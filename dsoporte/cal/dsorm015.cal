|FICHEROS;
     dsorm015  #15;
     dsprem99  #99;

     referen@  #900;
|FIN;

|VARIABLES;
     aBase        = "";
     aMas         = "";
     aAlfa        = "";
     aMenu        = "";
     aAlfa1       = "";
     aAlfa2       = "";
     aLong        = "";
     aOperacion   = "";
     aDOperacion  = "";
     aHora        = "";
     aTecla       = "";
     aFic         = "";
     aServidor    = "";
     aAbre        = "";
     aLinea       = "";
     aBaseDigital = "";
     aDirectorio  = "";
     aBaseMensaje = "";
     aTo          = "";
     aIP          = "";
     aSalida      = "";
     aFrom        = "";
     aAsunto      = "";
     aMensaje     = "";
     aAdjunto     = "";
     aReferencia  = "";
     aPassw       = "";

     nCampo    = 0;
     nHandle   = 0;
     nForma    = 0;
     nModo     = 0;
     nCaracter = 0;
     nPos      = 0;
     nCamuf    = 0;
     nNum      = 0;
     nLong     = 0;
     nReg      = 0;
     nDSPreven = 0;
     nError    = 0;

     aDirSer   = "";
     aDirPues  = "";
     aShell    = "";

    {1}aLocal  = "";

     &eaSPA          = "";
     &eaPass         = "";
     &eaPassEnc      = "";
     &enChequeoUsu   = 0;
     &eaIPDSCorreo   = "";
     &enBotonDsArchi = -1;
     &enHayDsArchi   = -1;
|FIN;

|PROCESO CargaMAC;
     |DBASS aBaseDigital;  |QBF aBaseDigital;

     aServidor = aBaseDigital % -303;
     |QBF aServidor;

     aDirectorio = aBaseDigital % -201;
     |QBF aDirectorio;

     nNum = aServidor;
     |SI nNum        = 0;   aServidor   = "001";  |FINSI;
     |SI aServidor   = "";  aServidor   = "001";  |FINSI;
     |SI aDirectorio = "";  aDirectorio = "1";    |FINSI;

     eaPass = aDirectorio + "0101" + aServidor + #15#1;
     |HAZ EncriptaMAC;

     #15#5 = eaPassEnc;
|FPRC;

|PROCESO CuerpoMensaje;
     |DBASS aBaseDigital;  |QBF aBaseDigital;

     aServidor   = aBaseDigital % -303;  |QBF aServidor;
     aDirectorio = aBaseDigital % -201;  |QBF aDirectorio;
     aReferencia = aBaseDigital % -207;

     nNum = aServidor;
     |SI nNum        = 0;   aServidor   = "001";  |FINSI;
     |SI aServidor   = "";  aServidor   = "001";  |FINSI;
     |SI aDirectorio = "";  aDirectorio = "1";    |FINSI;

     |DBASE aBaseMensaje;  |QBF aBase;
     aAbre    = aBaseMensaje + "correos";  |MKDIR aAbre;
     aAbre    = aAbre + "/adjunto.txt";
     |XABRE "WB", aAbre, nHandle;

     eaSPA = "DS, S.L.";

     aAlfa = eaSPA + " le agradece la confianza depositada en nosotros." + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "A continuación se le indica el enlace para obtener acceso a las ";
     aAlfa = aAlfa + "aplicaciones GECONET a través del portal de acceso." + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "Usuario:                   " + #15#1 + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa =  "Password:                  " + #15#3 + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     eaPass = #15#6;  |HAZ EncriptaMAC;

     aAlfa = "Pinche en http  " + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "http://www.geconet.net/portal/";
     aAlfa = aAlfa + "crearAcceso.php?claveGeconet=" + #15#5;  |QBF aAlfa;
     aAlfa = aAlfa + "&email=" + eaPassEnc;  |QBF aAlfa;
     |XGRABA nHandle, aAlfa;

     eaPass    = "";
     eaPassEnc = "";

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "Para cualquier aclaración o duda no dude en ponerse en contacto con nosotros." + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;

     aAlfa = ("_" * 134) + &13 + &10;   |XGRABA nHandle, aAlfa;

     aAlfa =  "Este correo electrónico y, en su caso, cualquier fichero anexo al mismo, contiene";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "información de carácter confidencial exclusivamente dirigida a su destinatario o";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "destinatarios. Queda prohibida su divulgación, copia o distribución a terceros sin la";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "previa autorización escrita de la empresa. En el caso de haber recibido este correo";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "electrónico por error, se ruega  notifíquese inmediatamente esta circunstancia mediante";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "reenvío a la dirección electrónica del remitente y proceda a su destrucción.";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;

     aAlfa = "El consumo de papel es perjudicial para el medio ambiente. Por favor téngalo en cuenta";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "antes de imprimir este mensaje.";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = ("_" * 134) + &13 + &10;   |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;
|FPRC;

|PROCESO PintaMAC;
     |PUSHV 0501 2380;
     |BLANCO 1125 1562;
     |CUADRO 1125 1562;

     |ATRI S;
     |PINTA 1226, "        CLAVE DE ACTIVACION         ";
     |ATRI s;
     |PINTA 1326, "____________________________________";

     |ATRI I;
     |PINTA 1426, #15#5;
     |ATRI i;

     |LEETECLA aTecla;
     |POPV;

     aTo = #15#6;  |QBF aTo;
     |SI aTo = "";  |ACABA;  |FINSI;

 ||--------------------/ Mandar el mail
     |CONFI "0000N Enviar correo electronico?";
     |SI FSalida = 0;
         |HAZ CuerpoMensaje;
         |HAZ IPDSCorreo;
         aIP      = eaIPDSCorreo;
         aSalida  = "asmtp.diagram.es";  |QBF aSalida;
         aFrom    = "soporte@diagram.es";
         aAsunto  = "Acceso para el uso de las aplicaciones GECONET";
         aMensaje = "$$$$" + aAbre;
         aAdjunto = aAbre;

         |DSCORREO_ENVIA aIP, aSalida, aFrom, aTo, aAsunto, aMensaje, aAdjunto;
         |SI FSalida < 0;
             |MENAV "0000 Ha habido un error en el envio del correo, revise el e_mail del usuario.";
         |SINO;
             |MENAV "0000 Correo enviado.";
         |FINSI;

         |MENSA "       ";
     |FINSI;
|FPRC;

|PROCESO Tipo11C1F15;  |TIPO 11;
     |SI FSalida = 10;
         aAlfa = "0000 La clave es " + #15#3;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;

     |SI FSalida = 11;
         |HAZ CargaMAC;
         |HAZ PintaMAC;
         |ERROR;
     |FINSI;

     |SI FSalida = 12;
         |CONFI "0000NSeguros que quiere cambiar al usuario de grupo";
         |SI FSalida ! 0;  |ACABA;  |FINSI;

         |DBASE aBase;  |QBF aBase;
         aMas = aBase + "def/dsorm001.mas";
         |CARGA_DEF aMas, referen@;
         |SI FSalida = 0;
             |ABRE #900;
             |SELECT #1#900;
             #900#0 = #15#0;
             |LEE 000#900=;
             |SI FSalida ! 0;  |DDEFECTO #900;  |FINSI;

             |CONSULTA_CLAVE #1#900;
             |CIERRA #900;

             |SI #900#0 = #15#0;
                 |MENAV "0000Ha elegido el mismo grupo, operacion cancelada.";
                 |ERROR;
             |SINO;
                 aAlfa = "0000SMovemos el usuario " + #15#1;  |QBF aAlfa;
                 aAlfa = aAlfa + " al grupo " + #900#1;  |QBF aAlfa;
                 |CONFI aAlfa;
                 |SI FSalida = 0;
                     |LEE 101#15=;
                     |SI FSalida = 0;
                         |BORRA 020#15a;
                         |LIBERA #15;

                         #15#0 = #900#0;
                         |GRABA 020#15n;
                         |LIBERA #15;

                         |MENAV "0000Recuerde que debera generar el grupo destino para aplicar los cambios al perfil";

                         |PONCONTROL 23, "SI";
                         |PTEC 808;
                     |FINSI;
                 |FINSI;
             |FINSI;

             |DESCARGA_DEF #referen@;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo0C1F15;  |TIPO 0;
     |SI #15#1 = "          ";
         |MENAV "0000 Usuario sin Contenido.";
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #15#1 - "¥";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0209;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #15#1 - "¤";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0241;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/dsorm015.mas";
     |CARGA_DEF aMas, referen@;
     |SI FSalida = 0;
         |ABRE #900;
         |SELECT #2#900;
         #900#1 = #15#1;
         |LEE 040#900=;
         |SI FSalida = 0;
             |SI #900#0 ! #15#0;
                 aAlfa = "0000 El Usuario ya esta definido en el Grupo: " + #900#0;
                 |MENAV aAlfa;
                 |ERROR;
             |FINSI;
         |FINSI;
         |CIERRA #900;

         |DESCARGA_DEF #referen@;
      |FINSI;
|FPRC;

|PROCESO ChequeoLaClave;
     nError = 0;
     aAlfa  = aPassw - "¥";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0209;
         |MENAV aAlfa;
         nError = 1;
         |ACABA;
     |FINSI;

     aAlfa = aPassw - "¤";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0241;
         |MENAV aAlfa;
         nError = 1;
     |FINSI;
|FPRC;

|PROCESO Tipo7C2F15;  |TIPO 7;
     |PUSHV 0501 2380;
     |BLANCO 1525 1842;
     |CUADRO 1525 1942;

     |ATRI R;
     |PINTA 1626, "INTRODUZCA CLAVE";
     |ATRI r;

     |PARA;  |SI;  |HACIENDO;
          aPassw   = #15#3;
          E_inf    = "";
          E_sup    = "10";
          aPassw   = 1730 ? -1;

          |PINTA 1730, "**********";

          |SI #15#3 ! aPassw;  |Y #15#3 ! "          ";
              |CONFI "0000NHas cambiado la Clave de Acceso que teniamos antes, Desea Continuar";
              |SI FSalida = 0;
                  |HAZ ChequeoLaClave;
                  |SI nError = 0;
                      #15#3 = aPassw;
                      #15#7 = "N";
                      |SAL;
                  |FINSI;
              |FINSI;
         |SINO;
              #15#3 = aPassw;
              |HAZ ChequeoLaClave;
              |SI nError = 0;
                  #15#3 = aPassw;
                  #15#7 = "N";
                  |SAL;
              |FINSI;
         |FINSI;
     |SIGUE;

     |POPV;
|FPRC;

|PROCESO Tipo0C3F15;  |TIPO 0;
     aAlfa = #15#3 - "¥";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0209;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #15#3 - "¤";
     |SI FSalida ! 0;
         aAlfa = "0000 Por favor no introduzca " + &0241;
         |MENAV aAlfa;
         |ERROR;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO Tipo7C1F15;  |TIPO 7;
     |SI enHayDsArchi = 1;
         |ESTADO_CONTROL enBotonDsArchi, "ENABLE";
     |FINSI;
|FPRC;

|PROCESO Tipo2F15;  |TIPO 2;
     nModo  = (FEntrada / 100) ! 0;
     nForma = 0 +. 1;

     |SI nForma = 1;
         |HAZ CargaMAC;
         |SI nModo = 1;  |HAZ PintaMAC;  |FINSI;
     |FINSI;

     |SI nModo = 3;
         aOperacion  = "B";
         aDOperacion = "BAJA DEL USUARIO";
     |FINSI;

     |SI nModo = 1;
         aOperacion  = "A";
         aDOperacion = "ALTA DEL USUARIO";
     |FINSI;

     |SI nModo = 2;
         |SI nForma ! 1;
             aOperacion  = "M";
             aDOperacion = "ENTRADA MODIFICACION DEL USUARIO";
         |FINSI;

         |SI nForma = 1;
             aOperacion  = "M";
             aDOperacion = "SALIDA MODIFICACION DEL USUARIO";
         |FINSI;
     |FINSI;

     |HORA aHora;

     |ABRE #99;
     nReg = 1;
     |LEE 000#99u;
     |SI FSalida = 0;
         nReg = #99#0 + 1;
     |FINSI;

     #99#0  = nReg;
     |GRABA 020#99b;

     #99#1  = #15#1;
     #99#2  = ~;
     #99#3  = aHora;
     #99#4  = aOperacion;
     #99#5  = aDOperacion;
     #99#6  = "";
     #99#7  = 0;
     #99#8  = 0;
     #99#9  = "";
     #99#10 = "";
     #99#11 = "";
     #99#12 = "";
     #99#13 = "";
     #99#14 = "";
     #99#15 = "";
     #99#16 = "";
     #99#17 = #15#5;
     #99#18 = #15#0;
     #99#19 = #15#4;
     #99#20 = Usuario % 810;

     |GRABA 020#99a;
     |LIBERA #99;
     |CIERRA #99;
|FPRC;
