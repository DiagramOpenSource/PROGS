|FICHEROS;
     gecom001@ #0;
     gecom014@ #14;

     :/dsoporte/def/dsprem04 #104;
     :/dsoporte/def/dsorm015 #215;
|FIN;

|VARIABLES;
     aBase         = "";
     aLong         = "";
     aAlfa         = "";
     aAlfa1        = "";
     aAlfa2        = "";
     aAbre         = "";
     aUsuario      = "";
     aPassword     = "";
     aMas          = "";
     aMenav        = "";
     aPathGecochek = "";
     aPath         = "";

     nLong         = 0;
     nPos          = 0;
     nCamuf        = 0;
     nCamuf1       = 0;
     nCamuf2       = 0;
     nNum          = 0;
     nCaracter     = 0;
     nRegis        = 0;
     nHandle       = 0;

     &eaPass       = "";
     &eaPassEnc    = "";
     &eaPassDesEnc = "";
     &enChequeoUsu = 0;
     &enErrorUsu   = 0;
     &eaIPDSCorreo = "";
     &enEsOTP      = 0;
     &enEsDSARCHI  = 0;
|FIN;

|PROCESO Desencripta;
     eaPassDesEnc = "";
     |PARA nCaracter = 1; |SI nCaracter [ 20; |HACIENDO nCaracter = nCaracter + 2;
          nPos   = (nCaracter * 100) + 1;       aAlfa1 = eaPass % nPos;
          nPos   = ((nCaracter + 1) * 100) + 1; aAlfa2 = eaPass % nPos;

          nCamuf2 = &aAlfa2;
          nCamuf2 = nCamuf2 - 65;

          nCamuf1 = &aAlfa1;
          nCamuf1 = nCamuf1 - 65;
          nCamuf1 = ((nCamuf1 * 26) + nCamuf2) / 2;

          eaPassDesEnc = eaPassDesEnc + &nCamuf1;
     |SIGUE;
|FPRC;

|PROCESO EncriptaUsuario;
     eaPassEnc = "";
     |PARA nCaracter = 1; |SI nCaracter [ 10; |HACIENDO nCaracter = nCaracter + 1;
           nPos   = (nCaracter * 100) + 1;
           aAlfa1 = eaPass % nPos;

           nCamuf = &aAlfa1;
           nCamuf = nCamuf * 2;

           nNum      = ((nCamuf - (nCamuf $ 26)) / 26 ) + 65;
           eaPassEnc = eaPassEnc + &nNum;

           nNum      = (nCamuf $ 26) + 65;
           eaPassEnc = eaPassEnc + &nNum;
     |SIGUE;
|FPRC;

|PROCESO EncriptaMAC;
     |QBF eaPass;
     aLong   = eaPass % 0;
     nLong   = aLong;
     eaPassEnc = "";
     |PARA nCaracter = 1; |SI nCaracter [ nLong; |HACIENDO nCaracter = nCaracter + 1;
           nPos   = (nCaracter * 100) + 1;
           aAlfa1 = eaPass % nPos;

           nCamuf = &aAlfa1;
           nCamuf = nCamuf * 2;

           nNum      = ((nCamuf - (nCamuf $ 26)) / 26 ) + 65;
           eaPassEnc = eaPassEnc + &nNum;

           nNum      = (nCamuf $ 26) + 65;
           eaPassEnc = eaPassEnc + &nNum;
     |SIGUE;
|FPRC;

|PROCESO MiraPassword;
     |DBASS aBase;  |QBF aBase;

     aMas  = aBase + "gecochek/def/gecom001.mas";
     |CARGA_DEF aMas, gecom001@;
     |SI FSalida = 0;
         |PATH_DAT #0 aPathGecochek;

         |ABRE #0;
         |SELECT #3#0;
         #0#4 = aUsuario;
         |LEE 000#0=;
         |SI FSalida = 0;  |Y #0#17 = "S";
             eaPass = #0#5;  |HAZ EncriptaUsuario;

             |SI eaPassEnc ! aPassword;
                 |SI enChequeoUsu = 1;
                     enErrorUsu = 1;
                     aMenav = "0000El password del usuario " + #0#4;  |QBF aMenav;
                     aMenav = aMenav + " es distinto al del ds_sys.psw. ";
                     |SI enEsOTP = 0;  |Y enEsDSARCHI = 0;
                         |MENAV aMenav;
                     |FINSI;
                 |SINO;
                     |SELECT #1#0;
                     |LEE 101#0=;
                     |SI FSalida = 0;
                         eaPass = aPassword;  |HAZ Desencripta;
                         #0#5   = eaPassDesEnc;
                         |GRABA 020#0a;
                         |LIBERA #0;

                         aMenav = "0000El password del usuario " + #0#4;  |QBF aMenav;
                         aMenav = aMenav + " ha sido cambiado. ";
                         aMenav = aMenav + " Se ha actualizado en el fichero de Administradores";
                         |SI enEsOTP = 0;  |Y enEsDSARCHI = 0;
                             |MENAV aMenav;
                         |FINSI;
                     |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;
         |CIERRA #0;

         |DESCARGA_DEF #gecom001@;
     |FINSI;

     aMas  = aBase + "gecochek/def/gecom014.mas";
     |CARGA_DEF aMas, gecom014@;
     |SI FSalida = 0;
         |ABRE #14;
         |SELECT #2#14;
         #14#1 = aUsuario;
         |LEE 000#14=;
         |SI FSalida = 0;  |Y #14#15 = "S";
             eaPass = #14#3;  |HAZ EncriptaUsuario;

             |SI eaPassEnc ! aPassword;
                 |SI enChequeoUsu = 1;
                     enErrorUsu = 1;
                     aMenav = "0000El password del usuario " + #14#1;  |QBF aMenav;
                     aMenav = aMenav + " es distinto al del ds_sys.psw. ";
                     |SI enEsOTP = 0;  |Y enEsDSARCHI = 0;
                         |MENAV aMenav;
                     |FINSI;
                 |SINO;
                     |SELECT #1#14;
                     |LEE 101#14=;
                     |SI FSalida = 0;
                         eaPass = aPassword;  |HAZ Desencripta;
                         #14#3  = eaPassDesEnc;
                         |GRABA 020#14a;
                         |LIBERA #14;

                         aMenav = "0000El password del usuario " + #14#1;  |QBF aMenav;
                         aMenav = aMenav + " ha cambiado. ";
                         aMenav = aMenav + " Se ha actualizado en el fichero gecom014.";
                         |SI enEsOTP = 0;  |Y enEsDSARCHI = 0;
                            |MENAV aMenav;
                         |FINSI;
                     |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;
         |CIERRA #14;

         |DESCARGA_DEF #gecom014@;
     |FINSI;

     |SELECT #2#104;
     #104#5 = aUsuario;
     |LEE 000#104=;
     |SI FSalida = 0;  |Y #104#18 = "S";
         eaPass = #104#7;  |HAZ EncriptaUsuario;

         |SI eaPassEnc ! aPassword;
             |SI enChequeoUsu = 1;
                 enErrorUsu = 1;
                 aMenav = "0000El password del usuario " + #104#5;  |QBF aMenav;
                 aMenav = aMenav + " es distinto al del ds_sys.psw. ";
                 |SI enEsOTP = 0;  |Y enEsDSARCHI = 0;
                     |MENAV aMenav;
                 |FINSI;
             |SINO;
                 |SELECT #1#104;
                 |LEE 101#104=;
                 |SI FSalida = 0;
                     eaPass = aPassword;  |HAZ Desencripta;
                     #104#7  = eaPassDesEnc;
                     |GRABA 020#104a;
                     |LIBERA #104;

                     aMenav = "0000El password del usuario " + #104#5;  |QBF aMenav;
                     aMenav = aMenav + " ha cambiado. ";
                     aMenav = aMenav + "Se ha actualizado en el fichero dsprem04.";
                     |SI enEsOTP = 0;  |Y enEsDSARCHI = 0;
                         |MENAV aMenav;
                     |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |SELECT #2#215;
     #215#1 = aUsuario;
     |LEE 000#215=;
     |SI FSalida = 0;  |Y #215#4 = nRegis;  |Y #215#7 = "S";
         eaPass = #215#3;  |HAZ EncriptaUsuario;

         |SI eaPassEnc ! aPassword;
             |SI enChequeoUsu = 1;
                 enErrorUsu = 1;
                 aMenav = "0000El password del usuario " + #215#1;  |QBF aMenav;
                 aMenav = aMenav + " es distinto al del ds_sys.psw. ";
                 |SI enEsOTP = 0;  |Y enEsDSARCHI = 0;
                     |MENAV aMenav;
                 |FINSI;
             |SINO;
                 |SELECT #1#215;
                 |LEE 101#215=;
                 |SI FSalida = 0;
                     eaPass  = aPassword;  |HAZ Desencripta;
                     #215#3  = eaPassDesEnc;
                     |GRABA 020#215a;
                     |LIBERA #215;

                     aMenav = "0000El password del usuario " + #215#1;  |QBF aMenav;
                     aMenav = aMenav + " ha cambiado. ";
                     aMenav = aMenav + "Se ha actualizado en el fichero dsorm015.";
                     |SI enEsOTP = 0;  |Y enEsDSARCHI = 0;
                         |MENAV aMenav;
                     |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO RevisaUsuarios;
     |DBASS aBase;  |QBF aBase;
     aPathGecochek = aBase + "gecochek/fich/";

     |ABRE #104;
     |ABRE #215;

     enErrorUsu = 0;

     |DBASS aBase; |QBF aBase;
     aAbre = aBase + "dev/usr/ds_sys.psw"
     |XABRE "U", aAbre, nHandle;
     |SI FSalida ] 0;
         |PARA; |SI; |HACIENDO;
              |XLEE nHandle, 37, aAlfa;
              |SI FSalida < 0;  |SAL;  |FINSI;

              aAlfa1    = aAlfa % 103;   nRegis = aAlfa1;
              aUsuario  = aAlfa % 410;
              aPassword = aAlfa % 1420;
              |HAZ MiraPassword;
         |SIGUE;
     |FINSI;
     |XCIERRA nHandle;

     |CIERRA #104;
     |CIERRA #215;
|FPRC;

|PROCESO IPDSCorreo;
     eaIPDSCorreo = "";
     aPath        = "";

     aAbre = "/u/basico/bin/ipdscorreo.txt";
     |XABRE "E", aAbre, nHandle;
     |SI FSalida ] 0;
         aPath = "/u/basico/bin/";
     |FINSI;

     |SI aPath = "";
         |DBASS aPath;  |QBF aPath;
         aAbre = aPath + "bin/ipdscorreo.txt";
         |XABRE "E", aAbre, nHandle;
         |SI FSalida ] 0;
             aPath = aPath + "bin/";
         |SINO;
             aPath = "";
         |FINSI;
     |FINSI;

     |SI aPath ! "";
         aAbre = aPath + "ipdscorreo.txt";
         |XABRE "AB", aAbre, nHandle;
         |SI FSalida ] 0;
             |XLEE nHandle, 250, aAlfa;
         |FINSI;
         |XCIERRA nHandle;

         |QBF aAlfa;
         eaIPDSCorreo = aAlfa;
     |FINSI;

     |SI eaIPDSCorreo = "";
         eaIPDSCorreo = "172.16.100.101";
     |FINSI;
|FPRC;
