|FICHEROS;
    dsaz0029;

    dsam0000;
    dsam0023;
    dsam0024;
    dsam0105;
    dsam0109;
    dsam0110;

    dsat0002,MANTE;
|FIN;

|VARIABLES;
     aAlfa  = "";
     aFichero  = "";

     aAlfa1    = "";
     aAlfa2    = "";
     nPara1    = 0;
     nDEmpresa = 0;
     nHEmpresa = 0;
     nCampo    = 0;
     nGraba    = 0;
     aTitulo   = "";
     nCamp3    = 0;
     aCamp4    = "";
     fCamp5    = @;
     fCamp6    = @;
     fCamp7    = @;
     nCamp8    = 0;
     nCamp9    = 0;
     nCamp10   = 0;
     nCamp11   = 0;
     nCamp12   = 0;
     nCamp13   = 0;
     aCamp17   = "";
     fCamp18   = @;
     nCamp19   = 0;
     nCamp20   = 0;
     aCamp21   = "";
     nCamp22   = 0;
     nCamp23   = 0;

     aDObligA  = "";
     aHObligA  = "";
     aDObligB  = "";
     aHObligB  = "";

     nImport1  = 0;
     nImport2  = 0;
     fFecha    = @;
     fDFecha   = @;
     fHFecha   = @;
     nEmpresa  = 0;
     nEjAnt    = 0;
     nAlgun    = 0;
     nSw       = 0;

     &aFuncion  = "";
     &enEjer    = 0;
     &enEmpresa = 0;
|FIN;

|PROCESO Tipo66C1z29; |TIPO 66;
   |SI aFuncion = "A";
       |ABRE #dsam0109;
       #dsam0109#0 = #dsaz0029#Campo#;
       |CONSULTA_CLAVE #1#dsam0109;
       #dsaz0029#Campo# = #dsam0109#0;
       |CIERRA #dsam0109;
   |FINSI;

   |SI aFuncion = "B";
       |ABRE #dsam0110;
       #dsam0110#0 = #dsaz0029#Campo#;
       |CONSULTA_CLAVE #1#dsam0110;
       #dsaz0029#Campo# = #dsam0110#0;
       |CIERRA #dsam0110;
   |FINSI;

   |PINTA #dsaz0029#Campo#;
|FPRC;

|CALCULO HEmpresa; |TIPO 0;
    |SI #dsaz0029#2 < #dsaz0029#1;
        |MENAV "0000Error. Hasta Empresa inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO HCliente; |TIPO 0;
    |SI #dsaz0029#4 < #dsaz0029#3;
        |MENAV "0000Error. Hasta Cliente inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO HAgente; |TIPO 0;
    |SI #dsaz0029#6 < #dsaz0029#5;
        |MENAV "0000Error. Hasta Cliente inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO Tipo0C07; |TIPO 0;
    aAlfa = "N";
    |SI #dsaz0029#Campo# = "N";
        aAlfa = "S";
    |FINSI;
    |C_M #dsaz0029#8,1,aAlfa;
    |C_M #dsaz0029#9,1,aAlfa;
|FCAL;

|CALCULO Tipo0C08; |TIPO 0;
    |C_M #dsaz0029#8,0,aAlfa;
    |SI aAlfa = "N"; |ACABA; |FINSI;

    aAlfa = "N";
    |SI #dsaz0029#Campo# = "I";
        aAlfa = "S";
    |FINSI;
    |C_M #dsaz0029#9,1,aAlfa;
|FCAL;
|| *******************************************************************
|PROCESO VerExiste;
   nSw = 1;
|FPRC;

|DEFBUCLE dsam0023N;
   #dsam0023#1;
   ;
   nEmpresa, enEjer, 01;
   nEmpresa, enEjer, 12;
   e;
   NULL, VerExiste;
|FIN;

|DEFBUCLE dsam0024N;
   #dsam0024#1;
   ;
   nEmpresa, enEjer, 01;
   nEmpresa, enEjer, 12;
   e;
   NULL, VerExiste;
|FIN;
|| *******************************************************************
|PROCESO GrabaAuxiliar1;
    #dsat0002#0 = nEmpresa;
    #dsat0002#1 = enEjer;
    #dsat0002#2 = 1;
    |LEE 141#dsat0002.=;
    |SI FSalida ! 0;
        |DDEFECTO #dsat0002;
        #dsat0002#0 = nEmpresa;
        #dsat0002#1 = enEjer;
        #dsat0002#2 = 1;
        |GRABA 020#dsat0002.b;
    |FINSI;
    #dsat0002#3  = nCamp3;
    #dsat0002#4  = aCamp4;
    #dsat0002#5  = fCamp5;
    #dsat0002#6  = fCamp6;
    #dsat0002#7  = fCamp7;
    #dsat0002#8  = nCamp8;
    #dsat0002#9  = nCamp9;
    #dsat0002#10 = nCamp10;
    #dsat0002#12 = nCamp12;
    #dsat0002#13 = nCamp13;
    #dsat0002#14 = #dsam0000#1;
    #dsat0002#15 = #dsam0000#72;
    #dsat0002#26 = #dsam0000#3;

    |SI #dsaz0029#7 = "S";
        #dsat0002#11 = 0;
    |SINO;
        #dsat0002#11 = nCamp11;
        |SI #dsaz0029#8 = "I";
            #dsat0002#11 = #dsat0002#11 + (nCamp11 % #dsaz0029#9) ! 2;
        |FINSI;
    |FINSI;

    |GRABA 020#dsat0002.a;
    |LIBERA #dsat0002;

    nAlgun = 1;
|FPRC;

|PROCESO LeeDsam0023;
   |SI #dsam0023#3 ] #dsaz0029#1; |Y #dsam0023#3 [ #dsaz0029#2;
       nCamp3  = #dsam0023#3;
       aCamp4  = #dsam0023#4;
       fCamp5  = #dsam0023#5;
       fCamp6  = #dsam0023#6;
       fCamp7  = #dsam0023#7;
       nCamp8  = #dsam0023#8;
       nCamp9  = #dsam0023#9;
       nCamp10 = #dsam0023#10;
       nCamp11 = #dsam0023#11;
       nCamp12 = #dsam0023#12;
       nCamp13 = 0;
       nGraba  = 1;
   |SINO;
       nGraba  = 0;
   |FINSI;
|FPRC;

|DEFBUCLE dsam0023;
   #dsam0023#1;
   ;
   nEmpresa, nEjAnt, 01;
   nEmpresa, nEjAnt, 12;
   e;
   NULL, LeeDsam0023;
|FIN;

|PROCESO LeeDsam0024;
   |SI #dsam0024#3 ] #dsaz0029#1; |Y #dsam0024#3 [ #dsaz0029#2;
       nCamp3  = #dsam0024#3;
       aCamp4  = #dsam0024#4;
       fCamp5  = #dsam0024#5;
       fCamp6  = #dsam0024#6;
       fCamp7  = #dsam0024#7;
       nCamp8  = #dsam0024#8;
       nCamp9  = 0;
       nCamp10 = #dsam0024#9;
       nCamp11 = #dsam0024#10;
       nCamp12 = #dsam0024#11;
       nCamp13 = #dsam0024#12;
       nGraba  = 1;
   |SINO;
       nGraba  = 0;
   |FINSI;
|FPRC;

|DEFBUCLE dsam0024;
   #dsam0024#1;
   ;
   nEmpresa, nEjAnt, 01;
   nEmpresa, nEjAnt, 12;
   e;
   NULL, LeeDsam0024;
|FIN;

|PROCESO LeoDsam0000;
   nSw    = 0;
   nGraba = 0;
   nEmpresa = #dsam0000#0;

   |SI aFuncion = "A"; |BUCLE dsam0023N; |FINSI;
   |SI aFuncion = "B"; |BUCLE dsam0024N; |FINSI;
   |SI nSw = 0;
       |SI aFuncion = "A"; |BUCLE dsam0023; |FINSI;
       |SI aFuncion = "B"; |BUCLE dsam0024; |FINSI;
   |FINSI;

   |SI nGraba = 1;
       |HAZ GrabaAuxiliar1;
   |FINSI;
|FPRC;

|DEFBUCLE dsam0000;
   #dsam0000#1;
   72,121,122;
   #dsaz0029#3, #dsaz0029#5, aDObligA, aDObligB;
   #dsaz0029#4, #dsaz0029#6, aHObligA, aHObligB;
   e;
   NULL, LeoDsam0000;
|FIN;

|| ********************************************************************
|PROCESO GrabaM0024;
    #dsam0024#0 = #dsat0002#0;
    #dsam0024#1 = #dsat0002#1;
    #dsam0024#2 = #dsat0002#2;
    |LEE 141#dsam0024.=;
    |SI FSalida ! 0;
        |DDEFECTO #dsam0024;
        #dsam0024#0 = #dsat0002#0;
        #dsam0024#1 = #dsat0002#1;
        #dsam0024#2 = #dsat0002#2;
        |GRABA 020#dsam0024.b;
    |FINSI;

    |PARA nCampo = 3; |SI nCampo [ 8; |HACIENDO nCampo = nCampo + 1;
          #dsam0024#nCampo# = #dsat0002#nCampo#;
    |SIGUE;
    #dsam0024#9  = #dsat0002#10;
    #dsam0024#10 = #dsat0002#11;
    #dsam0024#11 = #dsat0002#12;
    #dsam0024#12 = #dsat0002#13;

    |GRABA 020#dsam0024.a;
    |LIBERA #dsam0024;
|FPRC;

|PROCESO GrabaM0023;
    #dsam0023#0 = #dsat0002#0;
    #dsam0023#1 = #dsat0002#1;
    #dsam0023#2 = #dsat0002#2;
    |LEE 141#dsam0023.=;
    |SI FSalida ! 0;
        |DDEFECTO #dsam0023;
        #dsam0023#0 = #dsat0002#0;
        #dsam0023#1 = #dsat0002#1;
        #dsam0023#2 = #dsat0002#2;
        |GRABA 020#dsam0023.b;
    |FINSI;

    |PARA nCampo = 3; |SI nCampo [ 12; |HACIENDO nCampo = nCampo + 1;
          #dsam0023#nCampo# = #dsat0002#nCampo#;
    |SIGUE;

    |GRABA 020#dsam0023.a;
    |LIBERA #dsam0023;
|FPRC;

|PROCESO dsat0002;
    |SI aFuncion = "A";
        |HAZ GrabaM0023;
    |FINSI;
    |SI aFuncion = "B";
        |HAZ GrabaM0024;
    |FINSI;
|FPRC;

|DEFBUCLE dsat0002;
  #dsat0002#1;
  ;
  enEjer, 01, #dsaz0029#3;
  enEjer, 01, #dsaz0029#4;
  ;
  NULL, dsat0002;
|FIN;

|PROCESO PasoDatos;
  |ABRE #dsam0023;
  |ABRE #dsam0024;

  |BUCLE dsat0002;

  |CIERRA #dsam0024;
  |CIERRA #dsam0023;
|FPRC;

|PROCESO PantaFB;
             |C_V #dsat0002#13,1,"S";
             |PINTA 0774, "ÄÄÄÄÄÄ¿";
             |PINTA 0874, "      ³";
             |PINTA 0974, "      ³";
             |PINTA 1074, "      ³";
             |PINTA 1174, "      ³";
             |PINTA 1274, "      ³";
             |PINTA 1374, "      ³";
             |PINTA 1474, "      ³";
             |PINTA 1574, "      ³";
             |PINTA 1674, "      ³";
             |PINTA 1774, "      ³";
             |PINTA 1874, "      ³";
             |PINTA 1974, "      ³";
             |PINTA 2074, "      ³";
             |PINTA 2174, "      ³";
             |PINTA 2274, "      ³";
             |PINTA 2374, "ÄÄÄÄÄÄÙ";

             |ATRI R; |PINTA 0502, "Ejercicio siguiente Prevencion de Riesgos Laborales"
                      |PINTA 0821, "EPR";
                      |PINTA 1045, "EPR";
                      |PINTA 1063, " % Prev. % Vigi. "; |ATRI 0;
|FPRC;
|| ********************************************************************
|RUTINA ClaveBaja002;
     #dsat0002#1 = enEjer;
     #dsat0002#2 = 01;
     #dsat0002#0 = 00001;
|FRUT;

|RUTINA ClaveAlta002;
     #dsat0002#1 = enEjer;
     #dsat0002#2 = 12;
     #dsat0002#0 = 99999;
|FRUT;

|PROCESO ProcesoZ029;

     aFichero = ("9z" + Usuario) % 108;
     |NOME_DAT #dsat0002#aFichero#;
     |DELINDEX #dsat0002;

     aAlfa1 = #dsaz0029#0;
     aAlfa2 = "01.01." + aAlfa1; fDFecha = aAlfa2;
     aAlfa2 = "31.12." + aAlfa1; fHFecha = aAlfa2;

     enEjer = #dsaz0029#0;
     nEjAnt = enEjer - 1;
     aDObligA  = " "; aHObligA  = "z";
     aDObligB  = " "; aHObligB  = "z";
     |SI aFuncion = "A"; aDObligA  = "S"; aHObligA  = "S"; |FINSI;
     |SI aFuncion = "B"; aDObligB  = "S"; aHObligB  = "S"; |FINSI;

     |ABRE #dsat0002;
     nAlgun = 0;
     |BUCLE dsam0000;
     |CIERRA #dsat0002;

     |SI nAlgun = 1;

         |PINPA #0#dsat0002;
         |SI aFuncion = "B";
             |HAZ PantaFB;
         |FINSI;

         |ENTLINEAL #1#dsat0002, -3, 4, 22, 0, ClaveBaja002, ClaveAlta002;
         |CONFI "0000SActualizar Datos";
         |SI FSalida = 0;
             |HAZ PasoDatos;
         |FINSI;
     |SINO;
         |MENAV "0000Seleccion vacia";
     |FINSI;

     |DELINDEX #dsat0002;
|FPRC;

|PROGRAMA;
    aFuncion = PARAMETRO; |QBF aFuncion
    |SI aFuncion = ""; aFuncion = "A"; |FINSI;

    |CLS;
    |CABEZA "Generar Ejer.Siguiente";

    aTitulo = "A- Proteccion de Datos";
    |SI aFuncion = "B";
        aTitulo = "B- Prevencion de Riesgos";
    |FINSI;

    fFecha = ~;
    aAlfa  = fFecha;
    aAlfa  = aAlfa % -104;
    #dsaz0029#0 = aAlfa;
    #dsaz0029#0 = #dsaz0029#0 + 1;

    |PINPA #0#dsaz0029;
    |ATRI S; |PINTA 1412, aTitulo; |ATRI 0;
    |PINDA #0#dsaz0029;

    |ENDATOS #2#dsaz0029;
    |SI FSalida = 0;
        |HAZ ProcesoZ029;
    |FINSI;
|FPRO;
