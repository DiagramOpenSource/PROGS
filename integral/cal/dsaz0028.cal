|FICHEROS;
    dsaz0028;

    dsam0000;
    dsam0023;
    dsam0105;
    dsam0109;

    dsaw0013;
    dsat0001;
|FIN;

|VARIABLES;
     aAlfa  = "";
     aFichero  = "";

     aAlfa1    = "";
     aAlfa2    = "";
     nPara1    = 0;
     nGraba    = 0;

     nImport1  = 0;
     nImport2  = 0;
     fFecha    = @;
     fDFecha   = @;
     fHFecha   = @;
     nEmpresa  = 0;
     nEjer     = 0;
     nAlgun    = 0;

     &eaFichero  = "";
     &eaDLiqu    = "";
     &eaHLiqu    = "";
     &aFuncion   = "";
     &enEjer     = 0;
     &enEmpresa  = 0;
     &enDEmpresa = 0;
     &enHEmpresa = 0;
     &enDAgente  = 0;
     &enHAgente  = 0;
     &enDMes     = 0;
     &eaDMes     = "";
     &enHMes     = 0;
|FIN;

|CALCULO DMes; |TIPO 0;
    enDMes = #dsaz0028#1;
    |SI enDMes = 1;  #dsaz0028#2 = "Enero     "; |FINSI;
    |SI enDMes = 2;  #dsaz0028#2 = "Febrero   "; |FINSI;
    |SI enDMes = 3;  #dsaz0028#2 = "Marzo     "; |FINSI;
    |SI enDMes = 4;  #dsaz0028#2 = "Abril     "; |FINSI;
    |SI enDMes = 5;  #dsaz0028#2 = "Mayo      "; |FINSI;
    |SI enDMes = 6;  #dsaz0028#2 = "Junio     "; |FINSI;
    |SI enDMes = 7;  #dsaz0028#2 = "Julio     "; |FINSI;
    |SI enDMes = 8;  #dsaz0028#2 = "Agosto    "; |FINSI;
    |SI enDMes = 9;  #dsaz0028#2 = "Septiembre"; |FINSI;
    |SI enDMes = 10; #dsaz0028#2 = "Octubre   "; |FINSI;
    |SI enDMes = 11; #dsaz0028#2 = "Noviembre "; |FINSI;
    |SI enDMes = 12; #dsaz0028#2 = "Diciembre "; |FINSI;
    |PINTA #dsaz0028#2;
    eaDMes = #dsaz0028#2;
|FCAL;

|CALCULO HEmpresa; |TIPO 0;
    |SI #dsaz0028#4 < #dsaz0028#3;
        |MENAV "0000Error. Hasta Empresa inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO HCliente; |TIPO 0;
    |SI #dsaz0028#6 < #dsaz0028#5;
        |MENAV "0000Error. Hasta Cliente inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO HAgente; |TIPO 0;
    |SI #dsaz0028#8 < #dsaz0028#7;
        |MENAV "0000Error. Hasta Cliente inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|| *******************************************************************
|PROCESO GrabaAuxiliar1;
    #dsam0109#0 = #dsam0023#3;
    |LEE 041#dsam0109.=;
    |SI FSalida ! 0; |ACABA; |FINSI;
    |SI #dsam0109#3 ! "S"; |ACABA; |FINSI;

    #dsat0001#0 = aFuncion;
    #dsat0001#1 = #dsam0023#3;
    #dsat0001#2 = #dsam0023#1;
    #dsat0001#3 = #dsam0023#2;
    #dsat0001#4 = nEmpresa;
    |LEE 141#dsat0001.=;
    |SI FSalida ! 0;
        |DDEFECTO #dsat0001;
        #dsat0001#0 = aFuncion;
        #dsat0001#1 = #dsam0023#3;
        #dsat0001#2 = #dsam0023#1;
        #dsat0001#3 = #dsam0023#2;
        #dsat0001#4 = nEmpresa;
        #dsat0001#7 = #dsam0023#11;
        #dsat0001#8 = #dsam0023#12;
        |GRABA 020#dsat0001.b;
    |FINSI;
    #dsat0001#5  = #dsam0023#4;
    #dsat0001#6  = #dsam0000#1;
    #dsat0001#9  = #dsam0023#13;
    #dsat0001#10 = #dsam0023#14;
    #dsat0001#11 = #dsam0023#15;
    #dsat0001#12 = #dsam0023#16;
    #dsat0001#13 = #dsam0023#17;
    #dsat0001#14 = #dsam0023#18;

    |SI #dsat0001#9 = "N";
        #dsat0001#11 = (#dsat0001#7 % #dsat0001#8) ! 2;
    |FINSI;

    #dsat0001#15 = #dsam0000#72;
    #dsat0001#16 = #dsam0000#52;
    #dsat0001#20 = #dsam0000#3;
    #dsat0001#17 = " ";

    |SI #dsaz0028#10 = "T";  #dsat0001#17 = "*";  |FINSI;
    |SI #dsaz0028#10 = "S"; |Y #dsat0001#11 ! 0;
         #dsat0001#17 = "*";
    |FINSI;

    |GRABA 020#dsat0001.a;
    |LIBERA #dsat0001;

    nGraba = 1;
    nImport1  = #dsat0001#11;
    |HAZ GrabaAuxiliar2;
|FPRC;

|DEFBUCLE dsam0023;
   #dsam0023#1;
   3,13;
   nEmpresa, enEjer, enDMes, #dsaz0028#3, eaDLiqu;
   nEmpresa, enEjer, enHMes, #dsaz0028#4, eaHLiqu;
   e;
   NULL, GrabaAuxiliar1;
|FIN;

|PROCESO LeoDsam0000;
   nEmpresa = #dsam0000#0;
   |BUCLE dsam0023;
|FPRC;

|DEFBUCLE dsam0000;
   #dsam0000#1;
   121,72;
   enDEmpresa, "S", enDAgente;
   enHEmpresa, "S", enHAgente;
   e;
   NULL, LeoDsam0000;
|FIN;

|PROCESO GrabaAuxiliar2;
   #dsaw0013#0 = aFuncion;
   #dsaw0013#1 = enEjer;
   #dsaw0013#2 = #dsam0109#0;
   |LEE 041#dsaw0013.=;
   |SI FSalida ! 0;
       |DDEFECTO #dsaw0013;
       #dsaw0013#0 = aFuncion;
       #dsaw0013#1 = enEjer;
       #dsaw0013#2 = #dsam0109#0;
       #dsaw0013#3 = #dsam0109#2;
       #dsaw0013#6 = #dsam0109#9;
       #dsaw0013#7 = #dsam0109#8;
       |GRABA 020#dsaw0013.c;
   |FINSI;
   |SI nGraba = 1;
       #dsaw0013#4 = #dsaw0013#4 + nImport1;
       #dsaw0013#5 = #dsaw0013#5 + nImport2;
   |FINSI;
   #dsaw0013#9  = #dsaz0028#1;
   #dsaw0013#10 = #dsaz0028#2;
   |GRABA 020#dsaw0013.a;
   nAlgun = 1;
|FPRC;

|DEFBUCLE dsam0109;
   #dsam0109#1;
   3;
   #dsaz0028#3, "S";
   #dsaz0028#4, "S";
   e;
   NULL, GrabaAuxiliar2;
|FIN;

|PROCESO VerSiHayAlgo;
  nAlgun = 1;
  |ERROR10;
|FPRC;

|DEFBUCLE VerSiHayAlgo;
   #dsat0001#1;
   17;
   aFuncion, #dsaz0028#3, enEjer, enDMes, enDEmpresa, "*";
   aFuncion, #dsaz0028#4, enEjer, enHMes, enHEmpresa, "*";
   ;
   NULL, VerSiHayAlgo;
|FIN;

|PROCESO ClaveBaja999;
   #dsaw0013#0 = aFuncion;
   #dsaw0013#1 = enEjer;
   #dsaw0013#2 = #dsaz0028#3;
|FPRC;

|PROCESO ClaveAlta999;
   #dsaw0013#0 = aFuncion;
   #dsaw0013#1 = enEjer;
   #dsaw0013#2 = #dsaz0028#4;
|FPRC;

|PROCESO ProcesoZ028;

     aFichero = ("3z" + Usuario) % 108;
     |NOME_DAT #dsaw0013#aFichero#;
     |DELINDEX #dsaw0013;

     eaFichero = ("4z" + Usuario) % 108;
     |NOME_DAT #dsat0001#eaFichero#;
     |DELINDEX #dsat0001;

     aAlfa1 = #dsaz0028#0;
     aAlfa2 = "01.01." + aAlfa1; fDFecha = aAlfa2;
     aAlfa2 = "31.12." + aAlfa1; fHFecha = aAlfa2;

     enEjer  = #dsaz0028#0;
     eaDLiqu = #dsaz0028#9;
     eaHLiqu = #dsaz0028#9;
     |SI #dsaz0028#9 = "T";
         eaDLiqu = " ";
         eaHLiqu = "z";
     |FINSI;
     enDEmpresa = #dsaz0028#5;
     enHEmpresa = #dsaz0028#6;
     enDAgente  = #dsaz0028#7;
     enHAgente  = #dsaz0028#8;
     enDMes     = #dsaz0028#1;
     enHMes     = #dsaz0028#1;
     eaDMes     = #dsaz0028#2;

     |ABRE #dsaw0013;
     |ABRE #dsat0001;

     nAlgun = 0;
     nGraba = 0; |BUCLE dsam0109;

     |ABRE #dsam0109;
     |BUCLE dsam0000;
     |CIERRA #dsam0109;

     |CIERRA #dsat0001;
     |CIERRA #dsaw0013;

     |SI nAlgun = 1;
         |PARA; |SI nAlgun = 1; |HACIENDO;
                |PINPA #0#dsat0001;
                |ENTLINEAL #1#dsaw0013, -3, 4, 22, 0, ClaveBaja999, ClaveAlta999;
                nAlgun = 0;
                |BUCLE VerSiHayAlgo;
                |SI nAlgun = 1;
                    |MENAV "0000Hay registros marcados sin actualizar";
                    |CONFI "0000SDesea no actualizarlos y salir del programa";
                    |SI FSalida = 0;
                        nAlgun = 0;
                    |FINSI;
                |FINSI;
         |SIGUE;
     |SINO;
         |MENAV "0000Seleccion vacia";
     |FINSI;

     |DELINDEX #dsat0001;
     |DELINDEX #dsaw0013;
|FPRC;

|PROGRAMA;

    aFuncion = "A";

    |CLS;
    |CABEZA "Calculo Comision";

    fFecha = ~;
    aAlfa  = fFecha;
    aAlfa  = aAlfa % -104;
    #dsaz0028#0 = aAlfa;

    |PINPA #0#dsaz0028;
    |PINDA #0#dsaz0028;

    |ENDATOS #2#dsaz0028;
    |SI FSalida = 0;
        |HAZ ProcesoZ028;
    |FINSI;
|FPRO;
