|FICHEROS;
     dsay0004 #1000;
     dsam0000 #0;
     dsam0001 #101;
     dsam0002 #2;
     dsam0005 #5;
     dsam0053 #53;
     dsam0054 #54;
     dsam0055 #55;
     dsam0056 #56;
     dsam0111 #111;
     dsam0112 #112;
     dsaw0026 #99,MANTE;
     dsaw0032 #999;

     :/basica/def/agicen14 #6;
     :/basica/def/agiepim2 #102;
     :/basica/def/agitab99 #199;
     :/modelos/def/dsmom002 #202;

     :/dsarchi/def/dsarw010  #400;
|FIN;

|VARIABLES;
     &eaDirTrabajo = "";
     &eaDirPlantilla = "";
     aFicheroDos = "";
     &eaFicheroTxt = "";
     nHandleTxt = 0;

     aBasePla = "";

     aAuxiliar = "";
     aDirCorreo = "";
     &eaAlfa = "";
     aIP = "";
     aFrom = "";
     aSalida = "";
     aTo = "";
     aAdjunto = "";
     aAutenti = "";

     nSwAcaba = 0;
     nInstala = 0;
     aDirBasico = "";
     aDirDsPdf = "";
     nHandle = 0;
     &eaOrigen = "";
     &eaDestino = "";
     &eaDirSerPlan = "";
     &enSwNuevoMD5 = 0;

     aAsunto = "";
     aMensaje = "";
     aCuerpo1 = "";
     aCuerpo2 = "";
     aCuerpo3 = "";
     aCuerpo4 = "";
     aCuerpo5 = "";
     aFormato = "";
     aEmail = "";

     nCampo       = 0;
     nCampo1      = 0;
     nDCliente    = 0;
     nHCliente    = 0;
     nPosi        = 0;
     nContador    = 0;
     nRegistro    = 0;
     nWord        = 0;
     nLinea       = 0;
     nSwDialogo   = 0;
     nCopia       = 0;
     nDCodigo     = 0;
     nHCodigo     = 0;
     nCodigo      = 0;
     nLen         = 0;
     nCampoEpi1   = 0;
     nCampoEpi2   = 0;
     nSwPantalla  = 0;
     nTecla       = 0;
     nSwEsta      = 0;
     nOrden       = 0;
     nModo        = 0;

     aAlfa         = "";
     aAlfa1        = "";
     aAlfa2        = "";
     aCaracter     = "";
     aFichero      = "";
     aCampo        = "";
     aAsigna       = "";
     aOrigen       = "";
     aDestino      = "";
     aAbre         = "";
     aCadena       = "";
     aLen          = "";
     aBase         = "";
     aDocRemoto    = "";
     aDocServidor  = "";
     aIPRemoto     = "";
     aDsPrint      = "";

     {1}aContiene      = "";

     &enFSalida        = 0;
     &enCodUbica       = 0;
     &enTipoDocumento  = 0;
     &eaRutaDocumento  = "";
     &eaNombrePrograma = "";
     &eaNombreRuta     = "";
     &eaRutaPlanilla   = "";
     &eaExtension      = "";
     &eaFicheroEdita   = "";

     &enAgrupa         = 0;
     &eaTipoEpi        = "";
     &eaEpigrafe       = "";
     &eaUnidadBasico   = "";
|FIN;

|PROCESO Tipo7w26;  |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
         nOrden = nOrden + 1;
         #99#2 = nOrden;
     |FINSI;
|FPRC;

| **************** PROCESOS PARA PEDIR DATOS POR PANTALLAS

|PROCESO SacaHistorico;  |TIPO 66;
     |PUSHV 0501 2380;
     |ABRE #55;
     |LEE 040#55p;
     |CONSULTA_CLAVE #2#55;
     |CIERRA #55;
     |POPV;

     #1000#62 = #55#0;  |PINTA #1000#62;
|FPRC;

|PROCESO MiraHistorico;
     #1000#65 = Usuario % 810;  |PINTA #1000#65;

     |C_M #1000#0, 1, "S";

     |PARA nCampo = 0;  |SI nCampo [ 57;  |HACIENDO nCampo = nCampo + 1;
           |C_M #1000nCampo, 1, "S";
     |SIGUE;

     |SI #1000#62 = 0;  |ACABA;  |FINSI;

     |ABRE #55;
     #55#0 = #1000#62;
     |LEE 040#55=;
     |SI FSalida ! 0;
         |MENAV "      No existe el Registro en el Historico.";
         |ERROR;
         |CIERRA #55;
         |ACABA;
     |FINSI;
     |CIERRA #55;

     |PARA nCampo = 0;  |SI nCampo [ 57;  |HACIENDO nCampo = nCampo + 1;
           |C_M #1000nCampo, 1, "N";
     |SIGUE;

     #1000#0  = #55#4;      |PINTA #1000#0;
     #1000#1  = #55#5;      |PINTA #1000#1;
|FPRC;

|PROCESO SacaMailing;  |TIPO 66;
     |SI #1000#62 ! 0;  |ACABA;  |FINSI;

     |PUSHV 0501 2380;
     |ABRE #111;
     |LEE 040#111p;
     |CONSULTA_CLAVE #1#111;
     |CIERRA #111;
     |POPV;

     #1000#0  = #111#0;  |PINTA #1000#0;
     #1000#1  = #111#1;  |PINTA #1000#1;
|FPRC;

|PROCESO EstaElMailing;
     |ABRE #111;
     #111#0 = #1000#0;
     |LEE 040#111=;
     |SI FSalida ! 0;
         |MENAV "     No existe el Mailing";
         |ERROR;
     |FINSI;
     |CIERRA #111;

     #1000#1  = #111#1;  |PINTA #1000#1;
     #1000#63 = #111#5;  |PINTA #1000#63;

     |C_M #1000#58, 1, "N";
     |C_M #1000#59, 1, "N";
     |C_M #1000#60, 1, "N";
     |C_M #1000#61, 1, "N";

     |ABRE #112;

     #112#0 = #1000#0;
     #112#1 = "05000";
     |LEE 040#112];
     |SI FSalida = 0;
         aAlfa = ("00000" + #112#1) % -105;
         aAlfa = aAlfa % 102;
         |SI aAlfa = "05";
             |C_M #1000#58, 1, "S";
             |C_M #1000#59, 1, "S";
         |FINSI;
     |FINSI;

     #112#0 = #1000#0;
     #112#1 = "06000";
     |LEE 040#112];
     |SI FSalida = 0;
         aAlfa = ("00000" + #112#1) % -105;
         aAlfa = aAlfa % 102;
         |SI aAlfa = "06";
             |C_M #1000#60, 1, "S";
             |C_M #1000#61, 1, "S";
         |FINSI;
     |FINSI;

     |CIERRA #112;
|FPRC;

|PROCESO Parrilla;
     |SI #1000#62 ! 0;  |ACABA;  |FINSI;

     |SI #1000#2 = 0;
         #1000#2 = 0;  |PINTA #1000#2;
         #1000#3 = 0;  |PINTA #1000#3;  |C_M #1000#3, 1, "N";
         |PARA nCampo = 4;  |SI nCampo [ 45;  |HACIENDO nCampo = nCampo + 1;
               |C_M #1000nCampo, 1, "S";
         |SIGUE;
     |SINO;
         |C_M #1000#2, 1, "S";
         |C_M #1000#3, 1, "S";
         |PARA nCampo = 4;  |SI nCampo [ 45;  |HACIENDO nCampo = nCampo + 1;
               |C_M #1000nCampo, 1, "N";
               #1000nCampo = 0;  |PINTA #1000nCampo;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO NoMasEmpresas;
     |SI #1000#62 ! 0;  |ACABA;  |FINSI;

     |SI #1000Campo = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 45;  |HACIENDO nCampo = nCampo + 1;
               #1000Campo = 0;  |C_M #1000nCampo, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 45;  |HACIENDO nCampo = nCampo + 1;
               |C_M #1000nCampo, 1, "S";
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO TipoAct;
     |SI #1000#56 = 0;
         #1000#68  = "N";  |C_M #1000#68,  1, "N"; |PINTA #1000#68;
         #1000#129 = "N";  |C_M #1000#129, 1, "N"; |PINTA #1000#129;
     |SINO;
         |C_M #1000#68,  1, "S";
         |C_M #1000#129, 1, "S";
     |FINSI;
|FPRC;


|PROCESO SacaEpi;
     nCampoEpi1 = Campo - 1;       || Tipo Epigrafe
     nCampoEpi2 = Campo;           || Codigo Epigrafe

     eaEpigrafe = #1000nCampoEpi2;  |QBT eaEpigrafe;
     aAlfa      = eaEpigrafe % 0;
     |SI aAlfa  = "4";
         eaEpigrafe = (eaEpigrafe % 103) + "." + (eaEpigrafe % 401);
         |SI #1000nCampoEpi1 = " ";
             #1000nCampoEpi1 = "E";
         |FINSI;
     |FINSI;

     eaTipoEpi = #1000nCampoEpi1;
     |SI #1000nCampoEpi1 ! "E";  |Y #1000nCampoEpi1 ! "P";
      |Y #1000nCampoEpi1 ! "A";  |Y #1000nCampoEpi1 ! " ";
         eaTipoEpi = "O";
     |FINSI;

     enAgrupa = 0;
     |SI #1000nCampoEpi1 = "E";
         aAlfa    = #1000nCampoEpi2 % 101;
         enAgrupa = aAlfa;
         enAgrupa = enAgrupa * 100;
     |FINSI;

     |SI eaTipoEpi ! "O";
         |ABRE #102;
         #102#0 = eaTipoEpi;
         #102#1 = enAgrupa;
         #102#2 = eaEpigrafe;
         |LEE 040#102=;
         |SI FSalida ! 0;  nSwPantalla = 1;  |FINSI;
         |CIERRA #102;
     |SINO;
         eaEpigrafe = "9999";
     |FINSI;

     |SI nSwPantalla = 1;
         |SUB_EJECUTA_NP ":basica/agiepiz1";
     |FINSI;

     #1000nCampoEpi1 = eaTipoEpi;
     #1000nCampoEpi2 = eaEpigrafe;

     aAlfa        = eaEpigrafe % 0;
     |SI aAlfa    = "5";
         aAlfa        = (eaEpigrafe % 103) + (eaEpigrafe % 501);
          #1000nCampoEpi2 = aAlfa;
     |FINSI;

     |PINTA #1000nCampoEpi2;
|FPRC;

|PROCESO ConsuEpi;
     |SI #1000#68 = "N";  |ACABA;  |FINSI;

     nTecla = FSalida;
     |SI nTecla = 10;
         nSwPantalla = 1;
         |HAZ SacaEpi;
     |FINSI;

     |SI #1000Campo = "    ";
         |PARA nCampo = Campo + 2;  |SI nCampo [ 128;  |HACIENDO nCampo = nCampo + 2;
               #1000Campo = "";  |C_M #1000nCampo, 1, "N";
         |SIGUE;

         |ACABA;
     |SINO;
         |PARA nCampo = Campo + 2;  |SI nCampo [ 128;  |HACIENDO nCampo = nCampo + 2;
               |C_M #1000nCampo, 1, "S";
         |SIGUE;
     |FINSI;

     nSwPantalla = 0;
     |HAZ SacaEpi;
|FPRC;

|PROCESO ActivaEpi;
     |SI #1000#68 = "N";
         |PARA nCampo = 70;  |SI nCampo [ 128;  |HACIENDO nCampo = nCampo + 2;
               #1000nCampo = "";  |C_M #1000nCampo, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = 70;  |SI nCampo [ 128;  |HACIENDO nCampo = nCampo + 2;
               |C_M #1000nCampo, 1, "S";
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO ActivaModelo;
     |SI #1000#129 = "N";
         |PARA nCampo = 130;  |SI nCampo [ 159;  |HACIENDO nCampo = nCampo + 1;
               #1000nCampo = "";  |C_M #1000nCampo, 1, "N";
         |SIGUE;
         #1000#160 = "01.01.0000";  |C_M #1000#160, 1, "N";
         #1000#161 = "01.12.2999";  |C_M #1000#161, 1, "N";
     |SINO;
         |PARA nCampo = 130;  |SI nCampo [ 159;  |HACIENDO nCampo = nCampo + 1;
               |C_M #1000nCampo, 1, "S";
         |SIGUE;
         |C_M #1000#160, 1, "S";
         |C_M #1000#161, 1, "S";
     |FINSI;
|FPRC;

|PROCESO ConsuModelo;
     |SI #1000#129 = "N";  |ACABA;  |FINSI;

     nTecla = FSalida;
     |SI nTecla = 10;
         |ABRE #199;
         #199#0 = #1000Campo;
         |LEE 040#199];
         |CONSULTA_CLAVE #1#199;
         |SI FSalida = 0;  #1000Campo = #199#0;  |FINSI;
         |CIERRA #199;
     |FINSI;

     |SI #1000Campo = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 159;  |HACIENDO nCampo = nCampo + 1;
               #1000Campo = "";  |C_M #1000nCampo, 1, "N";
         |SIGUE;

         |ACABA;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 159;  |HACIENDO nCampo = nCampo + 1;
               |C_M #1000nCampo, 1, "S";
         |SIGUE;
     |FINSI;

     |ABRE #199;
     #199#0 = #1000Campo;
     |LEE 040#199=;
     |SI FSalida ! 0;  |O #199#4 = "N";
         |MENAV "     Modelo inexistente o desactivado.";
         |CIERRA #199;
         |ERROR;
         |ACABA;
     |FINSI;
     |CIERRA #199;

     |PINTA #1000Campo;
|FPRC;

| **************** PROCESOS PARA CREAR EL FICHERO DE IMPRESION

|PROCESO QuitaRaros;
     |QBF aAlfa;
     aCadena = "";
     aLen    = aAlfa % 0;
     nLen    = aLen;
     |PARA nCampo = 1;  |SI nCampo [ nLen;  |HACIENDO nCampo = nCampo + 1;
           nPosi = (100 * nCampo) + 1;
           aCaracter = aAlfa % nPosi;
           |SI aCaracter = "¥";  aCaracter = &209; |FINSI;
           |SI aCaracter = "¤";  aCaracter = &241; |FINSI;
           |SI aCaracter = " ";  aCaracter = &225; |FINSI;
           |SI aCaracter = "‚";  aCaracter = &233; |FINSI;
           |SI aCaracter = "¡";  aCaracter = &237; |FINSI;
           |SI aCaracter = "¢";  aCaracter = &243; |FINSI;
           |SI aCaracter = "£";  aCaracter = &250; |FINSI;
           |SI aCaracter = "§";  aCaracter = &176; |FINSI;
           |SI aCaracter = "¦";  aCaracter = &170; |FINSI;
           aCadena = aCadena + aCaracter;
     |SIGUE;
     aAlfa = aCadena;
|FPRC;

|PROCESO Asigna;
     FSalida = 0;
     aAlfa   = #999#2;   |HAZ QuitaRaros;
     |PARA; |SI FSalida = 0;  |HACIENDO;
            aAsigna   = "!" + #999#1;
            |WORD_ASIGNA_TEXTO nWord, aAsigna, aAlfa;
     |SIGUE;
|FPRC;

|DEFBUCLE dsaw0032;
     #999#1;
     ;
     00000, "        ";
     99999, "zzzzzzzz";
     ;
     NULL, Asigna;
|FIN;

|PROCESO dsam0000;
     #0#0 = #99#0;
     |LEE 040#0=;
     |SI FSalida ! 0;  |DDEFECTO #0;  |FINSI;

     #999#0 = 01000;
     #999#1 = "      ";
     |LEE 101#999];
     |PARA;  |SI; |HACIENDO;
             aAlfa = (("00000" + #999#0) % -105) % 102;
             |SI FSalida ! 0;     |LIBERA #999;  |SAL;  |FINSI;
             |SI aAlfa   ! "01";  |LIBERA #999;  |SAL;  |FINSI;
             |SI #999#3 = 0;
                 aCampo = (("00000" + #999#0) % -105) % 303;
                 nCampo = aCampo;
                 |SI #999#5 = "N";
                     aCaracter = " ";
                     |SI #999#4 [ 5;  aCaracter = "0";  |FINSI;
                     nPosi  = -(100 + #999#4)
                     #999#2 = ((aCaracter * #999#4) + #0nCampo) % nPosi;
                 |SINO;
                     #999#2 = #0nCampo;
                 |FINSI;
                 #999#3 = 1;
                 |GRABA 020#999a;
             |FINSI;
             |LIBERA #999;

             |LEE 101#999s;
     |SIGUE;
|FPRC;

|PROCESO dsay0004;
     #999#0 = 07000;
     #999#1 = "      ";
     |LEE 101#999];
     |PARA;  |SI; |HACIENDO;
             aAlfa = (("00000" + #999#0) % -105) % 102;
             |SI FSalida ! 0;     |LIBERA #999;  |SAL;  |FINSI;
             |SI aAlfa   ! "07";  |LIBERA #999;  |SAL;  |FINSI;
             |SI #999#3 = 0;
                 aCampo = (("00000" + #999#0) % -105) % 303;
                 nCampo = aCampo;
                 |SI #999#5 = "N";
                     aCaracter = " ";
                     |SI #999#4 [ 5;  aCaracter = "0";  |FINSI;
                     nPosi  = -(100 + #999#4)
                     #999#2 = ((aCaracter * #999#4) + #1000nCampo) % nPosi;
                 |SINO;
                     #999#2 = #1000nCampo;
                 |FINSI;
                 #999#3 = 1;
                 |GRABA 020#999a;
             |FINSI;
             |LIBERA #999;

             |LEE 101#999s;
     |SIGUE;
|FPRC;

|PROCESO LeeComent;
     nCodigo   = 0;
     nContador = nContador + 1;
     |SI nContador > 5;  |ERROR10;  |ACABA;  |FINSI;

     #999#0 = 02000;
     #999#1 = "      ";
     |LEE 101#999];
     |PARA;  |SI; |HACIENDO;
             aAlfa = (("00000" + #999#0) % -105) % 102;
             |SI FSalida ! 0;     |LIBERA #999;  |SAL;  |FINSI;
             |SI aAlfa   ! "02";  |LIBERA #999;  |SAL;  |FINSI;

             |SI #999#3 = 0;  |Y nCodigo ! #999#0;
                 nCodigo = #999#0;
                 aCampo  = (("00000" + #999#0) % -105) % 303;
                 nCampo  = aCampo;
                 |SI #999#5 = "N";
                     aCaracter = " ";
                     |SI #999#4 [ 5;  aCaracter = "0";  |FINSI;
                     nPosi  = -(100 + #999#4)
                     #999#2 = ((aCaracter * #999#4) + #2nCampo) % nPosi;
                 |SINO;
                     #999#2 = #2nCampo;
                 |FINSI;
                 #999#3 = 1;
                 |GRABA 020#999a;
             |FINSI;
             |LIBERA #999;

             |LEE 101#999s;
     |SIGUE;
|FPRC;

|DEFBUCLE dsam0002;
     #2#1;
     ;
     #99#0, 1;
     #99#0, 99;
     ;
     NULL, LeeComent;
|FIN;

|PROCESO LeeDirec;
     nCodigo   = 0;
     nContador = nContador + 1;
     |SI nContador > 5;  |ERROR10;  |ACABA;  |FINSI;

     #999#0 = 03000;
     #999#1 = "      ";
     |LEE 101#999];
     |PARA;  |SI; |HACIENDO;
             aAlfa = (("00000" + #999#0) % -105) % 102;
             |SI FSalida ! 0;     |LIBERA #999;  |SAL;  |FINSI;
             |SI aAlfa   ! "03";  |LIBERA #999;  |SAL;  |FINSI;

             |SI #999#3 = 0;  |Y nCodigo ! #999#0;
                 nCodigo = #999#0;
                 aCampo  = (("00000" + #999#0) % -105) % 303;
                 nCampo  = aCampo;
                 |SI #999#5 = "N";
                     aCaracter = " ";
                     |SI #999#4 [ 5;  aCaracter = "0";  |FINSI;
                     nPosi  = -(100 + #999#4)
                     #999#2 = ((aCaracter * #999#4) + #5nCampo) % nPosi;
                 |SINO;
                     #999#2 = #5nCampo;
                 |FINSI;
                 #999#3 = 1;
                 |GRABA 020#999a;
             |FINSI;
             |LIBERA #999;

             |LEE 101#999s;
     |SIGUE;
|FPRC;

|DEFBUCLE dsam0005;
     #5#2;
     ;
     #99#0, 99;
     #99#0, 00;
     ;
     NULL, LeeDirec;
|FIN;

|PROCESO LeeActi;
     nCodigo   = 0;
     nContador = nContador + 1;
     |SI nContador > 5;  |ERROR10;  |ACABA;  |FINSI;

     #999#0 = 04000;
     #999#1 = "      ";
     |LEE 101#999];
     |PARA;  |SI; |HACIENDO;
             aAlfa = (("00000" + #999#0) % -105) % 102;
             |SI FSalida ! 0;     |LIBERA #999;  |SAL;  |FINSI;
             |SI aAlfa   ! "04";  |LIBERA #999;  |SAL;  |FINSI;

             |SI #999#3 = 0;  |Y nCodigo ! #999#0;
                 nCodigo = #999#0;
                 aCampo  = (("00000" + #999#0) % -105) % 303;
                 nCampo  = aCampo;
                 |SI #999#5 = "N";
                     aCaracter = " ";
                     |SI #999#4 [ 5;  aCaracter = "0";  |FINSI;
                     nPosi  = -(100 + #999#4)
                     #999#2 = ((aCaracter * #999#4) + #6nCampo) % nPosi;
                 |SINO;
                     #999#2 = #6nCampo;
                 |FINSI;
                 #999#3 = 1;
                 |GRABA 020#999a;
             |FINSI;
             |LIBERA #999;

             |LEE 101#999s;
     |SIGUE;
|FPRC;

|DEFBUCLE agicen14;
     #6#1;
     7, 9, 16;
     #99#0, 00, #1000#52, #1000#54, #1000#56;
     #99#0, 99, #1000#53, #1000#55, #1000#57;
     ;
     NULL, LeeActi;
|FIN;

|PROCESO LeeAgenda;
     nCodigo   = 0;
     nContador = nContador + 1;
     |SI nContador > 5;  |ERROR10;  |ACABA;  |FINSI;

     #999#0 = 05000;
     #999#1 = "      ";
     |LEE 101#999];
     |PARA;  |SI; |HACIENDO;
             aAlfa = (("00000" + #999#0) % -105) % 102;
             |SI FSalida ! 0;     |LIBERA #999;  |SAL;  |FINSI;
             |SI aAlfa   ! "05";  |LIBERA #999;  |SAL;  |FINSI;

             |SI #999#3 = 0;  |Y nCodigo ! #999#0;
                 nCodigo = #999#0;
                 aCampo  = (("00000" + #999#0) % -105) % 303;
                 nCampo  = aCampo;
                 |SI #999#5 = "N";
                     aCaracter = " ";
                     |SI #999#4 [ 5;  aCaracter = "0";  |FINSI;
                     nPosi  = -(100 + #999#4)
                     #999#2 = ((aCaracter * #999#4) + #53nCampo) % nPosi;
                 |SINO;
                     #999#2 = #53nCampo;
                 |FINSI;
                 #999#3 = 1;
                 |GRABA 020#999a;
             |FINSI;
             |LIBERA #999;

             |LEE 101#999s;
     |SIGUE;
|FPRC;

|DEFBUCLE dsam0053;
     #53#1;
     ;
     #99#0, #1000#58, 00, 00, 00;
     #99#0, #1000#59, 99, 99, 99;
     ;
     NULL, LeeAgenda;
|FIN;

|PROCESO LeeDocum;
     nCodigo   = 0;
     nContador = nContador + 1;
     |SI nContador > 5;  |ERROR10;  |ACABA;  |FINSI;

     #999#0 = 06000;
     #999#1 = "      ";
     |LEE 101#999];
     |PARA;  |SI; |HACIENDO;
             aAlfa = (("00000" + #999#0) % -105) % 102;
             |SI FSalida ! 0;     |LIBERA #999;  |SAL;  |FINSI;
             |SI aAlfa   ! "06";  |LIBERA #999;  |SAL;  |FINSI;

             |SI #999#3 = 0;  |Y nCodigo ! #999#0;
                 nCodigo = #999#0;
                 aCampo  = (("00000" + #999#0) % -105) % 303;
                 nCampo  = aCampo;
                 |SI #999#5 = "N";
                     aCaracter = " ";
                     |SI #999#4 [ 5;  aCaracter = "0";  |FINSI;
                     nPosi  = -(100 + #999#4)
                     #999#2 = ((aCaracter * #999#4) + #54nCampo) % nPosi;
                 |SINO;
                     #999#2 = #54nCampo;
                 |FINSI;
                 #999#3 = 1;
                 |GRABA 020#999a;
             |FINSI;
             |LIBERA #999;

             |LEE 101#999s;
     |SIGUE;
|FPRC;

|DEFBUCLE dsam0054;
     #54#2;
     ;
     #99#0, 99;
     #99#0, 00;
     ;
     NULL, LeeDocum;
|FIN;

|PROCESO TemporalImpresion;
     nContador = nContador + 1;
     aAlfa     = ("00000" + #112#1) % -105;

     #999#0    = #112#1;
     |SI #112#5 = "dsam0000";  |O #112#5 = "dsay0004";
         #999#1 = "#" + (aAlfa % 102) + "#" + "0" + (aAlfa % 303);
     |SINO;
         #999#1 = "#" + (aAlfa % 102) + "#" + nCampo + (aAlfa % 303);
     |FINSI;
     #999#2 = "";
     #999#3 = 0;
     #999#4 = #112#6;
     #999#5 = #112#7;
     |GRABA 020#999n;
     |LIBERA #999;
|FPRC;

|DEFBUCLE dsam0112;
     #112#1;
     ;
     #1000#0, nDCodigo;
     #1000#0, nHCodigo;
     ;
     NULL, TemporalImpresion;
|FIN;

|PROCESO AbreWord;
     aAlfa = eaUnidadBasico + "/MODELOS";                   |RMKDIR aAlfa;
     aAlfa = eaUnidadBasico + "/MODELOS/DOCUMENTOS";        |RMKDIR aAlfa;

     nRegistro = 0;
     aOrigen   = eaRutaDocumento + "/" + #111#4;   |QBF aOrigen;
     aOrigen   = aOrigen + "." + eaExtension;      |QBF aOrigen;
     aDestino  = eaUnidadBasico + "/MODELOS/DOCUMENTOS/" + #111#4 + "." + eaExtension;  |QBT aDestino;

     |RCOPIA_FICHERO aOrigen, aDestino;
     |SI FSalida ! 0;
         |MENAV "      No se ha podido copiar el Documento al Directorio de Trabajo";
         |ACABA;
     |FINSI;

     nWord = 1;
     aAbre = aDestino;

     |MENSA "      Abriendo el Documento, espere un Momento.";

     |WORD_ABRE nWord, aAbre;
     |WORD_PROPIEDADES nWord, "Visible", "NO";
|FPRC;

|PROCESO CreaDocumento;
     |ABRE #54;
     #54#0  = #99#0;
     #54#1  = 9999;
     |LEE 040#54];
     |SI FSalida = 0;
         |LEE 040#54a;
     |SINO;
         |LEE 040#54u;
     |FINSI;
     |SI FSalida = 0;  |Y #54#0 = #99#0;
         nLinea = #54#1 + 1;
     |SINO;
         nLinea = 1;
     |FINSI;

     |DDEFECTO #54;
     |HORA aAlfa;
     aAlfa1 = aAlfa % 102;
     aAlfa2 = aAlfa % 402;

     #54#0  = #99#0;
     #54#1  = nLinea;
     #54#2  = #111#1;
     #54#3  = ((eaExtension + "zzz") % 103) + (("00000" + #54#0) % -105) + (("0000" + #54#1) % -104) + "." + eaExtension;
     #54#4  = ~;
     #54#5  = aAlfa1;
     #54#6  = aAlfa2;
     #54#7  = ~;
     #54#8  = aAlfa1;
     #54#9  = aAlfa2;
     #54#10 = enCodUbica;
     #54#11 = #1000#65;
     #54#12 = #1000#66;
     |GRABA 020#54n;
     |LIBERA #54;
     |CIERRA #54;

     aOrigen  = eaUnidadBasico + "/MODELOS/DOCUMENTOS/" + #111#4 + "." + eaExtension;
     aDestino = eaRutaDocumento + "/" + ((eaExtension + "zzz") % 103) + (("00000" + #99#0) % -105) + (("0000" + nLinea) % -104) + "." + eaExtension;
     |QBT aOrigen;
     |QBT aDestino;

     |RCOPIA_FICHERO aOrigen, aDestino;
     |SI FSalida ! 0;
         |MENAV "     No se ha podido copia el Documento al Cliente.";
     |FINSI;

     |RFBORRA aOrigen;
|FPRC;

|PROCESO Imprime;
     aDsPrint = eaUnidadBasico + "/MODELOS/DOCUMENTOS/dsprint.exe";
     aFichero = eaUnidadBasico + "/MODELOS/DOCUMENTOS/" + #111#4 + "." + eaExtension;
     |QBT aFichero;
     aAlfa    = "cmd " + &34 + "/c START /WAIT ";

     aAlfa    = aAlfa + aDsPrint + " " + aFichero + &34;
     |RSYSTEM aAlfa;
|FPRC;

|PROCESO CreaFichero;
     aFichero = ("32" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #999 aFichero;
     |ABRE #999;  |CIERRA #999;  |DELINDEX #999;

     |ABRE #999;
     nContador   = 0;
     nDCodigo    = 01000;  nHCodigo  = 01999;  |BUCLE dsam0112;
     nDCodigo    = 07000;  nHCodigo  = 07999;  |BUCLE dsam0112;

     |PARA nCampo = 1;  |SI nCampo [ 5;  |HACIENDO nCampo = nCampo + 1;
           nDCodigo  = 02000;  nHCodigo  = 02999;  |BUCLE dsam0112;
     |SIGUE;

     |PARA nCampo = 1;  |SI nCampo [ 5;  |HACIENDO nCampo = nCampo + 1;
           nDCodigo  = 03000;  nHCodigo  = 03999;  |BUCLE dsam0112;
     |SIGUE;

     |PARA nCampo = 1;  |SI nCampo [ 5;  |HACIENDO nCampo = nCampo + 1;
           nDCodigo  = 04000;  nHCodigo  = 04999;  |BUCLE dsam0112;
     |SIGUE;

     |PARA nCampo = 1;  |SI nCampo [ 5;  |HACIENDO nCampo = nCampo + 1;
           nDCodigo  = 05000;  nHCodigo  = 05999;  |BUCLE dsam0112;
     |SIGUE;

     |PARA nCampo = 1;  |SI nCampo [ 5;  |HACIENDO nCampo = nCampo + 1;
           nDCodigo  = 06000;  nHCodigo  = 06999;  |BUCLE dsam0112;
     |SIGUE;

     enCodUbica  = #111#2;  |HAZ LeeUbicaciones;
     |HAZ AbreWord;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |MENSA "      Asignando Campos";

     |HAZ dsam0000;
     |HAZ dsay0004;
     nContador = 0;  |BUCLE dsam0002;
     nContador = 0;  |BUCLE dsam0005;
     nContador = 0;  |BUCLE agicen14;
     nContador = 0;  |BUCLE dsam0053;
     nContador = 0;  |BUCLE dsam0054;

     |CIERRA #999;

     |BUCLE dsaw0032;

     #56#0 = #55#0;
     #56#1 = #99#0;
     #56#2 = #99#1;
     |GRABA 020#56n;
     |LIBERA #56;

     |WORD_SALVA nWord, "";

     ||ARA39
     ||Tengo que guardar y enviar por correo si es envio correo.
     ||pero tengo un problema, aqui esta usando dsprint
     ||y yo necesito que impriman usando dsxml.
     ||Nada, la solucion es sencilla, utilizo el dsxml, para crear el
     ||documento en .pdf y luego lo envio por correo.

     aAuxiliar = #99#4;
     |QBF aAuxiliar;
     |SI aAuxiliar = "PAPEL";
          |MENSA "      Imprimiendo Documento";
          |HAZ Imprime;
     |SINO;
          |HAZ MandaCorreo;
     |FINSI;

     |SI #1000#63 = "S";
          |HAZ CreaDocumento;
     |FINSI;
     |SI aAuxiliar ! "PAPEL";
          aFichero = eaUnidadBasico + "/MODELOS/DOCUMENTOS/" + #111#4 + "." + eaExtension;
          |QBT aFichero;
          |RFBORRA aFichero;
          aFichero = eaUnidadBasico + "/MODELOS/DOCUMENTOS/dos" + #111#4 + "." + eaExtension;
          |QBT aFichero;
          |RFBORRA aFichero;
          aFichero = eaUnidadBasico + "/MODELOS/DOCUMENTOS/dos" + #111#4 + ".pdf";
          |QBT aFichero;
          |RFBORRA aFichero;
     |FINSI;

     |RFBORRA aAbre;

     |DELINDEX #999;
|FPRC;


|DEFBUCLE dsaw0026;
     #99#2;
     ;
     00000, 00000;
     99999, 99999;
     ;
     NULL, CreaFichero;
|FIN;

|PROCESO CargaTexto;
     aAbre    = aDirCorreo + "/adjunto.txt";
     |XABRE "WB", aAbre, nHandle;

     aAlfa  = " " + &13 + &10;
     |XGRABA nHandle, aAlfa;

     |PARA nCampo = 172;  |SI nCampo [ 176;  |HACIENDO nCampo = nCampo + 1;
          eaAlfa  = #dsay0004#nCampo#;
          |QBF eaAlfa;
          |HAZ QuitaRarosPlb;
          |SI eaAlfa ! "";
              aAlfa  = eaAlfa + &13 + &10;
              |XGRABA nHandle, aAlfa;
          |FINSI;
     |SIGUE;

     |XCIERRA nHandle;
|FPRC;

|PROCESO MandaCorreo;
     eaDirTrabajo = eaUnidadBasico + "/MODELOS/DOCUMENTOS/";
     eaDirPlantilla = eaDirTrabajo;

     aFichero = eaUnidadBasico + "/MODELOS/DOCUMENTOS/" + #111#4 + "." + eaExtension;
     |QBT aFichero;

     aFicheroDos = eaUnidadBasico + "/MODELOS/DOCUMENTOS/dos" + #111#4;
     |QBF aFicheroDos;
     aFicheroDos = aFicheroDos + "." + eaExtension;

     eaFicheroTxt = "word2pdf.txt";

     aAbre = eaUnidadBasico + "/MODELOS/DOCUMENTOS/" + eaFicheroTxt;
     |XABRE "CWB", aAbre, nHandleTxt;

     aAlfa = "[FICHERO]#" + aFichero + "#" + aFicheroDos + &13 + &10;
     |XGRABA nHandleTxt, aAlfa;

     eaAlfa = "[IMPRESORA]#I#2#dspdf#2" + &13 + &10;
     |XGRABA nHandleTxt, eaAlfa;

     |XCIERRA nHandleTxt;

     |HAZ AbreWordExterno;

     aDirCorreo  = aBasePla + "dscorreo/";  |MKDIR aDirCorreo;

     aFicheroDos = eaUnidadBasico + "/MODELOS/DOCUMENTOS/dos" + #111#4;
     |QBF aFicheroDos;
     aFicheroDos = aFicheroDos + ".pdf";
     eaDestino   = aFicheroDos;
     eaOrigen    = aDirCorreo + "adjunto.pdf";
     |HAZ RecibeFichero;

     aIP      = #400#18;  |QBF aIP;
     aFrom    = #101#8;   |QBF aFrom;
     aSalida  = #400#19;  |QBF aSalida;

     aTo      = #99#3;   |QBF aTo;
     eaAlfa   = #dsay0004#171;     |HAZ QuitaRarosPlb;
     aAsunto  = eaAlfa;   |QBF aAsunto;
     aMensaje = "";

     |HAZ CargaTexto;
     aMensaje = "$$$$" + aAbre;

     aAdjunto = aDirCorreo + "adjunto.pdf";

     |SI #400#23 = "S";
          |SI #400#20 = "N";
               aAutenti = "!" + aFrom;
          |SINO;
               aAutenti = "!" + #400#22;
               |QBF aAutenti;
               aAutenti = aAutenti + ":" + #400#21;
               |QBF aAutenti;
               aAutenti = aAutenti + ":" + aFrom;
          |FINSI;
     |SINO;
          |SI #400#20 = "N";
               aAutenti = aFrom;
          |SINO;
               aAutenti = #400#22;
               |QBF aAutenti;
               aAutenti = aAutenti + ":" + #400#21;
               |QBF aAutenti;
               aAutenti = aAutenti + ":" + aFrom;
          |FINSI;
     |FINSI;

     |DSCORREO_ENVIA aIP, aSalida, aAutenti, aTo, aAsunto, aMensaje, aAdjunto;

     aAlfa  = aDirCorreo + "/adjunto.txt";  |FBORRA aAlfa;
     aAlfa  = aDirCorreo + "/adjunto.pdf";  |FBORRA aAlfa;
|FPRC;

|PROCESO CreaHistorico;
     #56#0 = #55#0;
     #56#1 = #99#0;
     #56#2 = #99#1;
     #56#3 = #99#2;
     |GRABA 020#56n;
     |LIBERA #56;
|FPRC;

|DEFBUCLE dsaw0026_2;
     #99#1;
     ;
     00000;
     99999;
     ;
     NULL, CreaHistorico;
|FIN;

| **************** PROCESOS PARA CREAR EL TEMPORAL

|PROCESO CreaTempo;
      nSwEsta = 1;
      |SI #1000#68 = "S";
          nSwEsta = 0;
          |PARA nCampo = 66;  |SI nCampo [ 128;  |HACIENDO nCampo = nCampo + 2;
                nCampo1 = nCampo - 1;
                |SI #1000nCampo1 = #6#2;  |Y #1000nCampo = #6#3;
                    nSwEsta = 1;
                    |SAL;
                |FINSI;
          |SIGUE;
      |FINSI;

      |SI nSwEsta = 0;  |ACABA;  |FINSI;

      |SI #1000#129 = "S";
          nSwEsta = 0;
          |ABRE #202;
          |PARA nCampo = 130;  |SI nCampo [ 159;  |HACIENDO nCampo = nCampo + 1;
                |SI #1000nCampo ! 0;
                    #202#0 = #6#0;
                    #202#1 = #6#1;
                    #202#2 = #1000nCampo;
                    |LEE 040#202=;
                    |SI FSalida = 0;
                        |SI #1000#160 = "00.00.0000";  #1000#160 = "01.01.0000";  |FINSI;
                        |SI #1000#161 = "00.00.0000";  #1000#161 = "31.12.2999";  |FINSI;
                        |SI #1000#161 = "01.01.0000";  #1000#161 = "31.12.2999";  |FINSI;

                        |SI #1000#160 ! "01.01.0000";  |O #1000#161 ! "31.12.2999";
                            |SI #202#8 = "00.00.0000";  #202#8 = "01.01.0000";  |FINSI;
                            |SI #202#9 = "00.00.0000";  #202#9 = "31.12.2999";  |FINSI;
                            |SI #202#9 = "01.01.0000";  #202#9 = "31.12.2999";  |FINSI;

                            |SI #202#8 = "01.01.0000";  |Y #202#9 = "31.12.2999";
                                nSwEsta = 1;
                            |FINSI;

                            |SI nSwEsta = 0;
                                |SI #202#8 ! "01.01.0000";
                                    |SI #202#8 < #1000#161;
                                        nSwEsta = 1;
                                    |FINSI;
                                |FINSI;

                                |SI #202#9 ! "31.12.2999";
                                    nSwEsta = 0;
                                    |SI #202#9 ] #1000#160;  |Y #202#9 [ #1000#161;
                                        nSwEsta = 1;
                                    |FINSI;
                                |FINSI;
                            |FINSI;
                        |SINO;
                            nSwEsta = 1;
                        |FINSI;
                        |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;
          |CIERRA #202;
      |FINSI;

      |SI nSwEsta = 0;  |ACABA;  |FINSI;

      #99#0 = #0#0;
      |LEE 040#99=;
      |SI FSalida = 0;  |ACABA;  |FINSI;
      #99#3 = aEmail;
      #99#4 = aFormato;
      nOrden = nOrden + 1;
      #99#0 = #0#0;
      #99#1 = #0#1;
      #99#2 = nOrden;
      |GRABA 020#99n;
      |LIBERA #99;
|FPRC;

|DEFBUCLE agicen14L;
     #6#1;
     7, 9, 16;
     #0#0, 00, #1000#52, #1000#54, #1000#56;
     #0#0, 99, #1000#53, #1000#55, #1000#57;
     ;
     NULL, CreaTempo;
|FIN;

|PROCESO MiraActividad;
     |SI #1000#50 = "N";
         |SI #0#85 = "A";  |ACABA;  |FINSI;
     |FINSI;

     |SI #1000#51 = "N";
         |SI #0#85 = "I";  |ACABA;  |FINSI;
     |FINSI;

     |SI #1000#162 = "S";
         |SI #0#49 ! "S";  |ACABA;  |FINSI;
     |FINSI;

     |SI #1000#163 ! "X";   ||contabilidad
         |SI #1000#163 ! #0#65; |ACABA; |FINSI;
     |FINSI;

     |SI #1000#164 ! "X";   ||fiscal
         |SI #1000#164 ! #0#66; |ACABA; |FINSI;
     |FINSI;

     |SI #1000#165 ! "X";   ||sociedades
         |SI #1000#165 ! #0#67; |ACABA; |FINSI;
     |FINSI;

     |SI #1000#166 ! "X";   ||renta
         |SI #1000#166 ! #0#68; |ACABA; |FINSI;
     |FINSI;

     |SI #1000#167 ! "X";   ||Laboral
         |SI #1000#167 ! #0#69; |ACABA; |FINSI;
     |FINSI;

     |SI #dsay0004#168 = "S";      ||PAPEL
          aFormato = "PAPEL";
          aEmail = "";

|| tique 3237_1269
          aEmail = #dsam0000#71; |QBF aEmail;
          |SI #dsay0004#177 = "S";      ||Solo papel
               |SI aEmail ! "";
                   |ACABA;             ||Si solo enviamos los que no tiene correo
               |FINSI;
          |FINSI;

     |SINO;
          aEmail = #dsam0000#71;
          |QBF aEmail;
          |SI #dsay0004#169 = "S";      ||CORREO
               aFormato = "CORREO";
               |SI aEmail = "";
                    |ACABA;             ||Si solo enviamos por correo y no tengo direccion
                                        ||no le enviamos el mailing a este cliente
               |FINSI;
          |SINO;                        ||SEGUN SI TIENE O NO DIR.CORREO
               |SI aEmail = "";
                    aFormato = "PAPEL";
               |SINO;
                    aFormato = "CORREO";
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #1000#56 = 0;
         #99#0 = #0#0;
         |LEE 040#99=;
         |SI FSalida = 0;  |ACABA;  |FINSI;

         nOrden = nOrden + 1;
         #99#0 = #0#0;
         #99#1 = #0#1;
         #99#2 = nOrden;

         #99#3 = aEmail;
         #99#4 = aFormato;

         |GRABA 020#99n;
         |LIBERA #99;
     |SINO;
         |BUCLE agicen14L;
     |FINSI;
|FPRC;

|DEFBUCLE dsam0000;
     #0#1;
     9, 50;
     nDCliente, #1000#46, #1000#48;
     nHCliente, #1000#47, #1000#49;
     ;
     NULL, MiraActividad;
|FIN;

|PROCESO MiraLinHisto;
     |DDEFECTO #dsam0000;
     #dsam0000#0 = #56#1;
     |LEE 000#dsam0000.=;

     |SI #dsay0004#168 = "S";      ||PAPEL
          aFormato = "PAPEL";
          aEmail = "";
|| tique 3237_1269
          aEmail = #dsam0000#71; |QBF aEmail;
          |SI #dsay0004#177 = "S";      ||Solo papel
               |SI aEmail ! "";
                   |ACABA;             ||Si solo enviamos los que no tiene correo
               |FINSI;
          |FINSI;
     |SINO;
          aEmail = #dsam0000#71;
          |QBF aEmail;
          |SI #dsay0004#169 = "S";      ||CORREO
               aFormato = "CORREO";
               |SI aEmail = "";
                    |ACABA;             ||Si solo enviamos por correo y no tengo direccion
                                        ||no le enviamos el mailing a este cliente
               |FINSI;
          |SINO;                        ||SEGUN SI TIENE O NO DIR.CORREO
               |SI aEmail = "";
                    aFormato = "PAPEL";
               |SINO;
                    aFormato = "CORREO";
               |FINSI;
          |FINSI;
     |FINSI;

     #99#0 = #56#1;
     #99#1 = #56#2;
     #99#2 = #56#3;
     |SI #99#2 > nOrden;
         nOrden = #99#2;
     |FINSI;

     #99#3 = aEmail;
     #99#4 = aFormato;

     |GRABA 020#99n;
     |LIBERA #99;
|FPRC;

|DEFBUCLE dsam0056;
     #56#1;
     ;
     #1000#62, 00000;
     #1000#62, 99999;
     ;
     NULL, MiraLinHisto;
|FIN;

|RUTINA ClaveBaja99;
     #99#0 = 1;
     #99#2 = 0;
|FRUT;

|RUTINA ClaveAlta99;
     #99#0 = 99999;
     #99#2 = 99999;
|FRUT;

|PROCESO Tipo0C168; |TIPO 0;
     |SI #dsay0004#168 = "S";
          #dsay0004#169 = "N";
          #dsay0004#170 = "N";
     |SINO;
          |SI #dsay0004#169 = "N"; |Y #dsay0004#170 = "N";
               #dsay0004#169 = "S";
          |FINSI;
     |FINSI;

     aAlfa1 = #dsay0004#168; |C_M #dsay0004#177,1, aAlfa1;
     |PINTA #dsay0004#168;
     |PINTA #dsay0004#169;
     |PINTA #dsay0004#170;

     |HAZ EstadoAsuntoCuerpo;
|FPRC;

|PROCESO Tipo0C169; |TIPO 0;
     |SI #dsay0004#169 = "S";
          #dsay0004#168 = "N";
          #dsay0004#170 = "N";
     |SINO;
          |SI #dsay0004#168 = "N"; |Y #dsay0004#170 = "N";
               #dsay0004#170 = "S";
          |FINSI;
     |FINSI;

     aAlfa1 = #dsay0004#168; |C_M #dsay0004#177,1, aAlfa1;
     |PINTA #dsay0004#168;
     |PINTA #dsay0004#169;
     |PINTA #dsay0004#170;

     |HAZ EstadoAsuntoCuerpo;
|FPRC;

|PROCESO Tipo0C170; |TIPO 0;
     |SI #dsay0004#170 = "S";
          #dsay0004#168 = "N";
          #dsay0004#169 = "N";
     |SINO;
          |SI #dsay0004#168 = "N"; |Y #dsay0004#169 = "N";
               #dsay0004#168 = "S";
          |FINSI;
     |FINSI;
     aAlfa1 = #dsay0004#168; |C_M #dsay0004#177,1, aAlfa1;
     |PINTA #dsay0004#168;
     |PINTA #dsay0004#169;
     |PINTA #dsay0004#170;

     |HAZ EstadoAsuntoCuerpo;
|FPRC;

|PROCESO EstadoAsuntoCuerpo;
     |SI #dsay0004#168 = "S";
          |C_M #dsay0004#171, 1, "N";
          |C_M #dsay0004#172, 1, "N";
          |C_M #dsay0004#173, 1, "N";
          |C_M #dsay0004#174, 1, "N";
          |C_M #dsay0004#175, 1, "N";
          |C_M #dsay0004#176, 1, "N";
     |SINO;
          |C_M #dsay0004#171, 1, "S";
          |C_M #dsay0004#172, 1, "S";
          |C_M #dsay0004#173, 1, "S";
          |C_M #dsay0004#174, 1, "S";
          |C_M #dsay0004#175, 1, "S";
          |C_M #dsay0004#176, 1, "S";
     |FINSI;
     |PINTA #dsay0004#171;
     |PINTA #dsay0004#172;
     |PINTA #dsay0004#173;
     |PINTA #dsay0004#174;
     |PINTA #dsay0004#175;
     |PINTA #dsay0004#176;
|FPRC;

|PROCESO Tipo12; |TIPO 12;

     |SI FSalida = 7;
          |ACABA;
     |FINSI;

     |SI #dsay0004#169 = "S"; |O #dsay0004#170 = "S";     ||CORREO
          aAsunto = #dsay0004#171;
          |QBF aAsunto;
          |SI aAsunto = "";
               aMensaje = "0000Por favor introduzca el asunto del correo";
               |MENAV aMensaje;
               |POSICIONATE #dsay0004#171;
               |ERROR;
               |ACABA;
          |FINSI;

          aCuerpo1 = #dsay0004#172; |QBF aCuerpo1;
          aCuerpo2 = #dsay0004#173; |QBF aCuerpo2;
          aCuerpo3 = #dsay0004#174; |QBF aCuerpo3;
          aCuerpo4 = #dsay0004#175; |QBF aCuerpo4;
          aCuerpo5 = #dsay0004#176; |QBF aCuerpo5;
          |SI aCuerpo1 = ""; |Y aCuerpo2 = ""; |Y aCuerpo3 = "";
           |Y aCuerpo4 = ""; |Y aCuerpo5 = "";
               aMensaje = "0000Por favor introduzca el cuerpo del correo";
               |MENAV aMensaje;
               |POSICIONATE #dsay0004#172;
               |ERROR;
               |ACABA;
          |FINSI;
     |FINSI;

     aMensaje = "0000SES CORRECTO?";
     |CONFI aMensaje;
     |SI FSalida = 0;
          nSwAcaba = 0;
     |SINO;
          nSwAcaba = 1;
     |FINSI;
|FPRC;

|PROCESO InstalaDSPDF;
     nInstala = 0;

     aDirBasico = "\ds";                     |RMKDIR aDirBasico;
     aDirBasico = aDirBasico + "\bin";       |RMKDIR aDirBasico;
     aDirBasico = aDirBasico + "\";
     aDirDsPdf  = "\ds\dspdf\bin\";
     aAlfa      = aDirDsPdf + "puerto.exe";
     |XABRE "EC", aAlfa, nHandle;
     |SI FSalida < 0;  nInstala = 1;  |FINSI;

     |DBASE aBase;  |QBF aBase;

     eaOrigen  = eaDirSerPlan + "dspdf.tgz";
     eaDestino = aDirBasico + "dspdf.tgz";

     |HAZ EnviaFicheroConMD5;
     |SI enSwNuevoMD5 = 1;
         nInstala = 1;
     |FINSI;

     |SI nInstala = 1;
         aAlfa = aDirBasico + "dspdf.tgz";
         Pos   = -1;
         |RDESCOMPRIME aAlfa;
         |RDETAR aAlfa, "\ds\";

         aAlfa = aDirBasico + "dspdf.tar";  |RFBORRA aAlfa;

         aAlfa = aDirDsPdf + "puerto.exe";
         |XABRE "EC", aAlfa, nHandle;
         |SI FSalida < 0;
             |MENAV "0000 No puedo instalar la impresora en PDF.";
             |ACABA;
         |FINSI;

         aAlfa  = "cmd " + &34 + "/c START /WAIT " + aDirDsPdf + "PUERTO.EXE" + &34;
         |RSYSTEM aAlfa;
     |FINSI;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;

|PROCESO Tipo3;  |TIPO 3;
     |SI nSwAcaba = 1;
          |ACABA;
     |FINSI;

     |SI #dsay0004#168 = "N";
          |HAZ TraeDsxml;
          ||Comprobaciones y controles para envio por correo

          |DBASE aBasePla;
          |QBF aBasePla;

          |DBASS aBase;  |QBF aBase;
          aAlfa = aBase + "dsarchi/dsarchi.men";
          |XABRE "E", aAlfa, nHandle;
          |SI FSalida < 0;
              |MENAV "0000El programa necesita el GAD instalado con la configuraci¢n del DSCORREO.";
              |ACABA;
          |FINSI;

          aAlfa = aBase + "dsarchi/fich/";
          |PATH_DAT #400 aAlfa;
          |ABRE #400;
          |LEE 000#400p;
          |SI FSalida ! 0;  |DDEFECTO #400;  |FINSI;
          |CIERRA #400;

          aAlfa = #400#18 + #400#19;  |QBT aAlfa;
          |SI aAlfa = "";
              |MENAV "0000No est  configurado el DSCORREO en GAD.";
              |ACABA;
          |FINSI;
          |ABRE #101;
          |LEE 000#101p;
          |SI FSalida ! 0;  |DDEFECTO #101;  |FINSI;
          |CIERRA #101;

          aAlfa = #101#8;  |QBT aAlfa;
          |SI aAlfa = "";
              |MENAV "0000No est  configurada la cuenta del correo del DESPACHO en Datos Generales del Despacho.";
              |ACABA;
          |FINSI;
     |FINSI;

     |HAZ LeeUnidadBasico;

     |DBASE aBase;  |QBF aBase;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;

     aOrigen = aBase + "plantillas/dsprint.exe";
     aDestino = eaUnidadBasico + "/MODELOS/DOCUMENTOS/dsprint.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     |SI aDocRemoto ! aDocServidor;
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     |ABRE #55;
     |LEE 040#55u;
     |SI FSalida ! 0;  |DDEFECTO #55;  |FINSI;

     |HORA aAlfa;
     aAlfa1 = aAlfa % 102;
     aAlfa2 = aAlfa % 402;

     #55#0  = #55#0 + 1;
     #55#1  = ~;
     #55#2  = aAlfa1;
     #55#3  = aAlfa2;
     #55#4  = #1000#0;
     #55#5  = #1000#1;
     #55#6  = #111#4;
     |GRABA 020#55n;
     |LIBERA #55;
     |CIERRA #55;

     aFichero = ("26" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #99 aFichero;
     |ABRE #99;  |CIERRA #99;  |DELINDEX #99;

     nSwDialogo = 0;
     nOrden     = 0;

     |ABRE #99;
     |SI #1000#62 = 0;
         |SI #1000#2 = 0;
             |PARA nCampo = 4;  |SI nCampo [ 45;  |HACIENDO nCampo = nCampo + 1;
                   |SI #1000nCampo ! 0;
                       nDCliente = #1000nCampo;
                       nHCliente = #1000nCampo;
                       |BUCLE dsam0000;
                   |FINSI;
             |SIGUE;
         |SINO;
             nDCliente = #1000#2;
             nHCliente = #1000#3;
             |BUCLE dsam0000;
         |FINSI;
     |SINO;
         |ABRE #dsam0000;
         |BUCLE dsam0056;
         |CIERRA #dsam0000;
     |FINSI;
     |CIERRA #99;

/*
     |C_V #99#3, 1, "N";
     |C_V #99#4, 1, "N";
*/

     |ENTLINEAL #2#99, -2, 2, 22, 1, ClaveBaja99, ClaveAlta99;

     |CONFI "0000SEmitimos el Mailing en estos momentos.";
     |SI FSalida = 0;
          |DBASS eaDirSerPlan;  |QBF eaDirSerPlan;
          eaDirSerPlan   = eaDirSerPlan + "dsarchi/dlls/";

          |HAZ InstalaDSPDF;

          |PTEC 802;  |PAUSA;

          |SI #dsay0004#168 = "S";
               |MENAV "0000 Los documentos se emitiran por la impresora predeterminada.";
          |FINSI;
          |ABRE #0;
          |ABRE #56;
          |BUCLE dsaw0026;
          |CIERRA #0;
          |CIERRA #56;
     |SINO;
          |ABRE #56;
          |BUCLE dsaw0026_2;
          |CIERRA #56;
     |FINSI;

     |DELINDEX #99;
|FPRC;
