7|FICHEROS;
    dsaz0041;

    dsam0027;
    dsam0028;

    dsam0029;
    dsam0030;

    dsat0010;
|FIN;

|VARIABLES;
     nPara1    = 0;

     nDEjer    = 0;
     nHEjer    = 0;
     fDFecha   = @;
     fHFecha   = @;
     fDFechaF  = @;
     fHFechaF  = @;
     nDEmpresa = 0;
     nHEmpresa = 0;
     nDExpedie = 0;
     nHExpedie = 0;
     nDMes     = 0;
     nHMes     = 0;
     aDFactu   = "";
     aHFactu   = "";
     aDEstado  = "";
     aHEstado  = "";
     aAlfa     = "";
     aAlfa1    = "";
     aAlfa2    = "";
     aFichero  = "";
     aDesdeFic = "";

     fFecha    = @;
     fFechaI   = @;
     aParam    = "";
|FIN;

|INCLUYE i_varfun;

|CALCULO HAny; |TIPO 0;
    |SI #dsaz0041#1 < #dsaz0041#0;
        |MENAV "0000Error. Hasta Ejercicio inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO HMes; |TIPO 0;
    |SI #dsaz0041#3 < #dsaz0041#2;
        |MENAV "0000Error. Hasta Ejercicio inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO HCliente; |TIPO 0;
    |SI #dsaz0041#6 < #dsaz0041#5;
        |MENAV "0000Error. Hasta Cliente inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO HExpe; |TIPO 0;
    |SI #dsaz0041#8 < #dsaz0041#7;
        |MENAV "0000Error. Hasta Expediente inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|| *******************************************************************
|PROCESO PasoAHisLinea;
   #dsam0030#0 = #dsam0028#0;
   #dsam0030#1 = #dsam0028#1;
   #dsam0030#2 = #dsam0028#2;
   |LEE 041#dsam0030.=;
   |SI FSalida ! 0;
       |PARA nPara1 = 0; |SI nPara1 [ 9; |HACIENDO nPara1 = nPara1 + 1;
             #dsam0030#nPara1# = #dsam0028#nPara1#
       |SIGUE;
       |GRABA 040#dsam0030.n;
       |BORRA 040#dsam0028.a;
   |FINSI;
   |LIBERA #dsam0028;
|FPRC;

|DEFBUCLE dsam0028;
   #dsam0028#1;
   ;
   #dsam0027#0, #dsam0027#1, "          ";
   #dsam0027#0, #dsam0027#1, "zzzzzzzzzz";
   be;
   NULL, PasoAHisLinea;
|FIN;

|PROCESO PasoAHistorico;
   #dsam0029#0 = #dsam0027#0;
   #dsam0029#1 = #dsam0027#1;
   |LEE 041#dsam0029.=;
   |SI FSalida ! 0;

       |SI aParam = ""; |PINTA 2133, #dsam0029#1; |FINSI;

       |BUCLE dsam0028;
       |PARA nPara1 = 0; |SI nPara1 [ 31; |HACIENDO nPara1 = nPara1 + 1;
             #dsam0029#nPara1# = #dsam0027#nPara1#
       |SIGUE;
       |GRABA 040#dsam0029.n;
       |BORRA 040#dsam0027.a;
   |FINSI;
   |LIBERA #dsam0027;
|FPRC;

|DEFBUCLE dsam0027;
   #dsam0027#1;
   5,4,3,28,24,8;
   eaFun07, nDExpedie, nDEmpresa, nDEjer, nDMes, aDEstado, aDFactu, fDFechaF;
   eaFun07, nHExpedie, nHEmpresa, nHEjer, nHMes, aHEstado, aHFactu, fHFechaF;
   be;
   NULL, PasoAHistorico;
|FIN;

|PROCESO PasoAManLinea;
   #dsam0028#0 = #dsam0030#0;
   #dsam0028#1 = #dsam0030#1;
   #dsam0028#2 = #dsam0030#2;
   |LEE 041#dsam0028.=;
   |SI FSalida ! 0;
       |PARA nPara1 = 0; |SI nPara1 [ 9; |HACIENDO nPara1 = nPara1 + 1;
             #dsam0028#nPara1# = #dsam0030#nPara1#
       |SIGUE;
       |GRABA 040#dsam0028.n;
       |BORRA 040#dsam0030.a;
   |FINSI;
   |LIBERA #dsam0030;
|FPRC;

|DEFBUCLE dsam0030;
   #dsam0030#1;
   ;
   #dsam0029#0, #dsam0029#1, "          ";
   #dsam0029#0, #dsam0029#1, "zzzzzzzzzz";
   be;
   NULL, PasoAManLinea;
|FIN;

|PROCESO PasoAMante;
   #dsam0027#0 = #dsam0029#0;
   #dsam0027#1 = #dsam0029#1;
   |LEE 041#dsam0027.=;
   |SI FSalida ! 0;

       |SI aParam = ""; |PINTA 2133, #dsam0027#1; |FINSI;

       |BUCLE dsam0030;
       |PARA nPara1 = 0; |SI nPara1 [ 31; |HACIENDO nPara1 = nPara1 + 1;
             #dsam0027#nPara1# = #dsam0029#nPara1#
       |SIGUE;
       |GRABA 040#dsam0027.n;
       |BORRA 040#dsam0029.a;
   |FINSI;
   |LIBERA #dsam0029;
|FPRC;

|DEFBUCLE dsam0029;
   #dsam0029#1;
   5,4,3,24,8;
   eaFun07, nDExpedie, nDEmpresa, nDEjer, nDMes, aDFactu, fDFechaF;
   eaFun07, nHExpedie, nHEmpresa, nHEjer, nHMes, aHFactu, fHFechaF;
   be;
   NULL, PasoAMante;
|FIN;

|PROCESO dsat0010;
  |SI aDesdeFic = "M";
      #dsam0027#0 = eaFun07;
      #dsam0027#1 = #dsat0010#0;
      |LEE 141#dsam0027.=;
      |SI FSalida = 0;
          |HAZ PasoAHistorico;
      |FINSI;
  |FINSI;

  |SI aDesdeFic = "H";
      #dsam0029#0 = eaFun07;
      #dsam0029#1 = #dsat0010#0;
      |LEE 141#dsam0029.=;
      |SI FSalida = 0;
          |HAZ PasoAMante;
      |FINSI;
  |FINSI;

|FPRC;

|DEFBUCLE dsat0010;
  #dsat0010#1;
  23;
  nDExpedie, "S";
  nHExpedie, "S";
  ;
  NULL, dsat0010;
|FIN;

|PROCESO Procesoz041;

     |SI #dsaz0041#11 ! "SI"; |ACABA; |FINSI;

     aFichero = ("4b" + Usuario) % 108;
     |NOME_DAT #dsat0010#aFichero#;

     aAlfa1 = #dsaz0041#0;
     aAlfa2 = "01.01." + aAlfa1; fDFecha = aAlfa2;
     aAlfa1 = #dsaz0041#1;
     aAlfa2 = "31.12." + aAlfa1; fHFecha = aAlfa2;

     nDEmpresa = #dsaz0041#5;
     nHEmpresa = #dsaz0041#6;
     nDExpedie = #dsaz0041#7;
     nHExpedie = #dsaz0041#8;
     nDMes     = #dsaz0041#2;
     nHMes     = #dsaz0041#3;
     nDEjer    = #dsaz0041#0;
     nHEjer    = #dsaz0041#1;
     fDFechaF  = #dsaz0041#9;
     fHFechaF  = #dsaz0041#10;
     aDEstado  = "S";
     aHEstado  = "S";

     aDFactu   = #dsaz0041#4;
     aHFactu   = #dsaz0041#4;
     |SI #dsaz0041#4 = "T";
         aDFactu   = " ";
         aHFactu   = "z";
     |FINSI;

     |SI aParam = "";
         |CUADRO 2008 2273;
         |PINTA 2110, "Pasando el Expediente: ";
     |FINSI;
     |SI aDesdeFic = "M";
         |ABRE #dsam0029;
         |ABRE #dsam0030;
         |SI aParam = "MF";
             |ABRE #dsam0027;
             |BUCLE dsat0010;
             |CIERRA #dsam0027;
         |SINO;
             |BUCLE dsam0027;
         |FINSI;
         |CIERRA #dsam0030;
         |CIERRA #dsam0029;
     |FINSI;

     |SI aDesdeFic = "H";
         |ABRE #dsam0027;
         |ABRE #dsam0028;
         |SI aParam = "HF";
             |ABRE #dsam0029;
             |BUCLE dsat0010;
             |CIERRA #dsam0029;
         |SINO;
             |BUCLE dsam0029;
         |FINSI;
         |CIERRA #dsam0028;
         |CIERRA #dsam0027;
     |FINSI;
|FPRC;

|PROGRAMA;

    eaFun07 = "A";
    aParam = PARAMETRO; |QBF aParam;
    aDesdeFic = "M";

    |SI aParam = "";
        |CLS;
        |CABEZA "Pasar al historico Expedientes finalizados ";

        fFecha = ~;
        aAlfa  = fFecha;
        aAlfa  = aAlfa % -104;
        #dsaz0041#0 = aAlfa;
        #dsaz0041#1 = aAlfa;
        aAlfa = "01.01." + aAlfa;
        fFechaI = aAlfa;
        |ABRE #dsaz0041;
        #dsaz0041#12 = "A";
        |LEE 041#dsaz0041.=;
        |SI FSalida ! 0;
            |DDEFECTO #dsaz0041;
            fFecha = ~;
            aAlfa  = fFecha;
            aAlfa  = aAlfa % -104;
            #dsaz0041#0 = aAlfa;
            #dsaz0041#1 = aAlfa;
            aAlfa = "01.01." + aAlfa;
            |GRABA 020#dsaz0041.b;
        |FINSI;
        #dsaz0041#11 = "NO";
        |PINPA #0#dsaz0041;
        |PINDA #0#dsaz0041;
        |ENDATOS #2#dsaz0041;
        |SI FSalida = 0;
            |GRABA 020#dsaz0041.a;
            |LIBERA #dsaz0041;
            |CIERRA #dsaz0041;
            |HAZ Procesoz041;
        |SINO;
            |LIBERA #dsaz0041;
            |CIERRA #dsaz0041;
        |FINSI;
    |SINO;
        aDesdeFic = "M";
        |DDEFECTO #dsaz0041;
        |SI aParam = "MA"; |O aParam = "HA";
            #dsaz0041#0  = 2000;
            #dsaz0041#1  = 2099;
            #dsaz0041#7  = enNExpediente;
            #dsaz0041#8  = enNExpediente;
            #dsaz0041#10 = "31.12.2999";
            #dsaz0041#11 = "SI";
        |FINSI;
        |SI aParam = "HA"; |O aParam = "HF"; aDesdeFic = "H"; |FINSI;
        |HAZ Procesoz041;
    |FINSI;
|FPRO;
