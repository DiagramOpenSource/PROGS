|FICHEROS;
    dsaz0031;

    dsam0000;
    dsam0023;
    dsam0024;
    dsam0105;
    dsam0109;
    dsam0110;

    dsat0003;
    :facturar/facemp1;
    ashismi@;
|FIN;

|VARIABLES;
     aAlfa  = "";
     aFichero  = "";

     aParam    = "";
     aAlfa1    = "";
     aAlfa2    = "";
     nPara1    = 0;
     nSw       = 0;
     aTitulo   = "";
     nImport1  = 0;
     nImport2  = 0;
     fFecha    = @;
     fDFecha   = @;
     fHFecha   = @;
     nEmpresa  = 0;
     nEjer     = 0;
     nAlgun    = 0;
     aBase     = "";
     aDef      = "";
     nSwError  = 0;
     aDObligA  = "";
     aHObligA  = "";
     aDObligB  = "";
     aHObligB  = "";
     nInkey    = 0;
     nExisteF  = 0;
     nCamp3    = 0;
     nCamp7    = 0;
     nCamp8    = 0;
     aCamp9    = "";
     nCamp10   = 0;
     nCamp13   = 0;
     nCamp14   = 0;

     &eSwImp     = 0;
     &eaFichero  = "";
     &eaDLiqu    = "";
     &eaHLiqu    = "";
     &aFuncion   = "";
     &enEjer     = 0;
     &enEmpPD    = 0;
     &enEmpresa  = 0;
     &enDEmpresa = 0;
     &enHEmpresa = 0;
     &enDAgente  = 0;
     &enHAgente  = 0;
     &enDMes     = 0;
     &enHMes     = 0;
     &enFEmp     = 0;
     &eaSFac     = "";
     &enNFac     = 0;
     &efFFac     = @;

     &enTotal1   = 0;
     &enTotal2   = 0;
|FIN;

|PROCESO Tipo66C3z31; |TIPO 66;
   |SI aFuncion = "A";
       |ABRE #dsam0109;
       #dsam0109#0 = #dsaz0031#Campo#;
       |CONSULTA_CLAVE #1#dsam0109;
       #dsaz0031#Campo# = #dsam0109#0;
       |CIERRA #dsam0109;
   |FINSI;

   |SI aFuncion = "B";
       |ABRE #dsam0110;
       #dsam0110#0 = #dsaz0031#Campo#;
       |CONSULTA_CLAVE #1#dsam0110;
       #dsaz0031#Campo# = #dsam0110#0;
       |CIERRA #dsam0110;
   |FINSI;

   |PINTA #dsaz0031#Campo#;
|FPRC;

|PROCESO LeeEmpColab; |TIPO 0;
   nSwError = 0;
   |SI aFuncion = "A";
       |ABRE #dsam0109;
       #dsam0109#0 = #dsaz0031#3;
       |LEE 041#dsam0109.=;
       |SI FSalida ! 0;
           nSwError = 1;
       |SINO;
           |SI #dsam0109#3 ! "S";
               nSwError = 2;
           |SINO;
               #dsaz0031#4 = #dsam0109#2;
               #dsaz0031#9 = #dsam0109#9;
           |FINSI;
       |FINSI;
       |CIERRA #dsam0109;
   |FINSI;
   |SI aFuncion = "B";
       |ABRE #dsam0110;
       #dsam0110#0 = #dsaz0031#3;
       |LEE 041#dsam0110.=;
       |SI FSalida ! 0;
           nSwError = 1;
       |SINO;
           |SI #dsam0110#3 ! "S";
               nSwError = 2;
           |SINO;
               #dsaz0031#4 = #dsam0110#2;
               #dsaz0031#9 = #dsam0110#10;
           |FINSI;
       |FINSI;
       |CIERRA #dsam0110;
   |FINSI;
   |SI nSwError = 0;
       |PINTA #dsaz0031#4;
       |PINTA #dsaz0031#9;
   |SINO;
       aAlfa = "0000No existe Empresa de Colaboradora";
       |SI nSwError = 2;
           aAlfa = "0000Empresa no Colaboradora";
       |FINSI;
       |MENAV aAlfa;
       |ERROR;
    |FINSI;
|FPRC;

|CALCULO HMes; |TIPO 0;
    |SI #dsaz0031#2 < #dsaz0031#1;
        |MENAV "0000Error. Hasta Mes inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO HEmpresa; |TIPO 0;
    |SI #dsaz0031#4 < #dsaz0031#3;
        |MENAV "0000Error. Hasta Empresa inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO HCliente; |TIPO 0;
    |SI #dsaz0031#6 < #dsaz0031#5;
        |MENAV "0000Error. Hasta Cliente inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO HAgente; |TIPO 0;
    |SI #dsaz0031#8 < #dsaz0031#7;
        |MENAV "0000Error. Hasta Cliente inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|PROCESO Tipo66C14z031; |TIPO 66;
     aBase = "";
     |DBASS aBase;  |QBT aBase;
     aBase = aBase + "facturar/fich/";

     |PATH_DAT #facemp1#aBase#;
     |ABRE #facemp1;
     #facemp1#0 = #dsaz0031#14;
     |CONSULTA_CLAVE #1#facemp1;
     #dsaz0031#14 = #facemp1#0;
     |PINTA #dsaz0031#14;
     |CIERRA #facemp1;
|FPRC;

|PROCESO Tipo0C14z031; |TIPO 0;
     aBase = "";
     |DBASS aBase;  |QBT aBase;
     aBase = aBase + "facturar/fich/";

     nExisteF = 0;
     #dsaz0031#18 = "";
     |PATH_DAT #facemp1#aBase#;
     |ABRE #facemp1;
     #facemp1#0 = #dsaz0031#14;
     |LEE 041#facemp1.=;
     |SI FSalida = 0;
         #dsaz0031#18 = #facemp1#1;
         nExisteF = 1;
     |FINSI;
     |CIERRA #facemp1;
|FPRC;

|PROCESO ClaveBaja;
   #ashismi@#0  = "  ";
   #ashismi@#1  = 00000;
   #ashismi@#29 = fDFecha;
|FPRC;

|PROCESO ClaveAlta;
   #ashismi@#0  = "zz";
   #ashismi@#1  = 99999;
   #ashismi@#29 = fHFecha;
|FPRC;

|PROCESO Tipo0C15z031; |TIPO 0;
     nInkey = FSalida;

     |SI nExisteF = 1;
         aBase = "";
         |DBASS aBase;  |QBT aBase;
         aDef  = aBase + "facturar/def/ashismic";
         |CARGA_DEF aDef, ashismi@;
         |SI FSalida ! 0; |ACABA; |FINSI;

         aBase = aBase + "facturar/fich/";
         aAlfa = aBase + (("00" + #dsaz0031#14) % -102) + "/";
         |PATH_DAT #ashismi@#aAlfa#;

         aAlfa1 = #dsaz0031#0;
         aAlfa2 = "01.01." + aAlfa1; fDFecha = aAlfa2;
         aAlfa2 = "31.12." + aAlfa1; fHFecha = aAlfa2;

         |SI nInkey = 10;
             |ABRE #ashismi@;
             #ashismi@#0 = #dsaz0031#15;
             #ashismi@#1 = #dsaz0031#16;
||             |CONSULTA_CLAVE #2#ashismi@;
             |CONSULTA_F_CLAVE #2#ashismi@, ClaveBaja, ClaveAlta;
             #dsaz0031#15 = #ashismi@#0;  |PINTA #dsaz0031#15;
             #dsaz0031#16 = #ashismi@#1;  |PINTA #dsaz0031#16;
             #dsaz0031#17 = #ashismi@#29; |PINTA #dsaz0031#17;
             |CIERRA #ashismi@;
         |FINSI;

         |DESCARGA_DEF #ashismi@;
    |FINSI;
|FPRC;

|| *******************************************************************
|PROCESO GrabaAuxiliar1;

    #dsat0003#0 = aFuncion;
    #dsat0003#1 = #dsaz0031#3;
    #dsat0003#2 = #dsaz0031#0;
    #dsat0003#3 = nCamp3;
    #dsat0003#4 = nEmpresa;
    |LEE 141#dsat0003.=;
    |SI FSalida ! 0;
        |DDEFECTO #dsat0003;
        #dsat0003#0 = aFuncion;
        #dsat0003#1 = #dsaz0031#3;
        #dsat0003#2 = #dsaz0031#0;
        #dsat0003#3 = nCamp3;
        #dsat0003#4 = nEmpresa;
        |GRABA 020#dsat0003.b;
    |FINSI;
    #dsat0003#5  = #dsaz0031#4;
    #dsat0003#6  = #dsam0000#1;
    #dsat0003#7  = nCamp7;
    #dsat0003#8  = nCamp8;
    #dsat0003#9  = aCamp9;
    #dsat0003#10 = nCamp10;
    #dsat0003#11 = #dsam0000#72;
    #dsat0003#12 = #dsam0000#52;
    #dsat0003#13 = nCamp13;
    #dsat0003#14 = nCamp14;
    #dsat0003#15 = #dsam0000#3;

    |GRABA 020#dsat0003.a;
    |LIBERA #dsat0003;

    #dsaz0031#10 = #dsaz0031#10 + #dsat0003#10;
    #dsaz0031#11 = #dsaz0031#11 + #dsat0003#14;
    nAlgun = 1;
|FPRC;

|PROCESO LeeDsam0023;
   |SI #dsam0023#15 ! 0;
       nCamp3  = #dsam0023#2;
       nCamp7  = #dsam0023#11;
       nCamp8  = #dsam0023#12;
       aCamp9  = #dsam0023#13;
       nCamp10 = #dsam0023#15;
       nCamp13 = 0;
       nCamp14 = 0;
       |HAZ GrabaAuxiliar1;
   |FINSI;
|FPRC;

|DEFBUCLE dsam0023;
   #dsam0023#1;
   3,13;
   nEmpresa, enEjer, enDMes, #dsaz0031#3, eaDLiqu;
   nEmpresa, enEjer, enHMes, #dsaz0031#3, eaHLiqu;
   e;
   NULL, LeeDsam0023;
|FIN;

|PROCESO LeeDsam0024;
   |SI #dsam0024#15 ! 0; |O #dsam0024#16 ! 0;
       nCamp3  = #dsam0024#2;
       nCamp7  = #dsam0024#10;
       nCamp8  = #dsam0024#11;
       aCamp9  = #dsam0024#13;
       nCamp10 = #dsam0024#15;
       nCamp13 = #dsam0024#12;
       nCamp14 = #dsam0024#16;
       |HAZ GrabaAuxiliar1;
   |FINSI;
|FPRC;

|DEFBUCLE dsam0024;
   #dsam0024#1;
   3,13;
   nEmpresa, enEjer, enDMes, #dsaz0031#3, eaDLiqu;
   nEmpresa, enEjer, enHMes, #dsaz0031#3, eaHLiqu;
   e;
   NULL, LeeDsam0024;
|FIN;

|PROCESO LeoDsam0000;
   nEmpresa = #dsam0000#0;
   |SI aFuncion = "A"; |BUCLE dsam0023; |FINSI;
   |SI aFuncion = "B"; |BUCLE dsam0024; |FINSI;
|FPRC;

|DEFBUCLE dsam0000;
   #dsam0000#1;
   72,121,122;
   enDEmpresa, enDAgente, aDObligA, aDObligB;
   enHEmpresa, enHAgente, aHObligA, aHObligB;
   e;
   NULL, LeoDsam0000;
|FIN;
|| ///////////////////////////////////////////////////////////////////////
|| ********************************************************************
|PROCESO GrabaM0024;
    #dsam0024#0 = #dsat0003#4;
    #dsam0024#1 = #dsat0003#2;
    #dsam0024#2 = #dsat0003#3;
    |LEE 141#dsam0024.=;
    |SI FSalida ! 0;
        |DDEFECTO #dsam0024;
        #dsam0024#0 = #dsat0003#4;
        #dsam0024#1 = #dsat0003#2;
        #dsam0024#2 = #dsat0003#3;
        |GRABA 020#dsam0024.b;
    |FINSI;

    #dsam0024#13 = "S";
    #dsam0024#14 = efFFac;
    #dsam0024#17 = eaSFac;
    #dsam0024#18 = enNFac;
    #dsam0024#19 = enFEmp;

    |GRABA 020#dsam0024.a;
    |LIBERA #dsam0024;
    nAlgun = 1;
|FPRC;

|PROCESO GrabaM0023;
    #dsam0023#0 = #dsat0003#4;
    #dsam0023#1 = #dsat0003#2;
    #dsam0023#2 = #dsat0003#3;
    |LEE 141#dsam0023.=;
    |SI FSalida ! 0;
        |DDEFECTO #dsam0023;
        #dsam0023#0 = #dsat0003#4;
        #dsam0023#1 = #dsat0003#2;
        #dsam0023#2 = #dsat0003#3;
        |GRABA 020#dsam0023.b;
    |FINSI;

    #dsam0023#13 = "S";
    #dsam0023#14 = efFFac;
    #dsam0023#16 = eaSFac;
    #dsam0023#17 = enNFac;
    #dsam0023#18 = enFEmp;

    |GRABA 020#dsam0023.a;
    |LIBERA #dsam0023;
    nAlgun = 1;
|FPRC;

|PROCESO dsat0003;
    |SI aFuncion = "A";  |HAZ GrabaM0023;  |FINSI;
    |SI aFuncion = "B";  |HAZ GrabaM0024;  |FINSI;
|FPRC;

|DEFBUCLE dsat0003;
  #dsat0003#1;
  9;
  aFuncion, #dsaz0031#3, enEjer, enDMes, enDEmpresa, "S";
  aFuncion, #dsaz0031#3, enEjer, enHMes, enHEmpresa, "S";
  ;
  NULL, dsat0003;
|FIN;

|PROCESO PasoDatos;
  nAlgun = 0;
  |ABRE #dsam0023;
  |ABRE #dsam0024;
  |ATRI S; |PINTA 1302, "Actualizando registros .... .... .... "; |ATRI 0;
  |BUCLE dsat0003;

  |CIERRA #dsam0024;
  |CIERRA #dsam0023;
  |SI nAlgun ! 0;
      |SI eSwImp = 1; |HAZ LosInformes; |FINSI;
      aAlfa = "0000Liquidadas las comisiones seleccionadas";
  |SINO;
      aAlfa = "0000No encontrados registros para Liquidar";
  |FINSI;
  |MENAV aAlfa;
|FPRC;
|| ********************************************************************
|| ///////////////////////////////////////////////////////////////////////

|RUTINA ClaveBaja001;
     #dsat0003#0  = aFuncion;
     #dsat0003#1  = #dsaz0031#3;
     #dsat0003#2  = #dsaz0031#0;
     #dsat0003#3  = enDMes;
     #dsat0003#4  = enDEmpresa;
|FRUT;

|RUTINA ClaveAlta001;
     #dsat0003#0  = aFuncion;
     #dsat0003#1  = #dsaz0031#3;
     #dsat0003#2  = #dsaz0031#0;
     #dsat0003#3  = enHMes;
     #dsat0003#4  = enHEmpresa;
|FRUT;

|PROCESO ProcesoZ031;

     eaFichero = ("4x" + Usuario) % 108;
     |NOME_DAT #dsat0003#eaFichero#;
     |SI aParam ! "Auto";
         |DELINDEX #dsat0003;
     |FINSI;

     aAlfa1 = #dsaz0031#0;
     aAlfa2 = "01.01." + aAlfa1; fDFecha = aAlfa2;
     aAlfa2 = "31.12." + aAlfa1; fHFecha = aAlfa2;

     enEjer  = #dsaz0031#0;
     eaDLiqu = "N";
     eaHLiqu = "N";
     aDObligA  = " "; aHObligA  = "z";
     aDObligB  = " "; aHObligB  = "z";
     |SI aFuncion = "A"; aDObligA  = "S"; aHObligA  = "S"; |FINSI;
     |SI aFuncion = "B"; aDObligB  = "S"; aHObligB  = "S"; |FINSI;


     enDEmpresa = #dsaz0031#5;
     enHEmpresa = #dsaz0031#6;
     enDAgente  = #dsaz0031#7;
     enHAgente  = #dsaz0031#8;
     enDMes     = #dsaz0031#1;
     enHMes     = #dsaz0031#2;

     #dsaz0031#10 = 0;  #dsaz0031#11 = 0;
     #dsaz0031#12 = 0;  #dsaz0031#13 = 0;

     enFEmp = #dsaz0031#14;
     eaSFac = #dsaz0031#15;
     enNFac = #dsaz0031#16;
     efFFac = #dsaz0031#17;

     |SI aParam ! "Auto";
         nAlgun = 0;
         |ABRE #dsat0003;
         |BUCLE dsam0000;
         |CIERRA #dsat0003;
     |SINO;
         #dsaz0031#10 = enTotal1;
         #dsaz0031#11 = enTotal2;
         nAlgun = 1;
     |FINSI;

     |PINTA #dsaz0031#10;
     |PINTA #dsaz0031#11;
     |SI nAlgun = 1;
         eSwImp  = 0;
         enEjer  = #dsaz0031#0;
         enEmpPD = #dsaz0031#3;
         |ENTLINEAL #1#dsat0003, -5, 4, 22, 0, ClaveBaja001, ClaveAlta001;
         |SI FSalida = 0;
             |CONFI "0000SDesea actualizar los datos Introducidos";
             |SI FSalida = 0;
                 |CONFI "0000SDesea obtener un informe de las comisiones liquidadas";
                 |SI FSalida = 0; eSwImp = 1; |FINSI;
                 |HAZ PasoDatos;
             |FINSI;
         |FINSI;
     |SINO;
         |MENAV "0000Seleccion vacia";
     |FINSI;
     |DELINDEX #dsat0003;
|FPRC;

|PROGRAMA;

    aParam = PARAMETRO; |QBF aParam;
    |SI aParam ! "Auto";
        aFuncion = PARAMETRO; |QBF aFuncion;
    |FINSI;
    |SI aFuncion = ""; aFuncion = "A"; |FINSI;

    |CLS;
    |CABEZA "Liquidar Comision";

    aTitulo = "Proteccion de Datos";
    |SI aFuncion = "B";
        aTitulo = "Prevencion de Riesgos";
    |FINSI;

    fFecha = ~;
    aAlfa  = fFecha;
    aAlfa  = aAlfa % -104;
    #dsaz0031#0 = aAlfa;

    |PINPA #0#dsaz0031;
    |ATRI R; |PINTA 0543, aTitulo; |ATRI 0;
    |SI aFuncion = "B";
        |C_V #dsaz0031#11,1,"S";
        |C_V #dsaz0031#13,1,"S";
        |C_V #dsat0003#13,1,"S";
        |C_V #dsat0003#14,1,"S";
        |C_P #dsat0003#3, 1, 1703;
        |C_P #dsat0003#4, 1, 1708;
        |C_P #dsat0003#6, 1, 1508; |C_L #dsat0003#6,1,"N";
        |C_P #dsat0003#11,1, 1716;
        |C_P #dsat0003#7, 1, 1721;
        |C_P #dsat0003#8, 1, 1736;
        |C_P #dsat0003#10,1, 1743;

        |PINTA 1504, "ÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ";
        |PINTA 1604, "  ³       ³    ³              ³                      ";
        |PINTA 1704, "  ³       ³    ³              ³                      ";
        |PINTA 1804, "  ³       ³    ³              ³                      ";
        |PINTA 1904, "  ³       ³    ³              ³                      ";
        |PINTA 2004, "  ³       ³    ³              ³                      ";
        |PINTA 2104, "  ³       ³    ³              ³                      ";
        |PINTA 2204, "  ³       ³    ³              ³                      ";
        |PINTA 2304, "ÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ";

        |ATRI S; |PINTA 1111, "PR"; |ATRI 0;
        |ATRI R; |PINTA 1602, "Mes ";
                 |PINTA 1607, "Cliente";
                 |PINTA 1615, "Agen";
                 |PINTA 1620, " Impor.pagado ";
                 |PINTA 1635, " %Comision Prevision  % Comision Vigilac."; |ATRI 0;
    |FINSI;

    |SI aParam ! "Auto";
        |PINDA #0#dsaz0031;

        |PUSHV 0701 2380;
        nSw = 0;
        |PARA; |SI nSw = 0; |HACIENDO;

               |ENDATOS #2#dsaz0031;
               |SI FSalida = 0;
                   |HAZ ProcesoZ031;
                   |POPV;

                    #dsaz0031#3 = 1;
                    #dsaz0031#4 = "";
                    |PDEFECTO #dsaz0031,9,19;
                    |PINDA #0#dsaz0031;
                    |PUSHV 0701 2380;
               |SINO;
                   nSw = 1;
               |FINSI;
        |SIGUE;
        |POPV;
    |SINO;
         eaFichero = ("4x" + Usuario) % 108;
         |NOME_DAT #dsat0003#eaFichero#;

         #dsaz0031#0 = enEjer;  |C_M #dsaz0031#0,1, "N";
         #dsaz0031#1 = enDMes;  |C_M #dsaz0031#1,1, "N";
         #dsaz0031#2 = enDMes;  |C_M #dsaz0031#2,1, "N";
         #dsaz0031#3 = enEmpPD; |C_M #dsaz0031#3,1, "N";
         #dsaz0031#5 = enDEmpresa; |C_M #dsaz0031#5,1, "N";
         #dsaz0031#6 = enHEmpresa; |C_M #dsaz0031#6,1, "N";
         #dsaz0031#7 = enDAgente;  |C_M #dsaz0031#7,1, "N";
         #dsaz0031#8 = enHAgente;  |C_M #dsaz0031#8,1, "N";

         |HAZ LeeEmpColab;
         |PINDA #0#dsaz0031;
         |ENTLINEAL #1#dsat0003, -5, 7, 22, 0, ClaveBaja001, ClaveAlta001;

         |ENDATOS #2#dsaz0031;
         |SI FSalida = 0;
             |HAZ ProcesoZ031;
         |FINSI;
    |FINSI;
|FPRO;
