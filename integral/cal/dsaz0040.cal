7|FICHEROS;
    dsaz0040;

    dsam0000;
    dsam0026;
    dsam0027;
    dsam0028;

    dsat0010,MANTE;
|FIN;

|VARIABLES;
     aAlfa     = "";
     aAlfa1    = "";
     aAlfa2    = "";
     aFichero  = "";
     aParam    = "";
     fFecha    = @;
     fFechaI   = @;
     nAlgun    = 0;
     nOk       = 0;
     nNume1    = 0;
     nGraba    = 0;
     aDFactu   = "";
     aHFactu   = "";
     aDEstado  = "";
     aHEstado  = "";
     nDEjer    = 0;
     nHEjer    = 0;
     fDFecha   = @;
     fHFecha   = @;
     nDEmpresa = 0;
     nHEmpresa = 0;
     nDExpedie = 0;
     nHExpedie = 0;
     nDMes     = 0;
     nHMes     = 0;
     nHay      = 0;
     nEmpresa  = 0;
     nTecla    = 0;
|FIN;

|INCLUYE i_varfun;

|CALCULO HAny; |TIPO 0;
    |SI #dsaz0040#1 < #dsaz0040#0;
        |MENAV "0000Error. Hasta Ejercicio inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO HMes; |TIPO 0;
    |SI #dsaz0040#3 < #dsaz0040#2;
        |MENAV "0000Error. Hasta Ejercicio inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO HCliente; |TIPO 0;
    |SI #dsaz0040#6 < #dsaz0040#5;
        |MENAV "0000Error. Hasta Cliente inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO HExpe; |TIPO 0;
    |SI #dsaz0040#8 < #dsaz0040#7;
        |MENAV "0000Error. Hasta Expediente inferior al Desde";
        |ERROR;
    |FINSI;
|FCAL;

|CALCULO Tipo0C19z040; |TIPO 0;
    aAlfa1 = "S";
    |SI #dsaz0040#19 = 00;
        aAlfa1 = "N";
        #dsaz0040#20 = 0000;
        |PINTA #dsaz0040#20;
    |FINSI;
    |C_M #dsaz0040#20, 1, aAlfa1;
|FCAL;

|| *******************************************************************
|PROCESO GrabaAuxiliar10;
   #dsat0010#0  = #dsam0027#1;
   |LEE 041#dsat0010.=;
   |SI FSalida ! 0;
       |DDEFECTO #dsat0010;
       #dsat0010#0  = #dsam0027#1;
       #dsat0010#1  = #dsam0027#3;
       #dsat0010#2  = #dsam0027#4;
       #dsat0010#3  = #dsam0027#5;
       #dsat0010#4  = #dsam0027#6;
       #dsat0010#5  = #dsam0027#2;
       #dsat0010#6  = #dsam0027#7;
       #dsat0010#7  = #dsam0027#30;
       #dsat0010#8  = #dsam0027#9;
       #dsat0010#9  = #dsam0027#10;
       #dsat0010#10 = #dsam0027#11;
       #dsat0010#11 = #dsam0027#12;
       #dsat0010#12 = #dsam0027#8;
       #dsat0010#13 = #dsam0027#13;
       #dsat0010#14 = #dsam0027#14;
       #dsat0010#15 = #dsam0027#24;
       #dsat0010#16 = #dsam0027#25;
       #dsat0010#17 = #dsam0027#26;
       #dsat0010#18 = #dsam0027#27;
       #dsat0010#19 = #dsam0027#16;

       |SI #dsaz0040#19 ! 0;
           #dsat0010#20 = #dsaz0040#19;
           #dsat0010#21 = #dsaz0040#20;
       |SINO;
           #dsat0010#20 = #dsam0027#3;
           #dsat0010#21 = #dsam0027#4 + 2;
       |FINSI;

       #dsat0010#22 = #dsaz0040#10;
       #dsat0010#23 = #dsaz0040#22;
       |GRABA 020#dsat0010.b;
   |FINSI;
   nAlgun = 1;
|FPRC;

|PROCESO LeoDsam0027;
   nHay     = 0;
   nEmpresa = #dsam0027#5;

   |SI #dsam0027#9  [ "01.01.0000"; |ACABA; |FINSI;
   |SI #dsam0027#10 [ "01.01.0000"; |ACABA; |FINSI;
   |SI #dsam0027#11 [ "01.01.0000"; |ACABA; |FINSI;
   |SI #dsam0027#12 [ "01.01.0000"; |ACABA; |FINSI;

   nOk = 0;
   |SI #dsam0027#10 < #dsaz0040#13; |O #dsam0027#10 > #dsaz0040#14; nOk = 1; |FINSI;
   |SI #dsam0027#11 < #dsaz0040#15; |O #dsam0027#11 > #dsaz0040#16; nOk = 1; |FINSI;
   |SI #dsam0027#12 < #dsaz0040#17; |O #dsam0027#12 > #dsaz0040#18; nOk = 1; |FINSI;

   |SI nOk = 1; |ACABA; |FINSI;

   |HAZ GrabaAuxiliar10;
|FPRC;

|DEFBUCLE dsam0027;
   #dsam0027#1;
   5,4,3,28,24;
   eaFun07, nDExpedie, nDEmpresa, nDEjer, nDMes, aDEstado, aDFactu;
   eaFun07, nHExpedie, nHEmpresa, nHEjer, nHMes, aHEstado, aHFactu;
   e;
   NULL, LeoDsam0027;
|FIN;

|| ********************************************************************
|PROCESO Tipo7C22t010;  |TIPO 7;
   aAlfa = "0000Entre Fecha de Finalizacion Expediente";
   |MENSA aAlfa;
|FPRC;

|PROCESO Tipo0C22t010;  |TIPO 0;
   |BLIN 4;
   |SI FSalida = 11;
       #dsat0010#22 = #dsaz0040#10;
       |PINTA #dsat0010#22;
   |FINSI;
|FPRC;

|PROCESO Tipo11t010;  |TIPO 11;
     nTecla = FSalida;

     |SI nTecla = 10;
         |LEE 141#dsat0010.=;

|ET Campo20;
         nGraba = 0;
         |ENCAMPO #20#dsat0010;
         |SI FSalida = 7; |VETE Fin; |FINSI;
         |SI FSalida = 1; nGraba = 1; |VETE Fin; |FINSI;

|ET Campo21;
         |ENCAMPO #21#dsat0010;
         |SI FSalida = 7; |VETE Fin; |FINSI;
         |SI FSalida = 1; nGraba = 1; |VETE Fin; |FINSI;
         |SI FSalida = 2; |VETE Campo20; |FINSI;

|ET Campo22;
         |ENCAMPO #22#dsat0010;
         |SI FSalida = 7; |VETE Fin; |FINSI;
         |SI FSalida = 1; nGraba = 1; |VETE Fin; |FINSI;
         |SI FSalida = 2; |VETE Campo21; |FINSI;

|ET Campo23;
         |ENCAMPO #23#dsat0010;
         |SI FSalida = 7; |VETE Fin; |FINSI;
         |SI FSalida = 1; nGraba = 1; |VETE Fin; |FINSI;
         |SI FSalida = 2; |VETE Campo22; |FINSI;

         nGraba = 1;
|ET Fin;
         |SI nGraba = 1;
             |GRABA 020#dsat0010.a;
         |FINSI;
         |LIBERA #dsat0010;

         |PONCONTROL  23, "SI";
     |FINSI;

     |SI nTecla = 16;
         |CONFI "0000SDesea borrar el registro (No actualiza en Cliente)";
         |SI FSalida = 0;
             |LEE 141#dsat0010.=;
             |BORRA 020#dsat0010.a;
             |LIBERA #dsat0010;
         |FINSI;
         |PONCONTROL  23, "SI";
     |FINSI;
|FPRC;

|| ///////////////////////////////////////////////////////////////////////
|PROCESO dsat0010;
  #dsam0027#0 = eaFun07;
  #dsam0027#1 = #dsat0010#0;
  |LEE 141#dsam0027.=;
  |SI FSalida = 0;
      #dsam0027#8 = #dsat0010#22;
      #dsam0027#28 = "S";
      |GRABA 020#dsam0027.a;
      enNExpediente = #dsam0027#1;
      enEmpresa     = #dsam0027#5;
      enMesRen      = #dsat0010#20;
      enEjeRen      = #dsat0010#21;
      enOpcion      = 1;
      |HAZ ActuaDsm0026;
      enOpcion      = 0;
      |SI #dsat0010#23 = "S"; nAlgun = 1; |FINSI;
  |FINSI;
  |LIBERA #dsam0027;
|FPRC;

|DEFBUCLE dsat0010;
  #dsat0010#1;
  ;
  nDExpedie;
  nHExpedie;
  ;
  NULL, dsat0010;
|FIN;

|PROCESO PasoDatos;
  nAlgun = 0;
  |ABRE #dsam0027;
  |ATRI S; |PINTA 2302, "Actualizando registros .... .... .... "; |ATRI 0;
  |BUCLE dsat0010;
  |CIERRA #dsam0027;

  |SI nAlgun = 1;
      |ATRI S; |PINTA 2302, "Actualizando historico .... .... .... "; |ATRI 0;
      |SUB_EJECUTA "dsaz0041;MF";
  |FINSI;
|FPRC;

|RUTINA ClaveBaja010;
     #dsat0010#0  = nDExpedie;
|FRUT;

|RUTINA ClaveAlta010;
     #dsat0010#0  = nHExpedie;
|FRUT;

|PROCESO LaPantalla;

    |PINPA #0#dsat0010;
    |PINTA 0841, "Visado Actual:                ";
    |PINTA 0941, "                              ";
    |PINTA 1041, "Fecha Inicio .....: ";
    |PINTA 2241, "Facturado ...: ";
    |ATRI S; |PINTA 0641, "Pasar al historico de expedientes:   "; |ATRI 0;

    |C_P #dsat0010#1,1,0856;|C_L #dsat0010#1,1,"N";
    |C_P #dsat0010#2,1,0861;|C_L #dsat0010#2,1,"N";

    |C_P #dsat0010#8,1,1061;
    |C_V #dsat0010#20,1,"S";|C_M #dsat0010#20,1,"S";
    |C_V #dsat0010#21,1,"S";|C_M #dsat0010#21,1,"S";
    |C_V #dsat0010#15,1,"S";
    |C_V #dsat0010#16,1,"S";
    |C_V #dsat0010#17,1,"S";
    |C_V #dsat0010#18,1,"S";
    |C_V #dsat0010#23,1,"S";|C_M #dsat0010#23,1,"S";

    |ATRI R; |PINTA 0619, "  Nueva  "; |ATRI 0;
    |ATRI R; |PINTA 0719, "F.Visado "; |ATRI 0;
    |ATRI R; |PINTA 0629, " Fecha    "; |ATRI 0;
    |ATRI R; |PINTA 0729, "Finalizad."; |ATRI 0;

|FPRC;

|PROCESO ProcesoZ040;

     aFichero = ("4b" + Usuario) % 108;
     |NOME_DAT #dsat0010#aFichero#;
     |DELINDEX #dsat0010;

     aAlfa1 = #dsaz0040#0;
     aAlfa2 = "01.01." + aAlfa1; fDFecha = aAlfa2;
     aAlfa1 = #dsaz0040#1;
     aAlfa2 = "31.12." + aAlfa1; fHFecha = aAlfa2;

     nDEmpresa = #dsaz0040#5;
     nHEmpresa = #dsaz0040#6;
     nDExpedie = #dsaz0040#7;
     nHExpedie = #dsaz0040#8;
     nDMes     = #dsaz0040#2;
     nHMes     = #dsaz0040#3;
     nDEjer    = #dsaz0040#0;
     nHEjer    = #dsaz0040#1;
     aDEstado  = "N";
     aHEstado  = "N";

     aDFactu   = #dsaz0040#4;
     aHFactu   = #dsaz0040#4;
     |SI #dsaz0040#4 = "T";
         aDFactu   = " ";
         aHFactu   = "z";
     |FINSI;

     |ABRE #dsat0010;
     |ABRE #dsam0000;
     nAlgun = 0;
     |BUCLE dsam0027;
     |CIERRA #dsam0000;
     |CIERRA #dsat0010;

     |SI nAlgun = 1;

||         |ABRE #dsat0010;
||         |CONSULTA_CLAVE #1#dsat0010;
||         |CIERRA  #dsat0010;

         |HAZ LaPantalla;
         |ENTLINEAL #1#dsat0010, -1, 4, 21, 0, ClaveBaja010, ClaveAlta010;
         |SI FSalida = 0;
             |CONFI "0000SDesea actualizar los datos Introducidos";
             |SI FSalida = 0;
                 |HAZ PasoDatos;
             |FINSI;
         |FINSI;
     |SINO;
         |MENAV "0000Seleccion vacia";
     |FINSI;

     |DELINDEX #dsat0010;
|FPRC;

|PROGRAMA;

    eaFun07 = "A";
    aParam = PARAMETRO; |QBF aParam;

    |CLS;
    |CABEZA "Finalizacion de Expedientes";

    fFecha = ~;
    aAlfa  = fFecha;
    aAlfa  = aAlfa % -104;
    #dsaz0040#0 = aAlfa;
    #dsaz0040#1 = aAlfa;
    aAlfa = "01.01." + aAlfa;
    fFechaI = aAlfa;
    |ABRE #dsaz0040;
    #dsaz0040#21 = "A";
    |LEE 041#dsaz0040.=;
    |SI FSalida ! 0;
        |DDEFECTO #dsaz0040;
        aAlfa  = fFecha;
        aAlfa  = aAlfa % -104;
        #dsaz0040#0 = aAlfa;
        #dsaz0040#1 = aAlfa;
        aAlfa = "01.01." + aAlfa;
        fFechaI = aAlfa;
        #dsaz0040#11 = fFechaI;
        #dsaz0040#12 = fFecha;
        |GRABA 020#dsaz0040.b;
    |FINSI;
    #dsaz0040#10 = fFecha;
    |PINPA #0#dsaz0040;
    |PINDA #0#dsaz0040;
    |ENDATOS #2#dsaz0040;
    |SI FSalida = 0;
        |GRABA 020#dsaz0040.a;
        |LIBERA #dsaz0040;
        |CIERRA #dsaz0040;
        |HAZ ProcesoZ040;
    |SINO;
        |LIBERA #dsaz0040;
        |CIERRA #dsaz0040;
    |FINSI;
|FPRO;
