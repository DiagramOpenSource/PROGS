|FICHEROS;
     dsam0001;
     av060z01;

     :agitool/crontcom;
|FIN;

|VARIABLES;
     nSwCreaTareas  = 0;
     nSwModoUBasico = 0;
     nHandle        = 0;
     nSwEstaTarea   = 0;
     nClave         = 0;
     nLinea         = 0;
     nTab1          = 0;
     nExiste        = 0;
     nContador      = 0;
     nRegis         = 0;
     nLong          = 0;
     nPos           = 0;
     nCanal         = 0;
     nBufUsr        = 0;
     nEleUsr        = 0;
     nSwEsta        = 0;
     nNumero        = 0;
     nMayor         = 0;

     aAlfa          = "";
     aSistema       = "";
     aReturn        = "";
     aBusca         = "";
     aBase          = "";
     aBaseBas       = "";
     aBaseBasico    = "";
     aBaseApli      = "";
     aTab           = "";
     aTAB           = "";
     aTexto         = "";
     aTexto1        = "";
     aReturnDos     = "";
     aComandoDOS    = "";
     aPathSh        = "";
     aFicBat        = "";
     aFicLanzaBat   = "";
     aTitulo        = "";
     aDBass         = "";
     aShell         = "";
     aDirBase       = "";
     aLong          = "";
     aAplicacion    = "";
     aAlfa1         = "";
     aAlfa2         = "";
     aAlfa3         = "";
     aNumEmpre      = "";
     aAbre          = "";
     aMin           = "";
     aHora          = "";
     aDia_mes       = "";
     aMes           = "";
     aDia_Sem       = "";
     aComando       = "";
     aLinea         = "";
     aLista         = "";
     aCR            = "";
     aLF            = "";
     aCadena        = "";

     &eaPrograma    = "";
     &enAprobacion  = 0;
|FIN;

|PROCESO crontcom;
     aMin     = #crontcom#2;    |QBF aMin;
     aHora    = #crontcom#3;    |QBF aHora;
     aDia_mes = #crontcom#4;    |QBF aDia_mes;
     aMes     = #crontcom#5;    |QBF aMes;
     aDia_Sem = #crontcom#6;    |QBF aDia_Sem;
     aComando = #crontcom#7;    |QBF aComando;
     aTitulo  = #crontcom#22;    |QBF aTitulo;

     aAlfa = "#" + aTitulo + &10;
     |XGRABA nCanal, aAlfa;

     |SI #crontcom#8 = "S";
          aAlfa = aMin + " " + aHora + " " + aDia_mes + " " + aMes + " " + aDia_Sem + " " + aComando + &13 + &10;
     |SINO;
          aAlfa = "#" + aMin + " " + aHora + " " + aDia_mes + " " + aMes + " " + aDia_Sem + " " + aComando + &13 + &10;
     |FINSI;
     |XGRABA nCanal, aAlfa;
|FPRC;

|DEFBUCLE crontcom;
     #crontcom#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, crontcom;
|FIN;

|PROCESO GeneraTareasSrv;
     aAbre = aBaseBasico;
     aAbre = aAbre + "bin/tareas.srv";
     |XABRE "WB", aAbre, nCanal;

     aDBass = aBaseBasico;
     aAlfa  = aDBass + "cron";   |MKDIR aAlfa;
     |BUCLE crontcom;
     |XCIERRA nCanal;
|FPRC;

|PROCESO ShellLinux;
     aTitulo = #crontcom#22; |QBF aTitulo;

     aDBass = aBaseBasico;
     aShell = aDBass + "bin/lanza" + nRegis + ".sh";
     |XABRE "WB", aShell, nHandle;
     aAlfa = "#" + aTitulo + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = aDBass + "bin/cron" + nRegis  + ".sh &" + &10;
     |XGRABA nHandle, aAlfa;
     |XCIERRA nHandle;
     aAlfa = "chmod 777 " + aShell;
     |SYSTEM aAlfa;

     aShell = aDBass + "bin/cron" + nRegis  + ".sh";
     |XABRE "WB", aShell, nHandle;
     aDirBase = #crontcom#16; |QBF aDirBase;
     aLong    = aDirBase % 0;
     nLong    = aLong;
     aAlfa    = aDirBase;
     nPos     = 100 + nLong - 1;

     aDirBase    = aAlfa % nPos;
     aAplicacion = #crontcom#17; |QBF aAplicacion;
     aTAB        = #crontcom#20; |QBF aTAB;

     aAlfa = "#" + aTitulo + &10;
     |XGRABA nHandle, aAlfa;
     aAlfa2 = &10;
     aAlfa3 = &10;
     |SI #crontcom#25 = "S";
          aAlfa = "echo Iniciando la ejecucion:";

          ||aAlfa2 Resetea los logs
          aAlfa2 = " >" + aDBass + "bin/cron" + nRegis + ".log 2>" + aDBass + "bin/cron" + nRegis + ".err" + &10;

          ||aAlfa3 Anyade info a los logs
          aAlfa3 = " >>" + aDBass + "bin/cron" + nRegis + ".log 2>>" + aDBass + "bin/cron" + nRegis + ".err" + &10;

          aAlfa = aAlfa + aAlfa2;
          |XGRABA nHandle, aAlfa;

          aAlfa = "date";
          aAlfa = aAlfa + aAlfa3;
          |XGRABA nHandle, aAlfa;
     |FINSI;

     aTab   = #crontcom#20;   |QBF aTab;
     aTexto = #crontcom#22;   |QBF aTexto;

     aDirBase = aBaseBas;
     aLong    = aDirBase % 0;
     nLong    = aLong;
     aAlfa    = aDirBase;
     nPos     = 100 + nLong - 1;
     aDirBase = aAlfa % nPos;

     aAlfa = aDBass + "bin/serverds @" + aDirBase + " " + &34 + "/!:" + aAplicacion +"/"+ aTAB;
     aAlfa = aAlfa + &34 + aAlfa3;
     |XGRABA nHandle, aAlfa;

     |SI #crontcom#25 = "S";
          aAlfa = "echo Finalizada la ejecucion:";
          aAlfa = aAlfa + aAlfa3;
          |XGRABA nHandle, aAlfa;

          aAlfa = "date";
          aAlfa = aAlfa + aAlfa3;
          |XGRABA nHandle, aAlfa;
     |FINSI;
     |XCIERRA nHandle;
     aAlfa = "chmod 777 " + aShell;
     |SYSTEM aAlfa;

     aShell = aDBass + "bin/lanza" + nRegis + ".sh";
|FPRC;

|PROCESO Bat;
     aDBass = aBaseApli;

     aShell = aDBass + "bin/cron" + nRegis  + ".bat";
     |XABRE "WB", aShell, nHandle;

     aDirBase    = #crontcom#16; |QBF aDirBase;
     aLong       = aDirBase % 0;
     nLong       = aLong;
     aAlfa       = aDirBase;
     nPos        = 100 + nLong - 1;
     aDirBase    = aAlfa % nPos;
     aAplicacion = #crontcom#17; |QBF aAplicacion;
     aTAB        = #crontcom#20; |QBF aTAB;

     aAlfa = "@echo off" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "echo Iniciando la ejecucion:";

     ||aAlfa2 Resetea los logs
     aAlfa2 = " >" + aDBass + "bin/cron" + nRegis + ".log 2>" + aDBass + "bin/cron" + nRegis + ".err" + &13 + &10;

     ||aAlfa3 Anyade info a los logs
     aAlfa3 = " >>" + aDBass + "bin/cron" + nRegis + ".log 2>>" + aDBass + "bin/cron" + nRegis + ".err" + &13 + &10;

     aAlfa = aAlfa + aAlfa2;
     |XGRABA nHandle, aAlfa;

     aAlfa = "time /T";
     aAlfa = aAlfa + aAlfa3;
     |XGRABA nHandle, aAlfa;

     aAlfa = aDBass + "bin/diagramx.exe /DS:" + &34 + "@" + aDirBase + " $$$batch,batch# //(" + aAplicacion +")"+ aTAB;
     aAlfa = aAlfa + &34 + aAlfa3;
     |XGRABA nHandle, aAlfa;

     aAlfa = "echo Finalizada la ejecucion:";
     aAlfa = aAlfa + aAlfa3;
     |XGRABA nHandle, aAlfa;

     aAlfa = "time /T";
     aAlfa = aAlfa + aAlfa3;
     |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;
|FPRC;

|PROCESO BuscaSecuencial;
     aAlfa = aBase + "dev/usr/ds_sys.psw"
     |LEESECUENCIAL aAlfa, nBufUsr, nEleUsr, 0, 0;
     |PARA nRegis = 0; |SI nRegis < nEleUsr; |HACIENDO nRegis = nRegis + 1;
           |DEL_BUF nBufUsr, nRegis, aAlfa;

           aAlfa1 = aAlfa % 410;
           |QBF aAlfa1;
           |SI aAlfa1 = "batch";
                 nSwEsta = 1;
                 |SAL;
           |FINSI;

           aAlfa1 = aAlfa % 103;
           nNumero = aAlfa1;

           |SI nMayor < nNumero;
               nMayor = nNumero;
           |FINSI;
     |SIGUE;
     |FINDIM nBufUsr;
|FPRC;

|PROCESO MeteBatch;
     aAbre = aBase + "dev/usr/ds_sys.psw"
     |XABRE "A", aAbre, nHandle;

     aAlfa = ("000" + nMayor) % -103;
     aAlfa = aAlfa + "batch     HOHMIYHQIACMCMCMCMCMN";
     |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;
|FPRC;

|PROCESO ControlBatch;
     |DBASS aBase;  |QBF aBase;
     |HAZ BuscaSecuencial;
     |SI nSwEsta = 0;
          nMayor = nMayor + 1;
          |HAZ MeteBatch;
     |FINSI;
|FPRC;

|PROCESO crontcom_tarea;
     |SI #crontcom#23 ! "S";  |ACABA;  |FINSI;

     aTab    = #crontcom#20;  |QBF aTab;
     aTexto  = #crontcom#22;  |QBF aTexto;
     aTexto1 = "Tarea avisos DEH " + aBaseApli;  |QBF aTexto1;

     |SI aTab = "av060z02"; |Y aTexto = aTexto1;
         nSwEstaTarea = 1;
         nClave       = #crontcom#0;
         nLinea       = #crontcom#1;
         |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE crontcom_tarea;
     #crontcom#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, crontcom_tarea;
|FIN;

|PROCESO MiraSiTarea;
     |BUCLE crontcom_tarea;
|FPRC;

|PROCESO DameLineaLibre;
     |PARA nContador = nLinea; |SI nContador [ 999; |HACIENDO nContador = nContador + 1;
          #crontcom#0 = nClave;
          #crontcom#1 = nContador;
          |LEE 000#crontcom.=;
          |SI FSalida ! 0;
               nLinea = nContador;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Tipo12;  |TIPO 12;
     |SI FSalida = 7;  |ACABA;  |FINSI;

     aSistema = "ESDOS";
     aReturn = &13 + &10;     ||DOS.
     |QUE_SISTEMA aSistema;
     |SI aSistema ! "ESDOS";
         aSistema = "ESUNIX";
         aReturn = &10;           ||Unix
     |FINSI;

     nSwCreaTareas  = 0;
     nSwModoUBasico = 0;

     |SI aSistema = "ESUNIX";
          aBusca = "/u/basico/ds.ini";
          |XABRE "E", aBusca, nHandle;
          |SI FSalida ] 0;
               nSwModoUBasico = 1;
          |FINSI;
     |FINSI;

     |SI nSwModoUBasico = 1;
          aAlfa = "/u/basico/agitool/fich/";
          |PATH_DAT #crontcom#aAlfa#;

          aBaseBasico = "/u/basico/";
     |SINO;
         |DBASS aAlfa;
         aAlfa = aAlfa + "agitool/fich/";
         |PATH_DAT #crontcom#aAlfa#;
     |FINSI;

     |ABRET #crontcom;

     nSwEstaTarea = 0;
     |HAZ MiraSiTarea;

     |SI nSwEstaTarea = 0;
          nTab1 = 9;
          aTab = &nTab1;

          |SI nSwModoUBasico = 0;
               |SI aSistema = "ESDOS";
                    |HAZ ControlBatch;
               |FINSI;

               |DBASS aBaseBasico;  |QBF aBaseBasico;
          |FINSI;

          nLinea = 1;
          |HAZ DameLineaLibre;

          nClave = 0;
     |FINSI;

     #crontcom#0 = nClave;
     #crontcom#1 = nLinea;
     |LEE 101#crontcom.=;
     |SI FSalida ! 0;
         |DDEFECTO #crontcom;
         #crontcom#0 = nClave;
         #crontcom#1 = nLinea;
         |GRABA 020#crontcom.b;
     |FINSI;

     aTexto       = "Tarea avisos DEH " + aBaseApli;

     #crontcom#2  = ("00" + #av060z01#1) % -102;
     #crontcom#3  = ("00" + #av060z01#0) % -102;
     #crontcom#4  = "*";
     #crontcom#5  = "*";
     #crontcom#6  = "*";
     #crontcom#8  = "S";
     #crontcom#9  = #crontcom#2;
     #crontcom#10 = #crontcom#3;
     #crontcom#11 = #crontcom#4;
     #crontcom#12 = #crontcom#5;
     #crontcom#13 = #crontcom#6;
     #crontcom#14 = #crontcom#7;
     #crontcom#15 = "S";
     #crontcom#16 = aBaseBasico;
     #crontcom#17 = "integral";
     #crontcom#20 = "av060z02";
     #crontcom#22 = aTexto;
     #crontcom#23 = "S";

     nRegis = #crontcom#1;
     |SI aSistema = "ESDOS";
         |HAZ Bat;
     |SINO;
         |HAZ ShellLinux;
     |FINSI;
     #crontcom#7 = aShell;

     |GRABA 020#crontcom.a
     |LIBERA #crontcom;

     |HAZ GeneraTareasSrv;

     |CIERRAT #crontcom;

     |ABRE #dsam0001;
     |LEE 000#dsam0001.p;
     |SI FSalida ! 0;
         |DDEFECTO #dsam0001;
         |GRABA 020#dsam0001.b;
     |FINSI;

     #dsam0001#14 = (("00" + #av060z01#0) % -102) + ":" + (("00" + #av060z01#1) % -102);
     |GRABA 020#dsam0001.a;
     |LIBERA #dsam0001;

     |CIERRA #dsam0001;
|FPRC;

|PROGRAMA;
     |DBASE aBaseApli;  |QBF aBaseApli;
     |DBASS aBaseBas;   |QBF aBaseBas;

     |ABRE #dsam0001;
     |LEE 000#dsam0001.p;
     |CIERRA #dsam0001;

     |SI #dsam0001#14 = "     ";
         #dsam0001#14 = "00:00";
     |FINSI;

     aAlfa = #dsam0001#14 % 102;  #av060z01#0 = aAlfa;
     aAlfa = #dsam0001#14 % 402;  #av060z01#1 = aAlfa;

     |PINPA #0#av060z01;
     |PINDA #0#av060z01;
     |ENDATOS #1#av060z01;
|FPRO;

|PROCESO Tipo80;  |TIPO 80;
     FSalida = 1050;
|FPRC;
