|FICHEROS;
     nifz0001;

     nifm0001;
     nifm0002;
     dsam0103;

     nifw0001;
     nifw0002;
     nifw0003,MANTE;
|FIN;

|VARIABLES;
     nBtnSal             = -1;
     nBtnMod             = -1;
     nGrid1              = -1;
     nGrid2              = -1;
     nID                 = 0;
     n1Vent              = 0;
     n2Vent              = 0;
     nHandle             = 0;
     nVeces              = 0;
     nOk                 = 0;
     nLong               = 0;
     nCarac              = 0;
     nPos                = 0;
     nFSalida            = 0;
     nRango              = 0;
     nPntW3              = 0;
     nCaracter           = 0;
     nValor              = 0;
     nSwYaUTF            = 0;
     nCmp                = 0;
     nPasada             = 0;
     nNumReg             = 0;
     nTope               = 0;
     nGrab               = 0;
     nFiche              = 0;
     nPos1               = 0;
     nPos2               = 0;
     nCmb                = 0;

     aAlfa               = "";
     aAlfa1              = "";
     aEsc1               = "";
     aEsc2               = "";
     aRetu               = "";
     aTecla              = "";
     aQB                 = "";
     aID                 = "";
     aLong               = "";
     aLee                = "";
     aFicXml             = "";
     aFicRes             = "";
     aFicTmp             = "";
     aAbreXml            = "";
     aHora               = "";
     aAbre               = "";
     aExt                = "";
     aVer1               = "";
     aVer2               = "";
     aOri                = "";
     aDes                = "";
     aLinea              = "";
     aEnlace             = "";
     aCadena             = "";
     aCaracter           = "";
     aNom1               = "";
     aNom2               = "";
     aSel                = "";
     aCar                = "";
     aCar1               = "";
     aCar2               = "";
     aCar3               = "";
     aUltReg             = "";
     aDReg               = "";

  {2}nNivel              = 0;

  {1}aConte              = "";

 {-1}aVent               = "";
     aVent1              = 0;
     aVent2              = 0;
     aVent3              = 0;
     aVent4              = 0;
     aVent5              = "";

     &eaNIF              = "";
     &eaNif              = "";
     &eaAzul             = "";
     &eaVerde            = "";
     &eaRojo             = "";
     &eaRosa             = "";
     &eaMarron           = "";
     &eaUnidadBasico     = "";
     &eaIP               = "";
     &eaPathTmp          = "";
     &eaPathNIF          = "";
     &eaPathPlu          = "";
     &efFechaSys         = @;
     &eaAlfa             = "";
     &eaCadena           = "";
     &eaCadena1          = "";
     &eaCadena2          = "";
     &eaCadena3          = "";

     &enPanta            = -1;
     &eaNomNIF           = "";
     &eaResNIF           = "";
     &eaError            = "";
|FIN;

|PROCESO ConvierteTF8;
     |QBF eaAlfa;

     aCadena = "";
     aLong    = eaAlfa % 0;
     nLong    = aLong;
     |PARA nCmp = 1;  |SI nCmp [ nLong;  |HACIENDO nCmp = nCmp + 1;
          nPos      = (100 * nCmp) + 1;
          aCaracter = eaAlfa % nPos;
          aCar      = aCaracter;
          nCaracter = &aCaracter;

          nValor = &aCar;
          nSwYaUTF = 0;

          |SI aCar = "Ñ"; aCar = &195 + &145; nSwYaUTF = 1; |FINSI; || en algunos defectos la ¥ ya esta cambiada
          |SI aCar = "¥"; aCar = &195 + &145; nSwYaUTF = 1; |FINSI;

          |SI aCar = "ñ"; aCar = &195 + &177; nSwYaUTF = 1; |FINSI;
          |SI aCar = "¤"; aCar = &195 + &177; nSwYaUTF = 1; |FINSI;

          |SI aCar = "á"; aCar = &195 + &161; nSwYaUTF = 1; |FINSI;
          |SI aCar = " "; aCar = &195 + &161; nSwYaUTF = 1; |FINSI;

          |SI aCar = "é"; aCar = &195 + &169; nSwYaUTF = 1; |FINSI;
          |SI aCar = "‚"; aCar = &195 + &169; nSwYaUTF = 1; |FINSI;

          |SI aCar = "í"; aCar = &195 + &173; nSwYaUTF = 1; |FINSI;
          |SI aCar = "¡"; aCar = &195 + &173; nSwYaUTF = 1; |FINSI;

          |SI aCar = "ó"; aCar = &195 + &179; nSwYaUTF = 1; |FINSI;
          |SI aCar = "¢"; aCar = &195 + &179; nSwYaUTF = 1; |FINSI;

          |SI aCar = "ú"; aCar = &195 + &186; nSwYaUTF = 1; |FINSI;
          |SI aCar = "£"; aCar = &195 + &186; nSwYaUTF = 1; |FINSI;

          |SI aCar = "º"; aCar = &194 + &186; nSwYaUTF = 1; |FINSI;
          |SI aCar = "§"; aCar = &194 + &186; nSwYaUTF = 1; |FINSI;

          |SI aCar = "ª"; aCar = &194 + &170; nSwYaUTF = 1; |FINSI;
          |SI aCar = "¦"; aCar = &194 + &170; nSwYaUTF = 1; |FINSI;

          |SI aCar = "°"; aCar = &226 + &130 + &172; nSwYaUTF = 1; |FINSI;  ||Euro

          |SI nValor > 127; |Y nSwYaUTF = 0;
               |SI nValor = "135"; aCar = &195 + &167; nSwYaUTF = 1; |FINSI;    || c cedilla
               |SI nValor = "128"; aCar = &195 + &135; nSwYaUTF = 1; |FINSI;    || C cedilla

               |SI nValor = "133"; aCar = &195 + &160; nSwYaUTF = 1; |FINSI;    || a acento cerrado
               |SI nValor = "138"; aCar = &195 + &168; nSwYaUTF = 1; |FINSI;    || e acento cerrado
               |SI nValor = "141"; aCar = &195 + &172; nSwYaUTF = 1; |FINSI;    || i acento cerrado
               |SI nValor = "149"; aCar = &195 + &178; nSwYaUTF = 1; |FINSI;    || o acento cerrado
               |SI nValor = "151"; aCar = &195 + &185; nSwYaUTF = 1; |FINSI;    || u acento cerrado

               |SI nValor = "129"; aCar = &195 + &175; nSwYaUTF = 1; |FINSI;    || i con dieresis
               |SI nValor = "139"; aCar = &195 + &188; nSwYaUTF = 1; |FINSI;    || u con dieresis

               |SI nValor = "207"; aCar = &195 + &143; nSwYaUTF = 1; |FINSI;    || I con dieresis
               |SI nValor = "154"; aCar = &195 + &156; nSwYaUTF = 1; |FINSI;    || U con dieresis

               |SI nValor = "165"; aCar = &195 + &145; nSwYaUTF = 1; |FINSI;    || ENYE

               |SI nValor = "160"; aCar = &195 + &161; nSwYaUTF = 1; |FINSI;    || a acento
               |SI nValor = "130"; aCar = &195 + &169; nSwYaUTF = 1; |FINSI;    || e acento
          |FINSI;

          |SI nSwYaUTF = 1;
               aCaracter = aCar;
          |SINO;
              |SI aCaracter = "&";
                  aCaracter = "&amp;";
              |SINO;
                   |SI nCaracter = 192;  aCaracter = "A";  |FINSI;
                   |SI nCaracter = 193;  aCaracter = "A";  |FINSI;
                   |SI nCaracter = 142;  aCaracter = "A";  |FINSI;
                   |SI nCaracter = 200;  aCaracter = "E";  |FINSI;
                   |SI nCaracter = 201;  aCaracter = "E";  |FINSI;
                   |SI nCaracter = 195;  aCaracter = "O";  |FINSI;
                   |SI nCaracter = 210;  aCaracter = "O";  |FINSI;
                   |SI nCaracter = 211;  aCaracter = "O";  |FINSI;
                   |SI nCaracter = 204;  aCaracter = "I";  |FINSI;
                   |SI nCaracter = 205;  aCaracter = "I";  |FINSI;
                   |SI nCaracter = 207;  aCaracter = "I";  |FINSI;
                   |SI nCaracter = 153;  aCaracter = "O";  |FINSI;
                   |SI nCaracter = 217;  aCaracter = "U";  |FINSI;
                   |SI nCaracter = 218;  aCaracter = "U";  |FINSI;
                   |SI nCaracter = 154;  aCaracter = "U";  |FINSI;

                   |SI nCaracter = 160;  aCaracter = "a";  |FINSI;
                   |SI nCaracter = 130;  aCaracter = "e";  |FINSI;
                   |SI nCaracter = 161;  aCaracter = "i";  |FINSI;
                   |SI nCaracter = 162;  aCaracter = "o";  |FINSI;
                   |SI nCaracter = 163;  aCaracter = "u";  |FINSI;

                   |SI nCaracter = 133;  aCaracter = "a";  |FINSI;
                   |SI nCaracter = 138;  aCaracter = "e";  |FINSI;
                   |SI nCaracter = 141;  aCaracter = "i";  |FINSI;
                   |SI nCaracter = 149;  aCaracter = "o";  |FINSI;
                   |SI nCaracter = 151;  aCaracter = "u";  |FINSI;
                   |SI nCaracter = 132;  aCaracter = "a";  |FINSI;
                   |SI nCaracter = 137;  aCaracter = "e";  |FINSI;
                   |SI nCaracter = 139;  aCaracter = "i";  |FINSI;
                   |SI nCaracter = 148;  aCaracter = "o";  |FINSI;
                   |SI nCaracter = 129;  aCaracter = "u";  |FINSI;

                   |SI nCaracter = 164;  aCaracter = "n";  |FINSI;
                   |SI nCaracter = 165;  aCaracter = "N";  |FINSI;
                   |SI nCaracter = 135;  aCaracter = "c";  |FINSI;
                   |SI nCaracter = 128;  aCaracter = "C";  |FINSI;
                   |SI nCaracter = 166;  aCaracter = "a";  |FINSI;
                   |SI nCaracter = 167;  aCaracter = "o";  |FINSI;

                   |SI nCaracter < 32;   aCaracter = "";   |FINSI;   ||Caracteres Control
                   |SI nCaracter = 131;  aCaracter = "a";  |FINSI;   ||a con acento circunflejo
                   |SI nCaracter = 134;  aCaracter = "a";  |FINSI;   ||a con anillo
                   |SI nCaracter = 136;  aCaracter = "e";  |FINSI;   ||e con acento circunflejo
                   |SI nCaracter = 140;  aCaracter = "i";  |FINSI;   ||i con acento circunflejo
                   |SI nCaracter = 143;  aCaracter = "A";  |FINSI;   ||A con anillo
                   |SI nCaracter = 144;  aCaracter = "E";  |FINSI;   ||E con acento agudo
                   |SI nCaracter = 145;  aCaracter = " ";  |FINSI;   ||diptongo ae
                   |SI nCaracter = 146;  aCaracter = " ";  |FINSI;   ||diptongo AE
                   |SI nCaracter = 147;  aCaracter = "o";  |FINSI;   ||o con acento circunflejo
                   |SI nCaracter = 150;  aCaracter = "u";  |FINSI;   ||u con acento circunflejo
                   |SI nCaracter = 152;  aCaracter = "y";  |FINSI;   ||y con dieresis
                   |SI nCaracter = 155;  aCaracter = "o";  |FINSI;   ||o con barra inclinada
                   |SI nCaracter = 156;  aCaracter = " ";  |FINSI;   ||Libra esterlina
                   |SI nCaracter = 157;  aCaracter = "O";  |FINSI;   ||O con barra inclinada
                   |SI nCaracter = 169;  aCaracter = " ";  |FINSI;   ||Signo Registrado
                   |SI nCaracter = 170;  aCaracter = " ";  |FINSI;   ||Signo Negacion
                   |SI nCaracter = 171;  aCaracter = " ";  |FINSI;   ||1/2
                   |SI nCaracter = 172;  aCaracter = " ";  |FINSI;   ||1/4
                   |SI nCaracter = 181;  aCaracter = "A";  |FINSI;   ||A con acento agudo
                   |SI nCaracter = 182;  aCaracter = "A";  |FINSI;   ||A con acento circunflejo
                   |SI nCaracter = 183;  aCaracter = "A";  |FINSI;   ||A con acento grave
                   |SI nCaracter = 184;  aCaracter = "c";  |FINSI;   ||Signo Copyright
                   |SI nCaracter = 198;  aCaracter = "a";  |FINSI;   ||a con tilde
                   |SI nCaracter = 199;  aCaracter = "A";  |FINSI;   ||A con tilde
                   ||SI nCaracter = 210;  aCaracter = "E";  |FINSI;   ||E con acento circunflejo
                   ||SI nCaracter = 211;  aCaracter = "E";  |FINSI;   ||E con dieresis
                   |SI nCaracter = 212;  aCaracter = "E";  |FINSI;   ||E con acento grave
                   |SI nCaracter = 213;  aCaracter = "i";  |FINSI;   ||i sin punto
                   |SI nCaracter = 214;  aCaracter = "I";  |FINSI;   ||I acento agudo
                   |SI nCaracter = 215;  aCaracter = "I";  |FINSI;   ||I acento circunflejo
                   |SI nCaracter = 216;  aCaracter = "I";  |FINSI;   ||I con dieresis
                   |SI nCaracter = 222;  aCaracter = "I";  |FINSI;   ||I con acento grave
                   |SI nCaracter = 224;  aCaracter = "O";  |FINSI;   ||O con acento agudo
                   |SI nCaracter = 226;  aCaracter = "O";  |FINSI;   ||O con acento circunflejo
                   |SI nCaracter = 227;  aCaracter = "O";  |FINSI;   ||O con acento grave
                   |SI nCaracter = 228;  aCaracter = "o";  |FINSI;   ||o con tilde
                   |SI nCaracter = 229;  aCaracter = "O";  |FINSI;   ||O con tilde
                   |SI nCaracter = 233;  aCaracter = "U";  |FINSI;   ||U acento agudo
                   |SI nCaracter = 234;  aCaracter = "U";  |FINSI;   ||U acento circunflejo
                   |SI nCaracter = 235;  aCaracter = "U";  |FINSI;   ||U acento grave
                   |SI nCaracter = 236;  aCaracter = "y";  |FINSI;   ||y acento agudo
                   |SI nCaracter = 237;  aCaracter = "Y";  |FINSI;   ||Y acento agudo
              |FINSI;
          |FINSI;

           aCadena = aCadena + aCaracter;
     |SIGUE;
     eaAlfa = aCadena;
|FPRC;

|PROCESO ConvierteDeTF8;
     |QBF eaAlfa;



     aCadena = "";
     aLong    = eaAlfa % 0;
     nLong    = aLong;
     |PARA nCmp = 1;  |SI nCmp [ nLong;  |HACIENDO nCmp = nCmp + 1;
          nPos      = (100 * nCmp) + 1;
          aCaracter = eaAlfa % nPos;
          aCar      = aCaracter;
          nCaracter = &aCaracter;
          nSwYaUTF  = 0;

          |SI aCar = "Ñ"; aCar = &195 + &145; nSwYaUTF = 1; |FINSI; || en algunos defectos la ¥ ya esta cambiada
          |SI aCar = "¥"; aCar = &195 + &145; nSwYaUTF = 1; |FINSI;

          |SI aCar = "ñ"; aCar = &195 + &177; nSwYaUTF = 1; |FINSI;
          |SI aCar = "¤"; aCar = &195 + &177; nSwYaUTF = 1; |FINSI;

          |SI aCar = "á"; aCar = &195 + &161; nSwYaUTF = 1; |FINSI;
          |SI aCar = " "; aCar = &195 + &161; nSwYaUTF = 1; |FINSI;

          |SI aCar = "é"; aCar = &195 + &169; nSwYaUTF = 1; |FINSI;
          |SI aCar = "‚"; aCar = &195 + &169; nSwYaUTF = 1; |FINSI;

          |SI aCar = "í"; aCar = &195 + &173; nSwYaUTF = 1; |FINSI;
          |SI aCar = "¡"; aCar = &195 + &173; nSwYaUTF = 1; |FINSI;

          |SI aCar = "ó"; aCar = &195 + &179; nSwYaUTF = 1; |FINSI;
          |SI aCar = "¢"; aCar = &195 + &179; nSwYaUTF = 1; |FINSI;

          |SI aCar = "ú"; aCar = &195 + &186; nSwYaUTF = 1; |FINSI;
          |SI aCar = "£"; aCar = &195 + &186; nSwYaUTF = 1; |FINSI;

          |SI aCar = "º"; aCar = &194 + &186; nSwYaUTF = 1; |FINSI;
          |SI aCar = "§"; aCar = &194 + &186; nSwYaUTF = 1; |FINSI;

          |SI aCar = "ª"; aCar = &194 + &170; nSwYaUTF = 1; |FINSI;
          |SI aCar = "¦"; aCar = &194 + &170; nSwYaUTF = 1; |FINSI;

          |SI aCar = "°"; aCar = &226 + &130 + &172; nSwYaUTF = 1; |FINSI;  ||Euro

          |SI nValor > 127; |Y nSwYaUTF = 0;
               |SI nValor = "135"; aCar = &195 + &167; nSwYaUTF = 1; |FINSI;    || c cedilla
               |SI nValor = "128"; aCar = &195 + &135; nSwYaUTF = 1; |FINSI;    || C cedilla

               |SI nValor = "133"; aCar = &195 + &160; nSwYaUTF = 1; |FINSI;    || a acento cerrado
               |SI nValor = "138"; aCar = &195 + &168; nSwYaUTF = 1; |FINSI;    || e acento cerrado
               |SI nValor = "141"; aCar = &195 + &172; nSwYaUTF = 1; |FINSI;    || i acento cerrado
               |SI nValor = "149"; aCar = &195 + &178; nSwYaUTF = 1; |FINSI;    || o acento cerrado
               |SI nValor = "151"; aCar = &195 + &185; nSwYaUTF = 1; |FINSI;    || u acento cerrado

               |SI nValor = "129"; aCar = &195 + &175; nSwYaUTF = 1; |FINSI;    || i con dieresis
               |SI nValor = "139"; aCar = &195 + &188; nSwYaUTF = 1; |FINSI;    || u con dieresis

               |SI nValor = "207"; aCar = &195 + &143; nSwYaUTF = 1; |FINSI;    || I con dieresis
               |SI nValor = "154"; aCar = &195 + &156; nSwYaUTF = 1; |FINSI;    || U con dieresis

               |SI nValor = "165"; aCar = &195 + &145; nSwYaUTF = 1; |FINSI;    || ENYE

               |SI nValor = "160"; aCar = &195 + &161; nSwYaUTF = 1; |FINSI;    || a acento
               |SI nValor = "130"; aCar = &195 + &169; nSwYaUTF = 1; |FINSI;    || e acento
          |FINSI;

          |SI nSwYaUTF = 1;
               aCaracter = aCar;
          |SINO;
              |SI aCaracter = "&";
                  aCaracter = "&amp;";
              |SINO;
                   |SI nCaracter = 192;  aCaracter = "A";  |FINSI;
                   |SI nCaracter = 193;  aCaracter = "A";  |FINSI;
                   |SI nCaracter = 142;  aCaracter = "A";  |FINSI;
                   |SI nCaracter = 200;  aCaracter = "E";  |FINSI;
                   |SI nCaracter = 201;  aCaracter = "E";  |FINSI;
                   |SI nCaracter = 195;  aCaracter = "O";  |FINSI;
                   |SI nCaracter = 210;  aCaracter = "O";  |FINSI;
                   |SI nCaracter = 211;  aCaracter = "O";  |FINSI;
                   |SI nCaracter = 204;  aCaracter = "I";  |FINSI;
                   |SI nCaracter = 205;  aCaracter = "I";  |FINSI;
                   |SI nCaracter = 207;  aCaracter = "I";  |FINSI;
                   |SI nCaracter = 153;  aCaracter = "O";  |FINSI;
                   |SI nCaracter = 217;  aCaracter = "U";  |FINSI;
                   |SI nCaracter = 218;  aCaracter = "U";  |FINSI;
                   |SI nCaracter = 154;  aCaracter = "U";  |FINSI;

                   |SI nCaracter = 160;  aCaracter = "a";  |FINSI;
                   |SI nCaracter = 130;  aCaracter = "e";  |FINSI;
                   |SI nCaracter = 161;  aCaracter = "i";  |FINSI;
                   |SI nCaracter = 162;  aCaracter = "o";  |FINSI;
                   |SI nCaracter = 163;  aCaracter = "u";  |FINSI;

                   |SI nCaracter = 133;  aCaracter = "a";  |FINSI;
                   |SI nCaracter = 138;  aCaracter = "e";  |FINSI;
                   |SI nCaracter = 141;  aCaracter = "i";  |FINSI;
                   |SI nCaracter = 149;  aCaracter = "o";  |FINSI;
                   |SI nCaracter = 151;  aCaracter = "u";  |FINSI;
                   |SI nCaracter = 132;  aCaracter = "a";  |FINSI;
                   |SI nCaracter = 137;  aCaracter = "e";  |FINSI;
                   |SI nCaracter = 139;  aCaracter = "i";  |FINSI;
                   |SI nCaracter = 148;  aCaracter = "o";  |FINSI;
                   |SI nCaracter = 129;  aCaracter = "u";  |FINSI;

                   |SI nCaracter = 164;  aCaracter = "n";  |FINSI;
                   |SI nCaracter = 165;  aCaracter = "N";  |FINSI;
                   |SI nCaracter = 135;  aCaracter = "c";  |FINSI;
                   |SI nCaracter = 128;  aCaracter = "C";  |FINSI;
                   |SI nCaracter = 166;  aCaracter = "a";  |FINSI;
                   |SI nCaracter = 167;  aCaracter = "o";  |FINSI;

                   |SI nCaracter < 32;   aCaracter = "";   |FINSI;   ||Caracteres Control
                   |SI nCaracter = 131;  aCaracter = "a";  |FINSI;   ||a con acento circunflejo
                   |SI nCaracter = 134;  aCaracter = "a";  |FINSI;   ||a con anillo
                   |SI nCaracter = 136;  aCaracter = "e";  |FINSI;   ||e con acento circunflejo
                   |SI nCaracter = 140;  aCaracter = "i";  |FINSI;   ||i con acento circunflejo
                   |SI nCaracter = 143;  aCaracter = "A";  |FINSI;   ||A con anillo
                   |SI nCaracter = 144;  aCaracter = "E";  |FINSI;   ||E con acento agudo
                   |SI nCaracter = 145;  aCaracter = " ";  |FINSI;   ||diptongo ae
                   |SI nCaracter = 146;  aCaracter = " ";  |FINSI;   ||diptongo AE
                   |SI nCaracter = 147;  aCaracter = "o";  |FINSI;   ||o con acento circunflejo
                   |SI nCaracter = 150;  aCaracter = "u";  |FINSI;   ||u con acento circunflejo
                   |SI nCaracter = 152;  aCaracter = "y";  |FINSI;   ||y con dieresis
                   |SI nCaracter = 155;  aCaracter = "o";  |FINSI;   ||o con barra inclinada
                   |SI nCaracter = 156;  aCaracter = " ";  |FINSI;   ||Libra esterlina
                   |SI nCaracter = 157;  aCaracter = "O";  |FINSI;   ||O con barra inclinada
                   |SI nCaracter = 169;  aCaracter = " ";  |FINSI;   ||Signo Registrado
                   |SI nCaracter = 170;  aCaracter = " ";  |FINSI;   ||Signo Negacion
                   |SI nCaracter = 171;  aCaracter = " ";  |FINSI;   ||1/2
                   |SI nCaracter = 172;  aCaracter = " ";  |FINSI;   ||1/4
                   |SI nCaracter = 181;  aCaracter = "A";  |FINSI;   ||A con acento agudo
                   |SI nCaracter = 182;  aCaracter = "A";  |FINSI;   ||A con acento circunflejo
                   |SI nCaracter = 183;  aCaracter = "A";  |FINSI;   ||A con acento grave
                   |SI nCaracter = 184;  aCaracter = "c";  |FINSI;   ||Signo Copyright
                   |SI nCaracter = 198;  aCaracter = "a";  |FINSI;   ||a con tilde
                   |SI nCaracter = 199;  aCaracter = "A";  |FINSI;   ||A con tilde
                   ||SI nCaracter = 210;  aCaracter = "E";  |FINSI;   ||E con acento circunflejo
                   ||SI nCaracter = 211;  aCaracter = "E";  |FINSI;   ||E con dieresis
                   |SI nCaracter = 212;  aCaracter = "E";  |FINSI;   ||E con acento grave
                   |SI nCaracter = 213;  aCaracter = "i";  |FINSI;   ||i sin punto
                   |SI nCaracter = 214;  aCaracter = "I";  |FINSI;   ||I acento agudo
                   |SI nCaracter = 215;  aCaracter = "I";  |FINSI;   ||I acento circunflejo
                   |SI nCaracter = 216;  aCaracter = "I";  |FINSI;   ||I con dieresis
                   |SI nCaracter = 222;  aCaracter = "I";  |FINSI;   ||I con acento grave
                   |SI nCaracter = 224;  aCaracter = "O";  |FINSI;   ||O con acento agudo
                   |SI nCaracter = 226;  aCaracter = "O";  |FINSI;   ||O con acento circunflejo
                   |SI nCaracter = 227;  aCaracter = "O";  |FINSI;   ||O con acento grave
                   |SI nCaracter = 228;  aCaracter = "o";  |FINSI;   ||o con tilde
                   |SI nCaracter = 229;  aCaracter = "O";  |FINSI;   ||O con tilde
                   |SI nCaracter = 233;  aCaracter = "U";  |FINSI;   ||U acento agudo
                   |SI nCaracter = 234;  aCaracter = "U";  |FINSI;   ||U acento circunflejo
                   |SI nCaracter = 235;  aCaracter = "U";  |FINSI;   ||U acento grave
                   |SI nCaracter = 236;  aCaracter = "y";  |FINSI;   ||y acento agudo
                   |SI nCaracter = 237;  aCaracter = "Y";  |FINSI;   ||Y acento agudo
              |FINSI;
          |FINSI;

           aCadena = aCadena + aCaracter;
     |SIGUE;
     eaAlfa = aCadena;
|FPRC;

|PROCESO nifw0002Act;
     #dsam0103#0 = #nifw0002#0;
     |LEE 101#dsam0103.=;
     |SI FSalida = 0;
         aAlfa = #nifw0002#7;  |QBF aAlfa;
         |SI aAlfa ! "";
             #dsam0103#1 = #nifw0002#7;
         |SINO;
             #dsam0103#1 = #nifw0002#8;
         |FINSI;

         |GRABA 020#dsam0103.a;
         |LIBERA #dsam0103;

         eaNif = #dsam0103#0;
         |SUB_EJECUTA "dsaz0012;SINPANTALLA";
     |FINSI;

     #nifm0001#0 = #nifw0002#0;
     |LEE 101#nifm0001.=;
     |SI FSalida = 0;
         aAlfa = #nifw0002#7;  |QBF aAlfa;
         |SI aAlfa ! "";
             #nifm0001#1 = #nifw0002#7;
         |SINO;
             #nifm0001#1 = #nifw0002#8;
         |FINSI;

         #nifm0001#3 = "IDENTIFICADO";

         |GRABA 020#nifm0001.a;
         |LIBERA #nifm0001;

         #nifm0002#0 = #nifm0001#0;
         #nifm0002#1 = #nifm0001#4;
         #nifm0002#2 = #nifm0001#5;
         |LEE 101#nifm0002.=;
         |SI FSalida = 0;
             #nifm0002#3 = #nifm0001#1;
             #nifm0002#5 = "IDENTIFICADO";

             |GRABA 020#nifm0002.a;
             |LIBERA #nifm0002;
         |FINSI;
     |FINSI;

     |PULSATECLA;
|FPRC;

|DEFBUCLE nifw0002Act;
     #nifw0002#2;
     ;
     "S", "";
     "S", "zzzzzzzzz";
     ;
     NULL, nifw0002Act;
|FIN;

|PROCESO Actualizar;
     |CONFI "0000NEst  seguro que quiere actualizar los registros seleccionados";
     |SI FSalida ! 0;
         |FOCOTECLADO nGrid1;
         |ACABA;
     |FINSI;

     |VENTANA 0501, 0540, -1, 16, "Actualizando";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |BUCLE nifw0002Act;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;

     |PTEC 806;
|FPRC;

|PROCESO QuitaBtnSalir;
     nBtnSal   = 0;
     InNivel   = nNivel1<-;
     nNivel1   = 0;
     |ESPECIFICA "IDBOTONTECLA", nNivel;

     nBtnSal = nNivel2;
     |ESTADO_CONTROL nBtnSal, "HIDE";
|FPRC;

|PROCESO PonBtnSalir;
     |ESTADO_CONTROL nBtnSal, "SHOW";
|FPRC;

|PROCESO AbreVtn1;
     |VENTANA 0501, 0540, -1, 16, "Realizando el env¡o";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;
|FPRC;

|PROCESO CierraVtn1;
     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;
|FPRC;

|PROCESO EvntW2;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#nifw0002.=;

         |ESTADO_CONTROL nBtnMod, "ENABLE";

         |SI #nifw0002#9 = "N";
             |ESTADO_CONTROL nBtnMod, "DISABLE";
         |FINSI;

         aAlfa = #nifw0002#8;  |QBF aAlfa;
         |SI aAlfa ! "";
             |ESTADO_CONTROL nBtnMod, "DISABLE";
         |FINSI;

         |DDEFECTO #nifw0003;
         #nifw0003#0 = #nifw0002#0;
         #nifw0003#1 = #nifw0002#1;
         #nifw0003#2 = #nifw0002#2;
         #nifw0003#3 = #nifw0002#3;
         #nifw0003#4 = #nifw0002#4;
         #nifw0003#5 = #nifw0002#5;
         #nifw0003#6 = #nifw0002#6;
         #nifw0003#7 = #nifw0002#7;
         #nifw0003#8 = #nifw0002#8;

         |PINTA #nifw0003#1;
         |PINTA #nifw0003#2;
         |PINTA #nifw0003#3;
         |PINTA #nifw0003#4;
         |PINTA #nifw0003#5;
         |PINTA #nifw0003#6;
         |PINTA #nifw0003#7;
         |PINTA #nifw0003#8;
     |FINSI;

     |SI FSalida = 4;
         |LEE 101#nifw0002.=;
         |SI FSalida = 0;
             |SI #nifw0002#9 = "N";
                 |MENAV "0000Registro no seleccionable";
                 |LIBERA #nifw0002;
                 |ACABA;
             |FINSI;

             |SI #nifw0002#10 = "N";
                 aSel = "S"
             |SINO;
                 aSel = "N"
             |FINSI;

             |HAZ nifw0002;

             |REFRESCACONTROL nGrid1;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO nifw0002;
     |SI #nifw0002#9 = "N";
         |ACABA;
     |FINSI;

     #nifw0002#10 = aSel;
     #nifw0002#11 = eaMarron;
     |SI #nifw0002#10 = "N";
         #nifw0002#11 = "";

         |SI #nifw0002#9 = "S";
             #nifw0002#11 = eaAzul;
         |FINSI;
     |FINSI;

     |GRABA 020#nifw0002.a;
     |LIBERA #nifw0002;
|FPRC;

|DEFBUCLE nifw0002;
     #nifw0002#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, nifw0002;
|FIN;

|PROCESO SelTodos;
     aSel = "S";
     |BUCLE nifw0002;

     |REFRESCACONTROL nGrid1;
|FPRC;

|PROCESO DeselTodos;
     aSel = "N";
     |BUCLE nifw0002;

     |REFRESCACONTROL nGrid1;
|FPRC;

|PROCESO T12Fw3;  |TIPO 12;
     |SI FSalida = 7;  |ACABA;  |FINSI;

     |SI FSalida ! 1;
         |POSICIONATE #nifw0003#4;
         |ERROR;
         |ACABA;
     |FINSI;

     eaCadena1 = #nifw0003#4;  |QBF eaCadena1;
     eaCadena2 = #nifw0003#5;  |QBF eaCadena2;
     eaCadena3 = #nifw0003#6;  |QBF eaCadena3;

     #nifw0003#7 = eaCadena1 + " " + eaCadena2 + ", " + eaCadena3;
     |PINTA #nifw0003#7;

     |LEE 101#nifw0002.=;
     |SI FSalida = 0;
         #nifw0002#4  = #nifw0003#4;
         #nifw0002#5  = #nifw0003#5;
         #nifw0002#6  = #nifw0003#6;
         #nifw0002#7  = #nifw0003#7;
         #nifw0002#10 = "S";
         #nifw0002#11 = eaMarron;

         |GRABA 020#nifw0002.a;
         |LIBERA #nifw0002;

         |REFRESCACONTROL nGrid1;
     |FINSI;
|FPRC;

|PROCESO Modificar;
     |HAZ QuitaBtnSalir;
     |ESTADO_CONTROL nBtnMod, "DISABLE";

     |ENDATOS #2#nifw0003;

     |ESTADO_CONTROL nBtnMod, "ENABLE";
     |HAZ PonBtnSalir;
|FPRC;

|PROCESO Envio;
     |HAZ AbreVtn1;

     #nifz0001#0 = #nifw0002#0;
     #nifz0001#1 = #nifw0002#1;
     |HAZ nifz0001;

     |HAZ CierraVtn1;

     |REFRESCACONTROL nGrid1;
|FPRC;

|PROCESO Colores;
     |VENTANA 0502, 1370, -1, 17, "Ayuda colores GRID";
     n2Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |CONTROL_SIMPLE 0, "LABEL,{{16}}Negro - Registros sin seleccionar", 0602, 0668, NULL;
     |CONTROL_SIMPLE 0, "LABEL,{{16}}Azul   - Registros para revisar y seleccionar", 0702, 0768, NULL;
     |CONTROL_SIMPLE 0, "LABEL,{{16}}Marr¢n - Registros seleccionados para actualizar", 0802, 0868, NULL;
     |CONTROL_SIMPLE 0, "LABEL,{{16}}Verde - Registros identificados no requieren actualizaci¢n", 0902, 0968, NULL;
     |CONTROL_SIMPLE 0, "LABEL,{{16}}Rojo   - Registros incorrectos se deben arreglar o borrar en el fichero de NIFS", 1002, 1068, NULL;

     |PAUSA;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n2Vent;
|FPRC;

|PROCESO Resultados;
     |VENTANA 0501, 3599, -1, 16, "Consulta y Correcciones de NIFS/CIFS";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |PINPA #0#nifw0003;  nPntW3 = FSalida;

     aAlfa =  "LABEL,{{16}}Doble click en el registro para ";
     aAlfa = aAlfa + "Seleccionar o Deseleccionar ";
     aAlfa = aAlfa + "registros azules";
     |CONTROL_SIMPLE nPntW3, aAlfa, 0502, 0565, NULL;

     |CONTROL_SIMPLE nPntW3, "BOTON,{{206}}Todos", 0590, 0598, SelTodos;
     |CONTROL_SIMPLE nPntW3, "BOTON,{{207}}Todos", 0580, 0588, DeselTodos;
     |CONTROL_SIMPLE nPntW3, "BOTON,{{197}}Colores", 0568, 0578, Colores;

     |CONTROL_SIMPLE nPntW3, "BOTON,{{197}}Modificar", 2188, 2198, Modificar;
     nBtnMod = FSalida;

     |CONTROL_SIMPLE nPntW3, "BOTON,{{197}}Reenvio", 2176, 2186, Envio;

     |CONTROL_SIMPLE 0, "BOTON,{{197}}Actualizar seleccionados", 3502, 3525, Actualizar;

     nRango   = 2 + 4 + 8 + 16 + 32 + 128;
     |LINEAL_SIMPLE #1#nifw0002, nRango, 0602, 2098, NULL, NULL, EvntW2;
     nGrid1 = FSalida;

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
          FSalida = "::{{001}}Salir," + nGrid1;
          |LEETECLA aTecla;
          |SI aTecla = aEsc1; |SAL;  |FINSI;
          |SI aTecla = aEsc2; |SAL;  |FINSI;
          |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;

     |HAZ CierraVtn1;
|FPRC;

|PROCESO Ds_SII;
     aVer1   = "";
     aVer2   = "";
     aConte  = eaPathPlu + "ds_sii.exe";
     |ESPECIFICA "MD5", aConte;
     aVer1 = FSalida;

     aConte  = eaPathNIF + "ds_sii.exe";
     |ESPECIFICA "REMOTOMD5", aConte;
     aVer2 = FSalida;

     |SI aVer1 ! aVer2;
         aOri = eaPathPlu + "ds_sii.exe";
         aDes = eaPathNIF + "ds_sii.exe";

         |SI eaIP = "";
             |COPIA_FICHERO aOri, aDes;
         |SINO;
             |ENVIA_FICHERO aOri, aDes;
         |FINSI;

         aAlfa = eaPathNIF + "ds_sii.exe";
         |XABRE "EC", aAlfa, 0;
         |SI FSalida < 0;
             |MENAV "0000No encuentro el programa que comunica con AEAT, por favor consulte con su administrador informatico.";

             |ACABA;
         |FINSI;
     |FINSI;

     nOk = 1;
|FPRC;

|PROCESO PonCaracter;
     aCadena = "";
     aLong   = aAlfa % 0;
     nLong   = aLong;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos       = (nCarac * 100) + 1;
           aCaracter  = aAlfa % nPos;
           aCar       = aCar1;
           |SI aCaracter = aCar;
               aCaracter = "";
           |FINSI;

           aCar       = aCar2;
           |SI aCaracter = aCar;
               aCaracter = aCar3;
           |FINSI;

           aCadena = aCadena + aCaracter;
     |SIGUE;

     aAlfa = aCadena;
|FPRC;

|PROCESO QuitaAmpersan;
     aAlfa  = FSalida;
     aAlfa1 = aAlfa - "05";
     nPos1  = aAlfa1;
     nPos2  = nPos1 + 5;
     nPos1  = 100 + nPos1;
     nPos2  = (100 * nPos2) + 99;

     aAlfa  = (eaNomNIF % nPos1) + (eaNomNIF % nPos2);
|FPRC;

|PROCESO CambiaCaracteres;
     nCmb  = 0;
     aCar  = &195 + &145;    || ¥
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &195;
         aCar2 = &145;
         aCar3 = "¥";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &195 + &177;    || ¥
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &195;
         aCar2 = &177;
         aCar3 = "¥";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &195 + &161;    ||  
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &195;
         aCar2 = &161;
         aCar3 = "A";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &195 + &169;    || ‚
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &195;
         aCar2 = &169;
         aCar3 = "E";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &195 + &173;    || ¡
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &195;
         aCar2 = &173;
         aCar3 = "I";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &195 + &179;    || ¢
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &195;
         aCar2 = &179;
         aCar3 = "O";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &195 + &186;    || £
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &195;
         aCar2 = &186;
         aCar3 = "U";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &194 + &186;    || §
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &194;
         aCar2 = &186;
         aCar3 = "§";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &194 + &170;    || ¦
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &194;
         aCar2 = &170;
         aCar3 = "¦";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &195 + &147;    || O
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &195;
         aCar2 = &147;
         aCar3 = "O";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &195 + &135;    || C trencada
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &195;
         aCar2 = &135;
         aCar3 = "C";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &194 + &180;
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &194;
         aCar2 = &180;
         aCar3 = "'";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &195 + &175;  || I Dieresis
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &195;
         aCar2 = &188;
         aCar3 = "I";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &195 + &188;  || U Dieresis
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &195;
         aCar2 = &188;
         aCar3 = "U";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &195 + &143;  || I Dieresis
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &195;
         aCar2 = &188;
         aCar3 = "I";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = &195 + &156;  || U Dieresis
     aAlfa = aAlfa - aCar;
     |SI FSalida ! 0;
         aCar1 = &195;
         aCar2 = &188;
         aCar3 = "U";
         aAlfa = eaNomNIF;
         |HAZ PonCaracter;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;

     aCar  = "&amp;";
     aAlfa = eaNomNIF - aCar;
     |SI FSalida ! 0;
         aAlfa = eaNomNIF;
         |HAZ QuitaAmpersan;
         eaNomNIF = aAlfa;

         nCmb  = 1;
     |FINSI;
|FPRC;

|PROCESO SacaCadena;
     aAlfa   = aLee;  |QBF aAlfa;
     aCadena = "";
     aLong   = aAlfa % 0;
     nLong   = aLong;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos       = (nCarac * 100) + 1;
           aCaracter  = aAlfa % nPos;
           |SI aCaracter = "<";  |O aCaracter = ">";
               aCadena = "";
           |SINO;
               aCadena = aCadena + aCaracter;
           |FINSI;
     |SIGUE;
|FPRC;

|PROCESO GrabaW2;
     #nifw0002#0 = #nifm0001#0;
     |LEE 101#nifw0002.=;
     |SI FSalida ! 0;
         |DDEFECTO #nifw0002;
         #nifw0002#0 = #nifm0001#0;

         |GRABA 020#nifw0002.b;
     |FINSI;

     #nifw0002#1 = #nifw0001#1;
     #nifw0002#2 = #nifm0001#2;
     #nifw0002#3 = #nifm0001#3;

     aNom1 = #nifw0002#1;
     aNom2 = #nifw0002#2;
     |HAZ Comparalos;

     #nifw0002#9  = "N";
     #nifw0002#11 = eaRojo;

     aAlfa = #nifm0001#3;  |QBF aAlfa;

     |SI aAlfa = "IDENTIFICADO";
         #nifw0002#11 = eaVerde;
     |FINSI;

     |SI aAlfa = "IDENTIFICADO-BAJA";
         #nifw0002#11 = eaVerde;
     |FINSI;

     |SI aAlfa = "NO IDENTIFICADO-SIMILAR";
         #nifw0002#11 = eaAzul;
         #nifw0002#9  = "S";
     |FINSI;

     |SI aNom1 ! aNom2;
         #nifw0002#11 = eaAzul;
         #nifw0002#9  = "S";
     |FINSI;

     |SI aAlfa = "NO IDENTIFICADO";
        #nifw0002#9  = "N";
        #nifw0002#11 = eaRojo;
     |FINSI;

     #nifw0002#4 = "";
     #nifw0002#5 = "";
     #nifw0002#6 = "";
     #nifw0002#7 = "";
     #nifw0002#8 = "";

     |SI #nifw0002#9  = "S";
         aAlfa = #nifw0002#0 % 101;
         nOk   = 0;
         |SI aAlfa ] "0";  |Y aAlfa [ "9";
             nOk = 1;
         |FINSI;

         |SI aAlfa = "X";  nOk = 1;  |FINSI;
         |SI aAlfa = "Y";  nOk = 1;  |FINSI;
         |SI aAlfa = "Z";  nOk = 1;  |FINSI;

         |SI nOk = 1;
             eaCadena = #nifw0002#2;  |QBF eaCadena;
             |HAZ SeparaNombreIzq;

             #nifw0002#4 = eaCadena1;
             #nifw0002#5 = eaCadena2;
             #nifw0002#6 = eaCadena3;
             #nifw0002#7 = eaCadena1 + " " + eaCadena2 + ", " + eaCadena3;

             #nifw0002#8 = "";
         |SINO;
             #nifw0002#4 = "";
             #nifw0002#5 = "";
             #nifw0002#6 = "";
             #nifw0002#7 = "";

             #nifw0002#8 = #nifw0002#2;
         |FINSI;
     |FINSI;

     |GRABA 020#nifw0002.a;
     |LIBERA #nifw0002;
|FPRC;

|PROCESO GrabaM1;
     |QBF eaResNIF;

     aAlfa = #nifz0001#0;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     |HORA aHora;

     #nifm0001#0 = #nifz0001#0;
     |LEE 101#nifm0001.=;
     |SI FSalida ! 0;
         |DDEFECTO #nifm0001;

         #nifm0001#0 = #nifz0001#0;
         |GRABA 020#nifm0001.b;
     |FINSI;

     #nifm0001#1 = #nifz0001#1;
     #nifm0001#2 = eaNomNIF;
     #nifm0001#3 = eaResNIF;
     #nifm0001#4 = efFechaSys;
     #nifm0001#5 = aHora;

     |SI eaResNIF = "NO IDENTIFICADO";
         #nifm0001#2 = "";
     |FINSI;

     |GRABA 020#nifm0001.a;
     |LIBERA #nifm0001;

     #nifm0002#0 = #nifz0001#0;
     #nifm0002#1 = efFechaSys;
     #nifm0002#2 = aHora;
     |LEE 101#nifm0002.=;
     |SI FSalida ! 0;
         |DDEFECTO #nifm0002;
         #nifm0002#0 = #nifz0001#0;
         #nifm0002#1 = efFechaSys;
         #nifm0002#2 = aHora;
         |GRABA 020#nifm0002.b;
     |FINSI;

     #nifm0002#3 = #nifz0001#1;
     #nifm0002#4 = #nifm0001#2;
     #nifm0002#5 = eaResNIF;

     |GRABA 020#nifm0002.a;
     |LIBERA #nifm0002;

     #nifw0001#1 = #nifm0001#1;
     |HAZ GrabaW2;
|FPRC;

|PROCESO LeeRespuesta;
     aOri  = eaPathNIF + aFicRes;
     aDes  = eaPathTmp + aFicRes;
     |SI eaIP = "";
         |COPIA_FICHERO aOri, aDes;
     |SINO;
         |RECIBE_FICHERO aOri, aDes;
     |FINSI;

     nOk      = 0;
     eaError  = "";
     eaNIF    = "";
     eaNomNIF = "";
     eaResNIF = "";

     aAbre  = eaPathTmp + aFicRes;
     |XABRE "", aAbre, nHandle;

     eaNIF = "";
     |PARA; |SI;  |HACIENDO;
          |XLEE nHandle, 250, aLee;
          |SI FSalida < 0; |SAL;  |FINSI;

          aAlfa = aLee - "<VNifV2Sal:Nif>";
          |SI FSalida ! 0;
              |HAZ SacaCadena;
              eaNIF = aCadena;
          |FINSI;

          aAlfa = aLee - "<VNifV2Sal:Nombre>";
          |SI FSalida ! 0;
              |HAZ SacaCadena;
              eaNomNIF = aCadena;

              |PARA;  |SI;  |HACIENDO;
                   |HAZ CambiaCaracteres;
                   |SI nCmb = 0;  |SAL;  |FINSI;
              |SIGUE;
          |FINSI;

          aAlfa = aLee - "<VNifV2Sal:Resultado>";
          |SI FSalida ! 0;
              |HAZ SacaCadena;
              eaResNIF = aCadena;

              nOk     = 1;

              #nifw0001#0 = eaNIF;
              |LEE 000#nifw0001.=;
              |SI FSalida = 0;
                  #nifz0001#0 = #nifw0001#0;
                  #nifz0001#1 = #nifw0001#1;
                  |HAZ GrabaM1;
              |FINSI;
          |FINSI;

          aAlfa = aLee - "<faultstring>";
          |SI FSalida ! 0;
              |HAZ SacaCadena;
              eaError = aCadena;
              |SAL;
          |FINSI;
     |SIGUE;
     |XCIERRA nHandle;

     |SI eaError ! "";
         aAlfa = "0000Proceso cancelado. " + eaError;  |QBF aAlfa;
         |MENAV aAlfa;
     |FINSI;

     |SI nOk = 0;
         |ACABA;
     |FINSI;

     |FBORRA aAbre;
|FPRC;

|PROCESO Comparalos;
     |QBT aNom1;
     |QBT aNom2;
     |PARA;  |SI;  |HACIENDO;
          nFSalida = 0;

          aNom1 = aNom1 - ".";
          nFSalida = nFSalida + FSalida;

          aNom1 = aNom1 - ",";
          nFSalida = nFSalida + FSalida;

          aNom2 = aNom2 - ".";
          nFSalida = nFSalida + FSalida;

          aNom2 = aNom2 - ",";
          nFSalida = nFSalida + FSalida;

          |SI nFSalida = 0;
              |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO EnviaLote;
     |HAZ Ds_SII;
     |SI nOk = 0;  |ACABA;  |FINSI;

     aOri = eaPathTmp + aFicXml;
     aDes = eaPathNIF + aFicXml;
     |SI eaIP = "";
         |COPIA_FICHERO aOri, aDes;
     |SINO;
         |ENVIA_FICHERO aOri, aDes;
     |FINSI;

     aLinea  = "0";

     aEnlace = eaPathNIF + "ejecuta.bat";
     |XABRE "WBC", aEnlace, nHandle;

     aAlfa = eaPathNIF + "ds_sii.exe ";       |XGRABA nHandle, aAlfa;
     aAlfa = "ds123456 " + aLinea + " ";      |XGRABA nHandle, aAlfa;
     aAlfa = eaPathNIF + aFicXml + " ";       |XGRABA nHandle, aAlfa;
     aAlfa = eaPathNIF + aFicRes + " ";       |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;

     |RSYSTEM aEnlace;

     aAbre = eaPathNIF + aFicRes;
     |XABRE "EC", aAbre, 0;
     |SI FSalida ] 0;
         |HAZ LeeRespuesta;
     |SINO;
         |MENAV "0000Sin respuesta. Revise la instalaci¢n y validez del certificado digital";

         nOk = 0;
     |FINSI;
|FPRC;

|PROCESO GrabaFic;
     |HAZ ConvierteTF8;

     eaAlfa = eaAlfa + &13 + &10;
     |XGRABA nHandle, eaAlfa;
|FPRC;

|PROCESO CabXml;
     eaAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "UTF-8" + &34 + "?>";
     |HAZ GrabaFic;

     eaAlfa = "<soapenv:Envelope xmlns:soapenv=" + &34;
     eaAlfa = eaAlfa + "http://schemas.xmlsoap.org/soap/envelope/" + &34;
     |HAZ GrabaFic;

     eaAlfa = "xmlns:vnif=" + &34 + "http://www2.agenciatributaria.gob.es/";
     eaAlfa = eaAlfa + "static_files/common/internet/dep/aplicaciones/es/";
     eaAlfa = eaAlfa + "aeat/burt/jdit/ws/VNifV2Ent.xsd" + &34 + ">";
     |HAZ GrabaFic;

     eaAlfa = "<soapenv:Header/>";
     |HAZ GrabaFic;

     eaAlfa = "   <soapenv:Body>";
     |HAZ GrabaFic;

     eaAlfa = "          <vnif:VNifV2Ent>";
     |HAZ GrabaFic;
|FPRC;                                                                                                                                                                               </soapenv:Envelope>

|PROCESO DetXml;
     eaAlfa = "               <vnif:Contribuyente>";
     |HAZ GrabaFic;

     eaAlfa = "                    <vnif:Nif>" + #nifz0001#0 + "</vnif:Nif>";
     |HAZ GrabaFic;

     eaAlfa = "                    <vnif:Nombre>" + #nifz0001#1;  |QBF aAlfa;
     eaAlfa = eaAlfa + "</vnif:Nombre>";
     |HAZ GrabaFic;

     eaAlfa = "               </vnif:Contribuyente>";
     |HAZ GrabaFic;
|FPRC;                                                                                                                                                                               </soapenv:Envelope>

|PROCESO PieXml;
     eaAlfa = "          </vnif:VNifV2Ent>";
     |HAZ GrabaFic;

     eaAlfa = "   </soapenv:Body>";
     |HAZ GrabaFic;

     eaAlfa = "</soapenv:Envelope>";
     |HAZ GrabaFic;
|FPRC;                                                                                                                                                                               </soapenv:Envelope>

|PROCESO nifw0001Env;
     nOk = 1;

     |SI nPasada = 0;
         #nifm0001#0 = #nifw0001#0;
         |LEE 000#nifm0001.=;
         |SI FSalida = 0;
             |HAZ GrabaW2;
             |ACABA;
         |FINSI;

         nNumReg = nNumReg + 1;

         |ACABA;
     |FINSI;

     #nifm0001#0 = #nifw0001#0;
     |LEE 000#nifm0001.=;
     |SI FSalida = 0;
         |ACABA;
     |FINSI;

     #nifz0001#0 = #nifw0001#0;
     #nifz0001#1 = #nifw0001#1;
     |HAZ DetXml;

     aUltReg = #nifw0001#0;
     nGrab   = nGrab + 1;

     |SI nGrab = nTope;
         |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE nifw0001Env;
     #nifw0001#2;
     ;
     "S", aDReg;
     "S", "zzzzzzzzz";
     ;
     NULL, nifw0001Env;
|FIN;

|PROCESO Ficheros;
     aDReg   = "";
     aUltReg = "";

     |PARA nFiche = 1;  |SI nFiche [ nVeces;  |HACIENDO nFiche = nFiche + 1;
           |SI nVeces > 1;
               aAlfa = "0000Preparando la consulta " + nFiche;
               |MENAV aAlfa;
           |FINSI;

           |HORA aHora;

           aFicXml = "NIF";
           aFicXml = aFicXml + efFechaSys % -104;
           aFicXml = aFicXml + efFechaSys % 402;
           aFicXml = aFicXml + efFechaSys % 102;
           aFicXml = aFicXml + aHora % 102;
           aFicXml = aFicXml + aHora % 402;
           aFicXml = aFicXml + aHora % 702;

           aFicRes = aFicXml + ".res";
           aFicXml = aFicXml + ".xml";

           aAbreXml = eaPathTmp + aFicXml;

           |XABRE "WB", aAbreXml, nHandle;
           |HAZ CabXml;

           |SI aUltReg ! "";
               aDReg = aUltReg + 1;
           |FINSI;

           nGrab   = 0;
           nPasada = 1;
           |BUCLE nifw0001Env;

           |HAZ PieXml;
           |XCIERRA nHandle;

           |HAZ EnviaLote;
     |SIGUE;
|FPRC;

|PROCESO nifz0001;
     |HORA aHora;

     aFicXml = "NIF";
     aFicXml = aFicXml + efFechaSys % -104;
     aFicXml = aFicXml + efFechaSys % 402;
     aFicXml = aFicXml + efFechaSys % 102;
     aFicXml = aFicXml + aHora % 102;
     aFicXml = aFicXml + aHora % 402;
     aFicXml = aFicXml + aHora % 702;

     aFicRes = aFicXml + ".res";
     aFicXml = aFicXml + ".xml";

     aAbreXml = eaPathTmp + aFicXml;

     |XABRE "WB", aAbreXml, nHandle;

     |HAZ CabXml;
     |HAZ DetXml;
     |HAZ PieXml;

     |XCIERRA nHandle;

     |HAZ EnviaLote;
|FPRC;

|PROCESO Consulta;
     aLong = eaNIF % 0;
     |SI aLong ! "9";
         |MENAV "0000Longitud err¢nea";
         |ACABA;
     |FINSI;

     aFicTmp   = "nifw0001" + Usuario;  |NOME_DAT #nifw0001#aFicTmp#;
     aFicTmp   = "nifw0002" + Usuario;  |NOME_DAT #nifw0002#aFicTmp#;

     |ABRE #nifw0001;  |CIERRA #nifw0001;  |DELINDEX #nifw0001;
     |ABRE #nifw0002;  |CIERRA #nifw0002;  |DELINDEX #nifw0002;

     |ABRET #nifw0001;
     #nifw0001#0 = #nifz0001#0;
     #nifw0001#1 = #nifz0001#1;
     |GRABA 020#nifw0001.n;
     |LIBERA #nifw0001;

     #nifw0002#1 = #nifw0001#1;
     #nifw0002#2 = #nifm0001#2;
     #nifw0002#3 = #nifm0001#3;

     |ABRET #nifw0002;

     #nifm0001#0 = #nifz0001#0;
     |LEE 000#nifm0001.=;
     |SI FSalida = 0;
         |HAZ GrabaW2;
     |SINO;
         |HAZ AbreVtn1;
         |HAZ nifz0001;
         |HAZ CierraVtn1;
     |FINSI;

     |LEE 000#nifw0002.p;
     |SI FSalida = 0;
         |HAZ Resultados;
     |FINSI;

     |CIERRAT #nifw0001;  |DELINDEX #nifw0001;
     |CIERRAT #nifw0002;  |DELINDEX #nifw0002;
|FPRC;

|PROCESO ConsultaMasiva;
     aFicTmp   = "nifw0002" + Usuario;  |NOME_DAT #nifw0002#aFicTmp#;
     |ABRE #nifw0002;  |CIERRA #nifw0002;  |DELINDEX #nifw0002;

     |ABRET #nifw0002;

     nNumReg = 0;
     aDReg   = "";
     nOk     = 0;
     nPasada = 0;  |BUCLE nifw0001Env;

     |SI nOk = 0;
         |MENAV "0000No hay registros a consultar";

         |CIERRAT #nifw0002;  |DELINDEX #nifw0002;

         |ACABA;
     |FINSI;

     nTope  = 10000;
     nVeces = ((nNumReg / nTope) + .4999) ! 0;

     |SI nVeces > 1;
         aAlfa = "0000Consulta con " + nNumReg + " registros, solo se pueden enviar ";
         aAlfa = aAlfa + nTope + " por consulta, por lo que haremos " + nVeces  + " consultas";
         |MENAV aAlfa;
     |FINSI;

     |SI nNumReg ! 0;
         |HAZ AbreVtn1;
         |HAZ Ficheros;
         |HAZ CierraVtn1;
     |FINSI;

     |LEE 000#nifw0002.p;
     |SI FSalida = 0;
         |HAZ Resultados;
     |FINSI;

     |CIERRAT #nifw0002;  |DELINDEX #nifw0002;
|FPRC;
