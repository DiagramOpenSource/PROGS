|FICHEROS;
     av060m01;
     av060m02;
     av060m03;

     av060m03@;

     dsam0001;
     :dsarchi/dsarw010;
|FIN;

|VARIABLES;
     aAlfa               = "";
     aAlfa1              = "";
     aAlfa2              = "";
     aAlfa3              = "";
     aBase               = "";
     aAbre               = "";
     aRutaOrigen         = "";
     aRutaDestino        = "";
     aFicheroTxt         = "";
     aBuscar             = "";
     aRefrescar          = "";
     aEsc1               = "";
     aEsc2               = "";
     aRetu               = "";
     aTecla              = "";
     aRefresca           = "";
     aIPRemoto           = "";
     aLong               = "";
     aCarac              = "";
     aTexto              = "";
     aUsuario            = "";
     aIPServ             = "";
     aServCorreo         = "";
     aTo                 = "";
     aFrom               = "";
     aPwd                = "";
     aNombre             = "";
     aFichero            = "";
     aExtension          = "";
     aEjecuta            = "";
     aDocRemoto          = "";
     aDocServidor        = "";
     aEmp                = "";
     aEmpCom             = "";
     aDatos              = "";
     aDatosCom           = "";
     aMas                = "";
     aDef                = "";
     aAux                = "";
     aPrograma           = "";
     aDirLocal           = "";
     aBorra              = "";
     aMensaje            = "";
     aLinea              = "";
     aTabla              = "";
     aPlantillaTxt       = "";
     aPlantillaDoc       = "";
     aPlantillaRes       = "";
     aAbrirDoc           = "";
     aAjuste             = "";
     aAsunto             = "";
     aPlanilla           = "";
     aNomFich            = "";
     aTipo               = "";
     aBusco              = "";
     aCadena             = "";
     aEstoy              = "";
     aNIF                = "";
     aDsmanPath          = "";
     aTab                = "";
     a13                 = "";
     a10                 = "";
     aFicTmp             = "";
     aCarpeta            = "";
     aFechaD             = "";
     aHoraD              = "";
     aRuta               = "";
     aLee                = "";
     aOrigen             = "";
     aDestino            = "";
     aCert               = "";
     aCIFBuzon           = "";
     aNomBuzon           = "";
     aNEOSBuzon          = "";
     aidNEO              = "";
     aEmisor             = "";
     aFecha              = "";
     aHora               = "";
     aEstado             = "";
     aDescarga           = "";
     aEnviado            = "";
     aEmail              = "";
     aCar                = "";
     aIP                 = "";
     aSalida             = "";
     aAutenti            = "";
     aRojo               = "255,80,80;255,255,255";
     aAzul               = "18,28,245;255,255,255";
     aVerde              = "0,185,0;255,255,255";
     aVar0               = "";
     aVar1               = "";
     aVar2               = "";
     aVar3               = "";
     aVar4               = "";
     aVar5               = "";
     aVar6               = "";
     aVar7               = "";
     aVar8               = "";
     aVar9               = "";
     aVar10              = "";

     nColor              = 0;
     nIni                = "";
     n1Vent              = 0;
     nHandle             = 0;
     nHandleTgz          = 0;
     nPos                = 0;
     nNume               = 0;
     nLabelCorreo        = 0;
     nLinea              = 0;
     nLong               = 0;
     nContaCmp           = 0;
     nVoy                = 0;
     nNuevo              = 0;
     nPon                = 0;
     nCar                = 0;
     nCarac              = 0;
     nAvisos             = 0;
     nHay                = 0;
     nError              = 0;
     nFSalida            = 0;

     fFecha              = @;

     {1}aContiene        = "";

     {-1}aVent           = "";
         aVent1          = 0;
         aVent2          = 0;
         aVent3          = 0;
         aVent4          = 0;
         aVent5          = "";

     {-1}sTree           = 0;
         sT_nID          = 0;
         sT_nOper        = 0;
         sT_aData        = "";


     &eaPathCorreo       = "";
     &eaPathDocu         = "";
     &eaPathLocalDoc     = "";
     &eaPath             = "";
     &eaPathCom          = "";
     &eaExtension        = "";

     &enINI              = 0;
     &eaCarpeta          = "";
     &enRegistro         = 0;
     &enRecogidos        = 0;
     &eaAlfa             = "";
|FIN;

|PROCESO GrabaCSVSin;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO GrabaCSVCon;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO av060m03;
     nHay       = 1;
     #av060m01#0 = #av060m03#0;
     |LEE 000#av060m01.=;

     aAlfa = #av060m03#0  + ";";      |HAZ GrabaCSVSin;
     aAlfa = #av060m03#1  + ";";      |HAZ GrabaCSVSin;
     aAlfa = #av060m03#2  + ";";      |HAZ GrabaCSVSin;
     aAlfa = #av060m03#4  + ";";      |HAZ GrabaCSVSin;
     aAlfa = #av060m03#5  + ";";      |HAZ GrabaCSVSin;
     aAlfa = #av060m03#6  + ";";      |HAZ GrabaCSVSin;
     aAlfa = #av060m03#7  + ";";      |HAZ GrabaCSVSin;
     aAlfa = #av060m03#9  + ";";      |HAZ GrabaCSVSin;
     aAlfa = #av060m03#10 + ";";      |HAZ GrabaCSVSin;
     aAlfa = #av060m03#11;            |HAZ GrabaCSVCon;

     #av060m03@#0 = #av060m03#0;
     #av060m03@#1 = #av060m03#1;
     #av060m03@#2 = #av060m03#2;
     |LEE 101#av060m03@.=;
     |SI FSalida = 0;
         #av060m03@#12 = "X";
         |GRABA 020#av060m03@.a;
         |LIBERA #av060m03@;
     |FINSI;
|FPRC;

|DEFBUCLE av060m03;
     #av060m03#3;
     ;
     "S", "            ", "            ";
     "X", "zzzzzzzzzzzz", "zzzzzzzzzzzz";
     ;
     NULL, av060m03;
|FIN;

|PROCESO av060m03Marca;
     #av060m03@#0 = #av060m03#0;
     #av060m03@#1 = #av060m03#1;
     #av060m03@#2 = #av060m03#2;
     |LEE 101#av060m03@.=;
     |SI FSalida = 0;
         |SI nError = 0;
             #av060m03@#12 = "";
         |SINO;
             #av060m03@#12 = "S";
         |FINSI;
         |GRABA 020#av060m03@.a;
         |LIBERA #av060m03@;
     |FINSI;
|FPRC;

|DEFBUCLE av060m03Marca;
     #av060m03#3;
     ;
     "X", "            ", "            ";
     "X", "zzzzzzzzzzzz", "zzzzzzzzzzzz";
     ;
     NULL, av060m03Marca;
|FIN;

|PROCESO MandaCorreo;
     aIP      = #dsarw010#18;  |QBF aIP;
     aFrom    = #dsam0001#13;  |QBF aFrom;
     aSalida  = #dsarw010#19;  |QBF aSalida;
     aTo      = "notificaciones060@avisos.diagram.es";
     aAsunto  = "AVISOS LEIDOS";
     aMensaje = "Avisos leidos";

     |SI #dsarw010#23 = "S";
          |SI #dsarw010#20 = "N";
               aAutenti = "!" + aFrom;
          |SINO;
               aAutenti = "!" + #dsarw010#22;
               |QBF aAutenti;
               aAutenti = aAutenti + ":" + #dsarw010#21;
               |QBF aAutenti;
               aAutenti = aAutenti + ":" + aFrom;
          |FINSI;
     |SINO;
          |SI #dsarw010#20 = "N";
               aAutenti = aFrom;
          |SINO;
               aAutenti = #dsarw010#22;
               |QBF aAutenti;
               aAutenti = aAutenti + ":" + #dsarw010#21;
               |QBF aAutenti;
               aAutenti = aAutenti + ":" + aFrom;
          |FINSI;
     |FINSI;

     |DSCORREO_ENVIA aIP, aSalida, aAutenti, aTo, aAsunto, aMensaje, aFicTmp;
     nFSalida = FSalida;
     |SI nFSalida ] 0;
         nError = 0;
     |SINO;
         nError = 1;
     |FINSI;

     |BUCLE av060m03Marca;
|FPRC;

|PROCESO EnviarCorreos;
     |DDEF aDef;
     aMas = aDef + "av060m03.mas";
     |CARGA_DEF aMas, av060m03@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     fFecha = ~;
     |HORA aHora;

     nHay    = 0;
     aFicTmp = eaPathCorreo;
     aFicTmp = aFicTmp + (fFecha % -104) + (fFecha % 402) + (fFecha % 102);
     aFicTmp = aFicTmp + (aHora % 102) + (aHora % 402) + (aHora % 702);
     aFicTmp = aFicTmp + ".csv";

     |XABRE "BW", aFicTmp, nHandle;

     |ABRE #av060m03@;
     |ABRE #av060m01;
     |BUCLE av060m03;
     |CIERRA #av060m01;

     |XCIERRA nHandle;

     |SI nHay = 1;
         |HAZ MandaCorreo;
     |FINSI;

     |CIERRA #av060m03@;
     |DESCARGA_DEF #av060m03@;

     |FBORRA aFicTmp;
|FPRC;

|PROCESO SacaDatos;
     |QBF aLee;
     |SI aLee = "";  |ACABA;  |FINSI;

     aLong     = aLee % 0;
     nLong     = aLong;
     nContaCmp = 0;
     aVar0     = "";
     aVar1     = "";
     aVar2     = "";
     aVar3     = "";
     aVar4     = "";
     aVar5     = "";
     aVar6     = "";
     aVar7     = "";
     aVar8     = "";
     aVar9     = "";
     aVar10    = "";
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos   = (nCarac * 100) + 1;
           aCarac = aLee % nPos;
           |SI aCarac = ";";
               nContaCmp = nContaCmp + 1;
               aCarac    = "";
           |FINSI;

           |SI nContaCmp = 0;   aVar0  = aVar0  + aCarac;  |FINSI;
           |SI nContaCmp = 1;   aVar1  = aVar1  + aCarac;  |FINSI;
           |SI nContaCmp = 2;   aVar2  = aVar2  + aCarac;  |FINSI;
           |SI nContaCmp = 3;   aVar3  = aVar3  + aCarac;  |FINSI;
           |SI nContaCmp = 4;   aVar4  = aVar4  + aCarac;  |FINSI;
           |SI nContaCmp = 5;   aVar5  = aVar5  + aCarac;  |FINSI;
           |SI nContaCmp = 6;   aVar6  = aVar6  + aCarac;  |FINSI;
           |SI nContaCmp = 7;   aVar7  = aVar7  + aCarac;  |FINSI;
           |SI nContaCmp = 8;   aVar8  = aVar8  + aCarac;  |FINSI;
           |SI nContaCmp = 9;   aVar9  = aVar9  + aCarac;  |FINSI;
           |SI nContaCmp = 10;  aVar10 = aVar10 + aCarac;  |FINSI;
     |SIGUE;

     |SELECT #1#av060m01;
     #av060m01#0 = aVar0;
     |LEE 000#av060m01.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     #av060m03#0  = aVar0;
     #av060m03#1  = aVar1;
     #av060m03#2  = aVar2;
     |LEE 101#av060m03.=;
     |SI FSalida ! 0;
         |DDEFECTO #av060m03;
         #av060m03#0  = aVar0;
         #av060m03#1  = aVar1;
         #av060m03#2  = aVar2;
         |GRABA 020#av060m03.b;
     |FINSI;

     #av060m03#3  = #av060m01#1;
     #av060m03#4  = aVar3;
     #av060m03#5  = aVar4;
     #av060m03#6  = aVar5;
     #av060m03#7  = aVar6;
     #av060m03#9  = aVar8;
     #av060m03#10 = aVar9;
     #av060m03#11 = aVar10;
     #av060m03#13 = aVerde;

     |SI #av060m03#7 = "NO_LEIDA       ";
         #av060m03#8  = "N";
         #av060m03#13 = aRojo;
     |SINO;
         fFecha = ~;
         |HORA aHora;

         #av060m03#8  = "S";
         #av060m03#9  = fFecha;
         #av060m03#10 = aHora;
         #av060m03#11 = Usuario % 810;
         #av060m03#12 = "S";
     |FINSI;

     |GRABA 020#av060m03.a;
     |LIBERA #av060m03;

     nAvisos = nAvisos + 1;
|FPRC;

|PROCESO LeeCSV;
     nLinea = 0;
     |XABRE "", aNombre, nHandle;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandle, 255, aLee;
          |SI FSalida < 0;  |SAL;  |FINSI;

          |HAZ SacaDatos;
     |SIGUE;
     |XCIERRA nHandle;

     |FBORRA aNombre;
|FPRC;

|PROCESO RecogerCorreos;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |PARA; |SI; |HACIENDO;
          aIPServ     = #dsarw010#18;        |QBF aIPServ;
          aServCorreo = #dsam0001#16;        |QBF aServCorreo;
          aFrom       = #dsam0001#17;        |QBF aFrom;
          aPwd        = #dsam0001#15;        |QBF aPwd;
          aNombre     = "";
          aExtension  = "";

          |DSCORREO_RECIBE aIPServ, aServCorreo, aFrom, aPwd, eaPathCorreo, aNombre;
          |SI FSalida ! 0;  |SAL;  |FINSI;

          aAsunto    = FSalida;
          aExtension = aAsunto;  |QBF aExtension
          aExtension = aExtension % -104;  |QBT aExtension;
          aTipo      = "";

          aAlfa    = aAsunto - "Avisos 060";
          |SI FSalida ! 0;
              |PARA;  |SI;  |HACIENDO;
                      aNombre = aNombre - ";";
                      |SI FSalida = 0;  |SAL;  |FINSI;
              |SIGUE;

              aFichero = aNombre - eaPathCorreo;
              aAlfa    = (aFichero % -103) > " ";
              |SI aAlfa = "CSV";
                  |HAZ LeeCSV;
              |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;



|PROGRAMA;
     |DBASS aBase;  |QBF aBase;
     aAlfa = aBase + "dsarchi/dsarchi.men";
     |XABRE "E", aAlfa, nHandle;
     |SI FSalida < 0;
         |MENAV "0000El programa necesita el GAD instalado con la configuraci¢n del DSCORREO.";
         |ACABA;
     |FINSI;

     aAlfa = aBase + "dsarchi/fich/";
     |PATH_DAT #dsarw010#aAlfa#;
     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     aAlfa = #dsarw010#18 + #dsarw010#19;  |QBT aAlfa;
     |SI aAlfa = "";
         |MENAV "0000No est  configurado el DSCORREO en GAD.";
         |ACABA;
     |FINSI;

     |DBASE aBase;  |QBF aBase;
     eaPathCorreo = aBase + "dscorreo/";  |MKDIR eaPathCorreo;

     |ABRE #dsam0001;
     |LEE 000#dsam0001.p;
     |SI FSalida ! 0;  |DDEFECTO #dsam0001;  |FINSI;
     |CIERRA #dsam0001;

     |SI PARAMETRO = "ENVIO";
         |HAZ EnviarCorreos;
         |ACABA;
     |FINSI;

     |SI PARAMETRO ! "";
         |VENTANA 0502, 0830, -1, 16, "Recogiendo correos";
         n1Vent = FSalida;

         aVent1 = -1;
         aVent2 = -1;
         aVent3 = 0;
         aVent4 = n1Vent;
         aVent5 = "MODAL";
         |ESPECIFICA "ESTADO_VENTANA", aVent;

         |PTEC 802;  |PAUSA;
         nLabelCorreo = -1;
     |FINSI;

     |ABRET #av060m01;
     |ABRET #av060m03;

     nAvisos = 0;
     |HAZ RecogerCorreos;

     |CIERRAT #av060m01;
     |CIERRAT #av060m03;

     |SI PARAMETRO ! "";
         aAlfa = "0000No hay avisos nuevos";
         |SI nAvisos ! 0;
             aAlfa = "0000Recogidos " + nAvisos + " avisos nuevos";
         |FINSI;
         |MENAV aAlfa;

         aVent1 = -1;
         aVent2 = -1;
         aVent3 = 0;
         aVent4 = n1Vent;
         aVent5 = "MODELESS";
         |ESPECIFICA "ESTADO_VENTANA", aVent;

         |FINVENTANA n1Vent;
     |FINSI;
|FPRO;
