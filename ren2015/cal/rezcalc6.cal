||Calculo patrimonio

|FICHEROS;
     rew99999;

     datfic0@;
     datfic1@;
     datfic2@;
     datfic3@;

    &refere1@;
    &refere2@;
    &refere3@;
|FIN;

|VARIABLES;
      aDef             = "";
      aAlfa            = "";
      aDecla           = "";
      aFichero         = "";

      nCoefi           = 0;
      nSwFich          = 0;
      nFactor          = 0;
      nCampo16         = 0;
      nObligado        = 0;
      nValor           = 0;
      nValor1          = 0;
      nValor2          = 0;
      nValor3          = 0;
      nValorV1         = 0;
      nValorI1         = 0;
      nValorTM         = 0;
      nCatastral       = 0;
      nCampo1          = 0;
      nCampo2          = 0;
      nCampo3          = 0;
      nCampo4          = 0;
      nCampo5          = 0;
      nCampo6          = 0;
      nCampo7          = 0;
      nCampo8          = 0;
      nCampo9          = 0;
      nCampo10         = 0;
      nCampo11         = 0;
      nConta           = 0;
      nBaseImpo        = 0;
      nBaseImpo1       = 0;
      nBaseImpo2       = 0;
      nIntegra         = 0;
      nIntegraT        = 0;
      nIntegraC        = 0;
      nParte           = 0;
      nSw              = 0;
      nMenor           = 0;
      nTotalCuota      = 0;
      nDeduccion       = 0;
      nLimite          = 0;
      nValor32         = 0;
      nValor35         = 0;
      nValor696        = 0;
      nValor36T        = 0;
      nValor36C        = 0;
      nValor38T        = 0;
      nValor38C        = 0;
      nValorTT         = 0;
      nValorTTT        = 0;
      nValorCC         = 0;
      nValorCCC        = 0;
      nValor27         = 0;
      nValor28         = 0;
      nValor465        = 0;
      nValor697        = 0;
      nPasada          = 0;
      nCuotaMino       = 0;
      nHipotetico      = 0;
      nCuotaHipotetica = 0;
      nPorce           = 0;

     &enEmpresa        = 0;
     &enComplementaria = 0;
     &eaPathDef        = "";
     &eaContri         = "";
     &enMinusvalia     = 0;
     &eaMinuAyuda      = "";
     &enBloque         = 0;
     &eaCasilla        = "";
     &enImporte        = 0;
     &enSwAcum         = 0;
     &enNomeDat        = 0;
     &enNomeAgr        = 0;
     &eaMuerto         = "";
     &efFechaMuerto    = @;
     &enCalcuMuerto    = 0;
     &eaLiquida        = "";
     &eaModoRenta      = "";
|FIN;

|PROCESO Liquida7;
     enSwAcum  = 1;
     enImporte = 0;

     |SI #datfic0@#1 = "A1";
         aDef    = eaPathDef + "rem01044.mas";
         |CARGA_DEF aDef, datfic2@;
         |SI FSalida ! 0;
             aAlfa = "     Error en cargar el Def " + aDef;
             |MENAV aAlfa;
             |ACABA;
         |FINSI;

         |SI enNomeDat = 1;  |NOME_DAT #datfic2@#"zdat1044"#;  |FINSI;

         |ABRE #datfic2@;
         #datfic2@#0 = enEmpresa;
         #datfic2@#1 = enComplementaria;
         #datfic2@#2 = eaContri;
         |LEE 101#datfic2@.=;
         |SI FSalida ! 0;
             |DDEFECTO #datfic2@;
             #datfic2@#0 = enEmpresa;
             #datfic2@#1 = enComplementaria;
             #datfic2@#2 = eaContri;
             |GRABA 020#datfic2@.b;
         |FINSI;

         |SI #datfic0@#22 = "S";
             #datfic2@#3 = (N\ #datfic2@#3 + (#datfic0@#10 % nCoefi));
             |SI #datfic0@#3 = "VARIOS    ";
                 #datfic2@#4   = 300000;
                 |SI #datfic2@#4 > #datfic2@#3;  #datfic2@#4 = #datfic2@#3;  |FINSI;
             |SINO;
                 #datfic2@#4 = (N\ #datfic2@#4 + (#datfic0@#23 % nCoefi));
             |FINSI;
             |SI #datfic2@#4 > 300000;  #datfic2@#4 = 300000;  |FINSI;
             #datfic2@#5 = (N\ #datfic2@#3 - #datfic2@#4);
         |SINO;
             #datfic2@#6 = (N\ #datfic2@#6 + (#datfic0@#10 % nCoefi));
         |FINSI;

         |GRABA 020#datfic2@.a;
         |LIBERA #datfic2@;

         |HAZ CreaLiquida;               || En el rezcalut
         enSwAcum  = 0;
         enBloque  = 2;
         eaCasilla = "060";
         enImporte = #datfic2@#3;
         |HAZ GrabaLineal;

         enBloque  = 2;
         eaCasilla = "061";
         enImporte = #datfic2@#4;
         |HAZ GrabaLineal;

         enBloque  = 1;
         eaCasilla = "001";
         enImporte = #datfic2@#5 + #datfic2@#6;
         |HAZ GrabaLineal;

         enImporte = 0;

         |DESCARGA_DEF #datfic2@;
     |FINSI;

     |SI #datfic0@#1 = "VI";
         aDef    = eaPathDef + "rem01044.mas";
         |CARGA_DEF aDef, datfic2@;
         |SI FSalida ! 0;
             aAlfa = "     Error en cargar el Def " + aDef;
             |MENAV aAlfa;
             |ACABA;
         |FINSI;

         |SI enNomeDat = 1;  |NOME_DAT #datfic2@#"zdat1044"#;  |FINSI;

         |ABRE #datfic2@;
         #datfic2@#0 = enEmpresa;
         #datfic2@#1 = enComplementaria;
         #datfic2@#2 = eaContri;
         |LEE 101#datfic2@.=;
         |SI FSalida ! 0;
             |DDEFECTO #datfic2@;
             #datfic2@#0 = enEmpresa;
             #datfic2@#1 = enComplementaria;
             #datfic2@#2 = eaContri;
             |GRABA 020#datfic2@.b;
         |FINSI;

         #datfic2@#7 = (N\ #datfic2@#7 + (#datfic0@#10 % nCoefi));

         |GRABA 020#datfic2@.a;
         |LIBERA #datfic2@;

         |DESCARGA_DEF #datfic2@;
     |FINSI;

     |SI #datfic0@#1 = "V4";
         aDef    = eaPathDef + "rem01044.mas";
         |CARGA_DEF aDef, datfic2@;
         |SI FSalida ! 0;
             aAlfa = "     Error en cargar el Def " + aDef;
             |MENAV aAlfa;
             |ACABA;
         |FINSI;

         |SI enNomeDat = 1;  |NOME_DAT #datfic2@#"zdat1044"#;  |FINSI;

         |ABRE #datfic2@;
         #datfic2@#0 = enEmpresa;
         #datfic2@#1 = enComplementaria;
         #datfic2@#2 = eaContri;
         |LEE 101#datfic2@.=;
         |SI FSalida ! 0;
             |DDEFECTO #datfic2@;
             #datfic2@#0 = enEmpresa;
             #datfic2@#1 = enComplementaria;
             #datfic2@#2 = eaContri;
             |GRABA 020#datfic2@.b;
         |FINSI;

         #datfic2@#8  = (N\ #datfic2@#8  + (#datfic0@#14 % nCoefi));
         #datfic2@#9  = (N\ #datfic2@#9  + (#datfic0@#10 % nCoefi));
         #datfic2@#10 = (N\ #datfic2@#10 + (#datfic0@#23 % nCoefi));
         #datfic2@#11 = (N\ #datfic2@#11 + (#datfic0@#24 % nCoefi));

         |HAZ CreaLiquida;

         enBloque  = 05; eaCasilla = "030";  enImporte = #datfic2@#8  + #datfic2@#9;
         |HAZ GrabaLineal;

         enBloque  = 05; eaCasilla = "034";  enImporte = #datfic2@#10 + #datfic2@#11;
         |HAZ GrabaLineal;

         enImporte = 0;

         |GRABA 020#datfic2@.a;
         |LIBERA #datfic2@;

         |DESCARGA_DEF #datfic2@;
     |FINSI;

     |SI #datfic0@#1 = "B1"; enBloque  = 1;  eaCasilla = "002";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "C1"; enBloque  = 1;  eaCasilla = "003";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "C2"; enBloque  = 1;  eaCasilla = "003";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "E1"; enBloque  = 1;  eaCasilla = "005";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "F1"; enBloque  = 1;  eaCasilla = "006";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "F2"; enBloque  = 1;  eaCasilla = "007";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "G1"; enBloque  = 1;  eaCasilla = "008";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "G2"; enBloque  = 1;  eaCasilla = "009";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "G3"; enBloque  = 1;  eaCasilla = "010";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "G4"; enBloque  = 1;  eaCasilla = "011";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "I1"; enBloque  = 1;  eaCasilla = "014";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "J1"; enBloque  = 1;  eaCasilla = "015";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "K1"; enBloque  = 1;  eaCasilla = "016";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "L1"; enBloque  = 1;  eaCasilla = "017";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "M1"; enBloque  = 1;  eaCasilla = "018";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "N1"; enBloque  = 1;  eaCasilla = "019";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "O1"; enBloque  = 1;  eaCasilla = "020";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "P1"; enBloque  = 1;  eaCasilla = "021";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "Q1"; enBloque  = 1;  eaCasilla = "022";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "U1"; enBloque  = 1;  eaCasilla = "024";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;

     |SI #datfic0@#1 = "D1"; enBloque  = 2;  eaCasilla = "004";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "H1"; enBloque  = 2;  eaCasilla = "012";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "H2"; enBloque  = 2;  eaCasilla = "013";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;

     |SI #datfic0@#1 = "V0"; enBloque  = 05; eaCasilla = "032";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "V1"; enBloque  = 05; eaCasilla = "036";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "V2"; enBloque  = 07; eaCasilla = "b  ";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "V3"; enBloque  = 08; eaCasilla = "042";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "V6"; enBloque  = 05; eaCasilla = "031";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "V7"; enBloque  = 10; eaCasilla = "050";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "V9"; enBloque  = 03; eaCasilla = "028";  enImporte = #datfic0@#10 % nCoefi;  |FINSI;
     |SI #datfic0@#1 = "V5";
         |SI eaContri = "ZPATRITIT ";
             nValor36T = nValor36T + (#datfic0@#10 % nCoefi);
             nValor38T = nValor38T + (#datfic0@#14 % nCoefi);
         |FINSI;
         |SI eaContri = "ZPATRICON ";
             nValor36C = nValor36C + (#datfic0@#10 % nCoefi);
             nValor38C = nValor38C + (#datfic0@#14 % nCoefi);
         |FINSI;
     |FINSI;

     |SI enImporte ! 0;
         enSwAcum  = 1;
         |SI #datfic0@#1 = "A1";  enSwAcum  = 0;  |FINSI;

         |HAZ CreaLiquida;               || En el rezcalut
         |HAZ GrabaLineal;
     |FINSI;

     enImporte = 0;

     |SI #datfic0@#1 = "V2"; enBloque  = 07; eaCasilla = "041";  enImporte = #datfic0@#14 % nCoefi;  |FINSI;

     |SI enImporte ! 0;
         |HAZ CreaLiquida;               || En el rezcalut
         |HAZ GrabaLineal;
     |FINSI;
|FPRC;

|PROCESO Seleccion7;
     |SI #datfic0@#3 = "GANANCIAL ";                || Si es Ganancial
         nCoefi = 50;  eaContri = "ZPATRITIT ";   |HAZ Liquida7;
         nCoefi = 50;  eaContri = "ZPATRICON ";   |HAZ Liquida7;

         |ACABA;
     |FINSI;

     |SI #datfic0@#3 ! "VARIOS    ";                || SI es TITULAR O CONYUGE;
         |SI #datfic0@#3 = "TITULAR   "; eaContri = "ZPATRITIT ";  |FINSI;
         |SI #datfic0@#3 = "CONYUGE   "; eaContri = "ZPATRICON ";  |FINSI;
         nCoefi = 100;
         |HAZ Liquida7;
         |ACABA;
     |FINSI;

     |SI #datfic0@#20 ! 0; nCoefi = #datfic0@#20;  eaContri = "ZPATRITIT ";  |HAZ Liquida7;  |FINSI;
     |SI #datfic0@#21 ! 0; nCoefi = #datfic0@#21;  eaContri = "ZPATRICON ";  |HAZ Liquida7;  |FINSI;
|FPRC;

|PROCESO Patrimonio;
     aDef    = eaPathDef + "rem00099.mas";
     |CARGA_DEF aDef, datfic0@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def " + aDef;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |ABRE #datfic0@;
     |DDEFECTO #datfic0@;
     #datfic0@#0 = enEmpresa;
     #datfic0@#1 = "  ";
     #datfic0@#2 = 1;
     |LEE 040#datfic0@.];
     |PARA; |SI FSalida = 0;  |Y #datfic0@#0 = enEmpresa;  |HACIENDO;
            |HAZ Seleccion7;
            |LEE 040#datfic0@.s;
     |SIGUE;
     |CIERRA #datfic0@;

     |DESCARGA_DEF #datfic0@;
|FPRC;

|PROCESO BienesYDerechos;
     nValor   = 0;
     enBloque = 1;  eaCasilla = "001"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "002"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "003"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "005"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "006"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "007"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "008"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "009"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "010"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "011"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "014"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "015"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "016"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "017"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "018"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "019"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "020"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "021"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque = 1;  eaCasilla = "022"; |HAZ SacaImporte; nValor = nValor + enImporte;

     enBloque = 03; eaCasilla = "028"; |HAZ SacaImporte; nValor28 = enImporte;

     enSwAcum = 0;
     enBloque = 1;  eaCasilla = "023";  enImporte = nValor;  |HAZ GrabaLineal;
     nBaseImpo = enImporte;

     enBloque = 1;  eaCasilla = "024"; |HAZ SacaImporte; nValor1 = enImporte;

     nValor2  = nValor - nValor1;
     enBloque = 1;  eaCasilla = "025";  enImporte = nValor2;  |HAZ GrabaLineal;
     nBaseImpo1 = nValor2;

     |ABRE #rew99999;
     |SELECT #2#rew99999;
     #rew99999#1 = "TITULAR";
     |SI nConta = 2;  #rew99999#1 = "CONYUGE";  |FINSI;
     |LEE 040#rew99999.=;
     |SI FSalida  ! 0;  |DDEFECTO #rew99999;  |FINSI;
     |CIERRA #rew99999;

     enImporte = 700000;

     |SI #rew99999#7 = 2;
         enImporte = 500000;
     |FINSI;

     |SI #rew99999#7 = 9;
         enImporte = 500000;
     |FINSI;

     |SI #rew99999#7 = 10;
         |SI #rew99999#3 ] 33;  enImporte = 800000;  |FINSI;
         |SI #rew99999#3 ] 50;  enImporte = 900000;  |FINSI;
         |SI #rew99999#3 ] 65;  enImporte = 1000000; |FINSI;
     |FINSI;

     |SI #rew99999#7 = 12;
         enImporte = 700000;
     |FINSI;

     enBloque = 1;  eaCasilla = "026";  |HAZ GrabaLineal;

     enImporte = nBaseImpo1 - enImporte;
     |SI enImporte < 0;  enImporte = 0;  |FINSI;
     enBloque = 1;  eaCasilla = "027";  |HAZ GrabaLineal;
     nValor27 = enImporte;

     nBaseImpo2 = enImporte;
|FPRC;

|PROCESO Hipotetico;
     nHipotetico = nValor27 + nValor28;
     nSw         = 0;
     nValor1     = 0;
     nValor2     = 0;
     nValor3     = 0;
     |PARA nCampo1 = 8;  |SI nCampo1 ] 1; |HACIENDO nCampo1 = nCampo1 - 1;
           |SI nHipotetico ] #datfic1@#nCampo1#;
               |SI #datfic1@#nCampo1# ! 0;  |O nCampo1 = 1;
                   nCampo2 = nCampo1 + 16;
                   nCampo3 = nCampo1 + 8;
                   nValor1 = #datfic1@#nCampo1#;   || hasta
                   nValor2 = #datfic1@#nCampo2#;   || porcentaje
                   nValor3 = #datfic1@#nCampo3#;   || cuota hasta
                   |SAL;
               |FINSI;
           |FINSI;
     |SIGUE;

     |SI nHipotetico = 0;  nValor2 = 0;  |FINSI;

     nCuotaHipotetica = (nValor3 + ((nHipotetico - nValor1) % nValor2)) ! 2;
     nPorce           = (((nCuotaHipotetica  / nHipotetico) * 100) - 0.0049) ! 2;
     enImporte        = (nValor27 % nPorce) ! 2;
|FPRC;

|PROCESO CuotaIntegra;
     nSw     = 0;
     nValor1 = 0;
     nValor2 = 0;
     nValor3 = 0;
     |PARA nCampo1 = 8;  |SI nCampo1 ] 1; |HACIENDO nCampo1 = nCampo1 - 1;
           |SI enImporte ] #datfic1@#nCampo1#;
               |SI #datfic1@#nCampo1# ! 0;  |O nCampo1 = 1;
                   nCampo2 = nCampo1 + 16;
                   nCampo3 = nCampo1 + 8;
                   nValor1 = #datfic1@#nCampo1#;   || hasta
                   nValor2 = #datfic1@#nCampo2#;   || porcentaje
                   nValor3 = #datfic1@#nCampo3#;   || cuota hasta
                   |SAL;
               |FINSI;
           |FINSI;
     |SIGUE;

     |SI nBaseImpo2 = 0;  nValor2 = 0;      |FINSI;

     enImporte = (nValor3 + ((nBaseImpo2 - nValor1) % nValor2)) ! 2;

     |SI nValor28 = 0;
         enBloque  = 04; eaCasilla = "029";  |HAZ GrabaLineal;
     |SINO;
         |HAZ Hipotetico;
         enBloque  = 04; eaCasilla = "029";  |HAZ GrabaLineal;
     |FINSI;
                                  nIntegra   = enImporte;
     |SI #refere1@#2 = "ZPATRITIT ";  nIntegraT  = enImporte;  |FINSI;
     |SI #refere1@#2 = "ZPATRICON ";  nIntegraC  = enImporte;  |FINSI;
|FPRC;

|PROCESO LimiteCuota;
     |SI #datfic0@#94 ! "N";
         enImporte = 0;
         enBloque  = 05; eaCasilla = "030";  |HAZ GrabaLineal;
         enBloque  = 05; eaCasilla = "031";  |HAZ GrabaLineal;
         enBloque  = 05; eaCasilla = "032";  |HAZ GrabaLineal;
         enBloque  = 05; eaCasilla = "033";  |HAZ GrabaLineal;
         enBloque  = 05; eaCasilla = "034";  |HAZ GrabaLineal;
         enBloque  = 05; eaCasilla = "035";  |HAZ GrabaLineal;
         enBloque  = 05; eaCasilla = "036";  |HAZ GrabaLineal;
         enBloque  = 05; eaCasilla = "037";  |HAZ GrabaLineal;
         enBloque  = 05; eaCasilla = "038";  |HAZ GrabaLineal;
         enBloque  = 05; eaCasilla = "039";  |HAZ GrabaLineal;

         enImporte = nIntegra;
         enBloque  = 06; eaCasilla = "040";   |HAZ GrabaLineal;

         |ACABA;
     |FINSI;

     enBloque = 05; eaCasilla = "032"; |HAZ SacaImporte; nValor32 = enImporte;
     |SI nValor32 < 0; nValor32 = 0;  |FINSI;

     aDecla  = #refere1@#2;
     #refere1@#0 = enEmpresa;
     #refere1@#1 = enComplementaria;
     |SI eaModoRenta = "";
         |SI nConta = 1;   #refere1@#2 = "TITULAR   ";  |FINSI;
         |SI nConta = 2;   #refere1@#2 = "CONYUGE   ";  |FINSI;
     |SINO;
         #refere1@#2 = "CONJUNTA  ";
     |FINSI;

     || Datos Renta
     enBloque  = 28; eaCasilla = "370"; |HAZ SacaImporte;  nValor1 = enImporte;
     enBloque  = 28; eaCasilla = "383"; |HAZ SacaImporte;  nValor2 = enImporte;

     #refere1@#0    = enEmpresa;
     #refere1@#1    = enComplementaria;
     #refere1@#2    = aDecla;

     nValor3   = nValor1 - nValor2;
     |SI nValor3 < 0;
         nValor32 = 0;
     |SINO;
         |SI nValor32 > nValor1;
             nValor32 = nValor3;
         |SINO;
             nValor32 = (nValor32 / nValor1) * nValor3;
         |FINSI;
     |FINSI;

     enImporte = nValor32;
     enBloque  = 05; eaCasilla = "032";
     |HAZ GrabaLineal;

     nValor = nValor - nValor32;

     enImporte = nIntegra;
     |SI #datfic2@#7 ! 0;
         enImporte = nIntegra - ((#datfic2@#7 * nIntegra) / nBaseImpo1);
     |FINSI;

     |SI eaModoRenta ! "";  |Y nPasada = 1;
         enBloque  = 05; eaCasilla = "036"; |HAZ SacaImporte;
         |SI #refere1@#2 = "ZPATRITIT ";
             nValorTT   = enImporte;
             enImporte  = enImporte + nIntegraC;
             nValorTTT  = enImporte;
         |FINSI;

         |SI #refere1@#2 = "ZPATRICON ";
             nValorCC  = enImporte;
             enImporte = enImporte + nIntegraT;
             nValorCCC = enImporte;
         |FINSI;
     |FINSI;

     enBloque  = 05; eaCasilla = "036";  |HAZ GrabaLineal;

     |SI #refere1@#2 = "ZPATRITIT ";
         |SI nValor36T ! 0;
             enImporte = nValor36T;
             enBloque  = 05; eaCasilla = "036";  |HAZ GrabaLineal;
         |FINSI;
     |FINSI;

     |SI #refere1@#2 = "ZPATRICON ";
         |SI nValor36C ! 0;
             enImporte = nValor36C;
             enBloque  = 05; eaCasilla = "036";  |HAZ GrabaLineal;
         |FINSI;
     |FINSI;

     enBloque  = 05; eaCasilla = "030"; |HAZ SacaImporte;
     nValor1   = enImporte;

     enBloque  = 05; eaCasilla = "034"; |HAZ SacaImporte;
     nValor2   = enImporte;

     aDecla  = #refere1@#2;

     #refere1@#0 = enEmpresa;
     #refere1@#1 = enComplementaria;
     |SI eaModoRenta = "";
         |SI nConta = 1;   #refere1@#2 = "TITULAR   ";  |FINSI;
         |SI nConta = 2;   #refere1@#2 = "CONYUGE   ";  |FINSI;
     |SINO;
         #refere1@#2 = "CONJUNTA  ";
     |FINSI;

     |SI nValor1 = 0;  |Y nValor2 = 0;
         || Datos Renta
         enBloque  = 27; eaCasilla = "380"; |HAZ SacaImporte;
         nValor1   = enImporte;

         enBloque  = 28; eaCasilla = "395"; |HAZ SacaImporte;
         nValor465 = enImporte;
         nValor1   = nValor1 + enImporte;

         enBloque  = 40; eaCasilla = "490"; |HAZ SacaImporte;
         nValor2   = enImporte;

         enBloque  = 41; eaCasilla = "491"; |HAZ SacaImporte;
         nValor2   = nValor2 + enImporte;

         enBloque  = 40; eaCasilla = "484"; |HAZ SacaImporte;
         nValor696 = enImporte;

         enBloque  = 41; eaCasilla = "485"; |HAZ SacaImporte;
         nValor697 = enImporte;

         nValor35  = ((nValor696 + nValor697) / nValor465) * nValor32;
     |SINO;
         enBloque  = 40; eaCasilla = "484"; |HAZ SacaImporte;
         nValor696 = enImporte;

         enBloque  = 41; eaCasilla = "485"; |HAZ SacaImporte;
         nValor697 = enImporte;

         nValor35  = ((nValor696 + nValor697) / nValor465) * nValor32;
     |FINSI;

     #refere1@#0    = enEmpresa;
     #refere1@#1    = enComplementaria;
     #refere1@#2    = aDecla;

     |SI nValor1 < 0;  nValor1 = 0;  |FINSI;
     |SI nValor2 < 0;  nValor2 = 0;  |FINSI;

     enImporte = nValor1;
     enBloque  = 05; eaCasilla = "030";  |HAZ GrabaLineal;

     enImporte = nValor2;
     enBloque  = 05; eaCasilla = "034";  |HAZ GrabaLineal;

     enImporte = nValor35;
     enBloque  = 05; eaCasilla = "035";  |HAZ GrabaLineal;

     nValor = 0;
     enBloque  = 05; eaCasilla = "030"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque  = 05; eaCasilla = "031"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque  = 05; eaCasilla = "032"; |HAZ SacaImporte; nValor = nValor - enImporte;

     enImporte = nValor % 60;
     enBloque  = 05; eaCasilla = "033";  |HAZ GrabaLineal;

     nValor = 0;
     enBloque  = 05; eaCasilla = "034"; |HAZ SacaImporte; nValor = nValor + enImporte;
     enBloque  = 05; eaCasilla = "035"; |HAZ SacaImporte; nValor = nValor - enImporte;
     enBloque  = 05; eaCasilla = "036"; |HAZ SacaImporte; nValor = nValor + enImporte;

     enImporte = nValor;
     enBloque  = 05; eaCasilla = "037";  |HAZ GrabaLineal;

     nValor1 = 0;
     nValor2 = 0;
     enBloque  = 05; eaCasilla = "033"; |HAZ SacaImporte; nValor1 = enImporte;
     enBloque  = 05; eaCasilla = "037"; |HAZ SacaImporte; nValor2 = enImporte;

     |SI nValor1 ] nValor2;
         enImporte = 0;
         enBloque  = 05; eaCasilla = "038";  |HAZ GrabaLineal;
         enBloque  = 05; eaCasilla = "039";  |HAZ GrabaLineal;

         enImporte = nIntegra;
         enBloque  = 06; eaCasilla = "040";  |HAZ GrabaLineal;
     |SINO;
         |SI eaModoRenta ! "";  |Y nPasada = 1;
             |SI #refere1@#2 = "ZPATRITIT ";
                 nCoefi  = (nValorTT / nValorTTT);
                 enImporte = (nValor2 - nValor1) * nCoefi;
             |FINSI;

             |SI #refere1@#2 = "ZPATRICON ";
                 nCoefi  = (nValorCC / nValorCCC);
                 enImporte = (nValor2 - nValor1) * nCoefi;
             |FINSI;
         |SINO;
             enImporte = nValor2 - nValor1;
         |FINSI;

         enBloque  = 05; eaCasilla = "038";  |HAZ GrabaLineal;
         nMenor    = enImporte;
         enImporte = nIntegra % 80;
         enBloque  = 05; eaCasilla = "039";  |HAZ GrabaLineal;
         |SI enImporte < nMenor; nMenor = enImporte;  |FINSI;

         nValor    = nIntegra - nMenor;
         enImporte = nValor;
         enBloque  = 06; eaCasilla = "040";  |HAZ GrabaLineal;
     |FINSI;

     |SI #refere1@#2 = "ZPATRITIT ";  |Y nValor38T ! 0;
         enImporte = nValor38T;
         enBloque  = 05; eaCasilla = "038";  |HAZ GrabaLineal;

         enImporte = nIntegra % 80;
         enBloque  = 05; eaCasilla = "039";  |HAZ GrabaLineal;

         nValor    = nValor38T;
         |SI nValor > enImporte;  nValor = enImporte;  |FINSI;

         enImporte = nIntegra - nValor;
         enBloque  = 06; eaCasilla = "040";  |HAZ GrabaLineal;
     |FINSI;

     |SI #refere1@#2 = "ZPATRICON ";  |Y nValor38C ! 0;
         enImporte = nValor38C;
         enBloque  = 05; eaCasilla = "038";  |HAZ GrabaLineal;

         enImporte = nIntegra % 80;
         enBloque  = 05; eaCasilla = "039";  |HAZ GrabaLineal;

         nValor    = nValor38C;
         |SI nValor > enImporte;  nValor = enImporte;  |FINSI;

         enImporte = nIntegra - nValor;
         enBloque  = 06; eaCasilla = "040";  |HAZ GrabaLineal;
     |FINSI;
|FPRC;

|PROCESO SeleccionaExtranjero;
     nCoefi = 0;
     |SI #datfic3@#3 = "GANANCIAL ";                || Si es Ganancial
         nCoefi = 50;
     |FINSI;

     |SI #datfic3@#3 ! "VARIOS    ";                || SI es TITULAR O CONYUGE;
         |SI #datfic3@#3 = "TITULAR   "; |Y #refere1@#2 = "ZPATRITIT ";
             nCoefi = 100;
         |FINSI;
         |SI #datfic0@#3 = "CONYUGE   "; |Y #refere1@#2 = "ZPATRICON ";
             nCoefi = 100;
         |FINSI;
     |FINSI;

     |SI #datfic3@#20 ! 0;  |Y #refere1@#2 = "ZPATRITIT ";
         nCoefi = #datfic3@#20;
     |FINSI;

     |SI #datfic3@#21 ! 0;  |Y #refere1@#2 = "ZPATRICON ";
         nCoefi = #datfic3@#21;
     |FINSI;

     |SI nCoefi = 0;  |ACABA;  |FINSI;

     enSwAcum    = 1;

     nValorV1 = ((nValor27 * (#datfic3@#14 % nCoefi)) / nBaseImpo1) ! 2;
     nValorI1 = (nValorV1 % nValorTM) ! 2;

     enImporte = (#datfic3@#10 % nCoefi) ! 2;
     enBloque    = 07; eaCasilla = "b  ";  |HAZ GrabaLineal;

     enImporte   = nValorV1;
     enBloque    = 07; eaCasilla = "041";  |HAZ GrabaLineal;

     enImporte = (#datfic3@#10 % nCoefi) ! 2;
     |SI enImporte > nValorI1;
         enImporte = nValorI1;
     |FINSI;
     enBloque    = 07; eaCasilla = "041";  |HAZ GrabaLineal;
     nDeduccion  = nDeduccion + enImporte;
|FPRC;

|PROCESO Extranjeros;
     nDeduccion = 0;
     nValor     = 0;
     enBloque   = 07; eaCasilla = "041"; |HAZ SacaImporte;  nValor = enImporte;
     enBloque   = 07; eaCasilla = "b  "; |HAZ SacaImporte;  nValor = nValor + enImporte;

     |SI nValor = 0;
         enImporte  = 0;
         enBloque   = 07; eaCasilla = "a  ";  |HAZ GrabaLineal;

         |ACABA;
     |FINSI;

     enSwAcum    = 0;
     enImporte   = 0;
     enBloque    = 07; eaCasilla = "b  ";  |HAZ GrabaLineal;
     enBloque    = 07; eaCasilla = "041";  |HAZ GrabaLineal;

     aDef    = eaPathDef + "rem00099.mas";
     |CARGA_DEF aDef, datfic3@;

     |ABRE #datfic3@;
     |DDEFECTO #datfic3@;
     #datfic3@#0 = enEmpresa;
     #datfic3@#1 = "V2";
     #datfic3@#2 = 1;
     |LEE 000#datfic3@.=;
     |PARA; |SI FSalida = 0;  |Y #datfic3@#0 = enEmpresa;  |Y #datfic3@#1 = "V2";  |HACIENDO;
            |HAZ SeleccionaExtranjero;
            |LEE 000#datfic3@.s;
     |SIGUE;
     |CIERRA #datfic3@;

     |DESCARGA_DEF #datfic3@;

     enSwAcum = 0;
|FPRC;

|PROCESO CuotaMinorada;
     nTotalCuota = enImporte;
     enImporte   = ((nTotalCuota / nBaseImpo2) * 100) ! 2;
     enBloque    = 07; eaCasilla = "a  ";  |HAZ GrabaLineal;
     nValorTM    = enImporte;

     |HAZ Extranjeros;

     enBloque    = 08; eaCasilla = "042"; |HAZ SacaImporte;
     enImporte   = (enImporte / nBaseImpo1) * nTotalCuota;
     enBloque    = 08; eaCasilla = "043";  |HAZ GrabaLineal;

     enImporte   = (enImporte % 75) ! 2;
     nLimite     = (nTotalCuota % 75) ! 2;
     |SI enImporte > nLimite;  enImporte = nLimite;  |FINSI;
     enBloque    = 08; eaCasilla = "044";  |HAZ GrabaLineal;

     enImporte   = nTotalCuota - nDeduccion - enImporte;
     enBloque    = 09; eaCasilla = "045";  |HAZ GrabaLineal;
     nCuotaMino  = enImporte;
|FPRC;

|PROCESO CuotaAIngresar;
     enBloque = 10; eaCasilla = "050"; |HAZ SacaImporte; nValor = enImporte;
     enBloque = 09; eaCasilla = "045"; |HAZ SacaImporte;

     |SI #datfic0@#94 ! "S";
         |SI nValor > enImporte;
             enBloque  = 10;
             eaCasilla = "050";     || Recoge la 50 el mismo valor que la 95
             |HAZ GrabaLineal;
         |FINSI;
     |FINSI;

     |SI #rew99999#7 = 12;
         enBloque  = 10;
         eaCasilla = "050";     || Recoge la 50 el mismo valor que la 95
         |HAZ GrabaLineal;
     |FINSI;

     |SI #rew99999#7 = 16;
         enImporte = enImporte / 2;
         enBloque  = 10;
         eaCasilla = "050";     || Recoge la 50 el 50% de la la 95
         |HAZ GrabaLineal;
     |FINSI;

     nObligado = 0
     enBloque  = 1; eaCasilla = "023"; |HAZ SacaImporte; nObligado = nObligado + enImporte;
     enBloque  = 2; eaCasilla = "061"; |HAZ SacaImporte; nObligado = nObligado + enImporte;
     enBloque  = 2; eaCasilla = "004"; |HAZ SacaImporte; nObligado = nObligado + enImporte;
     enBloque  = 2; eaCasilla = "012"; |HAZ SacaImporte; nObligado = nObligado + enImporte;
     enBloque  = 2; eaCasilla = "013"; |HAZ SacaImporte; nObligado = nObligado + enImporte;

     nValor   = 0;
     enBloque = 09; eaCasilla = "045"; |HAZ SacaImporte; nValor = enImporte;
     enBloque = 10; eaCasilla = "050"; |HAZ SacaImporte; nValor = nValor - enImporte;

     enImporte = nValor;
     enBloque  = 11; eaCasilla = "055";  |HAZ GrabaLineal;

     #refere1@#4  = "N";
     #refere1@#36 = "";
     |SI enImporte > 0;  |O nObligado > 2000000;
         #refere1@#3  = enImporte;
         #refere1@#4  = "S";
         #refere1@#5  = "714";
         #refere1@#36 = "0,0,0;81,222,62";
     |FINSI;
|FPRC;

|PROCESO CalculaPatrim;
     aDef    = eaPathDef + "rem00100.mas";
     |CARGA_DEF aDef, datfic0@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def " + aDef;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     aDef    = eaPathDef + "retabla3.mas";
     |CARGA_DEF aDef, datfic1@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def " + aDef;
         |MENAV aAlfa;
         |DESCARGA_DEF #datfic0@;
         |ACABA;
     |FINSI;

     aDef    = eaPathDef + "rem01044.mas";
     |CARGA_DEF aDef, datfic2@;
     |SI FSalida ! 0;
         aAlfa = "     Error en cargar el Def " + aDef;
         |MENAV aAlfa;
         |DESCARGA_DEF #datfic1@;
         |DESCARGA_DEF #datfic0@;
         |ACABA;
     |FINSI;

     |SI enNomeDat = 1;  |NOME_DAT #datfic2@#"zdat1044"#;  |FINSI;

     |ABRE #datfic0@;
     #datfic0@#0 = #refere1@#0;
     |LEE 040#datfic0@.=;
     |SI FSalida ! 0;  |DDEFECTO #datfic0@;  |FINSI;
     |CIERRA #datfic0@;

     |ABRE #datfic1@;
     #datfic1@#0 = #rew99999#7;
     |LEE 000#datfic1@.=;
     |SI FSalida ! 0;
         #datfic1@#0 = 0;
         |LEE 000#datfic1@.=;
         |SI FSalida ! 0;   |DDEFECTO #datfic1@;   |FINSI;
     |FINSI;
     |CIERRA #datfic1@;

     |ABRE #datfic2@;
     #datfic2@#0 = #refere1@#0;
     #datfic2@#1 = #refere1@#1;
     #datfic2@#2 = #refere1@#2;
     |LEE 040#datfic2@.=;
     |SI FSalida ! 0;  |DDEFECTO #datfic2@;  |FINSI;
     |CIERRA #datfic2@;

     |HAZ BienesYDerechos;
     |HAZ CuotaIntegra;
     |HAZ LimiteCuota;
     |HAZ CuotaMinorada;
     |HAZ CuotaAIngresar;

     |DESCARGA_DEF #datfic2@;
     |DESCARGA_DEF #datfic1@;
     |DESCARGA_DEF #datfic0@;
|FPRC;

|PROCESO CalculaPatrimonio;
     nValor36T = 0;
     nValor36C = 0;
     nValor38T = 0;
     nValor38C = 0;
     nIntegraT = 0;
     nIntegraC = 0;
     nValorTT  = 0;
     nValorTTT = 0;
     nValorCC  = 0;
     nValorCCC = 0;
     nValor28  = 0;

     |HAZ Patrimonio;

     nPasada = 0;
     |DDEFECTO #refere1@;
     FSalida = 0;
     #refere1@#0 = enEmpresa;
     #refere1@#1 = enComplementaria;
     |PARA nConta = 1;  |SI nConta [ 2;  |HACIENDO nConta = nConta + 1;
            |SI nConta = 1;   #refere1@#2 = "ZPATRITIT ";  |FINSI;
            |SI nConta = 2;   #refere1@#2 = "ZPATRICON ";  |FINSI;
            |LEE 101#refere1@.=;
            |SI FSalida = 0;
                |SI nConta = 1;  |Y eaMuerto = "T";
                    |LIBERA #refere1@;

                    eaLiquida = #refere1@#2;
                    |HAZ BorraLiquidacion;
                    eaLiquida = "";
                |FINSI;

                |SI nConta = 2;  |Y eaMuerto = "C";
                    |LIBERA #refere1@;

                    eaLiquida = #refere1@#2;
                    |HAZ BorraLiquidacion;
                    eaLiquida = "";
                |FINSI;

                |SI eaMuerto = "";
                    |HAZ CalculaPatrim;
                    |GRABA 020#refere1@.a;
                |SINO;
                    |SI nConta = 1;  |Y eaMuerto = "C";
                        |HAZ CalculaPatrim;
                        |GRABA 020#refere1@.a;
                    |FINSI;

                    |SI nConta = 2;  |Y eaMuerto = "T";
                        |HAZ CalculaPatrim;
                        |GRABA 020#refere1@.a;
                    |FINSI;
                |FINSI;

                |LIBERA #refere1@;
            |FINSI;
     |SIGUE;

     nPasada = 1;
     |SI eaModoRenta ! "";
         |DDEFECTO #refere1@;
         FSalida = 0;
         #refere1@#0 = enEmpresa;
         #refere1@#1 = enComplementaria;
         |PARA nConta = 1;  |SI nConta [ 2;  |HACIENDO nConta = nConta + 1;
                |SI nConta = 1;   #refere1@#2 = "ZPATRITIT ";  |FINSI;
                |SI nConta = 2;   #refere1@#2 = "ZPATRICON ";  |FINSI;
                |LEE 101#refere1@.=;
                |SI FSalida = 0;
                    |SI eaMuerto = "";
                        |HAZ CalculaPatrim;
                        |GRABA 020#refere1@.a;
                    |FINSI;
                    |LIBERA #refere1@;
                |FINSI;
         |SIGUE;
     |FINSI;
|FPRC;
