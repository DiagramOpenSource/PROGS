|FICHEROS;
     siiz0021;

     siim0001;
     siim0002;
     siim0003;
     siim0004;
     siim0007;
     siim0008;

     siiw0201;
     siiw0202;

     trabajo@;
|FIN;

|VARIABLES;
     n0Vent              = 0;
     n1Vent              = 0;
     nIdSalir            = 0;
     nOk                 = 0;
     nEje                = 0;
     nPer                = 0;
     nAnyo               = 0;
     nDAnyo              = 0;
     nHAnyo              = 0;
     nID                 = 0;
     nBtnVal             = -1;
     nBt                 = 0;
     nReg                = 0;
     nGrupo              = 0;
     nSubGrupo           = 0;
     nConta              = 0;
     nCmp                = 0;
     nCmp1               = 0;
     nCmp2               = 0;
     nHay201             = 0;
     nHay202             = 0;
     nPro                = 0;
     nActiv              = 0;
     nHandle             = 0;

     aID                 = "";
     aQB                 = "";
     aAlfa               = "";
     aAlfa1              = "";
     aAlfa2              = "";
     aPer                = "";
     aBaseSII            = "";
     aPathTmp            = "";
     aPathSII            = "";
     aFicTmp             = "";
     aFicCSV             = "";
     aClvPais            = "";
     aPais               = "";
     aIdenPais           = "";
     aISP                = "";
     aNom                = "";
     aDesglo             = "";
     aFact               = "";
     aH60                = "";
     aHora               = "";
     aAbre               = "";
     aOri                = "";
     aDes                = "";
     aIP                 = "";
     aDef                = "";
     aMas                = "";
     aMes                = "";

     fFechaSys           = @;

     {20}aPopup          = "";
     {2}nNivel           = 0;

     {-1}aVent           = "";
         aVent1          = 0;
         aVent2          = 0;
         aVent3          = 0;
         aVent4          = 0;
         aVent5          = "";

     &eaSiiPro           = "";
     &enSiiLib           = 0;
     &enSiiDoc           = 0;
     &enEmp              = 0;
     &enLot              = 0;
     &enLotFor           = 0;
     &eaTip              = "";
     &enEje              = 0;
     &enPer              = 0;
     &eaNomNif           = "";
     &eaPaisNif          = "";
     &eaCodNif           = "";
     &enAccPNT           = 0;
     &enEmpPNT           = 0;
     &enErrPNT           = 0;
     &eaUnidadBasico     = "";
|FIN;

|PROCESO AbreVtn0;
     |VENTANA 0501, 1855, -1, 16, "Exportaci¢n CSV";
     n0Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n0Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;
|FPRC;

|PROCESO CierraVtn0;
     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n0Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n0Vent;
|FPRC;

|PROCESO AbreVtn1;
     |VENTANA 0501, 1040, -1, 16, "Realizando la exportaci¢n";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;
|FPRC;

|PROCESO CierraVtn1;
     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;
|FPRC;

|PROCESO siim0007;
     nCmp = nCmp + 1;  #siiw0201#nCmp# = #siim0007#3;
     nCmp = nCmp + 1;  #siiw0201#nCmp# = #siim0007#4;

     |SI nCmp ] 120;
         |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE siim0007;
     #siim0007#1;
     ;
     #siim0003#0, #siim0003#1, #siim0003#2, "";
     #siim0003#0, #siim0003#1, #siim0003#2, aH60;
     ;
     NULL, siim0007;
|FIN;

|PROCESO siim0003Tra;
     |SI #trabajo@#111 = "S";
         nOk = 0;
         |ACABA;
     |FINSI;

     |SI #siim0003#1 > #trabajo@#1;
         nOk = 0;
         |ERROR10;
         |ACABA;
     |FINSI;

     nOk = 1;
|FPRC;

|DEFBUCLE siim0003Tra;
     #trabajo@#2004;
     15, 21;
     #siim0003#0, #siim0003#19, 0000000000, 000001, #siim0003#15, #siim0003#21;
     #siim0003#0, #siim0003#19, 9999999999, 999999, #siim0003#15, #siim0003#21;
     ;
     NULL, siim0003Tra;
|FIN;

|PROCESO siim0003Fac;
     #siim0002#0 = #siim0003#0;
     #siim0002#1 = #siim0003#1;
     |LEE 000#siim0002.=;

     nOk = 0;

     |SI #siiz0021#0 = "1";
         |SI #siim0002#2 = "11";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "12";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "15";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiz0021#0 = "2";
         |SI #siim0002#2 = "21";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "22";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "25";  nOk = 1;  |FINSI;
     |FINSI;

     |SI nOk = 0;  |ACABA;  |FINSI;

     |SI #siiz0021#1 = "S";
         |SI #siim0002#4 ! #siiz0021#2;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI #siiz0021#3 = "S";
         aAlfa1 = (("00" + #siim0002#5) % -102) + #siim0002#21;
         aAlfa = #siiz0021#4 % -101;
         |SI aAlfa ! "T";
             aAlfa2 = #siiz0021#4 + "M";
         |SINO;
             aAlfa2 = "0" + #siiz0021#4;
         |FINSI;

         |SI aAlfa1 ! aAlfa2;
             |ACABA;
         |FINSI;
     |FINSI;

     #siim0001#0 = #siim0002#0;
     |LEE 000#siim0001.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aPer = ("00" + #siim0002#5) % -102;
     |SI #siim0002#21 = "T";
         aPer = #siim0002#5 + #siim0002#21;
     |FINSI;

     nOk = 1;
     |BUCLE siim0003Tra;
     |SI nOk = 0;  |ACABA;  |FINSI;

     nReg = nReg + 1;

     #siiw0201#0   = nReg;
     #siiw0201#1   = #siim0001#2;
     #siiw0201#2   = #siim0003#3;
     #siiw0201#3   = aPer;
     #siiw0201#4   = "E";
     #siiw0201#5   = #siim0003#19;
     #siiw0201#6   = #siim0003#21;
     #siiw0201#7   = #siim0003#22;
     #siiw0201#8   = #siim0003#5;
     #siiw0201#9   = #siim0003#15;
     #siiw0201#10  = #siim0003#16;
     #siiw0201#11  = #siim0003#17;
     #siiw0201#12  = #siim0003#18;
     #siiw0201#13  = #siim0003#6;
     #siiw0201#14  = #siim0003#7;
     #siiw0201#15  = #siim0003#8;
     #siiw0201#16  = #siim0003#9;
     #siiw0201#17  = #siim0003#20;
     #siiw0201#18  = #siim0003#13 % 101;
     #siiw0201#19  = #siim0003#14 % 102;
     #siiw0201#20  = #siim0003#23;
     #siiw0201#21  = #siim0003#24;
     #siiw0201#22  = #siim0003#25;
     #siiw0201#23  = #siim0003#26;
     #siiw0201#24  = #siim0003#27;
     #siiw0201#25  = #siim0003#13 % 201;
     #siiw0201#26  = #siim0003#14 % 302;
     #siiw0201#27  = #siim0003#29;
     #siiw0201#28  = #siim0003#30;
     #siiw0201#29  = #siim0003#31;
     #siiw0201#30  = #siim0003#32;
     #siiw0201#31  = #siim0003#33;
     #siiw0201#32  = #siim0003#13 % 301;
     #siiw0201#33  = #siim0003#14 % 502;
     #siiw0201#34  = #siim0003#35;
     #siiw0201#35  = #siim0003#36;
     #siiw0201#36  = #siim0003#37;
     #siiw0201#37  = #siim0003#38;
     #siiw0201#38  = #siim0003#39;
     #siiw0201#39  = #siim0003#13 % 401;
     #siiw0201#40  = #siim0003#14 % 702;
     #siiw0201#41  = #siim0003#41;
     #siiw0201#42  = #siim0003#42;
     #siiw0201#43  = #siim0003#43;
     #siiw0201#44  = #siim0003#44;
     #siiw0201#45  = #siim0003#45;
     #siiw0201#46  = #siim0003#13 % 501;
     #siiw0201#47  = #siim0003#14 % 902;
     #siiw0201#48  = #siim0003#47;
     #siiw0201#49  = #siim0003#48;
     #siiw0201#50  = #siim0003#49;
     #siiw0201#51  = #siim0003#50;
     #siiw0201#52  = #siim0003#51;
     #siiw0201#53  = #siim0003#13 % 601;
     #siiw0201#54  = #siim0003#14 % 1102;
     #siiw0201#55  = #siim0003#53;
     #siiw0201#56  = #siim0003#54;
     #siiw0201#57  = #siim0003#55;
     #siiw0201#58  = #siim0003#56;
     #siiw0201#59  = #siim0003#57;
     #siiw0201#60  = #siim0003#59;
     #siiw0201#61  = #siim0003#62 + #siim0003#63 + #siim0003#64;
     #siiw0201#62  = #siim0003#65;
     #siiw0201#63  = #siim0003#66;
     #siiw0201#64  = #siim0003#67;
     #siiw0201#65  = #siim0003#68;
     #siiw0201#66  = #siim0003#69;
     #siiw0201#67  = #siim0003#70;
     #siiw0201#68  = #siim0003#71;
     #siiw0201#69  = #siim0003#72;
     #siiw0201#70  = #siim0003#73;
     #siiw0201#71  = #siim0003#74;
     #siiw0201#72  = #siim0003#75;
     #siiw0201#73  = #siim0003#76;
     #siiw0201#74  = #siim0003#77;
     #siiw0201#75  = #siim0003#78;
     #siiw0201#76  = #siim0003#79;
     #siiw0201#77  = #siim0003#80;
     #siiw0201#78  = #siim0003#81;
     #siiw0201#79  = #siim0003#82;
     #siiw0201#80  = #siim0003#83;
     #siiw0201#81  = #siim0003#84;
     #siiw0201#82  = #siim0003#85;
     #siiw0201#83  = #siim0003#86;
     #siiw0201#84  = #siim0003#87;
     #siiw0201#85  = #siim0003#88;
     #siiw0201#86  = #siim0003#89;
     #siiw0201#87  = #siim0003#90;
     #siiw0201#88  = #siim0003#91;
     #siiw0201#89  = #siim0003#92;
     #siiw0201#90  = #siim0003#93;
     #siiw0201#91  = #siim0003#94;
     #siiw0201#92  = #siim0003#95;
     #siiw0201#93  = #siim0003#96;
     #siiw0201#94  = #siim0003#97;
     #siiw0201#95  = #siim0003#98;
     #siiw0201#96  = #siim0003#99;
     #siiw0201#97  = #siim0003#61;
     #siiw0201#98  = #siim0003#60;
     #siiw0201#99  = #siim0003#10;
     #siiw0201#100 = #siim0003#11;
     #siiw0201#101 = #siim0003#12;

     nCmp = 101;
     |BUCLE siim0007;

     #siiw0201#122 = #siim0003#112;
     #siiw0201#123 = #siim0003#113;
     #siiw0201#124 = #siim0003#115;
     #siiw0201#125 = #siim0003#116;
     #siiw0201#126 = #siim0003#117;
     #siiw0201#127 = #siim0003#114;

     |GRABA 020#siiw0201.n;
     |LIBERA #siiw0201;
|FPRC;

|DEFBUCLE siim0003Fac;
     #siim0003#2;
     ;
     00000,   "", 0000000000, 000001;
     99999, aH60, 9999999999, 999999;
     ;
     NULL, siim0003Fac;
|FIN;

|PROCESO siim0008;
     nCmp = nCmp + 1;  #siiw0202#nCmp# = #siim0008#3;
     nCmp = nCmp + 1;  #siiw0202#nCmp# = #siim0008#4;

     |SI nCmp ] 85;
         |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE siim0008;
     #siim0008#1;
     ;
     #siim0004#0, #siim0004#1, #siim0004#2, "";
     #siim0004#0, #siim0004#1, #siim0004#2, aH60;
     ;
     NULL, siim0008;
|FIN;

|PROCESO siim0004Tra;
     |SI #trabajo@#86 = "S";
         nOk = 0;
         |ACABA;
     |FINSI;

     |SI #siim0004#1 > #trabajo@#1;
         nOk = 0;
         |ERROR10;
         |ACABA;
     |FINSI;

     nOk = 1;
|FPRC;

|DEFBUCLE siim0004Tra;
     #trabajo@#2005;
     16;
     #siim0004#0, #siim0004#10, #siim0004#14, 0000000000, 000001, #siim0004#16;
     #siim0004#0, #siim0004#10, #siim0004#14, 9999999999, 999999, #siim0004#16;
     ;
     NULL, siim0004Tra;
|FIN;

|PROCESO siim0004Fac;
     #siim0002#0 = #siim0004#0;
     #siim0002#1 = #siim0004#1;
     |LEE 000#siim0002.=;

     nOk = 0;

     |SI #siiz0021#0 = "1";
         |SI #siim0002#2 = "11";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "12";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "15";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiz0021#0 = "2";
         |SI #siim0002#2 = "21";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "22";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "25";  nOk = 1;  |FINSI;
     |FINSI;

     |SI nOk = 0;  |ACABA;  |FINSI;

     |SI #siiz0021#1 = "S";
         |SI #siim0002#4 ! #siiz0021#2;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI #siiz0021#3 = "S";
         aAlfa1 = (("00" + #siim0002#5) % -102) + #siim0002#21;
         aAlfa = #siiz0021#4 % -101;
         |SI aAlfa ! "T";
             aAlfa2 = #siiz0021#4 + "M";
         |SINO;
             aAlfa2 = "0" + #siiz0021#4;
         |FINSI;

         |SI aAlfa1 ! aAlfa2;
             |ACABA;
         |FINSI;
     |FINSI;

     #siim0001#0 = #siim0002#0;
     |LEE 000#siim0001.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aPer = ("00" + #siim0002#5) % -102;
     |SI #siim0002#21 = "T";
         aPer = #siim0002#5 + #siim0002#21;
     |FINSI;

     nOk = 1;
     |BUCLE siim0004Tra;
     |SI nOk = 0;  |ACABA;  |FINSI;

     nReg = nReg + 1;

     #siiw0202#0   = nReg;
     #siiw0202#1   = #siim0001#2;
     #siiw0202#2   = #siim0004#3;
     #siiw0202#3   = aPer;
     #siiw0202#4   = "R";
     #siiw0202#5   = #siim0004#14;
     #siiw0202#6   = #siim0004#16;
     #siiw0202#7   = #siim0004#18;
     #siiw0202#8   = #siim0004#17;
     #siiw0202#9   = #siim0004#5;
     #siiw0202#10  = #siim0004#10;
     #siiw0202#11  = #siim0004#11;
     #siiw0202#12  = #siim0004#12;
     #siiw0202#13  = #siim0004#13;
     #siiw0202#14  = #siim0004#6;
     #siiw0202#15  = #siim0004#7;
     #siiw0202#16  = #siim0004#8;
     #siiw0202#17  = #siim0004#9;
     #siiw0202#18  = #siim0004#15;
     #siiw0202#19  = #siim0004#19;
     #siiw0202#20  = #siim0004#20;
     #siiw0202#21  = #siim0004#21;
     #siiw0202#22  = #siim0004#22;
     #siiw0202#23  = #siim0004#23;
     #siiw0202#24  = #siim0004#24;
     #siiw0202#25  = #siim0004#26;
     #siiw0202#26  = #siim0004#27;
     #siiw0202#27  = #siim0004#28;
     #siiw0202#28  = #siim0004#29;
     #siiw0202#29  = #siim0004#30;
     #siiw0202#30  = #siim0004#31;
     #siiw0202#31  = #siim0004#33;
     #siiw0202#32  = #siim0004#34;
     #siiw0202#33  = #siim0004#35;
     #siiw0202#34  = #siim0004#36;
     #siiw0202#35  = #siim0004#37;
     #siiw0202#36  = #siim0004#38;
     #siiw0202#37  = #siim0004#40;
     #siiw0202#38  = #siim0004#41;
     #siiw0202#39  = #siim0004#42;
     #siiw0202#40  = #siim0004#43;
     #siiw0202#41  = #siim0004#44;
     #siiw0202#42  = #siim0004#45;
     #siiw0202#43  = #siim0004#47;
     #siiw0202#44  = #siim0004#48;
     #siiw0202#45  = #siim0004#49;
     #siiw0202#46  = #siim0004#50;
     #siiw0202#47  = #siim0004#51;
     #siiw0202#48  = #siim0004#52;
     #siiw0202#49  = #siim0004#54;
     #siiw0202#50  = #siim0004#55;
     #siiw0202#51  = #siim0004#56;
     #siiw0202#52  = #siim0004#57;
     #siiw0202#53  = #siim0004#58;
     #siiw0202#54  = #siim0004#59;
     #siiw0202#55  = #siim0004#61;
     #siiw0202#56  = #siim0004#62;
     #siiw0202#57  = #siim0004#63;
     #siiw0202#58  = #siim0004#64;
     #siiw0202#59  = #siim0004#65;
     #siiw0202#60  = #siim0004#67 + #siim0004#68 + #siim0004#69;
     #siiw0202#61  = #siim0004#70;
     #siiw0202#62  = #siim0004#71;
     #siiw0202#63  = #siim0004#72;
     #siiw0202#64  = #siim0004#73;
     #siiw0202#65  = #siim0004#74;
     #siiw0202#66  = #siim0004#66;

     nCmp = 66;
     |BUCLE siim0008;

     #siiw0202#87  = #siim0004#87;
     #siiw0202#88  = #siim0004#89;
     #siiw0202#89  = #siim0004#90;
     #siiw0202#90  = #siim0004#91;
     #siiw0202#91  = #siim0004#88;

     |GRABA 020#siiw0202.n;
     |LIBERA #siiw0202;
|FPRC;

|DEFBUCLE siim0004Fac;
     #siim0004#2;
     ;
     00000,            "",    "", 0000000000, 000001;
     99999, "zzzzzzzzzzzz", aH60, 9999999999, 999999;
     ;
     NULL, siim0004Fac;
|FIN;

|PROCESO siiw0201;
     |PARA nCmp = 1;  |SI nCmp [ 127;  |HACIENDO nCmp = nCmp + 1;
           aAlfa = #siiw0201#nCmp#;  |QBF aAlfa;

           |SI aAlfa = "01.01.0000";
               aAlfa = "";
           |FINSI;

           |SI nCmp ! 127;
               aAlfa = aAlfa + ";";
           |FINSI;
           |XGRABA nHandle, aAlfa;
     |SIGUE;

     aAlfa = &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|DEFBUCLE siiw0201;
     #siiw0201#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siiw0201;
|FIN;

|PROCESO Exporta201;
     aFicTmp = "siiw0201" + Usuario;  |NOME_DAT #siiw0201#aFicTmp#;
     |ABRE #siiw0201;  |CIERRA #siiw0201;  |DELINDEX #siiw0201;

     |DDEF aDef;
     aMas = aDef + "siim0003.mas";
     |CARGA_DEF aMas, trabajo@;

     |ABRET #siiw0201;
     |BUCLE siim0003Fac;

     |DESCARGA_DEF #trabajo@;

     |LEE 000#siiw0201.p;
     |SI FSalida ! 0;
         |MENAV "0000No hay registros a exportar";
         |CIERRAT #siiw0201;
         |DELINDEX #siiw0201;
         |ACABA;
     |FINSI;

     |HORA aHora;

     aFicCSV = fFechaSys % -104;
     aFicCSV = aFicCSV + fFechaSys % 402;
     aFicCSV = aFicCSV + fFechaSys % 102;
     aFicCSV = aFicCSV + aHora % 102;
     aFicCSV = aFicCSV + aHora % 402;
     aFicCSV = aFicCSV + aHora % 702;
     aFicCSV = aFicCSV + ".csv";

     aAbre   = aPathTmp + aFicCSV;

     |XABRE "WB", aAbre, nHandle;
     |BUCLE siiw0201;
     |XCIERRA nHandle;

     |CIERRAT #siiw0201;
     |DELINDEX #siiw0201;

     aOri = aPathTmp + aFicCSV;
     aDes = aPathSII + aFicCSV;
     |SI aIP = "";
         |COPIA_FICHERO aOri, aDes;
     |SINO;
         |ENVIA_FICHERO aOri, aDes;
     |FINSI;

     |XABRE "EC", aDes, 0;
     |SI FSalida ] 0;
         aAlfa = "0000El CSV exportado se ubica y se denomina " + aDes;
         |MENAV aAlfa;
     |SINO;
         |MENAV "0000Problemas al crear el CSV, int‚ntelo de nuevo.";
     |FINSI;
|FPRC;

|PROCESO siiw0202;
     |PARA nCmp = 1;  |SI nCmp [ 91;  |HACIENDO nCmp = nCmp + 1;
           aAlfa = #siiw0202#nCmp#;  |QBF aAlfa;

           |SI aAlfa = "01.01.0000";
               aAlfa = "";
           |FINSI;

           |SI nCmp ! 91;
               aAlfa = aAlfa + ";";
           |FINSI;
           |XGRABA nHandle, aAlfa;
     |SIGUE;

     aAlfa = &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|DEFBUCLE siiw0202;
     #siiw0202#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siiw0202;
|FIN;

|PROCESO Exporta202;
     aFicTmp = "siiw0202" + Usuario;  |NOME_DAT #siiw0202#aFicTmp#;
     |ABRE #siiw0202;  |CIERRA #siiw0202;  |DELINDEX #siiw0202;

     |DDEF aDef;
     aMas = aDef + "siim0004.mas";
     |CARGA_DEF aMas, trabajo@;

     |ABRET #siiw0202;
     |BUCLE siim0004Fac;

     |DESCARGA_DEF #trabajo@;

     |LEE 000#siiw0202.p;
     |SI FSalida ! 0;
         |MENAV "0000No hay registros a exportar";
         |CIERRAT #siiw0202;
         |DELINDEX #siiw0202;
         |ACABA;
     |FINSI;

     |HORA aHora;

     aFicCSV = fFechaSys % -104;
     aFicCSV = aFicCSV + fFechaSys % 402;
     aFicCSV = aFicCSV + fFechaSys % 102;
     aFicCSV = aFicCSV + aHora % 102;
     aFicCSV = aFicCSV + aHora % 402;
     aFicCSV = aFicCSV + aHora % 702;
     aFicCSV = aFicCSV + ".csv";

     aAbre   = aPathTmp + aFicCSV;

     |XABRE "WB", aAbre, nHandle;
     |BUCLE siiw0202;
     |XCIERRA nHandle;

     |CIERRAT #siiw0202;
     |DELINDEX #siiw0202;

     aOri = aPathTmp + aFicCSV;
     aDes = aPathSII + aFicCSV;
     |SI aIP = "";
         |COPIA_FICHERO aOri, aDes;
     |SINO;
         |ENVIA_FICHERO aOri, aDes;
     |FINSI;

     |XABRE "EC", aDes, 0;
     |SI FSalida ] 0;
         aAlfa = "0000El CSV exportado se ubica y se denomina " + aDes;
         |MENAV aAlfa;
     |SINO;
         |MENAV "0000Problemas al crear el CSV, int‚ntelo de nuevo.";
     |FINSI;
|FPRC;

|PROCESO Exporta;
     |CONFI "0000NSeguro que quiere realizar la exportaci¢n en estos momentos";
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     |HAZ AbreVtn1;

     nReg = 0;

     |SI #siiz0021#0 = "1";
         |HAZ Exporta201;
     |FINSI;

     |SI #siiz0021#0 = "2";
         |HAZ Exporta202;
     |FINSI;

     |HAZ CierraVtn1;
|FPRC;

|PROCESO T12;  |TIPO 12;
     |SI FSalida = 7;
         |HAZ CierraVtn0;
         |ACABA;
     |FINSI;

     |SI FSalida ! 1;
         |ERROR;

         |POSICIONATE #siiz0021#0;
         |ACABA;
     |FINSI;

     |HAZ CierraVtn0;
     |HAZ Exporta;
|FPRC;

|PROCESO T0C4;  |TIPO 0;
     |SI #siiz0021#3 = "N";
         |ACABA;
     |FINSI;

                              aMes = "";
     |SI #siiz0021#4 = "01";  aMes = "ENERO";       |FINSI;
     |SI #siiz0021#4 = "02";  aMes = "FEBRERO";     |FINSI;
     |SI #siiz0021#4 = "03";  aMes = "MARZO";       |FINSI;
     |SI #siiz0021#4 = "04";  aMes = "ABRIL";       |FINSI;
     |SI #siiz0021#4 = "05";  aMes = "MAYO";        |FINSI;
     |SI #siiz0021#4 = "06";  aMes = "JUNIO";       |FINSI;
     |SI #siiz0021#4 = "07";  aMes = "JULIO";       |FINSI;
     |SI #siiz0021#4 = "08";  aMes = "AGOSTO";      |FINSI;
     |SI #siiz0021#4 = "09";  aMes = "SEPTIEMBRE";  |FINSI;
     |SI #siiz0021#4 = "10";  aMes = "OCTUBRE";     |FINSI;
     |SI #siiz0021#4 = "11";  aMes = "NOVIEMBRE";   |FINSI;
     |SI #siiz0021#4 = "12";  aMes = "DICIEMBRE";   |FINSI;
     |SI #siiz0021#4 = "1T";  aMes = "1 TRIMSTRE";  |FINSI;
     |SI #siiz0021#4 = "2T";  aMes = "2 TRIMSTRE";  |FINSI;
     |SI #siiz0021#4 = "3T";  aMes = "3 TRIMSTRE";  |FINSI;
     |SI #siiz0021#4 = "4T";  aMes = "4 TRIMSTRE";  |FINSI;

     |SI aMes = "";
         |MENAV "0000Periodo incorrecto. ";
         |ERROR;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO T66C4;  |TIPO 66;
     aAlfa = "|C004WID";
     aID   = #siiz0021#aAlfa#;
     nID   = aID;

     aPopup1  = nID;
     aPopup2  = 16;
     aPopup3  = "01-ENERO";
     aPopup4  = "02-FEBRERO";
     aPopup5  = "03-MARZO";
     aPopup6  = "04-ABRIL";
     aPopup7  = "05-MAYO";
     aPopup8  = "06-JUNIO";
     aPopup9  = "07-JULIO";
     aPopup10 = "08-AGOSTO";
     aPopup11 = "09-SEPTIEMBRE";
     aPopup12 = "10-OCTUBRE";
     aPopup13 = "11-NOVIEMBRE";
     aPopup14 = "12-DICIEMBRE";
     aPopup15 = "1T-1 TRIMESTRE";
     aPopup16 = "2T-2 TRIMESTRE";
     aPopup17 = "3T-3 TRIMESTRE";
     aPopup18 = "4T-4 TRIMESTRE";

     IaPopup  = aPopup1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;
     |SI FSalida ! 0;
         IaPopup  = aPopup3  <-;
         IaPopup  = IaPopup + (FSalida - 1);

         aAlfa = aPopup % 102;  #siiz0021#4 = aAlfa;
     |FINSI;

     |PINTA #siiz0021#4;
|FPRC;

|PROCESO T7C4;  |TIPO 7;
     |C_M #siiz0021#4, 1, "S";
     |SI #siiz0021#3 = "N";
         |C_M #siiz0021#4, 1, "N";  #siiz0021#4 = "";
     |SINO;
         |SI #siiz0021#4 = "  ";
             aAlfa  = fFechaSys % 402;
             #siiz0021#4 = aAlfa;
         |FINSI;
     |FINSI;

     |PINTA #siiz0021#4;
|FPRC;

|PROCESO T7C2;  |TIPO 7;
     |C_M #siiz0021#2, 1, "S";
     |SI #siiz0021#1 = "N";
         |C_M #siiz0021#2, 1, "N";  #siiz0021#2 = 0;
     |SINO;
         |SI #siiz0021#2 = 0;
             aAlfa  = fFechaSys % -104;
             #siiz0021#2 = aAlfa;
         |FINSI;
     |FINSI;

     |PINTA #siiz0021#2;
|FPRC;

|PROGRAMA;
     |CLS;
     |CABEZA "Exportaci¢n excel";

     |HAZ AbreVtn0;

     |PINPA #0#siiz0021;
     |PINDA #0#siiz0021;
     |ENDATOS #1#siiz0021;
|FPRO;

|PROCESO T80;  |TIPO 80;
     |HAZ LeeUnidadBasico;

     aIP  = "";
     |IP_REMOTO aIP;

     |ABRET #siim0001;
     |ABRET #siim0002;

     aH60 = "z" * 60;

     fFechaSys = ~;

     |DBASE aBaseSII;  |QBF aBaseSII;
     aPathTmp = aBaseSII + "tmp";                    |MKDIR aPathTmp;
     aPathTmp = aBaseSII + "tmp/" + Usuario;         |MKDIR aPathTmp;
     aPathTmp = aBaseSII + "tmp/" + Usuario + "/";

     aPathSII = eaUnidadBasico + "\documentos";   |RMKDIR aPathSII;
     aPathSII = aPathSII + "\siibase";            |RMKDIR aPathSII;
     aPathSII = aPathSII + "\exportaciones";      |RMKDIR aPathSII;
     aPathSII = aPathSII + "\";

     FSalida = 1855;
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #siim0001;
     |CIERRAT #siim0002;
|FPRC;
