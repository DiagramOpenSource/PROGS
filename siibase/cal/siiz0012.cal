|FICHEROS;
     siim0000;
     siim0001;
     siim0002;
     siim0003;
     siim0007;
     siim0054;
     siim0500;
     siim0501;

     siiw0203;
     siiw0207;
|FIN;

|VARIABLES;
     n2Vent              = 0;
     n1Vent              = 0;
     nHandle             = 0;
     nLin                = 0;
     nLin1               = 0;
     nLin2               = 0;
     nLin3               = 0;
     nLin4               = 0;
     nLin5               = 0;
     nLin6               = 0;
     nCmp                = 0;
     nCmp1               = 0;
     nCmp2               = 0;
     nCmp3               = 0;
     nCmp4               = 0;
     nCmp5               = 0;
     nOk                 = 0;
     nBases              = 0;
     nLong               = 0;
     nCarac              = 0;
     nPos                = 0;
     nActiv              = 0;
     nReg                = 0;
     nRegs               = 0;
     nTDesFac            = 0;
     nTDesFacSuj         = 0;
     nTDesFacSujEx       = 0;
     nTDesFacSujNEx      = 0;
     nTDesFacNSuj        = 0;
     nTDesTOpPrs         = 0;
     nTDesTOpPrsSuj      = 0;
     nTDesTOpPrsSujEx    = 0;
     nTDesTOpPrsSujNEx   = 0;
     nTDesTOpPrsNSuj     = 0;
     nTDesTOpEnt         = 0;
     nTDesTOpEntSuj      = 0;
     nTDesTOpEntSujEx    = 0;
     nTDesTOpEntSujNEx   = 0;
     nTDesTOpEntNSuj     = 0;
     nEsOtro             = 0;
     nUno                = 0;
     nPasada             = 0;
     nNumReg             = 0;
     nVeces              = 0;
     nTope               = 0;
     nFiche              = 0;
     nDReg               = 0;
     nUltReg             = 0;
     nGrab               = 0;
     nPul                = 0;
     nCon                = 0;
     nPausa              = 0;

     aNIF                = "";
     aIdRes              = "";
     aIdent              = "";
     aFecEm              = "";
     aEstad              = "";
     aCodEr              = "";
     aDesEr              = "";
     aIdCSV              = "";
     aFEnvi              = "";
     aHEnvi              = "";
     aExt                = "";
     aLinea              = "";
     aModoImp            = "";
     aTDes               = "";
     aNDes               = "";
     aTDes1              = "";
     aTDes2              = "";
     aTDes3              = "";
     aTDes4              = "";
     aTDes5              = "";
     aTDes6              = "";
     aNDes1              = "";
     aNDes2              = "";
     aNDes3              = "";
     aNDes4              = "";
     aNDes5              = "";
     aNDes6              = "";
     aTip1               = "";
     aTip2               = "";
     aTipNiv             = "";
     aDesgl              = "";
     aCar                = "";
     aEjec               = "";

     aAlfa               = "";
     aAlfa1              = "";
     aAlfa2              = "";
     aAlfa3              = "";
     aAlfa4              = "";
     aAlfa5              = "";
     aAlfa6               = "";
     aLee                = "";
     aBaseSII            = "";
     aFicXml             = "";
     aFicRes             = "";
     aPathTmp            = "";
     aPathSII            = "";
     aPathPlu            = "";
     aAbreXml            = "";
     aHora               = "";
     aContenido          = "";
     aApli               = "";
     aH60                = "";
     aFec                = "";
     aClv                = "";
     aClvPpl             = "";
     aClvN1              = "";
     aClvN2              = "";
     aClvN3              = "";
     aClvN4              = "";
     aClvN5              = "";
     aTipoCmp            = "";
     aQQ                 = "";
     aDEtiq              = "";
     aHEtiq              = "";
     aDEti               = "";
     aHEti               = "";
     aAgru               = "";
     aAgruClv            = "";
     aIP                 = "";
     aOri                = "";
     aDes                = "";
     aVer1               = "";
     aVer2               = "";
     aEnlace             = "";
     aAbre               = "";
     aCaracter           = "";
     aError              = "";
     aLong               = "";
     aCadena             = "";
     aFicTmp             = "";
     aEsq                = "";

     fFecha              = @;
     fFechaSys           = @;

     {1}aConte           = "";

     {-1}aVent           = "";
         aVent1          = 0;
         aVent2          = 0;
         aVent3          = 0;
         aVent4          = 0;
         aVent5          = "";

     &enEmp              = 0;
     &enLot              = 0;
     &eaAlfa             = "";
     &eaCodNif           = "";
     &eaNomNif           = "";
     &eaUnidadBasico     = "";
     &eaVerde            = "";
     &eaRojo             = "";
     &eaAzul             = "";
     &eaPython           = "";
     &eaCert             = "";
     &enOk               = 0;
|FIN;

|PROCESO QuitaCeros;
     |PARA;  |SI;  |HACIENDO;
          aAlfa = aClvPpl % -102;
          |SI aAlfa = "00";
              aClvPpl = aClvPpl % -320;
          |SINO;
              |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO QuitaPrimero;
     aCadena = "";
     aLong   = aAlfa % 0;
     nLong   = aLong;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos       = (nCarac * 100) + 1;
           aCaracter  = aAlfa % nPos;
           aCar       = &194;
           |SI aCaracter = aCar;
               aCaracter = "";
           |FINSI;

           aCar       = &186;
           |SI aCaracter = aCar;
               aCaracter = "§";
           |FINSI;

           aCadena = aCadena + aCaracter;
     |SIGUE;

     aAlfa = aCadena;
|FPRC;

|PROCESO QuitaEne;
     aCadena = "";
     aLong   = aAlfa % 0;
     nLong   = aLong;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos       = (nCarac * 100) + 1;
           aCaracter  = aAlfa % nPos;
           aCar       = &195;
           |SI aCaracter = aCar;
               aCaracter = "";
           |FINSI;

           aCar       = &145;
           |SI aCaracter = aCar;
               aCaracter = "¥";
           |FINSI;

           aCadena = aCadena + aCaracter;
     |SIGUE;

     aAlfa = aCadena;
|FPRC;

|PROCESO SacaCadena;
     aAlfa   = aLee;  |QBF aAlfa;
     aCadena = "";
     aLong   = aAlfa % 0;
     nLong   = aLong;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos       = (nCarac * 100) + 1;
           aCaracter  = aAlfa % nPos;
           |SI aCaracter = "<";  |O aCaracter = ">";
               aCadena = "";
           |SINO;
               aCadena = aCadena + aCaracter;
           |FINSI;
     |SIGUE;
|FPRC;

|PROCESO SacaNivel;
     |SI nCmp1 = 23;  aTDes = aTDes1;  aNDes = aNDes1;  |FINSI;
     |SI nCmp1 = 29;  aTDes = aTDes2;  aNDes = aNDes2;  |FINSI;
     |SI nCmp1 = 35;  aTDes = aTDes3;  aNDes = aNDes3;  |FINSI;
     |SI nCmp1 = 41;  aTDes = aTDes4;  aNDes = aNDes4;  |FINSI;
     |SI nCmp1 = 47;  aTDes = aTDes5;  aNDes = aNDes5;  |FINSI;
     |SI nCmp1 = 53;  aTDes = aTDes6;  aNDes = aNDes6;  |FINSI;

     nCmp2 = nCmp1 + 1;
     nCmp3 = nCmp1 + 2;
     nCmp4 = nCmp1 + 3;
     nCmp5 = nCmp1 + 4;
|FPRC;

|PROCESO TipoOK;
     nCmp2 = nCmp1 + 1;
     nCmp3 = nCmp1 + 2;
     nCmp4 = nCmp1 + 3;
     nCmp5 = nCmp1 + 4;

     |SI nCmp1 = 23;
         aTDes = aTDes1;
         aNDes = aNDes1 % 101;
     |FINSI;

     |SI nCmp1 = 29;
         aTDes = aTDes2;
         aNDes = aNDes2 % 101;
     |FINSI;

     |SI nCmp1 = 35;
         aTDes = aTDes3;
         aNDes = aNDes3 % 101;
     |FINSI;

     |SI nCmp1 = 41;
         aTDes = aTDes4;
         aNDes = aNDes4 % 101;
     |FINSI;

     |SI nCmp1 = 47;
         aTDes = aTDes5;
         aNDes = aNDes5 % 101;
     |FINSI;

     |SI nCmp1 = 53;
         aTDes = aTDes6;
         aNDes = aNDes6 % 101;
     |FINSI;

     |SI aNDes = " ";
         |ACABA;
     |FINSI;

     |SI aTDes = aTip1;  |Y aNDes = aTip2;
         nRegs = nRegs + 1;

         |SI nLin1 = 0;  nLin1 = nCmp1;  |ACABA;  |FINSI;
         |SI nLin2 = 0;  nLin2 = nCmp1;  |ACABA;  |FINSI;
         |SI nLin3 = 0;  nLin3 = nCmp1;  |ACABA;  |FINSI;
         |SI nLin4 = 0;  nLin4 = nCmp1;  |ACABA;  |FINSI;
         |SI nLin5 = 0;  nLin5 = nCmp1;  |ACABA;  |FINSI;
         |SI nLin6 = 0;  nLin6 = nCmp1;  |ACABA;  |FINSI;
     |FINSI;
|FPRC;

|PROCESO SacaDesglose;
     aTip1 = aTipNiv % 101;
     aTip2 = aTipNiv % 201;

     nRegs = 0;
     nLin1 = 0;
     nLin2 = 0;
     nLin3 = 0;
     nLin4 = 0;
     nLin5 = 0;
     nLin6 = 0;

     |PARA nCmp1 = 23;  |SI nCmp1 [ 53;  |HACIENDO nCmp1 = nCmp1 + 6;
           |HAZ TipoOK;
     |SIGUE;
|FPRC;

|PROCESO GrabaEstado;
     nReg = nReg + 1;

     eaAlfa = aDesEr;  |HAZ QuitaRarosXml; aDesEr = eaAlfa;

     #siiw0203#0 = nReg;
     #siiw0203#1 = aIdent;
     #siiw0203#2 = aFecEm;
     #siiw0203#3 = aNIF;
     #siiw0203#4 = aIdRes;
     #siiw0203#5 = aEstad;
     #siiw0203#6 = aCodEr;
     #siiw0203#7 = aDesEr;
     #siiw0203#8 = eaVerde;

     |SI #siiw0203#5 = "Incorrecto          ";
         #siiw0203#8 = eaRojo;
     |FINSI;

     |SI #siiw0203#5 = "AceptadoConErrores  ";
         #siiw0203#8 = eaAzul;
     |FINSI;

     |GRABA 020#siiw0203.n;
     |LIBERA #siiw0203;
|FPRC;

|PROCESO LeeRespuesta;
     aOri  = aPathSII + aFicRes;
     aDes  = aPathTmp + aFicRes;
     |SI aIP = "";
         |COPIA_FICHERO aOri, aDes;
     |SINO;
         |RECIBE_FICHERO aOri, aDes;
     |FINSI;

     nOk     = 1;
     nActiv  = 0;
     aIdCSV  = "";
     aNIF    = "";
     aIdRes  = "";
     aIdent  = "";
     aFecEm  = "";
     aEstad  = "";
     aCodEr  = "";
     aDesEr  = "";
     aFEnvi  = "";
     aHEnvi  = "";

     aAbre  = aPathTmp + aFicRes;
     |XABRE "", aAbre, nHandle;

     |PARA; |SI;  |HACIENDO;
          |XLEE nHandle, 250, aLee;
          |SI FSalida < 0; |SAL;  |FINSI;

          aAlfa = aLee - "<siiR:CSV>";
          |SI FSalida ! 0;
              |SI aIdCSV = "";
                  |HAZ SacaCadena;
                  aIdCSV = aCadena;
              |FINSI;
          |FINSI;

          aAlfa = aLee - "<sii:TimestampPresentacion>";
          |SI FSalida ! 0;
              |HAZ SacaCadena;
              aFEnvi  = (aCadena % 102) + "." + (aCadena % 402) + "." + (aCadena % 704);
              aHEnvi  = aCadena % 1208;
          |FINSI;

          aAlfa = aLee - "<faultstring>";
          |SI FSalida ! 0;
              |HAZ SacaCadena;
              aError = aCadena;
              nOk    = 0;
              |SAL;
          |FINSI;

          aAlfa = aLee - "</siiR:RespuestaLinea>";
          |SI FSalida ! 0;
              nActiv = 0;
              |HAZ GrabaEstado;
          |FINSI;

          aAlfa = aLee - "<siiR:RespuestaLinea";
          |SI FSalida ! 0;
              aNIF   = "";
              aIdRes = "";
              aIdent = "";
              aFecEm = "";
              aEstad = "";
              aCodEr = "";
              aDesEr = "";

              nActiv = 1;
          |FINSI;

          |SI nActiv = 1;
              aAlfa = aLee - "<sii:NIF>";
              |SI FSalida ! 0;
                  |HAZ SacaCadena;
                  aNIF = aCadena;
              |FINSI;

              aAlfa = aLee - "<sii:IDOtro>";
              |SI FSalida ! 0;
                  nEsOtro = 1;
              |FINSI;

              aAlfa = aLee - "<sii:ID>";
              |SI FSalida ! 0;
                  |SI nEsOtro = 1;
                      |HAZ SacaCadena;
                      aIdRes = aCadena;
                  |FINSI;
              |FINSI;

              aAlfa = aLee - "<sii:NumSerieFacturaEmisor>";
              |SI FSalida ! 0;
                  |HAZ SacaCadena;
                  aIdent = aCadena;

                  aCar  = &194 + &186;    || §
                  aAlfa = aAlfa - aCar;
                  |SI FSalida ! 0;
                      aAlfa = aIdent;
                      |HAZ QuitaPrimero;
                      aIdent = aAlfa;
                  |FINSI;

                  aCar  = &195 + &145;    || ¥
                  aAlfa = aAlfa - aCar;
                  |SI FSalida ! 0;
                      aAlfa = aIdent;
                      |HAZ QuitaEne;
                      aIdent = aAlfa;
                  |FINSI;
              |FINSI;

              aAlfa = aLee - "<sii:FechaExpedicionFacturaEmisor>";
              |SI FSalida ! 0;
                  |HAZ SacaCadena;
                  aFecEm = aCadena;
              |FINSI;

              aAlfa = aLee - "<siiR:EstadoRegistro>";
              |SI FSalida ! 0;
                  |HAZ SacaCadena;
                  aEstad = aCadena;
              |FINSI;

              aAlfa = aLee - "<siiR:EstadoRegistro>";
              |SI FSalida ! 0;
                  |HAZ SacaCadena;
                  aEstad = aCadena;
              |FINSI;

              aAlfa = aLee - "<siiR:CodigoErrorRegistro>";
              |SI FSalida ! 0;
                  |HAZ SacaCadena;
                  aCodEr = aCadena;
              |FINSI;

              aAlfa = aLee - "<siiR:DescripcionErrorRegistro>";
              |SI FSalida ! 0;
                  |HAZ SacaCadena;
                  aDesEr = aCadena;
              |FINSI;
          |FINSI;
     |SIGUE;
     |XCIERRA nHandle;

     |SI nOk = 0;
         |SI aModoImp = "SIIBASE";
             aAlfa = "0000" + aError;
             |MENAV aAlfa;

             |MENAV "0000Proceso cancelado";
         |FINSI;

         |ACABA;
     |FINSI;

     |FBORRA aAbre;
|FPRC;

|PROCESO GrabaEnvio;
     #siiw0207#0  = #siim0003#0;
     #siiw0207#1  = #siim0003#1;
     #siiw0207#2  = #siim0003#2;
     #siiw0207#3  = #siiw0203#1;
     #siiw0207#4  = #siiw0203#2;
     #siiw0207#5  = #siiw0203#3;
     #siiw0207#6  = #siiw0203#4;
     #siiw0207#7  = #siiw0203#5;
     #siiw0207#8  = #siiw0203#6;
     #siiw0207#9  = #siiw0203#7;
     #siiw0207#10 = #siiw0203#8;

     |GRABA 000#siiw0207.n;
     |LIBERA #siiw0207;
|FPRC;

|PROCESO GrabaNoti;
     |LEE 000#siim0054.u;
     |SI FSalida ! 0;  |DDEFECTO #siim0054;  |FINSI;

     |HORA aHora;

     nReg = #siim0054#0 + 1;

     |DDEFECTO #siim0054;
     #siim0054#0 = nReg;
     #siim0054#1 = fFechaSys;
     #siim0054#2 = aHora;
     #siim0054#4 = #siim0003#104 + " / " + #siim0003#105;

     |SI #siim0003#103 = "C";
         #siim0054#3 = "Correcto";
         #siim0054#4 = "Registro aceptado";
     |FINSI;

     |SI #siim0003#103 = "A";  #siim0054#3 = "AceptadaConErrores";  |FINSI;
     |SI #siim0003#103 = "I";  #siim0054#3 = "Incorrecto";          |FINSI;

     #siim0054#5  = "PRESENTACION";
     #siim0054#7  = #siim0003#0;
     #siim0054#8  = #siim0003#1;
     #siim0054#9  = #siim0003#2;
     #siim0054#11 = #siim0003#19;

     |GRABA 020#siim0054.n;
     |LIBERA #siim0054;
|FPRC;

|PROCESO GrabaResp;
     |SI aFEnvi = "";
         |HORA aHora;

         aFEnvi = fFechaSys;
         aHEnvi = aHora;
     |FINSI;

     #siim0003#100 = Usuario % 810;
     #siim0003#101 = aFEnvi;
     #siim0003#102 = aHEnvi;
     #siim0003#104 = #siiw0203#6;
     #siim0003#105 = #siiw0203#7;
     #siim0003#106 = aIdCSV;
     #siim0003#103 = "C";
     #siim0003#107 = eaVerde;

     |SI #siiw0203#5 = "Incorrecto          ";
         #siim0003#101 = "01.01.0000";
         #siim0003#102 = "";
         #siim0003#103 = "I";
         #siim0003#106 = "";
         #siim0003#107 = eaRojo;
     |FINSI;

     |SI #siiw0203#5 = "AceptadoConErrores  ";
         #siim0003#103 = "A";
         #siim0003#107 = eaAzul;
     |FINSI;

     |GRABA 020#siim0003.a;
     |LIBERA #siim0003;

     |SI aModoImp = "SIIBOX";
         |HAZ GrabaNoti;
     |FINSI;

     |SI aModoImp = "SIIGEN";
         |HAZ GrabaEnvio;
     |FINSI;
|FPRC;

|PROCESO siiw0203;
     nUno = 0;

     #siim0003#0  = #siim0002#0;
     #siim0003#19 = #siiw0203#1;
     #siim0003#1  = 1;
     #siim0003#2  = 1;
     |LEE 101#siim0003.];
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |SI #siim0003#0 ! #siim0002#0;
              |SAL;
          |FINSI;

          |SI #siim0003#19 ! #siiw0203#1;
              |SAL;
          |FINSI;

          nUno = nUno + 1;

          |LEE 000#siim0003.s;
     |SIGUE;

     #siim0003#0  = #siim0002#0;
     #siim0003#19 = #siiw0203#1;
     #siim0003#1  = #siim0002#1;
     #siim0003#2  = 1;
     |LEE 101#siim0003.];
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |SI #siim0003#0 ! #siim0002#0;
              |SAL;
          |FINSI;

          |SI #siim0003#19 ! #siiw0203#1;
              |SAL;
          |FINSI;

          |SI #siim0003#1 ! #siim0002#1;
              |SAL;
          |FINSI;

          aAlfa = #siiw0203#7;  |QBF aAlfa;
          |SI aAlfa = "Factura duplicada";
              |SI #siim0003#103 ! "C";  |Y #siim0003#103 ! "A";
                  |SI nUno = 1;
                      #siiw0203#5 = "Correcto";
                      #siiw0203#6 = "";
                      #siiw0203#7 = "";
                      #siiw0203#8 = eaVerde;

                      |GRABA 020#siiw0203.a;
                      |LIBERA #siiw0203;
                  |FINSI;
               |FINSI;
          |FINSI;

          |SI #siim0003#103 ! "C";  |Y #siim0003#103 ! "A";
              |HAZ GrabaResp;
              |SAL;
          |FINSI;

          |LEE 000#siim0003.s;
     |SIGUE;
|FPRC;

|DEFBUCLE siiw0203;
     #siiw0203#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siiw0203;
|FIN;

|PROCESO EnviaLote;
     |HAZ Ds_SII;
     |SI enOk = 0;  |ACABA;  |FINSI;

     aOri = aPathTmp + aFicXml;
     aDes = aPathSII + aFicXml;
     |SI aIP = "";
         |COPIA_FICHERO aOri, aDes;
     |SINO;
         |ENVIA_FICHERO aOri, aDes;
     |FINSI;

     aLinea  = "0"; || Linea 1 del fichero sii_urls.txt

     aEnlace = aPathSII + "ejecuta.bat";
     |XABRE "WBC", aEnlace, nHandle;

     aAlfa = aPathSII + "ds_sii.exe ";       |XGRABA nHandle, aAlfa;
     aAlfa = "ds123456 " + aLinea + " ";     |XGRABA nHandle, aAlfa;
     aAlfa = aPathSII + aFicXml + " ";       |XGRABA nHandle, aAlfa;
     aAlfa = aPathSII + aFicRes + " ";       |XGRABA nHandle, aAlfa;

     |SI aModoImp = "SIIBOX";
         aAlfa = &34 + #siim0000#1;   |QBF aAlfa;
         aAlfa = aAlfa + &34;   |XGRABA nHandle, aAlfa;
     |SINO;
         aAlfa = "NO ";                          |XGRABA nHandle, aAlfa;
         aAlfa =  eaCert;                        |XGRABA nHandle, aAlfa;
     |FINSI;

     |XCIERRA nHandle;

     aEjec   = aPathSII + "dsmini ";
     aEjec   = aEjec + aPathSII + "ejecuta.bat";
     |RSYSTEM aEjec;

     nCon  = 0;
     aAbre = aPathSII + aFicRes;
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aAbre, 0;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             |SLEEP 1;
             |PULSATECLA;
     |SIGUE;

     aAbre = aPathSII + aFicRes;
     |XABRE "EC", aAbre, 0;
     |SI FSalida ] 0;
         |HAZ LeeRespuesta;
     |SINO;
         |SI aModoImp = "SIIBASE";
             |MENAV "0000Sin respuesta. Revise la instalaci¢n y validez del certificado digital";
         |FINSI;

         nOk = 0;
     |FINSI;

     |SI nOk  = 0;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO ConverFec;
     aFec = (aFec % 102) + "-" + (aFec % 402) + "-" + (aFec % 704);
|FPRC;

|PROCESO CargaContenido;
     aAlfa = #siim0501#15;  |QBF aAlfa;
     |SI aAlfa = "";
         eaAlfa = aContenido;
         |HAZ cp437_a_utf8;
         aContenido = eaAlfa;
         |QBF aContenido;
         |ACABA;
     |FINSI;

     aApli    = #siim0501#15 % 208;
     aAlfa    = #siim0501#15 % 1103;
     nCmp     = aAlfa;
     aTipoCmp = "";
     aQQ      = "|C" + (("000" + nCmp) % -103) + "TIPO";

     aContenido = "";

     |SI aApli = "siim0001";
         aContenido = #siim0001#nCmp#;
         aTipoCmp   = #siim0001#aQQ#;
     |FINSI;

     |SI aApli = "siim0002";
         aContenido = #siim0002#nCmp#;
         aTipoCmp   = #siim0002#aQQ#;
     |FINSI;

     |SI aApli = "siim0003";
         aContenido = #siim0003#nCmp#;
         aTipoCmp   = #siim0003#aQQ#;
     |FINSI;

     |SI aApli = "siim0500";
         aContenido = #siim0500#nCmp#;
         aTipoCmp   = #siim0500#aQQ#;
     |FINSI;

     |SI #siim0501#15 = "#siim0002#005# ";
         aContenido = ("00" + #siim0002#5) % -102;
     |FINSI;

     |SI #siim0501#15 = "#siim0002#002# ";
         |SI #siim0002#2 = "11";  aContenido = "A0";  |FINSI;
         |SI #siim0002#2 = "12";  aContenido = "A1";  |FINSI;
     |FINSI;

     |QBF aContenido;

     |SI aTipoCmp = "F";
         fFecha = aContenido;
         |SI fFecha < "01.01.2000";
             aContenido = "";
             |ACABA;
         |FINSI;

         aFec = aContenido;
         |HAZ ConverFec;
         aContenido = aFec;
     |FINSI;

     |SI aTipoCmp = "A";
         eaAlfa = aContenido;
         |HAZ QuitaRarosXml;
         aContenido = eaAlfa;
     |FINSI;
|FPRC;

|PROCESO GrabaFicEspa;
     |QBF aAlfa;
                            aAlfa1 = "      ";
     |SI #siim0501#2  ! 0;  aAlfa1 = aAlfa1 + "   ";  |FINSI;
     |SI #siim0501#3  ! 0;  aAlfa1 = aAlfa1 + "   ";  |FINSI;
     |SI #siim0501#4  ! 0;  aAlfa1 = aAlfa1 + "   ";  |FINSI;
     |SI #siim0501#5  ! 0;  aAlfa1 = aAlfa1 + "   ";  |FINSI;
     |SI #siim0501#6  ! 0;  aAlfa1 = aAlfa1 + "   ";  |FINSI;
     |SI #siim0501#7  ! 0;  aAlfa1 = aAlfa1 + "   ";  |FINSI;
     |SI #siim0501#8  ! 0;  aAlfa1 = aAlfa1 + "   ";  |FINSI;
     |SI #siim0501#9  ! 0;  aAlfa1 = aAlfa1 + "   ";  |FINSI;
     |SI #siim0501#10 ! 0;  aAlfa1 = aAlfa1 + "   ";  |FINSI;
     |SI #siim0501#11 ! 0;  aAlfa1 = aAlfa1 + "   ";  |FINSI;

     aAlfa2 = #siim0501#13 % 201;
     |SI aAlfa2 = "/";
         aAlfa1 = aAlfa1 - "   ";
     |FINSI;

     aAlfa = aAlfa1 + aAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO GrabaFic;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO siim0501;
     |SI #siim0501#12 = "1";
         aAlfa = #siim0501#13;  |HAZ GrabaFicEspa;
     |FINSI;

     |SI #siim0501#12 = "2";
         |HAZ CargaContenido;

         |SI #siim0501#17 = "2";
             |SI aTipoCmp = "N";
                 |SI aContenido = "0";
                     aContenido = "";
                 |FINSI;
             |FINSI;
         |FINSI;

         |SI aContenido = "";  |Y #siim0501#17 ! "1";
             |ACABA;
         |FINSI;

         aAlfa = #siim0501#13;          |QBF aAlfa;
         aAlfa = aAlfa + aContenido;    |QBF aAlfa;
         aAlfa = aAlfa + #siim0501#14;  |QBF aAlfa;

         |HAZ GrabaFicEspa;
     |FINSI;

     aAlfa = #siim0501#18;
|FPRC;

|DEFBUCLE siim0501;
     #siim0501#3;
     ;
     #siim0500#2, aEsq, aDEti;
     #siim0500#2, aEsq, aHEti;
     ;
     NULL, siim0501;
|FIN;

|PROCESO PorClave3;
     |HAZ QuitaCeros;

     eaAlfa = aContenido;
     |HAZ QuitaRarosXml;
     aContenido = eaAlfa;

     |SELECT #3#siim0501;

     aClv         = (aClvPpl + aAgruClv + ("00" * 20)) % 120;
     #siim0501#0  = #siim0500#2;
     #siim0501#1  = aEsq;
     #siim0501#18 = aClv;
     |LEE 000#siim0501.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aAlfa = #siim0501#13;          |QBF aAlfa;
     aAlfa = aAlfa + aContenido;    |QBF aAlfa;
     aAlfa = aAlfa + #siim0501#14;  |QBF aAlfa;
     |HAZ GrabaFicEspa;
|FPRC;

|PROCESO LeeEsquema;
     |SELECT #2#siim0501;

     #siim0501#0  = #siim0500#2;
     #siim0501#1  = aEsq;
     #siim0501#13 = aDEtiq;
     |LEE 000#siim0501.=;

     aDEti   = #siim0501#18;
     aClvPpl = #siim0501#18;  |QBF aClvPpl;

     #siim0501#0  = #siim0500#2;
     #siim0501#1  = aEsq;
     #siim0501#13 = aHEtiq;
     |LEE 000#siim0501.=;

     aHEti  = #siim0501#18;

     |BUCLE siim0501;
|FPRC;

|PROCESO InicioFactura;
     aDEtiq = "<siiLR:RegistroLRFacturasEmitidas>";
     aHEtiq = "<siiLR:RegistroLRFacturasEmitidas>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO FinalFactura;
     aDEtiq = "</siiLR:RegistroLRFacturasEmitidas>";
     aHEtiq = "</siiLR:RegistroLRFacturasEmitidas>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO PeriodoLiquidacion;
     aDEtiq = "<sii:PeriodoLiquidacion>";
     aHEtiq = "<sii:PeriodoLiquidacion>";
     |HAZ LeeEsquema;

     aAgruClv   = "01";
     aContenido = #siim0002#4;
     |HAZ PorClave3;

     aContenido = ("00" + #siim0002#5) % -102;
     |SI #siim0002#21 = "T";
         aContenido = #siim0002#5 + #siim0002#21;
     |FINSI;

     aAgruClv   = "02";
     |HAZ PorClave3;

     aDEtiq = "</sii:PeriodoLiquidacion>";
     aHEtiq = "</sii:PeriodoLiquidacion>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO IDFactura;
     aDEtiq = "<siiLR:IDFactura>";
     aHEtiq = "</siiLR:IDFactura>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO InicioFExpedida;
     aDEtiq = "<siiLR:FacturaExpedida>";
     aHEtiq = "<siiLR:FacturaExpedida>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO TipoFactura;
     aDEtiq = "<sii:TipoFactura>";
     aHEtiq = "<sii:TipoFactura>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO TipoRectificativa;
     aDEtiq = "<sii:TipoRectificativa>";
     aHEtiq = "<sii:TipoRectificativa>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO siim0007;
     |SI aAgru = "<sii:FacturasAgrupadas>";
         aDEtiq = "<sii:IDFacturaAgrupada>";
         aHEtiq = "<sii:IDFacturaAgrupada>";
         |HAZ LeeEsquema;
     |FINSI;

     |SI aAgru = "<sii:FacturasRectificadas>";
         aDEtiq = "<sii:IDFacturaRectificada>";
         aHEtiq = "<sii:IDFacturaRectificada>";
         |HAZ LeeEsquema;
     |FINSI;

     aAgruClv   = "01";
     aContenido = #siim0007#3;  |QBF aContenido;
     |HAZ PorClave3;

     aAgruClv   = "02";
     aFec       = #siim0007#4;      |HAZ ConverFec;
     aContenido =  aFec;            |QBF aContenido;
     |HAZ PorClave3;

     |SI aAgru = "<sii:FacturasAgrupadas>";
         aDEtiq = "</sii:IDFacturaAgrupada>";
         aHEtiq = "</sii:IDFacturaAgrupada>";
         |HAZ LeeEsquema;
     |FINSI;

     |SI aAgru = "<sii:FacturasRectificadas>";
         aDEtiq = "</sii:IDFacturaRectificada>";
         aHEtiq = "</sii:IDFacturaRectificada>";
         |HAZ LeeEsquema;
     |FINSI;
|FPRC;

|DEFBUCLE siim0007;
     #siim0007#1;
     ;
     #siim0003#0, #siim0003#1, #siim0003#2, "";
     #siim0003#0, #siim0003#1, #siim0003#2, aH60;
     ;
     NULL, siim0007;
|FIN;

|PROCESO FacturasAgrupadas;
     |SI #siim0003#6 ! "F3";
         |ACABA;
     |FINSI;

     #siim0007#0 = #siim0003#0;
     #siim0007#1 = #siim0003#1;
     #siim0007#2 = #siim0003#2;
     #siim0007#3 = "";
     |LEE 000#siim0007.];
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |SI #siim0007#0 ! #siim0003#0;  |O #siim0007#1 ! #siim0003#1;
      |O #siim0007#2 ! #siim0003#2;
         |ACABA;
     |FINSI;

     aAgru  = "<sii:FacturasAgrupadas>";
     aDEtiq = "<sii:FacturasAgrupadas>";
     aHEtiq = "<sii:FacturasAgrupadas>";
     |HAZ LeeEsquema;

     |BUCLE siim0007;

     aDEtiq = "</sii:FacturasAgrupadas>";
     aHEtiq = "</sii:FacturasAgrupadas>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO FacturasRectificadas;
     aAlfa = #siim0003#6 % 101;
     |SI aAlfa ! "R";
         |ACABA;
     |FINSI;

     #siim0007#0 = #siim0003#0;
     #siim0007#1 = #siim0003#1;
     #siim0007#2 = #siim0003#2;
     #siim0007#3 = "";
     |LEE 000#siim0007.];
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |SI #siim0007#0 ! #siim0003#0;  |O #siim0007#1 ! #siim0003#1;
      |O #siim0007#2 ! #siim0003#2;
         |ACABA;
     |FINSI;

     aAgru  = "<sii:FacturasRectificadas>";
     aDEtiq = "<sii:FacturasRectificadas>";
     aHEtiq = "<sii:FacturasRectificadas>";
     |HAZ LeeEsquema;

     |BUCLE siim0007;

     aDEtiq = "</sii:FacturasRectificadas>";
     aHEtiq = "</sii:FacturasRectificadas>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO ImporteRectificacion;
     aAlfa = #siim0003#6 % 101;
     |SI aAlfa ! "R";
         |ACABA;
     |FINSI;

     |SI #siim0003#65 ! "S";
         |ACABA;
     |FINSI;

     aDEtiq = "<sii:ImporteRectificacion>";
     aHEtiq = "<sii:ImporteRectificacion>";
     |HAZ LeeEsquema;

     aDEtiq = "<sii:BaseRectificada>";
     aHEtiq = "<sii:BaseRectificada>";
     |HAZ LeeEsquema;

     aDEtiq = "<sii:CuotaRectificada>";
     aHEtiq = "<sii:CuotaRectificada>";
     |HAZ LeeEsquema;

     aDEtiq = "<sii:CuotaRecargoRectificado>";
     aHEtiq = "<sii:CuotaRecargoRectificado>";
     |HAZ LeeEsquema;

     aDEtiq = "</sii:ImporteRectificacion>";
     aHEtiq = "</sii:ImporteRectificacion>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO FechaOperacion;
     aDEtiq = "<sii:FechaOperacion>";
     aHEtiq = "<sii:FechaOperacion>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO TrascendenciaAdicional;
     aDEtiq = "<sii:ClaveRegimenEspecialOTrascendencia>";
     aHEtiq = "<sii:ClaveRegimenEspecialOTrascendencia>";
     |HAZ LeeEsquema;

     aDEtiq = "<sii:ClaveRegimenEspecialOTrascendenciaAdicional1>";
     aHEtiq = "<sii:ClaveRegimenEspecialOTrascendenciaAdicional1>";
     |HAZ LeeEsquema;

     aDEtiq = "<sii:ClaveRegimenEspecialOTrascendenciaAdicional2>";
     aHEtiq = "<sii:ClaveRegimenEspecialOTrascendenciaAdicional2>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO RegistroAcuerdo;
     aDEtiq = "<sii:NumRegistroAcuerdoFacturacion>";
     aHEtiq = "<sii:NumRegistroAcuerdoFacturacion>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO ImporteTotal;
     aDEtiq = "<sii:ImporteTotal>";
     aHEtiq = "<sii:ImporteTotal>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO BaseACoste;
     aDEtiq = "<sii:BaseImponibleACoste>";
     aHEtiq = "<sii:BaseImponibleACoste>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO DescriOperacion;
     aContenido = #siim0003#62;  |QBF aContenido;
     aContenido = aContenido + " " + #siim0003#63;  |QBF aContenido;
     aContenido = aContenido + " " + #siim0003#64;  |QBF aContenido;

     aDEtiq = "<sii:DescripcionOperacion>";
     aHEtiq = "<sii:DescripcionOperacion>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO RefExterna;
     aDEtiq = "<sii:RefExterna>";
     aHEtiq = "<sii:RefExterna>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO FacturaSimplifArt72_73;
     |SI #siim0003#112 ! "S";
         |ACABA;
     |FINSI;

     |SI #siim0003#6 ! "F1";  |Y #siim0003#6 ! "F3";
      |Y #siim0003#6 ! "R1";  |Y #siim0003#6 ! "R2";
      |Y #siim0003#6 ! "R3";  |Y #siim0003#6 ! "R4";
         |ACABA;
     |FINSI;

     aContenido = "S";

     aDEtiq = "<sii:FacturaSimplificadaArticulos7.2_7.3>";
     aHEtiq = "<sii:FacturaSimplificadaArticulos7.2_7.3>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO EntidadSucedida;
     aAlfa = #siim0003#116 + #siim0003#117;  |QBF aAlfa;
     |SI aAlfa = "";
         |ACABA;
     |FINSI;

     aDEtiq = "<sii:EntidadSucedida>";
     aHEtiq = "</sii:EntidadSucedida>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO RegPrevio;
     |SI #siim0003#114 ! "S";
         |ACABA;
     |FINSI;

     aContenido = "S";

     aDEtiq = "<sii:RegPrevioGGEEoREDEMEoCompetencia>";
     aHEtiq = "<sii:RegPrevioGGEEoREDEMEoCompetencia>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO Macrodato;
     |SI #siim0003#59 [ 100000000;
         |ACABA;
     |FINSI;

     aContenido = "S";

     aDEtiq = "<sii:Macrodato>";
     aHEtiq = "<sii:Macrodato>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO DatosInmuebles;
     nOk = 0;
     |SI #siim0003#7 = "11";  nOk = 1;  |FINSI;
     |SI #siim0003#7 = "12";  nOk = 1;  |FINSI;
     |SI #siim0003#7 = "13";  nOk = 1;  |FINSI;
     |SI #siim0003#8 = "11";  nOk = 1;  |FINSI;
     |SI #siim0003#8 = "12";  nOk = 1;  |FINSI;
     |SI #siim0003#8 = "13";  nOk = 1;  |FINSI;
     |SI #siim0003#9 = "11";  nOk = 1;  |FINSI;
     |SI #siim0003#9 = "12";  nOk = 1;  |FINSI;
     |SI #siim0003#9 = "13";  nOk = 1;  |FINSI;

     |SI nOk = 0;
         |ACABA;
     |FINSI;

     nOk = 0;
     |PARA nCmp1 = 69;  |SI nCmp1 [ 97;  |HACIENDO nCmp1 = nCmp1 + 2;
           nCmp2 = nCmp1 + 1;
           |SI #siim0003#nCmp1# ! " ";
               nOk = 1;
           |FINSI;
     |SIGUE;

     |SI nOk = 0;
         |ACABA;
     |FINSI;

     aDEtiq = "<sii:DatosInmueble>";
     aHEtiq = "<sii:DatosInmueble>";
     |HAZ LeeEsquema;

     |PARA nCmp1 = 69;  |SI nCmp1 [ 97;  |HACIENDO nCmp1 = nCmp1 + 2;
           nCmp2 = nCmp1 + 1;
           |SI #siim0003#nCmp1# ! " ";
               aDEtiq = "<sii:DetalleInmueble>";
               aHEtiq = "<sii:DetalleInmueble>";
               |HAZ LeeEsquema;

               aContenido = #siim0003#nCmp1#;
               aDEtiq = "<sii:SituacionInmueble>";
               aHEtiq = "<sii:SituacionInmueble>";
               |HAZ LeeEsquema;

               aContenido = #siim0003#nCmp2#;
               aDEtiq = "<sii:ReferenciaCatastral>";
               aHEtiq = "<sii:ReferenciaCatastral>";
               |HAZ LeeEsquema;

               aDEtiq = "</sii:DetalleInmueble>";
               aHEtiq = "</sii:DetalleInmueble>";
               |HAZ LeeEsquema;
           |FINSI;
     |SIGUE;

     aDEtiq = "</sii:DatosInmueble>";
     aHEtiq = "</sii:DatosInmueble>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO TransmisionSujeto;
     aDEtiq = "<sii:ImporteTransmisionInmueblesSujetoAIVA>";
     aHEtiq = "<sii:ImporteTransmisionInmueblesSujetoAIVA>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO EmitidaPorTerceros;
     |SI #siim0003#10 ! "S";
         |ACABA;
     |FINSI;

     aDEtiq = "<sii:EmitidaPorTercerosODestinatario>";
     aHEtiq = "<sii:EmitidaPorTercerosODestinatario>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO TerceraYSexta;
     |SI #siim0003#113 ! "S";
         |ACABA;
     |FINSI;

     aDEtiq = "<sii:FacturacionDispAdicionalTerceraYsextayDelMercadoOrganizadoDelGas>";
     aHEtiq = "<sii:FacturacionDispAdicionalTerceraYsextayDelMercadoOrganizadoDelGas>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO VariosDestinatarios;
     |SI #siim0003#11 ! "S";
         |ACABA;
     |FINSI;

     aDEtiq = "<sii:VariosDestinatarios>";
     aHEtiq = "<sii:VariosDestinatarios>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO Cupon;
     |SI #siim0003#12 ! "S";
         |ACABA;
     |FINSI;

     aDEtiq = "<sii:Cupon>";
     aHEtiq = "<sii:Cupon>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO FacturaSinIdentificar;
     |SI #siim0003#112 ! "S";
         |ACABA;
     |FINSI;

     |SI #siim0003#6 ! "F2";  |Y #siim0003#6 ! "F4";
      |Y #siim0003#6 ! "R5";
         |ACABA;
     |FINSI;

     aContenido = "S";

     aDEtiq = "<sii:FacturaSinIdentifDestinatarioAritculo6.1.d>";
     aHEtiq = "<sii:FacturaSinIdentifDestinatarioAritculo6.1.d>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO Contraparte;
     |SI #siim0003#6 = "F2";  |O #siim0003#6 = "F4";
      |O #siim0003#6 = "R5";
         |ACABA;
     |FINSI;

     aDEtiq = "<sii:Contraparte>";
     aHEtiq = "<sii:Contraparte>";
     |HAZ LeeEsquema;

     aAgruClv   = "01";
     aContenido = #siim0003#16;  |QBF aContenido;
     |HAZ PorClave3;

     |SI #siim0003#5 = "01";  |O #siim0003#5 = "07";
         aAgruClv   = "03";
         aContenido = #siim0003#15;  |QBF aContenido;
         |HAZ PorClave3;
     |FINSI;

     |SI #siim0003#5 ! "01";  |Y #siim0003#5 ! "07";
         aDEtiq = "<sii:IDOtro>";
         aHEtiq = "<sii:IDOtro>";
         |HAZ LeeEsquema;

         aDEtiq = "<sii:CodigoPais>";
         aHEtiq = "<sii:CodigoPais>";
         |HAZ LeeEsquema;

         aDEtiq = "<sii:IDType>";
         aHEtiq = "<sii:IDType>";
         |HAZ LeeEsquema;

         aDEtiq = "<sii:ID>";
         aHEtiq = "<sii:ID>";
         |HAZ LeeEsquema;

         aDEtiq = "</sii:IDOtro>";
         aHEtiq = "</sii:IDOtro>";
         |HAZ LeeEsquema;
     |FINSI;

     aDEtiq = "</sii:Contraparte>";
     aHEtiq = "</sii:Contraparte>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO DFDetalleExenta;
     |HAZ SacaNivel;

     aClvPpl    = aClvN3;
     aAgruClv   = "01";
     aContenido = "";
     |HAZ PorClave3;
     aClvN4 = #siim0501#18;  |QBF aClvN4;

     aClvPpl    = aClvN4;
     aAgruClv   = "01";
     aContenido = aNDes;
     |HAZ PorClave3;

     aClvPpl    = aClvN4;
     aAgruClv   = "02";
     aContenido = #siim0003#nCmp1#;
     |HAZ PorClave3;

     aClvPpl    = aClvN4;
     aAgruClv   = "03";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO DFSujetaExenta;
     aClvPpl    = aClvN2;
     aAgruClv   = "01";
     aContenido = "";
     |HAZ PorClave3;
     aClvN3 = #siim0501#18;  |QBF aClvN3;

     |SI nLin1 ! 0;  nCmp1 = nLin1;  |HAZ DFDetalleExenta;  |FINSI;
     |SI nLin2 ! 0;  nCmp1 = nLin2;  |HAZ DFDetalleExenta;  |FINSI;
     |SI nLin3 ! 0;  nCmp1 = nLin3;  |HAZ DFDetalleExenta;  |FINSI;
     |SI nLin4 ! 0;  nCmp1 = nLin4;  |HAZ DFDetalleExenta;  |FINSI;
     |SI nLin5 ! 0;  nCmp1 = nLin5;  |HAZ DFDetalleExenta;  |FINSI;
     |SI nLin6 ! 0;  nCmp1 = nLin6;  |HAZ DFDetalleExenta;  |FINSI;

     aClvPpl    = aClvN3;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO DFDetalleIVA;
     |HAZ SacaNivel;

     aClvPpl    = aClvN4;
     aAgruClv   = "01";
     aContenido = "";
     |HAZ PorClave3;
     aClvN5 = #siim0501#18;  |QBF aClvN5;

     aClvPpl    = aClvN5;
     aAgruClv   = "01";
     aContenido = #siim0003#nCmp2#;
     |HAZ PorClave3;

     aClvPpl    = aClvN5;
     aAgruClv   = "02";
     aContenido = #siim0003#nCmp1#;
     |HAZ PorClave3;

     aClvPpl    = aClvN5;
     aAgruClv   = "03";
     aContenido = #siim0003#nCmp3#;
     |HAZ PorClave3;

     |SI #siim0003#nCmp4# ! 0;
         aClvPpl    = aClvN5;
         aAgruClv   = "04";
         aContenido = #siim0003#nCmp4#;
         |HAZ PorClave3;
     |FINSI;

     |SI #siim0003#nCmp5# ! 0;
         aClvPpl    = aClvN5;
         aAgruClv   = "05";
         aContenido = #siim0003#nCmp5#;
         |HAZ PorClave3;
     |FINSI;

     aClvPpl    = aClvN5;
     aAgruClv   = "06";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO DFSujetaNoExenta;
     nCmp1 = nLin1;  |HAZ SacaNivel;

     aClvPpl    = aClvN2;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;
     aClvN3 = #siim0501#18;  |QBF aClvN3;

     aClvPpl    = aClvN3;
     aAgruClv   = "01";
     aContenido = aNDes;
     |HAZ PorClave3;

     aClvPpl    = aClvN3;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;
     aClvN4 = #siim0501#18;  |QBF aClvN4;

     |SI nLin1 ! 0;  nCmp1 = nLin1;  |HAZ DFDetalleIVA;  |FINSI;
     |SI nLin2 ! 0;  nCmp1 = nLin2;  |HAZ DFDetalleIVA;  |FINSI;
     |SI nLin3 ! 0;  nCmp1 = nLin3;  |HAZ DFDetalleIVA;  |FINSI;
     |SI nLin4 ! 0;  nCmp1 = nLin4;  |HAZ DFDetalleIVA;  |FINSI;
     |SI nLin5 ! 0;  nCmp1 = nLin5;  |HAZ DFDetalleIVA;  |FINSI;
     |SI nLin6 ! 0;  nCmp1 = nLin6;  |HAZ DFDetalleIVA;  |FINSI;

     aClvPpl    = aClvN4;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;

     aClvPpl    = aClvN3;
     aAgruClv   = "03";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO DFNoSujetaBase;
     |HAZ SacaNivel;

     |SI aNDes = "N1";
         aClvPpl    = aClvN2;
         aAgruClv   = "01";
         aContenido = #siim0003#nCmp1#;
         |HAZ PorClave3;
     |FINSI;

     |SI aNDes = "N2";
         aClvPpl    = aClvN2;
         aAgruClv   = "02";
         aContenido = #siim0003#nCmp1#;
         |HAZ PorClave3;
     |FINSI;
|FPRC;

|PROCESO DFNoSujeta;
     aClvPpl    = aClvN1;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;
     aClvN2 = #siim0501#18;  |QBF aClvN2;

     nCmp1 = nLin1;
     |HAZ DFNoSujetaBase;

     |SI nLin2 ! 0;
         nCmp1 = nLin2;
         |HAZ DFNoSujetaBase;
     |FINSI;

     aClvPpl    = aClvN2;
     aAgruClv   = "03";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO DesgloseFactura;
     aDEtiq = "<sii:DesgloseFactura>";
     aHEtiq = "<sii:DesgloseFactura>";
     |HAZ LeeEsquema;
     aClvN1 = aClvPpl;

     |SI nTDesFacSuj = 1;
         aClvPpl    = aClvN1;
         aAgruClv   = "01";
         aContenido = "";
         |HAZ PorClave3;
         aClvN2 = #siim0501#18;  |QBF aClvN2;

         |SI nTDesFacSujEx = 1;
             aTipNiv = " E";  |HAZ SacaDesglose;
             |HAZ DFSujetaExenta;
         |FINSI;

         |SI nTDesFacSujNEx = 1;
             aTipNiv = " S";  |HAZ SacaDesglose;
             |HAZ DFSujetaNoExenta;
         |FINSI;

         aClvPpl    = aClvN2;
         aAgruClv   = "03";
         aContenido = "";
         |HAZ PorClave3;
     |FINSI;

     |SI nTDesFacNSuj = 1;
         aTipNiv = " N";  |HAZ SacaDesglose;
         |HAZ DFNoSujeta;
    |FINSI;

    aDEtiq = "</sii:DesgloseFactura>";
    aHEtiq = "</sii:DesgloseFactura>";
    |HAZ LeeEsquema;
|FPRC;

|PROCESO PRDetalleExenta;
     |HAZ SacaNivel;

     aClvPpl    = aClvN3;
     aAgruClv   = "01";
     aContenido = "";
     |HAZ PorClave3;
     aClvN4 = #siim0501#18;  |QBF aClvN4;

     aClvPpl    = aClvN4;
     aAgruClv   = "01";
     aContenido = aNDes;
     |HAZ PorClave3;

     aClvPpl    = aClvN4;
     aAgruClv   = "02";
     aContenido = #siim0003#nCmp1#;
     |HAZ PorClave3;

     aClvPpl    = aClvN4;
     aAgruClv   = "03";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO PRSujetaExenta;
     aClvPpl    = aClvN2;
     aAgruClv   = "01";
     aContenido = "";
     |HAZ PorClave3;
     aClvN3 = #siim0501#18;  |QBF aClvN3;

     |SI nLin1 ! 0;  nCmp1 = nLin1;  |HAZ PRDetalleExenta;  |FINSI;
     |SI nLin2 ! 0;  nCmp1 = nLin2;  |HAZ PRDetalleExenta;  |FINSI;
     |SI nLin3 ! 0;  nCmp1 = nLin3;  |HAZ PRDetalleExenta;  |FINSI;
     |SI nLin4 ! 0;  nCmp1 = nLin4;  |HAZ PRDetalleExenta;  |FINSI;
     |SI nLin5 ! 0;  nCmp1 = nLin5;  |HAZ PRDetalleExenta;  |FINSI;
     |SI nLin6 ! 0;  nCmp1 = nLin6;  |HAZ PRDetalleExenta;  |FINSI;

     aClvPpl    = aClvN3;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO PRDetalleIVA;
     |HAZ SacaNivel;

     aClvPpl    = aClvN4;
     aAgruClv   = "01";
     aContenido = "";
     |HAZ PorClave3;
     aClvN5 = #siim0501#18;  |QBF aClvN5;

     aClvPpl    = aClvN5;
     aAgruClv   = "01";
     aContenido = #siim0003#nCmp2#;
     |HAZ PorClave3;

     aClvPpl    = aClvN5;
     aAgruClv   = "02";
     aContenido = #siim0003#nCmp1#;
     |HAZ PorClave3;

     aClvPpl    = aClvN5;
     aAgruClv   = "03";
     aContenido = #siim0003#nCmp3#;
     |HAZ PorClave3;

     aClvPpl    = aClvN5;
     aAgruClv   = "04";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO PRSujetaNoExenta;
     nCmp1 = nLin1;  |HAZ SacaNivel;

     aClvPpl    = aClvN2;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;
     aClvN3 = #siim0501#18;  |QBF aClvN3;

     aClvPpl    = aClvN3;
     aAgruClv   = "01";
     aContenido = aNDes;
     |HAZ PorClave3;

     aClvPpl    = aClvN3;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;
     aClvN4 = #siim0501#18;  |QBF aClvN4;

     |SI nLin1 ! 0;  nCmp1 = nLin1;  |HAZ PRDetalleIVA;  |FINSI;
     |SI nLin2 ! 0;  nCmp1 = nLin2;  |HAZ PRDetalleIVA;  |FINSI;
     |SI nLin3 ! 0;  nCmp1 = nLin3;  |HAZ PRDetalleIVA;  |FINSI;
     |SI nLin4 ! 0;  nCmp1 = nLin4;  |HAZ PRDetalleIVA;  |FINSI;
     |SI nLin5 ! 0;  nCmp1 = nLin5;  |HAZ PRDetalleIVA;  |FINSI;
     |SI nLin6 ! 0;  nCmp1 = nLin6;  |HAZ PRDetalleIVA;  |FINSI;

     aClvPpl    = aClvN4;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;

     aClvPpl    = aClvN3;
     aAgruClv   = "03";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO PRNoSujetaBase;
     |HAZ SacaNivel;

     |SI aNDes = "N1";
         aClvPpl    = aClvN2;
         aAgruClv   = "01";
         aContenido = #siim0003#nCmp1#;
         |HAZ PorClave3;
     |FINSI;

     |SI aNDes = "N2";
         aClvPpl    = aClvN2;
         aAgruClv   = "02";
         aContenido = #siim0003#nCmp1#;
         |HAZ PorClave3;
     |FINSI;
|FPRC;

|PROCESO PRNoSujeta;
     aClvPpl    = aClvN1;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;
     aClvN2 = #siim0501#18;  |QBF aClvN2;

     nCmp1 = nLin1;
     |HAZ PRNoSujetaBase;

     |SI nLin2 ! 0;
         nCmp1 = nLin2;
         |HAZ PRNoSujetaBase;
     |FINSI;

     aClvPpl    = aClvN2;
     aAgruClv   = "03";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO Prestaciones;
     aDEtiq = "<sii:PrestacionServicios>";
     aHEtiq = "<sii:PrestacionServicios>";
     |HAZ LeeEsquema;
     aClvN1 = aClvPpl;

     |SI nTDesTOpPrsSuj = 1;
         aClvPpl    = aClvN1;
         aAgruClv   = "01";   || Sujeta
         aContenido = "";
         |HAZ PorClave3;
         aClvN2 = #siim0501#18;  |QBF aClvN2;

         |SI nTDesTOpPrsSujEx = 1;
             aTipNiv = "PE";  |HAZ SacaDesglose;
             |HAZ PRSujetaExenta;
         |FINSI;

         |SI nTDesTOpPrsSujNEx = 1;
             aTipNiv = "PS";  |HAZ SacaDesglose;
             |HAZ PRSujetaNoExenta;
         |FINSI;

         aClvPpl    = aClvN2;
         aAgruClv   = "03";   || FinSujeta
         aContenido = "";
         |HAZ PorClave3;
     |FINSI;

     |SI nTDesTOpPrsNSuj = 1;
         aTipNiv = "PN";  |HAZ SacaDesglose;
         |HAZ PRNoSujeta;
     |FINSI;

     aDEtiq = "</sii:PrestacionServicios>";
     aHEtiq = "</sii:PrestacionServicios>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO ENDetalleExenta;
     |HAZ SacaNivel;

     aClvPpl    = aClvN3;
     aAgruClv   = "01";
     aContenido = "";
     |HAZ PorClave3;
     aClvN4 = #siim0501#18;  |QBF aClvN4;

     aClvPpl    = aClvN4;
     aAgruClv   = "01";
     aContenido = aNDes;
     |HAZ PorClave3;

     aClvPpl    = aClvN4;
     aAgruClv   = "02";
     aContenido = #siim0003#nCmp1#;
     |HAZ PorClave3;

     aClvPpl    = aClvN4;
     aAgruClv   = "03";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO ENSujetaExenta;
     aClvPpl    = aClvN2;
     aAgruClv   = "01";
     aContenido = "";
     |HAZ PorClave3;
     aClvN3 = #siim0501#18;  |QBF aClvN3;

     |SI nLin1 ! 0;  nCmp1 = nLin1;  |HAZ PRDetalleExenta;  |FINSI;
     |SI nLin2 ! 0;  nCmp1 = nLin2;  |HAZ PRDetalleExenta;  |FINSI;
     |SI nLin3 ! 0;  nCmp1 = nLin3;  |HAZ PRDetalleExenta;  |FINSI;
     |SI nLin4 ! 0;  nCmp1 = nLin4;  |HAZ PRDetalleExenta;  |FINSI;
     |SI nLin5 ! 0;  nCmp1 = nLin5;  |HAZ PRDetalleExenta;  |FINSI;
     |SI nLin6 ! 0;  nCmp1 = nLin6;  |HAZ PRDetalleExenta;  |FINSI;

     aClvPpl    = aClvN3;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO ENDetalleIVA;
     |HAZ SacaNivel;

     aClvPpl    = aClvN4;
     aAgruClv   = "01";
     aContenido = "";
     |HAZ PorClave3;
     aClvN5 = #siim0501#18;  |QBF aClvN5;

     aClvPpl    = aClvN5;
     aAgruClv   = "01";
     aContenido = #siim0003#nCmp2#;
     |HAZ PorClave3;

     aClvPpl    = aClvN5;
     aAgruClv   = "02";
     aContenido = #siim0003#nCmp1#;
     |HAZ PorClave3;

     aClvPpl    = aClvN5;
     aAgruClv   = "03";
     aContenido = #siim0003#nCmp3#;
     |HAZ PorClave3;

     |SI #siim0003#nCmp4# ! 0;
         aClvPpl    = aClvN5;
         aAgruClv   = "04";
         aContenido = #siim0003#nCmp4#;
         |HAZ PorClave3;
     |FINSI;

     |SI #siim0003#nCmp5# ! 0;
         aClvPpl    = aClvN5;
         aAgruClv   = "05";
         aContenido = #siim0003#nCmp5#;
         |HAZ PorClave3;
     |FINSI;

     aClvPpl    = aClvN5;
     aAgruClv   = "06";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO ENSujetaNoExenta;
     nCmp1 = nLin1;  |HAZ SacaNivel;

     aClvPpl    = aClvN2;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;
     aClvN3 = #siim0501#18;  |QBF aClvN3;

     aClvPpl    = aClvN3;
     aAgruClv   = "01";
     aContenido = aNDes;
     |HAZ PorClave3;

     aClvPpl    = aClvN3;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;
     aClvN4 = #siim0501#18;  |QBF aClvN4;

     |SI nLin1 ! 0;  nCmp1 = nLin1;  |HAZ ENDetalleIVA;  |FINSI;
     |SI nLin2 ! 0;  nCmp1 = nLin2;  |HAZ ENDetalleIVA;  |FINSI;
     |SI nLin3 ! 0;  nCmp1 = nLin3;  |HAZ ENDetalleIVA;  |FINSI;
     |SI nLin4 ! 0;  nCmp1 = nLin4;  |HAZ ENDetalleIVA;  |FINSI;
     |SI nLin5 ! 0;  nCmp1 = nLin5;  |HAZ ENDetalleIVA;  |FINSI;
     |SI nLin6 ! 0;  nCmp1 = nLin6;  |HAZ ENDetalleIVA;  |FINSI;

     aClvPpl    = aClvN4;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;

     aClvPpl    = aClvN3;
     aAgruClv   = "03";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO ENNoSujetaBase;
     |HAZ SacaNivel;

     |SI aNDes = "N1";
         aClvPpl    = aClvN2;
         aAgruClv   = "01";
         aContenido = #siim0003#nCmp1#;
         |HAZ PorClave3;
     |FINSI;

     |SI aNDes = "N2";
         aClvPpl    = aClvN2;
         aAgruClv   = "02";
         aContenido = #siim0003#nCmp1#;
         |HAZ PorClave3;
     |FINSI;
|FPRC;

|PROCESO ENNoSujeta;
     aClvPpl    = aClvN1;
     aAgruClv   = "02";
     aContenido = "";
     |HAZ PorClave3;
     aClvN2 = #siim0501#18;  |QBF aClvN2;

     nCmp1 = nLin1;
     |HAZ ENNoSujetaBase;

     |SI nLin2 ! 0;
         nCmp1 = nLin2;
         |HAZ ENNoSujetaBase;
     |FINSI;

     aClvPpl    = aClvN2;
     aAgruClv   = "03";
     aContenido = "";
     |HAZ PorClave3;
|FPRC;

|PROCESO Entregas;
     aDEtiq = "<sii:Entrega>";
     aHEtiq = "<sii:Entrega>";
     |HAZ LeeEsquema;
     aClvN1 = aClvPpl;

     |SI nTDesTOpEntSuj = 1;
         aClvPpl    = aClvN1;
         aAgruClv   = "01";   || Sujeta
         aContenido = "";
         |HAZ PorClave3;
         aClvN2 = #siim0501#18;  |QBF aClvN2;

         |SI nTDesTOpEntSujEx = 1;
             aTipNiv = "EE";  |HAZ SacaDesglose;
             |HAZ ENSujetaExenta;
         |FINSI;

         |SI nTDesTOpEntSujNEx = 1;
             aTipNiv = "ES";  |HAZ SacaDesglose;
             |HAZ ENSujetaNoExenta;
         |FINSI;

         aClvPpl    = aClvN2;
         aAgruClv   = "03";   || FinSujeta
         aContenido = "";
         |HAZ PorClave3;
     |FINSI;

     |SI nTDesTOpEntNSuj = 1;
         aTipNiv = "EN";  |HAZ SacaDesglose;
         |HAZ ENNoSujeta;
     |FINSI;

     aDEtiq = "</sii:Entrega>";
     aHEtiq = "</sii:Entrega>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO DesgloseTipoOperacion;
     aDEtiq = "<sii:DesgloseTipoOperacion>";
     aHEtiq = "<sii:DesgloseTipoOperacion>";
     |HAZ LeeEsquema;

     |SI nTDesTOpPrs = 1;
         |HAZ Prestaciones;
     |FINSI;

     |SI nTDesTOpEnt = 1;
         |HAZ Entregas;
     |FINSI;

     aDEtiq = "</sii:DesgloseTipoOperacion>";
     aHEtiq = "</sii:DesgloseTipoOperacion>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO TipoDesglose;
     aDesgl = #siim0003#14;  |QBF aDesgl;
     nBases = #siim0003#23 + #siim0003#29 + #siim0003#35 + #siim0003#41;
     nBases = nBases + #siim0003#47 + #siim0003#53;
     |SI nBases = 0;  |Y aDesgl = "";
         |ACABA;
     |FINSI;

     aTDes1 = #siim0003#13 % 101;
     aNDes1 = #siim0003#14 % 102;
     aTDes2 = #siim0003#13 % 201;
     aNDes2 = #siim0003#14 % 302;
     aTDes3 = #siim0003#13 % 301;
     aNDes3 = #siim0003#14 % 502;
     aTDes4 = #siim0003#13 % 401;
     aNDes4 = #siim0003#14 % 702;
     aTDes5 = #siim0003#13 % 501;
     aNDes5 = #siim0003#14 % 902;
     aTDes6 = #siim0003#13 % 601;
     aNDes6 = #siim0003#14 % 1102;

     nTDesFac          = 0;
     nTDesFacSuj       = 0;
     nTDesFacSujEx     = 0;
     nTDesFacSujNEx    = 0;
     nTDesFacNSuj      = 0;

     nTDesTOpPrs       = 0;
     nTDesTOpPrsSuj    = 0;
     nTDesTOpPrsSujEx  = 0;
     nTDesTOpPrsSujNEx = 0;
     nTDesTOpPrsNSuj   = 0;

     nTDesTOpEnt       = 0;
     nTDesTOpEntSuj    = 0;
     nTDesTOpEntSujEx  = 0;
     nTDesTOpEntSujNEx = 0;
     nTDesTOpEntNSuj   = 0;

     |PARA nCmp1 = 23;  |SI nCmp1 [ 53;  |HACIENDO nCmp1 = nCmp1 + 6;
           |SI nCmp1 = 23; aTDes = aTDes1;  aNDes = aNDes1 % 101;  |FINSI;
           |SI nCmp1 = 29; aTDes = aTDes2;  aNDes = aNDes2 % 101;  |FINSI;
           |SI nCmp1 = 35; aTDes = aTDes3;  aNDes = aNDes3 % 101;  |FINSI;
           |SI nCmp1 = 41; aTDes = aTDes4;  aNDes = aNDes4 % 101;  |FINSI;
           |SI nCmp1 = 47; aTDes = aTDes5;  aNDes = aNDes5 % 101;  |FINSI;
           |SI nCmp1 = 53; aTDes = aTDes6;  aNDes = aNDes6 % 101;  |FINSI;

           |SI aNDes ! " ";
                |SI aTDes = " ";
                   nTDesFac = 1;

                   |SI aNDes = "E";
                       nTDesFacSuj   = 1;
                       nTDesFacSujEx = 1;
                   |FINSI;

                   |SI aNDes = "S";
                       nTDesFacSuj    = 1;
                       nTDesFacSujNEx = 1;
                   |FINSI;

                   |SI aNDes = "N";
                       nTDesFacNSuj = 1;
                   |FINSI;
               |FINSI;

               |SI aTDes = "P";
                   nTDesTOpPrs = 1;

                   |SI aNDes = "E";
                       nTDesTOpPrsSuj   = 1;
                       nTDesTOpPrsSujEx = 1;
                   |FINSI;

                   |SI aNDes = "S";
                       nTDesTOpPrsSuj    = 1;
                       nTDesTOpPrsSujNEx = 1;
                   |FINSI;

                   |SI aNDes = "N";
                       nTDesTOpPrsNSuj = 1;
                   |FINSI;
               |FINSI;

               |SI aTDes = "E";
                   nTDesTOpEnt = 1;

                   |SI aNDes = "E";
                       nTDesTOpEntSuj   = 1;
                       nTDesTOpEntSujEx = 1;
                   |FINSI;

                   |SI aNDes = "S";
                       nTDesTOpEntSuj    = 1;
                       nTDesTOpEntSujNEx = 1;
                   |FINSI;

                   |SI aNDes = "N";
                       nTDesTOpEntNSuj = 1;
                   |FINSI;
               |FINSI;
           |FINSI;
     |SIGUE;

     aDEtiq = "<sii:TipoDesglose>";
     aHEtiq = "<sii:TipoDesglose>";
     |HAZ LeeEsquema;

     |SI nTDesFac = 1;
         |HAZ DesgloseFactura;
     |FINSI;

     |SI nTDesTOpPrs = 1;  |O nTDesTOpEnt = 1;
         |HAZ DesgloseTipoOperacion;
     |FINSI;

     aDEtiq = "</sii:TipoDesglose>";
     aHEtiq = "</sii:TipoDesglose>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO FinalFExpedida;
     aDEtiq = "</siiLR:FacturaExpedida>";
     aHEtiq = "</siiLR:FacturaExpedida>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO CambiaValores;
     #siim0003#7  = "16";
     #siim0003#8  = "";
     #siim0003#9  = "";
     #siim0003#13 = "";

     aAlfa1       = #siim0003#14 % 102;
     aAlfa2       = #siim0003#14 % 302;
     aAlfa3       = #siim0003#14 % 502;
     aAlfa4       = #siim0003#14 % 702;
     aAlfa5       = #siim0003#14 % 902;
     aAlfa6       = #siim0003#14 % 1102;

     |SI aAlfa1 ! "  ";  aAlfa1 = "S1";  |FINSI;
     |SI aAlfa2 ! "  ";  aAlfa1 = "S1";  |FINSI;
     |SI aAlfa3 ! "  ";  aAlfa1 = "S1";  |FINSI;
     |SI aAlfa4 ! "  ";  aAlfa1 = "S1";  |FINSI;
     |SI aAlfa5 ! "  ";  aAlfa1 = "S1";  |FINSI;
     |SI aAlfa6 ! "  ";  aAlfa1 = "S1";  |FINSI;

     #siim0003#14 = aAlfa1 + aAlfa2 + aAlfa3 + aAlfa4 + aAlfa5 + aAlfa6;

     #siim0003#62 = "Registros del primer semestre";
     #siim0003#63 = "";
     #siim0003#64 = "";
|FPRC;

|PROCESO siim0003;
     |SI nPasada = 0;
         |SI #siim0003#103 = "C";  |O #siim0003#103 = "A";
             |ACABA;
         |FINSI;

         |SI #siim0003#21 > fFechaSys;
             |ACABA;
         |FINSI;

         nNumReg = nNumReg + 1;

         |ACABA;
     |FINSI;

     |SI #siim0003#103 = "C";  |O #siim0003#103 = "A";
         |ACABA;
     |FINSI;

     |SI #siim0003#21 > fFechaSys;
         |ACABA;
     |FINSI;

     |SI #siim0003#3 = 2017;
         |SI #siim0003#4 [ 6;
             |HAZ CambiaValores;
         |FINSI;
     |FINSI;

     |HAZ InicioFactura;
     |HAZ PeriodoLiquidacion;
     |HAZ IDFactura;
     |HAZ InicioFExpedida;
     |HAZ TipoFactura;
     |HAZ TipoRectificativa;
     |HAZ FacturasAgrupadas;
     |HAZ FacturasRectificadas;
     |HAZ ImporteRectificacion;
     |HAZ FechaOperacion;
     |HAZ TrascendenciaAdicional;
     |HAZ RegistroAcuerdo;
     |HAZ ImporteTotal;
     |HAZ BaseACoste;
     |HAZ DescriOperacion;
     |HAZ RefExterna;
     |HAZ FacturaSimplifArt72_73;
     |HAZ EntidadSucedida;
     |HAZ RegPrevio;
     |HAZ Macrodato;
     |HAZ DatosInmuebles;
     |HAZ TransmisionSujeto;
     |HAZ EmitidaPorTerceros;
     |HAZ TerceraYSexta;
     |HAZ VariosDestinatarios;
     |HAZ Cupon;
     |HAZ FacturaSinIdentificar;
     |HAZ Contraparte;
     |HAZ TipoDesglose;
     |HAZ FinalFExpedida;
     |HAZ FinalFactura;

     nUltReg = #siim0003#2;
     nGrab   = nGrab + 1;

     |SI nGrab = nTope;
         |ERROR10;
     |FINSI;

     nPul = nGrab $ 100;
     |SI nPul = 0;
         |PULSATECLA;
     |FINSI;
|FPRC;

|DEFBUCLE siim0003;
     #siim0003#1;
     ;
     #siim0002#0, #siim0002#1,  nDReg;
     #siim0002#0, #siim0002#1, 999999;
     ;
     NULL, siim0003;
|FIN;

|PROCESO CabXml;
     aAlfa = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "UTF-8" + &34 + "?>";
     |HAZ GrabaFic;

     aAlfa = "<soapenv:Envelope xmlns:soapenv=" + &34;
     aAlfa = aAlfa + "http://schemas.xmlsoap.org/soap/envelope/" + &34;
     |HAZ GrabaFic;

     aAlfa = "xmlns:siiLR=" + &34 + "https://www2.agenciatributaria.gob.es/";
     aAlfa = aAlfa + "static_files/common/internet/dep/aplicaciones/es/aeat/ssii/fact/ws/SuministroLR.xsd" + &34;
     |HAZ GrabaFic;

     aAlfa = "xmlns:sii=" + &34 + "https://www2.agenciatributaria.gob.es/static_files/";
     aAlfa = aAlfa + "common/internet/dep/aplicaciones/es/aeat/ssii/fact/ws/SuministroInformacion.xsd" + &34 + ">";
     |HAZ GrabaFic;

     aAlfa = "<soapenv:Header/>";
     |HAZ GrabaFic;

     aAlfa = "   <soapenv:Body>";
     |HAZ GrabaFic;

     aAlfa = "      <siiLR:SuministroLRFacturasEmitidas>";
     |HAZ GrabaFic;

     aDEtiq = "<sii:Cabecera>";
     aHEtiq = "</sii:Cabecera>";
     |HAZ LeeEsquema;
|FPRC;

|PROCESO PieXml;
     aAlfa = "      </siiLR:SuministroLRFacturasEmitidas>";
     |HAZ GrabaFic;

     aAlfa = "   </soapenv:Body>";
     |HAZ GrabaFic;

     aAlfa = "</soapenv:Envelope>";
     |HAZ GrabaFic;
|FPRC;

|PROCESO Ficheros;
     nDReg   = 1;
     nUltReg = 0;

     |PARA nFiche = 1;  |SI nFiche [ nVeces;  |HACIENDO nFiche = nFiche + 1;
           |SI nVeces > 1;
               aAlfa = "0000Preparando el env¡o " + nFiche;
               |MENAV aAlfa;
           |FINSI;

           |HORA aHora;

           aFicXml = ("00000" + #siim0002#0) % -105;
           aFicXml = aFicXml + (("0000000000" + #siim0002#1) % -110);
           aFicXml = aFicXml + fFechaSys % -104;
           aFicXml = aFicXml + fFechaSys % 402;
           aFicXml = aFicXml + fFechaSys % 102;
           aFicXml = aFicXml + aHora % 102;
           aFicXml = aFicXml + aHora % 402;
           aFicXml = aFicXml + aHora % 702;

           aFicRes = aFicXml + ".res";
           aFicXml = aFicXml + ".xml";

           aAbreXml = aPathTmp + aFicXml;

           |XABRE "WB", aAbreXml, nHandle;
           |HAZ CabXml;

           |SI nUltReg ! 0;
               nDReg = nUltReg + 1;
           |FINSI;

           nGrab   = 0;
           nPasada = 1;
           |BUCLE siim0003;

           |HAZ PieXml;
           |XCIERRA nHandle;

           |HAZ EnviaLote;
     |SIGUE;

     |SELECT #2#siim0003;
     |BUCLE siiw0203;

     |SI aModoImp = "SIIBASE";
         |CONSULTA_CLAVE #1#siiw0203;
     |FINSI;
|FPRC;

|PROCESO AbreVtn;
     |VENTANA 0501, 0540, -1, 16, "Realizando el env¡o";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;
|FPRC;

|PROCESO CierraVtn;
     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;
|FPRC;

|PROCESO SIIBASE;
     |SI #siim0002#6 = 0;
         |MENAV "0000Lote sin registros";
         |ACABA;
     |FINSI;

     |SI #siim0002#6 = #siim0002#8;
         |MENAV "0000El lote no tiene registros para enviar";
         |ACABA;
     |FINSI;

     |VENTANA 0501, 3599, -1, 0, "";
     n2Vent = FSalida;
     |PTEC 802;  |PAUSA;

     |SUB_EJECUTA "siiz0011";

     |FINVENTANA n2Vent;

     |SI eaCert = "";
         |MENAV "0000Proceso cancelado";
         |ACABA;
     |FINSI;

     |HAZ AbreVtn;
     |HAZ Ficheros;
     |HAZ CierraVtn;
|FPRC;

|PROCESO SIIBOX;
     |HAZ Ficheros;
|FPRC;

|PROGRAMA;
     #siim0002#0 = enEmp;
     #siim0002#1 = enLot;
     |LEE 000#siim0002.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     nNumReg = 0;
     nPasada = 0;  |BUCLE siim0003;
     |SI nNumReg = 0;
         |SI aModoImp = "SIIBASE";
             |MENAV "0000El lote no tiene registros para enviar";
         |FINSI;

         |ACABA;
     |FINSI;

     nTope  = 10000;
     nVeces = ((nNumReg / nTope) + .4999) ! 0;

     |SI nVeces > 1;
         aAlfa = "0000Lote con " + nNumReg + " registros, solo se pueden enviar ";
         aAlfa = aAlfa + nTope + " por env¡o, por lo que haremos " + nVeces  + " env¡os";
         |MENAV aAlfa;
     |FINSI;

     |SI aModoImp = "SIIBASE";
         |HAZ SIIBASE;
     |FINSI;

     |SI aModoImp = "SIIBOX";  |O aModoImp = "SIIGEN";
         |HAZ SIIBOX;
     |FINSI;
|FPRO;

|PROCESO T80;  |TIPO 80;
     aModoImp  = PARAMETRO;  |QBF aModoImp;
     fFechaSys = ~;

     |HAZ LeeUnidadBasico;
     |HAZ CargaColores;

     |ABRE #siim0000;
     |LEE 000#siim0000.p;
     |CIERRA #siim0000;

     |ABRE #siim0500;
     |LEE 000#siim0500.u;
     |CIERRA #siim0500;

     |ABRE #siim0001;
     |SELECT #1#siim0001;
     #siim0001#0 = enEmp;
     |LEE 000#siim0001.=;
     |SI FSalida ! 0;  |DDEFECTO #siim0001;  |FINSI;
     |CIERRA #siim0001;

     eaCodNif = #siim0001#2;
     |HAZ LeeNif;  |QBF eaNomNif;
     |SI eaNomNif ! "";
         #siim0001#1 = eaNomNif;
     |FINSI;

     aH60 = "z" * 60;
     aEsq = "11";

     aIP  = "";
     |IP_REMOTO aIP;

     |DBASE aBaseSII;  |QBF aBaseSII;
     aPathTmp = aBaseSII + "tmp";                    |MKDIR aPathTmp;
     aPathTmp = aBaseSII + "tmp/" + Usuario;         |MKDIR aPathTmp;
     aPathTmp = aBaseSII + "tmp/" + Usuario + "/";

     aPathPlu = aBaseSII + "plugins/";

     aPathSII = eaUnidadBasico + "\documentos";   |RMKDIR aPathSII;
     aPathSII = aPathSII + "\siibase";            |RMKDIR aPathSII;
     aPathSII = aPathSII + "\";

     aAlfa = aPathTmp + "*.xml";
     |_PDIR aAlfa;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |FBORRA aAlfa;

          |_SDIR aAlfa;
     |SIGUE;

     aAlfa = aPathSII + "*.*";
     |R_PDIR aAlfa;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          aExt = aAlfa % -103;
          |SI aExt = "res";  |O aExt = "xml";  |O aExt = "bat";
              |RFBORRA aAlfa;
          |FINSI;

          |R_SDIR aAlfa;
     |SIGUE;

     aFicTmp = "siiw0203" + Usuario;  |NOME_DAT #siiw0203#aFicTmp#;
     |ABRE #siiw0203;  |CIERRA #siiw0203;  |DELINDEX #siiw0203;

     |SI aModoImp = "SIIGEN";
         aFicTmp = "siiw0207" + Usuario;  |NOME_DAT #siiw0207#aFicTmp#;
         |ABRE #siiw0207;
     |FINSI;

     |HAZ CargaUrl;

     |ABRET #siim0002;
     |ABRET #siim0003;
     |ABRET #siim0007;
     |ABRET #siim0054;
     |ABRET #siim0501;
     |ABRET #siiw0203;
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #siim0002;
     |CIERRAT #siim0003;
     |CIERRAT #siim0007;
     |CIERRAT #siim0054;
     |CIERRAT #siim0501;
     |CIERRAT #siiw0203;

     |SI aModoImp = "SIIGEN";
         |CIERRA #siiw0207;
     |FINSI;

     |DELINDEX #siiw0203;

     |SUB_EJECUTA "siiz0002;REFRESCA";
|FPRC;
