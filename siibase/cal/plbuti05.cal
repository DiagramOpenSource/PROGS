|FICHEROS;
     siim1001;
|FIN;

|VARIABLES;
     nHandle             = 0;
     nConta              = 0;
     nPausa              = 0;

     aAlfa               = "";
     aOri                = "";
     aDes                = "";
     aDocRemoto          = "";
     aDocServidor        = "";
     aIP                 = "";
     aAbre               = "";
     aEjec               = "";
     aPathExe            = "";
     aPathPlu            = "";
     aPathTmp            = "";
     aPathSII            = "";
     aBaseSII            = "";

  {1}aConte              = "";

     &eaUnidadBasico     = "";
     &eaDSMAC            = "";
     &enOk               = 0;
|FIN;

|PROCESO LeeUnidadBasico;
     aConte = "";
     |ESPECIFICA "RBASS", aConte;
     eaUnidadBasico = (aConte1 % 102) > "";

     aAlfa = eaUnidadBasico % -101;
     |SI aAlfa ! ":";
         eaUnidadBasico = "";
     |FINSI;
|FPRC;

|PROCESO Ds_SII;
     enOk = 0;

     |DBASE aBaseSII;  |QBF aBaseSII;
     aPathTmp = aBaseSII + "tmp/" + Usuario + "/";
     aPathPlu = aBaseSII + "plugins/";
     aPathSII = eaUnidadBasico + "\documentos\siibase\";

     aDocRemoto   = "";
     aDocServidor = "";

     aConte1      = aPathPlu + "ds_sii.exe";
     |ESPECIFICA "MD5", aConte;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aConte1      = aPathSII + "ds_sii.exe";
     |ESPECIFICA "REMOTOMD5", aConte;
     aDocRemoto   = FSalida;  |QBF aDocRemoto;

     aIP = "";
     |IP_REMOTO aIP;  |QBT aIP;

     |SI aDocRemoto ! aDocServidor;
         aOri = aPathPlu + "ds_sii.exe";
         aDes = aPathSII + "ds_sii.exe";

         |SI aIP = "";
             |COPIA_FICHERO aOri, aDes;
         |SINO;
             |ENVIA_FICHERO aOri, aDes;
         |FINSI;

         aAlfa = aPathSII + "ds_sii.exe";
         |XABRE "EC", aAlfa, 0;
         |SI FSalida < 0;
             |ACABA;
         |FINSI;
     |FINSI;

     aDocRemoto   = "";
     aDocServidor = "";

     aConte1      = aPathPlu + "dsmini.exe";
     |ESPECIFICA "MD5", aConte;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aConte1    = aPathSII + "dsmini.exe";
     |ESPECIFICA "REMOTOMD5", aConte;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     |SI aDocRemoto ! aDocServidor;
         aOri = aPathPlu + "dsmini.exe";
         aDes = aPathSII + "dsmini.exe";

         |SI aIP = "";
             |COPIA_FICHERO aOri, aDes;
         |SINO;
             |ENVIA_FICHERO aOri, aDes;
         |FINSI;
     |FINSI;

     enOk = 1;
|FPRC;

|PROCESO TraeDSMAC;
     aAlfa = eaUnidadBasico + "\documentos\siibase";          |RMKDIR aAlfa;
     aAlfa = eaUnidadBasico + "\documentos\siibase\dsmac";    |RMKDIR aAlfa;

     |DBASE aAlfa;   |QBF aAlfa;
     aAlfa     = aAlfa + "plugins/";
     aOri   = aAlfa + "dsmac.exe";
     aDes  = eaUnidadBasico + "\documentos\siibase\dsmac\dsmac.exe";

     aConte1 = aDes;
     |ESPECIFICA "REMOTOMD5", aConte;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aConte1 = aOri;
     |ESPECIFICA "MD5", aConte;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIP = "";
     |IP_REMOTO aIP;  |QBT aIP;

     |SI aDocRemoto ! aDocServidor;
         |SI aIP ! "";
             |ENVIA_FICHERO aOri, aDes;
         |SINO;
             |COPIA_FICHERO aOri, aDes;
         |FINSI;
     |FINSI;

     |XABRE "EC", aDes, nHandle;
     |SI FSalida < 0;
         |SI aIP ! "";
             |ENVIA_FICHERO aOri, aDes;
         |SINO;
             |COPIA_FICHERO aOri, aDes;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO TraeDSMINI;
     |DBASE aAlfa;   |QBF aAlfa;
     aAlfa     = aAlfa + "plugins/";
     aOri   = aAlfa + "dsmini.exe";
     aDes  = eaUnidadBasico + "\documentos\siibase\dsmini.exe";

     aConte1 = aDes;
     |ESPECIFICA "REMOTOMD5", aConte;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aConte1 = aOri;
     |ESPECIFICA "MD5", aConte;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIP = "";
     |IP_REMOTO aIP;  |QBT aIP;

     |SI aDocRemoto ! aDocServidor;
         |SI aIP ! "";
             |ENVIA_FICHERO aOri, aDes;
         |SINO;
             |COPIA_FICHERO aOri, aDes;
         |FINSI;
     |FINSI;

     |XABRE "EC", aDes, nHandle;
     |SI FSalida < 0;
         |SI aIP ! "";
             |ENVIA_FICHERO aOri, aDes;
         |SINO;
             |COPIA_FICHERO aOri, aDes;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO CargaMac;
     |SI eaDSMAC ! "";  |ACABA;  |FINSI;

     |HAZ LeeUnidadBasico;

     |HAZ TraeDSMAC;
     |HAZ TraeDSMINI;

     aAbre    = eaUnidadBasico + "\documentos\siibase\dsmac\dsmac.txt";  |RFBORRA aAbre;

     aAbre = eaUnidadBasico + "\documentos\siibase\ejecuta.bat";
     |XABRE "WBC", aAbre, nHandle;

     aAlfa = aEjec + eaUnidadBasico + "\documentos\siibase\dsmac\dsmac ";
     aAlfa = aAlfa + eaUnidadBasico + "\documentos\siibase\dsmac\dsmac.txt";
     |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;

     aEjec = eaUnidadBasico + "\documentos\siibase\dsmini " + aAbre;
     |RSYSTEM aEjec;

     aAbre  = eaUnidadBasico + "\documentos\siibase\dsmac\dsmac.txt";
     nConta = 0;
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aAbre, nHandle;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             nConta = nConta + 1;
             |SI nConta > 100;
                 |SAL;
             |FINSI;

             |PULSATECLA;
     |SIGUE;

     eaDSMAC   = "";
     aAbre    = eaUnidadBasico + "\documentos\siibase\dsmac\dsmac.txt";
     |XABRE "CU", aAbre, nHandle;
     |SI FSalida < 0;   |ACABA;  |FINSI;

     |XLEE nHandle, 250, eaDSMAC;
     |SI FSalida < 0
         eaDSMAC   = "";
     |FINSI;
     |XCIERRA nHandle;

     |QBF eaDSMAC;

     aAlfa = eaUnidadBasico + "\documentos\siibase\ejecuta.bat";  |RFBORRA aAlfa;
     aAlfa = eaUnidadBasico + "\documentos\siibase\dsmac.txt";  |RFBORRA aAlfa;
|FPRC;

|PROCESO CogeMac;
     |HAZ CargaMac;

     |ABRE #siim1001;
     #siim1001#0 = eaDSMAC;
     |LEE 000#siim1001.=;
     |SI FSalida = 0;
         |CIERRA #siim1001;
         |ACABA;
     |FINSI;

     #siim1001#0 = aIP;
     |LEE 000#siim1001.=;
     |SI FSalida = 0;
         |DDEFECTO #siim1001;
         #siim1001#0 = eaDSMAC;
         |GRABA 020#siim1001.n;
         |LIBERA #siim1001;
     |FINSI;
     |CIERRA #siim1001;
|FPRC;

|PROCESO TraeDslistacerti;
     aPathExe = eaUnidadBasico + "\documentos\siibase\dsmac\";

     |DBASE aPathPlu;  |QBT aPathPlu;
     aPathPlu = aPathPlu + "plugins/";

     aOri  = aPathPlu + "ds_listacerti.exe";
     aDes = aPathExe + "ds_listacerti.exe";

     aConte1 = aDes;
     |ESPECIFICA "REMOTOMD5", aConte;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aConte1 = aOri;
     |ESPECIFICA "MD5", aConte;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIP = "";
     |IP_REMOTO aIP;  |QBT aIP;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIP ! "";
             |ENVIA_FICHERO aOri, aDes;
         |SINO;
             |COPIA_FICHERO aOri, aDes;
         |FINSI;
     |FINSI;
|FPRC;
