|FICHEROS;
     siim0000;
     siim0001;
     siim0002;
     siim0003;
     siim0004;
     siim0005;
     siim0006;
     siim0007;
     siim0008;
     siim0009;
     siim0010;
     siim0101;

     agifigen@;
     agicen14@;
     canempre@;

     siiw0001;
     siiw0008;
     siiw0011,MANTE;
     siiw0014,MANTE;

     consult@;
|FIN;

|VARIABLES;
     n0Vent              = 0;
     n1Vent              = 0;
     n2Vent              = 0;
     nGrid1              = -1;
     nGrid2              = -1;
     nTree               = -1;
     nApl                = -1;
     nCamb               = -1;

     nBtnBox             = -1;
     nBtnUtil            = -1;
     nBtnEmp             = -1;
     nBtnDesa            = -1;
     nBtnCam             = -1;
     nBtnExc             = -1;
     nBtnCon             = -1;
     nBtnEnv             = -1;

     nBtnAcce            = 0;
     nBtnNLot            = 0;
     nBtnBLot            = 0;
     nBtnFact            = 0;
     nBtnEstd            = 0;
     nRango              = 0;
     nEje                = 0;
     nPer                = 0;
     nLot                = 0;
     nOk                 = 0;
     nLong               = 0;
     nCarac              = 0;
     nPos                = 0;
     nHandle             = 0;
     nPtec               = 1;
     nSeg                = 0;
     nOpcion             = 0;
     nFSalida            = 0;
     nCmp                = 0;
     nEmp                = 0;
     nCod                = 0;

     aEsc1               = "";
     aEsc2               = "";
     aRetu               = "";
     aTecla              = "";
     aAlfa               = "";
     aAlfa1              = "";
     aAlfa2              = "";
     aEjecuta            = "";
     aOri                = "";
     aDes                = "";
     aBaseSII            = "";
     aBaseAplis          = "";
     aBase               = "";
     aPath               = "";
     aPathLocal          = "";
     aVer1               = "";
     aVer2               = "";
     aPathPlugins        = "";
     aApi                = "";
     aLogSincro          = "";
     aAse                = "";
     aLong               = "";
     aCaracter           = "";
     aEjeSincro          = "";
     aLee                = "";
     aMas                = "";
     aTipoLbl            = "";
     aConten             = "";
     aTo                 = "";
     aBaseMensaje        = "";
     aFrom               = "";
     aAsunto             = "";
     aAbreTXT            = "";
     aIP                 = "";
     aSalida             = "";
     aMensaje            = "";
     aHora               = "";
     aFecha              = "";
     aFicTmp             = "";
     aContenido          = "";
     aAbre               = "";
     aOpcion             = "";
     aMasBas             = "";
     aFicBas             = "";
     aMasCon             = "";
     aFicCon             = "";
     aEmp                = "";

     fFecha              = @;

  {1}aConte              = "";

     {-1}sTree           = 0;
         sT_nID          = 0;
         sT_nOper        = 0;
         sT_aData        = "";

     {-1}aVent           = "";
         aVent1          = 0;
         aVent2          = 0;
         aVent3          = 0;
         aVent4          = 0;
         aVent5          = "";

     &enEmp              = 0;
     &enEje              = 0;
     &enPer              = 0;
     &enLot              = 0;
     &enReg              = 0;
     &eaUnidadBasico     = "";
     &eaUrlSB            = "";
     &eaUrlAP            = "";
     &eaIni              = "";
     &eaPython           = "";
     &eaPaq              = "";
     &eaBtnBox           = "";
     &eaBtnEmp           = "";
     &eaBtnExc           = "";
     &eaBtnCon           = "";
     &eaBtnEnv           = "";
     &eaBtnLim           = "";

     &eaModoNet          = "";
     &eaUsuNet           = "";
     &eaBaseNet          = "";
     &eaFechaNet         = "";
     &eaEmpNet           = "";

     &eaPrograma         = "";
     &enAprobacion       = 0;
     &enOTP              = 0;
|FIN;

|PROCESO GrabaCuerpo;
     aConten = "USUARIO REALIZACION: " + eaUsuNet + &13 + &10;
     |XGRABA nHandle, aConten;

     aConten = "CARPETA: " + eaBaseNet + &13 + &10;
     |XGRABA nHandle, aConten;

     aConten = "EMPRESA: " + eaEmpNet + &13 + &10;
     |XGRABA nHandle, aConten;
|FPRC;

|PROCESO EnviaNotificacion;
     aTo = "manolo@diagram.es";
     aTo = "siibox_admin@diagram.es";
     |QBF aTo;

     |VENTANA 1610, 2080, -1, 16, "Por favor Espere";
     n2Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802; |PAUSA;

     |DBASS eaBaseNet;

     |DBASE aBaseMensaje;  |QBF aBase;
     aBaseMensaje = aBaseMensaje + "tmp";   |MKDIR aBaseMensaje;
     aBaseMensaje = aBaseMensaje + "/";
     aFrom   = "no_reply@diagram.es";  |QBF aFrom;
     aAsunto = "SIIBOX: " + eaModoNet + " (" + eaBaseNet + " - " + eaFechaNet + ")";

     aAbreTXT = aBaseMensaje + "adjunto.txt";
     |XABRE "WB", aAbreTXT, nHandle;
     |HAZ GrabaCuerpo;
     |XCIERRA nHandle;

     aIP      = "xdscorreo.dv.diagram.net";
     aSalida  = "asmtp.diagram.es";

     aMensaje = "$$$$" + aAbreTXT;

     |DSCORREO_ENVIA aIP, aSalida, aFrom, aTo, aAsunto, aMensaje, aAbreTXT;
     |SI FSalida < 0;
         |MENAV "0000 Ha habido un error durante el envio.";
     |FINSI;

     |FBORRA aAbreTXT;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n2Vent;
|FPRC;

|PROCESO Baja1;
     #siim0001#4 = "S";
     #siim0001#0 = 00001;
|FPRC;

|PROCESO Alta1;
     #siim0001#4 = "S";
     #siim0001#0 = 99999;
|FPRC;

|PROCESO Baja2;
     #siim0002#0 = #siim0001#0;
     #siim0002#1 = 9999999999;
|FPRC;

|PROCESO Alta2;
     #siim0002#0 = #siim0001#0;
     #siim0002#1 = 1;
|FPRC;

|PROCESO BtnFact;
     enEmp = #siim0002#0;
     enLot = #siim0002#1;
     enEje = #siim0002#4;
     enPer = #siim0002#5;

     |SI #siim0002#2 = "11";  |SUB_EJECUTA "siiz0002";  |FINSI;
     |SI #siim0002#2 = "12";  |SUB_EJECUTA "siiz0002";  |FINSI;
     |SI #siim0002#2 = "15";  |SUB_EJECUTA "siiz0002";  |FINSI;
     |SI #siim0002#2 = "14";  |SUB_EJECUTA "siiz0004";  |FINSI;

     |SI #siim0002#2 = "21";  |SUB_EJECUTA "siiz0003";  |FINSI;
     |SI #siim0002#2 = "22";  |SUB_EJECUTA "siiz0003";  |FINSI;
     |SI #siim0002#2 = "25";  |SUB_EJECUTA "siiz0003";  |FINSI;
     |SI #siim0002#2 = "24";  |SUB_EJECUTA "siiz0005";  |FINSI;

     |SI #siim0002#2 = "31";  |SUB_EJECUTA "siiz0006";  |FINSI;
     |SI #siim0002#2 = "32";  |SUB_EJECUTA "siiz0006";  |FINSI;
     |SI #siim0002#2 = "35";  |SUB_EJECUTA "siiz0006";  |FINSI;

     |SI #siim0002#2 = "41";  |SUB_EJECUTA "siiz0007";  |FINSI;
     |SI #siim0002#2 = "42";  |SUB_EJECUTA "siiz0007";  |FINSI;
     |SI #siim0002#2 = "45";  |SUB_EJECUTA "siiz0007";  |FINSI;

     |REFRESCACONTROL nGrid2;
     |FOCOTECLADO nGrid2;
|FPRC;

|PROCESO BtnEnv;
     enEmp = #siim0002#0;
     enLot = #siim0002#1;
     enEje = #siim0002#4;
     enPer = #siim0002#5;

     |SI #siim0002#2 = "11";  |SUB_EJECUTA "siiz0012;SIIBASE";  |FINSI;
     |SI #siim0002#2 = "12";  |SUB_EJECUTA "siiz0012;SIIBASE";  |FINSI;
     |SI #siim0002#2 = "14";  |SUB_EJECUTA "siiz0016;SIIBASE";  |FINSI;
     |SI #siim0002#2 = "15";  |SUB_EJECUTA "siiz0014;SIIBASE";  |FINSI;

     |SI #siim0002#2 = "21";  |SUB_EJECUTA "siiz0013;SIIBASE";  |FINSI;
     |SI #siim0002#2 = "22";  |SUB_EJECUTA "siiz0013;SIIBASE";  |FINSI;
     |SI #siim0002#2 = "24";  |SUB_EJECUTA "siiz0017;SIIBASE";  |FINSI;
     |SI #siim0002#2 = "25";  |SUB_EJECUTA "siiz0015;SIIBASE";  |FINSI;

     |SI #siim0002#2 = "31";  |SUB_EJECUTA "siiz0018;SIIBASE";  |FINSI;
     |SI #siim0002#2 = "32";  |SUB_EJECUTA "siiz0018;SIIBASE";  |FINSI;
     |SI #siim0002#2 = "35";  |SUB_EJECUTA "siiz0019;SIIBASE";  |FINSI;

     |SI #siim0002#2 = "41";  |SUB_EJECUTA "siiz0040;SIIBASE";  |FINSI;
     |SI #siim0002#2 = "42";  |SUB_EJECUTA "siiz0040;SIIBASE";  |FINSI;
     |SI #siim0002#2 = "45";  |SUB_EJECUTA "siiz0041;SIIBASE";  |FINSI;

     |REFRESCACONTROL nGrid2;
     |FOCOTECLADO nGrid2;
|FPRC;

|PROCESO BtnEstd;
     |VENTANA 0501, 1660, -1, 16, "Datos del env¡o";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     #siiw0008#0 = #siim0002#6;
     #siiw0008#1 = #siim0002#7;
     #siiw0008#2 = #siim0002#8;
     #siiw0008#3 = #siim0002#9;
     #siiw0008#4 = #siim0002#10;

     |PINPA #0#siiw0008;
     |PINDA #0#siiw0008;
     |LEETECLA aAlfa;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;

     |FOCOTECLADO nGrid2;
|FPRC;

|PROCESO Evnt2;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#siim0002.=;

         |ESTADO_CONTROL nBtnFact, "ENABLE";
         |ESTADO_CONTROL nBtnEstd, "ENABLE";
         |ESTADO_CONTROL nBtnBLot, "ENABLE";

         |SI nBtnEnv ! -1;
             |ESTADO_CONTROL nBtnEnv,  "DISABLE";
         |FINSI;

         |SI #siim0002#6 > 0;
             |SI nBtnEnv ! -1;
                 |ESTADO_CONTROL nBtnEnv, "ENABLE";
             |FINSI;
         |FINSI;

         |SI #siim0002#8 ! 0;  |O #siim0002#9 ! 0;
             |ESTADO_CONTROL nBtnBLot, "DISABLE";
         |FINSI;
     |FINSI;

     |SI FSalida = 4;
         |HAZ BtnFact;
     |FINSI;
|FPRC;

|PROCESO AccesoSIIBOX;
     enEmp = #siim0001#0;
     |SUB_EJECUTA "siiz0050";

     |FOCOTECLADO nGrid1;
|FPRC;

|PROCESO Evnt1;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#siim0001.=;

         |ESTADO_CONTROL nBtnDesa, "ENABLE";
         |ESTADO_CONTROL nBtnFact, "DISABLE";
         |ESTADO_CONTROL nBtnEstd, "DISABLE";
         |ESTADO_CONTROL nBtnNLot, "ENABLE";
         |ESTADO_CONTROL nBtnAcce, "ENABLE";
         |ESTADO_CONTROL nBtnBLot, "DISABLE";

         |SI nBtnEnv ! -1;
             |ESTADO_CONTROL nBtnEnv,  "DISABLE";
         |FINSI;

         |REFRESCACONTROL nGrid2;
     |FINSI;

     |SI FSalida = 4;
         |HAZ AccesoSIIBOX;
     |FINSI;
|FPRC;

|PROCESO agicen14;
     |SI #agicen14@#6 ] "01.01.1900";
         |ACABA;
     |FINSI;

     |SI #agicen14@#7 = 11;  nOk = 1;  |FINSI;
     |SI #agicen14@#7 = 12;  nOk = 1;  |FINSI;
     |SI #agicen14@#7 = 13;  nOk = 1;  |FINSI;
     |SI #agicen14@#7 = 15;  nOk = 1;  |FINSI;
     |SI #agicen14@#7 = 16;  nOk = 1;  |FINSI;
     |SI #agicen14@#7 = 17;  nOk = 1;  |FINSI;

     |SI nOk = 1;
         |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE agicen14;
     #agicen14@#1002;
     ;
     #agifigen@#0, 01;
     #agifigen@#0, 99;
     ;
     NULL, agicen14;
|FIN;

|PROCESO canempre;
     nOk = 0;
     |SI #canempre@#24 = "S";
         nOk = 1;
     |FINSI;
|FPRC;

|DEFBUCLE canempre;
     #canempre@#4002;
     ;
     #agifigen@#0, 17;
     #agifigen@#0, 80;
     ;
     NULL, canempre;
|FIN;

|PROCESO ChequeaSelPI;
     #siim0001#0 = #agifigen@#0;
     |LEE 000#siim0001.=;
     |SI FSalida = 0;
         |SI #siim0001#4 = "S";
             |MENAV "0000La empresa ya est  en la bandeja";
             |ACABA;
         |FINSI;

         |CONFI "0000SLa empresa est  desactivada, quiere activarla de nuevo";
         |SI FSalida ! 0;
             |ACABA;
         |FINSI;

         #siim0001#4 = "S";
         |GRABA 020#siim0001.a;
         |LIBERA #siim0001;

         |HORA aHora;

         eaModoNet     = "Habilitado nuevo acceso";
         eaUsuNet      = Usuario % 810; |QBF eaUsuNet;
         fFecha        = ~;
         aFecha        = fFecha;
         eaFechaNet    = aFecha + " " + aHora;
         eaEmpNet      = ("00000" + #siim0001#0) % -105;
         eaEmpNet      = eaEmpNet + " / " + #siim0001#1;   |QBF eaEmpNet;
         eaEmpNet      = eaEmpNet + " / " + #siim0001#2;   |QBF eaEmpNet;

         |HAZ EnviaNotificacion;

         |ACABA;
     |FINSI;

     nOk = 0;
     |BUCLE canempre;

     |SI nOk = 1;
         nOk = 0;
         |BUCLE agicen14;
         |SI nOk = 0;
             |MENAV "0000La empresa no est  sujeta a un r‚gimen de IVA para generar registros SII";
             |ACABA;
         |FINSI;
     |FINSI;

     |CONFI "0000SQuiere agregar la empresa a la bandeja";
     |SI FSalida = 0;
         |DDEFECTO #siim0001;
         #siim0001#0 = #agifigen@#0;
         #siim0001#1 = #agifigen@#1;
         #siim0001#2 = #agifigen@#13;
         |GRABA 020#siim0001.n;
         |LIBERA #siim0001;

         |HORA aHora;

         eaModoNet     = "Habilitado nuevo acceso";
         eaUsuNet      = Usuario % 810; |QBF eaUsuNet;
         fFecha        = ~;
         aFecha        = fFecha;
         eaFechaNet    = aFecha + " " + aHora;
         eaEmpNet      = ("00000" + #siim0001#0) % -105;
         eaEmpNet      = eaEmpNet + " / " + #siim0001#1;   |QBF eaEmpNet;
         eaEmpNet      = eaEmpNet + " / " + #siim0001#2;   |QBF eaEmpNet;

         |HAZ EnviaNotificacion;
     |FINSI;
|FPRC;

|PROCESO ModoBasica;
     aMas = aBaseAplis + "basica/def/agifigen.mas";
     |CARGA_DEF aMas, agifigen@;

     aMas = aBaseAplis + "basica/def/agicen14.mas";
     |CARGA_DEF aMas, agicen14@;

     aMas = aBaseAplis + "contagen/def/canempre.mas";
     |CARGA_DEF aMas, canempre@;

     |ABRE #agifigen@;
     |CONSULTA_CLAVE #1#agifigen@;
     |SI FSalida = 0;
         |SELECT #1#siim0001;
         |HAZ ChequeaSelPI;
         |SELECT #3#siim0001;

         |LEE 000#siim0001.=;
     |FINSI;
     |CIERRA #agifigen@;

     |DESCARGA_DEF #canempre@;
     |DESCARGA_DEF #agicen14@;
     |DESCARGA_DEF #agifigen@;
|FPRC;

|PROCESO ChequeaSelNoPI;
     #siim0001#0 = #agifigen@#0;
     |LEE 000#siim0001.=;
     |SI FSalida = 0;
         |SI #siim0001#4 = "S";
             |MENAV "0000La empresa ya est  en la bandeja";
             |ACABA;
         |FINSI;

         |CONFI "0000SLa empresa est  desactivada, quiere activarla de nuevo";
         |SI FSalida ! 0;
             |ACABA;
         |FINSI;

         #siim0001#4 = "S";
         |GRABA 020#siim0001.a;
         |LIBERA #siim0001;

         |HORA aHora;

         eaModoNet     = "Habilitado nuevo acceso";
         eaUsuNet      = Usuario % 810; |QBF eaUsuNet;
         fFecha        = ~;
         aFecha        = fFecha;
         eaFechaNet    = aFecha + " " + aHora;
         eaEmpNet      = ("00000" + #siim0001#0) % -105;
         eaEmpNet      = eaEmpNet + " / " + #siim0001#1;   |QBF eaEmpNet;
         eaEmpNet      = eaEmpNet + " / " + #siim0001#2;   |QBF eaEmpNet;

         |HAZ EnviaNotificacion;

         |ACABA;
     |FINSI;

     |CONFI "0000SQuiere agregar la empresa a la bandeja";
     |SI FSalida = 0;
         |DDEFECTO #siim0001;
         #siim0001#0 = #agifigen@#0;
         #siim0001#1 = #agifigen@#1;
         #siim0001#2 = #agifigen@#13;
         #siim0001#4 = "S";
         |GRABA 020#siim0001.n;
         |LIBERA #siim0001;

         |HORA aHora;

         eaModoNet     = "Habilitado nuevo acceso";
         eaUsuNet      = Usuario % 810; |QBF eaUsuNet;
         fFecha        = ~;
         aFecha        = fFecha;
         eaFechaNet    = aFecha + " " + aHora;
         eaEmpNet      = ("00000" + #siim0001#0) % -105;
         eaEmpNet      = eaEmpNet + " / " + #siim0001#1;   |QBF eaEmpNet;
         eaEmpNet      = eaEmpNet + " / " + #siim0001#2;   |QBF eaEmpNet;

         |HAZ EnviaNotificacion;
     |FINSI;
|FPRC;

|PROCESO ModoAgicli;
     aMas = aBaseAplis + "agicli/def/agifigen.mas";
     |CARGA_DEF aMas, agifigen@;

     |ABRE #agifigen@;
     |CONSULTA_CLAVE #1#agifigen@;
     |SI FSalida = 0;
         |CONFI "0000SQuiere agregar la empresa a la bandeja";
         |SI FSalida = 0;
             |SELECT #1#siim0001;
             |HAZ ChequeaSelNoPI;
             |SELECT #3#siim0001;

             |LEE 000#siim0001.=;
         |FINSI;
     |FINSI;
     |CIERRA #agifigen@;

     |DESCARGA_DEF #agifigen@;
|FPRC;

|PROCESO agifigenOTP;
     #siim0101#0 = aAse;
     #siim0101#1 = #agifigen@#0;
     |LEE 000#siim0101.=;
     |SI FSalida ! 0;  |DDEFECTO #siim0101;  |FINSI;

     #siim0001#0 = #siim0101#5;
     |LEE 000#siim0001.=;
     |SI FSalida = 0;
         |SI #siim0001#4 = "S";
             |ACABA;
         |FINSI;
     |FINSI;

     nOk = 0;
     |BUCLE canempre;

     |SI nOk = 1;
         nOk = 0;
         |BUCLE agicen14;
         |SI nOk = 0;
             |ACABA;
         |FINSI;
     |FINSI;

     #siim0101#0 = aAse;
     #siim0101#1 = #agifigen@#0;
     |LEE 101#siim0101.=;
     |SI FSalida ! 0;
         |DDEFECTO #siim0101;
         #siim0101#0 = aAse;
         #siim0101#1 = #agifigen@#0;
         |GRABA 020#siim0101.b;
     |FINSI;

     #siim0101#2 = #agifigen@#1;
     #siim0101#3 = #agifigen@#13;
     #siim0101#4 = "S";

     |GRABA 020#siim0101.a;
     |LIBERA #siim0101;
|FPRC;

|DEFBUCLE agifigenOTP;
     #agifigen@#1001;
     ;
     00001;
     99999;
     ;
     NULL, agifigenOTP;
|FIN;

|PROCESO CargaSIIM0101;
     aMasBas = "/u/" + aAse + "/basica/def/";
     aFicBas = "/u/" + aAse + "/basica/fich/";
     aMasCon = "/u/" + aAse + "/contagen/def/";
     aFicCon = "/u/" + aAse + "/contagen/fich/";

     aMas = aMasBas + "agifigen.mas";
     |CARGA_DEF aMas, agifigen@;

     aMas = aMasBas + "agicen14.mas";
     |CARGA_DEF aMas, agicen14@;

     aMas = aMasCon + "canempre.mas";
     |CARGA_DEF aMas, canempre@;

     |PATH_DAT #agifigen@#aFicBas#;
     |PATH_DAT #agicen14@#aFicBas#;
     |PATH_DAT #canempre@#aFicCon#;

     |BUCLE agifigenOTP;

     |DESCARGA_DEF #canempre@;
     |DESCARGA_DEF #agicen14@;
     |DESCARGA_DEF #agifigen@;
|FPRC;

|PROCESO MeteEmpOTP;
     |SI #siim0101#5 ! 0;
         #siim0001#0 = #siim0101#5;
         |LEE 000#siim0001.=;
         |SI FSalida = 0;
             |SI #siim0001#4 = "S";
                 |ACABA;
             |FINSI;
         |FINSI;

         |CONFI "0000SLa empresa est  desactivada, quiere activarla de nuevo";
     |SINO;
         |CONFI "0000SQuiere agregar la empresa a la bandeja";
     |FINSI;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aAse = #siim0101#0;
     nEmp = #siim0101#1;
     |SI #siim0101#5 = 0;
         aAlfa = #siim0101#0 % -102;
         nCod  = aAlfa;
         nCod  = nCod * 1000;

         |SELECT #3#siim0101;
         |PARA;   |SI nCod [ 99999;  |HACIENDO nCod = nCod + 1;
              #siim0101#0 = aAse;
              #siim0101#5 = nCod;
              |LEE 000#siim0101.=;
              |SI FSalida ! 0;  |SAL;  |FINSI;
         |SIGUE;
     |FINSI;

     |SELECT #1#siim0101;
     #siim0101#0 = aAse;
     #siim0101#1 = nEmp;
     |LEE 101#siim0101.=;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     |SI #siim0101#5 = 0;
         #siim0101#5 = nCod;
     |FINSI;
     |GRABA 020#siim0101.a;
     |LIBERA #siim0101;

     |SELECT #1#siim0001;
     #siim0001#0 = #siim0101#5;
     |LEE 101#siim0001.=;
     |SI FSalida = 0;
         #siim0001#1 = #siim0101#2;
         #siim0001#2 = #siim0101#3;
         #siim0001#3 = #siim0101#4;
         #siim0001#4 = "S";

         |GRABA 020#siim0001.a;
         |LIBERA #siim0001;

         |HORA aHora;

         eaModoNet     = "Habilitado nuevo acceso";
         eaUsuNet      = Usuario % 810; |QBF eaUsuNet;
         fFecha        = ~;
         aFecha        = fFecha;
         eaFechaNet    = aFecha + " " + aHora;
         eaEmpNet      = ("00000" + #siim0001#0) % -105;
         eaEmpNet      = eaEmpNet + " / " + #siim0001#1;   |QBF eaEmpNet;
         eaEmpNet      = eaEmpNet + " / " + #siim0001#2;   |QBF eaEmpNet;

         |HAZ EnviaNotificacion;

         |ACABA;
     |FINSI;

     |DDEFECTO #siim0001;
     #siim0001#0 = #siim0101#5;
     #siim0001#1 = #siim0101#2;
     #siim0001#2 = #siim0101#3;
     #siim0001#3 = #siim0101#4;

     |GRABA 020#siim0001.n;
     |LIBERA #siim0001;

     |HORA aHora;

     eaModoNet     = "Habilitado nuevo acceso";
     eaUsuNet      = Usuario % 810; |QBF eaUsuNet;
     fFecha        = ~;
     aFecha        = fFecha;
     eaFechaNet    = aFecha + " " + aHora;
     eaEmpNet      = ("00000" + #siim0001#0) % -105;
     eaEmpNet      = eaEmpNet + " / " + #siim0001#1;   |QBF eaEmpNet;
     eaEmpNet      = eaEmpNet + " / " + #siim0001#2;   |QBF eaEmpNet;

     |HAZ EnviaNotificacion;

     |LEE 000#siim0001.=;
|FPRC;

|PROCESO ModoOTP;
     |ABRET #siim0101;

     aAse = "ase1012";  |HAZ CargaSIIM0101;
     aAse = "ase1015";  |HAZ CargaSIIM0101;
     aAse = "ase1017";  |HAZ CargaSIIM0101;
     aAse = "ase1018";  |HAZ CargaSIIM0101;
     aAse = "ase1022";  |HAZ CargaSIIM0101;

     |CONSULTA_CLAVE #1#siim0101;
     |SI FSalida = 0;
         |HAZ MeteEmpOTP;
     |FINSI;

     |CIERRAT #siim0101;
|FPRC;

|PROCESO NuevaEmp;
     |SI enOTP = 1;
         |HAZ ModoOTP;

         |REFRESCACONTROL nGrid1;
         |FOCOTECLADO nGrid1;

         |ACABA;
     |FINSI;

     |SI eaPaq = "BASICA";
         |HAZ ModoBasica;
     |FINSI;

     |SI eaPaq = "AGICLI";
         |HAZ ModoAgicli;
     |FINSI;

     |REFRESCACONTROL nGrid1;
     |FOCOTECLADO nGrid1;
|FPRC;

|PROCESO DesactivarEmp;
     |CONFI "0000NEst  seguro que quiere desactivar la empresa";
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |SELECT #1#siim0001;
     |LEE 101#siim0001.=;
     |SI FSalida = 0;
         #siim0001#4 = "N";
         |GRABA 020#siim0001.a;
         |LIBERA #siim0001;

         eaModoNet     = "Acceso quitado ";
         eaUsuNet      = Usuario % 810; |QBF eaUsuNet;
         fFecha        = ~;
         aFecha        = fFecha;
         eaFechaNet    = aFecha + " " + aHora;
         eaEmpNet      = ("00000" + #siim0001#0) % -105;
         eaEmpNet      = eaEmpNet + " / " + #siim0001#1;   |QBF eaEmpNet;
         eaEmpNet      = eaEmpNet + " / " + #siim0001#2;   |QBF eaEmpNet;
         |HAZ EnviaNotificacion;
     |FINSI;

     |SELECT #3#siim0001;
     |LEE 000#siim0001.=;

     |REFRESCACONTROL nGrid1;
     |FOCOTECLADO nGrid1;
|FPRC;

|PROCESO CambiaPeriodo;
     |SI #siim0001#5 = "M";
         aAlfa = "0000NLa empresa tiene periodo MENSUAL. Quiere pararlo a TRIMESTRAL";
     |SINO;
         aAlfa = "0000NLa empresa tiene periodo TRIMESTRAL. Quiere pararlo a MENSUAL";
     |FINSI;

     |CONFI aAlfa;
     |SI FSalida ! 0;
         |FOCOTECLADO nGrid1;
         |ACABA;
     |FINSI;

     |SELECT #1#siim0001;
     |LEE 101#siim0001.=;
     |SI FSalida = 0;
         |SI #siim0001#5 = "M";
             #siim0001#5 = "T";
         |SINO;
             #siim0001#5 = "M";
         |FINSI;
         |GRABA 020#siim0001.a;
         |LIBERA #siim0001;
     |FINSI;

     |SELECT #3#siim0001;
     |LEE 000#siim0001.=;

     |REFRESCACONTROL nGrid1;
     |FOCOTECLADO nGrid1;
|FPRC;


|PROCESO NuevoLote;
     |VENTANA 0501, 2399, -1, 16, "Nuevo Lote";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |SELECT #1#siim0002;
     #siim0002#0 = #siim0001#0;
     #siim0002#1 = 9999999999;
     |LEE 000#siim0002.];
     |SI FSalida = 0;
         |LEE 000#siim0002.a;
     |SINO;
         |LEE 000#siim0002.u;
     |FINSI;

     nLot = 1;
     |SI FSalida = 0;  |Y  #siim0002#0 = #siim0001#0;
         nLot = #siim0002#1 + 1;
     |FINSI;

     fFecha = ~;
     aAlfa  = fFecha % -104;  nEje = aAlfa;
     aAlfa  = fFecha % 402;   nPer = aAlfa;

     |SI nPer > 12;
         nPer = 1;
         nEje = nEje + 1;
     |FINSI;

     |DDEFECTO #siiw0001;

     #siiw0001#0 = nEje;

     |SI #siim0001#5 = "M";
         #siiw0001#1 = ("00" + nPer) % -102;
     |FINSI;

     |SI #siim0001#5 = "T";
         |SI nPer ] 1; |Y nPer [ 3;
             #siiw0001#1 = "1T";
         |FINSI;

         |SI nPer ] 4; |Y nPer [ 6;
             #siiw0001#1 = "2T";
         |FINSI;

         |SI nPer ] 7; |Y nPer [ 9;
             #siiw0001#1 = "3T";
         |FINSI;

         |SI nPer ] 10; |Y nPer [ 12;
             #siiw0001#1 = "4T";
         |FINSI;
     |FINSI;

     |HAZ PonMes;

     |C_M #siiw0001#13, 1, "N";
     |C_M #siiw0001#14, 1, "N";
     |C_M #siiw0001#15, 1, "N";
     |C_M #siiw0001#16, 1, "N";
     |C_M #siiw0001#17, 1, "N";
     |C_M #siiw0001#18, 1, "N";

     |SI #siiw0001#1 = "12";  |O #siiw0001#1 = "4T";
         |C_M #siiw0001#13, 1, "S";
         |C_M #siiw0001#14, 1, "S";
         |C_M #siiw0001#15, 1, "S";
         |C_M #siiw0001#16, 1, "S";
         |C_M #siiw0001#17, 1, "S";
         |C_M #siiw0001#18, 1, "S";
     |FINSI;

     |PINPA #0#siiw0001;
     |PINDA #0#siiw0001;
     |ENDATOS #1#siiw0001;
     |SI FSalida = 0;
         |CONFI "0000NAgregamos el nuevo lote";
         |SI FSalida = 0;
             |DDEFECTO #siim0002;
             #siim0002#0 = #siim0001#0;
             #siim0002#1 = nLot;

             |SI #siiw0001#3  = "S";  #siim0002#2 = "11"; |FINSI;
             |SI #siiw0001#4  = "S";  #siim0002#2 = "12"; |FINSI;
             |SI #siiw0001#6  = "S";  #siim0002#2 = "14"; |FINSI;
             |SI #siiw0001#7  = "S";  #siim0002#2 = "15"; |FINSI;

             |SI #siiw0001#8  = "S";  #siim0002#2 = "21"; |FINSI;
             |SI #siiw0001#9  = "S";  #siim0002#2 = "22"; |FINSI;
             |SI #siiw0001#11 = "S";  #siim0002#2 = "24"; |FINSI;
             |SI #siiw0001#12 = "S";  #siim0002#2 = "25"; |FINSI;

             |SI #siiw0001#13 = "S";  #siim0002#2 = "31"; |FINSI;
             |SI #siiw0001#14 = "S";  #siim0002#2 = "32"; |FINSI;
             |SI #siiw0001#15 = "S";  #siim0002#2 = "35"; |FINSI;

             |SI #siiw0001#16 = "S";  #siim0002#2 = "41"; |FINSI;
             |SI #siiw0001#17 = "S";  #siim0002#2 = "42"; |FINSI;
             |SI #siiw0001#18 = "S";  #siim0002#2 = "45"; |FINSI;

             |SI #siim0002#2 = "11"; #siim0002#3 = "Alta de facturas expedidas";                          |FINSI;
             |SI #siim0002#2 = "12"; #siim0002#3 = "Modificaci¢n de facturas expedidas";                  |FINSI;
             |SI #siim0002#2 = "14"; #siim0002#3 = "Suministro de cobros";                                |FINSI;
             |SI #siim0002#2 = "15"; #siim0002#3 = "Baja de facturas expedidas";                          |FINSI;

             |SI #siim0002#2 = "21"; #siim0002#3 = "Alta de facturas recibidas";                          |FINSI;
             |SI #siim0002#2 = "22"; #siim0002#3 = "Modificaci¢n de facturas recibidas";                  |FINSI;
             |SI #siim0002#2 = "24"; #siim0002#3 = "Suministro de pagos";                                 |FINSI;
             |SI #siim0002#2 = "25"; #siim0002#3 = "Baja de facturas recibidas";                          |FINSI;

             |SI #siim0002#2 = "31"; #siim0002#3 = "Alta de facturas de inversi¢n";                       |FINSI;
             |SI #siim0002#2 = "32"; #siim0002#3 = "Modificaci¢n de facturas de inversi¢n";               |FINSI;
             |SI #siim0002#2 = "35"; #siim0002#3 = "Baja de facturas de inversi¢n";                       |FINSI;

             |SI #siim0002#2 = "41"; #siim0002#3 = "Alta de operaciones en met lico";                     |FINSI;
             |SI #siim0002#2 = "42"; #siim0002#3 = "Modificaci¢n de operaciones en met lico";             |FINSI;
             |SI #siim0002#2 = "45"; #siim0002#3 = "Baja de operaciones en met lico";                     |FINSI;

             #siim0002#4  = #siiw0001#0;

             |SI #siiw0001#1 = "1T";  |O #siiw0001#1 = "2T";
              |O #siiw0001#1 = "3T";  |O #siiw0001#1 = "4T";
                 aAlfa = #siiw0001#1 % 101;
                 #siim0002#5  = aAlfa;
                 #siim0002#21 = "T";
             |SINO;
                 #siim0002#5  = #siiw0001#1;
                 #siim0002#21 = "M";
             |FINSI;

             #siim0002#13 = #siim0001#1;
             #siim0002#14 = #siim0001#2;

             |GRABA 020#siim0002.n;
             |LIBERA #siim0002;
         |FINSI;
     |FINSI;

     |SELECT #2#siim0002;
     |LEE 000#siim0002.=;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;

     |REFRESCACONTROL nGrid2;
     |FOCOTECLADO nGrid2;
|FPRC;

|PROCESO BorrarLote;
     |CONFI "0000NBorramos el lote";
     |SI FSalida ! 0;
         |FOCOTECLADO nGrid2;
         |ACABA;
     |FINSI;

     |LEE 000#siim0002.=;
     |SI FSalida ! 0;
         |FOCOTECLADO nGrid2;
         |ACABA;
     |FINSI;

     enEmp = #siim0002#0;
     enLot = #siim0002#1;

     |SI #siim0002#2 = "11";  |SUB_EJECUTA "siiz0002;BORRAR";  |FINSI;
     |SI #siim0002#2 = "12";  |SUB_EJECUTA "siiz0002;BORRAR";  |FINSI;
     |SI #siim0002#2 = "15";  |SUB_EJECUTA "siiz0002;BORRAR";  |FINSI;
     |SI #siim0002#2 = "14";  |SUB_EJECUTA "siiz0004;BORRAR";  |FINSI;

     |SI #siim0002#2 = "21";  |SUB_EJECUTA "siiz0003;BORRAR";  |FINSI;
     |SI #siim0002#2 = "22";  |SUB_EJECUTA "siiz0003;BORRAR";  |FINSI;
     |SI #siim0002#2 = "25";  |SUB_EJECUTA "siiz0003;BORRAR";  |FINSI;
     |SI #siim0002#2 = "24";  |SUB_EJECUTA "siiz0005;BORRAR";  |FINSI;

     |SI #siim0002#2 = "31";  |SUB_EJECUTA "siiz0006;BORRAR";  |FINSI;
     |SI #siim0002#2 = "32";  |SUB_EJECUTA "siiz0006;BORRAR";  |FINSI;
     |SI #siim0002#2 = "35";  |SUB_EJECUTA "siiz0006;BORRAR";  |FINSI;

     |SI #siim0002#2 = "41";  |SUB_EJECUTA "siiz0007;BORRAR";  |FINSI;
     |SI #siim0002#2 = "42";  |SUB_EJECUTA "siiz0007;BORRAR";  |FINSI;
     |SI #siim0002#2 = "45";  |SUB_EJECUTA "siiz0007;BORRAR";  |FINSI;

     |BORRA 020#siim0002.a;
     |LIBERA #siim0002;

     |REFRESCACONTROL nGrid2;
     |FOCOTECLADO nGrid2;
|FPRC;

|PROCESO PonPlantilla;
     aVer1   = "";
     aVer2   = "";
     aConte  = aBaseSII + "plugins/plantillafacturas.xlsx";
     |ESPECIFICA "MD5", aConte;
     aVer1 = FSalida;

     aConte  = aPathLocal + "plantillafacturas.xlsx";
     |ESPECIFICA "REMOTOMD5", aConte;
     aVer2 = FSalida;

     |SI aVer1 ! aVer2;
         aOri  = aBaseSII + "plugins/plantillafacturas.xlsx";
         aDes  = aPathLocal + "plantillafacturas.xlsx";

         |SI aIP = "";
             |COPIA_FICHERO aOri, aDes;
         |SINO;
             |ENVIA_FICHERO aOri, aDes;
         |FINSI;

         aAlfa = aPathLocal + "plantillafacturas.xlsx";
         |XABRE "EC", aAlfa, 0;
         |SI FSalida < 0;
             |MENAV "0000No encuentro la plantilla, por favor consulte con su administrador informatico.";
             |ACABA;
         |FINSI;
     |FINSI;

     aAlfa = "0000El documento plantillafacturas.xlsx est  ubicado en " + aPathLocal + " de su PC";
     |MENAV aAlfa;
|FPRC;

|PROCESO EvtoTreeImpor;
     |SI FEntrada = 0;
         |ACABA;
     |FINSI;

     aContenido = Contenido % 101;

     |VENTANA 0501, 0501, -1, 16, "";
     n2Vent = FSalida;
     |PTEC 802;  |PAUSA;

     |SI aContenido = "1";  |HAZ PonPlantilla;                |FINSI;
     |SI aContenido = "2";  |SUB_EJECUTA "siiz0022;SIIBASE";  |FINSI;
     |SI aContenido = "3";  |SUB_EJECUTA "siiz0023;SIIBASE";  |FINSI;
     |SI aContenido = "4";  |SUB_EJECUTA "siiz0021";          |FINSI;

     |FINVENTANA n2Vent;

     |FOCOTECLADO nTree;
|FPRC;

|PROCESO BtnExcel;
     |VENTANA 0501, 1540, -1, 16, "Importaci¢n Excel/CSV";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |DBASE aBase;  |QBF aBase;
     aAlfa = aBase + "tmp";      |MKDIR aAlfa;

     sT_nID   = nTree;
     sT_nOper = 0;

     aAbre = aPathLocal + "tree" + Usuario + ".txt";
     |XABRE "WBC", aAbre, nHandle;

     nOpcion = 0;

     nOpcion  = nOpcion + 1;
     aOpcion  = nOpcion + ":Descargar plantilla {{1}}";
     |HAZ CargaArbol;

     nOpcion  = nOpcion + 1;
     aOpcion  = nOpcion + ":Facturas expedidas {{2}}";
     |HAZ CargaArbol;

     nOpcion  = nOpcion + 1;
     aOpcion  = nOpcion + ":Facturas recibidas {{3}}";
     |HAZ CargaArbol;

     nOpcion  = nOpcion + 1;
     aOpcion  = nOpcion + ":Exportacion CSV {{4}}";
     |HAZ CargaArbol;

     |XCIERRA nHandle;

     aAlfa = "TREECTRL, Tabla de contenidos {{" + aAbre + "}}";
     |CONTROL_SIMPLE 0, aAlfa, 0602, 1338, EvtoTreeImpor;
     nTree = FSalida;

     |RFBORRA aAbre;

     sT_nID   = nTree;
     sT_nOper = 2;
     sT_aData = "1:";

     |ESPECIFICA "COMMANDCONTROL", sTree;

     |PULSATECLA;
     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::{{001}}sali&R," + nTree;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
         |SI aTecla = aRetu; |SAL;  |FINSI;

         |REFRESCACONTROL nGrid2;
     |SIGUE;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PULSATECLA;

     |FINVENTANA n1Vent;

     |REFRESCACONTROL nGrid2;
     |FOCOTECLADO nGrid2;
|FPRC;

|PROCESO BtnConta;
     |SI eaPaq = "BASICA";
         |SUB_EJECUTA "siiz0030";
     |FINSI;

     |SI eaPaq = "AGICLI";
         |SUB_EJECUTA "siiz0031";
     |FINSI;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     |REFRESCACONTROL nGrid2;
     |FOCOTECLADO nGrid2;
|FPRC;

|PROCESO Ptec807;
     nPtec = 1;
     |PTEC 807;
|FPRC;

|PROCESO ProcesoPeriodico;
     |VENTANA 0501, 1375, -1, 16, "Proceso peri¢dico";
     n2Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     aTipoLbl = "LABEL,{{15}}";

     aAlfa = aTipoLbl + "Esta opción hace lo siguiente: "
     |CONTROL_SIMPLE 0, aAlfa, 0602, 0674, NULL;

     aTipoLbl = "LABEL,{{16}}";

     aAlfa = aTipoLbl + "   - Procesa las importaciones de CSV pendientes.";
     |CONTROL_SIMPLE 0, aAlfa, 0702, 0774, NULL;

     aAlfa = aTipoLbl + "   - Envia los lotes de registros pendientes de presentar a la AEAT ";
     |CONTROL_SIMPLE 0, aAlfa, 0802, 0874, NULL;

     aAlfa = aTipoLbl + "   - Comprueba la caducidad de los certificados depositados.";
     |CONTROL_SIMPLE 0, aAlfa, 0902, 0974, NULL;

     aAlfa = aTipoLbl + "   - Envia las correspondientes notificaciones con los";
     aAlfa = aAlfa + " resultados de todo el proceso.";
     |CONTROL_SIMPLE 0, aAlfa, 1002, 1074, NULL;

     nPtec = 0;
     |CONTROL_SIMPLE 0, "BOTON,Cancelar", 1345, 1355, Ptec807;

     |LEETECLA aAlfa;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n2Vent;

     |SI nPtec = 1;
         |FOCOTECLADO nTree;
         |ACABA;
     |FINSI;

     |VENTANA 0501, 0540, -1, 16, "Procesando proceso";
     n2Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |SUB_EJECUTA "siiz0020;TODO";

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n2Vent;

     |MENAV "0000Proceso terminado."
|FPRC;

|PROCESO PresentacionMasiva;
     |CONFI "0000NEst  seguro de enviar todos los lotes pendientes";
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |VENTANA 0501, 0540, -1, 16, "Procesando proceso";
     n2Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |SUB_EJECUTA "siiz0020;ENVIO";

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n2Vent;
|FPRC;

|PROCESO ConsultaMasiva;
     |DDEF aMas;
     aMas = aMas + "siim0002.mas";
     |CARGA_DEF aMas, consult@;

     |C_V #consult@#0,  1, "S";
     |C_V #consult@#13, 1, "S";
     |C_V #consult@#14, 1, "S";

     |ABRE #consult@;
     |PARA;  |SI;  |HACIENDO;
          |CONSULTA_CLAVE #1#consult@;
          |SI FSalida = 0;
              #siim0002#0 = #consult@#0;
              #siim0002#1 = #consult@#1;
              |LEE 101#siim0002.=;
              |SI FSalida = 0;
                  |HAZ BtnFact;
              |FINSI;
          |SINO;
              |CONFI "0000SQuiere salir de la consulta";
              |SI FSalida = 0;
                  |SAL;
              |FINSI;
          |FINSI;
     |SIGUE;
     |CIERRA #consult@;

     |DESCARGA_DEF #consult@;

     #siim0002#0 = #siim0001#0;
     #siim0002#1 = 1;
     |LEE 000#siim0002.];
|FPRC;

|PROCESO siim0002Lot;
     |SI #siiw0011#0 = "N";
         |SI #siim0002#2 = "11";  |ACABA;  |FINSI;
         |SI #siim0002#2 = "12";  |ACABA;  |FINSI;
         |SI #siim0002#2 = "15";  |ACABA;  |FINSI;
         |SI #siim0002#2 = "14";  |ACABA;  |FINSI;
     |FINSI;

     |SI #siiw0011#1 = "N";
         |SI #siim0002#2 = "21";  |ACABA;  |FINSI;
         |SI #siim0002#2 = "22";  |ACABA;  |FINSI;
         |SI #siim0002#2 = "25";  |ACABA;  |FINSI;
         |SI #siim0002#2 = "24";  |ACABA;  |FINSI;
     |FINSI;

     |SI #siiw0011#2 = "N";
         |SI #siim0002#2 = "31";  |ACABA;  |FINSI;
         |SI #siim0002#2 = "32";  |ACABA;  |FINSI;
         |SI #siim0002#2 = "35";  |ACABA;  |FINSI;
     |FINSI;

     |SI #siiw0011#3 = "N";
         |SI #siim0002#2 = "41";  |ACABA;  |FINSI;
         |SI #siim0002#2 = "42";  |ACABA;  |FINSI;
         |SI #siim0002#2 = "45";  |ACABA;  |FINSI;
     |FINSI;

     |SI #siiw0011#4 = "S";
         |SI #siim0002#4 ! #siiw0011#5;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI #siiw0011#6 = "S";
         aAlfa1 = (("00" + #siim0002#5) % -102) + #siim0002#21;
         aAlfa = #siiw0011#7 % -101;
         |SI aAlfa ! "T";
             aAlfa2 = #siiw0011#7 + "M";
         |SINO;
             aAlfa2 = "0" + #siiw0011#7;
         |FINSI;

         |SI aAlfa1 ! aAlfa2;
             |ACABA;
         |FINSI;
     |FINSI;

     nOk = 0;
     |SI #siiw0011#8 = "S";
         |SI #siim0002#7 ! 0;  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0011#9 = "S";
         |SI #siim0002#8 ! 0;  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0011#10 = "S";
         |SI #siim0002#9 ! 0;  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0011#11 = "S";
         |SI #siim0002#10 ! 0;  nOk = 1;  |FINSI;
     |FINSI;

     |SI nOk = 0;  |ACABA;  |FINSI;

     #consult@#0  = #siim0002#0;
     #consult@#1  = #siim0002#1;
     #consult@#2  = #siim0002#2;
     #consult@#3  = #siim0002#3;
     #consult@#4  = #siim0002#4;
     #consult@#5  = #siim0002#5;
     #consult@#6  = #siim0002#6;
     #consult@#7  = #siim0002#7;
     #consult@#8  = #siim0002#8;
     #consult@#9  = #siim0002#9;
     #consult@#10 = #siim0002#10;
     #consult@#11 = #siim0002#11;
     #consult@#12 = #siim0002#12;
     #consult@#13 = #siim0002#13;
     #consult@#14 = #siim0002#14;
     #consult@#15 = #siim0002#15;
     #consult@#16 = #siim0002#16;
     #consult@#17 = #siim0002#17;
     #consult@#18 = #siim0002#18;
     #consult@#19 = #siim0002#19;
     #consult@#20 = #siim0002#20;
     #consult@#21 = #siim0002#21;

     |GRABA 020#consult@.n;
     |LIBERA #consult@;
|FPRC;

|DEFBUCLE siim0002Lot;
     #siim0002#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siim0002Lot;
|FIN;

|PROCESO ConsultaGridLotes;
     |PARA;  |SI;  |HACIENDO;
          |VENTANA 0501, 1955, -1, 16, "Consulta selectiva vista por lotes";
          n2Vent = FSalida;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = n2Vent;
          aVent5 = "MODAL";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |PTEC 802;  |PAUSA;

          |PINPA #0#siiw0011;
          |PINDA #0#siiw0011;

          |ENDATOS #1#siiw0011;
          nFSalida = FSalida;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = n2Vent;
          aVent5 = "MODELESS";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |FINVENTANA n2Vent;

          |SI nFSalida ! 0;
              |SAL;
          |FINSI;

          |VENTANA 0501, 1955, -1, 16, "Procesando trabajo ...";
          n2Vent = FSalida;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = n2Vent;
          aVent5 = "MODAL";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |PTEC 802;  |PAUSA;

          |DDEF aMas;
          aMas = aMas + "siim0002.mas";
          |CARGA_DEF aMas, consult@;

          aFicTmp = "siim0002" + Usuario;  |NOME_DAT #consult@#aFicTmp#;
          |ABRE #consult@;  |CIERRA #consult@;  |DELINDEX #consult@;

          |ABRE #consult@;
          |BUCLE siim0002Lot;

          |LEE 000#consult@.p;
          |SI FSalida = 0;
              |PARA;  |SI;  |HACIENDO;
                   |CONSULTA_CLAVE #1#consult@;
                   |SI FSalida = 0;
                       #siim0002#0 = #consult@#0;
                       #siim0002#1 = #consult@#1;
                       |LEE 101#siim0002.=;
                       |SI FSalida = 0;
                           |HAZ BtnFact;
                       |FINSI;
                   |SINO;
                       |SAL;
                   |FINSI;
              |SIGUE;
          |SINO;
              |MENAV "0000Selecci¢n vac¡a";
          |FINSI;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = n2Vent;
          aVent5 = "MODELESS";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |FINVENTANA n2Vent;

          |CIERRA #consult@;
          |DELINDEX #consult@;
     |SIGUE;

     #siim0002#0 = #siim0001#0;
     #siim0002#1 = 1;
     |LEE 000#siim0002.];
|FPRC;

|PROCESO siim0003Fac;
     nOk = 0;
     |SI #siiw0014#5 = "S";
         |SI #siim0003#103 = "P";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#6 = "S";
         |SI #siim0003#103 = "C";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#7 = "S";
         |SI #siim0003#103 = "A";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#8 = "S";
         |SI #siim0003#103 = "I";  nOk = 1;  |FINSI;
     |FINSI;

     |SI nOk = 0;  |ACABA;  |FINSI;

     |PARA nCmp = 0;  |SI nCmp [ 111;  |HACIENDO nCmp = nCmp + 1;
           #consult@#nCmp# = #siim0003#nCmp#;
     |SIGUE;

     |GRABA 020#consult@.n;
     |LIBERA #consult@;
|FPRC;

|DEFBUCLE siim0003Fac;
     #siim0003#1;
     ;
     #siim0002#0, #siim0002#1, 000001;
     #siim0002#0, #siim0002#1, 999999;
     ;
     NULL, siim0003Fac;
|FIN;

|PROCESO siim0004Fac;
     nOk = 0;
     |SI #siiw0014#5 = "S";
         |SI #siim0004#78 = "P";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#6 = "S";
         |SI #siim0004#78 = "C";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#7 = "S";
         |SI #siim0004#78 = "A";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#8 = "S";
         |SI #siim0004#78 = "I";  nOk = 1;  |FINSI;
     |FINSI;

     |SI nOk = 0;  |ACABA;  |FINSI;

     |PARA nCmp = 0;  |SI nCmp [ 86;  |HACIENDO nCmp = nCmp + 1;
           #consult@#nCmp# = #siim0004#nCmp#;
     |SIGUE;

     |GRABA 020#consult@.n;
     |LIBERA #consult@;
|FPRC;

|DEFBUCLE siim0004Fac;
     #siim0004#1;
     ;
     #siim0002#0, #siim0002#1, 000001;
     #siim0002#0, #siim0002#1, 999999;
     ;
     NULL, siim0004Fac;
|FIN;

|PROCESO siim0009Fac;
     nOk = 0;
     |SI #siiw0014#5 = "S";
         |SI #siim0009#21 = "P";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#6 = "S";
         |SI #siim0009#21 = "C";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#7 = "S";
         |SI #siim0009#21 = "A";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#8 = "S";
         |SI #siim0009#21 = "I";  nOk = 1;  |FINSI;
     |FINSI;

     |SI nOk = 0;  |ACABA;  |FINSI;

     |PARA nCmp = 0;  |SI nCmp [ 29;  |HACIENDO nCmp = nCmp + 1;
           #consult@#nCmp# = #siim0009#nCmp#;
     |SIGUE;

     |GRABA 020#consult@.n;
     |LIBERA #consult@;
|FPRC;

|DEFBUCLE siim0009Fac;
     #siim0009#1;
     ;
     #siim0002#0, #siim0002#1, 000001;
     #siim0002#0, #siim0002#1, 999999;
     ;
     NULL, siim0009Fac;
|FIN;

|PROCESO siim0010Fac;
     nOk = 0;
     |SI #siiw0014#5 = "S";
         |SI #siim0010#14 = "P";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#6 = "S";
         |SI #siim0010#14 = "C";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#7 = "S";
         |SI #siim0010#14 = "A";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#8 = "S";
         |SI #siim0010#14 = "I";  nOk = 1;  |FINSI;
     |FINSI;

     |SI nOk = 0;  |ACABA;  |FINSI;

     |PARA nCmp = 0;  |SI nCmp [ 18;  |HACIENDO nCmp = nCmp + 1;
           #consult@#nCmp# = #siim0010#nCmp#;
     |SIGUE;

     |GRABA 020#consult@.n;
     |LIBERA #consult@;
|FPRC;

|DEFBUCLE siim0010Fac;
     #siim0010#1;
     ;
     #siim0002#0, #siim0002#1, 000001;
     #siim0002#0, #siim0002#1, 999999;
     ;
     NULL, siim0010Fac;
|FIN;

|PROCESO siim0002Fac;
     nOk = 0;

     |SI #siiw0014#0 = "1";
         |SI #siim0002#2 = "11";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "12";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "15";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#0 = "2";
         |SI #siim0002#2 = "21";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "22";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "25";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#0 = "3";
         |SI #siim0002#2 = "31";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "32";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "35";  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#0 = "4";
         |SI #siim0002#2 = "41";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "42";  nOk = 1;  |FINSI;
         |SI #siim0002#2 = "45";  nOk = 1;  |FINSI;
     |FINSI;

     |SI nOk = 0;  |ACABA;  |FINSI;

     |SI #siiw0014#1 = "S";
         |SI #siim0002#4 ! #siiw0014#2;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI #siiw0014#3 = "S";
         aAlfa1 = (("00" + #siim0002#5) % -102) + #siim0002#21;
         aAlfa = #siiw0014#4 % -101;
         |SI aAlfa ! "T";
             aAlfa2 = #siiw0014#4 + "M";
         |SINO;
             aAlfa2 = "0" + #siiw0014#4;
         |FINSI;

         |SI aAlfa1 ! aAlfa2;
             |ACABA;
         |FINSI;
     |FINSI;

     nOk = 0;
     |SI #siiw0014#5 = "S";
         |SI #siim0002#7 ! 0;  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#6 = "S";
         |SI #siim0002#8 ! 0;  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#7 = "S";
         |SI #siim0002#9 ! 0;  nOk = 1;  |FINSI;
     |FINSI;

     |SI #siiw0014#8 = "S";
         |SI #siim0002#10 ! 0;  nOk = 1;  |FINSI;
     |FINSI;

     |SI nOk = 0;  |ACABA;  |FINSI;

     |SI #siiw0014#0 = "1";
         |BUCLE siim0003Fac;
     |FINSI;

     |SI #siiw0014#0 = "2";
         |BUCLE siim0004Fac;
     |FINSI;

     |SI #siiw0014#0 = "3";
         |BUCLE siim0009Fac;
     |FINSI;

     |SI #siiw0014#0 = "4";
         |BUCLE siim0010Fac;
     |FINSI;
|FPRC;

|DEFBUCLE siim0002Fac;
     #siim0002#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siim0002Fac;
|FIN;

|PROCESO BtnFactReg;
     enEmp = #consult@#0;
     enLot = #consult@#1;
     enReg = #consult@#2;
     enEje = #consult@#3;
     enPer = #consult@#4;

     |SI #siiw0014#0 = "1";   |SUB_EJECUTA "siiz0002";  |FINSI;
     |SI #siiw0014#0 = "2";   |SUB_EJECUTA "siiz0003";  |FINSI;
     |SI #siiw0014#0 = "3";   |SUB_EJECUTA "siiz0006";  |FINSI;

     enReg = 0;
|FPRC;

|PROCESO ConsultaGridFacturas;
     |PARA;  |SI;  |HACIENDO;
          |VENTANA 0501, 1955, -1, 16, "Consulta selectiva vista por facturas";
          n2Vent = FSalida;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = n2Vent;
          aVent5 = "MODAL";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |PTEC 802;  |PAUSA;

          |PINPA #0#siiw0014;
          |PINDA #0#siiw0014;

          |ENDATOS #1#siiw0014;
          nFSalida = FSalida;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = n2Vent;
          aVent5 = "MODELESS";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |FINVENTANA n2Vent;

          |SI nFSalida ! 0;
              |SAL;
          |FINSI;

          |VENTANA 0501, 1955, -1, 16, "Procesando trabajo ...";
          n2Vent = FSalida;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = n2Vent;
          aVent5 = "MODAL";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |PTEC 802;  |PAUSA;

          |DDEF aMas;
          |SI #siiw0014#0 = "1";  aMas = aMas + "siim0003.mas";  |FINSI;
          |SI #siiw0014#0 = "2";  aMas = aMas + "siim0004.mas";  |FINSI;
          |SI #siiw0014#0 = "3";  aMas = aMas + "siim0009.mas";  |FINSI;
          |SI #siiw0014#0 = "4";  aMas = aMas + "siim0010.mas";  |FINSI;
          |CARGA_DEF aMas, consult@;

          aFicTmp = "facturas" + Usuario;  |NOME_DAT #consult@#aFicTmp#;
          |ABRE #consult@;  |CIERRA #consult@;  |DELINDEX #consult@;

          |ABRE #consult@;
          |BUCLE siim0002Fac;

          |LEE 000#consult@.p;
          |SI FSalida = 0;
              |PARA;  |SI;  |HACIENDO;
                   |CONSULTA_CLAVE #2#consult@;
                   |SI FSalida = 0;
                      |HAZ BtnFactReg;
                   |SINO;
                       |SAL;
                   |FINSI;
              |SIGUE;
          |SINO;
              |MENAV "0000Selecci¢n vac¡a";
          |FINSI;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = n2Vent;
          aVent5 = "MODELESS";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |FINVENTANA n2Vent;

          |CIERRA #consult@;
          |DELINDEX #consult@;
     |SIGUE;

     #siim0002#0 = #siim0001#0;
     #siim0002#1 = 1;
     |LEE 000#siim0002.];
|FPRC;

|PROCESO InformeComprobacion;
     |VENTANA 0501, 0501, -1, 16, "";
     n2Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |SUB_EJECUTA "siiy0001";

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n2Vent;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;
|FPRC;

|PROCESO InformeConsistencia;
     |VENTANA 0501, 0501, -1, 16, "";
     n2Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |SUB_EJECUTA "siiy0002";

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n2Vent;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;
|FPRC;

|PROCESO ProrrataProvisional;
     |VENTANA 0501, 0501, -1, -1, "";
     n2Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |SUB_EJECUTA "siim0055";

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n2Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n2Vent;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;
|FPRC;

|PROCESO CambiaContabilidad;
     |SI eaPaq = "BASICA";
         |CONFI "0000NSeguro que quiere los datos de la STARIII";
     |FINSI;

     |SI eaPaq = "AGICLI";
         |CONFI "0000NSeguro que quiere los datos de la CONTAGEN";
     |FINSI;

     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |ABRE #siim0000;
     |LEE 000#siim0000.p;

     |SI eaPaq = "BASICA";
         #siim0000#4 = "STARIII";
     |FINSI;

     |SI eaPaq = "AGICLI";
         #siim0000#4 = "CONTAGEN";
     |FINSI;

     |SI #siim0000#4 = "CONTAGEN";
         eaPaq = "BASICA";
     |FINSI;

     |SI #siim0000#4 = "STARIII ";
         eaPaq = "AGICLI";
     |FINSI;

     |GRABA 020#siim0000.a;
     |LIBERA #siim0000;
     |CIERRA #siim0000;

     |PTEC 807;
     nCamb = 1;
|FPRC;

|PROCESO EvtoTreeUtil;
     |SI FEntrada = 0;
         |ACABA;
     |FINSI;

     aContenido = Contenido % 103;

     |SI aContenido = "EPP";  |HAZ ProcesoPeriodico;     |FINSI;
     |SI aContenido = "PMV";  |HAZ PresentacionMasiva;   |FINSI;
     |SI aContenido = "CMV";  |HAZ ConsultaMasiva;       |FINSI;
     |SI aContenido = "CSV";  |HAZ ConsultaGridLotes;    |FINSI;
     |SI aContenido = "CSF";  |HAZ ConsultaGridFacturas; |FINSI;
     |SI aContenido = "ICC";  |HAZ InformeComprobacion;  |FINSI;
     |SI aContenido = "ICS";  |HAZ InformeConsistencia;  |FINSI;
     |SI aContenido = "FPP";  |HAZ ProrrataProvisional;  |FINSI;
     |SI aContenido = "CAM";  |HAZ CambiaContabilidad;   |FINSI;

     |PULSATECLA;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FOCOTECLADO nTree;

     |REFRESCACONTROL nGrid2;
|FPRC;

|PROCESO CargaArbol;
     aOpcion = aOpcion + &13 + &10;
     |XGRABA nHandle, aOpcion;
|FPRC;

|PROCESO BtnUtil;
     |VENTANA 0501, 1540, -1, 16, "Utilidades";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;
     |DBASE aBase;  |QBF aBase;
     aAlfa = aBase + "tmp";      |MKDIR aAlfa;

     sT_nID   = nTree;
     sT_nOper = 0;

     aAbre = aPathLocal + "tree" + Usuario + ".txt";
     |XABRE "WBC", aAbre, nHandle;

     nOpcion = 0;

     |SI eaBtnBox = "S";
         nOpcion  = nOpcion + 1;
         aOpcion  = nOpcion + ":Ejecutar proceso periodico {{EPP}}";
         |HAZ CargaArbol;
     |FINSI;

     |SI eaBtnBox = "N";
         nOpcion  = nOpcion + 1;
         aOpcion  = nOpcion + ":Presentacion masiva {{PMV}}";
         |HAZ CargaArbol;
     |FINSI;

     nOpcion  = nOpcion + 1;
     aOpcion  = nOpcion + ":Consulta masiva {{CMV}}";
     |HAZ CargaArbol;

     nOpcion  = nOpcion + 1;
     aOpcion  = nOpcion + ":Consulta selectiva vista por lotes{{CSV}}";
     |HAZ CargaArbol;

     nOpcion  = nOpcion + 1;
     aOpcion  = nOpcion + ":Consulta selectiva vista por facturas{{CSF}}";
     |HAZ CargaArbol;

     nOpcion  = nOpcion + 1;
     aOpcion  = nOpcion + ":Informe de comprobaci¢n {{ICC}}";
     |HAZ CargaArbol;

     |SI eaBtnCon = "S";
         nOpcion  = nOpcion + 1;
         aOpcion  = nOpcion + ":Informe de consistencia {{ICS}}";
         |HAZ CargaArbol;

         nOpcion  = nOpcion + 1;
         aOpcion  = nOpcion + ":Forzar prorrata provisional {{FPP}}";
         |HAZ CargaArbol;
     |FINSI;

     |SI eaBtnCon = "S";  |Y nApl = 2;
         nOpcion  = nOpcion + 1;

         |SI eaPaq = "BASICA";
             aOpcion  = nOpcion + ":Contabilidad cambiar a STARIII {{CAM}}";
         |FINSI;

         |SI eaPaq = "AGICLI";
             aOpcion  = nOpcion + ":Contabilidad cambiar a CONTAGEN {{CAM}}";
         |FINSI;

         |HAZ CargaArbol;
     |FINSI;

     |XCIERRA nHandle;

     aAlfa = "TREECTRL, Tabla de contenidos {{" + aAbre + "}}";
     |CONTROL_SIMPLE 0, aAlfa, 0602, 1338, EvtoTreeUtil;
     nTree = FSalida;

     |RFBORRA aAbre;

     sT_nID   = nTree;
     sT_nOper = 2;
     sT_aData = "1:";

     |ESPECIFICA "COMMANDCONTROL", sTree;

     |PULSATECLA;
     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::{{001}}sali&R," + nTree;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
         |SI aTecla = aRetu; |SAL;  |FINSI;

         #siim0002#0 = #siim0001#0;
         #siim0002#1 = 1;
         |LEE 000#siim0002.];

         |REFRESCACONTROL nGrid2;
     |SIGUE;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PULSATECLA;

     |FINVENTANA n1Vent;

     |REFRESCACONTROL nGrid2;
     |FOCOTECLADO nGrid2;

     |SI nCamb = 1;
         |DESTRUYECONTROL nBtnCon;

         |SI eaPaq = "BASICA";
             |CONTROL_SIMPLE 0, "BOTON,{{197}}Importaci¢n CONTAGEN", 3524, 3546, BtnConta;
         |FINSI;

         |SI eaPaq = "AGICLI";
             |CONTROL_SIMPLE 0, "BOTON,{{197}}Importaci¢n StarIII", 3524, 3546, BtnConta;
         |FINSI;

         nBtnCon = FSalida;
         nCamb   = 0;
     |FINSI;
|FPRC;

|PROGRAMA;
     |VENTANA 0501, 3599, -1, 16, "Bandeja control envios de facturas";
     n0Vent = FSalida;

     |CONTROL_SIMPLE 0, "LABEL,{{15}}Empresas", 0502, 0520, NULL;

     |CONTROL_SIMPLE 0, "LABEL,{{15}}Lotes", 1702, 1720, NULL;
     nBtnAcce = FSalida;

     |SI eaBtnBox = "S";
         |CONTROL_SIMPLE 0, "BOTON,{{197}}Definir accesos SIIBOX", 1502, 1523, AccesoSIIBOX;
         nBtnBox  = FSalida;
     |FINSI;

     |SI eaBtnEmp = "S";
         |CONTROL_SIMPLE 0, "BOTON,{{197}}Nueva empresa", 1580, 1598, NuevaEmp;
         nBtnEmp  = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{197}}Desactivar empresa", 1560, 1577, DesactivarEmp;
         nBtnDesa = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{197}}Cambiar periodicidad", 1538, 1558, CambiaPeriodo;
         nBtnCam  = FSalida;
     |FINSI;

     |SI eaBtnExc = "S";
         |CONTROL_SIMPLE 0, "BOTON,{{197}}Importaci¢n EXCEL/CSV", 3502, 3522, BtnExcel;
         nBtnExc = FSalida;
     |FINSI;

     |SI eaBtnCon = "S";
         |SI eaPaq = "BASICA";
             |CONTROL_SIMPLE 0, "BOTON,{{197}}Importaci¢n CONTAGEN", 3524, 3546, BtnConta;
         |FINSI;

         |SI eaPaq = "AGICLI";
             |CONTROL_SIMPLE 0, "BOTON,{{197}}Importaci¢n StarIII", 3524, 3546, BtnConta;
         |FINSI;

         nBtnCon = FSalida;
     |FINSI;

     |SI eaBtnLim = "N";
         |CONTROL_SIMPLE 0, "BOTON,{{197}}Utilidades", 3548, 3560, BtnUtil;
         nBtnUtil = FSalida;
     |FINSI;

     |SI eaBtnEnv = "S";
         |CONTROL_SIMPLE 0, "BOTON,{{197}}Enviar lote", 3222, 3237, BtnEnv;
         nBtnEnv = FSalida;
     |FINSI;

     |CONTROL_SIMPLE 0, "BOTON,{{193}}Nuevo lote", 3287, 3298, NuevoLote;
     nBtnNLot = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{199}}Borrar lote", 3275, 3285, BorrarLote;
     nBtnBLot = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{197}}Registros del lote", 3202, 3220, BtnFact;
     nBtnFact = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{197}}Estado del env¡o", 3240, 3257, BtnEstd;
     nBtnEstd = FSalida;

     |SI eaPaq = "";  |Y eaBtnEmp = "S";
         |ESTADO_CONTROL nBtnEmp,  "DISABLE";
         |ESTADO_CONTROL nBtnDesa, "DISABLE";
         |ESTADO_CONTROL nBtnCam, "DISABLE";
     |FINSI;

     |ESTADO_CONTROL nBtnDesa, "DISABLE";
     |ESTADO_CONTROL nBtnAcce, "DISABLE";
     |ESTADO_CONTROL nBtnNLot, "DISABLE";
     |ESTADO_CONTROL nBtnBLot, "DISABLE";
     |ESTADO_CONTROL nBtnFact, "DISABLE";
     |ESTADO_CONTROL nBtnEstd, "DISABLE";

     |SI nBtnEnv ! -1;
         |ESTADO_CONTROL nBtnEnv,  "DISABLE";
     |FINSI;

     nRango   = 2 + 4 + 8 + 16 + 32 + 128;
     |LINEAL_SIMPLE #3#siim0001, nRango, 0602, 1498, Baja1, Alta1, Evnt1;
     nGrid1 = FSalida;

     |LINEAL_SIMPLE #2#siim0002, nRango, 1802, 3198, Baja2, Alta2, Evnt2;
     nGrid2 = FSalida;

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
          FSalida = "::{{001}}Salir," + nGrid1;
          |LEETECLA aTecla;
          |SI aTecla = aEsc1; |SAL;  |FINSI;
          |SI aTecla = aEsc2; |SAL;  |FINSI;
          |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;

     |FINVENTANA n0Vent;

     |PULSATECLA;
|FPRO;

|PROCESO Sincro;
     aBase  = aBaseAplis % -299;
     aAse   = "";
     aLong  = aBase % 0;
     nLong  = aLong;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos       = (nCarac * 100) + 1;
           aCaracter  = aBase % nPos;
           aAse       = aAse + aCaracter;

           |SI aCaracter = "/";  |O aCaracter = "\";
               aAse = "";
           |FINSI;
     |SIGUE;

     aPathPlugins = aBaseSII + "plugins/";
     aApi         = aPathPlugins + "peticiones_api.py";
     aLogSincro   = aBaseSII + "peticiones_api.log";
     |FBORRA aLogSincro;

     aEjeSincro = eaPython;
     aEjeSincro = aEjeSincro + " " + aApi;
     aEjeSincro = aEjeSincro + " " + eaUrlSB;
     aEjeSincro = aEjeSincro + " /myapi/sincro/ase/";
     aEjeSincro = aEjeSincro + " " + eaUrlAP;
     aEjeSincro = aEjeSincro + " " + eaIni;
     aEjeSincro = aEjeSincro + " " + aLogSincro;
     |SYSTEM aEjeSincro;

     nSeg = 0;
     |PARA;  |SI;  |HACIENDO;
          |XABRE "E", aLogSincro, 0;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |SLEEP 1;

          nSeg = nSeg + 1;
          |SI nSeg ] 10;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     |XABRE "E", aLogSincro, 0;
     |SI FSalida ] 0;
         |XABRE "", aLogSincro, nHandle;
         |XLEE nHandle, 255, aLee;
         |XCIERRA nHandle;

         eaBtnBox = aLee % 101;
         eaBtnEmp = aLee % 201;
         eaBtnExc = aLee % 301;
         eaBtnCon = aLee % 401;
         eaBtnEnv = aLee % 501;
         eaBtnLim = aLee % 601;
     |SINO;
         |MENAV "0000Entorno de sistema incompleto. Consulte con su administrador.";
     |FINSI;

     |SI eaBtnBox ! "S";  |Y eaBtnBox ! "N";
         eaBtnBox = "N";
     |FINSI;

     |SI eaBtnEmp ! "S";  |Y eaBtnEmp ! "N";
         eaBtnEmp = "N";
     |FINSI;

     |SI eaBtnExc ! "S";  |Y eaBtnExc ! "N";
         eaBtnExc = "S";
     |FINSI;

     |SI eaBtnCon ! "S";  |Y eaBtnCon ! "N";
         eaBtnCon = "N";
     |FINSI;

     |SI eaBtnEnv ! "S";  |Y eaBtnEnv ! "N";
         eaBtnEnv = "S";
     |FINSI;

     |SI eaBtnLim ! "S";  |Y eaBtnLim ! "N";
         eaBtnLim = "N";
     |FINSI;
|FPRC;

|PROCESO Inicializa;
     |ABRE #siim0000;
     |LEE 000#siim0000.p;
     |SI FSalida ! 0;  |DDEFECTO #siim0000;  |FINSI;
     |CIERRA #siim0000;

     |SI #siim0000#2 > "01.01.1900";  |ACABA;  |FINSI;

     |ABRE #siim0002;
     |LEE 000#siim0002.p;
     nOk = FSalida;
     |CIERRA #siim0002;

     |ABRE #siim0002;  |CIERRA #siim0002;  |DELINDEX #siim0002;
     |ABRE #siim0003;  |CIERRA #siim0003;  |DELINDEX #siim0003;
     |ABRE #siim0004;  |CIERRA #siim0004;  |DELINDEX #siim0004;
     |ABRE #siim0005;  |CIERRA #siim0005;  |DELINDEX #siim0005;
     |ABRE #siim0006;  |CIERRA #siim0006;  |DELINDEX #siim0006;
     |ABRE #siim0007;  |CIERRA #siim0007;  |DELINDEX #siim0007;
     |ABRE #siim0008;  |CIERRA #siim0008;  |DELINDEX #siim0008;
     |ABRE #siim0009;  |CIERRA #siim0009;  |DELINDEX #siim0009;
     |ABRE #siim0010;  |CIERRA #siim0010;  |DELINDEX #siim0010;

     |ABRE #siim0000;
     |LEE 000#siim0000.p;
     |SI FSalida ! 0;
         |DDEFECTO #siim0000;
         |GRABA 020#siim0000.b;
     |FINSI;

     #siim0000#2 = ~;
     |GRABA 020#siim0000.a;

     |LIBERA #siim0000;
     |CIERRA #siim0000;

     |SI nOk = 0;
         |MENAV "0000Las pruebas anteriores al 01/07/2017 que se han detectado se han eliminado.";
     |FINSI;
|FPRC;

|PROCESO siim0002N;
     #siim0001#0 = #siim0002#0;
     |LEE 000#siim0001.=;

     #siim0002#13 = #siim0001#1;
     #siim0002#14 = #siim0001#2;

     |GRABA 020#siim0002.a;
     |LIBERA #siim0002;
|FPRC;

|DEFBUCLE siim0002N;
     #siim0002#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siim0002N;
|FIN;

|PROCESO T80;  |TIPO 80;
     |HAZ CambiaIni;

     fFecha = ~;
     |SI fFecha ] "01.07.2017";
         |HAZ Inicializa;
     |FINSI;

     |DBASS aBaseAplis;  |QBF aBaseAplis;
     |DBASE aBaseSII;

     eaPrograma   = "GRUPOOTP";
     |HAZ SIIBASE_INI;
     |SI enAprobacion = 1;
         enOTP = 1;
     |FINSI;

     eaPaq = "";
     nApl  = 0;

     aMas = aBaseAplis + "agicli/def/agifigen.mas";
     |XABRE "E", aMas, 0;
     |SI FSalida ] 0;
         eaPaq = "AGICLI";
         nApl  = nApl + 1;
     |FINSI;

     aMas = aBaseAplis + "basica/def/agifigen.mas";
     |XABRE "E", aMas, 0;
     |SI FSalida ] 0;
         eaPaq = "BASICA";
         nApl  = nApl + 1;
     |FINSI;

     |SI nApl = 2;
         |ABRE #siim0000;
         |LEE 000#siim0000.p;
         |SI FSalida ! 0;  |DDEFECTO #siim0000;  |FINSI;
         |CIERRA #siim0000;

         |SI #siim0000#4 = "CONTAGEN";
             eaPaq = "BASICA";
         |FINSI;

         |SI #siim0000#4 = "STARIII ";
             eaPaq = "AGICLI";
         |FINSI;
     |FINSI;

     eaBtnBox  = "N";
     eaBtnEmp  = "N";
     eaBtnExc  = "S";
     eaBtnCon  = "N";
     eaBtnEnv  = "S";
     eaBtnLim  = "N";

     |HAZ BuscaUrlSB;
     |HAZ AveriguaINI;
     |SI eaUrlSB ! "";
         |HAZ Sincro;
     |FINSI;

     |ABRET #siim0001;
     |ABRET #siim0002;

     |LEE 000#siim0002.p;
     |SI FSalida = 0;
         aAlfa = #siim0002#13 + #siim0002#14;  |QBF aAlfa;
         |SI aAlfa = "";
             |BUCLE siim0002N;
         |FINSI;
     |FINSI;

     |HAZ LeeUnidadBasico;

     aIP        = "";
     |IP_REMOTO aIP;

     aPathLocal = eaUnidadBasico + "\documentos";   |RMKDIR aPathLocal;
     aPathLocal = aPathLocal + "\siibase";          |RMKDIR aPathLocal;
     aPathLocal = aPathLocal + "\";
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #siim0001;
     |CIERRAT #siim0002;

     |SI eaUrlSB ! "";
         |FBORRA aLogSincro;
         |SYSTEM aEjeSincro;
     |FINSI;
|FPRC;
