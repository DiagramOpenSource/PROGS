|FICHEROS;
     siim0000;
     siim0502;
|FIN;

|VARIABLES;
     nHandle             = 0;
     nIni                = 0;
     nLong               = 0;
     nVoy                = 0;
     nSaca               = 0;

     aServ               = "";
     aAlfa               = "";
     aCadena             = "";
     aCR                 = "";
     aLF                 = "";
     aBase               = "";
     aFic                = "";
     aPathSII            = "";
     aAbre               = "";
     aFicTmp             = "";
     aSystema            = "";
     aLee                = "";
     aVersion            = "";
     aLong               = "";
     aLetra              = "";
     aQS                 = "";
     aIP                 = "";

 {-1}aSerie              = "";

     &enAprobacion       = "";
     &eaPrograma         = "";
     &eaUnidadBasico     = "";
     &eaPython           = "";
     &eaUrlSB            = "";
     &eaUrlAP            = "";
     &eaIni              = "";
     &enErrorPy          = 0;
     &eaMensaPy          = "";
|FIN;

|PROCESO QuitaBarras;
|FPRC;

|PROCESO AveriguaINI;
     eaUrlAP  = "";
     eaIni    = "";

     aSerie = "";
     |ESPECIFICA "SERIALIZACION", aSerie;
     eaIni = FSalida;
     eaIni = eaIni % 106;
     nIni  = eaIni;
     eaIni = ("000000" + nIni) % -106;

     |DBASS aBase;
     aLong = aBase % A0;
     nLong = aLong;
     |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
          nSaca  = (nVoy * 100) + 1;
          aLetra = aBase % nSaca;
          |SI aLetra = "/";  |O aLetra = "\";
               aLetra = "_";
          |FINSI;
          eaUrlAP = eaUrlAP + aLetra;

          |SI aLetra = ":";
              eaUrlAP = "";
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO SIIBASE_INI;
     enAprobacion = 0;

     |DBASE aBase;  |QBF aBase;
     aFic = aBase + "/siibase.ini";
     |XABRE "AB", aFic, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aCR        = &10;
     aLF        = &13;
     aCadena    = "";

     |XLEE nHandle, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            |SI aAlfa = aCR;
                |SI aCadena = eaPrograma;
                    enAprobacion = 1;
                    |SAL;
                |FINSI;

                aCadena = "";
            |SINO;
                |SI aAlfa ! aLF;
                    aCadena = aCadena + aAlfa;
                |FINSI;
            |FINSI;
            |XLEE nHandle, 1, aAlfa;
     |SIGUE;

     |SI aCadena = eaPrograma;
          enAprobacion = 1;
     |FINSI;

     |XCIERRA nHandle;
|FPRC;

|PROCESO siim0502;
     |SI #siim0502#2 = "SB";  |ACABA;  |FINSI;

     |SI #siim0502#1 ! aServ;
         |ACABA;
     |FINSI;

     aAlfa = "";
     |SI #siim0502#2 = "FE";
         |SI #siim0502#3 = "1";
             aAlfa = "Facturas Emitidas#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;

         |SI #siim0502#3 = "2";
             aAlfa = "Listado Facturas Emitidas#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;

         |SI #siim0502#3 = "3";
             aAlfa = "Borrado Facturas Emitidas#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;

         |SI #siim0502#3 = "4";
             aAlfa = "Cobro Facturas Emitidas#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;
     |FINSI;

     |SI #siim0502#2 = "FR";
         |SI #siim0502#3 = "1";
             aAlfa = "Facturas Recibidas#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;

         |SI #siim0502#3 = "2";
             aAlfa = "Listado Facturas Recibidas#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;

         |SI #siim0502#3 = "3";
             aAlfa = "Borrado Facturas Recibidas#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;

         |SI #siim0502#3 = "4";
             aAlfa = "Pago Facturas Recibidas#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;
     |FINSI;

     |SI #siim0502#2 = "OI";
         |SI #siim0502#3 = "1";
             aAlfa = "Facturas Operaciones Intracomunitarias#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;

         |SI #siim0502#3 = "2";
             aAlfa = "Listado Facturas Operaciones Intracomunitarias#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;

         |SI #siim0502#3 = "3";
             aAlfa = "Borrado Facturas Operaciones Intracomunitarias#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;
     |FINSI;

     |SI #siim0502#2 = "BI";
         |SI #siim0502#3 = "1";
             aAlfa = "Facturas Bienes de Inversion#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;

         |SI #siim0502#3 = "2";
             aAlfa = "Listado Facturas Bienes de Inversion#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;

         |SI #siim0502#3 = "3";
             aAlfa = "Borrado Facturas Bienes de Inversion#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;
     |FINSI;

     |SI #siim0502#2 = "PM";
         |SI #siim0502#3 = "1";
             aAlfa = "Operaciones trascendencia tributaria anual#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;

         |SI #siim0502#3 = "2";
             aAlfa = "Listado Operaciones trascendencia tributaria anual#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;

         |SI #siim0502#3 = "3";
             aAlfa = "Borrado Operaciones trascendencia tributaria anual#" + #siim0502#4;   |QBF aAlfa;
         |FINSI;
     |FINSI;

     |QBF aAlfa;
     |SI aAlfa ! "";
         aAlfa = aAlfa + &13 + &10;
         |XGRABA nHandle, aAlfa;
     |FINSI;
|FPRC;

|DEFBUCLE siim0502;
     #siim0502#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siim0502;
|FIN;

|PROCESO ServidorINI;
     aServ        = "";
     enAprobacion = 0;
     eaPrograma   = "SERVIDORPRUEBA";
     |HAZ SIIBASE_INI;
     |SI enAprobacion = 1;
         aServ = "P";
     |FINSI;
|FPRC;

|PROCESO QueServidor;
     |HAZ ServidorINI;

     |ABRE #siim0502;
     |SI aServ = "";
         |SELECT #2#siim0502;
         #siim0502#1 = "R";
         #siim0502#2 = "FE";
         #siim0502#3 = "1";
         |LEE 000#siim0502.=;
         |SI FSalida = 0;
             aServ = "R";
         |FINSI;
     |FINSI;

     |SI aServ = "";
         aServ = "P";
     |FINSI;

     |CIERRA #siim0502;
|FPRC;

|PROCESO CargaUrl;
     |HAZ QueServidor;

     aPathSII = eaUnidadBasico + "\documentos";
     aPathSII = aPathSII + "\siibase";
     aPathSII = aPathSII + "\";

     aAbre = aPathSII + "sii_urls.txt";
     |XABRE "WBC", aAbre, nHandle;
     |BUCLE siim0502;
     |XCIERRA nHandle;
|FPRC;

|PROCESO QuePython;
     |ABRE #siim0000;
     |LEE 000#siim0000.p;
     |SI FSalida ! 0;  |DDEFECTO #siim0000;  |FINSI;
     |CIERRA #siim0000;

     eaPython  = #siim0000#3;  |QBF eaPython;
     |SI eaPython ! "";  |ACABA;  |FINSI;

     eaPython  = "python2.7";

     aIP = ""; |IP_REMOTO aIP;
     aQS = ""; |QUE_SISTEMA aQS;
     |SI aIP = ""; |O aQS = "ESDOS";
          eaPython  = "python";
     |FINSI;
|FPRC;

|PROCESO VersionPython;
     |HAZ QuePython;

     |DBASE aBase;
     aFicTmp  = aBase + "peticiones_api.log";

     aSystema = eaPython + " --version 2> " + aFicTmp;
     |SYSTEM aSystema;

     enErrorPy = 0;
     eaMensaPy = "";

     |XABRE "E", aFicTmp, 0;
     |SI FSalida < 0;
         enErrorPy = 1;
         eaMensaPy = "Módulo python de sistema no encontrado";
     |SINO;
         |XABRE "", aFicTmp, nHandle;
         |XLEE nHandle, 255, aLee;
         |XCIERRA nHandle;

         aVersion = aLee - "Python ";  |QBT aVersion;
         |SI aVersion < "2.7.10";
             ||enErrorPy = 1;
             eaMensaPy = "Se requiere Python 2.7.10 (instalada " + aVersion + ")";
         |FINSI;
     |FINSI;

     |SI enErrorPy = 1;
         |XABRE "W", aFicTmp, nHandle;
         |XGRABA nHandle, eaMensaPy;
         |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROCESO BuscaUrlSB;
     eaUrlSB = "";

     |HAZ VersionPython;

     aServ = "R";

     |SI enErrorPy = 1;
         |ACABA;
     |FINSI;

     |ABRE #siim0502;
     |SELECT #2#siim0502;

     #siim0502#1 = aServ;
     #siim0502#2 = "SB";
     #siim0502#3 = "0";
     |LEE 000#siim0502.=;
     |SI FSalida = 0;
         eaUrlSB = #siim0502#4;  |QBF eaUrlSB;
     |FINSI;
|FPRC;

|PROCESO CambiaIni;
     |HAZ QueServidor;
     |SI aServ = "P";
         |MENAV "0000Detectada configuraci¢n para pruebas de env¡os a la AEAT.";
     |FINSI;
|FPRC;
