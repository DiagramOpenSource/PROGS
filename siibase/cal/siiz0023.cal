|FICHEROS;
     siim0001;
     siim0002;
     siim0004;
     siim0008;
     siim0051;
     siim0054;
     siim0101;

     siiw0200;
     siiw0202;
     siiw0204;
     siiw0206;

     casiim02@;
|FIN;

|VARIABLES;
     n1Vent              = 0;
     nOk                 = 0;
     nLong               = 0;
     nCarac              = 0;
     nPos                = 0;
     nHandle             = 0;
     nVeces              = 0;
     nPorce              = 0;
     nReg                = 0;
     nCampo              = 0;
     nCmp                = 0;
     nCmp1               = 0;
     nCmp2               = 0;
     nTCampo             = 0;
     nLot                = 0;
     nTReg               = 0;
     nCorre              = 0;
     nIncor              = 0;
     nCuot               = 0;
     nCuot1              = 0;
     nCuot2              = 0;
     nPer                = 0;
     nDPer               = 0;
     nHPer               = 0;
     nFacCero            = 0;
     nEmpCon             = 0;
     nEmpSii             = 0;

     aTPer               = "";
     aAlfa               = "";
     aParam1             = "";
     aParam2             = "";
     aParam3             = "";
     aProg               = "";
     aFicBrowse          = "";
     aVer1               = "";
     aVer2               = "";
     aOri                = "";
     aDes                = "";
     aBaseSII            = "";
     aFicConta           = "";
     aPathConta          = "";
     aDocumento          = "";
     aPathLocal          = "";
     aPathDoc            = "";
     aPathTmp            = "";
     aLong               = "";
     aIP                 = "";
     aAbre               = "";
     aLinea              = "";
     aRuta               = "";
     aFic                = "";
     aCaracter           = "";
     aVar                = "";
     aLee                = "";
     aC10                = "";
     aC13                = "";
     aCarac              = "";
     aFicTmp             = "";
     aQQ                 = "";
     aTipo               = "";
     aCif                = "";
     aNif                = "";
     aIdent              = "";
     aFecEx              = "";
     aExt                = "";
     aError1             = "";
     aError2             = "";
     aHora               = "";
     aModoImp            = "";
     aH60                = "";
     aMas                = "";

     fFecha              = @;

     {1}aConte           = "";

     {-1}aVent           = "";
         aVent1          = 0;
         aVent2          = 0;
         aVent3          = 0;
         aVent4          = 0;
         aVent5          = "";

     &eaUnidadBasico     = "";
     &eaAlfa             = "";
     &enEmp              = 0;
     &enLot              = 0;
     &enLotFor           = 0;
     &enID               = 0;
     &enOTP              = 0;
|FIN;

|| Lectura CSV ---------------------------------------------------------------

|PROCESO siiw0200Carga;
     nCampo            = #siiw0200#0;

     #siiw0202#0       = nReg;
     #siiw0202#nCampo# = #siiw0200#1#;
|FPRC;

|DEFBUCLE siiw0200Carga;
     #siiw0200#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siiw0200Carga;
|FIN;

|PROCESO GrabaDatos;
     |CIERRA #siiw0200;

     nReg = nReg + 1;

     |DDEFECTO #siiw0202;
     |BUCLE siiw0200Carga;
     |GRABA 020#siiw0202.n;
     |LIBERA #siiw0202;

     |DELINDEX #siiw0200;
     |PULSATECLA;
|FPRC;

|PROCESO Grabaw0200;
     |SI nCmp > nTCampo;
         |ACABA;
     |FINSI;

     #siiw0200#0 = nCmp;
     #siiw0200#1 = aVar;
     |GRABA 020#siiw0200.n;
     |LIBERA #siiw0200;
|FPRC;

|PROCESO SacaDatos;
     aLong  = aLee % 0;
     nLong  = aLong;
     aC10   = &10;
     aC13   = &13;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos   = (nCarac * 100) + 1;
           aCarac = aLee % nPos;

           |SI aCarac = aC13;
               aCarac = ";";

               nCmp   = nCmp + 1;
               |HAZ Grabaw0200;

               aVar   = "";
               aCarac = "";

               nCmp = nTCampo;
           |FINSI;

           |SI aCarac = ";";
               nCmp   = nCmp + 1;
               |HAZ Grabaw0200;

               aVar   = "";
               aCarac = "";
           |FINSI;

           |SI aCarac = aC10;
               aCarac = "";
           |FINSI;

           |SI nCmp = nTCampo;  |Y nCmp ! 0;
               |HAZ GrabaDatos;

               |ABRE #siiw0200;

               nCmp = 0;
           |FINSI;

           aVar = aVar + aCarac;
      |SIGUE;
|FPRC;

|PROCESO LeeFichero;
     nOk = 0;

     aFicTmp = "siiw0200" + Usuario;  |NOME_DAT #siiw0200#aFicTmp#;
     |ABRE #siiw0200;  |CIERRA #siiw0200;  |DELINDEX #siiw0200;

     aFicTmp = "siiw0202" + Usuario;  |NOME_DAT #siiw0202#aFicTmp#;
     |ABRE #siiw0202;  |CIERRA #siiw0202;  |DELINDEX #siiw0202;

     |ABRE #siiw0200;
     |ABRE #siiw0202;

     nCmp  = 0;
     nReg  = 0;

     |XABRE "B", aAbre, nHandle;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandle, 255, aLee;
          |SI FSalida [ 0;  |SAL;  |FINSI;

          |HAZ SacaDatos;
     |SIGUE;
     |XCIERRA nHandle;

     |LEE 000#siiw0200.p;
     |SI FSalida = 0;
         nCmp   = nCmp + 1;
         |HAZ Grabaw0200;
         |HAZ GrabaDatos;
     |FINSI;
     |CIERRA #siiw0200;

     |LEE 000#siiw0202.p;
     |SI FSalida = 0;
         nOk = 1;
     |FINSI;
     |CIERRA #siiw0202;
|FPRC;

|PROCESO PonDsselect;
     aVer1   = "";
     aVer2   = "";
     aConte  = aBaseSII + "plugins/dsselect.exe";
     |ESPECIFICA "MD5", aConte;
     aVer1 = FSalida;

     aConte  = aPathLocal + "dsselect.exe";
     |ESPECIFICA "REMOTOMD5", aConte;
     aVer2 = FSalida;

     |SI aVer1 ! aVer2;
         aOri = aBaseSII + "plugins/dsselect.exe";
         aDes = aPathLocal + "dsselect.exe";

         |SI aIP = "";
             |COPIA_FICHERO aOri, aDes;
         |SINO;
             |ENVIA_FICHERO aOri, aDes;
         |FINSI;

         aAlfa = aPathLocal + "dsselect.exe";
         |XABRE "EC", aAlfa, 0;
         |SI FSalida < 0;
             |MENAV "0000No encuentro el explorador de ficheros, por favor consulte con su administrador informatico.";
             |ACABA;
         |FINSI;
     |FINSI;

     nOk = 1;
|FPRC;

|PROCESO Dsofficetxt;
     aVer1   = "";
     aVer2   = "";
     aConte  = aBaseSII + "plugins/dsofficetxt.exe";
     |ESPECIFICA "MD5", aConte;
     aVer1 = FSalida;

     aConte  = aPathLocal + "dsofficetxt.exe";
     |ESPECIFICA "REMOTOMD5", aConte;
     aVer2 = FSalida;

     |SI aVer1 ! aVer2;
         aOri = aBaseSII + "plugins/dsofficetxt.exe";
         aDes = aPathLocal + "dsofficetxt.exe";

         |SI aIP = "";
             |COPIA_FICHERO aOri, aDes;
         |SINO;
             |ENVIA_FICHERO aOri, aDes;
         |FINSI;

         aAlfa = aPathLocal + "dsofficetxt.exe";
         |XABRE "EC", aAlfa, 0;
         |SI FSalida < 0;
             |MENAV "0000No encuentro el conversor a CSV, por favor consulte con su administrador informatico.";
             |ACABA;
         |FINSI;
     |FINSI;

     nOk = 1;
|FPRC;

|PROCESO Conversion;
     aAlfa = aPathLocal + "*.csv";
     |R_PDIR aAlfa;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |RFBORRA aAlfa;

          |R_SDIR aAlfa;
     |SIGUE;

     aExt = (aFic % -103) < "";
     |SI aExt = "csv";
         aOri    = aFicBrowse;
         aDes    = aPathLocal + "ficcsv.csv";
         aParam2 = aDes;
         |RCOPIA_FICHERO aOri, aDes;

         nOk = 1;
         |ACABA;
     |FINSI;

     nOk = 0;
     |HAZ Dsofficetxt;
     |SI nOk = 0;  |ACABA;  |FINSI;

     aParam2 = aPathLocal + "ficcsv.txt";  |RFBORRA aParam2;

     aProg   = aPathLocal + "dsofficetxt.exe";
     aParam1 = aFicBrowse;
     aParam2 = aPathLocal + "ficcsv.csv";
     aParam3 = "";

     aAbre = aPathLocal + "ejecuta.bat";
     |XABRE "WC", aAbre, nHandle;

     aAlfa  =  aProg + " " + &34 + aParam1 + &34 + " " + &34 + aParam2 + &34;
     |XGRABA nHandle, aAlfa;
     |XCIERRA nHandle;

     |RSYSTEM aAbre;

     nOk    = 1;
     nVeces = 0;
     |PARA;  |SI;  |HACIENDO;
          |XABRE "EC", aParam2, 0;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          nVeces = nVeces + 1;
          |SLEEP 1;

          |SI nVeces > 15;
              |MENAV "0000No se ha podido convertir a CSV el fichero seleccionado.";
              nOk = 0;
              |SAL;
          |FINSI;
     |SIGUE;

     |RFBORRA aAbre;
|FPRC;

|PROCESO RecogeCSV;
     |MENAV "0000A continuaci¢n busque y seleccione el fichero a importar";

     nOk = 0;
     |HAZ PonDsselect;
     |SI nOk = 0;  |ACABA;  |FINSI;

     aProg = aPathLocal + "dsselect.exe " + aPathLocal + "dsselect.ini";

     aAlfa = aPathLocal + "dsselect.txt";  |RFBORRA aAlfa;
     aAlfa = aPathLocal + "dsselect.ini";  |RFBORRA aAlfa;

     aAbre = aPathLocal + "dsselect.ini";
     |XABRE "CW", aAbre, nHandle;
     |SI FSalida ] 0;
          aLinea = &34 + aPathLocal + &34 + " " + &34 + aPathLocal + "dsselect.txt" + &34;
          |XGRABA nHandle, aLinea;
     |FINSI;
     |XCIERRA nHandle;

     |RSYSTEM aProg;
     |PULSATECLA;

     aRuta = "";
     aAbre = aPathLocal + "dsselect.txt";
     |XABRE "CU", aAbre, nHandle;
     |SI FSalida ] 0;
         |XLEE nHandle, 250, aRuta;
     |FINSI;
     |XCIERRA nHandle;

     aAlfa = aPathLocal + "dsselect.txt";
     |RFBORRA aAlfa;

     |PULSATECLA;

     |QBF aRuta;
     |SI aRuta = "";
         nOk = 0;
         |ACABA;
     |FINSI;

     aAlfa      = aRuta;
     aFicBrowse = "";
     aFic       = "";
     aLong      = aAlfa % 0;
     nLong      = aLong;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos       = (nCarac * 100) + 1;
           aCaracter  = aAlfa % nPos;
           aFicBrowse = aFicBrowse + aCaracter;
           aFic       = aFic + aCaracter;

           |SI aCaracter = "/";  |O aCaracter = "\";
               aFic = "";
           |FINSI;
     |SIGUE;

     nOk = 0;
     |HAZ Conversion;
     |SI nOk = 0;  |ACABA;  |FINSI;

     aOri  = aParam2;
     aDes  = aPathTmp + "ficcsv.csv";
     |SI aIP = "";
         |COPIA_FICHERO aOri, aDes;
     |SINO;
         |RECIBE_FICHERO aOri, aDes;
     |FINSI;
|FPRC;

|| Chequeo -----------------------------------------------------------------

|PROCESO siim0004Cheq;
     |SI #siim0004#78 = "C";  |O #siim0004#78 = "A";
      |O #siim0004#86 = "S";
         nOk   = 0;

         |ACABA;
     |FINSI;

     nOk = 1;
|FPRC;

|DEFBUCLE siim0004Cheq;
     #siim0004#2;
     16;
     #siim0001#0, #siiw0202#10, #siiw0202#5,          0,      0, #siiw0202#6;
     #siim0001#0, #siiw0202#10, #siiw0202#5, 9999999999, 999999, #siiw0202#6;
     ;
     NULL, siim0004Cheq;
|FIN;

|PROCESO GrabaW204;
     #siiw0204#0 = #siiw0202#0;
     #siiw0204#1 = aError1 + aError2;

     |GRABA 020#siiw0204.n;
     |LIBERA #siiw0204;
|FPRC;

|PROCESO GrabaW206;
     #siiw0206#0 = nEmpCon;
     #siiw0206#1 = #siiw0202#201;
     #siiw0206#2 = #siiw0202#202;
     #siiw0206#3 = #siiw0202#203;
     #siiw0206#4 = #siiw0202#204;
     #siiw0206#5 = aError2;

     |GRABA 020#siiw0206.n;
     |LIBERA #siiw0206;
|FPRC;

|PROCESO GrabaInci;
     |SI aModoImp = "CONTAGEN";  |O aModoImp = "AGICONT";
         |HAZ GrabaW206;
     |SINO;
         |HAZ GrabaW204;
     |FINSI;

     nOk = 0;
|FPRC;

|PROCESO siiw0202Cheq;
     nEmpCon = #siiw0202#200;
     nEmpSii = #siiw0202#200;
     |SI enOTP = 1;
         |SELECT #4#siim0101;
         #siim0101#5 = #siiw0202#200;
         |LEE 000#siim0101.=;
         |SI FSalida = 0;
             nEmpCon = #siim0101#0;
         |FINSI;
     |FINSI;

     nTReg = nTReg + 1;

     nPer  = #siiw0202#3;
     nDPer = #siiw0202#3;
     nHPer = #siiw0202#3;
     aTPer = "M";

     |SI #siiw0202#3 = "1T";  nDPer = 01;  nHPer = 03;  nPer = 1;  aTPer = "T";  |FINSI;
     |SI #siiw0202#3 = "2T";  nDPer = 04;  nHPer = 06;  nPer = 2;  aTPer = "T";  |FINSI;
     |SI #siiw0202#3 = "3T";  nDPer = 07;  nHPer = 09;  nPer = 3;  aTPer = "T";  |FINSI;
     |SI #siiw0202#3 = "4T";  nDPer = 10;  nHPer = 12;  nPer = 4;  aTPer = "T";  |FINSI;

     aAlfa = #siiw0202#9;  |QBF aAlfa;
     #siiw0202#9 = ("00" + aAlfa) % -102;

     aAlfa = #siiw0202#12;  |QBF aAlfa;
     |SI aAlfa = "";
         #siiw0202#12 = "ES";
     |FINSI;

     |SI aAlfa = "ESP";
         #siiw0202#12 = "ES";
     |FINSI;

     aAlfa = #siiw0202#15;  |QBF aAlfa;
     #siiw0202#15 = ("00" + aAlfa) % -102;

     aAlfa = #siiw0202#16;  |QBF aAlfa;
     #siiw0202#16 = ("00" + aAlfa) % -102;
     |SI #siiw0202#16 = "00";  #siiw0202#16 = "";  |FINSI;

     aAlfa = #siiw0202#17;  |QBF aAlfa;
     #siiw0202#17 = ("00" + aAlfa) % -102;
     |SI #siiw0202#17 = "00";  #siiw0202#17 = "";  |FINSI;

     |SI #siiw0202#19 = " ";  #siiw0202#19 = "N";  |FINSI;
     |SI #siiw0202#25 = " ";  #siiw0202#25 = "N";  |FINSI;
     |SI #siiw0202#31 = " ";  #siiw0202#31 = "N";  |FINSI;
     |SI #siiw0202#37 = " ";  #siiw0202#37 = "N";  |FINSI;
     |SI #siiw0202#43 = " ";  #siiw0202#43 = "N";  |FINSI;
     |SI #siiw0202#49 = " ";  #siiw0202#49 = "N";  |FINSI;
     |SI #siiw0202#87 = " ";  #siiw0202#87 = "N";  |FINSI;
     |SI #siiw0202#91 = " ";  #siiw0202#91 = "N";  |FINSI;

     |SI #siiw0202#7   < "01.01.2000";  #siiw0202#7   = "01.01.0000";  |FINSI;
     |SI #siiw0202#8   < "01.01.2000";  #siiw0202#8   = "01.01.0000";  |FINSI;
     |SI #siiw0202#68  < "01.01.2000";  #siiw0202#68  = "01.01.0000";  |FINSI;
     |SI #siiw0202#70  < "01.01.2000";  #siiw0202#70  = "01.01.0000";  |FINSI;
     |SI #siiw0202#72  < "01.01.2000";  #siiw0202#72  = "01.01.0000";  |FINSI;
     |SI #siiw0202#74  < "01.01.2000";  #siiw0202#74  = "01.01.0000";  |FINSI;
     |SI #siiw0202#76  < "01.01.2000";  #siiw0202#76  = "01.01.0000";  |FINSI;
     |SI #siiw0202#78  < "01.01.2000";  #siiw0202#78  = "01.01.0000";  |FINSI;
     |SI #siiw0202#80  < "01.01.2000";  #siiw0202#80  = "01.01.0000";  |FINSI;
     |SI #siiw0202#82  < "01.01.2000";  #siiw0202#82  = "01.01.0000";  |FINSI;
     |SI #siiw0202#84  < "01.01.2000";  #siiw0202#84  = "01.01.0000";  |FINSI;
     |SI #siiw0202#86  < "01.01.2000";  #siiw0202#86  = "01.01.0000";  |FINSI;

     |SI #siiw0202#22 = 0;  #siiw0202#21 = 0;  |FINSI;
     |SI #siiw0202#24 = 0;  #siiw0202#23 = 0;  |FINSI;
     |SI #siiw0202#28 = 0;  #siiw0202#27 = 0;  |FINSI;
     |SI #siiw0202#30 = 0;  #siiw0202#29 = 0;  |FINSI;
     |SI #siiw0202#34 = 0;  #siiw0202#33 = 0;  |FINSI;
     |SI #siiw0202#36 = 0;  #siiw0202#35 = 0;  |FINSI;
     |SI #siiw0202#40 = 0;  #siiw0202#39 = 0;  |FINSI;
     |SI #siiw0202#42 = 0;  #siiw0202#41 = 0;  |FINSI;
     |SI #siiw0202#46 = 0;  #siiw0202#45 = 0;  |FINSI;
     |SI #siiw0202#48 = 0;  #siiw0202#47 = 0;  |FINSI;
     |SI #siiw0202#52 = 0;  #siiw0202#51 = 0;  |FINSI;
     |SI #siiw0202#54 = 0;  #siiw0202#53 = 0;  |FINSI;

     |GRABA 020#siiw0202.a;
     |LIBERA #siiw0202;

     #siim0004#25 = #siiw0202#20 + #siiw0202#22 + #siiw0202#24;
     #siim0004#32 = #siiw0202#26 + #siiw0202#28 + #siiw0202#30;
     #siim0004#39 = #siiw0202#32 + #siiw0202#34 + #siiw0202#36;
     #siim0004#46 = #siiw0202#38 + #siiw0202#40 + #siiw0202#42;
     #siim0004#53 = #siiw0202#44 + #siiw0202#46 + #siiw0202#48;
     #siim0004#60 = #siiw0202#50 + #siiw0202#52 + #siiw0202#54;

     #siim0004#64 = #siim0004#25 + #siim0004#32 + #siim0004#39;
     #siim0004#64 = #siim0004#64 + #siim0004#46 + #siim0004#53;
     #siim0004#64 = #siim0004#64 + #siim0004#60;
     #siim0004#64 = #siim0004#64 + #siiw0202#55 + #siiw0202#57;

     |SI #siim0004#64 = 0;
         aError1 = "";
         aError2 = "Factura a cero. No se pasa el registro";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI aCif ! #siiw0202#1;
         aIdent = "";
         aFecEx = "";
         aNif   = "";
     |FINSI;

     |SI aIdent = #siiw0202#5;  |Y aCif = #siiw0202#1;  |Y aNif = #siiw0202#10;
      |Y aFecEx = #siiw0202#6;
         aError1 = "Columna E - ";
         aError2 = "Identificaci¢n de factura duplicada en una misma empresa";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     aCif   = #siiw0202#1;
     aNif   = #siiw0202#10;
     aIdent = #siiw0202#5;
     aFecEx = #siiw0202#6;

     |SI nEmpSii ! 0;
         |SELECT #1#siim0001;
         #siim0001#0 = nEmpSii;
     |FINSI;

     |SI nEmpSii = 0;
         |SELECT #2#siim0001;
         #siim0001#2 = #siiw0202#1;
     |FINSI;

     |LEE 000#siim0001.=;
     |SI FSalida ! 0;
         aError1 = "Columna A - ";
         aError2 = "Contenido incorrecto en el CIF emisor";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     nOk = 0;
     |BUCLE siim0004Cheq;
     |SI nOk = 1;
         aError1 = "";
         aError2 = "El registro ya est  dado de alta y pendiente de env¡o en la base de datos";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI #siiw0202#2 [ 2016;
         aError1 = "Columna B - ";
         aError2 = "Contenido incorrecto en ejercicio";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     nOk = 1;
     |SI aTPer = "M";
         |SI nPer < 1;  |O nPer > 12;
             nOk = 0;
         |FINSI;
     |SINO;
         |SI nPer < 1;  |O nPer > 4;
             nOk = 0;
         |FINSI;
     |FINSI;

     |SI nOk = 0;
         aError1 = "Columna C - ";
         aError2 = "Contenido incorrecto en periodo";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI #siiw0202#4 ! "R";
         aError1 = "Columna D - ";
         aError2 = "Contenido incorrecto en tipo, deben ser R";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     aAlfa = #siiw0202#5;  |QBF aAlfa;
     |SI aAlfa = "";
         aError1 = "Columna E - ";
         aError2 = "Contenido incorrecto en n£mero de factura";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI #siiw0202#6 < "01.01.2000";
         aError1 = "Columna F - ";
         aError2 = "Contenido incorrecto en fecha de expedici¢n";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI #siiw0202#8 < #siiw0202#6;
         aError1 = "Columna H - ";
         aError2 = "La fecha contable no puede ser inferior a la fecha expedici¢n";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     nOk   = 0;
     |SI #siiw0202#9 = "01";  nOk = 1;  |FINSI;
     |SI #siiw0202#9 = "02";  nOk = 1;  |FINSI;
     |SI #siiw0202#9 = "03";  nOk = 1;  |FINSI;
     |SI #siiw0202#9 = "04";  nOk = 1;  |FINSI;
     |SI #siiw0202#9 = "05";  nOk = 1;  |FINSI;
     |SI #siiw0202#9 = "06";  nOk = 1;  |FINSI;

     |SI nOk = 0;
         aError1 = "Columna I - ";
         aError2 = "Contenido incorrecto en identificacion fiscal";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI #siiw0202#9 = "01";
         aAlfa = #siiw0202#10;  |QBF aAlfa;
         |SI aAlfa = "";
             aError1 = "Columna J - ";
             aError2 = "Contenido incorrecto NIF, debe tener contenido";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;
     |FINSI;

     |SI #siiw0202#9 = "02";  |O #siiw0202#9 = "03"; |O #siiw0202#9 = "04";
      |O #siiw0202#9 = "05";  |O #siiw0202#9 = "06";
         aAlfa = #siiw0202#13;  |QBF aAlfa;
         |SI aAlfa = "";
             aError1 = "Columna M - ";
             aError2 = "Contenido incorrecto NIF pais residencia, debe tener contenido";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;
     |FINSI;

     nOk   = 0;
     |SI #siiw0202#14 = "F1";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "F2";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "F3";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "F4";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "F5";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "F6";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "R1";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "R2";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "R3";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "R4";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "R5";  nOk = 1;  |FINSI;

     |SI nOk = 0;
         aError1 = "Columna N - ";
         aError2 = "Contenido incorrecto en tipo de factura";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI #siiw0202#14 = "F5";
         |SI #siiw0202#10 ! #siiw0202#1;
             aError1 = "Columna J - ";
             aError2 = "Tipo factura F5. Los datos del proveedor deben ser los del titular del libro";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;
     |FINSI;

     nOk   = 0;
     |SI #siiw0202#15 = "01";  nOk = 1;  |FINSI;
     |SI #siiw0202#15 = "02";  nOk = 1;  |FINSI;
     |SI #siiw0202#15 = "03";  nOk = 1;  |FINSI;
     |SI #siiw0202#15 = "04";  nOk = 1;  |FINSI;
     |SI #siiw0202#15 = "05";  nOk = 1;  |FINSI;
     |SI #siiw0202#15 = "06";  nOk = 1;  |FINSI;
     |SI #siiw0202#15 = "07";  nOk = 1;  |FINSI;
     |SI #siiw0202#15 = "08";  nOk = 1;  |FINSI;
     |SI #siiw0202#15 = "09";  nOk = 1;  |FINSI;
     |SI #siiw0202#15 = "12";  nOk = 1;  |FINSI;
     |SI #siiw0202#15 = "13";  nOk = 1;  |FINSI;
     |SI #siiw0202#15 = "14";  nOk = 1;  |FINSI;

     |SI nOk = 0;
         aError1 = "Columna O - ";
         aError2 = "Contenido incorrecto en Clave ident.oper.trans.tributaria 1";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI #siiw0202#15 ! "14";
         |SI #siiw0202#9 = "02";
             |SI #siiw0202#15 ! "09";
                 aError1 = "Columna O - ";
                 aError2 = "Contenido incorrecto en Clave ident.oper.trans.tributaria 1 debe ser 09";
                 |HAZ GrabaInci;

                 |ACABA;
             |FINSI;
         |FINSI;

         |SI #siiw0202#15 = "13";
             |SI #siiw0202#14 ! "F6";
                 aError1 = "Columna N - ";
                 aError2 = "Clave operaci¢n 13 el tipo de factura deber¡a ser F6";
                 |HAZ GrabaInci;

                 |ACABA;
             |FINSI;

             nOk = 0;
             |PARA nCmp1 = 22;  |SI nCmp1 [ 52;  |HACIENDO nCmp1 = nCmp1 + 6;
                   |SI #siiw0202#nCmp1# ! 0;
                       nOk = 1;  |SAL;
                   |FINSI;
             |SIGUE;

             |SI nOk = 1;
                 aError1 = "Columna N - ";
                 aError2 = "Clave operaci¢n 13 y tipo de factura F6, no puede tener cuotas de IVA";
                 |HAZ GrabaInci;

                 |ACABA;
             |FINSI;
         |FINSI;

         |SI #siiw0202#15 = "02";
             |SI #siiw0202#14 ! "F6";
                 aError1 = "Columna N - ";
                 aError2 = "Clave operaci¢n 02 el tipo de factura deber¡a ser F6";
                 |HAZ GrabaInci;

                 |ACABA;
             |FINSI;

             |SI #siiw0202#55 = 0;  |Y #siiw0202#57 = 0;
                 aError1 = "Columna N - ";
                 aError2 = "Clave operaci¢n 02 y tipo de factura F6, no hay contenido en compensaci¢n REAGYP";
                 |HAZ GrabaInci;

                 |ACABA;
             |FINSI;
         |FINSI;
     |FINSI;

     aAlfa = #siiw0202#18;  |QBF aAlfa;
     |SI aAlfa ! "";
         |SI #siiw0202#18 = #siiw0202#5;
             aError1 = "Columna R - ";
             aError2 = "Contenido incorrecto en £ltimo n£mero factura, debe ser distnto a n£mero factura";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;

         |SI #siiw0202#14 ! "F4";
             aError1 = "Columna R - ";
             aError2 = "Contenido incorrecto en £ltimo n£mero factura, tiene contenido y el tipo de factura no es F4";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;
     |FINSI;

     nOk = 0;
     |SI #siiw0202#14 = "R1";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "R2";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "R3";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "R4";  nOk = 1;  |FINSI;
     |SI #siiw0202#14 = "R5";  nOk = 1;  |FINSI;

     |SI nOk = 1;
         |SI #siiw0202#61 = " ";
             aError1 = "Columna BI - ";
             aError2 = "Sin contenido en tipo rectificativa";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;

         |SI #siiw0202#61 = "S";
             |SI #siiw0202#62 = 0; |O #siiw0202#63 = 0;
/*
                 aError1 = "Columna BI - ";
                 aError2 = "Contenido incorrecto no viene informada la base y cuota de rectificaci¢n";
                 |HAZ GrabaInci;

                 |ACABA;
*/
             |FINSI;
         |FINSI;
     |SINO;
         |SI #siiw0202#61 ! " ";
             aError1 = "Columna BI - ";
             aError2 = "No procede contenido en tipo rectificativa";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;
     |FINSI;

     |SI #siiw0202#59 ! 0;
         nCuot = #siiw0202#57;
         |PARA nCmp1 = 22;  |SI nCmp1 [ 52;  |HACIENDO nCmp1 = nCmp1 + 6;
               nCuot = nCuot + #siiw0202#nCmp1#;
         |SIGUE;
         nCuot1 = nCuot ! 2;
         nCuot2 = #siiw0202#59 ! 2;

         |SI nCuot1 < 0; nCuot1 = -nCuot1;  |FINSI;
         |SI nCuot2 < 0; nCuot2 = -nCuot2;  |FINSI;

         |SI nCuot2 > nCuot1;
             aError1 = "Columna BG - ";
             aError2 = "Contenido incorrecto cuota deducible superior a las sumas de cuotas";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;
     |FINSI;

     aAlfa = #siiw0202#60;  |QBF aAlfa;
     |SI aAlfa = "";
         aError1 = "Columna BH - ";
         aError2 = "Sin contenido en descripci¢n de la operaci¢n";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;
|FPRC;

|DEFBUCLE siiw0202Cheq;
     #siiw0202#2;
     ;
     INICIO;
     FINAL;
     be;
     NULL, siiw0202Cheq;
|FIN;

|PROCESO siiw0204;
     nIncor = nIncor + 1;

     |SI aModoImp = "SIIBASE";
         |ACABA;
     |FINSI;

     eaAlfa  = (("00000" + #siiw0204#0) % -105) + "    ";
     eaAlfa  = eaAlfa + #siiw0204#1;  |QBF eaAlfa;
     eaAlfa  = eaAlfa + &13 + &10;
     |HAZ QuitaRaros;

     |XGRABA nHandle, eaAlfa;
|FPRC;

|DEFBUCLE siiw0204;
     #siiw0204#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siiw0204;
|FIN;

|PROCESO siiw0206;
     nIncor = nIncor + 1;

     aAlfa = #siiw0206#5 - "Factura a cero. No se pasa el registro";
     |SI FSalida = 0;
         nFacCero = 0;
     |FINSI;
|FPRC;

|DEFBUCLE siiw0206;
     #siiw0206#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siiw0206;
|FIN;

|PROCESO ModoCSV;
     aFicTmp = "siiw0204" + Usuario;  |NOME_DAT #siiw0204#aFicTmp#;
     |ABRE #siiw0204;  |CIERRA #siiw0204;  |DELINDEX #siiw0204;
     |ABRET #siiw0204;

     nTReg  = 0;
     nIncor = 0;
     |BUCLE siiw0202Cheq;

     nOk = 1;
     |LEE 000#siiw0204.p;
     |SI FSalida = 0;
         |SI aModoImp = "SIIBOX";
             aAbre = aPathDoc + (("00000000000" + #siim0051#0) % -111) + ".err";
             |XABRE "W", aAbre, nHandle;

             eaAlfa  = "Registro Incidencia" + &13 + &10;
             |XGRABA nHandle, eaAlfa;

             |BUCLE siiw0204;

             |XCIERRA nHandle;
         |FINSI;

         |SI aModoImp = "SIIBASE";
             |BUCLE siiw0204;

             |MENAV "0000Fichero con incidencias en recibidas, a continuaci¢n informamos de los errores";
             |CONSULTA_CLAVE #1#siiw0204;

             |CONFI "0000SQuiere consultar los datos tratados";
             |SI FSalida = 0;
                 |ABRE #siiw0202;
                 |CONSULTA_CLAVE #1#siiw0202;
                 |CIERRA #siiw0202;
             |FINSI;
         |FINSI;

         nOk = 0;
     |FINSI;
     |CIERRAT #siiw0204;
|FPRC;

|PROCESO PregCont;
     nOk = 0;
     |CONFI "0000NContinuamos con la importaci¢n a pesar de las incidencias";
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     |CONFI "0000NLos registros con incidencias pasaran igualmente menos las facturas a cero, est  seguro de no revisarlos en contabilidad";
     |SI FSalida = 0;
         nOk = 1;
     |FINSI;
|FPRC;

|PROCESO ModoContabilidad;
     aFicTmp = "siiw0206" + Usuario;  |NOME_DAT #siiw0206#aFicTmp#;
     |ABRE #siiw0206;  |CIERRA #siiw0206;  |DELINDEX #siiw0206;
     |ABRET #siiw0206;

     nTReg  = 0;
     nIncor = 0;
     |BUCLE siiw0202Cheq;

     nOk = 1;
     |LEE 000#siiw0206.p;
     |SI FSalida = 0;
         nFacCero = 1;
         |BUCLE siiw0206;

         |C_V #siiw0206#4, 1, "N";
         |SI aModoImp = "AGICONT";
             |C_V #siiw0206#4, 1, "S";
         |FINSI;

         |MENAV "0000Fichero con incidencias en recibidas , a continuaci¢n informamos de los errores";
         |CONSULTA_CLAVE #1#siiw0206;

         |CONFI "0000SQuiere consultar los datos tratados";
         |SI FSalida = 0;
             |ABRE #siiw0202;
             |CONSULTA_CLAVE #1#siiw0202;
             |CIERRA #siiw0202;
         |FINSI;

         |SI nFacCero = 0;
             |HAZ PregCont;
         |FINSI;
     |FINSI;

     |CIERRAT #siiw0206;
|FPRC;

|PROCESO ChequeaFichero;
     |SI aModoImp = "CONTAGEN";  |O aModoImp = "AGICONT";
         |HAZ ModoContabilidad;
     |SINO;
         |HAZ ModoCSV;
     |FINSI;
|FPRC;

|| Grabacion ----------------------------------------------------------------


|PROCESO siim0004;
     #siim0002#0 = #siim0004#0;
     #siim0002#1 = #siim0004#1;
     |LEE 000#siim0002.=;
     |SI FSalida ! 0;  |DDEFECTO #siim0002;  |FINSI;

     aTipo = #siim0002#2;
     |SI aTipo = "21";
         aTipo = "22";
     |FINSI;

     |SI #siim0004#86 = "S";
         nOk   = 0;
         aTipo = "";

         |ACABA;
     |FINSI;

     nOk = 1;
|FPRC;

|DEFBUCLE siim0004;
     #siim0004#2;
     16;
     #siim0001#0, #siiw0202#10, #siiw0202#5,          0,      0, #siiw0202#6;
     #siim0001#0, #siiw0202#10, #siiw0202#5, 9999999999, 999999, #siiw0202#6;
     ;
     NULL, siim0004;
|FIN;

|PROCESO siim0002;
     |SI #siim0002#8 > 0;  |O #siim0002#9 > 0;
         nLot = 0;
         |ACABA;
     |FINSI;

     nLot = #siim0002#1;
|FPRC;

|DEFBUCLE siim0002;
     #siim0002#3;
     2;
     #siim0001#0, #siiw0202#2, nPer, aTPer,          0, aTipo;
     #siim0001#0, #siiw0202#2, nPer, aTPer, 9999999999, aTipo;
     ;
     NULL, siim0002;
|FIN;

|PROCESO BuscaLote;
     nLot = enLotFor;
     |SI enLotFor = 0;
         |BUCLE siim0002;
     |FINSI;

     |SI nLot ! 0;
         #siim0002#0 = #siim0001#0;
         #siim0002#1 = nLot;
         |LEE 000#siim0002.=;

         |ACABA;
     |FINSI;

     |SELECT #1#siim0002;
     #siim0002#0 = #siim0001#0;
     #siim0002#1 = 9999999999;
     |LEE 000#siim0002.];
     |SI FSalida = 0;
         |LEE 000#siim0002.a;
     |SINO;
         |LEE 000#siim0002.u;
     |FINSI;

     nLot = 1;
     |SI FSalida = 0;  |Y  #siim0002#0 = #siim0001#0;
         nLot = #siim0002#1 + 1;
     |FINSI;

     |DDEFECTO #siim0002;
     #siim0002#0 = #siim0001#0;
     #siim0002#1 = nLot;
     #siim0002#2 = aTipo;

     |SI #siim0002#2 = "11"; #siim0002#3 = "Alta de facturas expedidas";                          |FINSI;
     |SI #siim0002#2 = "12"; #siim0002#3 = "Modificaci¢n de facturas expedidas";                  |FINSI;
     |SI #siim0002#2 = "14"; #siim0002#3 = "Suministro de cobros";                                |FINSI;
     |SI #siim0002#2 = "15"; #siim0002#3 = "Baja de facturas expedidas";                          |FINSI;

     |SI #siim0002#2 = "21"; #siim0002#3 = "Alta de facturas recibidas";                          |FINSI;
     |SI #siim0002#2 = "22"; #siim0002#3 = "Modificaci¢n de facturas recibidas";                  |FINSI;
     |SI #siim0002#2 = "24"; #siim0002#3 = "Suministro de pagos";                                 |FINSI;
     |SI #siim0002#2 = "25"; #siim0002#3 = "Baja de facturas recibidas";                          |FINSI;

     |SI #siim0002#2 = "31"; #siim0002#3 = "Alta de facturas de inversi¢n";                       |FINSI;
     |SI #siim0002#2 = "32"; #siim0002#3 = "Modificaci¢n de facturas de inversi¢n";               |FINSI;
     |SI #siim0002#2 = "35"; #siim0002#3 = "Baja de facturas de inversi¢n";                       |FINSI;

     #siim0002#4  = #siiw0202#2;
     #siim0002#5  = nPer;
     #siim0002#21 = aTPer;

     |GRABA 020#siim0002.n;
     |LIBERA #siim0002;
|FPRC;

|PROCESO casiim02;
     #siim0008#0   = #siim0004#0;
     #siim0008#1   = #siim0004#1;
     #siim0008#2   = #siim0004#2;
     #siim0008#3   = #casiim02@#3;
     |LEE 000#siim0008.=;
     |SI FSalida = 0;
         |ACABA;
     |FINSI;

     #siim0008#0   = #siim0004#0;
     #siim0008#1   = #siim0004#1;
     #siim0008#2   = #siim0004#2;
     #siim0008#3   = #casiim02@#3;
     #siim0008#4   = #casiim02@#4;

     |GRABA 020#siim0008.n;
     |LIBERA #siim0008;
|FPRC;

|DEFBUCLE casiim02;
     #casiim02@#1004;
     ;
     "camaniva", #siiw0202#202, #siiw0202#203, "";
     "camaniva", #siiw0202#202, #siiw0202#203, aH60;
     ;
     NULL, casiim02;
|FIN;

|DEFBUCLE casiim02_agicont;
     #casiim02@#1004;
     ;
     "caivasop", #siiw0202#202, aDocumento, "";
     "caivasop", #siiw0202#202, aDocumento, aH60;
     ;
     NULL, casiim02;
|FIN;

|PROCESO GrabaIdenti;
     nCmp2 = nCmp1 + 1;

     #siim0008#0   = #siim0004#0;
     #siim0008#1   = #siim0004#1;
     #siim0008#2   = #siim0004#2;
     #siim0008#3   = #siiw0202#nCmp1#;
     |LEE 000#siim0008.=;
     |SI FSalida = 0;
         |ACABA;
     |FINSI;

     #siim0008#0   = #siim0004#0;
     #siim0008#1   = #siim0004#1;
     #siim0008#2   = #siim0004#2;
     #siim0008#3   = #siiw0202#nCmp1#;
     #siim0008#4   = #siiw0202#nCmp2#;

     |GRABA 020#siim0008.n;
     |LIBERA #siim0008;
|FPRC;

|PROCESO GrabaSii8;
     aH60 = "z" * 60;

     |SI aModoImp = "AGICONT";

         aDocumento = #siiw0202#204 + ("000000" + #siiw0202#203) % -106;

         |DBASS aPathConta;
         aPathConta = aPathConta + "agicont/";

         aMas = aPathConta + "def/casiim02.mas";
         |XABRE "E", aMas, 0;
         |SI FSalida ] 0;
             |CARGA_DEF aMas, casiim02@;

             aFicConta = aPathConta + "fich/" + (("00000" + nEmpCon) % -105) + #siiw0202#201 + "/";
             |PATH_DAT #casiim02@#aFicConta#;

             |BUCLE casiim02_agicont;

             |DESCARGA_DEF #casiim02@;
         |FINSI;

         |ACABA;
     |FINSI;

     |SI aModoImp = "CONTAGEN";

         |DBASS aPathConta;
         aPathConta = aPathConta + "contagen/";

         aMas = aPathConta + "def/casiim02.mas";
         |XABRE "E", aMas, 0;
         |SI FSalida ] 0;
             |CARGA_DEF aMas, casiim02@;

             aFicConta = aPathConta + "fich/" + (("00000" + nEmpCon) % -105) + #siiw0202#201 + "/";
             |PATH_DAT #casiim02@#aFicConta#;

             |BUCLE casiim02;

             |DESCARGA_DEF #casiim02@;
         |FINSI;

         |ACABA;
     |FINSI;

     nReg = 0;
     |SI #siim0004#6 = "R1";  |O #siim0004#6 = "R2";
      |O #siim0004#6 = "R3";  |O #siim0004#6 = "R4";
      |O #siim0004#6 = "R5";
      |O #siim0004#6 = "F3";
         |PARA nCmp1 = 67;  |SI nCmp1 [ 85;  |HACIENDO nCmp1 = nCmp1 + 2;
               aAlfa = #siiw0202#nCmp1#;  |QBF aAlfa;
               |SI aAlfa ! "";
                   |HAZ GrabaIdenti;
               |FINSI;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO siiw0202Gra;
     nEmpCon = #siiw0202#200;
     nEmpSii = #siiw0202#200;
     |SI enOTP = 1;
         |SELECT #4#siim0101;
         #siim0101#5 = #siiw0202#200;
         |LEE 000#siim0101.=;
         |SI FSalida = 0;
             nEmpCon = #siim0101#0;
         |FINSI;
     |FINSI;

     #siim0004#25 = #siiw0202#20 + #siiw0202#22 + #siiw0202#24;
     #siim0004#32 = #siiw0202#26 + #siiw0202#28 + #siiw0202#30;
     #siim0004#39 = #siiw0202#32 + #siiw0202#34 + #siiw0202#36;
     #siim0004#46 = #siiw0202#38 + #siiw0202#40 + #siiw0202#42;
     #siim0004#53 = #siiw0202#44 + #siiw0202#46 + #siiw0202#48;
     #siim0004#60 = #siiw0202#50 + #siiw0202#52 + #siiw0202#54;

     #siim0004#64 = #siim0004#25 + #siim0004#32 + #siim0004#39;
     #siim0004#64 = #siim0004#64 + #siim0004#46 + #siim0004#53;
     #siim0004#64 = #siim0004#64 + #siim0004#60;
     #siim0004#64 = #siim0004#64 + #siiw0202#55 + #siiw0202#57;

     |SI #siim0004#64 = 0;
         |ACABA;
     |FINSI;

     nPer  = #siiw0202#3;
     nDPer = #siiw0202#3;
     nHPer = #siiw0202#3;
     aTPer = "M";

     |SI #siiw0202#3 = "1T";  nDPer = 01;  nHPer = 03;  nPer = 1;  aTPer = "T";  |FINSI;
     |SI #siiw0202#3 = "2T";  nDPer = 04;  nHPer = 06;  nPer = 2;  aTPer = "T";  |FINSI;
     |SI #siiw0202#3 = "3T";  nDPer = 07;  nHPer = 09;  nPer = 3;  aTPer = "T";  |FINSI;
     |SI #siiw0202#3 = "4T";  nDPer = 10;  nHPer = 12;  nPer = 4;  aTPer = "T";  |FINSI;

     |SI nEmpSii ! 0;
         |SELECT #1#siim0001;
         #siim0001#0 = nEmpSii;
     |FINSI;

     |SI nEmpSii = 0;
         |SELECT #2#siim0001;
         #siim0001#2 = #siiw0202#1;
     |FINSI;

     |LEE 000#siim0001.=;

     |SI aModoImp = "CONTAGEN";  |O aModoImp = "AGICONT";
         nOk   = 0;
         |BUCLE siim0004Cheq;
         |SI nOk = 1;  |ACABA;  |FINSI;
     |FINSI;

     nOk   = 0;
     |BUCLE siim0004;
     |SI nOk = 0;
         aTipo = "21";
     |FINSI;

     |HAZ BuscaLote;

     #siim0004#0  = #siim0002#0;
     #siim0004#1  = #siim0002#1;
     #siim0004#2  = 999999;
     |LEE 000#siim0004.];
     |SI FSalida = 0;
         |LEE 000#siim0004.a;
     |SINO;
         |LEE 000#siim0004.u;
     |FINSI;

     nReg = 1;
     |SI FSalida = 0;  |Y #siim0004#0  = #siim0002#0;
                       |Y #siim0004#1  = #siim0002#1;
         nReg = #siim0004#2 + 1;
     |FINSI;

     |DDEFECTO #siim0004;
     #siim0004#0   = #siim0002#0;
     #siim0004#1   = #siim0002#1;
     #siim0004#2   = nReg;
     #siim0004#3   = #siiw0202#2;
     #siim0004#4   = #siim0002#5;
     #siim0004#5   = #siiw0202#9;
     #siim0004#6   = #siiw0202#14;
     #siim0004#7   = #siiw0202#15;
     #siim0004#8   = #siiw0202#16;
     #siim0004#9   = #siiw0202#17;
     #siim0004#10  = #siiw0202#10;
     #siim0004#11  = #siiw0202#11;
     #siim0004#12  = #siiw0202#12;
     #siim0004#13  = #siiw0202#13;
     #siim0004#14  = #siiw0202#5;
     #siim0004#15  = #siiw0202#18;
     #siim0004#16  = #siiw0202#6;
     #siim0004#17  = #siiw0202#8;
     #siim0004#18  = #siiw0202#7;

     #siim0004#19  = #siiw0202#19;
     #siim0004#20  = #siiw0202#20;
     #siim0004#21  = #siiw0202#21;
     #siim0004#22  = #siiw0202#22;
     #siim0004#23  = #siiw0202#23;
     #siim0004#24  = #siiw0202#24;

     #siim0004#26  = #siiw0202#25;
     #siim0004#27  = #siiw0202#26;
     #siim0004#28  = #siiw0202#27;
     #siim0004#29  = #siiw0202#28;
     #siim0004#30  = #siiw0202#29;
     #siim0004#31  = #siiw0202#30;

     #siim0004#33  = #siiw0202#31;
     #siim0004#34  = #siiw0202#32;
     #siim0004#35  = #siiw0202#33;
     #siim0004#36  = #siiw0202#34;
     #siim0004#37  = #siiw0202#35;
     #siim0004#38  = #siiw0202#36;

     #siim0004#40  = #siiw0202#37;
     #siim0004#41  = #siiw0202#38;
     #siim0004#42  = #siiw0202#39;
     #siim0004#43  = #siiw0202#40;
     #siim0004#44  = #siiw0202#41;
     #siim0004#45  = #siiw0202#42;

     #siim0004#47  = #siiw0202#43;
     #siim0004#48  = #siiw0202#44;
     #siim0004#49  = #siiw0202#45;
     #siim0004#50  = #siiw0202#46;
     #siim0004#51  = #siiw0202#47;
     #siim0004#52  = #siiw0202#48;

     #siim0004#54  = #siiw0202#49;
     #siim0004#55  = #siiw0202#50;
     #siim0004#56  = #siiw0202#51;
     #siim0004#57  = #siiw0202#52;
     #siim0004#58  = #siiw0202#53;
     #siim0004#59  = #siiw0202#54;

     #siim0004#61  = #siiw0202#55;
     #siim0004#62  = #siiw0202#56;
     #siim0004#63  = #siiw0202#57;
     #siim0004#65  = #siiw0202#59;
     #siim0004#66  = #siiw0202#66;

     #siim0004#67  = #siiw0202#60 % 180;
     #siim0004#68  = #siiw0202#60 % 8180;
     #siim0004#69  = #siiw0202#60 % 16180;

     #siim0004#70  = #siiw0202#61;
     #siim0004#71  = #siiw0202#62;
     #siim0004#72  = #siiw0202#63;
     #siim0004#73  = #siiw0202#64;
     #siim0004#74  = #siiw0202#65;

     #siim0004#87  = #siiw0202#87;
     #siim0004#88  = #siiw0202#91;
     #siim0004#89  = #siiw0202#88;
     #siim0004#90  = #siiw0202#89;
     #siim0004#91  = #siiw0202#90;

     #siim0004#25 = #siim0004#20 + #siim0004#22 + #siim0004#24;
     #siim0004#32 = #siim0004#27 + #siim0004#29 + #siim0004#31;
     #siim0004#39 = #siim0004#34 + #siim0004#36 + #siim0004#38;
     #siim0004#46 = #siim0004#41 + #siim0004#43 + #siim0004#45;
     #siim0004#53 = #siim0004#48 + #siim0004#50 + #siim0004#52;
     #siim0004#60 = #siim0004#55 + #siim0004#57 + #siim0004#59;

     #siim0004#64 = #siim0004#25 + #siim0004#32 + #siim0004#39;
     #siim0004#64 = #siim0004#64 + #siim0004#46 + #siim0004#53;
     #siim0004#64 = #siim0004#64 + #siim0004#60;
     #siim0004#64 = #siim0004#64 + #siim0004#61 + #siim0004#63;

     |SI aModoImp = "CONTAGEN";
         #siim0004#83 = #siiw0202#202;
         #siim0004#84 = #siiw0202#203;
     |FINSI;

     |SI aModoImp = "AGICONT";
         #siim0004#83 = #siiw0202#202;
         #siim0004#84 = #siiw0202#203;
         #siim0004#85 = #siiw0202#204;
     |FINSI;

     |GRABA 020#siim0004.n;
     |LIBERA #siim0004;

     nTReg = nTReg + 1;

     |HAZ GrabaSii8;

     enEmp = #siim0002#0;
     enLot = #siim0002#1;
     |SUB_EJECUTA "siiz0003;REFRESCA";
|FPRC;

|DEFBUCLE siiw0202Gra;
     #siiw0202#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siiw0202Gra;
|FIN;

|| --------------------------------------------------------------------------

|PROCESO AbreVtn;
     |VENTANA 0501, 0540, -1, 16, "Realizando la importaci¢n";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;
|FPRC;

|PROCESO CierraVtn;
     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;
|FPRC;

|PROCESO CONTABILIDAD;
     aFicTmp = "siiw0202" + Usuario;  |NOME_DAT #siiw0202#aFicTmp#;
     |HAZ ChequeaFichero;
     |SI nOk = 0;
         nCorre  = nTReg - nIncor;
         aAlfa   = "0000Importaci¢n facturas recibidas cancelada. Leidos " + nTReg;
         aAlfa   = aAlfa + " - Correctos " + nCorre;
         aAlfa   = aAlfa + " - Incorrectos " + nIncor;

         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     nTReg = 0;
     |BUCLE siiw0202Gra;

     aAlfa = "0000Importado " + nTReg + " registros en recibidas";
     |MENAV aAlfa;
|FPRC;

|PROCESO GrabaNoti;
     |LEE 000#siim0054.u;
     |SI FSalida ! 0;  |DDEFECTO #siim0054;  |FINSI;

     nReg = #siim0054#0 + 1;

     |DDEFECTO #siim0054;
     #siim0054#0  = nReg;
     #siim0054#1  = fFecha;
     #siim0054#2  = aHora;
     #siim0054#3  = #siim0051#5;
     #siim0054#4  = #siim0051#6;
     #siim0054#5  = "IMPORTACION";
     #siim0054#6  = #siim0051#0;

     |GRABA 020#siim0054.n;
     |LIBERA #siim0054;
|FPRC;

|PROCESO SIIBOX;
     #siim0051#0 = enID;
     |LEE 101#siim0051.=;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     fFecha = ~;
     |HORA aHora;

     aAlfa = aPathDoc + (("00000000000" + #siim0051#0) % -111) + ".err";
     |FBORRA aAlfa;

     aAbre = aPathDoc + (("00000000000" + #siim0051#0) % -111) + ".csv";
     |XABRE "E", aAbre, 0;
     |SI FSalida < 0;
         aAbre = aPathDoc + (("00000000000" + #siim0051#0) % -111) + ".err";
         |XABRE "W", aAbre, nHandle;
         eaAlfa = "No existe documento CSV" + &13 + &10;
         |XGRABA nHandle, eaAlfa;
         |XCIERRA nHandle;

         #siim0051#3 = fFecha;
         #siim0051#4 = aHora;
         #siim0051#5 = "Incorrecto";
         #siim0051#6 = "No existe documento CSV";

         |GRABA 020#siim0051.a;
         |LIBERA #siim0051;

         |HAZ GrabaNoti;

         |ACABA;
     |FINSI;

     aAbre = aPathDoc + (("00000000000" + #siim0051#0) % -111) + ".csv";
     |HAZ LeeFichero;

     |SI nOk = 0;
         aAbre = aPathDoc + (("00000000000" + #siim0051#0) % -111) + ".err";
         |XABRE "W", aAbre, nHandle;
         eaAlfa = "CSV no v lido" + &13 + &10;
         |HAZ QuitaRaros;
         |XGRABA nHandle, eaAlfa;
         |XCIERRA nHandle;

         #siim0051#3 = fFecha;
         #siim0051#4 = aHora;
         #siim0051#5 = "Incorrecto";
         #siim0051#6 = "Documento CSV no v lido";

         |GRABA 020#siim0051.a;
         |LIBERA #siim0051;

         |HAZ GrabaNoti;

         |ACABA;
     |FINSI;

     |HAZ ChequeaFichero;
     |SI nOk = 0;
         nCorre  = nTReg - nIncor;
         aAlfa   = "Importaci¢n facturas recibidas cancelada. Leidos " + nTReg;
         aAlfa   = aAlfa + " - Correctos " + nCorre;
         aAlfa   = aAlfa + " - Incorrectos " + nIncor;

         #siim0051#3 = fFecha;
         #siim0051#4 = aHora;
         #siim0051#5 = "Incorrecto";
         #siim0051#6 = aAlfa;

         |GRABA 020#siim0051.a;
         |LIBERA #siim0051;

         |HAZ GrabaNoti;

         |ACABA;
     |FINSI;

     aAlfa = "Importado " + nTReg + " registros";

     #siim0051#3 = fFecha;
     #siim0051#4 = aHora;
     #siim0051#5 = "Correcto";
     #siim0051#6 = aAlfa;

     |GRABA 020#siim0051.a;
     |LIBERA #siim0051;

     |HAZ GrabaNoti;

     nTReg = 0;
     |BUCLE siiw0202Gra;

     |CIERRA #siim0051;
|FPRC;

|PROCESO SIIBASE;
     |HAZ RecogeCSV;
     |SI nOk = 0;  |ACABA;  |FINSI;

     |HAZ AbreVtn;
     aAbre = aPathTmp + "ficcsv.csv";
     |HAZ LeeFichero;
     |SI nOk = 0;
         |MENAV "0000Excel no v lida";
         |HAZ CierraVtn;
         |ACABA;
     |FINSI;

     |HAZ ChequeaFichero;
     |SI nOk = 0;
         |HAZ CierraVtn;
         |ACABA;
     |FINSI;

     nTReg = 0;
     |BUCLE siiw0202Gra;

     |HAZ CierraVtn;
|FPRC;

|PROGRAMA;
     |SI aModoImp = "CONTAGEN";  |O aModoImp = "AGICONT";
         |HAZ AbreVtn;
         |HAZ CONTABILIDAD;
         |HAZ CierraVtn;
     |FINSI;

     |SI aModoImp = "SIIBOX";
         |HAZ SIIBOX;
     |FINSI;

     |SI aModoImp = "SIIBASE";
         |HAZ SIIBASE;
     |FINSI;
|FPRO;

|PROCESO T80;  |TIPO 80;
     aModoImp = PARAMETRO;  |QBF aModoImp;

     nTCampo  = 91;

     aIP      = "";
     |IP_REMOTO aIP;

     |DBASE aBaseSII;

     |SI aModoImp = "SIIBOX";
         aPathDoc = aBaseSII + "documentos";        |MKDIR aPathDoc;
         aPathDoc = aBaseSII + "documentos/csv";    |MKDIR aPathDoc;
         aPathDoc = aBaseSII + "documentos/csv/";
     |FINSI;

     |SI aModoImp = "SIIBASE";
         |HAZ LeeUnidadBasico;

         aPathLocal = eaUnidadBasico + "\documentos";   |RMKDIR aPathLocal;
         aPathLocal = aPathLocal + "\tmp";              |RMKDIR aPathLocal;
         aPathLocal = aPathLocal + "\";
     |FINSI;

     aPathTmp = aBaseSII + "tmp";                    |MKDIR aPathTmp;
     aPathTmp = aBaseSII + "tmp/" + Usuario;         |MKDIR aPathTmp;
     aPathTmp = aBaseSII + "tmp/" + Usuario + "/";

     |ABRET #siim0001;
     |ABRET #siim0002;
     |ABRET #siim0004;
     |ABRET #siim0008;
     |ABRET #siim0101;

     |SI aModoImp = "SIIBOX";
         |ABRET #siim0051;
     |FINSI;
|FPRC;

|PROCESO T90;  |TIPO 90;
     aFicTmp = "siiw0200" + Usuario;  |NOME_DAT #siiw0200#aFicTmp#;
     |ABRE #siiw0200;  |CIERRA #siiw0200;  |DELINDEX #siiw0200;

     aFicTmp = "siiw0202" + Usuario;  |NOME_DAT #siiw0202#aFicTmp#;
     |ABRE #siiw0202;  |CIERRA #siiw0202;  |DELINDEX #siiw0202;

     aFicTmp = "siiw0204" + Usuario;  |NOME_DAT #siiw0204#aFicTmp#;
     |ABRE #siiw0204;  |CIERRA #siiw0204;  |DELINDEX #siiw0204;

     aFicTmp = "siiw0206" + Usuario;  |NOME_DAT #siiw0206#aFicTmp#;
     |ABRE #siiw0206;  |CIERRA #siiw0206;  |DELINDEX #siiw0206;

     aAlfa = aPathLocal + "*.csv";
     |R_PDIR aAlfa;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |RFBORRA aAlfa;

          |R_SDIR aAlfa;
     |SIGUE;

     |CIERRAT #siim0001;
     |CIERRAT #siim0002;
     |CIERRAT #siim0004;
     |CIERRAT #siim0008;
     |CIERRAT #siim0101;

     |SI aModoImp = "SIIBOX";
         |CIERRAT #siim0051;
     |FINSI;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PTEC 802;  |PAUSA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;
