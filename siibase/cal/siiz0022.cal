|FICHEROS;
     siim0001;
     siim0002;
     siim0003;
     siim0007;
     siim0051;
     siim0054;
     siim0101;

     siiw0200;
     siiw0201;
     siiw0204;
     siiw0206;

     casiim02@;
|FIN;

|VARIABLES;
     n1Vent              = 0;
     nOk                 = 0;
     nLong               = 0;
     nCarac              = 0;
     nPos                = 0;
     nHandle             = 0;
     nVeces              = 0;
     nPorce              = 0;
     nReg                = 0;
     nCampo              = 0;
     nCmp                = 0;
     nCmp1               = 0;
     nCmp2               = 0;
     nCmp3               = 0;
     nCmp4               = 0;
     nTCampo             = 0;
     nLot                = 0;
     nTReg               = 0;
     nCorre              = 0;
     nIncor              = 0;
     nConta              = 0;
     nContaBE            = 0;
     nContaPE            = 0;
     nContaEE            = 0;
     nContaBS1           = 0;
     nContaBS2           = 0;
     nContaBS3           = 0;
     nContaPS1           = 0;
     nContaPS2           = 0;
     nContaPS3           = 0;
     nContaES1           = 0;
     nContaES2           = 0;
     nContaES3           = 0;
     nContaBN1           = 0;
     nContaBN2           = 0;
     nContaPN1           = 0;
     nContaPN2           = 0;
     nContaEN1           = 0;
     nContaEN2           = 0;
     nBas                = 0;
     nPer                = 0;
     nDPer               = 0;
     nHPer               = 0;
     nFacCero            = 0;
     nEmpCon             = 0;
     nEmpSii             = 0;

     aTPer               = "";
     aAlfa               = "";
     aAlfa1              = "";
     aParam1             = "";
     aParam2             = "";
     aParam3             = "";
     aProg               = "";
     aFicBrowse          = "";
     aVer1               = "";
     aVer2               = "";
     aOri                = "";
     aDes                = "";
     aDocumento          = "";
     aBaseSII            = "";
     aFicConta           = "";
     aPathConta          = "";
     aPathLocal          = "";
     aPathDoc            = "";
     aPathTmp            = "";
     aLong               = "";
     aIP                 = "";
     aAbre               = "";
     aLinea              = "";
     aRuta               = "";
     aFic                = "";
     aCaracter           = "";
     aVar                = "";
     aLee                = "";
     aC10                = "";
     aC13                = "";
     aCarac              = "";
     aFicTmp             = "";
     aQQ                 = "";
     aTipo               = "";
     aCif                = "";
     aIdent              = "";
     aFecEx              = "";
     aExt                = "";
     aError1             = "";
     aError2             = "";
     aHora               = "";
     aModoImp            = "";
     aH60                = "";
     aMas                = "";

     fFecha              = @;

     {1}aConte           = "";

     {-1}aVent           = "";
         aVent1          = 0;
         aVent2          = 0;
         aVent3          = 0;
         aVent4          = 0;
         aVent5          = "";

     &eaUnidadBasico     = "";
     &eaAlfa             = "";
     &enEmp              = 0;
     &enLot              = 0;
     &enLotFor           = 0;
     &enID               = 0;
     &enOTP              = 0;
|FIN;

|| Lectura CSV --------------------------------------------------------------

|PROCESO siiw0200Carga;
     nCampo            = #siiw0200#0;

     #siiw0201#0       = nReg;
     #siiw0201#nCampo# = #siiw0200#1;
|FPRC;

|DEFBUCLE siiw0200Carga;
     #siiw0200#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siiw0200Carga;
|FIN;

|PROCESO GrabaDatos;
     |CIERRA #siiw0200;

     nReg = nReg + 1;

     |DDEFECTO #siiw0201;
     |BUCLE siiw0200Carga;
     |GRABA 020#siiw0201.n;
     |LIBERA #siiw0201;

     |DELINDEX #siiw0200;
     |PULSATECLA;
|FPRC;

|PROCESO Grabaw0200;
     |SI nCmp > nTCampo;
         |ACABA;
     |FINSI;

     #siiw0200#0 = nCmp;
     #siiw0200#1 = aVar;
     |GRABA 020#siiw0200.n;
     |LIBERA #siiw0200;
|FPRC;

|PROCESO SacaDatos;
     aLong  = aLee % 0;
     nLong  = aLong;
     aC10   = &10;
     aC13   = &13;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos   = (nCarac * 100) + 1;
           aCarac = aLee % nPos;

           |SI aCarac = aC13;
               aCarac = ";";

               nCmp   = nCmp + 1;
               |HAZ Grabaw0200;

               aVar   = "";
               aCarac = "";

               nCmp = nTCampo;
           |FINSI;

           |SI aCarac = ";";
               nCmp   = nCmp + 1;
               |HAZ Grabaw0200;

               aVar   = "";
               aCarac = "";
           |FINSI;

           |SI aCarac = aC10;
               aCarac = "";
           |FINSI;

           |SI nCmp = nTCampo;  |Y nCmp ! 0;
               |HAZ GrabaDatos;

               |ABRE #siiw0200;

               nCmp = 0;
           |FINSI;

           aVar = aVar + aCarac;
      |SIGUE;
|FPRC;

|PROCESO LeeFichero;
     nOk = 0;

     aFicTmp = "siiw0200" + Usuario;  |NOME_DAT #siiw0200#aFicTmp#;
     |ABRE #siiw0200;  |CIERRA #siiw0200;  |DELINDEX #siiw0200;

     aFicTmp = "siiw0201" + Usuario;  |NOME_DAT #siiw0201#aFicTmp#;
     |ABRE #siiw0201;  |CIERRA #siiw0201;  |DELINDEX #siiw0201;

     |ABRE #siiw0200;
     |ABRE #siiw0201;

     nCmp  = 0;
     nReg  = 0;

     |XABRE "B", aAbre, nHandle;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandle, 255, aLee;
          |SI FSalida [ 0;  |SAL;  |FINSI;

          |HAZ SacaDatos;
     |SIGUE;
     |XCIERRA nHandle;

     |LEE 000#siiw0200.p;
     |SI FSalida = 0;
         nCmp   = nCmp + 1;
         |HAZ Grabaw0200;
         |HAZ GrabaDatos;
     |FINSI;
     |CIERRA #siiw0200;

     |LEE 000#siiw0201.p;
     |SI FSalida = 0;
         nOk = 1;
     |FINSI;
     |CIERRA #siiw0201;
|FPRC;

|PROCESO PonDsselect;
     aVer1   = "";
     aVer2   = "";
     aConte  = aBaseSII + "plugins/dsselect.exe";
     |ESPECIFICA "MD5", aConte;
     aVer1 = FSalida;

     aConte  = aPathLocal + "dsselect.exe";
     |ESPECIFICA "REMOTOMD5", aConte;
     aVer2 = FSalida;

     |SI aVer1 ! aVer2;
         aOri = aBaseSII + "plugins/dsselect.exe";
         aDes = aPathLocal + "dsselect.exe";

         |SI aIP = "";
             |COPIA_FICHERO aOri, aDes;
         |SINO;
             |ENVIA_FICHERO aOri, aDes;
         |FINSI;

         aAlfa = aPathLocal + "dsselect.exe";
         |XABRE "EC", aAlfa, 0;
         |SI FSalida < 0;
             |MENAV "0000No encuentro el explorador de ficheros, por favor consulte con su administrador informatico.";
             |ACABA;
         |FINSI;
     |FINSI;

     nOk = 1;
|FPRC;

|PROCESO Dsofficetxt;
     aVer1   = "";
     aVer2   = "";
     aConte  = aBaseSII + "plugins/dsofficetxt.exe";
     |ESPECIFICA "MD5", aConte;
     aVer1 = FSalida;

     aConte  = aPathLocal + "dsofficetxt.exe";
     |ESPECIFICA "REMOTOMD5", aConte;
     aVer2 = FSalida;

     |SI aVer1 ! aVer2;
         aOri = aBaseSII + "plugins/dsofficetxt.exe";
         aDes = aPathLocal + "dsofficetxt.exe";

         |SI aIP = "";
             |COPIA_FICHERO aOri, aDes;
         |SINO;
             |ENVIA_FICHERO aOri, aDes;
         |FINSI;

         aAlfa = aPathLocal + "dsofficetxt.exe";
         |XABRE "EC", aAlfa, 0;
         |SI FSalida < 0;
             |MENAV "0000No encuentro el conversor a CSV, por favor consulte con su administrador informatico.";
             |ACABA;
         |FINSI;
     |FINSI;

     nOk = 1;
|FPRC;

|PROCESO Conversion;
     aAlfa = aPathLocal + "*.csv";
     |R_PDIR aAlfa;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |RFBORRA aAlfa;

          |R_SDIR aAlfa;
     |SIGUE;

     aExt = (aFic % -103) < "";
     |SI aExt = "csv";
         aOri    = aFicBrowse;
         aDes    = aPathLocal + "ficcsv.csv";
         aParam2 = aDes;
         |RCOPIA_FICHERO aOri, aDes;

         nOk = 1;
         |ACABA;
     |FINSI;

     nOk = 0;
     |HAZ Dsofficetxt;
     |SI nOk = 0;  |ACABA;  |FINSI;

     aParam2 = aPathLocal + "ficcsv.txt";  |RFBORRA aParam2;

     aProg   = aPathLocal + "dsofficetxt.exe";
     aParam1 = aFicBrowse;
     aParam2 = aPathLocal + "ficcsv.csv";
     aParam3 = "";

     aAbre = aPathLocal + "ejecuta.bat";
     |XABRE "WC", aAbre, nHandle;

     aAlfa  =  aProg + " " + &34 + aParam1 + &34 + " " + &34 + aParam2 + &34;
     |XGRABA nHandle, aAlfa;
     |XCIERRA nHandle;

     |RSYSTEM aAbre;

     nOk    = 1;
     nVeces = 0;
     |PARA;  |SI;  |HACIENDO;
          |XABRE "EC", aParam2, 0;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          nVeces = nVeces + 1;
          |SLEEP 1;

          |SI nVeces > 15;
              |MENAV "0000No se ha podido convertir a CSV el fichero seleccionado.";
              nOk = 0;
              |SAL;
          |FINSI;
     |SIGUE;

     |RFBORRA aAbre;
|FPRC;

|PROCESO RecogeCSV;
     |MENAV "0000A continuaci¢n busque y seleccione el fichero a importar";

     nOk = 0;
     |HAZ PonDsselect;
     |SI nOk = 0;  |ACABA;  |FINSI;

     aProg = aPathLocal + "dsselect.exe " + aPathLocal + "dsselect.ini";

     aAlfa = aPathLocal + "dsselect.txt";  |RFBORRA aAlfa;
     aAlfa = aPathLocal + "dsselect.ini";  |RFBORRA aAlfa;

     aAbre = aPathLocal + "dsselect.ini";
     |XABRE "CW", aAbre, nHandle;
     |SI FSalida ] 0;
          aLinea = &34 + aPathLocal + &34 + " " + &34 + aPathLocal + "dsselect.txt" + &34;
          |XGRABA nHandle, aLinea;
     |FINSI;
     |XCIERRA nHandle;

     |RSYSTEM aProg;
     |PULSATECLA;

     aRuta = "";
     aAbre = aPathLocal + "dsselect.txt";
     |XABRE "CU", aAbre, nHandle;
     |SI FSalida ] 0;
         |XLEE nHandle, 250, aRuta;
     |FINSI;
     |XCIERRA nHandle;

     aAlfa = aPathLocal + "dsselect.txt";
     |RFBORRA aAlfa;

     |PULSATECLA;

     |QBF aRuta;
     |SI aRuta = "";
         nOk = 0;
         |ACABA;
     |FINSI;

     aAlfa      = aRuta;
     aFicBrowse = "";
     aFic       = "";
     aLong      = aAlfa % 0;
     nLong      = aLong;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos       = (nCarac * 100) + 1;
           aCaracter  = aAlfa % nPos;
           aFicBrowse = aFicBrowse + aCaracter;
           aFic       = aFic + aCaracter;

           |SI aCaracter = "/";  |O aCaracter = "\";
               aFic = "";
           |FINSI;
     |SIGUE;

     nOk = 0;
     |HAZ Conversion;
     |SI nOk = 0;  |ACABA;  |FINSI;

     aOri  = aParam2;
     aDes  = aPathTmp + "ficcsv.csv";
     |SI aIP = "";
         |COPIA_FICHERO aOri, aDes;
     |SINO;
         |RECIBE_FICHERO aOri, aDes;
     |FINSI;
|FPRC;

|| Chequeo --------------------------------------------------------------

|PROCESO siim0003Cheq;
     |SI #siim0003#103 = "C";  |O #siim0003#103 = "A";
      |O #siim0003#111 = "S";
         nOk   = 0;

         |ACABA;
     |FINSI;

     nOk = 1;
|FPRC;

|DEFBUCLE siim0003Cheq;
     #siim0003#2;
     21;
     #siim0001#0, #siiw0201#5,          0,      0, #siiw0201#6;
     #siim0001#0, #siiw0201#5, 9999999999, 999999, #siiw0201#6;
     ;
     NULL, siim0003Cheq;
|FIN;

|PROCESO GrabaW204;
     #siiw0204#0 = #siiw0201#0;
     #siiw0204#1 = aError1 + aError2;

     |GRABA 020#siiw0204.n;
     |LIBERA #siiw0204;
|FPRC;

|PROCESO GrabaW206;
     #siiw0206#0 = nEmpCon;
     #siiw0206#1 = #siiw0201#201;
     #siiw0206#2 = #siiw0201#202;
     #siiw0206#3 = #siiw0201#203;
     #siiw0206#4 = #siiw0201#204;
     #siiw0206#5 = aError2;

     |GRABA 020#siiw0206.n;
     |LIBERA #siiw0206;
|FPRC;

|PROCESO GrabaInci;
     |SI aModoImp = "CONTAGEN";  |O aModoImp = "AGICONT";
         |HAZ GrabaW206;
     |SINO;
         |HAZ GrabaW204;
     |FINSI;
|FPRC;

|PROCESO CheqDesglose;
     aAlfa = #siiw0201#9 % 101;

                                                  nOk = 1;
     |SI #siiw0201#8  = "01";   |Y aAlfa ! "N";   nOk = 0;  |FINSI;
     |SI #siiw0201#8  = "07";   |Y aAlfa ! "N";   nOk = 0;  |FINSI;
     |SI #siiw0201#13 = "F2";                     nOk = 0;  |FINSI;
     |SI #siiw0201#13 = "F4";                     nOk = 0;  |FINSI;
     |SI #siiw0201#13 = "R5";                     nOk = 0;  |FINSI;

     |SI nOk = 0;
         |SI #siiw0201#nCmp1# = " ";
             nOk = 1;
         |FINSI;
     |SINO;
                                      nOk = 0;
         |SI #siiw0201#nCmp1# = "P";  nOk = 1;  |FINSI;
         |SI #siiw0201#nCmp1# = "E";  nOk = 1;  |FINSI;
     |FINSI;

     |SI nOk = 0;
         |SI nBas = 1;
             aError1 = "Columna R - ";
             aError2 = "Contenido incorrecto en tipo desglose 1";
         |FINSI;

         |SI nBas = 2;
             aError1 = "Columna Y - ";
             aError2 = "Contenido incorrecto en tipo desglose 2";
         |FINSI;

         |SI nBas = 3;
             aError1 = "Columna AF - ";
             aError2 = "Contenido incorrecto en tipo desglose 3";
         |FINSI;

         |SI nBas = 4;
             aError1 = "Columna AM - ";
             aError2 = "Contenido incorrecto en tipo desglose 4";
         |FINSI;

         |SI nBas = 5;
             aError1 = "Columna AT - ";
             aError2 = "Contenido incorrecto en tipo desglose 5";
         |FINSI;

         |SI nBas = 6;
             aError1 = "Columna BA - ";
             aError2 = "Contenido incorrecto en tipo desglose 6";
         |FINSI;

         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     nContaBE  = 0;
     nContaPE  = 0;
     nContaEE  = 0;

     nContaBS1 = 0;
     nContaBS2 = 0;
     nContaBS3 = 0;
     nContaPS1 = 0;
     nContaPS2 = 0;
     nContaPS3 = 0;
     nContaES1 = 0;
     nContaES2 = 0;
     nContaES3 = 0;

     nContaBN1 = 0;
     nContaBN2 = 0;
     nContaPN1 = 0;
     nContaPN2 = 0;
     nContaEN1 = 0;
     nContaEN2 = 0;

     |PARA nCmp3 = 19;  |SI nCmp3 [ 54;  |HACIENDO nCmp3 = nCmp3 + 7;
           nCmp4 = nCmp3 - 1;

           |SI #siiw0201#nCmp4# = " ";
               aAlfa1 = #siiw0201#nCmp3# % 101;
               |SI aAlfa1 = "E";
                   nContaBE = nContaBE + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "S1";
                   nContaBS1 = nContaBS1 + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "S2";
                   nContaBS2 = nContaBS2 + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "S3";
                   nContaBS3 = nContaBS3 + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "N1";
                   nContaBN1 = nContaBN1 + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "N2";
                   nContaBN2 = nContaBN2 + 1;
               |FINSI;
           |FINSI;

           |SI #siiw0201#nCmp4# = "P";
               aAlfa1 = #siiw0201#nCmp3# % 101;
               |SI aAlfa1 = "E";
                   nContaPE = nContaPE + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "S1";
                   nContaPS1 = nContaPS1 + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "S2";
                   nContaPS2 = nContaPS2 + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "S3";
                   nContaPS3 = nContaPS3 + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "N1";
                   nContaPN1 = nContaPN1 + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "N2";
                   nContaPN2 = nContaPN2 + 1;
               |FINSI;
           |FINSI;

           |SI #siiw0201#nCmp4# = "E";
               aAlfa1 = #siiw0201#nCmp3# % 101;
               |SI aAlfa1 = "E";
                   nContaEE = nContaEE + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "S1";
                   nContaES1 = nContaES1 + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "S2";
                   nContaES2 = nContaES2 + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "S3";
                   nContaES3 = nContaES3 + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "N1";
                   nContaEN1 = nContaEN1 + 1;
               |FINSI;

               |SI #siiw0201#nCmp3# = "N2";
                   nContaEN2 = nContaEN2 + 1;
               |FINSI;
           |FINSI;
     |SIGUE;

     nOk = 1;
     |SI nContaPE > 1;  nOk = 0;  |FINSI;
     |SI nContaEE > 1;  nOk = 0;  |FINSI;

     nConta = 0;
     |SI nContaBS1 ! 0;  nConta = nConta + 1;  |FINSI;
     |SI nContaBS2 ! 0;  nConta = nConta + 1;  |FINSI;
     |SI nContaBS3 ! 0;  nConta = nConta + 1;  |FINSI;

     |SI nConta > 1;  nOk = 0;   |FINSI;

     nConta = 0;
     |SI nContaPS1 ! 0;  nConta = nConta + 1;  |FINSI;
     |SI nContaPS2 ! 0;  nConta = nConta + 1;  |FINSI;
     |SI nContaPS3 ! 0;  nConta = nConta + 1;  |FINSI;

     |SI nConta > 1;  nOk = 0;   |FINSI;

     nConta = 0;
     |SI nContaES1 ! 0;  nConta = nConta + 1;  |FINSI;
     |SI nContaES2 ! 0;  nConta = nConta + 1;  |FINSI;
     |SI nContaES3 ! 0;  nConta = nConta + 1;  |FINSI;

     |SI nConta > 1;  nOk = 0;   |FINSI;

     |SI nContaBN1 > 1;  nOk = 0;   |FINSI;
     |SI nContaBN2 > 1;  nOk = 0;   |FINSI;

     |SI nContaPN1 > 1;  nOk = 0;   |FINSI;
     |SI nContaPN2 > 1;  nOk = 0;   |FINSI;

     |SI nContaEN1 > 1;  nOk = 0;   |FINSI;
     |SI nContaEN2 > 1;  nOk = 0;   |FINSI;

     |SI nOk = 0;
         aError2 = "Combinaci¢n Tipos de desglose no v lido.";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

                                   nOk = 0;
     |SI #siiw0201#nCmp2# = "E1";  nOk = 1;  |FINSI;
     |SI #siiw0201#nCmp2# = "E2";  nOk = 1;  |FINSI;
     |SI #siiw0201#nCmp2# = "E3";  nOk = 1;  |FINSI;
     |SI #siiw0201#nCmp2# = "E4";  nOk = 1;  |FINSI;
     |SI #siiw0201#nCmp2# = "E5";  nOk = 1;  |FINSI;
     |SI #siiw0201#nCmp2# = "E6";  nOk = 1;  |FINSI;
     |SI #siiw0201#nCmp2# = "S1";  nOk = 2;  |FINSI;
     |SI #siiw0201#nCmp2# = "S2";  nOk = 2;  |FINSI;
     |SI #siiw0201#nCmp2# = "S3";  nOk = 2;  |FINSI;
     |SI #siiw0201#nCmp2# = "N1";  nOk = 1;  |FINSI;
     |SI #siiw0201#nCmp2# = "N2";  nOk = 1;  |FINSI;

     |SI nOk = 0;
         aError1 = "";
         aError2 = "Valor tipo de desglose no v lidos.";
         |HAZ GrabaInci;
     |FINSI;
|FPRC;

|PROCESO siiw0201Cheq;
     nEmpCon = #siiw0201#200;
     nEmpSii = #siiw0201#200;
     |SI enOTP = 1;
         |SELECT #4#siim0101;
         #siim0101#5 = #siiw0201#200;
         |LEE 000#siim0101.=;
         |SI FSalida = 0;
             nEmpCon = #siim0101#1;
         |FINSI;
     |FINSI;

     nTReg = nTReg + 1;

     nPer  = #siiw0201#3;
     nDPer = #siiw0201#3;
     nHPer = #siiw0201#3;
     aTPer = "M";

     |SI #siiw0201#3 = "1T";  nDPer = 01;  nHPer = 03;  nPer = 1;  aTPer = "T";  |FINSI;
     |SI #siiw0201#3 = "2T";  nDPer = 04;  nHPer = 06;  nPer = 2;  aTPer = "T";  |FINSI;
     |SI #siiw0201#3 = "3T";  nDPer = 07;  nHPer = 09;  nPer = 3;  aTPer = "T";  |FINSI;
     |SI #siiw0201#3 = "4T";  nDPer = 10;  nHPer = 12;  nPer = 4;  aTPer = "T";  |FINSI;

     aAlfa = #siiw0201#8;  |QBF aAlfa;
     #siiw0201#8 = ("00" + aAlfa) % -102;

     aAlfa = #siiw0201#11;  |QBF aAlfa;
     |SI aAlfa = "";
         #siiw0201#11 = "ES";
     |FINSI;

     |SI aAlfa = "ESP";
         #siiw0201#11 = "ES";
     |FINSI;

     aAlfa = #siiw0201#14;  |QBF aAlfa;
     #siiw0201#14 = ("00" + aAlfa) % -102;

     aAlfa = #siiw0201#15;  |QBF aAlfa;
     #siiw0201#15 = ("00" + aAlfa) % -102;
     |SI #siiw0201#15 = "00";  #siiw0201#15 = "";  |FINSI;

     aAlfa = #siiw0201#16;  |QBF aAlfa;
     #siiw0201#16 = ("00" + aAlfa) % -102;
     |SI #siiw0201#16 = "00";  #siiw0201#16 = "";  |FINSI;

     |SI #siiw0201#99  = " ";  #siiw0201#99  = "N";  |FINSI;
     |SI #siiw0201#100 = " ";  #siiw0201#100 = "N";  |FINSI;
     |SI #siiw0201#101 = " ";  #siiw0201#101 = "N";  |FINSI;
     |SI #siiw0201#122 = " ";  #siiw0201#122 = "N";  |FINSI;
     |SI #siiw0201#123 = " ";  #siiw0201#123 = "N";  |FINSI;
     |SI #siiw0201#127 = " ";  #siiw0201#127 = "N";  |FINSI;

     |SI #siiw0201#7   < "01.01.2000";  #siiw0201#7   = "01.01.0000";  |FINSI;
     |SI #siiw0201#103 < "01.01.2000";  #siiw0201#103 = "01.01.0000";  |FINSI;
     |SI #siiw0201#105 < "01.01.2000";  #siiw0201#105 = "01.01.0000";  |FINSI;
     |SI #siiw0201#107 < "01.01.2000";  #siiw0201#107 = "01.01.0000";  |FINSI;
     |SI #siiw0201#109 < "01.01.2000";  #siiw0201#109 = "01.01.0000";  |FINSI;
     |SI #siiw0201#111 < "01.01.2000";  #siiw0201#111 = "01.01.0000";  |FINSI;
     |SI #siiw0201#113 < "01.01.2000";  #siiw0201#113 = "01.01.0000";  |FINSI;
     |SI #siiw0201#115 < "01.01.2000";  #siiw0201#115 = "01.01.0000";  |FINSI;
     |SI #siiw0201#117 < "01.01.2000";  #siiw0201#117 = "01.01.0000";  |FINSI;
     |SI #siiw0201#119 < "01.01.2000";  #siiw0201#119 = "01.01.0000";  |FINSI;
     |SI #siiw0201#121 < "01.01.2000";  #siiw0201#121 = "01.01.0000";  |FINSI;

     |SI #siiw0201#22 = 0;  #siiw0201#21 = 0;  |FINSI;
     |SI #siiw0201#24 = 0;  #siiw0201#23 = 0;  |FINSI;
     |SI #siiw0201#29 = 0;  #siiw0201#28 = 0;  |FINSI;
     |SI #siiw0201#31 = 0;  #siiw0201#30 = 0;  |FINSI;
     |SI #siiw0201#36 = 0;  #siiw0201#35 = 0;  |FINSI;
     |SI #siiw0201#38 = 0;  #siiw0201#37 = 0;  |FINSI;
     |SI #siiw0201#43 = 0;  #siiw0201#42 = 0;  |FINSI;
     |SI #siiw0201#45 = 0;  #siiw0201#44 = 0;  |FINSI;
     |SI #siiw0201#50 = 0;  #siiw0201#49 = 0;  |FINSI;
     |SI #siiw0201#52 = 0;  #siiw0201#51 = 0;  |FINSI;
     |SI #siiw0201#57 = 0;  #siiw0201#56 = 0;  |FINSI;
     |SI #siiw0201#59 = 0;  #siiw0201#58 = 0;  |FINSI;

     |GRABA 020#siiw0201.a;
     |LIBERA #siiw0201;

     #siim0003#28 = #siiw0201#20 + #siiw0201#22 + #siiw0201#24;
     #siim0003#34 = #siiw0201#27 + #siiw0201#29 + #siiw0201#31;
     #siim0003#40 = #siiw0201#34 + #siiw0201#36 + #siiw0201#38;
     #siim0003#46 = #siiw0201#41 + #siiw0201#43 + #siiw0201#45;
     #siim0003#52 = #siiw0201#48 + #siiw0201#50 + #siiw0201#52;
     #siim0003#58 = #siiw0201#55 + #siiw0201#57 + #siiw0201#59;

     #siim0003#59 = #siim0003#28 + #siim0003#34 + #siim0003#40;
     #siim0003#59 = #siim0003#59 + #siim0003#46 + #siim0003#52;
     #siim0003#59 = #siim0003#59 + #siim0003#58;

     |SI #siim0003#59 = 0;
         aError1 = "";
         aError2 = "Factura a cero. No se pasa el registro";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI aCif ! #siiw0201#1;
         aIdent = "";
         aFecEx = "";
     |FINSI;

     |SI aIdent = #siiw0201#5;  |Y aFecEx = #siiw0201#6;
         aError1 = "Columna E - ";
         aError2 = "Identificaci¢n de factura duplicada en una misma empresa";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     aCif   = #siiw0201#1;
     aIdent = #siiw0201#5;
     aFecEx = #siiw0201#6;

     |SI nEmpSii ! 0;
         |SELECT #1#siim0001;
         #siim0001#0 = nEmpSii;
     |FINSI;

     |SI nEmpSii = 0;
         |SELECT #2#siim0001;
         #siim0001#2 = #siiw0201#1;
     |FINSI;

     |LEE 000#siim0001.=;
     |SI FSalida ! 0;
         aError1 = "Columna A - ";
         aError2 = "Contenido incorrecto en el CIF emisor";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     nOk = 0;
     |BUCLE siim0003Cheq;
     |SI nOk = 1;
         aError1 = "";
         aError2 = "El registro ya est  dado de alta y pendiente de env¡o en la base de datos";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI #siiw0201#2 [ 2016;
         aError1 = "Columna B - ";
         aError2 = "Contenido incorrecto en ejercicio";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     nOk = 1;
     |SI aTPer = "M";
         |SI nPer < 1;  |O nPer > 12;
             nOk = 0;
         |FINSI;
     |SINO;
         |SI nPer < 1;  |O nPer > 4;
             nOk = 0;
         |FINSI;
     |FINSI;

     |SI nOk = 0;
         aError1 = "Columna C - ";
         aError2 = "Contenido incorrecto en periodo";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI #siiw0201#4 ! "E";
         aError1 = "Columna D - ";
         aError2 = "Contenido incorrecto en tipo, deben ser E";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     aAlfa = #siiw0201#5;  |QBF aAlfa;
     |SI aAlfa = "";
         aError1 = "Columna E - ";
         aError2 = "Contenido incorrecto en n£mero de factura";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI #siiw0201#6 < "01.01.2000";
         aError1 = "Columna F - ";
         aError2 = "Contenido incorrecto en fecha de expedici¢n";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     nOk   = 0;
     |SI #siiw0201#8 = "01";  nOk = 1;  |FINSI;
     |SI #siiw0201#8 = "02";  nOk = 1;  |FINSI;
     |SI #siiw0201#8 = "03";  nOk = 1;  |FINSI;
     |SI #siiw0201#8 = "04";  nOk = 1;  |FINSI;
     |SI #siiw0201#8 = "05";  nOk = 1;  |FINSI;
     |SI #siiw0201#8 = "06";  nOk = 1;  |FINSI;
     |SI #siiw0201#8 = "07";  nOk = 1;  |FINSI;

     |SI nOk = 0;
         aError1 = "Columna H - ";
         aError2 = "Contenido incorrecto en identificacion fiscal";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI #siiw0201#8 = "01";  |O #siiw0201#8 = "07";
         |SI #siiw0201#13 ! "F2";  |Y #siiw0201#13 ! "F4";
          |Y #siiw0201#13 ! "R5";
             aAlfa = #siiw0201#9;  |QBF aAlfa;
             |SI aAlfa = "";
                 aError1 = "Columna I - ";
                 aError2 = "Contenido incorrecto NIF, debe tener contenido";
                 |HAZ GrabaInci;

                 |ACABA;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI #siiw0201#8 = "02";  |O #siiw0201#8 = "03"; |O #siiw0201#8 = "04";
      |O #siiw0201#8 = "05";  |O #siiw0201#8 = "06";
         aAlfa = #siiw0201#12;  |QBF aAlfa;
         |SI aAlfa = "";
             aError1 = "Columna L - ";
             aError2 = "Contenido incorrecto NIF pais residencia, debe tener contenido";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;
     |FINSI;

     nOk   = 0;
     |SI #siiw0201#13 = "F1";  nOk = 1;  |FINSI;
     |SI #siiw0201#13 = "F2";  nOk = 1;  |FINSI;
     |SI #siiw0201#13 = "F3";  nOk = 1;  |FINSI;
     |SI #siiw0201#13 = "F4";  nOk = 1;  |FINSI;
     |SI #siiw0201#13 = "R1";  nOk = 1;  |FINSI;
     |SI #siiw0201#13 = "R2";  nOk = 1;  |FINSI;
     |SI #siiw0201#13 = "R3";  nOk = 1;  |FINSI;
     |SI #siiw0201#13 = "R4";  nOk = 1;  |FINSI;
     |SI #siiw0201#13 = "R5";  nOk = 1;  |FINSI;

     |SI nOk = 0;
         aError1 = "Columna M - ";
         aError2 = "Contenido incorrecto en tipo de factura";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     nOk   = 0;
     |SI #siiw0201#14 = "01";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "02";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "03";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "04";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "05";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "06";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "07";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "08";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "09";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "10";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "11";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "12";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "13";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "14";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "15";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "16";  nOk = 1;  |FINSI;

     |SI nOk = 0;
         aError1 = "Columna N - ";
         aError2 = "Contenido incorrecto en Clave ident.oper.trans.tributaria 1";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     |SI #siiw0201#15 ! "  ";
         nOk   = 0;
         |SI #siiw0201#14 = "05";  nOk = 1;  |FINSI;
         |SI #siiw0201#14 = "06";  nOk = 1;  |FINSI;
         |SI #siiw0201#14 = "07";  nOk = 1;  |FINSI;
         |SI #siiw0201#14 = "11";  nOk = 1;  |FINSI;
         |SI #siiw0201#14 = "12";  nOk = 1;  |FINSI;
         |SI #siiw0201#14 = "13";  nOk = 1;  |FINSI;

         |SI nOk = 0;
             aError1 = "Columna O  - ";
             aError2 = "Contenido incorrecto en Clave ident.oper.trans.tributaria 2";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;

         nOk = 0;
         |SI #siiw0201#14 = "05";
             |SI #siiw0201#15 = "01";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "07";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "11";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "12";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "13";  nOk = 1;  |FINSI;
         |FINSI;

         |SI #siiw0201#14 = "06";
             |SI #siiw0201#15 = "11";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "12";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "13";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "14";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "15";  nOk = 1;  |FINSI;
         |FINSI;

         |SI #siiw0201#14 = "07";
             |SI #siiw0201#15 = "01";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "03";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "05";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "09";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "11";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "12";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "13";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "14";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "15";  nOk = 1;  |FINSI;
         |FINSI;

         |SI #siiw0201#14 = "11";  |O #siiw0201#14 = "12";  |O #siiw0201#14 = "13";
             |SI #siiw0201#15 = "06";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "07";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "08";  nOk = 1;  |FINSI;
             |SI #siiw0201#15 = "15";  nOk = 1;  |FINSI;
         |FINSI;

         |SI nOk = 0;
             aError1 = "Columna O  - ";
             aError2 = "Contenido incorrecto en Clave ident.oper.trans.tributaria 2";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;
     |FINSI;

     |SI #siiw0201#16 ! "  ";
         nOk   = 0;
         |SI #siiw0201#14 = "05";  nOk = 1;  |FINSI;
         |SI #siiw0201#14 = "06";  nOk = 1;  |FINSI;
         |SI #siiw0201#14 = "07";  nOk = 1;  |FINSI;
         |SI #siiw0201#14 = "11";  nOk = 1;  |FINSI;
         |SI #siiw0201#14 = "12";  nOk = 1;  |FINSI;
         |SI #siiw0201#14 = "13";  nOk = 1;  |FINSI;

         |SI nOk = 0;
             aError1 = "Columna P  - ";
             aError2 = "Contenido incorrecto en Clave ident.oper.trans.tributaria 3";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;

         nOk = 0;
         |SI #siiw0201#14 = "05";
             |SI #siiw0201#16 = "01";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "07";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "11";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "12";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "13";  nOk = 1;  |FINSI;
         |FINSI;

         |SI #siiw0201#14 = "06";
             |SI #siiw0201#16 = "11";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "12";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "13";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "14";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "15";  nOk = 1;  |FINSI;
         |FINSI;

         |SI #siiw0201#14 = "07";
             |SI #siiw0201#16 = "01";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "03";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "05";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "09";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "11";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "12";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "13";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "14";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "15";  nOk = 1;  |FINSI;
         |FINSI;

         |SI #siiw0201#14 = "11";  |O #siiw0201#14 = "12";  |O #siiw0201#14 = "13";
             |SI #siiw0201#16 = "06";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "07";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "08";  nOk = 1;  |FINSI;
             |SI #siiw0201#16 = "15";  nOk = 1;  |FINSI;
         |FINSI;

         |SI nOk = 0;
             aError1 = "Columna P  - ";
             aError2 = "Contenido incorrecto en Clave ident.oper.trans.tributaria 3";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;
     |FINSI;

     aAlfa = #siiw0201#17;  |QBF aAlfa;
     |SI aAlfa ! "";
         |SI #siiw0201#17 = #siiw0201#5;
             aError1 = "Columna Q - ";
             aError2 = "Contenido incorrecto en £ltimo n£mero factura, debe ser distnto a n£mero factura";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;

         |SI #siiw0201#13 ! "F4";
             aError1 = "Columna Q - ";
             aError2 = "Contenido incorrecto en £ltimo n£mero factura, tiene contenido y el tipo de factura no es F4";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;
     |FINSI;

     |SI #siiw0201#20 ! 0;
         nCmp1 = 18;  nCmp2 = 19;  nBas = 1;  |HAZ CheqDesglose;
         |SI nOk = 0;  |ACABA;  |FINSI;
     |FINSI;

     |SI #siiw0201#27 ! 0;
         nCmp1 = 25;  nCmp2 = 26;  nBas = 2;  |HAZ CheqDesglose;
         |SI nOk = 0;  |ACABA;  |FINSI;
     |FINSI;

     |SI #siiw0201#34 ! 0;
         nCmp1 = 32;  nCmp2 = 33;  nBas = 3;  |HAZ CheqDesglose;
         |SI nOk = 0;  |ACABA;  |FINSI;
     |FINSI;

     |SI #siiw0201#41 ! 0;
         nCmp1 = 39;  nCmp2 = 38;  nBas = 4;  |HAZ CheqDesglose;
         |SI nOk = 0;  |ACABA;  |FINSI;
     |FINSI;

     |SI #siiw0201#48 ! 0;
         nCmp1 = 39;  nCmp2 = 38;  nBas = 5;  |HAZ CheqDesglose;
         |SI nOk = 0;  |ACABA;  |FINSI;
     |FINSI;

     |SI #siiw0201#55 ! 0;
         nCmp1 = 53;  nCmp2 = 54;  nBas = 6;  |HAZ CheqDesglose;
         |SI nOk = 0;  |ACABA;  |FINSI;
     |FINSI;

     |SI #siiw0201#20 = 0;  |Y  #siiw0201#27 = 0;
      |Y #siiw0201#34 = 0;  |Y  #siiw0201#41 = 0;
      |Y #siiw0201#48 = 0;  |Y  #siiw0201#55 = 0;
         nCmp1 = 18;  nCmp2 = 19;  nBas = 1;  |HAZ CheqDesglose;
         |SI nOk = 0;  |ACABA;  |FINSI;
     |FINSI;

     aAlfa = #siiw0201#61;  |QBF aAlfa;
     |SI aAlfa = "";
         aError1 = "Columna BI - ";
         aError2 = "Sin contenido en descripci¢n de la operaci¢n";
         |HAZ GrabaInci;

         |ACABA;
     |FINSI;

     nOk = 0;
     |SI #siiw0201#13 = "R1";  nOk = 1;  |FINSI;
     |SI #siiw0201#13 = "R2";  nOk = 1;  |FINSI;
     |SI #siiw0201#13 = "R3";  nOk = 1;  |FINSI;
     |SI #siiw0201#13 = "R4";  nOk = 1;  |FINSI;
     |SI #siiw0201#13 = "R5";  nOk = 1;  |FINSI;

     |SI nOk = 1;
         |SI #siiw0201#62 = " ";
             aError1 = "Columna BJ - ";
             aError2 = "Sin contenido en tipo rectificativa";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;
     |SINO;
         |SI #siiw0201#62 ! " ";
             aError1 = "Columna BJ - ";
             aError2 = "No procede contenido en tipo rectificativa";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;
     |FINSI;

     nOk = 0;
     |SI #siiw0201#14 = "12";  nOk = 1;  |FINSI;
     |SI #siiw0201#14 = "13";  nOk = 1;  |FINSI;
     |SI #siiw0201#15 = "12";  nOk = 1;  |FINSI;
     |SI #siiw0201#15 = "13";  nOk = 1;  |FINSI;
     |SI #siiw0201#16 = "12";  nOk = 1;  |FINSI;
     |SI #siiw0201#16 = "13";  nOk = 1;  |FINSI;

     |SI nOk = 1;
         nOk = 0;
         |PARA nCmp1 = 66;  |SI nCmp1 [ 94;  |HACIENDO nCmp1 = nCmp1 + 2;
               |SI #siiw0201#nCmp1# ! " ";
                   nOk = 1;  |SAL;
               |FINSI;
         |SIGUE;

         |SI nOk = 0;
             aError1 = "";
             aError2 = "Es obligatorio informar del detalle de los inmuebles";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;

         nOk = 1;
         |PARA nCmp1 = 66;  |SI nCmp1 [ 94;  |HACIENDO nCmp1 = nCmp1 + 2;
               nCmp2 = nCmp1 + 1;
               |SI #siiw0201#nCmp1# = "1";  |O #siiw0201#nCmp1# = "2";
                   aAlfa = #siiw0201#nCmp2#;  |QBF aAlfa;
                   |SI aAlfa = "";
                       nOk = 0;
                   |FINSI;
               |FINSI;
         |SIGUE;

         |SI nOk = 0;
             aError1 = "";
             aError2 = "Situaciones del inmueble 1 o 2 y no hay informadas referencias catastrales";
             |HAZ GrabaInci;

             |ACABA;
         |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE siiw0201Cheq;
     #siiw0201#2;
     ;
     INICIO;
     FINAL;
     be;
     NULL, siiw0201Cheq;
|FIN;

|PROCESO siiw0204;
     nIncor = nIncor + 1;

     |SI aModoImp = "SIIBASE";
         |ACABA;
     |FINSI;

     eaAlfa  = (("00000" + #siiw0204#0) % -105) + "    ";
     eaAlfa  = eaAlfa + #siiw0204#1;  |QBF eaAlfa;
     eaAlfa  = eaAlfa + &13 + &10;
     |HAZ QuitaRaros;

     |XGRABA nHandle, eaAlfa;
|FPRC;

|DEFBUCLE siiw0204;
     #siiw0204#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siiw0204;
|FIN;

|PROCESO siiw0206;
     nIncor = nIncor + 1;

     aAlfa = #siiw0206#5 - "Factura a cero. No se pasa el registro";
     |SI FSalida = 0;
         nFacCero = 0;
     |FINSI;
|FPRC;

|DEFBUCLE siiw0206;
     #siiw0206#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siiw0206;
|FIN;

|PROCESO ModoCSV;
     aFicTmp = "siiw0204" + Usuario;  |NOME_DAT #siiw0204#aFicTmp#;
     |ABRE #siiw0204;  |CIERRA #siiw0204;  |DELINDEX #siiw0204;
     |ABRET #siiw0204;

     nTReg  = 0;
     nIncor = 0;
     |BUCLE siiw0201Cheq;

     nOk = 1;
     |LEE 000#siiw0204.p;
     |SI FSalida = 0;
         |SI aModoImp = "SIIBOX";
             aAbre = aPathDoc + (("00000000000" + #siim0051#0) % -111) + ".err";
             |XABRE "W", aAbre, nHandle;

             eaAlfa  = "Registro Incidencia" + &13 + &10;
             |XGRABA nHandle, eaAlfa;

             |BUCLE siiw0204;

             |XCIERRA nHandle;
         |FINSI;

         |SI aModoImp = "SIIBASE";
             |BUCLE siiw0204;

             |MENAV "0000Fichero con incidencias en expedidas, a continuaci¢n informamos de los errores";
             |CONSULTA_CLAVE #1#siiw0204;

             |CONFI "0000SQuiere consultar los datos tratados";
             |SI FSalida = 0;
                 |ABRE #siiw0201;
                 |CONSULTA_CLAVE #1#siiw0201;
                 |CIERRA #siiw0201;
             |FINSI;
         |FINSI;

         nOk = 0;
     |FINSI;

     |CIERRAT #siiw0204;
|FPRC;

|PROCESO PregCont;
     nOk = 0;
     |CONFI "0000NContinuamos con la importaci¢n a pesar de las incidencias";
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     |CONFI "0000NLos registros con incidencias pasaran igualmente menos las facturas a cero, est  seguro de no revisarlos en contabilidad";
     |SI FSalida = 0;
         nOk = 1;
     |FINSI;
|FPRC;

|PROCESO ModoContabilidad;
     aFicTmp = "siiw0206" + Usuario;  |NOME_DAT #siiw0206#aFicTmp#;
     |ABRE #siiw0206;  |CIERRA #siiw0206;  |DELINDEX #siiw0206;
     |ABRET #siiw0206;

     nTReg  = 0;
     nIncor = 0;
     |BUCLE siiw0201Cheq;

     nOk = 1;
     |LEE 000#siiw0206.p;
     |SI FSalida = 0;
         nFacCero = 1;
         |BUCLE siiw0206;

         |C_V #siiw0206#4, 1, "N";
         |SI aModoImp = "AGICONT";
             |C_V #siiw0206#4, 1, "S";
         |FINSI;

         |MENAV "0000Fichero con incidencias en expedidas, a continuaci¢n informamos de los errores";
         |CONSULTA_CLAVE #1#siiw0206;

         |CONFI "0000SQuiere consultar los datos tratados";
         |SI FSalida = 0;
             |ABRE #siiw0201;
             |CONSULTA_CLAVE #1#siiw0201;
             |CIERRA #siiw0201;
         |FINSI;

         |SI nFacCero = 0;
             |HAZ PregCont;
         |FINSI;
     |FINSI;

     |CIERRAT #siiw0206;
|FPRC;

|PROCESO ChequeaFichero;
     |SI aModoImp = "CONTAGEN";  |O aModoImp = "AGICONT";
         |HAZ ModoContabilidad;
     |SINO;
         |HAZ ModoCSV;
     |FINSI;
|FPRC;


|| Grabacion --------------------------------------------------------------

|PROCESO GrabaIdenti;
     nCmp2 = nCmp1 + 1;

     #siim0007#0   = #siim0003#0;
     #siim0007#1   = #siim0003#1;
     #siim0007#2   = #siim0003#2;
     #siim0007#3   = #siiw0201#nCmp1#;
     |LEE 000#siim0007.=;
     |SI FSalida = 0;
         |ACABA;
     |FINSI;

     #siim0007#0   = #siim0003#0;
     #siim0007#1   = #siim0003#1;
     #siim0007#2   = #siim0003#2;
     #siim0007#3   = #siiw0201#nCmp1#;
     #siim0007#4   = #siiw0201#nCmp2#;

     |GRABA 020#siim0007.n;
     |LIBERA #siim0007;
|FPRC;

|PROCESO siim0003;
     #siim0002#0 = #siim0003#0;
     #siim0002#1 = #siim0003#1;
     |LEE 000#siim0002.=;
     |SI FSalida ! 0;  |DDEFECTO #siim0002;  |FINSI;

     aTipo = #siim0002#2;
     |SI aTipo = "11";
         aTipo = "12";
     |FINSI;

     |SI #siim0003#111 = "S";
         nOk   = 0;
         aTipo = "";

         |ACABA;
     |FINSI;

     nOk = 1;
|FPRC;

|DEFBUCLE siim0003;
     #siim0003#2;
     21;
     #siim0001#0, #siiw0201#5,          0,      0, #siiw0201#6;
     #siim0001#0, #siiw0201#5, 9999999999, 999999, #siiw0201#6;
     ;
     NULL, siim0003;
|FIN;

|PROCESO siim0002;
     |SI #siim0002#8 > 0;  |O #siim0002#9 > 0;
         nLot = 0;
         |ACABA;
     |FINSI;

     |SI aModoImp = "SIIBOX";
         |SI #siim0002#12 ! #siim0051#0;
             nLot = 0;
             |ACABA;
         |FINSI;
     |FINSI;

     nLot = #siim0002#1;
|FPRC;

|DEFBUCLE siim0002;
     #siim0002#3;
     2;
     #siim0001#0, #siiw0201#2, nPer, aTPer,          0, aTipo;
     #siim0001#0, #siiw0201#2, nPer, aTPer, 9999999999, aTipo;
     ;
     NULL, siim0002;
|FIN;

|PROCESO BuscaLote;
     nLot = enLotFor;
     |SI enLotFor = 0;
         |BUCLE siim0002;
     |FINSI;

     |SI nLot ! 0;
         #siim0002#0 = #siim0001#0;
         #siim0002#1 = nLot;
         |LEE 000#siim0002.=;

         |ACABA;
     |FINSI;

     |SELECT #1#siim0002;
     #siim0002#0 = #siim0001#0;
     #siim0002#1 = 9999999999;
     |LEE 000#siim0002.];
     |SI FSalida = 0;
         |LEE 000#siim0002.a;
     |SINO;
         |LEE 000#siim0002.u;
     |FINSI;

     nLot = 1;
     |SI FSalida = 0;  |Y  #siim0002#0 = #siim0001#0;
         nLot = #siim0002#1 + 1;
     |FINSI;

     |DDEFECTO #siim0002;
     #siim0002#0 = #siim0001#0;
     #siim0002#1 = nLot;
     #siim0002#2 = aTipo;

     |SI #siim0002#2 = "11"; #siim0002#3 = "Alta de facturas expedidas";                          |FINSI;
     |SI #siim0002#2 = "12"; #siim0002#3 = "Modificaci¢n de facturas expedidas";                  |FINSI;
     |SI #siim0002#2 = "14"; #siim0002#3 = "Suministro de cobros";                                |FINSI;
     |SI #siim0002#2 = "15"; #siim0002#3 = "Baja de facturas expedidas";                          |FINSI;

     |SI #siim0002#2 = "21"; #siim0002#3 = "Alta de facturas recibidas";                          |FINSI;
     |SI #siim0002#2 = "22"; #siim0002#3 = "Modificaci¢n de facturas recibidas";                  |FINSI;
     |SI #siim0002#2 = "24"; #siim0002#3 = "Suministro de pagos";                                 |FINSI;
     |SI #siim0002#2 = "25"; #siim0002#3 = "Baja de facturas recibidas";                          |FINSI;

     |SI #siim0002#2 = "31"; #siim0002#3 = "Alta de facturas de inversi¢n";                       |FINSI;
     |SI #siim0002#2 = "32"; #siim0002#3 = "Modificaci¢n de facturas de inversi¢n";               |FINSI;
     |SI #siim0002#2 = "35"; #siim0002#3 = "Baja de facturas de inversi¢n";                       |FINSI;

     #siim0002#4  = #siiw0201#2;
     #siim0002#5  = nPer;
     #siim0002#21 = aTPer;

     |SI aModoImp = "SIIBOX";
         #siim0002#12 = #siim0051#0;
     |FINSI;

     |GRABA 020#siim0002.n;
     |LIBERA #siim0002;
|FPRC;

|PROCESO casiim02;
     #siim0007#0   = #siim0003#0;
     #siim0007#1   = #siim0003#1;
     #siim0007#2   = #siim0003#2;
     #siim0007#3   = #casiim02@#3;
     |LEE 000#siim0007.=;
     |SI FSalida = 0;
         |ACABA;
     |FINSI;

     #siim0007#0   = #siim0003#0;
     #siim0007#1   = #siim0003#1;
     #siim0007#2   = #siim0003#2;
     #siim0007#3   = #casiim02@#3;
     #siim0007#4   = #casiim02@#4;

     |GRABA 020#siim0007.n;
     |LIBERA #siim0007;
|FPRC;

|DEFBUCLE casiim02;
     #casiim02@#1004;
     ;
     "camaniva", #siiw0201#202, #siiw0201#203, "";
     "camaniva", #siiw0201#202, #siiw0201#203, aH60;
     ;
     NULL, casiim02;
|FIN;

|DEFBUCLE casiim02_agicont;
     #casiim02@#1004;
     ;
     "caivarep", #siiw0201#202, aDocumento, "";
     "caivarep", #siiw0201#202, aDocumento, aH60;
     ;
     NULL, casiim02;
|FIN;


|PROCESO GrabaSii7;
     aH60 = "z" * 60;

     |SI aModoImp = "AGICONT";
         aDocumento = #siiw0201#204 + ("000000" + #siiw0201#203) % -106;
         |DBASS aPathConta;
         aPathConta = aPathConta + "agicont/";

         aMas = aPathConta + "def/casiim02.mas";
         |XABRE "E", aMas, 0;
         |SI FSalida ] 0;
             |CARGA_DEF aMas, casiim02@;

             aFicConta = aPathConta + "fich/" + (("00000" + nEmpCon) % -105) + #siiw0201#201 + "/";
             |PATH_DAT #casiim02@#aFicConta#;

             |BUCLE casiim02_agicont;

             |DESCARGA_DEF #casiim02@;
         |FINSI;

         |ACABA;
     |FINSI;

     |SI aModoImp = "CONTAGEN";
         |DBASS aPathConta;
         aPathConta = aPathConta + "contagen/";

         aMas = aPathConta + "def/casiim02.mas";
         |XABRE "E", aMas, 0;
         |SI FSalida ] 0;
             |CARGA_DEF aMas, casiim02@;

             aFicConta = aPathConta + "fich/" + (("00000" + nEmpCon) % -105) + #siiw0201#201 + "/";
             |PATH_DAT #casiim02@#aFicConta#;

             |BUCLE casiim02;

             |DESCARGA_DEF #casiim02@;
         |FINSI;

         |ACABA;
     |FINSI;

     nReg = 0;
     |SI #siim0003#6 = "R1";  |O #siim0003#6 = "R2";
      |O #siim0003#6 = "R3";  |O #siim0003#6 = "R4";
      |O #siim0003#6 = "R5";  |O #siim0003#6 = "F3";
         |PARA nCmp1 = 102;  |SI nCmp1 [ 120;  |HACIENDO nCmp1 = nCmp1 + 2;
               aAlfa = #siiw0201#nCmp1#;  |QBF aAlfa;
               |SI aAlfa ! "";
                   |HAZ GrabaIdenti;
               |FINSI;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO siiw0201Gra;
     nEmpCon = #siiw0201#200;
     nEmpSii = #siiw0201#200;
     |SI enOTP = 1;
         |SELECT #4#siim0101;
         #siim0101#5 = #siiw0201#200;
         |LEE 000#siim0101.=;
         |SI FSalida = 0;
             nEmpCon = #siim0101#1;
         |FINSI;
     |FINSI;

     #siim0003#28 = #siiw0201#20 + #siiw0201#22 + #siiw0201#24;
     #siim0003#34 = #siiw0201#27 + #siiw0201#29 + #siiw0201#31;
     #siim0003#40 = #siiw0201#34 + #siiw0201#36 + #siiw0201#38;
     #siim0003#46 = #siiw0201#41 + #siiw0201#43 + #siiw0201#45;
     #siim0003#52 = #siiw0201#48 + #siiw0201#50 + #siiw0201#52;
     #siim0003#58 = #siiw0201#55 + #siiw0201#57 + #siiw0201#59;

     #siim0003#59 = #siim0003#28 + #siim0003#34 + #siim0003#40;
     #siim0003#59 = #siim0003#59 + #siim0003#46 + #siim0003#52;
     #siim0003#59 = #siim0003#59 + #siim0003#58;

     |SI #siim0003#59 = 0;
         |ACABA;
     |FINSI;

     nPer  = #siiw0201#3;
     nDPer = #siiw0201#3;
     nHPer = #siiw0201#3;
     aTPer = "M";

     |SI #siiw0201#3 = "1T";  nDPer = 01;  nHPer = 03;  nPer = 1;  aTPer = "T";  |FINSI;
     |SI #siiw0201#3 = "2T";  nDPer = 04;  nHPer = 06;  nPer = 2;  aTPer = "T";  |FINSI;
     |SI #siiw0201#3 = "3T";  nDPer = 07;  nHPer = 09;  nPer = 3;  aTPer = "T";  |FINSI;
     |SI #siiw0201#3 = "4T";  nDPer = 10;  nHPer = 12;  nPer = 4;  aTPer = "T";  |FINSI;

     |SI nEmpSii ! 0;
         |SELECT #1#siim0001;
         #siim0001#0 = nEmpSii;
     |FINSI;

     |SI nEmpSii = 0;
         |SELECT #2#siim0001;
         #siim0001#2 = #siiw0201#1;
     |FINSI;

     |LEE 000#siim0001.=;
     |SI aModoImp = "CONTAGEN";  |O aModoImp = "AGICONT";
         nOk   = 0;
         |BUCLE siim0003Cheq;
         |SI nOk = 1;  |ACABA;  |FINSI;
     |FINSI;

     nOk   = 0;
     |BUCLE siim0003;
     |SI nOk = 0;
         aTipo = "11";
     |FINSI;

     |HAZ BuscaLote;

     #siim0003#0  = #siim0002#0;
     #siim0003#1  = #siim0002#1;
     #siim0003#2  = 999999;
     |LEE 000#siim0003.];
     |SI FSalida = 0;
         |LEE 000#siim0003.a;
     |SINO;
         |LEE 000#siim0003.u;
     |FINSI;

     nReg = 1;
     |SI FSalida = 0;  |Y #siim0003#0  = #siim0002#0;
                       |Y #siim0003#1  = #siim0002#1;
         nReg = #siim0003#2 + 1;
     |FINSI;

     |DDEFECTO #siim0003;
     #siim0003#0   = #siim0002#0;
     #siim0003#1   = #siim0002#1;
     #siim0003#2   = nReg;
     #siim0003#3   = #siiw0201#2;
     #siim0003#4   = #siim0002#5;
     #siim0003#5   = #siiw0201#8;
     #siim0003#6   = #siiw0201#13;
     #siim0003#7   = #siiw0201#14;
     #siim0003#8   = #siiw0201#15;
     #siim0003#9   = #siiw0201#16;
     #siim0003#10  = #siiw0201#99;
     #siim0003#11  = #siiw0201#100;
     #siim0003#12  = #siiw0201#101;

     aAlfa         = #siiw0201#18 + #siiw0201#25 + #siiw0201#32;
     aAlfa         = aAlfa        + #siiw0201#39 + #siiw0201#46;
     aAlfa         = aAlfa        + #siiw0201#53;
     #siim0003#13  = aAlfa;

     aAlfa         = #siiw0201#19 + #siiw0201#26 + #siiw0201#33;
     aAlfa         = aAlfa        + #siiw0201#40 + #siiw0201#47;
     aAlfa         = aAlfa        + #siiw0201#54;
     #siim0003#14  = aAlfa;

     #siim0003#15  = #siiw0201#9;
     #siim0003#16  = #siiw0201#10;
     #siim0003#17  = #siiw0201#11;
     #siim0003#18  = #siiw0201#12;
     #siim0003#19  = #siiw0201#5;
     #siim0003#20  = #siiw0201#17;
     #siim0003#21  = #siiw0201#6;
     #siim0003#22  = #siiw0201#7;
     #siim0003#23  = #siiw0201#20;
     #siim0003#24  = #siiw0201#21;
     #siim0003#25  = #siiw0201#22;
     #siim0003#26  = #siiw0201#23;
     #siim0003#27  = #siiw0201#24;
     #siim0003#29  = #siiw0201#27;
     #siim0003#30  = #siiw0201#28;
     #siim0003#31  = #siiw0201#29;
     #siim0003#32  = #siiw0201#30;
     #siim0003#33  = #siiw0201#31;
     #siim0003#35  = #siiw0201#34;
     #siim0003#36  = #siiw0201#35;
     #siim0003#37  = #siiw0201#36;
     #siim0003#38  = #siiw0201#37;
     #siim0003#39  = #siiw0201#38;
     #siim0003#41  = #siiw0201#41;
     #siim0003#42  = #siiw0201#42;
     #siim0003#43  = #siiw0201#43;
     #siim0003#44  = #siiw0201#44;
     #siim0003#45  = #siiw0201#45;
     #siim0003#47  = #siiw0201#48;
     #siim0003#48  = #siiw0201#49;
     #siim0003#49  = #siiw0201#50;
     #siim0003#50  = #siiw0201#51;
     #siim0003#51  = #siiw0201#52;
     #siim0003#53  = #siiw0201#55;
     #siim0003#54  = #siiw0201#56;
     #siim0003#55  = #siiw0201#57;
     #siim0003#56  = #siiw0201#58;
     #siim0003#57  = #siiw0201#59;
     #siim0003#60  = #siiw0201#98;
     #siim0003#61  = #siiw0201#97;
     #siim0003#62  = #siiw0201#61 % 180;
     #siim0003#63  = #siiw0201#61 % 8180;
     #siim0003#64  = #siiw0201#61 % 16180;
     #siim0003#65  = #siiw0201#62;
     #siim0003#66  = #siiw0201#63;
     #siim0003#67  = #siiw0201#64;
     #siim0003#68  = #siiw0201#65;
     #siim0003#69  = #siiw0201#66;
     #siim0003#70  = #siiw0201#67;
     #siim0003#71  = #siiw0201#68;
     #siim0003#72  = #siiw0201#69;
     #siim0003#73  = #siiw0201#70;
     #siim0003#74  = #siiw0201#71;
     #siim0003#75  = #siiw0201#72;
     #siim0003#76  = #siiw0201#73;
     #siim0003#77  = #siiw0201#74;
     #siim0003#78  = #siiw0201#75;
     #siim0003#79  = #siiw0201#76;
     #siim0003#80  = #siiw0201#77;
     #siim0003#81  = #siiw0201#78;
     #siim0003#82  = #siiw0201#79;
     #siim0003#83  = #siiw0201#80;
     #siim0003#84  = #siiw0201#81;
     #siim0003#85  = #siiw0201#82;
     #siim0003#86  = #siiw0201#83;
     #siim0003#87  = #siiw0201#84;
     #siim0003#88  = #siiw0201#85;
     #siim0003#89  = #siiw0201#86;
     #siim0003#90  = #siiw0201#87;
     #siim0003#91  = #siiw0201#88;
     #siim0003#92  = #siiw0201#89;
     #siim0003#93  = #siiw0201#90;
     #siim0003#94  = #siiw0201#91;
     #siim0003#95  = #siiw0201#92;
     #siim0003#96  = #siiw0201#93;
     #siim0003#97  = #siiw0201#94;
     #siim0003#98  = #siiw0201#95;
     #siim0003#99  = #siiw0201#96;

     #siim0003#28 = #siim0003#23 + #siim0003#25 + #siim0003#27;
     #siim0003#34 = #siim0003#29 + #siim0003#31 + #siim0003#33;
     #siim0003#40 = #siim0003#35 + #siim0003#37 + #siim0003#39;
     #siim0003#46 = #siim0003#41 + #siim0003#43 + #siim0003#45;
     #siim0003#52 = #siim0003#47 + #siim0003#49 + #siim0003#51;
     #siim0003#58 = #siim0003#53 + #siim0003#55 + #siim0003#57;

     #siim0003#59 = #siim0003#28 + #siim0003#34 + #siim0003#40;
     #siim0003#59 = #siim0003#59 + #siim0003#46 + #siim0003#52;
     #siim0003#59 = #siim0003#59 + #siim0003#58;

     |SI aModoImp = "CONTAGEN";
         #siim0003#108 = #siiw0201#202;
         #siim0003#109 = #siiw0201#203;
     |FINSI;

     |SI aModoImp = "AGICONT";
         #siim0003#108 = #siiw0201#202;
         #siim0003#109 = #siiw0201#203;
         #siim0003#110 = #siiw0201#204;
     |FINSI;

     #siim0003#112 = #siiw0201#122;
     #siim0003#113 = #siiw0201#123;
     #siim0003#115 = #siiw0201#124;
     #siim0003#116 = #siiw0201#125;
     #siim0003#117 = #siiw0201#126;
     #siim0003#114 = #siiw0201#127;

     |GRABA 020#siim0003.n;
     |LIBERA #siim0003;

     nTReg = nTReg + 1;

     |HAZ GrabaSii7;

     enEmp = #siim0002#0;
     enLot = #siim0002#1;
     |SUB_EJECUTA "siiz0002;REFRESCA";
|FPRC;

|DEFBUCLE siiw0201Gra;
     #siiw0201#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, siiw0201Gra;
|FIN;
|| ------------------------------------------------------------------------

|PROCESO AbreVtn;
     |VENTANA 0501, 0540, -1, 16, "Realizando la importaci¢n";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;
|FPRC;

|PROCESO CierraVtn;
     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;
|FPRC;

|PROCESO CONTABILIDAD;
     aFicTmp = "siiw0201" + Usuario;  |NOME_DAT #siiw0201#aFicTmp#;
     |HAZ ChequeaFichero;
     |SI nOk = 0;
         nCorre  = nTReg - nIncor;
         aAlfa   = "0000Importaci¢n facturas expedidas cancelada. Leidos " + nTReg;
         aAlfa   = aAlfa + " - Correctos " + nCorre;
         aAlfa   = aAlfa + " - Incorrectos " + nIncor;

         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     nTReg = 0;
     |BUCLE siiw0201Gra;

     aAlfa = "0000Importado " + nTReg + " registros en expedidas";
     |MENAV aAlfa;
|FPRC;

|PROCESO GrabaNoti;
     |LEE 000#siim0054.u;
     |SI FSalida ! 0;  |DDEFECTO #siim0054;  |FINSI;

     nReg = #siim0054#0 + 1;

     |DDEFECTO #siim0054;
     #siim0054#0  = nReg;
     #siim0054#1  = fFecha;
     #siim0054#2  = aHora;
     #siim0054#3  = #siim0051#5;
     #siim0054#4  = #siim0051#6;
     #siim0054#5  = "IMPORTACION";
     #siim0054#6  = #siim0051#0;

     |GRABA 020#siim0054.n;
     |LIBERA #siim0054;
|FPRC;

|PROCESO SIIBOX;
     #siim0051#0 = enID;
     |LEE 101#siim0051.=;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     fFecha = ~;
     |HORA aHora;

     aAlfa = aPathDoc + (("00000000000" + #siim0051#0) % -111) + ".err";
     |FBORRA aAlfa;

     aAbre = aPathDoc + (("00000000000" + #siim0051#0) % -111) + ".csv";
     |XABRE "E", aAbre, 0;
     |SI FSalida < 0;
         aAbre = aPathDoc + (("00000000000" + #siim0051#0) % -111) + ".err";
         |XABRE "W", aAbre, nHandle;
         eaAlfa = "No existe documento CSV" + &13 + &10;
         |XGRABA nHandle, eaAlfa;
         |XCIERRA nHandle;

         #siim0051#3 = fFecha;
         #siim0051#4 = aHora;
         #siim0051#5 = "Incorrecto";
         #siim0051#6 = "No existe documento CSV";

         |GRABA 020#siim0051.a;
         |LIBERA #siim0051;

         |HAZ GrabaNoti;

         |ACABA;
     |FINSI;

     aAbre = aPathDoc + (("00000000000" + #siim0051#0) % -111) + ".csv";
     |HAZ LeeFichero;

     |SI nOk = 0;
         aAbre = aPathDoc + (("00000000000" + #siim0051#0) % -111) + ".err";
         |XABRE "W", aAbre, nHandle;
         eaAlfa = "CSV no v lido" + &13 + &10;
         |HAZ QuitaRaros;
         |XGRABA nHandle, eaAlfa;
         |XCIERRA nHandle;

         #siim0051#3 = fFecha;
         #siim0051#4 = aHora;
         #siim0051#5 = "Incorrecto";
         #siim0051#6 = "Documento CSV no v lido";

         |GRABA 020#siim0051.a;
         |LIBERA #siim0051;

         |HAZ GrabaNoti;

         |ACABA;
     |FINSI;

     |HAZ ChequeaFichero;
     |SI nOk = 0;
         nCorre  = nTReg - nIncor;
         aAlfa   = "Importaci¢n facturas expedidas cancelada. Leidos " + nTReg;
         aAlfa   = aAlfa + " - Correctos " + nCorre;
         aAlfa   = aAlfa + " - Incorrectos " + nIncor;

         #siim0051#3 = fFecha;
         #siim0051#4 = aHora;
         #siim0051#5 = "Incorrecto";
         #siim0051#6 = aAlfa;

         |GRABA 020#siim0051.a;
         |LIBERA #siim0051;

         |HAZ GrabaNoti;

         |ACABA;
     |FINSI;

     aAlfa = "Importado " + nTReg + " registros";

     #siim0051#3 = fFecha;
     #siim0051#4 = aHora;
     #siim0051#5 = "Correcto";
     #siim0051#6 = aAlfa;

     |GRABA 020#siim0051.a;
     |LIBERA #siim0051;

     |HAZ GrabaNoti;

     nTReg = 0;
     |BUCLE siiw0201Gra;

     |CIERRA #siim0051;
|FPRC;

|PROCESO SIIBASE;
     |HAZ RecogeCSV;
     |SI nOk = 0;  |ACABA;  |FINSI;

     |HAZ AbreVtn;
     aAbre = aPathTmp + "ficcsv.csv";
     |HAZ LeeFichero;
     |SI nOk = 0;
         |MENAV "0000Excel no v lida";
         |HAZ CierraVtn;
         |ACABA;
     |FINSI;

     |HAZ ChequeaFichero;
     |SI nOk = 0;
         |HAZ CierraVtn;
         |ACABA;
     |FINSI;

     nTReg = 0;
     |BUCLE siiw0201Gra;

     |HAZ CierraVtn;
|FPRC;

|PROGRAMA;
     |SI aModoImp = "CONTAGEN";  |O aModoImp = "AGICONT";
         |HAZ AbreVtn;
         |HAZ CONTABILIDAD;
         |HAZ CierraVtn;
     |FINSI;

     |SI aModoImp = "SIIBOX";
         |HAZ SIIBOX;
     |FINSI;

     |SI aModoImp = "SIIBASE";
         |HAZ SIIBASE;
     |FINSI;
|FPRO;

|PROCESO T80;  |TIPO 80;
     aModoImp = PARAMETRO;  |QBF aModoImp;

     nTCampo  = 127;

     aIP      = "";
     |IP_REMOTO aIP;

     |DBASE aBaseSII;

     |SI aModoImp = "SIIBOX";
         aPathDoc = aBaseSII + "documentos";        |MKDIR aPathDoc;
         aPathDoc = aBaseSII + "documentos/csv";    |MKDIR aPathDoc;
         aPathDoc = aBaseSII + "documentos/csv/";
     |FINSI;

     |SI aModoImp = "SIIBASE";
         |HAZ LeeUnidadBasico;

         aPathLocal = eaUnidadBasico + "\documentos";   |RMKDIR aPathLocal;
         aPathLocal = aPathLocal + "\tmp";              |RMKDIR aPathLocal;
         aPathLocal = aPathLocal + "\";
     |FINSI;

     aPathTmp = aBaseSII + "tmp";                    |MKDIR aPathTmp;
     aPathTmp = aBaseSII + "tmp/" + Usuario;         |MKDIR aPathTmp;
     aPathTmp = aBaseSII + "tmp/" + Usuario + "/";

     |ABRET #siim0001;
     |ABRET #siim0002;
     |ABRET #siim0003;
     |ABRET #siim0007;
     |ABRET #siim0101;

     |SI aModoImp = "SIIBOX";
         |ABRET #siim0051;
         |ABRET #siim0054;
     |FINSI;
|FPRC;

|PROCESO T90;  |TIPO 90;
     aFicTmp = "siiw0200" + Usuario;  |NOME_DAT #siiw0200#aFicTmp#;
     |ABRE #siiw0200;  |CIERRA #siiw0200;  |DELINDEX #siiw0200;

     aFicTmp = "siiw0201" + Usuario;  |NOME_DAT #siiw0201#aFicTmp#;
     |ABRE #siiw0201;  |CIERRA #siiw0201;  |DELINDEX #siiw0201;

     aFicTmp = "siiw0204" + Usuario;  |NOME_DAT #siiw0204#aFicTmp#;
     |ABRE #siiw0204;  |CIERRA #siiw0204;  |DELINDEX #siiw0204;

     aFicTmp = "siiw0206" + Usuario;  |NOME_DAT #siiw0206#aFicTmp#;
     |ABRE #siiw0206;  |CIERRA #siiw0206;  |DELINDEX #siiw0206;

     aAlfa = aPathLocal + "*.csv";
     |R_PDIR aAlfa;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |RFBORRA aAlfa;

          |R_SDIR aAlfa;
     |SIGUE;

     |CIERRAT #siim0001;
     |CIERRAT #siim0002;
     |CIERRAT #siim0003;
     |CIERRAT #siim0007;
     |CIERRAT #siim0101;

     |SI aModoImp = "SIIBOX";
         |CIERRAT #siim0051;
         |CIERRAT #siim0054;
     |FINSI;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PTEC 802;  |PAUSA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;
