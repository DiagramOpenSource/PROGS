-----------------------------------------------------------------------------
CALCULO IBAN
-----------------------------------------------------------------------------

|VARIABLES;
     aCta      = "";
     aIban     = "";
     aLon      = "";
     aNuevo    = "";
     aCar      = "";
     aDC       = "";
     aAlfa     = "";
     aAlfa1    = "";
     aAlfa2    = "";
     aComodin1 = "";
     aComodin2 = "";
     aCaracter = "";

     nPos     = 0;
     i        = 0;
     nCalc    = 0;
     nNume    = 0;
     nResto   = 0;
     nDigito1 = 0;
     nDigito2 = 0;
     nCont    = 0;

     &eaCta      = "";
     &eaIBAN     =  "";
     &eaEntidad  = "";
     &eaSucursal = "";
     &eaCuenta   = "";
     &eaDC       = "";
|FIN;

|PROCESO CalculoDC;
     nDigito1  = 0;
     nDigito2  = 0;
     aComodin1 = "";
     aComodin2 = "";

     |PARA nCont = 1; |SI nCont [ 4; |HACIENDO nCont = nCont + 1;
           nCalc = 0 - ((100 * nCont) + 1);
           aCaracter = eaSucursal % nCalc;
           |SI aCaracter = ""; aCaracter = "0"; |FINSI;
           aComodin1 = aComodin1 + aCaracter;
     |SIGUE;

     |PARA nCont = 1; |SI nCont [ 4; |HACIENDO nCont = nCont + 1;
           nCalc = 0 - ((100 * nCont) + 1);
           aCaracter = eaEntidad % nCalc;
           |SI aCaracter = ""; aCaracter = "0"; |FINSI;
           aComodin1 = aComodin1 + aCaracter;
     |SIGUE;

     |PARA nCont = 1; |SI nCont [ 8; |HACIENDO nCont = nCont + 1;
           nCalc = (100 * nCont) + 1;
           aCaracter = aComodin1 % nCalc;
           nCalc     = aCaracter;

           |SI nCont = 1; nDigito1 = nDigito1 + (nCalc * 6);  |FINSI;
           |SI nCont = 2; nDigito1 = nDigito1 + (nCalc * 3);  |FINSI;
           |SI nCont = 3; nDigito1 = nDigito1 + (nCalc * 7);  |FINSI;
           |SI nCont = 4; nDigito1 = nDigito1 + (nCalc * 9);  |FINSI;
           |SI nCont = 5; nDigito1 = nDigito1 + (nCalc * 10); |FINSI;
           |SI nCont = 6; nDigito1 = nDigito1 + (nCalc * 5);  |FINSI;
           |SI nCont = 7; nDigito1 = nDigito1 + (nCalc * 8);  |FINSI;
           |SI nCont = 8; nDigito1 = nDigito1 + (nCalc * 4);  |FINSI;
     |SIGUE;

     nDigito1 = 11 - (nDigito1 $ 11);
     |SI nDigito1 = 10; nDigito1 = 1; |FINSI;
     |SI nDigito1 = 11; nDigito1 = 0; |FINSI;

     |PARA nCont = 1; |SI nCont [ 10; |HACIENDO nCont = nCont + 1;
           nCalc = 0 - ((100 * nCont) + 1);
           aCaracter = eaCuenta % nCalc;
           |SI aCaracter = ""; aCaracter = "0"; |FINSI;
           aComodin2 = aComodin2 + aCaracter;
     |SIGUE;

     |PARA nCont = 1; |SI nCont [ 10; |HACIENDO nCont = nCont + 1;
           nCalc = (100 * nCont) + 1;
           aCaracter = aComodin2 % nCalc;
           nCalc     = aCaracter;

           |SI nCont = 1;  nDigito2 = nDigito2 + (nCalc * 6);  |FINSI;
           |SI nCont = 2;  nDigito2 = nDigito2 + (nCalc * 3);  |FINSI;
           |SI nCont = 3;  nDigito2 = nDigito2 + (nCalc * 7);  |FINSI;
           |SI nCont = 4;  nDigito2 = nDigito2 + (nCalc * 9);  |FINSI;
           |SI nCont = 5;  nDigito2 = nDigito2 + (nCalc * 10); |FINSI;
           |SI nCont = 6;  nDigito2 = nDigito2 + (nCalc * 5);  |FINSI;
           |SI nCont = 7;  nDigito2 = nDigito2 + (nCalc * 8);  |FINSI;
           |SI nCont = 8;  nDigito2 = nDigito2 + (nCalc * 4);  |FINSI;
           |SI nCont = 9;  nDigito2 = nDigito2 + (nCalc * 2);  |FINSI;
           |SI nCont = 10; nDigito2 = nDigito2 + (nCalc * 1);  |FINSI;
      |SIGUE;

      nDigito2 = 11 - (nDigito2 $ 11);
      |SI nDigito2 = 10; nDigito2 = 1; |FINSI;
      |SI nDigito2 = 11; nDigito2 = 0; |FINSI;

      eaDC = nDigito1 + nDigito2;
|FPRC;

|PROCESO Mod9710;
     aAlfa  = aIban;
     aAlfa2 = aAlfa % 0101;

     |PARA; |SI aAlfa2 = "0"; |HACIENDO;
        aAlfa = aAlfa % 0299; aAlfa2 = aAlfa % 0101;
     |SIGUE;

     aAlfa1 = "";
     |PARA; |SI aAlfa ! ""; |HACIENDO;
        aAlfa2 = aAlfa % 0; nCalc = aAlfa2;

        |SI nCalc > 5;
           aAlfa2 = aAlfa % 0105; aAlfa = aAlfa % 0699;
        |SINO;
           aAlfa2 = aAlfa; aAlfa = "";
        |FINSI;

        aAlfa1 = aAlfa1 + aAlfa2;
        nCalc  = aAlfa1;
        nCalc  = nCalc / 97;
        aAlfa2 = nCalc;
        aAlfa2 = aAlfa2 - ".";
        nCalc  = 0;

       |SI FSalida ! 0;
           nCalc  = FSalida + 98;
           aAlfa2 = aAlfa2 % nCalc;
           aAlfa2 = "0." + aAlfa2; nCalc = aAlfa2;
        |SINO;
        |FINSI;
        nCalc  = (nCalc * 97) ! 0;
        aAlfa1 = nCalc;
     |SIGUE;

     nCalc  = aAlfa1;
     nCalc  = 98 - nCalc;
     aDC    = ("00" + nCalc) % -102;
|FPRC;

|PROCESO CambiaLetra;
     aNuevo = "";
     |PARA i = 1; |SI i [ 24; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aCar = aIban % nPos;
          |SI aCar ] "0"; |Y aCar [ "9";
               aNuevo = aNuevo + aCar;
          |SINO;
               nNume = &aCar; nNume = nNume - 55; aCar = nNume;
               aNuevo = aNuevo + aCar;
          |FINSI;
     |SIGUE;

     aIban = aNuevo;
|FPRC;

|PROCESO CalcuIBAN;
     eaIBAN = "";
     aCta   = eaCta; |QBF aCta;

     nNume = aCta;
     aLon  = aCta % A0;
     |SI aLon = 20; |Y nNume ! 0;
          aIban = aCta + "ES" + "00";
          |HAZ CambiaLetra;
          |HAZ Mod9710;
          eaIBAN = "ES" + aDC + aCta;
     |FINSI;
|FPRC;
