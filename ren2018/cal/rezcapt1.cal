|FICHEROS;
     rezcaptu;
     reacceso;

     :/integral/def/dsam0000;
     :/integral/def/dsam0003;

     :/contagen/def/canempre;
     :/contagen/def/cacuenta;

     :/basica/def/agicen14;
     :/basica/def/agicen30;

     :/modelos/def/dsmom001;
     :/modelos/def/dsmom042;
     :/modelos/def/dsmom043;
     :/modelos/def/dsm19001;
     :/modelos/def/dsm193ca;
     :/modelos/def/dsm193li;
     :/modelos/def/dsmom018;
     :/modelos/def/dsmom068;

     rem00022;
     rem00041;
     reauxval;
     rew00070;

     activida@;

     rem01001@;
     rem01011@;
|FIN;

|VARIABLES;
      aBase          = "";
      aPathFich      = "";
      aMas           = "";
      aFichero       = "";
      aNif           = "";
      aAlfa          = "";
      aAlfa1         = "";
      aAlfa2         = "";
      aIdentificador = "";
      aContri        = "";
      aDCuenta       = "";
      aHCuenta       = "";

      nLinea      = 0;
      nValor      = 0;
      nEmpresa43  = 0;
      nActivid43  = 0;
      nPorce      = 0;
      nComprueba  = 0;
      nComple     = 0;
      nSaldo      = 0;

     &enEmpresa   = 0;
     &enAmortiza  = 0;
     &enActividad = 0;
     &enSwPasa    = 0;
     &enTipoGanan = 0;
     &eaPrograma  = "";
     &eaPunto     = "  ";
     &eaPerceptor = "";
     &eaCaptura   = "";
     &enDComple   = 0;
     &enHComple   = 0;
     &enError     = 0;
     &enGastos    = 0;
     &eaRefCast   = "";
     &eaLorca     = "";
     &enImporteT   = 0;
     &enImporteC   = 0;
     &enImporte1   = 0;
     &enImporte2   = 0;
     &enImporte3   = 0;
     &enImporte4   = 0;
|FIN;

|PROCESO CogeAmortizacion;
     enAmortiza = (enAmortiza + #dsmom042#11) ! 2;
|FPRC;

|DEFBUCLE dsmom042;
     #dsmom042#1;
     1, 9, 6;
     #canempre#2, "        ", 00, 001, enActividad, "01.01.2018", "A";
     #canempre#2, "zzzzzzzz", 99, 999, enActividad, "31.12.2018", "A";
     ;
     NULL, CogeAmortizacion;
|FIN;

|PROCESO AmortizaAgricola;
     enAmortiza = 0;
     |BUCLE dsmom042;
|FPRC;

|PROCESO GrabaEl41;
     nLinea = 1;
     |ABRE #rem00041;
     #rem00041#0 = #reacceso#0;
     #rem00041#1 = 99;
     |LEE 040#rem00041.];
     |SI FSalida = 0;
         |LEE 040#rem00041.a;
     |SINO;
         |LEE 040#rem00041.u;
     |FINSI;
     |SI FSalida = 0;  |Y #rem00041#0 = #reacceso#0;
         nLinea = #rem00041#1 + 1;
         |SI nLinea ] 99;
             |PARA nLinea = 99; |SI nLinea ] 0; |HACIENDO nLinea = nLinea - 1;
                   #rem00041#0 = #reacceso#0;
                   #rem00041#1 = nLinea;
                   |LEE 040#rem00041.=;
                   |SI FSalida ! 0;  |SAL;  |FINSI;
             |SIGUE;
         |FINSI;
     |FINSI;

     #rem00041#0 = #reacceso#0;
     #rem00041#1 = nLinea;
     |LEE 101#rem00041.=;
     |SI FSalida ! 0;
         |DDEFECTO #rem00041;
         #rem00041#0  = #reacceso#0;
         #rem00041#1  = nLinea;
         #rem00041#3  = "X";
         |GRABA 020#rem00041.b;
     |FINSI;

     #rem00041#2  = eaPerceptor;
     #rem00041#13 = #dsmom043#4;
     #rem00041#16 = "7";
     #rem00041#14 = "O";
     #rem00041#20 = #dsmom043#7;
     #rem00041#19 = #dsmom043#6;
     #rem00041#21 = #dsmom043#9 % nPorce;
     #rem00041#27 = (#dsmom043#10 % nPorce) - (#dsmom043#12 % nPorce);

     nValor = #rem00041#21 - #rem00041#27;
     |SI nValor < 0;
         #rem00041#28 = -nValor;
         #rem00041#29 = #rem00041#22;
     |SINO;
         #rem00041#30 = nValor;
         #rem00041#35 = #rem00041#30;
         #rem00041#44 = #rem00041#30;
     |FINSI;

     #rem00041#11 = "PA";

     |GRABA 020#rem00041.a;
     |LIBERA #rem00041;

     eaPrograma   = "rem00041";
     eaPunto      = "  ";
     |HAZ ProgramaActivo;
|FPRC;

|PROCESO GrabaGananyPerd;
      |SI enTipoGanan = 1;  |Y #dsmom043#8 = 1;
          |HAZ GrabaEl41;
      |FINSI;

     |SI enTipoGanan = 2;  |Y #dsmom043#8 ! 1;
         |HAZ GrabaEl41;
     |FINSI;
|FPRC;

|DEFBUCLE dsmom043;
     #dsmom043#1;
     1;
     nEmpresa43, "        ", 00, 2018, nActivid43;
     nEmpresa43, "zzzzzzzz", 99, 2018, nActivid43;
     ;
     NULL, GrabaGananyPerd;
|FIN;

|PROCESO MiraComunero_1;
     |SI #dsmom001#8 > "01.01.0000";
         |SI #dsmom001#8 > "31.12.2018";  |ACABA;  |FINSI;
     |FINSI;

     |SI #dsmom001#9 > "01.01.0000";
         |SI #dsmom001#9 < "01.01.2018";  |ACABA;  |FINSI;
     |FINSI;

     nEmpresa43  = #dsmom001#0;
     nActivid43  = #dsmom001#1;
     nPorce      = #dsmom001#7;
     |BUCLE dsmom043;
|FPRC;

|DEFBUCLE dsmom001_1;
     #dsmom001#2;
     ;
     #agicen14#0, #agicen14#1;
     #agicen14#0, #agicen14#1;
     ;
     NULL, MiraComunero_1;
|FIN;

|PROCESO GananciasYPerdidas;
     |SI #agicen30#8  = 13;  |O #agicen30#8 = 14;  |O #agicen30#8 = 15;
      |O #agicen30#8  = 16;  |O #agicen30#8 = 17;  |O #agicen30#8 = 19;
         |BUCLE dsmom001_1;
     |SINO;
         nEmpresa43 = #agicen14#0;
         nActivid43 = #agicen14#1;
         nPorce     = 100;
         |BUCLE dsmom043;
     |FINSI;
|FPRC;

|PROCESO Borra141;
     |SI #rem00041#3 = "X";
         |BORRA 020#rem00041.a;
         eaPrograma   = "rem00041";
         eaPunto      = "  ";
         |HAZ ProgramaActivo;
     |SINO;
         enSwPasa = 0;
     |FINSI;
     |LIBERA #rem00041;
|FPRC;

|DEFBUCLE rem00041;
     #rem00041#1;
     11;
     #reacceso#0, 01, "PA";
     #reacceso#0, 99, "PA";
     be;
     NULL, Borra141;
|FIN;

|PROCESO Borra41;
     |BUCLE rem00041;
|FPRC;

|PROCESO BuscaCaptura;
     |DBASS aBase;  |QBF aBase;
     aMas = aBase + "basica/def/agicen14.mas";
     |CARGA_DEF aMas, activida@;
     |SI FSalida = 0;
         aPathFich = aBase + "basica/fich/";
         |PATH_DAT #activida@#aPathFich#;

         |ABRE #activida@;
         |SELECT #1#activida@;
         #activida@#0 = #dsmom001#0;
         #activida@#1 = #dsmom001#1;
         |LEE 000#activida@.=;
         |SI FSalida ! 0;  |DDEFECTO #activida@;  |FINSI;
         |CIERRA #activida@;

         eaCaptura = #activida@#15;
     |FINSI;

     |DESCARGA_DEF #activida@;

     |DBASS aBase;  |QBF aBase;
     aMas = aBase + "basica/def/agicen30.mas";
     |CARGA_DEF aMas, activida@;
     |SI FSalida = 0;
         aPathFich = aBase + "basica/fich/";
         |PATH_DAT #activida@#aPathFich#;

         |ABRE #activida@;
         |SELECT #1#activida@;
         #activida@#0 = #dsmom001#0;
         #activida@#1 = #dsmom001#1;
         #activida@#2 = 2018;
         |LEE 000#activida@.=;
         |SI FSalida ! 0;  |DDEFECTO #activida@;  |FINSI;
         |CIERRA #activida@;

         |SI #activida@#16 ! "          ";
             eaCaptura = #activida@#16;
         |FINSI;
     |FINSI;

     |DESCARGA_DEF #activida@;
|FPRC;

|PROCESO AbreTempoTrab;
     aFichero = ("70" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #rew00070#aFichero#;
|FPRC;

|PROCESO GrabaFiltro;
     |ABRE #rew00070;
     #rew00070#0 = #dsm19001#0;
     |LEE 101#rew00070.=;
     |SI FSalida ! 0;
         |DDEFECTO #rew00070;
         #rew00070#0 = #dsm19001#0;
         |GRABA 020#rew00070.b;
     |FINSI;
     #rew00070#1 = enDComple;
     #rew00070#2 = enHComple;
     |GRABA 020#rew00070.a;
     |LIBERA #rew00070;
     |CIERRA #rew00070;
|FPRC;

|PROCESO LeeFiltro;
     |ABRE #rew00070;
     #rew00070#0 = #dsm19001#0;
     |LEE 101#rew00070.=;
     |SI FSalida ! 0;  |DDEFECTO #rew00070;  |FINSI;
     |CIERRA #rew00070;

     enError = 0;
     |SI #dsm19001#4 < #rew00070#1;  |O #dsm19001#4 > #rew00070#2;
         enError = 1;
     |FINSI;
|FPRC;

|PROCESO CierraTempoTrab;
     |DELINDEX #rew00070;
|FPRC;

|PROCESO PintaPantalla;
     |PINPA #0#rezcaptu;
|FPRC;

|PROCESO Busca122;
     nLinea = #rem00022#1;
|FPRC;

|DEFBUCLE rem00022B;
     #rem00022#1;
     18;
     #reacceso#0, 01, aIdentificador;
     #reacceso#0, 99, aIdentificador;
     be;
     NULL, Busca122;
|FIN;

|PROCESO dsm193li;
     |SI nComprueba = 0;
         |SI #dsm193li#4 ! 0;
             |ABRE #dsm193ca;
             #dsm193ca#0 = #dsm193li#0;
             #dsm193ca#1 = #dsm193li#1;
             #dsm193ca#2 = #dsm193li#2;
             #dsm193ca#3 = #dsm193li#3;
             #dsm193ca#4 = #dsm193li#4;
             #dsm193ca#5 = #dsm193li#5;
             |LEE 040#dsm193ca.=;
             |SI FSalida ! 0;  |DDEFECTO #dsm193ca;  |FINSI;
             |CIERRA #dsm193ca;

             |SI #dsm193ca#14 = "S";
                 enDComple = #dsm193li#4;
                 enHComple = #dsm193li#4;
             |SINO;
                 enHComple = #dsm193li#4;
             |FINSI;
         |SINO;
             enDComple = #dsm193li#4;
             enHComple = #dsm193li#4;
         |FINSI;

         #dsm19001#0 = #dsm193li#0;
         |HAZ GrabaFiltro;

         |ACABA;
     |FINSI;

     #dsm19001#0 = #dsm193li#0;
     #dsm19001#4 = #dsm193li#4;
     |HAZ LeeFiltro;
     |SI enError = 1;  |ACABA;  |FINSI;

     nLinea         = 0;
     aIdentificador = "*" + (("00000" + #dsm193li#0) % -105) + (#dsm193li#6 % 109) + (("0000" + #dsm193li#7) % -104) + "*";
     |BUCLE rem00022B;

     |SI nLinea = 0;
         |ABRE #rem00022;
         nLinea = 1;
         #rem00022#0 = #reacceso#0;
         #rem00022#1 = 99;
         |LEE 040#rem00022.];
         |SI FSalida = 0;
             |LEE 040#rem00022.a;
         |SINO;
             |LEE 040#rem00022.u;
         |FINSI;
         |SI FSalida = 0;  |Y #rem00022#0 = #reacceso#0;
             nLinea = #rem00022#1 + 1;
             |SI nLinea ] 99;
                 |PARA nLinea = 99; |SI nLinea ] 0; |HACIENDO nLinea = nLinea - 1;
                       #rem00022#0 = #reacceso#0;
                       #rem00022#1 = nLinea;
                       |LEE 040#rem00022.=;
                       |SI FSalida ! 0;  |SAL;  |FINSI;
                 |SIGUE;
             |FINSI;
         |FINSI;
         |CIERRA #rem00022;
     |FINSI;

     |SI nLinea = 0;  |ACABA;  |FINSI;

     #rem00022#0 = #reacceso#0;
     #rem00022#1 = nLinea;
     |LEE 101#rem00022.=;
     |SI FSalida ! 0;
         |DDEFECTO #rem00022;
         #rem00022#0 = #reacceso#0;
         #rem00022#1 = nLinea;
         #rem00022#3  = "X";
         |GRABA 020#rem00022.b;
     |FINSI;

     |SI #rem00022#3 ! "X";  |ACABA;  |FINSI;

     |ABRE #dsam0000;
     #dsam0000#0 = #dsm193li#0;
     |LEE 040#dsam0000.=;
     |SI FSalida ! 0;  |DDEFECTO #dsam0000;  |FINSI;
     |CIERRA #dsam0000;

     |ABRE #reauxval;
     |SELECT #2#reauxval;
     #reauxval#1 = #dsam0000#1;
     |LEE 000#reauxval.=;
     |SI FSalida ! 0;  |DDEFECTO #reauxval;  |FINSI;
     |CIERRA #reauxval;

     #rem00022#2  = eaPerceptor;
     #rem00022#16 = #reauxval#0;
     #rem00022#17 = #dsam0000#1;
     #rem00022#18 = aIdentificador;
     #rem00022#19 = #rem00022#19 + #dsm193li#23;
     #rem00022#23 = #dsm193li#24;
     #rem00022#20 = 0;
     #rem00022#21 = 0;
     #rem00022#24 = #rem00022#19 % #rem00022#23;
     #rem00022#22 = #rem00022#19;

     |GRABA 020#rem00022.a;
     |LIBERA #rem00022;

     eaPrograma   = "rem00022";
     eaPunto      = "  ";
     |HAZ ProgramaActivo;
|FPRC;

|DEFBUCLE dsm193li;
     #dsm193li#1;
     ;
     00000, 2018, 99, 193, enDComple, 00, aNif, 0000, "A", "02", 1;
     99999, 2018, 99, 193, enHComple, 99, aNif, 9999, "A", "02", 1;
     ;
     NULL, NULL, NULL, NULL, NULL, dsm193li;
     6, 1, 4, 8, 9;
|FIN;

|PROCESO Borra122;
     aAlfa1 =  #rem00022#18 % 101;
     aAlfa2 =  #rem00022#18 % 2001;
     |SI aAlfa1 ! "*"; |O aAlfa2 ! "*";
         |ACABA;
    |FINSI;

     |SI #rem00022#3 = "X";
         |BORRA 020#rem00022.a;
         eaPrograma   = "rem00021";
         eaPunto      = "  ";
         |HAZ ProgramaActivo;
     |FINSI;
     |LIBERA #rem00022;
|FPRC;

|DEFBUCLE rem00022;
     #rem00022#1;
     ;
     #reacceso#0, 01;
     #reacceso#0, 99;
     be;
     NULL, Borra122;
|FIN;

|PROCESO PasaDelModelo193;
     |ABRET #rem00022;

     |BUCLE rem00022;

     |HAZ AbreTempoTrab;
     aNif        = #dsam0003#1;   |QBT aNif;
     eaPerceptor = "TITULAR";
     enDComple   = 0;
     enHComple   = 99;
     nComprueba  = 0;  |BUCLE dsm193li;
     nComprueba  = 1;  |BUCLE dsm193li;
     |HAZ CierraTempoTrab;


     |HAZ AbreTempoTrab;
     aNif        = #dsam0003#35;   |QBT aNif;
     eaPerceptor = "CONYUGE";
     enDComple   = 0;
     enHComple   = 99;
     nComprueba  = 0;  |BUCLE dsm193li;
     nComprueba  = 1;  |BUCLE dsm193li;
     |HAZ CierraTempoTrab;

     |CIERRAT #rem00022;
|FPRC;

|PROCESO rem01011;
     enGastos = enGastos + #rem01011@#15;
|FPRC;

|DEFBUCLE rem01011;
     #rem01011@#1004;
     9;
     #reacceso#0, nComple, aContri, 001, eaRefCast;
     #reacceso#0, nComple, aContri, 999, eaRefCast;
     ;
     NULL, rem01011;
|FIN;

|PROCESO rem01001;
     nComple  = #rem01001@#1;
     aContri  = #rem01001@#2;
     |BUCLE rem01011;
|FPRC;

|DEFBUCLE rem01001;
     #rem01001@#1003;
     5;
     #reacceso#0, 00, "          ", "100";
     #reacceso#0, 99, "zzzzzzzzzz", "101";
     ;
     NULL, rem01001;
|FIN;

|PROCESO RecogeGastos;
     |DBASS aBase;
     aMas = aBase + "ren2017/def/rem01001.mas";
     |CARGA_DEF aMas, rem01001@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aMas = aBase + "ren2017/def/rem01011.mas";
     |CARGA_DEF aMas, rem01011@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aPathFich = aBase + "ren2017/fich/";
     |PATH_DAT #rem01001@#aPathFich#;
     |PATH_DAT #rem01011@#aPathFich#;

     enGastos = 0;
     |BUCLE rem01001;

     |DESCARGA_DEF #rem01011@;
     |DESCARGA_DEF #rem01001@;
|FPRC;

|PROCESO MiraLorca;
     |ABRE #dsmom068;
     #dsmom068#0 = #dsmom018#0;
     #dsmom068#1 = #dsmom018#1;
     #dsmom068#2 = #dsmom018#2;
     #dsmom068#3 = #dsmom018#3;
     |LEE 000#dsmom068.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom068;  |FINSI;
     |CIERRA #dsmom068;

     eaLorca = #dsmom068#12;
|FPRC;

|PROCESO cacuenta;
     nSaldo = #cacuenta#53 - #cacuenta#50;

     |SI eaPerceptor = "TITULAR   ";  enImporteT = enImporteT + nSaldo;  |FINSI;
     |SI eaPerceptor = "CONYUGE   ";  enImporteC = enImporteC + nSaldo;  |FINSI;
     |SI eaPerceptor = "1 FAMILIAR";  enImporte1 = enImporte1 + nSaldo;  |FINSI;
     |SI eaPerceptor = "2 FAMILIAR";  enImporte2 = enImporte2 + nSaldo;  |FINSI;
     |SI eaPerceptor = "3 FAMILIAR";  enImporte3 = enImporte3 + nSaldo;  |FINSI;
     |SI eaPerceptor = "4 FAMILIAR";  enImporte4 = enImporte4 + nSaldo;  |FINSI;
|FPRC;

|DEFBUCLE cacuenta;
     #cacuenta#6;
     ;
     "S", aDCuenta;
     "S", aHCuenta;
     ;
     NULL, cacuenta;
|FIN;

|PROCESO Asalariados;
     |ABRE #canempre;
     |SELECT #4#canempre;
     #canempre#2  = #agicen14#0;
     #canempre#26 = 18;               || Ejercicio 2018
     |LEE 040#canempre.=;
     |SI FSalida ! 0;
         |CIERRA #canempre;
         |ACABA;
     |FINSI;

     |DBASS aBase;  |QBF aBase;
     aPathFich = aBase + "contagen/fich/" + (("00000" + #canempre#2) % -105) + #canempre#3 + "/";

     |PATH_DAT #cacuenta#aPathFich#;
     aDCuenta = "64";
     aHCuenta = "64zzzzzzzzz";
     |BUCLE cacuenta;
|FPRC;
