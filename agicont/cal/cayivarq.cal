|FICHEROS;
    cayivarq;

    caivasop;
    caivarep;
    caivasof;
    caivaref;

    dsmow172;
    dsmow173;

    cacongru;
    calibros;
    caconcep;
    cacon300;
    caclipro;

    caivaasi;
    caconimp;

    dsmow030 #900;
    dsmow157 #957;
    camacc01 #501;
    camacc02 #502;
|FIN;

|VARIABLES;
   aParam       = "";
   informe      = "";
   aInfoRes     = "";
   nInkey       = 0;
   aFichero     = "";
   nCampo       = 0;
   nDEmpresa    = 0;
   nHEmpresa    = 0;
   nDActividad  = 0;
   nHActividad  = 0;
   nLaEmpresa   = 0;
   nGTempo      = 0;
   nSPin1       = 0;
   aPath        = "";
   nEjercicio   = 0;

   aAlfa        = "";
   aAlfa1       = "";
   aAlfa2       = "";
   aAlfa3       = "";
   nPara1       = 0;
   nPara2       = 0;
   nPara3       = 0;
   nNume1       = 0;
   nNume2       = 0;
   nNume3       = 0;
   nNume4       = 0;
   nNume5       = 0;
   nNume6       = 0;
   fFecha       = @;
   nClave       = 0;

   aDTipo       = "";
   aHTipo       = "";
   SwHayDatos   = 0;
   ffecha1      = @;
   fDFecha      = @;
   fHFecha      = @;
   nDLiqui      = 0;
   nHLiqui      = 0;
   fLaFecha     = @;
   nElDepar     = 0;
   nEstado      = 0;
   nOperacion   = 0;
   nOpMdep      = 0;
   nAlSi        = 0;
   nAlNo        = 0;
   nAlConcepto  = 0;
   aClave       = "";

   aClaveOpe    = "";
   fFechaPago   = @;
   nImporPago   = 0;
   aMedioPago   = "";
   aDesPago     = "";
   nLibros      = 0;

   &enSwCaja    = 0;
   &enError     = 0;
   &eaAlfa      = "";
   &efFechaEmi  = @;
   &nLBase      = 0;
   &nLTipoI     = 0;
   &nLCuoI      = 0;
   &nLCuoIN     = 0;
   &nLTipoR     = 0;
   &nLCuoR      = 0;
   &nLCuoRN     = 0;
   &nLBasP      = 0;
   &nLTipP      = 0;
   &nLCuoP      = 0;
   &SwLinea     = 0;
   &aTipoIVA    = "";
   &aTipo       = "";
   &aTipoRS     = "";
   &nFactura    = 0;
   &enPorCsv    = 0;
   &eaPathDoc   = "";
   &eaPathLocal = "";
   &eaNomFic    = "";
   &enCab       = 0;
   &eaAbre      = "";

   &entrada     = 1;

   sw_con       = 0;
   x            = 0;
   y            = 0;
   nNivel       = 0;
   nBase        = 0;
   nIva         = 0;
   nCuota       = 0;
   nRec         = 0;
   nCuoRec      = 0;

   &eDevenCaja  = 0;
   &enLibroCaja = 0;
   &eaSerieCaja = "";
   &enRegisCaja = 0;
   &enConcepto  = 0;
   &eaTituloL   = "";
|FIN;

|INCLUYE acceso_i;
|INCLUYE varnue_i;
____________________________________/ CALCULOS DE PANTALLA
|PROCESO cheq_libro; |TIPO 0;
  |SI #calibros#2 ! #cayivarq#37;
      aAlfa1 = "    ATENCION!!! Libro de I.V.A. Repercutido ...";
      |SI #calibros#2 = "S";
          aAlfa1 = "    ATENCION!!! Libro de I.V.A. Soportado ...";
      |FINSI;
      |MENAV aAlfa1;
      |ERROR;
  |FINSI;
|FPRC;

|PROCESO fechad;
  |SI #cayivarq#Campo# < fec1; |O #cayivarq#Campo# > fec2;
      |MENAV "    ERROR ESTA FECHA NO CORRESPONDE AL EJERCICIO";
      |ERROR;
  |FINSI;
|FPRC;

|PROCESO fechah;
  nCampo = Campo - 1;
  |SI #cayivarq#Campo# < fec1; |O #cayivarq#Campo# > fec2; |O #cayivarq#Campo# < #cayivarq#nCampo#;
      |MENAV "    ERROR ESTA FECHA NO CORRESPONDE AL EJERCICIO";
      |ERROR;
  |FINSI;
|FPRC;

|PROCESO selecci2; |TIPO 0;  || Seleccion Conceptos
    |SI #cayivarq#31 = "N";
        |CAMPO_MODIFICA #cayivarq#6, 1, "S";
        |CAMPO_MODIFICA #cayivarq#32, 1, "N";
        |CAMPO_MODIFICA #cayivarq#33, 1, "N";
        |CAMPO_MODIFICA #cayivarq#34, 1, "N";
        |CAMPO_MODIFICA #cayivarq#35, 1, "N";
        #cayivarq#32 = 0;      |PINTA #cayivarq#32;
        #cayivarq#33 = 0;      |PINTA #cayivarq#33;
        #cayivarq#34 = 0;      |PINTA #cayivarq#34;
        #cayivarq#35 = 0;      |PINTA #cayivarq#35;
    |SINO;
        |CAMPO_MODIFICA #cayivarq#6, 1, "N";
        |CAMPO_MODIFICA #cayivarq#32, 1, "S";
        |CAMPO_MODIFICA #cayivarq#33, 1, "S";
        |CAMPO_MODIFICA #cayivarq#34, 1, "S";
        |CAMPO_MODIFICA #cayivarq#35, 1, "S";
        #cayivarq#6 = "N";    |PINTA #cayivarq#6;
        |HAZ no_entres;
    |FINSI;
|FPRC;

|PROCESO leegrupo; |TIPO 0;
    |SI FSalida = 2; |ACABA; |FINSI;
    |SI #cayivarq#Campo# = 0; |ACABA; |FINSI;

    |ABRE #cacongru;
    #cacongru#0 = #cayivarq#Campo#;
    |LEE 001#cacongru.=;
    |SI salidas ! 0;
        |MENAV "    NO existe el Grupo de Conceptos";
        |ERROR;
    |FINSI;
    |CIERRA #cacongru;
|FPRC;

|PROCESO no_entres;
  aAlfa1 = #cayivarq#6;
  |PARA nCampo = 7;  |SI nCampo [ 30;  |HACIENDO nCampo = nCampo + 1;
        |CAMPO_MODIFICA #cayivarq#nCampo#, 1, aAlfa1;
        |SI aAlfa1 = "N";
           #cayivarq#nCampo# = 0;
           |PINTA #cayivarq#nCampo#;
        |FINSI;
  |SIGUE;
|FPRC;

|PROCESO nopidas;
  |SI #cayivarq#Campo# ! 0;  |ACABA;  |FINSI;
  aAlfa1 = "N";
  |PARA nCampo = Campo + 1;  |SI nCampo [ 30;  |HACIENDO nCampo = nCampo + 1;
        |CAMPO_MODIFICA #cayivarq#nCampo#, 1, aAlfa1;
        #cayivarq#nCampo# = 0;
        |PINTA #cayivarq#nCampo#;
  |SIGUE;
|FPRC;

|PROCESO Formato;
       aAlfa = "Fichero CSV  ";
   |SI #cayivarq#36 = 2;
       aAlfa = "Fichero EXCEL";
   |FINSI;
   |ATRI P; |PINTA 2021, aAlfa; |ATRI 0;
|FPRC;
|| *************************************************************************
|PROCESO congru;
  sw_con = 1;
  |ABRE #cacongru;
  |PARA y = 32; |SI y [ 35; |HACIENDO y = y + 1;
        |SI #cayivarq#y# ! 0;
            #cacongru#0 = #cayivarq#y#;
            |LEE 001#cacongru.=;
            |SI FSalida = 0;
                |PARA x = 2; |SI x [ 21; |HACIENDO x = x + 1;
                      |SI #cacongru#x# = enConcepto;
                          sw_con = 0;
                          |SAL;
                      |FINSI;
                |SIGUE;
            |FINSI;
        |FINSI;
        |SI sw_con = 0; |SAL; |FINSI;
  |SIGUE;
  |CIERRA #cacongru;
|FPRC;

|PROCESO conceptos;

  |DDEFECTO #caconcep;
  #caconcep#0 = enConcepto;
  |LEE 041#caconcep.=;

  |DDEFECTO #cacon300;
  #cacon300#0 = enConcepto;
  |LEE 041#cacon300.=;

  |SI #cayivarq#31 = "S";
      |HAZ congru;
      |ACABA;
  |FINSI;

  sw_con = 0;
  |SI #cayivarq#6 ! "S";  |ACABA;  |FINSI;
  sw_con = 1;
  |PARA nCampo = 7; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
        |SI #cayivarq#nCampo# ! 0;|Y #cayivarq#nCampo# = enConcepto;
            sw_con = 0;
            |SAL;
        |FINSI;
  |SIGUE;
|FPRC;

|PROCESO VerCaja;
   |HAZ EsCajaIva;
   |SI enSwCaja = 1;
       aClaveOpe = "07";
       |DDEFECTO #501;
       #501#13 = aTipoIVA;
       #501#17 = eDevenCaja;
       #501#0  = enLibroCaja;
       #501#14 = eaSerieCaja;
       #501#15 = enRegisCaja;
       |LEE 040#501=;
       |SI FSalida ! 0;  enSwCaja = 0; aClaveOpe = ""; |FINSI;
   |FINSI;
   |SI enSwCaja = 0;
       |SI #cacon300#1 = 4; aClaveOpe = "02"; |FINSI;
   |FINSI;
|FPRC;

|PROCESO CalTipoNif;
   |DDEFECTO #caclipro;
   #caclipro#23 = "P";
   |SI aTipoIVA = "R";
       #caclipro#23 = "C";
   |FINSI;
   #caclipro#10 = #900#19;
   #caclipro#11 = nNivel;
   |LEE 041#caclipro.=;

   aAlfa1     = #caclipro#24; aAlfa2 = "  ";
   |SI aAlfa1 = "   "; aAlfa1 = "ES "; |FINSI;
   |SI aAlfa1 ! "ES ";
       aAlfa = aAlfa1; |QBF aAlfa;
       |SI aAlfa = "GR";  aAlfa = "EL";  |FINSI;
                          aAlfa2 = "06";
       |SI aAlfa = "DE";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "AT";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "BE";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "BG";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "CY";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "DK";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "SI";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "EE";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "FI";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "FR";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "EL";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "GB";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "NL";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "HU";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "IT";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "IE";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "LV";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "LT";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "LU";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "MT";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "PL";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "PT";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "CZ";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "SK";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "RO";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "SE";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "HR";  aAlfa2 = "02";  |FINSI;
   |FINSI;
   aAlfa = aAlfa1 + aAlfa2;
|FPRC;

|| *************************************************************************
|| *************************************************************************
|PROCESO Cabw172;   || Soportado
        |DDEFECTO #dsmow172;
        #dsmow172#0  = nClave;
        #dsmow172#1  = #900#79;
        #dsmow172#2  = #900#81;
        #dsmow172#3  = #900#22;
        #dsmow172#4  = "";
        aAlfa = #900#16; |QBF aAlfa;
        |SI aAlfa ! ""; aAlfa = aAlfa + "/"; |FINSI;
        aAlfa = aAlfa + #900#17;
        #dsmow172#5  = aAlfa;
        #dsmow172#7  = (#900#65 % 402);
        #dsmow172#8  = (#900#65 % 103);
        #dsmow172#9  = #900#21;
        #dsmow172#10 = #900#20;

        #dsmow172#12 = aClaveOpe;
        #dsmow172#13 = #900#51;
        #900#51 = 0;
|FPRC;

|PROCESO Cabw173;  || Repercutido
        |DDEFECTO #dsmow173;
        #dsmow173#0  = nClave;
        #dsmow173#1  = #900#79;
        #dsmow173#2  = #900#81;
        #dsmow173#3  = #900#16;
        #dsmow173#4  = #900#17;
        |SI #caivarep#62 > 1;
            nNume1 = #900#17 + (#caivarep#62) - 1;
            aAlfa  = nNume1;
            #dsmow173#5  = aAlfa;
        |FINSI;

        #dsmow173#6  = (#900#65 % 402);
        #dsmow173#7  = (#900#65 % 103);
        #dsmow173#8  = #900#21;
        #dsmow173#9  = #900#20;

        #dsmow173#11 = aClaveOpe;
        #dsmow173#12 = #900#51;
        #900#51 = 0;
|FPRC;

|PROCESO Graba_Req_RECC;
    nClave = nClave + 1;

    |SI aTipoIVA = "S";

        |HAZ Cabw172;
        #dsmow172#20 = fFechaPago;
        #dsmow172#21 = nImporPago;
        #dsmow172#22 = aMedioPago;
        #dsmow172#23 = aDesPago;

        |GRABA 020#dsmow172.n;
    |FINSI;

    |SI aTipoIVA = "R";

        |HAZ Cabw173;
        #dsmow173#18 = fFechaPago;
        #dsmow173#19 = nImporPago;
        #dsmow173#20 = aMedioPago;
        #dsmow173#21 = aDesPago;

        |GRABA 020#dsmow173.n;
    |FINSI;
|FPRC;

|PROCESO Graba_Req;

    nClave = nClave + 1;
    |SI aTipoIVA = "S";

        |HAZ Cabw172;
        #dsmow172#14 = nLBase;
        #dsmow172#15 = nLTipoI;
        #dsmow172#16 = nLCuoI + nLCuoIN;
        #dsmow172#17 = nLCuoI;
        #dsmow172#18 = nLTipoR;
        #dsmow172#19 = nLCuoR;

        |GRABA 020#dsmow172.n;
    |FINSI;

    |SI aTipoIVA = "R";

        |HAZ Cabw173;
        #dsmow173#13 = nLBase;
        #dsmow173#14 = nLTipoI;
        #dsmow173#15 = nLCuoI;
        #dsmow173#16 = nLTipoR;
        #dsmow173#17 = nLCuoR;

        |GRABA 020#dsmow173.n;
    |FINSI;
|FPRC;

|| *************************
|PROCESO camacc02;
    fFechaPago = #camacc02#4;
    nImporPago = #camacc02#10;
    aAlfa = #camacc02#15 - "DEVENGO";
    |SI FSalida ! 0;
        aMedioPago = "03";
    |SINO;
        |SI #camacc02#14 = "T"; aMedioPago = "01"; |FINSI;
        |SI #camacc02#14 = "C"; aMedioPago = "02"; |FINSI;
        |SI #camacc02#14 = "O"; aMedioPago = "04"; |FINSI;
    |FINSI;
    aDesPago = #camacc02#15;

    |HAZ Graba_Req_RECC;
|FPRC;

|DEFBUCLE camacc02;
    #camacc02#1;
    ;
    aTipoIVA, eDevenCaja, enLibroCaja, eaSerieCaja, enRegisCaja, 01;
    aTipoIVA, eDevenCaja, enLibroCaja, eaSerieCaja, enRegisCaja, 99;
    e;
    NULL, camacc02;
|FIN;

|| *************************************************************************
|PROCESO Auxiliar57;

 |SI nOperacion = 0;
     nCampo = nCampo + 1;
 |FINSI;

 |SI nOperacion = 1;
     nLBase  = #957#1;
     nLTipoI = #957#2;
     nLCuoI  = #957#3;
     nLTipoR = #957#4;
     nLCuoR  = #957#5;
     nLCuoIN = #957#6;
     nLCuoRN = #957#7;
     |SI nLCuoI = 0; |Y nLCuoIN = 0; nLTipoI = 0; |FINSI;
     |SI nLCuoR = 0; |Y nLCuoRN = 0; nLTipoR = 0; |FINSI;
     |SI nLBase ! 0; |O nLCuoI ! 0; |O nLCuoR ! 0; |O nLCuoIN ! 0; |O nLCuoRN ! 0;
         |HAZ Graba_Req;
         SwLinea = SwLinea + 1;
     |FINSI;
 |FINSI;
|FPRC;

|DEFBUCLE Auxiliar57;
  #957#1;
  ;
  nPara1,  000,  000;
  nPara1, 1000, 1000;
  ;
  NULL, Auxiliar57;
|FIN;

|PROCESO VariasLineas;

 SwLinea = 0;
 nLBasP = #900#66;
 nLTipP = #900#67;
 nLCuoP = #900#68;
 |PARA nPara1 = 23; |SI nPara1 [ 27; |HACIENDO nPara1 = nPara1 + 1;
       nCampo = 0;
       nOperacion = 0; |BUCLE Auxiliar57;
       |SI nCampo [ 1;
           nLBase = #900nPara1;
           nNume1 = nPara1 +  6; nLTipoI = #900nNume1;
           nNume2 = nPara1 + 11; nLCuoI  = #900nNume2;
           nNume3 = nPara1 + 17; nLTipoR = #900nNume3;
           nNume4 = nPara1 + 22; nLCuoR  = #900nNume4;
           nNume5 = nPara1 + 29; nLCuoIN = #900nNume5;
           nNume6 = nPara1 + 35; nLCuoRN = #900nNume6;
           |SI nLCuoI = 0; nLTipoI = 0; |FINSI;
           |SI nLCuoR = 0; nLTipoR = 0; |FINSI;

           |SI nLBase ! 0; |O nLCuoI ! 0; |O nLCuoR ! 0;  |O nLCuoIN ! 0; |O nLCuoRN ! 0;
               |HAZ Graba_Req;
               SwLinea = SwLinea + 1;
           |FINSI;
       |SINO;
           nOperacion = 1; |BUCLE Auxiliar57;
       |FINSI;
 |SIGUE;

 |SI SwLinea = 0;
     |HAZ Graba_Req;
     SwLinea = 1;
 |FINSI;

 |SI enSwCaja = 1;
    |BUCLE camacc02;
 |FINSI;

|FPRC;

|PROCESO SumaRepercutido;
 nCampo = -1;
 |SI nIva = 0;               ||  0%
     #900#27 = #900#27 + nBase;
     #900#28 = #900#28 + nBase;
 |SINO;
     #900#28 = #900#28 + nBase;
     #900#39 = #900#39 + nCuota;
     |SI nIva = 4;         ||  4%
         #900#23 = #900#23 + nBase;
         #900#29 = nIva;
         #900#34 = #900#34 + nCuota;
         nCampo = 23;
     |SINO;
         |SI nIva = 7; |O nIva = 8; |O nIva = 10;  ||  7% 8% 10%
             #900#24 = #900#24 + nBase;
             #900#30 = nIva;
             #900#35 = #900#35 + nCuota;
             nCampo = 24;
         |SINO;
             |SI nIva = 16;  |O nIva = 18; |O nIva = 21;   || 16% 18%
                 #900#25 = #900#25 + nBase;
                 #900#31 = nIva;
                 #900#36 = #900#36 + nCuota;
                 nCampo = 25;
             |SINO;
                 #900#26 = #900#26 + nBase;   || ??%
                 #900#32 = nIva;
                 #900#37 = #900#37 + nCuota;
                 nCampo = 26;
             |FINSI;
         |FINSI;
     |FINSI;
  |FINSI;

 |SI nRec ! 0;
     #900#50 = #900#50 + nCuoRec;
     |SI nRec = 0.50;
         #900#40 = nRec;
         #900#45 = #900#45 + nCuoRec;
     |SINO;
         |SI nRec = 1; |O nRec = 1.40;   || 1
             #900#41 = nRec;
             #900#46 = #900#46 + nCuoRec;
         |SINO;
             |SI nRec = 4; |O nRec = 5.20; || 4%
                 #900#42 = nRec;
                 #900#47 = #900#47 + nCuoRec;
             |SINO;
                 #900#43 = nRec;
                 #900#48 = #900#48 + nCuoRec; || %
             |FINSI;
         |FINSI;
     |FINSI;
 |FINSI;

 #900#51 = #900#51 + nBase + nCuota + nCuoRec;

/*
 #900#66 = #900#66 + #caivalin#20;
 #900#67 = #caivalin#21;
 #900#68 = #900#68 + #caivalin#22;
*/

|| ... Graba Detalle %
     |SI nCampo ! -1;
         |ABRE #957;
         #957#0 = nCampo;
         #957#2 = nIva;
         #957#4 = nRec;
         |LEE 041#957=;
         |SI FSalida ! 0;
             |DDEFECTO #957;
             #957#0 = nCampo;
             #957#2 = nIva;
             #957#4 = nRec;
             |GRABA 020#957c;
         |FINSI;
         #957#1  = #957#1 + nBase;
         #957#2  = nIva;
         #957#3  = #957#3 + nCuota;
         #957#4  = nRec;
         #957#5  = #957#5 + nCuoRec;
         |GRABA 020#957a;
         |CIERRA #957;
     |FINSI;
|FPRC;

|PROCESO SumaSoportado;
 nCampo = -1;
 |SI nIva = 0;               ||  0%
     #900#27 = #900#27 + nBase;
     #900#28 = #900#28 + nBase;
 |SINO;
     #900#28 = #900#28 + nBase;
     |SI #caivasop#23 = "S";
          #900#39 = #900#39 + nCuota;
          |SI nIva = 4;         ||  4%
              #900#23 = #900#23 + nBase;
              #900#29= nIva;
              #900#34 = #900#34 + nCuota;
              nCampo = 23;
          |SINO;
              |SI nIva = 7; |O nIva = 8; |O nIva = 10;  ||  7% y 8% 10%
                  #900#24 = #900#24 + nBase;
                  #900#30 = nIva;
                  #900#35 = #900#35 + nCuota;
                  nCampo = 24;
              |SINO;
                  |SI nIva = 16;  |O nIva = 18;  |O nIva = 21;    || 16% 18 % 21%
                      #900#25 = #900#25 + nBase;
                      #900#31 = nIva;
                      #900#36 = #900#36 + nCuota;
                      nCampo = 25;
                  |SINO;
                      #900#26 = #900#26 + nBase;   || ??%
                      #900#32 = nIva;
                      #900#37 = #900#37 + nCuota;
                      nCampo = 26;
                  |FINSI;
              |FINSI;
          |FINSI;
      |SINO;                                    ||NO DEDUCIBLE
          #900#57 = #900#57 + nCuota;
          |SI nIva = 4;         ||  4%
              #900#23 = #900#23 + nBase;
              #900#29 = nIva;
              #900#52 = #900#52 + nCuota;
              nCampo = 23;

          |SINO;
              |SI nIva = 7; |O nIva = 8; |O nIva = 10;       ||  7% 8% 10%
                  #900#24 = #900#24 + nBase;
                  #900#30 = nIva;
                  #900#53 = #900#53 + nCuota;
                  nCampo = 24;
              |SINO;
                  |SI nIva = 16; |O nIva = 18; |O nIva = 21;   || 16% 18% 21%
                      #900#25 = #900#25 + nBase;
                      #900#31 = nIva;
                      #900#54 = #900#54 + nCuota;
                      nCampo = 25;
                  |SINO;
                      #900#26 = #900#26 + nBase;   || ??%
                      #900#32 = nIva;
                      #900#55 = #900#55 + nCuota;
                      nCampo = 26;
                  |FINSI;
              |FINSI;
          |FINSI;
     |FINSI;
  |FINSI;

  |SI nRec ! 0; |Y #caivasop#23 = "S";
      #900#50 = #900#50 + nCuoRec;
      |SI nRec = 0.5;        || 0.5%
          #900#40 = nRec;
          #900#45 = #900#45 + nCuoRec;
      |SINO;
          |SI nRec = 1; |O nRec = 1.40;   || 1%
              #900#41 = nRec;
              #900#46 = #900#46 + nCuoRec;
         |SINO;
              |SI nRec = 4; |O nRec = 5.20; || 4
                  #900#42 = nRec;
                  #900#47 = #900#47 + nCuoRec;
             |SINO;
                 #900#43 = nRec;
                 #900#48 = #900#48 + nCuoRec; || %
             |FINSI;
         |FINSI;
     |FINSI;
 |FINSI;

 |SI nRec ! 0; |Y #caivasop#23 = "N";
     #900#63 = #900#63 + nCuoRec;
     |SI nRec = 0.5;        || 0.5%
         #900#40 = nRec;
         #900#58 = #900#58 + nCuoRec;
     |SINO;
         |SI nRec = 1; |O nRec = 1.40;   || 1.5%
             #900#41 = nRec;
             #900#59 = #900#59 + nCuoRec;
         |SINO;
             |SI nRec = 4; |O nRec = 5.20; || 1%
                 #900#42 = nRec;
                 #900#60 = #900#60 + nCuoRec;
             |SINO;
                 #900#43 = nRec;
                 #900#61 = #900#61 + nCuoRec; || %
             |FINSI;
         |FINSI;
     |FINSI;
 |FINSI;

 #900#51 = #900#51 + nBase + nCuota + nCuoRec;
/*
 #900#66 = #900#66 + #caivalin#20;
 #900#67 = #caivalin#21;
 #900#68 = #900#68 + #caivalin#22;
*/
|| ... Graba Detalle %
     |SI nCampo ! -1;
         |ABRE #957;
         #957#0 = nCampo;
         #957#2 = nIva;
         #957#4 = nRec;
         |LEE 041#957=;
         |SI FSalida ! 0;
             |DDEFECTO #957;
             #957#0 = nCampo;
             #957#2 = nIva;
             #957#4 = nRec;
             |GRABA 020#957c;
         |FINSI;
         #957#1  = #957#1 + nBase;
         #957#2  = nIva;
         #957#4  = nRec;
         |SI #caivasop#23 = "S";
             #957#3  = #957#3 + nCuota;
             #957#5  = #957#5 + nCuoRec;
         |SINO;
             #957#6  = #957#6 + nCuota;
             #957#7  = #957#7 + nCuoRec;
         |FINSI;
         |GRABA 020#957a;
         |CIERRA #957;
     |FINSI;
|FPRC;

|| *************************************************************************
|PROCESO FacturasS;
  enConcepto = #caivasop#6;
  |HAZ conceptos;
  |SI sw_con = 1;  |ACABA;   |FINSI;

  |DDEFECTO #caivasof;
  #caivasof#0 = #caivasop#0;
  #caivasof#1 = #caivasop#27;
  #caivasof#2 = #caivasop#2;
  |LEE 001#caivasof.=;

  |PDEFECTO #900, 16, 64;
  #900#66 = 0; #900#67 = 0; #900#68 = 0;
  #900#69 = #caivasop#49;

  #900#79 = "01.01.0000";
  #900#81 = "01.01.0000";
  #900#82 = "";
  #900#83 = 0;
  #900#84 = 0;
  #900#65 = "";
  |DELINDEX #957;

  #900#16 = #caivasop#27;
  #900#17 = #caivasop#2;
  |SI nFactura = 0; nFactura = 1; |FINSI;

  fLaFecha = #caivasop#3;
  aAlfa1   = fLaFecha; aAlfa1   = aAlfa1 % 105;
  #900#18  = aAlfa1;
  #900#19  = #caivasop#4;
  nNivel   = #caivasop#5;
  #900#20  = #caivasop#50;
  #900#21  = #caivasop#51;
  |HAZ CalTipoNif;
  #900#65 = aAlfa;

  #900#22 = #caivasop#7;

  #900#79  = fLaFecha;
  |SI #caivasof#3 > "01.01.0000";
       #900#81  = #caivasof#3;
       aAlfa1   = #900#81; aAlfa1   = aAlfa1 % 105;
       #900#82  = aAlfa1;
   |FINSI;

   #900#87 = #caivasop#44;
   |SI #caivasop#28 = "S"; #900#88 = #caivasop#44; |FINSI;

   |SI #caivasop#08 ! 0; |O #caivasop#14 ! 0; |O #caivasop#20 ! 0;
       nBase   = #caivasop#8;
       nIva    = #caivasop#11;
       nCuota  = #caivasop#14;
       nRec    = #caivasop#17;
       nCuoRec = #caivasop#20;
       |HAZ SumaSoportado;
   |FINSI;
   |SI #caivasop#09 ! 0; |O #caivasop#15 ! 0; |O #caivasop#21 ! 0;
       nBase   = #caivasop#9;
       nIva    = #caivasop#12;
       nCuota  = #caivasop#15;
       nRec    = #caivasop#18;
       nCuoRec = #caivasop#21;
       |HAZ SumaSoportado;
   |FINSI;
   |SI #caivasop#10 ! 0; |O #caivasop#16 ! 0; |O #caivasop#22 ! 0;
       nBase   = #caivasop#10;
       nIva    = #caivasop#13;
       nCuota  = #caivasop#16;
       nRec    = #caivasop#19;
       nCuoRec = #caivasop#22;
       |HAZ SumaSoportado;
   |FINSI;
   |SI #caivasop#52 ! 0; |O #caivasop#56 ! 0; |O #caivasop#60 ! 0;
       nBase   = #caivasop#52;
       nIva    = #caivasop#54;
       nCuota  = #caivasop#56;
       nRec    = #caivasop#58;
       nCuoRec = #caivasop#60;
       |HAZ SumaSoportado;
   |FINSI;
   |SI #caivasop#53 ! 0; |O #caivasop#57 ! 0; |O #caivasop#61 ! 0;
       nBase   = #caivasop#53;
       nIva    = #caivasop#55;
       nCuota  = #caivasop#57;
       nRec    = #caivasop#59;
       nCuoRec = #caivasop#61;
       |HAZ SumaSoportado;
   |FINSI;

   aClaveOpe   = "";
   enSwCaja    = 0
   eDevenCaja  = 0;
   enLibroCaja = #caivasop#0;
   enRegisCaja = #caivasop#2;
   eaSerieCaja = #caivasop#27;
   enConcepto  = #caivasop#6;
   |HAZ VerCaja;

   |HAZ VariasLineas;
   SwHayDatos = 1;

   nFactura = nFactura + 1;
|FPRC;

|PROCESO FacturasR;

  enConcepto = #caivarep#6;
  |HAZ conceptos;
  |SI sw_con = 1;  |ACABA;   |FINSI;

  |DDEFECTO #caivaref;
  #caivaref#0 = #caivarep#0;
  #caivaref#1 = #caivarep#27;
  #caivaref#2 = #caivarep#2;
  |LEE 001#caivaref.=;

  |PDEFECTO #900, 16, 64;
  #900#66 = 0; #900#67 = 0; #900#68 = 0;
  #900#69 = #caivarep#49;

  #900#79 = "01.01.0000";
  #900#81 = "01.01.0000";
  #900#82 = "";
  #900#83 = 0;
  #900#84 = 0;
  #900#65 = "";
  |DELINDEX #957;

  #900#16 = #caivarep#27;
  #900#17 = #caivarep#2;
  |SI nFactura = 0; nFactura = 1; |FINSI;

  fLaFecha = #caivarep#3;
  aAlfa1   = fLaFecha; aAlfa1   = aAlfa1 % 105;
  #900#18  = aAlfa1;
  #900#19  = #caivarep#4;
  nNivel   = #caivarep#5;
  #900#20  = #caivarep#50;
  #900#21  = #caivarep#51;
  |HAZ CalTipoNif;
  #900#65 = aAlfa;

  #900#22 = #caivarep#7;

  #900#79  = fLaFecha;
  |SI #caivaref#3 > "01.01.0000";
       #900#81  = #caivaref#3;
       aAlfa1   = #900#81; aAlfa1   = aAlfa1 % 105;
       #900#82  = aAlfa1;
   |FINSI;

   #900#87 = #caivarep#44;
   |SI #caivarep#28 = "S"; #900#88 = #caivarep#44; |FINSI;

   |SI #caivarep#08 ! 0; |O #caivarep#14 ! 0; |O #caivarep#20 ! 0;
       nBase   = #caivarep#8;
       nIva    = #caivarep#11;
       nCuota  = #caivarep#14;
       nRec    = #caivarep#17;
       nCuoRec = #caivarep#20;
       |HAZ SumaRepercutido;
   |FINSI;
   |SI #caivarep#09 ! 0; |O #caivarep#15 ! 0; |O #caivarep#21 ! 0;
       nBase   = #caivarep#9;
       nIva    = #caivarep#12;
       nCuota  = #caivarep#15;
       nRec    = #caivarep#18;
       nCuoRec = #caivarep#21;
       |HAZ SumaRepercutido;
   |FINSI;
   |SI #caivarep#10 ! 0; |O #caivarep#16 ! 0; |O #caivarep#22 ! 0;
       nBase   = #caivarep#10;
       nIva    = #caivarep#13;
       nCuota  = #caivarep#16;
       nRec    = #caivarep#19;
       nCuoRec = #caivarep#22;
       |HAZ SumaRepercutido;
   |FINSI;
   |SI #caivarep#52 ! 0; |O #caivarep#56 ! 0; |O #caivarep#60 ! 0;
       nBase   = #caivarep#52;
       nIva    = #caivarep#54;
       nCuota  = #caivarep#56;
       nRec    = #caivarep#58;
       nCuoRec = #caivarep#60;
       |HAZ SumaRepercutido;
   |FINSI;
   |SI #caivarep#53 ! 0; |O #caivarep#57 ! 0; |O #caivarep#61 ! 0;
       nBase   = #caivarep#53;
       nIva    = #caivarep#55;
       nCuota  = #caivarep#57;
       nRec    = #caivarep#59;
       nCuoRec = #caivarep#61;
       |HAZ SumaRepercutido;
   |FINSI;

   aClaveOpe = "";
   enSwCaja = 0
   eDevenCaja  = 0;
   enLibroCaja = #caivarep#0;
   enRegisCaja = #caivarep#2;
   eaSerieCaja = #caivarep#27;
   enConcepto  = #caivarep#6;
   |HAZ VerCaja;

   |HAZ VariasLineas;
   SwHayDatos = 1;

   nFactura = nFactura + 1;
|FPRC;

|| ////////////////////
|DEFBUCLE FacturasS;
 #caivasop#3;
 ;
 #cayivarq#0,  #cayivarq#2, #cayivarq#4, 000001;
 #cayivarq#1,  #cayivarq#3, #cayivarq#5, 999999;
 e;
 NULL, FacturasS;
|FIN;

|DEFBUCLE FacturasR;
 #caivarep#3;
 ;
 #cayivarq#0,  #cayivarq#2, #cayivarq#4, 000001;
 #cayivarq#1,  #cayivarq#3, #cayivarq#5, 999999;
 e;
 NULL, FacturasR;
|FIN;

|PROCESO ImprimeLinea;
    |SI enPorCsv = 1;
         |HAZ GrabaCsv;
    |SINO;
         |HAZ GrabaExcel;
    |FINSI;
    SwLinea = 1;
|FPRC;

|DEFBUCLE dsmow172;
   #dsmow172#1;
   ;
   00000001;
   99999999;
   ;
   NULL, ImprimeLinea;
|FIN;

|DEFBUCLE dsmow173;
   #dsmow173#1;
   ;
   00000001;
   99999999;
   ;
   NULL, ImprimeLinea;
|FIN;

|PROCESO Emision;
   |ABRE #caivaasi;
   |DDEFECTO #caivaasi;
   |LEE 000#caivaasi.p;
   |CIERRA #caivaasi;

   |DDEFECTO #caconimp;  ||Configuracion de Informes
   |ABRE #caconimp;
   #caconimp#0 = 1;
   |LEE 000#caconimp.=;
   |CIERRA #caconimp;

   nClave    = 0;
   eaTituloL = #cayivarq#38; ||Titulo del Libro
   |QBF eaTituloL;

   eaNomFic = enEjercicio;
   eaNomFic = eaNomFic + #canempre#8; |QBF eaNomFic;
   |SI aTipoIVA = "R";
       eaNomFic = eaNomFic + "E";
   |SINO;
       eaNomFic = eaNomFic + "R";
   |FINSI;

   eaAlfa = eaNombreEmp; |HAZ QuitaRarosNom;
   eaNomFic = eaNomFic + eaAlfa; |QBF eaNomFic;

   SwHayDatos = 0;
   fDFecha = #cayivarq#2;
   fHFecha = #cayivarq#3;

   || ... Creo auxiliar.

   |ABRE #caconcep;
   |ABRE #cacon300;
   |ABRE #caclipro;
   |ABRE #501;
   |ABRE #dsmow172;
   |ABRE #dsmow173;

   |SI aTipoIVA = "S";
       |ABRE #caivasof;
       |BUCLE FacturasS;
       |CIERRA #caivasof;
   |FINSI;
   |SI aTipoIVA = "R";
       |ABRE #caivaref;
       |BUCLE FacturasR;
       |CIERRA #caivaref;
   |FINSI;

   enError = 0;
/*
|SI aTipoIVA = "S"; |CONSULTA_CLAVE #1#dsmow172; |FINSI;
|SI aTipoIVA = "R"; |CONSULTA_CLAVE #1#dsmow173; |FINSI;
*/

   |CIERRA #dsmow172;
   |CIERRA #dsmow173;
   |CIERRA #501;
   |CIERRA #caclipro;
   |CIERRA #cacon300;
   |CIERRA #caconcep;

   |SI SwHayDatos = 1;
       |SI enPorCsv = 1;
           |HAZ PorCsv_2;
       |SINO;
           |HAZ PorExcel_2;
       |FINSI;

       |SI enError =  0;
           |SI aTipoIVA = "S"; |BUCLE dsmow172; |FINSI;
           |SI aTipoIVA = "R"; |BUCLE dsmow173; |FINSI;

           |SI enPorCsv = 1;
               |HAZ PresentaDocCsv;
           |SINO;
               |HAZ PresentaDocExcel;
           |FINSI;
           nLibros = nLibros + 1;
        |FINSI;
   |FINSI;

   |DELINDEX #dsmow172;
   |DELINDEX #dsmow173;
|FPRC;

|PROCESO Imprimir; |TIPO 3;

   aFichero = ("9s" + Usuario) % 108;
   |NOME_DAT #dsmow172#aFichero#;
   |DELINDEX #dsmow172;

   aFichero = ("9r" + Usuario) % 108;
   |NOME_DAT #dsmow173#aFichero#;
   |DELINDEX #dsmow173;

   |HAZ LeeUnidadBasico;

   |SI #cayivarq#36 = 1;
       enPorCsv = 1;
       |HAZ PorCsv_1;
   |SINO;
       enPorCsv  = 2;
       |HAZ PorExcel_1;
   |FINSI;

   nLibros = 0;
   |HAZ Emision;
   |SI nLibros ! 0;
       aAlfa = "Los libros generados estan: ";
       |SI nLibros = 1; aAlfa = "El libro generado esta: "; |FINSI;
       aAlfa = "0000" + aAlfa + eaPathLocal + " de su PC";
       |MENAV aAlfa;
   |SINO;
       |MENAV "0000Seleccion vacia";
   |FINSI;
|FPRC;
||///////////////////////////////////////////////////////////////////

|PROCESO lee_libro1;
  #cayivarq#0 = #calibros#0;
  #cayivarq#1 = #calibros#0;
  |ERROR10;
|FPRC;

|DEFBUCLE lee_libro;
 #calibros#1;
 2;
  1, #cayivarq#37;
 99, #cayivarq#37;
 e;
 NULL, lee_libro1;
|FIN;

|PROGRAMA;

  |HAZ inicio;
  |HAZ eVarEmpresa;
  aParam = PARAMETRO; |QBF aParam;
  |SI aParam = ""; aParam = "R"; |FINSI;

  |DDEFECTO #cayivarq;
  aClave    = aParam;

  |ABRE #cayivarq;
  #cayivarq#37 = aClave;
  |LEE 101#cayivarq.=;
  |SI FSalida ! 0;
      |DDEFECTO #cayivarq;
      #cayivarq#37  = aClave;
      #cayivarq#38 = "LIBRO REGISTRO DE FACTURAS EXPEDIDAS";
      |SI aClave = "S";
          #cayivarq#38 = "LIBRO REGISTRO DE FACTURAS RECIBIDAS";
      |FINSI;
      |BUCLE lee_libro;
      #cayivarq#2 = fec1;
      #cayivarq#3 = fec2;
      |GRABA 020#cayivarq.b;
      nEstado = 1;
  |FINSI;
  aTipoIVA   = #cayivarq#37;
  |SI aClave = "R";
      aTipo   = "EXPEDIDAS";
      aTipoRS = "REPERCUTIDO";
      aAlfa1  = "FACTURAS EMITIDAS ";
  |SINO;
      aTipo   = "RECIBIDAS";
      aTipoRS = "SOPORTADO";
      aAlfa1  = "FACTURAS RECIBIDAS ";
  |FINSI;

  |CLS;
  |PINPA #0#cayivarq;
  |ATRI R; |PINTA 0708, aAlfa1; |ATRI 0;
  |PINDA #0#cayivarq;
  |HAZ Formato;

  |ENDATOS #1#cayivarq;
  |SI FSalida = 0;
      #cayivarq#37 = aClave;
      |GRABA 020#cayivarq.a;
  |FINSI;
  |LIBERA #cayivarq;
  |CIERRA #cayivarq;
|FPRO;
