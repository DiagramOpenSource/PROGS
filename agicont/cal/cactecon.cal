||  el #5 y el #8 estan reservados para los 'INCLUYE'
 || /para 'cacuenta' y 'catradia' respect.

|FICHEROS;
    cactecon #00;
    camaasic #02;   || apuntes cabs.
    camaasil #03;   || apuntes lins.
    camingca #06;   || confirmes cabs.
    camingli #07;   || confirmes lins.
    cacuadre #09;   || control cobros y pagos
    camandia #10;   || diarios
    cacuebal #11;   || cuentas de balance
    camanpag #12;   || pagos
    caivasop #13;   || Libro Iva Soportado.....
    caconcep #33;   || Conceptos.....

    ca8m0002 #422;
|FIN;

|VARIABLES;
    &enDiario   = 0;
    &enContador = 0;

    nConp    = "";
    nDcop    = "";
    nDcof    = "";
     acon    = 0;
     descri2 = "";
    &entrada = 1;
    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    alfa5 = "";
    alfa6 = "";
    nPara1 = 0;
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;
    nume5 = 0;
    nume6 = 0;
    fech1 = @;
    fech2 = @;
    fech3 = @;
    fech4 = @;

    nSwLaC = 0;
    arteris = 0;
    swarteris = 0;

    mes_anyo = "";
    muestra = "";
    aMuestraO = "";
    digito = 0;
    longi = 0;
    asie = 0;
    apun = 0;
    cuen = "";
    digi = 0;
    sign = "";
    ptas = 0;
    desc = "";
    descrip = "";
    impo = 0;
    sw = 0;
    FEstado = 0;

    seleccio = 0;
    sw_tipo = 0;
    traba = "";
    &enEjerBal = 0;
|FIN;

|INCLUYE varnue_i;
|INCLUYE inicio_i;
|INCLUYE actcta_i;
|INCLUYE defec1_i;

**************************************************************************
          CALCULOS DESDE CAMPOS
**************************************************************************

|PROCESO limite; |TIPO 0;
|SI #0#7 < fec1;|O #0#7 > fec2;
    |MENAV "    ATENCION!!! La fecha no corresponde al ejercicio contable ...";
    |ERROR;
|FINSI;
|FPRC;

|PROCESO final816; |TIPO 7;
 |PTEC 816;
|FPRC;

|PROCESO Digito;         || saca el digito de la contrapartida del control
     sw   = 0;
     digito = 0;  || inicializa el digito
     |SI longi = dig4; |Y dig4 ! 0; sw = 1; digito = 1; |FINSI;
     |SI longi = dig5; |Y dig5 ! 0; sw = 1; digito = 2; |FINSI;
     |SI longi = dig6; |Y dig6 ! 0; sw = 1; digito = 3; |FINSI;
     |SI longi = dig7; |Y dig7 ! 0; sw = 1; digito = 4; |FINSI;
     |SI longi = dig8; |Y dig8 ! 0; sw = 1; digito = 5; |FINSI;
     |SI longi = dig9; |Y dig9 ! 0; sw = 1; digito = 6; |FINSI;
     |SI sw = 0;
         |MENAV "    Contrapartida de Pagos Fuera de Nivel!!! Proceso Abortado ...";
     |FINSI;
|FPRC;


|| ////////////////////////////////////////////////////////////////////
|PROCESO Arteris;     || desglosa la contrapartida del control

     alfa1 = #9#21;   |QBF alfa1;
     alfa2 = alfa1 % 0;
     longi = alfa2;            || 'longi' sirve despues (no tocar)

     nume3 = (longi * 100) + 1;
     alfa2 = alfa1 % nume3;

     |SI alfa2 = "*";|O alfa2 = "%";
         nume3     = 99 + longi;
         muestra   = alfa1 % nume3;
         arteris   = 1;
         swarteris = 0;
         |SI alfa2 = "%";
             swarteris = 1;
             mes_anyo  = (#0#7 % 402) + (#0#7 % -102);
         |FINSI;
     |SINO;
         |HAZ Digito;
         |SI sw = 0;   arteris = 2;  |FINSI; || contrapartida fuera de nivel!!!
         |SI sw ! 0;   arteris = 0;  |FINSI;
         muestra = alfa1;
     |FINSI;

  nSwLaC = 0;
  |PARA nume4 = 1; |SI nume4 [ longi; |HACIENDO nume4 = nume4 + 1;
        nume1 = (nume4 * 100) + 1;
        alfa3 = alfa1 % nume1;
        |SI alfa3 = "C";  nSwLaC = 1; |FINSI;
  |SIGUE;

|FPRC;

||////////////////////////////////////////////////////////////////////

|PROCESO Descripcion1;
     descrip = #0#6;  |QBF descrip;
     traba = #6#0;    |QBF traba;
     descrip = descrip + " " + (("000000" + traba) % -106);
|FPRC;

|PROCESO Descripcion2;
     descri2 = #0#15;  |QBF descri2;
     descri2 = descri2 + " " + #6#2;
     traba = #6#0;    |QBF traba;
     descri2 = descri2 + " " + (("000000" + traba) % -106);
|FPRC;

|PROCESO SacaCocp;
     nConp = #0#15;
     |QBF nConp;
     nDcop = "";
     nDcof = "";
     |ABRE #33;
     #33#0 = #13#6;
     |LEE 000#33=;
|| R.Blanquer                          31-01-2001

||     |SI FSalida = 0;
||         nDcof = #33#1;          |QBF nDcof;
||         nDcop = #13#7 - nDcof;  |QBF nDcop;
||         nConp = nConp + " " + nDcop;
||     |FINSI;
     |CIERRA #33;
|FPRC;

|PROCESO MontaCon;
     |ABRE #13;
     |DDEFECTO #13;
     #13#0  = #7#2; ||Libro...
     #13#2  = #7#3; ||Factura.
     #13#27 = #7#4; ||Serie...
     |LEE 000#13=;
     |HAZ SacaCocp;
     |CIERRA #13;
|FPRC;

|PROCESO Cabecera;       || actualiza Cabeceras
     |SI #3#09 ! 0;
         |DDEFECTO #2;
         #2#00 = #3#0;    || diario
         #2#01 = #3#1;    || fecha
         #2#02 = #3#2;    || documento
         #2#03 = #3#2;    || asiento
         |LEE 101#2=;
         FEstado = FSalida;
         |SI #3#08 = "D";
             #2#04 = #2#04 + #3#09;
             |SI #2#09 = 0; #2#08 = #3#4; #2#09 = #3#5; |FINSI;  || contrp.HABER
         |FINSI;
         |SI #3#08 = "H";
             #2#05 = #2#05 + #3#09;
             |SI #2#11 = 0; #2#10 = #3#4; #2#11 = #3#5; |FINSI;  || contrp.DEBE
         |FINSI;
         #2#6 = #2#4 - #2#5;                            || saldo
         |SI FEstado = 0;  |GRABA 020#2a;  |FINSI;
         |SI FEstado ! 0;  |GRABA 020#2n;  |FINSI;
         |LIBERA #2;
     |FINSI;
|FPRC;

|PROCESO actualiz3;
     |ABRE #10;
     #10#0 = #3#0;
     |LEE 121#10=;
     |SI FSalida = 0;
         |SI #3#8 = "D";  #10#2 = #10#2 + #3#9;  |FINSI;
         |SI #3#8 = "H";  #10#3 = #10#3 + #3#9;  |FINSI;
         |GRABA 020#10a;
     |FINSI;
     |LIBERA #10;
     |CIERRA #10;
|FPRC;

|PROCESO GrabaApunt2;    || graba apunte
     #0#08 = #6#0;   |PINTA #0#08;
     #0#09 = asie;   |PINTA #0#09;
     #0#10 = apun;   |PINTA #0#10;

     |DDEFECTO #3;
     #3#00 = #0#4;   || diario
     #3#01 = #0#7;   || fecha
     #3#02 = asie;   || asiento
     #3#03 = apun;   || apunte
     #3#04 = cuen;   || cuenta
     #3#05 = digi;   || digito
     #3#06 = acon;   || concepto
     #3#07 = desc;   || Descripcion
     #3#08 = sign;   || signo
     #3#09 = ptas;   || importe
     |SI #3#8 = "D";
         #3#16 = #3#4;
         #3#17 = #3#5;
         #3#10 = "";
         #3#11 = 0;
     |SINO;
         #3#16 = "";
         #3#17 = 0;
         #3#10 = #3#4;
         #3#11 = #3#5;
     |FINSI;
     #3#21 = #13#49;    ||Departamentoe
     |GRABA 020#3n;
     |HAZ Cabecera;           || Cabecera apunte
     ressum = #3#9;
     |HAZ actualiz1;          || cuenta
     |HAZ actualiz3;          || diario
     opera = "A";
     |HAZ altatra;            || subniveles
|FPRC;

|PROCESO PorCob;
     |HAZ MontaCon;
     apun = apun + 10;
     |QBF nConp;
     acon = #0#14;
     traba = #6#0;    |QBF traba;
     desc = nConp + " " + (("000000" + traba) % -106);
     desc = desc + " " + #7#7;
     cuen = #7#9;
     digi = #7#10;
     sign = "D";
     ptas = #7#8;
     |HAZ GrabaApunt2;

     apun = apun + 10;

     |HAZ Filtro;

     cuen = alfa2;
     digi = #7#10;
     sign = "H";
     ptas = #7#8;
     ||R Blanquer desc = descrip;
     desc = descrip + " " + #7#7;       || fecha vto.confirme linea
     acon = #0#5;

     |HAZ Cuenta;
     |HAZ GrabaApunt2;
|FPRC;


|PROCESO Filtro;         || construye la contrapartida individual

    |SI #6#5 = 1;  nume1 = dig4;  |FINSI;
    |SI #6#5 = 2;  nume1 = dig5;  |FINSI;
    |SI #6#5 = 3;  nume1 = dig6;  |FINSI;
    |SI #6#5 = 4;  nume1 = dig7;  |FINSI;
    |SI #6#5 = 5;  nume1 = dig8;  |FINSI;
    |SI #6#5 = 6;  nume1 = dig9;  |FINSI;

    aMuestraO = muestra;

|SI nSwLaC = 1;
    alfa5 = muestra % 0;
    nume5 = alfa5;
    alfa5 = "";
    |PARA nPara1 = 1; |SI nPara1 [ nume5; |HACIENDO nPara1 = nPara1 + 1;
          nume6 = (nPara1 * 100) + 1;
          alfa6 = muestra % nume6;
          |SI alfa6 = "C";
              alfa6 = #7#9 % nume6;
          |FINSI;
          alfa5 = alfa5 + alfa6;
    |SIGUE;

    muestra = alfa5;
|FINSI;

    nume2 = nume1 - (longi - 1);
    |SI swarteris = 0;
        nume2 = (100 * longi) + nume2;

        alfa1 = #7#9 % nume2;
        alfa2 = muestra + alfa1;             || si es "*"
    |SINO;
        nume2 = nume2 - 4;
        |SI nume2 < 0;
            |MENAV "    Cuenta con longitud fuera de nivel ...";
            nume2 = nume2 + 4;
            alfa1 = "0" * nume2;
            alfa2 = muestra + alfa1;
        |SINO;
            |SI nume2 = 0;  alfa1 = "";              |FINSI;   || cuenta ajustada
            |SI nume2 > 0;  alfa1 = "0" * nume2;     |FINSI;   || rellena de ceros
            mes_anyo = (#6#2 % 402) + (#6#2 % -102);
            alfa2 = muestra + alfa1 + mes_anyo;  || si es "%"
        |FINSI;
     |FINSI;

     muestra = aMuestraO;
|FPRC;

|PROCESO Cuenta;    || comprueba si la cuenta esta dada de alta
     |ABRE #5;
     #5#0 = cuen;
     #5#1 = digi;
     |LEE 001#5=;
     |SI FSalida ! 0;
         |DDEFECTO #5;
         #5#0 = cuen;
         #5#1 = digi;

         |HAZ defect1;

         |PUSHV 0501 2380;
         |PINPA #0#5;
         |PINDA #0#5;
         |ENDATOS #1#5;
         |SI FSalida = 0;  |GRABA 020#5n;  |FINSI;
         |POPV;
     |FINSI;
     |CIERRA #5;
|FPRC;

|PROCESO GrabaApunt1;    || Con "*"

  |SI #6#10 ! "S";  |Y #6#10 ! "D";
      |ACABA;
  |FINSI;

     seleccio = 1;
     |HAZ Descripcion1;
     |HAZ Descripcion2;

     |SI apun = 0;
         enDiario = #0#4;
         |HAZ contador;
         asie = enContador;
         apun = - 9;
     |FINSI;

     cuen = #6#1;
     digi = #6#2;
     desc = descri2;
     acon = #0#14;
     sign = "D";
     |BUCLELIN 2 PorCob #6;

     apun  = 0;
     #6#12 = "S";
     |GRABA 020#6a;
     |LIBERA #6;


||     apun = apun + 10;
||     |HAZ Filtro;

||     cuen = alfa2;
||     digi = #6#5;
||     sign = "H";
||     ptas = #6#9;
||     desc = descrip;
||     acon = #0#5;

||     |HAZ Cuenta;
||     |HAZ GrabaApunt2;
     || ............. Fin Asiento
||     apun  = 0;
||     #6#12 = "S";
||     |GRABA 020#6a;
||     |LIBERA #6;
|FPRC;


|DEFBUCLE camingca;
     #6#1;
     1, 12, 7;
     #0#0, #0#2, "N", #0#11; || fecha emision, c. emision. NO
     #0#1, #0#3, "N", #0#12;
     be;
     NULL, GrabaApunt1;
     #6#4, #6#5, #6#0;
|FIN;

|PROCESO SubNiveles;     || actualiza subniveles de cuentas
     |SI modcon = 0;
         |ABRE #8;
         |DDEFECTO #8;
         #8#0 = codcon;
         |LEE 001#8=;
         |SI FSalida = 0;  |BORRA 020#8a;  |FINSI;
         |CIERRA #8;
     |SINO;
         |SUB_EJECUTA "camaapua.run";
     |FINSI;
|FPRC;

|PROCESO Tipo3; |TIPO 3;  || calculo padre
     |SI #30#26 < 80;
         enEjercicio = 2000 + #30#26;
     |SINO;
         enEjercicio = 1900 + #30#26;
     |FINSI;

     |ABRE #9;
     |LEE 000#9p;
     |SI FSalida ! 0;
         |MENAV "    ATENCION!!! Control de Pagares y Talones sin definir ...";
         |CIERRA #9;
         |ACABA;
     |FINSI;
     |CIERRA #9;

     |ABRE #2;
     |ABRE #3;
     |ABRE #12;

     apun = 0;
     |HAZ Arteris;
     |BUCLE camingca;
     |HAZ SubNiveles;

     |CIERRA #2;
     |CIERRA #3;
     |CIERRA #12;
|FPRC;
