|FICHEROS;
   dsapunte #0;
   caenlace #1;

   camaasic #3;
   camaasil #4;
   cacuenta #5,MANTE;
   camandia #6;

   caivarep #7;
   caivasop #8;

   caivaasi #9;
   caivases #10;
   calibros #11;
   caclipro #12;
   caconcep #13;
   cacuebal #14;
   calicont #15;
   camanpag #16;
   caconcyp #17;
   caforpag #18;
   cacuivli #19;

   canempre #30;
   caparbal #31;
   caagrupa #32;
   caepigra #33;
|FIN;

|INCLUYE acceso_i;
|INCLUYE conasi_i;

|VARIABLES;
   &PRMNT_enError = 0;
   &PRMNT_enVer = 0;
{500}nError = 0;
{500}aError = "";
   nContError = 0;
   nTotalErr = 0;
   nBorra    = 0;
   nBorraAnt = 0;

   nDiff  = 0; nTipo = 0; nIVA = 0; aTipo = "";
   nCalc  = 0; nCalc1 = 0; nEjer = 0;

   nAntDia = 0; aAntFec = @; nAntDoc = 0; nTotalDoc = 0;
   nAvisos = 0; nCriticos = 0; aMensaje = "";

   Path = ""; aAlfa = ""; aAlfa1 = ""; aAlfa2 = "";
   Campo1 = 0; Campo2 = 0; Campo3 = 0;
   Contador = 0; Cambiante = 0; NumAsiento = 0;
   nSwCtrapD = 0; nSwCtrapH = 0;

   SwAviso = 0;
   Comodin = ""; Comodin1 = ""; ComodNum = 0;
   nIvaCero = 0;

   Calc = 0; Calc1 = 0; Calc2 = 0;
   nLong = 0; aLong = "";
   SwNivel = 0; Nivel = 0; MaxNiv = 0;
   LibContra = 0; SerContra = ""; FacContra = 0;
   LibroAnt  = 0; SerieAnt  = "";
   EmpAnt    = 0; PerAnt    = 0;

   CmpDebe  = 0; CmpHaber = 0; CmpSaldo = 0;
   TotDebe  = 0; TotHaber = 0; TotSaldo = 0;

   Cuenta  = ""; Cuenta1 = ""; nImporte = 0;
   aNombre = ""; ErrorDoc = 0; Respuesta = "";
   Cont = 0; nCont = 0;

   EnDiario = 0; EnFecha = @; EnAsto = 0; nDOCUMENTO = 0;
   Dig1 = 0; Dig2 = 0; Dig3 = 0; Dig4 = 0; Dig5 = 0; Dig6 = 0;


   FechaEnl    = @; FechaHoy  = @;
   HoraEnl     = 0; Hora      = 0;
   MinutosEnl  = 0; Minutos   = 0;
   SegundosEnl = 0; Segundos  = 0;

   &enBuscaDoc = 0;
   nUltLinea   = 0;
   nNumAsto    = 0;
   nEstadoCab  = 0;

   nNume1   = 0;
   nNumPago = 0;
   pesetas  = 0;
   emision  = "";
   ptasrec1 = 0;
   ptasrec2 = 0;
   fectra1  = @;
   fFechaVto = @;
   nPtasVto  = 0;
   nSwPrim   = 0;

   nComp1 = 0; fComp2 = @; nComp3 = 0; nComp4 = 0; nComp5 = 0;
   nMiraApunte = 0;

|FIN;

|PROCESO RevisaTipos;
   nCalc = nTipo - #cacuivli#2;
   |SI nCalc < 0; nCalc = -nCalc; |FINSI;
   |SI nCalc < nDiff; nDiff = nCalc; nIVA = #cacuivli#2; |FINSI;
|FPRC;

|DEFBUCLE RevisaTipos;
#cacuivli#1;
;
aTipo, 01;
aTipo, 99;
;
NULL, RevisaTipos;
|FIN;

|PROCESO CompruebaTipos;
   |ABRE #cacuivli;
   |SI aTipo = "R";
      |PARA nCont = 11; |SI nCont [ 55; |HACIENDO nCont = nCont + 1;
         nTipo = #caivarep#nCont#; nDiff = 99;
         |SI nTipo ! 0;
            |BUCLE RevisaTipos;
            |SI nIVA ! nTipo; #caivarep#nCont# = nIVA; |FINSI;
         |FINSI;
         |SI nCont = 13; nCont = 53; |FINSI;
      |SIGUE;
   |FINSI;
   |CIERRA #cacuivli;
|FPRC;

|PROCESO RecalculaIva;
   |ATRI I; |PINTA 2207, "Recalculando campos de iva       "; |ATRI N;
   |SI #caenlace#1 < "01.07.2010";
      |SI #caenlace#30 = "S"; #caenlace#28 = 16; |FINSI;
   |SINO;
      |SI #caenlace#30 = "S"; #caenlace#28 = 18; |FINSI;
   |FINSI;
|SI #caenlace#10 = "R";
      #caivarep#26 = #caivarep#8  + #caivarep#9  + #caivarep#10 + #caivarep#52 + #caivarep#53;
      #caivarep#26 = #caivarep#26 + #caivarep#14 + #caivarep#15 + #caivarep#16 + #caivarep#56 + #caivarep#57;
      #caivarep#26 = #caivarep#26 + #caivarep#20 + #caivarep#21 + #caivarep#22 + #caivarep#60 + #caivarep#61;

      |SI #caenlace#28 = 00.00; |O #caenlace#28 < 0;
         |SI #caenlace#26 = "B";
            #caivarep#11 = ((#caivarep#14 / #caivarep#8)  * 100) ! 0;  || Tipos de IVA
            #caivarep#12 = ((#caivarep#15 / #caivarep#9)  * 100) ! 0;
            #caivarep#13 = ((#caivarep#16 / #caivarep#10) * 100) ! 0;
            #caivarep#54 = ((#caivarep#56 / #caivarep#52) * 100) ! 0;
            #caivarep#55 = ((#caivarep#57 / #caivarep#53) * 100) ! 0;
            aTipo = "R"; |HAZ CompruebaTipos;
         |FINSI;
      |SINO;
         |SI #caenlace#27 = 0; |Y #caenlace#26 ! "F"; #caenlace#27 = 1; |FINSI;
         |SI #caenlace#27 = 1; #caivarep#11 = #caenlace#28; |FINSI;
         |SI #caenlace#27 = 2; #caivarep#12 = #caenlace#28; |FINSI;
         |SI #caenlace#27 = 3; #caivarep#13 = #caenlace#28; |FINSI;
         |SI #caenlace#27 = 4; #caivarep#54 = #caenlace#28; |FINSI;
         |SI #caenlace#27 = 5; #caivarep#55 = #caenlace#28; |FINSI;

         #caivarep#14 = #caivarep#8  % #caivarep#11;
         #caivarep#15 = #caivarep#9  % #caivarep#12;
         #caivarep#16 = #caivarep#10 % #caivarep#13;
         #caivarep#56 = #caivarep#52 % #caivarep#54;
         #caivarep#57 = #caivarep#53 % #caivarep#55;

         #caivarep#26 = #caivarep#8  + #caivarep#9  + #caivarep#10 + #caivarep#52 + #caivarep#53;
         #caivarep#26 = #caivarep#26 + #caivarep#14 + #caivarep#15 + #caivarep#16 + #caivarep#56 + #caivarep#57;
         #caivarep#26 = #caivarep#26 + #caivarep#20 + #caivarep#21 + #caivarep#22 + #caivarep#60 + #caivarep#61;
      |FINSI;

      |SI #caenlace#33 = 00.00; |O #caenlace#33 < 0;
         |SI #caenlace#26 = "B";
            #caivarep#17 = ((#caivarep#20 / #caivarep#8)  * 100);  || Tipos de REC
            |SI #caivarep#17 < .8; |Y #caivarep#17 > 0; #caivarep#17 = 0.5; |SINO; #caivarep#17 = #caivarep#17 ! 0; |FINSI;
            #caivarep#18 = ((#caivarep#21 / #caivarep#9)  * 100);
            |SI #caivarep#18 < .8; |Y #caivarep#18 > 0; #caivarep#18 = 0.5; |SINO; #caivarep#18 = #caivarep#18 ! 0; |FINSI;
            #caivarep#19 = ((#caivarep#22 / #caivarep#10) * 100);
            |SI #caivarep#19 < .8; |Y #caivarep#19 > 0; #caivarep#19 = 0.5; |SINO; #caivarep#19 = #caivarep#19 ! 0; |FINSI;
            #caivarep#58 = ((#caivarep#60 / #caivarep#52) * 100);
            |SI #caivarep#58 < .8; |Y #caivarep#58 > 0; #caivarep#58 = 0.5; |SINO; #caivarep#58 = #caivarep#58 ! 0; |FINSI;
            #caivarep#59 = ((#caivarep#61 / #caivarep#53) * 100);
            |SI #caivarep#59 < .8; |Y #caivarep#59 > 0; #caivarep#59 = 0.5; |SINO; #caivarep#59 = #caivarep#59 ! 0; |FINSI;
         |FINSI;
      |SINO;
         |SI #caenlace#27 = 0; |Y #caenlace#26 ! "F"; #caenlace#27 = 1; |FINSI;
         |SI #caenlace#27 = 1; #caivarep#17 = #caenlace#33; |FINSI;
         |SI #caenlace#27 = 2; #caivarep#18 = #caenlace#33; |FINSI;
         |SI #caenlace#27 = 3; #caivarep#19 = #caenlace#33; |FINSI;
         |SI #caenlace#27 = 4; #caivarep#58 = #caenlace#33; |FINSI;
         |SI #caenlace#27 = 5; #caivarep#59 = #caenlace#33; |FINSI;

         #caivarep#20 = #caivarep#8  % #caivarep#17;
         #caivarep#21 = #caivarep#9  % #caivarep#18;
         #caivarep#22 = #caivarep#10 % #caivarep#19;
         #caivarep#60 = #caivarep#52 % #caivarep#58;
         #caivarep#61 = #caivarep#53 % #caivarep#59;

         #caivarep#26 = #caivarep#8  + #caivarep#9  + #caivarep#10 + #caivarep#52 + #caivarep#53;
         #caivarep#26 = #caivarep#26 + #caivarep#14 + #caivarep#15 + #caivarep#16 + #caivarep#56 + #caivarep#57;
         #caivarep#26 = #caivarep#26 + #caivarep#20 + #caivarep#21 + #caivarep#22 + #caivarep#60 + #caivarep#61;
      |FINSI;
|FINSI;

|SI #caenlace#10 = "S";
      #caivasop#26 = #caivasop#8  + #caivasop#9  + #caivasop#10 + #caivasop#52 + #caivasop#53;
      #caivasop#26 = #caivasop#26 + #caivasop#14 + #caivasop#15 + #caivasop#16 + #caivasop#56 + #caivasop#57;
      #caivasop#26 = #caivasop#26 + #caivasop#20 + #caivasop#21 + #caivasop#22 + #caivasop#60 + #caivasop#61;

      |SI #caenlace#28 = 00.00; |O #caenlace#28 < 0;
         |SI #caenlace#26 = "B";
            #caivasop#11 = ((#caivasop#14 / #caivasop#8)  * 100) ! 0;  || Tipos de IVA
            #caivasop#12 = ((#caivasop#15 / #caivasop#9)  * 100) ! 0;
            #caivasop#13 = ((#caivasop#16 / #caivasop#10) * 100) ! 0;
            #caivasop#54 = ((#caivasop#56 / #caivasop#52) * 100) ! 0;
            #caivasop#55 = ((#caivasop#57 / #caivasop#53) * 100) ! 0;
         |FINSI;
      |SINO;
         |SI #caenlace#27 = 0; |Y #caenlace#26 ! "F"; #caenlace#27 = 1; |FINSI;
         |SI #caenlace#27 = 1; #caivasop#11 = #caenlace#28; |FINSI;
         |SI #caenlace#27 = 2; #caivasop#12 = #caenlace#28; |FINSI;
         |SI #caenlace#27 = 3; #caivasop#13 = #caenlace#28; |FINSI;
         |SI #caenlace#27 = 4; #caivasop#54 = #caenlace#28; |FINSI;
         |SI #caenlace#27 = 5; #caivasop#55 = #caenlace#28; |FINSI;

         #caivasop#14 = #caivasop#8  % #caivasop#11;
         #caivasop#15 = #caivasop#9  % #caivasop#12;
         #caivasop#16 = #caivasop#10 % #caivasop#13;
         #caivasop#56 = #caivasop#52 % #caivasop#54;
         #caivasop#57 = #caivasop#53 % #caivasop#55;

         #caivasop#26 = #caivasop#8  + #caivasop#9  + #caivasop#10 + #caivasop#52 + #caivasop#53;
         #caivasop#26 = #caivasop#26 + #caivasop#14 + #caivasop#15 + #caivasop#16 + #caivasop#56 + #caivasop#57;
         #caivasop#26 = #caivasop#26 + #caivasop#20 + #caivasop#21 + #caivasop#22 + #caivasop#60 + #caivasop#61;
      |FINSI;

      |SI #caenlace#33 = 00.00; |O #caenlace#33 < 0;
         |SI #caenlace#26 = "B";
            #caivasop#17 = ((#caivasop#20 / #caivasop#8)  * 100);  || Tipos de REC
            |SI #caivasop#17 < .8; |Y #caivasop#17 > 0; #caivasop#17 = 0.5; |SINO; #caivasop#17 = #caivasop#17 ! 0; |FINSI;
            #caivasop#18 = ((#caivasop#21 / #caivasop#9)  * 100);
            |SI #caivasop#18 < .8; |Y #caivasop#18 > 0; #caivasop#18 = 0.5; |SINO; #caivasop#18 = #caivasop#18 ! 0; |FINSI;
            #caivasop#19 = ((#caivasop#22 / #caivasop#10) * 100);
            |SI #caivasop#19 < .8; |Y #caivasop#19 > 0; #caivasop#19 = 0.5; |SINO; #caivasop#19 = #caivasop#19 ! 0; |FINSI;
            #caivasop#58 = ((#caivasop#60 / #caivasop#52) * 100);
            |SI #caivasop#58 < .8; |Y #caivasop#58 > 0; #caivasop#58 = 0.5; |SINO; #caivasop#58 = #caivasop#58 ! 0; |FINSI;
            #caivasop#59 = ((#caivasop#61 / #caivasop#53) * 100);
            |SI #caivasop#59 < .8; |Y #caivasop#59 > 0; #caivasop#59 = 0.5; |SINO; #caivasop#59 = #caivasop#59 ! 0; |FINSI;
         |FINSI;
      |SINO;
         |SI #caenlace#27 = 0; |Y #caenlace#26 ! "F"; #caenlace#27 = 1; |FINSI;
         |SI #caenlace#27 = 1; #caivasop#17 = #caenlace#33; |FINSI;
         |SI #caenlace#27 = 2; #caivasop#18 = #caenlace#33; |FINSI;
         |SI #caenlace#27 = 3; #caivasop#19 = #caenlace#33; |FINSI;
         |SI #caenlace#27 = 4; #caivasop#58 = #caenlace#33; |FINSI;
         |SI #caenlace#27 = 5; #caivasop#59 = #caenlace#33; |FINSI;

         #caivasop#20 = #caivasop#8  % #caivasop#17;
         #caivasop#21 = #caivasop#9  % #caivasop#18;
         #caivasop#22 = #caivasop#10 % #caivasop#19;
         #caivasop#60 = #caivasop#52 % #caivasop#58;
         #caivasop#61 = #caivasop#53 % #caivasop#59;

         #caivasop#26 = #caivasop#8  + #caivasop#9  + #caivasop#10 + #caivasop#52 + #caivasop#53;
         #caivasop#26 = #caivasop#26 + #caivasop#14 + #caivasop#15 + #caivasop#16 + #caivasop#56 + #caivasop#57;
         #caivasop#26 = #caivasop#26 + #caivasop#20 + #caivasop#21 + #caivasop#22 + #caivasop#60 + #caivasop#61;
      |FINSI;
|FINSI;

|FPRC;

|PROCESO CreaRegistro;
   |SI #caenlace#26 = "F";
      |ABRE #caivaasi; |LEE 000#caivaasi.p; |CIERRA #caivaasi;
      |SI #caenlace#10 = "R";
         |SI #caenlace#13 < 0;
            |SI #caivaasi#44 = "S";
               |ABRE #caivases;
               #caivases#0 = #caenlace#12;
               #caivases#1 = "R";
               |LEE 000#caivases.=;
               |SI FSalida = 0;
                  #caenlace#13 = #caivases#3;
               |SINO;
                  |DDEFECTO #caivases;
                  #caivases#0 = #caenlace#12;
                  #caivases#1 = "R";
                  #caivases#3 = 1;
                  #caenlace#13 = #caivases#3;
               |FINSI;
               |CIERRA #caivases;
            |SINO;
               |ABRE #calibros;
               #calibros#0 = #caenlace#11;
               |LEE 000#calibros.=;
               |SI FSalida = 0;
                  #caenlace#13 = #calibros#4;
               |SINO;
                  #caenlace#13 = 1;
               |FINSI;
               |CIERRA #calibros;
            |FINSI;
         |FINSI;
         NumAsiento = #caenlace#13;
         #caivarep#0  = #caenlace#11;
         #caivarep#27 = #caenlace#12;
         #caivarep#2  = #caenlace#13;
         |LEE 101#caivarep.=;
         |SI FSalida ! 0;
             |DDEFECTO #caivarep;
             #caivarep#0  = #caenlace#11;
             #caivarep#27 = #caenlace#12;
             #caivarep#2  = #caenlace#13;
             |GRABA 020#caivarep.b;
         |FINSI;
         |SI #caivaasi#44 = "S";
             |ABRE #caivases;
             #caivases#0 = #caenlace#12;
             #caivases#1 = "R";
             |LEE 101#caivases.=;
             |SI FSalida = 0;
                 #caivases#3 = #caenlace#13 + 1;
                 |GRABA 020#caivases.a; |LIBERA #caivases;
             |SINO;
                 |DDEFECTO #caivases;
                 #caivases#0 = #caenlace#12;
                 #caivases#1 = "R";
                 #caivases#3 = #caenlace#13 + 1;
                 |GRABA 020#caivases.n; |LIBERA #caivases;
             |FINSI;
             |CIERRA #caivases;
         |SINO;
             |ABRE #calibros;
             #calibros#0 = #caenlace#11;
             |LEE 101#calibros.=;
             |SI FSalida = 0;
                #calibros#4 = #caenlace#13 + 1;
                |GRABA 020#calibros.a; |LIBERA #calibros;
             |SINO;
                |DDEFECTO #calibros;
                #calibros#0 = #caenlace#11;
                #calibros#1 = "LIBRO " + (("00" + #caenlace#11) % -102) + " REPERCUTIDO";
                #calibros#2 = #caenlace#10;
                #calibros#3 = #caenlace#13 + 1;
                #calibros#4 = 1;
                |GRABA 020#calibros.n;
             |FINSI;
             |CIERRA #calibros;
          |FINSI;
          #caivarep#3  = #caenlace#29;
          #caivarep#4  = #caenlace#4;
          #caivarep#5  = #caenlace#5;
          #caivarep#6  = #caenlace#6;
          #caivarep#7  = #caenlace#7;
          Comodin = #caenlace#31; |QBF Comodin;
          |SI Comodin = "";
             #caivarep#23 = #caivaasi#21;
          |SINO;
             #caivarep#23 = #caenlace#31;
          |FINSI;

          Comodin = #caenlace#29; |QBF Comodin;
          aAlfa = Comodin % 0704; nCalc1 = aAlfa;
          Comodin = Comodin % 0402; Calc = Comodin;
          #caivarep#44 = Calc;
          |SI nCalc1 [ 2009;
             |SI #caivaasi#46 = "T";
                |SI Calc ] 1;  |Y Calc [ 3;  #caivarep#44 = 1; |FINSI;
                |SI Calc ] 4;  |Y Calc [ 6;  #caivarep#44 = 2; |FINSI;
                |SI Calc ] 7;  |Y Calc [ 9;  #caivarep#44 = 3; |FINSI;
                |SI Calc ] 10; |Y Calc [ 12; #caivarep#44 = 4; |FINSI;
             |FINSI;
          |FINSI;

          |SI nIvaCero = 0;
             #caivarep#45 = #caenlace#0;
             #caivarep#46 = #caenlace#1;
             #caivarep#47 = #caenlace#2;
          |SINO;
             #caivarep#45 = 0;
             #caivarep#46 = "01.01.0000";
             #caivarep#47 = 0;
          |FINSI;
          Comodin = #caenlace#32; |QBF Comodin;
          |SI Comodin = "";
             #caivarep#48 = #caivaasi#23;
          |SINO;
             #caivarep#48 = #caenlace#32;
          |FINSI;
          #caivarep#49 = #caenlace#15;

          aAlfa  = #caenlace#43; |QBF aAlfa;
          aAlfa1 = #caenlace#44; |QBF aAlfa1;
          |ABRE #caclipro;
          #caclipro#23 = "C";
          #caclipro#10 = #caenlace#4;
          #caclipro#11 = #caenlace#5;
          |LEE 000#caclipro.=;
          |SI FSalida = 0;
             |SI aAlfa = ""; |Y aAlfa1 = "";
                aAlfa = #caclipro#1;
                aAlfa1 = #caclipro#9;
             |FINSI;
          |FINSI;

          #caivarep#50 = aAlfa;
          #caivarep#51 = aAlfa1;

          |CIERRA #caclipro;
          |HAZ RecalculaIva;
          |SI #caenlace#30 = "S";
             |SI FacContra ! 0; |Y LibContra = #caenlace#34; |Y SerContra = #caenlace#35;
                #caenlace#36 = FacContra;
             |SINO;
                |ABRE #caivases;
                #caivases#0 = #caenlace#35;
                #caivases#1 = "S";
                |LEE 101#caivases.=;
                |SI FSalida = 0;
                   FacContra = #caivases#3; #caenlace#36 = #caivases#3;
                   #caivases#3 = #caivases#3 + #caivases#4;
                   |GRABA 020#caivases.a; |LIBERA #caivases;
                |FINSI;
                |CIERRA #caivases;
             |FINSI;
             aAlfa = "**"  + (("00" + #caenlace#34) % -102);
             aAlfa = aAlfa + #caenlace#35;
             aAlfa = aAlfa + (("000000" + #caenlace#36) % -106);
             #caivarep#35 = aAlfa;
          |FINSI;
          |GRABA 020#caivarep.a;
          |LIBERA #caivarep;
          |ATRI I;|PINTA 2207, "Grabando registro de iva         ";|ATRI N;
       |FINSI;
       |SI #caenlace#10 = "S";
          |SI #caenlace#13 < 0;
             |SI #caivaasi#44 = "S";
                |ABRE #caivases;
                #caivases#0 = #caenlace#12;
                #caivases#1 = "S";
                |LEE 000#caivases.=;
                |SI FSalida = 0;
                  #caenlace#13 = #caivases#3;
                |SINO;
                  |DDEFECTO #caivases;
                  #caivases#0 = #caenlace#12;
                  #caivases#1 = "S";
                  #caivases#3 = 1;
                  #caenlace#13 = #caivases#3;
                |FINSI;
                |CIERRA #caivases;
             |SINO;
                |ABRE #calibros;
                #calibros#0 = #caenlace#11;
                |LEE 000#calibros.=;
                |SI FSalida = 0;
                   #caenlace#13 = #calibros#4;
                |SINO;
                   #caenlace#13 = 1;
                |FINSI;
                |CIERRA #calibros;
             |FINSI;
          |FINSI;
          NumAsiento = #caenlace#13;
          #caivasop#0  = #caenlace#11;
          #caivasop#27 = #caenlace#12;
          #caivasop#2  = #caenlace#13;
          |LEE 101#caivasop.=;
          |SI FSalida ! 0;
             |DDEFECTO #caivasop;
             #caivasop#0  = #caenlace#11;
             #caivasop#27 = #caenlace#12;
             #caivasop#2  = #caenlace#13;
             |GRABA 020#caivasop.b;
          |FINSI;
          |SI #caivaasi#44 = "S";
             |ABRE #caivases;
             #caivases#0 = #caenlace#12;
             #caivases#1 = "S";
             |LEE 101#caivases.=;
             |SI FSalida = 0;
                #caivases#3 = #caenlace#13 + #caivases#4;
                |GRABA 020#caivases.a; |LIBERA #caivases;
             |SINO;
                |DDEFECTO #caivases;
                #caivases#0 = #caenlace#12;
                #caivases#1 = "S";
                #caivases#3 = #caenlace#13 + #caivases#4;
                |GRABA 020#caivases.n; |LIBERA #caivases;
             |FINSI;
             |CIERRA #caivases;
          |SINO;
             |ABRE #calibros;
             #calibros#0 = #caenlace#11;
             |LEE 101#calibros.=;
             |SI FSalida = 0;
                #calibros#4 = #caenlace#13 + 1;
                |GRABA 020#calibros.a; |LIBERA #calibros;
             |SINO;
                |DDEFECTO #calibros;
                #calibros#0 = #caenlace#11;
                #calibros#1 = "LIBRO " + (("00" + #caenlace#11) % -102) + " SOPORTADO";
                #calibros#2 = #caenlace#10;
                #calibros#3 = #caenlace#13 + 1;
                #calibros#4 = 1;
                |GRABA 020#calibros.n;
             |FINSI;
             |CIERRA #calibros;
          |FINSI;
          #caivasop#3  = #caenlace#29;
          #caivasop#4  = #caenlace#4;
          #caivasop#5  = #caenlace#5;
          #caivasop#6  = #caenlace#6;
          #caivasop#7  = #caenlace#7;
          Comodin = #caenlace#31; |QBF Comodin;
          |SI Comodin = "";
             #caivasop#23 = #caivaasi#21;
          |SINO;
             #caivasop#23 = #caenlace#31;
          |FINSI;

          Comodin = #caenlace#29; |QBF Comodin;
          aAlfa = Comodin % 0704; nCalc1 = Comodin;
          Comodin = Comodin % 0402; Calc = Comodin;
          #caivasop#44 = Calc;
          |SI nCalc1 [ 2009;
             |SI #caivaasi#46 = "T";
                |SI Calc ] 1;  |Y Calc [ 3;  #caivasop#44 = 1; |FINSI;
                |SI Calc ] 4;  |Y Calc [ 6;  #caivasop#44 = 2; |FINSI;
                |SI Calc ] 7;  |Y Calc [ 9;  #caivasop#44 = 3; |FINSI;
                |SI Calc ] 10; |Y Calc [ 12; #caivasop#44 = 4; |FINSI;
             |FINSI;
          |FINSI;
          |SI nIvaCero = 0;
             #caivasop#45 = #caenlace#0;
             #caivasop#46 = #caenlace#1;
             #caivasop#47 = #caenlace#2;
          |SINO;
             #caivarep#45 = 0;
             #caivarep#46 = "01.01.0000";
             #caivarep#47 = 0;
          |FINSI;
          Comodin = #caenlace#32; |QBF Comodin;
          |SI Comodin = "";
             #caivasop#48 = #caivaasi#23;
          |SINO;
             #caivasop#48 = #caenlace#32;
          |FINSI;
          #caivasop#49 = #caenlace#15;

          aAlfa  = #caenlace#43; |QBF aAlfa;
          aAlfa1 = #caenlace#44; |QBF aAlfa1;
          |ABRE #caclipro;
          |DDEFECTO #caclipro;
          #caclipro#23 = "P";
          #caclipro#10 = #caenlace#4;
          #caclipro#11 = #caenlace#5;
          |LEE 000#caclipro.=;
          |SI FSalida = 0;
             |SI aAlfa = ""; |Y aAlfa1 = "";
                aAlfa = #caclipro#1;
                aAlfa1 = #caclipro#9;
             |FINSI;
          |FINSI;
          |CIERRA #caclipro;
          #caivasop#50 = aAlfa;
          #caivasop#51 = aAlfa1;

          |HAZ RecalculaIva;
          |SI #caenlace#30 = "S";
             |SI FacContra ! 0; |Y LibContra = #caenlace#34; |Y SerContra = #caenlace#35;
                #caenlace#36 = FacContra;
             |SINO;
                |ABRE #caivases;
                #caivases#0 = #caenlace#35;
                #caivases#1 = "R";
                |LEE 101#caivases.=;
                |SI FSalida = 0;
                   FacContra = #caivases#3; #caenlace#36 = #caivases#3;
                   #caivases#3 = #caivases#3 + 1;
                   |GRABA 020#caivases.a; |LIBERA #caivases;
                |FINSI;
                |CIERRA #caivases;
             |FINSI;
             aAlfa = "**"  + (("00" + #caenlace#34) % -102);
             aAlfa = aAlfa + #caenlace#35;
             aAlfa = aAlfa + (("000000" + #caenlace#36) % -106);
             #caivasop#35 = aAlfa;
          |FINSI;
          |GRABA 020#caivasop.a; |LIBERA #caivasop;
          |ATRI I;|PINTA 2207, "Grabando registro de iva         ";|ATRI N;

          |SI #caenlace#14 = 999;
              nSwPrim = 0;
              |HAZ CreoPagos;
          |FINSI;
       |FINSI;
    |FINSI;
    |SI #caenlace#26 = "B";
       |SI #caenlace#13 < 0; #caenlace#13 = NumAsiento; |FINSI;
       |SI #caenlace#10 = "R";
          #caivarep#0  = #caenlace#11;
          #caivarep#27 = #caenlace#12;
          #caivarep#2  = #caenlace#13;
          |LEE 101#caivarep.=;
          |SI FSalida = 0;
             |SI #caenlace#27 = 0; #caenlace#27 = 1; |FINSI;
             |SI #caenlace#27 = 1; #caivarep#8  = #caivarep#8  + #caenlace#9; |FINSI;
             |SI #caenlace#27 = 2; #caivarep#9  = #caivarep#9  + #caenlace#9; |FINSI;
             |SI #caenlace#27 = 3; #caivarep#10 = #caivarep#10 + #caenlace#9; |FINSI;
             |SI #caenlace#27 = 4; #caivarep#52 = #caivarep#52 + #caenlace#9; |FINSI;
             |SI #caenlace#27 = 5; #caivarep#53 = #caivarep#53 + #caenlace#9; |FINSI;
          |FINSI;
          |HAZ RecalculaIva;
          |GRABA 020#caivarep.a; |LIBERA #caivarep;
          |ATRI I;|PINTA 2207, "Actualizando bases del registro  ";|ATRI N;
       |FINSI;
       |SI #caenlace#10 = "S";
          #caivasop#0  = #caenlace#11;
          #caivasop#27 = #caenlace#12;
          #caivasop#2  = #caenlace#13;
          |LEE 101#caivasop.=;
          |SI FSalida = 0;
             |SI #caenlace#27 = 0; #caenlace#27 = 1; |FINSI;
             |SI #caenlace#27 = 1; #caivasop#8  = #caivasop#8  + #caenlace#9; |FINSI;
             |SI #caenlace#27 = 2; #caivasop#9  = #caivasop#9  + #caenlace#9; |FINSI;
             |SI #caenlace#27 = 3; #caivasop#10 = #caivasop#10 + #caenlace#9; |FINSI;
             |SI #caenlace#27 = 4; #caivasop#52 = #caivasop#52 + #caenlace#9; |FINSI;
             |SI #caenlace#27 = 5; #caivasop#53 = #caivasop#53 + #caenlace#9; |FINSI;
          |FINSI;
          |HAZ RecalculaIva;
          |ATRI I;|PINTA 2207, "Actualizando bases del registro  ";|ATRI N;
          |GRABA 020#caivasop.a; |LIBERA #caivasop;
          |SI #caenlace#14 = 999;
              nSwPrim = 1;
              |HAZ CreoPagos;
          |FINSI;
       |FINSI;
    |FINSI;
    |SI #caenlace#26 = "D";
       |SI #caenlace#13 < 0; #caenlace#13 = NumAsiento; |FINSI;
       |SI #caenlace#10 = "R";
          #caivarep#0  = #caenlace#11;
          #caivarep#27 = #caenlace#12;
          #caivarep#2  = #caenlace#13;
          |LEE 101#caivarep.=;
          |SI FSalida = 0;
             |SI #caenlace#27 = 0; |O #caenlace#27 = 99; #caenlace#27 = 2; |FINSI;
             |SI #caenlace#27 = 1;
                #caivarep#8  = #caivarep#8 - #caenlace#9;
                #caivarep#11 = ((#caivarep#14 / #caivarep#8)  * 100) ! 0;  || Tipos de IVA
                #caivarep#17 = ((#caivarep#20 / #caivarep#8)  * 100);  || Tipos de REC
                |SI #caivarep#17 < .8; |Y #caivarep#17 > 0; #caivarep#17 = 0.5; |SINO; #caivarep#17 = #caivarep#17 ! 0; |FINSI;
             |FINSI;
            |SI #caivarep#59 < .8; |Y #caivarep#59 > 0; #caivarep#59 = 0.5; |SINO; #caivarep#59 = #caivarep#59 ! 0; |FINSI;
             |SI #caenlace#27 = 2;
                #caivarep#9  = #caivarep#9  - #caenlace#9;
                #caivarep#12 = ((#caivarep#15 / #caivarep#9)  * 100) ! 0;
                #caivarep#18 = ((#caivarep#21 / #caivarep#9)  * 100);
                |SI #caivarep#18 < .8; |Y #caivarep#18 > 0; #caivarep#18 = 0.5; |SINO; #caivarep#18 = #caivarep#18 ! 0; |FINSI;
             |FINSI;
             |SI #caenlace#27 = 3;
                #caivarep#10 = #caivarep#10 - #caenlace#9;
                #caivarep#13 = ((#caivarep#16 / #caivarep#10) * 100) ! 0;
                #caivarep#19 = ((#caivarep#22 / #caivarep#10) * 100);
                |SI #caivarep#19 < .8; |Y #caivarep#19 > 0; #caivarep#19 = 0.5; |SINO; #caivarep#19 = #caivarep#19 ! 0; |FINSI;
             |FINSI;
             |SI #caenlace#27 = 4;
                #caivarep#52 = #caivarep#52 - #caenlace#9;
                #caivarep#54 = ((#caivarep#56 / #caivarep#52) * 100) ! 0;
                #caivarep#58 = ((#caivarep#60 / #caivarep#52) * 100);
                |SI #caivarep#58 < .8; |Y #caivarep#58 > 0; #caivarep#58 = 0.5; |SINO; #caivarep#58 = #caivarep#58 ! 0; |FINSI;
             |FINSI;
             |SI #caenlace#27 = 5;
                #caivarep#53 = #caivarep#53 - #caenlace#9;
                #caivarep#55 = ((#caivarep#57 / #caivarep#53) * 100) ! 0;
                |SI #caivarep#59 < .8; |Y #caivarep#59 > 0; #caivarep#59 = 0.5; |SINO; #caivarep#59 = #caivarep#59 ! 0; |FINSI;
             |FINSI;
          |FINSI;
          |HAZ RecalculaIva;
          |GRABA 020#caivarep.a; |LIBERA #caivarep;
          |ATRI I;|PINTA 2207, "Actualizando bases del registro  ";|ATRI N;
       |FINSI;
       |SI #caenlace#10 = "S";
          #caivasop#0  = #caenlace#11;
          #caivasop#27 = #caenlace#12;
          #caivasop#2  = #caenlace#13;
          |LEE 101#caivasop.=;
          |SI FSalida = 0;
             |SI #caenlace#27 = 0; |O #caenlace#27 = 99; #caenlace#27 = 2; |FINSI;
             |SI #caenlace#27 = 1;
                #caivasop#8  = #caivasop#8 - #caenlace#9;
                #caivasop#11 = ((#caivasop#14 / #caivasop#8)  * 100) ! 0;  || Tipos de IVA
                #caivasop#17 = ((#caivasop#20 / #caivasop#8)  * 100);  || Tipos de REC
                |SI #caivasop#17 < .8; |Y #caivasop#17 > 0; #caivasop#17 = 0.5; |SINO; #caivasop#17 = #caivasop#17 ! 0; |FINSI;
             |FINSI;
            |SI #caivasop#59 < .8; |Y #caivasop#59 > 0; #caivasop#59 = 0.5; |SINO; #caivasop#59 = #caivasop#59 ! 0; |FINSI;
             |SI #caenlace#27 = 2;
                #caivasop#9  = #caivasop#9  - #caenlace#9;
                #caivasop#12 = ((#caivasop#15 / #caivasop#9)  * 100) ! 0;
                #caivasop#18 = ((#caivasop#21 / #caivasop#9)  * 100);
                |SI #caivasop#18 < .8; |Y #caivasop#18 > 0; #caivasop#18 = 0.5; |SINO; #caivasop#18 = #caivasop#18 ! 0; |FINSI;
             |FINSI;
             |SI #caenlace#27 = 3;
                #caivasop#10 = #caivasop#10 - #caenlace#9;
                #caivasop#13 = ((#caivasop#16 / #caivasop#10) * 100) ! 0;
                #caivasop#19 = ((#caivasop#22 / #caivasop#10) * 100);
                |SI #caivasop#19 < .8; |Y #caivasop#19 > 0; #caivasop#19 = 0.5; |SINO; #caivasop#19 = #caivasop#19 ! 0; |FINSI;
             |FINSI;
             |SI #caenlace#27 = 4;
                #caivasop#52 = #caivasop#52 - #caenlace#9;
                #caivasop#54 = ((#caivasop#56 / #caivasop#52) * 100) ! 0;
                #caivasop#58 = ((#caivasop#60 / #caivasop#52) * 100);
                |SI #caivasop#58 < .8; |Y #caivasop#58 > 0; #caivasop#58 = 0.5; |SINO; #caivasop#58 = #caivasop#58 ! 0; |FINSI;
             |FINSI;
             |SI #caenlace#27 = 5;
                #caivasop#53 = #caivasop#53 - #caenlace#9;
                #caivasop#55 = ((#caivasop#57 / #caivasop#53) * 100) ! 0;
                |SI #caivasop#59 < .8; |Y #caivasop#59 > 0; #caivasop#59 = 0.5; |SINO; #caivasop#59 = #caivasop#59 ! 0; |FINSI;
             |FINSI;
          |FINSI;
          |HAZ RecalculaIva;
          |ATRI I;|PINTA 2207, "Actualizando bases del registro  ";|ATRI N;
          |GRABA 020#caivasop.a; |LIBERA #caivasop;
          |SI #caenlace#14 = 999;
              nSwPrim = 1;
              |HAZ CreoPagos;
          |FINSI;
       |FINSI;
    |FINSI;
    |SI #caenlace#26 = "I";
       |SI #caenlace#13 < 0; #caenlace#13 = NumAsiento; |FINSI;
       |SI #caenlace#10 = "R";
          #caivarep#0  = #caenlace#11;
          #caivarep#27 = #caenlace#12;
          #caivarep#2  = #caenlace#13;
          |LEE 101#caivarep.=;
          |SI FSalida = 0;
             |SI #caenlace#27 ! 0;
                |SI #caenlace#27 = 1; Campo1 = 14; Campo2 = 11; Campo3 = 8;  |FINSI;
                |SI #caenlace#27 = 2; Campo1 = 15; Campo2 = 12; Campo3 = 9;  |FINSI;
                |SI #caenlace#27 = 3; Campo1 = 16; Campo2 = 13; Campo3 = 10; |FINSI;
                |SI #caenlace#27 = 4; Campo1 = 56; Campo2 = 54; Campo3 = 52; |FINSI;
                |SI #caenlace#27 = 5; Campo1 = 57; Campo2 = 55; Campo3 = 53; |FINSI;
                #caivarep#Campo1# = #caivarep#Campo1# + #caenlace#9;
                #caivarep#Campo2# = ((#caivarep#Campo1# / #caivarep#Campo3#)* 100) ! 0;
                |HAZ RecalculaIva;
                |ATRI I;|PINTA 2207, "Actualizando cuotas de iva       ";|ATRI N;
                |GRABA 020#caivarep.a; |LIBERA #caivarep;
             |FINSI;
          |FINSI;
       |FINSI;
       |SI #caenlace#10 = "S";
          #caivasop#0  = #caenlace#11;
          #caivasop#27 = #caenlace#12;
          #caivasop#2  = #caenlace#13;
          |LEE 101#caivasop.=;
          |SI FSalida = 0;
             |SI #caenlace#27 ! 0;
                |SI #caenlace#27 = 1; Campo1 = 14; Campo2 = 11; Campo3 = 8;  |FINSI;
                |SI #caenlace#27 = 2; Campo1 = 15; Campo2 = 12; Campo3 = 9;  |FINSI;
                |SI #caenlace#27 = 3; Campo1 = 16; Campo2 = 13; Campo3 = 10; |FINSI;
                |SI #caenlace#27 = 4; Campo1 = 56; Campo2 = 54; Campo3 = 52; |FINSI;
                |SI #caenlace#27 = 5; Campo1 = 57; Campo2 = 55; Campo3 = 53; |FINSI;
                #caivasop#Campo1# = #caivasop#Campo1# + #caenlace#9;
                #caivasop#Campo2# = ((#caivasop#Campo1# / #caivasop#Campo3#)* 100) ! 0;
                |HAZ RecalculaIva;
                |ATRI I;|PINTA 2207, "Actualizando cuotas de iva       ";|ATRI N;
                |GRABA 020#caivasop.a; |LIBERA #caivasop;
             |FINSI;
          |FINSI;
          |SI #caenlace#14 = 999;
              nSwPrim = 1;
              |HAZ CreoPagos;
          |FINSI;
       |FINSI;
    |FINSI;
    |SI #caenlace#26 = "R";
       |SI #caenlace#13 < 0; #caenlace#13 = NumAsiento; |FINSI;
       |SI #caenlace#10 = "R";
          #caivarep#0  = #caenlace#11;
          #caivarep#27 = #caenlace#12;
          #caivarep#2  = #caenlace#13;
          |LEE 101#caivarep.=;
          |SI FSalida = 0;
             |SI #caenlace#27 ! 0;
                |SI #caenlace#27 = 1; Campo1 = 20; Campo2 = 17; Campo3 = 8;  |FINSI;
                |SI #caenlace#27 = 2; Campo1 = 21; Campo2 = 18; Campo3 = 9;  |FINSI;
                |SI #caenlace#27 = 3; Campo1 = 22; Campo2 = 19; Campo3 = 10; |FINSI;
                |SI #caenlace#27 = 4; Campo1 = 60; Campo2 = 58; Campo3 = 52; |FINSI;
                |SI #caenlace#27 = 5; Campo1 = 61; Campo2 = 59; Campo3 = 53; |FINSI;
                #caivarep#Campo1# = #caivarep#Campo1# + #caenlace#9;

                #caivarep#Campo2# = (#caivarep#Campo1# / #caivarep#Campo3#)*100;
                |SI #caivarep#Campo2# ] 0.8;
                   #caivarep#Campo2# = #caivarep#Campo2# ! 0;
                |SINO;
                   #caivarep#Campo2# = #caivarep#Campo2# ! 1;
                   |SI #caivarep#Campo2# ! 0.5; #caivarep#Campo2# = 0.5; |FINSI;
                |FINSI;
                |HAZ RecalculaIva;
                |ATRI I;|PINTA 2207, "Actualizando cuotas de recargo   ";|ATRI N;
                |GRABA 020#caivarep.a; |LIBERA #caivarep;
             |FINSI;
          |FINSI;
       |FINSI;
       |SI #caenlace#10 = "S";
          #caivasop#0  = #caenlace#11;
          #caivasop#27 = #caenlace#12;
          #caivasop#2  = #caenlace#13;
          |LEE 101#caivasop.=;
          |SI FSalida = 0;
             |SI #caenlace#27 ! 0;
                |SI #caenlace#27 = 1; Campo1 = 20; Campo2 = 17; Campo3 = 8;  |FINSI;
                |SI #caenlace#27 = 2; Campo1 = 21; Campo2 = 18; Campo3 = 9;  |FINSI;
                |SI #caenlace#27 = 3; Campo1 = 22; Campo2 = 19; Campo3 = 10; |FINSI;
                |SI #caenlace#27 = 4; Campo1 = 60; Campo2 = 58; Campo3 = 52; |FINSI;
                |SI #caenlace#27 = 5; Campo1 = 61; Campo2 = 59; Campo3 = 53; |FINSI;
                #caivasop#Campo1# = #caivasop#Campo1# + #caenlace#9;
                #caivasop#Campo2# = ((#caivasop#Campo1# / #caivasop#Campo3#)* 100) ! 0;
                |HAZ RecalculaIva;
                |ATRI I;|PINTA 2207, "Actualizando cuotas de recargo   ";|ATRI N;
               |GRABA 020#caivasop.a; |LIBERA #caivasop;
            |FINSI;
         |FINSI;
         |SI #caenlace#14 = 999;
             nSwPrim = 1;
             |HAZ CreoPagos;
         |FINSI;
      |FINSI;
   |FINSI;
   |SI #caenlace#30 = "S";
      #caenlace#36 = FacContra;
      |SI #caenlace#10 = "S";
         aAlfa = "**"  + (("00" + #caenlace#34) % -102);
         aAlfa = aAlfa + #caenlace#35;
         aAlfa = aAlfa + (("000000" + #caenlace#36) % -106);
         #caivarep#0  = #caenlace#34;
         #caivarep#27 = #caenlace#35;
         #caivarep#2  = #caenlace#36;
         |LEE 101#caivarep.=;
         |SI FSalida ! 0;
            |DDEFECTO #caivarep;
            #caivarep#0  = #caenlace#34;
            #caivarep#27 = #caenlace#35;
            #caivarep#2  = #caenlace#36;
            |GRABA 020#caivarep.b;
         |FINSI;
         aAlfa = "|NC"; Calc = #caivarep#aAlfa#;
         Calc = Calc - 2;  || El fichero de iva repercutido tiene un campo mas que el de iva soportado
         |PARA nCont = 0; |SI nCont [ Calc; |HACIENDO nCont = nCont + 1;
            |SI nCont ! 0; |Y nCont ! 27; |Y nCont ! 2;
               #caivarep#nCont# = #caivasop#nCont#;
            |FINSI;
         |SIGUE;
         |GRABA 020#caivarep.a; |LIBERA #caivarep;
      |FINSI;
/*
      |SI #caenlace#10 = "R";
         #caivasop#0  = #caenlace#34;
         #caivasop#27 = #caenlace#35;
         #caivasop#2  = #caenlace#36;
         |LEE 101#caivasop.=;
         |SI FSalida ! 0;
            |DDEFECTO #caivasop;
            #caivasop#0  = #caenlace#34;
            #caivasop#27 = #caenlace#35;
            #caivasop#2  = #caenlace#36;
            |GRABA 020#caivasop.b;
         |FINSI;
         aAlfa = "|NC"; Calc = #caivasop#aAlfa#; Calc = Calc - 1;
         |PARA nCont = 0; |SI nCont [ Calc; |HACIENDO nCont = nCont + 1;
            |SI nCont ! 0; |Y nCont ! 27; |Y nCont ! 2;
               #caivasop#nCont# = #caivarep#nCont#;
            |FINSI;
         |SIGUE;
         |GRABA 020#caivasop.a; |LIBERA #caivasop;
      |FINSI;
*/
   |FINSI;
|FPRC;

|PROCESO BorraLinAsto;
 |SI enBuscaDoc = 1;
     nUltLinea = #camaasil#3;
 |SINO;
     |SI #camaasil#12 = "R";
         #caivarep#0  = #camaasil#13;
         #caivarep#27 = #camaasil#15;
         #caivarep#2  = #camaasil#14;
         |LEE 101#caivarep.=;
         |SI FSalida = 0;
            aAlfa = #caivarep#35; |QBF aAlfa;
            aAlfa1 = aAlfa % 0102;
            |SI aAlfa1 = "**";
               aAlfa1 = aAlfa % 0302; #caivasop#0  = aAlfa1; LibContra = #caivasop#0;
               aAlfa1 = aAlfa % 0502; #caivasop#27 = aAlfa1; SerContra = #caivasop#27;
               aAlfa1 = aAlfa % 0706; #caivasop#2  = aAlfa1; FacContra = #caivasop#2;
               |LEE 101#caivasop.=;
               |SI FSalida = 0;
                  |BORRA 020#caivasop.a; |LIBERA #caivasop;
               |FINSI;
            |FINSI;
            LibroAnt = #caivarep#0; SerieAnt = #caivarep#27;
            |BORRA 020#caivarep.a; |LIBERA #caivarep;
         |FINSI;
      |FINSI;

      |SI #camaasil#12 = "S";
         #caivasop#0  = #camaasil#13;
         #caivasop#27 = #camaasil#15;
         #caivasop#2  = #camaasil#14;
         |LEE 101#caivasop.=;
         |SI FSalida = 0;
            aAlfa = #caivasop#35; |QBF aAlfa;
            aAlfa1 = aAlfa % 0102;
            |SI aAlfa1 = "**";
               aAlfa1 = aAlfa % 0302; #caivarep#0  = aAlfa1; LibContra = #caivarep#0;
               aAlfa1 = aAlfa % 0502; #caivarep#27 = aAlfa1; SerContra = #caivarep#27;
               aAlfa1 = aAlfa % 0706; #caivarep#2  = aAlfa1; FacContra = #caivarep#2;
               |LEE 101#caivarep.=;
               |SI FSalida = 0;
                  |BORRA 020#caivarep.a; |LIBERA #caivarep;
               |FINSI;
            |FINSI;
            LibroAnt = #caivasop#0; SerieAnt = #caivasop#27;
            |BORRA 020#caivasop.a; |LIBERA #caivasop;
         |FINSI;
      |FINSI;

      |ATRI I;|PINTA 2207, "Borrando lineas de asientos      ";|ATRI N;
      Cuenta = #camaasil#4; nImporte = 0 - #camaasil#9; |HAZ Actualiza;
      |BORRA 020#camaasil.a;
 |FINSI;
 |LIBERA #camaasil;
|FPRC;

|DEFBUCLE BorraLinAsto;
#camaasil#1;
;
#camaasic#0,#camaasic#1,#camaasic#2,0001;
#camaasic#0,#camaasic#1,#camaasic#2,9999;
be;
NULL,BorraLinAsto;
|FIN;

|PROCESO BorraAsto;
   nNumAsto = #camaasic#3;
   |BUCLE BorraLinAsto;
   |SI enBuscaDoc = 0;
       |ATRI I;|PINTA 2207, "Borrando asientos                ";|ATRI N;
       |BORRA 020#camaasic.a;
       |LIBERA #camaasic;
       nEstadoCab = 1;
       nNumAsto = nDOCUMENTO;
   |FINSI;
|FPRC;

|PROCESO Asientos;
   aAlfa = #caenlace#18; |QBF aAlfa;
   |SI aAlfa = "S"; |LIBERA #caenlace; |ACABA; |FINSI;

   |LEE 101#dsapunte.p; #dsapunte#5 = Contador; |GRABA 020#dsapunte.a; |LIBERA #dsapunte;
   Contador = Contador + 1; |SI Contador > 99999999999; Contador = 0; |FINSI;

   |SI #caenlace#37 ! 0;
      |SI EmpAnt ! #caenlace#37; |O PerAnt ! #caenlace#38;
         Path = PARAMETRO;
         Path = Path - ",";
         |SI FSalida ! 0;
            nCalc = ((FSalida / 100) ! 0) + 99;
            Path = Path % nCalc;
         |FINSI;
         Comodin = Path % -107; Path = Path - Comodin;
         Path = Path + ((("00000" + #caenlace#37) % -105) + #caenlace#38) + "/";
         fich_alta = Path;
         |HAZ InitEmpresa;
         EmpAnt = #caenlace#37; PerAnt = #caenlace#38;
         EnDiario = 0; EnFecha = "01.01.0000"; EnAsto = 0;
      |FINSI;
   |FINSI;

   aAlfa = #caenlace#1; |QBF aAlfa;
   aAlfa = aAlfa % 0902; nCalc = aAlfa;
   |SI nCalc ! #canempre#26;
      |BORRA 020#caenlace.a; |LIBERA #caenlace; |ACABA;
   |FINSI;

   |SALVA_FICHA #caenlace;
   |SI EnDiario ! #caenlace#0; |O EnFecha ! #caenlace#1; |O EnAsto ! #caenlace#2;
      |SI LibroAnt ! #caenlace#11; |O SerieAnt ! #caenlace#12;
           LibContra = 0; SerContra = ""; FacContra = 0;
      |FINSI;

      nUltLinea = 0;
      #camaasic#0  = #caenlace#0;
      #camaasic#1  = #caenlace#1;
      #camaasic#2  = #caenlace#2; || nDOCUMENTO
      |LEE 101#camaasic.=;
      |SI FSalida = 0;
          nEstadoCab = 0;
          nDOCUMENTO = #camaasic#2;
          |HAZ BorraAsto;
      |SINO;
          nEstadoCab = 1;
          nDOCUMENTO = #caenlace#2;
          nNumAsto   = nDOCUMENTO;
      |FINSI;

      |SI #caenlace#25 = "S";
         |BORRA 020#caenlace.a; |REPON_FICHA #caenlace;
         |LIBERA #caenlace; |ACABA;
      |FINSI;
      |SI #caenlace#9 = 0; |Y #caenlace#26 ! "F";
         |BORRA 020#caenlace.a; |REPON_FICHA #caenlace;
         |LIBERA #caenlace; |ACABA;
      |FINSI;

      |SI nEstadoCab = 1;
          nEstadoCab = 0;
          |DDEFECTO #camaasic;
          #camaasic#0 = #caenlace#0;
          #camaasic#1 = #caenlace#1;
          #camaasic#2 = #caenlace#2;
          nDOCUMENTO  = #camaasic#2;
          #camaasic#3  = nNumAsto;
          |ATRI I;|PINTA 2207, "Grabando cabeceras de asientos   ";|ATRI N;
          |GRABA 020#camaasic.b;
      |FINSI;
   |FINSI;
   |LIBERA #camaasic;

   EnDiario = #caenlace#0;
   EnFecha  = #caenlace#1;
   EnAsto   = #caenlace#2;

   |SI #caenlace#9 = 0; |Y #caenlace#26 ! "F";
      |REPON_FICHA #caenlace; |LIBERA #caenlace; |ACABA;
   |FINSI;

   |DDEFECTO #camaasil;
   #camaasil#0 = #camaasic#0;
   #camaasil#1 = #camaasic#1;
   #camaasil#2 = #camaasic#2;
   #caenlace#2 = #camaasic#2;

   |SI nUltLinea = 0;
      #camaasil#3 = #caenlace#3;
   |SINO;
      nUltLinea = nUltLinea + 10;
      #camaasil#3 = nUltLinea;
   |FINSI;
   #camaasil#4 = #caenlace#4;
   #camaasil#5 = #caenlace#5;
   #camaasil#6 = #caenlace#6;
   #camaasil#7 = #caenlace#7;
   #camaasil#8 = #caenlace#8;
   #camaasil#9 = #caenlace#9;
   |SI #camaasil#8 = "D";
      #camaasil#10 = "";          #camaasil#11 = 0;
      #camaasil#16 = #camaasil#4; #camaasil#17 = #camaasil#5;
   |SINO;
      #camaasil#10 = #camaasil#4; #camaasil#11 = #camaasil#5;
      #camaasil#16 = "";          #camaasil#17 = 0;
   |FINSI;

   #camaasil#12 = #caenlace#10;
   #camaasil#13 = #caenlace#11;
   #camaasil#14 = #caenlace#13;
   #camaasil#15 = #caenlace#12;
   #camaasil#18 = " ";
   #camaasil#19 = #caenlace#26;
   #camaasil#20 = #caenlace#27;
   #camaasil#21 = #caenlace#15;
   #camaasil#22 = #caenlace#14;
   #camaasil#23 = "N";

   #caconcep#0 = #camaasil#6;
   |LEE 001#caconcep.=;
   |SI FSalida ! 0;
      |DDEFECTO #caconcep;
   |FINSI;
   #camaasil#24 = #caconcep#1;

   |ATRI I;|PINTA 2207, "Grabando lineas de asientos      ";|ATRI N;

   |GRABA 020#camaasil.c;

   |HAZ CreaRegistro;

   |SI #camaasil#12 ! " "; |Y #camaasil#14 < 0;
      #camaasil#14 = #caenlace#13; |GRABA 020#camaasil.a;
   |FINSI;
   |LIBERA #camaasil;

   #caenlace#20 = "S";
   |GRABA 020#caenlace.a;

   Cuenta = #camaasil#4;
   nImporte = #camaasil#9;
   |HAZ Actualiza;

   |REPON_FICHA #caenlace;
   |LIBERA #caenlace;
|FPRC;

|DEFBUCLE Asientos;
 #caenlace#1;
 20;
 00,"00.00.0000",000001,0000,00000,0,"N";
 99,"31.12.9999",999999,9999,99999,9,"N";
 be;
 NULL,Asientos;
|FIN;

|PROCESO Comprobar;
  |SI nComp1 = #caenlace#0;  |Y fComp2 = #caenlace#1;
   |Y nComp3 = #caenlace#2;  |Y nComp4 = #caenlace#37;
   |Y nComp5 = #caenlace#38;
     nBorra = 1;
     nMiraApunte = 0;
  |SINO;
     nComp1 = #caenlace#0; fComp2 = #caenlace#1;
     nComp3 = #caenlace#2; nComp4 = #caenlace#37;
     nComp5 = #caenlace#38;
     nMiraApunte = 1;
     nBorra = 0;
  |FINSI;

  |SI nMiraApunte = 1;
     |SALVA_FICHA #caenlace;
     #caenlace#3 = 9999;
     |LEE 000#caenlace.];
     |SI FSalida = 0; |Y nComp1 = #caenlace#0;  |Y fComp2 = #caenlace#1;
                      |Y nComp3 = #caenlace#2;  |Y nComp4 = #caenlace#37;
                      |Y nComp5 = #caenlace#38; |Y #caenlace#3 > 9999;
        nError = 9999;
        aAlfa2 = "El asiento " + (("00" + nComp1) % -102) + "/" + fComp2 + "/";
        aAlfa2 = aAlfa2 + (("00000" + nComp3) % -105) + "(Empresa ";
        aAlfa2 = aAlfa2 + (("00000" + nComp4) % -105) + " Periodo " + nComp5 + ")";
        aAlfa2 = aAlfa2 + " ha superado el limite de apuntes. Se omitira este asiento";
        aError = aAlfa2;
        |SI nContError < nTotalErr;
           InError = InError + 1; IaError = IaError + 1;
           nContError = nContError + 1;
        |FINSI;
        aAlfa2 = "En caso de seguir adelante con el enlace no se pasara este asiento ";
        aError = aAlfa2;
        |SI nContError < nTotalErr;
           InError = InError + 1; IaError = IaError + 1;
           nContError = nContError + 1;
        |FINSI;
        nBorra = 1;
     |SINO;
        nComp1 = 0; fComp2 = @; nComp3 = 0; nComp4 = 0; nComp5 = 0;
     |FINSI;
     |REPON_FICHA #caenlace;
  |FINSI;

  || Cuentas vacias
  aAlfa = #caenlace#4; |QBF aAlfa;
  |SI aAlfa = ""; |Y #caenlace#9 ! 0;
     nError = 1001; nAvisos = nAvisos + 1;
     aAlfa1 = #caenlace#3; |QBF aAlfa1;
     aAlfa2 = "La linea " + (("0000" + aAlfa1) % -104) + " del asiento ";
     aAlfa1 = #caenlace#0; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + (("00" + aAlfa1) % -102) + "/";
     aAlfa1 = #caenlace#1; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + aAlfa1 + "/";
     aAlfa1 = #caenlace#2; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + (("000000" + aAlfa1) % -106) + " tiene la cuenta en blanco";
     aError = aAlfa2;
     |SI nContError < nTotalErr;
        InError = InError + 1; IaError = IaError + 1;
        nContError = nContError + 1;
     |FINSI;
  |FINSI;

  || Cuentas fuera de nivel
  aLong = aAlfa % 0; nLong = aLong;
  |SI nLong ! Dig1; |Y nLong ! Dig2; |Y nLong ! Dig3; |Y nLong ! Dig4;
   |Y nLong ! Dig5; |Y nLong ! Dig6; |Y #caenlace#25 ! "S"; |Y #caenlace#9 ! 0;
     nError = 1002; nAvisos = nAvisos + 1;
     aAlfa1 = #caenlace#3; |QBF aAlfa1;
     aAlfa2 = "La linea " + (("0000" + aAlfa) % -104) + " del asiento ";
     aAlfa1 = #caenlace#0; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + (("00" + aAlfa1) % -102) + "/";
     aAlfa1 = #caenlace#1; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + aAlfa1 + "/";
     aAlfa1 = #caenlace#2; |QBF aAlfa1;
     aAlfa2 = aAlfa2 + (("000000" + aAlfa1) % -106) + " tiene una cuenta fuera de nivel";
     aError = aAlfa2;
     |SI nContError < nTotalErr;
        InError = InError + 1; IaError = IaError + 1;
        nContError = nContError + 1;
     |FINSI;
  |FINSI;

  nBorraAnt = nBorra;
  || Asiento descuadrado
  |SI nAntDia ! #caenlace#0; |O aAntFec ! #caenlace#1; |O nAntDoc ! #caenlace#2;
     nBorra = 0;
     |SI nAntDoc ] 0;
        |SI nTotalDoc ! 0;
           nError = 1004; nAvisos = nAvisos + 1;
           aAlfa1 = nAntDia; |QBF aAlfa1;
           aAlfa2 = "El asiento " + (("00" + aAlfa1) % -102) + "/";
           aAlfa1 = aAntFec; |QBF aAlfa1;
           aAlfa2 = aAlfa2 + aAlfa1 + "/";
           aAlfa1 = nAntDoc; |QBF aAlfa1;
           aAlfa2 = aAlfa2 + (("000000" + aAlfa1) % -106) + " esta descuadrado";
           aError = aAlfa2;
           |SI nContError < nTotalErr;
              InError = InError + 1; IaError = IaError + 1;
              nContError = nContError + 1;
           |FINSI;
        |FINSI;
     |FINSI;

     |SALVA_FICHA #canempre;
     #canempre#2 = #caenlace#37;
     #canempre#3 = #caenlace#38;
     |LEE 000#canempre.=;
     |SI FSalida ! 0;
        nEjer = -1;
     |SINO;
        nEjer = #canempre#26;
     |FINSI;
     |REPON_FICHA #canempre;

     || Fecha del asiento fuera del periodo
     aAlfa = #caenlace#1; |QBF aAlfa;
     aAlfa = aAlfa % 0902; nCalc = aAlfa;
     |SI nCalc ! #canempre#26;
        nError = 1005; nAvisos = nAvisos + 1;
        aAlfa1 = #caenlace#0; |QBF aAlfa1;
        aAlfa2 = "El asiento " + (("00" + aAlfa1) % -102) + "/";
        aAlfa1 = #caenlace#1; |QBF aAlfa1;
        aAlfa2 = aAlfa2 + aAlfa1 + "/";
        aAlfa1 = #caenlace#2; |QBF aAlfa1;
        aAlfa2 = aAlfa2 + (("000000" + aAlfa1) % -106) + " esta fuera del ejercicio de esta empresa";
        aError = aAlfa2;
        |SI nContError < nTotalErr;
           InError = InError + 1; IaError = IaError + 1;
           nContError = nContError + 1;
        |FINSI;
        nError = 9999;
        |SI nCalc ! nEjer;
           aAlfa2 = "En caso de seguir adelante con el enlace no se pasara este asiento ";
           aError = aAlfa2;
           |SI nContError < nTotalErr;
              InError = InError + 1; IaError = IaError + 1;
              nContError = nContError + 1;
           |FINSI;
           nBorra = 1;
        |SINO;
           |SI #caenlace#37 ! #canempre#2; |O #caenlace#38 ! #canempre#3;
               |CIERRA #camaasic;
               |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #caenlace#37) % -105) + #caenlace#38) + "/";
               |PATH_DAT #3 aAlfa; |ABRE #camaasic;
               |DDEFECTO #camaasic;
               #camaasic#0 = 99;
               #camaasic#1 = "01.01.0000";
               |LEE 000#camaasic.];
               |SI FSalida = 0; |Y #camaasic#0 = 99;
                  aAlfa2 = "La empresa del ejercicio indicado esta cerrado. Se omitira este asiento";
                  aError = aAlfa2;
                  nBorra = 1;
               |SINO;
                  aAlfa2 = "El asiento se ubicara en la empresa " + (("00000" + #caenlace#37) % -105);
                  aAlfa2 = aAlfa2 + " periodo " + #caenlace#38;
                  aError = aAlfa2;
               |FINSI;
               |CIERRA #camaasic;
               |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #canempre#2) % -105) + #canempre#3) + "/";
               |PATH_DAT #3 aAlfa; |ABRE #camaasic;
           |FINSI;
           |SI nContError < nTotalErr;
              InError = InError + 1; IaError = IaError + 1;
              nContError = nContError + 1;
           |FINSI;
           |SI nEjer ] 80;
              aAlfa2 = aAlfa2 + " del ao 19" + nEjer;
           |SINO;
              |SI nEjer < 10;
                 aAlfa2 = aAlfa2 + " del ao 200" + nEjer;
              |SINO;
                 aAlfa2 = aAlfa2 + " del ao 20" + nEjer;
              |FINSI;
           |FINSI;
        |FINSI;
     |SINO;
        |CIERRA #camaasic;
        |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #caenlace#37) % -105) + #caenlace#38) + "/";
        |PATH_DAT #3 aAlfa; |ABRE #camaasic;
        |DDEFECTO #camaasic;
        #camaasic#0 = 99;
        #camaasic#1 = "01.01.0000";
        |LEE 000#camaasic.];
        |SI FSalida = 0; |Y #camaasic#0 = 99;
           aAlfa2 = "La empresa del ejercicio indicado esta cerrado. Se omitira este asiento";
           aError = aAlfa2;
           nBorra = 1;
        |SINO;
           aAlfa2 = "El asiento se ubicara en la empresa " + (("00000" + #caenlace#37) % -105);
           aAlfa2 = aAlfa2 + " periodo " + #caenlace#38;
           aError = aAlfa2;
        |FINSI;
        |CIERRA #camaasic;
        |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + ((("00000" + #canempre#2) % -105) + #canempre#3) + "/";
        |PATH_DAT #3 aAlfa; |ABRE #camaasic;
     |FINSI;
     nTotalDoc = 0;
     nAntDia = #caenlace#0; aAntFec = #caenlace#1; nAntDoc = #caenlace#2;
  |FINSI;
  |SI nBorra = 0; |Y nBorraAnt = 1; nBorra = 1; |FINSI;

  |SI nBorra = 1;
     #caenlace#18 = "S"; |GRABA 020#caenlace.a;
     ||BORRA 020#caenlace.a;
  |FINSI;

  |SI #caenlace#8 = "D";
     nTotalDoc = nTotalDoc + #caenlace#9;
  |SINO;
     nTotalDoc = nTotalDoc - #caenlace#9;
  |FINSI;
  nTotalDoc = nTotalDoc ! 2;
|FPRC;

|DEFBUCLE Comprobar;
#caenlace#1;
20;
00,"00.00.0000",000001,0000,00000,0,"N";
99,"31.12.9999",999999,9999,99999,9,"N";
;
NULL,Comprobar;
|FIN;

|PROCESO RevisaCtraps;
   #calicont#0 = #camaasil#0;
   #calicont#1 = #camaasil#1;
   #calicont#2 = #camaasil#2;
   #calicont#3 = #camaasil#3;
   |LEE 101#calicont.=;
   |SI FSalida ! 0;
      |DDEFECTO #calicont;
      #calicont#0 = #camaasil#0;
      #calicont#1 = #camaasil#1;
      #calicont#2 = #camaasil#2;
      #calicont#3 = #camaasil#3;
      |GRABA 020#calicont.b;
   |FINSI;
   |SI #camaasil#8 = "D";
      #calicont#4 = #camaasic#10;
      #calicont#5 = #camaasic#11;
   |SINO;
      #calicont#4 = #camaasic#8;
      #calicont#5 = #camaasic#9;
   |FINSI;
   |GRABA 020#calicont.a; |LIBERA #calicont;
|FPRC;

|DEFBUCLE RevisaCtraps;
#camaasil#1;
;
#camaasic#0, #camaasic#1, #camaasic#2, 0001;
#camaasic#0, #camaasic#1, #camaasic#2, 9999;
be;
NULL,RevisaCtraps;
|FIN;

|PROCESO Actualiza;
   || Actualiza la cabecera del asiento

   #camaasic#0 = #camaasil#0;
   #camaasic#1 = #camaasil#1;
   #camaasic#2 = #camaasil#2;
   |LEE 101#camaasic.=;
   |SI FSalida ! 0;
       |DDEFECTO #camaasic;
       #camaasic#0 = #camaasil#0;
       #camaasic#1 = #camaasil#1;
       #camaasic#2 = #camaasil#2;
       #camaasic#3 = nNumAsto;
       |GRABA 020#camaasic.b;
       nSwCtrapD = 0; nSwCtrapH = 0;
   |FINSI;

   |SI #camaasil#8 = "D";
       #camaasic#4 = #camaasic#4 + nImporte;
       |SI #camaasic#8 = "            "; |Y nSwCtrapH = 0;
           #camaasic#8 = #camaasil#4; #camaasic#9 = #camaasil#5;
           nSwCtrapH = 1;
       |SINO;
           #camaasic#8 = ""; #camaasic#9 = 0;
       |FINSI;
   |SINO;
       #camaasic#5 = #camaasic#5 + nImporte;
       |SI #camaasic#10 = "            "; |Y nSwCtrapD = 0;
           #camaasic#10 = #camaasil#4; #camaasic#11 = #camaasil#5;
           nSwCtrapD = 1;
       |SINO;
           #camaasic#10 = ""; #camaasic#11 = 0;
       |FINSI;
   |FINSI;
   #camaasic#6 = #camaasic#4 - #camaasic#5;

   |GRABA 020#camaasic.a; |LIBERA #camaasic;
   |SALVA_FICHA #camaasil; |BUCLE RevisaCtraps; |REPON_FICHA #camaasil;

   || Actualiza el diario
   #camandia#0 = #camaasic#0;
   |LEE 101#camandia.=;
   |SI FSalida ! 0;
      |DDEFECTO #camandia;
      #camandia#0 = #camaasic#0;
      Comodin = ("00" + #camaasic#0) % -102; Comodin = "DIARIO " + Comodin;
      #camandia#1 = Comodin;
      |GRABA 020#camandia.b;
   |FINSI;

   |SI #camaasil#8 = "D";
      #camandia#2 = #camandia#2 + nImporte;
   |SINO;
      #camandia#3 = #camandia#3 + nImporte;
   |FINSI;
   |GRABA 020#camandia.a;
   |LIBERA #camandia;

   || Actualiza la cuenta del apunte
   Cuenta = #camaasil#4; |HAZ SacaNivel;
   |SI Nivel = 0; |Y SwAviso = 0;
      Comodin = #camaasil#4; |QBF Comodin;
      Comodin = "    La cuenta " + Comodin + " no tiene longitud correcta";
      |MENAV Comodin;
      SwAviso = 1;
   |FINSI;
   Comodin = Cuenta; |QBF Comodin;
   |SI Comodin = ""; |Y ErrorDoc ! #caenlace#2;
      Comodin = "    El asiento " + (("00"+#caenlace#0)%-102) + "/";
      Comodin = Comodin + #caenlace#1 + "/";
      Comodin = Comodin + (("000000"+#caenlace#2)%-106) + "/";
      Comodin = Comodin + " tiene apuntes sin cuenta asignada";
      |MENAV Comodin;
      ErrorDoc = #caenlace#2;
   |FINSI;

   Cuenta1 = Cuenta; |HAZ ActCuenta;

   || Actualiza los niveles superiores
   Nivel = Nivel - 1;
   |PARA; |SI Nivel > 0; |HACIENDO Nivel = Nivel - 1;
          |SI Nivel = 1; Calc = Dig1; |FINSI;
          |SI Nivel = 2; Calc = Dig2; |FINSI;
          |SI Nivel = 3; Calc = Dig3; |FINSI;
          |SI Nivel = 4; Calc = Dig4; |FINSI;
          |SI Nivel = 5; Calc = Dig5; |FINSI;
          |SI Nivel = 6; Calc = Dig6; |FINSI;
          Calc = Calc + 100;
          Comodin = Cuenta1; |QBF Comodin;
          Cuenta = Comodin % Calc; |HAZ ActCuenta;
   |SIGUE;
|FPRC;

|PROCESO SacaNivel;
   Comodin = Cuenta; |QBF Comodin;
   aLong = Comodin % 0; nLong = aLong;
   Nivel = 0;
   |SI nLong > 0;
      |SI nLong = Dig1; Nivel = 1; |FINSI;
      |SI nLong = Dig2; Nivel = 2; |FINSI;
      |SI nLong = Dig3; Nivel = 3; |FINSI;
      |SI nLong = Dig4; Nivel = 4; |FINSI;
      |SI nLong = Dig5; Nivel = 5; |FINSI;
      |SI nLong = Dig6; Nivel = 6; |FINSI;
   |FINSI;
|FPRC;

|PROCESO ActCuenta;
   #cacuenta#0 = Cuenta; |HAZ SacaNivel;
   #cacuenta#1 = Nivel;
   |LEE 101#cacuenta.=;
   |SI FSalida ! 0;
      |ABRE #cacuebal;
      |DDEFECTO #cacuenta;
      |PARA nCont = 6; |SI nCont ] 1; |HACIENDO nCont = nCont - 1;
         Calc = 13 + nCont; Calc = 100 + #canempre#Calc#;
         Comodin = Cuenta % Calc;
         #cacuebal#0 = Comodin
         |LEE 000#cacuebal.=;
         |SI FSalida = 0;
            #cacuenta#4 = #cacuebal#1;
            #cacuenta#5 = #cacuebal#2;
            #cacuenta#6 = #cacuebal#3;
            #cacuenta#7 = #cacuebal#4;
            #cacuenta#8 = #cacuebal#5;
            |SAL;
         |FINSI;
      |SIGUE;
      |CIERRA #cacuebal;

      #cacuenta#0 = Cuenta;
      #cacuenta#1 = Nivel;
      |SI Nivel = #canempre#13;
         #cacuenta#3 = "S";
      |SINO;
         #cacuenta#3 = "N";
      |FINSI;
      |GRABA 020#cacuenta.b;
      |PUSHV 0501 2380;
      |PINPA #0#cacuenta; |PINDA #0#cacuenta;
      |ENDATOS #1#cacuenta;
      |SI FSalida ! 0;
         |POPV; |BORRA 020#cacuenta.a; |LIBERA #cacuenta; |ACABA;
      |SINO;
         |POPV;
      |FINSI;
   |FINSI;

   Comodin = #camaasil#1; |QBF Comodin;
   Comodin = Comodin % 0402; ComodNum = Comodin;
   CmpDebe = (ComodNum * 3) + 9;
   CmpHaber = CmpDebe + 1;
   CmpSaldo = CmpDebe + 2;
   |SI #camaasil#8 = "D";
      #cacuenta#CmpDebe# = #cacuenta#CmpDebe# + nImporte;
   |SINO;
      #cacuenta#CmpHaber# = #cacuenta#CmpHaber# + nImporte;
   |FINSI;
   #cacuenta#CmpSaldo# = #cacuenta#CmpDebe# - #cacuenta#CmpHaber#;

   CmpDebe = 0; CmpHaber = 0; CmpSaldo = 0;
   TotDebe = 0; TotHaber = 0; TotSaldo = 0;
   |PARA Cont = 12; |SI Cont [ 45; |HACIENDO Cont = Cont + 3;
        CmpDebe = Cont; CmpHaber = Cont + 1; CmpSaldo = Cont + 2;
        TotDebe  = TotDebe  + #cacuenta#CmpDebe#;
        TotHaber = TotHaber + #cacuenta#CmpHaber#;
        TotSaldo = TotSaldo + #cacuenta#CmpSaldo#;
   |SIGUE;

   #cacuenta#51 = #cacuenta#9 + TotDebe;
   #cacuenta#52 = #cacuenta#10 + TotHaber;
   #cacuenta#53 = #cacuenta#11 + TotSaldo;
   |SI #camaasic#1 > #cacuenta#58; #cacuenta#58 = #camaasic#1; |FINSI;

   |GRABA 020#cacuenta.a; |LIBERA #cacuenta;
|FPRC;

|PROCESO InitEmpresa;

   |CIERRA #calicont; |CIERRA #caclipro; |CIERRA #caivasop;
   |CIERRA #caivarep; |CIERRA #canempre; |CIERRA #camandia;
   |CIERRA #cacuenta; |CIERRA #camaasil; |CIERRA #camaasic;

   |PATH_DAT #3  Path;  |PATH_DAT #4  Path;
   |PATH_DAT #5  Path;  |PATH_DAT #6  Path;  |PATH_DAT #7  Path;
   |PATH_DAT #8  Path;  |PATH_DAT #9  Path;  |PATH_DAT #10 Path;
   |PATH_DAT #11 Path;  |PATH_DAT #12 Path;  |PATH_DAT #13 Path;
   |PATH_DAT #14 Path;  |PATH_DAT #15 Path;  |PATH_DAT #16 Path;
   |PATH_DAT #17 Path;  |PATH_DAT #18 Path;  |PATH_DAT #19 Path;
   |PATH_DAT #31 Path;  |PATH_DAT #32 Path;  |PATH_DAT #33 Path;

   |HAZ inicio;

   |ABRE #calicont; |ABRE #caclipro; |ABRE #caivasop;
   |ABRE #caivarep; |ABRE #canempre; |ABRE #camandia;
   |ABRE #cacuenta; |ABRE #camaasil; |ABRE #camaasic;

   Comodin = Path; |QBF Comodin;
   Comodin = Comodin % -107; Comodin = Comodin - "/";
   Comodin1 = Comodin % 0105; #canempre#2 = Comodin1;
   Comodin1 = Comodin % -101; #canempre#3 = Comodin1;
   |LEE 000#canempre.=;
   |SI FSalida = 0;
      Dig1 = #canempre#14; Dig2 = #canempre#15; Dig3 = #canempre#16;
      Dig4 = #canempre#17; Dig5 = #canempre#18; Dig6 = #canempre#19;
   |SINO;
      nCriticos = nCriticos + 1;
      nError = 1; aError = "La empresa contable " + (("00000" + #canempre#2) % -105) + "/" + #canempre#3 + " no existe";
      |SI nContError < nTotalErr;
         InError = InError + 1; IaError = IaError + 1;
         nContError = nContError + 1;
      |FINSI;
   |FINSI;

   |DDEFECTO #camaasic;
   #camaasic#0 = 99;
   #camaasic#1 = "01.01.0000";
   #camaasic#2 = 0;
   |LEE 000#camaasic.]
   |SI FSalida = 0; |Y #camaasic#0 = 99;
      nCriticos = nCriticos + 1;
      nError = 2;
      aAlfa = "La empresa contable " + (("00000" + #canempre#2) % -105) + "/" + #canempre#3 + " esta cerrada";
      aError = aAlfa;
      |SI nContError < nTotalErr;
         InError = InError + 1;
         nContError = nContError + 1;
      |FINSI;
   |FINSI;
|FPRC;

|PROGRAMA;

   |SI PRMNT_enVer ! 2; |Y PRMNT_enVer ! 0;
      |MENAV "    Error. Necesita actualizar la version del programa que enlaza";
      |MENAV "    No se efectuara el enlace";
      PRMNT_enError = -1; |ERROR; |ACABA;
   |FINSI;

   SwAviso = 0;
   Path = PARAMETRO;
   Path = Path - ",";
   |SI FSalida ! 0;
      Calc = FSalida + 98;
      aNombre = Path % Calc; Path = Path - aNombre;
   |FINSI;
   |PATH_DAT #0  Path; |ABRET #dsapunte;

   Respuesta = "";
   |PARA; |SI; |HACIENDO;
      |LEE 000#dsapunte.p;
      |SI FSalida ! 0;
         |SI FSalida = 102; |SAL; |FINSI;
         |DDEFECTO #dsapunte;
         |GRABA 020#dsapunte.n;
         |LEE 000#dsapunte.p;
      |FINSI;
      |SI #dsapunte#1 = "N";
          |LEE 101#dsapunte.p;
          |SI FSalida = 0;
              #dsapunte#1 = "S";
              #dsapunte#2 = ~;
              |HORA Comodin; Comodin = Comodin % 0105; #dsapunte#3 = Comodin;
              Comodin = Usuario % 0810; #dsapunte#4 = Comodin;
              |GRABA 020#dsapunte.a; |LIBERA #dsapunte;
              |ATRI N;|PINTA 2307,"                                      "; |ATRI N;
              |SAL;
         |FINSI;
      |SINO;
         FechaHoy = ~;  FechaEnl = #dsapunte#2;
         |HORA Comodin;
         Comodin1 = Comodin % 0102; Hora        = Comodin1;
         Comodin1 = Comodin % 0402; Minutos     = Comodin1;
         Comodin1 = Comodin % 0702; Segundos    = Comodin1;
         |SI HoraEnl = 0; |Y MinutosEnl = 0; |Y SegundosEnl = 0;
            |HORA Comodin; |QBF Comodin;
            Comodin1 = Comodin % 0102; HoraEnl     = Comodin1;
            Comodin1 = Comodin % 0402; MinutosEnl  = Comodin1;
            Comodin1 = Comodin % 0702; SegundosEnl = Comodin1;
            SegundosEnl = SegundosEnl + 30;
            |SI SegundosEnl ] 60;
               MinutosEnl = MinutosEnl + 1; SegundosEnl = SegundosEnl - 60;
               |SI MinutosEnl ] 60;
                  HoraEnl = HoraEnl + 1; MinutosEnl = MinutosEnl - 60;
               |FINSI;
            |FINSI;
         |SINO;
            |SI Cambiante ! #dsapunte#5;
                Cambiante = #dsapunte#5;
                |HORA Comodin; |QBF Comodin;
                Comodin1 = Comodin % 0102; HoraEnl     = Comodin1;
                Comodin1 = Comodin % 0402; MinutosEnl  = Comodin1;
                Comodin1 = Comodin % 0702; SegundosEnl = Comodin1;
                SegundosEnl = SegundosEnl + 30;
                |SI SegundosEnl ] 60;
                   MinutosEnl = MinutosEnl + 1; SegundosEnl = SegundosEnl - 60;
                   |SI MinutosEnl ] 60;
                      HoraEnl = HoraEnl + 1; MinutosEnl = MinutosEnl - 60;
                  |FINSI;
                |FINSI;
            |SINO;
               Comodin  = (("00" + Hora)    % -102) + (("00" + Minutos)    % -102) + (("00" + Segundos)    % -102);
               Comodin1 = (("00" + HoraEnl) % -102) + (("00" + MinutosEnl) % -102) + (("00" + SegundosEnl) % -102);
               |SI FechaHoy = FechaEnl; |Y Comodin1 ] Comodin;
                  |ATRI I; |PINTA 2307, "Enlace Bloqueado, Espere por favor .. "; |ATRI N;
               |SINO;
                  |SI Respuesta = "";
                     |PUSHV 0501 2380; |BLANCO 1010 1870; |CUADRO 1010 1870;
                     |PINTA 1112, "Hay un enlace activo que parece bloqueado.";
                     Comodin = "Fecha comienzo enlace : " + #dsapunte#2 + "   Hora comienzo : " + #dsapunte#3;
                     |PINTA 1212, Comodin;
                     Comodin = "Usuario que lanzo el enlace : " + #dsapunte#4;
                     |PINTA 1312, Comodin;
                     Comodin = " Desea anularlo ? (SI/NO) : ";
                     |PINTA 1513, Comodin;
                     E_sup = 2; E_inf = "SINO";
                     Respuesta = "NO";
                     Respuesta = 1541 ? 0;
                     |SI Respuesta = "SI";
                        #dsapunte#1 = "S";
                        #dsapunte#2 = ~;
                        |HORA Comodin; Comodin = Comodin % 0105;
                        #dsapunte#3 = Comodin;
                        |GRABA 020#dsapunte.a; |LIBERA #dsapunte;
                        |ATRI N;|PINTA 2307,"                                      "; |ATRI N;
                        |SAL;
                     |SINO;
                        Respuesta = "";
                     |FINSI;
                     |POPV;
                  |SINO;
                     |ATRI I; |PINTA 2307, "Enlace Bloqueado, Espere por favor .. "; |ATRI N;
                  |FINSI;
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
   |SIGUE;

   |PATH_DAT #1  Path;
   |PATH_DAT #3  Path;
   |PATH_DAT #4  Path;
   |PATH_DAT #5  Path;
   |PATH_DAT #6  Path;
   |PATH_DAT #7  Path;
   |PATH_DAT #8  Path;
   |PATH_DAT #9  Path;
   |PATH_DAT #10  Path;
   |PATH_DAT #11  Path;
   |PATH_DAT #12  Path;
   |PATH_DAT #13  Path;
   |PATH_DAT #14  Path;
   |PATH_DAT #15  Path;
   |PATH_DAT #16  Path;
   |PATH_DAT #17  Path;
   |PATH_DAT #18  Path;
   |PATH_DAT #19  Path;
   |PATH_DAT #31  Path;
   |PATH_DAT #32  Path;
   |PATH_DAT #33  Path;

   Comodin = Path % -107;
   Path = Path - Comodin;
   |PATH_DAT #30 Path;
   Path = PARAMETRO; Path = Path - ","; Path = Path - aNombre;

   |HAZ inicio;
   |SI aNombre ! ""; |NOME_DAT #1 aNombre; |FINSI;
   |ABRE #caenlace;
   |ABRE #calicont;
   |ABRE #camaasic;
   |ABRE #camaasil;
   |ABRE #cacuenta;
   |ABRE #camandia;
   |ABRE #canempre;
   |ABRE #caivarep;
   |ABRE #caivasop;
   |ABRE #camanpag;
   |ABRE #caconcep;

   nContError = 0; nTotalErr = 499;

   |DDEFECTO #camaasic;
   #camaasic#0 = 99;
   #camaasic#1 = "01.01.0000";
   #camaasic#2 = 0;
   |LEE 000#camaasic.]
   |SI FSalida = 0; |Y #camaasic#0 = 99;
      nCriticos = nCriticos + 1;
      nError = 2;
      aAlfa = "La empresa contable " + (("00000" + #canempre#2) % -105) + "/" + #canempre#3 + " esta cerrada";
      aError = aAlfa;
      |SI nContError < nTotalErr;
         InError = InError + 1; IaError = IaError + 1;
         nContError = nContError + 1;
      |FINSI;
   |FINSI;

   Comodin = PARAMETRO; |QBF Comodin;
   |SI aNombre ! ""; Comodin = Comodin - ","; Comodin = Comodin - aNombre; |FINSI;
   Comodin = Comodin % -107;
   Comodin = Comodin - "/";
   Comodin1 = Comodin % 0105; #canempre#2 = Comodin1;
   Comodin1 = Comodin % -101; #canempre#3 = Comodin1;
   |LEE 000#canempre.=;
   |SI FSalida = 0;
      Dig1 = #canempre#14; Dig2 = #canempre#15; Dig3 = #canempre#16;
      Dig4 = #canempre#17; Dig5 = #canempre#18; Dig6 = #canempre#19;
      MaxNiv = #canempre#13;
   |SINO;
      nCriticos = nCriticos + 1;
      nError = 1; aError = "La empresa contable " + (("00000" + #canempre#2) % -105) + "/" + #canempre#3 + " no existe";
      |SI nContError < nTotalErr;
         InError = InError + 1; IaError = IaError + 1;
         nContError = nContError + 1;
      |FINSI;
   |FINSI;

   Contador = 0;
   PRMNT_enError = 0;

   |VERSIONRTME aAlfa;
   aAlfa1 = aAlfa - "9.10";
   |SI FSalida ! 0;
      aAlfa = aAlfa1 % 101;
      |SI aAlfa < "T";
         PRMNT_enError = 1;
      |FINSI;
   |SINO;
      PRMNT_enError = 1;
   |FINSI;
/*
   |VERSIONRTME aAlfa;
   aAlfa1 = aAlfa - "9.10";
   |SI FSalida ! 0;
      aAlfa = aAlfa1 % -101;
      |SI aAlfa < "T";
         PRMNT_enError = 1;
      |FINSI;
   |SINO;
      PRMNT_enError = 1;
   |FINSI;
*/
   |SI PRMNT_enError = 0;
      nAntDia = 0; aAntFec = "01.01.0000"; nAntDoc = -1;
      |BUCLE Comprobar;
      |SI nTotalDoc ! 0;
         nError = 1004; nAvisos = nAvisos + 1;
         aAlfa1 = nAntDia; |QBF aAlfa1;
         aAlfa2 = "El asiento " + (("00" + aAlfa1) % -102) + "/";
         aAlfa1 = aAntFec; |QBF aAlfa1;
         aAlfa2 = aAlfa2 + aAlfa1 + "/";
         aAlfa1 = nAntDoc; |QBF aAlfa1;
         aAlfa2 = aAlfa2 + (("000000" + aAlfa1) % -106) + " esta descuadrado";
         aError = aAlfa2;
         |SI nContError < nTotalErr;
            InError = InError + 1; IaError = IaError + 1;
            nContError = nContError + 1;
         |FINSI;
      |FINSI;

      |SI nCriticos > 0;
         |CONFI "    NSe han encontrado errores criticos. Imprimirlos ?";
         |SI FSalida = 0;
            |IMPRE 0;
            |SI FSalida ! 0; |VETE Final; |FINSI;
            || Imprime el informe
            aMensaje = " " + ("*" * 78); |IMPRIME aMensaje;
            aMensaje = "                    ERRORES ENCONTRADOS EN EL ENLACE                    ";
            |IMPRIME aMensaje;
            aMensaje = " " + ("*" * 78); |IMPRIME aMensaje;
            aMensaje = ""; |IMPRIME aMensaje;
            |SI nAvisos > 0;
               aMensaje = "      Errores de aviso "; |IMPRIME aMensaje;
               aMensaje = "      ---------------- "; |IMPRIME aMensaje;
               InError = nError1<-; IaError = aError1<-;
               |PARA nContError = 0; |SI nContError < nTotalErr; |HACIENDO;
                  |SI nError = 0; |SAL; |FINSI;
                  |SI nError ] 1000;
                     |SI nError ! 9999;
                         aMensaje = "        " + (("00000" + nError) % -105);
                     |SINO;
                         aMensaje = "             ";
                     |FINSI;
                     aMensaje = aMensaje + " " + aError; |QBF aMensaje;
                     |IMPRIME aMensaje;
                  |FINSI;
                  InError = InError + 1; IaError = IaError + 1;
               |SIGUE;
               aMensaje = ""; |IMPRIME aMensaje;
            |FINSI;
            aMensaje = "      Errores criticos "; |IMPRIME aMensaje;
            aMensaje = "      ---------------- "; |IMPRIME aMensaje;
            InError = nError1<-; IaError = aError1<-;
            |PARA nContError = 0; |SI nContError < nTotalErr; |HACIENDO;
               |SI nError = 0; |SAL; |FINSI;
               |SI nError < 1000;
                  aMensaje = "        " + (("00000" + nError) % -105) + " " + aError; |QBF aMensaje;
                  |IMPRIME aMensaje;
               |FINSI;
               InError = InError + 1; IaError = IaError + 1;
            |SIGUE;
            |FINIMP;
         |FINSI;
         PRMNT_enError = -1;
         |MENAV "    No se efectuara el enlace"; |VETE Final;
      |SINO;
         |SI nAvisos > 0;
            |CONFI "    NImprimir los errores de aviso encontrados ?";
            |SI FSalida = 0;
               |IMPRE 0;
               |SI FSalida ! 0; |VETE Final; |FINSI;
               || Imprime el informe
               aMensaje = " " + ("*" * 78); |IMPRIME aMensaje;
               aMensaje = "                    ERRORES ENCONTRADOS EN EL ENLACE                    ";
               |IMPRIME aMensaje;
               aMensaje = " " + ("*" * 78); |IMPRIME aMensaje;
               aMensaje = ""; |IMPRIME aMensaje;
               aMensaje = "      Errores de aviso "; |IMPRIME aMensaje;
               aMensaje = "      ---------------- "; |IMPRIME aMensaje;
               InError = nError1<-; IaError = aError1<-;
               |PARA nContError = 0; |SI nContError < nTotalErr; |HACIENDO;
                  |SI nError = 0; |SAL; |FINSI;
                  |SI nError ! 9999;
                      aMensaje = "        " + (("00000" + nError) % -105);
                  |SINO;
                      aMensaje = "             ";
                  |FINSI;
                  aMensaje = aMensaje + " " + aError; |QBF aMensaje;
                  |IMPRIME aMensaje;
                  InError = InError + 1; IaError = IaError + 1;
               |SIGUE;
               |FINIMP;
            |FINSI;
            |CONFI "    NContinuar con el enlace ?";
            |SI FSalida ! 0;
               PRMNT_enError = -2; |VETE Final;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;

   |BUCLE Asientos;

|ET Final;
   |CIERRA #caconcep;
   |CIERRA #camanpag;
   |CIERRA #caivasop;
   |CIERRA #caivarep;
   |CIERRA #canempre;
   |CIERRA #camandia;
   |CIERRA #cacuenta;
   |CIERRA #camaasil;
   |CIERRA #camaasic;
   |CIERRA #caenlace;
   |CIERRA #calicont;

   |LEE 101#dsapunte.p;
   |SI FSalida = 0;
      #dsapunte#1 = "N";
      |GRABA 020#dsapunte.a; |LIBERA #dsapunte;
   |FINSI;
   |CIERRAT #dsapunte;
|FPRO;

|| ************************************************************************
|| ************************************************************************
|PROCESO CreoPagos;

|| ... Forma de Pago
   |ABRE #18;
   |DDEFECTO #18;
   #18#0 = #caclipro#20;
   |LEE 000#18=;
   |SI FSalida ! 0; |O #18#0 = 0;
       |ABRE #17;
       |DDEFECTO #17;
       |LEE 000#17p;
       |CIERRA #17;
   |SINO;
        #17#6 = "S";
        #17#7 = #18#2;
        #17#8 = #18#3;
        #17#9 = #18#4;
        #17#10= #18#5;
   |FINSI;
   |CIERRA #18;
   |SI #17#7 = 0; #17#7 = 1; #17#8 = 0; |FINSI;
|| ..................................................

    emision = #caivasop#3;
    pesetas = #caivasop#26;
    |SI EURODB = 2; pesetas = (pesetas * 100) ! 0; |FINSI;

    |SI #17#7 = 1;
        ptasrec1 = 0;
        ptasrec2 = pesetas;
    |SINO;
        ptasrec1 = ((pesetas / #17#7) - .5) ! 0;   || todos vto.menos ultimo
        nNume1 = ptasrec1 * (#17#7 - 1);
        ptasrec2 = pesetas - nNume1;               || ultimo vto.
    |FINSI;

    |SI EURODB = 2;
        pesetas  = pesetas / 100;
        ptasrec1 = ptasrec1 / 100;
        ptasrec2 = ptasrec2 / 100;
    |FINSI;

    fectra1 = emision;
    |PARA nNumPago = 1; |SI nNumPago [ #17#7; |HACIENDO nNumPago = nNumPago + 1;
          nPtasVto = ptasrec1;
          |SI nNumPago = #17#7; nPtasVto = ptasrec2; |FINSI;
          |SI nSwPrim = 1;
              |HAZ RegraboPago;
          |SINO;
              |SI nNumPago = 1;
                  fectra1 = fectra1 + #17#8;
              |SINO;
                  fectra1 = fectra1 + #17#9;
              |FINSI;
              fFechaVto = fectra1;
              |HAZ GraboPago;
         |FINSI;
    |SIGUE;
|FPRC;

|PROCESO GraboPago;
  #camanpag#0 = #caivasop#0;
  #camanpag#1 = #caivasop#2;
  #camanpag#2 = #caivasop#27;
  #camanpag#3 = nNumPago;
  |LEE 101#camanpag.=;
  |SI FSalida ! 0;
     |DDEFECTO #camanpag;
     #camanpag#0 = #caivasop#0;
     #camanpag#1 = #caivasop#2;
     #camanpag#2 = #caivasop#27;
     #camanpag#3 = nNumPago;
     |GRABA 020#camanpag.b;
  |FINSI;
  #camanpag#4 = #caivasop#4;
  #camanpag#5 = #caivasop#5;
  #camanpag#6 = #caivasop#3;
  #camanpag#7 = fFechaVto;
  #camanpag#8 = nPtasVto;
  #camanpag#9 = 0;
  #camanpag#11 = #17#10;
  #camanpag#14 = #caclipro#13;
  #camanpag#15 = #caclipro#14;
  #camanpag#16 = #caclipro#15;
  #camanpag#17 = #caclipro#16;
  #camanpag#18 = #caclipro#17;
  #camanpag#19 = #caclipro#18;
  #camanpag#20 = #caclipro#19;
  #camanpag#22 = "N";
  #camanpag#23 = 0;
  #camanpag#27 = #caivasop#6;
  #camanpag#28 = #caivasop#7;
  |GRABA 020#camanpag.a;
  |LIBERA #camanpag;
|FPRC;

|PROCESO RegraboPago;
   #camanpag#0 = #caivasop#0;
   #camanpag#1 = #caivasop#2;
   #camanpag#2 = #caivasop#27;
   #camanpag#3 = nNumPago;
   |LEE 101#camanpag.=;
   |SI FSalida = 0;
       #camanpag#8 = nPtasVto;
       |GRABA 020#camanpag.a;
       |LIBERA #camanpag;
   |FINSI;
|FPRC;
