|FICHEROS;
  capasimp #0;
  cacuenta #1;      || plan contable
  isocie48 #2;      || distrib. resultados AGISOCI
  cacupimp #3;      || control asiento
  camaasic #4;      || apuntes cabs.
  camaasil #5;      || apuntes lins.
  camandia #6;      || diarios
  agicontr #23;     || control aplicaciones
  isocie58 #17;      || distrib. resultados AGISOCI a¤o 96
|FIN;

|VARIABLES;
  &enDiario   = 0;
  &enContador = 0;
  &modcon = 0;
  trab1 = "";
  nume = 0;
  num1 = 0;
  num2 = 0;
  num3 = 0;
  num4 = 0;
  num5 = 0;
  num6 = 0;
  num7 = 0;
  num8 = 0;
  line = 0;
  importe = 0;
  opera = "B";
  FEstado = 0;
  ini = 0;
  fecalf = @;
  mes = "";
  mesfec = 0;
  mesac = 0;
  a = 0;
  b = 0;
  c = 0;
  asie = 0;
  cantidad = 0;
  alfa1 = "";
  alfa2 = "";
  alfa3 = "";
  alfa4 = "";
  agi  = "";
  agi1 = "";
  agi2 = "";
  num = 0;
  aste = "";
  longi = "";
  para1 = 0;
|FIN;

|INCLUYE inici1_i;       || carga de parametros de la empresa
|INCLUYE condes_i;

____________________________________/ CALCULOS DE PANTALLA
|PROCESO mayor; |TIPO 0;
  trab1 = #0Campo > " ";
  #0Campo = trab1;
  |PINTA #0Campo;
|FPRC;

|PROCESO c_final; |TIPO 7;
  |PTEC 816;
|FPRC;

|PROCESO concepto;
  |SI Campo = 87; |ACABA; |FINSI;
  |SI Campo ! 80;
      num1 = Campo + 44;
      num2 = Campo - 10;
  |SINO;
      num1 = 100;
      num2 = Campo - 1;
  |FINSI;
  |SI #0num1 = "F"; |O #0num1 = "M";  |ACABA;  |FINSI;
  |SI Campo ! 80;
      |PARA num3 = num2+1 ;  |SI num3 [ 45;  |HACIENDO num3 = num3 + 1;
            num4 = num3 + 54;
            num5 = num3 + 10;
            |SI #0num3 = #0num2;  |Y #0num4 = "G";
                #0num5 = #0Campo;
                |PINTA #0num5;
            |FINSI;
      |SIGUE;
      num3 = 79;
      num4 = 100;
      num5 = 80;
      |SI #0num3 = #0num2;  |Y #0num4 = "G";
          #0num5 = #0Campo;
          |PINTA #0num5;
      |FINSI;
  |FINSI;
  num3 = 86;
  num4 = 101;
  num5 = 87;
  |SI #0num3 = #0num2;  |Y #0num4 = "G";
      #0num5 = #0Campo;
      |PINTA #0num5;
  |FINSI;
|FPRC;

|PROCESO leeimpuest; |TIPO 0;
  |SI FSalida = 2; |ACABA; |FINSI;
  |SI #0#2 < 1996;
      |PATH_DAT #2 agi1;
      |DDEFECTO #2;
      |ABRE #2;
      #2#0 = #0#0;       || empresa
      #2#1 = #0#2;       || a¤o
      |LEE 000#2=;
      |SI FSalida ! 0;
          |MENAV "    Distribucion de Resultados INEXISTENTE ...";
          |ERROR;
      |SINO;
          num7  = - #2#7;
          |SI #2#7 ! #2#16;
              |SI num7 ! #2#16;
                  |MENAV "    Distribucion de Resultados DESCUADRADA ...";
                  |ERROR;
              |FINSI;
          |FINSI;
      |FINSI;
      |CIERRA #2;
   |SINO;
      |PATH_DAT #17 agi1;
      |DDEFECTO #17;
      |ABRE #17;
      #17#0 = #0#0;       || empresa
      #17#1 = #0#2;       || a¤o
      |LEE 000#17=;
      |SI FSalida ! 0;
          |MENAV "    Distribucion de Resultados INEXISTENTE ...";
          |ERROR;
      |SINO;
          num7  = - #17#7;
          |SI #17#7 ! #17#16;
              |SI num7 ! #17#16;
                  |MENAV "    Distribucion de Resultados DESCUADRADA ...";
                  |ERROR;
              |FINSI;
          |FINSI;
      |FINSI;
      |CIERRA #17;
      |DDEFECTO #2;
      |PARA para1 = 0; |SI para1 [ 16; |HACIENDO para1 = para1 + 1;
            #2para1 = #17para1;
      |SIGUE;
  |FINSI;
|FPRC;

|PROCESO fechbue; |TIPO 0;
  |SI FSalida = 2; |ACABA; |FINSI;
  |SI #0#3 < fec1;  |O #0#3 > fec2;
      |MENAV "     Fecha ERRONEA";
      |ERROR;
  |SINO;
      |HAZ cargapanta;
  |FINSI;
|FPRC;
____________________________________/ CARGA DE IMPORTES EN PANTALLA
|PROCESO bor_datos;
  |PARA num5 = 46; |SI num5 [ 55; |HACIENDO num5 = num5 + 1;
        |CAMPO_MODIFICA #0num5,1,"N";
  |SIGUE;
        |CAMPO_MODIFICA #0#80,1,"N";
        |CAMPO_MODIFICA #0#87,1,"N";
  |PDEFECTO #0,6,102;
  |PINDA #0#0;
|FPRC;

|PROCESO sumanume;
  |SI num1 = 76;    num1 = 16;     |FINSI;
  |SI num1 = 83;    num1 = 17;     |FINSI;
  num1 = num1 + 1;
  |SI num1 [ 15;
      num2 = num1 + 10;
      num3 = num1 + 20;
      num4 = num1 + 30;
      num5 = num1 + 40;
      num6 = num1 + 50;
      num7 = num1 + 60;
      num8 = num1 + 84;
  |SINO;
      |SI num1 = 16;
          num1 = 76;
          num2 = num1 + 1;
          num3 = num1 + 2;
          num4 = num1 + 3;
          num5 = num1 + 4;
          num6 = num1 + 5;
          num7 = num1 + 6;
          num8 = 100;
      |FINSI;
      |SI num1 = 17;
          num1 = 83;
          num2 = num1 + 1;
          num3 = num1 + 2;
          num4 = num1 + 3;
          num5 = num1 + 4;
          num6 = num1 + 5;
          num7 = num1 + 6;
          num8 = 101;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO lee_cuenta;
  |DDEFECTO #1;
  #1#0 = #0num1;
  #1#1 = #0num2;
  |LEE 000#1=;
  |SI FSalida ! 0;
          alfa1 = "    No existe la cuenta [" + #1#0 + "-" + #1#1 + "] ...";
      |MENAV alfa1;
  |FINSI;
|FPRC;

/*
 importante: el importe de Per. y Ganacias #2#3 marca los signos del asiento
 En (+) [GANANCIAS] --> Base de Reparto al Debe   / Distribucion al Haber
    (-) [PERDIDAS]                      al Haber  /              al Debe
*/

|PROCESO cargapanta;
  |HAZ bor_datos;
  num1 = 5;

  |SI #2#3 ! 0;                              || perdidas y ganacias
      |HAZ sumanume;
      #0num1 = #3#1;     || cuenta
      #0num2 = #3#12;    || digito
      |HAZ lee_cuenta;
      #0num3 = #1#2;     || descripcion
      #0num4 = #3#23;    || concepto
      #0num5 = #3#34;    || descripcion
      #0num6 = #2#3;     || importe
      #0num7 = "D";
      |SI #2#3 < 0;
          #0num6 = -#0num6;
          #0num7 = "H";
      |FINSI;
      #0num8 = #3#47;
      |SI #0num8 ! "F";
          |CAMPO_MODIFICA #0num5,1,"S";
      |FINSI;
  |FINSI;

  |SI #2#4 ! 0;                                   || remanentes
      |HAZ sumanume;
      #0num1 = #3#2;
      #0num2 = #3#13;
      |HAZ lee_cuenta;
      #0num3 = #1#2;
      #0num4 = #3#24;
      #0num5 = #3#35;
      #0num6 = #2#4;
      #0num7 = "D";
      |SI #2#3 < 0;
          #0num6 = -#0num6;
          #0num7 = "H";
      |FINSI;
      #0num8 = #3#48;
      |SI #0num8 ! "F";
          |CAMPO_MODIFICA #0num5,1,"S";
      |FINSI;
  |FINSI;

  |SI #2#5 ! 0;                                   || reservas voluntarias
      |HAZ sumanume;
      #0num1 = #3#3;
      #0num2 = #3#14;
      |HAZ lee_cuenta;
      #0num3 = #1#2;
      #0num4 = #3#25;
      #0num5 = #3#36;
      #0num6 = #2#5;
      #0num7 = "D";
      |SI #2#3 < 0;
          #0num6 = -#0num6;
          #0num7 = "H";
      |FINSI;
      #0num8 = #3#49;
      |SI #0num8 ! "F";
          |CAMPO_MODIFICA #0num5,1,"S";
      |FINSI;
  |FINSI;

  |SI #2#6 ! 0;                                   || otras reservas
      |HAZ sumanume;
      #0num1 = #3#4;
      #0num2 = #3#15;
      |HAZ lee_cuenta;
      #0num3 = #1#2;
      #0num4 = #3#26;
      #0num5 = #3#37;
      #0num6 = #2#6;
      #0num7 = "D";
      |SI #2#3 < 0;
          #0num6 = - #0num6;
          #0num7 = "H";
      |FINSI;
      #0num8 = #3#50;
      |SI #0num8 ! "F";
          |CAMPO_MODIFICA #0num5,1,"S";
      |FINSI;
  |FINSI;

  |SI #2#8 ! 0;                                   || a reserva legal
      |HAZ sumanume;
      #0num1 = #3#5;
      #0num2 = #3#16;
      |HAZ lee_cuenta;
      #0num3 = #1#2;
      #0num4 = #3#27;
      #0num5 = #3#38;
      #0num6 = #2#8;
      #0num7 = "H";
      |SI #2#3 < 0;
          #0num7 = "D";
          |SI #2#7 = #2#16; #0num6 = - #0num6; |FINSI;
      |FINSI;
      #0num8 = #3#51;
      |SI #0num8 ! "F";
          |CAMPO_MODIFICA #0num5,1,"S";
      |FINSI;
  |FINSI;

  |SI #2#9 ! 0;                                   || a reservas especiales
      |HAZ sumanume;
      #0num1 = #3#6;
      #0num2 = #3#17;
      |HAZ lee_cuenta;
      #0num3 = #1#2;
      #0num4 = #3#28;
      #0num5 = #3#39;
      #0num6 = #2#9;
      #0num7 = "H";
      |SI #2#3 < 0;
          #0num7 = "D";
          |SI #2#7 = #2#16; #0num6 = -#0num6; |FINSI;
      |FINSI;
      #0num8 = #3#52;
      |SI #0num8 ! "F";
          |CAMPO_MODIFICA #0num5,1,"S";
      |FINSI;
  |FINSI;

  |SI #2#10 ! 0;                                  || a reservas voluntarias
      |HAZ sumanume;
      #0num1 = #3#7;
      #0num2 = #3#18;
      |HAZ lee_cuenta;
      #0num3 = #1#2;
      #0num4 = #3#29;
      #0num5 = #3#40;
      #0num6 = #2#10;
      #0num7 = "H";
      |SI #2#3 < 0;
          #0num7 = "D";
          |SI #2#7 = #2#16; #0num6 = -#0num6; |FINSI;
      |FINSI;
      #0num8 = #3#53;
      |SI #0num8 ! "F";
          |CAMPO_MODIFICA #0num5,1,"S";
      |FINSI;
  |FINSI;

  |SI #2#11 ! 0;                                  || a otras reservas
      |HAZ sumanume;
      #0num1 = #3#8;
      #0num2 = #3#19;
      |HAZ lee_cuenta;
      #0num3 = #1#2;
      #0num4 = #3#30;
      #0num5 = #3#41;
      #0num6 = #2#11;
      #0num7 = "H";
      |SI #2#3 < 0;
          #0num7 = "D";
          |SI #2#7 = #2#16; #0num6 = -#0num6; |FINSI;
      |FINSI;
      #0num8 = #3#54;
      |SI #0num8 ! "F";
          |CAMPO_MODIFICA #0num5,1,"S";
      |FINSI;
  |FINSI;

  |SI #2#12 ! 0;                                  || a dividendos
      |HAZ sumanume;
      #0num1 = #3#9;
      #0num2 = #3#20;
      |HAZ lee_cuenta;
      #0num3 = #1#2;
      #0num4 = #3#31;
      #0num5 = #3#42;
      #0num6 = #2#12;
      #0num7 = "H";
      |SI #2#3 < 0;
          #0num7 = "D";
          |SI #2#7 = #2#16; #0num6 = -#0num6; |FINSI;
      |FINSI;
      #0num8 = #3#55;
      |SI #0num8 ! "F";
          |CAMPO_MODIFICA #0num5,1,"S";
      |FINSI;
  |FINSI;

  |SI #2#13 ! 0;                                  || a perd. ejerc. anter.
      |HAZ sumanume;
      #0num1 = #3#10;
      #0num2 = #3#21;
      |HAZ lee_cuenta;
      #0num3 = #1#2;
      #0num4 = #3#32;
      #0num5 = #3#43;
      #0num6 = #2#13;
      #0num7 = "H";
      |SI #2#3 < 0;
          #0num7 = "D";
          |SI #2#7 = #2#16; #0num6 = -#0num6; |FINSI;
      |FINSI;
      #0num8 = #3#56;
      |SI #0num8 ! "F";
          |CAMPO_MODIFICA #0num5,1,"S";
      |FINSI;
  |FINSI;

  |SI #2#14 ! 0;                                  || a remanente
      |HAZ sumanume;
      #0num1 = #3#11;
      #0num2 = #3#22;
      |HAZ lee_cuenta;
      #0num3 = #1#2;
      #0num4 = #3#33;
      #0num5 = #3#44;
      #0num6 = #2#14;
      #0num7 = "H";
      |SI #2#3 < 0;
          #0num7 = "D";
          |SI #2#7 = #2#16; #0num6 = -#0num6; |FINSI;
      |FINSI;
      #0num8 = #3#57;
      |SI #0num8 ! "F";
          |CAMPO_MODIFICA #0num5,1,"S";
      |FINSI;
  |FINSI;

  |SI #2#15 ! 0;                                  || otras aplicaciones
      |HAZ sumanume;
      #0num1 = #3#58;
      #0num2 = #3#59;
      |HAZ lee_cuenta;
      #0num3 = #1#2;
      #0num4 = #3#60;
      #0num5 = #3#61;
      #0num6 = #2#15;
      #0num7 = "H";
      |SI #2#3 < 0;
          #0num7 = "D";
          |SI #2#7 = #2#16; #0num6 = -#0num6; |FINSI;
      |FINSI;
      #0num8 = #3#62;
      |SI #0num8 ! "F";
          |CAMPO_MODIFICA #0num5,1,"S";
      |FINSI;
  |FINSI;

  |PINDA #0#0;
|FPRC;
____________________________________/ GRABACION DEL ASIENTO
|PROCESO cabecera;
  |SI #5#9 = 0;  |ACABA;  |FINSI;
  |DDEFECTO #4;
  #4#0 = #5#0; ||  diario
  #4#1 = #5#1; ||  fecha
  #4#2 = #5#2; ||  documento
  #4#3 = #5#2; ||  asiento
  |LEE 101#4=;
  FEstado = FSalida;
  |SI #5#8 = "D";
      #4#04 = #4#4 + #5#9;
      |SI #4#9 = 0;                         ||CONTRAPARTIDA
          #4#8 = #5#4;
          #4#9 = #5#5;
      |FINSI;
  |SINO;
      #4#5 = #4#5 + #5#9;
      |SI #4#11 = 0;
          #4#10 = #5#4;
          #4#11 = #5#5;
      |FINSI;
  |FINSI;
  #4#6 = #4#4 - #4#5;
  |SI FEstado = 0;  |GRABA 020#4a;  |FINSI;
  |SI FEstado ! 0;  |GRABA 020#4n;  |FINSI;
  |LIBERA #4;
|FPRC;

|PROCESO actualiz1;
  #1#0 = #5#4;
  #1#1 = #5#5;
  |LEE 101#1=;
  |SI #5#0 = 0;
      |SI #5#8 = "D";
          #1#9 = #1#9 + #5#9;
          #1#51 = #1#51 + #5#9;
      |SINO;
          #1#10 = #1#10 + #5#9;
          #1#52 = #1#52 + #5#9;
      |FINSI;
      #1#11 = #1#9 - #1#10;
      #1#53 = #1#51 - #1#52;
  |SINO;
      |SI #5#0 = 99;
          |SI #5#8 = "D";
              #1#48 = #1#48 + #5#9;
              #1#51 = #1#51 + #5#9;
          |SINO;
              #1#49 = #1#49 + #5#9;
              #1#52 = #1#52 + #5#9;
          |FINSI;
          #1#50 = #1#48 - #1#49;
          #1#53 = #1#51 - #1#52;
      |SINO;
          |HAZ actualiz2;
      |FINSI;
  |FINSI;
  |SI #1#58 < #0#3;
      #1#58 = #0#0;
  |FINSI;
  |GRABA 020#1a;
  |LIBERA #1;      || /por lo tanto, en la primera no desbloquea
  |HAZ actualiz3;  || diario
|FPRC;

|PROCESO altatra;
  modcon = 1;
  |ABRE #8;
  #8#0 = codcon;
  #8#1 = #5#4;
  #8#2 = #5#5;
  #8#3 = #5#1;
  #8#4 = #5#8;
  #8#6 = #5#0;
  |LEE 101#8=;
  |SI FSalida ! 0;
      |DDEFECTO #8;
      #8#0 = codcon;
      #8#1 = #5#4;
      #8#2 = #5#5;
      #8#3 = #5#1;
      #8#4 = #5#8;
      #8#6 = #5#0;
      |GRABA 101#8b;
  |FINSI;
  importe = #5#9;  || aqui si que se usa el importe real
  |SI opera = "B";
      importe = -importe;
  |FINSI;
  #8#5 = #8#5 + importe;
  |GRABA 101#8a;
  |LIBERA #8;
  |CIERRA #8;
|FPRC;

|PROCESO actualiz2;
  ini = dig1;      || numero de niveles
  fecalf = #0#3;
  mes = fecalf % 402;
  mesfec = mes;
  |SI ini = 1;
      mesac = mesfec;
  |SINO;
      mesac = (mesfec - ini) + 1;
      |SI mesac [ 0;
          mesac = (13 - ini) + mesfec;
      |FINSI;
  |FINSI;
  a = (mesac * 3) + 9;
  b = a + 1;
  c = a + 2;
  |SI #5#8 = "D";
      #1a = #1a + #5#9;
      #1#51 = #1#51 + #5#9;
  |SINO;
      #1b = #1b + #5#9;
      #1#52 = #1#52 + #5#9;
  |FINSI;
  #1c = #1a - #1b;
  #1#53 = #1#51 - #1#52;
|FPRC;

|PROCESO actualiz3;
  |ABRE #6;
  #6#0 = #0#4;
  |LEE 121#6=;
  |SI FSalida = 0;
      |SI #5#8 = "D";  #6#2 = #6#2 + #5#9;  |FINSI;
      |SI #5#8 = "H";  #6#3 = #6#3 + #5#9;  |FINSI;
      |GRABA 020#6a;
  |FINSI;
  |LIBERA #6;
  |CIERRA #6;
|FPRC;

|PROCESO elpase;
  |ABRE #4;
  |ABRE #5;
  |PARA num1 = 6;  |SI num1 [ 83 ;  |HACIENDO num1 = num1 + 1;
        |SI num1 > 15;
            |SI num1 = 16;    num1 = 76;     |FINSI;
            |SI num1 = 77;    num1 = 83;     |FINSI;
            num2 = num1 + 1;
            num3 = num1 + 2;
            num4 = num1 + 3;
            num5 = num1 + 4;
            num6 = num1 + 5;
            num7 = num1 + 6;
        |SINO;
            num2 = num1 + 10;      || digito
            num3 = num1 + 20;      || descripcion
            num4 = num1 + 30;      || concepto
            num5 = num1 + 40;      || descripcion
            num6 = num1 + 50;      || importe
            num7 = num1 + 60;      || signo
        |FINSI;
        |SI #0num6 ! 0;                    ||si hay importe
            |SI line = 1;
                enDiario = #0#4;
                |HAZ contador;
                asie = enContador;
            |FINSI;
            |DDEFECTO #5;
            #5#0 = #0#4;
            #5#1 = #0#3;
            #5#2 = asie;
            #5#3 = line;
            |LEE 101#5=;
            FEstado = FSalida;
                #5#8 = #0num7;
                #5#9 = #0num6;
            |SI #5#9 < 0;
                |SI #5#8 = "D";         || cambia el signo en negativos
                        #5#8 = "H";
                |SINO;
                        #5#8 = "D";
                |FINSI;
                #5#9 = -#5#9;
            |FINSI;
            |SI #5#8 = "D";
                #5#10 = "";
                #5#11 = 0;
                #5#16 = #0num1;
                #5#17 = #0num2;
            |SINO;
                #5#10 = #0num1;
                #5#11 = #0num2;
                #5#16 = "";
                #5#17 = 0;
            |FINSI;
            #5#4 = #0num1;
            #5#5 = #0num2;
            #5#6 = #0num4;
            #5#7 = #0num5;
            enNumCon = #5#6; |HAZ VerConcepto; #5#24 = eaDesCon;
            |SI FEstado = 0;
                |GRABA 020#5a;
            |SINO;
                |GRABA 020#5n;
            |FINSI;
            |LIBERA #5;
            |HAZ cabecera;
            |HAZ actualiz1;
            opera = "A";
            |HAZ altatra;
            line = line + 10;
        |FINSI;
  |SIGUE;
  |CIERRA #4;
  |CIERRA #5;
|FPRC;
____________________________________/ ACTUALIZACION DE NIVELES SUPERIORES
|PROCESO final;
  |SI modcon ! 0;
      |SUB_EJECUTA "camaapua";
  |SINO;
      |ABRE #8;
      |DDEFECTO #8;
      #8#0 = codcon;
      |LEE 001#8=;
      |SI FSalida = 0;
          |BORRA 020#8a;
      |FINSI;
      |CIERRA #8;
  |FINSI;
|FPRC;
____________________________________/ CALCULO PRINCIPAL
|PROGRAMA;
  |HAZ comienzo;

|| ... Controlar Impuesto de Sociedades
  |HAZ tipo_8;
  |SI aste = "*";
       |MENAV "    ATENCION!!! Impuesto de Sociedades no instalado ...";
       ||PTEC 807;
       |ACABA;
  |FINSI;
|| ......................................................................
  line = 1;
  |CLS;
  |PINPA #0#0;
  |CABEZA "Asiento Impuesto";

  |ABRE #3;
  #3#0 = 1;
  |LEE 000#3=;
  |CIERRA #3;
  |SI FSalida ! 0;
      |MENAV "      NO Esta Definido El ASIENTO de Pase";
      |CIERRA #3;
      |ACABA;
  |FINSI;
  |DDEFECTO #0;
  trab1 = fec2 % -104;
  #0#0 = #30#2;
  #0#2 = trab1 - 1;           || coge el a¤o
  #0#4 = #3#45;               || coge el diario
  |PINDA #0#0;
  |ABRET #1;
  |ENDATOS #1#0;
  |SI FSalida = 0;
      |HAZ elpase;
      |HAZ final;
  |FINSI;
  |CIERRAT #1;
|FPRO;

|PROCESO tipo_8; || control de la ficha de clientes general
  |DIRECTORIO agi;
  |QBF agi;
  |PATH_DAT #23 agi;

|ABRE #23;
#23#0 = 1;
|LEE 040#23=;
    || |SI FSalida ! 0; aste = "*"; |CIERRA #23; |ACABA; |FINSI;
    |SI FSalida ! 0;
        agi1 = agi + "sociedad/fich/";
        |CIERRA #23;
        |ACABA;
    |FINSI;
|CIERRA #23;
aste = #23#4;
|QBF aste;
   |SI aste  = "*"; |ACABA; |FINSI;
agi1 = #23#4; |QBF agi1;
longi = agi1 % 0;
num   = longi;
num   = 100 + (num - 5);
longi = num;
agi2  = (agi1 % longi) + "pan/";
|FPRC;
