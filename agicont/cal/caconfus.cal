|FICHEROS;
   caconfus #0;
   caconful #100,MANTE;

   camaasic #31;
   camaasil #32;
   camandia #33;
   cacuenta #34;
   calibros #35;
   caivarep #36;
   caivasop #37;
   camancob #38;
   camanpag #39;
   caivaref #112;
   caivasof #113;

   cacuefus #40;
   caascfus #41;
   caaslfus #42;
   calibfus #43;
   cadiafus #44;
   carepfus #45;
   casopfus #46;
   cacobfus #47;
   capagfus #50;

   refere1@ #100;
   refere2@ #101;
|FIN;

|VARIABLES;
   Cont = 0;
   Calc = 0;
   Campo1 = 0;
   FEstado = 0;
   Comodin = "";
   Comodin1 = "";
   Comodin2 = "";
   ComodNum = 0;
   ComodNum2 = 0;
   Directorio = "";
   Long = 0;
   LongAlfa = "";
   UltNivel = 0;
   Libro = 0;
   LibroAnt = 0;
   LibroIntro = 0;
   Linea = 0;

   EmpresAct = 0;
   PeriodAct = 0;

   Empresa1 = 0;
   Periodo1 = 0;
   Empres = 0;

   MaxDigitos = 0;

   Long1 = 0;
   Long2 = 0;
   Long3 = 0;
   Long4 = 0;
   Long5 = 0;
   Long6 = 0;

   Long11 = 0;
   Long12 = 0;
   Long13 = 0;
   Long14 = 0;
   Long15 = 0;
   Long16 = 0;

   Long21 = 0;
   Long22 = 0;
   Long23 = 0;
   Long24 = 0;
   Long25 = 0;
   Long26 = 0;

   Long31 = 0;
   Long32 = 0;
   Long33 = 0;
   Long34 = 0;
   Long35 = 0;
   Long36 = 0;

   Long41 = 0;
   Long42 = 0;
   Long43 = 0;
   Long44 = 0;
   Long45 = 0;
   Long46 = 0;

   UltNivel1 = 0;
   UltNivel2 = 0;
   UltNivel3 = 0;
   UltNivel4 = 0;
   Nivel = 0;

   Cuenta = "";
   Digito = 0;
   DigDif = "";
   Tipo = 0;

   Diario      = 0;
   NumApunte   = 0;
   NumAsiento  = 0;
   CopiaFact   = 0;
   SwError     = 0;
   Conta1      = 0;
   ModoEntrada = 0;
   aMas        = "";
   aDef        = "";
   nExiste     = 0;
|FIN;

|INCLUYE acceso_i;
|INCLUYE varnue_i;
|INCLUYE recupe_i;

|PROCESO NivelCtas; |TIPO 7;
   |PARA Cont = 19; |SI Cont ] 14; |HACIENDO Cont = Cont - 1;
      |SI #canempre#Cont# ! 0;
         #caconfus#1 = Cont - 13;
         #caconfus#2 = #canempre#Cont#;
         MaxDigitos = #canempre#Cont#;
         |PINTA #caconfus#1;
         |PINTA #caconfus#2;
         |SAL;
      |FINSI;
   |SIGUE;
|FPRC;

|PROCESO ExisteEmpresa;
   |SI FSalida = 2; |ACABA; |FINSI;

   Campo1 = Campo - 1;
   |ABRE #canempre;
   #canempre#2 = #caconfus#Campo1#;
   #canempre#3 = #caconfus#Campo#;
   |LEE 010#canempre.=;
   |SI FSalida = 0;
      Comodin = #canempre#1 % 0136;
      |SI Campo = 4;  |PINTA 0741, Comodin; UltNivel1 = 0; |FINSI;
      |SI Campo = 20; |PINTA 0941, Comodin; UltNivel2 = 0; |FINSI;
      |SI Campo = 36; |PINTA 1141, Comodin; UltNivel3 = 0; |FINSI;
      |SI Campo = 52; |PINTA 1341, Comodin; UltNivel4 = 0; |FINSI;
      Long = 0;
      SwError = 1;
      |PARA Cont = 19; |SI Cont ] 14; |HACIENDO Cont = Cont - 1;
         |SI #canempre#Cont# ! 0;
            |SI #canempre#Cont# > Long; Long = #canempre#Cont#; |FINSI;

            |SI #canempre#Cont# > MaxDigitos;
               |MENAV "    La longitud de las cuentas de trabajo son incompatibles";
               |ERROR;
               |ACABA;
            |FINSI;

            |SI #canempre#Cont# = Long1; SwError = 0; |FINSI;
            |SI #canempre#Cont# = Long2; SwError = 0; |FINSI;
            |SI #canempre#Cont# = Long3; SwError = 0; |FINSI;
            |SI #canempre#Cont# = Long4; SwError = 0; |FINSI;
            |SI #canempre#Cont# = Long5; SwError = 0; |FINSI;
            |SI #canempre#Cont# = Long6; SwError = 0; |FINSI;

            |SI SwError = 1;
               |MENAV "    La longitud de las cuentas de trabajo son de distinta longitud";
               |ERROR;
               |ACABA;
            |FINSI;
         |FINSI;

         |SI Campo = 4;
            |SI UltNivel1 = 0; |Y #canempre#Cont# ! 0; UltNivel1 = Cont - 13; |FINSI;
            |SI Cont = 14; Long11 = #canempre#14; |FINSI;
            |SI Cont = 15; Long12 = #canempre#15; |FINSI;
            |SI Cont = 16; Long13 = #canempre#16; |FINSI;
            |SI Cont = 17; Long14 = #canempre#17; |FINSI;
            |SI Cont = 18; Long15 = #canempre#18; |FINSI;
            |SI Cont = 19; Long16 = #canempre#19; |FINSI;
         |FINSI;
         |SI Campo = 20;
            |SI UltNivel2 = 0; |Y #canempre#Cont# ! 0; UltNivel2 = Cont - 13; |FINSI;
            |SI Cont = 14; Long21 = #canempre#14; |FINSI;
            |SI Cont = 15; Long22 = #canempre#15; |FINSI;
            |SI Cont = 16; Long23 = #canempre#16; |FINSI;
            |SI Cont = 17; Long24 = #canempre#17; |FINSI;
            |SI Cont = 18; Long25 = #canempre#18; |FINSI;
            |SI Cont = 19; Long26 = #canempre#19; |FINSI;
         |FINSI;
         |SI Campo = 36;
            |SI UltNivel3 = 0; |Y #canempre#Cont# ! 0; UltNivel3 = Cont - 13; |FINSI;
            |SI Cont = 14; Long31 = #canempre#14; |FINSI;
            |SI Cont = 15; Long32 = #canempre#15; |FINSI;
            |SI Cont = 16; Long33 = #canempre#16; |FINSI;
            |SI Cont = 17; Long34 = #canempre#17; |FINSI;
            |SI Cont = 18; Long35 = #canempre#18; |FINSI;
            |SI Cont = 19; Long36 = #canempre#19; |FINSI;
         |FINSI;
         |SI Campo = 52;
            |SI UltNivel4 = 0; |Y #canempre#Cont# ! 0; UltNivel4 = Cont - 13; |FINSI;
            |SI Cont = 14; Long41 = #canempre#14; |FINSI;
            |SI Cont = 15; Long42 = #canempre#15; |FINSI;
            |SI Cont = 16; Long43 = #canempre#16; |FINSI;
            |SI Cont = 17; Long44 = #canempre#17; |FINSI;
            |SI Cont = 18; Long45 = #canempre#18; |FINSI;
            |SI Cont = 19; Long46 = #canempre#19; |FINSI;
         |FINSI;
      |SIGUE;
   |SINO;
      |SI #caconfus#Campo1# ! 0; |O #caconfus#Campo# ! 0;
         #canempre#2 = Empresa1;    || En este momento tienen los valores de
         #canempre#3 = Periodo1;    ||   la empresa destino
         |LEE 010#canempre.=;
         |CIERRA #canempre;
         |MENAV "    Empresa inexistente";
         |ERROR;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO Acerar;

   |DBASE aMas;
   aDef = aMas + "def/caivaref";
   |CARGA_DEF aDef, refere1@;
   |SI FSalida ! 0;
       SwError = 1;
       |ACABA;
   |FINSI;

   aDef = aMas + "def/caivasof";
   |CARGA_DEF aDef, refere2@;
   |SI FSalida ! 0;
       |DESCARGA_DEF #refere1@;
       SwError = 1;
       |ACABA;
   |FINSI;

   |DELINDEX #camaasic;
   |ABRET #camaasic;
   |CIERRAT #camaasic;

   |DELINDEX #camaasil;
   |ABRET #camaasil;
   |CIERRAT #camaasil;

   |DELINDEX #cacuenta;
   |ABRET #cacuenta;
   |CIERRAT #cacuenta;

   |DELINDEX #camandia;
   |ABRET #camandia;
   |CIERRAT #camandia;

   |DELINDEX #calibros;
   |ABRET #calibros;
   |CIERRAT #calibros;

   |DELINDEX #caivarep;
   |ABRET #caivarep;
   |CIERRAT #caivarep;

   |DELINDEX #caivasop;
   |ABRET #caivasop;
   |CIERRAT #caivasop;

   |DELINDEX #camancob;
   |ABRET #camancob;
   |CIERRAT #camancob;

   |DELINDEX #camanpag;
   |ABRET #camanpag;
   |CIERRAT #camanpag;

   |DELINDEX #caivaref;
   |ABRET #caivaref;
   |CIERRAT #caivaref;

   |DELINDEX #caivasof;
   |ABRET #caivasof;
   |CIERRAT #caivasof;
|FPRC;

|PROCESO LibrosOrig; |TIPO 0;

   |DFICB Directorio;
   Comodin = "00000" + Empresa1;
   Comodin = Comodin % -105;
   Directorio = Directorio + Comodin;
   Directorio = Directorio + Periodo1 + "/";
   |QBF Directorio;
   |PATH_DAT #43 Directorio;
   Comodin = "calibros";
   |QBF Comodin;
   |NOME_DAT #43 Comodin;

   |ABRE #calibfus;
   #calibfus#0 = #caconful#3;
   |LEE 010#calibfus.=;
   |SI FSalida ! 0;
      |MENAV "    Libro inexistente en empresa origen";
      |ERROR;
      |CIERRA #calibfus;
   |FINSI;
   |CIERRA #calibfus;
|FPRC;

|PROCESO LibrosDest; |TIPO 0;

   |ABRE #calibros;
   #calibros#0 = #caconful#4;
   |LEE 010#calibros.=;
   |SI FSalida ! 0;
      Campo1 = Campo - 1;
      #calibfus#0 = #caconful#4;
      |LEE 010#calibfus.=;
      |SI FSalida = 0;
         |DDEFECTO #calibros;
         #calibros#0 = #caconful#4;
         #calibros#1 = #calibfus#1;
         #calibros#2 = #calibfus#2;
         #calibros#3 = #calibfus#3;
         |GRABA 020#calibros.n;
      |FINSI;
   |FINSI;
   |CIERRA #calibros;
   |CIERRA #calibfus;
|FPRC;

|PROCESO Cuentas;

   |SI #cacuefus#0 = "            "; |ACABA; |FINSI;
   |SI #cacuefus#0 = "            "; |ACABA; |FINSI;

   |SI Empres = 1;
      Long1 = Long11;
      Long2 = Long12;
      Long3 = Long13;
      Long4 = Long14;
      Long5 = Long15;
      Long6 = Long16;
      DigDif = #caconfus#5;
   |FINSI;
   |SI Empres = 2;
      Long1 = Long21;
      Long2 = Long22;
      Long3 = Long23;
      Long4 = Long24;
      Long5 = Long25;
      Long6 = Long26;
      DigDif = #caconfus#9;
   |FINSI;
   |SI Empres = 3;
      Long1 = Long31;
      Long2 = Long32;
      Long3 = Long33;
      Long4 = Long34;
      Long5 = Long35;
      Long6 = Long36;
      DigDif = #caconfus#13;
   |FINSI;
   |SI Empres = 4;
      Long1 = Long41;
      Long2 = Long42;
      Long3 = Long43;
      Long4 = Long44;
      Long5 = Long45;
      Long6 = Long46;
      DigDif = #caconfus#17;
   |FINSI;
   |QBF DigDif;

   |SI dig4 ! 0; UltNivel = 1; |FINSI;
   |SI dig5 ! 0; UltNivel = 2; |FINSI;
   |SI dig6 ! 0; UltNivel = 3; |FINSI;
   |SI dig7 ! 0; UltNivel = 4; |FINSI;
   |SI dig8 ! 0; UltNivel = 5; |FINSI;
   |SI dig9 ! 0; UltNivel = 6; |FINSI;

   |SI #cacuefus#3 = "N";
      #cacuenta#0 = #cacuefus#0;
      #cacuenta#1 = #cacuefus#1;
      |LEE 010#cacuenta.=;
      |SI FSalida ! 0;
         |PARA Cont = 0; |SI Cont [ 59; |HACIENDO Cont = Cont + 1;
            #cacuenta#Cont# = #cacuefus#Cont#;
         |SIGUE;
         |GRABA 020#cacuenta.n;
      |SINO;
         |PARA Cont = 9; |SI Cont [ 53; |HACIENDO Cont = Cont + 1;
            #cacuenta#Cont# = #cacuenta#Cont# + #cacuefus#Cont#;
         |SIGUE;
         |SI #cacuenta#58 < #cacuefus#58;
            #cacuenta#58 = #cacuefus#58;
         |FINSI;
         |GRABA 020#cacuenta.a;
      |FINSI;
   |SINO;
 || Compruebo la longitud de la cuenta y saco el tipo de cuenta :
 ||  Tipo 1 : Nง digitos de origen igual al del ultimo nivel del destino
 ||  Tipo 2 : Nง digitos de origen igual a otro nivel (no al ultimo) de destino

      Tipo = 0;
      Nivel = 0;
      Comodin = #cacuefus#0;
      |QBF Comodin;
      LongAlfa = Comodin % 0;
      Long = LongAlfa;
      |SI UltNivel = 1; |Y Long = dig4; Tipo = 1; Nivel = 1; |FINSI;
      |SI UltNivel = 2; |Y Long = dig5; Tipo = 1; Nivel = 2; |FINSI;
      |SI UltNivel = 3; |Y Long = dig6; Tipo = 1; Nivel = 3; |FINSI;
      |SI UltNivel = 4; |Y Long = dig7; Tipo = 1; Nivel = 4; |FINSI;
      |SI UltNivel = 5; |Y Long = dig8; Tipo = 1; Nivel = 5; |FINSI;
      |SI UltNivel = 6; |Y Long = dig9; Tipo = 1; Nivel = 6; |FINSI;

      |SI Tipo = 0;
         |SI Long = dig4; Tipo = 2; Nivel = 1; |FINSI;
         |SI Long = dig5; Tipo = 2; Nivel = 2; |FINSI;
         |SI Long = dig6; Tipo = 2; Nivel = 3; |FINSI;
         |SI Long = dig7; Tipo = 2; Nivel = 4; |FINSI;
         |SI Long = dig8; Tipo = 2; Nivel = 5; |FINSI;
         |SI Long = dig9; Tipo = 2; Nivel = 6; |FINSI;
      |FINSI;

      |SI Tipo = 1;
         || Tomar la primera parte segun la posicion indicada
         ComodNum = 100 + (#caconfus#0 - 1);
         Comodin  = #cacuefus#0 % ComodNum;

         || Sumar el digito diferenciador
         |QBF Comodin;
         Comodin = Comodin + DigDif;

         ComodNum = ((#caconfus#0 + 1) * 100) + 99;
         Comodin1 = #cacuefus#0 % ComodNum;
         Comodin = Comodin + Comodin1;
         |QBF Comodin;

         #cacuenta#0 = Comodin;
         #cacuenta#1 = Nivel;
         |LEE 010#cacuenta.=;
         |SI FSalida = 0;
            |PARA Cont = 9; |SI Cont [ 53; |HACIENDO Cont = Cont + 1;
               #cacuenta#Cont# = #cacuenta#Cont# + #cacuefus#Cont#;
            |SIGUE;
            |GRABA 020#cacuenta.a;
         |SINO;
            |DDEFECTO #cacuenta;
            #cacuenta#0 = Comodin;
            #cacuenta#1 = Nivel;
            |PARA Cont = 2; |SI Cont [ 8; |HACIENDO Cont = Cont + 1;
               #cacuenta#Cont# = #cacuefus#Cont#;
            |SIGUE;
            |GRABA 020#cacuenta.n;
         |FINSI;
      |FINSI;

      |SI Tipo = 2;
         || Tomar la primera parte segun la posicion indicada
         ComodNum = 100 + (#caconfus#0 - 1);
         Comodin  = #cacuefus#0 % ComodNum;

         || Sumar el digito diferenciador
         |QBF Comodin;
         Comodin = Comodin + DigDif;
         |QBF Comodin;
         LongAlfa = Comodin % 0;
         Long = LongAlfa;

         || Relleno con ceros la ultima parte y ya tendremos creado la cuenta
         ||   del grupo del que deberia colgar la cuenta de trabajo que vamos
         ||   a obtener

         |SI Nivel = 1; ComodNum = dig4; |FINSI;
         |SI Nivel = 2; ComodNum = dig5; |FINSI;
         |SI Nivel = 3; ComodNum = dig6; |FINSI;
         |SI Nivel = 4; ComodNum = dig7; |FINSI;
         |SI Nivel = 5; ComodNum = dig8; |FINSI;
         |SI Nivel = 6; ComodNum = dig9; |FINSI;

         ComodNum = ComodNum - Long;
         Comodin1 = "0" * ComodNum;
         |QBF Comodin1;
         Comodin = Comodin + Comodin1;
         Comodin2 = Comodin;
         |QBF Comodin2;

         || Creo la cuenta de dicho grupo y lo grabo con "PASE DIRECTO = N"

         #cacuenta#0 = Comodin;
         #cacuenta#1 = Nivel;
         |LEE 010#cacuenta.=;
         |SI FSalida ! 0;
            #cacuenta#0 = Comodin;
            |PARA Cont = 1; |SI Cont [ 8; |HACIENDO Cont = Cont + 1;
               #cacuenta#Cont# = #cacuefus#Cont#;
            |SIGUE;
            #cacuenta#3 = "N";
            |GRABA 020#cacuenta.n;
         |FINSI;

         || y ahora creamos la cuenta de trabajo sumando la terminacion
         ||    de la cuenta

         LongAlfa = Comodin2 % 0;
         Long = LongAlfa;
         |SI UltNivel = 1; ComodNum = dig4 - Long; |FINSI;
         |SI UltNivel = 2; ComodNum = dig5 - Long; |FINSI;
         |SI UltNivel = 3; ComodNum = dig6 - Long; |FINSI;
         |SI UltNivel = 4; ComodNum = dig7 - Long; |FINSI;
         |SI UltNivel = 5; ComodNum = dig8 - Long; |FINSI;
         |SI UltNivel = 6; ComodNum = dig9 - Long; |FINSI;
         ComodNum = -(100 + ComodNum);

         Comodin1 = #cacuefus#0;
         |QBF Comodin1;
         Comodin1 = Comodin1 % ComodNum;
         Comodin = Comodin2 + Comodin1;
         |QBF Comodin;

         #cacuenta#0 = Comodin;
         |LEE 010#cacuenta.=;
         |SI FSalida ! 0;
            #cacuenta#0 = Comodin;
            #cacuenta#1 = UltNivel;
            |PARA Cont = 2; |SI Cont [ 8; |HACIENDO Cont = Cont + 1;
               #cacuenta#Cont# = #cacuefus#Cont#;
            |SIGUE;
            |GRABA 020#cacuenta.n;
         |FINSI;

      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Cuentas;
#cacuefus#1;
;
"            ",0;
"zzzzzzzzzzzz",9;
;
NULL,Cuentas;
|FIN;

|PROCESO FiltroCuenta;

      |QBF Cuenta;
      Digito = 0;
      |SI Cuenta = ""; |ACABA; |FINSI;

      LongAlfa = Cuenta % 0;
      Long = LongAlfa;
      |SI Long = dig4; Digito = 1; |FINSI;
      |SI Long = dig5; Digito = 2; |FINSI;
      |SI Long = dig6; Digito = 3; |FINSI;
      |SI Long = dig7; Digito = 4; |FINSI;
      |SI Long = dig8; Digito = 5; |FINSI;
      |SI Long = dig9; Digito = 6; |FINSI;

      || Tomar la primera parte segun la posicion indicada
      ComodNum  = 100 + (#caconfus#0 - 1);
      Comodin  = Cuenta % ComodNum;

      || Sumar el digito diferenciador
      |QBF Comodin;
      Comodin = Comodin + DigDif;
      |QBF Comodin;
      LongAlfa = Comodin % 0;
      Long = LongAlfa;

      || Tomar la segunda parte segun la posicion indicada
      ComodNum2 = ((#caconfus#0 + 1) * 100) + 99;
      Comodin1 = Cuenta % ComodNum2;
      |QBF Comodin1;
      LongAlfa = Comodin1 % 0;
      Long = Long + LongAlfa;

      || Obtengo la diferencia entre la longitud del ultimo nivel y la
      ||    longitud de la cadena que ya tengo calculada para rellenar
      ||    la cuenta con ceros (si procede)

      |SI UltNivel = 1; Long = dig4 - Long; |FINSI;
      |SI UltNivel = 2; Long = dig5 - Long; |FINSI;
      |SI UltNivel = 3; Long = dig6 - Long; |FINSI;
      |SI UltNivel = 4; Long = dig7 - Long; |FINSI;
      |SI UltNivel = 5; Long = dig8 - Long; |FINSI;
      |SI UltNivel = 6; Long = dig9 - Long; |FINSI;

      Comodin2 = "0" * Long;
      |QBF Comodin2;
      Comodin = Comodin + Comodin2 + Comodin1;
      |QBF Comodin;

      Cuenta = Comodin;
      LongAlfa = Cuenta % 0;
      Long = LongAlfa;
      |SI Long = dig4; Digito = 1; |FINSI;
      |SI Long = dig5; Digito = 2; |FINSI;
      |SI Long = dig6; Digito = 3; |FINSI;
      |SI Long = dig7; Digito = 4; |FINSI;
      |SI Long = dig8; Digito = 5; |FINSI;
      |SI Long = dig9; Digito = 6; |FINSI;

|FPRC;

|PROCESO CopiaPagos;
   |DDEFECTO #camanpag;
   #camanpag#0 = #caivasop#0;
   Comodin = "|NC"; Calc = #camanpag#Comodin# - 1;
   |PARA Cont = 1; |SI Cont [ Calc; |HACIENDO Cont = Cont + 1;
      #camanpag#Cont# = #capagfus#Cont#;
   |SIGUE;

   Cuenta = #camanpag#4;
   |HAZ FiltroCuenta;
   #camanpag#4 = Cuenta;
   #camanpag#5 = Digito;

   |GRABA 020#camanpag.n;
|FPRC;

|DEFBUCLE CopiaPagos;
  #capagfus#1;
  ;
  LibroAnt,#caivasop#27,#caivasop#2,0001;
  LibroAnt,#caivasop#27,#caivasop#2,9999;
  ;
  NULL,CopiaPagos;
|FIN;

|PROCESO CopiaCobros;
   |DDEFECTO #camancob;
   #camancob#0 = #caivarep#0;
   Comodin = "|NC"; Calc = #camancob#Comodin# - 1;
   |PARA Cont = 1; |SI Cont [ Calc; |HACIENDO Cont = Cont + 1;
         #camancob#Cont# = #cacobfus#Cont#;
   |SIGUE;

   Cuenta = #camancob#4;
   |HAZ FiltroCuenta;
   #camancob#4 = Cuenta;
   #camancob#5 = Digito;

   |GRABA 020#camancob.n;
|FPRC;

|DEFBUCLE CopiaCobros;
  #cacobfus#1;
  ;
  LibroAnt,#caivarep#27,#caivarep#2,0001;
  LibroAnt,#caivarep#27,#caivarep#2,9999;
  ;
  NULL,CopiaCobros;
|FIN;

|PROCESO CopiaFactura;

   |SI #camaasil#14 = 0; |O #camaasil#13 = 0;
       |ACABA;
   |FINSI;

   |SI #camaasil#12 = "R";

      |ABRE #carepfus;
      #carepfus#0  = LibroAnt;
      #carepfus#27 = #camaasil#15;
      #carepfus#2  = #camaasil#14;
      |LEE 010#carepfus.=;
      |SI FSalida ! 0; |CIERRA #carepfus; |ACABA; |FINSI;
      |CIERRA #carepfus;

      nExiste = 0;
      |ABRE #100;
      #100#0  = LibroAnt;
      #100#1  = #camaasil#15;
      #100#2  = #camaasil#14;
      |LEE 010#100=;
      |SI FSalida = 0; nExiste = 1; |FINSI;
      |CIERRA #100;

      |DDEFECTO #caivarep;

      #caivarep#0 = Libro;

      |ABRE #calibros;
      #calibros#0 = #caivarep#0;
      |LEE 010#calibros.=;
      |SI FSalida = 0;
         #caivarep#1 = #calibros#1;
      |FINSI;
      |CIERRA #calibros;

      Comodin = "|NC"; Calc = #caivarep#Comodin# - 1;
      |PARA Cont = 2; |SI Cont [ Calc; |HACIENDO Cont = Cont + 1;
            #caivarep#Cont# = #carepfus#Cont#;
      |SIGUE;

      #caivarep#45 = #camaasil#0;   || Por si el diario ha cambiado

      Cuenta = #caivarep#4;
      |HAZ FiltroCuenta;
      #caivarep#4 = Cuenta;
      #caivarep#5 = Digito;

      Cuenta = #caivarep#35;
      |HAZ FiltroCuenta;
      #caivarep#35 = Cuenta;
      #caivarep#38 = Digito;

      Cuenta = #caivarep#36;
      |HAZ FiltroCuenta;
      #caivarep#36 = Cuenta;
      #caivarep#39 = Digito;

      Cuenta = #caivarep#37;
      |HAZ FiltroCuenta;
      #caivarep#37 = Cuenta;
      #caivarep#40 = Digito;

      |GRABA 020#caivarep.n;
      |LEE 010#caivarep.=;

      |BUCLE CopiaCobros;

      |SI nExiste = 1;
          |DDEFECTO #caivaref;
          #caivaref#0 = #caivarep#0;
          #caivaref#1 = #caivarep#27;
          #caivaref#2 = #caivarep#2;
          |LEE 101#caivaref.=;
          |SI FSalida ! 0;
              #caivaref#0 = #caivarep#0;
              #caivaref#1 = #caivarep#27;
              #caivaref#2 = #caivarep#2;
              |GRABA 020#caivaref.b;
          |FINSI;
          #caivaref#3 = #100#3;
          |GRABA 020#caivaref.a;
          |LIBERA #caivaref;
      |FINSI;
   |FINSI;

   |SI #camaasil#12 = "S";
      |ABRE #casopfus;
      #casopfus#0  = LibroAnt;
      #casopfus#27 = #camaasil#15;
      #casopfus#2  = #camaasil#14;
      |LEE 010#casopfus.=;
      |SI FSalida ! 0; |CIERRA #casopfus; |ACABA; |FINSI;
      |CIERRA #casopfus;

      nExiste = 0;
      |ABRE #101;
      #101#0  = LibroAnt;
      #101#1  = #camaasil#15;
      #101#2  = #camaasil#14;
      |LEE 010#101=;
      |SI FSalida = 0; nExiste = 1; |FINSI;
      |CIERRA #101;

      |DDEFECTO #caivasop;

      #caivasop#0 = Libro;

      |ABRE #calibros;
      #calibros#0 = #caivasop#0;
      |LEE 010#calibros.=;
      |SI FSalida = 0;
         #caivasop#1 = #calibros#1;
      |SINO;
         |DDEFECTO #calibros;
         #calibros#0 = Libro;
      |FINSI;
      |CIERRA #calibros;

      Comodin = "|NC"; Calc = #caivasop#Comodin# - 1;
      |PARA Cont = 2; |SI Cont [ Calc; |HACIENDO Cont = Cont + 1;
            #caivasop#Cont# = #casopfus#Cont#;
      |SIGUE;

      #caivasop#45 = #camaasil#0; || Por si el diario ha cambiado

      |GRABA 020#caivasop.n;
      |LEE 010#caivasop.=;

      |BUCLE CopiaPagos;

      |SI nExiste = 1;
          |DDEFECTO #caivasof;
          #caivasof#0 = #caivasop#0;
          #caivasof#1 = #caivasop#27;
          #caivasof#2 = #caivasop#2;
          |LEE 101#caivasof.=;
          |SI FSalida ! 0;
              #caivasof#0 = #caivasop#0;
              #caivasof#1 = #caivasop#27;
              #caivasof#2 = #caivasop#2;
              |GRABA 020#caivasof.b;
          |FINSI;
          #caivasof#3 = #101#3;
          |GRABA 020#caivasof.a;
          |LIBERA #caivasof;
      |FINSI;

   |FINSI;
|FPRC;

|PROCESO CogeLibro;
   |SI Libro = #caconful#3;
      LibroAnt = Libro;
      Libro = #caconful#5;
      |ERROR10;
   |FINSI;
|FPRC;

|DEFBUCLE MiraLibro;
  #caconful#1;
  ;
  Empresa1,Periodo1,001;
  Empresa1,Periodo1,999;
  ;
  NULL,CogeLibro;
|FIN;


|PROCESO CopiaLineas;
   |DDEFECTO #camaasil;
   #camaasil#0 = #camaasic#0;
   #camaasil#1 = #camaasic#1;
   #camaasil#2 = #camaasic#2;
   NumApunte = 0;

   |SI #camaasil#0 = 0;
      #camaasil#0 = 0;
      #camaasil#1 = "01.01.1900";
      #camaasil#2 = 1;
      #camaasil#3 = 1;
      |LEE 010#camaasil.];
      |PARA; |SI FSalida = 0; |Y #camaasil#0 = 0; |HACIENDO;
         NumApunte = #camaasil#3;
         |LEE 010#camaasil.s;
      |SIGUE;
      #camaasil#0 = #camaasic#0;
      #camaasil#1 = #camaasic#1;
      #camaasil#2 = #camaasic#2;
      #camaasil#3 = NumApunte + Conta1;
   |SINO;
      #camaasil#3 = #caaslfus#3;
   |FINSI;

   Comodin = "|NC"; Calc = #camaasil#Comodin# - 1;

   |PARA Cont = 4; |SI Cont [ Calc; |HACIENDO Cont = Cont + 1;
         #camaasil#Cont# = #caaslfus#Cont#;
   |SIGUE;

   Cuenta = #camaasil#4;
   |HAZ FiltroCuenta;
   #camaasil#4 = Cuenta;
   #camaasil#5 = Digito;

   Cuenta = #camaasil#10;
   |HAZ FiltroCuenta;
   #camaasil#10 = Cuenta;
   #camaasil#11 = Digito;

   Cuenta = #camaasil#16;
   |HAZ FiltroCuenta;
   #camaasil#16 = Cuenta;
   #camaasil#17 = Digito;

   |SI #camaasil#12 ! " ";

       Libro = #camaasil#13;
       |BUCLE MiraLibro;
       #camaasil#13 = Libro;

       #calibros#2 = " ";
       |ABRE #calibros;
       #calibros#0 = Libro;
       |LEE 010#calibros.=;
       |SI FSalida ! 0;
           |ABRE #calibfus;
           #calibfus#0 = LibroAnt;
           |LEE 010#calibfus.=;
           |SI FSalida = 0; |Y #camaasil#12 = #calibfus#2;
               |DDEFECTO #calibros;
               #calibros#0 = Libro;
               #calibros#1 = #calibfus#1;
               #calibros#2 = #calibfus#2;
               #calibros#3 = #calibfus#3;
               |GRABA 020#calibros.n;
           |FINSI;
           |CIERRA #calibfus;
       |FINSI;
       |CIERRA #calibros;

   |FINSI;

   |GRABA 020#camaasil.n;
   |LEE 010#camaasil.=;

   |SI CopiaFact = 0; |Y #camaasil#12 ! " ";
       |SI #calibros#2 = #camaasil#12;
           |HAZ CopiaFactura;
           CopiaFact = 1;
       |SINO;
           || no esta bien la relacion de soportado y repercutido
       |FINSI;
   |FINSI;

|FPRC;

|DEFBUCLE CopiaLineas;
#caaslfus#1;
;
#caascfus#0,#caascfus#1,#caascfus#2,0001;
#caascfus#0,#caascfus#1,#caascfus#2,9999;
;
NULL,CopiaLineas;
|FIN;

|PROCESO CopiaCabecera;

   |SI Empres = 1; Diario = #caconfus#6;  |FINSI;
   |SI Empres = 2; Diario = #caconfus#10; |FINSI;
   |SI Empres = 3; Diario = #caconfus#14; |FINSI;
   |SI Empres = 4; Diario = #caconfus#18; |FINSI;

   #camaasic#0 = Diario;
   #camaasic#1 = #caascfus#1;
   #camaasic#2 = #caascfus#2;
   |LEE 010#camaasic.=;
   |SI FSalida = 0;
      #camandia#0 = Diario;
      |LEE 010#camandia.=;
      |SI FSalida ! 0;
         |DDEFECTO #camandia;
         #camandia#0 = Diario + 50;
         |GRABA 020#camandia.n;
      |FINSI;
      |DDEFECTO #camaasic;
      #camaasic#0 = Diario + 50;
   |SINO;
      #camandia#0 = Diario;
      |LEE 010#camandia.=;
      |SI FSalida ! 0;
         |DDEFECTO #camandia;
         #camandia#0 = Diario;
         |GRABA 020#camandia.n;
      |FINSI;
      |DDEFECTO #camaasic;
      #camaasic#0 = Diario;
   |FINSI;

   Comodin = "|NC"; Calc = #camaasic#Comodin# - 1;

   |PARA Cont = 1; |SI Cont [ Calc; |HACIENDO Cont = Cont + 1;
         #camaasic#Cont# = #caascfus#Cont#;
   |SIGUE;

   Cuenta = #camaasic#8;
   |HAZ FiltroCuenta;
   #camaasic#8 = Cuenta;
   #camaasic#9 = Digito;

   Cuenta = #camaasic#10;
   |HAZ FiltroCuenta;
   #camaasic#10 = Cuenta;
   #camaasic#11 = Digito;

   |GRABA 020#camaasic.n;
   |LEE 010#camaasic.=;

   CopiaFact = 0;
   |BUCLE CopiaLineas;

|FPRC;

|DEFBUCLE Asientos;
  #caascfus#1;
  ;
  01,"01.01.1900",000001;
  98,"31.12.2999",999999;
  ;
  NULL,CopiaCabecera;
|FIN;

|PROCESO CopiaApertura;

   |LEE 010#camaasic.p;
   |SI FSalida = 0; |Y #camaasic#0 = 0;
       |LEE 010#camaasic.s;
       |SI FSalida = 0; |Y #camaasic#0 = 0;
            |MENAV "    ญญ PROBLEMAS !! Mas de un asiento en el diario de apertura";
       |FINSI;
       |LEE 010#camaasic.p;
   |SINO;
      #camandia#0 = 0;
      |LEE 010#camandia.=;
      |SI FSalida ! 0;
         |DDEFECTO #camandia;
         #camandia#0 = 0;
         |GRABA 020#camandia.n;
      |FINSI;
      |DDEFECTO #camaasic;
      #camaasic#0 = #caascfus#0;
      #camaasic#1 = #caascfus#1;
      #camaasic#2 = #caascfus#2;
      |GRABA 020#camaasic.n;
      |LEE 010#camaasic.=;
   |FINSI;

   Comodin = "|NC"; Calc = #camaasic#Comodin# - 1;

   |PARA Cont = 3; |SI Cont [ Calc; |HACIENDO Cont = Cont + 1;
      #camaasic#Cont# = #camaasic#Cont# + #caascfus#Cont#;
   |SIGUE;

   Cuenta = #camaasic#8;
   |HAZ FiltroCuenta;
   #camaasic#8 = Cuenta;
   #camaasic#9 = Digito;

   Cuenta = #camaasic#10;
   |HAZ FiltroCuenta;
   #camaasic#10 = Cuenta;
   #camaasic#11 = Digito;

   |GRABA 020#camaasic.a;

   CopiaFact = 1;
   |BUCLE CopiaLineas;

|FPRC;

|DEFBUCLE Apertura;
  #caascfus#1;
  ;
  00,"01.01.1900",000001;
  00,"31.12.2999",999999;
  ;
  NULL, CopiaApertura;
|FIN;

|PROCESO CopiaCierre;
   |LEE 010#camaasic.u;
   |SI #camaasic#0 = 99;
      NumAsiento = #camaasic#2;
      NumAsiento = NumAsiento + 1;
   |SINO;
      NumAsiento = #caascfus#2;
   |FINSI;

   Comodin = "|NC"; Calc = #camaasic#Comodin# - 1;
   |DDEFECTO #camaasic;
   |PARA Cont = 0; |SI Cont [ Calc; |HACIENDO Cont = Cont + 1;
      #camaasic#Cont# = #caascfus#Cont#;
   |SIGUE;

   #camaasic#2 = NumAsiento;

   |GRABA 020#camaasic.n;
   |LEE 010#camaasic.=;

   CopiaFact = 1;
   |BUCLE CopiaLineas;
|FPRC;

|DEFBUCLE Cierre;
  #caascfus#1;
  ;
  99,"01.01.1900",000001;
  99,"31.12.2999",999999;
  ;
  NULL,CopiaCierre;
|FIN;

|PROCESO ProcesaEmpresa;

   |SI Empresa1 ! 0; ||  ........ |Y Periodo1 ! 0; el periodo puede ser 0
       |DFICB Directorio;
       Comodin = "00000" + Empresa1;
       Comodin = Comodin % -105;
       Directorio = Directorio + Comodin;
       Directorio = Directorio + Periodo1 + "/";
       |QBF Directorio;
       |PATH_DAT #40 Directorio;
       |PATH_DAT #41 Directorio;
       |PATH_DAT #42 Directorio;
       |PATH_DAT #43 Directorio;
       |PATH_DAT #44 Directorio;
       |PATH_DAT #45 Directorio;
       |PATH_DAT #46 Directorio;
       |PATH_DAT #47 Directorio;
       |PATH_DAT #50 Directorio;
       |PATH_DAT #100 Directorio;
       |PATH_DAT #101 Directorio;

       Comodin = "cacuenta"; |QBF Comodin;
       |NOME_DAT #40 Comodin;

       Comodin = "camaasic"; |QBF Comodin;
       |NOME_DAT #41 Comodin;

       Comodin = "camaasil"; |QBF Comodin;
       |NOME_DAT #42 Comodin;

       Comodin = "calibros"; |QBF Comodin;
       |NOME_DAT #43 Comodin;

       Comodin = "camandia"; |QBF Comodin;
       |NOME_DAT #44 Comodin;

       Comodin = "caivarep"; |QBF Comodin;
       |NOME_DAT #45 Comodin;

       Comodin = "caivasop"; |QBF Comodin;
       |NOME_DAT #46 Comodin;

       Comodin = "camancob"; |QBF Comodin;
       |NOME_DAT #47 Comodin;

       Comodin = "camanpag"; |QBF Comodin;
       |NOME_DAT #50 Comodin;

       |ABRE #cacuenta;
       |BUCLE Cuentas;
       |CIERRA #cacuenta;

       |ABRE #camaasic;
       |ABRE #camaasil;
       |ABRE #calibros;
       |ABRE #camandia;
       |ABRE #caivarep;
       |ABRE #caivasop;
       |ABRE #camancob;
       |ABRE #camanpag;
       |ABRE #caivaref;
       |ABRE #caivasof;

       Conta1 = 1;
       |BUCLE Apertura;

       Conta1 = 10;
       |BUCLE Asientos;      || Procesara todos los diarios excepto el de
                             || cierre y el de apertura
       |BUCLE Cierre;

             || Ademas hay que hacer un bucle para las facturas que hayan
             ||   perdido la relacion con los asientos

      |CIERRA #caivasof;
      |CIERRA #caivaref;
      |CIERRA #camanpag;
      |CIERRA #camancob;
      |CIERRA #caivasop;
      |CIERRA #caivarep;
      |CIERRA #camandia;
      |CIERRA #calibros;
      |CIERRA #camaasil;
      |CIERRA #camaasic;
   |FINSI;
|FPRC;

|| ***********************************************************************
|PROCESO Avisa;
   |PUSHV 10201760;
   |CUADRO 10201760;
   |ATRI I;
   |PINTA 1121, "             ญญ ATENCION !!            ";
   |PINTA 1221, " Esta opcion DESTRUIRA todos los datos ";
   |PINTA 1321, " de la EMPRESA  ACTUAL con el  fin  de ";
   |PINTA 1421, " englobar  todos   los  datos  de  las ";
   |PINTA 1521, " empresas indicadas.  Pulse tecla para ";
   |PINTA 1621, " poder cancelar la opcion.             ";
   |AVISO;
   |AVISO;
   |AVISO;
   |PAUSA;
   |CONFI "0000NContinuar ?";
   FEstado = FSalida;
   |POPV;
|FPRC;

|PROCESO TomaDefecto; |TIPO 11;
   #caconful#0 = Empresa1;
   #caconful#1 = Periodo1;
|FPRC;

|RUTINA inf;
   #caconful#0 = Empresa1;
   #caconful#1 = Periodo1;
   #caconful#2 = 1;
|FRUT;

|RUTINA sup;
   #caconful#0 = Empresa1;
   #caconful#1 = Periodo1;
   #caconful#2 = 999;
|FRUT;

|PROCESO RevLibros;
   |SI #caconful#3 = LibroIntro; |Y #caconful#0 = Empresa1; |Y #caconful#1 = Periodo1;
      SwError = 1;
      |ERROR10;
   |FINSI;
|FPRC;

|DEFBUCLE RevLibros;
#caconful#1;
;
Empresa1,Periodo1,001;
Empresa1,Periodo1,999;
;
NULL,RevLibros;
|FIN;

|PROCESO RevisaLibros;
   ModoEntrada = (FEntrada / 100) ! 0;
   LibroIntro = #caconful#3;
   Linea = #caconful#2;
   |SALVA_DATOS #caconful;
   SwError = 0;
   |BUCLE RevLibros;
   #caconful#0 = Empresa1;
   #caconful#1 = Periodo1;
   #caconful#2 = Linea;
   |LEE 010#caconful.=;
   |REPON_DATOS #caconful;
   |SI SwError = 1; |Y ModoEntrada = 1;
      |MENAV "    Ese libro ya esta introducido";
      |ERROR;
   |SINO;
      |DFICB Directorio;
      Comodin = "00000" + Empresa1;
      Comodin = Comodin % -105;
      Directorio = Directorio + Comodin;
      Directorio = Directorio + Periodo1 + "/";
      |QBF Directorio;
      |PATH_DAT #43 Directorio;
      Comodin = "calibros";
      |QBF Comodin;
      |NOME_DAT #43 Comodin;

      |ABRE #calibfus;
      #calibfus#0 = #caconful#3;
      |LEE 010#calibfus.=;
      |SI FSalida = 0;
         #caconful#4 = #calibfus#1;
      |SINO;
         |MENAV "    El libro no existe en la empresa origen";
         |ERROR;
      |FINSI;
      |CIERRA #calibfus;
   |FINSI;
|FPRC;

|PROCESO EntraLibros;
   |SI FSalida = 2; |ACABA; |FINSI;
   Campo1 = Campo - 3;
   Empresa1 = #caconfus#Campo1#;
   Campo1 = Campo1 + 1;
   Periodo1 = #caconfus#Campo1#;
   |SI Empresa1 ! 0; |O Periodo1 ! 0;
      |ENTLINEAL #1#caconful,-3,1,22,1,inf,sup;
   |FINSI;
|FPRC;

|PROGRAMA;

   |CLS;
   |CABEZA "Fusion de Empresas de Contabilidad";
   |HAZ inicio;
   |HAZ eVarEmpresa;
   EmpresAct = #30#2;
   PeriodAct = #30#3;

   |ABRE #caconfus;
   |LEE 010#caconfus.p;
   |SI FSalida ! 0;
      |DDEFECTO #caconfus;
      |GRABA 020#caconfus.n;
      |LEE 010#caconfus.p;
   |FINSI;

   |PINPA #0#caconfus;
   |PINDA #0#caconfus;

   |HAZ Avisa;
   |SI FEstado < 0; |ACABA; |FINSI;

   |ABRE #canempre;
   #canempre#2 = EmpresAct;
   #canempre#3 = PeriodAct;
   |LEE 010#canempre.=;
   Long1 = #canempre#14;   || En este momento usaremos estas variables para
   Long2 = #canempre#15;   ||   guardar los niveles de la empresa destino
   Long3 = #canempre#16;   ||   para comparar con los niveles de las empresas
   Long4 = #canempre#17;   ||   origen
   Long5 = #canempre#18;
   Long6 = #canempre#19;
   |CIERRA #canempre;

   |ENDATOS #1#caconfus;

   |SI FSalida < 0; |CIERRA #caconfus; |ACABA; |FINSI;
   |GRABA 020#caconfus.a;

   |HAZ Acerar;                             || Inicializo los ficheros
   |SI SwError = 1;
       |MENAV "   Error al cargar Defs de Contabilidad. Proceso Interumpido";
       |ACABA;
   |FINSI;


   Empres = 1;                              || Primera Empresa
   Empresa1 = #caconfus#3;
   Periodo1 = #caconfus#4;
   |HAZ ProcesaEmpresa;

   Empres = 2;                              || Segunda Empresa
   Empresa1 = #caconfus#7;
   Periodo1 = #caconfus#8;
   |HAZ ProcesaEmpresa;

   Empres = 3;                              || Tercera Empresa
   Empresa1 = #caconfus#11;
   Periodo1 = #caconfus#12;
   |HAZ ProcesaEmpresa;

   Empres = 4;                              || Cuarta Empresa
   Empresa1 = #caconfus#15;
   Periodo1 = #caconfus#16;
   |HAZ ProcesaEmpresa;

   |ABRE #canempre;
   #canempre#2 = EmpresAct;
   #canempre#3 = PeriodAct;
   |LEE 010#canempre.=;
   |CIERRA #canempre;

   conforme = "S";
   fini = "01.01.0000";
   ffin = "31.12.9999";
   cini = 1;
   cfin = 999;
   |HAZ recuperacion;

   |CIERRA #caconfus;

   |DESCARGA_DEF #refere2@;
   |DESCARGA_DEF #refere1@;
|FPRO;
