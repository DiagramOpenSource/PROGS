|FICHEROS;
     caem3390 #0;             || Este Def
     caportad #2;             || Clientes
     cama3390 #7;             || Mantenimiento 390
     cama4390 #8;             || Continuacion del mantenimiento 390
     cama5390 #9;             || Continuacion del mantenimiento 390

     dsmom108 #108;
     dsmom999 #199;

     caxxx547 #547;
     caxxx548 #548;
     caxxx549 #549;
     caxxx550 #550;
|FIN;

|VARIABLES;
     nTecla       = 0;
     nBoton1      = 0;
     nBoton2      = 0;
     nBoton3      = 0;
     nBoton4      = 0;
     nBoton5      = 0;
     nBoton6      = 0;
     nDCliente    = 0;
     nHCliente    = 0;
     nCampo       = 0;
     nCampoS      = 0;
     nCampo1      = 0;
     nCanti       = 0;
     nHandle1     = 0;
     nHay         = 0;
     nNume        = 0;

     aF2          = "";
     aF3          = "";
     aF4          = "";
     aF5          = "";
     aF6          = "";
     aF7          = "";
     aTecla       = "";
     aModelos     = "";
     aImpre       = "";
     aTercera     = "";
     aAbre        = "";
     aFichXml     = "";
     aFichPdf     = "";
     aFichErr     = "";
     aFichJus1    = "";
     aFichJus2    = "";
     aAlfa        = "";
     aPathModelo  = "";
     aOrigen      = "";
     aDestino     = "";
     aIPRemoto    = "";

     nifp         = "";
     nombrep      = "";
     callep       = "";
     nump         = "";
     escp         = "";
     pisop        = "";
     puep         = "";
     poblap       = "";
     provip       = "";
     codp         = "";
     sgp          = "";
     tlfnop       = "";
     vacio_20     = "                    ";
     vacio_16     = "                ";
     vacio_12     = "            ";
     vacio_10     = "          ";

     CampoDni   = "";
     Letra1     = "";
     Letra2     = "";
     Letra3     = "";
     Letra4     = "";
     Letra5     = "";
     Letra6     = "";
     Letra7     = "";
     Letra8     = "";
     Caracter   = "";
     Carac1     = 0;
     Carac2     = 0;
     Carac3     = 0;
     Carac4     = 0;
     Carac5     = 0;
     XPara      = 0;
     Posi       = 0;
     aLetrasCif = "ABCDEFGHPQSKLM";
     aCaracter  = "";
     Cadena     = "";

     &dia           = "";
     &mes           = "";
     &anyo          = "";
     &eaModelos     = "";
     &eaFOrigen     = "";
     &eaFDestino    = "";
     &eaInternet    = "";
     &eaAlfa        = "";
     &eaDirJava     = "";
     &eaPathAcrobat = "";
     &enAnyo        = 0;
     &enError       = 0;
     &enHandle2     = 0;
     &eaFichError   = "";
     &eaFichDatos   = "";
     &eaFichAuxil   = "";
     &eaEscal       = "";
     &eaPiso        = "";
     &eaPuerta      = "";
     &eaEjer        = "";
     &eaPeriodo     = "";
    &eaVarDni  = "";
    &enCalcCif = 0;
     &eaUnidadBasico = "";

     &eaPathEmision      = "";
     &eaPathLanza        = "";
     &eaPathExplorador   = "";
     &eaPathInternet     = "";
     &eaFicheroPlano     = "";
     &eaFicheroSalid     = "";
     &eaFicheroError     = "";
     &eaOpcion           = "";
     &enEmpresa          = 0;
     &eaNomEmpresa       = "";
     &eaUnidad           = "";
     &enPresentar        = 0;
     &enErrorPortal      = 0;
     &eaCampo0           = "";
     &eaCampo1           = "";
     &eaCampo2           = "";
     &eaCampo3           = "";
|FIN;

|| Calcula la letra del DNI

|PROCESO LetraDniXml;
     eaVarDni   = CampoDni;
     enCalcCif  = 3;
     |HAZ CalculoDNI;
     CampoDni = eaVarDni;
     CampoDni = ("000000000" + CampoDni) % -109;
|FPRC;

|PROCESO CargaDatosXml;
     nifp        = "";
     nombrep     = "";
     callep      = "";
     nump        = "";
     escp        = "";
     pisop       = "";
     puep        = "";
     poblap      = "";
     provip      = "";
     codp        = "";

     nifp        = #2#38;
     nombrep     = #2#39;   |QBF nombrep;
     callep      = #2#41;
     nump        = #2#42;
     escp        = #2#43;
     pisop       = #2#44;
     puep        = #2#45;
     poblap      = #2#49;
     provip      = #2#50;
     codp        = #2#80;
     sgp         = #2#40;
     tlfnop      = #2#46;

|FPRC;

|PROCESO Secuencial1Xml;
     |DDEFECTO #547;

     #547#1  = "<T";
     #547#2  = "390";
     #547#3  = "01";
     #547#4  = ">";
     #547#5  = " ";

     aAlfa   = (("00" + #2#16) % -102) + (("000" + #2#17) % -103);
     |SI aAlfa = "00000"; aAlfa = "     "; |FINSI;
     #547#6  = aAlfa;

     CampoDni = #2#13;   |HAZ LetraDniXml;
     #547#7  = CampoDni;

     eaAlfa  = #2#2 % 130;  |HAZ QuitaRaros;
     #547#8  = eaAlfa;

     aCaracter  = #2#13 % 101;
     aAlfa      = aLetrasCif - aCaracter;
     |SI aAlfa  = aLetrasCif;
         aAlfa  = ".              ";
     |SINO;
         aAlfa  = "               ";
     |FINSI;
     #547#9  = aAlfa;

     #547#10 = #2#14 % 109;

     #547#11 = #2#3 % 102;

     eaAlfa  = #2#4 % 117;  |HAZ QuitaRaros;
     #547#12 = eaAlfa;

     #547#13  = #2#5 % 104;
     eaEscal  = #2#6 % 102;  |QBF eaEscal;
     eaPiso   = #2#7;        |QBF eaPiso;
     eaPuerta = #2#8;        |QBF eaPuerta;

     eaAlfa  = #2#11 % 120;  |HAZ QuitaRaros;
     #547#14 = eaAlfa;

     eaAlfa  = #2#12;  |HAZ QuitaRaros;
     #547#15 = eaAlfa;

     aAlfa   = (("00" + #2#9) % -102) + (("000" + #2#10) % -103);
     |SI aAlfa = "00000"; aAlfa = "     "; |FINSI;
     #547#16 = aAlfa;

     |SI enAnyo = 2008;
         #547#17 = "0";
         |SI #8#67 = "S"; |O #8#67 = "X";
              #547#17 = "1";
         |FINSI;
     |FINSI;

     |SI enAnyo ] 2009;
         #547#17 = "0";
         |SI #8#84 = "S"; |O #8#84 = "X";
             #547#17 = "1";
         |FINSI;
     |FINSI;

     aAlfa  = "20" + (("00" + #0#0) % -102);
     |SI aAlfa = "0000"; aAlfa = "    "; |FINSI;
     #547#18 = aAlfa;

     #547#19 = #7#254;

     eaAlfa  = #7#5;  |HAZ QuitaRaros;  #547#20 = eaAlfa;

     #547#21 = #7#11;

     #547#22 = #7#23;

     eaAlfa  = #7#6;  |HAZ QuitaRaros;  #547#23 = eaAlfa;

     #547#24 = #7#12;

     #547#25 = #7#24;

     eaAlfa  = #7#7;  |HAZ QuitaRaros;  #547#26 = eaAlfa;

     #547#27 = #7#13;

     #547#28 = #7#25;

     eaAlfa  = #7#8;  |HAZ QuitaRaros;  #547#29 = eaAlfa;

     #547#30  = #7#14;

     #547#31  = #7#26;

     eaAlfa   = #7#9;  |HAZ QuitaRaros;  #547#32  = eaAlfa;

     #547#33  = #7#15;

     #547#34  = #7#27;

     eaAlfa   = #7#10;  |HAZ QuitaRaros;  #547#35  = eaAlfa;

     #547#36  = #7#16;

     #547#37  = #7#28;

     #547#38 = "0";
     |SI #8#66 = "S"; |O #8#66 = "X";
         #547#38 = "1";
     |FINSI;

     #547#39 = #8#68;
     #547#40 = #8#69;

     aAlfa  = #2#51 + #2#52;  |QBF aAlfa;
     |SI nombrep ! "";  |O aAlfa = "";
         #547#41 = nifp;

         eaAlfa  = nombrep;  |HAZ QuitaRaros;
         #547#42 = eaAlfa;

         #547#43 = sgp;

         eaAlfa  = callep;  |HAZ QuitaRaros;
         #547#44 = eaAlfa;

         #547#45 = nump;

         #547#46 = escp;

         #547#47 = pisop;

         #547#48 = puep;

         #547#49 = tlfnop;

         eaAlfa  =  poblap;  |HAZ QuitaRaros;
         #547#50 = eaAlfa;

         eaAlfa  = provip;  |HAZ QuitaRaros;
         #547#51 = eaAlfa;

         #547#52 = codp;

         #547#53 = (#0#1 % 102) + (#0#1 % 402) + (#0#1 % 704);

         #547#54 = "";
         #547#55 = "";
         #547#56 = "";
         #547#57 = "";
     |SINO;
         #547#53 = "";

         eaAlfa  = #2#11;  |HAZ QuitaRaros;
         #547#54 = eaAlfa;

         #547#55 = dia;
         #547#56 = mes;
         #547#57 = #0#1 % -104;

         eaAlfa  = (#2#51 + #2#52) % 136; |HAZ QuitaRaros;
         #547#58 = eaAlfa;

         #547#59 = #2#53 % 109;

         #547#60 = (#2#54 % 102) + (#2#54 % 402) + (#2#54 % 704);

         eaAlfa  = #2#55 % 112;  |HAZ QuitaRaros;
         #547#61 = eaAlfa;

         eaAlfa  = (#2#56 + #2#57) % 136; |HAZ QuitaRaros;
         #547#62 = eaAlfa;

         #547#63 = #2#58 % 109;

         #547#64 = (#2#59 % 102) + (#2#59 % 402) + (#2#59 % 704);

         eaAlfa  = #2#60 % 112;  |HAZ QuitaRaros;
         #547#65 = eaAlfa;

         eaAlfa  = (#2#61 + #2#62) % 136; |HAZ QuitaRaros;
         #547#66 = eaAlfa;

         #547#67 = #2#63 % 109;

         #547#68 = (#2#64 % 102) + (#2#64 % 402) + (#2#64 % 704);

         eaAlfa  = #2#65 % 112;  |HAZ QuitaRaros;
         #547#69 = eaAlfa;
     |FINSI;

     #547#70 = "";

     #547#71 = (("00000"  + #7#0) % -105);

     #547#72 = "</T39001>";

     #547#73 = &13 + &10;
|FPRC;

|PROCESO Secuencial2Xml;
     #548#1  = "<T";
     #548#2  = "390";
     #548#3  = "02";
     #548#4  = ">";
     #548#5  = " ";
                           || Del -6- al -21-
     |PARA nCampo = 33; |SI nCampo [ 46; |HACIENDO nCampo = nCampo + 1;
           nCampo1     = nCampo - 27;
           #548nCampo1 = #7nCampo;
     |SIGUE;

     |PARA nCampo = 53; |SI nCampo [ 54; |HACIENDO nCampo = nCampo + 1;
           nCampo1     = nCampo - 33;
           #548nCampo1 = #7nCampo;
     |SIGUE;

     |PARA nCampo = 176; |SI nCampo [ 181; |HACIENDO nCampo = nCampo + 1;
           nCampo1     = nCampo - 154;
           #548nCampo1 = #7nCampo;
     |SIGUE;

     |PARA nCampo = 55; |SI nCampo [ 56; |HACIENDO nCampo = nCampo + 1;
           nCampo1     = nCampo - 27;
           #548nCampo1 = #7nCampo;
     |SIGUE;

     |PARA nCampo = 182; |SI nCampo [ 183; |HACIENDO nCampo = nCampo + 1;
           nCampo1     = nCampo - 152;
           #548nCampo1 = #7nCampo;
     |SIGUE;

     |PARA nCampo = 57; |SI nCampo [ 64; |HACIENDO nCampo = nCampo + 1;
           nCampo1     = nCampo - 25;
           #548nCampo1 = #7nCampo;
     |SIGUE;

     |PARA nCampo = 184; |SI nCampo [ 185; |HACIENDO nCampo = nCampo + 1;
           nCampo1     = nCampo - 144;
           #548nCampo1 = #7nCampo;
     |SIGUE;

     |PARA nCampo = 65; |SI nCampo [ 66; |HACIENDO nCampo = nCampo + 1;
           nCampo1     = nCampo - 23;
           #548nCampo1 = #7nCampo;
     |SIGUE;

     |PARA nCampo = 186; |SI nCampo [ 187; |HACIENDO nCampo = nCampo + 1;
           nCampo1     = nCampo - 142;
           #548nCampo1 = #7nCampo;
     |SIGUE;

     #548#134 = #7#47;
     #548#135 = #7#48;
     #548#136 = #7#49;
     #548#137 = #7#50;
     #548#138 = #7#51;
     #548#139 = #7#52;

     #548#46  = #7#67;
     #548#47  = #7#188;
     #548#48  = #7#68;
     #548#49  = #7#189;
     #548#50  = #7#69;
     #548#51  = #7#190;
     #548#52  = #7#70;
     #548#53  = #7#191;
     #548#54  = #7#71;
     #548#55  = #7#192;
     #548#56  = #7#72;
     #548#57  = #7#193;
     #548#58  = #7#73;
     #548#59  = #7#194;
     #548#60  = #7#74;
     #548#61  = #7#195;
     #548#62  = #7#75;
     #548#63  = #7#76;
     #548#64  = #7#77;

     #548#65  = #7#79;
     #548#66  = #7#80;
     #548#67  = #7#199;
     #548#68  = #7#81;
     #548#69  = #7#200;
     #548#70  = #7#82;
     #548#71  = #7#201;
     #548#72  = #7#83;
     #548#73  = #7#202;
     #548#74  = #7#84;
     #548#75  = #7#203;
     #548#76  = #7#85;
     #548#77  = #7#204;
     #548#78  = #7#196;
     #548#79  = #7#205;
     #548#80  = #7#220;
     #548#81  = #7#221;

     nNume    = #7#222 * 100;
     aAlfa    = nNume;  |QBF aAlfa;
     aAlfa    = (aAlfa % 101) + "." + (aAlfa % 202);
     #548#82  = aAlfa;

     #548#83  = #7#223;
     #548#84  = #7#224;
     #548#85  = #8#56;
     #548#86  = #7#225;
     #548#87  = #7#88;

     #548#88  = #7#90;
     #548#89  = #7#91;
     #548#90  = #7#206;
     #548#91  = #7#92;
     #548#92  = #7#207;
     #548#93  = #7#93;
     #548#94  = #7#208;
     #548#95  = #7#94;
     #548#96  = #7#209;
     #548#97  = #7#95;
     #548#98  = #7#210;
     #548#99  = #7#96;
     #548#100 = #7#211;
     #548#101 = #7#197;
     #548#102 = #7#212;
     #548#103 = #7#226;
     #548#104 = #7#227;

     nNume    = #7#228 * 100;
     aAlfa    = nNume;  |QBF aAlfa;
     aAlfa    = (aAlfa % 101) + "." + (aAlfa % 202);
     #548#105 = aAlfa;

     #548#106 = #7#229;
     #548#107 = #7#230;
     #548#108 = #8#57;
     #548#109 = #7#231;
     #548#110 = #7#99;

     #548#111 = #7#101;
     #548#112 = #7#102;
     #548#113 = #7#213;
     #548#114 = #7#103;
     #548#115 = #7#214;
     #548#116 = #7#104;
     #548#117 = #7#215;
     #548#118 = #7#105;
     #548#119 = #7#216;
     #548#120 = #7#106;
     #548#121 = #7#217;
     #548#122 = #7#107;
     #548#123 = #7#218;
     #548#124 = #7#198;
     #548#125 = #7#219;
     #548#126 = #7#232;
     #548#127 = #7#233;

     nNume    = #7#234 * 100;
     aAlfa    = nNume;  |QBF aAlfa;
     aAlfa    = (aAlfa % 101) + "." + (aAlfa % 202);
     #548#128 = aAlfa;

     #548#129 = #7#235;
     #548#130 = #7#236;
     #548#131 = #8#58;
     #548#132 = #7#237;
     #548#133 = #7#110;

     #548#140 = #8#76;
     #548#141 = #8#77;
     #548#142 = #8#78;
     #548#143 = #8#79;
     #548#144 = #8#80;
     #548#145 = #8#122;
     #548#146 = #8#123;
     #548#147 = #8#124;
|FPRC;

|PROCESO Secuencial3Xml;
     |DDEFECTO #549;

     #549#1  = "<T";
     #549#2  = "390";
     #549#3  = "03";
     #549#4  = ">";
     #549#5  = "";

     #549#6  = ("00" + #7#119) % -102;
     #549#7  = #7#123;
     #549#8  = #7#127;
     #549#9  = #7#131;
     #549#10 = #7#244;
     #549#11 = #7#249;

     #549#12 = ("00" + #7#120) % -102;
     #549#13 = #7#124;
     #549#14 = #7#128;
     #549#15 = #7#132;
     #549#16 = #7#245;
     #549#17 = #7#250;

     #549#18 = ("00" + #7#121) % -102;
     #549#19 = #7#125;
     #549#20 = #7#129;
     #549#21 = #7#133;
     #549#22 = #7#246;
     #549#23 = #7#251;

     #549#24 = ("00" + #7#122) % -102;
     #549#25 = #7#126;
     #549#26 = #7#130;
     #549#27 = #7#134;
     #549#28 = #7#247;
     #549#29 = #7#252;

     #549#30 = ("00" + #7#240) % -102;
     #549#31 = #7#241;
     #549#32 = #7#242;
     #549#33 = #7#243;
     #549#34 = #7#248;
     #549#35 = #7#253;

     #549#36 = #7#135;
     #549#37 = #8#59;
     #549#38 = #7#138;
     #549#39 = #7#140;
     #549#40 = #7#139;

     |PARA nCampo = 141; |SI nCampo [ 145; |HACIENDO nCampo = nCampo + 1;
           nCampo1     = nCampo - 100;
           #549nCampo1 = #7nCampo;
     |SIGUE;

     |PARA nCampo = 146; |SI nCampo [ 148; |HACIENDO nCampo = nCampo + 1;
           nCampo1 = nCampo - 100;
           nCanti  = 0;

           |SI #7#149 = 0;  nCanti = #7nCampo;  |FINSI;

           #549nCampo1 = nCanti;
     |SIGUE;

     |PARA nCampo = 149; |SI nCampo [ 153; |HACIENDO nCampo = nCampo + 1;
           nCampo1 = nCampo - 100;
           nCanti  = 0;

           |SI #7#149 ! 0;  nCanti = #7nCampo;  |FINSI;
           #549nCampo1 = nCanti;
     |SIGUE;

     nCanti  = 0;
     |SI #7#149 ! 0;  nCanti = #7#146;  |FINSI;
     #549#54 = nCanti;

                                  || Del -55- al -57-

     |PARA nCampo = 154; |SI nCampo [ 156; |HACIENDO nCampo = nCampo + 1;
           nCampo1 = nCampo - 99;
           nCanti  = 0;

           |SI #7#149 ! 0;  nCanti= #7nCampo;  |FINSI;

           #549nCampo1 = nCanti;
     |SIGUE;

     |SI enAnyo [ 2005;
          |PARA nCampo = 157; |SI nCampo [ 175; |HACIENDO nCampo = nCampo + 1;
                nCampo1     = nCampo - 99;
                #549nCampo1 = #7nCampo;
          |SIGUE;
     |FINSI;

     |SI enAnyo ] 2006;
         #549#58 = #7#157;
         #549#59 = #7#158;
         #549#60 = #7#159;
         #549#61 = #7#160;

         #549#62 = #7#161;
         #549#63 = #7#165;
         #549#64 = #7#166;
         #549#65 = #7#167;
         #549#66 = #7#172;
         #549#67 = #7#174;
         #549#68 = #7#162;
         #549#69 = #7#163;
         #549#70 = #7#164;
         #549#71 = #8#61;
         #549#72 = #8#62;
         #549#73 = #7#168;
         #549#74 = #7#169;
         #549#75 = #7#170;
         #549#76 = #7#171;
         #549#79 = #7#173;
         #549#80 = #7#175;
         #549#81 = #8#81;
         #549#82 = #8#82;
         #549#83 = #8#83;
     |FINSI;

     |SI enAnyo ] 2009;
         #549#84 = #8#86;
         #549#85 = #8#87;
         #549#86 = #8#88;
         #549#87 = #8#89;
     |FINSI;

     #549#77 = "</T39003>";
     #549#78 = &13 + &10;
|FPRC;

|PROCESO Secuencial4Xml;
|FPRC;

|PROCESO EmiteXml390;
     |PUSHV 0501 2380;
     |BLANCO 0501 2380;
     |CUADRO 0501 2380;
     |CUADRO 0714 0970;
     |ATRI R;
     |PINTA 0815, " EMITIENDO EL MODELO, ESTO PUEDE TARDAR VARIOS MINUTOS ";
     |ATRI r;

     |MENSA "0000 EMITIENDO EL MODELO, ESTO PUEDE TARDAR VARIOS MINUTOS";

     aPathModelo = eaUnidadBasico + "\MODELOS\390\" + enAnyo + "\";
     aAbre = aPathModelo + aFichPdf;
     |RFBORRA aAbre;

     aAbre = aPathModelo + aFichJus2;
     |RFBORRA aAbre;

     aAbre = aPathModelo + "imprime.bat";
     |XABRE "CBW", aAbre, nHandle1;

     aAlfa = "CD " + aPathModelo + &13 + &10;
     |XGRABA nHandle1, aAlfa;

     aAlfa = eaDirJava + &13 + &10;
     |XGRABA nHandle1, aAlfa;

     |SI aImpre = "I";  |O aImpre = "P";
         aAlfa = "MIIVA" + (("00" + #0#0) % -102);
         aAlfa = aAlfa + " /E:" + aFichXml;
         aAlfa = aAlfa + " /P:" + aFichPdf;
         aAlfa = aAlfa + " /R:" + aFichErr;
         aAlfa = aAlfa + " /C:" + aTercera;
         aAlfa = aAlfa + &13 + &10;
     |SINO;
         aAlfa = "MIIVA" + (("00" + #0#0) % -102);
         aAlfa = aAlfa + " /E:" + aFichXml;
         aAlfa = aAlfa + " /P:" + aFichPdf;
         aAlfa = aAlfa + " /R:" + aFichErr;
         |SI enAnyo = 2004;  aAlfa = aAlfa + " /V:S";  |FINSI;
         |SI enAnyo = 2005;  aAlfa = aAlfa + " /S:S";  |FINSI;
         |SI enAnyo ] 2006;  aAlfa = aAlfa + " /V:S";  |FINSI;
         aAlfa = aAlfa + &13 + &10;
     |FINSI;

     |XGRABA nHandle1, aAlfa;

     |XCIERRA nHandle1;

     |RSYSTEM aAbre;

     |RFBORRA aAbre;

     nHay = 0;

     |SI enAnyo ] 2008;
         |SI aImpre = "I";  |O aImpre = "P";
             aAbre =  aPathModelo + "390" + (("00000" + #7#0) % -105) + "Borrador.pdf";
             |XABRE "EC", aAbre, nHandle1;
             |SI FSalida ] 0;
                 aOrigen  = aAbre;
                 aDestino = aPathModelo + aFichPdf;
                 |RRENOMBRA_FICHERO aOrigen, aDestino;
             |FINSI;
         |FINSI;
     |FINSI;

     aAbre = aPathModelo + aFichPdf;
     |XABRE "EC", aAbre, nHandle1;
     |SI FSalida ] 0;
         nHay = 1;
         |SI aImpre = "I";  |O aImpre = "P";
             |HAZ LocalizaAcrobat;
             |SI enError = 0;
                 aAbre = aPathModelo + "imprime.bat";
                 |XABRE "CBW", aAbre, nHandle1;

                 aAlfa = "CD " + aPathModelo + &13 + &10;
                 |XGRABA nHandle1, aAlfa;

                 |HAZ TraeWait;

                 |SI aImpre = "I";
                     aAlfa = "wait dsprint " + aFichPdf + &13 + &10;
                     |XGRABA nHandle1, aAlfa;
                 |FINSI;

                 |SI aImpre = "P";
                     aAlfa = aPathModelo + "wait " + eaPathAcrobat + " " + aFichPdf + &13 + &10;
                     |XGRABA nHandle1, aAlfa;
                 |FINSI;

                 |XCIERRA nHandle1;
                 |RSYSTEM aAbre;

                 |RFBORRA aAbre;

                 aAlfa = aPathModelo + aFichXml;
                 |RFBORRA aAlfa;
             |FINSI;
         |SINO;
             |SI enAnyo = 2004;
                 aOrigen  = aPathModelo + aFichXml;
                 aDestino = eaInternet  + aFichXml;
                 |RCOPIA_FICHERO aOrigen, aDestino;

                 |RFBORRA aOrigen;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI enAnyo ] 2005;  |Y aImpre = "C";
         nHay  = 1;
         aAbre = aPathModelo + aFichJus1;
         |XABRE "EC", aAbre, nHandle1;
         |SI FSalida ] 0;
             aAlfa  = aPathModelo + aFichJus1;  |RFBORRA aAlfa;

             aOrigen  = aPathModelo + aFichXml;
             aDestino = eaInternet  + aFichXml;
             |RCOPIA_FICHERO aOrigen, aDestino;

             |RFBORRA aOrigen;
         |FINSI;
     |FINSI;

     |SI nHay = 1;
         aAlfa  = aPathModelo + aFichJus1;  |RFBORRA aAlfa;
         aAlfa  = aPathModelo + aFichPdf;   |RFBORRA aAlfa;

         #7#3 = #0#1;
         #7#4 = "N";
         |GRABA 020#7a;
         |LIBERA #7;
     |SINO;
         #7#3 = "";
         #7#4 = "N";
         |GRABA 020#7a;
         |LIBERA #7;
     |FINSI;

     |POPV;
|FPRC;

|PROCESO CargaEmpresaXML;
     |HAZ CargaDatosXml;

     |HAZ Secuencial1Xml;
     |HAZ Secuencial2Xml;
     |HAZ Secuencial3Xml;

     |SI #8#4  ! 0; |O #8#5  ! 0; |O #8#10 ! 0; |O #8#11 ! 0;
      |O #8#16 ! 0; |O #8#17 ! 0; |O #8#22 ! 0; |O #8#23 ! 0;
      |O #8#28 ! 0; |O #8#29 ! 0; |O #8#34 ! 0; |O #8#35 ! 0;
      |O #8#40 ! 0; |O #8#41 ! 0; |O #8#46 ! 0; |O #8#47 ! 0;
      |O #8#52 ! 0; |O #8#53 ! 0;
         |HAZ Secuencial4Xml;
      |FINSI;

      |SI aImpre ! "";
          aAbre     = eaUnidadBasico + "\MODELOS\" + eaModelos + "\" + enAnyo + "\390" + (("00000" + #7#0) % -105) + ".xml";
          aFichXml  = "390" + (("00000" + #7#0) % -105) + ".xml";
          aFichPdf  = "390" + (("00000" + #7#0) % -105) + ".pdf";
          aFichErr  = "err" + (("00000" + #7#0) % -105) + ".xml";
          aFichJus1 = "err" + (("00000" + #7#0) % -105) + ".rst.xml";
          aFichJus2 = "jus" + (("00000" + #7#0) % -105) + ".xml";
     |SINO;
         aAbre = eaInternet + "390" + (("00000" + #7#0) % -105) + ".xml";
     |FINSI;

     |XABRE "CBW", aAbre, enHandle2;

     |ABRE #199;
     |HAZ CargaXml;
     |CIERRA #199;
     |XCIERRA enHandle2;

     |SI aImpre ! "";
         |HAZ EmiteXml390;
     |SINO;
         #7#3 = #0#1;
         #7#4 = "N";
         |GRABA 020#7a;
         |LIBERA #7;
     |FINSI;
|FPRC;

|PROCESO Boton3901;
     |PTEC 824;
|FPRC;

|PROCESO Boton3902;
     |PTEC 825;
|FPRC;

|PROCESO Boton3903;
     |PTEC 826;
|FPRC;

|PROCESO Boton3904;
     |PTEC 827;
|FPRC;

|PROCESO Boton3905;
     |PTEC 828;
|FPRC;

|PROCESO Boton390Esc;
     |PTEC 806;
|FPRC;

|PROCESO Botones;
     |BLANCO 0501 2380;

     |CONTROL_SIMPLE 0, "LBOTON, <F2> Emision Papel Oficial Laser (Directo por Impresora) ", 0513, 0754, Boton3901;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F3> Emision Papel Oficial Laser (Vista previa por el Acrobat)", 0913, 1154, Boton3902;
     nBoton2 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F4> Presentacion Telematica (Comprobacion Previa del Fichero)", 1313, 1554, Boton3903;
     nBoton3 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F5> Presentacion Telematica (Sin Comprobacion)", 1713, 1954, Boton3904;
     nBoton4 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F6> Directorio Acrobat", 2113, 2354, Boton3905;
     nBoton5 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,ESC Cancelar", 2365, 2378, Boton390Esc;
     nBoton6 = FSalida;

     aF2 = &255 + "824";
     aF3 = &255 + "825";
     aF4 = &255 + "826";
     aF5 = &255 + "827";
     aF6 = &255 + "828";
     aF7 = &255 + "806";
     |PARA; |SI;  |HACIENDO;
         |LEETECLA aTecla;
         |SI aTecla = aF2;  nTecla = 1; aImpre = "I";  |SAL;  |FINSI;
         |SI aTecla = aF3;  nTecla = 1; aImpre = "P";  |SAL;  |FINSI;
         |SI aTecla = aF4;  nTecla = 3; aImpre = "C";  |SAL;  |FINSI;
         |SI aTecla = aF5;  nTecla = 3; aImpre = "";   |SAL;  |FINSI;
         |SI aTecla = aF6;  |HAZ Acrobat;                     |FINSI;
         |SI aTecla = aF7;  nTecla = 0;                |SAL;  |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton4;
     |FIN_CONTROL_WINDOWS nBoton5;
     |FIN_CONTROL_WINDOWS nBoton6;

     |PULSATECLA;

     |SI aImpre ! "";
         |SI #0#1 < "01.01.2005";  #0#1 = "01.01.2005";  |FINSI;

         |PUSHV 0501 2380;
         |BLANCO 0501 2380;
         |CUADRO 0501 2380;
         |CUADRO 0719 0965;
         |ATRI R;
         |PINTA 0820, "COPIANDO PROGRAMAS NECESARIOS PARA LA EMISION";
         |ATRI r;

         eaModelos = "390";

         |HAZ CreaDirectorioAnyo;

         |DBASE aModelos;  |QBT aModelos;
         aModelos = aModelos + "hacienda/";

         eaFOrigen  = aModelos + "zls" + (("00" + #0#0) % -102) + "390.tgz";
         eaFDestino = eaUnidadBasico + "/MODELOS/390" + "/" + enAnyo + "/zls" + (("00" + #0#0) % -102) + "390.tgz";
         |HAZ CopiaFicheroXml;

         eaEjer = enAnyo;
         |HAZ BuscaJava;
         |SI enError = 1;  |POPV;  nTecla = 0;  |ACABA;  |FINSI;
         |POPV;
     |FINSI;
|FPRC;

|PROCESO Bloque2011;
     |HAZ Botones;

     |SI nTecla = 0;  |ACABA;  |FINSI;

     |SI nTecla = 1;
         aTercera = "N";
         aAlfa    = "0000NDesea la impresion de la tercera copia  ";
         |CONFI aAlfa;
         |SI FSalida = 0;  aTercera = "S";  |FINSI;
     |FINSI;

     |SI nTecla = 3;
         aTercera   = "N";
         aAlfa      = eaUnidadBasico + "/AEAT";                        |RMKDIR aAlfa;
         aAlfa      = eaUnidadBasico + "/AEAT/INTERNET";               |RMKDIR aAlfa;
         aAlfa      = eaUnidadBasico + "/AEAT/INTERNET/390";           |RMKDIR aAlfa;
         aAlfa      = eaUnidadBasico + "/AEAT/INTERNET/390/" + enAnyo; |RMKDIR aAlfa;
         eaInternet = aAlfa + "/";
     |FINSI;

     |HAZ CargaEmpresaXML;

     |SI aImpre ! "";
         aAlfa = eaUnidadBasico + "/MODELOS/390/" + enAnyo + "/miiva" + (("00" + #0#0) % -102) + ".log";
         |RFBORRA aAlfa;

         eaFichError = "err";
         eaFichDatos = "390";
         eaFichAuxil = "";
         |HAZ BuscaErroresXml;
     |FINSI;

     |SI nTecla = 3;
         aAlfa = "      Los ficheros generados estan en la Carpeta " + eaInternet + " de su PC";
         |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO CargaEmpresaXML_2012;
     |HAZ CargaDatosXml;

     |HAZ Secuencial1Xml;
     |HAZ Secuencial2Xml;
     |HAZ Secuencial3Xml;

     |SI #8#4  ! 0; |O #8#5  ! 0; |O #8#10 ! 0; |O #8#11 ! 0;
      |O #8#16 ! 0; |O #8#17 ! 0; |O #8#22 ! 0; |O #8#23 ! 0;
      |O #8#28 ! 0; |O #8#29 ! 0; |O #8#34 ! 0; |O #8#35 ! 0;
      |O #8#40 ! 0; |O #8#41 ! 0; |O #8#46 ! 0; |O #8#47 ! 0;
      |O #8#52 ! 0; |O #8#53 ! 0;
         |HAZ Secuencial4Xml;
      |FINSI;

     eaFicheroPlano = "390" + (("00000" + #7#0) % -105) + ".xml";
     eaFicheroSalid = "390" + (("00000" + #7#0) % -105) + ".390";
     eaFicheroError = "err" + (("00000" + #7#0) % -105) + ".txt";

     aAbre     = eaPathEmision + eaFicheroPlano;
     |XABRE "BW", aAbre, enHandle2;

     |ABRE #199;
     |HAZ CargaXml;
     |CIERRA #199;
     |XCIERRA enHandle2;

     enEmpresa    = #7#0;
     eaNomEmpresa = #2#2;

     |HAZ PresentaPortal;

     |SI eaOpcion ! "1";
         #7#3 = "";
         #7#4 = "N";
         |SI enErrorPortal = 0;
             #7#3 = #0#1;
         |FINSI;

         |GRABA 020#7a;
     |FINSI;

     |LIBERA #7;
|FPRC;

|PROCESO Bloque2012;
     |HAZ LeeUnidad;

     enAnyo     = 2000 + #0#0;
     eaModelos  = "390";
     eaEjer     = enAnyo;

     eaPathLanza = eaUnidad + "\MODELOS";            |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + eaModelos;    |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + eaEjer;       |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\";

     |DBASE eaPathEmision;
     eaPathEmision = eaPathEmision + "emisiones";       |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + eaModelos;   |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + eaEjer;      |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/";

     eaPathInternet = eaUnidad + "/AEAT";                |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/INTERNET";      |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + eaModelos;  |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + eaEjer;     |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/";

     |HAZ Botones_2012;

     |SI eaOpcion = "0";  |ACABA;  |FINSI;

     |HAZ CargaEmpresaXML_2012;

     |HAZ SacaErrorPtl;

     |SI eaOpcion = "3";  |Y enPresentar = 0;
         aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
         |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO ProcesoUnicoXml;
     |SI enAnyo [ 2011;
         |HAZ Bloque2011;
     |FINSI;

     |SI enAnyo = 2012;  |O enAnyo = 2013;
         |HAZ Bloque2012;
     |FINSI;

     |SI enAnyo ] 2014;
         eaCampo0  = #caem3390#0;
         eaCampo1  = #caem3390#1;
         eaCampo2  = #caem3390#2;
         eaCampo3  = #caem3390#3;
         enEmpresa = #7#0;
         |CIERRA #7;

         |SI enAnyo = 2014;  |SUB_EJECUTA "dsy39014";  |FINSI;
         |SI enAnyo ] 2015;  |Y enAnyo [2017 ; |SUB_EJECUTA "dsy39015";  |FINSI;
         |SI enAnyo ] 2018;  |SUB_EJECUTA "dsy39018";  |FINSI;

         |ABRE #7;
     |FINSI;
|FPRC;

|PROCESO EmpiezaMulti;
     |SI nTecla = 0;  |ACABA;  |FINSI;

     |SI nTecla = 1;
         aTercera = "N";
         aAlfa    = "0000NDesea la impresion de la tercera copia  ";
         |CONFI aAlfa;
         |SI FSalida = 0;  aTercera = "S";  |FINSI;
     |FINSI;

     |SI nTecla = 3;
         aTercera   = "N";
         aAlfa      = eaUnidadBasico + "/AEAT";                        |RMKDIR aAlfa;
         aAlfa      = eaUnidadBasico + "/AEAT/INTERNET";               |RMKDIR aAlfa;
         aAlfa      = eaUnidadBasico + "/AEAT/INTERNET/390";           |RMKDIR aAlfa;
         aAlfa      = eaUnidadBasico + "/AEAT/INTERNET/390/" + enAnyo; |RMKDIR aAlfa;
         eaInternet = aAlfa + "/";
     |FINSI;
|FPRC;

|PROCESO FinalMulti;
     |SI aImpre ! "";
         aAlfa = eaUnidadBasico + "/MODELOS/390/" + enAnyo + "/miiva" + (("00" + #0#0) % -102) + ".log";
         |RFBORRA aAlfa;

         eaFichError = "err";
         eaFichDatos = "390";
         eaFichAuxil = "";
         |HAZ BuscaErroresXml;
     |FINSI;

     |SI nTecla = 3;
         aAlfa = "      Los ficheros generados estan en la Carpeta " + eaInternet + " de su PC";
         |MENAV aAlfa;
     |FINSI;
|FPRC;
