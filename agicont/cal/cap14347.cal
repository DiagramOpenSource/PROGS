|FICHEROS;
  cap14347 #0;

  camaasil #1;
  caivasop #2;
  caivarep #3;
  caclipro #4;
  caprovin #6;
  caportad #8;

  camac347 #10;
  camal347 #11;
  camal348 #44;

  eosclipr #12;
  cacongru #13;
  camic347 #14;
  camil347 #15;
  canempre #30;
  agicontr #23;
  cadatemp #50;

  catmp502 #990;
  catmp347 #999;
  capas347 #1347;

  camacc01 #501;
  camacc02 #502;
|FIN;

|VARIABLES;
  desde = 0;
  hasta = 0;
  modif1 = "";
  modif2 = "";
  xy = 0;
  x = 0;
  y = 0;
  z = 0;
  yz = 0;
  juan = 0;
  LineaInm = 0;

  direcc = "";
  linea = 0;
  sien = 0;
  alfa1 = "";
  alfa2 = "";
  lonagi = "";
  longi = 0;
  nume1 = 0;
  nume2 = 0;
  nume3 = 0;
  nume4 = 0;

  totalcomp = 0;
  totalvent = 0;
  relcompra = 0;
  relventa  = 0;
  relpagos  = 0;
  relsubv   = 0;
  numpro = 0;
  numcli = 0;
  numpag = 0;
  numsub = 0;
  tipo1 = 0;
  tipo2 = 0;
  total = 0;
  nTrans = 0;

  swgr = 0;
  grupo = 0;
  concepto = 0;
  swclipro = 0;

  agi = "";
  &agi1 = "";
  &agi2 = "";
  &aste = "";
  num = 0;

  nSelec   = 0;
  nImporte = 0;

   Comodin = "";
   Cont    = 0;
   SwCont  = 0;
   SwError = 0;
   Dobles  = 0;
   Path = "";
   Comodin1 = "";
   ComodNum = 0;
   Empresa = 0;
   Periodo = 0;
   Dia = "";
   Mes1 = "";
   Mes2 = "";
   FechaIni  = @;
   FechaFin  = @;

   aOp1   = "";
   aOp2   = "";
   aOp3   = "";
   arren  = "";
   Segur  = "";
   Tipo   = 0;

   Linea  = 1;
   TotalTipo1   = 0;
   TotPersTipo1 = 0;
   TotalTipo2   = 0;
   TotPersTipo2 = 0;
   TotalTipo3   = 0;
   TotPersTipo3 = 0;
   TotalTipo4   = 0;
   TotPersTipo4 = 0;
   TotalTipo5   = 0;
   TotPersTipo5 = 0;
   TotalTipo6   = 0;
   TotPersTipo6 = 0;
   TotalTipo7   = 0;
   TotPersTipo7 = 0;
   nNegativo    = 0;
   aFichero     = "";
   Trimestre    = 0;
   nCampo1      = 0;
   nCampo2      = 0;

   nError = 0;
   nPara1 = 0;
   nPara2 = 0;
   nNume1 = 0;
   nNume2 = 0;
   nSw    = 0;
   fFecha = @;

   nConcepto   = 0;
   nBaseCaja   = 0;
   nCuotaCaja  = 0;

   a340        = "";
   &nPie       = 0;
   aCampo51    = "";
   &enNCobro   = 0;

   &ef502c1    = @;
   &ea502c2    = "";
   &ea502c3    = "";
   &enCobrado1 = 0;
   &enCobrado2 = 0;
   &enCobrado3 = 0;
   &enCobrado4 = 0;
   &enCobrado5 = 0;
   nTotalCaja  = 0;
|FIN;

|INCLUYE acceso_i;
|INCLUYE varnue_i;
|INCLUYE varcaj_i;

|PROCESO tipo_8; || controlar si existe ficha clientes
  |DIRECTORIO agi; |QBF agi;
  |PATH_DAT #23 agi;

  |ABRE #23;
  #23#0 = 1;
  |LEE 040#23=;
  |SI FSalida ! 0;
      aste = "*";
      |CIERRA #23;
      |ACABA;
  |FINSI;
  |CIERRA #23;

  aste = #23#7; |QBF aste;
  |SI aste  = "*"; |ACABA; |FINSI;

  agi1 = #23#8; |QBF agi1;
  lonagi = agi1 % 0;
  num    = lonagi;
  num    = 100 + (num - 5);
  lonagi = num;

  agi2  = (agi1 % lonagi) + "pan/";
  |PATH_DAT #12 agi1;
|FPRC;

|| ************************************************************************

|CALCULO mayor1; |TIPO 0;
  |SI #0Campo = "N";
      |C_M #0#75, 1, "S";
      |C_M #0#76, 1, "S";
  |SINO;
      |C_M #0#75, 1, "N";
      |C_M #0#76, 1, "N";
  |FINSI;
|FCAL;

|CALCULO mayor; |TIPO 0;
  desde = Campo;
  xy = 34;
  |SI Campo = 79; |O Campo = 99;  |O Campo = 145;  |O Campo = 164;
      xy = 18;
  |FINSI;

  |SI Campo = 183; |O Campo = 194;
      xy = 10;
  |FINSI;

  hasta = desde + xy;
  modif1 = "N";
  modif2 = "N"
  |SI #0Campo = "N";
      modif1 = "S";
      modif2 = "N";
  |SINO;
      |SI #0Campo = "S";
          modif1 = "N";
          modif2 = "S"
      |FINSI;
  |FINSI;
  juan = 0;
  |PARA desde = Campo + 1;  |SI desde [ hasta;  |HACIENDO desde = desde + 1;
        juan = juan + 1;
        |SI juan > 2;
            |C_M #0desde, 1,modif1;
            |SI modif1 = "N";
                #0desde = 0;
                |PINTA #0desde;
            |FINSI;
        |SINO;
            |C_M #0desde, 1,modif2;
            |SI modif2 = "N";
                #0desde = 0;
                |PINTA #0desde;
            |FINSI;
        |FINSI;
  |SIGUE;
|FCAL;

|CALCULO saltacon1; |TIPO 0;
  |SI FSalida = 2; |ACABA; |FINSI;
  x = Campo - 3;
  |SI #0x ! "N"; |ACABA; |FINSI;
  |SI #0Campo = 0;
      |MENAV "    Error!!! Introduzca como minimo  UN CONCEPTO ";
      |ERROR;
  |FINSI;
|FCAL;

|CALCULO saltacon; |TIPO 0;
                   hasta = 204; xy = 194;
  |SI Campo < 194; hasta = 193; xy = 183; |FINSI;
  |SI Campo < 183; hasta = 182; xy = 164; |FINSI;
  |SI Campo < 164; hasta = 163; xy = 145; |FINSI;
  |SI Campo < 145; hasta = 144; xy = 136; |FINSI;
  |SI Campo < 144; hasta = 135; xy = 127; |FINSI;
  |SI Campo < 127; hasta = 126; xy = 118; |FINSI;
  |SI Campo < 118; hasta = 117; xy = 99;  |FINSI;
  |SI Campo < 98;  hasta = 97;  xy = 79;  |FINSI;
  |SI Campo < 74;  hasta = 73;  xy = 39;  |FINSI;
  |SI Campo < 39;  hasta = 38;  xy = 4;   |FINSI;

  |SI xy < 118;  |O xy > 144;
      |SI #0xy ! "N"; |ACABA; |FINSI;  || ha pedido desde/hasta
  |SINO;
      |SI #0xy = "N"; |ACABA; |FINSI;  || no tiene Arrendamientos o seguros
  |FINSI;
  |PARA desde = Campo + 1;  |SI desde [ hasta;  |HACIENDO desde = desde + 1;
        |SI #0Campo = 0;
            |C_M #0desde, 1, "N";
            #0desde = 0;
        |SINO;
            |C_M #0desde, 1, "S";
        |FINSI;
  |SIGUE;
|FCAL;

|CALCULO mayor3; |TIPO 0;
  desde = Campo;
  hasta = desde + 8;
  modif2 = #0Campo;
  |PARA desde = Campo + 1;  |SI desde [ hasta;  |HACIENDO desde = desde + 1;
        |C_M #0desde, 1,modif2;
        |SI modif2 = "N";
            #0desde = 0;
            |PINTA #0desde;
        |FINSI;
  |SIGUE;
|FCAL;

|CALCULO saltacon2; |TIPO 7;
  xy = Campo - 4;
  |SI #0xy = "N"; |ACABA; |FINSI;
  x = Campo - 1;
  y = Campo - 2;
  z = Campo - 3;
  yz = Campo + 4;
  |SI #0x ! 0; |O #0y ! 0; |O #0z ! 0;
    |PARA desde = Campo;  |SI desde [ yz;  |HACIENDO desde = desde + 1;
          |C_M #0desde, 1, "N";
          #0desde = 0;
          |PINTA #0desde;
    |SIGUE;
  |SINO;
     |PARA desde = Campo;  |SI desde [ yz;  |HACIENDO desde = desde + 1;
           |C_M #0desde, 1, "S";
     |SIGUE;
  |FINSI;
|FCAL;

|CALCULO saltagru; |TIPO 0;
  |C_M #0Campo,0,alfa1;
  |SI alfa1 = "N"; |ACABA; |FINSI;

  |SI #0Campo ! 0;  |ACABA;  |FINSI;
  hasta = 227;
  |SI Campo < 219; hasta = 218; |FINSI;
  |SI Campo < 210; hasta = 209; |FINSI;
  |SI Campo < 140; hasta = 139; |FINSI;
  |SI Campo < 131; hasta = 130; |FINSI;
  |SI Campo < 122; hasta = 121; |FINSI;
  |PARA desde = Campo + 1;  |SI desde [ hasta;  |HACIENDO desde = desde + 1;
        |C_M #0desde, 1, "N";
        #0desde = 0;
  |SIGUE;
|FCAL;


|| **************************************************************************
***                  Nuevo proceso pase manten. modelo 347                ***
*****************************************************************************

|| /////////////////////////////////////////////////////////////////////
|PROCESO Diario;

     Tipo = 0;
     #caclipro#23 = "C";
     #caclipro#10 = #camaasil#4;
     #caclipro#11 = #camaasil#5;
     |LEE 000#caclipro.=;
     |SI FSalida = 0;
         Tipo = 1;
     |SINO;
         #caclipro#23 = "P";
         #caclipro#10 = #camaasil#4;
         #caclipro#11 = #camaasil#5;
         |LEE 000#caclipro.=;
         |SI FSalida = 0;
             Tipo = 2;
         |FINSI;
     |FINSI;
     |SI Tipo = 0;  |ACABA;  |FINSI;  ||no es cliente/proveedor

     nSelec = 0;
     |SI Tipo = 1;   || Ventas
         |SI #0#194 = "X"; |ACABA; |FINSI;
         |SI #0#194 = "S";
             |SI #camaasil#6 ] #0#195; |Y #camaasil#6 [ #0#196; nSelec = 1; |FINSI;
         |SINO;
             |PARA Cont = 197; |SI Cont [ 204; |HACIENDO Cont = Cont + 1;
                   |SI #0Cont = #camaasil#6; |Y #0Cont ! 0;
                       nSelec = 1; |SAL;
                   |FINSI;
             |SIGUE;
         |FINSI;
     |FINSI;
     |SI nSelec = 0; |ACABA; |FINSI;  || NO esta seleccionado

     SwCont = 1;

     |SELECT #3#catmp347;
     #catmp347#1 = #caclipro#9;
     Segur = "N";
     arren = "N";
     aOp1  = "N";
     aOp2  = "N";
     aOp3  = "N";
     #catmp347#8 = Tipo;
     #catmp347#6 = arren;
     #catmp347#7 = Segur;
     #catmp347#20 = aOp1;
     #catmp347#21 = aOp2;
     #catmp347#22 = aOp3;
     |LEE 101#catmp347.=;
     |SI FSalida ! 0;
         |LIBERA #catmp347;
         arren = "S";
         #catmp347#8 = Tipo;
         #catmp347#6 = arren;
         #catmp347#7 = Segur;
         #catmp347#20 = aOp1;
         #catmp347#21 = aOp2;
         #catmp347#22 = aOp3;
         |LEE 101#catmp347.=;
         |SI FSalida ! 0;
             |LIBERA #catmp347;
             arren = "N";
             |DDEFECTO #catmp347;
             #catmp347#0 = #camaasil#4;
             #catmp347#1 = #caclipro#9;
             #catmp347#3 = #caclipro#23;
             #catmp347#4 = #camaasil#5;
             #catmp347#5 = #caclipro#1;
             #catmp347#6 = arren;
             #catmp347#7 = Segur;
             #catmp347#8 = Tipo;
             #catmp347#9 = Linea;
             #catmp347#20 = aOp1;
             #catmp347#21 = aOp2;
             #catmp347#22 = aOp3;
             Linea = Linea + 1;
             |GRABA 020#catmp347.b;
         |FINSI;
     |FINSI;
     nImporte = 0;
     |SI Tipo = 1;
         |SI #camaasil#8 = "D";
             nImporte = - #camaasil#9;
         |SINO;
             nImporte = #camaasil#9;
         |FINSI;
     |FINSI;
     |SI Tipo = 2;
         |SI #camaasil#8 = "D";
             nImporte = #camaasil#9;
         |SINO;
             nImporte = - #camaasil#9;
         |FINSI;
     |FINSI;
     #catmp347#10 = #catmp347#10 + nImporte;

     |GRABA 020#catmp347.a;
     |LIBERA #catmp347;
     |SELECT #1#catmp347;
|FPRC;

|DEFBUCLE Diario;
   #1#1;
   ;
   01, FechaIni, 000001, 0001;
   99, FechaFin, 999999, 9999;
   e;
   NULL, Diario;
|FIN;

||//////////////////////////////////////////////////////////////////
|PROCESO LeeCab501;
        |ABRE #501;
        |DDEFECTO #501;
        #501#13 = aTipoIVA;
        #501#17 = eDevenCaja;
        #501#0  = enLibroCaja;
        #501#14 = eaSerieCaja;
        #501#15 = enRegisCaja;
        |LEE 040#501=;
        |SI FSalida ! 0;  enSwCaja = 0;  |FINSI;
        |CIERRA #501;
|FPRC;

|PROCESO LosCobros;
         nBaseCaja  = (nBaseCaja  + #502#11) ! 2;
         nCuotaCaja = (nCuotaCaja + #502#12) ! 2;
|FPRC;

|DEFBUCLE LosCobros;
     #502#1;
     ;
     aTipoIVA, eDevenCaja, enLibroCaja, eaSerieCaja, enRegisCaja, 01;
     aTipoIVA, eDevenCaja, enLibroCaja, eaSerieCaja, enRegisCaja, 99;
     e;
     NULL, LosCobros;
|FIN;

|PROCESO ElRECC;
     nBaseCaja   = 0; nCuotaCaja  = 0;
     |SI enSwCaja = 1;
         |BUCLE LosCobros;
     |FINSI;
|FPRC;

||//////////////////////////////////////////////////////////////////
|PROCESO SubGrupo;
       |SI #0nNume2 ! 0;
           #cacongru#0 = #0nNume2;
           |LEE 041#cacongru.=;
           |SI FSalida = 0;
               |PARA Cont = 2; |SI Cont [ 21; |HACIENDO Cont = Cont + 1;
                     |SI #cacongru#Cont# = #caivarep#6;
                         nSw = 1;
                         |SAL;
                     |FINSI;
               |SIGUE;
           |FINSI;
       |FINSI;
|FPRC;

|PROCESO SeleccionOp;
   nSw = 0;
   |SI #0nNume1 = "S";
           nNume2 = nNume1 + 1; |HAZ SubGrupo;
       |SI nSw = 0;
           nNume2 = nNume1 + 2; |HAZ SubGrupo;
       |FINSI;
       |SI nSw = 0;
           nNume2 = nNume1 + 3; |HAZ SubGrupo;
       |FINSI;
       |SI nSw = 0;
           nNume2 = nNume1 + 4; |SI #0nNume2 = nConcepto; nSw = 1; |FINSI;
           nNume2 = nNume1 + 5; |SI #0nNume2 = nConcepto; nSw = 1; |FINSI;
           nNume2 = nNume1 + 6; |SI #0nNume2 = nConcepto; nSw = 1; |FINSI;
           nNume2 = nNume1 + 7; |SI #0nNume2 = nConcepto; nSw = 1; |FINSI;
           nNume2 = nNume1 + 8; |SI #0nNume2 = nConcepto; nSw = 1; |FINSI;
       |FINSI;
   |FINSI;
|FPRC;

|| /////////////////////////////////////////////////////////////////

|PROCESO Trimestre;
      |SI #8#126 = "F";
          alfa1 = fFecha;
          alfa1 = alfa1 % 0402;
          nNume1 = alfa1;
          |SI #8#93 ! "T";
              Trimestre = nNume1;
          |SINO;
              |SI nNume1 [ 3; Trimestre = 1;                 |FINSI;
              |SI nNume1 > 3; |Y nNume1 [ 6;  Trimestre = 2; |FINSI;
              |SI nNume1 > 6; |Y nNume1 [ 9;  Trimestre = 3; |FINSI;
              |SI nNume1 > 9;                 Trimestre = 4; |FINSI;
          |FINSI;
      |FINSI;

      |SI #8#93 = "T";
          nCampo1 = 11 + Trimestre;
          nCampo2 = 15 + Trimestre;
      |SINO;
          |SI Trimestre [ 3;                  nCampo1 = 12; nCampo2 = 16; |FINSI;
          |SI Trimestre > 3;|Y Trimestre [ 6; nCampo1 = 13; nCampo2 = 17; |FINSI;
          |SI Trimestre > 6;|Y Trimestre [ 9; nCampo1 = 14; nCampo2 = 18; |FINSI;
          |SI Trimestre > 9;                  nCampo1 = 15; nCampo2 = 19; |FINSI;
      |FINSI;
      #999nCampo1 = #999nCampo1 + nImporte;
      |SI nTrans = 1;
          #999nCampo2 = #999nCampo2 + nImporte;
      |FINSI;

      |SI #999#8 = 1; |O #999#8 = 2;
           |DDEFECTO #990;
           #990#0 = #999#8;
           #990#1 = #999#1;
           |LEE 041#990=;
           |SI FSalida ! 0;
               |DDEFECTO #990;
               #990#0 = #999#8;
               #990#1 = #999#1;
               |GRABA 020#990b;
           |FINSI;
           #990#2 = #990#2 + nImporte;
           |GRABA 020#990a;
           |LIBERA #990;
      |FINSI;
|FPRC;

|PROCESO Ventas;
   |SI Dobles = 1;
      |SI #caivarep#3 < FechaIni; |O #caivarep#3 > FechaFin; |ACABA; |FINSI;
   |FINSI;

|| ... Procesos nuevos RECC ] 2014
   enSwCaja  = 0;
   aTipoIVA  = "R";
   |SI enEjercicio ] 2014;
       eDevenCaja  = 0;
       enConcepto  = #caivarep#6;
       enLibroCaja = #caivarep#0;
       eaSerieCaja = #caivarep#27;
       enRegisCaja = #caivarep#2;
       |HAZ EsCajaIva;
       |SI enSwCaja = 1;  |HAZ LeeCab501;  |FINSI;
   |FINSI;
   |HAZ ElRECC;

   aOp1 = "N";
   aOp2 = "N";
   aOp3 = "N";
   arren = "N";
   Segur = "N";

   nConcepto = #caivarep#6;
   ||  Conceptos de arrendamientos
       nNume1 = 127; |HAZ SeleccionOp;
       |SI nSw = 1;
           arren = "S";
       |FINSI;

   ||  Conceptos de Seguros
   |SI arren ! "S";
       nNume1 = 136; |HAZ SeleccionOp;
       |SI nSw = 1;
           Segur = "S";
       |FINSI;
   |FINSI;

   ||  Op. Depositos
   |SI arren ! "S"; |Y Segur ! "S";
       nNume1 = 224; |HAZ SeleccionOp;
       |SI nSw = 1;
           aOp2 = "S";
       |FINSI;
   |FINSI;

   Tipo = 1;
   |SI #0#79 ! "X";
      |SI #0#79 = "S";
         |SI #caivarep#6 ] #0#80; |Y #caivarep#6 [ #0#81;
            Tipo = 3;
         |FINSI;
      |SINO;
         |PARA Cont = 82; |SI Cont [ 97; |HACIENDO Cont = Cont + 1;
            |SI #0#Cont# = #caivarep#6;
               Tipo = 3;
            |FINSI;
         |SIGUE;
      |FINSI;
   |FINSI;

   |SI #0#99 ! "X";
      |SI #0#99 = "S";
         |SI #caivarep#6 ] #0#100; |Y #caivarep#6 [ #0#101;
            Tipo = 5;
         |FINSI;
      |SINO;
         |PARA Cont = 102; |SI Cont [ 117; |HACIENDO Cont = Cont + 1;
            |SI #0#Cont# = #caivarep#6;
               Tipo = 5;
            |FINSI;
         |SIGUE;
      |FINSI;
   |FINSI;

   |SI #0#145 ! "X";
      |SI #0#145 = "S";
         |SI #caivarep#6 ] #0#146; |Y #caivarep#6 [ #0#147;
            Tipo = 6;
         |FINSI;
      |SINO;
         |PARA Cont = 148; |SI Cont [ 163; |HACIENDO Cont = Cont + 1;
            |SI #0#Cont# = #caivarep#6;
               Tipo = 6;
            |FINSI;
         |SIGUE;
      |FINSI;
   |FINSI;

   |SI Tipo = 1;
       |SI arren = "N"; |Y Segur = "N"; |Y aOp1 = "N"; |Y aOp2 = "N";
           |SI #0#39 = "S";
               |SI #caivarep#6 < #0#40; |O #caivarep#6 > #0#41;
                   |ACABA;
               |FINSI;
           |SINO;
               SwError = 1;
               |PARA Cont = 42; |SI Cont [ 73; |HACIENDO Cont = Cont + 1;
                     |SI #caivarep#6 = #0Cont;
                         SwError = 0;
                         |SAL;
                     |FINSI;
               |SIGUE;
               |SI SwError = 1; |ACABA; |FINSI;
           |FINSI;
       |FINSI;
   |FINSI;

   nTrans = 0;
   |SI Tipo = 1;
       |SI #0#183 = "S";
          |SI #caivarep#6 ] #0#184; |Y #caivarep#6 [ #0#185;
              nTrans = 1;
          |FINSI;
       |SINO;
          |PARA Cont = 186; |SI Cont [ 193; |HACIENDO Cont = Cont + 1;
             |SI #caivarep#6 = #0Cont; nTrans = 1; |SAL; |FINSI;
          |SIGUE;
       |FINSI;
   |FINSI;

   aOp3 = "N";
   |SI Tipo = 1; |O Tipo = 2;
       |SI aOp1 = "N"; |Y aOp2 = "N";
           |SI enSwCaja = 1;
               aOp3 = "S";
           |FINSI;
       |FINSI;
   |FINSI;
   |SI Tipo ! 1; |Y Tipo ! 2;
       aOp1 = "N";
       aOp2 = "N";
   |FINSI;

   SwCont = 1;
   |SELECT #3#catmp347;
   #catmp347#1 = #caivarep#51;
   #catmp347#8 = Tipo;
   #catmp347#6 = arren;
   #catmp347#7 = Segur;
   #catmp347#20 = aOp1;
   #catmp347#21 = aOp2;
   #catmp347#22 = aOp3;
   |LEE 101#catmp347.=;
   |SI FSalida ! 0;
      |SELECT #1#catmp347;
      |DDEFECTO #catmp347;
      #catmp347#0 = #caivarep#4;
      #catmp347#1 = #caivarep#51;
      #catmp347#3 = "C";
      #catmp347#4 = #caivarep#5;
      #catmp347#5 = #caivarep#50;
      #catmp347#6 = arren;
      #catmp347#7 = Segur;
      #catmp347#20= aOp1;
      #catmp347#21= aOp2;
      #catmp347#22= aOp3;
      #catmp347#8 = Tipo;
      #catmp347#9 = Linea; Linea = Linea + 1;
      |GRABA 020#catmp347.b;
   |FINSI;
   #catmp347#2 = #catmp347#2 + #caivarep#26;

   |SI nTrans = 1;
       #catmp347#11 = #catmp347#11 + #caivarep#26;
   |FINSI;

   nImporte  = #caivarep#26;
   Trimestre = #caivarep#44;
   fFecha    = #caivarep#3;
   |HAZ Trimestre;

   |SI aOp3 = "S";
       #catmp347#23 = (#catmp347#23 + nBaseCaja + nCuotaCaja) ! 2;
   |FINSI;
   |GRABA 020#catmp347.a;
   |LIBERA #catmp347;
   |SELECT #1#catmp347;
|FPRC;

|DEFBUCLE Ventas;
   #caivarep#1;
   ;
   00,"  ",000000;
   99,"zz",999999;
   ;
   NULL,Ventas;
|FINSI;

|PROCESO Compras;
   |SI Dobles = 1;
      |SI #caivasop#3 < FechaIni; |O #caivasop#3 > FechaFin; |ACABA; |FINSI;
   |FINSI;

|| ... Procesos nuevos RECC ] 2014
   enSwCaja  = 0;
   aTipoIVA  = "S";
   |SI enEjercicio ] 2014;
       eDevenCaja  = 0;
       enConcepto  = #caivasop#6;
       enLibroCaja = #caivasop#0;
       eaSerieCaja = #caivasop#27;
       enRegisCaja = #caivasop#2;
       |HAZ EsCajaIva;
       |SI enSwCaja = 1;  |HAZ LeeCab501;  |FINSI;
   |FINSI;
   |HAZ ElRECC;

   aOp1 = "N";
   aOp2 = "N";
   aOp3 = "N";
   arren = "N";
   Segur = "N";

   nConcepto = #caivasop#6;
   ||  Conceptos de arrendamientos
       nNume1 = 118; |HAZ SeleccionOp;
       |SI nSw = 1;
           arren = "S";
       |FINSI;

   ||  Op. ISP
   |SI arren ! "S";
       nNume1 = 206; |HAZ SeleccionOp;
       |SI nSw = 1;
           aOp1 = "S";
       |FINSI;
   |FINSI;

   ||  Op. Depositos
   |SI arren ! "S"; |Y aOp1 ! "S";
       nNume1 = 215; |HAZ SeleccionOp;
       |SI nSw = 1;
           aOp2 = "S";
       |FINSI;
   |FINSI;

   Tipo = 2;

   |SI #0#79 ! "X";
      |SI #0#79 = "S";
         |SI #caivasop#6 ] #0#80; |Y #caivasop#6 [ #0#81;
            Tipo = 3;
         |FINSI;
      |SINO;
         |PARA Cont = 82; |SI Cont [ 97; |HACIENDO Cont = Cont + 1;
            |SI #0Cont = #caivasop#6;
               Tipo = 3;
            |FINSI;
         |SIGUE;
      |FINSI;
   |FINSI;

   |SI #0#99 ! "X";
      |SI #0#99 = "S";
         |SI #caivasop#6 ] #0#100; |Y #caivasop#6 [ #0#101;
            Tipo = 5;
         |FINSI;
      |SINO;
         |PARA Cont = 102; |SI Cont [ 117; |HACIENDO Cont = Cont + 1;
            |SI #0Cont = #caivasop#6;
               Tipo = 5;
            |FINSI;
         |SIGUE;
      |FINSI;
   |FINSI;

   |SI #0#164 ! "X";
      |SI #0#164 = "S";
         |SI #caivasop#6 ] #0#165; |Y #caivasop#6 [ #0#166;
             Tipo = 7;
         |FINSI;
      |SINO;
         |PARA Cont = 167; |SI Cont [ 182; |HACIENDO Cont = Cont + 1;
            |SI #0Cont = #caivasop#6;
               Tipo = 7;
            |FINSI;
         |SIGUE;
      |FINSI;
   |FINSI;

   |SI Tipo = 2;
       |SI arren = "N"; |Y aOp1 = "N"; |Y aOp2 = "N";
           |SI #0#4 = "S";
              |SI #caivasop#6 < #0#5; |O #caivasop#6 > #0#6;
                  |ACABA;
              |FINSI;
           |SINO;
              SwError = 1;
              |PARA Cont = 7; |SI Cont [ 37; |HACIENDO Cont = Cont + 1;
                   |SI #caivasop#6 = #0Cont;
                       SwError = 0;
                       |SAL;
                   |FINSI;
              |SIGUE;
              |SI SwError = 1;
                  |ACABA;
              |FINSI;
           |FINSI;
       |FINSI;
   |FINSI;

   nTrans = 0;
   |SI Tipo = 2;
       |SI #0#183 = "S";
          |SI #caivasop#6 ] #0#184; |Y #caivasop#6 [ #0#185;
              nTrans = 1;
          |FINSI;
       |SINO;
          |PARA Cont = 186; |SI Cont [ 193; |HACIENDO Cont = Cont + 1;
                |SI #caivasop#6 = #0Cont; nTrans = 1; |SAL; |FINSI;
          |SIGUE;
       |FINSI;
   |FINSI;

   SwCont = 1;
   aOp3 = "N";
   |SI Tipo = 1; |O Tipo = 2;
       |SI aOp1 = "N"; |Y aOp2 = "N";
           |SI enSwCaja = 1;
               aOp3 = "S";
           |FINSI;
       |FINSI;
   |FINSI;
   |SI Tipo ! 1; |Y Tipo ! 2;
       aOp1 = "N";
       aOp2 = "N";
   |FINSI;

   |SI aOp1 = "S";
       #caivasop#26 = #caivasop#8 + #caivasop#9 + #caivasop#10 + #caivasop#52 + #caivasop#53;
   |FINSI;

  |SELECT #3#catmp347;
   #catmp347#1 = #caivasop#51;
   #catmp347#8 = Tipo;
   #catmp347#6 = arren;
   #catmp347#7 = Segur;
   #catmp347#20 = aOp1;
   #catmp347#21 = aOp2;
   #catmp347#22 = aOp3;
   |LEE 101#catmp347.=;
   |SI FSalida ! 0;
      |DDEFECTO #catmp347;
      #catmp347#0 = #caivasop#4;
      #catmp347#1 = #caivasop#51;
      #catmp347#3 = "P";
      #catmp347#4 = #caivasop#5;
      #catmp347#5 = #caivasop#50;
      #catmp347#6 = arren;
      #catmp347#7 = Segur;
      #catmp347#20 = aOp1;
      #catmp347#21 = aOp2;
      #catmp347#22 = aOp3;
      #catmp347#8 = Tipo;
      #catmp347#9 = Linea; Linea = Linea + 1;
      |GRABA 020#catmp347.b;
   |FINSI;
   #catmp347#2 = #catmp347#2 + #caivasop#26;

   |SI nTrans = 1;
       #catmp347#11 = #catmp347#11 + #caivasop#26;
   |FINSI;
   nImporte = #caivasop#26;
   Trimestre = #caivasop#44;
   fFecha    = #caivasop#3;
   |HAZ Trimestre;

   |SI aOp3 = "S";
       #catmp347#23 = (#catmp347#23 + nBaseCaja + nCuotaCaja) ! 2;
   |FINSI;

   |GRABA 020#catmp347.a; |LIBERA #catmp347;
   |SELECT #1#catmp347;
|FPRC;

|DEFBUCLE Compras;
  #caivasop#1;
  ;
  00,"  ",000000;
  99,"zz",999999;
  ;
  NULL,Compras;
|FINSI;

|| ////////////////////////////////////////////////////////////
|PROCESO MiraEmpresa;
   |SI FSalida = 2; |ACABA; |FINSI;
   |SI #cadatemp#0 = enEmpresa; |Y #cadatemp#1 = enPeriodo;
      |MENAV "    La empresa debe ser distinta a la actual";
      |ERROR;
   |FINSI;
|FPRC;
|| ////////////////////////////////////////////////////////////

|PROCESO PasaAModelo;

  nNegativo = #999#2;
  |SI #999#2 = 1; |O #999#2 = 2;
      #990#0 = #999#8;
      #990#1 = #999#1;
      |LEE 041#990=;
      |SI FSalida = 0;
          nNegativo = #990#2;
      |FINSI;
  |FINSI;
  |SI nNegativo < 0; nNegativo = - nNegativo; |FINSI;

  |SI #999#8 = 1; |Y nNegativo < #0#2;  |Y #999#6 = "N"; |ACABA; |FINSI;
  |SI #999#8 = 2; |Y nNegativo < #0#1;  |Y #999#6 = "N"; |ACABA; |FINSI;
  |SI #999#8 = 3; |Y nNegativo < #0#78; |ACABA; |FINSI;
  |SI #999#8 = 5; |Y nNegativo < #0#98; |ACABA; |FINSI;

  |SI #999#8 = 1; TotPersTipo1 = TotPersTipo1 + 1; TotalTipo1 = TotalTipo1 + #999#2; |FINSI;
  |SI #999#8 = 2; TotPersTipo2 = TotPersTipo2 + 1; TotalTipo2 = TotalTipo2 + #999#2; |FINSI;
  |SI #999#8 = 3; TotPersTipo3 = TotPersTipo3 + 1; TotalTipo3 = TotalTipo3 + #999#2; |FINSI;
  |SI #999#8 = 4; TotPersTipo4 = TotPersTipo4 + 1; TotalTipo4 = TotalTipo4 + #999#2; |FINSI;
  |SI #999#8 = 5; TotPersTipo5 = TotPersTipo5 + 1; TotalTipo5 = TotalTipo5 + #999#2; |FINSI;
  |SI #999#8 = 6; TotPersTipo6 = TotPersTipo6 + 1; TotalTipo6 = TotalTipo6 + #999#2; |FINSI;
  |SI #999#8 = 7; TotPersTipo7 = TotPersTipo7 + 1; TotalTipo7 = TotalTipo7 + #999#2; |FINSI;

  |DDEFECTO #camal347;
  #camal347#0 = #camac347#0;
  #camal347#1 = Linea;
  #camal347#2 = #999#8;

  |SI #0#74 = "S";
      #eosclipr#0 = #catmp347#1;
      |LEE 001#eosclipr.=;
      |SI FSalida = 0;
          #camal347#4 =  #eosclipr#1;   ||nombre
          #camal347#6 =  #eosclipr#2;   ||CL/AV
          #camal347#7 =  #eosclipr#3;   ||direccion
          #camal347#8 =  #eosclipr#4;   ||numero
          #camal347#9 =  #eosclipr#7;   ||cod.pos -1-
          #camal347#10 = #eosclipr#8;   ||cos.pos -2-
          #camal347#11 = #eosclipr#9;   ||provincia
          #camal347#12 = #eosclipr#10;  ||poblacion
          #camal347#16 = "";            ||Pais
          |SI #camal347#9 = 99;
              #camal347#16 = #eosclipr#14;
          |FINSI;
       |FINSI;

   |SINO;

       #caclipro#23 = #catmp347#3;
       #caclipro#10 = #catmp347#0;
       #caclipro#11 = #catmp347#4;
       |LEE 001#caclipro.=;
       |SI FSalida = 0;
           #camal347#3 =  #caclipro#9;      ||dni
           #camal347#4 =  #caclipro#1;      ||nombre
           #camal347#9 =  #caclipro#3;      ||cod.pos -1-
           #camal347#10 = #caclipro#4;      ||cos.pos -2-
           #camal347#12 = #caclipro#6;      ||poblacion
           direcc = #caclipro#2;
           |HAZ separa;
           #caprovin#0 = #camal347#9;
           |LEE 041#caprovin.=;
           |SI FSalida = 0;
               #camal347#11 = #caprovin#1;
           |SINO;
               #camal347#11 = "";
           |FINSI;
           #camal347#16 = "";
           |SI #camal347#9 = 99;
               #camal347#16 = #caclipro#24;
           |FINSI;
       |SINO;
           #camal347#4 =  #catmp347#5;    ||nombre
           #camal347#5 =  #catmp347#2;    ||Importe
           #camal347#6 =  "";      ||CL/AV
       |FINSI;
   |FINSI;

   #camal347#3 =  #catmp347#1;   ||dni
   #camal347#5 =  #catmp347#2;   ||Importe
   #camal347#13 = #catmp347#7;   ||Seguro
   #camal347#14 = #catmp347#6;   ||Arrendamientos;
   |SI #catmp347#10 ] #0#205;
       #camal347#17 = #catmp347#10;   ||Importe Metalico
   |SINO;
       #camal347#17 = 0;
   |FINSI;
   #camal347#18 = #catmp347#11;  ||Transmisiones
   #camal347#20 = #catmp347#12;
   #camal347#21 = #catmp347#13;
   #camal347#22 = #catmp347#14;
   #camal347#23 = #catmp347#15;
   #camal347#24 = #catmp347#16;
   #camal347#25 = #catmp347#17;
   #camal347#26 = #catmp347#18;
   #camal347#27 = #catmp347#19;

   #camal347#28 = #999#20;
   #camal347#29 = #999#21;
   #camal347#30 = #999#22;
   |SI #999#22 = "S";
       #camal347#20 = 0;
       #camal347#21 = 0;
       #camal347#22 = 0;
       #camal347#23 = 0;
       #camal347#31 = #999#23;
   |FINSI;

   |GRABA 020#camal347.n;
   Linea = Linea + 1;

   |SI #999#6 = "S";
       |ABRE #camic347;
       |ABRE #camil347;
       #camic347#0 = #camac347#0;
       |LEE 101#camic347.=;
       |SI FSalida ! 0;
           |DDEFECTO #camic347;
           #camic347#0 = #camac347#0;
           #camic347#1 = #camac347#1;
           #camic347#4 = #30#26;
           |GRABA 020#camic347.b;
       |FINSI;
       #camic347#2 = #camic347#2 + 1;
       #camic347#3 = #camic347#3 + #catmp347#2;
       |GRABA 020#camic347.a;
       |LIBERA #camic347;

       #camil347#0 = #camac347#0;
       #camil347#1 = 1;
       |LEE 000#camil347.];
       |SI FSalida = 0; |Y #camil347#0 = #camac347#0;
           |PARA; |SI FSalida = 0; |Y #camil347#0 = #camac347#0; |HACIENDO;
                  LineaInm = #camil347#1 + 1;
                  |LEE 000#camil347.s;
           |SIGUE;
       |SINO;
            LineaInm = 1;
       |FINSI;

       |DDEFECTO #camil347;
       #camil347#0  = #camic347#0;
       #camil347#1  = LineaInm;
       #camil347#2  = #camal347#3;
       #camil347#3  = #camal347#4;
       #camil347#4  = #camal347#5;
       #camil347#5  = #camal347#6;
       #camil347#6  = #camal347#7;
       #camil347#7  = #camal347#8;
       #camil347#11 = #camal347#9;
       #camil347#12 = #camal347#10;
       #camil347#13 = #camal347#11;
       #camil347#14 = #camal347#12;
       #camil347#16 = #30#26;
       #camil347#19 = #camal347#20;
       #camil347#20 = #camal347#21;
       #camil347#21 = #camal347#22;
       #camil347#22 = #camal347#23;
       #camil347#23 = #camal347#31;
       #camil347#24 = #camal347#30;
       |GRABA 020#camil347.n;
       |CIERRA #camic347;
       |CIERRA #camil347;
  |FINSI;
|FPRC;

|DEFBUCLE PasaNif;
  #catmp347#3;
  ;
  "               ",1," ", " ", " ", " ", " ";
  "zzzzzzzzzzzzzzz",7,"z", "z", "z", "z", "z";
  ;
  NULL,PasaAModelo;
|FIN;


||/////////////////// Borra datos
|PROCESO BorraLins348;
   |BORRA 020#camal348.a;
   |LIBERA #camal348;
|FPRC;

|DEFBUCLE BorraLins348;
  #camal348#1;
  ;
  #camac347#0, 00001, 2990;
  #camac347#0, 99999, 1990;
  be;
  NULL,BorraLins348;
|FIN;

|PROCESO BorraLins347;
   |BORRA 020#camal347.a;
   |LIBERA #camal347;
|FPRC;

|DEFBUCLE BorraLins347;
  #camal347#1;
  ;
  #camac347#0,00001;
  #camac347#0,99999;
  be;
  NULL,BorraLins347;
|FIN;

|PROCESO BorraLInm347;
   |BORRA 020#camil347.a;
   |LIBERA #camac347;
|FPRC;

|DEFBUCLE BorraLInm347;
   #camil347#1;
   ;
   #camic347#0,00001;
   #camic347#0,99999;
   be;
   NULL,BorraLInm347;
|FIN;
|| \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

|PROCESO MalPeriodo;
    nError = 1;
|FPRC;

|DEFBUCLE Ventas_Per;
    #caivarep#1;
    44;
    00,"  ",000000,  5;
    99,"zz",999999, 99;
    ;
    NULL,MalPeriodo;
|FINSI;

|DEFBUCLE Compras_Per;
   #caivasop#1;
   44;
   00,"  ",000000,  5;
   99,"zz",999999, 99;
   ;
   NULL,MalPeriodo;
|FINSI;

|PROCESO Comienzo;

   #0#205 = 6000.01;

   aFichero = "4w" + Usuario;
   |NOME_DAT #999 aFichero;
   |DELINDEX #999;
   aFichero = "5w" + Usuario;
   |NOME_DAT #990 aFichero;
   |DELINDEX #990;

   |ABRE #8;
   |DDEFECTO #8;
   #8#0 = #30#2;
   #8#1 = #30#26;
   |LEE 000#8=;
   |CIERRA #8;

   |SI #8#93 = "T"; |Y #8#126 = "L";
       nError = 0;
       |BUCLE Ventas_Per;
       |SI nError = 0;
           |BUCLE Compras_Per;
       |FINSI;
       |SI nError = 1;
           |MENAV "    Error en los periodos de Liquidacion Informados en Facturas";
           |CONFI "    SDesea recalcular ahora el Periodo de Liquidacion ";
           |SI FSalida = 0;
               |SUB_EJECUTA_NP "carecliq;AUTO";
           |SINO;
               |MENAV "    Proceso abortado";
               |ACABA;
           |FINSI;
       |FINSI;
   |FINSI;

   |ABRE #camac347;
   #camac347#0 = #30#2;
   |LEE 041#camac347.=;
   |SI FSalida = 0;
      |BUCLE BorraLins347;
      |BUCLE BorraLins348;
      |BORRA 020#camac347.a;
   |FINSI;
   |CIERRA #camac347;

   |ABRE #camic347;
   #camic347#0 = #30#2;
   |LEE 000#camic347.=;
   |SI FSalida = 0;
      |BUCLE BorraLInm347;
      |BORRA 020#camic347.a;
   |FINSI;
   |CIERRA #camic347;

   |ABRE #990;
   |ABRE #catmp347;
   |ABRE #caclipro;
   |ABRE #eosclipr;
   |ABRE #caprovin;

   alfa1  = enEjercicio;
   Comodin = "01.01." + alfa1; FechaIni = Comodin;
   Comodin = "31.12." + alfa1; FechaFin = Comodin;

   |SI dig1 ! 1;
      |PUSHV 0501 2380;
      |PINPA #0#cadatemp;
      |PINDA #0#cadatemp;
      |ENDATOS #1#cadatemp;
      |SI FSalida < 0; |ACABA; |FINSI;
      |DFICB Path;
      |QBF Path;
      Path = Path + (("00000" + #cadatemp#0) % -105);
      Path = Path + #cadatemp#1 + "/";
      Dobles = 1;
   |SINO;
      Dobles = 0;
   |FINSI;

   SwCont = 0;
   Linea  = 1;
   |BUCLE Ventas;
   |BUCLE Compras;
   |SI #0#194 ! "X";
       |BUCLE Diario;
   |FINSI;

   |SI Dobles = 1;
      |PATH_DAT #1 Path;
      |PATH_DAT #2 Path;
      |PATH_DAT #3 Path;
      |BUCLE Ventas;
      |BUCLE Compras;
      |SI #0#194 ! "X";
          |BUCLE Diario;
      |FINSI;
   |FINSI;
   |SI SwCont = 0; |ACABA; |FINSI;

   |CIERRA #catmp347;

   |ABRE #camal347;
   Linea = 1;
   |BUCLE PasaNif;
   |CIERRA #camal347;
   |CIERRA #990;

   |ABRE #camac347;
   |DDEFECTO #camac347;
   #camac347#0  = #30#2;
   #camac347#1  = #30#1;
   #camac347#6  = TotPersTipo2;
   #camac347#7  = TotalTipo2;
   #camac347#8  = TotPersTipo1;
   #camac347#9  = TotalTipo1;
   #camac347#10 = TotPersTipo3;
   #camac347#11 = TotalTipo3;
   #camac347#12 = TotPersTipo4;
   #camac347#13 = TotalTipo4;
   #camac347#14 = TotPersTipo5;
   #camac347#15 = TotalTipo5;
   #camac347#20 = TotPersTipo6;
   #camac347#21 = TotalTipo6;
   #camac347#22 = TotPersTipo7;
   #camac347#23 = TotalTipo7;


   #camac347#17 = #30#26;
   |SI TotalTipo1 ! 0; |O TotalTipo2 ! 0; |O TotalTipo3 ! 0; |O TotalTipo5 ! 0;
    |O TotalTipo6 ! 0; |O TotalTipo7 ! 0;
      |GRABA 010#camac347.n;
   |FINSI;
   |CIERRA #camac347;

   |CIERRA #caprovin;
   |CIERRA #eosclipr;
   |CIERRA #caclipro;
|FPRC;

|PROCESO separa;
  #11#6 = "";
  |SI #0#75 ! 0;
      |QBF direcc;
      alfa1 = direcc % 0;
      longi = alfa1;
      nume1 = #0#75 + 100;
      #11#6 = direcc % nume1;
      nume1 = ((longi - #0#75) + 100) * -1;
      direcc = direcc % nume1;
  |FINSI;
  #11#8 = "";
  |SI #0#76 ! " ";
      |QBF direcc;
      alfa1 = direcc % 0;
      longi = alfa1;
      |PARA nume4 = longi; |SI nume4 > 1; |HACIENDO nume4 = nume4 - 1;
            nume2 = (nume4 * 100) + 1;
            alfa2 = direcc % nume2;
            |SI alfa2 = #0#76;
                nume3 = ((longi - nume4) + 100) * -1;
                #11#8 = direcc % nume3;
                nume2 = (nume4 - 1) + 100;
                direcc = direcc % nume2;
                |SAL;
            |FINSI;
      |SIGUE;
  |FINSI;
  #11#7 = direcc;
|FPRC;

|PROGRAMA;

  |HAZ inicio;
  |HAZ eVarEmpresa;
  |SI enEjercicio < 2014;
      |SUB_EJECUTA "capas347";
      |PULSATECLA;
      |ACABA;
  |FINSI;

  |HAZ tipo_8; || controlar si existe la ficha de clientes

  |SI aste = "*";
      |C_M #0#74, 1,"N";
  |FINSI;

  |CLS;
  |CABEZA "Pase a Modelo 347";
  |ABRE #0;
  |LEE 141#0p;
  |SI FSalida ! 0;
      |DDEFECTO #0;
      |DDEFECTO #1347;
      |ABRE #1347;
      |LEE 041#1347p;
      |PARA nPara1 = 0; |SI nPara1 [ 193; |HACIENDO nPara1 = nPara1 + 1;
            #0nPara1 = #1347nPara1;
      |SIGUE;
      |PARA nPara1 = 205; |SI nPara1 [ 216; |HACIENDO nPara1 = nPara1 + 1;
            nPara2 = nPara1 - 11;
            #0nPara2 = #1347nPara1;
      |SIGUE;
      |CIERRA #1347;
      |GRABA 041#0b;
  |FINSI;

  |SI aste = "*";
      #0#74 = "N"; |C_M #0#74, 1,"N";
  |FINSI;

  |SI eaMoneda = "E";
      #0#1  = (500000 / 166.386) ! EURODB;
      #0#2  = (500000 / 166.386) ! EURODB;
      #0#78 = (50000 / 166.386)  ! EURODB;
      #0#98 = (500000 / 166.386) ! EURODB;
  |FINSI;

  |PINPA #0#0;
  |PINDA #0#0;
  |ENDATOS #2#0;
  |SI FSalida = 0;
      |HAZ Comienzo;
      |GRABA 001#0a;
  |FINSI;
  |CIERRA #0;
  |DELINDEX #999;
|FPRO;
