|FICHEROS;
     c3gem115 #00;
     caemi115 #10;
     caportad #01;
     catra115 #02;
     camar115 #04; || Resumen
     caman115 #20;
     canempre #30;
     caw00001 #99;
     camoneda #21;

     eosw0541 #541;
     eosw0601 #601,MANTE;
|FIN;

|VARIABLES;
    mensaje = "Imprimiendo ...";
    swtraba = 0;
    campo = 0;
    antes = 0;
    diferen = 0;
    desdemes = 0;
    hastames = 0;
    meses = 0;
    campotA1  = 0;
    campotB1  = 0;
    campotR1  = 0;
    campotA2  = 0;
    campotB2  = 0;
    campotR2  = 0;
    campobas1 = 0;
    camporet1 = 0;
    campoexen = 0;
    campobas2 = 0;
    camporet2 = 0;
    campobas3 = 0;
    camporet3 = 0;
    swsuma1   = 0;
    swsuma2   = 0;
    informe   = "";
    numf      = 0;
    se_factu  = "";
    se_perio  = 0;

    mas = 0;
    campofec = 0;
    p_mes = "";
    fecsys = @;
    alfa3 = "";
    alfa4 = "";
    mensa0= "    Proceso ABORTADO !!!";

    destra = 0;
    hastra = 0;
    d_cla = "";
    h_cla = "";
    nume0 = 0;
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;
    yaesta1 = 0;
    yaesta2 = 0;
    yaesta3 = 0;
    no_vale = 0;

    sw_acumula = 0;
    des_emp = 0;
    has_emp = 0;
    grupo = 0;
    atri = "";
    estado = 0;
    tiposel = "";
    CampoArchiv = 0;

   &periodo = 0;
   &perialf = "";
   &dia     = "";
   &mes     = "";
   &anyo    = "";

  sw_por = 0;
  d_emp = 0;
  h_emp = 99999;
  empcon = 0;
  ejecon = 0;
  leidos = 0;
  dirfich0 = "";
  emp1 = 0;
  per1 = 0;
  xx = 0;
  yy = 0;
  anu = 0;
  desde = 0;
  hasta = 0;
  x = 0;
  y = 0;
  varcamp = 0;
  &r_emp = 0;
  &r_per = 0;
  alfa1 = "";
  alfa2 = "";
  mesm = 0;
  men9 = "     Empresa Contable INACTIVA ";

     nIngreso     = 0;
     aMoneda      = "";

     nAnyo2D      = 0;
     aAlfa        = "";

     aAbre        = "";
     aModelos     = "";

     nTCampo      = 0;
     nHandle1     = 0;
     nHandle2     = 0;
     nSwHay       = 0;

     aAlfa1       = "";
     aUnidad      = "";

  {1}aContiene    = "";

     &eaMonedEmpre = "";
     &eaFOrigen    = "";
     &eaFDestino   = "";
     &eaInternet   = "";
     &eaImpresora  = "";
     &enNume       = 0;
     &eaAlfa       = "";
     &eaDiaB       = "";
     &eaMesB       = "";
     &eaAnyoB      = "";
     &eaModelos    = "";
     &eaUnidadBasico  = "";
|FIN;

|INCLUYE acceso_i;
|INCLUYE seguim_i;
|INCLUYE tempo_i;
|INCLUYE i_laserc;

|| *************************************************************************
||                        CALCULOS DE PANTALLA
|| *************************************************************************

|PROCESO TipoImpreso;  |TIPO 0;
     |SI #0#6 = "F";  |Y #0#3 [ 2001;
         |MENAV "     Tipo de Impreso Incorrecto.";
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO Mayus; |TIPO 0;
  #0Campo = #0Campo > #0Campo; |PINTA #0Campo;
|FPRC;

|PROCESO defecto; |TIPO 7;
     |SI #30#26 < 80;
         #0#3   = 2000 + #30#26;     |PINTA #0#3;
     |SINO;
         #0#3   = 1900 + #30#26;     |PINTA #0#3;
     |FINSI;
     aAlfa    = #0#3 % -102;
     nAnyo2D  = aAlfa;
|FPRC;

|PROCESO pintames; |TIPO 0;
     |SI #0#72 = "T";
         |SI #0Campo =  1;  p_mes = "1§ Trimes.";  |FINSI;
         |SI #0Campo =  2;  p_mes = "2§ Trimes.";  |FINSI;
         |SI #0Campo =  3;  p_mes = "3§ Trimes.";  |FINSI;
         |SI #0Campo =  4;  p_mes = "4§ Trimes.";  |FINSI;

         |SI #0Campo > 4;
             |MENAV  "        Periodicidad Trimestral";
             |ERROR;
             |ACABA;
         |FINSI;
     |SINO;
         |SI #0Campo =  1;  p_mes = "ENERO     ";  |FINSI;
         |SI #0Campo =  2;  p_mes = "FEBRERO   ";  |FINSI;
         |SI #0Campo =  3;  p_mes = "MARZO     ";  |FINSI;
         |SI #0Campo =  4;  p_mes = "ABRIL     ";  |FINSI;
         |SI #0Campo =  5;  p_mes = "MAYO      ";  |FINSI;
         |SI #0Campo =  6;  p_mes = "JUNIO     ";  |FINSI;
         |SI #0Campo =  7;  p_mes = "JULIO     ";  |FINSI;
         |SI #0Campo =  8;  p_mes = "AGOSTO    ";  |FINSI;
         |SI #0Campo =  9;  p_mes = "SEPTIEMBRE";  |FINSI;
         |SI #0Campo = 10;  p_mes = "OCTUBRE   ";  |FINSI;
         |SI #0Campo = 11;  p_mes = "NOVIEMBRE ";  |FINSI;
         |SI #0Campo = 12;  p_mes = "DICIEMBRE ";  |FINSI;
     |FINSI;
     |ATRI I;  |PINTA 0759, p_mes;  |ATRI 0;
|FPRC;

|PROCESO mirames; |TIPO 7; ||calcula el mes por defecto segun fecha sistema
  fecsys = ~;
  alfa1 = fecsys;
  alfa1 = alfa1 % 402;
  |SI alfa1 = "01"; #0Campo = 1; |FINSI;
  |SI alfa1 = "02"; #0Campo = 1; |FINSI;
  |SI alfa1 = "03"; #0Campo = 1; |FINSI;
  |SI alfa1 = "04"; #0Campo = 2; |FINSI;
  |SI alfa1 = "05"; #0Campo = 2; |FINSI;
  |SI alfa1 = "06"; #0Campo = 2; |FINSI;
  |SI alfa1 = "07"; #0Campo = 3; |FINSI;
  |SI alfa1 = "08"; #0Campo = 3; |FINSI;
  |SI alfa1 = "09"; #0Campo = 3; |FINSI;
  |SI alfa1 = "10"; #0Campo = 4; |FINSI;
  |SI alfa1 = "11"; #0Campo = 4; |FINSI;
  |SI alfa1 = "12"; #0Campo = 4; |FINSI;
  |PINTA #0Campo;
|FPRC;


|PROCESO mes;
  dia  = #0#4 % 102;
  mes  = #0#4 % 402;
  anyo = #0#4 % -101;

  |SI mes = "01"; mes = "Enero     "; |FINSI;
  |SI mes = "02"; mes = "Febrero   "; |FINSI;
  |SI mes = "03"; mes = "Marzo     "; |FINSI;
  |SI mes = "04"; mes = "Abril     "; |FINSI;
  |SI mes = "05"; mes = "Mayo      "; |FINSI;
  |SI mes = "06"; mes = "Junio     "; |FINSI;
  |SI mes = "07"; mes = "Julio     "; |FINSI;
  |SI mes = "08"; mes = "Agosto    "; |FINSI;
  |SI mes = "09"; mes = "Septiembre"; |FINSI;
  |SI mes = "10"; mes = "Octubre   "; |FINSI;
  |SI mes = "11"; mes = "Noviembre "; |FINSI;
  |SI mes = "12"; mes = "Diciembre "; |FINSI;
  mes = mes > mes;
|FPRC;

|PROCESO consulta;
  |SI FSalida ! 9;  |ACABA;  |FINSI;
  |SUB_EJECUTA "caconemp.run";
  |ERROR;
  |SI Campo = 8;
      #0#8 = r_emp;
      #0#10 = r_per;
      |PTEC 802;
      |PTEC 802;
  |FINSI;
  |SI Campo = 9;
      #0#9  = r_emp;
      #0#11 = r_per;
      |PTEC 802;
  |FINSI;
  |SI Campo ] 12;
      #0Campo = r_emp;
      varcamp = Campo + 20;
      #0varcamp = r_per;
      |PTEC 802;
      |PTEC 802;
  |FINSI;
|FPRC;

|PROCESO mayor1;
  |HAZ Mayus;
  |SI #0Campo = "N";
      |PARA x = 12;  |SI x [ 51;  |HACIENDO x = x + 1;
            |CAMPO_MODIFICA #0x,1,"S";
      |SIGUE;
      #0#8  = 0;
      #0#10 = 0;
      #0#9  = 0;
      #0#11 = 0;
      |CAMPO_MODIFICA #0#8,1,"N";
      |CAMPO_MODIFICA #0#10,1,"N";
      |CAMPO_MODIFICA #0#9,1,"N";
      |CAMPO_MODIFICA #0#11,1,"N";
      |PINTA #0#8;
      |PINTA #0#10;
      |PINTA #0#9;
      |PINTA #0#11;
  |SINO;
      |PARA x = 12;  |SI x [ 51;  |HACIENDO x = x + 1;
            #0x = 0;
            |CAMPO_MODIFICA #0x,1,"N";
      |SIGUE;
      |CAMPO_MODIFICA #0#8, 1,"S";
      |CAMPO_MODIFICA #0#10,1,"S";
      |CAMPO_MODIFICA #0#9, 1,"S";
      |CAMPO_MODIFICA #0#11,1,"S";
  |FINSI;
|FPRC;

|| --------------- comprueba desde-hasta empresas ---------------------------

|PROCESO lee_fijos;
  sw_por = 0;
  |ABRE #1;
  #1#0 = #30#2;
  #1#1 = #30#26;
  |LEE 001#1=;
  |SI FSalida ! 0;
      |DDEFECTO #1;
      sw_por = 1;
  |FINSI;
  |CIERRA #1;
|FPRC;

|PROCESO buscaem1;
  sw_por = 0
  |SI #30#21 = "I"; |ACABA;  |FINSI;
  |SI #30#26 ! nAnyo2D; |ACABA; |FINSI;
  || .... comprobar que es empresa con 115
  |DBASE dir_fich;
  dirfich0 = dir_fich + "fich/";
  alfa1 = #30#2;
  alfa2 = #30#3;
  emp1 = #30#2;
  per1 = #30#3;
  alfa1 = "00000" + alfa1;   alfa1 = alfa1 % -105;
  alfa2 = "0"   + alfa2;   alfa2 = alfa2 % -101;
  dirfich0 = dirfich0 + alfa1 + alfa2 + "/";
  |PATH_DAT #1 dirfich0;
  |HAZ lee_fijos;
  leidos = 1;
|FPRC;

|DEFBUCLE buscaempre;
 #30#1;
;
#0#8,#0#10;
#0#9,#0#11;
e;
NULL,buscaem1;
|FIN;

|PROCESO buclempre;
  |SI #0#10 > #0#11;
      |MENAV "     ERROR EN INTRODUCCION";
      |ERROR;
      |ACABA;
  |FINSI;
  |SI #0#8 = 0;  |Y #0#9 = 0;  |ACABA;  |FINSI;
  leidos = 0;
  |BUCLE buscaempre;
  |SI leidos = 0;
      |MENAV "    ATENCION SELECCION VACIA";
      |ERROR;
      |ACABA;
  |FINSI;
|FPRC;

|PROCESO deshas;
  |SI #0#9 < #0#8;
      |MENAV "      Error en Introduccion";
      |ERROR;
  |FINSI;
|FPRC;

|PROCESO nomodi;
  |PARA x = Campo + 1;  |SI x [ 31;  |HACIENDO x = x + 1;
        #0x = 0;
        |CAMPO_MODIFICA #0x,1,"N";
        y = x + 20;
        #0y = 0;
        |CAMPO_MODIFICA #0y,1,"N";
  |SIGUE;
  y = Campo + 20;
  #0y = 0;
  |CAMPO_MODIFICA #0y,1,"N";
  |PINTA #0y;
|FPRC;

|PROCESO esbuena; || desde campo de empresas seleccion
  |SI FSalida = 2; |ACABA; |FINSI;
  |SI #0Campo = 0; |HAZ nomodi;  |ACABA;  |FINSI;
  |ABRE #30;
  #30#2 = #0Campo;
  #30#3 = 0;
  |LEE 011#30];
  |SI FSalida ! 0;  |O #30#2 ! #0Campo;
      |MENAV "     NO Existe la empresa Contable ";
      |ERROR;
  |FINSI;
  |CIERRA #30;
|FPRC;

|PROCESO esbuena1;
  |SI FSalida = 2;|ACABA;|FINSI;
  x = Campo - 20;
  |SI #0x = 0;  |ACABA;  |FINSI;
  |ABRE #30;
  x = Campo - 20;
  #30#2 = #0x;
  #30#3 = #0Campo;
  |LEE 011#30=;
  |SI FSalida ! 0;
      |MENAV "     NO Existe Periodo en la empresa Contable ";
      |CIERRA #30;
      |ERROR;
      |ACABA;
  |FINSI;
  |CIERRA #30;
  |SI #30#21 = "I";
      |MENAV men9;
      |ERROR;
      |ACABA;
  |FINSI;

  leidos = 0;
  |HAZ buscaem1;
  |SI leidos = 0;
      |SI sw_por = 1;
          |MENAV "     No existe datos de Portadas ";
      |SINO;
          |MENAV "     El a¤o contable NO esta dentro de la seleccion ";
      |FINSI;
      |ERROR;
      |ACABA;
  |FINSI;
  x = Campo + 20;
  #0x = #30#1;
  |PINTA #0x;
  x = Campo - 20;
  alfa1 = #0x;
  alfa2 = #0Campo;
|FPRC;

|| Secuencial del Modelo 115

|PROCESO Valor6;
     nCanti = nCanti ! 0;
     |SI nCanti ] 0;
         aCanti = nCanti;
         aCanti = ("000000" + aCanti) % -106;
     |SINO;
         nCanti = -nCanti;
         aCanti = nCanti;
         aCanti = "N" + (("00000" + aCanti) % -105);
     |FINSI;
|FPRC;

|PROCESO Valor12;
     |SI eaMonedEmpre = "P";
        |SI eaMoneda = "P";
           nCanti = nCanti ! 0;
        |SINO;
           nCanti = ((nCanti / 166.386) ! 2) * 100;
        |FINSI;
     |SINO;
        |SI eaMoneda = "P";
           nCanti = (nCanti / 166.386) ! 2;
        |SINO;
           nCanti = nCanti * 100;
        |FINSI;
     |FINSI;

     |SI nCanti ] 0;
         aCanti = nCanti;
         aCanti = ("000000000000" + aCanti) % -112;
     |SINO;
         nCanti = -nCanti;
         aCanti = nCanti;
         aCanti = "N" + (("00000000000" + aCanti) % -111);
     |FINSI;
|FPRC;

|PROCESO Carga1152001;
     |DDEFECTO #99;

     #99#4  = (("00" + #1#16) % -102) + (("000" + #1#17) % -103);

     Valfa  = #1#13; |QBF Valfa;
     #99#5  = ("000000000" + Valfa) % -109;
     #99#6  = #1#2;
     #99#8  = #1#3;
     #99#9  = #1#4;
     #99#10 = #1#5;
     #99#11 = #1#6;
     #99#12 = #1#7;
     #99#13 = #1#8;
     #99#14 = (("00" + #1#9) % -102) + (("000" + #1#10) % -103);
     #99#15 = #1#11;
     #99#16 = #1#12;
     #99#17 = #1#14;
     #99#18 = #0#3;
     |SI #0#3 [ 1998;
         #99#18 = nAnyo2D;
     |FINSI;
     #99#19 = perialf;

     nCanti = #10#12;   |HAZ Valor6;   #99#20 = aCanti;
     nCanti = #10#13;   |HAZ Valor12;  #99#21 = aCanti;
     nCanti = #10#14;   |HAZ Valor12;  #99#22 = aCanti;
     nCanti = #10#15;   |HAZ Valor6;   #99#23 = aCanti;
     nCanti = #10#16;   |HAZ Valor12;  #99#24 = aCanti;
     nCanti = #10#17;   |HAZ Valor12;  #99#25 = aCanti;
     nCanti = #10#18;   |HAZ Valor12;  #99#26 = aCanti;

     #99#27 = dia;
     #99#28 = mes;
     #99#29 = #10#4 % -104;
     nCanti = #10#18;  |HAZ Valor12;  #99#32 = aCanti;
     #99#33 = #1#66;
     #99#34 = #1#67;
     #99#35 = #1#68;
     #99#36 = #1#69;
     #99#37 = &13 + &10;
|FPRC;

|PROCESO Secuencial115_2001;
     Raiz       = "";  |DIRECTORIO Raiz;
     Directorio = "";
     |DBASE Directorio;
     Directorio = Directorio + "hacienda/" + eaTipoSec;
     |MKDIR Directorio;
     Directorio = Directorio + "/";
     Valfa = Raiz + "bin/agichmod 777 " + Directorio;

     Empresa  = ("00000" + #1#0) % -105;

     Fichero    = eaTipoSec + Empresa;
     INEmpresas = NEmpresas1 <-;
     INEmpresas = INEmpresas + NACopiar;
     NFichero   = Directorio + Fichero;          |QBF NFichero;
     NEmpresas  = NFichero;
     NACopiar   = NACopiar + 1;

     Fichero  = "wb  "+ NFichero;

     Pos = -1;
     |FABRE Fichero;
     Handle = FSalida;
     |SI FSalida ] 0;
         |HAZ Carga1152001;
         |PARA nCampo = 1;  |SI nCampo [ 37;  |HACIENDO nCampo = nCampo + 1;
               Cadena = Handle + " " + #99nCampo;
               |FGRABA Cadena;
         |SIGUE;
     |FINSI;
     FSalida = Handle;
     |FCIERRA FSalida;
|FPRC;

|PROCESO CargaImprime;
     aAlfa = "del err" + (("00000" + #1#0) % -105) + ".TXT" + &13 + &10;
     |XGRABA nHandle1, aAlfa;

     aAlfa = "wait mipf32 ";
     aAlfa = aAlfa + "/E:115" + (("00000" + #1#0) % -105) + ".TXT ";
     aAlfa = aAlfa + "/R:err" + (("00000" + #1#0) % -105) + ".TXT ";
     |SI eaImpresora ! "";
         aAlfa = aAlfa + "/I:" + &34 + eaImpresora + &34;
     |FINSI;
     aAlfa = aAlfa + " /C:" + #601#0;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle1, aAlfa;

     aAlfa = "DEL " + "115" + (("00000" + #1#0) % -105) + ".TXT ";
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle1, aAlfa;
|FPRC;

|PROCESO TDeclaracion;
     nIngreso  = #10#14 + #10#17;
     |SI nIngreso > 0;
         enNume  = nIngreso;  |HAZ Conver13;  #541#37 = eaAlfa;

         |SI #0#73 = "S";  |O #0#73 = "D";
             |SI #1#69 = "          ";
                 #541#35  = "X";
             |SINO;
                 #541#36 = "X";
                 #541#38 = #1#66;
                 #541#39 = #1#67;
                 #541#40 = #1#68;
                 #541#41 = #1#69;
             |FINSI;
         |SINO;
             #541#35  = "X";
         |FINSI;
     |SINO;
         enNume  = 0;  |HAZ Conver13;  #541#37 = eaAlfa;
     |FINSI;

     #541#4 = "";
     |SI #10#6 = "F";
         |SI nIngreso > 0;
                                                   #541#4 = "I";
             |SI  #0#19   = "A";                   #541#4 = "A";  |FINSI;
             |SI  #0#19   = "E";                   #541#4 = "E";  |FINSI;
             |SI  #541#36 = "X";  |Y #0#73 = "D";  #541#4 = "U";  |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Carga1152002;
     |SI #10#6 = "L";
         aAbre = eaUnidadBasico + "\MODELOS\115\" + "115" + (("00000" + #1#0) % -105) + ".TXT";
         |XABRE "CBW", aAbre, nHandle2;
     |FINSI;

     |SI #10#6 = "F";
         aAbre = eaInternet + "115" + (("00000" + #1#0) % -105) + ".TXT";
         |XABRE "CBW", aAbre, nHandle2;
     |FINSI;

     |DDEFECTO #541;

     #541#1   = "115";
     #541#2   = "01";
     #541#3   = "";

     #541#5   = (("00" + #1#16) % -102) + (("000" + #1#17) % -103);
     aAlfa    = #1#13;  |QBF aAlfa;
     #541#6   = ("000000000" + aAlfa) % -109;
     eaAlfa   = #1#2;    |HAZ QuitaRaros;     #541#8   = eaAlfa;
     #541#9   = ".";
     eaAlfa   = #1#3;    |HAZ QuitaRaros;     #541#10  = eaAlfa;
     eaAlfa   = #1#4;    |HAZ QuitaRaros;     #541#11  = eaAlfa;
     #541#12  = #1#5;
     #541#13  = #1#6;
     #541#14  = #1#7;
     #541#15  = #1#8;
     eaAlfa   = #1#14;   |HAZ QuitaRarosTfno; #541#16 = eaAlfa;
     eaAlfa   = #1#11;   |HAZ QuitaRaros;     #541#17  = eaAlfa;
     eaAlfa   = #1#12;   |HAZ QuitaRaros;     #541#18  = eaAlfa;
     #541#19  = (("00" + #1#9) % -102) + (("000" + #1#10) % -103);

     #541#20  = #10#3;
     #541#21  = perialf;

     enNume  = #10#12 + #10#15;
     #541#22 = ("000000" + enNume) % -106;
     enNume  = #10#13 + #10#16;   |HAZ Conver13;  #541#23 = eaAlfa;
     enNume  = #10#14 + #10#17;   |HAZ Conver13;  #541#24 = eaAlfa;
                                                  #541#26 = eaAlfa;

     |HAZ TDeclaracion;

     eaAlfa  = #1#89;         |HAZ QuitaRaros;     #541#29  = eaAlfa;
     eaAlfa  = #1#90 + #1#91; |HAZ QuitaRarosTfno; #541#30  = eaAlfa;

     eaAlfa  = #10#4;   |HAZ FechaBonito;
     #541#42 = eaDiaB;
     #541#43 = eaMesB;
     #541#44 = eaAnyoB;
     #541#45 = &13 + &10;

     |SI #10#6 = "L";
         #541#4  = "";
         #541#7  = "";
         #541#27 = "";
         #541#29 = "";
         #541#30 = "";
         #541#31 = "";
         nTCampo = 45;
     |FINSI;

     |SI #10#6 = "F";
         #541#2  = "";
         #541#3  = "";
         #541#5  = "";
         #541#8  = "";
         #541#9  = "";
         #541#10 = "";
         #541#11 = "";
         #541#12 = "";
         #541#13 = "";
         #541#14 = "";
         #541#15 = "";
         #541#16 = "";
         #541#17 = "";
         #541#18 = "";
         #541#19 = "";
         #541#42 = "";
         #541#43 = "";
         #541#44 = "";
         #541#45 = "";
         nTCampo = 44;
     |FINSI;

     aAlfa = "";
     |PARA nCampo = 1;  |SI nCampo [ nTCampo;  |HACIENDO nCampo = nCampo + 1;
           aAlfa = #541nCampo;
           |XGRABA nHandle2, aAlfa;
     |SIGUE;
     |XCIERRA nHandle2;

     |SI #10#6 = "L";
         |HAZ CargaImprime;
     |FINSI;

     nSwHay = 1;
|FPRC;


_____________________________________/ CARGA DEL TEMPORAL POR NIF's
|PROCESO por_dnis2;
  |DDEFECTO #2;
  #2#0  = #20#0;
  #2#7  = #20#7;       || dni
  |LEE 101#2=;
  estado = FSalida;
  #2#12 = 1;  #2#13 = 2;

  nume3 = 0; |SI #20#12 = 2; nume3 = 26; |FINSI;
  |PARA nume1 = 23; |SI nume1 [ 48; |HACIENDO nume1 = nume1 + 1;
        nume2 = nume1 + nume3;
        #2nume2 = #2nume2 + #20nume1;
  |SIGUE;

  nume3 = 0; |SI #20#13 = 1; nume3 = - 26; |FINSI;
  |PARA nume1 = 49; |SI nume1 [ 74; |HACIENDO nume1 = nume1 + 1;
        nume2 = nume1 + nume3;
        #2nume2 = #2nume2 + #20nume1;
  |SIGUE;

  #2#0  = #20#0;
  #2#7  = #20#7;       || dni
  |SI estado = 0;  |GRABA 000#2a;  |FINSI;
  |SI estado ! 0;  |GRABA 000#2n;  |FINSI;
  |LIBERA #2;
|FPRC;

|DEFBUCLE temporal;
  #20#1;
  135;
  #10#0, 00000, nAnyo2D, "5";
  #10#0, 99999, nAnyo2D, "5";
  be;
  NULL, por_dnis2;
|FIN;

|| -----------------------------------------------------------
|PROCESO por_dnis;
  |PINTA 2405, "Preparando Temporal por NIF's ... ";
  |ABRE #2;  |CIERRA #2;  |DELINDEX #2;

  |NOPARA;
  |ABRE #2;
  |BUCLE temporal;
  |CIERRA #2;
  |SIPARA;
  |PINTA 2405, "                                  ";
|FPRC;

|PROCESO borrar;
 |PDEFECTO #10,12,19;
 |PARA meses = desdemes; |SI meses [ hastames;  |HACIENDO meses = meses + 1;
       campotA1 = meses + 3;  campotA2 = meses + 39;
       campotB1 = meses + 15; campotB2 = meses + 51;
       campotR1 = meses + 27; campotR2 = meses + 63;

       #4campotA1 = 0; #4campotB1 = 0; #4campotR1 = 0;
       #4campotA2 = 0; #4campotB2 = 0; #4campotR2 = 0;
  |SIGUE;
|FPRC;

|PROCESO lasuma;
 swsuma1 = 0;
 swsuma2 = 0;
 |PARA meses = desdemes; |SI meses [ hastames;  |HACIENDO meses = meses + 1;
        campobas1 = meses +  22;
        camporet1 = meses +  35;
        campobas2 = meses +  48;
        camporet2 = meses +  61;

       campotA1 = meses + 3;  campotA2 = meses + 39;
       campotB1 = meses + 15; campotB2 = meses + 51;
       campotR1 = meses + 27; campotR2 = meses + 63;

       #4campotB1 = #4campotB1 + #2campobas1;   || total bases  1
       #4campotR1 = #4campotR1 + #2camporet1;   || total reten. 1
       |SI #2campobas1 ! 0; |O #2camporet1 ! 0;
           #4campotA1 = #4campotA1 + 1;
       |FINSI;

       #4campotB2 = #4campotB2 + #2campobas2;   || total bases  2
       #4campotR2 = #4campotR2 + #2camporet2;   || total reten. 2
       |SI #2campobas2 ! 0; |O #2camporet2 ! 0;
           #4campotA2 = #4campotA2 + 1;
       |FINSI;

       #10#13 = #10#13 + #2campobas1;   || total bases  1
       #10#14 = #10#14 + #2camporet1;   || total reten. 1
       |SI #2campobas1 ! 0; |O #2camporet1 ! 0;
           swsuma1 = 1;
       |FINSI;
       #10#16 = #10#16 + #2campobas2;   || total bases  2
       #10#17 = #10#17 + #2camporet2;   || total reten. 2
       |SI #2campobas2 ! 0; |O #2camporet2 ! 0;
           swsuma2 = 1;
       |FINSI;
  |SIGUE;

  |SI swsuma1 = 1; #10#12 = #10#12 + 1; |FINSI;
  |SI swsuma2 = 1; #10#15 = #10#15 + 1; |FINSI;
  #10#18 = #10#14 + #10#17;
  swtraba = 1;
|FPRC;

|DEFBUCLE altas;
  #2#1;
  ;
  #10#0, "            ";
  #10#0, "zzzzzzzzzzzz";
  ;
  NULL, lasuma;
|FIN;

|PROCESO leyendo;
  #4#0 = #10#0;
  #4#2 = nAnyo2D;
  |LEE 101#4=;
  |SI FSalida ! 0;
      |DDEFECTO #4;
      #4#0 = #10#0;
      #4#1 = #10#1;
      #4#2 = nAnyo2D;
      |GRABA 020#4b;
  |FINSI;
  desdemes = 0;
  hastames = 0;
  |SI #10#8 = "T";
      |SI #10#2 =  1; desdemes =  1; numf = 78; perialf = "1T"; |FINSI;
      |SI #10#2 =  2; desdemes =  4; numf = 81; perialf = "2T"; |FINSI;
      |SI #10#2 =  3; desdemes =  7; numf = 84; perialf = "3T"; |FINSI;
      |SI #10#2 =  4; desdemes = 10; numf = 87; perialf = "4T"; |FINSI;
      hastames = desdemes + 2;
      enPer = #10#2;
  |SINO;
      desdemes = #10#2;
      hastames = #10#2;
      numf     = 76;
      perialf  = ("00" + #10#2) % -102;
      enPer = #10#2;
  |FINSI;
  |HAZ borrar;
  no_vale = 0;
  swtraba = 0;  || switch para saber si hay trabajadores
  |BUCLE altas;  || lectura de los trabajadores
  |SI swtraba = 0;  |LIBERA #4;  |ACABA;  |FINSI;
  |SI #10#18   = 0;  |Y #10#10 = "N";  |LIBERA #4;  |ACABA;  |FINSI;
  |SI #10#6 = "O";  |O #10#6 = "B";
      |SI #10#6 = "O"; informe = "caemi115"; |FINSI;
      |SI #10#6 = "B"; informe = "caemb115"; |FINSI;
      |INFOR informe;
      |SI FSalida ! 0;  |FINIMP;  |LIBERA #4;  |ACABA;  |FINSI;
      |PRINT;   |PIEINF;   |FININF;
  |SINO;
      |SI #0#3 [ 2001;
          |HAZ Secuencial115_2001;
      |FINSI;

      |SI #0#3 ] 2002;
          |HAZ Carga1152002;
      |FINSI;
  |FINSI;

  |SI #10#6 = "B";  |LIBERA #4;  |ACABA; |FINSI;

  #4numf = #10#4;
  |GRABA 020#4a;
  |LIBERA #4;

  se_empre  = #10#0;
  se_ejerc  = nAnyo2D;
  se_modelo = "115";
  se_impor  = #10#18;
  se_fecha  = #10#4;
  se_perio  = #10#2;
  se_factu  = "N";
  |SI SwAgicli = 1;  |HAZ AlAgicl2;  |FINSI;
|FPRC;

|| ***************************************************************

|PROCESO haztodo;
  aMoneda     = eaMoneda;
  enEmpresa   = #canempre#2;
  enPeriodo   = #canempre#3;
  swOperacion = 0
  |SUB_EJECUTA "camoneda.tab";
  eaMoneda    = aMoneda;

   eaMonedEmpre = "P";
   |SI #0#3 ] 2001;
       |SI #0#6 = "L";  |O #0#6 = "F";
           |ABRE #camoneda;
           #camoneda#0 = #canempre#2;
           #camoneda#1 = #canempre#3;
           |LEE 000#camoneda.=;
           |SI FSalida = 0;
               eaMonedEmpre = #camoneda#2;
           |FINSI;
           |CIERRA #camoneda;
      |FINSI;
   |FINSI;

  |PATH_DAT #1  dirfich0;
  |PATH_DAT #4  dirfich0;
  |PATH_DAT #20 dirfich0;

  anu = 1900 + #30#26;
  |SI anu [ 1970;  anu = anu + 100;  |FINSI;
  empcon = #30#1;
  ejecon = #30#26;

  #0#0 = #30#2; #0#1 = #30#1;

  |DDEFECTO #10;
  #10#0  = #0#0;
  #10#1  = #0#1;
  #10#2  = #0#2;
  #10#3  = #0#3;
  #10#4  = #0#4;
  #10#5  = #0#5;
  #10#6  = #0#6;
  #10#8  = #0#72;
  #10#19 = #0#73;

  |HAZ lee_fijos;

  |SI sw_por = 0;
      des_emp = #0#0;
      has_emp = #0#0;
      |HAZ por_dnis;
      |ABRE #4;
      |HAZ leyendo;
      |CIERRA #4;
      |DELINDEX #2;
  |FINSI;
|FPRC;

|| ---------- Seleccion en parrilla.
|PROCESO esunaauna;
  |PARA xx = 12;  |SI xx [ 31;  |HACIENDO xx = xx + 1;
        |SI #0xx = 0;  |SAL;  |FINSI;
        |DBASE dir_fich;
        dirfich0 = dir_fich + "fich/";
        yy = xx + 20;
        emp1 = #0xx;
        per1 = #0yy;
        alfa1 = #0xx;
        alfa2 = #0yy;
        alfa1 = "00000" + alfa1;   alfa1 = alfa1 % -105;
        alfa2 = "0"   + alfa2;   alfa2 = alfa2 % -101;
        dirfich0 = dirfich0 + alfa1 + alfa2 + "/";
|| lee empresa
        |ABRE #30;
        #30#2 = emp1;
        #30#3 = per1;
        |LEE 011#30=;
        |CIERRA #30;
        |SI #30#26 ! nAnyo2D; |O #30#21 = "I";
            |VETE otramas;
        |FINSI;
        |HAZ haztodo;
|ET otramas;
  |SIGUE;
|FPRC;

|| ---------- Seleccion DESDE / HASTA Empresa.

|PROCESO esdesd1;
  |DBASE dir_fich;
  dirfich0 = dir_fich + "fich/";
  alfa1 = #30#2;
  alfa2 = #30#3;
  emp1  = #30#2;
  per1  = #30#3;
  alfa1 = "00000" + alfa1;   alfa1 = alfa1 % -105;
  alfa2 = "0"   + alfa2;   alfa2 = alfa2 % -101;
  dirfich0 = dirfich0 + alfa1 + alfa2 + "/";

  |SI #30#26 ! nAnyo2D; |O #30#21 = "I";
      |ACABA;
  |FINSI;

  |HAZ haztodo;
|FPRC;

|DEFBUCLE esdesde;
#30#1;
;
#0#8,#0#10;
#0#9,#0#11;
e;
NULL,esdesd1;
|FIN;

|PROCESO Impresora;
   |IMPRE 0;
   |SI FSalida ! 0; |ACABA; |FINSI;

   |HAZ AlAgicl1;
   |HAZ mes;
   |HAZ nom_usu;
   alfa1 = "b" + nom_tmp;
   |NOME_DAT #2 alfa1;

   |SI #0#7 = "S";
       |BUCLE esdesde;
   |SINO;
       |HAZ esunaauna;
   |FINSI;
   |FINIMP;
|FPRC;

|PROCESO AbreImprime;
     aAbre = eaUnidadBasico + "\MODELOS\115\imprime.bat";
     |XABRE "CBW", aAbre, nHandle1;

     aAlfa = eaUnidadBasico + &13 + &10;                        |XGRABA nHandle1, aAlfa;
      aAlfa = "CD " + eaUnidadBasico + "\MODELOS" + &13 + &10;  |XGRABA nHandle1, aAlfa;
     aAlfa = "CD 115" + &13 + &10;                              |XGRABA nHandle1, aAlfa;

     aAlfa = #0#3;
     aAlfa = aAlfa % -102;
     aVersion = "";

     |SI #0#3 ] 2008;
         aVersion = "01";
         |SI #0#3 = 2008;
             |SI #0#2 ] 2; |Y #0#72 = "T";
                 aVersion = "02";
             |FINSI;
             |SI #0#2 ] 6; |Y #0#72 = "M";
                 aVersion = "02";
             |FINSI;
         |FINSI;
     |FINSI;

     aAlfa1 = "DEL ERRORES.RST" + &13 + &10;      |XGRABA nHandle1, aAlfa1;

     aContiene = "";
     |ESPECIFICA "RBASS", aContiene;
     aUnidad = (aContiene1 % 102) > "";

     |SI aVersion = "";
         aAlfa = "ZLS" + aAlfa + "MPF.EXE /T:" + aUnidad + "\MODELOS\115\"+ &13 + &10;
     |SINO;
         aAlfa = "Z" + aAlfa + aVersion + "MPF.EXE /T:" + aUnidad + "\MODELOS\115\"+ &13 + &10;
     |FINSI;

     |XGRABA nHandle1, aAlfa;

     |SI #0#3 ] 2002;
         aAlfa = "MOVE ERRORM~1.TXT ERRORMIPF.TXT" + &13 + &10;      |XGRABA nHandle1, aAlfa;
         aAlfa = "MOVE EAN128~1.DLL EAN128_32.DLL" + &13 + &10;      |XGRABA nHandle1, aAlfa;
     |FINSI;
|FPRC;

|PROCESO EmiteEsto;
     aAlfa = "DEL *.wmf" + &13 + &10;             |XGRABA nHandle1, aAlfa;
     aAlfa = "DEL *.tab"  + &13 + &10;            |XGRABA nHandle1, aAlfa;
     aAlfa = "DEL *.dll"  + &13 + &10;            |XGRABA nHandle1, aAlfa;
     aAlfa = "DEL errorm~1.txt" + &13 + &10;      |XGRABA nHandle1, aAlfa;
     aAlfa = "DEL errormipf.txt"  + &13 + &10;    |XGRABA nHandle1, aAlfa;
     aAlfa = "DEL errmipf.txt"  + &13 + &10;      |XGRABA nHandle1, aAlfa;
     aAlfa = "DEL *.exe"  + &13 + &10;            |XGRABA nHandle1, aAlfa;
     |XCIERRA nHandle1;

     eaModelos = "115";   |HAZ Copiampf;

     aAlfa = eaUnidadBasico + "\MODELOS\115\IMPRIME";
     |RSYSTEM aAlfa;
|FPRC;

|PROCESO Laser;
     |HAZ AlAgicl1;
     |HAZ mes;
     |HAZ nom_usu;
     alfa1 = "b" + nom_tmp;
     |NOME_DAT #2 alfa1;

     eaMoneda  = "P";
     |SI #0#3 = 2001;
         |PUSHV 1921 2155;
         |BLANCO 1921 2155;
         |CUADRO 1923 2153;
         |ATRI R; |PINTA 1924 , " Seleccione moneda de emision "; |ATRI N;
         |PINTA 2031, "(Pesetas/Euros)";
         |ATRI I; |PINTA 2032, "P"; |PINTA 2040, "E"; |ATRI N;
         E_sup   = 1;
         E_i nf  = "EP";
         eaMoneda  = "P";
         eaMoneda  = 2047 ? 0;
         |POPV;
     |FINSI;

     |SI #0#3 ] 2002;
         eaMoneda  = "E";
     |FINSI;

     |SI #0#3 ] 2002;
         |SI #0#6 = "L";
             |PARA;  |SI;  |HACIENDO;
                  |DDEFECTO #601;
                  |PINPA #0#601;
                  |PINDA #0#601;
                  |ENDATOS #1#601;
                  |SI FSalida = 0;
                      aAlfa = eaUnidadBasico + "/MODELOS";          |RMKDIR aAlfa;
                      aAlfa = eaUnidadBasico + "/MODELOS/115";      |RMKDIR aAlfa;
                      |HAZ AbreImprime;
                      |SAL;
                  |FINSI;
             |SIGUE;
          |FINSI;

          |SI #0#6 = "F";
              aAlfa      = eaUnidadBasico + "/AEAT";                       |RMKDIR aAlfa;
              aAlfa      = eaUnidadBasico + "/AEAT/INTERNET";              |RMKDIR aAlfa;
              aAlfa      = eaUnidadBasico + "/AEAT/INTERNET/115";          |RMKDIR aAlfa;
              aAlfa      = eaUnidadBasico + "/AEAT/INTERNET/115/" + #0#3;  |RMKDIR aAlfa;
              eaInternet = aAlfa + "/";
          |FINSI;
     |FINSI;

     nSwHay = 0;

     |SI #0#7 = "S";
         |BUCLE esdesde;
     |SINO;
         |HAZ esunaauna;
     |FINSI;

     |SI #0#6 = "L";
         |SI #0#3 [ 2001;
             |HAZ GrabaDisketteL;
         |FINSI;

         |SI #0#3 ] 2002;
             |SI nSwHay = 1;
                 |HAZ EmiteEsto;
                 eaTipoSec = "115";
                 eaTipoEmi = "ERRORES";
                 enAnyo    = #0#3;
                 |SUB_EJECUTA "eosz9999";
             |SINO;
                 |MENAV "     Seleccion Vacia";
                 |XCIERRA nHandle1;
             |FINSI;

             aAlfa = eaUnidadBasico + "\MODELOS\115\imprime.bat";
             |RFBORRA aAlfa;
         |FINSI;
     |FINSI;

     |SI #0#6 = "F";  |Y #0#3 ] 2002;
         |SI nSwHay = 1;
             aAlfa =  "      Ficheros Generados. Situados en " + eaInternet + " de su PC";
             |MENAV aAlfa;
         |SINO;
             |MENAV "     Seleccion Vacia";
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO impre; |TIPO 3;
     |HAZ LeeUnidadBasico;

     aAlfa     = #0#3 % -102;
     nAnyo2D   = aAlfa;
     enAnyo    = #0#3;
     eaTipoSec = "115";
     aTipoSec  = "115";
     enPer     = #0#2;

     |SI #0#6 = "L"; |O #0#6 = "F";  |HAZ Laser;      |FINSI;
     |SI #0#6 = "O"; |O #0#6 = "B";  |HAZ Impresora;  |FINSI;
|FPRC;
