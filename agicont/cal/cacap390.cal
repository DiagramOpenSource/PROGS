|FICHEROS;
  cacap390 #0;

  caman300 #1; || en 300 #2
  caman303 #303;
  caportad #2; || en 300 #8

  cama3390 #3;
  cama4390 #490;
  cama5390 #590;

  caivarep #4;         || repercutido
  caivasop #5;         || soportado
  cacon300 #7;         || conceptos IVA

  eosma100 #100;
  desglose@  #1100;
|FIN;

|VARIABLES;
  swant = 0;
  modo = 0;
  anyo = 0;
  compens = 0;
  alfa1 = "";
  alfa2 = "";
  alfa3 = "";
  nume1 = 0;
  nume2 = 0;
  nume3 = 0;
  a = 0;
  b = 0;
  c = 0;
  empr  = 0;
  x1 = 0;
  x2 = 0;
  x3 = 0;
  x4 = 0;
  x5 = 0;
  tot_bas = 0;

  nOk          = 0;
  x            = 0;
  y            = 0;
  nCampo       = 0;
  nCampo1      = 0;
  nCampo2      = 0;
  nTotalBase1  = 0;
  nTotalBase2  = 0;
  nTotalBase3  = 0;
  nTotalBase4  = 0;
  nTotalBase5  = 0;
  nTotalBase6  = 0;
  nTotalBase7  = 0;
  nTotalCuota1 = 0;
  nTotalCuota2 = 0;
  nTotalCuota3 = 0;
  nTotalCuota4 = 0;
  nTotalCuota5 = 0;
  nTotalCuota6 = 0;
  nTotalCuota7 = 0;

  nTotalBas11  = 0;
  nTotalBas12  = 0;
  nTotalBas13  = 0;
  nTotalBas14  = 0;
  nTotalBas15  = 0;
  nTotalBas16  = 0;
  nTotalCuot11 = 0;
  nTotalCuot12 = 0;
  nTotalCuot13 = 0;
  nTotalCuot14 = 0;
  nTotalCuot15 = 0;
  nTotalCuot16 = 0;
  nTotalCuot17 = 0;

  enEjer       = 0;
  nTecla       = 0;
  nCampoDes    = 0;
  nError       = 0;
  aBase        = "";
  aMas         = "";
  nPara1       = 0;
  nPara2       = 0;
  nPara3       = 0;
  nPara11      = 0;
  nPara22      = 0;
  nPara33      = 0;

  nCampo303    = 0;
  nCampo390    = 0;
  nSwAcum      = 0;
  nHay         = 0;
  nHay100      = 0;
  nHay2_18     = 0;
  nIVA         = 0;
  nBase        = 0;
  nCuota       = 0;
  nNume1       = 0;
  nNume2       = 0;

  nCopia       = 0;
  nSwRe1       = 0;
  nSwSo1       = 0;
|FIN;

|INCLUYE acceso_i;

|| ***********************************************************************
|PROCESO Pantalla;
  alfa1 = "S";
  alfa2 = "Cuo.dedu. con tipos no vigentes";
  alfa3 = "³  Rectificacion de deducciones...³           º           ³";
  |C_P #0#75, 1, 2338;  |C_P #0#76, 1, 2350;
  |C_P #0#77, 1, 2238;  |C_P #0#78, 1, 2250;
  |SI #0#0 < 18;
      alfa1 = "N";
      alfa2 = "Rectificacion de deducciones...";
      alfa3 = "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÐÄÄÄÄÄÄÄÄÄÄÄÙ";
      |C_P #0#75, 1, 2238;  |C_P #0#76, 1, 2250;
  |FINSI;
  |C_V #0#77,1,alfa1; |C_V #0#78,1,alfa1;

  |PINTA 2206, alfa2;
  |PINTA 2303, alfa3;
  |SI #0#0 ] 18;
      |ATRI R; |PINTA 2304, " "; |ATRI 0;
      |PINTA #0#75;
      |PINTA #0#76;
  |FINSI;
|FPRC;

|PROCESO PideDesglose;
     nTecla = FSalida;

     nCampo1 = Campo;
     |SI Campo < 50;
         nCampo2 = nCampo1 - 14;
     |SINO;
         |SI nCampo1 = 54; nCampo2 = 53; |FINSI;
         |SI nCampo1 = 78; nCampo2 = 77; |FINSI;
         |SI nCampo1 = 76; nCampo2 = 75; |FINSI;
     |FINSI;

     |SI nCampo2 = 3;  nCampoDes = 188;  |FINSI;
     |SI nCampo2 = 4;  nCampoDes = 189;  |FINSI;
     |SI nCampo2 = 5;  nCampoDes = 190;  |FINSI;
     |SI nCampo2 = 6;  nCampoDes = 191;  |FINSI;
     |SI nCampo2 = 7;  nCampoDes = 192;  |FINSI;
     |SI nCampo2 = 8;  nCampoDes = 193;  |FINSI;
     |SI nCampo2 = 53; nCampoDes = 120;  |FINSI;
     |SI nCampo2 = 75; nCampoDes = 143;  |FINSI;
     |SI nCampo2 = 77; nCampoDes = 156;  |FINSI;

     |C_M #0nCampo2, 1, "N";

     |ABRE #100;
     #100#0 = "390";
     #100#1 = empr;
     #100#2 = 0;
     #100#3 = 99;
     #100#4 = #0#0;
     #100#5 = nCampoDes;
     |LEE 101#100=;
     |SI FSalida ! 0;
         |DDEFECTO #100;
         #100#0 = "390";
         #100#1 = empr;
         #100#2 = 0;
         #100#3 = 99;
         #100#4 = #0#0;
         #100#5 = nCampoDes;

         #100#6 = #0nCampo1;
         #100#7 = 0;
         #100#8 = #0nCampo2;

         |GRABA 020#100b;
     |FINSI;

     |SI nTecla = 13;
         |PUSHV 0501 2380;

         |PINPA #0#100;
         |PINDA #0#100;
         |ENDATOS #1#100;
         nError = FSalida;
         |SI FSalida = 0;
             #0nCampo1 = #100#6 + #100#9  + #100#12 + #100#15 + #100#18 + #100#21 + #100#24;
             #0nCampo2 = #100#8 + #100#11 + #100#14 + #100#17 + #100#20 + #100#23 + #100#26;
         |FINSI;

         |POPV;
     |FINSI;

     |SI nError = 0;
         |GRABA 020#100a;
     |FINSI;
     |LIBERA #100;

     #0nCampo1 = #100#6 + #100#9  + #100#12 + #100#15 + #100#18 + #100#21 + #100#24;
     #0nCampo2 = #100#8 + #100#11 + #100#14 + #100#17 + #100#20 + #100#23 + #100#26;

     |PINTA #0nCampo1;
     |PINTA #0nCampo2;
|FPRC;

|PROCESO def_any; |TIPO 7;
  empr = #30#2;
  #0#0 = #30#26;
  |PINTA #0#0;
  |HAZ Pantalla;
|FPRC;

|PROCESO cal_any; |TIPO 0;
 |C_M #0#0,0,alfa1;
 |SI alfa1 = "N"; |ACABA; |FINSI;

 anyo = #0#0;  || A¤o a pasar
 ||  lee datos de portada
 |ABRE #2;
 #2#0 = empr;
 #2#1 = anyo;
 |LEE 001#2=;
 |SI FSalida ! 0;
     |MENAV "0000No Existe registro en el fichero Portadas Modelos";
     |CIERRA #2;
     |PTEC 807;
     |ACABA;
 |FINSI;
 |CIERRA #2;

 |HAZ Pantalla;

 |ABRE #3;   || Fichero de Mantenimiento del 390 Actual
 #3#0 = empr;
 #3#1 = anyo;
 |LEE 001#3=;
 |SI FSalida = 0;
     |AVISO;
     |CONFI "2400NEl Modelo 390 ya esta calculado, Recalcular : ";
     |SI FSalida ! 0;
         |CIERRA #3;
         |ERROR;
         |ACABA;
     |FINSI;
 |FINSI;
 |CIERRA #3;
 |C_M #0#0,1,"N";
 |HAZ calpanta;
|FPRC;

|PROCESO calbrep; |TIPO 0;
 |SI FSalida = 2; |ACABA; |FINSI;
 |SI FSalida = 9;
     #0Campo = 0;
     #0Campo = #0#1 - ( #0#11 + #0#13 + #0#15 + #0#45 + #0#47 + #0#55 + #0#57);
     |PINTA #0Campo;
 |FINSI;
 nume1 = (#0#11 + #0#13 + #0#15 + #0#45 + #0#47 + #0#55 + #0#57) ! EURODB;
 |SI nume1 ! #0#1;
     |MENAV "    SUMA BASES DIFERENTE A LA DECLARADA ";
     |ERROR;
 |FINSI;
|FPRC;

|PROCESO calcrep; |TIPO 0;
 |SI FSalida = 2; |ACABA; |FINSI;
 |SI FSalida = 9;
     #0Campo = 0;
     #0Campo = #0#2 - ( #0#12 + #0#14 + #0#16 + #0#46 + #0#48 + #0#56 + #0#58 );
     |PINTA #0Campo;
 |FINSI;
 nume1 = (#0#12 + #0#14 + #0#16 + #0#46 + #0#48 + #0#56 + #0#58) ! EURODB;
 |SI nume1 ! #0#2;
     |MENAV "    SUMA CUOTAS IVA DIFERENTE A LA DECLARADA ";
     |ERROR;
 |FINSI;
|FPRC;

|PROCESO cuota7; |TIPO 0;
 nume1 = Contenido;
 |SI nume1 = #0Campo;  |ACABA; |FINSI;
 x = Campo + 1;
 |SI Campo = 11; y = 4;  |FINSI;
 |SI Campo = 13; y = 7;  |FINSI;
 |SI Campo = 45; y = 8;  |FINSI;
 |SI Campo = 55; y = 10; |FINSI;
 |SI Campo = 15; y = 16; |FINSI;
 |SI Campo = 47; y = 18; |FINSI;
 |SI Campo = 57; y = 21; |FINSI;
 #0x = ((#0Campo * y) / 100) ! EURODB; ||Redondeo EURO
|FPRC;

|| ***********************************************************************
|PROCESO carga_390;
  |SI #1#1 = 1;
      |SI swant = 1; compens = #1#29; #3#147 = compens; |FINSI;
  |FINSI;
  |HAZ suma_bases;
  |HAZ deduccion;
  |HAZ resto;
|FPRC;

|PROCESO resto;
  #3#157 = #3#157 + #1#33;        ||Total a Ingresar

  #3#159 = #1#32;      ||A Compensar
  #3#160 = #1#31;      ||A Devolver

  #3#161 = #3#161 + #1#5 + #1#8 + #1#11;  ||Operaciones Regimen General
  #3#162 = #3#162 + #1#34;      ||Op Regimen Simplificado     (100)
  #3#163 = #3#163 + #1#38;      ||Op AGP                      (101)
  #3#164 = #3#164 + #1#39;      ||Rec Equivalencia            (102)
  #3#165 = #3#165 + #1#35;      ||Entregas intracomun.        (103)
  #3#166 = #3#166 + #1#36;      ||Op Exentas con deduccion    (104)
  #3#167 = #3#167 + #1#37;      ||Op Exentas sin deduccion    (105)
  #3#168 = #3#168 + #1#40;      ||Entrega bienes, financieros (106)
  #3#169 = #3#169 + #1#41;      ||Entrega bienes Inversion    (107)
  #3#170 = #3#170 + #1#42;      ||Total Volumen               (108)

  #3#171 = #3#171 + #1#52;      || punto 109
  #3#172 = #3#172 + #1#53;      || punto 110
  #3#173 = #3#173 + #1#59;      || punto 111
  #3#174 = #3#174 + #1#56;      || punto 112
  #3#175 = #3#175 + #1#57;      || punto 113

|FPRC;

|PROCESO deduccion;
  #3#68 = #3#68 + #1#21;      ||Bienes y servicios corrientes (INT.)
  #3#69 = #3#69 + #1#43;      ||Bienes de Inversion (INT.)
  #3#70 = #3#70 + #1#22;      ||Bienes Corrientes (IMP.)
  #3#71 = #3#71 + #1#44;      ||Bienes Inversion (IMP.)
  #3#72 = #3#72 + #1#51;      ||Bienes Corrientes (Adq.intrac.)
  #3#73 = #3#73 + #1#58;      ||Bienes de inversion (Adq.intrac.)

  #3#74 = #3#74 + #1#23;        ||Compensacion AGP
  #3#75 = #3#75 + #1#24;        ||Regularizacion Inversiones

  #3#76 = #3#76 + #1#21 + #1#43 + #1#22 + #1#44 + #1#51 + #1#23 + #1#24 + #1#58; || TOTAL

|FPRC;

|PROCESO suma_bases;
  |SI #2#73 = 1; || ..........  es ordinario
                         #3nume1 = #3nume1 + #1#5;               ||BASES
      nume2 = nume1 + 2; #3nume2 = #3nume2 + #1#8;
      nume2 = nume1 + 4; #3nume2 = #3nume2 + #1#11;

      nume2 = nume1 + 1; #3nume2 = #3nume2 + #1#7;               ||CUOTAS
      nume2 = nume1 + 3; #3nume2 = #3nume2 + #1#10;
      nume2 = nume1 + 5; #3nume2 = #3nume2 + #1#13;
  |FINSI;

  #3#59 = #3#59 + #1#14;           ||RECARGOS BASES
  #3#61 = #3#61 + #1#17;
  #3#63 = #3#63 + #1#46;

  #3#60 = #3#60 + #1#16;
  #3#62 = #3#62 + #1#19;           ||RECARGO IVA
  #3#64 = #3#64 + #1#48;
                       ||  #3#184, #3#185 Recargo  1.75

  a = #1#5  + #1#8  + #1#11 + #1#49;      ||  BASES
  b = #1#7  + #1#10 + #1#13 + #1#50;      || IVA
  c = #1#16 + #1#19 + #1#48;              || Recargo

  #3#57 = #3#57 + a;          || TOTAL BASES
  #3#58 = #3#58 + b;          || TOTAL IVA
  #3#67 = #3#67 + (b + c);    || TOTAL IVA + Recargo
|FPRC;

|DEFBUCLE carga;
 #1#1;
 ;
 " " ,  0 , anyo;
 "z" , 12 , anyo;
 e;
 NULL , carga_390;
|FIN;

|| ***********************************************************************
|PROCESO carga_390_m303;
  |SI #303#1 = 1;
      |SI swant = 1; compens = #303#29; #3#147 = compens; |FINSI;
  |FINSI;
  |HAZ suma_bases3;
  |HAZ deduccion3;
  |HAZ resto3;
|FPRC;

|PROCESO resto3;
  #3#157 = #3#157 + #303#33;        ||Total a Ingresar

  #3#159 = #303#32;      ||A Compensar
  #3#160 = #303#31;      ||A Devolver

  || #490#158 = #3#159; Tarea 12729

  #3#161 = #3#161 + #303#5 + #303#8 + #303#11;  ||Operaciones Regimen General
  #3#165 = #3#165 + #303#35;      ||Entregas intracomun.        (103)
  #3#166 = #3#166 + #303#36;      ||Op Exentas con deduccion    (104)
  #3#167 = #3#167 + #303#37;      ||Op Exentas sin deduccion    (105)
  #3#172 = #3#172 + #303#71;      || punto 110   - 53
  #3#174 = #3#174 + #303#56;      || punto 112
  #3#162 = #3#162 + #303#34;      ||Op Regimen Simplificado     (100)
  #3#163 = #3#163 + #303#38;      ||Op AGP                      (101)
  #3#164 = #3#164 + #303#39;      ||Rec Equivalencia            (102)
  #490#61 = #490#61 + #303#72;
  #490#62 = #490#62 + #303#73;
  #3#168 = #3#168 + #303#40;      ||Entrega bienes, financieros (106)
  #3#169 = #3#169 + #303#41;      ||Entraga bienes Inversion    (107)
  #3#170 = #3#170 + #303#42;      ||Total Volumen               (108)

  #490#81 = #490#81 + #303#74;
  #3#171  = #3#171  + #303#52;      || punto 109
  #490#82 = #490#82 + #303#75;
  #490#89 = #490#89 + #303#76;
  #3#173  = #3#173 + #303#53;      || punto 111
  #3#175  = #3#175 + #303#57;      || punto 113
  #490#83 = #490#83 + #303#59;

  #490#146 = #490#146 + #303#154;
  #490#147 = #490#147 + #303#111;
  #490#148 = #490#148 + #303#112;
  #490#149 = #490#149 + #303#113;
  #490#150 = #490#150 + #303#114;
|FPRC;

|PROCESO deduccion3;
  #3#75   = #3#75   + #303#24;        ||Regularizacion Inversiones
  #490#80 = #490#80 + #303#61;


  #3#76 = #3#68 + #3#69 + #490#77 + #490#79 + #3#70 + #3#71;
  #3#76 = #3#76 + #3#72 + #3#73 + #490#121 + #3#74 + #490#157;
  #3#76 = #3#76 + #3#195 + #490#145 +  #3#75 + #490#80; || TOTAL
|FPRC;

|PROCESO suma_bases3;

  |SI nCopia = 0;
      |SI #0#0 < 12;
                             #3nume1 = #3nume1 + #0#25;               ||BASES
          nume2 = nume1 + 2; #3nume2 = #3nume2 + #0#27;
          nume2 = nume1 + 4; #3nume2 = #3nume2 + #0#29;

          nume2 = nume1 + 1; #3nume2 = #3nume2 + #0#26;               ||CUOTAS
          nume2 = nume1 + 3; #3nume2 = #3nume2 + #0#28;
          nume2 = nume1 + 5; #3nume2 = #3nume2 + #0#30;

          |SI nume3 ! 0; |Y nume3 ! 102;
                                 #490nume3 = #490nume3 + #0#49;
              nume2 = nume3 + 2; #490nume2 = #490nume2 + #0#51;

              nume2 = nume3 + 1; #490nume2 = #490nume2 + #0#50;
              nume2 = nume3 + 3; #490nume2 = #490nume2 + #0#52;
          |FINSI;
          |SI nume3 = 102;
                                 #490nume3 = #490nume3 + #0#51;
              nume2 = nume3 + 1; #490nume2 = #490nume2 + #0#51;
          |FINSI;

    |SINO;

                             #3nume1 = #3nume1 + #0#25;               ||BASES
          nume2 = nume1 + 2; #3nume2 = #3nume2 + #0#59;
          nume2 = nume1 + 4; #3nume2 = #3nume2 + #0#61;

          nume2 = nume1 + 1; #3nume2 = #3nume2 + #0#26;               ||CUOTAS
          nume2 = nume1 + 3; #3nume2 = #3nume2 + #0#60;
          nume2 = nume1 + 5; #3nume2 = #3nume2 + #0#62;

          |SI nume3 ! 0; |Y nume3 ! 102;
                                 #490nume3 = #490nume3 + #0#49;
              nume2 = nume3 + 2; #490nume2 = #490nume2 + #0#51;

              nume2 = nume3 + 1; #490nume2 = #490nume2 + #0#50;
              nume2 = nume3 + 3; #490nume2 = #490nume2 + #0#52;
          |FINSI;
          |SI nume3 = 102;
                                 #490nume3 = #490nume3 + #0#51;
              nume2 = nume3 + 1; #490nume2 = #490nume2 + #0#51;
          |FINSI;

          |SI #0#0 < 14;
              |SI #0#28 ! 0; |O #0#30 ! 0;
                  || ... Hay bases al 7 y 16 y las ponemos en este apartado
                  #3#55 = #3#55 + #0#27 + #0#29;
                  #3#56 = #3#56 + #0#28 + #0#30;  || modificacion base y cuotas
              |FINSI;
          |FINSI;

          #3#59    = #3#59  + #0#63; || 0.5          ||RECARGOS BASES
          #3#61    = #3#61  + #0#65; || 1
          #3#63    = #3#63  + #0#67; || 4%
          #3#184   = #3#184 + #0#69; || 1.75%
          #490#126 = #490#126 + #0#71; || 1.4%
          #490#128 = #490#128 + #0#73; || 5.20

          #3#60  = #3#60  + #0#64;
          #3#62  = #3#62  + #0#66;           ||RECARGO IVA
          #3#64  = #3#64  + #0#68;
          #3#185 = #3#185 + #0#70;
          #490#127 = #490#127 + #0#72; || 1.4%
          #490#129 = #490#129 + #0#74;  || 5.20

      |FINSI;
      nCopia = 1;

  |FINSI;

  |SI #0#0 ] 14;
      #3#55 = #3#55 + #303#105;
      #3#56 = #3#56 + #303#106;

      #3#65 = #3#65 + #303#107;
      #3#66 = #3#66 + #303#108;

      #3#180 = #3#180 + #303#103;
      #3#181 = #3#181 + #303#104;
  |FINSI;

  |SI #0#0 < 12;
      #3#59 = #3#59 + #303#14;           ||RECARGOS BASES
      #3#61 = #3#61 + #303#17;
      #3#63 = #3#63 + #303#46;

      #3#60 = #3#60 + #303#16;
      #3#62 = #3#62 + #303#19;           ||RECARGO IVA
      #3#64 = #3#64 + #303#48;
                       ||  #3#184, #3#185 Recargo  1.75
  |FINSI;

  a = #303#5  + #303#8  + #303#11 + #303#49;      ||  BASES
  b = #303#7  + #303#10 + #303#13 + #303#50;      || IVA
  c = #303#16 + #303#19 + #303#48;                || Recargo

  #3#57 = #3#57 + a;          || TOTAL BASES
  #3#58 = #3#58 + b;          || TOTAL IVA
  #3#67 = #3#67 + (b + c);    || TOTAL IVA + Recargo
|FPRC;

|DEFBUCLE carga3;
  #303#1;
  ;
  " " ,  0 , anyo;
  "z" , 12 , anyo;
  e;
  NULL , carga_390_m303;
|FIN;
|| ************************ PROGRAMA

|PROCESO ElEpigrafe;
 alfa2 = "";
 alfa3 = "";
 |QBF alfa1;
 |SI alfa1 = ""; |ACABA; |FINSI;

 alfa2 = alfa1 % 101;
 |SI alfa2 < "0"; |O alfa2 > "9";
     alfa3 = alfa1 - alfa2;
 |SINO;
     alfa3 = alfa1;
     alfa2 = "";
 |FINSI;
|FPRC;

|PROCESO alta; |TIPO 3;

 nume1 = (#0#11 + #0#13 + #0#15 + #0#45 + #0#47 + #0#55 + #0#57) ! EURODB;
 |SI nume1 ! #0#1;
     |MENAV "    SUMA BASES INTRACOMUNITARIAS DIFERENTE A LA DECLARADA "
     |ACABA;
 |FINSI;
 nume1 = (#0#12 + #0#14 + #0#16 + #0#46 + #0#48 + #0#56 + #0#58) ! EURODB;
 |SI nume1 ! #0#2;
     |MENAV "    SUMA CUOTAS INTRACOMUNITARIAS DIFERENTE A LA DECLARADA "
     |ACABA;
 |FINSI;
 anyo = #0#0;  || A¤o a pasar

 ||  lee datos de portada
 |ABRE #2;
 #2#0 = empr;
 #2#1 = anyo;
 |LEE 001#2=;
 |SI FSalida ! 0;
     |CIERRA #2;
     |ACABA;
 |FINSI;
 |CIERRA #2;

 |ABRE #3;   || Fichero de Mantenimiento del 390 Actual
 #3#0 = empr;
 #3#1 = anyo;
 |LEE 141#3=;
 |SI FSalida = 0;
     |BORRA 020#3a;
 |FINSI;
 |LIBERA #3;

 |ABRE #490;   || Fichero de Mantenimiento del 390 Actual
 #490#0 = empr;
 #490#1 = anyo;
 |LEE 141#490=;
 |SI FSalida = 0;
     |BORRA 020#490a;
 |FINSI;
 |LIBERA #4;

 |ABRE #590;   || Fichero de Mantenimiento del 390 Actual
 #590#0 = empr;
 #590#1 = anyo;
 |LEE 141#590=;
 |SI FSalida = 0;
     |BORRA 020#590a;
 |FINSI;
 |LIBERA #4;

 |HAZ lee_ant;  || busca el a¤o anterior ......

 |DDEFECTO #3;
 |DDEFECTO #490;
 |DDEFECTO #590;

 #3#147 = compens; || Compensar de A¤os Anteriores
 #3#0   = empr;      ||Empresa
 #3#1   = anyo;      ||A¤o
 #490#0 = empr;
 #490#1 = anyo;
 #590#0 = empr;
 #590#1 = anyo;

|| ... Datos Alfa
 #3#2 = #2#2;                                  || Nombre Empresa
 #3#3 = "          ";
 #3#4 = "N";

 #3#5  = #2#20;  #3#11 = #2#26;               || Actividades / Clave
 #3#6  = #2#21;  #3#12 = #2#27;
 #3#7  = #2#22;  #3#13 = #2#28;
 #3#8  = #2#23;  #3#14 = #2#29;
 #3#9  = #2#24;  #3#15 = #2#30;
 #3#10 = #2#25;  #3#16 = #2#31;

 alfa1 = #2#32; |HAZ ElEpigrafe;
 #3#17 = alfa2;  #3#23 = alfa3;

 alfa1 = #2#33; |HAZ ElEpigrafe;
 #3#18 = alfa2;  #3#24 = alfa3;

 alfa1 = #2#34;  |HAZ ElEpigrafe;
 #3#19 = alfa2;  #3#25 = alfa3;

 alfa1 = #2#35;  |HAZ ElEpigrafe;
 #3#20 = alfa2;  #3#26 = alfa3;

 alfa1 = #2#36;  |HAZ ElEpigrafe;
 #3#21 = alfa2;  #3#27 = alfa3;

 alfa1 = #2#37;  |HAZ ElEpigrafe;
 #3#22 = alfa2;  #3#28 = alfa3;

 #3#29 = #2#97;    || > 500.000 ptas
 #3#30 = #2#98;    || -E-
 #3#31 = #2#99;    || -F-
 #3#32 = #2#100;   || -G-

 |SI #2#97 = "S"; |O #2#97 = "X";
     #490#66 = "S";
 |SINO;
     #490#66 = "N";
 |FINSI;

 || ... Datos Numericos

 nume3 = 0;
 |SI #2#73 = 1;
     nume1 = 33;   ||  "Regimen Ordinario";
     nume3 = 90;
 |SINO;
     |SI #2#73 = 2; |O #2#73 = 3;
         nume1 = 39;  || "Regimen Especial Bienes Usados, Obj. Arte ...";
         nume3 = 98;
     |SINO;
         |SI #2#73 = 4;
             nume1 = 45; || "Regimen Esp. Agencias de Viaje";
             nume3 = 102;
         |SINO;
             nume1 = 47;  || "Regimen Esp. Det. Proporcional";
             nume3 = 94;
         |FINSI;
     |FINSI;
 |FINSI;

 |SI #2#93 ! "T"; |Y #2#93 ! "F";
     #490#84 = "S";
 |FINSI;

  |SI #0#0 < 12;
      #3#53  = #0#11; ||Intracomunitarias al 4%
      #3#54  = #0#12;
      #3#176 = #0#13; ||Intracomunitarias al 7%
      #3#177 = #0#14;
      #3#178 = #0#15; ||Intracomunitarias al 16%
      #3#179 = #0#16;
      #490#104 = #0#45; ||Intracomunitarias al 8%
      #490#105 = #0#46;
      #490#106 = #0#47; ||Intracomunitarias al 18%
      #490#107 = #0#48;
  |SINO;
      #3#53  = #0#11; ||Intracomunitarias al 4%
      #3#54  = #0#12;
      #3#176 = #0#55; ||Intracomunitarias al 10%
      #3#177 = #0#56;
      #3#178 = #0#57; ||Intracomunitarias al 21%
      #3#179 = #0#58;
      #490#104 = #0#45; ||Intracomunitarias al 8%
      #490#105 = #0#46;
      #490#106 = #0#47; ||Intracomunitarias al 18%
      #490#107 = #0#48;

      |SI #0#0 < 14;
          #3#55 = #3#55 + #0#13 + #0#15;
          #3#56 = #3#56 + #0#14 + #0#16;  || modificacion base y cuotas
      |FINSI;
  |FINSI;

  #3#188   = #0#17;      ||Bienes y servicios corrientes (INT.)
  #3#189   = #0#18;      ||Bienes de Inversion (INT.)
  #3#190   = #0#19;      ||Bienes Corrientes (IMP.)
  #3#191   = #0#20;      ||Bienes Inversion (IMP.)
  #3#192   = #0#21;      ||Bienes Corrientes (Adq.intrac.)
  #3#193   = #0#22;      ||Bienes de inversion (Adq.intrac.)
  #3#194   = #0#23;      ||Compensacion AGP
  #3#195   = #0#75;      ||Rectificaciones

  #490#120 = #0#54;      ||adquisiciones intrac. servicios
  #490#157 = #0#77;      ||No vigentes

|| ....
 |SI enEjer [ 2008;
     |BUCLE carga;

     |HAZ fin_carga;
 |SINO;
     #3#68    =  #0#3;   ||Bienes y servicios corrientes (INT.)
     #3#69    =  #0#4;   ||Bienes de Inversion (INT.)
     #3#70    =  #0#5;   ||Bienes Corrientes (IMP.)
     #3#71    =  #0#6;   ||Bienes Inversion (IMP.)
     #3#72    =  #0#7;   ||Bienes Corrientes (Adq.intrac.)
     #3#73    =  #0#8;   ||Bienes de inversion (Adq.intrac.)
     #3#74    =  #0#9;   ||Compensacion AGP
     #490#143 =  #0#76;  || Rectificaciones
     #490#121 =  #0#53;  ||Adquisiciones intracomunitarias servicios
     #490#156 =  #0#78;  ||Adquisiciones intracomunitarias servicios
     |BUCLE carga3;
     |HAZ fin_carga3;
 |FINSI;

 |GRABA 020#3n;
 |GRABA 020#490n;
 |GRABA 020#590n;

 |CIERRA #590;
 |CIERRA #490;
 |CIERRA #3;
|FPRC;

|| ***********************************************************************
|PROCESO fin_carga3;
    #3#67  = #3#058 + #3#060 + #3#062 + #3#064 + #3#185 + #3#066 + #3#187 + #490#127 + #490#129;

    #3#77  = #3#067 - #3#076;
     |SI #3#1 ] 01; |Y #3#1 [ 80;
        #3#135 = #3#088 + #3#099 + #3#110;
        #490#59 = #3#249 + #3#250 + #3#251 + #3#252 + #3#253;
     |SINO;
        #3#135 = #3#088 + #3#099 + #3#110 + #3#249 + #3#250 + #3#251 + #3#252 + #3#253;
     |FINSI;

     #3#141 = #3#135 + #490#59 + #3#138 + #3#139 + #3#140;
     #3#145 = #3#141 - #3#144;
     #3#146 = #3#77  + #3#145;
     #3#148 = #3#146 - #3#147;
     |SI #3#149 ! 0;
         #3#154 = #3#146 % #3#149;
         |SI #3#147 ! 0; #3#155 = #3#147; |FINSI;
         #3#156 = #3#154 - #3#155;
         #3#146 = 0;
         #3#147 = 0;
     |SINO;
         #3#154 = 0;
         #3#155 = 0;
         #3#156 = 0;
     |FINSI;

     |SI #3#161 = 0;
         |SI enEjer < 2009;
             #3#161 = #3#57 - (#3#53 + #3#176 + #3#178 + #490#104 + #490#106) - #3#180;
         |SINO;
             #3#161 =          #3#33 + #3#35 + #3#37 + #490#90 + #490#92;  || Regimen ordinario + intergrupo
             #3#161 = #3#161 + #3#47 + #3#49 + #3#51 + #490#94 + #490#96;
             #3#161 = #3#161 + (#3#55 + #3#182 + #490#141);
         |FINSI;
     |SINO;
         |SI enEjer ] 2009; #3#161 = #3#161 + (#3#55 + #3#182 + #490#141); |FINSI;
     |FINSI;

     |SI enEjer ] 2009;
         |SI #490#61 = 0; #490#61 = #3#39 + #3#41 + #3#43 + #490#98 + #490#100; |FINSI;
         |SI #490#62 = 0; #490#62 = #3#45 + #490#102; |FINSI;
     |FINSI;

     |SI #3#1 [ 5;
         #3#170 = #3#161 + #3#162 + #3#163 + #3#164 + #3#165 + #3#166 + #3#167 - #3#168 - #3#169;
     |SINO;
         #3#170 = #3#161 + #3#165 + #3#166 + #3#167 + #3#172 + #3#174 + #3#162;
         #3#170 = #3#170 + #3#163 + #3#164 + #490#61  + #490#62  - #3#168 - #3#169;
     |FINSI;
|FPRC;

|PROCESO fin_carga;
  #3#77  = #3#67  - #3#76;    || Total Regimen General
  #3#145 = #3#141 - #3#144;   || Total Regimen Simplificado
  #3#146 = #3#77  + #3#145;   || Suma de Resultados
  #3#148 = #3#146 - #3#147;   || Resultado de la Liquidaci¢n

  #3#149 = #2#72;      ||Territorio Comun
  #3#150 = #2#75;      ||Alava
  #3#151 = #2#77;      ||Guipuzcoa
  #3#152 = #2#76;      ||Vizcaya
  #3#153 = #2#74;      ||Navarra

  #3#154 = #3#146 * #3#149 / 100;
  #3#155 = #3#147 * #3#149 / 100;
  #3#156 = #3#154 - #3#155;
|FPRC;

|PROCESO lee_ant;  || Lee el registro del Modelo A¤o Anterior
  compens = 0;
  swant = 0;
  anyo = anyo - 1;
  #3#0 = empr;
  #3#1 = anyo;
  |LEE 001#3=;
  |SI FSalida = 0;
      compens = #3#159;    ||Compensar A¤o anterior
  |SINO;
      swant = 1;
  |FINSI;
  anyo = anyo + 1;
|FPRC;

|| ***********************************************************************
|| ************* CARGA DATOS EN PANTALLA *********************************
|| ***********************************************************************
|PROCESO Busca100;
     nSwAcum = 0;

     |PARA nPara11 = 6;  |SI nPara11 [ 24;  |HACIENDO nPara11 = nPara11 + 3;
           nPara22 = nPara11 + 1;
           nPara33 = nPara11 + 2;

           |SI #1100nPara2 = #100nPara22;
               #100nPara11 = #100nPara11 + #1100nPara1;
               #100nPara22 = #1100nPara2;
               #100nPara33 = #100nPara33 + #1100nPara3;
               nSwAcum = 1;
               |SAL;
           |FINSI;
     |SIGUE;

     |SI nSwAcum = 1;  |ACABA;  |FINSI;

     |PARA nPara11 = 6;  |SI nPara11 [ 24;  |HACIENDO nPara11 = nPara11 + 3;
           nPara22 = nPara11 + 1;
           nPara33 = nPara11 + 2;

           |SI #100nPara11 = 0;  |Y #100nPara22 = 0;  |Y #100nPara33 = 0;
               #100nPara11 = #1100nPara1;
               #100nPara22 = #1100nPara2;
               #100nPara33 = #1100nPara3;
               |SAL;
           |FINSI;
     |SIGUE;
|FPRC;

|PROCESO MiroVigentes;

    nHay2_18 = 0;
    nOk      = 0;
    |SI nCampo303 = 109;  nOk = 1; |FINSI;
    |SI nOk = 1; |ACABA; |FINSI;

    |PARA nPara2 = 7;  |SI nPara2 [ 25;  |HACIENDO nPara2 = nPara2 + 3;
          |SI #1100nPara2 ! 0; |Y #1100nPara2 ! 4;
              |Y #1100nPara2 ! 10; |Y #1100nPara2 ! 21;
                 nHay2_18 = 1;
                 |SAL;
          |FINSI;
     |SIGUE;

     |SI nHay2_18 = 1;
         #100#0 = "390";
         #100#1 = #303#0;
         #100#2 = 0;
         #100#3 = 99;
         #100#4 = #0#0;
         #100#5 = 156;
         |LEE 101#100=;
         |SI FSalida ! 0;
             |DDEFECTO #100;
             #100#0 = "390";
             #100#1 = #303#0;
             #100#2 = 0;
             #100#3 = 99;
             #100#4 = #0#0;
             #100#5 = 156;
             |GRABA 020#100b;
         |FINSI;

         |PARA nPara1 = 6;  |SI nPara1 [ 24;  |HACIENDO nPara1 = nPara1 + 3;
               nPara2 = nPara1 + 1;
               nPara3 = nPara1 + 2;

               |SI #1100nPara1 ! 0;  |O #1100nPara3 ! 0;
                    |SI #1100nPara2 ! 0; |Y #1100nPara2 ! 4;
                       |Y #1100nPara2 ! 10; |Y #1100nPara2 ! 21;
                        |HAZ Busca100;
                        #0#78 = #0#78 + #1100nPara1;
                        #0#77 = #0#77 + #1100nPara3;
                        #0nCampo1 = #0nCampo1 - #1100nPara1;
                        #0nCampo2 = #0nCampo2 - #1100nPara3;
                        #1100nPara1 = 0;
                        #1100nPara2 = 0;
                        #1100nPara3 = 0;
                    |FINSI;
                |FINSI;
           |SIGUE;

           |GRABA 020#100a;
           |LIBERA #100;
     |FINSI;
|FPRC;

|PROCESO GrabaDes390;
     nCampo1 = 17;
     |SI nCampo303 = 63; nCampo1 = 18; |FINSI;
     |SI nCampo303 = 64; nCampo1 = 19; |FINSI;
     |SI nCampo303 = 65; nCampo1 = 20; |FINSI;
     |SI nCampo303 = 66; nCampo1 = 21; |FINSI;
     |SI nCampo303 = 67; nCampo1 = 22; |FINSI;
     nCampo2 = nCampo1 - 14;

     |SI nCampo303 = 109; nCampo1 = 76; nCampo2 = 75; |FINSI;

     #1100#0 = "303";
     #1100#1 = empr;
     #1100#2 = 1;
     #1100#3 = #303#1;
     #1100#4 = #303#2;
     #1100#5 = nCampo303;
     |LEE 000#1100=;
     |SI FSalida ! 0;  |DDEFECTO #1100;  |FINSI;

     |SI enEjer ] 2018;
         |HAZ MiroVigentes;
     |FINSI;

     #100#0 = "390";
     #100#1 = #303#0;
     #100#2 = 0;
     #100#3 = 99;
     #100#4 = #0#0;
     #100#5 = nCampo390;
     |LEE 101#100=;
     |SI FSalida ! 0;
         |DDEFECTO #100;
         #100#0 = "390";
         #100#1 = #303#0;
         #100#2 = 0;
         #100#3 = 99;
         #100#4 = #0#0;
         #100#5 = nCampo390;
         |GRABA 020#100b;
     |FINSI;

     |PARA nPara1 = 6;  |SI nPara1 [ 24;  |HACIENDO nPara1 = nPara1 + 3;
           nPara2 = nPara1 + 1;
           nPara3 = nPara1 + 2;

           |SI #1100nPara1 ! 0;  |O #1100nPara3 ! 0;
               |SI #1100nPara2 ! 4; |Y #1100nPara2 ! 7; |Y #1100nPara2 ! 8;
                     |Y #1100nPara2 ! 10; |Y #1100nPara2 ! 16;
                     |Y #1100nPara2 ! 18; |Y #1100nPara2 ! 21;
                     nSwSo1 = 1;
               |FINSI;
               |HAZ Busca100;
           |FINSI;
     |SIGUE;

     |GRABA 020#100a;
     |LIBERA #100;
|FPRC;

|PROCESO Leo100_303;
     nHay100 = 0;
     #1100#0 = "303";
     #1100#1 = empr;
     #1100#2 = 1;
     #1100#3 = #303#1;
     #1100#4 = #303#2;
     #1100#5 = nCampo303;
     |LEE 000#1100=;
     |SI FSalida ! 0;
         nHay100 = 1;
     |FINSI;
|FPRC;

|PROCESO PongoCampos;

  |SI nCampo303 [ 11;
      |SI nIVA = 4;  nTotalBase1  = nTotalBase1  + nBase;  nTotalCuota1 = nTotalCuota1 + nCuota; |FINSI;
      |SI nIVA = 7;  nTotalBase2  = nTotalBase2  + nBase;  nTotalCuota2 = nTotalCuota2 + nCuota; |FINSI;
      |SI nIVA = 16; nTotalBase3  = nTotalBase3  + nBase;  nTotalCuota3 = nTotalCuota3 + nCuota; |FINSI;
      |SI nIVA =  8; nTotalBase4  = nTotalBase4  + nBase;  nTotalCuota4 = nTotalCuota4 + nCuota; |FINSI;
      |SI nIVA = 18; nTotalBase5  = nTotalBase5  + nBase;  nTotalCuota5 = nTotalCuota5 + nCuota; |FINSI;
      |SI nIVA = 10; nTotalBase6  = nTotalBase6  + nBase;  nTotalCuota6 = nTotalCuota6 + nCuota; |FINSI;
      |SI nIVA = 21; nTotalBase7  = nTotalBase7  + nBase;  nTotalCuota7 = nTotalCuota7 + nCuota; |FINSI;

      |SI nIVA ! 4; |Y nIVA ! 8; |Y nIVA ! 10; |Y nIVA ! 18;
         |Y nIVA ! 21; |Y nIVA ! 7; |Y nIVA ! 16;
            |SI nBase ! 0; |O nCuota ! 0;
                nSwRe1 = 1;
             |FINSI;
      |FINSI;
  |SINO;
      |SI nIVA = 0.50; nTotalBas11  = nTotalBas11  + nBase;  nTotalCuot11 = nTotalCuot11 + nCuota; |FINSI;
      |SI nIVA = 1;    nTotalBas12  = nTotalBas12  + nBase;  nTotalCuot12 = nTotalCuot12 + nCuota; |FINSI;
      |SI nIVA = 4;    nTotalBas13  = nTotalBas13  + nBase;  nTotalCuot13 = nTotalCuot13 + nCuota; |FINSI;
      |SI nIVA = 1.75; nTotalBas14  = nTotalBas14  + nBase;  nTotalCuot14 = nTotalCuot14 + nCuota; |FINSI;
      |SI nIVA = 1.40; nTotalBas15  = nTotalBas15  + nBase;  nTotalCuot15 = nTotalCuot15 + nCuota; |FINSI;
      |SI nIVA = 5.20; nTotalBas16  = nTotalBas16  + nBase;  nTotalCuot16 = nTotalCuot16 + nCuota; |FINSI;
  |FINSI;
|FPRC;

|PROCESO carga0_390;
  |SI enEjer [ 2008;
      #0#1 = #0#1 + #1#49; ||Intracomunitarias
      #0#2 = #0#2 + #1#50;

      #0#3   = #0#3   + #1#21;      ||Bienes y servicios corrientes (INT.)
      #0#4   = #0#4   + #1#43;      ||Bienes de Inversion (INT.)
      #0#5   = #0#5   + #1#22;      ||Bienes Corrientes (IMP.)
      #0#6   = #0#6   + #1#44;      ||Bienes Inversion (IMP.)
      #0#7   = #0#7   + #1#51;      ||Bienes Corrientes (Adq.intrac.)
      #0#8   = #0#8   + #1#58;      ||Bienes de inversion (Adq.intrac.)
      #0#9   = #0#9   + #1#23;      ||Compensacion AGP


      nTotalBase1  = nTotalBase1  + #1#5;   nTotalCuota1 = nTotalCuota1 + #1#7;
      nTotalBase2  = nTotalBase2  + #1#8;   nTotalCuota2 = nTotalCuota2 + #1#10;
      nTotalBase3  = nTotalBase3  + #1#11;  nTotalCuota3 = nTotalCuota3 + #1#13;
 |SINO;

      #0#1 = #0#1 + #303#49; ||Intracomunitarias
      #0#2 = #0#2 + #303#50;

      #0#3   = #0#3   + #303#21;      ||Bienes y servicios corrientes (INT.)
      #0#4   = #0#4   + #303#43;      ||Bienes de Inversion (INT.)
      #0#5   = #0#5   + #303#22;      ||Bienes Corrientes (IMP.)
      #0#6   = #0#6   + #303#44;      ||Bienes Inversion (IMP.)
      #0#7   = #0#7   + #303#51;      ||Bienes Corrientes (Adq.intrac.)
      #0#8   = #0#8   + #303#58;      ||Bienes de inversion (Adq.intrac.)
      #0#9   = #0#9   + #303#23;      ||Compensacion AGP
      #0#75  = #0#75  + #303#110;     ||Retificaciones

      #0#17  = #0#17  + #303#62;      ||Bienes y servicios corrientes (INT.)
      #0#18  = #0#18  + #303#63;      ||Bienes de Inversion (INT.)
      #0#19  = #0#19  + #303#64;      ||Bienes Corrientes (IMP.)
      #0#20  = #0#20  + #303#65;      ||Bienes Inversion (IMP.)
      #0#21  = #0#21  + #303#66;      ||Bienes Corrientes (Adq.intrac.)
      #0#22  = #0#22  + #303#67;      ||Bienes de inversion (Adq.intrac.)
      #0#23  = #0#23  + #303#90;      ||Compensacion AGP
      #0#76  = #0#76  + #303#109;     ||Retificaciones

      |PARA nCampo303 = 5; |SI nCampo303 [ 46; |HACIENDO nCampo303 = nCampo303 + 3;
            nNume1 = nCampo303 + 1;
            nNume2 = nCampo303 + 2;
            nHay100 = 1;
            |SI enEjer ] 2010;  |HAZ Leo100_303; |FINSI;
            |SI nHay100 = 1;
                nIVA   = #303nNume1;
                nBase  = #303nCampo303;
                nCuota = #303nNume2;
                |HAZ PongoCampos;
            |SINO;
                |PARA nPara11 = 6;  |SI nPara11 [ 21;  |HACIENDO nPara11 = nPara11 + 3;
                      nPara22 = nPara11 + 1;
                      nPara33 = nPara11 + 2;

                      nBase  = #1100nPara11;
                      nIVA   = #1100nPara22;
                      nCuota = #1100nPara33;
                      |HAZ PongoCampos;
                |SIGUE;
           |FINSI;
           |SI nCampo303 = 17; nCampo303 = 43; |FINSI;
      |SIGUE;

      |SI enEjer ] 2009;
          nCampo303 = 62;  nCampo390 = 188;  |HAZ GrabaDes390;
          nCampo303 = 63;  nCampo390 = 189;  |HAZ GrabaDes390;
          nCampo303 = 64;  nCampo390 = 190;  |HAZ GrabaDes390;
          nCampo303 = 65;  nCampo390 = 191;  |HAZ GrabaDes390;
          nCampo303 = 66;  nCampo390 = 192;  |HAZ GrabaDes390;
          nCampo303 = 67;  nCampo390 = 193;  |HAZ GrabaDes390;
          nCampo303 = 109; nCampo390 = 143;  |HAZ GrabaDes390;

          |SI #303#78 ! 0; |O #303#80 ! 0;
               nCampo = 15;
               |SI #303#79 = 4;  nCampo = 11; |FINSI;
               |SI #303#79 = 7;  nCampo = 13; |FINSI;
               |SI #303#79 = 16; nCampo = 15; |FINSI;
               |SI #303#79 =  8; nCampo = 45; |FINSI;
               |SI #303#79 = 18; nCampo = 47; |FINSI;
               |SI #303#79 = 10; nCampo = 55; |FINSI;
               |SI #303#79 = 21; nCampo = 57; |FINSI;
               |SI #303#79 ! 4; |Y #303#79 ! 7;
                   |Y #303#79 ! 8; |Y #303#79 ! 10;
                     |Y #303#79 ! 16; |Y #303#79 ! 18; |Y #303#79 ! 21;
                   nSwRe1 = 1;
               |FINSI;
               #0nCampo = #0nCampo + #303#78; nCampo = nCampo + 1;
               #0nCampo = #0nCampo + #303#80;
               nHay = 1;
          |FINSI;
          |SI #303#81 ! 0; |O #303#83 ! 0;
               nCampo = 15;
               |SI #303#82 = 4;  nCampo = 11; |FINSI;
               |SI #303#82 = 7;  nCampo = 13; |FINSI;
               |SI #303#82 = 16; nCampo = 15; |FINSI;
               |SI #303#82 =  8; nCampo = 45; |FINSI;
               |SI #303#82 = 18; nCampo = 47; |FINSI;
               |SI #303#82 = 10; nCampo = 55; |FINSI;
               |SI #303#82 = 21; nCampo = 57; |FINSI;
               |SI #303#82 ! 4; |Y #303#82 ! 7;
                   |Y #303#82 ! 8; |Y #303#82 ! 10;
                     |Y #303#82 ! 16; |Y #303#82 ! 18; |Y #303#82 ! 21;
                   nSwRe1 = 1;
               |FINSI;
               #0nCampo = #0nCampo + #303#81; nCampo = nCampo + 1;
               #0nCampo = #0nCampo + #303#83;
               nHay = 1;
          |FINSI;
          |SI #303#84 ! 0; |O #303#86 ! 0;
               nCampo = 15;
               |SI #303#85 = 4;  nCampo = 11; |FINSI;
               |SI #303#85 = 7;  nCampo = 13; |FINSI;
               |SI #303#85 = 16; nCampo = 15; |FINSI;
               |SI #303#85 =  8; nCampo = 45; |FINSI;
               |SI #303#85 = 18; nCampo = 47; |FINSI;
               |SI #303#85 = 10; nCampo = 55; |FINSI;
               |SI #303#85 = 21; nCampo = 57; |FINSI;
               |SI #303#85 ! 4; |Y #303#85 ! 7;
                   |Y #303#85 ! 8; |Y #303#85 ! 10;
                     |Y #303#85 ! 16; |Y #303#85 ! 18; |Y #303#85 ! 21;
                   nSwRe1 = 1;
               |FINSI;
               #0nCampo = #0nCampo + #303#84; nCampo = nCampo + 1;
               #0nCampo = #0nCampo + #303#86;
               nHay = 1;
          |FINSI;
          |SI #303#87 ! 0; |O #303#89 ! 0;
               nCampo = 15;
               |SI #303#88 = 4;  nCampo = 11; |FINSI;
               |SI #303#88 = 7;  nCampo = 13; |FINSI;
               |SI #303#88 = 16; nCampo = 15; |FINSI;
               |SI #303#88 =  8; nCampo = 45; |FINSI;
               |SI #303#88 = 18; nCampo = 47; |FINSI;
               |SI #303#88 = 10; nCampo = 55; |FINSI;
               |SI #303#88 = 21; nCampo = 57; |FINSI;
               |SI #303#88 ! 4; |Y #303#88 ! 7;
                   |Y #303#88 ! 8; |Y #303#88 ! 10;
                     |Y #303#88 ! 16; |Y #303#88 ! 18; |Y #303#88 ! 21;
                   nSwRe1 = 1;
               |FINSI;
               #0nCampo = #0nCampo + #303#87; nCampo = nCampo + 1;
               #0nCampo = #0nCampo + #303#89;
               nHay = 1;
          |FINSI;
          |SI #303#91 ! 0; |O #303#93 ! 0;
               nCampo = 15;
               |SI #303#92 = 4;  nCampo = 11; |FINSI;
               |SI #303#92 = 7;  nCampo = 13; |FINSI;
               |SI #303#92 = 16; nCampo = 15; |FINSI;
               |SI #303#92 =  8; nCampo = 45; |FINSI;
               |SI #303#92 = 18; nCampo = 47; |FINSI;
               |SI #303#92 = 10; nCampo = 55; |FINSI;
               |SI #303#92 = 21; nCampo = 57; |FINSI;
               |SI #303#92 ! 4; |Y #303#92 ! 7;
                   |Y #303#92 ! 8; |Y #303#92 ! 10;
                     |Y #303#92 ! 16; |Y #303#92 ! 18; |Y #303#92 ! 21;
                   nSwRe1 = 1;
               |FINSI;
               #0nCampo = #0nCampo + #303#91; nCampo = nCampo + 1;
               #0nCampo = #0nCampo + #303#93;
               nHay = 1;
          |FINSI;
      |FINSI;
 |FINSI;
|FPRC;

|DEFBUCLE carga0;
 #1#1;
 ;
 " " ,  0 , anyo;
 "z" , 12 , anyo;
 e;
 NULL , carga0_390;
|FIN;

|DEFBUCLE carga303;
 #303#1;
 ;
 " " ,  0 , anyo;
 "z" , 12 , anyo;
 e;
 NULL , carga0_390;
|FIN;

|| ************************************
|PROCESO iva_rep2;
 x1 = 0;  x2 = 0;  x3 = 0;  x4 = 0;  x5 = 0;
 |SI #5#11 = 4;  x1 = 11;  |FINSI;
 |SI #5#11 = 7;  x1 = 13;  |FINSI;
 |SI #5#11 = 16; x1 = 15;  |FINSI;

 |SI #5#12 = 4;  x2 = 11;  |FINSI;
 |SI #5#12 = 7;  x2 = 13;  |FINSI;
 |SI #5#12 = 16; x2 = 15;  |FINSI;

 |SI #5#13 = 4;  x3 = 11;  |FINSI;
 |SI #5#13 = 7;  x3 = 13;  |FINSI;
 |SI #5#13 = 16; x3 = 15;  |FINSI;

 |SI #5#54 = 4;  x4 = 11;  |FINSI;
 |SI #5#54 = 7;  x4 = 13;  |FINSI;
 |SI #5#54 = 16; x4 = 15;  |FINSI;

 |SI #5#55 = 4;  x5 = 11;  |FINSI;
 |SI #5#55 = 7;  x5 = 13;  |FINSI;
 |SI #5#55 = 16; x5 = 15;  |FINSI;

 |SI x1 ! 0;
     #0x1 = #0x1 + #5#08;                     || base 1
     x1 = x1 + 1;    #0x1 = #0x1 + #5#14;     || cuota iva 1
 |FINSI;
 |SI x2 ! 0;
     #0x2 = #0x2 + #5#09;                     || base 2
     x2 = x2 + 1;    #0x2 = #0x2 + #5#15;     || cuota iva 2
 |FINSI;
 |SI x3 ! 0;
     #0x3 = #0x3 + #5#10;                     || base 3
     x3 = x3 + 1;    #0x3 = #0x3 + #5#16;     || cuota iva 3
 |FINSI;
 |SI x4 ! 0;
     #0x4 = #0x4 + #5#52;                     || base 4
     x4 = x4 + 1;    #0x4 = #0x4 + #5#56;     || cuota iva 4
 |FINSI;
 |SI x5 ! 0;
     #0x5 = #0x5 + #5#53;                     || base 5
     x5 = x5 + 1;    #0x5 = #0x5 + #5#57;     || cuota iva 5
 |FINSI;
|FPRC;

||.........IVA SOPORTADO
|PROCESO sopor1;
 #7#0 = #5#6;
 |LEE 001#7=;
 |SI FSalida ! 0;
     #7#1 = 1;
 |FINSI;
 |SI #7#1 ! 9;
     |HAZ acum_sop;
 |FINSI;
|FPRC;

|PROCESO acum_sop;
  tot_bas = #5#8 + #5#10 + #5#9 + #5#52 + #5#53;
  |SI #5#23 = "S";
      |SI #5#48 = "N";         ||Si no es de inversion
          |HAZ noinver;
      |SINO;         ||SI es de inversiones
          |HAZ inver;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO inver;
 |SI #7#1 = 6;       ||Op. Interiores Inversiones
     #0#18 = #0#18 + tot_bas;
 |SINO;
     |SI #7#1 = 7;  ||Importaciones Inversiones
          #0#20 = #0#20 + tot_bas;
     |SINO;
          |SI #7#1 = 3;
              #0#22 = #0#22 + tot_bas;
              |SI #7#2 = 2;
                  |HAZ iva_rep2;
              |FINSI;
          |FINSI;
      |FINSI;
 |FINSI;
|FPRC;

|PROCESO noinver;
  |SI #7#1 = 1;       ||Operaciones Corrientes
      #0#17 = #0#17 + tot_bas;
  |SINO;
      |SI #7#1 = 2;   ||Importaciones
          #0#19 = #0#19 + tot_bas;
      |SINO;
          |SI #7#1 = 3;  ||Adj. Intracomunitaria
              #0#21 = #0#21 + tot_bas;
              |SI #7#2 = 2;
                  |HAZ iva_rep2;
              |FINSI;
          |SINO;
              |SI #7#1 = 4;  ||Regimen AGp
                  #0#23 = #0#23 + tot_bas;
              |FINSI;
          |FINSI;
      |FINSI;
  |FINSI;
|FPRC;

|DEFBUCLE sopor;
 #5#1;
 28;
  0, "  ",      1, "S";
 99, "zz", 999999, "S";
 e;
 NULL, sopor1;
|FIN;

|| ************************************
||.........IVA REPERCUTIDO / ADQUISICIONES INTRACOMUNITARIAS

|PROCESO iva_rep;
     tot_bas = #4#8 + #4#9 + #4#10 + #4#52 + #4#53;
     x1 = 0;  x2 = 0;  x3 = 0;  x4 = 0;  x5 = 0;

     |SI #4#11 = 4;  x1 = 11;  |FINSI;
     |SI #4#11 = 7;  x1 = 13;  |FINSI;
     |SI #4#11 = 16; x1 = 15;  |FINSI;

     |SI #4#12 = 4;  x2 = 11;  |FINSI;
     |SI #4#12 = 7;  x2 = 13;  |FINSI;
     |SI #4#12 = 16; x2 = 15;  |FINSI;

     |SI #4#13 = 4;  x3 = 11;  |FINSI;
     |SI #4#13 = 7;  x3 = 13;  |FINSI;
     |SI #4#13 = 16; x3 = 15;  |FINSI;

     |SI #4#54 = 4;  x4 = 11;  |FINSI;
     |SI #4#54 = 7;  x4 = 13;  |FINSI;
     |SI #4#54 = 16; x4 = 15;  |FINSI;

     |SI #4#55 = 4;  x5 = 11;  |FINSI;
     |SI #4#55 = 7;  x5 = 13;  |FINSI;
     |SI #4#55 = 16; x5 = 15;  |FINSI;

     |SI x1 ! 0;
                                #0x1     = #0x1 + #4#08;     || base 1
         x1     = x1     + 1;   #0x1     = #0x1 + #4#14;     || cuota iva 1
     |FINSI;

     |SI x2 ! 0;
                                #0x2     = #0x2 + #4#09;     || base 2
         x2     = x2     + 1;   #0x2     = #0x2 + #4#15;     || cuota iva 2
     |FINSI;

     |SI x3 ! 0;
                                #0x3     = #0x3     + #4#10;     || base 3
         x3     = x3     + 1;   #0x3     = #0x3     + #4#16;     || cuota iva 3
     |FINSI;

     |SI x4 ! 0;
                                #0x4     = #0x4 + #4#52;     || base 4
         x4     = x4     + 1;   #0x4     = #0x4 + #4#56;     || cuota iva 4
     |FINSI;


     |SI x5 ! 0;
                                #0x5     = #0x5 + #4#53;     || base 5
         x5     = x5     + 1;   #0x5     = #0x5 + #4#57;     || cuota iva 5
     |FINSI;
|FPRC;

|PROCESO BaseVentas;
     x1 = 0;  x2 = 0;  x3 = 0;  x4 = 0;  x5 = 0; nCampo = 0;

     || Separamos las bases y cuotas por conceptos

     |SI #7#4 = 1;
         |SI #4#11 = 4;  nCampo = 25;  |FINSI;
         |SI #4#11 = 7;  nCampo = 27;  |FINSI;
         |SI #4#11 = 16; nCampo = 29;  |FINSI;
     |FINSI;

     |SI #7#4 = 2;  |O #7#4 = 3;
         |SI #4#11 = 4;  nCampo = 31;  |FINSI;
         |SI #4#11 = 7;  nCampo = 33;  |FINSI;
         |SI #4#11 = 16; nCampo = 35;  |FINSI;
     |FINSI;

     |SI #7#4 = 4;
         |SI #4#11 = 16;  nCampo = 37;  |FINSI;
     |FINSI;

     |SI #7#4 = 5;
         |SI #4#11 = 4;  nCampo = 39;  |FINSI;
         |SI #4#11 = 7;  nCampo = 41;  |FINSI;
         |SI #4#11 = 16; nCampo = 43;  |FINSI;
     |FINSI;

     |SI nCampo = 0;  |ACABA;  |FINSI;

     |SI #4#11 = 4;  x1 = 11;  |FINSI;
     |SI #4#11 = 7;  x1 = 13;  |FINSI;
     |SI #4#11 = 16; x1 = 15;  |FINSI;

     |SI #4#12 = 4;  x2 = 11;  |FINSI;
     |SI #4#12 = 7;  x2 = 13;  |FINSI;
     |SI #4#12 = 16; x2 = 15;  |FINSI;

     |SI #4#13 = 4;  x3 = 11;  |FINSI;
     |SI #4#13 = 7;  x3 = 13;  |FINSI;
     |SI #4#13 = 16; x3 = 15;  |FINSI;

     |SI #4#54 = 4;  x4 = 11;  |FINSI;
     |SI #4#54 = 7;  x4 = 13;  |FINSI;
     |SI #4#54 = 16; x4 = 15;  |FINSI;

     |SI #4#55 = 4;  x5 = 11;  |FINSI;
     |SI #4#55 = 7;  x5 = 13;  |FINSI;
     |SI #4#55 = 16; x5 = 15;  |FINSI;

     |SI x1 ! 0;
                                #0nCampo = #0nCampo + #4#8;
         nCampo = nCampo + 1;   #0nCampo = #0nCampo + #4#14;
     |FINSI;

     |SI x2 ! 0;
                                #0nCampo = #0nCampo + #4#9;
         nCampo = nCampo + 1;   #0nCampo = #0nCampo + #4#15;
     |FINSI;

     |SI x3 ! 0;
                                #0nCampo = #0nCampo + #4#10;
         nCampo = nCampo + 1;   #0nCampo = #0nCampo + #4#16;
     |FINSI;

     |SI x4 ! 0;
                                #0nCampo = #0nCampo + #4#52;
         nCampo = nCampo + 1;   #0nCampo = #0nCampo + #4#56;
     |FINSI;

     |SI x5 ! 0;
                                #0nCampo = #0nCampo + #4#53;
         nCampo = nCampo + 1;   #0nCampo = #0nCampo + #4#57;
     |FINSI;
|FPRC;

|PROCESO reper1;
     #7#0 = #4#6;
     |LEE 001#7=;
     |SI FSalida = 0;
         |SI #7#2 = 2;
             |HAZ iva_rep;
             |SI #7#1 = 3;
                 |SI #4#48 = "N"; #0#21 = #0#21 + tot_bas; |FINSI;
                 |SI #4#48 = "S"; #0#22 = #0#21 + tot_bas; |FINSI;
             |FINSI;
         |FINSI;
         |HAZ BaseVentas;
     |FINSI;
|FPRC;

|DEFBUCLE reper;
 #4#1;
 28;
  0, "  ",      0 , "S";
 99, "zz", 999999 , "S";
 e;
 NULL, reper1;
|FIN;

|| ***********************************************************************
|PROCESO eosma100B;
     |BORRA 020#100a;
     |LIBERA #100;
|FPRC;

|DEFBUCLE eosma100B;
     #100#1;
     ;
     "390", empr, 0, 99, #0#0, 000;
     "390", empr, 0, 99, #0#0, 999;
     be;
     NULL, eosma100B;
|FIN;

|PROCESO calpanta;
 |ATRI P;
 |MENSA "    ***** CALCULANDO *****";
 |ATRI 0;

  nTotalBase1  = 0;   nTotalCuota1 = 0;
  nTotalBase2  = 0;   nTotalCuota2 = 0;
  nTotalBase3  = 0;   nTotalCuota3 = 0;
  nTotalBase4  = 0;   nTotalCuota4 = 0;
  nTotalBase5  = 0;   nTotalCuota5 = 0;
  nTotalBase6  = 0;   nTotalCuota6 = 0;
  nTotalBase7  = 0;   nTotalCuota7 = 0;

  nTotalBas11  = 0;   nTotalCuot11 = 0;
  nTotalBas12  = 0;   nTotalCuot12 = 0;
  nTotalBas13  = 0;   nTotalCuot13 = 0;
  nTotalBas14  = 0;   nTotalCuot14 = 0;
  nTotalBas15  = 0;   nTotalCuot15 = 0;
  nTotalBas16  = 0;   nTotalCuot16 = 0;

 nSwRe1 = 0;
 nSwSo1 = 0;

 |PDEFECTO #0,1,79;
 |SI #0#0 [ 80;
     enEjer = #0#0 + 2000;
 |SINO;
     enEjer = #0#0 + 1900;
 |FINSI;

 |SI enEjer [ 2008;
     |BUCLE carga0;
 |SINO;
     |BUCLE eosma100B;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/eosma100.mas";
     |CARGA_DEF aMas, desglose@;

     nHay = 0;
     |ABRE #1100;
     |ABRE #100;
     |BUCLE carga303;
     |CIERRA #100;
     |CIERRA #1100;

     |DESCARGA_DEF #desglose@;
 |FINSI;

 |SI enEjer [ 2008;
    |ABRE #7;
    |BUCLE reper;
    |BUCLE sopor;
    |CIERRA #7;
 |FINSI;
 #0#25 = #0#25 + ((nTotalBase1  - (#0#31 + #0#39)));
 #0#26 = #0#26 + ((nTotalCuota1 - (#0#32 + #0#40)));
 #0#27 = #0#27 + ((nTotalBase2  - (#0#33 + #0#41)));
 #0#28 = #0#28 + ((nTotalCuota2 - (#0#34 + #0#42)));
 #0#29 = #0#29 + ((nTotalBase3  - (#0#35 + #0#37 + #0#43)));
 #0#30 = #0#30 + ((nTotalCuota3 - (#0#36 + #0#38 + #0#44)));

 #0#49 = nTotalBase4;
 #0#50 = nTotalCuota4;
 #0#51 = nTotalBase5;
 #0#52 = nTotalCuota5;
 #0#59 = nTotalBase6;
 #0#60 = nTotalCuota6;
 #0#61 = nTotalBase7;
 #0#62 = nTotalCuota7;

 #0#63 = nTotalBas11;
 #0#64 = nTotalCuot11;
 #0#65 = nTotalBas12;
 #0#66 = nTotalCuot12;
 #0#67 = nTotalBas13;
 #0#68 = nTotalCuot13;
 #0#69 = nTotalBas14;
 #0#70 = nTotalCuot14;
 #0#71 = nTotalBas15;
 #0#72 = nTotalCuot15;
 #0#73 = nTotalBas16;
 #0#74 = nTotalCuot16;
 |BLIN 4;
 |PINDA #0#0;

|| ... Avisos
 |SI anyo ] 12;
     |SI nTotalCuota2 ! 0; |O nTotalCuota3 ! 0;
         |MENAV "    Detectadas Bases al 7% o 16%, tipos no vigentes. ";
         |MENAV "    Se incluiran en MODIFICACION DE BASES Y CUOTAS, casillas 29/30";
     |FINSI;
     |SI #0#14 ! 0; |O #0#16 ! 0;
         |MENAV "    Bases al 7% o 16%, tipos no vigentes, en Adquisiones Intracomunitaria. ";
         |MENAV "    Se incluiran en MODIFICACION DE BASES Y CUOTAS, casillas 29/30";
     |FINSI;
     |SI nSwSo1 = 1;
         |MENAV "    Detectadas en IVA deducible Bases y Cuotas con tipos incorrectos.";
         |MENAV "    Revisar y Modifique los Datos";
     |FINSI;
     |SI nSwRe1 = 1;
         |MENAV "    Detectadas en IVA devengado Bases y Cuotas con tipos incorrectos.";
         |MENAV "    No pasaran al Modelo 390. Revisar Datos.";
     |FINSI;
 |FINSI;
|FPRC;
