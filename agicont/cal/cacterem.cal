|FICHEROS;
    cacterem #00;   ||  el #5 y el #8 estan reservados para los 'INCLUYE'
    camaasic #02;   || /para 'cacuenta' y 'catradia' respect.
    camaasil #03;
    caremesc #06;
    caremesl #07;
    camandia #10;
    cacuebal #11;

    camanban #12;

    caivarep #13;
    caconcep #14;

    caivaasi #210;
    ca8m0002 #422;
|FIN;

|VARIABLES;
    aCampo1 = "";
    aCampo2 = "";
    aCampo3 = "";
    aAlfa4  = "";
    &enDiario   = 0;
    &enContador = 0;
    &entrada = 1;
    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;
    fech1 = @;
    fech2 = @;
    fech3 = @;
    fech4 = @;
    arteris = 0;
    muestra = "";
    digito = 0;
    longi = 0;
    asie = 0;
    apun = 0;
    cuen = "";
    digi = 0;
    sign = "";
    ptas = 0;
    conc = 0;
    desc   = "";
    aDesc1 = "";
    aDesc2 = "";
    sw = 0;
    FEstado = 0;

    seleccio = 0;
    &enEjerBal = 0;
|FIN;

|INCLUYE varnue_i;
|INCLUYE inicio_i;
|INCLUYE actcta_i;
|INCLUYE defec1_i;

|PROCESO mayor;
  alfa1 = #0Campo > " ";
  #0Campo = alfa1;
  |PINTA #0Campo;
|FPRC;

|PROCESO MarcaLin;
#caremesl#15 = "S";
|GRABA 020#caremesl.a;
|FPRC;

|DEFBUCLE MarcaLin;
#caremesl#1;
;
#caremesc#0,001;
#caremesc#0,999;
;
NULL,MarcaLin;
|FIN;

|PROCESO contab2;    || graba apunte
    #0#08 = #6#0;   |PINTA #0#08;
    #0#09 = asie;   |PINTA #0#09;
    #0#10 = apun;   |PINTA #0#10;
|DDEFECTO #3;
    #3#00 = #0#4;   || diario
    #3#01 = #0#7;   || fecha
    #3#02 = asie;   || asiento
    #3#03 = apun;   || apunte
    #3#04 = cuen;   || cuenta
    #3#05 = digi;   || digito
    #3#06 = conc;   || concepto
    #3#07 = desc;   || descripcion
    #3#08 = sign;   || signo
    #3#09 = ptas;   || importe
|SI #3#08 = "D";
        #3#16 = #3#4;
        #3#17 = #3#5;
        #3#10 = "";
        #3#11 = 0;
|SINO;
        #3#16 = "";
        #3#17 = 0;
        #3#10 = #3#4;
        #3#11 = #3#5;
|FINSI;
|GRABA 020#3n;
|HAZ cabecera;           || cabecera apunte
    ressum = #3#9;
|HAZ actualiz1;          || cuenta
|HAZ actualiz3;          || diario
    opera = "A";
|HAZ altatra;            || subniveles

|FPRC;

|PROCESO clientes;
    apun = apun + 10;
    cuen = #7#11;
    digi = #7#12;
    sign = "H";
    ptas = #7#7;
    conc = #0#2;

|| ... Descripcion del Asiento
    alfa1 = "";
    alfa2 = "";
    alfa3 = "";

    || .. Descripcion
    alfa2 = #0#3; |QBF alfa2;


    || .. Numero factura
    alfa1 = #7#4 + aCampo2; |QBF alfa1;
    aAlfa4 = #7#3;
    |SI aCampo3 = "S"; aAlfa4 = ("000000" + aAlfa4) % -106; |FINSI;
    alfa1 = alfa1 + aAlfa4;
    alfa1 = " " + alfa1;

    || .. Fecha Vencimiento
    alfa3 = #7#6;
    alfa4 = " " + (alfa3 % 106) + (alfa3 % -104);

    desc = alfa2;
    |SI #0#11 = "D";
        |HAZ DesFactura;
    |SINO;
        |SI #0#11 ! "V";
            desc = desc + alfa1; ||numero factura
        |FINSI;
        |SI #0#11 ! "F";
            desc = desc + alfa4;
        |FINSI;
    |FINSI;

    |HAZ cuenta;
    |HAZ contab2;
|FPRC;

|PROCESO contab1;   || controla la grabacion de apuntes

    seleccio = 1;
    apun = 0;
    enDiario = #0#4;
    |HAZ contador;
    asie = enContador;
    apun = apun + 1;
    cuen = #6#14;
    digi = #6#15;             || apunte del banco
    sign = "D";
    ptas = #6#10;
    conc = #0#5;

    alfa2 = #0#6;
    |QBF alfa2;
    alfa1 = #6#0;   alfa1 = "00000" + alfa1;  alfa1 = alfa1 % -106;
    desc = alfa2 + " " + alfa1;

    |HAZ cuenta;
    |HAZ contab2;

    |BUCLELIN 2clientes#6;

    #6#9 = "S";          || contabilizada
    |GRABA 020#6a;
    |LIBERA #6;

    |ABRE #camanban;
    #camanban#0 = #caremesc#2;
    |LEE 010#camanban.=;
    |SI FSalida = 0;
        #camanban#13 = #camanban#13 - #caremesc#10;
        |GRABA 020#camanban.a;
    |FINSI;
    |CIERRA #camanban;

    |BUCLE MarcaLin;

|FPRC;

|DEFBUCLE cactvpag0;
 #6#1;
 9;
 #0#0, "N";
 #0#1, "N";
 be;
 NULL, contab1;
 #6#1, #6#2, #6#0;
|FIN;

|PROCESO LeeCaivaasi;
 |ABRE #210;
 |DDEFECTO #210;
 |LEE 001#210p;
 |CIERRA #210;
 aCampo1 = #210#45;
 aCampo2 = #210#48;
 aCampo3 = #210#49;
|FPRC;

|PROCESO proceso; |TIPO 3;  || calculo padre
     |SI #30#26 < 80;
         enEjercicio = 2000 + #30#26;
     |SINO;
         enEjercicio = 1900 + #30#26;
     |FINSI;


  |HAZ LeeCaivaasi;
|ABRE #2;
|ABRE #3;
|ABRE #7;
|BUCLE cactvpag0;
|SI seleccio ! 0;
    |HAZ subniveles;
|FINSI;
|CIERRA #7;
|CIERRA #2;
|CIERRA #3;
|FPRC;

|PROCESO subniveles;     || actualiza subniveles de cuentas
|SI modcon = 0;
    |ABRE #8;
    |DDEFECTO #8;
        #8#0 = codcon;
    |LEE 001#8=;
    |SI FSalida = 0;
        |BORRA 020#8a;
    |FINSI;
    |CIERRA #8;
|SINO;
    |SUB_EJECUTA "camaapua.run";
|FINSI;
|FPRC;

|PROCESO cabecera;       || actualiza cabeceras
|SI #3#09 ! 0;
    |DDEFECTO #2;
        #2#00 = #3#0; ||  diario
        #2#01 = #3#1; ||  fecha
        #2#02 = #3#2; ||  documento
        #2#03 = #3#2; ||  asiento
    |LEE 101#2=;
        FEstado = FSalida;
    |SI #3#08 = "D";
            #2#04 = #2#04 + #3#09;
        |SI #2#09 = 0; #2#08 = #3#4; #2#09 = #3#5; |FINSI;  || contrp.HABER
    |FINSI;
    |SI #3#08 = "H";
            #2#05 = #2#05 + #3#09;
        |SI #2#11 = 0; #2#10 = #3#4; #2#11 = #3#5; |FINSI;  || contrp.DEBE
    |FINSI;
        #2#6 = #2#4 - #2#5;      || saldo
    |SI FEstado = 0;  |GRABA 020#2a;  |FINSI;
    |SI FEstado ! 0;  |GRABA 020#2n;  |FINSI;
    |LIBERA #2;
|FINSI;
|FPRC;

|PROCESO actualiz3;
|ABRE #10;
    #10#0 = #3#0;
|LEE 121#10=;
|SI FSalida = 0;
    |SI #3#8 = "D";  #10#2 = #10#2 + #3#9;  |FINSI;
    |SI #3#8 = "H";  #10#3 = #10#3 + #3#9;  |FINSI;
    |GRABA 020#10a;
|FINSI;
|LIBERA #10;
|CIERRA #10;
|FPRC;

|PROCESO cuenta;    || comprueba si la cuenta esta dada de alta
|ABRE #5;
    #5#0 = cuen;
    #5#1 = digi;
|LEE 001#5=;
|SI FSalida ! 0;
    |DDEFECTO #5;
        #5#0 = cuen;
        #5#1 = digi;
    |HAZ defect1;
    |PUSHV 0501 2380;
    |PINPA #0#5;
    |PINDA #0#5;
    |ENDATOS #1#5;
    |SI FSalida = 0;
        |GRABA 020#5n;
    |FINSI;
    |POPV;
|FINSI;
|CIERRA #5;
|FPRC;

**************************************************************************
          CALCULOS DESDE CAMPOS
**************************************************************************

|PROCESO limite; |TIPO 0;
|SI #0#7 < fec1;|O #0#7 > fec2;
    |MENAV "    ATENCION!!! La fecha no corresponde al ejercicio contable ...";
    |ERROR;
|FINSI;
|FPRC;

|PROCESO final; |TIPO 7;
 |PTEC 816;
|FPRC;

|PROCESO DesFactura;
 |ABRE #13;
 #13#0  = #7#2;  || Libro
 #13#27 = #7#4;  || Serie
 #13#2  = #7#3;  || Factura
 |LEE 001#13=;
 |SI FSalida ! 0;
     desc = desc + alfa1; ||numero factura
     |CIERRA #13;
     |ACABA;
 |FINSI;
 |CIERRA #13;

 aDesc1 = #13#7; |QBF aDesc1;

 |ABRE #14;
 aDesc2 = "";
 #14#0 = #13#6;
 |LEE 001#14=;
 |SI FSalida = 0;
     aDesc2 = #14#1; |QBF aDesc2;
 |FINSI;
 aDesc1 = aDesc1 - aDesc2;
 desc = desc + aDesc1;
 |CIERRA #14;
|FPRC;
