|FICHEROS;
     caems349 #0;
     camac349 #1;
     camal349 #2;
     caportad #7;
     catraso2 #104;
     caemi349 #3;

     dsmow538 #538;
     dsmow539 #539;
|FIN;

|VARIABLES;
     nHayDat = 0;
     aTipo = "";
     nLongitud = 0;
     aLongitud = "";
     Calc      = 0;
     Cambio    = 0;
     Redond    = 0;
     nEspa      = 0;
     nLong      = 0;
     nPos       = 0;
     aCadena    = "";
     Cadena1    = "";
     aLong      = "";
     aCaracter  = "";
     aEjer      = "";


     aAlfa   = "";
     aAlfa1  = "";
     aDirOri = "";
     aDirDes = "";
     SwError = 0;
     aDestino = "";
     aOrigen  = "";

     Path       = "";
     nTecla     = 0;
     Vacio10    = "                    ";
     Vacio20    = "                    ";
     Vacio30    = "                              ";
     Vacio40    = "                                        ";
     Vacio45    = "                                             ";
     Salir      = 0;
     Opcion     = 0;
     Comodin    = "";
     nNume1     = 0;

     VAlfa      = "";
     VAlfa1     = "";
     VAlfa2     = "";
     VAlfa3     = "";
     VAlfa4     = "";
     VarNum     = 0;

     Letras     = "";
     Compl      = "";
     Refer      = "";

     Campos     = "";
     Campos1    = "";
     Campos2    = "";
     Campos3    = "";
     Campos4    = "";
     Campos5    = "";
     Campos6    = "";
     Campos7    = "";
     Campos8    = "";
     Campos9    = "";
     Campos10   = "";
     Campos11   = "";
     Campos12   = "";
     Campos13   = "";
     Campos14   = "";
     Campos15   = "";
     Campos16   = "";
     Campos17   = "";
     Campos18   = "";
     Campos19   = "";
     Campos20   = "";
     Campos21   = "";

     DClave     = "";
     HClave     = "";
     Clave      = "";
     Contador   = 0;
     ModoModi   = "";
     SwLee      = 0;
     Fichero1   = "";
     FicheroD   = "";
     nOk        = 0;
     CampoDni   = "";
     Letra1     = "";
     Letra2     = "";
     Letra3     = "";
     Letra4     = "";
     Letra5     = "";
     Letra6     = "";
     Letra7     = "";
     Letra8     = "";
     Caracter   = "";
     Carac1     = 0;
     Carac2     = 0;
     Carac3     = 0;
     Carac4     = 0;
     Carac5     = 0;

         alfa1    = "";
         alfa2    = "";
         tip1     = "";
         tip2     = "";
         empcon   = 0;
         ejecon   = 0;
         leidos   = 0;
         dirfich0 = "";
         xx       = 0;
         yy       = 0;
         x        = 0;
         y        = 0;

     sw_fisica  = 0;
     vacio_20   = "                    ";

     nHandle1   = 0;
     nHandle2   = 0;
     nHandle3   = 0;
     nHandle4   = 0;
     aTecla     = "";
     aAbre      = "";
     aTercera   = "";
     aModelos   = "";
     aInternet  = "";
     nNume      = 0;
     perialf         = "";


     aTTel      = "";
{-1} MGeneral   = "";
     MGeneral1  = "1860";
     MGeneral2  = "1";
     MGeneral3  = "4";
     MGeneral4  = "Creacion  Fichero ";
     MGeneral5  = "Emision   Portada  ";
     MGeneral6  = "Etiqueta  Diskette ";
     MGeneral7  = "Grabacion Diskette ";

     nAnyo         = 0;
     nHasta        = 0;
     nBoton1       = 0;
     nBoton2       = 0;
     nBoton3       = 0;

     aF2           = "";
     aF3           = "";
     aEsc          = "";
     aPathLanza    = "";
     aPathEmision  = "";
     aPathInternet = "";
     aIPRemoto     = "";
     aPathInter    = "";
     aFichero      = "";
     aBue          = "";

     &r_emp   = 0;
     &r_per   = 0;
     &cargoem = "";
     &any     = "";
     &dia     = "";
     &mes     = "";
     &anyo    = "";
     &preimp  = "";
     &predis  = "";
     &predi1  = "";
     &predi2  = "";
     &represen = "";
     &fecbo   = "";
     &ttes    = 0;
     &tdos    = 0;
     &THojas         = 0;
     &NHojas         = 0;
     &nombrep        = "";
     &tipo_p         = "";
     &enEjercicio    = 0;
     &eaTipoE        = "";
     &eaTipoR        = "";
     &eaTipoP        = "";
     &eaTipoC        = "";
     &eaTipoA        = "";
     &eaTipoV        = "";
     &eaModoImpre    = "";
     &eaFichDatos    = "";
     &eaFichAuxil    = "";
     &eaFichError    = "";
     &enBuenos       = 0;
     &enMalos        = 0;
     &enValidacion   = 0;
     &eaInternet     = "";
     &enError        = 0;
     &enInternet     = 1;
     &eaAlfa         = "";
     &eaVarDni       = "";
     &enCalcCif      = 0;
     &eFecha       = "";
     &eNif         = "";
     &eTelefono    = "";
     &eNombre      = "";
     &eCalle       = "";
     &eNumero      = "";
     &eMunicipio   = "";
     &eProvincia   = "";
     &eCodPostal   = "";
     &eNumDecl     = "";
     &eTotalPers   = 0;
     &eTotalOper   = 0;
     &eTotalInm    = 0;
     &eTotalArrend = 0;
     &eTDeclar     = 0;
     &eTDeclardos  = 0;
     &eNumDeclP    = "";
     &eFirmado     = "";
     &eEmpleo      = "";
     &eAnyo        = "";
     &ePres        = "";
     &eCompl       = "";
     &eSust        = "";
     &eaFOrigen    = "";
     &eaFDestino   = "";
     &enNume       = 0;
     &eaUnidadBasico = "";
     &eaModelos          = "";
     &eaEjer             = "";
     &eaPeriodo          = "";
     &eaFicheroPlano     = "";
     &eaOpcion           = "";
     &enErrorPortal      = 0;
     &eaFicheroImpre     = "";
     &eaFicheroSalid     = "";
     &eaFicheroError     = "";
     &eaNomEmpresa       = "";
     &eaPathLanza        = "";
     &eaPathEjecu        = "";
     &eaPathEmision      = "";
     &eaPathInternet     = "";
     &enPresentar        = 0;
     &enTecla            = 0;
|FIN;

|INCLUYE acceso_i;
|INCLUYE i_laserc;

|| ***********************************************************************
||                       PROCESO CARGA DE DATOS
|| ***********************************************************************
|PROCESO repite; |TIPO 7;
    #0#29 = #0#25; |PINTA #0#29;
    #0#37 = #0#11; |PINTA #0#37;
|FPRC;

|PROCESO EsSust; |TIPO 0;
 |SI #0#38 = "S"; |O #0#38 = "C";
     |C_M #0#39,1,"S";
 |SINO;
     |C_M #0#39,1,"N";
     #0#39 = "0000000000000"; |PINTA #0#39;
 |FINSI;
|FPRC;

|PROCESO Relleno;
  |SI Campo = 6;
      VAlfa = #0Campo; |QBT VAlfa;
      VAlfa = ("00000" + VAlfa) % -105;
  |FINSI;

  |SI Campo = 10;
      VAlfa = #0Campo; |QBT VAlfa;
      VAlfa = ("   " + VAlfa) % -103;
  |FINSI;

  |SI Campo = 11;
      VAlfa = #0Campo; |QBT VAlfa;
      VAlfa = ("       " + VAlfa) % -107;
  |FINSI;

  #0Campo = VAlfa;  |PINTA #0Campo;
|FPRC;

|PROGRAMA;
  |HAZ QueVersion;
  |HAZ inicio;

  aTipoSec = "349";

  |CLS;
  |CABEZA "Emision 349 Soporte M/T";

  nHayDat = 0;
  |DDEFECTO #0;
  |PINPA #0#0;
  |ABRE #0;
  |LEE 101#0p;
  |SI FSalida ! 0;
      nHayDat = 1;
      |GRABA 020#0b;
  |FINSI;
  |HAZ PintaAnyo;
  |PINDA #0#0;
  |ENDATOS #1#0;
  |SI FSalida = 0;
      |GRABA 020#0a;
  |FINSI;
  |LIBERA #0;
  |CIERRA #0;
|FPRO;

|| -----------------------------------------------------------------------
|CALCULO MiraVarMoneda;  |TIPO 0;
     |HAZ PintaMoneda;
     #0#34 = eaMoneda;
     |SI #0#34 = "PESETAS";
         |MENAV "     Obligada la Emision en EUROS, cambien la Moneda en el Menu Ver";
         |ERROR;
     |FINSI;
|FCAL;

|CALCULO Mayus; |TIPO 0;
  #0Campo = #0Campo > #0Campo;
  |PINTA #0Campo;
|FCAL;

|CALCULO PintaAnyo; |TIPO 7;
    |SI cod2 ] 80;
       #0#2 = 1900 + cod2;
    |SINO;
       #0#2 = 2000 + cod2;
    |FINSI;
    |PINTA #0#2;
|FCAL;

|CALCULO TipoSop; |TIPO 0;
|FCAL;

|CALCULO Individual; |TIPO 0;
    |SI #0#35 = "C";
        ModoModi = "S";
    |SINO;
        ModoModi = "N";
    |FINSI;

  |C_M #0#03, 1, ModoModi;
  |C_M #0#04, 1, ModoModi;
  |C_M #0#05, 1, ModoModi;
  |C_M #0#06, 1, ModoModi;
  |C_M #0#07, 1, ModoModi;
  |C_M #0#08, 1, ModoModi;
  |C_M #0#09, 1, ModoModi;
  |C_M #0#10, 1, ModoModi;
  |C_M #0#11, 1, ModoModi;
  |C_M #0#12, 1, ModoModi;
  |C_M #0#16, 1, ModoModi;
  |C_M #0#17, 1, ModoModi;
  |C_M #0#18, 1, ModoModi;
  |C_M #0#26, 1, ModoModi;
  |C_M #0#27, 1, ModoModi;
|FCAL;

|PROCESO Parrilla;
   |PUSHV 0501 2380;
   |SUB_EJECUTA "cabucemp";
   |POPV;
|FPRC;

|CALCULO PonIgual;  |TIPO 0;

  nTecla = FSalida;
  aAlfa       = #0#2; |QBF aAlfa;
  aAlfa       = aAlfa % -102;
  #0#36       = aAlfa;

  |C_M #0#22, 1, "N";
  |SI #0#2 ] 2010;
      |C_M #0#22, 1, "N";  #0#22 = "F";   |PINTA #0#22;
      |C_M #0#03, 1, "N";
      |C_M #0#04, 1, "N";
      |C_M #0#05, 1, "N";
      |C_M #0#06, 1, "N";
      |C_M #0#07, 1, "N";
      |C_M #0#08, 1, "N";
      |C_M #0#09, 1, "N";
      |C_M #0#11, 1, "N";
      |C_M #0#12, 1, "N";
      |C_M #0#13, 1, "N";
      |C_M #0#14, 1, "N";
      |C_M #0#16, 1, "N";
      |C_M #0#17, 1, "N";
      |C_M #0#18, 1, "N";
      |C_M #0#23, 1, "N";
      |C_M #0#24, 1, "N";
      |C_M #0#25, 1, "N";
      |C_M #0#26, 1, "N";
      |C_M #0#27, 1, "N";
      |C_M #0#30, 1, "N";
      |C_M #0#31, 1, "N";
      |C_M #0#32, 1, "N";
  |FINSI;
|FCAL;

|CALCULO desperio; |TIPO 0;
  nTecla = FSalida;

  |SI FSalida = 2;  |ACABA; |FINSI;

  |SI #0#35 = "I";
         |ABRE #1;
         #1#0 = #30#2;
         #1#2 = #0#36;
         #1#1 = #0#28;
         |LEE 040#1=;
         |SI FSalida ! 0;
             |CIERRA #1;
             |MENAV "     No Existe Movimientos en el Modelo 349 con esta Empresa";
             |ERROR;
             |ACABA;
         |FINSI;
         |CIERRA #1;

         |ABRE #7;
         #7#0 = #30#2;
         #7#1 = #0#36;
         |LEE 040#7=;
         |SI FSalida ! 0;
             |CIERRA #7;
             |MENAV "    No existen datos el PORTADAS MOD. OFICIALES ";
             |ERROR;
             |ACABA;
         |FINSI;
         |CIERRA #7;

         |HAZ representante;
         #0#25 = represen; |PINTA #0#25;             || Fdo.
         CampoDni = #7#13;  |HAZ LetraDni;
         #0#9  = CampoDni; |PINTA #0#9;              || NIF
         #0#3  = #7#2;     |PINTA #0#3;              || Apellidos y Nombre
         #0#4  = #7#3;     |PINTA #0#4;              || SG
         #0#5  = #7#4;     |PINTA #0#5;              || Calle
         #0#6  = #7#5;     |PINTA #0#6;              || Numero
         #0#11 = #7#46;    |PINTA #0#11;             || Telefono
         #0#7  = #7#11;    |PINTA #0#7;              || Municipio
         #0#8  = #7#12;    |PINTA #0#8;              || Provincia
         #0#17 = #7#09;    |PINTA #0#17;             || Codigo Postal 1
         #0#18 = #7#10;    |PINTA #0#18;             || Codigo Postal 2
         #0#12 = #7#16;    |PINTA #0#12;             || Delegacion de Hacienda
         #0#16 = #7#17;    |PINTA #0#16;             || Administracion de Hacienda
         #0#26 = #7#18;    |PINTA #0#26;             || Delegacion
         #0#27 = #7#19;    |PINTA #0#27;             || Administracion

  |FINSI;
  |SI nHayDat = 1;
      #0#29 = #7#89; |PINTA #0#29;
      aAlfa = #7#90; |QBF aAlfa;
      #0#37 = aAlfa + #7#91; |PINTA #0#37;
  |FINSI;
  |SI #0#35 = "C"; |Y nTecla ! 2; |HAZ Parrilla; |FINSI;
|FCAL;

|PROCESO representante;
 represen = "";
 |SI #7#39 ! Vacio45;
     represen = #7#39;
 |SINO;
     |SI #7#51 ! Vacio20; |O #7#52 ! Vacio20;
         represen = #7#51;
         |QBF represen;
         represen = represen + ", " + #7#52;
     |SINO;
         |SI #7#56 ! Vacio20; |O #7#57 ! Vacio20;
              represen = #7#56;
              |QBF represen;
              represen = represen + ", " + #7#57;
         |SINO;
              |SI #7#61 ! Vacio20; |O #7#62 ! Vacio20;
                  represen = #7#61;
                  |QBF represen;
                  represen = represen + ", " + #7#62;
              |FINSI;
         |FINSI;
     |FINSI;
 |FINSI;
|FPRC;

|PROCESO LetraDni;
     eaVarDni   = CampoDni;
     enCalcCif  = 3;
     |HAZ CalculoDNI;
     CampoDni = eaVarDni;
     CampoDni = ("000000000" + CampoDni) % -109;
|FPRC;


|| ***********************************************************************
||                       IMPRESION DE LA PORTADA
|| ***********************************************************************

|PROCESO FechaP;
  VAlfa2 = #0#15 % 102;
  VAlfa3 = #0#15 % 402;
  VAlfa4 = #0#15 % 704;

  |SI VAlfa3 = "01";  VAlfa3 = "Enero     ";  |FINSI;
  |SI VAlfa3 = "02";  VAlfa3 = "Febrero   ";  |FINSI;
  |SI VAlfa3 = "03";  VAlfa3 = "Marzo     ";  |FINSI;
  |SI VAlfa3 = "04";  VAlfa3 = "Abril     ";  |FINSI;
  |SI VAlfa3 = "05";  VAlfa3 = "Mayo      ";  |FINSI;
  |SI VAlfa3 = "06";  VAlfa3 = "Junio     ";  |FINSI;
  |SI VAlfa3 = "07";  VAlfa3 = "Julio     ";  |FINSI;
  |SI VAlfa3 = "08";  VAlfa3 = "Agosto    ";  |FINSI;
  |SI VAlfa3 = "09";  VAlfa3 = "Septiembre";  |FINSI;
  |SI VAlfa3 = "10";  VAlfa3 = "Octubre   ";  |FINSI;
  |SI VAlfa3 = "11";  VAlfa3 = "Noviembre ";  |FINSI;
  |SI VAlfa3 = "12";  VAlfa3 = "Diciembre ";  |FINSI;
  mes =VAlfa3;
  fecbo = VAlfa2 + " de " + VAlfa3 + " de " + VAlfa4;
|FPRC;

|PROCESO LeePortadaP;
  |SI SwLee = 0;
      ttes = ttes + 1;
      tdos = tdos + (#1#6 + #1#8 + #1#10 + #1#11);
      |ACABA;
  |FINSI;

  any    = #0#36;                              || A¤o Emision
  preimp = "";                                || Impreso
  predi1 = "";                                || Soporte Colectivo Presentador
  |SI #0#35 = "I";  predis = "X";  |FINSI;    || Soporte Individual
  |SI #0#35 = "C";  predi2 = "X";  |FINSI;    || Soporte Colectivo Declarante

  cargoem  = #0#24;                           || Cargo o Empleo #103#27
  |HAZ representante;
  #0#25 = represen;

  |SI enEjercicio [ 2002;
      |PRINT;
      |PIEINF;
  |SINO;
      aAlfa1 = "1";
      aAlfa1 = aAlfa1 + "349";
      aAlfa1 = aAlfa1 + enEjercicio;
      aAlfa1 = aAlfa1 + (#7#13 % 109);
      aAlfa1 = aAlfa1 + ("00"  + #7#16) % -102;
      aAlfa1 = aAlfa1 + ("000" + #7#17) % -103;
      aAlfa1 = aAlfa1 + #7#3;

      aAlfa  = #7#4; aTipo = "A"; nLongitud = 30; |HAZ AnalizaCadena;
      aAlfa1 = aAlfa1 + (aAlfa % 120);

      nNume = #7#5; aAlfa1 = aAlfa1 + (("00000" + nNume) % -105);

      aAlfa  = #7#11; aTipo = "A"; nLongitud = 25; |HAZ AnalizaCadena;
      aAlfa1 = aAlfa1 + (aAlfa % 112);

      aAlfa1 = aAlfa1 + ("00"  + #7#9) % -102;
      aAlfa1 = aAlfa1 + (("00" + #7#9) % -102) + (("000" + #7#10) % -103);
      aAlfa1 = aAlfa1 + (#0#15 % -104) + (#0#15 % 402) + (#0#15 % 102);

      aAlfa  = #0#25; aTipo = "A"; nLongitud = 40; |HAZ AnalizaCadena;
      aAlfa1 = aAlfa1 + (aAlfa % 130);

      aAlfa  = #0#24; aTipo = "A"; nLongitud = 20; |HAZ AnalizaCadena;
      aAlfa1 = aAlfa1 + (aAlfa + (" " * 5));

      aAlfa1 = aAlfa1 + (" " * 20);
      aAlfa1 = aAlfa1 + &13 + &10;

      |XGRABA nHandle3, aAlfa1;
  |FINSI;

  #1#2 = #0#15;
  #1#3 = "S";
  #1#13 = #0#22;

  |GRABA 140#1a;
  |LIBERA #1;
|FPRC;

|PROCESO Validacion_2007;
     eaTipoE =  "CE"   + enEjercicio + ".TXT";
     eaTipoR =  "CCC"   + (("00000" + #1#0) % -105) + ".TXT";
     eaTipoV =  "S";
     |HAZ LineaShellJava;

     eaFichError = "ccc";
     eaFichDatos = "ce" + enEjercicio + ".TXT";
     eaFichAuxil = "cb" + enEjercicio + ".TXT";
     enInternet  = 1;
     |HAZ BuscaErroresL;
     |SI enError ! 0;
         |MENAV "      Hay Errores, arreglelos y vuelva a emitir.";
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO Validacion_2006;
     |SI enEjercicio [ 2005;
         aTercera = "N";
         |CONFI "0000SDesea la impresion de la tercera hoja  ";
         |SI FSalida = 0;  aTercera = "S";  |FINSI;
     |FINSI;

     aAbre = eaUnidadBasico + "\MODELOS\349\" + enEjercicio + "\imprime.bat";
     |XABRE "CBW", aAbre, nHandle4;

     aAlfa = eaUnidadBasico + &13 + &10;                      |XGRABA nHandle4, aAlfa;
     aAlfa = "CD " + eaUnidadBasico + "\MODELOS" + &13 + &10; |XGRABA nHandle4, aAlfa;
     aAlfa = "CD 349" + &13 + &10;                            |XGRABA nHandle4, aAlfa;
     aAlfa = "CD " + enEjercicio + &13 + &10;                 |XGRABA nHandle4, aAlfa;

     aAlfa = "ZPR" + aEjer + "349.EXE -Y" + &13 + &10;      |XGRABA nHandle4, aAlfa;

     |SI enEjercicio [ 2005;
         aAlfa = "wait vs349 /E:CE" + enEjercicio + ".TXT";
         aAlfa = aAlfa + " /R:CC" + enEjercicio + ".TXT ";
         aAlfa = aAlfa + "/I: ";
         aAlfa = aAlfa + "/C:" + aTercera + " ";
         aAlfa = aAlfa + "/F:FLAG.TXT ";
         aAlfa = aAlfa + "/A:CB" + enEjercicio + ".TXT";
         aAlfa = aAlfa + &13 + &10;
     |SINO;
         aAlfa = "wait vi349 /E:CE" + enEjercicio + ".TXT";
         aAlfa = aAlfa + " /R:CC" + enEjercicio + ".TXT ";
         aAlfa = aAlfa + "/F:FLAG.TXT ";
         aAlfa = aAlfa + &13 + &10;
     |FINSI;
     |XGRABA nHandle4, aAlfa;

     aAlfa = "DEL *.DLL" + &13 + &10;
     |XGRABA nHandle4, aAlfa;

     aAlfa = "DEL *.TAB" + &13 + &10;
     |XGRABA nHandle4, aAlfa;

     aAlfa = "DEL *.WMF" + &13 + &10;
     |XGRABA nHandle4, aAlfa;

     aAlfa = "DEL *.EXE" + &13 + &10;
     |XGRABA nHandle4, aAlfa;

     aAlfa = "DEL ERROR349.TXT" + &13 + &10;
     |XGRABA nHandle4, aAlfa;

     |XCIERRA nHandle4;

     |DBASE aModelos;  |QBT aModelos;

     aOrigen  = aModelos + "hacienda/zpr" + aEjer + "349.exe";
     aDestino = eaUnidadBasico + "/MODELOS/349/" + enEjercicio + "/zpr" + aEjer + "349.exe";

     aAlfa = "";
     |IP_REMOTO aAlfa;  |QBT aAlfa;
     |SI aAlfa ! "";
         |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |RSYSTEM aAbre;
     |RFBORRA aAbre;

     enAnyo    = enEjercicio;
     eaTipoSec = "349";
     eaTipoEmi = "ERRORES";
     |SUB_EJECUTA "eosz9999";
|FPRC;

|PROCESO Portada;
  |HAZ FechaP;

  |SI enEjercicio [ 2002;
      |IMPRE 0;
      |SI FSalida ! 0;  |ACABA;  |FINSI;

      |INFOR "ca2or349";
      |SI FSalida ! 0;  |FINIMP;  |ACABA;  |FINSI;
  |SINO;
      aAbre = eaUnidadBasico + "\MODELOS\349\" + enEjercicio + "\CB" + enEjercicio + ".TXT";
      |XABRE "CBW", aAbre, nHandle3;
  |FINSI;

  tipo_p = "T";
  |SI #0#28 = 0; tipo_p = "A"; |FINSI;

  ttes    = 0;  || #103#35    = 0;
  tdos    = 0;  || #103#36    = 0;

  |SI #0#35 = "C";
      SwLee = 0;  |HAZ eosm0009C;

      |DDEFECTO #7;
      |DDEFECTO #1;
      any      = #0#36;                  || A¤o Emision  #103#25
      preimp   = "";                     || Impreso      #103#31
      predis   = "";                     || Soporte Individual  #103#32
      predi1   = "X";                    || Soporte Colectivo Presentador  #103#33
      predi2   = "";                     || Soporte Colectivo Declarante   #103#34
      represen = "";                     || Nombre Representante           #103#38

      #7#0  = 0;                        || Codigo Cliente
      CampoDni = #0#9;  |HAZ LetraDni;
      #7#13 = CampoDni;                 || NIF
      #7#2  = #0#3;                     || Apellidos y Nombre
      #7#3  = #0#4;                     || SG
      #7#4  = #0#5;                     || Calle
      #7#5  = #0#6;                     || Numero
      #7#14 = #0#10 + "-" + #0#11;      || Telefono
      #7#11 = #0#7;                     || Municipio
      #7#12 = #0#8;                     || Provincia
      #7#09 = #0#17;                    || Codigo Postal 1
      #7#10 = #0#18;                    || Codigo Postal 2
      #7#16 = #0#12;                    || Delegacion de Hacienda
      #7#17 = #0#16;                    || Administracion de Hacienda
      #7#18 = #0#26;                    || Delegacion Hacienda
      #7#19 = #0#27;                    || Adminsitracion Hacienda

      #3#3 = #0#15; || Fecha Presentacion
      #3#4 = #0#24; || Cargo o empleo
      #3#5 = #0#25; || Cargo o empleo
      #3#6 = #0#33; || Justificante

      |SI enEjercicio [ 2002;
          |PRINT;
          |PIEINF;
      |SINO;
          aAlfa1 = "0";
          aAlfa1 = aAlfa1 + "349";
          aAlfa1 = aAlfa1 + enEjercicio;
          aAlfa1 = aAlfa1 + (#7#13 % 109);
          aAlfa1 = aAlfa1 + ("00"  + #7#16) % -102;
          aAlfa1 = aAlfa1 + ("000" + #7#17) % -103;
          aAlfa1 = aAlfa1 + #7#3;

          aAlfa  = #7#4; aTipo = "A"; nLongitud = 30; |HAZ AnalizaCadena;
          aAlfa1 = aAlfa1 + (aAlfa % 120);

          nNume = #7#5; aAlfa1 = aAlfa1 + (("00000" + nNume) % -105);

          aAlfa  = #7#11; aTipo = "A"; nLongitud = 25; |HAZ AnalizaCadena;
          aAlfa1 = aAlfa1 + (aAlfa % 112);

          aAlfa1 = aAlfa1 + ("00"  + #7#9) % -102;
          aAlfa1 = aAlfa1 + (("00" + #7#9) % -102) + (("000" + #7#10) % -103);
          aAlfa1 = aAlfa1 + (#0#15 % -104) + (#0#15 % 402) + (#0#15 % 102);

          aAlfa  = #0#25; aTipo = "A"; nLongitud = 40; |HAZ AnalizaCadena;
          aAlfa1 = aAlfa1 + (aAlfa % 130);

          aAlfa  = #0#24; aTipo = "A"; nLongitud = 20; |HAZ AnalizaCadena;
          aAlfa1 = aAlfa1 + (aAlfa + (" " * 5));

          aAlfa1 = aAlfa1 + (" " * 20);
          aAlfa1 = aAlfa1 + &13 + &10;

          |XGRABA nHandle3, aAlfa1;
      |FINSI;
  |FINSI;

  ttes    = 0;
  tdos    = 0;

  SwLee = 1; |HAZ eosm0009C;

  |SI enEjercicio [ 2002;
      |FININF;
      |FINIMP;
  |SINO;
      |XCIERRA nHandle3;

      |SI enEjercicio ] 2003;  |Y enEjercicio [ 2006;
          |HAZ Validacion_2006;
      |FINSI;

      |SI enEjercicio ] 2007;
          |HAZ Validacion_2007;
      |FINSI;
  |FINSI;
|FPRC;

|| ***********************************************************************
||                       GRABACION SECUENCIAL DISTINTOS TIPOS
|| ***********************************************************************

|PROCESO Tipo2_EA;
 || ... Tipo 2 de Registro para Operador Intracomunitario .................

     Campos1  = "2349";                                  || Tipo Registro

     Campos2  = #0#2;                                    || Ejercicio

     CampoDni = #7#13;  |HAZ LetraDni;
     Campos3  = CampoDni % 109;                          || N.I.F.

     Campos4  = " " * 58;                                || 58 posiciones blanco

     Campos5  = #2#5 % 102;
     |SI Campos5 = "GR";  Campos5 = "EL";  |FINSI;

     Campos6  = (#2#6 + "                 ") % 115;

     aAlfa    = #2#7; aTipo = "A"; nLongitud = 40; |HAZ AnalizaCadena;
     Campos7  = aAlfa;                                   || Apellidos y Nombre

     Campos8  = "A";
     |SI #2#4  = "E";  Campos8 = "E";  |FINSI;
     |SI #2#13 = "X";  Campos8 = "T";  |FINSI;

     aAlfa    = #2#8; aTipo = "N"; nLongitud = 13; |HAZ AnalizaCadena;
     Campos9  = aAlfa;

     Campos10 = " " * 4;

     Campos11 = " " * 2;

     Campos12 = " " * 13;

     Campos13 = " " * 13;

     Campos14 = " " * 72;

     Campos   = Campos1 + Campos2 + Campos3 + Campos4;
     Campos   = Campos   + Campos5  + Campos6  + Campos7  + Campos8 + Campos9;
     Campos   = Campos   + Campos10 + Campos11 + Campos12 + Campos13 + Campos14;
     Campos   = Campos   + &13 + &10;        || Caracter Final de Linea
     |XGRABA nHandle2, Campos;

     #104#14 = #104#14 + 1;
|FPRC;

|PROCESO Tipo2_RX;         ||AQUI
 || ... Tipo 2 de Registro de Rectificaciones

     Campos1  = "2349";                                   || Tipo Registro

     Campos2  = #0#2;                                     || Ejercicio

     CampoDni = #7#13;  |HAZ LetraDni;
     Campos3  = CampoDni % 109;                          || N.I.F.

     Campos4 = " " * 58;                                 || 58 posiciones blanco

     Campos5  = #2#5 % 102;
     |SI Campos5 = "GR";  Campos5 = "EL";  |FINSI;

     Campos6  = (#2#6 + "                 ") % 115;

     aAlfa    = #2#7; aTipo = "A"; nLongitud = 40; |HAZ AnalizaCadena;
     Campos7  = aAlfa;                                    || Apellidos y Nombre

     Campos8   = "A";
     |SI #2#4  = "R";  Campos8 = "E";  |FINSI;
     |SI #2#13 = "X";  Campos8 = "T";  |FINSI;

     Campos9 = " " * 13;                 || 13 posiciones blanco

     |SI #2#11 < 80;
         nNume1 = 2000 + #2#11;
     |SINO;
         nNume1 = 1900 + #2#11;
     |FINSI;
     aAlfa    = nNume1; |QBF aAlfa;
     Campos10 = aAlfa;

     |SI #2#12 = 0;  VAlfa = "0A";  |FINSI;
     |SI #2#12 = 1;  VAlfa = "1T";  |FINSI;
     |SI #2#12 = 2;  VAlfa = "2T";  |FINSI;
     |SI #2#12 = 3;  VAlfa = "3T";  |FINSI;
     |SI #2#12 = 4;  VAlfa = "4T";  |FINSI;
     Campos11  = VAlfa;                                    || Periodo

     aAlfa     = #2#8; aTipo = "N"; nLongitud = 13; |HAZ AnalizaCadena;
     Campos12  = aAlfa;

     aAlfa     = #2#16; aTipo = "N"; nLongitud = 13; |HAZ AnalizaCadena;
     Campos13  = aAlfa;

     Campos14 = (" " *  72);

     Campos   = Campos1 + Campos2 + Campos3 + Campos4;
     Campos   = Campos   + Campos5  + Campos6  + Campos7  + Campos8;
     Campos   = Campos   + Campos9  + Campos10  + Campos11 + Campos12;
     Campos   = Campos   + Campos13 + Campos14;
     Campos   = Campos   + &13 + &10;        || Caracter Final de Linea
     |XGRABA nHandle2, Campos;

     #104#14 = #104#14 + 1;
|FPRC;

|PROCESO Tipo2;
 |SI #2#4 = "E"; |O #2#4 = "A"; |HAZ Tipo2_EA; |FINSI;
 |SI #2#4 = "R"; |O #2#4 = "X"; |HAZ Tipo2_RX; |FINSI;
|FPRC;

|DEFBUCLE grlin;
 #2#2;
 ;
 #30#2, #0#36, #0#28, tip1, "            ";
 #30#2, #0#36, #0#28, tip2, "zzzzzzzzzzzz";
 be;
 NULL, Tipo2;
|FIN;

|PROCESO eosm0010;
  tip1 = "E";
  tip2 = "E";
  |BUCLE grlin; || las lineas - registro de operaciones
  tip1 = "A";
  tip2 = "A";
  |BUCLE grlin; || las lineas - registro de operaciones
  tip1 = "R";
  tip2 = "X";
  |BUCLE grlin; || las lineas - registro de operaciones
|FPRC;

|PROCESO Tipo1;
  Campos1  = "1349";                                   || Tipo Registro
  VAlfa = #0#2;
  Campos2  = VAlfa;                                    || Ejercicio

  CampoDni = #7#13;  |HAZ LetraDni;
  Campos3  = CampoDni;                                 || N.I.F.

  aAlfa    = #7#2; aTipo = "A"; nLongitud = 40; |HAZ AnalizaCadena;
  Campos4  = aAlfa;                                    || Apellidos y Nombre
  Campos5  = aTTel;
  Campos6  = #0#37 % 0109;
  Campos7  = #0#29;                                    || Persona contacto
  Campos8  = #0#33;                                    || Numero Justificante

  Campos9  = "  ";
  |SI #0#38 = "C"; Campos9 = "C ";  |FINSI;
  |SI #0#38 = "S"; Campos9 = " S";  |FINSI;
  Campos10 = #0#39;   ||justificante anterior

  |SI #1#1 = 0;  VAlfa = "0A";  |FINSI;
  |SI #1#1 = 1;  VAlfa = "1T";  |FINSI;
  |SI #1#1 = 2;  VAlfa = "2T";  |FINSI;
  |SI #1#1 = 3;  VAlfa = "3T";  |FINSI;
  |SI #1#1 = 4;  VAlfa = "4T";  |FINSI;
  Campos11  = VAlfa;                                    || Periodo

  nNume1   = #1#6 + #1#8;  ||Entregas + Adquisiciones
  aAlfa    = nNume1; aTipo = "N"; nLongitud = 9; |HAZ AnalizaCadena;
  Campos12 = aAlfa;                                     || Personas

  nNume1   = #1#7 + #1#9; ||Entregas + adquisiciones
  aAlfa    = nNume1; aTipo = "N"; nLongitud = 15; |HAZ AnalizaCadena;
  Campos13  = aAlfa;                                    || Cantidad

  nNume1   = #1#10 + #1#11;
  aAlfa    = nNume1; aTipo = "N"; nLongitud = 9; |HAZ AnalizaCadena;
  Campos14  = aAlfa;                                     || Personas

  nNume1   = #1#14 + #1#15;
  aAlfa    = nNume1; aTipo = "N"; nLongitud = 15; |HAZ AnalizaCadena;
  Campos15 = aAlfa;                                      || Cantidad

  Campos16 = Vacio45 + Vacio20;

  Campos   = Campos1 + Campos2 + Campos3 + Campos4;
  Campos   = Campos   + Campos5  + Campos6  + Campos7  + Campos8  + Campos9;
  Campos   = Campos   + Campos10 + Campos11 + Campos12 + Campos13 + Campos14;
  Campos   = Campos   + Campos15 + Campos16;
  Campos   = Campos   + &13 + &10;        || Caracter Final de Linea

  |XGRABA nHandle2, Campos;

  #104#14 = #104#14 + 1;
|FPRC;

|PROCESO LeePortadaC;
  |SI SwLee = 0;
      ttes = ttes + 1;
      tdos = tdos + (#1#6 + #1#8 + #1#10 + #1#11);

      #104#0  = #104#0 + #1#6;
      #104#1  = #104#1 + #1#8;
      #104#2  = #104#2 + #1#10 + #1#11;
      #104#6  = #104#0 + #104#1 + #104#2;
      #104#7  = #104#7 + #1#7;
      #104#8  = #104#8 + #1#9;
      #104#9  = #104#9 + #1#14 + #1#15;
      #104#13 = #104#7 + #104#8 + #104#9;
      #104#15 = #104#15 + 1;
      |ACABA;
  |FINSI;

  SwLee = 1;  |HAZ Tipo1;
  SwLee = 2;  |HAZ eosm0010;
|FPRC;

|| *********************************************************************

|PROCESO eosm0009C;
  empcon = #30#1;
  ejecon = #30#26;

  |ABRE #1;
  #1#0 = #30#2;
  #1#2 = #0#36;
  #1#1 = #0#28;
  |LEE 101#1=;
  |SI FSalida ! 0; |CIERRA #1; |ACABA; |FINSI;

  |ABRE #7;
  #7#0 = #30#2;
  #7#1 = #0#36;
  |LEE 001#7=;
  |SI FSalida ! 0; |CIERRA #1; |CIERRA #7; |ACABA; |FINSI;
  |CIERRA #1;
  |CIERRA #7;
  #7#89 = #0#29;
  #7#90 = #0#37 % 103;
  #7#91 = #0#37 % 412;

  |SI Opcion = 1;
      |HAZ LeePortadaC;
  |FINSI;

  |SI Opcion = 2;
      |HAZ LeePortadaP;
  |FINSI;
|FPRC;

|| ************************************************************************

|PROCESO Tipo0;     || Proceso Colectivo Solo soporte Magnetico
  Campos1  = "0349";                                   || Tipo Registro
  VAlfa    = #0#2;
  Campos2  = VAlfa;                                    || Ejercicio

  Campos3  = #0#9;                                     || N.I.F.
  Campos4  = #0#3;                                     || Apellidos y Nombre
  Campos5  = #0#4;                                     || SG
  Campos6  = #0#5 % 120;                               || Calle
  Campos7  = #0#6;                                     || Numero
  Campos8  = #0#30;                                    || Escalera
  Campos9  = #0#31;                                    || Piso
  Campos10 = #0#32;                                    || Puerta

  VAlfa    = ("00" + #0#17) % -102;
  Campos11 = VAlfa;                                    || Codigo Postal 1
  VAlfa    = ("000" + #0#18) % -103;
  Campos12 = VAlfa;                                    || Codigo Postal 2
  Campos13 = #0#7 % 112;                               || Municipio
  Campos14 = Campos11;                                 || Codigo Provincia

  VAlfa    = ("00000" + ttes) % -105;               || Total Declarantes
  Campos15 = VAlfa;
  VAlfa    = ("0000000" + tdos) % -109;             || Total Declarados
  Campos16 = VAlfa;
  Campos17 = "D";
  Campos18 = #0#37 % 0109;
  Campos19 = #0#29;                                    || Persona contacto

  |SI #1#1 = 0;  VAlfa = "0A";  |FINSI;
  |SI #1#1 = 1;  VAlfa = "1T";  |FINSI;
  |SI #1#1 = 2;  VAlfa = "2T";  |FINSI;
  |SI #1#1 = 3;  VAlfa = "3T";  |FINSI;
  |SI #1#1 = 4;  VAlfa = "4T";  |FINSI;
  Campos20 = VAlfa;                                    || Periodo

  Campos21 = Vacio30 + Vacio45;

  Campos   = Campos1  + Campos2  + Campos3 + Campos4;
  Campos   = Campos   + Campos5  + Campos6  + Campos7  + Campos8  + Campos9;
  Campos   = Campos   + Campos10 + Campos11 + Campos12 + Campos13 + Campos14;
  Campos   = Campos   + Campos15 + Campos16 + Campos17 + Campos18 + Campos19;
  Campos   = Campos   + Campos20 + Campos21;
  Campos   = Campos   + &13 + &10;        || Caracter Final de Linea
  |XGRABA nHandle2, Campos;

  #104#14 = #104#14 + 1;
|FPRC;

|| ************************************************************************
||                  CREACION DISKETTE SOPORTE COLECTIVO E INDIVIDUAL
|| ************************************************************************

|PROCESO Creacion;
     |HAZ FechaP;

     |DDEFECTO #104;
     ttes    = 0;
     tdos    = 0;

     SwLee   = 0;
     |HAZ eosm0009C;

     aAbre = eaUnidadBasico + "\MODELOS\349\" + enEjercicio + "\CE" + enEjercicio  + ".TXT";
     |XABRE "CBW", aAbre, nHandle2;
     |SI FSalida ] 0;
         |SI #0#35 = "C";  |HAZ Tipo0;  |FINSI;  || Registro del Presentador
         SwLee = 1;  |HAZ eosm0009C;
     |FINSI;
     |XCIERRA nHandle2;

     |PUSHV 0501 2380;
     |PINPA #0#104;
     |PINDA #0#104;
     |PAUSA;
     |CONFI "    SEs Correcto: ";
     |SI FSalida ! 0;
         |RFBORRA aAbre;
         Salir = 1;
     |FINSI;
     |POPV;
|FPRC;

|| ************************************************************************
||                  GRABACION DEL DISKETTE OP
|| ************************************************************************

|PROCESO GrabaDisketteC;
     aAbre = eaUnidadBasico + "\MODELOS\349\" + enEjercicio + "\CE" + enEjercicio  + ".TXT";
     |XABRE "CE", aAbre, nHandle2;
     |SI FSalida < 0;
         |MENAV "     No se ha hecho la creacion del Diskette.";
         |ACABA;
     |FINSI;

     |PUSHV 0501 2380;
     |BLANCO 0501 2380;
     |CUADRO 0501 2380;
     |ATRI I;
     |PINTA 0715, "Introduzca un Diskette Formateado en D.O.S. en su PC,";
     |PINTA 0815, "y pulse una Tecla para iniciar la copia.             ";
     |ATRI i;
     |LEETECLA aTecla;
     |POPV;

     aAbre = eaUnidadBasico + "\MODELOS\349\" + enEjercicio + "\copiaa.bat";
     |XABRE "CBW", aAbre, nHandle4;

     aAlfa = eaUnidadBasico + &13 + &10;                           |XGRABA nHandle4, aAlfa;
     aAlfa = "CD " + eaUnidadBasico + "\MODELOS" + &13 + &10;       |XGRABA nHandle4, aAlfa;
     aAlfa = "CD 349" + &13 + &10;                         |XGRABA nHandle4, aAlfa;
     aAlfa = "CD " + enEjercicio + &13 + &10;              |XGRABA nHandle4, aAlfa;
     aAlfa = "COPY CE" + enEjercicio + ".TXT A:" + &13 + &10;        |XGRABA nHandle4, aAlfa;
     |SI enEjercicio ] 2003;
         aAlfa = "COPY CB" + enEjercicio + ".TXT A:" + &13 + &10;    |XGRABA nHandle4, aAlfa;
     |FINSI;
     |XCIERRA nHandle4;

     |RSYSTEM aAbre;

     |RFBORRA aAbre;
|FPRC;

|| ***********************************************************************
||                       EMISION DE ETIQUETAS
|| ***********************************************************************

|PROCESO Etiquetas;
  |SI #104#14 = 0;
      |MENAV "     Por favor haga la creacion de Diskette.";
      |ACABA;
  |FINSI;

  |PUSHV 0501 2380;

  Campos1  = "19";
  |SI #0#36 < 80; Campos1 = "20"; |FINSI;
  VAlfa    = #0#36;   VAlfa = ("00" + VAlfa) % -102;
  Campos1  = Campos1 + VAlfa;                          || Ejercicio
  VAlfa    = #0#17;  VAlfa = ("00" + VAlfa) % -102;
  Campos2  = VAlfa;                                     || Codigo Postal 1
  VAlfa    = #0#18;  VAlfa = ("000" + VAlfa) % -103;
  Campos3  = VAlfa;                                     || Codigo Postal 2

  #104#16 = "Delegacion .........: " + #0#26;
  #104#17 = "Ejercicio ..........: " + Campos1;
  #104#18 = "Modelo .............: 349";
  #104#19 = "Numero Justificante : ";
  #104#20 = "N.I.F. .............: " + #0#9;
  #104#21 = "Nombre : " + #0#3;
  Comodin = #0#4 + " " + #0#5; |QBF Comodin;
  Comodin = Comodin + ", N§ " + #0#6 + ", C.P." + Campos2 + Campos3 + ", " + #0#7;
  #104#22 = Comodin;
  #104#23 = "P.Cont.: " + #0#29;
  #104#24 = "Telefono ...........: " + #0#37;
  #104#25 = "Numero total Registros ..: " + #104#14;
  #104#26 = "Densidad soporte : 1,44 MB en Diskettes de 3 1/2";
  #104#27 = "";
  #104#28 = "";
  |C_M #104#27, 1, "N";
  |C_M #104#28, 1, "N";
  |SI #0#35 = "C";
      #104#27 = "Numero total Declarantes : " + #104#15;
      #104#28 = "Numero total Declarados .: " + #104#6;
      |C_M #104#27, 1, "S";
      |C_M #104#28, 1, "S";
  |FINSI;

  |PINPA #2#104;
  |PINDA #2#104;
  |ENDATOS #1#104;
  |SI FSalida = 0;
      |PINPA #2#104;
      |PINDA #2#104;

      |CONFI "2400SRealizar Impresion de la Etiqueta : ";
      |SI FSalida ! 0; |POPV; |ACABA; |FINSI;

      |IMPRE 0;
      |SI FSalida ! 0;  |ACABA;  |FINSI;

      |INFOR "catraso2";
      |SI FSalida ! 0;  |FINIMP;  |ACABA;  |FINSI;

      |PRINT; |PIEINF; |FININF; |FINIMP;
  |FINSI;
  |POPV;
|FPRC;

|| ***********************************************************************
||                       PROCESO DE DISTRIBUCION
|| ***********************************************************************

|PROCESO ElTelemat;
     aAlfa      = "/AEAT";                                |RMKDIR aAlfa;
     aAlfa      = "/AEAT/INTERNET";                       |RMKDIR aAlfa;
     aAlfa      = "/AEAT/INTERNET/349";                   |RMKDIR aAlfa;
     aAlfa      = "/AEAT/INTERNET/349/" + enEjercicio;    |RMKDIR aAlfa;
     aInternet  = aAlfa + "/";

     |SI #0#35 = "I";
         |SI enEjercicio ] 2003;  |Y enEjercicio [ 2006;
             |HAZ Validacion_2006;
         |FINSI;

         |SI enEjercicio ] 2007;
            |HAZ Validacion_2007;
         |FINSI;
     |FINSI;

     |SI enError ! 0;  |ACABA;  |FINSI;

     aOrigen    = eaUnidadBasico + "/MODELOS/349/" + enEjercicio + "/CE" + enEjercicio + ".TXT";

     |SI #0#35 = "I";
         aDestino   = aInternet + "CE" + (("00000" + #1#0) % -105) + ".TXT";
     |SINO;
         aDestino   = aInternet + "CE" + enEjercicio + ".TXT";
     |FINSI;

     |RCOPIA_FICHERO aOrigen, aDestino;

     aAlfa =  "      Los ficheros generados estan en " + aInternet + " de su PC";
     |MENAV aAlfa;
|FPRC;

|PROCESO AnalizaCadena;
     |QBF aAlfa;
     |SI aTipo = "N";
         |SI nLongitud = 15; |O nLongitud = 13;
             Calc = aAlfa; Calc = (Calc / Cambio) ! Redond;
             |SI #0#34 = "EUROS  ";  Calc = (Calc * 100) ! 0; |FINSI;
             aAlfa = Calc;
         |FINSI;
         Comodin = "0" * nLongitud;
     |SINO;
         Comodin = " " * nLongitud;
     |FINSI;

     nEspa   = 0;
     aCadena = "";
     aLong   = aAlfa % 0;
     nLong   = aLong;
     |PARA nCampo = 1;  |SI nCampo [ aLong;  |HACIENDO nCampo = nCampo + 1;
           nPos = (100 * nCampo) + 1;
           aCaracter = aAlfa % nPos;
           |SI aCaracter = ",";  aCaracter = "";   nEspa = nEspa + 1;  |FINSI;
           |SI aCaracter = "¥";  aCaracter = &209; |FINSI;
           |SI aCaracter = "¤";  aCaracter = &209; |FINSI;
           |SI aCaracter = "§";  aCaracter = &176; |FINSI;
           |SI aCaracter = "¦";  aCaracter = &170; |FINSI;
           |SI aCaracter = "'";  aCaracter = "";   |FINSI;
           aCadena = aCadena + aCaracter;
     |SIGUE;
     aAlfa = aCadena + (" " * nEspa);

     aAlfa = aAlfa > aAlfa;

     |SI aTipo = "A";
        Calc  = 100 + nLongitud;
        aAlfa = (aAlfa + Comodin) % Calc;
     |SINO;
        Calc  = 0 - (100 + nLongitud);
        aAlfa = (Comodin + aAlfa) % Calc;
     |FINSI;
|FPRC;

|PROCESO Del2009;
   aAlfa      = eaUnidadBasico + "/MODELOS";                             |RMKDIR aAlfa;
   aAlfa      = eaUnidadBasico + "/MODELOS/349";                         |RMKDIR aAlfa;
   aAlfa      = eaUnidadBasico + "/MODELOS/349/" + enEjercicio;          |RMKDIR aAlfa;

   eaModelos   = "349";
   enAnyo      = enEjercicio;
   eaEjer      = enEjercicio;

  |SI EURODB ! 0;
      eaMoneda = "E";
  |SINO;
      eaMoneda = "P";
  |FINSI;
  Cambio = 1;
  Redond = 2;
  |SI eaMoneda = "P";  Cambio = 166.386;  |FINSI;

  aEjer       = ("00" + #0#2) % -102;
  enAnyo      = #0#2;
  aAlfa       = #0#2; |QBF aAlfa;
  aAlfa       = aAlfa % -102;
  #0#36       = aAlfa;
  |PINPA #0#0;
  |PINDA #0#0;

  || Campos de Pantalla
  aAlfa = #0#3; aTipo = "A"; nLongitud = 40; |HAZ AnalizaCadena; #0#3  = aAlfa;

  eaAlfa = #0#37; |HAZ QuitaRarosTfno; #0#37 = eaAlfa;

  aAlfa = #0#29; aTipo = "A"; nLongitud = 40; |HAZ AnalizaCadena; #0#29 = aAlfa;

                   aTTel = "T";
  |SI #0#22 ! "F"; aTTel = "D"; |FINSI;

  |SI #0#22 = "F";
      Opcion = 1;
      Salir  = 0;
      |HAZ Creacion;
      |SI Salir = 0;
          |HAZ ElTelemat;
      |FINSI;
      |ACABA;
  |FINSI;

  |PARA; |SI Salir = 0; |HACIENDO;
         |SI enEjercicio ] 2003;
             MGeneral5  = "Validacion ";
         |FINSI;

         |MENUG MGeneral;
         MGeneral2 = FSalida;
         Opcion    = MGeneral2;
         Salir     = 1;
         |SI Opcion ] 1; |Y Opcion [ 4;
             Salir = 0;
             |SI Opcion = 1; |HAZ Creacion;       |FINSI;
             |SI Opcion = 2; |HAZ Portada;        |FINSI;
             |SI Opcion = 3; |HAZ Etiquetas;      |FINSI;
             |SI Opcion = 4; |HAZ GrabaDisketteC; |FINSI;
         |FINSI;
  |SIGUE;

  aAbre = eaUnidadBasico + "\MODELOS\349\" + enEjercicio + "\CE" + enEjercicio + ".TXT";  |RFBORRA aAbre;
  aAbre = eaUnidadBasico + "\MODELOS\349\" + enEjercicio + "\CB" + enEjercicio + ".TXT";  |RFBORRA aAbre;
|FPRC;

||---------------------------------------------------------------------------

|PROCESO Registro1;
     |DDEFECTO #538;

     #538#0   = "1";

     #538#1   = "349";

     #538#2   = #0#2;

     enCalcCif = 3;
     eaVarDni  = #0#9;  |HAZ CalculoDNI;
     #538#3    = eaVarDni;

     eaAlfa   = #0#3;   |HAZ QuitaRaros;
     #538#4   = eaAlfa;

     |SI #dsmow538#2 < 2020;
         #538#5   = "T";
     |FINSI;

     eaAlfa   = #0#37;  |HAZ QuitaRarosTfno;
     #538#6   = eaAlfa;

     eaAlfa   = #0#29;   |HAZ QuitaRaros;
     #538#7   = eaAlfa;

     #538#8   = "3490000000000";

     |SI #0#38 = "C";
         #538#9 = "C";
         #538#11 = #0#39;
     |FINSI;

     |SI #0#38 = "S";
         #538#10 = "S";
         #538#11 = #0#39;
     |FINSI;

     |SI #1#16 = "M";
         #538#12 = (("00" + #1#1) % -102);

         |SI #1#17 = "S";   #538#17 = "X";  |FINSI;
     |FINSI;

     |SI #1#16 = "T";
         |SI #1#1 = 1;   #538#12 = "1T";  |FINSI;
         |SI #1#1 = 2;   #538#12 = "2T";  |FINSI;
         |SI #1#1 = 3;   #538#12 = "3T";  |FINSI;
         |SI #1#1 = 4;   #538#12 = "4T";  |FINSI;
     |FINSI;

     |SI #1#16 = "A";
         #538#12 = "0A";
     |FINSI;

     enNume   = #1#6 + #1#8;
     #538#13  = ("000000000" + enNume) % -109;

     enNume   = #1#7 + #1#9;  |HAZ Conver15;
     #538#14  = eaAlfa;

     enNume   = #1#10 + #1#11;
     #538#15  = ("000000000" + enNume) % -109;

     enNume   = #1#14 + #1#15;  |HAZ Conver15;
     #538#16  = eaAlfa;

     #538#21  = &13 + &10;

                          nHasta = 20;
     |SI eaOpcion = "3";  nHasta = 21;  |FINSI;

     aAlfa = "";
     |PARA nCampo = 0;  |SI nCampo [ nHasta;  |HACIENDO nCampo = nCampo + 1;
           aAlfa = #538nCampo;
           |XGRABA nHandle2, aAlfa;
     |SIGUE;
|FPRC;

|PROCESO camal349;  || Registro 2
     |DDEFECTO #539;

     #539#0  = "2";

     #539#1  = "349";

     #539#2  = #538#2;
     #539#3  = #538#3;
     #539#4  = "";

     #539#5  = #2#5;
     |SI #2#5 = "GR ";  #539#5 = "EL";  |FINSI;

     #539#6  = #2#6;

     #539#7  = #2#7;

     |SI #2#4  = "A";  #539#8 = "A";  |FINSI;
     |SI #2#4  = "E";  #539#8 = "E";  |FINSI;
     |SI #2#4  = "I";  #539#8 = "I";  |FINSI;
     |SI #2#4  = "S";  #539#8 = "S";  |FINSI;
     |SI #2#4  = "M";  #539#8 = "M";  |FINSI;
     |SI #2#4  = "H";  #539#8 = "H";  |FINSI;

     |SI #2#4  = "X";  #539#8 = "A";  |FINSI;
     |SI #2#4  = "Y";  #539#8 = "I";  |FINSI;
     |SI #2#4  = "Z";  #539#8 = "S";  |FINSI;
     |SI #2#4  = "W";  #539#8 = "M";  |FINSI;
     |SI #2#4  = "V";  #539#8 = "H";  |FINSI;

     |SI #539#2 ] 2020;
         |SI #2#4  = "U";  #539#8 = "E";  |FINSI;
         |SI #2#4  = "R";  #539#8 = "R";  |FINSI;
         |SI #2#4  = "T";  #539#8 = "R";  |FINSI;
         |SI #2#4  = "D";  #539#8 = "D";  |FINSI;
         |SI #2#4  = "Q";  #539#8 = "D";  |FINSI;
         |SI #2#4  = "C";  #539#8 = "C";  |FINSI;
         |SI #2#4  = "P";  #539#8 = "C";  |FINSI;
     |SINO;
         |SI #2#4  = "R";  #539#8 = "E";  |FINSI;
     |FINSI;

     |SI #2#13 = "X";  #539#8 = "T";  |FINSI;

     nOk = 0;
     |SI #539#2 ] 2020;
         |SI #2#4 = "A";  |O #2#4 = "E";  |O #2#4 = "S";  |O #2#4 = "I"; |O #2#4 = "M";
            |O #2#4 = "H"; |O #2#4 = "R";  |O #2#4 = "D";  |O #2#4 = "C";
             nOk = 1;
         |FINSI;
     |SINO;
         |SI #2#4 = "A";  |O #2#4 = "E";  |O #2#4 = "S";  |O #2#4 = "I"; |O #2#4 = "M"; |O #2#4 = "H";
             nOk = 1;
        |FINSI;
     |FINSI;

     |SI nOk = 1;
         enNume = #2#8;   |HAZ Conver13;
         #539#9 = eaAlfa;

         #539#10 = "";

         #539#11 = "";

         #539#12 = "";

         #539#13 = "";
     |SINO;
         #539#9  = "";

         nAnyo   = 2000  + #2#11;
         #539#10 = nAnyo;

         |SI #2#12 = 0;   #539#11 = "0A";   |FINSI;
         |SI #2#12 = 1;   #539#11 = "1T";   |FINSI;
         |SI #2#12 = 2;   #539#11 = "2T";   |FINSI;
         |SI #2#12 = 3;   #539#11 = "3T";   |FINSI;
         |SI #2#12 = 4;   #539#11 = "4T";   |FINSI;
         |SI #2#12 = 11;  #539#11 = "01";   |FINSI;
         |SI #2#12 = 12;  #539#11 = "02";   |FINSI;
         |SI #2#12 = 13;  #539#11 = "03";   |FINSI;
         |SI #2#12 = 14;  #539#11 = "04";   |FINSI;
         |SI #2#12 = 15;  #539#11 = "05";   |FINSI;
         |SI #2#12 = 16;  #539#11 = "06";   |FINSI;
         |SI #2#12 = 17;  #539#11 = "07";   |FINSI;
         |SI #2#12 = 18;  #539#11 = "08";   |FINSI;
         |SI #2#12 = 19;  #539#11 = "09";   |FINSI;
         |SI #2#12 = 20;  #539#11 = "10";   |FINSI;
         |SI #2#12 = 21;  #539#11 = "11";   |FINSI;
         |SI #2#12 = 22;  #539#11 = "12";   |FINSI;

         enNume = #2#8;   |HAZ Conver13;
         #539#12  = eaAlfa;

         enNume = #2#16;  |HAZ Conver13;
         #539#13  = eaAlfa;
     |FINSI;

     |SI #539#2 ] 2020; |Y #539#8 = "C";
         #539#14 = #2#17;
         |SI #2#17 = "GR ";  #539#14 = "EL";  |FINSI;

         #539#15  = #2#18;

         #539#16  = #2#19;

     |FINSI;

     #539#19 = &13 + &10;

                          nHasta = 18;
     |SI eaOpcion = "3";  nHasta = 19;  |FINSI;

     aAlfa = "";
     |PARA nCampo = 0;  |SI nCampo [ nHasta;  |HACIENDO nCampo = nCampo + 1;
           aAlfa = #539nCampo;
           |XGRABA nHandle2, aAlfa;
     |SIGUE;
|FPRC;

|DEFBUCLE camal349;
     #2#1;
     ;
     #1#0, #1#2, #1#1, 001;
     #1#0, #1#2, #1#1, 999;
     ;
     NULL, camal349;
|FIN;

|PROCESO CreaVarios;
     aIPRemoto   = "";
     |IP_REMOTO aIPRemoto;

     aPathInter  = aPathLanza +  "AInternet/";
     aFichero    = aPathInter + "*.bue";
     |R_PDIR aFichero;
     |PARA; |SI; |HACIENDO;
            |SI FSalida ! 0; |SAL; |FINSI;

            aBue     = aFichero - aPathInter;
            aDestino = aPathInternet + "349" + (aBue % 405) + ".txt";

            |RCOPIA_FICHERO aFichero, aDestino;

            |RFBORRA aFichero;

            |R_SDIR aFichero;
     |SIGUE;

     aAlfa =  "      Los ficheros generados estan: " + aPathInternet + " de su PC";
     |MENAV aAlfa;
|FPRC;

|PROCESO Internet2010;
     |BLANCO 0501 2380;

     eaFichError  = "ccc";
     eaFichDatos  = "349";
     eaFichAuxil  = "";
     enValidacion = 1;

     |HAZ BuscaErroresL;

     |SI enBuenos = 0;
         |MENAV "      Ha habido Errores, arreglelos y vuelva a emitir.";
         |ACABA;
     |FINSI;

     #1#4 = #0#15;

     |HAZ CreaVarios;
|FPRC;

|PROCESO Del2010;
     enAnyo     = #0#2;
     eaEjer     = #0#2;
     eaPeriodo  = (("00" + #0#28) % -102);

     aPathInternet = eaUnidadBasico + "/AEAT";              |RMKDIR aPathInternet;
     aPathInternet = aPathInternet + "/INTERNET";           |RMKDIR aPathInternet;
     aPathInternet = aPathInternet + "/349";                |RMKDIR aPathInternet;
     aPathInternet = aPathInternet + "/" + #0#2;            |RMKDIR aPathInternet;
     aPathInternet = aPathInternet + "/" + eaPeriodo;       |RMKDIR aPathInternet;
     aPathInternet = aPathInternet + "/";

     aPathLanza = eaUnidadBasico + "\MODELOS";       |RMKDIR aPathLanza;
     aPathLanza = aPathLanza + "\349";               |RMKDIR aPathLanza;
     aPathLanza = aPathLanza + "\" + #0#2;           |RMKDIR aPathLanza;
     aPathLanza = aPathLanza + "\";

     |DBASE aPathEmision;
     aPathEmision = aPathEmision + "emisiones";                     |MKDIR aPathEmision;
     aPathEmision = aPathEmision + "/349";                          |MKDIR aPathEmision;
     aPathEmision = aPathEmision + "/" + #0#2;                      |MKDIR aPathEmision;
     aPathEmision = aPathEmision + "/" + (("00" + #0#28) % -102);   |MKDIR aPathEmision;
     aPathEmision = aPathEmision + "/";

     aAlfa = #0#2;
     aAlfa = aAlfa % -102;
     nAnyo = aAlfa;

     |ABRE #1;
     #1#0 = #30#2;
     #1#2 = #0#36;
     #1#1 = #0#28;
     |LEE 101#1=;
     |SI FSalida ! 0; |CIERRA #1; |ACABA; |FINSI;

     #1#4 = "";

     aAbre = aPathEmision + "349" + (("00000" + #30#2) % -105) + ".TXT";
     |XABRE "BW", aAbre, nHandle2;

     |HAZ Registro1;

     |BUCLE camal349;

     |XCIERRA nHandle2;

     eaFOrigen  = aPathEmision + "349" + (("00000" + #30#2) % -105) + ".TXT";
     eaFDestino = aPathLanza   + "349" + (("00000" + #30#2) % -105) + ".TXT";
     |HAZ CopiaFicheroIP;

     |FBORRA eaFOrigen;

     eaModelos = "349";
     eaTipoE   =  "349" + (("00000" + #30#2) % -105) + ".TXT";
     eaTipoR   =  "CCC" + (("00000" + #30#2) % -105) + ".TXT";
     eaTipoV   =  "S";
     |HAZ LineaShellJava;

     |HAZ Internet2010;

     |GRABA 020#1a;

     |LIBERA #1;
     |CIERRA #1;
|FPRC;


|PROCESO Del2013;
     |HAZ LeeUnidad;

     |ABRE #1;
     #1#0 = #30#2;
     #1#2 = #0#36;
     #1#1 = #0#28;
     |LEE 101#1=;
     |SI FSalida ! 0; |CIERRA #1; |ACABA; |FINSI;

     enAnyo     = #0#2;
     eaEjer     = #0#2;
     eaModelos  = "349";
     eaOpcion   = "3";
     eaPeriodo  = ("00" + #0#28) % -102;
     perialf    = ("00" + #0#28) % -102;
     |SI #1#16 = "T";
         |SI #0#28 = 1;  perialf = "1T"; |FINSI;
         |SI #0#28 = 2;  perialf = "2T"; |FINSI;
         |SI #0#28 = 3;  perialf = "3T"; |FINSI;
         |SI #0#28 = 4;  perialf = "4T"; |FINSI;
     |FINSI;

     eaPathLanza = eaUnidad + "\MODELOS";            |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + eaModelos;    |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + eaEjer;       |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + perialf;      |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\";

     |DBASE eaPathEmision;
     eaPathEmision = eaPathEmision + "emisiones";       |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + eaModelos;   |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + eaEjer;      |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + perialf;     |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/";

     eaPathInternet = eaUnidad + "/AEAT";                |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/INTERNET";      |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + eaModelos;  |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + eaEjer;     |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + perialf;    |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/";

     |HAZ PreguntaPresentacion;
     |HAZ TraeTgzCobol;

     aAlfa = #0#2;
     aAlfa = aAlfa % -102;
     nAnyo = aAlfa;

     #1#4 = "";

     eaFicheroPlano = "349" + (("00000" + #1#0) % -105) + ".txt";
     eaFicheroImpre = "349" + (("00000" + #1#0) % -105) + ".imp";
     eaFicheroSalid = "349" + (("00000" + #1#0) % -105) + ".sal";
     eaFicheroError = "err" + (("00000" + #1#0) % -105) + ".txt";

     aAbre = eaPathEmision + eaFicheroPlano;
     |XABRE "BW", aAbre, nHandle2;

     |HAZ Registro1;

     |BUCLE camal349;

     |XCIERRA nHandle2;

     enEmpresa    = #1#0;
     eaNomEmpresa = #1#3;

     |HAZ PresentaPortal;

     |SI enErrorPortal = 0;
         #1#4 = #0#15;
     |FINSI;

     |GRABA 020#1a;

     |LIBERA #1;
     |CIERRA #1;

     |HAZ SacaErrorPtl;

     |SI enPresentar = 0;
         aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
         |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO Botones349_2018;
     |BLANCO 0501 2380;

     |CONTROL_SIMPLE 0, "LBOTON, <F2> Presentacion Telematica      ", 0513, 0654, BotonF2;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F3> Borrador con validacion ", 0813, 0954, BotonF3;
     nBoton2 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,ESC Cancelar", 2365, 2378, BotonEsc;
     nBoton3 = FSalida;

     aF2  = &255 + "824";
     aF3  = &255 + "825";
     aEsc = &255 + "806";

     eaOpcion = "0";
     |PARA; |SI;  |HACIENDO;
         |LEETECLA aTecla;

         |SI aTecla = aF2;  eaOpcion = "3"; |SAL;  |FINSI;
         |SI aTecla = aF3;  eaOpcion = "1"; |SAL;  |FINSI;
         |SI aTecla = aEsc;                 |SAL;  |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;

                          enTecla = 0;
     |SI eaOpcion = "1";  enTecla = 1;  |FINSI;
     |SI eaOpcion = "3";  enTecla = 3;  |FINSI;

     |PULSATECLA;
|FPRC;

|PROCESO Del2018;
     |HAZ LeeUnidad;

     |ABRE #1;
     #1#0 = #30#2;
     #1#2 = #0#36;
     #1#1 = #0#28;
     |LEE 101#1=;
     |SI FSalida ! 0; |CIERRA #1; |ACABA; |FINSI;

     enAnyo     = #0#2;
     eaEjer     = #0#2;
     eaModelos  = "349";
     eaOpcion   = "3";
     eaPeriodo  = ("00" + #0#28) % -102;
     perialf    = ("00" + #0#28) % -102;
     |SI #1#16 = "T";
         |SI #0#28 = 1;  perialf = "1T"; |FINSI;
         |SI #0#28 = 2;  perialf = "2T"; |FINSI;
         |SI #0#28 = 3;  perialf = "3T"; |FINSI;
         |SI #0#28 = 4;  perialf = "4T"; |FINSI;
     |FINSI;

     eaPathLanza = eaUnidad + "\MODELOS";            |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + eaModelos;    |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + eaEjer;       |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + perialf;      |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\";

     |DBASE eaPathEmision;
     eaPathEmision = eaPathEmision + "emisiones";       |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + eaModelos;   |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + eaEjer;      |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + perialf;     |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/";

     eaPathInternet = eaUnidad + "/AEAT";                |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/INTERNET";      |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + eaModelos;  |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + eaEjer;     |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + perialf;    |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/";

     |HAZ Botones349_2018;
     |SI enTecla = 0;  |ACABA;  |FINSI;

     |SI enTecla = 3;
         |HAZ PreguntaPresentacion;
     |FINSI;

     aAlfa = #0#2;
     aAlfa = aAlfa % -102;
     nAnyo = aAlfa;

     #1#4 = "";

     eaFicheroPlano = "349" + (("00000" + #1#0) % -105) + ".txt";
     eaFicheroImpre = "349" + (("00000" + #1#0) % -105) + ".imp";
     eaFicheroSalid = "349" + (("00000" + #1#0) % -105) + ".sal";
     eaFicheroError = "err" + (("00000" + #1#0) % -105) + ".txt";

     aAbre = eaPathEmision + eaFicheroPlano;
     |XABRE "BW", aAbre, nHandle2;

     |HAZ Registro1;

     |BUCLE camal349;

     |XCIERRA nHandle2;

     enEmpresa    = #1#0;
     eaNomEmpresa = #1#3;

     |HAZ PresentaPortal;

     |SI enErrorPortal = 0;
         #1#4 = #0#15;
     |FINSI;

     |GRABA 020#1a;

     |LIBERA #1;
     |CIERRA #1;

     |SI enTecla = 3;
         |SI enPresentar = 0;
             aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
             |MENAV aAlfa;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Distribuye; |TIPO 3;
   |HAZ LeeUnidadBasico;

   enEjercicio = #0#2;
   eaOpcion    = "3";
   enTecla     = 3;

   |SI #0#2 [ 2009;   |HAZ Del2009;   |FINSI;
   |SI #0#2 = 2010;   |HAZ Del2010;   |FINSI;
   |SI #0#2 = 2011;   |HAZ Del2010;   |FINSI;
   |SI #0#2 = 2012;   |HAZ Del2010;   |FINSI;
   |SI #0#2 = 2013;   |HAZ Del2013;   |FINSI;
   |SI #0#2 = 2014;   |HAZ Del2013;   |FINSI;
   |SI #0#2 = 2015;   |HAZ Del2013;   |FINSI;
   |SI #0#2 = 2016;   |HAZ Del2013;   |FINSI;
   |SI #0#2 = 2017;   |HAZ Del2013;   |FINSI;
   |SI #0#2 ] 2018;   |HAZ Del2018;   |FINSI;
|FPRC;
