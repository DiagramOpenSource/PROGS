|FICHEROS;
   camic347 #0;
   camil347 #1;
   eosclipr #2,MANTE;
   cautm347 #3;
   agipobla #4;
   agiprovi #5;
   caclipro #6;
   canempre #30;
   agicontr #23;

   camac347 #7;
   camal347 #8;
|FIN;

|VARIABLES;
 mod       = 0;
 men1      = "0000SEs correcto S/N : ";
 men2      = "0000NLo Grabo en el Fichero General : ";
 men6      = "    NConfirma el Alta en Fichero General (S/N): ";
 error1    = "     La empresa no tiene impreso del 347 ";
 verrfec   = "0000ATENCION !! Fecha erronea o formato incorrecto ";
 vdia1     = "";
 vme1      = "";
 vany1     = "";
 vdia      = 0;
 vme       = 0;
 vany      = 0;
 vtope     = 0;
 vsw       = 0;
 vfec      = "";
 vblanco   = "          ";
 vpuntos   = "..........";
 v         = 0;
 SwError   = 0;
 Flag      = 0;
 Linea     = 0;
 vacio     = "                                        ";
 cliente   = "";
 cuarenta  = "                                        ";

     letra = "";
     alfa1 = "";
     alfa2 = "";
     final = "";
     x = "";
     nume1 = 0;
     nume2 = 0;
     lugar = 0;
     nifnum = 0;
     resto = 0;

 &elcampo0 = "";
 &elcampo1 = "";
 &elcampo2 = "";
 &elcampo3 = "";
 &elcampo4 = "";
 &elcampo5 = "";
 &elcampo6 = "";
 &elcampo7 = "";
 &elcampo8 = 0;
 &elcampo9 = 0;
 &elcampo10= "";
 &elcampo11= "";
 &elcampo12= "";
 &swentra  = 0;
 &swmodi   = 0;
 swmod   = 0;
 directo = "";
 direct1 = "";
 traba = "";
 dprocli = "";
 eselbase = "";
 salida = 0;
   &aste = "";
   agi = "";
   &agi1 = "";
   &agi2 = "";
   num = 0;
   longi = "";

     aNifQbf1   = "";
     aNifQbf2   = "";

     &eaVarDni  = "";
     &enCalcCif = 0;


  nCampo1 = 0;
  nCampo2 = 0;
  nCampo3 = 0;
  nCampo4 = 0;
  nCampo7 = 0;
  aCampo6 = "";
  nModo   = 0;
|FIN;

|INCLUYE acceso_i;
|INCLUYE varnue_i;

|PROCESO alentrar;  |TIPO 8;
  |HAZ inicio;
  |HAZ eVarEmpresa;
  |HAZ tipo_8; || comprueba la existencia de la ficha general
  |SI aste ! "*";
      |PATH_DAT #2 agi1;
      |PATH_DAT #4 agi1;
      |PATH_DAT #5 agi1;

      |PATH_PAN #2 agi2;
      |PATH_PAN #4 agi2;
      |PATH_PAN #5 agi2;
  |FINSI;

  |SI enEjercicio > 2010; |C_M #1#4,1,"N"; |FINSI;
|FPRC;

|PROCESO antesque;  |TIPO 7;
  |ABRE #30;
  #30#2 = cod1;
  #30#3 = cod2;
  |LEE 040#30=;
  #0#0 = #30#2;
  #0#1 = #30#1;
  #0#4 = #30#26;
  |PINTA #0#0;
  |PINTA #0#1;
  |CIERRA #30;
|FPRC;

|PROCESO despuesde;
  |SI #0#0 ! cod1;
      |ERROR;
      #0#0 = cod1;
      |PINTA #0#0;
      |ACABA;
  |FINSI;
|FPRC;

|PROCESO conficha;
  |SI aste ! "*";
      |ABRE #2;
      |PUSHV 0501 2380;
      |PINPA #0#2;
      #2#0 = #1#2;
      |LEE 000#2];
      |CONSULTA #0#2;
      #1#2 = #2#0;
      |CIERRA #2;
  |SINO;
      |ABRE #6;
      |SELECT #4#6;
      |PUSHV 0501 2380;
      |PINPA #0#6;
      #6#9 = #1#2;
      |LEE 000#6=;
      |CONSULTA #3#6;
      #1#2 = #6#9;
      |CIERRA #6;
  |FINSI;
  |POPV;
  |PINTA #1#2;
|FPRC;

|PROCESO cliente;
  salida = FSalida;
  |SI salida = 9;  |HAZ letra_0;  |FINSI;
  |SI salida = 10; |HAZ conficha; |FINSI;

  |ABRE #3;
  |DDEFECTO #3;
  swmodi = 0;
  swmod  = 0;

|SI aste ! "*"; |Y #1#2 ! "            ";
    |ABRE #2;
    #2#0 = #1#2;
    |LEE 040#2=;
    |SI FSalida = 0;
        #1#3  = #2#1; #1#5  = #2#2; #1#6  = #2#3;
        #1#7  = #2#4; #1#9  = #2#5; #1#10 = #2#6;
        #1#11 = #2#7; #1#12 = #2#8; #1#13 = #2#9;
        #1#14 = #2#10;
        swmod = 1;
    |SINO;
        |HAZ altaclipr;
    |FINSI;
    |CIERRA #2;
|FINSI;
|SI swmod = 0;
    |ABRE #6;
    |SELECT #4#6;
    |DDEFECTO #6;
    #6#9 = #1#2;
    |LEE 040#6=;
    |SI FSalida = 0;
        #1#3 = #6#1; #1#6  = #6#2; #1#11 = #6#3;
        #1#12 = #6#4; #1#13 = #6#5; #1#14 = #6#6;
    |FINSI;
    |CIERRA #6;
|FINSI;
 |HAZ cargavar;
 |SI swentra = 1;
     |HAZ recovar;
     |SI aste ! "*"; |Y swmodi = 0;
         |CONFI men2;
         |SI FSalida = 0; |HAZ grabagen; |FINSI;
     |FINSI;
 |SINO;
     |ERROR;
 |FINSI;
|PINTA #1#3;
|CIERRA #3;
|FPRC;

|PROCESO grabagen;
   |ABRE #2;
   #2#0 = #1#2;
   |LEE 040#2=;
   salida = FSalida;
   |SI salida ! 0; |DDEFECTO #2; |FINSI;
   #2#0 = #1#2;  #2#1 = #1#3;  #2#2 = #1#5;
   #2#3 = #1#6;  #2#4 = #1#7;  #2#5 = #1#9;
   #2#6 = #1#10; #2#7 = #1#11; #2#8 = #1#12;
   #2#9 = #1#13; #2#10 = #1#14;
   |SI salida ! 0;
       |GRABA 040#2n;
   |SINO;
       |GRABA 040#2a;
   |FINSI;
   |LIBERA #2;
   |CIERRA #2;
|FPRC;

|PROCESO cargavar;
  swentra  = 0;
  elcampo0 = #1#2;
  elcampo1 = #1#3;
  elcampo2 = #1#5;
  elcampo3 = #1#6;
  elcampo4 = #1#7;
  elcampo5 = #1#8;
  elcampo6 = #1#9;
  elcampo7 = #1#10;
  elcampo8 = #1#11;
  elcampo9 = #1#12;
  elcampo10 = #1#13;
  elcampo11 = #1#14;
  elcampo12 = #1#18;
  |SUB_EJECUTA "cautm347.tab";
|FPRC;

|PROCESO recovar;
  #1#2  = elcampo0; elcampo0 = "";
  #1#3  = elcampo1; elcampo1 = "";
  #1#5  = elcampo2; elcampo2 = "";
  #1#6  = elcampo3; elcampo3 = "";
  #1#7  = elcampo4; elcampo4 = "";
  #1#8  = elcampo5; elcampo5 = "";
  #1#9  = elcampo6; elcampo6 = "";
  #1#10 = elcampo7; elcampo7 = "";
  #1#11 = elcampo8; elcampo8 = 0;
  #1#12 = elcampo9; elcampo9 = 0;
  #1#13 = elcampo10; elcampo10 = "";
  #1#14 = elcampo11; elcampo11 = "";
  #1#18 = elcampo12; elcampo12 = "";
|FPRC;

|| //////////////////////////////////////////////////////////

|PROCESO BuscaDecl;
  Linea = #8#1;
  SwError = 1;
|FPRC;

|DEFBUCLE BuscaDecl;
  #8#1;
  2,3,14,30;
  #1#0, 00001, 1, #1#2, "S", #1#24;
  #1#0, 99999, 1, #1#2, "S", #1#24;
  ;
  NULL,BuscaDecl;
|FIN;


|PROCESO actualiz; |TIPO 2;

      nModo = (FEntrada / 100) ! 0;

      #0#2 = #0#2 +. 1;
      #0#3 = #0#3 +. #1#4;
      |PINTA #0#2;
      |PINTA #0#3;

|FPRC;


|PROCESO RecalculaCab;
   |SI #8#2 = 1; |Y #8#14 = "S";
       |SI #8#5 = 0; |Y #8#20 = 0; |Y #8#21 = 0; |Y #8#22 = 0;
            |Y #8#23 = 0; |Y #8#19 = 0; |Y #8#17 = 0;
           |BORRA 020#8a;
           |ACABA;
       |FINSI;
   |FINSI;


   |SI #8#2 = "2";
       #7#6 = #7#6 + 1;
       #7#7 = #7#7 + #8#5;
   |FINSI;

   |SI #8#2 = "1";
      #7#8 = #7#8 + 1;
      #7#9 = #7#9 + #8#5;
   |FINSI;

   |SI #8#2 = "3";
      #7#10 = #7#10 + 1;
      #7#11 = #7#11 + #8#5;
   |FINSI;

   |SI #8#2 = "4";
      #7#12 = #7#12 + 1;
      #7#13 = #7#13 + #8#5;
   |FINSI;

   |SI #8#2 = "5";
      #7#14 = #7#14 + 1;
      #7#15 = #7#15 + #8#5;
   |FINSI;

|FPRC;

|DEFBUCLE RecalculaCab;
  #8#1;
  ;
  #7#0, 00001;
  #7#0, 99999;
  ;
  NULL, RecalculaCab;
|FIN;

|PROCESO LineasInmI;
      SwError = 0;
      Linea   = 0;
      |BUCLE BuscaDecl;
      |SI SwError = 1;
          |ABRE #8;
          #8#0 = #1#0;
          #8#1 = Linea;
          |LEE 101#8=;
          |SI FSalida = 0;
              #8#5  = #8#5  + #1#4;
              #8#20 = #8#20 + #1#19;
              #8#21 = #8#21 + #1#20;
              #8#22 = #8#22 + #1#21;
              #8#23 = #8#23 + #1#22;
              #8#31 = #8#31 + #1#23;
              #8#30 = #1#24;
              |SI #1#24 = "S";
                  #8#20 = 0;
                  #8#21 = 0;
                  #8#22 = 0;
                  #8#23 = 0;
              |FINSI;
              |GRABA 020#8a;
         |FINSI;
         |LIBERA #8;
         |CIERRA #8;
      |SINO;
         |ABRE #8;
         #8#0 = #1#0;
         #8#1 = 99999;
         |LEE 040#8];
         |SI FSalida = 0;
             |LEE 040#8a;
         |SINO;
             |LEE 040#8u;
         |FINSI;
         Linea = 1;
         |SI FSalida = 0; |Y #8#0 = #1#0;
             Linea = #8#1 + 1;
         |FINSI;

         |DDEFECTO #8;
         #8#0  = #1#0;
         #8#1  = Linea;
         |GRABA 020#8b;

         #8#2  = "1";
         #8#3  = #1#2;
         #8#4  = #1#3;
         #8#6  = #1#5;
         #8#7  = #1#6;
         #8#8  = #1#7;
         #8#9  = #1#11;
         #8#10 = #1#12;
         #8#11 = #1#13;
         #8#12 = #1#14;
         #8#13 = "N";
         #8#14 = "S";
         #8#15 = "N";
         #8#28 = "N";
         #8#29 = "N";
         #8#30 = #1#24;

         #8#5  = #1#4;
         #8#20 = #1#19;
         #8#21 = #1#20;
         #8#22 = #1#21;
         #8#23 = #1#22;
         #8#31 = #1#23;
         |SI #1#24 = "S";
             #8#20 = 0;
             #8#21 = 0;
             #8#22 = 0;
             #8#23 = 0;
         |FINSI;
         |GRABA 020#8a;
         |LIBERA #8;
         |CIERRA #8;
      |FINSI;
|FPRC;

|DEFBUCLE LineasInmI;
  #1#1;
  ;
  #0#0, 00001;
  #0#0, 99999;
  ;
  NULL,LineasInmI
|FIN;

|PROCESO LineasInm;
   #8#5  = 0;
   #8#20 = 0;
   #8#21 = 0;
   #8#22 = 0;
   #8#23 = 0;
   #8#31 = 0;
   |GRABA 020#8a;
   |LIBERA #8;
|FPRC;

|DEFBUCLE LineasInm;
  #8#1;
  2,14;
  #0#0, 00001, 1, "S";
  #0#0, 99999, 1, "S";
  ;
  NULL,LineasInm;
|FIN;

|PROCESO Tipo1; |TIPO 1;
   nModo = (FEntrada / 100) ! 0;
   |SI nModo = 3;
       |BUCLE LineasInm;
       |HAZ RecalCabecera;
   |FINSI;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
    |BUCLE LineasInm;
    |BUCLE LineasInmI;

    |HAZ RecalCabecera;
|FPRC;

|PROCESO RecalCabecera;
    |ABRE #7;
    #7#0 = #0#0;
    |LEE 101#7=;
    |SI FSalida = 0;
        #7#6  = 0; #7#7  = 0;
        #7#8  = 0; #7#9  = 0;
        #7#10 = 0; #7#11 = 0;
        #7#12 = 0; #7#13 = 0;
        #7#14 = 0; #7#15 = 0;
        |BUCLE RecalculaCab;
        |GRABA 020#7a;
        |LIBERA #7;
    |FINSI;
    |CIERRA #7;
|FPRC;

|PROCESO letra_0;  |TIPO 6;
     |SI FSalida = 9;
         eaVarDni   = #1Campo;
         enCalcCif  = 1;
         |HAZ CalculoDNI;
         #1Campo = eaVarDni;
         |PINTA #1Campo;
         |ERROR;
         |ACABA;
     |FINSI;

     eaVarDni  = #1Campo;
     enCalcCif = 0;
     |HAZ CalculoDNI;

     aNifQbf1 = #1Campo;   |QBF aNifQbf1;
     aNifQbf2 = eaVarDni;  |QBF aNifQbf2;

     |SI aNifQbf1 ! aNifQbf2; |Y aNifQbf1 ! "";
         |CONFI "0000SEl Nif puede ser Erroneo. Desea Calcularlo.";
         |SI FSalida = 0;
             #1Campo = eaVarDni;  |PINTA #1Campo;
             |ERROR;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO tipo_8; || control de la ficha de clientes general
  |DIRECTORIO agi;
  |QBF agi;
  |PATH_DAT #23 agi;

|ABRE #23;
#23#0 = 1;
|LEE 040#23=;
|SI FSalida ! 0; aste = "*"; |CIERRA #23; |ACABA; |FINSI;
|CIERRA #23;
aste = #23#7;
|QBF aste;
|SI aste  = "*"; |ACABA; |FINSI;

agi1 = #23#8; |QBF agi1;

longi = agi1 % 0;
num   = longi;
num   = 100 + (num - 5);
longi = num;

agi2  = (agi1 % longi) + "pan/";
|FPRC;

|PROCESO altaclipr;
|SI aste = "*"; |ACABA; |FINSI;
    |CONFI men6;
    |SI FSalida = 0;
        |PUSHV 0501 2380;
        |PINPA #0#2;
        |DDEFECTO #2;
        |PINDA #0#2;
        #2#0 = #1#2;
        |PINTA #2#0;
        |ENDATOS #1#2;
        |SI FSalida = 0;
            |POPV;
            #1#3 = #2#1; #1#5  = #2#2; #1#6  = #2#3; #1#7  = #2#4;
            #1#11 = #2#7; #1#12 = #2#8; #1#11 = #2#9; #1#12 = #2#10;
            swmodi=1; swmod = 1;
            |GRABA 020#2n;                 || Graba el agicli
        |SINO;
            |POPV;
        |FINSI;
    |FINSI;
|LIBERA #2;
|CIERRA #2;
|FPRC;

|PROCESO PanTrimes;
          |PUSHV 1236 2080;
          |BLANCO 1236 1974;
          |CUADRO 1236 1974;

          |PINTA 1338, "Importe:                           ";
          |PINTA 1438, "1§ Trimestre .........:            ";
          |PINTA 1538, "2§ Trimestre .........:            ";
          |PINTA 1638, "3§ Trimestre .........:            ";
          |PINTA 1738, "4§ Trimestre .........:            ";
          |SI enEjercicio ] 2014;
              |C_V #1#24,1,"S"; |C_V #1#23,1,"S";
              |PINTA 1838, "Op. IVA de Caja ..:                ";
              |PINTA 1858, #1#24;
              |PINTA 1862, #1#23;
          |FINSI;

          |PINTA 1362, #1#4;
          |PINTA 1462, #1#19;
          |PINTA 1562, #1#20;
          |PINTA 1662, #1#21;
          |PINTA 1762, #1#22;
|FPRC;

|PROCESO Totales;
         #1#19 = nCampo1;
         #1#20 = nCampo2;
         #1#21 = nCampo3;
         #1#22 = nCampo4;
         #1#4  = #1#19 + #1#20 + #1#21 + #1#22;
         |PINTA 1362, #1#4;
         #1#23 = nCampo7;
         #1#24 = aCampo6;
|FPRC;

|PROCESO Pedir2011;
         |HAZ PanTrimes;

         nCampo1 = #1#19; nCampo2 = #1#20;
         nCampo3 = #1#21; nCampo4 = #1#22;
         aCampo6 = #1#24; nCampo7 = #1#23;

         |ET nCampo1_3;
             E_inf = "-999999999.?EURO";
             E_sup = "9999999999";
             nCampo1 = 1462 ? 1;
             |SI FSalida = 1;  |VETE Abajo_3;    |FINSI;
             |SI FSalida = 7;  |VETE Abajo_3;    |FINSI;
             |HAZ Totales;

         |ET nCampo2_3;
             E_inf = "-999999999.?EURO";
             E_sup = "9999999999";
             nCampo2 = 1562 ? 1;
             |SI FSalida = 1;  |VETE Abajo_3;    |FINSI;
             |SI FSalida = 2;  |VETE nCampo1_3;  |FINSI;
             |SI FSalida = 7;  |VETE Abajo_3;    |FINSI;
             |HAZ Totales;

         |ET nCampo3_3;
             E_inf = "-999999999.?EURO";
             E_sup = "9999999999";
             nCampo3 = 1662 ? 1;
             |SI FSalida = 1;  |VETE Abajo_3;    |FINSI;
             |SI FSalida = 2;  |VETE nCampo2_3;  |FINSI;
             |SI FSalida = 7;  |VETE Abajo_3;    |FINSI;
             |HAZ Totales;

         |ET nCampo4_3;
             E_inf = "-999999999.?EURO";
             E_sup = "9999999999";
             nCampo4 = 1762 ? 1;
             |SI FSalida = 2;  |VETE nCampo3_3;  |FINSI;
             |HAZ Totales;

         |ET aCampo6_3;
             |SI enEjercicio ] 2014;
                 E_inf = "SNsn";
                 E_sup = 1;
                 aCampo6 = 1858 ? 1; aCampo6 = aCampo6 > " ";
                 #1#24 = aCampo6;
                 |PINTA 1858, #1#24;
                 |SI FSalida = 1;  |VETE Abajo_3;    |FINSI;
                 |SI FSalida = 2;  |VETE nCampo4_3;  |FINSI;
                 |SI FSalida = 7;  |VETE Abajo_3;    |FINSI;

                 |SI aCampo6 = "N";
                     nCampo7 = 0; #1#23 = 0; |PINTA 1862, #1#23;
                 |SINO;
                     E_inf = "-999999999.?EURO";
                     E_sup = "9999999999";
                     nCampo7 = 1862 ? 1;
                     |SI FSalida = 10;
                         nCampo7 = #1#23;
                         #1#23 = nCampo7;
                        |PINTA 1862, #1#23;
                     |FINSI;
                     |SI FSalida = 1;  |VETE Abajo_3;    |FINSI;
                     |SI FSalida = 2;  |VETE aCampo6_3;  |FINSI;
                     |SI FSalida = 7;  |VETE Abajo_3;    |FINSI;
                |FINSI;

                |HAZ Totales;
            |FINSI;

         |ET Abajo_3;
         |HAZ Totales;
         |POPV;
|FPRC;

|PROCESO Importe;
  |SI enEjercicio > 2010;
      |HAZ Pedir2011;
      |PINTA #1#4;
  |FINSI;
|FPRC;
