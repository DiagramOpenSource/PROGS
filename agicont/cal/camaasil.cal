|FICHEROS;
    camaasil #00;        || apuntes lins.
    camaasic #01;        || apuntes cabs.
    cafantas #02;        || def para 'PINTA' de acumulados diario
    caconcep #03;        || conceptos
    cacuenta #04;        || cuentas
    catradia #05;        || actualizacion niveles inferiores
    camandia #06;        || diarios
    cacuentp #10;
    casieaca #11;        || predef. cabs.
    casieali #12;        || predef. lins.
    casiedef #13;        || consulta predef.
    casiedco #14;        || Def para Contrapartidas Predefinidos
    caivarep #15;        || iva repercutido
    caivasop #16;        || iva soportado
    calibros #17;        || libros iva
    caclipro #18;        || clientes/proveedores
    camancob #21;        || cobros
    camanpag #22;        || pagos
    camemori #24;        || ultimas operaciones
    camaasiz #25;        || entrada nombre y cif cliente/proveedor
    caivaasi #26;        || control entrada apuntes
    canempre #30;        || empresas
    calicont #31;        || Contrapartidas
    caivases #50;
    carevisa #51;

    calisfra #997;
    caacrval #998;

    caivarea #120;
    caivarec #111;
    caivaref #112;
    caivasof #113;

    cacon300 #117;

    ca8m0004 #404;
    caivatm4;
|FIN;

|VARIABLES;
    &eaConDes = "";
    aCtaAntDebe = "";  nDigAntDebe  = 0;
    aCtaAntHaber = ""; nDigAntHaber = 0;
    aAlfa  = "";     nCalc = 0;
    aAlfa1 = "";     nFlag = 0;
    SwRepasa = 0;
    nDebe = 0;
    nHaber = 0;
    saldo = 0;
    men2  = "    Longitud de Cuenta Fuera de Nivel !";
    men3  = "    Esta Cuenta NO tiene Pase directo";
    cont = 0;
    long = "  ";
    cta  = 0;
    CtaAct = ""; DigAct = 0; Signo = 0;
    num   = 0;
    sw = 0;
    ctanum = 0;
    ctaalf = "";
    longnum = "";
    vacio = "            ";
    ini = 0;
    fecalf = "";
    mes = "";
    mesfec = 0;
    mesac = 0;
    a = 0;
    b = 0;
    c = 0;
    cuant = "";
    diant = 0;
    &coant = 0;
    &deant = "";
    &cdant = "";
    &dhant = "";
    &imant = 0;
    &dpant = 0;
    &aferlamar = 0;
    &nConcep = 0;
    &aDesc   = "";
    trant = "";
    drant = 0;
    fiac = "  ";
    guarda = "  ";
    relleno = "                                       ";
    aponer = "  ";
    auto = 0;
    &dig1 = 0;
    &dig3 = 0;
    &dig4 = 0;
    &dig5 = 0;
    &dig6 = 0;
    &dig7 = 0;
    &dig8 = 0;
    &dig9 = 0;
    &codcon = 0;
    &modcon = 0;
    opera = "";
    importe = 0;
    cta_t = 0;
    dig_t = 0;
    &entrada = 1;
    xx = 0;
    las_dos = 0;
    otra_vez = 0;
    signo = "";
    &ext1 = "";
    &ext2 = "";
    &ext3 = "";
    &ext4 = "";
    &ext5 = "";
    &extf = @;
    &inkey = 0;
    sit1 = "";
    sit2 = "";
    sit3 = "";
    sit4 = "";
    sit5 = 0;
    sit6 = 0;
    programa = "";
    &predefine = 0;
    &predefine2 = 0;
    sw_hay = 0;
    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    alfa6 = "";
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;
    nume5 = 0;
    nume6 = 0;
    p_eof = 0;
    p_cuenta = "";
    p_linea = 0;
    p_apunte = 0;
    calculo = 0;
    trim1 = @;
    trim2 = @;
    trim3 = @;
    &sw_debe = 0;
    &sw_habe = 0;
    &i_serie = "";
    &i_nserie = "";
    &i_factu = 0;
    &i_fecha = @;
    &i_fechaO = @;
    fecha1  = @;
    i_perio = 0;
    i_cuent = "";
    i_digit = 0;
    i_conce = 0;
    i_descr = "";
    i_depar = "";
    factor = 0;
    &p_tabla = 0;
    &sw_tabla = 0;
    &sw_ptec = 0;
    c_c = 0;
    puntero = 0;
    detector = 0;
    FEstado = 0;
    &avisos = "";
    &f1auto = 0;
    &swCambiar = 0;
    &empre = 0;
    &ejerc = 0;
    i_nom = "";
    i_cif = "";
    i_cc1 = "";
    i_dc1 = 0;
    i_cc2 = "";
    i_dc2 = 0;
    i_signo = 0;
    modo = 0;
    &libro = 0;
    &orden = 0;
    &serie = "";
    &pesetas = 0;
    &cuenta = "";
    &digito = 0;
    &emision = "";
    &repres = "";
    i_acum = "";
    i_impo = 0;
    salidas = 0;
    &p_cen = 0;
    ant1 = 0;
    ant2 = @;
    ant3 = 0;
    ant4 = 0;
    rafa1 = "";
    rafa2 = "";
    raf1 = 0;
    raf2 = 0;
    sumoresto = 0;
    iva1 = 0;
    iva2 = 0;
    iva3 = 0;
    iva4 = 0;
    iva5 = 0;
    req1 = 0.00;
    req2 = 0.00;
    req3 = 0.00;
    req4 = 0.00;
    req5 = 0.00;

    &j_d = 0000;
    &j_h = 0000;
    &fec_am = @;
    &imp_am = 0;
    &ct1_am = "";
    &ct2_am = 0;
    &prv_am = "";
    &c_am = "";
    primer = "";
    &ctab1 = "";
    &ctab2 = 0;
    ctdeant = "";
    dideant = 0;
    cthaant = "";
    dihaant = 0;
    ctpre   = "";
    dipre   = 0;
    &cdiari = 0;
    &cfecha = @;
    &cdocum = 0;
    &clinea = 0;
    &cdefecta = "";
    &cdefedig = 0;
    &LineaExt  = 0;
    &NombreExt = "";
    &CifExt    = "";

    ComodNum = 0;
    &CtrlCtrap = 0;
    &CtrapD = "";
    &DigCtD = 0;
    &CtrapH = "";
    &DigCtH = 0;
    LinAnt = 0;
    SopRep = "";
    Libro  = 0;
    Fact   = 0;
    Serie  = "";

    ModoEntrada = 0;

    Diario    = 0;
    Fecha     = @;
    Documento = 0;
    Linea     = 0;
    Docum     = 0;
    PrimD     = 0;
    PrimH     = 0;

    DepAnt = "";
    irpf = 0;

    Comodin = "";
    Desc   = "";
    Letra  = "";
    Cont   = 0;
 &EURO = 1;
 &EURODB = 0;
 &EURODV = 0;
 &EUROTEXTO = "Cambio de Moneda";
 &swOperacion = 0;  || 0 = Lectura / 1 = Alta
 &enEmpresa = 0;
 &enPeriodo = 0;
 &eaMoneda  = "";
 &eaDepar   = "";
 aBlancs    = "";
   nOpera   = 0;
   nEstado  = 0;
   nEsta11  = 0;

     &eaNomFich    = "";
     &enGrabaSii   = 0;
     &enSiiDoc     = 0;
     &eaSiiSer     = "";
     &eaSiiPro     = "";
     &enSiiLib     = 0;
     &eaSiiDoc     = "";
     &enSiiLin     = 0;
     &enSiiIva     = 0;
     &enSiiMod     = 0;
     &eaSiiCta     = "";
     &eaSiiDig     = "";
     &eaSiiCpt     = "";
     &eaSiiDes     = "";
     &enSiiL       = 0;
     &eaSiiEje     = "";
     &enSiiPer     = 0;
     &enSiiRet     = 0;
     &enSiiUlt     = 0;
     &eaSiiCIF     = "";

    nNoLee = 0;
    i_nomF = "";
    i_cifF = "";
|FIN;

|INCLUYE puntos_i;
|INCLUYE tempo_i;
|INCLUYE vardep_i;
|INCLUYE varnue_i;

|PROCESO SinBarra;  |TIPO 5;
     FSalida = "SINBARRA";
     |ATRI R; |PINTA 0836, #camandia#1; |ATRI N;
|FPRC;

|PROCESO refresca; |TIPO 2;        || calculos de (des)actualizacion
    aCtaAntDebe = #camaasil#10; aCtaAntHaber = #camaasil#16;
    nDigAntDebe = #camaasil#11; nDigAntHaber = #camaasil#17;
    xx = (FEntrada / 100) ! 0;
|SI p_cen = 0;
    |HAZ a_contrap;     || contrapartidas asiento
    |HAZ a_asiento;     || acumulados asiento
    |HAZ a_cuentas;     || acumulados cuenta
    |HAZ pinta_cta;     || pinta los datos de la cuenta
    |HAZ a_diario;      || acumulados diario
    |SI #0#12 = "R";  |HAZ a_ivar;  |FINSI;  || iva repercutido
    |SI #0#12 = "S";  |HAZ a_ivas;  |FINSI;  || iva soportado
    |SI #0#12 = "C";  |HAZ a_cobr;  |FINSI;  || cobros
    |SI #0#12 = "P";  |HAZ a_pago;  |FINSI;  || pagos
    |SI #0#12 = "I";  |HAZ a_impa;  |FINSI;  || impagados
|FINSI;
|FPRC;

|PROCESO saalta; |TIPO 0;               || desde campo 'linea'
    inkey = FSalida;
|SI FEntrada = 101; |Y #0#3 ! 1;
    |SI coant ! 0;
        #0#6 = coant;
        #0#8 = dhant;
        #0#21 = dpant;
    |FINSI;
    |PINTA #0#6;
    |PINTA #0#21;
|FINSI;
|SI predefine ! 0;
    |SI predefine ! 0;             || carga los campos relacionados con IVAS
            #0#12 = #11#3;    || tipo (soportado/repercutido)
            #0#13 = #11#4;    || libro
            #0#14 = i_factu;  || factura/orden
            #0#15 = i_serie;  || serie
            #0#19 = #12#56;   || tipo acumulador IVA
            |SI #12#1 = #11#5; #0#19 = "F"; |FINSI;
            |SI #11#9 = 1;
                |SI #12#56 = "B"; #0#19 = "b"; |FINSI;
                |SI #12#56 = "I"; #0#19 = "i"; |FINSI;
                |SI #12#56 = "R"; #0#19 = "r"; |FINSI;
                |SI #12#56 = "b"; #0#19 = "B"; |FINSI;
                |SI #12#56 = "i"; #0#19 = "I"; |FINSI;
                |SI #12#56 = "r"; #0#19 = "R"; |FINSI;
              |FINSI;
            #0#20 = #12#57;   || nro. acumulador IVA
            |SI #0#19 = "F";|O #0#19 = "f";  #0#20 = 0; |FINSI;
            |SI #11#2 = "N";
                #0#12 = "";
                #0#13 = 0;
                #0#14 = 0;
                #0#15 = "";
                #0#19 = "";
                #0#20 = 0;
            |FINSI;
    |SINO;
            #0#12 = "";
            #0#13 = 0;
            #0#14 = 0;
            #0#15 = "";
            #0#19 = "";
            #0#20 = 0;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO ElCambio;
   swCambiar = 0;

   |SI #0#8 = "D";
       #0#8 = "H";
       #0#10 = #0#16;
       #0#11 = #0#17;
       #0#16 = "";
       #0#17 = 0;
   |SINO;
       #0#8 = "D";
       #0#16 = #0#10;
       #0#17 = #0#11;
       #0#10 = "";
       #0#11 = 0;
   |FINSI;
   |PINTA #0#16;
   |PINTA #0#10;
   |PTEC 806;
|FPRC;

|PROCESO diez;                     || desde calculo 'c_apunte'
    xx = (FEntrada / 100) ! 0;
|SI xx = 1;|Y FSalida ! 1;|Y FSalida ! 7;|Y #0#3 ! 1;
        #0#3 = #0#3 + 9;
    |PINTA #0#3;
|FINSI;
|FPRC;

|PROCESO entmod; |TIPO 1;          || desde campo 'linea'
    coant = #0#6;
    deant = #0#7;
    cdant = #0#24;
    opera = "B";
    |HAZ altatra;
    xx = (FEntrada / 100) ! 0;
    |SI xx = 3;
        |ABRE #31;
        #31#0 = #0#0;
        #31#1 = #0#1;
        #31#2 = #0#2;
        #31#3 = #0#3;
        |LEE 101#31=;
        |SI FSalida = 0;
            |BORRA 020#31a;
        |FINSI;
        |LIBERA #31;
        |CIERRA #31;

        |SI enEjercicio ] 2008; |Y #0#0 = 0;
            |ABRE #404;
            #404#10 = #0#0;
            #404#11 = #0#1;
            #404#12 = #0#2;
            #404#0  = #0#3;
            |LEE 101#404=;
            |SI FSalida = 0;
                |BORRA 020#404a;
            |FINSI;
            |LIBERA #404;
            |CIERRA #404;
        |FINSI;
    |FINSI;
|FPRC;

|PROCESO guarda; |TIPO 3;          || desde campo 'linea'
  ModoEntrada = (FEntrada / 100) ! 0;
  SwRepasa = 1;

  alfa1 = #0#16;   |QBF alfa1;
  alfa2 = #0#10;   |QBF alfa2;
  |SI alfa1 = "";  |Y alfa2 = "";    ||al menos una cuenta cargada;
      avisos = "ATENCION!!! Apunte sin cuentas ...";
      |HAZ aviso5;
      |PAUSA;
      |HAZ aviso9;
|| quitado por PRIEGO, para que estaba esto?
      ||#camaasil#10 = aCtaAntDebe;  #camaasil#11 = nDigAntDebe;
      ||#camaasil#16 = aCtaAntHaber; #camaasil#17 = nDigAntHaber;
      |ERROR;
      |SI predefine ! 0; #12#1 = #12#1 - 1; |FINSI;
      |ACABA;
  |FINSI;
  |SI #0#9 = 0;                       || importe distinto de cero
      avisos = "ATENCION!!! Importe cero ...";
      |HAZ aviso5;
      |PAUSA;
      |HAZ aviso9;
      |ERROR;
      |ACABA;
  |FINSI;
  |SI alfa1 ! "";
      ctdeant = #0#16;
      dideant = #0#17;
  |FINSI;
  |SI alfa2 ! "";
      cthaant = #0#10;
      dihaant = #0#11;
  |FINSI;
  cuant = #0#16;
  diant = #0#17;
  coant = #0#6;
  deant = #0#7;
  cdant = #0#24;
  dhant = #0#8;
  imant = #0#9;
  trant = #0#10;
  drant = #0#11;
  dpant = #0#21;
  |SI #0#16 ! doce; |Y #0#10 ! doce;        || provoca otro apunte
      |SI CtrlCtrap = 0;
          CtrlCtrap = 1;
          CtrapD = #0#10;
          DigCtD = #0#11;
          CtrapH = #0#16;
          DigCtH = #0#17;
          LinAnt = #0#3;
      |SINO;
         |ABRE #calicont;
         |SI CtrlCtrap = 1;
            CtrlCtrap = 2;
            |DDEFECTO #calicont;
            #calicont#0 = #camaasil#0;
            #calicont#1 = #camaasil#1;
            #calicont#2 = #camaasil#2;
            #calicont#3 = LinAnt;
            |LEE 101#calicont.=;
            |SI FSalida ! 0;
               |DDEFECTO #calicont;
               #calicont#0 = #camaasil#0;
               #calicont#1 = #camaasil#1;
               #calicont#2 = #camaasil#2;
               #calicont#3 = LinAnt;
               |GRABA 020#calicont.b;
            |FINSI;
            #calicont#4 = CtrapD;
            #calicont#5 = DigCtD;
            |GRABA 020#calicont.a; |LIBERA #calicont;
            #calicont#0 = #camaasil#0;
            #calicont#1 = #camaasil#1;
            #calicont#2 = #camaasil#2;
            #calicont#3 = LinAnt + 10;
            |LEE 101#calicont.=;
            |SI FSalida ! 0;
               |DDEFECTO #calicont;
               #calicont#0 = #camaasil#0;
               #calicont#1 = #camaasil#1;
               #calicont#2 = #camaasil#2;
               #calicont#3 = LinAnt + 10;
               |GRABA 020#calicont.b;
            |FINSI;
            #calicont#4 = CtrapH;
            #calicont#5 = DigCtH;
            |GRABA 020#calicont.a; |LIBERA #calicont;
         |FINSI;
         #calicont#0 = #camaasil#0;
         #calicont#1 = #camaasil#1;
         #calicont#2 = #camaasil#2;
         #calicont#3 = #camaasil#3;
         |LEE 101#calicont.=;
         |SI FSalida ! 0;
            |DDEFECTO #calicont;
            #calicont#0 = #camaasil#0;
            #calicont#1 = #camaasil#1;
            #calicont#2 = #camaasil#2;
            #calicont#3 = #camaasil#3;
            |GRABA 020#calicont.b;
         |FINSI;
         #calicont#4 = #camaasil#10;
         #calicont#5 = #camaasil#11;
         |GRABA 020#calicont.a; |LIBERA #calicont;
         #calicont#0 = #camaasil#0;
         #calicont#1 = #camaasil#1;
         #calicont#2 = #camaasil#2;
         #calicont#3 = #camaasil#3 + 10;
         |LEE 101#calicont.=;
         |SI FSalida ! 0;
            |DDEFECTO #calicont;
            #calicont#0 = #camaasil#0;
            #calicont#1 = #camaasil#1;
            #calicont#2 = #camaasil#2;
            #calicont#3 = #camaasil#3 + 10;
            |GRABA 020#calicont.b;
         |FINSI;
         #calicont#4 = #camaasil#16;
         #calicont#5 = #camaasil#17;
         |GRABA 020#calicont.a; |LIBERA #calicont;
         |CIERRA #calicont;
      |FINSI;

      #0#4 = #0#16;         || cuenta DEBE
      #0#5 = #0#17;         || digito DEBE
      #0#8 = "D";           || signo DEBE
      #0#10 = "";           || vacia cuenta HABER
      #0#11 = 9;            || vacia digito HABER
      |GRABA 020#0n;        || graba el actual
      opera = "A";
      |HAZ altatra;
      #0#3 = #0#3 + 10;     || aumenta el apunte
      #0#4 = trant;         || cuenta HABER
      #0#5 = drant;         || digito HABER
      #0#16 = "";           || vacia cuenta DEBE
      #0#17 = 9;            || vacia digito DEBE
      #0#6 = coant;         || concepto
      #0#7 = deant;         || descripcion
      #0#24= cdant;         || descripcion 2
      #0#8 = "H";           || signo
      #0#9 = imant;         || importe
      #0#10 = trant;        || cuenta HABER
      #0#11 = drant;        || digito HABER
      #0#21 = dpant;        || departamento
      |GRABA 020#0n;        || graba el provocado
      opera = "A";
      |HAZ altatra;
      |LEE 020#0=;
      #0#16 = cuant;
      #0#17 = diant;
      #0#6 = coant;
      #0#7 = deant;
      #0#24 = cdant;
      #0#8 = dhant;
      #0#9 = imant;
      #0#10 = trant;
      #0#11 = drant;
      #0#21 = dpant;          || departamento
      aponer = "kksi";
      |HAZ poncontr;
      Pos = -1;
      |PTEC 809;
      |PTEC 809;
      |PTEC 808;
  |SINO;
       opera = "A";
       |HAZ altatra;
  |FINSI;
  |SI sumoresto = 1;
      aponer = "kksi";
      |HAZ poncontr;
      Pos = -1;
      sumoresto = 0;
      |PTEC 809;
      |PTEC 809;
  |FINSI;
  ctpre = #0#4;
  dipre = #0#5;

  |SI enEjercicio ] 2008; |Y #0#0 = 0;

      |ABRE #404;
      |LEE 001#404p;
      |SI FSalida = 0;
          |SI #404#10 = #0#0; |Y #404#11 = #0#1; |Y #404#12 = #0#2;
              #404#0 = #0#3;
              |LEE 001#404=;
              nEstado = FSalida;
              nume1 = #404#4 + #404#5;
              |SI #404#3 ! #0#8; |O nume1 ! #0#9; |O #404#8 ! #0#4;
                  #404#14 = "*";
              |FINSI;
              #404#10 = #0#0;
              #404#11 = #0#1;
              #404#12 = #0#2;
              #404#0  = #0#3;
              #404#3  = #0#8;
              |SI #404#3 = "D"; #404#4 = #0#9; #404#5 = 0; |FINSI;
              |SI #404#3 = "H"; #404#4 = 0; #404#5 = #0#9; |FINSI;
              #404#8 = #0#4;
              #404#9 = #0#5;
              #404#13 = #0#21;
              |SI nEstado = 0;
                  |GRABA 020#404a;
              |FINSI;
              |SI nEstado ! 0;
                  #404#1  = "";
                  #404#2  = #cacuenta#2;
                  #404#6  = "Nueva por introduccion";
                  #404#7  = #0#5;
                  #404#14 = "*";
                  |GRABA 020#404n;
              |FINSI;
          |FINSI;
      |FINSI;
      |CIERRA #404;
  |FINSI;
|FPRC;


|PROCESO funcion1; |TIPO 11;                  || desde campo 'linea'
  inkey = FSalida;

  |SI SwRepasa = 1; |HAZ RepasaCtraps; SwRepasa = 0; |FINSI;

  |SI inkey = 1; |O inkey = 7;
      |SI #1#6 ! 0;
          |CONFI "    NAVISO !!! Asiento Descuadrado. Desea Salir S/N ";
          |SI FSalida ! 0;
              |ERROR;
          |FINSI;
          inkey = 0;
          |ACABA;
      |FINSI;
  |FINSI;

  |SI inkey = 16;
      |HAZ RevisionPartida;
  |FINSI;

  modo = (FEntrada / 100) ! 0;
  |SI modo ! 1;
      |HAZ funcion2;
  |SINO;
      |SI Campo = 3;  |Y inkey = 14;  |Y  #1#6 = 0;  |Y #1#4 ! 0;  |Y #1#5 ! 0;
          |PTEC 802;
          |PTEC 802;
          |PTEC 802;
          |PTEC 802;
          |PTEC 802;
          |PTEC 806;
          |PTEC 807;
      |SINO;
          |SI inkey ] 9;|Y inkey [ 20;
              |AVISO;
              |ERROR;
          |FINSI;
     |FINSI;
  |FINSI;
|FPRC;

|PROCESO funcion2;                           || desde calculo 'funcion1'
  |SI inkey > 15; |Y inkey [ 20; |Y inkey ! 18; |Y inkey ! 17;
      |AVISO;
      |ERROR;
      |ACABA;
  |FINSI;
  |SI inkey = 9;            || extractos
      ext1 = #0#4;          || cuenta
      ext2 = #0#5;          || digito
      programa = "caextrap";
      |HAZ externos;
      |ERROR;
      |ACABA;
  |FINSI;
  |SI inkey = 10;               || diario de trabajo
      ||ext1 = #1#0;          || desde diario
      ||ext2 = #1#0;          || hasta diario
      programa = "caditrab.run";
      |HAZ externos;
      |ERROR;
      |ACABA;
  |FINSI;
  |SI inkey = 11;               || anotaciones extracontables
      ext1 = #0#0;          || diario
      ext2 = #0#1;          || fecha
      ext3 = #0#2;          || documento
      programa = "caextra0.run";
      |HAZ externos;
      |ERROR;
      |ACABA;
  |FINSI;
  |SI inkey = 12;               || consulta cobros
      ext1 = #0#4;          || cuenta
      ext2 = #0#5;          || digito
      programa = "caconcob.run";
      |HAZ externos;
      |ERROR;
      |ACABA;
  |FINSI;
  |SI inkey = 13;               || consulta pagos
      ext1 = #0#4;          || cuenta
      ext2 = #0#5;          || digito
      programa = "caconpag.run";
      |HAZ externos;
      |ERROR;
      |ACABA;
  |FINSI;
  |SI inkey = 14;
      |SI Campo = 3; |ERROR; |ACABA; |FINSI;
      raf1 = (FEntrada / 100) ! 0;
      |SI raf1 ! 2;  |ERROR; |ACABA; |FINSI;
      ant1 = #0#0;
      ant2 = #0#1;
      ant3 = #0#2;
      ant4 = #0#3;
      |LEE 021#0a;
      |SI FSalida ! 0; |O #0#2 ! ant3;
          |MENAV "     NO SE PUEDE EJECUTAR ESTA OPCION";
          #0#0 = ant1;
          #0#1 = ant2;
          #0#2 = ant3;
          #0#3 = ant4;
          |LEE 121#0=;
          |ERROR;
          |ACABA;
      |FINSI;
      #0#0 = ant1;
      #0#1 = ant2;
      #0#2 = ant3;
      #0#3 = ant4;
      |LEE 021#0=;
      E_sup = 1;
      E_inf = "+-";
      rafa1 = " ";
      |MENSA "2405 DESEA SUMAR O RESTAR EL IMPORTE + o -: ";
      rafa1 = 2445 ? 1;
      |MENSA "2405                                          ";
      |SI rafa1 = "+";
          #0#9 = #0#9 + 1;
      |SINO;
          #0#9 = #0#9 - 1;
      |FINSI;
      rafa2 = #0#8;
      |PINDA #0#0;
      |GRABA 020#0a;
      |LEE 020#0a;
      opera = "B";
      |HAZ altatra;
      |ABRE #6;
      #6#0 = #0#0;
      |LEE 141#6=;
      |SI rafa1 = "+";
          |SI rafa2 = #0#8;
              #0#9 = #0#9 - 1;
              raf2 = -1;
          |SINO;
              #0#9 = #0#9 + 1;
              raf2 = 1;
          |FINSI;
      |SINO;
          |SI rafa2 = #0#8;
              #0#9 = #0#9 + 1;
              raf2 = 1;
          |SINO;
              #0#9 = #0#9 - 1;
              raf2 = -1;
          |FINSI;
      |FINSI;
      |SI #0#8 = "D";
          #6#2 = #6#2 + raf2;
          #1#4 = #1#4 + raf2;
      |SINO;
          #6#3 = #6#3 + raf2;
          #1#5 = #1#5 + raf2;
      |FINSI;
      |GRABA 020#6a;
      |LIBERA #6;
      |CIERRA #6;
      #2#0 = #6#2;
      #2#1 = #6#3;
      #2#2 = #2#0 - #2#1;
      |ATRI I;
      |PINTA 0636, #2#0;
      |PINTA 0651, #2#1;           || pinta acumulados de diario
      |PINTA 0666, #2#2;
      |ATRI 0;
      |GRABA 020#0a;
      raf1 = #0#9;
      #0#9 = raf2;
      |HAZ a_cuentas;
      |SI #0#12 = "R";
          |HAZ a_ivar;
      |FINSI;
      |SI #0#12 = "S";
          |HAZ a_ivas;
      |FINSI;
      #0#9 = raf1;
      #1#6 = #1#4 - #1#5;
      |PINTA #1#4;
      |PINTA #1#5;        || acumulados asiento
      |PINTA #1#6;
      opera = "A";
      |HAZ altatra;
      #0#0 = ant1;
      #0#1 = ant2;
      #0#2 = ant3;
      #0#3 = ant4;
      |LEE 021#0=;
      sumoresto = 1;
      |PTEC 806;
      |ACABA;
  |FINSI;

  |SI inkey = 15;
      |ERROR;
      |PTEC 802;
      |PTEC 802;
      swCambiar = 1;
  |FINSI;
  |SI inkey = 17;
      |HAZ lacontra;
  |FINSI;
||    |ERROR;
|FPRC;

|PROCESO lacontra;
      ext1 = #0#0;          || diario
      ext2 = #0#1;          || fecha
      ext3 = #0#2;          || documento
      cdiari = #0#0;
      cfecha = #0#1;
      cdocum = #0#2;
      clinea = #0#3;
      |HAZ signo;
      cdefecta = ""; cdefedig = 0;
      |SI #0#8 = "H";
          |SI j_d ! 0;
              cdefecta = #1#8;
              cdefedig = #1#9;
          |FINSI;
      |SINO;
          |SI j_h ! 0;
              cdefecta = #1#10;
              cdefedig = #1#11;
          |FINSI;
      |FINSI;
      programa = "calicont.tab";
      |HAZ externos;
      |ERROR;
|FPRC;

|PROCESO cuefin; |TIPO 0;                    || desde campo 'cuenta'
  |HAZ signo;
  |SI inkey = 16;
      |SI predefine ! 0; |Y #0#3 = 1; predefine = 0; |PTEC 807; |FINSI;
      |PTEC 807;
      |ERROR;
  |SINO;
      cta_t = Campo;
      dig_t = cta_t + 1;
      |HAZ cuefin_t;
      |HAZ funcion2;
  |FINSI;
|FPRC;

|PROCESO otravez;
 cta_t = Campo - 1;
 dig_t = Campo;
    alfa1 = #0cta_t;
 |QBF alfa1;
 |SI alfa1 = ""; |ACABA; |FINSI;
     alfa2 = alfa1 % 0;
     long = alfa2;
     sw = 0;
 |SI long = dig4;  sw = 1;  #0dig_t = 1;  |FINSI;
 |SI long = dig5;  sw = 1;  #0dig_t = 2;  |FINSI;
 |SI long = dig6;  sw = 1;  #0dig_t = 3;  |FINSI;
 |SI long = dig7;  sw = 1;  #0dig_t = 4;  |FINSI;
 |SI long = dig8;  sw = 1;  #0dig_t = 5;  |FINSI;
 |SI long = dig9;  sw = 1;  #0dig_t = 6;  |FINSI;
 |SI long = 0;     sw = 1;  #0dig_t = 0;  |FINSI;
|FPRC;

|PROCESO cuefin_t;                      || desde calculo 'cuefin'
  |ABRET #4;
  #4#0 = #0cta_t;
  #4#1 = #0dig_t;
  |LEE 001#4=;
  |SI FSalida ! 0;
      |ERROR;
      |ACABA;
  |FINSI;
  |SI #4#3 = "N";
      |MENAV men3;
      |ERROR;
      |ACABA;
  |FINSI;
  |CIERRAT #4;
  |HAZ pinta_cta;
|FPRC;

|PROCESO cuenta; |TIPO 6;                    || desde campo 'cuenta'
  ||varia_cod = #0Campo;
  inkey = FSalida;
  |SI inkey = 15;
      |SI Campo = 10;
          #0#10 = cthaant;
          #0#11 = dihaant;
      |FINSI;
      |SI Campo = 16;
          #0#16 = ctdeant;
          #0#17 = dideant;
      |FINSI;
      |PINTA #0Campo;
      inkey = 0;
  |FINSI;
  p_alfa1 = #0Campo;
  salidas = FSalida;
  |HAZ punto;
  |SI p_error ! 0;  |ERROR;  |ACABA;  |FINSI;
  cta_t = Campo;
  dig_t = cta_t + 1;
  |HAZ blanco;
  |HAZ cuenta_t;
|FPRC;

|PROCESO blanco;              || desde calculo 'cuenta'
    alfa1 = #0cta_t;   |QBF alfa1;
|SI alfa1 = "";
    |ABRET #4;
        #4#0 = #0cta_t;
        #4#1 = #0dig_t;
    |LEE 101#4=;
    |SI FSalida ! 0;
        |DDEFECTO #4;
        #4#3 = "S";       || pase directo si
        |PARA nume1 = 1; |SI nume1 [ dig3; |HACIENDO nume1 = nume1 + 1;
            |SI nume1 = 1;  #4#1 = dig4;  |FINSI;
            |SI nume1 = 2;  #4#1 = dig5;  |FINSI;
            |SI nume1 = 3;  #4#1 = dig6;  |FINSI;
            |SI nume1 = 4;  #4#1 = dig7;  |FINSI;
            |SI nume1 = 5;  #4#1 = dig8;  |FINSI;
            |SI nume1 = 6;  #4#1 = dig9;  |FINSI;
            |GRABA 040#4n;
        |SIGUE;
            #4#1 = 0;
        |GRABA 040#4n;        || graba con el nivel 0 (por si acaso)
    |SINO;
       #4#3 = "S";
       |GRABA 040#4a;
    |FINSI;
    |LIBERA #4;
    |CIERRAT #4;
|FINSI;                  || graba automaticamente las cuentas en blanco
|FPRC;

|PROCESO cuenta_t;
    alfa1 = #0cta_t;
|QBF alfa1;
    alfa2 = alfa1 % 0;
    long = alfa2;
    cont = 0;
    sw = 0;
|SI long = dig4;  sw = 1;  #0dig_t = 1;  |FINSI;
|SI long = dig5;  sw = 1;  #0dig_t = 2;  |FINSI;
|SI long = dig6;  sw = 1;  #0dig_t = 3;  |FINSI;
|SI long = dig7;  sw = 1;  #0dig_t = 4;  |FINSI;
|SI long = dig8;  sw = 1;  #0dig_t = 5;  |FINSI;
|SI long = dig9;  sw = 1;  #0dig_t = 6;  |FINSI;
|SI long = 0;     sw = 1;  #0dig_t = 0;  |FINSI;
|SI sw = 0;
        #0dig_t = 0;
    |MENAV men2;
    |ERROR;
    |ACABA;
|FINSI;
|FPRC;

|PROCESO concepto; |TIPO 0;             || desde campo 'concepto'
 inkey = FSalida;
 |SI inkey = 17; |HAZ lacontra; inkey = 0; |ACABA; |FINSI;

 |ABRE #3;
 #3#0 = #0#6;
 |LEE 040#3=;

 #0#24 = #3#1;
 |SI FEntrada = 101;
     |SI eaConDes = "N"; #0#7  = #3#1; |FINSI;
 |SINO;
     #0#24 = #3#1;
     |SI #0#6 = coant;
         #0#7 = deant;
     |SINO;
         |SI eaConDes = "N"; #0#7  = #3#1; |FINSI;
     |FINSI;
 |FINSI;
 |PINTA #0#7;
 |SI eaConDes ! "N"; |PINTA #0#24; |FINSI;
 |CIERRA #3;
|FPRC;

|PROCESO descrip; |TIPO 0;        || desde campo 'descripcion'
  inkey = FSalida;
  |SI inkey = 17; |HAZ lacontra; inkey = 0; |ACABA; |FINSI;
  |SI FSalida = 15;
      #0#7 = deant;
      |PINTA #0#7;
  |FINSI;
|FPRC;

|PROCESO nocero; |TIPO 0;          || desde campo 'importe'
    inkey     = FSalida;
    f1auto    = 0;
    swCambiar = 0;

    |SI inkey = 17; |HAZ lacontra; inkey = 0; |ACABA; |FINSI;
    |HAZ aviso9;
|SI #0Campo = 0;|Y inkey ! 10; |Y inkey ! 11;
    |ERROR;
    |ACABA;
|SINO;
    |SI inkey = 10; |O inkey = 11;   || <F2>
        |SI #0#8 = "D";  #0#9 = #1#6 * -1;  |FINSI;
        |SI #0#8 = "H";  #0#9 = #1#6;       |FINSI;
        |PINTA #0#9;
        |SI inkey = 11;
            |ERROR;
            |PTEC 802;
        |FINSI;
    |FINSI;
    |SI inkey ! 2;                 || cuando no es flecha arriba
        |HAZ c_predefi;            || opera en predef. al salir del apunte
    |FINSI;
    |SI inkey = 9; |O inkey = 10;
        nDebe = #1#4; nHaber = #1#5;
        |SI #0#8 = "D"; nDebe  = nDebe  + #0#9; |FINSI;
        |SI #0#8 = "H"; nHaber = nHaber + #0#9; |FINSI;
        |SI nDebe ! nHaber; |AVISO; |ERROR; |ACABA; |FINSI;
        f1auto = 1;
        |PTEC 806;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO signo;                    || desde calculo 'c_importe' y 'cuefin'
|SI #0#16 ! doce;
        #0#8 = "D";
        #0#4 = #0#16;
        #0#5 = #0#17;
|FINSI;
|SI #0#10 ! doce;
        #0#8 = "H";
        #0#4 = #0#10;
        #0#5 = #0#11;
|FINSI;
|SI #0#16 ! doce;|Y #0#10 ! doce;
        #0#8 = "x";
        #0#4 = "";
        #0#5 = 9;
|FINSI;
|FPRC;

****************************************************************************
                    RUTINAS VARIAS
****************************************************************************

|PROCESO a_contrap;
    |SI j_d = 0; sw_debe = 0; |FINSI;
    |SI j_h = 0; sw_habe = 0; |FINSI;
    xx = (FEntrada / 100) ! 0
    |SI xx = 3;
        |SI j_d = #0#3; sw_debe = 0; j_d = 0; |FINSI;
        |SI j_h = #0#3; sw_habe = 0; j_h = 0; |FINSI;
        |ACABA;
    |FINSI;

    |SI sw_debe = 0;
        |SI #0#8 ! "H";
            #1#08 = #0#16;             || contrap. HABER
            #1#09 = #0#17;             || digito HABER
            sw_debe = 1;
            j_d = #0#3;
        |FINSI;
    |SINO;
        |SI j_d = #0#3;
            |SI #0#8 ! "H";
                #1#08 = #0#16;             || contrap. HABER
                #1#09 = #0#17;             || digito HABER
                j_d = #0#3;
            |SINO;
                j_d = 0;
                sw_debe = 0;
            |FINSI;
        |FINSI;
    |FINSI;
 || -------------------------------------------------------------------
    |SI sw_habe = 0;
        |SI #0#8 ! "D";
            #1#10 = #0#10;             || contrap. DEBE
            #1#11 = #0#11;             || digito DEBE
            sw_habe = 1;
            j_h = #0#3;
        |FINSI;
    |SINO;
        |SI j_h = #0#3;
            |SI #0#8 ! "D";
                #1#10 = #0#10;             || contrap. DEBE
                #1#11 = #0#11;             || digito DEBE
                j_h = #0#3;
            |SINO;
                j_h = 0;
                sw_habe = 0;
            |FINSI;
        |FINSI;
    |FINSI;

    |SI CtrapD ! doce; |Y CtrapD ! ""; #1#10 = CtrapD; |FINSI;
    |SI CtrapH ! doce; |Y CtrapH ! ""; #1#8  = CtrapH; |FINSI;

|FPRC;

|PROCESO a_asiento;                || calculo 'refresca'
|SI #0#8 = "D";|O #0#8 = "x";  #1#4 = #1#4 +. #0#9;  |FINSI;
|SI #0#8 = "H";|O #0#8 = "x";  #1#5 = #1#5 +. #0#9;  |FINSI;
    #1#6 = #1#4 - #1#5;
|PINTA #1#4;
|PINTA #1#5;        || acumulados asiento
|PINTA #1#6;
|FPRC;

|PROCESO a_diario;                 || calculo 'refresca'
|ABRE #6;
    #6#0 = #0#0;
|LEE 141#6=;
|SI FSalida ! 0;              || actualiza el diario
    |DDEFECTO #6;
        #6#0 = #0#0;
        #6#1 = "<DIARIO SIN DEFINIR>";
    |GRABA 020#6b;
|FINSI;
|SI #0#8 = "D";|O #0#8 = "x";
        #6#2 = #6#2 +. #0#9;
|FINSI;
|SI #0#8 = "H";|O #0#8 = "x";
        #6#3 = #6#3 +. #0#9;
|FINSI;
|GRABA 020#6a;
|LIBERA #6;
|CIERRA #6;
    #2#0 = #6#2;
    #2#1 = #6#3;
    #2#2 = #2#0 - #2#1;
|ATRI I;
|PINTA 0636, #2#0;
|PINTA 0651, #2#1;           || pinta acumulados de diario
|PINTA 0666, #2#2;
|ATRI 0;
|FPRC;

|PROCESO a_cuentas;                || calculo 'refresca'
  las_dos = 1;
  |SI #0#10 ! doce;  cta_t = 10;  signo = "H";  |FINSI;
  |SI #0#16 ! doce;  cta_t = 16;  signo = "D";  |FINSI;|| se queda con esta
                                                       ||/si van las 2 llenas
  |PARA otra_vez=1; |SI otra_vez[ las_dos; |HACIENDO otra_vez=otra_vez+1;
        dig_t = cta_t + 1;

        |ABRET #4;
        #4#0 = #0cta_t;
        #4#1 = #0dig_t;           || actualizacion cuentas
        |LEE 101#4=;
        |SI FSalida = 0;
            |SI #0#0 = 0;
                |SI signo = "D";
                    #4#9 = #4#9 +. #0#9;        || diario cero (saldos iniciales)
                    #4#51 = #4#51 +. #0#9;
                |SINO;
                    #4#10 = #4#10 +. #0#9;
                    #4#52 = #4#52 +. #0#9;
                |FINSI;
                #4#11 = #4#9 - #4#10;
                #4#53 = #4#51 - #4#52;
            |SINO;
                |SI #0#0 = 99;
                    |SI signo = "D";
                        #4#48 = #4#48 +. #0#9;       || diario 99 (saldos finales)
                        #4#51 = #4#51 +. #0#9;
                    |SINO;
                        #4#49 = #4#49 +. #0#9;
                        #4#52 = #4#52 +. #0#9;
                    |FINSI;
                    #4#50 = #4#48 - #4#49;
                    #4#53 = #4#51 - #4#52;
                |SINO;
                    |HAZ a_actualiza;       || saldos del mes correspondiente
                |FINSI;
            |FINSI;
            |SI #4#58 < #0#1;
                #4#58 = #0#1;               || fecha ultimo apunte
            |FINSI;
            |GRABA 020#4a;
       |FINSI;
       |LIBERA #4;
       |CIERRAT #4;
       |SI #0#8 = "x";
           cta_t = 10;                 || por si lleva las dos ctas. llenas
           las_dos = 2;
           signo = "H";
       |FINSI;                             || pega otra pasada
  |SIGUE;
|FPRC;

|PROCESO a_actualiza;                || rutina 'a_cuentas'
    ini = dig1;
    fecalf = #0#1;
    mes = fecalf % 402;
    mesfec = mes;
|SI ini = 1;
        mesac = mesfec;
|SINO;
        mesac = (mesfec - ini) + 1;
    |SI mesac [ 0;
            mesac = (13 - ini) + mesfec;
    |FINSI;
|FINSI;
    a = (mesac * 3) + 9;
    b = a + 1;
    c = a + 2;
|SI signo = "D";
        #4a = #4a +. #0#9;
        #4#51 = #4#51 +. #0#9;
|SINO;
        #4b = #4b +. #0#9;
        #4#52 = #4#52 +. #0#9;
|FINSI;
    #4c = #4a - #4b;
    #4#53 = #4#51 - #4#52;
|FPRC;

|PROCESO a_ivar;                   || desde 'refresca'
    |ABRE #15;
    #15#0  = #0#13;      || libro
    #15#2  = #0#14;      || factura
    #15#27 = #0#15;      || serie
    |LEE 101#15=;
    |SI FSalida = 0;
        |SI #15#62 > 1;
            avisos = "ATENCION!!! Facturas Englodadas. Revisar la Factura ...";
            |HAZ aviso5;
            |PAUSA;
            |HAZ aviso9;
         |FINSI;
         |HAZ a_busca;
         extf = "00.00.0000";
         |ABRE #112;
         #112#0 = #15#0;
         #112#1 = #15#27;
         #112#2 = #15#2;
         |LEE 041#112=;
         |SI FSalida = 0;
             extf = #112#3;
         |FINSI;
         |LIBERA #112;
         |CIERRA #112;
    |FINSI;
    |LIBERA #15;
    |CIERRA #15;
|FPRC;

|PROCESO a_ivas;                   || desde 'refresca'
    |ABRE #16;
    #16#0 = #0#13;       || libro
    #16#2 = #0#14;       || orden
    #16#27 = #0#15;      || serie
    |LEE 141#16=;
    |SI FSalida = 0;
        |HAZ a_busca;
         extf = "00.00.0000";
         |ABRE #113;
         #113#0 = #16#0;
         #113#1 = #16#27;
         #113#2 = #16#2;
         |LEE 041#113=;
         |SI FSalida = 0;
             extf = #113#3;
         |FINSI;
         |LIBERA #113;
         |CIERRA #113;
    |FINSI;
    |LIBERA #16;
    |CIERRA #16;
|FPRC;

|PROCESO a_busca;             || desde 'a_iva?'
  |ABRE #caivaasi;
  |LEE 010#caivaasi.p;
  |CIERRA #caivaasi;
  |SI #0#20 ! 0;      || si el apunte influye en algun acumulador de IVAS
      |HAZ c_impiva;  || recalcula y regraba
      |SI #0#12 = "R";
          |HAZ total_ivar;
          |SI xx = 2;                || en modificacion siempre regraba
              |GRABA 020#15a;
              |LIBERA #15;
          |FINSI;
          |SI xx = 3;
              |HAZ TotalIvaR;
              |SI #15#26 ! 0;        || en baja lo borra si el importe es cero
                  |GRABA 020#15a;
              |SINO;
                  aAlfa = #caivarep#35; |QBF aAlfa; aAlfa1 = aAlfa % 0102;
                  |SI aAlfa1 = "**";
                     |ABRE #caivasop;
                     aAlfa1 = aAlfa % 0302; #caivasop#0 = aAlfa1;
                     aAlfa1 = aAlfa % 0502; #caivasop#27 = aAlfa1;
                     aAlfa1 = aAlfa % 0706; #caivasop#2 = aAlfa1;
                     |LEE 101#caivasop.=;
                     |SI FSalida = 0;
                        |SI #caivaasi#44 = "N";
                           |ABRE #calibros;
                           #calibros#0 = #caivasop#0;
                           |LEE 110#calibros.=;
                           |SI FSalida = 0;
                              |SI #calibros#4 = #caivasop#2;
                                 #calibros#4 = #calibros#4 - 1;
                                 |GRABA 020#calibros.a;
                              |FINSI;
                           |FINSI;
                           |LIBERA #calibros;
                           |CIERRA #calibros;
                        |SINO;
                           |ABRE #caivases;
                           #caivases#0 = #caivasop#27;
                           #caivases#1 = "S";
                           |LEE 110#caivases.=;
                           |SI FSalida = 0;
                              ComodNum = #caivasop#2 + 1;
                              |SI #caivases#3 = ComodNum;
                                 #caivases#3 = #caivases#3 - 1;
                                 |GRABA 020#caivases.a;
                              |FINSI;
                           |FINSI;
                           |LIBERA #caivases;
                           |CIERRA #caivases;
                        |FINSI;
                        |BORRA 020#caivasop.a;
                        |HAZ bor_pagos;
                        |HAZ bor_OtrosS;
                     |FINSI;
                     |CIERRA #caivasop;
                  |FINSI;
                  |SI #caivaasi#44 = "N";
                     |ABRE #calibros;
                     #calibros#0 = #caivarep#0;
                     |LEE 110#calibros.=;
                     |SI FSalida = 0;
                        |SI #calibros#4 = #caivarep#2;
                           #calibros#4 = #calibros#4 - 1;
                           |GRABA 020#calibros.a;
                        |FINSI;
                     |FINSI;
                     |LIBERA #calibros;
                     |CIERRA #calibros;
                  |SINO;
                     |ABRE #caivases;
                     #caivases#0 = #15#27;
                     #caivases#1 = "R";
                     |LEE 110#caivases.=;
                     |SI FSalida = 0;
                        ComodNum = #caivarep#2 + 1;
                        |SI #caivases#3 = ComodNum;
                           #caivases#3 = #caivases#3 - 1;
                           |GRABA 020#caivases.a;
                        |FINSI;
                     |FINSI;
                     |LIBERA #caivases;
                     |CIERRA #caivases;
                  |FINSI;
                  |BORRA 020#15a;
                  |SI swModulo = 1872; nOpera = 1; |HAZ Modifico; |FINSI;
                  |HAZ BorraRecti;
                  |HAZ bor_cobros;
              |FINSI;
              |LIBERA #15;
          |FINSI;
      |FINSI;
      |SI #0#12 = "S";
          |HAZ total_ivas;
          |SI xx = 2;                || en modificacion siempre regraba
              |GRABA 020#16a;
              |LIBERA #16;
          |FINSI;
          |SI xx = 3;
              |HAZ TotalIvaS;
              |SI #16#26 ! 0;        || en baja lo borra si el importe es cero
                  |GRABA 020#16a;
              |SINO;
                  aAlfa = #caivasop#35; |QBF aAlfa; aAlfa1 = aAlfa % 0102;
                  |SI aAlfa1 = "**";
                     |ABRE #caivarep;
                     aAlfa1 = aAlfa % 0302; #caivarep#0 = aAlfa1;
                     aAlfa1 = aAlfa % 0502; #caivarep#27 = aAlfa1;
                     aAlfa1 = aAlfa % 0706; #caivarep#2 = aAlfa1;
                     |LEE 101#caivarep.=;
                     |SI FSalida = 0;
                        |SI #caivaasi#44 = "N";
                           |ABRE #calibros;
                           #calibros#0 = #caivarep#0;
                           |LEE 110#calibros.=;
                           |SI FSalida = 0;
                              |SI #calibros#4 = #caivarep#2;
                                 #calibros#4 = #calibros#4 - 1;
                                 |GRABA 020#calibros.a;
                              |FINSI;
                           |FINSI;
                           |LIBERA #calibros;
                           |CIERRA #calibros;
                        |SINO;
                           |ABRE #caivases;
                           #caivases#0 = #caivarep#27;
                           #caivases#1 = "R";
                           |LEE 110#caivases.=;
                           |SI FSalida = 0;
                              ComodNum = #caivarep#2 + 1;
                              |SI #caivases#3 = ComodNum;
                                 #caivases#3 = #caivases#3 - 1;
                                 |GRABA 020#caivases.a;
                              |FINSI;
                           |FINSI;
                           |LIBERA #caivases;
                           |CIERRA #caivases;
                        |FINSI;
                        |BORRA 020#caivarep.a;
                        |SI swModulo = 1872; nOpera = 1; |HAZ Modifico; |FINSI;
                        |HAZ BorraRecti;
                        |HAZ bor_cobros;
                     |FINSI;
                     |CIERRA #caivarep;
                  |FINSI;
                  |SI #caivaasi#44 = "N";
                     |ABRE #calibros;
                     #calibros#0 = #caivasop#0;
                     |LEE 110#calibros.=;
                     |SI FSalida = 0;
                        |SI #calibros#4 = #caivasop#2;
                           #calibros#4 = #calibros#4 - #calibros#3;
                           |GRABA 020#calibros.a;
                        |FINSI;
                     |FINSI;
                     |LIBERA #calibros;
                     |CIERRA #calibros;
                  |SINO;
                     |ABRE #caivases;
                     #caivases#0 = #16#27;
                     #caivases#1 = "S";
                     |LEE 110#caivases.=;
                     |SI FSalida = 0;
                        ComodNum = #caivasop#2 + #caivases#4;
                        |SI #caivases#3 = ComodNum;
                           #caivases#3 = #caivases#3 - #caivases#4;
                           |GRABA 020#caivases.a;
                        |FINSI;
                     |FINSI;
                     |LIBERA #caivases;
                     |CIERRA #caivases;
                  |FINSI;
                  |BORRA 020#16a;
                  |HAZ bor_pagos;
                  |HAZ bor_OtrosS;
              |FINSI;
              |LIBERA #16;
          |FINSI;
      |FINSI;
      |ACABA;
  |FINSI;
||___________________/ si se trata del apunte del cliente/proveedor
  detector = 0 +. 1;
  |SI detector ! 1;  |ACABA;  |FINSI;
  |SI #0#19 ! "F"; |ACABA; |FINSI;
  |SI #0#12 = "R";           || regraba la cuenta por si ha cambiado
      nNoLee = 0;
      i_nomF= #15#50;
      i_cifF= #15#51;
      |SI #15#4 = #0#4; nNoLee = 1; |FINSI;
      #15#04 = #0#4;
      #15#05 = #0#5;
      #15#06 = #0#6;
      #15#07 = #0#7;
      #11#3 = #0#12;
      i_cuent = #15#4;
      i_digit = #15#5;
      |HAZ c_nombre;
      #15#50 = i_nom;      || nombre
      #15#51 = i_cif;      || cif
      #15#49 = #0#21;
      |GRABA 020#15a;
      |LIBERA #15;
      #11#4 = #15#00;      || libro
      i_factu = #15#02;    || factura
      i_serie = #15#27;    || serie
      |HAZ TrataRecti;
      |HAZ TrataSiiPred;
      |HAZ cobros;
  |FINSI;
  |SI #0#12 = "S";
      nNoLee = 0;
      i_nomF= #16#50;
      i_cifF= #16#51;
      |SI #16#4 = #0#4; nNoLee = 1; |FINSI;
      #16#04 = #0#4;
      #16#05 = #0#5;
      #16#06 = #0#6;
      #16#07 = #0#7;
      #11#3 = #0#12;
      i_cuent = #16#4;
      i_digit = #16#5;
      |HAZ c_nombre;
      #16#50 = i_nom;      || nombre
      #16#51 = i_cif;      || cif
      #16#49 = #0#21;
      |GRABA 020#16a;
      |LIBERA #16;
      #11#4 = #16#00;      || libro
      i_factu = #16#02;    || factura
      i_serie = #16#27;    || serie
      |HAZ TrataSiiPred;
      |HAZ pagos;
      |HAZ TrataOtrosS;
  |FINSI;
|FPRC;

|PROCESO a_cobr;                   || desde 'refresca'
  |ABRE #21;
  #21#0 = #0#13;      || libro
  #21#1 = #0#14;      || factura
  #21#2 = #0#15;      || ~serie
  #21#3 = #0#22;      || recibo
  |LEE 101#21=;
  |SI FSalida ! 0;  |LIBERA #21; |CIERRA #21;  |ACABA;  |FINSI;
  #21#24 = #21#24 +. #0#9;        || ptas. liquidadas
  |SI #21#24 < #21#8;|O #21#24 = 0;
      #21#23 = "N";          || no liquidada, cuando queda pendiente
      nume1 = (#21#8 * 2);
     |SI #21#24 < 0;|Y #21#24 = nume1;    || parche para borrar bien abonos
         #21#24 = 0;
     |FINSI;
  |SINO;
      #21#23 = "S";          || liquidada, cuando queda pendiente
  |FINSI;
  |GRABA 020#21a;
  |LIBERA #21;
  |CIERRA #21;
|FPRC;

|PROCESO a_pago;                   || desde 'refresca'
|ABRE #22;
    #22#0 = #0#13;      || libro
    #22#1 = #0#14;      || orden
    #22#2 = #0#15;      || ~serie
    #22#3 = #0#22;      || recibo
|LEE 101#22=;
|SI FSalida = 0;
   #22#23 = #22#23 +. #0#9;        || ptas. liquidadas
   |SI #22#23 < #22#8;|O #22#23 = 0;
      #22#22 = "N";                || no liquidada, cuando queda pendiente
      nume1 = (#22#8 * 2);
      |SI #22#23 < 0;|Y #22#23 = nume1;    || parche para borrar bien abonos
         #22#23 = 0;
      |FINSI;
   |SINO;
      #22#22 = "S";                || liquidada, cuando queda pendiente
   |FINSI;
   |GRABA 020#22a;
|FINSI;
|LIBERA #22;
|CIERRA #22;
|FPRC;


|PROCESO a_impa;                   || desde 'refresca'
    avisos = "ATENCION!!! Impagado Automatico. Revisar Cobros ...";
|HAZ aviso5;
|PAUSA;
|HAZ aviso9;
|FPRC;

|PROCESO pinta_cta; |TIPO 13;      || desde 'refresca', 'cuefin_t', CONSULTA
|C_V #camaasil#24,1,eaConDes;
|SI #0#16 ! doce;
        cta_t = 16;
    |HAZ pinta_cta_t;
|SINO;
    |SI #0#10 ! doce;
            cta_t = 10;
        |HAZ pinta_cta_t;
    |SINO;
        |DDEFECTO #4;
    |FINSI;
|FINSI;
|ATRI I;
#2#4 = #4#2;  |PINTA 2202, #2#4;
#2#0 = #4#51; |PINTA 2236, #2#0;
#2#1 = #4#52; |PINTA 2251, #2#1;
#2#2 = #4#53; |PINTA 2266, #2#2;
|ATRI 0;


|| aqui
  aBlancs = " " * 78;
  |PINTA 2302, aBlancs; |PINTA 2302, aBlancs;
   xx = (FEntrada / 100) ! 0; |SI xx = 1; |ACABA; |FINSI;
   |SI eaDepar = "S";
       eOpDep = 0;
       eaCodDep  = #camaasil#21;
       eSwNoalta = 1;
       |HAZ Actividad;
       |HAZ pDepartamento;
       eSwNoalta = 0;
   |FINSI;
|FPRC;

|PROCESO pinta_cta_t;              || rutina 'pinta_cta'
    dig_t = cta_t + 1;
|ABRET #4;
    #4#0 = #0cta_t;
    #4#1 = #0dig_t;
|LEE 001#4=;
|SI FSalida ! 0;  |DDEFECTO #4;  |FINSI;
|CIERRAT #4;
|FPRC;

|PROCESO altatra;                  || calculo 'guarda' y 'entmod'
|SI opera = "A";
    |HAZ ultimos;                  || graba ultimas operaciones
|FINSI;
    dig_t = cta_t + 1;
    modcon = 1;               || graba el temporal para la actualiz. de ctas.
|ABRE #5;
    #5#0 = codcon;
    #5#1 = #0#4;
    #5#2 = #0#5;
    #5#3 = #0#1;
    #5#4 = #0#8;
    #5#6 = #0#0;
|LEE 101#5=;
|SI FSalida ! 0;
    |DDEFECTO #5;
        #5#0 = codcon;
        #5#1 = #0#4;
        #5#2 = #0#5;
        #5#3 = #0#1;
        #5#4 = #0#8;
        #5#6 = #0#0;
    |GRABA 020#5b;
|FINSI;
    importe = #0#9;
|SI opera = "B";
        importe = -importe;
|FINSI;
    #5#5 = #5#5 + importe;
|GRABA 020#5a;
|LIBERA #5;
|CIERRA #5;
|FPRC;

|PROCESO poncontr;                 || calculo 'guarda'
    fiac = Control % A109;
    fiac = fiac + relleno;
    guarda = fiac % A109;
    fiac = Control % A1001;
    Control = Control + fiac;
    Control = Control + relleno;
    Control = Control % A120;
    Control = Control + aponer;
|FPRC;

|PROCESO externos;                      || desde calculo 'cuefin'
  |ATRI P;
  |MENSA "    Cargando Opcion ...";
  |ATRI 0;
  sit1 = #0#0;         || diario
  sit2 = #0#1;         || fecha
  sit3 = #0#2;         || documento        / las guarda para la vuelta
  sit4 = #0#3;         || apunte
  sit5 = #1#4;         || debe asiento
  sit6 = #1#5;         || haber asiento
  |LIBERA #0;
  |CIERRAT #0;        || cierra lins.
  |LIBERA #1;
  |CIERRAT #1;        || cierra cabs.

  |SUB_EJECUTA_NP programa;

  |ABRET #0;          || abre lins.
  #0#0 = sit1;         || diario
  #0#1 = sit2;         || fecha
  #0#2 = sit3;         || documento
  #0#3 = sit4;         || apunte
  |LEE 101#0=;        || lee el apunte
  |ABRET #1;          || abre cabs.
|SALVA_DATOS #1;
  #1#0 = sit1;         || diario
  #1#1 = sit2;         || fecha
  #1#2 = sit3;         || documento
  |LEE 101#1=;        || lee el asiento
|REPON_DATOS #1;
  #1#4 = sit5;         || debe asiento
  #1#5 = sit6;         || haber asiento
  #1#6 = #1#4 - #1#5;  || saldo asiento
|FPRC;

|PROCESO ultimos;                  || desde rutina 'altatra'
  alfa1 = Usuario;     |QBF alfa1;
  alfa1 = "T" + (alfa1 % 107);
  |NOME_DAT #24 alfa1;

  |DDEFECTO #24;
  |ABRE #24;
  #24#00 = empre;       || empresa
  #24#25 = ejerc;       || periodo
  |LEE 101#24=;
  FEstado = FSalida;
  #24#01 = #24#02;  #24#02 = #24#03;  #24#03 = #0#0;      || diario
  #24#04 = #24#05;  #24#05 = #24#06;  #24#06 = #0#1;      || fecha
  #24#07 = #24#08;  #24#08 = #24#09;  #24#09 = #0#2;      || documento
  #24#10 = #24#11;  #24#11 = #24#12;  #24#12 = #0#4;      || cuenta
  #24#13 = #24#14;  #24#14 = #24#15;  #24#15 = #0#5;      || digito
  #24#16 = #24#17;  #24#17 = #24#18;  #24#18 = #0#8;      || signo
  #24#19 = #24#20;  #24#20 = #24#21;  #24#21 = #0#9;      || importe
  #24#22 = #24#23;  #24#23 = #24#24;  #24#24 = #0#3;      || apunte
  |SI FEstado = 0;  |GRABA 020#24a;  |FINSI;
  |SI FEstado ! 0;  |GRABA 020#24n;  |FINSI;
  |LIBERA #24;
  |CIERRA #24;
|FPRC;

****************************************************************************
                 CALCULO PARA ASIENTOS PREDEFINIDOS
****************************************************************************

|PROCESO c_empieza;      || desde 'c_apunte'
 |DDEFECTO #13;      || def de trabajo para acumuladores y lineas
 |DDEFECTO #14;      || def de trabajo para contrapartidas
 |DDEFECTO #15;      || iva repercutido
 |DDEFECTO #16;      || iva soportado
    #12#1   = 0;     || lineas predefinido
    i_conce = 0;
|FPRC;

|PROCESO lee_predef;
  p_eof = 0;
  |ABRE #12;
  #12#0 = #1#7;
  |LEE 001#12>;
  |SI FSalida ! 0; |O #12#0 ! #1#7;  p_eof = 111;  |FINSI;
  |CIERRA #12;
  |SI p_eof = 111;  |ACABA;  |FINSI;
  |SI #12#56 ! "I";  |Y #12#56 ! "i";  |Y #12#56 ! "R";  |Y #12#56 ! "r";
      |ACABA;
  |FINSI;
  |SI #12#60 = 0;
      |MENAV "     Atencion No esta informado el Tipo de IVA en predefinido";
  |FINSI;
  |SI #12#56 = "I";  |O #12#56 = "i";
      |SI #12#57 = 1;  iva1 = #12#60;  |FINSI;
      |SI #12#57 = 2;  iva2 = #12#60;  |FINSI;
      |SI #12#57 = 3;  iva3 = #12#60;  |FINSI;
      |SI #12#57 = 4;  iva4 = #12#60;  |FINSI;
      |SI #12#57 = 5;  iva5 = #12#60;  |FINSI;
  |FINSI;
  |SI #12#56 = "R";  |O #12#56 = "r";
      |SI #12#57 = 1;  req1 = #12#60;  |FINSI;
      |SI #12#57 = 2;  req2 = #12#60;  |FINSI;
      |SI #12#57 = 3;  req3 = #12#60;  |FINSI;
      |SI #12#57 = 4;  req4 = #12#60;  |FINSI;
      |SI #12#57 = 5;  req5 = #12#60;  |FINSI;
  |FINSI;
|FPRC;

|PROCESO c_apunte; |TIPO 7;             || desde campo 'linea'

|HAZ diez;
|SI predefine = 0;  |ACABA;  |FINSI;

|SI #0#3 = 1;            || se supone que la primera linea del apunte es la 1
    |HAZ c_empieza;
|FINSI;
|ET arriba;
|CAMPO_MODIFICA #0#16, 1, "S";
|CAMPO_MODIFICA #0#10, 1, "S";
|HAZ lee_predef;
|SI p_eof ! 0;           || cuando se acaba el predefinido

    |SI #11#2 = "S";          || si hay iva
        |HAZ graba_iva;
        |HAZ TrataSiiPred;
        |SI #11#3 = "R";|Y #11#6 = "S";  |HAZ cobros;  |FINSI;
        |SI #11#3 = "S";|Y #11#6 = "S";  |HAZ pagos;   |FINSI;
        |SI #11#3 = "S";|Y #11#12  = "S";  |HAZ el_amo;  |FINSI;
        |SI #11#3 = "R";|Y #11#12  = "S";  |HAZ el_amov;  |FINSI;
    |FINSI;
    |HAZ todaslacon;

        predefine = 0;        || pide otro predefinido
        sw_ptec = 1; || por el 'PTEC' del 'pide_iva' de 'camaasic'(sobra)

|| ... ver que hacer aqu
        |SI #11#15 = 1; sw_ptec = 0; |ACABA; |FINSI;
        |SI #11#15 = 2;
            |PAUSA;
            sw_ptec = 2;
            aferlamar = 1;
            |PTEC 806;
            |ACABA;
        |FINSI;
        |SI #11#15 = 3;
             |PAUSA;
             sw_ptec = 0;
             inkey =0;
             |PTEC 806;
             |ACABA;
        |FINSI;

|| --------------------------------------------------------
    |ENCAMPO #7#1;
    |SI FSalida = 0; |Y #1#7 ! 0; |Y inkey ! 1;
            predefine = 1;
        |HAZ c_empieza;   || inicia el proceso de otro asiento predef.
        |VETE arriba;
    |SINO;
        |SI FSalida = 10;      || <F2>
                inkey = 0;     || (para no molestar en el tipo 11)
            |PTEC 806;         || pulsa ESCAPE para volver al diario
        |FINSI;
    |FINSI;
|SINO;
    |SI #12#2 = "N";          || en el tipo N solo pide importe
            #0#12 = #11#3;    || tipo (soportado/repercutido)
            #0#13 = #11#4;    || libro
            #0#14 = i_factu;  || factura/orden
            #0#15 = i_serie;  || serie
            #0#19 = #12#56;   || tipo acumulador IVA
            |SI #12#1 = #11#5; #0#19 = "F"; |FINSI;
            |SI #11#9 = 1;
                |SI #12#56 = "B"; #0#19 = "b"; |FINSI;
                |SI #12#56 = "I"; #0#19 = "i"; |FINSI;
                |SI #12#56 = "R"; #0#19 = "r"; |FINSI;
                |SI #12#56 = "b"; #0#19 = "B"; |FINSI;
                |SI #12#56 = "i"; #0#19 = "I"; |FINSI;
                |SI #12#56 = "r"; #0#19 = "R"; |FINSI;
            |FINSI;
            #0#20 = #12#57;   || nro. acumulador IVA
            |SI #0#19 = "F";|O #0#19 = "f";  #0#20 = 0; |FINSI;
        |ENCAMPO #9#0;
        |VETE arriba;
    |SINO;
        |PTEC 802;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO c_cuenta; |TIPO 7;

  |SI swCambiar = 1; |HAZ ElCambio; |ACABA; |FINSI;

  xx = (FEntrada / 100) ! 0;
  |CAMPO_MODIFICA #0#10, 1, "S";
  |CAMPO_MODIFICA #0#16, 1, "S";
  |SI xx ! 1;              || no modificable cuenta en blanco en no alta
      |SI #0#10 ! doce; |O #0#16 ! doce;
          |SI Campo=10; |Y #0#16!doce; |CAMPO_MODIFICA #0#10,1,"N"; |FINSI;
          |SI Campo=16; |Y #0#10!doce; |CAMPO_MODIFICA #0#16,1,"N"; |FINSI;
      |FINSI;
  |FINSI;
  |SI predefine = 0;  |ACABA;  |FINSI;

  |SI #12#2="D"; |Y Campo=10; |CAMPO_MODIFICA #0#10,1,"N"; |ACABA;  |FINSI;
  |SI #12#2="H"; |Y Campo=16; |CAMPO_MODIFICA #0#16,1,"N"; |ACABA;  |FINSI;

  |HAZ c_contra;
  p_cuenta = #12#3;
  |QBF p_cuenta;
  |SI p_cuenta = "=";
      |SI #12#2 = "D";
          #0#16 = ctpre;              || cuenta DEBE (incompleta)
          #0#17 = dipre;              || digito DEBE
          #0#10 = "";                 || cuenta HABER
          #0#11 = 0;                  || digito HABER
      |SINO;
          #0#16 = "";                 || cuenta DEBE
          #0#17 = 0;                  || digito DEBE
          #0#10 = ctpre;              || cuenta HABER (incompleta)
          #0#11 = dipre;              || digito HABER
      |FINSI;
      |PINTA #0#16;
      |PINTA #0#10;
      |PTEC 802;           || pulsa un 'Intro'
      |ACABA;
  |FINSI;
  alfa3 = p_cuenta % 0;
  nume1 = alfa3;
  nume1 = nume1 + 99;
  alfa2 = p_cuenta % -101;       || coge el asterisco
  |SI alfa2 = "*";
      |SI #12#2 = "D";
          #0#16 = p_cuenta % nume1;   || cuenta DEBE (incompleta)
          #0#17 = #12#4;              || digito DEBE
          #0#10 = "";                 || cuenta HABER
          #0#11 = 0;                  || digito HABER
      |SINO;
          #0#16 = "";                 || cuenta DEBE
          #0#17 = 0;                  || digito DEBE
          #0#10 = p_cuenta % nume1;   || cuenta HABER (incompleta)
          #0#11 = #12#4;              || digito HABER
      |FINSI;
      |PINTA #0#16;
      |PINTA #0#10;
      |PTEC 816;            || pulsa un 'Fin'
  |SINO;
      |SI #12#2 = "D";
          #0#16 = #12#3;              || cuenta DEBE (completa)
          #0#17 = #12#4;              || digito DEBE
          #0#10 = "";                 || cuenta HABER
          #0#11 = 0;                  || digito HABER
      |SINO;
          #0#16 = "";                 || cuenta DEBE
          #0#17 = 0;                  || digito DEBE
          #0#10 = #12#3;              || cuenta HABER (completa)
          #0#11 = #12#4;              || digito HABER
      |FINSI;
      |PINTA #0#16;
      |PINTA #0#10;
      |PTEC 802;           || pulsa un 'Intro'
  |FINSI;
|FPRC;

|PROCESO c_concepto; |TIPO 7;
   alfa1 = #0#16;   |QBF alfa1;
   alfa2 = #0#10;   |QBF alfa2;
   |SI alfa1 = "";  |Y alfa2 = "";    ||al menos una cuenta cargada;
       |MENAV "0000Informar Cuenta";
       |PTEC 808;
       |ACABA;
  |FINSI;
  |SI predefine = 0;  |ACABA;  |FINSI;

  #0#6 = #12#5;
  |PINTA #0#6;
  alfa1 = #12#6;
  |QBF alfa1;
  |SI alfa1 = "=";
      |PTEC 802;
  |FINSI;
|FPRC;

|PROCESO c_descrip; |TIPO 7;
 |SI predefine = 0;  |PTEC 816;  |ACABA;  |FINSI;

 alfa1 = #12#6;
 |QBF alfa1;
 |SI alfa1 = "=";
     #0#7 = deant;
     |PINTA #0#7;
     |PTEC 802;
 |SINO;
     |SI alfa1 ! "*";
         alfa2 = #3#1;
         |QBF alfa2;
         #0#7 = alfa2 + " " + #12#6;
         |PINTA #0#7;
         |PTEC 802;
     |SINO;
         |PTEC 816;
     |FINSI;
 |FINSI;
|FPRC;

|PROCESO c_departa; |TIPO 7;
  |SI #30#24 = "N";
      |CAMPO_MODIFICA #0#21, 1, "N";
  |SINO;
      |CAMPO_MODIFICA #0#21, 1, "S";
      |SI predefine = 0;  |ACABA;  |FINSI;
      #0#21 = #12#58;
      |SI #12#61 = "T"; #0#21 = dpant; |FINSI;
      |PINTA #0#21;
      |SI #12#61 ! "M";  |PTEC 802;  |FINSI;
  |FINSI;
|FPRC;

|PROCESO pActividad; |TIPO 0;
   |SI eaDepar = "N"; |ACABA; |FINSI;

   aBlancs = " "* 78; |PINTA 2302, aBlancs;

   eOpDep = 0; || 1 = Consulta pantalla
   |SI FSalida = 10;  eOpDep = 1; |FINSI;
   eaCodDep    = #camaasil#21;
   |HAZ Actividad;
   |SI eaCodDep = ""; eswLect = 0; |FINSI;
   |SI eswLect = 1;
       |MENAV "    Error.! No Existe Departamento";
       |ERROR;
   |SINO;
       #camaasil#21 = eaCodDep; |PINTA #camaasil#21;
       |HAZ pDepartamento;
   |FINSI;
|FPRC;

|PROCESO c_importe; |TIPO 7;
|HAZ signo;
    xx = (FEntrada / 100) ! 0;
|SI xx = 1;
        #0#9 = imant;
    |PINTA #0#9;
|FINSI;
|SI predefine = 0;  |ACABA;  |FINSI;

|SI #12#7 = "M";
        avisos = #12#59;      || comentario importe (cuando es manual)
        alfa1 = avisos;
    |QBF alfa1;
    |SI alfa1 ! "";  |HAZ aviso5;  |FINSI;
|FINSI;

    calculo = 0;
|PARA nume1 = 24; |SI nume1 [ 31; |HACIENDO nume1 = nume1 + 1;
        nume2 = nume1 + 8;     || acum. o linea
        nume3 = nume1 + 16;    || tipo de calculo
        nume4 = nume1 + 24;    || valor
    |SI #12nume1 = "L";
            nume5 = #12nume2;
        |SI #12nume3 = "+";  calculo = calculo + #13nume5;  |FINSI;
        |SI #12nume3 = "-";  calculo = calculo - #13nume5;  |FINSI;
        |SI #12nume3 = "*";  calculo = calculo * #13nume5;  |FINSI;
        |SI #12nume3 = "/";  calculo = calculo / #13nume5;  |FINSI;
        |SI #12nume3 = "%";  calculo = calculo % #13nume5;  |FINSI;
    |FINSI;
    |SI #12nume1 = "A";
            nume5 = #12nume2 + 100;
        |SI #12nume3 = "+";  calculo = calculo + #13nume5;  |FINSI;
        |SI #12nume3 = "-";  calculo = calculo - #13nume5;  |FINSI;
        |SI #12nume3 = "*";  calculo = calculo * #13nume5;  |FINSI;
        |SI #12nume3 = "/";  calculo = calculo / #13nume5;  |FINSI;
        |SI #12nume3 = "%";  calculo = calculo % #13nume5;  |FINSI;
    |FINSI;
    |SI #12nume1 = "V";
        |SI #12nume3 = "+";  calculo = calculo + #12nume4;  |FINSI;
        |SI #12nume3 = "-";  calculo = calculo - #12nume4;  |FINSI;
        |SI #12nume3 = "*";  calculo = calculo * #12nume4;  |FINSI;
        |SI #12nume3 = "/";  calculo = calculo / #12nume4;  |FINSI;
        |SI #12nume3 = "%";  calculo = calculo % #12nume4;  |FINSI;
    |FINSI;
|SIGUE;

    calculo = calculo ! EURODB;    ||Modificacion por Redondeo Euros.????
    #0#9 = calculo;
|PINTA #0#9;

|SI #12#7 = "A";
    |PTEC 802;
|FINSI;
|FPRC;

----------------------- OPERACIONES DE PREDEFINIDOS

|PROCESO c_predefi;                || desde 'nocero'
/*
alfa1 = #0#16;   |QBF alfa1;
alfa2 = #0#10;   |QBF alfa2;
|SI alfa1 = "";|Y alfa2 = "";
    |ACABA;
|FINSI;
*/

|SI predefine = 0;  |ACABA;  |FINSI;
|SI #11#2 = "S";         || cuando hay IVA
    |HAZ c_cuenta2;
    |HAZ c_impiva;
|FINSI;
|HAZ c_importe2;
|HAZ c_lacontra2;
|FPRC;

|PROCESO c_cuenta2;                || desde 'c_predefi'
|SI #12#1 = #11#5;       || cuenta cliente/proveedor
        i_cuent = #0#4;
        i_digit = #0#5;
        i_conce = #0#6;
        i_descr = #0#7;
        i_depar = #0#21;
    |HAZ c_nombre;
|SINO;
    |SI i_conce = 0;
        i_conce = #0#6;
        i_descr = #0#7;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO c_impiva;                 || desde 'c_predefi','a_busca'
    nFlag = 0 +. 1;

    i_acum = #0#19;
    i_impo = #0#9;
|SI i_acum = "b"; i_acum = "B"; i_impo = i_impo * -1; |FINSI;  || aminorar
|SI i_acum = "i"; i_acum = "I"; i_impo = i_impo * -1; |FINSI;
|SI i_acum = "r"; i_acum = "R"; i_impo = i_impo * -1; |FINSI;

|SI i_acum = "B"; ctab1 = #0#4; ctab2 = #0#5; |FINSI;
|SI i_acum = "B";|O i_acum = "I";|O i_acum = "R";
    |SI i_acum = "B";  puntero =  7;  |FINSI;
    |SI i_acum = "I";  puntero = 13;  |FINSI;
    |SI i_acum = "R";  puntero = 19;  |FINSI;
    |SI #0#20 ] 1;|Y #0#20 [ 5;
        |SI #0#20 > 3;|Y i_acum = "B";  puntero = puntero + 41;  |FINSI;
        |SI #0#20 > 3;|Y i_acum = "I";  puntero = puntero + 39;  |FINSI;
        |SI #0#20 > 3;|Y i_acum = "R";  puntero = puntero + 37;  |FINSI;
            puntero = puntero + #0#20;
        |SI #0#12 = "R";
           #15puntero = #15puntero +. i_impo;
        |FINSI;
        |SI #0#12 = "S";
           #16puntero = #16puntero +. i_impo;
           |SI i_acum = "B";
              aAlfa = #caivasop#35; |QBF aAlfa; aAlfa1 = aAlfa % 0102;
              |SI aAlfa1 = "**";
                 |ABRE #caivarep;
                 aAlfa1 = aAlfa % 0302; #caivarep#0  = aAlfa1;
                 aAlfa1 = aAlfa % 0502; #caivarep#27 = aAlfa1;
                 aAlfa1 = aAlfa % 0706; #caivarep#2  = aAlfa1;
                 |LEE 101#caivarep.=;
                 |SI FSalida = 0;
                    #caivarep#puntero# = #caivarep#puntero# +. i_impo;
                    |SI #caivarep#puntero# = 0;
                       |SI puntero ] 8; |O puntero [ 10;
                          nCalc = puntero + 3; #caivarep#nCalc# = 0;
                          nCalc = puntero + 6; #caivarep#nCalc# = 0;
                       |SINO;
                          nCalc = puntero + 4; #caivarep#nCalc# = 0;
                          nCalc = puntero + 2; #caivarep#nCalc# = 0;
                       |FINSI;
                    |SINO;
                       |SI puntero ] 8; |O puntero [ 10;
                          nCalc = puntero + 3; #caivarep#nCalc# = 16;
                          nCalc = puntero + 6; #caivarep#nCalc# = #caivarep#puntero# % 16;
                       |SINO;
                          nCalc = puntero + 2; #caivarep#nCalc# = 16;
                          nCalc = puntero + 4; #caivarep#nCalc# = #caivarep#puntero# % 16;
                       |FINSI;
                    |FINSI;
                    |HAZ total_ivar;
                    |GRABA 020#caivarep.a; |LIBERA #caivarep;
                 |FINSI;
                 |SI #caivasop#puntero# = 0;
                    |SI puntero ] 8; |O puntero [ 10;
                       nCalc = puntero + 6; #caivasop#nCalc# = 0;
                       nCalc = puntero + 3; #caivasop#nCalc# = 0;
                    |SINO;
                       nCalc = puntero + 4; #caivasop#nCalc# = 0;
                       nCalc = puntero + 2; #caivasop#nCalc# = 0;
                    |FINSI;
                 |SINO;
                    |SI puntero ] 8; |O puntero [ 10;
                       nCalc = puntero + 3; #caivasop#nCalc# = 16;
                       nCalc = puntero + 6; #caivasop#nCalc# = #caivasop#puntero# % 16;
                    |SINO;
                       nCalc = puntero + 2; #caivasop#nCalc# = 16;
                       nCalc = puntero + 4; #caivasop#nCalc# = #caivasop#puntero# % 16;
                    |FINSI;
                 |FINSI;
                 |CIERRA #caivarep;
              |FINSI;
           |FINSI;
        |FINSI;
    |SINO;
        |SI i_acum = "I";         || solo en el iva
            |HAZ c_impiva2;
        |SINO;
            |MENAV "    ATENCION!!! Apunte mal relacionado con IVA ...";
        |FINSI;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO c_impiva2;      || (des)actualizacion del iva manual (nro. 6), no puede ser 6.
    c_c = i_impo;
    detector = 0 +. 1;
|SI detector = -1;
    |PARA nume1 = 14; |SI nume1 [ 61; |HACIENDO nume1 = nume1 + 1;
        |SI nume1 = 17;  nume1 = 20;  |FINSI;
        |SI nume1 = 23;  nume1 = 56;  |FINSI;
        |SI nume1 = 58;  nume1 = 60;  |FINSI;
        |SI #0#12 = "R";
            |SI #15nume1 [ c_c;
                    c_c = c_c - #15nume1;     #15nume1 = 0;
            |SINO;
                    #15nume1 = #15nume1 - c_c;     c_c = 0;
            |FINSI;
        |FINSI;
        |SI #0#12 = "S";
            |SI #16nume1 [ c_c;
                    c_c = c_c - #16nume1;     #16nume1 = 0;
            |SINO;
                    #16nume1 = #16nume1 - c_c;     c_c = 0;
            |FINSI;
        |FINSI;
    |SIGUE;
|SINO;
    |SI #0#12 = "R";  #15#14 = #15#14 + c_c;  |FINSI;  || lo suma en el
    |SI #0#12 = "S";  #16#14 = #16#14 + c_c;  |FINSI;  ||/primer acumulador
|FINSI;
|FPRC;

|PROCESO c_importe2;               || desde 'c_predefi'
    p_linea = #12#1;
    #13p_linea = #0#9;
|PARA nume1 = 8; |SI nume1 [ 15; |HACIENDO nume1 = nume1 + 1;
        nume2 = nume1 + 8;
    |SI #12nume1 ! 0;|Y #12nume2 ! " ";
            nume3 = #12nume1 + 100;
        |SI #12nume2 = "+";  #13nume3 = #13nume3 + #0#9;  |FINSI;
        |SI #12nume2 = "-";  #13nume3 = #13nume3 - #0#9;  |FINSI;
    |FINSI;
    |SI #12#56 = "P"; |O #12#56 = "p"; irpf = #0#9; |FINSI;
|SIGUE;
|FPRC;

|PROCESO c_lacontra2;  ||desde 'c_predefi'
    |SI #12#2 = "N"; |ACABA; |FINSI;
    p_linea = #12#1;
    alfa1 = #0#4;
    alfa2 = #0#5; |QBT alfa2;
    alfa2 = ("0" + alfa2) % -101;
    #14p_linea = alfa1 + alfa2;
    p_linea = p_linea + 100;
    alfa1 = #12#15; |QBT alfa1;
    alfa1 = ("00" + alfa1) % -102;
    alfa2 = #0#3; |QBT alfa2;
    alfa2 = ("00000" + alfa2) % -105;
    #14p_linea = alfa1 + alfa2;
|FPRC;

|PROCESO todaslacon;
 |ABRE #31;
 |PARA nume1 = 1; |SI nume1 [ 99; |HACIENDO nume1 = nume1 + 1;
       nume2 = nume1 + 100;

       alfa1 = #14nume2 % 102;    ||Linea Contrapartida
       alfa2 = #14nume2 % -104;   ||Linea Apunte

       nume3 = alfa1;               || Linea de la Contrapartida
       nume4 = alfa2;
       |SI nume3 > 00;
           alfa1 = #14nume3 % 112;  ||Cuenta Contrapartida
           alfa2 = #14nume3 % -101; ||Digito Contrapartida

           #31#0 = #0#0;
           #31#1 = #0#1;
           #31#2 = #0#2;
           #31#3 = nume4;
           |LEE 101#31=;
           |SI FSalida ! 0;
               #31#0 = #0#0;
               #31#1 = #0#1;
               #31#2 = #0#2;
               #31#3 = nume4;
               |GRABA 020#31b;
           |FINSI;
           #31#4 = alfa1;
           #31#5 = alfa2;
           |GRABA 020#31a;
           |LIBERA #31;
       |FINSI;
 |SIGUE;
 |CIERRA #31;
|FPRC;

----------------------- GRABA IVAS (SOPORTADO/REPERCUTIDO)

|PROCESO graba_iva;
    i_signo = 1;
|| ... |SI #11#9 = 1;   i_signo = -1;   |FINSI; || cambiados ya los param.
                                                || de IVA B->b I->i ...
|SI #11#3 = "R";  |HAZ graba_ivar;  |FINSI;
|SI #11#3 = "S";  |HAZ graba_ivas;  |FINSI;
|FPRC;

|PROCESO graba_ivar;          || repercutido
|ABRE #15;
    #15#00 = #11#4;      || libro
|HAZ lee_libro;
    #15#01 = #17#1;      || descripcion libro
    #15#02 = i_factu;    || factura
    #15#03 = i_fecha;    || fecha
    #15#04 = i_cuent;    || cuenta
    #15#05 = i_digit;    || digito
    #15#06 = i_conce;    || concepto
    #15#07 = i_descr;    || descripcion
    #15#08 = #15#08 * i_signo;                 || base 1
    #15#09 = #15#09 * i_signo;                 || base 2
    #15#10 = #15#10 * i_signo;                 || base 3
    #15#52 = #15#52 * i_signo;                 || base 4
    #15#53 = #15#53 * i_signo;                 || base 5
    #15#14 = #15#14 * i_signo;                 || cuota iva 1
    #15#15 = #15#15 * i_signo;                 || cuota iva 2
    #15#16 = #15#16 * i_signo;                 || cuota iva 3
    #15#56 = #15#56 * i_signo;                 || cuota iva 4
    #15#57 = #15#57 * i_signo;                 || cuota iva 5
    #15#20 = #15#20 * i_signo;                 || cuota rec 1
    #15#21 = #15#21 * i_signo;                 || cuota rec 2
    #15#22 = #15#22 * i_signo;                 || cuota rec 3
    #15#60 = #15#60 * i_signo;                 || cuota rec 4
    #15#61 = #15#61 * i_signo;                 || cuota rec 5
    |SI #15#14 ! 0;  |Y iva1 = 0;              || (%) iva 1
        #15#11 = ((#15#14 * 100) / #15#08) ! 0;
    |SINO;
        #15#11 = iva1;
    |FINSI;
    |SI #15#15 ! 0;  |Y iva2 = 0;              || (%) iva2
        #15#12 = ((#15#15 * 100) / #15#09) ! 0;
    |SINO;
        #15#12 = iva2;
    |FINSI;
    |SI #15#16 ! 0;  |Y iva3 = 0;              || (%) iva 3
        #15#13 = ((#15#16 * 100) / #15#10) ! 0;
    |SINO;
        #15#13 = iva3;
    |FINSI;
    |SI #15#56 ! 0;  |Y iva4 = 0;              || (%) iva 4
        #15#54 = ((#15#56 * 100) / #15#52) ! 0;
    |SINO;
        #15#54 = iva4;
    |FINSI;
    |SI #15#57 ! 0;  |Y iva5 = 0;              || (%) iva 5
        #15#55 = ((#15#57 * 100) / #15#53) ! 0;
    |SINO;
        #15#55 = iva5;
    |FINSI;
    |SI #15#20 ! 0;  |Y req1 = 0;              || (%) rec 1
        #15#17 = ((#15#20 * 100) / #15#08) ! 1;
    |SINO;
        #15#17 = req1;
    |FINSI;
    |SI #15#21 ! 0;  |Y req2 = 0;              || (%) rec 2
        #15#18 = ((#15#21 * 100) / #15#09) ! 1;
    |SINO;
        #15#18 = req2;
    |FINSI;
    |SI #15#22 ! 0;  |Y req3 = 0;              || (%) rec 3
        #15#19 = ((#15#22 * 100) / #15#10) ! 1;
    |SINO;
        #15#19 = req3;
    |FINSI;
    |SI #15#60 ! 0;  |Y req4 = 0;             || (%) rec 4
        #15#58 = ((#15#60 * 100) / #15#52) ! 1;
    |SINO;
        #15#58 = req4;
    |FINSI;
    |SI #15#61 ! 0;  |Y req5 = 0;             || (%) rec 5
        #15#59 = ((#15#61 * 100) / #15#53) ! 1;
    |SINO;
        #15#59 = req5;
    |FINSI;
    #15#23 = #11#11;     || deducible
|HAZ total_ivar;         || total factura
    #15#27 = i_serie;    || serie
    #15#28 = "N";        || liquidada
|HAZ periodo;
    #15#44 = i_perio;    || periodo
    #15#45 = #1#0;       || diario
    #15#46 = #1#1;       || fecha asiento
    #15#47 = #1#2;       || documento
    #15#48 = #11#12;     || inversiones
    #15#49 = i_depar;    || departamento
    #15#50 = i_nom;      || nombre
    #15#51 = i_cif;      || cif
|GRABA 020#15n;
|LIBERA #15;
|CIERRA #15;
|HAZ TrataRecti;
  iva1 = 0;  iva2 = 0;  iva3 = 0;  iva4 = 0;  iva5 = 0;
  req1 = 0;  req2 = 0;  req3 = 0;  req4 = 0;  req5 = 0;
  |SI swModulo = 1872;
      nOpera = 0;
      |HAZ Modifico;
  |FINSI;
|FPRC;

|PROCESO cobros;
    |ABRE #15;
    #15#00 = #11#4;      || libro
    #15#02 = i_factu;    || factura
    #15#27 = i_serie;    || serie
|LEE 021#15=;
|SI FSalida = 0;
        libro = #15#0;
        orden = #15#2;
        emision = #15#3;
        serie = #15#27;            || inhibida
        pesetas = #15#26 - irpf;
        cuenta = #15#4;
        digito = #15#5;
        repres = #15#49;
    |SUB_EJECUTA_NP "calincob.run";
|FINSI;
|SELECT #1#15;
|CIERRA #15;
   irpf = 0;
|FPRC;

|PROCESO PideRectif;
     |PUSHV 0501 2380;
     |BLANCO 1202 2379;
     |CUADRO 1202 2379;
     |PINTA 1318, "CONCEPTO DE FACTURA RECTIFICATIVA";
     |PINTA 1514, "Introduzca el numero de la factura rectificada";

     aAlfa = #111#3;
     E_inf = "";
     E_sup = "40";
     aAlfa = 1716 ? 1;
     #111#3 = aAlfa;

     |POPV;
|FPRC;

|PROCESO TrataRecti;
     |ABRE #111;
     |DDEFECTO #111;
     #111#0 = #15#0;
     #111#1 = #15#27;
     #111#2 = #15#2;
     |LEE 101#111=;
     nEsta11 = FSalida;

     |ABRE #117;
     #117#0 = #15#6;
     |LEE 001#117=;
     |SI FSalida ! 0;  |DDEFECTO #117;  |FINSI;
     |SI #117#5 = "D";
         |HAZ PideRectif;
         |SI nEsta11 = 0; |GRABA 020#111a; |FINSI;
         |SI nEsta11 ! 0; |GRABA 020#111b; |FINSI;
     |SINO;
         |SI nEsta11 = 0; |BORRA 020#111a; |FINSI;
     |FINSI;
     |CIERRA #117;
     |LIBERA #111;
     |CIERRA #111;

     |SI extf ] "01.01.0000";
          |ABRE #112;
          #112#0 = #15#0;
          #112#1 = #15#27;
          #112#2 = #15#2;
          |LEE 101#112=;
          |SI FSalida ! 0;
              #112#0 = #15#0;
              #112#1 = #15#27;
              #112#2 = #15#2;
              |GRABA 020#112b;
          |FINSI;
          #112#3 = extf;
          |GRABA 020#112a;
          |LIBERA #112;
          |CIERRA #112;
     |FINSI;
|FPRC;

|PROCESO TrataSiiPred;

   |ABRE #caivaasi;
   |LEE 041#caivaasi.p;
   |CIERRA #caivaasi;
   |SI #caivaasi#51 ! "S"; |ACABA; |FINSI;

   eaNomFich  = ("0p" + Usuario) % 108;
   |NOME_DAT #caivatm4#eaNomFich#;
   |DELINDEX #caivatm4;

   |SI #11#3 = "R";
       eaSiiPro = "caivarep";
       enSiiLib = #caivarep#0;
       eaSiiDoc = #caivarep#27 + (("000000" + #caivarep#2) % -106);
       enSiiDoc = #caivarep#2;
       eaSiiSer = #caivarep#27;
       enSiiDoc = #caivarep#2;
       enSiiLin = 0;
       eaSiiCpt = #caivarep#6;
       eaSiiCta = #caivarep#4;
       eaSiiDig = #caivarep#5;
       eaSiiCIF = #caivarep#51;  |QBF eaSiiCIF;
       eaSiiDes = #caivarep#7;
       eaSiiEje = #caivarep#3 % -104;
       enSiiPer = #caivarep#44;
       enSiiUlt = #caivarep#62;
       enSiiRet = 0;
   |SINO;
       eaSiiPro = "caivasop";
       enSiiLib = #caivasop#0;
       eaSiiDoc = #caivasop#27 + (("000000" + #caivasop#2) % -106);
       enSiiDoc = #caivasop#2;
       eaSiiSer = #caivasop#27;
       enSiiDoc = #caivasop#2;
       enSiiLin = 0;
       eaSiiCpt = #caivasop#6;
       eaSiiCta = #caivasop#4;
       eaSiiDig = #caivasop#5;
       eaSiiCIF = #caivasop#51;  |QBF eaSiiCIF;
       eaSiiDes = #caivasop#7;
       eaSiiEje = #caivasop#3 % -104;
       enSiiPer = #caivasop#44;
       enSiiUlt = 1;
       enSiiRet = 0;
   |FINSI;

   |ABRE #caivatm4;
   #caivatm4#0 = 0;
   #caivatm4#1 = 0;
   #caivatm4#2 = #11#3;
   #caivatm4#3 = enSiiLib;
   #caivatm4#4 = eaSiiSer;
   #caivatm4#5 = enSiiDoc;
   |LEE 041#caivatm4.=;
   |SI FSalida ! 0;
       #caivatm4#0 = 0;
       #caivatm4#1 = 0;
       #caivatm4#2 = #11#3;
       #caivatm4#3 = enSiiLib;
       #caivatm4#4 = eaSiiSer;
       #caivatm4#5 = enSiiDoc;
       |GRABA 020#caivatm4.n;
   |FINSI;
   |CIERRA #caivatm4;
   |SUB_EJECUTA_NP "caut0018;PASE";

    |SI enGrabaSii = 1;
         enSiiL = 1;
         |SUB_EJECUTA "casiim01";
         enSiiL = 0;
    |FINSI;
|FPRC;


|PROCESO BorraRecti;
     |ABRE #111;
     |DDEFECTO #111;
     #111#0 = #15#0;
     #111#1 = #15#27;
     #111#2 = #15#2;
     |LEE 101#111=;
     |SI FSalida = 0;
         |BORRA 020#111a;
     |FINSI;
     |LIBERA #111;
     |CIERRA #111;

     |ABRE #112;
     #112#0 = #15#0;
     #112#1 = #15#27;
     #112#2 = #15#2;
     |LEE 101#112=;
     |SI FSalida = 0;
         |BORRA 020#112a;
     |FINSI;
     |LIBERA #112;
     |CIERRA #112;
|FPRC;

|PROCESO TrataOtrosS;
     |SI extf ] "01.01.0000";
          |ABRE #113;
          #113#0 = #16#0;
          #113#1 = #16#27;
          #113#2 = #16#2;
          |LEE 101#113=;
          |SI FSalida ! 0;
              #113#0 = #16#0;
              #113#1 = #16#27;
              #113#2 = #16#2;
              |GRABA 020#113b;
          |FINSI;
          #113#3 = extf;
          |GRABA 020#113a;
          |LIBERA #113;
          |CIERRA #113;
     |FINSI;
|FPRC;

|PROCESO bor_OtrosS;
  |ABRE #113;
  #113#0 = #16#0;
  #113#1 = #16#27;
  #113#2 = #16#2;
  |LEE 101#113=;
  |SI FSalida = 0;
      |BORRA 020#113a;
  |FINSI;
  |LIBERA #113;
  |CIERRA #113;
|FPRC;

|PROCESO graba_ivas;
|ABRE #16;
    #16#00 = #11#4;      || libro
|HAZ lee_libro;
    #16#01 = #17#1;      || descripcion libro
    #16#02 = i_factu;    || factura
    #16#03 = i_fecha;    || fecha
    #16#04 = i_cuent;    || cuenta
    #16#05 = i_digit;    || digito
    #16#06 = i_conce;    || concepto
    #16#07 = i_descr;    || descripcion
    #16#08 = #16#08 * i_signo;                 || base 1
    #16#09 = #16#09 * i_signo;                 || base 2
    #16#10 = #16#10 * i_signo;                 || base 3
    #16#52 = #16#52 * i_signo;                 || base 4
    #16#53 = #16#53 * i_signo;                 || base 5
    #16#14 = #16#14 * i_signo;                 || cuota iva 1
    #16#15 = #16#15 * i_signo;                 || cuota iva 2
    #16#16 = #16#16 * i_signo;                 || cuota iva 3
    #16#56 = #16#56 * i_signo;                 || cuota iva 4
    #16#57 = #16#57 * i_signo;                 || cuota iva 5
    #16#20 = #16#20 * i_signo;                 || cuota rec 1
    #16#21 = #16#21 * i_signo;                 || cuota rec 2
    #16#22 = #16#22 * i_signo;                 || cuota rec 3
    #16#60 = #16#60 * i_signo;                 || cuota rec 4
    #16#61 = #16#61 * i_signo;                 || cuota rec 5
    |SI #16#14 ! 0;  |Y iva1 = 0;              || (%) iva 1
        #16#11 = ((#16#14 * 100) / #16#08) ! 0;
    |SINO;
        #16#11 = iva1;
    |FINSI;
    |SI #16#15 ! 0;  |Y iva2 = 0;              || (%) iva2
        #16#12 = ((#16#15 * 100) / #16#09) ! 0;
    |SINO;
        #16#12 = iva2;
    |FINSI;
    |SI #16#16 ! 0;  |Y iva3 = 0;              || (%) iva 3
        #16#13 = ((#16#16 * 100) / #16#10) ! 0;
    |SINO;
        #16#13 = iva3;
    |FINSI;
    |SI #16#56 ! 0;  |Y iva4 = 0;              || (%) iva 4
        #16#54 = ((#16#56 * 100) / #16#52) ! 0;
    |SINO;
        #16#54 = iva4;
    |FINSI;
    |SI #16#57 ! 0;  |Y iva5 = 0;              || (%) iva 5
        #16#55 = ((#16#57 * 100) / #16#53) ! 0;
    |SINO;
        #16#55 = iva5;
    |FINSI;
    |SI #16#20 ! 0;  |Y req1 = 0;              || (%) rec 1
        #16#17 = ((#16#20 * 100) / #16#08) ! 1;
    |SINO;
        #16#17 = req1;
    |FINSI;
    |SI #16#21 ! 0;  |Y req2 = 0;              || (%) rec 2
        #16#18 = ((#16#21 * 100) / #16#09) ! 1;
    |SINO;
        #16#18 = req2;
    |FINSI;
    |SI #16#22 ! 0;  |Y req3 = 0;              || (%) rec 3
        #16#19 = ((#16#22 * 100) / #16#10) ! 1;
    |SINO;
        #16#19 = req3;
    |FINSI;
    |SI #16#60 ! 0;  |Y req4 = 0;             || (%) rec 4
        #16#58 = ((#16#60 * 100) / #16#52) ! 1;
    |SINO;
        #16#58 = req4;
    |FINSI;
    |SI #16#61 ! 0;  |Y req5 = 0;             || (%) rec 5
        #16#59 = ((#16#61 * 100) / #16#53) ! 1;
    |SINO;
        #16#59 = req5;
    |FINSI;
    #16#23 = #11#11;     || deducible
|HAZ total_ivas;         || total factura
    #16#27 = i_serie;    || serie
    #16#28 = "N";        || liquidada
|HAZ periodo;
    #16#44 = i_perio;    || periodo
    #16#45 = #1#0;       || diario
    #16#46 = #1#1;       || fecha asiento
    #16#47 = #1#2;       || documento
    #16#48 = #11#12;     || inversiones
    #16#49 = i_depar;    || departamento
    #16#50 = i_nom;      || nombre
    #16#51 = i_cif;      || cif
|GRABA 020#16n;
|LIBERA #16;
|CIERRA #16;
|HAZ TrataOtrosS;
  iva1 = 0;  iva2 = 0;  iva3 = 0;  iva4 = 0;  iva5 = 0;
  req1 = 0;  req2 = 0;  req3 = 0;  req4 = 0;  req5 = 0;
|FPRC;

|PROCESO pagos;
|ABRE #16;
    #16#00 = #11#4;      || libro
    #16#02 = i_factu;    || factura
    #16#27 = i_serie;    || serie
|LEE 021#16=;
|SI FSalida = 0;
        libro = #16#0;
        orden = #16#2;
        serie = #16#27;
        emision = #16#3;
        pesetas = #16#26 - irpf;
        cuenta = #16#4;
        digito = #16#5;
        nConcep = #16#6;
        aDesc   = #16#7;
    |SUB_EJECUTA_NP "calinpag.run";
|FINSI;
|SELECT #1#16;
|CIERRA #16;
   irpf = 0;
|FPRC;

|PROCESO lee_libro;
 |ABRE #17;
 #17#0 = #11#4;
 |LEE 001#17=;
 |SI FSalida ! 0;
     #17#1 = "<LIBRO INEXISTENTE>";
 |FINSI;
 |CIERRA #17;
|FPRC;

|PROCESO periodo;
    |SI #caivaasi#53 = "A";
        fecha1 = #1#1;
    |SINO;
        fecha1 = i_fecha;
    |FINSI;
    alfa1 = fecha1;

    |SI #caivaasi#46 = "T";
        alfa1 = alfa1 % -104;   || saca ao
        alfa2 = "31.03." + alfa1;  trim1 = alfa2;  || primer trimestre
        alfa2 = "30.06." + alfa1;  trim2 = alfa2;  || segundo trimestre
        alfa2 = "30.09." + alfa1;  trim3 = alfa2;  || tercer trimestre

        |SI fecha1 [ trim1;                    i_perio = 1;  |FINSI;
        |SI fecha1 > trim1;|Y fecha1 [ trim2;  i_perio = 2;  |FINSI;
        |SI fecha1 > trim2;|Y fecha1 [ trim3;  i_perio = 3;  |FINSI;
        |SI fecha1 > trim3;                    i_perio = 4;  |FINSI;
    |SINO;
        alfa1 = alfa1 % 402;    || saca mes
        i_perio = alfa1;
    |FINSI;
|FPRC;

|PROCESO TotalIvaR;
    #15#14 = (#15#08 % #15#11) ! EURODB; #15#20 = (#15#08 % #15#17) ! EURODB;
    #15#15 = (#15#09 % #15#12) ! EURODB; #15#21 = (#15#09 % #15#18) ! EURODB;
    #15#16 = (#15#10 % #15#13) ! EURODB; #15#22 = (#15#10 % #15#19) ! EURODB;
    #15#56 = (#15#52 % #15#54) ! EURODB; #15#60 = (#15#52 % #15#58) ! EURODB;
    #15#57 = (#15#53 % #15#55) ! EURODB; #15#61 = (#15#53 % #15#59) ! EURODB;
    |HAZ total_ivar;
|FPRC;

|PROCESO total_ivar;
    nume1 = #15#08 +#15#09 +#15#10 +#15#52 +#15#53;    || bases imponibles
    nume2 = #15#14 +#15#15 +#15#16 +#15#56 +#15#57;    || cuotas iva
    nume3 = #15#20 +#15#21 +#15#22 +#15#60 +#15#61;    || total cuotas rec.
    #15#26 = nume1 + nume2 + nume3;                    || TOTAL FACTURA
|FPRC;

|PROCESO TotalIvaS;
    #16#14 = (#16#08 % #16#11) ! EURODB; #16#20 = (#16#08 % #16#17) ! EURODB;
    #16#15 = (#16#09 % #16#12) ! EURODB; #16#21 = (#16#09 % #16#18) ! EURODB;
    #16#16 = (#16#10 % #16#13) ! EURODB; #16#22 = (#16#10 % #16#19) ! EURODB;
    #16#56 = (#16#52 % #16#54) ! EURODB; #16#60 = (#16#52 % #16#58) ! EURODB;
    #16#57 = (#16#53 % #16#55) ! EURODB; #16#61 = (#16#53 % #16#59) ! EURODB;
    |HAZ total_ivas;
|FPRC;

|PROCESO total_ivas;
    nume1 = #16#08 +#16#09 +#16#10 +#16#52 +#16#53;    || bases imponibles
    nume2 = #16#14 +#16#15 +#16#16 +#16#56 +#16#57;    || cuotas iva
    nume3 = #16#20 +#16#21 +#16#22 +#16#60 +#16#61;    || cuotas rec.
    #16#26 = nume1 + nume2 + nume3;                    || TOTAL FACTURA
|FPRC;

|PROCESO lee_clien;
  |ABRE #18;
  #18#23 = "C";
  #18#10 = i_cuent;
  #18#11 = i_digit;
  |LEE 001#18=;
  |SI FSalida ! 0;
      |DDEFECTO #18;
      |HAZ lee_cuent;
      i_nom = #4#2;         || nombre de la cuenta
  |SINO;
      i_nom = #18#1;        || nombre del cliente
  |FINSI;
  |CIERRA #18;
|FPRC;

|PROCESO lee_prove;
  |ABRE #18;
  #18#23 = "P";
  #18#10 = i_cuent;
  #18#11 = i_digit;
  |LEE 001#18=;
  |SI FSalida ! 0;
      |DDEFECTO #18;
      |HAZ lee_cuent;
      i_nom = #4#2;         || nombre de la cuenta
  |SINO;
      i_nom = #18#1;        || nombre del proveedor
  |FINSI;
  |CIERRA #18;
|FPRC;

|PROCESO lee_cuent;
 |ABRET #4;
 #4#0 = i_cuent;
 #4#1 = i_digit;
 |LEE 001#4=;
 |SI FSalida ! 0;
     |DDEFECTO #4;
 |FINSI;
 |CIERRAT #4;
|FPRC;

|PROCESO c_nombre;
|DDEFECTO #26;
|ABRE #26;
|LEE 000#26p;
|CIERRA #26;

|SI #11#3 = "R"; |HAZ lee_clien; i_cif=#18#9; i_cc1=#18#21; i_dc1=#18#22; |FINSI;
|SI #11#3 = "S"; |HAZ lee_prove; i_cif=#18#9; i_cc2=#18#21; i_dc2=#18#22; |FINSI;
|SI nNoLee = 1;
    i_nom = i_nomF;
    i_cif = i_cifF;
|FINSI;
nNoLee = 0;

|SI #26#35 = "S";|O #26#36 = "S";
    |ABRE #caacrval;
    #caacrval#0 = i_cuent;
    #caacrval#1 = i_digit;
    #caacrval#2 = 1;
    |LEE 010#caacrval.];
    |SI FSalida = 0; |Y #caacrval#0 = i_cuent; |Y #caacrval#1 = i_digit;
       |PUSHV 05012380;
       Comodin = "caacrvar.tab;" + i_cuent + "/" + i_digit;
       |SUB_EJECUTA Comodin;
       |SI FSalida = 0;
          |ABRE #calisfra;
          #calisfra#0 = #camaasil#13;
          #calisfra#1 = #camaasil#15;
          #calisfra#2 = #camaasil#14;
          |LEE 010#calisfra.=;
          |SI FSalida = 0;
             #calisfra#3 = i_cuent;
             #calisfra#4 = i_digit;
             #calisfra#5 = LineaExt;
             ||#calisfra#5 = #caacrval#2;
             |GRABA 020#calisfra.a;
          |SINO;
             |DDEFECTO #calisfra;
             #calisfra#0 = #camaasil#13;
             #calisfra#1 = #camaasil#15;
             #calisfra#2 = #camaasil#14;
             #calisfra#3 = i_cuent;
             #calisfra#4 = i_digit;
             #calisfra#5 = LineaExt;
             ||#calisfra#5 = #caacrval#2;
             |GRABA 020#calisfra.n;
          |FINSI;
          |CIERRA #calisfra;
          i_nom = NombreExt;
          i_cif = CifExt;
       |SINO;
          |ERROR;
       |FINSI;
       |POPV;
    |SINO;
       |PUSHV 05012380;
       |PINPA #0#25;
       #25#0 = i_nom;
       #25#1 = i_cif;
       |PINDA #0#25;
       alfa1 = #26#35;       || modificable nombre
       alfa2 = #26#36;       || modificable cif
       |CAMPO_MODIFICA #25#0, 1, alfa1;
       |CAMPO_MODIFICA #25#1, 1, alfa2;
       |ENDATOS #1#25;
       |SI FSalida = 0;
          i_nom = #25#0;
          i_cif = #25#1;
       |FINSI;
       |POPV;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO c_contra;
  alfa1 = #12#3;
  |QBF alfa1;
  alfa2 = alfa1 %  103;
  alfa3 = alfa1 % -101;
  |SI alfa2 ! "CON";  |ACABA;  |FINSI;
  |SI #11#2 = "S";
      |SI #11#3 = "R";  #12#3 = i_cc1;  #12#4 = i_dc1;  |FINSI;
      |SI #11#3 = "S";  #12#3 = i_cc2;  #12#4 = i_dc2;  |FINSI;
      |SI #12#3 = doce;
          alfa3 = "*";       || por si la contrapartida viene vacia
      |FINSI;
      |SI alfa3 = "*";
          alfa4 = #12#3;
          |QBF alfa4;
          #12#3 = alfa4 + alfa3;
      |FINSI;
  |SINO;
      #12#3 = "*";
      #12#4 = 0;
  |FINSI;
|FPRC;

|PROCESO el_amo; || facturas de inversion COMPRA
  |AVISO;
  |CONFI "2400SFra. de Inversion. Desea crear el Bien Amortizable S/N : ";
  |SI FSalida ! 0;
      |ACABA;
  |FINSI;
  fec_am = #16#3;
  imp_am = #16#8 + #16#9 + #16#10 + #16#52 + #16#53;
    c_am = #16#7;
  ct1_am = "";
  ct2_am = 0;
  prv_am = #16#50;
  eaCodDep = #16#49;
                            || primer = #16#4 % 101;
                            || |SI primer = "4";
                            ||     prv_am = #16#50;
                            || |FINSI;
  primer = ctab1 % 101;
  |SI primer = "2";
      ct1_am = ctab1;
      ct2_am = ctab2;
  |FINSI;
  |SUB_EJECUTA_NP "camocab1.tab";
|FPRC;

|PROCESO el_amov; || facturas de inversion VENTA
  |AVISO;
  |CONFI "2400SFra. de Inversion. Desea reflejar la venta del Bien Amortizable S/N : ";
  |SI FSalida ! 0;
      |ACABA;
  |FINSI;
  fec_am   = #15#3;
  imp_am   = #15#8 + #15#9 + #15#10 + #15#52 + #15#53;
   c_am    = #15#7;
  |SUB_EJECUTA_NP "camocab2.tab";
|FPRC;

|PROCESO RevisionPartida;
   |SI #camaasil#12 = "R"; |O #camaasil#12 = "S";
      |MENAV "    Registro enlazado correctamente";
      |ERROR;
   |SINO;
      Diario    = #camaasil#0;
      Fecha     = #camaasil#1;
      Documento = #camaasil#2;
      Linea     = #camaasil#3;
      |ABRE #camaasil;
      #camaasil#0 = Diario;
      #camaasil#1 = Fecha;
      #camaasil#2 = Documento;
      |SI Linea = 1;
         #camaasil#3 = Linea + 10;
      |SINO;
         #camaasil#3 = Linea - 10;
      |FINSI;
      |LEE 010#camaasil.=
      |SI FSalida = 0;
         #carevisa#0 = #camaasil#13;
         #carevisa#2 = #camaasil#14;
         #carevisa#1 = #camaasil#15;
      |SINO;
         |DDEFECTO #carevisa;
      |FINSI;
      |PUSHV 0501 2380;
      |PINPA #0#carevisa;
      |PINDA #0#carevisa;
      |ENDATOS #1#carevisa;
      |SI FSalida < 0; |POPV; |ACABA; |FINSI;
      #camaasil#0 = Diario;
      #camaasil#1 = Fecha;
      #camaasil#2 = Documento;
      #camaasil#3 = Linea;
      |LEE 110#camaasil.=;
      |SI FSalida = 0;
         |ABRE #calibros;
         #calibros#0 = #carevisa#0;
         |LEE 010#calibros.=;
         |CIERRA #calibros;
         #camaasil#12 = #calibros#2;
         #camaasil#13 = #carevisa#0;
         #camaasil#14 = #carevisa#2;
         #camaasil#15 = #carevisa#1;
         #camaasil#19 = #carevisa#3;
         #camaasil#20 = #carevisa#4;
         |GRABA 020#camaasil.a;
      |FINSI;
      |LIBERA #camaasil;
      |CIERRA #camaasil;
      |SI #calibros#2 = "R";
         |ABRE #caivarep;
         #caivarep#0  = #carevisa#0;
         #caivarep#27 = #carevisa#1;
         #caivarep#2  = #carevisa#2;
         |LEE 110#caivarep.=;
         |SI FSalida = 0;
            |SI #carevisa#3 = "B";
               |SI #carevisa#4 = 1;
                  #caivarep#8  = #caivarep#8 + #camaasil#9;
                  #caivarep#14 = #caivarep#8 % #caivarep#11;
                  #caivarep#20 = #caivarep#8 % #caivarep#17;
               |FINSI;
               |SI #carevisa#4 = 2;
                  #caivarep#9  = #caivarep#9 + #camaasil#9;
                  #caivarep#15 = #caivarep#9 % #caivarep#12;
                  #caivarep#21 = #caivarep#9 % #caivarep#18;
               |FINSI;
               |SI #carevisa#4 = 3;
                  #caivarep#10 = #caivarep#10 + #camaasil#9;
                  #caivarep#16 = #caivarep#10 % #caivarep#13;
                  #caivarep#22 = #caivarep#10 % #caivarep#19;
               |FINSI;
               |SI #carevisa#4 = 4;
                  #caivarep#52 = #caivarep#52 + #camaasil#9;
                  #caivarep#56 = #caivarep#52 % #caivarep#54;
                  #caivarep#60 = #caivarep#52 % #caivarep#58;
               |FINSI;
               |SI #carevisa#4 = 5;
                  #caivarep#53 = #caivarep#53 + #camaasil#9;
                  #caivarep#57 = #caivarep#53 % #caivarep#55;
                  #caivarep#61 = #caivarep#53 % #caivarep#59;
               |FINSI;
            |FINSI;
            |SI #carevisa#3 = "I";
               |SI #carevisa#4 = 1; #caivarep#14 = #caivarep#14 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 2; #caivarep#15 = #caivarep#15 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 3; #caivarep#16 = #caivarep#16 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 4; #caivarep#56 = #caivarep#56 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 5; #caivarep#57 = #caivarep#57 + #camaasil#9; |FINSI;
            |FINSI;
            |SI #carevisa#3 = "R";
               |SI #carevisa#4 = 1; #caivarep#20 = #caivarep#20 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 2; #caivarep#21 = #caivarep#21 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 3; #caivarep#22 = #caivarep#22 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 4; #caivarep#60 = #caivarep#60 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 5; #caivarep#61 = #caivarep#61 + #camaasil#9; |FINSI;
            |FINSI;
            #caivarep#26 = #caivarep#8 + #caivarep#9 + #caivarep#10 + #caivarep#52 + #caivarep#53;
            #caivarep#26 = #caivarep#26 + #caivarep#14 + #caivarep#15 + #caivarep#16 + #caivarep#56 + #caivarep#57;
            #caivarep#26 = #caivarep#26 + #caivarep#20 + #caivarep#21 + #caivarep#22 + #caivarep#60 + #caivarep#61;
            |GRABA 020#caivarep.a;
         |FINSI;
         |LIBERA #caivarep;
         |CIERRA #caivarep;
      |SINO;
         |ABRE #caivasop;
         #caivasop#0  = #carevisa#0;
         #caivasop#27 = #carevisa#1;
         #caivasop#2  = #carevisa#2;
         |LEE 110#caivasop.=;
         |SI FSalida = 0;
            |SI #carevisa#3 = "B";
               |SI #carevisa#4 = 1;
                  #caivasop#8  = #caivasop#8 + #camaasil#9;
                  #caivasop#14 = #caivasop#8 % #caivasop#11;
                  #caivasop#20 = #caivasop#8 % #caivasop#17;
               |FINSI;
               |SI #carevisa#4 = 2;
                  #caivasop#9  = #caivasop#9 + #camaasil#9;
                  #caivasop#15 = #caivasop#9 % #caivasop#12;
                  #caivasop#21 = #caivasop#9 % #caivasop#18;
               |FINSI;
               |SI #carevisa#4 = 3;
                  #caivasop#10 = #caivasop#10 + #camaasil#9;
                  #caivasop#16 = #caivasop#10 % #caivasop#13;
                  #caivasop#22 = #caivasop#10 % #caivasop#19;
               |FINSI;
               |SI #carevisa#4 = 4;
                  #caivasop#52 = #caivasop#52 + #camaasil#9;
                  #caivasop#56 = #caivasop#52 % #caivasop#54;
                  #caivasop#60 = #caivasop#52 % #caivasop#58;
               |FINSI;
               |SI #carevisa#4 = 5;
                  #caivasop#53 = #caivasop#53 + #camaasil#9;
                  #caivasop#57 = #caivasop#53 % #caivasop#55;
                  #caivasop#61 = #caivasop#53 % #caivasop#59;
               |FINSI;
            |FINSI;
            |SI #carevisa#3 = "I";
               |SI #carevisa#4 = 1; #caivasop#14 = #caivasop#14 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 2; #caivasop#15 = #caivasop#15 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 3; #caivasop#16 = #caivasop#16 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 4; #caivasop#56 = #caivasop#56 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 5; #caivasop#57 = #caivasop#57 + #camaasil#9; |FINSI;
            |FINSI;
            |SI #carevisa#3 = "R";
               |SI #carevisa#4 = 1; #caivasop#20 = #caivasop#20 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 2; #caivasop#21 = #caivasop#21 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 3; #caivasop#22 = #caivasop#22 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 4; #caivasop#60 = #caivasop#60 + #camaasil#9; |FINSI;
               |SI #carevisa#4 = 5; #caivasop#61 = #caivasop#61 + #camaasil#9; |FINSI;
            |FINSI;
            #caivasop#26 = #caivasop#8 + #caivasop#9 + #caivasop#10 + #caivasop#52 + #caivasop#53;
            #caivasop#26 = #caivasop#26 + #caivasop#14 + #caivasop#15 + #caivasop#16 + #caivasop#56 + #caivarep#57;
            #caivasop#26 = #caivasop#26 + #caivasop#20 + #caivasop#21 + #caivasop#22 + #caivasop#60 + #caivarep#61;
            |GRABA 020#caivasop.a;
         |FINSI;
         |LIBERA #caivasop;
         |CIERRA #caivasop;
      |FINSI;
      |POPV;
   |FINSI;
|FPRC;

|PROCESO AadeDesc;

   Desc = #camaasil#7; |QBF Desc;
   |PARA Cont = 1; |SI Cont [ 3; |HACIENDO Cont = Cont + 1;
         Letra = #camaasil#7 % ((Cont * 100) + 1);
         |SI Letra = "S";
            |SI #0#12 = "S";
                Desc = Desc + #caivasop#27 + #caivaasi#48; |QBF Desc;
            |FINSI;
            |SI #0#12 = "R";
                Desc = Desc + #caivarep#27 + #caivaasi#48; |QBF Desc;
         |FINSI;
      |FINSI;
      |SI Letra = "F";
          |SI #0#12 = "R";
              alfa6 = #caivarep#1;
         |FINSI;
         |SI #0#12 = "S";
              alfa6 = #caivasop#1;
         |FINSI;
         |SI #caivaasi#49 = "S"; alfa6 = ("000000" + alfa6) % -106; |FINSI;
         Desc = Desc + alfa6  + " ";
      |FINSI;
      |SI Letra = "C";
         |SI #0#12 = "S";
            Desc = Desc + #caivasop#4 + " ";
         |FINSI;
         |SI #0#12 = "R";
            Desc = Desc + #caivarep#4 + " ";
         |FINSI;
      |FINSI;
   |SIGUE;
|FPRC;

|PROCESO Repasa;
|SI SopRep = "S"; |O SopRep = "R";
   |SI Libro ! #camaasil#12; |O Serie ! #camaasil#15; |O Fact ! #camaasil#14;
      |ACABA;
   |FINSI;
|FINSI;

|SI PrimD = 0;
   |SI #camaasil#8 = "H";
      |SI #camaasil#9 ] 0;
         |SI CtrapD = "";
            CtrapD = #camaasil#10;
            DigCtD = #camaasil#11;
         |SINO;
            |SI CtrapD ! #camaasil#10;
               CtrapD = "";
               DigCtD = 0;
               PrimD = 1;
            |FINSI;
         |FINSI;
               PrimD = 1;
      |SINO;
         |SI CtrapH = "";
            CtrapH = #camaasil#10;
            DigCtH = #camaasil#11;
         |SINO;
            |SI CtrapH ! #camaasil#10;
               CtrapH = "";
               DigCtH = 0;
               PrimH = 1;
            |FINSI;
         |FINSI;
               PrimH = 1;
      |FINSI;
   |FINSI;
|FINSI;

|SI PrimH = 0;
   |SI #camaasil#8 = "D";
      |SI #camaasil#9 ] 0;
         |SI CtrapH = "";
            CtrapH = #camaasil#16;
            DigCtH = #camaasil#17;
         |SINO;
            |SI CtrapH ! #camaasil#16;
               CtrapH = "";
               DigCtH = 0;
               PrimH = 1;
            |FINSI;
         |FINSI;
      |SINO;
         |SI CtrapD = "";
            CtrapD = #camaasil#16;
            DigCtD = #camaasil#17;
         |SINO;
            |SI CtrapD ! #camaasil#16;
               CtrapD = "";
               DigCtD = 0;
               PrimD = 1;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;
|FINSI;
|FPRC;

|DEFBUCLE Repasa;
#camaasil#1;
;
Diario,Fecha,Docum,0001;
Diario,Fecha,Docum,9999;
;
NULL,Repasa;
|FIN;

|PROCESO RehazCtraps;
     |ABRE #calicont;
     #calicont#0 = #camaasil#0;
     #calicont#1 = #camaasil#1;
     #calicont#2 = #camaasil#2;
     #calicont#3 = #camaasil#3;
     |LEE 010#calicont.=;
     |SI FSalida = 0;
        |SI #camaasil#8 = "D";
           |SI #camaasil#9 ] 0
              |SI CtrapD ! "";
                 #calicont#4 = CtrapD;
                 #calicont#5 = DigCtD;
                 |GRABA 020#calicont.a;
              |SINO;
                 |BORRA 020#calicont.a;
              |FINSI;
           |SINO;
              |SI CtrapH ! "";
                 #calicont#4 = CtrapH;
                 #calicont#5 = DigCtH;
                 |GRABA 020#calicont.a;
              |SINO;
                 |BORRA 020#calicont.a;
              |FINSI;
           |FINSI;
        |SINO;
           |SI #camaasil#9 ] 0
              |SI CtrapH ! "";
                 #calicont#4 = CtrapH;
                 #calicont#5 = DigCtH;
                 |GRABA 020#calicont.a;
              |SINO;
                 |BORRA 020#calicont.a;
              |FINSI;
           |SINO;
              |SI CtrapD ! "";
                 #calicont#4 = CtrapD;
                 #calicont#5 = DigCtD;
                 |GRABA 020#calicont.a;
              |SINO;
                 |BORRA 020#calicont.a;
              |FINSI;
           |FINSI;
        |FINSI;
        |LIBERA #calicont;
     |SINO;
        |SI #camaasil#8 = "D";
           |SI #camaasil#9 ] 0;
              |SI CtrapD ! "";
                 |DDEFECTO #calicont;
                 #calicont#0 = #camaasil#0;
                 #calicont#1 = #camaasil#1;
                 #calicont#2 = #camaasil#2;
                 #calicont#3 = #camaasil#3;
                 |LEE 101#calicont.=;
                 |SI FSalida ! 0;
                    |DDEFECTO #calicont;
                    #calicont#0 = #camaasil#0;
                    #calicont#1 = #camaasil#1;
                    #calicont#2 = #camaasil#2;
                    #calicont#3 = #camaasil#3;
                    |GRABA 020#calicont.b;
                 |FINSI;
                 #calicont#4 = CtrapD;
                 #calicont#5 = DigCtD;
                 |GRABA 020#calicont.a; |LIBERA #calicont;
              |FINSI;
           |SINO;
              |SI CtrapH ! "";
                 |DDEFECTO #calicont;
                 #calicont#0 = #camaasil#0;
                 #calicont#1 = #camaasil#1;
                 #calicont#2 = #camaasil#2;
                 #calicont#3 = #camaasil#3;
                 |LEE 101#calicont.=;
                 |SI FSalida ! 0;
                    |DDEFECTO #calicont;
                    #calicont#0 = #camaasil#0;
                    #calicont#1 = #camaasil#1;
                    #calicont#2 = #camaasil#2;
                    #calicont#3 = #camaasil#3;
                    |GRABA 020#calicont.b;
                 |FINSI;
                 #calicont#4 = CtrapH;
                 #calicont#5 = DigCtH;
                 |GRABA 020#calicont.a; |LIBERA #calicont;
              |FINSI;
           |FINSI;
        |SINO;
           |SI #camaasil#9 ] 0;
              |SI CtrapH ! "";
                 |DDEFECTO #calicont;
                 #calicont#0 = #camaasil#0;
                 #calicont#1 = #camaasil#1;
                 #calicont#2 = #camaasil#2;
                 #calicont#3 = #camaasil#3;
                 |LEE 101#calicont.=;
                 |SI FSalida ! 0;
                    |DDEFECTO #calicont;
                    #calicont#0 = #camaasil#0;
                    #calicont#1 = #camaasil#1;
                    #calicont#2 = #camaasil#2;
                    #calicont#3 = #camaasil#3;
                    |GRABA 020#calicont.b;
                 |FINSI;
                 #calicont#4 = CtrapH;
                 #calicont#5 = DigCtH;
                 |GRABA 020#calicont.a; |LIBERA #calicont;
              |FINSI;
           |SINO;
              |SI CtrapD ! "";
                 |DDEFECTO #calicont;
                 #calicont#0 = #camaasil#0;
                 #calicont#1 = #camaasil#1;
                 #calicont#2 = #camaasil#2;
                 #calicont#3 = #camaasil#3;
                 |LEE 101#calicont.=;
                 |SI FSalida ! 0;
                    |DDEFECTO #calicont;
                    #calicont#0 = #camaasil#0;
                    #calicont#1 = #camaasil#1;
                    #calicont#2 = #camaasil#2;
                    #calicont#3 = #camaasil#3;
                    |GRABA 020#calicont.b;
                 |FINSI;
                 #calicont#4 = CtrapD;
                 #calicont#5 = DigCtD;
                 |GRABA 020#calicont.a; |LIBERA #calicont;
              |FINSI;
           |FINSI;
        |FINSI;
     |FINSI;
     |CIERRA #calicont;
|FPRC;

|DEFBUCLE RehazCtraps;
#camaasil#1;
;
Diario,Fecha,Docum,0001;
Diario,Fecha,Docum,9999;
;
NULL,RehazCtraps;
|FIN;

|PROCESO RepasaCtraps;
   PrimD = 0; CtrapD = ""; DigCtD = 0;
   PrimH = 0; CtrapH = ""; DigCtH = 0;
   |SALVA_FICHA #camaasil;
   Diario = #camaasil#0;
   Fecha  = #camaasil#1;
   Docum  = #camaasil#2;
   Linea  = #camaasil#3;
   CtaAct = #camaasil#4;
   DigAct = #camaasil#5;
   Signo  = #camaasil#8;
   SopRep = #camaasil#12;
   Libro  = #camaasil#13;
   Fact   = #camaasil#14;
   Serie  = #camaasil#15;
   |BUCLE Repasa;
||   |BUCLE RehazCtraps;
   ||#camaasil#0 = Diario;    || con REPON_DATOS se perdia el puntero de la
   ||#camaasil#1 = Fecha;     ||/linea en las altas
   ||#camaasil#2 = Docum;
   ||#camaasil#3 = Linea;
   ||LEE 000#camaasil.=;
   |REPON_FICHA #camaasil;
|FPRC;


|PROCESO Modifico;

 |ABRE #120;
 #120#0 = #15#0;
 #120#1 = #15#2;
 #120#2 = #15#27;
 |LEE 101#120=;
 nEstado = FSalida;
 |SI nOpera = 0;           || Modificacion o alta
     #120#0 = #15#0;
     #120#1 = #15#2;
     #120#2 = #15#27;
     #120#3 = i_nserie; |QBF i_nserie;
     |SI i_nserie ! "";;
         |SI nEstado = 0; |GRABA 020#120a; |FINSI;
         |SI nEstado ! 0; |GRABA 020#120b; |FINSI;
     |SINO;
         |SI nEstado = 0; |BORRA 020#120a; |FINSI;
     |FINSI;
 |FINSI;
 |SI nOpera = 1;           || Baja
     |SI nEstado = 0; |BORRA 020#120a; |FINSI;
 |FINSI;
 |LIBERA #120;
 |CIERRA #120;
|FPRC;
