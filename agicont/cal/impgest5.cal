|FICHEROS;
     impgest5 #0;   ||Pantalla importacion
     impfich  #1;   ||Fichero de control path
     encoemp5 #2;   ||fichero de apuntes enlace gestion
     camaasic #3;   ||Cabeceras Apuntes
     camaasil #4;   ||lineas de Apuntes
     caivarep #5;   ||iva Repercutido, Ventas
     caivasop #6;   ||Iva soportado compras
     camandia #7;   ||diarios
     calibros #8;   ||libros de iva
     caconcep #9;   ||Conceptos
     cacuenta #11;  ||Fichero de cuentas
     encorec  #12;  ||Fichero de Cobros Enlace Gesion
     camancob #13;  ||Fichero de Cobros
     camanrec #14;  ||Fichero de Tipos de Recibo
     camanpag #15;  ||Fichero de Pagos
     caclipro #16;  ||clientes/proveedores GENERAL
     imptmp1  #18;  ||temporal nuevos numeros de IVA
     catradia #19;  ||temporal niveles superiores
     impcafac #33;  ||Cambio N§ Factura en Cobros....
     caivases #34;  ||contador de series
     caivaasi #35;  || Control entrada apuntes
     encoiva  #40;  || Temporal Ivas

     caivaref;
     caivasof;
     caivatm4;
|FIN;

|VARIABLES;
  &PRMNT_enSole = 0;

  alfa1 = "";
  alfa2 = "";
  &enDiario   = 0;
  &enContador = 0;
  nSal = 0;
  aFactuan = "";
  &fichero = "";
  fichero1 = "";
  &dir_fich1 = "";
  control = 0;
  control1 = 999;
  asiento = 0;
  asient1 = 0;
  fecha = @;
  diario = 0;
  asiehaber = 0;
  asiedebe = 0;
  c = 0;
  i_factu = 0;
  conta = 0;
  mensaje = "";
  librodesc = "";
  librodescc = "";
  contab = "";
  cuenta = "";
  nivel = 0;
  fecha1 = "";
  fecha2 = @;
  nume1  = 0;
  mes = "";
  nMes = 0;
  fmes = "";
  lon = "";
  niv = 0;
  lon1 = "";
  ok = 0;
  p1 = "";
  cta = "";
  mess = 0;
  cuentaz = "";
  i = 0;
  pasar = 0;
  total = 0;          ||si la variable total = 0 actualizare los importes
  empresa1 = "";      ||de las cuentas, si es uno, solo las dare de alta
  empresao = "";
  periodoo = "";
  empresa2 = "";
  dia = 0;
  docu = 0;
  fech = @;
  desdedi = 0;
  hastadi = 99;
  desdenum = 0;
  hastanum = 999999999;
  ini = 0;
  mesac = 0;
  fecalf = "";
  mesfec = 0;
  a = 0;
  b = 0;
  c1 = 0;
  cuencli = "";
  nivcli = 0;
  nombre = "";
  cif = "";
  nombre1 = "";
  opera = "";
  importe = 0;
  c_conh = "";
  d_conh = 0;
  c_cond = "";
  d_cond = 0;
  &feini = @;
  &fefin = @;
  ren_fra = 0;
  EsIva = 0;

  aAlfa  = "";
  nCanal = 0;

  &enEmpImpor = 0;
  &enBuscaDoc = 0;
  swPrimero   = 0;
  nNumLinea   = 0;
  nEstadoCab  = 0;
  Comod1 = "";
  Comod2 = "";
  nEstaLinea  = 0;
  nDiario = 0;
  fFecha  = @;
  nDocum  = 0;
  aParam  = "";
  &eaFitxer = "";
  &eaNomFich = "";
  aReferencia = "";
|FIN;

|INCLUYE acceso_i;

|PROCESO mayus;
  #0Campo = #0Campo > " ";
  |PINTA #0Campo;
|FPRC;

|| ********************************************************************
|PROCESO miraiva;
|SI #2#47 = 0; ||No este grabado
    enDiario = #2#0;
    |SI enBuscaDoc = 0;
        |HAZ contador;
        conta = enContador;
        #2#3 = enContador;
    |SINO;
        conta = #2#2;   || Documento;
    |FINSI;

 |ET otravez;
    #3#0 = #2#0;
    #3#1 = #2#1;
    #3#2 = conta;
    |LEE 001#3=;
    |SI FSalida = 0; |Y enBuscaDoc = 0;
        enDiario = #2#0;
        |HAZ contador;
        conta = enContador;
        #2#3 = enContador;
        |VETE otravez;
    |SINO;
        #2#47 = conta;
        |GRABA 001#2a;
        |LIBERA #2;
        |SI #0#7 = 3;    |HAZ grasidx;  |FINSI;
    |FINSI;

    dia  = #2#0;
    docu = #2#2;
    fech = #2#1;
    #2#4 = 1;
    |LEE 101#2];
    |PARA ; |SI FSalida = 0;
            |Y #2#0 = dia;
            |Y #2#1 = fech;
            |Y #2#2 = docu;
            |Y #2#4 ] 0;
                             |HACIENDO;
            #2#47 = conta;
            |GRABA 021#2a;
            |LIBERA #2;
            |SI #0#7 = 3;    |HAZ grasidx;  |FINSI;
            |LEE 101#2s;
    |SIGUE;
    #2#0 = dia;
    #2#1 = fech;
    #2#2 = docu;
    #2#4 = 0;
    |LEE 001#2];
|FINSI;
|FPRC;

|PROCESO altatra;
|ABRE #19;
    #19#0 = codcon;
    #19#1 = #4#4;        || cuenta
    #19#2 = #4#5;        || digito
    #19#3 = #4#1;        || fecha
    #19#4 = #4#8;        || signo
    #19#6 = #4#0;        || diario
|LEE 101#19=;
|SI FSalida ! 0;
    |DDEFECTO #19;
        #19#0 = codcon;
        #19#1 = #4#4;
        #19#2 = #4#5;
        #19#3 = #4#1;
        #19#4 = #4#8;
        #19#6 = #4#0;
    |GRABA 020#19b;
|FINSI;
    importe = #4#9;
|SI opera = "B";
        importe = -importe;
|FINSI;
    #19#5 = #19#5 + importe;
|GRABA 020#19a;
|LIBERA #19;
|CIERRA #19;
|FPRC;

|DEFBUCLE asiento1;
  #2#1;
  ;
  desdedi,feini,desdenum,desdenum;
  hastadi,fefin,hastanum,hastanum;
  be;
  NULL, miraiva;
|FIN;

||**********************************************************************
||**********************************************************************
|PROCESO GrabaNuevo;
   nNumLinea = nNumLinea + 1;
   #4#0 = #2#0;   ||diario
   #4#1 = #2#1;   ||fecha
   #4#2 = #2#47;  ||documento
   || ... #4#3 = #2#4;   ||linea
   #4#3 = nNumLinea;
   #4#8 = #2#11;  ||Signo
   |SI #4#8 = "D";     ||Es cuenta de debe
       #4#4 = #2#5;    ||Cuenta
       #4#5 = #2#7;    ||Digito
       #4#16 = #2#5;   ||Cuenta DEBE
       #4#17 = #2#7;  ||Digito DEBE
       #4#10 = "";
       #4#11 = 0;
       asiedebe = asiedebe + #2#12;
       cuenta = #4#16;
       nivel = #4#17;
       |SI d_conh=0; c_conh=#4#4; d_conh=#4#5; |FINSI;
   |SINO;              ||Es cuenta de haber
       #4#4 = #2#6;   ||Cuenta
       #4#5 = #2#8;   ||Digito
       #4#10 = #2#6;  ||cuenta HABER
       #4#11 = #2#8;  ||Digito HABER
       #4#16 = "";
       #4#17 = 0;
       asiehaber = asiehaber + #2#12;
       cuenta = #4#10;
       nivel = #4#11;
       |SI d_cond=0; c_cond=#4#4; d_cond=#4#5; |FINSI;
   |FINSI;
   total = 0;

|SI #4#5 = 0;
    alfa1 = "    Error en la Cuenta " + #4#4 + " Asiento: ";
    alfa2 = ("00" + #4#0) % -102;
    alfa1 = alfa1 + alfa2 + "-"+ #4#1 + "-";
    alfa2 = ("0000000" + #4#2) % -106;
    alfa1 = alfa1 + alfa2 + "-";
    alfa2 = ("0000" + #4#3) % -104;
    alfa1 = alfa1 + alfa2;
    |MENAV alfa1;
|FINSI;
   #4#6 = #2#9;   ||concepto
   #9#0 = #2#9;        ||Miro si existe el concepto
   |LEE 001#9=;
   |SI FSalida ! 0;
       #9#1 = "INEXISTENTE";
       |GRABA 001#9n;
       |LIBERA #9;
   |FINSI;
   #4#7  = #2#10;  ||descripcion concepto
   #4#24 = #9#1;   ||descripcion concepto
   #4#9 = #2#12;  ||Importe

   ||Si la factura a pasar ya existe, no se graban
   ||los datos de la factura en el asiento

   |SI pasar = 0;
        #4#12 = #2#13;   || soportado/repercutido
        #4#13 = #2#14;   || libro
        ||#4#14 = #2#16; || factura
        #4#14 = ren_fra; || por si se ha renumerado
        |SI ren_fra = 0;
            #4#14 = #2#16; || factura
        |FINSI;
        #4#15 = #2#17;   || serie
        #4#19 = #2#42;   || acumulador
        #4#20 = #2#43;   || nro.acumulador
        |SI #4#19 = " ";
            |SI #4#4 = #2#20; |Y #4#5 = #2#21;
                |SI #2#13 = "R"; |Y #4#8 = "D"; #4#19 = "F"; |FINSI;
                |SI #2#13 = "S"; |Y #4#8 = "H"; #4#19 = "F"; |FINSI;
            |FINSI;
        |FINSI;
   |FINSI;
   #4#21 = #2#40; ||departamento

/*
   ABDON 13/09/2005   TIQUET 1901/120

   Para que no incorpore asientos con lineas de importe cero
   Antes simplemente era un graba

   |GRABA 011#4n;
*/
|| INICIO

   |SI #4#9 ! 0; |GRABA 011#4n; |FINSI;

|| FIN

       opera = "A";
   |HAZ altatra;       || fichero de movimientos
   asiento = #2#47;
   asient1 = #2#3;
   fecha = #2#1;
   fecha1 = #2#1;
   diario = #2#0;
   ren_fra = #2#16;
   |HAZ cuentas;       ||En el proceso cuentas, averiguo si la
                       ||cuenta existe, si no la doy de alta
                       ||Acumulo los importes

|FPRC;
||**********************************************************************
|PROCESO BuscaLinea0;
 nNumLinea  = #4#3;
|FPRC;

|DEFBUCLE BuscaLinea;
 #4#1;
 ;
 #3#0,#3#1,#3#2,0001;
 #3#0,#3#1,#3#2,9999;
 ;
 NULL, BuscaLinea0;
|FIN;

|PROCESO miraasie;
 nEstaLinea = #2#4;
 control = #2#2;
 c = c + 1;
 |SI control ! control1;
     |SI c ! 1;
          |DDEFECTO #3;  ||Grabo la cabecera del asiento
          #3#0 = diario;
          #3#1 = fecha1;
          #3#2 = asiento;
          #3#3 = asiento; || Modificador por JOSE ( era campo asient1 = #2#3)
          #3#4 = asiedebe;
          #3#5 = asiehaber;
          #3#6 = #3#4 - #3#5; ||Saldo
          #3#7 = 0;
          #3#8 = c_conh;
          #3#9 = d_conh;
          #3#10 = c_cond;
          #3#11 = d_cond;
          |SI nEstadoCab ! 0; |GRABA 001#3n; |FINSI;
          |SI nEstadoCab = 0; |GRABA 001#3a; |FINSI;
          |LIBERA #3;
          swPrimero = 0;
          nNumLinea = 0;
          |HAZ grabadiario;   ||grabo en el fichero de diario
          asiehaber = 0;
          asiedebe = 0;
          c_conh = "";  d_conh = 0;
          c_cond = "";  d_cond = 0;
    |FINSI;
 |FINSI;

 EsIva = 0;
 |SI #2#22 ! 0;|O #2#23 ! 0;|O #2#24 ! 0;|O #2#48 ! 0;|O #2#49 ! 0;
      EsIva = 1;          || comprueba bases imponibles
 |SINO;
     |SI #2#25 ! 0;|O #2#26 ! 0;|O #2#27 ! 0;|O #2#50 ! 0;|O #2#51 ! 0;
          EsIva = 1;      || comprueba porcentajes
     |FINSI;              || las facturas con importe cero son validas tambien!
 |FINSI;                  || R.PRIEGO (23.02.99)

/*
    ABDON 09/09/2005 por el tiquet 1901/120

  Esta comprobacion hacia que cuando una de las bases que se preveen en el
  asiento es cero, le ponga el importe del total factura, descuadrando el asiento,
  pero no solo eso. al poner la variable 'EsIva' a uno, intenta grabar un nuevo
  registro de iva y se vuelve loco

 |SI EsIva = 0;|Y #2#37 ! 0; |Y #2#12 = 0;
      #2#22 = #2#37; EsIva = 1;
 |FINSI;
*/

/*
    ABDON 13/09/2005 por el tiquet 1901/120

  Al solucionar el comentario de arriba se ve que no pasa ahora las facturas
  con total factura cero. No crea el registro de iva con lo que se incorpora
  la condicion que hay debajo delimitada por 'INICIO' y 'FIN' para que en
  caso de que se este tratando la linea que lleva la informacion de IVA y
  este vacia y sea un total factura a cero cree el registro de iva vacio
*/

||INICIO

 |SI EsIva = 0; |Y #2#4 = 0; |Y #2#37 = 0;
    EsIva = 1;
 |FINSI;

||FIN

 |SI EsIva = 1;            || es asiento de iva
     |SI #caivaasi#53 = "A";
         alfa1 = #2#1;        || vuelvo a calcular periodo 156_262
     |SINO;
         alfa1 = #2#41;        || vuelvo a calcular periodo 156_262
     |FINSI;
     alfa1 = alfa1 % 0402;
     nMes   = alfa1;
     |SI #caivaasi#46 ="T";
         |SI nMes =  1; |O nMes =  2; |O nMes =  3; #2#44 = 1; |FINSI;
         |SI nMes =  4; |O nMes =  5; |O nMes =  6; #2#44 = 2; |FINSI;
         |SI nMes =  7; |O nMes =  8; |O nMes =  9; #2#44 = 3; |FINSI;
         |SI nMes = 10; |O nMes = 11; |O nMes = 12; #2#44 = 4; |FINSI;
     |SINO;
         #2#44 = nMes;
     |FINSI;
     |SI #2#13 = "R";
         |HAZ repercutido;   ||Si es Ventas Repercutido
     |FINSI;
     |SI #2#13 = "S";
         |HAZ soportado;     ||Si es Compras Soportado
     |FINSI;
     |SI pasar = 0;
         |HAZ GraboAuxtm4;  ||grabo auxiliar.
     |FINSI;
 |SINO;
                   || ... No es un asiento de iva
          Comod1 = #2#5; |QBF Comod1;
          Comod2 = #2#6; |QBF Comod2;
          |SI Comod1 = ""; |Y Comod2 = "";
              mensaje = "0000Factura [" + #2#16 + "] con apunte [" + #2#4 + "] erroneo. Sin cuentas.";
              |MENAV mensaje;
          |FINSI;

          |SI swPrimero = 1;
              |HAZ GrabaNuevo;
          |SINO;
              |DDEFECTO #3;
              #3#0 = #2#0;        ||diario
              #3#1 = #2#1;        ||fecha
              #3#2 = #2#47;       ||documento
              |LEE 101#3=;
              |SI FSalida ! 0;
                  nNumLinea  = 0;
                  nEstadoCab = 1;
                  |HAZ GrabaNuevo;
              |SINO;                   ||Si el numero de asiento ya existe
                  asiedebe = #3#4;
                  asiehaber = #3#5;
                  nEstadoCab = 0;
                  |BUCLE BuscaLinea;
                  |HAZ GrabaNuevo;
              |FINSI;
              swPrimero = 1;
         |FINSI;
 |FINSI;
 control1 = control;
|FPRC;

|PROCESO finasie;
          |DDEFECTO #3;       ||Grabo la cabecera del ultimo asiento leido
          #3#0 = diario;
          #3#1 = fecha1;
          #3#2 = asiento;
          #3#3 = asiento; ||Modificado por JOSE (Campo asient1 = #2#3)
          #3#4 = asiedebe;
          #3#5 = asiehaber;
          #3#6 = #3#4 - #3#5;
          #3#7 = 0;
          #3#8 = c_conh;
          #3#9 = d_conh;
          #3#10 = c_cond;
          #3#11 = d_cond;
          |GRABA 001#3n;
          |LIBERA #3;
          |HAZ grabadiario;
|FPRC;


|DEFBUCLE asiento;
   #2#1;
   ;
   desdedi,feini,desdenum,desdenum;
   hastadi,fefin,hastanum,hastanum;
   e;
   NULL,miraasie,NULL,NULL,finasie;
|FIN;

|PROCESO guafa2;
     #33#0 = #40#16;
     #33#4 = #40#17;
     |LEE 101#33=;
     nSal = FSalida;
     #33#0 = #40#16;
     #33#4 = #40#17;
     #33#1 = aFactuan;
     #33#2 = #40#18;  ||concepto iva
     #33#3 = #40#19;  ||Descripcion concepto LA MISMA QUE EL APUNTE!!!
     |SI nSal = 0; |GRABA 020#33a; |FINSI;
     |SI nSal ! 0; |GRABA 020#33n; |FINSI;
     |LIBERA #33;
|FPRC;

|PROCESO clientes2;
     nombre = "";
     cif = "";
     |ABRE #16;
     || .... SELECT #2#16; ahora es la primera clave

     #16#23 = "C";
     #16#10 = cuencli;
     #16#11 = nivcli;
     |LEE 001#16=;
     |SI FSalida = 0;
          nombre = #16#1;     ||nombre
          cif = #16#9;        ||cif del cliente
     |SINO;
          #16#23 = "P";
          #16#10 = cuencli;
          #16#11 = nivcli;
          |LEE 001#16=;
          |SI FSalida = 0;
               nombre = #16#1;     ||nombre
               cif = #16#9;        ||cif del cliente
          |SINO;
               nombre = nombre1;   ||nombre de la cuenta
               cif = #40#58;
          |FINSI;
     |FINSI;
     |CIERRA #16;
|FPRC;

|PROCESO camaasil;
    nDocum  = #4#2;
    fFecha  = #4#1;
    nDiario = #4#0;
    #40#47  = #4#2;
    |ERROR10;
|FPRC;

|DEFBUCLE camaasil;
#4#4;
;
#5#0,#5#27,#5#2;
#5#0,#5#27,#5#2;
;
NULL, camaasil;
|FIN;

|PROCESO repercutido2;
     pasar = 0;
     |DDEFECTO #5;
     #5#0 = #40#14;       || libro
     #5#27 = #40#17;      || serie
     |SI #0#10 = "S";
         |HAZ ultimaf;
         #5#2 = i_factu; || factura renumerada
     |SINO;
         #5#2 = #40#16;   || factura original
         |HAZ guardaf;
     |FINSI;

     aReferencia = "";
     aFactuan    = #5#2;
     |HAZ guafa2;
     ren_fra     = #5#2;     || lo guarda para rectificar la relacion con apuntes
     |LEE 001#5=;
     |SI FSalida ! 0;
          #5#1 = librodesc;  ||descripcion libro
          #5#3 = #40#41;  ||Fecha factura
          #5#4 = #40#20;  ||Cuenta iva
          #5#5 = #40#21;  ||digito cuenta
          cuenta = #5#4;
          nivel = #5#5;
          total = 1;
          |HAZ cuentas;
          #5#6 = #40#18;  ||concepto iva
          ||#5#7 = librodescc;  ||DEscripcion concepto
          #5#7 = #40#19;  ||DEscripcion concepto LA MISMA QUE EL APUNTE!!!
          #5#8 = #40#22;  ||Base 1 COns
          #5#9 = #40#23;  ||Base 2 red
          #5#10 = #40#24; ||Base 3 lujo
          #5#52 = #40#48; ||Base 4
          #5#53 = #40#49; ||Base 5
          #5#11 = #40#25; ||% Iva 1
          #5#12 = #40#26; ||% Iva 2
          #5#13 = #40#27; ||% Iva 3
          #5#54 = #40#50; ||% Iva 4
          #5#55 = #40#51; ||% Iva 5
          #5#14 = #40#28; ||Cuota iva 1
          #5#15 = #40#29; ||Cuota iva 2
          #5#16 = #40#30; ||Cuota iva 3
          #5#56 = #40#52; ||Cuota iva 4
          #5#57 = #40#53; ||Cuota iva 5
          #5#17 = #40#31; ||% Rec 1
          #5#18 = #40#32; ||% Rec 2
          #5#19 = #40#33; ||% Rec 3
          #5#58 = #40#54; ||% Rec 4
          #5#59 = #40#55; ||% Rec 5
          #5#20 = #40#34; ||Cuota Rec 1
          #5#21 = #40#35; ||Cuota Rec 2
          #5#22 = #40#36; ||Cuota Rec 3
          #5#60 = #40#56; ||Cuota Rec 4
          #5#61 = #40#57; ||Cuota Rec 5
          #5#23 = #40#39; ||deducible
          #5#26 = #40#37; ||Total factura
          |SI #5#26 ! 0;
             nDiario = #40#0;
             fFecha  = #40#1;
             nDocum  = #40#47;
             |BUCLE camaasil;||Busca en que documento esta la factura
             #5#45 = nDiario;  ||diario asiento
             #5#46 = fFecha;  ||Fecha asiento
             #5#47 = nDocum; ||documento asiento
          |FINSI;
          |SI #caivaasi#53 = "A";
               alfa1 = #5#46;        || vuelvo a calcular periodo 156_262
          |SINO;
               alfa1 = #5#3;         || vuelvo a calcular periodo 156_262
          |FINSI;
          alfa1 = alfa1 % 0402;
          nMes   = alfa1;
          |SI #caivaasi#46 ="T";
              |SI nMes =  1; |O nMes =  2; |O nMes =  3; #40#44 = 1; |FINSI;
              |SI nMes =  4; |O nMes =  5; |O nMes =  6; #40#44 = 2; |FINSI;
              |SI nMes =  7; |O nMes =  8; |O nMes =  9; #40#44 = 3; |FINSI;
              |SI nMes = 10; |O nMes = 11; |O nMes = 12; #40#44 = 4; |FINSI;
          |SINO;
               #40#44 = nMes;
          |FINSI;
          #5#44 = #40#44; ||Periodo
          #5#48 = #40#38; ||inversion
          #5#49 = #40#40; ||departamento
          cuencli = #5#4;
          nivcli = #5#5;
          |HAZ clientes2;
          #5#50 = nombre;
          #5#51 = cif;
          |GRABA 001#5n;
          |LIBERA #5;
     |SINO;
          mensaje = "0000Factura No: " + #5#2 + " Existente";
          |MENAV mensaje;
          pasar = 1;     ||Si la factura existe, pasar vale 1,
          dia = #40#0;    ||con lo que en las lineas de apuntes
          docu = #40#2;   ||no se grabaran los datos del IVA
          fech = #40#1;
          #40#4 = 1;
          |LEE 101#40];
          |PARA ; |SI FSalida = 0;
                  |Y #40#0 = dia;
                  |Y #40#1 = fech;
                  |Y #40#2 = docu;
                  |Y #40#4 >0;
                       |HACIENDO;
               #40#42 = "";    ||Tipo Acumulador
               #40#43 = 0;     ||Acumulador
               |GRABA 001#40a;
               |LIBERA #40;    ||Elimino parte de los datos del IVA
               |LEE 101#40s;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO encoiva;
     |HAZ repercutido2;
|FPRC;

|DEFBUCLE encoiva;
#40#1;
;
INICIO;
FINAL;
;
NULL,encoiva;
|FIN;

||***************************************************************************
||***************************************************************************
||***********************+HASTA AQUI EL ENLACE DE ASIENTOS*******************
||***************************************************************************
||***************************************************************************

||miro los cobros si son cobros o no

|PROCESO miracobro;
     |SI #12#18 = "C";   ||Si son cobros
          |HAZ cobro;
     |FINSI;
     |SI #12#18 = "P";        ||si es un pago
          |HAZ pago;
     |FINSI;
|FPRC;

|PROCESO pago;
  |DDEFECTO #15;
  |HAZ leefa;
  #15#0 = #12#0;
  #15#1 = aFactuan; || Cambio Factura Si #0#10 = "S" = que en iva... #12#1;
  #15#2 = #12#2;
  #15#3 = #12#3;
  |LEE 101#15=;
  |SI FSalida = 0;
      |SI #0#9 ! "S";
          mensaje = "0000El Pago " + #15#1 + "-" + #15#3 + " Ya Existe NO SE GRABARA";
          |MENAV mensaje;
      |SINO;
          |SI #15#22 ! "S";
              #15#9 = #15#9 + #12#9;        ||Gts Negociacion
              #15#10 = #15#10 + #12#10;     ||Gts Impagado
              #15#23 = #15#23 + #12#25;
              |SI #15#23 ] #15#8;  #15#22 = "S";  |FINSI;
              |GRABA 021#15a;
              |LIBERA #15;
          |FINSI;
      |FINSI;
  |SINO;
      |PARA i = 4; |SI i [ 13; |HACIENDO i = i + 1;
            #15i = #12i;
      |SIGUE;
      #15#14 = #12#19;         || nombre banco
      #15#15 = #12#20;         || direccion banco
      #15#16 = #12#22;         || cp. 1
      #15#17 = #12#23;         || cp. 2
      #15#18 = #12#17 % 114;   || cta.cte.
      #15#19 = #12#16;         || ccc
      #15#20 = #12#21;         || poblacion banco
      #15#27 = #33#2;          || Concepto = Iva.
      #15#28 = #33#3;          ||   ''        ''
      cuencli = #15#4;
      nivcli  = #15#5;
      |HAZ clientes;
      #15#26 = #16#28;
      |SI #12#24 = "P";
          #15#23 = #12#25;
          |SI #15#23 ] #15#8;      ||Cobrado completo
              #15#22 = "S";
          |FINSI;
      |FINSI;
      |GRABA 001#15n;
  |FINSI;
  cuenta = #15#4;
  nivel = #15#5;
  total = 1;
  |HAZ cuentas;
  #14#0 = #12#11;
  |LEE 001#14=;
  |SI FSalida ! 0;
      #14#1 = "INEXISTENTE";
      |GRABA 001#14n;
  |FINSI;
|FPRC;

|PROCESO cobro;
  |DDEFECTO #13;
  |HAZ leefa;
  #13#0 = #12#0;
  #13#1 = aFactuan; || Cambio Factura Si #0#10 = "S" = que en iva... #12#1;
  #13#2 = #12#2;
  #13#3 = #12#3;
  |LEE 101#13=;
  |SI FSalida = 0;
      |SI #0#9 ! "S";
          mensaje = "0000El Cobro " + #13#1 + "-" + #13#3 + " Ya Existe";
          |MENAV mensaje;
      |SINO;
          |SI #13#23 ! "S"; |Y #12#24 = "C";
                  #13#9 = #13#9 + #12#9;        ||Gts Negociacion
                  #13#10 = #13#10 + #12#10;     ||Gts Impagado
                  #13#24 = #13#24 + #12#25;
              |SI #13#24 ] #13#8;  #13#23 = "S";  |FINSI;

              |GRABA 021#13a;
              |LIBERA #13;
          |FINSI;
          |SI #12#24 = "I";
                  #13#9 = #13#9 + #12#9;        ||Gts Negociacion
                  #13#10 = #13#10 + #12#10;     ||Gts Impagado
                  #13#24 = #13#24 - #12#25;
                  #13#27 = #13#27 + 1;
              |SI #13#24 < #13#8;  #13#23 = "N";  |FINSI;
              |GRABA 021#13a;
              |LIBERA #13;
          |FINSI;
      |FINSI;
  |SINO;
      |PARA i = 4; |SI i [ 14; |HACIENDO i = i + 1;
            #13i = #12i;
      |SIGUE;
      #13#14 = #12#7;          || vto.original
      #13#15 = #12#19;         || nombre banco
      #13#16 = #12#20;         || direccion banco
      #13#17 = #12#22;         || cp. 1
      #13#18 = #12#23;         || cp. 2
      #13#19 = #12#17 % 114;   || cta.cte.
      #13#20 = #12#16;         || ccc
      #13#21 = #12#21;         || poblacion banco
      |SI #12#24 = "C";
          #13#24 = #12#25;
          |SI #13#24 ] #13#8;      ||Cobrado completo
              #13#23 = "S";
          |FINSI;
      |FINSI;
      #13#26 = #13#8;          || importe original
      #13#27 = 0;              || nro. impagos
      #13#28 = #12#17 % 1502;  || Representante
      |GRABA 001#13n;
      |LIBERA #13;
  |FINSI;
  cuenta = #13#4;
  nivel = #13#5;
  total = 1;
  |HAZ cuentas;    ||doy de alta si no existe la cuenta del cobro
  #14#0 = #12#11;
  |LEE 001#14=;
  |SI FSalida ! 0;
      #14#1 = "INEXISTENTE";
      |GRABA 001#14n;
  |FINSI;
|FPRC;

|DEFBUCLE cobros;
  #12#1;
  ;
  0  , 0       , "  " , 0;
  99 , 9999999 , "zz" , 999999;
  e;
  NULL,miracobro;
|FIN;

|PROCESO SerieSop;
   #caivases#0 = #caivasop#27;
   #caivases#1 = "S";
   |LEE 101#caivases.=;
   |SI FSalida = 0;
      |SI #caivasop#2 ] #caivases#3;
         #caivases#3 = #caivasop#2 + 1;
         |GRABA 020#caivases.a;
      |FINSI;
      |LIBERA #caivases;
   |FINSI;
|FPRC;

|DEFBUCLE SerieSop;
#caivasop#1;
;
INICIO;
FINAL;
;
NULL,SerieSop;
|FIN;

|PROCESO SerieRep;
   #caivases#0 = #caivarep#27;
   #caivases#1 = "R";
   |LEE 101#caivases.=;
   |SI FSalida = 0;
      |SI #caivarep#2 ] #caivases#3;
         #caivases#3 = #caivarep#2 + 1;
         |GRABA 020#caivases.a;
      |FINSI;
      |LIBERA #caivases;
   |FINSI;
|FPRC;

|DEFBUCLE SerieRep;
#caivarep#1;
;
INICIO;
FINAL;
;
NULL,SerieRep;
|FIN;

|PROCESO ContaLibros;
   |SI #calibros#2 = "S";
      #caivasop#0 = #calibros#0;
      #caivasop#27 = "  ";
      #caivasop#2 = 1;
      |LEE 000#caivasop.];
      |SI FSalida = 0; |Y #caivasop#0 = #calibros#0;
         |PARA; |SI FSalida = 0; |Y #caivasop#0 = #calibros#0; |HACIENDO;
            #calibros#4 = #caivasop#2 + #calibros#3;
            |LEE 000#caivasop.s;
         |SIGUE;
         |GRABA 020#calibros.a;
      |FINSI;
   |SINO;
      #caivarep#0 = #calibros#0;
      #caivarep#27 = "  ";
      #caivarep#2 = 1;
      |LEE 000#caivarep.];
      |SI FSalida = 0; |Y #caivarep#0 = #calibros#0;
         |PARA; |SI FSalida = 0; |Y #caivarep#0 = #calibros#0; |HACIENDO;
            #calibros#4 = #caivarep#2 + 1;
            |LEE 000#caivarep.s;
         |SIGUE;
         |GRABA 020#calibros.a;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE ContaLibros;
#calibros#1;
;
INICIO;
FINAL;
;
NULL,ContaLibros;
|FIN;

|PROCESO RecalcContad;
   |ABRE #caivasop;    |ABRE #caivarep;
   |BUCLE ContaLibros;
   |BUCLE SerieSop;    |BUCLE SerieRep;
   |CIERRA #caivarep;  |CIERRA #caivasop;
|FPRC;

|PROGRAMA;
  aParam = PARAMETRO; |QBF aParam;

  |CLS;
  |CABEZA "Importacion Gestion";
  |PINPA #0#0;
  |PINDA #0#0;
  |HAZ inicio;

  |ABRE #caivaasi;
  |LEE 000#caivaasi.p;
  |SI FSalida ! 0;
     |DDEFECTO #caivaasi;
     |GRABA 020#caivaasi.n;
     |LEE 000#caivaasi.p;
  |FINSI;
  |CIERRA #caivaasi;

  |SI enEmpImpor ! 0;
      #0#3 = enEmpImpor;
      |PINTA #0#3;
  |FINSI;

  |ABRE #19;
  |LEE 101#19u;
  |SI FSalida ! 0;
      |DDEFECTO #19;
      #19#0 = 1;
  |SINO;
      #19#0 = #19#0 + 1;
  |FINSI;
  |GRABA 101#19n;
  codcon = #19#0;
  |LIBERA #19;
  |CIERRA #19;

  |SI aParam = "LAPIZ";
      #0#3 = enEmpresa; |PINTA #0#3;
      |C_M #0#3, 1, "N";
  |FINSI;

  |ENDATOS #1#0;
  |SI FSalida ! 0;  |ERROR;  |ACABA;  |FINSI;
  |SI #0#0 ! "SI";  |ERROR;  |ACABA;  |FINSI;

  eaNomFich  = ("0p" + Usuario) % 108;
  |NOME_DAT #caivatm4#eaNomFich#;
  |DELINDEX #caivatm4;

  dir_fich1 = #1#2; |QBF dir_fich1;

  |SI #0#7 = 2;  |O #0#7 = 4;    |HAZ secuencial;  |FINSI;
  |SI #0#7 = 3;  |Y #0#8 = "S";  |HAZ indexado;  |FINSI;

   |SI #0#8 = "S";
       |HAZ b_apuntes;
       |SUB_EJECUTA "camaapua";        || solo en importacion completa
   |FINSI;

   |SI aParam ! "LAPIZ"; |HAZ b_cobros; |FINSI;

   |SI #0#10 = "N";
      |HAZ RecalcContad;
   |FINSI;

   |CIERRA #2;
   |CIERRA #12;

   |SI #0#6 = "S";
       |DELINDEX #2;
       |DELINDEX #40;
       |DELINDEX #12;
   |FINSI;

   |SUB_EJECUTA_NP "caut0018;PASE";
|FPRO;

|PROCESO GraboAuxtm4;
   |ABRE #caivatm4;
   #caivatm4#0 = 0;
   #caivatm4#1 = 0;
   #caivatm4#2 = #2#13;
   #caivatm4#3 = #2#14;
   #caivatm4#4 = #2#17;
   #caivatm4#5 = aFactuan;
   |LEE 041#caivatm4.=;
   |SI FSalida ! 0;
       #caivatm4#0 = 0;
       #caivatm4#1 = 0;
       #caivatm4#2 = #2#13;
       #caivatm4#3 = #2#14;
       #caivatm4#4 = #2#17;
       #caivatm4#5 = aFactuan;
       #caivatm4#6 = aReferencia;
       |GRABA 020#caivatm4.n;
   |FINSI;
   |LIBERA #caivatm4;
   |CIERRA #caivatm4;
|FPRC;

|PROCESO b_apuntes;
     |CIERRA #1;
     |CIERRA #2;
     |PATH_DAT #2 dir_fich1;
     |PATH_DAT #40 dir_fich1;

     ||EMpiezo a pasar el fichero de apuntes
     fichero = #0#3;     ||empresa origen
     fichero = "000000" + fichero;
     fichero = fichero % -104;
     |SI aParam = "LAPIZ"; |Y eaFitxer ! ""; fichero = eaFitxer; |FINSI;

     fichero1 = "enco" + fichero; |QBF fichero1; |NOME_DAT #2 fichero1;
     fichero1 = "eniv" + fichero; |QBF fichero1; |NOME_DAT #40 fichero1;

     |ABRE #2;
     |LEE 001#2p;   ||miro si existe algo para saber que lo he encontrado
     |SI FSalida!0;
          |MENAV "0000No se ha encontrado el fichero";
          |ERROR;
          |ACABA;
     |SINO;

          |DFICE empresa1;
          |QBF empresa1;
          empresa1 = empresa1 % -206;
          |SI #2#45 ! 0; |Y #2#45 < 1000;
              empresao = #2#45;
              periodoo = #2#46;
              empresa2 = "000000" + empresao + periodoo;
              empresa2 = empresa2 % -106;
              |SI empresa2 ! empresa1;
                  mensaje = "0000NLa empresa Contable destino ha de ser la : " + empresao + "/" + periodoo + ". Continuar S/N";
                  |CONFI mensaje;
                  |SI FSalida ! 0;
                      |ERROR;
                      |ACABA;   ||si no encuentro la empresa, no sigo, puesto que no
                  |SINO;        ||se pasara nada si no hay asientos
                      empresao = empresa1 % 105;
                      periodoo = empresa1 % 601;
                      empresa2 = empresa1;
                      #2#45 = empresao;
                      #2#46 = periodoo;
                  |FINSI;
              |FINSI;
          |SINO;
              empresao = empresa1 % 105;
              periodoo = empresa1 % 601;
              empresa2 = empresa1;
              #2#45 = empresao;
              #2#46 = periodoo;
          |FINSI;
     |FINSI;

     |ABRE #8;
     #8#0 = #2#14;
     |LEE 001#8=;
     |SI FSalida = 0;
          librodesc = #8#1;
     |SINO;
          #8#1 = "LIBRO INEXISTENTE";
          librodesc = #8#1;
          |GRABA 001#8n;
          |LIBERA #8;
     |FINSI;
     |CIERRA #8;

     |ABRE #9;
     #9#0 = #2#18;
     |LEE 001#9=;
     |SI FSalida = 0;
          librodescc = #9#1;
     |SINO;
          #9#1 = "INEXISTENTE";
          |GRABA 011#9n;
          |LIBERA #9;
     |FINSI;

     |ABRE #3;      ||asientos cab
     |ABRE #4;      ||lineas cabs
     |ABRE #5;      ||iva rep
     |ABRE #6;      ||iva sop
     |DELINDEX #33;

     |ABRE #33;     ||Cambio N§ Factura.....
     feini = "00.00.0000";
     fefin = "31.12.9999";
     |BUCLE asiento1;    ||Grabo los numeros de asiento en fichero de enlace

     control1 = 999;
     feini = "00.00.0000";
     fefin = "31.12.9999";
     |BUCLE asiento;     ||Grabo los asientos e ivas

     |BUCLE encoiva;

     |LIBERA #2;
     |LIBERA #3;
     |LIBERA #4;
     |LIBERA #5;
     |LIBERA #6;
     |CIERRA #3;
     |CIERRA #4;
     |CIERRA #5;
     |CIERRA #2;
     |CIERRA #6;
     |CIERRA #9;
     |CIERRA #33;
|FPRC;

|PROCESO b_cobros;
     ||************************
     ||****ACTUALIZO LOS COBROS
     ||************************

     |CIERRA #12;
     |CIERRA #33;

     |PATH_DAT #12 dir_fich1;
     ||EMpiezo a pasar el fichero de apuntes
     fichero = #0#3;     ||empresa origen
     fichero = "000000" + fichero;
     fichero = fichero % -104;
     fichero1 = "enre" + fichero;
     |QBF fichero1;
     |NOME_DAT #12 fichero1;
     |ABRE #12;
     |LEE 001#12p;   ||miro si existe algo para saber que lo he encontrado
     |SI FSalida!0;
          |MENAV "0000No se ha encontrado el fichero de Enlace de COBROS";
     |SINO;
          |ABRE #13;
          |ABRE #14;
          |ABRE #15;
          |ABRE #33;
          |BUCLE cobros;
          |CIERRA #13;
          |CIERRA #14;
          |CIERRA #15;
          |CIERRA #33;
          |DELINDEX #33;
     |FINSI;
     |CIERRA #12;
|FPRC;

|PROCESO mira;|TIPO 0;        ||miro que exista el registro en el control
     |ABRE #1;                ||de importacines
     #1#0=#0#1;
     |LEE 001#1=;
     |SI FSalida = 0;
          #0#2 = #1#1;
          |PINTA #0#2;
     |SINO;
          |MENAV "0000No Existe el Control Path Importaciones";
          |ERROR;
     |FINSI;
     |CIERRA #1;
|FPRC;

|PROCESO cuentas;
|ABRE #11;
|QBF cuenta;
#11#0 = cuenta;
#11#1 = nivel;
|LEE 001#11=;
|SI FSalida = 0;
     |LEE 101#11c;       ||Si la cuenta ya existe
     nombre1 = #11#2;    ||nombre de la cuenta
     |SI total = 0; ||si viene de un apunte
          ini = dig1;
          fecalf = fecha;          ||la actualizo
          mes = fecalf % 402;
          mesfec = mes;
          |SI ini = 1;
               mesac = mesfec;
          |SINO;
               mesac = (mesfec - ini) + 1;
               |SI mesac [ 0;
                    mesac = (13 - ini) + mesfec;
               |FINSI;
          |FINSI;
          a = (mesac * 3) + 9;
          b = a + 1;
          c1 = a + 2;
          |SI #4#8 = "D";
               #11a = #11a + #4#9;
               #11#51 = #11#51 + #4#9;
          |SINO;
               #11b = #11b + #4#9;
               #11#52 = #11#52 + #4#9;
          |FINSI;
          #11c1 = #11a - #11b;
          #11#53 = #11#51 - #11#52;
          |GRABA 011#11a;
          |LIBERA #11;
     |FINSI;
|SINO;         ||Si la cuenta no existe, busco la anterior para saber a que
     ok =0;    ||Epigrafe ...... pertenece
     lon = cuenta % 0;
     |SI dig4 = lon; ok = 1; niv = 1; lon1 = dig4; |FINSI;
     |SI dig5 = lon; ok = 1; niv = 2; lon1 = dig4; |FINSI;
     |SI dig6 = lon; ok = 1; niv = 3; lon1 = dig5; |FINSI;
     |SI dig7 = lon; ok = 1; niv = 4; lon1 = dig6; |FINSI;
     |SI dig8 = lon; ok = 1; niv = 5; lon1 = dig7; |FINSI;
     |SI dig9 = lon; ok = 1; niv = 6; lon1 = dig8; |FINSI;
     |SI ok = 1;
          |PARA ; |SI FSalida !0; |Y niv > 0; |HACIENDO ;
               niv = niv - 1;||Le quito un nivel,para mirar la cuenta anterior
               |SI niv = 1; lon1 = dig4; |FINSI;
               |SI niv = 2; lon1 = dig5; |FINSI;
               |SI niv = 3; lon1 = dig6; |FINSI;
               |SI niv = 4; lon1 = dig7; |FINSI;
               |SI niv = 5; lon1 = dig8; |FINSI;
                    lon1 = "0000" + lon1;
                    lon1 = lon1 % -102;
                    lon1 = "1"+lon1;
                    cta = cuenta % lon1;
                    |QBF cta;
               #11#0 = cta;
               #11#1 = niv;
               |LEE 001#11=;
          |SIGUE;
               |PARA i = 9; |SI i [ 53; |HACIENDO i = i + 1;
                    #11i = 0;
               |SIGUE;
               |SI total = 0;
                    |SI FSalida =0; |O niv = 1;
                         ini = dig1;         ||Actualizo la cuenta
                         fecalf = fecha;
                         mes = fecalf % 402;
                         mesfec = mes;
                         |SI ini = 1;
                              mesac = mesfec;
                         |SINO;
                              mesac = (mesfec - ini) + 1;
                              |SI mesac [ 0;
                                   mesac = (13 - ini) + mesfec;
                              |FINSI;
                         |FINSI;
                         a = (mesac * 3) + 9;
                         b = a + 1;
                         c1 = a + 2;
                         |SI #4#8 = "D";
                              #11a = #11a + #4#9;
                              #11#51 = #11#51 + #4#9;
                         |SINO;
                              #11b = #11b + #4#9;
                              #11#52 = #11#52 + #4#9;
                         |FINSI;
                         #11c1 = #11a - #11b;
                         #11#53 = #11#51 - #11#52;

                    |FINSI;
               |FINSI;

               #11#0 = cuenta;
               #11#1 = nivel;
               #11#3 = "S";
               cuentaz = cuenta + "zzzzzzzzzzzzzzzzzzzz";
               cuentaz = cuentaz % 112;
               #11#54 = cuentaz;
               #11#55 = nivel;

               |PUSHV 0501 2380;
               |PINPA #0#11;
               |PINDA #0#11;
               |CONFI "0000SConfirma el alta : ";
               |SI FSalida = 0;
                    |ENDATOS #1#11;
                    |SI FSalida = 0;
                         nombre1 = #11#2;
                         |GRABA 011#11n;          ||Si acepta el darla de alta
                         |LIBERA #11;             ||la grabo
                         #11#0 = cta;
                         #11#1 = niv;
                         |LEE 101#11=;
                         #11#3 = "N";        ||Quito el pase directo de la cuenta
                         |GRABA 011#11a;     ||en donde he mirado a donde pertenecia
                         |LIBERA #11;        ||puesto que ya no es de pase directo
                    |FINSI;
               |FINSI;
     |FINSI;
     |POPV;
|FINSI;
|CIERRA #11;
|FPRC;

|PROCESO clientes;
     nombre = "";
     cif = "";
     |ABRE #16;
     || .... SELECT #2#16; ahora es la primera clave

     #16#23 = "C";
     #16#10 = cuencli;
     #16#11 = nivcli;
     |LEE 001#16=;
     |SI FSalida = 0;
          nombre = #16#1;     ||nombre
          cif = #16#9;        ||cif del cliente
     |SINO;
          #16#23 = "P";
          #16#10 = cuencli;
          #16#11 = nivcli;
          |LEE 001#16=;
          |SI FSalida = 0;
               nombre = #16#1;     ||nombre
               cif = #16#9;        ||cif del cliente
          |SINO;
               nombre = nombre1;   ||nombre de la cuenta
               cif = #2#58;
          |FINSI;
     |FINSI;
     |CIERRA #16;
|FPRC;

|PROCESO Gcaivasof;
  |ABRE #caivasof;
  |DDEFECTO #caivasof;
  #caivasof#0 = #6#0;
  #caivasof#1 = #6#27;
  #caivasof#2 = #6#2;
  |LEE 101#caivasof.=;
  |SI FSalida ! 0;
      #caivasof#0 = #6#0;
      #caivasof#1 = #6#27;
      #caivasof#2 = #6#2;
      |GRABA 020#caivasof.b;
  |FINSI;
  #caivasof#3 = fecha2;
  |GRABA 020#caivasof.a;
  |LIBERA #caivasof;
  |CIERRA #caivasof;
|FPRC;

|PROCESO Gcaivaref;
  |ABRE #caivaref;
  |DDEFECTO #caivaref;
  #caivaref#0 = #5#0;
  #caivaref#1 = #5#27;
  #caivaref#2 = #5#2;
  |LEE 101#caivaref.=;
  |SI FSalida ! 0;
      #caivaref#0 = #5#0;
      #caivaref#1 = #5#27;
      #caivaref#2 = #5#2;
      |GRABA 020#caivaref.b;
  |FINSI;
  #caivaref#3 = fecha2;
  |GRABA 020#caivaref.a;
  |LIBERA #caivaref;
  |CIERRA #caivaref;
|FPRC;

|PROCESO Gcaivafecha;

   alfa1 = #2#15 % 0110; |QBF alfa1;
   alfa2 = alfa1 % 0;
   |SI alfa2 = 10;
       fecha2 = alfa1;
       |SI fecha2 > "01.01.1900";
           |SI #2#13 = "R"; |HAZ Gcaivaref; |FINSI;
           |SI #2#13 = "S"; |HAZ Gcaivasof; |FINSI;
       |FINSI;
   |FINSI;

   aReferencia = #2#15 % 1120; |QBF aReferencia;
|FPRC;

|PROCESO soportado;

     pasar = 0;
     |DDEFECTO #6;
     #6#0 = #2#14;       || libro
     #6#27 = #2#17;      || serie
     |SI #0#10 = "S";
         |HAZ ultimas;
         #6#2 = i_factu; || factura renumerada
     |SINO;
         #6#2 = #2#16;   || factura original
         |HAZ guardas;
     |FINSI;
     aReferencia = "";
     aFactuan = #6#2;
     |HAZ guafa;
     ren_fra = #6#2;     || lo guarda para rectificar la relacion con apuntes
     |LEE 001#6=;
     |SI FSalida ! 0;
          #6#27 = #2#17;      ||Serie
          #6#1 = librodesc;  ||descripcion libro
          #6#3 = #2#41;  ||Fecha factura
          #6#4 = #2#20;  ||Cuenta iva
          #6#5 = #2#21;  ||digito cuenta
          cuenta = #6#4;
          nivel = #6#5;
          total = 1;
          |HAZ cuentas;
          #6#6 = #2#18;  ||concepto iva
          ||#6#7 = librodescc;  ||DEscripcion concepto
          #6#7 = #2#19;  ||DEscripcion concepto LA MISMA QUE EL APUNTE!!!
          #6#8 = #2#22;  ||Base 1 COns
          #6#9 = #2#23;  ||Base 2 red
          #6#10 = #2#24; ||Base 3 lujo
          #6#52 = #2#48; ||Base 4
          #6#53 = #2#49; ||Base 5
          #6#11 = #2#25; ||% Iva 1
          #6#12 = #2#26; ||% Iva 2
          #6#13 = #2#27; ||% Iva 3
          #6#54 = #2#50; ||% Iva 4
          #6#55 = #2#51; ||% Iva 5
          #6#14 = #2#28; ||Cuota iva 1
          #6#15 = #2#29; ||Cuota iva 2
          #6#16 = #2#30; ||Cuota iva 3
          #6#56 = #2#52; ||Cuota iva 4
          #6#57 = #2#53; ||Cuota iva 5
          #6#17 = #2#31; ||% Rec 1
          #6#18 = #2#32; ||% Rec 2
          #6#19 = #2#33; ||% Rec 3
          #6#58 = #2#54; ||% Rec 4
          #6#59 = #2#55; ||% Rec 5
          #6#20 = #2#34; ||Cuota Rec 1
          #6#21 = #2#35; ||Cuota Rec 2
          #6#22 = #2#36; ||Cuota Rec 3
          #6#60 = #2#56; ||Cuota Rec 4
          #6#61 = #2#57; ||Cuota Rec 5
          #6#23 = #2#39; ||deducible
          #6#26 = #2#37; ||Total factura
          #6#44 = #2#44; ||Periodo
          #6#45 = #2#0;  ||diario asiento
          #6#46 = #2#1;  ||Fecha asiento
          #6#47 = #2#47; ||documento asiento
          #6#48 = #2#38; ||inversion
          #6#49 = #2#40; ||departamento
          cuencli = #6#4;
          nivcli = #6#5;
          |HAZ clientes;
          #6#50 = nombre;
          #6#51 = cif;
          |GRABA 001#6n;
          |LIBERA #6;
          |HAZ Gcaivafecha;
     |SINO;
          mensaje = "0000Factura No: " + #6#2 + " Existente";
          |MENAV mensaje;
          pasar = 1;               ||Pasar = 1 lo mismo que en el iva
          dia = #2#0;    ||Repercutido
          docu = #2#2;
          fech = #2#1;
          #2#4 = 1;
          |LEE 101#2];
          |PARA ; |SI FSalida = 0;
                  |Y #2#0 = dia;
                  |Y #2#1 = fech;
                  |Y #2#2 = docu;
                  |Y #2#4 >0;
                       |HACIENDO;
               #2#42 = "";    ||Tipo Acumulador
               #2#43 = 0;     ||Acumulador
               |GRABA 001#2a;
               |LIBERA #2;
               |LEE 101#2s;
          |SIGUE;
          dia = #2#0;    ||con lo que en las lineas de apuntes
          docu = #2#2;   ||no se grabaran los datos del IVA
          fech = #2#1;
          #2#4 = nEstaLinea;
          |LEE 101#2=;
     |FINSI;
|FPRC;

|PROCESO repercutido;

     pasar = 0;
     |DDEFECTO #5;
     #5#0 = #2#14;       || libro
     #5#27 = #2#17;      || serie
     |SI #0#10 = "S";
         |HAZ ultimaf;
         #5#2 = i_factu; || factura renumerada
     |SINO;
         #5#2 = #2#16;   || factura original
         |HAZ guardaf;
     |FINSI;
     aReferencia = "";
     aFactuan = #5#2;
     |HAZ guafa;
     ren_fra = #5#2;     || lo guarda para rectificar la relacion con apuntes
     |LEE 001#5=;
     |SI FSalida ! 0;
          #5#1 = librodesc;  ||descripcion libro
          #5#3 = #2#41;  ||Fecha factura
          #5#4 = #2#20;  ||Cuenta iva
          #5#5 = #2#21;  ||digito cuenta
          cuenta = #5#4;
          nivel = #5#5;
          total = 1;
          |HAZ cuentas;
          #5#6 = #2#18;  ||concepto iva
          ||#5#7 = librodescc;  ||DEscripcion concepto
          #5#7 = #2#19;  ||DEscripcion concepto LA MISMA QUE EL APUNTE!!!
          #5#8 = #2#22;  ||Base 1 COns
          #5#9 = #2#23;  ||Base 2 red
          #5#10 = #2#24; ||Base 3 lujo
          #5#52 = #2#48; ||Base 4
          #5#53 = #2#49; ||Base 5
          #5#11 = #2#25; ||% Iva 1
          #5#12 = #2#26; ||% Iva 2
          #5#13 = #2#27; ||% Iva 3
          #5#54 = #2#50; ||% Iva 4
          #5#55 = #2#51; ||% Iva 5
          #5#14 = #2#28; ||Cuota iva 1
          #5#15 = #2#29; ||Cuota iva 2
          #5#16 = #2#30; ||Cuota iva 3
          #5#56 = #2#52; ||Cuota iva 4
          #5#57 = #2#53; ||Cuota iva 5
          #5#17 = #2#31; ||% Rec 1
          #5#18 = #2#32; ||% Rec 2
          #5#19 = #2#33; ||% Rec 3
          #5#58 = #2#54; ||% Rec 4
          #5#59 = #2#55; ||% Rec 5
          #5#20 = #2#34; ||Cuota Rec 1
          #5#21 = #2#35; ||Cuota Rec 2
          #5#22 = #2#36; ||Cuota Rec 3
          #5#60 = #2#56; ||Cuota Rec 4
          #5#61 = #2#57; ||Cuota Rec 5
          #5#23 = #2#39; ||deducible
          #5#26 = #2#37; ||Total factura
          #5#44 = #2#44; ||Periodo
          #5#45 = #2#0;  ||diario asiento
          #5#46 = #2#1;  ||Fecha asiento
          #5#47 = #2#47; ||documento asiento
          #5#48 = #2#38; ||inversion
          #5#49 = #2#40; ||departamento
          cuencli = #5#4;
          nivcli = #5#5;
          |HAZ clientes;
          #5#50 = nombre;
          #5#51 = cif;
          |GRABA 001#5n;
          |LIBERA #5;
          |HAZ Gcaivafecha;
     |SINO;
          mensaje = "0000Factura No: " + #5#2 + " Existente";
          |MENAV mensaje;
          pasar = 1;     ||Si la factura existe, pasar vale 1,
          dia = #2#0;    ||con lo que en las lineas de apuntes
          docu = #2#2;   ||no se grabaran los datos del IVA
          fech = #2#1;
          #2#4 = 1;
          |LEE 101#2];
          |PARA ; |SI FSalida = 0;
                  |Y #2#0 = dia;
                  |Y #2#1 = fech;
                  |Y #2#2 = docu;
                  |Y #2#4 >0;
                       |HACIENDO;
               #2#42 = "";    ||Tipo Acumulador
               #2#43 = 0;     ||Acumulador
               |GRABA 001#2a;
               |LIBERA #2;    ||Elimino parte de los datos del IVA
               |LEE 101#2s;
          |SIGUE;
          dia = #2#0;    ||con lo que en las lineas de apuntes
          docu = #2#2;   ||no se grabaran los datos del IVA
          fech = #2#1;
          #2#4 = nEstaLinea;
          |LEE 101#2=;
     |FINSI;
|FPRC;

|PROCESO grabadiario;
          |ABRE #7;
          #7#0 = #3#0;
          |LEE 101#7=;        ||Grabo en el diario
          |SI FSalida = 0;
               #7#2 = #7#2 + #3#4; ||total debe
               #7#3 = #7#3 + #3#5; ||total haber
               |GRABA 001#7a;
               |LIBERA #7;
          |SINO;
               #7#1 = "INEXISTENTE";
               #7#2 = #3#4;
               #7#3 = #3#5;        ||Si el diario no existe lo doy de alta
               |GRABA 001#7n;
               |LIBERA #7;
          |FINSI;
          |CIERRA #7;
|FPRC;

|PROCESO guardaf;
   |SI #caivaasi#44 = "N";
      |ABRE #calibros;
      #calibros#0 = #caivarep#0;
      |LEE 101#calibros.=;
      |SI FSalida = 0;
         i_factu = #calibros#4;
         #calibros#4 = #calibros#4 + 1;
         |GRABA 020#calibros.a;
      |SINO;
         |DDEFECTO #calibros;
         #calibros#0 = #caivarep#0;
         #calibros#1 = "LIBRO " + (("00" + #caivarep#0) % -102) + " REPERCUTIDO";
         #calibros#2 = "R";
         i_factu = #calibros#4;
         #calibros#4 = #calibros#4 + 1;
         |GRABA 020#calibros.n;
      |FINSI;
      |LIBERA #calibros;
      |CIERRA #calibros;
   |SINO;
      |ABRE #caivases;
      #caivases#0 = #caivarep#27;
      #caivases#1 = "R";
      |LEE 101#caivases.=;
      |SI FSalida = 0;
           |SI #caivases#3 [ #caivarep#2;
                #caivases#3 = #caivarep#2 + 1;
                |GRABA 020#caivases.a;
           |FINSI;
      |SINO;
         |DDEFECTO #caivases;
         #caivases#0 = #caivarep#27;
         #caivases#1 = "R";
         |SI #caivases#3 [ #caivarep#2;
            #caivases#3 = #caivarep#2 + 1;
         |FINSI;
         |GRABA 020#caivases.n;
      |FINSI;
      |LIBERA #caivases;
      |CIERRA #caivases;
   |FINSI;
|FPRC;

|PROCESO guardas;
   |SI #caivaasi#44 = "N";
      |ABRE #calibros;
      #calibros#0 = #caivasop#0;
      |LEE 101#calibros.=;
      |SI FSalida = 0;
         i_factu = #calibros#4;
         #calibros#4 = #calibros#4 + #calibros#3;
         |GRABA 020#calibros.a;
      |SINO;
         |DDEFECTO #calibros;
         #calibros#0 = #caivasop#0;
         #calibros#1 = "LIBRO " + (("00" + #caivasop#0) % -102) + " SOPORTADO";
         #calibros#2 = "S";
         i_factu = #calibros#4;
         #calibros#4 = #calibros#4 + #calibros#3;
         |GRABA 020#calibros.n;
      |FINSI;
      |LIBERA #calibros;
      |CIERRA #calibros;
   |SINO;
      |ABRE #caivases;
      #caivases#0 = #caivasop#27;
      #caivases#1 = "S";
      |LEE 101#caivases.=;
      |SI FSalida = 0;
         |SI #caivases#3 [ #caivasop#2;
            #caivases#3 = #caivasop#2 + #caivases#4;
            |GRABA 020#caivases.a;
         |FINSI;
      |SINO;
         |DDEFECTO #caivases;
         #caivases#0 = #caivasop#27;
         #caivases#1 = "S";
         |SI #caivases#3 [ #caivasop#2;
            #caivases#3 = #caivasop#2 + #caivases#4;
         |FINSI;
         |GRABA 020#caivases.n;
      |FINSI;
      |LIBERA #caivases;
      |CIERRA #caivases;
   |FINSI;
|FPRC;

|PROCESO ultimaf;
   |SI #caivaasi#44 = "N";
      |ABRE #calibros;
      #calibros#0 = #caivarep#0;
      |LEE 101#calibros.=;
      |SI FSalida = 0;
         i_factu = #calibros#4;
         #calibros#4 = #calibros#4 + 1;
         |GRABA 020#calibros.a;
      |SINO;
         |DDEFECTO #calibros;
         #calibros#0 = #caivarep#0;
         #calibros#1 = "LIBRO " + (("00" + #caivarep#0) % -102) + " REPERCUTIDO";
         #calibros#2 = "R";
         i_factu = #calibros#4;
         #calibros#4 = #calibros#4 + 1;
         |GRABA 020#calibros.n;
      |FINSI;
      |LIBERA #calibros;
      |CIERRA #calibros;
   |SINO;
      |ABRE #caivases;
      #caivases#0 = #caivarep#27;
      #caivases#1 = "R";
      |LEE 101#caivases.=;
      |SI FSalida = 0;
         i_factu = #caivases#3;
         #caivases#3 = #caivases#3 + #caivases#4;
         |GRABA 020#caivases.a;
      |SINO;
         |DDEFECTO #caivases;
         #caivases#0 = #caivarep#27;
         #caivases#1 = "R";
         i_factu = #caivases#3;
         #caivases#3 = #caivases#3 + #caivases#4;
         |GRABA 020#caivases.n;
      |FINSI;
      |LIBERA #caivases;
      |CIERRA #caivases;
   |FINSI;
|FPRC;

|PROCESO ultimas;
   |SI #caivaasi#44 = "N";
      |ABRE #calibros;
      #calibros#0 = #caivasop#0;
      |LEE 101#calibros.=;
      |SI FSalida = 0;
         i_factu = #calibros#4;
         #calibros#4 = #calibros#4 + #calibros#3;
         |GRABA 020#calibros.a;
      |SINO;
         |DDEFECTO #calibros;
         #calibros#0 = #caivarep#0;
         #calibros#1 = "LIBRO " + (("00" + #caivasop#0) % -102) + " SOPORTADO";
         #calibros#2 = "S";
         i_factu = #calibros#4;
         #calibros#4 = #calibros#4 + #calibros#3;
         |GRABA 020#calibros.n;
      |FINSI;
      |LIBERA #calibros;
      |CIERRA #calibros;
   |SINO;
      |ABRE #caivases;
      #caivases#0 = #caivasop#27;
      #caivases#1 = "S";
      |LEE 101#caivases.=;
      |SI FSalida = 0;
           i_factu = #caivases#3;
           #caivases#3 = #caivases#3 + #caivases#4;
           |GRABA 020#caivases.a;
      |SINO;
         |DDEFECTO #caivases;
         #caivases#0 = #caivasop#27;
         #caivases#1 = "S";
         i_factu = #caivases#3;
         #caivases#3 = #caivases#3 + #caivases#4;
         |GRABA 020#caivases.n;
      |FINSI;
      |LIBERA #caivases;
      |CIERRA #caivases;
   |FINSI;
|FPRC;


|PROCESO guafa;
     #33#0 = #2#16;
     #33#4 = #2#17;
     |LEE 101#33=;
     nSal = FSalida;
     #33#0 = #2#16;
     #33#4 = #2#17;
     #33#1 = aFactuan;
     #33#2 = #2#18;  ||concepto iva
     aAlfa = #2#10; |QBF aAlfa;
     |SI PRMNT_enSole = 0; |O aAlfa = "";
        #33#3 = #2#19;  ||Descripcion concepto LA MISMA QUE EL APUNTE!!!
     |SINO;
        #33#3 = #2#10;  ||Descripcion concepto LA MISMA QUE EL APUNTE SIN EL PROVEEDOR!!!
     |FINSI;
     |SI nSal = 0; |GRABA 020#33a; |FINSI;
     |SI nSal ! 0; |GRABA 020#33n; |FINSI;
     |LIBERA #33;
|FPRC;

|PROCESO leefa;
     #33#0 = #12#1;
     #33#4 = #12#2;
     |LEE 101#33=;
     |SI FSalida ! 0;
          aFactuan = #12#1;
     |SINO;
          aFactuan = #33#1;
     |FINSI;
     |LIBERA #33;
|FPRC;
