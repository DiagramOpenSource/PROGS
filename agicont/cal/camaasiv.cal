|FICHEROS;
  camaasiv #0;
  caivarep #1;
  caivaasi #2;
  caivases #3;
  calibros #4;

  caivarea #11;
  caivasea #13;

  casieali #12;
  casieal@ #912;
|FIN;

|VARIABLES;
    &entrada  = 1;
    &ext1     = "";          || fecha
    &ext2     = "";          || libro
    &ext3     = "";          || FSalida
    &ext4     = "";          || serie       (ESTA INHIBIDA!!!, NO SE PIDE)
    &ext5     = "";          || factura
    &extf     = @;           || fecha Operacion
    &ext13    = 0;
    &eaNSerie = "";
    SerieAnt  = "  XX";
    ComodNum  = 0;
    Comodin   = "";
    FEstado   = 0;
    Calc      = 0;
    inkey     = 0;
    aAlfa1    = "";
    aAlfa2    = "";
    aAlfa4    = "";
    nAntes    = 0;
    nNume1    = 0;
    nNume2    = 0;
    nPara1    = 0;
    nPara2    = 0;
    nError    = 0;
    aParApte  = "";
    nSumaIVA  = 0;
    nHayRec   = 0;
    aMas      = "";
    aDef      = "";
 &EURO = 1;
 &EURODB = 0;
 &EURODV = 0;
 &EUROTEXTO = "Cambio de Moneda";
 &swOperacion = 0;  || 0 = Lectura / 1 = Alta
 &enEmpresa = 0;
 &enPeriodo = 0;
 &eaMoneda  = "";
|FIN;

|INCLUYE vardep_i;
|INCLUYE varnue_i;

|PROCESO Tipo12; |TIPO 12;
|FPRC;

|PROCESO LeoEspejo;
  aAlfa4 = #912#56; aAlfa4 = aAlfa4  > " ";

  |SI aAlfa4 = "I"; |O aAlfa4 = "R";
      nSumaIVA = nSumaIVA + #912#60;
      |SI aAlfa4 = "R"; nHayRec = 1; |FINSI;
  |FINSI;
|FPRC;

|DEFBUCLE LeoEspejo;
 #912#1002;
 ;
 ext13, 01;
 ext13, 99;
 e;
 NULL, LeoEspejo;
|FIN;

|PROCESO MiroEspejo;
  nSumaIVA = 0;
  nHayRec  = 0;
  |BUCLE LeoEspejo;
  |SI nHayRec = 1; |O nSumaIVA = nNume2;
      aAlfa2 = "";
  |FINSI;
|FPRC;

|PROCESO CambioNumero;

      |SI nAntes = 0;
          |SI nNume1 = 18;  |O nNume1 = 1.18; |O nNume1 = 0.18; aAlfa2 = "18%";  nNume2 = 18;  |FINSI;
          |SI nNume1 =  8;  |O nNume1 = 1.08; |O nNume1 = 0.08; aAlfa2 = "8%";   nNume2 = 8;   |FINSI;
          |SI nNume1 = 10;  |O nNume1 = 1.10; |O nNume1 = 0.10; aAlfa2 = "10%";  nNume2 = 10;  |FINSI;
          |SI nNume1 = 8.5; |O nNume1 = 0.85;                   aAlfa2 = "8.5%"; nNume2 = 8.5; |FINSI;

          |SI nNume1 = 21;  |O nNume1 = 1.21; |O nNume1 = 0.21; aAlfa2 = "21%";   nNume2 = 21;  |FINSI;
          |SI nNume1 = 10.5;|O nNume1 = 1.05;                   aAlfa2 = "10.5%"; nNume2 = 10.5;|FINSI;

      |FINSI;

      |SI nAntes = 1;
          |SI nNume1 = 16;  |O nNume1 = 1.16; |O nNume1 = 0.16; aAlfa2 = "16%";  nNume2 = 16;  |FINSI;
          |SI nNume1 =  7;  |O nNume1 = 1.07; |O nNume1 = 0.07; aAlfa2 = "7%";   nNume2 = 7;   |FINSI;
          |SI nNume1 =  9;  |O nNume1 = 1.09; |O nNume1 = 0.09; aAlfa2 = "9%";   nNume2 = 9;   |FINSI;
          |SI nNume1 = 7.5; |O nNume1 = 0.75;                   aAlfa2 = "7.5%"; nNume2 = 7.5; |FINSI;

          |SI nNume1 = 21;  |O nNume1 = 1.21; |O nNume1 = 0.21; aAlfa2 = "21%";   nNume2 = 21;  |FINSI;
          |SI nNume1 = 10.5;|O nNume1 = 1.05;                   aAlfa2 = "10.5%"; nNume2 = 10.5;|FINSI;
      |FINSI;

      |SI nAntes = 2;
          |SI nNume1 = 18;  |O nNume1 = 1.18; |O nNume1 = 0.18; aAlfa2 = "18%";  nNume2 = 18;  |FINSI;
          |SI nNume1 =  8;  |O nNume1 = 1.08; |O nNume1 = 0.08; aAlfa2 = "8%";   nNume2 = 8;   |FINSI;
          |SI nNume1 = 8.5; |O nNume1 = 0.85;                   aAlfa2 = "8.5%"; nNume2 = 8.5; |FINSI;

          |SI nNume1 = 16;  |O nNume1 = 1.16; |O nNume1 = 0.16; aAlfa2 = "16%";  nNume2 = 16;  |FINSI;
          |SI nNume1 =  7;  |O nNume1 = 1.07; |O nNume1 = 0.07; aAlfa2 = "7%";   nNume2 = 7;   |FINSI;
          |SI nNume1 =  9;  |O nNume1 = 1.09; |O nNume1 = 0.09; aAlfa2 = "9%";   nNume2 = 9;   |FINSI;
          |SI nNume1 = 7.5; |O nNume1 = 0.75;                   aAlfa2 = "7.5%"; nNume2 = 7.5; |FINSI;
      |FINSI;
|FPRC;

|PROCESO CambioNumeroR;

      |SI nAntes ! 2;
          |SI nNume1 = 5.20; |O nNume1 = 1.52; |O nNume1 = 0.52; aAlfa2 = "5.20%";  nNume2 = 5.20;  |FINSI;
          |SI nNume1 = 1.40; |O nNume1 = 1.14; |O nNume1 = 0.14; aAlfa2 = "1.40%";  nNume2 = 1.40;  |FINSI;
      |FINSI;

      |SI nAntes = 2;
          |SI nNume1 = 4;                     |O nNume1 = 0.40; aAlfa2 = "4.00%";  nNume2 = 4.00;  |FINSI;
          |SI nNume1 = 1;   |O nNume1 = 1.10; |O nNume1 = 0.10; aAlfa2 = "1.00%";  nNume2 = 1;     |FINSI;
      |FINSI;
|FPRC;

|PROCESO LeoPredefinidos;
  aParApte = #12#56; aParApte = aParApte  > " ";

  |SI #12#60 ! 0; |Y aParApte = "I";
      nNume1 = #12#60;
      |HAZ CambioNumero;
  |FINSI;

  |SI #12#60 ! 0; |Y aParApte = "R";
      nNume1 = #12#60;
      |HAZ CambioNumeroR;
  |FINSI;

/*
  |SI aParApte ! "R"; |Y aParApte ! "P"; |Y aParApte ! "D"; |Y aParApte ! "X";
      |SI aAlfa2 = "";
          |SI #12#7 = "A";
              |PARA nPara1 = 48; |SI nPara1 [ 55; |HACIENDO nPara1 = nPara1 + 1;
                    nPara2 = nPara1 - 8;
                    |SI #12nPara2 ! " "; |Y #12nPara2 ! "+"; |Y #12nPara2 ! "-";
                         nNume1 = #12nPara1;
                         |HAZ CambioNumero;
                         |SI aAlfa2 ! "";
                             |HAZ MiroEspejo;
                             |SI aAlfa2 ! "";
                                 |SAL;
                             |FINSI;
                         |FINSI;
                     |FINSI;
              |SIGUE;
          |FINSI;
      |FINSI;
  |FINSI;

  |SI aParApte = "R";
      |SI aAlfa2 = "";
          |SI #12#7 = "A";
              |PARA nPara1 = 48; |SI nPara1 [ 55; |HACIENDO nPara1 = nPara1 + 1;
                    nPara2 = nPara1 - 8;
                    |SI #12nPara2 ! " "; |Y #12nPara2 ! "+"; |Y #12nPara2 ! "-";
                         nNume1 = #12nPara1;
                         |HAZ CambioNumeroR;
                         |SI aAlfa2 ! "";
                             |HAZ MiroEspejo;
                             |SI aAlfa2 ! "";
                                 |SAL;
                             |FINSI;
                         |FINSI;
                     |FINSI;
              |SIGUE;
          |FINSI;
      |FINSI;
  |FINSI;
*/
  |SI aAlfa2 ! "";  |ERROR10;  |FINSI;
|FPRC;

|DEFBUCLE LeoPredefinidos;
 #12#1;
 ;
 ext13, 01;
 ext13, 99;
 e;
 NULL, LeoPredefinidos;
|FIN;

|CALCULO VerFechas;
  |DBASE aMas; |QBF aMas;
  aDef = aMas + "def/casieali";
  |CARGA_DEF aDef, casieal@;
  |SI FSalida ! 0;
      |ACABA;
  |FINSI;

  nError  = 0;
  nAntes  = 0;
  aAlfa2  = "";
  aAlfa1  = "Fecha Factura ANTERIOR a 01.07.2010 y Asto Predefinido con IVA al ";
  |SI #0#2 ] "01.07.2010"; |Y #0#2 < "01.09.2012";
      aAlfa1  = "Fecha Factura entre 01.07.2010 y 31.08.2012, y Asto Predefinido con IVA al ";
      nAntes  = 1;
  |FINSI;
  |SI #0#2 ] "01.09.2012";
      aAlfa1  = "Fecha Factura POSTERIOR a 01.09.2012 y Asto Predefinido con IVA al ";
      nAntes  = 2;
  |FINSI;

  |BUCLE LeoPredefinidos;
  |SI aAlfa2 ! "";
      aAlfa1 = "    N" + aAlfa1 + aAlfa2 + ". Continuar ";
      |CONFI aAlfa1;
      |SI FSalida ! 0;
          nError = 1;
      |FINSI;
  |FINSI;

  |DESCARGA_DEF #casieal@;
|FCAL;

|PROCESO LaFechaOp;
  inkey = FSalida;

  |SI enEjercicio ] 2010;
      |HAZ VerFechas;
      |SI nError = 1;
          |PTEC 807;
          |ACABA;
      |FINSI;
  |FINSI;

  |C_M #0#4, 1, "N";
  |SI inkey = 11; |O #0#4 ! "01.01.0000";
      |C_M #0#4, 1, "S";
  |FINSI;
|FPRC;

|PROCESO AntesFecha; |TIPO 7;
  |C_M #0#4, 0, aAlfa1;
  |SI aAlfa1 = "N"; |ACABA; |FINSI;

  |SI #0#4 = "01.01.0000";
      #0#4 = #0#2; |PINTA #0#4;
  |FINSI;
|FPRC;

|PROGRAMA;

  |HAZ BuscaModulo;

  |SI PARAMETRO ! "";
      Comodin = PARAMETRO; |QBF Comodin;
      ext4 = Comodin;
  |FINSI;

  eaNSerie = "";
  |ABRE #2;
  |LEE 040#2p;
  |SI FSalida = 0;
      |SI #2#25 = "N";  |Y #2#26 = "N";
          |HAZ nolosaques;
          |SI nError = 1; ext3 = "-1"; |FINSI;
          |CIERRA #2;
          |ACABA;
      |SINO;
          |SI #2#26 = "N"; |Y  enEjercicio ] 2010;
              |HAZ VerFechas;
              |SI nError = 1;
                  ext3 = "-1";
                  |ACABA;
              |FINSI;
          |FINSI;
      |FINSI;
  |FINSI;
  |CIERRA #2;

  |SI #2#25 = "N";
      |CAMPO_MODIFICA #0#0,1,"N";
      |CAMPO_MODIFICA #0#1,1,"N";
  |FINSI;
  |SI #2#26 = "N";
      |CAMPO_MODIFICA #0#2,1,"N";
  |FINSI;

  |CABEZA "Iva Repercutido";
  |DDEFECTO #0;

  #0#1 = ext4;

  |PINPA #0#0;
  #0#2 = ext1;         || fecha del asiento por defecto
  |SI #caivaasi#44 = "N";
      |C_M #camaasiv#1,1,"N";
      |HAZ ultima;
      |ABRE #calibros;
      #calibros#0 = ext2;
      |LEE 110#calibros.=;
      |SI FSalida = 0;
          |SI #camaasiv#0 < #calibros#4;
              #camaasiv#0 = #calibros#4;
              #calibros#4 = #calibros#4 + 1;
          |SINO;
              #calibros#4 = #camaasiv#0 + 1;
          |FINSI;
          |GRABA 020#calibros.a;
      |FINSI;
      |LIBERA #calibros;
      |CIERRA #calibros;
  |SINO;
      |SI #1#25 = "S";
          |C_M #camaasiv#1,1,"S";
      |FINSI;
      |HAZ MiraSerie;
  |FINSI;
  |PINDA #0#0;
  |ENDATOS #1#0;
  ext1 = #0#2;         || fecha
  ext3 = FSalida;
  |SI nError = 1; ext3 = "-1"; |FINSI;
  ext4 = #0#1;         || serie  (inhibida)
  ext5 = #0#0;         || factura
  extf = #0#4;

  |SI ext3 ! 0;
     |SI #caivaasi#44 = "N";
||        |HAZ ultima;
        |ABRE #calibros;
        #calibros#0 = ext2;
        |LEE 110#calibros.=;
        |SI FSalida = 0;
           Calc = #camaasiv#0 + 1;
           |SI #calibros#4 = Calc;
              |SI #camaasiv#0 ! 1;
                 #calibros#4 = #camaasiv#0;
              |FINSI;
           |FINSI;
           |GRABA 020#calibros.a;
        |FINSI;
        |LIBERA #calibros;
        |CIERRA #calibros;
     |SINO;
        |ABRE #caivases;
        #caivases#0 = #camaasiv#1;
        |LEE 101#caivases.=;
        |SI FSalida = 0;
          ComodNum = #camaasiv#0 + #caivases#4;
          |SI ComodNum = #caivases#3;
             #caivases#3 = #camaasiv#0;
             |GRABA 020#caivases.a;
          |FINSI;
        |FINSI;
        |LIBERA #caivases;
        |CIERRA #caivases;
     |FINSI;
  |FINSI;
|FPRO;

|PROCESO nolosaques;
  |DDEFECTO #0;
  ext3 = 0;
  #0#1 = ext4;
  ||   ext4 = #0#1;
  |SI enEjercicio ] 2010;
      |HAZ VerFechas;
      |SI nError = 1; |ACABA; |FINSI;
  |FINSI;
  |SI #caivaasi#44 = "N";
     |C_M #camaasiv#1,1,"N";
     |HAZ ultima;
     |ABRE #calibros;
     #calibros#0 = ext2;
     |LEE 110#calibros.=;
     |SI FSalida = 0;
        |SI #camaasiv#0 < #calibros#4;
           #camaasiv#0 = #calibros#4;
           #calibros#4 = #calibros#4 + 1;
        |SINO;
           #calibros#4 = #camaasiv#0 + 1;
        |FINSI;
        |GRABA 020#calibros.a;
     |FINSI;
     |LIBERA #calibros;
     |CIERRA #calibros;
  |SINO;
     |C_M #camaasiv#1,1,"S";
     |HAZ MiraSerie;
  |FINSI;
  ext5 = #0#0;
|FPRC;

|PROCESO ultima; |TIPO 7;
  #0#0 = 1;
  |DDEFECTO #1;
  |ABRE #1;
  #1#0 = ext2;    || libro
  #1#2 = 999999;  || factura
  |LEE 001#1];
  |SI FSalida ! 0;
      |LEE 001#1u;
      |SI FSalida = 0; |Y #1#0 = ext2;
          #0#0 = #1#2 + 1;
      |SINO;
         |SI FSalida ! 0;
            |HAZ anterior;
         |FINSI;
      |FINSI;
  |SINO;
      |HAZ anterior;
  |FINSI;
  |CIERRA #1;
|FPRC;

|PROCESO anterior;
  |LEE 001#1a;
  |SI FSalida = 0;|Y #1#0 = ext2;
      #0#0 = #1#2 + 1;
  |FINSI;
|FPRC;

|PROCESO MiraSerie;

   |SI #caivaasi#44 = "N"; |ACABA; |FINSI;

   |ABRE #caivases;
   #caivases#0 = #camaasiv#1;
   #caivases#1 = "R";
   |LEE 000#caivases.=;
   FEstado = FSalida;
   |CIERRA #caivases;

   |SI FEstado ! 0; |ACABA; |FINSI;

   |SI SerieAnt ! #camaasiv#1;
      |ABRE #caivases;
      |SI SerieAnt ! "  XX";
         #caivases#0 = SerieAnt;
         #caivases#1 = "R";
         |LEE 101#caivases.=;
         |SI FSalida = 0;
            ComodNum = #camaasiv#0 + #caivases#4;
            |SI ComodNum = #caivases#3;
               #caivases#3 = #camaasiv#0;
               |GRABA 020#caivases.a;
            |FINSI;
         |FINSI;
      |FINSI;

      #caivases#0 = #camaasiv#1;
      #caivases#1 = "R";
      |LEE 101#caivases.=;
      |SI FSalida = 0;
         #camaasiv#0 = #caivases#3;
         #caivases#3 = #caivases#3 + #caivases#4;
         |GRABA 020#caivases.a;
      |FINSI;
      |LIBERA #caivases;
      |CIERRA #caivases;
      SerieAnt = #camaasiv#1;
   |FINSI;

   |SI swModulo = 1872;
       |PINTA 1422, "                        ";
       |ABRE #13;
       #13#0 = #camaasiv#1;
       #13#1 = "R";
       |LEE 001#13=;
       |SI FSalida = 0;
           |SI #13#2 = "S";
               |PINTA 1422, "S. Extendida:";
               |PINTA 1436, #13#3;
               eaNSerie = #13#3;
           |FINSI;
       |FINSI;
       |CIERRA #13;
   |FINSI;
|FPRC;

|PROCESO MiraNumero;
   |ABRE #caivarep;
   #caivarep#0 = ext2;
   #caivarep#2 = #camaasiv#0;
   #caivarep#27 = #camaasiv#1;
   |LEE 010#caivarep.=;
   |SI FSalida = 0;
      |MENAV "0400La factura ya existe";
      |ERROR;
   |SINO;
      |SI #camaasiv#0 ! Contenido;
         |ABRE #caivases;
         #caivases#0 = #camaasiv#1;
         #caivases#1 = "R";
         |LEE 110#caivases.=;
         |SI FSalida = 0;
            #caivases#3 = #camaasiv#0 + 1;
            |GRABA 020#caivases.a;
         |FINSI;
         |LIBERA #caivases;
         |CIERRA #caivases;
      |FINSI;
   |FINSI;
   |CIERRA #caivarep;
|FPRC;
