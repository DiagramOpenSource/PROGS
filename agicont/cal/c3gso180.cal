|FICHEROS;
     c3gso180 #0;
     caportad #1;
     canempre #30;
     cat18001 #2;
     cat18002 #11;
     caman115 #20;
     cat18003 #104;

     c3gem180 #900;
     catmp180 #901;
|FIN;

|VARIABLES;

      Moneda = "";
      Cantidad = 0;

      nCalc       = 0;
      nHandle2    = 0;
      nLong       = 0;
      nPos        = 0;
      nVarCampo1  = 0;
      nVarCampo1T = 0;
      nVarCampo2  = 0;
      nVarCampo2T = 0;
      nSwError    = 0;
      nLeidos     = 0;
      nDesde      = 0;
      nHasta      = 0;
      FEstado     = 0;
      nSwAcumula  = 0;
      nPag        = 0;
      s1          = 0;
      s2          = 0;
      b1          = 0;
      b2          = 0;
      r1          = 0;
      r2          = 0;
      nSwTraba    = 0;
      nYaEsta1    = 0;
      nYaEsta2    = 0;
      nMeses      = 0;
      nCampoBase  = 0;
      nCampoRete  = 0;
      nCampoBase1 = 0;
      nCampoBase2 = 0;
      nCampoRete1 = 0;
      nCampoRete2 = 0;
      nSwBusca    = 0;
      Calc        = 0;
      Calc1       = 0;
      NCar        = 0;
      nAnyo       = 0;

      aCadena     = "";
      aCont       = "";
      aLong       = "";
      aCaracter   = "";
      aFichOrigen = "";
      aFichDestin = "";
      Maneja      = "";
      Maneja1     = "";
      Tipo        = "";
      Comodin     = "";
      Comodin1    = "";
      aEjerc      = "";
      aDirFich    = "";
      aAlfa       = "";
      aDCla       = "";
      aHCla       = "";
      aAlfa1      = "";
      aAlfa2      = "";
      aAlfa3      = "";
      aAlfa4      = "";
      aAbre       = "";
      nume1       = 0;

     &r_emp       = 0;
     &r_per       = 0;
     &clave       = "";
     &tb          = 0;
     &tr          = 0;
     &te          = 0;
     &hoja        = 0;
     &linea       = 0;
     &tothojas    = 0;
     &cp1         = "";
     &cp2         = "";

     MaxOpc     = 0;
     dv         = 0;
     tb2        = 0;
     ttb2        = 0;
     tr2        = 0;
     ttr2        = 0;
     sg         = "";
     fiche = "";
     regis = "";
     blancos = "";
     caden = "";
     unida = "";
     treten = 0;
     tperce = 0;
     dire = "";
     sistem = "";
     SwLaser = 0;

     CampoDni   = "";
     Letra1     = "";
     Letra2     = "";
     Letra3     = "";
     Letra4     = "";
     Letra5     = "";
     Letra6     = "";
     Letra7     = "";
     Letra8     = "";
     Caracter   = "";
     Carac1     = 0;
     Carac2     = 0;
     Carac3     = 0;
     Carac4     = 0;
     Carac5     = 0;
     ModoModi   = "";
     Salir      = 0;
     Opcion     = 0;
     SwLee      = 0;
     NEmpresa   = 0;

     &eaCaminoT = "";
     || &eaTEjer   = "";

     Fichero1   = "";
     FicheroD   = "";
     VAlfa      = "";
     VAlfa1     = "";
     VAlfa2     = "";
     VAlfa3     = "";
     VAlfa4     = "";
     Path        = "";
     Reper       = "";

     Punto01     = 0;
     Punto02     = 0;
     Punto03     = 0;
     Punto04     = 0;
     Punto05     = 0;

     &impreso  = "";
     &sopindi  = "";
     &sopcole  = "";
     &cinta    = "";
     &disco    = "";
     &locali   = "";
     &sf       = "";
     &pp       = 0;

{-1} MGeneral   = "";
     MGeneral1  = "1660";
     MGeneral2  = "1";
     MGeneral3  = "3";
     MGeneral4  = "Creacion  Fichero   ";
     MGeneral5  = "Validar Fichero     ";
     MGeneral6  = "Emision en Laser    ";

     Contador = 0;
     nCont = 0;

     nBoton       = 0;
     nBoton1      = 0;
     nBoton2      = 0;
     nBoton3      = 0;
     nBoton4      = 0;
     nBoton5      = 0;
     nBoton6      = 0;
     nTecla       = 0;

     aF2          = "";
     aF3          = "";
     aF4          = "";
     aF5          = "";
     aF6          = "";
     aF7          = "";
     aTecla       = "";
     aTercera     = "";
     aOrigen      = "";
     aDestino     = "";
     aPathLocal   = "";
     aIPRemoto    = "";
     aDirFic      = "";

     &eaFichDatos    = "";
     &eaFichAuxil    = "";
     &eaFichError    = "";
     &enValidacion   = 0;
     &enError        = 0;
     &eaTipoE        = "";
     &eaTipoR        = "";
     &eaTipoP        = "";
     &eaTipoC        = "";
     &eaTipoA        = "";
     &eaTipoV        = "";
     &eaModoImpre    = "";
     &eaModelos      = "";
     &eaEjer         = "";
     &eaPeriodo      = "";
     &eaVarDni  = "";
     &enCalcCif = 0;

     &eaUnidadBasico = "";
     &eaPathEmision      = "";
     &eaPathLanza        = "";
     &eaPathExplorador   = "";
     &eaPathInternet     = "";
     &eaFicheroPlano     = "";
     &eaOpcion           = "";
     &enErrorPortal      = 0;
     &eaFicheroImpre     = "";
     &eaFicheroSalid     = "";
     &eaFicheroError     = "";
     &eaNomEmpresa       = "";

     nTope1 = 0;
     nTope2 = 0;
     nNume  = 0;
     nSw    = 0;
|FIN;

|INCLUYE acceso_i;
|INCLUYE i_laserc;

|| *************************************************************************
||                        CALCULOS DE PANTALLA
|| *************************************************************************

|| --------------- comprueba desde-hasta empresas ---------------------------

|PROCESO BuscaEmpresa;
     |SI #30#21 = "I"; |ACABA; |FINSI;

     |SI #30#26 ! #0#0;
         nSwError = 3;
         |ACABA;
     |FINSI;

     aDirFich = "";
     |DBASE aDirFich;
     aDirFich = aDirFich + "fich/" + (("00000" + #30#2) % -105) + (("0" + #30#3) % -101) + "/";

     || aqui estaba el path

     || aqui estaba la lectura

     nLeidos = 1;
|FPRC;

|DEFBUCLE canempre_1;
     #30#1;
     ;
     #0#5, nDesde;
     #0#6, nHasta;
     ;
     NULL, BuscaEmpresa;
|FIN;

|PROCESO BucleEmpresa;
     |SI #0#7 > #0#8;
         |MENAV "     ERROR EN INTRODUCCION";
         |ERROR;
         |ACABA;
     |FINSI;

     |SI #0#5 = 0;  |Y #0#6 = 0;  |ACABA;  |FINSI;

     nDesde  = #0#7;
     nHasta  = #0#8;
     nLeidos = 0;
     |BUCLE canempre_1;
     |SI nLeidos = 0;
         |MENAV "    ATENCION SELECCION VACIA";
         |ERROR;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO DesdeHasta;
     |SI #0#6 < #0#5;
         |MENAV "      Error en Introduccion";
         |ERROR;
     |FINSI;
|FPRC;

|| ------------------------------------------------------------------------
|PROCESO ComparaSiglas;
    |QBF aAlfa; aAlfa = aAlfa > " ";
    |SI aAlfa = "AL";  aAlfa = "ALAM ";  |FINSI;
    |SI aAlfa = "AD";  aAlfa = "ALDEA";  |FINSI;
    |SI aAlfa = "AP";  aAlfa = "APTOS";  |FINSI;
    |SI aAlfa = "AR";  aAlfa = "ARRAL";  |FINSI;
    |SI aAlfa = "AY";  aAlfa = "ARRY ";  |FINSI;
    |SI aAlfa = "AV";  aAlfa = "AVDA ";  |FINSI;
    |SI aAlfa = "BJ";  aAlfa = "BJADA";  |FINSI;
    |SI aAlfa = "BR";  aAlfa = "BRANC";  |FINSI;
    |SI aAlfa = "BO";  aAlfa = "BARRO";  |FINSI;
    |SI aAlfa = "BL";  aAlfa = "BLQUE";  |FINSI;
    |SI aAlfa = "CL";  aAlfa = "CALLE";  |FINSI;
    |SI aAlfa = "CJ";  aAlfa = "CLLJA";  |FINSI;
    |SI aAlfa = "CM";  aAlfa = "CMNO ";  |FINSI;
    |SI aAlfa = "CR";  aAlfa = "CTRA ";  |FINSI;
    |SI aAlfa = "CS";  aAlfa = "CSRIO";  |FINSI;
    |SI aAlfa = "CO";  aAlfa = "COL  ";  |FINSI;
    |SI aAlfa = "CN";  aAlfa = "CJTO ";  |FINSI;
    |SI aAlfa = "CT";  aAlfa = "CUSTA";  |FINSI;
    |SI aAlfa = "CH";  aAlfa = "CHLET";  |FINSI;
    |SI aAlfa = "ED";  aAlfa = "EDIFC";  |FINSI;
    |SI aAlfa = "EN";  aAlfa = "ENTD ";  |FINSI;
    |SI aAlfa = "ES";  aAlfa = "ESCAL";  |FINSI;
    |SI aAlfa = "EX";  aAlfa = "EXPLA";  |FINSI;
    |SI aAlfa = "EM";  aAlfa = "EXTRM";  |FINSI;
    |SI aAlfa = "ER";  aAlfa = "EXTRR";  |FINSI;
    |SI aAlfa = "GL";  aAlfa = "GTA  ";  |FINSI;
    |SI aAlfa = "GV";  aAlfa = "G.V. ";  |FINSI;
    |SI aAlfa = "GR";  aAlfa = "GRUPO";  |FINSI;
    |SI aAlfa = "JR";  aAlfa = "JDIN ";  |FINSI;
    |SI aAlfa = "LG";  aAlfa = "LUGAR";  |FINSI;
    |SI aAlfa = "MS";  aAlfa = "MASIA";  |FINSI;
    |SI aAlfa = "MC";  aAlfa = "MERC ";  |FINSI;
    |SI aAlfa = "MT";  aAlfa = "MONTE";  |FINSI;
    |SI aAlfa = "ML";  aAlfa = "MUELL";  |FINSI;
    |SI aAlfa = "PQ";  aAlfa = "PQUE ";  |FINSI;
    |SI aAlfa = "PQ";  aAlfa = "PQUE ";  |FINSI;
    |SI aAlfa = "PD";  aAlfa = "PTDA ";  |FINSI;
    |SI aAlfa = "PJ";  aAlfa = "PSAJE";  |FINSI;
    |SI aAlfa = "PS";  aAlfa = "PASEO";  |FINSI;
    |SI aAlfa = "PZ";  aAlfa = "PLAZA";  |FINSI;
    |SI aAlfa = "PB";  aAlfa = "PBDO ";  |FINSI;
    |SI aAlfa = "PG";  aAlfa = "POLIG";  |FINSI;
    |SI aAlfa = "PR";  aAlfa = "PROL ";  |FINSI;
    |SI aAlfa = "PT";  aAlfa = "PNTE ";  |FINSI;
    |SI aAlfa = "PU";  aAlfa = "PTA  ";  |FINSI;
    |SI aAlfa = "RM";  aAlfa = "RAMAL";  |FINSI;
    |SI aAlfa = "RB";  aAlfa = "RBLA ";  |FINSI;
    |SI aAlfa = "RP";  aAlfa = "RAMPA";  |FINSI;
    |SI aAlfa = "RR";  aAlfa = "RIERA";  |FINSI;
    |SI aAlfa = "RC";  aAlfa = "RCON ";  |FINSI;
    |SI aAlfa = "RD";  aAlfa = "RONDA";  |FINSI;
    |SI aAlfa = "RU";  aAlfa = "RUA  ";  |FINSI;
    |SI aAlfa = "SC";  aAlfa = "SECT ";  |FINSI;
    |SI aAlfa = "SD";  aAlfa = "SENDA";  |FINSI;
    |SI aAlfa = "SB";  aAlfa = "SBIDA";  |FINSI;
    |SI aAlfa = "TO";  aAlfa = "TRRNT";  |FINSI;
    |SI aAlfa = "TR";  aAlfa = "TRVA ";  |FINSI;
    |SI aAlfa = "UR";  aAlfa = "URB  ";  |FINSI;
    |SI aAlfa = "VI";  aAlfa = "VIA  ";  |FINSI;
    |SI aAlfa = "VP";  aAlfa = "VIA  ";  |FINSI;

    |SI aAlfa = "";  aAlfa = "CALLE";  |FINSI;
    aAlfa = (aAlfa + "     ") % 105;
|FPRC;

|PROCESO LetraDni;
     eaVarDni   = CampoDni;
     enCalcCif  = 3;
     |HAZ CalculoDNI;
     CampoDni = eaVarDni;
     CampoDni = ("000000000" + CampoDni) % -109;
|FPRC;

|| ****************************
|| CREACION DE LOS SECUENCIALES
|| ****************************

|PROCESO magnetico9;
     aAlfa1   = caden % 0;
     nume1   = aAlfa1;
     nume1   = 185 - nume1;      || ajusta a 185 posiciones
     blancos = " " * nume1;
     caden   = caden + blancos;
     caden   = Handle + " " + caden;

     |SI enAnyo [ 2011;  |O eaOpcion = "3";
         caden   = caden + &#0#93 + &#0#94;         || caract. final de linea
     |FINSI;

     |FGRABA caden;
     |SI FSalida < 185;|O FSalida > 187;
         aAlfa2 = "    Error grabando secuencial: " + FSalida;
         |MENAV aAlfa2;
     |SINO;
         |SI regis = "1";  treten = treten + 1;  |FINSI;    || total retenedores
         |SI regis = "2";  tperce = tperce + 1;  |FINSI;    || total perceptores
     |FINSI;
     #104#14 = #104#14 + 1;
|FPRC;

|PROCESO magnetico0;     || registro tipo 0 'presentador'

     regis = "0";
     caden = "0";                                || tipo de registro (1)
     caden = caden + "180";                      || modelo 180       (3)
     caden = caden + aEjerc;                     || aEjercicio        (4)
     caden = caden + (("00" + #0#12) % -102);    || delegacion       (2)
     caden = caden + #0#83;                      || nif              (9)
     aAlfa = #0#75; nLongi = 40; |HAZ QuitaComas; #0#75 = aAlfa;
     caden = caden + aAlfa;                      || razon social     (40)
     caden = caden + #0#76;                      || cl               (2)
     caden = caden + (#0#77 % 120);              || calle            (20)
     caden = caden + #0#78;                      || numero           (5)
     caden = caden + "  ";                       || Escalera         (2)
     caden = caden + "  ";                       || Piso             (2)
     caden = caden + "  ";                       || Puerta           (2)
     caden = caden + (("00"  + #0#79) % -102);   || Codigo provincia (2)
     caden = caden + (("000" + #0#80) % -103);   || Codigo poblacion (3)
     caden = caden + (#0#81 % 112);              || municipio        (12)
     caden = caden + "00000";                    || retenedores, lo regraba al final     (5)
     caden = caden + "000000000";                || perceptores, lo regraba al final     (9)
     caden = caden + "D";                        || tipo presentacion (diskette)    (1)
     caden = caden + #0#92;                      || Telefono         (9)
     aAlfa = #0#91; nLongi = 40; |HAZ QuitaComas;
     caden = caden + aAlfa;                      || Persona Contacto (40)
     |HAZ magnetico9;
|FPRC;

|PROCESO magnetico1;     || registro tipo 1 'retenedor'
     regis = "1";
     caden = "1";                                || tipo de registro    (1)
     caden = caden + "180";                      || modelo 180          (3)
     caden = caden + aEjerc;                      || aEjercicio           (4)
     caden = caden + (("00" + #1#18) % -102);    || delegacion          (2)
     CampoDni = #1#13;  |HAZ LetraDni;
     caden = caden + CampoDni;                   || nif                 (9)
     caden = caden + #1#2;                       || razon social        (40)
     aAlfa1 = ("00000000000" + #11#19) % -109;
     caden = caden + aAlfa1;                      || perceptores         (9)
     |SI #11#20 < 0;
         caden = caden + "N";    ttb2 = -#11#20;  ttr2 = -#11#21;
     |SINO;
         caden = caden + " ";    ttb2 = #11#20;   ttr2 = #11#21;
     |FINSI;
     aAlfa1 = ("000000000000000" + ttb2) % -115;
     caden = caden + aAlfa1;                      || retribuciones       (15)
     aAlfa1 = ("000000000000000" + ttr2) % -115;
     caden = caden + aAlfa1;                      || retenciones         (15)
     |SI #11#22 < 0;
         caden = caden + "N";    nume1 = -#11#22;
     |SINO;
         caden = caden + " ";    nume1 = #11#22;
     |FINSI;
     aAlfa1 = ("000000000000000" + nume1) % -115;
     caden = caden + aAlfa1;                      || retrib.en especie   (15)
     aAlfa1 = ("000000000000000" + #11#23) % -115;
     caden = caden + aAlfa1;                      || ingresos a cuenta   (15)
     caden = caden + "D";                        || tipo presentacion (diskette)

     |SI #0#70 ! "C";
         caden = caden + #0#92;                  || Telefono
         caden = caden + #0#91;                  || Persona Contacto
     |FINSI;

     Punto01 = Punto01 + #11#19;
     Punto02 = Punto02 + #11#20;
     Punto03 = Punto03 + #11#21;
     Punto04 = Punto04 + #11#22;
     Punto05 = Punto05 + #11#23;

     |HAZ magnetico9;
|FPRC;

|PROCESO magnetico2;     || registro tipo 2 'perceptor'
     regis = "2";
     caden = "2";                                    || tipo de registro (1)
     caden = caden + "180";                          || modelo 180       (3)
     caden = caden + aEjerc;                          || aEjercicio        (4)
     caden = caden + (("00" + #1#16) % -102);        || delegacion       (2)
     CampoDni = #1#13;  |HAZ LetraDni;
     caden = caden + CampoDni;                       || nif retenedor    (9)
     |SI clave = "1";  clave = "A";  |FINSI;
     |SI clave = "2";  clave = "B";  |FINSI;
     caden = caden + clave;                          || clave perceptora (1)
     CampoDni = #2#7;  |HAZ LetraDni;
     caden = caden + CampoDni;                       || nif perceptor    (9)
     caden = caden + #2#133;                         || Representante    (1)
     aAlfa = #2#3; nLongi = 40; |HAZ QuitaComas;
     caden = caden + aAlfa;                           || apellidos,nombre (40)

     |SI #2#5 = 99;      || con 99 reside en el extranjero
         aAlfa1 = ("00"  + #2#5) % -102;
         aAlfa2 = ("000" + #2#6) % -103;
     |SINO;
         aAlfa1 = ("00"  + #2#5) % -102;
         aAlfa2 = "000";
     |FINSI;
     caden = caden + aAlfa1 + aAlfa2;                  || codigo postal    (5)

     |SI tb ] 0;
         sg  = " ";  tb2 = tb;   tr2 = tr;
     |SINO;
         sg  = "N";  tb2 = -tb;  tr2 = -tr;
     |FINSI;
     caden = caden + sg;                             || signo (1)
     aAlfa1 = ("000000000000000" + tb2) % -115;
     caden = caden + aAlfa1;                          || retribuciones    (15)
     aAlfa1 = ("000000000000000" + tr2) % -115;
     caden = caden + aAlfa1;                          || retencion   (15)
     caden = caden + "0000";                         || aEjercicio devengo (4)

     |HAZ magnetico9;
|FPRC;

|PROCESO magnetico2009;

     |SI enAnyo < 2014;
         aAlfa1   = caden % 0;
         nume1   = aAlfa1;
         nume1   = 250 - nume1;      || ajusta a 250 posiciones
         blancos = " " * nume1;
         caden   = caden + blancos;
         caden   = Handle + " " + caden;
     |FINSI;

     |SI enAnyo ] 2014;          || sumamos 250
         aAlfa1   = caden % 0;
         nume1   = aAlfa1;
         nume1   = 250 - nume1;      || ajusta a 250 posiciones
         |SI nSw = 0;
             blancos = " " * nume1;
             caden   = caden + blancos;
             caden   = Handle + " " + caden;
             |FGRABA caden;

             blancos = " " * 250;
             caden   = Handle + " " + blancos;
         |SINO;
             blancos = " " * 173;
             caden   = Handle + " " + blancos;
         |FINSI;
     |FINSI;

     |SI enAnyo [ 2011;  |O eaOpcion = "3";
         caden   = caden + &#0#93 + &#0#94;         || caract. final de linea
     |FINSI;

     |FGRABA caden;
     |SI FSalida ! 250;|Y FSalida ! 252; |Y nSw ! 1;
         aAlfa2 = "    Error grabando secuencial: " + FSalida;
         |MENAV aAlfa2;
     |SINO;
         |SI regis = "1";  treten = treten + 1;  |FINSI;    || total retenedores
         |SI regis = "2";  tperce = tperce + 1;  |FINSI;    || total perceptores
     |FINSI;
     #104#14 = #104#14 + 1;
|FPRC;

|PROCESO magnetico2000;     || registro tipo 0 'presentador' soporte 2000
     regis = "0";
     caden = "0";                                || tipo de registro (1)
     caden = caden + "180";                      || modelo 180       (3)
     caden = caden + aEjerc;                     || aEjercicio        (4)
     caden = caden + #0#83;                      || nif              (9)
     aAlfa = #0#75; nLongi = 40; |HAZ QuitaComas; #0#75 = aAlfa;
     caden = caden + aAlfa;                      || razon social     (40)
     caden = caden + #0#76;                      || cl               (2)
     caden = caden + (#0#77 % 120);              || calle            (20)
     caden = caden + #0#78;                      || numero           (5)
     caden = caden + "  ";                       || Escalera         (2)
     caden = caden + "  ";                       || Piso             (2)
     caden = caden + "  ";                       || Puerta           (2)
     caden = caden + (("00"  + #0#79) % -102);   || Codigo provincia (2)
     caden = caden + (("000" + #0#80) % -103);   || Codigo poblacion (3)
     caden = caden + (#0#81 % 112);              || municipio        (12)
     caden = caden + (("00"  + #0#79) % -102);   || Codigo provincia (2)
     caden = caden + "00000";                    || retenedores, lo regraba al final     (5)
     caden = caden + "000000000";                || perceptores, lo regraba al final     (9)
     caden = caden + "D";                        || tipo presentacion (diskette)    (1)
     caden = caden + #0#92;                      || Telefono         (9)
     aAlfa = #0#91; nLongi = 40; |HAZ QuitaComas;
     caden = caden + aAlfa;                      || Persona Contacto (40)
     |HAZ magnetico2009;
|FPRC;

|PROCESO magnetico2001;     || registro tipo 1 'retenedor' soporte 2000

     regis = "1";
     caden = "1";                                || tipo de registro    (1)
     caden = caden + "180";                      || modelo 180          (3)
     caden = caden + aEjerc;                      || aEjercicio           (4)
     CampoDni = #1#13;  |HAZ LetraDni;
     caden = caden + CampoDni;                   || nif                 (9)
     aAlfa = #1#2; nLongi = 40; |HAZ QuitaComas;
     caden = caden + aAlfa;                      || razon social        (40)

     |SI enAnyo [ 2005;
         caden = caden + "D";                        || Tipo de soporte     (1)
     |SINO;
         caden = caden + "T";                        || Tipo de soporte     (1)
     |FINSI;

     #0#92 = #1#90 + #1#91;
     caden = caden + #0#92;                      || Telefono            (9)
     aAlfa = #1#89; nLongi = 40; |HAZ QuitaComas;
     caden = caden + aAlfa;                       || Persona Contacto    (40)
     |SI enAnyo [ 2000;
        Comodin = "1800000000000";
     |SINO;
        |SI enAnyo ] 2014;
            Comodin = "1800000000000";
        |SINO;
            Comodin = "1670000000000";
        |FINSI;
     |FINSI;
     caden = caden + Comodin;                    || N§ justificante

     |SI #0#96 = "0000000000000";
         caden = caden + "  " + #0#96;               || Normal
     |SINO;
         caden = caden + " S" + #0#96;               || Sustitutiva
     |FINSI;

     aAlfa1 = ("00000000000" + #11#19) % -109;
     caden = caden + aAlfa1;                      || perceptores         (9)

     nume1 = #11#20 + #11#22; ttr2 = #11#21 + #11#23;
     |SI nume1 < 0;
         caden = caden + "N";
         nume1 = -nume1;  ttr2 = -ttr2;
     |SINO;
         caden = caden + " ";
     |FINSI;

     |SI Moneda = "E";
        Cantidad = nume1; |HAZ Conversion; nume1 = Cantidad;
        Cantidad = ttr2;  |HAZ Conversion; ttr2  = Cantidad;
     |FINSI;

     aAlfa1 = ("000000000000000" + nume1) % -115;
     caden = caden + aAlfa1;                      || retribuciones       (15)

     aAlfa1 = ("000000000000000" + ttr2) % -115;
     caden = caden + aAlfa1;                      || retenciones         (15)

     Punto01 = Punto01 + #11#19;
     Punto02 = Punto02 + #11#20;
     Punto03 = Punto03 + #11#21;
     Punto04 = Punto04 + #11#22;
     Punto05 = Punto05 + #11#23;

     |HAZ magnetico2009;
|FPRC;

|PROCESO magnetico2002;     || registro tipo 2 'perceptor' soporte 2000
     regis = "2";
     caden = "2";                                    || tipo de registro (1)
     caden = caden + "180";                          || modelo 180       (3)
     caden = caden + aEjerc;                          || aEjercicio        (4)
     CampoDni = #1#13;  |HAZ LetraDni;
     caden = caden + CampoDni;                       || nif retenedor    (9)
     CampoDni = #2#7;   |HAZ LetraDni;
     Comodin = " " * 9;
     |SI #2#133 = " ";
        caden = caden + CampoDni;                    || nif perceptor     (9)
        caden = caden + Comodin;                     || nif representante (9)
     |SINO;
        caden = caden + Comodin;                     || nif perceptor     (9)
        caden = caden + CampoDni;                    || nif representante (9)
     |FINSI;
     aAlfa = #2#3; nLongi = 40; |HAZ QuitaComas;
     caden = caden + aAlfa;                          || apellidos,nombre (40)
     aAlfa1 = ("00" + #2#5) % -102;
     caden = caden + aAlfa1;                         || Codigo Provincial (2)
     caden = caden + clave;

     |SI Moneda = "E";
        Cantidad = tb; |HAZ Conversion; tb = Cantidad;
     |FINSI;

     |SI tb ] 0;
         sg  = " ";  tb2 = tb;   tr2 = tr;
     |SINO;
         sg  = "N";  tb2 = -tb;  tr2 = -tr;
     |FINSI;
     caden = caden + sg;                             || signo (1)
     aAlfa1 = ("0000000000000" + tb2) % -113;
     caden = caden + aAlfa1;                          || retribuciones    (15)

     |SI clave = "1"; Calc = #20#9;  |FINSI;
     |SI clave = "2"; Calc = #20#10; |FINSI;

     |SI enAnyo = 2015;
         |SI Calc ! 20; |Y Calc ! 19.5;
          |Y Calc ! 10; |Y Calc ! 9.75;
          |Y Calc > 0;
             |SI Calc < 20;  Calc = 19.5;  |FINSI;
             |SI Calc < 12;  Calc = 10;    |FINSI;
             |SI Calc < 10;  Calc = 9.75;  |FINSI;
             |SI Calc > 20;  Calc = 20;    |FINSI;
         |FINSI;
     |FINSI;

     Calc    = Calc * 100;
     Comodin = ("0000" + Calc) % -104;

     caden = caden + Comodin;

     |SI Moneda = "E"; Cantidad = tr2; |HAZ Conversion; tr2 = Cantidad; |FINSI;

     aAlfa1 = ("0000000000000" + tr2) % -113;
     caden = caden + aAlfa1;                          || retencion   (15)
     caden = caden + "0000";                         || aEjercicio devengo (4)

     Comodin = "";
     |SI enAnyo ] 2014;

         caden   = Handle + " " + caden;
         |FGRABA caden;

         Comodin = #2#138;   || Situacion Inmueble

         aAlfa   = #2#136;  |HAZ QuitaComas;  |QBF aAlfa;   || Ref. Catastral
         aAlfa1  = " " * 20;  aAlfa = (aAlfa + aAlfa1) % 120;
         Comodin = Comodin + aAlfa;

         aAlfa   = #2#137;  |HAZ ComparaSiglas;  || SG
         aAlfa   = (aAlfa + "     ") % 105;
         Comodin = Comodin + aAlfa;

         aAlfa  = #2#127;  |HAZ QuitaComas;     |QBF aAlfa;
         aAlfa1 = " " * 50; aAlfa = (aAlfa + aAlfa1) % 150;
         Comodin = Comodin + aAlfa;

         aAlfa1 = "   ";
         |SI #2#128 ! "    "; aAlfa1 = "NUM"; |FINSI;
         nNume = #2#128;
         aAlfa = ( "00000" + nNume) % -105; || Numero Casa
         Comodin = Comodin + aAlfa1 + aAlfa;

         Comodin = Comodin + "         ";  || cal, bloque y portal

         aAlfa = #2#129; || Escalera
         Comodin = Comodin + aAlfa;

         aAlfa = #2#130 + " ";  || Piso
         Comodin = Comodin + aAlfa;

         aAlfa = #2#131 + " "; || Puerta
         Comodin = Comodin + aAlfa;

         aAlfa1  = " " * 70;
         Comodin = Comodin + aAlfa1;

         aAlfa = #2#4;  |HAZ QuitaComas; |QBF aAlfa; || Municipio
         aAlfa1 = " " * 30; aAlfa = (aAlfa + aAlfa1) % 0130;
         Comodin = Comodin + aAlfa;

         aAlfa = #2#139;  || Codigo Municipio
         aAlfa = ("00000" + aAlfa) % -105;
         Comodin = Comodin + aAlfa;

         aAlfa = ("00" + #2#5) % -102;
         Comodin = Comodin + aAlfa;

         aAlfa = (("00" + #2#5) % -102) + (("000" + #2#6) % -103);
         Comodin = Comodin + aAlfa;

         nSw = 1;
         Comodin  = Handle + " " + Comodin;
         |FGRABA Comodin;
     |FINSI;

     |HAZ magnetico2009;
     nSw = 0;
|FPRC;

|PROCESO magnetico;      || abre el fichero
     |SI enAnyo [ 2011;
         |DFICE fiche;
         fiche = "wb  " + fiche + "RTPA" + aEjerc;
         |FABRE fiche;
         FEstado = FSalida;
         Handle = FEstado;
     |FINSI;

     |SI enAnyo ] 2012;
         eaFicheroPlano = eaModelos + (("00000" + #30#2) % -105) + ".txt";
         eaFicheroImpre = eaModelos + (("00000" + #30#2) % -105) + ".imp";
         eaFicheroSalid = eaModelos + (("00000" + #30#2) % -105) + ".sal";
         eaFicheroError = "err" + (("00000" + #30#2) % -105) + ".txt";

         |DFICE fiche;
         fiche = "wb  " + eaPathEmision + eaFicheroPlano;
         |FABRE fiche;
         FEstado = FSalida;
         Handle = FEstado;

         enEmpresa    = #30#2;
         eaNomEmpresa = #30#1;
     |FINSI;
|FPRC;

|| **********************************************************************
||                       CALCULOS DE IMPRESION
|| **********************************************************************

|PROCESO QuitaComas;

     |QBF aAlfa;
     aCadena = "";
     aLong   = aAlfa % 0;
     nLong   = aLong;
     |PARA nCampo = 1;  |SI nCampo [ aLong;  |HACIENDO nCampo = nCampo + 1;
           nPos = (100 * nCampo) + 1;
           aCaracter = aAlfa % nPos;
           |SI aCaracter = ",";  aCaracter = "";   |FINSI;
           |SI aCaracter = "¥";  aCaracter = &209; |FINSI;
           |SI aCaracter = "¤";  aCaracter = &209; |FINSI;
           |SI aCaracter = "§";  aCaracter = &176; |FINSI;
           |SI aCaracter = "¦";  aCaracter = &170; |FINSI;
           aCadena = aCadena + aCaracter;
     |SIGUE;
     blancos = " " * nLongi; nCalc = 100 + nLongi;
     aCadena = (aCadena + blancos) % nCalc;
     aAlfa = aCadena;
|FPRC;

|PROCESO GrabaTempo1;
     |DDEFECTO #2;
     #2#0    = #20#0;
     #2#7    = #20#7;       || dni
     #2#136  = #20#136;     || Ref. catastral
     |LEE 101#2=;
     FEstado = FSalida;

     |PARA nCampo = 0; |SI nCampo [ 139; |HACIENDO nCampo = nCampo + 1;
           nSwAcumula = 0;
           |SI nCampo ]  23; |Y nCampo [ 126;  nSwAcumula = 1;  |FINSI;
           |SI nSwAcumula = 0;
               #2nCampo = #20nCampo;
           |SINO;
               #2nCampo = #2nCampo + #20nCampo;
           |FINSI;
     |SIGUE;

     |SI FEstado = 0;  |GRABA 000#2a;  |FINSI;
     |SI FEstado ! 0;  |GRABA 000#2n;  |FINSI;
     |LIBERA #2;
|FPRC;

|DEFBUCLE caman115;
     #20#1;
     135;
     #30#2, 00000, #30#26, "5";
     #30#2, 99999, #30#26, "5";
     ;
     NULL, GrabaTempo1;
|FIN;

|PROCESO CreaTemporal1;
     |ABRE #2;  |CIERRA #2;  |DELINDEX #2;

     |NOPARA;

     |ABRE #2;
     |BUCLE caman115;
     |CIERRA #2;

     |SIPARA;
|FPRC;

|PROCESO Hojas;
     hoja     = 0;
     tothojas = 0;
     nPag     = 7;
     |SI #11#32 ! 0;
         nCampo = #11#32 $ nPag;
         |SI nCampo ! 0;
             tothojas = tothojas + ((#11#32 + (nPag - nCampo)) / nPag);
         |SINO;
             tothojas = tothojas + (#11#32 / nPag);
         |FINSI;
     |FINSI;

     |SI #11#33 ! 0;
         nCampo = #11#33 $ nPag;
         |SI nCampo ! 0;
             tothojas = tothojas + ((#11#33 + (nPag - nCampo)) / nPag);
         |SINO;
             tothojas = tothojas + (#11#33 / nPag);
         |FINSI;
     |FINSI;

     |SI #11#34 ! 0;
         nCampo = #11#34 $ nPag;
         |SI nCampo ! 0;
             tothojas = tothojas + ((#11#34 + (nPag - nCampo)) / nPag);
         |SINO;
             tothojas = tothojas +  (#11#34 / nPag);
         |FINSI;
     |FINSI;

     |SI #11#35 ! 0;
         nCampo = #11#35 $ nPag;
         |SI nCampo ! 0;
             tothojas = tothojas + ((#11#35 + (nPag - nCampo)) / nPag);
         |SINO;
             tothojas = tothojas +  (#11#35 / nPag);
         |FINSI;
     |FINSI;

     |SI #11#36 ! 0;
         nCampo = #11#36 $ nPag;
         |SI nCampo ! 0;
             tothojas = tothojas + ((#11#36 + (nPag - nCampo)) / nPag);
         |SINO;
             tothojas = tothojas +  (#11#36 / nPag);
         |FINSI;
     |FINSI;

     |SI #11#37 ! 0;
         nCampo = #11#37 $ nPag;
         |SI nCampo ! 0;
             tothojas = tothojas + ((#11#37 + (nPag - nCampo)) / nPag);
         |SINO;
             tothojas = tothojas +  (#11#37 / nPag);
         |FINSI;
     |FINSI;

     |SI #11#38 ! 0;
         nCampo=#11#38 $ nPag;
         |SI nCampo ! 0;
             tothojas = tothojas + ((#11#38 + (nPag - nCampo)) / nPag);
         |SINO;
             tothojas = tothojas + (#11#38 /nPag);
         |FINSI;
     |FINSI;

     |SI #11#39 ! 0;
         nCampo = #11#39 $ nPag;
         |SI nCampo ! 0;
             tothojas = tothojas + ((#11#39 + (nPag - nCampo) ) / nPag);
         |SINO;
             tothojas = tothojas + (#11#39 /nPag);
         |FINSI;
     |FINSI;

     |SI #11#40 ! 0;
         nCampo = #11#40 $ nPag;
         |SI nCampo ! 0;
             tothojas = tothojas + ((#11#40 + (nPag - nCampo)) / nPag);
         |SINO;
             tothojas = tothojas + (#11#40 / nPag);
         |FINSI;
     |FINSI;

     |SI #11#41 ! 0;
         nCampo = #11#41 $ nPag;
         |SI nCampo ! 0;
             tothojas = tothojas + ((#11#41 + (nPag - nCampo)) / nPag);
         |SINO;
             tothojas = tothojas + (#11#41 / nPag);
         |FINSI;
     |FINSI;

     |SI #11#42 ! 0;
         nCampo=#11#42 $ nPag;
         |SI nCampo ! 0;
             tothojas = tothojas + ((#11#42 + (nPag - nCampo)) / nPag);
         |SINO;
             tothojas = tothojas + (#11#42 / nPag);
         |FINSI;
     |FINSI;

     |SI #11#43 ! 0;
         nCampo = #11#43 $ nPag;
         |SI nCampo ! 0;
             tothojas = tothojas + ((#11#43 + (nPag - nCampo)) / nPag);
         |SINO;
             tothojas = tothojas +  (#11#43 / nPag);
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Punteros;
     s1 = 0;   b1 = 0;   r1 = 0;
     |SI #2#12 = "1";  s1 = 32;  b1 = 20;  r1 = 21;  |FINSI;
     |SI #2#12 = "2";  s1 = 37;  b1 = 22;  r1 = 23;  |FINSI;

     s2 = 0;   b2 = 0;   r2 = 0;
     |SI #2#13 = "1";  s2 = 32;  b2 = 20;  r2 = 21;  |FINSI;
     |SI #2#13 = "2";  s2 = 37;  b2 = 22;  r2 = 23;  |FINSI;
|FPRC;

|PROCESO Proceso;
     nSwTraba = 1;   || si hay trabajadores
     nYaEsta1 = 0;
     nYaEsta2 = 0;
     |HAZ Punteros;

     |PARA nMeses = 1; |SI nMeses [ 12;  |HACIENDO nMeses = nMeses + 1;
           nCampoBase1 = nMeses +  22;
           nCampoRete1 = nMeses +  35;
           nCampoBase2 = nMeses +  48;
           nCampoRete2 = nMeses +  61;
           #11b1 = #11b1 + #2nCampoBase1;
           #11r1 = #11r1 + #2nCampoRete1;   || total reten. 1
           #11b2 = #11b2 + #2nCampoBase2;   || total bases 2
           #11r2 = #11r2 + #2nCampoRete2;   || total reten. 2

           |SI nYaEsta1 = 0;
               |SI #2nCampoBase1 ! 0;|O #2nCampoRete1 ! 0;
                   nYaEsta1 = 1;
                   #11s1 = #11s1 + 1;  || sujetos 1
               |FINSI;
           |FINSI;

           |SI nYaEsta2 = 0;
               |SI #2nCampoBase2 ! 0;|O #2nCampoRete2 ! 0;
                   nYaEsta2 = 1;
                   #11s2 = #11s2 + 1;  || sujetos 2
               |FINSI;
           |FINSI;
     |SIGUE;
|FPRC;

|DEFBUCLE cat18001_1;
     #2#1;
     ;
     #30#2, "            ", "                    ";
     #30#2, "zzzzzzzzzzzz", "zzzzzzzzzzzzzzzzzzzz";
     e;
     NULL, Proceso, NULL, NULL, Hojas;
|FIN;

____________________________________/ Portada
|| *************************
|| IMPRESION DE LAS PORTADAS
|| *************************

|PROCESO PortadaC;
     #900#75  = #0#88;
     #900#76  = #0#89;
     #900#77  = (("00" + #0#86) % -102) + (("000" + #0#87) % -103);
     #900#78  = 0;
     #900#79  = #0#0;
     #900#80  = " ";
     #900#81  = " ";
     #900#82  = "X";
     #900#83  = " ";
     #900#84  = #0#83;
     #900#85  = #0#75;
     #900#86  = #0#76;
     #900#87  = #0#77;
     #900#88  = #0#78;
     #900#89  = "";
     #900#90  = "";
     #900#91  = "";
     #900#92  = #0#85;
     #900#93  = #0#81;
     #900#94  = #0#82;
     #900#95  = (("00" + #0#79) % -102) + (("000" + #0#80) % -103);
     #900#96  = "";
     #900#97  = "";
     #900#98  = Punto01;
     #900#99  = Punto02;
     #900#100 = Punto03;
     #900#101 = Punto04;
     #900#102 = Punto05;
     #900#103 = #104#15;
     #900#104 = #104#6;
     #900#105 = "";
     aAlfa    = #0#81;  |QBF aAlfa;
     #900#106 = aAlfa + ",  " + #0#1;
     #900#107 = "";
     #900#108 = #0#90;

     |INFOR "capor180";

     |PRINT;
     |PIEINF;
     |FININF;
|FPRC;

|PROCESO PortadaI;
     |ABRE #1;
     #1#0 = #30#2;
     #1#1 = #30#26;
     |LEE 040#1=;
     |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;
     |CIERRA #1;

     #900#75  = #1#18;
     #900#76  = #1#19;
     #900#77  = (("00" + #1#16) % -102) + (("000" + #1#17) % -103);
     #900#78  = #1#0;
     #900#79  = #1#1;
     #900#80  = " ";
     #900#81  = " ";
     #900#82  = " ";
     #900#83  = " ";
     |SI #0#70 = "I"; #900#81 = "X";  |FINSI;
     |SI #0#70 = "C"; #900#83 = "X";  |FINSI;
     #900#84  = #1#13;
     #900#85  = #1#2;
     #900#86  = #1#3;
     #900#87  = #1#4;
     #900#88  = #1#5;
     #900#89  = #1#6;
     #900#90  = #1#7;
     #900#91  = #1#8;
     #900#92  = #1#14;
     #900#93  = #1#11;
     #900#94  = #1#12;
     #900#95  = (("00" + #1#9) % -102) + (("000" + #1#10) % -103);
     #900#96  = "";
     #900#97  = "";
     #900#98  = #11#19;
     #900#99  = #11#20;
     #900#100 = #11#21;
     #900#101 = #11#22;
     #900#102 = #11#23;
     #900#103 = 0;
     #900#104 = 0;
     #900#105 = "";
     #900#107 = "";
     #900#108 = "";

     |INFOR "capor180";

     aAlfa = #1#11;  |QBF aAlfa;
     #900#106 = aAlfa + ",  " + #0#1;

     |PRINT;
     |PIEINF;
     |FININF;

     Punto01 = Punto01 + #11#19;
     Punto02 = Punto02 + #11#20;
     Punto03 = Punto03 + #11#21;
     Punto04 = Punto04 + #11#22;
     Punto05 = Punto05 + #11#23;
|FPRC;

|PROCESO HojasIn2;
     #20#0   = #2#0;
     #20#1   = #2#1;        || lee del fichero maestro
     #20#134 = #0#0;
     |LEE 121#20=;            || tiene que existir!!!
     |SI nSwBusca = 1;  nVarCampo1 =  22;  nVarCampo2 =  35;  |FINSI;    || punteros de base
     |SI nSwBusca = 2;  nVarCampo1 =  48;  nVarCampo2 =  61;  |FINSI;    ||/y retencion
         tb = 0;
         tr = 0;
     |PARA nMeses = 1; |SI nMeses [ 12; |HACIENDO nMeses = nMeses + 1;
             nCampoBase = nMeses + nVarCampo1;
             nCampoRete = nMeses + nVarCampo2;
             tb = tb + #2nCampoBase;                     || acumula bases
             tr = tr + #2nCampoRete;                     || acumula retencion
     |SIGUE;

     |SI nSwBusca = 1;  #20#15 = 0;  #20#19 = 0;  |FINSI;
     |SI nSwBusca = 2;  #20#16 = 0;  #20#20 = 0;  |FINSI;      || inicializa la

     |SI tb ! 0;|O tr ! 0;
         |SI nSwBusca = 1;  pp = #2#09;  clave = #2#12;  |FINSI;
         |SI nSwBusca = 2;  pp = #2#10;  clave = #2#13;  |FINSI; || carga

         |SI #c3gso180#0 ] 80;
            |HAZ magnetico2;
         |SINO;
            |HAZ magnetico2002;
         |FINSI;

         |SI nSwBusca = 1;  #20#15 = hoja;  #20#19 = linea;  |FINSI;
         |SI nSwBusca = 2;  #20#16 = hoja;  #20#20 = linea;  |FINSI;  || carga hoja
     |FINSI;
     |GRABA 020#20a;               || regraba el trabajador
     |LIBERA #20;
|FPRC;

|DEFBUCLE cat18001_2;
     #2#1;
     12;
     #30#2, "            ", "                    ", aDCla;
     #30#2, "zzzzzzzzzzzz", "zzzzzzzzzzzzzzzzzzzz", aHCla;
     e;
     NULL, HojasIn2;
|FIN;

|DEFBUCLE cat18001_3;
     #2#1;
     13;
     #30#2, "            ", "                    ", aDCla;
     #30#2, "zzzzzzzzzzzz", "zzzzzzzzzzzzzzzzzzzz", aHCla;
     e;
     NULL, HojasIn2;
|FIN;

|PROCESO HojasIn1;
     nSwBusca = 1;  |BUCLE cat18001_2;
     nSwBusca = 2;  |BUCLE cat18001_3;
|FPRC;

|PROCESO HojasIn;
     |SI #11#32 ! 0;  aDCla = "1";  aHCla = aDCla;  |HAZ HojasIn1;  |FINSI;
     |SI #11#37 ! 0;  aDCla = "2";  aHCla = aDCla;  |HAZ HojasIn1;  |FINSI;
|FPRC;

____________________________________/ GRABA REGISTROS POR EMPRESA

|PROCESO SumaPerce;
     |PARA nCampo = 32; |SI nCampo [ 43; |HACIENDO nCampo = nCampo + 1;
             #11#19 = #11#19 + #11nCampo;        || casilla 1 (total percep.)
     |SIGUE;
|FPRC;

|PROCESO Reparte;
     |ABRE #1;
     #1#0 = #30#2;
     #1#1 = #30#26;
     |LEE 040#1=;
     |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;
     |CIERRA #1;

     |SI Opcion ! 2;
         |HAZ SumaPerce;           || halla el total perceptores
         |SI #c3gso180#0 ] 80;
             |HAZ magnetico1;
         |SINO;
             |HAZ magnetico2001;
         |FINSI;
         |HAZ HojasIn;             || imprime hojas interiores
     |SINO;
         |HAZ SumaPerce;
         |HAZ PortadaI;
     |FINSI;
|FPRC;

|PROCESO Imprime;
     |DDEFECTO #11;
     nSwTraba = 0;
     |BUCLE cat18001_1;          || lee trabajadores y calcula el numero de hojas
     |SI nSwTraba = 1; |HAZ Reparte; |FINSI;
|FPRC;

|PROCESO HazTodo;
  enEmpresa = #canempre#2;
  enPeriodo = #canempre#3;
  swOperacion = 0
  |SUB_EJECUTA "camoneda.tab";

     |PATH_DAT #2  aDirFich;
     |PATH_DAT #11 aDirFich;
     |PATH_DAT #20 aDirFich;
     |PATH_DAT #1  aDirFich;

     |HAZ CreaTemporal1;

     |ABRE #20;
     |HAZ Imprime;
     |CIERRA #20;

     |SI nSwTraba = 0; |ACABA; |FINSI;

     #catmp180#0 = 0;
     |LEE 000#catmp180.=;
     |SI FSalida ! 0;
        |DDEFECTO #catmp180;
        #catmp180#0 = 0;
        #catmp180#1 = 0;
        #catmp180#2 = 180;
        #catmp180#3 = aEjerc;
        Comodin = #0#83; NCar = 9;  Tipo = "A"; |HAZ Recorta; #catmp180#4 = Comodin;
        Comodin = #0#86; NCar = 2;  Tipo = "N"; |HAZ Recorta; #catmp180#5 = Comodin;
        Comodin = #0#87; NCar = 3;  Tipo = "N"; |HAZ Recorta; #catmp180#6 = Comodin;
        Comodin = #0#76; NCar = 2;  Tipo = "A"; |HAZ Recorta; #catmp180#7 = Comodin;
        Comodin = #0#77; NCar = 20; Tipo = "A"; |HAZ Recorta; #catmp180#8 = Comodin;
        Comodin = #0#78; NCar = 5;  Tipo = "N"; |HAZ Recorta; #catmp180#9 = Comodin;
        Comodin = #0#81; NCar = 12; Tipo = "A"; |HAZ Recorta; #catmp180#10 = Comodin;
        Comodin = #0#79; NCar = 2;  Tipo = "N"; |HAZ Recorta; #catmp180#11 = Comodin
        Comodin = #0#80; NCar = 3;  Tipo = "N"; |HAZ Recorta; #catmp180#12 = Comodin;
        Comodin = #0#1;  NCar = 8;  Tipo = "F"; |HAZ Recorta; #catmp180#13 = Comodin;
        Comodin = #0#75; NCar = 30; Tipo = "A"; |HAZ Recorta; #catmp180#14 = Comodin;
        Comodin = #0#90; NCar = 25; Tipo = "A"; |HAZ Recorta; #catmp180#15 = Comodin;
        Comodin = #0#90; NCar = 25; Tipo = "A"; |HAZ Recorta; #catmp180#15 = Comodin;
        Comodin = "";    NCar = 20; Tipo = "A"; |HAZ Recorta; #catmp180#16 = Comodin;
        |GRABA 020#catmp180.n;
     |FINSI;

     |DDEFECTO #catmp180;
     #catmp180#0 = Contador; Contador = Contador + 1;
     #catmp180#1 = 1;
     #catmp180#2 = 180;
     #catmp180#3 = aEjerc;
     Comodin = #caportad#13; NCar = 9;  Tipo = "A"; |HAZ Recorta; #catmp180#4 = Comodin;
     Comodin = #caportad#16; NCar = 2;  Tipo = "N"; |HAZ Recorta; #catmp180#5 = Comodin;
     Comodin = #caportad#17; NCar = 3;  Tipo = "N"; |HAZ Recorta; #catmp180#6 = Comodin;
     Comodin = #caportad#3;  NCar = 2;  Tipo = "A"; |HAZ Recorta; #catmp180#7 = Comodin;
     Comodin = #caportad#4;  NCar = 20; Tipo = "A"; |HAZ Recorta; #catmp180#8 = Comodin;
     Comodin = #caportad#5;  NCar = 5;  Tipo = "N"; |HAZ Recorta; #catmp180#9 = Comodin;
     Comodin = #caportad#11; NCar = 12; Tipo = "A"; |HAZ Recorta; #catmp180#10 = Comodin;
     Comodin = #caportad#9;  NCar = 2;  Tipo = "N"; |HAZ Recorta; #catmp180#11 = Comodin;
     Comodin = #caportad#10; NCar = 3;  Tipo = "N"; |HAZ Recorta; #catmp180#12 = Comodin;
     Comodin = #c3gso180#1;  NCar = 8;  Tipo = "F"; |HAZ Recorta; #catmp180#13 = Comodin;
     aAlfa = #caportad#2; |HAZ QuitaComas;    Comodin = aAlfa;  NCar = 30; Tipo = "A"; |HAZ Recorta; #catmp180#14 = Comodin;
     Comodin = "";           NCar = 25; Tipo = "A"; |HAZ Recorta; #catmp180#15 = Comodin;
     Comodin = #caportad#0;  NCar = 20; Tipo = "A"; |HAZ Recorta; #catmp180#16 = Comodin;
     |GRABA 020#catmp180.n;
|FPRC;

|| ---------- Seleccion DESDE / HASTA Empresa.

|PROCESO Leelo;
     aDirFich = "";
     |DBASE aDirFich;
     aDirFich = aDirFich + "fich/" + (("00000" + #30#2) % -105) + (("0" + #30#3) % -101) + "/";

     |SI #30#26 ! #0#0; |O #30#21 = "I";
         |ACABA;
     |FINSI;

     aAlfa = "RTPA" + aEjerc;
     INEmpresas = NEmpresas1 <-; NEmpresas = aAlfa;

     |HAZ HazTodo;
|FPRC;

|DEFBUCLE canempre_2;
     #30#1;
     ;
     #0#5, #0#7;
     #0#6, #0#8;
     ;
     NULL, Leelo;
|FIN;

|PROCESO Seleccion;
     nCont = 1; Contador = 1; |DELINDEX #catmp180; |ABRE #catmp180;
     |SI #0#4 = "S";
         |BUCLE canempre_2;
     |SINO;
         |PARA nVarCampo1T = 9;  |SI nVarCampo1T [ 28;  |HACIENDO nVarCampo1T = nVarCampo1T + 1;
               |SI #0nVarCampo1T = 0;  |SAL;  |FINSI;
               nVarCampo2T = nVarCampo1T + 20;

               #0#5 = #0nVarCampo1T;
               #0#6 = #0nVarCampo1T;
               #0#7 = #0nVarCampo2T;
               #0#8 = #0nVarCampo2T;
               |BUCLE canempre_2;
         |SIGUE;
     |FINSI;
     |CIERRA #catmp180;
|FPRC;

|PROCESO CreaTempos;
     Punto01 = 0;
     Punto02 = 0;
     Punto03 = 0;
     Punto04 = 0;
     Punto05 = 0;

     |SI #0#70 = "C";
        |SI #c3gso180#0 ] 80;
           |HAZ magnetico0;
        |SINO;
           |HAZ magnetico2000;
        |FINSI;
     |FINSI;

     |HAZ Seleccion;

     |SI Opcion = 2;
         |SI #0#70 = "C";  |HAZ PortadaC;  |FINSI;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO GrabaTotal;    || regraba total retenedores y total perceptores
     |DFICE fiche;
     fiche = "r+b " + fiche + "RTPA" + aEjerc;
     |FABRE fiche;
     |SI FSalida ] 0;
         Handle = FSalida;
         aAlfa1 = ("00000" + treten) % -105;
         caden = aAlfa1;
         caden = Handle + " " + caden;
         Pos   = 109;
         |FGRABA caden;       || regraba total retenedores

         aAlfa1 = ("000000000" + tperce) % -109;
         caden = aAlfa1;
         caden = Handle + " " + caden;
         Pos = 114;
         |FGRABA caden;       || regraba total perceptores
         |FCIERRA Handle;
         Pos = -1;
     |FINSI;
|FPRC;

|| *********************************************
|| PROCESO DEL SECUENCIAL PARA SOPORTE MAGNETICO
|| *********************************************

|PROCESO Creacion;
     |DDEFECTO #104;
     treten = 0;
     tperce = 0;

     |HAZ magnetico;

     |SI FEstado ] 0;
         |DDEFECTO #11;
         |HAZ CreaTempos;

         caden = Handle + " " + &#0#95;
         |FGRABA caden;
         |FCIERRA Handle;
         Pos = -1;
         |SI #0#70 = "C";
             |HAZ GrabaTotal;     || regraba el registro tipo 0 'presentador' (colec.)
         |FINSI;
         |BLIN 23;
     |FINSI;

     |SI SwLaser = 1; |ACABA; |FINSI;

     Pos = -1;
     |PUSHV 0501 2380;
     |PINPA #0#104;

     |C_V #104#1,  1, "N";  |C_M #104#1,  1, "N";
     |C_V #104#2,  1, "N";  |C_M #104#2,  1, "N";
     |C_V #104#3,  1, "N";  |C_M #104#3,  1, "N";
     |C_V #104#4,  1, "N";  |C_M #104#4,  1, "N";
     |C_V #104#5,  1, "N";  |C_M #104#5,  1, "N";
     |C_V #104#7,  1, "N";  |C_M #104#7,  1, "N";
     |C_V #104#12, 1, "N";  |C_M #104#12, 1, "N";
     |C_V #104#13, 1, "N";  |C_M #104#13, 1, "N";

     #104#0  = Punto01;
     #104#8  = Punto02;
     #104#9  = Punto03;
     #104#10 = Punto04;
     #104#11 = Punto05;
     #104#15 = treten;
     #104#6  = tperce;

     |PINDA #0#104;
     |CONFI "2400SEs Correcto : ";
     |SI FSalida ! 0;
         fiche = "";
         |DFICE fiche;
         fiche = fiche + "RTPA" + aEjerc;
         |FBORRA fiche;
         Salir = 1;
     |FINSI;
     |POPV;
|FPRC;

|| *********************************************************************
||                    COMIENZO con TIPO 3
|| *********************************************************************

|PROCESO VuelcaDatos;
   |SI #c3gso180#70 = "I"; |Y #catmp180#0 = 0; |ACABA; |FINSI;

   caden = "";
   |PARA nCont = 1; |SI nCont [ 11; |HACIENDO nCont = nCont + 1;
      caden = caden + #catmp180#nCont#;
   |SIGUE;
   |PARA nCont = 11; |SI nCont [ 15; |HACIENDO nCont = nCont + 1;
      caden = caden + #catmp180#nCont#;
   |SIGUE;
   |SI enAnyo ] 2002;
       caden = caden + #catmp180#16#;
   |FINSI;
   caden = caden + &13 + &10;
   caden = Maneja1 + " " + caden; |FGRABA caden;
|FPRC;

|DEFBUCLE VuelcaDatos;
   #catmp180#1;
   ;
   INICIO;
   FINAL;
   ;
   NULL,VuelcaDatos;
|FIN;

|PROCESO Portadas;
     |SI nAnyo [ 2000;
        |IMPRE 0;
        |HAZ CreaTempos;
        |FINIMP;
     |SINO;
        Directorio = "";  |DBASE Directorio; DirectorioD = Directorio;
        Directorio = Directorio + "hacienda/180/DIRECTA/";
        Comodin = (("00000" + #48#2) % -105) + #48#3;
        DirectorioD = DirectorioD + "fich/" + Comodin + "/";

        aFichOrigen = DirectorioD + "RTPA" + aEjerc;
        aFichDestin = Directorio  + "RTPA" + aEjerc;
        |COPIA_FICHERO aFichOrigen, aFichDestin;

        |DFICE Directorio;
        Fichero  = #0#0;
        Fichero  = "RTPA" + aEjerc + ".car";
        NFichero = Fichero;          |QBF NFichero;
        Fichero  = "wb  "+ Directorio + NFichero;
        |FABRE Fichero;
        |SI FSalida ] 0;
           Maneja1 = FSalida;
           |BUCLE VuelcaDatos;
        |FINSI;
        FSalida = Maneja1; |FCIERRA FSalida;
        aFichOrigen = aFichOrigen + ".car";
        aFichDestin = aFichDestin + ".car";
        |COPIA_FICHERO aFichOrigen,aFichDestin;

        eaFichCol = "RTPA" + aEjerc; eaTipoEmi = "VERIF180"; eaTipoSec = "180";
        eaEjecutable = "";
        |SI enAnyo = 2001;  eaEjecutable = "i180pr01";  |FINSI;
        |SI enAnyo = 2002;  eaEjecutable = "zpr02180";  |FINSI;
        |SI enAnyo = 2003;  eaEjecutable = "zpr03180";  |FINSI;
        |SI enAnyo = 2004;  eaEjecutable = "zpr04180";  |FINSI;
        |SI enAnyo = 2005;  eaEjecutable = "zpr05180";  |FINSI;

        |SI eaEjecutable ! "";  |SUB_EJECUTA "eosz9999";  |FINSI;
     |FINSI;
|FPRC;

|| ***********************************************************************
||                       EMISION DE ETIQUETAS
|| ***********************************************************************

|PROCESO Etiquetas;
     |SI #104#14 = 0;
         |MENAV "     Por favor haga la creacion de Diskette.";
         |ACABA;
     |FINSI;

     |PUSHV 0501 2380;

     aAlfa1  = "19";
     |SI #0#0 < 80; aAlfa1 = "20"; |FINSI;
     VAlfa    = #0#0;   VAlfa = ("00" + VAlfa) % -102;
     aAlfa1  = aAlfa1 + VAlfa;                          || Ejercicio
     VAlfa    = #0#79;  VAlfa = ("00" + VAlfa) % -102;
     aAlfa2  = VAlfa;                                     || Codigo Postal 1
     VAlfa    = #0#80;  VAlfa = ("000" + VAlfa) % -103;
     aAlfa3  = VAlfa;                                     || Codigo Postal 2

     #104#16 = "Delegacion .........: " + #0#88;
     #104#17 = "Ejercicio ..........: " + aAlfa1;
     #104#18 = "Modelo .............: 180";
     #104#19 = "Numero Justificante : ";
     #104#20 = "N.I.F. .............: " + #0#83;
     #104#21 = "Nombre : " + #0#75;
     #104#22 = #0#76 + " " + #0#77 + " " + #0#78 + " " + aAlfa2 + aAlfa3 + " " + #0#81;
     #104#23 = "P.Cont.: " + #0#91;
     #104#24 = "Telefono ...........: " + #0#84 + " " + #0#85;
     #104#25 = "Numero total Registros ..: " + #104#14;
     #104#26 = "Densidad soporte : 1,44 MB en Diskettes de 3 1/2";
     #104#27 = "";
     #104#28 = "";
     |C_M #104#27, 1, "N";
     |C_M #104#28, 1, "N";
     |SI #0#22 = "C";
         #104#27 = "Numero total Declarantes : " + #104#15;
         #104#28 = "Numero total Declarados .: " + #104#6;
         |C_M #104#27, 1, "S";
         |C_M #104#28, 1, "S";
     |FINSI;

     |PINPA #2#104;
     |PINDA #2#104;
     |ENDATOS #1#104;
     |SI FSalida = 0;
         |PINPA #2#104;
         |PINDA #2#104;

         |CONFI "2400SRealizar Impresion de la Etiqueta : ";
         |SI FSalida ! 0; |POPV; |ACABA; |FINSI;

         |IMPRE 0;
         |SI FSalida ! 0;  |ACABA;  |FINSI;

         |INFOR "caetique";
         |SI FSalida ! 0;  |FINIMP;  |ACABA;  |FINSI;

         |PRINT; |PIEINF; |FININF; |FINIMP;
     |FINSI;
     |POPV;
|FPRC;

|PROCESO Recorta;
   |SI Tipo ! "F";
      |SI Tipo = "A";
         Calc = 100 + NCar;
         Comodin1 = " ";
         Comodin1 = Comodin1 * NCar;
         Comodin = (Comodin + Comodin1) % Calc;
      |SINO;
         |QBF Comodin;
         Calc = 0 - (100 + NCar);
         Comodin1 = "0";
         Comodin1 = Comodin1 * NCar;
         Comodin = (Comodin1 + Comodin) % Calc;
      |FINSI;
   |SINO;
      Comodin1 = Comodin % -104;
      Comodin1 = Comodin1 + (Comodin % 0402);
      Comodin  = Comodin1 + (Comodin % 0102);
   |FINSI;
|FPRC;

|PROCESO CreaCaratula;
     |DFICE Directorio;
     Fichero  = "RTPA" + aEjerc + ".car";
     NFichero = Fichero;          |QBF NFichero;
     Fichero  = "wb  "+ Directorio + NFichero;
     |FABRE Fichero;
     |SI FSalida ] 0;
        Maneja = FSalida;
        caden = "1180";
        caden = caden + aEjerc;
        Comodin = #caportad#13; NCar = 9;  Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#16; NCar = 2;  Tipo = "N"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#17; NCar = 3;  Tipo = "N"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#3;  NCar = 2;  Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#4;  NCar = 20; Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#5;  NCar = 5;  Tipo = "N"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#11; NCar = 12; Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#9;  NCar = 2;  Tipo = "N"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#9;  NCar = 2;  Tipo = "N"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#10; NCar = 3;  Tipo = "N"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #0#1;         NCar = 8;  Tipo = "F"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #0#75;        NCar = 30; Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #0#90;        NCar = 25; Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = ("00000" + #caportad#0) % -105;
                                NCar = 20; Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        caden = caden + &13 + &10;
        caden = Maneja + " " + caden; |FGRABA caden;
     |FINSI;
     |FCIERRA Maneja;
|FPRC;

|PROCESO Laser;
   SwLaser = 1;
   |HAZ Creacion;
   |HAZ CreaCaratula;

   Directorio = "";  |DBASE Directorio; DirectorioD = Directorio;
   Directorio = Directorio + "hacienda/180/";
   Comodin = (("00000" + #48#2) % -105) + #48#3;
   DirectorioD = DirectorioD + "fich/" + Comodin + "/";

   aTipoSec = "180";
   aFichOrigen = DirectorioD + "RTPA" + aEjerc;
   aFichDestin = Directorio  +"RTPA" + aEjerc;
   |COPIA_FICHERO aFichOrigen, aFichDestin;
   aFichOrigen = aFichOrigen + ".car";
   aFichDestin = aFichDestin + ".car";
   |COPIA_FICHERO aFichOrigen, aFichDestin;

   |HAZ GrabaDisketteL;
|FPRC;

|PROCESO GrabaDisketteC;
     Pos = -1;
     Directorio = "";
     |DFICE Directorio;
     Fichero  = #0#0;
     Fichero  = "RTPA" + aEjerc;
     NFichero = Fichero;          |QBF NFichero;
     Fichero  = "rt  "+ Directorio + NFichero;
     |FABRE Fichero;
     |SI FSalida < 0;
         VAlfa = "      No se ha creado el fichero " + NFichero + " Por favor haga la Creacion del Diskette";
         |MENAV  VAlfa;
         |ACABA;
     |FINSI;
     |FCIERRA FSalida;

     Pos = -1;
     |PUSHV 0501 2380;
     |PINPA #1#104;

     E_sup  = 1;
     E_inf  = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
     Unidad = "A";
     Unidad = 0851 ? 0;
     |ATRI I;
     |PINTA 1616, "Introduzca un diskette formateado en D.O.S. ...";
     |ATRI i;
     |PINTA 2380, ".";
     |PAUSA;

     Raiz = "";
     |DIRECTORIO Raiz; |QBF Raiz;
     |DFICE Fichero;   |QBF Fichero;
     NFichero  = #0#0;
     NFichero  = "RTPA" + aEjerc;
     Fichero   = Fichero + NFichero;

     |ATRI P;
     |PINTA 1616, "                  Copiando ...                 ";
     |ATRI p;
     |PINTA 2380, ".";

     |QUE_SISTEMA Sistema;
     |SI Sistema ! "ESDOS";
         VAlfa = Raiz + "bin/agcopiaa " + Fichero + " " + Unidad + ":";
         |SYSTEM VAlfa;

         |ATRI P;
         |PINTA 1616, "           FICHERO COPIADO !!!!                 ";
         |ATRI p;
         |PINTA 2380, ".";
         |PAUSA;
     |SINO;
         VAlfa1 = Fichero;
         VAlfa2 = Unidad + ":" + NFichero;

         |COPIA_FICHERO VAlfa1, VAlfa2;
         |SI FSalida ! 0;
             VAlfa3 = "Error [" + FSalida + "] en copia de ficheros ...";
             |PINTA 1616, VAlfa3;
             |PINTA 2380, ".";
             |PAUSA;
         |SINO;
             |ATRI P;
             |PINTA 1616, "           FICHERO COPIADO !!!!                 ";
             |ATRI p;
             |PINTA 2380, ".";
             |PAUSA;
         |FINSI;
     |FINSI;
     |POPV;
|FPRC;

|PROCESO Boton1801;
     |PTEC 824;
|FPRC;

|PROCESO Boton1802;
     |PTEC 825;
|FPRC;

|PROCESO Boton1803;
     |PTEC 826;
|FPRC;

|PROCESO Boton1804;
     |PTEC 827;
|FPRC;

|PROCESO Boton1805;
     |PTEC 828;
|FPRC;

|PROCESO Boton1806;
     |PTEC 806;
|FPRC;

|PROCESO Botones2006;
     |BLANCO 0501 2380;

     |CONTROL_SIMPLE 0, "LBOTON, <F2> Emision Papel Oficial Laser (Directo por impresora) ", 0513, 0754, Boton1801;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F3> Emision Papel Oficial Laser (Vista previa por el Acrobat) ", 0913, 1154, Boton1802;
     nBoton2 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F4> Presentacion Telematica ", 1313, 1554, Boton1803;
     nBoton3 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F6> Directorio Acrobat  ", 1713, 1954, Boton1805;
     nBoton5 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,ESC Cancelar", 2365, 2378, Boton1806;
     nBoton6 = FSalida;

     aF2 = &255 + "824";
     aF3 = &255 + "825";
     aF4 = &255 + "826";
     aF5 = &255 + "827";
     aF6 = &255 + "828";
     aF7 = &255 + "806";
     |PARA; |SI;  |HACIENDO;
         |LEETECLA aTecla;
         |SI aTecla = aF2;  nTecla = 1; eaModoImpre = "I";    |SAL;  |FINSI;
         |SI aTecla = aF3;  nTecla = 1; eaModoImpre = "P";    |SAL;  |FINSI;
         |SI aTecla = aF4;  nTecla = 3;                       |SAL;  |FINSI;
         |SI aTecla = aF6;  |HAZ Acrobat;                            |FINSI;
         |SI aTecla = aF7;  nTecla = 0;   |SAL;  |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton4;
     |FIN_CONTROL_WINDOWS nBoton5;
     |FIN_CONTROL_WINDOWS nBoton6;

     |PULSATECLA;
|FPRC;

|PROCESO CopiaInternet;
     aAlfa      = eaUnidadBasico + "/AEAT";                         |RMKDIR aAlfa;
     aAlfa      = eaUnidadBasico + "/AEAT/INTERNET";                |RMKDIR aAlfa;
     aAlfa      = eaUnidadBasico + "/AEAT/INTERNET/180";            |RMKDIR aAlfa;
     aAlfa      = eaUnidadBasico + "/AEAT/INTERNET/180/" + enAnyo;  |RMKDIR aAlfa;

     aOrigen  = eaUnidadBasico + "/MODELOS/180/" + enAnyo + "/AINTERNET/RTA" + (("00000"  + #0#5) % -105) + ".BUE";
     aDestino = eaUnidadBasico + "/AEAT/INTERNET/180/" + enAnyo + "/" + "RTP" + (("00000" + #0#5) % -105) + ".TXT";
     |RCOPIA_FICHERO aOrigen, aDestino;
     |RFBORRA aOrigen;

     aAlfa = "     Los ficheros generados estan en el directorio \AEAT\INTERNET\180\" + enAnyo;
     |MENAV aAlfa;
|FPRC;

|PROCESO CreaPlanos;
     |DDEFECTO #104;
     treten = 0;
     tperce = 0;

     |HAZ magnetico;

     |SI FEstado ] 0;
         |DDEFECTO #11;
         |HAZ CreaTempos;

         caden = Handle + " " + &#0#95;
         |FGRABA caden;
         |FCIERRA Handle;
     |FINSI;

     |DFICE Directorio;
     Fichero  = "RTPA" + aEjerc + ".car";
     NFichero = Fichero;          |QBF NFichero;
     Fichero  = "wb  "+ Directorio + NFichero;
     |FABRE Fichero;
     |SI FSalida ] 0;
        Maneja = FSalida;
        caden = "1180";
        caden = caden + aEjerc;
        Comodin = #caportad#13; NCar = 9;  Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#16; NCar = 2;  Tipo = "N"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#17; NCar = 3;  Tipo = "N"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#3;  NCar = 2;  Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#4;  NCar = 20; Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#5;  NCar = 5;  Tipo = "N"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#11; NCar = 12; Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#9;  NCar = 2;  Tipo = "N"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#9;  NCar = 2;  Tipo = "N"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #caportad#10; NCar = 3;  Tipo = "N"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #0#1;         NCar = 8;  Tipo = "F"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #0#75;        NCar = 30; Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = #0#90;        NCar = 25; Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        Comodin = ("00000" + #caportad#0) % -105;
                                NCar = 20; Tipo = "A"; |HAZ Recorta; caden = caden + Comodin;
        caden = caden + &13 + &10;
        caden = Maneja + " " + caden; |FGRABA caden;
     |FINSI;
     |FCIERRA Maneja;
|FPRC;

|PROCESO ComoEl2006;
     |HAZ Botones2006;
     |SI nTecla = 0;  |ACABA;  |FINSI;

     |SI nTecla = 1;
         aTercera = "N";
         aAlfa    = "0000NDesea la impresion de la tercera copia  ";
         |CONFI aAlfa;
         |SI FSalida = 0;  aTercera = "S";  |FINSI;
     |FINSI;

     aAlfa      = eaUnidadBasico + "/MODELOS";                             |RMKDIR aAlfa;
     aAlfa      = eaUnidadBasico + "/MODELOS/180";                         |RMKDIR aAlfa;
     aAlfa      = eaUnidadBasico + "/MODELOS/180" + "/" + enAnyo;          |RMKDIR aAlfa;
     aPathLocal = aAlfa + "/";

     |HAZ CreaPlanos;

     |DFICE aDirFic;  |QBF aDirFic;

     aOrigen  = aDirFic + "RTPA" + aEjerc;
     aDestino = aPathLocal + "RTA" + (("00000" + #0#5) % -105) + ".TXT";

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
         |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |FBORRA aOrigen;

     aOrigen  = aDirFic + "RTPA" + aEjerc + ".car";
     aDestino = aPathLocal + "RTB" + (("00000" + #0#5) % -105) + ".TXT";

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
         |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |FBORRA aOrigen;

     eaModelos = "180";
     eaEjer    = enAnyo;
     eaTipoE   =  "RTA" + (("00000" + #0#5) % -105) + ".TXT";
     eaTipoR   =  "RTC" + (("00000" + #0#5) % -105) + ".TXT";
     eaTipoP   =  "PDF" + (("00000" + #0#5) % -105) + ".PDF";

     |SI nTecla = 1;
         eaTipoC =  aTercera;
         eaTipoA =  "RTB" + (("00000" + #0#5) % -105) + ".TXT";
         eaTipoV =  "N";
     |SINO;
         eaTipoV =  "S";
     |FINSI;

     |HAZ LineaShellJava;

     eaFichError  = "rtc";
     eaFichDatos  = "rta";
     eaFichAuxil  = "rtb";

     |SI eaTipoV ! "S";
         enValidacion = 0;
         |HAZ BuscaErroresL;
     |SINO;
         enValidacion = 1;
         |HAZ BuscaErroresL;
         |SI enError ! 0;
             |MENAV "      Ha habido Errores, arreglelos y vuelva a emitir.";
             |ACABA;
         |FINSI;

         |HAZ CopiaInternet;
     |FINSI;
|FPRC;

|PROCESO Bloque2012;
     eaModelos  = "180";
     eaEjer     = enAnyo;

     eaPathLanza = eaUnidad + "\MODELOS";            |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + eaModelos;    |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + eaEjer;       |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\";

     |DBASE eaPathEmision;
     eaPathEmision = eaPathEmision + "emisiones";       |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + eaModelos;   |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + eaEjer;      |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/";

     eaPathInternet = eaUnidad + "/AEAT";                |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/INTERNET";      |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + eaModelos;  |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + eaEjer;     |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/";

     |HAZ Botones_2012;
     |SI eaOpcion = "0";  |ACABA;  |FINSI;

     |DDEFECTO #104;
     treten = 0;
     tperce = 0;

     |HAZ magnetico;

     |SI FEstado ] 0;
         |DDEFECTO #11;
         |HAZ CreaTempos;

         |FGRABA caden;
         |FCIERRA Handle;
     |FINSI;

     |HAZ PresentaPortal;

     |SI eaOpcion = "3";
         |HAZ SacaErrorPtl;

         aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
         |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO Bloque2015;
     eaModelos  = "180";
     eaEjer     = enAnyo;

     eaPathLanza = eaUnidad + "\MODELOS";            |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + eaModelos;    |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + eaEjer;       |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\";

     |DBASE eaPathEmision;
     eaPathEmision = eaPathEmision + "emisiones";       |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + eaModelos;   |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + eaEjer;      |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/";

     eaPathInternet = eaUnidad + "/AEAT";                |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/INTERNET";      |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + eaModelos;  |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + eaEjer;     |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/";

     |HAZ Botones_2015;
     |SI eaOpcion = "0";  |ACABA;  |FINSI;

     |DDEFECTO #104;
     treten = 0;
     tperce = 0;

     |HAZ magnetico;

     |SI FEstado ] 0;
         |DDEFECTO #11;
         |HAZ CreaTempos;

         |FGRABA caden;
         |FCIERRA Handle;
     |FINSI;

     |HAZ PresentaPortal;

     |SI eaOpcion = "3";
         aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
         |MENAV aAlfa;
     |FINSI;
|FPRC;

____________________________________/ LEE LAS EMPRESAS

|PROCESO Tipo3; |TIPO 3;
     |HAZ LeeUnidadBasico;
     eaUnidad = eaUnidadBasico;

     |HAZ PideMoneda;

     aEjerc = "19";
     |SI #0#0 [ 80; aEjerc = "20"; |FINSI;
     aEjerc = aEjerc + (("00" + #0#0) % -102);
     enAnyo = aEjerc;

     #0#4  = "S";
     #0#5  = #30#2;
     #0#6  = #30#2;
     #0#7  = #30#3;
     #0#8  = #30#3;
     #0#70 = "I";
     #0#93 = 13;
     #0#94 = 10;

     |SI enAnyo ] 2006;  |Y enAnyo [ 2011;
         |HAZ ComoEl2006;
         |ACABA;
     |FINSI;

     |SI enAnyo [ 2014;  |HAZ Bloque2012;  |ACABA;  |FINSI;
     |SI enAnyo ] 2015;  |HAZ Bloque2015;  |ACABA;  |FINSI;

     |PARA; |SI Salir = 0; |HACIENDO;
            |SI #0#0 ] 80;
               nAnyo = #0#0 + 1900;
            |SINO;
               nAnyo = #0#0 + 2000;
            |FINSI;
            eaTEjer = nAnyo;
            |MENUG MGeneral;
            MGeneral2 = FSalida;
            Opcion    = MGeneral2;
            Salir     = 1;
            |SI #0#0 ] 80;
               MaxOpc = 4;
            |SINO;
               MaxOpc = 5;
            |FINSI;
            |SI Opcion ] 1; |Y Opcion [ MaxOpc;
                Salir = 0;
                |SI Opcion = 1;  |HAZ Creacion;       |FINSI;
                |SI Opcion = 2;
                   |HAZ Portadas;
                   |SI nAnyo ] 2001;
                       aTipoSec = "180"; |HAZ Errores180;
                       |PUSHV 2002 2278;
                       |CUADRO 2002 2278;
                       |ATRI I; |PINTA 2103, "                     FICHERO UBICADO EN:                                   ";
                       |ATRI S; |PINTA 2144, eaCaminoT; |ATRI 0;
                       |PAUSA;
                       |POPV;
                   |FINSI;

                |FINSI;
                |SI Opcion = 3;  |HAZ Laser; aTipoSec = "180"; |HAZ Errores180; |FINSI;
            |FINSI;
     |SIGUE;
     |ABRE #2;  |CIERRA #2;  |DELINDEX #2;
|FPRC;


|PROCESO PideMoneda;
   Moneda = "E"; |ACABA;
   |PUSHV 1943 2177;
   |BLANCO 1943 2177;
   |CUADRO 1945 2175;
   |ATRI R; |PINTA 1946 , " Seleccione moneda de emision "; |ATRI N;
   |PINTA 2053, "(Pesetas/Euros)";
   |ATRI I; |PINTA 2054, "P"; |PINTA 2062, "E"; |ATRI N;
   E_sup  = 1;
   E_inf  = "EP";
   Moneda = eaMoneda;
   Moneda = 2069 ? 0;
   |POPV;
|FPRC;

|PROCESO Conversion;
   |SI eaMoneda = "P";
      |SI Moneda = "E";
         Cantidad = ((Cantidad / 166.386) ! 2) * 100;
      |FINSI;
   |SINO;
      |SI Moneda = "P";
         Cantidad = (Cantidad * 166.386) ! 0;
      |SINO;
         Cantidad = Cantidad * 100;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO Tipo0C70;  |TIPO 0;
     |C_M #0#76, 1, "S";
     |C_M #0#77, 1, "S";
     |C_M #0#78, 1, "S";
     |C_M #0#79, 1, "S";
     |C_M #0#80, 1, "S";
     |C_M #0#81, 1, "S";
     |C_M #0#82, 1, "S";
     |C_M #0#83, 1, "S";
     |C_M #0#84, 1, "S";
     |C_M #0#85, 1, "S";
     |C_M #0#86, 1, "S";
     |C_M #0#87, 1, "S";
     |C_M #0#88, 1, "S";
     |C_M #0#89, 1, "S";
     |C_M #0#91, 1, "S";
     |C_M #0#92, 1, "S";

     |SI #0#70 = "I";
         |C_M #0#76, 1, "N";
         |C_M #0#77, 1, "N";
         |C_M #0#78, 1, "N";
         |C_M #0#79, 1, "N";
         |C_M #0#80, 1, "N";
         |C_M #0#81, 1, "N";
         |C_M #0#82, 1, "N";
         |C_M #0#83, 1, "N";
         |C_M #0#84, 1, "N";
         |C_M #0#85, 1, "N";
         |C_M #0#86, 1, "N";
         |C_M #0#87, 1, "N";
         |C_M #0#88, 1, "N";
         |C_M #0#89, 1, "N";
         |C_M #0#91, 1, "N";
         |C_M #0#92, 1, "N";
     |FINSI;
|FPRC;

|PROGRAMA;
     |HAZ inicio;

     |CLS;
     |CABEZA "Emision 180 Magn.";
     |DDEFECTO #0;
     |PINPA #0#0;
     |ABRE #0;
     |LEE 101#0p;
     |SI FSalida ! 0;
         |CIERRA #0;  |DELINDEX #0;
         |ABRE #0;
         |GRABA 020#0b;
     |FINSI;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
         |GRABA 020#0a;
     |FINSI;
     |LIBERA #0;
     |CIERRA #0;
|FPRO;
