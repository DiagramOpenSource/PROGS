|FICHEROS;
   caemrcca #0;
   caemrctm #1,MANTE;
   cacuenta #2;
   camancob #3;
   caclipro #4;
   carctxcb #5;
   carctxpi #6;
   caemrctx #7;
|FIN;

|INCLUYE acceso_i;

|VARIABLES;
   &Lugar = "";
   &entrada = 0;
   &Separacion = 7;

   Calc  = 0;
   Linea = 1;
   Comodin = "";
   Comodin1 = "";
   Comodin2 = "";
   MaxDigitos = 0;
   NumLineas = 0;
   Long = "";
   PosParte1 = 0;
   PosParte2 = 0;
   Testigo = 0;
   Digito   = 0;

   HayDatos = 0;

   ContLins = 0;

   &Cab = 0;
   &CabCue = 0;
   &Cue = 0;
   &PieCue = 0;
   &Pie = 0;
   &Separa = 0;

   DFactura = 0;
   HFactura = 0;
   Cont     = 0;
|FIN;

|PROCESO Rellena;
   |DDEFECTO #caemrctm;
   #caemrctm#0 = Linea;
   Linea = Linea + 1;
   #caemrctm#1 = #camancob#2;
   #caemrctm#2 = #camancob#1;
   #caemrctm#3 = #camancob#3;
   #caemrctm#4 = #camancob#4;
   #cacuenta#0 = #camancob#4;
   #cacuenta#1 = #camancob#5;
   |LEE 010#cacuenta.=;
   #caemrctm#5 = #cacuenta#2;
   #caemrctm#6 = #camancob#7;
   #caemrctm#7 = #camancob#8;
   #caemrctm#8 = #camancob#9 + #camancob#10;
   #caemrctm#9 = " ";
   |GRABA 020#caemrctm.n;
|FPRC;

|DEFBUCLE RellenaRecibos;
#camancob#1;
4,7,23,28,11;
01, #0#0, DFactura, 001, #0#2, #0#3, "N", #0#13, #0#15;
99, #0#4, HFactura, 999, #0#6, #0#7, "N", #0#14, #0#16;
e;
NULL,Rellena;
|FIN;

|RUTINA inf;
   #caemrctm#0 = 001;
|FRUT;

|RUTINA sup;
   #caemrctm#0 = 999;
|FRUT;

|PROCESO Marcar; |TIPO 11;
   |SI FSalida = 9;
      |SI #caemrctm#9 = " ";
         #caemrctm#9 = "*";
         HayDatos = HayDatos + 1;
      |SINO;
         #caemrctm#9 = " ";
         HayDatos = HayDatos - 1;
      |FINSI;
      |GRABA 020#caemrctm.a;
   |FINSI;
|FPRC;

|PROCESO TrataCuenta; |TIPO 6;

    MaxDigitos = #canempre#19; Digito = 6;

    |SI #canempre#18 > MaxDigitos; MaxDigitos = #canempre#18; Digito = 5; |FINSI;
    |SI #canempre#17 > MaxDigitos; MaxDigitos = #canempre#17; Digito = 4; |FINSI;
    |SI #canempre#16 > MaxDigitos; MaxDigitos = #canempre#16; Digito = 3; |FINSI;
    |SI #canempre#15 > MaxDigitos; MaxDigitos = #canempre#15; Digito = 2; |FINSI;
    |SI #canempre#14 > MaxDigitos; MaxDigitos = #canempre#14; Digito = 1; |FINSI;

    Comodin = #0Campo;
    Comodin = Comodin - ".";
    |SI FSalida ! 0;
       PosParte1 = ((FSalida - 101) / 100) + 100;
       PosParte2 = FSalida + 198;
       Comodin1 = #0Campo % PosParte1;
       Comodin2 = #0Campo % PosParte2;
       Long = Comodin1 % 0;
       Comodin2 = "000000000000" + Comodin2;
       |QBF Comodin2;
       PosParte2 = (MaxDigitos - Long) + 100;
       PosParte2 = - PosParte2;
       Comodin2 = Comodin2 % PosParte2;
       Comodin = Comodin1 + Comodin2;
       |QBF Comodin;
       #0Campo = Comodin;
       |PINTA #0Campo;
    |SINO;
       |QBF Comodin;
       Long = Comodin % 0;
       Testigo = 0;
       |SI #canempre#19 = Long; Testigo = 1; Digito = 6; |FINSI;
       |SI #canempre#18 = Long; Testigo = 1; Digito = 5; |FINSI;
       |SI #canempre#17 = Long; Testigo = 1; Digito = 4; |FINSI;
       |SI #canempre#16 = Long; Testigo = 1; Digito = 3; |FINSI;
       |SI #canempre#15 = Long; Testigo = 1; Digito = 2; |FINSI;
       |SI #canempre#14 = Long; Testigo = 1; Digito = 1; |FINSI;
       |SI Testigo = 0;
          |MENAV "0400Longitud de cuenta fuera de nivel";
          |ERROR;
       |FINSI;
    |FINSI;

    #0#11 = Digito;
|FPRC;

|PROCESO MiraCliente;
    |ABRE #caclipro;
    #caclipro#23 = "C";
    #caclipro#10 = #0Campo;
    #caclipro#11 = Digito;
    |LEE 010#caclipro.=;
    |SI FSalida ! 0;
       |PUSHV 05012380;
       |PINPA #0#caclipro;
       |PINDA #0#caclipro;
       |CONFI "0400N¨ Dar de alta ?";
       |SI FSalida = 0;
          |ENDATOS #1#caclipro;
          |SI FSalida = 0;
             |GRABA 020#caclipro.n;
          |SINO;
             |ERROR;
          |FINSI;
       |SINO;
          |ERROR;
       |FINSI;
       |POPV;
    |FINSI;
    |CIERRA #caclipro;
|FPRC;

|PROCESO Cabecera;
   ContLins = ContLins + 1;
   |PRINT;
|FPRC;

|DEFBUCLE Cabecera;
#carctxcb#1;
;
#0#12,001;
#0#12,999;
e;
NULL,Cabecera;
|FIN;

|PROCESO Cuerpo;
   |SI #caemrctm#9 = "*";
      |PRINT;
      |SI CabCue = 1;
         CabCue = 0;
      |FINSI;
      ContLins = ContLins + 1;
   |FINSI;
|FPRC;

|DEFBUCLE Cuerpo;
#caemrctm#1;
;
INICIO;
FINAL;
;
NULL,Cuerpo;
|FIN;

|PROCESO Pie;
   |PRINT;
   |SI PieCue = 1; PieCue = 0; |FINSI;
|FPRC;

|DEFBUCLE Pie;
#carctxpi#1;
;
#0#12,001;
#0#12,999;
;
NULL,Pie;
|FIN;

|PROCESO CuentaPies;
   ContLins = ContLins + 1;
|FPRC;

|DEFBUCLE CuentaPies;
#carctxpi#1;
;
#0#12,001;
#0#12,999;
;
NULL,CuentaPies;
|FIN;

|PROCESO MiraSelec;
   |SI #0#17 = "S";
      |PARA Cont = 18; |SI Cont [ 41; |HACIENDO Cont = Cont + 1;
         |C_M #0#Cont#,1,"N";
      |SIGUE;
      |C_M #0#1,1,"S";
      |C_M #0#5,1,"S";
   |SINO;
      |PARA Cont = 18; |SI Cont [ 41; |HACIENDO Cont = Cont + 1;
         |C_M #0#Cont#,1,"S";
      |SIGUE;
      |C_M #0#1,1,"N";
      |C_M #0#5,1,"N";
   |FINSI;
|FPRC;

|PROGRAMA;
   |CLS;
   |HAZ inicio;
   entrada = 1;
   |PINPA #0#0;
   |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida < 0; |ACABA; |FINSI;

   |ABRE #caemrctx;
   #caemrctx#0 = #caemrcca#12;
   |LEE 000#caemrctx.=;
   |SI FSalida = 0;
      NumLineas = #caemrctx#2;
   |FINSI;
   |CIERRA #caemrctx;

   |DELINDEX #caemrctm;
   |ABRE #caemrctm;
   |ABRE #cacuenta;

   |SI #0#17= "S";
      DFactura = #0#1;
      HFactura = #0#5;
      |BUCLE RellenaRecibos;
   |SINO;
      |PARA Cont = 18; |SI Cont [ 41; |HACIENDO Cont = Cont + 1;
         |SI #0#Cont# ! 0;
            DFactura = #0#Cont#;
            HFactura = #0#Cont#;
            |BUCLE RellenaRecibos;
         |FINSI;
      |SIGUE;
   |FINSI;

   |CIERRA #cacuenta;
   |PUSHV 05012380;
   |PINPA #0#1;
   |ATRI R;
   |MENSA "0400<F12> Marcar/Desmarcar";
   |ATRI N;
   |ENTLINEAL #1#1, -1, 4, 21, 0, inf, sup;
   |CIERRA #caemrctm;
   |POPV;
   |SI HayDatos = 0;
      |MENAV "0400Seleccion vacia";
      |ERROR;
      |ACABA;
   |FINSI;
   |IMPRE 0;
   |SI FSalida < 0; |ACABA; |FINSI;
   Lugar = #0#8;
   |QBF Lugar;
   Lugar = (" " * 25) + Lugar;
   Lugar = Lugar % -125;

   |INFOR "caemrccb";
   Cab = 1;
   CabCue = 0;
   Cue = 0;
   PieCue = 0;
   Pie = 0;
   ContLins = 19;
   |BUCLE CuentaPies;
   |BUCLE Cabecera;
   Cab = 0;
   CabCue = 1;
   Cue = 1;
   |BUCLE Cuerpo;

   |PARA; |SI ContLins > NumLineas; |HACIENDO ContLins = ContLins - NumLineas; |SIGUE;

   Calc = NumLineas - Separacion;
   |PARA; |SI ContLins [ Calc; |HACIENDO ContLins = ContLins + 1;
      Cab = 0;
      CabCue = 0;
      Cue = 0;
      PieCue = 0;
      Pie = 0;
      Separa = 1;
      |PRINT;
   |SIGUE;

   Separa = 0;
   CabCue = 0;
   Cue = 0;
   PieCue = 1;
   Pie = 1;
   Cab = 0;
   |BUCLE Pie;

   Separa = 0;
   CabCue = 0;
   Cue = 0;
   PieCue = 0;
   Pie = 0;
   Cab = 0;
   |PIEINF;
   |FININF;
   |FINIMP;

|FPRO;
