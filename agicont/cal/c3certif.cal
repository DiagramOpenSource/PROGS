|FICHEROS;
     c3certif #0;
     caportad #1;
     canempre #30;
     cat18001 #2;
     caman115 #20;
     caportad #1;
|FIN;

|VARIABLES;
      nVarCampo1  = 0;
      nVarCampo1T = 0;
      nVarCampo2  = 0;
      nVarCampo2T = 0;
      nSwError    = 0;
      nLeidos     = 0;
      nDesde      = 0;
      nHasta      = 0;
      nCampo      = 0;
      nSwAcumula  = 0;
      nPag        = 0;
      s1          = 0;
      s2          = 0;
      b1          = 0;
      b2          = 0;
      r1          = 0;
      r2          = 0;
      nSwTraba    = 0;
      nYaEsta1    = 0;
      nYaEsta2    = 0;
      nMeses      = 0;
      nCampoBase  = 0;
      nCampoRete  = 0;
      nCampoBase1 = 0;
      nCampoBase2 = 0;
      nCampoRete1 = 0;
      nCampoRete2 = 0;
      nSwBusca    = 0;

      aDirFich    = "";
      aDCla       = "";
      aHCla       = "";
      aAlfa       = "";
      aAlfa1      = "";
      aAlfa2      = "";

    &r_emp  = 0;
    &r_per  = 0;
    &domemp = "";
    &domtra = "";
    &fletra = "";
    &fprese = "";
    &tbases1 = 0;
    &tbases2 = 0;
    &tbases3 = 0;
    &treten1 = 0;
    &treten2 = 0;
    &treten3 = 0;
    &tdescue = 0;
    &texenta = 0;
    &letrai = 0;
    &dia = 0;
    &mes = "";
    &anyo = 0;
    &nomrep = "";
    &dnirep = "";

    sw_acumula = 0;
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;
    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    para1 = 0;
    para2 = 0;
    para3 = 0;
    para4 = 0;
    FEstado = 0;
    sw_impre = 0;
    nModulo = 0;

    ant_emp = -1;

    &gr     = 0;
    &gb     = 0;
    &hr     = 0;
    &hb     = 0;
    &justi1 = 0;
    &justi2 = 0;
    &periodo = 0;
    &ajusti1 = "";
    &ajusti2 = "";
|FIN;

|INCLUYE acceso_i;

|| *************************************************************************
||                        CALCULOS DE PANTALLA
|| *************************************************************************

|PROCESO Alentrar;  |TIPO 8;
     |HAZ inicio;
|FPRC;

|PROCESO Defecto; |TIPO 7;
     #0#0 = cod2;
     |PINTA #0#0;
|FPRC;

|PROCESO Consulta;
     |SI FSalida ! 9;  |ACABA;  |FINSI;

     |SUB_EJECUTA "caconemp.run";
     |ERROR;

     |SI Campo = 5;
         #0#5 = r_emp;
         #0#7 = r_per;
         |PTEC 802;
         |PTEC 802;
     |FINSI;

     |SI Campo = 6;
         #0#6 = r_emp;
         #0#8 = r_per;
         |PTEC 802;
     |FINSI;

     |SI Campo ] 9;
         #0Campo = r_emp;
         nVarCampo1   = Campo + 20;
         #0nVarCampo1 = r_per;
         |PTEC 802;
         |PTEC 802;
     |FINSI;
|FPRC;

|PROCESO Mayus;
     #0Campo = #0Campo > #0Campo;
     |PINTA #0Campo;
|FPRC;

|PROCESO Mayus1;
     |HAZ Mayus;
     |SI #0Campo = "N";
         |PARA nVarCampo1 = 9;  |SI nVarCampo1 [ 48;  |HACIENDO nVarCampo1 = nVarCampo1 + 1;
               |C_M #0nVarCampo1,1,"S";
         |SIGUE;

         |C_M #0#5,1,"N";  #0#5 = 0;  |PINTA #0#5;
         |C_M #0#7,1,"N";  #0#7 = 0;  |PINTA #0#7;
         |C_M #0#6,1,"N";  #0#6 = 0;  |PINTA #0#6;
         |C_M #0#8,1,"N";  #0#8 = 0;  |PINTA #0#8;
      |SINO;
         |PARA nVarCampo1 = 9;  |SI nVarCampo1 [ 48;  |HACIENDO nVarCampo1 = nVarCampo1 + 1;
               #0nVarCampo1 = 0;
               |C_M #0nVarCampo1,1,"N";
         |SIGUE;

         |C_M #0#5,1,"S";
         |C_M #0#7,1,"S";
         |C_M #0#6,1,"S";
         |C_M #0#8,1,"S";
  |FINSI;
|FPRC;

|| --------------- comprueba desde-hasta empresas ---------------------------

|PROCESO BuscaEmpresa;
     |SI #30#21 = "I"; |ACABA; |FINSI;

     |SI #30#26 ! #0#0;
         nSwError = 3;
         |ACABA;
     |FINSI;

     aDirFich = "";
     |DBASE aDirFich;
     aDirFich = aDirFich + "fich/" + (("00000" + #30#2) % -105) + (("0" + #30#3) % -101) + "/";

     nLeidos = 1;
|FPRC;

|DEFBUCLE canempre_1;
     #30#1;
     ;
     #0#5, nDesde;
     #0#6, nHasta;
     ;
     NULL, BuscaEmpresa;
|FIN;

|PROCESO BucleEmpresa;
     |SI #0#7 > #0#8;
         |MENAV "     ERROR EN INTRODUCCION";
         |ERROR;
         |ACABA;
     |FINSI;

     |SI #0#5 = 0;  |Y #0#6 = 0;  |ACABA;  |FINSI;

     nDesde  = #0#7;
     nHasta  = #0#8;
     nLeidos = 0;
     |BUCLE canempre_1;
     |SI nLeidos = 0;
         |MENAV "    ATENCION SELECCION VACIA";
         |ERROR;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO DesdeHasta;
     |SI #0#6 < #0#5;
         |MENAV "      Error en Introduccion";
         |ERROR;
     |FINSI;
|FPRC;

|| ------------------------------------------------------------------------

|PROCESO Nomodifica;
     |PARA nVarCampo1 = Campo + 1;  |SI nVarCampo1 [ 28;  |HACIENDO nVarCampo1 = nVarCampo1 + 1;
                                          #0nVarCampo1 = 0;  |C_M #0nVarCampo1,1,"N";
           nVarCampo2 = nVarCampo1 + 20;  #0nVarCampo2 = 0;  |C_M #0nVarCampo2,1,"N";
     |SIGUE;
     nVarCampo2 = Campo + 20; #0nVarCampo2 = 0;  |C_M #0nVarCampo2,1,"N";  |PINTA #0nVarCampo2;
|FPRC;

|PROCESO EsBuena; || desde campo de empresas seleccion
     |SI FSalida = 2; |ACABA; |FINSI;
     |SI #0Campo = 0; |HAZ Nomodifica;  |ACABA;  |FINSI;

     |ABRE #30;
     #30#2 = #0Campo;
     #30#3 = 0;
     |LEE 011#30];
     |SI FSalida ! 0;  |O #30#2 ! #0Campo;
         |MENAV "     NO Existe la empresa Contable";
         |ERROR;
     |FINSI;
     |CIERRA #30;
|FPRC;

|PROCESO EsBuena1;
     |SI FSalida = 2;|ACABA;|FINSI;

     nVarCampo1 = Campo - 20;
     |SI #0nVarCampo1 = 0;  |ACABA;  |FINSI;

     |ABRE #30;
     nVarCampo1 = Campo - 20;
     #30#2 = #0nVarCampo1;
     #30#3 = #0Campo;
     |LEE 011#30=;
     |SI FSalida ! 0;
         |MENAV "     NO Existe Periodo en la empresa Contable";
         |CIERRA #30;
         |ERROR;
         |ACABA;
     |FINSI;
     |CIERRA #30;

     |SI #30#21 = "I";
         |MENAV "       Empresa Contable Inactiva";
         |ERROR;
         |ACABA;
     |FINSI;

     nLeidos = 0;
     |HAZ BuscaEmpresa;
     |SI nLeidos = 0;
         |SI nSwError = 1;
             |MENAV "     No existe Modelo 390";
         |FINSI;

         |SI nSwError = 2
             |MENAV "0000No se encuentra el fichero de control Datos Fijos";
         |FINSI;

         |SI nSwError = 3;
             |MENAV "     El a¤o contable NO corresponde ";
         |FINSI;
         |ERROR;
         |ACABA;
     |FINSI;

     nVarCampo1 = Campo + 20;  #0nVarCampo1 = #30#1;  |PINTA #0nVarCampo1;
     nVarCampo1 = Campo - 20;
|FPRC;

|| **********************************************************************
||                       CALCULOS DE IMPRESION
|| **********************************************************************

|PROCESO GrabaTempo1;
     |DDEFECTO #2;
     #2#0   = #20#0;
     #2#7   = #20#7;       || dni
     #2#136 = #20#136;     || Ref. catastral
     |LEE 101#2=;
     FEstado = FSalida;

     |PARA nCampo = 0; |SI nCampo [ 139; |HACIENDO nCampo = nCampo + 1;
           nSwAcumula = 0;
           |SI nCampo ]  23; |Y nCampo [ 126;  nSwAcumula = 1;  |FINSI;
           |SI nSwAcumula = 0;
               #2nCampo = #20nCampo;
           |SINO;
               #2nCampo = #2nCampo + #20nCampo;
           |FINSI;
     |SIGUE;

     #2#0   = #20#0;
     #2#7   = #20#7;         || dni
     #2#135 = #20#135;       || dni

     |SI FEstado = 0;  |GRABA 000#2a;  |FINSI;
     |SI FEstado ! 0;  |GRABA 000#2n;  |FINSI;
     |LIBERA #2;
|FPRC;

|DEFBUCLE caman115;
     #20#1;
     135;
     #30#2, 00000, #30#26, "5";
     #30#2, 99999, #30#26, "5";
     ;
     NULL, GrabaTempo1;
|FIN;

|PROCESO CreaTemporal1;
     |PINTA 2305, "Preparando Temporal por NIF's ... ";
     |ABRE #2;  |CIERRA #2;  |DELINDEX #2;

     |NOPARA;

     |ABRE #2;
     |BUCLE caman115;
     |CIERRA #2;

     |SIPARA;
|FPRC;

____________________________________/ PROCESOS DE LECTURA E IMPRESION
|PROCESO Imprimelo;
     |SI letrai = 0;
         |SI ant_emp = -1;  ant_emp = #2#0;  |FINSI;
         |SI ant_emp ! #2#0;
             justi1 = justi1 + 1;
             justi2 = justi2 - 1;
             |SI justi2 = -1;  justi2 = 6;  |FINSI;
             ant_emp = #2#0;
         |FINSI;
     |FINSI;

     |SI #0#69 = "B";  |INFOR "c3cert01";  |FINSI;
     |SI #0#69 = "O";  |INFOR "c3cert02";  |FINSI;

     ajusti1 = justi1; |QBF ajusti1;
     ajusti1 = ("000000000000" + ajusti1) % -112;
     ajusti2 = justi2; |QBF ajusti2;
     ajusti2 = ("0" + ajusti2) % -101;

     |PRINT;
     |PIEINF;
     |FININF;
     letrai=1;
|FPRC;

|PROCESO CargaImpresion;
     #0#98  = 0;
     #0#99  = 0;
     #0#100 = 0;
     #0#101 = 0;

     |PARA nVarCampo1 = 1; |SI nVarCampo1 [ 12; |HACIENDO nVarCampo1 = nVarCampo1 + 1;
           nVarCampo2 = nVarCampo1 +  22; #0#99  = #0#99  + #2nVarCampo2;
           nVarCampo2 = nVarCampo1 +  35; #0#98  = #0#98  + #2nVarCampo2;
           nVarCampo2 = nVarCampo1 +  48; #0#101 = #0#101 + #2nVarCampo2;
           nVarCampo2 = nVarCampo1 +  61; #0#100 = #0#100 + #2nVarCampo2;
     |SIGUE;

     |SI #0#98 = 0;|Y #0#99 = 0;|Y #0#100 = 0;|Y #0#101 = 0;
         |ACABA;
     |FINSI;

     domemp = #1#4;  |QBF domemp;                        || construye domicilio empresa
     domemp = domemp + " " + #1#5 + " " + #1#7;

     domtra = #2#127;  |QBF domtra;                        || construye domicilio trabajador
     domtra = domtra + " " + #2#128 + " " + #2#130;

     nomrep = #1#39;   |QBF nomrep;
     |SI nomrep = "";
         nomrep = #1#52; |QBF nomrep;
         |SI nomrep ! ""; nomrep = nomrep + " "; |FINSI;
         nomrep = nomrep + #1#51;
         dnirep = #1#53;
     |SINO;
         dnirep = #1#38;
     |FINSI;

     ||SI #2#12 = "1";   gb = #0#99;        gr = #0#98;        |FINSI;
     ||SI #2#12 = "2";   hb = #0#101;       hr = #0#100;       |FINSI;
     ||SI #2#13 = "1";   gb = gb + #0#99;   gr = gr + #0#98;   |FINSI;
     ||SI #2#13 = "2";   hb = hb + #0#101;  hr = hr + #0#100;  |FINSI;

     gb = #0#99;        gr = #0#98;
     hb = #0#101;       hr = #0#100;

     |HAZ Imprimelo;
|FPRC;

|DEFBUCLE cat18001;
     #2#1;
     ;
     #30#2, "            ", "                    ";
     #30#2, "zzzzzzzzzzzz", "zzzzzzzzzzzzzzzzzzzz";
     ;
     NULL, CargaImpresion;
|FIN;

|PROCESO Imprime;
     |BLIN 23;
     |PINTA 2305, "  Imprimiendo";

     nSwTraba = 0;
     |BUCLE cat18001;          || lee trabajadores y calcula el numero de hojas
|FPRC;

|PROCESO HazTodo;
     |PATH_DAT #2  aDirFich;
     |PATH_DAT #20 aDirFich;
     |PATH_DAT #1  aDirFich;

     |ABRE #1;
     #1#0 = #30#2;
     #1#1 = #30#26;
     |LEE 040#1=;
     |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;
     |CIERRA #1;
     enEmpresa = #canempre#2;
     enPeriodo = #canempre#3;
     swOperacion = 0;
     |SUB_EJECUTA "camoneda.tab";

     |HAZ CreaTemporal1;

     |ABRE #20;
     |HAZ Imprime;
     |CIERRA #20;
|FPRC;

|| ---------- Seleccion DESDE / HASTA Empresa.

|PROCESO Leelo;
     aDirFich = "";
     |DBASE aDirFich;
     aDirFich = aDirFich + "fich/" + (("00000" + #30#2) % -105) + (("0" + #30#3) % -101) + "/";

     |SI #30#21 = "I";
         |ACABA;
     |FINSI;

     |HAZ HazTodo;
|FPRC;

|DEFBUCLE canempre_2;
     #30#1;
     26;
     #0#5, #0#7, #0#0;
     #0#6, #0#8, #0#0;
     ;
     NULL, Leelo;
|FIN;

|| *********************************************************************
||                    COMIENZO con TIPO 3
|| *********************************************************************

|PROCESO Fecha;
     aAlfa1 = #0#1;
     aAlfa2 = aAlfa1 %  102;   dia = aAlfa2;         || dia
     aAlfa2 = aAlfa1 % -102;  anyo = aAlfa2;         || a¤o
     aAlfa2 = aAlfa1 %  402;                         || mes

     |SI aAlfa2 = "01";  mes = "ENERO     ";  |FINSI;
     |SI aAlfa2 = "02";  mes = "FEBRERO   ";  |FINSI;
     |SI aAlfa2 = "03";  mes = "MARZO     ";  |FINSI;
     |SI aAlfa2 = "04";  mes = "ABRIL     ";  |FINSI;
     |SI aAlfa2 = "05";  mes = "MAYO      ";  |FINSI;
     |SI aAlfa2 = "06";  mes = "JUNIO     ";  |FINSI;
     |SI aAlfa2 = "07";  mes = "JULIO     ";  |FINSI;
     |SI aAlfa2 = "08";  mes = "AGOSTO    ";  |FINSI;
     |SI aAlfa2 = "09";  mes = "SEPTIEMBRE";  |FINSI;
     |SI aAlfa2 = "10";  mes = "OCTUBRE   ";  |FINSI;
     |SI aAlfa2 = "11";  mes = "NOVIEMBRE ";  |FINSI;
     |SI aAlfa2 = "12";  mes = "DICIEMBRE ";  |FINSI;
|FPRC;

____________________________________/ LEE LAS EMPRESAS
|PROCESO Tipo3; |TIPO 3;
     justi1 = #0#70;
     justi2 = #0#71;

     periodo = #0#0;
     |SI periodo < 80;
         periodo = 2000 + periodo;
     |SINO;
         periodo = 1900 + periodo;
     |FINSI;

     |HAZ Fecha;

     |IMPRE 0;
     |SI #0#4 = "S";
         |BUCLE canempre_2;
     |SINO;
         |PARA nVarCampo1T = 9;  |SI nVarCampo1T [ 28;  |HACIENDO nVarCampo1T = nVarCampo1T + 1;
               |SI #0nVarCampo1T = 0;  |SAL;  |FINSI;
               nVarCampo2T = nVarCampo1T + 20;

               #0#5 = #0nVarCampo1T;
               #0#6 = #0nVarCampo1T;
               #0#7 = #0nVarCampo2T;
               #0#8 = #0nVarCampo2T;
               |BUCLE canempre_2;
         |SIGUE;
     |FINSI;
     |FINIMP;
|FPRC;
