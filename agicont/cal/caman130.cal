|FICHEROS;
    caman130 #0;         || Mant. modelo 130
    caexistl #1;         || Estructura Existencias (lin)
    cacuenta #2;         || Plan Contable
    caplctac #3;         || Planilla cuentas a 130 (cab)
    caplctal #4;         || Planilla cuentas a 130 (lin)
    caportad #8;         || Portada modelos

    caman130@ #1130;
|FIN;

|VARIABLES;

  nInkey = 0;
  nDP = 0;
  nHP = 0;
  cont = 0;
  FEstado = 0;
    act_nor   = 0;
    x         = 0;
    xx = 0;
    y = "";
    campo     = 0;
    empreos   = 0;
    activid   = 0;
    periodo   = 0;
    ejercic   = 0;
    v_anter   = 0;
    f_anter   = 0;
    c_anter   = 0;
    i_anter   = 0;
    r_anter   = 0;
    p_anter   = 0;
    e_anter   = "";
    coefi_g   = 0;
    ventas    = 0;
    activi_g  = 0;
    sw_130    = 0;
    sw_esta   = 0;
    cuota     = 0;
    &d_mes = 0;
    &h_mes = 0;
    &estru = 0;
    &r_emp = 0;
    &r_per = 0;
    &r_eje = 0;
    &r_nom = "";
    exini = 0;
    exfin = 0;
    cc1 = 0;
    cc2 = 0;
    cc3 = 0;
    cc4 = 0;
    cc5 = 0;
    compra = 0;
    retenc = 0;
  uno = "";
  dos = "";
  sumactas = 0;
  scta = 0;
  cta = "";
  aAlfa1 = "";
  aAlfa2 = "";
  aAlfa3 = "";
  aAlfa4 = "";
  aAlfa5 = "";

    nImporte = 0;
    nSwNeg   = 0;
    nSumaD   = 0;
    aBase    = "";
    aMas     = "";
    nHPer    = 0;

    modo     = 0;
    nEjer    = 0;
    nPanta   = 0;
    nTope        = 0;
    nTopeAgrario = 0;
    nSuma        = 0;
    nEl27        = 0;
    nNume1       = 0;
    enNume       = 0;

   nSiGrabo      = 0;
   nHay          = 0;

|FIN;

|INCLUYE acceso_i;
|INCLUYE i_vareos;
|INCLUYE varnue_i;

|| ---- Procesos de Campos de Clave
|PROCESO Tipo8; |TIPO 8;
    |HAZ inicio;
    |HAZ eVarEmpresa;

    |SI enEjercicio = 2015;
        |HAZ eVerM130_2015;
    |FINSI;
|FPRC;


|PROCESO empresa; |TIPO 0;
  cont = (FEntrada / 100) ! 0;
  |ABRE #8;
  |DDEFECTO #8;
  #8#0 = #30#2;
  #8#1 = #30#26;
  |LEE 000#8=;
  |SI FSalida ! 0;
      |MENAV "    No encontrado Fichero Portadas Modelos";
      |ERROR;
  |SINO;
      |SI #8#82 ! "P"; |Y #8#82 ! "E";
          |MENAV "    Esta Empresa no realiza el Modelo 130 ";
          |ERROR;
      |FINSI;
 |FINSI;
 |CIERRA #8;
|FPRC;

|PROCESO def_any; |TIPO 7;
  #0#0 = cod1;
  #0#1 = 1;
  #0#34 = #30#1;
  #0#3 = #30#26; |PINTA #0#3;
|FPRC;

|PROCESO i_archiv; |TIPO 7;
  |SI #0#5 ! "S";  |ACABA;  |FINSI;
  |AVISO;
  |CONFI "2400NEste Modelo ya esta Impreso, Desea Modificarlo : ";
  |SI FSalida = 0;
      |AVISO;
      |CONFI "2400NEsta Seguro? : ";
      |SI FSalida ! 0;
          |PTEC 807;
      |SINO;
          #0#5 = "N"; |PINTA #0#5;
      |FINSI;
  |SINO;
      |PTEC 807;
  |FINSI;
|FPRC;

|PROCESO Comple; |TIPO 0;
 aAlfa1 = "N"; |SI #0#38 = "S"; aAlfa1 = "S"; |FINSI;
 |C_M #0#39,1,aAlfa1;
 |C_M #0#40,1,aAlfa1;
 |C_M #0#45,1,aAlfa1;

 |SI #0#38 ! "S";
     #0#39 = ""; |PINTA #0#39;
     #0#40 = ""; |PINTA #0#40;
     #0#45 = ""; |PINTA #0#45;
 |FINSI;
|FPRC;

|PROCESO esta_super; |TIPO 2;
  |SI #0#2 = 4; |ACABA; |FINSI;
  |SI cont = 1; |ACABA; |FINSI;
  |SALVA_DATOS #0;
  sw_esta   = 0;
  empreos   = #0#0;
  activid   = #0#1;
  periodo   = #0#2;
  ejercic   = #0#3;
  #0#2 = #0#2 + 1;
  |LEE 040#0=;
  |SI FSalida = 0; sw_esta = 1; |FINSI;
  #0#0 = empreos;
  #0#1 = activid;
  #0#2 = periodo;
  #0#3 = ejercic;
  |LIBERA #0;
  |LEE 140#0=;
  |SI FSalida ! 0;
      |DDEFECTO #0;
      #0#0 = empreos;
      #0#1 = activid;
      #0#2 = periodo;
      #0#3 = ejercic;
  |FINSI;
  |SI sw_esta = 1;
    |MENAV "    Ya existe registro con un PERIODO superior";
    |ERROR;
  |FINSI;
  |REPON_DATOS #0;
|FPRC;

|PROCESO existenc; |TIPO 0;
  |SI FSalida ! 9; |ACABA; |FINSI;
    d_mes = 0 + (#0#2 - 1) * 3;
    h_mes = 3 + (#0#2 - 1) * 3;
    estru = #8#88;
    r_emp = #30#2;
    r_per = #30#3;
    r_eje = #30#26;
    r_nom = #30#1;
    |QBF r_nom;
    r_nom = r_nom % A120;
    y = #0#2;
    r_nom = r_nom + " - " + y + "§ trimestre";
  |SUB_EJECUTA "caexicon.run";
  |HAZ lee_exist;
|FPRC;

|PROCESO antes; |TIPO 7;
  campo = Campo;
|FPRC;

|PROCESO nomodi; |TIPO 7;
  |CAMPO_MODIFICA #0#06, 1, "S";
  |CAMPO_MODIFICA #0#09, 1, "S";
  |CAMPO_MODIFICA #0#11, 1, "S";
  |CAMPO_MODIFICA #0#12, 1, "S";
  |CAMPO_MODIFICA #0#15, 1, "S";
  |CAMPO_MODIFICA #0#17, 1, "S";
||  |CAMPO_MODIFICA #0#19, 1, "S"; || 1% Ventas
  |CAMPO_MODIFICA #0#20, 1, "S"; || % de gastos
  |CAMPO_MODIFICA #0#23, 1, "S";
  |CAMPO_MODIFICA #0#28, 1, "S";
  |CAMPO_MODIFICA #0#30, 1, "S";
  |CAMPO_MODIFICA #0#36, 1, "S";
  |CAMPO_MODIFICA #0#37, 1, "S";
  |CAMPO_MODIFICA #0#48, 1, "S";
  |CAMPO_MODIFICA #0#49, 1, "S";

  |SI #0#3 < 80;
      nEjer = 2000 + #0#3;
  |SINO;
      nEjer = 1900 + #0#3;
  |FINSI;
  |SI nEjer < 2010; |O nEjer > 2015;
      |C_M #0#48, 1, "N"; #0#48 = "N";
      |C_M #0#49, 1, "N"; #0#49 = 0;
  |FINSI;
  |SI #8#83 = "S";
      |CAMPO_MODIFICA #0#06, 1, "N";
      |CAMPO_MODIFICA #0#09, 1, "N";
      |CAMPO_MODIFICA #0#11, 1, "N";
      |CAMPO_MODIFICA #0#12, 1, "N";
      |CAMPO_MODIFICA #0#15, 1, "N";
      |CAMPO_MODIFICA #0#17, 1, "N";
   ||   |CAMPO_MODIFICA #0#19, 1, "N"; || 1% Ventas
      |CAMPO_MODIFICA #0#20, 1, "N"; || % coeficientes gastos
      |CAMPO_MODIFICA #0#23, 1, "N";
      |CAMPO_MODIFICA #0#28, 1, "N";
      |CAMPO_MODIFICA #0#37, 1, "N";
      |CAMPO_MODIFICA #0#48, 1, "N";
      |CAMPO_MODIFICA #0#49, 1, "N";
      |PARA x = 6; |SI x [ 28; |HACIENDO x = x + 1;
            #0x = 0;
      |SIGUE;
      #0#37 = 0;
      #0#48 = "N";
      #0#49 = 0;
      |PINDA #0#0;
  |SINO;
      |CAMPO_MODIFICA #0#30, 1, "N";
      |CAMPO_MODIFICA #0#36, 1, "N";
      #0#30 = 0;
      #0#31 = 0;
      #0#36 = 0;
      |PINDA #0#0;
  |FINSI;
  |SI #8#83 = "S"; |ACABA; |FINSI;
  |SI #8#81 = "B";
      |CAMPO_MODIFICA #0#20, 1, "S";
      coefi_g = #8#86;
  |SINO;
       |CAMPO_MODIFICA #0#20, 1, "N";
       coefi_g = 0;
  |FINSI;
  cont = (FEntrada / 100) ! 0;
  |SI cont = 1;
      #0#20 = coefi_g; |PINTA #0#20;
  |FINSI;
|FPRC;

|PROCESO sumaex;
  exini = exini + #1cc1;
  exfin = exfin + #1cc2;
|FPRC;

|DEFBUCLE lineas;
 #1#1;
 ;
 #8#88, 01;
 #8#88, 99;
 e;
 NULL, sumaex;
|FIN;

|PROCESO lee_exist;
  |SI #8#83 = "S"; |ACABA; |FINSI;
  |ABRE #1;
  exini = 0;
  exfin = 0;
  |SI #0#2 = 1; cc1 = 11; cc2 = 14;  |FINSI;
  |SI #0#2 = 2; cc1 = 14; cc2 = 17;  |FINSI;
  |SI #0#2 = 3; cc1 = 17; cc2 = 20;  |FINSI;
  |SI #0#2 = 4; cc1 = 20; cc2 = 23;  |FINSI;
  |BUCLE lineas;
  #0#9  = exfin;
  #0#15 = exini;
  |PINTA #0#9;
  |PINTA #0#15;
|FPRC;

|PROCESO LaReduccion;
 |C_M #0#48, 0, aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 aAlfa1 = #0#48;  |C_M #0#49,1,aAlfa1;
 |SI #0#48 = "N"; #0#49 = 0; |PINTA #0#49;  |FINSI;
|FPRC;

|PROCESO Crea2015;
   |C_M #0#49, 0, aAlfa1;
   |SI aAlfa1 = "N"; |ACABA; |FINSI;

   |SI FSalida = 2; |ACABA; |FINSI;

   |SI #0#3 = 15;
       |SI #0#49 ! 0;
           aAlfa1 = "0000SImporte en Reduc.creacion empleo y ejercicio 2015 incompatibles. Modifiquela. ";
           |CONFI aAlfa1;
           |SI FSalida = 0;
               |ERROR;
           |FINSI;
       |SINO;
            #0#48 = "N"; |PINTA #0#48;
       |FINSI;
   |FINSI;
|FPRC;

|PROCESO MRedEmpleo; |TIPO 3;
      |SI #0#3 = 15;
          |SI #0#49 ! 0;
              |MENAV "0000Hay Importe en la Reduccion por creacion de empleo, no es correcto para Ejer. 2015.";
          |SINO;
              #0#48 = "N";
          |FINSI;
      |FINSI;
|FPRC;
|| **********************************************************************

|PROCESO dsmod130;

     |SI #1130#3 = 8;  |Y #1130#2 = 1;
          nImporte = #1130#29;
     |SINO;
          nImporte = #1130#46;
     |FINSI;

     |SI nImporte < 0; nSwNeg = 1; |FINSI;

     |SI nImporte ] 0;  |Y nSwNeg = 0; |ACABA;  |FINSI;

     nSumaD = nSumaD + #1130#42;

     |SI nImporte < 0;
         #0#43 = #0#43 + -nImporte;
     |SINO;
         #0#43 = #0#43 - #1130#42;
         |SI #0#43 [ 0; nSwNeg = 0; #0#43 = 0; nSumaD = 0; |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsmod130;
     #1130#1004;
     ;
     #0#0, #0#1,     1, #0#3;
     #0#0, #0#1, nHPer, #0#3;
     ;
     NULL, dsmod130;
|FIN;

|PROCESO CapturaNegativos130;
     |SI #0#42 [ 0;  |ACABA;  |FINSI;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/caman130.mas";
     |CARGA_DEF aMas, caman130@;

     nSwNeg   = 0;
     nSumaD   = 0;
     #0#43    = 0;
     nHPer    = #0#2 - 1;
     |BUCLE dsmod130;

     |DESCARGA_DEF #caman130@;
|FPRC;

|PROCESO dsmod130Tope;
     nTopeAgrario = nTopeAgrario + #1130#47;
|FPRC;

|DEFBUCLE dsmod130Tope;
     #1130#1004;
     ;
     #0#0, #0#1,     1, #0#3;
     #0#0, #0#1, nHPer, #0#3;
     ;
     NULL, dsmod130Tope;
|FIN;

|PROCESO CapturaTopeAgrario;
     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/caman130.mas";
     |CARGA_DEF aMas, caman130@;

     nTopeAgrario = 0;
     nHPer        = #0#2 - 1;
     |BUCLE dsmod130Tope;

     |DESCARGA_DEF #caman130@;
|FPRC;

|| ************************************************************************

|PROCESO CalculaDed130;
     |SI nEjer < 2008;
         #0#41 = 0;
         #0#42 = 0;
         #0#43 = 0;
         #0#44 = 0;
         #0#47 = 0;
         |ACABA;
     |FINSI;

     #0#42 = #0#29 - #0#41;

     |SI #0#42 [ 0;
         #0#43 = 0;
         #0#47 = 0;
         |ACABA;
     |FINSI;

     |SI nEjer = 2008;
         |SI #0#2 > 1;
             |HAZ CapturaNegativos130;
         |SINO;
             #0#41 = 0;
             #0#42 = 0;
             #0#43 = 0;
             #0#44 = 0;
             #0#47 = 0;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI nEjer ] 2009;
         |SI #0#2 ! 1;
             |HAZ CapturaNegativos130;
         |FINSI;
     |FINSI;

     nSuma = #0#43 + #0#47;
     |SI nSuma > #0#42;
         |SI #0#43 > #0#42;
             #0#43 = #0#42;
             #0#47 = 0;
             |ACABA;
         |FINSI;

         #0#47 = #0#42 - #0#43;
     |FINSI;
|FPRC;

|PROCESO AntesMino; |TIPO 7;
     |SI #0#3 ] 15;
         |MENSA "0000<F7> Introducir Rendimiento Ejer. Anterior para Minoracion";
     |FINSI;
|FPRC;

|PROCESO NuevoCal;
   |BLIN 4;
   nInkey = FSalida;
   |SI nInkey = 15; |Y  #0#3 ] 15; |Y Campo = 41;
       enMod130 = 130;
       enEmp130 = #0#0;
       enEje130 = #0#3;
       |SUB_EJECUTA "eosz0099";
       |HAZ calcular;
   |FINSI;

   |SI Campo ! 47;
       |HAZ CalculaDed130;
   |FINSI;

   #0#44 = #0#42 - #0#43 - #0#47;
   #0#46 = #0#44 - #0#45;

   |PINTA #0#41;
   |PINTA #0#42;
   |PINTA #0#43;
   |PINTA #0#44;
   |PINTA #0#46;
   |PINTA #0#47;
|FPRC;

|PROCESO dsmod130hay;
 nHay = 1;
|FPRC;

|DEFBUCLE dsmod130hay;
     #1130#1004;
     ;
     #0#0, #0#1,     1, #0#3;
     #0#0, #0#1, nHPer, #0#3;
     ;
     NULL, dsmod130hay;
|FIN;

|PROCESO BuscoOtra;
     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/caman130.mas";
     |CARGA_DEF aMas, caman130@;

     nHPer = #0#2 - 1;
     nHay  = 0;
     |BUCLE dsmod130hay;

     |DESCARGA_DEF #caman130@;
     |SI nHay = 0;
         nSiGrabo = 1;
         |SI #0#2 = 2; aAlfa2 = "01.04."; |FINSI;
         |SI #0#2 = 3; aAlfa2 = "01.07."; |FINSI;
         |SI #0#2 = 4; aAlfa2 = "01.10."; |FINSI;
         aAlfa2   = aAlfa2 + aAlfa1;
         efFec130 = aAlfa2;
     |FINSI;
|FPRC;

|PROCESO ParaCalMinoracion;
  nSiGrabo = 0;
  |SI nEjer ] 2010;
      aAlfa1 = nEjer;
      |SI #0#2 = 1;
          nSiGrabo = 1;
          aAlfa2   = "01.01." + aAlfa1;
          efFec130 = aAlfa2;
      |SINO;
          |HAZ BuscoOtra;
      |FINSI;
  |FINSI;
  |SI nSiGrabo = 1;
      enMod130 = 130;
      enEje130 = #0#3;
      enEmp130 = #0#0;
      enAct130 = 1;
      enPer130 = #0#2;
      enRend_NoAgr = #0#22;
      enRend_Agr   = #0#30;
      |HAZ eGrabadsmom094;
  |FINSI;
|FPRC;

|PROCESO calcular; |TIPO 0;
  #0#8  = #0#6 + #0#7;
  #0#11 = #0#9;
  #0#14 = #0#12 + #0#13;

  |SI #0#16 ! 0; #0#17 = #0#16; |SINO; #0#17 = #0#15; |FINSI;
  #0#18 = #0#8 + #0#11 - #0#14 - #0#17;

  |SI #8#81 = "B";
      #0#21 = #0#18 % #0#20;
      #0#19 = 0;
  |SINO;
      |SI #8#82 = "P"; #0#19 = #0#8 % 1; |SINO; #0#19 = 0; |FINSI;
      #0#21 = 0;
  |FINSI;
  |SI #0#3 ] 98; |O #0#3 [ 40; #0#19 = 0; |FINSI;

  |SI #0#18 < 0; #0#19 = 0; #0#21 = 0; |FINSI;

  |SI #0#21 > 2000; |Y #0#3 ] 15;
      #0#21 = 2000;
  |FINSI;

  #0#22 = #0#18 - #0#19 - #0#21;

  |SI #0#48 = "S"; |Y #0#22 > 0;  ||nuevo
    |SI Campo < 22; |O Campo = 48;
        #0#49 = #0#22 % 20;
    |FINSI;
  |SINO;
     #0#49 = 0;
  |FINSI;


  #0#22 = #0#22 - #0#49;

  #0#25 = #0#23 + #0#24;

  |SI #8#87 = 1; #0#26 = #0#18; |SINO; #0#26 = #0#22; |FINSI;

  #0#26 = #0#26 + #0#37;

  #0#27 = #0#26 % 20;
  #0#31 = #0#30 % 2;

  #0#29 = #0#27 - #0#28 - #0#25
  |SI #0#29 < 0; #0#29 = 0; |FINSI;

  cuota = #0#31 - #0#36;
  |SI cuota < 0; cuota = 0; |FINSI;

  #0#29 = #0#29 + cuota;
  |SI #0#29 < 0; #0#29 = 0; |FINSI;

   modo = (FEntrada / 100) ! 0;
   |SI modo = 1;
       #0#41 = 0; #0#42 = 0;
       #0#43 = 0; #0#44 = 0;
   |FINSI;

   |SI #0#3 < 80;
       nEjer = 2000 + #0#3;
   |SINO;
       nEjer = 1900 + #0#3;
   |FINSI;
   |HAZ ParaCalMinoracion;

   |SI nEjer ] 2010;
       enSwApli = 0;
       enEmp130 = #0#0;
       enEje130 = #0#3;
       enPer130 = #0#2;
       enMod130 = 130;
       enRend_NoAgr = #0#22;
       enRend_Agr   = #0#30;
       |HAZ eLeeAplica;
   |SINO;
       eaAplica1 = #8#103;
       eaAplica2 = #8#105;
       enAplica3 = 0;
   |FINSI;

   |SI nEjer = 2008; |Y eaAplica1 = "S";
       |SI #0#2 = 2;  #0#41 = 200;  |FINSI;
       |SI #0#2 = 3;  #0#41 = 100;  |FINSI;
       |SI #0#2 = 4;  #0#41 = 100;  |FINSI;
   |FINSI;

   |SI nEjer = 2009; |Y eaAplica1 = "S";
       |SI #0#2 = 1;  #0#41 = 100;  |FINSI;
       |SI #0#2 = 2;  #0#41 = 100;  |FINSI;
       |SI #0#2 = 3;  #0#41 = 100;  |FINSI;
       |SI #0#2 = 4;  #0#41 = 100;  |FINSI;
   |FINSI;

   |SI nEjer ] 2010;
       |SI eaAplica1 = "S";
           #0#41 = enApli400;
       |SINO;
           #0#41 = 0;   || Puesto por Manolo Tiquet 700000-5276
       |FINSI;
   |FINSI;

    #0#47 = 0;
    |SI nEjer ] 2009; |Y eaAplica2 = "S";
         |SI #0#22 > 0;
             #0#47 = #0#22 % 2;
             |SI enAplica3 = 0;
                 |SI #0#47 > 660.14;
                     #0#47 = 660.14;
                 |FINSI;
             |SINO;
                 |SI #0#47 > 440;
                     #0#47 = 440;
                 |FINSI;
             |FINSI;
         |SINO;
             |SI #0#30 > 0;
                 #0#47 = #0#30 % 2;
                 |HAZ CapturaTopeAgrario;
                 |SI enAplica3 = 0;
                     nTope = 660.14 - nTopeAgrario;
                 |SINO;
                     nTope = 440 - nTopeAgrario;
                 |FINSI;
                 |SI nTope < 0;  nTope = 0;  |FINSI;
                 |SI #0#47 > nTope;
                     #0#47 = nTope;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |HAZ NuevoCal;

     |PINDA #0#0;
|FPRC;


|| ----------- programa de la captura
|PROCESO AntesAgr1;
   v_anter = v_anter +  #0#30;
   r_anter = r_anter +  #0#36;
|FPRC;

|DEFBUCLE AntesAgr;
 #0#1;
 ;
 empreos, activid, nDP, ejercic;
 empreos, activid, nHP, ejercic;
 e;
 NULL, AntesAgr1;
|FIN;

|PROCESO Casilla5;
     p_anter = 0;

     |SI #0#3 ] 80;
         nEjer = 1900 + #0#3;
     |SINO;
         nEjer = 2000 + #0#3;
     |FINSI;

     |SI nEjer [ 2008;
         #0#0  = empreos;
         #0#1  = activid;
         #0#2  = periodo - 1;
         #0#3  = ejercic;
         |LEE 040#0=;
         |SI FSalida = 0;
             p_anter = #0#28 + #0#29;
         |FINSI;

         |ACABA;
     |FINSI;

     nHPer   = periodo - 1;
     |PARA nNume1 = 1; |SI nNume1 [ nHPer; |HACIENDO nNume1 = nNume1 + 1;
           |DDEFECTO #0;
           #0#0  = empreos;
           #0#1  = activid;
           #0#2  = nNume1;
           #0#3  = ejercic;
           |LEE 040#0=;
           |SI FSalida = 0;
               nEl27   = 0;
               |SI #0#27 > 0;
                   nEl27 = #0#27;
               |FINSI;

               enNume  = nEl27 - #0#28 - #0#25;
               |SI enNume < 0; enNume = 0; |FINSI;

               p_anter = p_anter + (enNume - #0#47);
           |FINSI;
     |SIGUE;
|FPRC;

|PROCESO anterior;
  |SI #8#83 = "N";
      |HAZ Casilla5;

      #0#0  = empreos;
      #0#1  = activid;
      #0#2  = periodo - 1;
      #0#3  = ejercic;
      |LEE 040#0=;
      |SI FSalida = 0;
          v_anter = #0#8;
          f_anter = #0#11;
          c_anter = #0#14;
          i_anter = #0#17;
          r_anter = #0#25;
          e_anter = #0#48;
      |FINSI;
  |SINO;
       v_anter = 0;
       r_anter = 0;
       nDP = 1; nHP = periodo - 1;
       |BUCLE AntesAgr;
  |FINSI;

  #0#0  = empreos;
  #0#1  = activid;
  #0#2  = periodo;
  #0#3  = ejercic;
|FPRC;

|PROCESO cal_ctas2;

   cc3 = 9;
   cc5 = 18 + (periodo - 1) * 9;

   |SI #4#4 = "H";
       cc3 = cc3 + 1;
       cc5 = cc5 + 1;
   |FINSI;

   |SI #4#4 = "S";
       cc3 = cc3 + 2;
       cc5 = cc5 + 2;
   |FINSI;

   scta = 0;
   |PARA cc4 = cc3; |SI cc4 [ cc5; |HACIENDO cc4 = cc4 + 3;
         scta = scta + #2cc4;
   |SIGUE;

   |SI #4#3 = "I"; |Y #4#4 = "S";
       scta = - scta;
   |FINSI;

   sumactas = sumactas + scta;
|FPRC;

|DEFBUCLE lee_ctas;
 #2#1;
 3;
 #4#2, 0, "S";
 dos,  9, "S";
 e;
 NULL, cal_ctas2;
|FIN;

|PROCESO cal_ctas1;
   sumactas = 0;
   |SI #4#4 = "*"; |ACABA; |FINSI;
   uno = #4#2;
   |QBF uno;
   dos = uno + "999999999999";
   dos = dos % A112;
   |BUCLE lee_ctas;
   |SI #4#3 = "I";
       ventas = ventas + sumactas;
   |FINSI;
   |SI #4#3 = "G";
       compra = compra + sumactas;
   |FINSI;
   |SI #4#3 = "R";
       retenc = retenc + sumactas;
   |FINSI;
|FPRC;

|DEFBUCLE ctas_130;
 #4#1;
 ;
 #8#88, 001;
 #8#88, 999;
 e;
 NULL, cal_ctas1;
|FIN;

|PROCESO pon_cero;
   exini = 0;
   exfin = 0;
   e_anter = #8#114;
   v_anter = 0;
   f_anter = 0;
   c_anter = 0;
   i_anter = 0;
   r_anter = 0;
   p_anter = 0;
   ventas = 0;
   compra = 0;
   retenc = 0;
|FPRC;

|PROCESO crea_130;

  |HAZ pon_cero;

  |SI periodo ! 1;
      |HAZ anterior;
  |FINSI;

  |SI #8#83 = "N";
      |HAZ lee_exist;
  |FINSI;

  |BUCLE ctas_130;
  #0#0  = empreos;
  #0#1  = activid;
  #0#2  = periodo;
  #0#3  = ejercic;
  |LEE 040#0=;
  |SI FSalida ! 0; |DDEFECTO #0; #0#48 = e_anter; |FINSI;

  #0#0  = empreos;
  #0#1  = activid;
  #0#2  = periodo;
  #0#3  = ejercic;
  |SI #8#83 = "N";

      #0#8  = ventas;   #0#7  = v_anter;

      #0#11  = exfin;   #0#10 = f_anter;

      #0#14 = compra;   #0#13 = c_anter;

      #0#17 = exini;    #0#16 = i_anter;

      #0#25 = retenc;   #0#24 = r_anter;
      #0#28 = p_anter;

      #0#6 = #0#8 - #0#7;    || Ventas
      #0#9 = #0#11;
      #0#12 = #0#14 - #0#13; || Compras
      #0#15 = #0#17;
      #0#23 = #0#25- #0#24;

      coefi_g = 0; |SI #8#81 = "B"; coefi_g = #8#86;|FINSI;
      #0#20 = coefi_g;
  |SINO;

      #0#30 = ventas - v_anter;
      #0#36 = retenc - r_anter;

  |FINSI;
  |HAZ calcular;
  |GRABA 040#0a;
|FPRC;

|| ===== Anula los registros seleccionados

|PROCESO borrando;
   #0#22 = 0;
   #0#30 = 0;
   |HAZ ParaCalMinoracion;
   |BORRA 020#0a;
|FPRC;

|DEFBUCLE borra;
 #0#1;
 ;
 empreos, activid, #0#2, ejercic;
 empreos, activid, #0#2, ejercic;
 e;
 NULL, borrando;
|FIN;


|PROCESO recogida; |TIPO 0;

  |SI FSalida = 2; |ACABA; |FINSI;

  cont = (FEntrada / 100) ! 0;
  |SI cont ! 1; |ACABA; |FINSI;

  empreos = cod1;
  activid = 1;
  periodo = #0#2;
  ejercic = #0#3;
  |LEE 000#0=;
  |SI FSalida = 0;
      |AVISO;
      |CONFI "2400NEl 130 ya Existe, Recalcular S/N : ";
      |SI FSalida = 0;
          |BORRA 020#0a;
      |SINO;
          |ACABA;
      |FINSI;
  |FINSI;


  |ATRI P;
  |MENSA "    ***** CALCULANDO *****";
  |ATRI 0;
  |HAZ crea_130;
  |BLIN 4;

|FPRC;

|CALCULO tipo13; |TIPO 13;
 modo  = (FEntrada / 100) ! 0;
 |SI modo < 1; |ACABA; |FINSI;

 |SI #0#3 < 80;
     nEjer = 2000 + #0#3;
 |SINO;
     nEjer = 1900 + #0#3;
 |FINSI;

 |SI nEjer [ 2007;  nPanta = 1; |FINSI;
 |SI nEjer ] 2008;
     nPanta = 2;
     |SI nEjer = 2008; |Y #0#2 = 1;
         nPanta = 1;
     |FINSI;
 |FINSI;

 |SI nPanta = 2;
     |C_V #0#41,1, "S"; |C_M #0#41,1,"S";
     |C_V #0#42,1, "S"; |C_M #0#42,1,"S";
     |C_V #0#43,1, "S"; |C_M #0#43,1,"S";
     |C_V #0#44,1, "S"; |C_M #0#44,1,"S";
     |C_V #0#47,1, "S";
     aAlfa1 = "Minoracion ......:           ³";
     aAlfa2 = "Diferencia ......:           ³";
     aAlfa3 = "Reg.Negativos Ant:           ³";
     aAlfa4 = "Prestamo Viv.Hab.:           ³";
     aAlfa5 = "Total ...........:           ³";
 |SINO;
     |C_V #0#41,1, "N"; |C_M #0#41,1,"N";
     |C_V #0#42,1, "N"; |C_M #0#42,1,"N";
     |C_V #0#43,1, "N"; |C_M #0#43,1,"N";
     |C_V #0#44,1, "N"; |C_M #0#44,1,"N";
     |C_V #0#47,1, "N";

     aAlfa1 = "                             ³";
     aAlfa2 = "                             ³";
     aAlfa3 = "                             ³";
     aAlfa4 = "                             ³";
     aAlfa5 = "                             ³";
 |FINSI;
 |PINTA 1751, aAlfa1;
 |PINTA 1851, aAlfa2;
 |PINTA 1951, aAlfa3;
 |PINTA 2051, aAlfa4;
 |PINTA 2151, aAlfa5;
|FCAL;
