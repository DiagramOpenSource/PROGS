|FICHEROS;
     cacap303;
     canempre #30;
     caman303 #2;         || man. 303
     caivarep #4;         || repercutido
     caivasop #5;         || soportado
     caivarec #9;         || Auxiliar
     cacon300 #7;         || conceptos IVA
     caportad #8;         || portada modelos
     caclipro #106;
     eosclipr #709;

     caivaref #124;
     caivasof #125;

     dsmo3402 #342;
     dsmo3403 #343;

     camaasil;
     dsmow204;
|FIN;

|VARIABLES;
    aAlfa       = "";
    aAlfa1      = "";
    aAlfa2      = "";
    aNombre     = "";
    aPais       = "";
    aCodNif     = "";
    aClaveOp    = "";
    aBase       = "";
    aDFecha     = "";
    aHFecha     = "";
    aFichero    = "";

    nBoton340   = -1;
     nIva       = -1;
     nIva1      = -1;
     nIva2      = -1;
     nIva3      = -1;
     nIva4      = -1;
     nIva5      = -1;
     nBaseImpo  = 0;
     nBaseImpo1 = 0;
     nBaseImpo2 = 0;
     nBaseImpo3 = 0;
     nBaseImpo4 = 0;
     nBaseImpo5 = 0;
     nCuotaIva  = 0;
     nCuotaIva1 = 0;
     nCuotaIva2 = 0;
     nCuotaIva3 = 0;
     nCuotaIva4 = 0;
     nCuotaIva5 = 0;
     nRec       = 0;
     nRec1      = 0;
     nRec2      = 0;
     nRec3      = 0;
     nRec4      = 0;
     nRec5      = 0;
     nCuotaRec  = 0;
     nCuotaRec1 = 0;
     nCuotaRec2 = 0;
     nCuotaRec3 = 0;
     nCuotaRec4 = 0;
     nCuotaRec5 = 0;
     nReg       = 0;
     nChequeaNif= 0;
     nVarios    = 0;
     nNume      = 0;
     nCampo1    = 0;
     nCampo2    = 0;
     nCampo3    = 0;
     nCampo4    = 0;
     nCampo5    = 0;
     nEjer      = 0;
     nError     = 0;
     nBaffer    = 0;
     nTotalLinea= 0;
     nConta     = 0;
     nOpcion    = 0;

     aTabla     = "";
     aDestino   = "";
     aSimbolo   = "";

     &eaAlfa       = "";
     &eaLibro      = "";
     &eaReg        = "";
     &eaLib340     = "";
     &eaReg340     = "";
     &eaError      = "";
     &eaVarDni     = "";

     &enNCobro  = 0;
     &ef502c1   = @;
     &ea502c2   = "";
     &ea502c3   = "";
     &enCobrado1 = 0;
     &enCobrado2 = 0;
     &enCobrado3 = 0;
     &enCobrado4 = 0;
     &enCobrado5 = 0;
     &enCobrado6 = 0;
     nCobrado    = 0;
     nCobrado1   = 0;
     nCobrado2   = 0;
     nCobrado3   = 0;
     nCobrado4   = 0;
     nCobrado5   = 0;
     nCobrado6   = 0;
|FIN;

|INCLUYE varnue_i;
|INCLUYE varcaj_i;


|PROCESO ErroresExp340;
     eaLibro = (("00" + #4#0) % -102);
     eaReg   = #4#27 + " - " + (("000000" + #4#2) % -106);

     eaLib340 = "EXPEDIDAS";
     eaReg340 = (("000000" + nReg) % -106);

     |SI nChequeaNif = 1;
         eaVarDni  = #4#51;    |HAZ DNISinChequeo;
         aAlfa1    = #4#51;    |QBF aAlfa1;
         aAlfa2    = eaVarDni; |QBF aAlfa2;

         |SI aAlfa1 ! aAlfa2;  |O eaAlfa ! "";  |O aAlfa1 = "";
             eaError = eaAlfa;

             |SI aAlfa1 = "";
                 eaError = "El NIF/CIF Sin contenido";
                 |PRINT;
             |SINO;
                 |SI aAlfa1 ! aAlfa2;
                     eaError = "El NIF/CIF puede ser erroneo";
                     |PRINT;
                 |FINSI;
             |FINSI;
         |FINSI;
     |SINO;
         eaVarDni = "";
     |FINSI;

     |SI nBaseImpo = 0;
         eaError = "Sin contenido en Base Imponible";
         |PRINT;
     |FINSI;

     aAlfa = aNombre;  |QBF aAlfa;
     |SI aAlfa = "";
         eaError = "Sin contenido en Apellidos y Nombre";
         |PRINT;
     |SINO;
         aAlfa = eaVarDni % 101;
         |SI aAlfa = "0"; |O aAlfa = "1"; |O aAlfa = "2"; |O aAlfa = "3";
          |O aAlfa = "4"; |O aAlfa = "5"; |O aAlfa = "6"; |O aAlfa = "7";
          |O aAlfa = "8"; |O aAlfa = "9"; |O aAlfa = "X"; |O aAlfa = "Y";
          |O aAlfa = "Z";
              aAlfa = aNombre;  |QBF aAlfa;
              aAlfa1 = aAlfa - " ";
              |SI aAlfa1 = aAlfa;
                  eaError =  "Formato del Apellidos y Nombre puede ser erroneo";
                  |PRINT;
              |FINSI;
         |FINSI;
     |FINSI;

     |DBASE aTabla;  |QBF aTabla;
     aTabla = aTabla + "fich/000000/";

     aTabla      = aTabla + "ztabla05.txt";
     nOpcion     = 1;
     nTotalLinea = 0;
     nConta      = -1;
     nBaffer     = 0;

     |LEESECUENCIAL aTabla, nBaffer, nTotalLinea, 0, 0;

     nError = 1;
     |PARA nConta = 0;  |SI nConta [ nTotalLinea;  |HACIENDO nConta = nConta + 1;
         |DEL_BUF nBaffer, nConta, aDestino;
         aAlfa = aDestino % 102;

         |QBF aAlfa;
         |QBF aPais;

         |SI aAlfa = aPais;  nError = 0;  |SAL;  |FINSI;
     |SIGUE;

     |SI nError = 1;
         eaError =  "Contenido incorrecto en el codigo del Pais: " + aPais;
         |PRINT;
     |FINSI;

     |FINDIM nBaffer;
|FPRC;

|PROCESO GrabaTransmisiones;
     #dsmow204#0 = #4#51;
     #dsmow204#1 = nEjer;
     |LEE 101#dsmow204.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmow204;
         #dsmow204#0 = #4#51;
         #dsmow204#1 = nEjer;
         #dsmow204#4 = #4#38;
         |GRABA 020#dsmow204.b;
     |FINSI;

     #dsmow204#2 = #dsmow204#2 + (nBaseImpo + nCuotaIva + nCuotaRec);
     #dsmow204#3 = "S";
     #dsmow204#5 = #4#3;

     |GRABA 020#dsmow204.a;
     |LIBERA #dsmow204;
|FPRC;

|PROCESO FacturasExpedidas;
     nEjer = 2000 + #2#2;

                        aSimbolo = "*";
     |SI nEjer < 2012;  aSimbolo = "X";  |FINSI;

     |SI #7#5 = aSimbolo;  |ACABA;  |FINSI;

     |SI #7#5 = "1";
         |HAZ GrabaTransmisiones;

         #7#5 = " ";
     |FINSI;

     aClaveOp = #7#5;
     |SI enSwCaja = 1; |Y enNCobro = 0;
         aClaveOp = " ";
     |FINSI;

     |ABRE #124;
     |DDEFECTO #124;
     #124#0 = #4#0;
     #124#1 = #4#27;
     #124#2 = #4#2;
     |LEE 001#124=;
     |SI FSalida ! 0; #124#3 = "01.01.0000";   |FINSI;
     |SI #124#3 = #4#3; #124#3 = "01.01.0000"; |FINSI;
     |CIERRA #124;

     |ABRE #342;
     |SELECT #1#342;
     #342#0  = #30#2;
     #342#1  = nEjer;
     #342#2  = #2#1
     #342#3  = 340;
     #342#4  = 0;
     #342#5  = 1;
     #342#6  = 999999;
     |LEE 000#342];
     |SI FSalida = 0;
         |LEE 000#342a;
     |SINO;
         |LEE 000#342u;
     |FINSI;

     nReg = 1;
     |SI FSalida = 0;  |Y #342#0  = #30#2; |Y #342#1  = nEjer;
                       |Y #342#2  = #2#1;  |Y #342#3  = 340;
                       |Y #342#4  = 0;     |Y #342#5  = 1;
         nReg = #342#6 + 1;
     |FINSI;

     |DBASS aBase;
     aBase = aBase + "agicli/fich/";
     |PATH_DAT #709 aBase

     aCodNif  = #4#51;  |QBF aCodNif;

     aPais   = "";
     aNombre = "";

     |ABRE #106;
     #106#23 = "C";
     #106#10 = #4#4;
     #106#11 = #4#5;
     |LEE 000#106=;
     |SI FSalida = 0;
         aPais   = #106#24;   |QBF aPais;
         aNombre = #106#1;    |QBF aNombre;
     |SINO;
         #106#23 = "P";
         #106#10 = #4#4;
         #106#11 = #4#5;
         |LEE 000#106=;
         |SI FSalida = 0;
             aPais   = #106#24;   |QBF aPais;
             aNombre = #106#1;    |QBF aNombre;
         |FINSI;
     |FINSI;
     |CIERRA #106;

     |SI aPais = "";  |O aNombre = "";
         |SI aCodNif ! "";
             |ABRE #709;
             #709#0 = aCodNif;
             |LEE 000#709=;
             |SI FSalida ! 0;  |DDEFECTO #709;  |FINSI;
             |CIERRA #709;

             |SI aPais   = "";   aPais   = #709#14;   |FINSI;
             |SI aNombre = "";   aNombre = #709#1;    |FINSI;
          |FINSI;
     |FINSI;

     |QBF aNombre;

     aPais = aPais % 102;
     |QBF aPais;

     |SI aPais = "";  |O aPais = "E";
         aPais = "ES";
     |FINSI;

     |SI aNombre = "";  aNombre = #4#50;  |FINSI;

     |DDEFECTO #342;
     #342#0  = #30#2;
     #342#1  = nEjer;
     #342#2  = #2#1
     #342#3  = 340;
     #342#4  = 0;
     #342#5  = 1;
     #342#6  = nReg;
     #342#9  = aNombre;
     #342#10 = aPais;
     |SI #342#10 = "   ";
         #342#10 = "ES";
     |FINSI;

     #342#13 = aClaveOp;
     #342#14 = #4#3;
     #342#15 = #124#3;   || .. "01.01.0000";

     #342#16 = nIva;
     #342#17 = nBaseImpo;
     #342#18 = nCuotaIva;
     #342#27 = nRec;
     #342#28 = nCuotaRec;
     #342#19 = #342#17 + #342#18 + #342#28;
     #342#22 = #4#62;
     |SI #342#22 = 0;  #342#22 = 1;  |FINSI;

     |SI nVarios > 1;  |Y #342#13 = " ";
         #342#13 = "C";
         #342#23 = nVarios;
     |FINSI;

     aAlfa   = (("00" + #4#0) % -102) + " / " + #4#27 + " " + (("000000" + #4#2) % -106);
     #342#21 = aAlfa;

     |SI #342#13 = "A";  |O #342#13 = "B";
         aAlfa   = #4#27 + " - " + (("000000" + #4#2) % -106);
         #342#24 = aAlfa;
         nNume   = (#4#2 + #4#62) - 1;
         aAlfa   = #4#27 + " - " + (("000000" + nNume) % -106);
         #342#25 = aAlfa;
     |FINSI;

     nChequeaNif = 1;

     |SI #342#10 ! "ES ";
         aAlfa   = #342#10;  |QBF aAlfa;
         |SI aAlfa = "GR";  aAlfa = "EL";  |FINSI;

         #342#12 = aAlfa + #4#51;

                            #342#11 = "6";
         |SI aAlfa = "DE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "AT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "BE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "BG";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "CY";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "DK";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "SI";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "EE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "FI";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "FR";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "EL";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "GB";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "NL";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "HU";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "IT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "IE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "LV";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "LT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "LU";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "MT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "PL";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "PT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "CZ";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "SK";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "RO";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "SE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "HR";  #342#11 = "2";  |FINSI;

         nChequeaNif = 0;
     |FINSI;

     |SI #7#2 = 3;
         aAlfa   = #342#10;  |QBF aAlfa;
         |SI aAlfa = "GR";  aAlfa = "EL";  |FINSI;

         #342#12 = aAlfa + #4#51;
         #342#11 = "2";
         nChequeaNif = 0;
     |FINSI;

     |SI #7#2 = 8;
         aAlfa   = #342#10;  |QBF aAlfa;
         |SI aAlfa = "GR";  aAlfa = "EL";  |FINSI;

         #342#12 = aAlfa + #4#51;
         #342#11 = "4";
         nChequeaNif = 0;
     |FINSI;

     aClaveOp = #342#13;
     aNombre  = #342#9;

     |SI aClaveOp = "A";  |O aClaveOp = "B";  |O aClaveOp = "J";
      |O aClaveOp = "P";
         nChequeaNif = 0;
     |FINSI;

     |SI aClaveOp = "D";
         |ABRE #9;
         #9#0 = #4#0;
         #9#1 = #4#27;
         #9#2 = #4#2;
         |LEE 000#9=;
         |SI FSalida ! 0;  |DDEFECTO #9;  |FINSI;
         |CIERRA #9;

         #342#26 = #9#3;
     |FINSI;

     |HAZ ErroresExp340;

     #342#7  = eaVarDni;

     |SI #7#7 = "S";  #342#29 = "S";  |FINSI;

     aAlfa = #342#7 % 101;
     |SI aAlfa = "X";  |O aAlfa = "Y";
         #342#11 = "4";
     |FINSI;

     |SI #342#13 = "S";  |O #342#13 = "T";  |O #342#13 = "W";  |O #342#13 = "U";
         #342#16 = 0;
         #342#17 = 0;
         #342#18 = 0;
         #342#27 = 0;
         #342#28 = 0;
     |FINSI;

     |SI enSwCaja = 1; |Y enNCobro ! 0;
         #342#35 = ef502c1;
         #342#36 = nCobrado;
         #342#37 = ea502c2;
         #342#38 = ea502c3;
     |FINSI;

     |GRABA 020#342n;
     |LIBERA #342;

     |CIERRA #342;
|FPRC;

|PROCESO AcumulaFac4;
     |SI #4nCampo1 = 0;  |ACABA;  |FINSI;

     |SI #4nCampo2 = nIva1;
         nBaseImpo1 = nBaseImpo1 + #4nCampo1;
         nIva1      = #4nCampo2;
         nCuotaIva1 = nCuotaIva1 + #4nCampo3;
         nRec1      = #4nCampo4;
         nCuotaRec1 = nCuotaRec1 + #4nCampo5;
         nCobrado1  = nCobrado1 + nCobrado;

         |ACABA;
     |FINSI;

     |SI #4nCampo2 = nIva2;
         nBaseImpo2 = nBaseImpo2 + #4nCampo1;
         nIva2      = #4nCampo2;
         nCuotaIva2 = nCuotaIva2 + #4nCampo3;
         nRec2      = #4nCampo4;
         nCuotaRec2 = nCuotaRec2 + #4nCampo5;
         nCobrado2  = nCobrado2 + nCobrado;

         |ACABA;
     |FINSI;

     |SI #4nCampo2 = nIva3;
         nBaseImpo3 = nBaseImpo3 + #4nCampo1;
         nIva3      = #4nCampo2;
         nCuotaIva3 = nCuotaIva3 + #4nCampo3;
         nRec3      = #4nCampo4;
         nCuotaRec3 = nCuotaRec3 + #4nCampo5;
         nCobrado3  = nCobrado3 + nCobrado;

         |ACABA;
     |FINSI;

     |SI #4nCampo2 = nIva4;
         nBaseImpo4 = nBaseImpo4 + #4nCampo1;
         nIva4      = #4nCampo2;
         nCuotaIva4 = nCuotaIva4 + #4nCampo3;
         nRec4      = #4nCampo4;
         nCuotaRec4 = nCuotaRec4 + #4nCampo5;
         nCobrado4  = nCobrado4 + nCobrado;

         |ACABA;
     |FINSI;

     |SI #4nCampo2 = nIva5;
         nBaseImpo5 = nBaseImpo5 + #4nCampo1;
         nIva5      = #4nCampo2;
         nCuotaIva5 = nCuotaIva5 + #4nCampo3;
         nRec5      = #4nCampo4;
         nCuotaRec5 = nCuotaRec5 + #4nCampo5;
         nCobrado5  = nCobrado5 + nCobrado;

         |ACABA;
     |FINSI;

     |SI nIva1 = -1;
         nBaseImpo1 = #4nCampo1;
         nIva1      = #4nCampo2;
         nCuotaIva1 = #4nCampo3;
         nRec1      = #4nCampo4;
         nCuotaRec1 = #4nCampo5;
         nCobrado1  = nCobrado;

         |ACABA;
     |FINSI;

     |SI nIva2 = -1;
         nBaseImpo2 = #4nCampo1;
         nIva2      = #4nCampo2;
         nCuotaIva2 = #4nCampo3;
         nRec2      = #4nCampo4;
         nCuotaRec2 = #4nCampo5;
         nCobrado2  = nCobrado;

         |ACABA;
     |FINSI;

     |SI nIva3 = -1;
         nBaseImpo3 = #4nCampo1;
         nIva3      = #4nCampo2;
         nCuotaIva3 = #4nCampo3;
         nRec3      = #4nCampo4;
         nCuotaRec3 = #4nCampo5;
         nCobrado3  = nCobrado;

         |ACABA;
     |FINSI;

     |SI nIva4 = -1;
         nBaseImpo4 = #4nCampo1;
         nIva4      = #4nCampo2;
         nCuotaIva4 = #4nCampo3;
         nRec4      = #4nCampo4;
         nCuotaRec4 = #4nCampo5;
         nCobrado4  = nCobrado;

         |ACABA;
     |FINSI;

     |SI nIva5 = -1;
         nBaseImpo5 = #4nCampo1;
         nIva5      = #4nCampo2;
         nCuotaIva5 = #4nCampo3;
         nRec5      = #4nCampo4;
         nCuotaRec5 = #4nCampo5;
         nCobrado5  = nCobrado;

         |ACABA;
     |FINSI;
|FPRC;

|PROCESO Expedidas340;
     nIva1      = -1;
     nIva2      = -1;
     nIva3      = -1;
     nIva4      = -1;
     nIva5      = -1;
     nBaseImpo1 = 0;
     nBaseImpo2 = 0;
     nBaseImpo3 = 0;
     nBaseImpo4 = 0;
     nBaseImpo5 = 0;
     nCuotaIva1 = 0;
     nCuotaIva2 = 0;
     nCuotaIva3 = 0;
     nCuotaIva4 = 0;
     nCuotaIva5 = 0;
     nRec1      = 0;
     nRec2      = 0;
     nRec3      = 0;
     nRec4      = 0;
     nRec5      = 0;
     nCuotaRec1 = 0;
     nCuotaRec2 = 0;
     nCuotaRec3 = 0;
     nCuotaRec4 = 0;
     nCuotaRec5 = 0;
     nCobrado1  = 0;
     nCobrado2  = 0;
     nCobrado3  = 0;
     nCobrado4  = 0;
     nCobrado5  = 0;

     nCampo1 = 8;   nCampo2 = 11;  nCampo3 = 14;  nCampo4 = 17;  nCampo5 = 20;
     nCobrado = enCobrado1;
     |HAZ AcumulaFac4;

     nCampo1 = 9;   nCampo2 = 12;  nCampo3 = 15;  nCampo4 = 18;  nCampo5 = 21;
     nCobrado = enCobrado2;
     |HAZ AcumulaFac4;

     nCampo1 = 10;  nCampo2 = 13;  nCampo3 = 16;  nCampo4 = 19;  nCampo5 = 22;
     nCobrado = enCobrado3;
     |HAZ AcumulaFac4;

     nCampo1 = 52;  nCampo2 = 54;  nCampo3 = 56;  nCampo4 = 58;  nCampo5 = 60;
     nCobrado = enCobrado4;
     |HAZ AcumulaFac4;

     nCampo1 = 53;  nCampo2 = 55;  nCampo3 = 57;  nCampo4 = 59;  nCampo5 = 61;
     nCobrado = enCobrado5;
     |HAZ AcumulaFac4;

     |SI #7#5 = "A";  |O #7#5 = "B";
         |SI nIva2 ! -1;
             eaLibro = (("00" + #4#0) % -102);
             eaReg   = #4#27 + " - " + (("000000" + #4#2) % -106);

             eaLib340 = "EXPEDIDAS";

             eaReg340 = "------";
             eaError  = "Factura resumen con varios tipos de iva. No se pasa el registro al 340";

             |PRINT;
             |ACABA;
          |FINSI;
     |FINSI;

     nVarios = 0;
     |SI nIva1 ! -1;  nVarios = nVarios + 1;  |FINSI;
     |SI nIva2 ! -1;  nVarios = nVarios + 1;  |FINSI;
     |SI nIva3 ! -1;  nVarios = nVarios + 1;  |FINSI;
     |SI nIva4 ! -1;  nVarios = nVarios + 1;  |FINSI;
     |SI nIva5 ! -1;  nVarios = nVarios + 1;  |FINSI;

     |SI nIva1 ! -1;
         nBaseImpo = nBaseImpo1;
         nIva      = nIva1;
         nCuotaIva = nCuotaIva1;
         nRec      = nRec1;
         nCuotaRec = nCuotaRec1;
         nCobrado  = nCobrado1;
         |HAZ FacturasExpedidas;
     |FINSI;

     |SI nIva2 ! -1;
         nBaseImpo = nBaseImpo2;
         nIva      = nIva2;
         nCuotaIva = nCuotaIva2;
         nRec      = nRec2;
         nCuotaRec = nCuotaRec2;
         nCobrado  = nCobrado2;
         |HAZ FacturasExpedidas;
     |FINSI;

     |SI nIva3 ! -1;
         nBaseImpo = nBaseImpo3;
         nIva      = nIva3;
         nCuotaIva = nCuotaIva3;
         nRec      = nRec3;
         nCuotaRec = nCuotaRec3;
         nCobrado  = nCobrado3;
         |HAZ FacturasExpedidas;
     |FINSI;

     |SI nIva4 ! -1;
         nBaseImpo = nBaseImpo4;
         nIva      = nIva4;
         nCuotaIva = nCuotaIva4;
         nRec      = nRec4;
         nCuotaRec = nCuotaRec4;
         nCobrado  = nCobrado4;
         |HAZ FacturasExpedidas;
     |FINSI;

     |SI nIva5 ! -1;
         nBaseImpo = nBaseImpo5;
         nIva      = nIva5;
         nCuotaIva = nCuotaIva5;
         nRec      = nRec5;
         nCuotaRec = nCuotaRec5;
         nCobrado  = nCobrado5;
         |HAZ FacturasExpedidas;
     |FINSI;
|FPRC;

|PROCESO ErroresRec340;
     eaLibro = (("00" + #5#0) % -102);
     eaReg   = #5#27 + " - " + (("000000" + #5#2) % -106);

     eaLib340 = "RECIBIDAS";
     eaReg340 = (("000000" + nReg) % -106);

     |SI nChequeaNif = 1;
         eaVarDni  = #5#51;    |HAZ DNISinChequeo;
         aAlfa1    = #5#51;    |QBF aAlfa1;
         aAlfa2    = eaVarDni; |QBF aAlfa2;

         |SI aAlfa1 ! aAlfa2;  |O eaAlfa ! "";  |O aAlfa1 = "";
             eaError = eaAlfa;

             |SI aAlfa1 = "";
                 eaError = "El NIF/CIF Sin contenido";
                 |PRINT;
             |SINO;
                 |SI aAlfa1 ! aAlfa2;
                     eaError = "El NIF/CIF puede ser erroneo";
                     |PRINT;
                 |FINSI;
             |FINSI;
         |FINSI;
     |SINO;
         eaVarDni = "";
     |FINSI;

     |SI nBaseImpo = 0;
         eaError = "Sin contenido en Base Imponible";
         |PRINT;
     |FINSI;

     aAlfa = aNombre;  |QBF aAlfa;
     |SI aAlfa = "";
         eaError = "Sin contenido en Apellidos y Nombre";
         |PRINT;
     |SINO;
         aAlfa = eaVarDni % 101;
         |SI aAlfa = "0"; |O aAlfa = "1"; |O aAlfa = "2"; |O aAlfa = "3";
          |O aAlfa = "4"; |O aAlfa = "5"; |O aAlfa = "6"; |O aAlfa = "7";
          |O aAlfa = "8"; |O aAlfa = "9"; |O aAlfa = "X"; |O aAlfa = "Y";
          |O aAlfa = "Z";
              aAlfa = aNombre;  |QBF aAlfa;
              aAlfa1 = aAlfa - " ";
              |SI aAlfa1 = aAlfa;
                  eaError =  "Formato del Apellidos y Nombre puede ser erroneo";
                  |PRINT;
              |FINSI;
         |FINSI;
     |FINSI;

     |DBASE aTabla;  |QBF aTabla;
     aTabla = aTabla + "fich/000000/";

     aTabla      = aTabla + "ztabla05.txt";
     nOpcion     = 1;
     nTotalLinea = 0;
     nConta      = -1;
     nBaffer     = 0;

     |LEESECUENCIAL aTabla, nBaffer, nTotalLinea, 0, 0;

     nError = 1;
     |PARA nConta = 0;  |SI nConta [ nTotalLinea;  |HACIENDO nConta = nConta + 1;
         |DEL_BUF nBaffer, nConta, aDestino;
         aAlfa = aDestino % 102;

         |QBF aAlfa;
         |QBF aPais;

         |SI aAlfa = aPais;  nError = 0;  |SAL;  |FINSI;
     |SIGUE;

     |SI nError = 1;
         eaError =  "Contenido incorrecto en el codigo del Pais: " + aPais;
         |PRINT;
     |FINSI;

     |FINDIM nBaffer;
|FPRC;

|PROCESO FacturasRecibidas;
     nEjer = 2000 + #2#2;

                        aSimbolo = "*";
     |SI nEjer < 2012;  aSimbolo = "X";  |FINSI;

     |SI #7#6 = aSimbolo;  |ACABA;  |FINSI;

     aClaveOp = #7#6;
     |SI enSwCaja = 1; |Y enNCobro = 0;
         aClaveOp = " ";
     |FINSI;

     |ABRE #125;
     |DDEFECTO #125;
     #125#0 = #5#0;
     #125#1 = #5#27;
     #125#2 = #5#2;
     |LEE 001#125=;
     |SI FSalida ! 0; #125#3 = "01.01.0000";   |FINSI;
     |SI #125#3 = #5#3; #125#3 = "01.01.0000"; |FINSI;
     |CIERRA #125;

     |ABRE #343;
     |SELECT #1#343;
     #343#0  = #30#2;
     #343#1  = nEjer;
     #343#2  = #2#1
     #343#3  = 340;
     #343#4  = 0;
     #343#5  = 1;
     #343#6  = 999999;
     |LEE 000#343];
     |SI FSalida = 0;
         |LEE 000#343a;
     |SINO;
         |LEE 000#343u;
     |FINSI;

     nReg = 1;
     |SI FSalida = 0;  |Y #343#0  = #30#2; |Y #343#1  = nEjer;
                       |Y #343#2  = #2#1;  |Y #343#3  = 340;
                       |Y #343#4  = 0;     |Y #343#5  = 1;
         nReg = #343#6 + 1;
     |FINSI;

     |DBASS aBase;
     aBase = aBase + "agicli/fich/";
     |PATH_DAT #709 aBase

     aCodNif  = #5#51;  |QBF aCodNif;
     aPais    = "";
     aNombre  = "";

     |ABRE #106;
     #106#23 = "P";
     #106#10 = #5#4;
     #106#11 = #5#5;
     |LEE 000#106=;
     |SI FSalida = 0;
         aPais   = #106#24;   |QBF aPais;
         aNombre = #106#1;    |QBF aNombre;
     |SINO;
         #106#23 = "C";
         #106#10 = #5#4;
         #106#11 = #5#5;
         |LEE 000#106=;
         |SI FSalida = 0;
             aPais   = #106#24;   |QBF aPais;
             aNombre = #106#1;    |QBF aNombre;
         |FINSI;
     |FINSI;
     |CIERRA #106;

     |SI aPais = "";  |O aNombre = "";
         |SI aCodNif ! "";
             |ABRE #709;
             #709#0 = aCodNif;
             |LEE 000#709=;
             |SI FSalida ! 0;  |DDEFECTO #709;  |FINSI;
             |CIERRA #709;

             |SI aPais   = "";   aPais   = #709#14;   |FINSI;
             |SI aNombre = "";   aNombre = #709#1;    |FINSI;
          |FINSI;
     |FINSI;

     |QBF aNombre;

     aPais = aPais % 102;
     |QBF aPais;

     |SI aPais = "";  |O aPais = "E";
         aPais = "ES";
     |FINSI;

     |SI aNombre = "";  aNombre = #5#50;  |FINSI;

     |DDEFECTO #343;
     #343#0  = #30#2;
     #343#1  = nEjer;
     #343#2  = #2#1
     #343#3  = 340;
     #343#4  = 0;
     #343#5  = 1;
     #343#6  = nReg;
     #343#9  = aNombre;
     #343#10 = aPais;
     |SI #343#10 = "   ";
         #343#10 = "ES";
     |FINSI;

     #343#13 = aClaveOp;
     #343#14 = #5#3;
     #343#15 = #125#3;  ||  Nuevo fichero para Fecha Operaciones "01.01.0000";

     #343#16 = nIva;
     #343#17 = nBaseImpo;
     #343#18 = nCuotaIva;
     #343#19 = #343#17 + #343#18;

     |SI #5#23 = "S";
         #343#26 = nCuotaIva;
     |FINSI;

     #343#22 = 1;

     |SI nVarios > 1;  |Y #343#13 = " ";
         #343#13 = "C";
         #343#23 = nVarios;
     |FINSI;

     aAlfa   = (("00" + #5#0) % -102) + " / " + #5#27 + " " + (("000000" + #5#2) % -106);
     #343#21 = aAlfa;

     |SI #343#13 = " ";
         |SI #7#1 = 3;  #343#13 = "P";  |FINSI;
     |FINSI;

     |SI #343#13 = "A";  |O #343#13 = "B";
         aAlfa   = #5#27 + " - " + (("000000" + #5#2) % -106);
         #343#24 = aAlfa;
         nNume   = #5#2 + 1;
         aAlfa   = #5#27 + " - " + (("000000" + nNume) % -106);
         #343#25 = aAlfa;
     |FINSI;

     nChequeaNif = 1;

     |SI #343#10 ! "ES ";
         aAlfa   = #343#10;  |QBF aAlfa;
         |SI aAlfa = "GR";  aAlfa = "EL";  |FINSI;

         #343#12 = aAlfa + #5#51;

                            #343#11 = "6";
         |SI aAlfa = "DE";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "AT";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "BE";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "BG";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "CY";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "DK";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "SI";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "EE";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "FI";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "FR";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "EL";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "GB";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "NL";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "HU";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "IT";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "IE";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "LV";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "LT";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "LU";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "MT";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "PL";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "PT";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "CZ";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "SK";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "RO";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "SE";  #343#11 = "2";  |FINSI;
         |SI aAlfa = "HR";  #343#11 = "2";  |FINSI;

         nChequeaNif = 0;
     |FINSI;

     |SI #343#13 = " ";
         |SI #7#1 = 2;  |O #7#1 = 7;
             aAlfa   = #343#10;  |QBF aAlfa;
             |SI aAlfa = "GR";  aAlfa = "EL";  |FINSI;

             #343#12 = aAlfa + #5#51;
             #343#11 = "4";
            nChequeaNif = 0;
         |FINSI;
     |FINSI;

     |SI #343#13 = "P";
         aAlfa   = #343#10;  |QBF aAlfa;
         |SI aAlfa = "GR";  aAlfa = "EL";  |FINSI;

         #343#12 = aAlfa + #5#51;
         #343#11 = "2";
         nChequeaNif = 0;
     |FINSI;


     aClaveOp = #343#13;
     aNombre  = #343#9;

     |SI aClaveOp = "A";  |O aClaveOp = "B";  |O aClaveOp = "J";
      |O aClaveOp = "P";
         nChequeaNif = 0;
     |FINSI;

     |HAZ ErroresRec340;

     #343#7  = eaVarDni;

     |SI #7#7 = "S";  #343#27 = "S";  |FINSI;

     aAlfa = #343#7 % 101;
     |SI aAlfa = "X";  |O aAlfa = "Y";
         #343#11 = "4";
     |FINSI;

     |SI #343#13 = "S";  |O #343#13 = "W";
         #343#16 = 0;
         #343#17 = 0;
         #343#18 = 0;
         #343#26 = 0;
     |FINSI;

     |SI #343#13 = "X";
         ||  #343#17 = #343#19;
         #343#16 = 0;
     |FINSI;

     |SI enSwCaja = 1; |Y enNCobro ! 0;
         #343#28 = ef502c1;
         #343#29 = nCobrado;
         #343#30 = ea502c2;
         #343#31 = ea502c3;
     |FINSI;

     |GRABA 020#343n;
     |LIBERA #343;

     |CIERRA #343;
|FPRC;

|PROCESO AcumulaFac5;
     |SI #5nCampo1 = 0;  |ACABA;  |FINSI;

     |SI #5nCampo2 = nIva1;
         nBaseImpo1 = nBaseImpo1 + #5nCampo1;
         nIva1      = #5nCampo2;
         nCuotaIva1 = nCuotaIva1 + #5nCampo3;
         nRec1      = #5nCampo4;
         nCuotaRec1 = nCuotaRec1 + #5nCampo5;
         nCobrado1  = nCobrado1 + nCobrado;

         |ACABA;
     |FINSI;

     |SI #5nCampo2 = nIva2;
         nBaseImpo2 = nBaseImpo2 + #5nCampo1;
         nIva2      = #5nCampo2;
         nCuotaIva2 = nCuotaIva2 + #5nCampo3;
         nRec2      = #5nCampo4;
         nCuotaRec2 = nCuotaRec2 + #5nCampo5;
         nCobrado2  = nCobrado2 + nCobrado;

         |ACABA;
     |FINSI;

     |SI #5nCampo2 = nIva3;
         nBaseImpo3 = nBaseImpo3 + #5nCampo1;
         nIva3      = #5nCampo2;
         nCuotaIva3 = nCuotaIva3 + #5nCampo3;
         nRec3      = #5nCampo4;
         nCuotaRec3 = nCuotaRec3 + #5nCampo5;
         nCobrado3  = nCobrado3 + nCobrado;

         |ACABA;
     |FINSI;

     |SI #5nCampo2 = nIva4;
         nBaseImpo4 = nBaseImpo4 + #5nCampo1;
         nIva4      = #5nCampo2;
         nCuotaIva4 = nCuotaIva4 + #5nCampo3;
         nRec4      = #5nCampo4;
         nCuotaRec4 = nCuotaRec4 + #5nCampo5;
         nCobrado4  = nCobrado4 + nCobrado;

         |ACABA;
     |FINSI;

     |SI #5nCampo2 = nIva5;
         nBaseImpo5 = nBaseImpo5 + #5nCampo1;
         nIva5      = #5nCampo2;
         nCuotaIva5 = nCuotaIva5 + #5nCampo3;
         nRec5      = #5nCampo4;
         nCuotaRec5 = nCuotaRec5 + #5nCampo5;
         nCobrado5  = nCobrado5 + nCobrado;

         |ACABA;
     |FINSI;

     |SI nIva1 = -1;
         nBaseImpo1 = #5nCampo1;
         nIva1      = #5nCampo2;
         nCuotaIva1 = #5nCampo3;
         nRec1      = #5nCampo4;
         nCuotaRec1 = #5nCampo5;
         nCobrado1  = nCobrado;

         |ACABA;
     |FINSI;

     |SI nIva2 = -1;
         nBaseImpo2 = #5nCampo1;
         nIva2      = #5nCampo2;
         nCuotaIva2 = #5nCampo3;
         nRec2      = #5nCampo4;
         nCuotaRec2 = #5nCampo5;
         nCobrado2  = nCobrado;

         |ACABA;
     |FINSI;

     |SI nIva3 = -1;
         nBaseImpo3 = #5nCampo1;
         nIva3      = #5nCampo2;
         nCuotaIva3 = #5nCampo3;
         nRec3      = #5nCampo4;
         nCuotaRec3 = #5nCampo5;
         nCobrado3  = nCobrado;

         |ACABA;
     |FINSI;

     |SI nIva4 = -1;
         nBaseImpo4 = #5nCampo1;
         nIva4      = #5nCampo2;
         nCuotaIva4 = #5nCampo3;
         nRec4      = #5nCampo4;
         nCuotaRec4 = #5nCampo5;
         nCobrado4  = nCobrado;

         |ACABA;
     |FINSI;

     |SI nIva5 = -1;
         nBaseImpo5 = #5nCampo1;
         nIva5      = #5nCampo2;
         nCuotaIva5 = #5nCampo3;
         nRec5      = #5nCampo4;
         nCuotaRec5 = #5nCampo5;
         nCobrado5  = nCobrado;

         |ACABA;
     |FINSI;
|FPRC;

|PROCESO Recibidas340;
     nIva1      = -1;
     nIva2      = -1;
     nIva3      = -1;
     nIva4      = -1;
     nIva5      = -1;
     nBaseImpo1 = 0;
     nBaseImpo2 = 0;
     nBaseImpo3 = 0;
     nBaseImpo4 = 0;
     nBaseImpo5 = 0;
     nCuotaIva1 = 0;
     nCuotaIva2 = 0;
     nCuotaIva3 = 0;
     nCuotaIva4 = 0;
     nCuotaIva5 = 0;
     nRec1      = 0;
     nRec2      = 0;
     nRec3      = 0;
     nRec4      = 0;
     nRec5      = 0;
     nCuotaRec1 = 0;
     nCuotaRec2 = 0;
     nCuotaRec3 = 0;
     nCuotaRec4 = 0;
     nCuotaRec5 = 0;
     nCobrado1  = 0;
     nCobrado2  = 0;
     nCobrado3  = 0;
     nCobrado4  = 0;
     nCobrado5  = 0;

     nCampo1 = 8;   nCampo2 = 11;  nCampo3 = 14;  nCampo4 = 17;  nCampo5 = 20;
     nCobrado = enCobrado1;
     |HAZ AcumulaFac5;

     nCampo1 = 9;   nCampo2 = 12;  nCampo3 = 15;  nCampo4 = 18;  nCampo5 = 21;
     nCobrado = enCobrado2;
     |HAZ AcumulaFac5;

     nCampo1 = 10;  nCampo2 = 13;  nCampo3 = 16;  nCampo4 = 19;  nCampo5 = 22;
     nCobrado = enCobrado3;
     |HAZ AcumulaFac5;

     nCampo1 = 52;  nCampo2 = 54;  nCampo3 = 56;  nCampo4 = 58;  nCampo5 = 60;
     nCobrado = enCobrado4;
     |HAZ AcumulaFac5;

     nCampo1 = 53;  nCampo2 = 55;  nCampo3 = 57;  nCampo4 = 59;  nCampo5 = 61;
     nCobrado = enCobrado5;
     |HAZ AcumulaFac5;

     |SI #7#6 = "A";  |O #7#6 = "B";
         |SI nIva2 ! -1;
             eaLibro = (("00" + #5#0) % -102);
             eaReg   = #5#27 + " - " + (("000000" + #5#2) % -106);

             eaLib340 = "RECIBIDAS";

             eaReg340 = "------";
             eaError  = "Factura resumen con varios tipos de iva. No se pasa el registro al 340";

             |PRINT;
             |ACABA;
          |FINSI;
     |FINSI;

     nVarios = 0;
     |SI nIva1 ! -1;  nVarios = nVarios + 1;  |FINSI;
     |SI nIva2 ! -1;  nVarios = nVarios + 1;  |FINSI;
     |SI nIva3 ! -1;  nVarios = nVarios + 1;  |FINSI;
     |SI nIva4 ! -1;  nVarios = nVarios + 1;  |FINSI;
     |SI nIva5 ! -1;  nVarios = nVarios + 1;  |FINSI;

     |SI nIva1 ! -1;
         nBaseImpo = nBaseImpo1;
         nIva      = nIva1;
         nCuotaIva = nCuotaIva1;
         nRec      = nRec1;
         nCuotaRec = nCuotaRec1;
         nCobrado  = nCobrado1;
         |HAZ FacturasRecibidas;
     |FINSI;

     |SI nIva2 ! -1;
         nBaseImpo = nBaseImpo2;
         nIva      = nIva2;
         nCuotaIva = nCuotaIva2;
         nRec      = nRec2;
         nCuotaRec = nCuotaRec2;
         nCobrado  = nCobrado2;
         |HAZ FacturasRecibidas;
     |FINSI;

     |SI nIva3 ! -1;
         nBaseImpo = nBaseImpo3;
         nIva      = nIva3;
         nCuotaIva = nCuotaIva3;
         nRec      = nRec3;
         nCuotaRec = nCuotaRec3;
         nCobrado  = nCobrado3;
         |HAZ FacturasRecibidas;
     |FINSI;

     |SI nIva4 ! -1;
         nBaseImpo = nBaseImpo4;
         nIva      = nIva4;
         nCuotaIva = nCuotaIva4;
         nRec      = nRec4;
         nCuotaRec = nCuotaRec4;
         nCobrado  = nCobrado4;
         |HAZ FacturasRecibidas;
     |FINSI;

     |SI nIva5 ! -1;
         nBaseImpo = nBaseImpo5;
         nIva      = nIva5;
         nCuotaIva = nCuotaIva5;
         nRec      = nRec5;
         nCuotaRec = nCuotaRec5;
         nCobrado  = nCobrado5;
         |HAZ FacturasRecibidas;
     |FINSI;
|FPRC;

|PROCESO dsmow204Trans;   || Trnasmisiones inmuebles
     |SI #dsmow204#3 = "N";   |ACABA;  |FINSI;

     nEjer = 2000 + #2#2;

     |ABRE #342;
     |SELECT #1#342;
     #342#0  = #30#2;
     #342#1  = nEjer;
     #342#2  = #2#1;
     #342#3  = 340;
     #342#4  = 0;
     #342#5  = 1;
     #342#6  = 999999;
     |LEE 000#342];
     |SI FSalida = 0;
         |LEE 000#342a;
     |SINO;
         |LEE 000#342u;
     |FINSI;

     nReg = 1;
     |SI FSalida = 0;  |Y #342#0  = #30#2; |Y #342#1  = nEjer;
                       |Y #342#2  = #2#1;  |Y #342#3  = 340;
                       |Y #342#4  = 0;     |Y #342#5  = 1;
         nReg = #342#6 + 1;
     |FINSI;

     |DBASS aBase;
     aBase = aBase + "agicli/fich/";
     |PATH_DAT #709 aBase

     aCodNif  = #dsmow204#0;  |QBF aCodNif;

     aPais   = "";
     aNombre = "";

     |ABRE #106;
     |SELECT #4#106;
     #106#9  = #dsmow204#0;
     |LEE 000#106=;
     |SI FSalida = 0;
         aPais   = #106#24;   |QBF aPais;
         aNombre = #106#1;    |QBF aNombre;
     |FINSI;
     |CIERRA #106;

     |SI aPais = "";  |O aNombre = "";
         |SI aCodNif ! "";
             |ABRE #709;
             #709#0 = aCodNif;
             |LEE 000#709=;
             |SI FSalida ! 0;  |DDEFECTO #709;  |FINSI;
             |CIERRA #709;

             |SI aPais   = "";   aPais   = #709#14;   |FINSI;
             |SI aNombre = "";   aNombre = #709#1;    |FINSI;
          |FINSI;
     |FINSI;

     |QBF aNombre;

     aPais = aPais % 102;
     |QBF aPais;

     |SI aPais = "";  |O aPais = "E";
         aPais = "ES";
     |FINSI;

     |SI aNombre = "";  aNombre = #dsmow204#4;  |FINSI;

     |DDEFECTO #342;
     #342#0  = #30#2;
     #342#1  = nEjer;
     #342#2  = #2#1;
     #342#3  = 340;
     #342#4  = 0;
     #342#5  = 1;
     #342#6  = nReg;
     #342#9  = aNombre;
     #342#10 = aPais;
     |SI #342#10 = "   ";
         #342#10 = "ES";
     |FINSI;

     #342#13 = "";
     #342#14 = #dsmow204#5;
     #342#15 = "01.01.0000";

     nChequeaNif = 1;

     |SI #342#10 ! "ES ";
         aAlfa   = #342#10;  |QBF aAlfa;
         |SI aAlfa = "GR";  aAlfa = "EL";  |FINSI;

                            #342#11 = "6";
         |SI aAlfa = "DE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "AT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "BE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "BG";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "CY";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "DK";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "SI";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "EE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "FI";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "FR";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "EL";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "GB";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "NL";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "HU";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "IT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "IE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "LV";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "LT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "LU";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "MT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "PL";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "PT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "CZ";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "SK";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "RO";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "SE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "HR";  #342#11 = "2";  |FINSI;

         #342#12 = aAlfa + #dsmow204#0;
         nChequeaNif = 0;
     |FINSI;

     aClaveOp = #342#13;
     aNombre  = #342#9;

     #342#34  = #dsmow204#2;

     |HAZ ErroresExp340;

     #342#7  = eaVarDni;

     aAlfa = #342#7 % 101;
     |SI aAlfa = "X";  |O aAlfa = "Y";
         #342#11 = "4";
     |FINSI;

     |GRABA 020#342n;
     |LIBERA #342;

     |CIERRA #342;
|FPRC;

|DEFBUCLE dsmow204Trans;
     #dsmow204#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsmow204Trans;
|FIN;

|PROCESO Transmisiones;
     |BUCLE dsmow204Trans;
|FPRC;

|PROCESO camaasil;
     |SELECT #1#caclipro;
     #caclipro#23 = "C";
     #caclipro#10 = #camaasil#4;
     #caclipro#11 = #camaasil#5;
     |LEE 000#caclipro.=;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     |SI #camaasil#6 = 0;  |ACABA;  |FINSI;

     |SI #cacap303#8  ! #camaasil#6;  |Y  #cacap303#9  ! #camaasil#6;
     |Y  #cacap303#10 ! #camaasil#6;  |Y  #cacap303#11 ! #camaasil#6;
     |Y  #cacap303#12 ! #camaasil#6;
         |ACABA;
     |FINSI;

     #dsmow204#0 = #caclipro#9;
     #dsmow204#1 = nEjer;
     |LEE 101#dsmow204.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmow204;
         #dsmow204#0 = #caclipro#9;
         #dsmow204#1 = nEjer;
         #dsmow204#4 = #caclipro#1;
         |GRABA 020#dsmow204.b;
     |FINSI;

     |SI #camaasil#8 = "D";
         #dsmow204#2 = #dsmow204#2 - #camaasil#9;
     |SINO;
         #dsmow204#2 = #dsmow204#2 + #camaasil#9;
     |FINSI;

     |SI #camaasil#1 ] aDFecha;
         #dsmow204#3 = "S";
     |FINSI;

     |GRABA 020#dsmow204.a;
     |LIBERA #dsmow204;
|FPRC;

|DEFBUCLE camaasil;
     #camaasil#1;
     ;
     01, "01.01.0000", 000001, 0001;
     99,      aHFecha, 999999, 9999;
     ;
     NULL, camaasil;
|FIN;

|PROCESO dsmow204Cobros;
     |SI #dsmow204#3 = "N";   |ACABA;  |FINSI;
     |SI #dsmow204#2 < 6000;  |ACABA;  |FINSI;

     nEjer = 2000 + #2#2;

     |ABRE #342;
     |SELECT #1#342;
     #342#0  = #30#2;
     #342#1  = nEjer;
     #342#2  = #2#1;
     #342#3  = 340;
     #342#4  = 0;
     #342#5  = 1;
     #342#6  = 999999;
     |LEE 000#342];
     |SI FSalida = 0;
         |LEE 000#342a;
     |SINO;
         |LEE 000#342u;
     |FINSI;

     nReg = 1;
     |SI FSalida = 0;  |Y #342#0  = #30#2; |Y #342#1  = nEjer;
                       |Y #342#2  = #2#1;  |Y #342#3  = 340;
                       |Y #342#4  = 0;     |Y #342#5  = 1;
         nReg = #342#6 + 1;
     |FINSI;

     |DBASS aBase;
     aBase = aBase + "agicli/fich/";
     |PATH_DAT #709 aBase

     aCodNif  = #dsmow204#0;  |QBF aCodNif;

     aPais   = "";
     aNombre = "";

     |ABRE #106;
     |SELECT #4#106;
     #106#9  = #dsmow204#0;
     |LEE 000#106=;
     |SI FSalida = 0;
         aPais   = #106#24;   |QBF aPais;
         aNombre = #106#1;    |QBF aNombre;
     |FINSI;
     |CIERRA #106;

     |SI aPais = "";  |O aNombre = "";
         |SI aCodNif ! "";
             |ABRE #709;
             #709#0 = aCodNif;
             |LEE 000#709=;
             |SI FSalida ! 0;  |DDEFECTO #709;  |FINSI;
             |CIERRA #709;

             |SI aPais   = "";   aPais   = #709#14;   |FINSI;
             |SI aNombre = "";   aNombre = #709#1;    |FINSI;
          |FINSI;
     |FINSI;

     |QBF aNombre;

     aPais = aPais % 102;
     |QBF aPais;

     |SI aPais = "";  |O aPais = "E";
         aPais = "ES";
     |FINSI;

     |SI aNombre = "";  aNombre = #dsmow204#4;  |FINSI;

     |DDEFECTO #342;
     #342#0  = #30#2;
     #342#1  = nEjer;
     #342#2  = #2#1;
     #342#3  = 340;
     #342#4  = 0;
     #342#5  = 1;
     #342#6  = nReg;
     #342#9  = aNombre;
     #342#10 = aPais;
     |SI #342#10 = "   ";
         #342#10 = "ES";
     |FINSI;

     #342#13 = "";
     #342#14 = aHFecha;
     #342#15 = "01.01.0000";

     nChequeaNif = 1;

     |SI #342#10 ! "ES ";
         aAlfa   = #342#10;  |QBF aAlfa;
         |SI aAlfa = "GR";  aAlfa = "EL";  |FINSI;

                            #342#11 = "6";
         |SI aAlfa = "DE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "AT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "BE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "BG";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "CY";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "DK";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "SI";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "EE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "FI";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "FR";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "EL";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "GB";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "NL";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "HU";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "IT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "IE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "LV";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "LT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "LU";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "MT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "PL";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "PT";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "CZ";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "SK";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "RO";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "SE";  #342#11 = "2";  |FINSI;
         |SI aAlfa = "HR";  #342#11 = "2";  |FINSI;

         #342#12 = aAlfa + #dsmow204#0;
         nChequeaNif = 0;
     |FINSI;

     aClaveOp = #342#13;
     aNombre  = #342#9;

     #342#32  = #dsmow204#2;
     #342#33  = #dsmow204#1;

     |HAZ ErroresExp340;

     #342#7  = eaVarDni;

     aAlfa = #342#7 % 101;
     |SI aAlfa = "X";  |O aAlfa = "Y";
         #342#11 = "4";
     |FINSI;

     |GRABA 020#342n;
     |LIBERA #342;
     |CIERRA #342;
|FPRC;

|DEFBUCLE dsmow204Cobros;
     #dsmow204#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsmow204Cobros;
|FIN;

|PROCESO Cobros;
     |SI #cacap303#8  = 0;  |Y #cacap303#9  = 0;  |Y #cacap303#10 = 0;
      |Y #cacap303#11 = 0;  |Y #cacap303#12 = 0;
         |ACABA;
     |FINSI;

     nEjer = 2000 + #30#26;

     |SI #cacap303#0 = "T";
         |SI #cacap303#1 = 1;   aDFecha = "01.01." + nEjer;  aHFecha = "31.03." + nEjer;  |FINSI;
         |SI #cacap303#1 = 2;   aDFecha = "01.01." + nEjer;  aHFecha = "31.03." + nEjer;  |FINSI;
         |SI #cacap303#1 = 3;   aDFecha = "01.01." + nEjer;  aHFecha = "31.03." + nEjer;  |FINSI;
         |SI #cacap303#1 = 4;   aDFecha = "01.04." + nEjer;  aHFecha = "30.06." + nEjer;  |FINSI;
         |SI #cacap303#1 = 5;   aDFecha = "01.04." + nEjer;  aHFecha = "30.06." + nEjer;  |FINSI;
         |SI #cacap303#1 = 6;   aDFecha = "01.04." + nEjer;  aHFecha = "30.06." + nEjer;  |FINSI;
         |SI #cacap303#1 = 7;   aDFecha = "01.07." + nEjer;  aHFecha = "30.09." + nEjer;  |FINSI;
         |SI #cacap303#1 = 8;   aDFecha = "01.07." + nEjer;  aHFecha = "30.09." + nEjer;  |FINSI;
         |SI #cacap303#1 = 9;   aDFecha = "01.07." + nEjer;  aHFecha = "30.09." + nEjer;  |FINSI;
         |SI #cacap303#1 = 10;  aDFecha = "01.10." + nEjer;  aHFecha = "31.12." + nEjer;  |FINSI;
         |SI #cacap303#1 = 11;  aDFecha = "01.10." + nEjer;  aHFecha = "31.12." + nEjer;  |FINSI;
         |SI #cacap303#1 = 12;  aDFecha = "01.10." + nEjer;  aHFecha = "31.12." + nEjer;  |FINSI;
     |SINO;
         |SI #cacap303#1 = 1;   aDFecha = "01.01." + nEjer;  aHFecha = "31.01." + nEjer;  |FINSI;
         |SI #cacap303#1 = 2;   aDFecha = "01.02." + nEjer;  aHFecha = "29.02." + nEjer;  |FINSI;
         |SI #cacap303#1 = 3;   aDFecha = "01.03." + nEjer;  aHFecha = "31.03." + nEjer;  |FINSI;
         |SI #cacap303#1 = 4;   aDFecha = "01.04." + nEjer;  aHFecha = "30.04." + nEjer;  |FINSI;
         |SI #cacap303#1 = 5;   aDFecha = "01.05." + nEjer;  aHFecha = "31.05." + nEjer;  |FINSI;
         |SI #cacap303#1 = 6;   aDFecha = "01.06." + nEjer;  aHFecha = "30.06." + nEjer;  |FINSI;
         |SI #cacap303#1 = 7;   aDFecha = "01.07." + nEjer;  aHFecha = "31.07." + nEjer;  |FINSI;
         |SI #cacap303#1 = 8;   aDFecha = "01.08." + nEjer;  aHFecha = "31.08." + nEjer;  |FINSI;
         |SI #cacap303#1 = 9;   aDFecha = "01.09." + nEjer;  aHFecha = "30.09." + nEjer;  |FINSI;
         |SI #cacap303#1 = 10;  aDFecha = "01.10." + nEjer;  aHFecha = "31.10." + nEjer;  |FINSI;
         |SI #cacap303#1 = 11;  aDFecha = "01.11." + nEjer;  aHFecha = "30.11." + nEjer;  |FINSI;
         |SI #cacap303#1 = 12;  aDFecha = "01.12." + nEjer;  aHFecha = "31.12." + nEjer;  |FINSI;
     |FINSI;

     aFichero = ("47" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #dsmow204#aFichero#;
     |ABRE #dsmow204;  |CIERRA #dsmow204;  |DELINDEX #dsmow204;

     |ABRE #caclipro;
     |ABRE #dsmow204;

     |BUCLE camaasil;

     |CIERRA #caclipro;
     |CIERRA #dsmow204;

     |BUCLE dsmow204Cobros;

     |DELINDEX #dsmow204;
|FPRC;
