|FICHEROS;
    camaasix #00;   || def introduccion IVAS
    camaasiy #01;   || def introduccion de contrapartidas
    camaasic #02;   || apuntes cabs.
    camaasil #03;   || apuntes lins.
    cacuenta #04;   || cuentas
    caconcep #06;   || concepto
    caivaasi #07;   || control entrada iva
    calibros #11;   || libros iva
    caivasop #12;   || iva soportado
    caivarep #13;   || iva repercutido
    cacuivli #15;   || cuentas iva
    cacoivli #16;   || control iva
    caclipro #17;   || clientes/proveedores
    caivases #50,MANTE;   || Fichero de Series
    caentasc #102;  || apuntes cabs Bloques
    caentasl #103;  || apuntes lins Bloques
    calisfra #998;
    caacrval #999;

    caivaref #112;
    caivasof #113;
|FIN;

|VARIABLES;
    &entrada = 1;
    &nConcep = 0;
    &aDesc = "";
    mensa1 = "    ERROR ESTA FECHA NO CORRESPONDE AL EJERCICIO";
    men2  = "     Longitud de Cuenta Fuera de Nivel !";
    men3  = "      Esta Cuenta NO tiene Pase directo";
    men4  = "";
    cont = 0;
    long = "  ";
    cta  = 0;
    num   = 0;
    sw = 0;
    traba1 = "";
    traba2 = "";
    trasum = 0;
    juan = 0;
    jose = 0;
    pepe = 0;
    rafa = 0;
    anter = 0;
    antnum = 0;
    seran = "";

    &LineaExt  = 0;
    &NombreExt = "";
    &CifExt    = "";
    &clau = "";
    &libro = 0;
    &orden = 0;
    &serie = "";
    &pesetas = 0;
    nImpCartera = 0;
    &cuenta = "";
    &digito = 0;
    &emision = "";
    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;
    trim1 = @;
    trim2 = @;
    trim3 = @;
    mas = 0;
    modo = 0;
    digi = 0;
    desc = 0;
    &ext1 = "";
    &ext2 = "";
    &ext3 = "";
    &ext4 = "";
    &ext5 = "";
    &ext6 = "";
    &ext7 = "";
    c_base = 0;
    c_ivac = 0;
    c_ivap = 0;
    c_recc = 0;
    c_recp = 0;
    &t_bases = 0;
    &sw_vuelve = 0;
    &descuadre = "";
    &swt_ficha = 0;
    doce = "            ";
    tipito = 0;
    t_linea = 0;
    t_acumu = 0;
    ult_apunt = 0;
    signe = "";
    impor = 0;
    conte = "";
    digcu = 0;
    tip_acum = "";
    num_acum = 0;
    conce = 0;
    descr = "";
    departam = "";
    FEstado = 0;
    &sw_ivamerr = 0;
    factor = 0;
    t_sumas = 0;
    sw_defcta = 0;
    sw_defdes = 0;
    ant_con = 0;
    sw_netos = 0;
    guarda_base = 0;
         letra = "";
         final = "";
         x = "";
         lugar = 0;
         nifnum = 0;
         resto = 0;
    &fec_am = @;
    &imp_am = 0;
    &ct1_am = "";
    &ct2_am = 0;
    &prv_am = "";
    &c_am = "";
    primer = "";
    &ctab1 = "";
    &ctab2 = 0;
    sw_pr = 0;

    ComodNum = 0;
    SerieAnt = "  XX";
    LibroAnt = 0;
    NumFact = 0;
    ModoEntrada = 0;
    nCalc = 0;


    Calc1   = 0; Calc2 = 0;
    Cont    = 0;
    Letra   = "";
    Desc    = "";
    DescAnt = "";
    Calc    = 0;
    Comodin = "";
    aCampo1 = "";
    aCampo2 = "";
    aCampo3 = "";

     aNifQbf1   = "";
     aNifQbf2   = "";

     &eaVarDni  = "";
     &enCalcCif = 0;
     inkey      = 0;
     fecha1     = @;

     nBtnPDF1            = -1;
     nBtnPDF2            = -1;

     aEmp                = "";
     aLib                = "";
     aSer                = "";
     aFac                = "";
     aFic                = "";
     aAlfa               = "";
     aBase               = "";
     aAbre               = "";

     &swModulo           = 0;
|FIN;

|INCLUYE acceso_i;       || #30
|INCLUYE cobros_i;       || #20
|INCLUYE pagoss_i;       || #21
|INCLUYE actcta_i;       || #5,#8
|INCLUYE actudi_i;       || #10
|INCLUYE puntos_i;       || #69,#70
|INCLUYE tempo_i;

|PROCESO RecogePDF;
     aEmp = (("00000" + #48#2) % -105) + #48#3;
     aLib = ("00" + #camaasix#0) % -102;
     aSer = #camaasix#27;  |QBF aSer;
     aSer = ("__" + aSer) % -102;
     aFac = #camaasix#2;  |QBF aFac;
     aFac = ("000000" + aFac) % -106;
     aFic  = "CR" + aEmp + aLib + aSer + aFac + ".pdf";
     aAlfa = "|hogarz01;" + aFic;
     |SUB_EJECUTA aAlfa;

     aFic  = "CC" + aEmp + aLib + aSer + aFac + ".pdf";
     |DBASS aBase;
     aAbre = aBase + "hogareur/hogardoc/" + aFic;
     |XABRE "E", aAbre, 0;
     |SI FSalida ] 0;
         |ESTADO_CONTROL nBtnPDF2, "ENABLE";
     |FINSI;
|FPRC;

|PROCESO VerPDF;
     aEmp = (("00000" + #48#2) % -105) + #48#3;
     aLib = ("00" + #camaasix#0) % -102;
     aSer = #camaasix#27;  |QBF aSer;
     aSer = ("__" + aSer) % -102;
     aFac = #camaasix#2;  |QBF aFac;
     aFac = ("000000" + aFac) % -106;
     aFic  = "CC" + aEmp + aLib + aSer + aFac + ".pdf";
     aAlfa = "|hogarz01;" + aFic;
     |SUB_EJECUTA aAlfa;
|FPRC;

|PROCESO Botones3824;
     |SI swModulo ! 3824;
         |ACABA;
     |FINSI;

     |SI #0#55 ! "S";
         |SI nBtnPDF1 ! -1;
             |FIN_CONTROL_WINDOWS nBtnPDF1;
             |FIN_CONTROL_WINDOWS nBtnPDF2;

             nBtnPDF1 = -1;
             nBtnPDF2 = -1;
         |FINSI;
         |ACABA;
     |FINSI;

     |SI nBtnPDF1 ! -1;
         |ACABA;
     |FINSI;

     |CONTROL_SIMPLE 0, "BOTON,{{197}}Recoger factura", 1765, 1776, RecogePDF;
     nBtnPDF1 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{197}}Ver factura", 1865, 1876, VerPDF;
     nBtnPDF2 = FSalida;

     |ESTADO_CONTROL nBtnPDF1, "ENABLE";
     |ESTADO_CONTROL nBtnPDF2, "DISABLE";
|FPRC;

|PROCESO mayusculas;
  #0Campo = #0Campo > " ";
  |PINTA #0Campo;
|FPRC;

|PROCESO libro; |TIPO 0;
 |SI clau = "R";
     men4 = "    ATENCION!!! Libro de I.V.A. Soportado ...";
 |SINO;
     men4 = "    ATENCION!!! Libro de I.V.A. Repercutido ...";
 |FINSI;
 |SI #11#2 ! clau;
     |MENAV men4;
     |ERROR;
 |FINSI;
|FPRC;


***************************************************************************
                    CALCULOS DESDE CAMPOS
***************************************************************************

|CALCULO FechaOpe; |TIPO 7;
 |C_M #0#74,0, alfa1;
 |SI alfa1 = "N"; |ACABA; |FINSI;

 |SI #0#74 = "01.01.0000";
     #0#74 = #0#3; |PINTA #0#74;
 |FINSI;
|FCAL;

|PROCESO repite; |TIPO 0;
  |SI FSalida ! 9; |ACABA; |FINSI;
  |SI Campo = 52;
      #0#52 = #0#6;
      sw_defdes = 1;
      ant_con = #0#52;
      |PINTA #0#52;
  |FINSI;
      #0#53 = #0#7;
      |PINTA #0#53;
      |PTEC 802;
|FPRC;

|PROCESO diselo;                   || desde 'PROGRAMA'
    #0#55 = clau;
|SI #0#55 = "R";  alfa1 = "REPERCUTIDO";  |FINSI;
|SI #0#55 = "S";  alfa1 = "SOPORTADO  ";  |FINSI;
|ATRI P;
|PINTA 0545, alfa1;
|ATRI 0;
|FPRC;

|PROCESO control;                  || desde 'PROGRAMA'
 |ABRE #7;
 |DDEFECTO #7;
 |LEE 001#7p;
 |SI FSalida ! 0;
     |MENAV "    Se aconseja definir 'Tratam.IVA/Ficheros Asociados/Control Entrada ...'";
 |FINSI;
 |CIERRA #7;
 #0#56 = #7#01;            || cobros/pagos
 |SI #0#55 = "R";
     #0#00 = #7#03;        || libro repercutido
     #0#06 = #7#05;        || concepto cliente
     #0#07 = #7#07;        || descripcion cliente
     alfa1 = #7#04;   |CAMPO_MODIFICA #0#00, 1, alfa1;
     alfa1 = #7#06;   |CAMPO_MODIFICA #0#06, 1, alfa1;
     alfa1 = #7#08;   |CAMPO_MODIFICA #0#07, 1, alfa1;
     #7#22 = "N";          || el 'deducible' es no modificable en reperc.
 |FINSI;
 |SI #0#55 = "S";
     #0#00 = #7#29;        || libro soportado
     #0#06 = #7#31;        || concepto proveedor
     #0#07 = #7#33;        || descripcion proveedor
     alfa1 = #7#30;   |CAMPO_MODIFICA #0#00, 1, alfa1;
     alfa1 = #7#32;   |CAMPO_MODIFICA #0#06, 1, alfa1;
     alfa1 = #7#34;   |CAMPO_MODIFICA #0#07, 1, alfa1;
 |FINSI;
 #0#29 = #7#09;            || grupo de iva
 #0#32 = #7#11;            || tipo de iva
 #0#52 = #7#13;            || concepto iva
 #0#53 = #7#15;            || descripcion iva
 #0#54 = #7#17;            || bruto/neto
 #0#49 = #7#19;            || departamento
 #0#23 = #7#21;            || deducible
 #0#48 = #7#23;            || inversion

    alfa1 = #7#02;  |CAMPO_MODIFICA #0#56, 1, alfa1;
    alfa1 = #7#10;  |CAMPO_MODIFICA #0#29, 1, alfa1;
    alfa1 = #7#12;  |CAMPO_MODIFICA #0#32, 1, alfa1;
    alfa1 = #7#14;  |CAMPO_MODIFICA #0#52, 1, alfa1;
    alfa1 = #7#16;  |CAMPO_MODIFICA #0#53, 1, alfa1;
    alfa1 = #7#18;  |CAMPO_MODIFICA #0#54, 1, alfa1;
    alfa1 = #7#20;  |CAMPO_MODIFICA #0#49, 1, alfa1;
    alfa1 = #7#22;  |CAMPO_MODIFICA #0#23, 1, alfa1;
    alfa1 = #7#24;  |CAMPO_MODIFICA #0#48, 1, alfa1;
    alfa1 = #7#25;  |CAMPO_MODIFICA #0#02, 1, alfa1;
    alfa1 = #7#26;  |CAMPO_MODIFICA #0#03, 1, alfa1;
    alfa1 = #7#27;  |CAMPO_MODIFICA #0#50, 1, alfa1;
    alfa1 = #7#28;  |CAMPO_MODIFICA #0#44, 1, alfa1;
    alfa1 = #7#35;  |CAMPO_MODIFICA #0#57, 1, alfa1;
    alfa1 = #7#36;  |CAMPO_MODIFICA #0#58, 1, alfa1;
    alfa1 = #7#37;  |CAMPO_MODIFICA #0#69, 1, alfa1;

    aCampo1 = #7#45;
    aCampo2 = #7#48;
    aCampo3 = #7#49;

    LibroAnt = #0#0;

|FPRC;

|PROCESO entrada; |TIPO 7;         || desde campo 'factura/orden'
    modo = (FEntrada / 100) ! 0;
|SI modo = 1;
    |SI #0#55 = "R";  |HAZ entrada_r;  |FINSI;
    |SI #0#55 = "S";  |HAZ entrada_s;  |FINSI;
        #0#0 = anter;             || libro entrada
        #0#2 = antnum + mas;      || factura entrada
    |PINTA #0#2;
|FINSI;
|FPRC;

|PROCESO entrada_r;                || desde calculo 'entrada'
|ABRE #13;                         || ultimo nro. iva repercutido
    mas = 1;
    anter = #0#0;        || libro entrada
    #13#0 = anter;       || libro iva
    #13#2 = 999999;      || factura
|LEE 001#13];
|SI FSalida = 0;
    |LEE 001#13a;
    |SI FSalida ! 0; |O anter ! #13#0;
            mas = 0;
        |DDEFECTO #13;
    |FINSI;
        antnum = #13#2;
|SINO;
    |LEE 001#13u;
    |SI FSalida ! 0; |O anter ! #13#0;
            mas = 0;
        |DDEFECTO #13;
    |FINSI;
        antnum = #13#2;
|FINSI;
|DDEFECTO #13;
|CIERRA #13;
|FPRC;

|PROCESO entrada_s;                || desde calculo 'entrada'
|ABRE #12;                         || ultimo nro. iva soportado
    mas = #11#3;
    anter = #0#0;        || libro entrada
    #12#0 = anter;       || libro iva
    #12#2 = 999999;      || factura
|LEE 001#12];
|SI FSalida = 0;
    |LEE 001#12a;
    |SI FSalida ! 0; |O anter ! #12#0;
            mas = 0;
        |DDEFECTO #12;
    |FINSI;
        antnum = #12#2;
|SINO;
    |LEE 001#12u;
    |SI FSalida ! 0; |O anter ! #12#0;
            mas = 0;
        |DDEFECTO #12;
    |FINSI;
        antnum = #12#2;
|FINSI;
|DDEFECTO #12;
|CIERRA #12;

|ET sientrada;
|SI mas ! 0;
        nume1 = (antnum + mas) $ #11#3;
    |SI nume1 ! 0;
            mas = mas - 1;
        |VETE sientrada;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO fecha; |TIPO 0;           || desde campo 'fecha'
 inkey = FSalida;
 |C_M #0#74, 1, "N";

 |SI inkey = 11; |O #0#74 ! "01.01.0000";
     |C_M #0#74, 1, "S";
 |FINSI;

 |SI #0#3 < fec1; |O #0#3 > fec2;
     |MENAV mensa1;
     |ERROR;
     |ACABA;
 |FINSI;
|FPRC;

|PROCESO defecto; |TIPO 7;         || desde campo 'cuenta'
|SI sw_defcta = 0;
    |SI #0#55 = "S";  #0#4 = "4.";   |FINSI;
    |SI #0#55 = "R";  #0#4 = "43.";  |FINSI;
    |PTEC 816;
        sw_defcta = 1;
|FINSI;
|FPRC;

|PROCESO cuefin; |TIPO 0;          || desde campo 'cuenta'
    digi = Campo + 1;
|ABRE #4;
    #4#0 = #0Campo;
    #4#1 = #0digi;
|LEE 001#4=;
|SI FSalida = 0;
    |SI #4#3 = "S";
        |SI Campo = 4;
           |ABRE #caacrval;
           #caacrval#0 = #camaasix#4;
           #caacrval#1 = #camaasix#5;
           #caacrval#2 = 1;
           |LEE 010#caacrval.];
           |SI FSalida = 0; |Y #caacrval#0 = #camaasix#4; |Y #caacrval#1 = #camaasix#5;
              |PUSHV 05012380;
              Comodin = "caacrvar.tab;" + #camaasix#4 + "/" + #camaasix#5;
              |SUB_EJECUTA Comodin;
              |SI FSalida = 0;
                 |ABRE #calisfra;
                 #calisfra#0 = #camaasix#0;
                 #calisfra#1 = #camaasix#27;
                 #calisfra#2 = #camaasix#2;
                 |LEE 010#calisfra.=;
                 |SI FSalida = 0;
                    #calisfra#3 = #camaasix#4;
                    #calisfra#4 = #camaasix#5;
                    #calisfra#5 = LineaExt;
                    |GRABA 020#calisfra.a;
                 |SINO;
                    |DDEFECTO #calisfra;
                    #calisfra#0 = #camaasix#0;
                    #calisfra#1 = #camaasix#27;
                    #calisfra#2 = #camaasix#2;
                    #calisfra#3 = #camaasix#4;
                    #calisfra#4 = #camaasix#5;
                    #calisfra#5 = LineaExt;
                    |GRABA 020#calisfra.n;
                 |FINSI;
                 |CIERRA #calisfra;
                 #camaasix#57 = NombreExt;
                 #camaasix#58 = CifExt;
              |SINO;
                 |ERROR;
              |FINSI;
              |POPV;
           |SINO;
              |SI #0#55 = "R";  |HAZ lee_clien;  |FINSI;
              |SI #0#55 = "S";  |HAZ lee_prove;  |FINSI;
              #0#57 = #4#2;        || carga el nombre del plan contable
           |FINSI;
           |CIERRA #caacrval;
           |PINTA #0#29;
           |PINTA #0#57;
           |PINTA #0#58;
        |FINSI;
    |SINO;
        |MENAV men3;
        |ERROR;
    |FINSI;
|SINO;
    |ERROR;
|FINSI;
|CIERRA #4;
|FPRC;

|PROCESO lee_clien;                || desde calculo 'cuefin'
  |DDEFECTO #17;
  |ABRE #17;
  #17#23 = "C";
  #17#10 = #4#0;   || cuenta
  #17#11 = #4#1;   || digito
  |LEE 001#17=;
  #0#29 = #17#12;      || grupo de IVA
  #0#58 = #17#9;       || carga el CIF del cliente
  #0#35 = #17#21;      || cta. contrap.
  #0#38 = #17#22;      || dig. contrap.
  |CIERRA #17;
|FPRC;

|PROCESO lee_prove;                || desde calculo 'cuefin'
  |DDEFECTO #17;
  |ABRE #17;
  #17#23 = "P";
  #17#10 = #4#0;   || cuenta
  #17#11 = #4#1;   || digito
  |LEE 001#17=;
  #0#29 = #17#12;      || grupo de IVA
  #0#58 = #17#9;       || carga el CIF del proveedor
  #0#35 = #17#21;      || cta. contrap.
  #0#38 = #17#22;      || dig. contrap.
  |CIERRA #17;
|FPRC;

|PROCESO cuenta; |TIPO 6;
    p_alfa1 = #0Campo;
    salidas = FSalida;
|HAZ punto;
|SI p_error ! 0;  |ERROR;  |ACABA;  |FINSI;
    digi = Campo + 1;
    cta  = #0Campo;
    long = cta % A0;
    cont = 0;
    sw = 0;
    |SI cta = 0;  |Y Campo = 69;
        sw = 1;
        #0digi = 1;
        |ACABA;
    |FINSI;
|SI long = dig4; sw = 1; #0digi = 1; |FINSI;
|SI long = dig5; sw = 1; #0digi = 2; |FINSI;
|SI long = dig6; sw = 1; #0digi = 3; |FINSI;
|SI long = dig7; sw = 1; #0digi = 4; |FINSI;
|SI long = dig8; sw = 1; #0digi = 5; |FINSI;
|SI long = dig9; sw = 1; #0digi = 6; |FINSI;
|SI sw = 0;
    |MENAV men2;
    |ERROR;
    |ACABA;
|FINSI;
|SI #0Campo = doce; |Y Campo ! 69;
    |MENAV "    ATENCION!!! Error de Entrada ...";
    |ERROR;
    |ACABA;
|FINSI;
|FPRC;

|PROCESO final; |TIPO 7;           || desde campo 'descripcion'
  |SI Campo =  7;  nume1 = 34;  |FINSI;
  |SI Campo = 53;  nume1 = 16;  |FINSI;
  |SI #7nume1 = "S";
      |PTEC 816;
  |FINSI;
|FPRC;

|PROCESO control1; |TIPO 0;        || desde campo 'tipo de iva'
  |SI FSalida ! 0;  |ACABA;  |FINSI;
  nume1 = Campo;
  |ABRE #16;
  #16#0 = #0#55;        || soportado/repercutido
  #16#1 = #0#32;        || tipo de iva
  |LEE 001#16=;
  |SI FSalida ! 0;
      |MENAV "    ATENCION!!! No existe control en I.V.A. ...";
      |CIERRA #16;
      |ACABA;
  |FINSI;
  nume1 = #0#35;
  |SI nume1 = 0;             || si la del cliente/proveedor es nada
      #0#35 = #16#2;  || contrapartida
      #0#38 = #16#3;  || digito contrapartida
  |FINSI;
  tipito = 0;
  |SI #0#29 = 1; tipito = #16#4;  |FINSI;
  |SI #0#29 = 2; tipito = #16#5;  |FINSI;
  |SI #0#29 = 3; tipito = #16#6;  |FINSI;
  |SI #0#29 = 4; tipito = #16#7;  |FINSI;
  |SI #0#29 = 5; tipito = #16#8;  |FINSI;
  |SI #0#29 = 6; tipito = #16#9;  |FINSI;
  |SI #0#29 = 7; tipito = #16#10; |FINSI;
  |SI tipito = 0;
      |MENAV "    ATENCION!!! No existe control en I.V.A. ...";
      |CIERRA #6;
      |ACABA;
  |FINSI;
  |ABRE #15;
  #15#0 = #0#55;
  #15#1 = tipito;
  |LEE 001#15=;
  |SI FSalida = 0;
      #0#23 = #15#8;  |PINTA #0#23;   || deducible
      #0#48 = #15#9;  |PINTA #0#48;   || inversion
      #0#72 = #15#10; |PINTA #0#72;   || Intracomunitario para asiento
      #0#50 = #15#3;  |PINTA #0#50;   || cuenta iva
      #0#51 = #15#4;                  || digito iva
      #0#11 = #15#2;  |PINTA #0#11;   || (%) iva 1
      #0#12 = #15#2;  |PINTA #0#12;   || (%) iva 2
      #0#13 = #15#2;  |PINTA #0#13;   || (%) iva 3
      #0#61 = #15#2;  |PINTA #0#61;   || (%) iva 4
      #0#62 = #15#2;  |PINTA #0#62;   || (%) iva 5
      #0#17 = #15#5;  |PINTA #0#17;   || (%) rec.1
      #0#18 = #15#5;  |PINTA #0#18;   || (%) rec.2
      #0#19 = #15#5;  |PINTA #0#19;   || (%) rec.3
      #0#65 = #15#5;  |PINTA #0#65;   || (%) rec.4
      #0#66 = #15#5;  |PINTA #0#66;   || (%) rec.5
      #0#69 = #15#6;  |PINTA #0#69;   || cuenta rec.
      #0#70 = #15#7;                  || digito rec.
  |SINO;
      |MENAV "    ATENCION!!! No existe control en I.V.A. ...";
  |FINSI;
  |CIERRA #15;
  |CIERRA #16;
|FPRC;

|PROCESO suma1; |TIPO 0;           || desde campo 'base'
  sw_netos = 0;
  factor = 3;
  |SI Campo ] 59; factor = 2;  |FINSI;
  c_ivap = Campo + factor;
  c_ivac = Campo + (factor * 2);
  c_recp = Campo + (factor * 3);
  c_recc = Campo + (factor * 4);
  |SI #0#54 = "N";
      sw_netos = 1;
      guarda_base = #0Campo;
      #0Campo = (#0Campo * 100) / (#0c_ivap + #0c_recp + 100);
  |FINSI;
  #0c_ivac = (#0Campo % #0c_ivap) ! EURODB;  || cuota iva  Redondeo EURO
  #0c_recc = (#0Campo % #0c_recp) ! EURODB;  || cuota rec. Redondeo EURO
  |SI sw_netos = 1;
      #0Campo = #0Campo + (guarda_base - (#0Campo + #0c_ivac + #0c_recc));
  |FINSI;
  |PINTA #0Campo;
  |PINTA #0c_ivac;
  |PINTA #0c_recc;
  |HAZ total;
  |HAZ modifica;
|FPRC;

|PROCESO suma2; |TIPO 0;
  |SI #0#54 ! "B";  |ACABA;  |FINSI;
  factor = 3;
  |SI Campo ] 61; factor = 2;  |FINSI;
  c_base = Campo - factor;
  c_ivac = Campo + factor;
  c_recp = Campo + (factor * 2);
  c_recc = Campo + (factor * 3);
  #0c_ivac = #0c_base % #0Campo;  || cuota iva
  |SI sw_netos = 1;
      #0c_base = #0c_base + (guarda_base - (#0c_base + #0c_ivac + #0c_recc));
  |FINSI;
  |PINTA #0c_ivac;
  |HAZ total;
  |HAZ modifica;
|FPRC;

|PROCESO suma3; |TIPO 0;
  |SI #0#54 ! "B";  |ACABA;  |FINSI;
  factor = 3;
  |SI Campo ] 65;  factor = 2;  |FINSI;
  c_base = Campo - (factor * 3);
  c_ivap = Campo - (factor * 2);
  c_ivac = Campo - factor;
  c_recc = Campo + factor;
  #0c_recc = #0c_base % #0Campo;  || cuota rec.
  |SI sw_netos = 1;
       #0c_base = #0c_base + (guarda_base - (#0c_base + #0c_ivac + #0c_recc));
  |FINSI;
  |PINTA #0c_recc;
  |HAZ total;
  |HAZ modifica;
|FPRC;

|PROCESO total;     || desde calculos 'suma1'
  #0#26 = #0#8 + #0#9 + #0#10 + #0#59 + #0#60;
  #0#26 = #0#26 + #0#14 + #0#15 + #0#16 + #0#63 + #0#64;
  #0#26 = #0#26 + #0#20 + #0#21 + #0#22 + #0#67 + #0#68;
  |PINTA #0#26;
|FPRC;              || recalcula total factura

|PROCESO modifica;
  alfa1 = "S";
  |SI #0Campo = 0;  alfa1 = "N";  |FINSI;
  |CAMPO_MODIFICA #0c_ivap, 1, alfa1;
  |CAMPO_MODIFICA #0c_ivac, 1, alfa1;
  |CAMPO_MODIFICA #0c_recp, 1, alfa1;
  |CAMPO_MODIFICA #0c_recc, 1, alfa1;
|FPRC;

|PROCESO nodepar; |TIPO 7;
    alfa1 = #30#24;
   |CAMPO_MODIFICA #0#49, 1, alfa1;
|FPRC;

|PROCESO periodo;
   |SI #caivaasi#53 = "A";
       fecha1 = #0#46;
   |SINO;
       fecha1 = #0#3;
   |FINSI;

   |SI #caivaasi#46 = "T";
       alfa1 = fecha1; alfa1 = alfa1 % -104;      || saca a¤o
       alfa2 = "31.03." + alfa1;  trim1 = alfa2;  || primer trimestre
       alfa2 = "30.06." + alfa1;  trim2 = alfa2;  || segundo trimestre
       alfa2 = "30.09." + alfa1;  trim3 = alfa2;  || tercer trimestre
       |SI fecha1 [ trim1;                    #0#44 = 1;  |FINSI;
       |SI fecha1 > trim1;|Y fecha1 [ trim2;  #0#44 = 2;  |FINSI;
       |SI fecha1 > trim2;|Y fecha1 [ trim3;  #0#44 = 3;  |FINSI;
       |SI fecha1 > trim3;                    #0#44 = 4;  |FINSI;
   |SINO;
       alfa1 = fecha1 % 0402;
       #0#44 = alfa1;
   |FINSI;
   |PINTA #0#44;
|FPRC;

|PROCESO conten; |TIPO 7;
    ant_con = #0Campo;
|FPRC;

|PROCESO descrip; |TIPO 0;
|SI sw_defdes = 0;|O ant_con ! #0Campo;
    |ABRE #6;
    |DDEFECTO #6;
        #6#0 = #0Campo;
    |LEE 001#6=;
    |CIERRA #6;
        desc = Campo + 1;
        Desc = #6#1; |HAZ AplicaDesc;
        #0desc = Desc;
    |PINTA #0desc;
        sw_defdes = 1;
|FINSI;
|FPRC;

***************************************************************************
                    CALCULOS PARA LAS CONTRAPARTIDAS
***************************************************************************

|PROCESO gra_contra;
|SI #0nume1 ! 0;
        t_linea = t_linea + 1;
        #1#0 = 1;               || tonteria
        #1#1 = t_linea;         || linea
        #1#2 = #0#35;           || contrapartida
        #1#3 = #0#38;           || digito contrapartida
        #1#4 = #0#6;            || concepto
        #1#5 = #0#7;            || descripcion
        #1#6 = t_acumu;         || nro. acumulador
        #1#7 = #0nume1;         || importe
    |GRABA 020#1n;
    DescAnt = #0#7;
|FINSI;
|FPRC;

|PROCESO contrap;             || desde 'PROGRAMA'
    t_linea = 0;
    t_bases = #0#8 + #0#9 + #0#10 + #0#59 + #0#60;     || bases imponibles
    ctab1 = "";
    ctab2 = 0;
    sw_pr = 0;
|SI t_bases ! 0;
    |ABRE #1;
    |PARA nume1 =  8; |SI nume1 [ 10; |HACIENDO nume1 = nume1 + 1;
            t_acumu = nume1 - 7;
        |HAZ gra_contra;
    |SIGUE;
    |PARA nume1 = 59; |SI nume1 [ 60; |HACIENDO nume1 = nume1 + 1;
            t_acumu = nume1 - 55;
        |HAZ gra_contra;
    |SIGUE;
    |CIERRA #1;
        sw_vuelve = 1;
    |PARA; |SI sw_vuelve ! 0; |HACIENDO;
        |HAZ ges_lineas;      || edita las lineas grabadas
        |SI sw_vuelve ! 0;
            |HAZ aviso1;
            |HAZ aviso9;
        |FINSI;
    |SIGUE;         || no sale hasta que no cuadran las bases!!!
|FINSI;
|FPRC;

|PROCESO aviso1;         || desde calculo 'contrap'
|PUSHV 09101171;
|HAZ color_f;
|CUADRO 09 10 11 71;
||           123456789012345678901234567890123456789012345678901234567890
    alfa1 = " ATENCION!!! Descuadre de Bases Imponibles > " + descuadre + " ";
|HAZ color_c;
|PINTA 1011, alfa1;
|ATRI 0;
|AVISO;
|PAUSA;
|FPRC;

|PROCESO aviso9;         || desde calculo 'contrap'
|POPV;
|FPRC;

|PROCESO color_c;        || activa el color caracter en avisos
|COLOR 14, 0;
|ATRI 0;
|FPRC;

|PROCESO color_f;        || activa el color graficos en avisos
|COLOR 4, 0;
|ATRI 0;
|FPRC;

**************************************************************************
                CALCULOS DE GRABACION DEL ASIENTO
**************************************************************************

|PROCESO asiento;
|ABRET #2;
|ABRET #3;
|HAZ asiento1;        || apunte del cliente/proveedor
|HAZ asiento2;        || apuntes de contrapartidas
|HAZ asiento3;        || apunte del iva
|HAZ asiento4;        || apunte del recargo
    swt_ficha = 1;  || para que se entere 'camaasic'
|CIERRAT #2;
|CIERRAT #3;
|FPRC;

|PROCESO asiento1;            || apunte cliente/proveedor
    ult_apunt = 1;
|SI #0#55 = "R";  signe = "D";  |FINSI;
|SI #0#55 = "S";  signe = "H";  |FINSI;
  |SI #0#72 = "N";
      impor = #0#26;       || importe CLIENTE/PROVEEDOR
  |SINO;
      impor = #0#8 + #0#9 + #0#10 + #0#59 + #0#60;
  |FINSI;
    conte = #0#4;        || cuenta CLIENTE/PROVEEDOR
    digcu = #0#5;        || digito cuenta
    conce = #0#6;        || concepto
    descr = #0#7;        || descripcion
    tip_acum = "F";
    num_acum = 0;
    departam = #0#49;
|HAZ apuntes;
|FPRC;

|PROCESO contrap1;
|SI #0#55 = "R";  signe = "H";  |FINSI;
|SI #0#55 = "S";  signe = "D";  |FINSI;
    impor = #1#7;        || importe contrapartida
    conte = #1#2;        || contrapartida
    digcu = #1#3;        || digito
    conce = #1#4;        || concepto
    descr = #1#5;        || descrip.
    tip_acum = "B";
    num_acum = #1#6;
    departam = #1#8;
|HAZ apuntes;
|FPRC;

|DEFBUCLE contrap;
 #1#1;
 ;
 1,  1;
 1, 99;
 e;
 NULL, contrap1;
|FIN;

|PROCESO asiento2;
|BUCLE contrap;
|FPRC;

|PROCESO asiento3;            || apunte iva
|SI #0#72 = "S"; |ACABA; |FINSI; || SI es Fra. Intracomunitaria
                                 ||    NO crea apunte de IVA
|SI #0#55 = "R";  signe = "H";  |FINSI;
|SI #0#55 = "S";  signe = "D";  |FINSI;

/*  antes juntaba todos los ivas en uno y grababa un n§acum.6.
    |SI #0#50 = #0#69;
            impor = #0#14+#0#15+#0#16+#0#20+#0#21+#0#22+#0#63+#0#64+#0#67+#0#68;
    |SINO;                             || importe iva (con o sin recargo)
            impor = #0#14+#0#15+#0#16+#0#63+#0#64;
    |FINSI;
            conte = #0#50;                 || cuenta IVA
            digcu = #0#51;                 || digito cuenta
            conce = #0#52;                 || concepto IVA
            descr = #0#53;                 || descrip. IVA
            tip_acum = "I";
            num_acum = 6;
            departam = #0#49;
    |HAZ apuntes;
*/
num_acum = 0;
|PARA nume1 = 14; |SI nume1 [ 64; |HACIENDO nume1 = nume1 + 1;
      |SI nume1 = 17; nume1 = 63; |FINSI;
      num_acum = num_acum + 1;
      |SI #0nume1 ! 0;
          conte = #0#50;                 || cuenta IVA
          digcu = #0#51;                 || digito cuenta
          conce = #0#52;                 || concepto IVA
          descr = #0#53;                 || descrip. IVA
          impor = #0nume1;
          tip_acum = "I";
          departam = #0#49;
          |HAZ apuntes;
      |FINSI;
|SIGUE;
|FPRC;

|PROCESO asiento4;            || apunte recargo
|SI #0#72 = "S"; |ACABA; |FINSI; || SI es Fra. Intracomunitaria
                                 ||    NO crea apunte de RECARGO
|SI #0#55 = "R";  signe = "H";  |FINSI;
|SI #0#55 = "S";  signe = "D";  |FINSI;

/*  antes juntaba todos los recargos en uno y como IVA I/6.
    |SI #0#50 = #0#69;
            impor = 0;
    |SINO;                             || importe recargo
            impor = #0#20+#0#21+#0#22+#0#67+#0#68;
    |FINSI;
        conte = #0#69;                 || cuenta IVA
        digcu = #0#70;                 || digito cuenta
        conce = #0#52;                 || concepto IVA
        descr = #0#53;                 || descrip. IVA
        tip_acum = "I";
        num_acum = 6;
        departam = #0#49;
    |HAZ apuntes;
*/
num_acum = 0;
|PARA nume1 = 20; |SI nume1 [ 68; |HACIENDO nume1 = nume1 + 1;
      |SI nume1 = 23; nume1 = 67; |FINSI;
      num_acum = num_acum + 1;
      |SI #0nume1 ! 0;
          conte = #0#69;                 || cuenta IVA
          digcu = #0#70;                 || digito cuenta
          conce = #0#52;                 || concepto IVA
          descr = #0#53;                 || descrip. IVA
          impor = #0nume1;
          tip_acum = "R";
          departam = #0#49;
          |HAZ apuntes;
      |FINSI;
|SIGUE;

|FPRC;

|PROCESO apuntes;
|SI impor ! 0;|Y conte ! doce;|Y digcu ! 0;
        sw_ivamerr = 0;
    |DDEFECTO #3;
        #3#00 = #0#45;      || diario
        #3#01 = #0#46;      || fecha
        #3#02 = #0#47;      || documento
        #3#03 = ult_apunt;  || apunte
        #3#04 = conte;      || cuenta
        #3#05 = digcu;      || digito cuenta
        #3#06 = conce;      || concepto
        #3#07 = descr;      || descripcion
        #3#08 = signe;      || signo
        #3#09 = impor;      || importe

    |SI #0#71 = "S";|Y #3#9 < 0;   || cambio de signo en abonos
        |SI #3#8 = "D";
                #3#8 = "H";
        |SINO;
                #3#8 = "D";
        |FINSI;
            #3#9 = -#3#9;
        |SI tip_acum = "B"; tip_acum = "b"; |FINSI;
        |SI tip_acum = "I"; tip_acum = "i"; |FINSI;
        |SI tip_acum = "R"; tip_acum = "r"; |FINSI;
    |FINSI;

    |SI #3#08 = "D";
            #3#16 = #3#4;
            #3#17 = #3#5;
    |SINO;
            #3#10 = #3#4;
            #3#11 = #3#5;
    |FINSI;
        #3#12 = #0#55;      || soport./reperc.
        #3#13 = #0#0;       || libro
        #3#14 = #0#2;       || orden
        #3#15 = #0#27;      || serie
        #3#19 = tip_acum;   || tipo acumulador
        #3#20 = num_acum;   || numero acumulador
        #3#21 = departam;   || departamento
    |GRABA 020#3n;
    |HAZ cabecera;
        ressum = #3#9;
    |HAZ actualiz1;     || actualiza cuentas
        opera = "A";
    |HAZ altatra;       || actualiza niveles inferiores
        d_diari = #3#0;
        d_opera = #3#8;
        d_impor = #3#9;
    |HAZ actu_diari;    || actualiza diario
        ult_apunt = ult_apunt + 10;
|FINSI;
|FPRC;

|PROCESO cabecera;
|DDEFECTO #2;
    #2#0 = #3#0;
    #2#1 = #3#1;
    #2#2 = #3#2;
|LEE 101#2=;
    FEstado = FSalida;
    #2#0 = #3#0;         || diario
    #2#1 = #3#1;         || fecha
    #2#2 = #3#2;         || documento
    #2#3 = #2#2;         || asiento
|SI #3#8 = "D";
        #2#4 = #2#4 + #3#9;
    |SI #2#09 = 0; #2#08 = #3#4; #2#09 = #3#5; |FINSI;      || contrp.HABER
|FINSI;
|SI #3#8 = "H";
        #2#5 = #2#5 + #3#9;
    |SI #2#11 = 0; #2#10 = #3#4; #2#11 = #3#5; |FINSI;      || contrp.DEBE
|FINSI;
|SI FEstado = 0;  |GRABA 020#2a;  |FINSI;
|SI FEstado ! 0;  |GRABA 020#2n;  |FINSI;
|LIBERA #2;
|FPRC;

**************************************************************************
            CALCULOS DE GRABACION DEL ASIENTO caentasc/caentasl
**************************************************************************

|PROCESO astobloque;
 |NOME_DAT #103 ext6;
 |ABRET #102;
 |ABRET #103;
 |HAZ astobloque1;        || apunte del cliente/proveedor
 |HAZ astobloque2;        || apuntes de contrapartidas
 |HAZ astobloque3;        || apunte del iva
 |HAZ astobloque4;        || apunte del recargo
    swt_ficha = 1;  || para que se entere 'camaasic'
 |CIERRAT #102;
 |CIERRAT #103;
|FPRC;

|PROCESO astobloque1;            || apunte cliente/proveedor
    ult_apunt = ext5;
|SI #0#55 = "R";  signe = "D";  |FINSI;
|SI #0#55 = "S";  signe = "H";  |FINSI;
  |SI #0#72 = "N";
      impor = #0#26;       || importe CLIENTE/PROVEEDOR
  |SINO;
      impor = #0#8 + #0#9 + #0#10 + #0#59 + #0#60;
  |FINSI;
    conte = #0#4;        || cuenta CLIENTE/PROVEEDOR
    digcu = #0#5;        || digito cuenta
    conce = #0#6;        || concepto
    descr = #0#7;        || descripcion
    tip_acum = "F";
    num_acum = 0;
    departam = #0#49;
|HAZ aptebloque;
|FPRC;

|PROCESO contrapb1;
|SI #0#55 = "R";  signe = "H";  |FINSI;
|SI #0#55 = "S";  signe = "D";  |FINSI;
    impor = #1#7;        || importe contrapartida
    conte = #1#2;        || contrapartida
    digcu = #1#3;        || digito
    conce = #1#4;        || concepto
    descr = #1#5;        || descrip.
    tip_acum = "B";
    num_acum = #1#6;
    departam = #1#8;
|HAZ aptebloque;
|FPRC;

|DEFBUCLE contrapb;
 #1#1;
 ;
 1,  1;
 1, 99;
 e;
 NULL, contrapb1;
|FIN;

|PROCESO astobloque2;
|BUCLE contrapb;
|FPRC;

|PROCESO astobloque3;            || apunte iva
|SI #0#72 = "S"; |ACABA; |FINSI; || SI es Fra. Intracomunitaria
                                 ||    NO crea apunte de IVA
|SI #0#55 = "R";  signe = "H";  |FINSI;
|SI #0#55 = "S";  signe = "D";  |FINSI;
num_acum = 0;
|PARA nume1 = 14; |SI nume1 [ 64; |HACIENDO nume1 = nume1 + 1;
      |SI nume1 = 17; nume1 = 63; |FINSI;
      num_acum = num_acum + 1;
      |SI #0nume1 ! 0;
          conte = #0#50;                 || cuenta IVA
          digcu = #0#51;                 || digito cuenta
          conce = #0#52;                 || concepto IVA
          descr = #0#53;                 || descrip. IVA
          impor = #0nume1;
          tip_acum = "I";
          departam = #0#49;
          |HAZ aptebloque;
      |FINSI;
|SIGUE;
|FPRC;

|PROCESO astobloque4;            || apunte recargo
|SI #0#72 = "S"; |ACABA; |FINSI; || SI es Fra. Intracomunitaria
                                 ||    NO crea apunte de RECARGO
|SI #0#55 = "R";  signe = "H";  |FINSI;
|SI #0#55 = "S";  signe = "D";  |FINSI;
num_acum = 0;
|PARA nume1 = 20; |SI nume1 [ 68; |HACIENDO nume1 = nume1 + 1;
      |SI nume1 = 23; nume1 = 67; |FINSI;
      num_acum = num_acum + 1;
      |SI #0nume1 ! 0;
          conte = #0#69;                 || cuenta IVA
          digcu = #0#70;                 || digito cuenta
          conce = #0#52;                 || concepto IVA
          descr = #0#53;                 || descrip. IVA
          impor = #0nume1;
          tip_acum = "R";
          departam = #0#49;
          |HAZ aptebloque;
      |FINSI;
|SIGUE;

|FPRC;

|PROCESO aptebloque;
|SI impor ! 0;|Y conte ! doce;|Y digcu ! 0;
    sw_ivamerr = 0;
    |DDEFECTO #103;
        #103#00 = ext4;       || Bloque
        #103#01 = ult_apunt;  || apunte
        #103#02 = #0#45;      || diario
        #103#03 = #0#46;      || fecha
        #103#21 = #0#47;      || documento
        #103#04 = conte;      || cuenta
        #103#05 = digcu;      || digito cuenta
        #103#06 = conce;      || concepto
        #103#07 = descr;      || descripcion
        #103#08 = signe;      || signo
        #103#09 = impor;      || importe

    |SI #0#71 = "S";|Y #103#9 < 0;   || cambio de signo en abonos
        |SI #103#8 = "D";
                #103#8 = "H";
        |SINO;
                #103#8 = "D";
        |FINSI;
            #103#9 = -#103#9;
        |SI tip_acum = "B"; tip_acum = "b"; |FINSI;
        |SI tip_acum = "I"; tip_acum = "i"; |FINSI;
        |SI tip_acum = "R"; tip_acum = "r"; |FINSI;
    |FINSI;

        #103#10 = #0#55;      || soport./reperc.
        #103#11 = #0#0;       || libro
        #103#12 = #0#2;       || orden
        #103#13 = #0#27;      || serie
        #103#15 = tip_acum;   || tipo acumulador
        #103#16 = num_acum;   || numero acumulador
        #103#17 = departam;   || departamento
    |GRABA 020#103n;
    |HAZ cabBloque;
        #3#0 = #103#2; || Diario de Apuntes;
        #3#1 = #103#3; || Fecha de Apuntes;
        #3#4 = #103#4; || Cuenta
        #3#5 = #103#5; || Digito
        #3#8 = #103#8; || Signo
        #3#9 = #103#9; || Importe
        ressum = #103#9;
    |HAZ actualiz1;     || actualiza cuentas
        d_diari = #103#2;
        d_opera = #103#8;
        d_impor = #103#9;
    |HAZ actu_diari;    || actualiza diario
        ult_apunt = ult_apunt + 10;
        ext5 = ult_apunt;
|FINSI;
|FPRC;

|PROCESO cabBloque;
|DDEFECTO #102;
    #102#0 = #103#0;
|LEE 101#102=;
    FEstado = FSalida;
    #102#0 = #103#0;         || Bloque
    #102#1 = #103#2;         || Diario
    #102#2 = #103#3;         || fecha
    #102#3 = #103#21;        || documento
|SI #103#8 = "D";
    #102#4 = #102#4 + #103#9;
|SINO;
    #102#5 = #102#5 + #103#9;
|FINSI;
#102#6 = #102#4 - #102#5;
|SI FEstado = 0;  |GRABA 020#102a;  |FINSI;
|SI FEstado ! 0;  |GRABA 020#102n;  |FINSI;
|LIBERA #102;
|FPRC;


***************************************************************************
              CALCULOS DE GRABACION DE LOS HISTORICOS DE IVA
***************************************************************************

|PROCESO grabarep;
|ABRE #13;
|PARA nume1 =  0; |SI nume1 [ 49; |HACIENDO nume1 = nume1 + 1;
        #13nume1 = #0nume1;
|SIGUE;
|PARA nume1 = 50; |SI nume1 [ 61; |HACIENDO nume1 = nume1 + 1;
        nume2 = nume1 + 7;
        #13nume1 = #0nume2;
|SIGUE;
|GRABA 040#13n;
|PARA; |SI FSalida ! 0; |HACIENDO;      || por si mientras han dado de alta
        #13#2 = #13#2 + 1;              ||/este numero de factura!!!
    |GRABA 040#13n;
|SIGUE;
|CIERRA #13;

|SI #0#74 > "01.01.0000";
    |ABRE #112;
    #112#0 = #13#0;
    #112#1 = #13#27;
    #112#2 = #13#2;
    #112#3 = #0#74;
    |GRABA 040#112n;
    |CIERRA #112;
|FINSI;
|FPRC;

|PROCESO grabasop;
|ABRE #12;
|PARA nume1 =  0; |SI nume1 [ 49; |HACIENDO nume1 = nume1 + 1;
    #12nume1 = #0nume1;
|SIGUE;
|PARA nume1 = 50; |SI nume1 [ 61; |HACIENDO nume1 = nume1 + 1;
        nume2 = nume1 + 7;
        #12nume1 = #0nume2;
|SIGUE;
|GRABA 040#12n;
|PARA; |SI FSalida ! 0; |HACIENDO;      || por si mientras han dado de alta
        #12#2 = #12#2 + 10;             ||/este numero de orden!!!
    |GRABA 040#12n;
|SIGUE;
|CIERRA #12;
|SI #0#74 > "01.01.0000";
    |ABRE #113;
    #113#0 = #12#0;
    #113#1 = #12#27;
    #113#2 = #12#2;
    #113#3 = #0#74;
    |GRABA 040#113n;
    |CIERRA #113;
|FINSI;
|FPRC;
____________________________________/ GESTION LINEAS DE COMPRAS/VENTAS
|PROCESO ges_lineas;
|PINPA #0#1;
|DDEFECTO #1;
|ENTLINEAL #1#1, 2, 2, 23, 0, min, max;
|HAZ alsalir;
|FPRC;

|PROCESO min;
    #1#0 = 1;
    #1#1 = 1;
|FPRC;

|PROCESO max;
    #1#0 = 1;
    #1#1 = 99;
|FPRC;

|PROCESO sumalos;
    t_sumas = t_sumas + #1#7;
    |SI sw_pr= 0;
        sw_pr= 1;
        ctab1=#1#2;
        ctab2=#1#3;
    |FINSI;
|FPRC;

|DEFBUCLE comprueba;
 #1#1;
 ;
 1,  1;
 1, 99;
 e;
 NULL, sumalos;
|FIN;

|PROCESO alsalir;
    sw_vuelve = 0;
    t_sumas = 0;
|BUCLE comprueba;
|SI EURO < 1;
   Calc1 = t_sumas ! EURODV;
   Calc2 = t_bases ! EURODV;
|SINO;
   Calc1 = t_sumas ! EURODB;
   Calc2 = t_bases ! EURODB;
|FINSI;

|SI Calc1 ! Calc2;
        sw_vuelve = 1;
        nume1 = t_bases - t_sumas;
        descuadre = nume1;
        descuadre = "              " + descuadre;
        descuadre = descuadre % -114;
|FINSI;
|FPRC;
____________________________________/ CALCULOS DE LA PANTALLA 'camaasiy'
|PROCESO cuenta_g; |TIPO 6;   || contrapartidas
  alfa4 = #0Campo;
  |PUSHV 0658 0679;
  p_alfa1 = #1Campo;
  salidas = FSalida;
  |HAZ punto;
  #1Campo = p_alfa5;
  #0Campo = alfa4;          || restaura, porque 'punto' trabaja con #0Campo
  |PINTA #1Campo;
  |POPV;
  |PINTA #0Campo;
  |SI p_error ! 0;  |ERROR;  |ACABA;  |FINSI;
  nume1 = Campo + 1;
  alfa1 = #1Campo;
  |QBF alfa1;
  alfa1 = alfa1 % 0;
  long = alfa1;
  sw   = 0;
  #1nume1 = 0;  || inicializa el digito
  |SI long = dig4; |Y dig4 ! 0; sw = 1; #1nume1 = 1; |FINSI;
  |SI long = dig5; |Y dig5 ! 0; sw = 1; #1nume1 = 2; |FINSI;
  |SI long = dig6; |Y dig6 ! 0; sw = 1; #1nume1 = 3; |FINSI;
  |SI long = dig7; |Y dig7 ! 0; sw = 1; #1nume1 = 4; |FINSI;
  |SI long = dig8; |Y dig8 ! 0; sw = 1; #1nume1 = 5; |FINSI;
  |SI long = dig9; |Y dig9 ! 0; sw = 1; #1nume1 = 6; |FINSI;
  |SI sw = 0;|Y long ! 0;
      |MENAV "    Longitud de Cuenta Fuera de Nivel !";
      |ERROR;
      |ACABA;
  |FINSI;
|FPRC;

|PROCESO cuefin_g; |TIPO 0;             || desde campo 'cuenta'
  digi = Campo + 1;
  |ABRE #4;
  #4#0 = #1Campo;
  #4#1 = #1digi;
  |LEE 040#4=;
  |SI FSalida ! 0;
      |CIERRA #4;
      |ERROR;
      |ACABA;
  |FINSI;
  |SI #4#3 = "N";
      |MENAV "    ATENCION!!! Cuenta sin Pase Directo ...";
      |CIERRA #4;
      |ERROR;
      |ACABA;
  |FINSI;
  |PINTA 1925, "                                        ";
  |ATRI I;
  |PINTA 1926,#4#2;
  |ATRI 0;
  |CIERRA #4;
|FPRC;

|PROCESO nodepar_g; |TIPO 7;
  |SI #30#24 = "N";
      |CAMPO_MODIFICA #1#8, 1, "N";
  |SINO;
      |CAMPO_MODIFICA #1#8, 1, "S";
  |FINSI;
|FPRC;

|PROCESO letra_0;  |TIPO 6;
     |SI FSalida = 9;
         eaVarDni   = #0Campo;
         enCalcCif  = 1;
         |HAZ CalculoDNI;
         #0Campo = eaVarDni;
         |PINTA #0Campo;
         |ERROR;
         |ACABA;
     |FINSI;

     eaVarDni  = #0Campo;
     enCalcCif = 0;
     |HAZ CalculoDNI;

     aNifQbf1 = #0Campo;   |QBF aNifQbf1;
     aNifQbf2 = eaVarDni;  |QBF aNifQbf2;

     |SI aNifQbf1 ! aNifQbf2; |Y aNifQbf1 ! "";
        |SI #caclipro#24 = "ES "; |O #caclipro#24 = "E  "; |O  #caclipro#24 = "   ";
            |CONFI "0000SEl Nif puede ser Erroneo. Desea Calcularlo.";
            |SI FSalida = 0;
                #0Campo = eaVarDni;  |PINTA #0Campo;
                |ERROR;
            |FINSI;
         |FINSI;
     |FINSI;
|FPRC;


|PROCESO el_inver; || factura de Inversion
  |AVISO;
  |CONFI "2400SFra. de Inversion. Desea crear el Bien Amortizable S/N : ";
  |SI FSalida ! 0;
      |ACABA;
  |FINSI;
  fec_am = #0#3;
  imp_am = #0#8 + #0#9 + #0#10 + #0#59 + #0#60;
  c_am = #0#7;
  ct1_am = "";
  ct2_am = 0;
  prv_am = #0#57;
                      || primer = #0#4 % 101;
                      || |SI primer = "4";
                      ||     prv_am = #0#57;
                      || |FINSI;
  primer = ctab1 % 101;
  |SI primer = "2";
      ct1_am = ctab1;
      ct2_am = ctab2;
  |FINSI;
  |SUB_EJECUTA "camocab1.tab";
|FPRC;

|PROCESO el_inverv; || factura de Inversion VENTA
  |AVISO;
  |CONFI "2400SFra. de Inversion. Desea reflejar la venta del Bien Amortizable S/N : ";
  |SI FSalida ! 0;
      |ACABA;
  |FINSI;
  fec_am = #0#3;
  imp_am = #0#8 + #0#9 + #0#10 + #0#59 + #0#60;
  c_am = #0#7;
  |SUB_EJECUTA "camocab2.tab";
|FPRC;

|PROCESO CampoFijo; |TIPO 7;

   ModoEntrada = FEntrada $ 100;
   |SI ModoEntrada ! 1; |Y LibroAnt = #camaasix#0; |ACABA; |FINSI;

   |SI LibroAnt ! #camaasix#0;
      |ABRE #calibros;
      #calibros#0 = LibroAnt;
      |LEE 110#calibros.=;
      |SI FSalida = 0;
         |SI #calibros#4 = #camaasix#2;
            #calibros#4 = 1;
            |GRABA 020#calibros.a;
         |FINSI;
      |FINSI;
      |LIBERA #calibros;
      |CIERRA #calibros;
      LibroAnt = #camaasix#0;
   |FINSI;

   |SI #caivaasi#44 = "N";
      |C_M #camaasix#27,1,"N";
      |SI #calibros#2 = "R";
         |ABRE #caivarep;
         #caivarep#0 = #camaasix#0;
         #caivarep#27 = "  ";
         #caivarep#2 = 999999;
         |LEE 010#caivarep.];
         |SI FSalida ! 0;
            |LEE 010#caivarep.u;
            |SI #caivarep#0 ! #camaasix#0; |O #caivarep#27 ! #camaasix#27;
               #camaasix#2 = 1;
            |FINSI;
         |SINO;
            |SI #caivarep#0 ! #camaasix#0; |O #caivarep#27 ! #camaasix#27;
               |LEE 010#caivarep.a;
            |FINSI;
         |FINSI;

         |SI FSalida = 0; |Y #caivarep#0 = #camaasix#0; |Y #caivarep#27 = #camaasix#27;
            |ABRE #calibros;
            #calibros#0 = #camaasix#0;
            |LEE 110#calibros.=;
            |SI #caivarep#2 [ #calibros#4;
               #camaasix#2 = #calibros#4;
               #calibros#4 = #calibros#4 + 1;
               |GRABA 020#calibros.a;
            |SINO;
               #camaasix#2 = #caivarep#2 + 1;
               #calibros#4 = #camaasix#2 + 1;
               |GRABA 020#calibros.a;
            |FINSI;
            |LIBERA #calibros;
            |CIERRA #calibros;
         |FINSI;

         |CIERRA #caivarep;
      |FINSI;

      |SI #calibros#2 = "S";
         |ABRE #caivasop;
         #caivasop#0 = #camaasix#0;
         #caivasop#27 = "  ";
         #caivasop#2 = 999999;
         |LEE 010#caivasop.];
         |SI FSalida ! 0;
            |LEE 010#caivasop.u;
            |SI #caivasop#27 ! #camaasix#27; |O #caivasop#0 ! #camaasix#0;
               #camaasix#2 = 1;
            |FINSI;
         |SINO;
            |SI #caivasop#27 ! #camaasix#27; |O #caivasop#0 ! #camaasix#0;
               |LEE 010#caivasop.a;
            |FINSI;
         |FINSI;
         |SI FSalida = 0; |Y #caivasop#27 = #camaasix#27; |Y #caivasop#0 = #camaasix#0;
            |ABRE #calibros;
            #calibros#0 = #camaasix#0;
            |LEE 110#calibros.=;
            |SI #caivasop#2 [ #calibros#4;
               #camaasix#2 = #calibros#4;
               #calibros#4 = #calibros#4 + #calibros#3;
               |GRABA 020#calibros.a;
            |SINO;
               #camaasix#2 = #caivasop#2;
               #calibros#4 = #caivasop#2 + #calibros#3;
               |GRABA 020#calibros.a;
            |FINSI;
            |LIBERA #calibros;
            |CIERRA #calibros;
         |FINSI;
         |CIERRA #caivasop;
      |FINSI;
   |SINO;
      |C_M #camaasix#27,1,"S";
   |FINSI;

   #camaasix#73 = #calibros#2;
|FPRC;

|PROCESO MiraSerie;
   |SI #caivaasi#44 = "N";
      |C_M #camaasix#27,1,"N";
      |ACABA;
   |SINO;
      |C_M #camaasix#27,1,"S";
   |FINSI;

   |SI SerieAnt ! #camaasix#27;
      |ABRE #caivases;
      |SI SerieAnt ! "  XX";
         #caivases#0 = SerieAnt;
         #caivases#1 = #0#55;
         |LEE 110#caivases.=;
         |SI FSalida = 0;
            ComodNum = #camaasix#2 + #caivases#4;
            |SI ComodNum = #caivases#3;
               #caivases#3 = #caivases#3 - #caivases#4;
               |GRABA 020#caivases.a;
            |FINSI;
         |FINSI;
         |LIBERA #caivases;
      |FINSI;
      #caivases#0 = #camaasix#27;
      #caivases#1 = #0#55;
      |LEE 110#caivases.=;
      |SI FSalida = 0;
         #camaasix#2 = #caivases#3;
         #caivases#3 = #caivases#3 + #caivases#4;
         |GRABA 020#caivases.a;
      |FINSI;
      |LIBERA #caivases;
      |CIERRA #caivases;
      SerieAnt = #camaasix#27;
      |PINTA #camaasix#2;
   |FINSI;
|FPRC;

|PROCESO cheq_fra;
   |SI #0#55 = "R";
      |ABRE #caivarep;
      #caivarep#0  = #camaasix#0;
      #caivarep#27 = #camaasix#27;
      #caivarep#2  = #camaasix#2;
      |LEE 010#caivarep.=;
      |SI FSalida = 0;
         |MENAV "    La factura ya existe ";
         |ERROR;
      |SINO;
         |SI #camaasix#2 ! Contenido;
            |SI #caivaasi#44 = "S";
               |ABRE #caivases;
               #caivases#0 = #camaasix#27;
               #caivases#1 = "R";
               |LEE 110#caivases.=;
               |SI FSalida = 0;
                  #caivases#3 = #camaasix#2 + 1;
                  |GRABA 020#caivases.a;
               |FINSI;
               |LIBERA #caivases;
               |CIERRA #caivases;
            |SINO;
            |FINSI;
         |FINSI;
      |FINSI;
      |CIERRA #caivarep;
   |FINSI;

   |SI #0#55 = "S";
      |ABRE #caivasop;
      #caivasop#0  = #camaasix#0;
      #caivasop#27 = #camaasix#27;
      #caivasop#2  = #camaasix#2;
      |LEE 010#caivasop.=;
      |SI FSalida = 0;
         |MENAV "    La factura ya existe ";
         |ERROR;
      |SINO;
         |SI #camaasix#2 ! Contenido;
            |SI #caivaasi#44 = "S";
               |ABRE #caivases;
               #caivases#0 = #camaasix#27;
               #caivases#1 = "S";
               |LEE 110#caivases.=;
               |SI FSalida = 0;
                  #caivases#3 = #camaasix#2 + #caivases#4;
                  |GRABA 020#caivases.a;
               |FINSI;
               |LIBERA #caivases;
               |CIERRA #caivases;
            |SINO;
            |FINSI;
         |FINSI;
      |FINSI;
      |CIERRA #caivasop;
   |FINSI;

   |HAZ Botones3824;
|FPRC;

|PROCESO AplicaDesc;

   |PARA Cont = 1; |SI Cont [ 3; |HACIENDO Cont = Cont + 1;
         Calc  = (Cont * 100) + 1;
         Letra = #caivaasi#45 % Calc;
         |SI Letra = "S";
             |QBF Desc;
              Desc = Desc + #camaasix#27 + aCampo2;
         |FINSI;
         |SI Letra = "F";
             |QBF Desc;
             Comodin = ("000000" + #camaasix#2) % -106;
             |SI aCampo3 = "N"; Comodin = #camaasix#2; |FINSI;
             Desc = Desc + Comodin;
         |FINSI;

         |SI Letra = "C";
             |QBF Desc;
             Desc = Desc + " " + #camaasix#4;
         |FINSI;
   |SIGUE;
|FPRC;

|PROCESO Descrip;
   |SI FSalida = 9;
      #camaasiy#5 = DescAnt;
   |FINSI;
   |PINTA #camaasiy#5;
|FPRC;

|PROCESO TomaDesc; |TIPO 3;
   DescAnt = #camaasiy#5;
|FPRC;



|PROGRAMA;
     |HAZ BuscaModulo;
     |HAZ inicio;
     |HAZ nom_usu;
     alfa1 = "i" + nom_tmp;
     |NOME_DAT #1 alfa1;
     |ABRE #1;  |CIERRA #1;  |DELINDEX #1;

     |DDEFECTO #0;
     #0#45 = ext1;   || diario
     #0#46 = ext2;   || fecha
     #0#47 = ext3;   || documento
     #0#03 = ext2;   || fecha IVA (por defecto la del asiento)
     |BLIN 4;

     |PINPA #0#0;
     |HAZ diselo;
     |HAZ control;
     |PINDA #0#0;
     sw_ivamerr = 1;
     |ENDATOS #1#0;
     |SI FSalida = 0;
         |HAZ contrap;
         |SI ext7 = "B";
             |HAZ astobloque;
         |SINO;
             |HAZ asiento;
         |FINSI;

         |SI #0#72 = "N";
             nImpCartera = #0#26;
         |SINO;
            nImpCartera = #0#8 + #0#9 + #0#10 + #0#59 + #0#60;
         |FINSI;

         |SI #0#55 = "R";  |HAZ grabarep;  |FINSI;
         |SI #0#55 = "S";  |HAZ grabasop;  |FINSI;
         |SI #0#55 = "R"; |Y #0#56 = "S";  |HAZ cobros;  |FINSI;
         |SI #0#55 = "S"; |Y #0#56 = "S";  |HAZ pagos;   |FINSI;
         |SI #0#55 = "S"; |Y #0#48 = "S";  |HAZ el_inver; |FINSI;
         |SI #0#55 = "R"; |Y #0#48 = "S";  |HAZ el_inverv; |FINSI;
     |SINO;
         |SI #caivaasi#44 = "S";
             |ABRE #caivases;
             #caivases#0 = #camaasix#27;
             |LEE 110#caivases.=;
             |SI FSalida = 0;
                 ComodNum = #camaasix#2 + #caivases#4;
                 |SI ComodNum = #caivases#3;
                     #caivases#3 = #caivases#3 - #caivases#4;
                     |GRABA 020#caivases.a;
                 |FINSI;
             |FINSI;
             |LIBERA #caivases;
             |CIERRA #caivases;
         |SINO;
             |ABRE #calibros;
             #calibros#0 = #camaasix#0;
             |LEE 110#calibros.=;
             |SI FSalida = 0;
                 |SI #0#55 = "S"; nCalc = #calibros#4 - #calibros#3; |FINSI;
                 |SI #0#55 = "R"; nCalc = #calibros#4 - 1;           |FINSI;
                 |SI nCalc = #camaasix#2;
                     |SI #0#55 = "S"; #calibros#4 = #calibros#4 - #calibros#3; |FINSI;
                     |SI #0#55 = "R"; #calibros#4 = #calibros#4 - 1; |FINSI;
                     |GRABA 020#calibros.a;
                 |FINSI;
             |FINSI;
             |LIBERA #calibros;
             |CIERRA #calibros;
         |FINSI;
         |CIERRA #1;
         |DELINDEX #1;
     |FINSI;

     |SI swModulo = 3824;
         |FIN_CONTROL_WINDOWS nBtnPDF1;
         |FIN_CONTROL_WINDOWS nBtnPDF2;
     |FINSI;
|FPRO;
