|FICHEROS;
    asfacges #0;
    ascabmin #1;
    aslinmin #2;
    ascontro #4;
    asempres #3;
    asclient #5;
    asfpagos #7;

    ascabfdi #8;
    aslinfdi #9;
    ascontfd #12;

    ashismic #10;
    ashismil #11;

    asm00003 #500;

    Ref0001@ #1999;
|FIN;

|VARIABLES;
     aTipoFactura = "";   || (N)ormal; (D)irecta; (H)istorico
     aAlfa = "";

     &eaArCodCli = "";  || Codigo Cliente
     &eaArNomCli = "";  || Nombre Cliente
     &eaArCodCif = "";  || Cif
     &eaArNomCif = "";  || Nombre Cif
     &eaArCodTra = "";  || Codigo Trabajador
     &eaArNomTra = "";  || Nombre Trabajador
     &eaArCamPDF = "";  || Camino al PDF a archivar
     &eaAplicacion = "";
     &eaDefFE = "";
     &eaEmpresaFE = "";
     &eaSerieFE = "";
     &eaNumeroFE = "";
     &eaDefLinFe = "";
     &eaDefEmpFe = "";
     &eaDefCliFe = "";
     &eaDefIvaFe = "";
     &eaCodCliFe = "";
     &eaDefAlbFe = "";
     &enTipoIvaFe = 0;
     &enTipoFacFe = 0;

     &eaArTipoDoc = ""; || Tipo documento.  FD, FV, etc ...
     &eaArSerDoc = "";  || Serie Docuemnto.
     &enArNumDoc = 0;   || Numero Documento
     &eaArFecDoc = "";  || Fecha Documento.


     &eaSwEnvioCorreo = "";  ||Indica si se enivia por correo al emitir la minuta
     &eaDirDesFE = "";  || Direccion destino para envio por correo
     &eaFirmarFE = "";  || Indica si tenemos que firmar o no el documento

     aPath = "";
     nOpcion = 0;
     nArchi = 0;
     nSwFirma = 0;
     &eaArGrpMin = "";  || Grupo archivo en caso de archivar desde minutacion
     &eaArSbGMin = "";  || Subgrupo archivo en caso de archivar desde minutacion
     &eaArTipMin = "";  || Tipo archivo en caso de archivar desde minutacion
     {-1}aMenu  = "";
         aMenu1 = "2400";
         aMenu2 = "1";
         aMenu3 = "";
         aMenu4 = "APSC";
         aMenu5 = "Archivar";
         aMenu6 = "Papel";
         aMenu7 = "S/Conf.Cli.";
         aMenu8 = "Cancelar";


    thono1    = 0;
    impdto    = 0;
    timp      = 0;
    tret      = 0;
    tpagar    = 0;
    cab       = "Control";
    informe   = "";

    fechav    = @;
    em        = 0;
    j         = 0;

    indihono  = 0;
    i         = 0;
    SwLectura = 0;

    D_Serie   = "";
    H_Serie   = "";
    D_Factura = 0;
    H_Factura = 0;
    D_TipoFac = 0;
    H_TipoFac = 0;
    D_Cliente = 0;
    H_Cliente = 0;
    D_Linea   = 0;
    H_Linea   = 0;
    aAct      = "";

    &enFactor   = 0;
    &enSwCuotas = 0;
    &enTipoFac = 0;
    &descr1    = "";
    &descr2    = "";
    &descr3    = "";
    &retsino   = "";
    &timporte  = 0;
    &serie     = "  "
    &sw        = 0;
    &vacio     = "                                        ";
    &factura   = 0;
    &ivabo     = 0;
    &acum      = 0;
    &hono      = 0;
    &supli     = 0;
    &ret       = 0;
    &dto       = 0;
    &fech      = @;
    &fechv     = @;
    &unidades  = 0;
    &ptasunid  = 0;
    &tipo      = "";
    &tacum     = 0;
    &thono     = 0;
    &tsupli    = 0;
    &tfac      = 0;
    &cargo     = 0;
    &cargo_h   = 0;
    &abono     = 0;
    &abono_h   = 0;
    &seccion   = "";
    &concepto  = "";
    &fecha_lin = "";
    &saldo_a   = 0;
    &tsal_a    = 0;
    &acuen_a   = 0;
    &acuen_i   = 0;
    &d_viene   = 0;

    &tipo_d    = 0;
    &cliente_d = 0;
    &serie_d   = "";
    &factura_d = 0;

    &d_serie   = "";
    &h_serie   = "";
    &d_factu   = 0;
    &h_factu   = 0;
    &d_fecha   = @;
    &h_fecha   = @;
    &empresa   = 0;
    &cuotas    = "";
    &observa   = "";
    &Cab1      = "";
    &Cab2      = "";
    &Cab3      = "";
    &Pie1      = "";
    &Pie2      = "";
    &Pie3      = "";

    {-1}&des   = "                                        ";
        &des1  = "                                        ";
        &des2  = "                                        ";
        &des3  = "                                        ";
        &des4  = "                                        ";
        &des5  = "                                        ";
        &des6  = "                                        ";
        &des7  = "                                        ";
        &des8  = "                                        ";
        &des9  = "                                        ";
        &des10 = "                                        ";
        &des11 = "                                        ";
        &des12 = "                                        ";

    {-1}&imp   = 0;
        &imp1  = 0;
        &imp2  = 0;
        &imp3  = 0;
        &imp4  = 0;
        &imp5  = 0;
        &imp6  = 0;
        &imp7  = 0;
        &imp8  = 0;
        &imp9  = 0;
        &imp10 = 0;
        &imp11 = 0;
        &imp12 = 0;

    {-1}parada  = "";
        parada1 = "2400";
        parada2 = "1";
        parada3 = "  PAUSA por cada Factura : ";
        parada4 = "NS";
        parada5 = "  No  ";
        parada6 = "  Si  ";

    aSerie    = "";
    nFactura  = 0;
    aSeccion  = "";
    aConcept  = "";
    aDescrip  = "";
    aDescri1  = "";
    aDescri2  = "";
    aDescri3  = "";
    nImporte  = 0;
    nLinea    = 0;
    nTipoFac  = 0;
    nCliente  = 0;
    &enUnidades = 0;
    &enImpTotal = 0;
    &enOrden    = 0;

    &EURODB   = 0;
|FIN;

|INCLUYE i_lletre;
|INCLUYE i_asefec;

|| ***********************************************************************
||                      IMPRESION FACTURAS DESDE MINUTAS NORMALES
|| ***********************************************************************

|PROCESO Linlinmin;
   |SI #2#6 = aDescrip; |Y #2#7 = aDescri1; |Y #2#8 = aDescri2;
    |Y #2#9 = aDescri3; |Y #2#12 = nImporte;
      enUnidades = enUnidades + #2#11;
      enImpTotal = enImpTotal + #2#13;
      |SI #2#2 [ nLinea; enOrden = enOrden + 1; |FINSI;
   |SINO;
      enOrden = 1;
   |FINSI;
|FPRC;

|DEFBUCLE Linlinmin; || PEPE
#aslinmin#1;
4,5;
nTipoFac, nCliente, 001, aSeccion, aConcept;
nTipoFac, nCliente, 999, aSeccion, aConcept;
;
NULL,Linlinmin;
|FIN:

|PROCESO Cuotas;
   |PRINT;
|FPRC;

|DEFBUCLE Cuotas;
#asm00003#1;
;
D_TipoFac,D_Cliente,D_Serie,D_Factura,aAct,D_Linea,01;
H_TipoFac,H_Cliente,H_Serie,H_Factura,aAct,H_Linea,99;
;
NULL,Cuotas;
|FIN;

|PROCESO imprelin_n;
|SI SwLectura = 1;
    |SI #2#4 = "ASUN"; |Y #2#5 = "01";
        Cab1 = #2#7;
        Cab2 = #2#8;
        Cab3 = #2#9;
    |FINSI;

    |SI #2#4 = "OBSE"; |Y #2#5 = "01";
        Pie1 = #2#7;
        Pie2 = #2#7;
        Pie3 = #2#7;
    |FINSI;
    |ACABA;
|FINSI;

|SI informe = "asfacjgs";
    |SI #2#4 = "ASUN"; |Y #2#5 = "01";
        |ACABA;
    |FINSI;

    |SI #2#4 = "OBSE"; |Y #2#5 = "01";
        |ACABA;
    |FINSI;
|FINSI;

|SI informe = "asfacase";  |O informe = "feuroase";
    tipo_ase = #2#10;
    secc_ase = #2#4;
    conc_ase = #2#5;
    dcab_ase = #2#6;
    impo_ase = #2#13;
    des2_ase = #2#8;
    des3_ase = #2#9;
    |SI informe = "asfacase";  enFactor = 1;        |FINSI;
    |SI EURODB = 0;
        |SI informe = "feuroase";  enFactor = 166.386;  |FINSI;
    |SINO;
        |SI informe = "feuroase";  enFactor = 1;        |FINSI;
    |FINSI;
    |HAZ asefeco;
    |ACABA;
|FINSI;

||     PEPE
|SALVA_FICHA #2;
nTipoFac = #2#0;
nCliente = #2#1;
aSeccion = #2#4;
aConcept = #2#5;
aDescrip = #2#6;
aDescri1 = #2#7;
aDescri2 = #2#8;
aDescri3 = #2#9;
nImporte = #2#12;
nLinea   = #2#2;
enUnidades = 0; enImpTotal = 0;
enOrden    = 0;
|BUCLE Linlinmin;
|REPON_FICHA #2;
|| FIN PEPE

descr1   = #2#7;
descr2   = #2#8;
descr3   = #2#9;
unidades = #2#11;
ptasunid = #2#12;
seccion  = #2#4;
concepto = #2#5;
fecha_lin = #2#15;

cargo_h = 0;
abono_h = 0;
saldo_a = 0;
acuen_a = 0;
acuen_i = 0;
hono    = 0;
supli   = 0;
acum    = 0;
timporte = 0;
cargo    = 0;
abono    = 0;

|SI #2#10 = "H";
    |SI #2#13 > 0;
        cargo_h = #2#13;
        cargo   = #2#13;
        abono   = 0;
        abono_h = 0;
    |SINO;
        abono   = -#2#13;
        abono_h = -#2#13;
        cargo   = 0;
        cargo_h = 0;
    |FINSI;

    hono     = #2#13;
    supli    = 0;
    acum     = 0;
    timporte = hono;
    sw       = 0;
    tipo     = "H";
|FINSI;

|SI #2#10 = "S";
    |SI #2#13 > 0;
        cargo = #2#13;
        abono = 0;
    |SINO;
        abono = -#2#13;
        cargo = 0;
    |FINSI;

    supli    = #2#13;
    hono     = 0;
    acum     = 0;
    timporte = supli;
    sw       = 0;
    tipo     = "S";
|FINSI;

|SI #2#10 = "A";
    |SI #2#13 > 0;
        abono   = #2#13;
        cargo   = 0;
        acuen_a = #2#13;
        acuen_i = #2#13;
    |SINO;
        cargo   = -#2#13;
        abono   = 0;
        acuen_i = -#2#13;
        saldo_a = -#2#13;
    |FINSI;

    acum     = #2#13;
    hono     = 0;
    supli    = 0;
    timporte = acum;
    tsal_a   = tsal_a + saldo_a;
    sw       = 1;
    tipo     = "A";
|FINSI;

tacum  = tacum + acum;
thono  = thono + hono;
tsupli = tsupli + supli;

|SI indihono < 12;
    Ides     = des1 <-;
    Ides     = Ides + indihono;
    des      = #2#6;
    Iimp     = imp1 <-;
    Iimp     = Iimp + indihono;
    imp      = #2#13;
    indihono = indihono + 1;
|FINSI;

|PRINT;

|SI #asfacges#10 = "S";
   enSwCuotas = 1;
   D_TipoFac  = #aslinmin#0;  H_TipoFac  = #aslinmin#0;
   D_Cliente  = #aslinmin#1;  H_Cliente  = #aslinmin#1;
   D_Serie    = #ascabmin#27; H_Serie    = #ascabmin#27;
   D_Factura  = #ascabmin#28; H_Factura  = #ascabmin#28;
   D_Linea    = #aslinmin#2;  H_Linea    = #aslinmin#2;
   aAct = "N";
   |BUCLE Cuotas;
   enSwCuotas = 0;
|FINSI;
|FPRC;

|DEFBUCLE aslinmin;
#2#2;
;
#1#0, #1#1, "00.00.0000", 000;
#1#0, #1#1, "31.12.9999", 999;
e;
NULL, imprelin_n;
|FIN;

|PROCESO lineasfac_n;
|SI #1#28 = 0; |ACABA; |FINSI;

|SI nOpcion = 3;
     |ABRE #5;
     #5#0 = #ascabmin#1;
     |LEE 000#5=;
     |SI FSalida ! 0;
          |DDEFECTO #5;
     |FINSI;
     |CIERRA #5;
     |SI #5#56 = "S";
          |HAZ lineasfac_n_fir;
          |ACABA;
     |FINSI;
|FINSI;

|SI parada2 = 2;
    |ATRI R;
    |ATRI P;
    |PINTA 2130, " Introduzca Factura en impresora ";
    |ATRI 0;
    |PAUSA;
    |PINTA 2130, "                                  ";
|FINSI;

retsino   = #1#12;
|SI #1#12 = "S"; ret = #4#31; |SINO; ret = 0; |FINSI;
dto       = #1#20;
observa   = #1#30;

|SI #1#0 = 0; ivabo = #4#21; |FINSI;
|SI #1#0 = 1; ivabo = #4#22; |FINSI;
|SI #1#0 = 2; ivabo = #4#23; |FINSI;
|SI #1#0 = 3; ivabo = #4#24; |FINSI;
|SI #1#0 = 4; ivabo = #4#25; |FINSI;
|SI #1#0 = 5; ivabo = #4#26; |FINSI;
|SI #1#0 = 6; ivabo = #4#27; |FINSI;
|SI #1#0 = 7; ivabo = #4#28; |FINSI;
|SI #1#0 = 8; ivabo = #4#29; |FINSI;
|SI #1#0 = 9; ivabo = #4#30; |FINSI;

enTipoFac = #1#0;
serie     = #1#27;
factura   = #1#28;
#0#4      = #1#29;
fech      = #1#29;

|SI #1#10 = 99;
    fechv = "A LA VISTA";
|SINO;
    |ABRE #7;
    #7#0 = #1#10;
    |LEE 040#7=;
    |SI FSalida ! 0;
        fechav = #1#29;
        fechv = fechav;
    |SINO;
        |SI #7#2 = "D"; em = 1; |SINO; em = 1000; |FINSI;
        j = #7#5 / em;
        fechav = #1#29 + j;
        fechv = fechav;
    |FINSI;
    |CIERRA #7;
|FINSI;

|HAZ desconfec;

|ABRE #5;
#5#0 = #1#1;
|LEE 040#5=;
|SI FSalida ! 0; |DDEFECTO #5; |FINSI;
|CIERRA #5;

SwLectura = 1; |BUCLE aslinmin;
SwLectura = 0; |BUCLE aslinmin;

|SI informe = "asfacase";  |O informe = "feuroase";
    |HAZ calcula;
    |HAZ escribe;
    hono  = 0;
    supli = 0;
    acue  = 0;
    |ACABA;
|FINSI;

thono1 = thono;
impdto = (thono % dto) ! EURODB;
thono  = thono - impdto;
timp   = (thono % ivabo) ! EURODB;
tfac   = thono + timp + tsupli;
tret   = (thono % ret) ! EURODB;
tpagar = tfac - tret - tacum;
rlecan = tpagar;

|HAZ lletres;
|PIEINF;

|HAZ borra;
|FPRC;

|DEFBUCLE ascabmin;
#1#1;
27, 28;
#0#0, #0#2, #0#6, #0#8;
#0#1, #0#3, #0#7, #0#9;
e;
NULL, lineasfac_n;
|FIN;

|PROCESO lineasfac_n_fir;
     |SI #1#28 = 0; |ACABA; |FINSI;

     ivabo = 0;
     |SI #1#0 = 0; ivabo = #4#21; |FINSI;
     |SI #1#0 = 1; ivabo = #4#22; |FINSI;
     |SI #1#0 = 2; ivabo = #4#23; |FINSI;
     |SI #1#0 = 3; ivabo = #4#24; |FINSI;
     |SI #1#0 = 4; ivabo = #4#25; |FINSI;
     |SI #1#0 = 5; ivabo = #4#26; |FINSI;
     |SI #1#0 = 6; ivabo = #4#27; |FINSI;
     |SI #1#0 = 7; ivabo = #4#28; |FINSI;
     |SI #1#0 = 8; ivabo = #4#29; |FINSI;
     |SI #1#0 = 9; ivabo = #4#30; |FINSI;

     enTipoIvaFe = ivabo;
     aTipoFactura = "N";
     enTipoFacFe = #ascabmin#0;
     |HAZ FirmaFactura;
|FPRC;

|DEFBUCLE ascabmin_fir;
#1#1;
27, 28;
#0#0, #0#2, #0#6, #0#8;
#0#1, #0#3, #0#7, #0#9;
;
NULL, lineasfac_n_fir;
|FIN;


|PROCESO desde_normal;

|SI nOpcion = 2; |O nOpcion = 3;
     |MENU parada;
     parada2 = FSalida;
     |SI parada2 < 1; |O parada2 > 2; |ACABA; |FINSI;

     |IMPRE 0;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #3;
     #3#0 = #0#5;
     |LEE 040#3=;
     |SI FSalida ! 0; |DDEFECTO #3; |FINSI;
     |CIERRA #3;

     informe = #3#8; |QBF informe;
     informe = informe < "";
     |INFOR informe;
     |SI FSalida ! 0; |FINIMP; |ACABA; |FINSI;

     |ABRE #2;
     |ABRE #4;
     |LEE 121#4p;
     |SI FSalida = 0;
         |BUCLE ascabmin;
     |SINO;
         |MENAV " ***  ATENCION  ***  FICHERO DE CONTROL INEXISTENTE";
     |FINSI;
     |LIBERA #4;
     |CIERRA #2;
     |CIERRA #4;
     |FININF;
     |FINIMP;
|FINSI;

|SI nOpcion = 1;
     |ABRE #3;
     #3#0 = #0#5;
     |LEE 040#3=;
     |SI FSalida ! 0; |DDEFECTO #3; |FINSI;
     |CIERRA #3;

     |ABRE #2;
     |ABRE #4;
     |LEE 121#4p;
     |SI FSalida = 0;
         |BUCLE ascabmin_fir;
     |SINO;
         |MENAV " ***  ATENCION  ***  FICHERO DE CONTROL INEXISTENTE";
     |FINSI;
     |LIBERA #4;
     |CIERRA #2;
     |CIERRA #4;
|FINSI;

|FPRC;

|PROCESO FirmaFactura;
     ||TODO CCC
     ||ARA
     ||Pasamos la variables y llamabamos a dsarz011
     ||depende del aTipoFactura.
     ||aTipoFactura = "";   || (N)ormal; (D)irecta; (H)istorico

     |SI aTipoFactura = "N";
          eaArCodCli = #ascabmin#1;  || Codigo Cliente
          eaArNomCli = #ascabmin#3;  || Nombre Cliente

          |ABRE #5;
          #5#0 = #ascabmin#1;
          |LEE 000#5=;
          |SI FSalida ! 0;
               |DDEFECTO #5;
          |FINSI;
          |CIERRA #5;

          eaArCodCif = #5#8;         || Cif
          eaArNomCif = #ascabmin#3;  || Nombre Cif

          eaArTipoDoc = "FN";
          eaArSerDoc = #ascabmin#27;
          enArNumDoc = #ascabmin#28;
          eaArFecDoc = #ascabmin#29;

          eaDirDesFE = #5#55;
          eaFirmarFE = #5#56;
          eaSwEnvioCorreo = #5#57;

          eaAplicacion = "facges";
          eaDefFE = "ascabmin";
          eaEmpresaFE = ("00" + #48#0) % -102;
          eaSerieFE = #ascabmin#27;
          eaNumeroFE = #ascabmin#28;
          eaDefLinFe = "aslinmin";
          eaDefEmpFe = "facge280";
          eaDefCliFe = "asclient";
          eaDefIvaFe = "";
          eaCodCliFe = #ascabmin#1;
          eaDefAlbFe = "";

          |SUB_EJECUTA ":dsarchi/dsarz011.tab";
     |FINSI;

     |SI aTipoFactura = "D";
          eaArCodCli = #ascabfdi#1;  || Codigo Cliente
          eaArNomCli = #ascabfdi#3;  || Nombre Cliente

          |ABRE #5;
          #5#0 = #ascabfdi#1;
          |LEE 000#5=;
          |SI FSalida ! 0;
               |DDEFECTO #5;
          |FINSI;
          |CIERRA #5;

          eaArCodCif = #5#8;         || Cif
          eaArNomCif = #ascabfdi#3;  || Nombre Cif

          eaArTipoDoc = "FD";
          eaArSerDoc = #ascabfdi#27;
          enArNumDoc = #ascabfdi#28;
          eaArFecDoc = #ascabfdi#29;

          eaDirDesFE = #5#55;
          eaFirmarFE = #5#56;
          eaSwEnvioCorreo = #5#57;

          eaAplicacion = "facges";
          eaDefFE = "ascabfdi";
          eaEmpresaFE = ("00" + #48#0) % -102;
          eaSerieFE = #ascabfdi#27;
          eaNumeroFE = #ascabfdi#28;
          eaDefLinFe = "aslinfdi";
          eaDefEmpFe = "facge280";
          eaDefCliFe = "asclient";
          eaDefIvaFe = "";
          eaCodCliFe = #ascabfdi#1;
          eaDefAlbFe = "";

          |SUB_EJECUTA ":dsarchi/dsarz011.tab";
     |FINSI;

     |SI aTipoFactura = "H";
          eaArCodCli = #ashismic#3;  || Codigo Cliente
          eaArNomCli = #ashismic#5;  || Nombre Cliente

          |ABRE #5;
          #5#0 = #ashismic#3;
          |LEE 000#5=;
          |SI FSalida ! 0;
               |DDEFECTO #5;
          |FINSI;
          |CIERRA #5;

          eaArCodCif = #5#8;         || Cif
          eaArNomCif = #ashismic#5;  || Nombre Cif

          eaArTipoDoc = "FH";
          eaArSerDoc = #ashismic#0;
          enArNumDoc = #ashismic#1;
          eaArFecDoc = #ascabfdi#29;

          eaDirDesFE = #5#55;
          eaFirmarFE = #5#56;
          eaSwEnvioCorreo = #5#57;

          eaAplicacion = "facges";
          eaDefFE = "ashismic";
          eaEmpresaFE = ("00" + #48#0) % -102;
          eaSerieFE = #ashismic#0;
          eaNumeroFE = #ashismic#1;
          eaDefLinFe = "ashismil";
          eaDefEmpFe = "facge280";
          eaDefCliFe = "asclient";
          eaDefIvaFe = "";
          eaCodCliFe = #ashismic#3;
          eaDefAlbFe = "";

          |SUB_EJECUTA ":dsarchi/dsarz011.tab";
     |FINSI;


|FPRC;


|| ***********************************************************************


|| ***********************************************************************
||                      IMPRESION FACTURAS DESDE MINUTAS DIRECTAS
|| ***********************************************************************

|PROCESO Linfacdir;
   |SI #9#6 = aDescrip; |Y #9#7 = aDescri1; |Y #9#8 = aDescri2;
    |Y #9#9 = aDescri3; |Y #9#12 = nImporte;
      enUnidades = enUnidades + #9#11;
      enImpTotal = enImpTotal + #9#13;
      |SI #9#2 [ nLinea; enOrden = enOrden + 1; |FINSI;
   |SINO;
      enOrden = 1;
   |FINSI;
|FPRC;

|DEFBUCLE Linfacdir; || PEPE
#aslinfdi#1;
4,5;
nTipoFac, aSerie, nFactura, nCliente, 001, aSeccion, aConcept;
nTipoFac, aSerie, nFactura, nCliente, 999, aSeccion, aConcept;
;
NULL,Linfacdir;
|FIN:

|PROCESO imprelin_d;
|SI SwLectura = 1;
    |SI #9#4 = "ASUN"; |Y #9#5 = "01";
        Cab1 = #9#7;
        Cab2 = #9#8;
        Cab3 = #9#9;
    |FINSI;

    |SI #9#4 = "OBSE"; |Y #9#5 = "01";
        Pie1 = #9#7;
        Pie2 = #9#8;
        Pie3 = #9#9;
    |FINSI;
    |ACABA;
|FINSI;

|SI informe = "asfacjgs";
    |SI #9#4 = "ASUN"; |Y #9#5 = "01";
        |ACABA;
    |FINSI;

    |SI #9#4 = "OBSE"; |Y #9#5 = "01";
        |ACABA;
    |FINSI;
|FINSI;

|SI informe = "asfacase";  |O informe = "feuroase";
    tipo_ase = #9#10;
    secc_ase = #9#4;
    conc_ase = #9#5;
    dcab_ase = #9#6;
    impo_ase = #9#13;
    des2_ase = #9#8;
    des3_ase = #9#9;
    |SI informe = "asfacase";  enFactor = 1;        |FINSI;
    |SI EURODB = 0;
        |SI informe = "feuroase";  enFactor = 166.386;  |FINSI;
    |SINO;
        |SI informe = "feuroase";  enFactor = 1;        |FINSI;
    |FINSI;
    |HAZ asefeco;
    |ACABA;
|FINSI;

||     PEPE
|SALVA_FICHA #9;
aSerie   = #9#14;
nFactura = #9#15;
nTipoFac = #9#0;
nCliente = #9#1;
aSeccion = #9#4;
aConcept = #9#5;
aDescrip = #9#6;
aDescri1 = #9#7;
aDescri2 = #9#8;
aDescri3 = #9#9;
nImporte = #9#12;
nLinea   = #9#2;
enUnidades = 0; enImpTotal = 0;
enOrden    = 0;
|BUCLE Linfacdir;
|REPON_FICHA #9;
|| FIN PEPE

descr1   = #9#7;
descr2   = #9#8;
descr3   = #9#9;
unidades = #9#11;
ptasunid = #9#12;
seccion  = #9#4;
concepto = #9#5;
fecha_lin = #9#17;

cargo_h = 0;
abono_h = 0;
saldo_a = 0;
acuen_a = 0;
acuen_i = 0;
hono    = 0;
supli   = 0;
acum    = 0;
timporte = 0;
cargo    = 0;
abono    = 0;

|SI #9#10 = "H";
    |SI #9#13 > 0;
        cargo_h = #9#13;
        cargo   = #9#13;
        abono   = 0;
        abono_h = 0;
    |SINO;
        abono   = -#9#13;
        abono_h = -#9#13;
        cargo   = 0;
        cargo_h = 0;
    |FINSI;

    hono     = #9#13;
    supli    = 0;
    acum     = 0;
    timporte = hono;
    sw       = 0;
    tipo     = "H";
|FINSI;

|SI #9#10 = "S";
    |SI #9#13 > 0;
        cargo = #9#13;
        abono = 0;
    |SINO;
        abono = -#9#13;
        cargo = 0;
    |FINSI;

    supli    = #9#13;
    hono     = 0;
    acum     = 0;
    timporte = supli;
    sw       = 0;
    tipo     = "S";
|FINSI;

|SI #9#10 = "A";
    |SI #9#13 > 0;
        abono   = #9#13;
        cargo   = 0;
        acuen_a = #9#13;
        acuen_i = #9#13;
    |SINO;
        cargo   = -#9#13;
        abono   = 0;
        acuen_i = -#9#13;
        saldo_a = -#9#13;
    |FINSI;

    acum     = #9#13;
    hono     = 0;
    supli    = 0;
    timporte = acum;
    tsal_a   = tsal_a + saldo_a;
    sw       = 1;
    tipo     = "A";
|FINSI;

tacum  = tacum + acum;
thono  = thono + hono;
tsupli = tsupli + supli;

|SI indihono < 12;
    Ides     = des1 <-;
    Ides     = Ides + indihono;
    des      = #9#6;
    Iimp     = imp1 <-;
    Iimp     = Iimp + indihono;
    imp      = #9#13;
    indihono = indihono + 1;
|FINSI;

|PRINT;
|FPRC;

|DEFBUCLE aslinfdi;
#9#2;
;
#8#0, #8#27, #8#28, #8#1, "00.00.0000", 000;
#8#0, #8#27, #8#28, #8#1, "31.12.9999", 999;
e;
NULL, imprelin_d;
|FIN;

|PROCESO lineasfac_d;

retsino   = #8#12;
|SI #8#12 = "S"; ret = #12#31; |SINO; ret = 0; |FINSI;
dto       = #8#20;
observa   = #8#31;

|SI #8#0 = 0; ivabo = #12#21; |FINSI;
|SI #8#0 = 1; ivabo = #12#22; |FINSI;
|SI #8#0 = 2; ivabo = #12#23; |FINSI;
|SI #8#0 = 3; ivabo = #12#24; |FINSI;
|SI #8#0 = 4; ivabo = #12#25; |FINSI;
|SI #8#0 = 5; ivabo = #12#26; |FINSI;
|SI #8#0 = 6; ivabo = #12#27; |FINSI;
|SI #8#0 = 7; ivabo = #12#28; |FINSI;
|SI #8#0 = 8; ivabo = #12#29; |FINSI;
|SI #8#0 = 9; ivabo = #12#30; |FINSI;

enTipoFac = #8#0;
serie     = #8#27;
factura   = #8#28;
#0#4      = #8#29;
fech      = #8#29;

|SI #8#10 = 99;
    fechv = "A LA VISTA";
|SINO;
    |ABRE #7;
    #7#0 = #8#10;
    |LEE 040#7=;
    |SI FSalida ! 0;
        fechav = #8#29;
        fechv = fechav;
    |SINO;
        |SI #7#2 = "D"; em = 1; |SINO; em = 1000; |FINSI;
        j = #7#5 / em;
        fechav = #8#29 + j;
        fechv = fechav;
    |FINSI;
    |CIERRA #7;
|FINSI;

|HAZ desconfec;

|ABRE #5;
#5#0 = #8#1;
|LEE 040#5=;
|SI FSalida ! 0; |DDEFECTO #5; |FINSI;
|CIERRA #5;

SwLectura = 1; |BUCLE aslinfdi;
SwLectura = 0; |BUCLE aslinfdi;

|SI informe = "asfacase";  |O informe = "feuroase";
    |HAZ calcula;
    |HAZ escribe;
    hono  = 0;
    supli = 0;
    acue  = 0;
    |ACABA;
|FINSI;

thono1 = thono;
impdto = (thono % dto) ! EURODB;
thono  = thono - impdto;
timp   = (thono % ivabo) ! EURODB;
tfac   = thono + timp + tsupli;
tret   = (thono % ret) ! EURODB;
tpagar = tfac - tret - tacum;
rlecan = tpagar;

|HAZ lletres;
|PIEINF;

|HAZ borra;
|FPRC;

|PROCESO desde_directa;
|SI nOpcion = 2; |O nOpcion = 3;

     |SI nOpcion = 3;
          |ABRE #5;
          #5#0 = #ascabfdi#1;
          |LEE 000#5=;
          |SI FSalida ! 0;
               |DDEFECTO #5;
          |FINSI;
          |CIERRA #5;
          |SI #5#56 = "S";
               |ABRE #8;
               #8#0  = tipo_d;
               #8#1  = cliente_d;
               #8#27 = serie_d;
               #8#28 = factura_d;
               |LEE 040#8=;
               |SI FSalida ! 0; |CIERRA #8; |ACABA; |FINSI;
               |CIERRA #8;

               |ABRE #12;
               |LEE 121#12p;
               |SI FSalida ! 0;
                   |DDEFECTO #12;
               |FINSI;
               |CIERRA #12;

               ivabo = 0;
               |SI #8#0 = 0; ivabo = #12#21; |FINSI;
               |SI #8#0 = 1; ivabo = #12#22; |FINSI;
               |SI #8#0 = 2; ivabo = #12#23; |FINSI;
               |SI #8#0 = 3; ivabo = #12#24; |FINSI;
               |SI #8#0 = 4; ivabo = #12#25; |FINSI;
               |SI #8#0 = 5; ivabo = #12#26; |FINSI;
               |SI #8#0 = 6; ivabo = #12#27; |FINSI;
               |SI #8#0 = 7; ivabo = #12#28; |FINSI;
               |SI #8#0 = 8; ivabo = #12#29; |FINSI;
               |SI #8#0 = 9; ivabo = #12#30; |FINSI;

               enTipoIvaFe = ivabo;
               aTipoFactura = "D";
               enTipoFacFe = #ascabfdi#0;
               |HAZ FirmaFactura;

               |ACABA;
          |FINSI;
     |FINSI;

     |ABRE #8;
     #8#0  = tipo_d;
     #8#1  = cliente_d;
     #8#27 = serie_d;
     #8#28 = factura_d;
     |LEE 040#8=;
     |SI FSalida ! 0; |CIERRA #8; |ACABA; |FINSI;
     |CIERRA #8;

     |IMPRE 0;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #3;
     #3#0 = #8#30;
     |LEE 040#3=;
     |SI FSalida ! 0; |DDEFECTO #3; |FINSI;
     |CIERRA #3;

     informe = #3#12; |QBF informe;
     informe = informe < "";
     |INFOR informe;
     |SI FSalida ! 0; |FINIMP; |ACABA; |FINSI;

     |ABRE #12;
     |LEE 121#12p;
     |SI FSalida = 0;
         |HAZ lineasfac_d;
     |FINSI;
     |CIERRA #12;
     |FININF;
     |FINIMP;
|FINSI;

|SI nOpcion = 1;
     |ABRE #8;
     #8#0  = tipo_d;
     #8#1  = cliente_d;
     #8#27 = serie_d;
     #8#28 = factura_d;
     |LEE 040#8=;
     |SI FSalida ! 0; |CIERRA #8; |ACABA; |FINSI;
     |CIERRA #8;

     |ABRE #12;
     |LEE 121#12p;
     |SI FSalida ! 0;
         |DDEFECTO #12;
     |FINSI;
     |CIERRA #12;

     ivabo = 0;
     |SI #8#0 = 0; ivabo = #12#21; |FINSI;
     |SI #8#0 = 1; ivabo = #12#22; |FINSI;
     |SI #8#0 = 2; ivabo = #12#23; |FINSI;
     |SI #8#0 = 3; ivabo = #12#24; |FINSI;
     |SI #8#0 = 4; ivabo = #12#25; |FINSI;
     |SI #8#0 = 5; ivabo = #12#26; |FINSI;
     |SI #8#0 = 6; ivabo = #12#27; |FINSI;
     |SI #8#0 = 7; ivabo = #12#28; |FINSI;
     |SI #8#0 = 8; ivabo = #12#29; |FINSI;
     |SI #8#0 = 9; ivabo = #12#30; |FINSI;

     enTipoIvaFe = ivabo;
     aTipoFactura = "D";
     enTipoFacFe = #ascabfdi#0;
     |HAZ FirmaFactura;
|FINSI;

|FPRC;

|| ***********************************************************************


|| ***********************************************************************
||                      IMPRESION FACTURAS DESDE HISTORICO MINUTAS
|| ***********************************************************************

|PROCESO Linhismil;
   |SI #11#6 = aDescrip; |Y #11#7 = aDescri1; |Y #11#8 = aDescri2;
    |Y #11#9 = aDescri3; |Y #11#12 = nImporte;
      enUnidades = enUnidades + #11#11;
      enImpTotal = enImpTotal + #11#13;
      |SI #11#2 [ nLinea; enOrden = enOrden + 1; |FINSI;
   |SINO;
      enOrden = 1;
   |FINSI;
|FPRC;

|DEFBUCLE Linhismil; || PEPE
#ashismil#1;
4,5;
aSerie, nFactura, 001, aSeccion, aConcept;
aSerie, nFactura, 999, aSeccion, aConcept;
;
NULL,Linhismil;
|FIN:

|PROCESO imprelin_h;
|SI SwLectura = 1;
    |SI #11#4 = "ASUN"; |Y #11#5 = "01";
        Cab1 = #11#7;
        Cab2 = #11#8;
        Cab3 = #11#9;
    |FINSI;

    |SI #11#4 = "OBSE"; |Y #11#5 = "01";
        Pie1 = #11#7;
        Pie2 = #11#8;
        Pie3 = #11#9;
    |FINSI;
    |ACABA;
|FINSI;

|SI informe = "asfacjgs";
    |SI #11#4 = "ASUN"; |Y #11#5 = "01";
        |ACABA;
    |FINSI;

    |SI #11#4 = "OBSE"; |Y #11#5 = "01";
        |ACABA;
    |FINSI;
|FINSI;

||     PEPE
|SALVA_FICHA #11;
aSerie   = #11#0;
nFactura = #11#1;
aSeccion = #11#4;
aConcept = #11#5;
aDescrip = #11#6;
aDescri1 = #11#7;
aDescri2 = #11#8;
aDescri3 = #11#9;
nImporte = #11#12;
nLinea   = #11#2;
enUnidades = 0; enImpTotal = 0;
enOrden    = 0;
|BUCLE Linhismil;
|REPON_FICHA #11;
|| FIN PEPE

|SI informe = "asfacase";  |O informe = "feuroase";
    tipo_ase = #11#10;
    secc_ase = #11#4;
    conc_ase = #11#5;
    dcab_ase = #11#6;
    impo_ase = #11#13;
    des2_ase = #11#8;
    des3_ase = #11#9;
    |SI informe = "asfacase";  enFactor = 1;        |FINSI;
    |SI EURODB = 0;
        |SI informe = "feuroase";  enFactor = 166.386;  |FINSI;
    |SINO;
        |SI informe = "feuroase";  enFactor = 1;        |FINSI;
    |FINSI;
    |HAZ asefeco;
    |ACABA;
|FINSI;

descr1    = #11#7;
descr2    = #11#8;
descr3    = #11#9;
unidades  = #11#11;
ptasunid  = #11#12;
seccion   = #11#4;
concepto  = #11#5;
fecha_lin = #11#3;
cargo_h   = 0;
abono_h   = 0;
saldo_a   = 0;
acuen_a   = 0;
acuen_i   = 0;
hono    = 0;
supli   = 0;
acum    = 0;
timporte = 0;
cargo    = 0;
abono    = 0;

|SI #11#10 = "H";
    |SI #11#13 > 0;
        cargo_h = #11#13;
        cargo   = #11#13;
        abono   = 0;
        abono_h = 0;
    |SINO;
        abono   = -#11#13;
        abono_h = -#11#13;
        cargo   = 0;
        cargo_h = 0;
    |FINSI;

    hono     = #11#13;
    supli    = 0;
    acum     = 0;
    timporte = hono;
    sw       = 0;
    tipo     = "H";
|FINSI;

|SI #11#10 = "S";
    |SI #11#13 > 0;
        cargo = #11#13;
        abono = 0;
    |SINO;
        abono = -#11#13;
        cargo = 0;
    |FINSI;

    supli    = #11#13;
    hono     = 0;
    acum     = 0;
    timporte = supli;
    sw       = 0;
    tipo     = "S";
|FINSI;

|SI #11#10 = "A";
    |SI #11#13 > 0;
        abono   = #11#13;
        cargo   = 0;
        acuen_a = #11#13;
        acuen_i = #11#13;
    |SINO;
        cargo   = -#11#13;
        abono   = 0;
        acuen_i = -#11#13;
        saldo_a = -#11#13;
    |FINSI;

    acum     = #11#13;
    hono     = 0;
    supli    = 0;
    timporte = acum;
    tsal_a   = tsal_a + saldo_a;
    sw       = 1;
    tipo     = "A";
|FINSI;

tacum  = tacum + acum;
thono  = thono + hono;
tsupli = tsupli + supli;

|SI indihono < 12;
    Ides     = des1 <-;
    Ides     = Ides + indihono;
    des      = #11#6;
    Iimp     = imp1 <-;
    Iimp     = Iimp + indihono;
    imp      = #11#13;
    indihono = indihono + 1;
|FINSI;

|PRINT;

|SI #asfacges#10 = "S";
   enSwCuotas = 1;
   D_TipoFac  = 0;            H_TipoFac  = 9;
   D_Cliente  = #ashismic#3;  H_Cliente  = #ashismic#3;
   D_Serie    = #ashismil#0;  H_Serie    = #ashismil#0;
   D_Factura  = #ashismil#1;  H_Factura  = #ashismil#1;
   D_Linea    = #ashismil#2;  H_Linea    = #ashismil#2;
   aAct = "S";
   |BUCLE Cuotas;
   enSwCuotas = 0;
|FINSI;
|FPRC;

|DEFBUCLE ashismil;
#11#2;
;
#10#0, #10#1, "00.00.0000", 000;
#10#0, #10#1, "31.12.9999", 999;
e;
NULL, imprelin_h;
|FIN;

|PROCESO lineasfac_h;

|SI nOpcion = 3;
     |ABRE #5;
     #5#0 = #ashismic#3;
     |LEE 000#5=;
     |SI FSalida ! 0;
          |DDEFECTO #5;
     |FINSI;
     |CIERRA #5;
     |SI #5#56 = "S";
          |HAZ lineasfac_h_fir;
          |ACABA;
     |FINSI;
|FINSI;

|SI parada2 = 2;
    |ATRI R;
    |ATRI P;
    |PINTA 2130, " Introduzca Factura en impresora ";
    |ATRI 0;
    |PAUSA;
    |PINTA 2130, "                                  ";
|FINSI;

retsino   = #10#14;
|SI #10#14 = "S"; ret = #10#46; |SINO; ret = 0; |FINSI;

dto       = #10#22;
observa   = #10#34;

ivabo     = #10#45;
enTipoFac = #10#2;
serie     = #10#0;
factura   = #10#1;
#0#4      = #10#29;
fech      = #10#29;

|SI #10#12 = 99;
    fechv = "A LA VISTA";
|SINO;
    |ABRE #7;
    #7#0 = #10#12;
    |LEE 040#7=;
    |SI FSalida ! 0;
        fechav = #10#29;
        fechv = fechav;
    |SINO;
        |SI #7#2 = "D"; em = 1; |SINO; em = 1000; |FINSI;
        j = #7#5 / em;
        fechav = #10#29 + j;
        fechv = fechav;
    |FINSI;
    |CIERRA #7;
|FINSI;

|HAZ desconfec;

|ABRE #5;
#5#0 = #10#3;
|LEE 040#5=;
|SI FSalida ! 0; |DDEFECTO #5; |FINSI;
|CIERRA #5;

SwLectura = 1; |BUCLE ashismil;
SwLectura = 0; |BUCLE ashismil;

|SI informe = "asfacase";  |O informe = "feuroase";
    |HAZ calcula;
    |HAZ escribe;
    hono  = 0;
    supli = 0;
    acue  = 0;
    |ACABA;
|FINSI;

thono1 = thono;
impdto = (thono % dto) ! EURODB;
thono  = thono - impdto;
timp   = (thono % ivabo) ! EURODB;
tfac   = thono + timp + tsupli;
tret   = (thono % ret) ! EURODB;
tpagar = tfac - tret - tacum;
rlecan = tpagar;

|HAZ lletres;
|PIEINF;

|HAZ borra;
|FPRC;

|DEFBUCLE ashismic;
#10#1;
29;
d_serie, d_factu, d_fecha;
h_serie, h_factu, h_fecha;
e;
NULL, lineasfac_h;
|FIN;

|PROCESO lineasfac_h_fir;
     ivabo        = #10#45;
     enTipoIvaFe  = ivabo;
     aTipoFactura = "H";
     |HAZ FirmaFactura;
|FPRC;

|DEFBUCLE ashismic_fir;
#10#1;
29;
d_serie, d_factu, d_fecha;
h_serie, h_factu, h_fecha;
e;
NULL, lineasfac_h_fir;
|FIN;


|PROCESO desde_histori;
|SI nOpcion = 2; |O nOpcion = 3;

     |MENU parada;
     parada2 = FSalida;
     #asfacges#10 = cuotas;
     |SI parada2 < 1; |O parada2 > 2; |ACABA; |FINSI;

     |IMPRE 0;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #3;
     #3#0 = empresa;
     |LEE 040#3=;
     |SI FSalida ! 0; |DDEFECTO #3; |FINSI;
     |CIERRA #3;

     informe = #3#11; |QBF informe;
     informe = informe < "";
     |INFOR informe;
     |SI FSalida ! 0; |FINIMP; |ACABA; |FINSI;

     |ABRE #2;
     |ABRE #4;
     |ABRE #12;

     |LEE 000#4p;
     |SI FSalida ! 0;  |DDEFECTO #4;  |FINSI;

     |LEE 000#12p;
     |SI FSalida ! 0;  |DDEFECTO #12;  |FINSI;

     |CIERRA #4;
     |CIERRA #12;

     |BUCLE ashismic;

     |CIERRA #2;
     |FININF;
     |FINIMP;
|FINSI;

|SI nOpcion = 1;
     |ABRE #3;
     #3#0 = empresa;
     |LEE 040#3=;
     |SI FSalida ! 0; |DDEFECTO #3; |FINSI;
     |CIERRA #3;

     |ABRE #2;
     |ABRE #4;
     |ABRE #12;

     |LEE 000#4p;
     |SI FSalida ! 0;  |DDEFECTO #4;  |FINSI;

     |LEE 000#12p;
     |SI FSalida ! 0;  |DDEFECTO #12;  |FINSI;

     |CIERRA #4;
     |CIERRA #12;

     |BUCLE ashismic_fir;

     |CIERRA #2;
|FINSI;

|FPRC;

|| ***********************************************************************

|PROCESO borra;
Ides = des1 <-;
Iimp = imp1 <-;
|PARA i = 0;|SI i < 12;|HACIENDO i = i + 1;
    des  = "";
    imp  = 0;
    Ides = Ides + 1;
    Iimp = Iimp + 1;
|SIGUE;

Cab1   = "";
Cab2   = "";
Cab3   = "";
Pie1   = "";
Pie2   = "";
Pie3   = "";

tacum  = 0;
thono  = 0;
tsupli = 0;
tsal_a = 0;
|FPRC;

|PROGRAMA;
|HAZ Tipo8Version;

|SI d_viene = 0;
    |CLS;
    |CABEZA "Impresion Facturas";
    |PINPA #0#0;
    |PINDA #0#0;
    |ENDATOS #1#0;
    |SI FSalida = 0;
         |HAZ EsArchi;
         |SI nArchi = 1;
               |MENU aMenu;
               |SI FSalida < 1; |O FSalida > 3; |ACABA; |FINSI;
               nOpcion = FSalida;
         |SINO;
               nOpcion = 2;
         |FINSI;

         |HAZ desde_normal;
    |FINSI;
|FINSI;

|SI d_viene = 1;
     |HAZ EsArchi;
     |SI nArchi = 1;
          |MENU aMenu;
          |SI FSalida < 1; |O FSalida > 3; |ACABA; |FINSI;
          nOpcion = FSalida;
     |SINO;
          nOpcion = 2;
     |FINSI;
     |HAZ desde_directa;
|FINSI;
|SI d_viene = 2;
     |HAZ EsArchi;
     |SI nArchi = 1;
          |MENU aMenu;
          |SI FSalida < 1; |O FSalida > 3; |ACABA; |FINSI;
          nOpcion = FSalida;
     |SINO;
          nOpcion = 2;
     |FINSI;
     |HAZ desde_histori;
|FINSI;
|FPRO;

|PROCESO EsArchi;
     nArchi = 0;
     |DBASS aPath; |QBF aPath;
     aPath = aPath + "dsarchi/def/dsarm001.mas";
     |XABRE "E", aPath, 0;
     |SI FSalida = 0;
        |DBASS aAlfa; |QBF aAlfa;
        aAlfa = aAlfa + "dsarchi/def/dsarm001.mas";
        |CARGA_DEF aAlfa, Ref0001@;
        |SI FSalida = 0;
           |DBASS aAlfa; |QBF aAlfa;
           aAlfa = aAlfa + "dsarchi/fich/"; |PATH_DAT #1999 aAlfa;
           |ABRE #Ref0001@;
           |DDEFECTO #Ref0001@;
           |LEE 000#Ref0001@.p;
           |SI FSalida ! 0; |DDEFECTO #Ref0001@; |FINSI;

           |SI #Ref0001@#46 = "S";
              nArchi = 1;
              eaArGrpMin = #Ref0001@#48;
              eaArSbGMin = #Ref0001@#49;
              eaArTipMin = #Ref0001@#50;
           |SINO;
              eaArGrpMin = "";
              eaArSbGMin = "";
              eaArTipMin = "";
           |FINSI;
           |CIERRA #Ref0001@; |DESCARGA_DEF #Ref0001@;
        |FINSI;
     |FINSI;
|FPRC;
