|FICHEROS;
   asprepar #0;
   ascabmin #1;
   ascontro #2;
   asprepa1 #3;
   aslinmin #4;
   asconcep #5;
   asclient #6;

   asenlcon #9;
   asempcon #10;
   asw00001 #99;

   asm00003 #500;
|FIN;

|VARIABLES;
 c_clie  = "";
 fijo    = "";
 sw        = 0;
 sw_existe = 0;
 factura_1 = 0;
 factura_2 = 0;
 serie_1   = "";
 serie_2   = "";
 fecha     = @;
 varalf    = "";
 conver    = "";
 conver1   = "";
 conver2   = "";

     nCampo = 0;
     nIVA1  = 0;
     nIVA2  = 0;
     alfa1  = "";
|FIN;

|INCLUYE pastil_i;
|INCLUYE agicon_i;

|CALCULO desprepa_t1;
|SI sw = 0;
   sw = 1;
   |SI #1#22 ! 0; |O #1#18 ! 0;
       factura_1 = #1#28;
   |SINO;
       factura_2 = #1#28;
   |FINSI;
|FINSI;

|SI #0#0 = #0#3;
    |SI #1#28 < factura_1; |Y #1#28 ! 0;
        factura_1 = #1#28;
    |FINSI;
|SINO;
    |SI #1#22 ! 0; |O #1#18 ! 0;
        |SI #1#28 < factura_1; |Y #1#28 ! 0;
            factura_1 = #1#28;
        |FINSI;
    |SINO;
        |SI factura_2 = 0; |Y  #1#28 ! 0;
            factura_2 = #1#28;
        |FINSI;

        |SI #1#28 < factura_2; |Y #1#28 ! 0;
            factura_2 = #1#28;
        |FINSI;
    |FINSI;
|FINSI;

#1#27 = "<<";
#1#28 = 0;
#1#29 = "01.01.1900";
|GRABA 020#1a;
|FCAL;

|PROCESO HistCuotCli;
   |SALVA_FICHA #asm00003;
   #asm00003#2 = #1#27;
   #asm00003#3 = #1#28;
   |GRABA 020#asm00003.n;
   |REPON_FICHA #asm00003;
   |BORRA 020#asm00003.a;
|FPRC;

|DEFBUCLE HistCuotCli;
#asm00003#1;
;
#1#0,#1#1,"  ",00000,"N",001,01;
#1#0,#1#1,"  ",00000,"N",999,99;
be;
NULL,HistCuotCli;
|FIN;

|CALCULO ponefac;
    p_imp = #0#2;
|HAZ pastilla;
|SI #1#28 = 0;|Y p_cen = 0;
   |SI #0#0 = #0#3;
       factura_1 = factura_1 + 1;
       #1#27 = serie_1;
       #1#28 = factura_1;
       #1#29 = #0#2;
       |GRABA 020#1a;
       |LIBERA #1;
   |SINO;
      |SI #1#22 ! 0; |O #1#18 ! 0;
          factura_1 = factura_1 + 1;
          #1#27 = serie_1;
          #1#28 = factura_1;
          #1#29 = #0#2;
              |GRABA 020#1a;
              |LIBERA #1;
          |SINO;
              factura_2 = factura_2 + 1;
              #1#27 = serie_2;
              #1#28 = factura_2;
              #1#29 = #0#2;
              |GRABA 020#1a;
              |LIBERA #1;
         |FINSI;
   |FINSI;
   |BUCLE HistCuotCli;
|FINSI;
|FCAL;

|DEFBUCLE asprepar_t1;
#1#1;
;
#0#0, 00001;
#0#0, 99999;
be;
NULL, desprepa_t1;
|FIN;

|DEFBUCLE asprepar1;
#1#1;
;
#0#0, 00001;
#0#0, 99999;
be;
NULL, ponefac;
|FIN;

|PROCESO existe;
sw_existe = 1;
|ERROR10;
|FPRC;

|DEFBUCLE ascabmin;
#1#1;
;
0, #6#0;
9, #6#0;
e;
NULL, existe;
|FIN;

|PROCESO saldo;
|SI #6#24 = 0; |ACABA; |FINSI;

sw_existe = 0;
|BUCLE ascabmin;
|SI sw_existe = 1; |ACABA; |FINSI;

factura_2 = factura_2 + 1;

|ABRE #1;
|DDEFECTO #1;
#1#0  = #0#0;
#1#1  = #6#0;
#1#2  = #6#1;
#1#3  = #6#2;
#1#4  = #6#3;
#1#5  = #6#4;
#1#6  = #6#5;
#1#7  = #6#6;
#1#8  = #6#7;
#1#9  = #6#8;
#1#10 = #6#15;
#1#11 = #6#16;
#1#12 = #6#17;
#1#13 = #6#11;
#1#14 = #6#12;
#1#15 = #6#13;
#1#16 = #6#14;
#1#27 = serie_2;
#1#28 = factura_2;
#1#29 = #0#2;

#4#0  = #1#0;
#4#1  = #1#1;
#4#2  = 5;
#4#3  = 0;
#4#4  = #5#0;
#4#5  = #5#1;
#4#6  = #5#2;
#4#7  = #5#16;
#4#8  = #5#17;
#4#9  = #5#18;
#4#10 = #5#3;
#4#11 = 1;
#4#12 = -#6#24;
#4#13 = -#6#24;
#4#14 = "G";
#4#15 = "00.00.0000";
|GRABA 140#4n;
|LIBERA #4;

#1#19 = #4#13;
#1#26 = #1#24 -#1#19 - #1#25;
|GRABA 140#1n;
|LIBERA #1;
|CIERRA #1;
|HAZ graba_con;
|FPRC;

|DEFBUCLE asclient;
#6#1;
;
00000;
99999;
e;
NULL, saldo;
|FIN;

|CALCULO prepara;|TIPO 3;
     |ABRE #2;
     |LEE 000#2p;
     |SI FSalida ! 0;  |DDEFECTO #2;  |FINSI;
     |CIERRA #2;

     nCampo = 21 + #0#0;  nIVA1 = #2nCampo;
     nCampo = 21 + #0#3;  nIVA2 = #2nCampo;

     |SI #0#2 [ "30.06.2010";
         |SI nIVA1 = 8;  |O nIVA1 = 18; |O nIVA1 = 10; |O nIVA1 = 21;
             alfa1 = nIVA1;
             alfa1 = "0000Se va a facturar con un IVA erroneo ("+alfa1+"%), segun la fecha de factura.";
             |MENAV alfa1;
             |CONFI "0000NQuiere continuar";
             |SI FSalida ! 0;
                 |MENAV "0000Revise los % IVA y las minutas.";
                 |ACABA;
             |FINSI;
         |SINO;
             |SI nIVA2 = 8;  |O nIVA2 = 18; |O nIVA2 = 10; |O nIVA2 = 21;
                 alfa1 = nIVA2;
                 alfa1 = "0000Se va a facturar con un IVA erroneo ("+alfa1+"%), segun la fecha de factura.";
                 |MENAV alfa1;
                 |CONFI "0000NQuiere continuar";
                 |SI FSalida ! 0;
                     |MENAV "0000Revise los % IVA y las minutas.";
                     |ACABA;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI #0#2 ] "01.07.2010"; |Y #0#2 < "01.09.2012";

         |SI nIVA1 = 7;  |O nIVA1 = 16; |O nIVA1 = 10; |O nIVA1 = 21;
             alfa1 = nIVA1;
             alfa1 = "0000Se va a facturar con un IVA erroneo ("+alfa1+"%), segun la fecha de factura.";
             |MENAV alfa1;
             |CONFI "0000NQuiere continuar";
             |SI FSalida ! 0;
                 |MENAV "0000Revise los % IVA y las minutas.";
                 |ACABA;
             |FINSI;
         |SINO;
             |SI nIVA2 = 7;  |O nIVA2 = 16; |O nIVA2 = 10; |O nIVA2 = 21;
                 alfa1 = nIVA2;
                 alfa1 = "0000Se va a facturar con un IVA erroneo ("+alfa1+"%), segun la fecha de factura.";
                 |MENAV alfa1;
                 |CONFI "0000NQuiere continuar";
                 |SI FSalida ! 0;
                     |MENAV "0000Revise los % IVA y las minutas.";
                     |ACABA;
                 |FINSI;
             |FINSI;
         |FINSI;
    |FINSI;

    |SI #0#2 ] "01.09.2012";
         |SI nIVA1 = 7;  |O nIVA1 = 16; |O nIVA1 = 8; |O nIVA1 = 18;
             alfa1 = nIVA1;
             alfa1 = "0000Se va a facturar con un IVA erroneo ("+alfa1+"%), segun la fecha de factura.";
             |MENAV alfa1;
             |CONFI "0000NQuiere continuar";
             |SI FSalida ! 0;
                 |MENAV "0000Revise los % IVA y las minutas.";
                 |ACABA;
             |FINSI;
         |SINO;
             |SI nIVA2 = 7;  |O nIVA2 = 16; |O nIVA2 = 8; |O nIVA2 = 18;
                 alfa1 = nIVA2;
                 alfa1 = "0000Se va a facturar con un IVA erroneo ("+alfa1+"%), segun la fecha de factura.";
                 |MENAV alfa1;
                 |CONFI "0000NQuiere continuar";
                 |SI FSalida ! 0;
                     |MENAV "0000Revise los % IVA y las minutas.";
                     |ACABA;
                 |FINSI;
             |FINSI;
         |FINSI;
    |FINSI;

     fecha = ~;
     varalf = (fecha % 102) + (fecha % 402);

     |SI #0#1 = "S";
        sw = 0; |BUCLE asprepar_t1;
        |SI factura_1 ! 0; |O factura_2 ! 0;
            |ABRE #2;
            |LIBERA #2;
            |LEE 101#2p;
            |SI FSalida = 0;
                |PINPA #0#3;
                #3#0 = factura_1;
                #3#3 = factura_2;
                |PINTA #3#0;
                |PINTA #3#3;
                |ENCAMPO #1#3;
                |SI #3#1 = "N";
                    |ET arriba;
                        |ENCAMPO #2#3;
                        |ENCAMPO #4#3;
                        |CONFI "2400SEs Correcto : ";
                        |SI FSalida = 0;
                            factura_1 = #3#2 - 1;
                            factura_2 = #3#4 - 1;
                        |SINO;
                            |VETE arriba;
                        |FINSI;
                |SINO;
                    factura_1 = factura_1 - 1;
                    factura_2 = factura_2 - 1;
                |FINSI;

                |SI #0#0 = #0#3;
                    |HAZ grabacon_1;
                |SINO;
                    |HAZ grabacon_1;
                    |HAZ grabacon_2;
                |FINSI;
            |SINO;
                |DDEFECTO #2;
                #2#0 = 1;
                |GRABA 020#2c;
            |FINSI;
            |LIBERA #2;
            |CIERRA #2;
        |FINSI;
     |FINSI;

     |ABRE #2;
     |LIBERA #1;
     |LEE 101#2p;
     |SI FSalida = 0;
        |SI #0#0 = 0; serie_1 = #2#1;  factura_1 = #2#11; |FINSI;
        |SI #0#0 = 1; serie_1 = #2#2;  factura_1 = #2#12; |FINSI;
        |SI #0#0 = 2; serie_1 = #2#3;  factura_1 = #2#13; |FINSI;
        |SI #0#0 = 3; serie_1 = #2#4;  factura_1 = #2#14; |FINSI;
        |SI #0#0 = 4; serie_1 = #2#5;  factura_1 = #2#15; |FINSI;
        |SI #0#0 = 5; serie_1 = #2#6;  factura_1 = #2#16; |FINSI;
        |SI #0#0 = 6; serie_1 = #2#7;  factura_1 = #2#17; |FINSI;
        |SI #0#0 = 7; serie_1 = #2#8;  factura_1 = #2#18; |FINSI;
        |SI #0#0 = 8; serie_1 = #2#9;  factura_1 = #2#19; |FINSI;
        |SI #0#0 = 9; serie_1 = #2#10; factura_1 = #2#20; |FINSI;

        |SI #0#3 = 0; serie_2 = #2#1;  factura_2 = #2#11; |FINSI;
        |SI #0#3 = 1; serie_2 = #2#2;  factura_2 = #2#12; |FINSI;
        |SI #0#3 = 2; serie_2 = #2#3;  factura_2 = #2#13; |FINSI;
        |SI #0#3 = 3; serie_2 = #2#4;  factura_2 = #2#14; |FINSI;
        |SI #0#3 = 4; serie_2 = #2#5;  factura_2 = #2#15; |FINSI;
        |SI #0#3 = 5; serie_2 = #2#6;  factura_2 = #2#16; |FINSI;
        |SI #0#3 = 6; serie_2 = #2#7;  factura_2 = #2#17; |FINSI;
        |SI #0#3 = 7; serie_2 = #2#8;  factura_2 = #2#18; |FINSI;
        |SI #0#3 = 8; serie_2 = #2#9;  factura_2 = #2#19; |FINSI;
        |SI #0#3 = 9; serie_2 = #2#10; factura_2 = #2#20; |FINSI;
     |SINO;
        |DDEFECTO #2;
         #2#0 = 1;
        |GRABA 020#2c;
        serie_1   = "  ";
        factura_1 = 0;
        serie_2   = "  ";
        factura_2 = 0;
     |FINSI;

     |BUCLE asprepar1;

     |SI #0#0 = #0#3;
          factura_2 = factura_1;
          serie_2   = serie_1;
     |FINSI;

     |ABRE #5;
     #5#0 = #2#33;
     #5#1 = #2#34;
     |LEE 040#5=;
     |SI FSalida = 0; |Y #5#3 = "A";
         |ABRE #4;
         |SI #2#32 = "S"; |BUCLE asclient; |FINSI;
         |CIERRA #4;
     |FINSI;
     |CIERRA #5;

     |SI #0#0 = #0#3;
          |HAZ grabacon_1;
          factura_2 = factura_1;
          serie_2   = serie_1;
     |SINO;
          |SI factura_1 ! 0; |HAZ grabacon_1; |FINSI;
          |SI factura_2 ! 0; |HAZ grabacon_2; |FINSI;
     |FINSI;

     |LIBERA #2;
     |CIERRA #2;
|FCAL;

|CALCULO grabacon_1;
|SI #0#0 = 0; #2#11 = factura_1; |FINSI;
|SI #0#0 = 1; #2#12 = factura_1; |FINSI;
|SI #0#0 = 2; #2#13 = factura_1; |FINSI;
|SI #0#0 = 3; #2#14 = factura_1; |FINSI;
|SI #0#0 = 4; #2#15 = factura_1; |FINSI;
|SI #0#0 = 5; #2#16 = factura_1; |FINSI;
|SI #0#0 = 6; #2#17 = factura_1; |FINSI;
|SI #0#0 = 7; #2#18 = factura_1; |FINSI;
|SI #0#0 = 8; #2#19 = factura_1; |FINSI;
|SI #0#0 = 9; #2#20 = factura_1; |FINSI;
|GRABA 020#2a;

|FCAL;

|CALCULO grabacon_2;
|SI #0#3 = 0; #2#11 = factura_2; |FINSI;
|SI #0#3 = 1; #2#12 = factura_2; |FINSI;
|SI #0#3 = 2; #2#13 = factura_2; |FINSI;
|SI #0#3 = 3; #2#14 = factura_2; |FINSI;
|SI #0#3 = 4; #2#15 = factura_2; |FINSI;
|SI #0#3 = 5; #2#16 = factura_2; |FINSI;
|SI #0#3 = 6; #2#17 = factura_2; |FINSI;
|SI #0#3 = 7; #2#18 = factura_2; |FINSI;
|SI #0#3 = 8; #2#19 = factura_2; |FINSI;
|SI #0#3 = 9; #2#20 = factura_2; |FINSI;
|GRABA 020#2a;
|FCAL;

|PROCESO graba_con;
|ABRE #9;
#9#0 = #4#4;
#9#1 = #4#5;
|LEE 040#9=;
|SI FSalida ! 0; |CIERRA #9; |ACABA; |FINSI;
|CIERRA #9;

|ABRE #10;
|LEE 040#10p;
|SI FSalida ! 0; |DDEFECTO #10; |FINSI;
|CIERRA #10;

c_clie    = #4#1;
c_clie    = ("00000" + c_clie) % -105;
fijo    = #10#3; |QBF fijo;
fijo    = fijo + c_clie;
conver1 = #4#15 % 0102;
conver2 = #4#15 % 0402;
conver  = conver1 + conver2;
c_fecha = conver;
c_fecha = ("0000" + c_fecha) % -104;

|ABRE #99;
#99#0 = #4#0;
#99#1 = #4#1;
#99#2 = #4#2;
|LIBERA #99;
|LEE 140#99=;
|SI FSalida = 0;
   #99#3  = #10#1;
   #99#4  = #10#2;
   #99#5  = c_fecha;
   #99#6  = fijo;
   #99#7  = #9#2;
   #99#8  = #9#6;
   #99#9  = #9#3;
   #99#10 = #9#4;
   #99#11 = #4#13;
   #99#12 = #9#5;
   #99#13 = 0;
   #99#14 = "";
   |GRABA 140#99a;
|SINO;
   |DDEFECTO #99;
   #99#0  = #4#0;
   #99#1  = #4#1;
   #99#2  = #4#2;
   #99#3  = #10#1;
   #99#4  = #10#2;
   #99#5  = c_fecha;
   #99#6  = fijo;
   #99#7  = #9#2;
   #99#8  = #9#6;
   #99#9  = #9#3;
   #99#10 = #9#4;
   #99#11 = #4#13;
   #99#12 = #9#5;
   #99#13 = 0;
   #99#14 = "";
   |GRABA 140#99n;
|FINSI;
|CIERRA #99;
|FPRC;
