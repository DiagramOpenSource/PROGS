|FICHEROS;
   finz0001 #0;

   finm0006 #10;
   finm0007 #11;
   finm0008 #12;
   finm0011 #13;
   finm0009 #14;

   canempr@ #100;
   cacuent@ #101;
   camasic@ #102;
   camasil@ #103;
   cacupre@ #104;
|FIN;

|VARIABLES;
   aAlfa       = "";
   aAlfa1      = "";
   aEstado     = "";

   fFecha      = @;

   nDAnyo      = 0;
   nAnyo       = 0;
   nTecla      = 0;
   nSwCargaDef = 0;
   nSwError    = 0;
   nCalc       = 0;
   nCalc1      = 0;
   nCont       = 0;
   nCont1      = 0;
   nNivel1     = 0;
   nNivel2     = 0;
   nNivel3     = 0;
   nNivel4     = 0;
   nNivel5     = 0;
   nNivel6     = 0;

   nPant0      = 0;
   nLabel1     = -1;
   nLabel2     = -1;
   nLabel3     = -1;
   nLabel4     = -1;

   nLabelProceso = -1;
|FIN;

|PROCESO MiraEmpresa;
   nTecla = FSalida;
   |SI FSalida = 2; |ACABA; |FINSI;

   aAlfa = #finz0001#0; |QBF aAlfa;
   aAlfa1 = aAlfa + "def/canempre.mas";
   |CARGA_DEF aAlfa1, canempr@;
   |SI FSalida ! 0;
      |MENAV "    ERROR !!! No puedo encontrar el fichero de empresas contables. Revise el path.";
      |ERROR; |ACABA;
   |FINSI;

   aAlfa = #finz0001#0; |QBF aAlfa;
   aAlfa1 = aAlfa + "fich/"; |PATH_DAT #canempr@#aAlfa1#;
   |ABRE #canempr@;

   |SI nTecla = 10;
      #canempr@#2 = #finz0001#1;
      #canempr@#3 = #finz0001#2;
      |LEE 000#canempr@.];
      |CONSULTA_CLAVE #1#canempr@;
      |SI FSalida = 0;
         #finz0001#1 = #canempr@#2; |PINTA #finz0001#1;
         #finz0001#2 = #canempr@#3; |PINTA #finz0001#2;
      |FINSI;
      |ERROR;
   |FINSI;

   #canempr@#2 = #finz0001#1;
   #canempr@#3 = #finz0001#2;
   |LEE 000#canempr@.=;
   |SI FSalida ! 0;
      |SI Campo = 2;
         |MENAV "    Empresa contable inexistente !!! ";
         |ERROR;
      |FINSI;
   |SINO;
      #finz0001#3 = #canempr@#1; |PINTA #finz0001#3;
      |SI #canempr@#26 > 80;
         #finz0001#9 = #canempr@#26 + 1900;
      |SINO;
         #finz0001#9 = #canempr@#26 + 2000;
      |FINSI;
   |FINSI;

   |CIERRA #canempr@; |DESCARGA_DEF #canempr@;
|FPRC;

|PROCESO MiraPath;
   |SI FSalida = 10;
      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "contagen/";
      #finz0001#0 = aAlfa; |PINTA #finz0001#0;
      |ERROR; |ACABA;
   |FINSI;
|FPRC;

|PROCESO Tipo80; |TIPO 80;
   FSalida = 2482;
|FPRC;

|PROCESO CargaDef;
   nSwCargaDef = 1;

   aAlfa = #finz0001#0; |QBF aAlfa;
   aAlfa1 = aAlfa + "def/canempre.mas";
   |CARGA_DEF aAlfa1, canempr@;
   |SI FSalida = 0;
      aAlfa1 = aAlfa + "def/cacuenta.mas";
      |CARGA_DEF aAlfa1, cacuent@;
      |SI FSalida ! 0; |DESCARGA_DEF #canempr@; |ACABA; |FINSI;

      aAlfa1 = aAlfa + "def/camaasic.mas";
      |CARGA_DEF aAlfa1, camasic@;
      |SI FSalida ! 0;
         |DESCARGA_DEF #cacuent@; |DESCARGA_DEF #canempr@;
         |ACABA;
      |FINSI;

      aAlfa1 = aAlfa + "def/camaasil.mas";
      |CARGA_DEF aAlfa1, camasil@;
      |SI FSalida ! 0;
         |DESCARGA_DEF #camasic@;
         |DESCARGA_DEF #cacuent@; |DESCARGA_DEF #canempr@;
         |ACABA;
      |FINSI;

      aAlfa1 = aAlfa + "def/cacuepre.mas";
      |CARGA_DEF aAlfa1, cacupre@;
      |SI FSalida ! 0;
         |DESCARGA_DEF #camasil@; |DESCARGA_DEF #camasic@;
         |DESCARGA_DEF #cacuent@; |DESCARGA_DEF #canempr@;
         |ACABA;
      |FINSI;

      nSwCargaDef = 0;

      aAlfa1 = aAlfa + "fich/"; |PATH_DAT #canempr@#aAlfa1#;
      |ABRE #canempr@;
   |FINSI;
|FPRC;

|PROCESO DescargaDef;
   |SI nSwCargaDef = 0;
                         |DESCARGA_DEF #cacupre@;
                         |DESCARGA_DEF #camasil@;
                         |DESCARGA_DEF #camasic@;
                         |DESCARGA_DEF #cacuent@;
      |CIERRA #canempr@; |DESCARGA_DEF #canempr@;
   |FINSI;
|FPRC;

|PROCESO Cuentas;
   |SI nCont1 ] 50;
      aAlfa1 = "LABEL,{{1}}Ejercicio " + nAnyo + "   ";
      aAlfa1 = aAlfa1 + "Procesando cuenta " + #cacuent@#0;
      aAlfa1 = aAlfa1 + " " + #cacuent@#2; |QBF aAlfa1;
      |CONTROL_SIMPLE nPant0, aAlfa1, 2102, 2198, NULL;
      nLabelProceso = FSalida; ||PULSATECLA;
      nCont1 = 0;
   |SINO;
      nCont1 = nCont1 + 1;
   |FINSI;

   |DDEFECTO #finm0006;

   #finm0006#0 = #finz0001#1;
   #finm0006#1 = nAnyo;
   #finm0006#2 = #cacuent@#0;
   #finm0006#3 = #cacuent@#2;
   #finm0006#4 = #cacuent@#51;
   #finm0006#5 = #cacuent@#52;
   #finm0006#6 = #cacuent@#53;
   |GRABA 020#finm0006.n;

   |SI FSalida ! 0; nSwError = 1; |FINSI;
|FPRC;

|DEFBUCLE Cuentas;
#cacuent@#1001#;
;
"            ";
"zzzzzzzzzzzz";
;
NULL,Cuentas;
|FIN;

|PROCESO CapturaPlanActual;
   #finz0001#4 = "S"; |PINTA #finz0001#4;
   || Preparo para leer el fichero de empresas
   |HAZ CargaDef;

   || Busco la empresa del ejercicio actual
   #canempr@#2 = #finz0001#1;
   #canempr@#3 = #finz0001#2;
   |LEE 000#canempr@.=;
   |SI FSalida = 0;
      aAlfa1 = aAlfa + "fich/" + (("00000" + #finz0001#1) % -105) + #finz0001#2 + "/";
      |PATH_DAT #cacuent@#aAlfa1#;

      nAnyo = #finz0001#9; nSwError = 0;
      |BUCLE Cuentas;
      |SI nSwError = 0;
         aEstado = "LABEL,{{1}} Completado";
      |SINO;
         aEstado = "LABEL,{{4}} Incompleto !!!";
      |FINSI;
   |SINO;
      aEstado = "LABEL,{{4}} Incompleto !!!";
   |FINSI;

   |CONTROL_SIMPLE nPant0, aEstado, 1361, 1373, NULL;
   nLabel1 = FSalida;

   |HAZ DescargaDef;
|FPRC;

|PROCESO CapturaPlanesAnt;
   #finz0001#5 = "S"; |PINTA #finz0001#5;

   || Preparo para leer el fichero de empresas
   |HAZ CargaDef;

   || Busco la empresa y periodo correspondiente al a¤o anterior al que
   ||     acabo de pasar
   #canempr@#2 = #finz0001#1;
   #canempr@#3 = 0;
   |LEE 000#canempr@.];
   |PARA; |SI FSalida = 0; |Y #canempr@#2 = #finz0001#1; |HACIENDO;
      nAnyo = #canempr@#26;
      |SI nAnyo > 80;
         nAnyo = nAnyo + 1900;
      |SINO;
         nAnyo = nAnyo + 2000;
      |FINSI;

      nCalc1 = #finz0001#9 - 6;
      |SI nAnyo ] nCalc1; |Y nAnyo < #finz0001#9;
         |DDEFECTO #finm0006;
         #finm0006#0 = #finz0001#1;
         #finm0006#1 = nAnyo;
         |LEE 000#finm0006.];
         |SI FSalida ! 0; |O #finm0006#0 ! nAnyo; |O #finm0006#0 ! #finz0001#1;
            aAlfa = #finz0001#0; |QBF aAlfa;
            aAlfa1 = aAlfa + "fich/" + (("00000" + #canempr@#2) % -105) + #canempr@#3 + "/";
            |PATH_DAT #cacuent@#aAlfa1#;
            nSwError = 0;
            |BUCLE Cuentas;
            |SI nSwError = 0;
               aEstado = "LABEL,{{1}} Completado";
            |SINO;
               aEstado = "LABEL,{{4}} Incompleto !!!";
            |FINSI;
         |FINSI;
      |FINSI;
      |LEE 000#canempr@.s;
   |SIGUE;

   |CONTROL_SIMPLE nPant0, aEstado, 1461, 1473, NULL;
   nLabel2 = FSalida;

   |HAZ DescargaDef;
|FPRC;

|PROCESO PasaLinAsientos;
   |DDEFECTO #finm0008;

   #finm0008#0 = #finz0001#1;
   #finm0008#1 = #finz0001#9;
   #finm0008#2 = #camasil@#0;
   #finm0008#3 = #camasil@#1;
   #finm0008#4 = #camasil@#2;
   #finm0008#5 = #camasil@#3;
   #finm0008#6 = #camasil@#4;
   #finm0008#7 = #camasil@#6;
   #finm0008#8 = #camasil@#7;
   #finm0008#9 = #camasil@#8;
   #finm0008#10 = #camasil@#9;
   |GRABA 020#finm0008.n;

   |SI FSalida ! 0; nSwError = 1; |FINSI;
|FPRC;

|DEFBUCLE PasaLinAsientos;
#camasil@#1004#;
;
#camasic@#0, #camasic@#1, #camasic@#2, 0000;
#camasic@#0, #camasic@#1, #camasic@#2, 9999;
;
NULL, PasaLinAsientos;
|FIN;

|PROCESO PasaAsientos;
   |SI nCont1 ] 50;
      aAlfa1 = "LABEL,{{1}}Pasando asiento : Diario " + (("00" + #camasil@#0) % -102);
      aAlfa1 = aAlfa1 + "  Fecha " + #camasil@#1;
      aAlfa1 = aAlfa1 + "  Documento " + (("000000" + #camasil@#2) % -106); |QBF aAlfa1;
      |CONTROL_SIMPLE nPant0, aAlfa1, 2102, 2198, NULL;
      nLabelProceso = FSalida; |PULSATECLA;
      nCont1 = 0;
   |SINO;
      nCont1 = nCont1 + 1;
   |FINSI;

   |DDEFECTO #finm0007;
   #finm0007#0 = #finz0001#1;
   #finm0007#1 = #finz0001#9;
   #finm0007#2 = #camasic@#0;
   #finm0007#3 = #camasic@#1;
   #finm0007#4 = #camasic@#2;
   #finm0007#5 = #camasic@#4;
   #finm0007#6 = #camasic@#5;
   #finm0007#7 = #camasic@#6;
   |GRABA 020#finm0007.n;

   |SI FSalida ! 0; nSwError = 1; |FINSI;

   |BUCLE PasaLinAsientos;
|FPRC;

|DEFBUCLE PasaAsientos;
#camasic@#1003#;
;
00, "00.00.0000", 00000;
99, "31.12.9999", 99999;
;
NULL, PasaAsientos;
|FIN;

|PROCESO CapturaAsientos;
   #finz0001#6 = "S"; |PINTA #finz0001#6;

   |HAZ CargaDef;

   aAlfa = #finz0001#0; |QBF aAlfa;
   aAlfa1 = aAlfa + "fich/" + (("00000" + #finz0001#1) % -105) + #finz0001#2 + "/";
   |PATH_DAT #camasic@#aAlfa1#; |PATH_DAT #camasil@#aAlfa1#;

   nSwError = 0;
   |BUCLE PasaAsientos;
   |SI nSwError = 0;
      aEstado = "LABEL,{{1}} Completado";
   |SINO;
      aEstado = "LABEL,{{4}} Incompleto !!!";
   |FINSI;

   |CONTROL_SIMPLE nPant0, aEstado, 1561, 1573, NULL;
   nLabel3 = FSalida;

   |HAZ DescargaDef;
|FPRC;

|PROCESO PasaFichas;
   #canempr@#2 = #finz0001#1;
   #canempr@#3 = #finz0001#2;
   |LEE 000#canempr@.=;
   |SI FSalida ! 0; |DDEFECTO #canempr@; |FINSI;

   #cacuent@#0 = #cacupre@#0;
   #cacuent@#1 = #cacupre@#1;
   |LEE 000#cacuent@.=;
   |SI FSalida ! 0; |DDEFECTO #cacuent@; |FINSI;

   |DDEFECTO #finm0009;
   #finm0009#0  = #finz0001#1;
   #finm0009#1  = #finz0001#9;
   #finm0009#2  = #cacupre@#0;
   #finm0009#3  = #cacupre@#2;
   #finm0009#4  = #cacupre@#3;
   #finm0009#5  = #cacupre@#4;
   #finm0009#6  = #cacupre@#5;
   #finm0009#7  = #cacupre@#6;
   #finm0009#8  = #cacupre@#7;
   #finm0009#9  = #cacupre@#8;
   #finm0009#10 = #cacupre@#9;
   #finm0009#11 = #cacupre@#10;
   #finm0009#12 = #cacupre@#11;
   #finm0009#13 = #cacupre@#12;
   #finm0009#14 = #cacupre@#13;
   #finm0009#15 = #cacupre@#14;
   #finm0009#16 = #cacupre@#15;
   #finm0009#17 = #cacupre@#16;
   #finm0009#18 = #cacuent@#2;
   #finm0009#19 = #canempr@#4;
   |GRABA 020#finm0009.n;
|FPRC;

|DEFBUCLE PasaFichas;
#cacupre@#1003#;
;
01, "            ", 0;
99, "zzzzzzzzzzzz", 9;
;
NULL, PasaFichas;
|FIN;

|PROCESO CapturaFichasPres;
   #finz0001#7 = "S"; |PINTA #finz0001#7;

   |HAZ CargaDef;

   aAlfa = #finz0001#0; |QBF aAlfa;
   aAlfa1 = aAlfa + "fich/" + (("00000" + #finz0001#1) % -105) + #finz0001#2 + "/";
   |PATH_DAT #cacupre@#aAlfa1#; |PATH_DAT #cacuent@#aAlfa1#;
   ||PATH_DAT #camasil@#aAlfa1#;

   nSwError = 0;
   |BUCLE PasaFichas;
   |SI nSwError = 0;
      aEstado = "LABEL,{{1}} Completado";
   |SINO;
      aEstado = "LABEL,{{4}} Incompleto !!!";
   |FINSI;

   |CONTROL_SIMPLE nPant0, aEstado, 1561, 1573, NULL;
   nLabel3 = FSalida;

   |HAZ DescargaDef;
|FPRC;

|PROCESO Pase;
   |ABRE #finm0006; |ABRE #finm0007; |ABRE #finm0008; |ABRE #finm0009;

   || Primero paso el plan de cuentas actual
   |HAZ CapturaPlanActual;
   |SI nLabelProceso ] 0;
      |FIN_CONTROL_WINDOWS nLabelProceso;
      nLabelProceso = -1;
   |FINSI;

   || El paso siguiente es pasar el plan de cuentas de a¤os anteriores
   |HAZ CapturaPlanesAnt;
   |SI nLabelProceso ] 0;
      |FIN_CONTROL_WINDOWS nLabelProceso;
      nLabelProceso = -1;
   |FINSI;

   || Hecho esto paso los asientos contables
   |HAZ CapturaAsientos;
   |SI nLabelProceso ] 0;
      |FIN_CONTROL_WINDOWS nLabelProceso;
      nLabelProceso = -1;
   |FINSI;

   || Y para acabar paso la ficha de presupuestos que es identica a la de
   ||   contagen
   |HAZ CapturaFichasPres;
   |SI nLabelProceso ] 0;
      |FIN_CONTROL_WINDOWS nLabelProceso;
      nLabelProceso = -1;
   |FINSI;

   |CIERRA #finm0006; |CIERRA #finm0007; |CIERRA #finm0008; |CIERRA #finm0009;
|FPRC;

|PROCESO BorraSaldos;
   |BORRA 020#finm0006.a;
|FPRC;

|DEFBUCLE BorraSaldos;
#finm0006#1;
;
#finz0001#1, nDAnyo, "            ";
#finz0001#1, #finz0001#9, "zzzzzzzzzzzz";
be;
NULL, BorraSaldos;
|FIN;

|PROCESO BorraLinAstos;
   |BORRA 020#finm0008.a;
|FPRC;

|DEFBUCLE BorraLinAstos;
#finm0008#1;
;
#finm0007#0, #finm0007#1, #finm0007#2, #finm0007#3, #finm0007#4, 0000;
#finm0007#0, #finm0007#1, #finm0007#2, #finm0007#3, #finm0007#4, 9999;
be;
NULL,BorraLinAstos;
|FIN;

|PROCESO BorraAstos;
   |BUCLE BorraLinAstos;

   |BORRA 020#finm0007.a;
|FPRC;

|DEFBUCLE BorraAstos;
#finm0007#1;
;
#finz0001#1, #finz0001#9, 00, "01.01.0000", 000000;
#finz0001#1, #finz0001#9, 99, "31.12.9999", 999999;
be;
NULL, BorraAstos;
|FIN;

|PROCESO BorraAntiguos;
   nDAnyo = #finz0001#9 - 6;
   |BUCLE BorraSaldos;
   |BUCLE BorraAstos;
|FPRC;

|PROGRAMA;
   |CLS;

   |ABRE #finz0001;
   |LEE 101#finz0001.p;
   |SI FSalida ! 0;
      |DDEFECTO #finz0001;
      |GRABA 020#finz0001.c;
   |FINSI;

   |PINPA #0#0; nPant0 = FSalida;
   |PINDA #0#0;

   |ENDATOS #1#finz0001;
   |SI FSalida = 0;
      |GRABA 020#finz0001.a;

      |C_M #finz0001#4, 1, "S";
      |C_M #finz0001#5, 1, "S";
      |C_M #finz0001#6, 1, "S";
      |C_M #finz0001#7, 1, "S";

      |ABRE #finm0011;
      #finm0011#0 = #finz0001#1;
      #finm0011#1 = #finz0001#9;
      |LEE 000#finm0011.=;
      |SI FSalida = 0;
         aAlfa = "    NSe inicializaran los mantenimientos de esta empresa. " + &191;
         aAlfa = aAlfa + " Continuar ?";
         |CONFI aAlfa;
         |SI FSalida ! 0;
            |MENAV "    Proceso cancelado.";
         |SINO;
            |HAZ BorraAntiguos;
            |HAZ Pase;
         |FINSI;
      |SINO;
         |DDEFECTO #finm0011;
         #finm0011#0 = #finz0001#1;
         #finm0011#1 = #finz0001#9;
         #finm0011#2 = #finz0001#0;
         #finm0011#3 = #finz0001#2;
         #finm0011#4 = #finz0001#3;
         #finm0011#5  = nNivel1;
         #finm0011#6  = nNivel2;
         #finm0011#7  = nNivel3;
         #finm0011#8  = nNivel4;
         #finm0011#9  = nNivel5;
         #finm0011#10 = nNivel6;
         |GRABA 020#finm0011.n;

         |HAZ Pase;
      |FINSI;

      |CIERRA #finm0011;
   |FINSI;

   |LIBERA #finz0001; |CIERRA #finz0001;

   |SI nLabel1 ] 0; |FIN_CONTROL_WINDOWS nLabel1; |FINSI;
   |SI nLabel2 ] 0; |FIN_CONTROL_WINDOWS nLabel2; |FINSI;
   |SI nLabel3 ] 0; |FIN_CONTROL_WINDOWS nLabel3; |FINSI;
   |SI nLabel4 ] 0; |FIN_CONTROL_WINDOWS nLabel4; |FINSI;
   |SI nLabelProceso ] 0; |FIN_CONTROL_WINDOWS nLabelProceso; |FINSI;
|FPRO;
