|FICHEROS;
  c3galamo #0;
  camocabe #1;
  camoline #2;
|FIN;

|VARIABLES;
  &modcon = 0;

  fecalf = "";
  feclin = "";
  linea = 0;
  mensaje = "";
  trab1 = "";
  dias = 0;
  diasanyo = 0;
  ultlin = 0;
  ultfis = @;
  ultcon = @;
  amorcon = 0;
  amorfis = 0;
  canamort = 0;
  coefi = 0.0;
  fecpri = @;
  fecult = @;
  valorele = 0;
  fecha = @;
  cuotamor = 0;
  nume1 = 0;
  nume2 = 0;
  cuodig = 0;
  x = 0;
  topfisc = @;
  topcont = @;
  diastot = 0;
  diasprim = 0;
  empcon = 0;
  ejecon = 0;
  leidos = 0;
  dirfich0 = "";
  &dir_H = "";
  xx = 0;
  yy = 0;
  desde = 0;
  hasta = 0;
  y = 0;
  varcamp = 0;
  &r_emp = 0;
  &r_per = 0;
  alfa1 = "";
  alfa2 = "";
  sw_error = 0;
  men1 = "     NO Existe Periodo en la empresa Contable";
  men9 = "     Empresa Contable INACTIVA";
  sw = 0;
  pasar = 0;
  concepto = "";

|FIN;

|INCLUYE inici1_i;
|INCLUYE conasi_i;
|INCLUYE numamo_i;

|| *************************************************************************
||                        CALCULOS DE PANTALLA
|| *************************************************************************

|PROCESO numamo; |TIPO 0;
    x_alfa1 = #0Campo;
|HAZ x_punto;
    #0Campo = x_alfa1;
    |PINTA #0Campo;
|FPRC;

|PROCESO defecano;
  fecalf = #0#3;
  fecalf = fecalf % -104;
  #0#2 = fecalf;
|FPRC;

|PROCESO mayor; |TIPO 0;
  alfa1 = #0Campo > " ";
  #0Campo = alfa1;
  |PINTA #0Campo;
|FPRC;

|PROCESO mayor1; |TIPO 0;
  |HAZ mayor;
  |SI #0Campo = "N";
      |PARA x = 11;  |SI x [ 50;  |HACIENDO x = x + 1;
            |CAMPO_MODIFICA #0x,1,"S";
      |SIGUE;
      #0#7  = 0;
      #0#9  = 0;
      #0#8  = 0;
      #0#10 = 0;
      |CAMPO_MODIFICA #0#7,1,"N";
      |CAMPO_MODIFICA #0#9,1,"N";
      |CAMPO_MODIFICA #0#8,1,"N";
      |CAMPO_MODIFICA #0#10,1,"N";
      |PINTA #0#7;
      |PINTA #0#9;
      |PINTA #0#8;
      |PINTA #0#10;
  |SINO;
      |PARA x = 11;  |SI x [ 50;  |HACIENDO x = x + 1;
            #0x = 0;
            |CAMPO_MODIFICA #0x,1,"N";
      |SIGUE;
      |CAMPO_MODIFICA #0#7,1,"S";
      |CAMPO_MODIFICA #0#9,1,"S";
      |CAMPO_MODIFICA #0#8,1,"S";
      |CAMPO_MODIFICA #0#10,1,"S";
  |FINSI;
|FPRC;

|PROCESO consulta; |TIPO 0;
  |SI FSalida ! 9;  |ACABA;  |FINSI;
  |SUB_EJECUTA "caconemp.run";
  |ERROR;
  |SI Campo = 7;
      #0#7 = r_emp;
      #0#9 = r_per;
      |PTEC 802;
      |PTEC 802;
  |FINSI;
  |SI Campo = 8;
      #0#8 = r_emp;
      #0#10 = r_per;
      |PTEC 802;
  |FINSI;
  |SI Campo ] 11;
      #0Campo = r_emp;
      varcamp = Campo + 20;
      #0varcamp = r_per;
      |PTEC 802;
      |PTEC 802;
  |FINSI;
|FPRC;

|PROCESO deshas; |TIPO 0;
  |SI #0#8 < #0#7;
      |MENAV "      Error en Introduccion";
      |ERROR;
  |FINSI;
|FPRC;

|| --------------- comprueba desde-hasta empresas ---------------------------

|PROCESO buscaem1;
  |SI #30#21 = "I"; |ACABA; |FINSI;
  leidos = 1;
  |ERROR10;
|FPRC;

|DEFBUCLE buscaempre;
#30#1;
;
#0#7,desde;
#0#8,hasta;
e;
NULL,buscaem1;
|FIN;

|PROCESO buclempre;
  |SI #0#9 > #0#10;
      |MENAV "     Error en Introduccion";
      |ERROR;
      |ACABA;
  |FINSI;
  |SI #0#7 = 0; |Y #0#8 = 0; |ACABA; |FINSI;
  desde = #0#9;
  hasta = #0#10;
  leidos = 0;
  |BUCLE buscaempre;
  |SI leidos = 0;
      |MENAV "    ATENCION SELECCION VACIA";
      |ERROR;
      |ACABA;
  |FINSI;
|FPRC;

|| ------------------------------------------------------------------------

|PROCESO nomodi;
  |PARA x = Campo + 1;  |SI x [ 30;  |HACIENDO x = x + 1;
        #0x = 0;
        |CAMPO_MODIFICA #0x,1,"N";
        y = x + 20;
        #0y = 0;
        |CAMPO_MODIFICA #0y,1,"N";
  |SIGUE;
    y = Campo + 20;
  #0y = 0;
  |CAMPO_MODIFICA #0y,1,"N";
  |PINTA #0y;
|FPRC;

|PROCESO esbuena; || desde campo de empresas seleccion
  |SI FSalida = 2; |ACABA; |FINSI;
  |SI #0Campo = 0; |HAZ nomodi;  |ACABA;  |FINSI;
  |ABRE #30;
  #30#2 = #0Campo;
  #30#3 = 0;
  |LEE 011#30];
  |SI FSalida ! 0;  |O #30#2 ! #0Campo;
      |MENAV "     NO Existe la empresa Contable";
      |ERROR;
  |FINSI;
  |CIERRA #30;
|FPRC;

|PROCESO esbuena1;
  |SI FSalida = 2;|ACABA;|FINSI;
  x = Campo - 20;
  |SI #0x = 0;  |ACABA;  |FINSI;

  sw_error = 0;
  |ABRE #30;
  x = Campo - 20;
  #30#2 = #0x;
  #30#3 = #0Campo;
  |LEE 011#30=;
  |SI FSalida ! 0;
      sw_error = 1;
      |CIERRA #30;
      |MENAV men1;
      |ERROR;
      |ACABA;
  |FINSI;
  |CIERRA #30;
  |SI #30#21 = "I";
      sw_error = 1;
      |MENAV men9;
      |ERROR;
      |ACABA;
  |FINSI;
  x = Campo + 20;
  #0x = #30#1;
  |PINTA #0x;
|FPRC;

|| **********************************************************************
||                       CALCULOS DEL PROCESO
|| **********************************************************************

|| ---------- Seleccion DESDE / HASTA Empresa.

|PROCESO esdesd1;

  |DBASE dir_fich;
  dirfich0 = dir_fich + "fich/";
  alfa1 = #30#2;
  alfa2 = #30#3;
  alfa1 = "00000" + alfa1;   alfa1 = alfa1 % -105;
  alfa2 = "0"   + alfa2;   alfa2 = alfa2 % -101;
  dirfich0 = dirfich0 + alfa1 + alfa2 + "/";

  |SI #30#21 = "I"; |ACABA; |FINSI; || Inactiva

  x = Campo + 20;
  |HAZ haztodo;
|FPRC;

|DEFBUCLE esdesde;
#30#1;
;
#0#7, #0#9;
#0#8,#0#10;
e;
NULL,esdesd1;
|FIN;

|| ---------- Seleccion en parrilla.

|PROCESO esunaauna;
  |PARA xx = 11;  |SI xx [ 30;  |HACIENDO xx = xx + 1;
        |SI #0xx = 0;  |SAL;  |FINSI;

        |DBASE dir_fich;
        dirfich0 = dir_fich + "fich/";
        yy = xx + 20;
        alfa1 = #0xx;
        alfa2 = #0yy;
        alfa1 = "00000" + alfa1;   alfa1 = alfa1 % -105;
        alfa2 = "0"   + alfa2;   alfa2 = alfa2 % -101;
        dirfich0 = dirfich0 + alfa1 + alfa2 + "/";
|| lee empresa
        |ABRE #30;
        #30#2 = #0xx;
        #30#3 = #0yy;
        |LEE 011#30=;
        |SI FSalida ! 0; |CIERRA #30; |VETE otramas; |FINSI;
        |CIERRA #30;
        |HAZ haztodo;
|ET otramas;
  |SIGUE;
|FPRC;

|| *********************************************************************
||                              PROGRAMA
|| *********************************************************************

|PROCESO tipo3; |TIPO 3;
  sw = 0;

    |PUSHV 2102 2378;
    |ATRI I;
    |CUADRO 2102 2378
    |ATRI N;
    |ATRI R;
    |PINTA 2203," EMPRESA:                                                                  ";
    |ATRI 0;

  |SI #0#6 = "S";
      |BUCLE esdesde;
  |SINO;
      |HAZ esunaauna;
  |FINSI;
|FPRC;

|| ***********************************************************************
||                    CALCULO AMORTIZACIONES
|| ***********************************************************************


||
||
||este PROCESO YA NO SE UTILIZA
||
||

|PROCESO normfisc;
  fecpri = #1#6;
  fecult = #0#3;
  |SI #1#23 ! "00.00.0000"; |Y #1#23 < #0#3;
      fecult = #1#23;
  |FINSI;
  diastot = fecult - #1#6;
  canamort = 0;
  |PARA; |SI fecpri < fecult; |HACIENDO;
         cuotamor = ((#1#7 * #1#11) / 100) ! EURODB;
         fecha = fecult - fecpri;
         |SI fecha ] "00.00.0001";
             canamort = canamort + cuotamor;
             nume1 = 1 / 1000000;
             fecult = fecult - nume1;
         |SINO;
             dias = fecult - fecpri;
||             |SI diastot > diasanyo;
||                 amorfis = ((dias * cuotamor) / diasprim) ! 0;
||             |SINO;
                 amorfis = ((dias * cuotamor) / diasanyo) ! EURODB;
||             |FINSI;
             canamort = canamort + amorfis;
             |SAL;
         |FINSI;
  |SIGUE;
  amorfis = canamort - #1#12;
|FPRC;

|PROCESO degrfisc;
  coefi = 2.5;
  |SI #1#14 < 8;  coefi = 2;    |FINSI;
  |SI #1#14 < 5;  coefi = 1.5;  |FINSI;
  coefi = (coefi * #1#11) / 100;
  fecpri = #1#6;
  fecult = #0#3;
  |SI #1#23 ! "00.00.0000"; |Y #1#23 < #0#3;
      fecult = #1#23;
  |FINSI;
  canamort = 0;
  valorele = #1#7;
  |PARA; |SI fecpri < fecult; |HACIENDO;
         cuotamor = ((#1#7 * #1#11) / 100) ! EURODB;
         |SI cuotamor > valorele;
             cuotamor = valorele;
         |SINO;
             cuotamor = (valorele * coefi) ! EURODB;
         |FINSI;
         fecha = fecult - fecpri;
         |SI fecha ] "00.00.0001";
             canamort = canamort + cuotamor;
             valorele = valorele - cuotamor;
             nume1 = 1 / 1000000;
             fecpri = fecpri + nume1;
         |SINO;
             dias = fecult - fecpri;
             amorfis = ((dias * cuotamor) / diasanyo) ! EURODB;
             canamort = canamort + amorfis;
             |SAL;
         |FINSI;
  |SIGUE;
  amorfis = canamort - #1#12;
|FPRC;

|PROCESO acelfisc;
  nume1 = 0;
  |PARA x = 1;  |SI x [ #1#14;  |HACIENDO x = x + 1;
        nume1 = nume1 + x;
  |SIGUE;
  cuodig = #1#7 / nume1;
  x = #1#14;
  fecpri = #1#6;
  fecult = #0#3;
  |SI #1#23 ! "00.00.0000"; |Y #1#23 < #0#3;
      fecult = #1#23;
  |FINSI;
  canamort = 0;
  |PARA; |SI fecpri < fecult; |HACIENDO;
         cuotamor = (cuodig * x) ! EURODB;
         fecha = fecult - fecpri;
         |SI fecha ] "00.00.0001";
             canamort = canamort + cuotamor;
             nume1 = 1 / 1000000;
             fecpri = fecpri + nume1;
             x = x - 1;
         |SINO;
             dias = fecult - fecpri;
             amorfis = ((dias * cuotamor) / diasanyo) ! EURODB;
             canamort = canamort + amorfis;
             |SAL;
         |FINSI;
  |SIGUE;
  amorfis = canamort - #1#12;
|FPRC;

||
||
||este PROCESO YA NO SE UTILIZA
||
||

|PROCESO normcont;
  fecpri = #1#6;
  fecult = #0#3;
  |SI #1#23 ! "00.00.0000"; |Y #1#23 < #0#3;
      fecult = #1#23;
  |FINSI;
  diastot = fecult - #1#6;
  canamort = 0;
  |PARA; |SI fecpri < fecult; |HACIENDO;
         cuotamor = ((#1#7 * #1#17) / 100) ! EURODB;
         fecha = fecult - fecpri;
         |SI fecha ] "00.00.0001";
             canamort = canamort + cuotamor;
             nume1 = 1 / 1000000;
             fecpri = fecpri + nume1;
         |SINO;
             dias = fecult - fecpri;
||             |SI diastot > diasanyo;
||                 amorcon = ((dias * cuotamor) / diasprim) ! 0;
||             |SINO;
                 amorcon = ((dias * cuotamor) / diasanyo) ! EURODB;
||             |FINSI;
             canamort = canamort + amorcon;
             |SAL;
         |FINSI;
  |SIGUE;
  amorcon = canamort - #1#18;
|FPRC;

|PROCESO degrcont;
  coefi = 2.5;
  |SI #1#20 < 8;  coefi = 2;    |FINSI;
  |SI #1#20 < 5;  coefi = 1.5;  |FINSI;
  coefi = (coefi * #1#17) / 100;
  fecpri = #1#6;
  fecult = #0#3;
  |SI #1#23 ! "00.00.0000"; |Y #1#23 < #0#3;
      fecult = #1#23;
  |FINSI;
  canamort = 0;
  valorele = #1#7;
  |PARA; |SI fecpri < fecult; |HACIENDO;
         cuotamor = ((#1#7 * #1#17) / 100) ! EURODB;
         |SI cuotamor > valorele;
             cuotamor = valorele;
         |SINO;
             cuotamor = (valorele * coefi) ! EURODB;
         |FINSI;
         fecha = fecult - fecpri;
         |SI fecha ] "00.00.0001";
             canamort = canamort + cuotamor;
             valorele = valorele - cuotamor;
             nume1 = 1 / 1000000;
             fecpri = fecpri + nume1;
         |SINO;
             dias = fecult - fecpri;
             amorcon = ((dias * cuotamor) / diasanyo) ! EURODB;
             canamort = canamort + amorcon;
             |SAL;
         |FINSI;
  |SIGUE;
  amorcon = canamort - #1#18;
|FPRC;

|PROCESO acelcont;
  nume1 = 0;
  |PARA x = 1;  |SI x [ #1#20;  |HACIENDO x = x + 1;
        nume1 = nume1 + x;
  |SIGUE;
  cuodig = #1#7 / nume1;
  x = #1#20;
  fecpri = #1#6;
  fecult = #0#3;
  |SI #1#23 ! "00.00.0000"; |Y #1#23 < #0#3;
      fecult = #1#23;
  |FINSI;
  canamort = 0;
  |PARA; |SI fecpri < fecult; |HACIENDO;
         cuotamor = (cuodig * x) ! EURODB;
         fecha = fecult - fecpri;
         |SI fecha ] "00.00.0001";
             canamort = canamort + cuotamor;
             nume1 = 1 / 1000000;
             fecpri = fecpri + nume1;
             x = x - 1;
         |SINO;
             dias = fecult - fecpri;
             amorcon = ((dias * cuotamor) / diasanyo) ! EURODB;
             canamort = canamort + amorcon;
             |SAL;
         |FINSI;
  |SIGUE;
  amorcon = canamort - #1#18;
|FPRC;

|PROCESO calamor;
  |SI #2#4 = "C";
      |SI #2#9 = 0; #2#9 = #2#5; |FINSI;
  |FINSI;
  |SI #2#5 ! 0;  |Y #2#4 ! "V"; |Y #2#7 > ultfis;  ultfis = #2#7;  |FINSI;
  |SI #2#9 ! 0;  |Y #2#4 ! "V"; |Y #2#7 > ultcon;  ultcon = #2#7;  |FINSI;
  |SI #2#2 > ultlin;  ultlin = #2#2;  |FINSI;
  |SI #2#4 = "A";
      #1#12 = #1#12 + #2#5;
      #1#18 = #1#18 + #2#9;
  |FINSI;
|FPRC;

|PROCESO calcula;
  |SI #0#5 = "A";  |Y #1#21 ! "A";  |ACABA;  |FINSI;
  |SI #0#5 = "P";  |Y #1#21 ! "P";  |ACABA;  |FINSI;
  |SI #1#13 = 0;   |Y #1#19 = 0;    |ACABA;  |FINSI;
  ultlin = 0;
  ultfis = 0;
  ultcon = 0;
  #1#12 = 0;
  #1#18 = 0;

||   |PINTA 1839, #1#0;
||   |PINTA 1848, #1#1;
  feclin = #1#6;
  feclin = feclin % -104;
  diasprim = 365;
  |SI feclin = 1980; |O feclin = 1984;  |O feclin = 1988;  |O feclin = 1992;
                     |O feclin = 1996;  |O feclin = 2000;  |O feclin = 2004;
                     |O feclin = 2008;  |O feclin = 2012;  |O feclin = 2016;
      diasprim = 366;
  |FINSI;
  |BUCLELIN 2calamor#1;
  amorfis = 0;
  amorcon = 0;
  |SI #1#10 = "N";
      nume1 = (100 / #1#11) ! EURODB;
      nume1 = nume1 / 1000000;
      nume2 = 100 $ #1#11;
      nume2 = ((365 * nume2 ) / #1#11 ! EURODB);
      nume1 = nume1 + nume2;
  |SINO;
      nume1 = #1#14 / 1000000;
  |FINSI;
  topfisc = #1#6 + nume1;

  |SI #1#16 = "N";
      nume1 = (100 / #1#17) ! EURODB;
      nume1 = nume1 / 1000000;
      nume2 = 100 $ #1#17;
      nume2 = ((365 * nume2 ) / #1#17 ! EURODB);
      nume1 = nume1 + nume2;
  |SINO;
      nume1 = #1#20 / 1000000;
  |FINSI;
  topcont = #1#6 + nume1;

  |SI #1#13 ! 0;
      |SI #1#23 ! "00.00.0000"; |Y #1#23 < #0#3;
          dias = #1#23 - ultfis;
      |SINO;
          dias = #0#3 - ultfis;
      |FINSI;
      |SI dias [ 0;  |O dias > diasanyo;
          mensaje = "     ATENCION!!  ERROR EN FECHAS AMORTIZACION ELEMENTO "
          trab1 = #1#0;
          mensaje = mensaje + trab1 + "/";
          trab1 = #1#1;
          mensaje = mensaje + trab1;
          || ... |MENAV mensaje;
          |ACABA;
      |FINSI;

      |SI #1#10 = "N";
          cuotamor = ((#1#7 * #1#11) / 100) ! EURODB;
          amorfis = ((dias * cuotamor) / diasanyo) ! EURODB;
      |SINO;
          |SI #1#10 = "D";
              |HAZ degrfisc;
          |SINO;
              |HAZ acelfisc;
          |FINSI;
      |FINSI;
  |FINSI;

  |SI #1#19 ! 0;
      |SI #1#23 ! "00.00.0000"; |Y #1#23 < #0#3;
          dias = #1#23 - ultcon;
      |SINO;
          dias = #0#3 - ultcon;
      |FINSI;
      |SI dias [ 0;  |O dias > diasanyo;
          mensaje = "     ATENCION!!  ERROR EN FECHAS AMORTIZACION EN ELEMENTO "
          trab1 = #1#0;
          mensaje = mensaje + trab1 + "/";
          trab1 = #1#1;
          mensaje = mensaje + trab1;
          || ... |MENAV mensaje;
          |ACABA;
      |FINSI;

      |SI #1#16 = "N";
          cuotamor = ((#1#7 * #1#17) / 100) ! EURODB;
          amorcon = ((dias * cuotamor) / diasanyo) ! EURODB;
      |SINO;
          |SI #1#16 = "D";
              |HAZ degrcont;
          |SINO;
              |HAZ acelcont;
          |FINSI;
      |FINSI;
  |FINSI;
  |DDEFECTO #2;
  |SI #1#7 > 0;
      |SI #1#13 < amorfis;  amorfis = #1#13;  |FINSI;
      |SI #1#19 < amorcon;  amorcon = #1#19;  |FINSI;
  |SINO;
      |SI #1#13 > amorfis;  amorfis = #1#13;  |FINSI;
      |SI #1#19 > amorcon;  amorcon = #1#19;  |FINSI;
  |FINSI;

  #1#12 = #1#12 + amorfis;
  #1#13 = #1#13 - amorfis;
  #1#18 = #1#18 + amorcon;
  #1#19 = #1#19 - amorcon;
  |SI #1#13 ! 0;
      |SI #1#23 ! "00.00.0000";
          |SI #1#23 [ #0#3;
             || amorfis = amorfis + #1#13;
             || #1#12 = #1#12 + #1#13;
              #1#13 = 0;
          |FINSI;
      |SINO;
          |SI topfisc [ #0#3;
              amorfis = amorfis + #1#13;
              #1#12 = #1#12 + #1#13;
              #1#13 = 0;
          |FINSI;
      |FINSI;
  |FINSI;
  |SI #1#19 ! 0;
      |SI #1#23 ! "00.00.0000";
          |SI #1#23 [ #0#3;
             || amorcon = amorcon + #1#19;
             || #1#18 = #1#18 + #1#19;
              #1#19 = 0;
          |FINSI;
      |SINO;
          |SI topcont [ #0#3;
              amorcon = amorcon + #1#19;
              #1#18 = #1#18 + #1#19;
              #1#19 = 0;
          |FINSI;
      |FINSI;
  |FINSI;
  #2#0 = #1#0;
  #2#1 = #1#1;
  #2#2 = ultlin + 1;
  #2#3 = #0#2;
  #2#4 = "A";
  #2#5 = amorfis;
  #2#6 = "N";
  #2#7 = #0#3;
  #2#8 = #0#4;
  #2#9 = amorcon;
  |GRABA 021#2n;
  || |SI #1#23 ! "00.00.0000"; ya lo hemos puesto a cero antes
  ||     #1#13 = 0;
  ||     #1#19 = 0;
  || |FINSI;
  |GRABA 040#1a;
  |LIBERA #1;
|FPRC;

|DEFBUCLE cacalamo0;
 #1#1;
 ;
 #0#0,00;
 #0#1,99;
 be;
 NULL, calcula;
|FIN;

|PROCESO null;
     linea = linea + 1;
|FPRC;

|PROCESO haztodo;
 enEmpresa = #canempre#2;
 enPeriodo = #canempre#3;
 swOperacion = 0;
 |SUB_EJECUTA "camoneda";

  |PATH_DAT #1  dirfich0;
  |PATH_DAT #2  dirfich0;

  |ATRI R;
    |ATRI R;
    |PINTA 2213, #30#2;
    |PINTA 2219, #30#3;
    |PINTA 2221, #30#1;
    |ATRI 0;

  |ATRI 0

  |ABRET #2;
  diasanyo = 365;
  |SI #0#2 = 1980;  |O #0#2 = 1984;  |O #0#2 = 1988;  |O #0#2 = 1992;
                    |O #0#2 = 1996;  |O #0#2 = 2000;  |O #0#2 = 2004;
                    |O #0#2 = 2008;  |O #0#2 = 2012;  |O #0#2 = 2016;
      diasanyo = 366;
  |FINSI;
  |BUCLE cacalamo0;
  |CIERRAT #2;
|FPRC;
