|FICHEROS;
  cacierre #0;
  camaasil #1;    || apuntes lins.
  camaasic #2;    || apuntes cabs.
  catracie #4;    || trabajo cierre
  caconcep #7;    || conceptos
  caexistc #22;   || Cabeceras de Existencias

  caconcic #50;
  caconcil #51;
  camocabe #60;
  camoline #61;

  Referen1@ #600;
  Referen2@ #601;
  Referen3@ #602;
  Referen4@ #603;
|FIN;

|VARIABLES;
   &entrada = 1;

   VAlfa1 = "";
   VAlfa2 = "";
   VAlfa3 = "";
   VAlfa4 = "";
   VAlfa5 = "";
   swexis = 0;

    jaleo = 0;

    alfa1 = "";
    alfa2 = "";
    pp = 0;
    cam = 0;
    linea = 0;
    avisillo = "";
    cuenta = "";
    cuen = "";
    xxxxfiac = "  ";
    xxaponer = "  ";
    xrelleno = "                              ";
    fecalf = "";
    men2   = "    NO EXISTE CONCEPTO AUTOMATICO";
    mensa1 = "    ERROR ESTA FECHA NO CORRESPONDE AL EJERCICIO";

    desde = "            ";
    hasta = "zzzzzzzzzzzz";
    fich = "";
    no_sigas = 0;
    cierre = "";
    apertu = "";
    d_diari = 0;
    d_opera = "";
    d_impor = 0;
    d_tipos = 0;
    FEstado = 0;
    nPOrigen = 0;
    swalg    = 0;

    Comodin  = "";
    Comodin1 = "";
    Comodin2 = "";
    Calc     = 0;
    nCont    = 0;
|FIN;

|INCLUYE acceso_i;
|INCLUYE conasi_i;
|INCLUYE copian_i;
|INCLUYE dsmone_i;


|PROGRAMA;

  |CLS;
  |CABEZA "Cierre Ejercicio";

  |PINPA #0#0;
  |DDEFECTO #0;
  |PINDA #0#0;
  |HAZ apertu;
  |HAZ leeempre;
  |SI no_sigas ! 0;  |ACABA;  |FINSI;
  |ENDATOS #1#0;
  |SI FSalida = 0;
      |HAZ cierre;
      |HAZ apertura;
      |HAZ copiaantes;
  |FINSI;
|FPRO;

|PROCESO apertu;         || calcula el periodo de la empresa nueva
  |HAZ inicio;
  cierre = #30#0;  cierre = "000000" + cierre;  cierre = cierre % -106;
  cod2 = #30#3;
  nPOrigen = cod2;
  #0#10 = cod1;
  #0#11 = cod2 + 1;
  |SI #0#11 = 10;  #0#11 = 0;  |FINSI;
  |PINTA #0#10;
  |PINTA #0#11;
  #0#0 = fec2;
  #0#5 = #0#0 + 1;
  |PINTA #0#0;
  |PINTA #0#5;
  aMonedaC = eaMoneda;
|FPRC;

|PROCESO leeempre;       || lee la empresa
  jaleo = 0;
  cod1 = #0#10;
  cod2 = #0#11;
  |HAZ leelo;
  |SI swerror = 1;
      |HAZ creacion;
      swOperacion = 1;
      |SI no_sigas = 1; |ACABA; |FINSI;
  |SINO;
      swOperacion = 0;
      enEmpresa = #0#10;
      enPeriodo = #0#11;
      |SUB_EJECUTA_NP "camoneda";
  |FINSI;
  |BLIN 23;
  |BLIN 24;
  apertu = #30#0;  apertu = "000000" + apertu;  apertu = apertu % -106;
  #0#12 = #30#1;
  |PINTA #0#12;
  aMonedaA = eaMoneda;
|FPRC;

*****************************************************************************
               CALCULOS DESDE CAMPOS
*****************************************************************************
|PROCESO mayor;
  #0Campo = #0Campo > "  ";
  |PINTA #0Campo;
|FPRC;
|PROCESO entrada; |TIPO 0;         || desde campo 'fecha de cierre'
  |HAZ contador;
  #0#3 = #20#1;
  #0#4 = #0#3;
  |PINTA #0#3;
  |PINTA #0#4;
|FPRC;

|PROCESO repite; |TIPO 0;          || desde campo 'documento'
  pp = Campo + 1;
  #0pp = #0Campo;
  |PINTA #0pp;
|FPRC;

|PROCESO concepto; |TIPO 0;        || desde campo 'concepto'
  |ABRE #7;
  #7#0 = #0Campo;
  |LEE 001#7=;
  |SI FSalida ! 0;
      |MENAV men2;
      |DDEFECTO #7;
      |CIERRA #7;
      |ERROR;
      |ACABA;
  |FINSI;
  pp = Campo + 1;
  #0pp = #7#1;
  |PINTA #0pp;
  |CIERRA #7;
|FPRC;

|PROCESO final; |TIPO 7;
|PTEC 816;
|FPRC;

*****************************************************************************
               CALCULOS DE CIERRE
*****************************************************************************

|PROCESO buscalibre;
  #1#0 = #2#0;
  #1#1 = #2#1;
  #1#2 = #2#2;
  #1#3 = 9999;
  |LEE 001#1];
  |SI FSalida ! 0;
      |LEE 001#1u;
  |SINO;
      |LEE 001#1a;
  |FINSI;
  |SI FSalida ! 0;
      linea = 1;
  |SINO;
      |SI #1#0 = #2#0; |Y #1#1 = #2#1; |Y #1#2 = #2#2;
          linea = #1#3 + 1;
      |SINO;
          linea = 1;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO grabadia;
  |SI cam = 0;
      cam = 1;
      #2#0 = 99;
      #2#1 = #0#0;
      #2#2 = #0#3;
      |LIBERA #2;
      |LEE 101#2=;
      |SI FSalida ! 0;
          |DDEFECTO #2;
          #2#0 = 99;
          #2#1 = #0#0;
          #2#2 = #0#3;
          #2#3 = #0#3;
          |GRABA 020#2b;
      |FINSI;
      |HAZ buscalibre;
  |FINSI;
  #1#0 = #2#0;
  #1#1 = #2#1;
  #1#2 = #2#2;
  #1#3 = linea;
  #1#4 = #6#0;
  #1#5 = #6#1;
  #1#6 = #0#1;
  #1#7 = #0#2;
  |SI #6#53 [ 0;
      #1#8 = "D";
      #1#9 = -#6#53;
  |SINO;
      #1#8 = "H";
      #1#9 = #6#53;
  |FINSI;
  |SI #1#8 = "D";
      #1#16 = #1#4;
      #1#17 = #1#5;
      #1#10 = "";
      #1#11 = 0;
  |SINO;
      #1#16 = "";
      #1#17 = 0;
      #1#10 = #1#4;
       #1#11 = #1#5;
  |FINSI;
  |GRABA 020#1n;
  linea = linea + 1;

  d_diari = #1#0;
  d_opera = #1#8;
  d_impor = #1#9;
  d_tipos = 1;
  |HAZ actu_diari;

  |SI #1#8 = "D";
      #2#4 = #2#4 + #1#9;
      |SI #2#09 = 0; #2#08 = #1#4; #2#09 = #1#5; |FINSI;      || contrp.HABER
  |SINO;
      #2#5 = #2#5 + #1#9;
      |SI #2#11 = 0; #2#10 = #1#4; #2#11 = #1#5; |FINSI;      || contrp.DEBE
  |FINSI;
  |GRABA 020#2a;
|FPRC;

|PROCESO grabacion;
  #4#0 = #6#0;
  #4#1 = #6#1;
  #4#2 = #6#58;
  |SI #6#53 [ 0;
      #4#3 = "H";
      #4#4 = -#6#53;
  |SINO;
      #4#3 = "D";
      #4#4 = #6#53;
  |FINSI;
  #4#5 = #6#2;
  #4#6 = #6#3;
  #4#7 = #6#4;
  #4#8 = #6#5;
  #4#9 = #6#6;
  #4#10 = #6#7;
  #4#11 = #6#8;
  #4#12 = #6#54;
  #4#13 = #6#55;
  |GRABA 020#4n;
|FPRC;

|PROCESO acerar;
  |SI #6#53 [ 0;
      #6#48 = -#6#53;
      #6#51 = #6#51 - #6#53;
  |SINO;
      #6#49 = #6#49 + #6#53;
      #6#52 = #6#52 + #6#53;
  |FINSI;
  #6#50 = #6#48 - #6#49;
  #6#53 = #6#51 - #6#52;
  |GRABA 020#6a;
  |LIBERA #6;
|FPRC;

|PROCESO aceroplan;
  avisillo = "2301 Asiento de Cierre, Tratando: " + #6#0;
  |MENSA avisillo;
  |HAZ grabacion;
  |SI #6#53 ! 0;
      |SI #6#3 = "S";
          |HAZ grabadia;
      |FINSI;
      |HAZ acerar;
  |FINSI;
|FPRC;

|DEFBUCLE cacierre0;
 #6#1;
 ;
 desde, 0;
 hasta, 9;
 be;
 NULL, aceroplan;
|FIN;

|PROCESO cierre;
  eaMoneda = aMonedaC;
  |HAZ MoCierre;      ||Carga Variables Moneda

  |DBASE dir_fich;
  dir_fich = dir_fich + "fich/" + cierre + "/";
  |PATH_DAT #1 dir_fich;
  |PATH_DAT #2 dir_fich;
  |PATH_DAT #6 dir_fich;
  |PATH_DAT #4 dir_fich;
  |PATH_DAT #18 dir_fich;
  |DELINDEX #4;
  |ABRE #1;
  |ABRE #2;
  |ABRE #4;
  |ABRE #18;
  cam = 0;
  |BUCLE cacierre0;
  |CIERRA #1;
  |CIERRA #2;
  |CIERRA #4;
  |CIERRA #18;
|FPRC;

*****************************************************************************
               CALCULOS DE APERTURA
*****************************************************************************

|PROCESO leeape;
  avisillo = "2301 Asiento de Apertura, Tratando: " + #4#0;
  |MENSA avisillo;
  |SI aMonedaC ! aMonedaA;
      impMoneda = #4#4;
      |HAZ ElCambioMoneda;
      #4#4= impMoneda;
  |FINSI;
  |HAZ grabacuen;                    || actualiza cuenta
  |SI #4#4 ! 0; |Y #4#6 = "S";
      |HAZ grabaaper;                || graba apunte
  |FINSI;
|FPRC;

|DEFBUCLE cacierre1;
 #4#1;
 ;
 desde, 0;
 hasta, 9;
 be;
 NULL, leeape;
|FIN;

|PROCESO grabacuen;
  #6#0 = #4#0;
  #6#1 = #4#1;
  |LEE 101#6=;
  |SI FSalida ! 0;
      |DDEFECTO #6;
      #6#0 = #4#0;
      #6#1 = #4#1;
      |GRABA 020#6b;
  |FINSI;
  #6#58 = #4#2;
  |SI #4#3 = "D";
      #6#9 = #4#4;
      #6#51 = #6#51 + #4#4;
  |SINO;
      #6#10 = #4#4;
      #6#52 = #6#52 + #4#4;
  |FINSI;
  #6#0 = #4#0;
  #6#1 = #4#1;
  #6#11 = #6#9 - #6#10;
  #6#53 = #6#51 - #6#52;
  #6#2 = #4#5;
  #6#3 = #4#6;
  #6#4 = #4#7;
  #6#5 = #4#8;
  #6#6 = #4#9;
  #6#7 = #4#10;
  #6#8 = #4#11;
  #6#54 = #4#12;
  #6#55 = #4#13;
  |GRABA 020#6a;
  |LIBERA #6;
|FPRC;

|PROCESO lee_descarga1;
  |SI #1#8 = "D";     #19#11 = #1#9;  |FINSI;
  |SI #1#8 = "H";     #19#11 = -#1#9; |FINSI;

  |GRABAENDEF VAlfa2, VAlfa3, 0,#19#0, 1,#19#1, 2,#19#2, 3,#19#3, 4,#19#4, 5,#19#5, 6,#19#6, 7,#19#7, 8,#19#8, 9,#19#9, 10,#19#10, 11,#19#11;
  |SI swexis = 0;
      |ABRE #22;
      |DDEFECTO #22;
      #22#0 = #19#0;
      |LEE 001#22=;
      |GRABAENDEF VAlfa4, VAlfa5, 0,#22#0, 1,#22#1, 2,#22#2, 3,#22#3;
      swexis = 1;
      |CIERRA #22;
  |FINSI;
||  |GRABA 020#19a;
||  |LIBERA #19;
|FPRC;

|DEFBUCLE lee_descarga;
 #19#2;
 ;
 #0#13, #1#4, #1#5;
 #0#13, #1#4, #1#5;
 ;
 NULL, lee_descarga1;
|FIN;

|PROCESO buscaaper;
  #1#0 = #2#0;
  #1#1 = #2#1;
  #1#2 = #2#2;
  #1#3 = 9999;
  |LEE 001#1];
  |SI FSalida ! 0;
      |LEE 001#1u;
  |SINO;
      |LEE 001#1a;
  |FINSI;
  |SI FSalida ! 0;
      linea = 1;
  |SINO;
      |SI #1#0 = #2#0; |Y #1#1 = #2#1; |Y #1#2 = #2#2;
          linea = #1#3 + 1;
      |SINO;
          linea = 1;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO grabaaper;
  |SI cam = 0;
      cam = 1;
      #2#0 = 0;
      #2#1 = #0#5;
      #2#2 = #0#8;
      |LIBERA #2;
      |LEE 101#2=;
      |SI FSalida ! 0;
          |DDEFECTO #2;
          #2#0 = 0;
          #2#1 = #0#5;
          #2#2 = #0#8;
          #2#3 = #0#8;
          |GRABA 020#2b;
      |FINSI;
      |HAZ buscaaper;
  |FINSI;
  #1#0 = #2#0;
  #1#1 = #2#1;
  #1#2 = #2#2;
  #1#3 = linea;
  #1#4 = #4#0;
  #1#5 = #4#1;
  #1#6 = #0#6;
  #1#7 = #0#7;
  #1#8 = #4#3;
  #1#9 = #4#4;
  |SI #1#8 = "D";
      #1#16 = #1#4;
      #1#17 = #1#5;
      #1#10 = "";
      #1#11 = 0;
  |SINO;
      #1#16 = "";
      #1#17 = 0;
      #1#10 = #1#4;
      #1#11 = #1#5;
  |FINSI;
  |SI #0#14 = "S";
      #1#18 = "û";
  |SINO;
      #1#18 = " ";
  |FINSI;
  |GRABA 020#1n;
  linea = linea + 1;

  |BUCLE lee_descarga;

  d_diari = #1#0;
  d_opera = #1#8;
  d_impor = #1#9;
  d_tipos = 2;
  |HAZ actu_diari;

  |SI #1#8 = "D";
      #2#4 = #2#4 + #1#9;
      |SI #2#09 = 0; #2#08 = #1#4; #2#09 = #1#5; |FINSI;      || contrp.HABER
  |SINO;
      #2#5 = #2#5 + #1#9;
      |SI #2#11 = 0; #2#10 = #1#4; #2#11 = #1#5; |FINSI;      || contrp.DEBE
  |FINSI;
  |GRABA 020#2a;
|FPRC;

|PROCESO apertura;

  eaMoneda = aMonedaA;
  |HAZ MoCierre;      ||Carga Variables Moneda

  |DBASE dir_fich;
  dir_fich = dir_fich + "fich/" + apertu + "/";
  |PATH_DAT #1 dir_fich;
  |PATH_DAT #2 dir_fich;
  |PATH_DAT #6 dir_fich;
  |PATH_DAT #18 dir_fich;
  |PATH_DAT #50 dir_fich;
  |PATH_DAT #51 dir_fich;
  |PATH_DAT #60 dir_fich;
  |PATH_DAT #61 dir_fich;

  |DDEF VAlfa1; |QBF VAlfa1;
  VAlfa2 = VAlfa1 + "caexistl";
  VAlfa3 = dir_fich + "caexistl";
  VAlfa4 = VAlfa1 + "caexistc";
  VAlfa5 = dir_fich + "caexistc";
  swexis = 0;
 || ..............................  |PATH_DAT #19 dir_fich;
  |ABRE #1;
  |ABRE #2;
  |ABRE #6;
  |ABRE #18;
  cam = 0;
  |BUCLE cacierre1;
  |CIERRA #1;
  |CIERRA #2;
  |CIERRA #6;
  |CIERRA #18;
  |DELINDEX #4;
|FPRC;

*****************************************************************************
               CALCULOS DE CREACION DE LA EMPRESA
*****************************************************************************

|PROCESO creacion;
  no_sigas = 0;
  |CONFI "2400S Realizar Creacion de Empresa de Apertura: ";
  |SI FSalida = 0;
      |HAZ empresa;
      swOperacion = 1;
      enEmpresa = #0#10;
      enPeriodo = #0#11;
      |SUB_EJECUTA_NP "camoneda";
      |HAZ jaleo;
  |SINO;
      no_sigas = 1;
  |FINSI;
|FPRC;

|PROCESO empresa;             || da de alta la empresa y crea el directorio
  |DBASE dir_fich;
  dir_fich=dir_fich + "fich/";
  |PATH_DAT #30 dir_fich;
  |ABRE #30;
  #30#2 = #0#10;
  #30#3 = #0#11;
/*
  #30#3 = #0#11 - 1;
  |SI #0#11 = -1;  #30#3 = 9;  |FINSI;
*/
  |LEE 001#30=;
  ||SI FSalida = 0;
  |SI FSalida ! 0;
      #30#0 = (#0#10 * 10) + #0#11;
      #30#2 = #0#10;
      #30#3 = #0#11;
      #30#26 = #30#26 + 1;                 || suma un a¤o
      |SI #30#26 = 100;  #30#26 = 0;  |FINSI;  || a¤o cero
      |GRABA 020#30n;
      |SI FSalida = 0;
          |DBASE alfa1;
          alfa2 = #30#0;  alfa2 = "000000" + alfa2;  alfa2 = alfa2 % -106;
          alfa1 = alfa1 + "fich/" + alfa2;
          |MKDIR alfa1;
      |FINSI;
  |FINSI;
  |CIERRA #30;
|FPRC;

|PROCESO copiaantes;
  |DFICE dir_fich;
  |DBASE fich;
  alfa2 = #30#0;
  alfa2 = "000000" + alfa2;
  alfa2 = alfa2 % -106;
  fich = fich + "fich/" + alfa2 + "/";

  fich_copi = dir_fich;
  fich_alta = fich;

  |SI #0#14 = "S";
      traba1 = "caconcic";  |HAZ copiando;    || cabeceras diferencias
      traba1 = "caconcil";  |HAZ copiando;    || lineas diferencias
      |HAZ CambioConc;
  |FINSI;

  |SI #0#15 = "S";
       |SI jaleo = 1;
           traba1 = "camocabe";  |HAZ copiando;    || cabeceras amortizaciones
           traba1 = "camoline";  |HAZ copiando;    || lineas amortizaciones
           |HAZ CambioAmor;
       |SINO;
           |HAZ CopiaAmort;
       |FINSI;
  |FINSI;

  |SI #0#16 = "S";
      traba1 = "caclipro";  |HAZ copiando;    || Clientes/Proveedores
  |FINSI;
|FPRC;

|PROCESO jaleo;          || copia los ficheros

  num_por = #30#2;
  any_por = #30#26;
  |DFICE dir_fich;
  |DBASE fich;
  alfa2 = #30#0;
  alfa2 = "000000" + alfa2;
  alfa2 = alfa2 % -106;
  fich = fich + "fich/" + alfa2 + "/";

  fich_copi = dir_fich;
  fich_alta = fich;

  |HAZ copia_maes;
  |HAZ acerar4;
  |HAZ pone0_maes;
  jaleo = 1;
|FPRC;

|| **************************************************************
|PROCESO actu_diari;
  #18#0 = d_diari;
  |LEE 101#18=;
  |SI FSalida ! 0;
      |DDEFECTO #18;
      #18#0 = d_diari;
      |SI d_tipos = 1;  #18#1 = "DIARIO DE CIERRE  ";  |FINSI;
      |SI d_tipos = 2;  #18#1 = "DIARIO DE APERTURA";  |FINSI;
      |GRABA 020#18n;
      |LEE 121#18=;
  |FINSI;
  |SI d_opera = "D";
      #18#2 = #18#2 + d_impor;        || debe
  |SINO;
      #18#3 = #18#3 + d_impor;        || haber
  |FINSI;
  |GRABA 020#18a;
  |LIBERA #18;
|FPRC;

|| ********************************************************************

|PROCESO borrarlo;
  avisillo = "2301 Actualizando Diferencias, Tratando: " + #caconcil#0;
  |MENSA avisillo;
  |SI #caconcil#8 ! " ";
      |BORRA 020#caconcil.a;
  |SINO;
      |SI aMonedaC ! aMonedaA;
          impMoneda = #caconcil#6; |HAZ ElCambioMoneda; #caconcil#6= impMoneda;
          impMoneda = #caconcil#7; |HAZ ElCambioMoneda; #caconcil#7= impMoneda;
          |GRABA 020#caconcil.a;
      |FINSI;
  |FINSI;
  |LIBERA #caconcil;
|FPRC;

|DEFBUCLE borrar_a;
 #caconcil#1;
 4;
 desde, 0, 001, "01.01.1900";
 hasta, 9, 999, "31.12.2090";
 be;
 NULL, borrarlo;
|FIN;

|| *********************************************************************

|PROCESO leelineas;
 swalg = 1;
 |ERROR10;
|FPRC;

|PROCESO borrar_cab;
 swalg = 0;
 |BUCLELIN 2leelineas#caconcic;
 |SI swalg = 0;
     |BORRA 020#caconcic.a;
 |SINO;
     |SI aMonedaC ! aMonedaA;
         impMoneda = #caconcic#4; |HAZ ElCambioMoneda; #caconcic#4 = impMoneda;
         |GRABA 020#caconcic.a;
     |FINSI;
 |FINSI;
 |LIBERA #caconcic;
|FPRC;

|DEFBUCLE borrar_c;
 #caconcic#1;
 ;
 desde, 0;
 hasta, 9;
 be;
 NULL, borrar_cab;
|FIN;

|PROCESO CambioConc;
  |BUCLE borrar_a;  ||Bucle para repasar Diferencias
  |BUCLE borrar_c;  ||Recalculo de Cabeceras
|FPRC;

|| ********************************************************************
|PROCESO C2Amor0;
  avisillo = "2301 Actualizando Amortizaciones, Tratando: " + #camoline#0;
  |MENSA avisillo;
  impMoneda = #camoline#5; |HAZ ElCambioMoneda; #camoline#5= impMoneda;
  impMoneda = #camoline#9; |HAZ ElCambioMoneda; #camoline#9= impMoneda;
  #camoline#10 = #camoline#9 - #camoline#5;

  |GRABA 020#camoline.a;
  |LIBERA #camoline;
|FPRC;

|PROCESO C1Amor0;
  avisillo = "2301 Actualizando Amortizaciones, Tratando: " + #camocabe#0;
  |MENSA avisillo;
  impMoneda = #camocabe#7; |HAZ ElCambioMoneda; #camocabe#7= impMoneda;
  impMoneda = #camocabe#12; |HAZ ElCambioMoneda; #camocabe#12= impMoneda;
  impMoneda = #camocabe#13; |HAZ ElCambioMoneda; #camocabe#13= impMoneda;
  impMoneda = #camocabe#18; |HAZ ElCambioMoneda; #camocabe#18= impMoneda;
  impMoneda = #camocabe#19; |HAZ ElCambioMoneda; #camocabe#19= impMoneda;
  |GRABA 020#camocabe.a;
  |LIBERA #camocabe;
|FPRC;

|DEFBUCLE C2Amor;
 #camoline#1;
 ;
 "        ", 00,000;
 "zzzzzzzz", 99,999;
 be;
 NULL, C2Amor0;
|FIN;

|DEFBUCLE C1Amor;
 #camocabe#1;
 ;
 "        ", 00;
 "zzzzzzzz", 99;
 be;
 NULL, C1Amor0;
|FIN;

|PROCESO CambioAmor;
  |SI aMonedaC ! aMonedaA;
      |BUCLE C1Amor;
      |BUCLE C2Amor;
  |FINSI;
|FPRC;



|| ***************************************
|PROCESO BorraAct;
   |BORRA 020#Referen4@.a; |LIBERA #Referen4@;
|FPRC;

|DEFBUCLE BorraAct;
#Referen4@#1003;
;
#Referen3@#0,#Referen3@#1,001;
#Referen3@#0,#Referen3@#1,999;
be;
NULL,BorraAct;
|FIN;

|PROCESO LineasAmort;
  #Referen4@#0 = #Referen2@#0;
  #Referen4@#1 = #Referen2@#1;
  #Referen4@#2 = #Referen2@#2;
  |LEE 101#Referen4@.=;
  |SI FSalida ! 0;
      Comodin = "|NC";
      Calc = #Referen2@#Comodin# - 1;
      |PARA nCont = 0; |SI nCont [ Calc; |HACIENDO nCont = nCont + 1;
            #Referen4@#nCont# = #Referen2@#nCont#;
      |SIGUE;
      |SI aMonedaC ! aMonedaA;
         impMoneda = #603#5; |HAZ ElCambioMoneda; #603#5 = impMoneda;
         impMoneda = #603#9; |HAZ ElCambioMoneda; #603#9 = impMoneda;
         #603#10 = #603#9 - #603#5;
      |FINSI;

      |GRABA 020#Referen4@.b;
   |FINSI;
   |LIBERA #Referen4@;
|FPRC;

|DEFBUCLE LineasAmort;
 #Referen2@#1003;
 ;
 #Referen1@#0,#Referen1@#1,001;
 #Referen1@#0,#Referen1@#1,999;
 be;
 NULL,LineasAmort;
|FIN;

|PROCESO Amortiz;

  #Referen3@#0 = #Referen1@#0;
  #Referen3@#1 = #Referen1@#1;
  |LEE 101#Referen3@.=;
  |SI FSalida ! 0;
      Comodin = "|NC";
      Calc = #Referen1@#Comodin# - 1;
      |PARA nCont = 0; |SI nCont [ Calc; |HACIENDO nCont = nCont + 1;
            #Referen3@#nCont# = #Referen1@#nCont#;
      |SIGUE;
      |SI aMonedaC ! aMonedaA;
         impMoneda = #602#7;  |HAZ ElCambioMoneda; #602#7= impMoneda;
         impMoneda = #602#12; |HAZ ElCambioMoneda; #602#12= impMoneda;
         impMoneda = #602#13; |HAZ ElCambioMoneda; #602#13= impMoneda;
         impMoneda = #602#18; |HAZ ElCambioMoneda; #602#18= impMoneda;
         impMoneda = #602#19; |HAZ ElCambioMoneda; #602#19= impMoneda;
      |FINSI;

      |GRABA 020#Referen3@.b;
   |FINSI;

   |BUCLE LineasAmort;

   |LIBERA #Referen3@;
|FPRC;

|DEFBUCLE Amortiz;
 #Referen1@#1002;
 ;
 "        ",00;
 "zzzzzzzz",99;
 be;
 NULL,Amortiz;
|FIN;

|PROCESO CopiaAmort;
   Comodin = fich_copi; |QBF Comodin;
   Comodin1 = Comodin % -107;
   Comodin = Comodin - Comodin1;  || Le quitamos el directorio de empresa
   Comodin = Comodin - "fich/";
   Comodin1 = Comodin + "def/camocabe.mas";
   Comodin2 = Comodin + "def/camoline.mas";

   |CARGA_DEF Comodin1, Referen1@;
   |SI FSalida = 0;
       |PATH_DAT #600 fich_copi;
       |CARGA_DEF Comodin2, Referen2@;
       |SI FSalida = 0;
           |PATH_DAT #601 fich_copi;
           |CARGA_DEF Comodin1, Referen3@;
           |SI FSalida = 0;
               |PATH_DAT #602 fich_alta;
               |CARGA_DEF Comodin2, Referen4@;
               |SI FSalida = 0;
                   |PATH_DAT #603 fich_alta;
                   |ABRE #602;
                   |ABRE #603;
                   |BUCLE Amortiz;
                   |CIERRA #603;
                   |CIERRA #602;
                   |DESCARGA_DEF #Referen4@;
               |FINSI;
               |DESCARGA_DEF #Referen3@;
           |FINSI;
           |DESCARGA_DEF #Referen2@;
       |FINSI;
       |DESCARGA_DEF #Referen1@;
   |FINSI;
|FPRC;
