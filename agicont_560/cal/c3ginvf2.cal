|FICHEROS;
    c3ginvf2 #0;
    camocabe #1;
    camoline #2;
    camogrup #3;
    cainftmp #4;
|FIN;

|VARIABLES;
    fecsys = @;
    &entrada = 1;
    &ulti    = "";
    informe  = "cainvfin";
    bueno    = 0;
    &amor    = 0;
    &resid   = 0;
    &lintot  = 0;
    &linnor  = 0;
    &linant  = 0;
    &totval  = 0;
    &totamo  = 0;
    &totano  = 0;
    &totres  = 0;
    &linanyo = 0;
    &anyo1   = 0;
    &anyo2   = 0;
    &anyo3   = 0;
    &anyo4   = 0;
    &anyo5   = 0;
    &anyo6   = 0;
    &anyo7   = 0;
    &anyo8   = 0;
    &a1      = 0;
    &a2      = 0;
    &a3      = 0;
    &a4      = 0;
    &a5      = 0;
    &a6      = 0;
    &a7      = 0;
    &a8      = 0;
    &t1      = 0;
    &t2      = 0;
    &t3      = 0;
    &t4      = 0;
    &t5      = 0;
    &t6      = 0;
    &t7      = 0;
    &t8      = 0;
    nombre = "";
    alfa1 = "";
    alfa2 = "";
    &am_ti = "CONTABLE";
    &fec = @;
    sw_error = 0;
    i_cm1 = 8;  || Campo Desde/Hasta Empresa
|FIN;

|INCLUYE acceso_i;
|INCLUYE puntos_i;
|INCLUYE numamo_i;
|INCLUYE multie_i;

|| ************************************************************************
|PROCESO numamo; |TIPO 0;
    x_alfa1 = #0Campo;
|HAZ x_punto;
    #0Campo = x_alfa1;
    |PINTA #0Campo;
|FPRC;

|PROCESO mayor;
  alfa1 = #0Campo > " ";
  #0Campo = alfa1;
  |PINTA #0Campo;
|FPRC;

|PROCESO cuenta; |TIPO 0;
    p_alfa1 = #0Campo;
    salidas = FSalida;
|HAZ punto;
|SI p_error ! 0;  |ERROR;  |ACABA;  |FINSI;
|FPRC;

|PROCESO defecto; |TIPO 7;
    fecsys = fec2; || fecsys = ~;
    alfa1 = fecsys;
    alfa1 = alfa1 % -104;
    #0Campo = alfa1;
|PINTA #0Campo;
|FPRC;

|PROCESO tipo8;  |TIPO 8;
  |HAZ inicio;
  any = #30#26;
  |HAZ coloca;
|FPRC;

|| ************************************************************************
|PROCESO sel_multi;
|| |SI #30#26 ! any;  |ACABA; |FINSI;
  |SI #30#21 = "I"; |ACABA; |FINSI;
  sw_error = 0;
  leidos = 1;
|FPRC;

|| ---------- Seleccion DESDE / HASTA Empresa.
|PROCESO esdesd1;
  alfa1 = #30#2;
  alfa2 = #30#3;
  alfa1 = "00000" + alfa1;   alfa1 = alfa1 % -105;
  alfa2 = "0"   + alfa2;   alfa2 = alfa2 % -101;
  dirfich0 = dir_fich + alfa1 + alfa2 + "/";

  sw_error = 0;
  leidos = 0;
  |HAZ sel_multi;
  |SI leidos = 1; |Y sw_error = 0;
      |HAZ haztodo;
  |FINSI;
|FPRC;

|DEFBUCLE esdesde;
 #30#1;
 ;
 d_empres, d_period;
 h_empres, h_period;
 e;
 NULL,esdesd1;
|FIN;

|| ---------- Seleccion en parrilla.
|PROCESO esunaauna;
  |PARA xx = i_cm6; |SI xx [ i_cm7; |HACIENDO xx = xx + 1;
        |SI #0xx = 0;  |SAL;  |FINSI;
        yy = xx + 20;
        alfa1 = #0xx;
        alfa2 = #0yy;

        || ... lee empresa
           |ABRE #30;
           |DDEFECTO #30;
           #30#2 = #0xx;
           #30#3 = #0yy;
           |LEE 011#30=;
           |CIERRA #30;
           leidos = 0; sw_error = 0;
           |HAZ sel_multi;
           |SI leidos = 0; |O sw_error ! 0; |VETE otramas; |FINSI;
        || ...................

        alfa1 = "00000" + alfa1;   alfa1 = alfa1 % -105;
        alfa2 = "0"     + alfa2;   alfa2 = alfa2 % -101;
        dirfich0 = dir_fich + alfa1 + alfa2 + "/";

        |HAZ haztodo;
 |ET otramas;
  |SIGUE;
|FPRC;
|| *************************************************************************

|PROCESO graba_tmp;
  |SI #0#6 = "N";
      |SI #1#22 = "N"; |ACABA; |FINSI;
  |FINSI;
   || graba la cuenta de cabecera
      |SI #1#3 ] #0#0; |Y #1#3 [ #0#1;
          #4#0 = #1#3;
          #4#1 = #1#4;
          #4#2 = #1#0;
          #4#3 = #1#1;
          |GRABA 021#4n;
          |LIBERA #4;
      |FINSI;
|FPRC;

|DEFBUCLE carga_tmp;
#1#1;
3;
#0#2,00,#0#0;
#0#3,99,#0#1;
e;
NULL , graba_tmp;
|FIN;

|PROCESO acumano;
  |SI #2#4 = "A";
      |SI anyo1 = #2#3; a1 = a1 + #2#9; |FINSI;
      |SI anyo2 = #2#3; a2 = a2 + #2#9; |FINSI;
      |SI anyo3 = #2#3; a3 = a3 + #2#9; |FINSI;
      |SI anyo4 = #2#3; a4 = a4 + #2#9; |FINSI;
      |SI anyo5 = #2#3; a5 = a5 + #2#9; |FINSI;
      |SI anyo6 = #2#3; a6 = a6 + #2#9; |FINSI;
      |SI anyo7 = #2#3; a7 = a7 + #2#9; |FINSI;
      |SI anyo8 ] #2#3; a8 = a8 + #2#9; |FINSI;
      |SI #2#3 [ anyo1;
          resid = resid - #2#9;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO fechafac;
#1#0 = #4#2;
#1#1 = #4#3;
|LEE 001#1=;
|SI FSalida = 0;
  |SI bueno ! 0;          || si es primera vez imprime cabeceras solo
      |SI #1#3 ! ulti;
          lintot = 1;     || imprime linea de totales
          |PRINT;
          |HAZ poncero;
          lintot = 0;
          linant = 0;
          linnor = 1;     || imprime primera linea de cuenta
      |SINO;
          lintot = 0;
          linnor = 0;
          linant = 1;     || imprime siguientes lineas de misma cuenta
      |FINSI;
  |SINO;
      lintot = 0;
      linnor = 1;
      linant = 0;
  |FINSI;
  bueno = 1;
  ulti = #1#3;               || Cod. de Cuenta;
  a1 = 0;  a2 = 0;  a3 = 0;  a4 = 0;  a5 = 0;  a6 = 0;  a7 = 0;  a8 = 0;
  amor  = #1#18;
  resid = #1#7;
  |BUCLELIN 2acumano#1;
  |PRINT;
  totval = totval + #1#7;   || acumula valor inicial;
  totamo = totamo + amor;   || acumula amortizacion;
  t1 = t1 + a1;              || acumula amortizacion en a¤o final;
  t2 = t2 + a2;              || acumula amortizacion en a¤o -1;
  t3 = t3 + a3;              || acumula amortizacion en a¤o -2;
  t4 = t4 + a4;              || acumula amortizacion en a¤o -3;
  t5 = t5 + a5;              || acumula amortizacion en a¤o -4;
  t6 = t6 + a6;              || acumula amortizacion en a¤o -5;
  t7 = t7 + a7;              || acumula amortizacion en a¤o -6;
  t8 = t8 + a8;              || acumula amortizacion en a¤o -7;
  totres = totres + resid;   || acumula valor residual;
  lintot = 0;
  linnor = 0;
  linant = 0;
|FINSI;
|FPRC;

|DEFBUCLE cainvfin0;
#4#1;
;
#0#0,0,#0#2,00;
#0#1,9,#0#3,99;
e;
NULL,fechafac;
|FIN;

|| **********************************************************************
|PROCESO impre; |TIPO 3;
  nombre = "fin" + Usuario;
  nombre = nombre % 108;
  |QBF nombre;
  |NOME_DAT #4 nombre;

  anyo1 = #0#5;
  anyo2 = #0#5-1;
  anyo3 = #0#5-2;
  anyo4 = #0#5-3;
  anyo5 = #0#5-4;
  anyo6 = #0#5-5;
  anyo7 = #0#5-6;
  anyo8 = #0#5-7;
  fec = #0#4;

  |IMPRE 0;
  |SI FSalida ! 0;  |ACABA;  |FINSI;
  |INFOR informe;
  |SI FSalida ! 0; |FINIMP; |ACABA; |FINSI;

  |SI #0i_cm1 = "S";
      |BUCLE esdesde;
  |SINO;
      |HAZ esunaauna;
  |FINSI;
  |FININF;
  |FINIMP;
|FPRC;
|| ................................................................

|PROCESO haztodo;
  enEmpresa = #canempre#2;
  enPeriodo = #canempre#3;
  swOperacion = 0;
  |SUB_EJECUTA "camoneda.tab";

  |PATH_DAT #1 dirfich0;
  |PATH_DAT #2 dirfich0;
  |PATH_DAT #3 dirfich0;

  |ABRE #4;
  |CIERRA #4;
  |DELINDEX #4;

  |HAZ poncero;
  |ABRE #4;
  |ABRE #3;
  |BUCLE carga_tmp;
  |CIERRA #4;
  |CIERRA #3;

  bueno = 0;
  |ABRE #1;
  |BUCLE cainvfin0;
  |CIERRA #1;
  |SI bueno = 1;
      lintot = 1;
      |PRINT;
      |PIEINF;
  |FINSI;
  |DELINDEX #4;
|FPRC;

|PROCESO poncero;
  totval = 0;
  totamo = 0;
  t1 = 0;
  t2 = 0;
  t3 = 0;
  t4 = 0;
  t5 = 0;
  t6 = 0;
  t7 = 0;
  t8 = 0;
  totres = 0;
|FPRC;
