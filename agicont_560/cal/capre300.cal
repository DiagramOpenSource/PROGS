|FICHEROS;
    capre300 #0;
    caiva300 #1;         || control iva
    caman300 #2;         || man. 300
    caivarep #4;         || repercutido
    caivasop #5;         || soportado
    cacon300 #7;         || conceptos IVA
    caportad #8;         || portada modelos
    caw00004 #99;        || Acumulador 300 Anteriores.
|FIN;

|INCLUYE acceso_i;
|INCLUYE tempo_i;

|VARIABLES;
    temporal1 = ""; traba1 = ""; dirfich0 = "";
    temporal2 = ""; traba2 = "";

    cont     = 0;
    trime    = 0;
    anyo     = 0;
    activi   = "";
    compen   = 0;
    base     = 0;
    tipo     = 0;
    total    = 0;
    rendi1   = 0;
    rendi2   = 0;
    penult   = 0;
    estado   = 0;
    ventas   = 0;
    x        = 0;
    camp     = 0;
    xxxxfiac = "  ";
    xxaponer = "  ";
    xrelleno = "                              ";
    modo = 0;
    t_ivasop = 0;
    FEstado= 0;
    per_ant = -1;
    x1 = 0;
    x2 = 0;
    x3 = 0;
    x4 = 0;
    x5 = 0;
    perio = 0;
    peria = 0;
    any   = 0;
    emp   = "";
    emp1  = "";
    FConcep = 0;
    tot_iva = 0;
    tot_bas = 0;
    &compens = 0;

    trim1 = @;
    trim2 = @;
    trim3 = @;
    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    antes1 = 0;
    antes2 = 0;
    antes3 = 0;
    antes4 = 0;
    antes5 = 0;
    antes6 = 0;
    antes11 = 0;
    antes12 = 0;
    antes13 = 0;
    antes14 = 0;
    antes15 = 0;
    antes16 = 0;

    sw_exi = 0;
    &a_emp = 0;
    &a_per = 0;
    &ac_pe = 0;

   frase_d     = "";
   informado_d = "";
   Linea1      = "";
   Linea2      = "";
   Linea3      = "";
   swyacal = 0;

   nHPeriodo = 0;
   nSw300    = 0;
|FIN;

|PROCESO copiando;
temporal1 = dirfich0 + "/" + traba1 + ".dat";
temporal2 = dirfich0 + "/" + traba2 + ".dat";
|COPIA_FICHERO temporal1,temporal2;
|SI FSalida ! 0; |ACABA; |FINSI;
temporal1 = dirfich0 + "/" + traba1 + ".ixx";
temporal2 = dirfich0 + "/" + traba2 + ".ixx";
|COPIA_FICHERO temporal1,temporal2;
|SI FSalida ! 0; |ACABA; |FINSI;
temporal1 = dirfich0 + "/" + traba1 + ".ddx";
temporal2 = dirfich0 + "/" + traba2 + ".ddx";
|COPIA_FICHERO temporal1,temporal2;
|SI FSalida ! 0; |ACABA; |FINSI;
|FPRC;

|PROCESO defecto; |TIPO 7;
  #0#0 = #8#93;
  #0#1 = 1;
  #0#2 = 1;
  |PINDA #0#0;
|FPRC;

|PROCESO totales; |TIPO 3;
#2#20 = #2#7 + #2#10 + #2#13 + #2#16 + #2#19 + #2#48 + #2#50;
#2#25 = #2#21 + #2#22 + #2#23 + #2#24 + #2#43 + #2#44 + #2#51 + #2#58;
#2#26 = #2#20 - #2#25;
#2#35 = #2#54;
#2#52 = #2#49;
#2#42 = #2#5  + #2#8  + #2#11;
#2#42 = #2#42 + #2#34 + #2#35 + #2#36 + #2#37 + #2#38 + #2#39
#2#42 = #2#42 - #2#40 - #2#41;

total = #2#28 - #2#29 - #2#30;
|SI total = 0;
    #2#33 = 0;
    #2#31 = 0;
    #2#32 = 0;
|FINSI;
|SI total > 0;
    #2#33 = total;
    #2#31 = 0;
    #2#32 = 0;
|SINO;         ||total negativo
    total = total * (-1);
    #2#33 = 0;
    #2#32 = total;
    #2#31 = 0;
    |SI #8#71 = "D";
        |SI #2#45 = "T"; |Y #2#1 = 4;
            #2#32 = 0;
            #2#31 = total;
        |FINSI;
        |SI #2#45 = "M"; |Y #2#1 = 12;
            #2#32 = 0;
            #2#31 = total;
        |FINSI;
        |SI #2#45 = "A";
            #2#32 = 0;
            #2#31 = total;
        |FINSI;
    |FINSI;
    |PINTA #2#31;
    |PINTA #2#32;
    |PINTA #2#33;
|FINSI;
|FPRC;

|PROCESO totaliza_300;
    #2#20 = #2#07+#2#10+#2#13+#2#16+#2#19+#2#48+#2#50;      || t. devengado
    #2#25 = #2#21+#2#22+#2#51+#2#23+#2#24+#2#43+#2#44+#2#58;|| t. deducible
    #2#26 = #2#20-#2#25;                                    || diferencia
    #2#28 = #2#26%#2#27;                                    || atribuible
    #2#31 = 0;
    #2#32 = 0;
    #2#33 = 0;
|SI #2#28 > 0;
        #2#33 = #2#28;                  || a ingresar
|FINSI;
|SI #2#28 < 0;
        #2#32 = #2#28;                  || a compensar
|FINSI;
|SI #2#28 < 0;
        #2#31 = #2#28;                  || a devolver
|FINSI;
   |HAZ totales;
|FPRC;

|PROCESO recargo;
    x1 = 0;  x2 = 0;  x3 = 0;  x4 = 0;  x5 = 0;
|SI #4#17 = #1#4;   x1 = 14;  |FINSI;
|SI #4#17 = #1#5;   x1 = 17;  |FINSI;
|SI #4#17 = #1#6;   x1 = 46;  |FINSI;

|SI #4#18 = #1#4;   x2 = 14;  |FINSI;
|SI #4#18 = #1#5;   x2 = 17;  |FINSI;
|SI #4#18 = #1#6;   x2 = 46;  |FINSI;

|SI #4#19 = #1#4;   x3 = 14;  |FINSI;
|SI #4#19 = #1#5;   x3 = 17;  |FINSI;
|SI #4#19 = #1#6;   x3 = 46;  |FINSI;

|SI #4#58 = #1#4;   x4 = 14;  |FINSI;
|SI #4#58 = #1#5;   x4 = 17;  |FINSI;
|SI #4#58 = #1#6;   x4 = 46;  |FINSI;

|SI #4#59 = #1#4;   x5 = 14;  |FINSI;
|SI #4#59 = #1#5;   x5 = 17;  |FINSI;
|SI #4#59 = #1#6;   x5 = 46;  |FINSI;

|SI x1 ! 0;
    #2x1 = #2x1 + #4#08;                     || base 1
    x1 = x1 + 1;    #2x1 = #4#17;            || (%) rec. 1
    x1 = x1 + 1;    #2x1 = #2x1 + #4#20;     || cuota rec. 1
|FINSI;
|SI x2 ! 0;
    #2x2 = #2x2 + #4#09;                     || base 2
    x2 = x2 + 1;    #2x2 = #4#18;            || (%) rec. 2
    x2 = x2 + 1;    #2x2 = #2x2 + #4#21;     || cuota rec. 2
|FINSI;
|SI x3 ! 0;
    #2x3 = #2x3 + #4#10;                     || base 3
    x3 = x3 + 1;    #2x3 = #4#19;            || (%) rec. 3
    x3 = x3 + 1;    #2x3 = #2x3 + #4#22;     || cuota rec. 3
|FINSI;
|SI x4 ! 0;
    #2x4 = #2x4 + #4#52;                     || base 4
    x4 = x4 + 1;    #2x4 = #4#58;            || (%) rec. 4
    x4 = x4 + 1;    #2x4 = #2x4 + #4#60;     || cuota rec. 4
|FINSI;
|SI x5 ! 0;
    #2x5 = #2x5 + #4#53;                     || base 5
    x5 = x5 + 1;    #2x5 = #4#59;            || (%) rec. 5
    x5 = x5 + 1;    #2x5 = #2x5 + #4#61;     || cuota rec. 5
|FINSI;
|FPRC;

|PROCESO iva_rep;
    x1 = 0;  x2 = 0;  x3 = 0;  x4 = 0;  x5 = 0;
|SI #4#11 = #1#1;   x1 =  5;  |FINSI;
|SI #4#11 = #1#2;   x1 =  8;  |FINSI;
|SI #4#11 = #1#3;   x1 = 11;  |FINSI;

|SI #4#12 = #1#1;   x2 =  5;  |FINSI;
|SI #4#12 = #1#2;   x2 =  8;  |FINSI;
|SI #4#12 = #1#3;   x2 = 11;  |FINSI;

|SI #4#13 = #1#1;   x3 =  5;  |FINSI;
|SI #4#13 = #1#2;   x3 =  8;  |FINSI;
|SI #4#13 = #1#3;   x3 = 11;  |FINSI;

|SI #4#54 = #1#1;   x4 =  5;  |FINSI;
|SI #4#54 = #1#2;   x4 =  8;  |FINSI;
|SI #4#54 = #1#3;   x4 = 11;  |FINSI;

|SI #4#55 = #1#1;   x5 =  5;  |FINSI;
|SI #4#55 = #1#2;   x5 =  8;  |FINSI;
|SI #4#55 = #1#3;   x5 = 11;  |FINSI;

|SI x1 ! 0;
    #2x1 = #2x1 + #4#08;                     || base 1
    x1 = x1 + 1;    #2x1 = #4#11;            || (%) iva 1
    x1 = x1 + 1;    #2x1 = #2x1 + #4#14;     || cuota iva 1
|FINSI;
|SI x2 ! 0;
    #2x2 = #2x2 + #4#09;                     || base 2
    x2 = x2 + 1;    #2x2 = #4#12;            || (%) iva 2
    x2 = x2 + 1;    #2x2 = #2x2 + #4#15;     || cuota iva 2
|FINSI;
|SI x3 ! 0;
    #2x3 = #2x3 + #4#10;                     || base 3
    x3 = x3 + 1;    #2x3 = #4#13;            || (%) iva 3
    x3 = x3 + 1;    #2x3 = #2x3 + #4#16;     || cuota iva 3
|FINSI;
|SI x4 ! 0;
    #2x4 = #2x4 + #4#52;                     || base 4
    x4 = x4 + 1;    #2x4 = #4#54;            || (%) iva 4
    x4 = x4 + 1;    #2x4 = #2x4 + #4#56;     || cuota iva 4
|FINSI;
|SI x5 ! 0;
    #2x5 = #2x5 + #4#53;                     || base 5
    x5 = x5 + 1;    #2x5 = #4#55;            || (%) iva 5
    x5 = x5 + 1;    #2x5 = #2x5 + #4#57;     || cuota iva 5
|FINSI;
#2#42 = #2#42 + #4#8 + #4#9 + #4#10 + #4#52 + #4#53;
|FPRC;

|PROCESO iva_sop;
    t_ivasop = #5#14+#5#15+#5#16+#5#20+#5#21+#5#22+#5#56+#5#57+#5#60+#5#61; || suma recargo
      |SI #5#23 = "S";
          |SI #5#48 = "S";
               #2#43 = #2#43 + t_ivasop;   || operaciones interiores inversiones
          |SINO;
               #2#21 = #2#21 + t_ivasop;   || operaciones interiores corrientes
          |FINSI;
      |FINSI;
|FPRC;

|PROCESO per_sopor1;
|SI #2#45 = "A"; #5#44 = 1; |FINSI;
|SI #2#45 = "T";
    alfa1 = #5#3;   alfa1 = alfa1 % -104;      || saca a¤o
    alfa2 = "31.03." + alfa1;  trim1 = alfa2;  || primer trimestre
    alfa2 = "30.06." + alfa1;  trim2 = alfa2;  || segundo trimestre
    alfa2 = "30.09." + alfa1;  trim3 = alfa2;  || tercer trimestre
    |SI #5#3 [ trim1;                   #5#44 = 1;  |FINSI;
    |SI #5#3 > trim1;|Y #5#3 [ trim2;   #5#44 = 2;  |FINSI;
    |SI #5#3 > trim2;|Y #5#3 [ trim3;   #5#44 = 3;  |FINSI;
    |SI #5#3 > trim3;                   #5#44 = 4;  |FINSI;
|FINSI;
|SI #2#45 = "M";
    alfa1 = #5#3;  alfa1 = alfa1 % 402;      || saca mes
    #5#44 = alfa1;
|FINSI;
|GRABA 020#5a;
|LIBERA #5;
|FPRC;

|DEFBUCLE per_sopor;
 #5#1;
 ;
  1,      1, "  ";
 99, 999999, "zz";
 be;
 NULL, per_sopor1;
|FIN;

|PROCESO per_reper1;
|SI #2#45 = "A"; #4#44 = 1; |FINSI;
|SI #2#45 = "T";
    alfa1 = #4#3;   alfa1 = alfa1 % -104;      || saca a¤o
    alfa2 = "31.03." + alfa1;  trim1 = alfa2;  || primer trimestre
    alfa2 = "30.06." + alfa1;  trim2 = alfa2;  || segundo trimestre
    alfa2 = "30.09." + alfa1;  trim3 = alfa2;  || tercer trimestre
    |SI #4#3 [ trim1;                   #4#44 = 1;  |FINSI;
    |SI #4#3 > trim1;|Y #4#3 [ trim2;   #4#44 = 2;  |FINSI;
    |SI #4#3 > trim2;|Y #4#3 [ trim3;   #4#44 = 3;  |FINSI;
    |SI #4#3 > trim3;                   #4#44 = 4;  |FINSI;
|FINSI;
|SI #2#45 = "M";
    alfa1 = #4#3;  alfa1 = alfa1 % 402;      || saca mes
    #4#44 = alfa1;
|FINSI;

|GRABA 020#4a;
|LIBERA #4;
|FPRC;

|DEFBUCLE per_reper;
 #4#1;
 ;
  1,      1, "  ";
 99, 999999, "zz";
 be;
 NULL, per_reper1;
|FIN;

|PROCESO acum_rep;
     tot_bas = #4#8  + #4#9  + #4#10 + #4#52 + #4#53; ||Total bases
     tot_iva = #4#14 + #4#15 + #4#16 + #4#56 + #4#57; || Total IVA
     tot_iva = tot_iva + #4#20 + #4#21 + #4#22 + #4#60 + #4#61; || + recargo

     |SI #7#2 = 2;  ||Adq Intracomunitarias
         #2#49 = #2#49 + tot_bas;          ||base intracomunitario
         #2#50 = #2#50 + tot_iva;
         |SI #7#1 = 3;
             |SI #4#48 = "N"; #2#51 = #2#51 + tot_iva; |FINSI;
             |SI #4#48 = "S"; #2#58 = #2#58 + tot_iva; |FINSI;
         |FINSI;
         #2#52 = #2#52 + tot_bas;
     |FINSI;

     |SI #7#2 = 3;       ||Entrada Intracomunitaria
         #2#54 = #2#54 + tot_bas;
         #2#35 = #2#35 + tot_bas;
     |FINSI;

     |SI #7#2 = 4;       ||Operaciones Regimen Simplificado
         #2#34 = #2#34 + tot_bas;
     |FINSI;

     |SI #7#2 = 5;       ||Op. AGyP
         #2#38 = #2#38 + tot_bas;
     |FINSI;

     |SI #7#2 = 6;       ||Recargo de equivalencia
         #2#39  = #2#39 + tot_bas;
     |FINSI;

     |SI #7#2 = 7;       ||Operaciones sujetas 91
         #2#59  = #2#59 + tot_bas;
     |FINSI;

     |SI #7#2 = 8;       ||Exportaciones y otras con derecho a deduccion
         #2#36 = #2#36 + tot_bas;
     |FINSI;

     |SI #7#2 = 9;       ||Op Exentas sin derecho a deduccion
         #2#37 = #2#37 + tot_bas;
     |FINSI;

     |SI #7#2 = 10;      ||Entrega bienes inmuebles
         #2#40 = #2#40 + tot_bas;
     |FINSI;

     |SI #7#2 = 11;      ||Ventas a distancia no sujetas
         #2#53 = #2#53 + tot_bas;
     |FINSI;

     |SI #7#2 = 12;      ||Entrega bienes objetos de otros estados miembros
         #2#56 = #2#56 + tot_bas;
     |FINSI;

     |SI #7#2 = 13;      ||Entregas Interiores de Bienes
         #2#57 = #2#57 + tot_bas;
     |FINSI;

     |SI #7#2 = 14;      ||Entrega bienes de inversion
          #2#41 = #2#41 + tot_bas;
     |FINSI;
|FPRC;

|PROCESO reper1;
     |SI #4#44 < perio; |Y #4#28 = "S";
         |ACABA;
     |FINSI;

     |SI per_ant ! perio;
         |HAZ cierra_300;
         |HAZ abre_300;
         per_ant = perio;
     |FINSI;

     |PINTA 2045, #caivarep#0;
     |PINTA 2048, #caivarep#27;
     |PINTA 2051, #caivarep#2;

     #7#0 = #4#6;
     |LEE 001#7=;
     |SI FSalida = 0;
         |SI #7#2 = 1; |O #7#2 = 0;
             |HAZ iva_rep;
             |HAZ recargo;
         |SINO;
             |SI #7#2 = 14; |O #7#2 = 10;
                 |HAZ iva_rep;
                 |HAZ recargo;
             |FINSI;
             |HAZ acum_rep;
         |FINSI;
     |SINO;
         |HAZ iva_rep;
         |HAZ recargo;
     |FINSI;

     #4#28 = "S";
     #4#44 = perio;
     |GRABA 020#4a;
|FPRC;

|DEFBUCLE reper;
     #4#1;
     44;
     0,       0 , "  ", peria;
     99, 999999 , "zz", perio;
     e;
     NULL, NULL, NULL, NULL, NULL, reper1;
     #4#44, #4#0, #4#2, #4#27;    || ordena por periodo
|FIN;

|PROCESO sopor1;

 |SI #5#44 < perio; |Y #5#28 = "S";
     |ACABA;
 |FINSI;
 |SI per_ant ! perio;
    |HAZ cierra_300;
    |HAZ abre_300;
    per_ant = perio;
 |FINSI;

     |PINTA 2045, #caivasop#0;
     |PINTA 2048, #caivasop#27;
     |PINTA 2051, #caivasop#2;

 #7#0 = #5#6;
 |LEE 001#7=;
 |SI FSalida = 0;
     |SI #7#1 ! 9;
         |HAZ acum_sop;
     |FINSI;
 |SINO;
     |HAZ iva_sop;
 |FINSI;
 #5#28= "S";
 #5#44= perio;
 |GRABA 020#5a;
|FPRC;

|PROCESO acum_sop;
     tot_iva = #5#14 + #5#15 + #5#16 + #5#56 + #5#57; || no suma recargo.
     tot_bas = #5#8 + #5#10 + #5#9 + #5#52 + #5#53;
     |SI #5#23 = "S";
          |SI #5#48 = "N";         ||Si no es de inversion
               |HAZ noinver;
          |SINO;         ||SI es de inversiones
               |HAZ inver;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO inver;
     |SI #7#1 = 5;
          #2#24 = #2#24 + tot_iva;
     |SINO;
          |SI #7#1 = 6;       ||Op. Interiores Inversiones
               #2#43 = #2#43 + tot_iva;
          |SINO;
               |SI #7#1 = 7;  ||Importaciones Inversiones
                    #2#44 = #2#44 + tot_iva;
               |SINO;
                    |SI #7#1 = 8; || Entregas Intracomunitarias
                         #2#54 = #2#54 - tot_bas;
                         #2#35 = #2#35 - tot_bas;
                    |SINO;
                         |SI #7#1 = 3;
                             #2#58 = #2#58 + tot_iva;
                             |SI #7#2 = 2;
                                 #2#49 = #2#49 + tot_bas;          ||base intracomunitario
                                 #2#50 = #2#50 + tot_iva;
                                 #2#52 = #2#52 + tot_bas;
                             |FINSI;
                         |SINO;
                             #2#24 = #2#24 + tot_iva;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO noinver;
     |SI #7#1 = 1;       ||Operaciones Corrientes
          #2#21 = #2#21 + tot_iva;
     |SINO;
          |SI #7#1 = 2;  ||Importaciones
               #2#22 = #2#22 + tot_iva;
          |SINO;
               |SI #7#1 = 3;  ||Adj. Intracomunitaria
                    #2#51 = #2#51 + tot_iva;
                    |SI #7#2 = 2;
                        #2#49 = #2#49 + tot_bas;          ||base intracomunitario
                        #2#50 = #2#50 + tot_iva;
                        #2#52 = #2#52 + tot_bas;
                    |FINSI;
               |SINO;
                    |SI #7#1 = 4;  ||Regimen AGp
                         #2#23 = #2#23 + tot_iva;
                    |SINO;
                         |SI #7#1 = 8;  ||Entrega intracom
                              #2#54 = #2#54 - tot_bas;
                              #2#35 = #2#35 - tot_bas;
                         |SINO;
                              #2#21 = #2#21 + tot_iva;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE sopor;
 #5#1;
 44;
  0,      1, "  ", peria;
 99, 999999, "zz", perio;
 e;
 NULL, NULL, NULL, NULL, NULL, sopor1;
 #5#44, #5#0, #5#2, #5#27;    || ordena por periodo
|FIN;

 ************************************************************************
 PROCESOS DE COMPENSACIONES CON MODELOS 300 ANTERIORES
 ************************************************************************

|PROCESO AcumulaReper;
     tot_bas = #4#8    + #4#9  + #4#10 + #4#52 + #4#53;         ||Total bases
     tot_iva = #4#14   + #4#15 + #4#16 + #4#56 + #4#57;         || Total IVA
     tot_iva = tot_iva + #4#20 + #4#21 + #4#22 + #4#60 + #4#61; || + recargo

     |SI #7#2 = 2;  ||Adq Intracomunitarias
         #99#49 = #99#49 + tot_bas;          ||base intracomunitario
         #99#50 = #99#50 + tot_iva;
         |SI #7#1 = 3;
             |SI #4#48 = "N"; #99#51 = #99#51 + tot_iva; |FINSI;
             |SI #4#48 = "S"; #99#58 = #99#58 + tot_iva; |FINSI;
         |FINSI;
         #99#52 = #99#52 + tot_bas;
     |FINSI;

     |SI #7#2 = 3;       ||Entrada Intracomunitaria
         #99#54 = #99#54 + tot_bas;
         #99#35 = #99#35 + tot_bas;
     |FINSI;

     |SI #7#2 = 4;       ||Operaciones Regimen Simplificado
         #99#34 = #99#34 + tot_bas;
     |FINSI;

     |SI #7#2 = 5;       ||Op. AGyP
         #99#38 = #99#38 + tot_bas;
     |FINSI;

     |SI #7#2 = 6;       ||Recargo de equivalencia
         #99#39  = #99#39 + tot_bas;
     |FINSI;

     |SI #7#2 = 7;       ||Operaciones sujetas 91
         #99#59  = #99#59 + tot_bas;
     |FINSI;

     |SI #7#2 = 8;       ||Exportaciones y otras con derecho a deduccion
         #99#36 = #99#36 + tot_bas;
     |FINSI;

     |SI #7#2 = 9;       ||Op Exentas sin derecho a deduccion
         #99#37 = #99#37 + tot_bas;
     |FINSI;

     |SI #7#2 = 10;      ||Entrega bienes inmuebles
         #99#40 = #99#40 + tot_bas;
     |FINSI;

     |SI #7#2 = 11;      ||Ventas a distancia no sujetas
         #99#53 = #99#53 + tot_bas;
     |FINSI;

     |SI #7#2 = 12;      ||Entrega bienes objetos de otros estados miembros
         #99#56 = #99#56 + tot_bas;
     |FINSI;

     |SI #7#2 = 13;      ||Entregas Interiores de Bienes
         #99#57 = #99#57 + tot_bas;
     |FINSI;

     |SI #7#2 = 14;      ||Entrega bienes de inversion
          #99#41 = #99#41 + tot_bas;
     |FINSI;
|FPRC;

|PROCESO IvaRecargo;
     x1 = 0;  x2 = 0;  x3 = 0;  x4 = 0;  x5 = 0;

     |SI #4#17 = #1#4;   x1 = 14;  |FINSI;
     |SI #4#17 = #1#5;   x1 = 17;  |FINSI;
     |SI #4#17 = #1#6;   x1 = 46;  |FINSI;

     |SI #4#18 = #1#4;   x2 = 14;  |FINSI;
     |SI #4#18 = #1#5;   x2 = 17;  |FINSI;
     |SI #4#18 = #1#6;   x2 = 46;  |FINSI;

     |SI #4#19 = #1#4;   x3 = 14;  |FINSI;
     |SI #4#19 = #1#5;   x3 = 17;  |FINSI;
     |SI #4#19 = #1#6;   x3 = 46;  |FINSI;

     |SI #4#58 = #1#4;   x4 = 14;  |FINSI;
     |SI #4#58 = #1#5;   x4 = 17;  |FINSI;
     |SI #4#58 = #1#6;   x4 = 46;  |FINSI;

     |SI #4#59 = #1#4;   x5 = 14;  |FINSI;
     |SI #4#59 = #1#5;   x5 = 17;  |FINSI;
     |SI #4#59 = #1#6;   x5 = 46;  |FINSI;

     |SI x1 ! 0;
         #99x1 = #99x1 + #4#08;                     || base 1
         x1 = x1 + 1;    #99x1 = #4#17;            || (%) rec. 1
         x1 = x1 + 1;    #99x1 = #99x1 + #4#20;     || cuota rec. 1
     |FINSI;

     |SI x2 ! 0;
         #99x2 = #99x2 + #4#09;                     || base 2
         x2 = x2 + 1;    #99x2 = #4#18;            || (%) rec. 2
         x2 = x2 + 1;    #99x2 = #99x2 + #4#21;     || cuota rec. 2
     |FINSI;

     |SI x3 ! 0;
         #99x3 = #99x3 + #4#10;                     || base 3
         x3 = x3 + 1;    #99x3 = #4#19;            || (%) rec. 3
         x3 = x3 + 1;    #99x3 = #99x3 + #4#22;     || cuota rec. 3
     |FINSI;

     |SI x4 ! 0;
         #99x4 = #99x4 + #4#52;                     || base 4
         x4 = x4 + 1;    #99x4 = #4#58;            || (%) rec. 4
         x4 = x4 + 1;    #99x4 = #99x4 + #4#60;     || cuota rec. 4
     |FINSI;

     |SI x5 ! 0;
         #99x5 = #99x5 + #4#53;                     || base 5
         x5 = x5 + 1;    #99x5 = #4#59;            || (%) rec. 5
         x5 = x5 + 1;    #99x5 = #99x5 + #4#61;     || cuota rec. 5
     |FINSI;
|FPRC;

|PROCESO IvaRepercutido;
     x1 = 0;  x2 = 0;  x3 = 0;  x4 = 0;  x5 = 0;

     |SI #4#11 = #1#1;   x1 =  5;  |FINSI;
     |SI #4#11 = #1#2;   x1 =  8;  |FINSI;
     |SI #4#11 = #1#3;   x1 = 11;  |FINSI;

     |SI #4#12 = #1#1;   x2 =  5;  |FINSI;
     |SI #4#12 = #1#2;   x2 =  8;  |FINSI;
     |SI #4#12 = #1#3;   x2 = 11;  |FINSI;

     |SI #4#13 = #1#1;   x3 =  5;  |FINSI;
     |SI #4#13 = #1#2;   x3 =  8;  |FINSI;
     |SI #4#13 = #1#3;   x3 = 11;  |FINSI;

     |SI #4#54 = #1#1;   x4 =  5;  |FINSI;
     |SI #4#54 = #1#2;   x4 =  8;  |FINSI;
     |SI #4#54 = #1#3;   x4 = 11;  |FINSI;

     |SI #4#55 = #1#1;   x5 =  5;  |FINSI;
     |SI #4#55 = #1#2;   x5 =  8;  |FINSI;
     |SI #4#55 = #1#3;   x5 = 11;  |FINSI;

     |SI x1 ! 0;
         #99x1 = #99x1 + #4#08;                     || base 1
         x1 = x1 + 1;    #99x1 = #4#11;             || (%) iva 1
         x1 = x1 + 1;    #99x1 = #99x1 + #4#14;     || cuota iva 1
     |FINSI;

     |SI x2 ! 0;
         #99x2 = #99x2 + #4#09;                     || base 2
         x2 = x2 + 1;    #99x2 = #4#12;             || (%) iva 2
         x2 = x2 + 1;    #99x2 = #99x2 + #4#15;      || cuota iva 2
     |FINSI;

     |SI x3 ! 0;
         #99x3 = #99x3 + #4#10;                     || base 3
         x3 = x3 + 1;    #99x3 = #4#13;            || (%) iva 3
         x3 = x3 + 1;    #99x3 = #99x3 + #4#16;     || cuota iva 3
     |FINSI;

     |SI x4 ! 0;
         #99x4 = #99x4 + #4#52;                     || base 4
         x4 = x4 + 1;    #99x4 = #4#54;            || (%) iva 4
         x4 = x4 + 1;    #99x4 = #99x4 + #4#56;     || cuota iva 4
     |FINSI;

     |SI x5 ! 0;
         #99x5 = #99x5 + #4#53;                     || base 5
         x5 = x5 + 1;    #99x5 = #4#55;            || (%) iva 5
         x5 = x5 + 1;    #99x5 = #99x5 + #4#57;     || cuota iva 5
     |FINSI;

     #99#42 = #99#42 + (#99#8 + #99#9 + #99#10 + #99#52 + #99#53);
|FPRC;

|PROCESO Repercutido;
     #7#0 = #4#6;
     |LEE 001#7=;
     |SI FSalida = 0;
         |SI #7#2 = 1; |O #7#2 = 0;
             |HAZ IvaRepercutido;
             |HAZ IvaRecargo;
         |SINO;
             |SI #7#2 = 14; |O #7#2 = 10;
                 |HAZ IvaRepercutido;
                 |HAZ IvaRecargo;
             |FINSI;
             |HAZ AcumulaReper;
         |FINSI;
     |SINO;
         |HAZ IvaRepercutido;
         |HAZ IvaRecargo;
     |FINSI;
|FPRC;

|DEFBUCLE caivarep;
     #4#1;
     44;
     0,       0 , "  ",         1;
     99, 999999 , "zz", nHPeriodo;
     e;
     NULL, NULL, NULL, NULL, NULL, Repercutido;
     #4#44, #4#0, #4#2, #4#27;    || ordena por periodo
|FIN;

|PROCESO SiInversion;
     |SI #7#1 = 5;
          #99#24 = #99#24 + tot_iva;
     |SINO;
          |SI #7#1 = 6;       ||Op. Interiores Inversiones
               #99#43 = #99#43 + tot_iva;
          |SINO;
               |SI #7#1 = 7;  ||Importaciones Inversiones
                    #99#44 = #99#44 + tot_iva;
               |SINO;
                    |SI #7#1 = 8; || Entregas Intracomunitarias
                         #99#54 = #99#54 - tot_bas;
                         #99#35 = #99#35 - tot_bas;
                    |SINO;
                         |SI #7#1 = 3;
                             #99#58 = #99#58 + tot_iva;
                             |SI #7#2 = 2;
                                 #99#49 = #99#49 + tot_bas;          ||base intracomunitario
                                 #99#50 = #99#50 + tot_iva;
                                 #99#52 = #99#52 + tot_bas;
                             |FINSI;
                         |SINO;
                             #99#24 = #99#24 + tot_iva;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO NoInversion;
     |SI #7#1 = 1;       ||Operaciones Corrientes
          #99#21 = #99#21 + tot_iva;
     |SINO;
          |SI #7#1 = 2;  ||Importaciones
               #99#22 = #99#22 + tot_iva;
          |SINO;
               |SI #7#1 = 3;  ||Adj. Intracomunitaria
                    #99#51 = #99#51 + tot_iva;
                    |SI #7#2 = 2;
                        #99#49 = #99#49 + tot_bas;          ||base intracomunitario
                        #99#50 = #99#50 + tot_iva;
                        #99#52 = #99#52 + tot_bas;
                    |FINSI;
               |SINO;
                    |SI #7#1 = 4;  ||Regimen AGp
                         #99#23 = #99#23 + tot_iva;
                    |SINO;
                         |SI #7#1 = 8;  ||Entrega intracom
                              #99#54 = #99#54 - tot_bas;
                              #99#35 = #99#35 - tot_bas;
                         |SINO;
                              #99#21 = #99#21 + tot_iva;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO AcumulaSopor;
     tot_iva = #5#14 + #5#15 + #5#16 + #5#56 + #5#57; || no suma recargo.
     tot_bas = #5#8 + #5#10 + #5#9 + #5#52 + #5#53;
     |SI #5#23 = "S";
          |SI #5#48 = "N";         ||Si no es de inversion
               |HAZ NoInversion;
          |SINO;         ||SI es de inversiones
               |HAZ SiInversion;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO IvaSoportado;
     t_ivasop = #5#14+#5#15+#5#16+#5#20+#5#21+#5#22+#5#56+#5#57+#5#60+#5#61; || suma recargo
     |SI #5#23 = "S";
         |SI #5#48 = "S";
             #99#43 = #99#43 + t_ivasop;   || operaciones interiores inversiones
         |SINO;
             #99#21 = #99#21 + t_ivasop;   || operaciones interiores corrientes
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Soportado;
     #7#0 = #5#6;
     |LEE 001#7=;
     |SI FSalida = 0;
         |SI #7#1 ! 9;
             |HAZ AcumulaSopor;
         |FINSI;
     |SINO;
         |HAZ IvaSoportado;
     |FINSI;
|FPRC;

|DEFBUCLE caivasop;
     #5#1;
     44;
      0,      1, "  ",         1;
     99, 999999, "zz", nHPeriodo;
     e;
     NULL, NULL, NULL, NULL, NULL, Soportado;
     #5#44, #5#0, #5#2, #5#27;    || ordena por periodo
|FIN;

|PROCESO Descarga300;
     #99#5  = #99#5  - #2#5;    #99#7  = #99#7  - #2#7;
     #99#8  = #99#8  - #2#8;    #99#10 = #99#10 - #2#10;
     #99#11 = #99#11 - #2#11;   #99#13 = #99#13 - #2#13;
     #99#14 = #99#14 - #2#14;   #99#16 = #99#16 - #2#16;
     #99#17 = #99#17 - #2#17;   #99#19 = #99#19 - #2#19;
     #99#21 = #99#21 - #2#21;
     #99#22 = #99#22 - #2#22;
     #99#23 = #99#23 - #2#23;
     #99#24 = #99#24 - #2#24;
     #99#34 = #99#34 - #2#34;
     #99#35 = #99#35 - #2#35;
     #99#36 = #99#36 - #2#36;
     #99#37 = #99#37 - #2#37;
     #99#38 = #99#38 - #2#38;
     #99#39 = #99#39 - #2#39;
     #99#40 = #99#40 - #2#40;
     #99#41 = #99#41 - #2#41;
     #99#42 = #99#42 - #2#42;
     #99#43 = #99#43 - #2#43;
     #99#44 = #99#44 - #2#44;
     #99#46 = #99#46 - #2#46;
     #99#48 = #99#48 - #2#48;
     #99#49 = #99#49 - #2#49;
     #99#50 = #99#50 - #2#50;
     #99#51 = #99#51 - #2#51;
     #99#52 = #99#52 - #2#52;
     #99#53 = #99#53 - #2#53;
     #99#56 = #99#56 - #2#56;
     #99#57 = #99#57 - #2#57;
     #99#58 = #99#58 - #2#58;
     #99#59 = #99#59 - #2#59;
|FPRC;

|DEFBUCLE caman300;
     #2#1;
     ;
     activi,         1, any;
     activi, nHPeriodo, any;
     ;
     NULL, Descarga300;
|FIN;

|PROCESO lee_ant;
     compens = 0;
 |SI perio = 1;
     |HAZ lee_any_a;
 |SINO;
     perio = perio - 1;
     |ABRE #2;
     #2#45 = activi;
     #2#1 = perio;
     #2#2 = any;
     |LEE 001#2=;
     |SI FSalida = 0;
          compens = #2#32;
     |FINSI;
     |CIERRA #2;
     perio = perio + 1;
 |FINSI;
|FPRC;

|PROCESO lee_any_a;
     compens = 0;
     sw_exi = 0;
     || lee el a¤o anterior, para ver si existe
     |ABRE #30;
     a_emp = #30#2;
     ac_pe = #30#3;
     a_per = ac_pe - 1;
     |SI a_per < 0; a_per = 9; |FINSI;
     #30#3 = a_per;
     |LEE 011#30=;
     |SI FSalida ! 0;
         sw_exi = 1;
     |FINSI;
     #30#2 = a_emp;
     #30#3 = ac_pe;
     |LEE 011#30=;
     |CIERRA #30;
     |SI sw_exi = 1; |ACABA; |FINSI;

     |SUB_EJECUTA "caany300";
|FPRC;

|PROCESO Carga99;
     #2#5  = #99#5;   #2#7  = #99#7;
     #2#8  = #99#8;   #2#10 = #99#10;
     #2#11 = #99#11;  #2#13 = #99#13;
     #2#14 = #99#14;  #2#16 = #99#16;
     #2#17 = #99#17;  #2#19 = #99#19;
     #2#21 = #99#21;
     #2#22 = #99#22;
     #2#23 = #99#23;
     #2#24 = #99#24;
     #2#26 = #99#26;
     #2#34 = #99#34;
     #2#35 = #99#35;
     #2#36 = #99#36;
     #2#37 = #99#37;
     #2#38 = #99#38;
     #2#39 = #99#39;
     #2#40 = #99#40;
     #2#41 = #99#41;
     #2#43 = #99#43;
     #2#44 = #99#44;
     #2#46 = #99#46;
     #2#48 = #99#48;
     #2#49 = #99#49;
     #2#50 = #99#50;
     #2#51 = #99#51;
     #2#52 = #99#52;
     #2#53 = #99#53;
     #2#54 = #99#54;
     #2#56 = #99#56;
     #2#57 = #99#57;
     #2#58 = #99#58;
     #2#59 = #99#59;
|FPRC;

|PROCESO empresa; |TIPO 0;
  cont = FEntrada / 100;
  cont = cont ! 0;
  |SI cont ! 1;  |ACABA;  |FINSI;
  |ABRE #1;
  |LEE 000#1p;
  |SI FSalida = 0;
      #2#6  = #1#1;
      #2#9  = #1#2;
      #2#12 = #1#3;
      #2#15 = #1#4;
      #2#18 = #1#5;
      #2#47 = #1#6;
  |SINO;
      |MENAV "    No esta definido el control del IVA ...";
      |ERROR;
  |FINSI;
  |CIERRA #1;
|FPRC;

|PROCESO abre_300;
    #2#45 = activi;      || actividad
    #2#01 = perio;       || periodo
    #2#02 = #30#26;      || a¤o
|FPRC;

|PROCESO cierra_300;
  |SI per_ant = -1; |HAZ totaliza_300; |FINSI;
|FPRC;

|PROCESO haztot;
|HAZ totaliza_300;
total = #2#28 - #2#29 - #2#30;
|SI total = 0;
    #2#33 = 0;
    #2#31 = 0;
    #2#32 = 0;
|FINSI;
|SI total > 0;
    #2#33 = total;       || a ingresar
    #2#31 = 0;
    #2#32 = 0;
|SINO;         ||total negativo
    total = total * (-1);
    ||SI #2#1 ! 4; |Y #2#1 ! 12;    ||Si el periodo = 4 debe ser fin de a¤o

     |SI #8#71 = "C";
       #2#32 = total;         || a compensar
       #2#31 = 0;
     |SINO;
       #2#31 = total;         || a devolver
       #2#32 = 0;
     |FINSI;
       #2#33 = 0;             || a ingresar
    ||FINSI;
|FINSI;
|FPRC;

|PROCESO tipo8; |TIPO 8;
  |HAZ inicio;
  |DDEFECTO #8;
  |ABRE #8;
  #8#0 = #30#2;
  #8#1 = #30#26;
  |LEE 000#8=;
  |SI FSalida ! 0;
     |MENAV "    No encontrado Fichero Portadas Modelos";
     |CIERRA #8;
     |PTEC 807;
     |ACABA;
  |FINSI;
  |CIERRA #8;
|FPRC;

|PROCESO mayor;
  #0Campo = #0Campo > " ";
  |PINTA #0Campo;

  |C_M #0#8,1,"S";
  |SI #0#2 = 1;
     |C_M #0#8,1,"N";
     #0#8 = "N"; |PINTA #0#8;
  |FINSI;

  |SI Campo = 8;
     |C_M #0#7,1,"S";
     |SI #0#8 = "S";
        |C_M #0#7,1,"N";
        #0#7 = "N"; |PINTA #0#7;
     |FINSI;
  |FINSI;
|FPRC;

|PROCESO per_hasta; |TIPO 0;
  |SI #0#0 = "T"; |Y #0Campo > 4;
     |ERROR;
  |FINSI;
  |SI #0#0 = "A"; |Y #0Campo > 1;
     |ERROR;
  |FINSI;
|FPRC;

|PROCESO reo300; |TIPO 3;

     |IMPRE 0;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |INFOR "capre300";
     |SI FSalida ! 0; |ACABA; |FINSI;

     |HAZ nom_usu;
     alfa1 =  "b" + nom_tmp;
     traba2 = alfa1;
     |DFICE dirfich0;
     traba1 = "caman300";
     |HAZ copiando;
     |NOME_DAT #2 traba2;

     activi    = #0#0;
     perio     = #0#2;
     peria     = #0#2;
     nHPeriodo = #0#2 - 1;
     any       = #48#26;

     |SI swyacal = 0;
        |SI #0#6 = "S";
           swyacal = 1;
           |BUCLE per_reper;    || revisa los periodos
           |BUCLE per_sopor;
        |FINSI;
     |FINSI;

     nSw300 = 0;
     |DDEFECTO #99;

     |ABRE #7;

     |SI #0#2 > 1;
         |SI #0#8 = "S";
             nSw300 = 0;
             |BUCLE caivarep;
             |BUCLE caivasop;
             |BUCLE caman300;
         |SINO;
             |SI #0#7 = "S";
                 peria = 1;
             |FINSI;
         |FINSI;
     |FINSI;

     per_ant = -1;
     |HAZ lee_ant;

     |DDEFECTO #2;
     |HAZ empresa;             || vuelve a cargar porcentajes

     #2#45 = activi;
     #2#1  = perio;
     #2#2  = any;
     #2#0  = #30#2;
     #2#27 = #8#72;
     |HAZ Carga99;

     |ATRI P;
     |MENSA "    ***** CALCULANDO *****";
     |ATRI 0;

     |BUCLE reper;
     |HAZ cierra_300;
     per_ant = -1;

     |BUCLE sopor;
     #2#29 = compens;
     |HAZ cierra_300;
     |CIERRA #7;

     |HAZ haztot;

     |PRINT;
     |PIEINF;
     |FININF;
     |FINIMP;
|FPRC;
