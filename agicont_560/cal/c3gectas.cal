|FICHEROS;
    c3gectas #0;       || Informe suma y saldos comparacion
    cacuenta #1;       || Plan contable
    cactasys #2;       || Fichero Defs Informe
    caconimp #8;

    caratios #103;       || Fichero de Ratios
    caformul #104;
|FIN;

|VARIABLES;
  &pathbal = "";
  &balance = 1;
  &entrada = 1;
  lin = 0;
  sw_error = 0;
    x = 0;
    y = 0;
    informe = "cactasys";
    mes = 0;                  || Variable para saber el mes seleccionado
    letrames = "";            || Variable para poner el mes en letra
    error1 = "0000Nivel repetido";
    error2 = "0000No existe informe";
    error3 = "0000El numero de nivel no coincide con el numero de nivel de la empresa";
    swprint = 0;       || Variable para saber si imprimimos o no
    swsuma = 0;        || Variable para saber si sumamos o no
    saldo = 0;         || Resta entre el debe y el haber;
    sw = 0;            || sw para nivel anterior
    nivelact = 0;      || Nivel actual
    rellenos = "";     || Variable para rellenar el hasta de la cuenta en zetas
    &i_debe = 0;       || Total del debe por registro
    &i_haber = 0;      || Total del haber por registro
    &i_deudor = 0;     || Total saldo deudor por registro
    &i_acreedor = 0;   || Total saldo acreedor por registro
    &t_debe = 0;       || Total del debe del informe
    &t_haber = 0;      || Total del haber del informe;
    &t_deudor = 0;     || Total saldo deudor por informe
    &t_acreedor = 0;   || Total saldo acreedor por informe
    &tan100 = 0;
    &swlinea = 0;      || Pone o no linea en blanco en informe
    &swcomen = 0;

    men2  = "     Longitud de Cuenta Fuera de Nivel ";
    long = "  ";
    cta  = 0;
    num   = 0;
    swdig = 0;
    digito = 0;
    menor = 0;
    para1 = 0;
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;
    alfa1 = "";
    alfa2 = "";
    alfa3 = "";
    alfa4 = "";
    dos_ant = "xx";
    &pagina = 0;
    sw_pagina = 0;
    &cmcta = "";
    &cmnom = "";
    &cmsal = 0;
    &deac = "";
    &titulo = "";
    dif = 0;
    aparam = "";

    i_cm1 = 20;  || Campo Desde/Hasta Empresa
    pregun2 = "2400NCalcular los Ratios de cada Empresa ? ";
|FIN;

|INCLUYE acceso_i;
|INCLUYE digito_i;
|INCLUYE puntos_i;
|INCLUYE calrat_i;
|INCLUYE multie_i;

|| ***********************************************************************
||                       CALCULOS DE PANTALLA
|| ***********************************************************************

|PROCESO &c_pagina;
  |SI sw_pagina = 0;
      pagina = 1;
      sw_pagina = 1;
  |SINO;
      pagina = pagina + 1;
  |FINSI;
|FPRC;

|PROCESO tipo8;  |TIPO 8;
  |HAZ inicio;
  any = #30#26;
  |HAZ coloca;
|FPRC;

|PROCESO mayor;
 alfa1 = #0Campo > " ";
 #0Campo = alfa1;
 |PINTA #0Campo;
 |SI Campo = 17;
     |SI #0Campo = "C";
         |C_M #0#8, 1,"S";
         |C_M #0#18,1,"N";
         #0#18 = 0; |PINTA #0#18;
         |PINTA 1521, "                                    ";
         #0#16 = "* BALANCE SUMAS Y SALDOS COMPARADO CON CUENTA *";
         |PINTA #0#16;
     |SINO;
         |C_M #0#8, 1,"N";
         |C_M #0#18,1,"S";
         #0#8 = "            "; |PINTA #0#8;
         |PINTA 1429, "                                    ";
         #0#16 = "* BALANCE SUMAS Y SALDOS COMPARADO CON RATIO *";
         |PINTA #0#16;
     |FINSI;
 |FINSI;
|FPRC;

|PROCESO cuenta; |TIPO 6;
 |SI FSalida = 2; |ACABA; |FINSI;
 |SI #0#17 = "R"; |Y Campo = 8; |ACABA; |FINSI;
    p_alfa1 = #0Campo;
    salidas = FSalida;
 |HAZ punto;
 |SI p_error ! 0;  |ERROR;  |ACABA;  |FINSI;

 |SI #0Campo = "            "; |Y Campo = 8; |ERROR;  |ACABA;  |FINSI;
 |SI Campo = 8;
     digito = 9;
 |SINO;
     digito = Campo + 14;
 |FINSI;
 cta  = #0Campo;
 long = cta % 0;
 swdig = 0;
 |SI long = #30#14; swdig = 1; #0digito = 1; |FINSI;
 |SI long = #30#15; swdig = 1; #0digito = 2; |FINSI;
 |SI long = #30#16; swdig = 1; #0digito = 3; |FINSI;
 |SI long = #30#17; swdig = 1; #0digito = 4; |FINSI;
 |SI long = #30#18; swdig = 1; #0digito = 5; |FINSI;
 |SI long = #30#19; swdig = 1; #0digito = 6; |FINSI;
 |SI swdig = 0;
     |MENAV men2;
     |ERROR;
 |FINSI;
|FPRC;

|PROCESO nomcuenta; || leer la cuenta a comparar.
  |SI #0#17 = "R"; |ACABA; |FINSI;
  |SI FSalida = 2; |ACABA; |FINSI;
   sw_error = 1;
|ABRE #1;
    |DDEFECTO #1;
    #1#0 = #0#8;
    #1#1 = #0#9;
   |LEE 001#1=;
   |PINTA 1429, #1#2;
|CIERRA #1;
|FPRC;

|PROCESO leeratio; || Lee el ratio
  |SI #0#17 = "C"; |ACABA; |FINSI;
  |ABRE #103;
  #103#0 = #0#18;
  |LEE 001#103=;
  |SI FSalida = 0;
      |PINTA 1521, #103#1;
  |SINO;
      |PINTA 1521, "Atencion!. Ratio Inexistente.";
  |FINSI;
  |CIERRA #103;
|FPRC;

|PROCESO mesconta; |TIPO 0;
  y = Campo + 1;                || Coge el campo del nombre del mes
  mes = #0Campo;
  |SI #0Campo ! 0;|Y #0Campo ! 13;
      mes = #30#11 + (#0Campo - 1);     || Operacion para saber que mes es
      |SI mes > 12; mes = mes - 12; |FINSI;
  |FINSI;
  |HAZ mesletra;                      || Recoge el mes en letra
  #0y = letrames;
  |PINTA #0y;                   || Pinta el nombre del mes
  |SI Campo = 4;
      |SI #0#2 > #0#4;
          |MENAV "    ATENCION!!! Error de Entrada ...";
          |ERROR;
          |ACABA; || Si el mes hasta es menor al desde
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO mesletra;
  |SI mes = 0;  letrames = "Apertura  "; |FINSI;
  |SI mes = 1;  letrames = "Enero     "; |FINSI;
  |SI mes = 2;  letrames = "Febrero   "; |FINSI;
  |SI mes = 3;  letrames = "Marzo     "; |FINSI;
  |SI mes = 4;  letrames = "Abril     "; |FINSI;
  |SI mes = 5;  letrames = "Mayo      "; |FINSI;
  |SI mes = 6;  letrames = "Junio     "; |FINSI;
  |SI mes = 7;  letrames = "Julio     "; |FINSI;
  |SI mes = 8;  letrames = "Agosto    "; |FINSI;
  |SI mes = 9;  letrames = "Septiembre"; |FINSI;
  |SI mes = 10; letrames = "Octubre   "; |FINSI;
  |SI mes = 11; letrames = "Noviembre "; |FINSI;
  |SI mes = 12; letrames = "Diciembre "; |FINSI;
  |SI mes = 13; letrames = "Cierre    "; |FINSI;
|FPRC;

|PROCESO numnivel;|TIPO 0;
  |SI #0#7 > #30#13;
      |MENAV error3;
      |ERROR;
      |ACABA;
  |FINSI;
|FPRC;

|| **********************************************************************
|PROCESO sel_multi;
|| |SI #30#26 ! any;  |ACABA; |FINSI;
  |SI #30#21 = "I";   |ACABA; |FINSI;
  |SI #30#13 < #0#7;  |ACABA;  |FINSI;
  sw_error = 0;

  alfa1 = #30#2;
  alfa2 = #30#3;
  alfa1 = "00000" + alfa1;   alfa1 = alfa1 % -105;
  alfa2 = "0"     + alfa2;   alfa2 = alfa2 % -101;
  dirfich0 = dir_fich + alfa1 + alfa2 + "/";
  |SI #0#17 = "C";
      || ... Busca que exista Cuenta
      |PATH_DAT #1 dirfich0;
      |ABRE #1;
      |DDEFECTO #1;
      #1#0 = #0#8;
      #1#1 = #0#9;
      |LEE 001#1=;
      |SI FSalida ! 0; sw_error = 1; |FINSI;
      |CIERRA #1;
  |SINO;
      || ... Buscar El Ratio
      |PATH_DAT #103 dirfich0;
      |ABRE #103;
      #103#0 = #0#18;
      |LEE 001#103=;
      |SI FSalida ! 0; sw_error = 2; |FINSI;
      |CIERRA #103;
  |FINSI;
||  |SI sw_error = 0; leidos = 1; |FINSI;
  leidos = 1;
|FPRC;

|PROCESO esbuena2;
 |SI FSalida = 2; |ACABA; |FINSI;
 |CAMPO_MODIFICA #0Campo,0,alfa1;
 |SI alfa1 = "N"; |ACABA; |FINSI;
 |SI sw_error !  0; |Y leidos = 1;
     |SI sw_error = 1; |MENAV "    NO EXISTE CUENTA A COMPARAR "; |FINSI;
     |SI sw_error = 2; |MENAV "    NO EXISTE RATIO  A COMPARAR "; |FINSI;
     leidos = 0;
     |ERROR;
 |FINSI;
|FPRC;

|| ***********************************************************************
|| ---------- Seleccion DESDE / HASTA Empresa.
|PROCESO esdesd1;
  alfa1 = #30#2;
  alfa2 = #30#3;
  alfa1 = "00000" + alfa1;   alfa1 = alfa1 % -105;
  alfa2 = "0"   + alfa2;   alfa2 = alfa2 % -101;
  dirfich0 = dir_fich + alfa1 + alfa2 + "/";

  sw_error = 0;
  leidos = 0;
  |HAZ sel_multi;
  |SI leidos = 1; |Y sw_error = 0;
      |HAZ haztodo;
  |FINSI;
|FPRC;

|DEFBUCLE esdesde;
 #30#1;
 ;
 d_empres, d_period;
 h_empres, h_period;
 e;
 NULL,esdesd1;
|FIN;

|| ---------- Seleccion en parrilla.
|PROCESO esunaauna;
  |PARA xx = i_cm6; |SI xx [ i_cm7; |HACIENDO xx = xx + 1;
        |SI #0xx = 0;  |SAL;  |FINSI;
        yy = xx + 20;
        alfa1 = #0xx;
        alfa2 = #0yy;

        || ... lee empresa
           |ABRE #30;
           |DDEFECTO #30;
           #30#2 = #0xx;
           #30#3 = #0yy;
           |LEE 011#30=;
           |CIERRA #30;
           leidos = 0; sw_error = 0;
           |HAZ sel_multi;
           |SI leidos = 0; |O sw_error ! 0; |VETE otramas; |FINSI;
        || ...................

        alfa1 = "00000" + alfa1;   alfa1 = alfa1 % -105;
        alfa2 = "0"     + alfa2;   alfa2 = alfa2 % -101;
        dirfich0 = dir_fich + alfa1 + alfa2 + "/";

        |HAZ haztodo;
 |ET otramas;
  |SIGUE;
|FPRC;

|| ***************************************************************************
|PROCESO impre;  |TIPO 3;
  |SI #0#17 = "R";
      |CONFI pregun2;
      |SI FSalida = 0;
          pregun1 = "2400SDesea calcular el Ratio ? ";
      |FINSI;
  |FINSI;

  |IMPRE 0;
  |SI FSalida ! 0;  |ACABA;  |FINSI;

  |INFOR informe;
  |SI FSalida ! 0; |FINIMP; |ACABA; |FINSI;

  |PARA xx = 0; |SI xx [ 18; |HACIENDO xx = xx + 1;
        #2xx = #0xx;
  |SIGUE;

  |SI #0i_cm1 = "S";
      |BUCLE esdesde;
  |SINO;
      |HAZ esunaauna;
  |FINSI;
  |FININF;
  |FINIMP;
|FPRC;
|| **********************************************************************
||                       CALCULOS DE IMPRESION
|| **********************************************************************

|PROCESO condicion;      || Calculo condiciones de impresion
  |HAZ digitos2;
  |SI d_error ! 0;  |ACABA;  |FINSI;
  swprint = 0;         || Variable para saber si imprimimos o no
  swsuma = 0;          || Variable para saber si sumamos o no

|SI #1#55 = #0#7; swprint = 1; swsuma = 1; |FINSI;

|SI #1#3 = "S";|Y #1#55 [ #0#7;    || Si el nivel no esta seleccionado
    swsuma = 1;                || pero tiene en el campo pase una S
    swprint = 1;               || entonces se imprime y se suma.
|FINSI;

|SI swprint = 1;    || Si se puede imprimir
    |SI sw = 0;
        nivelact = #1#55;     || Nivel actual
        sw = 1;
    |FINSI;
    |HAZ suma;
    |SI i_debe = 0; |Y i_haber = 0; |Y #0#6 = "N"; || cuentas sin mov.
        |ACABA;
    |FINSI;
    |HAZ tanto100;
    |HAZ operaimpre;
|FINSI;
|FPRC;

|PROCESO operaimpre;     || impresora

|SI nivelact ! #1#55;         || cambio de nivel, linea en blanco
        swlinea = 1;
        nivelact = #1#55;
|SINO;
        swlinea = 0;
|FINSI;

|| SI #0#8 = 1;  |HAZ artenvas; |FINSI;   || separacion lineas formato ARTENVAS

|PRINT;
swcomen = 1
|SI swsuma = 1;     || acumula totales
        t_debe = t_debe + i_debe;                 || debe
        t_haber = t_haber + i_haber;              || haber
        t_deudor = t_deudor + i_deudor;           || saldo deudor
        t_acreedor = t_acreedor + i_acreedor;     || saldo acreedor
|FINSI;
|FPRC;

|PROCESO artenvas;
    alfa1 = #1#0;
    alfa1 = alfa1 % 102;

|SI dos_ant = "xx"; dos_ant = alfa1;    |FINSI;

|SI alfa1 ! dos_ant;
        dos_ant = alfa1;
        swlinea = 1;          || cuando solo se ha seleccionado un nivel y
|SINO;                        ||/cambia en sus dos primeros digitos se
        swlinea = 0;          ||/imprime una linea en blanco!!!
|FINSI;
|FPRC;

|DEFBUCLE caycosy00;      || plan contable (3ra. clave)
 #1#3;
 ;
     #0#0, 1;
 rellenos, 6;
 e;
 NULL, condicion;
|FIN;

|PROCESO suma;
i_debe = 0;
i_haber = 0;
i_deudor = 0;
i_acreedor = 0;
saldo = 0;
y = ((#0#2 * 3) + 9);
|PARA x = #0#2; |SI x [ #0#4; |HACIENDO x = x + 1;
        i_debe = i_debe + #1y;                   || acumula debe
        y = y + 1;
        i_haber = i_haber + #1y;                 || acumula haber
        y = y + 2;
|SIGUE;
    saldo = i_debe - i_haber;      || saldo
|SI saldo > 0; i_deudor = saldo; i_acreedor = 0;            |FINSI;
|SI saldo < 0; i_deudor = 0;     i_acreedor = saldo * (-1); |FINSI;
|SI saldo = 0; i_deudor = 0;     i_acreedor = 0;            |FINSI;
|FPRC;

|PROCESO tanto100;
  tan100 = 0;
  |SI cmsal = 0; |O saldo = 0;  |ACABA;  |FINSI;
  |SI saldo > 0; dif = saldo;   |FINSI;
  |SI saldo < 0; dif = - saldo; |FINSI;

  tan100 = (dif * 100) / cmsal;
|FPRC;

|| ***********************************************************************
||                       CALCULO ENTRADA DE DATOS
|| ***********************************************************************

|PROCESO rellena;
    rellenos = "zzzzzzzzzzzz";
    menor = #0#7;
    |SI menor = 1;  nume1 = dig4;  |FINSI;
    |SI menor = 2;  nume1 = dig5;  |FINSI;   || construye el hasta segun
    |SI menor = 3;  nume1 = dig6;  |FINSI;   ||/el nivel seleccionado
    |SI menor = 4;  nume1 = dig7;  |FINSI;
    |SI menor = 5;  nume1 = dig8;  |FINSI;
    |SI menor = 6;  nume1 = dig9;  |FINSI;
        nume1 = 100 + nume1;
        rellenos = #0#1 % nume1;
        rellenos = rellenos + "zzzzzzzzzzzz";
        rellenos = rellenos % 112;
|FPRC;

|PROCESO lecturas; || Leer el saldo de la cuenta o el ratio
 |SI #0#17 = "C"; |HAZ lectura_cta; |FINSI;
 |SI #0#17 = "R"; |HAZ lectura_ratio; |FINSI;
|FPRC;

|PROCESO lectura_cta; || leer la cuenta a comparar.
  titulo = "CUENTA";
  sw_error = 1;
|ABRE #1;
    #1#0 = #0#8;
    #1#1 = #0#9;
|LEE 001#1=;
  |SI FSalida = 0;
      sw_error = 0;
      cmcta = #1#0;
      cmnom = #1#2;
      cmsal = 0;
      |HAZ suma;
      |SI saldo ] 0; cmsal = saldo;   deac = "DEUDOR";   |FINSI;
      |SI saldo < 0; cmsal = - saldo; deac = "ACREEDOR"; |FINSI;
  |FINSI;
|CIERRA #1;
|FPRC;

|PROCESO lectura_ratio; || leer el ratio a comparar.
  titulo = "RATIO ";
  sw_error = 1;
  |ABRE #103;
  #103#0 = #0#18;
  |LEE 001#103=;
  |SI FSalida = 0;
      sw_error = 0;
      deac = " RATIO";
      cmcta = "0000" + #0#18;
      cmcta = cmcta % -104;
      cmnom = #103#1;

      |PTEC 802;
      |HAZ calculo_ratio;

      |SI error = 0;
          x = #0#4 + 2; |SI #0#4 = 0; x = 3; |FINSI;
          cmsal = #103x;
          saldo = #103x;
      |SINO;
          sw_error = 1;
      |FINSI;
  |FINSI;
  |CIERRA #103;
|FPRC;

|PROCESO haztodo;
  enEmpresa = #canempre#2;
  enPeriodo = #canempre#3;
  swOperacion = 0;
  |SUB_EJECUTA "camoneda.tab";

  |PATH_DAT #1 dirfich0;
  |PATH_DAT #8 dirfich0;
  |PATH_DAT #103 dirfich0;
  |PATH_DAT #104 dirfich0;

  |HAZ borra_var;

  |ABRE #8;
  |LEE 111#8p;
  |SI #8#2 = "S";  |Y #8#3 = "N";  |Y aparam = "";
      pathbal = dirfich0;
      balance = 1;
      |SUB_EJECUTA "careccue.tab";
  |FINSI;
  |CIERRA #8;
  || .... .... .... .... .... .... ....

  |HAZ rellena;
  |HAZ lecturas;
  |SI sw_error = 1; |ACABA; |FINSI;

  |BUCLE caycosy00;
  |SI swcomen = 1;  |PIEINF; |FINSI;
|FPRC;

|| ----------------------------------------------------------------------
|PROCESO borra_var;
    sw = 0;
    swcomen = 0;
    t_debe = 0;
    t_haber = 0;
    t_deudor = 0;
    t_acreedor = 0;
    cmsal = 0;
    sw_pagina = 0;

  dig1 = #30#11;       || desde mes
  dig3 = #30#13;       || nro. niveles
  dig4 = #30#14;       || 1 nivel
  dig5 = #30#15;       || 2 nivel
  dig6 = #30#16;       || 3 nivel
  dig7 = #30#17;       || 4 nivel
  dig8 = #30#18;       || 5 nivel
  dig9 = #30#19;       || 6 nivel
|FPRC;
