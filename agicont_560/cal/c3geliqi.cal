|FICHEROS;
    c3geliqi #0;
    caivasop #1;
    caivarep #2;
    caliqiva #3;
    cacon300 #4;
    canempre #30;
|FIN;

|VARIABLES;
    &entrada = 1;

    nSwIntra = 0;
    sw = 0;
    sw_impr = 0;
    informe = "caliqiva";
    mensa1  = "    ERROR ESTA FECHA NO CORRESPONDE AL EJERCICIO";
    x = 0;
    y = 0;
    z = 0;
    &descri1 = "";
    &descri2 = "";
    &varnum1 = 0;
    &varnum2 = 0;
    &varnum3 = 0;
    &tiva1 = 0;
    &tiva3 = 0;
    &trec1 = 0;
    &trec3 = 0;
    &ttotal1 = 0;
    &ttotal3 = 0;
    &swlin = 0;
    &bds = 0;
    &bdr = 0;
    &bns = 0;
    &bnr = 0;
    &cus = 0;
    &cur = 0;

    tiva11 = 0;
    prim = 0;
    blanco = "  ";
    ultimo = "zz";
    xxq = 0;
    yyq = 0;
    zzq = 0;
    desde = 0;
    hasta = 0;
    inver1 = "";
    inver2 = "";

    i_cm1 = 8;
    alfa1 = "";
    alfa2 = "";
|FIN;

|INCLUYE acceso_i;
|INCLUYE multie_i;
____________________________________/ CALCULOS DE PANTALLA
|PROCESO tipo8;  |TIPO 8;
  |HAZ inicio;
  any = #30#26;
  |HAZ coloca;
|FPRC;

|PROCESO empieza; |TIPO 7;
  #0#2 = fec1; |PINTA #0#2;
  #0#3 = fec2; |PINTA #0#3;
|FPRC;

|PROCESO fechad;
  |SI #0#2 < fec1; |O #0#2 > fec2;
      |MENAV mensa1;
      |ERROR;
      |ACABA;
  |FINSI;
|FPRC;

|PROCESO fechah;
  |SI #0#3 < fec1; |O #0#3 > fec2; |O #0#3 < #0#2;
      |MENAV mensa1;
      |ERROR;
      |ACABA;
  |FINSI;
|FPRC;

|PROCESO mayor; |TIPO 0;
  alfa1 = #0Campo > " ";
  #0Campo = alfa1;
  |PINTA #0Campo;
|FPRC;

|PROCESO periodoh;
  |SI #0#75 < #0#74;
      |ERROR;
      |ACABA;
  |FINSI;
|FPRC;

|PROCESO selec;
 |C_M #0#2,1,"S";  |C_M #0#3,1,"S";
 |C_M #0#74,1,"S"; |C_M #0#75,1,"S";
 |PINTA 1032, "                           ";

 |SI #0Campo = 1; alfa1 = "POR FECHA FACTURA  "; |FINSI;
 |SI #0Campo = 2; alfa1 = "POR FECHA CONTABLE "; |FINSI;
 |SI #0Campo = 3; alfa1 = "POR PERIODO DE LIQUIDACION "; |FINSI;
 |ATRI I; |PINTA 1132, alfa1; |ATRI 0;

 |SI #0Campo = 3;
     |C_M #0#2, 1,"N";  |C_M #0#3,1,"N";
     #0#2 = fec1; |PINTA #0#2;
     #0#3 = fec2; |PINTA #0#3;
 |SINO;
     |C_M #0#74, 1,"N";  |C_M #0#75,1,"N";
     #0#74 = 01; |PINTA #0#74;
     #0#75 = 12; |PINTA #0#75;
 |FINSI;
|FPRC;

|| ***************************************************************************
|PROCESO sel_multi;
 || ...  |SI #30#26 ! any;  |ACABA; |FINSI; || No es necesario Ejercicio
  |SI #30#21 = "I";  |ACABA; |FINSI;
  leidos = 1;
|FPRC;

|| ***********************************************************************
|| ---------- Seleccion DESDE / HASTA Empresa.
|PROCESO esdesd1;
  alfa1 = #30#2;
  alfa2 = #30#3;
  alfa1 = "00000" + alfa1;   alfa1 = alfa1 % -105;
  alfa2 = "0"   + alfa2;   alfa2 = alfa2 % -101;
  dirfich0 = dir_fich + alfa1 + alfa2 + "/";

  || ................. |SI #30#26 ! any;  |ACABA; |FINSI;
  |SI #30#21 = "I";  |ACABA; |FINSI;

  |HAZ haztodo;
|FPRC;

|DEFBUCLE esdesde;
 #30#1;
 ;
 d_empres, d_period;
 h_empres, h_period;
 e;
 NULL,esdesd1;
|FIN;

|| ---------- Seleccion en parrilla.
|PROCESO esunaauna;
  |PARA xx = i_cm6; |SI xx [ i_cm7; |HACIENDO xx = xx + 1;
        |SI #0xx = 0;  |SAL;  |FINSI;
        yy = xx + 20;
        alfa1 = #0xx;
        alfa2 = #0yy;

        || ... lee empresa
           |ABRE #30;
           |DDEFECTO #30;
           #30#2 = #0xx;
           #30#3 = #0yy;
           |LEE 011#30=;
           |CIERRA #30;
           || ... |SI #30#26 ! any;  |VETE otramas; |FINSI;
           |SI #30#21 = "I";  |VETE otramas; |FINSI;
        || ........................................................

        alfa1 = "00000" + alfa1;   alfa1 = alfa1 % -105;
        alfa2 = "0"     + alfa2;   alfa2 = alfa2 % -101;
        dirfich0 = dir_fich + alfa1 + alfa2 + "/";
        |HAZ haztodo;

 |ET otramas;
  |SIGUE;
|FPRC;

|| ***************************************************************************
____________________________________/ IVA SOPORTADO
|PROCESO carga_sopo;
  |PARA xxq = desde;  |SI xxq [ hasta;  |HACIENDO xxq = xxq + 1;
        yyq = xxq + 10;
        zzq = xxq + 20;
        |SI #3xxq = -1;
             #3xxq = #1y;
             #3yyq = #1x;
             #3zzq = #1z;
            |SAL;
        |FINSI;
        |SI #1y = #3xxq;
            #3yyq = #3yyq + #1x;
            #3zzq = #3zzq + #1z;
            |SAL;
        |FINSI;
  |SIGUE;
|FPRC;

|PROCESO puntero1;
  |SI nSwIntra = 1;
      #4#0 = #1#6;
      |LEE 040#4=;
      |SI FSalida ! 0;  |DDEFECTO #4;  |FINSI;

      |SI #4#1 ! 3;  |ACABA;  |FINSI;
  |FINSI;

  sw = 1;
  |PARA x =  8; |SI x [ 10; |HACIENDO x = x + 1;         || carga iva sop.
        y = x + 3;       || % IVA                      || bases 1-3
        z = y + 3;       || ptas. IVA
        |SI #1#23 = "N";
            #3#63 = #3#63 + #1x;
            #3#64 = #3#64 + #1z;
        |SINO;
            |SI #1x ! 0; |O #1z ! 0;
                desde = 3;
                hasta = 12;
                |HAZ carga_sopo;
            |FINSI;
        |FINSI;
  |SIGUE;
  |PARA x = 52; |SI x [ 53; |HACIENDO x = x + 1;         || carga iva sop.
        y = x + 2;       || % IVA                      || bases 4-5
        z = y + 2;       || ptas. IVA
        |SI #1#23 = "N";
            #3#63 = #3#63 + #1x;
            #3#64 = #3#64 + #1z;
        |SINO;
            |SI #1x ! 0; |O #1z ! 0;
                desde = 3;
                hasta = 12;
                |HAZ carga_sopo;
            |FINSI;
        |FINSI;
  |SIGUE;

  |PARA x =  8; |SI x [ 10; |HACIENDO x = x + 1;    || Carga rec. sop.
        y = x + 9;       || % recargo             || bases 1-3
        z = y + 3;       || cuota recargo
        |SI #1#23 = "N";
            #3#64 = #3#64 + #1z;
        |SINO;
            |SI #1x ! 0;|Y #1y ! 0;
                desde = 33;
                hasta = 42;
                |HAZ carga_sopo;
            |FINSI;
        |FINSI;
  |SIGUE;
  |PARA x = 52; |SI x [ 53; |HACIENDO x = x + 1;    || Carga rec. sop.
        y = x + 6;       || % recargo             || base 4-5
        z = y + 2;       || cuota recargo
        |SI #1#23 = "N";
            #3#64 = #3#64 + #1z;
        |SINO;
            |SI #1x ! 0;|Y #1y ! 0;
                desde = 33;
                hasta = 42;
                |HAZ carga_sopo;
            |FINSI;
        |FINSI;
  |SIGUE;
|FPRC;

|DEFBUCLE calisopo;
#1#3;
48;
#3#65, #3#0, 000001, blanco, inver1;
#3#66, #3#1, 999999, ultimo, inver2;
be;
NULL,puntero1;
|FIN;

|DEFBUCLE calisopo_2;
#1#1;
46,48;
#3#65, 000000, blanco, #3#0, inver1;
#3#66, 999999, ultimo, #3#1, inver2;
be;
NULL,puntero1;
|FIN;

|DEFBUCLE calisopo_3;
#1#1;
44,48;
#3#65, 000000, blanco, #3#70, inver1;
#3#66, 999999, ultimo, #3#71, inver2;
be;
NULL,puntero1;
|FIN;

____________________________________/ IVA REPERCUTIDO
|PROCESO carga_repe;
  |PARA xxq = desde;  |SI xxq [ hasta;  |HACIENDO xxq = xxq + 1;
        yyq = xxq + 10;
        zzq = xxq + 20;
        |SI #3xxq = -1;
             #3xxq = #2y;
             #3yyq = #2x;
             #3zzq = #2z;
            |SAL;
        |FINSI;
        |SI #2y = #3xxq;
            #3yyq = #3yyq + #2x;
            #3zzq = #3zzq + #2z;
            |SAL;
        |FINSI;
  |SIGUE;
|FPRC;

|PROCESO puntero2;
  sw = 2;
  |PARA x =  8; |SI x [ 10; |HACIENDO x = x + 1;         || carga iva rep.
        y = x + 3;       || % IVA                        || bases 1-3
        z = y + 3;       || ptas. IVA
        |SI #2#23 = "N";
            #3#63 = #3#63 + #2x;
            #3#64 = #3#64 + #2z;
        |SINO;
            |SI #2x ! 0; |O #2z ! 0;
                desde = 3;
                hasta = 12;
                |HAZ carga_repe;
            |FINSI;
        |FINSI;
  |SIGUE;
  |PARA x = 52; |SI x [ 53; |HACIENDO x = x + 1;         || carga iva rep.
        y = x + 2;       || % IVA                      || bases 4-5
        z = y + 2;       || ptas. IVA
        |SI #2#23 = "N";
            #3#63 = #3#63 + #2x;
            #3#64 = #3#64 + #2z;
        |SINO;
            |SI #2x ! 0; |O #2z ! 0;
                desde = 3;
                hasta = 12;
                |HAZ carga_repe;
            |FINSI;
        |FINSI;
  |SIGUE;

  |PARA x =  8; |SI x [ 10; |HACIENDO x = x + 1;         || carga rec. rep.
        y = x + 9;       || % recargo                  || bases 1-3
        z = y + 3;       || ptas. recargo
        |SI #2#23 = "N";
            #3#64 = #3#64 + #2z;
        |SINO;
            |SI #2x ! 0; |Y #2y ! 0;
                desde = 33;
                hasta = 42;
                |HAZ carga_repe;
            |FINSI;
        |FINSI;
  |SIGUE;
  |PARA x = 52; |SI x [ 53; |HACIENDO x = x + 1;         || carga rec. rep.
        y = x + 6;       || % recargo                  || bases 4-5
        z = y + 2;       || ptas. recargo
        |SI #2#23 = "N";
            #3#64 = #3#64 + #2z;
        |SINO;
            |SI #2x ! 0; |Y #2y ! 0;
                desde = 33;
                hasta = 42;
                |HAZ carga_repe;
            |FINSI;
        |FINSI;
  |SIGUE;
|FPRC;

|DEFBUCLE calirepe;
#2#3;
48;
#3#65, #3#0, 000000, blanco, inver1;
#3#66, #3#1, 999999, ultimo, inver2;
be;
NULL,puntero2;
|FIN;

|DEFBUCLE calirepe_2;
#2#1;
46,48;
#3#65, 000000, blanco, #3#0, inver1;
#3#66, 999999, ultimo, #3#1, inver2;
be;
NULL,puntero2;
|FIN;

|DEFBUCLE calirepe_3;
#2#1;
44,48;
#3#65, 000000, blanco, #3#70, inver1;
#3#66, 999999, ultimo, #3#71, inver2;
be;
NULL,puntero2;
|FIN;
|| ****************************************************************************

|PROCESO impre2;
  tiva1 = 0;
  tiva11 = 0;
  tiva3 = 0;
  prim = 0;
  |PARA xxq = 3; |SI xxq [ 12; |HACIENDO xxq = xxq + 1;
        yyq = xxq + 10;
        zzq = xxq + 20;
        |SI #3xxq = -1;  |SAL;  |FINSI;
        |SI #3yyq ! 0;  |O #3zzq ! 0; |O xxq = 3;
            varnum1 = #3yyq;
            varnum2 = #3xxq;
            varnum3 = #3zzq;
            tiva1 = tiva1 + varnum1;
            tiva11 = tiva11 + varnum1;
            tiva3 = tiva3 + varnum3;
            |SI prim = 0;
                descri1 = "*I.V.A. SOPORTADO";
                descri2 = " ================";
                swlin = 1;
                |PRINT;
                prim = 1;
            |FINSI;
            swlin = 2;
            |PRINT;
            sw_impr = 1;
        |FINSI;
  |SIGUE;
  |SI sw_impr ! 0;
      swlin = 3;
      |PRINT;
      sw_impr = 0;
  |FINSI;
  ttotal3 = ttotal3 + tiva3;

  tiva1 = 0;
  tiva3 = 0;
  prim = 0;
  |PARA xxq = 33; |SI xxq [ 42; |HACIENDO xxq = xxq + 1;
        yyq = xxq + 10;
        zzq = xxq + 20;
        |SI #3xxq = -1;  |SAL;  |FINSI;
        varnum1 = #3yyq;
        varnum2 = #3xxq;
        varnum3 = #3zzq;
        tiva1 = tiva1 + varnum1;
        tiva3 = tiva3 + varnum3;
        |SI prim = 0;
            descri1 = "*REC. DE EQ. SOPORTADO";
            descri2 = " =====================";
            swlin = 1;
            |PRINT;
            prim = 1;
        |FINSI;
        swlin = 2;
        |PRINT;
        sw_impr = 1;
  |SIGUE;
  |SI sw_impr ! 0;
      swlin = 3;
      |PRINT;
      sw_impr = 0;
  |FINSI;
  |SI #3#63 ! 0;|O #3#64 ! 0;
      swlin = 4;
      |PRINT;
  |FINSI;
  ttotal1 = tiva11 + #3#63 + #3#64;
  ttotal3 = ttotal3 + tiva3;
  bds = tiva11;
  bns = #3#63 + #3#64;
  cus = ttotal3;
  ttotal1 = 0;
  ttotal3 = 0;
|FPRC;

|PROCESO impre3;       ||imprime IVA repercutido;
  tiva1 = 0;
  tiva11 = 0;
  tiva3 = 0;
  prim = 0;
  |PARA xxq = 3; |SI xxq [ 12; |HACIENDO xxq = xxq + 1;
        yyq = xxq + 10;
        zzq = xxq + 20;
        |SI #3xxq = -1;  |SAL;  |FINSI;
        |SI #3yyq ! 0;  |O #3zzq ! 0; |O xxq = 3;
            varnum1 = #3yyq;
            varnum2 = #3xxq;
            varnum3 = #3zzq;
            tiva1 = tiva1 + varnum1;
            tiva11 = tiva11 + varnum1;
            tiva3 = tiva3 + varnum3;
            |SI prim = 0;
                descri1 = "*I.V.A. REPERCUTIDO";
                descri2 = " ==================";
                swlin = 1;
                |PRINT;
                prim = 1;
            |FINSI;
            swlin = 2;
            |PRINT;
            sw_impr = 1;
        |FINSI;
  |SIGUE;
  |SI sw_impr ! 0;
      swlin = 3;
      |PRINT;
      sw_impr = 0;
  |FINSI;
  ttotal3 = ttotal3 + tiva3;

  tiva1 = 0;
  tiva3 = 0;
  prim = 0;
  |PARA xxq = 33; |SI xxq [ 42; |HACIENDO xxq = xxq + 1;
        yyq = xxq + 10;
        zzq = xxq + 20;
        |SI #3xxq = -1;  |SAL;  |FINSI;
        varnum1 = #3yyq;
        varnum2 = #3xxq;
        varnum3 = #3zzq;
        tiva1 = tiva1 + varnum1;
        tiva3 = tiva3 + varnum3;
        |SI prim = 0;
            descri1 = "*REC. DE EQ. REPERCUTIDO";
            descri2 = " =======================";
            swlin = 1;
            |PRINT;
            prim = 1;
        |FINSI;
        swlin = 2;
        |PRINT;
        sw_impr = 1;
  |SIGUE;
  |SI sw_impr ! 0;
      swlin = 3;
      |PRINT;
      sw_impr = 0;
  |FINSI;
  |SI #3#63 ! 0;|O #3#64 ! 0;
      swlin = 4;
      |PRINT;
  |FINSI;
  ttotal1 = tiva11 + #3#63 + #3#64;
  ttotal3 = ttotal3 + tiva3;
  bdr = tiva11;
  bnr = #3#63 + #3#64;
  cur = ttotal3;
  ttotal1 = 0;
  ||ttotal3 = 0;
|FPRC;

|PROCESO impre4;       ||imprime IVA Intracomunitario
  prim = 0;
  |PARA xxq = 3; |SI xxq [ 12; |HACIENDO xxq = xxq + 1;
        yyq = xxq + 10;
        zzq = xxq + 20;
        |SI #3xxq = -1;  |SAL;  |FINSI;
        |SI #3yyq ! 0;  |O #3zzq ! 0; |O xxq = 3;
            varnum1 = #3yyq;
            varnum2 = #3xxq;
            varnum3 = #3zzq;
            tiva1 = tiva1 + varnum1;
            tiva11 = tiva11 + varnum1;
            tiva3 = tiva3 + varnum3;
            |SI prim = 0;
                descri1 = "*I.V.A. INTRACOMUNITARIO";
                descri2 = " =======================";
                swlin = 1;
                |PRINT;
                prim = 1;
            |FINSI;
            swlin = 2;
            |PRINT;
            sw_impr = 1;
        |FINSI;
  |SIGUE;
  |SI sw_impr ! 0;
      swlin = 3;
      |PRINT;
      sw_impr = 0;
  |FINSI;
  ttotal3 = ttotal3 + tiva3;

  tiva1 = 0;
  tiva3 = 0;
  prim = 0;
  |PARA xxq = 33; |SI xxq [ 42; |HACIENDO xxq = xxq + 1;
        yyq = xxq + 10;
        zzq = xxq + 20;
        |SI #3xxq = -1;  |SAL;  |FINSI;
        varnum1 = #3yyq;
        varnum2 = #3xxq;
        varnum3 = #3zzq;
        tiva1 = tiva1 + varnum1;
        tiva3 = tiva3 + varnum3;
        |SI prim = 0;
            descri1 = "*REC. DE EQ. REPERCUTIDO";
            descri2 = " =======================";
            swlin = 1;
            |PRINT;
            prim = 1;
        |FINSI;
        swlin = 2;
        |PRINT;
        sw_impr = 1;
  |SIGUE;
  |SI sw_impr ! 0;
      swlin = 3;
      |PRINT;
      sw_impr = 0;
  |FINSI;
  |SI #3#63 ! 0;|O #3#64 ! 0;
      swlin = 4;
      |PRINT;
  |FINSI;
  ttotal1 = tiva11 + #3#63 + #3#64;
  ttotal3 = ttotal3 + tiva3;
  bdr = tiva11;
  bnr = #3#63 + #3#64;
  cur = ttotal3;
  ttotal1 = 0;
  ttotal3 = 0;
|FPRC;

|PROCESO tipo3; |TIPO 3;
  |IMPRE 0;
  |SI FSalida ! 0;  |ACABA;  |FINSI;

  |INFOR informe;
  |SI FSalida ! 0; |FINIMP; |ACABA; |FINSI;

  |DDEFECTO #3;
  #3#0  = #0#2;  #3#1  = #0#3;
  #3#2  = #0#5;
  #3#65 = #0#0;  #3#66 = #0#1;
  #3#67 = #0#4;  #3#68 = #0#6;
  #3#69 = #0#73;
  #3#70 = #0#74; #3#71 = #0#75;

  |SI #0i_cm1 = "S";
      |BUCLE esdesde;
  |SINO;
      |HAZ esunaauna;
  |FINSI;
  |FININF;
  |FINIMP;
|FPRC;

|| ******************************** CALCULO
|PROCESO haztodo;
  enEmpresa = #canempre#2;
  enPeriodo = #canempre#3;
  swOperacion = 0;
  |SUB_EJECUTA "camoneda.tab";

  |PATH_DAT #1 dirfich0;
  |PATH_DAT #2 dirfich0;

  nSwIntra = 0;
  sw = 0;
  inver1 = #3#67;
  inver2 = #3#67;
  |SI #3#67 = "A"; inver1 = " "; inver2 = "z"; |FINSI;

  sw_impr = 0;
  |PDEFECTO #3,3,65;
  |SI #3#69 = 1; |BUCLE calisopo;   |FINSI;
  |SI #3#69 = 2; |BUCLE calisopo_2; |FINSI;
  |SI #3#69 = 3; |BUCLE calisopo_3; |FINSI;
  |SI sw = 1; |HAZ impre2; |FINSI;

  sw_impr = 0;
  |PDEFECTO #3,3,65;
  |SI #3#69 = 1; |BUCLE calirepe;   |FINSI;
  |SI #3#69 = 2; |BUCLE calirepe_2; |FINSI;
  |SI #3#69 = 3; |BUCLE calirepe_3; |FINSI;
  |SI sw = 2; |HAZ impre3; |FINSI;

  |SI #0#76 = "S";
      nSwIntra = 1;
      sw_impr  = 0;
      |ABRE #4;
      |PDEFECTO #3,3,65;
      |SI #3#69 = 1; |BUCLE calisopo;   |FINSI;
      |SI #3#69 = 2; |BUCLE calisopo_2; |FINSI;
      |SI #3#69 = 3; |BUCLE calisopo_3; |FINSI;
      |SI sw = 1; |HAZ impre4; |FINSI;
      |CIERRA #4;
  |FINSI;

  |SI sw ! 0;  |PIEINF;  |FINSI;

  ttotal1 = 0;
  ttotal3 = 0;
|FPRC;
|| **************************************************************************
