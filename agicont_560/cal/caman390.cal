|FICHEROS;
  caman390 #0;
  caman300 #1;
  caportad #2;
|FIN;

|VARIABLES;
  swant = 0;
  modo = 0;
  anyo = 0;
  compens = 0;
     letrasnif = "TRWAGMYFPDXBNJZSQVHLCKE";
     letra = "";
     alfa1 = "";
     alfa2 = "";
     final = "";
     x = "";
     nume1 = 0;
     nume2 = 0;
     lugar = 0;
     nifnum = 0;
     resto = 0;
|FIN;

|INCLUYE acceso_i;

|PROCESO mayor;
  alfa1 = #0Campo > " ";
  #0Campo = alfa1;
  |PINTA #0Campo;
|FPRC;

|PROCESO letra_0;  |TIPO 6;
  |SI FSalida ! 9;  |ACABA;  |FINSI;

  alfa1 = #0Campo;   |QBT alfa1;
  x    = alfa1 % 101;
  |SI x ! "A"; |Y x ! "B"; |Y x ! "C"; |Y x ! "D"; |Y x ! "E"; |Y x ! "F";
   |Y x ! "G"; |Y x ! "P"; |Y x ! "Q"; |Y x ! "S"; |Y x ! "X";
      final = "";
      alfa2 = alfa1 % 0;
      nume1 = alfa2;
      |PARA nume2 = 1;  |SI nume2 [ nume1;  |HACIENDO nume2 = nume2 + 1;
            lugar = (nume2 * 100) + 1;
            alfa2 = alfa1 % lugar;
            |SI alfa2 = "0"; |O alfa2 = "1";|O alfa2 = "2"; |O alfa2 = "3";
             |O alfa2 = "4"; |O alfa2 = "5";|O alfa2 = "6";
             |O alfa2 = "7"; |O alfa2 = "8";|O alfa2 = "9";
                final = final + alfa2;
            |FINSI;
      |SIGUE;
      nifnum = final;
      |SI nifnum ! 0; |Y final ! "";
          resto   = nifnum $ 23;
          resto   = resto + 1;
          lugar   = (resto * 100) + 1;
          letra   = letrasnif % lugar;
          final   = ("000000000" + final + letra) % -109;
          #0Campo = final;
      |FINSI;
   |SINO;
      |MENAV "    ATENCION !!! No se calcular un C.I.F. ...";
   |FINSI;
   |PINTA #0Campo;
|FPRC;


|PROCESO def_any; |TIPO 7;
  #0#0 = #30#26;
  |PINTA #0#0;
|FPRC;

|PROCESO carga_390;
  |SI #1#1 = 1;
      |SI swant = 1; compens = #1#29; #0#89 = compens; |FINSI;
  |FINSI;
  #0#1 = ~;
  |HAZ suma_bases;
  |HAZ deduccion;
  |HAZ resto;
|FPRC;

|PROCESO resto;
  #0#99 = #0#99 + #1#33;        ||Total a Ingresar
  #0#101 = #1#32;      ||A Compensar
  #0#102 = #1#31;      ||A Devolver
  #0#103 = #0#103 + #1#5 + #1#8 + #1#11;  ||Operaciones Regimen General
  #0#110 = #0#110 + #1#34;      ||Op Regimen Simplificado     (80)
  #0#105 = #0#105 + #1#38;      ||Op AGP                      (81)
  #0#106 = #0#106 + #1#39;      ||Rec Equivalencia            (82)
  #0#104 = #0#104 + #1#35;      ||Entregas intracomun.        (83)
  #0#114 = #0#114 + #1#36;      ||Op Exentas con deduccion    (84)
  #0#115 = #0#115 + #1#37;      ||Op Exentas sin deduccion    (85)
  #0#107 = #0#107 + #1#40;      ||Entrega bienes, financieros (86)
  #0#108 = #0#108 + #1#41;      ||Entraga bienes Inversion    (87)
  #0#109 = #0#109 + #1#42;      ||Total Volumen               (88)

  #0#111 = #0#111 + #1#52;      || punto 89
  #0#132 = #0#132 + #1#53;      || punto 90
  #0#133 = #0#133 + #1#59;      || punto 91
  #0#134 = #0#134 + #1#56;      || punto 92
  #0#135 = #0#135 + #1#57;      || punto 93
|FPRC;

|PROCESO deduccion;
  #0#80 = #0#80 + #1#21;        ||Bienes y servicios corrientes (INT.)
  #0#81 = #0#81 + #1#43;        ||Bienes de Inversion (INT.)
  #0#82 = #0#82 + #1#22;        ||Bienes Corrientes (IMP.)
  #0#83 = #0#83 + #1#44;        ||Bienes Inversion (IMP.)
  #0#130 = #0#130 + #1#51;      ||Bienes Corrientes (Adq.intrac.)
  #0#131 = #0#131 + #1#58;      ||Bienes de inversion (Adq.intrac.)

  #0#84 = #0#84 + #1#23;        ||Compensacion AGP
  #0#85 = #0#85 + #1#24;        ||Regularizacion Inversiones

  #0#86 = #0#86 + #1#21 + #1#43 + #1#22 + #1#44 + #1#51 + #1#23 + #1#24 + #1#58; || TOTAL
|FPRC;

|PROCESO suma_bases;
  |SI #2#73 ! 4; || ..........  no es de viajeros
      #0#68 = #0#68 + #1#5;              ||BASES
      #0#69 = #0#69 + #1#8;
      #0#70 = #0#70 + #1#11;
      #0#71 = #0#71 + #1#49;

      #0#72 = #0#72 + #1#7;              ||CUOTAS
      #0#73 = #0#73 + #1#10;
      #0#74 = #0#74 + #1#13;
      #0#75 = #0#75 + #1#50;
  |SINO;
      #0#70 = #0#70 + #1#11;         ||Solamente para la actividad 4
      #0#74 = #0#74 + #1#13;
      #0#71 = #0#71 + #1#49;
      #0#75 = #0#75 + #1#50;
  |FINSI;
  #0#116 = #0#116 + #1#14;           ||RECARGOS BASES
  #0#117 = #0#117 + #1#17;
  #0#126 = #0#126 + #1#46;
  #0#118 = #0#118 + #1#16;
  #0#119 = #0#119 + #1#19;           ||RECARGO IVA
  #0#127 = #0#127 + #1#48;

  #0#76 = #0#76 + #1#5 + #1#8 + #1#11 + #1#49;      ||TOTAL BASES
  #0#77 = #0#77 + #1#7 + #1#10 + #1#13 + #1#50;     ||TOTAL IVA
  #0#112 = #0#112 + #1#16 + #1#19 + #1#48 ;    ||TOTAL Recargo

  #0#78 = #0#78 + #1#48 + #1#19 + #1#16 + #1#7 + #1#10 + #1#13 + #1#50;  ||IVA+REC
|FPRC;

|PROCESO carga_bas;
  |SI #2#73 = 1;
       #0#79 = "Regimen Ordinario";
  |FINSI;
  |SI #2#73 = 2;
      #0#79 = "Regimen Especial Bienes Usados";
  |FINSI;
  |SI #2#73 = 3;
      #0#79 = "Regimen Especial Obj. Arte ...";
  |FINSI;
  |SI #2#73 = 4;
      #0#79 = "Regimen Esp. Agencias de Viaje";
  |FINSI;
  |SI #2#73 = 5;
      #0#79 = "Regimen Esp. Det. Proporcional";
  |FINSI;
|FPRC;

|DEFBUCLE carga;
#1#1;
;
" " ,  0 , anyo;
"z" , 12 , anyo;
e;
NULL , carga_390;
|FIN;

|PROCESO alta; || inicio del programa ................
  modo = (FEntrada / 100) ! 0;
  |SI modo ! 1;  |ACABA;  |FINSI;
  anyo = #0#0;
  |LEE 001#0=;
  |SI FSalida = 0;
      |AVISO;
      |CONFI "2400NEl Modelo 390 ya esta calculado, Recalcular : ";
      |SI FSalida = 0;
          |BORRA 020#0a;
      |SINO;
           |ERROR;
           |ACABA;
      |FINSI;
  |FINSI;
  |HAZ lee_ant;  || busca el a¤o anterior
  |DDEFECTO #0;
  #0#0 = anyo;
  #0#89 = compens;
  |HAZ mira_fijo; || lee datos de hacienda
  #0#5 = #2#20;   #0#6 = #2#21;   #0#7 = #2#22;   #0#8 = #2#23;   #0#9 = #2#24;
  #0#10 = #2#25;  #0#11 = #2#26;  #0#12 = #2#27;  #0#13 = #2#28;  #0#14 = #2#29;
  #0#15 = #2#30;  #0#16 = #2#31;  #0#17 = #2#32;  #0#18 = #2#33;  #0#19 = #2#34;
  #0#20 = #2#35;  #0#21 = #2#36;  #0#22 = #2#37;  #0#42 = #2#38;  #0#43 = #2#39;
  #0#44 = #2#40 +  " " +  #2#41;
  #0#45 = #2#42;  #0#46 = #2#43;  #0#47 = #2#44;  #0#48 = #2#45;  #0#49 = #2#46;
  #0#50 = #2#49;  #0#51 = #2#50;  #0#52 = #2#80;  #0#53 = #2#51;  #0#54 = #2#52;
  #0#55 = #2#53;  #0#56 = #2#54;  #0#57 = #2#55;  #0#58 = #2#56;  #0#59 = #2#57;
  #0#60 = #2#58;  #0#61 = #2#59;  #0#62 = #2#60;  #0#63 = #2#61;  #0#64 = #2#62;
  #0#65 = #2#63;  #0#66 = #2#64;  #0#67 = #2#65;
  #0#2 = #2#11;
  |HAZ carga_bas; || carga #0#79
  |BUCLE carga;
  |HAZ fin_carga;
  |PINDA #0#0;
|FPRC;

|PROCESO fin_carga;
  #0#87 = #0#78 - #0#86;
  #0#88 = #0#87;
  #0#90 = #0#88 - #0#89;
  #0#91 = #2#72;      ||Territorio Comun
  #0#92 = #2#75;      ||Alava
  #0#93 = #2#77;      ||Guipuzcoa
  #0#94 = #2#76;      ||Vizcaya
  #0#95 = #2#74;      ||Navarra
  #0#96 = #0#88 * #0#91/100;
  #0#97 = #0#89 * #0#91/100;
  #0#120 = #1#0;
  #0#98 = #0#96 - #0#97;
|FPRC;

|PROCESO mira_fijo; || lee datos de hacienda
  |ABRE #2;
  #2#0 = #30#2;
  #2#1 = #30#26;
  |LEE 001#2=;
  |SI FSalida ! 0;
      |MENAV "0000No se encuentra el fichero Portadas Modelos";
      |ERROR;
  |FINSI;
  |CIERRA #2;
|FPRC;

|PROCESO lee_ant;
  compens = 0;
  swant = 0;
  anyo = anyo - 1;
  |LEE 001#0=;
  |SI FSalida = 0;
      compens = compens + #0#101;        ||Compensar anterior
  |SINO;
      swant = 1;
  |FINSI;
  anyo = anyo + 1;
|FPRC;

|PROCESO sum;
  #0#76 = #0#68 + #0#69 + #0#70 + #0#71 - #0#121;       ||Total Bases
  #0#77 = #0#72 + #0#73 + #0#74 + #0#75 - #0#122;       ||Total Iva
  #0#112 = #0#118 + #0#119 + #0#127 - #0#129;           ||Total Rec
  #0#78 = #0#112 + #0#77;         ||Total Iva + Rec.
  #0#87 = #0#78 - #0#86;                       ||Total Regimen General
  |PINTA #0#76;
  |PINTA #0#77;
  |PINTA #0#112;
  |PINTA #0#78;
  |PINTA #0#87;
  #0#88 = #0#87;
|FPRC;

|PROCESO ded;
  #0#86 = #0#80 + #0#81 + #0#82 + #0#83 + #0#130 + #0#131 + #0#84 + #0#85;
  |PINTA #0#86;
  #0#87 = #0#78 - #0#86;                       ||Total Regimen General
  #0#88 = #0#87;
  |PINTA #0#87;
|FPRC;

|PROCESO liq;
  #0#90 = #0#88 - #0#89;
  |PINTA #0#90;
|FPRC;

|PROCESO terr;
  #0#98 = #0#96 - #0#97;
  |PINTA #0#98;
|FPRC;

|PROCESO vol;
  #0#109=#0#103+#0#110+#0#104+#0#114+#0#115+#0#105+#0#106-#0#107-#0#108;
  |PINTA #0#109;
|FPRC;
