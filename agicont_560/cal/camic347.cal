|FICHEROS;
  camic347 #0;
  camil347 #1;
  eosclipr #2,MANTE;
  cautm347 #3;
  agipobla #4;
  agiprovi #5;
  caclipro #6;
  canempre #30;
  agicontr #23;

  camac347 #7;
  camal347 #8;
|FIN;

|VARIABLES;
 mod       = 0;
 men1      = "0000SEs correcto S/N : ";
 men2      = "0000NLo Grabo en el Fichero General : ";
 men6      = "    NConfirma el Alta en Fichero General (S/N): ";
 error1    = "     La empresa no tiene impreso del 347 ";
 verrfec   = "0000ATENCION !! Fecha erronea o formato incorrecto ";
 vdia1     = "";
 vme1      = "";
 vany1     = "";
 vdia      = 0;
 vme       = 0;
 vany      = 0;
 vtope     = 0;
 vsw       = 0;
 vfec      = "";
 vblanco   = "          ";
 vpuntos   = "..........";
 v         = 0;
 SwError   = 0;
 Flag      = 0;
 Linea     = 0;
 vacio     = "                                        ";
 cliente   = "";
 cuarenta  = "                                        ";

     letrasnif = "TRWAGMYFPDXBNJZSQVHLCKE";
     letra = "";
     alfa1 = "";
     alfa2 = "";
     final = "";
     x = "";
     nume1 = 0;
     nume2 = 0;
     lugar = 0;
     nifnum = 0;
     resto = 0;

 &elcampo0 = "";
 &elcampo1 = "";
 &elcampo2 = "";
 &elcampo3 = "";
 &elcampo4 = "";
 &elcampo5 = "";
 &elcampo6 = "";
 &elcampo7 = "";
 &elcampo8 = 0;
 &elcampo9 = 0;
 &elcampo10= "";
 &elcampo11= "";
 &swentra  = 0;
 &swmodi   = 0;
 swmod   = 0;
 directo = "";
 direct1 = "";
 traba = "";
 dprocli = "";
 eselbase = "";
 salida = 0;
   &aste = "";
   agi = "";
   &agi1 = "";
   &agi2 = "";
   num = 0;
   longi = "";
|FIN;

|INCLUYE acceso_i;

|PROCESO alentrar;  |TIPO 8;
  |HAZ inicio;
  |HAZ tipo_8; || comprueba la existencia de la ficha general
  |SI aste ! "*";
      |PATH_DAT #2 agi1;
      |PATH_DAT #4 agi1;
      |PATH_DAT #5 agi1;

      |PATH_PAN #2 agi2;
      |PATH_PAN #4 agi2;
      |PATH_PAN #5 agi2;
  |FINSI;
|FPRC;

|PROCESO antesque;  |TIPO 7;
  |ABRE #30;
  #30#2 = cod1;
  #30#3 = cod2;
  |LEE 040#30=;
  #0#0 = #30#2;
  #0#1 = #30#1;
  #0#4 = #30#26;
  |PINTA #0#0;
  |PINTA #0#1;
  |CIERRA #30;
|FPRC;

|PROCESO despuesde;
  |SI #0#0 ! cod1;
      |ERROR;
      #0#0 = cod1;
      |PINTA #0#0;
      |ACABA;
  |FINSI;
|FPRC;

|PROCESO conficha;
  |SI aste ! "*";
      |ABRE #2;
      |PUSHV 0501 2380;
      |PINPA #0#2;
      #2#0 = #1#2;
      |LEE 000#2];
      |CONSULTA #0#2;
      #1#2 = #2#0;
      |CIERRA #2;
  |SINO;
      |ABRE #6;
      |SELECT #4#6;
      |PUSHV 0501 2380;
      |PINPA #0#6;
      #6#9 = #1#2;
      |LEE 000#6=;
      |CONSULTA #3#6;
      #1#2 = #6#9;
      |CIERRA #6;
  |FINSI;
      |POPV;
      |PINTA #1#2;
|FPRC;

|PROCESO cliente;
  salida = FSalida;
  |SI salida = 9;  |HAZ letra_0;  |FINSI;
  |SI salida = 10; |HAZ conficha; |FINSI;

  |ABRE #3;
  |DDEFECTO #3;
  swmodi = 0;
  swmod  = 0;

|SI aste ! "*"; |Y #1#2 ! "            ";
    |ABRE #2;
    #2#0 = #1#2;
    |LEE 040#2=;
    |SI FSalida = 0;
        #1#3  = #2#1; #1#5  = #2#2; #1#6  = #2#3;
        #1#7  = #2#4; #1#9  = #2#5; #1#10 = #2#6;
        #1#11 = #2#7; #1#12 = #2#8; #1#13 = #2#9;
        #1#14 = #2#10;
        swmod = 1;
    |SINO;
        |HAZ altaclipr;
    |FINSI;
    |CIERRA #2;
|FINSI;
|SI swmod = 0;
    |ABRE #6;
    |SELECT #4#6;
    |DDEFECTO #6;
    #6#9 = #1#2;
    |LEE 040#6=;
    |SI FSalida = 0;
        #1#3 = #6#1; #1#6  = #6#2; #1#11 = #6#3;
        #1#12 = #6#4; #1#13 = #6#5; #1#14 = #6#6;
    |FINSI;
    |CIERRA #6;
|FINSI;
 |HAZ cargavar;
 |SI swentra = 1;
     |HAZ recovar;
     |SI aste ! "*"; |Y swmodi = 0;
         |CONFI men2;
         |SI FSalida = 0; |HAZ grabagen; |FINSI;
     |FINSI;
 |SINO;
     |ERROR;
 |FINSI;
|PINTA #1#3;
|CIERRA #3;
|FPRC;

|PROCESO grabagen;
   |ABRE #2;
   #2#0 = #1#2;
   |LEE 040#2=;
   salida = FSalida;
   |SI salida ! 0; |DDEFECTO #2; |FINSI;
   #2#0 = #1#2;  #2#1 = #1#3;  #2#2 = #1#5;
   #2#3 = #1#6;  #2#4 = #1#7;  #2#5 = #1#9;
   #2#6 = #1#10; #2#7 = #1#11; #2#8 = #1#12;
   #2#9 = #1#13; #2#10 = #1#14;
   |SI salida ! 0;
       |GRABA 040#2n;
   |SINO;
       |GRABA 040#2a;
   |FINSI;
   |LIBERA #2;
   |CIERRA #2;
|FPRC;

|PROCESO cargavar;
  swentra  = 0;
  elcampo0 = #1#2;
  elcampo1 = #1#3;
  elcampo2 = #1#5;
  elcampo3 = #1#6;
  elcampo4 = #1#7;
  elcampo5 = #1#8;
  elcampo6 = #1#9;
  elcampo7 = #1#10;
  elcampo8 = #1#11;
  elcampo9 = #1#12;
  elcampo10 = #1#13;
  elcampo11 = #1#14;
  |SUB_EJECUTA "cautm347.tab";
|FPRC;

|PROCESO recovar;
  #1#2  = elcampo0; elcampo0 = "";
  #1#3  = elcampo1; elcampo1 = "";
  #1#5  = elcampo2; elcampo2 = "";
  #1#6  = elcampo3; elcampo3 = "";
  #1#7  = elcampo4; elcampo4 = "";
  #1#8  = elcampo5; elcampo5 = "";
  #1#9  = elcampo6; elcampo6 = "";
  #1#10 = elcampo7; elcampo7 = "";
  #1#11 = elcampo8; elcampo8 = 0;
  #1#12 = elcampo9; elcampo9 = 0;
  #1#13 = elcampo10; elcampo10 = "";
  #1#14 = elcampo11; elcampo11 = "";
|FPRC;

|PROCESO BuscaDecl;
   SwError = 1;
|FPRC;

|DEFBUCLE BuscaDecl;
#camal347#1;
3,14,5;
#camil347#0,001,#camil347#2,"S",#camil347#4;
#camil347#0,999,#camil347#2,"S",#camil347#4;
;
NULL,BuscaDecl;
|FIN;

|PROCESO RecalculaCab;
   |SI #camal347#2 = "2";
      #camac347#6 = #camac347#6 + 1;
      #camac347#7 = #camac347#7 + #camal347#5;
   |FINSI;

   |SI #camal347#2 = "1";
      #camac347#8 = #camac347#8 + 1;
      #camac347#9 = #camac347#9 + #camal347#5;
   |FINSI;

   |SI #camal347#2 = "3";
      #camac347#10 = #camac347#10 + 1;
      #camac347#11 = #camac347#11 + #camal347#5;
   |FINSI;

   |SI #camal347#2 = "4";
      #camac347#12 = #camac347#12 + 1;
      #camac347#13 = #camac347#13 + #camal347#5;
   |FINSI;

   |SI #camal347#2 = "5";
      #camac347#14 = #camac347#14 + 1;
      #camac347#15 = #camac347#15 + #camal347#5;
   |FINSI;

|FPRC;

|DEFBUCLE RecalculaCab;
#camal347#1;
;
#camac347#0,001;
#camac347#0,999;
;
NULL,RecalculaCab;
|FIN;

|PROCESO actualiz; |TIPO 2;
      #0#2 = #0#2 +. 1;
      #0#3 = #0#3 +. #1#4;
      |PINTA #0#2;
      |PINTA #0#3;

      Flag = 0 +. 1;
      |SI Flag > 0;
         SwError = 0;
         |SALVA_FICHA #camil347;
         |BUCLE BuscaDecl;
         |SI SwError = 0;
            |ABRE #camac347; |ABRE #camal347;
            |ABRE #camic347; |ABRE #camil347;
            #camac347#0 = #camic347#0;
            |LEE 101#camac347.=;
            |SI FSalida = 0;
               #camal347#0 = #camac347#0;
               #camal347#1 = 1;
               |LEE 000#camal347.];
               |SI FSalida = 0; |Y #camal347#0 = #camac347#0;
                  |PARA; |SI FSalida = 0; |Y #camal347#0 = #camac347#0; |HACIENDO;
                     Linea = #camal347#1 + 1;
                     |LEE 000#camal347.s;
                  |SIGUE;
               |SINO;
                  Linea = 1;
               |FINSI;
               |DDEFECTO #camal347;
               #camal347#0  = #camac347#0;
               #camal347#1  = Linea;
               |GRABA 020#camal347.b;
               #camal347#2  = "1";
               #camal347#3  = #camil347#2;
               #camal347#4  = #camil347#3;
               #camal347#5  = #camil347#4;
               #camal347#6  = #camil347#5;
               #camal347#7  = #camil347#6;
               #camal347#8  = #camil347#7;
               #camal347#9  = #camil347#11;
               #camal347#10 = #camil347#12;
               #camal347#11 = #camil347#13;
               #camal347#12 = #camil347#14;
               #camal347#13 = "N";
               #camal347#14 = "S";
               #camal347#15 = "N";
               |GRABA 020#camal347.a; |LIBERA #camal347;

               #camac347#6  = 0; #camac347#7  = 0;
               #camac347#8  = 0; #camac347#9  = 0;
               #camac347#10 = 0; #camac347#11 = 0;
               #camac347#12 = 0; #camac347#13 = 0;
               #camac347#14 = 0; #camac347#15 = 0;
               |BUCLE RecalculaCab;
               |GRABA 020#camac347.a; |LIBERA #camac347;

               |CIERRA #camil347; |CIERRA #camic347;
               |CIERRA #camal347; |CIERRA #camac347;
            |FINSI;
         |FINSI;
         |SALVA_FICHA #camil347;
      |FINSI;
|FPRC;

|PROCESO letra_0;  |TIPO 6;
  |SI FSalida ! 9;  |ACABA;  |FINSI;

  alfa1 = #1Campo;   |QBT alfa1;
  x    = alfa1 % 101;
  |SI x ! "A"; |Y x ! "B"; |Y x ! "C"; |Y x ! "D"; |Y x ! "E"; |Y x ! "F";
   |Y x ! "G"; |Y x ! "P"; |Y x ! "Q"; |Y x ! "S"; |Y x ! "X";
      final = "";
      alfa2 = alfa1 % 0;
      nume1 = alfa2;
      |PARA nume2 = 1;  |SI nume2 [ nume1;  |HACIENDO nume2 = nume2 + 1;
            lugar = (nume2 * 100) + 1;
            alfa2 = alfa1 % lugar;
            |SI alfa2 = "0"; |O alfa2 = "1";|O alfa2 = "2"; |O alfa2 = "3";
             |O alfa2 = "4"; |O alfa2 = "5";|O alfa2 = "6";
             |O alfa2 = "7"; |O alfa2 = "8";|O alfa2 = "9";
                final = final + alfa2;
            |FINSI;
      |SIGUE;
      nifnum = final;
      |SI nifnum ! 0; |Y final ! "";
          resto   = nifnum $ 23;
          resto   = resto + 1;
          lugar   = (resto * 100) + 1;
          letra   = letrasnif % lugar;
          final   = ("000000000" + final + letra) % -109;
          #1Campo = final;
      |FINSI;
   |SINO;
      |MENAV "    ATENCION !!! No se calcular un C.I.F. ...";
   |FINSI;
   |PINTA #1Campo;
|FPRC;

|PROCESO tipo_8; || control de la ficha de clientes general
  |DIRECTORIO agi;
  |QBF agi;
  |PATH_DAT #23 agi;

|ABRE #23;
#23#0 = 1;
|LEE 040#23=;
|SI FSalida ! 0; aste = "*"; |CIERRA #23; |ACABA; |FINSI;
|CIERRA #23;
aste = #23#7;
|QBF aste;
|SI aste  = "*"; |ACABA; |FINSI;

agi1 = #23#8; |QBF agi1;

longi = agi1 % 0;
num   = longi;
num   = 100 + (num - 5);
longi = num;

agi2  = (agi1 % longi) + "pan/";
|FPRC;

|PROCESO altaclipr;
|SI aste = "*"; |ACABA; |FINSI;
    |CONFI men6;
    |SI FSalida = 0;
        |PUSHV 0501 2380;
        |PINPA #0#2;
        |DDEFECTO #2;
        |PINDA #0#2;
        #2#0 = #1#2;
        |PINTA #2#0;
        |ENDATOS #1#2;
        |SI FSalida = 0;
            |POPV;
            #1#3 = #2#1; #1#5  = #2#2; #1#6  = #2#3; #1#7  = #2#4;
            #1#11 = #2#7; #1#12 = #2#8; #1#11 = #2#9; #1#12 = #2#10;
            swmodi=1; swmod = 1;
            |GRABA 020#2n;                 || Graba el agicli
        |SINO;
            |POPV;
        |FINSI;
    |FINSI;
|LIBERA #2;
|CIERRA #2;
|FPRC;
