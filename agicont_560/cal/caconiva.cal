|FICHEROS;
    caconiva #0;
    caivarep #1;    || repercutido
    caivasop #2;    || soportado
    camaasic #3;    || apuntes cabs.
    camaasil #4;    || apuntes lins.
    cacuenta #5;    || Plan Contable
|FIN;

|VARIABLES;
    nume1 = 0;
    nume2 = 0;
    nume3 = 0;
    nume4 = 0;

    FEstado = 0;
    seleccio = 0;
    modo = 0;
    sw_rup = 0;

    &e = "";
    base = 0;
    porc = 0;
    cuot = 0;
    punt = 0;
    swerr = 0;

    tipo  = "";
    serie = "";
    factu = 0;
    libro = 0;

    diari = 0;
    docum = 0;
    fecha = @;

    cuenta = "";
    digito = 0;
    nivel  = 0;
    cta    = "";
    long   = "";
|FIN;

|INCLUYE acceso_i;

|PROCESO mayus; |TIPO 0;
 #0Campo = #0Campo > #0Campo;
 |PINTA #0Campo;
|FPRC;

|| ___________________________________/ Busca en Apuntes

|PROCESO busl1;
  |SI #4#12 = tipo; |Y #4#13 = libro; |Y #4#14 = factu; |Y #4#15 = serie;
      swerr = 0;
      |ERROR10;
  |FINSI;
|FPRC;

|DEFBUCLE buslin1;
 #4#1;
 ;
 diari, fecha, docum, 0001;
 diari, fecha, docum, 9999;
 e;
 NULL, busl1;
|FIN;

|PROCESO b_asiento;
  swerr = 0;

  |SI docum = 0;
      swerr =  1;
      e = "Asiento Inexistente. Documento Igual a <000000>";
      |PRINT;
      |ACABA;
  |FINSI;

  #3#0 = diari;
  #3#1 = fecha;
  #3#2 = docum;
  |LEE 000#3=;
  |SI FSalida ! 0;
      swerr =  1;
      e = "Asiento Inexistente";
      |PRINT;

      libro = 0;
      fecha = "01.01.0001";
      docum = 0;
  |SINO;
      swerr = 1;
      |BUCLE buslin1;  || Busca el Numero de Factura
      |SI swerr = 1;
          e = "Asto. Contable informado no corresponde a la Fra.";
          |PRINT;
          libro = 0;
          fecha = "01.01.0001";
          docum = 0;
      |FINSI;
  |FINSI;
|FPRC;

|PROCESO b_cuenta;
  cta = cuenta;
  |QBF cta;           || Cuenta Contable
  |SI cta = "";
      e = "CUENTA CONTABLE EN BLANCO";
      |PRINT;
  |SINO;
      nivel = 0;
      long  = cta % 0;
      nume1 = long;
      |SI nume1 = dig4; nivel = 1; |FINSI;
      |SI nume1 = dig5; nivel = 2; |FINSI;
      |SI nume1 = dig6; nivel = 3; |FINSI;
      |SI nume1 = dig7; nivel = 4; |FINSI;
      |SI nume1 = dig8; nivel = 5; |FINSI;
      |SI nume1 = dig9; nivel = 6; |FINSI;
      |SI nivel = 0;
          e = "CUENTA CONTABLE FUERA DE NIVEL";
          |PRINT;
      |SINO;
          |SI nivel ! digito;
              e = "CUENTA CONTABLE CON NIVEL ERRONEO";
              |PRINT;
          |FINSI;
      |FINSI;
  |FINSI;
  #5#0 = cuenta;
  #5#1 = digito;
  |LEE 001#5=;
  |SI FSalida ! 0;
      e = "NO EXISTE CUENTA CONTABLE";
      |PRINT;
  |SINO;
      |SI #5#3 = "N";
          e = "CUENTA CONTABLE SIN ASIENTO DIRECTO";
          |PRINT;
      |FINSI;
  |FINSI;
|FPRC;

____________________________________/   SOPORTADO
|PROCESO total_sop;
    nume1 = #2#8  + #2#9  + #2#10 + #2#52 + #2#53;
    nume2 = #2#14 + #2#15 + #2#16 + #2#56 + #2#57;
    nume3 = #2#20 + #2#21 + #2#22 + #2#60 + #2#61;
    nume4 = nume1 + nume2 + nume3;
|FPRC;

|PROCESO c_sop2;

    nume1 = (base % porc) ! EURODB;

    nume2 = nume1 - cuot;     |SI nume2 < 0; nume2 = nume2 * -1; |FINSI;

|SI nume2 > #0#2;
    |SI punt =  1;  e = "IVA 1";        #2#14 = nume1; |FINSI;
    |SI punt =  2;  e = "IVA 2";        #2#15 = nume1; |FINSI;
    |SI punt =  3;  e = "IVA 3";        #2#16 = nume1; |FINSI;
    |SI punt =  4;  e = "IVA 4";        #2#56 = nume1; |FINSI;
    |SI punt =  5;  e = "IVA 5";        #2#57 = nume1; |FINSI;
    |SI punt =  6;  e = "Recargo 1";    #2#20 = nume1; |FINSI;
    |SI punt =  7;  e = "Recargo 2";    #2#21 = nume1; |FINSI;
    |SI punt =  8;  e = "Recargo 3";    #2#22 = nume1; |FINSI;
    |SI punt =  9;  e = "Recargo 4";    #2#60 = nume1; |FINSI;
    |SI punt = 10;  e = "Recargo 5";    #2#61 = nume1; |FINSI;
        e = "Error en " + e;
    |PRINT;
    |HAZ total_sop;
|FINSI;
|FPRC;

|PROCESO c_sop1;
 |HAZ total_sop;
 nume2 = nume4 - #2#26;
 |SI nume2 < 0; nume2 = nume2 * -1; |FINSI;

 |SI nume2 > #0#2;
     e = "Error en Importe Total";
     |PRINT;
 |FINSI;
|FPRC;

|PROCESO lee_sopor1;
    #0#3 = "IVA Soportado  ";      |PINTA #0#3;
    #0#4 = #2#0;                   |PINTA #0#4;
    #0#5 = #2#2;                   |PINTA #0#5;
    #0#6 = "  ";

 |HAZ c_sop1;             || total factura

    base = #2#8;    porc = #2#11;  cuot = #2#14;  punt =  1;|HAZ c_sop2;
    base = #2#9;    porc = #2#12;  cuot = #2#15;  punt =  2;|HAZ c_sop2;
    base = #2#10;   porc = #2#13;  cuot = #2#16;  punt =  3;|HAZ c_sop2;
    base = #2#52;   porc = #2#54;  cuot = #2#56;  punt =  4;|HAZ c_sop2;
    base = #2#53;   porc = #2#55;  cuot = #2#57;  punt =  5;|HAZ c_sop2;

    base = #2#8;    porc = #2#17;  cuot = #2#20;  punt =  6;|HAZ c_sop2;
    base = #2#9;    porc = #2#18;  cuot = #2#21;  punt =  7;|HAZ c_sop2;
    base = #2#10;   porc = #2#19;  cuot = #2#22;  punt =  8;|HAZ c_sop2;
    base = #2#52;   porc = #2#58;  cuot = #2#60;  punt =  9;|HAZ c_sop2;
    base = #2#53;   porc = #2#59;  cuot = #2#61;  punt = 10;|HAZ c_sop2;

    tipo = "S";
    libro = #2#0;
    factu = #2#2;
    serie = #2#27;
    diari = #2#45;
    fecha = #2#46;
    docum = #2#47;
    cuenta = #2#4;
    digito = #2#5;
    |HAZ b_asiento;        || existencia asiento
    |HAZ b_cuenta;

  |SI #1#6 = 0;                   || Concepto
      e = "CONCEPTO AUTOMATICO IGUAL A CERO";
      |PRINT;
  |FINSI;

 |SI #0#1 = "S";
    |HAZ total_sop; #2#26 = nume4;
    |GRABA 020#2a;
 |FINSI;
 |LIBERA #2;
|FPRC;

|DEFBUCLE lee_sopor;
 #2#1;
 ;
  1,      1, "  ";
 99, 999999, "zz";
 be;
 NULL, lee_sopor1;
|FIN;
____________________________________/   REPERCUTIDO
|PROCESO total_rep;
    nume1 = #1#8  + #1#9  + #1#10 + #1#52 + #1#53;
    nume2 = #1#14 + #1#15 + #1#16 + #1#56 + #1#57;
    nume3 = #1#20 + #1#21 + #1#22 + #1#60 + #1#61;
    nume4 = nume1 + nume2 + nume3;
|FPRC;

|PROCESO c_rep2;

    nume1 = (base % porc) ! EURODB;

    nume2 = nume1 - cuot;     |SI nume2 < 0; nume2 = nume2 * -1; |FINSI;

|SI nume2 > #0#2;
    |SI punt =  1;  e = "IVA 1";        #1#14 = nume1; |FINSI;
    |SI punt =  2;  e = "IVA 2";        #1#15 = nume1; |FINSI;
    |SI punt =  3;  e = "IVA 3";        #1#16 = nume1; |FINSI;
    |SI punt =  4;  e = "IVA 4";        #1#56 = nume1; |FINSI;
    |SI punt =  5;  e = "IVA 5";        #1#57 = nume1; |FINSI;
    |SI punt =  6;  e = "Recargo 1";    #1#20 = nume1; |FINSI;
    |SI punt =  7;  e = "Recargo 2";    #1#21 = nume1; |FINSI;
    |SI punt =  8;  e = "Recargo 3";    #1#22 = nume1; |FINSI;
    |SI punt =  9;  e = "Recargo 4";    #1#60 = nume1; |FINSI;
    |SI punt = 10;  e = "Recargo 5";    #1#61 = nume1; |FINSI;
        e = "Error en " + e;
    |PRINT;
    |HAZ total_rep;
|FINSI;
|FPRC;

|PROCESO c_rep1;
 |HAZ total_rep;
 nume2 = nume4 - #1#26;
 |SI nume2 < 0; nume2 = nume2 * -1; |FINSI;

 |SI nume2 > #0#2;
     e = "Error en Importe Total";
     |PRINT;
 |FINSI;
|FPRC;

|PROCESO lee_reper1;
    #0#3 = "IVA Repercutido";      |PINTA #0#3;
    #0#4 = #1#0;                   |PINTA #0#4;
    #0#5 = #1#2;                   |PINTA #0#5;
    #0#6 = #1#27;                  |PINTA #0#6;

    |HAZ c_rep1;             || total factura

    base = #1#8;    porc = #1#11;  cuot = #1#14;  punt =  1;|HAZ c_rep2;
    base = #1#9;    porc = #1#12;  cuot = #1#15;  punt =  2;|HAZ c_rep2;
    base = #1#10;   porc = #1#13;  cuot = #1#16;  punt =  3;|HAZ c_rep2;
    base = #1#52;   porc = #1#54;  cuot = #1#56;  punt =  4;|HAZ c_rep2;
    base = #1#53;   porc = #1#55;  cuot = #1#57;  punt =  5;|HAZ c_rep2;

    base = #1#8;    porc = #1#17;  cuot = #1#20;  punt =  6;|HAZ c_rep2;
    base = #1#9;    porc = #1#18;  cuot = #1#21;  punt =  7;|HAZ c_rep2;
    base = #1#10;   porc = #1#19;  cuot = #1#22;  punt =  8;|HAZ c_rep2;
    base = #1#52;   porc = #1#58;  cuot = #1#60;  punt =  9;|HAZ c_rep2;
    base = #1#53;   porc = #1#59;  cuot = #1#61;  punt = 10;|HAZ c_rep2;

    tipo = "R";
    libro = #1#0;
    factu = #1#2;
    serie = #1#27;
    diari = #1#45;
    fecha = #1#46;
    docum = #1#47;
    cuenta = #1#4;
    digito = #1#5;
    |HAZ b_asiento;        || existencia asiento
    |HAZ b_cuenta;

    |SI #0#1 = "S";
        |HAZ total_rep; #1#26 = nume4;
        |GRABA 020#1a;
   |FINSI;
   |LIBERA #1;
|FPRC;

|DEFBUCLE lee_reper;
 #1#1;
 ;
  1,      1, "  ";
 99, 999999, "zz";
 be;
 NULL, lee_reper1;
|FIN;
____________________________________/ CALCULO PRINCIPAL
|PROCESO tipo3; |TIPO 3;
|SI #0#0 = "SI";
    |IMPRE 0;
    |SI FSalida = 0;
        |INFOR "caconiva";
        |ABRE #3;
        |ABRE #5;
        |SI #0#7 = "R";|O #0#7 = "A";   |BUCLE lee_reper;   |FINSI;
        |SI #0#7 = "S";|O #0#7 = "A";   |BUCLE lee_sopor;   |FINSI;
        |CIERRA #3;
        |CIERRA #5;
        |PIEINF;
        |FININF;
    |SINO;
        |MENAV "    Proceso abortado ...";
    |FINSI;
    |FINIMP;
|FINSI;
|FPRC;
