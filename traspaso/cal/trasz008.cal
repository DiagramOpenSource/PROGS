|FICHEROS;
   trasz008 #0;
   trasw001 #10,MANTE;
   trasw002 #11;
   trasw005 #12;

   canempr@ #100;
   camasic@ #101;
   camasil@ #102;
   camaniv@ #103;
   caivali@ #104;
   camandi@ #105;
   cacuent@ #106;
   caclipr@ #107;
   caenlac@ #108;
   calibro@ #109;

   Referen@ #500;
|FIN;

|VARIABLES;

   &eaExterno = "";
   &enEmpreOri = 0;
   &enPerioOri = 0;
   &enNoModif  = 0;
   &eaCopiar   = "";
   &eaCeros    = "";
   &eaOtras    = "";
   &eaDepar    = "";

   nHayComillas = 0;

   nCmpBase  = 0;
   nCmpPIVA  = 0;
   nCmpIIVA  = 0;
   nCmpPREC  = 0;
   nCmpIREC  = 0;

   nSwRet = 0;
   nSwSF = 0;
   nDia  = 0;
   nMes  = 0;
   nAnyo = 0;
   nIva  = 0;
   nConcepto = 0;
   nMarca    = 0;
   aTipo     = "";
   aPD       = "";
   aMask     = "";
   aDato1    = "";
   aDato2    = "";
   aMensa    = "";

   nNumSerie = 0;

   nLibro   = 0;
   nFactu   = 0;
   aSerie   = "";

   nLinIva = 0;
   alfa1   = "";
   alfa2   = "";
   alfa3   = "";
   alfa4   = "";
   trim1   = "";
   trim2   = "";
   trim3   = "";
   trim4   = "";

   nContador = 0;

   nNumCampo = 0;
   nModo    = 0;
   nAsiento = 0;
   nOrden   = 0;
   aSigno   = "";
   aCuenta  = "";
   aDescri  = "";
   nImporte = 0;
   nLinea   = 0;
   nNumSop  = 0;
   nNumDoc  = 0;

   nDiario    = 0;
   fFecha     = @;
   nDocumento = 0;

   aAlfa   = "";
   aAlfa1  = "";
   aAlfa2  = "";
   aCR     = "";
   aLF     = "";
   aCadena = "";
   aDatos  = "";
   nNivel  = 0;

   nLong   = 0;
   nHandle = 0;
   nTecla  = 0;
   nCont   = 0;
   nCalc   = 0;
   nCalc1  = 0;
   nCalc2  = 0;
   nCampo  = 0;
   nSwError = 0;

{200}aCampos = "";
|FIN;

|PROCESO FiltraLetras;
   aAlfa = #trasw001#2; |QBF aAlfa;
   |SI aAlfa = ""; |ACABA; |FINSI;
   aAlfa = (("00" + aAlfa) % -102); #trasw001#2 = aAlfa; |PINTA #trasw001#2;

   aAlfa = #trasw001#2; |QBF aAlfa; aAlfa = aAlfa % 0101;
   |SI aAlfa < "0"; |O aAlfa > "9"; #trasw001#2 = "00"; |PINTA #trasw001#2; |ERROR; |FINSI;
   aAlfa = #trasw001#2; |QBF aAlfa; aAlfa = aAlfa % 0201;
   |SI aAlfa < "0"; |O aAlfa > "9"; #trasw001#2 = "00"; |PINTA #trasw001#2; |ERROR; |FINSI;
|FPRC;

|PROCESO MiraFichs;
   |SI FSalida = 2; |ACABA; |FINSI;
   aAlfa = #trasz008#0; |QBF aAlfa;

   aAlfa1 = aAlfa + #trasz008#Campo#; |QBF aAlfa1;
   |XABRE "E", aAlfa1, nHandle;
   |SI FSalida < 0;
      |MENAV "    Fichero no encontrado "; |ERROR;
   |FINSI;
|FPRC;

|PROCESO PathAutom;
   |SI FSalida = 10;
      |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "contagen/";
      #trasz008#Campo# = aAlfa; |PINTA #trasz008#Campo#; |ERROR;
   |FINSI;
|FPRC;

|PROCESO MiraPath;
   aAlfa = #trasz008#10; |QBF aAlfa; aAlfa = aAlfa % -101;
   |SI aAlfa ! "/"; |Y aAlfa ! "\";
      aAlfa = #trasz008#10; |QBF aAlfa;
      aAlfa = aAlfa + "/"; #trasz008#10 = aAlfa; |PINTA #trasz008#10;
   |FINSI;

   aAlfa = #trasz008#10; |QBF aAlfa;
   aAlfa = aAlfa + "fich/canempre.dat";
   |XABRE "E", aAlfa, nHandle;
   |SI FSalida < 0;
      |MENAV "    No se ha encontrado el fichero de empresas "; |ERROR;
   |FINSI;
|FPRC;

|PROCESO MiraEmpresa;
   nTecla = FSalida;

   aAlfa = #trasz008#10; |QBF aAlfa;
   aAlfa = aAlfa + "def/canempre.mas";

   |CARGA_DEF aAlfa, canempr@;
   |SI FSalida = 0;
      aAlfa = #trasz008#10; |QBF aAlfa;
      aAlfa = aAlfa + "fich/"; |PATH_DAT #100 aAlfa;
      |ABRE #canempr@;
      |SI nTecla = 10;
         |CONSULTA_CLAVE #1#canempr@;
         |SI FSalida ! 0; |ERROR; |FINSI;
         #trasz008#7 = #canempr@#2; |PINTA #trasz008#7;
         #trasz008#8 = #canempr@#3; |PINTA #trasz008#8;
      |FINSI;
      #canempr@#2 = #trasz008#7;
      #canempr@#3 = #trasz008#8;
      |LEE 000#canempr@.=;
      |SI FSalida = 0;
         #trasz008#9 = #canempr@#1; |PINTA #trasz008#9;
      |FINSI;
      |CIERRA #canempr@; |DESCARGA_DEF #canempr@;
      |SI nTecla = 10; |ERROR; |FINSI;
   |FINSI;
|FPRC;

|PROCESO SacaNivel;
   aAlfa = aCuenta; |QBF aAlfa;
   aAlfa = aAlfa % 0; nLong = aAlfa;

   |PARA nCont = 14; |SI nCont [ 19; |HACIENDO nCont = nCont + 1;
      |SI nLong = #canempr@#nCont#; nNivel = nCont - 13; |FINSI;
   |SIGUE;
|FPRC;

|PROCESO Cambia1; |TIPO 1;
   |HAZ Cambia;
|FPRC;

|PROCESO Cambia;
   nModo = (FEntrada / 100) ! 0;
   |SI nModo = 1; |O nModo = 3; |ERROR; |FINSI;
|FPRC;

|RUTINA inf;
   #trasw001#0 = 00;
|FRUT;

|RUTINA sup;
   #trasw001#0 = 99;
|FRUT;

|PROCESO LeeRegistro;
   |BLIN 4;
   aAlfa = "    Leyendo registro "; |MENSA aAlfa;

   aCadena = ""; nHayComillas = 0; nNumCampo = 0; nSwError = 0;
   |XLEE nHandle, 1, aAlfa;
   |PARA; |SI FSalida > 0; |HACIENDO;
      |SI aAlfa ! aCR;
         aAlfa1 = &34;
         |SI aAlfa = aAlfa1;
            |SI nHayComillas = 1;
               nHayComillas = 0;
            |SINO;
               nHayComillas = 1;
            |FINSI;
         |FINSI;
         |SI aAlfa = ";"; |Y nHayComillas = 0;
            IaCampos = aCampos1<-; IaCampos = IaCampos + nNumCampo;
            aCadena = aCadena - &34; aCadena = aCadena - &34; |QBF aCadena;
            aAlfa = aCadena - "/";
            |SI FSalida ! 0;
               aAlfa = aAlfa - "/";
               |SI FSalida ! 0;
                  aAlfa = aAlfa - ":";
                  |SI FSalida ! 0;
                     aAlfa = aAlfa - ":";
                     |SI FSalida ! 0;    || Campo fecha de Access
                        aAlfa = aCadena; nDia = 0; nMes = 0; nAnyo = 0;
                        |PARA; |SI aAlfa ! ""; |HACIENDO;
                           aAlfa1 = aAlfa % 0101; aAlfa = aAlfa % 0299;
                           |SI aAlfa1 = "/";
                              |SI nDia = 0;
                                 nDia = aAlfa2; aAlfa2 = "";
                              |SINO;
                                 nMes = aAlfa2; aAlfa2 = "";
                              |FINSI;
                           |SINO;
                              |SI aAlfa1 = " ";
                                 nAnyo = aAlfa2; aAlfa2 = "";
                              |SINO;
                                 aAlfa2 = aAlfa2 + aAlfa1;
                              |FINSI;
                           |FINSI;
                        |SIGUE;
                        aCadena = (("00" + nDia) % -102) + "." + (("00" + nMes) % -102) + "." + nAnyo;
                        aAlfa2 = "";
                     |FINSI;
                  |FINSI;
               |FINSI;
            |FINSI;

            aCampos = aCadena;
            aCadena = ""; nHayComillas = 0; nNumCampo = nNumCampo + 1;
         |SINO;
            aCadena = aCadena + aAlfa;
         |FINSI;
      |SINO;
         |SAL;
      |FINSI;

      |XLEE nHandle, 1, aAlfa;
   |SIGUE;

   |SI FSalida [ 0;
      nSwError = 1;
   |SINO;
      nSwError = 0;
   |FINSI;
   |BLIN 4;
|FPRC;

|PROCESO IvaIntrac;
   aAlfa = #caenlac@#4; |QBF aAlfa; aAlfa = aAlfa % 0103;
   ||SI aAlfa = "477"; |O aAlfa = "472";
      ||BORRA 020#caenlac@.a;
   ||SINO;
      |SI #caenlac@#10 = "R";
         #caenlac@#6 = #trasz008#20;
      |SINO;
         #caenlac@#6 = #trasz008#18;
      |FINSI;
      |GRABA 020#caenlac@.a;
   ||FINSI;
|FPRC;

|DEFBUCLE IvaIntrac;
#caenlac@#1006;
;
nDiario, fFecha, nDocumento, 0000, #trasz008#7, #trasz008#8;
nDiario, fFecha, nDocumento, 9999, #trasz008#7, #trasz008#8;
;
NULL, IvaIntrac;
|FIN;

|PROCESO Iva;
   #caenlac@#10 = aTipo;
   #caenlac@#6  = nConcepto;
   |GRABA 020#caenlac@.a;
|FPRC;

|DEFBUCLE Iva;
#caenlac@#1006;
;
nDiario, fFecha, nDocumento, 0000, #trasz008#7, #trasz008#8;
nDiario, fFecha, nDocumento, 9999, #trasz008#7, #trasz008#8;
;
NULL, Iva;
|FIN;

|PROCESO EscribeIva;
   |SI #trasw005#13 = "I"; |ACABA; |FINSI;

   nLinIva = 0; nLibro = 0; nNumSerie = 0;
   |SI #trasw005#13 = "E";
      nLibro = #trasz008#12;
   |SINO;
      nLibro = #trasz008#13;
      |SELECT #3#camaniv@;
      |DDEFECTO #camaniv@;
      #camaniv@#0 = nLibro;
      #camaniv@#2  = "     ";
      #camaniv@#3  = 999999;
      |LEE 000#camaniv@.];
      |SI FSalida = 0;
         |SI #camaniv@#0 = nLibro; |Y #camaniv@#2  = "     ";
            nNumSerie = 1;
         |SINO;
            |LEE 000#camaniv@.a;
            |SI FSalida = 0;
               |SI #camaniv@#0 = nLibro; |Y #camaniv@#2  = "     ";
                  nNumSerie = #camaniv@#3 + 1;
               |SINO;
                  nNumSerie = 1;
               |FINSI;
            |SINO;
               nNumSerie = 1;
            |FINSI;
         |FINSI;
      |SINO;
         |LEE 000#camaniv@.u;
         |SI FSalida = 0;
            |SI #camaniv@#0 = nLibro; |Y #camaniv@#2  = "     ";
               nNumSerie = #camaniv@#3 + 1;
            |SINO;
               nNumSerie = 1;
            |FINSI;
         |SINO;
            nNumSerie = 1;
         |FINSI;
      |FINSI;
      |SELECT #1#camaniv@;
   |FINSI;
   #camaniv@#0 = nLibro;
   #camaniv@#1 = 9999999999;
   |LEE 000#camaniv@.];
   |SI FSalida = 0;
      |SI #camaniv@#0 = nLibro;
         nLinIva = 1;
      |SINO;
         |LEE 000#camaniv@.a;
         |SI FSalida = 0;
            |SI #camaniv@#0 = nLibro;
               nLinIva = #camaniv@#1 + 1;
            |SINO;
               nLinIva = 1;
            |FINSI;
         |SINO;
            nLinIva = 1;
         |FINSI;
      |FINSI;
   |SINO;
      |LEE 000#camaniv@.u;
      |SI FSalida = 0;
         |SI #camaniv@#0 = nLibro;
            nLinIva = #camaniv@#1 + 1;
         |SINO;
            nLinIva = 1;
         |FINSI;
      |SINO;
         nLinIva = 1;
      |FINSI;
   |FINSI;

   |DDEFECTO #camaniv@;
   #camaniv@#0  = nLibro;
   #camaniv@#1  = nLinIva;
   |SI #trasw005#13 = "E";
      #camaniv@#2  = #trasw005#3;
      #camaniv@#3  = #trasw005#4;
   |SINO;
      #camaniv@#2  = "";
      #camaniv@#3  = nNumSerie;
      aAlfa = #trasw005#3 + "/" + #trasw005#4;
      #camaniv@#22 = aAlfa;
   |FINSI;
   #camaniv@#4  = #trasw005#5;
   alfa1 = #trasw005#5;       alfa1 = alfa1 %  -104;  || saca a¤o
   alfa2 = "31.03." + alfa1;  trim1 = alfa2;  || primer trimestre
   alfa2 = "30.06." + alfa1;  trim2 = alfa2;  || segundo trimestre
   alfa2 = "30.09." + alfa1;  trim3 = alfa2;  || tercer trimestre
   |SI #camaniv@#4 [ trim1;                   #camaniv@#5 = 1;  |FINSI;
   |SI #camaniv@#4 > trim1;|Y #camaniv@#4 [ trim2;  #camaniv@#5 = 2;  |FINSI;
   |SI #camaniv@#4 > trim2;|Y #camaniv@#4 [ trim3;  #camaniv@#5 = 3;  |FINSI;
   |SI #camaniv@#4 > trim3;                   #camaniv@#5 = 4;  |FINSI;
   || periodo (segun fecha)

   #camaniv@#12 = #trasw005#14;
   #camaniv@#13 = #trasw005#8;
   #camaniv@#14 = #trasw005#7;
   aAlfa = #camaniv@#14; |QBF aAlfa;
   |SI aAlfa = "";
      #caclipr@#23 = "C";
      #caclipr@#10 = #camaniv@#12;  aCuenta = #camaniv@#12; |HAZ SacaNivel;
      #caclipr@#11 = nNivel;
      |LEE 000#caclipr@.=;
      |SI FSalida = 0;
         aAlfa = #caclipr@#9; |QBF aAlfa;
         |SI aAlfa = "";
            #camaniv@#13 = #caclipr@#1;
            #camaniv@#14 = #caclipr@#9;
         |FINSI;
      |FINSI;
   |FINSI;
   #camaniv@#27 = #trasz008#16;
   #camaniv@#28 = #trasz008#17;
   #camaniv@#29 = #camaniv@#27;
   #camaniv@#30 = #camaniv@#28;
   |SI #trasw005#13 = "E"; #camaniv@#36 = "R"; |FINSI;
   |SI #trasw005#13 = "R"; #camaniv@#36 = "S"; |FINSI;
   |GRABA 020#camaniv@.c;

   nSwRet = 0;
   |SI #trasw005#15 ! 0;
      nSwRet = 1;
      |DDEFECTO #caivali@;
      #caivali@#0  = #camaniv@#0;
      #caivali@#1  = #camaniv@#1;
      #caivali@#2  = 1;
      #caivali@#3  = #camaniv@#27;
      #caivali@#4  = #camaniv@#28;
      #caivali@#5  = #trasw005#12;
      #caivali@#6  = #trasw005#15;
      #caivali@#7  = #trasw005#16;
      #caivali@#8  = #trasw005#17;
      #caivali@#9  = #trasw005#18;
      #caivali@#10 = #trasw005#19;
      #caivali@#20 = #trasw005#11;
      #caivali@#21 = #trasw005#9;
      #caivali@#22 = #trasw005#10;
      #camaniv@#20 = #camaniv@#20 + #caivali@#22;

      #camaniv@#19 = #camaniv@#19 + #caivali@#6;
      #camaniv@#23 = #camaniv@#23 + (#caivali@#8 + #caivali@#10);
      #camaniv@#26 = #camaniv@#26 + #caivali@#11;
      #camaniv@#21 = #camaniv@#19 + #camaniv@#23 - #camaniv@#26;
      |GRABA 020#caivali@.n;
   |FINSI;

   |SI #trasw005#20 ! 0;
      |DDEFECTO #caivali@;
      #caivali@#0  = #camaniv@#0;
      #caivali@#1  = #camaniv@#1;
      #caivali@#2  = 2;
      #caivali@#3  = #camaniv@#27;
      #caivali@#4  = #camaniv@#28;
      #caivali@#5  = #trasw005#12;
      #caivali@#6  = #trasw005#20;
      #caivali@#7  = #trasw005#21;
      #caivali@#8  = #trasw005#22;
      #caivali@#9  = #trasw005#23;
      #caivali@#10 = #trasw005#24;
      |SI nSwRet = 0;
         #caivali@#20 = #trasw005#11;
         #caivali@#21 = #trasw005#9;
         #caivali@#22 = #trasw005#10;
         #camaniv@#20 = #camaniv@#20 + #caivali@#22;
         nSwRet = 1;
      |FINSI;

      #camaniv@#19 = #camaniv@#19 + #caivali@#6;
      #camaniv@#23 = #camaniv@#23 + (#caivali@#8 + #caivali@#10);
      #camaniv@#26 = #camaniv@#26 + #caivali@#11;
      #camaniv@#21 = #camaniv@#19 + #camaniv@#23 - #camaniv@#26;
      |GRABA 020#caivali@.n;
   |FINSI;

   |SI #trasw005#25 ! 0;
      |DDEFECTO #caivali@;
      #caivali@#0  = #camaniv@#0;
      #caivali@#1  = #camaniv@#1;
      #caivali@#2  = 3;
      #caivali@#3  = #camaniv@#27;
      #caivali@#4  = #camaniv@#28;
      #caivali@#5  = #trasw005#12;
      #caivali@#6  = #trasw005#25;
      #caivali@#7  = #trasw005#26;
      #caivali@#8  = #trasw005#27;
      #caivali@#9  = #trasw005#28;
      #caivali@#10 = #trasw005#29;
      |SI nSwRet = 0;
         #caivali@#20 = #trasw005#11;
         #caivali@#21 = #trasw005#9;
         #caivali@#22 = #trasw005#10;
         #camaniv@#20 = #camaniv@#20 + #caivali@#22;
         nSwRet = 1;
      |FINSI;

      #camaniv@#19 = #camaniv@#19 + #caivali@#6;
      #camaniv@#23 = #camaniv@#23 + (#caivali@#8 + #caivali@#10);
      #camaniv@#26 = #camaniv@#26 + #caivali@#11;
      #camaniv@#21 = #camaniv@#19 + #camaniv@#23 - #camaniv@#26;
      |GRABA 020#caivali@.n;
   |FINSI;

   |SI #trasw005#30 ! 0;
      |DDEFECTO #caivali@;
      #caivali@#0  = #camaniv@#0;
      #caivali@#1  = #camaniv@#1;
      #caivali@#2  = 4;
      #caivali@#3  = #camaniv@#27;
      #caivali@#4  = #camaniv@#28;
      #caivali@#5  = #trasw005#12;
      #caivali@#6  = #trasw005#30;
      #caivali@#7  = #trasw005#31;
      #caivali@#8  = #trasw005#32;
      #caivali@#9  = #trasw005#33;
      #caivali@#10 = #trasw005#34;
      |SI nSwRet = 0;
         #caivali@#20 = #trasw005#11;
         #caivali@#21 = #trasw005#9;
         #caivali@#22 = #trasw005#10;
         #camaniv@#20 = #camaniv@#20 + #caivali@#22;
         nSwRet = 1;
      |FINSI;

      #camaniv@#19 = #camaniv@#19 + #caivali@#6;
      #camaniv@#23 = #camaniv@#23 + (#caivali@#8 + #caivali@#10);
      #camaniv@#26 = #camaniv@#26 + #caivali@#11;
      #camaniv@#21 = #camaniv@#19 + #camaniv@#23 - #camaniv@#26;
      |GRABA 020#caivali@.n;
   |FINSI;

   |SI #trasw005#35 ! 0;
      |DDEFECTO #caivali@;
      #caivali@#0  = #camaniv@#0;
      #caivali@#1  = #camaniv@#1;
      #caivali@#2  = 5;
      #caivali@#3  = #camaniv@#27;
      #caivali@#4  = #camaniv@#28;
      #caivali@#5  = #trasw005#12;
      #caivali@#6  = #trasw005#35;
      #caivali@#7  = #trasw005#36;
      #caivali@#8  = #trasw005#37;
      #caivali@#9  = #trasw005#38;
      #caivali@#10 = #trasw005#39;
      |SI nSwRet = 0;
         #caivali@#20 = #trasw005#11;
         #caivali@#21 = #trasw005#9;
         #caivali@#22 = #trasw005#10;
         #camaniv@#20 = #camaniv@#20 + #caivali@#22;
         nSwRet = 1;
      |FINSI;

      #camaniv@#19 = #camaniv@#19 + #caivali@#6;
      #camaniv@#23 = #camaniv@#23 + (#caivali@#8 + #caivali@#10);
      #camaniv@#26 = #camaniv@#26 + #caivali@#11;
      #camaniv@#21 = #camaniv@#19 + #camaniv@#23 - #camaniv@#26;
      |GRABA 020#caivali@.n;
   |FINSI;

   |GRABA 020#camaniv@.a;
|FPRC;

|DEFBUCLE EscribeIva;
#trasw005#1;
;
INICIO;
FINAL;
;
NULL,EscribeIva;
|FIN;

|PROCESO Traspaso;
   nNumSop  = 1;
   aAlfa = #trasz008#10; |QBF aAlfa;

   aAlfa1 = aAlfa + "def/canempre.mas";
   |CARGA_DEF aAlfa1, canempr@;
   |SI FSalida ! 0; |ACABA; |FINSI;

   aAlfa1 = aAlfa + "def/camaasic.mas";
   |CARGA_DEF aAlfa1, camasic@;
   |SI FSalida ! 0;
      |DESCARGA_DEF #canempr@; |ACABA;
   |FINSI;

   aAlfa1 = aAlfa + "def/camaasil.mas";
   |CARGA_DEF aAlfa1, camasil@;
   |SI FSalida ! 0;
      |DESCARGA_DEF #camasic@;
      |DESCARGA_DEF #canempr@; |ACABA;
   |FINSI;

   aAlfa1 = aAlfa + "def/cacuenta.mas";
   |CARGA_DEF aAlfa1, cacuent@;
   |SI FSalida ! 0;
      |DESCARGA_DEF #camasil@;
      |DESCARGA_DEF #camasic@;
      |DESCARGA_DEF #canempr@; |ACABA;
   |FINSI;

   aAlfa1 = aAlfa + "def/camandia.mas";
   |CARGA_DEF aAlfa1, camandi@;
   |SI FSalida ! 0;
      |DESCARGA_DEF #cacuent@;
      |DESCARGA_DEF #camasil@;
      |DESCARGA_DEF #camasic@;
      |DESCARGA_DEF #canempr@; |ACABA;
   |FINSI;

   aAlfa1 = aAlfa + "def/caclipro.mas";
   |CARGA_DEF aAlfa1, caclipr@;
   |SI FSalida ! 0;
      |DESCARGA_DEF #camandi@;
      |DESCARGA_DEF #cacuent@;
      |DESCARGA_DEF #camasil@;
      |DESCARGA_DEF #camasic@;
      |DESCARGA_DEF #canempr@; |ACABA;
   |FINSI;

   aAlfa1 = aAlfa + "def/camaniva.mas";
   |CARGA_DEF aAlfa1, camaniv@;
   |SI FSalida ! 0;
      |DESCARGA_DEF #caclipr@;
      |DESCARGA_DEF #camandi@;
      |DESCARGA_DEF #cacuent@;
      |DESCARGA_DEF #camasil@;
      |DESCARGA_DEF #camasic@;
      |DESCARGA_DEF #canempr@; |ACABA;
   |FINSI;

   aAlfa1 = aAlfa + "def/caivalin.mas";
   |CARGA_DEF aAlfa1, caivali@;
   |SI FSalida ! 0;
      |DESCARGA_DEF #camaniv@;
      |DESCARGA_DEF #caclipr@;
      |DESCARGA_DEF #camandi@;
      |DESCARGA_DEF #cacuent@;
      |DESCARGA_DEF #camasil@;
      |DESCARGA_DEF #camasic@;
      |DESCARGA_DEF #canempr@; |ACABA;
   |FINSI;

   aAlfa1 = aAlfa + "def/caenlace.mas";
   |CARGA_DEF aAlfa1, caenlac@;
   |SI FSalida ! 0;
      |DESCARGA_DEF #caivali@;
      |DESCARGA_DEF #camaniv@;
      |DESCARGA_DEF #caclipr@;
      |DESCARGA_DEF #camandi@;
      |DESCARGA_DEF #cacuent@;
      |DESCARGA_DEF #camasil@;
      |DESCARGA_DEF #camasic@;
      |DESCARGA_DEF #canempr@; |ACABA;
   |FINSI;

   aAlfa = #trasz008#10; |QBF aAlfa;
   aAlfa = aAlfa + "fich/" + (("00000" + #trasz008#7) % -105) + #trasz008#8 + "/";
   |PATH_DAT #101 aAlfa; |PATH_DAT #102 aAlfa;
   |PATH_DAT #103 aAlfa; |PATH_DAT #104 aAlfa; |PATH_DAT #105 aAlfa;
   |PATH_DAT #106 aAlfa; |PATH_DAT #107 aAlfa; |PATH_DAT #108 aAlfa;
   aAlfa = "pu" + Usuario; |NOME_DAT #108 aAlfa;
   aAlfa = #trasz008#10; |QBF aAlfa;
   aAlfa = aAlfa + "fich/"; |PATH_DAT #100 aAlfa;

   aAlfa = "t1" + Usuario; |NOME_DAT #11 aAlfa;
   aAlfa = "t2" + Usuario; |NOME_DAT #12 aAlfa;

   |ABRE #canempr@;
   |DELINDEX #camasic@; |ABRE #camasic@;
   |DELINDEX #camasil@; |ABRE #camasil@;
   |DELINDEX #cacuent@; |ABRE #cacuent@;
   |DELINDEX #caclipr@; |ABRE #caclipr@;
   |DELINDEX #camaniv@; |ABRE #camaniv@;
   |DELINDEX #caivali@; |ABRE #caivali@;
   |DELINDEX #camandi@; |ABRE #camandi@;
   |DELINDEX #caenlac@; |ABRE #caenlac@;
   |DELINDEX #trasw001; |ABRE #trasw001;
   |DELINDEX #trasw002; |DELINDEX #trasw005;

   aAlfa = #trasz008#3; |QBF aAlfa;
   |SI aAlfa ! "";

|| Creamos los ficheros basicos (partidas, epigrafes, plan contable general ....)

      eaExterno  = #trasz008#10; |QBF eaExterno;
      eaExterno  = eaExterno + "fich/" + (("00000" + #trasz008#7) % -105) + #trasz008#8 + "/";
      enEmpreOri = 0;
      enPerioOri = 0;
      eaCopiar   = "T";
      eaCeros    = "S";
      eaOtras    = "N";
      eaDepar    = "S";
      |SUB_EJECUTA_NP ":contagen/cacrebal";

      #canempr@#2 = #trasz008#7;
      #canempr@#3 = #trasz008#8;
      |LEE 000#canempr@.=;
      |SI FSalida ! 0; |DDEFECTO #canempr@; |FINSI;

|| Pasamos el plan contable

      |ATRI I; |PINTA 2210, " Procesando plan contable ....................."; |ATRI N;
      aCR = &10; aLF = &13;
      aAlfa = #trasz008#0; |QBF aAlfa; aAlfa1 = aAlfa + #trasz008#3; |QBF aAlfa1;
      |XABRE "B", aAlfa1, nHandle;
      |SI FSalida ] 0;
         |HAZ LeeRegistro;
         |PARA; |SI nSwError = 0; |HACIENDO;
            aCuenta = aCampos1; aDescri = aCampos2;
            #cacuent@#0 = aCuenta;
            #cacuent@#2 = aDescri;
            |LEE 000#cacuent@.=;
            |SI FSalida ! 0;
               aAlfa = " Procesando cuenta " + aCuenta + " [" + aDescri + "]               ";
               |BLIN 23;
               |ATRI I; |PINTA 2310, aAlfa; |ATRI N;
               nCalc = 14 + #canempr@#13;
               |LEE 000#cacuent@.p;
               |SI FSalida = 0;
                  nSwSF = 1; |SALVA_FICHA #cacuent@;
               |SINO;
                  nSwSF = 0;
               |FINSI;
               |PARA nCont = 14; |SI nCont [ nCalc; |HACIENDO nCont = nCont + 1;
                  nLong = 100 + #canempr@#nCont#;
                  aAlfa = aCuenta % nLong;
                  #cacuent@#0 = aAlfa;
                  |LEE 000#cacuent@.=;
                  |SI FSalida = 0; |Y nLong ! 100;
                     |SI nSwSF = 1; |REPON_FICHA #cacuent@; |FINSI;
                     #cacuent@#0 = aAlfa;
                     #cacuent@#1 = nCont - 13;
                     |LEE 000#cacuent@.=;
                     |SI FSalida = 0;
                        nSwSF = 1; |SALVA_FICHA #cacuent@;
                     |SINO;
                        nSwSF = 0;
                     |FINSI;
                  |FINSI;
               |SIGUE;
               |SI nSwSF = 1; |REPON_FICHA #cacuent@; |FINSI;

               aPD = "S"; nNivel = 0; |HAZ SacaNivel;
               nCalc = nNivel + 14;
               |PARA; |SI nCalc [ 19; |HACIENDO nCalc = nCalc + 1;
                  |SI #canempr@#nCalc# ! 0; aPD = "N"; |FINSI;
               |SIGUE;
               #cacuent@#0 = aCuenta;
               #cacuent@#1 = nNivel;
               #cacuent@#2 = aDescri;
               #cacuent@#3 = aPD;
               |GRABA 020#cacuent@.n;
            |FINSI;
            |HAZ LeeRegistro;
         |SIGUE;
      |FINSI;
      |XCIERRA nHandle;
   |FINSI;

|| Pasamos las fichas de Clientes/Proveedores

   |ATRI I; |PINTA 2210, " Procesando ficha de clientes / proveedores ..."; |ATRI N;

   aAlfa = #trasz008#5; |QBF aAlfa;
   |SI aAlfa ! "";
      aCR = &10; aLF = &13;
      aAlfa = #trasz008#0; |QBF aAlfa; aAlfa1 = aAlfa + #trasz008#5; |QBF aAlfa1;
      |XABRE "B", aAlfa1, nHandle;
      |SI FSalida ] 0;
         |HAZ LeeRegistro;
         |PARA; |SI nSwError = 0; |HACIENDO;
            aAlfa = " Procesando cli/pro " + aCampos1 + " [" + aCampos2 + "]                ";
            |BLIN 23;
            |ATRI I; |PINTA 2310, aAlfa; |ATRI N;

            |DDEFECTO #caclipr@;
            #caclipr@#23 = aCampos8;
            #caclipr@#10 = aCampos1;
            aCuenta = aCampos1; nNivel = 0; |HAZ SacaNivel;  #caclipr@#11 = nNivel;
            |LEE 000#caclipr@.=;
            |SI FSalida ! 0;
               |DDEFECTO #caclipr@;
               #caclipr@#23 = aCampos8;
               #caclipr@#10 = aCampos1;
               aCuenta = aCampos1; nNivel = 0; |HAZ SacaNivel;  #caclipr@#11 = nNivel;
               #caclipr@#0 = aCampos1;
               #caclipr@#1 = aCampos2;
               #caclipr@#9  = aCampos3;
               #caclipr@#10 = aCampos1;
               aCuenta = #caclipr@#10; nNivel = 0; |HAZ SacaNivel; #caclipr@#11 = nNivel;
               |GRABA 020#caclipr@.n;
            |FINSI;

            |HAZ LeeRegistro;
         |SIGUE;
      |FINSI;
      |XCIERRA nHandle;
   |FINSI;

|| Pasamos los diarios
   |ATRI I; |PINTA 2210, " Procesando ficha de diarios .................."; |ATRI N;
   aAlfa = #trasz008#4; |QBF aAlfa;
   |SI aAlfa ! "";
      aCR = &10; aLF = &13;
      aAlfa = #trasz008#0; |QBF aAlfa; aAlfa1 = aAlfa + #trasz008#4; |QBF aAlfa1;
      |XABRE "B", aAlfa1, nHandle;
      |SI FSalida ] 0;
         |HAZ LeeRegistro;
         |PARA; |SI nSwError = 0; |HACIENDO;
            aAlfa = " Procesando diario " + aCampos1 + " [" + aCampos2 + "]                ";
            |BLIN 23;
            |ATRI I; |PINTA 2310, aAlfa; |ATRI N; |PULSATECLA;

            |DDEFECTO #trasw001;
            #trasw001#0 = aCampos1;
            #trasw001#1 = aCampos2;
            |GRABA 020#trasw001.n;

            |HAZ LeeRegistro;
         |SIGUE;
      |FINSI;
      |XCIERRA nHandle;

      |PUSHV 0501 2380;
      |ENTLINEAL #1#trasw001, -1, 2, 17, 1, inf, sup;
      |POPV;
   |FINSI;

   || Pasamos los asientos

   |ABRE #trasw002; |ABRE #trasw005;

   |ATRI I; |PINTA 2210, " Procesando fichero de asientos ..............."; |ATRI N;
   aAlfa = #trasz008#6; |QBF aAlfa;
   |SI aAlfa ! "";
      aCR = &10; aLF = &13;
      aAlfa = #trasz008#0; |QBF aAlfa; aAlfa1 = aAlfa + #trasz008#6; |QBF aAlfa1;
      |XABRE "B", aAlfa1, nHandle;
      |SI FSalida ] 0;
         |HAZ LeeRegistro;
         |PARA; |SI nSwError = 0; |HACIENDO;
            aAlfa = " Procesando asiento " + aCampos13 + "/" + aCampos7 + "/" + aCampos3 + "                 ";
            |BLIN 23;
            |ATRI I; |PINTA 2310, aAlfa; |ATRI N;  |PULSATECLA;

            |SI aCampos4 ! "";
               #trasw001#0 = aCampos13;
               |LEE 000#trasw001.=;
               |SI FSalida = 0;
                  |SI #trasw001#2 ! "  "; aCampos13 = #trasw001#2; |FINSI;
               |FINSI;

               nLinea = 1;
               |DDEFECTO #caenlac@;
               nDiario = aCampos13; fFecha = aCampos7; nNumDoc = aCampos3;
               #caenlac@#0 = nDiario;
               #caenlac@#1 = fFecha;
               #caenlac@#2 = nNumDoc;
               #caenlac@#37 = #trasz008#7;
               #caenlac@#38 = #trasz008#8;
               |LEE 000#caenlac@.];
               |PARA; |SI FSalida = 0; |Y #caenlac@#0 = nDiario; |Y #caenlac@#1 = fFecha; |Y #caenlac@#2 = nNumDoc;
                 |Y #caenlac@#37 = #trasz008#7; |Y #caenlac@#38 = #trasz008#8; |HACIENDO;
                  nLinea = #caenlac@#3 + 1;
                  |LEE 000#caenlac@.s;
               |SIGUE;

               |DDEFECTO #caenlac@;
               #caenlac@#0 = aCampos13;
               #caenlac@#1 = aCampos7;
               #caenlac@#2 = aCampos3;
               #caenlac@#3 = nLinea;
               #caenlac@#4 = aCampos5; aCuenta = aCampos5;
               nNivel = 0; |HAZ SacaNivel;
               #caenlac@#5 = nNivel;
               #caenlac@#6 = #trasz008#22;
               #caenlac@#7 = aCampos10;
               #caenlac@#8 = aCampos4;
               #caenlac@#9 = aCampos11;
               #caenlac@#37 = #trasz008#7;
               #caenlac@#38 = #trasz008#8;
               |GRABA 020#caenlac@.c;

               |DDEFECTO #trasw002;
               #trasw002#0 = #caenlac@#0;
               #trasw002#1 = #caenlac@#1;
               #trasw002#2 = #caenlac@#2;
               #trasw002#3 = #caenlac@#3;
               #trasw002#4 = "";
               #trasw002#5 = aCampos1;
               aAlfa = aCampos7 % -104;
               #trasw002#6 = aAlfa;
               |GRABA 020#trasw002.c;
            |FINSI;

            |HAZ LeeRegistro;
         |SIGUE;
      |FINSI;
      |XCIERRA nHandle;
   |FINSI;

   || Pasamos los movimientos de factura
   |SELECT #3#trasw002;

   |ATRI I; |PINTA 2210, " Procesando fichero de movs de factura .........."; |ATRI N;
   aAlfa = #trasz008#1; |QBF aAlfa;
   |SI aAlfa ! "";
      aCR = &10; aLF = &13;
      aAlfa = #trasz008#0; |QBF aAlfa; aAlfa1 = aAlfa + #trasz008#1; |QBF aAlfa1;
      |XABRE "B", aAlfa1, nHandle;
      |SI FSalida ] 0;
         |HAZ LeeRegistro;
         |PARA; |SI nSwError = 0; |HACIENDO;

            aAlfa = " Procesando factura " + aCampos6 + "/" + aCampos7 + "                 ";
            |BLIN 23;
            |ATRI I; |PINTA 2310, aAlfa; |ATRI N;  |PULSATECLA;

            |SI aCampos1 = "2005";
               #trasw005#0 = aCampos1;
               #trasw005#1 = aCampos4;
               |LEE 000#trasw005.=;
               |SI FSalida ! 0;
                  |DDEFECTO #trasw005;
                  #trasw005#0 = aCampos1;
                  #trasw005#1 = aCampos4;
                  |GRABA 020#trasw005.c;
               |FINSI;
               #trasw005#2 = aCampos2;
               #trasw005#3 = aCampos6;
               #trasw005#4 = aCampos7;
               #trasw005#5 = aCampos8;
               #trasw005#6 = aCampos9;
               #trasw005#7 = aCampos13;
               #trasw005#8 = aCampos14;
               #trasw005#9 = aCampos16;
               #trasw005#10 = aCampos17;
               #trasw005#11 = aCampos21;
               #trasw005#13 = aCampos11;
               #trasw005#14 = aCampos12;
               |GRABA 020#trasw005.a;
            |FINSI;
/*
            #trasw002#5 = aCampos4;
            #trasw002#6 = aCampos1;
            |LEE 000#trasw002.=;
            |SI FSalida = 0;
               #trasw002#7 = aCampos2;
               |GRABA 020#trasw002.a;

               #caenlac@#0  = #trasw002#0;
               #caenlac@#1  = #trasw002#1;
               #caenlac@#2  = #trasw002#2;
               #caenlac@#3  = #trasw002#3;
               #caenlac@#37 = #trasz008#7;
               #caenlac@#38 = #trasz008#8;
               |LEE 000#caenlac@.=;
               |SI FSalida = 0;
                  |SI aCampos11 = "R";
                     #caenlac@#11 = #trasz008#13;
                     |SI aCampos22 = "0";
                        nConcepto = #trasz008#14;
                        aTipo = "S";
                        #caenlac@#26 = "F";
                     |SINO;
                        nConcepto = #trasz008#20;
                        aTipo = "R";
                     |FINSI;
                     #caenlac@#12 = "";
                     #caenlac@#13 = nNumSop; nNumSop = nNumSop + 1;
                     |SI aCampos6 ! "";
                        aAlfa = aCampos6 + "/" + aCampos7;
                     |SINO;
                        aAlfa = aCampos7;
                     |FINSI;
                     #caenlac@#45 = aAlfa;
                  |FINSI;
                  |SI aCampos11 = "E";
                     #caenlac@#11 = #trasz008#12;
                     |SI aCampos22 = "0";
                        nConcepto = #trasz008#16;
                        aTipo = "R";
                        #caenlac@#26 = "F";
                     |SINO;
                        nConcepto = #trasz008#18;
                        aTipo = "S";
                     |FINSI;
                     #caenlac@#12 = aCampos6;
                     #caenlac@#13 = aCampos7;
                     #caenlac@#45 = "";
                  |FINSI;
                  #caenlac@#29 = aCampos8;
                  |SI aCampos22 = "0";
                     #caenlac@#30 = "N";
                     nDiario    = #caenlac@#0;
                     fFecha     = #caenlac@#1;
                     nDocumento = #caenlac@#2;
                     |SALVA_FICHA #caenlac@;
                     |BUCLE Iva;
                     |REPON_FICHA #caenlac@;
                     #caenlac@#10 = aTipo;
                     #caenlac@#6  = nConcepto;
                  |SINO;
                     nDiario    = #caenlac@#0;
                     fFecha     = #caenlac@#1;
                     nDocumento = #caenlac@#2;
                     |SALVA_FICHA #caenlac@;
                     |BUCLE IvaIntrac;
                     |REPON_FICHA #caenlac@;
                     #caenlac@#30 = "S";
                     |SI #caenlac@#10 = "R";
                        #caenlac@#6 = #trasz008#20;
                        #caenlac@#34 = #trasz008#13;
                     |SINO;
                        #caenlac@#6 = #trasz008#18;
                        #caenlac@#34 = #trasz008#12;
                     |FINSI;
                     #caenlac@#35 = aCampos6;
                     #caenlac@#36 = aCampos7;
                  |FINSI;
                  #caenlac@#43 = aCampos14;
                  aAlfa = aCampos13; |QBF aAlfa;
                  |SI aAlfa ! "";
                     #caenlac@#44 = aCampos13;
                  |SINO;
                     |SI aCampos11 = "R"; aAlfa = "P"; |FINSI;
                     |SI aCampos11 = "E"; aAlfa = "C"; |FINSI;
                     #caclipr@#23 = aAlfa;
                     #caclipr@#10 = aCampos12;
                     aCuenta = aCampos12; nNivel = 0; |HAZ SacaNivel;
                     #caclipr@#11 = nNivel;
                     |LEE 000#caclipr@.=;
                     |SI FSalida = 0;
                        #caenlac@#44 = #caclipr@#9;
                     |FINSI;
                  |FINSI;
                  ||GRABA 020#caenlac@.a;
               |FINSI;
            |FINSI;
*/
            |HAZ LeeRegistro;
         |SIGUE;
      |FINSI;
      |XCIERRA nHandle;
   |FINSI;

   || Pasamos los movimientos de iva
   |SELECT #4#trasw002; |SELECT #2#trasw005;

   |ATRI I; |PINTA 2210, " Procesando fichero de movs.iva ......................."; |ATRI N;
   aAlfa = #trasz008#2; |QBF aAlfa;
   |SI aAlfa ! "";
      aCR = &10; aLF = &13;
      aAlfa = #trasz008#0; |QBF aAlfa; aAlfa1 = aAlfa + #trasz008#2; |QBF aAlfa1;
      |XABRE "B", aAlfa1, nHandle;
      |SI FSalida ] 0;
         |HAZ LeeRegistro;
         |PARA; |SI nSwError = 0; |HACIENDO;

            |SI aCampos1 ! aDato1; |O aCampos2 ! aDato2;
               nIva = 1;
               aDato1 = aCampos1; aDato2 = aCampos2;
            |FINSI;
            aAlfa = " Procesando movimientos de iva [" + aCampos1 + "/" + aCampos2 + "]              ";
            |ATRI I; |PINTA 2310, aAlfa; |ATRI N;  |PULSATECLA;

            |SI aCampos13 ! "30"; |Y aCampos1 = "2005";
               #trasw005#0 = aCampos1;
               #trasw005#2 = aCampos2;
               |LEE 000#trasw005.=;
               |SI FSalida = 0;
                  nCalc = aCampos3; nCalc = nCalc - 1;
                  nCalc = 15 + (nCalc * 5);
                  nCmpBase = nCalc;
                  nCmpPIVA = nCalc + 1;
                  nCmpIIVA = nCalc + 2;
                  nCmpPREC = nCalc + 3;
                  nCmpIREC = nCalc + 4;

                  #trasw005#nCmpBase# = aCampos7;
                  #trasw005#nCmpPIVA# = aCampos9;
                  #trasw005#nCmpIIVA# = aCampos10;
                  #trasw005#nCmpPREC# = aCampos11;
                  #trasw005#nCmpIREC# = aCampos12;
                  |SI aCampos14 = "-1";
                     #trasw005#12 = "N";
                  |SINO;
                     #trasw005#12 = "S";
                  |FINSI;
                  |GRABA 020#trasw005.a;
               |FINSI;
            |FINSI;
/*
            nLibro = 0; aSerie = ""; nFactu = 0;
            #trasw002#6 = aCampos1;
            #trasw002#7 = aCampos2;
            |LEE 000#trasw002.=;
            |SI FSalida = 0;
               |SI aCampos13 ! "30"; |Y aCampos1 = "2005";
                  nMarca = 0;

                  #caenlac@#0 = #trasw002#0;
                  #caenlac@#1 = #trasw002#1;
                  #caenlac@#2 = #trasw002#2;
                  #caenlac@#3 = #trasw002#3;
                  #caenlac@#37 = #trasz008#7;
                  #caenlac@#38 = #trasz008#8;
                  |LEE 000#caenlac@.=;
                  |PARA; |SI FSalida = 0; |Y #caenlac@#0 = #trasw002#0;
                          |Y #caenlac@#1 = #trasw002#1; |Y #caenlac@#2 = #trasw002#2;
                          |Y #caenlac@#37 = #trasz008#7; |Y #caenlac@#38 = #trasz008#8; |HACIENDO;

                     |SI #caenlac@#26 = "F";
                        nLibro = #caenlac@#11;
                        aSerie = #caenlac@#12;
                        nFactu = #caenlac@#13;
                     |FINSI;
                     |SI #caenlac@#26 = " ";
                        nCalc1 = #caenlac@#9; nCalc2 = aCampos7;
                        |SI nCalc1 = nCalc2;
                           #caenlac@#26 = "B"; #caenlac@#27 = 1; #caenlac@#28 = aCampos9;
                           nMarca = 1;
                        |FINSI;
                        nCalc2 = aCampos10;
                        |SI nCalc1 = nCalc2;
                           #caenlac@#26 = "I";
                        |FINSI;
                        nCalc2 = aCampos12;
                        |SI nCalc1 = nCalc2;
                           #caenlac@#26 = "R"; #caenlac@#27 = 1; #caenlac@#33 = aCampos11;
                           nMarca = 1;
                        |FINSI;
                        #caenlac@#11 = nLibro;
                        #caenlac@#12 = aSerie;
                        #caenlac@#13 = nFactu;
                     |FINSI;
                     |SI aCampos14 = "-1";  #caenlac@#31 = "S"; |FINSI;
                     |SI aCampos14 = "0";   #caenlac@#31 = "N"; |FINSI;
                     ||GRABA 020#caenlac@.a;

                     |LEE 000#caenlac@.s;
                  |SIGUE;

                  |SI nMarca = 0;
                     #caenlac@#0 = #trasw002#0;
                     #caenlac@#1 = #trasw002#1;
                     #caenlac@#2 = #trasw002#2;
                     #caenlac@#3 = #trasw002#3;
                     #caenlac@#37 = #trasz008#7;
                     #caenlac@#38 = #trasz008#8;
                     |LEE 000#caenlac@.=;
                     |PARA; |SI FSalida = 0; |Y #caenlac@#0 = #trasw002#0;
                          |Y #caenlac@#1 = #trasw002#1; |Y #caenlac@#2 = #trasw002#2;
                          |Y #caenlac@#37 = #trasz008#7; |Y #caenlac@#38 = #trasz008#8; |HACIENDO;
                        |SI #caenlac@#26 = " ";
                           aAlfa = #caenlac@#4; |QBF aAlfa;
                           aAlfa = aAlfa % 0101;
                           |SI #caenlac@#10 = "S"; aMask = "6"; |SINO; aMask = "7"; |FINSI;
                           |SI aAlfa = aMask;
                              #caenlac@#26 = "B"; #caenlac@#28 = aCampos9;
                              #caenlac@#27 = nIva;
                              #caenlac@#9  = aCampos7;
                              |SALVA_FICHA #caenlac@;
                              nLinea = #caenlac@#3 + 1;
                              #caenlac@#3 = nLinea;
                              |LEE 000#caenlac@.=;
                              |PARA; |SI FSalida = 0; |HACIENDO;
                                 nLinea = #caenlac@#3 + 1;
                                 #caenlac@#3 = nLinea;
                                 |LEE 000#caenlac@.=;
                              |SIGUE;
                              |REPON_FICHA #caenlac@;
                              nIva   = nIva        + 1;
                              ||GRABA 020#caenlac@.a;
                              |SAL;
                           |FINSI;
                        |SINO;
                           |SI #caenlac@#26 = "B"; |Y #caenlac@#30 = "N";
                              |SALVA_FICHA #caenlac@;
                              nLinea = #caenlac@#3 + 1;
                              #caenlac@#3 = nLinea;
                              |LEE 000#caenlac@.=;
                              |PARA; |SI FSalida = 0; |HACIENDO;
                                 nLinea = #caenlac@#3 + 1;
                                 #caenlac@#3 = nLinea;
                                 |LEE 000#caenlac@.=;
                              |SIGUE;
                              |REPON_FICHA #caenlac@;

                              #caenlac@#3 = nLinea; nLinea = #caenlac@#3 + 1;
                              #caenlac@#27 = nIva;
                              #caenlac@#28 = aCampos12;
                              #caenlac@#9  = aCampos10;
                              nIva   = nIva        + 1;
                              ||GRABA 020#caenlac@.n;
                              |SAL;
                           |FINSI;
                        |FINSI;
                        |LEE 000#caenlac@.s;
                     |SIGUE;
                  |FINSI;
               |FINSI;
            |FINSI;
*/
            |HAZ LeeRegistro;
         |SIGUE;
      |FINSI;
      |XCIERRA nHandle;
   |FINSI;

   |SELECT #1#trasw002; |SELECT #1#trasw005;
|DEBUG;
   |BUCLE EscribeIva;
   |CIERRA #trasw002; |CIERRA #trasw005;

   |CIERRA #trasw001; |DELINDEX #trasw001;

   |CIERRA #caenlac@; |DESCARGA_DEF #caenlac@;
   |CIERRA #caivali@; |DESCARGA_DEF #caivali@;
   |CIERRA #camaniv@; |DESCARGA_DEF #camaniv@;
   |CIERRA #caclipr@; |DESCARGA_DEF #caclipr@;
   |CIERRA #camandi@; |DESCARGA_DEF #camandi@;
   |CIERRA #cacuent@; |DESCARGA_DEF #cacuent@;
   |CIERRA #camasil@; |DESCARGA_DEF #camasil@;
   |CIERRA #camasic@; |DESCARGA_DEF #camasic@;
   |CIERRA #canempr@; |DESCARGA_DEF #canempr@;

   |BLIN 22; |BLIN 23;

   enNoModif  = 100;
   aAlfa1 = #trasz008#10; |QBF aAlfa1;
   aAlfa1 = aAlfa1 + "fich/" + ((("00000" + #trasz008#7) % -105) + #trasz008#8) + "/";
   aAlfa = ":contagen/dsapunte.tab;" + aAlfa1 + ",pu" + Usuario;
   |SUB_EJECUTA_NP aAlfa;
|FPRC;

|PROCESO PintaLibro;
   nTecla = FSalida; |SI nTecla = 2; |ACABA; |FINSI;
   aAlfa = #trasz008#10; |QBF aAlfa;
   aAlfa1 = aAlfa + "def/calibros.mas";
   |CARGA_DEF aAlfa1, calibro@;
   |SI FSalida ! 0;
      |MENAV "    Problemas para cargar el def de libros"; |ERROR; |ACABA;
   |FINSI;
   aAlfa = #trasz008#10; |QBF aAlfa;
   aAlfa = aAlfa + "fich/" + (("00000" + #trasz008#7) % -105) + #trasz008#8 + "/";
   |PATH_DAT #109 aAlfa;
   |ABRE #calibro@;
   |SI nTecla = 10;
      |CONSULTA_CLAVE #1#calibro@;
      |SI FSalida = 0;
         #trasz008#Campo# = #calibro@#0;
      |FINSI;
   |FINSI;
   #calibro@#0 = #trasz008#Campo#;
   |LEE 000#calibro@.=;
   |SI FSalida = 0;
      |C_P #trasz008#Campo#, 0, nCalc; nCalc = nCalc + 3;
      |PINTA nCalc, #calibro@#1;
      |SI #calibro@#2 = "R";
         |SI Campo ! 12; |Y Campo ! 14;
            |MENAV "    Libro incorrecto"; |ERROR;
         |FINSI;
      |SINO;
         |SI Campo ! 13; |Y Campo ! 15;
            |MENAV "    Libro incorrecto"; |ERROR;
         |FINSI;
      |FINSI;
   |SINO;
      |MENAV "    Libro inexistente"; |ERROR;
   |FINSI;
   |CIERRA #calibro@; |DESCARGA_DEF #calibro@;
|FPRC;

|PROCESO PasaFecha;
   aAlfa1 = aAlfa % 0; nCont = aAlfa1;
   nCont = nCont + 92; aAlfa = aAlfa % nCont;
|FPRC;

|PROGRAMA;
   |ABRE #trasz008;
   |LEE 000#trasz008.p;
   |SI FSalida ! 0;
      |DDEFECTO #trasz008;
      |GRABA 020#trasz008.c;
   |FINSI;

   |CLS;
   |CABEZA " Traspaso de datos de Logic / Diagram (Contagen)";
   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      |GRABA 020#trasz008.a;
      |CONFI "    NLos datos de la empresa indicada seran eliminados. Continuar ?";
      |SI FSalida = 0;
         |PUSHV 0501 2380;
         |BLANCO 2102 2378;
         |CUADRO 2102 2378;
         |HAZ Traspaso;
         |POPV;
      |FINSI;
   |FINSI;
   |CIERRA #trasz008;

|FPRO;
