|FICHEROS;
     trasz003 #0;

     :integral/dsam0000 #900;        || Empreas
     :integral/dsaw0015 #915;        || Alta de Contabilidades

     :contagen/canempre #800;
     :contagen/cacuenta #801;
     :contagen/cacuebal #802;
     :contagen/caenlace #803;
|FIN;

|VARIABLES;
     nAlta         = 0;
     nHandle       = 0;
     nLong         = 0;
     nError        = 0;
     nAnyo         = 0;
     nApunte       = 0;
     nApunteUlt    = 0;
     nAsiento      = 0;
     nAcum         = 0;
     nApuntador    = 0;
     nContaApunte  = 0;
     nDiario       = 0;
     nDiarioB      = 0;
     nDebe         = 0;
     nHaber        = 0;
     nEsCobro      = 0;

     aAlfa         = "";
     aAlfa1        = "";
     aAlfa2        = "";
     aAlfa3        = "";
     aAlfa4        = "";
     aAlfa5        = "";
     aAlfa4Ant     = "";
     aBase         = "";
     aFich         = "";
     aAbre         = "";
     aCaracter10   = "";
     aCaracter13   = "";
     aLong         = "";
     aCadena       = "";
     aCta          = "";
     aCtaAnt       = "";
     aUno          = "";
     aDos          = "";
     aDes1         = "";
     aDes2         = "";
     aMensa        = "";
     aDia          = "";
     aMes          = "";
     aAnyo         = "";
     aDebe         = "";
     aDebeAnt      = "";
     aHaber        = "";
     aHaberAnt     = "";
     aDocumento    = "";
     aDocumentoAnt = "";
     aDiario       = "";
     aDiarioAnt    = "";
     aAsiento      = "";
     aAsientoAnt   = "";
     aCobro        = "";

     &fich_alta   = "";
     &any_pos     = 0;
     &swOperacion = 0;
     &enEmpresa   = 0;
     &enPeriodo   = 0;
     &eaMoneda    = "";
     &enNoModif   = 0;
|FIN;

|PROCESO GrabaEmpresa;
     |ABRE #900;
     #900#0 = #0#0;
     |LEE 040#900=;
     |SI FSalida ! 0;  |DDEFECTO #900;  |FINSI;
     |CIERRA #900;

     |PUSHV 0501 2380;

     #800#2 = #0#0;
     #800#3 = #0#2;

     |DDEFECTO #915;
     #915#0 = #0#2;

     |PINPA #0#915;
     |PINDA #0#915;
     |ENDATOS #1#915;
     |SI FSalida = 0;
         #800#2  = #0#0;
         #800#3  = #0#2;
         aAlfa1  = (("00000" + #800#2) % -105) + #800#3;
         #800#0  = aAlfa1;
         #800#1  = #900#1;
         #800#4  = #900#2;
         aAlfa1  = #900#19;  |QBF aAlfa1;
         aAlfa2  = #900#20;  |QBF aAlfa2;
         aAlfa3  = #900#21;  |QBF aAlfa3;
         |SI aAlfa3 ! "";
             #800#5  = aAlfa1 + " " + aAlfa2 + ", " + aAlfa3;
         |SINO;
             #800#5  = aAlfa1 + " " + aAlfa2;
         |FINSI;
         #800#6  = (("00" + #900#25) % -102) + (("000" + #900#26) % -103);
         #800#7  = #900#27;
         #800#8  = #900#3;
         #800#9  = #900#54;
         #800#10 = "";
         #800#11 = #915#2;
         #800#12 = #915#3;
         #800#13 = #915#4;
         #800#14 = #915#5;
         #800#15 = #915#6;
         #800#16 = #915#7;
         #800#17 = #915#8;
         #800#18 = #915#9;
         #800#19 = #915#10;
         #800#22 = #915#12;
         #800#23 = #915#13;
         #800#26 = #915#1;
         #800#20 = #915#17;
         #800#21 = #915#12;
         |SI #900#85 = "I";  #800#21 = #900#85;  |FINSI;
         #800#22 = #915#14;
         #800#24 = #915#13;
         #800#27 = #915#11;
         #800#28 = #915#15;
         #800#29 = #915#16;

         |GRABA 020#800n;
         |LIBERA #800;

         |DBASS aAlfa2;   |QBT aAlfa2;
         aAlfa2 = aAlfa2 + "contagen/fich/";
         aAlfa3 = ("000000" + #800#0) % -106;
         aAlfa1 = aAlfa2 + aAlfa3;
         |MKDIR aAlfa1;

         enEmpresa   = #800#2;
         enPeriodo   = #800#3;
         eaMoneda    = #800#28;
         swOperacion = 3;
         |SUB_EJECUTA_NP ":contagen/camoneda";
         swOperacion = 0;

         fich_alta = aAlfa1 + "/";
         any_pos   = #800#26;
         |SUB_EJECUTA ":contagen/cacrebal";
     |FINSI;
     |POPV;

     nAlta = 1;
|FPRC;

|PROCESO MiraEmpresa;
     nAlta = 0;

     |ABRE #800;
     #800#2 = #0#0;
     #800#3 = #0#2;
     |LEE 040#800=;
     |SI FSalida ! 0;  |HAZ GrabaEmpresa;  |FINSI;

     #800#2 = #0#0;
     #800#3 = #0#2;
     |LEE 040#800=;
     |SI FSalida ! 0;  |CIERRA #800;  |ERROR;  |ACABA;  |FINSI;
     |CIERRA #800;

     |SI #800#26 ] 0;  |Y #800#26 [ 80;
         #0#3 = 2000 + #800#26;
     |SINO;
         #0#3 = 1900 + #800#26;
     |FINSI;

     |PINTA #0#3;

     |DBASS aBase;  |QBF aBase;
     aFich = aBase + "contagen/fich/" + (("00000" + #800#2) % -105) + #800#3 + "/";

     |PATH_DAT #801 aFich;
     |PATH_DAT #802 aFich;
     |PATH_DAT #803 aFich;

     |SI nAlta = 1;  |ACABA;  |FINSI;

     |ABRE #801;
     |LEE 040#801p;
     |SI FSalida = 0;
         |CONFI "0000NYa hay datos en la Contabilidad, desea realizar el pase de nuevo ";
         |SI FSalida ! 0;
             |ERROR;
             |CIERRA #801;
             |ACABA;
         |SINO;
             aAlfa  = aBase + "contagen/fich/" + ("000000" + #800#0) % -106;
             aAlfa1 = aBase + "bin/agirm -r " + aAlfa;
             |SYSTEM aAlfa1;

             |ABRE #800;
             #800#2 = #0#0;  #800#3 = #0#2;  |BORRA 020#800c;  |LIBERA #800;
             |CIERRA #800;

             |ERROR;
         |FINSI;
     |FINSI;
     |CIERRA #801;
|FPRC;

|PROCESO Tipo7;  |TIPO 7;
     |DBASE aBase;  |QBF aBase;
     #0#4 = aBase + "pasopi/contabilidad/";
     |PINTA #0#4;
|FPRC;

|PROCESO ExisteFichero;
     aAlfa = #0#4;  |QBF aAlfa;
     aAbre = aAlfa + #0Campo;  |QBF aAbre;

     |XABRE "E", aAbre, nHandle;
     |SI FSalida < 0;
         |MENAV "     No existe el Fichero.";
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO Saca;
     #801#4 = #802#1;
     #801#5 = #802#2;
     #801#6 = #802#3;
     #801#7 = #802#4;
     #801#8 = #802#5;
|FPRC;

|PROCESO Defectos;
     aUno = #801#0;   |QBF aUno;
     aDos = aUno + "000000000000";

     aUno = aDos % 101;
     #802#0 = aUno;
     |LEE 000#802=;
     |SI FSalida = 0;
         |HAZ Saca;
     |SINO;
         aUno = aDos % 102;
         #802#0 = aUno;
         |LEE 000#802=;
         |SI FSalida = 0;
             |HAZ Saca;
         |SINO;
             aUno = aDos % 103;
             #802#0 = aUno;
             |LEE 000#802=;
             |SI FSalida = 0;
                 |HAZ Saca;
             |SINO;
                 aUno = aDos % 104;
                 #802#0 = aUno;
                 |LEE 000#802=;
                 |SI FSalida = 0;
                     |HAZ Saca;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     aLong = aCta;      |QBF aLong;
     aLong = aLong % 0;
     nLong = aLong;

     #801#1 = 0;
     |SI nLong = #800#14;  #801#1 = 1;  |FINSI;
     |SI nLong = #800#15;  #801#1 = 2;  |FINSI;
     |SI nLong = #800#16;  #801#1 = 3;  |FINSI;
     |SI nLong = #800#17;  #801#1 = 4;  |FINSI;
     |SI nLong = #800#18;  #801#1 = 5;  |FINSI;
     |SI nLong = #800#19;  #801#1 = 6;  |FINSI;

     |SI #801#1 = 0;
         aMensa = "     Cuenta fuera de Nivel :" + aCta;
         |MENAV aMensa;
         nError = 1;
     |FINSI;

     aAlfa1   = #801#0;  |QBF aAlfa1;
     aAlfa1   = (#801#0 + "zzzzzzzzzzzz") % 112;
     #801#54  = aAlfa1;
     #801#55  = #801#1;

     |SI #801#1 = #800#13; #801#3 = "S"; |FINSI;
|FPRC;

|PROCESO GrabaCuenta;
     #801#0 = aCta;
     |LEE 101#801=;
     |SI FSalida ! 0;
         |DDEFECTO #801;
         #801#0 = aCta;
         #801#2 = aDes1 + aDes2;
         |GRABA 020#801b;
     |SINO;
         |LIBERA #801;
         |ACABA;
     |FINSI;

     nError = 0;
     |HAZ Defectos;

     |SI nError = 0;
         |GRABA 020#801a;

         |ATRI R;
         |PINTA 1525, #801#0;
         |ATRI r;
     |SINO;
         |BORRA 020#801a;
     |FINSI;
     |LIBERA #801;
|FPRC;

|PROCESO CreaPlan;
     aAlfa = #0#4;  |QBF aAlfa;
     aAbre = aAlfa + #0#5;  |QBF aAbre;

     aCaracter10  = &10;
     aCaracter13  = &13;

     |ABRE #801;
     |ABRE #802;

     |XABRE "BU", aAbre, nHandle;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandle, 1, aAlfa;
          |SI FSalida [ 0;  |SAL;  |FINSI;

          |SI aAlfa = aCaracter13;
              aLong   = aCadena % 0;
              nLong   = aLong;


/*                                                       || Antes
              |SI nLong = 118;
                  aCta  = aCadena % 1112;
                  aDes1 = aCadena % 2426;  |QBF aDes1;
                  aDes2 = aCadena % 5026;
                  |HAZ GrabaCuenta;
              |FINSI;
*/

              |SI nLong = 109;
                  aCta  = aCadena % 0212;
                  aDes1 = aCadena % 1526;  |QBF aDes1;
                  aDes2 = aCadena % 4126;
                  |HAZ GrabaCuenta;
              |FINSI;

              aCadena = "";
          |FINSI;

          |SI aAlfa ! aCaracter10;  |Y aAlfa ! aCaracter13;
              aCadena = aCadena + aAlfa;
          |FINSI;
     |SIGUE;
     |XCIERRA nHandle;

     |CIERRA #801;
     |CIERRA #802;
|FPRC;

|PROCESO GrabaTrabajo;
     |SI #800#14 ! 0;  nLong = #800#14;  |FINSI;
     |SI #800#15 ! 0;  nLong = #800#15;  |FINSI;
     |SI #800#16 ! 0;  nLong = #800#16;  |FINSI;
     |SI #800#17 ! 0;  nLong = #800#17;  |FINSI;
     |SI #800#18 ! 0;  nLong = #800#18;  |FINSI;
     |SI #800#19 ! 0;  nLong = #800#19;  |FINSI;
     nLong = 100 + nLong;

     aCta = aCadena % 5712;   |QBF aCta;
     |QBF aCta;
     aCta = (aCta + "000000000000") % nLong;

     aDia   = aCadena % 0102;
     aMes   = aCadena % 0402;
     aAnyo  = aCadena % 0702;
     nAnyo  = aAnyo;
     |SI nAnyo ] 0;  |Y nAnyo [ 80;
         aAnyo = "20" + aAnyo;
     |SINO;
         aAnyo = "19" + aAnyo;
     |FINSI;

     aAlfa4     = aDia + "." + aMes + "." + aAnyo;
     aDocumento = aCadena % 2208;
     aAlfa3     = aCadena % 1506;
     aAsiento   = aCadena % 1004;

     |SI aDiario ! aDiarioAnt;
         |SI aDiario ! "00";  |Y aDiario ! "99";
             nDiarioB = nDiarioB + 1;
             nDiario  = nDiarioB;
         |SINO;
             nDiario = aDiario;
         |FINSI;

         nAsiento      = 1;
         nApunte       = 0;
         nApunteUlt    = 0;
         nContaApunte  = 0;
         nDebe         = 0;
         nHaber        = 0;
         aDiarioAnt    = aDiario;
         aDocumentoAnt = aDocumento;
     |FINSI;

     |SI aAsiento ! aAsientoAnt;
         nAsiento      = nAsiento + 1;
         nApunte       = 0;
         nApunteUlt    = 0;
         nContaApunte  = 0;
         nAcum         = 0;
         nDebe         = 0;
         nHaber        = 0;
         aAsientoAnt   = aAsiento;
         aDocumentoAnt = aDocumento;
     |FINSI;

     |SI aDocumentoAnt ! aDocumento;
         aDebe  = aCadena % 9011;   |QBF aDebe;
         aHaber = aCadena % 10211;  |QBF aHaber;

         |SI nDebe = 1;  |Y nHaber = 1;
             nAsiento      = nAsiento + 1;
             nApunte       = 0;
             nApunteUlt    = 0;
             nContaApunte  = 0;
             nAcum         = 0;
             nDebe         = 0;
             nHaber        = 0;
         |SINO;
             nContaApunte  = 0;
         |FINSI;

         aDocumentoAnt = aDocumento;
     |FINSI;

     aDebe      = aCadena % 9011;   |QBF aDebe;
     |SI aDebe ! "";  nDebe = 1;    |FINSI;

     aHaber     = aCadena % 10211;  |QBF aHaber;
     |SI aHaber ! "";  nHaber = 1;  |FINSI;

     aCtaAnt = aCta;
     #801#0  = aCta;
     |LEE 040#801=;
     |SI FSalida ! 0;
         aAlfa1 = aCta % 104;
         #801#0 = aAlfa1;
         |LEE 040#801=;
         |SI FSalida ! 0;  |DDEFECTO #801; |FINSI;

         aDes1 = #801#2;
         aDes2 = "";
         aCta  = aCtaAnt;
         |HAZ GrabaCuenta;
     |FINSI;

     aCta = aCtaAnt;

     #803#13 = aDocumento;
     aAlfa1  = aCta % 103;
     aAlfa2  = aCta % 101;

     aAlfa5   = aCadena % 3125;
     nEsCobro = 0;
     aCobro   = aAlfa5 - "COBRADA FACTURA";
     |SI FSalida ! 0;  nEsCobro = 1;  |FINSI;

     aCobro   = aAlfa5 - "COBRO FRAS. PDTES.";
     |SI FSalida ! 0;  nEsCobro = 1;  |FINSI;

     |SI #803#13 ! 0;  |Y nEsCobro = 0;
         nContaApunte = nContaApunte + 1;
         nApuntador   = 0;

         |SI aAlfa1 = "400";  |O aAlfa1 = "410";
             |SI nContaApunte = 3;  nApuntador = -2;  |FINSI;
             |SI nContaApunte = 2;  nApuntador = -1;  |FINSI;
             |SI nContaApunte = 1;  nApuntador =  1;  |FINSI;
         |FINSI;

         |SI aAlfa1 = "472";
             |SI nContaApunte = 1;  nApuntador =  2;  |FINSI;
         |FINSI;

         |SI aAlfa2 = "6";  |O aAlfa2 = "2";
             |SI nContaApunte = 1;  nApuntador =  2;  |FINSI;
         |FINSI;

         |SI aAlfa1 = "430";  |O aAlfa1 = "440";
             |SI nContaApunte = 3;  nApuntador = -2;  |FINSI;
             |SI nContaApunte = 2;  nApuntador = -1;  |FINSI;
             |SI nContaApunte = 1;  nApuntador =  1;  |FINSI;
         |FINSI;

         |SI aAlfa1 = "477";
             |SI nContaApunte = 1;  nApuntador =  2;  |FINSI;
         |FINSI;

         |SI aAlfa2 = "7";
             |SI nContaApunte = 1;  nApuntador =  2;  |FINSI;
         |FINSI;

         |SI nApuntador = 0; nApuntador = 1;  |FINSI;
     |SINO;
         nContaApunte = 0;
         nApuntador   = 1;
     |FINSI;

     nApunte = nApunte + nApuntador;

     |DDEFECTO #803;
     #803#0  = nDiario;
     #803#1  = aAlfa4;
     #803#2  = nAsiento;
     #803#3  = nApunte;
     #803#37 = #0#0;
     #803#38 = #0#2;
     #803#4  = #801#0;
     #803#5  = #801#1;
     #803#6  = 999;
     #803#13 = aDocumento;
     #803#29 = aAlfa4;
     #803#7  = aCadena % 3125;

     |SI aDebe ! "";
         #803#8 = "D";
         #803#9 = aDebe;
     |SINO;
         #803#8 = "H";
         #803#9 = aHaber;
     |FINSI;

     aAlfa1 = aCta % 103;
     aAlfa2 = aCta % 101;

     |SI #803#13 ! 0;  |Y nEsCobro = 0;
         |SI aAlfa1 = "400";  |O aAlfa1 = "410";
             #803#10 = "S";
             #803#26 = "F";
             #803#27 = 0;
             #803#11 = 2;
         |FINSI;

         |SI aAlfa1 = "472";
             #803#10 = "S";
             #803#26 = "I";
             #803#27 = nAcum;
             #803#11 = 2;
         |FINSI;

         |SI aAlfa2 = "6";  |O aAlfa2 = "2";
             nAcum   = nAcum + 1;

             #803#10 = "S";
             #803#26 = "B";
             #803#27 = nAcum;
             #803#11 = 2;
         |FINSI;

         |SI aAlfa1 = "430";  |O aAlfa1 = "440";
             #803#10 = "R";
             #803#26 = "F";
             #803#27 = 0;
             #803#11 = 1;
             nAcum   = nAcum + 1;
         |FINSI;

         |SI aAlfa1 = "477";
             #803#10 = "R";
             #803#26 = "I";
             #803#27 = nAcum;
             #803#11 = 1;
         |FINSI;

         |SI aAlfa2 = "7";
             #803#10 = "R";
             #803#26 = "B";
             #803#27 = nAcum;
             #803#11 = 1;
         |FINSI;
     |FINSI;

     #803#15 = "01";
     |GRABA 020#803n;
     |LIBERA #803;

     |ATRI R;
     |PINTA 1625, #803#0;
     |PINTA 1628, #803#1;
     |PINTA 1639, #803#2;
     |PINTA 1646, #803#3;
     |ATRI r;

     |SI nApunte > nApunteUlt;
         nApunteUlt = nApunte;
     |FINSI;

     nApunte  = nApunteUlt;
|FPRC;

|PROCESO CreaDiario;
     |ABRE #803;  |CIERRA #803;  |DELINDEX #803;

     aAlfa = #0#4;  |QBF aAlfa;
     aAbre = aAlfa + #0#6;  |QBF aAbre;

     aCaracter10  = &10;
     aCaracter13  = &13;

     |ABRE #801;
     |ABRE #802;
     |ABRE #803;

     nAsiento      = 0;
     aDocumento    = "";
     aDocumentoAnt = "";
     aDiario       = "";
     aDiarioAnt    = "";
     aAsiento      = "";
     aAsientoAnt   = "";
     nDiarioB      = 0;
     nDiario       = 0;

     |XABRE "BU", aAbre, nHandle;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandle, 1, aAlfa;
          |SI FSalida [ 0;  |SAL;  |FINSI;

          |SI aAlfa = aCaracter13;
              aAlfa1 = (aCadena % 301) + (aCadena % 601)
              |SI aAlfa1 = "--";
                  aAlfa1 = aCadena % 101;
                  |SI aAlfa1 ! "-";
                      |HAZ GrabaTrabajo;
                  |FINSI;
              |SINO;
                  aAlfa1 = aCadena - "DIARIO : ";
                  |SI FSalida ! 0;
                      aDiario = aCadena % 5503;
                      |SI aDiario = "APE";  aDiario = "00";  |FINSI;
                      |SI aDiario = "CIE";  aDiario = "99";  |FINSI;
                  |FINSI;
              |FINSI;

              aCadena = "";
          |FINSI;

          |SI aAlfa ! aCaracter10;  |Y aAlfa ! aCaracter13;
              aCadena = aCadena + aAlfa;
          |FINSI;
     |SIGUE;
     |XCIERRA nHandle;

     |CIERRA #801;
     |CIERRA #802;
     |CIERRA #803;

     enNoModif = 100;
     |DBASS aBase;  |QBF aBase;
     aAlfa = ":contagen/dsapunte;" + aBase + "contagen/fich/" + (("000000" + #800#0) % -106) + "/";
     |SUB_EJECUTA_NP aAlfa;

     |DELINDEX #803;
|FPRC;

|PROCESO Tipo3;  |TIPO 3;
     |ABRE #800;
     #800#2 = #0#0;
     #800#3 = #0#2;
     |LEE 040#800=;
     |SI FSalida ! 0;  |DDEFECTO #800;  |FINSI;
     |CIERRA #800;

     |HAZ CreaPlan;
     |HAZ CreaDiario;
|FPRC;
