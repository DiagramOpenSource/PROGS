|FICHEROS;
     trasz007 #0;

     :/contagen/def/canempre #800;
     :/contagen/def/cacuenta #801;
     :/contagen/def/cacuebal #802;
     :/contagen/def/caenlace #803;
     :/contagen/def/caclipro #804;

     trasw003 #915,MANTE;
     trasw004 #904;
|FIN;

|VARIABLES;
     nAlta         = 0;
     nHandle       = 0;
     nLong         = 0;
     nError        = 0;
     nAnyo         = 0;
     nApunte       = 0;
     nApunteUlt    = 0;
     nAsiento      = 0;
     nApuntador    = 0;
     nContaApunte  = 0;
     nDiario       = 0;
     nDiarioB      = 0;
     nDebe         = 0;
     nHaber        = 0;
     nEsCobro      = 0;
     nCampo        = 0;
     nLongNume     = 0;
     nCarac        = 0;
     nPosi         = 0;
     nHayIva       = 0;
     nCampo1       = 0;
     nCampo2       = 0;
     nCampo3       = 0;
     nCampo4       = 0;
     nCampo5       = 0;
     nBase         = 0;
     nLinea        = 0;

     aAlfa         = "";
     aAlfa1        = "";
     aAlfa2        = "";
     aAlfa3        = "";
     aAlfa4        = "";
     aAlfa5        = "";
     aAlfa4Ant     = "";
     aBase         = "";
     aFich         = "";
     aAbre         = "";
     aCaracter10   = "";
     aCaracter13   = "";
     aLong         = "";
     aCadena       = "";
     aCta          = "";
     aCtaAnt       = "";
     aUno          = "";
     aDos          = "";
     aDes1         = "";
     aDes2         = "";
     aMensa        = "";
     aDia          = "";
     aMes          = "";
     aAnyo         = "";
     aDebe         = "";
     aDebeAnt      = "";
     aHaber        = "";
     aHaberAnt     = "";
     aDocumento    = "";
     aDocumentoAnt = "";
     aDiario       = "";
     aDiarioAnt    = "";
     aAsiento      = "";
     aAsientoAnt   = "";
     aCobro        = "";
     aDirec        = "";
     aHoja         = "";
     aNombreHoja   = "";
     aTipo         = "";
     aCampo        = "";
     aCampoA       = "";
     aCampoB       = "";
     aCampoC       = "";
     aCampoD       = "";
     aCampoE       = "";
     aCampoF       = "";
     aCampoG       = "";
     aCampoH       = "";
     aCampoI       = "";
     aCampoJ       = "";
     aCampoK       = "";
     aCampoL       = "";
     aCampoM       = "";
     aCampoN       = "";
     aCampoO       = "";
     aCampoR       = "";
     aCampoS       = "";
     aLongAlfa     = "";
     aImporte      = "";
     aCaracter     = "";
     aFichero      = "";

     &fich_alta   = "";
     &any_pos     = 0;
     &swOperacion = 0;
     &enEmpresa   = 0;
     &enPeriodo   = 0;
     &eaMoneda    = "";
     &enNoModif   = 0;
|FIN;

|PROCESO GrabaEmpresa;
     |PUSHV 0501 2380;

     #800#2 = #0#0;
     #800#3 = #0#2;

     |DDEFECTO #915;
     #915#0 = #0#2;

     |PINPA #0#915;
     |PINDA #0#915;
     |ENDATOS #1#915;
     |SI FSalida = 0;
         #800#2  = #0#0;
         #800#3  = #0#2;
         aAlfa1  = (("00000" + #800#2) % -105) + #800#3;
         #800#0  = aAlfa1;
         #800#1  = #0#1;
         #800#10 = "";
         #800#11 = #915#2;
         #800#12 = #915#3;
         #800#13 = #915#4;
         #800#14 = #915#5;
         #800#15 = #915#6;
         #800#16 = #915#7;
         #800#17 = #915#8;
         #800#18 = #915#9;
         #800#19 = #915#10;
         #800#22 = #915#12;
         #800#23 = #915#13;
         #800#26 = #915#1;
         #800#20 = #915#17;
         #800#21 = #915#12;
         #800#22 = #915#14;
         #800#24 = #915#13;
         #800#27 = #915#11;
         #800#28 = #915#15;
         #800#29 = #915#16;

         |GRABA 020#800n;
         |LIBERA #800;

         |DBASS aAlfa2;   |QBT aAlfa2;
         aAlfa2 = aAlfa2 + "contagen/fich/";
         aAlfa3 = ("000000" + #800#0) % -106;
         aAlfa1 = aAlfa2 + aAlfa3;
         |MKDIR aAlfa1;

         enEmpresa   = #800#2;
         enPeriodo   = #800#3;
         eaMoneda    = #800#28;
         swOperacion = 3;
         |SUB_EJECUTA_NP ":contagen/camoneda";
         swOperacion = 0;

         fich_alta = aAlfa1 + "/";
         any_pos   = #800#26;
         |SUB_EJECUTA ":contagen/cacrebal";
     |FINSI;
     |POPV;

     nAlta = 1;
|FPRC;

|PROCESO MiraEmpresa;
     nAlta = 0;

     |ABRE #800;
     #800#2 = #0#0;
     #800#3 = #0#2;
     |LEE 040#800=;
     |SI FSalida ! 0;  |HAZ GrabaEmpresa;  |FINSI;

     #800#2 = #0#0;
     #800#3 = #0#2;
     |LEE 040#800=;
     |SI FSalida ! 0;  |CIERRA #800;  |ERROR;  |ACABA;  |FINSI;
     |CIERRA #800;

     |SI #800#26 ] 0;  |Y #800#26 [ 80;
         #0#3 = 2000 + #800#26;
     |SINO;
         #0#3 = 1900 + #800#26;
     |FINSI;

     |PINTA #0#3;

     |DBASS aBase;  |QBF aBase;
     aFich = aBase + "contagen/fich/" + (("00000" + #800#2) % -105) + #800#3 + "/";

     |PATH_DAT #801 aFich;
     |PATH_DAT #802 aFich;
     |PATH_DAT #803 aFich;
     |PATH_DAT #804 aFich;

     |SI nAlta = 1;  |ACABA;  |FINSI;

     |ABRE #801;
     |LEE 040#801p;
     |SI FSalida = 0;
         |CONFI "0000NYa hay datos en la Contabilidad, desea realizar el pase de nuevo ";
         |SI FSalida ! 0;
             |ERROR;
             |CIERRA #801;
             |ACABA;
         |SINO;
             aAlfa  = aBase + "contagen/fich/" + ("000000" + #800#0) % -106;
             aAlfa1 = aBase + "bin/agirm -r " + aAlfa;
             |SYSTEM aAlfa1;

             |ABRE #800;
             #800#2 = #0#0;  #800#3 = #0#2;  |BORRA 020#800c;  |LIBERA #800;
             |CIERRA #800;

             |ERROR;
         |FINSI;
     |FINSI;
     |CIERRA #801;
|FPRC;

|PROCESO Browse7;  |TIPO 7;
     aAlfa = #0#4;  |QBF aAlfa;
     |SI aAlfa = "";
         |PTEC 802;
     |FINSI;
|FPRC;

|PROCESO Browse;  |TIPO 0;
     aAlfa = #0#4;  |QBF aAlfa;
     |SI aAlfa = "";
         aDirec = "D";
         |BROWSE aDirec;
         aDirec = aDirec % 275;  |QBF aDirec;
         |SI aDirec = "";
             |MENAV "0000 Introduzca la carpeta donde se encuentran los ficheros a tratar.";
             |ERROR;
             |ACABA;
         |FINSI;

         aDirec = aDirec + "\";
         #0#4   = aDirec;  |PINTA #0#4;
     |FINSI;
|FPRC;

|PROCESO ExisteFichero;
     aAlfa = #0Campo;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     aAlfa = #0#4;  |QBF aAlfa;
     aAbre = aAlfa + #0Campo;  |QBF aAbre;
     aAbre = aAbre + ".xls";

     |XABRE "EC", aAbre, nHandle;
     |SI FSalida < 0;
         |MENAV "     No existe el Fichero.";
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO LeeCasilla;
     #0#14 = "Fichero: " + aNombreHoja + "   Registro: " + nCampo;
     |PINTA #0#14;

     |ALFACALLDLL "agixl97.dll", "peek_dato", aCampo;  |QBF aCampo;
|FPRC;

|PROCESO Saca;
     #801#4 = #802#1;
     #801#5 = #802#2;
     #801#6 = #802#3;
     #801#7 = #802#4;
     #801#8 = #802#5;
|FPRC;

|PROCESO Defectos;
     aUno  = #801#0;   |QBF aUno;
     aDos  = aUno + "000000000000";

     aUno = aDos % 101;
     #802#0 = aUno;
     |LEE 000#802=;
     |SI FSalida = 0;
         |HAZ Saca;
     |SINO;
         aUno = aDos % 102;
         #802#0 = aUno;
         |LEE 000#802=;
         |SI FSalida = 0;
             |HAZ Saca;
         |SINO;
             aUno = aDos % 103;
             #802#0 = aUno;
             |LEE 000#802=;
             |SI FSalida = 0;
                 |HAZ Saca;
             |SINO;
                 aUno = aDos % 104;
                 #802#0 = aUno;
                 |LEE 000#802=;
                 |SI FSalida = 0;
                     |HAZ Saca;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     aLong = aCta;      |QBF aLong;
     aLong = aLong % 0;
     nLong = aLong;

     #801#1 = 0;
     |SI nLong = #800#14;  #801#1 = 1;  |FINSI;
     |SI nLong = #800#15;  #801#1 = 2;  |FINSI;
     |SI nLong = #800#16;  #801#1 = 3;  |FINSI;
     |SI nLong = #800#17;  #801#1 = 4;  |FINSI;
     |SI nLong = #800#18;  #801#1 = 5;  |FINSI;
     |SI nLong = #800#19;  #801#1 = 6;  |FINSI;

     |SI #801#1 = 0;
         aMensa = "     Cuenta fuera de Nivel :" + aCta;
         |MENAV aMensa;
         nError = 1;
     |FINSI;

     aAlfa1   = #801#0;  |QBF aAlfa1;
     aAlfa1   = (#801#0 + "zzzzzzzzzzzz") % 112;
     #801#54  = aAlfa1;
     #801#55  = #801#1;

     |SI #801#1 = #800#13; #801#3 = "S"; |FINSI;
|FPRC;

|PROCESO ClienteProveedores;
                        aTipo = "C";
     |SI aAlfa ! "43";  aTipo = "P";  |FINSI;

     #804#23  = aTipo;
     #804#10  = #801#0;
     |LEE 101#804=;
     |SI FSalida ! 0;
         |DDEFECTO #804;
         #804#23  = aTipo;
         #804#10  = #801#0;
         #804#11  = #801#1;
         |GRABA 020#804b;
     |FINSI;

     #804#0 = aCampoA;
                        #804#1 = aCampoC;
     |SI aCampoC = "";  #804#1 = aCampoD;  |FINSI;

     #804#2 = aCampoE;

     aAlfa = aCampoF % 102;  #804#3 = aAlfa;
     aAlfa = aCampoF % 303;  #804#4 = aAlfa;

     #804#5 = aCampoH;
     #804#6 = aCampoG;
     #804#7 = aCampoJ;
     #804#8 = aCampoK;
     #804#9 = aCampoI;

     |GRABA 020#804a;
     |LIBERA #804;
|FPRC;

|PROCESO GrabaCuenta;
     #801#0 = aCampoA;
     |LEE 101#801=;
     |SI FSalida ! 0;
         |DDEFECTO #801;
         #801#0 = aCampoA;
         #801#2 = aCampoB;
         |GRABA 020#801b;
     |SINO;
         |LIBERA #801;
         |ACABA;
     |FINSI;

     nError = 0;
     |HAZ Defectos;

     |SI nError = 0;
         |GRABA 020#801a;
     |SINO;
         |BORRA 020#801a;
     |FINSI;
     |LIBERA #801;

     aAlfa = aCampoA % 102;
     |SI aAlfa = "43";  |O aAlfa = "40";  |O aAlfa = "41";
         |HAZ ClienteProveedores;
     |FINSI;
|FPRC;

|PROCESO PlanContable;
     aAlfa = #0#5;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     |ABRE #801;
     |ABRE #802;
     |ABRE #804;

     aHoja       = #0#4 + #0#5;            |QBT aHoja;
     aHoja       = aHoja + ".xls";
     aNombreHoja = #0#5;                   |QBF aNombreHoja;
     aNombreHoja = aNombreHoja + ".xls";

     |ALFACALLDLL "agixl97.dll", "carga_book", aHoja;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja";

     nCampo    = 1;
     |PARA; |SI; |HACIENDO;
          aCampo = "A" + nCampo;  |HAZ LeeCasilla;  aCampoA = aCampo;
          |SI aCampoA = "";  |SAL;  |FINSI;

          aCampo = "B" + nCampo;  |HAZ LeeCasilla;  aCampoB = aCampo;
          aCampo = "C" + nCampo;  |HAZ LeeCasilla;  aCampoC = aCampo;
          aCampo = "D" + nCampo;  |HAZ LeeCasilla;  aCampoD = aCampo;
          aCampo = "E" + nCampo;  |HAZ LeeCasilla;  aCampoE = aCampo;
          aCampo = "F" + nCampo;  |HAZ LeeCasilla;  aCampoF = aCampo;
          aCampo = "G" + nCampo;  |HAZ LeeCasilla;  aCampoG = aCampo;
          aCampo = "H" + nCampo;  |HAZ LeeCasilla;  aCampoH = aCampo;
          aCampo = "I" + nCampo;  |HAZ LeeCasilla;  aCampoI = aCampo;
          aCampo = "J" + nCampo;  |HAZ LeeCasilla;  aCampoJ = aCampo;
          aCampo = "K" + nCampo;  |HAZ LeeCasilla;  aCampoK = aCampo;

          aCta   = aCampoA;
          |HAZ GrabaCuenta;

          nCampo = nCampo + 1;
     |SIGUE;

     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";

     |CIERRA #801;
     |CIERRA #802;
     |CIERRA #804;
|FPRC;

|PROCESO GrabaCuentaApertura;
     #801#0 = aCampoA;
     |LEE 101#801=;
     |SI FSalida ! 0;
         |DDEFECTO #801;
         #801#0 = aCta;
         #801#2 = aDes1;
         |GRABA 020#801b;
     |SINO;
         |LIBERA #801;
         |ACABA;
     |FINSI;

     nError = 0;
     |HAZ Defectos;

     |SI nError = 0;
         |GRABA 020#801a;
     |SINO;
         |BORRA 020#801a;
     |FINSI;
     |LIBERA #801;
|FPRC;

|PROCESO QuitaPuntos;
     aLongAlfa = aImporte % 0;
     nLongNume = aLongAlfa;
     aAlfa     = "";
     |PARA nCarac = 1; |SI nCarac [ nLongNume; |HACIENDO nCarac = nCarac + 1;
           nPosi     = (nCarac * 100) + 1;
           aCaracter = aImporte % nPosi;
           |SI aCaracter ! ".";
               aAlfa = aAlfa + aCaracter;
           |FINSI;
     |SIGUE;
|FPRC;

|PROCESO GrabaApertura;
     #801#0  = aCampoA;
     |LEE 040#801=;
     |SI FSalida ! 0;
         aAlfa1 = aCampoA % 104;
         #801#0 = aAlfa1;
         |LEE 040#801=;
         |SI FSalida ! 0;  |DDEFECTO #801; |FINSI;

         aCta  = aCampoA;
         aDes1 = #801#2;
         aDes2 = "";
         |HAZ GrabaCuenta;
     |FINSI;

     nApunte = nApunte + 1;

     |DDEFECTO #803;
     #803#0  = 00;
     aAlfa   = "01.01." + #0#3;
     #803#1  = aAlfa;
     #803#2  = 1;
     #803#3  = nApunte;
     #803#37 = #0#0;
     #803#38 = #0#2;
     #803#4  = #801#0;
     #803#5  = #801#1;
     #803#6  = 999;
     #803#13 = 0;
     #803#29 = "";
     #803#7  = "APERTURA DEL EJERCICIO CONTABLE";

     nDebe   = aCampoC;
     nHaber  = aCampoD;
     |SI nDebe ! 0;
         aImporte = aCampoC;
         |HAZ QuitaPuntos;
         #803#8   = "D";
         #803#9   = aAlfa;
     |SINO;
         aImporte = aCampoD;
         |HAZ QuitaPuntos;
         #803#8 = "H";
         #803#9   = aAlfa;
     |FINSI;

     #803#15 = "01";
     |GRABA 020#803n;
     |LIBERA #803;
|FPRC;

|PROCESO AsientoApertura;
     aAlfa = #0#6;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     aHoja       = #0#4 + #0#6;            |QBT aHoja;
     aHoja       = aHoja + ".xls";
     aNombreHoja = #0#6;                   |QBF aNombreHoja;
     aNombreHoja = aNombreHoja + ".xls";

     |ALFACALLDLL "agixl97.dll", "carga_book", aHoja;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja";

     nCampo    = 1;
     |PARA; |SI; |HACIENDO;
          aCampo = "A" + nCampo;  |HAZ LeeCasilla;  aCampoA = aCampo;
          |SI aCampoA = "";  |SAL;  |FINSI;

          aCampo = "B" + nCampo;  |HAZ LeeCasilla;  aCampoB = aCampo;
          aCampo = "C" + nCampo;  |HAZ LeeCasilla;  aCampoC = aCampo;
          aCampo = "D" + nCampo;  |HAZ LeeCasilla;  aCampoD = aCampo;
          aCampo = "E" + nCampo;  |HAZ LeeCasilla;  aCampoE = aCampo;

          |HAZ GrabaApertura;

          nCampo = nCampo + 1;
     |SIGUE;

     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
|FPRC;

|PROCESO GrabaIva1;
     |QBT aCampoB;

     |DDEFECTO #904;
     #904#0 = aTipo;
     #904#1 = aCampoB;
     #904#2 = aCampoC;
     aAlfa  = (aCampoD % 102) + "." + (aCampoD % 402) + "." + (aCampoD % -104);
     #904#3 = aAlfa;
     #904#4 = aCampoF;
                         #904#5 = "N";
     |SI aCampoH ! "0";  #904#5 = "S";  |FINSI;
                         #904#6 = "N";
     |SI aCampoI ! "0";  #904#6 = "S";  |FINSI;

     #904#7 = aCampoK;
     aImporte = aCampoL;  |HAZ QuitaPuntos;
     #904#8   = aAlfa;
     #904#9   = aCampoM;
     aImporte = aCampoN;  |HAZ QuitaPuntos;
     #904#10  = aAlfa;
     #904#11  = aCampoO;

     |GRABA 020#904n;
     |LIBERA #904;
|FPRC;

|PROCESO GrabaIva2;
     |QBT aCampoB;

     #904#0 = aTipo;
     #904#1 = aCampoB;
     #904#2 = aCampoC;
     |LEE 101#904=;
     |SI FSalida ! 0;
         |DDEFECTO #904;
         #904#0 = aTipo;
         #904#1 = aCampoB;
         #904#2 = aCampoC;
     |FINSI;

     |PARA nCampo1 = 12;  |SI nCampo1 [ 40;  |HACIENDO nCampo1 = nCampo1 + 7;
           nCampo2 = nCampo1 + 1;
           aAlfa   = #904nCampo1;  |QBF aAlfa;
           |SI aAlfa = "";
               #904nCampo1 = aCampoE;
               aImporte = aCampoF;  |HAZ QuitaPuntos;
               #904nCampo2 = aAlfa;
               |SAL;
           |FINSI;
     |SIGUE;

     |GRABA 020#904a;
     |LIBERA #904;
|FPRC;

|PROCESO GrabaIva3;
     |QBT aCampoB;

     #904#0 = aTipo;
     #904#1 = aCampoB;
     #904#2 = aCampoC;
     |LEE 101#904=;
     |SI FSalida ! 0;
         |DDEFECTO #904;
         #904#0 = aTipo;
         #904#1 = aCampoB;
         #904#2 = aCampoC;
     |FINSI;

     |PARA nCampo1 = 14;  |SI nCampo1 [ 42;  |HACIENDO nCampo1 = nCampo1 + 7;
           nCampo2 = nCampo1 + 1;
           nCampo3 = nCampo1 + 2;
           nCampo4 = nCampo1 + 3;
           nCampo5 = nCampo1 + 4;
           |SI #904nCampo1 = 0;  |Y #904nCampo2 = 0;
               aImporte = aCampoE;  |HAZ QuitaPuntos;
               #904nCampo1 = aAlfa;

               #904nCampo2 = aCampoF;

               aImporte    = aCampoG;  |HAZ QuitaPuntos;
               #904nCampo3 = aAlfa;

               aImporte    = aCampoH;  |HAZ QuitaPuntos;
               #904nCampo4 = aAlfa;

                                   #904nCampo5 = "N";
               |SI aCampoL ! "0";  #904nCampo5 = "S";  |FINSI;

               |SAL;
           |FINSI;
     |SIGUE;

     |GRABA 020#904a;
     |LIBERA #904;
|FPRC;

|PROCESO IvaRep1;
     aAlfa = #0#8;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     aHoja       = #0#4 + #0#8;            |QBT aHoja;
     aHoja       = aHoja + ".xls";
     aNombreHoja = #0#8;                   |QBF aNombreHoja;
     aNombreHoja = aNombreHoja + ".xls";

     |ALFACALLDLL "agixl97.dll", "carga_book", aHoja;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja";

     nCampo    = 1;
     |PARA; |SI; |HACIENDO;
          aCampo = "A" + nCampo;  |HAZ LeeCasilla;  aCampoA = aCampo;
          |SI aCampoA = "";  |SAL;  |FINSI;

          aCampo = "B" + nCampo;  |HAZ LeeCasilla;  aCampoB = aCampo;
          aCampo = "C" + nCampo;  |HAZ LeeCasilla;  aCampoC = aCampo;
          aCampo = "D" + nCampo;  |HAZ LeeCasilla;  aCampoD = aCampo;
          aCampo = "F" + nCampo;  |HAZ LeeCasilla;  aCampoF = aCampo;
          aCampo = "H" + nCampo;  |HAZ LeeCasilla;  aCampoH = aCampo;
          aCampo = "I" + nCampo;  |HAZ LeeCasilla;  aCampoI = aCampo;
          aCampo = "K" + nCampo;  |HAZ LeeCasilla;  aCampoK = aCampo;
          aCampo = "L" + nCampo;  |HAZ LeeCasilla;  aCampoL = aCampo;
          aCampo = "M" + nCampo;  |HAZ LeeCasilla;  aCampoM = aCampo;
          aCampo = "N" + nCampo;  |HAZ LeeCasilla;  aCampoN = aCampo;
          aCampo = "O" + nCampo;  |HAZ LeeCasilla;  aCampoO = aCampo;

          aTipo = "R";  |HAZ GrabaIva1;

          nCampo = nCampo + 1;
     |SIGUE;

     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
|FPRC;

|PROCESO IvaRep2;
     aAlfa = #0#9;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     aHoja       = #0#4 + #0#9;            |QBT aHoja;
     aHoja       = aHoja + ".xls";
     aNombreHoja = #0#9;                   |QBF aNombreHoja;
     aNombreHoja = aNombreHoja + ".xls";

     |ALFACALLDLL "agixl97.dll", "carga_book", aHoja;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja";

     nCampo    = 1;
     |PARA; |SI; |HACIENDO;
          aCampo = "A" + nCampo;  |HAZ LeeCasilla;  aCampoA = aCampo;
          |SI aCampoA = "";  |SAL;  |FINSI;

          aCampo = "B" + nCampo;  |HAZ LeeCasilla;  aCampoB = aCampo;
          aCampo = "C" + nCampo;  |HAZ LeeCasilla;  aCampoC = aCampo;
          aCampo = "E" + nCampo;  |HAZ LeeCasilla;  aCampoE = aCampo;
          aCampo = "F" + nCampo;  |HAZ LeeCasilla;  aCampoF = aCampo;

          aTipo = "R";  |HAZ GrabaIva2;

          nCampo = nCampo + 1;
     |SIGUE;

     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
|FPRC;

|PROCESO IvaRep3;
     aAlfa = #0#10;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     aHoja       = #0#4 + #0#10;            |QBT aHoja;
     aHoja       = aHoja + ".xls";
     aNombreHoja = #0#10;                   |QBF aNombreHoja;
     aNombreHoja = aNombreHoja + ".xls";

     |ALFACALLDLL "agixl97.dll", "carga_book", aHoja;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja";

     nCampo    = 1;
     |PARA; |SI; |HACIENDO;
          aCampo = "A" + nCampo;  |HAZ LeeCasilla;  aCampoA = aCampo;
          |SI aCampoA = "";  |SAL;  |FINSI;

          aCampo = "B" + nCampo;  |HAZ LeeCasilla;  aCampoB = aCampo;
          aCampo = "C" + nCampo;  |HAZ LeeCasilla;  aCampoC = aCampo;
          aCampo = "E" + nCampo;  |HAZ LeeCasilla;  aCampoE = aCampo;
          aCampo = "F" + nCampo;  |HAZ LeeCasilla;  aCampoF = aCampo;
          aCampo = "G" + nCampo;  |HAZ LeeCasilla;  aCampoG = aCampo;
          aCampo = "H" + nCampo;  |HAZ LeeCasilla;  aCampoH = aCampo;
          aCampo = "L" + nCampo;  |HAZ LeeCasilla;  aCampoL = aCampo;

          aTipo = "R";  |HAZ GrabaIva3;

          nCampo = nCampo + 1;
     |SIGUE;

     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
|FPRC;

|PROCESO IvaSop1;
     aAlfa = #0#11;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     aHoja       = #0#4 + #0#11;            |QBT aHoja;
     aHoja       = aHoja + ".xls";
     aNombreHoja = #0#11;                   |QBF aNombreHoja;
     aNombreHoja = aNombreHoja + ".xls";

     |ALFACALLDLL "agixl97.dll", "carga_book", aHoja;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja";

     nCampo    = 1;
     |PARA; |SI; |HACIENDO;
          aCampo = "A" + nCampo;  |HAZ LeeCasilla;  aCampoA = aCampo;
          |SI aCampoA = "";  |SAL;  |FINSI;

          aCampo = "B" + nCampo;  |HAZ LeeCasilla;  aCampoB = aCampo;
          aCampo = "C" + nCampo;  |HAZ LeeCasilla;  aCampoC = aCampo;
          aCampo = "D" + nCampo;  |HAZ LeeCasilla;  aCampoD = aCampo;
          aCampo = "F" + nCampo;  |HAZ LeeCasilla;  aCampoF = aCampo;
          aCampo = "H" + nCampo;  |HAZ LeeCasilla;  aCampoH = aCampo;
          aCampo = "I" + nCampo;  |HAZ LeeCasilla;  aCampoI = aCampo;
          aCampo = "K" + nCampo;  |HAZ LeeCasilla;  aCampoK = aCampo;
          aCampo = "L" + nCampo;  |HAZ LeeCasilla;  aCampoL = aCampo;
          aCampo = "M" + nCampo;  |HAZ LeeCasilla;  aCampoM = aCampo;
          aCampo = "N" + nCampo;  |HAZ LeeCasilla;  aCampoN = aCampo;
          aCampo = "O" + nCampo;  |HAZ LeeCasilla;  aCampoO = aCampo;

          aTipo = "S";  |HAZ GrabaIva1;

          nCampo = nCampo + 1;
     |SIGUE;

     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
|FPRC;

|PROCESO IvaSop2;
     aAlfa = #0#12;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     aHoja       = #0#4 + #0#12;            |QBT aHoja;
     aHoja       = aHoja + ".xls";
     aNombreHoja = #0#12;                   |QBF aNombreHoja;
     aNombreHoja = aNombreHoja + ".xls";

     |ALFACALLDLL "agixl97.dll", "carga_book", aHoja;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja";

     nCampo    = 1;
     |PARA; |SI; |HACIENDO;
          aCampo = "A" + nCampo;  |HAZ LeeCasilla;  aCampoA = aCampo;
          |SI aCampoA = "";  |SAL;  |FINSI;

          aCampo = "B" + nCampo;  |HAZ LeeCasilla;  aCampoB = aCampo;
          aCampo = "C" + nCampo;  |HAZ LeeCasilla;  aCampoC = aCampo;
          aCampo = "E" + nCampo;  |HAZ LeeCasilla;  aCampoE = aCampo;
          aCampo = "F" + nCampo;  |HAZ LeeCasilla;  aCampoF = aCampo;

          aTipo = "S";  |HAZ GrabaIva2;

          nCampo = nCampo + 1;
     |SIGUE;

     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
|FPRC;

|PROCESO IvaSop3;
     aAlfa = #0#13;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     aHoja       = #0#4 + #0#13;            |QBT aHoja;
     aHoja       = aHoja + ".xls";
     aNombreHoja = #0#13;                   |QBF aNombreHoja;
     aNombreHoja = aNombreHoja + ".xls";

     |ALFACALLDLL "agixl97.dll", "carga_book", aHoja;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja";

     nCampo    = 1;
     |PARA; |SI; |HACIENDO;
          aCampo = "A" + nCampo;  |HAZ LeeCasilla;  aCampoA = aCampo;
          |SI aCampoA = "";  |SAL;  |FINSI;

          aCampo = "B" + nCampo;  |HAZ LeeCasilla;  aCampoB = aCampo;
          aCampo = "C" + nCampo;  |HAZ LeeCasilla;  aCampoC = aCampo;
          aCampo = "E" + nCampo;  |HAZ LeeCasilla;  aCampoE = aCampo;
          aCampo = "F" + nCampo;  |HAZ LeeCasilla;  aCampoF = aCampo;
          aCampo = "G" + nCampo;  |HAZ LeeCasilla;  aCampoG = aCampo;
          aCampo = "H" + nCampo;  |HAZ LeeCasilla;  aCampoH = aCampo;
          aCampo = "L" + nCampo;  |HAZ LeeCasilla;  aCampoL = aCampo;

          aTipo = "S";  |HAZ GrabaIva3;

          nCampo = nCampo + 1;
     |SIGUE;

     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
|FPRC;

|PROCESO BaseSoportado;
     nBase   = nBase + 1;

     #803#3  = nLinea;
     #803#10 = "S";
     #803#11 = 2;
     #803#26 = "B";
     #803#27 = nBase;

     |SI nBase = 1;  nCampo1 = 14;  nCampo2 = 15;  nCampo3 = 12;  |FINSI;
     |SI nBase = 2;  nCampo1 = 21;  nCampo2 = 22;  nCampo3 = 19;  |FINSI;
     |SI nBase = 3;  nCampo1 = 28;  nCampo2 = 29;  nCampo3 = 26;  |FINSI;
     |SI nBase = 4;  nCampo1 = 35;  nCampo2 = 36;  nCampo3 = 33;  |FINSI;
     |SI nBase = 5;  nCampo1 = 42;  nCampo2 = 43;  nCampo3 = 40;  |FINSI;

     aAlfa = #904nCampo3;  |QBF aAlfa;
     |SI aAlfa = "";
         aAlfa = #904#12;
     |FINSI;

     |SALVA_DATOS #801;
     #801#0  = aAlfa;
     |LEE 040#801=;
     |SI FSalida ! 0;
         aAlfa1 = aAlfa % 104;
         #801#0 = aAlfa1;
         |LEE 040#801=;
         |SI FSalida ! 0;  |DDEFECTO #801; |FINSI;

         aCta  = aAlfa;
         aDes1 = #801#2;
         aDes2 = "";
         |HAZ GrabaCuenta;
     |FINSI;

     aCta  = #801#0;

     #803#8  = "D";
     #803#9  = #904nCampo1;
     #803#4   = #801#0;
     #803#5   = #801#1;

     |REPON_DATOS #801;

     |SI #904nCampo1 = 0;  |Y #904nCampo2 = 0;
          nCampo1 = 14;
          nCampo2 = 15;
     |FINSI;

     |SI #904nCampo2 = 1;  #803#28 = 16;  |FINSI;
     |SI #904nCampo2 = 2;  #803#28 = 7;   |FINSI;
     |SI #904nCampo2 = 3;  #803#28 = 4;   |FINSI;
     |SI #904nCampo2 = 4;  #803#28 = 0;   |FINSI;
|FPRC;

|PROCESO OtraBaseSoportado;
     |SALVA_DATOS #803;

     |DDEFECTO #803;
     #803#0   = 01;
     aAlfa    = (aCampoC % 102) + "." + (aCampoC % 402) + "." + (aCampoC % -104);
     #803#1   = aAlfa;
     #803#2   = aCampoA;
     #803#37  = #0#0;
     #803#38  = #0#2;
     #803#6   = 999;
     #803#13  = 0;
     #803#29  = "";
     #803#7   = aCampoF;
     #803#8   = "D";
     #803#9   = #904#21;
     #803#15 = "01";

     |HAZ BaseSoportado;

     |GRABA 020#803n;
     |LIBERA #803;

     nLinea   = nLinea + 1;

     |REPON_DATOS #803;
|FPRC;

|PROCESO IvaSoportado;
     |SI nAsiento ! #904#7;
         nBase  = 0;
         nLinea = 1;
     |FINSI;

     nAsiento = #904#7;
     nLinea   = nLinea + 1;

     |SI #803#4 = #904#4;
         nLinea  = 1;
         #803#3  = nLinea;
         #803#10 = "S";
         #803#11 = 2;
         #803#26 = "F";
         #803#27 = 0;
     |FINSI;

     |SI aAlfa1 = "472";
         |SI nBase = 1;
             |SI #904#21 ! 0;  |HAZ OtraBaseSoportado;  |FINSI;
             |SI #904#28 ! 0;  |HAZ OtraBaseSoportado;  |FINSI;
             |SI #904#35 ! 0;  |HAZ OtraBaseSoportado;  |FINSI;
             |SI #904#42 ! 0;  |HAZ OtraBaseSoportado;  |FINSI;
         |FINSI;

         #803#3  = nLinea;
         #803#10 = "S";
         #803#11 = 2;
         #803#26 = "I";
         #803#27 = 0;
     |FINSI;

     |SI #803#4 = #904#11;
         #803#3  = nLinea;
         #803#10 = "S";
         #803#11 = 2;
         #803#26 = "P";
         #803#27 = 10;
         #803#42 = #904#14;
     |FINSI;

     |SI #803#4 = #904#9;
         #803#3  = nLinea;
         #803#10 = "S";
         #803#11 = 2;
         #803#26 = "D";
         #803#27 = 1;
     |FINSI;

     |SI #803#4 = #904#12;  |O #803#4 = #904#19; |O #803#4 = #904#26;
      |O #803#4 = #904#33;  |O #803#4 = #904#40; |O #803#10 = " ";
         |HAZ BaseSoportado;
     |FINSI;
|FPRC;

|PROCESO BaseRepercutido;
     nBase   = nBase + 1;

     #803#3  = nLinea;
     #803#10 = "R";
     #803#11 = 1;
     #803#26 = "B";
     #803#27 = nBase;

     |SI nBase = 1;  nCampo1 = 14;  nCampo2 = 15;  nCampo3 = 12;  |FINSI;
     |SI nBase = 2;  nCampo1 = 21;  nCampo2 = 22;  nCampo3 = 19;  |FINSI;
     |SI nBase = 3;  nCampo1 = 28;  nCampo2 = 29;  nCampo3 = 26;  |FINSI;
     |SI nBase = 4;  nCampo1 = 35;  nCampo2 = 36;  nCampo3 = 33;  |FINSI;
     |SI nBase = 5;  nCampo1 = 42;  nCampo2 = 43;  nCampo3 = 40;  |FINSI;

     aAlfa = #904nCampo3;  |QBF aAlfa;
     |SI aAlfa = "";
         aAlfa = #904#12;
     |FINSI;

     |SALVA_DATOS #801;
     #801#0  = aAlfa;
     |LEE 040#801=;
     |SI FSalida ! 0;
         aAlfa1 = aAlfa % 104;
         #801#0 = aAlfa1;
         |LEE 040#801=;
         |SI FSalida ! 0;  |DDEFECTO #801; |FINSI;

         aCta  = aAlfa;
         aDes1 = #801#2;
         aDes2 = "";
         |HAZ GrabaCuenta;
     |FINSI;

     aCta  = #801#0;

     #803#8  = "H";
     #803#9  = #904nCampo1;
     #803#4  = #801#0;
     #803#5  = #801#1;

     |REPON_DATOS #801;

     |SI #904nCampo1 = 0;  |Y #904nCampo2 = 0;
          nCampo1 = 14;
          nCampo2 = 15;
     |FINSI;

     |SI #904nCampo2 = 1;  #803#28 = 16;  |FINSI;
     |SI #904nCampo2 = 2;  #803#28 = 7;   |FINSI;
     |SI #904nCampo2 = 3;  #803#28 = 4;   |FINSI;
     |SI #904nCampo2 = 4;  #803#28 = 0;   |FINSI;
|FPRC;

|PROCESO OtraBaseRepercutido;
     |SALVA_DATOS #803;

     |DDEFECTO #803;
     #803#0   = 01;
     aAlfa    = (aCampoC % 102) + "." + (aCampoC % 402) + "." + (aCampoC % -104);
     #803#1   = aAlfa;
     #803#2   = aCampoA;
     #803#37  = #0#0;
     #803#38  = #0#2;
     #803#6   = 999;
     #803#13  = 0;
     #803#29  = "";
     #803#7   = aCampoF;
     #803#8   = "H";
     #803#9   = #904#21;
     #803#15 = "01";

     |HAZ BaseRepercutido;

     |GRABA 020#803n;
     |LIBERA #803;

     nLinea   = nLinea + 1;

     |REPON_DATOS #803;
|FPRC;

|PROCESO IvaRepercutido;
     |SI nAsiento ! #904#7;
         nBase  = 0;
         nLinea = 1;
     |FINSI;

     nAsiento = #904#7;
     nLinea   = nLinea + 1;

     |SI #803#4 = #904#4;
         nLinea  = 1;
         #803#3  = nLinea;
         #803#10 = "R";
         #803#11 = 1;
         #803#26 = "F";
         #803#27 = 0;
     |FINSI;

     |SI aAlfa1 = "477";
         |SI nBase = 1;
             |SI #904#21 ! 0;  |HAZ OtraBaseRepercutido;  |FINSI;
             |SI #904#28 ! 0;  |HAZ OtraBaseRepercutido;  |FINSI;
             |SI #904#35 ! 0;  |HAZ OtraBaseRepercutido;  |FINSI;
             |SI #904#42 ! 0;  |HAZ OtraBaseRepercutido;  |FINSI;
         |FINSI;

         #803#3  = nLinea;
         #803#10 = "R";
         #803#11 = 1;
         #803#26 = "I";
         #803#27 = 0;
     |FINSI;

     |SI #803#4 = #904#11;
         #803#3  = nLinea;
         #803#10 = "R";
         #803#11 = 1;
         #803#26 = "P";
         #803#27 = 10;
         #803#42 = #904#14;
     |FINSI;

     |SI #803#4 = #904#9;
         #803#3  = nLinea;
         #803#10 = "R";
         #803#11 = 1;
         #803#26 = "D";
         #803#27 = 1;
     |FINSI;

     |SI #803#4 = #904#12;  |O #803#4 = #904#19; |O #803#4 = #904#26;
      |O #803#4 = #904#33;  |O #803#4 = #904#40; |O #803#10 = " ";
         |HAZ BaseRepercutido;
     |FINSI;
|FPRC;

|PROCESO GrabaAsiento;
     #801#0  = aCampoD;
     |LEE 040#801=;
     |SI FSalida ! 0;
         aAlfa1 = aCampoD % 104;
         #801#0 = aAlfa1;
         |LEE 040#801=;
         |SI FSalida ! 0;  |DDEFECTO #801; |FINSI;

         aCta  = aCampoD;
         aDes1 = #801#2;
         aDes2 = "";
         |HAZ GrabaCuenta;
     |FINSI;

     |DDEFECTO #803;
     #803#0  = 01;
     aAlfa   = (aCampoC % 102) + "." + (aCampoC % 402) + "." + (aCampoC % -104);
     #803#1  = aAlfa;
     #803#2  = aCampoA;
     #803#3  = aCampoB;
     #803#37 = #0#0;
     #803#38 = #0#2;
     #803#4  = #801#0;
     #803#5  = #801#1;
     #803#6  = 999;
     #803#13 = 0;
     #803#29 = "";
     #803#7  = aCampoF;

     nDebe   = aCampoR;
     nHaber  = aCampoS;
     |SI nDebe ! 0;
         aImporte = aCampoR;
         |HAZ QuitaPuntos;
         #803#8   = "D";
         #803#9   = aAlfa;
     |SINO;
         aImporte = aCampoS;
         |HAZ QuitaPuntos;
         #803#8 = "H";
         #803#9   = aAlfa;
     |FINSI;

     #803#15 = "01";

     aAlfa1  = aCampoD % 103;
     aAlfa2  = aCampoD % 101;
     nHayIva = -1;
     aTipo   = "";

     |SI aCampoE = "1";  aTipo = "R";  |FINSI;
     |SI aCampoE = "2";  aTipo = "S";  |FINSI;

     |SI aTipo ! "";
         #904#0 = aTipo;
         #904#7 = aCampoA;
         |LEE 040#904=;
         nHayIva = FSalida;
     |FINSI;

     |SI nHayIva = 0;
         #803#12 = #904#1;
         #803#13 = #904#2;
         #803#29 = #904#3;
         #803#10 = " ";

         |SI #904#0 = "S";
             |HAZ IvaSoportado;
         |SINO;
             |HAZ IvaRepercutido;
         |FINSI;
     |FINSI;

     |GRABA 020#803n;
     |LIBERA #803;
|FPRC;

|PROCESO Asientos;
     aAlfa = #0#7;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     aHoja       = #0#4 + #0#7;            |QBT aHoja;
     aHoja       = aHoja + ".xls";
     aNombreHoja = #0#7;                   |QBF aNombreHoja;
     aNombreHoja = aNombreHoja + ".xls";

     |ALFACALLDLL "agixl97.dll", "carga_book", aHoja;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja";

     nCampo    = 1;
     |PARA; |SI; |HACIENDO;
          aCampo = "A" + nCampo;  |HAZ LeeCasilla;  aCampoA = aCampo;
          |SI aCampoA = "";  |SAL;  |FINSI;

          aCampo = "B" + nCampo;  |HAZ LeeCasilla;  aCampoB = aCampo;
          aCampo = "C" + nCampo;  |HAZ LeeCasilla;  aCampoC = aCampo;
          aCampo = "D" + nCampo;  |HAZ LeeCasilla;  aCampoD = aCampo;
          aCampo = "E" + nCampo;  |HAZ LeeCasilla;  aCampoE = aCampo;
          aCampo = "F" + nCampo;  |HAZ LeeCasilla;  aCampoF = aCampo;
          aCampo = "G" + nCampo;  |HAZ LeeCasilla;  aCampoG = aCampo;
          aCampo = "H" + nCampo;  |HAZ LeeCasilla;  aCampoH = aCampo;
          aCampo = "R" + nCampo;  |HAZ LeeCasilla;  aCampoR = aCampo;
          aCampo = "S" + nCampo;  |HAZ LeeCasilla;  aCampoS = aCampo;

          |HAZ GrabaAsiento;

          nCampo = nCampo + 1;
     |SIGUE;

     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
|FPRC;

|PROCESO Tipo3;  |TIPO 3;
     |CARGADLL "agixl97.dll";
     |SI FSalida < 0;
         |MENAV "0000No se puede usar agixl97.dll";
         |ACABA;
     |FINSI;

     |HAZ PlanContable;

     |ABRE #801;
     |ABRE #802;
     |ABRE #803;
     |HAZ AsientoApertura;

     aFichero = ("4" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #904 aFichero;

     |ABRE #904;  |CIERRA #904;  |DELINDEX #904;

     |ABRE #904;
     |HAZ IvaRep1;
     |HAZ IvaRep2;
     |HAZ IvaRep3;
     |HAZ IvaSop1;
     |HAZ IvaSop2;
     |HAZ IvaSop3;

     |SELECT #2#904;
     |HAZ Asientos;

     |CIERRA #801;
     |CIERRA #802;
     |CIERRA #803;
     |CIERRA #904;

     |DELINDEX #904;

     #0#14 = "Enlazando con contabilidad.";  |PINTA #0#14;

     enNoModif = 100;
     |DBASS aBase;  |QBF aBase;
     aAlfa = ":contagen/dsapunte;" + aBase + "contagen/fich/" + (("00000" + #0#0) % -105) + #0#2 + "/";
     |SUB_EJECUTA_NP aAlfa;

     |DELINDEX #803;

     |DESCARGADLL "agixl97.dll";
|FPRC;
