     || Recalculo

|FICHEROS;
     &gopre001@ #1;
     &gopre002@ #2;
     &gopre003@ #3;
     &gopre004@ #4;
     &goparame@ #9;
|FIN;

|VARIABLES;
     nTotal = 0;
     nTotalE = 0;
     nBajaE = 0;
     nBaja = 0;
     nDtoE = 0;
     nDto = 0;
     nGasE = 0;
     nGas = 0;
     nBenE = 0;
     nBen = 0;
|FIN;

|PROCESO gopre004;
     |SI #1#42 = "+";
          #4#11 = (#4#8 * #4#9) > #4#13;                 ||Importe Venta.
     |SINO;
          #4#11 = (#4#9 * #4#8) / (1 - (#4#13 / 100));
     |FINSI;

     #4#12 = #4#8 * #4#10;

     #3#8  = #3#8  + #4#11;
     #3#9  = #3#9  + #4#12;
     #3#10 = (#3#8 * #3#7);
     #3#11 = (#3#9 * #3#7);
     |SI #1#42 = "+";
          #3#12 = (((#3#8-#3#9)/#3#9)*100);
     |SINO;
          #3#12 = (1 - (#3#9/#3#8))*100;
     |FINSI;

     #1#22 = #3#8;
     #1#23 = #3#9;

     |SI #9#5 = #4#14;
          #3#16 = #3#16 + #4#8;             ||Unidades Mano de Obra.
     |FINSI;

     |GRABA 020#4a;
     |LIBERA #4;
|FPRC;

|DEFBUCLE gopre004;
     #4#1005;
     ;
     #1#0, #1#1, #2#12, #3#4,      1;
     #1#0, #1#1, #2#12, #3#4, 999999;
     be;
     NULL, gopre004;
|FIN;

|PROCESO gopre003;
     #3#8 = 0;
     #3#9 = 0;
     #3#16 = 0;

     |BUCLE gopre004;
     #1#22 = #3#8;
     #1#23 = #3#9;


     |GRABA 020#3a;
     |LIBERA #3;

     #2#7  = #2#7 + #3#10;                       ||Precio Venta Cap.
     #2#8  = #2#8 + #3#11;                       ||Precio Coste Cap.
     #2#9  = #2#6 * #2#7;                         ||Importe Venta Cap.
     #2#10 = #2#6 * #2#8;                         ||Importe Coste Cap.
     |SI #1#42 = "+";
          #2#11 = ((#2#7-#2#8)/#2#8)*100;         ||Incremento en Capitulo.
     |SINO;
          #2#11 = (1 - (#2#8/#2#7))*100;
     |FINSI;
|FPRC;

|DEFBUCLE gopre003;
     #3#1004;
     ;
     #1#0, #1#1, #2#12,      1;
     #1#0, #1#1, #2#12, 999999;
     be;
     NULL, gopre003;
|FIN;

|PROCESO Calgopre002;
     #2#7 = 0;
     #2#8 = 0;
     |BUCLE gopre003;

     |GRABA 020#2a;
     |LIBERA #2;
/* Nuevo (cambiado al poner EXT en el gopre002*/
     |SI #2#15 = "S";
          #1#50 = #1#50 + #2#9;
     |SINO;
          #1#51 = #1#51 + #2#9;
     |FINSI;
     #1#5 = #1#50 + #1#51;
/* Antes
     #1#5 = #1#5 + #2#9;                         ||Total Venta.
*/
     #1#6 = #1#6 + #2#10;                        ||Total Coste.

/* Antes
     #1#21 = #1#5 - (#1#6+#1#28);                 ||Margen.
     #1#44 = (#1#5 % #1#43);
     nTotal = #1#5 - #1#44;
     #1#31 = (nTotal % #1#26);
     #1#32 = (nTotal % #1#27);
     nTotal = nTotal + #1#31 + #1#32;
     #1#33 = (nTotal % #1#28);
     nTotal = nTotal - #1#33;
     #1#34 = (nTotal % #1#29);
     #1#35 = nTotal + #1#34;
*/
/* Nuevo */
     #1#21 = #1#5 - #1#6 + #1#28;                 ||Margen.
     nDto  = (#1#51 % #1#43);
     nDtoE = (#1#50 % #1#43);
     #1#44 = nDto + nDtoE;
     nTotal = (#1#51 - nDto);
     nTotalE = (#1#50 - nDtoE);
     nGas  = (nTotal % #1#26);
     nBen  = (nTotal % #1#27);
     nGasE = (nTotalE % #1#26);
     nBenE = (nTotalE % #1#27);
     #1#31 = nGas + nGasE;
     #1#32 = nBen + nBenE;
     nTotal = nTotal + nGas + nBen;
     nTotalE = nTotalE + nGasE + nBenE;
     nBaja = (nTotal % #1#28);
     nBajaE = (nTotalE % #1#28);
     #1#33 = nBaja + nBajaE;
     nTotal = nTotal - nBaja;
     nTotalE = nTotalE - nBajaE;
     #1#34 = (nTotal % #1#29);
     #1#35 = nTotal + #1#34 + nTotalE;

     #1#54 = #1#5-#1#33+#1#31+#1#32-#1#44-#1#6;|| Margen Total
     #1#53 = #1#54 * 100 / #1#6;
|FPRC;
