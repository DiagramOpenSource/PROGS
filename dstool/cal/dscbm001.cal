|FICHEROS;
     dscbm001 #0;   ||Copia Basicos (Principal)

     dscbm002 #2,MANTE;   ||Copia Basicos (Conta)
     dscbm003 #3,MANTE;   ||Copia Basicos (Facges)

     canempr@ #10;  ||Empresas de agicont
     facempr@ #20;  ||Empresas de facgesz

     control@ #100; ||Para la carga del agicontr
|FIN;

|VARIABLES;
     nExiste = 0;
     aMensaje = "";
     aPath = "";
     aDirBase = "";
     aDirDest = "";
     aSistema = "";
     nSwUnix = 0;
     aLong = "";
     nLong = 0;
     nCont = 0;
     nPos = 0;
     aAlfa = "";
     nNumCar = 0;

     aDefConta = "";
     aPathConta = "";
     aDefFac = "";
     aPathFac = "";

     aDirectorio = "";
     aPathOri = "";
     aPathDes = "";
     aNom = "";

     aEmpresa = "";
     aPeriodo = "";
     direc = "";
     aCopyDos = "";
     aCopyDosDir = "";
     aCopyUnix = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";

     aDirControl = "";
     aDefCtrl = "";
     aPathCtrl = "";
     nCampo = 0;
     aDirBaseBo = "";
     aUnidad = "";
|FIN;

|PROCESO minConta;
     #2#0 = 00001;
     #2#3 = 0;
|FPRC;

|PROCESO maxConta;
     #2#0 = 99999;
     #2#3 = 9;
|FPRC;

|PROCESO minFactu;
     #3#0 = 00;
|FPRC;

|PROCESO maxFactu;
     #3#0 = 99;
|FPRC;

|PROGRAMA;
     aCopyDos = "dscp.bat";
     aCopyDosDir = "dscpdir.bat";
     aCopyUnix = "dscp";
     |DIRECTORIO direc;
     |QBF direc;
     |CLS;
     |ABRE #0;
     |DDEFECTO #0;
     |LEE 101#0p;
     nExiste = FSalida;
     |PINPA #0#0;
     |PINDA #0#0;
     |HAZ Inicializacion;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |HAZ Copiado;
     |FINSI;
     |LIBERA #0;
     |CIERRA #0;
|FPRO;

|PROCESO Inicializacion;
     |DBASS aPath;
     |QBF aPath;
     aDirBase = aPath;
     |HAZ Sistema;

     |HAZ SacaDirDest;
     aMensaje = "0000Origen: " + aDirBase + &13 + "Destino: " + aDirDest;
     ||MENAV aMensaje;
     |HAZ LlenaConta;
     |HAZ LlenaFacges;
|FPRC;

|PROCESO SacaDirDest;
     |SI nSwUnix = 1;    ||Unix
          aLong = aDirBase % A0;
          nLong = aLong;
          |PARA nCont = 2; |SI nCont [ nLong; |HACIENDO nCont = nCont + 1;
               nPos = -((nCont * 100) + 1);
               aAlfa = aDirBase % nPos;
               |SI aAlfa = "/";
                    nNumCar = nLong - nCont;
                    nNumCar = 100 + nNumCar;
                    aDirDest = aDirBase % nNumCar;
                    aDirDest = aDirDest + "/dseuro/";
                    |SAL;
               |FINSI;
          |SIGUE;
     |SINO;
          aUnidad = aDirBase % 102;
          |QBF aUnidad;
          aDirDest = aUnidad + "\dseuro\";
     |FINSI;
|FPRC;

|PROCESO Sistema;
     |QUE_SISTEMA aSistema;
     |SI aSistema = "ESDOS";
          nSwUnix = 0;     ||DOS.
     |SINO;
          nSwUnix = 1;     ||Unix
     |FINSI;
|FPRC;

|PROCESO canempre;
     ||Si no existe meter esta empresa.
     |DDEFECTO #dscbm002;
     #dscbm002#0 = #canempr@#2;    ||Emp
     #dscbm002#3 = #canempr@#3;    ||Eje
     |LEE 101#dscbm002.=;
     |SI FSalida ! 0; |GRABA 020#dscbm002.b; |FINSI;
     #dscbm002#1 = #canempr@#1;
     |GRABA 020#dscbm002.a;
     |LIBERA #dscbm002;
|FPRC;

|DEFBUCLE canempre;
 #canempr@#1002;
 ;
 00001, 0;
 99999, 9;
 ;
 NULL, canempre;
|FIN;

|PROCESO LlenaConta;
     aDefConta = aDirBase + "agicont/def/canempre";
     aPathConta = aDirBase + "agicont/fich/";
     |CARGA_DEF aDefConta, canempr@;
     |SI FSalida ! 0;
          aMensaje = "0000Error en CARGA_DEF: " + aDefConta;
          ||MENAV aMensaje;
          |ACABA;
     |FINSI;
     |PATH_DAT #10 aPathConta;
     |ABRE #dscbm002;
     |BUCLE canempre;
     |CIERRA #dscbm002;
|FPRC;

|PROCESO facempre;
     |DDEFECTO #dscbm003;
     #dscbm003#0 = #facempr@#0;    ||Emp
     |LEE 101#dscbm003.=;
     |SI FSalida ! 0; |GRABA 020#dscbm003.b; |FINSI;
     #dscbm003#1 = #facempr@#1;
     |GRABA 020#dscbm003.a;
     |LIBERA #dscbm003;
|FPRC;

|DEFBUCLE facempre;
 #facempr@#1001;
 ;
 00;
 99;
 ;
 NULL, facempre;
|FIN;

|PROCESO LlenaFacges;
     aDefFac = aDirBase + "facges/def/facemp";
     aPathFac = aDirBase + "facges/fich/";
     |CARGA_DEF aDefFac, facempr@;
     |SI FSalida ! 0;
          aMensaje = "0000Error en CARGA_DEF: " + aDefFac;
          ||MENAV aMensaje;
          |ACABA;
     |FINSI;
     |PATH_DAT #20 aPathFac;
     |ABRE #dscbm003;
     |BUCLE facempre;
     |CIERRA #dscbm003;
|FPRC;

|PROCESO Agicont; |TIPO 0;
     |SI #dscbm001#1 = "S";
          |HAZ SeleConta;
     |FINSI;
|FPRC;

|PROCESO SeleConta;
     |PUSHV 1132 2377;
     |PINPA #0#2;
     |PINDA #0#2;
     |ABRE #dscbm002;
     |ENTLINEAL #1#2, -1, 4, 22, 1, minConta, maxConta;
     |SI FSalida=0;

     |FINSI;
     |CIERRA #dscbm002;
     |POPV;
|FPRC;

|PROCESO Return; |TIPO 0;
     |SI FSalida = 0;
          |SI #dscbm002#2 = "S";
               #dscbm002#2 = "N";
               |PINTA #dscbm002#2;
               |GRABA 020#dscbm002.a;
          |SINO;
               |SI #dscbm002#2 = "N";
                    #dscbm002#2 = "S";
                    |PINTA #dscbm002#2;
                    |GRABA 020#dscbm002.a;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Marca; |TIPO 0;
     |SI FSalida = 0;
          |SI #dscbm003#2 = "S";
               #dscbm003#2 = "N";
               |PINTA #dscbm003#2;
               |GRABA 020#dscbm003.a;
          |SINO;
               |SI #dscbm003#2 = "N";
                    #dscbm003#2 = "S"
                    |PINTA #dscbm003#2;
                    |GRABA 020#dscbm003.a;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Copiado;
     |SI #dscbm001#1 = "S"; |O #dscbm001#2 = "S"; |O #dscbm001#3 = "S"; |O #dscbm001#4 = "S"; |O #dscbm001#5 = "S"; |O #dscbm001#6 = "S";
          |HAZ Directorios;
          |HAZ CopiaComun;
     |FINSI;

     |SI #dscbm001#1 = "S";
          |HAZ CopConta;
     |FINSI;
     |SI #dscbm001#2 = "S";
          |HAZ CopFactura;
     |FINSI;
     |SI #dscbm001#3 = "S";
          |HAZ CopNominas;
     |FINSI;
     |SI #dscbm001#4 = "S";
          |HAZ CopSociedad;
     |FINSI;
     |SI #dscbm001#5 = "S";
          |HAZ CopAgieos;
     |FINSI;
     |SI #dscbm001#6 = "S";
          |HAZ CopAgicli;
          |HAZ AgiControl;
     |FINSI;
|FPRC;


|PROCESO Facges; |TIPO 0;
     |SI #dscbm001#2 = "S";
          |HAZ SeleFactura;
     |FINSI;
|FPRC;

|PROCESO SeleFactura;
     |PUSHV 1132 2377;
     |PINPA #0#2;
     |PINDA #0#2;
     |ABRE #dscbm003;
     |ENTLINEAL #1#3, -1, 4, 22, 1, minFactu, maxFactu;
     |SI FSalida=0;
     |FINSI;
     |CIERRA #dscbm003;
     |POPV;
|FPRC;

|PROCESO CopConta;
     aPathOri = aDirBase;
     aPathOri = aPathOri + "agicont/";

     aPathDes = aDirDest;
     aPathDes = aPathDes + "agicont/";
     aDirectorio = aPathDes;
     |HAZ CreaDir;

     aNom = "agicont.men";
     |HAZ Copif;

     aNom = "ayuda";
     |HAZ Copid;
     aNom = "bin";
     |HAZ Copid;
     aNom = "def";
     |HAZ Copid;

     aNom = "dsmodulo.men";
     |HAZ Copif;

     aNom = "hacienda";
     |HAZ Copid;
     aNom = "pan";
     |HAZ Copid;
     aNom = "vent";
     |HAZ Copid;

     aDirectorio = aPathDes + "fich/";
     |HAZ CreaDir;

     |HAZ LinAgiCont;
|FPRC;

|PROCESO CopFactura;
     aPathOri = aDirBase;
     aPathOri = aPathOri + "facges/";

     aPathDes = aDirDest;
     aPathDes = aPathDes + "facges/";
     aDirectorio = aPathDes;
     |HAZ CreaDir;

     aNom = "facges.men";
     |HAZ Copif;

     aNom = "ayuda";
     |HAZ Copid;
     aNom = "bin";
     |HAZ Copid;
     aNom = "def";
     |HAZ Copid;
     aNom = "pan";
     |HAZ Copid;
     aNom = "vent";
     |HAZ Copid;

     aDirectorio = aPathDes + "fich/";
     |HAZ CreaDir;

     |HAZ LinFacGes;
|FPRC;

|PROCESO CopNominas;
     aPathOri = aDirBase;
     aPathDes = aDirDest;

     aNom = "aginom";
     |HAZ Copid;
|FPRC;

|PROCESO CopSociedad;
     aPathOri = aDirBase;
     aPathDes = aDirDest;

     aNom = "sociedad";
     |HAZ Copid;
|FPRC;

|PROCESO CopAgieos;
     aPathOri = aDirBase;
     aPathDes = aDirDest;

     aNom = "agieos";
     |HAZ Copid;
|FPRC;

|PROCESO CopAgicli;
     aPathOri = aDirBase;
     aPathDes = aDirDest;

     aNom = "agicli";
     |HAZ Copid;
|FPRC;

|PROCESO CopiaComun;
     aPathOri = aDirBase;
     aPathDes = aDirDest;

     aNom = "agicontr.dat";
     |HAZ Copif;
     aNom = "agicontr.ddx";
     |HAZ Copif;
     aNom = "agicontr.ixx";
     |HAZ Copif;

     aNom = "agitool";
     |HAZ Copid;
     aNom = "bin";
     |HAZ Copid;
     aNom = "cfg";
     |HAZ Copid;
     aNom = "dev";
     |HAZ Copid;

     aNom = "ds.ini";
     |HAZ Copif;
     aNom = "ds.men";
     |HAZ Copif;
     aNom = "informa.pan";
     |HAZ Copif;
     aNom = "inicio.pan";
     |HAZ Copif;
     aNom = "informa.bmp";
     |HAZ Copif;
     aNom = "inicio.bmp";
     |HAZ Copif;
     aNom = "logo.bmp";
     |HAZ Copif;

     aNom = "master";
     |HAZ Copid;
     aNom = "tmp";
     |HAZ Copid;
     aNom = "ut";
     |HAZ Copid;
|FPRC;

|PROCESO Directorios;
     aDirectorio = aDirDest;
     |HAZ CreaDir;

     aDirectorio = aDirDest + "spool/";
     |HAZ CreaDir;

     aDirectorio = aDirDest + "logs/";
     |HAZ CreaDir;
|FPRC;

|PROCESO CreaDir;   ||Crea el directorio especificado en aDirectorio
     |MKDIR aDirectorio;
|FPRC;

|PROCESO Copif; ||Proceso que copia ficheros
     ||Utiliza aPathOri, aPathDes y aNom.
     aAlfa2 = aPathOri + aNom;
     |SI nSwUnix = 1;
          aAlfa3 = aPathDes;
          aAlfa1 = direc + "agitool/" + aCopyUnix + " -p " + aAlfa2 + " " + aAlfa3;
     |SINO;
          aAlfa3 = aPathDes + aNom;
          |COPIA_FICHERO aAlfa2, aAlfa3;
          ||No funciona en windows98.  (w95?). Si va en W2K
          ||aAlfa1 = direc + "agitool\" + aCopyDos + " " + aAlfa2 + " " + aAlfa3;
     |FINSI;
     |SYSTEM aAlfa1;
|FPRC;

|PROCESO Copid; ||Proceso que copia directorios.
     ||Utiliza aPathOri, aPathDes y aNom.
     aAlfa2 = aPathOri + aNom;
     |SI nSwUnix = 1;
          aAlfa3 = aPathDes;
          aAlfa1 = direc + "agitool/" + aCopyUnix + " -r " + aAlfa2 + " " + aAlfa3;
     |SINO;
          aAlfa3 = aPathDes + aNom;
          aDirectorio = aAlfa3;
          |HAZ CreaDir;
          aAlfa1 = direc + "agitool\" + aCopyDosDir + " " + aAlfa2 + " " + aAlfa3;
     |FINSI;
     |SYSTEM aAlfa1;
|FPRC;

|PROCESO dscbm002;
     |SI #dscbm002#2 = "S";
          aEmpresa = ("00000" + #dscbm002#0) % -105;
          aPeriodo = ("0" + #dscbm002#3) % -101;
          aEmpresa = aEmpresa + aPeriodo;
          |QBF aEmpresa;
          aNom = aEmpresa;
          |HAZ Copid;
     |FINSI;
|FPRC;

|DEFBUCLE dscbm002;
 #dscbm002#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, dscbm002;
|FIN;

|PROCESO LinAgiCont;
     aPathOri = aPathOri + "fich/";
     aPathDes = aPathDes + "fich/";

     aNom = "agicont.dir";
     |HAZ Copif;
     aNom = "agrupaci.abr";
     |HAZ Copif;
     aNom = "agrupaci.amp";
     |HAZ Copif;
     aNom = "canempre.dat";
     |HAZ Copif;
     aNom = "canempre.ddx";
     |HAZ Copif;
     aNom = "canempre.ixx";
     |HAZ Copif;
     aNom = "cuebalan.abr";
     |HAZ Copif;
     aNom = "cuebalan.amp";
     |HAZ Copif;
     aNom = "epigrafe.abr";
     |HAZ Copif;
     aNom = "epigrafe.amp";
     |HAZ Copif;
     aNom = "parbalan.abr";
     |HAZ Copif;
     aNom = "parbalan.amp";
     |HAZ Copif;
     aNom = "parexplo.abr";
     |HAZ Copif;
     aNom = "parexplo.amp";
     |HAZ Copif;
     aNom = "plancont.dat";
     |HAZ Copif;
     aNom = "plancont.ddx";
     |HAZ Copif;
     aNom = "plancont.ixx";
     |HAZ Copif;
     aNom = "preconce.dat";
     |HAZ Copif;
     aNom = "preconce.ddx";
     |HAZ Copif;
     aNom = "preconce.ixx";
     |HAZ Copif;
     aNom = "predecab.dat";
     |HAZ Copif;
     aNom = "predecab.ddx";
     |HAZ Copif;
     aNom = "predecab.ixx";
     |HAZ Copif;
     aNom = "predegru.dat";
     |HAZ Copif;
     aNom = "predegru.ddx";
     |HAZ Copif;
     aNom = "predegru.ixx";
     |HAZ Copif;
     aNom = "predelin.dat";
     |HAZ Copif;
     aNom = "predelin.ddx";
     |HAZ Copif;
     aNom = "predelin.ixx";
     |HAZ Copif;
     aNom = "predesub.dat";
     |HAZ Copif;
     aNom = "predesub.ddx";
     |HAZ Copif;
     aNom = "predesub.ixx";
     |HAZ Copif;

     |BUCLE dscbm002;
|FPRC;

|PROCESO dscbm003;
     |SI #dscbm003#2 = "S";
          aEmpresa = ("00" + #dscbm003#0) % -102;
          |QBF aEmpresa;
          aNom = aEmpresa;
          |HAZ Copid;
     |FINSI;
|FPRC;

|DEFBUCLE dscbm003;
 #dscbm003#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, dscbm003;
|FIN;

|PROCESO LinFacGes;
     aPathOri = aPathOri + "fich/";
     aPathDes = aPathDes + "fich/";

     aNom = "facemp.dat ";
     |HAZ Copif;
     aNom = "facemp.ddx";
     |HAZ Copif;
     aNom = "facemp.ixx";
     |HAZ Copif;
     aNom = "facges.dir";
     |HAZ Copif;
     aNom = "forempre.dat";
     |HAZ Copif;
     aNom = "forempre.ddx";
     |HAZ Copif;
     aNom = "forempre.ixx";
     |HAZ Copif;

     |BUCLE dscbm003;
|FPRC;

|PROCESO AgiControl;
     ||Repasar y actualizar el fichero agicontr
     aDefCtrl = aDirBase + "agicli/def/agicontr";
     aPathCtrl = aDirDest;

     |CARGA_DEF aDefCtrl, control@;
     |SI FSalida ! 0;
          |MENAV "0000Error en CARGA_DEF agicontr.";
          |ACABA;
     |FINSI;

     |PATH_DAT #100 aPathCtrl;
     |ABRE #100;
     |LEE 101#control@.=;
     |SI FSalida = 0;
          |SI nSwUnix = 0;
               aDirBaseBo = "";
               aLong = aDirBase % A0;
               nLong = aLong;
               |PARA nCont = 1; |SI nCont [ nLong; |HACIENDO nCont = nCont + 1;
                    nPos = ((nCont * 100) + 1);
                    aAlfa = aDirBase % nPos;
                    |SI aAlfa = "/";
                         aAlfa = "\";
                    |FINSI;
                    aDirBaseBo = aDirBaseBo + aAlfa;
               |SIGUE;
               aDirBase = aDirBaseBo;
               |QBF aDirBase;
          |FINSI;
          |PARA nCampo = 1; |SI nCampo [ 9; |HACIENDO nCampo = nCampo + 1;
               aDirControl = #control@#nCampo#;
               |QBF aDirControl;
               |SI aDirControl ! "";
                    aDirControl = aDirControl - aDirBase;
                    aDirControl = aDirDest + aDirControl;
                    #control@#nCampo# = aDirControl;
               |FINSI;
          |SIGUE;
          |GRABA 020#control@.a;
          |LIBERA #control@;
     |FINSI;
     |CIERRA #100;
|FPRC;
