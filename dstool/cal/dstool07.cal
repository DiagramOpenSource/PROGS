|FICHEROS;
   dstool07 #0;
|FIN;

|VARIABLES;
     aIp = "";
     aOri = "";
     aDst = "";
     aVent = "";

   aCreaDir = "";

   aSistema = "";
   aShell = "";
   aPathPython = "";
   nHandle = 0;
   aMensaje = "";

   nPos1 = 0;
   nPos2 = 0;
   nCalc = 0;

   aAlfa  = "";
   aAlfa1 = "";
   aEsc1  = "";
   aEsc2  = "";
   aRetu  = "";
   aTecla = "";
   nPant   = 0;
   nBoton1 = 0;
   nBoton2 = 0;
   nBoton3 = 0;
   {2}nNivel = 0;
   nIdSalir = 0;
|FIN;

|PROCESO Boton1;
   InNivel = nNivel1<-;
   nNivel1 = 0;
   |ESPECIFICA "IDBOTONTECLA", nNivel;
   nIdSalir = nNivel2;

    aSistema = "ESDOS";
   |QUE_SISTEMA aSistema;
   |SI aSistema = "ESDOS";
       |HAZ PreparaWindows;
   |FINSI;

   |ESTADO_CONTROL nIdSalir, "HIDE";
   |SUB_EJECUTA "dstool06.tab";
   |ESTADO_CONTROL nIdSalir, "SHOW";

|FPRC;

|PROCESO PreparaWindows;
     |DBASE aAlfa;
     aOri = aAlfa + "tar.exe";
     aDst = "c:\windows\system32\tar.exe";
     |XABRE "E",aDst,nHandle;
     |SI FSalida < 0;
          |COPIA_FICHERO aOri, aDst;
     |FINSI;

     aOri = aAlfa + "wget.exe";
     aDst = "c:\windows\system32\wget.exe";
     |XABRE "E",aDst,nHandle;
     |SI FSalida < 0;
          |COPIA_FICHERO aOri, aDst;
     |FINSI;

     aOri = aAlfa + "gzip.exe";
     aDst = "c:\windows\system32\gzip.exe";
     |XABRE "E",aDst,nHandle;
     |SI FSalida < 0;
          |COPIA_FICHERO aOri, aDst;
     |FINSI;


|FPRC;

|PROCESO Boton2;
   aSistema = "ESDOS";
   |QUE_SISTEMA aSistema;
   |SI aSistema ! "ESDOS";
        aSistema = "ESUNIX";
   |FINSI;

   |SI aSistema = "ESUNIX";
        aPathPython = "/usr/bin/python";
        |XABRE "E", aPathPython, nHandle;
        |SI FSalida ] 0;
             aPathPython = "/usr/bin/python";
        |SINO;
             aPathPython = "/usr/local/bin/python";
             |XABRE "E", aPathPython, nHandle;
             |SI FSalida ] 0;
                  aPathPython = "/usr/local/bin/python";
             |SINO;
                  aPathPython = "";
             |FINSI;
        |FINSI;

        |SI aPathPython = "";
             aMensaje = "0000Modulo <python> inaccesible o inexistente. Consulte con su Administrador";
             |MENAV aMensaje;
             |ACABA;
        |FINSI;
   |SINO;
        |DBASS aAlfa1;
        |QBF aAlfa1;
        aPathPython = aAlfa1 + "python";
        aCreaDir = aPathPython + "/tmp/";
        |MKDIR aCreaDir;
   |FINSI;

     aAlfa = "    NLa actualizaci¢n supone abrir una ventana de 30 minutos ";
     aAlfa = aAlfa + "durante la que no se podr  acceder a las aplicaciones.";
     aAlfa = aAlfa + " Adem s se cerrar n las tareas activas. " + &191 + " Est  seguro ?";

     aIp =""
     |IP_REMOTO aIp;
     |SI aIp = "";
          aVent = "0";
     |SINO;
          aVent = "";
          |CONFI aAlfa;
     |FINSI;

   |SI FSalida = 0;|O aVent = "0";
      aSistema = "ESDOS";
      |QUE_SISTEMA aSistema;
      |SI aSistema ! "ESDOS";
          aSistema = "ESUNIX";
      |SINO;
          |HAZ PreparaWindows;
      |FINSI;

      |DBASS aAlfa1;
      aAlfa = aAlfa1 % 0; nCalc = aAlfa;
      nCalc = 100 + nCalc - 1; aAlfa = aAlfa1 % nCalc;

      |SI aSistema = "ESUNIX";
          |SI aPathPython = ""; aPathPython = "python"; |FINSI;
          aShell = aPathPython + " " + aAlfa1 + "agitool/plugins/dsupdater.py " + aAlfa + " > /tmp/dsupdater.log 2> /tmp/dsupdater.err &";
      |SINO;
          aShell ="cmd " +&34 +"/c START " +  aPathPython + "/python " + aAlfa1 + "agitool/plugins/dsupdater.py " + aAlfa + " " + aVent + " > " + aPathPython + "/tmp/dsupdater.log 2> " + aPathPython + "/tmp/dsupdater.err" + &34;
      |FINSI;
      |SYSTEM aShell;
   |SINO;
      |MENAV "    Proceso cancelado";
   |FINSI;
|FPRC;

|PROCESO Boton3;
   InNivel = nNivel1<-;
   nNivel1 = 0;
   |ESPECIFICA "IDBOTONTECLA", nNivel;
   nIdSalir = nNivel2;

   |ESTADO_CONTROL nIdSalir, "HIDE";
   |SUB_EJECUTA "dstool06;BORRAR";
   |ESTADO_CONTROL nIdSalir, "SHOW";

   |PTEC 806;
|FPRC;

|PROCESO tipo80; |TIPO 80;
   FSalida = 2899;
|FPRC;

|PROGRAMA;
   |CLS;

   |CABEZA "Diagram Update";
   |PINPA #0#0;  nPant = FSalida;

     ||COMPROBAR SI en DBASS + "bin" existe el rwnetcon,
     ||en caso contrario no estamos en la carpeta donde se ejecuta el
     ||netcon y tenemos que mostrar un mensaje de advertencia.

     |DBASS aDst;
     |QBF aDst;
     aAlfa = aDst + "bin/rwnetcon";

     aSistema = "ESDOS";
     |QUE_SISTEMA aSistema;
     |SI aSistema = "ESDOS";
          aOri = aAlfa + ".exe";
     |SINO;
          aOri = aAlfa;
     |FINSI;

     ||SISCO
     |XABRE "E",aOri,nHandle;
     |SI FSalida < 0;
          aAlfa = "    Servicio no encontrado en la carpeta " + aDst + ". No tendran efecto las programaciones ni las ventanas.";
          |MENAV aAlfa;
     |FINSI;



   nPos1 = 1240; nPos2 = 1460;
   |CONTROL_SIMPLE nPant, "BOTON,{{137}}Programar Horario", nPos1, nPos2, Boton1;          nBoton1 = FSalida;
   nPos1 = 1640; nPos2 = 1860;
   |CONTROL_SIMPLE nPant, "BOTON,{{197}}Actualizar ahora", nPos1, nPos2, Boton2; nBoton2 = FSalida;
/*
   nPos1 = 2040; nPos2 = 2260;
   |CONTROL_SIMPLE nPant, "BOTON,{{199}}Desactivar", nPos1, nPos2, Boton3; nBoton3 = FSalida;
*/


   aEsc1  = &255 + "806";
   aEsc2  = &255 + "807";
   aRetu  = &255 + "802";
   |PARA; |SI;  |HACIENDO;
       FSalida = "::{{001}}Salir";
       |LEETECLA aTecla;
       |SI aTecla = aEsc1; |SAL;  |FINSI;
       |SI aTecla = aEsc2; |SAL;  |FINSI;
       |SI aTecla = aRetu; |SAL;  |FINSI;
   |SIGUE;

   |FIN_CONTROL_WINDOWS nBoton1;
   |FIN_CONTROL_WINDOWS nBoton2;
||   |FIN_CONTROL_WINDOWS nBoton3;
|FPRO;
