|FICHEROS;
     dsctdm01;
     dsctdm02;     ||Registro de Ejecucion

     tablaemp@ #1;
     tabladat@ #2;
     tablarep@;
|FIN;

|VARIABLES;
     {-1}aSerie = "";

     nC2        = 0;
     nC4        = 0;
     nC5        = 0;
     nC6        = 0;
     nC7        = 0;
     nC8        = 0;
     nC9        = 0;
     nConta     = 0;
     nImpor     = 0;
     nHandle    = 0;
     nAnyo2     = 0;
     nAnyo4     = 0;
     nNume1     = 0;
     nNume2     = 0;
     nLongAnyo  = 0;
     nEjer      = 0;
     nPer       = 0;
     nLong      = 0;
     nVoy       = 0;
     nSaca      = 0;
     nIni       = 0;
     nEjer1     = 0;
     nEjer2     = 0;
     nEjer3     = 0;
     nEjer4     = 0;
     nValC6     = 0;
     n01Ant     = 0;
     n02Ant     = 0;
     n03Ant     = 0;
     n04Ant     = 0;
     n05Ant     = 0;
     n06Ant     = 0;
     n07Ant     = 0;
     n08Ant     = 0;
     n09Ant     = 0;
     n10Ant     = 0;
     n11Ant     = 0;
     n12Ant     = 0;
     n99Ant     = 0;
     n01Act     = 0;
     n02Act     = 0;
     n03Act     = 0;
     n04Act     = 0;
     n05Act     = 0;
     n06Act     = 0;
     n07Act     = 0;
     n08Act     = 0;
     n09Act     = 0;
     n10Act     = 0;
     n11Act     = 0;
     n12Act     = 0;
     n99Act     = 0;
     n01VAn     = 0;
     n02VAn     = 0;
     n03VAn     = 0;
     n04VAn     = 0;
     n05VAn     = 0;
     n06VAn     = 0;
     n07VAn     = 0;
     n08VAn     = 0;
     n09VAn     = 0;
     n10VAn     = 0;
     n11VAn     = 0;
     n12VAn     = 0;
     n99VAn     = 0;
     n01VAc     = 0;
     n02VAc     = 0;
     n03VAc     = 0;
     n04VAc     = 0;
     n05VAc     = 0;
     n06VAc     = 0;
     n07VAc     = 0;
     n08VAc     = 0;
     n09VAc     = 0;
     n10VAc     = 0;
     n11VAc     = 0;
     n12VAc     = 0;
     n99VAc     = 0;
     nDiasCiclo = 0;
     nContador  = 0;
     nSalida    = 0;
     nDias      = 0;
     nHandPSW   = 0;

     aAlfa      = "";
     aAlfa1     = "";
     aAlfa2     = "";
     aBaseAqui  = "";
     aBaseFuera = "";
     aMas       = "";
     aHora      = "";
     aAbre      = "";
     aPathDef   = "";
     aPathFic   = "";
     aTabla     = "";
     aAplica    = "";
     aPaquete   = "";
     aDescri    = "";
     aEmpCod    = "";
     aQueQuiero = "";
     aAuxBarra  = "";
     aLong      = "";
     aLetra     = "";
     aIni       = "";
     aParamIni  = "";
     aIP        = "";
     aSalida    = "";
     aFrom      = "";
     aTo        = "";
     aMensaje   = "";
     aAsunto    = "";
     aPer       = "";
     aLee       = "";
     aIde       = "";

     fFecha     = @;
     fFecActiva = @;
     fDFecha1   = @;
     fHFecha1   = @;
     fDFecha2   = @;
     fHFecha2   = @;
     fUltFecha  = @;
     fHoy       = @;

     &enCredFor = 0;
     &enCredCon = 0;
|FIN;

|PROCESO TrataRegistro;
     nValC6 = 0;

     |SI aAplica = "";
         |ACABA;               ||No lo quites
     |FINSI;

     |SI nC9 ! -1;
         |SI #tabladat@#nC9# ! #dsctdm01#10;  |ACABA;  |FINSI;
     |FINSI;

     |SI aAplica = "dsarchi";
         |SI #tabladat@#1# ! #tablaemp@#0;  |ACABA;  |FINSI;
     |FINSI;

     |SI nC2 ! 0;
         nNume1 = #tabladat@#nC7#;
         nNume2 = #dsctdm01#2;

         |SI aTabla = "dsam9999";  |Y nNume2 = 10;
             |SI #tabladat@#nC7# = "X";
                 nNume1 = 10;
             |FINSI;
         |FINSI;

         |SI nNume1 ! nNume2;  |ACABA;  |FINSI;
     |FINSI;

     |SI nC6 ! -1;
         nValC6 = #tabladat@#nC6#;
     |FINSI;

     nConta = nConta + 1;

     |PULSATECLA;
|FPRC;

|PROCESO GrabaAcum;
     |SI aAplica = "ren2014";
         aAlfa = aPaquete + ";";
     |SINO;
         aAlfa = aAplica + ";";
     |FINSI;

     aAlfa = aAlfa + aTabla  + ";";
     aAlfa = aAlfa + aDescri + ";";

     |SI nEjer ! 0;
          aAlfa = aAlfa + nEjer   + ";";
     |SINO;
          aAlfa = aAlfa + ";";
     |FINSI;

     |SI nPer ] 1;  |Y nPer [ 12;
         aAlfa = aAlfa + (("00" + nPer) % -102) + ";";
     |SINO;
         aAlfa = aAlfa + ";";
     |FINSI;

     aAlfa = aAlfa + nConta  + ";";
     aAlfa = aAlfa + nImpor  + ";";
     aAlfa = aAlfa + aEmpCod + ";";
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO LeeTodo;
     |ABRE #tabladat@;
     |LEE 000#tabladat@.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |HAZ TrataRegistro;
          nImpor = nImpor + nValC6;

          |LEE 000#tabladat@.s;
     |SIGUE;
     |CIERRA #tabladat@;

     |HAZ GrabaAcum;
|FPRC;

|PROCESO CargaVarPer;
     |SI #tabladat@#nC5# = nEjer1;  |O #tabladat@#nC5# = nEjer3;
         |SI #tabladat@#nC8# = 1;  n01Ant = n01Ant + 1;  |FINSI;
         |SI #tabladat@#nC8# = 2;  n02Ant = n02Ant + 1;  |FINSI;
         |SI #tabladat@#nC8# = 3;  n03Ant = n03Ant + 1;  |FINSI;
         |SI #tabladat@#nC8# = 4;  n04Ant = n04Ant + 1;  |FINSI;
         |SI #tabladat@#nC8# = 5;  n05Ant = n05Ant + 1;  |FINSI;
         |SI #tabladat@#nC8# = 6;  n06Ant = n06Ant + 1;  |FINSI;
         |SI #tabladat@#nC8# = 7;  n07Ant = n07Ant + 1;  |FINSI;
         |SI #tabladat@#nC8# = 8;  n08Ant = n08Ant + 1;  |FINSI;
         |SI #tabladat@#nC8# = 9;  n09Ant = n09Ant + 1;  |FINSI;
         |SI #tabladat@#nC8# = 10; n10Ant = n10Ant + 1;  |FINSI;
         |SI #tabladat@#nC8# = 11; n11Ant = n11Ant + 1;  |FINSI;
         |SI #tabladat@#nC8# = 12; n12Ant = n12Ant + 1;  |FINSI;
         |SI #tabladat@#nC8# = 99; n99Ant = n99Ant + 1;  |FINSI;

         |SI #tabladat@#nC8# = 1;  n01VAn = n01VAn + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 2;  n02VAn = n02VAn + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 3;  n03VAn = n03VAn + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 4;  n04VAn = n04VAn + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 5;  n05VAn = n05VAn + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 6;  n06VAn = n06VAn + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 7;  n07VAn = n07VAn + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 8;  n08VAn = n08VAn + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 9;  n09VAn = n09VAn + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 10; n10VAn = n10VAn + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 11; n11VAn = n11VAn + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 12; n12VAn = n12VAn + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 99; n99VAn = n99VAn + nValC6;  |FINSI;
     |FINSI;

     |SI #tabladat@#nC5# = nEjer2;  |O #tabladat@#nC5# = nEjer4;
         |SI #tabladat@#nC8# = 1;  n01Act = n01Act + 1;  |FINSI;
         |SI #tabladat@#nC8# = 2;  n02Act = n02Act + 1;  |FINSI;
         |SI #tabladat@#nC8# = 3;  n03Act = n03Act + 1;  |FINSI;
         |SI #tabladat@#nC8# = 4;  n04Act = n04Act + 1;  |FINSI;
         |SI #tabladat@#nC8# = 5;  n05Act = n05Act + 1;  |FINSI;
         |SI #tabladat@#nC8# = 6;  n06Act = n06Act + 1;  |FINSI;
         |SI #tabladat@#nC8# = 7;  n07Act = n07Act + 1;  |FINSI;
         |SI #tabladat@#nC8# = 8;  n08Act = n08Act + 1;  |FINSI;
         |SI #tabladat@#nC8# = 9;  n09Act = n09Act + 1;  |FINSI;
         |SI #tabladat@#nC8# = 10; n10Act = n10Act + 1;  |FINSI;
         |SI #tabladat@#nC8# = 11; n11Act = n11Act + 1;  |FINSI;
         |SI #tabladat@#nC8# = 12; n12Act = n12Act + 1;  |FINSI;
         |SI #tabladat@#nC8# = 99; n99Act = n99Act + 1;  |FINSI;

         |SI #tabladat@#nC8# = 1;  n01VAc = n01VAc + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 2;  n02VAc = n02VAc + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 3;  n03VAc = n03VAc + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 4;  n04VAc = n04VAc + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 5;  n05VAc = n05VAc + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 6;  n06VAc = n06VAc + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 7;  n07VAc = n07VAc + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 8;  n08VAc = n08VAc + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 9;  n09VAc = n09VAc + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 10; n10VAc = n10VAc + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 11; n11VAc = n11VAc + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 12; n12VAc = n12VAc + nValC6;  |FINSI;
         |SI #tabladat@#nC8# = 99; n99VAc = n99VAc + nValC6;  |FINSI;
     |FINSI;
|FPRC;

|PROCESO IniVar;
     n01Ant = 0;
     n02Ant = 0;
     n03Ant = 0;
     n04Ant = 0;
     n05Ant = 0;
     n06Ant = 0;
     n07Ant = 0;
     n08Ant = 0;
     n09Ant = 0;
     n10Ant = 0;
     n11Ant = 0;
     n12Ant = 0;
     n99Ant = 0;
     n01Act = 0;
     n02Act = 0;
     n03Act = 0;
     n04Act = 0;
     n05Act = 0;
     n06Act = 0;
     n07Act = 0;
     n08Act = 0;
     n09Act = 0;
     n10Act = 0;
     n11Act = 0;
     n12Act = 0;
     n99Act = 0;

     n01VAn = 0;
     n02VAn = 0;
     n03VAn = 0;
     n04VAn = 0;
     n05VAn = 0;
     n06VAn = 0;
     n07VAn = 0;
     n08VAn = 0;
     n09VAn = 0;
     n10VAn = 0;
     n11VAn = 0;
     n12VAn = 0;
     n99VAn = 0;

     n01VAc = 0;
     n02VAc = 0;
     n03VAc = 0;
     n04VAc = 0;
     n05VAc = 0;
     n06VAc = 0;
     n07VAc = 0;
     n08VAc = 0;
     n09VAc = 0;
     n10VAc = 0;
     n11VAc = 0;
     n12VAc = 0;
     n99VAc = 0;

     nConta = 0;
|FPRC;

|PROCESO LeePorPeriodos;
     nEjer1 = nAnyo4 - 1;
     nEjer2 = nAnyo4;

     nEjer3 = nAnyo2 - 1;
     nEjer4 = nAnyo2;

     |HAZ IniVar;

     |ABRE #tabladat@;
     |LEE 000#tabladat@.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
        nConta = 0;
         |SI nLongAnyo < 4;
             |SI #tabladat@#nC5# = nEjer3;  |O #tabladat@#nC5# = nEjer4;
                 |HAZ TrataRegistro;
             |FINSI;
         |SINO;
              |SI #tabladat@#nC5# = nEjer1;  |O #tabladat@#nC5# = nEjer2;
                  |HAZ TrataRegistro;
              |FINSI;
          |FINSI;

          |SI nConta ! 0;  |HAZ CargaVarPer;  |FINSI;

          |LEE 000#tabladat@.s;
     |SIGUE;

     |SI n01Ant ! 0; nPer = 01; nEjer = nEjer1; nConta = n01Ant; nImpor = n01VAn; |HAZ GrabaAcum; |FINSI;
     |SI n02Ant ! 0; nPer = 02; nEjer = nEjer1; nConta = n02Ant; nImpor = n02VAn; |HAZ GrabaAcum; |FINSI;
     |SI n03Ant ! 0; nPer = 03; nEjer = nEjer1; nConta = n03Ant; nImpor = n03VAn; |HAZ GrabaAcum; |FINSI;
     |SI n04Ant ! 0; nPer = 04; nEjer = nEjer1; nConta = n04Ant; nImpor = n04VAn; |HAZ GrabaAcum; |FINSI;
     |SI n05Ant ! 0; nPer = 05; nEjer = nEjer1; nConta = n05Ant; nImpor = n05VAn; |HAZ GrabaAcum; |FINSI;
     |SI n06Ant ! 0; nPer = 06; nEjer = nEjer1; nConta = n06Ant; nImpor = n06VAn; |HAZ GrabaAcum; |FINSI;
     |SI n07Ant ! 0; nPer = 07; nEjer = nEjer1; nConta = n07Ant; nImpor = n07VAn; |HAZ GrabaAcum; |FINSI;
     |SI n08Ant ! 0; nPer = 08; nEjer = nEjer1; nConta = n08Ant; nImpor = n08VAn; |HAZ GrabaAcum; |FINSI;
     |SI n09Ant ! 0; nPer = 09; nEjer = nEjer1; nConta = n09Ant; nImpor = n09VAn; |HAZ GrabaAcum; |FINSI;
     |SI n10Ant ! 0; nPer = 10; nEjer = nEjer1; nConta = n10Ant; nImpor = n10VAn; |HAZ GrabaAcum; |FINSI;
     |SI n11Ant ! 0; nPer = 11; nEjer = nEjer1; nConta = n11Ant; nImpor = n11VAn; |HAZ GrabaAcum; |FINSI;
     |SI n12Ant ! 0; nPer = 12; nEjer = nEjer1; nConta = n12Ant; nImpor = n12VAn; |HAZ GrabaAcum; |FINSI;
     |SI n99Ant ! 0; nPer = 99; nEjer = nEjer1; nConta = n99Ant; nImpor = n99VAn; |HAZ GrabaAcum; |FINSI;

     |SI n01Act ! 0; nPer = 01; nEjer = nEjer2; nConta = n01Act; nImpor = n01VAc; |HAZ GrabaAcum; |FINSI;
     |SI n02Act ! 0; nPer = 02; nEjer = nEjer2; nConta = n02Act; nImpor = n02VAc; |HAZ GrabaAcum; |FINSI;
     |SI n03Act ! 0; nPer = 03; nEjer = nEjer2; nConta = n03Act; nImpor = n03VAc; |HAZ GrabaAcum; |FINSI;
     |SI n04Act ! 0; nPer = 04; nEjer = nEjer2; nConta = n04Act; nImpor = n04VAc; |HAZ GrabaAcum; |FINSI;
     |SI n05Act ! 0; nPer = 05; nEjer = nEjer2; nConta = n05Act; nImpor = n05VAc; |HAZ GrabaAcum; |FINSI;
     |SI n06Act ! 0; nPer = 06; nEjer = nEjer2; nConta = n06Act; nImpor = n06VAc; |HAZ GrabaAcum; |FINSI;
     |SI n07Act ! 0; nPer = 07; nEjer = nEjer2; nConta = n07Act; nImpor = n07VAc; |HAZ GrabaAcum; |FINSI;
     |SI n08Act ! 0; nPer = 08; nEjer = nEjer2; nConta = n08Act; nImpor = n08VAc; |HAZ GrabaAcum; |FINSI;
     |SI n09Act ! 0; nPer = 09; nEjer = nEjer2; nConta = n09Act; nImpor = n09VAc; |HAZ GrabaAcum; |FINSI;
     |SI n10Act ! 0; nPer = 10; nEjer = nEjer2; nConta = n10Act; nImpor = n10VAc; |HAZ GrabaAcum; |FINSI;
     |SI n11Act ! 0; nPer = 11; nEjer = nEjer2; nConta = n11Act; nImpor = n11VAc; |HAZ GrabaAcum; |FINSI;
     |SI n12Act ! 0; nPer = 12; nEjer = nEjer2; nConta = n12Act; nImpor = n12VAc; |HAZ GrabaAcum; |FINSI;
     |SI n99Act ! 0; nPer = 99; nEjer = nEjer2; nConta = n99Act; nImpor = n99VAc; |HAZ GrabaAcum; |FINSI;
|FPRC;

|PROCESO CargaVarEjer;
     |SI nEjer1 = nEjer2;
         n99Act = n99Act + 1;
         |ACABA;
     |FINSI;

     |SI #tabladat@#nC5# = nEjer1;  |O #tabladat@#nC5# = nEjer3;
         n99Ant = n99Ant + 1;
         n99VAn = n99VAn + nValC6;
     |FINSI;

     |SI #tabladat@#nC5# = nEjer2;  |O #tabladat@#nC5# = nEjer4;
         n99Act = n99Act + 1;
         n99VAc = n99VAc + nValC6;
     |FINSI;
|FPRC;

|PROCESO LeePorEjer;
     nEjer1 = nAnyo4 - 1;
     nEjer2 = nAnyo4;

     nEjer3 = nAnyo2 - 1;
     nEjer4 = nAnyo2;

     |SI aAplica = "contasoc";
         nEjer1 = nAnyo4 - 1;
         nEjer2 = nAnyo4 - 1;

         nEjer3 = nAnyo2 - 1;
         nEjer4 = nAnyo2 - 1;
     |FINSI;

     |HAZ IniVar;

     |ABRE #tabladat@;
     |LEE 000#tabladat@.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
        nConta = 0;
         |SI nLongAnyo < 4;
             |SI #tabladat@#nC5# = nEjer3;  |O #tabladat@#nC5# = nEjer4;
                 |HAZ TrataRegistro;
             |FINSI;
         |SINO;
              |SI #tabladat@#nC5# = nEjer1;  |O #tabladat@#nC5# = nEjer2;
                  |HAZ TrataRegistro;
              |FINSI;
          |FINSI;

          |SI nConta ! 0;  |HAZ CargaVarEjer;  |FINSI;

          |LEE 000#tabladat@.s;
     |SIGUE;

     |SI n99Ant ! 0;
         nPer   = 99;
         nEjer  = nEjer1;
         nConta = n99Ant;
         nImpor = n99VAn;
         |HAZ GrabaAcum;
     |FINSI;

     |SI n99Act ! 0;
         nPer   = 99;
         nEjer  = nEjer2;
         nConta = n99Act;
         nImpor = n99VAc;
         |HAZ GrabaAcum;
     |FINSI;
|FPRC;

|PROCESO CargaVarFecha;
     |SI fFecha ] fDFecha1;  |Y fFecha [ fHFecha1;
         n99Ant = n99Ant + 1;
         n99VAn = n99VAn + nValC6;
     |FINSI;

     |SI fFecha ] fDFecha2;  |Y fFecha [ fHFecha2;
         n99Act = n99Act + 1;
         n99VAc = n99VAc + nValC6;
     |FINSI;
|FPRC;

|PROCESO LeePorFecha;
     nEjer1 = nAnyo4 - 1;
     nEjer2 = nAnyo4;

     aAlfa = "01.01." + nEjer1;  fDFecha1 = aAlfa;
     aAlfa = "31.12." + nEjer1;  fHFecha1 = aAlfa;

     aAlfa = "01.01." + nEjer2;  fDFecha2 = aAlfa;
     aAlfa = "31.12." + nEjer2;  fHFecha2 = aAlfa;

     |HAZ IniVar;

     |ABRE #tabladat@;
     |LEE 000#tabladat@.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
         fFecha = #tabladat@#nC4#;
         nConta = 0;

         |SI fFecha ] fDFecha1;  |Y fFecha [ fHFecha1;
             |HAZ TrataRegistro;
         |FINSI;

         |SI fFecha ] fDFecha2;  |Y fFecha [ fHFecha2;
             |HAZ TrataRegistro;
         |FINSI;

         |SI nConta ! 0;  |HAZ CargaVarFecha;  |FINSI;

         |LEE 000#tabladat@.s;
     |SIGUE;

     |SI n99Ant ! 0;
         nPer   = 99;
         nEjer  = nEjer1;
         nConta = n99Ant;
         nImpor = n99VAn;
         |HAZ GrabaAcum;
     |FINSI;

     |SI n99Act ! 0;
         nPer   = 99;
         nEjer  = nEjer2;
         nConta = n99Act;
         nImpor = n99VAc;
         |HAZ GrabaAcum;
     |FINSI;
|FPRC;

|PROCESO LeePSW;
     aAlfa = aBaseFuera + "dev/usr/ds_sys.psw";
     |XABRE "", aAlfa, nHandPSW;
     |PARA;  |SI;  |HACIENDO;
          |XLEE nHandPSW, 255, aLee;
          |SI FSalida < 0;  |SAL;  |FINSI;

          nConta = nConta + 1;
     |SIGUE;
     |XCIERRA nHandPSW;

     |HAZ GrabaAcum;
|FPRC;

|PROCESO CreditosFormacion;
     nEjer1 = nAnyo4 - 1;
     nEjer2 = nAnyo4;

     aAlfa = ":laboral/nominf05;ESTADISTICA" + nEjer1;
     |SUB_EJECUTA aAlfa;

     aDescri = "Credito formaci¢n";
     nEjer   = nEjer1;
     nPer    = 0;
     nConta  = 0;
     nImpor  = enCredFor;
     aEmpCod = "";
     |HAZ GrabaAcum;

     aDescri = "Credito consumido";
     nEjer   = nEjer1;
     nPer    = 0;
     nConta  = 0;
     nImpor  = enCredCon;
     aEmpCod = "";
     |HAZ GrabaAcum;

     aAlfa = ":laboral/nominf05;ESTADISTICA" + nEjer2;
     |SUB_EJECUTA aAlfa;

     aDescri = "Credito formaci¢n";
     nEjer   = nEjer2;
     nPer    = 0;
     nConta  = 0;
     nImpor  = enCredFor;
     aEmpCod = "";
     |HAZ GrabaAcum;

     aDescri = "Credito consumido";
     nEjer   = nEjer2;
     nPer    = 0;
     nConta  = 0;
     nImpor  = enCredCon;
     aEmpCod = "";
     |HAZ GrabaAcum;
|FPRC;

|PROCESO Convenios;
     aMas = aPathDef + aTabla;
     |CARGA_DEF aMas, tablarep@;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aIde = "              ";

     |ABRE #tabladat@;  |SELECT #3#tabladat@;
     |LEE 000#tabladat@.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |SI aIde ! #tabladat@#142;  |Y aIde ! "              ";
                                      |Y nConta ! 0;
              aDescri = aIde;
              nEjer   = 0;
              nPer    = 0;
              nImpor  = 0;
              aEmpCod = "";
              |HAZ GrabaAcum;

              nConta = 0;
          |FINSI;

          nConta = nConta + 1;
          aIde   = #tabladat@#142;

          |LEE 000#tabladat@.s;
     |SIGUE;

     |SI nConta ! 0;  |Y aIde ! "              ";
         aDescri = aIde;
         nEjer   = 0;
         nPer    = 0;
         nImpor  = 0;
         aEmpCod = "";
         |HAZ GrabaAcum;
     |FINSI;

     |CIERRA #tabladat@;
     |DESCARGA_DEF #tablarep@;
|FPRC;

|PROCESO dsctdm01;
     nConta  = 0;
     nImpor  = 0;
     aTabla  = #dsctdm01#1;  |QBF aTabla;
     aPer    = "";
     nC2     = #dsctdm01#2;
     nC4     = #dsctdm01#4;
     nC5     = #dsctdm01#5;
     nC6     = #dsctdm01#6;
     nC7     = #dsctdm01#7;
     nC8     = #dsctdm01#8;
     nC9     = #dsctdm01#9;

     aDescri = #dsctdm01#3;  |QBF aDescri;

     |SI aAplica = "dsarchi";
         aDescri = "Registros GAD del grupo " + #tablaemp@#1;  |QBF aDescri;
     |FINSI;

     |SI aTabla = "nominf05";
         |HAZ CreditosFormacion;

         |ACABA;
     |FINSI;

     |SI aAplica = "integral";  |Y aTabla = "dsam0108";
         |HAZ LeePSW;

         |ACABA;
     |FINSI;

     aMas = aPathDef + aTabla;
     |CARGA_DEF aMas, tabladat@;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |PATH_DAT #tabladat@#aPathFic#;
     |ABRET #tabladat@;

     |SI nC5 ! -1;
         aQueQuiero = "|C" + (("000" + nC5) % -103) + "LONGITUD";
         aAlfa      = #tabladat@#aQueQuiero#;  |QBF aAlfa;
         nLongAnyo  = aAlfa;
     |FINSI;

     |SI aAplica = "laboral";  |Y aTabla = "nomconca";
         |HAZ Convenios;

         |CIERRA #tabladat@;
         |DESCARGA_DEF #tabladat@;

         |ACABA;
     |FINSI;

     |SI nC8 ! -1;
         |HAZ LeePorPeriodos;
     |SINO;
          |SI nC5 ! -1;
              |HAZ LeePorEjer;
          |SINO;
              |SI nC4 ! -1;
                   |HAZ LeePorFecha;
              |SINO;
                  |HAZ LeeTodo;
              |FINSI;
          |FINSI;
     |FINSI;

     |CIERRA #tabladat@;
     |DESCARGA_DEF #tabladat@;
|FPRC;

|DEFBUCLE dsctdm01;
     #dsctdm01#1;
     ;
     aAplica, "        ", 000;
     aAplica, "zzzzzzzz", 999;
     ;
     NULL, dsctdm01;
|FIN;

|PROCESO Integral;
     aAplica  = "integral";
     aEmpCod  = "";
     aPathDef = aBaseFuera + "integral/def/";
     aPathFic = aBaseFuera + "integral/fich/";
     nPer     = 0;
     nEjer    = 0;

     |BUCLE dsctdm01;
|FPRC;

|PROCESO Modelos;
     aAplica  = "modelos";
     aEmpCod  = "";
     aPathDef = aBaseFuera + "modelos/def/";
     aPathFic = aBaseFuera + "modelos/fich/";
     nPer     = 0;
     nEjer    = 0;

     |BUCLE dsctdm01;
|FPRC;

|PROCESO Laboral;
     aAplica  = "laboral";
     aEmpCod  = "";
     aPathDef = aBaseFuera + "laboral/def/";
     aPathFic = aBaseFuera + "laboral/fich/";
     nPer     = 0;
     nEjer    = 0;

     |BUCLE dsctdm01;
|FPRC;

|PROCESO Renta;
     nPer     = 0;
     nEjer    = 0;
     nEjer1   = nAnyo4 - 1;
     nEjer2   = nAnyo4;

     aPathDef = aBaseFuera + "ren" + nAnyo4 + "/def/";
     aAlfa    = aPathDef + "reacceso.mas";
     |XABRE "E", aAlfa, 0;
     |SI FSalida < 0;
         nEjer1   = nAnyo4 - 1;
         nEjer2   = nAnyo4 - 1;
     |FINSI;

     aEmpCod  = "";
     aAplica  = "ren2014";
     nPer     = 0;

     |PARA nEjer = nEjer1;  |SI nEjer [ nEjer2;  |HACIENDO nEjer = nEjer + 1;
           aPathDef = aBaseFuera + "ren" + nEjer + "/def/";
           aAlfa    = aPathDef + "reacceso.mas";
           |XABRE "E", aAlfa, 0;
           |SI FSalida < 0;  |SAL;  |FINSI;

           aPaquete = "ren" + nEjer;
           aPathDef = aBaseFuera + aPaquete + "/def/";
           aPathFic = aBaseFuera + aPaquete + "/fich/";

           |BUCLE dsctdm01;
     |SIGUE;
|FPRC;

|PROCESO Sociedades;
     aAplica  = "contasoc";
     aEmpCod  = "";
     aPathDef = aBaseFuera + "contasoc/def/";
     aPathFic = aBaseFuera + "contasoc/fich/";
     nPer     = 0;
     nEjer    = 0;

     |BUCLE dsctdm01;
|FPRC;

|PROCESO Contabilidad;
     aAplica  = "contagen";
     aEmpCod  = "";
     aPathDef = aBaseFuera + "contagen/def/";
     aPathFic = aBaseFuera + "contagen/fich/";
     nPer     = 0;
     nEjer    = 0;

     aMas = aPathDef + "canempre.mas";
     |CARGA_DEF aMas, tablaemp@;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |PATH_DAT #tablaemp@#aPathFic#;

     nEjer3 = nAnyo2 - 1;
     nEjer4 = nAnyo2;

     |ABRE #tablaemp@;
     |LEE 000#tablaemp@.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |SI #tablaemp@#26 = nEjer3;  |O #tablaemp@#26 = nEjer4;
              nEjer    = 2000 + #tablaemp@#26;
              aEmpCod  = (("00000" + #tablaemp@#2) % -105) + #tablaemp@#3;
              aPathFic = aBaseFuera + "contagen/fich/" + aEmpCod + "/";

              |BUCLE dsctdm01;
          |FINSI;

          |LEE 000#tablaemp@.s;
     |SIGUE;
     |CIERRA #tablaemp@;

     |DESCARGA_DEF #tablaemp@;
|FPRC;

|PROCESO Facturar;
     aAplica  = "facturar";
     aEmpCod  = "";
     aPathDef = aBaseFuera + "facturar/def/";
     aPathFic = aBaseFuera + "facturar/fich/";
     nPer     = 0;
     nEjer    = 0;

     aMas = aPathDef + "facemp.mas";
     |CARGA_DEF aMas, tablaemp@;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |PATH_DAT #tablaemp@#aPathFic#;

     |ABRE #tablaemp@;
     |LEE 000#tablaemp@.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          aEmpCod  = (("00" + #tablaemp@#0) % -102);
          aPathFic = aBaseFuera + "facturar/fich/" + aEmpCod + "/";

          |BUCLE dsctdm01;

          |LEE 000#tablaemp@.s;
     |SIGUE;
     |CIERRA #tablaemp@;

     |DESCARGA_DEF #tablaemp@;
|FPRC;

|PROCESO GAD;
     aAplica  = "dsarchi";
     aEmpCod  = "";
     aPathDef = aBaseFuera + aAplica + "/def/";
     aPathFic = aBaseFuera + "dsarchi/fich/";
     nPer     = 0;
     nEjer    = 0;

     aMas = aPathDef + "dsarm002.mas";
     |CARGA_DEF aMas, tablaemp@;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |PATH_DAT #tablaemp@#aPathFic#;

     |ABRE #tablaemp@;
     |LEE 000#tablaemp@.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
          |BUCLE dsctdm01;

          |LEE 000#tablaemp@.s;
     |SIGUE;
     |CIERRA #tablaemp@;

     |DESCARGA_DEF #tablaemp@;
|FPRC;

|PROCESO QuitaBarras;
     aAuxBarra = "";
     aLong = aBaseFuera % A0;
     nLong = aLong;
     |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
          nSaca = (nVoy * 100) + 1;
          aLetra = aBaseFuera % nSaca;
          |SI aLetra = "/";  |O aLetra = "\";
               aLetra = "_";
          |FINSI;
          aAuxBarra = aAuxBarra + aLetra;

          |SI aLetra = ":";
              aAuxBarra = "";
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO AveriguaINI;
     aSerie = "";
     |ESPECIFICA "SERIALIZACION", aSerie;
     aIni = FSalida;          ||Antes esto lo devolvia en la variable aSerie
     aIni = aIni % 106;       ||Esto es el numero de ORO. Los 6 primeros digitos
     nIni = aIni;
     aIni = ("000000" + nIni) % -106;

     |HAZ QuitaBarras;

     aParamIni = aIni + aAuxBarra;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;

|PROCESO MandaCorreo;
     aIP      = "xdscorreo.dv.diagram.net";
     aSalida  = "smtp.soporte.diagram.net";
     aFrom    = "controlinterno@diagram.es";
     aTo      = "dsctdrs@diagram.es";

     aAlfa    = "ESTADISTICA ASESORIA ";
     aAlfa    = aAlfa + aIni + aAuxBarra;
     aMensaje = aAlfa;
     aAsunto  = aAlfa;

     |DSCORREO_ENVIA aIP, aSalida, aFrom, aTo, aAsunto, aMensaje, aAbre;
     nSalida = FSalida;
     |SI nSalida ] 0;
          #dsctdm02#0 = nContador;
          |LEE 101#dsctdm02.=;
          |SI FSalida = 0;
               #dsctdm02#2 = "S";
               |GRABA 020#dsctdm02.a;
               |LIBERA #dsctdm02;
          |FINSI;
     |FINSI;
|FPRC;

|PROGRAMA;
     nDiasCiclo = 30;
     fFecActiva = "27.10.2017";

     |DBASE aBaseAqui;  |QBF aBaseAqui;
     |DBASS aBaseFuera; |QBF aBaseFuera;

     aMas = aBaseFuera + "integral/def/dsam0000.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |HAZ AveriguaINI;

     nContador = 1;
     |ABRE #dsctdm02;
     |LEE 000#dsctdm02.u;
     |SI FSalida = 0;
          nContador = #dsctdm02#0 + 1;

          fUltFecha = #dsctdm02#1;
          fHoy      = ~;

          |SI fHoy ] fFecActiva;
              |SI #dsctdm02#1 < fFecActiva;
                  #dsctdm02#2 = "N";
              |FINSI;
          |FINSI;

          |SI #dsctdm02#2 = "N";
               ||La ultima vez que se lanzo fallo, por lo tanto
               ||Lo tenemos que volver a lanzar y registrar
          |SINO;
               ||Verificamos si hace mas de nDiasCiclo, para lanzarlo o no
               fHoy = ~;

               nDias = fHoy - fUltFecha;
               |SI nDias < nDiasCiclo;
                   |CIERRA #dsctdm02;
                   |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     #dsctdm02#0 = nContador;
     |LEE 101#dsctdm02.=;
     |SI FSalida ! 0;
          |DDEFECTO #dsctdm02;
          #dsctdm02#0 = nContador;
          #dsctdm02#1 = ~;
          |GRABA 020#dsctdm02.n;
          |LIBERA #dsctdm02;
     |FINSI;

     fFecha = ~;
     |HORA aHora;

     aAlfa  = fFecha % -104;  nAnyo4 = aAlfa;
     aAlfa  = fFecha % -102;  nAnyo2 = aAlfa;

     aAbre = aBaseAqui + "tmp";  |MKDIR aAbre;
     aAbre = aBaseAqui + "tmp/";
     aAbre = aAbre + aParamIni;
     aAbre = aAbre + (fFecha % -104);
     aAbre = aAbre + (fFecha % 0402);
     aAbre = aAbre + (fFecha % 0102);
     aAbre = aAbre + (aHora % 0102);
     aAbre = aAbre + (aHora % 0402);
     aAbre = aAbre + (aHora % 0702);
     aAbre = aAbre + ".csv";

     |XABRE "BW", aAbre, nHandle;
     aAlfa = "Aplicación;";
     aAlfa = aAlfa + "Tabla;";
     aAlfa = aAlfa + "Descripción tabla;";
     aAlfa = aAlfa + "Ejercicio;";
     aAlfa = aAlfa + "Periodo;";
     aAlfa = aAlfa + "Contador;";
     aAlfa = aAlfa + "Importe;";
     aAlfa = aAlfa + "Codigo empresa acceso;";
     aAlfa = aAlfa + "Nombre empresa acceso;";
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;

     |HAZ Integral;
     |HAZ Modelos;
     |HAZ Laboral;
     |HAZ Renta;
     |HAZ Sociedades;
     |HAZ Contabilidad;
     |HAZ Facturar;
     |HAZ GAD;

     |XCIERRA nHandle;

     |HAZ MandaCorreo;

     |FBORRA aAbre;

     |CIERRA #dsctdm02;
|FPRO;
