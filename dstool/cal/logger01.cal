|FICHEROS;
     logger01 #0;
     logger00 #99;
|FIN;

|VARIABLES;
     &PRMNT_eExtrae = "";
     &PRMNT_eVersio = 0;

     nLong = 0;
     aLong = "";
     nPos = 0;
     nMod = 0;
     aNom = "";
     aDsini1 = "";
     aDsini2 = "";

     &eaLogger = "";
     nAcot = 0;
     aAbre = "";
     aAbre2 = "";
     nCanal = 0;
     aChar = ""
     aAscii = "";
     aAsci2 = "";
     nLin = 0;
     nCodAsc = 0;
     aLetra = "";
     aAlfa = "";
     aAlfa2 = "";
     nHandle = 0;

     nCuenta = 0;

     nParaI = 0;
     nI   = 0;
     nJ   = 0;
     nK   = 0;
     nX   = 0;
     nY   = 0;

     aUsr = "";
     fFecha = @;
     aHora = "";
     aTipo = "";
     nAcc  = 0;
     aTabDef = "";
     aTitul = "";
     nCampo  = 0;
     aVant  = "";
     aVnou  = "";
     aClau  = "";
     aMac   = "";
     aEmpresa = "";
|FIN;

|PROCESO logger01;
     |PRINT;
|FPRC;


|DEFBUCLE logger01;
     #0#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, logger01;
|FIN;

|PROCESO SacaTabDef;
     |VARIABLES;
          aLongi = "";
          nLongi = 0;
          nPara1 = 0;
          nPosic = 0;
     |FIN;

     aLongi = aAscii % 0;
     nLongi = aLongi;

     aTabDef = "";

     |PARA nPara1 = nLongi; |SI nPara1 ] 1; |HACIENDO nPara1 = nPara1 - 1;
          nPosic = (nPara1 * 100) + 1;
          aAlfa = aAscii % nPosic;
          |SI aAlfa = "/";|O aAlfa = "\";
               |SAL;
          |SINO;
               aTabDef = aAlfa + aTabDef;
          |FINSI;
     |SIGUE;

     aTabDef = aTabDef % 108;

     nLongi = nPara1 - 1;
     |PARA nPara1 = nLongi; |SI nPara1 ] 1; |HACIENDO nPara1 = nPara1 - 1;
          nPosic = (nPara1 * 100) + 1;
          aAlfa = aAscii % nPosic;
          |SI aAlfa = "/";|O aAlfa = "\";
               |SAL;
          |SINO;
               aEmpresa = aAlfa + aEmpresa;
          |FINSI;
     |SIGUE;
     |SI aEmpresa = "fich"
          aEmpresa = "";
     |FINSI;
|FPRC;

|PROCESO Graba;
     |DDEFECTO #0;

     aTitul = aTitul - &10;
     aClau  = aClau  - &10;
     |SI aUsr ! "";      #0#0 = aUsr;        |FINSI;
     |SI fFecha ! @;     #0#1 = fFecha;      |FINSI;
     |SI aHora ! "";     #0#2 = aHora;       |FINSI;
     |SI aTipo ! "";     #0#3 = aTipo;       |FINSI;
     |SI nAcc ! 0;       #0#4 = nAcc;        |FINSI;
     |SI aTabDef ! "";   #0#5 = aTabDef;     |FINSI;
     |SI nCampo ! 0;     #0#6 = nCampo;      |FINSI;
     |SI aClau ! "";     #0#7 = aClau;       |FINSI;
     |SI aMac  ! "";     #0#8 = aMac;        |FINSI;
     |SI aEmpresa  ! ""; #0#9 = aEmpresa;    |FINSI;
     |SI aTitul ! "";    #0#10 = aTitul;     |FINSI;
     |SI aVnou ! "";     #0#11 = aVnou;       |FINSI;
     |SI aVant ! "";     #0#12 = aVant;       |FINSI;


     nCuenta = nCuenta + 1;
     #0#13 = nCuenta;
     |SI nAcot = 1;
          |SI #0#0 ] #99#0; |Y #0#0 [ #99#1;
               |SI #0#1 ] #99#2; |Y #0#1 [ #99#3;
                    |SI #0#2 ] #99#4; |Y #0#2 [ #99#5;
                         |SI #0#5 ] #99#8; |Y #0#5 [ #99#9;
                              |SI #0#6 ] #99#10; |Y #0#6 [ #99#11;
                                 |SI #0#9 ] #99#23; |Y #0#9 [ #99#24;
                                   |SI #0#7 ] #99#12; |Y #0#7 [ #99#13;
                                      |SI #0#8 ] #99#21; |Y #0#8 [ #99#22;
                                        |SI #99#6 = "*";
                                             |GRABA 020#0n;
                                        |SINO;
                                             |SI #99#6 = #0#3; |Y #99#7 = #0#4;
                                                  |GRABA 020#0n;
                                             |FINSI;
                                        |FINSI;
                                      |FINSI;
                                   |FINSI;
                                 |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          |GRABA 020#0n;
     |FINSI;
|FPRC;


|PROCESO Extrae;
     aAbre2 = #99#15; |QBF aAbre2;
     aAbre2 = aAbre2 + eaLogger;

     aAbre = aAbre2 + "_extrayendo";
     |COPIA_FICHERO aAbre2,aAbre;
     |SI FSalida < 0;
          |ACABA;
     |FINSI;
     nLin = 1;
     |XABRE "AB", aAbre, nCanal;
     |PARA; |SI FSalida ] 0; |HACIENDO;
          nI = 0;
          nJ = 0;
          nX = 0;
          nY = 0;
          |XLEE nCanal, 1, aChar;
          |SI FSalida [ 0; |SAL; |FINSI;

          aAscii =aAscii + aChar;
          nCodAsc = &aChar;
          |SI nCodAsc = 10; ||Leemos una fila completa
               aLongi = aAscii % 0;
               nLongi = aLongi;
               |SI nLin = 1;
                    ||Aqui podemos limpiar todas las variables que se registran
                    aUsr = "";
                    fFecha = @;
                    aHora = "";
                    aTipo = "";
                    nAcc = "";
                    aTabDef = "";
                    aTitul = "";
                    nCampo = 0;
                    aVant = 0;
                    aVnou = 0;
                    aClau = "";
                    aMac  = "";
                    aEmpresa = "";

                    aUsr = aAscii %110; |QBF aUsr;

                    aAlfa = aAscii % 1210;
                    fFecha = aAlfa;

                    aHora = aAscii % 2308;
                    aMac  = aAscii % 3317;
               |FINSI;
               |SI nLin > 1;
                    aLetra = aAscii % 102;
                    |SI aLetra = "--";
                         aLetra = aAscii % 808;
                         |SI aLetra =  "ENTRANDO";
                              aLetra = aAscii % 2002;
                              |SI aLetra = "MO";
                                  || aAlfa = aAscii - "-----> ENTRANDO EN MODIFICACION DE :[";
                                  || aAlfa = aAscii - "-----> ENTRANDO EN MODIFICACION (Consulta) DE :[";
                                   |PARA nParaI = 1; |SI nParaI [ nLongi; |HACIENDO nParaI = nParaI + 1;
                                        nK = (nParaI * 100) + 1;
                                        aAlfa2 = aAscii % nK;
                                        |SI aAlfa2 = "[";
                                             |SAL;
                                        |FINSI;
                                   |SIGUE;

                                   |PARA nI = 1; |SI nI [ nLongi ; |HACIENDO nI = nI +1;
                                        nJ = (nI * 100) + 1;
                                        aAlfa2 = aAscii % nJ;
                                        |SI aAlfa2 = "]";
                                             |SAL;
                                        |FINSI;
                                   |SIGUE;
                                   nK =(nParaI + 1) *  100 + (nI - nParaI - 1);
                                   aTabDef = aAscii % nK;

                                   nJ = (300 + (nLongi - nI - 4)) * (-1)
                                   aAlfa = aAscii % nJ;

                                   aTitul = aAlfa;
                                   aTipo = "D";
                                   nAcc = 13;
                                   |HAZ Graba;
                              |FINSI;
                              |SI aLetra = "AL";
                                   aAlfa = aAscii - "-----> ENTRANDO EN ALTA DE :[";
                                   aAlfa2 = aAlfa % 108;

                                   aTabDef = aAlfa2;

                                   aAlfa2 = aAlfa - aAlfa2;
                                   aAlfa = aAlfa2 - "],[" -"]";

                                   aTitul = aAlfa;
                                   aTipo = "D";
                                   nAcc = 11;
                                   |HAZ Graba;

                              |FINSI;
                              |SI aLetra = "BA";
                                   aAlfa = aAscii - "-----> ENTRANDO EN BAJA DE :[";
                                   aAlfa2 = aAlfa % 108;
                                   aAlfa2 = aAlfa - aAlfa2;
                                   aAlfa = aAlfa2 - "],[" -"]";

                                   aTabDef = aAlfa2;
                                   aTitul = aAlfa;
                                   aTipo = "D";
                                   nAcc = 12;
                                   |HAZ Graba;

                              |FINSI;
                         |FINSI;
                         |SI aLetra =  "SALIENDO";
                              aLetra = aAscii % 2002;
                              |SI aLetra = "MO";
                                   ||aAlfa = aAscii - "-----> SALIENDO DE MODIFICACION DE :[";
                                   ||aAlfa = aAscii - "-----> SALIENDO DE MODIFICACION (Consulta) DE :[";
                                   |PARA nParaI = 1; |SI nParaI [ nLongi; |HACIENDO nParaI = nParaI + 1;
                                        nK = (nParaI * 100) + 1;
                                        aAlfa2 = aAscii % nK;
                                        |SI aAlfa2 = "[";
                                             |SAL;
                                        |FINSI;
                                   |SIGUE;

                                   |PARA nI = 1; |SI nI [ nLongi ; |HACIENDO nI = nI +1;
                                        nJ = (nI * 100) + 1;
                                        aAlfa2 = aAscii % nJ;
                                        |SI aAlfa2 = "]";
                                             |SAL;
                                        |FINSI;
                                   |SIGUE;
                                   nK =(nParaI + 1) *  100 + (nI - nParaI - 1);
                                   aTabDef = aAscii % nK;

                                   nJ = (300 + (nLongi - nI - 4)) * (-1)
                                   aAlfa = aAscii % nJ;




                                   aTitul = aAlfa;
                                   aTipo = "D";
                                   nAcc = 23;
                                   |HAZ Graba;

                              |FINSI;
                              |SI aLetra = "AL";
                                   aAlfa = aAscii - "-----> SALIENDO DE ALTA DE :[";
                                   aAlfa2 = aAlfa % 108;

                                   aTabDef = aAlfa2;

                                   aAlfa2 = aAlfa - aAlfa2;
                                   aAlfa = aAlfa2 - "],[" -"]";

                                   aTitul = aAlfa;
                                   aTipo = "D";
                                   nAcc = 21;
                                   |HAZ Graba;

                              |FINSI;
                              |SI aLetra = "BA";
                                   aAlfa = aAscii - "-----> SALIENDO DE BAJA DE :[";
                                   aAlfa2 = aAlfa % 108;
                                   aAlfa2 = aAlfa - aAlfa2;
                                   aAlfa = aAlfa2 - "],[" -"]";

                                   aTabDef = aAlfa2;
                                   aTitul = aAlfa;
                                   aTipo = "D";
                                   nAcc = 22;
                                   |HAZ Graba;

                              |FINSI;
                         |FINSI;
                    nLin = 0;
                    |FINSI;
                    |SI aLetra = "**";
                         aAlfa = aAscii % 1108;
                         aAlfa2 = aAscii % 1804;

                         |SI aAlfa = "ENTRANDO";
                              aAlfa = aAscii % 3112;   ||nombre del tab

                              aTabDef = aAlfa;

                              aLetra = "********* ENTRANDO EN EL TAB:[" + aAlfa +"],[";
                              aAlfa = aAscii - aLetra; |QBF aAlfa;
                              aAlfa = aAlfa - "]";     ||titulo del tab
                              nLin = 0;

                              aTitul = aAlfa;
                              aTipo = "T";
                              nAcc = 1;

                              |HAZ Graba;

                         |FINSI;

                         |SI aAlfa = "SALIENDO";
                              aAlfa = aAscii % 2912;   ||nombre del tab

                              aTabDef = aAlfa;

                              aLetra = "********* SALIENDO DEL TAB:[" + aAlfa +"],[";
                              aAlfa = aAscii - aLetra; |QBF aAlfa;
                              aAlfa = aAlfa - "]";     ||titulo del tab
                              nLin = 0;

                              aTitul = aAlfa;
                              aTipo = "T";
                              nAcc = 2;

                              |HAZ Graba;
                         |FINSI;

                         |SI aAlfa2 ! "****";
                              aLetra = aAscii % 1802;
                              |SI aLetra = "NO";
                                   ||No se actualiza nada
                                   nAcc = 0;
                                   nLin = 0;
                              |FINSI;
                              |SI aLetra = "SE";
                                   ||Se actualizan x campos
                                   aAlfa = aAscii % 3203;
                                   nLin = 0;
                              |FINSI;
                         |FINSI;
                         |SI aAlfa2 = "****";
                              nLin = 0;
                         |FINSI;
                    |FINSI;

                    |SI aLetra = "Ac";
                         aAscii = aAscii - "Actualizando "; |QBF aAscii;
                         |HAZ SacaTabDef;
                         aTitul = aAscii;
                         aTipo = "C";
                         nAcc = 3;
                    |FINSI;

                    |SI aLetra = "Nu";
                         aAscii = aAscii -"Nueva ficha "; |QBF aAscii;
                         |HAZ SacaTabDef;
                         aTitul = aAscii;
                         aTipo = "R";
                         nAcc = 1;
                    |FINSI;

                    |SI aLetra = "Ba";
                         aAscii = aAscii -"Baja ficha "; |QBF aAscii;
                         |HAZ SacaTabDef;
                         aTitul = aAscii;
                         aTipo = "R";
                         nAcc = 2;
                    |FINSI;

                    |SI aLetra = "Cl";
                         aAscii = aAscii - "Clave :"; |QBF aAscii;

                         aClau = aAscii;
                         |HAZ Graba;
                    |FINSI;

                    |SI aLetra = "CA";
                         ||Estamos en CAMPO
                         aAscii = aAscii -"CAMPO ("; |QBF aAscii;
                         |PARA; |SI FSalida ] 0; |HACIENDO;
                              nI = nI + 1;
                              nJ = nI * 100 + 1;
                              aAlfa = aAscii % nJ;
                              |SI aAlfa = ")";
                                   |SAL;
                              |FINSI;
                         |SIGUE;
                         nK = 100 + nI -1;
                         aAlfa2 = aAscii % nK; ||numero de campo

                         nCampo = aAlfa2;

                         |PARA; |SI FSalida ] 0; |HACIENDO;
                              nX = nX + 1;
                              nJ = nX * 100 + 1;
                              aAlfa = aAscii % nJ;
                              |SI aAlfa = "[";
                                   |SAL;
                              |FINSI;
                         |SIGUE;
                         nK = (nI + 1) * 100 + nX -(nI + 1);
                         aAlfa = aAscii % nK;     ||Nombre del campo

                         |PARA nY = 0; |SI nY [ nLongi; |HACIENDO;
                              nY = nY + 1;
                              nJ = nY * 100 + 1;
                              aAlfa = aAscii % nJ;
                              |SI aAlfa = "]";
                                   |SAL;
                              |FINSI;
                         |SIGUE;
                         nK = (nX + 1) * 100 + nY -(nX + 1);
                         aAlfa = aAscii % nK;     ||valor viejo

                         aVant = aAlfa;

                         nK = (nY + 6) * 100 + nY -(nX + 1);
                         aAlfa = aAscii % nK;     ||Nombre del valor nuevo

                         aVnou = aAlfa;
                         |HAZ Graba;

                    |FINSI;
               |FINSI;
               nLin = nLin + 1;
               ||Borrar las variables auxiliares
               aAscii = "";
               aAlfa = "";
               aAlfa2 = "";
         |FINSI;
     |SIGUE;
     |XCIERRA nCanal;
     |FBORRA aAbre;
|FPRC;

|PROCESO DesactivaLogger;
     aDsini1 = "LOGGER";
     |VALOR_INI aDsini1, aDsini2;
     |SI aDsini2 ! "";
/*          |DBASS aNom;
          aNom = aNom + "ds.ini";
          |XABRE "AB",aNom, nHandle;
          |SI FSalida ] 0;
               |PARA; |SI FSalida ] 0; |HACIENDO;
                    |XLEE nHandle, 1, aChar;
                    |SI FSalida [ 0; |SAL; |FINSI;
                         aAscii = aAscii + aChar;
                         nCodAsc = &aChar;
                         |SI nCodAsc = 10;
                              aAlfa = aAscii % 107;
                              |SI aAlfa = "LOGGER=";
                                   nMod = 1;
                                   |XPOSICION nHandle,nPos,nMod;
                                   aLong = aAscii % 0;
                                   nLong = aLong;
                                   nPos = - nLong;
                                   aAsci2 = ";" + aAscii;
                              |FINSI;
                              aAscii = "";
                         |FINSI;
                    |FINSI;
               |SIGUE;
               |XCIERRA nHandle;
               |XABRE "U",aNom, nHandle;
               |XPOSICION nHandle,nPos,2;
               |XGRABA nHandle, aAsci2;
               |XCIERRA nHandle;*/
          |FINSI;
|FPRC;
/*
|PROCESO DevuelveLogger;
|FPRC;
*/

|PROCESO NuevoExtrae;
     aAbre2 = #99#15; |QBF aAbre2;
     aAbre2 = aAbre2 + eaLogger;

     aAbre = aAbre2 + "_extrayendo";
     |COPIA_FICHERO aAbre2,aAbre;
     |SI FSalida < 0;
          |ACABA;
     |FINSI;
     nLin = 1;
     |XABRE "AB", aAbre, nCanal;
     |PARA; |SI FSalida ] 0; |HACIENDO;
          |XLEE nCanal, 1, aChar;
          |SI FSalida [ 0; |SAL; |FINSI;

          aAscii =aAscii + aChar;
          nCodAsc = &aChar;
          |SI nCodAsc = 10; ||Leemos una fila completa
               aUsr = aAscii % 110;
               aAscii = aAscii - aUsr;  |QBF aUsr;
               aAlfa = aAscii % 108;
               aAscii = aAscii - aAlfa;  |QBF aAlfa;
               aAlfa2 = (aAlfa % -102) + "." + (aAlfa % 502) + "." + (aAlfa % 104);
               fFecha = aAlfa2;
               aAlfa = aAscii % 108;
               aAscii = aAscii - aAlfa;  |QBF aAlfa;
               aHora = aAlfa;
               aAlfa = aAscii % 101;
               aAscii = aAscii - aAlfa;  |QBF aAlfa;
               aTipo = aAlfa;
               aAlfa = aAscii % 102;
               aAscii = aAscii - aAlfa;  |QBF aAlfa;
               nAcc = aAlfa;
               aAlfa = aAscii % 112;
               aAscii = aAscii - aAlfa;  |QBF aAlfa;
               aTabDef = aAlfa;
               aAlfa = aAscii % 103;
               aAscii = aAscii - aAlfa;  |QBF aAlfa;
               nCampo = aAlfa;
               aAlfa = aAscii % 150;
               aAscii = aAscii - aAlfa;  |QBF aAlfa;
               aClau = aAlfa;
               aAlfa = aAscii % 117;
               aAscii = aAscii - aAlfa;  |QBF aAlfa;
               aMac = aAlfa;
               aAlfa = aAscii % 110;
               aAscii = aAscii - aAlfa;  |QBF aAlfa;
               aEmpresa = aAlfa;
               aAlfa = aAscii % 150;
               aAscii = aAscii - aAlfa;  |QBF aAlfa;
               aTitul = aAlfa;
               aAlfa = aAscii % 130;
               aAscii = aAscii - aAlfa;  |QBF aAlfa;
               aVant = aAlfa;
               aAlfa = aAscii % 130;
               aAscii = aAscii - aAlfa;  |QBF aAlfa;
               aVnou = aAlfa;
               aAscii = "";
               |SI aUsr ! ""; |Y aTipo ! "";
                    |HAZ Graba;
               |FINSI;
               aUsr     = "";
               fFecha   = "";
               aHora    = "";
               aTipo    = "";
               nAcc     = 0;
               aTabDef  = "";
               aTitul   = "";
               nCampo   = 0;
               aVant    = "";
               aVnou    = "";
               aClau    = "";
               aMac     = "";
               aEmpresa = "";
          |FINSI;
     |SIGUE;
     |XCIERRA nCanal;
     |FBORRA aAbre;
|FPRC;


|PROGRAMA;
     |CLS;
     |CABEZA "Extractor de Logger";

     |ABRE #99;
     |LEE 000#99p;
     |CIERRA #99;

     |AVISO;
     |CONFI "2400NAcotar la extraccion?";
     |SI FSalida ! 0;
          nAcot = 0;
     |SINO;
          nAcot = 1;
     |FINSI;
     |PINPA #0#0;
     |SI PRMNT_eExtrae ! "AD";
          |ABRE #0;
          |CIERRA #0;
          |DELINDEX #0;
     |SINO;
          |ABRE #0;
          |LEE 001#0u;
          nCuenta = #0#13;
          |CIERRA #0;
     |FINSI;
     |ABRE #0;
     |SI PRMNT_eVersio = 0;
          |HAZ Extrae;
     |SINO;
          |HAZ NuevoExtrae;
     |FINSI;
     |CIERRA #0;
|FPRO;
