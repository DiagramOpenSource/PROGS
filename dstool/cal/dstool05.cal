|FICHEROS;
     dstool05 #0; || este def
|FIN;

|VARIABLES;
     VERSION = "20080610";    ||Version Python
     VERMENS2 = "0000Es necesario que cierre todas las ventanas DIAGRAM y vuelva a entrar a esta opción.";

     nVersion = 0;
     nHandle = 0;
     aSistema = "";
     aNueva = "";
     aCar = "";
     nPos = 0;
     aLon = "";
     i = 0;
     aBat = "";

     aTextoLabel = "";
     nLabel = 0;
     nPanta = 0;

     {1}aContiene = "";
     {1}aLocal = "";
     aOrg = "";
     aDes = "";
     aAlfa = "";
     aBase = "";
     aIP = "";
     aFicPy = "";
     aMd5Org = "";
     aMd5Des = "";
     aFicTar = "";
     aFnt = "";
     nSwCorta = 0;
     nCheq = 0;

     || para lanzar el cliente python.
     {-1}ivpy = 0;
     visual = "";
     vejecuta = "";
     vargs = "";

     || variables EXTERNAS
     &eaPath = "";
     &eaModulo = "";
|FIN;

|PROCESO Tipo80; |TIPO 80;
     FSalida = 4099;
|FPRC;

|PROCESO CopiaRMD5;
     aContiene = aOrg;
     |ESPECIFICA "MD5", aContiene;
     aMd5Org = FSalida;

     aContiene = aDes;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aMd5Des = FSalida;

     |SI aMd5Org ! aMd5Des;
          |ENVIA_FICHERO aOrg, aDes;
     |FINSI;
|FPRC;

|PROCESO CopiaRMD5_python;
     aContiene = aOrg;
     |ESPECIFICA "MD5", aContiene;
     aMd5Org = FSalida;

     aContiene = aDes;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aMd5Des = FSalida;

     |SI aMd5Des = "";        || no lo tenemos en el puesto
          |SI aMd5Org ! "";   || buscamos si esta en agitool/plugins
               |ENVIA_FICHERO aOrg, aDes;    || y lo traemos
          |SINO;                             || sino se lo bajan
               aAlfa = "0000Debera descargar el http://www.diagram.es/basico/python/python.tgz,  dejarlo en " + aBase + " y volver a entrar.";
               |MENAV aAlfa;
               nSwCorta = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CopiaMD5;
     aContiene = aOrg;
     |ESPECIFICA "MD5", aContiene;
     aMd5Org = FSalida;

     aContiene = aDes;
     |ESPECIFICA "MD5", aContiene;
     aMd5Des = FSalida;

     |SI aMd5Org ! aMd5Des;
          |COPIA_FICHERO aOrg, aDes;
     |FINSI;
|FPRC;

|PROCESO CopiaMD5_python;
     aContiene = aOrg;
     |ESPECIFICA "MD5", aContiene;
     aMd5Org = FSalida;

     aContiene = aDes;
     |ESPECIFICA "MD5", aContiene;
     aMd5Des = FSalida;

     |SI aMd5Des = "";        || no lo tenemos en el puesto
          |SI aMd5Org ! "";   || buscamos si esta en agitool/plugins
               |COPIA_FICHERO aOrg, aDes;    || y lo traemos
          |SINO;                             || sino se lo bajan
               aAlfa = "0000Debera descargar el http://www.diagram.es/basico/python/python.tgz,  dejarlo en " + aBase + " y volver a entrar.";
               |MENAV aAlfa;
               nSwCorta = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CopiaFnt;
     |DBASE aBase;
     aOrg = aBase + "plugins/" + aFnt;

     aIP = "";
     |IP_REMOTO aIP;
     |SI aIP = "";
          |DBASS aBase;
          aAlfa = aBase + "dev/";
          aDes = aAlfa + aFnt;
          |HAZ CopiaMD5;
     |SINO;
          |ESPECIFICA "RBASS", aLocal;
          aBase = aLocal; aAlfa = aBase + "dev/";
          aDes = aAlfa + aFnt;
          |HAZ CopiaRMD5;
     |FINSI;
|FPRC;

|PROCESO CopiaPy;
     |DBASE aBase;
     aOrg = aBase + "plugins/" + aFicPy;

     aIP = "";
     |IP_REMOTO aIP;
     |SI aIP = "";
          |DBASS aBase;
          aAlfa = aBase + "python/";
          aAlfa = aAlfa + "aplicaciones/";
          |MKDIR aAlfa;
          aDes = aAlfa + aFicPy;
          |HAZ CopiaMD5;
     |SINO;
          |ESPECIFICA "RBASS", aLocal;
          aBase = aLocal; aAlfa = aBase + "python/";
          aAlfa = aAlfa + "aplicaciones/";
          |RMKDIR aAlfa;
          aDes = aAlfa + aFicPy;
          |HAZ CopiaRMD5;
     |FINSI;
|FPRC;

|PROCESO CopiaLibPy;
     aFicTar = "python.tgz";

     |DBASE aBase;
     aOrg = aBase + "plugins/" + aFicTar;

     aIP = "";
     |IP_REMOTO aIP;
     |SI aIP = "";
          |DBASS aBase;
          aDes = aBase + aFicTar;
          |HAZ CopiaMD5_python;
          |SI aMd5Org ! aMd5Des;
               |MENSA "0000Descomprimiendo...";
               ||DETAR aDes, aBase;
          |FINSI;
     |SINO;
          |ESPECIFICA "RBASS", aLocal;
          aBase = aLocal; aAlfa = aBase;
          aDes = aAlfa + aFicTar;
          |HAZ CopiaRMD5_python;
          |SI aMd5Org ! aMd5Des;
               |MENSA "0000Descomprimiendo...";
               ||RDETAR aDes, aBase;
          |FINSI;
     |FINSI;
|FPRC;


|PROCESO RBorraDir;
     |HAZ CambiaBarra;
     aAlfa = "RD /S /Q " + aAlfa;

     aBat = "C:\" + Usuario + ".bat";

     |XABRE "CW", aBat, nHandle;
     |XGRABA nHandle, aAlfa;
     |XCIERRA nHandle;

     |RSYSTEM aBat;
     |RFBORRA aBat;
|FPRC;

|PROCESO BorraDir;
     |QUE_SISTEMA aSistema;
     |SI aSistema = "ESDOS";
          |HAZ CambiaBarra;
          aAlfa = "RD /S /Q " + aAlfa;

          aBat = "C:\" + Usuario + ".bat";

          |XABRE "CW", aBat, nHandle;
          |XGRABA nHandle, aAlfa;
          |XCIERRA nHandle;

          |RSYSTEM aBat;
          |RFBORRA aBat;
     |SINO;
          aAlfa = "rm -R " + aAlfa;
          |SYSTEM aAlfa;
     |FINSI;
|FPRC;

|PROCESO CambiaBarra;
     aNueva = "";
     aLon = aAlfa % A0;
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aCar = aAlfa % nPos;
          |SI aCar = "/"; aCar = "\"; |FINSI;
          aNueva = aNueva + aCar;
     |SIGUE;
     aAlfa = aNueva;
|FPRC;

|PROCESO VerServidor;
     |DBASS aBase;
     aAlfa = aBase + "python/python.ver";
     |XABRE "", aAlfa, nHandle;
     |SI FSalida = 0;
          |XLEE nHandle, 250, aAlfa;
          |XCIERRA nHandle;
          nVersion = aAlfa;
     |FINSI;
|FPRC;

|PROCESO VerPuesto;
     |ESPECIFICA "RBASS", aLocal;
     aBase = aLocal; aAlfa = aBase + "python/python.ver";
     |XABRE "C", aAlfa, nHandle;
     |SI FSalida = 0;
          |XLEE nHandle, 250, aAlfa;
          |XCIERRA nHandle;
          nVersion = aAlfa;
     |FINSI;
|FPRC;

|PROCESO CheqDllLocal;
     nCheq = 0;
     aAlfa = aBase + "python/dspython.dll";
     |XABRE "E", aAlfa, nHandle;
     |SI FSalida = -1;
          |MENAV "0000Local preparado para actualizar.";
     |SINO;
          aAlfa = aBase + "python/python.bor";
          |XABRE "W", aAlfa, nHandle;
          aAlfa = "pendiente de borrar";
          |XGRABA nHandle, aAlfa;
          |XCIERRA nHandle;
          |MENAV VERMENS2;
          nCheq = 1;
     |FINSI;
|FPRC;

|PROCESO CheqDllServidor;
     nCheq = 0;
     aAlfa = aBase + "python/dspython.dll";
     |XABRE "CE", aAlfa, nHandle;
     |SI FSalida = -1;
          |MENAV "0000Puesto preparado para actualizar.";
     |SINO;
          aAlfa = aBase + "python/python.bor";
          |XABRE "CW", aAlfa, nHandle;
          aAlfa = "pendiente de borrar";
          |XGRABA nHandle, aAlfa;
          |XCIERRA nHandle;
          |MENAV VERMENS2;
          nCheq = 1;
     |FINSI;
|FPRC;

|PROCESO VerPython;
     nSwCorta = 0;
     aIP = "";
     |IP_REMOTO aIP;
     |SI aIP = "";
          |DBASE aBase;
          aAlfa = aBase + "python/python.bor";
          |XABRE "E", aAlfa, nHandle;
          |SI FSalida ! -1;
               aAlfa = aBase + "python";
               |HAZ BorraDir;
               |HAZ CheqDllLocal;
               |SI nCheq = 0;
                    |MENAV "0000Desinstalación anterior completada.";
               |SINO;
                    FSalida = 1;
                    |ACABA;
               |FINSI;
          |FINSI;

          |HAZ VerServidor;
          FSalida = 0;
          |SI nVersion ] VERSION;  |ACABA;   |FINSI;   || version LOCAL OK

          |SI nVersion ! 0;   || la version cero es que no esta instalado
               aAlfa = aBase + "python";
               |HAZ BorraDir;

               aAlfa = aBase + "agitool/python.tgz";
               |FBORRA aAlfa;

               |HAZ CheqDllLocal;
               |SI nCheq ! 0;
                    FSalida = 1;
                    |ACABA;
               |FINSI;
          |FINSI;
     |SINO;
          |ESPECIFICA "RBASS", aLocal;
          aBase = aLocal; aAlfa = aBase + "python/python.bor";
          |XABRE "CE", aAlfa, nHandle;
          |SI FSalida ! -1;
               aAlfa = aBase + "python";
               |HAZ RBorraDir;
               |HAZ CheqDllServidor;
               |SI nCheq = 0;
                    |MENAV "0000Desinstalación anterior completada.";
               |SINO;
                    FSalida = 1;
                    |ACABA;
               |FINSI;
          |FINSI;

          |HAZ VerPuesto;
          FSalida = 0;
          |SI nVersion ] VERSION;  |ACABA;   |FINSI;   || version PUESTO OK

          |SI nVersion ! 0;   || la version cero es que no esta instalado
               aAlfa = aBase + "python";
               |HAZ RBorraDir;

               aAlfa = aBase + "agitool/python.tgz";
               |RFBORRA aAlfa;

               |HAZ CheqDllServidor;
               |SI nCheq ! 0;
                    FSalida = 1;
                    |ACABA;
               |FINSI;
          |FINSI;

          |HAZ VerServidor;
          |SI nVersion ] VERSION;  |ACABA;   |FINSI;   || version SERVIDOR OK

          |DBASS aBase;
          aAlfa = aBase + "python";
          |HAZ BorraDir;

          aAlfa = aBase + "agitool/python.tgz";
          |FBORRA aAlfa;

          FSalida = 0;
          |MENAV "0000Servidor preparado para actualizar.";
     |FINSI;
|FPRC;

|PROCESO &Cls;      ||Proceso llamado desde python
     |FIN_CONTROL_WINDOWS nLabel;
|FPRC;

|PROGRAMA;
/*
     || el python.tgz
     |HAZ CopiaLibPy;
     |SI nSwCorta = 1;        |ACABA;   |FINSI;
*/
     |HAZ VerPython;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aFnt = "defaultcab.fnt";      |HAZ CopiaFnt;
     aFnt = "defaultclas.fnt";     |HAZ CopiaFnt;
     aFnt = "defaultpie.fnt";      |HAZ CopiaFnt;
     aFnt = "defaultpred.fnt";     |HAZ CopiaFnt;

     || los propios de este programa
     aFicPy = "main.py";           |HAZ CopiaPy;
     aFicPy = "dsbase.pyc";        |HAZ CopiaPy;
     aFicPy = "colores.pyc";       |HAZ CopiaPy;
     aFicPy = "colores_bmp.pyc";   |HAZ CopiaPy;

     |CLS;
     |PINPA #0#0;
     nPanta = FSalida;
     aTextoLabel = "Cargando [" + VERSION + "] ...";
     aTextoLabel = "LABEL,{{005}}" + aTextoLabel;
     |CONTROL_SIMPLE nPanta, aTextoLabel, 0902, 1182, NULL;
     nLabel = FSalida;

     |ESPECIFICA "RBASS", aLocal;
     ||----------------Variables pasadas al .py
     eaPath = aLocal;
     eaModulo = "colores";
     ||----------------Llamada a python
     Iivpy = visual<-;
     visual = "1";     ||Sin frame
     vejecuta = "aplicaciones/main.py";
     |SI PARAMETRO = "CONSOLA";
          vargs = "-i";
     |SINO;
          vargs = "";
     |FINSI;
     |ESPECIFICA "INTERFACE_VISUAL_PYTHON",ivpy;
     |SI PARAMETRO = "CONSOLA";
          |PAUSA;
     |FINSI;
|FPRO;
