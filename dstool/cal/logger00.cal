|FICHEROS;
     logger00  #0;  ||Acota
     logger01  #1;  ||Extrae y muestra datos
     logger03  #3;  ||Fichero de apoyo
     logger04  #4;  ||Filtro de defs
     referen@;
|FIN;

|VARIABLES;
     nHay = 0;
     nSwConsulta = 0;
     aDef = "";
     aDes = "";
     aBase = "";
     aFic = "";
     nPrime = 0;
     aPath = "";
     aPathOrg = "";
     aOrg = "";
     aFecha = "";
     fFecha = @;
     aHora = "";
     nOk = 0;

     aDCampo = "";
     aHCampo = "";
     aDEmpresa = "";
     aHEmpresa = "";
     aDTipo = "";
     aHTipo = "";
     aDAccion = "";
     aHAccion = "";
     &PRMNT_eExtrae = "";
     &PRMNT_eVersio = 0;
     aRestauraIni = "";
     aDsini1 = "";
     aDsini2 = "";

     {-1}menu = "";
     menu1 = "1400";
     menu2 = "2";
     menu3 = "2";
     menu4 = "Conservar ultima extraccion";
     menu5 = "Nueva Extraccion";


     aExtrae = "";

     {-1}men2 = "";
     men21 = "1400";
     men22 = "1";   ||Opcion por defecto
     men23 = "4";   ||Numero de opciones
     men24 = "";
     men25 = "";
     men26 = "";
     men27 = "";
     men28 = "";
     men29 = "";
     men2A = "";
     men2B = "";
     opcdef = 0;
     nTmp = 0;

     fHoy = @;
     aHoy = "";
     aDia = "";
     nDia = 0;
     aMes = "";
     aAnyo = "";
     aNom = "";
     aAbre = "";
     nHandle = 0;

     nActi = 0;
     nPara1 = 0;
     nPosic = 0;
     aAscii = "";
     aLongi = "";
     nLongi = 0;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     nCodAsc = 0;
     aChar = "";

     &eaLogger = "";

     aUsrIni = "";
     aUsrFin = "";
     fFechaIni = @;
     fFechaFin = @;
     aHoraIni = "";
     aHoraFin = "";
     aTipo = "";
     nAcc = 0;
     aTabDefI = "";
     aTabDefF = "";
     nCmpoIni = 0;
     nCmpoFin = 0;
     aClauIni = "";
     aClauFin = "";
     nNuevaVer= 0;
     aDest    = "";
|FIN;

|PROCESO ExcluInf;
     #4#0 = "";
|FPRC;

|PROCESO ExcluSup;
     #4#0 = "zzzzzzzz";
|FPRC;

|PROCESO Excluir; |TIPO 0;
     |SI #0#25 = "S";
          |PUSHV 0501 2215;
          |ENTLINEAL #1#4, 1, 1, 20,1,ExcluInf, ExcluSup;
          |POPV;
     |FINSI;
|FPRC;

|PROCESO Tipo0; |TIPO 0;
     |MENUG menu;
/*
     |SI FSalida = 3; |O FSalida = 4;
          nNuevaVer = 1;
     |FINSI;
     |SI FSalida = 1; |O FSalida = 3;
          aExtrae = "SI";
          |C_M #0#15, 1, "S";
          |C_M #0#20, 1, "S";
          |C_V #0#15, 1, "S";
          |C_V #0#20, 1, "S";
     |FINSI;
     |SI FSalida = 2; |O FSalida = 4;
          aExtrae = "AD";
          |C_M #0#15, 1, "S";
          |C_M #0#20, 1, "S";
          |C_V #0#15, 1, "S";
          |C_V #0#20, 1, "S";
     |FINSI;
*/
     |SI FSalida = 1;
          aExtrae = "NO";
          |C_M #0#15, 1, "N";
          |C_M #0#20, 1, "N";
          |C_V #0#15, 1, "N";
          |C_V #0#20, 1, "N";
     |FINSI;
     PRMNT_eExtrae = aExtrae;
     PRMNT_eVersio = nNuevaVer;
     |SI FSalida = 2;
          aExtrae = "Nw";
     |FINSI;
|FPRC;


|PROCESO Tipo7; |TIPO 7;

     ||Es para poner dinamicamente un cmapo como no modificable

     |SI #0#6 = "*";
          |C_M #0#10, 1, "S";
          |C_M #0#11, 1, "S";
          |C_M #0#12, 1, "S";
          |C_M #0#13, 1, "S";
          |C_M #0#23, 1, "S";
          |C_M #0#24, 1, "S";
          |C_V #0#10, 1, "S";
          |C_V #0#11, 1, "S";
          |C_V #0#12, 1, "S";
          |C_V #0#13, 1, "S";
          |C_V #0#23, 1, "S";
          |C_V #0#24, 1, "S";

          men22 = 1;
          men23 = 1;
          men24 = "Todas las Acciones";
          |MENUG men2;
     |FINSI;
     |SI #0#6 = "T";
          #0#10 = 000;
          #0#11 = 999;
          #0#12 = "";
          #0#13 = "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
          |C_M #0#10, 1, "N";
          |C_M #0#11, 1, "N";
          |C_M #0#12, 1, "N";
          |C_M #0#13, 1, "N";
          |C_M #0#23, 1, "N";
          |C_M #0#24, 1, "N";
          |C_V #0#10, 1, "N";
          |C_V #0#11, 1, "N";
          |C_V #0#12, 1, "N";
          |C_V #0#13, 1, "N";
          |C_V #0#23, 1, "N";
          |C_V #0#24, 1, "N";

          |SI opcdef [ 2;
               men22 = opcdef;
          |SINO;
               opcdef = 1;
               men22 = opcdef;
          |FINSI;
          men23 = 2; ||Numero de opciones
          men24 = "Entrando en el TAB";
          men25 = "Saliendo del TAB";
          |MENUG men2;
          |SI FSalida = 1;
               #0#7 = 1;
          |FINSI;
          |SI FSalida = 2;
               #0#7 = 2;
          |FINSI;
     |FINSI;
     |SI #0#6 = "D";
          #0#10 = 000;
          #0#11 = 999;
          #0#12 = "";
          #0#13 = "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"

          |C_M #0#10, 1, "N";
          |C_M #0#11, 1, "N";
          |C_M #0#12, 1, "N";
          |C_M #0#13, 1, "N";
          |C_M #0#23, 1, "N";
          |C_M #0#24, 1, "N";
          |C_V #0#10, 1, "N";
          |C_V #0#11, 1, "N";
          |C_V #0#12, 1, "N";
          |C_V #0#13, 1, "N";
          |C_V #0#23, 1, "N";
          |C_V #0#24, 1, "N";

          |SI opcdef ] 11;|Y opcdef [ 23;
               |SI opcdef [ 13;
                    nTmp = opcdef - 10;
                    men22 = nTmp;
               |FINSI;
               |SI opcdef ] 21;
                    nTmp = opcdef - 17;
                    men22 = nTmp;
               |FINSI;
          |SINO;
               opcdef = 1;
               men22 = opcdef;
          |FINSI;
          men23 = 8; ||Numero de opciones
          men24 = "Entrando en el DEF modo ALTA";
          men25 = "Entrando en el DEF modo BAJA";
          men26 = "Entrando en el DEF modo MODIF";
          men27 = "Entrando en el DEF modo IMPRIMIR";
          men28 = "Saliendo del DEF modo ALTA";
          men29 = "Saliendo del DEF modo BAJA";
          men2A = "Saliendo del DEF modo MODIF";
          men2B = "Saliendo del DEF modo IMPRIMIR";
          |MENUG men2;
          |SI FSalida = 1;
               #0#7 = 11;
          |FINSI;
          |SI FSalida = 2;
               #0#7 = 12;
          |FINSI;
          |SI FSalida = 3;
               #0#7 = 13;
          |FINSI;
          |SI FSalida = 4;
               #0#7 = 21;
          |FINSI;
          |SI FSalida = 5;
               #0#7 = 22;
          |FINSI;
          |SI FSalida = 6;
               #0#7 = 23;
          |FINSI;
     |FINSI;
     |SI #0#6 = "R";
          #0#10 = 000;
          #0#11 = 999;

          |C_M #0#10, 1, "N";
          |C_M #0#11, 1, "N";
          |C_M #0#12, 1, "S";
          |C_M #0#13, 1, "S";
          |C_M #0#23, 1, "S";
          |C_M #0#24, 1, "S";
          |C_V #0#10, 1, "N";
          |C_V #0#11, 1, "N";
          |C_V #0#12, 1, "S";
          |C_V #0#13, 1, "S";
          |C_V #0#23, 1, "S";
          |C_V #0#24, 1, "S";

          |SI opcdef [ 2;
               men22 = opcdef;
          |SINO;
               opcdef = 1;
               men22 = opcdef;
          |FINSI;
          men23 = 4; ||Numero de opciones
          men24 = "Nueva ficha";
          men25 = "Baja ficha";
          men26 = "Modificando registro";
          men27 = "Todas las acciones de registro";
          |MENUG men2;
          |SI FSalida = 1;
               #0#7 = 31;
          |FINSI;
          |SI FSalida = 2;
               #0#7 = 32;
          |FINSI;
          |SI FSalida = 3;
               #0#7 = 33;
          |FINSI;
          |SI FSalida = 4;
               #0#7 = 99;
          |FINSI;
     |FINSI;
     |SI #0#6 = "C";
          |C_M #0#10, 1, "S";
          |C_M #0#11, 1, "S";
          |C_M #0#12, 1, "S";
          |C_M #0#13, 1, "S";
          |C_M #0#23, 1, "S";
          |C_M #0#24, 1, "S";
          |C_V #0#10, 1, "S";
          |C_V #0#11, 1, "S";
          |C_V #0#12, 1, "S";
          |C_V #0#13, 1, "S";
          |C_V #0#23, 1, "S";
          |C_V #0#24, 1, "S";

          men22 = 1;
          men23 = 1; ||Numero de opciones
          men24 = "Actualizando Campo";
          |MENUG men2;
          |SI FSalida = 1;
               #0#7 = 34;
          |FINSI;
     |FINSI;
     opcdef = #0#7;      ||Guardamos en esta variable la opcion que se ha elegido
     |PINPA #0#0;
     |PINDA #0#0;
|FPRC;

|PROCESO logger01;
     |PRINT;
|FPRC;

|PROCESO logger03;
     nHay = 0;
     |SI #0#25 = "S";
          #4#0 = #3#5;
          |LEE 000#4=;
          |SI FSalida ! 0;
               nHay = 1;
          |FINSI;
     |SINO;
          nHay = 1;
     |FINSI;
     |SI nHay = 0; |ACABA; |FINSI;

     |SI nSwConsulta = 0;
          |PRINT;
     |SINO;
          |SALVA_DATOS #3;
          |REPON_DATOS #referen@;
          |GRABA 020#referen@.n;
     |FINSI;
|FPRC;

|DEFBUCLE logger01;
     #1#1;
     ;
     000000000001,#0#0,#0#2,#0#4,#0#6,#0#7,#0#8,#0#10,#0#12,#0#21,#0#23;
     999999999999,#0#1,#0#3,#0#5,#0#6,#0#7,#0#9,#0#11,#0#13,#0#22,#0#24;
     ;
     NULL, logger01;
|FIN;

|DEFBUCLE logger02;
     #1#1;
     ;
     000000000001,#0#0,#0#2,#0#4," ",00,#0#8,#0#10,#0#12,#0#21,#0#23;
     999999999999,#0#1,#0#3,#0#5,"z",99,#0#9,#0#11,#0#13,#0#22,#0#24;
     ;
     NULL, logger01;
|FIN;

|PROCESO Inicio3;
     |SI nActi = 1;
          aDsini1 = "LOGGER";
          |VALOR_INI aDsini1,aDsini2;
          aRestauraIni = aDsini2;

          aDsini2 = #0#15; |QBF aDsini2;
          aDsini2 = aDsini2 + "logger2.spo";
          aDsini1 = aDsini1 + "=" + aDsini2;
          |VALOR_INI aDsini1,aDsini2;
     |FINSI;
|FPRC;

|PROCESO Final3;
     |SI nActi = 1;
          aDsini2 = aRestauraIni;
          aDsini1 = "LOGGER="+ aDsini2;
          |VALOR_INI aDsini1,aDsini2;

          aDsini2 = #0#15; |QBF aDsini2;
          aDsini2 = aDsini2 + "logger2.spo";
          |FBORRA aDsini2;
          aDsini2 = aDsini2 + ".dat";
          |FBORRA aDsini2;
     |FINSI;
|FPRC;

|DEFBUCLE logger03;
     #3#1;
     ;
     #0#0,#0#2,#0#4,aDTipo,aDAccion,#0#8,aDCampo,#0#12,#0#21,aDEmpresa;
     #0#1,#0#3,#0#5,aHTipo,aHAccion,#0#9,aHCampo,#0#13,#0#22,aHEmpresa;
     ;
     Inicio3, logger03, NULL, NULL, Final3;
|FIN;

|PROCESO Imprime;
     |SI #0#6 = "*";
          aDTipo = ""
          aHTipo = "z";
          aDAccion = "00";
          aHAccion = "99";
     |SINO;
          aDTipo = #0#6;
          aHTipo = #0#6;
          aDAccion = #0#7;
          aHAccion = #0#7;
     |FINSI;
     |SI #0#7 = 99;
          aDAccion = "";
          aHAccion = "zz";
     |FINSI;
     aDCampo = ("000" + #0#10) % -103;
     aHCampo = ("000" + #0#11) % -103;
     aDEmpresa = #0#23;
     aHEmpresa = #0#24;

     |SI #0#19 = "I";
          Impresora = "Crystal Reports";
          |IMPRE 0;
          |SI FSalida = 0;
               |SI Impresora ! "CrystalReport";   ||Revisar este punto
                    |MENAV "0000Informe recomendado para impresora CrystalReports.";
                    |MENAV "0000Para ello debera instalar http://www.diagram.es/ geconet/DSCrystal_X.msi ";
               |FINSI;
               |INFOR "logger03";
               ||INFOR "logger01";
               |SI FSalida = 0;
                    |ABRE #4;
                    nSwConsulta = 0; |BUCLE logger03;
                    |CIERRA #4;
/*
                         |SI #0#6 = "*";
                              |BUCLE logger02;
                         |SINO;
                              |BUCLE logger01;
                         |FINSI;
*/
                    |PIEINF;
                    |FININF;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #0#19 = "G";
     /*
          |ABRE #1;
          |CONSULTA_CLAVE #1#1;
          |CIERRA #1;
      */
          |DDEF aDef;
          aDef = aDef + "logger03";
          |CARGA_DEF aDef, referen@;
          |SI FSalida = 0;
               aAlfa = "lg" + Usuario;
               |NOME_DAT #referen@#aAlfa#;
               |ABRE #referen@;
               |ABRE #4;
               nSwConsulta = 1; |BUCLE logger03;
               |CIERRA #4;
               |LEE 000#referen@.p;
               |CONSULTA_CLAVE #1#referen@;
               |CIERRA #referen@;
               |DELINDEX #referen@;
               |DESCARGA_DEF #referen@;
          |FINSI;
     |FINSI;
|FPRC;

|PROGRAMA;
     |CLS;
     |CABEZA "Auditoria";
     |PINPA #0#0;
     |ABRE #0;
     |LEE 101#0p;
     |SI FSalida ! 0;  |GRABA 020#0b;  |FINSI;

/*     fHoy = ~;
     nDia = fHoy;
     nDia = nDia - 1;
     fHoy = nDia;

     aHoy = fHoy;
     aMes = aHoy % 402;
     aAnyo = aHoy % 704;
     aDia = aHoy % 102;

     aNom = aAnyo + "_" + aMes + "_" + aDia + ".gz";
     #0#20 = aNom;
*/

     |DBASS aNom;
     aNom = aNom + "ds.ini";
     |XABRE "AB",aNom, nHandle;
     |SI FSalida ] 0;
          |PARA; |SI FSalida ] 0; |HACIENDO;
          |XLEE nHandle, 1, aChar;
          |SI FSalida [ 0; |SAL; |FINSI;
               aAscii = aAscii + aChar;
               nCodAsc = &aChar;
               |SI nCodAsc = 10;
                    aAlfa = aAscii % 107;

                    |SI aAlfa = "LOGGER=";
                         ||Esta activado
                         nActi = 1;

                         aLongi = aAscii % 0;
                         nLongi = aLongi;

                         aAlfa2 = aAscii - "LOGGER=";
                         |PARA nPara1 = nLongi; |SI nPara1 ] 1; |HACIENDO nPara1 = nPara1 - 1;
                              nPosic = (nPara1 * 100) + 1;
                              aAlfa = aAscii % nPosic;
                              |SI aAlfa = "/";|O aAlfa = "\";
                                   aAlfa1 = aAlfa1 - &13 - &10;
                                   #0#20 = aAlfa1;
                                   |SAL;
                              |SINO;
                                   aAlfa1 = aAlfa + aAlfa1;
                              |FINSI;
                         |SIGUE;
                         aAlfa2 = aAlfa2 - aAlfa1 - &13 - &10;
                         #0#15 = aAlfa2;
                    |FINSI;
                    aAscii = "";
               |FINSI;
          |SIGUE;
     |FINSI;
     |SI nActi = 0;
          |AVISO;
          |CONFI "0000N'LOGGER' no activado en 'ds.ini'. Dejar activado?";
          |SI FSalida = 0;
               ||Activar el logger.
               |DBASS aNom;
               #0#15 = aNom + "logger/";
               aAlfa = #0#15; |QBF aAlfa;
               |MKDIR aAlfa;
               #0#20 = "logger.spo";
               aAlfa = "LOGGER=" + aNom + "logger/logger.spo" + &13 + &10;
               |XGRABA nHandle, aAlfa;
               |MENAV "0000Se activara en las ventanas de DIAGRAM nuevas.";
          |FINSI;
     |FINSI;
     |XCIERRA nHandle;

     |PINDA #0#0;

     |ENDATOS #1#0;
     |SI FSalida = 0;
          |GRABA 020#0a;
          |HAZ Auto;
          |SI aExtrae = "";
               |HAZ Tipo0;
          |FINSI;
          |SI aExtrae = "SI"; |O aExtrae = "AD";
               aAbre = #0#15;          |QBF aAbre;
               aAbre = aAbre + #0#20;  |QBF aAbre;
               |XABRE "E",aAbre,nHandle;
               |SI FSalida ] 0;
                    aNom = #0#20;
                    |QBF aNom;
                    aAscii = aNom % -103;
                    |SI aAscii = ".gz";
                         aNom = #0#20 - ".gz";
                         |DESCOMPRIME aAbre;
                    |FINSI;
                    eaLogger = aNom;

                  |SI nActi = 1;
                    aDsini1 = "LOGGER";
                    |VALOR_INI aDsini1,aDsini2;
                    aRestauraIni = aDsini2;

                    aDsini2 = #0#15; |QBF aDsini2;
                    aDsini2 = aDsini2 + "logger2.spo";
                    aDsini1 = aDsini1 + "=" + aDsini2;
                    |VALOR_INI aDsini1,aDsini2;
                  |FINSI;

                    |SUB_EJECUTA "logger01";

                  |SI nActi = 1;
                    aDsini2 = aRestauraIni;
                    aDsini1 = "LOGGER="+ aDsini2;
                    |VALOR_INI aDsini1,aDsini2;

                    aDsini2 = #0#15; |QBF aDsini2;
                    aDsini2 = aDsini2 + "logger2.spo";
                    |FBORRA aDsini2;
                    aDsini2 = aDsini2 + ".dat";
                    |FBORRA aDsini2;
                  |FINSI;

                    |HAZ Imprime;
               |SINO;
                    aAlfa1 = "0000[" + aAbre + "] inaccesible.";
                    |AVISO;
                    |MENAV aAlfa1;
               |FINSI;
          |FINSI;
          |SI aExtrae = "NO";
               |HAZ Imprime;
          |FINSI;
          |SI aExtrae = "Nw";
               |DBASE aAlfa;
               aAbre = #0#15;          |QBF aAbre;
               aAbre = aAbre + #0#20;  |QBF aAbre;
               |XABRE "E",aAbre,nHandle;
               |SI FSalida ] 0;
                    |DFICE aDest;
                    aDest = aDest + "logger03.dat";
                    ||DELINDEX #3;
                    |COPIA_FICHERO aAbre, aDest;
                    |ABRE #3;
                    |HAZ Imprime;
                    |CIERRA #3;
               |FINSI;
          |FINSI;
          |SI #0#26 = "A";
               aDes = #0#15; |QBF aDes;
               aDes = aDes + "/" + #0#20; |QBF aDes;
               |FBORRA aDes;
          |FINSI;
     |FINSI;
     |CIERRA #0;
|FPRO;
=========================================
|PROCESO Descomprime;
     aDes = aBase + "spool/ficlog.gz";
     |COPIA_FICHERO aFic, aDes;
     |DESCOMPRIME aDes;
     |FBORRA aDes;
     aFic = aDes - ".gz";
     aDes = aBase + "spool/ficlog.dat";
     |RENOMBRA_FICHERO aFic, aDes;
|FPRC;

|PROCESO Copia;
     aDes = aBase + "spool/ficlog";
     |COPIA_FICHERO aFic, aDes;
     aFic = aDes;
     aDes = aBase + "spool/ficlog.dat";
     |RENOMBRA_FICHERO aFic, aDes;
|FPRC;

|PROCESO Automatico; |TIPO 0;
     |SI #0#26 = "A";
          |C_M #0#20, 1, "N";
     |FINSI;
|FPRC;

|PROCESO Auto;
     |SI #0#26 ! "A"; |ACABA; |FINSI;

     |PUSHV 0501 2480;
     |BLANCO 0919 1667;
     |CUADRO 0919 1667;
     |CUADRO 1020 1566;
     |COLOR 7,4; |ATRI 0; |BLANCO 1021 1465; |ATRI 0;
     |COLOR 4,7; |ATRI 0; |PINTA 1230, "Creando logger.txt"; |ATRI 0;
     nPrime = 0;
     |DBASS aBase;
     #0#20 = "logger.txt";
     aPath = #0#15; |QBF aPath;
     aPathOrg = aPath;
     |_PDIR aPath;
     |PARA; |SI FSalida = 0; |HACIENDO;
          nOk = 0;
          aFic = aPath; |QBF aFic;
          aAlfa = aFic - aPathOrg;
          aFecha = (aAlfa % 1602) + "." + (aAlfa % 1902) + "." + (aAlfa % 2204);
          fFecha = aFecha;
          aHora =  (aAlfa % 2702) + ":" + (aAlfa % 3002) + ":" + (aAlfa % 3302);
          |SI fFecha ] #0#2; |Y fFecha [ #0#3;
               |SI aHora ] #0#4; |Y aHora [ #0#5;
                    nOk = 1;
               |FINSI;
          |FINSI;
          |SI aAlfa = "logger.txt";  nOk = 0; |FINSI;
          |SI aAlfa = "logger.spo.dat"; nOk = 1; |FINSI;
          aAlfa = aFic % -103;
          |SI aAlfa ! "tar"; |Y nOk = 1;
               |BLIN 24; |PINTA 2402, aFic;
               |SI aAlfa = ".gz";
                    |HAZ Descomprime;
               |SINO;
                    |HAZ Copia;
               |FINSI;
               aOrg = aDes;
               aDes = #0#15; |QBF aDes;
               aDes = aDes + "/" + #0#20; |QBF aDes;
               |SI nPrime = 0;
                    nPrime = 1;
                    |COPIA_FICHERO aOrg, aDes;
               |SINO;
                    |AFEGIR_FICHERO aOrg, aDes;
               |FINSI;
               |FBORRA aOrg;
          |FINSI;
          |_SDIR aPath;
     |SIGUE;
     |POPV;
|FPRC;
