||dsactua2.    Instalacion de aplicaciones de forma remota

||el formato esta al final de este programa. listapaq.txt

||Realiza llamadas a dsactual

|FICHEROS;
     :/agitool/def/dsactua2 #0;
     :/agitool/def/agiparam #100;      ||Parametros Configuracion  (para Proxy)
|FIN;

|VARIABLES;
     aReturnDos = "";
     aAlfa = "";
     aDirFtp = "";
     aPathPlugins = "";
     aBase = "";
     aOrigen = "";
     aDestino = "";
     aIPRemoto = "";
     aSistema = "";
     {1}aContiene = "";
     aDocRemoto = "";
     aDocServidor = "";

     aIP = "";
     aPuerto = "";
     aDirRecoge = "";
     aAbre = "";

     aParametro = "";
     aAlfa1 = "";
     aMensaje = "";
     aNomBat = "";
     aAplica = "";
     aPar2 = "";
     aPathDswget = "";
     aDirBase = "";
     aTmp = "";
     nHandle = 0;
     aUsu = "";
     aPw = "";
     aR = "";
     aA = "";
     aY = "";
     aB = "";
     aX = "";
     aL = "";
     aG = "";
     aJ = "";
     aS = "";
     aListaPaq = "";
     aPathLista = "";
     aLinea = "";
     aAlfa2 = "";
     nNume1 = 0;
     aLogWget = "";
     aCaracter = "";
     aMenu = "";
     nParte = 0;
     aCheck = "";
     aLong = "";
     nLong = 0;
     aSubCadena = "";
     nSubCadena = 0;
     nContador = 0;
     nLinea = 0;
     nSwF3 = 0;
     aPrograma = "";
     aPathLocal = "";
     aFichero = "";
|FIN;

|PROGRAMA;
     |CLS;
     |PINPA #0#dsactua2;
     |DELINDEX #dsactua2;
     |ABRE #dsactua2;
     aListaPaq = "listapaq.txt";
     aNomBat = "xdswget.bat";
     aL = "n";
     aJ = "a";
     aX = "c";
     aS = "u";
     aB = "2";
     aG = "1";
     aR = "j";
     aA = "l";
     aY = "a";
     aPw = aG + aB + aG + aJ;
     aUsu = aR + aS + aY + aL;
     aPw = aPw + aA + aX + aG + aB;

     |ABRE #agiparam;
     |DDEFECTO #agiparam;
     |LEE 000#agiparam.p;
     |CIERRA #agiparam;


     |DBASS aPathDswget;
     |QBF aPathDswget;

     ||EN CLIENTE
     ||aPathDswget = aPathDswget + "agitool";
     ||EN DESARROLLO
     aPathDswget = aPathDswget + "agitool";

     aPathLocal = "/dsupdate/";
     |RMKDIR aPathLocal;

     ||DIRECTORIO aDirBase;
     ||QBF aDirBase;
     ||aTmp = aDirBase + "tmp2";
     ||MKDIR aTmp;
     aTmp = aPathLocal + "tmp2";
     |RMKDIR aTmp;

     ||ARA
     aPathDswget = aPathLocal;
     aLogWget = aTmp + "/dswget.log";
     aPathLista = aTmp + "/" + aListaPaq;


     |QUE_SISTEMA aSistema;
     |QBF aSistema;

     ||ARA. TODO CCC. QUITAR
     ||aSistema = "ESDOS";

     |SI aSistema = "ESUNIX"; |O #agiparam#7 = "S";
          aFichero = "dswcopia";
          aOrigen = aPathDswget + "/" + aFichero;
          aDestino = aPathLocal + aFichero;
          aIPRemoto = "";
          |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
          |SI aIPRemoto ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;

          aFichero = "dswcopia.bat";
          aOrigen = aPathDswget + "/" + aFichero;
          aDestino = aPathLocal + aFichero;
          aIPRemoto = "";
          |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
          |SI aIPRemoto ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;

          aFichero = "dswget";
          aOrigen = aPathDswget + "/" + aFichero;
          aDestino = aPathLocal + aFichero;
          |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
          |SI aIPRemoto ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;

          aFichero = "dswget.exe";
          aOrigen = aPathDswget + "/" + aFichero;
          aDestino = aPathLocal + aFichero;
          |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
          |SI aIPRemoto ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;

          aFichero = "dswlista";
          aOrigen = aPathDswget + "/" + aFichero;
          aDestino = aPathLocal + aFichero;
          |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
          |SI aIPRemoto ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;

          aFichero = "dswlista.bat";
          aOrigen = aPathDswget + "/" + aFichero;
          aDestino = aPathLocal + aFichero;
          |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
          |SI aIPRemoto ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;

          aFichero = "dswocupa";
          aOrigen = aPathDswget + "/" + aFichero;
          aDestino = aPathLocal + aFichero;
          |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
          |SI aIPRemoto ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;

          aFichero = "dswocupa.bat";
          aOrigen = aPathDswget + "/" + aFichero;
          aDestino = aPathLocal + aFichero;
          |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
          |SI aIPRemoto ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;

          aAlfa1 = aPathDswget + "/dswlista " + aPathDswget + " " + aTmp + " " + aListaPaq;

          |SI #agiparam#1 = "N";
               aAlfa1 = aAlfa1 + " " + "N";
          |SINO;
               aIP = #agiparam#2;
               |QBF aIP;
               aIP = aIP + "." + #agiparam#3;
               |QBF aIP;
               aIP = aIP + "." + #agiparam#4;
               |QBF aIP;
               aIP = aIP + "." + #agiparam#5;
               aPuerto = #agiparam#6;
               |QBF aPuerto;
               aAlfa1 = aAlfa1 + " " + "S" + " " + aIP + ":" + aPuerto;
          |FINSI;

          |RSYSTEM aAlfa1;
     |SINO;
          |DBASE aBase;
          |QBF aBase;
          aPathPlugins = aBase + "plugins/";

          aReturnDos = &13 + &10;       ||Return en maquina Local. Siempre Windows

          aAlfa      = "C:\DOCUMENTOS";                     |RMKDIR aAlfa;
          aAlfa      = "C:\DOCUMENTOS\AGITOOL";             |RMKDIR aAlfa;
          aDirFtp    = aAlfa;
          aDirRecoge = aAlfa + "\";

          aFichero = "dsftp.exe";
          aOrigen = aPathPlugins + aFichero;
          aDestino = aDirRecoge + aFichero;

          aContiene1 = aOrigen;
          |ESPECIFICA "MD5", aContiene;
          aDocServidor = FSalida;  |QBF aDocServidor;

          aContiene1 = aDestino;
          |ESPECIFICA "REMOTOMD5", aContiene;
          aDocRemoto = FSalida;  |QBF aDocRemoto;

          |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
               aIPRemoto = "";
               |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

               |SI aIPRemoto ! "";
                    |ENVIA_FICHERO aOrigen, aDestino;
               |SINO;
                    |COPIA_FICHERO aOrigen, aDestino;
               |FINSI;
          |FINSI;

          aAbre =  aDirRecoge + "dsftp.bat";
          |XABRE "CWB", aAbre, nHandle;
          |SI FSalida ] 0;
               aAlfa = "@ECHO OFF"                                          + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = ":: crear un archivo temporal llamado script.ftp"    + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = ":: el signo > y >> es para canalizar el texto."     + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = ">"  + aDirRecoge + "script.ftp ECHO agi" + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = ">>" + aDirRecoge + "script.ftp ECHO %1" + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = ">>" + aDirRecoge + "script.ftp ECHO lcd " + aTmp + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = ">>" + aDirRecoge + "script.ftp ECHO bin"            + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = ">>" + aDirRecoge + "script.ftp ECHO cd public_html/clientes/diagram/aplica" + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = ">>" + aDirRecoge + "script.ftp ECHO get listapaq.txt" + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = ">>" + aDirRecoge + "script.ftp ECHO bye"            + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = ":: Usamos el archivo recien creado:"                 + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = aDirRecoge + "dsftp.exe " + aDirRecoge + "script.ftp ftp.diagram.es" + aReturnDos; |XGRABA nHandle, aAlfa;
               aAlfa = ":: sobreescribimos el fichero temporal y lo borramos" + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = "TYPE NUL > " + aDirRecoge + "script.ftp"           + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = "DEL " + aDirRecoge + "script.ftp"                  + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = "GOTO End"                                          + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = ":Ayuda"                                            + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = "ECHO Uso: %0 password"                             + aReturnDos;  |XGRABA nHandle, aAlfa;
               aAlfa = ":End"                                              + aReturnDos;  |XGRABA nHandle, aAlfa;

          |SINO;
               aMensaje = "0000Problemas al crear dsftp.bat para obtener los datos del servidor";
               |MENAV aMensaje;
               |XCIERRA nHandle;
               |ACABA;
          |FINSI;

          |XCIERRA nHandle;

          aAlfa = "cmd " + &34 + "/c " + aDirRecoge + "dsftp.bat mantenerlimpio2009" + &34;
          |RSYSTEM aAlfa;

          |SLEEP 1;
          aAbre = aDirRecoge + "dsftp.bat";
          |RFBORRA aAbre;

          aAbre = aDirRecoge + "DsFtp.log";
          |RFBORRA aAbre;
     |FINSI;

     nLinea = 0;
     nHandle=1;
     |XABRE "C", aPathLista, nHandle;
     |PARA; |SI; |HACIENDO;
          |XLEE nHandle, 250, aLinea;
          |SI FSalida < 0;
               |SAL;
          |SINO;
               ||CARGAR EN EL DEF PARA POSTERIORMENTE SACAR ENTLINEAL
               |HAZ MeteLinea;
          |FINSI;
     |SIGUE;
     |XCIERRA nHandle;
     |CIERRA #dsactua2;
     ||Muestra enlineal
     |HAZ Seleccion;
     |HAZ Pregunta;
     ||Para cada seleccion llamar a dsactual.
|FPRO;

|PROCESO MeteLinea;
     nParte = 0;
     aAplica = "";
     aMenu = "";
     aCheck = "";
     aLong = aLinea % A0;
     aLong = ("00" + aLong) % -102;
     nLong = aLong;
     |PARA nContador = 1; |SI nContador [ nLong; |HACIENDO nContador = nContador + 1;
          aSubCadena = nContador + "01";
          nSubCadena = aSubCadena;
          aCaracter = aLinea % nSubCadena;
          |SI aCaracter ! " "; |Y nParte = 0;
               aAplica = aAplica + aCaracter;
          |SINO;
               |SI aCaracter = " ";
                    nParte = nParte + 1;
               |SINO;
                    |SI nParte = 1;
                         aMenu = aMenu + aCaracter;
                    |SINO;
                         aSubCadena = nContador + aLong;
                         nSubCadena = aSubCadena;
                         aCheck = aLinea % nSubCadena;
                         |SAL;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;

     aAlfa1 =  aAplica;
     |QBF aAlfa1;
     |SI aAlfa1 ! "";
          aAlfa2 =  aMenu;
          |QBF aAlfa2;
          |SI aAlfa2 ! "";
               nLinea = nLinea + 1;
               |DDEFECTO #dsactua2;
               #dsactua2#0 = nLinea;
               |LEE 101#dsactua2.=;
               |SI FSalida ! 0; |GRABA 020#dsactua2.b; |FINSI;
               #dsactua2#1 = aAplica;
               #dsactua2#2 = aMenu;
               #dsactua2#3 = aCheck;
               |GRABA 020#dsactua2.a;
               |LIBERA #dsactua2;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO min;
     #dsactua2#0 = 0;
|FPRC;

|PROCESO max;
     #dsactua2#0 = 999;
|FPRC;

|PROCESO Seleccion;
     |ENTLINEAL #1#dsactua2, -1, 2, 21, 0, min, max;
|FPRC;

|PROCESO dsactua2;
     aAlfa1 = #dsactua2#1;
     |QBF aAlfa1;
     |SI #dsactua2#4 = "S"; |Y aAlfa1 ! "";
          aAlfa2 = #dsactua2#1;
          |QBF aAlfa2;
          aPrograma = "dsactual;" + aAlfa2 + " ";
          aAlfa2 = #dsactua2#2;
          |QBF aAlfa2;
          aPrograma = aPrograma + aAlfa2;
          |SUB_EJECUTA aPrograma;
     |FINSI;
|FPRC;

|DEFBUCLE dsactua2;
 #dsactua2#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL,dsactua2;
|FIN;

|PROCESO Procesar;
     |BUCLE dsactua2;
|FPRC;

|PROCESO HazF3; |TIPO 11;
     |SI FSalida = 11; |O nSwF3 = 1;   ||F3. Anular linea
          nSwF3 = 0;
          |SI #dsactua2#4 = "N";
               #dsactua2#4 = "S";
          |SINO;
               #dsactua2#4 = "N";
          |FINSI;
          |PINTA #dsactua2#4;
          |GRABA 020#dsactua2.a;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Tipo0; |TIPO 0;
     |SI FSalida = 0;
          nSwF3 = 1;
          |HAZ HazF3;
     |SINO;
          nSwF3 = 0;
     |FINSI;
|FPRC;

|PROCESO Pregunta;      ||Consultamos si realizamos la instalacion
     aMensaje = "0000NActualizar los paquetes Seleccionados?";
     |CONFI aMensaje;
     |SI FSalida = 0;
          |HAZ Procesar;
     |FINSI;
|FPRC;


/*

||El formato es el siguiente   listapaq.txt


agitool.tgz agitool
cartera.tgz cartera
comer8.tgz dscomer8
comer9.tgz dscomer9
cont0.tgz agicont
cont1.tgz agicont
cont2.tgz agicont
cont3.tgz agicont
enompatz.tgz enompat
eos.tgz agieos
ereopatz.tgz ereopat
ereoz.tgz ereo
fige.tgz agicli
hotel.tgz hotel
nom1.tgz aginom
nom2.tgz contra
prof.tgz facges
red.tgz agired
rent99.tgz agiren99
rent00.tgz agiren00
rent01.tgz agiren01
rent02.tgz agiren02
rent03.tgz agiren03
rent04.tgz agiren04
scopiasz.tgz dscopias
seguros.tgz seguros
soci.tgz sociedad
star0z.tgz star0
star2z.tgz star2
star36z.tgz star36
star550z.tgz star550
starpatz.tgz starpat
tpv9.tgz dscomer9

*/
