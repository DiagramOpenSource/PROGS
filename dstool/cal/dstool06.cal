|FICHEROS;
     dstool06 #0;
     crontcom@ #100;
|FIN;

|VARIABLES;
     aCreaDir = "";
     nPanta = 0;
     nPos1 = 0;
     nPos2 = 0;
     nBoton = 0;

     aSistema = "";
     nHandle = 0;
     aPathPython = "";
     aParametro = "";
     nSwHay = 0;

     TITULO = "Diagram Update";

     nCampo = 0;
     nNum1 = 0;
     nNum2 = 0;
     aFecha = "";
     aAnyo = "";
     nAnyo = 0;
     aMensaje = "";
     aFechaSys = "";
     fFechaSys = @;
     nAnyoSys = 0;
     aAnyoSys = "";
     aMin = "";
     aHora = "";
     aDia_mes = "";
     aComando = "";
     nCanal = 0;
     aMes = "";
     aDia_Sem = "";
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aAbre = "";
     aDBass = "";
     aDirBass = "";
     nUltima = 0;
     nLinea = 0;
     aFicCron = "";
     aDatos = "";
     aShell = "";
     aHoraIni = "";
     aMinutos = "";
     aCampoDiaSem = "";
     aAux = "";
     aCampoDiaMes = "";
     aCampoMes = "";
     aFechaVez = "";
     aDia = "";
     aCarpeta = "";
|FIN;

|PROCESO GrabSRV;
     ||Grabamos el comentario.
     aAlfa = "#" + #crontcom@#22;  |QBF aAlfa;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nCanal, aAlfa;

     aMin     = #crontcom@#2;    |QBF aMin;
     aHora    = #crontcom@#3;    |QBF aHora;
     aDia_mes = #crontcom@#4;    |QBF aDia_mes;
     aMes     = #crontcom@#5;    |QBF aMes;
     aDia_Sem = #crontcom@#6;    |QBF aDia_Sem;
     aComando = #crontcom@#7;    |QBF aComando;

     |SI #crontcom@#8 = "S";
          aAlfa = aMin + " " + aHora + " " + aDia_mes + " " + aMes + " " + aDia_Sem + " " + aComando + &13 + &10;
     |SINO;
          aAlfa = "#" + aMin + " " + aHora + " " + aDia_mes + " " + aMes + " " + aDia_Sem + " " + aComando + &13 + &10;
     |FINSI;
     |XGRABA nCanal, aAlfa;
|FPRC;

|DEFBUCLE GrabSRV;
     #crontcom@#1002;
     ;
     00, 000;
     00, 999;
     ;
     NULL, GrabSRV;
|FIN;

|PROCESO Graba_SRV;
     |DBASS aAbre;
     aAbre = aAbre + "bin/tareas.srv";
     |XABRE "WB", aAbre, nCanal;
     |DBASS aDBass; |QBF aDBass;
     aAlfa = aDBass + "cron";
     |MKDIR aAlfa;
     |BUCLE GrabSRV;
     |XCIERRA nCanal;
|FPRC;

|PROCESO SacaTiempos;
     aHoraIni = #0#3;
     aHora = aHoraIni % 102;
     aMinutos = aHoraIni % -102;

     |SI #0#2 = "D";
          |SI #0#5 = "S"; |Y #0#6 = "S"; |Y #0#7 = "S"; |Y #0#8 = "S"; |Y #0#9 = "S"; |Y #0#10 = "S"; |Y #0#11 = "S";
               aCampoDiaSem = "*";
          |SINO;
               |SI #0#5 = "S"; |Y #0#6 = "S"; |Y #0#7 = "S"; |Y #0#8 = "S"; |Y #0#9 = "S"; |Y #0#10 = "N"; |Y #0#11 = "N";
                    aCampoDiaSem = "1-5";
               |SINO;
                    |SI #0#5 = "S"; |Y #0#6 = "S"; |Y #0#7 = "S"; |Y #0#8 = "S"; |Y #0#9 = "S"; |Y #0#10 = "S"; |Y #0#11 = "N";
                         aCampoDiaSem = "1-6";
                    |SINO;
                         aAux = "";
                         |SI #0#5 = "S";
                              |SI aAux = "";
                                   aAux = aAux + "1";
                              |SINO;
                                   aAux = aAux + ",1";
                              |FINSI;
                         |FINSI;
                         |SI #0#6 = "S";
                              |SI aAux = "";
                                   aAux = aAux + "2";
                              |SINO;
                                   aAux = aAux + ",2";
                              |FINSI;
                         |FINSI;
                         |SI #0#7 = "S";
                              |SI aAux = "";
                                   aAux = aAux + "3";
                              |SINO;
                                   aAux = aAux + ",3";
                              |FINSI;
                         |FINSI;
                         |SI #0#8 = "S";
                              |SI aAux = "";
                                   aAux = aAux + "4";
                              |SINO;
                                   aAux = aAux + ",4";
                              |FINSI;
                         |FINSI;
                         |SI #0#9 = "S";
                              |SI aAux = "";
                                   aAux = aAux + "5";
                              |SINO;
                                   aAux = aAux + ",5";
                              |FINSI;
                         |FINSI;
                         |SI #0#10 = "S";
                              |SI aAux = "";
                                   aAux = aAux + "6";
                              |SINO;
                                   aAux = aAux + ",6";
                              |FINSI;
                         |FINSI;
                         |SI #0#11 = "S";
                              |SI aAux = "";
                                   aAux = aAux + "7";
                              |SINO;
                                   aAux = aAux + ",7";
                              |FINSI;
                         |FINSI;
                         aCampoDiaSem = aAux;
                    |FINSI;
               |FINSI;
          |FINSI;

          aCampoDiaMes = "*";
          aCampoMes = "*";
     |FINSI;
     |SI #0#2 = "M";
          |SI #0#013 = "S"; |Y #0#014 = "S"; |Y #0#015 = "S"; |Y #0#016 = "S"; |Y #0#017 = "S"; |Y #0#018 = "S"; |Y #0#019 = "S"; |Y #0#020 = "S"; |Y #0#021 = "S"; |Y #0#022 = "S"; |Y #0#023 = "S"; |Y #0#024 = "S";
               aCampoMes = "*";
          |SINO;
               aAux = "";
               |SI #0#013 = "S";
                    |SI aAux = "";
                         aAux = aAux + "1";
                    |SINO;
                         aAux = aAux + ",1";
                    |FINSI;
               |FINSI;
               |SI #0#014 = "S";
                    |SI aAux = "";
                         aAux = aAux + "2";
                    |SINO;
                         aAux = aAux + ",2";
                    |FINSI;
               |FINSI;
               |SI #0#015 = "S";
                    |SI aAux = "";
                         aAux = aAux + "3";
                    |SINO;
                         aAux = aAux + ",3";
                    |FINSI;
               |FINSI;
               |SI #0#016 = "S";
                    |SI aAux = "";
                         aAux = aAux + "4";
                    |SINO;
                         aAux = aAux + ",4";
                    |FINSI;
               |FINSI;
               |SI #0#017 = "S";
                    |SI aAux = "";
                         aAux = aAux + "5";
                    |SINO;
                         aAux = aAux + ",5";
                    |FINSI;
               |FINSI;
               |SI #0#018 = "S";
                    |SI aAux = "";
                         aAux = aAux + "6";
                    |SINO;
                         aAux = aAux + ",6";
                    |FINSI;
               |FINSI;
               |SI #0#019 = "S";
                    |SI aAux = "";
                         aAux = aAux + "7";
                    |SINO;
                         aAux = aAux + ",7";
                    |FINSI;
               |FINSI;
               |SI #0#020 = "S";
                    |SI aAux = "";
                         aAux = aAux + "8";
                    |SINO;
                         aAux = aAux + ",8";
                    |FINSI;
               |FINSI;
               |SI #0#021 = "S";
                    |SI aAux = "";
                         aAux = aAux + "9";
                    |SINO;
                         aAux = aAux + ",9";
                    |FINSI;
               |FINSI;
               |SI #0#022 = "S";
                    |SI aAux = "";
                         aAux = aAux + "10";
                    |SINO;
                         aAux = aAux + ",10";
                    |FINSI;
               |FINSI;
               |SI #0#023 = "S";
                    |SI aAux = "";
                         aAux = aAux + "11";
                    |SINO;
                         aAux = aAux + ",11";
                    |FINSI;
               |FINSI;
               |SI #0#024 = "S";
                    |SI aAux = "";
                         aAux = aAux + "12";
                    |SINO;
                         aAux = aAux + ",12";
                    |FINSI;
               |FINSI;
               aCampoMes = aAux;
          |FINSI;

          |SI #0#12 = 0;
               aCampoDiaMes = "*";
          |SINO;
               aCampoDiaMes = #0#12;
          |FINSI;
          aCampoDiaSem = "*";
     |FINSI;
     |SI #0#2 = "V";
          aFechaVez = #0#25;
          aDia = aFechaVez % 102;
          aMes = aFechaVez % 402;
          aCampoDiaMes = aDia;
          aCampoMes = aMes;
          aCampoDiaSem = "*";
     |FINSI;
|FPRC;

|PROCESO crontcom;
     nUltima = #crontcom@#1;
     aAlfa = #crontcom@#22; |QBF aAlfa;
     aAlfa2 = TITULO;
     |SI aAlfa = aAlfa2;
          nLinea = #crontcom@#1;
     |FINSI;
|FPRC;

|DEFBUCLE crontcom;
     #crontcom@#1002;
     ;
     00, 000;
     00, 999;
     ;
     NULL, crontcom;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     aSistema = "ESDOS";
     |QUE_SISTEMA aSistema;
     |SI aSistema ! "ESDOS";
          aSistema = "ESUNIX";
     |FINSI;

     |SI aSistema = "ESUNIX";
          aPathPython = "/usr/bin/python";
          |XABRE "E", aPathPython, nHandle;
          |SI FSalida ] 0;
               aPathPython = "/usr/bin/python";
          |SINO;
               aPathPython = "/usr/local/bin/python";
               |XABRE "E", aPathPython, nHandle;
               |SI FSalida ] 0;
                    aPathPython = "/usr/local/bin/python";
               |SINO;
                    aPathPython = "";
               |FINSI;
          |FINSI;

          |SI aPathPython = "";
               aMensaje = "0000Modulo <python> inaccesible o inexistente. Consulte con su Administrador";
               |MENAV aMensaje;
               |ACABA;
          |FINSI;
     |SINO;
          |DBASS aDirBass;
          |QBF aDirBass;
          aPathPython = aDirBass + "python";
          aCreaDir = aPathPython + "/tmp/";
          |MKDIR aCreaDir;
     |FINSI;

     |DBASS aDirBass;
     |QBF aDirBass;
     aFicCron = aDirBass + "agitool/def/crontcom";
     |CARGA_DEF aFicCron, crontcom@;
     |SI FSalida ! 0;
          aMensaje = "0000Problemas con el CargaDef " + aFicCron;
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     aDatos = aDirBass + "agitool/fich/";
     |PATH_DAT #crontcom@#aDatos#;

     nLinea = 0;
     |BUCLE crontcom;

     |ABRE #crontcom@;
     |SI nLinea = 0;
          #crontcom@#0 = 0;
          #crontcom@#1 = nUltima + 1;
          |GRABA 020#crontcom@.b;
     |SINO;
          #crontcom@#0 = 0;
          #crontcom@#1 = nLinea;
          |LEE 121#crontcom@.=;
     |FINSI;
     |SI FSalida = 0;
          |DBASS aDBass;
          aAlfa = aDBass % 0;
          nNum1 = aAlfa;
          nNum1 = 100 + nNum1 - 1;
          aCarpeta = aDBass % nNum1;
          |SI aSistema = "ESUNIX";
               |SI aPathPython = "";
                    aPathPython = "python";
               |FINSI;
               aShell = aPathPython + " " + aDBass + "agitool/plugins/dsupdater.py " + aCarpeta + " > /tmp/dsupdater.log 2> /tmp/dsupdater.err";
          |SINO;
               aShell = aPathPython + "/python " + aDBass + "agitool/plugins/dsupdater.py " + aCarpeta + " > " + aPathPython + "/tmp/dsupdater.log 2> " + aPathPython + "/tmp/dsupdater.err";
          |FINSI;

          |HAZ SacaTiempos;

          ||
          #crontcom@#2 = aMinutos;
          #crontcom@#3 = aHora;
          #crontcom@#4 = aCampoDiaMes;
          #crontcom@#5 = aCampoMes;
          #crontcom@#6 = aCampoDiaSem;

          ||
          #crontcom@#7 = aShell;
          #crontcom@#8 = "S";
          #crontcom@#9 = #crontcom@#2;
          #crontcom@#10 = #crontcom@#3;
          #crontcom@#11 = #crontcom@#4;
          #crontcom@#12 = #crontcom@#5;
          #crontcom@#13 = #crontcom@#6;
          #crontcom@#14 = #crontcom@#7;
          #crontcom@#15 = "N";          || Tab
          #crontcom@#22 = TITULO;
          #crontcom@#23 = "N";     || Solo se grabara para DSCOPIAS
          #crontcom@#24 = "S";     || Activar log
          #crontcom@#25 = "S";     || Activar log
          |GRABA 020#crontcom@.a;
          |SI FSalida = 0;
               |HAZ Graba_SRV;
          |FINSI;
     |FINSI;
     |CIERRA #crontcom@;

     |DESCARGA_DEF #crontcom@;
|FPRC;

|PROCESO FechaEsteAnyo;
     |SI #0#2 = "V";
          aFecha = #0#25;
          aAnyo = aFecha % -104;
          nAnyo = aAnyo;

          fFechaSys = ~;
          aFechaSys = fFechaSys;
          aAnyoSys = aFechaSys % -104;
          nAnyoSys = aAnyoSys;

          |SI nAnyo ! nAnyoSys;
               aMensaje = "0000Solo puede programar la ejecucion para el a¤o en curso [" + aAnyoSys + "]";
               |MENAV aMensaje;
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DiaMes; |TIPO 0;
     |SI #0#2 = "M";
          |SI #0#12 < 0; |O #0#12 > 31;
               aMensaje = "0000Dia del Mes incorrecto [" + #0#12 + "].";
               |MENAV aMensaje;
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CheqHora; |TIPO 0;
     nNum1 = (A\(#0#3 % 102)) $ 24;
     nNum2 = (A\(#0#3 %-102)) $ 60;
     #0#3 = (("00" + nNum1) % -102) + ":" + (("00" + nNum2) % -102)
     |PINTA #0#3;
|FPRC;

|PROCESO Seleccion; |TIPO 0;
     |SI #0#2 = "D";
          |C_M #0#5, 1, "S";
          |C_M #0#6, 1, "S";
          |C_M #0#7, 1, "S";
          |C_M #0#8, 1, "S";
          |C_M #0#9, 1, "S";
          |C_M #0#10, 1, "S";
          |C_M #0#11, 1, "S";
          |C_M #0#12, 1, "N";
          |C_M #0#13, 1, "N";
          |C_M #0#14, 1, "N";
          |C_M #0#15, 1, "N";
          |C_M #0#16, 1, "N";
          |C_M #0#17, 1, "N";
          |C_M #0#18, 1, "N";
          |C_M #0#19, 1, "N";
          |C_M #0#20, 1, "N";
          |C_M #0#21, 1, "N";
          |C_M #0#22, 1, "N";
          |C_M #0#23, 1, "N";
          |C_M #0#24, 1, "N";
          |C_M #0#25, 1, "N";
     |FINSI;
     |SI #0#2 = "M";
          |C_M #0#5, 1, "N";
          |C_M #0#6, 1, "N";
          |C_M #0#7, 1, "N";
          |C_M #0#8, 1, "N";
          |C_M #0#9, 1, "N";
          |C_M #0#10, 1, "N";
          |C_M #0#11, 1, "N";
          |C_M #0#12, 1, "S";
          |C_M #0#13, 1, "S";
          |C_M #0#14, 1, "S";
          |C_M #0#15, 1, "S";
          |C_M #0#16, 1, "S";
          |C_M #0#17, 1, "S";
          |C_M #0#18, 1, "S";
          |C_M #0#19, 1, "S";
          |C_M #0#20, 1, "S";
          |C_M #0#21, 1, "S";
          |C_M #0#22, 1, "S";
          |C_M #0#23, 1, "S";
          |C_M #0#24, 1, "S";
          |C_M #0#25, 1, "N";
     |FINSI;
     |SI #0#2 = "V";
          |C_M #0#5, 1, "N";
          |C_M #0#6, 1, "N";
          |C_M #0#7, 1, "N";
          |C_M #0#8, 1, "N";
          |C_M #0#9, 1, "N";
          |C_M #0#10, 1, "N";
          |C_M #0#11, 1, "N";
          |C_M #0#12, 1, "N";
          |C_M #0#13, 1, "N";
          |C_M #0#14, 1, "N";
          |C_M #0#15, 1, "N";
          |C_M #0#16, 1, "N";
          |C_M #0#17, 1, "N";
          |C_M #0#18, 1, "N";
          |C_M #0#19, 1, "N";
          |C_M #0#20, 1, "N";
          |C_M #0#21, 1, "N";
          |C_M #0#22, 1, "N";
          |C_M #0#23, 1, "N";
          |C_M #0#24, 1, "N";
          |C_M #0#25, 1, "S";
     |FINSI;

     |PARA nCampo = 5; |SI nCampo [ 25; |HACIENDO nCampo = nCampo + 1;
          |PINTA #0#nCampo#;
     |SIGUE;
|FPRC;

|PROCESO crontcom_borra;
     aAlfa = #crontcom@#22;
     |QBF aAlfa;
     aAlfa2 = TITULO;
     |SI aAlfa = aAlfa2;
          |BORRA 020#crontcom@.a;
          nSwHay = 1;
     |FINSI;
|FPRC;

|DEFBUCLE crontcom_borra;
     #crontcom@#1002;
     ;
     00, 000;
     00, 999;
     be;
     NULL, crontcom_borra;
|FIN;

|PROCESO BorraProgramacion;
     |DBASS aDirBass;
     |QBF aDirBass;
     aFicCron = aDirBass + "agitool/def/crontcom";
     |CARGA_DEF aFicCron, crontcom@;
     |SI FSalida ! 0;
          aMensaje = "0000Problemas con el CargaDef " + aFicCron;
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     aDatos = aDirBass + "agitool/fich/";
     |PATH_DAT #crontcom@#aDatos#;

     nSwHay = 0;
     |BUCLE crontcom_borra;

     |SI nSwHay = 1;
          |HAZ Graba_SRV;
     |FINSI;

     |DESCARGA_DEF #crontcom@;
|FPRC;

|PROCESO Tipo80; |TIPO 80;
     FSalida = 2799;
|FPRC;

|PROCESO Boton;
     |HAZ BorraProgramacion;

     |PTEC 807;
|FPRC;

|PROGRAMA;
     |CLS;
     |ABRE #0;

     aParametro = PARAMETRO;
     |QBF aParametro;
     |SI aParametro = "";
          |HAZ Seleccion;
          |LEE 101#0p;
          |SI FSalida ! 0; |GRABA 020#0b; |FINSI;
          |PINPA #0#0; nPanta = FSalida;
          |PINDA #0#0;

          nPos1 = 0782; nPos2 = 0895;
          |CONTROL_SIMPLE nPanta, "BOTON,{{199}}Desactivar", nPos1, nPos2, Boton;
          nBoton = FSalida;

          |HAZ Seleccion;
          |ENDATOS #1#0;
          |SI FSalida = 0;
               |GRABA 020#0a;
          |FINSI;
          |LIBERA #0;
     |SINO;
          ||Borrar la programacion.
          |HAZ BorraProgramacion;
     |FINSI;
     |CIERRA #0;
|FPRO;
