|FICHEROS;
     copidat2 #0;
     copidat1 #1;
     referen@;
|FIN;

|VARIABLES;
     aPath = "";
     aAlfa = "";
     aAlfa1 = "";
     nModo = 0;
     aDef = "";
     nNum = 0;
     nCal = 0;
     aClave = "";
     aCamClave = "";
     aLonClave = "";
     nCampo = 0;
     nBtn1 = -1;
     nBtn2 = -1;
     nError = 0;
     nCampos = 0;
     i = 0;
     j = 0;
     nLon = 0;
     aPathFic = "";
     nPos = 0;
     aTar = "";
     a1 = "";
     a2 = "";
     aEmp = "";
     fHoy = @;
     aFic = "";
     aIP = "";
     aLon = "";
     aCar = "";
     aNom = "";
     aDir = "";
     aOrg = "";
     aDes = "";
|FIN;

|PROCESO Restaura;
     nError = 1;
     aAlfa = #0#3; |QBF aAlfa;
     |SI aAlfa ! "";
          |DBASS aPath;
          aPath = aPath + #0#2; |QBF aPath;
          aDef = aPath + "/def/" + #0#3; |QBF aPath;
          aDef = aDef + ".mas";
          |CARGA_DEF aDef, referen@;
          |SI FSalida ! 0;
               |MENAV "0000Error al cargar def empresa...";
          |SINO;
               aAlfa = aPath + "/fich/";
               |PATH_DAT #referen@#aAlfa#;
               |ABRE #referen@;
               aAlfa = "|K000";
               aAlfa = #referen@#aAlfa#;
               aCamClave = aAlfa % -103;
               aAlfa = "|C" + aCamClave + "MAXIMO";
               aAlfa = #referen@#aAlfa#;
               aLonClave = aAlfa % A0;
               nCampo = aCamClave;
               #referen@#nCampo# = #0#4;
               |LEE 000#referen@.=;
               |SI FSalida ! 0;
                    |MENAV "0000No existe empresa...";
               |SINO;
                    nPos = aLonClave;
                    nPos = -1 * (nPos + 100);
                    aEmp = (("0000000" + #0#4) % nPos);
                    aPathFic = aPath + "/fich/" + aEmp + "/";
                    nError = 0;
               |FINSI;
               |CIERRA #referen@;
               |DESCARGA_DEF #referen@;
          |FINSI;
     |SINO;
          |DBASS aPath;
          aPath = aPath + #0#2; |QBF aPath;
          aPathFic = aPath + "/fich/";
          aAlfa = aPathFic;
          |_PDIR aAlfa;
          |SI FSalida ! 0;
               |MENAV "0000No existe o esta vacio el directorio 'fich'";
          |SINO;
               nError = 0;
          |FINSI;
          aEmp = "";
     |FINSI;
     |SI nError = 0;
          nError = 1;
          aIP = "";
          |IP_REMOTO aIP;
          aOrg = #0#5; |QBF aOrg;
          aDes = aPathFic + Usuario + ".gz";
          |SI aIP = "";
               |COPIA_FICHERO aOrg, aDes;
          |SINO;
               |RECIBE_FICHERO aOrg, aDes;
          |FINSI;
          |SI FSalida ! 0;
               |MENAV "0000Error al copiar el fichero origen de la copia...";
          |SINO;
               |DESCOMPRIME aDes;
               |FBORRA aDes;
               aOrg = aPathFic + Usuario;
               |DETAR aOrg, aPathFic;
               |FBORRA aOrg;
               nError = 0;
          |FINSI;
     |FINSI;
     |SI nError = 0;
          |MENAV "0000Copia restaurada...";
     |SINO;
          |MENAV "0000Se ha producido algún error, no se ha restaurado la copia...";
     |FINSI;
|FPRC;

|PROCESO Guarda;
     nError = 1;
     aAlfa = #0#3; |QBF aAlfa;
     |SI aAlfa ! "";
          |DBASS aPath;
          aPath = aPath + #0#2; |QBF aPath;
          aDef = aPath + "/def/" + #0#3; |QBF aPath;
          aDef = aDef + ".mas";
          |CARGA_DEF aDef, referen@;
          |SI FSalida ! 0;
               |MENAV "0000Error al cargar def empresa...";
          |SINO;
               aAlfa = aPath + "/fich/";
               |PATH_DAT #referen@#aAlfa#;
               |ABRE #referen@;
               aAlfa = "|K000";
               aAlfa = #referen@#aAlfa#;
               aCamClave = aAlfa % -103;
               aAlfa = "|C" + aCamClave + "MAXIMO";
               aAlfa = #referen@#aAlfa#;
               aLonClave = aAlfa % A0;
               nCampo = aCamClave;
               #referen@#nCampo# = #0#4;
               |LEE 000#referen@.=;
               |SI FSalida ! 0;
                    |MENAV "0000No existe empresa...";
               |SINO;
                    nPos = aLonClave;
                    nPos = -1 * (nPos + 100);
                    aEmp = (("0000000" + #0#4) % nPos);
                    aPathFic = aPath + "/fich/" + aEmp + "/";
                    nError = 0;
               |FINSI;
               |CIERRA #referen@;
               |DESCARGA_DEF #referen@;
          |FINSI;
     |SINO;
          |DBASS aPath;
          aPath = aPath + #0#2; |QBF aPath;
          aPathFic = aPath + "/fich/";
          aAlfa = aPathFic;
          |_PDIR aAlfa;
          |SI FSalida ! 0;
               |MENAV "0000No existe o esta vacio el directorio 'fich'";
          |SINO;
               nError = 0;
          |FINSI;
          aEmp = "";
     |FINSI;
     |SI nError = 0;
          nError = 1;
          fHoy = ~;
          aFic = (fHoy % -102) + (fHoy % 402) + (fHoy % 102);
          aTar = aFic + aEmp ;    ||->Nombre del Fichero
          |DFICE aPath;
          a1 = aPath + aTar + " *.dat *.ixx *.ddx";
          a2 = aPathFic;
          |ATAR a1, a2;

          a1 = aPath + aTar;
          |COMPRIME a1;
          |FBORRA a1;

          a1 = a1 + ".gz";
          |XABRE "E", a1, 0;
          |SI FSalida ! 0;
               |MENAV "0000Error no se puede compactar...";
          |SINO;
               aIP = "";
               |IP_REMOTO aIP;
               a2 = #0#7; |QBF a2;
               a2 = a2 + "/" + aTar + ".tgz";
               |SI aIP = "";
                    |COPIA_FICHERO a1, a2;
               |SINO;
                    |ENVIA_FICHERO a1, a2;
               |FINSI;
               |SI FSalida ! 0;
                    |MENAV "0000Error al copiar 'tgz' al destino...";
               |SINO;
                    nError = 0;
               |FINSI;
               |FBORRA a1;
          |FINSI;
     |FINSI;
     |SI nError = 1;
          |MENAV "0000Se ha producido algún error, no se ha realizado la copia...";
     |SINO;
          aAlfa = "0000Fichero compactado:" + &13 + aTar + ".tgz";
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO PideClave0;
     |PUSHV 0501 2380;
     |PINTA 2214, "Introduzca la clave de la empresa:"
     E_inf = "";
     E_sup = nLon;
     aAlfa = "";
     aAlfa = 2249 ? -1;
     |POPV;
     |QBF aAlfa;
|FPRC;

|PROCESO Desencripta;
     aAlfa1 = "";
     aAlfa = aClave; |QBF aAlfa;
     aAlfa = aAlfa % 0; nNum = aAlfa;
     |PARA j = 1; |SI j [ nNum; |HACIENDO j = j + 1;
          nCal = (j * 100) + 1; aAlfa = aClave % nCal;
          nCal = &aAlfa;
          |SI nCal > 79;
               nCal = 79 - (nCal - 79);
          |SINO;
               nCal = 79 + (79 - nCal);
          |FINSI;
          aAlfa1 = &nCal + aAlfa1;
     |SIGUE;
     aClave = aAlfa1;
     |QBF aClave;
|FPRC;

|PROCESO PideClave;
     nError = 1;
     aAlfa = #0#3; |QBF aAlfa;
     |SI aAlfa ! "";
          |DBASS aPath;
          aPath = aPath + #0#2; |QBF aPath;
          aDef = aPath + "/def/" + #0#3; |QBF aPath;
          aDef = aDef + ".mas";
          |CARGA_DEF aDef, referen@;
          |SI FSalida ! 0;
               |MENAV "0000Error al cargar def empresa...";
          |SINO;
               aAlfa = aPath + "/fich/";
               |PATH_DAT #referen@#aAlfa#;
               |ABRE #referen@;
               aAlfa = "|NC";
               aAlfa = #referen@#aAlfa#;
               nCampos = aAlfa;
               |PARA i = 0; |SI i < nCampos; |HACIENDO i = i + 1;
                    aAlfa = "|C" + (("000" + i) % -103) + "NOMBRE";
                    aAlfa = #referen@#aAlfa#;
                    aAlfa = aAlfa > "";
                    aAlfa = aAlfa - "CLAVE";
                    |SI FSalida > 0; |SAL; |FINSI;
               |SIGUE;
               |SI i < nCampos;
                    aAlfa = "|K000";
                    aAlfa = #referen@#aAlfa#;
                    aCamClave = aAlfa % -103;
                    nCampo = aCamClave;
                    #referen@#nCampo# = #0#4;
                    |LEE 000#referen@.=;
                    |SI FSalida ! 0;
                         |MENAV "0000No existe empresa...";
                    |SINO;
                         aClave = #referen@#i#;
                         |HAZ Desencripta;
                         aAlfa = "|C" + (("000"+i)%-103) + "ILON";
                         aAlfa = #referen@#aAlfa#;
                         nLon = aAlfa;
                         |HAZ PideClave0;
                         |SI aAlfa = aClave;
                              nError = 0;
                         |FINSI;
                    |FINSI;
               |SINO;
                    nError = 0;
               |FINSI;
               |CIERRA #referen@;
               |DESCARGA_DEF #referen@;
          |FINSI;
     |SINO;
          nError = 0;
     |FINSI;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     |HAZ PideClave;
     |SI nError ! 0;
          |MENAV "0000Clave incorrecta, no se realiza la copia...";
          |ACABA;
     |FINSI;

     |SI #0#6 = "S";
          |HAZ Guarda;
     |FINSI;
     |SI nError = 0;
          |HAZ Restaura;
     |FINSI;

|FPRC;

|PROCESO CambiaBarra;
     |QBF aAlfa;
     aLon = aAlfa % A0;
     aNom = "";
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aCar = aAlfa % nPos;
          |SI aCar = "\"; aCar = "/";  |FINSI;
          |SI i = aLon;
               |SI aCar = "/"; |SAL; |FINSI;
          |FINSI;
          aNom = aNom + aCar;
     |SIGUE;
     aAlfa = aNom;
|FPRC;

|PROCESO SacaDir;
     aAlfa = #0#5; |QBF aAlfa;
     aLon = aAlfa % A0;
     aNom = "";
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = -(i * 100 + 1)
          aCar = aAlfa % nPos;
          |SI aCar = "\"; |O aCar = "/"; |SAL; |FINSI;
          aNom = aCar + aNom;
     |SIGUE;
     aDir = aAlfa - aNom;
|FPRC;

|PROCESO Guarda0; |TIPO 0;
     |SI #0#6 = "S";
          |C_M #0#7, 1, "S";
     |SINO;
          |C_M #0#7, 1, "N";
          #0#7 = ""; |PINTA #0#7;
     |FINSI;
|FPRC;

|PROCESO DesCop0; |TIPO 0;
     |SI #0#6 = "N"; |ACABA; |FINSI;
     |SI FSalida = 13;
          aAlfa = "D*.*";
          |BROWSE aAlfa;
          aAlfa = aAlfa % 2; |QBF aAlfa;
          |SI aAlfa = "D"; aAlfa = ""; |FINSI;
          |QBF aAlfa;
          |SI aAlfa = "";
               |ERROR;
          |SINO;
               #0#7 = aAlfa;
               |PINTA #0#7;
          |FINSI;
     |FINSI;
     aAlfa = #0#7; |QBF aAlfa;
     |SI aAlfa = "";
          |MENAV "0000Debe de indicar un destino...";
          |ERROR;
     |SINO;
          |HAZ SacaDir;
          aDir = aDir > ""; aAlfa = aDir; |HAZ CambiaBarra; aDir = aAlfa;
          aAlfa = #0#7; |QBF aAlfa;
          aAlfa = aAlfa > ""; |HAZ CambiaBarra;
          |SI aDir = aAlfa;
               |MENAV "0000La carpeta destino de la copia no puede ser igual al origen...";
               |ERROR;
          |SINO;
               |ESTADO_CONTROL nBtn2, "DISABLE";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DesCop7; |TIPO 7;
     |ESTADO_CONTROL nBtn2, "ENABLE";
|FPRC;

|PROCESO OrgCop0; |TIPO 0;
     |SI FSalida = 13;
          aAlfa = "F*.tgz";
          |BROWSE aAlfa;
          aAlfa = aAlfa % 2; |QBF aAlfa;
          |SI aAlfa = "F"; aAlfa = ""; |FINSI;
          |QBF aAlfa;
          |SI aAlfa = "";
               |ERROR;
          |SINO;
               #0#5 = aAlfa;
               |PINTA #0#5;
          |FINSI;
     |FINSI;
     aAlfa = #0#5; |QBF aAlfa;
     |SI aAlfa = "";
          |MENAV "0000Debe de indicar un origen...";
          |ERROR;
     |SINO;
          aAlfa = aAlfa % -104; aAlfa = aAlfa < "";
          |SI aAlfa ! ".tgz";
               |MENAV "0000La extensión del fichero debe ser '.tgz'...";
               |ERROR;
          |SINO;
               |ESTADO_CONTROL nBtn1, "DISABLE";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO OrgCop7; |TIPO 7;
     |ESTADO_CONTROL nBtn1, "ENABLE";
|FPRC;

|PROCESO EmpReem7; |TIPO 7;
     aAlfa = #0#3; |QBF aAlfa;
     |SI aAlfa = "";
          |C_M #0#4, 1, "N";
     |SINO;
          |C_M #0#4, 1, "S";
     |FINSI;
|FPRC;

|PROCESO EmpReem0; |TIPO 0;
     aAlfa = #0#3; |QBF aAlfa;
     |SI aAlfa ! "";
          |DBASS aPath;
          aPath = aPath + #0#2; |QBF aPath;
          aDef = aPath + "/def/" + #0#3; |QBF aPath;
          aDef = aDef + ".mas";
          |CARGA_DEF aDef, referen@;
          |SI FSalida ! 0;
               |MENAV "0000Error al cargar def empresa...";
               |ERROR;
          |SINO;
               aAlfa = aPath + "/fich/";
               |PATH_DAT #referen@#aAlfa#;
               |ABRE #referen@;
               aAlfa = "|K000";
               aAlfa = #referen@#aAlfa#;
               aCamClave = aAlfa % -103;
               nCampo = aCamClave;
               #referen@#nCampo# = #0#4;
               |LEE 000#referen@.=;
               |SI FSalida ! 0;
                    |MENAV "0000No existe empresa...";
                    |ERROR;
               |FINSI;
               |CIERRA #referen@;
               |DESCARGA_DEF #referen@;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO EmpReem66; |TIPO 66;
     |DBASS aPath;
     aPath = aPath + #0#2; |QBF aPath;
     aDef = aPath + "/def/" + #0#3; |QBF aPath;
     aDef = aDef + ".mas";
     |CARGA_DEF aDef, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar def empresa...";
          |ERROR;
     |SINO;
          aAlfa = aPath + "/fich/";
          |PATH_DAT #referen@#aAlfa#;
          |ABRE #referen@;
          aAlfa = "|K000";
          aAlfa = #referen@#aAlfa#;
          aCamClave = aAlfa % -103;
          nCampo = aCamClave;
          #referen@#nCampo# = #0#4;
          |LEE 000#referen@.];
          |CONSULTA_CLAVE #1#referen@;
          |SI FSalida = 0;
               #0#4 = #referen@#nCampo#; |PINTA #0#4;
          |SINO;
               |ERROR;
          |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO F5;
     |PTEC 827;
|FPRC;

|PROCESO Proceso; |TIPO 0;
     |ABRE #1;
     #1#0 = #0#0;
     |LEE 020#1=;
     |SI FSalida = 0;
          #0#4 = #1#4; |PINTA #0#4;
     |FINSI;
     |CIERRA #1;
|FPRC;

|PROGRAMA;
     |CLS;
     |PINPA #0#0;
     |PINDA #0#0;
     |CONTROL_SIMPLE 0, "BOTON,...", 1574, 1577, F5;
     nBtn1 = FSalida;
     |CONTROL_SIMPLE 0, "BOTON,...", 1974, 1977, F5;
     nBtn2 = FSalida;
     |ENDATOS #1#0;
     |FIN_CONTROL_WINDOWS nBtn1;
     |FIN_CONTROL_WINDOWS nBtn2;
|FPRO;
