|FICHEROS;
   agifa760 #0;
   agifa761 #1;

   agifa704 #10;

   agifa134 #20;
   agifa079 #21;
   agifa084 #22;
   agifa069 #23;

   agifa722 #24;

   Referen@ #1000;
   camasic@ #1001;
   camasil@ #1002;
   camaniv@ #1003;
   caivarp@ #1004;
   caivasp@ #1005;
|FIN;

|VARIABLES;
   &eaTipoEnl   = "";
   &eaEmpreCont = "";

   aAlfa    = "";
   aAlfa1   = "";
   aSerie   = "";

   nSwContagen = 0;
   nSw      = 0;
   nTecla   = 0;
   nCalc    = 0;
   nFactura = 0;
   nLibro   = 0;
   nDocum   = 0;
   nApunte  = 0;

   CmpClv1  = "";
   CmpClv2  = "";
   CmpClv3  = "";
|FIN;

|PROCESO CodEnlaceT66; |TIPO 66;
   aAlfa = "SELECT * FROM agifa704 INTO tm" + Usuario + " WHERE 2 == '" + #agifa760#0 + "'";
   |SQL aAlfa;
   |SI FSalida = 0;
      aAlfa = FSalida; |QBF aAlfa;
      aAlfa = aAlfa - ":";
      nCalc = FSalida; nCalc = nCalc + 98;
      aAlfa = aAlfa % nCalc; nCalc = aAlfa;
      |SI nCalc = 0;
         |MENAV "    No hay enlaces del tipo indicado"; |POSICIONATE #agifa760#0;
      |SINO;
         |DDEF aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + "agifa704.mas";
         |CARGA_DEF aAlfa, Referen@;
         |SI FSalida = 0;
            aAlfa = "tm" + Usuario; |NOME_DAT #Referen@#aAlfa#;
            |ABRE #Referen@;
            |CONSULTA_CLAVE #1#Referen@;
            |SI FSalida = 0;
               #agifa760#5 = #Referen@#0; |PINTA #agifa760#5;
            |FINSI;
            |CIERRA #Referen@; |DELINDEX #Referen@; |DESCARGA_DEF #Referen@;
         |SINO;
            |MENAV "    No puedo cargar el fichero de mantenimiento de enlaces";
            |ERROR;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO MiraCodEnlace;
   |ABRE #agifa704;
   #agifa704#0 = #agifa760#5;
   |LEE 000#agifa704.=;
   |SI FSalida = 0;
      |SI #agifa704#2 ! #agifa760#0;
         |MENAV "    El enlace seleccionado no es del tipo de enlace indicado.";
         |ERROR;
      |FINSI;
   |FINSI;
   |CIERRA #agifa704;
|FPRC;

|PROCESO MiraEmpCont;
   |SI FSalida = 2; |ACABA; |FINSI;
   nTecla = FSalida;

   |ABRE #agifa704;
   #agifa704#0 = #agifa760#5;
   |LEE 000#agifa704.=;
   |SI FSalida = 0;
      aAlfa = #agifa704#6; |QBF aAlfa; #agifa760#7 = aAlfa;
      aAlfa = aAlfa + "def/canempre.mas";
      |CARGA_DEF aAlfa, Referen@;
      |SI FSalida = 0;
         aAlfa = #agifa704#6; |QBF aAlfa;
         aAlfa = aAlfa + "fich/";
         |PATH_DAT #Referen@#aAlfa#;
         |ABRE #Referen@;
         |SI nTecla = 10;
            #Referen@#2 = #agifa760#3;
            #Referen@#3 = #agifa760#4;
            |LEE 000#Referen@.];
            |CONSULTA_CLAVE #1#Referen@;
            |SI FSalida = 0;
               #agifa760#3 = #Referen@#2;
               #agifa760#4 = #Referen@#3;
               eaEmpreCont = #Referen@#1;
               |PINTA 2021, #Referen@#1;
            |FINSI;
            |ERROR;
         |SINO;
            #Referen@#2 = #agifa760#3;
            #Referen@#3 = #agifa760#4;
            |LEE 000#Referen@.=;
            |SI FSalida = 0;
               eaEmpreCont = #Referen@#1;
               |PINTA 2021, #Referen@#1;
            |SINO;
               |MENAV "    Empresa inexistente";
            |FINSI;
         |FINSI;
         |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
      |SINO;
         |MENAV "    No puedo encontrar el def de empresas contables. Revise el path del enlace";
      |FINSI;
   |SINO;
      |MENAV "    No encuentro el codigo de enlace indicado.";
   |FINSI;
   |CIERRA #agifa704;
|FPRC;

|PROCESO TipoEnlace;
   |SI #agifa760#0 = "FV";
      eaTipoEnl = "Facturas de venta ";
   |FINSI;
   |SI #agifa760#0 = "FC";
      eaTipoEnl = "Facturas de compra";
   |FINSI;
   |SI #agifa760#0 = "FD";
      eaTipoEnl = "Facturas directas ";
   |FINSI;
   |ATRI I; |PINTA 1336, eaTipoEnl; |ATRI N;
|FPRC;

|PROCESO BuscaFactura;
   |SI #camaniv@#36 = "S"; |Y #agifa760#0 = "FC";
      nLibro = #camaniv@#0; nDocum = #camaniv@#1; |ERROR10;
   |FINSI;
   |SI #camaniv@#36 = "R"; |Y #agifa760#0 ! "FC";
      nLibro = #camaniv@#0; nDocum = #camaniv@#1; |ERROR10;
   |FINSI;
|FPRC;

|DEFBUCLE BuscaFactura;
#camaniv@#3003;
;
00, aSerie, nFactura;
99, aSerie, nFactura;
;
NULL,BuscaFactura;
|FIN;

|PROCESO BuscaFacturaStar3Vnt;
   nLibro = #caivarp@#0; |ERROR10;
|FPRC;

|DEFBUCLE BuscaFacturaStar3Vnt;
#caivarp@#1003;
;
00, aSerie, nFactura;
99, aSerie, nFactura;
;
NULL,BuscaFacturaStar3Vnt;
|FIN;

|PROCESO BuscaFacturaStar3Cmp;
   nLibro = #caivasp@#0; |ERROR10;
|FPRC;

|DEFBUCLE BuscaFacturaStar3Cmp;
#caivasp@#1003;
;
00, aSerie, nFactura;
99, aSerie, nFactura;
;
NULL,BuscaFacturaStar3Cmp;
|FIN;

|PROCESO RecalcHisto;
   #agifa722#0 = #agifa760#0;
   |SI #agifa760#0 = "FV";
      aSerie   = #agifa134#49; nFactura = #agifa134#0;
      #agifa722#1 = #agifa134#49;
      #agifa722#2 = #agifa134#0;
      aAlfa = #agifa134#1; |QBF aAlfa; aAlfa = aAlfa % -104;
      #agifa722#3 = aAlfa;
   |FINSI;
   |SI #agifa760#0 = "FC";
      aSerie   = #agifa079#66; nFactura = #agifa079#0;
      #agifa722#1 = #agifa079#66;
      #agifa722#2 = #agifa079#0;
      aAlfa = #agifa079#1; |QBF aAlfa; aAlfa = aAlfa % -104;
      #agifa722#3 = aAlfa;
   |FINSI;
   |SI #agifa760#0 = "FD";
      aSerie   = #agifa084#48; nFactura = #agifa084#0;
      #agifa722#1 = #agifa084#48;
      #agifa722#2 = #agifa084#0;
      #agifa722#3 = 0;

      #agifa069#20 = #agifa084#48;
      #agifa069#0  = #agifa084#0;
      #agifa069#1  = 1;
      |LEE 000#agifa069.];
      |SI FSalida = 0; |Y #agifa069#20 = #agifa084#48; |Y #agifa069#0  = #agifa084#0;
         #agifa722#3 = #agifa069#1;
      |FINSI;
   |FINSI;
   CmpClv1 = #agifa722#1;
   CmpClv2 = #agifa722#2;
   CmpClv3 = #agifa722#3;
   |LEE 000#agifa722.];
   |SI FSalida ! 0; |O #agifa722#0 ! #agifa760#0; |O #agifa722#1 ! CmpClv1;
    |O #agifa722#2 ! CmpClv2; |O #agifa722#3 ! CmpClv3;
      |SI nSw = 1;
         |DDEFECTO #agifa761;
         |SI #agifa760#0 = "FV";
            #agifa761#0 = #agifa134#49;
            #agifa761#1 = #agifa134#0;
            #agifa761#2 = #agifa134#1;
            #agifa761#3 = #agifa134#2;
            #agifa761#4 = #agifa134#3;
            #agifa761#5 = #agifa134#101;
         |FINSI;
         |SI #agifa760#0 = "FC";
            #agifa761#0 = #agifa079#66;
            #agifa761#1 = #agifa079#0;
            #agifa761#2 = #agifa079#1;
            #agifa761#3 = #agifa079#2;
            #agifa761#4 = #agifa079#3;
            #agifa761#5 = #agifa079#118;
         |FINSI;
         |SI #agifa760#0 = "FD";
            #agifa761#0 = #agifa084#48;
            #agifa761#1 = #agifa084#0;
            #agifa761#2 = #agifa084#1;
            #agifa761#3 = #agifa084#3;
            #agifa761#4 = #agifa084#4;
            #agifa761#5 = #agifa084#73;
         |FINSI;
         |GRABA 020#agifa761.n;
      |FINSI;

      |SI nSw = 2;
         aAlfa1 = #agifa760#7; |QBF aAlfa1;
         aAlfa = aAlfa1 - "contagen";
         |SI FSalida = 0;
            nSwContagen = 0;
            aAlfa = aAlfa1 + "def/caivarep.mas";
            |CARGA_DEF aAlfa, caivarp@;
            |SI FSalida = 0;
               aAlfa = aAlfa1 + "def/caivasop.mas";
               |CARGA_DEF aAlfa, caivasp@;
            |FINSI;
         |SINO;
            nSwContagen = 1;
            aAlfa = aAlfa1 + "def/camaniva.mas";
            |CARGA_DEF aAlfa, camaniv@;
         |FINSI;
         |SI FSalida = 0;
            aAlfa = aAlfa1 + "def/camaasic.mas";
            |CARGA_DEF aAlfa, camasic@;

            aAlfa = aAlfa1 + "def/camaasil.mas";
            |CARGA_DEF aAlfa, camasil@;

            aAlfa = #agifa760#7; |QBF aAlfa;
            aAlfa = aAlfa + "fich/" + (("00000" + #agifa760#3) % -105) + #agifa760#4 + "/";
            |PATH_DAT #camasic@#aAlfa#; |ABRE #camasic@;
            |PATH_DAT #camasil@#aAlfa#; |ABRE #camasil@;

            |SI nSwContagen = 1;
               |PATH_DAT #camaniv@#aAlfa#; |ABRE #camaniv@;
               nLibro   = 0; nDocum   = 0;
               |BUCLE BuscaFactura;
               #camaniv@#0 = nLibro;
               #camaniv@#1 = nDocum;
               |LEE 000#camaniv@.=;
            |SINO;
               |PATH_DAT #caivarp@#aAlfa#; |ABRE #caivarp@;
               |PATH_DAT #caivasp@#aAlfa#; |ABRE #caivasp@;
               nLibro   = 0;
               |SI #agifa760#0 = "FC";
                  |BUCLE BuscaFacturaStar3Cmp;
                  #caivasp@#0  = nLibro;
                  #caivasp@#27 = aSerie;
                  #caivasp@#2  = nFactura;
                  |LEE 000#caivasp@.=;
               |SINO;
                  |BUCLE BuscaFacturaStar3Vnt;
                  #caivarp@#0  = nLibro;
                  #caivarp@#27 = aSerie;
                  #caivarp@#2  = nFactura;
                  |LEE 000#caivarp@.=;
               |FINSI;
            |FINSI;
            |SI FSalida = 0;
               |SI nSwContagen = 1;
                  #camasic@#0 = #camaniv@#7;
                  #camasic@#1 = #camaniv@#8;
                  #camasic@#2 = #camaniv@#9;
               |SINO;
                  |SI #agifa760#0 = "FC";
                     #camasic@#0 = #caivasp@#45;
                     #camasic@#1 = #caivasp@#46;
                     #camasic@#2 = #caivasp@#47;
                  |SINO;
                     #camasic@#0 = #caivarp@#45;
                     #camasic@#1 = #caivarp@#46;
                     #camasic@#2 = #caivarp@#47;
                  |FINSI;
               |FINSI;
               |LEE 000#camasic@.=;
               |SI FSalida = 0;
                  nApunte = 1;

                  #camasil@#0 = #camasic@#0;
                  #camasil@#1 = #camasic@#1;
                  #camasil@#2 = #camasic@#2;
                  #camasil@#3 = 1;
                  |LEE 000#camasil@.];
                  |PARA; |SI FSalida = 0; |Y #camasil@#0 = #camasic@#0;
                   |Y #camasil@#1 = #camasic@#1; |Y #camasil@#2 = #camasic@#2; |HACIENDO;
                     |SI #camasil@#19 = "B"; |O #camasil@#19 = "b";
                        nApunte = #camasil@#3;
                     |FINSI;
                     |LEE 000#camasil@.s;
                  |SIGUE;

                  |SI #agifa760#0 = "FD";
                     #agifa069#20 = #agifa084#48;
                     #agifa069#0  = #agifa084#0;
                     #agifa069#1  = 1;
                     |LEE 000#agifa069.];
                     |PARA; |SI FSalida = 0; |Y #agifa069#20 = #agifa084#48; |Y #agifa069#0  = #agifa084#0; |HACIENDO;
                        |DDEFECTO #agifa722;
                        #agifa722#0  = #agifa760#0;
                        #agifa722#1  = CmpClv1;
                        #agifa722#2  = CmpClv2;
                        #agifa722#3  = #agifa069#1;
                        #agifa722#4  = #camasic@#0;
                        #agifa722#5  = #camasic@#1;
                        #agifa722#6  = #camasic@#2;
                        #agifa722#7  = nApunte;
                        #agifa722#8  = #agifa760#3;
                        #agifa722#9  = #agifa760#4;
                        #agifa722#10 = #agifa760#5;
                        #agifa722#11 = 1;
                        |GRABA 020#agifa722.n;

                        |LEE 000#agifa069.s;
                     |SIGUE;
                  |SINO;
                     |DDEFECTO #agifa722;
                     #agifa722#0  = #agifa760#0;
                     #agifa722#1  = CmpClv1;
                     #agifa722#2  = CmpClv2;
                     #agifa722#3  = CmpClv3;
                     #agifa722#4  = #camasic@#0;
                     #agifa722#5  = #camasic@#1;
                     #agifa722#6  = #camasic@#2;
                     #agifa722#7  = 1;
                     #agifa722#8  = #agifa760#3;
                     #agifa722#9  = #agifa760#4;
                     #agifa722#10 = #agifa760#5;
                     #agifa722#11 = 1;
                     |GRABA 020#agifa722.n;
                  |FINSI;
               |SINO;
                  |SI #agifa760#0 = "FV";
                     #agifa134#48 = "N";
                     |GRABA 020#agifa134.a;
                  |FINSI;
                  |SI #agifa760#0 = "FC";
                     #agifa079#48 = "N";
                     |GRABA 020#agifa079.a;
                  |FINSI;
                  |SI #agifa760#0 = "FD";
                     #agifa084#39 = "N";
                     |GRABA 020#agifa084.a;
                  |FINSI;
               |FINSI;
            |SINO;
               |SI #agifa760#0 = "FV";
                  #agifa134#48 = "N";
                  |GRABA 020#agifa134.a;
               |FINSI;
               |SI #agifa760#0 = "FC";
                  #agifa079#48 = "N";
                  |GRABA 020#agifa079.a;
               |FINSI;
               |SI #agifa760#0 = "FD";
                  #agifa084#39 = "N";
                  |GRABA 020#agifa084.a;
               |FINSI;
            |FINSI;

            |CIERRA #camasil@; |DESCARGA_DEF #camasil@;
            |CIERRA #camasic@; |DESCARGA_DEF #camasic@;
            |SI nSwContagen = 1;
               |CIERRA #camaniv@; |DESCARGA_DEF #camaniv@;
            |SINO;
               |CIERRA #caivasp@; |DESCARGA_DEF #caivasp@;
               |CIERRA #caivarp@; |DESCARGA_DEF #caivarp@;
            |FINSI;
         |SINO;
            |MENAV "    No puedo cargar el fichero del registro de iva ";
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE RecalcFV;
#agifa134#3;
48;
"      ", #agifa760#1, #agifa760#8, #agifa760#10, "S";
"zzzzzz", #agifa760#2, #agifa760#9, #agifa760#11, "S";
be;
NULL, RecalcHisto;
|FIN;

|DEFBUCLE RecalcFC;
#agifa079#3;
48;
"N", "      ", #agifa760#1, #agifa760#8, #agifa760#10, "S";
"S", "zzzzzz", #agifa760#2, #agifa760#9, #agifa760#11, "S";
be;
NULL, RecalcHisto;
|FIN;

|DEFBUCLE RecalcFD;
#agifa084#3;
39;
"      ", #agifa760#1, #agifa760#8, #agifa760#10, "S";
"zzzzzz", #agifa760#2, #agifa760#9, #agifa760#11, "S";
be;
NULL, RecalcHisto;
|FIN;

|PROCESO Imprime;
   |PRINT;
|FPRC;

|DEFBUCLE Imprime;
#agifa761#1;
;
INICIO;
FINAL;
;
NULL, Imprime;
|FIN;

|PROCESO Recalcula;
   |ABRE #agifa722; |ABRE #agifa069;
   |SI #agifa760#0 = "FV"; |BUCLE RecalcFV; |FINSI;
   |SI #agifa760#0 = "FC"; |BUCLE RecalcFC; |FINSI;
   |SI #agifa760#0 = "FD"; |BUCLE RecalcFD; |FINSI;
   |CIERRA #agifa722; |CIERRA #agifa069;
|FPRC;

|PROGRAMA;
   |CLS;
   |CABEZA " Proceso de recuperacion del historico de enlaces ";

   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      aAlfa = "tm" + Usuario; |NOME_DAT #agifa761#aAlfa#;
      |DELINDEX #agifa761; |ABRE #agifa761;
      |SI #agifa760#6 = "I"; |O #agifa760#6 = "A";
         nSw = 1; |HAZ Recalcula; || Imprime el informe
         |IMPRE 0;
         |SI FSalida = 0;
            |INFOR "agifa760";
            |SI FSalida = 0;
               |BUCLE Imprime;
               |PIEINF; |FININF;
            |FINSI;
            |FINIMP;
         |FINSI;
      |FINSI;
      |SI #agifa760#6 = "R"; |O #agifa760#6 = "A";
         nSw = 2; |HAZ Recalcula; || Recalcula el historico de enlaces
      |FINSI;
      |CIERRA #agifa761; |DELINDEX #agifa761;
   |FINSI;
|FPRO;
