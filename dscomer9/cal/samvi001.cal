|FICHEROS;
     samvi001 #0;        ||Este Def
     agifa019 #19;       ||Articulos
|FIN;

|VARIABLES;
     nExiste=0;
     aMensaje = "";
     aPath = "";
     aFichero = "";
     nCampo = 0;
     aNombre = "";
     aIPRemoto = "";
     aOrigen = "";
     aDestino = "";
     aBase = "";
     aPathDes = "";
     nLinea = 0;
     aLinea = "";
     nHandle = 0;
     aSeparador = "";
     aLong = "";
     nLong = 0;
     aRef = "";
     nRef = 0;
     aPvp = "";
     aLin = "";
     aUMed = "";
     aFam = "";
     aSubFam = "";
     nConta = 0;
     aConta = "";
     aCaracter = "";
     aAux = "";
     nSwFin = 0;
     nTotal = 0;
|FIN;

|PROGRAMA;
     |HAZ DecimalesBase;
     aSeparador = "#";
     |CLS;
     |ABRE #0;
     |DDEFECTO #0;
     |LEE 101#0p;
     nExiste=FSalida;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida=0;
          |SI nExiste=0;
               |GRABA 020#0a;
          |SINO;
               |GRABA 020#0n;
          |FINSI;
          |ABRE #agifa019;
          |HAZ Principal;
          |CIERRA #agifa019;
     |FINSI;
     |LIBERA #0;
     |CIERRA #0;
|FPRO;

|PROCESO Principal;
     aPath = #samvi001#1;
     |QBF aPath;
     |PARA nCampo = 2;  |SI nCampo [ 11;  |HACIENDO nCampo = nCampo + 1;
          aNombre = #samvi001#nCampo#;
          |QBF aNombre
          |SI aNombre ! "";
               |SI nCampo = 2;
                    aMensaje = "0000Por Favor, introduzca el primer disquette.";
               |SINO;
                    aMensaje = "0000Por Favor proceda a cambiar el disquette. [" + aNombre + "]";
               |FINSI;
               |MENAV aMensaje;
               aFichero = aPath + #samvi001#nCampo#;
               |QBF aFichero;
               |HAZ Importacion;
          |FINSI;
     |SIGUE;
     |SI nTotal = 0;
           aMensaje = "0000No se ha actualizado ninguna Tarifa.";
     |SINO;
           aMensaje = "0000Actualizadas [" + nTotal + "] tarifas.";
     |FINSI;
     |MENAV aMensaje;
|FPRC;

|PROCESO Importacion;
     |HAZ EnviaFichero;
     |SI nSwFin = 0;
          |HAZ RecorreFichero;
          |HAZ BorraFichero;
     |FINSI;
|FPRC;

|PROCESO EnviaFichero;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |DBASS aBase;
     |QBF aBase;
     aPathDes = aBase + "tmp/";
     aDestino = aPathDes + aNombre;

     aOrigen = aFichero;

     aMensaje = "Realizando Captura de Datos, - Procesando Fichero " + aNombre + "-";
     |PINTA 2210, aMensaje;

     aMensaje = "             --- Por Favor, Espere --- ";
     |PINTA 2310, aMensaje;

     |SI aIPRemoto ! "";
         |RECIBE_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
     |SI FSalida ! 0;
          aMensaje = "0000Error: Detectados problemas en el Fichero [" + aNombre + "]";
          |MENAV aMensaje;
          nSwFin = 1;
     |SINO;
          nSwFin = 0;
     |FINSI;
|FPRC;

|PROCESO RecorreFichero;
     nLinea = 0;
     nHandle=1;
     |XABRE "U", aDestino, nHandle;
     |SI FSalida = 0;
          |PARA; |SI; |HACIENDO;
               |XLEE nHandle, 250, aLinea;
               |SI FSalida < 0;
                    |SAL;
               |SINO;
                    |QBF aLinea;
                    nLinea = nLinea + 1;
                    |SI nLinea > 1;
                         |HAZ ProcesaArt;
                    |FINSI;
               |FINSI;
          |SIGUE;
          |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROCESO ProcesaArt;
     aAux = aLinea % 103;
     |SI aAux ! "***";
          aLong = aLinea % 0; nLong = aLong;

          aRef = "";
          |PARA nConta = 1; |SI nConta [ nLong; |HACIENDO nConta = nConta + 1;
               aConta = nConta;
               aAux = aConta + "01";
               aCaracter = aLinea % aAux;
               |SI aCaracter ! aSeparador;
                    aRef = aRef + aCaracter;
               |SINO;
                    |SAL;
               |FINSI;
          |SIGUE;

          aPvp = "";
          nConta = nConta + 1;
          |PARA; |SI nConta [ nLong; |HACIENDO nConta = nConta + 1;
               aConta = nConta;
               aAux = aConta + "01";
               aCaracter = aLinea % aAux;
               |SI aCaracter ! aSeparador;
                    aPvp = aPvp + aCaracter;
               |SINO;
                    |SAL;
               |FINSI;
          |SIGUE;

          aLin = "";
          nConta = nConta + 1;
          |PARA; |SI nConta [ nLong; |HACIENDO nConta = nConta + 1;
               aConta = nConta;
               aAux = aConta + "01";
               aCaracter = aLinea % aAux;
               |SI aCaracter ! aSeparador;
                    aLin = aLin + aCaracter;
               |SINO;
                    |SAL;
               |FINSI;
          |SIGUE;

          aUMed = "";
          nConta = nConta + 1;
          |PARA; |SI nConta [ nLong; |HACIENDO nConta = nConta + 1;
               aConta = nConta;
               aAux = aConta + "01";
               aCaracter = aLinea % aAux;
               |SI aCaracter ! aSeparador;
                    aUMed = aUMed + aCaracter;
               |SINO;
                    |SAL;
               |FINSI;
          |SIGUE;

          aFam = "";
          nConta = nConta + 1;
          |PARA; |SI nConta [ nLong; |HACIENDO nConta = nConta + 1;
               aConta = nConta;
               aAux = aConta + "01";
               aCaracter = aLinea % aAux;
               |SI aCaracter ! aSeparador;
                    aFam = aFam + aCaracter;
               |SINO;
                    |SAL;
               |FINSI;
          |SIGUE;

          aSubFam = "";
          nConta = nConta + 1;
          |PARA; |SI nConta [ nLong; |HACIENDO nConta = nConta + 1;
               aConta = nConta;
               aAux = aConta + "01";
               aCaracter = aLinea % aAux;
               |SI aCaracter ! aSeparador;
                    aSubFam = aSubFam + aCaracter;
               |SINO;
                    |SAL;
               |FINSI;
          |SIGUE;

          |DDEFECTO #agifa019;
          #agifa019#0 = aRef;
          |LEE 101#agifa019.=;
          |SI FSalida ! 0;    |GRABA 020#agifa019.b;   |FINSI;

          #agifa019#18 = aPvp;
          #agifa019#19 = aPvp;
          #agifa019#20 = aPvp;
          #agifa019#147 = aPvp;
          #agifa019#148 = aPvp;
          #agifa019#149 = aPvp;
          #agifa019#125 = aLin;
          #agifa019#5 = aUMed;
||          #agifa019#2 = aFam;
          #agifa019#3 = aSubFam;

          |GRABA 020#agifa019.a;
          |LIBERA #agifa019;

          nTotal = nTotal + 1;
     |FINSI;
|FPRC;

|PROCESO BorraFichero;
     |FBORRA aDestino;
|FPRC;
