|FICHEROS;
     sctrz051 #0;
     sctrm003 #3;
     sctrw020 #20;  ||Tmp Factu/Liqui
     sctrm035 #35;
     sctrm036 #36;
     sctrm046 #46;
     sctrm052 #52;
     sctrm053 #53;
     sctrm054 #54;
     sctrm055 #55;
     sctrm056 #56;
     sctrm066 #66;
     tmp00000 #99;  ||Tmp Impresion
     sctrm001 #100;
|FIN;

|VARIABLES;
     &eaNomLogo = "";
     &enPantaLogo = 0;
     &eaTmpImp = "";
     &Tempo = "";
     &enTiva = 0;
     &efFiva = @;
     &enIva = 0;
     aTmp20 = "";
     aTmp99 = "";
     nPanta = 0;
     aAlfa = "";
     nSwImp = 0;
     nTipo = 0;
     aCli = "";
     aAge = "";
     nLinea = 0;
     nLin = 0;
     nRese = 0;
     nHay = 0;
     aPais = "";
     aIda = "";
     aVuelta = "";
     aIdaVuelta = "";
     nImpTasa = 0;
     nImpLoca = 0;
     nImpDevo = 0;
     nPorcentaje = 0;
     aApis = "";
|FIN;

|PROCESO Saca_IVA;
     aAlfa = aPais; |QBF aAlfa;
     |SI aAlfa = "";
          |HAZ SacaIVA;
     |SINO;
          enIva = 0;
          |ABRE #66;
          #66#5 = aPais;
          #66#0 = enTiva
          #66#4 = "01.01.0000";
          |LEE 000#66];
          |PARA; |SI FSalida = 0; |Y #66#5 = aPais; |Y #66#0 = enTiva;
                    |Y efFiva ] #66#4; |HACIENDO;
               enIva = #66#2;
               |LEE 000#66s;
          |SIGUE;
          |CIERRA #66;
     |FINSI;
|FPRC;

|PROCESO FinFactu;
     |SI aCli ! "";
          |GRABA 020#54a;
          |LIBERA #54;
          |HAZ CreaReci;
          |HAZ CreaReciCartera;
     |FINSI;
|FPRC;

|PROCESO LinFactu;
     nLin = nLin + 1;
     |DDEFECTO #55;
     #55#0 = #54#0;
     #55#1 = #54#1;
     #55#2 = nLin;
     #55#3 = #52#0;
     #55#4 = #52#75;
     #55#6 = #52#45;
     #55#7 = #53#3;
     #55#8 = #52#20;
     #55#10 = #52#19;
     ||#55#11 =

     nImpTasa = #52#108 * nPorcentaje / 100;
     nImpLoca = #52#32 * nPorcentaje / 100;
     nImpDevo = #52#72 * nPorcentaje / 100;

     |SI #20#5 = 1;
          #55#9 = #52#1;
          #55#12 = nImpTasa;
          #55#13 = nImpLoca - nImpTasa;
     |SINO;
          #55#9 = #52#64;
          |SI #52#112 ! "C";
               #55#12 = 0;
          |SINO;
               #55#12 = nImpTasa;
          |FINSI;
          #55#13 = -(nImpDevo - #55#12);
          #55#12 = -#55#12;
     |FINSI;
     #55#14 = #55#13 *  #52#55 / 100;

     |||SI #52#38 = "R"; |O #46#21 = "S";
     |SI #52#38 = "R"; |Y #36#72 = "N";
          #55#12 = 0;
          #55#13 = 0;
     |FINSI;
     #55#17 = #52#8;
     #55#18 = #52#12;

     enTiva = #100#26;
     |SI #36#45 = "N";
          enTiva = 0;    ||Sin iva
     |FINSI;
     efFiva = #54#2;
     aPais = #54#25;
     |HAZ Saca_IVA;
     #55#19 = enIva;

     #55#16 = #55#14 * #55#19 / 100;
     #55#15 = #55#13 - #55#14 - #55#16 + #55#12;
     #55#20 = #20#5;
     #55#21 = aIdaVuelta;
     |GRABA 020#55n;

     #54#9 = #54#9 + #55#15;
     #54#10 = #54#10 + #55#14;
     #54#11 = #54#11 + #55#13;
     #54#12 = #54#12 + #55#12;
     #54#24 = #54#24 + #55#16;
|FPRC;

|PROCESO CabFactu;
     nLin = 0;

     #36#1 = #20#0;
     |LEE 000#36=;
     |SI FSalida ! 0; |DDEFECTO #36; |FINSI;

     #54#0 = #100#25
     #54#1 = 999999;
     |LEE 000#54];
     |SI FSalida = 0;
          |LEE 000#54a;
     |SINO;
          |LEE 000#54u;
     |FINSI;
     |SI FSalida = 0; |Y #54#0 = #100#25;
          nRese = #54#1 + 1;
     |SINO;
          nRese = 1;
     |FINSI;
     |DDEFECTO #54;
     #54#0 = #100#25
     #54#1 = nRese;
     |GRABA 020#54b;
     #54#2 = #0#0;
     #54#3 = #20#0;
     #54#4 = #36#33;
     #54#5 = #36#51;
     #54#13 = #36#48;
     |SI #0#11 = "N";
          #54#14 = #52#43;
     |SINO;
         #54#14 = #20#0;
     |FINSI;
     #54#15 = #20#3;
     #54#25 = #36#9;  ||Pais
     #54#26 = #20#8;  ||F.Apis

     #99#0 = #54#0;
     #99#1 = #54#1;
     |GRABA 020#99n;
|FPRC;

|PROCESO Tmp;
     #52#0 = #20#4;
     |LEE 121#52=;
     |SI FSalida = 0;
          #3#0 = #52#8;
          |LEE 000#3=;
          |SI FSalida ! 0; |DDEFECTO #3; |FINSI;

          #46#0 = #52#4;
          |LEE 000#46=;
          |SI FSalida ! 0; |DDEFECTO #46; |FINSI;

          |SI aCli ! #20#0; |O aAge ! #20#1; |O nTipo ! #20#2; |O nLinea ! #20#3;
                    |O aApis ! #20#8;
               |HAZ FinFactu;
               |HAZ CabFactu;
               aCli = #20#0;
               aAge = #20#1;
               nTipo = #20#2;
               nLinea = #20#3;
               aApis = #20#8;
          |FINSI;
          #53#0 = #52#0;
          #53#1 = 0;
          |LEE 000#53];
          |SI FSalida ! 0; |O #53#0 ! #52#0; |DDEFECTO #53; |FINSI;

          |SI #0#9 = "N";
               nPorcentaje = 100;
               aIdaVuelta = "";
               |HAZ LinFactu;
          |SINO;
               nPorcentaje = 50;
               |SI #20#6 = "S";
                    aIdaVuelta = "I";
                    |HAZ LinFactu;
               |FINSI;
               |SI #20#7 = "S";
                    aIdaVuelta = "V";
                    |HAZ LinFactu;
               |FINSI;
          |FINSI;

          |SI #0#9 = "S";
               |SI #20#6 = "S";    || Ida

                    ||SI #52#6 = 4; |O #52#6 = 5;  || apis

                    |SI #0#11 = "S";  || apis
                         |SI #20#5 = 1;      || Normal
                              #52#143 = "S";
                              #52#144 = #54#0;
                              #52#145 = #54#1;
                         |SINO;              || Anulacion
                              #52#146 = "S";
                              #52#147 = #54#0;
                              #52#148 = #54#1;
                         |FINSI;
                    |SINO;
                         |SI #20#5 = 1;      || Normal
                              #52#83 = "S";
                              #52#84 = #54#0;
                              #52#85 = #54#1;
                         |SINO;              || Anulacion
                              #52#89 = "S";
                              #52#90 = #54#0;
                              #52#91 = #54#1;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI #20#7 = "S";    || Vuelta
                    |SI #20#5 = 1;      || Normal
                         #52#154 = "S";
                         #52#155 = #54#0;
                         #52#156 = #54#1;
                    |SINO;              || Anulacion
                         #52#157 = "S";
                         #52#158 = #54#0;
                         #52#159 = #54#1;
                    |FINSI;
               |FINSI;
          |SINO;
             ||  |SI #52#6 = 4; |O #52#6 = 5;  || apis

               |SI #0#11 = "S";  || apis
                    |SI #20#5 = 1;      || anula
                         #52#143 = "S";
                         #52#144 = #54#0;
                         #52#145 = #54#1;
                    |SINO;
                         #52#146 = "S";
                         #52#147 = #54#0;
                         #52#148 = #54#1;
                    |FINSI;
               |SINO;
                    |SI #20#5 = 1;
                         #52#83 = "S";
                         #52#84 = #54#0;
                         #52#85 = #54#1;
                    |SINO;
                         #52#89 = "S";
                         #52#90 = #54#0;
                         #52#91 = #54#1;
                    |FINSI;
               |FINSI;
          |FINSI;
          |GRABA 020#52a;
     |FINSI;
     |LIBERA #52;
|FPRC;

|DEFBUCLE Tmp;
     #20#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Tmp;
|FIN;

|PROCESO Reserva;
     |SI #52#6 = 3;
          |ACABA;
     |FINSI;

     |SI #0#11 = "N";  || Solo cuando liquidacion no API
          |SI #52#6 = 1; |O #52#6 = 4;
               #46#0 = #52#4;
               |LEE 000#46=;
               |SI FSalida ! 0; |DDEFECTO #46; |FINSI;

               |SI #46#21 ! "S";
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nTipo = 2; |Y #52#64 = "01.01.0000";
          |ACABA;
     |FINSI;

     |SI #0#11 = "S";
          #36#1 = #52#151;
     |SINO;
          #36#1 = #52#43;
     |FINSI;
     |LEE 000#36=;
     |SI FSalida ! 0; |DDEFECTO #36; |FINSI;

     aIda = "N"; aVuelta = "N";
     |SI #0#9 = "N";
          |SI #0#11 = "N";
               |SI #36#75 ! "N";
                    |ACABA;
               |FINSI;
          |FINSI;
     |SINO;
          |SI #36#75 ! "S";
               |ACABA;
          |FINSI;

          |SI #52#17 = 1;
               |SI #52#20 ] #0#3; |Y #52#20 [ #0#4; aIda = "S"; |FINSI;
          |FINSI;
          |SI #52#17 = 2; |O #52#17 = 3;
               |SI #52#20 ] #0#3; |Y #52#20 [ #0#4; aIda = "S"; |FINSI;
               |SI #52#26 ] #0#3; |Y #52#26 [ #0#4; aVuelta = "S"; |FINSI;
          |FINSI;

          |SI aIda = "S";
               |SI #0#11 = "S";
                    |SI nTipo = 1;
                         |SI #52#143 = "S"; aIda = "N"; |FINSI;
                    |SINO;
                         |SI #52#146 = "S"; aIda = "N"; |FINSI;
                    |FINSI;
               |SINO;
                    |SI nTipo = 1;
                         |SI #52#83 = "S"; aIda = "N"; |FINSI;
                    |SINO;
                         |SI #52#89 = "S"; aIda = "N"; |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI aVuelta = "S";
               |SI nTipo = 1;
                    |SI #52#154 = "S"; aVuelta = "N"; |FINSI;
               |SINO;
                    |SI #52#157 = "S"; aVuelta = "N"; |FINSI;
               |FINSI;
          |FINSI;

          |SI aIda = "N"; |Y aVuelta = "N";
               |ACABA;
          |FINSI;
     |FINSI;

     #20#0 = #36#32;
     |SI #0#11 = "N";
          #20#1 = #52#43;
     |SINO;
          #20#1 = "000000";
     |FINSI;
     |SI #0#8 = "N";
          #20#2 = 0;
     |SINO;
          #20#2 = nTipo;
     |FINSI;
     |SI #36#69 = "N";
          #20#3 = 999;
     |SINO;
          #20#3 = #52#75;
     |FINSI;
     #20#4 = #52#0;
     #20#5 = nTipo;
     #20#6 = aIda;
     #20#7 = aVuelta;
     |SI #0#11 = "S";
          #20#8 = "S";
     |SINO;
          #20#8 = "N";
     |FINSI;
     |GRABA 000#20n;          || sin error porque se duplican
     nHay = 1;
|FPRC;

|DEFBUCLE ReseConfir;
     #52#5;
     6, 83, 20, 43;
     #0#1, 0000, 0000000, 1, "N", #0#3, #0#5;
     #0#2, 9999, 9999999, 5, "N", #0#4, #0#6;
     ;
     NULL, Reserva;
|FIN;

|DEFBUCLE ReseConfirApi;
     #52#5;
     6, 143, 20, 151;
     #0#1, 0000, 0000000, 4, "N", #0#3, #0#5;
     #0#2, 9999, 9999999, 5, "N", #0#4, #0#6;
     ;
     NULL, Reserva;
|FIN;

|DEFBUCLE ReseAnula;
     #52#6;
     6, 89, 20, 43;
     #0#1, 0000000, 1, "N", #0#3, #0#5;
     #0#2, 9999999, 5, "N", #0#4, #0#6;
     ;
     NULL, Reserva;
|FIN;

|DEFBUCLE ReseAnulaApi;
     #52#6;
     6, 146, 20, 151;
     #0#1, 0000000, 4, "N", #0#3, #0#5;
     #0#2, 9999999, 5, "N", #0#4, #0#6;
     ;
     NULL, Reserva;
|FIN;

|DEFBUCLE ReseConfirI;
     #52#1;
     6, 20, 43;
     0000000, 1, #0#3, #0#5;
     9999999, 5, #0#4, #0#6;
     ;
     NULL, Reserva;
|FIN;

|DEFBUCLE ReseConfirV;
     #52#1;
     6, 26, 43;
     0000000, 1, #0#3, #0#5;
     9999999, 5, #0#4, #0#6;
     ;
     NULL, Reserva;
|FIN;

|DEFBUCLE ReseAnulaI;
     #52#1;
     6, 20, 43;
     0000000, 1, #0#3, #0#5;
     9999999, 5, #0#4, #0#6;
     ;
     NULL, Reserva;
|FIN;

|DEFBUCLE ReseAnulaV;
     #52#1;
     6, 26, 43;
     0000000, 1, #0#3, #0#5;
     9999999, 5, #0#4, #0#6;
     ;
     NULL, Reserva;
|FIN;

|PROCESO T3; |TIPO 3;
     |SI #0#10 ! "SI"; |ACABA; |FINSI;

     |HAZ CreaTempo; |NOME_DAT #99 Tempo; aTmp99 = Tempo; |DELINDEX #99;
     |HAZ CreaTempo; |NOME_DAT #20 Tempo; aTmp20 = Tempo; |DELINDEX #20;

     |ABRE #20;
     |ABRE #36;
     |ABRE #46;

     |SI #0#7 = "T"; |O #0#7 = "R";
          nTipo = 1;
          |SI #0#11 = "S";
               |BUCLE ReseConfirApi;
          |SINO;
               |SI #0#9 = "S";
                    |BUCLE ReseConfirI;
                    |BUCLE ReseConfirV;
               |SINO;
                     |BUCLE ReseConfir
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #0#7 = "T"; |O #0#7 = "A";
          nTipo = 2;
          |SI #0#11 = "S";
               |BUCLE ReseAnulaApi;
          |SINO;
               |SI #0#9 = "S";
                    |BUCLE ReseAnulaI;
                    |BUCLE ReseAnulaV;
               |SINO;
                    |BUCLE ReseAnula;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #46;
     |CIERRA #36;
     |CIERRA #20;

     |SI nHay = 0;
          |MENAV "0000Selecci¢n vacia...";
     |SINO;
          |CONFI "0000S¨Imprimir Facturas?";
          nSwImp = FSalida;
          |ABRE #3;
          |ABRE #36;
          |ABRE #46;
          |ABRE #52;
          |ABRE #53;
          |ABRE #54;
          |ABRE #55;
          |ABRE #99;
          |BUCLE Tmp;
          |HAZ FinFactu;
          |CIERRA #99;
          |CIERRA #55;
          |CIERRA #54;
          |CIERRA #53;
          |CIERRA #52;
          |CIERRA #46;
          |CIERRA #36;
          |CIERRA #3;
          |SI nSwImp = 0;
               eaTmpImp = aTmp99;
               |SUB_EJECUTA_NP "sctrz052";
          |FINSI;
     |FINSI;

     Tempo = aTmp20; |HAZ BoraTempo; |DELINDEX #20;
     Tempo = aTmp99; |HAZ BoraTempo; |DELINDEX #99;
|FPRC;

|PROCESO TipoRese; |TIPO 0;
     |SI #0#7 = "T";
          |C_M #0#8, 1, "S"; |PINTA #0#8;
     |SINO;
          |C_M #0#8, 1, "N"; |PINTA #0#8;
     |FINSI;
|FPRC;

|PROCESO FacApi; |TIPO 0;
     |SI #0#11 = "S";
          |C_M #0#9, 1, "N";
          #0#9 = "N";
     |SINO;
          |C_M #0#9, 1, "S";
     |FINSI;
     |PINTA #0#9;
|FPRC;

|PROCESO IdaVuelta; |TIPO 0;
     |SI #0#9 = "S";
          |C_M #0#1, 1, "N";
          |C_M #0#2, 1, "N";
     |SINO;
          |C_M #0#1, 1, "S";
          |C_M #0#2, 1, "S";
     |FINSI;
     |PINTA #0#1;
     |PINTA #0#2;
|FPRC,

|PROCESO Relleno; |TIPO 0;
     aAlfa = #0Campo; |QBF aAlfa;
     |SI aAlfa ! "";
          aAlfa = ("000000" + aAlfa) % -106;
          #0Campo = aAlfa; |PINTA #0Campo;
     |FINSI;
|FPRC;

|PROCESO LogoPanta;
     eaNomLogo = #100#1;
     |HAZ TraeLogoPan;
     enPantaLogo = nPanta;
     |HAZ PintaLogoPan;
|FPRC;

|PROGRAMA;
     |ABRE #100; |LEE 000#100p; |CIERRA #100;
     |PINPA #0#0; nPanta = FSalida;
     |PINDA #0#0;
     |HAZ LogoPanta;
     |ENDATOS #1#0;
|FPRO;
