|FICHEROS;
     legiz006 #0;
     legiz007 #3;
     agifa019 #2;
     agifa024 #4;
     agifa038 #13;
     agifa048 #15;
     agifa049 #16;
     agifa204 #204;
     dsm00003 #39,MANTE;
     agifa007 #40;
     agifa142 #41;

     agifa027 #43;  || Contador.              || VIC Puesto el 15/07/98
     agifa321 #35;  || Parametros de Divisas
     agifa328 #36;  || Clientes/Divisas
     agifa329 #37;  || Lineas de Clientes/Divisas
     agifa324 #38;  || Divisas
     agifa073 #73;

     agis0002;
     tempo084 #500,MANTE;  || a Pagar.......
     dscamrec@ #600;
     dsm00005 #905;
     dsm00010 #910;
     dsm00047 #947;
     dsw00016 #1016,MANTE;
     dsm00114 #114;
     dsm00246 #140; ||Control Riesgo Por Usuarios.
     dsm00247 #141; ||Pantalla Informe Riesgo.
     dsm00248 #143; ||Auditoria.
     referen@;
     dsz00119 #119;
|FIN;

|VARIABLES;
     &enImpRiesgo = 0;
     nForma = 0;
     aDef00 = "";
     aMensa = "";
     aTempo600 = "";
     aCPath = "";
     aCNome = "";
     Comodin = "";
     Divisa = "";
     CambioBase = 0;
     CambioDiv = 0;
     nLinea = 0;
     aSubProg = "";
     nUni = 0;
     &enSwNoImp = 0;
     nPrime = 0;
     nPorcOfi = 0; || Porcenta Oficial
     nAcumA = 0;   || Acum. Imp. Oficial
     nAcumB = 0;   || Acum. Imp. B
     nAcumTot = 0; || Acumulado Total
     nPorcCal = 0; || Porcentaje que llevamos
     nNumLin = 0;  || Controla primera línea
     i = 0;
     nError2 = 0;
     &enInforpConfi = -1;
     aPath = "";
     &enMecaDeOrden = 0;
     &enModoCab210 = 0;
     aSinError = "";
     aSql = "";
     aDef = "";
     nGuarda = 0;
     &eaSerAlb = "";
     &enNumAlb = 0;
     &enEsCto = 0;
     &enNumero = 0;
     aCliTeca = "";
     nLinV     = 0;
     &nImpo    = 0;

     aSerAnt = "";
     nPedAnt = 0;
     nImpAd  = 0;
     nFlag   = 0;

     nModo      = 0;
     nPos       = 0;
     nPreBlanco = 0;
     nPreNegro  = 0;
     nDecimal   = 0;
     nCamPre    = 0;
     nCamTot    = 0;
     &Nopregunta= 0;
     nConAu     = 0;
     aUs        = "";
     &nMasRies  = 0;
     nTries     = 0;
     nAudito    = 0;
     &Tempo     = "";
     aTempo1016 = "";
     &nRieTotal = 0;
     &nRieUtili = 0;
     &aRieBloqu = "";
     &aBloquead = "";
     &ser_alb  = "";
     &num_alb  = 0;
     &abo_alb  = "";
     &fec_alb  = @;
     nMult           = 0;
     &eaTag          = "";
     &enTipo         = 0;
     aExporNegro     = "";
     &aSerAntes      = "";
     &nNumAntes      = 0;
     aArti           = "";
     aOpera          = "";
     &cli            = "";
     &ser            = "";
     &enPedCab       = 0;
     &enCodAlbNegro  = 0;
     &enSwMenu       = 0;
     &eaCodigo       = "";
     &eaTipoCodigo   = "CL";

     &pedido         = 0;
     &cliente        = "";
     &ser_ped_inf    = ""; ||Serie (inf. y sup.) del pedido que pasaremos
     &ser_ped_sup    = ""; ||al defbucle de agit0001
     &enSw           = 0;

     nSal            = 0;
     nNume           = 0;
     aFichero        = "";
     nError          = 0;
     nSwVersion      = 0;
     nSwError        = 0;
     aSerAlbBlanco   = "";
     nCodAlbBlanco   = 0;
     nPorce          = 0;
     nPorceT         = 0;
     nCanti          = 0;
     nCanti2         = 0;
     nAcumula        = 0;
     nReparto        = 0;
     nEntero         = 0;
     nTotalBlanco    = 0;
     nTotalNegro     = 0;
     nTCantiBlanco   = 0;
     nCantiBlanco    = 0;
     nCantiBlanco2   = 0;
     nMasMenos       = 0;
     aAlfa           = "";
     aAlfa1          = "";
     aAlfa2          = "";
     aAlfa3          = "";
     aAlfa4          = "";
     nTecla          = 0;

     &nDeci_TBas     = 0;
     &nDeci_TDiv     = 0;
     &nDeci_PBas     = 0;
     &nDeci_PDiv     = 0;

     &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_Div      = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDiv   = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVis   = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVis = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVis   = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVis   = 0;   || Decimales en el Importe visual. (lineas)
     &nDeci_BaseMxP  = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBasMxP= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_DivP     = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDivP  = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVisP  = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVisP= 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVisP  = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVisP  = 0;   || Decimales en el Importe visual. (lineas)
     nfecha    = 0;
     &ac_divisa = "N";   || Vale "S" cuando las divisas en ventas estan
                         || activadas y la serie es de divisas
     &pintado = 0;       || Sirve para controlar los pintados de las lineas
     &decim_divisa = 0;  || Decimales de la divisa
     &precio_divisa = 0; || Decimales del precio en divisa
     &decim_base = 0;    || Decimales de la moneda base
     &precio_base = 0;   || Decimales del precio en moneda base
     div_act = 0;        || Divisa actualizada. Me sirve en un PARA para que
                         || no salga hasta que este actualizada (div_act=1)
     &cli_divisa = "";   || Codigo de Cliente. Se pasa a CLIENTES/DIVISAS
     &divisa = "";       || Codigo de Divisa. Se pasa a ACTUAL. de DIVISAS
     nModo210 = 0;

     &abono    = "";   || Lo utilizo en agifa014.run

     tipo      = 0;
     &codigo   = "";
     &descrip  = "";
     &supedino = "";
     &bl       = "                              ";
     &act_ent  = "N";
     &serv_art = "N";
     informe   = "";
     puente    = "";
     &iva1     = 0;
     &iva2     = 0;
     &iva3     = 0;
     &iva4     = 0;
     &iva5     = 0;
     &re1      = 0;
     &re2      = 0;
     &re3      = 0;
     &re4      = 0;
     &re5      = 0;
     &precio   = 0;
     &dto      = 0;
     &dto1     = 0;
     &unid     = 0;
     &imptot   = 0;
     &tiva     = 0;
     &linea    = 0;
     &n_dec    = 0;
     &n_pre    = 0;
     &sw_modo  = 0;
     totalba   = 0;
     cant      = 0;
     importe   = 0;
     imneto    = 0;
     tf        = 0;
     mes       = 0;
     con       = 0;
     margen    = 0;
     indtope   = 0;
     ind       = 0;
     n_copia   = 0;
     contenido = 0;
     iva_ant   = 0;
     modo = 0;
     alfa = "";
     cont     = "";
     contador = 0;
     caltot = 0;
     recalpre = 0;

     || MENU PARA INTRODUCIR EL CODIGO DEL CLIENTE DE FORMA AUTOMATICA.

 {-1}meng           = "";                   || VIC Puesto 15/07/98
     meng1          = "2400";
     meng2          = "1";
     meng3          = "Contador:  ";
     meng4          = "AM";
     meng5          = " Automatico ";
     meng6          = " Manual ";
     so             = "";
     no             = "";
     nImpDiv        = 0;
|FIN;

|INCLUYE i_varart;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO Tipo8m210;  |TIPO 8;

     |ABRE #41;
     |LEE 001#41p;
     |SI FSalida ! 0; |DDEFECTO #41; |FINSI;
     |CIERRA #41;
     |ABRE #910;
     |LEE 040#910p;
     |SI FSalida ! 0;  |DDEFECTO #910;  |FINSI;
     |CIERRA #910;

     n_dec = #41#8;
     n_pre = #41#9;
     ctrl_st = #41#5;
     act_ent = #41#33;
     serv_art = #41#130;

     |ABRE #40;
     #40#26 = #0#52;
     |LEE 001#40=;
     |SI FSalida ! 0; |DDEFECTO #40; |FINSI;
     |CIERRA #40;
     |C_M #0#51,1,"S";
     |SI #40#37 = "S"; #0#51 = "N"; |C_M #0#51,1,"N"; |FINSI;

     nSwVersion = 0;
     |ABRE #73;
     |LEE 040#73p;
     |SI FSalida = 0;
         |SI #73#42 = 0;  |Y #73#5 ! 0;
             nSwVersion = 1;
         |FINSI;
     |FINSI;
     |CIERRA #73;

     |SI nSwVersion = 1;  |SUB_EJECUTA_NP "dsz00005";  |FINSI;

     |SI enSw = 1;  |PTEC 807;  |FINSI;


|FPRC;

|PROCESO fecalb1;|TIPO 7;
     sw_modo = (FEntrada / 100) ! 0;
     modo = (FEntrada / 100) ! 0;
     |SI modo = 2;
          |C_M #0#1 , 1 , "N";    || Fecha Albaran
          |C_M #0#3 , 1 , "N";    || Cod. Cliente
          |C_M #0#6 , 1 , "N";    || Representante
          |C_M #0#70, 1 , "N";    || Moneda Trabajo
          |C_M #0#68, 1 , "N";    || Divisa
     |SINO;
          |C_M #0#1 , 1 , "S";
          |C_M #0#3 , 1 , "S";
          |C_M #0#6 , 1 , "S";    || Representante
          |C_M #0#8 , 1 , "S";    || Forma de pago
          |C_M #0#70, 1 , "S";    || Moneda Trabajo
          |C_M #0#68, 1 , "S";    || Divisa
     |FINSI;
|FPRC;

|PROCESO EntraCurso; |TIPO 7;
|FPRC;

|PROCESO Tipo210_1; |TIPO 1;
     nSwError = 0;
|FPRC;

|PROCESO acacp;  |TIPO 2;
     |SI nSwError ! 0; |ERROR; |ACABA; |FINSI;

     |HAZ ControlUsuAV;
     |SI enErr ! 0; |ERROR; |ACABA; |FINSI;

     con = (FEntrada / 100) ! 0;
     tipo = 0 +. 1;
     nForma = tipo;
     enModoCab210 = con;
     |SI con = 4; |ACABA; |FINSI;

     |MODULO aAlfa;
     |SI con ! 1;
          |SI #0#41 = 0; |O #0#42 ! 0;
               |MENAV "0000El albaran no proviene de pedido...";
               |ERROR; |ACABA;
          |FINSI;

          |SI #0#85 = "X";
               |MENAV "0000El Albaran proviene de otro Albaran ...";
               |ERROR; |ACABA;
          |FINSI;
          |SI con = 3;
               eaSer = #0#52;
               enDocu = #0#0;
               efFec = #0#1;
               |HAZ MiraHisV;
               |SI enErrHis ! 0;
                    |ERROR;
                    |ACABA;
               |FINSI;
               Nopregunta = 1;
          |FINSI;
     |FINSI;

     |SI con ! 1; |Y tipo = -1; |Y #0#65 = "S";
         |AVISO;
         |CONFI "2400NAlbaran pasado a Compras. Continuar (S/N).: ";
         |SI FSalida ! 0;
             |ERROR; |ACABA;
         |FINSI;
     |FINSI;

     |SI con = 2;|Y #0#42 > 0;|O #0#38 = AS; |O #0#39 = 999999;
         |SI #0#38 = AS;
             |MENAV "0000Este albaran esta FACTURADO";
             |ERROR;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI con = 3;|Y #0#42 > 0;|O #0#38 = AS; |O #0#39 = 999999;
         |SI #0#42 > 0;
             |MENAV "0000Debe Eliminar previamente las lineas de Depositos";
         |FINSI;

         |SI #0#38 = "S";
             |MENAV "0000Este albaran esta FACTURADO";
         |FINSI;

         |SI #0#39 = 999999;
             |MENAV "0000Este albaran esta en modo Exportacion";
         |FINSI;
         |ERROR;
         |ACABA;
     |FINSI;

     |SI tipo = -1;
          |HAZ BajaDesglose;
          |SI nSwError = 1;  |ERROR;  |ACABA;  |FINSI;
     |FINSI;

     ||ÄÄÄÄÄÄÄÄÄÄÄÄAutomatizacion Empresas
     |ABRE #dsm00114; |LEE 000#dsm00114.p; nSal = FSalida; |CIERRA #dsm00114;
     |SI nSal = 0;
          eaCli = #0#3;
          |SI tipo = 1;
               aAlfa = "dsz99983;ALBALTA" + #0#52 + (("000000" + #0#0) % -106);
               |SUB_EJECUTA aAlfa;
          |SINO;
               aAlfa = "dsz99983;ALBBAJA" + #0#52 + (("000000" + #0#0) % -106);
               |SUB_EJECUTA aAlfa;
          |FINSI;
     |FINSI;

     |SI con ! 2;
          |HAZ actal;
     |FINSI;
     |HAZ actpf;
|FPRC;

|PROCESO acttl;|TIPO 0;
     |SI caltot = 0;
          |PINTA 445,#3#1;
          #3#15 = #0#3;
          #3#16 = #0#34;
          #3#17 = #0#35;
          |GRABA 020#3a;
     |SINO;
          |SI recalpre = 1;
               |HAZ TotalLin71;
               |GRABA 020#3a;
               |SI #0#70 = "D";     || Si la moneda de trabajo es la divisa ...
                    |PINTA #3#37;
               |SINO;               || Si la moneda de trabajo es la moneda base ...
                    |PINTA #3#9;
               |FINSI;
               |SI ac_divisa = "S"; |Y #agifa321#3= "S";
                    |PINTA #3#39;   || Si las divisas y la visualizacion estan activadas, pinto
               |FINSI;
          |FINSI;
     |FINSI;

     |HAZ CalCabAgifa010;
|FPRC;

|DEFBUCLE agifa071;
     #3#1;
     ;
     #0#52, #0#0, 001;
     #0#52, #0#0, 999;
     ;
     NULL, acttl;
|FIN;

|PROCESO actal; |TIPO 0;
     |SI caltot = 0;
         |MENSA "0423Actualizando linea:";
     |FINSI;

     |HAZ LimCabAgifa010;
     |BUCLE agifa071;

     |SI caltot = 0;  |BLIN 4;  |FINSI;
|FPRC;

|PROCESO alriesgo1;|TIPO 0;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ Observaciones Clientes.

     |SI #agifa142#14 = "S";
          puente = #agifa024#53;     |QBF puente;
          |SI puente ! "";
               |PUSHV 1008 1370;
               |SI #agifa142#20 = "S"; |AVISO; |FINSI;
               |BLANCO 1009 1369;
               |CUADRO 1008 1370;
               |ATRI R;
               |PINTA 1110 , #agifa024#53;
               |ATRI 0;
               |PAUSA;
               |POPV;
          |FINSI;
     |FINSI;

     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ Control Riesgo Cliente.
     nMasRies = 0;
     eaSerie = #legiz006#52; eaTag = "AV";  |HAZ SacaRiesgo;
     |SI #agifa142#6 = "S";
          eaDocu = "C";
          eaTipo = "A";
          enImpoDoc = #0#67;
          eaMuestra = "S";
          |HAZ ControlRiesgo;
          |SI enErrRie ! 0; nError6 = 1; |ERROR; |ACABA; |FINSI;
          |SI enAudito = 0;
               |ABRE #143;
               |LEE 000#143u;
               |SI FSalida = 0;
                    nConAu = #143#0 + 1;
               |SINO;
                    nConAu = 1;
               |FINSI;
               |DDEFECTO #143;
               #143#0 = nConAu;
               #143#12 = "ALBARAN";
               #143#1 = #0#52;
               #143#2 = #0#0;
               #143#3 = #0#1;
               #143#4 = #0#3;
               #143#5 = #0#4;
               #143#6 = Usuario % 810;
               #143#7 = #141#0;
               #143#8 = #141#1;
               #143#9 = #141#2;
               #143#10 = #141#3;
               #143#11 = #141#4;
               |GRABA 020#143n;
               |CIERRA #143;
          |FINSI;
     |FINSI;
/*

          |SI nRieUtili ] nRieTotal; |Y nRieTotal ! 0;
               |SI #agifa142#22 = "N";
                    |MENAV "0000Superado Riesgo Cliente";
                    |BLIN 4;
               |FINSI;
               |SI #agifa142#22 = "S";
                    |HAZ AvisaRiesgo;
               |FINSI;
               |SI #agifa142#22 = "P";
                    |ABRE #140;
                    aUs = Usuario % 0810;
                    #140#0 = "A";
                    #140#1 = aUs;
                    |LEE 000#140=;
                    |SI FSalida ! 0;
                         |CIERRA #140;
                         |HAZ mira_riesgoa;
                         |ERROR; |ACABA;
                    |FINSI;
                    |CIERRA #140;
                    |DDEFECTO #141;
                    #141#0 = nRieTotal;
                    #141#1 = nRieUtili;
                    #141#2 = #140#2;
                    #141#5 = nRieUtili;
                    #141#3 = (nRieTotal % #140#2);
                    #141#4 = #140#3;
                    |SI #141#3 < #141#4;|Y #141#3 ! 0;
                         #141#6 = nRieTotal + #141#3;
                         nMasRies  = #141#3;
                    |SINO;
                         #141#6 = nRieTotal + #141#4;
                         nMasRies  = #141#4;
                    |FINSI;
                    |SI #141#6 [ #141#5;
                         #141#7 = "DENEGADA ";
                         nAudito = 1;
                         nMasRies = 0;
                    |SINO;
                         #141#7 = "PERMITIDA";
                         nAudito = 0;
                         |ABRE #143;
                         |LEE 000#143u;
                         |SI FSalida = 0;
                              nConAu = #143#0 + 1;
                         |SINO;
                              nConAu = 1;
                         |FINSI;
                         |DDEFECTO #143;
                         #143#0 = nConAu;
                         #143#12 = "ALBARAN";
                         #143#1 = #0#52;
                         #143#2 = #0#0;
                         #143#3 = #0#1;
                         #143#4 = #0#3;
                         #143#5 = #0#4;
                         #143#6 = aUs;
                         #143#7 = #141#0;
                         #143#8 = #141#1;
                         #143#9 = #141#2;
                         #143#10 = #141#3;
                         #143#11 = #141#4;
                         |GRABA 020#143n;
                         |CIERRA #143;
                    |FINSI;
                    |PUSHV 0501 2380;
                    |PINPA #0#141;
                    |PINDA #0#141;
                    |PAUSA;
                    |POPV;
                    |SI nAudito = 1;
                         |ERROR;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |HAZ mira_riesgoa;
*/
|FPRC;

|PROCESO mira_riesgoa;
     |SI aRieBloqu ="S";
          |HAZ BloqCart;
          |ERROR;
          |ACABA;
     |FINSI;
     |SI #agifa142#166 = "S";
          |SI nRieTotal ! 0;
               |PUSHV 0501 2380;
               |BLANCO 0948 1672;
               |CUADRO 1148 1672;
               |CUADRO 0948 1672;
               |ATRI R; |PINTA 1049, "  < CONTROL RIESGOS >  "; |ATRI 0;
               |ATRI I;
               |PINTA 1250, "Concedido:";
               |PINTA 1350, "Total ...:";
               |PINTA 1261, nRieTotal;
               |PINTA 1361, nRieUtili;
               |ATRI 0;
               |PAUSA;
               |POPV;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO actpf;|TIPO 0;
     cant = #0#15 < #0#5;     ||#0#5;
     cant = cant < #0#32;
     cant = cant < #0#7;
     |ABRE #4;
     #4#0 = #0#3;
     |LEE 121#4=;
     |SI 0 = FSalida;
     ||---------------------- #4#50 = #4#50 +. cant;
         |GRABA 020#4a;
         |LIBERA #4;
     |FINSI;
     |CIERRA #4;

     |HAZ riesgo_cli;
|FPRC;

|PROCESO pintot;|TIPO 14;
     |PINTA 0576,"  ";
     |SI #0#41 = 0;|Y #0#42 = 0;
         |PINTA 0576,"AV";
     |SINO;
         |SI #0#41 ! 0;
             |PINTA 0576,"PV";
         |SINO;
             |SI #0#42 ! 0;
                 |PINTA 0576,"AD";
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|RUTINA mirainf1;
     |ABRE #40;
     #40#26 = #0#52;
     |LEE 001#40=;
     |SI FSalida = 0;
          |SI #0#50 = "S";
               informe = #40#3; |QBF informe;
          |SINO;
               informe = #40#4; |QBF informe;
          |FINSI;
     |SINO;
          |SI #0#50 = "S";
               informe = "agifa010";
          |SINO;
               informe = "agif1010";
          |FINSI;
     |FINSI;
     |CIERRA #40;
|FRUT;

|PROCESO entra_0; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |HAZ PintaSerie;
|FPRC;

|PROCESO entra_7; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;

     |HAZ ControlUsuAV;
     |SI enErr ! 0; |PTEC 807; |ACABA; |FINSI;

     |HAZ DefSerVta;

     Nopregunta = 0;
|FPRC;

|PROCESO pinta_obs; |TIPO 14;
     |ABRE #204; |LEE 000#204p; |CIERRA #204;
     puente = #agifa204#6; |QBF puente;
     |SI puente ! "";
          |ATRI I;  |PINTA 2005 , puente;    |ATRI i;
          |C_M #0#55 , 1 , "S";
     |FINSI;

     puente = #agifa204#7; |QBF puente;
     |SI puente ! "";
          |ATRI I;  |PINTA 2030 , puente;    |ATRI i;
          |C_M #0#56 , 1 , "S";
     |FINSI;

     puente = #agifa204#8; |QBF puente;
     |SI puente ! "";
          |ATRI I;  |PINTA 2055 , puente;    |ATRI i;
          |C_M #0#57 , 1 , "S";
     |FINSI;
     |ATRI I;
|FPRC;

|PROCESO riesgo_cli;
     || Si tiene desglose el riesgo lo hace despues
     |SI #0#85 ! "E"; |O nForma = -1;
          eaTag = "AV";  |HAZ Riesgos;
     |FINSI;
|FPRC;

_______________________________________/ COMPRUEBA SI LA SERIE ES FACTURABLE.
|PROCESO nofact; |TIPO 0;
     |ABRE #40;
     #40#26 = #0#52;
     |LEE 001#40=;
     |SI FSalida ! 0; |DDEFECTO #40; |FINSI;
     |C_M #0#51,1,"S";
     |SI #40#37 = "S";
          #0#51 = "N";
          |C_M #0#51,1,"N";
     |FINSI;
     |CIERRA #40;
     |PINTA #0#51;
|FPRC;


|PROCESO MiraIvas;
     |ABRE #40;
     #40#26 = #0#52;
     |LEE 001#40=;
     |SI FSalida ! 0; |DDEFECTO #40; |FINSI;
     |SI #40#30 = "S";   ||Serie Exportacion
          #0#12 = 0;
          #0#14 = 0;
          |PINTA #0#12;
          |PINTA #0#14;
     |FINSI;
|FPRC;

_____________________________________/ BUSCA UN CODIGO DE CLIENTE AUTOMATICO.
|PROCESO Menusg;
     |MENU meng;
     |SI FSalida = 1;    ||Automatico
          |ABRE #43;
          #43#2 = "";
          #43#0 = "clientes";
          |LEE 101#43=;
          |SI FSalida = 0;
               #43#1 = #43#1 + 1;
               contador = #43#1;
               |GRABA 021#43a;
          |SINO;
               contador = 1;
               #43#1 = 1;
               |GRABA 021#43n;
          |FINSI;
          cont = contador;
          cont = ("000000" + cont) % -106;
          #0Campo = cont;
          |PINTA #0Campo;
          |LIBERA #43;
          |CIERRA #43;
     |FINSI;
|FPRC;

|PROCESO LeeMonBase4; ||Lee los parametros de la moneda base
     |ABRE #agifa321;
     |ABRE #agifa324;
     |LEE 010#agifa321.p;   ||Leo parametros de divisa
     #legiz006#73 = #agifa321#9;  ||Cojo la Moneda Base de parametros
     #agifa324#0 = #agifa321#9;
     |LEE 010#agifa324.=;         ||Leo la ficha de la moneda base en Divisas
     #legiz006#74 = #agifa324#2;  ||Asigno el cambio de la moneda base con el euro
     decim_base = #agifa324#7;    ||Asigno los decimales de la moneda base
     precio_base = #agifa324#9;   ||Asigno los decimales del precio en la mon. base
     |CIERRA #agifa324;
     |CIERRA #agifa321;
|FPRC;

|PROCESO Param_Divisas4; |TIPO 0;
     nGuarda = FSalida;
     pintado = 0;  ||Controla pintados de las lineas

     |ABRE #agifa324;
     #agifa324#0 = #legiz006#68;
     |LEE 001#agifa324.=;   || Leo la divisa
     |CIERRA #agifa324;

     decim_divisa = #agifa324#7;  || Decimales de la divisa
     precio_divisa = #agifa324#9;  || Decimales en el precio de la divisa
     nDeci_Div     = decim_divisa;   || Decimales de la divisa
     nDeci_PreDiv  = precio_divisa;  || Decimales en el precio de la divisa
     nDeci_DivP    = decim_divisa;   || Decimales de la divisa
     nDeci_PreDivP = precio_divisa;  || Decimales en el precio de la divisa
     |SI #0#70 = "B";   || Si trabajo con la moneda base ...
          nDeci_Base     = decim_base;
          nDeci_PreBase  = precio_base;
          nDeci_PreVis   = precio_divisa;
          nDeci_ImpVis   = decim_divisa;
          nDeci_BaseMx  = decim_base;
          nDeci_PreBaseMx = precio_base;
          nDeci_TotVis   = decim_base;
          nDeci_TotNoVis = decim_divisa;
          nDeci_PreVisP  = precio_divisa;
          nDeci_ImpVisP  = decim_divisa;
          nDeci_BaseMxP  = decim_base;
          nDeci_PreBasMxP= precio_base;
          nDeci_TotVisP  = decim_base;
          nDeci_TotNoVisP= decim_divisa;
     |SINO;     || Si trabajo con la divisa ...
          nDeci_Base     = decim_base; || Max. precision en los decimales de la moneda base
          nDeci_PreBase  = precio_base;  || Max. precision en los dec. del precio de la moneda base
          nDeci_PreVis   = precio_base;
          nDeci_ImpVis   = decim_base;
         |SI #0#69 = 1;
              nDeci_BaseMx    = decim_base;    || sin triangulacion
              nDeci_PreBaseMx = precio_base;
         |SINO;
              nDeci_BaseMx    = #agifa321#10;  || con triangulacion
              nDeci_PreBaseMx = #agifa321#11;
         |FINSI;
          nDeci_TotVis   = decim_divisa;
          nDeci_TotNoVis = decim_base;
          nDeci_PreVisP  = precio_base;
          nDeci_ImpVisP  = decim_base;
         |SI #0#69 = 1;
              nDeci_BaseMxP   = decim_base;    || sin triangulacion
              nDeci_PreBasMxP = precio_base;
         |SINO;
              nDeci_BaseMxP   = #agifa321#10;  || con triangulacion
              nDeci_PreBasMxP = #agifa321#11;
         |FINSI;
          nDeci_TotVisP  = decim_divisa;
          nDeci_TotNoVisP= decim_base;
     |FINSI;
     |HAZ Deci_IVA;
     FSalida = nGuarda;
|FPRC;

|PROCESO LeeParamDiv4; |TIPO 0;
     |ABRE #agifa321;
     |LEE 001#agifa321.p;    || Leo parametros de divisas
     |CIERRA #agifa321;

     |ABRE #agifa007;
     #agifa007#26 = #legiz006#52;
     |LEE 001#agifa007.=;        || Leo la serie
     |CIERRA #agifa007;

     |SI #agifa007#39 = "N"; |O #agifa321#1 = "N";
          #0#70 = "B";
     |FINSI;

     |SI #0#70 = "D";      || Si la mon. de trabajo es la divisa...
          || ...escondo los campos de la moneda base :
          |C_P #3#6 , 1 , 1009;
          |C_P #3#9 , 1 ,1026;
          |C_V #3#6 , 1 , "N";
          |C_V #3#9 , 1 , "N";
          |C_L #3#6 , 1 , "N";
          |C_L #3#9 , 1 , "N";
          |C_M #3#6 , 1 , "N";
          || ...y pongo en pantalla los de divisa
          |C_P #3#36 , 1 , 1544;
          |C_P #3#37 , 1 ,1568;
          |C_V #3#36 , 1 , "S";
          |C_V #3#37 , 1 , "S";
          |C_M #3#36 , 1 , "S";
          |C_L #3#36 , 1 , "S";
          |C_L #3#37 , 1 , "S";
          |SI #agifa007#39 = "S"; |Y #agifa321#1 = "S"; ||Si la serie es de ...
               ac_divisa = "S";  || ... divisas, y en parametros estan activadas ...
               || ... pongo como modificables los campos relacionados con divisas
               |C_M #0#68 , 1 , "S";
               |C_M #0#69 , 1 , "S";
               |C_M #0#70 , 1 , "S";
               |C_M #0#71 , 1 , "S";
               |C_M #0#72 , 1 , "S";
               |SI #agifa321#3 = "S";  || Si la visualizacion de parametros esta activada
                    || ... pongo los campos visual. de lineas como visualizables
                    |C_V #3#38, 1 , "S";
                    |C_V #3#39 , 1 , "S";
               |SINO;
                    || ... los pongo como no visualizables
                    |C_V #3#38 , 1 , "N";
                    |C_V #3#39 , 1 , "N";
               |FINSI;
          |SINO;    || Si la serie no es de divisas, o no estan activados parametros
               ac_divisa = "N";
               #0#70 = "B";  || La moneda de trabajo es por fuerza la moneda base
               |PINTA #0#70;
               || Pongo como no modificables los campos relacionados con divisas
               |C_M #0#70 , 1 , "N";
               |C_M #0#71 , 1 , "N";
               |C_M #0#72 , 1 , "N";
               |C_M #0#68 , 1 , "N";
               |C_M #0#69 , 1 , "N";
               || Pongo como no visualizables los campos visual. de lineas
               |C_V #3#38, 1 , "N";
               |C_V #3#39, 1 , "N";
          |FINSI;
     |SINO;  || Si la moneda de trabajo es la moneda base
          || ...escondo los campos en divisa :
          |C_P #3#36 , 1 , 1009;
          |C_P #3#37 , 1 ,1026;
          |C_V #3#36 , 1 , "N";
          |C_V #3#37 , 1 , "N";
          |C_M #3#36 , 1 , "N";
          |C_L #3#36 , 1 , "N";
          |C_L #3#37 , 1 , "N";
          || ...coloco los campos en moneda base:
          |C_P #3#6 , 1 , 1544;
          |C_P #3#9 , 1 ,1568;
          |C_V #3#6 , 1 , "S";
          |C_V #3#9 , 1 , "S";
          |C_M #3#6 , 1 , "S";
          |C_L #3#6 , 1 , "S";
          |C_L #3#9 , 1 , "S";
          |SI #agifa007#39 = "S"; |Y #agifa321#1 = "S"; || Si la serie es de divisas...
               ac_divisa = "S"; || ... y divisas estan activadas en parametros
               || Pongo como modificables los campos relacionados con divisas
               |C_M #0#68 , 1 , "S";
               |C_M #0#69 , 1 , "S";
               |C_M #0#70 , 1 , "S";
               |C_M #0#71 , 1 , "S";
               |C_M #0#72 , 1 , "S";
               |SI #agifa321#3 = "S";  || Si la visualizacion esta activada en parametros ...
                    || Pongo como visualizables los campos visual. de las lineas
                    |C_V #3#38, 1 , "S";
                    |C_V #3#39 , 1 , "S";
               |SINO; || Los pongo como no visualizables
                    |C_V #3#38 , 1 , "N";
                    |C_V #3#39 , 1 , "N";
               |FINSI;
          |SINO;  || Si la serie no es de divisas o no estan activados los parametros
               ac_divisa = "N";
               #0#70 = "B";  || La moneda de trabajo es por fuerza la moneda base
               || Pongo como no modificables los campos relacionados con divisas
               |C_M #0#70 , 1 , "N";
               |C_M #0#71 , 1 , "N";
               |C_M #0#72 , 1 , "N";
               |C_M #0#68 , 1 , "N";
               |C_M #0#69 , 1 , "N";
               || Pongo como no visualizables los campos visual. de lineas
               |C_V #3#38, 1 , "N";
               |C_V #3#39, 1 , "N";
          |FINSI;
     |FINSI;
     ||ÄÄÄÄÄÄÄÄPortes/Varios
     |C_P #0#81, 0, nPos; |C_P #0#11, 1, nPos;
     |C_P #0#82, 0, nPos; |C_P #0#13, 1, nPos;
     |C_V #0#11, 1, "N";
     |C_V #0#13, 1, "N";
     |C_V #0#81, 1, "N";
     |C_V #0#82, 1, "N";
     |SI #0#70 = "D";
          |C_V #0#81, 1, "S";
          |C_V #0#82, 1, "S";
     |SINO;
          |C_V #0#11, 1, "S";
          |C_V #0#13, 1, "S";
     |FINSI;
     |HAZ Param_Divisas4;
|FPRC;

|PROCESO CambioDivisa4; |TIPO 0;
     nModo210 = (FEntrada / 100) ! 0;
     |SI #0Campo ! Contenido; |Y nModo210 = 1;   ||Si cambia el valor o es alta
       |SI Campo = 3; || Si llamo al proceso desde el cod. de cliente ...
         #0#68 = #agifa024#192;  || Asigno la divisa por defecto del cliente
         #0#70 = #agifa024#193;  || Asigno la moneda de trabajo del cliente
         |PINTA #0#70;
       |FINSI;
       |ABRE #agifa007;
       #agifa007#26 = #legiz006#52;
       |LEE 001#agifa007.=;  || Leo la serie
       |CIERRA #agifa007;
        |SI #agifa007#39 = "S"; |Y #agifa321#1 = "S";
           |SI #agifa024#191 = "S"; || Si el cliente es de divisa pactada
              |ABRE #agifa328;
              |ABRE #agifa329;
              #agifa329#0 = #legiz006#3;
              #agifa329#2 = #legiz006#68;
              #agifa329#7 = "N";
              |SELECT #2#agifa329;  || Con esta clave ...
              |LEE 011#agifa329.=;  || ... busco periodos no finalizados de esa divisa
              |SI FSalida = 0;  || Si existe un periodo no finalizado
                |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
                  #legiz006#68 = #agifa329#2;        || Cargo la divisa ...
                  #legiz006#69 = #agifa329#3;        || ...y el cambio
                  |LEE 001#agifa329.=;   || Leo las lineas de Clientes/Divisas
                  nfecha = #legiz006#1 - #agifa329#6;  || Resto la fecha de fin de periodo a la actual
                  |SI nfecha > 0;  || Si la fecha actual supera a la del periodo asignado ...
                     |MENAV "0000ATENCION deberia Actualizar primero la divisa en Clientes/Divisas";
                     cli_divisa = #legiz006#3;  || Le envio el cod. de cliente a "agifa328"
                     |SUB_EJECUTA_NP "agifa328.tab";  || Ejecuto Clientess/Divisas
                     |ERROR;
                  |SINO;
                     div_act = 1;  || Para salir del PARA
                  |FINSI;
                |SIGUE;
              |SINO;  || Si no existe un periodo no finalizado para esa divisa
                |MENAV "0000No existe un periodo activo para la divisa en Clientes / Divisas";
                cli_divisa = #legiz006#3;  || Le paso a "agifa328" el cliente
                |SUB_EJECUTA_NP "agifa328.tab";  || Ejecuto Clientes / Divisas
                |ERROR;
                ||#legiz006#68 = #legiz006#73;
                ||#legiz006#69 = #legiz006#74;
              |FINSI;
              |SELECT #1#agifa329;
              |CIERRA #agifa329;
              |CIERRA #agifa328;
           |SINO; || Si el Cliente no es de Divisa pactada ...
              |ABRE #agifa324; || ...miro directamente en divisas
              #agifa324#0 = #legiz006#68;
              |LEE 001#agifa324.=;
              |SI FSalida = 0; ||Si existe la divisa...
                 #legiz006#69 = #agifa324#2; || la recojo
                 |SI #agifa324#5 ! -1; || Si los dias de margen de actualizacion no
                                       || son = -1 (indefinidos)
                   |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
                      #legiz006#68 = #agifa324#0;        ||Cargo el valor de la divisa
                      #legiz006#69 = #agifa324#2;        ||Cargo el valor del cambio
                      |LEE 001#agifa324.=;  || Leo la divisa
                      nfecha = #legiz006#1 - #agifa324#4;
                      |SI nfecha > #agifa324#5; |Y #agifa324#5 ! -1;  || Si la fecha actual
                         |MENAV "0000ATENCION deberia Actualizar primero la divisa";
                         divisa = #legiz006#68;
                         |SUB_EJECUTA_NP "agifa326.tab";
                         |ERROR;
                      |SINO;
                         div_act = 1;
                      |FINSI;
                   |SIGUE;
                 |FINSI;
              |FINSI;
              |CIERRA #agifa324;
           |FINSI;
        |SINO;
          #legiz006#68 = #legiz006#73;
          #legiz006#69 = #legiz006#74;
        |FINSI;
     |PINTA #legiz006#68;
     |PINTA #legiz006#69;
     |SI Campo = 3; || Si llamo al proceso desde el cod. de cliente ...
       |HAZ LeeParamDiv4;
     |SINO;
       |HAZ Param_Divisas4;
     |FINSI;
     |FINSI;
|FPRC;

|PROCESO convportes; |TIPO 6;
     |SI #0#70 = "D";
          #0#11 = #0#81 / #0#69 * #0#74;
     |SINO;
          #0#81 = #0#11 * #0#69 / #0#74;
     |FINSI;
|FPRC;

|PROCESO convvarios; |TIPO 6;
     |SI #0#70 = "D";
         #0#13 = #0#82 / #0#69 * #0#74;
     |SINO;
         #0#82 = #0#13 / #0#69 * #0#74;
     |FINSI;
|FPRC;

|PROCESO Nume0; |TIPO 0;
     enModoCab210 = (FEntrada / 100) ! 0;
     |SI enModoCab210 = 1;
          |ABRE #40;
          #40#26 = #0#52;
          |LEE 020#40=;
          |CIERRA #40;
          #0#51 = #40#28; |PINTA #0#51;
     |FINSI;

     |HAZ LeeMonBase4;
     |HAZ LeeParamDiv4;
     |HAZ MiraIvas;
|FPRC;

|PROCESO LeeAlb; |TIPO 13;  || Sirve para cargar los valores cada vez que
                            || cambio de ficha
     |HAZ Tipo8m210;
     pintado = 0;   || controla pintado de las lineas
     |HAZ LeeMonBase4;
     |HAZ LeeParamDiv4;

     |HAZ PintaSerie;
|FPRC;

|PROCESO PintaSerie;
     |DDEFECTO #40;
     |ABRE #40;
     #40#26 = #0#52;
     |LEE 000#40=;
     |CIERRA #40;
     |ATRI I;
     |PINTA 908, #40#27;
     |ATRI 0;
|FPRC;

|PROCESO cambfecha4;
|SI #0#71 ! "O";
  #0#72 = "        ";
  |PINTA #0#72;
  |C_M #0#72,1,"N";
  |C_V #0#72,1,"N";
|SINO;
  |C_M #0#72,1,"S";
  |C_V #0#72,1,"S";
|FINSI;
|FPRC;

|PROCESO modomod4; |TIPO 6;
   |SI nModo210 = 2; |Y #0Campo ! Contenido;
       |MENAV "0000No se puede modificar el campo.";
       #0Campo = Contenido;
       |PINTA #0Campo;
       |ERROR;
   |FINSI;
   |SI #0Campo ! Contenido; |Y Campo = 70;
     |HAZ LeeParamDiv4;
   |FINSI;
|FPRC;

|PROCESO caltotal4; |TIPO 0; ||Proceso especial para casos determinados como
                            ||modificar los campos de cabecera en dtos, cambio divisas etc
                            ||Recalcula total albaran, descuentos y ivas de lineas
                            ||En el caso de cambiar el cambio de divisas recalcula tambien precio... de lineas

     |SI #0Campo ! Contenido;||Solo si cambia
          caltot = 1;
          |SI Campo = 69; ||Si viene del cambio divisa
              recalpre = 1; ||Recalcular tambien precios linea
          |FINSI;
          |HAZ actal;

          |PINTA #0#78;
          caltot = 0;
          recalpre = 0;
     |FINSI;
|FPRC;

|RUTINA linfer;
  #39#0 = #0#3;
  #39#1 = 1;
|FRUT;

|RUTINA lsuper;
  #39#0 = #0#3;
  #39#1 = 9999;
|FRUT;

|PROCESO impreal;
     modo = (FEntrada / 100) ! 0;
     |SI modo = 1; |O modo = 2;
          |GRABA 021#0a;
          |LIBERA #0;
     |FINSI;
     ser_alb = #0#52;
     num_alb = #0#0;
     |CIERRAT #0;
     abono = #0#43;                 || Abono S/N para discriminar los formatos
                                    || en agifa014.run
     |SUB_EJECUTA_NP "agifa014.run";   || Impresion de albaranes
     |ABRET #0;
     #0#52 = ser_alb;
     #0#0 = num_alb;
     |SI modo = 4;
          |LEE 001#0=;
     |SINO;
          |LEE 101#0=;
     |FINSI;
|FPRC;

|PROCESO PreReparto;
     |SI #0#70 = "B";
          #905#8 = #905#6 * #905#7;
          #905#13 = #905#7 / #0#74 * #0#69;
          #905#14 = #905#8 / #0#74 * #0#69;
     |SINO;
          #905#14 = #905#6 * #905#13;
          #905#7 = #905#13 / #0#69 * #0#74;
          #905#8 = #905#14 / #0#69 * #0#74 ;
     |FINSI;
|FPRC;

|PROCESO Reparto;
     nCantiBlanco2 = nCanti2 * nPorce;

     nAcumula = nAcumula + nCanti;
     nReparto = nCanti * nPorce;
     nEntero  = (nReparto - .50) ! 0;
     |SI nReparto = nEntero;
         nCantiBlanco = nReparto;
         nTCantiBlanco = nTCantiBlanco + nCantiBlanco;
     |SINO;
         nReparto = ((nCanti * nPorce) - nMasMenos);
         |SI nReparto < 0;
             nCantiBlanco = 0;
         |SINO;
             nEntero = (nReparto - .50) ! 0;
             |SI nReparto = nEntero;
                 nCantiBlanco  = nReparto;
                 nTCantiBlanco = nTCantiBlanco + nCantiBlanco;
             |SINO;
                 nCantiBlanco = nEntero + 1;
                 nTCantiBlanco = nTCantiBlanco + nCantiBlanco;
             |FINSI;
         |FINSI;
     |FINSI;

     nReparto  = nAcumula * nPorce;
     nMasMenos = nTCantiBlanco - nReparto;
|FPRC;

|PROCESO PorUnidadC;
     nCanti = #905#6;
     |HAZ Reparto;

     |SALVA_FICHA #905;

     #905#1  = #4#199;
     #905#2  = enCodAlbNegro;
     #905#6  = nCanti - nCantiBlanco;
     #905#9  = 0;
     #905#11 = 0;
     #905#12 = 0;
     |HAZ PreReparto;
     |GRABA 020#905n;

     |REPON_FICHA #905;
     #905#10 = #905#6;
     #905#6  = nCantiBlanco;
     |HAZ PreReparto;
     |GRABA 020#905a;
     |LIBERA #905;
|FPRC;

|PROCESO PorPrecioC;
     nCanti = #905#nCamPre#;
     ||nCanti = nCanti * nDecimal;
     nCanti = (nCanti * nDecimal) ! 0;  || Tiquet 1908/517
     |HAZ Reparto;
     nCantiBlanco = nCantiBlanco / nDecimal;

     |SALVA_FICHA #905;

     #905#1  = #4#199;
     #905#2  = enCodAlbNegro;
     #905#nCamPre# = #905#nCamPre# - nCantiBlanco;
     #905#9  = 0;
     #905#11 = 0;
     #905#12 = 0;
     |HAZ PreReparto;
     |GRABA 020#905n;
     nTotalNegro = nTotalNegro + #905#nCamTot#;
     nPreNegro = #905#nCamPre#;

     |REPON_FICHA #905;
     #905#10 = #905#nCamPre#;
     #905#nCamPre# = nCantiBlanco;
     |HAZ PreReparto;
     |GRABA 020#905a;
     |LIBERA #905;
     nTotalBlanco = nTotalBlanco + #905#nCamTot#;
     nPreBlanco = #905#nCamPre#;
|FPRC;

|PROCESO PorProporcion;
     |SI #2#176 = "S";
/*
         nLinV = #3#1;
         |BUCLE dsm00005;

         |SALVA_FICHA #71;

         #3#29 = #4#199;
         #3#0  = enCodAlbNegro;
         #3#5  = #3#5 - nTCantiBlanco;
         aAlfa = "U" + "N" + (("000" + nPorceT) % -103);
         #3#47 = aAlfa;
         |SI aExporNegro = "S"; #3#11 = 0; |FINSI;  ||Exporta
         |GRABA 020#71n;

         |REPON_FICHA #71;

         aAlfa = "U" + "P" + (("000" + nPorceT) % -103) + (("               " + #3#5) % -115);
         #3#47 = aAlfa;
         #3#5  = nTCantiBlanco;
         |GRABA 020#71a;
*/
     |SINO;
         |SI #2#179 = "S";         || Doble Stock
/*
              |SI #3#48 = 1;
                  nPorce = 1;  || Si uni2 = 1 no hay desglose
                  nPorceT = 0;
              |FINSI;
              nCanti = #3#5;
              nReparto = nCanti * nPorce;
              nCantiBlanco = nReparto ! #2#187;
              nCanti2 = #3#48;
              nReparto = nCanti2 * nPorce;
              nCantiBlanco2 = nReparto ! 0;
              #3#50 = #3#50 * nPorce;
*/
         |SINO;
               nCanti = #3#5;
               nCantiBlanco = 0;
               |SI nPorcOfi = 0;
                    nCantiBlanco = 0;
               |SINO;
                    |SI nNumLin = 0;
                         nNumLin = 1;
                         |SI nPorcOfi ] 50;
                              || Como el porcentaje es igual o mayor Of 1º unidad de la linea del albaran todo oficial
                              nCantiBlanco = 1;
                              nAcumA = #3#6 < #3#8 < #3#33;
                              nAcumTot = nAcumA;
                         |SINO;
                              nAcumB = #3#6 < #3#8 < #3#33;
                              nAcumTot = nAcumB;
                         |FINSI;
                         nPorcCal = (nAcumA * 100) / (nAcumTot);
                         |PARA i = 2;|SI i [ #3#5;|HACIENDO i = i + 1;
                              |SI nPorcOfi < nPorcCal;
                                   || Como % oficial es inferior al que se lleva B
                                   nAcumB = nAcumB + (#3#6 < #3#8 < #3#33);
                                   nAcumTot = nAcumTot + (#3#6 < #3#8 < #3#33);
                              |SINO;
                                   nAcumA = nAcumA + (#3#6 < #3#8 < #3#33);
                                   nAcumTot = nAcumTot + (#3#6 < #3#8 < #3#33);
                                   nCantiBlanco = nCantiBlanco + 1;
                              |FINSI;
                              nPorcCal = (nAcumA * 100) / (nAcumTot);
                         |SIGUE;
                    |SINO;
                         |PARA i = 1;|SI i [ #3#5;|HACIENDO i = i + 1;
                              |SI nPorcOfi < nPorcCal;
                                   || Como % oficial es inferior al que se lleva B
                                   nAcumB = nAcumB + (#3#6 < #3#8 < #3#33);
                                   nAcumTot = nAcumTot + (#3#6 < #3#8 < #3#33);
                              |SINO;
                                   nAcumA = nAcumA + (#3#6 < #3#8 < #3#33);
                                   nAcumTot = nAcumTot + (#3#6 < #3#8 < #3#33);
                                   nCantiBlanco = nCantiBlanco + 1;
                              |FINSI;
                              nPorcCal = (nAcumA * 100) / (nAcumTot);
                         |SIGUE;
                    |FINSI;
               |FINSI;
               nCanti2 = 0;
               nCantiBlanco2 = 0;
         |FINSI;

         |SALVA_FICHA #3;
         |SI nPorcOfi = 100;
             nCanti = #3#5; nCantiBlanco = #3#5;
             nCanti2 = #3#48; nCantiBlanco2 = #3#48;
         |FINSI;
         #3#29 = #4#199;
         #3#0  = enCodAlbNegro;
         #3#5  = nCanti - nCantiBlanco;
         #3#48  = nCanti2 - nCantiBlanco2;
         aAlfa = "X " + (("000" + nPorcOfi) % -103) + (("               " + nCantiBlanco) % -115);
         aAlfa = aAlfa + (("               " + #3#5) % -115);
         #3#47 = aAlfa;
         |SI aExporNegro = "S"; #3#11 = 0; |FINSI;  ||Exporta
         |GRABA 020#3n;
         |REPON_FICHA #3;
         #3#47 = aAlfa;
         #3#5  = nCantiBlanco;
         #3#48  = nCantiBlanco2;
         |GRABA 020#3a;
         |LIBERA #3;
     |FINSI;
|FPRC;

|PROCESO LineasBlancasC;
     |SI #4#198 = "U";                  |HAZ PorUnidadC;  |FINSI;
     |SI #4#198 = "P"; nMasMenos = 0;nAcumula = 0; |HAZ PorPrecioC;  |FINSI;
     |SI #4#198 = "A"; |O #4#198 = " ";
         |SI #2#178 = " "; #2#178 = "U"; |FINSI;
         |SI #2#178 = "U"; |HAZ PorUnidadC;  |FINSI;
         |SI #2#178 = "P"; nMasMenos = 0;nAcumula=0; |HAZ PorPrecioC;  |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsm00005;
     #905#1;
     ;
     "AV", #3#29, #3#0, nLinV, "      ";
     "AV", #3#29, #3#0, nLinV, "zzzzzz";
     be;
     NULL, LineasBlancasC;
|FIN;

|PROCESO PorUnidad;
     |SI #2#176 = "S";
         nLinV = #3#1;
         |BUCLE dsm00005;

         |SALVA_FICHA #3;

         #3#29 = #4#199;
         #3#0  = enCodAlbNegro;
         #3#5  = #3#5 - nTCantiBlanco;
         aAlfa = "U" + "N" + (("000" + nPorceT) % -103);
         #3#47 = aAlfa;
         |SI aExporNegro = "S"; #3#11 = 0; |FINSI;
         |GRABA 020#3n;

         |REPON_FICHA #3;

         aAlfa = "U" + "P" + (("000" + nPorceT) % -103) + (("               " + #3#5) % -115);
         #3#47 = aAlfa;
         #3#5  = nTCantiBlanco;
         |GRABA 020#3a;
     |SINO;
         |SI #2#179 = "S";         || Doble Stock
              |SI #3#48 = 1;
                  nPorce = 1;  || Si uni2 = 1 no hay desglose
                  nPorceT = 0;
              |FINSI;
              nCanti = #3#5;
              nReparto = nCanti * nPorce;
              nCantiBlanco = nReparto ! #2#187;
              nCanti2 = #3#48;
              nReparto = nCanti2 * nPorce;
              nCantiBlanco2 = nReparto ! 0;
              #3#50 = #3#50 * nPorce;
         |SINO;
               nCanti = #3#5;
               nReparto = nCanti * nPorce;
               nCantiBlanco = nReparto ! #2#187;
               nCanti2 = 0;
               nCantiBlanco2 = 0;
         |FINSI;

         |SALVA_FICHA #3;

         #3#29 = #4#199;
         #3#0  = enCodAlbNegro;
         #3#5  = nCanti - nCantiBlanco;
         #3#48 = nCanti2 - nCantiBlanco2;
         aAlfa = "U" + "N" + (("000" + nPorceT) % -103);
         #3#47 = aAlfa;
         |SI aExporNegro = "S"; #3#11 = 0; |FINSI;
         |GRABA 020#3n;

         |REPON_FICHA #3;
         aAlfa = "U" + "P" + (("000" + nPorceT) % -103) + (("               " + #3#5) % -115);
         aAlfa = aAlfa + (("               " + #3#48) % -115);
         #3#47 = aAlfa;
         #3#5  = nCantiBlanco;
         #3#48 = nCantiBlanco2;
         |GRABA 020#3a;
         |LIBERA #3;
     |FINSI;
|FPRC;

|PROCESO PorPrecio;
     |SI #2#176 = "S";
         nTotalNegro  = 0;
         nTotalBlanco = 0;
         nLinV = #3#1;
         |BUCLE dsm00005;

         |SALVA_FICHA #3;

         #3#29 = #4#199;
         #3#0  = enCodAlbNegro;
         |SI #0#70 = "D";  || Si mon. de trabajo es divisa ...
             |SI #910#24 = "N";
                  #3#36 = nPreNegro;
             |SINO;
                  #3#36 = nTotalNegro / #3#5;
             |FINSI;
         |SINO;
             |SI #910#24 = "N";
                  #3#6 = nPreNegro;
             |SINO;
                  #3#6  = nTotalNegro / #3#5;
             |FINSI;
         |FINSI;
         aAlfa = "P" + "N" + (("000" + nPorceT) % -103);
         #3#47 = aAlfa;
         |SI aExporNegro = "S"; #3#11 = 0; |FINSI;
         |GRABA 020#3n;

         |REPON_FICHA #3;

         |SI #0#70 = "D";
             aAlfa = "P" + "P" + (("000" + nPorceT) % -103) + (("               " + #3#36) % -115);
             #3#47 = aAlfa;
             |SI #910#24 = "N";
                   #3#36 = nPreBlanco;
             |SINO;
                   #3#36 = nTotalBlanco / #3#5;
             |FINSI;
         |SINO;
             aAlfa = "P" + "P" + (("000" + nPorceT) % -103) + (("               " + #3#6) % -115);
             #3#47 = aAlfa;
             |SI #910#24 = "N";
                   #3#6 = nPreBlanco;
             |SINO;
                   #3#6  = nTotalBlanco / #3#5;
             |FINSI;
         |FINSI;
         |GRABA 020#3a;
         |LIBERA #3;
     |SINO;
         |SI #0#70 = "D";
             nCanti = #3#36;
         |SINO;
             nCanti = #3#6;
         |FINSI;
         ||nCanti = nCanti * nDecimal;
         nCanti = (nCanti * nDecimal) ! 0; || Tiquet 1908/517
         |HAZ Reparto;
         nCanti = nCanti / nDecimal;
         nCantiBlanco = nCantiBlanco / nDecimal;

         |SALVA_FICHA #3;

         #3#29 = #4#199;
         #3#0  = enCodAlbNegro;
         |SI #0#70 = "D";
             #3#36 = nCanti - nCantiBlanco;
             aAlfa = "P" + "N" + (("000" + nPorceT) % -103);
             #3#47 = aAlfa;
         |SINO;
             #3#6  = nCanti - nCantiBlanco;
             aAlfa = "P" + "N" + (("000" + nPorceT) % -103);
             #3#47 = aAlfa;
         |FINSI;
         |SI aExporNegro = "S"; #3#11 = 0; |FINSI;
         |GRABA 020#3n;

         |REPON_FICHA #3;

         |SI #0#70 = "D";
             aAlfa = "P" + "P" + (("000" + nPorceT) % -103) + (("               " + #3#36) % -115);
             #3#47 = aAlfa;
             #3#36 = nCantiBlanco;
         |SINO;
             aAlfa = "P" + "P" + (("000" + nPorceT) % -103) + (("               " + #3#6) % -115);
             #3#47 = aAlfa;
             #3#6  = nCantiBlanco;
         |FINSI;
         |GRABA 020#3a;
         |LIBERA #3;
     |FINSI;
|FPRC;

|PROCESO LineasKitNeg;
     #947#0 = #4#199;
     #947#1 = enCodAlbNegro;
     |GRABA 020#947n;
|FPRC;

|DEFBUCLE LineasKitNeg;
     #947#1;
     ;
     #3#29, #3#0, #3#1, 001;
     #3#29, #3#0, #3#1, 999;
     ;
     NULL, LineasKitNeg;
|FIN;

|PROCESO LineasBlancas;
     |LEE 101#3=;
     aAlfa         = #3#47 % 303;
     nPorceT       = aAlfa;
     nPorce        =  ((100 - nPorceT) / 100);
     nMasMenos     = 0;
     nAcumula      = 0;
     nTCantiBlanco = 0;
     nMasMenos     = 0;
     |SI nAcumTot = 0; |Y #4#198 = "X";
          |SI nPrime = 0;
               nPrime = 1;
               nPorcOfi = nPorceT;
               |SI nModo = 1;
                    #119#0 = nPorcOfi;
               |SINO;
                    #119#0 = 100 - nPorcOfi;
               |FINSI;
               |PUSHV 0501 2380;
               |BLANCO 1327 1954;
               |PINPA #0#119;
               |PINDA #0#119;
               |ENDATOS #1#119;
               |SI FSalida = 0;
                    nPorcOfi = 100 - #119#0;
               |SINO;
                    |SI nModo = 1; nPorcOfi = 100 - #119#0; |FINSI;
               |FINSI;
               |POPV;
          |SINO;
               nPorcOfi = 100 - #119#0;
          |FINSI;
     |FINSI;

     |ABRE #2;
     #2#0 = #3#2;
     |LEE 000#2=;
     |SI FSalida ! 0;  |DDEFECTO #2;  |FINSI;
     |CIERRA #2;

     |SI #4#198 = "U";   |HAZ PorUnidad;  |FINSI;
     |SI #4#198 = "P";   |HAZ PorPrecio;  |FINSI;

     |SI #4#198 = "A"; |O #4#198 = " ";
         |SI #2#178 = " ";  #2#178 = "U";    |FINSI;
         |SI #2#178 = "U";  |HAZ PorUnidad;  |FINSI;
         |SI #2#178 = "P";  |HAZ PorPrecio;  |FINSI;
     |FINSI;
     |SI #4#198 = "X"; |HAZ PorProporcion; |FINSI;

     eaArticulo = #3#2;
     |HAZ EsKit;
     |SI FSalida = 0;
          |BUCLE LineasKitNeg;
     |FINSI;
|FPRC;

|PROCESO DesgloseAlb;
     nAcumA = 0;
     nAcumB = 0;
     nAcumTot = 0;
     nNumLin = 0;

     |SI #0#70 = "D";
          aAlfa = "0" * nDeci_PreDiv;
     |SINO;
          aAlfa = "0" * nDeci_PreBase;
     |FINSI;
     aAlfa = "1" + aAlfa;
     nDecimal = aAlfa;

     |ABRE #4;
     #4#0 = #0#3;
     |LEE 040#4=;
     |SI FSalida ! 0;  |DDEFECTO #4;  |FINSI;
     |CIERRA #4;

     |ABRE #40;
     #40#26 = #4#199;
     |LEE 000#40=;
     |SI FSalida ! 0; |DDEFECTO #40; |FINSI;
     |CIERRA #40;
     aExporNegro = #40#30;

     aSerAlbBlanco = #0#52;
     nCodAlbBlanco = #0#0;

     |SALVA_FICHA #0;

     |SI #0#87 = 0;
          |SI #41#103 = "S";
              enCodAlbNegro = nCodAlbBlanco;
              nError        = 0;

              #0#52 = #4#199;
              #0#0  = enCodAlbNegro;
              |LEE 040#0=;
              |SI FSalida = 0;
                  |MENAV "     La Codigo en el Albaran de Desglose YA EXISTE";
                  |MENAV "     NO VOY a CREAR el ALBARAN de DESGLOSE";
                  |REPON_FICHA #0;
                  nError = 1;
                  |ACABA;
              |FINSI;
          |SINO;
              |SALVA_DATOS #0;
              |PARA FSalida = 0; |SI FSalida = 0; |HACIENDO;
                   enSwMenu = 1;
                   |HAZ ContadorNegro;
                   #0#52 = #4#199;
                   #0#0  = enCodAlbNegro;
                   |LEE 040#0=;
              |SIGUE;
              |REPON_DATOS #0;
          |FINSI;
     |SINO;
          |SI #41#103 = "S";
              enCodAlbNegro = #0#0;
          |SINO;
              enCodAlbNegro = #0#87;
          |FINSI;
     |FINSI;

     #0#52 = #4#199;
     #0#0  = enCodAlbNegro;
     #0#8  = #4#200;
     #0#85 = "X";
     #0#86 = aSerAlbBlanco;
     #0#87 = nCodAlbBlanco;
     #0#5  = #4#201;
     |GRABA 020#0n;

     |REPON_FICHA #0;
     #0#86 = #4#199;
     #0#87 = enCodAlbNegro;

     nPrime = 0;
     |BUCLELIN 0LineasBlancas#0;
|FPRC;

|RUTINA Final;
     caltot   = 1;
     recalpre = 1;
     |HAZ actal;

     enImpRiesgo =       #0#16 + #0#17 + #0#18 + #0#19 + #0#20 + #0#21 + #0#22 + #0#23;
     enImpRiesgo = enImpRiesgo + #0#44 + #0#45 + #0#46 + #0#47 + #0#48 + #0#49 + #0#28;
     |SALVA_FICHA #0;

     #0#52 = #4#199;
     #0#0  = enCodAlbNegro;
     |LEE 101#0=;
     |SI FSalida = 0;
          |HAZ actal;
          |GRABA 020#0a;
          enImpRiesgo = enImpRiesgo + #0#16 + #0#17 + #0#18 + #0#19 + #0#20 + #0#21 + #0#22 + #0#23;
          enImpRiesgo = enImpRiesgo + #0#44 + #0#45 + #0#46 + #0#47 + #0#48 + #0#49 + #0#28;
     |FINSI;

     |REPON_FICHA #0;
|FRUT;

|PROCESO CargaTempo;
     #1016#0 = #3#1;
     #1016#1 = #3#2;
     #1016#2 = #3#4;
     aAlfa   = #3#47 % 303;
     #1016#3 = aAlfa;
     |GRABA 020#1016n;
     |LIBERA #1016;
|FPRC;

|RUTINA ClaveBaja1016;
     #1016#0 = 1;
|FRUT;

|RUTINA ClaveAlta1016;
     #1016#0 = 999;
|FRUT;

|PROCESO GrabaLinBlancas;
     #3#29 = #0#52;
     #3#0  = #0#0;
     #3#1  = #1016#0;
     |LEE 101#3=;
     |SI FSalida = 0;
         aAlfa1 = #3#47 % 102;
         aAlfa2 = ("000" + #1016#3) % -103;
         aAlfa3 = #3#47 % 625;
         #3#47 = aAlfa1 + aAlfa2 + aAlfa3;
         |GRABA 020#3a;
         |LIBERA #3;
     |FINSI;
|FPRC;

|DEFBUCLE dsw00016;
     #1016#1;
     ;
     001;
     999;
     ;
     NULL, GrabaLinBlancas
|FIN;

|PROCESO Carga1016;
     |HAZ CreaTempo; aTempo1016 = Tempo;
     |NOME_DAT #1016 aTempo1016; |DELINDEX #1016;

     |ABRE #1016;
     |BUCLELIN 0CargaTempo#0;
     |CIERRA #1016;

     |ABRE #4;
     #4#0 = #0#3;
     |LEE 020#4=;
     |CIERRA #4;

     |SI #4#198 ! "X";
          |PUSHV 0501 2380;
          |PINPA #0#1016;
          |ENTLINEAL #1#1016, 1, 4, 20, 0, ClaveBaja1016, ClaveAlta1016;
          |POPV;
     |FINSI;

     |ABRE #3;
     |BUCLE dsw00016;
     |CIERRA #3;

     |DELINDEX #1016; Tempo = aTempo1016; |HAZ BoraTempo;
|FPRC;

|PROCESO siimpre; |TIPO 3;
     |SI nSwError ! 0; |ERROR; |ACABA; |FINSI;

     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 4; |ACABA; |FINSI;

     aSerAntes = "";         || Inicializa variables
     nNumAntes = 0;          || de adj. anterior

     |BUCLELIN 2 ModiHistoAV #0;

     |SI #0#85 = "E";
          |HAZ Carga1016;
          |SI #0#70 = "B"; nCamPre = 7; |SINO; nCamPre = 13; |FINSI;
          |SI #0#70 = "B"; nCamTot = 8; |SINO; nCamTot = 14; |FINSI;
          |HAZ DesgloseAlb;

          enImpRiesgo =       #0#16 + #0#17 + #0#18 + #0#19 + #0#20 + #0#21 + #0#22 + #0#23;
          enImpRiesgo = enImpRiesgo + #0#44 + #0#45 + #0#46 + #0#47 + #0#48 + #0#49 + #0#28;

          |SI nError = 0;  |HAZ Final;  |FINSI;

          eaTag = "AV";  |HAZ Riesgos;
     |FINSI;
|FPRC;

|PROCESO Ti30; |TIPO 30;
     |SI #41#86 = "X";
         |HAZ apagar;
     |FINSI;

     |SI enSwNoImp = 0;
          |CONFI "2400NDesea imprimir este albaran? ";
     |SINO;
          FSalida = -1;
     |FINSI;

     |SI FSalida = 0;
         |HAZ impreal;
     |FINSI;

     |MODULO puente;     |QBF puente;
     |SI #41#17 = "S"; |Y #0#51 = "S"; |Y puente = "legiz006";
          |SI #41#19 = "S";
               |CONFI "2400NDesea Facturar este Albaran : ";
               |SI FSalida ! 0;  |ACABA;  |FINSI;
          |FINSI;

          |GRABA 021#0a;
          |LIBERA #0;
          |CIERRAT #0;

          ser_alb = #0#52;
          num_alb = #0#0;
          fec_alb = #0#1;
          abo_alb = #0#43;

          |PUSHV 0101 2480;
          |SUB_EJECUTA_NP "agifa057";       ||Facturar Albaranes
          |POPV;
          |ABRET #0;
          #0#0 = num_alb;
          #0#52 = ser_alb;
          |LEE 101#0=;
     |FINSI;
|FPRC;

|PROCESO VuelveAlSitioC;
     |SI aAlfa1 = "U"; |O aAlfa1 = "X";
         #905#6 = #905#10;
     |SINO;
          |SI #0#70 = "B";
               #905#7 = #905#10;
          |SINO;
               #905#13 = #905#10;
          |FINSI;
     |FINSI;
     |HAZ PreReparto;
     |GRABA 020#905a;
     |LIBERA #905;
|FPRC;

|DEFBUCLE dsm00005A;
     #905#1;
     ;
     "AV", #3#29, #3#0, nLinV, "      ";
     "AV", #3#29, #3#0, nLinV, "zzzzzz";
     be;
     NULL, VuelveAlSitioC;
|FIN;

|PROCESO VuelveAlSitio;
     |LEE 101#3=;

     #2#0 = #3#2;
     |LEE 000#2=;

     aAlfa1 = #3#47 % 101;
     aAlfa2 = #3#47 % 615;
     aAlfa3 = #3#47 % 303;
     aAlfa4 = #3#47 % 2115;
     nPorce = aAlfa3;
     nPorce = ((100 - nPorce) / 100);
     |SI aAlfa1 = "X";
          nNume = aAlfa2 + aAlfa4;
          #3#5 = nNume;
     |FINSI;
     |SI aAlfa1 = "U";
          |SI #2#179 = "S";
               #3#5 = aAlfa2;
               #3#48 = aAlfa4;
               #3#50 = #3#50 / nPorce;
          |SINO;
               #3#5 = aAlfa2;
          |FINSI;
     |FINSI;
     |SI aAlfa1 = "P";
          |SI #0#70 = "B";
               #3#6 = aAlfa2;
          |SINO;
               #3#36 = aAlfa2;
          |FINSI;
     |FINSI;

     nLinV = #3#1;
     |BUCLE dsm00005A;

     |GRABA 020#3a;
     |LIBERA #3;
|FPRC;

|PROCESO BorraEl905;
     |BORRA 020#905a;
     |LIBERA #905;
|FPRC;

|DEFBUCLE dsm00005B;
     #905#1;
     ;
     "AV", #3#29, #3#0, nLinV, "      ";
     "AV", #3#29, #3#0, nLinV, "zzzzzz";
     be;
     NULL, BorraEl905;
|FIN;

|PROCESO BorraEl3;
     |LEE 101#3=;
     nLinV = #3#1;
     |BUCLE dsm00005B;

     |BORRA 020#3a;
     |LIBERA #3;
|FPRC;

|PROCESO BorraKitNeg;
     |BORRA 020#947a;
|FPRC;

|DEFBUCLE BorraKitNeg;
     #947#1;
     ;
     #3#29, #3#0, 001, 001;
     #3#29, #3#0, 999, 999;
     be;
     NULL, BorraKitNeg;
|FIN;

|RUTINA BajaDesglose;
     |SI #0#85 ! "E";  |ACABA;  |FINSI;
     |SI #0#87 = 0;    |ACABA;  |FINSI;

     nSwError = 0;
     |SALVA_FICHA #0;
     #0#52 = #0#86;
     #0#0  = #0#87;
     |LEE 101#0=;
     |SI FSalida = 0;
         |SI #0#38 = "S";
             |MENAV "2400 Parte del Albaran ya esta Facturado.";
             nSwError = 1;
             |ACABA;
         |FINSI;

          enImpRiesgo =       #0#16 + #0#17 + #0#18 + #0#19 + #0#20 + #0#21 + #0#22 + #0#23;
          enImpRiesgo = enImpRiesgo + #0#44 + #0#45 + #0#46 + #0#47 + #0#48 + #0#49 + #0#28;

         |BUCLELIN 0 BorraEl3 #0;  || No se pone con NULL porque actualizaria.
         |BUCLE BorraKitNeg;
         |BORRA 020#0a;
         |LIBERA #0;

     |FINSI;
     |REPON_FICHA #0;
     |LEE 121#0=;             || aseguramos el bloqueo del albaran principal!

     enImpRiesgo = enImpRiesgo + #0#16 + #0#17 + #0#18 + #0#19 + #0#20 + #0#21 + #0#22 + #0#23;
     enImpRiesgo = enImpRiesgo + #0#44 + #0#45 + #0#46 + #0#47 + #0#48 + #0#49 + #0#28;

     nDeci_TBas = nDeci_Base;
     nDeci_TDiv = nDeci_Div;
     nDeci_PBas = nDeci_PreBase;
     nDeci_PDiv = nDeci_PreDiv;
     |ABRE #2;
     |BUCLELIN 0 VuelveAlSitio #0;
     |CIERRA #2;

     caltot   = 1;
     recalpre = 1;
     |HAZ actal;

     |PINTA #0#77;
     |PINTA #0#78;
|FRUT;

|RUTINA AdjDesdeCliente;
     modo = (FEntrada / 100) ! 0;
     |SI modo ! 1;  |ACABA;  |FINSI;

     enTipo = 0;
     pedido  = 0;
     ser_ped_inf = "     ";
     ser_ped_sup = "zzzzz";
     |SUB_EJECUTA_NP "agit0001";
     |SI pedido = 0;
         enPedCab = 0;
         |ERROR;
         |ACABA;
     |FINSI;
     enPedCab = pedido;
     #0#3 = cliente; |PINTA #0#3;
     |ABRE #4; #4#0 = #0#3; |LEE 000#4=; |CIERRA #4;
     |DEFECTO #0#4;
     |PTEC 802;     || intro
     |PTEC 802;     || intro
     |PTEC 824;     || F2
     |PTEC 802;     || intro
     |PTEC 815;     || avpag
     |PTEC 802;     || intro
     |PTEC 802;     || intro
|FRUT;

|PROCESO Tipo210_6; |TIPO 6;
     nTecla = FSalida;
     nError6 = 0;

     |ABRE #4;
     #4#0 = #0#3;
     |LEE 000#4=;
     |CIERRA #4;
     |SI #0Campo ! Contenido;
          |ABRE #39;
          #39#0 = #0#3;
          #39#1 = #0#84;
          |LEE 000#39=;
          |CIERRA #39;
          |HAZ AsignaDir210;
     |FINSI;

     alfa = #0#3; |QBF alfa;
     |SI alfa ! ""; |Y Campo = 3;
          |ABRE #4;
          #4#0 = #0#3;
          |LEE 000#4=;
          |SI FSalida ! 0; |Y #41#1 = "S";
               |HAZ Menusg;
          |FINSI;
          |CIERRA #4;
     |FINSI;

     |HAZ alriesgo1;
     |SI nError6 ! 0; |ERROR; |ACABA; |FINSI;
|FPRC;

|PROCESO Tipo210_0; |TIPO 0;
     enPedCab = 0;
     nModo210 = (FEntrada / 100) ! 0;
     |ABRE #41; |LEE 000#41p; |CIERRA #41;

     |ABRE #4;
     #4#0 = #0#3;
     |LEE 000#4=;
     |CIERRA #4;

     cli = #0#3;
     ser = #0#52;
     |SUB_EJECUTA_NP "agifv011.tab;por_ejemplo";

     |SI nTecla = 11; |O #41#102 = "S"; |O #41#102 = "X";
          eaCodigo = #0#3;
          eaFuerza = "N";
          |SI nTecla = 11; eaFuerza = "S"; |FINSI;
          |SUB_EJECUTA_NP "dsz99994";
          |SI #41#102 = "N"; |Y nModo210 ! 2; |ERROR;  |FINSI;
     |FINSI;

     |SI nTecla = 13;
         nTecla = 0;
         FSalida = 0;
         |HAZ AdjDesdeCliente;
     |FINSI;

     nTecla = 0;

     |HAZ CambioDivisa4;

     |HAZ Pago7_210;

     |SI nModo = 1; |Y #4#28 = "S"; || Cliente Exporacion
          #0#12 = 0; |PINTA #0#12;
          #0#14 = 0; |PINTA #0#14;
     |FINSI;
|FPRC;

|PROCESO Dto210_7; |TIPO 7;
|FPRC;

|PROCESO FPago210; |TIPO 0;
|FPRC;

|PROCESO Tipo10_20; |TIPO 20;
     |SI FSalida ! "OPCION";
          |SELECT #1#0;
          |LEE 000#0=;
          |SI FSalida ! 0;
               |MENAV "0000Por favor, consulte el registro correcto antes de imprimir.";
               |ACABA;
          |SINO;
               |PINDA #0#0;
          |FINSI;
     |FINSI;
     |HAZ T210_20;
|FPRC;

|PROCESO T210_20;
     aAlfa = FSalida;

     FSalida = aAlfa;

     |SI FSalida = "OPCION";
          FSalida = " Imprimir "; || La estandar
          |ACABA;
     |FINSI;

     || La estandar
     |HAZ impreal;
|FPRC;

|PROCESO TecaAgen; |TIPO 7;
|FPRC;

|PROCESO AsignaDir210;
     ||#0#4 = #39#10;   |PINTA #0#4;
     #0#29 = #39#10;  |PINTA #0#29;
     #0#30 = #39#2; |PINTA #0#30;
     #0#31 = #39#3; |PINTA #0#31;
     #0#33 = #39#7; |PINTA #0#33;
     #0#62 = #39#6; |PINTA #0#62;
     #0#84 = #39#1; |PINTA #0#84;
     |SI #39#14 = "  ";
         #0#6 = #4#25;
     |SINO;
         #0#6 = #39#14;
     |FINSI;
     |PINTA #0#6;
|FPRC;

|PROCESO MinDir210;
     #39#0 = #0#3;
     #39#1 = 1;
|FPRC;

|PROCESO MaxDir210;
     #39#0 = #0#3;
     #39#1 = 9999;
|FPRC;

|PROCESO Dir210_0; |TIPO 0;
     |SI enErrRie ! 0; |ERROR; |ACABA; |FINSI;
     |SI FSalida = 2; |ACABA; |FINSI;
     nTecla = FSalida;
     |SI nTecla = 12;    || F4 Alta direccion
          |PUSHV 0501 2380;
          |ENTLINEAL #1#39, -2, 1, 22, 1, MinDir210, MaxDir210;
          |POPV;
          nTecla = 18;
     |FINSI;
     |ABRE #39;
     |SI nTecla = 18;   || F10  Todas las direcciones
          #39#0 = #0#3;
          #39#1 = #0#84;
          |LEE 000#39];
          |CONSULTA_F_CLAVE #1#39, MinDir210, MaxDir210;
          |SI FSalida = 0;
               |HAZ AsignaDir210;
          |SINO;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;
     #39#0 = #0#3;
     #39#1 = #0#84;
     |LEE 000#39=;
     |SI FSalida = 0;
          |SI #39#18 = "N";
               |CONFI "0000NDireccion de entrega desactiva. ¨Continuar?";
               |SI FSalida ! 0; |ERROR; |ACABA; |FINSI;
          |FINSI;
     |SINO;
          |MENAV "0000No existe direccion de entrega...";
          |ERROR; |ACABA;
     |FINSI;
     |CIERRA #39;
     |SI #0Campo ! Contenido;
          |HAZ AsignaDir210;
     |FINSI;
|FPRC;

|PROCESO Dir210_7; |TIPO 7;
     |SI #41#71 = "S";
          |ABRE #39;
          #39#0 = #0#3;
          #39#1 = 1;
          |LEE 000#39];
          |SI FSalida = 0; |Y #39#0 = #0#3;
               |LEE 000#39s;
               |SI FSalida = 0; |Y #39#0 = #0#3;
                    aSinError = "S";
                    |HAZ Dir210_66;
                    aSinError = "N";
                    |SI nSal = 0; |ERROR; |FINSI;
               |FINSI;
          |FINSI;
          |CIERRA #39;
     |FINSI;
|FPRC;

|PROCESO Repre210_7; |TIPO 7;
     |SI nTecla = 0; |O nTecla = 3;
          |SI PARAMETRO = "primicias"; |PTEC 806; |FINSI;
          |SI PARAMETRO = "vallcorba"; |PTEC 806; |FINSI;
     |FINSI;
|FPRC;

|PROCESO Dir210_66; |TIPO 66;
     nModo = (FEntrada / 100) ! 0;
     |ABRE #39;
     aSql = "SELECT * FROM dsm00003 INTO sq" + Usuario + ".def WHERE ";
     aSql = aSql + "0 == " + #0#3 + " AND 18 == S";
     |SQL aSql;
     |SI FSalida = 0;
          |DDEF aDef; |QBF aDef;
          aDef = aDef + "sq" + Usuario + ".mas";
          |CARGA_DEF aDef, referen@;
          |SI FSalida = 0;
               |ABRE #referen@;
               #referen@#0 = #0#3;
               #referen@#1 = #0#84;
               |LEE 000#referen@.]
               |CONSULTA_CLAVE #1#referen@;
               nSal = FSalida;
               |SI FSalida = 0;
                    |SI nModo ! 2; |O #referen@#0 ! #0#3; |O #referen@#1 ! #0#84;
                         #39#0 = #referen@#0;
                         #39#1 = #referen@#1;
                         |LEE 020#39=;
                         |HAZ AsignaDir210;
                    |FINSI;
               |SINO;
                    |SI aSinError ! "S";
                         |ERROR;
                    |FINSI;
               |FINSI;
               |CIERRA #referen@;
               |DELINDEX #referen@;
               |DESCARGA_DEF #referen@;
               |FBORRA aDef;
          |FINSI;
     |FINSI;
     |CIERRA #39;
|FPRC;

|PROCESO Pago7_210; |TIPO 7;
|FPRC;

|PROCESO Observa7; |TIPO 7;
     aAlfa = "0000Observacion 1";

     |HAZ EsInmMarro;
     |SI FSalida = 0;
          aAlfa = "0000Matricula           <F11> Consulta";
          |C_M #0#55, 1, "S";
     |FINSI;

     |MENSA aAlfa;
|FPRC;

|PROCESO Observa0; |TIPO 0;
|FPRC;

|PROCESO Observa66; |TIPO 66;
|FPRC;

|PROCESO Portes210; |TIPO 0;
|FPRC;

|PROCESO IVA210_66; |TIPO 66;
     enTiva = #0Campo;
     efFiva = #0#1;
     |HAZ ConsuIVA;
     |SI eaDiva = "";
          |ERROR;
     |SINO;
          #0Campo = enTiva; |PINTA #0Campo;
     |FINSI;
|FPRC;

|PROCESO IVA210_0; |TIPO 0;
     enTiva = #0Campo;
     efFiva = #0#1;
     |HAZ SacaIVA;
     |SI eaDiva = "";
          |MENAV "0000No existe tipo iva para esta fecha...";
          |ERROR; |ACABA;
     |SINO;
          |HAZ caltotal4;
     |FINSI;
|FPRC;
|PROCESO Bultos210; |TIPO 0;
     |SI #0#2 ! 0;
          |HAZ EsVigor;
          |SI FSalida = 0;
               enModo = (FEntrada / 100) ! 0;
               eaSerie = #0#52;
               enCodigo = #0#0;
               |SUB_EJECUTA_NP "vigm0048";
               #0#55 = eaAlfa % 0110; |PINTA #0#55;
               #0#56 = eaAlfa % 1130; |PINTA #0#56;
               #0#57 = eaAlfa % 4110; |PINTA #0#57;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO dif;
    #500#2 = #500#0 - #500#1;
    |PINTA #500#2;
|FPRC;

|PROCESO dif2;
    #500#1 = #500#0 - #500#2;
    |PINTA #500#1;
|FPRC;

|PROCESO apagar;
     |ABRE #agis0002;
     |DDEFECTO #agis0002;
     #agis0002#30 = "A";
     #agis0002#20 = #legiz006#52;
     #agis0002#17 = #legiz006#0;
     #agis0002#18 = 01;
     |LEE 101#agis0002.=;
     |SI FSalida = 0;
        |BORRA 020#agis0002.a;

        |DBASS aPath;
        aPath = aPath + "dscarter/";
        aDef00 = aPath + "def/dscamrec";
        |CARGA_DEF aDef00, dscamrec@;
        |SI FSalida ! 0;
           aMensa = "0000Error al cargar:" + aDef00;
           |MENAV aMensa;
           aDef00 = "";
        |SINO;
           |HAZ CreaTempo; aTempo600 = Tempo;
           |PATH_DAT #600 aPath; |NOME_DAT #600 aTempo600; |DELINDEX #600;
           |ABRE #600;
           aCPath = aPath; aCNome = aTempo600;
        |FINSI;
        |DFICE Comodin;
        Comodin = Comodin % -106;
        Comodin = Comodin % 0105;
        Divisa     = #legiz006#68;
        CambioBase = #legiz006#69;
        CambioDiv  = #legiz006#74;

        #agifa324#0 = Divisa;
        |LEE 000#agifa324.=;
        |SI FSalida ! 0; |DDEFECTO #agifa324; |FINSI;

        |DDEFECTO #dscamrec@;
        #600#1  = #legiz006#52;||Serie
        #600#2  = #legiz006#0; ||Fact
        #600#3  = #agis0002#18;||N§ Rec
        #600#4  = #agis0002#8; ||F.V
        #600#5  = #agis0002#7; ||F.E
        #600#6  = #agis0002#12;||Cuenta Cli
        #600#7  = #agis0002#3; ||Nom Cli
        #600#8  = #agis0002#4; ||Nom Banco
        #600#9  = #agifa024#32;      ||Entidad
        #600#10 = #agifa024#33;      ||Sucursal
        #600#11 = #agifa024#31;      ||DC
        #600#12 = #agifa024#30;      ||Cuenta
        #600#13 = #agis0002#22;||Tipo Rec
        #600#15 = #agis0002#9; ||Importe
        #600#16 = #agis0002#15;||A aceptar
        #600#17 = #agis0002#6; ||Aceptado
        #600#18 = #agis0002#2; ||Cliente
        #600#21 = #agifa024#3; ||Zona
        #600#22 = 1;           ||Documento
        #600#25 = Comodin;     ||Empresa ges
        #600#27 = "V";         ||Tipo
        #600#28 = "B";         ||Ope
        #600#29 = #agifa324#0; ||Divisa
        #600#30 = #agifa324#1; ||Nombre
        #600#31 = CambioDiv;   ||Cambio Divisa
        #600#32 = CambioBase;  ||Cambio Base
        #600#33 = #agifa024#203;
        #600#34 = 0;
        #600#35 = "A";
        #600#36 = #agis0002#28;
        #600#38 = #agis0002#16;
        #600#39 = #agis0002#10;
        |GRABA 020#600n;

        |SUB_EJECUTA_NP aSubProg;

        |SI aDef00 ! "";
          |CIERRA #600;
          |DELINDEX #600;
          |DESCARGA_DEF #dscamrec@;
        |FINSI;

        #agis0002#9 = -#agis0002#9;

        |SI #0#51 = "S";    || Facturable
            eaTag = "RAA"; |HAZ Riesgos;
        |FINSI;
     |FINSI;
     |CIERRA #agis0002;

     |PUSHV 0501 2380;
     |BLANCO 0923 1758;
     |PINPA #0#500;
     #500#0 = #0#78;
     #500#1 = #0#61;
     #500#2 = #500#0 - #500#1;
     |PINDA #0#500;
     |ENDATOS #1#500;
     |SI FSalida = 0;
          #0#61 = #500#1;
          |GRABA 020#0a;
     |FINSI;
     |POPV;
     |SI nModo ! 1;|PINTA #0#61; |FINSI;

     |SI #500#1 = 0; |ACABA; |FINSI;

     nLinea = 0;
     |ABRE #agis0002;
     |DDEFECTO #agis0002;
     #agis0002#30 = "A";
     #agis0002#20 = #legiz006#52;
     #agis0002#17 = #legiz006#0;
     #agis0002#18 = 01;
     |LEE 000#agis0002.=;
     |SI FSalida ! 0;
        |DDEFECTO #agis0002;
        #agis0002#30 = "A";
        #agis0002#20 = #legiz006#52;
        #agis0002#17 = #legiz006#0;
        #agis0002#18 = 1;
        #agis0002#1  = 1;
        #agis0002#2  = #legiz006#3;
        #agis0002#3  = #legiz006#4;
        #agis0002#4  = #agifa024#29;
        #agis0002#7  = #legiz006#1;
        #agis0002#8  = #legiz006#1;
        |SI #0#43 = "S";
              #agis0002#9 = -#legiz006#61;
        |SINO;
              #agis0002#9 = #legiz006#61;
        |FINSI;
        #agis0002#12 = #agifa024#16;
        #agis0002#19 = #legiz006#52;
        #agis0002#24 = #legiz006#8;
        |GRABA 020#agis0002.c;
     |FINSI;
     |CIERRA #agis0002;

     |DBASS aPath;
     aPath = aPath + "dscarter/";
     aDef00 = aPath + "def/dscamrec";
     |CARGA_DEF aDef00, dscamrec@;
     |SI FSalida ! 0;
        aMensa = "0000Error al cargar:" + aDef00;
        |MENAV aMensa;
        aDef00 = "";
     |SINO;
        |HAZ CreaTempo; aTempo600 = Tempo;
        |PATH_DAT #600 aPath; |NOME_DAT #600 aTempo600; |DELINDEX #600;
        |ABRE #600;
        aCPath = aPath; aCNome = aTempo600;
     |FINSI;
     |DFICE Comodin;
     Comodin = Comodin % -106;
     Comodin = Comodin % 0105;
     Divisa     = #legiz006#68;
     CambioBase = #legiz006#69;
     CambioDiv  = #legiz006#74;

     |ABRE #agifa324;
     #agifa324#0 = Divisa;
     |LEE 000#agifa324.=;
     |SI FSalida ! 0; |DDEFECTO #agifa324; |FINSI;
     |CIERRA #agifa324;

     nDeci_Div = #agifa324#7;
     |DDEFECTO #dscamrec@;
     #600#1  = #legiz006#52;||Serie
     #600#2  = #legiz006#0; ||Fact
     #600#3  = #agis0002#18;||N§ Rec
     #600#4  = #agis0002#8; ||F.V
     #600#5  = #agis0002#7; ||F.E
     #600#6  = #agis0002#12;||Cuenta Cli
     #600#7  = #agis0002#3; ||Nom Cli
     #600#8  = #agis0002#4; ||Nom Banco
     #600#9  = #agifa024#32;      ||Entidad
     #600#10 = #agifa024#33;      ||Sucursal
     #600#11 = #agifa024#31;      ||DC
     #600#12 = #agifa024#30;      ||Cuenta
     #600#13 = #agis0002#22;||Tipo Rec
     #600#15 = #agis0002#9; ||Importe
     #600#16 = #agis0002#15;||A aceptar
     #600#17 = #agis0002#6; ||Aceptado
     #600#18 = #agis0002#2; ||Cliente
     #600#21 = #agifa024#3; ||Zona
     #600#22 = 1;           ||Documento
     #600#25 = Comodin;     ||Empresa ges
     #600#27 = "V";         ||Tipo
     #600#28 = "A";         ||Ope
     #600#29 = #agifa324#0; ||Divisa
     #600#30 = #agifa324#1; ||Nombre
     #600#31 = CambioDiv;   ||Cambio Divisa
     #600#32 = CambioBase;  ||Cambio Base
     #600#33 = #agifa024#203;
     #600#34 = 0;
     #600#35 = "A";
     #600#36 = #agis0002#28;
     #600#38 = #agis0002#16;
     #600#39 = #agis0002#10;
     |GRABA 020#600n;

     |SUB_EJECUTA_NP aSubProg;

     |SI aDef00 ! "";
          |CIERRA #600;
          |DELINDEX #600;
          |DESCARGA_DEF #dscamrec@;
     |FINSI;

     |SI #0#51 = "S";    || Facturable
          eaTag = "RAA"; |HAZ Riesgos;
     |FINSI;
     |CIERRA #agis0002;
|FPRC;
