|FICHEROS;
     agifa081 #0;
     agifa019 #19;
     agifa067 #3;
|FIN;

|VARIABLES;
     nImporDescue1 = 0;
     nImporDescue2 = 0;
     nImporDescue3 = 0;
     nImporMoneda1 = 0;
     nImporMoneda2 = 0;
     nBrutoMoneda1 = 0;
     nBrutoMoneda2 = 0;
     nNume7    = 0;
     &nDeci_DivP = 0;
     &nDeci_BaseMxP = 0;
     nImpo     = 0;
     nImpDiv   = 0;
     nMult     = 0;
     nPPort1   = 0;
     nPPort2   = 0;
     nPend     = 0;
     nNume11   = 0;
     aAlfa = "";
     nPreTon = 0;
|FIN;

|PROCESO TotalesDiv81;
     |SI #0#29 = "D";
          #0#37 = #0#34;
          #0#38 = #0#35;
          #0#39 = #0#36;
          #0#40 = #0#11;
          #0#41 = #0#12;
          #0#42 = #0#13;
     |SINO;
          #0#37 = #0#11;
          #0#38 = #0#12;
          #0#39 = #0#13;
          #0#40 = #0#34;
          #0#41 = #0#35;
          #0#42 = #0#36;
     |FINSI;
|FPRC;

|CALCULO LineasPedido;
     #3#20 = #0#4;
     #3#23 = #0#5;
     #3#24 = #0#6;
     #3#25 = #0#17;
     #3#26 = #0#9;

     |HAZ TotalLin67;
     #3#18 = #19#2;

     #0#11 = #0#11 +. #3#9;
     #0#12 = #0#12 +. #3#11;
     #0#13 = #0#11 - #0#12;
     #0#44 = #0#44 +. #3#56;

     |SI #0#29 = "D";                    || Si la moneda de trabajo es la divisa ...
          nPPort2 = #3#50;
     |SINO;
          nPPort2 = #3#50 / #0#33 * #0#28;
     |FINSI;

     |SI #19#196 = 2;
         nPend = (#3#41 - #3#38) * #3#33 / nPreTon;
     |SINO;
         nPend = (#3#5 - #3#38) * #3#33 / nPreTon;
     |FINSI;

     nPend = ((nPend < #3#8) < #3#27) < #3#57;

     |SI #19#196 = 2;
         nPend = nPend + ((#3#41 - #3#38) * nPPort2) / nPreTon;
     |SINO;
         nPend = nPend + ((#3#5  - #3#38) * nPPort2) / nPreTon;
     |FINSI;
     nPend = nPend ! nDeci_BaseMxP;
/*
     nPend = (nPend < #0#5) ! nDeci_BaseMxP;
     nPend = (nPend < #0#17) ! nDeci_BaseMxP;
     nPend = (nPend < #0#6) ! nDeci_BaseMxP;
*/
     nBrutoMoneda1 = nPend;
     nImporDescue1 = (nBrutoMoneda1 % #0#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #0#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #0#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     nPend = nBrutoMoneda1;


     #0#34 = #0#34 +. #3#34;
     #0#35 = #0#35 +. nPend;
     #0#36 = #0#34 - #0#35;
     #0#36 = #0#34 - #0#35;
     |SI #3#58 = -1;
          #0#46 = #0#46 + #3#9;
     |FINSI;

     |HAZ TotalesDiv81;

     |GRABA 020#3a;
     |LIBERA #3;
|FCAL;

|PROCESO CalCabAgifa081;
     |ABRE #19;
     #0#11 = 0;
     #0#12 = 0;
     #0#13 = 0;
     #0#34 = 0;
     #0#35 = 0;
     #0#36 = 0;
     #0#37 = 0;
     #0#38 = 0;
     #0#39 = 0;
     #0#40 = 0;
     #0#41 = 0;
     #0#42 = 0;
     #0#44 = 0;
     #0#46 = 0;
     |BUCLELIN 0 LineasPedido #0;
     |GRABA 021#0a;
     |CIERRA #19;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO TotalLin67;
     |ABRE #19;
     #19#0 = #3#2;
     |LEE 020#19=;
     |CIERRA #19;

     nPreTon = 1;
     |HAZ EsVigor;
     |SI FSalida = 0;
          aAlfa = #19#110; |QBF aAlfa;   || Alfanumerico1
          aAlfa = aAlfa > "";
          |SI aAlfa = "S"; nPreTon = 1000; |FINSI;
     |FINSI;

     #3#56 = #3#5 * #19#208; ||Punto Verde

     |HAZ EsAlbadis; ||Para este modulo se factura con las unidades 2
     |SI FSalida = 0; #agifa019#196 = 2; |FINSI;

     |SI #0#29 = "D";                    || Si la moneda de trabajo es la divisa ...
          #3#6    = #3#33 / #0#28 * #0#33;|| ... recalculo precio en funcion de la divisa
          #3#35   = #3#6;                 || ... el campo visualiz. es el precio en moneda base
          nPPort1 = #3#50 / #0#28 * #0#33;
          nPPort2 = #3#50;
     |SINO;
          #3#33   = #3#6  / #0#33 * #0#28; || .. recalculo precio en funcion de la moneda base
          #3#35   = #3#33;                 || ... el campo visual. es el precio en divisa
          nPPort1 = #3#50;
          nPPort2 = #3#50 / #0#33 * #0#28;
     |FINSI;

     |SI #19#196 = 2;
          nNume7 = (#3#41 * #3#6 / nPreTon) ! nDeci_BaseMxP;
          nImpDiv = (#3#41 * #3#33 / nPreTon) ! nDeci_DivP;
     |SINO;
          nNume7 = (#3#5  * #3#6 / nPreTon) ! nDeci_BaseMxP;
          nImpDiv = (#3#5 * #3#33 / nPreTon) ! nDeci_DivP
     |FINSI;

     #3#9  = ((nNume7  < #3#8) < #3#27) < #3#57;
     #3#34 = ((nImpDiv < #3#8) < #3#27) < #3#57;
     |SI #19#196 = 2;
          #3#9  = (#3#9  + (#3#41 * nPPort1));
          #3#34 = (#3#34 + (#3#41 * nPPort2));
     |SINO;
          #3#9  = (#3#9  + (#3#5  * nPPort1));
          #3#34 = (#3#34 + (#3#5  * nPPort2));
     |FINSI;
/*
     #3#9 = #3#9 < #0#5;
     #3#9 = #3#9 < #0#17;
     #3#9 = #3#9 < #0#6;

     #3#34 = #3#34 < #0#5;
     #3#34 = #3#34 < #0#17;
     #3#34 = #3#34 < #0#6;
*/
     nBrutoMoneda1 = #3#9;
     nImporDescue1 = (nBrutoMoneda1 % #0#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #0#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #0#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     #3#9 = nBrutoMoneda1;

     nBrutoMoneda2 = #3#34;
     nImporDescue1 = (nBrutoMoneda2 % #0#5) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #0#17) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #0#6) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     #3#34 = nBrutoMoneda2;

     |SI #0#29 = "D";             || Si la moneda de trabajo es la divisa ...
          #3#36 = #3#9;           || el campo visualiz. es el importe en moneda base
     |SINO;                       || Si la moneda de trabajo es la moneda base ...
          #3#36 = #3#34;          || el campo visualiz. es el importe en divisa
     |FINSI;

     |SI #19#196 = 2;
          nNume11 = ((#3#41 - #3#46) * #3#6 / nPreTon) ! nDeci_BaseMxP;
          nNume11 = (((nNume11 < #3#8) < #3#27) < #3#57) ! nDeci_BaseMxP;
          nNume11 = nNume11 + ((#3#41 - #3#46) * nPPort1);
     |SINO;
          nNume11 = ((#3#5 - #3#38) * #3#6 / nPreTon) ! nDeci_BaseMxP;
          nNume11 = (((nNume11 < #3#8) < #3#27) < #3#57) ! nDeci_BaseMxP;
          nNume11 = nNume11 + ((#3#5 - #3#38) * nPPort1);
     |FINSI;
     nNume11 = nNume11 ! nDeci_BaseMxP;
/*
     #3#11 = (nNume11 < #0#5) ! nDeci_BaseMxP;
     #3#11 = (#3#11 < #0#17) ! nDeci_BaseMxP;
     #3#11 = (#3#11 < #0#6) ! nDeci_BaseMxP;
*/
     nBrutoMoneda1 = nNume11;
     nImporDescue1 = (nBrutoMoneda1 % #0#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #0#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #0#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     #3#11 = nBrutoMoneda1;

     #3#7 = nNume7;
|FPRC;
