|FICHEROS;
     dsfa0002 #8;
     expor501@ #101;          ||Temporal

     agifa501 #0;             ||Entrada Tiquets (C)
     agifa502 #1;             ||Entrada Tiquets (L)
     agifa019 #2;             ||Articulos
     agifa505 #4;             ||Parametros CAJA
     agifa027 #5;             ||Contadores
     agifa509 #8;             ||Resumen diario
     agifa084 #12;            ||Factura Contado
     agifa069 #13;            ||Factura Contado Lineas
     agifa024 #14;            ||Fichero de Clientes
     agifa065 #18;            ||Historico
     agifa515 #19;            ||Fichero tarjetas de credito
     agifa516 #20;            ||Fichero Resumen tarjetas de credito
     agifa514 #21;            ||Fichero de Cajeros
     agifa517 #30;            ||Parametros Tp.V
     agifa554 #33;            ||Pantalla Captura datos Alb/Fra
     agifa017 #34;            ||Almacenes
     agifa576 #41;            ||Pantalla numeros grandes
     agifa577 #42;            ||Pantalla Entrada a Cobrar numeros grandes
     agifa007 #43;            ||Series
     agifa508 #51;            ||Documentos Borrados
     agifa142 #142;
     agifa321;
     agifa324;
     tempo134 #134;
     agifa513 #513;
|FIN;

|VARIABLES;
     nSalCobro = 0;
     nHay = 0;
     aSerTiq = "";
     aSerie = "";
     &eaTag = "";
     &aMoneda  = "";
     &aDivisa  = "";
     &eFecha   = "";
     &enCaja   = 0;
     &eaNom    = "";
     &eaDir    = "";
     &eaPob    = "";
     &eaNif    = "";
     &efFecha  = @;
     &Tempo    = "";
     aTempo101 = "";
     &eaCli    = "";
     &enTiva   = 0;
     &enIva    = 0;
     &enRec    = 0;
     &efFiva = @;
     &eaSerie  = "";
     &enCodigo = 0;

     aDef1     = "";
     aPath     = "";
     aMensa    = "";
     &enSwMenu = 0;
     aSesion   = "";
     iva       = 0;
     puente_n  = 0;
     puente_s  = "";

     &serie    = "";
     &fecha    = @;
     &numero   = 0;
     &reimpr   = "";

     alfa      = "";
     almacen   = 0;
     conta_reg = 0;
     niva      = 0;
     j         = 0;
     i         = 0;
     conta_fa  = "";
     aAlfa1    = "";

     Dser      = "";
     Hser      = "";
     Dnum      = 0;
     Hnum      = 0;
     Cliente   = "";
     Linea     = 0;
     fichero   = "";
     campo     = 0;
     claveconta = "";
     aParam     = "";
     &nDeci_Base    = 0;
     &nDeci_PreBase = 0;
     &eaFichero = "";
     aTemporal = "";
|FIN;

|PROCESO ModSerie; |TIPO 0;
     |SI #8#28 = "F";
          |C_M #8#29, 1, "S";
     |SINO;
          |C_M #8#29, 1, "N";
     |FINSI;
|FPRC;

|PROCESO Rellena; |TIPO 6;
     |SI #142#46 = "S";
          |SI Campo = 22; |Y #8Campo = "      "; |ACABA; |FINSI;
          alfa = #8Campo; |QBF alfa;
          alfa = ("000000" + alfa) % -106;
          #8Campo = alfa;
          |PINTA #8Campo;
     |FINSI;
|FPRC;

|PROCESO parrilla; |TIPO 0;
     |SI #8Campo = "P";
          |C_M #8#0, 1, "N";
          |C_M #8#1, 1, "N";
          |C_M #8#2, 1, "N";
          |C_M #8#3, 1, "N";
          |C_M #8#5, 1, "S";
          |C_M #8#6, 1, "S";
          |C_M #8#7, 1, "S";
          |C_M #8#8, 1, "S";
          |C_M #8#9, 1, "S";
          |C_M #8#10, 1, "S";
          |C_M #8#11, 1, "S";
          |C_M #8#12, 1, "S";
          |C_M #8#13, 1, "S";
          |C_M #8#14, 1, "S";
          |C_M #8#15, 1, "S";
          |C_M #8#16, 1, "S";
          |C_M #8#17, 1, "S";
          |C_M #8#18, 1, "N";
          |C_M #8#19, 1, "N";
          |C_M #8#20, 1, "N";
          |C_M #8#21, 1, "N";
     |SINO;
          |C_M #8#0, 1, "S";
          |C_M #8#1, 1, "S";
          |C_M #8#2, 1, "S";
          |C_M #8#3, 1, "S";
          |C_M #8#5, 1, "N";
          |C_M #8#6, 1, "N";
          |C_M #8#7, 1, "N";
          |C_M #8#8, 1, "N";
          |C_M #8#9, 1, "N";
          |C_M #8#10, 1, "N";
          |C_M #8#11, 1, "N";
          |C_M #8#12, 1, "N";
          |C_M #8#13, 1, "N";
          |C_M #8#14, 1, "N";
          |C_M #8#15, 1, "N";
          |C_M #8#16, 1, "N";
          |C_M #8#17, 1, "N";
          |C_M #8#18, 1, "S";
          |C_M #8#19, 1, "S";
          |C_M #8#20, 1, "S";
          |C_M #8#21, 1, "S";
     |FINSI;
|FPRC;
-----------------------------------------------------------------------
|PROCESO Divisa;
     |ABRE #agifa321;
     |LEE 000#agifa321.p;
     |CIERRA #agifa321;

     aMoneda = "B";
     aDivisa = #agifa321#9;
     |HAZ Divisas084;
|FPRC;

|PROCESO BorraHisto;
     |ABRE #18;
     #18#0 = #1#2;
     #18#1 = #0#14;
     #18#2 = "TI";
     #18#3 = #0#58;
     #18#4 = #1#1;
     #18#5 = #1#3;
     #18#6 = -#1#5;
     #18#8 = #2#9;
     #18#9 = #1#10;        ||Precio sin iva
     #18#10 = #0#1;
     #18#11 = #0#57;
     |LEE 101#18=;
     |SI FSalida = 0;
          |BORRA 021#18a;
     |FINSI;
     |CIERRA #18;
|FPRC;

|PROCESO GraHisto;
     |DDEFECTO #18;
     |ABRE #18;
     #18#0 = #13#2;
     #18#1 = #12#1;
     #18#2 = "FC";
     #18#3 = #12#0;
     #18#4 = #13#1;
     #18#5 = #13#3;
     #18#6 = -#13#5;
     #18#8 = #2#9;
     #18#9 = #1#10;        ||Precio sin iva
     #18#10 = #12#3;
     #18#11 = #12#48;
     #18#3 = numero;
     #18#14 = ((((#18#9 < #18#12) < #18#13) < #0#17) < #0#19);
     |SI #142#115 = "S";
          #18#14 = #18#14 < #0#18;
     |FINSI;
     |GRABA 021#18n;
     |CIERRA #18;
|FPRC;

|PROCESO lin_502;
     |HAZ BorraHisto;

     #13#20 = #12#48;
     #13#0 = #12#0;
     #13#1 = 999;
     |LEE 000#13];
     |SI FSalida = 0;
          |LEE 000#13a;
     |SINO;
          |LEE 000#13u;
     |FINSI;
     |SI FSalida = 0; |Y #13#20 = #12#48; |Y #13#0 = #12#0;
          Linea = #13#1 + 1;
     |SINO;
          Linea = 1;
     |FINSI;

     |DDEFECTO #13;
     #13#20 = #12#48;        ||Serie
     #13#0 = #12#0;
     #13#1 = Linea;
     #13#2 = #1#2;                    ||Articulo
     #13#3 = almacen;                  ||almacen
     #13#4 = #1#8;              ||Descripcion
     #13#5 = #1#5;              ||Unidades
     #13#6 = #1#10;             ||Precio
     #13#7 = #13#5 * #13#6;||Importe
     #13#8 = #1#14;             ||Dto
     #13#9 = (#13#5 * #13#6) < #13#8;||Imp.Tot
     #13#11 = #1#13;            ||Tipo de Iva
     #13#13 = #1#11;            ||Familia
     #13#14 = #1#23;            ||Coste
     #13#15 = #0#1;             ||Cliente
     #13#16 = #12#34;            ||Tipo Comision
     #13#17 = #12#35;            ||Tipo Cliente

     #13#26 = #1#10;             ||Precio
     #13#28 = #1#10;             ||Precio
     #13#27 = #13#9;             || importe
     #13#29 = #13#9;             || importe

     |GRABA 021#13n;
     |HAZ GraHisto;
|FPRC;

|DEFBUCLE lin_502;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, lin_502;
|FIN;

|PROCESO cabecera;
     |HAZ Divisa;

     #12#1 = #8#24;             ||Fecha
     #12#3 = #14#0;             ||Cliente
     |SI #8#22 = "      ";
          #12#4 = #14#1;             ||Nombre
          #12#29 = #14#8;            ||Entre
          #12#30 = #14#8;            ||Dir
          #12#31 = #14#9;            ||Pob
          #12#60 = #14#15;            ||Nif
     |SINO;
          #12#4 = #8#23;             ||Nombre
          #12#29 = #8#26;            ||Entre
          #12#30 = #8#26;            ||Dir
          #12#31 = #8#25;            ||Pob
          #12#60 = #8#27;            ||Nif
     |FINSI;
     #12#5 = #0#17;             ||Dto
     aAlfa1 = #4#111;    |QBF aAlfa1;
     |SI aAlfa1 ! "";
         #12#6 = #4#111;        || representante fijo
     |SINO;
         #12#6 = #0#33;         || cajero como representante
     |FINSI;
     #12#7 = #0#18;             ||Dto pp
     #12#8 = #14#20;            ||Forma de Pago
     #12#9 = #14#35;            ||Agencia Transportes

     #12#87 = "N§:" + #0#0;     ||Curso = Contador

     #12#10 = "N";


     #12#15 = #12#15 + #0#3;    ||Total bruto
     #12#36 = #0#29;            ||Regimen equivalencia || *(3)

     eaCli = #12#3; efFiva = #12#1;
     enTiva = 1; |HAZ IVACli;
     #12#16 = #12#16 + #0#20;      || Base Iva 1
     #12#17 = #12#16 % enIva;      || Cuota I.Va. 1
     |SI #12#36 = "S";
          #12#18 = #12#16 % enRec; || Cuota Rec I.Va. 1
     |FINSI;

     enTiva = 2; |HAZ IVACli;
     #12#19 = #12#19 + #0#23;      || Base Iva 2
     #12#20 = #12#19 % enIva;      || Cuota I.Va. 2
     |SI #12#36 = "S";
          #12#21 = #12#19 % enRec; || Cuota Rec I.Va. 2
     |FINSI;

     enTiva = 3; |HAZ IVACli;
     #12#22 = #12#22 + #0#26;      || Base Iva 3
     #12#23 = #12#22 % enIva;      || Cuota I.Va. 3
     |SI #12#36 = "S";
          #12#24 = #12#22 % enRec; || Cuota Rec I.Va. 3
     |FINSI;

     #12#25 = #12#25 + #0#28;            ||Total descuento
     #12#28 = #12#28 + #0#30;            ||Base Exenta

     #12#32 = #0#19;                     ||Dto Acumulado
     #12#33 = #14#7;              ||Prov Entrega
     #12#34 = #14#7;             ||Tipo Comision
     #12#35 = #14#4;             ||Tipo Cliente

     enTiva = 4; |HAZ IVACli;
     #12#42 = #12#42 + #0#48;      || Base iva 4
     #12#43 = #12#42 % enIva;      || Cuota I.Va. 4
     |SI #12#36 = "S";
          #12#43 = #12#42 % enRec; || Cuota Rec I.Va. 4
     |FINSI;

     enTiva = 5; |HAZ IVACli;
     #12#45 = #12#45 + #0#51;      || Base iva 5
     #12#46 = #12#45 % enIva;      || Cuota I.Va. 5
     |SI #12#36 = "S";
          #12#47 = #12#45 % enRec; || Cuota Rec I.Va. 5
     |FINSI;


     || Calculamos el total de la Factura. Como consecuencia de los totales
     || que le han llegado y no igualandola al total del tiquet
     || Cogido a pelo de agifa084
     #12#24=#12#17+#12#20+#12#23+#12#18+#12#21+#12#49+#12#43+#12#44+#12#46+#12#47;
     #12#41 = #12#24 + #12#16 + #12#19 + #12#22 + #12#28 + #12#42 + #12#45;


     #12#63 = #33#5;             || A cuenta *(1)

     ||Se calculan los % de iva para los campos de la factura

     j = 49;
     |PARA i = 1; |SI i [ 5; |HACIENDO i = i + 1;
          #1#13 = i;
          eaCli = #1#4; efFiva = #12#1;
          enTiva = i;  |HAZ IVACli;
          j = j + 1; #12j = enIva;
          j = j + 1; #12j = eaCli;
     |SIGUE;
     #12#67 = "B";           ||Moneda de trabajo
     #12#65 = #agifa321#9;   ||Divisa
     #12#68 = #agifa321#9;   ||Moneda Base
     #12#66 = #agifa324#2;   ||Cambio moneda base a euros
     #12#69 = #agifa324#2;   ||Cambio moneda base a euros
     #12#70 = #12#70 + #0#3; ||Bruto en Divisa
     #12#71 = #12#71 + #0#9; ||Total Albaran en Divisa
     #12#72 = #12#72 + #0#3; ||Bruto (vis)
     #12#73 = #12#73 + #0#9; || Total (vis)
     #12#74 = #12#74 + #0#3; ||Bruto (no vis)
     #12#75 = #12#75 + #0#9; ||Total (no vis)
     |ABRE #2;
     |ABRE #34;
     |ABRE #18;
     |||BUCLELIN 2lin_502#0;
     |BUCLE lin_502;
     |CIERRA #2;
     |CIERRA #34;
     |CIERRA #18;
|FPRC;

|PROCESO Factura;
     |DDEFECTO #12;
     #12#48 = serie;
     #12#0 = numero;
     |LEE 121#12=;
     |SI FSalida = 0;
          #12#40 = #14#16;    || cuenta contable (R.PRIEGO, 28.12)
          #12#61 = "N";
          #12#62 = "00.00.0000";

          |HAZ cabecera;
          |GRABA 021#12a;
          |LIBERA #12;

          #0#58 = conta_reg;     ||Numero de Documento
     |FINSI;
|FPRC;

|PROCESO SiguienteFac;
     #12#48 = aSerie;
     #12#0 = 999999;
     |LEE 000#12];
     |SI FSalida = 0;
          |LEE 000#12a;
     |SINO;
          |LEE 000#12u;
     |FINSI;
     |SI FSalida = 0; |Y #12#48 = aSerie;
          conta_reg = #12#0 + 1;
     |SINO;
          conta_reg = 1;
     |FINSI;
     |DDEFECTO #12;
     #12#48 = aSerie;
     #12#0 = conta_reg;
|FPRC;

|PROCESO contique;
     conta_reg = 0;
     |ABRE #51;
     |DDEFECTO #51;
     #51#0 = claveconta;
     claveconta = #51#0;        ||para que lo rellene de blancos
     #51#1 = aSerie;
     |LEE 141#51];
     |PARA; |SI FSalida = 0; |Y #51#0 = claveconta; |Y #51#1 = aSerie; |HACIENDO;
          claveconta = #51#0;
          |SI #51#3 = #0#14;
               conta_reg = #51#2;
               |BORRA 040#51a;
               |SAL;
          |FINSI;
          |LIBERA #51;
          |LEE 141#51s;
     |SIGUE;
     |CIERRA #51;

     |SI conta_reg = 0;
          |ABRE #5;
          #5#0 = claveconta;
          #5#2 = aSerie;
          |LEE 141#5=;
          |SI FSalida ! 0;
               #5#1 = 1;
               |GRABA 040#5b;
          |FINSI;
          conta_reg = #5#1;
          #5#1 = #5#1 + 1;
          |GRABA 040#5a;
          |CIERRA #5;
     |FINSI;
|FPRC;

|PROCESO Contique;
     |SI #8#28 = "F";
          aSerie = #8#29;
     |SINO;
          aSerie = #0#57;
     |FINSI;
/*
     |SI #142#137 = "F";
          |SI #142#26 = "S";
               claveconta = "vfactura";
          |SINO;
               claveconta = "vfactuco";
          |FINSI;
          |HAZ contique;
          |DDEFECTO #12;
          #12#48 = aSerie;
          #12#0 = conta_reg;
     |SINO;
          |HAZ SiguienteFac;
     |FINSI;
*/
     #12#48 = aSerie;
     enSwMenu = 1;
     |HAZ ContaFD7;
     |GRABA 020#12b;
     conta_reg = #12#0;
|FPRC;

|PROCESO agifa501;
     |DDEFECTO #14;
     |ABRE #14;
     |SI #8#22 = "      ";
          #14#0 = #0#1;
     |SINO;
          #14#0 = #8#22;
     |FINSI;
     |LEE 000#14=;
     |CIERRA #14;

     |SI #1#3 ! 0;
          almacen = #1#3;
     |SINO;
          |ABRE #4;
          #4#0 = #0#12;
          |LEE 000#4=;
          |SI FSalida = 0;
               almacen = #4#87;
          |SINO;
               almacen = 1;
          |FINSI;
          |CIERRA #4;
     |FINSI;

     |ABRE #12;
     |ABRE #13;
     |SI aParam = "iber21";
          #8#24 = #0#14;
          #8#23 = #14#1;
          #8#22 = #14#0;
          |HAZ Contique;
          serie = aSerie;
          numero = conta_reg;
     |SINO;
          |SI Cliente ! "";
               |SI #8#22 ! "      "; Cliente = #0#1; |FINSI;
          |FINSI;
          |SI #8#28 = "F"; aSerTiq = #0#57; |FINSI;
          |SI #0#1 ! Cliente; |O Linea > 900; || solo 900 lineas por factura...
                    |O aSerTiq ! #0#57;
               |SI Cliente ! "";
                    #12#48 = serie;
                    #12#0 = numero;
                    |LEE 121#12=;
                    |SI FSalida = 0;
                         |HAZ LimCabAgifa084;
                         |BUCLELIN 0 CalCabAgifa084 #12;
                         |GRABA 020#12a;
                         |LIBERA #12;
                         |SI #142#47 = "S";  ||ÄÄÄÄÄÄÄÄÄÄÄÄÄ Acumula en Riesgo Si Crea Recibos = "S"
                              |HAZ VenciDir;
                              eaTag = "FC";  |HAZ Riesgos;
                         |FINSI;

                         reimpr = "S";
                         ||SUB_EJECUTA_NP "agifa086.run";
                         #134#0 = #12#48;
                         #134#1 = #12#0;
                         |GRABA 020#134n; nHay = 1;
                    |FINSI;
               |FINSI;
               |HAZ Contique;
               serie = aSerie;
               numero = conta_reg;
          |FINSI;
     |FINSI;
     |HAZ Factura;
     |CIERRA #12;
     |CIERRA #13;
     Cliente = #0#1;
     aSerTiq = #0#57;

     |DDEFECTO #101;
     #101#36 = #0#36;
     #101#0 = #0#0;
     #101#57 = aSerie;
     #101#58 = #0#58;
     |GRABA 020#101n;
|FPRC;

|DEFBUCLE agifa501;
     #0#3;
     ;
     #8#18, #8#20, "T", Dser, Dnum;
     #8#19, #8#21, "T", Hser, Hnum;
     b;
     NULL, NULL, NULL, NULL, NULL, agifa501;
     #0#1, #0#57;
|FIN;

|DEFBUCLE agifa501Iber;
     #0#3;
     12;
     eFecha, "      ", "T", "     ", 000001, enCaja;
     eFecha, "zzzzzz", "T", "zzzzz", 999999, enCaja;
     b;
     NULL, NULL, NULL, NULL, NULL, agifa501;
     #0#1, #0#57;
|FIN;

|PROCESO temporal;
     #0#36 = #101#36;
     #0#0 = #101#0;
     |LEE 121#0=;
     |SI FSalida  = 0;
          |SELECT #4#513;
          #513#19 = #0#35;
          #513#20 = #0#57;
          #513#21 = #0#58;
          |LEE 101#513=;
          nSalCobro = FSalida;

          #0#57 = #101#57;
          #0#58 = #101#58;
          #0#35 = "F";
          |GRABA 021#0a;
          |SI FSalida = 0; |Y nSalCobro = 0;
               #513#19 = #0#35;
               #513#20 = #0#57;
               #513#21 = #0#58;
               |GRABA 020#513a;
          |FINSI;

          |LIBERA #513;
          |LIBERA #0;
     |FINSI;
|FPRC;

|DEFBUCLE temporal;
     #101#1002;
     ;
     "     ", 000001;
     "zzzzz", 999999;
     ;
     NULL, temporal;
|FIN;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO acum_iva;
     iva = 0;
     |SI #1#13 = 0;
          #0#30 = #0#30 +. puente_n;||Exenta
     |FINSI;
     |SI #1#13 = 1;
           #0#20 = #0#20 +. puente_n;
           #0#21 = #0#21 +. (puente_n % enIva);
           iva = puente_n % enIva;
           |SI #0#29 = "S";            ||Tiene recargo
                #0#22 = #0#22 +. (puente_n % enRec);
                iva = iva + (puente_n % enRec);
           |FINSI;
     |FINSI;
     |SI #1#13 = 2;
          #0#23 = #0#23 +. puente_n;    || Base imponible s/decimales
          #0#24 = #0#24 +. (puente_n % enIva);
          iva = puente_n % enIva;
          |SI #0#29 = "S";            ||Tiene recargo
               #0#25 = #0#25 +. (puente_s % enRec);
               iva = iva + (puente_n % enRec);
          |FINSI;
     |FINSI;
     |SI #1#13 = 3;
          #0#26 = #0#26 +. puente_n;
          #0#27 = #0#27 +. (puente_n % enIva);
          iva = puente_n % enIva;
          |SI #0#29 = "S";            ||Tiene recargo
               #0#47 = #0#47 +. (puente_n % enRec);
               iva = iva + (puente_n % enRec);
          |FINSI;
     |FINSI;
     |SI #1#13 = 4;
          #0#48 = #0#48 +. puente_n;
          #0#49 = #0#49 +. (puente_s % enIva);
          iva = puente_s % enIva;
          |SI #0#29 = "S";            ||Tiene recargo
               #0#50 = #0#50 +. (puente_s % enRec);
               iva = iva + (puente_s % enRec);
          |FINSI;
     |FINSI;
     |SI #1#13 = 5;
          #0#51 = #0#51 +. puente_n;
          #0#52 = #0#52 +. (puente_s % enIva);
          iva = puente_s % enIva;
          |SI #0#29 = "S";            ||Tiene recargo
               #0#53 = #0#53 +. (puente_s % enRec);
               iva = iva + (puente_s % enRec);
          |FINSI;
     |FINSI;
     #0#4=#0#21+#0#22+#0#24+#0#25+#0#27+#0#47+#0#49+#0#50+#0#52+#0#53;
|FPRC;

|PROCESO RecalCab;
     #0#3 = #0#3 +. #1#21;        ||Total bruto
     puente_n = ((#1#21 < #0#17) < #0#19) < #0#18;
     puente_s = (((#1#10 * #1#5) < #0#17) < #0#19) < #0#18;

     #0#28 = #0#28 +. (#1#21 - puente_n);   ||Total descuentos

     eaCli = #1#4;
     enTiva = #1#13;
     efFiva = #0#14;
     |HAZ IVACli;

     |HAZ acum_iva;

     #0#9 = #0#9 +. (puente_n + iva);
|FPRC;


|PROCESO GrabaLinDesglose;
     |BORRA 020#1a;
     #1#20 = aSesion;
     |GRABA 020#1n;
|FPRC;

|DEFBUCLE GrabaLinDesglose;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     be;
     NULL, GrabaLinDesglose;
|FIN;

|DEFBUCLE RecalCab;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, RecalCab;
|FIN;

|PROCESO MiraDesglose;
     |SI #0#5 = "     ";
          |ERROR;
          |ACABA;                 || Sesion blanca no tiene desglose
     |FINSI;

     |SALVA_FICHA #0;
     |SELECT #1#0;

     aSesion = #0#36;
     #0#36 = #0#5;
     |LEE 101#0=;
     |SI FSalida = 0;
          |BUCLE GrabaLinDesglose;
          |||BUCLELIN 0 GrabaLinDesglose #0;
          |BORRA 020#0a;
     |FINSI;

     |SELECT #3#0;
     |REPON_FICHA #0;

     #0#3 = 0;
     #0#4 = 0;
     #0#9 = 0;
     |PARA i = 20; |SI i [ 28; |HACIENDO i = i + 1;
          #0i = 0;
     |SIGUE;
     #0#30 = 0;
     |PARA i = 47; |SI i [ 53; |HACIENDO i = i + 1;
          #0i = 0;
     |SIGUE;
     |||BUCLELIN 0 RecalCab #0;
     |BUCLE RecalCab;
     |GRABA 020#0a;
|FPRC;

|DEFBUCLE MiraDesglose;
     #0#3;
     ;
     #8#18, #8#20, "T", Dser, Dnum;
     #8#19, #8#21, "T", Hser, Hnum;
     b;
     NULL, MiraDesglose;
|FIN;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO tipo3; |TIPO 3;
     |DBASE aPath;
     aMensa = ""; aDef1 = "";

     aDef1 = aPath + "def/" + "agifa501";
     |CARGA_DEF aDef1, expor501@;
     |SI FSalida ! 0;
          aMensa = "0000Error al cargar:" + aDef1;
          aDef1 = "";
          |MENAV aMensa; |ACABA;
     |FINSI;

     |HAZ CreaTempo; aTempo101 = Tempo;
     |NOME_DAT #101 aTempo101; |DELINDEX #101;
     |ABRE #101;

     |SI #8#4 = "P";
          #8#18 = "01.01.0000";
          #8#19 = "31.12.9999";
          #8#20 = "      ";
          #8#21 = "zzzzzz";
          Dser = #8#5;
          Hser = #8#5;
          |PARA campo = 6; |SI campo [ 17; |HACIENDO campo = campo + 1;
               |SI #8campo ! 0;
                    Dnum = #8campo;
                    Hnum = #8campo;
                    |BUCLE MiraDesglose;
                    |BUCLE agifa501;
               |FINSI;
          |SIGUE;
     |SINO;
          Dser = #8#0;
          Hser = #8#1;
          Dnum = #8#2;
          Hnum = #8#3;
          |BUCLE MiraDesglose;
          |BUCLE agifa501;
     |FINSI;
     |SI Cliente ! "";
          |ABRE #12;
          #12#48 = serie;
          #12#0 = numero;
          |LEE 121#12=;
          |SI FSalida = 0;
               |HAZ LimCabAgifa084;
               |BUCLELIN 0 CalCabAgifa084 #12;
               |GRABA 020#12a;
          |FINSI;
          |CIERRA #12;
          |SI #142#47 = "S";  ||ÄÄÄÄÄÄÄÄÄÄÄÄÄ Acumula en Riesgo Si Crea Recibos = "S"
               |HAZ VenciDir;
               eaTag = "FC";  |HAZ Riesgos;
          |FINSI;

          reimpr = "S";
          ||SUB_EJECUTA_NP "agifa086.run";
          #134#0 = #12#48;
          #134#1 = #12#0;
          |GRABA 020#134n; nHay = 1;
     |FINSI;

     |ABRE #0;
     |ABRE #513;
     |BUCLE temporal;
     |CIERRA #513;
     |CIERRA #0;

     |CIERRA #101;
     |DELINDEX #101; Tempo = aTempo101; |HAZ BoraTempo;

     |SI aDef1 ! ""; |DESCARGA_DEF #expor501@; |FINSI;
|FPRC;

|PROCESO Iber21;
     |DBASE aPath;
     aMensa = ""; aDef1 = "";

     aDef1 = aPath + "def/" + "agifa501";
     |CARGA_DEF aDef1, expor501@;
     |SI FSalida ! 0;
          aMensa = "0000Error al cargar:" + aDef1;
          aDef1 = "";
          |MENAV aMensa; |ACABA;
     |FINSI;

     |HAZ CreaTempo; aTempo101 = Tempo;
     |NOME_DAT #101 aTempo101; |DELINDEX #101;
     |ABRE #101;

     |BUCLE agifa501Iber;

     |ABRE #0;
     |ABRE #513;
     |BUCLE temporal;
     |CIERRA #513;
     |CIERRA #0;

     |CIERRA #101;
     |DELINDEX #101; Tempo = aTempo101; |HAZ BoraTempo;

     |SI aDef1 ! ""; |DESCARGA_DEF #expor501@; |FINSI;
|FPRC;

|PROGRAMA;
     |HAZ CreaTempo;
     aTemporal = Tempo;
     |NOME_DAT #134 aTemporal;     || Tmp de impresion
     |ABRE #134;

     |HAZ Divisa;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     aParam = PARAMETRO;

     |SI aParam = "iber21";
          |HAZ Iber21;
          |ACABA;
     |FINSI;

     |SI enCodigo ! 0;
          #8#4 = "P";
          #8#5 = eaSerie;
          #8#6 = enCodigo;
          #8#24 = efFecha;
          #8#22 = eaCli;
          #8#23 = eaNom;
          #8#26 = eaDir;
          #8#25 = eaPob;
          #8#27 = eaNif;
          |HAZ tipo3;
     |SINO;
          |MANTE #8;
     |FINSI;

     |CIERRA #134;
     |SI nHay ! 0;
          eaFichero = aTemporal;
          |SUB_EJECUTA_NP "agifa086";
     |FINSI;
     |DELINDEX #134; Tempo = aTemporal; |HAZ BoraTempo;
|FPRO;
