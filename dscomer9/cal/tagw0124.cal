     || Copia (similar al) tagz0015

|FICHEROS;
     agifa010 #10;
     agifa019 #19;
     tagm0021 #21;
     tagm0036 #36;
     agifa081 #81;
     agifa067 #67;
     agifa071 #71;
     agifa073 #73;
     agifa104 #104;
     tagw0035@;     || Usado como temporal para saber cuales se han tratando
     noecontr@;     || temporal de los no encontrados en ped.vta
     nomodifi@;     || temporal para los que no se deben de modificar
|FIN;

|VARIABLES;
     &Tempo = "";
     &efDfecha  = @;
     &efHfecha = @;
     &eaDarti = "";
     &eaHarti = "";

     nSalida = 0;
     aTmn = "";
     nUni = 0;
     nAbo = 0;
     aAlfa = "";
     aParam = "";
     aFic = "";
     aCli = "";
     aEsAsociaCli = "";
     aLon = "";
     aSer = "";
     nLin = 0;
     aImpreso = "";
     aTmp21 = "";
     aTmp35 = "";
     aTmp = "";
     aPath = "";
     aEncontrado = "";
     nEsta = 0;

     aIP = "";
     aServidor = "";
     aFrom = "";
     aTo = "";
     aSubject = "";
     aMensaje = "";
     aDjunto = "";
     nHandle = 0;
     aEmp = "";
     aDirDestino = "";

     {1}aBaseLocal = "";
|FIN;

|PROCESO QuitaHisto;
     #36#2 = #tagw0035@#0;
     #36#1 = #tagw0035@#3;
     |LEE 000#36=;
     |SI FSalida = 0;
          #21#0 = #36#1;
          #21#2 = #36#2;
          |LEE 121#21=;
          |SI FSalida = 0;
               #21#12 = #21#12 - #36#4;
               |SI #21#12 < 0; #21#12 = 0; |FINSI;
               |GRABA 020#21a;
               |LIBERA #21;

          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE QuitaHisto;
     #tagw0035@#1002;
     ;
     "                    ", "      ";
     "zzzzzzzzzzzzzzzzzzzz", "zzzzzz";
     ;
     NULL, QuitaHisto;
|FIN;

|PROCESO AlbVenta;
     |SI #10#43 = "S";
          nAbo = -1;
     |SINO;
          nAbo = 1;
     |FINSI;

     nUni = #71#5 * nAbo;
     |SI nUni < 0; |ACABA; |FINSI; || los abonos no se tratan

     #noecontr@#0 = #71#2;
     |LEE 000#noecontr@.=;
     |SI FSalida = 0;
          #21#0 = #noecontr@#3;
          #21#2 = #noecontr@#0;
          |LEE 121#21=;
          #21#12 = #21#12 - nUni;
          |SI #21#11 < 0; #21#11 = 0; |FINSI;
          |SI #21#12 < 0; #21#12 = 0; |FINSI;

          #21#13 = #10#4;
          |GRABA 020#21a;
          |LIBERA #21;

     |FINSI;
|FPRC;

|DEFBUCLE AlbVenta;
     #10#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, NULL, AlbVenta;
|FIN;

|PROCESO BusPedVta;
     nEsta = 0;
     #73#2 = #tagw0035@#0;
     #73#28 = "";
     #73#0 = 0;
     #73#20 = "";
     |LEE 000#73];
     |PARA; |SI FSalida = 0; |Y #73#2 = #tagw0035@#0; |HACIENDO;
          nEsta = 1;
          |DDEFECTO #104;
          #104#25 = #73#28;
          #104#0 = #73#0;
          |LEE 000#104=;

          #21#0 = #tagw0035@#3;
          #21#2 = #tagw0035@#0;
          |LEE 121#21=;
          #21#12 = #21#12 - #73#43;
          #21#13 = #104#8;
          |SI #21#11 < 0; #21#11 = 0; |FINSI;
          |SI #21#12 < 0; #21#12 = 0; |FINSI;
          |GRABA 020#21a;
          |LIBERA #21;


          |LEE 000#73s;
     |SIGUE;

     |SI nEsta = 0;
          aEncontrado = "N";

          #noecontr@#0 = #tagw0035@#0;
          #noecontr@#3 = #tagw0035@#3;
          |GRABA 020#noecontr@.n;
     |FINSI;
|FPRC;

|DEFBUCLE BusPedVta;
     #tagw0035@#1002;
     ;
     "                    ", "      ";
     "zzzzzzzzzzzzzzzzzzzz", "zzzzzz";
     ;
     NULL, BusPedVta;
|FIN;

|PROCESO EsAsociaCli;
     aAlfa = #67#2; |QBF aAlfa;
     aLon = aAlfa % A0;
     |SI aLon ! 14;
          aEsAsociaCli = "S";
     |SINO;
          aSer = #67#2 % 102;
          aAlfa = #67#28; |QBF aAlfa;
          |SI aAlfa = aSer;
               aEsAsociaCli = "N";
          |SINO;
               aEsAsociaCli = "S";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Modi;
     #21#3 = #67#4;
     #21#4 = #67#47;
     #21#5 = #67#48;
     #21#6 = #67#49;
     #21#7 = #67#28;
     #21#8 = #67#0;
     #21#9 = #67#1;
     #21#10 = aEsAsociaCli;
     #21#11 = #67#5 - #67#38;|| Pdte Rec
     #21#12 = #67#38;    || Reser Vta
     |SI #21#11 < 0; #21#11 = 0; |FINSI;
     |SI #21#12 < 0; #21#12 = 0; |FINSI;
     ||#21#13 = "";   || Nombre
     |GRABA 020#21a;


     #tagw0035@#0 = #21#2;
     #tagw0035@#3 = #21#0;
     |GRABA 040#tagw0035@.n;
|FPRC;

|PROCESO PedCompra;
     |SI #67#2 < eaDarti; |O #67#2 > eaHarti;
          |ACABA;
     |FINSI;
     #19#0 = #67#2;
     |LEE 000#19=;
     |SI FSalida ! 0; |O #19#126 ! "VAR";
          |ACABA;
     |FINSI;

     |HAZ EsAsociaCli;

     aAlfa = #67#2; |QBF aAlfa;
     aCli = aAlfa % -106;

     |SELECT #2#21;
     #21#0 = aCli;
     #21#2 = #67#2;
     |LEE 101#21=;
     |SI FSalida = 0;
          |HAZ Modi;
     |FINSI;
     |LIBERA #21;
|FPRC;

|DEFBUCLE PedCompra;
     #81#1;
     1;
     "     ", 000001, efDfecha;
     "zzzzz", 999999, efHfecha;
     ;
     NULL, NULL, PedCompra;
|FIN;

|PROCESO Copialo;
     |SI #21#14 = "S";
          |SALVA_DATOS #21;
          |REPON_DATOS #nomodifi@;
          |GRABA 020#nomodifi@.n;
     |FINSI;
|FPRC;

|DEFBUCLE Copialo;
     #21#3;
     ;
     eaDarti;
     eaHarti;
     ;
     NULL, Copialo;
|FIN;

|PROCESO CopiaNoModi;
     |SALVA_DATOS #nomodifi@;
     #21#0 = #nomodifi@#0;
     #21#1 = #nomodifi@#1;
     |LEE 101#21=;
     nSalida = FSalida;
     |REPON_DATOS #21;

     |SI nSalida = 0;
          |GRABA 020#21a;
     |SINO;
          |GRABA 020#21n;
     |FINSI;
     |LIBERA #21;

|FPRC;

|DEFBUCLE CopiaNoModi;
     #nomodifi@#1002;
     ;
     "      ", 00001;
     "zzzzzz", 99999;
     ;
     NULL, CopiaNoModi;
|FIN;

|PROCESO ArtVarios;
     |DDEF aPath;

     aAlfa = aPath + "tagm0021";
     |CARGA_DEF aAlfa, nomodifi@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aAlfa = aPath + "tagw0035";
     |CARGA_DEF aAlfa, tagw0035@;
     |SI FSalida = 0;
          aAlfa = aPath + "tagw0035";
          |CARGA_DEF aAlfa, noecontr@;
          |SI FSalida = 0;
               |HAZ CreaTempo; aTmp35 = Tempo; |NOME_DAT #tagw0035@#Tempo#; |DELINDEX #tagw0035@;
               |HAZ CreaTempo; aTmp = Tempo; |NOME_DAT #noecontr@#Tempo#; |DELINDEX #noecontr@;
               |HAZ CreaTempo; aTmn = Tempo; |NOME_DAT #nomodifi@#Tempo#; |DELINDEX #nomodifi@;

               |ABRE #nomodifi@;
               |BUCLE Copialo;
               |CIERRA #nomodifi@;

               |ABRE #tagw0035@;
               |ABRE #noecontr@;

               |ABRE #19;
               |ABRE #21;
               |BUCLE PedCompra;
               |CIERRA #21;
               |CIERRA #19;

               |ABRE #21; |SELECT #2#21;
               |ABRE #104;
               |ABRE #73; |SELECT #3#73;
               |BUCLE BusPedVta;

               |CIERRA #73;
               |CIERRA #104;
               |SI aEncontrado = "N";
                    |SELECT #2#noecontr@;
                    |BUCLE AlbVenta;
               |FINSI;

               |ABRE #36; |SELECT #2#36;
               |BUCLE QuitaHisto;
               |CIERRA #36;

               |CIERRA #21;

               |CIERRA #noecontr@;
               |CIERRA #tagw0035@;

               |ABRE #21;
               |BUCLE CopiaNoModi;
               |CIERRA #21;

               Tempo = aTmn; |HAZ BoraTempo; |DELINDEX #nomodifi@;
               Tempo = aTmp35; |HAZ BoraTempo; |DELINDEX #tagw0035@;
               Tempo = aTmp; |HAZ BoraTempo; |DELINDEX #noecontr@;

               |DESCARGA_DEF #noecontr@;
          |FINSI;
          |DESCARGA_DEF #tagw0035@;
     |FINSI;
     |DESCARGA_DEF #nomodifi@;
|FPRC;
