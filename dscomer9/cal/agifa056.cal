|FICHEROS;
     agifa056 #0;
     agifa079 #1;
     agifa072 #2;
     agifa112 #3;
     agifa077 #4;
     agifa080 #5;
     agifa091 #10;
     dsz99984 #11;
     agifa007 #40;
     dsm00083 #83;
     agifa177 #177;
     agifa136 #136; || Mascara Vto
     agifa321 #321;
     agifa324 #324;
     dsm00279 #279;

     tlfm0001@ #101;
     tlfm0002@ #102;
     agifa080@;
     referen@;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     nSwRavenida = 0;
     aTipo = "";
     nSal = 0;
     &PRMNT_Imp = "";
     aPath = "";
     nSal1 = 0;
     nSal2 = 0;
     nSwSematel   = 0;
     nSwSanchez   = 0;
     &eaIMEI      = "";
     &eaABO       = "";
     &eaICC       = "";
     &enSwIMEI    = 0;

     nTotaFac = 0;
     &eaDoc = "";
     &eaImprime = "";
     nSwPackList = 0;

     nNumRecibos = 0;
     nCamImp = 0;
     nCamFec = 0;
     nEuro = 0;
     aEuro = "";
     &nDeci_Base = 0;
     &nDeci_PreBase = 0;

     &eaImpreSiNo   = "N";
     &eaReimp       = "";
     &eaOrden       = "";

     &nDeci_Vto     = 0; ||Decimales Vtos
     &nFactor       = 0;
     &aMoneda = "";
     &aDivisa = "";

     aAlfa     = "";
     nTota     = 0;
     nCam      = 0;
     nEncuentra = 0;
     nCampos    = 0;

     i = 0;
     j = 0;
     num = 0;
     importe = 0;
     resto = 0;
     a = 0;
     yaesta = 0;
     lafecha = @;
     redondeo = 0;
     saltar = 0;
     informe1 = "agifa079";
     informe2 = "agif1079";
     informe = "";
     &iva1 = 0;
     &iva2 = 0;
     &iva3 = 0;
     &iva4 = 0;
     &iva5 = 0;
     &re1 = 0;
     &re2 = 0;
     &re3 = 0;
     &re4 = 0;
     &re5 = 0;
     &fechae = @;
     &bl  = "                              ";
|FIN;

||INC-LUYE llena_c1;

컴컴컴컴컴컴컴컴컴컴컴컴Modulo 004159컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO Agrupador;
     nEncuentra = 0;
     |LEE 101#5p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          |SI #5#2 = #agifa080@#2; |Y #5#39 = #agifa080@#39; |Y #agifa080@#39!0;
               nEncuentra = 1; |SAL;
          |FINSI;
          |LEE 101#5s;
     |SIGUE;
     |SI nEncuentra = 1;
          #5#6 = #5#6 + #agifa080@#6;   ||Precio
          #5#7 = #5#7 + #agifa080@#7;   ||Impo
          #5#9 = #5#9 + #agifa080@#9;   ||Total
          #5#30 = #5#30 + #agifa080@#30;||Precio Div
          #5#31 = #5#31 + #agifa080@#31;||Total Div
          |GRABA 020#5a;
     |SINO;
          aAlfa = "|NC"; aAlfa = #5#aAlfa#;
          nCampos = aAlfa; nCampos = nCampos - 1;
          |PARA i = 0; |SI i [ nCampos; |HACIENDO i = i + 1;
               #5i = #agifa080@#i#;
          |SIGUE;
          |GRABA 020#5n;
     |FINSI;
|FPRC;

|DEFBUCLE Agrupador;
     #agifa080@#1003;
     ;
     #4#50, #4#0, 001;
     #4#50, #4#0, 999;
     ;
     NULL, Agrupador;
|FIN;

|PROCESO AgruArtiIni;
     |DDEF aAlfa;
     aAlfa = aAlfa + "agifa080";
     |CARGA_DEF aAlfa, agifa080@;
     nSwSanchez = FSalida;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aAlfa = Usuario; aAlfa = "5" + aAlfa;
     |NOME_DAT #5 aAlfa;


     |DELINDEX #5;
     |ABRE #5;
     |BUCLE Agrupador;
     |CIERRA #5;
|FPRC;

|PROCESO AgruArtiFin;
     |DESCARGA_DEF #agifa080@;
     |DELINDEX #5;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴

|CALCULO leepago;|TIPO 0;
   |ABRE #10;
   #10#0 = #1#11;
   |LEE 121#10=;
   |SI 0 ! FSalida;
      |DDEFECTO #10;
   |FINSI;
   |CIERRA #10;
|FCAL;

|PROCESO DesAmpli_C;
     enSwDA = 1;
     |PRINT;
     enSwDA = 0;
|FPRC;

|DEFBUCLE DesAmpli_C;
     #83#1;
     ;
     "A", #5#27, #5#0, #5#1, 001;
     "A", #5#27, #5#0, #5#1, 999;
     ;
     NULL, DesAmpli_C;
|FIN;

|CALCULO imprelin;|TIPO 0;
     |SI #4#73 = "N";   || Portes Lin no Facturables
          #5#31 = #5#31 - (#5#42*#5#5);
     |FINSI;
     enArtImp = #5#2; |QBF enArtImp;
     |PRINT;

     |HAZ EsAparecida;
     |SI FSalida = 0;
          eaArticulo = #5#2;
          |HAZ ImpAparecida;
     |FINSI;

     |SI nSwSematel = 0;
          |HAZ ImpreIMEI;
     |FINSI;

     |SI #279#6 = "S";
          |BUCLE DesAmpli_C;
     |FINSI;
|FCAL;

|CALCULO facimprl;|TIPO 0;
     eaSerLog = #1#66;
     eaNumLog = (A\("000000" + #1#0) % -106);
     eaTipLog = "FC";
     |HAZ ImprimeLog;

     aDivisa = #1#75;
     |HAZ HallaFactor;
     |PDEFECTO #136, 13, 37;
     #136#13 = #1#33 * nFactor; #136#14 = #1#68; |SI #136#13 ! 0;nCam = 13;|FINSI;
     #136#15 = #1#34 * nFactor; #136#16 = #1#69; |SI #136#15 ! 0;nCam = 15;|FINSI;
     #136#17 = #1#35 * nFactor; #136#18 = #1#70; |SI #136#17 ! 0;nCam = 17;|FINSI;
     #136#19 = #1#36 * nFactor; #136#20 = #1#71; |SI #136#19 ! 0;nCam = 19;|FINSI;
     #136#21 = #1#37 * nFactor; #136#22 = #1#72; |SI #136#21 ! 0;nCam = 21;|FINSI;
     #136#23 = #1#38 * nFactor; #136#24 = #1#73; |SI #136#23 ! 0;nCam = 23;|FINSI;
     #136#25 = #1#39 * nFactor; #136#26 = #1#129;|SI #136#25 ! 0;nCam = 25;|FINSI;
     #136#27 = #1#40 * nFactor; #136#28 = #1#130;|SI #136#27 ! 0;nCam = 27;|FINSI;
     #136#29 = #1#41 * nFactor; #136#30 = #1#131;|SI #136#29 ! 0;nCam = 29;|FINSI;
     #136#31 = #1#42 * nFactor; #136#32 = #1#132;|SI #136#31 ! 0;nCam = 31;|FINSI;
     #136#33 = #1#43 * nFactor; #136#34 = #1#133;|SI #136#33 ! 0;nCam = 33;|FINSI;
     #136#35 = #1#44 * nFactor; #136#36 = #1#134;|SI #136#35 ! 0;nCam = 35;|FINSI;
     #136#47 = #1#146 * nFactor;
     #136#48 = #1#147;

     nTota=#136#13+#136#15+#136#17+#136#19+#136#21+#136#23+#136#25;
     nTota= nTota +#136#27+#136#29+#136#31+#136#33+#136#35;
     nTotaFac = #1#118 - #136#47;
     |SI nTota ! nTotaFac;
          nTota = nTota - nTotaFac;
          #136nCam = #136nCam - nTota;
     |FINSI;

     |DDEFECTO #4;
     #4#0 = #2#2;
     #4#50 = #2#17;
     |LEE 121#4=;
     |SI FSalida = 0;
          #4#10 = "S";
          |GRABA 020#4a;
          |LIBERA #4;

          |SI #3#42 = AS;
               |PRINT;
          |SINO;
             |SI nSwSanchez = 0; |HAZ AgruArtiIni; |FINSI;
             |BUCLELIN 2imprelin#4;
             |SI nSwSanchez = 0; |HAZ AgruArtiFin; |FINSI;
          |FINSI;
     |FINSI;
|FCAL;

|DEFBUCLE facimprl_1;
     #2#1;
     17,2;
     #1#66,#1#0,001,"     ",000001;
     #1#66,#1#0,999,"zzzzz",999999;
     ;
     NULL, NULL, NULL, NULL, NULL, facimprl;
     #2#17,#2#2;
|FIN;


|PROCESO IVAS;
     eaPrv = #1#2;
     efFiva = #1#1;
     enTiva = 1; |HAZ IVAPrv; iva1 = enIva; re1 = enRec;
     enTiva = 2; |HAZ IVAPrv; iva2 = enIva; re2 = enRec;
     enTiva = 3; |HAZ IVAPrv; iva3 = enIva; re3 = enRec;
     enTiva = 4; |HAZ IVAPrv; iva4 = enIva; re4 = enRec;
     enTiva = 5; |HAZ IVAPrv; iva5 = enIva; re5 = enRec;
|FPRC;

|CALCULO facimpr1;|TIPO 0;
     |SI nSwPackList = 0;
          eaDoc = "FC" + #1#66 + #1#0;
          |HAZ PackListVar;
     |FINSI;

     |HAZ IVAS;

     aDivisa = #agifa079#75;
     aMoneda = #agifa079#77;
     |HAZ Divisas079;

     |SI #3#0 ! #1#2;
          #3#0 = #1#2;|LEE 041#3=;
          |SI 0 ! FSalida;|DDEFECTO #3;|FINSI;
     |FINSI;
     |HAZ mirainf;
     |INFOR informe;
     |SI 0 = FSalida;
          |SI #0#6 = "N";
               ||HAZ VenciComp;
               #1#45 = AS;
               |GRABA 020#1a;
               |HAZ llenarec;
          |FINSI;
          eaImpreSiNo = "S";
          |SI #0#11 = "N";
               |BUCLELIN 0facimprl#1;
          |SINO;
               |BUCLE facimprl_1;
          |FINSI;
          |PIEINF;
          |FININF;
     |FINSI;
|FCAL;


|DEFBUCLE agifa079;
     #1#1;
     2,1,45,31;
     #0#9  , #0#2 , #0#0, #0#4, #0#6, #0#7;
     #0#10 , #0#3 , #0#1, #0#5, #0#6, #0#8;
     e;
     NULL, facimpr1,NULL,NULL;
|FIN;

|CALCULO facimpr; |TIPO 3;
     |ABRE #5;
     |ABRE #4;
     |ABRE #3;
     aAlfa = eaImprime; |QBF aAlfa;
     |SI aAlfa = "";
        |IMPRE 2;
     |SINO;
        Impresora = eaImprime;
        |IMPRE -1;
     |FINSI;
     |SI 0 = FSalida;
          |ABRE #40;
          |BUCLE agifa079;
          |CIERRA #40;
          |FINIMP;
     |FINSI;
     |CIERRA #3;
     |CIERRA #4;
     |CIERRA #5;
|FCAL;

|PROCESO miralinea;
     |DDEFECTO #4;
     #4#0 = #2#2;
     #4#50 = #2#17;
     |LEE 121#4=;
     |ERROR10;
|FPRC;

|PROCESO mirainf;
     |BUCLELIN 0miralinea#1;
     #40#26 = #1#66;
     |LEE 001#40=;
     nSal = FSalida;
     |SI FSalida = 0;
          |SI #4#42 = "N";
               informe = #40#10; |QBF informe;
          |SINO;
               informe = #40#16; |QBF informe;
          |FINSI;
     |SINO;
          |SI #4#42 = "N";
               informe = informe1;
          |SINO;
               informe = informe2;
          |FINSI;
     |FINSI;

     |SI nSwRavenida = 0;
          |HAZ RaveInf;
     |FINSI;
|FPRC;

|PROCESO RaveInf;
     aTipo = "";
     |DDEF aAlfa;
     aAlfa = aAlfa + "ravem006";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          #referen@#0 = #1#66;
          #referen@#1 = #1#0;
          |LEE 000#referen@.=;
          |SI FSalida = 0;
               aTipo = #referen@#2;
          |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
     |SI aTipo = "N";
          |ACABA;
     |FINSI;

     |DDEF aAlfa;
     aAlfa = aAlfa + "ravem003";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #1#66;
          |LEE 000#referen@.=;
          |CIERRA #referen@;

          |SI nSal = 0;
               |SI #4#42 = "N";
                    informe = #referen@#1; |QBF informe;
               |SINO;
                    informe = #referen@#2; |QBF informe;
               |FINSI;
          |SINO;
               |SI #4#42 = "N";
                    informe = "rave2079";
               |SINO;
                    informe = "rave3079";
               |FINSI;
          |FINSI;

          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|CALCULO llenarec;
     |HAZ leepago;
     |DDEFECTO #11;
     #11#0 = #1#0;
     #11#17 = #1#66;
     |PARA i = 1;|SI i [ 12; |HACIENDO i = i + 1;
          nCamImp = i + 32;
          |SI #1nCamImp ! 0; nNumRecibos = i; |FINSI;
     |SIGUE;
     |SI #1#146 ! 0; nNumRecibos = nNumRecibos + 1; |FINSI;

     |HAZ AbreRecCompra;
     |PARA i = 1;|SI i [ 12; |HACIENDO i = i + 1;
          nCamImp = i + 32;
          ||SI #1nCamImp = 0; |O i > 12; |ACABA; |FINSI;
          |SI #1nCamImp = 0; |O i > 12; |SAL; |FINSI;
          |SI i [ 6;
               nCamFec = i + 67;
          |SINO;
               nCamFec = i + 122;
          |FINSI;
          #11#7 = #1#1;
          #11#8 = #1nCamFec;
          #11#9 = #1nCamImp;
          #11#1 = i;
          #11#2 = #1#2;
          #11#3 = #1#3;
          #11#4 = #1#9;
          #11#12 = #1#12;
          #11#18 = #10#69;      ||Tipo de Recibo
          #11#21 = #10#69;
          #11#23 = nNumRecibos;
          #11#24 = #10#0;
          #11#25 = #10#1;

          |ABRE #177;
          #177#0 = #11#18;
          |LEE 000#177=;
          |CIERRA #177;

          #11#15 = #177#3;      ||Cuenta
          ||HAZ CreaRecCompra;
          |HAZ RecCompra;
     |SIGUE;
     |SI #1#146 ! 0;
          #11#7 = #1#1;
          #11#8 = #1#147;
          #11#9 = #1#146;
          #11#1 = i;
          #11#2 = #1#2;
          #11#3 = #1#3;
          #11#4 = #1#9;
          #11#12 = #1#12;
          #11#18 = #10#73;      ||Tipo de Recibo
          #11#21 = #10#73;
          #11#23 = nNumRecibos;
          #11#24 = #10#0;
          #11#25 = #10#1;

          |ABRE #177;
          #177#0 = #11#18;
          |LEE 000#177=;
          |CIERRA #177;

          #11#15 = #177#3;      ||Cuenta

          |HAZ RecCompra;
     |FINSI;
     |HAZ CierraRecCompra;
|FCAL;

|PROGRAMA;
     ||컴컴컴컴컴컴컴컴컴컴컴
     |HAZ EsSanchez;
     nSwSanchez = FSalida;
     ||컴컴컴컴컴컴컴컴컴컴컴
     |HAZ EsRavenida;
     nSwRavenida = FSalida;

     |SI PRMNT_Imp ! "";
          eaSer = PRMNT_Imp % 105; aAlfa = PRMNT_Imp % 606;
          enNum = aAlfa;
          eaOrden = "N";
          |ABRE #1; #1#66 = eaSer; #1#0 = enNum; |LEE 000#1=; |CIERRA #1;
          eaReimp = #1#45;
     |FINSI;

     |HAZ MiraLogos; || Copia Logos para el Crystal

     |ABRE #279; |LEE 000#279p; |CIERRA #279;

     |HAZ EsPackList;
     nSwPackList = FSalida;

     |HAZ EsSematel;
     nSwSematel = FSalida;

     |SI enNum = 0;
          |MANTE #0;
     |SINO;
          eaImpreSiNo = "N";
          |DDEFECTO #0;
          #0#9 = eaSer;
          #0#10 = eaSer;
          #0#2 = enNum;
          #0#3 = enNum;
          #0#6 = eaReimp;
          #0#11 = eaOrden;
          #0#4 = "01.01.0000";
          #0#5 = "31.12.9999";
          |HAZ facimpr;
     |FINSI;
|FPRO;

|PROCESO LeeDecimBase; |TIPO 8;
     |ABRE #agifa321;
     |ABRE #agifa324;
     |LEE 001#agifa321.p;
     #agifa324#0 = #agifa321#9; ||Igualo a moneda base
     |LEE 001#agifa324.=;
     nDeci_Base = #agifa324#7;  ||Decimales moneda base
     nDeci_PreBase = #agifa324#9;  ||Decimales precio de moneda base
     |CIERRA #agifa321;
     |CIERRA #agifa324;
|FPRC;

|PROCESO ImpreIMEI;
     |DDEF aPath;
     aAlfa = aPath + "tlfm0001";
     |CARGA_DEF aAlfa, tlfm0001@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar 'tlfm0001'";
     |SINO;
          aAlfa = aPath + "tlfm0002"
          |CARGA_DEF aAlfa, tlfm0002@;
          |SI FSalida ! 0;
               |MENAV "0000Error al cargar 'tlfm0002'";
          |SINO;
               enSwIMEI = 1;
               |ABRE #101; |SELECT #3#101;
               |ABRE #102; |SELECT #3#102;
               |PARA i = 1; |SI i [ 99; |HACIENDO i = i + 1;
                    eaIMEI = ""; eaABO = ""; eaICC = "";
                    #101#49 = #5#27;
                    #101#50 = #5#0;
                    #101#51 = #5#1;
                    #101#52 = i;
                    |LEE 000#101=;
                    nSal1 = FSalida;
                    |SI FSalida = 0; eaIMEI = #101#0; |FINSI;
                    #102#44 = #5#27;
                    #102#45 = #5#0;
                    #102#46 = #5#1;
                    #102#47 = i;
                    |LEE 000#102=;
                    nSal2 = FSalida;
                    |SI FSalida = 0; eaABO = #102#3; eaICC = #102#4; |FINSI;
                    |SI nSal1 ! 0; |Y nSal2 ! 0;
                         |SAL;
                    |SINO;
                         |PRINT;
                    |FINSI;
               |SIGUE;
               |CIERRA #101;
               |CIERRA #102;
               enSwIMEI = 0;
               |DESCARGA_DEF #tlfm0002@;
          |FINSI;
          |DESCARGA_DEF #tlfm0001@;
     |FINSI;
|FPRC;
