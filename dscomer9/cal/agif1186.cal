|FICHEROS;
     agifa010 #0;        || Albaranes
     agifa019 #2;
     agifa071 #3;
     agifa024 #4;
     agifa142 #42;       || Parametros Generales
     agifa186 #100;
     agifa321 #321;
     agifa324 #324;
|FIN;

|VARIABLES;
     &eaIva = "";
     &eaCli    = "";
     &enTiva   = 0;
     &enIva    = 0;
     &enRec    = 0;
     imneto    = 0;
     tf        = 0;
     mes       = 0;
     margen    = 0;
     base0     = 0;
     base1     = 0;
     base2     = 0;
     base3     = 0;
     base4     = 0;
     base5     = 0;
     importe   = 0;
     totalbac  = 0;
     nMult     = 0;
     nImpDiv   = 0;

     &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_Div      = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDiv   = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVis   = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVis = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVis   = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVis   = 0;   || Decimales en el Importe visual. (lineas)
     &decim_divisa = 0;  || Decimales de la divisa
     &precio_divisa = 0; || Decimales del precio en divisa
     &decim_base = 0;    || Decimales de la moneda base
     &precio_base = 0;   || Decimales del precio en moneda base
|FIN;

|PROCESO Param_Divisas; |TIPO 0;
     |ABRE #agifa321;
     |LEE 001#agifa321.p;   || Leo la divisa
     |CIERRA #agifa321;

     |ABRE #agifa324;
     #agifa324#0 = #agifa010#68;
     |LEE 001#agifa324.=;   || Leo la divisa
     |CIERRA #agifa324;

     decim_divisa = #agifa324#7;  || Decimales de la divisa
     precio_divisa = #agifa324#9;  || Decimales en el precio de la divisa
     nDeci_Div = decim_divisa;   || Decimales de la divisa
     nDeci_PreDiv = precio_divisa;  || Decimales en el precio de la divisa
     |SI #0#70 = "B";   || Si trabajo con la moneda base ...
          nDeci_PreVis   = precio_divisa;
          nDeci_ImpVis   = decim_divisa;
          nDeci_Base     = decim_base;
          nDeci_PreBase  = precio_base;
          nDeci_BaseMx  = decim_base;
          nDeci_PreBaseMx = precio_base;
          nDeci_TotVis   = decim_base;
          nDeci_TotNoVis = decim_divisa;
     |SINO;     || Si trabajo con la divisa ...
          nDeci_PreVis   = precio_base;
          nDeci_ImpVis   = decim_base;
          nDeci_Base     = decim_base; || Max. precision en los decimales de la moneda base
          nDeci_PreBase  = precio_base;  || Max. precision en los dec. del precio de la moneda base
          |SI #agifa010#69 = 1;
               nDeci_BaseMx    = decim_base;    || sin triangulacion
               nDeci_PreBaseMx = precio_base;
          |SINO;
               nDeci_BaseMx    = #agifa321#10;  || con triangulacion
               nDeci_PreBaseMx = #agifa321#11;
          |FINSI;
          nDeci_TotVis   = decim_divisa;
          nDeci_TotNoVis = decim_base;
     |FINSI;
     |HAZ Deci_IVA;
|FPRC;

|PROCESO acttl;|TIPO 0;
     |ABRE #2;
     #2#0 = #3#2;
     |LEE 000#2=;
     |CIERRA #2;

     |SI #100#7 ! "*";
          #3#11 = #100#7;
     |FINSI;
     |SI eaIva = "X";
          #3#11 = #2#30;
     |FINSI;

     |HAZ TotalLin71;
     |GRABA 020#3a;

     |HAZ CalCabAgifa010;
|FPRC;

|PROCESO RecalcuAlba;
     |ABRE #42; |LEE 000#42p; |CIERRA #42;

     |ABRE #0;
     #0#0 = #100#4;||Albaran;
     #0#52= #100#2;||Serie;
     |LEE 121#0=;
     |HAZ Param_Divisas;
     |HAZ LimCabAgifa010;
     |BUCLELIN 2acttl#0;
     |GRABA 020#0a;
     |CIERRA #0;
|FPRC;
