|FICHEROS;
     ibery009 #0;  ||Este Def
     temp0020 #2;  ||Temporal Estadisticas.
     agifa501 #3;  ||Cabecera Tic.
     agifa502 #4;  ||Lineas T.
     agifa019 #5;  ||Articulos.
     iber0020@ #20;
     tempfafa #100; || Temporal para series
|FIN;

|VARIABLES;
     nSw = 0;
     &enSwTotal = 0;
     &Tempo    = "";
     &enSwIber = 0;
     aSerAnt   = "";
     aAlfa     = "";
     aTempo2   = "";
     aTempo100 = "";
     total     = 0;
     i         = 0;
     j         = 0;
     diaSema   = "";
     f         = @;
     f_ini     = @;
     fichero   = "";
     informe   = "ibery009";
     campo     = 0;
     dia       = @;
     mes       = @;
     ano       = @;
     dfecha    = @;
     hfecha    = @;
     alfa      = "";
     alfa1     = "";
     beta      = 0;
     &impCos   = 0;
     &impVen   = 0;
     &impBen   = 0;
     &impUni   = 0;
     impDiaAnt = 0;
     impDiaSem = 0;
     impSemAnt = 0;
     impMesAnt = 0;
     impAnoAnt = 0;
     reg       = 0;
     nHay      = 0;
|FIN;

|PROCESO Impre;
     |DDEFECTO #5;
     #5#0 = #2#1;
     |LEE 000#5=;

     |SI aSerAnt ! #2#14; |Y aSerAnt ! "";
          |PIEINF;
     |FINSI;
     aSerAnt = #2#14;
     |PRINT;
     nHay = 1;
|FPRC;

|DEFBUCLE TemporalSub;
     #2#4;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Impre;
|FIN;

|DEFBUCLE TemporalFam;
     #2#3;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Impre;
|FIN;

|DEFBUCLE TemporalArt;
     #2#2;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Impre;
|FIN;

|PROCESO Porcentaje;
     impBen = impVen - impCos;

     #2#6  = #2#5 * #2#3;
     #2#8  = #2#9 / #2#3;

     #2#11 = #2#9 - #2#6;

     #2#4  = #2#3  * 100 / impUni;
     #2#7  = #2#6  * 100 / impCos;
     #2#10 = #2#9  * 100 / impVen;

     #2#13 = #2#11 * 100 / impBen;

     #2#12 = #2#11 * 100 / #2#9;
     |GRABA 021#2a;

     ||--------------------Temporal Series
     #100#0 = #2#14;
     |LEE 000#100=;
     |SI FSalida ! 0;
          |GRABA 020#100n;
     |FINSI;
|FPRC;

|DEFBUCLE Porcentaje;
     #2#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Porcentaje;
|FIN;
--------------------------------------------------
|PROCESO leelin;
     |SI #4#2 < #0#16; |O #4#2 > #0#17; |ACABA; |FINSI;

     #5#0 = #4#2; || Articulo...
     |LEE 000#5=;
     |SI FSalida ! 0; |DDEFECTO #5; |FINSI;

     |SI #5#2 < #0#8; |O #5#2 > #0#9; |ACABA; |FINSI;
     |SI #5#3 < #0#10; |O #5#3 > #0#11; |ACABA; |FINSI;

     |DDEFECTO #2;
     reg = reg + 1;
     #2#0 = reg;
     #2#1 = #4#2;   || Articulo
     #2#2 = #5#1;   || Descripcion.
     #2#14 = #3#57; ||Se
     #2#15 = #5#2;  ||Fam
     #2#16 = #5#3;  ||Sub
     |LEE 000#2=;
     |SI FSalida ! 0;
          |GRABA 021#2b;
     |SINO;
          reg = reg - 1;
     |FINSI;

     #2#3 = #2#3 + #4#5;  || Total Unidades.

     |SI #3#31 ! "R"; |Y #3#31 ! "L"; |Y #3#31 ! "A";
          |SI #0#15 = "S";
               #2#9 = #2#9 + #4#7;           || Total Importe.
          |SINO;
               #2#9 = #2#9 + #4#21;          || Total Importe.
          |FINSI;
     |FINSI;

     ||#2#5 = #5#9;                       || P.M.C.
     ||impCos = impCos + (#4#5 * #5#9);   ||Total Coste.

     #2#5 = #4#23 / #4#5;
     impCos = #4#23;

     |SI #3#31 ! "R"; |Y #3#31 ! "L"; |Y #3#31 ! "A";
          |SI #0#15 = "S";
               impVen = impVen + #4#7;       ||Total Ventas.
          |SINO;
               impVen = impVen + #4#21;       ||Total Ventas.
          |FINSI;
     |FINSI;

     impUni = impUni + #4#5;            ||Total Unidades.
     |GRABA 021#2a;
     |LIBERA #2;
|FPRC;

|DEFBUCLE leelin;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, leelin;
|FIN;

|PROCESO agifa501;
     nSw = 0;
     |SI #3#31 = "R"; |Y #0#12 = "N"; nSw = 1; |FINSI;
     |SI #3#31 = "A"; |Y #0#13 = "N"; nSw = 1; |FINSI;
     |SI #3#31 = "L"; |Y #0#14 = "N"; nSw = 1; |FINSI;
     |SI nSw = 1; |ERROR; |ACABA; |FINSI;
     |BUCLE leelin;
|FPRC;

|DEFBUCLE agifa501;
     #3#3;
     9;
     #0#0, "      ", " ", #0#4, 000000, #0#6;
     #0#1, "zzzzzz", "z", #0#5, 999999, #0#7;
     ;
     NULL, agifa501;
|FIN;

|PROCESO agifa019;
     |SI #5#2 < #0#8; |O #5#2 > #0#9; |ACABA; |FINSI;
     |SI #5#3 < #0#10; |O #5#3 > #0#11; |ACABA; |FINSI;

     |SI enSwIber = 0;
          #20#2 = #5#0;
          #20#1 = 0;
          |LEE 000#20];
          |SI #20#2 ! #5#0; |O FSalida ! 0;
               |ACABA;
          |FINSI;
     |FINSI;
     #2#1 = #5#0;
     |LEE 000#2=;
     |SI FSalida ! 0;
          reg = reg + 1;
          |DDEFECTO #2;
          #2#0 = reg;
          #2#1 = #5#0;
          #2#2 = #5#1;
          #2#15 = #5#2;
          #2#16 = #5#3;
          #2#14 = #100#0;
          |GRABA 020#2n;
     |FINSI;
|FPRC;

|DEFBUCLE agifa019;
     #5#1;
     ;
     #0#16;
     #0#17;
     ;
     NULL, agifa019;
|FIN;

|PROCESO Tempo100;
     |SELECT #2#2;
     |SI enSwIber = 0;
          |DDEF aAlfa;
          aAlfa = aAlfa + "iber0020";
          |CARGA_DEF aAlfa, iber0020@;
          |SI FSalida = 0;
               |ABRE #20;
               |SELECT #2#20;
               |BUCLE agifa019;
               |CIERRA #20;
               |DESCARGA_DEF #iber0020@;
          |SINO;
               aAlfa = "0000ERROR al cargar " + aAlfa;
               |MENAV aAlfa;
          |FINSI;
     |SINO;
          |BUCLE agifa019;
     |FINSI;
|FPRC;

|DEFBUCLE Tempo100;
     #100#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Tempo100;
|FIN;

|PROCESO SinMovi;
     |BUCLE Tempo100;
|FPRC;

|PROCESO inicio; |TIPO 3;
     |HAZ EsIber21;
     |HAZ CreaTempo; aTempo100 = Tempo;
     |NOME_DAT #100 aTempo100; |DELINDEX #100;

     |HAZ CreaTempo; aTempo2 = Tempo;
     |NOME_DAT #2 aTempo2; |DELINDEX #2;
     |ABRE #2;

     |IMPRE 0;
     |SI FSalida = 0;
          |INFOR informe;
          |SI FSalida = 0;
               |ABRE #3; |ABRE #4; |ABRE #5;
               |SI #0#3 = 1; |SELECT #2#2; |FINSI;
               |SI #0#3 = 2; |SELECT #2#2; |FINSI;
               |SI #0#3 = 3; |SELECT #2#2; |FINSI;
               |BUCLE agifa501;
               |ABRE #100;
               |BUCLE Porcentaje;
               |CIERRA #100;
               |SI #0#2 = "N";
                    |HAZ SinMovi;
               |FINSI;
               |SI #0#3 = 1; |BUCLE TemporalArt; |FINSI;
               |SI #0#3 = 2; |BUCLE TemporalFam; |FINSI;
               |SI #0#3 = 3; |BUCLE TemporalSub; |FINSI;
               enSwTotal = 1;
               |PIEINF;
               |SI nHay ! 0; |FININF; |FINSI;
               |CIERRA #3; |CIERRA #4; |CIERRA #5;
          |FINSI;
          |FINIMP;
     |FINSI;
     |CIERRA #2;
     |DELINDEX #100; Tempo = aTempo100; |HAZ BoraTempo;
     |DELINDEX #2; Tempo = aTempo2; |HAZ BoraTempo;
|FPRC;
