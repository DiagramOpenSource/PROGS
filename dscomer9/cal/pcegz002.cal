               ANULADO, impresion antigua

/*
|FICHEROS;
     pcegz002 #0;
     pcegm002 #1;
     pcegm003 #2;
     agifa024 #3;
     pcegm011 #11;  ||email usu
     agifa038 #13;
     agifa048 #15;
     agifa049 #16;
     agifa019 #19;
     agifa007 #40;
     agifa041 #41;
     agifa142 #142;
     dsm00053 #53;
     dsm00050 #50;
     agifa091 #91;
     pcegm025 #25;
     agifa066;||*
     agifa321;
     agifa324;
     dsm00087;
     gestempo;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     &enOferta = 0;
     &enPro1 = 0; &enPro2 = 0; &enPro3 = 0; &enPro4 = 0; &enPro5 = 0;
     &enPro6 = 0; &enPro7 = 0; &enPro8 = 0; &enPro9 = 0; &enPro10 = 0;
     &eaFich = "";
     nHandle = 0;
     aCuerpo = "";
     aDestino = "";
     aNomFic = "";
     aNumFax = "";
     aDjunto = "";
     aFic = "";
     aIPRemoto = "";
     aDes = "";
     aDirDestino = "";
     aNumMail = "";
     aIP = "";
     aServidor = "";
     aFrom = "";
     aTo = "";
     aSubject = "";
     aMensaje = "";


     &eaTipoImp = "";
     nPrecio = 0;
     nPrecioD = 0;
     aAlfa = "";
     nTotal = 0;
     nTotalD = 0;
     aEsPostFormaso = "N";
     &eaDoc = "";

     &aMoneda     = "";
     &aDivisa     = "";
     &enEscan    = 0;
     &enCodig     = 0;
     &eaNArticulo = "";
     &n5Elem      = 0;
     &enImpo = 0;

     indtope = 0;
     ind = 0;
     informe  = "";
     &informe1 = "";

     &numero = 0;
     &serie  = "";
     &reimpr = "";
     &iva1 = 0;
     &iva2 = 0;
     &iva3 = 0;
     &iva4 = 0;
     &iva5 = 0;
     &re1 = 0;
     &re2 = 0;
     &re3 = 0;
     &re4 = 0;
     &re5 = 0;
     &codigo="";
     &descrip="";
     &precio=0;
     &dto=0;
     &unid=0;
     &imptot=0;
     &tiva=0;
     &linea=0;
     vacio="";
     &bl  = "                              ";
|FIN;

|PROCESO CargaMail;
     |FINIMP;
     |SI #0#11 = "M";
          |HAZ EnviaCorreo;
     |FINSI;
|FPRC;

|PROCESO EnviaCorreo;
     aDjunto = aFic;

     |SI aIPRemoto ! "";
          |DFICE aDes;
          aDes = aDes + aNomFic;
          |RECIBE_FICHERO aFic, aDes;
          aDjunto = aDes;

          |RFBORRA aFic;
     |FINSI;

     |HAZ Cuerpo;

     aDirDestino = aNumMail; |QBF aDirDestino;

     aIP = "xdscorreo.dv.diagram.net";
     aServidor = "asmtp.diagram.es";

     aTo = aDirDestino;
     aSubject = "Oferta nº:" + #1#48 + "/" + (("000000" + #1#0) % -106);
     aMensaje = "$$$$" + aCuerpo;
     |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
     |SI FSalida < 0;
          aAlfa = "Factura nº " + #1#48 + "/" + (("000000" + #1#0) % -106);
          aAlfa = "0000Error al enviar correo:" + &13 + aAlfa;
          |MENAV aAlfa;
     |FINSI;

     |FBORRA aDjunto;
|FPRC;

|PROCESO TextoMail;
     aAlfa = #25#3;
     |XGRABA nHandle, aAlfa;
|FPRC;

|DEFBUCLE TextoMail;
     #25#1;
     ;
     #1#48, #1#0, 01;
     #1#48, #1#0, 99;
     ;
     NULL, TextoMail;
|FIN;

|PROCESO Cuerpo;
     |DFICE aCuerpo;
     aCuerpo = aCuerpo + "mail";
     |XABRE "W", aCuerpo, nHandle;
     |SI FSalida ] 0;
          |BUCLE TextoMail;
          |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROCESO impdesam;|TIPO 0;
     #13#0 = #2#18;
     |ABRE #13;
     |LEE 101#13=;
     |SI 0=FSalida
          |HAZ xx;
     |FINSI;
     |LIBERA #13;
     |CIERRA #13;
|FPRC;

|PROCESO xx;
     indtope=0;
     |PARA ind=6;|SI ind>0;|HACIENDO ind=ind-1;
          descrip=#13ind;
          |QBF descrip;
          |SI descrip ! vacio;
               indtope=ind+1;
               ind=0;
          |FINSI;
     |SIGUE;

     |PARA ind=1;|SI ind < indtope;|HACIENDO ind=ind+1;
          descrip=#13ind;
          linea=0;
          |PRINT;
     |SIGUE;
|FPRC;


|PROCESO escanlinea;
    unid = #16#4 * #2#5;
    descrip = #16#3;
    codigo = "";
    dto = 0;
    precio = 0;
    imptot = 0;
    tiva = 0;
    linea = 1;
    |PRINT;
|FPRC;

|PROCESO DesAmpli;
     |DDEFECTO #2;
     #2#3 = 0;      || Almacen
     #2#4 = #53#5;
     descrip = #2#4;
     codigo = "";
     dto = "";
     precio = "";
     unid = "";
     imptot = "";
     tiva = "";
     |PRINT;
|FPRC;

|DEFBUCLE DesAmpli;
     #53#1;
     ;
     "X", #2#20, #2#0, #2#1, 001;
     "X", #2#20, #2#0, #2#1, 999;
     ;
     NULL, DesAmpli;
|FIN;

|PROCESO dsm00050;
     unid = #2#5 * #50#5;
     |PRINT;
|FPRC;

|DEFBUCLE dsm00050;
     #50#1;
     ;
     #2#20, #2#0, #2#1, 001;
     #2#20, #2#0, #2#1, 999;
     ;
     NULL, dsm00050;
|FIN;

|PROCESO ImpreNormal;
     enArtImp = #2#2; |QBF enArtImp;
     codigo=#2#2;
     descrip=#2#4;
     dto=#2#8;
     precio = #2#6;
     unid=#2#5;
     imptot=#2#9;
     tiva=#2#11;
     linea=1;
     |PRINT;

     |SALVA_DATOS #2;
     |BUCLE DesAmpli;
     |REPON_DATOS #2;

     |HAZ impdesam;

     |SI #142#16 = "S";
          eaArticulo = #2#2;
          |HAZ EsEscandallo;
          |SI FSalida = 0;
               |HAZ EsKit;
               |SI FSalida = 0;
                    enEscan = 2;
                    |BUCLE dsm00050;
               |SINO;
                    enEscan = 1;
                    |BUCLELIN 0escanlinea#15;
               |FINSI;
               enEscan = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO conimprl;
     eaSerLog = #2#20;
     eaNumLog = (A\("000000" + #2#0) % -106);
     eaTipLog = "OF";
     |HAZ ImprimeLog;
     |HAZ ImpreNormal;
|FPRC;

|PROCESO conimpr2;|TIPO 0;
     |PIEINF;
     |FININF;

     |SI #0#6 = "N";
          #1#10 = AS;
          |BORRA 020#1a;
          |GRABA 020#1n;
     |FINSI;

     |SI #0#11 = "M";
          |HAZ CargaMail;
     |FINSI;
|FPRC;

|PROCESO conimpr1;|TIPO 0;
     aNumFax = #1#89; |QBF aNumFax;
     aNumMail = #1#88; |QBF aNumMail;

     |SI #0#11 = "M"; |Y aNumMail = "";
          aAlfa = #1#48 + "/" + (("000000" + #1#0) % -106);
          aAlfa = "0000No se ha indicado Email en la oferta: " + aAlfa;
          |MENAV aAlfa;
          |ERROR; |ACABA;
     |FINSI;

     |SI #0#11 = "M";
          aFrom = "";
          |ABRE #11;
          #11#0 = #1#98;
          |LEE 000#11=;
          |SI FSalida = 0;
               aFrom = #11#1; |QBF aFrom;
          |FINSI;
          |SI aFrom = "";
               aAlfa = "0000Usuario: [" + #1#98 + "] sin direccion mail configurada";
               |MENAV aAlfa;
               |ERROR; |ACABA;
          |FINSI;
          aAlfa = "";
          #11#0 = Usuario % 810;
          |LEE 000#11=;
          |SI FSalida = 0;
               aAlfa = #11#1; |QBF aAlfa;
          |FINSI;
          |SI aAlfa = "";
               aAlfa = "0000Usuario: [" + #11#0 + "] sin direccion mail configura, ni envia copia";
               |MENAV aAlfa;
          |SINO;
               aNumMail = aNumMail + ";" + aAlfa;
          |FINSI;
          |CIERRA #11;
     |FINSI;

     |SI #0#11 = "F"; |Y aNumFax = "";
          aAlfa = #1#48 + "/" + (("000000" + #1#0) % -106);
          aAlfa = "0000No se ha indicado numero de fax en la oferta: " + aAlfa;
          |MENAV aAlfa;
          |ERROR; |ACABA;
     |FINSI;

     |SI #0#11 = "M";
          aNomFic = #1#48 +(("000000"+#1#0)%-106)+".pdf";|QBT aNomFic;
          |DBASS aFic;
          |SI aIPRemoto = "";
               |MKDIR "c:\dsmail\";
          |SINO;
               |RMKDIR "c:\dsmail\";
          |FINSI;
          aFic = "c:\dsmail\" + aNomFic;
          Impresora = "CrystalReport;" + aFic;
          |IMPRE -1;
          |SI FSalida ! 0; |ERROR; |ACABA; |FINSI;
     |FINSI;

     aDivisa = #pcegm002#65;
     aMoneda = #pcegm002#67;
     |HAZ Divisas146;

     |SI #1#73 < #0#7; |O #1#73 > #0#8;
          |ERROR;
          |ACABA;
     |FINSI;

     #3#0 = #1#3;
     |LEE 021#3=;
     |SI 0 ! FSalida;|DDEFECTO #3;|FINSI;

     |ABRE #91;
     #91#0 = #1#8;
     |LEE 000#91=;
     |SI FSalida ! 0; |DDEFECTO #91; |FINSI;
     |CIERRA #91;

     |ABRE #40;
     #40#26 = #1#48;
     |LEE 001#40=;
     |SI FSalida ! 0;  |DDEFECTO #40;  |FINSI;
     |CIERRA #40;

     informe = #40#20; |QBF informe;
     informe1 = (informe % 0104) + "5" + (informe % 0603); |QBF informe1;

     iva1 = #1#50; re1 = #1#51;
     iva2 = #1#52; re2 = #1#53;
     iva3 = #1#54; re3 = #1#55;
     iva4 = #1#56; re4 = #1#57;
     iva5 = #1#58; re5 = #1#59;

     |INFOR informe;
     |SI FSalida ! 0; |ERROR10; |ACABA;  |FINSI;

     enPro1 = 0; enPro2 = 0; enPro3 = 0; enPro4 = 0; enPro5 = 0;
     enPro6 = 0; enPro7 = 0; enPro8 = 0; enPro9 = 0; enPro10 = 0;
     aAlfa = #1#91; |QBF aAlfa; |SI aAlfa ! ""; enPro1 = 1; |FINSI;
     aAlfa = #1#116; |QBF aAlfa; |SI aAlfa ! ""; enPro2 = 1; |FINSI;
     aAlfa = #1#117; |QBF aAlfa; |SI aAlfa ! ""; enPro3 = 1; |FINSI;
     aAlfa = #1#118; |QBF aAlfa; |SI aAlfa ! ""; enPro4 = 1; |FINSI;
     aAlfa = #1#119; |QBF aAlfa; |SI aAlfa ! ""; enPro5 = 1; |FINSI;
     aAlfa = #1#120; |QBF aAlfa; |SI aAlfa ! ""; enPro6 = 1; |FINSI;
     aAlfa = #1#121; |QBF aAlfa; |SI aAlfa ! ""; enPro7 = 1; |FINSI;
     aAlfa = #1#122; |QBF aAlfa; |SI aAlfa ! ""; enPro8 = 1; |FINSI;
     aAlfa = #1#123; |QBF aAlfa; |SI aAlfa ! ""; enPro9 = 1; |FINSI;
     aAlfa = #1#124; |QBF aAlfa; |SI aAlfa ! ""; enPro10 = 1; |FINSI;
|FPRC;

|DEFBUCLE agifa4950;
     #1#3;
     1, 10;
     #0#0, #0#12, " ", #0#9,  #0#2, #0#4, #0#6;
     #0#1, #0#13, "z", #0#10, #0#3, #0#5, #0#6;
     be;
     NULL,conimpr1,conimprl,conimpr2;
|FIN;

|PROCESO conim;|TIPO 3;
     |ABRE #3;
     |SI #0#11 = "P";
          Impresora = "Crystal Reports";
          |IMPRE -1;
     |FINSI;
     |SI #0#11 = "F";
          Impresora = "Fax";
          |IMPRE -1;
     |FINSI;
     |SI FSalida = 0;
          |BUCLE agifa4950;
          |FINIMP;
     |FINSI;
     |CIERRA #3;
|FPRC;

|PROGRAMA;
     |DBASE aAlfa;
     aAlfa = aAlfa + "fich/";
     |PATH_DAT #41 aAlfa;
     |DFICE aAlfa;
     aAlfa = aAlfa % -205;
     |ABRE #41;
     #41#0 = aAlfa;
     |LEE 000#41=;
     |CIERRA #41;

     |HAZ MiraLogos; || Copia Logos para el Crystal

     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |IP_REMOTO aIPRemoto;

     |SI numero ! 0;
          |SI eaTipoImp = "M";
               eaSerie = serie;
               enOferta = numero;
               |SUB_EJECUTA_NP "pcegm025";
          |FINSI;
          #0#9  = serie;
          #0#10 = serie;
          #0#2 = numero;
          #0#3 = numero;
          #0#6 = reimpr;
          #0#11 = eaTipoImp;
          |HAZ conim;
     |SINO;
          |MANTE #0;
     |FINSI;
|FPRO;
*/
