|FICHEROS;
     agifa015 #0;
     agifa081 #2;
     agifa067 #3;
     agifa019 #4;        || Articulos
     agifa017 #5;        || Almacen
     agifa112 #6;        || Clientes
     agifa077 #77;
     agifa080 #80;
     dsm00083 #83;
     agifa142 #142;
     dsm00005 #905;
|FIN;

|VARIABLES;
     &nDeci_BaseMxP = 0;
     &nDeci_DivP = 0;
     &enErr = 0;
     &enImpPrvCom = 0;
     &eaProve = "";
     &aDivisa = "";
     &aMoneda = "";
     &enError = 0;
     &enPrecioB = 0;
     &precio_base = 0;
     &enDeciB = 0;
     &nDeci_PreBase = 0;
     &enForma = 0;
     &eaDocu = "";
     &eaTipo = "";
     &eaSerie = "";
     &enCodigo = 0;
     &enLinea = 0;
     &efFecha = @;
     &eaArticulo = "";
     &enAlmacen = 0;
     &enUnidades = 0;
     &eaAbono = "";
     &eaSeriePedido = "";
     &enCodigPedido = 0;
     &enLineaPedido = 0;
     &eaDespreciar  = "";
     &eaEsNecesario = "";
     &enUnidPend = 0;
     &enUnidPend2 = 0;
     aParam = "";
     nImpo = 0;
     aMes = "";
     nMes = 0;
     nForma = 0;
     aAlfa = "";
     aPedCompleto = "N";
     nUniVarAnt = 0;
     nLinV = 0;
     nPPort1 = 0;
     nPPort2 = 0;
     importe = 0;
     importeD = 0;
     nBrutoMoneda1 = 0;
     nBrutoMoneda2 = 0;
     nBrutoMoneda3 = 0;
     nImporDescue1 = 0;
     nImporDescue2 = 0;
     nImporDescue3 = 0;
     aDespreciar = "";
     nVaria1 = 0;
     nVaria2 = 0;
     nImpDiv = 0;
     nPendiente = 0;
     nPendiente2 = 0;
|FIN;

|PROCESO Tipo8; |TIPO 8;
     |HAZ ControlUsuAC;
     |SI enErr ! 0; |PTEC 807; |ACABA; |FINSI;
|FPRC;

|PROCESO Bagifa080;
     |SI #77#38 = "N";
          |BORRA 020#80a;
     |FINSI;
|FPRC;

|PROCESO Bagifa077;
     |SI #77#38 = "N";
          |BORRA 020#77a;
     |FINSI;
|FPRC;

|DEFBUCLE Bagifa077;
     #77#3;
     ;
     #0#0, #0#4, #0#6, #0#2;
     #0#1, #0#5, #0#7, #0#3;
     be;
     NULL, Bagifa077, Bagifa080;
|FIN;

|PROCESO alcbo;|TIPO 3;
     |SI #0#8 = "SI";
          |BUCLE Bagifa077;
     |FINSI;
|FPRC;
============================================================
|PROCESO VariPedido;
     #3#12 = #3#12 + #905#9;
|FPRC;

|DEFBUCLE VariPedido;
     #905#1;
     ;
     "PC", #80#29, #80#12, nLinV, "      ";
     "PC", #80#29, #80#12, nLinV, "zzzzzz";
     ;
     NULL, VariPedido;
|FIN;

|PROCESO tot_ped_div;
   |SI #2#29 = "B";  || Asigna campos visual. y no visual. en el pedido segun la moneda de trabajo
     #2#37 = #2#11;
     #2#38 = #2#12;
     #2#39 = #2#13;
     #2#40 = #2#34;
     #2#41 = #2#35;
     #2#42 = #2#36;
   |SINO;
     #2#37 = #2#34;
     #2#38 = #2#35;
     #2#39 = #2#36;
     #2#40 = #2#11;
     #2#41 = #2#12;
     #2#42 = #2#13;
   |FINSI;
|FPRC;

|PROCESO ActuaPedido;
     nUniVarAnt = #3#12;
     nLinV = #0#1;
||     |SI #4#176 = "S"; |BUCLE dsm00005P;  |FINSI;

     |SI #2#29 = "D";
          nPPort1 = #3#50 / #2#28 * #2#33;
          nPPort2 = #3#50;
     |SINO;
          nPPort1 = #3#50;
          nPPort2 = #3#50 / #2#33 * #2#28;
     |FINSI;

     importe  = #2#13;                || Imp Servido (C)
     importeD = #2#36;                || Imp Servido (C)
     |SI #4#196 = 2;
         #2#13 = #3#46 * #3#6;
         #2#36 = #3#46 * #3#33;
     |SINO;
         #2#13 = #3#38 * #3#6;
         #2#36 = #3#38 * #3#33;
     |FINSI;

     #2#13 = ((#2#13 < #3#8) < #3#27) < #3#57;
     #2#36 = ((#2#36 < #3#8) < #3#27) < #3#57;

     |SI #4#196 = 2;
          #2#13 = (#2#13 + (#3#46 * nPPort1));
          #2#36 = (#2#36 + (#3#46 * nPPort2));
     |SINO;
          #2#13 = (#2#13 + (#3#38 * nPPort1));
          #2#36 = (#2#36 + (#3#38 * nPPort2));
     |FINSI;
/*
     #2#13 = ((#2#13 < #2#5) < #2#17) < #2#6;
     #2#36 = ((#2#36 < #2#5) < #2#17) < #2#6;
*/
     nBrutoMoneda1 = #2#13;
     nImporDescue1 = (nBrutoMoneda1 % #2#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #2#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #2#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     #2#13 = nBrutoMoneda1;

     nBrutoMoneda2 = #2#36;
     nImporDescue1 = (nBrutoMoneda2 % #2#5) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #2#17) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #2#6) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     #3#36 = nBrutoMoneda2;

     #2#13 = importe - #2#13;
     #2#36 = importeD - #2#36;

     #3#38 = #3#38 + (#80#5 * nForma);
     #3#46 = #3#46 + (#80#36 * nForma);

     |SI aDespreciar = "S";
          nVaria1 = #3#12;
          nVaria2 = #3#44;
          |SI #4#176 = "S";   || Division Vertical
               #3#12 = 0;
               #3#44 = 0;
               nLinV = #80#21;
               |BUCLE VariPedido;
          |SINO;
               #3#12 = #3#38 - #3#37;
               #3#44 = #3#46 - #3#45;
          |FINSI;
          nVaria1 = #3#12 - nVaria1;
          nVaria2 = #3#44 - nVaria2;
          #80#22 = nVaria1;
          #80#24 = nVaria2;
     |SINO;
          |SI #142#225 = "B";
               |SI #3#37 = 0;
                    #3#12 = #3#38 - #3#37;
               |FINSI;
               |SI #3#45 = 0;
                    #3#44 = #3#46 - #3#45;
               |FINSI;
          |FINSI;
     |FINSI;

     enUnidPend =  0;
     enUnidPend2 =  0;
     |SI nForma = -1;  || Restaura Unid. Variacion Pedido
          #3#12 = #3#12 - #80#22;
          #3#44 = #3#44 - #80#24;
          enUnidPend =  #80#22;
          enUnidPend2 =  #80#24;
          #80#22 = 0;
          #80#24 = 0;
     |FINSI;

     #2#11 = #2#11 - #3#9;
     #2#34 = #2#34 - #3#34;

     #3#5  = #3#37 + #3#12;
     #3#41 = #3#45 + #3#44;

     |SI #4#196 = 2;
          #3#7    = #3#41 * #3#6;
          nImpDiv = #3#41 * #3#33;
     |SINO;
          #3#7    = #3#5 * #3#6;
          nImpDiv = #3#5 * #3#33;
     |FINSI;
     #2#44 = #2#44 - #3#56; ||P.Verde
     #3#56 = #3#5 * #4#208;
     #2#44 = #2#44 + #3#56;

     #3#9  = ((#3#7 < #3#8) < #3#27) < #3#57;
     #3#34 = ((nImpDiv < #3#8) < #3#27) < #3#57;
     |SI #4#196 = 2;
         #3#9  = (#3#9  + (#3#41 * nPPort1));
         #3#34 = (#3#34 + (#3#41 * nPPort2));
     |SINO;
         #3#9  = (#3#9  + (#3#5  * nPPort1));
         #3#34 = (#3#34 + (#3#5  * nPPort2));
     |FINSI;
/*
     #3#9  = ((#3#9  < #2#5) < #2#17) < #2#6;
     #3#34 = ((#3#34 < #2#5) < #2#17) < #2#6;
*/
     nBrutoMoneda1 = #3#9;
     nImporDescue1 = (nBrutoMoneda1 % #2#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #2#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #2#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     #3#9 = nBrutoMoneda1;

     nBrutoMoneda2 = #3#34;
     nImporDescue1 = (nBrutoMoneda2 % #2#5) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #2#17) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #2#6) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     #3#34 = nBrutoMoneda2;

     #2#11 = #2#11 + #3#9;
     #2#34 = #2#34 + #3#34;

     |SI #2#29 = "D";
         #3#36 = #3#9;
     |SINO;
         #3#36 = #3#34;
     |FINSI;

     |SI #4#196 = 2;
          importe  = #3#46 * #3#6;
          importe  = ((importe < #3#8) < #3#27) < #3#57;
          importe  = importe + (#3#46 * nPPort1);

          importeD = #3#46 * #3#33;
          importeD = ((importeD < #3#8) < #3#27) < #3#57 ;
          importeD = importeD + (#3#46 * nPPort2);
     |SINO;
          importe  = #3#38 * #3#6;
          importe  = ((importe < #3#8) < #3#27) < #3#57;
          importe  = importe + (#3#38 * nPPort1);

          importeD = #3#38 * #3#33;
          importeD = ((importeD < #3#8) < #3#27) < #3#57;
          importeD = importeD + (#3#38 * nPPort2);
     |FINSI;
/*
     importe  = ((importe  < #2#5) < #2#17) < #2#6;
     importeD = ((importeD < #2#5) < #2#17) < #2#6;
*/
     nBrutoMoneda1 = importe;
     nImporDescue1 = (nBrutoMoneda1 % #2#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #2#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #2#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     importe = nBrutoMoneda1;

     nBrutoMoneda2 = importeD;
     nImporDescue1 = (nBrutoMoneda2 % #2#5) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #2#17) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #2#6) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     importeD = nBrutoMoneda2;

     #3#11 = #3#9  - importe;

     #2#13 = #2#13 + importe;         || Imp Servido (C)
     #2#12 = #2#11 - #2#13;           || Imp Pdte serv (C)

     #2#36 = #2#36 + importeD;        || Imp Servido (C)
     #2#35 = #2#34 - #2#36;           || Imp Pdte serv (C)

     #2#24 = #2#24 + (#80#5 * nForma);           || Ctrl Servido (C)
     ||컴컴컴컴컴컴 Doble/Multi
     |SI aDespreciar = "S";
         enUnidPend = #80#5 + (nPendiente - #80#5);
         enUnidPend2 = #80#36 + (nPendiente2 - #80#36);
     |SINO;
          enUnidPend = #80#5 - enUnidPend;
          enUnidPend2 = #80#36 - enUnidPend2;
          |SI #3#37 = 0; enUnidPend = 0; |FINSI;
          |SI #3#45 = 0; enUnidPend2 = 0; |FINSI;
     |FINSI;

     enForma = nForma;
     eaDocu = "agifa213";
     |HAZ StockEntra;

     aDespreciar = "N";
|FPRC;

|PROCESO AlPedido;
     |ABRE #4;
     |ABRE #2;
     |ABRE #3;
     #2#25 = #80#29;
     #2#0 = #80#12;
     |LEE 101#2=;                    ||Leo el pedido Original
     |SI FSalida = 0;
          #3#28 = #2#25;
          #3#0 = #2#0;
          #3#1 = #80#21;
          |LEE 101#3=;               ||Leo la linea de pedido
          |SI FSalida = 0;
               |HAZ ActuaPedido;
               |HAZ tot_ped_div;

               enForma = nForma;
               |GRABA 021#3a;
               |LIBERA #3;
          |FINSI;
          |GRABA 021#2a;
     |FINSI;
     |CIERRA #2;
     |CIERRA #4;
     |CIERRA #3;
|FPRC;

|PROCESO lee_arti;
     #4#0 = #80#2;
     |LEE 101#4=;
     |SI FSalida ! 0;
          |DDEFECTO #4;
          #4#0 = #80#2;
          #4#1 = #80#4;
          |GRABA 021#4b;
     |FINSI;
     |LIBERA #4;

     #5#0 = #80#2;
     #5#1 = #80#3;
     |LEE 101#5=;
     |SI FSalida ! 0;
          |DDEFECTO #5;
          #5#0 = #80#2;
          #5#1 = #80#3;
          #5#40 = #80#4;
          |GRABA 021#5b;
     |FINSI;
     |LIBERA #5;
|FPRC;

|PROCESO lee_clien;
     #6#0 = #80#15;
     |LEE 101#6=;
     |SI FSalida ! 0;
          |DDEFECTO #6;
          #6#0 = #80#15;
          |GRABA 021#6b;
     |FINSI;
|FPRC;

|PROCESO ActuaResto;
     #77#41 = #77#41 + nForma;
     |ABRE #4;
     |ABRE #5;
     |ABRE #6;
     |HAZ lee_arti;
     |HAZ lee_clien;

     |SI #80#12 ! 0;  |O #80#29 ! "     ";
          |HAZ AlPedido;
          aAlfa = #77#71; |QBF aAlfa;
          |SI aAlfa = "";
               #77#71 = #2#43; |PINTA #77#71;
          |FINSI;
     |FINSI;

     importe = #80#9 < #77#5;
     importe = importe < #77#7;
     importe = importe < #77#32;
     importe = importe;
     #80#23 = #3#5;
     |CIERRA #6;
     |CIERRA #4;
     |CIERRA #5;
|FPRC;

|PROCESO BorraDesAmpli;
     |BORRA 020#83a;
|FPRC;

|DEFBUCLE BorraDesAmpli;
     #83#1;
     ;
     "A", #80#29, #80#12, #80#21, 001;
     "A", #80#29, #80#12, #80#21, 999;
     be;
     NULL, BorraDesAmpli;
|FIN;

|PROCESO BorraLin;
     nForma = -1;
     enPrecioB  = precio_base;
     enDeciB = nDeci_PreBase;
     enForma = nForma;
     eaDocu = "agifa077";
     |HAZ StockEntra;

     nImpo = (#80#9 < #77#5) < #77#32;
     |SI #142#114 = "S";
          nImpo = nImpo < #77#7;
     |FINSI;
     #6#0 = #77#3;
     |LEE 101#6=;
     |SI FSalida = 0;
         aMes = #77#1 % A402;
         nMes = aMes + 26;
         |SI #77#42 = "N";
             #6nMes = #6nMes + (nImpo * nForma);
             #6#39 = #6#39 + (nImpo * nForma);
         |SINO;
             #6nMes = #6nMes - (nImpo * nForma);
             #6#39 = #6#39 - (nImpo * nForma);
         |FINSI;
         |GRABA 020#6a;
         |LIBERA #6;
     |FINSI;

     |SI #77#42 = "N";
          enImpPrvCom = nImpo * nForma;
     |SINO;
          enImpPrvCom = -nImpo * nForma;
     |FINSI;
     efFecha = #77#1;
     eaProve = #77#3;
     |HAZ AcumulaPrv;
     ||-----------------------------------
     aPedCompleto = "N";
     eaDocu = "agifa212";
     |HAZ ActuaResto;
     |SI #80#12 = 0; |Y #80#21 = 0;
          enUnidPend = 0; enUnidPend2 = 0;
          enForma = nForma;
          eaDocu = "agifa213";
          |HAZ StockEntra;
     |FINSI;
     |BUCLE BorraDesAmpli;

     eaTipo        = "AC";
     eaSerie       = #80#27;
     enCodigo      = #80#0;
     enLinea       = #80#1;
     efFecha       = #77#1;
     eaArticulo    = #80#2;
     enAlmacen     = #80#3;
     enUnidades    = #80#5;
     eaAbono       = #77#42;
     eaSeriePedido = #80#29;
     enCodigPedido = #80#12;
     enLineaPedido = #80#21;
     eaDespreciar  = "N";
     eaEsNecesario = "S";
     |SUB_EJECUTA_NP "dsz00002;BAJA";
     |HAZ BorraKit;

     ||-----------------------------------
     |BORRA 020#80a;
|FPRC;


|| si se llama con parametro serie+documento borra el albaran
|| siempre que no este facturado siendo enError = 1 si no lo borra
|PROGRAMA;
     aParam = PARAMETRO;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     |SI aParam = "";
          |MANTE #0;
     |SINO;
          enError = 0;
          |ABRE #77;
          |ABRE #6;
          aAlfa = aParam % 105; #77#50 = aAlfa;
          aAlfa = aParam % 6; #77#0 = aAlfa;
          |LEE 121#77=;
          |SI FSalida = 0;
               |SI #77#38 = "S";
                    enError = 1;
                    |MENAV "0000Albaran facturado...";
               |SINO;
                    aDivisa = #77#56;
                    aMoneda = #77#58;
                    |HAZ Divisas077;

                    |BUCLELIN 0 BorraLin #77;
                    |BORRA 020#77a;
               |FINSI;
          |FINSI;
          |CIERRA #6;
          |CIERRA #77;
     |FINSI;
|FPRO;
