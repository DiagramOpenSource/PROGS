|FICHEROS;
     psion028 #28; ||Este
     psion026 #26;  || Historico
     psion025 #0;   || Parametros
     psion004 #1;   || Cabecera.
     psion005 #2;   || Lineas.
     psion013 #6;   || Cobros Facturas.
     psion015 #7;   || Movimientos de Almacen.
     psion019 #8;   || Cobros Albaranes.
     agifa321 #14;  || Divisas-Parametros.
     agifa324 #15;  || Divisas-Divisas.
     psion021 #21; || Cli
     psion022 #22; || Dir Ent
|FIN;

|VARIABLES;
     aCar = "";
     aExe = "";
     ||nPos = 0;
     ||aLon = "";
     aFicDes = "";
     aFicOrg = "";
     aVer1 = "";
     aVer2 = "";
     aIP = "";
     aBase = "";
     {1}aLocal = "";
     {1}aConte = "";
     aOrigen = "";
     aDestino = "";

     &enMensa = 0;
     aAlf1 = "";
     aAlf2 = "";
     aAlf3 = "";
     nConta = 0;
     i = 0;
     guarda = 0;
     nCampo = 0;
 {90}Valor = "";
     aReg = "";
     aLon = "";
     aDato = "";
     nPos = 0;
     aLetra = "";
     aTab = "";

     aFic = "";
     nHandle = 0;
     aDir = "";
     aDSCorreo = "";
     aUsu = "";
     aPwd = "";
     aProxyEnt = "";
     aNombre = "";
     aAlfa = "";
     aMensaje = "";
     aPath = "";
     nCorreos = 0;
     nError = 0;
     nNume = 0;
     aSer = "";
     nLin = 0;
     aClase = "";
|FIN;

|PROCESO CopiaPuesto;
     aIP = "";
     |IP_REMOTO aIP;
     |ESPECIFICA "RBASS", aLocal;
     |DBASS aBase;

     aOrigen = aPath + aNombre + ".txt";
     aDestino = aLocal + "spool/" + aNombre + ".txt";
     |SI aIP ! "";
          |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     aFicOrg = aDestino;
     aFicDes = aLocal + "spool/" + aNombre + ".xxx";
|FPRC;

|PROCESO TraePuesto;
     aIP = "";
     |IP_REMOTO aIP;
     |ESPECIFICA "RBASS", aLocal;
     |DBASS aBase;

     aOrigen = aLocal + "spool/" + aNombre + ".xxx";
     aDestino = aBase + "spool/" + aNombre + ".txt";
     |SI aIP ! "";
          |RECIBE_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
     aNombre = aDestino;
     |RFBORRA aOrigen;
|FPRC;

|PROCESO Utf82Ansi;
     aIP = "";
     |IP_REMOTO aIP;
     |DBASE aBase;
     |ESPECIFICA "RBASS", aLocal;

     aOrigen = aBase + "00psion/wait.exe"
     aDestino = aLocal + "/bin/wait.exe";
     aConte = aOrigen;
     |ESPECIFICA "MD5", aConte;
     aVer1 = FSalida;
     aConte = aDestino;
     |ESPECIFICA "REMOTOMD5", aConte;
     aVer2 = FSalida;
     |SI aVer1 ! aVer2;
          |SI aIP ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
     |FINSI;

     aOrigen = aBase + "00psion/ansitoutf8.exe"
     aDestino = aLocal + "/bin/ansitoutf8.exe";
     aConte = aOrigen;
     |ESPECIFICA "MD5", aConte;
     aVer1 = FSalida;
     aConte = aDestino;
     |ESPECIFICA "REMOTOMD5", aConte;
     aVer2 = FSalida;
     |SI aVer1 ! aVer2;
          |SI aIP ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
     |FINSI;

     aAlfa = "wait " + aDestino + " 5 " + aFicOrg + " " + aFicDes;
     aLon = aAlfa % A0;
     aExe = "";
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aCar = aAlfa % nPos;
          |SI aCar = "/"; aCar = "\"; |FINSI;
          aExe = aExe + aCar;
     |SIGUE;

     |RSYSTEM aExe;
     |RFBORRA aFicOrg;
|FPRC;

|PROCESO LeeDivisa;
     |ABRE #14;
     |ABRE #15;
     |LEE 001#14p;
     #15#0 = #14#9;
     |LEE 001#15=;
     |CIERRA #14;
     |CIERRA #15;
|FPRC;

|PROCESO Movimi;
     nConta = nConta + 1;
     |DDEFECTO #7;
     #7#0 = Valor2;
     #7#1 = Valor3;
     #7#2 = Valor4;
     #7#3 = Valor5;
     #7#4 = Valor6;
     #7#5 = ~;
     #7#6 = nConta;
     #7#7 = Valor7;
     #7#8 = Valor8;
     #7#9 = Valor9;
     |GRABA 121#7n;
|FPRC;

|PROCESO Cobros1;
     |DDEFECTO #8;
     #8#0 = Valor2;
     #8#1 = Valor3;
     #8#2 = Valor4;
     |LEE 101#8=;
     |SI FSalida ! 0; |GRABA 020#8b; |FINSI;
     #8#3 = Valor5;
     #8#4 = Valor6;
     #8#5 = Valor7;
     #8#6 = Valor8;
     #8#7 = Valor9;
     #8#8 = Valor10;

     #8#4 = #8#4 ! #15#7;
     #8#5 = #8#5 ! #15#7;
     #8#6 = "S";
     |GRABA 020#8a;
     |LIBERA #8;
|FPRC;

|PROCESO Cobros;
     |DDEFECTO #6;
     #6#0 = Valor2;
     #6#1 = Valor3;
     #6#2 = Valor4;
     |LEE 101#6=;
     |SI FSalida ! 0; |GRABA 020#6b; |FINSI;
     #6#3 = Valor5;
     #6#4 = Valor6;
     #6#5 = Valor7;
     #6#6 = Valor8;
     #6#7 = Valor10;
     #6#8 = Valor11;
     #6#9 = Valor12;

     #6#4 = #6#4 ! #15#7;
     #6#5 = #6#5 ! #15#7;

     #6#6 = "S";
     |GRABA 020#6a;
     |LIBERA #6;
|FPRC;

|PROCESO LinAlb;
     |DDEFECTO #2;
     #2#0 = Valor2;
     #2#1 = Valor3;
     #2#2 = Valor4;
     #2#3 = Valor5;

     |LEE 101#2=;
     |SI FSalida ! 0; |GRABA 020#2b; |FINSI;
     #2#4 = Valor6;
     #2#6 = Valor7;
     #2#7 = Valor8;
     #2#8 = Valor9;
     #2#9 = Valor10;
     #2#5 = Valor11;
     #2#12 = Valor12;
     #2#15 = Valor13;
     #2#16 = Valor14;
     #2#17 = Valor15;
     |SI #2#11 = 0; #2#11 = 1; |FINSI; || Almacen
     |HAZ grabalineas;
     |GRABA 020#2a;
     |LIBERA #2;

     #1#0 = #2#0;
     #1#0 = #2#0;
     |LEE 101#1=;
     |SI FSalida = 0;
          |HAZ grabacabeza;
          |GRABA 020#1a;
          |LIBERA #1;
     |FINSI;
|FPRC;

|PROCESO CabAlb;
     |DDEFECTO #1;
     #1#0 = Valor2;
     #1#1 = Valor3;
     #1#2 = Valor4;
     |LEE 101#1=;
     |SI FSalida ! 0; |GRABA 020#1b; |FINSI;
     #1#3 = Valor5;
     #1#4 = Valor6;
     #1#6 = Valor7;
     #1#7 = Valor8;
     #1#39 = Valor9;          || Para el modulo 002448
     #1#11 = Valor12;
     #1#12 = Valor13;
     #1#13 = Valor14;
     #1#32 = Valor15;
     #1#33 = Valor16;
     #1#34 = Valor17;
     #1#35 = Valor18;
     #1#37 = Valor11;
     #1#10 = Valor20;
     |SI #1#32 = 0; #1#32 = 1; |FINSI;  || Dir. Entrega
     #1#7 = #1#7 ! #15#7;
     |HAZ grabacabeza;
     |GRABA 020#1a;
     |LIBERA #1;
|FPRC;

|PROCESO DirNue;
     |DDEFECTO #22;
     #22#9 = Valor11;
     #22#10 = Valor12;
     #22#0 = ("000000" + Valor2) % -106;
     #22#1 = Valor3;
     |LEE 101#22=;
     |SI FSalida ! 0; |GRABA 020#22b; |FINSI;
     IValor = Valor3<-;
     |PARA i = 1; |SI i [ 8; |HACIENDO i = i + 1;
          #22i = Valor;
          IValor = IValor + 1;
     |SIGUE;
     |GRABA 020#22a;
|FPRC;

|PROCESO CliNue;
     |DDEFECTO #21;
     #21#18 = Valor20;
     #21#19 = Valor21;
     #21#0 = ("000000" + Valor2) % -106;
     |LEE 101#21=;
     |SI FSalida ! 0; |GRABA 020#21b; |FINSI;
     IValor = Valor3<-;
     |PARA i = 1; |SI i [ 19; |HACIENDO i = i + 1;
          #21i = Valor;
          IValor = IValor + 1;
     |SIGUE;
     #21#21 = Valor22;
     #21#22 = Valor23;
     #21#23 = Valor24;
     #21#24 = Valor25;
     #21#25 = Valor26;
     #21#26 = Valor27;
     #21#27 = Valor28;
     |GRABA 020#21a;
|FPRC;

|PROCESO General;
|FPRC;

|PROCESO Dato;
     IValor = Valor1<-;
     |PARA i = 1; |SI i [ 90; |HACIENDO i = i + 1;
          Valor = "";
          IValor = IValor + 1;
     |SIGUE;
     nCampo = 1;
     IValor = Valor1<-;
     aLon = aDato % A0;
     aReg = "";
     aTab = &9;
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aLetra = aDato % nPos;
          |SI aLetra = aTab;
               Valor = aReg;
               aReg = "";
               nCampo = nCampo + 1;
               IValor = IValor + 1;
          |SINO;
               aReg = aReg + aLetra;
          |FINSI;
          |SI nCampo > 90; |SAL; |FINSI;     || Por si.... :)
     |SIGUE;
     Valor = aReg;
|FPRC;

|PROCESO ProcesaCorreo;
     nError = 0;
     |ABRE #1;
     |ABRE #2;
     |ABRE #6;
     |ABRE #7;
     |ABRE #8;
     |ABRE #21;
     |ABRE #22;
     |HAZ CopiaPuesto;
     |HAZ Utf82Ansi;
     |HAZ TraePuesto;
     aFic = aNombre;
     |XABRE "U", aFic, nHandle;
     |SI FSalida ! 0;
          nError = 1;
          aMensaje = "0000No puedo abrir adjunto: " + aFic;
          |SI enMensa = 1;
               |MENSA aMensaje;
          |SINO;
               |MENAV aMensaje;
          |FINSI;
     |SINO;
          |XLEE nHandle, 250, aDato;
          |PARA; |SI FSalida ] 0; |HACIENDO;
               |HAZ Dato;
               |SI Valor1 = "G";  |HAZ General; |FINSI;
               |SI Valor1 = "C0"; |HAZ CliNue;  |FINSI;
               |SI Valor1 = "C1"; |HAZ DirNue;  |FINSI;
               |SI Valor1 = "C2"; |HAZ CabAlb;  |FINSI;
               |SI Valor1 = "L";  |HAZ LinAlb;  |FINSI;
               |SI Valor1 = "CF"; |HAZ Cobros;  |FINSI;
               |SI Valor1 = "CA"; |HAZ Cobros1; |FINSI;
               |SI Valor1 = "MA"; |HAZ Movimi;  |FINSI;
               |SI Valor1 = "F"; |SAL; |FINSI;
               |XLEE nHandle, 250, aDato;
          |SIGUE;
          |XCIERRA nHandle;
     |FINSI;
     |CIERRA #22;
     |CIERRA #21;
     |CIERRA #8;
     |CIERRA #7;
     |CIERRA #6;
     |CIERRA #2;
     |CIERRA #1;
     |FBORRA aFic;
|FPRC;

|PROCESO psion026;
     |SI #26#3 = "N";
          aPath = #0#14; |QBF aPath;
          aAlf1 = #26#0; |QBF aAlf1;
          aAlf2 = #26#1;
          aAlf3 = #26#2;
          aAlf2 = (aAlf2 % 102) + (aAlf2 % 402) + (aAlf2 % 704)
          aAlf3 = (aAlf3 % 102) + (aAlf3 % 402) + (aAlf3 % 702)
          aNombre = aAlf1 + aAlf2 + aAlf3;
          aAlfa = "Procesando : " + aNombre;
          |PINTA 2203, aAlfa;

          |HAZ ProcesaCorreo;
          |SI nError = 0;
               #26#3 = "S";
               |GRABA 020#26a;
          |FINSI;
     |FINSI;
     |LIBERA #26;
|FPRC;

|DEFBUCLE psion026;
     #26#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, psion026;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #0; |LEE 000#0p; |CIERRA #0;

     |SI #28#0 = "SI";
          |BUCLE psion026;
     |FINSI;
|FPRC;
