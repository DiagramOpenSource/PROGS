|FICHEROS;
     fergay05;
     fergam02;
     fergam06;
     fergam07;
     fergam08;

     agifa019;
     agifa024;
     agifa060;
     agifa073;
     agifa104;
     agifa210;
     agifa211;

     fergaw12;
|FIN;

|VARIABLES;
     &eaAlfa = "";
     nHayAlb = "";
     aFecElabora = "";
     aFecArmado = "";
     aFecPilote = "";
     aCompo = "";
     nHay = 0;

     aAlfa = "";
     aAlfa1 = "";
     aHojaExcel = "";
     aBase = "";
     aOrigen = "";
     aDestino = "";
     aDestinoTrab = "";
     aIPRemoto = "";
     aPath = "";
     {1}aVersion = "";
     aLongitud = "";
     nLongitud = 0;
     aPos = "";
     nPos = 0;
     nCaracter = 0;
     aCaracter = "";
     aResultado = "";
     aHoja = "";
     nLinea = 0;
     aLF = "";
     aIP = "";
     {1}aLocal = "";
     aExe = "dsabreextension.exe";
     aOrg = "";
     aDes = "";
     aFic = "";
     nHandle = 0;
|FIN;

|PROCESO PresentaDoc;
     |DBASE aAlfa;
     aOrg = aAlfa + "plugins/" + aExe;

     aIP = ""; |IP_REMOTO aIP;
     |SI aIP = "";
          |DBASS aBase;
          aAlfa = aBase + "bin/" + aExe + " " + aFic;
          |SYSTEM aAlfa;
     |SINO;
          |ESPECIFICA "RBASS", aLocal;
          aBase = aLocal;
          aDes = aBase + "bin/" + aExe;
          |ENVIA_FICHERO aOrg, aDes;
          aAlfa = aDes;

          aOrg = aFic;
          aDes = aBase + "tmp/" + Usuario + ".csv";
          |ENVIA_FICHERO aOrg, aDes;
          aAlfa = aAlfa + " " + aDes;

          |RSYSTEM aAlfa;
     |FINSI;
|FPRC;

|PROCESO fergaw12;
     aAlfa =       #fergaw12#1;  |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#2;  |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#3;  |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#4;  |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#5;  |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#6;  |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#7;  |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#8;  |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#9;  |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#10; |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#11; |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#12; |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#13; |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#14; |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#15; |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#16; |XGRABA nHandle, aAlfa;
     aAlfa = ";" + #fergaw12#17; |XGRABA nHandle, aAlfa;

     |XGRABA nHandle, aLF;
|FPRC;

|DEFBUCLE fergaw12;
     #fergaw12#2;
     ;
     INICIO;
     FINAL;
     ;
     NULL, fergaw12;
|FIN;

|PROCESO Lineas;
     nLinea = nLinea + 1;

     |DDEFECTO #fergaw12;

     #fergaw12#0 = nLinea;

     |SI nHayAlb = 0;
         #fergaw12#1 = #agifa210#1;
     |FINSI;

     |SI nHayAlb = 0;
          #agifa024#0 = #agifa210#3;
          |LEE 000#agifa024.=;
          |SI FSalida ! 0; |DDEFECTO #agifa024; |FINSI;

          #fergaw12#2 = &34+#agifa210#3+&34;
          #fergaw12#3 = #agifa024#1;
          #fergaw12#4 = #agifa210#4;
     |SINO;
          #agifa024#0 = #agifa104#4;
          |LEE 000#agifa024.=;
          |SI FSalida ! 0; |DDEFECTO #agifa024; |FINSI;

          #fergaw12#2 = &34+#agifa104#4+&34;
          #fergaw12#3 = #agifa024#1;
          #fergaw12#4 = #agifa104#8;
     |FINSI;

     #fergaw12#5 = #agifa104#0;

     eaAlfa = #agifa019#1; |HAZ QuitaRarosExp;
     #fergaw12#6 = eaAlfa;

     #fergaw12#7 = #agifa060#1;

     #fergaw12#8 = #agifa073#5;

     |SI nHayAlb = 0;
         #fergaw12#9 = #agifa210#1;
     |FINSI;

     aAlfa1 = "";
     |SI nHayAlb = 0;
          aAlfa1 = #agifa210#52; |QBF aAlfa1;
          aAlfa1 = aAlfa1 + "/" + (("000000" + #agifa210#0) % -106);
     |FINSI;
     #fergaw12#10 = aAlfa1;

     #fergaw12#11 = aFecElabora;
     #fergaw12#12 = aFecArmado;
     #fergaw12#13 = aFecPilote;
     #fergaw12#14 = #agifa104#1;
     #fergaw12#15 = #agifa104#51;
     #fergaw12#16 = #agifa104#53;
     #fergaw12#17 = #agifa104#54;

     |GRABA 000#fergaw12.n;
|FPRC;

|PROCESO fergam08;
     |SI aCompo ! "";
          |SI aFecElabora > #fergam08#3; |O aFecElabora = "";
               aFecElabora = #fergam08#3;
          |FINSI;
     |SINO;
          #fergam02#0 = #fergam08#4;
          |LEE 000#fergam02.=;
          |SI FSalida ! 0; |DDEFECTO #fergam02; |FINSI;

          |SI #fergam02#2 = "S";
               |SI aFecArmado > #fergam08#3; |O aFecArmado = "";
                    aFecArmado = #fergam08#3;
               |FINSI;
          |FINSI;

          |SI #fergam02#5 = "S";
               |SI aFecPilote > #fergam08#3; |O aFecPilote = "";
                    aFecPilote = #fergam08#3;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE fergam08;
     #fergam08#1;
     ;
     #fergam07#0, #fergam07#1, 001;
     #fergam07#0, #fergam07#1, 999;
     ;
     NULL, fergam08;
|FIN;

|PROCESO fergam07;
     aCompo = #fergam07#2; |QBF aCompo;
     |BUCLE fergam08;
|FPRC;

|DEFBUCLE fergam07;
     #fergam07#1;
     ;
     #fergam06#0, 001;
     #fergam06#0, 999;
     ;
     NULL, fergam07;
|FIN;

|PROCESO fergam06;
     nHay = 1;
     |BUCLE fergam07;
|FPRC;

|DEFBUCLE fergam06;
     #fergam06#3;
     ;
     #agifa104#25, #agifa104#0, 000001;
     #agifa104#25, #agifa104#0, 999999;
     ;
     NULL, fergam06;
|FIN;

|PROCESO agifa073;
     aFecElabora = "";
     aFecElabora = "";
     aFecArmado = "";
     aFecPilote = "";

     nHay = 0;
     |BUCLE fergam06;

     |SI nHay ! 0;
          #agifa060#0 = #agifa073#18;
          |LEE 000#agifa060.=;
          |SI FSalida ! 0; |DDEFECTO #agifa060; |FINSI;

          #agifa019#0 = #agifa073#2;
          |LEE 000#agifa019.=;
          |SI FSalida ! 0; |DDEFECTO #agifa019; |FINSI;

          nHayAlb = 1;
          #agifa211#31 = #agifa073#28;
          #agifa211#12 = #agifa073#0;
          #agifa211#21 = #agifa073#1;
          |LEE 000#agifa211.=;
          |SI FSalida = 0;
               #agifa210#52 = #agifa211#29;
               #agifa210#0 = #agifa211#0;
               |LEE 000#agifa210.=;
               nHayAlb = FSalida;
               |SI FSalida ! 0; |DDEFECTO #agifa210; |FINSI;
          |SINO;
               |DDEFECTO #agifa210;
          |FINSI;

          |HAZ Lineas;
     |FINSI;
|FPRC;

|DEFBUCLE agifa104;
     #agifa104#7;
     ;
     #fergay05#0, #fergay05#2, 0001, #fergay05#4, 000001;
     #fergay05#1, #fergay05#3, 9999, #fergay05#5, 999999;
     ;
     NULL, NULL, NULL, NULL, NULL, NULL, agifa073;
     #agifa104#8;
|FIN;

|PROCESO Titulos;
     aAlfa = "Fecha Albarán;Cliente;Nombre Fiscal;Nombre Comercial;Nº Pedido;Descripción Artículo;Descripción Familia;";
     |XGRABA nHandle, aAlfa;
     aAlfa = "Unidades;Fecha Albarán;Nº Albarán;Fecha Elaborado;Fecha Armado;Fecha Pilotes;Fecha Pedido;Usuario Pedido;";
     |XGRABA nHandle, aAlfa;
     aAlfa = "Observación1;Observación2";
     |XGRABA nHandle, aAlfa;
     |XGRABA nHandle, aLF;
|FPRC;

|PROCESO T3; |TIPO 3;
     nLinea = 0;

     |ABRE #agifa210;
     |ABRE #agifa211; |SELECT #4#agifa211;
     |ABRE #agifa060;
     |ABRE #agifa019;
     |ABRE #fergam02;
     |ABRE #agifa024;

     |BUCLE agifa104;

     |CIERRA #agifa024;
     |CIERRA #fergam02;
     |CIERRA #agifa019;
     |CIERRA #agifa060;
     |CIERRA #agifa211;
     |CIERRA #agifa210;

     |LEE 000#fergaw12.p;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     aLF = &13; aLF = aLF + &10;
     |DFICE aAlfa;
     aFic = aAlfa + Usuario + ".csv";
     |XABRE "WB", aFic, nHandle;
     |SI FSalida ] 0;
          |HAZ Titulos;

          |BUCLE fergaw12;

          |XCIERRA nHandle;

          |HAZ PresentaDoc;
     |FINSI;
|FPRC;

|PROCESO T80;  |TIPO 80;
     aFic = "fergaw12" + Usuario;
     |NOME_DAT #fergaw12#aFic#;
     |ABRE #fergaw12;  |CIERRA #fergaw12;  |DELINDEX #fergaw12;

     |ABRET #fergaw12;

     FSalida = 3199;
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #fergaw12;
     |DELINDEX #fergaw12;
|FPRC;
