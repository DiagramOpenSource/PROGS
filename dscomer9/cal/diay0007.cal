|FICHEROS;
     diay0007 #0;
     diam0032 #32;
     diam0019 #1;
     diam0016 #2;
     diaw0022 #922;
|FIN;

|VARIABLES;
     &nRelleno = 0;
     &nSuma = 0;
     &aOfePed = ""
     &aTipoInf = "";
     &fFechaFin = @;
     &aPeriodo = "";
     &fFechaDesde = @;
     &nSwSeccion = 0;
     &fperiodo = @;
     aAlfa = "";
     &nAnyo = 0;
     &fFechaCrys = @;
     &aPeriodoCrys = "";
     &fFechaDesdeCrys = @;
     nResta = 0;
     nFechaTmp = 0;
     &eaSerie  = "";
     &eaPedido = "";
|FIN;

|PROCESO diam0032;
     nRelleno = 1;
     aOfePed = aTipoInf;
     nSuma = 0;
     nSwSeccion = 1;
     #1#18 = #32#1;
     nSuma = 1;
     #1#120 = #32#2;
     |PRINT;
     nSuma = 2;
     nSwSeccion = 2;
     |PRINT;
     nSwSeccion = 3;
     |PRINT;
     nSwSeccion = 4;
     |PRINT;
|FPRC;

|PROCESO diam0019;
     nRelleno   = 0;
     nSuma      = 0;
     nSwSeccion = 0;
     eaSerie    = "";
     eaPedido   = "";

     aAlfa = #1#119;     |QBF aAlfa;

     |SI aAlfa = "EN PEDIDOS";
          |SI #1#122 > fFechaFin;  |ACABA; |FINSI;
          |SI #1#122 < fFechaDesde; |ACABA; |FINSI;
          |SI #1#122 ] fperiodo; |Y #1#122 [ fFechaFin;
               nSwSeccion = 1;
          |FINSI;
          |SI #1#122 [ fperiodo; |Y #1#122 ] fFechaDesde;
               nSwSeccion = 2;
          |FINSI;

          #2#0  = #1#0;
          #2#1  = #1#122;
          #2#13 = #1#13;
          |LEE 000#2=;
          |SI FSalida = 0;
              eaSerie  = #2#14;
              eaPedido = ("000000" + #2#15) % -106;
          |FINSI;
     |FINSI;

     |SI aAlfa = "PENDIENTE";
          |SI #1#1 > fFechaFin;  |ACABA; |FINSI;
          |SI #1#1 < fFechaDesde; |ACABA; |FINSI;
          |SI #1#1 ] fperiodo; |Y #1#1 [ fFechaFin;
               nSwSeccion = 3;
          |FINSI;
          |SI #1#1 [ fperiodo; |Y #1#1 ] fFechaDesde;
               nSwSeccion = 4;
          |FINSI;
     |FINSI;

     |SI nSwSeccion = 0;
          |ACABA;
     |SINO;
          |SI nSwSeccion < 3;
               aAlfa = #1#122;     |QBF aAlfa;
               aOfePed = "P";
          |SINO;
               aAlfa = #1#1;     |QBF aAlfa;
               aOfePed = "O";
          |FINSI;
          aAlfa = aAlfa % -104;
          nAnyo = aAlfa;
          #32#0 = nAnyo;
          #32#1 = #1#18;
          |LEE 000#32=;
          |SI FSalida ! 0; |ACABA; |FINSI;
          #922#0 = #1#18;
          |LEE 000#922=;
          |SI FSalida ! 0;
               #922#0 = #1#18;
               |GRABA 020#922n;
               ||nSuma = 1;
          |FINSI;
          |SI #32#4 = "N";    |ACABA;   |FINSI;
          |PRINT;
     |FINSI;
|FPRC;

|DEFBUCLE diam0032;
     #32#1;
     ;
     nAnyo, "";
     nAnyo, "zz";
     ;
     NULL, diam0032;
|FIN;

|DEFBUCLE diam0019;
     #1#1;
     #1#18;
     INICIO;
     FINAL;
     ;
     NULL, diam0019;
|FIN;

|PROGRAMA;
     |CLS;
     fFechaFin = fFechaCrys;
     aPeriodo = aPeriodoCrys;
     fFechaDesde = fFechaDesdeCrys;
     Impresora = "CrystalReports";
     |IMPRE -1;
     |SI FSalida = 0;
          |INFOR "diay0007";
          |SI FSalida ! 0; |ACABA; |FINSI;
          |SI aPeriodo = "M";
               nResta = 30;
          |FINSI;
          |SI aPeriodo = "Q";
               nResta = 15;
          |FINSI;
          |SI aPeriodo = "S";
               nResta = 7;
          |FINSI;
          nFechaTmp = fFechaFin;
          nFechaTmp = nFechaTmp - nResta;
          fperiodo = nFechaTmp;
          |ABRE #32;
          |ABRE #922;
          |CIERRA #922;
          |DELINDEX #922;
          |ABRE #922;
          |ABRE #1;
          aAlfa = fFechaDesde;
          aAlfa = aAlfa % -104;
          nAnyo = aAlfa;
          |BUCLE diam0032;
          |CIERRA #1;
          |ABRE #2;
          |BUCLE diam0019;
          |CIERRA #2;
          |CIERRA #922;
          |CIERRA #32;
          |PIEINF;
          |FININF;
          |FINIMP;
     |FINSI;
|FPRO;
