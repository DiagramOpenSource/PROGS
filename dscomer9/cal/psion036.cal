|FICHEROS;
     psion036 #0;
     psion004 #1;
     psion005 #2;
     agifa024 #3;   || Clientes.
     agifa019 #4;   || Articulos.
     psion001 #9;   || Mto. Pase Datos Psion.
     agifa321 #14;  || Divisas-Parametros.
     agifa324 #15;  || Divisas-Divisas.
     agifa104 #104;
     agifa073 #73;
     agifa010 #10;
     agifa071 #71;
     agifa084 #84;
     agifa069 #69;
|FIN;

|VARIABLES;
     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;
     &eaImpresora = "";
     &eaFicTmpCab = "";
     &eaFicTmpLin = "";

     &ser_alb = "";
     &num_alb = 0;
     &ser_ped = "";
     &num_ped = 0;
     &serie = "";
     &numero = 0;

     aTempC = "";
     aTempL = "";
     aFic = "";
     bruto = 0;
     impuesto = 0;
     almacen = 0;
     nSal = 0;
     nHandle = 0;
     aAlfa = "";
     i = 0;
     nCamRec = 0;
     nCamIva = 0;
     nError = 0;
     nBoton = 0;
     nBruto = 0;
     aRuta = "";
     &Tempo = "";
     aTemp1 = "";
     aTemp2 = "";
     total = 0;
     nCamBase = 0;

     nCampo = 0;
 {90}Valor = "";
     aReg = "";
     aLon = "";
     aDato = "";
     nPos = 0;
     aLetra = "";
     aTab = "";
|FIN;

|PROCESO LinFac;
     |DDEFECTO #69;
     #69#20 = #2#2;
     #69#0 = #2#1;
     #69#1 = #2#3;
     #69#2 = #2#4;
     #69#4 = #2#5;
     #69#5 = #2#6;
     #69#6 = #2#7; #69#26 = #2#7; #69#28 = #2#7;
     #69#8 = #2#8;
     #69#11 = #2#9;
     #69#9 = #2#10; #69#27 = #2#10; #69#29 = #2#10;
     #69#3 = #2#11;
     #69#31 = #2#12;
     #69#21 = #2#13;
     |GRABA 020#69n;
|FPRC;

|PROCESO LinAlb;
     |DDEFECTO #71;
     #71#29 = #2#2;
     #71#0 = #2#1;
     #71#1 = #2#3;
     #71#2 = #2#4;
     #71#4 = #2#5;
     #71#5 = #2#6;
     #71#6 = #2#7; #71#36 = #2#7; #71#38 = #2#7;
     #71#8 = #2#8;
     #71#11 = #2#9;
     #71#9 = #2#10; #71#37 = #2#10; #71#39 = #2#10;
     #71#3 = #2#11;
     #71#49 = #2#12;
     #71#33 = #2#13;
     |GRABA 020#71n;
|FPRC;

|PROCESO LinPed;
     |DDEFECTO #73;
     #73#28 = #2#2;
     #73#0 = #2#1;
     #73#1 = #2#3;
     #73#2 = #2#4;
     #73#4 = #2#5;
     #73#5 = #2#6;
     #73#6 = #2#7; #73#38 = #2#7; #73#40 = #2#7;
     #73#8 = #2#8;
     #73#14 = #2#9;
     #73#9 = #2#10; #73#39 = #2#10; #73#41 = #2#10;
     #73#3 = #2#11;
     #73#45 = #2#12;
     #73#29 = #2#13;
     |GRABA 020#73n;
|FPRC;

|PROCESO CabFac;
     |DDEFECTO #84;
     #84#48 = #1#2;
     #84#0 = #1#1;
     #84#1 = #1#3;
     #84#3 = #1#4;
     #84#4 = #1#5;
     #84#15 = #1#8; #84#70 = #1#8; #84#72 = #1#8; #84#74 = #1#8;
     #84#41 = #1#9; #84#71 = #1#9; #84#73 = #1#9; #84#75 = #1#9;
     #84#6 = #1#10;
     #84#5 = #1#11;
     #84#7 = #1#12;
     #84#32 = #1#13;
     #84#28 = #1#14;
     #84#16 = #1#15;
     #84#19 = #1#16;
     #84#22 = #1#17;
     #84#42 = #1#18;
     #84#45 = #1#19;
     #84#17 = #1#20;
     #84#20 = #1#21;
     #84#23 = #1#22;
     #84#43 = #1#23;
     #84#46 = #1#24;
     #84#18 = #1#25;
     #84#21 = #1#26;
     #84#49 = #1#27;
     #84#44 = #1#28;
     #84#47 = #1#29;
     #84#25 = #1#30;
     #84#24 = #1#31;
     #84#91 = #1#32;
     #84#8 = #1#37;
     |GRABA 020#84n;
|FPRC;

|PROCESO CabAlb;
     |DDEFECTO #10;
     #10#52 = #1#2;
     #10#0 = #1#1;
     #10#1 = #1#3;
     #10#3 = #1#4;
     #10#4 = #1#5;
     #10#15 = #1#8; #10#75 = #1#8; #10#77 = #1#8; #10#79 = #1#8;
     #10#67 = #1#9; #10#76 = #1#9; #10#78 = #1#9; #10#80 = #1#9;
     #10#6 = #1#10;
     #10#5 = #1#11;
     #10#7 = #1#12;
     #10#32 = #1#13;
     #10#28 = #1#14;
     #10#16 = #1#15;
     #10#19 = #1#16;
     #10#22 = #1#17;
     #10#44 = #1#18;
     #10#47 = #1#19;
     #10#17 = #1#20;
     #10#20 = #1#21;
     #10#23 = #1#22;
     #10#45 = #1#23;
     #10#48 = #1#24;
     #10#18 = #1#25;
     #10#21 = #1#26;
     #10#54 = #1#27;
     #10#46 = #1#28;
     #10#49 = #1#29;
     #10#25 = #1#30;
     #10#24 = #1#31;
     #10#84 = #1#32;
     #10#66 = #1#35;
     #10#8 = #1#36;
     |GRABA 020#10n;
|FPRC;

|PROCESO CabPed;
     |DDEFECTO #104;
     #104#25 = #1#2;
     #104#0 = #1#1;
     #104#1 = #1#2;
     #104#4 = #1#3;
     #104#8 = #1#4;
     #104#11 = #1#9; #104#42 = #1#9; #104#45 = #1#9; #104#48 = #1#9;
     #104#7 = #1#10;
     #104#6 = #1#11;
     #104#5 = #1#12;
     #104#17 = #1#13;
     #104#57 = #1#32;
     #104#2 = #1#33;
     #104#15 = #1#34;
     #104#9 = #1#37;
     #104#35 = #15#0;
     #104#36 = #15#2;
     #104#37 = "B";
     |GRABA 020#104n;
|FPRC;

|PROCESO Dato;
     IValor = Valor1<-;
     |PARA i = 1; |SI i [ 90; |HACIENDO i = i + 1;
          Valor = "";
          IValor = IValor + 1;
     |SIGUE;
     nCampo = 1;
     IValor = Valor1<-;
     aLon = aDato % A0;
     aReg = "";
     aTab = &9;
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aLetra = aDato % nPos;
          |SI aLetra = aTab;
               Valor = aReg;
               aReg = "";
               nCampo = nCampo + 1;
               IValor = IValor + 1;
          |SINO;
               aReg = aReg + aLetra;
          |FINSI;
          |SI nCampo > 90; |SAL; |FINSI;     || Por si.... :)
     |SIGUE;
     Valor = aReg;
|FPRC;

|PROCESO grabalineas;
     bruto    = 0;
     impuesto = 0;
     |ABRE #4;           || Articulos
     #4#0 = #2#4;
     |LEE 000#4=;
     |SI #9#59 ! 2;      || El Pda tra la descripcion en el asc
          #2#5 = #4#1;
     |FINSI;
     |CIERRA #4;

     enTiva = #2#9;
     efFiva = #4#3;
     |HAZ SacaIVA;
     impuesto = ;
     |ABRE #3;
     #3#0 = #1#4;
     |LEE 000#3=;
     |SI #3#47 = "S"; impuesto = enIva + enRec; |FINSI;

     bruto = #2#6 * #2#7;          || base.
     bruto = bruto < #2#8;         || dto.
     bruto = bruto ! #15#7;
     #2#10 = bruto;                || bruto.

     |SI #2#11 = 0; #2#11 = almacen; |FINSI;
     |SI #2#11 = 0; #2#11 = 1; |FINSI;

     #2#14 = #2#11;         || Almacen (no se usa para nada)

     |CIERRA #3;
     |GRABA 121#2n;
     |DDEFECTO #2;
|FPRC;

|PROCESO Suma;
     enTiva = #2#9;
     efFiva = #1#3;
     |HAZ SacaIVA;

||T.Linea
    #2#10 = ((#2#6 * #2#7) < #2#8) ! #15#7;

||Bruto
     #1#8 = (#1#8 +. #2#10) ! #15#7;
     nBruto = (((#2#10 < #1#11) < #1#13) < #1#12);

     nError = 1;
     |SI #1#8 < 0; nError = -1; |FINSI;
     #1#8 = #1#8 * nError;

||Dto
     #1#30 = (((#1#8 < #1#11) < #1#13) < #1#12) ! #15#7;
     #1#30 = #1#30 * nError;
     #1#8 = #1#8 * nError;
     #1#30 = #1#8 - #1#30;

||Ivas
     |SI #2#9 = 0;
          #1#14 = (#1#14 +. nBruto) ! #15#7;
     |SINO;
          nCamBase = #2#9 - 1 + 15;
          nCamIva = #2#9 - 1 + 20;
          nCamRec = #2#9 - 1 + 25;
          #1nCamBase = (#1nCamBase +. nBruto) ! #15#7;
          #1nCamIva = (#1nCamBase %  enIva) ! #15#7;
          |SI #3#47 = "S";
               #1nCamRec = (#1nCamBase % enRec) ! #15#7;
          |FINSI;
     |FINSI;

||T.IVA
     #1#31 = #1#20+#1#21+#1#22+#1#23+#1#24+#1#25+#1#26+#1#27+#1#28+#1#29;
     #1#31 = #1#31 ! #15#7;

||Total
     #1#9 = (#1#8 - #1#30 + #1#31) ! #15#7;
|FPRC;

|DEFBUCLE totalalb;
     #2#1;
     ;
     #1#0,#1#2,#1#1,000;
     #1#0,#1#2,#1#1,999;
     be;
     NULL, Suma;
|FIN;

|PROCESO grabacabeza;
     #1#8 = 0;
     #1#9 = 0;
     |PARA i = 14; |SI i [ 31; |HACIENDO i = i + 1;
          #1i = 0;
     |SIGUE;

     |ABRE #3;
     #3#0 = #1#4;
     |LEE 000#3=;
     |CIERRA #3;

     |BUCLE totalalb;

     |ABRE #3;
     #3#0 = #1#4;
     |LEE 000#3=;
     #1#5 = #3#1;
     |SI #1#10 = "  "; |O #1#10 = "00";
          #1#10 = #3#25;
     |FINSI;
     |LIBERA #3;
     |CIERRA #3;

     |SI #1#7 [ 0;
         #1#6 = "N";
     |FINSI;
     |SI #1#7 ] #1#9;
         #1#6 = "S";
     |FINSI;
     |SI #1#7 < #1#9; |Y #1#7 > 0;
         #1#6 = "P";
     |FINSI;

     total = #1#9 - #1#7;
     total = total ! #15#7;
     |SI total < 0; total = -total;     |FINSI;   || valor absoluto
     |SI total [ 0.05;
         #1#6 = "S";
         #1#7 = #1#9;
     |FINSI;

     |GRABA 121#1n;
     |DDEFECTO #1;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #9;
     #9#0 = #0#1;
     |LEE 000#9=;
     |CIERRA #9;

     |HAZ CreaTempo; aTemp1 = Tempo; |NOME_DAT #1 Tempo; |DELINDEX #1;
     |HAZ CreaTempo; aTemp2 = Tempo; |NOME_DAT #2 Tempo; |DELINDEX #2;
     |HAZ CreaTempo; aTempC = Tempo;
     |HAZ CreaTempo; aTempL = Tempo;
     |ABRE #1;
     |ABRE #2;
     aFic = #0#0; |QBF aFic;
     |XABRE "C", aFic, nHandle;
     |SI FSalida ] 0;
          |PARA nSal = 0; |SI nSal ] 0; |HACIENDO;
               |XLEE nHandle, 254, aDato;
               nSal = FSalida;
               |SI nSal > 0;
                    |HAZ Dato;
                    |DDEFECTO #2;
                    #2#0 = Valor1;
                    #2#1 = Valor2;
                    #2#2 = Valor3;
                    #2#3 = Valor4;
                    #2#4 = Valor5;
                    #2#6 = Valor6;
                    #2#7 = Valor7;
                    #2#8 = Valor8;
                    #2#9 = Valor90;
                    #2#5 = Valor10;
                    |SI #2#11 = 0; #2#11 = 1; |FINSI; || Almacen
                    |HAZ grabalineas;
               |FINSI;
          |SIGUE;
          |XCIERRA nHandle;
     |FINSI;

     aAlfa = aFic % A0;
     nPos = aAlfa;
     nPos = nPos - 3 + 100;
     aFic = aFic % nPos;
     aFic = aFic + "cab";

     |XABRE "C", aFic, nHandle;
     |SI FSalida ] 0;
          |PARA nSal = 0; |SI nSal ] 0; |HACIENDO;
               |XLEE nHandle, 254, aDato;
               nSal = FSalida;
               |SI nSal > 0;
                    |HAZ Dato;
                    |DDEFECTO #1;
                    #1#0 = Valor1;
                    #1#1 = Valor2;
                    #1#2 = Valor3;
                    #1#3 = Valor4;
                    #1#4 = Valor5;
                    #1#6 = Valor6;
                    #1#7 = Valor7;
                    #1#11 = Valor11;
                    #1#12 = Valor12;
                    #1#13 = Valor13;
                    #1#32 = Valor14;
                    |SI Valor15 ! ""; #1#33 = Valor15; |FINSI;
                    #1#34 = Valor16;
                    #1#35 = Valor17;
                    |SI #9#59 = 2;
                         aAlfa = Valor10; |QBT aAlfa;
                         |SI aAlfa ! "0"; |Y aAlfa ! "00";
                              #1#37 = Valor10;
                         |FINSI;
                    |FINSI;
                    #1#10 = Valor19;
                    |SI #1#32 = 0; #1#32 = 1; |FINSI;  || Dir. Entrega
                    #1#7 = #1#7 ! #15#7;
                    |HAZ grabacabeza;
               |FINSI;
          |SIGUE;
          |XCIERRA nHandle;
     |FINSI;
     #1#0 = Valor1;
     #1#1 = Valor2;
     #1#2 = Valor3;
     |LEE 000#1=;
     |SI #1#0 = "P";
          |NOME_DAT #104 aTempC; |DELINDEX #104;
          |NOME_DAT #73 aTempL; |DELINDEX #73;
          |ABRE #104;
          |ABRE #73;
          |HAZ CabPed;
          |BUCLELIN 2 LinPed #1;
          |CIERRA #73;
          |CIERRA #104;
          ser_ped = #1#2;
          num_ped = #1#1;
          eaFicTmpCab = aTempC;
          eaFicTmpLin = aTempL;
          eaImpresora = #9#66; |QBF eaImpresora;
          |SUB_EJECUTA "agifa105";
          |DELINDEX #104;
          |DELINDEX #73;
     |FINSI;
     |SI #1#0 = "A";
          |NOME_DAT #10 aTempC; |DELINDEX #10;
          |NOME_DAT #71 aTempL; |DELINDEX #71;
          |ABRE #10;
          |ABRE #71;
          |HAZ CabAlb;
          |BUCLELIN 2 LinAlb #1;
          |CIERRA #71;
          |CIERRA #10;
          ser_alb = #1#2;
          num_alb = #1#1;
          eaFicTmpCab = aTempC;
          eaFicTmpLin = aTempL;
          eaImpresora = #9#66; |QBF eaImpresora;
          |SUB_EJECUTA "agifa014";
          |DELINDEX #10;
          |DELINDEX #71;
     |FINSI;
     |SI #1#0 = "F";
          |NOME_DAT #84 aTempC; |DELINDEX #84;
          |NOME_DAT #69 aTempL; |DELINDEX #69;
          |ABRE #84;
          |ABRE #69;
          |HAZ CabFac;
          |BUCLELIN 2 LinFac #1;
          |CIERRA #69;
          |CIERRA #84;
          serie = #1#2;
          numero = #1#1;
          eaFicTmpCab = aTempC;
          eaFicTmpLin = aTempL;
          eaImpresora = #9#66; |QBF eaImpresora;
          |SUB_EJECUTA "agifa086";
          |DELINDEX #84;
          |DELINDEX #69;
     |FINSI;
     |CIERRA #1;
     |CIERRA #2;
     |DELINDEX #1; Tempo = aTemp1; |HAZ BoraTempo;
     |DELINDEX #2; Tempo = aTemp2; |HAZ BoraTempo;
     Tempo = aTempC; |HAZ BoraTempo;
     Tempo = aTempL; |HAZ BoraTempo;
|FPRC;

|PROCESO Desactiva; |TIPO 0;
     |ESTADO_CONTROL nBoton, "DISABLE";
|FPRC;

|PROCESO Activa; |TIPO 7;
     |ESTADO_CONTROL nBoton, "ENABLE";
|FPRC;

|PROCESO Boton;
     |PTEC 824; ||F2
|FPRC;

|PROCESO Browse; |TIPO 0;
     |SI FSalida ! 10; |ACABA; |FINSI;

     |ESTADO_CONTROL nBoton, "DISABLE";
     |PUSHV 0501 2380;
     aRuta = #0#0;  |QBF aRuta;
     |SI aRuta = ""; aRuta = "\*.*"; |FINSI;
     aRuta = "F" + aRuta;
     |BROWSE aRuta; |QBF aRuta;
     |POPV;
     |ESTADO_CONTROL nBoton, "ENABLE";
     #0#0 = aRuta % 280; |PINTA #0#0;
     aRuta = #0#0; |QBF aRuta;
     |SI aRuta = ""; |ERROR; |FINSI;
|FPRC;

|PROCESO Tipo9;
     |FIN_CONTROL_WINDOWS nBoton;
     |PULSATECLA;
|FPRC;

|PROCESO Tipo8;
     |CONTROL_SIMPLE 0, "BOTON, Fichero", 1116, 1123, Boton;
     nBoton = FSalida;
     |ESTADO_CONTROL nBoton, "DISABLE";
     |PULSATECLA;
|FPRC;

|PROCESO LeeDivisa;
     |ABRE #14;
     |ABRE #15;
     #14#0 = "A";
     |LEE 001#14=;
     |SI FSalida ! 0; |DDEFECTO #14; |FINSI;
     #15#0 = #14#9;
     |LEE 001#15=;
     |SI FSalida ! 0; |DDEFECTO #15; |FINSI;
     |CIERRA #14;
     |CIERRA #15;
|FPRC;

|PROGRAMA;
     |ABRE #0;
     |LEE 101#0=;
     |SI FSalida ! 0;
          |GRABA 020#0b;
     |FINSI;

     |HAZ LeeDivisa;
     |SI PARAMETRO ! "";
          |LIBERA #0;
          #0#0 = PARAMETRO;
          |HAZ Tipo3;
     |SINO;
          |CLS;
          |PINPA #0#0;
          |PINDA #0#0;
          |HAZ Tipo8;
          |ENDATOS #1#0;
          |SI FSalida = 0;
               |GRABA 020#0a;
          |FINSI;
          |HAZ Tipo9;
     |FINSI;
     |CIERRA #0;
|FPRO;
