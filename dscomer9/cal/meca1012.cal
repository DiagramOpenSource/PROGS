|FICHEROS;
     mecaz012 #0;
     mecam007 #7;
     mecam008 #8;
     agifa010 #10;
     mecam014 #14;
     agifa019 #19;
     mecaw021 #21,MANTE; || Tmp seleccion
     mecaw023 #23;       || Tmp cantidad
     mecaw027 #27;       || Tmp marcar paquetes
     agifa024 #24;
     agifa025 #25;
     agifa027 #27;
     agifa071 #71;
     agifa073 #73;
     agifa104 #104;
     dsm00020 #200; ||Agencia transporte
     agifa142 #142;
     dsm00238 #238;
     agifa321 #321;
     agifa324 #324;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     &nImpo = 0;
     nCalc = 0;
     aAlfa = "";
     &ser_alb = "";
     &num_alb = 0;
     &abono = "";
     &Tempo = "";
     aTmp23 = "";
     aTmp27 = "";
     nLinea = 0;
     &enSwMenu = 0;
     &aDivisa = "";
     &aMoneda = "";
     nUni2 = 0;
     importe = 0;
     cant = 0;
     nForma = 1;
     &eaTag = "";
|FIN;


|PROCESO MarcaPaqueteLin;
     #8#6 = #71#29;
     #8#7 = #71#0;
     #8#8 = #71#1;
     |GRABA 020#8a;
     |LIBERA #8;
|FPRC;

|DEFBUCLE MarcaPaqueteLin;
     #8#1;
     ;
     #0#3, #0#4, #27#0, #27#1;
     #0#3, #0#4, #27#0, #27#1;
     be;
     NULL, MarcaPaqueteLin;
|FIN;

|PROCESO MarcaPaquete;
     |BUCLE MarcaPaqueteLin;
|FPRC;

|DEFBUCLE MarcaPaquete;
     #27#2;
     ;
     #23#2;
     #23#2;
     ;
     NULL, MarcaPaquete;
|FIN;

|PROCESO actpf;
     |SI #10#15 ] 0;
          importe = 1;
     |SINO;
          importe = -1;
          #10#15 = -#10#15;
     |FINSI;
     cant = #10#15 < #10#5;
     cant = cant < #10#32;
     cant = cant < #10#7;
     cant = cant * importe;
     #10#15 = #10#15 * importe;
     |ABRE #24;
     #24#0 = #10#3;
     |LEE 121#24=;
     |SI FSalida = 0;
        |SI #10#43 = AN;
           #24#50 = #24#50 + cant;    || es albaran
        |SINO;
           #24#50 = #24#50 - cant;    || es abono
        |FINSI;
        |GRABA 020#24a;
        |LIBERA #24;
     |FINSI;
     |CIERRA #24;

     |SI #10#43 = "N";
          enImpCliPen = cant * nForma;
     |SINO;
          enImpCliPen =  -cant * nForma;
     |FINSI;
     eaCliente = #10#3;
     efFecha = #10#1;
     |HAZ AcumulaCli;

     eaTag = "AV";  |HAZ Riesgos;
|FPRC;

|PROCESO Lineas;
     |ABRE #73;
     #73#28 = #23#0;
     #73#0 = #23#1;
     #73#1 = #23#2;
     |LEE 121#73=;
     |SI FSalida = 0;
          |DDEFECTO #19;
          |ABRE #19;
          #19#0 = #73#2;
          |LEE 000#19=;
          |CIERRA #19;
          nUni2 = 0;
          |SI #19#179 = "S";
               #238#0 = #19#201;
               |LEE 020#238=;
               |SI #238#8 = 1; nUni2 = #23#3 * #73#50; |FINSI;
               |SI #238#8 = 2; nUni2 = #23#3 * #73#50 * #73#51; |FINSI;
               |SI #238#8 = 3; nUni2 = #23#3 * #73#50 * #73#51 * #73#52; |FINSI;
          |FINSI;
          #73#43 = #73#43 + #23#3;  || Servidas
          #73#49 = #73#49 + nUni2;
          |GRABA 020#73a;
          |LIBERA #73;
     |SINO;
          |MENAV "0000ERROR. No existe linea pedido";
          |ACABA;
     |FINSI;
     |CIERRA #73;

     nLinea = nLinea + 1;
     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = nLinea;
     #71#2 = #73#2;
     #71#3 = #73#3;
     #71#4 = #73#4;
     #71#5 = #23#3; || Unidades
     #71#6 = #73#6;
     #71#8 = #73#8;
     #71#10 = #73#10;
     #71#11 = #73#14;
     #71#12 = #73#0;
     #71#13 = #73#18;
     #71#15 = #10#3;
     #71#16 = #73#17;
     #71#17 = #73#19;
     #71#21 = #73#1;
     #71#31 = #73#28;
     #71#33 = #73#29;
     #71#36 = #73#38;

     #71#49 = #73#45;
     #71#50 = #73#46;
     #71#51 = #73#50;
     #71#52 = #73#51;
     #71#53 = #73#52;

     |SI #19#179 = "S";
          |SI #238#8 = 1; #71#48 = #71#5 * #71#51; |FINSI;
          |SI #238#8 = 2; #71#48 = #71#5 * #71#51 * #71#52; |FINSI;
          |SI #238#8 = 3; #71#48 = #71#5 * #71#51 * #71#52 * #71#53; |FINSI;
     |FINSI;

     |HAZ TotalLin71;
     |HAZ CalCabAgifa010;
     #10#41 = #10#41 + 1; || Control-P
     |GRABA 020#71n;

     enForma = 1;
     enUnidPend = #71#5;
     enUnidPend2 = #71#48;
     eaProgVta = "agifa210";
     |HAZ AcumulaAV;

     |BUCLE MarcaPaquete;

     enTiva = #73#14;
     efFiva = #104#1;
     |HAZ SacaIVA;

     nCalc = #73#11 % enIva;
     |SI #agifa024#47 = "S";
          nCalc = nCalc + (#73#11 % enRec);
     |FINSI;

     nImpo = #73#11 + nCalc;
     eaTag = "PAU";  |HAZ Riesgos;
|FPRC;

|PROCESO Cabecera;
     #10#1 = ~;
     #10#3 = #104#4;
     #10#4 = #104#8;
     #10#5 = #104#5;
     #10#6 = #104#7;
     #10#7 = #104#6;
     #10#8 = #104#9;
     #10#29 = #104#19;
     #10#30 = #104#14;
     #10#31 = #104#20;
     #10#32 = #104#17;
     #10#33 = #104#21;
     #10#34 = #25#7;
     #10#35 = #24#4;
     #10#36 = #24#47;
     #10#40 = #24#41;
     #10#50 = #24#40;
     #10#62 = #104#59;
     #10#63 = #24#19;
     #10#62 = #104#59;
     #10#68 = #104#35;
     #10#69 = #104#36;
     #10#70 = #104#37;
     #10#73 = #104#40;
     #10#74 = #104#41;
     #10#83 = #104#51;
     #10#84 = #104#57;
     #10#88 = #14#9;

     |ABRE #200;
     #200#0 = #10#88;
     |LEE 000#200=;
     |CIERRA #200;
     #10#9 = #200#1;

     aAlfa = #14#8; |QBT aAlfa;
     aAlfa = aAlfa + " " + #14#6;
     #10#55 = #14#5;
     #10#56 = aAlfa;
     #10#57 = #14#7;

     aDivisa = #10#68;
     aMoneda = #10#70;
     |HAZ Divisas010;
|FPRC;

|DEFBUCLE Lineas;
     #23#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, Lineas;
|FIN;

|PROCESO LinPaquete;
     |DDEFECTO #23;
     #23#0 = #8#0;
     #23#1 = #8#1;
     #23#2 = #8#3;
     |LEE 101#23=;
     |SI FSalida ! 0; |GRABA 020#23b; |FINSI;
     #23#3 = #23#3 + #8#5;
     |GRABA 020#23a;

     #27#0 = #21#2;
     #27#1 = #8#3;
     |GRABA 020#27n;
|FPRC;

|DEFBUCLE LinPaquete;
     #8#1;
     ;
     #21#3, #21#4, #21#2, 001;
     #21#3, #21#4, #21#2, 999;
     ;
     NULL, LinPaquete;
|FIN;

|PROCESO Agrupa;
     |BUCLE LinPaquete;
|FPRC;

|DEFBUCLE Agrupa;
     #21#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Agrupa;
|FIN;

|PROCESO Actualiza;
     |HAZ CreaTempo; aTmp23 = Tempo; |NOME_DAT #23 Tempo; |DELINDEX #23;
     |HAZ CreaTempo; aTmp27 = Tempo; |NOME_DAT #27 Tempo; |DELINDEX #27;

     |ABRE #23;
     |ABRE #27;
     |BUCLE Agrupa;
     |CIERRA #27;
     |CIERRA #23;

     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     |ABRE #321; |LEE 000#321p; |CIERRA #321;

     |ABRE #104;
     #104#25 = #0#3;
     #104#0 = #0#4;
     |LEE 121#104=;
     |SI FSalida ! 0;
          |MENAV "0000ERROR. No existe pedido...";
     |SINO;
          |ABRE #14;
          #14#0 = #0#0;
          #14#1 = #0#1;
          |LEE 000#14=;
          |CIERRA #14;

          |ABRE #200;
          #200#0 = #104#60;
          |LEE 020#200=;
          |CIERRA #200;

          |ABRE #24;
          #24#0 = #104#4;
          |LEE 020#24=;
          |CIERRA #24;

          |ABRE #25;
          #25#0 = #104#7;
          |LEE 020#25=;
          |CIERRA #25;

          |ABRE #10;
          |ABRE #71;

          |DDEFECTO #10;
          ||#10#52 = #0#3;
          #10#52 = #0#0;
          enSwMenu = 1;
          |HAZ ContaAV7;
          |GRABA 000#10b;
          |PARA; |SI FSalida ! 0; |HACIENDO;
               #10#0 = #10#0 + 1;
               |GRABA 000#10b;
          |SIGUE;

          |HAZ Cabecera;
          |HAZ LimCabAgifa010;
          nLinea = 0;
          |ABRE #238;
          |BUCLE Lineas;
          |CIERRA #238;
          |GRABA 020#10a;

          |CIERRA #10;
          |CIERRA #71;

          aDivisa = #104#35;
          aMoneda = #104#37;
          |HAZ Divisas104;

          |HAZ CalCabAgifa104;
          |GRABA 020#104a;

          |HAZ actpf;

          |CONFI "0000NImprimir albaran";
          |SI FSalida = 0;
               ser_alb = #10#52;
               num_alb = #10#0;
               abono = "N";
               |SUB_EJECUTA_NP "agifa014";
          |FINSI;
     |FINSI;
     |CIERRA #104;

     Tempo = aTmp23; |HAZ BoraTempo; |DELINDEX #23;
     Tempo = aTmp27; |HAZ BoraTempo; |DELINDEX #27;
|FPRC;
