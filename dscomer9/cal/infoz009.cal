|FICHEROS;
     infoz009 #0;
     agifa010 #10;
     agifa059 #59;
     agifa071 #71;
     agifa073 #73;
     agifa077 #77;
     agifa080 #80;
     agifa104 #104;
     agifa134 #134;
|FIN;

|VARIABLES;
     DIFE = 1;
     nDif = 0;
     &eaTipo = "";
     &enTipo = 0;
     aAlfa = "";
     nPrime = 0;
     nInfor = -1;
     nImpre = -1;
     nImpVis = 0;
     nImpDiv = 0;
     &aDivisa = "";
     &aMoneda = "";
     &nDeci_BaseMxP = 0;
     &nDeci_ImpVisP = 0;
     &nDeci_DivP = 0;
     &nDeci_IVA = 0;
     &nDeci_IVADiv = 0;
     &nDeci_IVAImp = 0;
     &nDeci_BaseMx = 0;
     &nDeci_DivF = 0;
     &nDeci_IVAC = 0;
     &nDeci_IVACDiv = 0;
     &nDeci_IVACImp = 0;
     nImpBruto = 0;
     nImpDto = 0;
     nImpPor = 0;
     nImpVar = 0;
     nImpBase1 = 0;
     nImpBase2 = 0;
     nImpBase3 = 0;
     nImpBase4 = 0;
     nImpBase5 = 0;
     nImpIva = 0;
     nImpTotal = 0;
     nImpComi = 0;
     nImpBase = 0;
     nImpBrutoD = 0;
     nImpDtoD = 0;
     nImpPorD = 0;
     nImpBaseD = 0;
     nImpIvaD = 0;
     nImpTotalD = 0;
     nImpBrutoV = 0;
     nImpDtoDV = 0;
     nImpPorDV = 0;
     nImpBaseV = 0;
     nImpIvaV  = 0;
     nImpTotalV = 0;
     nOk = 0;
     aFic = "";
     aMail = "";
     aEmp = "";
     fHoy = @;
     aIP = "";
     aServidor = "";
     aFrom = "";
     aTo = "";
     aMensaje = "";
     aSubject = "";
     aDjunto = "";
     nHay = 0;
     nNume = 0;
|FIN;

|PROCESO EnviaMail;
     fHoy = ~;
     |DFICE aEmp; aEmp = aEmp % -205;

     aIP = "xdscorreo.dv.diagram.net";
     aServidor = "asmtp.diagram.es";

     aFrom = aMail;
     aTo = aMail;
     aSubject = "Chequeo ficheros empresa:" + aEmp + " (" + fHoy + ")";
     aMensaje = "$$$$" + aFic;
     aDjunto = aFic;
     |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
     |FBORRA aFic;
|FPRC;

|PROCESO Imprime;
     |SI nPrime = 0;
          nPrime = 1;
          |SI aMail = "";
               |IMPRE 0;
          |SINO;
               |DFICE aAlfa;
               aFic = aAlfa + Usuario + ".txt";
               Impresora = aFic;
               |IMPRE -77;
          |FINSI;
          nImpre = FSalida;
          |SI FSalida = 0;
               |INFOR "infoz009";
               nInfor = FSalida;
          |FINSI;
     |FINSI;
     |SI nImpre = 0; |Y nInfor = 0;
          |PRINT;
          nHay = 1;
     |FINSI;
|FPRC;

|PROCESO FinPed;
     |SI nImpTotal ! #104#11; |O nImpVis ! #104#45; |O nImpDiv ! #104#42;
          eaTipo = "Importe lineas pedido distinto a la cabecera";
          enTipo = 3;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|PROCESO LinPed;
     nImpTotal = (nImpTotal + #73#9) ! nDeci_BaseMxP;
     nImpDiv = (nImpDiv + #73#39) ! nDeci_DivP;
     nImpVis = (nImpVis + #73#41) ! nDeci_ImpVisP;
|FPRC;

|PROCESO CabPed;
     aDivisa = #104#35;
     aMoneda = #104#37;
     |HAZ Divisas104;

     nImpTotal = 0;
     nImpVis = 0;
     nImpDiv = 0;
|FPRC;

|DEFBUCLE TotaPedido;
     #104#7;
     ;
     #0#9, "      ", 0001, "     ", 000001;
     #0#10, "zzzzzz", 9999, "zzzzz", 999999;
     ;
     NULL, CabPed, LinPed, FinPed;
|FIN;

|PROCESO LinPedido;
     #104#25 = #73#28;
     #104#0 = #73#0;
     |LEE 000#104=;
     |SI FSalida ! 0;
          eaTipo = "Linea pedido sin cabecera";
          enTipo = 2;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|DEFBUCLE LinPedido;
     #73#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, LinPedido;
|FIN;

|PROCESO CabPedido;
     #73#28 = #104#25;
     #73#0 = #104#0;
     #73#1 = 1;
     |LEE 000#73];
     |SI FSalida ! 0; |O #73#28 ! #104#25; |O #73#0 ! #104#0;
          eaTipo = "Cabecera pedido sin lineas";
          enTipo = 1;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|DEFBUCLE CabPedido;
     #104#7;
     ;
     #0#7, "      ", 0001, "     ", 000001;
     #0#8, "zzzzzz", 9999, "zzzzz", 999999;
     ;
     NULL, CabPedido;
|FIN;

|PROCESO FinAlb;
     |SI nImpTotal ! #10#15; |O nImpVis ! #10#79; |O nImpDiv ! #10#75;
          eaTipo = "Importe lineas albaran distinto a la cabecera";
          enTipo = 6;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|PROCESO LinAlb;
     nImpTotal = (nImpTotal + #71#9) ! nDeci_IVA;
     nImpDiv = (nImpDiv + #71#37) ! nDeci_IVADiv;
     nImpVis = (nImpVis + #71#39) ! nDeci_IVAImp;
|FPRC;

|PROCESO CabAlb;
     aDivisa = #10#68;
     aMoneda = #10#70;
     |HAZ Divisas010;

     nImpTotal = 0;
     nImpVis = 0;
     nImpDiv = 0;
|FPRC;

|DEFBUCLE TotaAlbaran;
     #10#7;
     ;
     #0#9, "     ", 000001;
     #0#10, "zzzzz", 999999;
     ;
     NULL, CabAlb, LinAlb, FinAlb;
|FIN;

|PROCESO LinAlbaran;
     #10#52 = #71#29;
     #10#0 = #71#0;
     |LEE 000#10=;
     |SI FSalida ! 0;
          eaTipo = "Linea albaran sin cabecera";
          enTipo = 5;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|DEFBUCLE LinAlbaran;
     #71#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, LinAlbaran;
|FIN;

|PROCESO CabAlbaran;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = 1;
     |LEE 000#71];
     |SI FSalida ! 0; |O #71#29 ! #10#52; |O #71#0 ! #10#0;
          eaTipo = "Cabecera albaran sin lineas";
          enTipo = 4;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|DEFBUCLE CabAlbaran;
     #10#7;
     ;
     #0#7, "     ", 000001;
     #0#8, "zzzzz", 999999;
     ;
     NULL, CabAlbaran;
|FIN;

|PROCESO FinFac;
     nOk = 0;
/*
     |SI nImpBruto ! #134#18; nOk = 1; |FINSI;
     |SI nImpDto ! #134#17; nOk = 1; |FINSI;
     |SI nImpPor ! #134#19; nOk = 1; |FINSI;
     |SI nImpVar ! #134#20; nOk = 1; |FINSI;
     |SI nImpBase1 ! #134#21; nOk = 1; |FINSI;
     |SI nImpBase2 ! #134#24; nOk = 1; |FINSI;
     |SI nImpBase3 ! #134#27; nOk = 1; |FINSI;
     |SI nImpBase4 ! #134#33; nOk = 1; |FINSI;
     |SI nImpBase5 ! #134#36; nOk = 1; |FINSI;

     nNume = (#134#29 + #134#30) ! nDeci_IVA;
 ||    |SI nImpIva ! nNume; nOk = 1; |FINSI;

||     |SI nImpTotal ! #134#31; nOk = 1; |FINSI;
     |SI nImpComi ! #134#8; nOk = 1; |FINSI;
   ||  |SI nImpBase ! #134#; nOk = 1; |FINSI;

     |SI nImpBrutoD ! #134#65; nOk = 1; |FINSI;
     |SI nImpDto ! #134#64; nOk = 1; |FINSI;
     |SI nImpPorD ! #134#66; nOk = 1; |FINSI;
   ||  |SI nImpBaseD ! #134#; nOk = 1; |FINSI;
   ||  |SI nImpIvaD ! #134#; nOk = 1; |FINSI;
||     |SI nImpTotalD ! #134#78; nOk = 1; |FINSI;

     |SI nImpBrutoV ! #134#88; nOk = 1; |FINSI;
     |SI nImpDtoDV ! #134#87; nOk = 1; |FINSI;
     |SI nImpPorDV ! #134#89; nOk = 1; |FINSI;
 ||    |SI nImpBaseV ! #134#; nOk = 1; |FINSI;
 ||    |SI nImpIvaV ! #134#; nOk = 1; |FINSI;
||     |SI nImpTotalV ! #134#101; nOk = 1; |FINSI;
*/

     nDif = nImpBruto - #134#18;
     |HAZ Check;

     nDif = nImpDto - #134#17;
     |HAZ Check;

     nDif = nImpPor - #134#19;
     |HAZ Check;

     nDif = nImpVar - #134#20;
     |HAZ Check;

     nDif = nImpBase1 - #134#21;
     |HAZ Check;

     nDif = nImpBase2 - #134#24;
     |HAZ Check;

     nDif = nImpBase3 - #134#27;
     |HAZ Check;

     nDif = nImpBase4 - #134#33;
     |HAZ Check;

     nDif = nImpBase5 - #134#36;
     |HAZ Check;

     nDif = nImpComi - #134#8;
     |HAZ Check;

     nDif = nImpBrutoD - #134#65;
     |HAZ Check;

     nDif = nImpDto - #134#64;
     |HAZ Check;

     nDif = nImpPorD - #134#66;
     |HAZ Check;

     nDif = nImpBrutoV - #134#88;
     |HAZ Check;

     nDif = nImpDtoDV - #134#87;
     |HAZ Check;

     nDif = nImpPorDV - #134#89;
     |HAZ Check;

     |SI nOk ! 0;
          eaTipo = "Importe lineas factura distinto a la cabecera";
          enTipo = 9;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|PROCESO Check;
     |SI nDif < 0; nDif = -nDif; |FINSI;
     |SI nDif > DIFE;
          nOk = 1;
     |FINSI;
|FPRC;

|PROCESO LinFac;
     nImpBruto = (nImpBruto + #59#3) ! nDeci_IVA;
     nImpDto = (nImpDto + #59#4) ! nDeci_IVA;
     nImpPor = (nImpPor + #59#5) ! nDeci_BaseMx;
     nImpVar = (nImpVar + #59#6) ! nDeci_BaseMx;
     nImpBase1 = (nImpBase1 + #59#7) ! nDeci_IVA;
     nImpBase2 = (nImpBase2 + #59#8) ! nDeci_IVA;
     nImpBase3 = (nImpBase3 + #59#9) ! nDeci_IVA;
     nImpBase4 = (nImpBase4 + #59#16) ! nDeci_IVA;
     nImpBase5 = (nImpBase5 + #59#17) ! nDeci_IVA;
     nImpIva = (nImpIva + #59#10) ! nDeci_IVA;
     nImpTotal = (nImpTotal + #59#11) ! nDeci_BaseMx;
     nImpComi = (nImpComi + #59#12) ! nDeci_BaseMx;
     nImpBase = (nImpBase + #59#13) ! nDeci_IVA;

     nImpBrutoD = (nImpBrutoD + #59#21) ! nDeci_IVADiv;
     nImpDtoD = (nImpDtoD + #59#22) ! nDeci_IVADiv;
     nImpPorD = (nImpPorD + #59#23) ! nDeci_DivF;
     nImpBaseD = (nImpBase + #59#13) ! nDeci_IVADiv;
     nImpIvaD = (nImpIvaD + #59#25) ! nDeci_IVADiv;
     nImpTotalD = (nImpTotalD + #59#26) ! nDeci_DivF;

     nImpBrutoV = (nImpBrutoV + #59#27) ! nDeci_IVAImp;
     nImpDtoDV = (nImpDtoDV + #59#28) ! nDeci_IVAImp;
     nImpPorDV = (nImpPorDV + #59#29) ! nDeci_IVAImp;
     nImpBaseV = (nImpBaseV + #59#30) ! nDeci_IVAImp;
     nImpIvaV = (nImpIvaV + #59#31) ! nDeci_IVAImp;
     nImpTotalV = (nImpTotalV + #59#32) ! nDeci_IVAImp;
|FPRC;

|PROCESO CabFac;
     aDivisa = #134#58;
     aMoneda = #134#60;
     |HAZ Divisas134;

     nImpBruto = 0;
     nImpDto = 0;
     nImpPor = 0;
     nImpVar = 0;
     nImpBase1 = 0;
     nImpBase2 = 0;
     nImpBase3 = 0;
     nImpBase4 = 0;
     nImpBase5 = 0;
     nImpIva = 0;
     nImpTotal = 0;
     nImpComi = 0;
     nImpBase = 0;

     nImpBrutoD = 0;
     nImpDtoD = 0;
     nImpPorD = 0;
     nImpBaseD = 0;
     nImpIvaD = 0;
     nImpTotalD = 0;

     nImpBrutoV = 0;
     nImpDtoDV = 0;
     nImpPorDV = 0;
     nImpBaseV = 0;
     nImpIvaV = 0;
     nImpTotalV = 0;
|FPRC;

|DEFBUCLE TotaFactura;
     #134#4;
     ;
     #0#10, "zzzzz", 999999, "      ";
     #0#9, "     ", 000001, "zzzzzz";
     ;
     NULL, CabFac, LinFac, FinFac;
|FIN;

|PROCESO LinFactura;
     #134#49 = #59#14;
     #134#0 = #59#0;
     |LEE 000#134=;
     |SI FSalida ! 0;
          eaTipo = "Linea factura sin cabecera";
          enTipo = 8;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|DEFBUCLE LinFactura;
     #59#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, LinFactura;
|FIN;

|PROCESO CabFactura;
     #59#14 = #134#49;
     #59#0 = #134#0;
     #59#1 = 1;
     |LEE 000#59];
     |SI FSalida ! 0; |O #59#14 ! #134#49; |O #59#0 ! #134#0
          eaTipo = "Cabecera factura sin lineas";
          enTipo = 7;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|DEFBUCLE CabFactura;
     #134#4;
     ;
     #0#8, "zzzzz", 999999, "      ";
     #0#7, "     ", 000001, "zzzzzz";
     ;
     NULL, CabFactura;
|FIN;

|PROCESO FinCom;
     |SI nImpTotal ! #77#15; |O nImpVis ! #77#65; |O nImpDiv ! #77#63;
          eaTipo = "Importe lineas albaran compra distinto a la cabecera";
          enTipo = 12;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|PROCESO LinCom;
     nImpTotal = (nImpTotal + #80#9) ! nDeci_IVAC;
     nImpDiv = (nImpDiv + #80#31) ! nDeci_IVACDiv;
     nImpVis = (nImpVis + #80#33) ! nDeci_IVACImp;
|FPRC;

|PROCESO CabCom;
     aDivisa = #77#56;
     aMoneda = #77#58;
     |HAZ Divisas077;

     nImpTotal = 0;
     nImpVis = 0;
     nImpDiv = 0;
|FPRC;

|DEFBUCLE TotaAlbCom;
     #77#3;
     ;
     "      ", #0#9, "     ", 000001;
     "zzzzzz", #0#10, "zzzzz", 999999;
     ;
     NULL, CabCom, LinCom, FinCom;
|FIN;

|PROCESO LinAlbCom;
     #77#50 = #80#27;
     #77#0 = #80#0;
     |LEE 000#77=;
     |SI FSalida ! 0;
          eaTipo = "Linea albaran compra sin cabecera";
          enTipo = 11;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|DEFBUCLE LinAlbCom;
     #80#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, LinAlbCom;
|FIN;

|PROCESO CabAlbCom;
     #80#27 = #77#50;
     #80#0 = #77#0;
     #80#1 = 1;
     |LEE 000#80];
     |SI FSalida ! 0; |O #80#27 ! #77#50; |O #80#0 ! #77#0;
          eaTipo = "Cabecera albaran compras sin lineas";
          enTipo = 10;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|DEFBUCLE CabAlbCom;
     #77#3;
     ;
     "      ", #0#7, "     ", 000001;
     "zzzzzz", #0#8, "zzzzz", 999999;
     ;
     NULL, CabAlbCom;
|FIN;

|PROCESO Impo; |TIPO 0;
     aAlfa = #0#6;
     |C_M #0#9, 1, aAlfa;
     |C_M #0#10, 1, aAlfa;
|FPRC;

|PROCESO Cabe; |TIPO 0;
     aAlfa = #0#4;
     |C_M #0#7, 1, aAlfa;
     |C_M #0#8, 1, aAlfa;
|FPRC;

|PROCESO T3; |TIPO 3;
     aMail = #0#11; |QBF aMail;

     |SI #0#0 = "S";
          |SI #0#4 = "S";
               |ABRE #73;
               |BUCLE CabPedido;
               |CIERRA #73;
          |FINSI;
          |SI #0#5 = "S";
               |ABRE #104;
               |BUCLE LinPedido;
               |CIERRA #104;
          |FINSI;
          |SI #0#6 = "S";
               |BUCLE TotaPedido;
          |FINSI;
     |FINSI;

     |SI #0#1 = "S";
          |SI #0#4 = "S";
               |ABRE #71;
               |BUCLE CabAlbaran;
               |CIERRA #71;
          |FINSI;
          |SI #0#5 = "S";
               |ABRE #10;
               |BUCLE LinAlbaran;
               |CIERRA #10;
          |FINSI;
          |SI #0#6 = "S";
               |BUCLE TotaAlbaran;
          |FINSI;
     |FINSI;

     |SI #0#2 = "S";
          |SI #0#4 = "S";
               |ABRE #59;
               |BUCLE CabFactura;
               |CIERRA #59;
          |FINSI;
          |SI #0#5 = "S";
               |ABRE #134;
               |BUCLE LinFactura;
               |CIERRA #134;
          |FINSI;
          |SI #0#6 = "S";
               |BUCLE TotaFactura;
          |FINSI;
     |FINSI;

     |SI #0#3 = "S";
          |SI #0#4 = "S";
               |ABRE #80;
               |BUCLE CabAlbCom;
               |CIERRA #80;
          |FINSI;
          |SI #0#5 = "S";
               |ABRE #77;
               |BUCLE LinAlbCom
               |CIERRA #77;
          |FINSI;
          |SI #0#6 = "S";
               |BUCLE TotaAlbCom;
          |FINSI;
     |FINSI;

     |SI nInfor = 0; |PIEINF; |FININF; |FINSI;
     |SI nImpre = 0; |FINIMP; |FINSI;

     |SI aMail ! ""; |Y nHay ! 0;
          |HAZ EnviaMail;
     |FINSI;
|FPRC;

|PROGRAMA;
     |ABRE #0;
     |LEE 000#0p;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;
     |SI PARAMETRO = "menu";
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
          |SI FSalida = 0; |GRABA 020#0a; |FINSI;
     |SINO;
          aAlfa = #0#11; |QBF aAlfa;
          |SI aAlfa ! "";
               |HAZ T3;
          |FINSI;
     |FINSI;
     |CIERRA #0;
|FPRO;
