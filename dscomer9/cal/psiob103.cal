     AsignaPartidas

|FICHEROS;
     psioa001 #1;
     psioa005 #5;   ||Lineas
     agifa019 #19;
     dsm00024 #24;
     agifa324 #324;

     psioa005@;
     dsm00024@;
|FIN;

|VARIABLES;
     &eaTmp2 = "";
     &Tempo = "";
     aTmp24 = "";
     aPath = "";
     aAlfa = "";
     nLin = 0;
     nUni = 0;
     aSer = "";
     nDocu = 0;
     nLinDocu = 0;
     nBruto = 0;
     nSw = 0;
|FIN;

|PROCESO PartiBlanco;
     |ABRE #dsm00024@;
     #dsm00024@#0 = #psioa005@#4;
     #dsm00024@#1 = #psioa005@#11;
     #dsm00024@#2 = ""
     |LEE 000#dsm00024@.=;
     |SI FSalida ! 0; |GRABA 020#dsm00024@.n; |FINSI;
     |CIERRA #dsm00024@;

     |DDEFECTO #24;
     #24#0 = #psioa005@#4;
     #24#1 = #psioa005@#11;
     #24#2 = "";
     |LEE 000#24=;
     |SI FSalida ! 0; |GRABA 020#24n; |FINSI;
|FPRC;

|PROCESO TotalLin;
     nBruto = #psioa005@#6 * #psioa005@#7;          || base.
     nBruto = nBruto < #psioa005@#8;         || dto.
     nBruto = nBruto ! #324#7;
     #psioa005@#10 = nBruto;                || bruto.
|FPRC;

|PROCESO AsignaPartida;
     |SI #24#31 > 0;
          |SI #24#31 > nUni;
               #24#31 = #24#31 - nUni;

               #psioa005@#3 = nLin;
               #psioa005@#6 = nUni;
               #psioa005@#12 = #24#2;
               |HAZ TotalLin;

               nUni = 0;
               |GRABA 020#psioa005@.n;
          |SINO;
               nUni = nUni - #24#31;

               #psioa005@#3 = nLin;
               #psioa005@#6 = #24#31;
               #psioa005@#12 = #24#2;
               |HAZ TotalLin;

               #24#31 = 0;
               |GRABA 020#psioa005@.n;
               nLin = nLin + 1;
          |FINSI;
          |GRABA 020#24a;
     |FINSI;

     |SI nUni = 0; |ERROR10; |FINSI;
|FPRC;

|DEFBUCLE AsignaPartida;
     #24#1;
     ;
     #5#4, #5#11, "                              ";
     #5#4, #5#11, "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
     be;
     NULL, NULL, NULL, NULL, NULL, AsignaPartida;
     #24#27;
|FIN;

|PROCESO CargaPartidas;
     |SALVA_DATOS #dsm00024@;
     |REPON_DATOS #24;
     |GRABA 000#24n;
|FPRC;

|DEFBUCLE CargaPartidas;
     #dsm00024@#1003;
     ;
     #5#4, #5#11, "                              ";
     #5#4, #5#11, "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
     ;
     NULL, CargaPartidas;
|FIN;

|PROCESO UltLin;
     #psioa005@#0 = #5#0;
     #psioa005@#1 = #5#1;
     #psioa005@#2 = #5#2;
     #psioa005@#3 = 999;
     |LEE 000#psioa005@.];
     |SI FSalida = 0;
          |LEE 000#psioa005@.a;
     |SINO;
          |LEE 000#psioa005@.u;
     |FINSI;
     |SI FSalida = 0;
               |Y #5#0 = #psioa005@#0;
               |Y #5#1 = #psioa005@#1;
               |Y #5#2 = #psioa005@#2
          nLin = #psioa005@#3 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
|FPRC;

|PROCESO CreaLineas;
     #19#0 = #5#4;
     |LEE 000#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;
     |HAZ UltLin;
     |SALVA_DATOS #5;
     |REPON_DATOS #psioa005@;

     nSw = 0
     |SI #psioa005@#0 = "A"; |O #psioa005@#0 = "F";
          #psioa005@#3 = nLin;
          nSw = 1;
     |FINSI;

     |SI #19#180 = "S"; |Y nSw = 1;
          #5#11 = #1#70;
          #psioa005@#11 = #1#70;

          nUni = #5#6;
          |BUCLE CargaPartidas;
          |BUCLE AsignaPartida;
          |SI nUni > 0;
               #psioa005@#3 = nLin;
               #psioa005@#6 = nUni;
               #psioa005@#11 = #1#70;
               #psioa005@#12 = "";
               |HAZ TotalLin;
               |GRABA 020#psioa005@.n;
               |HAZ PartiBlanco;
          |FINSI;
     |SINO;
          |GRABA 020#psioa005@.n;
     |FINSI;
|FPRC;

|DEFBUCLE CreaLineas;
     #5#1;
     ;
     " ", "     ", 000001, 001;
     "z", "zzzzz", 999999, 999;
     ;
     NULL, CreaLineas;
|FIN;

|PROCESO BorraLineas;
     #psioa005@#0 = #5#0;
     #psioa005@#1 = #5#1;
     #psioa005@#2 = #5#2;
     #psioa005@#3 = 1;
     |LEE 101#psioa005@.];
     |PARA; |SI FSalida = 0;
               |Y #5#0 = #psioa005@#0;
               |Y #5#1 = #psioa005@#1;
               |Y #5#2 = #psioa005@#2; |HACIENDO;
          |BORRA 020#psioa005@.a;
          |LIBERA #psioa005@;
          |LEE 101#psioa005@.s;
     |SIGUE;
     |LIBERA #psioa005@;
|FPRC;

|DEFBUCLE BorraLineas;
     #5#1;
     ;
     " ", "     ", 000001, 001;
     "z", "zzzzz", 999999, 999;
     ;
     NULL, BorraLineas;
|FIN;

|PROCESO AsignaPartidas;
     |DDEF aPath;
     aAlfa = aPath + "psioa005";
     |CARGA_DEF aAlfa, psioa005@;
     |SI FSalida = 0;
          aAlfa = aPath + "dsm00024";
          |CARGA_DEF aAlfa, dsm00024@;
          |SI FSalida = 0;
               |HAZ CreaTempo; |NOME_DAT #24#Tempo#; |DELINDEX #24; aTmp24 = Tempo;
               |ABRE #24;

               |ABRE #psioa005@;
               |ABRE #19;
               |BUCLE BorraLineas;
               |BUCLE CreaLineas;
               |CIERRA #19;
               |CIERRA #psioa005@;

               |CIERRA #24;
               Tempo = aTmp24; |HAZ BoraTempo; |DELINDEX #24;
               |DESCARGA_DEF #dsm00024@;
          |FINSI;
          |DESCARGA_DEF #psioa005@;
     |FINSI;
|FPRC;
