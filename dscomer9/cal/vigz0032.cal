|FICHEROS;
     vigz0032 #0;
     vigm0027 #27; ||Viajes
     agifa104 #1;
     agifa073 #2;
     agifa024 #3;
     agifa038 #13;
     agifa048 #15;
     agifa049 #16;
     agifa007 #40;
     agifa142 #41;
     dsm00010 #910;
     dsm00053 #53;
     dsm00046 #46;
     &marhu355@ #100;
     agifa010 #55;
     :/agitool/def/dsfax001 #101;
|FIN;

|VARIABLES;
     &eaFicTmpCab = "";
     &eaFicTmpLin = "";
     nImpreso = 0;
   {1}aContiene = "";
   {1}aLocal = "";
     aFic = "";
     aAdjunto = "";
     aBaseLocal = "";
     aVersion1 = "";
     aVersion2 = "";
     aSalida = "";
     aFrom = "";
     aTo = "";
     aAsunto = "";
     aMensaje = "";
     aEmail = "";
     aNomFic = "";
     aBase = "";
     aPathEnvios = "";
     aOrigen = "";
     aDestino = "";
     aIPRemoto = "";
     aAlfa = "";
     aNumFax = "";
     aNumMail = "";
     aInforme = "";
     &enSwAnna = 0;
     nSwFax = 0;
     nSwMail = 0;
     &eaImpresora = "";
     &eaDefImpre = "";
     &eaFicImpre = "";
     &enPideImpre = 0;
     aDRei        = "";
     aHRei        = "";
     &eaCli       = "";
     &enTiva      = 0;
     &enIva       = 0;
     &enRec       = 0;
     &efFiva = @;

     &aMoneda     = "";
     &aDivisa     = "";
     &enEscan     = 0;
     &enImpo      = 0;
     &enSwImpre   = 0;
     aParam      = "";
     &eaTipo      = "";
     &eaSerie     = "";
     &enCodig     = 0;
     &enLinea     = 0;
     &eaArticulo  = "";
     &eaNArticulo = "";
     &enUnidades  = 0;
     &enPrecio    = 0;
     &enDto1      = 0;
     &enDto2      = 0;
     &enPantalla  = 0;
     &efFEntrega  = @;

     nSwPasa      = 0;

     indtope = 0;
     ind = 0;
     n_copia  = 0;
     informe   = "";
     &informe1 = "";
     &cant = 0;
     &tolin = 0;
     &iva1 = 0;
     &iva2 = 0;
     &iva3 = 0;
     &iva4 = 0;
     &iva5 = 0;
     &re1 = 0;
     &re2 = 0;
     &re3 = 0;
     &re4 = 0;
     &re5 = 0;
     &descrip="";
     &linea=0;
     vacio="";
     &bl  = "                              ";
     &ser_ped  = "";
     &num_ped  = 0;
     &unid     = 0;
     &codigo   = "";
     &descri   = "";
     &dto      = 0;
     &precio   = 0;
     &imptot   = 0;
     &tiva     = 0;

     &enSwLin  = 0;
     &eaDoc = "";
     nSwPackList = 0;
|FIN;

|PROCESO CargaFax;
     |SI nImpreso = 0; |ACABA; |FINSI;
     |FINIMP;
     aDestino = "c:\dswinfax\" + aNomFic;
     |SI nSwFax = 1;
          |DBASS aAlfa; |QBF aAlfa;
          aAlfa = aAlfa + "/agitool/fich/";
          |PATH_DAT #100 aAlfa;
          |ABRE #100;
          |LEE 101#100p;
          |SI FSalida ! 0; |ACABA; |FINSI;
          #100#3 = #3#2;          || destinatario
          #100#4 = aNumFax;       || nro. de fax destino
          #100#7 = aNomFic;       || doc
          #100#10 = #100#10 + 1;  || contador
          #100#11 = aDestino;     || fichero
          |GRABA 020#100a;
          |CIERRA #100;
          |SUB_EJECUTA ":agitool/dsfax001;AUTO";
     |FINSI;
     |SI nSwMail = 1;         ||EMAIL
          ||TODO CCC es un DSCORREO de la propia maquina
          |HAZ MandaCorreo;
     |FINSI;
|FPRC;

|PROCESO MandaCorreo;
||Paso el adjunto (PDF) al servidor.
     |DBASE aBase; |QBF aBase;
     aPathEnvios = aBase + "envios/";
     |MKDIR aPathEnvios;
     aOrigen = aDestino;
     aDestino = aPathEnvios + aNomFic;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
          |RECIBE_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
     aAdjunto = aDestino;

     |ESPECIFICA "RBASS", aLocal;
     aBaseLocal = aLocal;

     aDestino   = aBaseLocal + "bin/dscorreo.exe";
     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aVersion1  = FSalida;  |QBF aVersion1;

     |DBASE aBase;  |QBF aBase;
     aOrigen    = aBase + "plugins/dscorreo.exe";
     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aVersion2  = FSalida;  |QBF aVersion2;

     |SI aVersion1 ! aVersion2;
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aAlfa  = "start " + aDestino;
     |RSYSTEM aAlfa;
     |MENSA "         ";
     |PULSATECLA;
     |SLEEP 1;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     aSalida  = "MAPI";
     aFrom    = "MAPI";
     aTo      = aEmail;  |QBF aTo;
     aAsunto  = "Pedido de Venta " + aNomFic;
     aAsunto = aAsunto - ".pdf";
     |QBF aAsunto;
     aMensaje = aAsunto;

     |DSCORREO_ENVIA aIPRemoto, aSalida, aFrom, aTo, aAsunto, aMensaje, aAdjunto;
     |SI FSalida < 0;
         |MENAV "0000 Ha habido un error durante el envio.";
     |SINO;
         |MENAV "0000 El correo se encuentra en la Bandeja de Salida de su Gestor de Correos. Envielo desde alli.";
     |FINSI;

     |FBORRA aAdjunto;
|FPRC;

|PROCESO escanlinea;
     unid    = #16#4 * #2#5;
     descrip = #16#3;
     linea   = 1;
     |PRINT;
|FPRC;

|PROCESO xx;
     indtope=0
     |PARA ind=6;|SI ind>0;|HACIENDO ind=ind-1;
           descrip = #13ind;  |QBF descrip;
           |SI descrip ! vacio;
               indtope = ind + 1;
               ind     = 0;
           |FINSI;
     |SIGUE;

     |PARA ind = 1; |SI ind <i ndtope; |HACIENDO ind = ind + 1;
           descrip = #13ind;
           linea   = 0;
           |PRINT;
     |SIGUE;
|FPRC;

|PROCESO impdesam;|TIPO 0;
     |ABRE #13;
     #13#0=#2#27;
     |LEE 121#13=;
     |SI FSalida = 0;  |HAZ xx;  |FINSI;
     |LIBERA #13;
     |CIERRA #13;
|FPRC;

|PROCESO DesAmpli;
     |DDEFECTO #2;
     #2#3 = 0;      || Almacen
     #2#4 = #53#5;
     descrip = #2#4;
     |PRINT;
|FPRC;

|DEFBUCLE DesAmpli;
     #53#1;
     ;
     "P", #2#28, #2#0, #2#1, 0001;
     "P", #2#28, #2#0, #2#1, 9999;
     ;
     NULL, DesAmpli;
|FIN;

|PROCESO dsm00046;
     unid = #2#5 * #46#5;
     |PRINT;
|FPRC;

|DEFBUCLE dsm00046;
     #46#1;
     ;
     #2#28, #2#0, #2#1, 001;
     #2#28, #2#0, #2#1, 999;
     ;
     NULL, dsm00046;
|FIN;

|PROCESO ImpreNormal;
     tolin   = #2#5 * #2#6;
     tolin   = tolin < #2#8;
     cant    = cant + tolin;
     descrip = #2#4;
     linea   = 1;
     unid    = #2#5;
     codigo  = #2#2;
     |PRINT;

     |SALVA_DATOS #2;
     |BUCLE DesAmpli;
     |REPON_DATOS #2;

     |HAZ impdesam;
     |SI #41#16 = "S";
          eaArticulo = #2#2;
          |HAZ EsEscandallo;
          |SI FSalida = 0;
               |HAZ EsKit;
               |SI FSalida = 0;
                    enEscan = 2;
                    |BUCLE dsm00046;
               |SINO;
                    enEscan = 1;
                    |BUCLELIN 0escanlinea#15;
               |FINSI;
               enEscan = 0;
          |FINSI;
          |CIERRA #15;
     |FINSI;
|FPRC;

|PROCESO pedimprl;|TIPO 0;
     |SI #2#13 < #0#9;  |O #2#13 > #0#10;  |ACABA;  |FINSI;

     nSwPasa = 1;

     |HAZ ImpreNormal;
|FPRC;

|PROCESO IVAS;
     eaCli = #1#4;
     efFiva = #1#1;
     enTiva = 1; |HAZ IVACli; iva1 = enIva; re1 = enRec;
     enTiva = 2; |HAZ IVACli; iva1 = enIva; re1 = enRec;
     enTiva = 3; |HAZ IVACli; iva1 = enIva; re1 = enRec;
     enTiva = 4; |HAZ IVACli; iva1 = enIva; re1 = enRec;
     enTiva = 5; |HAZ IVACli; iva1 = enIva; re1 = enRec;
|FPRC;

|PROCESO pedimpr1;
     |LIBERA #1;
     |DDEFECTO #1;
     #1#25 = #27#0;
     #1#0 = #27#1;
     |LEE 101#1=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |SI nSwPackList = 0;
          eaDoc = "PV" + #1#25 + #1#0;
          |HAZ PackListVar;
     |FINSI;

     |HAZ IVAS;

     aMoneda = #agifa104#37;
     aDivisa = #agifa104#35;
     |HAZ Divisas104;

     |DDEFECTO #3;
     #3#0 = #1#4;
     |LEE 040#3=;
     aNumFax = #3#18; |QBF aNumFax;
     aNumMail = #3#197; |QBF aNumMail;
     |SI nSwFax = 1; |Y aNumFax = "";
          aAlfa = "0000No se ha indicado Numero de Fax en la ficha del Cliente:" + #3#0;
          |MENAV aAlfa;
          |ACABA;
     |FINSI;
     |SI nSwMail = 1; |Y aNumMail = "";
          aAlfa = "0000No se ha indicado Numero de Email en la ficha del Cliente: " + #3#0;
          |MENAV aAlfa;
          |ACABA;
     |FINSI;
     |SI nSwFax = 1; |O nSwMail = 1;
          aNomFic = #1#25 +(("000000"+#1#0)%-106)+".pdf";|QBT aNomFic;
          |DBASS aFic;

          aFic = "c:\dswinfax\" + aNomFic;
          Impresora = "CrystalReport;" + aFic;
          |IMPRE -1;
          |SI FSalida ! 0; |ERROR; |ACABA; |FINSI;
     |FINSI;

     |ABRE #40;
     #40#26 = #1#25;
     |LEE 001#40=;
     |SI FSalida ! 0;  |DDEFECTO #40;  |FINSI;
     |CIERRA #40;

     |SI aInforme = "";
          informe = #40#0; |QBF informe;
          aInforme = informe;
     |SINO;
          informe = aInforme;
     |FINSI;
     informe1 = (informe % 0104) + "5" + (informe % 0603); |QBF informe1;

     |INFOR aInforme;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |PARA n_copia = 0; |SI n_copia [ #3#188; |HACIENDO n_copia = n_copia + 1;
          nSwPasa = 0;

          |BUCLELIN 2pedimprl#1;

          |SI nSwPasa = 1;  |PIEINF;  |FINSI;
          enSwImpre = 0;
          cant = 0;
          tolin = 0;
     |SIGUE;
     |FININF;
     #1#58 = "S";
     |GRABA 020#1a;

     nImpreso = 1;
|FPRC;

|DEFBUCLE SoloUno;
     #27#1;
     ;
     #0#6 , #0#2;
     #0#7 , #0#3;
     e;
     NULL, pedimpr1;
|FIN;

|DEFBUCLE PorViaje;
     #27#3;
     ;
     #0#4, #0#6, #0#2, #0#9, #0#0;
     #0#5, #0#7, #0#3, #0#10, #0#1;
     e;
     NULL, pedimpr1;
|FIN;

|DEFBUCLE PorCliente;
     #27#2;
     ;
     #0#0, #0#6, #0#2, #0#4, #0#9;
     #0#1, #0#7, #0#3, #0#5, #0#10;
     be;
     NULL, pedimpr1;
|FIN;

|PROCESO PideImpresora;
     |QBF eaImpresora;        || No pide
     |QBF eaFicImpre;         || a un fichero
     |QBF eaDefImpre;         || la por defecto
     || enPideImpre  (solo pide la impresora la primera vez)

     |SI eaFicImpre ! "";
          Impresora = eaFicImpre;
          |IMPRE -77;
     |SINO;
          |SI eaImpresora = "";
               |SI eaDefImpre = "";
                    |IMPRE 1;
                    |SI enPideImpre = 1;||carga la variable para que no la pida a la siguiente
                        eaImpresora = Impresora;
                        |SI FSalida ! 0;eaImpresora = "***";|FINSI;||ninguna
                    |FINSI;
               |SINO;
                    Impresora = eaDefImpre;
                    |IMPRE 0;
               |FINSI;
          |SINO;
               Impresora = eaImpresora;
               |IMPRE -1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo3;

     |SI nSwFax = 0; |Y nSwMail = 0;
          |HAZ PideImpresora;
          |SI FSalida ! 0;  |ACABA;  |FINSI;
     |FINSI;

     |ABRE #3;
     |ABRE #1;
     |SI ser_ped = ""; |Y num_ped = 0;
         |SI #0#8 = "C";
             |BUCLE PorCliente;
         |SINO;
             |BUCLE PorViaje;
         |FINSI;
     |SINO;
         |BUCLE SoloUno;
     |FINSI;
     |CIERRA #1;
     |CIERRA #3;

     |SI nSwFax = 0; |Y nSwMail = 0;
          |FINIMP;
     |SINO;
          |HAZ CargaFax;
     |FINSI;
|FPRC;

|PROGRAMA;
     |SI eaFicTmpCab ! ""; |NOME_DAT #agifa104#eaFicTmpCab#; |FINSI;
     |SI eaFicTmpLin ! ""; |NOME_DAT #agifa073#eaFicTmpLin#; |FINSI;

     aParam = PARAMETRO; |QBF aParam;
     |SI aParam = "ANNA";
          enSwAnna = 1; aParam = "";
     |FINSI;
     |SI aParam = "FAX";
          nSwFax = 1; aParam = "";
     |FINSI;
     |SI aParam = "EMAIL";
          nSwMail = 1; aParam = "";
     |FINSI;
     aInforme = aParam;
     /*----*/

     |HAZ MiraLogos; || Copia Logos para el Crystal

     enPantalla  = 0;

     |ABRE #41; |LEE 000#41p; |CIERRA #41;
     |ABRE #910; |LEE 000#910p; |CIERRA #910;

     |SI ser_ped = ""; |Y num_ped = 0;
         eaImpresora = "";
         |CLS;
         |CABEZA "Imp.Pedidos";
         |DDEFECTO #0;
         |PINPA #0#0;
         |PINDA #0#0;
         |ENDATOS #1#0;
         |SI FSalida = 0;  |HAZ Tipo3;  |FINSI;
     |SINO;
         |SI eaImpresora = "***"; |ACABA; |FINSI;
         #0#6 = ser_ped;
         #0#7 = ser_ped;
         #0#2 = num_ped;
         #0#3 = num_ped;
         #0#4 = "01.01.0000";
         #0#5 = "31.12.9999";
         #0#9 = "01.01.0000";
         #0#10 = "31.12.9999";
         |HAZ Tipo3;
     |FINSI;
|FPRO;
