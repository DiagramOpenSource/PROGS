|FICHEROS;
     con00625 #0;
     con00626 #1;
     con00627 #2;
     con00628 #3,MANTE;
     con00629 #4,MANTE;
     con00630 #5,MANTE;
     con00631 #6,MANTE;
     agifa017 #9; || STOCK POR ALMACENES
     agifa019 #11;
     agifa065 #12;
     agifa007 #70;
     agifa071 #71;
     dsm00248 #143;
     dsm00247 #141;
     con00004 #400;
     con00683 #683;
     agifa142;
     agifa019@;
     agifa024 #24;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     nUni = 0;
     nCos = 0;
     nVta = 0;
     nSwCanon = 0;
     nSeccion = 0;
     &enLinCanon = 0;
     &eaMenErr = "";
     aAlfa = "";
     &enTotal = 0;
     &eaCodCliente = "";
     &eaNomCliente = "";
     &eaTag = "";
     &nRieUtili = 0;
     &nRieTotal = 0;
     &enLineaRie = 0;
     nConAu = 0;
     aUs = "";
     nModo = 0;
     nForma = 0;
     &EURODB = 0;
     modo_ent = 0;
     mod = 0;
     serie_orig = "";
     parte_orig = "";
     linea_orig = 0;
     mes = 0;
     fmes = "  ";
     mes_margen = 0;
     mes_importe = 0;
     &opcion = 0;
|FIN;


|PROCESO tipo7; |TIPO 7;
|FPRC;

|PROCESO m_obra;
|SI mod = -1;
|DDEFECTO #4;
#4#9 = #1#10;
|PUSHV 0501 2380;
     #4#0 = #1#2;
     #4#1 = #1#3;
     #4#2 = #1#4;
     #4#3 = #1#13;
     #4#4 = #1#5;
     #4#6 = #1#6;
     #4#7 = #1#7;
     #4#8 = #1#8;
     #4#9 = #1#10;
     #4#12 = #1#14;
     #4#13 = #1#21;
     #4#14 = #1#22;
     #4#15 = #1#23;
     #4#16 = 1;
     #4#17 = #1#0;
|PINPA #0#4;
|PINDA #0#4;
|ENDATOS #2#4;
|SI FSalida = 0;
     #1#2 = #4#0;
     #1#3 = #4#1;
     #1#4 = #4#2;
     #1#5 = #4#4;
     #1#6 = #4#6;
     #1#7 = #4#7;
     #1#8 = #4#8;
     #1#10 = #4#9;
     #1#9 = 1;
     #1#13 = #4#3;
     #1#14 = #4#12;
     #1#21 = #4#13;
     #1#22 = #4#14;
     #1#23 = #4#15;
|FINSI;
|POPV;
|FINSI;
|FPRC;


|PROCESO s_ext;
|SI mod = -1;
|DDEFECTO #3;
#3#7 = #1#10;
#3#0 = #1#2;

#3#1 = #1#3;
#3#2 = #1#4;
#3#3 = #1#5;
#3#4 = #1#6;
#3#5 = #1#7;
#3#6 = #1#8;
#3#7 = #1#10;
#3#11 = #1#14;
#3#12 = #1#16;
#3#13 = #1#18;
#3#14 = #1#22;
#3#15 = #1#23;
#3#16 = 3;
#3#17 = #1#0;
|PUSHV 0501 2380;
|PINPA #0#3;
|PINDA #0#3;
|ENDATOS #2#3;
|SI FSalida = 0;
       #1#2 = #3#0;
       #1#3 = #3#1;
       #1#4 = #3#2;
       #1#5 = #3#3;
       #1#6 = #3#4;
       #1#7 = #3#5;
       #1#8 = #3#6;
       #1#10 = #3#7;
       #1#14 = #3#11;
       #1#16 = #3#12;
       #1#18 = #3#13;
       #1#22 = #3#14;
       #1#23 = #3#15;
|FINSI;
|POPV;
|FINSI;
|FPRC;

|PROCESO artic;
|SI mod = -1;
|DDEFECTO #5;
#5#8 = #1#10;
#5#0 = #1#2;
#5#1 = #1#3;
#5#2 = #1#4;
#5#3 = #1#5;
#5#5 = #1#6;
#5#6 = #1#7;
#5#7 = #1#8;
#5#11 = #1#14;
#5#12 = #1#15;
#5#13 = #1#16;
#5#14 = #1#17;
#5#15 = #1#18;
#5#16 = #1#19;
#5#17 = #1#22;
#5#18 = #1#23;
#5#19 = 2;
#5#20 = #1#0;
|PUSHV 0501 2380;
|PINPA #0#5;
|PINDA #0#5;
|ENDATOS #2#5;
|SI FSalida = 0;
     #1#2 = #5#0;
     #1#3 = #5#1;
     #1#4 = #5#2;
     #1#5 = #5#3;
     #1#6 = #5#5;
     #1#7 = #5#6;
     #1#8 = #5#7;
     #1#10 = #5#8
     #1#14 = #5#11;
     #1#15 = #5#12;
     #1#16 = #5#13;
     #1#17 = #5#14;
     #1#18 = #5#15;
     #1#19 = #5#16;
     #1#22 = #5#17;
     #1#23 = #5#18;
     |HAZ ModiArti;
|FINSI;
|POPV;
|FINSI;

|FPRC;



|PROCESO lubri;
|SI mod = -1;
|DDEFECTO #6;
#6#8 = #1#10;

     #6#0 = #1#2;
     #6#1 = #1#3;
     #6#2 = #1#4;
     #6#3 = #1#5;
     #6#5 = #1#6;
     #6#6 = #1#7;
     #6#7 = #1#8;
     #6#8 = #1#10;
     #6#11 = #1#14;
     #6#12 = #1#15;
     #6#13 = #1#16;
     #6#14 = #1#17;
     #6#15 = #1#18;
     #6#16 = #1#19;
     #6#17 = #1#22;
     #6#18 = #1#23;
     #6#19 = 4;
     #6#20 = #1#0;
|PUSHV 0501 2380;
|PINPA #0#6;
|PINDA #0#6;
|ENDATOS #2#6;
|SI FSalida = 0;
     #1#2 = #6#0;
     #1#3 = #6#1;
     #1#4 = #6#2;
     #1#5 = #6#3;
     #1#6 = #6#5;
     #1#7 = #6#6;
     #1#8 = #6#7;
     #1#10 = #6#8;
     #1#14 = #6#11;
     #1#15 = #6#12;
     #1#16 = #6#13;
     #1#17 = #6#14;
     #1#18 = #6#15;
     #1#19 = #6#16;
     #1#22 = #6#17;
     #1#23 = #6#18;
     |HAZ ModiLubri;
|FINSI;
|POPV;
|FINSI;

|FPRC;


|PROCESO mod_lin;
     eaMenErr = "";
     |SI #1#26 ! 0; |Y #1#27 ! 0;
          eaMenErr = "0000No se puede modificar. Modifique el albaran:";
          eaMenErr = eaMenErr + #1#25 + "/" + (("000000"+#1#26)%-106)+"/"+(("000"+#1#27)%-103);
     |FINSI;
     |SI #1#11 ] 1; |Y #1#11 [ 999; |HAZ m_obra; |FINSI;
     |SI #1#11 ] 1000; |Y #1#11 [ 1999; |HAZ artic; |FINSI;
     |SI #1#11 ] 2000; |Y #1#11 [ 2999; |HAZ s_ext; |FINSI;
     |SI #1#11 ] 3000; |Y #1#11 [ 3999; |HAZ lubri; |FINSI;
     eaMenErr = "";
     |HAZ ModiSeccion;
|FPRC;

|PROCESO borr_lin;
|HAZ baja_histo;
|BORRA 000#1a;
|LIBERA #1;
|FPRC;


|DEFBUCLE baja_lin;
#1#1;
12;
serie_orig , parte_orig ,   1  , linea_orig;
serie_orig , parte_orig , 9999 , linea_orig;
be;
NULL, borr_lin;
|FIN;


|PROCESO mov_historico;
     |SI #683#36 = "N"; |Y #1#26 ! 0; || OR de albaran
          |ABRE #11;
          #11#0 = #1#2;
          |LEE 020#11=;
          |SI FSalida = 0;
               |HAZ HistoAlb;
          |FINSI;
          |CIERRA #11;
     |SINO;
          |SI modo_ent = 1;
               |HAZ alta_histo;
          |FINSI;
          |SI modo_ent = 2;
               |SI mod < 0;
                    |HAZ baja_histo;
               |SINO;
                   |HAZ alta_histo;
               |FINSI;
          |FINSI;
          |SI modo_ent = 3;
               |HAZ baja_histo;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ActCanon;
     |SI #1#34 ! 0;
          |DDEF aAlfa;
          aAlfa = aAlfa + "agifa019";
          |CARGA_DEF aAlfa, agifa019@;
          |SI FSalida = 0;
               |DBASE aAlfa;
               aAlfa = aAlfa + "fich/" + (("00000" + #1#34)% -105) + "/";
               |PATH_DAT #agifa019@#aAlfa#;
               |ABRE #agifa019@;
               #agifa019@#0 = #1#2;
               |LEE 000#agifa019@.=;
               |SI FSalida = 0; |Y #agifa019@#168 ! 0;
                    |ABRE #11;
                    #11#0 = #1#2;
                    |LEE 101#11=;
                    |SI FSalida = 0; |Y #11#168 = 0;
                         #11#168 = #agifa019@#168;
                         |GRABA 020#11a;
                    |FINSI;
                    |CIERRA #11;
               |FINSI;
               |CIERRA #agifa019@;
               |DESCARGA_DEF #agifa019@;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO tip_2; |TIPO 2;
     modo_ent = (FEntrada/100)!0;
     mod = 0 +. 1;

     |SI mod = -1; |O modo_ent = 1; enLinCanon = 0; |FINSI;

     |ABRE #683; |LEE 000#683p; |CIERRA #683;

     |SI modo_ent = 3;
          |SI #1#26 ! 0; |Y #1#27 ! 0;
               aAlfa = "0000No se puede borrar. Modifique el albaran:";
               aAlfa = aAlfa + #1#25 + "/" + (("000000"+#1#26)%-106)+"/"+(("000"+#1#27)%-103);
               |SI mod = -1; |MENAV aAlfa; |FINSI;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;
     |SI #1#36 ! 0;
          |SI mod = -1;
               aAlfa = "0000Linea facturada en factura:" + #1#35 + "/" + (("000000"+#1#36)%-106);
               |MENAV aAlfa;
          |FINSI;
          |ERROR; |ACABA;
     |FINSI;

     |SI #1#28 = -1;
          |SI mod = -1;
               |MENAV "0000Linea canon de articulo, no se puede modificar";
          |FINSI;
          |ERROR; |ACABA;
     |FINSI;
     |SI modo_ent = 2; |O modo_ent = 3;
          |SI #1#38 = "A";
               |ABRE #24;
               #24#0 = #0#11;
               |LEE 101#24=;
               |SI FSalida = 0;
                    #24#50 = #24#50 + (#1#8 * mod);
                    |GRABA 020#24a;
               |FINSI;
               |CIERRA #24;
          |FINSI;

          |SI #1#9 = 2; |O #1#9 = 4;
                |HAZ mov_historico;
          |FINSI;

     |FINSI;
     |SI modo_ent = 1; |ERROR; |FINSI;
     |SI modo_ent = 2;
          |SI mod < 0; |HAZ ActCanon; |FINSI;
          |HAZ mod_lin;
          |SI mod = 1;
               enLineaRie = #1#11;
               enTotal = 0;
               |HAZ CalculaTotalRef;
               |HAZ CalculaTotal0;
               enErrRie = 0;
               eaCodCliente = #0#11;
               eaNomCliente = #0#19;
               eaTag = "";  |HAZ SacaRiesgo;
               |SI eaRieSuma = "S"; nRieUtili = nRieUtili + enTotal; |FINSI;
               |SI #agifa142#6 = "S";
                    eaDocu = "L";
                    eaTipo = "A";
                    enImpoDoc = 0;
                    |HAZ ControlRiesgo;
                    |SI enErrRie = 1; |ERROR; |ACABA; |FINSI;
                    |SI enAudito = 0;
                         |ABRE #143;
                         |LEE 000#143u;
                         |SI FSalida = 0;
                              nConAu = #143#0 + 1;
                         |SINO;
                              nConAu = 1;
                         |FINSI;
                         |DDEFECTO #143;
                         #143#0 = nConAu;          || contador
                         #143#12 = "ORDEN";      || tipo documento
                         #143#1 = #0#0;           || serie
                         #143#2 = #0#1;            || documento
                         #143#3 = #0#2;            || fecha
                         #143#4 = #0#11;           || cliente
                         #143#5 = #0#19;           || nombre
                         #143#6 = Usuario % 810;   || usuario
                         #143#7 = nRieTotal;       || riesto concedido
                         #143#8 = nRieUtili;       || riesgo actual
                         #143#9 = #141#2;           || % exceso
                         #143#10= #141#3;           || importe % exceso
                         #143#11= #141#4;           || limite exceso
                         |GRABA 020#143n;
                         |CIERRA #143;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI modo_ent = 3;
          serie_orig = #1#0;
          parte_orig = #1#1;
          linea_orig = #1#11;
          |CIERRAT #1;
          |BUCLE baja_lin;
          |ABRET #1;
          #1#0 = serie_orig;
          #1#1 = parte_orig;
          #1#11 = linea_orig;
          |LEE 121#1=;

          |SI #1#28 ! 0;
               |HAZ BajaCanon;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ModiArti;
     |SALVA_FICHA #1;

     nSeccion = #1#23;

     |ABRE #11;
     |DDEFECTO #11;
     #11#0 = #1#2;
     |LEE 020#11=;
     |CIERRA #11;

     enLinCanon = 0;
     nSwCanon = 0;

     #1#0 = #0#0;
     #1#1 = #0#1;
     #1#9 = 5;
     #1#11 = #1#28;
     |LEE 101#1=;
     |SI FSalida = 0;
          |SI #11#168 = 0;
               nSwCanon = 1;
               enLinCanon = 0;
               |BORRA 020#1a;
               |HAZ baja_histo;
          |SINO;
               enLinCanon = #1#11;
               #1#2 = "xxxxx";
               #1#3 = "CANON " + #5#1;
               #1#4 = #5#2;
               #1#5 = #11#168;
               #1#6 = 0;
               #1#7 = 0;
               #1#8 = #1#4  * #1#5;
               #1#9 = 5;
               #1#10 = #5#8
               #1#14 = #5#11;
               #1#23 = nSeccion;
               #1#28 = -1;
               #1#29 = #11#30;
               |GRABA 020#1a;
          |FINSI;
     |SINO;
          |HAZ CanonArticulo;
     |FINSI;
     |SI nSwCanon = 1; |O enLinCanon ! 0;
          |PONCONTROL 23, "SI";
          |PTEC 808; |PTEC 809; |PTEC 808;
     |FINSI;
     |REPON_FICHA #1;
     #1#28 = enLinCanon;
|FPRC;

|PROCESO ModiLubri;
     |SALVA_FICHA #1;

     nSeccion = #1#23;

     |ABRE #11;
     |DDEFECTO #11;
     #11#0 = #1#2;
     |LEE 020#11=;
     |CIERRA #11;

     #1#0 = #0#0;
     #1#1 = #0#1;
     #1#9 = 5;
     #1#11 = #1#28;
     |LEE 101#1=;
     |SI FSalida = 0;
          |SI #11#168 = 0;
               enLinCanon = 0;
               |BORRA 020#1a;
               |HAZ baja_histo;
          |SINO;
               enLinCanon = #1#11;
               #1#2 = "xxxxx";
               #1#3 = "CANON " + #6#1;
               #1#4 = #6#2;
               #1#5 = #11#168;
               #1#6 = 0;
               #1#7 = 0;
               #1#8 = #1#4  * #1#5;
               #1#9 = 5;
               #1#10 = #6#8
               #1#14 = #6#11;
               #1#23 = nSeccion;
               #1#28 = -1;
               #1#29 = #11#30;
               |GRABA 020#1a;
          |FINSI;
     |SINO;
          |HAZ CanonLubri;
     |FINSI;
     |PONCONTROL 23, "SI";
     |PTEC 808; |PTEC 809; |PTEC 808;

     |REPON_FICHA #1;
     #1#28 = enLinCanon;
|FPRC;

|PROCESO BajaCanon;
     |SALVA_FICHA #1;

     #1#0 = #0#0;
     #1#1 = #0#1;
     #1#9 = 5;
     #1#11 = #1#28;
     |LEE 101#1=;
     |SI FSalida = 0;
          |BORRA 020#1a;
          |HAZ baja_histo;
          |PONCONTROL 23, "SI";
          |PTEC 809; |PTEC 808;
     |FINSI;

     |REPON_FICHA #1;
|FPRC,

|PROCESO ModiSeccion;
     |ABRE #683; |LEE 000#683p; |CIERRA #683;
     |DFICE aAlfa;
     aAlfa = aAlfa % -205;
     |SI aAlfa = #683#2; |O aAlfa = #683#7; |O aAlfa = #683#8;
          |ABRE #400;
          #400#0 = #1#25;
          #400#1 = #1#26;
          #400#2 = #1#27;
          |LEE 101#400=;
          |SI FSalida = 0;
               #400#3 = #1#23;
               |GRABA 020#400a;
          |FINSI;
          |CIERRA #400;
     |FINSI;
|FPRC;

|PROCESO HistoAlb;
     |ABRE #71;
     #71#29 = #1#25;
     #71#0 = #1#26;
     #71#1 = #1#27;
     |LEE 000#71=;
     |SI FSalida ! 0; |DDEFECTO #71; |FINSI;
     |CIERRA #71;

     nUni = #1#4 - #71#5;
     |SI nUni = 0; |ACABA; |FINSI;

     nUni = nUni * mod;
     nVta = (nUni * #1#5) * mod;
     nCos = (#1#17 / #1#4 * nUni) * mod;

     |ABRE #70;
     #70#26 = #1#0;
     |LEE 000#70=;
     |CIERRA #70;

     |ABRE #9;
     |DDEFECTO #9;
     #9#0 = #1#2;
     #9#2 = #70#29;
     |LEE 101#9=;
     |SI FSalida ! 0 ; |GRABA 021#9b; |FINSI;
     #9#39 = #9#39 - nUni;
     #9#5  = #9#5  - nUni;

     #11#104 = #11#104 - nUni;
     #11#6 = #11#6 - nUni;

     fmes = #0#2 % A402;
     mes = fmes - 1;
     mes = mes * 5;
     mes = mes + 34;
     #11mes = #11mes + nUni;
     #11#94 = #11#94 + nUni;

     mes = fmes - 1;
     mes = mes * 2;
     mes = mes + 11;
     #9mes = #9mes + nUni; ||salida mensual
     #9#35 = #9#35 + nUni; ||salida anual

     |HAZ ValoraStock;
     |GRABA 021#11a;
     |LIBERA #11;
     |GRABA 021#9a;
     |LIBERA #9; |CIERRA #9;

     enUniVta = nUni;
     enUniSal = nUni;
     eaArticulo = #1#2;
     enAlmacen = #70#29;
     efFecha = #0#2;
     |HAZ AcumulaArt;
     |HAZ AcumulaAlm;

     ||----- Histo
     |ABRE #70;
     #70#26 = #1#0;
     |LEE 000#70=;
     |CIERRA #70;

     |ABRE #12;
     |DDEFECTO #12;
     #12#0 = #1#2;||articulo
     #12#11= #0#0;||Serie
     #12#1 = #1#22;||FECHA
     #12#2 = "OR";|| tipo operacion
     #12#3 = #1#1;|| documento
     #12#4 = #1#11;|| linea
     |LEE 101#12=;
     |SI FSalida ! 0; |GRABA 020#12b; |FINSI;
     #12#5 = #70#29;
     #12#6 = -nUni;
     #12#7 = 0;
     #12#8 = 0;
     |SI #1#14 = "G"; |O #1#14 = "S";
          #12#9 = 0;
          #12#14 = 0;
     |SINO;
          #12#9 = #1#5;
          #12#14 = #1#5 < #1#6;
     |FINSI;
     #12#10 = #0#11;
     #12#12 = #1#6;
     #12#13 = 0;
     ||#12#15 = #0#3; || matricula
     |SI modo_ent = 3;
          |BORRA 020#12c;
     |SINO;
          |GRABA 020#12a;
     |FINSI;
     |CIERRA #12;
|FPRC;
