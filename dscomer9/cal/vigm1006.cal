     TotalLinVigor, CalCabVigor, LimCabVigor

|FICHEROS;
     dszrec01;
     vigm0006 #10;
     vigm0007 #71;
     agifa024;
     agifa142;
     agifa019 #19;
     referen@;

     otroref@;
|FIN;

|VARIABLES;
     aBaseRec01 = "";
     aMasRec01 = "";
     aCampo207 = "";

     nBasRete = 0;
     nImporDescue1 = 0;
     nImporDescue2 = 0;
     nImporDescue3 = 0;
     nImporMoneda1 = 0;
     nImporMoneda2 = 0;
     nDescuMoneda1 = 0;
     nDescuMoneda2 = 0;

     aDef          = "";
     &nDeci_IVA    = 0;
     &nDeci_IVADiv = 0;
     nError        = 0;
     nNume         = 0;
     nCanti        = 0;
     nMargen       = 0;
     nBrutoMoneda1 = 0;
     nBrutoMoneda2 = 0;

     &eaCli        = "";
     &enTiva       = 0;
     &enIva        = 0;
     &enRec        = 0;
     &efFiva = @;
     nImpDiv       = 0;
     nMult         = 0;
     nTotPVerde = 0;
     aAlfa = "";
     nPreTon = 0;
|FIN;

|PROCESO Ivasvigm0006;
     efFiva = #vigm0006#1;
     |HAZ IVACli;

     |SI enTiva = 0;
         #vigm0006#28 = #vigm0006#28 +. nBrutoMoneda1;
         #dszrec01#00 = #dszrec01#00 +. nBrutoMoneda2;
     |FINSI;

     |SI enTiva = 1;
         #vigm0006#16 = #vigm0006#16 +. nBrutoMoneda1;
         nNume        = #vigm0006#16;
         #vigm0006#17 = #vigm0006#16 % enIva;
         |SI #vigm0006#36 = "S";
             #vigm0006#18 = nNume % enRec;
         |FINSI;

         #dszrec01#1  = #dszrec01#1  +. nBrutoMoneda2;
         nNume        = #dszrec01#1;
         #dszrec01#2  = #dszrec01#1 % enIva;
         |SI #vigm0006#36 = "S";
             #dszrec01#3 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 2;
         #vigm0006#19 = #vigm0006#19 +. nBrutoMoneda1;
         nNume        = #vigm0006#19;
         #vigm0006#20 = #vigm0006#19 % enIva;
         |SI #vigm0006#36 = "S";
             #vigm0006#21 = nNume % enRec;
         |FINSI;

         #dszrec01#4  = #dszrec01#4  +. nBrutoMoneda2;
         nNume        = #dszrec01#4;
         #dszrec01#5  = #dszrec01#4 % enIva;
         |SI #vigm0006#36 = "S";
             #dszrec01#6 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 3;
         #vigm0006#22 = #vigm0006#22 +. nBrutoMoneda1;
         nNume        = #vigm0006#22;
         #vigm0006#23 = #vigm0006#22 % enIva;
         |SI #vigm0006#36 = "S";
             #vigm0006#54 = nNume % enRec;
         |FINSI;

         #dszrec01#7  = #dszrec01#7  +. nBrutoMoneda2;
         nNume        = #dszrec01#7;
         #dszrec01#8  = #dszrec01#7 % enIva;
         |SI #vigm0006#36 = "S";
             #dszrec01#9 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 4;
         #vigm0006#44 = #vigm0006#44 +. nBrutoMoneda1;
         nNume        = #vigm0006#44;
         #vigm0006#45 = #vigm0006#44 % enIva;
         |SI #vigm0006#36 = "S";
             #vigm0006#46 = nNume % enRec;
         |FINSI;

         #dszrec01#10 = #dszrec01#10 +. nBrutoMoneda2;
         nNume        = #dszrec01#10;
         #dszrec01#11 = #dszrec01#10 % enIva;
         |SI #vigm0006#36 = "S";
             #dszrec01#12 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 5;
         #vigm0006#47 = #vigm0006#47 +. nBrutoMoneda1;
         nNume        = #vigm0006#47;
         #vigm0006#48 = #vigm0006#47 % enIva;
         |SI #vigm0006#36 = "S";
             #vigm0006#49 = nNume % enRec;
         |FINSI;

         #dszrec01#13 = #dszrec01#13 +. nBrutoMoneda2;
         nNume        = #dszrec01#13;
         #dszrec01#14 = #dszrec01#13 % enIva;
         |SI #vigm0006#36 = "S";
             #dszrec01#15 = nNume % enRec;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO IvaRestovigm0006;
     eaCli         = #vigm0006#3;

     nBrutoMoneda1 = #vigm0006#11;
     nBrutoMoneda2 = #vigm0006#81;
     enTiva        = #vigm0006#12;
     |HAZ Ivasvigm0006;

     nBrutoMoneda1 = #vigm0006#13;
     nBrutoMoneda2 = #vigm0006#82;
     enTiva        = #vigm0006#14;
     |HAZ Ivasvigm0006;
|FPRC;

|PROCESO LimCabVigor;
     |DDEFECTO #dszrec01;
     #vigm0006#15 = 0;
     #vigm0006#37 = 0;
     #vigm0006#16 = 0;
     #vigm0006#17 = 0;
     #vigm0006#18 = 0;
     #vigm0006#19 = 0;
     #vigm0006#20 = 0;
     #vigm0006#21 = 0;
     #vigm0006#22 = 0;
     #vigm0006#23 = 0;
     #vigm0006#24 = 0;
     #vigm0006#25 = 0;
     #vigm0006#26 = 0;
     #vigm0006#28 = 0;
     #vigm0006#37 = 0;
     #vigm0006#44 = 0;
     #vigm0006#45 = 0;
     #vigm0006#46 = 0;
     #vigm0006#47 = 0;
     #vigm0006#48 = 0;
     #vigm0006#49 = 0;
     #vigm0006#54 = 0;
     #vigm0006#67 = 0;
     #vigm0006#75 = 0;
     #vigm0006#76 = 0;
     #vigm0006#94 = 0;
     |SI #vigm0006#70 = "D";
          #vigm0006#11 = #vigm0006#81 / #vigm0006#69 * #vigm0006#74;
          #vigm0006#13 = #vigm0006#82 / #vigm0006#69 * #vigm0006#74;
     |SINO;
          #vigm0006#81 = #vigm0006#11 * #vigm0006#69 / #vigm0006#74;
          #vigm0006#82 = #vigm0006#13 * #vigm0006#69 / #vigm0006#74;
     |FINSI;
     |HAZ IvaRestovigm0006;
|FPRC;

|PROCESO CalCabVigor;
     |SI #vigm0007#9 ] 0;
          nError = 1;
     |SINO;
          nError = -1;
     |FINSI;
     #vigm0007#9   = #vigm0007#9 * nError;
     #vigm0007#37  = #vigm0007#37 * nError;

     nCanti = #vigm0007#9 < #vigm0006#5;
     nCanti = nCanti < #vigm0006#32;
     |SI #agifa142#115 = "S";
          nCanti = nCanti < #vigm0006#7;
     |FINSI;
     nCanti = nCanti * nError;
     |SI #agifa019#194 = 1;
         nMargen = #vigm0007#5 * #agifa019#9;
     |SINO;
         nMargen = #vigm0007#48 * #agifa019#9;
     |FINSI;
     nMargen = nCanti - nMargen;
     #vigm0006#37 = #vigm0006#37 + nMargen;

     #vigm0007#9  = #vigm0007#9  * nError;
     #vigm0007#37 = #vigm0007#37 * nError;
     ||----------------------------

     #vigm0006#15 = #vigm0006#15 +. #vigm0007#9;
     #vigm0006#75 = #vigm0006#75 +. #vigm0007#37;
     #vigm0006#94 = #vigm0006#94 +. #vigm0007#62;

     nBrutoMoneda1 = #vigm0007#9;
     nImporDescue1 = (nBrutoMoneda1 % #vigm0006#5) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #vigm0006#32) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #vigm0006#7) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     nDescuMoneda1 = nImporDescue1 + nImporDescue2 + nImporDescue3;

     nBrutoMoneda2 = #vigm0007#37;
     nImporDescue1 = (nBrutoMoneda2 % #vigm0006#5) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #vigm0006#32) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #vigm0006#7) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     nDescuMoneda2 = nImporDescue1 + nImporDescue2 + nImporDescue3;
/*
     nBrutoMoneda1 = (#vigm0007#9  < #vigm0006#5) ! nDeci_IVA;
     nBrutoMoneda1 = (nBrutoMoneda1 < #vigm0006#32) ! nDeci_IVA;
     nBrutoMoneda1 = (nBrutoMoneda1 < #vigm0006#7) ! nDeci_IVA;

     nBrutoMoneda2 = (#vigm0007#37 < #vigm0006#5) ! nDeci_IVADiv;
     nBrutoMoneda2 = (nBrutoMoneda2 < #vigm0006#32) ! nDeci_IVADiv;
     nBrutoMoneda2 = (nBrutoMoneda2 < #vigm0006#7) ! nDeci_IVADiv;
*/

     eaCli         = #vigm0006#3;
     enTiva        = #vigm0007#11;
     |HAZ Ivasvigm0006;

     ||----------------------------
     nNume = nBrutoMoneda1 % #vigm0007#10;
     #vigm0006#26 = #vigm0006#26 +. nNume;
     ||----------------------------

     #vigm0006#25 = #vigm0006#25 +. nDescuMoneda1;
/*
     |SI #vigm0006#15 > 0;
         nError = 1;
     |SINO;
         nError = -1;
         #vigm0006#15 = -#vigm0006#15;
         #vigm0006#75 = -#vigm0006#75;
     |FINSI;

     #vigm0006#25 = #vigm0006#15 < #vigm0006#5;
     #vigm0006#25 = #vigm0006#25 < #vigm0006#32;
     #vigm0006#25 = #vigm0006#25 < #vigm0006#7;

     #vigm0006#25 = #vigm0006#25 * nError;
     #vigm0006#15 = #vigm0006#15 * nError;
     #vigm0006#25 = #vigm0006#15 - #vigm0006#25;
*/

     #vigm0006#24 = #vigm0006#17 + #vigm0006#18 + #vigm0006#20 + #vigm0006#21 + #vigm0006#23 + #vigm0006#54 + #vigm0006#45 + #vigm0006#46 + #vigm0006#48 + #vigm0006#49;

     #dszrec01#17 = #dszrec01#17 +. nDescuMoneda2;

/*
     #dszrec01#17 = #vigm0006#75 < #vigm0006#5;
     #dszrec01#17 = #dszrec01#17 < #vigm0006#32;
     #dszrec01#17 = #dszrec01#17 < #vigm0006#7;
     #dszrec01#17 = #dszrec01#17 * nError;

     #vigm0006#75 = #vigm0006#75 * nError;
     #dszrec01#17 = #vigm0006#75 - #dszrec01#17;
*/

     #dszrec01#16 = #dszrec01#02 + #dszrec01#03 + #dszrec01#05 + #dszrec01#06 + #dszrec01#08 + #dszrec01#09 + #dszrec01#11 + #dszrec01#12 + #dszrec01#14 + #dszrec01#15;

     #vigm0006#67 =  (#vigm0006#15 - #vigm0006#25) + (#vigm0006#11 + #vigm0006#13 + #vigm0006#24);
     #vigm0006#67 = #vigm0006#67 + nTotPVerde;  || modulo

     #vigm0006#76 =  (#vigm0006#75 - #dszrec01#17) + (#vigm0006#81 + #vigm0006#82 + #dszrec01#16);
     #vigm0006#76 = #vigm0006#76 + nTotPVerde;  || modulo

     |SI #vigm0006#70 = "D";
         #vigm0006#77 = #vigm0006#75;
         #vigm0006#78 = #vigm0006#76;
         #vigm0006#79 = #vigm0006#15;
         #vigm0006#80 = #vigm0006#67;
     |SINO;
         #vigm0006#77 = #vigm0006#15;
         #vigm0006#78 = #vigm0006#67;
         #vigm0006#79 = #vigm0006#75;
         #vigm0006#80 = #vigm0006#76;
     |FINSI;


     |DBASE aBaseRec01;
     |QBF aBaseRec01;
     aMasRec01 = aBaseRec01 + "def/agifa024";
     |CARGA_DEF aMasRec01, otroref@;
     |SI FSalida = 0;
          |ABRE #otroref@;
          |DDEFECTO #otroref@;
          #otroref@#0 = #vigm0006#3;
          |LEE 000#otroref@.=;
          aCampo207 = #otroref@#207;
          |CIERRA #otroref@;
          |DESCARGA_DEF #otroref@;
     |SINO;
          |ABRE #agifa024;
          |DDEFECTO #agifa024;
          #agifa024#0 = #vigm0006#3;
          |LEE 000#agifa024.=;
          aCampo207 = #agifa024#207;
          |CIERRA #agifa024;
     |FINSI;

     nBasRete = #vigm0006#28 + #vigm0006#16 + #vigm0006#19 + #vigm0006#22 + #vigm0006#44 + #vigm0006#47;
     |SI aCampo207 = "N";
          nBasRete = nBasRete + #vigm0006#17 + #vigm0006#20 + #vigm0006#23 + #vigm0006#45 + #vigm0006#48;
          nBasRete = nBasRete + #vigm0006#18 + #vigm0006#21 + #vigm0006#54 + #vigm0006#46 + #vigm0006#49;
     |FINSI;
     #dszrec01#19 = nBasRete;
     #dszrec01#20 = nBasRete / #vigm0006#69 * #vigm0006#74
|FPRC;

|| ----------------------  FIN vigm0006 ---------------------------------

|PROCESO TotalLinVigor;
     |ABRE #19;
     #19#0 = #71#2;
     |LEE 000#19=;
     |SI FSalida !0; |DDEFECTO #19; |FINSI;
     |CIERRA #19;

     nPreTon = 1;
     |HAZ EsVigor;
     |SI FSalida = 0;
          aAlfa = #19#110; |QBF aAlfa;   || Alfanumerico1
          aAlfa = aAlfa > "";
          |SI aAlfa = "S"; nPreTon = 1000; |FINSI;
     |FINSI;

     #71#62 = #71#5 * #19#208; ||Punto Verde

     |SI #10#70 = "D";                    || Si mon. de trabajo es divisa ...
          #71#6  = #71#36 / #10#69 * #10#74; || Recalculo precio en mon. base
          #71#38 = #71#6;                  || Precio visual, en mon. base
     |SINO;                              || Si mon. de trabajo es mon. base
          #71#36 = #71#6 / #10#74 * #10#69;  || Recalculo precio en divisa
          #71#38 = #71#36;                 || Precio visual, en divisa
     |FINSI;

     |SI #19#194 = 2;
         #71#7    = #71#48 * #71#6 / nPreTon;
         nImpDiv = (#71#48 * #71#36 / nPreTon) ! nDeci_IVADiv;
     |SINO;
          #71#7    = #71#5 * #71#6 / nPreTon;
          nImpDiv = (#71#5 * #71#36 / nPreTon) ! nDeci_IVADiv;
     |FINSI;

     || nMult corrige el error del redondeo para negativos
     |SI #71#7 < 0; nMult = -1; |SINO; nMult = 1; |FINSI;

     #71#7    = #71#7    * nMult;
     nImpDiv = nImpDiv * nMult;

     #71#9  = (((#71#7 < #71#8) < #71#33));
     #71#37 = (((nImpDiv < #71#8) < #71#33));

     #71#7  = #71#7 * nMult;
     #71#9  = #71#9 * nMult;
     #71#37 = #71#37 * nMult;
     ||컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴

     |SI #10#70 = "D";     || Si la moneda de trabajo es la divisa ...
          #71#39 = #71#9;   || el campo visualiz. es el importe en moneda base
     |SINO;               || Si la moneda de trabajo es la moneda base ...
          #71#39 = #71#37;  || el campo visualiz. es el importe en divisa
     |FINSI;
|FPRC;
