     CALCULO ALBARANES VENTA TotalLinMpA CalCabMalpe090A LinCabMalpe090A

     si se cambia algo, cambiarlo en el malp1090

|FICHEROS;
     dszrec01;
     malpe090 #0,MANTE;   ||Cab Alb Vta
     malpe091 #3;   ||Lin Alb Vta

     agifa142;
     agifa019 #2;
|FIN;

|VARIABLES;
     &nDeci_IVADiv = 0;
     nError        = 0;
     nNume         = 0;
     nCanti        = 0;
     nMargen       = 0;
     nBrutoMoneda1 = 0;
     nBrutoMoneda2 = 0;

     &eaCli        = "";
     &enTiva       = 0;
     &enIva        = 0;
     &enRec        = 0;
     &efFiva = @;
     nImpDiv       = 0;
     nMult         = 0;
|FIN;

|PROCESO Ivasmalpe090A;
     efFiva = #malpe090#1;
     |HAZ IVACli;

     |SI enTiva = 0;
         #malpe090#28 = #malpe090#28 +. nBrutoMoneda1;
         #dszrec01#00 = #dszrec01#00 +. nBrutoMoneda2;
     |FINSI;

     |SI enTiva = 1;
         #malpe090#16 = #malpe090#16 +. nBrutoMoneda1;
         nNume        = #malpe090#16;
         #malpe090#17 = #malpe090#16 % enIva;
         |SI #malpe090#36 = "S";
             #malpe090#18 = nNume % enRec;
         |FINSI;

         #dszrec01#1  = #dszrec01#1  +. nBrutoMoneda2;
         nNume        = #dszrec01#1;
         #dszrec01#2  = #dszrec01#1 % enIva;
         |SI #malpe090#36 = "S";
             #dszrec01#3 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 2;
         #malpe090#19 = #malpe090#19 +. nBrutoMoneda1;
         nNume        = #malpe090#19;
         #malpe090#20 = #malpe090#19 % enIva;
         |SI #malpe090#36 = "S";
             #malpe090#21 = nNume % enRec;
         |FINSI;

         #dszrec01#4  = #dszrec01#4  +. nBrutoMoneda2;
         nNume        = #dszrec01#4;
         #dszrec01#5  = #dszrec01#4 % enIva;
         |SI #malpe090#36 = "S";
             #dszrec01#6 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 3;
         #malpe090#22 = #malpe090#22 +. nBrutoMoneda1;
         nNume        = #malpe090#22;
         #malpe090#23 = #malpe090#22 % enIva;
         |SI #malpe090#36 = "S";
             #malpe090#54 = nNume % enRec;
         |FINSI;

         #dszrec01#7  = #dszrec01#7  +. nBrutoMoneda2;
         nNume        = #dszrec01#7;
         #dszrec01#8  = #dszrec01#7 % enIva;
         |SI #malpe090#36 = "S";
             #dszrec01#9 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 4;
         #malpe090#44 = #malpe090#44 +. nBrutoMoneda1;
         nNume        = #malpe090#44;
         #malpe090#45 = #malpe090#44 % enIva;
         |SI #malpe090#36 = "S";
             #malpe090#46 = nNume % enRec;
         |FINSI;

         #dszrec01#10 = #dszrec01#10 +. nBrutoMoneda2;
         nNume        = #dszrec01#10;
         #dszrec01#11 = #dszrec01#10 % enIva;
         |SI #malpe090#36 = "S";
             #dszrec01#12 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 5;
         #malpe090#47 = #malpe090#47 +. nBrutoMoneda1;
         nNume        = #malpe090#47;
         #malpe090#48 = #malpe090#47 % enIva;
         |SI #malpe090#36 = "S";
             #malpe090#49 = nNume % enRec;
         |FINSI;

         #dszrec01#13 = #dszrec01#13 +. nBrutoMoneda2;
         nNume        = #dszrec01#13;
         #dszrec01#14 = #dszrec01#13 % enIva;
         |SI #malpe090#36 = "S";
             #dszrec01#15 = nNume % enRec;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO IvaRestomalpe090A;
     eaCli         = #malpe090#3;

     nBrutoMoneda1 = #malpe090#11;
     nBrutoMoneda2 = #malpe090#81;
     enTiva        = #malpe090#12;
     |HAZ Ivasmalpe090A;

     nBrutoMoneda1 = #malpe090#13;
     nBrutoMoneda2 = #malpe090#82;
     enTiva        = #malpe090#14;
     |HAZ Ivasmalpe090A;
|FPRC;

|PROCESO LinCabMalpe090A;
     |DDEFECTO #dszrec01;

     #malpe090#15 = 0;
     #malpe090#37 = 0;
     #malpe090#16 = 0;
     #malpe090#17 = 0;
     #malpe090#18 = 0;
     #malpe090#19 = 0;
     #malpe090#20 = 0;
     #malpe090#21 = 0;
     #malpe090#22 = 0;
     #malpe090#23 = 0;
     #malpe090#24 = 0;
     #malpe090#25 = 0;
     #malpe090#26 = 0;
     #malpe090#28 = 0;
     #malpe090#37 = 0;
     #malpe090#44 = 0;
     #malpe090#45 = 0;
     #malpe090#46 = 0;
     #malpe090#47 = 0;
     #malpe090#48 = 0;
     #malpe090#49 = 0;
     #malpe090#54 = 0;
     #malpe090#67 = 0;
     #malpe090#75 = 0;
     #malpe090#76 = 0;
     |SI #malpe090#70 = "D";
          #malpe090#11 = #malpe090#81 / #malpe090#69 * #malpe090#74;
          #malpe090#13 = #malpe090#82 / #malpe090#69 * #malpe090#74;
     |SINO;
          #malpe090#81 = #malpe090#11 * #malpe090#69 / #malpe090#74;
          #malpe090#82 = #malpe090#13 * #malpe090#69 / #malpe090#74;
     |FINSI;
     |HAZ IvaRestomalpe090A;
|FPRC;

|PROCESO CalCabMalpe090A;
     ||----------------------------  Margen
     |SI #malpe091#9 ] 0;
          nError = 1;
     |SINO;
          nError = -1;
          #malpe091#9   = -#malpe091#9;
          #malpe091#37  = -#malpe091#37;
     |FINSI;

     nCanti = #malpe091#9 < #malpe090#5;
     nCanti = nCanti < #malpe090#32;
     |SI #agifa142#115 = "S";
          nCanti = nCanti < #malpe090#7;
     |FINSI;
     nCanti = nCanti * nError;
     |SI #agifa019#194 = 1;
         nMargen = #malpe091#5 * #agifa019#9;
     |SINO;
         nMargen = #malpe091#48 * #agifa019#9;
     |FINSI;
     nMargen      = nCanti - nMargen;
     #malpe090#37 = #malpe090#37 + nMargen;
     ||----------------------------

     #malpe091#9  = #malpe091#9  * nError;
     #malpe091#37 = #malpe091#37 * nError;

     #malpe090#15 = #malpe090#15 +. #malpe091#9;
     #malpe090#75 = #malpe090#75 +. #malpe091#37;

     nBrutoMoneda1 = ((#malpe091#9  < #malpe090#5) < #malpe090#32) < #malpe090#7;
     nBrutoMoneda2 = ((#malpe091#37 < #malpe090#5) < #malpe090#32) < #malpe090#7;

     eaCli         = #malpe090#3;
     enTiva        = #malpe091#11;
     |HAZ Ivasmalpe090A;

     nNume = (#malpe091#67 * #malpe091#5);
     nNume = ((nNume < #malpe090#5) < #malpe090#32) < #malpe090#7;
     nNume = nNume % #malpe091#10;
     #malpe090#26 = #malpe090#26 +. nNume;

     |SI #malpe090#15 > 0;
         nError = 1;
     |SINO;
         nError = -1;
         #malpe090#15 = -#malpe090#15;
         #malpe090#75 = -#malpe090#75;
     |FINSI;

     #malpe090#25 = (((#malpe090#15 < #malpe090#5) < #malpe090#32) < #malpe090#7);
     #malpe090#25 = #malpe090#25 * nError;
     #malpe090#15 = #malpe090#15 * nError;
     #malpe090#25 = #malpe090#15 - #malpe090#25;
     #malpe090#24 = #malpe090#17 + #malpe090#18 + #malpe090#20 + #malpe090#21 + #malpe090#23 + #malpe090#54 + #malpe090#45 + #malpe090#46 + #malpe090#48 + #malpe090#49;

     #dszrec01#17 = (((#malpe090#75 < #malpe090#5) < #malpe090#32) < #malpe090#7);
     #dszrec01#17 = #dszrec01#17 * nError;
     #malpe090#75 = #malpe090#75 * nError;
     #dszrec01#17 = #malpe090#75 - #dszrec01#17;
     #dszrec01#16 = #dszrec01#02 + #dszrec01#03 + #dszrec01#05 + #dszrec01#06 + #dszrec01#08 + #dszrec01#09 + #dszrec01#11 + #dszrec01#12 + #dszrec01#14 + #dszrec01#15;

     #malpe090#67 =  (#malpe090#15 - #malpe090#25) + (#malpe090#11 + #malpe090#13 + #malpe090#24);
     #malpe090#76 =  (#malpe090#75 - #dszrec01#17) + (#malpe090#81 + #malpe090#82 + #dszrec01#16);

     |SI #malpe090#70 = "D";
         #malpe090#77 = #malpe090#75;
         #malpe090#78 = #malpe090#76;
         #malpe090#79 = #malpe090#15;
         #malpe090#80 = #malpe090#67;
     |SINO;
         #malpe090#77 = #malpe090#15;
         #malpe090#78 = #malpe090#67;
         #malpe090#79 = #malpe090#75;
         #malpe090#80 = #malpe090#76;
     |FINSI;
|FPRC;

|PROCESO TotalLinMpA;
     |ABRE #2;
     #2#0 = #3#2;
     |LEE 020#2=;
     |CIERRA #2;

     |SI #0#70 = "D";                    || Si mon. de trabajo es divisa ...
          #3#6  = #3#36 / #0#69 * #0#74; || Recalculo precio en mon. base
          #3#38 = #3#6;                  || Precio visual, en mon. base
     |SINO;                              || Si mon. de trabajo es mon. base
          #3#36 = #3#6 / #0#74 * #0#69;  || Recalculo precio en divisa
          #3#38 = #3#36;                 || Precio visual, en divisa
     |FINSI;

     |SI #2#194 = 2;
         #3#7    = #3#48 * #3#6;
         nImpDiv = (#3#48 * #3#36) ! nDeci_IVADiv;
     |SINO;
          #3#7    = #3#5 * #3#6;
          nImpDiv = (#3#5 * #3#36) ! nDeci_IVADiv;
     |FINSI;

     || nMult corrige el error del redondeo para negativos
     |SI #3#7 < 0; nMult = -1; |SINO; nMult = 1; |FINSI;

     #3#7    = #3#7    * nMult;
     nImpDiv = nImpDiv * nMult;

     #3#9  = (((#3#7 ) ));
     #3#37 = (((nImpDiv ) ));

     #3#7  = #3#7 * nMult;
     #3#9  = #3#9 * nMult;
     #3#37 = #3#37 * nMult;
     ||컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴

     |SI #0#70 = "D";     || Si la moneda de trabajo es la divisa ...
          #3#39 = #3#9;   || el campo visualiz. es el importe en moneda base
     |SINO;               || Si la moneda de trabajo es la moneda base ...
          #3#39 = #3#37;  || el campo visualiz. es el importe en divisa
     |FINSI;
|FPRC;
