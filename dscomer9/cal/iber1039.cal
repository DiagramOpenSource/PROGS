|FICHEROS;
     iber0139 #0;
     iber0137 #137;
     iber0138 #138;
     agifa501 #501;
     agifa024 #24;
|FIN;

|VARIABLES;
     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;
     &EURODB   = 0;
     nCampo    = 0;
     aSerie    = "";
     aTipo     = "";
     fFecha    = @;
     nLinCab   = 0;
     nLinCon   = 0;
     nLin      = 0;
     nCam      = 0;
     nTotIva   = 0;
     nBase     = 0;
     nIva      = 0;
     nRec      = 0;
     nCanti    = 0;
     nCantiHasta = 0;
     nTotal    = 0;
     nSumTotal0 = 0;
     nSumTotal1 = 0;
     nSumTotal2 = 0;
     nSumTotal3 = 0;
     nSumTotal4 = 0;
     nSumTotal5 = 0;
     i          = 0;
     nSumIva1 = 0;
     nSumIva2 = 0;
     nSumIva3 = 0;
     nSumIva4 = 0;
     nSumIva5 = 0;

     nSumRec1 = 0;
     nSumRec2 = 0;
     nSumRec3 = 0;
     nSumRec4 = 0;
     nSumRec5 = 0;
|FIN;

|PROCESO UltimoCon1;
     |SELECT #2#137;
     #137#0 = #501#57;
     #137#2 = #501#35;
     #137#41 = 999999;
     |LEE 000#137];
     |SI FSalida = 0;
          |LEE 000#137a;
     |SINO;
          |LEE 000#137u;
     |FINSI;
     |SI FSalida = 0; |Y #137#0 = #501#57; |Y #137#2 = #501#35;
          nLinCon = #137#41 + 1;
     |SINO;
          nLinCon = 1;
     |FINSI;
     |SELECT #1#137;
|FPRC;

|PROCESO UltimaCab1;
     #137#0 = #501#57;
     #137#1 = #501#14;
     #137#2 = #501#35;
     #137#3 = 999;
     |LEE 000#137];
     |SI FSalida = 0;
          |LEE 000#137a;
     |SINO;
          |LEE 000#137u;
     |FINSI;
     |SI FSalida = 0; |Y #137#0 = #501#57; |Y #137#1 = #501#14;
               |Y #137#2 = #501#35;
          nLinCab = #137#3 + 1;
     |SINO;
          nLinCab = 1;
     |FINSI;
|FPRC;

|PROCESO TotalTiquet1;
     #137#7 = #137#7 + nSumTotal0;

     #137#11 = #137#11 + nSumTotal1;
     #137#17 = #137#17 + nSumTotal2;
     #137#23 = #137#23 + nSumTotal3;
     #137#29 = #137#29 + nSumTotal4;
     #137#35 = #137#35 + nSumTotal5;

     #137#12 = #137#12 + nSumIva1;
     #137#18 = #137#18 + nSumIva2;
     #137#24 = #137#24 + nSumIva3;
     #137#30 = #137#30 + nSumIva4;
     #137#36 = #137#36 + nSumIva5;

     #137#13 = #137#13 + nSumRec1;
     #137#19 = #137#19 + nSumRec1;
     #137#25 = #137#25 + nSumRec1;
     #137#31 = #137#31 + nSumRec1;
     #137#37 = #137#37 + nSumRec1;

     #137#10 = #137#11 + #137#12 + #137#13;
     #137#16 = #137#17 + #137#18 + #137#19;
     #137#22 = #137#23 + #137#24 + #137#25;
     #137#28 = #137#29 + #137#30 + #137#31;
     #137#34 = #137#35 + #137#36 + #137#37;

     #137#6 = #137#7 + #137#10 + #137#16 + #137#22 + #137#28 + #137#34;

|FPRC;

|PROCESO agifa501_1;
     |SI #501#35 ! "F"; |Y #501#35 ! "T";
          |ERROR; |ACABA;
     |FINSI;

     |PARA i = 1; |SI i [ 5; |HACIENDO i = i + 1;
          enTiva = i;
          efFiva = #501#14;
          |HAZ SacaIVA;
          nCampo = i * 6 + 2;
          #137nCampo = enIva;
          nCampo = nCampo + 1;
          #137nCampo = enRec;
     |SIGUE;

     nSumTotal0 = #501#30;

     nSumTotal1 = #501#20;
     nSumTotal2 = #501#23;
     nSumTotal3 = #501#26;
     nSumTotal4 = #501#48;
     nSumTotal5 = #501#51;

     nSumIva1 = #501#21;
     nSumIva2 = #501#24;
     nSumIva3 = #501#27;
     nSumIva4 = #501#49;
     nSumIva5 = #501#52;

     nSumRec1 = #501#22;
     nSumRec2 = #501#25;
     nSumRec3 = #501#47;
     nSumRec4 = #501#50;
     nSumRec5 = #501#53;

     nCantiHasta = #0#5 - #501#9;

     |SI aSerie ! #501#57; |O fFecha ! #501#14; |O aTipo ! #501#35;
               |O nCanti > nCantiHasta;
          aSerie = #501#57;
          fFecha = #501#14;
          aTipo = #501#35;
          nCanti = 0;
          |HAZ UltimaCab1;
          |HAZ UltimoCon1;

          |DDEFECTO #137;
          #137#0 = #501#57;
          #137#1 = #501#14;
          #137#2 = #501#35;
          #137#3 = nLinCab;
          #137#4 = #501#58;   ||D.Numero Doc
          #137#39 = (A\(#137#0 % 103));
          #137#41 = nLinCon;
          |GRABA 020#137b;
     |FINSI;

     #24#0 = #501#1;
     |LEE 000#24=;
     |SI FSalida ! 0; |DDEFECTO #24; |FINSI;
|FPRC;

|PROCESO FinCab1;
     |HAZ TotalTiquet1;

     #137#5 = #501#58;
     |GRABA 020#137a;
     |LIBERA #137;

     #138#0 = #137#0;
     #138#1 = #137#1;
     #138#2 = #137#2;
     #138#3 = #137#3;
     #138#4 = 1;
     |GRABA 000#138n;
|FPRC;

|DEFBUCLE agifa501_1;
     #501#2;
     14, 31;
     " ", #0#1, 00001, #0#3, "B";
     "z", #0#2, 99999, #0#4, "Z";
     ;
     NULL, agifa501_1, NULL, FinCab1;
|FIN;

|PROCESO Nuevo;
     |ABRE #137;
     |ABRE #138;
     |ABRE #24;
     |BUCLE agifa501_1;
     |CIERRA #24;
     |CIERRA #137;
     |CIERRA #138;
|FPRC;
