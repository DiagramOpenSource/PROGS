|FICHEROS;
     diaz0021 #100;
     dsz99984 #0;
     dsz99984 #11;
     agifa010 #10;
     agifa059 #59;
     agifa071 #71;
     agifa134 #134;
     agifa133 #133;
     agifa324 #324;
     agifa025 #25;
     agifa024 #24;
     agifa091 #91;
     agifa142 #142;
     agifa177 #177;
     agis0002 #98;
     dscam003@;
     dscam045@;
|FIN;

|VARIABLES;
     &enSw = 0;
     &aDivisa = "";
     &aMoneda = "";
     &nDeci_Div = 0;
     &enImpo = 0;
     &enBase = 0;
     &enIva = 0;

     enDirEnt = 0;
     eaDirEnt = "";
     aAlfa = "";
     nImporte = 0;
     nLin = 0;
     fFec = 0;
     aZona = "";
     nBase = 0;
     nEuro = 0;
     nTotal = 0;
     aCurso = "";
     nLinea = 1;
     aNumEmp = "";
     aPath = "";
     aDef00 = "";
     aTempo600 = "";
     &Tempo = "";
     nCampos = 0;
     &aCPath = "";
     &aCNome = "";
     &eaProg = "";
     nVto = 0;
     nRecibo = 0;
     nNume = 0;
     aBase = "";
     nError = 0;
     aEmp = "";
     nEmpresa = 0;
|FIN;

|PROCESO FactuFin;
     nImporte = #134#101 - nImporte;

     nNume = nImporte ! 2;
     |SI nNume = 0;
          |DDEFECTO #133;
          enSw = 3; |PRINT;
          |ACABA;
     |FINSI;

     #133#4 = #134#49;
     #133#0 = #134#0;
     #133#1 = 999;
     |LEE 000#133];
     |SI FSalida = 0;
          |LEE 000#133a;
     |SINO;
          |LEE 000#133u;
     |FINSI;
     |SI FSalida = 0; |Y #133#4 = #134#49; |Y #133#0 = #134#0;
          nLin = #133#1 + 1;
          fFec = #133#3;
     |SINO;
          nLin = 1;
          fFec = #134#1;
     |FINSI;
     |DDEFECTO #133;
     #133#4 = #134#49;
     #133#0 = #134#0;
     #133#1 = nLin;
     #133#2 = nImporte;
     #133#3 = fFec;
     |GRABA 020#133n;

     enSw = 3; |PRINT;

     |SI #134#45 = "S";
          nVto = #133#1;
          nRecibo = #133#1;

          |ABRE #91;
          #91#0 = #134#11;
          |LEE 020#91=;
          |CIERRA #91;
          |ABRE #24;
          #24#0 = #134#2;   ||cli
          |LEE 020#24=;
          |CIERRA #24;

          |HAZ AbreRecVenta;

          |DDEFECTO #11;
          #11#17 = #134#49;
          #11#0 = #134#0;
          #11#1 = #133#1;           || Linea;
          #11#2 = #134#2;            || cliente
          #11#3 = #134#3;            || nombre del cliente
          #11#4 = #134#9;            || Banco
          #11#5 = "S";             || domiciliado
          #11#6 = "N";             || aceptado
          #11#7 = #134#1;            || fecha de emision
          #11#8 = #133#3;           || Fecha de vencimiento
          #11#23 = nVto;
          #11#9 = #133#2;             || Importe
          |SI #133#5 = "S";
              #11#10 = #98#10;
              #11#11 = #98#11;
          |SINO;
              #11#10 = "N";            || Impreso
              #11#11 = "N";            || Contabilizado
          |FINSI;
          |SI #142#63 = "S";     ||  COGE LA CTA.CONTABLE DEL TIPO DE RECIBO.
              |ABRE #177;
              #177#0 = #91#69;
              |LEE 000#177=;
              |SI FSalida = 0;
                   #11#12 = #177#3;     || NUMERO CTA.CONTABLE.
              |SINO;
                   #11#12 = #134#12;     || NUMERO CTA.CONTABLE.
              |FINSI;
              |CIERRA #177;
          |SINO;
              #11#12 = #134#12;     || NUMERO CTA.CONTABLE.
          |FINSI;
          #11#13 = #98#13;
          #11#16 = #98#16;
          #11#22 = "Cobrado";
          #11#24 = #134#11;          || Forma de Pago
          #11#25 = #91#1;           || Descripcion de la forma de Pago
          #11#14 = "N";            || Impagado
          #11#15 = #24#161;         || A aceptar
          |SI #133#5 = "S";
              #11#21 = #98#22;         || Tipo de Recibo (entr.a cta.)
          |SINO;
              #11#21 = #91#69;          || Tipo de Recibo (forma de pago)
          |FINSI;
          |SI nRecibo = nVto; |Y #91#70 ! 0;
              #11#21 = #91#73;          || Tipo de Recibo (Fianza Retenida)
          |FINSI;
          #11#24 = #91#0;
          #11#25 = #91#1;
          eaProg = "agifa134";
          |HAZ RecVenta;

          |HAZ CierraRecVenta;

     |FINSI;
|FPRC;

|PROCESO CalLinAlb;
     |HAZ TotalLin71;
     |HAZ CalCabAgifa010;

     |GRABA 020#71a;
|FPRC;

|PROCESO FactuLin;
     #10#52 = #59#15;
     #10#0 = #59#2;
     |LEE 121#10=;
     |SI FSalida = 0;
          |HAZ LimCabAgifa010;
          |BUCLELIN 2 CalLinAlb #10;
          |GRABA 020#10a;
          |LIBERA #10;
     |FINSI;

     enBase = #10#16 + #10#19 + #10#22 + #10#44 + #10#47 + #10#28;
     enIva = #10#17 + #10#20 + #10#23 + #10#45 + #10#48;
     enIva = enIva + #10#18 + #10#21 + #10#53 + #10#46 + #10#49;
     enSw = 2; |PRINT;
|FPRC;

|PROCESO LinFac;
     #10#52 = #59#15;
     #10#0 = #59#2;
     |LEE 121#10=;
     |SI FSalida = 0;         || los albaranes no tienen
          #10#73 = #134#61;   || grabado estos 2 campos
          #10#74 = #134#62;
          |GRABA 020#10a;
          |LIBERA #10;
     |FINSI;
|FPRC;

|PROCESO dscam045_1;
     |SI #134#49 ] #dscam045@#4; |Y #134#49 [ #dscam045@#5;
          aEmp = ("00000" + #dscam045@#6) % -105;
          aAlfa = aBase + "dscarter/fich/" + aEmp + "/";
          |PATH_DAT #dscam003@#aAlfa#;
          |ABRE #dscam003@;
          |SELECT #12#dscam003@;
          |DDEFECTO #dscam003@;
          #dscam003@#0 = #134#49;
          #dscam003@#1 = #134#0;
          |LEE 000#dscam003@.];
          |PARA; |SI FSalida = 0; |Y #dscam003@#0 = #134#49;
                    |Y #dscam003@#1 = #134#0; |HACIENDO;
               |SI #dscam003@#14 = "P";
                    nError = 1;
                    |ERROR10;
               |FINSI;
               |LEE 000#dscam003@.s;
          |SIGUE;
          |CIERRA #dscam003@;
     |FINSI;
|FPRC;

|DEFBUCLE dscam045_1;
     #dscam045@#1002;
     2;
     nEmpresa, 001, "V";
     nEmpresa, 999, "V";
     ;
     NULL, dscam045_1;
|FIN;

|PROCESO MiraReci;
     |DFICE aAlfa; aAlfa = aAlfa % -205;
     nEmpresa = aAlfa;
     |BUCLE dscam045_1;
|FPRC;

|PROCESO FactuCab;
     nError = 0;
     |HAZ MiraReci;
     |SI nError ! 0; |ERROR; |ACABA; |FINSI;

     nImporte = #134#101;
     enImpo = #134#101;

     aDivisa = #134#58;
     aMoneda = #134#60;
     |HAZ Divisas134;

     |BUCLELIN 0 LinFac #134;

     |HAZ CalCabAgifa134;
     |GRABA 020#134a;

     enSw = 1; |PRINT;
|FPRC;

|DEFBUCLE Facturas;
     #134#1;
     1;
     "     ", 000000, #100#0;
     "zzzzz", 999999, #100#1;
     be;
     NULL, FactuCab, FactuLin, FactuFin;
|FIN;

|PROCESO Inicio;
     |IMPRE 0;
     |SI FSalida = 0;
          |INFOR "diaz0021";
          |SI FSalida = 0;
               |ABRE #10;
               |ABRE #133;
               |BUCLE Facturas;
               |CIERRA #133;
               |CIERRA #10;
               |PIEINF;
               |FININF;
          |FINSI;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     |DBASS aBase;
     aAlfa = aBase + "dscarter/def/dscam045";
     |CARGA_DEF aAlfa, dscam045@;
     |SI FSalida = 0;
          aAlfa = aBase + "dscarter/def/dscam003";
          |CARGA_DEF aAlfa, dscam003@;
          |SI FSalida = 0;
               aAlfa = aBase + "dscarter/fich/";
               |PATH_DAT #dscam045@#aAlfa#;
               |HAZ Inicio;
               |DESCARGA_DEF #dscam003@;
          |FINSI;
          |DESCARGA_DEF #dscam045@;
     |FINSI;
|FPRC;
