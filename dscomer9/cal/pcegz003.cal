|FICHEROS;
     pcegz003 #0;
     pcegm004 #1;
     pcegm005 #2;
     agifa024 #3;
     pcegm011 #11;  ||email usu
     agifa038 #13;
     agifa048 #15;
     agifa049 #16;
     agifa019 #19;
     agifa007 #40;
     agifa142 #142;
     dsm00053 #53;
     agifa041 #41;
     dsm00046 #46;
     agifa010 #55;
     agifa091 #91;
     dsm00003 #103;
     dsm00109 #109;
     dsm00020 #120;
     agifa321;
     agifa324;
     dsm00087;
     gestempo;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     i = 0;
     aMailNotifica = "";
     &eaFich = "";
     &eaTipoImp = "";
     &enCliArt = 0;
     nPrecio = 0;
     nPrecioD = 0;
     nTotal = 0;
     nTotalD = 0;
   {1}aContiene = "";
   {1}aLocal = "";
     aFic = "";
     aAdjunto = "";
     aBaseLocal = "";
     aVersion1 = "";
     aVersion2 = "";
     aSalida = "";
     aFrom = "";
     aTo = "";
     aAsunto = "";
     aMensaje = "";
     aEmail = "";
     aNomFic = "";
     aBase = "";
     aPathEnvios = "";
     aOrigen = "";
     aDestino = "";
     aIPRemoto = "";
     aAlfa = "";
     aNumFax = "";
     aNumMail = "";
     aInforme = "";
     &eaImpresora = "";
     &eaDefImpre = "";
     &enPideImpre = 0;
     aDRei        = "";
     aHRei        = "";

     &aMoneda     = "";
     &aDivisa     = "";
     &enEscan     = 0;
     &enImpo      = 0;
     &enSwImpre   = 0;
     aParam      = "";
     &enCodig     = 0;
     &eaNArticulo = "";
     &efFEntrega  = @;

     nSwPasa      = 0;

     indtope = 0;
     ind = 0;
     n_copia  = 0;
     informe   = "";
     &cant = 0;
     &tolin = 0;
     &iva1 = 0;
     &iva2 = 0;
     &iva3 = 0;
     &iva4 = 0;
     &iva5 = 0;
     &re1 = 0;
     &re2 = 0;
     &re3 = 0;
     &re4 = 0;
     &re5 = 0;
     &descrip="";
     &linea=0;
     vacio="";
     &bl  = "                              ";
     &ser_ped  = "";
     &num_ped  = 0;
     &unid     = 0;
     &codigo   = "";
     &descri   = "";
     &dto      = 0;
     &precio   = 0;
     &imptot   = 0;
     &tiva     = 0;

     &enSwLin  = 0;
     &eaDoc = "";

     aCadena = "";
     aLen = "";
     nLen = 0;
     nPosi = 0;
     nCampo = 0;
     aCaracter = "";
|FIN;

|PROCESO TodosCar;
     |PARA i = 0; |SI i [ 255; |HACIENDO i = i + 1;
          aAlfa = ("000" + i) % -103;
          aCaracter = &i;
          aAlfa = aAlfa + ":" + aCaracter;
          descrip = aAlfa;
          |PRINT;
     |SIGUE;
     |ERROR10;
|FPRC;

|PROCESO QuitaRaros;
     |QBF aAlfa;
     aCadena = "";
     aLen = aAlfa % 0;
     nLen = aLen;
     |PARA nCampo = 1;  |SI nCampo [ nLen;  |HACIENDO nCampo = nCampo + 1;
           nPosi = (100 * nCampo) + 1;
           aCaracter = aAlfa % nPosi;
           |SI aCaracter = "°";         || El euro
                aCaracter = &128;
           |FINSI;
           |SI aCaracter = "‰";         || El pormil
                aCaracter = &137;
           |FINSI;
           |SI aCaracter = "¥";  aCaracter = &209; |FINSI;
           |SI aCaracter = "¤";  aCaracter = &241; |FINSI;
           |SI aCaracter = " ";  aCaracter = &225; |FINSI;
           |SI aCaracter = "‚";  aCaracter = &233; |FINSI;
           |SI aCaracter = "¡";  aCaracter = &237; |FINSI;
           |SI aCaracter = "¢";  aCaracter = &243; |FINSI;
           |SI aCaracter = "£";  aCaracter = &250; |FINSI;
           |SI aCaracter = "§";  aCaracter = &176; |FINSI;
           |SI aCaracter = "¦";  aCaracter = &170; |FINSI;
           aCadena = aCadena + aCaracter;
     |SIGUE;
     aAlfa = aCadena;
|FPRC;

|PROCESO ConverCliArt;
     |DDEFECTO #109;
     #109#0 = #1#4;
     #109#2 = #2#2;
     |LEE 000#109=;
     |SI FSalida = 0;
          enCliArt = 1;
     |SINO;
          enCliArt = 0;
          #109#3 = #109#2;    || pongo el original sino esta, asi no es
          #109#4 = #2#4;      ||/necesario condicionar la linea en el inf
     |FINSI;
|FPRC;


|PROCESO escanlinea;
     unid    = #16#4 * #2#5;
     descrip = #16#3;
     linea   = 1;
     |PRINT;
|FPRC;

|PROCESO xx;
     indtope=0
     |PARA ind=6;|SI ind>0;|HACIENDO ind=ind-1;
           descrip = #13ind;  |QBF descrip;
           |SI descrip ! vacio;
               indtope = ind + 1;
               ind     = 0;
           |FINSI;
     |SIGUE;

     |PARA ind = 1; |SI ind <i ndtope; |HACIENDO ind = ind + 1;
           descrip = #13ind;
           linea   = 0;
           |PRINT;
     |SIGUE;
|FPRC;

|PROCESO impdesam;|TIPO 0;
     |ABRE #13;
     #13#0=#2#27;
     |LEE 121#13=;
     |SI FSalida = 0;  |HAZ xx;  |FINSI;
     |LIBERA #13;
     |CIERRA #13;
|FPRC;

|PROCESO DesAmpli;
     |DDEFECTO #2;
     #2#3 = 0;      || Almacen
     #2#4 = #53#5;
     descrip = #2#4;

     enSwDA = 1;
     |PRINT;
     enSwDA = 0;
|FPRC;

|DEFBUCLE DesAmpli;
     #53#1;
     ;
     "P", #2#28, #2#0, #2#1, 0001;
     "P", #2#28, #2#0, #2#1, 9999;
     ;
     NULL, DesAmpli;
|FIN;

|PROCESO dsm00046;
     unid = #2#5 * #46#5;
     |PRINT;
|FPRC;

|DEFBUCLE dsm00046;
     #46#1;
     ;
     #2#28, #2#0, #2#1, 001;
     #2#28, #2#0, #2#1, 999;
     ;
     NULL, dsm00046;
|FIN;

|PROCESO ImpreNormal;
     enTiva = #2#14;
     efFiva = #1#1;
     |HAZ SacaIVA;

     |DDEFECTO #19;
     |ABRE #19;
     #19#0 = #2#2;
     |LEE 000#19=;
     |CIERRA #19;

     tolin   = #2#5 * #2#6;
     tolin   = tolin < #2#8;
     cant    = cant + tolin;

     descrip = #2#4;

     ||aAlfa = descrip; |HAZ QuitaRaros; descrip = aAlfa;
     ||ANSI_OEM descrip, descrip;
     |||HAZ TodosCar;

     linea   = 1;
     unid    = #2#5;
     codigo  = #2#2;
     enArtImp = #2#2; |QBF enArtImp;

     eaSerLog = #1#25;
     eaNumLog = (A\("000000" + #1#0) % -106);
     eaTipLog = "PV";
     |HAZ ImprimeLog;

     |HAZ ConverCliArt;

     |PRINT;
/*
     |SALVA_DATOS #2;
     |BUCLE DesAmpli;
     |REPON_DATOS #2;
*/
     |HAZ impdesam;
     |SI #142#16 = "S";
          eaArticulo = #2#2;
          |HAZ EsEscandallo;
          |SI FSalida = 0;
               |HAZ EsKit;
               |SI FSalida = 0;
                    enEscan = 2;
                    |BUCLE dsm00046;
               |SINO;
                    enEscan = 1;
                    |BUCLELIN 0escanlinea#15;
               |FINSI;
               enEscan = 0;
          |FINSI;
          |CIERRA #15;
     |FINSI;
|FPRC;

|PROCESO pedimprl;|TIPO 0;
     |SI #2#13 < #0#9;  |O #2#13 > #0#10;  |ACABA;  |FINSI;

     nSwPasa = 1;

     |HAZ ImpreNormal;
|FPRC;

|PROCESO IVAS;
     eaCli = #1#4;
     efFiva = #1#1;
     enTiva = 1; |HAZ IVACli; iva1 = enIva; re1 = enRec;
     enTiva = 2; |HAZ IVACli; iva1 = enIva; re1 = enRec;
     enTiva = 3; |HAZ IVACli; iva1 = enIva; re1 = enRec;
     enTiva = 4; |HAZ IVACli; iva1 = enIva; re1 = enRec;
     enTiva = 5; |HAZ IVACli; iva1 = enIva; re1 = enRec;
|FPRC;

|PROCESO pedimpr1;
     |HAZ IVAS;

     aMoneda = #pcegm004#37;
     aDivisa = #pcegm004#35;
     |HAZ Divisas104;

     |DDEFECTO #3;
     #3#0 = #1#4;
     |LEE 040#3=;

     |DDEFECTO #103;
     |ABRE #103;
     #103#0 = #1#4;
     #103#1 = #1#57;
     |LEE 000#103=;
     |CIERRA #103;

     |DDEFECTO #91;
     |ABRE #91;
     #91#0 = #1#9;
     |LEE 000#91=;
     |CIERRA #91;

     |DDEFECTO #11;
     |ABRE #11;
     #11#0 = #1#83;
     |LEE 000#11=;
     |CIERRA #11;

     |DDEFECTO #120;
     |ABRE #120;
     #120#0 = #1#60;
     |LEE 000#120=;
     |CIERRA #120;

     aNumFax = #1#72; |QBF aNumFax;
     aNumMail = #1#71; |QBF aNumMail;

     |SI #0#12 = "M"; |Y aNumMail = "";
          aAlfa = #1#25 + "/" + (("000000" + #1#0) % -106);
          aAlfa = "0000No se ha indicado Email en el pedido: " + aAlfa;
          |MENAV aAlfa;
          |ACABA;
     |FINSI;

     |SI #0#12 = "M"; |O #0#12 = "F";
          aFrom = "";
          |ABRE #11;
          #11#0 = #1#83;
          |LEE 000#11=;
          |SI FSalida = 0;
               aFrom = #11#1; |QBF aFrom;
          |FINSI;
          |SI aFrom = "";
               aAlfa = "0000Usuario: [" + #1#83 + "] sin direccion mail configurada";
               |MENAV aAlfa;
               |ERROR; |ACABA;
          |FINSI;
/*
          aAlfa = "";
          #11#0 = Usuario % 810;
          |LEE 000#11=;
          |SI FSalida = 0;
               aAlfa = #11#1; |QBF aAlfa;
          |FINSI;
          |SI aAlfa = "";
               aAlfa = "0000Usuario: [" + #11#0 + "] sin direccion mail configura, ni envia copia";
               |MENAV aAlfa;
          |SINO;
               aNumMail = aNumMail + ";" + aAlfa;
          |FINSI;
*/
          |CIERRA #11;
     |FINSI;

     |SI #0#12 = "F"; |Y aNumFax = "";
          aAlfa = #1#25 + "/" + (("000000" + #1#0) % -106);
          aAlfa = "0000No se ha indicado numero de fax en el pedido: " + aAlfa;
          |MENAV aAlfa;
          |ACABA;
     |FINSI;

     |ABRE #40;
     #40#26 = #1#25;
     |LEE 001#40=;
     |SI FSalida ! 0;  |DDEFECTO #40;  |FINSI;
     |CIERRA #40;

     |SI aInforme = "";
          informe = #40#0; |QBF informe;
          aInforme = informe;
     |SINO;
          informe = aInforme;
     |FINSI;

     aNomFic = #1#25+"-"+(("000000"+#1#0)%-106)+".pdf";|QBT aNomFic;
     |SI #0#12 = "F";
          aAsunto = "Pedido Numero:" +#1#25+"/"+(("000000"+#1#0)%-106);
          aMailNotifica = #11#1; |QBF aMailNotifica;
          Impresora = "Fax;-" + aNumFax + "*" + aMailNotifica + "&" + aAsunto;
          |IMPRE -1;
          |SI FSalida ! 0; |ERROR10; |ACABA;  |FINSI;
     |FINSI;
     |SI #0#12 = "M";
          aAsunto = "Pedido Numero:" +#1#25+"/"+(("000000"+#1#0)%-106);
          Impresora = "Correo;-" + aAsunto + "*" + aNumMail;
          |IMPRE -1;
          |SI FSalida ! 0; |ERROR10; |ACABA;  |FINSI;
     |FINSI;

     |INFOR aInforme;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |BUCLELIN 2pedimprl#1;

     #1#58 = "S";
     |GRABA 020#1a;

     |PIEINF;
     |FININF;
     |SI #0#12 ! "P"; |FINIMP; |FINSI;
|FPRC;

|DEFBUCLE agifa104e1;
     #1#1;
     58;
     #0#6 , #0#2,aDRei;
     #0#7 , #0#3,aHRei;
     e;
     NULL, pedimpr1;
|FIN;

|DEFBUCLE agifa104e2;
     #1#1;
     4, 1,58;
     #0#6 , #0#2 , #0#0 , #0#4,aDRei;
     #0#7 , #0#3 , #0#1 , #0#5,aHRei;
     e;
     NULL, pedimpr1;
|FIN;

|DEFBUCLE agifa104e3;
     #1#2;
     25, 0, 1,58;
     #0#0 , "     ",      0, #0#6 , #0#2 , #0#4,aDRei;
     #0#1 , "zzzzz", 999999, #0#7 , #0#3 , #0#5,aHRei;
     be;
     NULL, pedimpr1;
|FIN;

|PROCESO Tipo3;
     |SI #0#11 = "S";
          aDRei = " ";
          aHRei = "z";
     |SINO;
          aDRei = "N";
          aHRei = "N";
     |FINSI;

     |SI #0#12 = "P";
          Impresora = "CrystalReport";
          |IMPRE -1;
          |SI FSalida ! 0; |ACABA; |FINSI;
     |FINSI;

     |ABRE #3;
     |ABRE #109; |SELECT #2#109;
     |SI ser_ped = ""; |Y num_ped = 0;
         |SI #0#8 = "C";
             |BUCLE agifa104e3;
         |SINO;
             |BUCLE agifa104e1;
         |FINSI;
     |SINO;
         |BUCLE agifa104e2;
     |FINSI;
     |CIERRA #109;
     |CIERRA #3;

     |SI #0#12 = "P"; |FINIMP; |FINSI;
|FPRC;

|PROGRAMA;
     |DBASE aAlfa;
     aAlfa = aAlfa + "fich/";
     |PATH_DAT #41 aAlfa;
     |DFICE aAlfa;
     aAlfa = aAlfa % -205;
     |ABRE #41;
     #41#0 = aAlfa;
     |LEE 000#41=;
     |CIERRA #41;

     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |IP_REMOTO aIPRemoto;


     |SI ser_ped = ""; |Y num_ped = 0;
         eaImpresora = "";
         |CLS;
         |CABEZA "Imp.Pedidos";
         |DDEFECTO #0;
         |PINPA #0#0;
         |PINDA #0#0;
         |ENDATOS #1#0;
         |SI FSalida = 0;  |HAZ Tipo3;  |FINSI;
     |SINO;
         |SI eaImpresora = "***"; |ACABA; |FINSI;
         #0#6 = ser_ped;
         #0#7 = ser_ped;
         #0#2 = num_ped;
         #0#3 = num_ped;
         #0#4 = "01.01.0000";
         #0#5 = "31.12.9999";
         #0#9 = "01.01.0000";
         #0#10 = "31.12.9999";
         #0#11 = "S";
         #0#12 = eaTipoImp;
         |HAZ Tipo3;
     |FINSI;
|FPRO;
