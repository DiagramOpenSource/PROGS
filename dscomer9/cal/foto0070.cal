|FICHEROS;
     foto0070 #0;

     expor024 #1;        ||Cliente a importar
     agifa024 #11;

     expor019 #2;        ||Articulo a importar
     agifa019 #12;

     expor112 #3;        ||Proveedor a importar
     agifa112 #13;

     expor025 #4;        ||Comisionista a importar
     agifa025 #14;

     expor065 #5;        ||Historico Movimientos,
     agifa065 #15;

     expor001 #6;        ||Cod. Barras Mult.
     dsl00001 #16;

     foto0074 #50;       || Fichero CONTROL CAMINO EXPORT/IMPORT

     foto0x18 #118;      || Cabecera F
     foto0x19 #128;      || Cabecera R
     foto0015 #138;      || Cabecera Sobres

     foto0z18 #119;      || Lineas F
     foto0z19 #129;      || Lineas R
     foto0016 #139;      || Lineas Sobres
|FIN;

|VARIABLES;
     &eaNomDef = "";
     &enCamposDef = 0;
     n024 = 0; n019 = 0; n112 = 0; n025 = 0; n065 = 0; n001 = 0;
     n015 = 0; n016 = 0;
     ddx = "";
     fich = "";
     org = "";
     num = 0;
     bufer = 0;
     err = 0;
     fdes = "";
     des = "";
     fdef = "";
     def = "";
     exp = 0;

     desdec="      ";
     hastac="zzzzzz";
     desdea="                    ";
     hastaa="zzzzzzzzzzzzzzzzzzzz";
     desdep="    ";
     hastap="zzzz";
     desdecom="  ";
     hastacom="zz";
     desfecha="00.00.0000";
     hasfecha="31.12.2099";
     i=0;
     sist="";
     dirfich="";
     mandato="";
     mandato1="";
     mensaje1= "0000ATENCION No puedo abrir fichero de control EXPORT/IMPORT";
     mensaje2= "0000ATENCION Debe informar del CONTROL CAMINO EXPORT/IMPORT";
     path="";
     path1="";
     path2="";
     path3="";
     path4="";
     no="N";
     fecha="00.00.0000";
     copia="";
     si="S";
     blanco="                         ";
     blanco1="                    ";
     aexpor = "";
     aexpor2 = "";
     asystem = "";
     atgz = "";
     acopias = "";
|FIN;

||**********NO SE INCLUYEN ACUMULADOS

|PROCESO CodBarra;
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #16#1;
     |PARA i = 0; |SI i [ n001; |HACIENDO i = i + 1;
          #6i = #16i;
     |SIGUE;
     |GRABA 011#6n;
     |LIBERA #6;
     #16#4 = "S";
     #16#5 = #0#4;
     |GRABA 011#16a;     ||Graba el original
     |LIBERA #16;
|FPRC;

|PROCESO miracli;
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #11#0;
     |PARA i = 0; |SI i [ n024; |HACIENDO i = i + 1;
          #1i = #11i;
     |SIGUE;
     |GRABA 011#1n;
     |LIBERA #1;
     #11#175="S";
     #11#176=#0#4;
     |GRABA 011#11a;     ||Graba el original
     |LIBERA #11;
|FPRC;

|PROCESO miraarti;
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #12#0;
     |PARA i = 0; |SI i [ n019;|HACIENDO i = i + 1;
          #2i = #12i;
     |SIGUE;
     |GRABA 011#2n;
     |LIBERA #2;
     #12#123 = "S";
     #12#124 = #0#4;
     |GRABA 011#12a;     ||Graba el original
     |LIBERA #12;
|FPRC;

|PROCESO miraprove;
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #13#0;
     |PARA i = 0; |SI i [ n112; |HACIENDO i = i + 1;
          #3i = #13i;
     |SIGUE;
     |GRABA 011#3n;
     |LIBERA #3;
     #13#71 = "S";
     #13#72 = #0#4;
     |GRABA 011#13a;     ||Graba el original
     |LIBERA #13;
|FPRC;

|PROCESO miracomis;
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #14#0;
     |PARA i = 0; |SI i [ n025; |HACIENDO i = i + 1;
          #4i = #14i;
     |SIGUE;
     |GRABA 011#4n;
     |LIBERA #4;
     #14#54 = "S";
     #14#55 = #0#4;
     |GRABA 011#14a;     ||Graba el original
     |LIBERA #14;
|FPRC;

|PROCESO mirahis;
|SI #15#2 = "ES"; |O #15#2 = "SS"; |O #15#2 = "EV"; |O #15#2 = "ME"; |O #15#2 = "MS";|O #15#2 = "AC";|O #15#2 = "AV";|O #15#2 = "FC";
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #15#0;
     |PARA i = 0; |SI i [ n065; |HACIENDO i = i + 1;
          #5i = #15i;
     |SIGUE;
     |GRABA 011#5n;
     |LIBERA #5;
     #15#15 = "S";
     #15#16 = #0#4;
     |GRABA 011#15a;     ||Graba el original
     |LIBERA #15;
|FINSI;
|FPRC;

|PROCESO LineasF;
     |PARA i = 0; |SI i [ n016; |HACIENDO i = i + 1;
          #119i = #139i;
     |SIGUE;
     |GRABA 011#119n;
     |LIBERA #119;
|FPRC;

|DEFBUCLE LineasF;
  #139#1;
  ;
  #138#0,1;
  #138#0,999;
  be;
  NULL,LineasF;
|FIN;

|PROCESO LineasR;
     |PARA i = 0; |SI i [ n016; |HACIENDO i = i + 1;
          #129i = #139i;
     |SIGUE;
     |GRABA 011#129n;
     |LIBERA #129;
|FPRC;

|DEFBUCLE LineasR;
  #139#1;
  ;
  #138#0,1;
  #138#0,999;
  be;
  NULL,LineasR;
|FIN;

|PROCESO SobresF;
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #138#0;
     |PARA i = 0; |SI i [ n015; |HACIENDO i = i + 1;
          #118i = #138i;
     |SIGUE;
     |GRABA 011#118n;
     |ABRE #119;
     |BUCLE LineasF;
     |CIERRA #119;
     #138#17 = "S";
     |GRABA 011#138a;     ||Graba el original
     |LIBERA #138;
|FPRC;

|PROCESO SobresR;
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #138#0;
     |PARA i = 0; |SI i [ n015; |HACIENDO i = i + 1;
          #128i = #138i;
     |SIGUE;
     |GRABA 011#128n;
     |ABRE #129;
     |BUCLE LineasR;
     |CIERRA #129;
     #138#17 = "S";
     |GRABA 011#138a;     ||Graba el original
     |LIBERA #138;
|FPRC;


|DEFBUCLE 0;        ||CLientes #1
#11#1;
 175,176;
"      " , no,desfecha;
"zzzzzz" , no,hasfecha;
be;
NULL,miracli;
|FIN;

|| Articulos
|DEFBUCLE 1;
#12#1;
123;
"                    ", no;
"zzzzzzzzzzzzzzzzzzzz", no;
be;
NULL,miraarti;
|FIN;

|DEFBUCLE 2;        ||Proveedor #3
 #13#1;
 71,72;
"    " , no,desfecha;
"zzzz" , no,hasfecha;
be;
NULL,miraprove;
|FIN;

|DEFBUCLE 3;        ||Comisionista #4
#14#1;
 54,55;
"  " , no,desfecha;
"zz" , no,hasfecha;
be;
NULL,miracomis;
|FIN;

|DEFBUCLE 4;        ||Historico
#15#1;
15;
"                    ", "01.01.1900", "  ", 000000, 00000, "  ", "N";
"zzzzzzzzzzzzzzzzzzzz", "31.12.9999", "zz", 999999, 99999, "zz", "N";
be;
NULL,mirahis;
|FIN;

|DEFBUCLE CodBarra;
     #16#1;
     4,5;
     0000001, no,desfecha;
     9999999, no,hasfecha;
     be;
     NULL, CodBarra;
|FIN;

|DEFBUCLE SobresF;
  #138#3;
  ;
  #0#16,#0#14,"F",#0#12,"N";
  #0#17,#0#15,"F",#0#13,"N";
  be;
  NULL,SobresF;
|FIN;

|DEFBUCLE SobresR;
  #138#3;
  ;
  #0#22,#0#20,"R",#0#18,"N";
  #0#23,#0#21,"R",#0#19,"N";
  be;
  NULL,SobresR;
|FIN;


|PROCESO inicio;|TIPO 3;
     |HAZ BusCampos;
     |SI err ! 0;
          |MENAV "0000Proceso Abortado...";
          |ACABA;
     |FINSI;

     |DFICE dirfich; |QBF dirfich;      ||Directorio de la empresa
     |QUE_SISTEMA sist;  |QBF sist;
     || Averiguo el path que tengo indicado en el fichero CONTROL CAMINO EXPORT/IMPORT
     |ABRE #50;
     |SI FSalida ! 0;        || Por si hubiera un desastre en el disco duro
         |MENAV mensaje1;
         |ERROR;
         |ACABA;
     |FINSI;

     |LEE 001#50p;
     path=#50#1;
     |QBF path;
     |SI path = "";   || Si no habia nada informado, debo indicar que lo ponga bien
          |MENAV mensaje2;
          |ERROR;
          |ACABA;
     |FINSI;

     |CIERRA #50;

     |PATH_DAT #1 path;
     |ABRE #1;
     |SI FSalida ! 0;
          |MENAV "0000Error: No se encuentra el path definido";
          |ERROR;
          |ACABA;
     |SINO;
          |CIERRA #1;
     |FINSI;
     ||Clientes
     |SI #0#5="S";|O #0#5="s";
          |PINTA 2124 , blanco;
          |PINTA 2124 , "Clientes";
          |PATH_DAT #1 path;   || Marco camino de clientes exportacion
          |ABRE #1;  |CIERRA #1;
          |DELINDEX #1;
          |ABRE #1;
          |BUCLE 0;
          |LIBERA #1;
          |CIERRA #1;
     |FINSI;

     ||Articulo
     |SI #0#6="S";|O #0#6="s";
          |PINTA 2124 , blanco;
          |PINTA 2124 , "Articulos";
          |PATH_DAT #2 path;   || Marco camino de articulos exportacion
          |ABRE #2;
          |CIERRA #2;
          |DELINDEX #2;
          |ABRE #2;
          |BUCLE 1;
          |LIBERA #2;
          |CIERRA #2;
     |FINSI;
     ||Proveedores
     |SI #0#7="S";|O #0#7="s";
          |PINTA 2124 , blanco;
          |PINTA 2124 , "Proveedores";
          |PATH_DAT #3 path;   || Marco camino de proveedores exportacion
          |ABRE #3;
          |CIERRA #3;
          |DELINDEX #3;
          |ABRE #3;
          |BUCLE 2;
          |LIBERA #3;
          |CIERRA #3;
     |FINSI;

     ||Comisionistas
     |SI #0#8="S";|O #0#8="s";
          |PINTA 2124 , blanco;
          |PINTA 2124 , "Comisionistas";
          |PATH_DAT #4 path;   || Marco camino de comisionistas exportacion
          |ABRE #4;
          |CIERRA #4;
          |DELINDEX #4;
          |ABRE #4;
          |BUCLE 3;
          |LIBERA #4;
          |CIERRA #4;
     |FINSI;

     ||Historico
     |SI #0#9="S";|O #0#9="s";
          |PINTA 2124 , blanco;
          |PINTA 2124 , "Historico    ";
          |PATH_DAT #5 path;   || Marco camino de historico  exportacion
          |ABRE #5; |CIERRA #5; |DELINDEX #5;
          |ABRE #5;
          |BUCLE 4;
          |LIBERA #5;
          |CIERRA #5;
     |FINSI;

     ||Barras
     |SI #0#10 = "S";|O #0#10="s";
          |PINTA 2124 , blanco;
          |PINTA 2124 , "Cod. Barras  ";
          |PATH_DAT #6 path;   || Marco camino de historico  exportacion
          |ABRE #6; |CIERRA #6; |DELINDEX #6;
          |ABRE #6;
          |BUCLE CodBarra;
          |LIBERA #6;
          |CIERRA #6;
     |FINSI;

     ||SobresF. davith,------------------------------------------------------
     |SI #0#11 = "S";|O #0#11 = "s";
       |PINTA 2124, blanco;
       |PINTA 2124, "Sob. fact.";
       |PATH_DAT #118 path;|PATH_DAT #119 path;
       |ABRE #118;|CIERRA #118;|DELINDEX #118; ||Cabecera F
       |ABRE #119;|CIERRA #119;|DELINDEX #119; ||Lineas F
       |ABRE #118;
       |BUCLE SobresF;
       |LIBERA #118;
       |CIERRA #118;
     |FINSI;

     ||SobresR
     |SI #0#24 = "S";|O #0#24 = "s";
       |PINTA 2124, blanco;
       |PINTA 2124, "Sob. recog.";
       |PATH_DAT #128 path;|PATH_DAT #129 path;
       |ABRE #128;|CIERRA #128;|DELINDEX #128; ||Cabecera R
       |ABRE #129;|CIERRA #129;|DELINDEX #129; ||Lineas R
       |ABRE #128;
       |BUCLE SobresR;
       |LIBERA #128;
       |CIERRA #128;
     |FINSI;

     |HAZ Compresion;
     |CONFI "0000Enviar exportacion a TPV ahora: ";
     |SI FSalida=0;
          |MENAV "0000Atencion!! Debe estar conectado a Internet";
          |SUB_EJECUTA "foto0100.tab";
     |FINSI;
|FPRC;

=======================================================================
|PROCESO LeeDDX;
     fdef = def + fich; fdes = org + fich;
     |LEEDEDEF fdef, fdes;
     |SI exp = 1; |Y FSalida = -1;
          fich = fdes + ".dat"; |FBORRA fich;
          fich = fdes + ".ixx"; |FBORRA fich;
          fich = fdes + ".ddx"; |FBORRA fich;
          |LEEDEDEF fdef, fdes;
          |MENAV "0000Fichero exportacion reparado...";
     |FINSI;
     eaNomDef = fich;
     |HAZ CamposDef;
     num = enCamposDef;
|FPRC;

|PROCESO BusCampos;
     |DFICE org; |QBF org;
     |DBASE des; |QBF des;
     |DDEF  def; |QBF def;
     err = 0;

     exp = 0; fich = "agifa024"; |HAZ LeeDDX; n024 = num;
     exp = 1; fich = "expor024"; |HAZ LeeDDX;
     |SI n024 ! num;
          |MENAV "0000Fichero enlace Clientes incorrecto..."; err = 1;
     |FINSI;

     exp = 0; fich = "agifa019"; |HAZ LeeDDX; n019 = num;
     exp = 1; fich = "expor019"; |HAZ LeeDDX;
     |SI n019 ! num;
          |MENAV "0000Fichero enlace Articulos incorrecto..."; err = 1;
     |FINSI;

     exp = 0; fich = "agifa112"; |HAZ LeeDDX; n112 = num;
     exp = 1; fich = "expor112"; |HAZ LeeDDX;
     |SI n112 ! num;
          |MENAV "0000Fichero enlace Proveedores incorrecto..."; err = 1;
     |FINSI;

     exp = 0; fich = "agifa025"; |HAZ LeeDDX; n025 = num;
     exp = 1; fich = "expor025"; |HAZ LeeDDX;
     |SI n025 ! num;
          |MENAV "0000Fichero enlace Comisionistas incorrecto..."; err = 1;
     |FINSI;

     exp = 0; fich = "agifa065"; |HAZ LeeDDX; n065 = num;
     exp = 1; fich = "expor065"; |HAZ LeeDDX;
     |SI n065 ! num;
          |MENAV "0000Fichero enlace Historico incorrecto..."; err = 1;
     |FINSI;

     exp = 0; fich = "dsl00001"; |HAZ LeeDDX; n001 = num;
     exp = 1; fich = "expor001"; |HAZ LeeDDX;
     |SI n001 ! num;
          |MENAV "0000Fichero enlace Cod. Barra incorrecto..."; err = 1;
     |FINSI;

     exp = 0; fich = "foto0015"; |HAZ LeeDDX; n015 = num;
     exp = 1; fich = "foto0x18"; |HAZ LeeDDX;
     |SI n015 ! num;
          |MENAV "0000Fichero enlace Cab. Sobres incorrecto..."; err = 1;
     |FINSI;
     exp = 1; fich = "foto0x19"; |HAZ LeeDDX;
     |SI n015 ! num;
          |MENAV "0000Fichero enlace Cab. Sobres incorrecto..."; err = 1;
     |FINSI;

     exp = 0; fich = "foto0016"; |HAZ LeeDDX; n016 = num;
     exp = 1; fich = "foto0z18"; |HAZ LeeDDX;
     |SI n016 ! num;
          |MENAV "0000Fichero enlace Lin. Sobres incorrecto..."; err = 1;
     |FINSI;
     exp = 1; fich = "foto0z19"; |HAZ LeeDDX;
     |SI n016 ! num;
          |MENAV "0000Fichero enlace Lin. Sobres incorrecto..."; err = 1;
     |FINSI;
|FPRC;

|PROCESO DefectosF;         ||davith. Bloquea los campos segun el valor entrado
                            ||en SobresF.
|SI #0#11 = "N";|O #0#11 = "n"; ||No quiero exportar sobres facturados.
     |C_M #0#12, 1 , "N";
     |C_M #0#13, 1 , "N";
     |C_M #0#14, 1 , "N";
     |C_M #0#15, 1 , "N";
     |C_M #0#16, 1 , "N";
     |C_M #0#17, 1 , "N";
|SINO;
     |C_M #0#12, 1 , "S";
     |C_M #0#13, 1 , "S";
     |C_M #0#14, 1 , "S";
     |C_M #0#15, 1 , "S";
     |C_M #0#16, 1 , "S";
     |C_M #0#17, 1 , "S";
|FINSI;
|FPRC;

|PROCESO DefectosR;         ||davith. Bloquea los campos segun el valor entrado
                            ||en SobresR.
|SI #0#24 = "N";|O #0#24 = "n"; ||No quiero exportar sobres recogidos.
     |C_M #0#18, 1 , "N";
     |C_M #0#19, 1 , "N";
     |C_M #0#20, 1 , "N";
     |C_M #0#21, 1 , "N";
     |C_M #0#22, 1 , "N";
     |C_M #0#23, 1 , "N";
|SINO;
     |C_M #0#18, 1 , "S";
     |C_M #0#19, 1 , "S";
     |C_M #0#20, 1 , "S";
     |C_M #0#21, 1 , "S";
     |C_M #0#22, 1 , "S";
     |C_M #0#23, 1 , "S";
|FINSI;
|FPRC;

|PROCESO Compresion;
     |MENSA "0000Comprimiendo los datos...";
     aexpor = path + "exporce";
     |QBF aexpor;
     atgz = aexpor + ".tgz";

     aexpor = aexpor + ".tar";
     |QBF aexpor;
     aexpor2 = aexpor + " *.*";
     |FBORRA atgz; ||Borro el anterior tgz
     |ATAR aexpor2,path;
     |COMPRIME aexpor;
     |SI FSalida = 0;
        |QUE_SISTEMA asystem;
        acopias = path + "copiasex";
        |MKDIR acopias;
        acopias = acopias + "/ex" + #0#4 + ".tgz";
        |FBORRA acopias; ||Borro si hay copia ant misma fecha
        |COPIA_FICHERO atgz,acopias;
        |SI asystem = "ESBSD";
            asystem = "chmod 777 " + path + "copiasex";
            |SYSTEM asystem;
            asystem = "chmod 777 " + atgz;
            |SYSTEM asystem;
            asystem = "chmod 777 " + acopias;
            |SYSTEM asystem;
        |FINSI;
        |FBORRA aexpor;  ||Borro el tar
        aexpor = path + "testigo.dat";
        |FBORRA aexpor;
        aexpor = path + "testigo.ddx";
        |FBORRA aexpor;
        aexpor = path + "testigo.ixx";
        |FBORRA aexpor;
        |PARA i=1;|SI i < 100;|HACIENDO i = i +1;
            aexpor = path + "expor00" + i;
            aexpor2 = aexpor + ".dat";
            |FBORRA aexpor2;
            aexpor2 = aexpor + ".ixx";
            |FBORRA aexpor2;
            aexpor2 = aexpor + ".ddx";
            |FBORRA aexpor2;
        |SIGUE;
        |PARA i=10;|SI i < 100;|HACIENDO i = i +1;
            aexpor = path + "expor0" + i;
            aexpor2 = aexpor + ".dat";
            |FBORRA aexpor2;
            aexpor2 = aexpor + ".ixx";
            |FBORRA aexpor2;
            aexpor2 = aexpor + ".ddx";
            |FBORRA aexpor2;
        |SIGUE;
        |PARA i=100;|SI i < 1000;|HACIENDO i = i +1;
            aexpor = path + "expor" + i;
            aexpor2 = aexpor + ".dat";
            |FBORRA aexpor2;
            aexpor2 = aexpor + ".ixx";
            |FBORRA aexpor2;
            aexpor2 = aexpor + ".ddx";
            |FBORRA aexpor2;
        |SIGUE;
        aexpor= path + "foto0x18";
        aexpor2 = aexpor + ".dat";
        |FBORRA aexpor2;
        aexpor2 = aexpor + ".ixx";
       |FBORRA aexpor2;
        aexpor2 = aexpor + ".ddx";
        |FBORRA aexpor2;
        aexpor= path + "foto0z18";
        aexpor2 = aexpor + ".dat";
        |FBORRA aexpor2;
        aexpor2 = aexpor + ".ixx";
        |FBORRA aexpor2;
        aexpor2 = aexpor + ".ddx";
        |FBORRA aexpor2;
        aexpor= path + "foto0x19";
        aexpor2 = aexpor + ".dat";
        |FBORRA aexpor2;
        aexpor2 = aexpor + ".ixx";
        |FBORRA aexpor2;
        aexpor2 = aexpor + ".ddx";
        |FBORRA aexpor2;
        aexpor= path + "foto0z19";
        aexpor2 = aexpor + ".dat";
        |FBORRA aexpor2;
        aexpor2 = aexpor + ".ixx";
        |FBORRA aexpor2;
        aexpor2 = aexpor + ".ddx";
        |FBORRA aexpor2;
     |SINO;
        |MENAV "0000Error comprimiendo los datos";
     |FINSI;
|FPRC;
