|FICHEROS;
     agifa501 #0;             ||Entrada Tiquets (C)
     agifa019 #2;             ||Articulos
     agifa500 #3,MANTE;       ||Pantalla Entrada a Cobrar EURO/PTAS
     agifa506 #300;           ||Pantalla Entrada a Cobrar EURO
     agifa505 #4;             ||Parametros CAJA
     agifa027 #5;             ||clavecontaes
     agifa510 #7;             ||Fichero Horarios
     agifa509 #8;             ||Resumen diario
     agifa084 #12;            ||Factura Contado
     agifa069 #13;            ||Factura Contado Lineas
     agifa024 #14;            ||Fichero de Clientes
     agifa010 #16;            ||Albaranes
     agifa071 #17;            ||Albaranes Lineas
     agifa515 #19;            ||Fichero tarjetas de credito
     agifa516 #20;            ||Fichero Resumen tarjetas de credito
     agifa514 #21;            ||Fichero de Cajeros
     dsw00027 #27,MANTE;
     dsw00028 #28,MANTE;
     agifa517 #30;            ||Parametros Tp.V
     agifa554 #33,MANTE;            ||Pantalla Captura datos Alb/Fra
     agifa017 #34;            ||Almacenes
     agifa571 #35;            ||Fichero de Creditos
     agifa572 #36;            ||Lineas de Creditos
     agifa576 #41;            ||Pantalla numeros grandes
     agifa577 #42;            ||Pantalla Entrada a Cobrar numeros grandes
     agifa007 #43;            ||Series
     agifa508 #51;            ||Documentos Borrados
     dsm00058 #58;
     dsm00060 #60;
     dsm00061 #61;
     dsm00062 #62;
     dsm00063 #63;
     dsw00067 #67;            || Tmp Tarifa Cliente
     agifa142 #142;
     agifa204 #204;
     agifa513 #513;
     dsm00010 #910;
     dsm00005 #905;
     dsm00006 #906;
     dsm00051 #951;
     dsm00047 #947;
     dsm00048 #948;
     agifa324;       || Divisas
     agifa321;       || Parametros divisas
     tmp00501@ #100;
     agifa501@ #101;
|FIN;

|VARIABLES;
     &enPdtVale = 0;
     &enIva1 = 0;
     &enIva2 = 0;
     &enIva3 = 0;
     &enIva4 = 0;
     &enIva5 = 0;
     &enRec1 = 0;
     &enRec2 = 0;
     &enRec3 = 0;
     &enRec4 = 0;
     &enRec5 = 0;
     aMensaje = "";
     nBase = 0;
     &eaSerPro = "";
     &enNumPro = "";
     &eaSerExp = "";
     &enSwMenu = 0;
     &enSwSematel = 0;
     &eaSerIMEI = "";
     &enDocIMEI = 0;

     aTComi = "";
     aRepre = "";
     nNume = 0;
     &eaModiUniTpv = "";
     nValor9 = 0;
 {-1}aMenuCli = "";
     aMenuCli1 = "2400";
     aMenuCli2 = "1";
     aMenuCli3 = "Contador:  ";
     aMenuCli4 = "AM";
     aMenuCli5 = " Automatico ";
     aMenuCli6 = " Manual ";
     &enTariCli = 0;
     nDCajero = 0;
     nHCajero = 0;
     nCampos = 0;
     nHay = 0;
     aDef = "";
     nError = 0;
     &enNumAparca = 0;
     &enCambio      = 0;
     aSerBloq       = "";
     nNumBloq       = 0;
     &aDivisa = "";
     &aMoneda = "";
     &EURODB   = 0;
     &eaEsEuro = "";
     &nSwCajaModi = 0;
     &Tempo       = "";
     aTempo28     = "";
     aTempo27     = "";
     &enClaveCajon = 0;
     &nDeci_PreBase = 0;
     &nDeci_PreBaseMx = 0;
     &nDeci_PreVis = 0;
     &eaTag = "";
     &nRieTotal = 0;
     &nRieUtili = 0;
     &aRieBloqu = "";
     &aBloquead = "";

     &aDef11   = "";
     &aDef22   = "";
     &enHayIMEI= 999;
     nTecla   = 0;
     aNomModulo = "";
     aSer     = "";
     nSwFin   = 0;
     nModo    = 0;
     &aClave  = "";
     nRiesgo  = 0;
     aOpe     = "";
     nCambio  = 0;
     aAlfa    = "";
     imneto   = 0;
     mes      = 0;
     fmes     = "";
     nMargen  = 0;
     nForma   = 0;
     nDto     = 0;
     Tefe = 0; Ttar = 0; Tche = 0; Tdeu = 0; Tres = 0; Tdes = 0; nImpo = 0;
     FicPant  = "";
     SerAnt   = "";
     DocAnt   = "";
     nGuarda  = 0;
     nu1      = 0;
     nu2      = 0;
     alf1     = "";
     &xSer    = "";
     &xAlb    = 0;
     &credito = "";
     &aparcar = 0;
     &TVisor = 0;
     &cVisor = "";
     &salida  = 0;
     cambio_tarjeta = "";
     alfa_oper = "";
     vacio = "";
     tarjetas  = "";
     beta      = 0;
     bet0      = 0;
     longi     = "";
     form0     = "";
     text0     = "";
     pos0      = 0;
     lon0      = 0;
     cam0      = 0;
     long      = 0;
     cSerie    = "";
     nEstado   = 0;
     cabeza    = 0;
     &impr_tpv = "";
     &impr_dis = "";
     f             = "";
     ErrorTarjeta  = 0;
     memo_tarjeta  = "";
     &ferr_tarjeta = "";
     &oper_tarjeta = "";
     &bat_tarjeta  = "";
     &c_alter      = "";
     &forma        = "";
     &abre_dis     = "";
     &cier_dis     = "";
     &mens_dis     = "";
     texto         = "";
     actu_dia = " ";
     &diferido = " ";
     alfa11 = "";
     cabtick = "";
     lintick = "";
     virtual = "";
     camino = "";
     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     alfa4 = "";
     nume1 = 0;
     nume2 = 0;
     nume3 = 0;
     nume4 = 0;
     para1 = 0;
     para2 = 0;
     para3 = 0;
     para4 = 0;
     base  = "";
     nombre = "";
     alfa = "";
     &ser_alb                 = "";
     &num_alb                 = 0;
     &ser_fac                 = "";
     &num_fac                 = 0;
     &serie = "";
     &fecha = @;
     &numero = 0;
     &reimpr = "";
     {-1}menu                 = "";
     menu1                    = "2400";
     menu2                    = "1";
     menu3                    = "Tipo DOCUMENTO: ";
     menu4                    = "TAF";
     menu5                    = " Tiquet ";
     menu6                    = " Albaran ";
     menu7                    = " Factura ";
     aparam                   = "";
     aprograma                = "";
     puente_a                 = "";
     mensaje                  = "";
     claveconta               = "vtiquet";
     conta_reg                = 0;
     sistema                  = "";
     total                    = "";
     mens                     = "";
     operacion                = "";
     aparcado                 = "N";
     &acaja                   = 0;
     &modo_c                  = 0;
     &almacen                 = 0;
     &n_linea                 = 0;
     &salmenu                 = 0;      ||si es 998 es un tiquet aparcado
     &sw_carga                = 0;
     modo                     = 0;
     tipo                    = 0;
     puente_n                 = 0;
     i                        = 0;
     j                        = 0;
     periodo                  = 0;
     sw_entrada               = 0;
     &empresa                  = 0;
     nparam                   = 0;
     niva                     = 0;    || *(3)
     &afecha                  = "";
     ntipo_menu               = 0;
     aop_defec                = "";
     atmp                     = "";
     &exporta                 = "";   || Lo utilizo en agifa502
     atipo                    = "";
     ntipo_por                = 0;
     ncant_por                = 0;
     ntmp                     = 0;
     acif                     = "";
     anombre                  = "";
     impresora                = "";
     infocab                  = "";
     infolin                  = "";
     infopie                  = "";
     alfai                    = "";
     alfai2                   = "";
     alfai3                   = "";
     numei                    = 0;
     numei2                   = 0;
     ind                      = 0;
     impo_dis                 = 0;

     {-1}cmenu                = "";
     cmenu1                   = "2400";
     cmenu2                   = "1";
     cmenu3                   = "RESTO: ";
     cmenu4                   = "CD";
     cmenu5                   = "Credito";
     cmenu6                   = "Descuento";
     descu                    = 0;
{100}C1_                      = "";
{100}C2_                      = "";
     nCab                     = 65;          || CAMPOS DE LA CABECERA
     clave_fa                 = "";
     aAlfa1                   = "";
     nPuntos                  = 0;
     nLin                     = 0;
     nImpVale                 = 0;
     nImpCobro                = 0;
     nPend                    = 0;
     nRes                     = 0;
     fGuarda                  = @;
     nNume1                   = 0;

     &enDescuento1 = 0;
     &enDescuento2 = 0;
     &eaTComision  = "";
     &uni_dt        = 0;
     &enComision    = 0;
|FIN;

|INCLUYE i_varart;

|PROCESO PintaVisor;
     |SI #4#31 = "S";
          |SI #4#157 = "S";
               TVisor = #0#9;
          |SINO;
               TVisor = #0#20 + #0#23 + #0#26 + #0#30 + #0#48 + #0#51;
          |FINSI;
          |HAZ Numero;
     |SINO;
          |PINTA #0#9;
     |FINSI;
|FPRC;

|PROCESO t66; |TIPO 66;
     nGuarda = FEntrada;
     ||HAZ llena_c4;
     |PUSHV 0101 2380;
     |CLS;
     |ABRE #14;
     #14#0 = #0#1;
     |LEE 000#14=;
     |SI #4#119 = "T";
          |PINPA #0#14;
          |PINDA #0#14;
          |CONSULTA #0#14;
          |SI FSalida = 0;
               #0#1 = #14#0;
          |FINSI;
     |SINO;
          |CONSULTA_CLAVE #1#14;
          |SI FSalida = 0;
               #0#1 = #14#0;
               |PINPA #0#14;
               |PINDA #0#14;
               |PAUSA;
          |FINSI;
     |FINSI;
     |CIERRA #14;
     |POPV;
     |ERROR;
     FEntrada = nGuarda;
|FPRC;

|PROCESO control_cli; |TIPO 6;
     |SI #4#120 = "N";
          |ABRE #14;
          #14#0 = #0#1;
          |LEE 000#14=;
          |SI FSalida ! 0;
               |MENAV "0000Cliente inexistente...";
               |ERROR;
          |FINSI;
          |CIERRA #14;
     |FINSI;
|FPRC;

|PROCESO credi_cli; |TIPO 0;
     |ABRE #35;
     #35#0 = #0#1;
     |LEE 000#35=;
     |SI FSalida = 0; |Y #35#4 ! 0;
          |ATRI S; |PINTA 936, "Cliente"; |ATRI 0;
     |SINO;
          |ATRI N; |PINTA 936, "Cliente"; |ATRI 0;
     |FINSI;
     |CIERRA #35;
     |PINTA  #0#29;
|FPRC;

|PROCESO pan; |TIPO 14;
     |SI #4#31 = "S";
          |C_M #0#9 , 1 , "N";
          |C_V #0#9 , 1 , "N";
          |HAZ tipo5;
          |PINPA #0#41;
          |ATRI 0;
          |HAZ PintaVisor;
          |ATRI I;
     |FINSI;
|FPRC;

|PROCESO tipo5; |TIPO 5;
     |SI #4#109 = "S";   || Precio con IVA
          |C_M #1#6, 1, "S"; |C_V #1#6, 1, "S";  |C_P #1#6, 0, nume1;
          |C_M #1#10, 1, "N"; |C_V #1#10, 1, "N";|C_P #1#10, 1, nume1;

          |C_M #1#7, 1, "S"; |C_V #1#7, 1, "S";  |C_P #1#7, 0, nume1;
          |C_M #1#21, 1, "N"; |C_V #1#21, 1, "N";|C_P #1#21, 1, nume1;
     |SINO;
          |C_M #1#6, 1, "N"; |C_V #1#6, 1, "N";  |C_P #1#6, 0, nume1;
          |C_M #1#10, 1, "S"; |C_V #1#10, 1, "S";|C_P #1#10, 1, nume1;

          |C_M #1#7, 1, "N"; |C_V #1#7, 1, "N";  |C_P #1#7, 0, nume1;
          |C_M #1#21, 1, "S"; |C_V #1#21, 1, "S";|C_P #1#21, 1, nume1;
     |FINSI;
     FSalida = "SINBARRA";
|FPRC;


||_____________________________________/ JUSTO AL ENTRAR EN EL PROGRAMA
|| Si en la llamada a este programa hemos puesto como parametro un numero este
|| sera el numero de returns que queremos con el objeto de ahorrar tiempo
|PROCESO ptecs;
     || De momento lo hacemos con esta chapuza, con el nuevo basico la variable
     || PARAMETRO solo  contiene el parametro
     aparam = PARAMETRO;
     |QBF aparam;
     |MODULO aprograma;
     |QBF aprograma;
     aprograma= aprograma + ".run";

     aparam = aparam - aprograma;
     |QBF aparam;

     nparam = aparam;
     |PARA i = 1;|SI i [ nparam;|HACIENDO i = i +1;
         |PTEC 802;
     |SIGUE;
|FPRC;

|PROCESO empieza; |TIPO 8;
     |HAZ ptecs;
     |ABRE #4;              ||Cargo los valores de Parametros CAJA
     #4#0 = acaja;
     |LEE 001#4=;
     |CIERRA #4;
     c_alter = #4#88;
     cVisor  = #4#86;
     eaModiUniTpv = #4#10;
     |HAZ InicioVisor;
     |HAZ lee_514;
     |ABRE #30;              ||Cargo los Valores de Parametros TPV
     |LEE 001#30p;
     |CIERRA #30;
     tarjetas = #30#12;
     almacen  = #4#87;
     diferido = #30#6;
     actu_dia = #30#7;
     |HAZ lee_horario;
     |DFICE puente_a;         |QBF puente_a;
     puente_a = puente_a % -205;
     empresa = puente_a;
     |ABRE #910; |LEE 000#910p; |CIERRA #910;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     |SI #142#26 = "S";
          clave_fa = "vfactura";
     |SINO;
          clave_fa = "vfactuco";
     |FINSI;

     |HAZ caldecim;
|FPRC;

||_______________________________________/ CALCULOS DESDE CAMPOS TIPOS 6

|PROCESO infc;
     #0#35 = "N";
     #0#57 = "     ";
     #0#58 = 000000;
|FPRC;

|PROCESO supc;
     #0#35 = "N";
     #0#57 = "zzzzz";
     #0#58 = 999999;
|FPRC;

|PROCESO inft;
     #0#35 = " ";
     #0#57 = "     ";
     #0#58 = 000000;
     #0#36 = "     ";
     #0#0 = 000000;
|FPRC;

|PROCESO supt;
     #0#35 = "z";
     #0#57 = "zzzzz";
     #0#58 = 999999;
     #0#36 = "zzzzz";
     #0#0 = 999999;
|FPRC;

|PROCESO salir; |TIPO 6;
     nTecla = FSalida;
     nModo = (FEntrada / 100) ! 0;
     |SI Campo = 1; |HAZ AltaCli; |FINSI;
     |ABRE #14;
     #14#0 = #0#1;
     |LEE 000#14=;
     |CIERRA #14;
     enTariCli = #14#39;
     |SI nTecla = 10;                        || Aparcados
          |SI nModo ! 4;
               |MENAV "0000Opcion solo en Consulta...";
               |ERROR; |ACABA;
          |FINSI;
          |SELECT #2#0;
          #0#35 = "N";
          #0#57 = "";
          #0#58 = 0;
          |LEE 000#0];
          |SI #0#35 = "N"; |Y FSalida = 0;
               |PUSHV 0101 2380;
               |CONSULTA_F_CLAVE #2#0, infc, supc;
               |SI FSalida = 0;
                    |SELECT #1#0;
                    |LEE 000#0=;
                    |SI #0#35 = "N";    || Me aseguro que es aparcado
                         |PTEC 802;
                    |FINSI;
               |FINSI;
               |POPV;
          |SINO;
               |MENAV "0000No hay tiquets aparcados...";
          |FINSI;
          |ERROR;
          |SELECT #1#0;
     |FINSI;

     |SI nTecla = 11;                   ||Cajon
          |HAZ AbreCajon;
          |ERROR;
     |FINSI;

     |SI nTecla = 12; |O nTecla = 13;    ||Consulta
          |C_M #0#35, 1, "S";
          |C_M #0#57, 1, "S";
          |C_M #0#58, 1, "S";
        ||  |SELECT #3#0;
        ||  #0#14 = afecha;
        ||  |LEE 000#0];
          |SI nTecla = 13;
               |SELECT #1#0;
               |LEE 000#0];
               |CONSULTA_F_CLAVE #1#0, inft, supt;
          |SINO;
               |SELECT #2#0;
               |LEE 000#0];
               |CONSULTA_F_CLAVE #2#0, inft, supt;
          |FINSI;
          |SI FSalida = 0;
               |LEE 000#0=;
               |PTEC 802;
          |FINSI;
          |SELECT #1#0;
          |C_M #0#35, 1, "N";
          |C_M #0#57, 1, "N";
          |C_M #0#58, 1, "N";
          |ERROR;
     |FINSI;
     FSalida = nTecla;
|FPRC;

|PROCESO SelecTariCli;
     |ABRE #67;
     |PARA i = 1; |SI i [ 6; |HACIENDO i = i + 1;
          aAlfa = "Tarifa N§: " + i;
          #67#0 = i;
          #67#1 = aAlfa;
          |LEE 000#67=;
          |SI FSalida ! 0; |GRABA 020#67n; |FINSI;
     |SIGUE;
     #67#0 = enTariCli;
     |LEE 000#67];
     |CONSULTA_CLAVE #1#67;
     |SI FSalida = 0;
           enTariCli = #67#0;
     |FINSI;
     |CIERRA #67;
|FPRC;

||_______________________________________/ CALCULOS DESDE CAMPOS TIPOS 7
|PROCESO ant_reg; |TIPO 7;         ||Se llama antes de entrar a la serie
     |HAZ tipo5;
     modo = (FEntrada / 100) ! 0;
     modo_c = modo;
     |C_M #1#1 , 1 , "S";
     |SI #4#31 = "S"; |Y sw_entrada = 0;
          |C_M #0#9 , 1 , "N";
          |C_V #0#9 , 1 , "N";
          |PINPA #0#41;
          |HAZ PintaVisor;
          sw_entrada = 1;
     |FINSI;
     |SI modo = 1;                    ||Solamente en alta
          |C_M #0#57, 1, "N";
          |C_M #0#58, 1, "N";
          |HORA puente_a;
          #0#34 = puente_a; ||Cargo la hora en que se hace el tiquet
          |PINTA #0#34;
          mensaje = "0000ATENCION la hora no esta entre los limites definidos en HORARIOS";
          puente_a = (puente_a % 102) + (puente_a % 402);
          puente_n = puente_a;
          |HAZ horario;
          |SI mensaje ! "";
               |MENAV mensaje;
               |PTEC 807;          ||Tengo que provocar un Ctrl + C
          |SINO;
               #0#36 = #4#112; || ­­­ QUIEN LO CAMBIE LE CORTO LA MANO !!!
               #0#0 = 999999;
               |LEE 000#0];
               |SI FSalida = 0;
                    |LEE 000#0a;
               |SINO;
                    |LEE 000#0u;
               |FINSI;
               |SI FSalida = 0; |Y #0#36 = #4#112;
                    beta = #0#0 + 1;
               |SINO;
                    beta = 1;
               |FINSI;
               |DDEFECTO #0;
               #0#36 = #4#112;
               #0#0 = beta;
               #0#14 = afecha;             ||Cargo la fecha del agifa507
               |PINTA #0#14;
               #0#12 = acaja;              ||Cargo la caja del agifa507
               |PINTA #0#12;

               puente_a = #4#34;                     ||Campo cajero
               |C_M #0#33 , 1 , puente_a;
               #0#33 = #4#20;
               |PINTA #0#33;

               puente_a = #4#35;                     ||Campo cliente
               |C_M #0#1 , 1 , puente_a;
               #0#1 = #4#36;
               |PINTA #0#1;

               puente_a = #4#37;
               |C_M #0#29 , 1 , puente_a;
               #0#29 = #4#38;
               |PINTA #0#29;

               |HORA puente_a;
               #0#34 = puente_a; ||Cargo la hora en que se hace el tiquet
               |PINTA #0#34;

               |PTEC 802;
          |FINSI;
     |SINO;
          |C_M #0#57, 1, "S";
          |C_M #0#58, 1, "S";
     |FINSI;
     salmenu = 0;
     sw_carga = 0;
|FPRC;

||_______________________________________/ CALCULOS DESDE CAMPOS TIPOS 0

|PROCESO contique; |TIPO 0;
     conta_reg = 0;
     |ABRE #51;
     |DDEFECTO #51;
     #51#0 = claveconta;
     claveconta = #51#0;        ||para que lo rellene de blancos
     #51#1 = #0#57;
     |LEE 101#51];
     |PARA; |SI FSalida = 0; |Y #51#0 = claveconta; |Y #51#1 = #0#57; |HACIENDO;
          claveconta = #51#0;
          |SI #51#3 = #0#14;
               conta_reg = #51#2;
               |BORRA 021#51a;
               |SAL;
          |FINSI;
          |LIBERA #51;
          |LEE 101#51s;
     |SIGUE;
     |CIERRA #51;

     |SI conta_reg = 0;
          |ABRE #5;
          #5#0 = claveconta;
          #5#2 = #0#57;
          |LEE 101#5=;
          |SI FSalida ! 0;
               #5#1 = 1;
               |GRABA 021#5b;
          |FINSI;
          conta_reg = #5#1;
          #5#1 = #5#1 + 1;
          |GRABA 021#5a;
          |CIERRA #5;
     |FINSI;
|FPRC;

||_________________________________________/ CALCULOS VARIOS
|PROCESO lee_horario;
     |ABRE #7;              ||Cargo los Valores del Codigo Horario
     #7#0 = #4#18;
     |LEE 001#7=;
     |CIERRA #7;
|FPRC;

|PROCESO carga_aparca;
     aparcar = 2;
     modo = (FEntrada / 100) ! 0;
     ||PTEC 802;
     |||PTEC 806;
     |PTEC 802;
     |PTEC 802;
     |PTEC 77;
     |PTEC 807;
     |LEE 101#0=;
     |SI FSalida = 0;
          |PINDA #0#0;
     |FINSI;
|FPRC;

|PROCESO lee_serie;
     |DDEFECTO #43;
     |ABRE #43;
     #43#26 = #0#57;
     |LEE 000#43=;
     |CIERRA #43;

     exporta=#43#30;
     |HAZ lee_horario;
     infocab = #43#21; |QBF infocab;
     infolin = #43#32; |QBF infolin;
     infopie = #43#33; |QBF infopie;

     |PARA i = 1; |SI i [ 5; |HACIENDO i = i + 1;
          enTiva = i;
          eaCli = #0#1;
          efFiva = #0#14;
          |HAZ IVACli;
          |SI #0#29 = "N"; enRec = 0; |FINSI;
          |SI i = 1; enIva1 = enIva; enRec1 = enRec; |FINSI;
          |SI i = 2; enIva2 = enIva; enRec2 = enRec; |FINSI;
          |SI i = 3; enIva3 = enIva; enRec3 = enRec; |FINSI;
          |SI i = 4; enIva4 = enIva; enRec4 = enRec; |FINSI;
          |SI i = 5; enIva5 = enIva; enRec5 = enRec; |FINSI;
     |SIGUE;
|FPRC;

|PROCESO lee_clien;
     |ABRE #14;
     |DDEFECTO #14;
     #14#0 = #0#1;
     |LEE 101#14=;
     |SI FSalida ! 0; |GRABA 021#14b; |FINSI;
     #0#65 = #14#16; || Cta
|FPRC;

|PROCESO horario;
     periodo = 0;
     |PARA i = 1; |SI i [ 19; |HACIENDO i = i + 2;
          j = i + 1;
          periodo = periodo + 1;
          |SI puente_n ] #7#i#; |Y puente_n [ #7#j#;
               mensaje = "";
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;


|PROCESO lee_514;
     |DDEFECTO #21;
     |ABRE #21;
     #21#0 = #0#33;
     |LEE 000#21=;
     credito = #21#4;
     |CIERRA #21;
|FPRC;

|PROCESO user_imp;
     alfa1 = alfa1 + &13;
     alfa2 = alfa1 % 0;   nume1 = alfa2;
     |PARA para1 = nume1; |SI para1 ] 1; |HACIENDO para1 = para1 - 1;
          nume2 = (para1 * 100) + 1;
          alfa2 = alfa1 % nume2;
          nume3 = &alfa2;
          |PTEC nume3;
     |SIGUE;
|FPRC;

||__________________________________/ PROCESOS DE ACTUALIZACION
|PROCESO GraDocBorra;
     |SI DocAnt ! "A";
          |ABRE #51;
          |SI DocAnt = "T"; #51#0 = "vtiquet";  |FINSI;
          |SI DocAnt = "F"; #51#0 = clave_fa;   |FINSI;
          #51#1 = SerAnt;
          #51#2 = #0#58;
          #51#3 = #0#14;
          |GRABA 000#51n;
          |CIERRA #51;
     |FINSI;
|FPRC;

|PROCESO BorraKitFac;
     |BORRA 020#948a;
|FPRC;

|DEFBUCLE BorraKitFac;
     #948#1;
     ;
     #13#20, #13#0, 001, 001;
     #13#20, #13#0, 999, 999;
     be;
     NULL, BorraKitFac;
|FIN;

|PROCESO BorraKitAlb;
     |BORRA 020#947a;
|FPRC;

|DEFBUCLE BorraKitAlb;
     #947#1;
     ;
     #17#29, #17#0, 001, 001;
     #17#29, #17#0, 999, 999;
     be;
     NULL, LineasKit;
|FIN;

|PROCESO BorraFactura;
     |ABRE #12;
     #12#48 = #0#57;
     #12#0 = #0#58;
     |LEE 121#12=;
     |SI FSalida = 0;
          |BUCLELIN 1NULL#12;
          |BUCLE BorraKitFac;
          |BORRA 021#12a;
          |SI #142#47 = "S";  ||ÄÄÄÄÄÄÄÄÄÄÄÄÄ Acumula en Riesgo Si Crea Recibos = "S"
               eaTag = "FC";  |HAZ Riesgos;
          |FINSI;
     |FINSI;
     |CIERRA #12;
|FPRC;

|PROCESO BorraAlbaran;
     |ABRE #16;
     #16#52 = #0#57;
     #16#0 = #0#58;
     |LEE 121#16=;
     |SI FSalida = 0;
          |BUCLELIN 1NULL#16;
          |BUCLE BorraKitAlb;
          |BORRA 021#16a;

          eaTag = "AV";  |HAZ Riesgos;

     |FINSI;
     |CIERRA #16;
|FPRC;

|PROCESO Historico;
     |SI #0#35 = "T"; operacion = "TI"; |FINSI;
     |SI #0#35 = "A"; operacion = "AV"; |FINSI;
     |SI #0#35 = "F"; operacion = "FC"; |FINSI;
     ||--------------------Historico
     enForma = nForma;
     eaOpeTP = operacion;
     |HAZ ModiHistoTPV;
     ||----------------------------lineas
     #1#9 = #0#14;   || Fecha
     #1#15 = #0#12;  ||Caja
     #1#16 = #0#34;  ||Hora
     #1#17 = #0#33;  ||Cajero
     #1#18 = #0#35;  || Tipo
     |GRABA 021#1a;
|FPRC;

|PROCESO PuntosCli;
     |SI #0#9 ] #58#1;
          nPuntos = #58#3;
     |FINSI;
     |SI #0#9 ] #58#1; |Y #0#9 [ #58#2;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE PuntosCli;
     #58#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, PuntosCli;
|FIN;

|DEFBUCLE Historico;
     #1#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, Historico;
|FIN;

|PROCESO ActCab;
     |ABRE #8;
     |HAZ lee_diario;
     |SI #0#9 > 0; |O #0#31 ! "V";
          |SI #0#3 > 0; beta = 1; |SINO; beta = -1; |FINSI;
          #0#3 = #0#3 * beta;
          nDto = (((#0#3 < #0#17) < #0#19) < #0#18) * beta;
          #0#3 = #0#3 * beta;
          nDto = #0#3 - nDto;   || Total Dto Cabecera
          ||...............................................
          ||-------------------- Cliente
          |SI diferido = "N"; |Y #0#31 ! "V";
               |ABRE #14;
               |DDEFECTO #14;
               #14#0 = #0#1;
               |LEE 101#14=;
               |SI FSalida ! 0; |GRABA 020#14b; |FINSI;
               fmes = #0#14 % A402;
               mes = ((fmes - 1) * 4) + 54;
               imneto = #0#3 - nDto;
               |SI #0#35 = "A";
                    #14#50 = #14#50 +. imneto;
               |SINO;
                    |SI #142#115 = "N";
                         nImpo = (imneto * 100) / (100 - #0#18);
                         nDto = nDto + (imneto - nImpo);
                    |SINO;
                         nImpo = imneto;
                    |FINSI;
                    #14mes = #14mes +. nImpo;
                    mes = mes + 1;
                    #14mes = #14mes +. nDto;
                    mes = mes + 1;
                    #14mes = #14mes +. #0#8;
                    #14#102 = #14#102 +. nImpo;
                    #14#103 = #14#103 +. nDto;
                    #14#104 = #14#104 +. #0#8;
                    beta = (FEntrada / 100) ! 0;
                    |SI beta = 1;
                         #14#45 = #0#14;
                    |FINSI;
                    #14#46 = imneto;
                    #14#110 = #14#110 +. imneto;

                    enImpCliCom = (nImpo * nForma);
                    enImpCliDto = (nDto * nForma);
                    enImpCliMar = (#0#8 * nForma);
                    enImpCliFac = imneto * nForma;
                    eaCliente = #0#1;
                    efFecha = #0#14;
                    |HAZ AcumulaCli;

               |FINSI;
               |GRABA 020#14a;
               |CIERRA #14;
          |FINSI;
          ||--------------------Resumen
          |SI #0#35 = "T"; |O #0#35 = "F"; |O #0#35 = "A";
               |SI diferido = "N";|O actu_dia = "S";
                    |SI #0#31 ! "V";
                         #8#24 = #8#24 +. #0#9;   ||Venta con imp.
                         #8#25 = #8#25 +. #0#4;   ||Total iva
                         #8#26 = #8#26 +. (#0#22+#0#25+#0#47+#0#50+#0#53);
                         #8#27 = #8#24 - #8#25 - #8#26; || Pruebas Redondeo....#8#27 +. (#0#20+#0#23+#0#26+#0#30+#0#48+#0#51);
                         #8#28 = #8#28 +. #0#28;  ||Total dto
                         #8#29 = #8#29 +. #0#3;   ||Total bruto
                    |FINSI;
               |FINSI;
          |FINSI;
          #8#84 = #8#84 +. #0#66;  ||Vales
          |SI #0#31 ! "V";
               |SI diferido = "N";|O actu_dia = "S";
                   |HAZ actua_dia;                    ||Actualiza el resumen diario
               |FINSI;
               |SI diferido = "N";
                   |HAZ actua_tarj;                   ||Actualiza la tarjeta
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #0#35 = "T";                     ||Tiquet;
          #8#6 = #8#6 +. 1;
          |SI #0#31 ! "V";
               #8#15 = #8#15 +. #0#9;
          |FINSI;
          |SI tipo = 1;
               |HAZ gra_tiquet;
          |FINSI;
     |FINSI;
     |SI #0#35 = "A";              ||Albaran
          #8#8 = #8#8 +. 1;
          |SI #0#31 ! "V";
               #8#17 = #8#17 +. #0#9;
          |FINSI;
          |SI tipo = 1;
               |HAZ gra_albaran;
               |HAZ RecalAlba;
          |SINO;
               |HAZ BorraAlbaran;
          |FINSI;
     |FINSI;
     |SI #0#35 = "F";
          #8#7 = #8#7 +. 1;
          |SI #0#31 ! "V";
               #8#16 = #8#16 +. #0#9;
          |FINSI;
          |SI tipo = 1;
               |HAZ gra_factura;
               |HAZ RecalFactura;
          |SINO;
               |HAZ BorraFactura;
          |FINSI;
     |FINSI;
     |SI diferido = "N";|O actu_dia = "S";
          |GRABA 021#8a;
          |LIBERA #8;
     |FINSI;
     |CIERRA #8;
     ||--------------------Historico + Sobres + Lineas
     |SI diferido = "N";
          |||BUCLELIN 0Historico#0;
          |BUCLE Historico;
     |FINSI;
     |SI #0#41 ! 0;
          |HAZ actua_deuda;
     |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄPuntos Cliente
     nPuntos = 0;
     |BUCLE PuntosCli;
     |SI nPuntos ! 0;
          |ABRE #60;
          |ABRE #61;
          |DDEFECTO #60;
          #60#0 = #0#1;
          |LEE 101#60=;
          |SI FSalida ! 0; |GRABA 020#60b; |FINSI;
          |SI nForma = 1;
               #61#0 = #60#0;
               #61#1 = 99999;
               |LEE 000#61];
               |SI FSalida = 0;
                    |LEE 000#61a;
               |SINO;
                    |LEE 000#61u;
               |FINSI;
               |SI FSalida = 0; |Y #60#0 = #61#0;
                    nLin = #61#1 + 1;
               |SINO;
                    nLin = 1;
               |FINSI;
               |DDEFECTO #61;
               #61#0 = #60#0;
               #61#1 = nLin;
               #61#2 = #0#35;
               #61#3 = #0#57;
               #61#4 = #0#58
               #61#5 = #0#14;
               #61#6 = #0#9;
               #61#7 = nPuntos;
               |GRABA 020#61n;
          |SINO;
               |SELECT #2#61;
               #61#2 = #0#35;
               #61#3 = #0#57;
               #61#4 = #0#58
               |BORRA 020#61c;
          |FINSI;
          #60#1 = #60#1 +. #61#6;
          #60#2 = #60#2 +. #61#7;
          |GRABA 020#60a;
          |CIERRA #60;
          |CIERRA #61;
     |FINSI;
|FPRC;

|PROCESO FinTiquet;
     |SI nForma ! -1;
          SerAnt = "";
          DocAnt = "";
          nSwFin = 1;
          |HAZ saca_menu;
          nSwFin = 0;
     |FINSI;
|FPRC;

|DEFBUCLE ActImpoArti;
     #1#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, ActImpoArti;
|FIN;

|DEFBUCLE Gra905_906;
     #1#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, Gra905_906;
|FIN;

|PROCESO t2_501; |TIPO 2;
     n_linea = 0;
     tipo = 0 +. 1;
     nError = 0;
     modo = (FEntrada / 100) ! 0
     nForma  = 0 +. 1;
     |SI modo = 2; |Y #0#35 ! "N";
          |SI #0#31 = "V";
               |MENAV "0000Vale de Devolucion, NO SE PUEDE MODIFICAR...";
               nError = 1;
               |ERROR; |ACABA;
          |FINSI;
          |ABRE #8;
          #8#63 = empresa;
          #8#0 = #0#12;
          #8#1 = #0#14;
          |LEE 000#8=;
          |CIERRA #8;
          |SI #8#56 = "N";
               |SI nSwCajaModi = 0;
                    |SI tipo = 1;
                         |MENAV "0000Resumen Diario Cerrado. NO SE MODIFICA...";
                    |FINSI;
                    nError = 1;
                    |ERROR; |ACABA;
               |SINO;
                    |SI acaja ! #0#12; |O afecha ! #0#14;
                         aAlfa = "0000Caja activa: " + acaja + " Fecha: " + afecha;
                         |SI tipo = 1;
                              |MENAV aAlfa;
                         |FINSI;
                         nError = 1;
                         |ERROR; |ACABA;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #0#35 = "A";
               |ABRE #16;
               #16#52 = #0#57;
               #16#0 = #0#58;
               |LEE 000#16=;
               |SI FSalida = 0; |Y #16#38 = "S";
                    |SI tipo = 1;
                         |MENAV "0000Albaran Facturado. NO SE MODIFICA...";
                    |FINSI;
                    |CIERRA #16;
                    nError = 1;
                    |ERROR; |ACABA;
               |FINSI;
               |CIERRA #16;
          |FINSI;
          |SI #0#35 = "F";
               |ABRE #12;
               #12#48 = #0#57;
               #12#0 = #0#58;
               |LEE 000#12=;
               |SI FSalida = 0; |Y #12#39 = "S";
                    |SI tipo = 1;
                         |MENAV "0000Factura Contabilizada. NO SE MODIFICA...";
                    |FINSI;
                    |CIERRA #12;
                    nError = 1;
                    |ERROR; |ACABA;
               |FINSI;
               |CIERRA #12;
          |FINSI;
          |SI #4#108 = "N"; |Y nSwCajaModi = 0;
               |SI tipo = 1;
                    |MENAV "0000CAJA SIN PERMISO PARA MODIFICACION...";
               |FINSI;
               nError = 1;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     |SI modo = 3; |Y #0#35 ! "N";
          |SI nSwCajaModi = 0;
               nError = 1;
               |ERROR;
               |ACABA;
          |SINO;
               |SI acaja ! #0#12; |O afecha ! #0#14;
                    aAlfa = "0000Caja activa: " + acaja + " Fecha: " + afecha;
                    |MENAV aAlfa;
                    nError = 1;
                    |ERROR; |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI modo = 2; |Y tipo = -1; ||Lo meto directamente en las lineas
          |PTEC 815; |PTEC 815;  ||porque puede pulsar Ctrl_C en
     |FINSI;                     ||la cabecera

     |SI tipo = -1;
          IC1_ = C1_1<-;
          |PARA i = 0; |SI i [ nCab; |HACIENDO i = i + 1;
               C1_ = #0i;
               IC1_ = IC1_ + 1;
          |SIGUE;
     |SINO;
          IC2_ = C2_1<-;
          |PARA i = 0; |SI i [ nCab; |HACIENDO i = i + 1;
               C2_ = #0i;
               IC2_ = IC2_ + 1;
          |SIGUE;
     |FINSI;
     |SI modo = 2; |Y tipo = 1; |Y salmenu ! 998;
          SerAnt = #0#57;
          DocAnt = #0#35;
          |SI #0#35 = "N";
               |HAZ saca_menu;
          |SINO;
               || COMPRUEBA SI HAY ALGUNA DIFERENCIA EN LA CABECERA
               IC1_ = C1_1<-; IC2_ = C2_1<-;
               |PARA i = 0; |SI i [ nCab; |HACIENDO; i = i + 1;
                    |SI C1_ ! C2_;
                         |SAL;
                    |FINSI;
                    IC1_ = IC1_ + 1; IC2_ = IC2_ + 1;
               |SIGUE;
               |SI i [ nCab;
                    |HAZ saca_menu;
               |SINO;
                    |BLIN 24;
                    |CONFI "2400NModificar Documento. (S/N).: ";
                    |SI FSalida = 0;
                         |HAZ saca_menu;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #0#35 ! "N";
          |HAZ ActCab;
     |FINSI;

     |SI salmenu ! 998;             || Aparcado
          |SI #0#31 = "V"; |Y #0#9 < 0; |Y modo = 1;
               |HAZ CreaVale;
          |FINSI;
          |PUSHV 0501 2380;
          |SI salida ! 18; |Y tipo = 1;      || NO IMPRIME F10, SI CON F2
               |PUSHV 0501 2380;
               |HAZ Impresion;
               |POPV;
          |FINSI;
          |XABRE "E", FicPant, beta;
          |SI FSalida = 0;
               |BLANCO 1208 2145;
               |PINVE 1208, 2145, FicPant;
               |PINTA #0#1;
               |FBORRA FicPant;
               |ATRI I; |PINTA 2009, " CAMBIO..:"; |ATRI 0;
               |SI #0#11 ! 0;
                    |SI #0#39 ! 0; |O #0#40 ! 0;
                         |ATRI S; |PINTA 2009, " DIFEREN.:"; |ATRI 0;
                    |FINSI;
               |FINSI;
               |PAUSA;
          |FINSI;
          |POPV;
     |FINSI;

||____/TONI COVERIN 20/07/99

     |SI salida =18; ||salimos con F10;
          |ABRE #30;
          #30#0="A";
          |LEE 000#30=;
          |SI FSalida = 0;|Y #30#22 ! "     ";
               #0#57 = #30#22;
          |FINSI;
          |CIERRA #30;
     |FINSI;

||Si el ticket no esta impreso lo grabo con la serie mala
     |SI tipo = 1;
          IC1_ = C1_1<-;
          |PARA i = 0; |SI i [ nCab; |HACIENDO i = i + 1;
               C1_ = "";
               IC1_ = IC1_ + 1;
          |SIGUE;
     |FINSI;
     |SI #0#35 ! "A"; |Y diferido = "N";
          |ABRE #2;
          |||BUCLELIN 2 ActImpoArti #0;
          |BUCLE ActImpoArti;
          |CIERRA #2;
     |FINSI;
     |ABRE #2;
     |||BUCLELIN 2 Gra905_906 #0;
     |BUCLE Gra905_906;
     |CIERRA #2;

     |HAZ ActSematel;

     |HAZ Enlaza;

     |HAZ EsAparecida;
     |SI FSalida = 0; |Y eaSerPro ! "";
          |HAZ GrabaSerPro;
     |FINSI;

     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ Libera el registro contador+1
     |SI aSerBloq ! "";
          |SALVA_FICHA #0;
          #0#36 = aSerBloq;
          #0#0 = nNumBloq;
          |LEE 140#0=;
          |LIBERA #0;
          aSerBloq = "";
          |REPON_FICHA #0;
     |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|FPRC;

|PROCESO Gra905_906;
     |SI #0#35 ! "T"; |Y #0#35 ! "F"; |Y #0#35 ! "A"; |ACABA; |FINSI;
     |SI #0#35 = "T"; aOpe = "TI"; |FINSI;
     |SI #0#35 = "F"; aOpe = "FC"; |FINSI;
     |SI #0#35 = "A"; aOpe = "AV"; |FINSI;

     #2#0 = #1#2;
     |LEE 000#2=;
     |SI #2#176 ! "S"; |ACABA; |FINSI;

     |ABRE #905;
     |DDEFECTO #905;
     #905#0 = aOpe;
     #905#1 = #0#57;
     #905#2 = #0#58;
     #905#3 = #1#1;
     #905#4 = #1#27;
     #905#5 = #1#28;
     #905#6 = #1#5;
     #905#7 = #1#10;
     #905#8 = #905#6 * #905#7;
     |SI enForma = 1;
          |GRABA 020#905n;
     |SINO;
          |BORRA 020#905c;
     |FINSI;
     |CIERRA #905;
     |ABRE #906;
     #906#0 = #1#2;
     #906#1 = #1#3;
     #906#2 = #0#14;
     #906#3 = aOpe;
     #906#4 = #0#57;
     #906#5 = #0#58;
     #906#6 = #1#1;
     #906#7 = #1#27;
     #906#8 = #1#28;
     #906#9 = -#1#5;
     #906#10 = #1#10;
     |SI enForma = 1;
          |GRABA 020#906n;
     |SINO;
          |BORRA 020#906c;
     |FINSI;
     |CIERRA #906;
|FPRC;

|PROCESO ActImpoArti;
     fmes = #0#14 % A402;
     mes = ((fmes - 1) * 5) + 35;
     #2#0 = #1#2;
     |LEE 101#2=;
     |SI FSalida = 0;
          |SI #2#194 = 2;
               nImpo = ((((#1#29 * #1#10) < #1#14) < #0#17) < #0#19);
          |SINO;
               nImpo = ((((#1#5 * #1#10) < #1#14) < #0#17) < #0#19);
          |FINSI;
          |SI #142#115 = "S";
               nImpo = nImpo < #0#18;
          |FINSI;
          nMargen = nImpo - #1#23;
          #2mes = #2mes + (nImpo * nForma);
          #2#95 = #2#95 + (nImpo * nForma);
          mes = mes + 1;
          #2mes = #2mes + (nMargen * nForma);
          #2#96 = #2#96 + (nMargen * nForma);
          |GRABA 020#2a;
          |LIBERA #2;

          efFecha = #0#14;
          eaArticulo = #1#2;
          enImpVta = (nImpo * nForma);
          enImpMar = (nMargen * nForma);
          |HAZ AcumulaArt;
     |FINSI;
|FPRC;

|| Con esta opcion presentamos un menu diferente en funcion de lo que se
|| haya elegido en parametros generales. Se debe hacer todas las combinaciones
|| de TIQUET, ALBARAN y FACTURA, es decir, 7 (ya que la de 000) no existe porque
|| no elegiriamos ninguna.
|| La pantalla habla de ocultar opciones por lo que deberemos interpretarlo
|| al reves.
|| Las opciones actuaran como si de "jumpers" se tratara, la primera posicion
|| sera TIQUET, la segunda ALBARAN y la tercera FACTURA. un 1 presenta en
|| pantalla la opcion, un 0 desactiva.
|| Segun la siguiente tabla
||  T  A  F
||  0  0  1  -> (En binario, En decimal es 1)
||  0  1  0  -> 2
||  0  1  1  -> 3
||  1  0  0  -> 4
||  1  0  1  -> 5
||  1  1  0  -> 6
||  1  1  1  -> 7

|PROCESO elige_menu;
    ntipo_menu = 0;
    salmenu    = 0;

    || Interpreto el valor de cada posicion
    |SI #4#42= "N";ntipo_menu = ntipo_menu + 4; |FINSI;
    |SI #4#43= "N";ntipo_menu = ntipo_menu + 2; |FINSI;
    |SI #4#44= "N";ntipo_menu = ntipo_menu + 1; |FINSI;

    || Las posibilidades con una sola opcion no deben presentar menu y cargar
    || sobre salmenu la opcion como si se hubiera escogido por el usuario
    |SI ntipo_menu = 1; salmenu = 3;|FINSI;   || Factura
    |SI ntipo_menu = 2; salmenu = 2;|FINSI;   || Albaran
    |SI ntipo_menu = 4; salmenu = 1;|FINSI;   || Tiquet

    || Con dos opciones:
       || Albaran y Factura (menu_a)ntipo_menu = 3
       || Tiquet y Factura  (menu_b)ntipo_menu = 5
       || Tiquet y Albaran  (menu_c)ntipo_menu = 6
    || Con tres opciones    (menu_d)ntipo_menu = 7
|FPRC;


|PROCESO saca_menu;                ||Pregunta sobre el documento a realizar
     |SI nSwCajaModi = 1;
          |HAZ Recal501;
     |FINSI;

     |HAZ elige_menu;
     |PARA ; |SI salmenu = -1; |O salmenu = 0; |HACIENDO ;
          |SI ntipo_menu = 3 ;
               menu4 = "AF";
               menu5 = "Albaran";
               menu6 = "Factura";
          |FINSI;
          |SI ntipo_menu = 5 ;
               menu4 = "TF";
               menu5 = "Tiquet";
               menu6 = "Factura";
          |FINSI;
          |SI ntipo_menu = 6;
               menu4 = "TA";
               menu5 = "Tiquet";
               menu6 = "Albaran";
          |FINSI;
          |SI ntipo_menu = 7;
               menu4 = "TAF";
               menu5 = "Tiquet";
               menu6 = "Albaran";
               menu7 = "Factura";
          |FINSI;
          |MENU menu;
          salmenu = FSalida;
          |SI salmenu = 0; |O salmenu = -1;
               |SI nSwFin = 1;
                    salmenu = -1;
                    |ACABA;
               |FINSI;
          |FINSI;

          || Ajusto los valores a como estaban antes, cuando el menu era fijo
          || 1 -> Tiquet, 2 -> Albaran, 3 -> Factura contado
          |SI ntipo_menu = 3;
              salmenu = salmenu +1;
          |FINSI;
          |SI ntipo_menu = 5;
              |SI salmenu = 2; salmenu = 3; |FINSI;
          |FINSI;
          || En el menu 6 y en el 7 coinciden. No hace falta retocar
     |SIGUE;

     |HAZ PideSerie;

     impo_dis = #0#9;
     |HAZ total_display;                           ||Pintado del display

     |SI salmenu = 2; |O salmenu = 3;
          |HAZ pide_datos;
     |FINSI;

     |SI salmenu = 1; |O salmenu = 3; |O salmenu = 2;
          |HAZ cobrar;
     |FINSI;

     |SI salmenu = 1; #0#35 = "T"; |FINSI;
     |SI salmenu = 2; #0#35 = "A"; |FINSI;
     |SI salmenu = 3; #0#35 = "F"; |FINSI;

/* Comentado Tarea: T10197

     |SI #0#35 = "A"; || pongo a '0' por si se modifica el documento
          #0#38 = 0; #0#39 = 0; #0#40 = 0; #0#41 = 0;
     |FINSI;
*/
|FPRC;

|PROCESO actua_tarj;               ||Actualiza las tarjetas
     |SI #0#40 ! 0;
          |ABRE #19;
          |DDEFECTO #19;
          #19#0 = #0#46;
          |LEE 101#19=;
          |SI FSalida ! 0;    |GRABA 021#19b; |FINSI;
          #19#2 = #19#2 + (#0#40*tipo);    ||Total Ptas cargadas
          #19#3 = #0#14;                  ||Fecha Ult. Oper.
          #19#4 = #0#40;                  ||Ptas Cargadas
          |GRABA 021#19a;
          |LIBERA #19;
          |CIERRA #19;
          |ABRE #20;
          |DDEFECTO #20;
          #20#0 = #0#46;
          #20#1 = #0#14;
          |LEE 101#20=;
          |SI FSalida ! 0;    |GRABA 021#20b; |FINSI;
          #20#2 = #20#2 + (#0#40*tipo);    ||Total Ptas cargadas
          |GRABA 021#20a;
          |LIBERA #20;
          |CIERRA #20;
     |FINSI;
|FPRC;

|PROCESO lee_diario;          ||Grabacion del fichero de diarios
     |DDEFECTO #8;
     #8#63 = empresa;
     #8#0 = acaja;
     #8#1 = afecha;
     |LEE 101#8=;
     |SI FSalida ! 0;
          |GRABA 021#8b;
     |FINSI;
|FPRC;

|PROCESO actua_dia;
     puente_a = (#0#34 % 102) + (#0#34 % 402);
     puente_n = puente_a;
     |HAZ lee_horario;
     |HAZ horario;
     puente_n = periodo + 29;
     #8#puente_n# = #8#puente_n# + tipo;
     puente_n = puente_n + 10;
     #8#puente_n# = #8#puente_n# + ((#0#9 - #0#4)*tipo);
     |SI #4#163 = "S"; |O #0#9 > 0;
          #8#52 = #8#52 + ((#0#38)*tipo);     ||Efectivo
          #8#55 = #8#55 + ((#0#38 + #0#40 + #0#39)*tipo);
     |FINSI;
     #8#53 = #8#53 + (#0#40*tipo);            ||Tarjeta
     #8#54 = #8#54 + (#0#39*tipo);            ||Cheque
     #8#58 = #8#58 + (#0#41*tipo);            ||Pendiente de credito
     #8#57 = #8#57 + (#0#15*tipo);            ||Restos no  cobrados
|FPRC;

||____________________________________/ COBRADO DE UN TIQUET O FACTURA

|PROCESO cobrar;
     #0#38 = 0;   #0#39 = 0;   #0#40 = 0;
     #0#11 = 0;   #0#41 = 0;   #0#15 = 0;
     #0#16 = 0;   #0#10 = 0;   #0#42 = "            ";

     |HORA aAlfa;
     #0#34 = aAlfa; |PINTA #0#34;

     |HAZ lee_514;             ||Leo el fichero de cajeros

     |PUSHV 0501 2380;
     |BLANCO 1208 2145;
     |PINPA #0#3;
     |PINDA #0#3;

     |HAZ cobro;

     |HAZ AbreCajon;
     FicPant = ".pan"; |TEMPO FicPant;
     |GRABAVE 1208, 2145, FicPant;
     |POPV;
|FPRC;

|PROCESO PideCliDeuda;
     |MENSA "0000Introduzca el Cliente para DEUDA";
     |C_M #0#1, 1, "S";
     |ENCAMPO #1#0;
     aAlfa = #4#35;
     |C_M #0#1, 1, aAlfa;
     #1#20 = #0#36;
     #1#0 = #0#0;
     #1#1 = 0;
     |LEE 000#1];
     |PARA; |SI FSalida = 0; |Y #1#0 = #0#0; |Y #1#20 = #0#36; |HACIENDO;
          #1#4 = #0#1;
          |GRABA 020#1a;
          |LIBERA #1;
          |LEE 000#1s;
     |SIGUE;
     |MENSA "0000 ";
|FPRC;

|PROCESO CobroPtas;
     |C_M #3#1, 1, "N"; |C_M #3#2, 1, "N";

     Tefe = 0; Ttar = 0; Tche = 0; Tdeu = 0; Tres = 0; Tdes = 0;

     |SI #3#7 < 0;
          #3#0 = "E";
          |ENCAMPO #0#3;
          |SI #3#0 = "E"; Tefe = #3#7; |FINSI;
          |SI #3#0 = "C"; Tche = #3#7; |FINSI;
          |SI #3#0 = "D"; Tdeu = #3#7; |FINSI;
          |SI #3#0 = "T";
               Ttar = #3#7;
               |ENCAMPO #4#3;
          |FINSI;
          |SI #3#0 = "V";
               |MENSA "0000Introduzca el Cliente para VALE";
               |HAZ PideCliDeuda;
          |FINSI;
     |FINSI;

     |PARA ; |SI #3#7 > 0; |HACIENDO;
       |ET PagaPtas;
          #3#0 = "E";
          |SI #4#102 ="S";
               #3#8 = 0;
          |SINO;
               #3#8 = #3#7;
          |FINSI;
          #3#9 = 0;
          |PINDA #0#3;

       |ET PreguntaPtas;
          |ENCAMPO #0#3;              ||Pregunto como lo paga
          |SI #3#0 = "A";
               |SI #0#67 ! 0;         ||Solo una vez
                    #3#0 = "E";
                    |VETE PreguntaPtas;
               |FINSI;
               |HAZ CobrosCaja;
               |SI nImpCobro = 0;
                    |MENAV "0000El Cliente, NO tiene Entregas...";
                    |VETE PagaPtas;
               |SINO;
                    |SI nImpCobro > #3#7;
                         #0#67 = nImpCobro - (nImpCobro - #3#7);
                         aAlfa = "0000Total importe Entrega:" + nImpCobro + &10;
                         nImpCobro = nImpCobro - #3#7;
                         aAlfa = aAlfa + "Pendiente:"+ nImpCobro;
                    |SINO;
                         aAlfa = "0000Total importe Entrega:" + nImpCobro;
                         #0#67 = nImpCobro;
                    |FINSI;
                    |MENAV aAlfa;
                    |VETE OtraVezPta;
               |FINSI;
          |FINSI;
          |SI #3#0 = "V";
               |SI #0#66 ! 0;         ||Solo una vez
                    #3#0 = "E";
                    |VETE PreguntaPtas;
               |FINSI;
               |HAZ ImporteVale;
               |SI nImpVale = 0;
                    |MENAV "0000El Cliente, NO tiene VALES PENDIENTES...";
                    |VETE PagaPtas;
               |SINO;
                    |SI nImpVale > #3#7;
                         #0#66 = nImpVale - (nImpVale - #3#7);
                         aAlfa = "0000Total importe Vale:" + nImpVale + &10;
                         nImpVale = nImpVale - #3#1;
                         aAlfa = aAlfa + "Pendiente:"+ nImpVale;
                         enPdtVale = nImpVale;
                    |SINO;
                         aAlfa = "0000Total importe Vale:" + nImpVale;
                         #0#66 = nImpVale;
                    |FINSI;
                    |MENAV aAlfa;
                    |VETE OtraVezPta;
               |FINSI;
          |FINSI;
          |SI #4#113 = "S"; |Y #3#0 = "D"; || Clave en Dto
               |HAZ ClaveDto;
               alfa = #4#114; |QBF alfa;
               |SI alfa ! aClave;
                    |MENAV "0000Clave Incorrecta...";
                    |VETE OtraVezPta;
               |FINSI;
          |FINSI;
          |SI #3#0 = "T"; |Y #21#3 = "N";
               |MENAV "0000ATENCION Este cajero NO puede aceptar Tarjetas";
               |VETE OtraVezPta;
          |FINSI;
          |SI #3#0 = "C"; |Y #21#2 = "N";
               |MENAV "0000ATENCION Este cajero NO puede aceptar Cheques";
               |VETE OtraVezPta;
          |FINSI;
          |SI #3#0 = "D"; |Y #4#117 ! "N"; |Y #14#48 ! 0; ||Control Riesgo
               nRiesgo = #14#49 + #3#7;
               |SI #4#117 = "A";
                    |SI nRiesgo > #14#48;
                         |MENAV "0000Riesgo Cliente superado...";
                    |FINSI;
               |SINO;
                    |SI nRiesgo > #14#48;
                         |MENAV "0000Riesgo Cliente superado...";
                         |VETE OtraVezPta;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #3#0 = "D"; |Y #21#4 = "N";
               |MENAV "0000ATENCION Este cajero NO puede aceptar Creditos";
               |VETE OtraVezPta;
          |FINSI;
          |BLIN 4;
          |C_M #3#7, 1 , "N";
          |SI #4#19 = "S";
               nImpo = #3#7;
               |C_M #3#7, 1 , "S";
               |ENCAMPO #7#3;
               |SI FSalida = 2; |VETE OtraVezPta; |FINSI;
               impo_dis = #3#7;
               |HAZ total_display;
               Tres = Tres + (nImpo - #3#7);
          |FINSI;
      |ET EntregaPta;
          |SI #4#102 ="S";
               #3#8 = 0;
          |SINO;
               #3#8 = #3#7;
          |FINSI;
          |SI #3#0 = "D";
               |AVISO;
               |MENSA "0000Introduzca la cantidad que se ENTREGA";
          |FINSI;
          |ENCAMPO #8#3;
          |SI FSalida = 2; |VETE OtraVezPta; |FINSI;
      |ET DeudaPta;
          |SI #3#0 = "D";
               |SI #3#8 > #3#7;
                    |MENAV "0000La cantidad a ENTREGAR no puede ser superior al importe";
                    |VETE EntregaPta;
               |FINSI;
               nImpo = #3#7 - #3#8;
               |BLIN 4;
               mensaje = "2400SLa cantidad a Deber es : " + nImpo + " Correcto : ";
               |CONFI mensaje;
               |SI FSalida ! 0; |VETE EntregaPta; |FINSI;
               Tdeu = Tdeu + nImpo;
               |VETE OtraVezPta;
          |FINSI;
          |SI #3#0 = "T"; |Y #3#8 ! 0;
               alfa_oper = oper_tarjeta;
               |MENSA "0000Introduzca codigo trajeta de credito";
               |ENCAMPO #4#3;
               |SI FSalida = 9;
                    |MENSA "0000Introduzca Codigo de operacion";
                    |PUSHV 0501 2380;
                    |PINTA 1329,"Operacion:  ";
                    E_sup = 2;
                    E_inf = "";
                    alfa_oper = 1340 ? 1;
                    |QBT alfa_oper;
                    |POPV;
               |FINSI;
               |SI FSalida ! 0; |VETE OtraVezPta; |FINSI;
               |HAZ tarjeta;
               |SI ErrorTarjeta ! 0;
                    |MENAV "0000­­­ ERROR EN TARJETA !!!";
                    |VETE OtraVezPta;
               |FINSI;
          |FINSI;
          nNume1 = ((#3#2 * 166.386)!EURODB) + #3#8;
          |SI #3#7 > 0; |Y nNume1 < #3#7; |Y #21#4 = "N"; ||Cajero no acepta Deuda
               |VETE OtraVezPta;
          |FINSI;
          |SI #3#0 = "E";
               nNume1 = ((#3#2 * 166.386)!EURODB) + #3#8;
               |SI #3#7 > 0; |Y nNume1 < #3#7;
                    |SI #4#113 = "S";
                         |HAZ ClaveDto;
                         alfa = #4#114; |QBF alfa;
                         |SI alfa ! aClave;
                              |MENAV "0000Clave Incorrecta...";
                              #3#9 = 0;
                              |VETE OtraVezPta;
                         |FINSI;
                    |FINSI;
                    |MENU cmenu;
                    |SI FSalida = 2;
                         |SI #21#6 = "N";
                              |MENAV "0000ATENCION Este cajero NO puede aceptar Descuentos";
                              |VETE OtraVezPta;
                         |SINO;
                              descu = (#3#8*100) / #3#7; || CALCULA % DTO.
                              #0#18 = 100 - descu;         || PASA EL DTO. A P.P.
                              Tdes = Tdes + #3#7- #3#8;
                         |FINSI;
                    |SINO;
                         #3#0 = "D";
                         |VETE DeudaPta;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #3#0 = "E"; Tefe = Tefe + #3#8-#3#9; |FINSI;
          |SI #3#0 = "T"; Ttar = Ttar + #3#8; |FINSI;
          |SI #3#0 = "C"; Tche = Tche + #3#8; |FINSI;
       |ET OtraVezPta;
          #3#7 = #0#9 - Tefe - Ttar - Tche - Tdeu - Tres - Tdes - #0#66;
          #3#1 = #3#7 / 166.386;
          |SI #3#9 < 0; #3#9 = 0; |FINSI;
          |SI #3#7 = 0;
               |PINTA #3#9;
          |FINSI;
     |SIGUE;
     #0#9 = nValor9;
|FPRC;

|PROCESO CobroEuro;
     |C_M #3#1, 1, "S"; |C_M #3#2, 1, "S";

     Tefe = 0; Ttar = 0; Tche = 0; Tdeu = 0; Tres = 0; Tdes = 0;
     nImpCobro = 0;
     nImpVale = 0;
     |SI #3#1 < 0;
          #3#0 = "E";
          |ENCAMPO #0#3;
          |SI #3#0 = "E"; Tefe = #3#1; |FINSI;
          |SI #3#0 = "T"; Ttar = #3#1; |FINSI;
          |SI #3#0 = "C"; Tche = #3#1; |FINSI;
          |SI #3#0 = "D"; Tdeu = #3#1; |FINSI;
          |SI #3#0 = "T";
               Ttar = #3#1;
               |ENCAMPO #4#3;
          |FINSI;
          |SI #3#0 = "V";
               |MENSA "0000Introduzca el Cliente para VALE";
               |HAZ PideCliDeuda;
          |FINSI;
     |FINSI;

     |PARA ; |SI #3#1 > 0; |HACIENDO;
       |ET PagaEuro;
          #3#0 = "E";
          #3#8 = 0;
          #3#3 = 0;
          |SI #4#102 = "S";
               #3#2 = 0;
          |SINO;
               #3#2 = #3#1;
          |FINSI;
          |PINDA #0#3;

       |ET PreguntaEuro;
          |ENCAMPO #0#3;              ||Pregunto como lo paga
          |SI #3#0 = "A";
               |SI #0#67 ! 0;         ||Solo una vez
                    #3#0 = "E";
                    |VETE PreguntaEuro;
               |FINSI;
               |HAZ CobrosCaja;
               |SI nImpCobro = 0;
                    |MENAV "0000El Cliente, NO tiene Entregas...";
                    |VETE PagaEuro;
               |SINO;
                    |SI nImpCobro > #3#1;
                         #0#67 = nImpCobro - (nImpCobro - #3#1);
                         aAlfa = "0000Total importe Entrega:" + nImpCobro + &10;
                         nImpCobro = nImpCobro - #3#1;
                         aAlfa = aAlfa + "Pendiente:"+ nImpCobro;
                    |SINO;
                         aAlfa = "0000Total importe Entrega:" + nImpCobro;
                         #0#67 = nImpCobro;
                    |FINSI;
                    |MENAV aAlfa;
                    |VETE OtraVezEuro;
               |FINSI;
          |FINSI;
          |SI #3#0 = "V";
               |SI #0#66 ! 0;         ||Solo una vez
                    #3#0 = "E";
                    |VETE PreguntaEuro;
               |FINSI;
               |HAZ ImporteVale;
               |SI nImpVale = 0;
                    |MENAV "0000El Cliente, NO tiene VALES PENDIENTES...";
                    |VETE PagaEuro;
               |SINO;
                    |SI nImpVale > #3#1;
                         #0#66 = nImpVale - (nImpVale - #3#1);
                         aAlfa = "0000Total importe Vale:" + nImpVale + &10;
                         nImpVale = nImpVale - #3#1;
                         aAlfa = aAlfa + "Pendiente:"+ nImpVale;
                         enPdtVale = nImpVale;
                    |SINO;
                         aAlfa = "0000Total importe Vale:" + nImpVale;
                         #0#66 = nImpVale;
                    |FINSI;
                    |MENAV aAlfa;
                    |VETE OtraVezEuro;
               |FINSI;
          |FINSI;
          |SI #4#113 = "S"; |Y #3#0 = "D"; || Clave en Dto
               |HAZ ClaveDto;
               alfa = #4#114; |QBF alfa;
               |SI alfa ! aClave;
                    |MENAV "0000Clave Incorrecta...";
                    |VETE OtraVezEuro;
               |FINSI;
          |FINSI;
          |SI #3#0 = "T"; |Y #21#3 = "N";
               |MENAV "0000ATENCION Este cajero NO puede aceptar Tarjetas";
               |VETE OtraVezEuro;
          |FINSI;
          |SI #3#0 = "C"; |Y #21#2 = "N";
               |MENAV "0000ATENCION Este cajero NO puede aceptar Cheques";
               |VETE OtraVezEuro;
          |FINSI;
          |SI #3#0 = "D"; |Y #4#117 ! "N"; |Y #14#48 ! 0; ||Control Riesgo
               nRiesgo = #14#49 + #3#1;
               |SI #4#117 = "A";
                    |SI nRiesgo > #14#48;
                         |MENAV "0000Riesgo Cliente superado...";
                    |FINSI;
               |SINO;
                    |SI nRiesgo > #14#48;
                         |MENAV "0000Riesgo Cliente superado...";
                         |VETE OtraVezEuro;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #3#0 = "D"; |Y #21#4 = "N";
               |MENAV "0000ATENCION Este cajero NO puede aceptar Creditos";
               |VETE OtraVezEuro;
          |FINSI;
          |BLIN 4;
          |C_M #3#1 , 1 , "N"; |C_M #3#7, 1 , "N";
          |SI #4#19 = "S";
               nImpo = #3#1;
               |C_M #3#1, 1 , "S";
               |C_M #3#7, 1 , "S";
           |ET Camp1;
               |ENCAMPO #1#3;
               |SI FSalida = 2; |VETE OtraVezEuro; |FINSI;
               |ENCAMPO #7#3;
               |SI FSalida = 2; |VETE Camp1; |FINSI;
               impo_dis = #3#1;
               |HAZ total_display;
               Tres = Tres + (nImpo - #3#1);
          |FINSI;
      |ET EntregaEuro;
          #3#8 = 0;
          |SI #4#102 ="S";
               #3#2 = 0;
          |SINO;
               #3#2 = #3#1;
          |FINSI;
          |SI #3#0 = "D";
               |AVISO;
               |MENSA "0000Introduzca la cantidad que se ENTREGA";
          |FINSI;
      |ET Camp2;
          |ENCAMPO #2#3;
          |SI FSalida = 2; |VETE OtraVezEuro; |FINSI;

          |HAZ EsAparecida;
          |SI FSalida = 0;
               aMensaje = "0000SEs Correcto?";
               |CONFI aMensaje;
               |SI FSalida ! 0;
                    salmenu = -1;
                    |ACABA;
               |FINSI;
          |FINSI;

          |SI #3#3 = 0;
               #3#8 = (#3#1 - #3#2) * 166.386;
               |SI #30#24 = "N";
                    #3#8 = 0;
               |FINSI;
          |FINSI;
          |ENCAMPO #8#3;
          |SI FSalida = 2;
               |SI #3#3 = 0; |Y #4#102 ! "S";
                    #3#2 = #3#1 - ((#3#8 / 166.386)!EURODB);
                    |PINTA #3#2;
               |FINSI;
               |VETE Camp2;
          |FINSI;
      |ET DeudaEuro;
          |SI #3#0 = "D"; |Y #4#117 ! "N"; |Y #14#48 ! 0; ||Control Riesgo
               nRiesgo = #14#49 + #3#1;
               |SI #4#117 = "A";
                    |SI nRiesgo > #14#48;
                         |MENAV "0000Riesgo Cliente superado...";
                    |FINSI;
               |SINO;
                    |SI nRiesgo > #14#48;
                         |MENAV "0000Riesgo Cliente superado...";
                         |VETE OtraVezEuro;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #3#0 = "D";
               beta = #3#2 + ((#3#8 / 166.386)!EURODB);
               |SI beta > #3#1;
                    |MENAV "0000La cantidad a ENTREGAR no puede ser superior al importe";
                    |VETE EntregaEuro;
               |FINSI;
               nImpo = #3#1 - (#3#2 + ((#3#8 / 166.386)!EURODB));
               |BLIN 4;
               mensaje = "2400SLa cantidad a Deber es : " + nImpo + " Correcto : ";
               |CONFI mensaje;
               |SI FSalida ! 0; |VETE EntregaEuro; |FINSI;
               Tdeu = Tdeu + nImpo;
               |VETE OtraVezEuro;
          |FINSI;
          beta = #3#2 + (#3#8 / 166.386);
          |SI #3#0 = "T"; |Y beta ! 0;
               alfa_oper = oper_tarjeta;
               |MENSA "0000Introduzca codigo trajeta de credito";
               |ENCAMPO #4#3;
               |SI FSalida = 9;
                    |MENSA "0000Introduzca Codigo de operacion";
                    |PUSHV 0501 2380;
                    |PINTA 1329,"Operacion:  ";
                    E_sup = 2;
                    E_inf = "";
                    alfa_oper = 1340 ? 1;
                    |QBT alfa_oper;
                    |POPV;
               |FINSI;
               |SI FSalida ! 0; |VETE OtraVezEuro; |FINSI;
               |HAZ tarjeta;
               |SI ErrorTarjeta ! 0;
                    |MENAV "0000­­­ ERROR EN TARJETA !!!";
                    |VETE OtraVezEuro;
               |FINSI;
          |FINSI;
          nNume1 = #3#2 + ((#3#8 / 166.386)!EURODB);
          |SI #3#1 > 0; |Y nNume1 < #3#1; |Y #21#4 = "N"; ||Cajero no acepta Deuda
               |VETE OtraVezEuro;
          |FINSI;
          |SI #3#0 = "E";
               nNume1 = #3#2 + ((#3#8 / 166.386)!EURODB);
               |SI #3#1 > 0; |Y nNume1 < #3#1;
                    |SI #4#113 = "S";
                         |HAZ ClaveDto;
                         alfa = #4#114; |QBF alfa;
                         |SI alfa ! aClave;
                              |MENAV "0000Clave Incorrecta...";
                              #3#3 = 0;
                              |VETE OtraVezEuro;
                         |FINSI;
                    |FINSI;
                    |MENU cmenu;
                    |SI FSalida = 2;
                         |SI #21#6 = "N";
                              |MENAV "0000ATENCION Este cajero NO puede aceptar Descuentos";
                              |VETE OtraVezEuro;
                         |SINO;
                              || segun 3218/988 23.05.2008
                              ||descu = ((#3#2+((#3#8/166.386)!EURODB)*100) / #3#1) * 100; || CALCULA % DTO.
                              ||#0#18 = 100 - descu;         || PASA EL DTO. A P.P.
                              ||Tdes = Tdes + #3#1-(#3#2+((#3#8/166.386)!EURODB));

                              nNume = Ttar + Tche + #0#66 + #3#2;
                              descu = (nNume*100) / #0#9; || CALCULA % DTO.
                              #0#18 = 100 - descu;         || PASA EL DTO. A P.P.
                              Tdes = Tdes + #0#9 - nNume;
                         |FINSI;
                    |SINO;
                         #3#0 = "D";
                         |VETE DeudaEuro;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #3#0 = "E"; Tefe = Tefe + #3#2+((#3#8/166.386)!EURODB)-#3#3; |FINSI;
          |SI #3#0 = "T"; Ttar = Ttar + #3#2+((#3#8/166.386)!EURODB); |FINSI;
          |SI #3#0 = "C"; Tche = Tche + #3#2+((#3#8/166.386)!EURODB); |FINSI;
       |ET OtraVezEuro;
          #3#1 = #0#9 - Tefe - Ttar - Tche - Tdeu - Tres - Tdes - #0#66;
          #3#7 = (#3#1/166.386)!EURODB;
          |SI #3#3 < 0; #3#3 = 0; |FINSI;
          |SI #3#1 = 0;
               |PINTA #3#3;
          |FINSI;
     |SIGUE;
     #0#9 = nValor9;
|FPRC;

|PROCESO cobro;
     enPdtVale = 0;
     |ABRE #14;
     #14#0 = #0#1
     |LEE 000#14=;
     |CIERRA #14;

     |DDEFECTO #3;
     #3#1 = #0#9 - #0#54; || Se le quita la cantidad ya dada a cuenta

     nValor9 = #0#9;     ||guarda el valor para despues restaurarlo
     |SI salmenu  = 2;   || Si es Albaran el apagar es la entrega a cuenta
          #3#1 = #0#54;
          #0#9 = #0#54;
     |FINSI;

     |SI eaEsEuro = "S";
          #3#7 = #3#1 * 166.386;
          #3#2 = #3#1;
          |SI #4#102 = "S"; #3#2 = 0; |FINSI; ||Entrega a '0'
     |SINO;
          #3#7 = #3#1;
          #3#8 = #3#7;
          #3#1 = #3#1 / 166.386;
          |SI #4#102 = "S"; #3#8 = 0; |FINSI; ||Entrega a '0'
     |FINSI;

     |SI #30#24 = "S";
          |BLANCO 1208 2145;
          |PINPA #0#3;
          |PINDA #0#3;
     |SINO;
          |C_V #3#7, 1, "N";
          |C_V #3#8, 1, "N";
          |C_V #3#9, 1, "N";
          |BLANCO 1208 2145;
          |PINPA #0#3;
          |PINPA #0#300;
          |PINDA #0#3;
     |FINSI;

     |SI eaEsEuro = "S";
          |HAZ CobroEuro;
          |SI #3#0 = "T"; |O #3#0 = "D";
               #0#10 = Tefe + Ttar + Tche;       || Entrega
          |SINO;
               #0#10 = Tefe + Ttar + Tche + #3#3;       || Entrega
          |FINSI;
          #0#11 = #3#3;       || Cambio
     |SINO;
          |HAZ CobroPtas;
          |SI #3#0 = "T"; |O #3#0 = "D";
               #0#10 = Tefe + Ttar + Tche;       || Entrega
          |SINO;
               #0#10 = Tefe + Ttar + Tche + #3#9;       || Entrega
          |FINSI;
          #0#11 = #3#9;       || Cambio
     |FINSI;
     |SI #0#9 ] 0;
          #0#31 = "E";
          |SI Tefe > 0; #0#31 = "E"; |SINO;
               |SI Ttar > 0; #0#31 = "T"; |SINO;
                    |SI Tche > 0; #0#31 = "C"; |SINO;
                         #0#31 = "D";
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          #0#31 = #3#0;
     |FINSI;
     #0#15 = Tres;       || Resto no Cobrado
     #0#28 = Tdes;       || Descuento
     #0#38 = Tefe;       || Efectivo
     #0#39 = Tche;       || Cheque
     #0#40 = Ttar;       || Tarjeta
     #0#41 = Tdeu;       || Credito o Deuda
     |SI Ttar ! 0;
          #0#42 = #19#5; || Cta Tarjeta
          #0#46 = #19#0; || Cod. Tarjeta
     |FINSI;
     |SI #0#41 > 0; |Y #4#115 = "S";
          |HAZ PideCliDeuda;
     |FINSI;

     |HAZ cobro_display;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄCOBROS POR CAJAÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO TeclaCobro;
     |SI FSalida = 0; |Y #28Campo = Contenido;
          |SI #28#8 = "*";
               #28#8 = "";
               nImpCobro = nImpCobro - (#28#6 - #28#7);
          |SINO;
               #28#8 = "*";
               nImpCobro = nImpCobro + (#28#6 - #28#7);
          |FINSI;
          |GRABA 020#28a;
          |PINTA #28#8;
          |PINTA 0771, "        ";
          |PINTA 0771, nImpCobro;
     |FINSI;
|FPRC;

|PROCESO Min28;
     #28#2 = 1;
|FPRC;

|PROCESO Max28;
     #28#2 = 99;
|FPRC;

|PROCESO CobrosCaja;
     nImpCobro = 0;
     nLin = 0;
     nRes = 0;
     |HAZ CreaTempo; aTempo28 = Tempo;
     |NOME_DAT #28 aTempo28; |DELINDEX #28;
     |ABRE #28;
     |ABRE #513;
     |SELECT #3#513;
     #513#1 = #0#1;
     #513#11 = "00.00.0000";
     #513#14 = "  ";
     #513#0 = 0;
     |LEE 101#513];
     |PARA; |SI FSalida = 0; |Y #513#1 = #0#1; |HACIENDO;
          nPend = #513#4 - #513#18;
          nImpCobro = nImpCobro + nPend;
          |SI nPend > 0;
               nLin = nLin + 1;
               #28#0 = #513#0;
               #28#2 = nLin;
               #28#3 = #513#14;
               #28#4 = #513#0;
               #28#5 = #513#11;
               #28#6 = #513#4;
               #28#7 = #513#18;
               #28#8 = "";
               #28#9 = #28#6 - #28#7;
               |GRABA 020#28n;
          |FINSI;
          |LEE 101#513s;
     |SIGUE;
     |CIERRA #28;
     |SI nImpCobro ! 0;
          nImpCobro = 0;
          |PUSHV 0501 2380;
          |BLANCO 0534 2380;
          |MENSA "0000<INTRO> Selecciona linea";
          |ENTLINEAL #2#28, -1, 4, 21, 1, Min28, Max28;
          |POPV;
     |FINSI;

     nImpCobro = 0;
     |ABRE #28;
     |LEE 000#28p;
     |PARA; |SI FSalida = 0; |Y nRes = 0; |HACIENDO;
          |SI #28#8 = "*";
               nImpCobro = nImpCobro + #28#9;
               |SI nImpCobro > #3#1;
                    nRes = nImpCobro - #3#1;
               |FINSI;
          |FINSI;
          #513#14 = #28#3;
          #513#0 = #28#4;
          |LEE 121#513=;
          |SI FSalida = 0;
               #513#18 = #513#18 + (#28#9 - nRes);
               |GRABA 020#513a;
          |FINSI;
          |LEE 000#28s;
     |SIGUE;
     |CIERRA #28;

     |DELINDEX #28; Tempo = aTempo28; |HAZ BoraTempo;
     |CIERRA #513;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄVALESÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO TeclaVale;
     |SI FSalida = 0; |Y #27Campo = Contenido;
          |SI #27#8 = "*";
               #27#8 = "";
               nImpVale = nImpVale - (#27#6 - #27#7);
          |SINO;
               #27#8 = "*";
               nImpVale = nImpVale + (#27#6 - #27#7);
          |FINSI;
          |GRABA 020#27a;
          |PINTA #27#8;
          |PINTA 0771, "        ";
          |PINTA 0771, nImpVale;
     |FINSI;
|FPRC;

|PROCESO Min27;
     #27#2 = 1;
|FPRC;

|PROCESO Max27;
     #27#2 = 99;
|FPRC;

|PROCESO ImporteVale;
     nImpVale = 0;
     nLin = 0;
     nRes = 0;
     |ABRE #62;
     |ABRE #63;
     #62#0 = #0#1;
     |LEE 101#62=;
     |SI FSalida = 0;
          |HAZ CreaTempo; aTempo27 = Tempo;
          |NOME_DAT #27 aTempo27; |DELINDEX #27;
          |ABRE #27;

          #62#1 = 0;     ||Recalculo el Total
          #63#0 = #62#0;
          #63#1 = 1;
          |LEE 000#63];
          |PARA; |SI FSalida = 0; |Y #63#0 = #0#1; |HACIENDO;
               nPend = #63#6 - #63#7;
               nImpVale = nImpVale + nPend;
               |SI nPend > 0;
                    nLin = nLin + 1;
                    #27#0 = #63#0;
                    #27#1 = #63#1;
                    #27#2 = nLin;
                    #27#3 = #63#3;
                    #27#4 = #63#4;
                    #27#5 = #63#5;
                    #27#6 = #63#6;
                    #27#7 = #63#7;
                    #27#8 = "";
                    #27#9 = #27#6 - #27#7;
                    |GRABA 020#27n;
               |FINSI;
               #62#1 = #62#1 + (#63#6 - #63#7);   ||Total
               |LEE 000#63s;
          |SIGUE;
          |GRABA 020#62a;
          |CIERRA #27;
          |SI nImpVale ! 0;
               nImpVale = 0;
               |PUSHV 0501 2380;
               |BLANCO 0534 2380;
               |MENSA "0000<INTRO> Selecciona linea";
               |ENTLINEAL #2#27, -1, 4, 21, 1, Min27, Max27;
               |POPV;
          |FINSI;
          nImpVale = 0;
          |ABRE #27;
          |LEE 000#27p;
          |PARA; |SI FSalida = 0; |Y nRes = 0; |HACIENDO;
               |SI #27#8 = "*";
                    nImpVale = nImpVale + #27#9;
                    |SI nImpVale > #3#1;
                         nRes = nImpVale - #3#1;
                    |FINSI;
                    #63#0 = #27#0;
                    #63#1 = #27#1;
                    |LEE 121#63=;
                    |SI FSalida = 0;
                         #63#7 = #63#7 + (#27#9 - nRes);
                         #62#1 = #62#1 - (#27#9 - nRes);
                         |GRABA 020#62a;
                         |GRABA 020#63a;
                    |FINSI;
                    |SI nImpVale = #3#1;
                         |SAL;
                    |FINSI;
               |FINSI;
               |LEE 000#27s;
          |SIGUE;
          |CIERRA #27;
          |DELINDEX #27; Tempo = aTempo27; |HAZ BoraTempo;
     |FINSI;
     |CIERRA #62;
     |CIERRA #63;
|FPRC;

|PROCESO CreaVale;
     |ABRE #62;
     |ABRE #63;
     |DDEFECTO #62;
     #62#0 = #0#1;
     |LEE 101#62=;
     |SI FSalida ! 0; |GRABA 020#62b; |FINSI;
     #63#0 = #62#0;
     #63#1 = 99999;
     |LEE 000#63];
     |SI FSalida = 0;
          |LEE 000#63a;
     |SINO;
          |LEE 000#63u;
     |FINSI;
     |SI FSalida = 0; |Y #62#0 = #63#0;
          nLin = #63#1 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
     |DDEFECTO #63;
     #63#0 = #62#0;
     #63#1 = nLin;
     #63#2 = #0#35;
     #63#3 = #0#57;
     #63#4 = #0#58;
     #63#5 = #0#14;
     #63#6 = -#0#9;
     #63#7 = 0;
     |GRABA 020#63n;
     #62#1 = #62#1 + #63#6;
     |GRABA 020#62a;
     |CIERRA #62;
     |CIERRA #63;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|| El fichero ERROR devuelve 'bien' o 'mal'
|PROCESO CompruTarjeta;
     |SI tarjetas = "S";
          Pos = -1;
          alfa = "rt  " + ferr_tarjeta;
          |FABRE alfa;
          |SI FSalida ] 0;
               f = FSalida;
               alfa = f + " 80";
               |FLEE alfa;
               |QBT alfa; alfa = alfa > alfa;
               |SI FSalida [ 0; |O alfa ! "BIEN";
                    ErrorTarjeta = 1;
               |FINSI;
               |FCIERRA f;
          |SINO;
               |MENAV "0000No existe el fichero 'ERROR'";
               ErrorTarjeta = 1;
          |FINSI;
          Pos = -1;
     |FINSI;
|FPRC;

|PROCESO tarjeta;
     ErrorTarjeta = 0;
     |ABRE #19;
     |DDEFECTO #19;
     #19#0 = #3#4;
     |LEE 001#19=;
     |SI FSalida ! 0;
          |MENAV "0000­­­ El Codigo no Existe !!!";
          ErrorTarjeta = 1;
     |FINSI;
     |CIERRA #19;

     ||----Ejecuta bat Tarjeta Parametros: Importe, Memoria, Operacion

     |SI tarjetas = "S";
          |SI ErrorTarjeta = 0;
               memo_tarjeta = #19#6; |QBF memo_tarjeta;
               |SI alfa_oper ! "";
                 cambio_tarjeta = alfa_oper;
               |FINSI;
               alfa = bat_tarjeta + " " + #3#2 + " " + memo_tarjeta + " " + cambio_tarjeta;
               |SYSTEM alfa;
               |HAZ CompruTarjeta;
          |FINSI;
     |FINSI;
|FPRC;
-------------------------------------------------------------------
|PROCESO LineasKit;
     |SI #0#35 = "A";         ||Albaran
          #947#0 = #17#29;
          #947#1 = #17#0;
          #947#2 = #17#1;
          #947#3 = #951#3;
          #947#4 = #951#4;
          #947#5 = #951#5;
          #947#6 = #951#6;
          #947#7 = #951#7;
          #947#8 = #951#8;
          #947#9 = #951#9;
          #947#10 = #951#10;
          #947#11 = #951#11;
          #947#12 = #951#12;
          |GRABA 020#947n;
     |SINO;                   ||Factura
          #948#0 = #13#20;
          #948#1 = #13#0;
          #948#2 = #13#1;
          #948#3 = #951#3;
          #948#4 = #951#4;
          #948#5 = #951#5;
          #948#6 = #951#6;
          #948#7 = #951#7;
          #948#8 = #951#8;
          #948#9 = #951#9;
          #948#10 = #951#10;
          #948#11 = #951#11;
          #948#12 = #951#12;
          |GRABA 020#948n;
     |FINSI;
|FPRC;

|DEFBUCLE LineasKit;
     #951#1;
     ;
     #1#20, #1#0, #1#1, 001;
     #1#20, #1#0, #1#1, 999;
     ;
     NULL, LineasKit;
|FIN;

|PROCESO lin_502;
     #2#0 = #1#2;
     |LEE 020#2=;

     |SI #0#35 = "A";
          |DDEFECTO #17;
          #17#29 = #0#57;            ||Serie
          #17#0 = #0#58;
          #17#1 = #1#1;
          #17#2 = #1#2;              ||Articulo
          #17#3 = almacen;           ||almacen
          #17#4 = #1#8;              ||Descripcion
          #17#5 = #1#5;              ||Unidades
          #17#6 = #1#10;             ||Precio
          #17#38 = #17#6;
          #17#8 = #1#14;             ||Dto
          |SI #2#194 = 2;
               #17#7 = #1#29 * #17#6;     ||Importe
               #17#9 = (#1#29 * #17#6) < #17#8;||Imp.Tot
          |SINO;
               #17#7 = #1#5 * #17#6;     ||Importe
               #17#9 = (#1#5 * #17#6) < #17#8;||Imp.Tot
          |FINSI;
          #17#11 = #1#13;            ||Tipo de Iva
          #17#13 = #1#11;            ||Familia
          #17#14 = #1#23;            ||Coste
          #17#15 = #0#1;             ||Cliente
          #17#16 = #16#34;           ||Tipo Comision
          #17#17 = #16#35;           ||Tipo Cliente
          #17#48 = #1#29;            ||Uni2
          #17#49 = #1#30;            ||Partida
          #17#50 = #1#31;            ||Merma
          #17#51 = #1#32;
          #17#52 = #1#33;
          #17#53 = #1#34;
          |SI #16#70 = "D";
               #17#38 = #17#6;
          |SINO;
               #17#38 = #17#36;
          |FINSI;
          |HAZ TotalLin71;
          enDescuento1 = #17#8;
          enDescuento2 = #17#33;
          eaTComision  = #17#16;
          eaCliente    = #16#3;
          eaArticulo   = #17#2;
          eaRepre      = #16#6;
          efFecha      = #16#1;
          enDirEnt     = #16#84;
          enAlmacen    = #17#3;
          |SI #17#35 ! 0;
               uni_dt = #17#35;
          |SINO;
               uni_dt = #17#5;
          |FINSI;
          |HAZ Comisiones;
          |HAZ ComiMarhu;
          #17#10 = enComision;

          |GRABA 021#17n;
          |ABRE #947;
          |BUCLE LineasKit;
          |CIERRA #947;
     |FINSI;
     |SI #0#35 = "F";
          |DDEFECTO #13;
          #13#20 = #0#57;        ||Serie
          #13#0 = #0#58;
          #13#1 = #1#1;
          #13#2 = #1#2;                    ||Articulo
          #13#3 = almacen;                  ||almacen
          #13#4 = #1#8;              ||Descripcion
          #13#5 = #1#5;              ||Unidades
          #13#6 = #1#10;             ||Precio
          #13#8 = #1#14;             ||Dto
          |SI #2#194 = 2;
               #13#7 = #1#29 * #13#6;||Importe
               #13#9 = (#1#29 * #13#6) < #13#8;||Imp.Tot
          |SINO;
               #13#7 = #1#5 * #13#6;||Importe
               #13#9 = (#1#5 * #13#6) < #13#8;||Imp.Tot
          |FINSI;
          #13#11 = #1#13;            ||Tipo de Iva
          #13#13 = #1#11;            ||Familia
          #13#14 = #1#23;            ||Coste
          #13#15 = #0#1;             ||Cliente
          #13#16 = #12#34;           ||Tipo Comision
          #13#17 = #12#35;           ||Tipo Cliente
          #13#30 = #1#29;            ||Uni2
          #13#31 = #1#30;            ||Partida
          #13#32 = #1#31;            ||Merma
          |GRABA 021#13n;
          |ABRE #948;
          |BUCLE LineasKit;
          |CIERRA #948;
     |FINSI;
|FPRC;

|DEFBUCLE lin_502;
     #1#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, lin_502;
|FIN;

|PROCESO cabecera;
     |SI #0#3 > 0; beta = 1; |SINO; beta = -1; |FINSI;
     #0#3 = #0#3 * beta;
     nDto = (((#0#3 < #0#17) < #0#19) < #0#18) * beta;
     #0#3 = #0#3 * beta;
     nDto = #0#3 - nDto;   || Total Dto Cabecera

     |SI #0#35 = "A";              ||Es albaran
          operacion = "AV";
          |ATRI P;
          |MENSA "0000CREANDO AUTOMATICAMENTE EL ALBARAN";
          |ATRI p;
          #16#1 = #0#14;             ||Fecha
          #16#3 = #0#1;              ||Cliente
          #16#4 = #33#0;              ||Nombre
          #16#5 = #0#17;             ||Dto
          aAlfa1 = #4#111;    |QBF aAlfa1;
          |SI aAlfa1 ! "";
              #16#6 = ("00" + #4#111) % -102;   || representante fijo
          |SINO;
              #16#6 = ("00" + #0#33) % -102;    || cajero como representante
          |FINSI;
          aRepre = #16#6;
          |HAZ LeeRepre;
          #16#7 = #0#18;             ||Dto pp
          #16#8 = #14#20;             ||Forma de Pago
          #16#9 = #14#35;             ||Agencia Transportes
          #16#15 = #0#3;             ||Total bruto
          #16#16 = #0#20;            ||Base Iva 1
          #16#36 = #0#29;            || Recargo de Equivalencia || *(3)
          #16#40 = #14#41;
          #16#50 = #14#40;           ||Albaran valorado S/N;
          #16#51 = #43#28;
          #16#91 = #14#206;

          eaCli = #0#1; efFiva = #0#14;
          enTiva = 1; |HAZ  IVACli;
          #16#17 = #16#16 % enIva;   || Cuota I.Va. 1
          |SI #16#36 = "S";
               #16#18 = #16#16 % enRec;   || Cuota Rec I.Va. 1
          |FINSI;
          #16#19 = #0#23;            ||Base Iva 2

          enTiva = 2; |HAZ  IVACli;
          #16#20 = #16#19 % enIva;   || Cuota I.Va. 2
          |SI #16#36 = "S";
               #16#21 = #16#19 % enRec;   || Cuota Rec I.Va. 2
          |FINSI;
          #16#22 = #0#26;            ||Base Iva 3

          enTiva = 3; |HAZ  IVACli;
          #16#23 = #16#22 % enIva;   || Cuota I.Va. 3
          |SI #16#36 = "S";
              #16#54 = #16#22 % enRec;   ||Cuota Rec Iva 3
          |FINSI;
          #16#25 = nDto;            ||Total descuento
          #16#28 = #0#30;            ||Base Exenta
          #16#29 = #33#0;             ||Entregar a
          #16#30 = #33#2;             ||Dir Entrega
          #16#31 = #33#3;             ||Pob Entrega
          #16#32 = #0#19;            ||Dto Acumulado
          #16#33 = #33#4;             ||Prov Entrega
          #16#34 = aTComi;             ||Tipo Comision
          #16#35 = #14#4;             ||Tipo Cliente
          #16#62 = (("00" + #33#9) % -102) + (("000" + #33#10) % -103);
          #16#63 = #33#1;             ||DNI;
          #16#44 = #0#48;            ||Base iva 4
          #16#84 = #33#6;

          enTiva = 4; |HAZ  IVACli;
          #16#45 = #16#44 % enIva;   || Cuota I.Va. 4
          |SI #16#36 = "S";
              #16#46 = #16#44 % enRec;   || Cuota Rec I.Va. 4
          |FINSI;
          #16#47 = #0#51;            ||Base iva 5

          enTiva = 5; |HAZ  IVACli;
          #16#48 = #16#47 % enIva;   || Cuota I.Va. 5
          |SI #16#36 = "S";
              #16#49 = #16#47 % enRec;   || Cuota Rec I.Va. 5
          |FINSI;
          #16#24 = #16#17+#16#20+#16#23+#16#18+#16#21+#16#45+#16#46+#16#48+#16#49+#16#54;
          #16#61 = #33#5;             || A cuenta *(1)

          #16#68 = #agifa321#9; ||Divisa
          #16#69 = #agifa324#2; ||Cambio divisa a euros
          #16#70 = "B";         ||Moneda de trabajo
          #16#71 = "A";         ||Cambio en albaran
          #16#73 = #agifa321#9; ||Moneda Base
          #16#74 = #agifa324#2; ||Cambio moneda base a euros
          #16#75 = #0#3;        ||Bruto en Divisa
          #16#76 = #0#9;        ||Total Albaran en Divisa
          #16#77 = #0#3;        ||Bruto (vis)
          #16#78 = #0#9;        ||Total (vis)
          #16#79 = #0#3;        ||Bruto (no vis)
          #16#80 = #0#9;        ||Total (no vis)
     |SINO;
          |HAZ Factura;
     |FINSI;
     |ABRE #2;
     |ABRE #34;
     |||BUCLELIN 2lin_502#0;
     |BUCLE lin_502;
     |CIERRA #2;
     |CIERRA #34;
     |BLIN 4;
|FPRC;

|PROCESO Factura;
     |MENSA "0000CREANDO FACTURA";
     operacion = "FC";
     #12#1 = #0#14;                   ||Fecha
     #12#3 = #0#1;                    ||Cliente
     #12#4 = #33#0;                   ||Nombre
     #12#5 = #0#17;                   ||Dto
     aAlfa1 = #4#111;    |QBF aAlfa1;
     |SI aAlfa1 ! "";
          #12#6 = #4#111;            || representante fijo
     |SINO;
          #12#6 = ("00" + #0#33) % -102;             || cajero como representante
     |FINSI;
     aRepre = #12#6;
     |HAZ LeeRepre;
     #12#7 = #0#18;             ||Dto pp
     #12#8 = #14#20;            ||Forma de Pago
     #12#9 = #14#35;            ||Agencia Transportes
     #12#15 = #0#3;             ||Total bruto
     #12#36 = #0#29;            ||Regimen equivalencia || *(3)

     #12#29 = #33#0;             ||Entregar a
     #12#30 = #33#2;             ||Dir Entrega
     #12#31 = #33#3;             ||Pob Entrega
     #12#32 = #0#19;             ||Dto Acumulado
     #12#33 = #33#4;             ||Prov Entrega
     #12#34 = aTComi;             ||Tipo Comision
     #12#35 = #14#4;             ||Tipo Cliente
     #12#60 = #33#1;             ||Cif

     #12#28 = #0#30;            ||Base Exenta

     #12#16 = #0#20;            ||Base Iva 1
     #12#17 = #0#21;            ||Cuota Iva 1
     #12#18 = #0#22;            ||Cuota Rec Iva 1

     #12#19 = #0#23;            ||Base Iva 2
     #12#20 = #0#24;            ||Cuota Iva 2
     #12#21 = #0#25;            ||Cuota Rec Iva 2

     #12#22 = #0#26;            ||Base Iva 3
     #12#23 = #0#27;            || Cuota I.Va. 3
     #12#49 = #0#47;

     #12#42 = #0#48;            ||Base iva 4
     #12#43 = #0#49;            ||Cuota iva 4
     #12#44 = #0#50;            ||Cuota Rec iva 4

     #12#45 = #0#51;            ||Base iva 5
     #12#46 = #0#52;            ||Cuota iva 5
     #12#47 = #0#53;            ||Cuota Reciva 5

     #12#24 = #0#4;             ||Total iva
     #12#25 = nDto;             ||Total descuento
     #12#41 = #0#9;             ||Total factura
     #12#63 = #33#5;            ||a Cuenta
     #12#91 = #33#6;
     #12#64 = (("00" + #33#9) % -102) + (("000" + #33#10) % -103);

     j = 49;
     |PARA i = 1; |SI i [ 5; |HACIENDO i = i + 1;
          #1#13 = i;
          eaCli = #0#1; enTiva = i; efFiva = #0#14;  |HAZ IVACli;
          j = j + 1; #12#j# = enIva;
          j = j + 1; #12#j# = enRec;
     |SIGUE;

     #12#67 = "B";           ||Moneda de trabajo
     #12#65 = #agifa321#9;   ||Divisa
     #12#68 = #agifa321#9;   ||Moneda Base
     #12#66 = #agifa324#2;   ||Cambio moneda base a euros
     #12#69 = #agifa324#2;   ||Cambio moneda base a euros
     #12#70 = #0#3;    ||Bruto en Divisa
     #12#71 = #0#9;    ||Total Albaran en Divisa
     #12#72 = #0#3;    ||Bruto (vis)
     #12#73 = #0#9;    ||Total (vis)
     #12#74 = #0#3;    ||Bruto (no vis)
     #12#75 = #0#9;    ||Total (no vis)

|FPRC;

||____________________________________/ GRABACION DE UN TIQUET

|PROCESO SiguienteTiq;
     |SALVA_FICHA #0;
   |ET Siguiente;
     |SELECT #2#0;
     aSer = #0#57;
     #0#35 = "T";
     #0#58 = 999999;
     |LEE 000#0];
     |SI FSalida = 0;
          |LEE 000#0a;
     |SINO;
          |LEE 000#0u;
     |FINSI;
     |SI FSalida = 0; |Y #0#57 = aSer; |Y #0#35 = "T";
          conta_reg = #0#58 + 1;
     |SINO;
          conta_reg = 1;
     |FINSI;
     |SELECT #1#0;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ Bloqea registro contador+1
     aSerBloq = #0#36;
     nNumBloq = #0#0;
     |LEE 140#0=;
     |SI FSalida = 107;
          |SLEEP 1;
          |VETE Siguiente;
     |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |REPON_FICHA #0;
|FPRC;

|PROCESO gra_tiquet;
     #0#59 = - 1; ||(*quitar)
     |SI SerAnt = ""; |Y DocAnt = "";
          |SI #142#137 = "F";
               claveconta = "vtiquet";
               |HAZ contique;
          |SINO;
               |HAZ SiguienteTiq;
          |FINSI;
     |SINO;
          conta_reg = #0#58;
          |SI SerAnt ! #0#57; |O DocAnt ! #0#35;
               |HAZ GraDocBorra;
               |SI #142#137 = "F";
                    claveconta = "vtiquet";
                    |HAZ contique;
               |SINO;
                    |HAZ SiguienteTiq;
               |FINSI;
          |FINSI;
     |FINSI;
     #0#58 = conta_reg;     ||Numero de Documento
     #0#44 = "N";
     #0#45 = "00.00.0000";


     |SI #0#58 [ 0; ||(*quitar)
          aAlfa = "0000ERROR: Numero tiquet incorrecto " + #0#58;
          |MENAV aAlfa;
          |MENAV aAlfa;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

||____________________________________/ GRABACION DE UN ALBARAN
|PROCESO SiguienteAlb;
     aSer = #0#57;
     #16#52 = aSer;
     #16#0 = 999999;
     |LEE 000#16];
     |SI FSalida = 0;
          |LEE 000#16a;
     |SINO;
          |LEE 000#16u;
     |FINSI;
     |SI FSalida = 0; |Y #16#52 = aSer;
          conta_reg = #16#0 + 1;
     |SINO;
          conta_reg = 1;
     |FINSI;
     |DDEFECTO #16;
     #16#52 = aSer;
     #16#0 = conta_reg;
|FPRC;

|PROCESO RecalAlba;
     |ABRE #16;
     #16#52 = #0#57;
     #16#0 = #0#58
     |LEE 101#16=;
     |SI FSalida = 0;
          |HAZ LimCabAgifa010;
          |BUCLELIN 0 CalCabAgifa010 #16;
          |GRABA 020#16a;
     |FINSI;
     |CIERRA #16;
|FPRC;

|PROCESO gra_albaran;
     |ABRE #16;
     |ABRE #17;
     |SI SerAnt = ""; |Y DocAnt = "";
          |SI #142#137 = "F";
               |PARA FSalida = 0; |SI FSalida = 0; |HACIENDO;
                    |DDEFECTO #16;
                    claveconta = "valbaran";
                    |HAZ contique;
                    #16#52 = #0#57;
                    #16#0 = conta_reg;
                    |LEE 001#16=;
               |SIGUE;
               |DDEFECTO #16;
               #16#52 = #0#57;
               #16#0 = conta_reg;
          |SINO;
               |HAZ SiguienteAlb;
          |FINSI;
     |SINO;
          conta_reg = #0#58;
          |SI SerAnt ! #0#57; |O DocAnt ! #0#35;
               |HAZ GraDocBorra;
               |SI #142#137 = "F";
                    |PARA FSalida = 0; |SI FSalida = 0; |HACIENDO;
                         |DDEFECTO #16;
                         claveconta = "valbaran";
                         |HAZ contique;
                         #16#52 = #0#57;
                         #16#0 = conta_reg;
                         |LEE 001#16=;
                    |SIGUE;
                    |DDEFECTO #16;
                    #16#52 = #0#57;
                    #16#0 = conta_reg;
               |SINO;
                    |HAZ SiguienteAlb;
               |FINSI;
          |FINSI;
     |FINSI;

     aMoneda = "B";
     |ABRE #agifa321;
     |LEE 000#agifa321.p;
     |CIERRA #agifa321;
     aDivisa = #agifa321#9;
     |HAZ Divisas010;

     |HAZ lee_serie;
     #16#58 = "N";
     #16#59 = "00.00.0000";
     #16#90 = "N";
     |GRABA 021#16b;
     #0#58 = conta_reg;      ||Numero de Documento
     |HAZ cabecera;
     |GRABA 021#16a;
     |SI #16#61 ! 0;
          |HAZ EntregaCta501;
     |FINSI;

     eaTag = "AV";  |HAZ Riesgos;

     |LIBERA #16;
     |CIERRA #16;
     |CIERRA #17;

     |HAZ ActSematel;

     |SI #4#40 = "S";
          |CONFI "2400SDesea Imprimir el Albaran : ";
          |SI FSalida = 0;
               ser_alb = #0#57;
               num_alb = #0#58;
               |SUB_EJECUTA_NP "agifa014.run";
          |FINSI;
     |FINSI;
|FPRC;
||____________________________________/ GRABACION DE UNA FACTURA
|PROCESO SiguienteFac;
     aSer = #0#57;
     #12#48 = aSer;
     #12#0 = 999999;
     |LEE 000#12];
     |SI FSalida = 0;
          |LEE 000#12a;
     |SINO;
          |LEE 000#12u;
     |FINSI;
     |SI FSalida = 0; |Y #12#48 = aSer;
          conta_reg = #12#0 + 1;
     |SINO;
          conta_reg = 1;
     |FINSI;
     |DDEFECTO #12;
     #12#48 = aSer;
     #12#0 = conta_reg;
|FPRC;

|PROCESO RecalFactura;
     |ABRE #12;
     #12#48 = #0#57;
     #12#0 = #0#58
     |LEE 101#12=;
     |SI FSalida = 0;
          |HAZ LimCabAgifa084;
          |BUCLELIN 0 CalCabAgifa084 #12;
          |GRABA 020#12a;
     |FINSI;
     |CIERRA #12;
|FPRC;

|PROCESO RecalLin84;
     |HAZ TotalLin69;
     |GRABA 020#13a;
     |LIBERA #13;
|FPRC;

|PROCESO gra_factura;
     |ABRE #12;
     |ABRE #13;
     |SI SerAnt = ""; |Y DocAnt = "";
          enSwMenu = 1;
          #12#48 = #0#57;
          |HAZ ContaFD7;
          conta_reg = #12#0;
/*
          |SI #142#137 = "F";
               |PARA FSalida = 0; |SI FSalida = 0; |HACIENDO;
                    |DDEFECTO #12;
                    claveconta = clave_fa;
                    |HAZ contique;
                    #12#48 = #0#57;
                    #12#0 = conta_reg;
                    |LEE 001#12=;
               |SIGUE;
               |DDEFECTO #12;
               #12#48 = #0#57;
               #12#0 = conta_reg;
          |SINO;
               |HAZ SiguienteFac;
          |FINSI;
*/
     |SINO;
          conta_reg = #0#58;
          |SI SerAnt ! #0#57; |O DocAnt ! #0#35;
               |HAZ GraDocBorra;
               enSwMenu = 1;
               #12#48 = #0#57;
               |HAZ ContaFD7;
               conta_reg = #12#0;
/*
               |SI #142#137 = "F";
                    |PARA FSalida = 0; |SI FSalida = 0; |HACIENDO;
                         |DDEFECTO #12;
                         claveconta = clave_fa;
                         |HAZ contique;
                         #12#48 = #0#57;
                         #12#0 = conta_reg;
                         |LEE 001#12=;
                    |SIGUE;
                    |DDEFECTO #12;
                    #12#48 = #0#57;
                    #12#0 = conta_reg;
               |SINO;
                    |HAZ SiguienteFac;
               |FINSI;
*/
          |FINSI;
     |FINSI;

     aMoneda = "B";
     |ABRE #agifa321;
     |LEE 000#agifa321.p;
     |CIERRA #agifa321;
     aDivisa = #agifa321#9;
     |HAZ Divisas084;

     |ABRE #14;
     #14#0 = #0#1;
     |LEE 020#14=;
     |CIERRA #14;
     #12#10 = "N";
     #12#40 = #14#16;    || cuenta contable (R.PRIEGO, 28.12)
     #12#61 = "N";
     #12#62 = "00.00.0000";
     |GRABA 021#12b;
     #0#58 = conta_reg;     ||Numero de Documento
     |HAZ cabecera;

     ||CCC
     ||Como el ticket no tiene el Recargo, hay que volver a calcular la factura
     ||directa que si que lleva el Recargo de Equivalencia.

     |HAZ LimCabAgifa084;
     |BUCLELIN 0 RecalLin84 #12;
     |BUCLELIN 0 CalCabAgifa084 #12;

     |GRABA 021#12a;
     |SI #142#47 = "S";  ||ÄÄÄÄÄÄÄÄÄÄÄÄÄ Acumula en Riesgo Si Crea Recibos = "S"
          |HAZ VenciDir;
          eaTag = "FC";  |HAZ Riesgos;
     |FINSI;

     |LIBERA #12;
     |CIERRA #12;
     |CIERRA #13;

     |HAZ ActSematel;

     |SI #4#41 = "S";
          |CONFI "2400SDesea Imprimir la Factura : ";
          |SI FSalida = 0;
               serie = #0#57;
               fecha = #0#14;
               numero = #0#58;
               reimpr = "N";
               |SUB_EJECUTA_NP "agifa086.run";
          |FINSI;
     |FINSI;
|FPRC;

---------------------------------------------------------------------
|PROCESO pide_datos;
     |PUSHV 0501 2380;
     |PINPA #0#33;
     |DDEFECTO #33;
     #33#0 = #14#1; |PINTA #33#0;  || N.Fiscal
     #33#1 = #14#15;|PINTA #33#1;  || Nif
     |SI salmenu = 3;
          |SI #142#229 = "E";
               #33#2 = #14#5; |PINTA #33#2;  || Dir.
               #33#3 = #14#6; |PINTA #33#3;  || Pob.
               #33#4 = #14#7; |PINTA #33#4;  || Prv.
               #33#9 = #14#178; |PINTA #33#9;|| CP1
               #33#10 = #14#179; |PINTA #33#10; ||CP2
          |FINSI;
          |SI #142#229 = "F";
               #33#2 = #14#8; |PINTA #33#2;  || Dir.
               #33#3 = #14#9; |PINTA #33#3;  || Pob.
               #33#4 = #14#10;|PINTA #33#4;  || Prv.
               #33#9 = #14#181; |PINTA #33#9;|| CP1
               #33#10 = #14#182; |PINTA #33#10; ||CP2
          |FINSI;
          |SI #142#229 = "C";
               #33#2 = #14#11; |PINTA #33#2;  || Dir.
               #33#3 = #14#12; |PINTA #33#3;  || Pob.
               #33#4 = #14#13;|PINTA #33#4;  || Prv.
               #33#9 = #14#184; |PINTA #33#9;|| CP1
               #33#10 = #14#185; |PINTA #33#10; ||CP2
          |FINSI;
          #33#8 = "A";
     |SINO;
          #33#2 = #14#5; |PINTA #33#2;  || Dir. Envio
          #33#3 = #14#6; |PINTA #33#3;  || Pob. Envio
          #33#4 = #14#7; |PINTA #33#4;  || Prv. Envio
          #33#9 = #14#178; |PINTA #33#9;|| CP1
          #33#10 = #14#179; |PINTA #33#10; ||CP2
          #33#8 = "F";
     |FINSI;
     #33#5 = #0#54;        ||A cuenta
     #33#6 = 1;
     #33#7 = #0#1;
     |PINDA #0#33;
     |ENDATOS #1#33;
     |SI FSalida ! 0;    |DDEFECTO #33;     |FINSI;
     |POPV;
     #0#54 = #33#5;        ||Acuenta Tiquets (C)
|FPRC;

||_________________________________/ ACTUALIZACION DEUDA DEL CLIENTE

|PROCESO actua_deuda;
/*
     |ABRE #14;
     #14#0 = #0#1;
     |LEE 121#14=;
     |SI FSalida = 0;
          #14#49 = #14#49 +. #0#41;  ||Riesgo Cliente
          |GRABA 021#14a;
     |FINSI;
     |CIERRA #14;
*/
     |ABRE #35;
     |DDEFECTO #35;
     #35#0 = #0#1;         ||Leo el cliente de las deudas
     |LEE 101#35=;
     |SI FSalida ! 0;
          #35#1 = #14#1;
          |GRABA 021#35b;
     |FINSI;
     #35#2 = #35#2 +. #0#41;
     #35#4 = #35#4 +. #0#41;
     |ABRE #36;
     |SI tipo = 1;
          #36#0 = #35#0;
          #36#1 = 9999;
          |LEE 001#36];
          |SI FSalida = 0;
               |LEE 001#36a;
          |SINO;
               |LEE 001#36u;
          |FINSI;
          |SI FSalida = 0; |Y #35#0 = #36#0;
               puente_n = #36#1 + 1;
          |SINO;
               puente_n = 1;
          |FINSI;
          |DDEFECTO #36;
          #36#0 = #35#0;
          #36#1 = puente_n;
          #36#2 = #0#57;        ||Serie
          #36#3 = #0#0;         ||Registro
          #36#4 = #0#58;        ||Documento
          #36#5 = #0#14;        ||Fecha
          #36#6 = #0#12;        ||Caja
          #36#7 = #0#33;        ||Cajero
          #36#8 = #0#41;        ||Importe
          #36#9 = #0#41;        ||Importe Pdte
          #36#10 = #0#9;        ||Importe Total
          #36#13 = #0#36;
          |GRABA 021#36n;
     |SINO;
          |SELECT #3#36;
          #36#3 = #0#0;
          #36#13 = #0#36;
          |BORRA 021#36c;
     |FINSI;
     |CIERRA #36;
     |GRABA 021#35a;
     |LIBERA #35;
     |CIERRA #35;
|FPRC;
_________________________________________/ IMPRESION
|PROCESO imprelineas;
     Impresora = impr_tpv;
     |IMPRE -1;
     |INFOR infolin;  |PRINT; |PIEINF; |FININF;
     |FINIMP;
|FPRC;

|PROCESO abre_impre;
     |SI cabeza ! 1;
          aAlfa = (#0#34 % 102) + (#0#34 % 402);
          fGuarda = #0#14;
          |SI  aAlfa ] #4#155; |Y aAlfa [ #4#156;
               #0#14 = #0#14 + 1;
          |FINSI;
          cabeza = 1;
          Impresora = impr_tpv;
          |IMPRE -1;
          |INFOR infocab; |PRINT; |PIEINF; |FININF;
          |FINIMP;
          #0#14 = fGuarda;
     |FINSI;
|FPRC;

|PROCESO fin_imp;
     cabeza = 0;
     Impresora = impr_tpv;
     |IMPRE -1;
     |INFOR infopie;    |PRINT; |PIEINF; |FININF;
     |FINIMP;
     #0#13 = "S";
     #0#16 = #0#16 + 1;
|FPRC;

|PROCESO imprelin;
     |PRINT;
|FPRC;

|PROCESO ImpreSobre;          || Impresion Modulo HIPERFOTO
     nModo = (FEntrada / 100) ! 0;
     |DBASE aNomModulo;
     aNomModulo = aNomModulo + "bin/hiper001.prc";
     |XABRE "E", aNomModulo, 0;
     |SI FSalida ! 0;
          aNomModulo = ""; |ACABA;
     |FINSI;
     |SI nModo = 1; |O nModo = 2;
          |GRABA 020#0a;
     |FINSI;
     |CIERRAT #0;
     aAlfa = ("000000" + #0#0) % -106;
     aAlfa = "hiper001;" + #0#36 + aAlfa;
     |SUB_EJECUTA aAlfa;
     |ABRET #0;
     |SI nModo = 4;
          |LEE 000#0=;
     |SINO;
          |LEE 101#0=;
     |FINSI;
     #0#13 = "S";
     #0#16 = #0#16 + 1;
|FPRC;

|DEFBUCLE imprelin;
     #1#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, imprelin;
|FIN;

|PROCESO Impresion;
     enCambio = 0;
     |SI #0#11 ! 0;
          |SI #0#39 ! 0; |O #0#40 ! 0;
               enCambio = 1;
          |FINSI;
     |FINSI;
     |HAZ lee_serie;
     |SI #4#21 = "S"; |Y #4#32 = "N"; |Y salmenu = 1; || Imp. Normal
               |Y salmenu ! 998;      |Y tipo = 1;
          |HAZ ImpreSobre;
          |SI aNomModulo ! ""; |ACABA; |FINSI;
          aAlfa = (#0#34 % 102) + (#0#34 % 402);
          fGuarda = #0#14;
          |SI  aAlfa ] #4#155; |Y aAlfa [ #4#156;
               #0#14 = #0#14 + 1;
          |FINSI;
          Impresora = impr_tpv;
          |IMPRE -1;
          aAlfa = infolin + infopie; |QBF aAlfa;
          |SI aAlfa = "";
               |INFOR infocab;|BUCLE imprelin; |PIEINF; |FININF;
          |SINO;
               |INFOR infocab; |PRINT; |PIEINF; |FININF;
               |INFOR infolin; |BUCLE imprelin; |PIEINF; |FININF;
               |INFOR infopie; |PRINT; |PIEINF; |FININF;
          |FINSI;
          |FINIMP;
          #0#13 = "S";
          #0#16 = #0#16 + 1;
          #0#14 = fGuarda;
     |FINSI;
     |SI tipo = 1; |Y #4#32 = "S"; |Y salmenu ! 998; || Imp. Directa
          |HAZ fin_imp;
          |SI #4#33 = "S";                          || Imp. Cabecera al Final
               |HAZ abre_impre;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ini_display; |TIPO 0;
     texto = abre_dis + mens_dis + cier_dis;
     |SI mens_dis ! ""; |Y impr_dis ! "";
          Impresora = impr_dis;
          |IMPRE -1;
          |IMPRIMESIN texto;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO total_display;
     |SI impr_dis ! "";
          texto = " " * #4#67;
          texto = texto + impo_dis;
          alfa = "-"  + forma;
          texto = texto % alfa;
          nume1 = forma; nume1 = nume1 - 7;
          alfa = nume1;  alfa = "-" + alfa;
          texto = texto % alfa;
          texto = "TOTAL: " + texto;
          texto = abre_dis + texto + cier_dis;
          Impresora = impr_dis;
          |IMPRE -1;
          |IMPRIMESIN texto;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO cobro_display;
     |SI impr_dis ! ""; |Y #4#68 > 1; || Si tiene mas de 1 linea
          beta = #4#67/#4#68;
          longi = "00" + beta;
          form0 = "1" + (longi % -102);
          texto = " " * beta;
          texto = texto + #0#9;
          alfa = "-"  + form0;
          texto = texto % alfa;
          nume1 = form0; nume1 = nume1 - 7;
          alfa = nume1;  alfa = "-" + alfa;
          texto = texto % alfa;
          text0 = "TOTAL: " + texto;
          texto = " " * beta;
          |SI eaEsEuro = "S";
               texto = texto + #3#3;
          |SINO;
               texto = texto + #3#9;
          |FINSI;
          alfa = "-"  + form0;
          texto = texto % alfa;
          nume1 = form0; nume1 = nume1 - 8;
          alfa = nume1;  alfa = "-" + alfa;
          texto = texto % alfa;
          text0 = text0 + "CAMBIO: " + texto;
          texto = abre_dis + text0 + cier_dis;
          Impresora = impr_dis;
          |IMPRE -1;
          |IMPRIMESIN texto;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO lin_display;
     |SI impr_dis ! "";
          texto = "";
          |PARA beta = 69; |SI beta [ 81; |HACIENDO beta = beta + 3;
               |SI #4beta = 0; |SAL; |FINSI;
               pos0 = beta + 1; lon0 = beta + 2;
               longi = texto % A0; long = longi;
               bet0 = #4pos0 - long - 1;
               alfa = " " * bet0;
               texto = texto + alfa;
               alfa = " " * #4#67;
               |SI #4beta = 1; cam0 = 2; |FINSI;     || Cod
               |SI #4beta = 2; cam0 = 5; |FINSI;     || Uni
               |SI #4beta = 3; cam0 = 8; |FINSI;     || Des
               |SI #4beta = 4; cam0 = 6; |FINSI;     || Pre
               |SI #4beta = 5; cam0 = 7; |FINSI;     || Imp Linea
               |SI #4beta = 6;
                    bet0 = #0#9 + #1#7;
                    alfa = bet0 + alfa;              || Imp parcial
               |SINO;
                    alfa = #1cam0 + alfa;
               |FINSI;
               longi = "00" + #4lon0;
               form0 = "1" + (longi % -102);
               alfa = alfa % form0;
               texto = texto + alfa;
          |SIGUE;
          |QBF texto;
          alfa = "." * #4#67;
          texto = texto + alfa;
          texto = texto % forma;
          texto = abre_dis + texto + cier_dis;
          Impresora = impr_dis;
          |IMPRE -1;
          |IMPRIMESIN texto;
          |FINIMP;
     |FINSI;
|FPRC;
=========================================================================
|PROCESO PideSerie;
     |SI salida ! 18;    || SERIE OFICIAL
          |SI salmenu = 1; cSerie = #4#105; alfa = "T"; |FINSI;
          |SI salmenu = 2; cSerie = #4#106; alfa = "A"; |FINSI;
          |SI salmenu = 3; cSerie = #4#107; alfa = "F"; |FINSI;
     |SINO;              || SERIE NEGRA
          |SI salmenu = 1; cSerie = #4#89;  alfa = "T"; |FINSI;
          |SI salmenu = 2; cSerie = #4#103; alfa = "A"; |FINSI;
          |SI salmenu = 3; cSerie = #4#104; alfa = "F"; |FINSI;
     |FINSI;

     |SI #4#39 = "S"; || si debemos pedir la serie
          |SI C1_1 ! "";                || Es Modificacion
               |SI C1_36 = alfa;        || Y mismo tipo Documento
                    cSerie = C1_58;     || la serie es igual a la anterior
               |FINSI;
          |FINSI;
          |PUSHV 0101 2380;
          |BLANCO 1905 2326;
          |D_CUADRO 1905, 2326;
          |ATRI R;|PINTA 1905, "     SERIE TIQUET     "; |ATRI 0;
          |ATRI R;|PINTA 2107, " SERIE.:"; |ATRI 0;
        |ET OtraSerie;
          E_sup = 5;
          E_inf = "";
          cSerie = 2116 ? 1;
          nEstado = FSalida;
          |SI nEstado ! 0;
              |VETE OtraSerie;
          |SINO;
               |ABRE #43;
               #43#26 = cSerie;
               |LEE 000#43=;
               |SI FSalida ! 0;
                    |MENAV "0000­­­ LA SERIE NO EXISTE... !!!";
                    |VETE OtraSerie;
               |FINSI;
               |CIERRA #43;
          |FINSI;
          |POPV;
     |FINSI;
     #0#57 = cSerie;

     |HAZ EsAparecida;
     |SI FSalida = 0;
          |ABRE #43;
          #43#26 = #0#57;
          |LEE 000#43=;
          |SI FSalida = 0; |Y #43#30 = "S";  ||Serie exportacion
               eaSerExp = "S";
               |HAZ Recal501;
               eaSerExp = "";
               |HAZ PintaVisor;
          |FINSI;
          |CIERRA #43;
     |FINSI;
|FPRC;

|PROCESO k1; |TIPO 4;
     |SELECT #1#0;
     |LEE 000#0=;
     |SI FSalida ! 0;
          |MENAV "0000Por favor, consulte el registro correcto antes de imprimir.";
          |ACABA;
     |SINO;
          |PINDA #0#0;
          FEntrada = 402;
     |FINSI;
     |HAZ T20;
|FPRC;

|PROCESO T20;
     enCambio = 0;
     |SI #0#11 ! 0;
          |SI #0#39 ! 0; |O #0#40 ! 0;
               enCambio = 1;
          |FINSI;
     |FINSI;

     |SI #0#35 = "T";            || Imprimir tiket.
          |HAZ lee_serie;
          |SI #4#32 = "N";
               |HAZ ImpreSobre;
               |SI aNomModulo ! ""; |ACABA; |FINSI;
               aAlfa = (#0#34 % 102) + (#0#34 % 402);
               fGuarda = #0#14;
               |SI  aAlfa ] #4#155; |Y aAlfa [ #4#156;
                    #0#14 = #0#14 + 1;
               |FINSI;
               Impresora = impr_tpv;
               |IMPRE -1;
               aAlfa = infolin + infopie;
               |SI aAlfa = "";
                    |INFOR infocab; |BUCLE imprelin; |PIEINF; |FININF;
               |SINO;
                    |INFOR infocab; |PRINT; |PIEINF; |FININF;
                    |INFOR infolin; |BUCLE imprelin; |PIEINF; |FININF;
                    |INFOR infopie; |PRINT; |PIEINF; |FININF;
               |FINSI;
               |FINIMP;
               #0#14 = fGuarda;
          |FINSI;
          |SI #4#32 = "S";
               |HAZ fin_imp;
               |SI #4#33 = "S";            || Imp. Cabecera al Final
                    |HAZ abre_impre;
                |FINSI;
          |FINSI;
     |FINSI;

     |SI #0#35 = "F";            || Imprimir Factura.
          serie = #0#57;
          fecha = #0#14;
          numero = #0#58;
          |SUB_EJECUTA_NP "agifa086.run";
     |FINSI;
     |SI #0#35 = "A";            || Imprimir Albaran.
          ser_alb = #0#57;
          num_alb = #0#58;
          |SUB_EJECUTA_NP "agifa014.run";
     |FINSI;
|FPRC;

|PROCESO ClaveDto;
     |BLIN 24;
     |PINTA 2425, "Entre la Clave:";
     alfa = "";
     E_sup = 10;
     E_inf = "";
     alfa = 2441 ? -1;
     |BLIN 24;
     nu2 = 0;
     |PARA i = 101; |SI i [ 1100; |HACIENDO i = i + 100;
          alf1 = alfa % i;
          nu1 = &alf1 * i;    || Encripta la clave
          nu2 = nu2 + nu1;
     |SIGUE;
     aClave = nu2;
     |QBF aClave;
|FPRC;

|PROCESO caldecim;
     |ABRE #agifa324;
     |ABRE #agifa321;
     |LEE 001#agifa321.p;
     #agifa324#0 = #agifa321#9; ||Igualo a moneda base
     |LEE 001#agifa324.=;
     nDeci_PreBase = #agifa324#9;  ||Decimales precio de moneda base
     nDeci_PreBaseMx = #agifa324#9;  ||Decimales precio de moneda base
     nDeci_PreVis = #agifa324#9;   ||Decimales precio de moneda base
     |CIERRA #agifa321;
     |CIERRA #agifa324;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO CargaAparcado;
     |SI #101#36 = #0#36; |Y #101#0 = #0#0;
          |ACABA;
     |FINSI;

     aAlfa = "|NC";
     aAlfa = #101#aAlfa#;
     nCampos = aAlfa;
     nCampos = nCampos - 1;
     |PARA i = 0; |SI i [ nCampos; |HACIENDO i = i + 1;
          #100i = #101i;
     |SIGUE;
     |GRABA 020#100n;
     nHay = 1;
|FPRC;

|DEFBUCLE CargaAparcado;
     #101#2003;
     33;
     "N", "     ", 000000, nDCajero;
     "N", "zzzzz", 999999, nHCajero;
     ;
     NULL, CargaAparcado;
|FIN;

|PROCESO RecogeAparca;
     |DDEF aDef;

     aAlfa = aDef + "agifa501";
     |CARGA_DEF aAlfa, tmp00501@;
     |SI FSalida ! 0;
          |MENAV "0000ERROR al cargar agifa501";
          |ACABA;
     |FINSI;

     aAlfa = aDef + "agifa501";
     |CARGA_DEF aAlfa, agifa501@;
     |SI FSalida ! 0;
          |MENAV "0000ERROR al cargar agifa501";
          |DESCARGA_DEF #tmp00501@; |ACABA;
     |FINSI;

     aAlfa = Usuario;
     |NOME_DAT #100 aAlfa; |DELINDEX #100;
     |ABRE #100;

     |SI #4#168 = "S";
          |PUSHV 0501 2380;
          |BLANCO 1624 2145;
          |CUADRO 1624 2145;
          |ATRI R; |PINTA 1725, "  Recuperar Tiquet  "; |ATRI 0;
          |PINTA 1926, " Cajero:";
          E_inf = 0;
          E_sup = 99999;
          nDCajero = 1936 ? 1;
          nHCajero = nDCajero;
          |POPV;
     |SINO;
          nDCajero = 0;
          nHCajero = 99999;
     |FINSI;

     nHay = 0;
     |BUCLE CargaAparcado;
     |SI nHay ! 0;
          |LEE 000#100p;
          |CONSULTA_CLAVE #1#100;
          |SI FSalida = 0;
               enNumAparca = #100#0;
          |FINSI;
     |SINO;
          |MENAV "0000No hay tiquets aparcados...";
     |FINSI;
     |CIERRA #100;
     |DELINDEX #100;

     |DESCARGA_DEF #agifa501@;
     |DESCARGA_DEF #tmp00501@;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
CONTROL CABECERAS / LINEAS
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO Min502;
     #1#20 = #0#36;
     #1#0 = #0#0;
     #1#1 = 1;
|FPRC;

|PROCESO Max502;
     #1#20 = #0#36;
     #1#0 = #0#0;
     #1#1 = 999;
|FPRC;

|PROCESO Min502Vacio;
     #1#20 = #0#36;
     #1#0 = #0#0;
     #1#1 = 999;
|FPRC;

|PROCESO Tipo7; |TIPO 7;
     |ENTLINEAL #1#1, 3, 7, 22, 0, Min502Vacio, Max502;
|FPRC;

|PROCESO Tipo12; |TIPO 12;
|FPRC;

|PROCESO RecalProforma;
     eaCli = #0#1; enTiva = #1#13; efFiva = #0#14;  |HAZ IVACli;

     nBase = ((#1#10 * #1#5) < #1#14);
     #1#7 = (nBase + (nBase * enIva / 100)) ! EURODB;
     #1#21 = nBase ! EURODB;
     #1#19 = #1#7 - #1#21;
     #1#6 = #1#10 + (#1#10 * enIva / 100);
     #1#6 = #1#6 ! #30#19;

     |ABRE #2;
     #2#0 = #2#2;
     |LEE 000#2=;
     |CIERRA #2;

     #1#23 = #2#9 * #1#5;

     enForma = 1;
     |HAZ AcumulaTPV;
     #1#23 = enCoste;

     |SI #1#21 > 0;
         nNume = 1;
     |SINO;
         nNume = -1;
         #1#21 =  -#1#21;
     |FINSI;
     imneto = ((((#1#21 < #0#17) < #0#19) < #0#18)) * nNume;
     #1#21 = #1#21 * nNume;

     |GRABA 020#1a;
     |LIBERA #1;

     #0#8 = #0#8 + (imneto - enCoste);
     #0#76 = #0#76 + #1#5;
|FPRC;

|DEFBUCLE RecalProforma;
     #1#1;
     ;
     #0#36, #0#0, 001;
     #0#36, #0#0, 999;
     ;
     NULL, RecalProforma;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     nModo = (FEntrada / 100) ! 0;

     |SI nError ! 0; |ACABA; |FINSI;    || nError lo carga el TIPO 2

     |HAZ EsAparecida;
     |SI FSalida = 0; |Y eaSerPro ! "";
          |HAZ CargaProforma;
          |BUCLE RecalProforma;
          |HAZ Recal501;
          |HAZ PintaVisor;
     |FINSI;

  |ET EntraLin;
     |ENTLINEAL #1#1, 3, nModo, 22, 0, Min502, Max502;

     |ABRE #1;
     #1#20 = #0#36;
     #1#0 = #0#0;
     #1#1 = 1;
     |LEE 101#1];
     |SI FSalida ! 0; |O #1#20 ! #0#36; |O #1#0 ! #0#0;
          |SI nModo = 1; |Y enNumAparca = 0;
               |MENAV "0000Se anulan los datos entrados...";
               |ERROR;
          |FINSI;
     |FINSI;
     |CIERRA #1;
     |SI salmenu = 998;
          enNumAparca = 0;
          |HAZ RecogeAparca;
          |SI enNumAparca ! 0;
               |HAZ t2_501;
               |GRABA 020#0a;
               |CIERRAT #0;

               |ABRET #0;
               #0#0 = enNumAparca;
               enNumAparca = 0;
               |LEE 121#0=;
               |SI FSalida = 0;
                    |PINDA #0#0;
                    |SI #4#9 = "N"; |PTEC 802; |FINSI;
                    salmenu = 0;
                    |VETE EntraLin;
               |FINSI;
          |FINSI;
          salmenu = 0;
     |FINSI;
     |SI enNumAparca ! 0;
          |CIERRAT #0;
          |ABRET #0;
          |BORRA 020#0c;

          #0#0 = enNumAparca;
          enNumAparca = 0;
          |LEE 121#0=;
          |SI FSalida = 0;
               |PINDA #0#0;
               |SI #4#9 = "N"; |PTEC 802; |FINSI;
               |VETE EntraLin;
          |FINSI;
     |FINSI;

|FPRC;

|PROCESO Tipo13; |TIPO 13;
     |ENTLINEAL #1#1, 3, 7, 22, 0, Min502, Max502;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO AltaCli;
     aAlfa = #0#1; |QBF alfa;
     |SI aAlfa ! ""; |Y #142#1 = "S";
          |ABRE #14;
          #14#0 = #0#1;
          |LEE 000#14=;
          |SI FSalida ! 0;
               |MENU aMenuCli;
               |SI FSalida = 1;    ||Automatico
                    |ABRE #5;
                    #5#2 = "";
                    #5#0 = "clientes";
                    |LEE 101#5=;
                    |SI FSalida = 0;
                         #5#1 = #5#1 + 1;
                         nNume1 = #5#1;
                         |GRABA 021#5a;
                    |SINO;
                         nNume1 = 1;
                         #5#1 = 1;
                         |GRABA 021#5n;
                    |FINSI;
                    aAlfa = ("000000" + nNume1) % -106;
                    #0#1 = aAlfa;
                    |PINTA #0#1;
                    |CIERRA #5;
               |FINSI;
          |FINSI;
          |CIERRA #14;
     |FINSI;
|FPRC;

|PROCESO LeeRepre;
     |DDEF aDef;
     aDef = aDef + "agifa025";  || Por que supera el limite de fichero en el PRC
     |CARGA_DEF aDef, tmp00501@;
     |SI FSalida = 0;
          |ABRE #100;
          #100#0 = aRepre;
          |LEE 000#100=;
          |CIERRA #100;
          aTComi = #100#7;
          |DESCARGA_DEF #tmp00501@;
     |FINSI;
|FPRC;

|PROCESO ActSematel;
     |SI enSwSematel = 0;
          |GRABA 020#0a;
          |CIERRAT #0;
          eaSerIMEI = #0#36;
          enDocIMEI = #0#0;
          |SUB_EJECUTA_NP "tlfw0003;ACTUALIZA";
          |ABRET #0;
          #0#36 = eaSerIMEI;
          #0#0 = enDocIMEI;
          |LEE 101#0=;
     |FINSI;
|FPRC;
