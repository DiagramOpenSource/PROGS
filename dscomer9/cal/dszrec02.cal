|FICHEROS;
     dszrec02;
     agifa036 #0;
     agifa070 #3;

     agifa142;
     agifa019 #2;
|FIN;

|VARIABLES;
     nCanon = 0;
     &enForma = 0;
     nTotPVerde = 0;
     nImporDescue1 = 0;
     nImporDescue2 = 0;
     nImporDescue3 = 0;
     nImporMoneda1 = 0;
     nImporMoneda2 = 0;
     nDescuMoneda1 = 0;
     nDescuMoneda2 = 0;

     &nDeci_IVA    = 0;
     &nDeci_IVADiv = 0;
     &nDeci_DivD   = 0;
     nImpDiv       = 0;
     nError        = 0;
     nNume         = 0;
     nCanti        = 0;
     nMargen       = 0;
     nBrutoMoneda1 = 0;
     nBrutoMoneda2 = 0;

     &eaCli        = "";
     &enTiva       = 0;
     &enIva        = 0;
     &enRec        = 0;
     &efFiva = @;
     aAlfa = "";
     nPreTon = 0;
|FIN;

|PROCESO BseVerdeBase36;
     |SI #agifa142#177 ! "S";
          |ACABA;
     |FINSI;

     nBrutoMoneda1 = nBrutoMoneda1 + #agifa070#37;
     nBrutoMoneda2 = nBrutoMoneda2 + #agifa070#37;
     nTotPVerde = #agifa036#62;
|FPRC;

|PROCESO IvasAgifa036;
     efFiva = #agifa036#1;
     |HAZ IVACli;
     |SI enTiva = 0;
         #agifa036#28  = #agifa036#28  +. nBrutoMoneda1;
         #dszrec02#00  = #dszrec02#00  +. nBrutoMoneda2;
     |FINSI;

     |SI enTiva = 1;
         #agifa036#16 = #agifa036#16 +. nBrutoMoneda1;
         nNume        = #agifa036#16;
         #agifa036#17 = #agifa036#16 % enIva;
         |SI #agifa036#36 = "S";
             #agifa036#18 = nNume % enRec;
         |FINSI;

         #dszrec02#1  = #dszrec02#1  +. nBrutoMoneda2;
         nNume        = #dszrec02#1;
         #dszrec02#2  = #dszrec02#1 % enIva;
         |SI #agifa036#36 = "S";
             #dszrec02#3 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 2;
         #agifa036#19 = #agifa036#19 +. nBrutoMoneda1;
         nNume        = #agifa036#19;
         #agifa036#20 = #agifa036#19 % enIva;
         |SI #agifa036#36 = "S";
             #agifa036#21 = nNume % enRec;
         |FINSI;

         #dszrec02#4  = #dszrec02#4  +. nBrutoMoneda2;
         nNume        = #dszrec02#4;
         #dszrec02#5  = #dszrec02#4 % enIva;
         |SI #agifa036#36 = "S";
             #dszrec02#6 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 3;
         #agifa036#22 = #agifa036#22 +. nBrutoMoneda1;
         nNume        = #agifa036#22;
         #agifa036#23 = #agifa036#22 % enIva;
         |SI #agifa036#36 = "S";
             #agifa036#47 = nNume % enRec;
         |FINSI;

         #dszrec02#7  = #dszrec02#7  +. nBrutoMoneda2;
         nNume        = #dszrec02#7;
         #dszrec02#8  = #dszrec02#7 % enIva;
         |SI #agifa036#36 = "S";
             #dszrec02#9 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 4;
         #agifa036#40 = #agifa036#40 +. nBrutoMoneda1;
         nNume        = #agifa036#40;
         #agifa036#41 = #agifa036#40 % enIva;
         |SI #agifa036#36 = "S";
             #agifa036#42 = nNume % enRec;
         |FINSI;

         #dszrec02#10 = #dszrec02#10 +. nBrutoMoneda2;
         nNume        = #dszrec02#10;
         #dszrec02#11 = #dszrec02#10 % enIva;
         |SI #agifa036#36 = "S";
             #dszrec02#12 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 5;
         #agifa036#43 = #agifa036#43 +. nBrutoMoneda1;
         nNume        = #agifa036#43;
         #agifa036#44 = #agifa036#43 % enIva;
         |SI #agifa036#36 = "S";
             #agifa036#45 = nNume % enRec;
         |FINSI;

         #dszrec02#13 = #dszrec02#13 +. nBrutoMoneda2;
         nNume        = #dszrec02#13;
         #dszrec02#14 = #dszrec02#13 % enIva;
         |SI #agifa036#36 = "S";
             #dszrec02#15 = nNume % enRec;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO LimCabAgifa036;
     nTotPVerde = 0;
     |ABRE #agifa142; |LEE 000#agifa142.p; |CIERRA #agifa142;

     |DDEFECTO #dszrec02;

     #agifa036#15 = 0;
     #agifa036#16 = 0;
     #agifa036#17 = 0;
     #agifa036#18 = 0;
     #agifa036#19 = 0;
     #agifa036#20 = 0;
     #agifa036#21 = 0;
     #agifa036#22 = 0;
     #agifa036#23 = 0;
     #agifa036#24 = 0;
     #agifa036#25 = 0;
     #agifa036#26 = 0;
     #agifa036#28 = 0;
     #agifa036#37 = 0;
     #agifa036#40 = 0;
     #agifa036#41 = 0;
     #agifa036#42 = 0;
     #agifa036#43 = 0;
     #agifa036#44 = 0;
     #agifa036#45 = 0;
     #agifa036#47 = 0;
     #agifa036#48 = 0;
     #agifa036#54 = 0;
     #agifa036#55 = 0;
     #agifa036#62 = 0;
     #agifa036#63 = 0;
|FPRC;

|PROCESO CalCabAgifa036;
     ||----------------------------  Margen
     |SI #agifa070#9 ] 0;
          nError = 1;
     |SINO;
          nError = -1;
          #agifa070#9   = -#agifa070#9;
          #agifa070#25  = -#agifa070#25;
     |FINSI;

     nCanti = #agifa070#9 < #agifa036#5;
     nCanti = nCanti < #agifa036#32;
     |SI #agifa142#115 = "S";
          nCanti = nCanti < #agifa036#7;
     |FINSI;

     nCanti = nCanti * nError;
     |SI #agifa019#194 = 1;
         nMargen = #agifa070#5 * #agifa019#9;
     |SINO;
         nMargen = #agifa070#28 * #agifa019#9;
     |FINSI;
     nMargen = nCanti - nMargen;
     #agifa036#37 = #agifa036#37 + nMargen;
     #agifa070#9  = #agifa070#9  * nError;
     #agifa070#25 = #agifa070#25 * nError;
     ||----------------------------

     #agifa036#15 = #agifa036#15 +. #agifa070#9;
     #agifa036#54 = #agifa036#54 +. #agifa070#25;
     #agifa036#62 = #agifa036#62 +. #agifa070#37;

     nBrutoMoneda1 = #agifa070#9;
     nImporDescue1 = (nBrutoMoneda1 % #agifa036#5) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #agifa036#32) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #agifa036#7) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     nDescuMoneda1 = nImporDescue1 + nImporDescue2 + nImporDescue3;

     nBrutoMoneda2 = #agifa070#25;
     nImporDescue1 = (nBrutoMoneda2 % #agifa036#5) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #agifa036#32) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #agifa036#7) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     nDescuMoneda2 = nImporDescue1 + nImporDescue2 + nImporDescue3;
/*
     nBrutoMoneda1 = (#agifa070#9  < #agifa036#5) ! nDeci_IVA;
     nBrutoMoneda1 = (nBrutoMoneda1  < #agifa036#32) ! nDeci_IVA;
     nBrutoMoneda1 = (nBrutoMoneda1  < #agifa036#7) ! nDeci_IVA;

     nBrutoMoneda2 = (#agifa070#25 < #agifa036#5) ! nDeci_IVADiv;
     nBrutoMoneda2 = (nBrutoMoneda2 < #agifa036#32) ! nDeci_IVADiv;
     nBrutoMoneda2 = (nBrutoMoneda2 < #agifa036#7) ! nDeci_IVADiv;
*/

     |HAZ BseVerdeBase36;

     eaCli       = #agifa036#3;
     enTiva      = #agifa070#11;
     |HAZ IvasAgifa036;

     |SI #agifa070#38 = -1;
          nCanon = #agifa070#9 + (#agifa070#9 % enIva);
          |SI #agifa036#36 = "S";
               nCanon = nCanon + (#agifa070#9 % enRec);
          |FINSI;
          #agifa036#63 = #agifa036#63 +. nCanon;
     |FINSI;

     nNume = nBrutoMoneda1 % #agifa070#10;
     #agifa036#26 = #agifa036#26 +. nNume;

     #agifa036#25 = #agifa036#25 +. nDescuMoneda1

/*
     |SI #agifa036#15 > 0;
         nError = 1;
     |SINO;
         nError = -1;
         #agifa036#15 = -#agifa036#15;
         #agifa036#54 = -#agifa036#54;
     |FINSI;
     #agifa036#25 = #agifa036#15 < #agifa036#5;
     #agifa036#25 = #agifa036#25 < #agifa036#32;
     #agifa036#25 = #agifa036#25 < #agifa036#7;
     #agifa036#25 = #agifa036#25 * nError;
     #agifa036#15 = #agifa036#15 * nError;
     #agifa036#25 = #agifa036#15 - #agifa036#25;
*/

     #agifa036#24 = #agifa036#17 + #agifa036#18 + #agifa036#20 + #agifa036#21 + #agifa036#23 + #agifa036#41 + #agifa036#42 + #agifa036#44 + #agifa036#45 + #agifa036#47;

     #dszrec02#17 = #dszrec02#17 +. nDescuMoneda2;
/*
     #dszrec02#17 = #agifa036#54 < #agifa036#5;
     #dszrec02#17 = #dszrec02#17 < #agifa036#32;
     #dszrec02#17 = #dszrec02#17 < #agifa036#7;
     #dszrec02#17 = #dszrec02#17 * nError;
     #agifa036#54 = #agifa036#54 * nError;
     #dszrec02#17 = #agifa036#54 - #dszrec02#17;
*/

     #dszrec02#16 = #dszrec02#02 + #dszrec02#03 + #dszrec02#05 + #dszrec02#06 + #dszrec02#08 + #dszrec02#09 + #dszrec02#11 + #dszrec02#12 + #dszrec02#14 + #dszrec02#15;

     #agifa036#48 = #agifa036#15 - #agifa036#25 + #agifa036#24 + nTotPVerde;
     #agifa036#55 = #agifa036#54 - #dszrec02#17 + #dszrec02#16 + nTotPVerde;

     |SI #agifa036#51 = "B";  || Asigna campos visual. y no visual. en el pedido segun la moneda de trabajo
         #agifa036#56 = #agifa036#15;
         #agifa036#57 = #agifa036#48;
         #agifa036#58 = #agifa036#54;
         #agifa036#59 = #agifa036#55;
     |SINO;
         #agifa036#56 = #agifa036#54;
         #agifa036#57 = #agifa036#55;
         #agifa036#58 = #agifa036#15;
         #agifa036#59 = #agifa036#48;
     |FINSI;
|FPRC;

|PROCESO CalCabAgifa036_2;    || cambia +. por enForma
     ||----------------------------  Margen
     |SI #agifa070#9 ] 0;
          nError = 1;
     |SINO;
          nError = -1;
          #agifa070#9   = -#agifa070#9;
          #agifa070#25  = -#agifa070#25;
     |FINSI;

     nCanti = #agifa070#9 < #agifa036#5;
     nCanti = nCanti < #agifa036#32;
     |SI #agifa142#115 = "S";
          nCanti = nCanti < #agifa036#7;
     |FINSI;

     nCanti = nCanti * nError;
     |SI #agifa019#194 = 1;
         nMargen = #agifa070#5 * #agifa019#9;
     |SINO;
         nMargen = #agifa070#28 * #agifa019#9;
     |FINSI;
     nMargen = nCanti - nMargen;
     #agifa036#37 = #agifa036#37 + nMargen;
     #agifa070#9  = #agifa070#9  * nError;
     #agifa070#25 = #agifa070#25 * nError;
     ||----------------------------

     #agifa036#15 = #agifa036#15 + (#agifa070#9 * enForma);
     #agifa036#54 = #agifa036#54 + (#agifa070#25 * enForma);
     #agifa036#62 = #agifa036#62 + (#agifa070#37 * enForma);

     nBrutoMoneda1 = #agifa070#9;
     nImporDescue1 = (nBrutoMoneda1 % #agifa036#5) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #agifa036#32) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #agifa036#7) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     nDescuMoneda1 = nImporDescue1 + nImporDescue2 + nImporDescue3;

     nBrutoMoneda2 = #agifa070#25;
     nImporDescue1 = (nBrutoMoneda2 % #agifa036#5) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #agifa036#32) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #agifa036#7) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     nDescuMoneda2 = nImporDescue1 + nImporDescue2 + nImporDescue3;
/*
     nBrutoMoneda1 = (#agifa070#9  < #agifa036#5) ! nDeci_IVA;
     nBrutoMoneda1 = (nBrutoMoneda1  < #agifa036#32) ! nDeci_IVA;
     nBrutoMoneda1 = (nBrutoMoneda1  < #agifa036#7) ! nDeci_IVA;

     nBrutoMoneda2 = (#agifa070#25 < #agifa036#5) ! nDeci_IVADiv;
     nBrutoMoneda2 = (nBrutoMoneda2 < #agifa036#32) ! nDeci_IVADiv;
     nBrutoMoneda2 = (nBrutoMoneda2 < #agifa036#7) ! nDeci_IVADiv;
*/

     |HAZ BseVerdeBase36;

     eaCli       = #agifa036#3;
     enTiva      = #agifa070#11;
     |HAZ IvasAgifa036;

     |SI #agifa070#38 = -1;
          nCanon = #agifa070#9 + (#agifa070#9 % enIva);
          |SI #agifa036#36 = "S";
               nCanon = nCanon + (#agifa070#9 % enRec);
          |FINSI;
          #agifa036#63 = #agifa036#63 + (nCanon * enForma);
     |FINSI;

     nNume = nBrutoMoneda1 % #agifa070#10;
     #agifa036#26 = #agifa036#26 + (nNume * enForma);

     #agifa036#25 = #agifa036#25 + (nDescuMoneda1 * enForma)

/*
     |SI #agifa036#15 > 0;
         nError = 1;
     |SINO;
         nError = -1;
         #agifa036#15 = -#agifa036#15;
         #agifa036#54 = -#agifa036#54;
     |FINSI;
     #agifa036#25 = #agifa036#15 < #agifa036#5;
     #agifa036#25 = #agifa036#25 < #agifa036#32;
     #agifa036#25 = #agifa036#25 < #agifa036#7;
     #agifa036#25 = #agifa036#25 * nError;
     #agifa036#15 = #agifa036#15 * nError;
     #agifa036#25 = #agifa036#15 - #agifa036#25;
*/

     #agifa036#24 = #agifa036#17 + #agifa036#18 + #agifa036#20 + #agifa036#21 + #agifa036#23 + #agifa036#41 + #agifa036#42 + #agifa036#44 + #agifa036#45 + #agifa036#47;

     #dszrec02#17 = #dszrec02#17 + (nDescuMoneda2 * enForma);
/*
     #dszrec02#17 = #agifa036#54 < #agifa036#5;
     #dszrec02#17 = #dszrec02#17 < #agifa036#32;
     #dszrec02#17 = #dszrec02#17 < #agifa036#7;
     #dszrec02#17 = #dszrec02#17 * nError;
     #agifa036#54 = #agifa036#54 * nError;
     #dszrec02#17 = #agifa036#54 - #dszrec02#17;
*/

     #dszrec02#16 = #dszrec02#02 + #dszrec02#03 + #dszrec02#05 + #dszrec02#06 + #dszrec02#08 + #dszrec02#09 + #dszrec02#11 + #dszrec02#12 + #dszrec02#14 + #dszrec02#15;

     #agifa036#48 = #agifa036#15 - #agifa036#25 + #agifa036#24 + nTotPVerde;
     #agifa036#55 = #agifa036#54 - #dszrec02#17 + #dszrec02#16 + nTotPVerde;

     |SI #agifa036#51 = "B";  || Asigna campos visual. y no visual. en el pedido segun la moneda de trabajo
         #agifa036#56 = #agifa036#15;
         #agifa036#57 = #agifa036#48;
         #agifa036#58 = #agifa036#54;
         #agifa036#59 = #agifa036#55;
     |SINO;
         #agifa036#56 = #agifa036#54;
         #agifa036#57 = #agifa036#55;
         #agifa036#58 = #agifa036#15;
         #agifa036#59 = #agifa036#48;
     |FINSI;
|FPRC;
|| ----------------------  FIN AGIFA036 ---------------------------------

|PROCESO TotalLin70;
     |ABRE #2;
     #2#0 = #3#2;
     |LEE 020#2=;
     |CIERRA #2;

     nPreTon = 1;
     |HAZ EsVigor;
     |SI FSalida = 0;
          aAlfa = #2#110; |QBF aAlfa;   || Alfanumerico1
          aAlfa = aAlfa > "";
          |SI aAlfa = "S"; nPreTon = 1000; |FINSI;
     |FINSI;

     #3#37 = #3#5 * #2#208; ||Punto Verde

     |SI #0#51 = "D";                   || Si mon. de trabajo es divisa ...
          #3#6 = #3#24 / #0#50 * #0#53; || Recalculo precio en mon. base
          #3#26 = #3#6;                 || Precio visual, en mon. base
     |SINO;                             || Si mon. de trabajo es mon. base
          #3#24 = #3#6 / #0#53 * #0#50; || Recalculo precio en divisa
          #3#26 = #3#24;                || Precio visual, en divisa
     |FINSI;

     |SI #2#194 = 2;                    || Unidades Facturacion
          #3#7    = #3#28 * #3#6 / nPreTon;
          nImpDiv = (#3#28 * #3#24 / nPreTon) ! nDeci_DivD;
     |SINO;
          #3#7    = #3#5 * #3#6 / nPreTon;
          nImpDiv = (#3#5 * #3#24 / nPreTon) ! nDeci_DivD;
     |FINSI;

     #3#9  = (#3#7 < #3#8) < #3#23;
     #3#25  = (nImpDiv < #3#8) < #3#23;

     |SI #0#51 = "D";     || Si la moneda de trabajo es la divisa ...
          #3#27 = #3#9;   || el campo visualiz. es el importe en moneda base
     |SINO;               || Si la moneda de trabajo es la moneda base ...
          #3#27 = #3#25;  || el campo visualiz. es el importe en divisa
     |FINSI;
|FPRC;
