|FICHEROS;
   albm0031 #10;
   albm0032 #11;
   albm0035 #12,MANTE;
   albm0043 #13;

   dsm00043 #30;
   dsm00044 #31;
   dsm00024 #32;
   dsm00056 #33;
   dsm00057 #34;

   agifa019 #50;
   agifa017 #51;

   albw0012 #100;
   albw0014 #101;
   albw0015 #102;
   albw0016 #103,MANTE;
   albw0021 #104;
   albw0032 #900;

   artialm@ #1000;
   referen@ #2000;

   albm43@  #1043;       ||CargaDef, para numero Orden Partidas.

   agifa029 #5029;       ||Almacenes
   agifa112 #5112;       ||Proveedores

   albm0060 #60;         ||Rel. Orden/Mezclada

   albm0038 #38;         ||Orden (L)
   albm0062 #62;         ||Rel.Orden-Partidas
|FIN;

|VARIABLES;
   nKilos = 0;
   nTotal = 0;

   nOrden = 0;
   &enForma  = 0;
   &enCodigo = 0;

   nDifKg = 0;
   nLinea = 0;
   nMaxStock = 0;
   nDocum = 0;
   nSalir  = 0;

   aAlfa = "";
   aCodArt = "";
   nCodAlm = 0;
   nKg     = 0;
   nPrecio = 0;
   aPartida = "";
   aDTipo   = "";
   aHTipo   = "";
   aTecla   = "";

   nCabecera = 0;
   nPartidas = 0;
   nVentana  = 0;
   nVentana1 = 0;
   nVentana2 = 0;
   nMezclada = 0;
   nAntMezc  = 0;
   nActualizar = 0;

   nSw      = 0;
   nSwError = 0;
   nModoEnt = 0;
   nModo = 0;
   nPos1 = 0;
   nPos2 = 0;
   nCont = 0;
   nCalc = 0;
   nNueva = 0;

   nTecla = 0;

   nPanta  = 0;
   nBoton2 = 0;          ||Nueva Partida
   nBoton3 = 0;          ||Borra Partida
   nBoton4 = 0;          ||Finalizar Mezclada
   nBoton5 = 0;          ||Introduce Partida

     nPanta0    = 0;
     nGrid      = 0;
     nRango     = 0;
     nTecla0    = 0;

     nLectura = 0;
     nWid     = 0;
     nId      = 0;
     nSid     = 0;
     nWidGuarda = 0;
     nIdGuarda  = 0;
     nSidGuarda = 0;

     aMensaje     = "";

     nPrincipal = -1;
     nFinal     = 0;

     &enAlmPar = 0;
     &eaNumPar = "";
     &eaProducido = "";
     &eaDesPro = "";
     nKgIntro = 0;
     aKilos = "";

     &eaDocExt = "";
     &eaSerExt = "";
     &enNumExt = 0;
     aAux = "";
     nSwEsta = 0;
     nUltimo = 0;
     nSwExistePar = 0;
     aMas = "";
     &eaCerrarPar = "";
     &eaIncPar = "";
     &enMezclada = 0;
     nSwCerrada = 0;
     fFecha     = @;
|FIN;


|PROCESO StockNoFin;
   #albm0032#0 = #albm0043#0;
   #albm0032#1 = #albm0043#1;
   |LEE 000#albm0032.=;
   |SI #albm0032#2 ! #albw0014#2; |O #albm0032#4 ! #albw0014#4; |ACABA; |FINSI;

   |SI #albm0043#5 = "S"; nMaxStock = 0; |ERROR10; |FINSI;
/*
   #albm0031#0 = #albm0043#0;
   |LEE 000#albm0031.=;
   |SI FSalida = 0; |Y #albm0031#16 = "N";
      nMaxStock = nMaxStock - #albm0043#4;
   |FINSI;
*/
   |SI #albm0031#16 = "N";
      nMaxStock = nMaxStock - #albm0043#4;
   |FINSI;
|FPRC;

|DEFBUCLE StockNoFin;
#albm0043#1;
;
000000,000,aPartida;
999999,999,aPartida;
;
NULL,StockNoFin;
|FIN;

|PROCESO BorraPartidas;
   |BORRA 020#albw0021.a;
|FPRC;

|DEFBUCLE BorraPartidas;
#albw0021#1;
;
INICIO;
FINAL;
;
NULL,BorraPartidas;
|FIN;

|PROCESO SacaPartidas;
   #albw0021#0 = #albm0043#0;
   #albw0021#1 = #albm0043#1;
   #albw0021#2 = #albm0043#2;
   |LEE 000#albw0021.=;
   |SI FSalida = 0; |ACABA; |FINSI;

   aAlfa = "|NC";
   aAlfa = #albm0043#aAlfa#; nCalc = aAlfa; nCalc = nCalc - 1;
   |PARA nCont = 0; |SI nCont [ nCalc; |HACIENDO nCont = nCont + 1;
      #albw0021#nCont# = #albm0043#nCont#;
   |SIGUE;
   |GRABA 020#albw0021.n;
|FPRC;

|DEFBUCLE SacaPartidas;
#albm0043#1;
;
nMezclada,01,"               ";
nMezclada,99,"zzzzzzzzzzzzzzz";
;
NULL,SacaPartidas;
|FIN;

|PROCESO SacaLineas;
   aAlfa = "|NC";
   aAlfa = #albm0032#aAlfa#; nCalc = aAlfa; nCalc = nCalc - 1;
   |PARA nCont = 0; |SI nCont [ nCalc; |HACIENDO nCont = nCont + 1;
      #albw0014#nCont# = #albm0032#nCont#;
   |SIGUE;
   |GRABA 020#albw0014.n;
|FPRC;

|DEFBUCLE SacaLineas;
#albm0032#1;
;
nMezclada,01;
nMezclada,99;
;
NULL,SacaLineas;
|FIN;

|PROCESO Incidencia;
   |SI #albw0016#8 = "S";
      |ABRE #albm0035;
      |VENTANA 0501, 3299, -1, -1, "";
      nVentana1 = FSalida;

      nNueva = 0;
      #albm0035#0 = #albw0014#2;
      #albm0035#2 = #albw0014#4;
      #albm0035#4 = #albw0016#4;
      |LEE 000#albm0035.=;
      |SI FSalida ! 0;
         |DDEFECTO #albm0035;
         #albm0035#0 = #albw0014#2;
         #albm0035#2 = #albw0014#4;
         #albm0035#4 = #albw0016#4;
         |GRABA 020#albm0035.b;
         nNueva = 1;
      |FINSI;

      #albm0035#1  = #albw0014#3;
      #albm0035#3  = #albw0014#5;
      #albm0035#5  = #albw0016#5;
      #albm0035#6  = #albw0016#6;
      #albm0035#7  = #albw0014#2;
      #albm0035#8  = #albw0014#3;
      #albm0035#9  = nMaxStock;

      |PINPA #0#12; |PINDA #0#12;
      |ENDATOS #1#12;
      |SI FSalida = 0;
         |GRABA 020#albm0035.a;
         |SI #albm0035#40 = "S"; |PTEC 807; |FINSI;
      |SINO;
         |SI nNueva = 1; |BORRA 020#albm0035.a; |FINSI;
      |FINSI;
      |LIBERA #albm0035;
      |CIERRA #albm0035;

      |FINVENTANA nVentana1;
   |FINSI;
|FPRC;

|PROCESO LineasRegEx;
   #albm0032#0 = #albm0043#0;
   #albm0032#1 = #albm0043#1;
   |LEE 000#albm0032.=;
   |SI FSalida ! 0; |DDEFECTO #albm0032; |FINSI;

   |ABRE #agifa019;
   #agifa019#0 = #albm0032#2;
   |LEE 101#agifa019.=;
   |SI FSalida = 0;
      #agifa019#12  = #agifa019#12  - #albm0043#4;
      #agifa019#104 = #agifa019#104 + #albm0043#4;
      |GRABA 020#agifa019.a; |LIBERA #agifa019;
   |FINSI;
   |CIERRA #agifa019;

   |ABRE #agifa017;
   #agifa017#0 = #albm0032#2;
   #agifa017#1 = #albm0032#4;
   |LEE 101#agifa017.=;
   |SI FSalida = 0;
      #agifa017#8  = #agifa017#8  - #albm0043#4;
      #agifa017#39 = #agifa017#39 + #albm0043#4;
      |GRABA 020#agifa017.a; |LIBERA #agifa017;
   |FINSI;
   |CIERRA #agifa017;

   |ABRE #dsm00024;
   #dsm00024#0 = #albm0032#2;
   #dsm00024#1 = #albm0032#4;
   #dsm00024#2 = #albm0043#2;
   |LEE 000#dsm00024.=;
   |SI FSalida ! 0; |DDEFECTO #dsm00024; |FINSI;
   |CIERRA #dsm00024;

   |DDEFECTO #dsm00043;
   #dsm00043#0 = nDocum;
   #dsm00043#1 = fFecha;
   #dsm00043#4 = "     ";
   |LEE 101#dsm00043.=;
   |SI FSalida ! 0;
      |DDEFECTO #dsm00043;
      #dsm00043#0 = nDocum;
      #dsm00043#1 = fFecha;
      #dsm00043#4 = "     ";
      |GRABA 020#dsm00043.n;
   |FINSI;

   nLinea = nLinea + 1;
   |DDEFECTO #dsm00044;
   #dsm00044#0  = #albm0032#2;
   #dsm00044#1  = #albm0032#4;
   #dsm00044#2  = #albm0032#3;
   #dsm00044#3  = #agifa017#39;
   |SI #albm0043#5 = "S";
      #dsm00044#4  = #dsm00024#31;
   |SINO;
      #dsm00044#4  = #albm0043#4;
   |FINSI;
   #dsm00044#5  = fFecha;
   #dsm00044#6  = #agifa019#104;
   #dsm00044#7  = "S";
   #dsm00044#8  = nLinea;
   #dsm00044#12 = #albm0043#3;
   #dsm00044#13 = #albm0043#2;
   #dsm00044#18 = nDocum;
   #dsm00044#19 = #agifa017#5;
   #dsm00044#20 = #agifa017#6;
   #dsm00044#21 = "     ";
   #dsm00044#22 = #agifa019#185;
   #dsm00044#23 = #agifa017#47;
   #dsm00044#24 = #agifa019#193;
   #dsm00044#25 = #agifa017#48;

   enForma = 1; enCodigo = nDocum;
   eaCerrarPar = #albm0043#5;
   eaIncPar = #albm0043#6;
   |HAZ AcumulaES_SS;

   #dsm00044#3  = #agifa017#39;
   #dsm00044#19 = #agifa017#5;
   |GRABA 020#dsm00044.n;

   #albm0043#11 = "";
   #albm0043#12 = nDocum;
   #albm0043#13 = nLinea;
   |GRABA 020#albm0043.a;

|FPRC;

|DEFBUCLE LineasRegEx;
#albm0043#1;
;
#albm0031#0,01,"               ";
#albm0031#0,99,"zzzzzzzzzzzzzzz";
be;
NULL,LineasRegEx;
|FIN;

|PROCESO CalcPartidas;
   ||nPrecio = nPrecio + #albm0043#9;

     nKilos = nKilos + #albm0043#4;
     nTotal = nTotal + #albm0043#10;
|FPRC;

|DEFBUCLE CalcPartidas;
#albm0043#1;
;
#albm0031#0,001,"               ";
#albm0031#0,999,"zzzzzzzzzzzzzzz";
;
NULL,CalcPartidas;
|FIN;

|PROCESO ActStock;
|| Calculo el precio de la mezclada

   nPrecio = 0;
   nTotal = 0;
   nKilos = 0;
   |BUCLE CalcPartidas;
   nPrecio = nTotal / nKilos;

|| Entrada del producto terminado

   nDocum = 0;
   |ABRE #dsm00056;
   |ABRE #dsm00057;

   |DDEFECTO #dsm00056;
   #dsm00056#2 = "     ";
   #dsm00056#0 = 999999;
   |LEE 000#dsm00056.];
   |SI FSalida = 0;
      |LEE 000#dsm00056.a;
      |SI FSalida = 0;
         |SI #dsm00056#2 = "     ";
            nDocum = #dsm00056#0 + 1;
         |SINO;
            nDocum = 1;
         |FINSI;
      |SINO;
         nDocum = 1;
      |FINSI;
   |SINO;
      |LEE 000#dsm00056.u;
      |SI FSalida = 0;
         |SI #dsm00056#2 = "     ";
            nDocum = #dsm00056#0 + 1;
         |SINO;
            nDocum = 1;
         |FINSI;
      |SINO;
         nDocum = 1;
      |FINSI;
   |FINSI;

   |DDEFECTO #dsm00056;
   #dsm00056#0 = nDocum;
   #dsm00056#1 = fFecha;
   #dsm00056#2 = "     ";
   |GRABA 020#dsm00056.n;

   nLinea = 1;

   |ABRE #agifa019;
   #agifa019#0 = #albm0031#3;
   |LEE 101#agifa019.=;
   |SI FSalida ! 0; |DDEFECTO #agifa019; |FINSI;
   |CIERRA #agifa019;

   |ABRE #agifa017;
   #agifa017#0 = #albm0031#3;
   #agifa017#1 = #albm0031#11;
   |LEE 101#agifa017.=;
   |SI FSalida ! 0; |DDEFECTO #agifa017; |FINSI;
   |CIERRA #agifa017;

   |DDEFECTO #dsm00057;
   #dsm00057#0  = #albm0031#3;
   #dsm00057#1  = #albm0031#11;
   #dsm00057#2  = #albm0031#4;
   #dsm00057#3  = #agifa017#39;
   #dsm00057#4  = #albm0031#14;
   #dsm00057#5  = "000000";
   #dsm00057#6  = nPrecio;
   #dsm00057#11 = nPrecio;
   #dsm00057#12 = fFecha;
   #dsm00057#13 = #agifa019#104;
   #dsm00057#14 = nLinea; nLinea = nLinea + 1;
   #dsm00057#18 = "EUR";
   #dsm00057#19 = nPrecio;
   ||#dsm00057#21 = ???;           ||Unidades 2.
   #dsm00057#22 = #albm0031#20;
   #dsm00057#27 = nDocum;
   #dsm00057#28 = "     ";

   enForma = 1; enCodigo = nDocum;
   eaDocExt = "MZ";
   eaSerExt = "";
   enNumExt = #albm0031#0;

   |HAZ AcumulaEV;
   eaDocExt = "";
   eaSerExt = "";
   enNumExt = 0;

   #dsm00057#3  = #agifa017#39;
   #dsm00057#13 = #agifa017#5;
   |GRABA 020#dsm00057.n;

   #albm0031#17 = "";
   #albm0031#18 = nDocum;
   |GRABA 020#albm0031.a;

   |CIERRA #dsm00056; |CIERRA #dsm00057;

|| Salidas de la materia prima

   |ABRE #dsm00043; |ABRE #dsm00044; |ABRE #albm0032;
   enAlmPar = #albm0031#11;
   eaNumPar = #albm0031#20;
   eaProducido = #albm0031#3;
   eaDesPro = #albm0031#4;
   eaDocExt = "MZ";
   eaSerExt = "";
   enNumExt = #albm0031#0;

   #dsm00043#4 = "     ";
   #dsm00043#0 = 999999;
   |LEE 000#dsm00043.];
   |SI FSalida = 0;
      |LEE 000#dsm00043.a;
      |SI FSalida = 0;
         |SI #dsm00043#4 = "     ";
            nDocum = #dsm00043#0 + 1;
         |SINO;
            nDocum = 1;
         |FINSI;
      |SINO;
         nDocum = 1;
      |FINSI;
   |SINO;
      |LEE 000#dsm00043.u;
      |SI FSalida = 0;
         |SI #dsm00043#4 = "     ";
            nDocum = #dsm00043#0 + 1;
         |SINO;
            nDocum = 1;
         |FINSI;
      |SINO;
         nDocum = 1;
      |FINSI;
   |FINSI;

   nLinea = 0;
   |BUCLE LineasRegEx;

   enAlmPar    = 0;
   eaNumPar    = "";
   eaProducido = "";
   eaDesPro    = "";
   eaDocExt    = "";
   eaSerExt    = "";
   enNumExt    = 0;

   |CIERRA #dsm00043;
   |CIERRA #dsm00044;
   |CIERRA #albm0032;

   |HAZ ActOrdenPartidas;        || albm0062
|FPRC;

|PROCESO albm0060;
     ||El albm0032 ya esta leido en Lineas RegE

     |SELECT #3#albm0038;
     |DDEFECTO #albm0038;
     #albm0038#16 = #albm0060#2;
     #albm0038#0 = #albm0060#0;
     #albm0038#2 = #albm0031#3;
     |LEE 000#albm0038.=;
     |SI FSalida = 0;
          |HAZ MeteOrdenPartida;
     |FINSI;
|FPRC;

|PROCESO MeteOrdenPartida;
     |DDEFECTO #albm0062;
     #albm0062#4 = #albm0038#16;
     #albm0062#0 = #albm0038#0;
     #albm0062#1 = #albm0038#1;
     #albm0062#2 = #albm0031#11;
     #albm0062#3 = #albm0031#20;
     #albm0062#5 = #albm0031#14;
     |LEE 101#albm0062.=;
     |SI FSalida ! 0;
          |GRABA 020#albm0062.n;
     |FINSI;
     |LIBERA #albm0062;
|FPRC;

|DEFBUCLE albm0060;
 #albm0060#2;
 3;
 #albm0031#0, "";
 #albm0031#0, "";
 ;
 NULL, albm0060;
|FIN;

|PROCESO ActOrdenPartidas;
     |BUCLE albm0060;
|FPRC;

|PROCESO ModifPartida;
   nTecla = FSalida;
   |SI nTecla = 1;
       |LEE 000#101c;
       |SI FSalida = 0;
          |ESTADO_CONTROL nBoton2, "ENABLE";
       |SINO;
          |ESTADO_CONTROL nBoton2, "DISABLE";
       |FINSI;
       |REFRESCACONTROL nPartidas;
   |FINSI;
|FPRC;

|PROCESO BorraLineas;
   |BORRA 020#albw0014.a;
|FPRC;

|DEFBUCLE BorraLineas;
#albw0014#1;
;
INICIO;
FINAL;
;
NULL,BorraLineas;
|FIN;

|PROCESO Boton2;
   nModoEnt = 1; |HAZ EntraPartida;
   |SI nSwError ! 1;
      aCodArt = #albw0016#0; nCodAlm = #albw0016#2;
      nKg = #albw0016#11; |HAZ ReservaStock;
   |FINSI;
   nSalir = 0;
   |PTEC 806;
|FPRC;

|PROCESO Boton3;         ||Borra Partida
   |ABRE #albm0043;
   #albm0043#0 = #albw0021#0;
   #albm0043#1 = #albw0021#1;
   #albm0043#2 = #albw0021#2;
   |LEE 040#albm0043.=;
   |SI FSalida = 0;
      #albm0031#0 = #albw0021#0;
      |LEE 101#albm0031.=;
      |SI FSalida = 0;
           #albm0031#14 = #albm0031#14 - #albw0021#4;
           #albm0031#21 = #albm0031#21 - #albw0021#10;
           #albm0031#22 = #albm0031#21 / #albm0031#14;
           |GRABA 020#albm0031.a;
           |LIBERA #albm0031;
           nKgIntro = #albm0031#14;
           |HAZ PintaKilos;

           |ABRE #albm0032;
           |ABRE #albw0014;
           #albm0032#0 = #albm0031#0;
           #albm0032#1 = #albw0021#1;
           |LEE 101#albm0032.=;
           |SI FSalida = 0;
                #albm0032#6 = #albm0032#6 - #albw0021#3;
                #albm0032#8 = #albm0032#8 - #albw0021#4;
                |GRABA 020#albm0032.a;
                |LIBERA #albm0032;
                #albw0014#0 = #albm0031#0;
                #albw0014#1 = #albw0021#1;
                |LEE 101#albw0014.=;
                |SI FSalida = 0;
                     #albw0014#6 = #albm0032#6;
                     #albw0014#8 = #albm0032#8;
                     |GRABA 020#albw0014.a;
                     |LIBERA #albw0014;
                |FINSI;
           |FINSI;
           |CIERRA #albm0032;
           |CIERRA #albw0014;
      |FINSI;
      aCodArt = #albw0014#2; nCodAlm = #albw0014#4;
      nKg = 0 - #albw0021#4; |HAZ ReservaStock;
      |BORRA 020#albm0043.a; |BORRA 020#albw0021.a;
   |FINSI;
   |CIERRA #albm0043;

   |REFRESCACONTROL nPartidas;

   nSalir = 0;
   |PTEC 806;
|FPRC;

|PROCESO Boton5;
   nModoEnt = 3; |HAZ EntraPartida;
   |SI nSwError ! 1;
      nSwEsta = 0;
      |HAZ MiraArticulo;
      |SI nSwEsta = 0;
          nUltimo = nUltimo + 1;
          |ABRE #albm0032;
          |DDEFECTO #albm0032;
          #albm0032#0 = #albm0031#0;
          #albm0032#1 = nUltimo;
          |LEE 101#albm0032.=;
          |SI FSalida ! 0; |GRABA 020#albm0032.b; |FINSI;
          #albm0032#2 = #albw0016#0;
          #albm0032#3 = #albw0016#1;
          #albm0032#4 = #albw0016#2;
          #albm0032#5 = #albw0016#3;
          ||Se actualizan luego en el proceso Final FinalIntroPar
          ||#albm0032#6 = #albm0032#6 + #albw0016#9;
          ||#albm0032#8 = #albm0032#8 + #albw0016#11;
          |GRABA 020#albm0032.a;
          |LIBERA #albm0032;
          |CIERRA #albm0032;

          |DDEFECTO #albw0014;
          aAlfa = "|NC";
          aAlfa = #albm0032#aAlfa#; nCalc = aAlfa; nCalc = nCalc - 1;
          |PARA nCont = 0; |SI nCont [ nCalc; |HACIENDO nCont = nCont + 1;
             #albw0014#nCont# = #albm0032#nCont#;
          |SIGUE;
          |GRABA 020#albw0014.n;
      |FINSI;
      |HAZ FinalIntroPar;

      |REFRESCACONTROL nPartidas;

      ||He de crear la linea arriba y la linea de abajo.  OK
      aCodArt = #albw0016#0; nCodAlm = #albw0016#2;
      nKg = #albw0016#11; |HAZ ReservaStock;
   |FINSI;

   nSalir = 0;
   |PTEC 806;
|FPRC;

|PROCESO RellenaTempo;
   nMaxStock = #dsm00024#31;
   aPartida = #dsm00024#2; |BUCLE StockNoFin;
   |SI nMaxStock = 0; |ACABA; |FINSI;

   |DDEFECTO #artialm@;
   aAlfa = "|NC"; nCalc = #artialm@#aAlfa#; nCalc = nCalc - 1;
   |PARA nCont = 0; |SI nCont [ nCalc; |HACIENDO nCont = nCont + 1;
      #artialm@#nCont# = #dsm00024#nCont#;
   |SIGUE;
   |GRABA 020#artialm@.n;
|FPRC;

|PROCESO RellenaTempoTots;
   aAux = #dsm00024#0;
   |QBF aAux;
   |SI aAux ! "";
     |HAZ RellenaTempo;
   |FINSI;
|FPRC;

|DEFBUCLE RellenaTempo;
#dsm00024#1;
;
#albw0016#0, #albw0016#2, "               ";
#albw0016#0, #albw0016#2, "zzzzzzzzzzzzzzz";
;
NULL,RellenaTempo;
|FIN;

|DEFBUCLE RellenaTempoTots;
#dsm00024#1;
;
"                   !", 00001, "               ";
"zzzzzzzzzzzzzzzzzzzz", 99999, "zzzzzzzzzzzzzzz";
;
NULL,RellenaTempoTots
|FIN;


|CALCULO SelPart;
   |SI FSalida = 4;      ||Doble Click
       |PTEC 806;
   |FINSI;
   #albw0016#4 = #artialm@#2;
   |PINTA #albw0016#4;
   |HAZ LosDatos;
|FCAL;

|CALCULO MiraPart;
   |SI FSalida = 10; |Y nModoEnt ! 3;
      |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "def/dsm00024.mas";
      |CARGA_DEF aAlfa, artialm@;
      |SI FSalida = 0;
         aAlfa = "aa" + Usuario; |QBF aAlfa; |NOME_DAT #1000 aAlfa;
         |DFICE aAlfa; |QBF aAlfa; |PATH_DAT #1000 aAlfa;
         |DELINDEX #artialm@; |ABRE #artialm@; |ABRE #dsm00024;
         |ABRE #albm0031; |ABRE #albm0032;
         |SI nModoEnt = 3;
              |BUCLE RellenaTempoTots;
         |SINO;
              |BUCLE RellenaTempo;
         |FINSI;
         |CIERRA #albm0031; |CIERRA #albm0032;
         nPos1 = 1529; nPos2 = 1877;
         nModo = 2 + 4 + 8 + 16;
         |LINEAL_SIMPLE #1#artialm@,nModo,nPos1,nPos2,NULL,NULL,SelPart;
         |SI FSalida = 0;
            ||Aqui creo que no entra nunca ... :(
            #albw0016#4 = #artialm@#2; |PINTA #albw0016#4;
            nMaxStock = #artialm@#31;
            |SI nModoEnt = 3;
                |HAZ LosDatos;
            |FINSI;
         |SINO;
            |ERROR;
         |FINSI;
         |CIERRA #artialm@; |DELINDEX #artialm@; |DESCARGA_DEF #artialm@;
         |CIERRA #dsm00024;
      |FINSI;
   |FINSI;

   |SI nModoEnt = 3;
      |HAZ ArtPartida;
      |ACABA;
   |FINSI;

   |SALVA_FICHA #albw0021;
   |SI nModoEnt = 1;
      #albw0021#0 = #albw0014#0;
      #albw0021#1 = #albw0014#1;
      #albw0021#2 = #albw0016#4;
      |LEE 000#albw0021.=;
      |SI FSalida = 0;
         |MENAV "     Ya existe una linea con la partida indicada.";
         ||ERROR;
         |REPON_FICHA #albw0021;
         ||ACABA;
      |FINSI;
   |FINSI;
   |REPON_FICHA #albw0021;

   |ABRE #dsm00024;
   |SELECT #1#dsm00024;
   |SI nModoEnt = 1;
       #dsm00024#0 = #albw0014#2;
       #dsm00024#1 = #albw0014#4;
   |SINO;
       #dsm00024#0 = #albw0016#0;
       #dsm00024#1 = #albw0016#2;
   |FINSI;
   #dsm00024#2 = #albw0016#4;
   |LEE 000#dsm00024.=;
   |SI FSalida = 0;
      nMaxStock = #dsm00024#31;
      #albw0016#12 = #dsm00024#31;
      #albw0016#13 = #dsm00024#32;
      |PINTA #albw0016#12;
      |PINTA #albw0016#13;

      #albw0016#5 = #dsm00024#3;
      |PINTA #albw0016#5;
      |ABRE #agifa112;
      #agifa112#0 = #albw0016#5;
      |LEE 000#agifa112.=;
      |SI FSalida = 0;
           #albw0016#6 = #agifa112#1;
           |PINTA #albw0016#6;
      |FINSI;
      |CIERRA #agifa112;
   |SINO;
      |MENAV "    Partida inexistente"; |ERROR;
   |FINSI;
   |CIERRA #dsm00024;


   || Debo descontar del stock maximo el stock de las partidas que se han
   ||   usado en mezcladas pero que no estan finalizadas aun .,...
   ||Si nModoEnt = 2 ... No lo tiene que hacer
   |SI nModoEnt = 1;
      |ABRE #albm0031; |ABRE #albm0032;
      aPartida = #albw0016#4; |BUCLE StockNoFin;
      |CIERRA #albm0031; |CIERRA #albm0032;
   |FINSI;

   |MENSA "2405                      ";

|FCAL;

|PROCESO MiraKgs;
   |SI #albw0016#11 > nMaxStock;
      ||ARA. Ticket 290.
      aMensaje =  "0000NStock insuficiente en la partida. Desea Continuar?";
      |CONFI aMensaje;
      |SI FSalida = 0;
           |SI nModoEnt ! 3;
                |SI #albw0016#11 > #albw0016#10; |Y #albw0016#10 > 0;
                     aMensaje = "0000SSe superan los Kg. Pendientes. Es correcto?";
                     |CONFI aMensaje;
                     |SI FSalida ! 0;
                          |ERROR;
                     |FINSI;
                |FINSI;
           |FINSI;
      |SINO;
           |ERROR;
      |FINSI;
   |SINO;
      |SI nModoEnt ! 3;
           |SI #albw0016#11 > #albw0016#10; |Y #albw0016#10 > 0;
                aMensaje = "0000SSe superan los Kg. Pendientes. Es correcto?";
                |CONFI aMensaje;
                |SI FSalida ! 0;
                     |ERROR;
                |FINSI;
           |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO EntraPartida;
   |ESTADO_CONTROL nBoton2, "DISABLE";
   |ESTADO_CONTROL nBoton3, "DISABLE";
   |ESTADO_CONTROL nBoton4, "DISABLE";
   |ESTADO_CONTROL nBoton5, "DISABLE";

   |VENTANA 0914, 1877, -1, -1, "";
   nVentana = FSalida;

   ||nModoEnt = 1;       ||Introduccion Partida, segun el articulo seleccionado
   ||nModoEnt = 2;       ||DobleClick, muestra datos de Partida Utilzada entrada
   ||nModoEnt = 3;       ||Introduccion directa Partida

   |C_M #albw0016#4, 1, "S";

   |SI nModoEnt = 3;          ||Introduccion directa Partida
      |DDEFECTO #albw0016;
      |PINPA #0#103; |PINDA #0#103;
      |ENDATOS #1#103;
      nActualizar = FSalida;
      |SI FSalida = 0;
         nSwError = 0;
      |SINO;
         nSwError = 1;
      |FINSI;
   |SINO;
      |SI nModoEnt = 2;
           |DDEFECTO #albw0014;
           #albw0014#0 = #albm0031#0;
           #albw0014#1 = #albw0021#1;
           |LEE 000#albw0014.=;
      |FINSI;

      |DDEFECTO #albw0016;
      #albw0016#0  = #albw0014#2;
      #albw0016#1  = #albw0014#3;
      #albw0016#2  = #albw0014#4;
      #albw0016#3  = #albw0014#5;
      |SI nModoEnt = 2;
         #albw0016#4  = #albw0021#2;
         #albw0016#5  = #albw0021#7;
         #albw0016#6  = #albw0021#8;
         #albw0016#7  = #albw0021#5;
         #albw0016#8  = #albw0021#6;
         #albw0016#9  = #albw0021#3;
         #albw0016#11 = #albw0021#4;
      |FINSI;
      #albw0016#10 = #albw0014#7 - #albw0014#8;
      |SI nModoEnt = 2;
           ||Estoy modificando, se supone que estos tambien me faltan
           #albw0016#10 = #albw0016#10 + #albw0016#11;
           |C_M #albw0016#4, 1, "N";
      |FINSI;
      |PINPA #0#103; |PINDA #0#103;
      |ENDATOS #1#103;
      nActualizar = FSalida;
      |SI FSalida = 0;
         |SI #albw0016#8 = "N";
            |ABRE #albm0035;
            #albm0035#0 = #albw0014#2;
            #albm0035#2 = #albw0014#4;
            #albm0035#4 = #albw0016#4;
            |LEE 101#albm0035.=;
            |SI FSalida = 0; |BORRA 020#albm0035.a; |FINSI;
            |CIERRA #albm0035;
         |FINSI;

         |ABRE #albm0043;
         #albm0043#0 = #albw0014#0;
         #albm0043#1 = #albw0014#1;
         #albm0043#2 = #albw0016#4;
         |LEE 101#albm0043.=;
         |SI FSalida ! 0;
            nOrden = 0;
            |HAZ SacaOrden;
            nOrden = nOrden + 1;
            |DDEFECTO #albm0043;
            #albm0043#0 = #albw0014#0;
            #albm0043#1 = #albw0014#1;
            #albm0043#2 = #albw0016#4;
            |GRABA 020#albm0043.b;
            #albm0043#14 = nOrden;
         |FINSI;
         nOrden = #albm0043#14;

         |ABRE #albm0032;
         #albm0032#0 = #albw0014#0;
         #albm0032#1 = #albw0014#1;
         |LEE 101#albm0032.=;
         |SI FSalida = 0;
            #albm0032#8 = #albm0032#8 + #albw0016#11;
            #albm0032#6 = #albm0032#6 + #albw0016#9;
            |GRABA 020#albm0032.a; |LIBERA #albm0032;
            #albw0014#8 = #albm0032#8;
            #albw0014#6 = #albm0032#6;
            |GRABA 020#albw0014.a;
         |FINSI;
         |CIERRA #albm0032;

         |ABRE #dsm00024;
         #dsm00024#0 = #albm0032#2;
         #dsm00024#1 = #albm0032#4;
         #dsm00024#2 = #albw0016#4;
         |LEE 000#dsm00024.=;
         |SI FSalida ! 0; |DDEFECTO #dsm00024; |FINSI;
         |CIERRA #dsm00024;

         |SI nModoEnt = 2;                   ||Modificacion. DobleClick
              #albm0043#3 = #albw0016#9;
              #albm0043#4 = #albw0016#11;
         |SINO;
              #albm0043#3 = #albm0043#3 + #albw0016#9;
              #albm0043#4 = #albm0043#4 + #albw0016#11;
         |FINSI;
         #albm0043#5 = #albw0016#7;
         #albm0043#6 = #albw0016#8;
         #albm0043#7 = #albw0016#5;
         #albm0043#8 = #albw0016#6;
         ||#albm0043#9 = (#dsm00024#33 / #dsm00024#22) ! 2;
         #albm0043#9 = #dsm00024#38;
         #albm0043#10 = #albm0043#9 * #albm0043#4;
         #albm0043#14 = nOrden;
         |GRABA 020#albm0043.a; |LIBERA #albm0043;
         |CIERRA #albm0043;

         |DDEFECTO #albw0021;
         #albw0021#0 = #albm0031#0;
         #albw0021#1 = #albw0014#1;
         #albw0021#2 = #albw0016#4;
         |LEE 101#albw0021.=;
         |SI FSalida ! 0; |GRABA 020#albw0021.b; |FINSI;
         |SI nModoEnt = 2;                   ||Modificacion. DobleClick
              #albw0021#3 = #albw0016#9;
              #albw0021#4 = #albw0016#11;
         |SINO;
              #albw0021#3 = #albw0021#3 + #albw0016#9;
              #albw0021#4 = #albw0021#4 + #albw0016#11;
         |FINSI;
         #albw0021#5 = #albw0016#7;
         #albw0021#6 = #albw0016#8;
         #albw0021#7 = #albw0016#5;
         #albw0021#8 = #albw0016#6;
         ||#albw0021#9 = (#dsm00024#33 / #dsm00024#22) ! 2;
         #albw0021#9 = #dsm00024#38;
         #albw0021#10 = #albw0021#9 * #albw0021#4;
         #albw0021#14 = nOrden;
         |GRABA 020#albw0021.a;
         |LIBERA #albw0021;

         |ABRE #albm0031;
         #albm0031#0 = nMezclada;
         |LEE 101#albm0031.=;
         |SI FSalida = 0;
            #albm0031#14 = #albm0031#14 + #albw0016#11;
            |SI nModoEnt = 2;
                 #albm0031#21 = #albm0031#21 + #albw0021#10;
            |SINO;
                 #albm0031#21 = #albm0031#21 + (#albw0021#9 * #albw0016#11);
            |FINSI;
            #albm0031#22 = #albm0031#21 / #albm0031#14;
            |GRABA 020#albm0031.a; |LIBERA #albm0031;
            nKgIntro = #albm0031#14;
            |HAZ PintaKilos;
         |FINSI;
         |CIERRA #albm0031;

         nSwError = 0;
      |SINO;
         nSwError = 1;
      |FINSI;
      |CIERRA #albm0032;
   |FINSI;

   |FINVENTANA nVentana;

   ||ESTADO_CONTROL nBoton2, "ENABLE";
     ||Se activara cuando se pinche en alguna linea

   |ESTADO_CONTROL nBoton3, "ENABLE";
   |ESTADO_CONTROL nBoton4, "ENABLE";
   |ESTADO_CONTROL nBoton5, "ENABLE";

   |SI nModoEnt ! 3;
        |LEE 000#albw0021.c;
        |REFRESCACONTROL nPartidas;
   |FINSI;
|FPRC;

|PROCESO ArtPartida;
     aAux = #albw0016#4;
     |QBF aAux;
     |SI aAux = "";
          aMensaje = "0000Introduzca la partida";
          |MENAV aMensaje;
          |ERROR;
     |SINO;
          |SALVA_FICHA #albw0021;
          |SELECT #2#albw0021;
          #albw0021#0 = #albm0031#0;
          #albw0021#2 = #albw0016#4;
          |LEE 000#albw0021.=;
          |SI FSalida = 0;
                |MENAV "     Ya existe una linea con la partida indicada.";
                ||ERROR;
                |REPON_FICHA #albw0021;
                ||ACABA;
          |FINSI;
          |REPON_FICHA #albw0021;

          nSwCerrada = 0;
          nSwExistePar = 0;
          |HAZ LosDatos2;
          |SI nSwExistePar = 1;
               nSwEsta = 0;
               |HAZ MiraArticulo;
               |SI nSwEsta = 0;
                    aMensaje = "0000SEl articulo no pertenece a la Mezclada. Desea Incluirlo?";
                    |CONFI aMensaje;
                    |SI FSalida ! 0;
                         |ERROR;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI nSwCerrada = 1;
                    aMensaje = "0000Partida Cerrada";
                    |MENAV aMensaje;
                    |ERROR;
               |SINO;
                    aMensaje = "0000No existe la Partida Introducida";
                    |MENAV aMensaje;
                    |ERROR;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ReservaStock;
   |ABRE #agifa019;
   #agifa019#0 = aCodArt;
   |LEE 101#agifa019.=;
   |SI FSalida = 0;
      #agifa019#12  = #agifa019#12 + nKg;
      #agifa019#104 = #agifa019#104 - nKg;
      |GRABA 020#agifa019.a; |LIBERA #agifa019;
   |FINSI;
   |CIERRA #agifa019;

   |ABRE #agifa017;
   #agifa017#0 = aCodArt;
   #agifa017#1 = nCodAlm;
   |LEE 101#agifa017.=;
   |SI FSalida = 0;
      #agifa017#8  = #agifa017#8  + nKg;
      #agifa017#39 = #agifa017#39 - nKg;
      |GRABA 020#agifa017.a; |LIBERA #agifa017;
   |FINSI;
   |CIERRA #agifa017;
|FPRC;

|PROCESO Evento;
   |SI FSalida = 4;
               ||El dobleclick para modificar la partida.

      |LEE 000#albw0021.c;
      |SI FSalida ! 0;  |DDEFECTO #104;  |FINSI;

      #albw0014#0 = #albw0021#0;
      #albw0014#1 = #albw0021#1;
      |LEE 000#albw0014.=;
      |SI FSalida ! 0; |DDEFECTO #albw0014; |FINSI;

      aCodArt = #albw0014#2; nCodAlm = #albw0014#4;
      nKg = 0 - #albw0021#4; |HAZ ReservaStock;

      |ABRE #albm0031;
      #albm0031#0 = nMezclada;
      |LEE 101#albm0031.=;
      |SI FSalida = 0;
         #albm0031#14 = #albm0031#14 - #albw0021#4;
         #albm0031#21 = #albm0031#21 - #albw0021#10;
         #albm0031#22 = #albm0031#21 / #albm0031#14;
         |GRABA 020#albm0031.a; |LIBERA #albm0031;
         nKgIntro = #albm0031#14;
         |HAZ PintaKilos;
      |FINSI;
      |CIERRA #albm0031;

      |ABRE #albm0032;
      #albm0032#0 = #albw0014#0;
      #albm0032#1 = #albw0014#1;
      |LEE 101#albm0032.=;
      |SI FSalida = 0;
         #albm0032#8 = #albm0032#8 - #albw0021#4;
         #albm0032#6 = #albm0032#6 - #albw0021#3;
         |GRABA 020#albm0032.a; |LIBERA #albm0032;
         #albw0014#8 = #albm0032#8;
         #albw0014#6 = #albm0032#6;
      |FINSI;
      |CIERRA #albm0032;

      nModoEnt = 2; |HAZ EntraPartida;
      |SI nSwError = 0;
         aCodArt = #albw0016#0;
         nCodAlm = #albw0016#2;
         nKg     = #albw0016#11;
      |SINO;
         |ABRE #albm0031;
         #albm0031#0 = nMezclada;
         |LEE 101#albm0031.=;
         |SI FSalida = 0;
            #albm0031#14 = #albm0031#14 + #albw0021#4;
            #albm0031#21 = #albm0031#21 + #albw0021#10;
            #albm0031#22 = #albm0031#21 / #albm0031#14;
            #albw0012#14 = #albm0031#14;
            |GRABA 020#albm0031.a; |LIBERA #albm0031;
            nKgIntro = #albm0031#14;
            |HAZ PintaKilos;
         |FINSI;
         |CIERRA #albm0031;

         |ABRE #albm0032;
         #albm0032#0 = #albw0014#0;
         #albm0032#1 = #albw0014#1;
         |LEE 101#albm0032.=;
         |SI FSalida = 0;
            #albm0032#8 = #albm0032#8 + #albw0021#4;
            #albm0032#6 = #albm0032#6 + #albw0021#3;
            |GRABA 020#albm0032.a; |LIBERA #albm0032;
            #albw0014#8 = #albm0032#8;
            #albw0014#6 = #albm0032#6;
         |FINSI;
         |CIERRA #albm0032;

         aCodArt = #albw0014#2;
         nCodAlm = #albw0014#4;
         nKg     = #albw0021#4;
      |FINSI;

      |HAZ ReservaStock;
   |FINSI;
|FPRC;

|PROCESO Infw14;
   #albw0014#0 = nMezclada;
   #albw0014#1 = 1;
|FPRC;

|PROCESO Supw14;
   #albw0014#0 = nMezclada;
   #albw0014#1 = 99;
|FPRC;

|PROCESO Infw43;
   #albw0021#0 = #albw0014#0;
   #albw0021#1 = 1;
   #albw0021#2 = " " * 15;
|FPRC;

|PROCESO Supw43;
   #albw0021#0 = #albw0014#0;
   #albw0021#1 = 99;
   #albw0021#2 = "z" * 15;
|FPRC;

|PROCESO Boton4;
     |ESTADO_CONTROL nBoton2, "HIDE";
     |ESTADO_CONTROL nBoton3, "HIDE";
     |ESTADO_CONTROL nBoton4, "HIDE";
     |ESTADO_CONTROL nBoton5, "HIDE";

     fFecha = ~;
     |PINTA 2702, "Fecha Fin";
     fFecha = 2802 ? 1;

     |PINTA 2702, "         ";

     |ABRE #albm0031;
     #albm0031#0 = nMezclada;
     |LEE 101#albm0031.=;
     |SI FSalida = 0;
        |SI #albm0031#14 ! 0;
             #albm0031#16 = "S";
             #albm0031#25 = fFecha;
             |ABRE #albm0038;
             |ABRE #albm0062;
             |HAZ ActStock;
             |CIERRA #albm0062;
             |CIERRA #albm0038;
        |SINO;
             aMensaje = "0000NNo se ha realizado ningun Kg. Quiere dar por Finalizada la Mezclada?";
             |CONFI aMensaje;
             |SI FSalida = 0;
                  #albm0031#16 = "S";
                  #albm0031#25 = fFecha;
                  |GRABA 020#albm0031.a;
             |FINSI;
        |FINSI;
        |LIBERA #albm0031;
     |FINSI;
     |CIERRA #albm0031;

     |ESTADO_CONTROL nBoton2, "SHOW";
     |ESTADO_CONTROL nBoton3, "SHOW";
     |ESTADO_CONTROL nBoton4, "SHOW";
     |ESTADO_CONTROL nBoton5, "SHOW";

     nSalir = 1;
     |PTEC 806;
|FPRC;

|PROCESO PintaKilos;
     aKilos = ("         " + nKgIntro) % -109;

     nLectura = 1;
     nWid     = nWidGuarda;
     nId      = nIdGuarda;
     nSid     = nSidGuarda;
     |PCONTEXTO nLectura, nWid, nId, nSid;

     |ATRI N;
     |PINTA 0970, "Kg.Introducidos: ";
     |ATRI n;

     |ATRI N;
     |ATRI R;
     |PINTA 0987, aKilos;
     |ATRI r;
     |ATRI n;

     nLectura = 1;
     |PCONTEXTO nLectura, nWidGuarda, nIdGuarda, nSidGuarda;
|FPRC;

|PROCESO LosDatos;
     #albw0016#0 = #artialm@#0; |PINTA #albw0016#0;
     |ABRE #agifa019;
     #agifa019#0 = #albw0016#0;
     |LEE 000#agifa019.=;
     |SI FSalida = 0;
        #albw0016#1 = (#agifa019#1 % 140); |PINTA #albw0016#1;
     |FINSI;
     |CIERRA #agifa019;
     #albw0016#2 = #artialm@#1; |PINTA #albw0016#2;
     |ABRE #agifa029;
     #agifa029#0 = #albw0016#2;
     |LEE 000#agifa029.=;
     |SI FSalida = 0;
        #albw0016#3 = (#agifa029#1 % 140); |PINTA #albw0016#3;
     |FINSI;
     |CIERRA #agifa029;
     #albw0016#5 = #artialm@#3; |PINTA #albw0016#5;
     |ABRE #agifa112;
     #agifa112#0 = #albw0016#5;
     |LEE 000#agifa112.=;
     |SI FSalida = 0;
        #albw0016#6 = #agifa112#1; |PINTA #albw0016#6;
     |FINSI;
     |CIERRA #agifa112;
|FPRC;


|PROCESO LosDatos2;
     |ABRE #dsm00024;
     |SELECT #3#dsm00024;
     #dsm00024#2 = #albw0016#4;
     |LEE 000#dsm00024.=;
     |SI FSalida = 0;
          |SI #dsm00024#42 = "S";
               nSwCerrada = 1;
               nSwExistePar = 0;
               |ACABA;
          |FINSI;
          #albw0016#12 = #dsm00024#31;
          #albw0016#13 = #dsm00024#32;
          |PINTA #albw0016#12;
          |PINTA #albw0016#13;

          #albw0016#0 = #dsm00024#0; |PINTA #albw0016#0;
          |ABRE #agifa019;
          #agifa019#0 = #albw0016#0;
          |LEE 000#agifa019.=;
          |SI FSalida = 0;
             #albw0016#1 = (#agifa019#1 % 140); |PINTA #albw0016#1;
          |FINSI;
          |CIERRA #agifa019;
          #albw0016#2 = #dsm00024#1; |PINTA #albw0016#2;
          |ABRE #agifa029;
          #agifa029#0 = #albw0016#2;
          |LEE 000#agifa029.=;
          |SI FSalida = 0;
             #albw0016#3 = (#agifa029#1 % 140); |PINTA #albw0016#3;
          |FINSI;
          |CIERRA #agifa029;
          #albw0016#5 = #dsm00024#3; |PINTA #albw0016#5;
          |ABRE #agifa112;
          #agifa112#0 = #albw0016#5;
          |LEE 000#agifa112.=;
          |SI FSalida = 0;
             #albw0016#6 = #agifa112#1; |PINTA #albw0016#6;
          |FINSI;
          |CIERRA #agifa112;
          nMaxStock = #dsm00024#31;
          nSwExistePar = 1;
     |SINO;
          nSwExistePar = 0;
     |FINSI;
     |CIERRA #dsm00024;
|FPRC;

|PROCESO albm0032_refe;
     nUltimo = #referen@#1;
     |SI #referen@#2 = #albw0016#0;
          nSwEsta = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE albm0032_refe;
 #referen@#1002;
 ;
 #albm0031#0, 01;
 #albm0031#0, 99;
 ;
 NULL, albm0032_refe;
|FIN;

|PROCESO MiraArticulo;
     |DBASE aAlfa; |QBF aAlfa;
     aMas = aAlfa + "def/albm0032.mas";
     |CARGA_DEF aMas, referen@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;
     nUltimo = 0;
     |BUCLE albm0032_refe;
     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO FinalIntroPar;
     |DDEFECTO #albw0014;
     #albw0014#0 = #albm0031#0;
     #albw0014#1 = nUltimo;
     |LEE 000#albw0014.=;

     |SI #albw0016#8 = "N";
        |ABRE #albm0035;
        #albm0035#0 = #albw0014#2;
        #albm0035#2 = #albw0014#4;
        #albm0035#4 = #albw0016#4;
        |LEE 101#albm0035.=;
        |SI FSalida = 0; |BORRA 020#albm0035.a; |FINSI;
        |CIERRA #albm0035;
     |FINSI;


     |ABRE #albm0043;
     #albm0043#0 = #albw0014#0;
     #albm0043#1 = #albw0014#1;
     #albm0043#2 = #albw0016#4;
     |LEE 101#albm0043.=;
     |SI FSalida ! 0;
        nOrden = 0;
        |HAZ SacaOrden;
        nOrden = nOrden + 1;
        |DDEFECTO #albm0043;
        #albm0043#0 = #albw0014#0;
        #albm0043#1 = #albw0014#1;
        #albm0043#2 = #albw0016#4;
        |GRABA 020#albm0043.b;
        #albm0043#14 = nOrden;
     |FINSI;
     nOrden = #albm0043#14;

     |ABRE #albm0032;
     #albm0032#0 = #albw0014#0;
     #albm0032#1 = #albw0014#1;
     |LEE 101#albm0032.=;
     |SI FSalida = 0;
        #albm0032#8 = #albm0032#8 + #albw0016#11;
        #albm0032#6 = #albm0032#6 + #albw0016#9;
        |GRABA 020#albm0032.a; |LIBERA #albm0032;
        #albw0014#8 = #albm0032#8;
        #albw0014#6 = #albm0032#6;
        |GRABA 020#albw0014.a;
     |FINSI;
     |CIERRA #albm0032;

     |ABRE #dsm00024;
     #dsm00024#0 = #albm0032#2;
     #dsm00024#1 = #albm0032#4;
     #dsm00024#2 = #albw0016#4;
     |LEE 000#dsm00024.=;
     |SI FSalida ! 0; |DDEFECTO #dsm00024; |FINSI;
     |CIERRA #dsm00024;

     ||Precio de compra + Importe

     |SI nModoEnt = 2;
          #albm0043#3 = #albw0016#9;
          #albm0043#4 = #albw0016#11;
     |SINO;
          #albm0043#3 = #albm0043#3 + #albw0016#9;
          #albm0043#4 = #albm0043#4 + #albw0016#11;
     |FINSI;
     #albm0043#5 = #albw0016#7;
     #albm0043#6 = #albw0016#8;
     #albm0043#7 = #albw0016#5;
     #albm0043#8 = #albw0016#6;
     ||#albm0043#9 = (#dsm00024#33 / #dsm00024#22) ! 2;
     #albm0043#9 = #dsm00024#38;
     #albm0043#10 = #albm0043#9 * #albm0043#4;
     #albm0043#14 = nOrden;
     |GRABA 020#albm0043.a; |LIBERA #albm0043;
     |CIERRA #albm0043;

     |DDEFECTO #albw0021;
     #albw0021#0 = #albm0031#0;
     #albw0021#1 = #albw0014#1;
     #albw0021#2 = #albw0016#4;
     |LEE 101#albw0021.=;
     |SI FSalida ! 0; |GRABA 020#albw0021.b; |FINSI;
     |SI nModoEnt = 2;
          #albw0021#3 = #albw0016#9;
          #albw0021#4 = #albw0016#11;
     |SINO;
          #albw0021#3 = #albw0021#3 + #albw0016#9;
          #albw0021#4 = #albw0021#4 + #albw0016#11;
     |FINSI;
     #albw0021#5 = #albw0016#7;
     #albw0021#6 = #albw0016#8;
     #albw0021#7 = #albw0016#5;
     #albw0021#8 = #albw0016#6;
     ||#albw0021#9 = (#dsm00024#33 / #dsm00024#22) ! 2;
     #albw0021#9 = #dsm00024#38;
     #albw0021#10 = #albw0021#9 * #albw0021#4;
     #albw0021#14 = nOrden;
     |GRABA 020#albw0021.a;
     |LIBERA #albw0021;

     |ABRE #albm0031;
     #albm0031#0 = nMezclada;
     |LEE 101#albm0031.=;
     |SI FSalida = 0;
        #albm0031#14 = #albm0031#14 + #albw0016#11;
        |SI nModoEnt = 2;
            #albm0031#21 = #albm0031#21 + #albw0021#10;
        |SINO;
            #albm0031#21 = #albm0031#21 + (#albw0021#9 * #albw0016#11);
        |FINSI;
        #albm0031#22 = #albm0031#21 / #albm0031#14;
        |GRABA 020#albm0031.a; |LIBERA #albm0031;
        nKgIntro = #albm0031#14;
        |HAZ PintaKilos;
     |FINSI;
     |CIERRA #albm0031;
|FPRC;

|PROCESO Tipo80; |TIPO 80;
   FSalida = 3099;
|FPRC;

|PROGRAMA;
   |ABRE #10;
   #10#0 = enMezclada;
   |LEE 101#10=;

   aAlfa  = "tl" + Usuario; |NOME_DAT #101 aAlfa;
   aAlfa  = "tp" + Usuario; |NOME_DAT #104 aAlfa;
   |DELINDEX #albw0014;
   |DELINDEX #albw0021;

   |ABRET #albw0014;
   |ABRET #albw0021;

   nMezclada = #albm0031#0;

   nLinea = 1;
   |BUCLE SacaLineas;
   |BUCLE SacaPartidas;

   |PINPA #0#900;
   nPanta = FSalida;

   nLectura = 0;
   |PCONTEXTO nLectura, nWidGuarda, nIdGuarda, nSidGuarda;

   nKgIntro = #albm0031#14;
   |HAZ PintaKilos;

   aMensaje = "Mezclada Numero: " + (("000000" + #albm0031#0) % -106) + "   " + #albm0031#1;
   |ATRI N;
   |PINTA 0903, aMensaje;
   |ATRI 0;

   |CONTROL_SIMPLE nPanta, "BOTON,{{206}} Nueva partida", 2846, 2866, Boton2;
   nBoton2 = FSalida;

   |CONTROL_SIMPLE nPanta, "BOTON,{{207}} Borra partida", 2868, 2886, Boton3;
   nBoton3 = FSalida;

   |CONTROL_SIMPLE nPanta, "BOTON,Finalizar Mezclada", 2802, 2822, Boton4;
   nBoton4 = FSalida;

   |CONTROL_SIMPLE nPanta, "BOTON,{{137}} Introd. Partida", 2824, 2844, Boton5;
   nBoton5 = FSalida;

   |ESTADO_CONTROL nBoton2, "DISABLE";
   |ESTADO_CONTROL nBoton3, "ENABLE";
   |ESTADO_CONTROL nBoton4, "ENABLE";
   |ESTADO_CONTROL nBoton5, "ENABLE";

   |LEE 000#albw0014.p;
   |SI FSalida ! 0; |DDEFECTO #albw0014; |FINSI;

   |LEE 000#albw0021.p;
   |SI FSalida ! 0; |DDEFECTO #albw0021; |FINSI;

   nPos1 = 1902;
   nPos2 = 2598;
   nModo = 2 + 4 + 8 + 16 + 32 + 128;

   |LINEAL_SIMPLE #1#104, nModo, nPos1, nPos2, Infw43, Supw43, Evento;
   nPartidas = FSalida;

   |PARA;  |SI;  |HACIENDO;
       nSalir = 1;
       nModo  = 2 + 4 + 8 + 16 + 128;
       nPos1  = 1102;
       nPos2  = 1798;
       |LINEAL_SIMPLE #1#101, nModo, nPos1, nPos2, Infw14, Supw14, ModifPartida;
       |SI nSalir = 1;  |SAL;  |FINSI;
   |SIGUE;

   |CIERRA #101;

   |FIN_CONTROL_WINDOWS nBoton5;
   |FIN_CONTROL_WINDOWS nBoton4;
   |FIN_CONTROL_WINDOWS nBoton3;
   |FIN_CONTROL_WINDOWS nBoton2;

   |DESTRUYECONTROL nPartidas;

   |PULSATECLA;

   |CIERRAT #albw0014;
   |CIERRAT #albw0021;

   |CIERRA #10;
|FPRO;

|PROCESO albm43;
     |SI nOrden < #albm43@#14;
          nOrden = #albm43@#14;
     |FINSI;
|FPRC;

|DEFBUCLE NumOrden;
 #albm43@#1003;
 ;
 #albw0014#0, 01, "               ";
 #albw0014#0, 99, "zzzzzzzzzzzzzzz";
 ;
 NULL, albm43;
|FIN;

|PROCESO SacaOrden;
     |DBASE aAlfa;
     |QBF aAlfa;
     aAlfa = aAlfa + "def/albm0043";
     |CARGA_DEF aAlfa, albm43@;
     |SI FSalida = 0;
          |BUCLE NumOrden;
          |DESCARGA_DEF #albm43@;
     |FINSI;
|FPRC;

|PROCESO PonMensaje; |TIPO 7;
     |SI nModoEnt ! 3;
          |MENSA "2405<F2> Consulta Partidas";
     |FINSI;
|FPRC;
