|FICHEROS;
     coimz004 #0;
     coima001 #1;
     dsm00003 #3;
     coima006 #6;
     coimw007 #7;   || Tmp Stock
     coimw008 #8,MANTE;   || Tmp Adjudica
     agifa010 #10;
     coima013 #13;
     coimw006 #16;  || Tmp Orden
     agifa017 #17;
     agifa019 #19;
     dsm00020 #20;
     agifa007 #21;
     agifa024 #24;
     agifa025 #25;
     coima026 #26;
     coima027 #27;
     agifa071 #71;
     agifa073 #73;
     agifa104 #104;
     coima007 #107;
     coima017 #117;
     coima025 #125;
     agifa142 #142;
     coima016 #160;
     dsm00225 #225;
     agifa321 #321;
     agifa324 #324;
     agifa328 #328;
     agifa329 #329;
     dsm00005 #905;
     dsm00046 #946;
     dsm00047 #947;
     referen@ #100;
|FIN;

|VARIABLES;
     nUni = 0;
     &enModoCoimasa = 0;

     nAux = 0;
     nAux2 = 0;

     nSwSirve = 0;
     nSwOk = 0;
     aUsu = "";
     nPorcOfi = 0; || Porcenta Oficial
     nAcumA = 0;   || Acum. Imp. Oficial
     nAcumB = 0;   || Acum. Imp. B
     nAcumTot = 0; || Acumulado Total
     nPorcCal = 0; || Porcentaje que llevamos
     nPorcSirve = 0;
     nNumLin = 0;  || Controla primera línea

     nImpre = 0;
     aSerBl = "";
     nNumBl = 0;
     nTotNoSer = 0;
     nTotSer = 0;
     nPrecio = 0;
     nDir = 0;
     aEntrega = "";
     aDirEnt = "";
     aPobla = "";
     nContaAdj = 0;
     aHora = "";
     fHoy = @;
     &eaCodCliente = "";
     aValor = "";
     nClaveAnt = 0;
     nClave = 0;
     aEstaComple = "";
     nImpPdte = 0;
     &enSwMenu = 1;
     &Tempo = "";
     &enNumAlbAnt = 0;
     &enNumPedido = 0;
     &eaSerPedido = "";
     &eaSerAlb = "";
     &eaFecAlb = "";
     &enNumAlb = 0;

     &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_Div      = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDiv   = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVis   = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVis = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVis   = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVis   = 0;   || Decimales en el Importe visual. (lineas)
     &nDeci_BaseMxP  = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBasMxP= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_DivP     = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDivP  = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVisP  = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVisP= 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVisP  = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVisP  = 0;   || Decimales en el Importe visual. (lineas)
     nfecha    = 0;
     &ac_divisa = "N";   || Vale "S" cuando las divisas en ventas estan
                         || activadas y la serie es de divisas
     &pintado = 0;       || Sirve para controlar los pintados de las lineas
     &decim_divisa = 0;  || Decimales de la divisa
     &precio_divisa = 0; || Decimales del precio en divisa
     &decim_base = 0;    || Decimales de la moneda base
     &precio_base = 0;   || Decimales del precio en moneda base
     div_act = 0;        || Divisa actualizada. Me sirve en un PARA para que
                         || no salga hasta que este actualizada (div_act=1)
     &cli_divisa = "";   || Codigo de Cliente. Se pasa a CLIENTES/DIVISAS
     &divisa = "";       || Codigo de Divisa. Se pasa a ACTUAL. de DIVISAS

     aAlfa = "";
     aAlfa1 = "";
     fFecha = @;
     aAny = "";
     aFecha = "";
     aClave = "";
     aFPed = "";
     aFEnt = "";
     i = 0;
     aTmp7 = "";
     aTmp8 = "";
     aTmp16 = "";
     nCampo = "";
     nSwParri = 0;
     aServir = "";
     nPdte = 0;
     nUniAdj = 0;
     aSerPed = "";
     nNumPed = 0;
     aComple = "";
     nSwCole = 0;
     aDj = "";
     nHay = 0;
 {-1}aMenu = "";
     aMenu1 = "2400";
     aMenu2 = "1";
     aMenu3 = "";
     aMenu4 = "AjPEC";
     aMenu5 = "Aceptar";
     aMenu6 = "Adjudicadas";
     aMenu7 = "Pendientes";
     aMenu8 = "Especiales";
     aMenu9 = "Cancelar";
     aCli = "";
     aRep = "";
     aFP = "";
     nPP = 0;
     aSer = "";
     &nImpo = 0;
     importe = 0;
     importeD = 0;
     nMult = 0;
     nBrutoMoneda1 = 0;
     nImporDescue1 = 0;
     nImporDescue2 = 0;
     nImporDescue3 = 0;
     nBrutoMoneda2 = 0;
     nImpDiv = 0;
     nCalc = 0;
     &nRieTotal      = 0;
     &nRieUtili      = 0;
     &aRieBloqu      = "";
     &aBloquead      = "";
     &eaTag = "";
     nNume = 0;
     nLinV = 0;
     nLinea = 0;
     cant = 0;
     nUniAnt = 0;
     nAcumula = 0;
     nCanti = 0;
     nReparto = 0;
     nPorce = 0;
     nEntero = 0;
     nCantiBlanco = 0;
     nTCantiBlanco = 0;
     nMasMenos = 0;
     &enCodAlbNegro = 0;
     nTotalNegro = 0;
     nTotalBlanco = 0;
     nPorceT = 0;
     aExporNegro = "";
     nCanti2 = 0;
     nCantiBlanco2 = 0;
     aSerAlbBlanco = "";
     nCodAlbBlanco = 0;
     nCodAlb = 0;
     aEsKit = "";
     nSwChecKit = 0;
     nPdteKit = 0;
     nUniAdjKit = 0;
     nImpServ = 0;
     nImp = 0;
     nSer = 0;

     &enImpRiesgo = 0;
|FIN;

|INCLUYE i_varart;

|PROCESO FinCheqMinPdte;
     |SI aCli ! ""; |Y nImp < #1#25; |Y nImp > 0; |Y #1#25 > 0;
          |AVISO;
          aAlfa = "0000El cliente " + aCli + " le queda pendiente " + nImp + " y se le servirá " + nImpServ + "."
          |MENAV aAlfa;
          aAlfa = "0000S¿Desadjudicar?";
          |CONFI aAlfa;
          |SI FSalida = 0;
               |ABRE #117;
               |SALVA_DATOS #8;
               #8#4 = aCli;
               #8#19 = 0;
               |LEE 121#8];
               |PARA; |SI FSalida = 0; |Y #8#4 = aCli; |HACIENDO;
                    |HAZ Desadj;
                    |LEE 101#8s;
               |SIGUE;
               |LIBERA #8;
               |CIERRA #117;
               |REPON_DATOS #8;
               |LEE 020#8=
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CheqMinPdte;
     |SI aCli = ""; aCli = #8#4; |FINSI;
     |SI aCli ! #8#4;
          |HAZ FinCheqMinPdte;
          nImp = 0;
          nImpServ = 0;
          aCli = #8#4;
     |FINSI;
     nImp = nImp + #8#26;
     nSer = #8#23 - #8#26;
     nImpServ = nImpServ + nSer;
|FPRC;

|DEFBUCLE CheqMinPdte;
     #8#6;
     ;
     INICIO;
     FINAL;
     ;
     NULL, CheqMinPdte, NULL, NULL, FinCheqMinPdte;
|FIN;

|PROCESO CalcuNoAdj;
     #104#25 = #8#1;
     #104#0 = #8#2;
     |LEE 020#104=;

     #73#28 = #8#1;
     #73#0 = #8#2;
     #73#1 = #8#3;
     |LEE 020#73=;

     #73#5 = #8#9 - #8#10 + #73#43;
     |HAZ TotalLin73;

     #8#26 = #73#11;
     |GRABA 020#8a;
|FPRC;

|DEFBUCLE CalcuNoAdj;
     #8#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, CalcuNoAdj;
|FIN;

|PROCESO DocWeb;
     |DDEF aAlfa;
     aAlfa = aAlfa + "coima038";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          #referen@#0 = "AV";
          #referen@#1 = #10#52;
          #referen@#2 = #10#0;
          |LEE 101#referen@.=;
          |SI FSalida ! 0; |GRABA 020#referen@.b; |FINSI;
          #referen@#3 = #10#1;
          #referen@#4 = "N";
          |GRABA 020#referen@.a;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO acttl;
     |HAZ TotalLin71;
     |GRABA 001#71a; ||Grabo lineas
     |HAZ CalCabAgifa010;
|FPRC;

|PROCESO ActualizaFicha;
     |HAZ LimCabAgifa010;
     |BUCLELIN 0acttl#10;
|FPRC;

|PROCESO Reparto;
     nAcumula = nAcumula + nCanti;
     nReparto = nCanti * nPorce;
     nEntero  = (nReparto - .50) ! 0;
     |SI nReparto = nEntero;
         nCantiBlanco = nReparto;
         nTCantiBlanco = nTCantiBlanco + nCantiBlanco;
     |SINO;
         nReparto = ((nCanti * nPorce) - nMasMenos);
         |SI nReparto < 0;
             nCantiBlanco = 0;
         |SINO;
             nEntero = (nReparto - .50) ! 0;
             |SI nReparto = nEntero;
                 nCantiBlanco  = nReparto;
                 nTCantiBlanco = nTCantiBlanco + nCantiBlanco;
             |SINO;
                 nCantiBlanco = nEntero + 1;
                 nTCantiBlanco = nTCantiBlanco + nCantiBlanco;
             |FINSI;
         |FINSI;
     |FINSI;

     nReparto  = nAcumula * nPorce;
     nMasMenos = nTCantiBlanco - nReparto;
|FPRC;

|PROCESO PorUnidadC;
     nCanti = #905#6;
     |HAZ Reparto;

     |SALVA_FICHA #905;

     #905#1  = #24#199;
     #905#2  = enCodAlbNegro;
     #905#6  = nCanti - nCantiBlanco;
     #905#8  = #905#6 * #905#7;
     #905#9  = 0;
     #905#11 = 0;
     #905#12 = 0;
     |GRABA 020#905n;

     |REPON_FICHA #905;
     #905#10 = #905#6;
     #905#6  = nCantiBlanco;
     #905#8  = #905#6 * #905#7;
     |GRABA 020#905a;
     |LIBERA #905;
|FPRC;

|PROCESO PorPrecioC;
     nCanti = #905#7;
     |HAZ Reparto;

     |SALVA_FICHA #905;

     #905#1 = #24#199;
     #905#2 = enCodAlbNegro;
     #905#7 = #905#7 - nCantiBlanco;
     #905#8 = #905#6 * #905#7;
     #905#9  = 0;
     #905#11 = 0;
     #905#12 = 0;
     |GRABA 020#905n;
     nTotalNegro = nTotalNegro + #905#8;

     |REPON_FICHA #905;
     #905#10 = #905#7;
     #905#7  = nCantiBlanco;
     #905#8  = #905#6 * #905#7;
     |GRABA 020#905a;
     |LIBERA #905;
     nTotalBlanco = nTotalBlanco + #905#8;
|FPRC;

|PROCESO PorProporcion;
     |SI #19#176 = "S";
/*
         nLinV = #71#1;
         |BUCLE dsm00005;

         |SALVA_FICHA #71;

         #71#29 = #24#199;
         #71#0  = enCodAlbNegro;
         #71#5  = #71#5 - nTCantiBlanco;
         aAlfa = "U" + "N" + (("000" + nPorceT) % -103);
         #71#47 = aAlfa;
         |SI aExporNegro = "S"; #71#11 = 0; |FINSI;  ||Exporta
         |GRABA 020#71n;

         |REPON_FICHA #71;

         aAlfa = "U" + "P" + (("000" + nPorceT) % -103) + (("               " + #71#5) % -115);
         #71#47 = aAlfa;
         #71#5  = nTCantiBlanco;
         |GRABA 020#71a;
*/
     |SINO;
         |SI #19#179 = "S";         || Doble Stock
/*
              |SI #71#48 = 1;
                  nPorce = 1;  || Si uni2 = 1 no hay desglose
                  nPorceT = 0;
              |FINSI;
              nCanti = #71#5;
              nReparto = nCanti * nPorce;
              nCantiBlanco = nReparto ! #19#187;
              nCanti2 = #71#48;
              nReparto = nCanti2 * nPorce;
              nCantiBlanco2 = nReparto ! 0;
              #71#50 = #71#50 * nPorce;
*/
         |SINO;
               nCanti = #71#5;
               nCantiBlanco = 0;
               |SI nPorcOfi = 0;
                    nCantiBlanco = 0;
               |SINO;
                    |SI nNumLin = 0;
                         nNumLin = 1;
                         |SI nPorcOfi ] 50;
                              || Como el porcentaje es igual o mayor Of 1º unidad de la linea del albaran todo oficial
                              nCantiBlanco = 1;     
                              nAcumA = #71#6 < #71#8 < #71#33;
                              nAcumTot = nAcumA;
                         |SINO;
                              nAcumB = #71#6 < #71#8 < #71#33;
                              nAcumTot = nAcumB;
                         |FINSI;
                         nPorcCal = (nAcumA * 100) / (nAcumTot);
                         |PARA i = 2;|SI i [ #71#5;|HACIENDO i = i + 1;
                              |SI nPorcOfi < nPorcCal;
                                   || Como % oficial es inferior al que se lleva B
                                   nAcumB = nAcumB + (#71#6 < #71#8 < #71#33);
                                   nAcumTot = nAcumTot + (#71#6 < #71#8 < #71#33);
                              |SINO;
                                   nAcumA = nAcumA + (#71#6 < #71#8 < #71#33);
                                   nAcumTot = nAcumTot + (#71#6 < #71#8 < #71#33);
                                   nCantiBlanco = nCantiBlanco + 1;
                              |FINSI;
                              nPorcCal = (nAcumA * 100) / (nAcumTot);
                         |SIGUE;
                    |SINO;
                         |PARA i = 1;|SI i [ #71#5;|HACIENDO i = i + 1;
                              |SI nPorcOfi < nPorcCal;
                                   || Como % oficial es inferior al que se lleva B
                                   nAcumB = nAcumB + (#71#6 < #71#8 < #71#33);
                                   nAcumTot = nAcumTot + (#71#6 < #71#8 < #71#33);
                              |SINO;
                                   nAcumA = nAcumA + (#71#6 < #71#8 < #71#33);
                                   nAcumTot = nAcumTot + (#71#6 < #71#8 < #71#33);
                                   nCantiBlanco = nCantiBlanco + 1;
                              |FINSI;
                              nPorcCal = (nAcumA * 100) / (nAcumTot);
                         |SIGUE;
                    |FINSI;     
               |FINSI;
               nCanti2 = 0;
               nCantiBlanco2 = 0;
         |FINSI;

         |SALVA_FICHA #71;

         #71#29 = #24#199;
         #71#0  = enCodAlbNegro;
         #71#5  = nCanti - nCantiBlanco;
         #71#48  = nCanti2 - nCantiBlanco2;
         aAlfa = "X" + (("000" + nPorcOfi) % -103) + (("               " + nCantiBlanco) % -115);
         aAlfa = aAlfa + (("               " + #71#5) % -115);
         #71#47 = aAlfa;
         |SI aExporNegro = "S"; #71#11 = 0; |FINSI;  ||Exporta
         |GRABA 020#71n;
         |REPON_FICHA #71;
         #71#47 = aAlfa;
         #71#5  = nCantiBlanco;
         #71#48  = nCantiBlanco2;
         |GRABA 020#71a;
         |LIBERA #71;
     |FINSI;
|FPRC;

|PROCESO LineasBlancasC;
     |SI #24#198 = "U";   |HAZ PorUnidadC;  |FINSI;
     |SI #24#198 = "P";   |HAZ PorPrecioC;  |FINSI;
     |SI #24#198 = "A";
         |SI #19#178 = " ";  #19#178 = "U";     |FINSI;
         |SI #19#178 = "U";  |HAZ PorUnidadC;  |FINSI;
         |SI #19#178 = "P";  |HAZ PorPrecioC;  |FINSI;
     |FINSI;
     |SI #24#198 = "X"; |HAZ PorProporcion; |FINSI;
|FPRC;

|DEFBUCLE dsm00005;
     #905#1;
     ;
     "AV", #71#29, #71#0, nLinV, "      ";
     "AV", #71#29, #71#0, nLinV, "zzzzzz";
     be;
     NULL, LineasBlancasC;
|FIN;

|PROCESO PorUnidad;
     |SI #19#176 = "S";
         nLinV = #71#1;
         |BUCLE dsm00005;

         |SALVA_FICHA #71;

         #71#29 = #24#199;
         #71#0  = enCodAlbNegro;
         #71#5  = #71#5 - nTCantiBlanco;
         aAlfa = "U" + "N" + (("000" + nPorceT) % -103);
         #71#47 = aAlfa;
         |SI aExporNegro = "S"; #71#11 = 0; |FINSI;  ||Exporta
         |GRABA 020#71n;

         |REPON_FICHA #71;

         aAlfa = "U" + "P" + (("000" + nPorceT) % -103) + (("               " + #71#5) % -115);
         #71#47 = aAlfa;
         #71#5  = nTCantiBlanco;
         |GRABA 020#71a;
     |SINO;
         |SI #19#179 = "S";         || Doble Stock
              |SI #71#48 = 1;
                  nPorce = 1;  || Si uni2 = 1 no hay desglose
                  nPorceT = 0;
              |FINSI;
              nCanti = #71#5;
              nReparto = nCanti * nPorce;
              nCantiBlanco = nReparto ! #19#187;
              nCanti2 = #71#48;
              nReparto = nCanti2 * nPorce;
              nCantiBlanco2 = nReparto ! 0;
              #71#50 = #71#50 * nPorce;
         |SINO;
               nCanti = #71#5;
               nReparto = nCanti * nPorce;
               nCantiBlanco = nReparto ! #19#187;
               nCanti2 = 0;
               nCantiBlanco2 = 0;
         |FINSI;

         |SALVA_FICHA #71;

         #71#29 = #24#199;
         #71#0  = enCodAlbNegro;
         #71#5  = nCanti - nCantiBlanco;
         #71#48  = nCanti2 - nCantiBlanco2;
         aAlfa = "U" + "N" + (("000" + nPorceT) % -103);
         #71#47 = aAlfa;
         |SI aExporNegro = "S"; #71#11 = 0; |FINSI;  ||Exporta
         |GRABA 020#71n;

         |REPON_FICHA #71;

         aAlfa = "U" + "P" + (("000" + nPorceT) % -103) + (("               " + #71#5) % -115);
         aAlfa = aAlfa + (("               " + #71#48) % -115);
         #71#47 = aAlfa;
         #71#5  = nCantiBlanco;
         #71#48  = nCantiBlanco2;
         |GRABA 020#71a;
         |LIBERA #71;
     |FINSI;
|FPRC;

|PROCESO PorPrecio;
     |SI #19#176 = "S";
         nTotalNegro  = 0;
         nTotalBlanco = 0;
         nLinV = #71#1;
         |BUCLE dsm00005;

         |SALVA_FICHA #71;

         #71#29 = #24#199;
         #71#0  = enCodAlbNegro;
         |SI #10#70 = "D";
             #71#36 = nTotalNegro / #71#5;
         |SINO;
             #71#6  = nTotalNegro / #71#5;
         |FINSI;

         aAlfa = "P" + "N" + (("000" + nPorceT) % -103);
         #71#47 = aAlfa;
         |SI aExporNegro = "S"; #71#11 = 0; |FINSI;  ||Exporta
         |GRABA 020#71n;

         |REPON_FICHA #71;

         |SI #10#70 = "D";
             aAlfa = "P" + "P" + (("000" + nPorceT) % -103) + (("               " + #71#36) % -115);
             #71#47 = aAlfa;
             #71#36 = nTotalBlanco / #71#5;
         |SINO;
             aAlfa = "P" + "P" + (("000" + nPorceT) % -103) + (("               " + #71#6) % -115);
             #71#47 = aAlfa;
             #71#6  = nTotalBlanco / #71#5;
         |FINSI;
         |GRABA 020#71a;
         |LIBERA #71;
     |SINO;
         |SI #10#70 = "D";
             nCanti = #71#36;
         |SINO;
             nCanti = #71#6;
         |FINSI;
         |HAZ Reparto;

         |SALVA_FICHA #71;

         #71#29 = #24#199;
         #71#0  = enCodAlbNegro;
         |SI #10#70 = "D";
             #71#36 = nCanti - nCantiBlanco;
         |SINO;
             #71#6 = nCanti - nCantiBlanco;
         |FINSI;
         aAlfa = "P" + "N" + (("000" + nPorceT) % -103);
         #71#47 = aAlfa;
         |SI aExporNegro = "S"; #71#11 = 0; |FINSI;  ||Exporta
         |GRABA 020#71n;

         |REPON_FICHA #71;

         |SI #10#70 = "D";
             aAlfa = "P" + "P" + (("000" + nPorceT) % -103) + (("               " + #71#36) % -115);
             #71#47 = aAlfa;
             #71#36 = nCantiBlanco;
         |SINO;
             aAlfa = "P" + "P" + (("000" + nPorceT) % -103) + (("               " + #71#6) % -115);
             #71#47 = aAlfa;
             #71#6  = nCantiBlanco;
         |FINSI;
         |GRABA 020#71a;
         |LIBERA #71;
     |FINSI;
|FPRC;

|PROCESO KitNegro;
     #947#0 = #24#199;
     #947#1 = enCodAlbNegro;
     |GRABA 020#947n;
|FPRC;

|DEFBUCLE KitNegro;
     #947#1;
     ;
     #71#29, #71#0, #71#1, 001;
     #71#29, #71#0, #71#1, 999;
     ;
     NULL, KitNegro;
|FIN;

|PROCESO LineasBlancas;
     |LEE 101#71=;

     aAlfa         = #71#47 % 303;
     nPorceT       = aAlfa;
     nPorce        =  ((100 - nPorceT) / 100);
     nMasMenos     = 0;
     nAcumula      = 0;
     nTCantiBlanco = 0;
     nMasMenos     = 0;
     |SI nAcumTot = 0;
          nPorcOfi = 100 - nPorceT;
     |FINSI;

     |ABRE #19;
     #19#0 = #71#2;
     |LEE 000#19=;
     |SI FSalida ! 0;  |DDEFECTO #19;  |FINSI;
     |CIERRA #19;

     |SI #24#198 = "U";   |HAZ PorUnidad;  |FINSI;
     |SI #24#198 = "P";   |HAZ PorPrecio;  |FINSI;
     |SI #24#198 = "A";
         |SI #19#178 = " ";  #19#178 = "U";     |FINSI;
         |SI #19#178 = "U";  |HAZ PorUnidad;  |FINSI;
         |SI #19#178 = "P";  |HAZ PorPrecio;  |FINSI;
     |FINSI;
     |SI #24#198 = "X"; |HAZ PorProporcion; |FINSI;
     eaArticulo = #71#2;
     |HAZ EsKit;
     |SI FSalida = 0;
          |BUCLE KitNegro;
     |FINSI;
|FPRC;

|PROCESO DesgloseAlb;
     |ABRE #24;
     #24#0 = #10#3;
     |LEE 040#24=;
     |SI FSalida ! 0;  |DDEFECTO #24;  |FINSI;
     |CIERRA #24;

     |ABRE #21;
     #21#26 = #24#199;
     |LEE 000#21=;
     |CIERRA #21;
     aExporNegro = #21#30;

     aSerAlbBlanco = #10#52;
     nCodAlbBlanco = #10#0;
     nCodAlb       = #10#0;

     FSalida = 0;
     |PARA; |SI FSalida = 0;  |HACIENDO;
            |SI #142#103 = "N";
                enSwMenu = 1;
                |HAZ ContadorNegro;
            |SINO;
                enCodAlbNegro = nCodAlb;
            |FINSI;

            #10#52 = #24#199;
            #10#0  = enCodAlbNegro;
            |LEE 040#10=;

            nCodAlb = nCodAlb + 1;
     |SIGUE;

     #10#52 = #24#199;
     #10#0  = enCodAlbNegro;
     #10#8  = #24#200;
     #10#85 = "X";
     #10#86 = aSerAlbBlanco;
     #10#87 = nCodAlbBlanco;
     #10#97 = nCodAlbBlanco;
     #10#64 = #104#61;
     #10#2  = 0;
     #10#5  = #24#201;
     |GRABA 020#10n;

     #10#52 = aSerAlbBlanco;
     #10#0  = nCodAlbBlanco;
     |LEE 101#10=;
     |SI FSalida = 0;
         #10#86 = #24#199;
         #10#87 = enCodAlbNegro;
         #10#97 = enCodAlbNegro;
        |BUCLELIN 0LineasBlancas#10;
     |FINSI;
|FPRC;

|PROCESO DesgloNegro;
     nAcumA = 0;
     nAcumB = 0;
     nAcumTot = 0;
     nNumLin = 0;

     |HAZ DesgloseAlb;
     |HAZ ActualizaFicha;
     |GRABA 020#10a;
     |LIBERA #10;

     #10#52 = #24#199;
     #10#0  = enCodAlbNegro;
     |LEE 101#10=;
     |SI FSalida = 0;
          |HAZ ActualizaFicha;
          |GRABA 020#10a;
          |LIBERA #10;

          |HAZ EsWeb;
          |SI FSalida = 0;
               |HAZ DocWeb;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Param_Divisas4; |TIPO 0;
     |ABRE #agifa324;
     #agifa324#0 = #agifa010#68;
     |LEE 001#agifa324.=;   || Leo la divisa
     |CIERRA #agifa324;

     decim_divisa = #agifa324#7;  || Decimales de la divisa
     precio_divisa = #agifa324#9;  || Decimales en el precio de la divisa
     nDeci_Div = decim_divisa;   || Decimales de la divisa
     nDeci_PreDiv = precio_divisa;  || Decimales en el precio de la divisa
     nDeci_DivP = decim_divisa;   || Decimales de la divisa
     nDeci_PreDivP = precio_divisa;  || Decimales en el precio de la divisa
     |SI #10#70 = "B";   || Si trabajo con la moneda base ...
         nDeci_Base     = decim_base;
         nDeci_PreBase  = precio_base;
         nDeci_PreVis   = precio_divisa;
         nDeci_ImpVis   = decim_divisa;
         nDeci_BaseMx   = decim_base;
         nDeci_PreBaseMx= precio_base;
         nDeci_TotVis   = decim_base;
         nDeci_TotNoVis = decim_divisa;
         nDeci_PreVisP  = precio_divisa;
         nDeci_ImpVisP  = decim_divisa;
         nDeci_BaseMxP  = decim_base;
         nDeci_PreBasMxP= precio_base;
         nDeci_TotVisP  = decim_base;
         nDeci_TotNoVisP= decim_divisa;
     |SINO;     || Si trabajo con la divisa ...
         nDeci_Base     = decim_base; || Max. precision en los decimales de la moneda base
         nDeci_PreBase  = precio_base;  || Max. precision en los dec. del precio de la moneda base
         nDeci_PreVis   = precio_base;
         nDeci_ImpVis   = decim_base;
         |SI #10#69 = 1;
              nDeci_BaseMx    = decim_base;    || sin triangulacion
              nDeci_PreBaseMx = precio_base;
         |SINO;
              nDeci_BaseMx    = #agifa321#10;  || con triangulacion
              nDeci_PreBaseMx = #agifa321#11;
         |FINSI;
         nDeci_TotVis   = decim_divisa;
         nDeci_TotNoVis = decim_base;
         nDeci_PreVisP  = precio_base;
         nDeci_ImpVisP  = decim_base;
         |SI #10#69 = 1;
              nDeci_BaseMxP   = decim_base;    || sin triangulacion
              nDeci_PreBasMxP = precio_base;
         |SINO;
              nDeci_BaseMxP   = #agifa321#10;  || con triangulacion
              nDeci_PreBasMxP = #agifa321#11;
         |FINSI;
         nDeci_TotVisP  = decim_divisa;
         nDeci_TotNoVisP= decim_base;
     |FINSI;
     |HAZ Deci_IVA;
|FPRC;

|PROCESO CambioDivisa4; |TIPO 0;
     |SI #agifa024#191 = "S"; || Si el cliente es de divisa pactada
         |ABRE #agifa328;
         |ABRE #agifa329;
         #agifa329#0 = #agifa010#3;
         #agifa329#2 = #agifa010#68;
         #agifa329#7 = "N";
         |SELECT #2#agifa329;  || Con esta clave ...
         |LEE 011#agifa329.=;  || ... busco periodos no finalizados de esa divisa
         |SI FSalida = 0;  || Si existe un periodo no finalizado
            |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
                  #agifa010#69 = #agifa329#3;        || ...y el cambio
                  |LEE 001#agifa329.=;   || Leo las lineas de Clientes/Divisas
                  nfecha = #agifa010#1 - #agifa329#6;  || Resto la fecha de fin de periodo a la actual
                  |SI nfecha > 0;  || Si la fecha actual supera a la del periodo asignado ...
                      |MENAV "0000ATENCION deberia Actualizar primero la divisa en Clientes/Divisas";
                      cli_divisa = #agifa010#3;  || Le envio el cod. de cliente a "agifa328"
                      |SUB_EJECUTA_NP "agifa328.tab";  || Ejecuto Clientess/Divisas
                      |ERROR;
                  |SINO;
                      div_act = 1;  || Para salir del PARA
                  |FINSI;
            |SIGUE;
        |SINO;  || Si no existe un periodo no finalizado para esa divisa
           |MENAV "0000No existe un periodo activo para la divisa en Clientes / Divisas";
           cli_divisa = #agifa010#3;  || Le paso a "agifa328" el cliente
           |SUB_EJECUTA_NP "agifa328.tab";  || Ejecuto Clientes / Divisas
           |ERROR;
        |FINSI;
        |SELECT #1#agifa329;
        |CIERRA #agifa329;
        |CIERRA #agifa328;
     |SINO; || Si el Cliente no es de Divisa pactada ...
        |ABRE #agifa324; || ...miro directamente en divisas
        #agifa324#0 = #agifa010#68;
        |LEE 001#agifa324.=;
        |SI FSalida = 0; ||Si existe la divisa...
            #agifa010#69 = #agifa324#2; || la recojo
            |SI #agifa324#5 ! -1; || Si los dias de margen de actualizacion no
                               || son = -1 (indefinidos)
               |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
                     #agifa010#69 = #agifa324#2;        ||Cargo el valor del cambio
                     |LEE 001#agifa324.=;  || Leo la divisa
                     nfecha = #agifa010#1 - #agifa324#4;
                     |SI nfecha > #agifa324#5; |Y #agifa324#5 ! -1;  || Si la fecha actual
                         |MENAV "0000ATENCION deberia Actualizar primero la divisa";
                         divisa = #agifa010#68;
                         |SUB_EJECUTA_NP "agifa326.tab";
                         |ERROR;
                     |SINO;
                         div_act = 1;
                     |FINSI;
               |SIGUE;
            |FINSI;
        |FINSI;
        |CIERRA #agifa324;
     |FINSI;
     |HAZ Param_Divisas4;
|FPRC;

|PROCESO LineasKit;
     |DDEFECTO #947;
     #947#0 = #71#29;
     #947#1 = #71#0;
     #947#2 = #71#1;
     #947#3 = #946#3;
     #947#4 = #946#4;
     #947#5 = #946#5;
     #947#6 = #946#6;
     #947#7 = #946#7;
     #947#8 = #946#8;
     #947#9 = #946#9;
     #947#10 = #946#10;
     #947#11 = #946#11;
     #947#12 = #946#12;
     |GRABA 020#947n;
|FPRC;

|DEFBUCLE LineasKit;
     #946#1;
     ;
     #73#28, #73#0, #73#1, 001;
     #73#28, #73#0, #73#1, 999;
     ;
     NULL, LineasKit;
|FIN;

|PROCESO actulp;|TIPO 0;
     |ABRE #19;
     #19#0 = #73#2;
     |LEE 000#19=;
     |CIERRA #19;

     || nMult corrige redondeo importe negativo
     |SI #19#194 = 2;
          nImpo = #73#44  * #73#6;
     |SINO;
          nImpo = #73#5  * #73#6;
     |FINSI;

     importe  = #104#13;
     importeD = #104#44;
     |SI #19#194 = 2;
          #104#13 = (#73#49 * #73#6)  * nMult;
          #104#44 = (#73#49 * #73#38) * nMult;
     |SINO;
          #104#13 = (#73#43 * #73#6)  * nMult;
          #104#44 = (#73#43 * #73#38) * nMult;
     |FINSI;
/*
     #104#13 = ((((#104#13 < #73#8) < #73#29) < #104#5) < #104#17) < #104#6;
     #104#44 = ((((#104#44 < #73#8) < #73#29) < #104#5) < #104#17) < #104#6;
*/
     nBrutoMoneda1 = (#104#13 < #73#8) < #73#29;
     nImporDescue1 = (nBrutoMoneda1 % #104#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #104#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #104#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     #104#13 = nBrutoMoneda1;

     nBrutoMoneda2 = (#104#44 < #73#8) < #73#29;
     nImporDescue1 = (nBrutoMoneda2 % #104#5) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #104#17) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #104#6) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     #104#44 = nBrutoMoneda2;

     #104#13 = importe - (#104#13 * nMult);        || Imp Servido (C)
     #104#44 = importeD - (#104#44 * nMult);        || Imp Servido (C)

     #73#43 = #73#43 + #71#5;
     #73#49 = #73#49 + #71#48;

     #104#11 = #104#11  - #73#9;
     #104#42 = #104#42  - #73#39;

     |SI nImpo < 0; nMult = -1; |SINO; nMult = 1; |FINSI;
     |SI #19#194 = 2;
          #73#7   = (#73#44  * #73#6)  * nMult;
          nImpDiv = (#73#44  * #73#38) * nMult;
     |SINO;
          #73#7   = (#73#5  * #73#6)  * nMult;
          nImpDiv = (#73#5  * #73#38) * nMult;
     |FINSI;
/*
     #73#9  = ((((#73#7   < #73#8) < #73#29) < #104#5) < #104#17) < #104#6;
     #73#39 = ((((nImpDiv < #73#8) < #73#29) < #104#5) < #104#17) < #104#6;
*/
     nBrutoMoneda1 = (#73#7 < #73#8) < #73#29;
     nImporDescue1 = (nBrutoMoneda1 % #104#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #104#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #104#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     #73#9 = nBrutoMoneda1;

     nBrutoMoneda2 = (nImpDiv < #73#8) < #73#29;
     nImporDescue1 = (nBrutoMoneda2 % #104#5) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #104#17) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #104#6) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     #73#39 = nBrutoMoneda2;


     #73#7  = #73#7 * nMult;
     #73#9  = #73#9 * nMult;
     #73#39 = #73#39 * nMult;

     #104#11 = #104#11 + #73#9;
     #104#42 = #104#42 + #73#39;

     |SI #104#37 = "D";
         #73#41 = #73#9;
     |SINO;
         #73#41 = #73#39;
     |FINSI;

     |SI #19#194 = 2;
          importe  = (#73#49 * #73#6)  * nMult;
          importeD = (#73#49 * #73#38) * nMult;
     |SINO;
          importe  = (#73#43 * #73#6)  * nMult;
          importeD = (#73#43 * #73#38) * nMult;
     |FINSI;
/*
     importe  = ((((importe  < #73#8) < #73#29) < #104#5) < #104#17) < #104#6;
     importeD = ((((importeD < #73#8) < #73#29) < #104#5) < #104#17) < #104#6;
*/
     nBrutoMoneda1 = (importe < #73#8) < #73#29;
     nImporDescue1 = (nBrutoMoneda1 % #104#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #104#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #104#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     importe = nBrutoMoneda1;

     nBrutoMoneda2 = (importeD < #73#8) < #73#29;
     nImporDescue1 = (nBrutoMoneda2 % #104#5) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #104#17) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #104#6) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     importeD = nBrutoMoneda2;

     enTiva = #73#14;
     efFiva = #104#1;
     |HAZ SacaIVA;
     nCalc = (#73#11 % enIva);
     |SI #24#47 = "S";
          nCalc = nCalc + (#73#11 % enRec);
     |FINSI;
     nCalc = nCalc ! 2;
     nImpo = #73#11 + nCalc;
     eaTag = "PAA";  |HAZ Riesgos;

     #73#11 = #73#9  - (importe * nMult);|| Imp. Pdte (L)
     #73#37 = #73#37 + #71#35;

     enTiva = #73#14;
     efFiva = #104#1;
     |HAZ SacaIVA;
     nCalc = (#73#11 % enIva);
     |SI #24#47 = "S";
          nCalc = nCalc + (#73#11 % enRec);
     |FINSI;
     nCalc = nCalc ! 2;
     nImpo = #73#11 + nCalc;
     eaTag = "PAM";  |HAZ Riesgos;

     nImpo = #104#13;
     #104#13 = importe;                   || Imp Servido (C)
     #104#13 = (#104#13 * nMult) + nImpo;   || Imp Servido (C)
     #104#12 = #104#11 - #104#13;             || Imp Pdte serv (C)

     nImpo = #104#44;
     #104#44 = importeD;                  || Imp Servido (C)
     #104#44 = (#104#44 * nMult) + nImpo;   || Imp Servido (C)
     #104#43 = #104#42 - #104#44;             || Imp Pdte serv (C)

     #104#24 = #104#24 + #71#5;              || Ctrl Servido (C)

     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     eaArticulo = #73#2;
     |HAZ EsKit;
     |SI FSalida = 0;
          |ABRE #947;
          |BUCLE LineasKit;
          |CIERRA #947;
     |FINSI;
     ||-------------------Actualiza Historico, Articulo y Almacen
     enForma = 1;
     enUnidPend = #71#5;
     enUnidPend2 = #71#48;
     eaProgVta = "agifa098";
     |HAZ AcumulaAV;
     |HAZ AcumulaPV;

     nNume  = ((((#71#9 < #10#5) < #10#32) < #10#7));
     #71#14  = enCoste;

     |SI #104#37 = "B";  || Asigna campos visual. y no visual. en el pedido segun la moneda de trabajo
       #104#45 = #104#11;
       #104#46 = #104#12;
       #104#47 = #104#13;
       #104#48 = #104#42;
       #104#50 = #104#43;
       #104#49 = #104#44;
     |SINO;
       #104#45 = #104#42;
       #104#46 = #104#43;
       #104#47 = #104#44;
       #104#48 = #104#11;
       #104#50 = #104#12;
       #104#49 = #104#13;
     |FINSI;
     |GRABA 020#104a;  |LIBERA #104;
     |GRABA 020#73a; |LIBERA #73;
|FPRC;

|PROCESO liacartia;
     #71#5 = #8#10;
     #71#48 = #73#48 - #73#49;

     #10#41 = #10#41 + 1;

     |HAZ TotalLin71;

     #71#24 = #73#5 - #73#43;
     #71#23 = #73#5;

     |HAZ actulp;

     |HAZ CalCabAgifa010;

     |SI #104#52 ! 0;
          |SI #24#198 = " "; |O #24#199 = "     ";
               aAlfa = "0000El cliente " + #24#0 + "no tiene el desglose preparado, no se realizara el mismo";
               |MENAV aAlfa;
          |SINO;
               aAlfa = #24#198 + "P" + (("000" + #104#52) % -103);
               #71#47 = aAlfa;
               #10#85 = "E";
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaCompoN;
     |SALVA_DATOS #905;

     #905#0  = "AV";
     #905#1  = #71#29;
     #905#2  = #71#0;
     #905#3  = #71#1;
     #905#6  = #905#6 - #905#12;
     #905#8  = #905#6 * #905#7;
     #905#9  = 0;
     #905#11 = 0;
     #905#12 = 0;
     |GRABA 020#905n;
     |LIBERA #905;

     |REPON_DATOS #905;
     |LEE 040#905=;

     eaTipo        = "AV";
     eaSerie       = #71#29;
     enCodigo      = #71#0;
     enLinea       = #71#1;
     efFecha       = #10#1;
     eaArticulo    = #71#2;
     enAlmacen     = #71#3;
     eaComponente  = #905#4;
     enUnidades    = #71#5;
     enTBruto      = #71#7;
     eaAbono       = #10#43;
     enTarifa      = #24#39;
     eaSeriePedido = #71#31;
     enCodigPedido = #71#12;
     enLineaPedido = #71#21;
     enCamBas      = #10#69;
     eaMoneda      = #10#70;
     enCamDiv      = #10#74;

     |SUB_EJECUTA_NP "dsz00002;AVC";
|FPRC;

|DEFBUCLE dsm00005N;
     #905#1;
     ;
     "PV", #71#31, #71#12, nLinV, "      ";
     "PV", #71#31, #71#12, nLinV, "zzzzzz";
     ;
     NULL, GrabaCompoN;
|FIN;

|PROCESO LeeMonBase4; ||Lee los parametros de la moneda base
     |ABRE #agifa321;
     |ABRE #agifa324;
     |LEE 010#agifa321.p;   ||Leo parametros de divisa
     #agifa010#73 = #agifa321#9;  ||Cojo la Moneda Base de parametros
     #agifa324#0 = #agifa321#9;
     |LEE 010#agifa324.=;         ||Leo la ficha de la moneda base en Divisas
     #agifa010#74 = #agifa324#2;  ||Asigno el cambio de la moneda base con el euro
     decim_base = #agifa324#7;    ||Asigno los decimales de la moneda base
     precio_base = #agifa324#9;   ||Asigno los decimales del precio en la mon. base
     |CIERRA #agifa324;
     |CIERRA #agifa321;
|FPRC;

|PROCESO actpf;|TIPO 0;
     cant = #10#15 < #10#5;
     cant = cant < #10#32;
     cant = cant < #10#7;
     |ABRE #24;
     #24#0 = #10#3;
     |LEE 121#24=;
     |SI FSalida = 0;
         #24#50 = #24#50 + cant;
         |GRABA 020#24a;
         |LIBERA #24;
     |FINSI;
     |CIERRA #24;

     enImpCliPen = cant;
     eaCliente = #10#3;
     efFecha = #10#1;
     |HAZ AcumulaCli;
|FPRC;

|PROCESO tot_ped_div;
     |SI #104#37 = "B";  || Asigna campos visual. y no visual. en el pedido segun la moneda de trabajo
         #104#45 = #104#11;
         #104#46 = #104#12;
         #104#47 = #104#13;
         #104#48 = #104#42;
         #104#50 = #104#43;
         #104#49 = #104#44;
     |SINO;
         #104#45 = #104#42;
         #104#46 = #104#43;
         #104#47 = #104#44;
         #104#48 = #104#11;
         #104#50 = #104#12;
         #104#49 = #104#13;
     |FINSI;
|FPRC;

|PROCESO EstaComple;
     nPdte = #73#5 - #73#43;
     |SI nPdte ! 0;
          aEstaComple = "N";
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE EstaComple;
     #104#2;
     ;
     #10#3, "     ", 000001;
     #10#3, "zzzzz", 999999;
     ;
     NULL, NULL, EstaComple;
|FIN;

|PROCESO CuentaUni;
     nUni = nUni + #71#5;
|FPRC;

|DEFBUCLE CuentaUni;
     #71#1;
     ;
     #13#0, #13#1, 001;
     #13#0, #13#1, 999;
     ;
     NULL, CuentaUni;
|FIN;

|PROCESO FinAdju;
     |HAZ actpf;

     |HAZ tot_ped_div;

     |SALVA_FICHA #73;
     |SALVA_FICHA #104;
     aEstaComple = "S";
     |BUCLE EstaComple;
     |SI aEstaComple = "S";
          #10#57 = "PEDIDO CUMPLIMENTADO";
     |FINSI;
     |REPON_FICHA #104;
     |REPON_FICHA #73;

     |HAZ ActualizaFicha;
     |GRABA 020#10a; |LIBERA #10;

     |HAZ EsWeb;
     |SI FSalida = 0;
          |HAZ DocWeb;
     |FINSI;

     aSerBl = #10#52;
     nNumBl = #10#0;
     |SI #10#85 = "E";
          |HAZ DesgloNegro;

          enImpRiesgo =      #10#16 + #10#17 + #10#18 + #10#19 + #10#20 + #10#21 + #10#22 + #10#23;
          enImpRiesgo = enImpRiesgo + #10#44 + #10#45 + #10#46 + #10#47 + #10#48 + #10#49 + #10#28;

          |SALVA_FICHA #10;
          #10#52 = aSerBl;
          #10#0 = nNumBl;
          |LEE 000#10=;
          |SI FSalida ! 0; |DDEFECTO #10; |FINSI;
          enImpRiesgo = enImpRiesgo + #10#16 + #10#17 + #10#18 + #10#19 + #10#20 + #10#21 + #10#22 + #10#23;
          enImpRiesgo = enImpRiesgo + #10#44 + #10#45 + #10#46 + #10#47 + #10#48 + #10#49 + #10#28;
          |REPON_FICHA #10;
     |SINO;
          enImpRiesgo = 0;
     |FINSI;
     eaTag = "AV";  |HAZ Riesgos;

     |ABRE #125;
     #125#0 = #10#52;
     |LEE 000#125=;
     |SI FSalida ! 0;
          |ABRE #26;
          #26#0 = #10#88;
          |LEE 000#26=;
          |SI FSalida ! 0;
               |ABRE #13;
               |DDEFECTO #13;
               |SI #10#85 = "X";
                    #13#0 = aSerBl;
                    #13#1 = nNumBl;
                    nUni = 0;
                    |BUCLE CuentaUni;
                    |SI nUni = 0;
                         #13#3 = "S";
                         #13#4 = "S";
                    |FINSI;
                    |GRABA 020#13n;
               |FINSI;
               |DDEFECTO #13;
               #13#0 = #10#52;
               #13#1 = #10#0;
               nUni = 0;
               |BUCLE CuentaUni;
               |SI nUni = 0;
                    #13#3 = "S";
                    #13#4 = "S";
               |FINSI;
               |GRABA 020#13n;
               |CIERRA #13;
          |FINSI;
          |CIERRA #26;
     |FINSI;
     |CIERRA #125;
|FPRC;

|PROCESO LinAlba;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = 999;
     |LEE 000#71];
     |SI FSalida = 0;
          |LEE 000#71a;
     |SINO;
          |LEE 000#71u;
     |FINSI;
     |SI #142#236 [ 0; #142#236 = 1; |FINSI; || aseguramos que sea ] 1

     |SI FSalida = 0; |Y #71#29 = #10#52; |Y #71#0 = #10#0;
          nLinea = #71#1 + #142#236;
     |SINO;
          nLinea = #142#236;
     |FINSI;

     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = nLinea;
     |PARA i = 2;|SI i < 11;|HACIENDO i = i + 1;
          #71i = #73i;
     |SIGUE;
     #71#3 = #73#3;
     #71#5 = #8#10;
     #71#11 = #73#14;
     |SI #21#30 = "S"; #71#11 = 0; |FINSI; || iva=0 en exportacion
     #71#12 = #104#0;
     #71#13 = #73#18;
     #71#15 = #73#20;
     #71#16 = #73#17;
     #71#17 = #73#19;
     #71#19 = "S";
     #71#21 = #73#1;
     #71#27 = #73#27;
     #71#33 = #73#29;
     #71#31 = #104#25;
     #71#34 = #73#35;
     #71#35 = #73#36 - #73#37;
     #71#36 = #73#38;                     ||Precio en divisa

     #71#49 = #73#45;   ||partida
     #71#50 = #73#46;   ||merma
     #71#51 = #73#50;   ||medida1
     #71#52 = #73#51;   ||medida2
     #71#53 = #73#52;   ||medida3
     #71#51 = #73#50;   ||medida1
     #71#62 = #73#54;   ||p.verde
     #71#63 = #73#55;   ||linea promo
     #71#64 = #73#56;   ||imp promo
     #71#65 = #73#57;
     #71#66 = #73#58;

     aAlfa = #71#2; |QBF aAlfa;
     |SI aAlfa ! "";
          |SI #142#202 = "S"; |O #142#40 = "S";
               aTipoDA = "AP"; |HAZ AltaDA;
          |FINSI;
     |FINSI;

     |HAZ liacartia;

     |GRABA 020#71n;
     nLinV = #71#21;
     |BUCLE dsm00005N;
|FPRC;

|PROCESO CabAlba;
     |ABRE #24;
     #24#0 = #8#4;
     |LEE 000#24=;
     |CIERRA #24;

     |ABRE #20;
     #20#0 = #104#60;
     |LEE 000#20=;
     |CIERRA #20;

     |ABRE #21;
     #21#26 = #8#16;
     |LEE 000#21=;
     |CIERRA #21;

     |ABRE #25;
     #25#0 = #8#11;
     |LEE 000#25=;
     |CIERRA #25

     |DDEFECTO #10;
     #10#1 = #0#13;
     #10#3 = #8#4;
     #10#4 = #8#5;
     ||#10#5 = #104#5;
     #10#7 = #8#13;
     ||#10#32 = #104#17;
     #10#6 = #8#11;
     #10#8 = #8#12;
     #10#9 = #20#1;

     #10#29 = #104#19;
     #10#30 = #104#14;
     #10#31 = #104#20;
     #10#33 = #104#21;
     #10#34 = #25#7;
     #10#35 = #24#4;
     #10#36 = #24#47;
     #10#40 = #24#41;
     #10#50 = #24#40;
     #10#51 = #21#28;
     #10#55 = #104#53;
     #10#56 = #104#54;
     #10#57 = #104#55;
     #10#62 = #104#59;
     #10#63 = #104#64;
     aAlfa = #10#63; |QBF aAlfa;
     |SI aAlfa = "";
          #10#63 = #24#15;
     |FINSI;
     #10#64 = #104#61;
     #10#68 = #104#35; ||DIVISA
     #10#69 = #104#36; ||CAMBIO
     #10#70 = #104#37; ||MONEDA DE TRABAJO
     #10#73 = #104#40; ||MONEDA BASE
     #10#74 = #104#41; ||CAMBIO MON. BASE

     aUsu = Usuario % 810; |QBF aUsu;
     aAlfa = #1#23; |QBF aAlfa;
     |SI aAlfa = aUsu;
          #10#83 = "F";
     |SINO;
          #10#83 = "";
     |FINSI;
     #10#84 = #104#57; || Dir Ent.
     #10#91 = #24#206;
     #10#88 = #20#0; ||Agencia
     |SI #6#5 = "S"; |O #6#5 = "X";
          |SI #8#15 = "S"; |O #6#5 = "X";
               #10#11 = #1#14;
               #10#81 = #1#14;
          |FINSI;
     |FINSI;
     |SI #21#30 = "N";
          #10#12 = #142#239;
     |SINO;
          #10#12 = 0;     
     |FINSI;

     |HAZ LeeMonBase4;
     |HAZ CambioDivisa4;

     |SI enNumAlbAnt ! 0;     || Llamado por dsz00067, a¤ade al albaran
          #10#52 = eaSerAlb;
          #10#0 = enNumAlbAnt;
          |LEE 121#10=;
     |SINO;
          |PARA FSalida = 1;|SI 0 ! FSalida;|HACIENDO FSalida = FSalida;
               enSwMenu = 1;
               eaSerie = #8#16;
               |HAZ ContaADJ;
               #10#0 = enCodigo;
               #10#52 = eaSerie;
               |GRABA 000#10b;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO Sirve;
     |SI aCli ! #8#4; |O aRep ! #8#11; |O aFP ! #8#12;
               |O nPP ! #8#13; |O aSer ! #8#16; |O nPorcSirve ! #8#25;
               |O nDir ! #8#19; |O aEntrega ! #8#20;
               |O aDirEnt ! #8#21; |O aPobla ! #8#22;
          |SI aCli ! "";
               |HAZ FinAdju;
          |FINSI;
          aCli = #8#4;
          aRep = #8#11;
          aFP = #8#12;
          nPP = #8#13;
          aSer = #8#16;
          nDir = #8#19;
          nPorcSirve = #8#25;
          aEntrega = #8#20;
          aDirEnt = #8#21;
          aPobla = #8#22;
          |HAZ CabAlba;
     |FINSI;
     |HAZ LinAlba;

     enModoCoimasa = 3;
     |HAZ CtrlPrioridaReservarAlb;
|FPRC;

|PROCESO Adjudicar;
     |SI #8#0 = "S"; |O #8#0 = "E";
          |SI #8#10 ! 0;
               #104#25 = #8#1;
               #104#0 = #8#2;
               |LEE 121#104=;

               |DDEFECTO #6;
               #6#0 = #104#25;
               #6#1 = #104#0;
               |LEE 000#6=;

               #73#28 = #8#1;
               #73#0 = #8#2;
               #73#1 = #8#3;
               |LEE 121#73=;

               nSwOk = 0;
               eaSerie = #73#28; eaTag = "PE";  |HAZ SacaRiesgo;
               |SI #agifa142#6 = "S";
                    |SI nRieUtili ] nRieTotal;  |Y nRieTotal ! 0;
                         aAlfa = "0000Riesgo Limite superado del cliente [" + #6#0 + "] ...";
                         |MENSA aAlfa;
                         |SI #agifa142#22 = "S";|O #agifa142#22 = "P";
                              |AVISO;
                              |BLIN 4;
                              |SI #agifa142#22 = "P";   || Avisa y para
                                   nSwOk = 1;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI aRieBloqu = "S";
                    |HAZ BloqCart;
                    nSwOk = 1;
               |FINSI;

               |SI nSwOk = 0; |HAZ Sirve; |FINSI;

               |LIBERA #104;
               |LIBERA #73;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE Adjudicar;
     #8#5;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Adjudicar;
|FIN;

|PROCESO Sirve0;
     |ABRE #24;
     #24#0 = #104#4;
     |LEE 000#24=;
     |CIERRA #24;
     |ABRE #19;
     #19#0 = #73#2;
     |LEE 000#19=;
     |CIERRA #19;
     |ABRE #17;
     #17#0 = #73#2;
     #17#1 = #73#3;
     |LEE 000#17=;
     |CIERRA #17;

     nUniAdj = #73#5 - #73#43;

     |SI enNumPedido ! 0; |Y #1#16 = "N"; |Y nUniAdj > 0;
          |SI #17#5 < nUniAdj;
               nUniAdj = #17#5;
          |FINSI;
          |SI nUniAdj [ 0; |ACABA; |FINSI;
     |FINSI;

     #8#4 = #104#4;
     #8#5 = #104#8;
     #8#6 = #73#2;
     #8#7 = #73#4;
     #8#10 = nUniAdj;
     #8#11 = #104#7;
     #8#12 = #104#9;
     #8#13 = #104#6;
     #8#16 = eaSerAlb;
     |HAZ Sirve;

     nSwSirve = 1;
|FPRC;

|PROCESO DesadjComple;
     |SI nSwCole = 1;
          |DDEFECTO #107;
          #107#0 = #8#1;
          #107#1 = #8#2;
          #107#2 = #8#3;
          |LEE 000#107=;
          |SI #107#3 = "N"; |ACABA; |FINSI;
     |FINSI;

     |SI #0#44 = "N";
          #7#0 = #8#6;
          #7#1 = #8#17;
          |LEE 101#7=;
          |SI FSalida = 0;
               #7#2 = #7#2 + #8#10;
               |GRABA 020#7a;
          |FINSI;
     |FINSI;
     #8#0 = "N";
     #8#10 = 0;
     |GRABA 020#8a;
     |LIBERA #8;
|FPRC;

|DEFBUCLE DesadjComple;
     #8#1;
     ;
     #104#25, #104#0, 001;
     #104#25, #104#0, 999;
     be;
     NULL, DesadjComple;
|FIN;

|PROCESO CheqCompleto;
     |SI nSwCole = 1;
          |DDEFECTO #107;
          #107#0 = #73#28;
          #107#1 = #73#0;
          #107#2 = #73#1;
          |LEE 000#107=;
          |SI #107#3 = "N"; |ACABA; |FINSI;
     |FINSI;

     nPdte = #73#5 - #73#43;
     #8#1 = #73#28;
     #8#2 = #73#0;
     #8#3 = #73#1;
     |LEE 000#8=;
     |SI FSalida = 0;
          |SI nPdte ! #8#10;
               aComple = "N";
               |ERROR10;
          |FINSI;
     |SINO;
          |SI nPdte > 0;
               aComple = "N";
               |ERROR10;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Chequeo;
     |SI aSerPed ! #16#1; |O nNumPed ! #16#2;
          aSerPed = #16#1;
          nNumPed = #16#2;
          #104#25 = #16#1;
          #104#0 = #16#2;
          |LEE 020#104=;
          #6#0 = #16#1;
          #6#1 = #16#2;
          |LEE 000#6=;
          |SI FSalida = 0;
               |SI #6#3 = "S";
                    aComple = "S";
                    nSwCole = 0;
                    |BUCLELIN 2 CheqCompleto #104;
                    |SI aComple = "N";
                         |BUCLE DesadjComple;
                    |FINSI;
               |FINSI;
               |SI #6#4 = "S";
                    aComple = "S";
                    nSwCole = 1;
                    |BUCLELIN 2 CheqCompleto #104;
                    |SI aComple = "N";
                         |BUCLE DesadjComple;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE Chequeo;
     #16#2;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Chequeo;
|FIN;

|PROCESO Desadj;
     #8#0 = "N";
     |GRABA 020#8a;
     |LIBERA #8;

     #117#19 = nContaAdj;
     #117#1 = #8#1;
     #117#2 = #8#2;
     #117#3 = #8#3;
     |LEE 121#117=;
     |SI FSalida = 0;
          #117#0 = "N";
          #117#23 = "S";
          |GRABA 020#117a;
          |LIBERA #117;
     |FINSI;
|FPRC;

|DEFBUCLE Desadj;
     #8#6;
     ;
     aCli, nDir;
     aCli, nDir;
     be;
     NULL, Desadj;
|FIN;

|PROCESO CheqImpo;
     |SI aCli ! #referen@#4; |O nDir ! #referen@#19;
          |SI aCli ! "";
               |SI nTotNoSer ! 0; |Y nTotSer < #1#21;
                    |BUCLE Desadj;
               |FINSI;
          |FINSI;
          nTotNoSer = 0; nTotSer = 0;
     |FINSI;
     aCli = #referen@#4;
     nDir = #referen@#19;
     |SI #referen@#10 = 0; || Uni. Adj.
          nTotNoSer = nTotNoSer + #referen@#23;
     |SINO;
          |SI #referen@#10 = #referen@#9;   ||  Uni. Adj. = Uni. Ped.
               nTotSer = nTotSer + #referen@#23;
          |SINO;
               nPrecio = #referen@#23 / #referen@#9;
               nTotSer = nTotSer + (#referen@#10 * nPrecio);
               nTotNoSer = nTotNoSer + ((#referen@#9 - #referen@#10) * nPrecio);
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE CheqImpo;
     #referen@#6002;
     ;
     "      ", 0000;
     "zzzzzz", 9999;
     ;
     NULL, CheqImpo;
|FIN;

|PROCESO StockKit;
     aEsKit = "S";
     |DDEFECTO #17;
     #17#0 = #946#3
     #17#1 = #946#4;
     |LEE 000#17=;

     |DDEFECTO #7;
     #7#0 = #946#3;
     #7#1 = #946#4;
     |LEE 101#7=;
     |SI FSalida ! 0; |GRABA 020#7b; |FINSI;

     |SI nSwChecKit = 1;
          nPdteKit = #946#5 * nPdte;
          |SI #6#2 > #1#27;
               |ABRE #coima027;
               |DDEFECTO #coima027;
               #coima027#0 = #946#3;
               #coima027#1 = #946#4;
               |LEE 000#coima027.=;
               |SI FSalida = 0;
                    nStock = #17#5 - #coima027#6 + #7#3;
               |SINO;
                    nStock = #17#5;          || Total;
               |FINSI;
               |CIERRA #coima027;
          |SINO;
               nStock = #17#5;          || Total;
          |FINSI;
          nStock = nStock - #7#2;
          |SI nPdteKit > nStock;
               |SI nStock > 0;
                    nUniAdjKit = nStock / #946#5;
                    |SI nUniAdj > nUniAdjKit;
                         nUniAdj = nUniAdjKit;
                    |FINSI;
               |SINO;
                    nUniAdj = 0;
                    |ERROR10;
               |FINSI;
          |SINO;
               |SI nUniAdj > nPdte;
                    nUniAdj = nPdte;
               |FINSI;
          |FINSI;
     |SINO;
          #7#2 = #7#2 + (nUniAdj * #946#5);
          |GRABA 020#7a;
     |FINSI;
     |SI #6#2 [ #1#27;
          #7#3 = #7#3 + nUniAdj;
     |FINSI;
     |LIBERA #7;
|FPRC;

|DEFBUCLE StockKit;
     #946#1;
     ;
     #73#28, #73#0, #73#1, 001;
     #73#28, #73#0, #73#1, 999;
     ;
     NULL, StockKit;
|FIN;

|PROCESO Ordenado;
     #104#25 = #16#1;
     #104#0 = #16#2;
     |LEE 020#104=;

     |DDEFECTO #24;
     #24#0 = #104#4;
     |LEE 000#24=;

     |DDEFECTO #6;
     #6#0 = #104#25;
     #6#1 = #104#0;
     |LEE 000#6=;

     #73#28 = #16#1;
     #73#0 = #16#2;
     #73#1 = #16#3;
     |LEE 020#73=

     |DDEFECTO #19;
     #19#0 = #73#2;
     |LEE 000#19=;

     |DDEFECTO #17;
     #17#0 = #73#2;
     #17#1 = #73#3;
     |LEE 000#17=;

     nPdte = #73#5 - #73#43;
     |SI nPdte = 0; |ACABA; |FINSI;

     eaTag = "";
     eaCodCliente = #104#4;
     |HAZ SacaRiesgo;
     |SI aRieBloqu = "S"; |ACABA; |FINSI;

     aEsKit = "N";
     aServir = "N";
     |SI #19#137 = "N";
          aServir = "E";
          nUniAdj = nPdte;
     |SINO;
          |SI nPdte < 0;
               aServir = "S";
               nUniAdj = nPdte;
               |DDEFECTO #7;
               #7#0 = #73#2;
               #7#1 = #73#3;
               |LEE 101#7=;
               |SI FSalida ! 0; |GRABA 020#7b; |FINSI;
               #7#2 = #7#2 + nUniAdj;
               |GRABA 020#7a;
               |LIBERA #7;
          |SINO;
               |SI #0#44 = "S";
                    aServir = "S";
                    nUniAdj = nPdte;
               |SINO;
                    nSwChecKit = 1;
                    nUniAdj = nPdte;
                    |BUCLE StockKit;    || Calcula nUniAdj
                    |SI aEsKit = "S";
                         |SI nUniAdj [ 0;
                              aServir = "N";
                         |SINO;
                              aServir = "S";
                              nSwChecKit = 0;
                              |BUCLE StockKit;    || Actualiza tmp stock
                         |FINSI;
                    |SINO;
                         |DDEFECTO #7;
                         #7#0 = #73#2;
                         #7#1 = #73#3;
                         |LEE 101#7=;
                         |SI FSalida ! 0; |GRABA 020#7b; |FINSI;

                         |SI #6#2 > #1#27;
                              |ABRE #coima027;
                              |DDEFECTO #coima027;
                              #coima027#0 = #73#2;
                              #coima027#1 = #73#3;
                              |LEE 000#coima027.=;
                              |SI FSalida = 0;
                                   nStock = #17#5 - #coima027#6 + #7#3;
                              |SINO;
                                   nStock = #17#5;          || Total;
                              |FINSI;
                              |CIERRA #coima027;
                         |SINO;
                              nStock = #17#5;          || Total;
                         |FINSI;
                         nStock = nStock - #7#2;
                         |SI nPdte > nStock;
                              aServir = "N";
                              nUniAdj = 0;
                              |SI nStock > 0;
                                   aServir = "S";
                                   nUniAdj = nStock;
                              |FINSI;
                         |SINO;
                              aServir = "S";
                              nUniAdj = nPdte;
                         |FINSI;
                         #7#2 = #7#2 + nUniAdj;
                         |SI #6#2 [ #1#27;
                              #7#3 = #7#3 + nUniAdj;
                         |FINSI;
                         |GRABA 020#7a;
                         |LIBERA #7;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |DDEFECTO #8;
     #8#0 = aServir;
     #8#1 = #73#28;
     #8#2 = #73#0;
     #8#3 = #73#1;
     #8#4 = #104#4;
     #8#5 = #104#8;
     #8#6 = #73#2;
     #8#7 = #73#4;
     #8#8 = #73#13;
     #8#9 = nPdte;
     #8#10 = nUniAdj;
     |SI #24#25 ! #104#7;
          #8#11 = #104#7;
     |SINO;
          |DDEFECTO #160;
          #160#0 = #19#125;
          |LEE 000#160=;
          |SI #160#1 = 1;
               #8#11 = #24#25;
          |SINO;
               #8#11 = #24#26;
          |FINSI;
     |FINSI;
     #8#12 = #104#9;
     #8#13 = #104#6;
     #8#14 = #6#3;
     #8#15 = "N";
     aAlfa = #24#205; |QBT aAlfa;
     |SI aAlfa = ""; |O aAlfa = "ES";
          aAlfa = #104#59 % 102;
          |SI aAlfa = "35"; |O aAlfa = "38"; |O aAlfa = "51"; |O aAlfa = "52";
               #8#16 = #1#10; ||canaridas
          |SINO;
               #8#16 = #1#9;  ||nacional
          |FINSI;
     |SINO;
          |DDEFECTO #3;
          #3#0 = #104#4;
          #3#1 = #104#57;
          |LEE 000#3=;
          |DDEFECTO #225;
          #225#0 = #3#19;
          |LEE 000#225=;
          |SI #225#2 = "S";
               #8#16 = #1#11; ||intracomu.
          |SINO;
               #8#16 = #1#12;  ||exporta
          |FINSI;
     |FINSI;
     #8#17 = #73#3;
     #8#18 = aEsKit;
     #8#19 = #104#57;
     #8#20 = #104#19;
     #8#21 = #104#14;
     #8#22 = #104#20;
     #8#23 = #73#11;
     #8#24 = "N";
     #8#25 = #104#52;
     |GRABA 020#8n;
|FPRC;

|DEFBUCLE Ordenado;
     #16#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Ordenado;
|FIN;

|PROCESO AlbaImpre;
     |SI #10#90 = "N";
          nImpre = 0;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE AlbaImpre;
     #10#3;
     84;
     #104#4, #0#13, "     ", 000001, #104#57;
     #104#4, #0#13, "zzzzz", 999999, #104#57;
     ;
     NULL, AlbaImpre;
|FIN;

|PROCESO parrilla;
     |SI #0#15 = 0; nSwParri = 1; |ACABA; |FINSI;
     |PARA nAux = 14; |SI nAux [ 42; |HACIENDO nAux = nAux + 2;
          nAux2 = nAux + 1;
          |SI #0#nAux# = #73#28; |Y #0#nAux2# = #73#0;
               nSwParri = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Ordena;
     nSwParri = 0;
     |HAZ parrilla;
     |SI nSwParri = 0; |ERROR; |ACABA; |FINSI;

     |DDEFECTO #107;
     #107#0 = #73#28;
     #107#1 = #73#0;
     #107#2 = #73#1;
     |LEE 000#107=;

     #104#25 = #73#28;
     #104#0 = #73#0;
     |LEE 000#104=;
     |SI FSalida = 0; |Y #104#60 ] #0#51; |Y #104#60 [ #0#52; ||Agencia
               |Y #104#57 ] #0#49; |Y #104#57 [ #0#50;  || Dir Entrega
          #24#0 = #104#4;
          |LEE 000#24=;
          |SI FSalida = 0; |Y #24#3 ] #0#47; |Y #24#3 [ #0#48;
               |DDEFECTO #6;
               #6#0 = #104#25;
               #6#1 = #104#0;
               |LEE 000#6=;
               |SI #0#61 = "S";
                    nImpre = 1;
                    |BUCLE AlbaImpre;
               |SINO;
                    nImpre = 0;
               |FINSI;
               |SI #6#2 ] #0#58; |Y #6#2 [ #0#59; |Y nImpre = 0;
                    aClave = "";
                    aFPed = (#73#13 % 704) + (#73#13 % 402) + (#73#13 % 102);
                    aFEnt = (#104#1 % 704) + (#104#1 % 402) + (#104#1 % 102);
                    |PARA i = 1; |SI i [ 4; |HACIENDO i = i + 1;
                         |SI i = #0#53; aClave = aClave + #6#2; aClave = aClave + #107#4; |FINSI;
                         |SI i = #0#54; aClave = aClave + aFPed;|FINSI;
                         |SI i = #0#55; aClave = aClave + aFEnt;|FINSI;
                         |SI i = #0#56; aClave = aClave + #24#4;|FINSI;
                    |SIGUE;
                    #16#0 = aClave;
                    #16#1 = #73#28;
                    #16#2 = #73#0;
                    #16#3 = #73#1;
                    |GRABA 020#16n;
                    nHay = 1;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE Ordena;
     #73#2;
     28, 15, 3;
     #0#2, #0#4,     0,     0,     0, "  "," ",  #0#0, #0#8,  "N", #0#45;
     #0#3, #0#5, 99.99, 99.99, 99.99, "zz","zz", #0#1, #0#10, "N", #0#46;
     ;
     NULL, Ordena;
|FIN;

|PROCESO PedCliPdte;
     ||SI #104#46 ! 0;
     |SI #104#46 > 1;
          nImpPdte = nImpPdte + #104#46;
          nImpServ = nImpServ + #104#47;
     |FINSI;
|FPRC;

|DEFBUCLE PedCliPdte;
     #104#2;
     ;
     #8#4, "     ", 000001;
     #8#4, "zzzzz", 999999;
     ;
     NULL, PedCliPdte;
|FIN;

|PROCESO CalcuPorte;
     |ABRE #24;
     |SI aSerPed ! #8#1; |O nNumPed ! #8#2;
          aSerPed = #8#1;
          nNumPed = #8#2;
          nImpPdte = 0;
          nImpServ = 0;
          |BUCLE PedCliPdte;
          |SI nImpPdte < #1#13; |Y nImpServ = 0;
               #24#0 = #8#4;
               |LEE 000#24=;
               |SI FSalida = 0; |Y #24#4 = #1#24;
                    aAlfa1 = #24#1;
                    |QBF aAlfa1;
                    aAlfa = "0000SEl cliente " + #24#0 + "-" + aAlfa1 + "no llega al minimo portes,desadjudicar?";
                    |CONFI aAlfa;
                    |SI FSalida = 0;
                         aCli = #8#4;
                         nDir = #8#19;
                         |SALVA_DATOS #8;
                         |ABRE #117;
                         |BUCLE Desadj;
                         |CIERRA #117;
                         |REPON_DATOS #8;
                         |LEE 020#8=;
                    |FINSI;
               |FINSI;
               #8#15 = "S";
               |GRABA 020#8a;
          |FINSI;
     |FINSI;
     |LIBERA #8;
     |CIERRA #24;
|FPRC;

|DEFBUCLE CalcuPorte;
     #8#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, CalcuPorte;
|FIN;

|PROCESO CambiaAdj;
     |SI #8#0 ! "E";
          |SI #8#10 ! 0;
               #8#0 = "S";
          |SINO;
               #8#0 = "N";
          |FINSI;
     |FINSI;
     |GRABA 020#8a;
     |LIBERA #8;
|FPRC;

|DEFBUCLE CambiaAdj;
     #8#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, CambiaAdj;
|FIN;

|PROCESO GrabaTmp;
     #16#1 = #8#1;
     #16#2 = #8#2;
     #16#3 = #8#3;
     |GRABA 020#16n;

     |PARA i = 0; |SI i [ 18; |HACIENDO i = i + 1;
          #117i = #8i;
     |SIGUE;
     #117#19 = nContaAdj;
     #117#20 = fHoy;
     #117#21 = aHora;
     #117#22 = #8#23;
     #117#23 = #8#24;
     |GRABA 020#117n;
|FPRC;

|DEFBUCLE GrabaTmp;
     #8#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, GrabaTmp;
|FIN;

|PROCESO StockKit1;
     |DDEFECTO #17;
     |ABRE #17;
     #17#0 = #946#3;
     #17#1 = #946#4;
     |LEE 000#17=;
     |CIERRA #17;

     |DDEFECTO #7;
     |ABRE #7
     #7#0 = #946#3;
     #7#1 = #946#4;
     |LEE 101#7=;
     |SI FSalida ! 0; |GRABA 020#7b; |FINSI;

     |SI nSwChecKit = 1;
          nStock = #17#5 - #7#2 + (nUniAnt * #946#5);
          nUniAdjKit = #8#10 * #946#5;
          |SI nUniAdjKit > nStock;
               aAlfa = "0000Se superan las unidades componente '" + #7#0;
               |QBF aAlfa;
               aAlfa = aAlfa + "':" + nStock;
               |MENAV aAlfa;
          |FINSI;
     |SINO;
          #7#2 = #7#2 + (#8#10 * #946#5) - (nUniAnt * #946#5);
          |GRABA 020#7a;
     |FINSI;
     |CIERRA #7;
|FPRC;

|DEFBUCLE StockKit1;
     #946#1;
     ;
     #8#1, #8#2, #8#3, 001;
     #8#1, #8#2, #8#3, 999;
     ;
     NULL, StockKit1;
|FIN;

|PROCESO UniAdj7; |TIPO 7;
     nUniAnt = #8#10;
|FPRC;

|PROCESO UniAdj0; |TIPO 0;
     |SI #8#9 < 0;
          |SI #8#10 < #8#9;
               |MENAV "0000No se puede superar las unidades pendientes...";
               |ERROR;
          |FINSI;
          |ACABA;
     |FINSI;

     |SI #8#10 > #8#9;
          |MENAV "0000No se puede superar las unidades pendientes...";
          |ERROR;
     |SINO;
          |SI #0#44 = "S"; |ACABA; |FINSI;
          |SI #8#0 = "E"; |ACABA; |FINSI;

          |SI #8#18 = "S";
               aAlfa = "";
               nSwChecKit = 1;
               |BUCLE StockKit1;
               |SI aAlfa ! "";
                    |SI #1#16 = "S";
                         |CONFI "0000NVa a servir sin stock, seguro?";
                         |SI FSalida = 0;
                              nSwChecKit = 0;
                              |BUCLE StockKit1;
                         |SINO;
                              |ERROR;
                         |FINSI;
                    |SINO;
                         |ERROR;
                    |FINSI;
               |SINO;
                    nSwChecKit = 0;
                    |BUCLE StockKit1;
               |FINSI;
          |SINO;
               |DDEFECTO #17;
               |ABRE #17;
               #17#0 = #8#6;
               #17#1 = #8#17;
               |LEE 000#17=;
               |CIERRA #17;

               |DDEFECTO #7;
               |ABRE #7
               #7#0 = #8#6;
               #7#1 = #8#17;
               |LEE 101#7=;
               |SI FSalida ! 0; |GRABA 020#7b; |FINSI;
               nStock = #17#5 - #7#2 + nUniAnt;
               |SI #8#10 > nStock;
                    |SI #1#16 = "S";
                         |CONFI "0000NVa a servir sin stock, seguro?";
                         |SI FSalida = 0;
                              #7#2 = #7#2 + #8#10 - nUniAnt;
                              |GRABA 020#7a;
                         |SINO;
                              |ERROR;
                         |FINSI;
                    |SINO;
                         aAlfa = "0000Se superan las unidades de stock:" + nStock;
                         |MENAV aAlfa;
                         |ERROR;
                    |FINSI;
               |SINO;
                    #7#2 = #7#2 + #8#10 - nUniAnt;
                    |GRABA 020#7a;
               |FINSI;
               |CIERRA #7;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CogeValor; |TIPO 7;
     |SI nClave = 0; aValor = #8#2; |FINSI;
     |SI nClave = 1; aValor = #8#4; |FINSI;
     |SI nClave = 2; aValor = #8#6; |FINSI;
|FPRC;

|PROCESO Tecla; |TIPO 0;
     |SI nClave = 0; aAlfa = #8#2; |FINSI;
     |SI nClave = 1; aAlfa = #8#4; |FINSI;
     |SI nClave = 2; aAlfa = #8#6; |FINSI;

     |SI FSalida = 0; |Y aAlfa = aValor; |Y aDj ! "T";
          |ENCAMPO #10#8;
          |SI FSalida = 0;
               |GRABA 020#8a;
          |SINO;
               |LEE 000#8=;
          |FINSI;
          |PINTA #8#10;
     |FINSI;
|FPRC;

|PROCESO Min8;
     |SI aDj = "T";
          #8#0 = " ";
     |SINO;
          #8#0 = aDj;
     |FINSI;
     #8#1 = "     ";
     #8#2 = 1;
     #8#3 = 1;
     #8#4 = "      ";
     #8#6 = "                    ";
|FPRC;

|PROCESO Max8;
     |SI aDj = "T";
          #8#0 = "z";
     |SINO;
          #8#0 = aDj;
     |FINSI;
     #8#1 = "zzzzz";
     #8#2 = 999999;
     #8#3 = 999;
     #8#4 = "zzzzzz";
     #8#6 = "zzzzzzzzzzzzzzzzzzzz";
|FPRC;

|PROCESO CamClave; |TIPO 11;
     |SI FSalida = 13;
          nClave = (nClave + 1) $ 3;
          |PTEC 807;
     |FINSI;
|FPRC;

|PROCESO adjuped; |TIPO 3;
     |ABRET #71;
     |ABRET #10;
     |SI enNumPedido ! 0;
          |ABRE #104;
          #104#25 = eaSerPedido;
          #104#0 = enNumPedido;
          |LEE 101#104=;
          |SI FSalida = 0;
               |SI eaFecAlb ! ""; #0#13 = eaFecAlb; |FINSI;
               nSwSirve = 0;
               |BUCLELIN 0 Sirve0 #104;
               |SI nSwSirve = 1;
                    |HAZ FinAdju;
                    eaSerAlb = #10#52;
                    enNumAlb = #10#0;
               |SINO;
                    |MENAV "0000No se ha servido ninguna linea...";
               |FINSI;
          |FINSI;
          |CIERRA #104;
     |SINO;
          |HAZ CreaTempo; |NOME_DAT #16 Tempo; |DELINDEX #16; aTmp16 = Tempo;
          |HAZ CreaTempo; |NOME_DAT #7 Tempo; |DELINDEX #7; aTmp7 = Tempo;
          |HAZ CreaTempo; |NOME_DAT #8 Tempo; |DELINDEX #8; aTmp8 = Tempo;
          nHay = 0;
          |ABRE #6;
          |ABRE #16;
          |ABRE #24;
          |ABRE #104;
          |BUCLE Ordena;
          |CIERRA #104;
          |CIERRA #24;
          |CIERRA #16;
          |CIERRA #6;
          |SI nHay = 0;
               |MENAV "0000Selección vacia...";
          |SINO;
               |ABRE #3;
               |ABRE #6;
               |ABRE #7;
               |ABRET #8;
               |ABRE #17;
               |ABRE #19;
               |ABRE #73;
               |ABRE #104;
               |ABRE #225;
               |ABRE #24;
               |ABRE #160;
               |ABRE #107;
               |BUCLE Ordenado;
               |CIERRA #107;
               |CIERRA #160;
               |ABRE #107;
               aSerPed = ""; nNumPed = "";
               |BUCLE Chequeo;
               |CIERRA #107;
               |CIERRA #24;
               |CIERRA #225;
               |CIERRA #104;
               |CIERRA #73;
               |CIERRA #19;
               |CIERRA #17;
               |CIERRAT #8;
               |CIERRA #7;
               |CIERRA #6;
               |CIERRA #3;
               |PINPA #0#8;
               aDj = "T";
               |MENSA "0000Pulse <ESC> para continuar...";
               |ENTLINEAL #2#8, 2, 4, 19, 0, Min8, Max8;
               |PARA; |SI; |HACIENDO;
                    |MENSA "0000Elija la opcion...";
                    |MENU aMenu;
                    aMenu2 = FSalida;
                    |BUCLE CambiaAdj;
                    |SI aMenu2 = 1; |O aMenu2 = 5; |SAL; |FINSI;
                    |SI aMenu2 = 2; aDj = "S"; |FINSI;
                    |SI aMenu2 = 3; aDj = "N"; |FINSI;
                    |SI aMenu2 = 4; aDj = "E"; |FINSI;
                    |MENSA "0000Pulse <ENTER> para modificar unidades,  <F5> Cambia clave";
                    |ATRI R;
                    |SI aDj = "S"; |PINTA 537, "(A adjudicar)   "; |FINSI;
                    |SI aDj = "N"; |PINTA 537, "(Sin adjudicar) "; |FINSI;
                    |SI aDj = "E"; |PINTA 537, "(Especiales)    "; |FINSI;
                    |PARA; |SI; |HACIENDO;
                         |SI nClave = 0;
                              nClaveAnt = nClave;
                              |C_M #8#1, 1, "N";
                              |C_M #8#2, 1, "S";
                              |C_M #8#4, 1, "N";
                              |C_M #8#6, 1, "N";
                              |ENTLINEAL #2#8, 3, 4, 19, 0, Min8, Max8;
                         |FINSI;
                         |SI nClave = 1;
                              nClaveAnt = nClave;
                              |C_M #8#1, 1, "N";
                              |C_M #8#2, 1, "N";
                              |C_M #8#4, 1, "S";
                              |C_M #8#6, 1, "N";
                              |ENTLINEAL #3#8, 2, 4, 19, 0, Min8, Max8;
                         |FINSI;
                         |SI nClave = 2;
                              nClaveAnt = nClave;
                              |C_M #8#1, 1, "N";
                              |C_M #8#2, 1, "N";
                              |C_M #8#4, 1, "N";
                              |C_M #8#6, 1, "S";
                              |ENTLINEAL #4#8, 2, 4, 19, 0, Min8, Max8;
                         |FINSI;
                         |SI nClaveAnt = nClave; |SAL; |FINSI;
                    |SIGUE;
               |SIGUE;
               |SI aMenu2 = 1;
                    |MENSA "0000Adjudicando...";

                    |DELINDEX #16;
                    |ABRE #16;
                    |ABRE #117;
                    |LEE 000#117u;
                    nContaAdj = #117#19 + 1;
                    |HORA aHora;
                    fHoy = ~;
                    |BUCLE GrabaTmp;
                    |CIERRA #117;
                    |CIERRA #16;

                    |ABRE #107;
                    |ABRE #104;
                    |ABRE #8;
                    |ABRE #6;
                    |ABRE #7;
                    aSerPed = ""; nNumPed = "";
                    |BUCLE Chequeo;
                    |CIERRA #7;
                    |CIERRA #6;
                    |CIERRA #8;
                    |CIERRA #104;
                    |CIERRA #107;

                    |SI #0#60 = "S";
                         |ABRE #117;
                         nDir = 0; aCli = "";
                         |DDEF aAlfa; aAlfa = aAlfa + "coimw008";
                         |CARGA_DEF aAlfa, referen@;
                         |SI FSalida = 0;
                              |NOME_DAT #referen@#aTmp8#;
                              |BUCLE CheqImpo;
                              |DESCARGA_DEF #referen@;
                         |FINSI;
                         |SI aCli ! "";
                              |SI nTotNoSer ! 0; |Y nTotSer < #1#21;
                                   |BUCLE Desadj;
                              |FINSI;
                         |FINSI;
                         |CIERRA #117;
                    |FINSI;

                    aSerPed = ""; nNumPed = "";
                    |SI #0#61 = "N";
                         |BUCLE CalcuPorte;
                    |FINSI;

                    |ABRE #104;
                    |ABRE #73;
                    |BUCLE CalcuNoAdj;
                    |CIERRA #73;
                    |CIERRA #104;
                    aCli = ""; nImp = 0;
                    nImpServ = 0;
                    |BUCLE CheqMinPdte;

                    |ABRET #104;
                    |ABRET #73;
                    |ABRE #6;
                    nDir = 0; aCli = "";
                    |BUCLE Adjudicar;
                    |SI aCli ! "";
                         |HAZ FinAdju;
                    |FINSI;
                    |CIERRA #6;
                    |CIERRAT #73;
                    |CIERRAT #104;
               |FINSI;
          |FINSI;
          Tempo = aTmp16; |HAZ BoraTempo; |DELINDEX #16;
          Tempo = aTmp7; |HAZ BoraTempo; |DELINDEX #7;
          Tempo = aTmp8; |HAZ BoraTempo; |DELINDEX #8;
     |FINSI;
     |CIERRAT #10;
     |CIERRAT #71;
|FPRC;

|PROCESO cierre; |TIPO 0;
     efFec = #0#13;
     enAlma = 0;
     |HAZ MiraHisT;
     |SI enErrHis ! 0;
          |ERROR;
          |ACABA;
     |FINSI;
|FPRC;

|PROCESO NormalizaFecha; |TIPO 7;
     |SI #0#4 = "01.01.0001";
          fFecha = ~;
          aFecha = fFecha;
          aAny = aFecha % -104;
          |QBF aAny;
          aFecha = "01.01." + aAny;
          #0#4 = aFecha;
          |PINTA #0#4;
     |FINSI;
     |SI #142#185 = "S"; #0#9 = #142#188; |FINSI;
|FPRC;

|PROGRAMA;
     |ABRE #0;
     |LEE 101#0p;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;

     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     |ABRE #1; |LEE 000#1p; |CIERRA #1;

     |SI enNumPedido = 0;
          |SI #142#246 = "N";
               |MENAV "0000No se permite la adj. automatica de pedidos a albaranes";
          |SINO;
               |PINPA #0#0;
               |PINDA #0#0;
               |ENDATOS #1#0;
               |SI FSalida = 0;
                    |GRABA 020#0a;
               |FINSI;
          |FINSI;
     |SINO;
          |HAZ adjuped;
     |FINSI;

     |CIERRA #0;
|FPRO;
