|FICHEROS;
     tagzavis #0;
     tagmpara #1;
     tagmpalm #2;
|FIN;

|VARIABLES;
     aPath       = "";
     aDirFich    = "";
     aFichero    = "";
     aAlfa       = "";
     aPalm       = "";
     aLong       = "";
     aCaracter   = "";
     aHora       = "";

     fFecha      = @;

     nLong       = 0;
     nPos        = 0;
     nCaracter   = 0;

     {5} dstray = "";

     aIP = "";
     aDSCorreo = "";
     aProxy = "";
     aDirOri = "";
     aDirDes = "";
     aTitulo = "";
     aTexto = "";
|FIN;

|PROCESO EnviaCorreo;
     |SI #1#9 = "F"; aDSCorreo = #1#8;             |FINSI;
     |SI #1#9 = "L"; aDSCorreo = ""; |IP_REMOTO aDSCorreo; |FINSI;
     |SI #1#9 = "S"; aDSCorreo = ""; |IP_LOCAL  aDSCorreo; |FINSI;
     |QBF aDSCorreo;
     aProxy = #1#10; |QBF aProxy;
     aDirOri = #1#11; |QBF aDirOri;
     aDirDes = #0#2; |QBF aDirDes;
     aTitulo = dstray4 + " USUARIO:" + #0#0 + " " + dstray5;
     aTexto = aTitulo;
     aFichero = "vacio.txt";
     |SI aDirDes ! "";
          |DSCORREO_ENVIA aDSCorreo, aProxy, aDirOri, aDirDes, aTitulo, aTexto, aFichero;
          |SI FSalida ! 0;
               aAlfa = "0000Problemas al enviar correo, Usuariuo: "
               |MENAV aAlfa;
          |SINO;
               ||MENAV "0000Envio correo completado.";
          |FINSI;
     |FINSI;
     aDirDes = #0#3; |QBF aDirDes;
     |SI aDirDes ! "";
          |DSCORREO_ENVIA aDSCorreo, aProxy, aDirOri, aDirDes, aTitulo, aTexto, aFichero;
          |SI FSalida ! 0;
               aAlfa = "0000Problemas al enviar correo. Usuario:" + #0#0;
               |MENAV aAlfa;
          |SINO;
               ||MENAV "0000Envio correo completado.";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO tagzavis;
     fFecha  = ~;
     |HORA aHora;

     dstray1 = "0";
     dstray2 = #0#0;  |QBF dstray2;
     dstray3 = "2";
     dstray4 = "HAN ENTRADO " + #0#1 + " PEDIDOS DE LOS PDA.";
     dstray5 = "FECHA: " + fFecha + " HORA: " + aHora;

||     |ESPECIFICA "DSTRAY", dstray;

     |HAZ EnviaCorreo;
|FPRC;

|DEFBUCLE tagzavis;
     #0#1;
     ;
     "          ";
     "zzzzzzzzzz";
     ;
     NULL, tagzavis;
|FIN;

|PROGRAMA;
     |ABRE #1; |LEE 000#1p; |CIERRA #1;

     aFichero = ("av" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #0 aFichero;
     |DELINDEX #0;

     |ABRE #0;
     |ABRE #2;

     aPath     = #1#3;  |QBF aPath;
     aDirFich = aPath + "dslineas_*.txt";

     |_PDIR aDirFich;
     |PARA; |SI FSalida ] 0; |HACIENDO;
            aAlfa  = aDirFich - ".txt";
            aAlfa  = aAlfa - aPath;
            aAlfa  = aAlfa - "dslineas_";
            aLong  = aAlfa % 0;
            nLong  = aLong;
            aPalm  = "";
            |PARA nCaracter = 1;  |SI nCaracter [ nLong;  |HACIENDO nCaracter = nCaracter + 1;
                  nPos      = (100 * nCaracter) + 1;
                  aCaracter = aAlfa % nPos;
                  |SI aCaracter ! "_";
                      aPalm = aPalm + aCaracter;
                  |SINO;
                      |SAL;
                  |FINSI;
            |SIGUE;

            #2#0 = aPalm;
            |LEE 000#2=;
            |SI FSalida = 0;
                #0#0 = #2#2;
                |LEE 101#0=;
                |SI FSalida ! 0;
                    |DDEFECTO #0;
                    #0#0 = #2#2;
                    |GRABA 020#0b;
                |FINSI;
                #0#1 = #0#1 + 1;
                #0#2 = #2#3;
                #0#3 = #2#4;
                |GRABA 020#0a;
                |LIBERA #0;
            |FINSI;

            |_SDIR aDirFich;
     |SIGUE;
     |CIERRA #0;
     |CIERRA #2;

     |BUCLE tagzavis;

     |DELINDEX #0;
|FPRO;
