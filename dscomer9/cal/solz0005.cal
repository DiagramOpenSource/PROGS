|FICHEROS;
     solz0005 #0;
     solm0001 #1;
     solm0002 #2;
     solm0003 #3;
     solm0005 #5;
     agifa091 #6;
     agifa007 #7;
     solm0008 #8;
     solm0009 #9;
     solm0010 #10;
     solm0014 #14;
     solm0016 #16;
     dsz99984 #11;
     solm0013 #13;
     agifa133 #17;  || vencimientos de facturas
     solm0018 #18;
     agifa024 #24;
     dsm00053 #53;
     agifa069 #69;
     agifa084 #84;
     agifa177 #99;
     agifa142 #142;
     agifa041 #41;
|FIN;

|VARIABLES;
     &enSwDA = 0;
     nPos = 0;
     aPos = 0;
     aPath = "";
     &serie = "";
     &numero = 0;
     &reimpr = "";
     &eaReimp = "";
     &eaSerie = "";
     &enNumFac = 0;
     aDes = "";
     &eaProg = "";
     &enDirEnt = 0;
     nRecibo = 0;
     nVto = 0;
     {1}aBase = "";
     aFic = "";
     aAlfa = "";
     &venci1 = @;
     &venci2 = @;
     &venci3 = @;
     &venci4 = @;
     &venci5 = @;
     &venci6 = @;
     &venci7 = @;
     &venci8 = @;
     &venci9 = @;
     &venci10 = @;
     &venci11 = @;
     &venci12 = @;

     &impor1 = 0;
     &impor2 = 0;
     &impor3 = 0;
     &impor4 = 0;
     &impor5 = 0;
     &impor6 = 0;
     &impor7 = 0;
     &impor8 = 0;
     &impor9 = 0;
     &impor10 = 0;
     &impor11 = 0;
     &impor12 = 0;
     &iva1 = 0;
     &iva2 = 0;
     &iva3 = 0;
     &iva4 = 0;
     &iva5 = 0;
     &re1 = 0;
     &re2 = 0;
     &re3 = 0;
     &re4 = 0;
     &re5 = 0;
     &codigo="";
     &descrip="";
     &precio=0;
     &dto=0;
     &dto1=0;
     &unid=0;
     &imptot=0;
     &tiva=0;
     nSw = 0;
     aIP = "";
     aServidor = "";
     aFrom = "";
     aTo = "";
     aSubject = "";
     aMensaje = "";
     aDjunto = "";
     aDirDestino = "";
|FIN;
----------------------------------
|PROCESO LeeFicManteLin;    || Restaura los path
     |DFICE aPath;
     aAlfa = aPath;
     |PATH_DAT #1 aAlfa;
     |PATH_DAT #2 aAlfa;
     |PATH_DAT #3 aAlfa;
     |PATH_DAT #5 aAlfa;
     |DDEFECTO #1;
     |DDEFECTO #2;
     |DDEFECTO #3;
     |DDEFECTO #5;
     |ABRE #1;
     |ABRE #2;
     |ABRE #3;
     |ABRE #5;
     |SELECT #4#5;
     #5#12 = #84#48;
     #5#13 = #84#0;
     #5#18 = #69#1;
     |LEE 000#5=;
     |SI FSalida = 0;
          |SELECT #2#3;
          #3#3 = #5#2;
          #3#0 = #5#0;
          #3#1 = #5#1;
          |LEE 000#3=;
          |SI FSalida = 0;
               #2#0 = #3#0;
               #2#1 = #3#1;
               |LEE 000#2=;
               |SI FSalida = 0;
                    #1#0 = #2#0;
                    |LEE 000#1=;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #5;
     |CIERRA #3;
     |CIERRA #2;
     |CIERRA #1;
|FPRC;

|PROCESO LeeFicAutoLin; || en el campo curso esta la empresa de la forma "Emp:00000"
     aAlfa = #84#87 % 505; |QBF aAlfa;
     |SI aAlfa = ""; |ACABA; |FINSI;
     |DBASE aPath;
     aPath = aPath + "fich/";
     aAlfa = aPath + aAlfa + "/";
     |PATH_DAT #1 aAlfa;
     |PATH_DAT #2 aAlfa;
     |PATH_DAT #3 aAlfa;
     |PATH_DAT #5 aAlfa;
     |DDEFECTO #1;
     |DDEFECTO #2;
     |DDEFECTO #3;
     |DDEFECTO #5;
     |ABRE #1;
     |ABRE #2;
     |ABRE #3;
     |ABRE #5;
     |SELECT #5#5;
     #5#15 = #84#48;
     #5#16 = #84#0;
     #5#19 = #69#1;
     |LEE 000#5=;
     |SI FSalida = 0;
          |SELECT #2#3;
          #3#3 = #5#2;
          #3#0 = #5#0;
          #3#1 = #5#1;
          |LEE 000#3=;
          |SI FSalida = 0;
               #2#0 = #3#0;
               #2#1 = #3#1;
               |LEE 000#2=;
               |SI FSalida = 0;
                    #1#0 = #2#0;
                    |LEE 000#1=;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #5;
     |CIERRA #3;
     |CIERRA #2;
     |CIERRA #1;
|FPRC;
----------------------------------
|PROCESO LeeFicMante;    || Restaura los path
     |DFICE aPath;
     aAlfa = aPath;
     |PATH_DAT #1 aAlfa;
     |PATH_DAT #2 aAlfa;
     |PATH_DAT #3 aAlfa;
     |PATH_DAT #5 aAlfa;
     |DDEFECTO #1;
     |DDEFECTO #2;
     |DDEFECTO #3;
     |DDEFECTO #5;
     |ABRE #1;
     |ABRE #2;
     |ABRE #3;
     |ABRE #5;
     |SELECT #4#5;
     #5#12 = #84#48;
     #5#13 = #84#0;
     #5#18 = 0;
     |LEE 000#5];
     |SI FSalida = 0; |Y #5#12 = #84#48; |Y #5#13 = #84#0;
          |SELECT #2#3;
          #3#3 = #5#2;
          #3#0 = #5#0;
          #3#1 = #5#1;
          |LEE 000#3=;
          |SI FSalida = 0;
               #2#0 = #3#0;
               #2#1 = #3#1;
               |LEE 000#2=;
               |SI FSalida = 0;
                    #1#0 = #2#0;
                    |LEE 000#1=;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #5;
     |CIERRA #3;
     |CIERRA #2;
     |CIERRA #1;
|FPRC;

|PROCESO LeeFicAuto; || en el campo curso esta la empresa de la forma "Emp:00000"
     aAlfa = #84#87 % 505; |QBF aAlfa;
     |SI aAlfa = ""; |ACABA; |FINSI;
     |DBASE aPath;
     aPath = aPath + "fich/";
     aAlfa = aPath + aAlfa + "/";
     |PATH_DAT #1 aAlfa;
     |PATH_DAT #2 aAlfa;
     |PATH_DAT #3 aAlfa;
     |PATH_DAT #5 aAlfa;
     |DDEFECTO #1;
     |DDEFECTO #2;
     |DDEFECTO #3;
     |DDEFECTO #5;
     |ABRE #1;
     |ABRE #2;
     |ABRE #3;
     |ABRE #5;
     |SELECT #5#5;
     #5#15 = #84#48;
     #5#16 = #84#0;
     #5#19 = 0;
     |LEE 000#5];
     |SI FSalida = 0; |Y #5#15 = #84#48; |Y #5#16 = #84#0;
          |SELECT #2#3;
          #3#3 = #5#2;
          #3#0 = #5#0;
          #3#1 = #5#1;
          |LEE 000#3=;
          |SI FSalida = 0;
               #2#0 = #3#0;
               #2#1 = #3#1;
               |LEE 000#2=;
               |SI FSalida = 0;
                    #1#0 = #2#0;
                    |LEE 000#1=;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #5;
     |CIERRA #3;
     |CIERRA #2;
     |CIERRA #1;
|FPRC;

|PROCESO LeeFicCto;
     |ABRE #9;
     |ABRE #10;
     |SELECT #3#10;
     #10#7 = #84#48;
     #10#8 = #84#0;
     |LEE 000#10=;
     |SI FSalida = 0;
          #9#0 = #10#0;
          #9#1 = #10#1;
          |LEE 000#9=;
     |FINSI;
     |CIERRA #10;
     |CIERRA #9;
|FPRC;

|PROCESO DirCopia;
     |ABRE #18;
     #18#0 = #24#0;
     #18#1 = 1;
     |LEE 000#18];
     |PARA; |SI FSalida = 0; |Y #18#0 = #24#0; |HACIENDO;
          |SI aDirDestino = "";
               aDirDestino = #18#3;
               |QBF aDirDestino;
          |SINO;
               aDirDestino = aDirDestino + ";" + #18#3;
               |QBF aDirDestino;
          |FINSI;
          |LEE 000#18s;
     |SIGUE;
     |CIERRA #18;
|FPRC;

|PROCESO EnviaCorreo;
     |IP_REMOTO aIP;
     |SI aIP ! "";
          |DFICE aDes;
          aDes = aDes + "factura.pdf";
          |RECIBE_FICHERO aFic, aDes;
          |SI FSalida ! 0;
               aAlfa = "Factura:" + #84#48 + "/" + (("000000" + #84#0) % -106);
               aAlfa = "0000Error al recibir el pdf del servidor, " + aAlfa;
               |MENAV aAlfa; |ACABA;
          |FINSI;
          aFic = aDes;
     |FINSI;

     aDirDestino = #24#197; |QBF aDirDestino;
     |HAZ DirCopia;
     |SI aDirDestino = "";
          aAlfa = "0000Email no informado en el cliente:" + #24#0;
          |MENAV aAlfa; |ACABA;
     |FINSI;

     aIP = "xdscorreo.dv.diagram.net";
     aServidor = "asmtp.diagram.es";
     aIP = #13#1; |QBF aIP;
     aServidor = #13#2; |QBF aServidor;

     aFrom = #41#21; |QBF aFrom;
     |SI aFrom = "";
          |MENAV "0000Email no informado en el acceso empresas";
          |ACABA;
     |FINSI;

     aTo = aDirDestino;
     aSubject = "Factura nº:" + #84#48 + "/" + (("000000" + #84#0) % -106);
     aMensaje = aSubject; || "$$$$" + aFic;
     aDjunto = aFic;
     |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
     |SI FSalida < 0;
          aAlfa = "Factura nº " + #84#48 + "/" + (("000000" + #84#0) % -106);
          aAlfa = "0000Error al enviar correo:" + &13 + aAlfa;
          |MENAV aAlfa;
     |SINO;
          |ABRE #8;
          #8#0 = #84#48;
          #8#1 = #84#0;
          |LEE 101#8=;
          |SI FSalida = 0;
               #8#2 = #84#3;
               #8#3 = #84#1;
               #8#5 = ~;
               |GRABA 020#8a;
          |SINO;
               #8#2 = #84#3;
               #8#3 = #84#1;
               #8#4 = ~;
               #8#5 = ~;
               |GRABA 020#8n;
          |FINSI;
          |CIERRA #8;
     |FINSI;
     |FBORRA aFic;
|FPRC;

|PROCESO crearec;
     |ABRE #17;
     #17#0 = #84#0;
     #17#4 = #84#48;
     #17#1 = 0;
     |LEE 001#17];
     nVto = 0;
     |SI FSalida ! 0; |O #17#0 ! #84#0;  |O #17#4 ! #84#48;
         |HAZ VenciDir;
     |FINSI;

     |ABRE #99;
     nVto = 0;
     #17#0 = #84#0;
     #17#4 = #84#48;
     #17#1 = 0;
     |LEE 001#17];
     |PARA ; |SI FSalida = 0; |Y #17#0 = #84#0;|Y #17#4 = #84#48; |HACIENDO;
          nVto = nVto + 1;
          |LEE 001#17s;
     |SIGUE;

     |HAZ AbreRecVenta;

     nRecibo = 0;
     #17#0 = #84#0;
     #17#4 = #84#48;
     #17#1 = 0;
     |LEE 001#17];
     |PARA ; |SI FSalida = 0; |Y #17#0 = #84#0;|Y #17#4 = #84#48; |HACIENDO;
          |DDEFECTO #11;
          #11#17 = #84#48;
          #11#0  = #84#0;
          #11#1  = #17#1;           || Linea;
          #11#2  = #84#3;            || cliente
          #11#3  = #84#4;            || nombre del cliente
          #11#4  = #24#29;           || Banco
          #11#5  = "S";             || domiciliado
          #11#6  = "N";             || aceptado
          #11#7  = #84#1;            || fecha de emision
          #11#8  = #17#3;           || Fecha de vencimiento
          #11#9  = #17#2;           || Importe
          #11#10 = "N";            || Impreso
          #11#11 = "N";            || Contabilizado
          #11#12 = #84#40;

          |ABRE #6;
          |DDEFECTO #6;
          #6#0 = #84#8;
          |LEE 000#6=;
          |CIERRA #6;

          |SI #142#63 = "S";
               #99#0 = #6#69;
               |LEE 000#99=;
               |SI FSalida = 0;
                    #11#12 = #99#3;     || NUMERO CTA.CONTABLE.
               |SINO;
                    #11#12 = #84#40;     || NUMERO CTA.CONTABLE.
               |FINSI;
          |SINO;
               #11#12 = #84#40;          || NUMERO CTA.CONTABLE.
          |FINSI;
          #11#13 = "N";            || Cobrado
          #11#14 = "N";            || Impagado
          #11#15 = #24#161;         || A aceptar
          #11#16 = "01.01.0000";   || fecha de cobro
          #11#18 = #84#40;          || Cta
          #11#21 = #6#69;          || Tipo de Recibo (forma de pago)
          nRecibo = nRecibo + 1;
          |SI nRecibo = nVto; |Y #6#70 ! 0;
               #11#21 = #6#73;     || Tipo de Recibo (Fianza retenida)
          |FINSI;
          #11#22 = "Pdte. Cobro";
          #11#23 = nVto;
          #11#24 = #6#0;
          #11#25 = #6#1;

          #11#26 = "";
          #11#27 = "";
          #11#29 = "";
          #11#28 = "";

          eaProg = "agifa084";
          |HAZ RecVenta;
          |LEE 001#17s;
     |SIGUE;
     |CIERRA #17;
     |CIERRA #99;
     enDirEnt = #agifa084#91; |HAZ CierraRecVenta;
|FPRC;

|PROCESO DesAmpli;
     |DDEFECTO #2;
     #69#3 = 0;      || Almacen
     #69#4 = #53#5;
     descrip = #69#4;
     codigo  = "";
     dto     = "";
     dto1    = "";
     precio  = "";
     unid    = "";
     imptot  = "";
     tiva    = "";
     enSwDA = 1;
     |PRINT;
     enSwDA = 0;
|FPRC;

|DEFBUCLE DesAmpli;
     #53#1;
     ;
     "F", #69#20, #69#0, #69#1, 0001;
     "F", #69#20, #69#0, #69#1, 9999;
     ;
     NULL, DesAmpli;
|FIN;

|PROCESO agifa069;
     codigo  = #69#2;
     descrip = #69#4;
     dto     = #69#8;
     dto1    = #69#21;
     precio  = #69#6;
     unid    = #69#5;
     imptot  = #69#27;
     tiva    = #69#11;

     aAlfa = #84#95; |QBF aAlfa;
     |SI aAlfa = "MANTENIMIENTO";
          |HAZ LeeFicManteLin;
     |FINSI;
     |SI aAlfa = "AUTOFACTURA";
          |HAZ LeeFicAutoLin;
     |FINSI;

     |DDEFECTO #16;
     |ABRE #16; |SELECT #2#16;
     #16#7 = #84#48;
     #16#8 = #84#0;
     |LEE 000#16=;
     |SI FSalida = 0;
          |ABRE #14;
          #14#0 = #16#0;
          #14#1 = #16#1;
          |LEE 000#14=;
          |CIERRA #14;
     |FINSI;
     |CIERRA #16;


     |PRINT;
     |SALVA_DATOS #69;
     |BUCLE DesAmpli;
     |REPON_DATOS #69;
|FPRC;


|PROCESO agifa084;
     aAlfa = #84#95; |QBF aAlfa;
     |SI aAlfa = "MANTENIMIENTO";
          |SI #0#13 ! 1; |ERROR; |ACABA; |FINSI;
          |HAZ LeeFicMante;
     |FINSI;
     |SI aAlfa = "AUTOFACTURA";
          |SI #0#13 ! 2; |ERROR; |ACABA; |FINSI;
          |HAZ LeeFicAuto;
     |FINSI;
     |SI aAlfa = "CONTRATO";
          |SI #0#13 ! 3; |ERROR; |ACABA; |FINSI;
          |HAZ LeeFicCto;
     |FINSI;

     |DDEFECTO #24;
     #24#0 = #84#3;
     |LEE 000#24=;

     |SI #0#8 = "M"; |Y #0#14 = "C";
          |SI #24#112 ! "S"; |ERROR; |ACABA; |FINSI;
     |FINSI;

     |SI #0#8 = "P"; |Y #0#14 = "C";
          |SI #24#112 ! "N"; |ERROR; |ACABA; |FINSI;
     |FINSI;

     |SI #0#9 ! #84#10; |ERROR; |ACABA; |FINSI;

     |SI #0#8 = "M";
          aIP = "";
          |IP_REMOTO aIP;
          |SI aIP = "";
               |DBASE aFic;
               aFic = aFic + "crystal/";
               |MKDIR aFic;
               aFic = aFic + "factura.pdf";
               |FBORRA aFic;
          |SINO;
               |ESPECIFICA "RBASS", aBase;
               aFic = aBase1 + "crystal/";
               |RMKDIR aFic;
               aFic = aFic + "factura.pdf";
               |RFBORRA aFic;
          |FINSI;
          Impresora = "CrystalReport;" + aFic;
          |IMPRE -1;
          |SI FSalida ! 0;
               |MENAV "0000Error al abrir la impresora...";
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     |DDEFECTO #7;
     #7#26 = #84#48;
     |LEE 000#7=;

     aAlfa = #7#11; |QBF aAlfa;

     |INFOR aAlfa;
     |SI FSalida ! 0;
          aAlfa = "0000Error en informe" + aAlfa;
          |MENAV aAlfa;
          |ERROR; |ACABA;
     |FINSI;

     |DDEFECTO #6;
     |ABRE #6;
     #6#0 = #84#8;
     |LEE 000#6=;
     |CIERRA #6;

     |ABRE #17;
     |DDEFECTO #17;
     #17#4 = #84#48;
     #17#0 = #84#0;
     #17#1 = 0;
     |LEE 001#17];
     |PARA ; |SI FSalida = 0; |Y #17#0 = #84#0;|Y #17#4 = #84#48; |HACIENDO;
          |SI #6#70 ! 0; || Fianza Retenida, es el ultimo recibo
               |SALVA_FICHA #17;
               |LEE 000#17s;
               |SI FSalida ! 0; |O #17#0 ! #84#0; |O #17#4 ! #84#48;
                    |REPON_FICHA #17;
                    #0#11 = #17#2;
                    #0#12 = #17#3;
                    |SAL;
               |FINSI;
               |REPON_FICHA #17;
          |FINSI;
          nSw = nSw + 1;
          |SI nSw = 1;
               venci1 = #17#3;
               impor1 = #17#2;
          |FINSI;
          |SI nSw = 2;
               venci2 = #17#3;
               impor2 = #17#2;
          |FINSI;
          |SI nSw = 3;
               venci3 = #17#3;
               impor3 = #17#2;
          |FINSI;
          |SI nSw = 4;
               venci4 = #17#3;
               impor4 = #17#2;
          |FINSI;
          |SI nSw = 5;
               venci5 = #17#3;
               impor5 = #17#2;
          |FINSI;
          |SI nSw = 6;
               venci6 = #17#3;
               impor6 = #17#2;
          |FINSI;
          |SI nSw = 7;
               venci7 = #17#3;
               impor7 = #17#2;
          |FINSI;
          |SI nSw = 8;
               venci8 = #17#3;
               impor8 = #17#2;
          |FINSI;
          |SI nSw = 9;
               venci9 = #17#3;
               impor9 = #17#2;
          |FINSI;
          |SI nSw = 10;
               venci10= #17#3;
               impor10= #17#2;
          |FINSI;
          |SI nSw = 11;
               venci11= #17#3;
               impor11= #17#2;
          |FINSI;
          |SI nSw = 12;
               venci12= #17#3;
               impor12= #17#2;
          |FINSI;
          |LEE 001#17s;
     |SIGUE;
     |CIERRA #17;
|FPRC;

|PROCESO agifa084Fin;
     |SI #84#10 = AN; |Y #142#47 = "S"; |Y #0#9 = "N";
          |SI #142#146 ! "N"; |O #84#73 ! 0;
               |HAZ crearec;
          |FINSI;
     |FINSI;
     |PIEINF;
     |FININF;
     |SI #0#8 = "M";
          |FINIMP;
          |HAZ EnviaCorreo;
     |FINSI;
     #84#10 = "S";
     |GRABA 020#84a;
     |LIBERA #84;
|FPRC;

|DEFBUCLE agifa084;
     #84#1;
     3, 1, 10;
     #0#2, #0#4, #0#0, #0#6, #0#9;
     #0#3, #0#5, #0#1, #0#7, #0#9;
     be;
     NULL, agifa084, agifa069, agifa084Fin;
|FIN;

|PROCESO Tipo; |TIPO 0;
     |SI #0#8 = "P"; |O #0#8 = "M";
          |C_M #0#9, 1, "S";
     |SINO;
          |C_M #0#9, 1, "N";
          #0#9 = "S"; |PINTA #0#9;
     |FINSI;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |SI #0#8 ! "M"
          Impresora = "Crystal Reports";
          |IMPRE 5;
          |SI FSalida ! 0; |ACABA; |FINSI;
     |FINSI;

     |ABRE #7;
     |ABRE #24;
     |BUCLE agifa084;
     |CIERRA #24;
     |CIERRA #7;

     |SI #0#8 ! "M";
          |FINIMP;
     |FINSI;
|FPRC;

|PROGRAMA;
     |ABRE #13; |LEE 000#13p; |CIERRA #13;

     |DBASE aAlfa;
     aAlfa = aAlfa + "fich/";
     |PATH_DAT #41 aAlfa;
     |DFICE aAlfa;
     aAlfa = aAlfa % -205;
     |ABRE #41;
     #41#0 = aAlfa;
     |LEE 000#41=;
     |CIERRA #41;

     |SI numero ! 0;
          #0#2 = serie;
          #0#3 = serie;
          #0#4 = numero;
          #0#5 = numero;
          #0#6 = "01.01.0000";
          #0#7 = "31.12.9999";
          #0#8 = "P";

          |ABRE #84;
          #84#48 = serie;
          #84#0 = numero;
          |LEE 000#84=;
          |CIERRA #84;

          aAlfa = #84#95; |QBF aAlfa;
          |SI aAlfa = "MANTENIMIENTO";
               #0#13 = 1;
          |FINSI;
          |SI aAlfa = "AUTOFACTURA";
               #0#13 = 2;
          |FINSI;
          |SI aAlfa = "CONTRATO";
               #0#13 = 3;
          |FINSI;
          #0#9 = #84#10;

          |HAZ Tipo3;
          |ACABA;
     |FINSI;

     |SI enNumFac ! 0;        || Llama solm0008
          #0#2 = eaSerie;
          #0#3 = eaSerie;
          #0#4 = enNumFac;
          #0#5 = enNumFac;
          #0#6 = "01.01.0000";
          #0#7 = "31.12.9999";
          #0#8 = "M";
          #0#9 = "S"
          |HAZ Tipo3;
     |SINO;
          |MANTE #0;
     |FINSI;
|FPRO;
