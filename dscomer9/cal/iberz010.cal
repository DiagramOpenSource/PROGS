|FICHEROS;
     iberz010 #0;
     agitp001 #1;
     dsm00241 #241;
     dsm00237 #237;
     agifa080@ #800;
     agifa019 #19;
     agifa065 #65;
     agifa077 #77;
     agifa080 #80;
     agifa112 #112;
     agifa048 #480;
     agifa010 #10;
     agifa071 #71;
     agifa501 #501;
     agifa502 #502;
     agifa084 #84;
     agifa069 #69;
     agifa142 #142;
     agifa321;
     agifa324;
|FIN;

|VARIABLES;
     &nDeci_PreDiv = 0;
     nFactor   = 0;
     &eaUsar   = "";
     &eaSer    = "";
     &enNum    = 0;
     &enLin    = 0;
     aParam    = "";
     aDef      = "";
     nSwPromo  = 0;
     nMargen   = 0;
     nCanti    = 0;
     nError    = 0;
     nCoste    = 0;
     nSwRecal  = 0;
     nPPort1   = 0;
     nPPort2   = 0;
     nImpDiv    = 0;
     &nDeci_Base = 0;
     &nDeci_PreBase = 0;
|FIN;
--------------------------------------------------------------
|PROCESO Cero;
     nMargen = 0;
|FPRC;

|PROCESO Margen501;
     |SI #502#7 ] 0;
          nError = 1;
     |SINO;
          nError = -1;
          #502#7 = -#502#7;
     |FINSI;
     nCanti = #502#7 < #501#17;
     nCanti = nCanti < #501#19;
     |SI #agifa142#115 = "S";
          nCanti = nCanti < #501#18;
     |FINSI;
     nCanti = nCanti * nError;
     nMargen = nMargen + (nCanti - nCoste);
     #502#7  = #502#7  * nError;
|FPRC;

|PROCESO Margen10;
     |SI #71#9 ] 0;
          nError = 1;
     |SINO;
          nError = -1;
          #71#9  = -#71#9;
     |FINSI;
     nCanti = #71#9 < #10#5;
     nCanti = nCanti < #10#32;
     |SI #agifa142#115 = "S";
          nCanti = nCanti < #10#7;
     |FINSI;
     nCanti = nCanti * nError;
     nMargen = nMargen + (nCanti - nCoste);
     #71#9  = #71#9 * nError;
|FPRC;

|PROCESO Margen84;
     |SI #69#9 ] 0;
          nError = 1;
     |SINO;
          nError = -1;
          #69#9  = -#69#9;
     |FINSI;
     nCanti = #69#9 < #69#5;
     nCanti = nCanti < #69#32;
     |SI #agifa142#115 = "S";
          nCanti = nCanti < #69#7;
     |FINSI;
     nCanti = nCanti * nError;
     nMargen = nMargen + (nCanti - nCoste);
     #69#9  = #69#9 * nError;
|FPRC;

|PROCESO agifa069;
     #19#0 = #69#2;
     |LEE 000#19=;
     |SI FSalida = 0;
          nCoste = #19#9 * #69#5;
          #69#14 = nCoste;
          |GRABA 020#69a;
          |LIBERA #69;
          |HAZ Margen84;
     |FINSI;
|FPRC;

|PROCESO agifa084;
     #84#37 = nMargen;
     |GRABA 020#84a;
     |LIBERA #84;
|FPRC;

|DEFBUCLE agifa084;
     #84#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, Cero, agifa069, agifa084;
|FIN;
--------------------------------------------------------------
|PROCESO agifa071;
     #19#0 = #71#2;
     |LEE 000#19=;
     |SI FSalida = 0;
          nCoste = #19#9 * #71#5;
          #71#14 = nCoste;
          |GRABA 020#71a;
          |LIBERA #71;
          |HAZ Margen10;
     |FINSI;
|FPRC;

|PROCESO agifa010;
     #10#37 = nMargen;
     |GRABA 020#10a;
     |LIBERA #10;
|FPRC;

|DEFBUCLE agifa010;
     #10#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, Cero, agifa071, agifa010;
|FIN;
--------------------------------------------------------------
|PROCESO agifa502;
     #19#0 = #502#2;
     |LEE 000#19=;
     |SI FSalida = 0;
          nCoste = #19#9 * #502#5;
          #502#23 = nCoste;
          |GRABA 020#502a;
          |LIBERA #502;
          |HAZ Margen501;
     |FINSI;
|FPRC;

|PROCESO agifa501;
     #501#8 = nMargen;
     |GRABA 020#501a;
     |LIBERA #501;
|FPRC;

|DEFBUCLE agifa502_0;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, agifa502;
|FIN;

|PROCESO El501;
     |HAZ Cero;
     |BUCLE agifa502_0;
     |HAZ agifa501;
|FPRC;

|DEFBUCLE agifa501;
     #501#1;
     ;
     INICIO;
     FINAL;
     be;
||     NULL, Cero,  agifa502, agifa501;
     NULL, El501;
|FIN;
--------------------------------------------------------------
|PROCESO agifa048;
     #19#0 = #480#0;
     |LEE 101#19=;
     |SI FSalida = 0;
          #480#11 = #19#9;
          |GRABA 020#480a;
          |LIBERA #480;
     |FINSI;
|FPRC;

|DEFBUCLE agifa048;
     #480#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, agifa048;
|FIN;

|PROCESO MiraPromo;
     nSwPromo = 0;
     #800#27 = #80#27;
     #800#0 = #80#0;
     #800#1 = 0;
     |LEE 000#800];
     |PARA; |SI FSalida = 0; |Y #800#27 = #80#27; |Y #800#0 = #80#0; |HACIENDO;
          |SI #800#2 = #80#2; |Y #800#1 ! #80#1;
               |SI #80#30 ! 0;
                    nSwPromo = 1;
                    |SAL;
               |FINSI;
          |FINSI;
          |LEE 000#800s;
     |SIGUE;
|FPRC;

|PROCESO Factor;
     |SI #19#204 = "N";
          nFactor = 1;
     |SINO;
          #241#0 = #19#5;
          #241#2 = #80#43;
          |LEE 000#241=;
          |SI FSalida ! 0; |DDEFECTO #241; |FINSI;
          |SI #241#6 = "D";
              nFactor = 1 * #241#5;
          |SINO;
              nFactor = 1 / #241#5;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Historico;
     #65#0 = #80#2;
     #65#1 = #77#1;
     #65#2 = "AC";
     #65#3 = #80#0;
     #65#4 = #80#1;
     #65#11 = #80#27;
     |LEE 101#65=;
     |SI FSalida = 0;
          #65#9 = #80#6;
          #65#12 = #80#8;
          #65#13 = #80#26;
          #65#14 = ((((#65#9 < #80#8) < #80#26) < #77#5) < #77#32);
          |GRABA 020#65a;
          |LIBERA #65;
     |FINSI;
|FPRC;

|PROCESO agifa080;
     |SI #80#30 = 0;
          |HAZ MiraPromo;
          |SI nSwPromo = 0;
               #19#0 = #80#2;
               |LEE 000#19=;
               |SI FSalida = 0;
                    |HAZ Factor;
                    #237#7 = #77#3;
                    #237#2 = #19#0;
                    |LEE 000#237=;
                    |SI FSalida = 0;
                         #80#30 = #237#4;
                         #80#6 = #237#4;
                         #80#32 = #237#4;
                         #80#8 = #237#6;
                    |SINO;
                         #1#7 = #77#3;
                         #1#2 =  #19#0;
                         |LEE 000#1=;
                         |SI FSalida = 0;
                              #80#30 = #1#4;
                              #80#6 = #1#4;
                              #80#32 = #1#4;
                              #80#8 = #1#6;
                         |SINO;
                              |SI #19#28 = 0;
                                   #80#30 = #19#9;
                                   #80#6 = #19#9;
                                   #80#32 = #19#9;
                              |SINO;
                                   #80#30 = #19#28;
                                   #80#6 = #19#28;
                                   #80#32 = #19#28;
                              |FINSI;
                              #80#8 = #19#29;
                              #80#26 = #19#129;
                              #80#45 = #19#209;
                         |FINSI;
                    |FINSI;
                    #80#30 = #80#30 * nFactor;
                    #80#6 = #80#6 * nFactor;
                    #80#32 = #80#32 * nFactor;
                    |HAZ Historico;

                    |HAZ TotalLin80;
                    |GRABA 020#80a;
                    |LIBERA #80;
               |FINSI;
          |FINSI;
     |FINSI;
     |HAZ CalCabAgifa077;
     |GRABA 020#80a;
     |LIBERA #80;
|FPRC;

|PROCESO agifa077;
     |HAZ LimCabAgifa077;
|FPRC;

|PROCESO Fin80;
     |GRABA 020#77a;
     |LIBERA #77;
|FPRC;

|DEFBUCLE agifa077;
     #77#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, agifa077, agifa080, Fin80;
|FIN;
----------------------------------------------------------------------
|PROCESO CorrigeAC;
     |SI #65#2 = "AC";
          #77#50 = #65#11;
          #77#0 = #65#3;
          |LEE 000#77=;
          |SI FSalida = 0;
               |SI  #65#1 ! #77#1;
                    |BORRA 020#65a;
                    #65#1 = #77#1;
                    |GRABA 040#65n;
               |FINSI;
          |SINO;
               |BORRA 020#65a;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE CorrigeAC;
     #65#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, CorrigeAC;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |SI #0#0 = "S";
          |DDEF aDef;
          aDef = aDef + "agifa080";
          |CARGA_DEF aDef, agifa080@;
          |SI FSalida = 0;
               |ABRE #77;
               |BUCLE CorrigeAC;  || Corrige la Fecha del Hist. de los
               |CIERRA #77;       || Alba. Compra
               |ABRE #241; |SELECT #2#241;
               |ABRE #237; |SELECT #2#237;
               |ABRE #1; |SELECT #2#1;
               |ABRE #800;
               |ABRE #19;
               |ABRET #112;
               |ABRE #77;
               |ABRE #65;
               |BUCLE agifa077;
               |CIERRA #65;
               |CIERRA #77;
               |CIERRAT #112;
               |CIERRA #19;
               |CIERRA #800;
               |CIERRA #1;
               |CIERRA #237;
               |CIERRA #241;
               |DESCARGA_DEF #agifa080@;
          |SINO;
               aDef = "0000Error al Cargar " + aDef;
               |MENAV aDef;
          |FINSI;
     |FINSI;

     |SI #0#1 = "S";
          eaUsar = #0#2;
          |SUB_EJECUTA_NP "dsz00015;iber";  || PCM

          |ABRE #19;
          |BUCLE agifa048;
          |CIERRA #19;

          |SUB_EJECUTA_NP "agifa044;auto";  || Recal Escan.
/*
ESTO YA LO HACE "dsz00015"

          |ABRE #19;
          |BUCLE agifa010;
          |BUCLE agifa501;
          |BUCLE agifa084;
          |CIERRA #19;
*/
     |FINSI;
|FPRC;

|PROCESO Decimales;
     |ABRE #agifa324;
     |ABRE #agifa321;
     |LEE 000#agifa321.p;
     #agifa324#0 = #agifa321#9; ||Igualo a moneda base
     |LEE 001#agifa324.=;
     |CIERRA #agifa321;
     |CIERRA #agifa324;
     nDeci_Base = #agifa324#7;  ||Decimales moneda base
     nDeci_PreBase = #agifa324#9;  ||Decimales precio de moneda base
|FPRC;

|DEFBUCLE agifa502;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, agifa502;
|FIN;

|PROGRAMA;
     |HAZ Decimales;

     aParam = PARAMETRO; |QBF aParam;
     |SI aParam = "";
          |MANTE #0;
     |SINO;
          |DDEF aDef;
          aDef = aDef + "agifa080";
          |CARGA_DEF aDef, agifa080@;
          |SI FSalida = 0;
               |ABRE #241; |SELECT #2#241;
               |ABRE #237; |SELECT #2#237;
               |ABRE #1; |SELECT #2#1;
               |ABRE #800;
               |ABRE #19;
               |ABRET #112;
               |ABRE #77;
               |ABRE #65;
               |ABRE #19;
               |SI aParam = "77";
                    |ABRE #77;
                    #77#50 = eaSer;
                    #77#0 = enNum;
                    |LEE 101#77=;
                    |SI FSalida = 0;
                         |HAZ agifa077;
                         |BUCLELIN 2 agifa080 #77;
                         |HAZ Fin80;
                    |FINSI;
                    |CIERRA #77;
               |FINSI;
               |SI aParam = "501";
                    |ABRE #501;
                    #501#36 = eaSer;
                    #501#0 = enNum;
                    |LEE 101#501=;
                    |SI FSalida = 0;
                         |HAZ Cero;
                         |||BUCLELIN 2 agifa502 #501;
                         |BUCLE agifa502;
                         |HAZ agifa501;
                    |FINSI;
                    |CIERRA #501;
               |FINSI;
               |SI aParam = "10";
                    |ABRE #10;
                    #10#52 = eaSer;
                    #10#0 = enNum;
                    |LEE 101#10=;
                    |SI FSalida = 0;
                         |HAZ Cero;
                         |BUCLELIN 2 agifa071 #10;
                         |HAZ agifa010;
                    |FINSI;
                    |CIERRA #10;
               |FINSI;
               |SI aParam = "84";
                    |ABRE #84;
                    #84#48 = eaSer;
                    #84#0 = enNum;
                    |LEE 101#84=;
                    |SI FSalida = 0;
                         |HAZ Cero;
                         |BUCLELIN 2 agifa069 #84;
                         |HAZ agifa084;
                    |FINSI;
                    |CIERRA #84;
               |FINSI;
               |CIERRA #800;
               |CIERRA #19;
               |CIERRA #112;
               |CIERRA #77;
               |CIERRA #65;
               |CIERRA #19;
               |CIERRA #1;
               |CIERRA #237;
               |CIERRA #241;
               |DESCARGA_DEF #agifa080@;
          |FINSI;
     |FINSI;
|FPRO;
