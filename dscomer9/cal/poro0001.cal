|FICHEROS;
     poro0001 #0;

     porconrp #1;
     porconrl #2;
     poro0002 #3,MANTE; || temporal lineas

     poro0003 #4;       || Temporal Dir. Entrega
     dsm00003 #5;       || Dir ent.

     agifa134 #10; || facturas C
     agifa059 #11; || facturas L
     agifa010 #12; || albaran C
     agifa071 #13; || albaran L

     agifa019 #19; || articulos
     agifa024 #24;
     agifa084 #84;
     agifa142 #142;
     agifa501 #501;
|FIN;

|VARIABLES;
     &Tempo = "";
     aTmp3 = "";
     aTmp4 = "";
     &EURODB = 0;
     aPath = "";
     fFecha = @;
     aCadena1 = "";
     nMes = 0;
     nCual = 0;
     aAlfa1 = "";
     i = 0;
     canti = 0;
     nImpo = 0;
     nDir  = 0;
     nCompra = 0;
     nAbono  = 0;
     beta = 0;
     nDto = 0;
     imneto = 0;
|FIN;
_________________________________________ PANTALLA
|PROCESO FamiliaSi; |TIPO 0;
     |SI #0#1="S";
          |CAMPO_MODIFICA #0#2,1,"N";
          #0#2="";
          |PINTA #0#2;
     |SINO;
          |CAMPO_MODIFICA #0#2,1,"S";
     |FINSI;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO Acumula;
     |DDEFECTO #5;
     #5#0 = #24#0;
     #5#1 = nDir;
     |LEE 000#5=;

     |DDEFECTO #4;
     #4#0 = #24#0;
     #4#1 = nDir;
     |LEE 000#4=;
     |SI FSalida ! 0;
          |PARA i = 0; |SI i [ 15; |HACIENDO i = i + 1;
               #4i = #5i;
          |SIGUE;
          |GRABA 020#4b;
     |FINSI;
     |SI nCual = 1;
          #4#18 = #4#18 + nCompra;
          #4#19 = #4#19 + nAbono;
     |SINO;
          #4#16 = #4#16 + nCompra;
          #4#17 = #4#17 + nAbono;
     |FINSI;
     |GRABA 020#4a;
     |LIBERA #4;
     nCompra = 0;
     nAbono = 0;
|FPRC;

|PROCESO agifa059;
     #12#52 = #11#15;
     #12#0 = #11#2;
     |LEE 000#12=;
     |SI FSalida = 0;
          canti = #12#15 - #12#25;
          canti = canti ! EURODB;
          |SI #142#115 = "N";
               nImpo = (canti * 100) / (100 - #12#33);
          |SINO;
               nImpo = canti;
          |FINSI;
          |SI #12#15 < 0; |O #12#43 = "S";
               |SI #12#15 < 0;
                    nAbono = -canti;
               |SINO;
                    nAbono = canti;
               |FINSI;
          |SINO;
               nCompra = nImpo;
          |FINSI;
          nDir = #12#84;
          |HAZ Acumula;
     |FINSI;
|FPRC;

|DEFBUCLE agifa134;
     #10#3;
     ;
     #24#0, "01.01.0000", "     ", 000001;
     #24#0, "31.12.9999", "zzzzz", 999999;
     ;
     NULL, NULL, agifa059;
|FIN;

|PROCESO agifa084;
     canti  = #84#15 - #84#25;
     |SI #142#115 = "N";
          nCompra = (canti * 100) / (100 - #84#7);
     |SINO;
          nCompra = canti;
     |FINSI;
     nDir = 1;
     |HAZ Acumula;
|FPRC;

|DEFBUCLE agifa084;
     #84#3;
     ;
     #24#0, "01.01.0000", "     ", 000001;
     #24#0, "31.12.9999", "zzzzz", 999999;
     ;
     NULL, agifa084;
|FIN;

|PROCESO agifa501;
     |SI #501#3 > 0; beta = 1; |SINO; beta = -1; |FINSI;
     #501#3 = #501#3 * beta;
     nDto = (((#501#3 < #501#17) < #501#19) < #501#18) * beta;
     #501#3 = #501#3 * beta;
     nDto = #501#3 - nDto;   || Total Dto Cabecera
     imneto = #501#3 - nDto;
     |SI #142#115 = "N";
          nCompra = (imneto * 100) / (100 - #501#18);
     |SINO;
          nCompra = imneto;
     |FINSI;
     nDir = 1;
     |HAZ Acumula;
|FPRC;

|DEFBUCLE agifa501;
     #501#3;
     ;
     "01.01.0000", #24#0, "     ", "     ", 000001;
     "31.12.9999", #24#0, "zzzzz", "zzzzz", 999999;
     ;
     NULL, agifa501;
|FIN;

|PROCESO agifa024;
     #5#0 = #24#0;
     #5#1 = 0;
     |LEE 000#5];
     |SI FSalida = 0; |Y #5#0 = #24#0;
          |LEE 000#5s;
          |SI FSalida = 0; |Y #5#0 = #24#0;
               |BUCLE agifa501;
               |BUCLE agifa084;
               |BUCLE agifa134;
          |SINO;
               nDir = #5#1;
               nCompra = #24#102;
               nAbono = #24#151;
               |HAZ Acumula;
          |FINSI;
     |SINO;
          nDir = #5#1;
          nCompra = #24#102;
          nAbono = #24#151;
          |HAZ Acumula;
     |FINSI;
|FPRC;

|DEFBUCLE agifa024;
     #24#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, agifa024;
|FIN;
_________________________________________ ACUMULADOS
|PROCESO PAlbLineasActual;
     #19#0 = #13#2;
     |LEE 000#19=;
     |SI FSalida = 0;
          |SI #19#2 = #0#2;|O #0#1 = "S";    || si las familias coinciden
               aCadena1 = #10#1;             || fecha para coger el mes
               aCadena1 = aCadena1 % 402;
               nMes = aCadena1;

               |DDEFECTO #3;
               #3#13 = nCual;
               #3#0 = #19#2;
               |LEE 101#3=;
               |SI FSalida ! 0;    |GRABA 020#3b; |FINSI;
               #3nMes = #3nMes + #13#7;
               |GRABA 020#3a;
               |LIBERA #3;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO PAlbaranesLineas;   || la llegada es igual, pero lo que se hace no
     |HAZ PAlbLineasActual;
|FPRC;

|DEFBUCLE BAlbaranesLineas;
     #13#1;
     ;
     #12#52,#12#0,1;
     #12#52,#12#0,999;
     ;
     NULL,PAlbaranesLineas;
|FIN;

|PROCESO PAlbaranes;
     |BUCLE BAlbaranesLineas;
|FPRC;

|DEFBUCLE BAlbaranes;
     #12#1;
     ;
     #11#15,#11#2;
     #11#15,#11#2;
     ;
     NULL,PAlbaranes;
|FIN;

|PROCESO PFacturasLineas;
     |BUCLE BAlbaranes;
|FPRC;

|DEFBUCLE BFacturasLineas;
     #11#1;
     ;
     #10#49, #10#0, 1;
     #10#49, #10#0, 999;
     ;
     NULL, PFacturasLineas;
|FIN;

|PROCESO PFacturas;
     |BUCLE BFacturasLineas;
|FPRC;

|DEFBUCLE BFacturas;
     #10#1;
     7;
     "  ", 000001, #0#0;
     "zz", 999999, #0#0;
     ;
     NULL, PFacturas;
|FIN;

|PROCESO Factura;
     |DELINDEX #3;
     |DELINDEX #4;
     |ABRE #4;
     |ABRET #3;
     |ABRET #19;

     nCual = 1;
     |BUCLE BFacturas;
     |ABRE #5;
     |ABRE #12;

     |BUCLE agifa024;
     |CIERRA #5;
     |CIERRA #12;

     |DBASE aPath;  |QBF aPath;
     aPath = aPath + "fich/" + #1#3 + "/";
     |MKDIR aPath;
     |SI FSalida = 0;         || quiere decir que la empresa no existe
          |RMDIR aPath;
     |SINO;
          |PATH_DAT #10 aPath;
          |PATH_DAT #11 aPath;
          |PATH_DAT #12 aPath;
          |PATH_DAT #13 aPath;
          |PATH_DAT #501 aPath;
          |PATH_DAT #84 aPath;
          |PATH_DAT #5 aPath;
          nCual = 2;
          |BUCLE BFacturas;
          |ABRE #5;
          |ABRE #12;
          |BUCLE agifa024;
          |CIERRA #5;
          |CIERRA #12;
     |FINSI;

     |CIERRAT #3;
     |CIERRAT #19;
     |CIERRA #4;
|FPRC;

_________________________________________ PRESENTACION
|PROCESO Objetivos;
     |SI #0#1 = "N";
          |SI #2#1 ! #0#2;
               |ACABA;
          |FINSI;
     |FINSI;

     #0#27 = #0#27 + #2#2;
     #0#28 = #0#28 + #2#3;
     #0#29 = #0#29 + #2#4;
     #0#30 = #0#30 + #2#5;
     #0#31 = #0#31 + #2#6;
     #0#32 = #0#32 + #2#7;
     #0#33 = #0#33 + #2#8;
     #0#34 = #0#34 + #2#9;
     #0#35 = #0#35 + #2#10;
     #0#36 = #0#36 + #2#11;
     #0#37 = #0#37 + #2#12;
     #0#38 = #0#38 + #2#13;
|FPRC;

|DEFBUCLE Objetivos;
     #2#1;
     ;
     #1#0, "   ";
     #1#0, "zzz";
     ;
     NULL, Objetivos;
|FIN;

|PROCESO Temporal;
     |SI #0#1 = "N";
          |SI #3#0 ! #0#2;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI #3#13 = 1;      || empresa actual
          #0#3 = #0#3 + #3#1;
          #0#4 = #0#4 + #3#2;
          #0#5 = #0#5 + #3#3;
          #0#6 = #0#6 + #3#4;
          #0#7 = #0#7 + #3#5;
          #0#8 = #0#8 + #3#6;
          #0#9 = #0#9 + #3#7;
          #0#10 = #0#10 + #3#8;
          #0#11 = #0#11 + #3#9;
          #0#12 = #0#12 + #3#10;
          #0#13 = #0#13 + #3#11;
          #0#14 = #0#14 + #3#12;
     |FINSI;

     |SI #3#13 = 2;      || empresa anterior
          #0#15 = #0#15 + #3#1;
          #0#16 = #0#16 + #3#2;
          #0#17 = #0#17 + #3#3;
          #0#18 = #0#18 + #3#4;
          #0#19 = #0#19 + #3#5;
          #0#20 = #0#20 + #3#6;
          #0#21 = #0#21 + #3#7;
          #0#22 = #0#22 + #3#8;
          #0#23 = #0#23 + #3#9;
          #0#24 = #0#24 + #3#10;
          #0#25 = #0#25 + #3#11;
          #0#26 = #0#26 + #3#12;
     |FINSI;
|FPRC;

|DEFBUCLE Temporal;
     #3#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Temporal;
|FIN;

|PROCESO Presenta;
     |BUCLE Temporal;
     |BUCLE Objetivos;

     |PINDA #0#0;
     |AVISO;
     |PAUSA;
|FPRC;

|PROGRAMA;
     |HAZ CreaTempo; aTmp3 = Tempo; |NOME_DAT #3 Tempo; |DELINDEX #3;
     |HAZ CreaTempo; aTmp4 = Tempo; |NOME_DAT #4 Tempo; |DELINDEX #4;

     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |ABRE #1;
     |LEE 000#1p;
     #0#0 = #1#0;
     |CIERRA #1;
     |SI PARAMETRO = "";
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
          |SI FSalida = 0;
               |HAZ Presenta; || solo presenta el temporal
          |FINSI;
     |SINO;
          #0#1 = "S";
          |HAZ Factura;       || solo crea el temporal
     |FINSI;

     Tempo = aTmp3; |HAZ BoraTempo; |DELINDEX #3;
     Tempo = aTmp4; |HAZ BoraTempo; |DELINDEX #4;

|FPRO;
