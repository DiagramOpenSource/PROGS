|FICHEROS;
     gocercap #0;
     gocerlip #1;
     gocerhip #2;
     gopre003 #3;
     gocerhis #4;
     gocerlin #5;
     gopre001 #9;
     gopre002 #10;
     guerw036 #36,MANTE;
     gomedive #20;
     gocermed #30,MANTE; || Mediciones
     goparame #100;
     guerw066;
     guerw067;
     gopre021;
|FIN;
-------------------------------------------------------------------------------
|VARIABLES;
     nBotCopia = 0;
     nError = 0;
     &Tempo = "";
     nAgrup = 0;
     aDesAgrup = "";
     nNume = 0;
     &nDeci_Medi = 0;
     &nDeci_Meda = 0;
     aAlfa = "";
     nTotaMedi = 0;
     nTotaImpo = 0;
     &aTipCer       = "";
     &cCodMonBase   = "";
     &cDesMonBase   = "";
     &cCodMonTrab   = "";
     &cDesMonTrab   = "";

     &nDeci_PBase   = 0;
     &nDeci_TBase   = 0;
     &nDeci_PTrab   = 0;
     &nDeci_TTrab   = 0;
     &nDeci_TotVis  = 0;
     &nEurComTrab   = 0;
     &nEurComBase   = 0;
     &nEurVenTrab   = 0;
     &nEurVenBase   = 0;

     nLinea         = 0;
     nModo          = 0;
     nHay           = 0;
     nTipo          = 0;
     nPorcien       = 0;
     nImporte       = 0;
     nBotAmpli      = 0;
     nBotMedi       = 0;

     cPartida       = "";
     cDesc          = "";
     cCapitulo      = "";

|FIN;
-------------------------------------------------------------------------------
|PROCESO MiPar;
     #3#0 = #2#0;
     #3#1 = #2#1;
     #3#2 = #2#14;
     #3#4 = " " * 20;
|FPRC;

|PROCESO MaPar;
     #3#0 = #2#0;
     #3#1 = #2#1;
     #3#2 = #2#14;
     #3#4 = "z" * 20;
|FPRC;

|PROCESO MiCap;
     #10#0 = #2#0;
     #10#1 = #2#1;
     #10#12 = " " * 20;
|FPRC;

|PROCESO MaCap;
     #10#0 = #2#0;
     #10#1 = #2#1;
     #10#12 = "z" * 20;
|FPRC;

|PROCESO RelPar; |TIPO 0;
     |SI FSalida = 10;   ||F2
          |HAZ ConsultaParti;
/*
          |ABRE #10;
          |ABRE #3;
          |SELECT #6#10;
          #10#0 = #2#0;
          #10#1 = #2#1;
          #10#12 = #2#14;
          |LEE 000#10];
          |CONSULTA_F_CLAVE #6#10, MiCap, MaCap;
          |SI FSalida ! 0;
               |ERROR; |ACABA;
          |SINO;
               #2#14 = #10#12;

               |SELECT #2#3;
               #3#0 = #2#0;
               #3#1 = #2#1;
               #3#2 = #2#14
               #3#4 = #2#4;
               |LEE 000#3];
               |CONSULTA_F_CLAVE #2#3, MiPar, MaPar;
               |SI FSalida = 0;
                    #2#4 = #3#4;                       ||Partida.
                    #2#14 = #3#2;                      ||Capitulo.
                    #2#15 = #1#3;                      ||Fecha.
               |SINO;
                    |ERROR; |ACABA;
               |FINSI;
          |FINSI;
          |CIERRA #3;
          |CIERRA #10;
*/
     |FINSI;

     |SI #2#4 = "                    ";
          |ERROR;
          |ACABA;
     |FINSI;

     |ABRE #3;
     |SELECT #2#3;
     #3#0 = #1#0;                                 ||Serie Pre.
     #3#1 = #1#1;                                 ||Numero Pre.
     #3#2 = #2#14;                                ||Capitulo.
     #3#4 = #2#4;                                 ||Partida.
     |LEE 000#3=;

     |SI FSalida ! 0;
          |MENAV "0000LA PARTIDA NO EXISTE EN EL PRESUSPUESTO";
          |ERROR;
          |ACABA;
     |FINSI;

     |SI #2#4 ! Contenido;

          |SALVA_FICHA #2;
          |SELECT #2#2;
          |LEE 000#2=;

          |SI FSalida = 0;
               |MENAV "0000LA PARTIDA YA ESTA INCLUIDA EN LA CERTIFICACION";
               nHay = 1;
          |SINO;
               nHay = 0;
          |FINSI;

          |SELECT #1#2;
          |REPON_FICHA #2;

          |SI nHay = 1;
               |ERROR;
               |ACABA;
          |FINSI;

          #2#5  = #3#5;                           ||Descripcion.
          #2#18 = #3#7;                           ||Cantidad Pres.
          #2#8  = #3#8;                           ||Precio Venta.
          #2#9  = #3#10;                          ||Importe Partida.
          #2#11 = #3#20;                          ||Pendiente Cerif.
    |FINSI;

     #2#14 = #3#2;                                ||Capitulo.
     #2#15 = #1#3;                                ||Fecha.

     |PINTA 2270, #3#23;
     |PINTA 2370, #3#24;
     |PINTA #2#4;  |PINTA #2#5; |PINTA #2#18;

     |CIERRA #3;
     |HAZ BHCer;

|FPRC;
-------------------------------------------------------------------------------
|PROCESO PinPen; |TIPO 7;
     |ABRE #3;
     |SELECT #2#3;
     #3#0 = #2#0;                                 ||Serie Pres.
     #3#1 = #2#1;                                 ||N.Presupuesto
     #3#2 = #2#14;
     #3#4 = #2#4;                                 ||Partida.
     |LEE 000#3=;

     |SI FSalida = 0;
          #2#9  = #3#10;
          #2#11 = #3#20;
          |PINTA 2270, #3#23;
          |PINTA 2370, #3#24;
     |FINSI;

     |CIERRA #3;

     |SI aTipCer = "M";
          |C_M #2#10 , 1 , "N";
          |C_M #2#12 , 1 , "N";
          |C_M #2#20 , 1 , "S";
     |FINSI;
     |SI aTipCer = "I";
          |C_M #2#10 , 1 , "S";
          |C_M #2#12 , 1 , "N";
          |C_M #2#20 , 1 , "N";
     |FINSI;
     |SI aTipCer = "P";
          |C_M #2#10 , 1 , "N";
          |C_M #2#12 , 1 , "S";
          |C_M #2#20 , 1 , "N";
     |FINSI;
|FPRC;
-------------------------------------------------------------------------------
|PROCESO BorrMedi;
     |BORRA 020#30a;
|FPRC;

|DEFBUCLE BorrMedi;
     #30#1;
     ;
     #2#0, #2#1, #2#2, #2#3, 001;
     #2#0, #2#1, #2#2, #2#3, 001;
     be;
     NULL, BorrMedi;
|FIN;

|PROCESO Act003; |TIPO 2;
     nModo = (FEntrada / 100) ! 0;
     |ABRE #3;
     |SELECT #2#3;
     #3#0 = #2#0;                                 ||Serie Pres.
     #3#1 = #2#1;                                 ||N.Presupuesto
     #3#2 = #2#14;
     #3#4 = #2#4;                                 ||Partida.
     |LEE 000#3=;
     |SI FSalida = 0;
          #3#23 = #3#23 +. #2#7;                  ||Unidades Certificadas.
          #3#24 = #3#7  -  #3#23;                 ||Unidades Pendientes.
          |GRABA 020#3a;
     |FINSI;

     #1#6 = #1#6 +. #2#10;                        ||Total certificacion sin IVA.
     #2#9  = #3#10;
     #2#11 = #3#20;
     |PINTA 2270, #3#23;
     |PINTA 2370, #3#24;
     |CIERRA #3;

     |SI nModo = 3;
          |BUCLE BorrMedi;
     |FINSI;
|FPRC;
-------------------------------------------------------------------------------
|PROCESO CalCan; |TIPO 0;

     |SI Contenido ! #2#20;
          |ABRE #3;
          |SELECT #2#3;
          #3#0 = #2#0;                            ||Serie Pres.
          #3#1 = #2#1;                            ||N.Presupuesto
          #3#2 = #2#14;
          #3#4 = #2#4;                            ||Partida.
          |LEE 000#3=;

          |SI FSalida = 0;

               |SI #2#20 [ #3#23;
                    |MENAV "0000LA MEDICION REALIZA ES INFERIOR A LA CERTIFICADA";
                    |ERROR;
                    |CIERRA #3;
                    |ACABA;
               |FINSI;

               |SI #2#20 > #2#18;
                    |MENAV "0000LA MEDICION REALIZA ES SUPERIOR A LA PRESUPUESTADA";
               |FINSI;

               #2#7  = #2#20 - #3#23;
               #2#10 = #2#7 * #2#8;
               |SI #2#10 > #2#11;
                    #2#10 = #2#11;
               |FINSI;
               #2#11 = #3#20 - #2#10;
               #2#12 = (#2#10 * 100) / #2#9;
               |PINTA #2#7;
          |FINSI;

          |CIERRA #3;

     |FINSI;
|FPRC;
-------------------------------------------------------------------------------
|PROCESO CalImp; |TIPO 0;

     |SI Contenido ! #2#10;

          |SI #2#10 > #2#11;
               |MENAV "0000EL IMPORTE ES SUPERIOR AL PENDIENTE";
          |FINSI;

          #2#7 = (#2#10 * #2#18) / #2#9;
          #2#20 = #3#23 + #2#7;
          |SI aTipCer = "I";
               #2#12 = (#2#10 * 100) / #2#9;
          |FINSI;
          |PINTA #2#12;
          |PINTA #2#20;
          |PINTA #2#7;
     |FINSI;

|FPRC;

|PROCESO CalTan; |TIPO 0;
     |SI Contenido ! #2#12;
          |ABRE #3;
          |SELECT #2#3;
          #3#0 = #2#0;                            ||Serie Pres.
          #3#1 = #2#1;                            ||N.Presupuesto
          #3#2 = #2#14;
          #3#4 = #2#4;                            ||Partida.
          |LEE 000#3=;
          #2#10 = #2#9 % #2#12;
          |SI #2#10 > #2#11;
               #2#10 = #2#11;
          |FINSI;
          |HAZ CalImp;
          |CIERRA #3;
     |FINSI;
|FPRC;
-------------------------------------------------------------------------------
-----------------------------------------------------------------------------
|PROCESO Graba;
     #2#11 = nImporte;
     #2#13 = nPorcien;
     #2#15 = #1#3;
     |GRABA 020#2a;
|FPRC;
-------------------------------------------------------------------------------
|DEFBUCLE Recalcula;
     #2#2;
     ;                                          ||Campos Extras.
     #1#0, #1#1,   1, cPartida, cCapitulo;
     #1#0, #1#1, 999, cPartida, cCapitulo;
     ;                                          ||b/e Bolqueo-Ordenacion.
     NULL, Graba;
|FIN;
-------------------------------------------------------------------------------
|PROCESO Recal; |TIPO 3;
     |SALVA_FICHA #2;
     cPartida  = #2#4;
     nImporte  = #2#11;
     nPorcien  = #2#13;
     cCapitulo = #2#14;
     |BUCLE Recalcula;
     |REPON_FICHA #2;
|FPRC;
-------------------------------------------------------------------------------
|PROCESO BICer; |TIPO 80;
     |CLS;
     |CONTROL_SIMPLE 0, "BOTON,F2 - Relacion de Partidas.", 2430, 2450, F2Cer;
     nBotAmpli = FSalida;
     |CONTROL_SIMPLE 0, "BOTON,F6 - Medicion.", 2430, 2450, F6Cer;
     nBotMedi = FSalida;
     |CONTROL_SIMPLE 0, "BOTON,F6 - Copia Medicion.", 2430, 2450, F6Cer;
     nBotCopia = FSalida;
     |ESTADO_CONTROL nBotAmpli, "HIDE";
     |ESTADO_CONTROL nBotMedi, "HIDE";
     |ESTADO_CONTROL nBotCopia, "HIDE";
|FPRC;
------------------------------------------------------------------------------
|PROCESO BFCer; |TIPO 90;
     |FIN_CONTROL_WINDOWS nBotAmpli;
     |FIN_CONTROL_WINDOWS nBotMedi;
     |FIN_CONTROL_WINDOWS nBotCopia;
     |PULSATECLA;
|FPRC;
------------------------------------------------------------------------------
|PROCESO BSCer; |TIPO 7;
     |SI Campo = 4;
          |SI #3#5 ! "                    ";
               |ESTADO_CONTROL nBotAmpli, "SHOW";
          |FINSI;

     |FINSI;
|FPRC;
-------------------------------------------------------------------------------
|PROCESO BHCer; |TIPO 0;
     |ESTADO_CONTROL nBotAmpli, "HIDE";
     |ESTADO_CONTROL nBotMedi, "HIDE";
|FPRC;
-------------------------------------------------------------------------------
|PROCESO F2Cer;
     |PTEC 824;
|FPRC;
|PROCESO F6Cer;
     |PTEC 828;
|FPRC;
-------------------------------------------------------------------------------
|PROCESO SalEsc; |TIPO 11;
     |SI FSalida = 7;
          |HAZ BHCer;
     |FINSI;
|FPRC;
-------------------------------------------------------------------------------
|PROCESO gocerhis;
     |DDEFECTO #5;
     #5#0 = #4#0;
     #5#1 = #4#1;
     #5#2 = #4#2;
     |LEE 020#5=;

     nHay = 1;
     nTotaMedi = (nTotaMedi + #4#7) ! 3;
     nTotaImpo = (nTotaImpo + #4#10) !  2;
     |DDEFECTO #36;
     #36#0 = #4#4; ||parti
     |||#36#6 =  #4#15; ||fecha
     #36#6 = #5#3; ||fecha
     |LEE 101#36=;
     |SI FSalida ! 0; |GRABA 020#36b; |FINSI;
     #36#1 = #4#5; ||des
     #36#2 = #36#2 + #4#7;
     #36#3 = #36#3 + #4#10;
     |GRABA 020#36a;
     |LIBERA #36;
|FPRC;

|DEFBUCLE gocerhis;
     #4#1;
     ;
     #2#0, #2#1, 001, 001;
     #2#0, #2#1, 999, 999;
     ;
     NULL, gocerhis;
|FIN;

|PROCESO ConsultaCerti; |TIPO 11;
     |SI FSalida = 13; ||F5
          nTotaMedi = 0; nTotaImpo = 0; nHay = 0;
          aAlfa = Usuario; aAlfa = "s" + aAlfa;
          |NOME_DAT #36 aAlfa; |DELINDEX #36;
          |ABRE #36;
          |ABRE #5;
          |BUCLE gocerhis;
          |CIERRA #5;
          |CIERRA #36;
          |SI nHay = 0;
               |MENAV  "0000No hay unidades certificadas...";
          |SINO;
               |PUSHV 0501 2380;
               |ENTLINEAL #1#36, 2, 4, 20, 1, Min36, Max36;
               |POPV;
          |FINSI;
          |DELINDEX #36;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Min36;
     #36#0 = " " * 20;
     #36#6 = "01.01.0000";
|FPRC;

|PROCESO Max36;
     #36#0 = "z" * 20;
     #36#6 = "31.12.9999";
|FPRC;

|PROCESO PintaToCerti; |TIPO 7;
     #36#4 = nTotaMedi; |PINTA #36#4;
     #36#5 = nTotaImpo; |PINTA #36#5;
|FPRC;
-------------------------------------------------------------------------------
|PROCESO Medi7; |TIPO 7;
     |ABRE #20;
     #20#0 = #3#6;
     |LEE 000#20=;
     |SI FSalida = 0; |Y #20#2 = "S";
          |ESTADO_CONTROL nBotMedi, "SHOW";
     |FINSI;
     |CIERRA #20;
|FPRC;

|PROCESO Min30;
     #30#0 = #2#0;
     #30#1 = #2#1;
     #30#2 = #2#2;
     #30#3 = #2#3
     #30#4 = 1;
|FPRC;

|PROCESO Max30;
     #30#0 = #2#0;
     #30#1 = #2#1;
     #30#2 = #2#2;
     #30#3 = #2#3
     #30#4 = 999;
|FPRC;

|PROCESO Medi0; |TIPO 0;
     |SI #20#2 = "S";
          nNume = Contenido;
          |SI nNume ! #2Campo;
               |MENAV "0000PULSE F6 PARA ENTRAR LAS MEDICIONES";
               #2Campo = Contenido;
               |PINTA #2Campo;
               |ERROR;
               |ACABA;
          |FINSI;
          |SI FSalida = 14;
               |ABRE #9;
               #9#0 = #2#0;
               #9#1 = #2#1;
               |LEE 000#9=;
               |CIERRA #9;
               nDeci_Medi = #9#24;
               |ABRE #100; |LEE 000#100p; |CIERRA #100;
               nDeci_Meda = #100#115;
               |ESTADO_CONTROL nBotMedi, "HIDE";
               |ESTADO_CONTROL nBotCopia, "SHOW";
               |PUSHV 0501 2380;
               |ENTLINEAL #1#30, 5, 2, 22, 1, Min30, Max30;
               |POPV;
               |PINTA #2#20;
               |ESTADO_CONTROL nBotCopia, "HIDE";
               |ESTADO_CONTROL nBotMedi, "SHOW";
          |FINSI;
     |FINSI;
     |ESTADO_CONTROL nBotMedi, "HIDE";
|FPRC;
---------------------------------------------------------------
|PROCESO CargaAgrupPres;
     nLinea = nLinea + 1;
     #guerw067#0 = nLinea;
     #guerw067#1 = #gopre002#12;
     #guerw067#2 = #gopre002#13;
     |GRABA 020#guerw067.n;
|FPRC;

|DEFBUCLE CargaAgrupPres;
     #gopre002#7;
     ;
     #gopre001#0, #gopre001#1, nAgrup, 001, "                    ";
     #gopre001#0, #gopre001#1, nAgrup, 999, "zzzzzzzzzzzzzzzzzzzz";
     ;
     NULL, CargaAgrupPres;
|FIN;

|PROCESO CargaAgrup;
     #guerw066#0 = #gopre002#14;
     |LEE 101#guerw066.=;
     |SI FSalida ! 0;
          |SI #guerw066#0 = 0;
               #guerw066#0 = 0;
               #guerw066#1 = "Sin Agrupacion";
               |GRABA 020#guerw066.n;
          |SINO;
               #gopre021#0 = #gopre002#0;
               #gopre021#1 = #gopre002#1;
               #gopre021#2 = #gopre002#14;
               |LEE 000#gopre021.=;

               #guerw066#0 = #gopre002#14;
               #guerw066#1 = #gopre021#3;
               |GRABA 020#guerw066.n;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE CargaAgrup;
     #gopre002#1;
     ;
     #gopre001#0, #gopre001#1, 001;
     #gopre001#0, #gopre001#1, 999;
     ;
     NULL, CargaAgrup;
|FIN;

|PROCESO MinPed;
     #gopre002#0 = #0#0;
     #gopre002#1 = #0#1;
     #gopre002#2 = 001;

     |SI #gopre001#49 = "S";
          #gopre002#14 = nAgrup;
     |SINO;
          #gopre002#14 = 000;
     |FINSI;

     #gopre003#0 = #0#0;
     #gopre003#1 = #0#1;
     #gopre003#2 = #2#14;
     #gopre003#3 = 1;
|FPRC;

|PROCESO MaxPed;
     #gopre002#0 = #0#0;
     #gopre002#1 = #0#1;
     #gopre002#2 = 999;

     |SI #gopre001#49 = "S";
          #gopre002#14 = nAgrup;
     |SINO;
          #gopre002#14 = 999;
     |FINSI;

     #gopre003#0 = #0#0;
     #gopre003#1 = #0#1;
     #gopre003#2 = #2#14;
     #gopre003#3 = 999;
|FPRC;

|PROCESO ConsultaParti;
     |ABRE #gopre001;
     #gopre001#0 = #0#0;
     #gopre001#1 = #0#1;
     |LEE 020#gopre001.=;
     |CIERRA #gopre001;

     || AGRUPACIONES DE CAPITULOS

     nAgrup = 0;
     aDesAgrup = "";
     nError = 0;
     |SI #gopre001#49 = "S";
          |HAZ CreaTempo; |NOME_DAT #guerw066#Tempo#; |DELINDEX #guerw066;
          |ABRE #guerw066;
          |ABRE #gopre021;
          |BUCLE CargaAgrup;
          |LEE 000#guerw066.p;
          |CONSULTA_CLAVE #1#guerw066;
          |SI FSalida = 0;
               nAgrup = #guerw066#0;
               aDesAgrup = #guerw066#1;
          |SINO;
               nError = 1;
          |FINSI;
          |CIERRA #gopre021;
          |CIERRA #guerw066;
          |HAZ BoraTempo; |DELINDEX #guerw066;

          |SI nError = 1; |ERROR; |ACABA; |FINSI;

          |HAZ CreaTempo; |NOME_DAT #guerw067#Tempo#; |DELINDEX #guerw067;
          |ABRE #guerw067;
          nLinea = 0;
          |BUCLE CargaAgrupPres;

          ||CONSULTA_F_CLAVE #1#gopre002, MinPed, MaxPed;
          |LEE 000#guerw067.p;
          |CONSULTA_CLAVE #1#guerw067;
          |SI FSalida ! 0;
               nError = 1;
          |SINO;
               #2#14 = #guerw067#1;     || Capitulo
          |FINSI;
          |CIERRA #guerw067;
          |HAZ BoraTempo; |DELINDEX #guerw067;
     |SINO;
          |ABRE #gopre002;
          |SELECT #6#gopre002;
          #gopre002#0 = #0#0;
          #gopre002#1 = #0#1;
          #gopre002#12 = #2#14;
          |LEE 000#gopre002.];

          ||CONSULTA_F_CLAVE #1#gopre002, MinPed, MaxPed;
          |CONSULTA_F_CLAVE #7#gopre002, MinPed, MaxPed;
          |SI FSalida ! 0;
               nError = 1;
          |SINO;
               #2#14 = #gopre002#12; || Capitulo
          |FINSI;
          |CIERRA #gopre002;
     |FINSI;

     |SI nError = 1; |ERROR; |ACABA; |FINSI;

     |ABRE #gopre003;
     |SELECT #2#gopre003;
     #gopre003#0 = #0#0;
     #gopre003#1 = #0#1;
     #gopre003#2 = #2#14;
     #gopre003#4 = #2#4;
     |LEE 000#gopre003.];
     |CONSULTA_F_CLAVE #1#gopre003, MinPed, MaxPed;
     |SI FSalida ! 0;
          |ERROR;
     |SINO;
          #2#4 = #gopre003#4;
          #2#5 = #gopre003#5;
          |PINTA #2#4;
          |PINTA #2#5;
     |FINSI;
     |CIERRA #gopre003;
|FPRC
