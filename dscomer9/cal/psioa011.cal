|FICHEROS;
     agifa104 #0;   || Cabecera Pedidos.
     agifa024 #1;   || Clientes.
     agifa025 #5;   || Representantes
     agifa038 #13;  || Descripcion Ampliada.
     agifa007 #40;  || Fichero de Series.
     agifa142 #41;  || Parametros Generales.
     agifa027 #43;  || Contadores;
     psioa004 #99;  || Cabecera de revision.
     agifa324 #50;  || Divisas.

     agifa091 #100;
     agis0002 #101;
     dscamrec@ #600;
     dsm00003 #300;
     referen@;
     dsm00289 #289;
|FIN;

|VARIABLES;
     nSwCoimasa = 0;
     nPrioridad = 0;
     nSwCongecar = 0;
     &eaFichero1 = "";
     &efFecha = @;
     con = 0;
     indtope = 0;
     ind = 0;
     fmes = "  ";
     mes = 0;
     control = 0;
     mensaje10 = "0000El Pedido ya esta Servido en parte o totalmente";
     mensaje11 = "0423Actualizando linea:";
     mensajei  = "2400NDesea imprimir este pedido? ";
     informe1 = "agifa104";
     informe = "";
     &iva1 = 0;
     &iva2 = 0;
     &iva3 = 0;
     &iva4 = 0;
     &iva5 = 0;
     &re1 = 0;
     &re2 = 0;
     &re3 = 0;
     &re4 = 0;
     &re5 = 0;
     &codigo="";
     &descrip="";
     &precio=0;
     &dto=0;
     &dto1=0;
     &unid=0;
     &imptot=0;
     &tiva=0;
     &linea=0;
     vacio="";
     &cant = 0;
     &tolin = 0;
     &n_dec = 0;
     &n_pre = 0;
     &ext1 = "";
     modo = 0;
     &bl  = "                              ";
     numero = "";
     tipo = "vpedido";
     &aMoneda = "";
     &aDivisa = "";

     &eaCuenta = "";
     &eaTag  = "";
     &Tempo  = "";
     &nDeci_Div = 0;
     &aCPath  = "";
     &aCNome  = "";
     nNumRec = 0;
     nHandle = 0;
     nSwError = 0;
     aAlfa   = "";
     Comodin = "";
     aMensa  = "";
     aPath   = "";
     aDef00  = "";
     aTempo600 = "";
|FIN;

|PROCESO AuxCoimasa;
     |DDEF aPath;
     aAlfa = aPath + "coima022";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@; |LEE 000#referen@.p; |CIERRA #referen@;
          nPrioridad = #referen@#12;
          |DESCARGA_DEF #referen@;
     |FINSI;
     aAlfa = aPath + "coima006";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          #referen@#0 = #0#25;
          #referen@#1 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida ! 0; |GRABA 020#referen@.b; |FINSI;
          #referen@#2 = nPrioridad;
          #referen@#3 = #99#45; ||Servir completo
          #referen@#4 = #99#44; ||Coleccion completa
          #referen@#5 = "S";
          |GRABA 020#referen@.a;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO DirEnt;
     |DDEFECTO #300;
     |ABRE #300;
     #300#0 = #0#4;
     #300#1 = #0#57;
     |LEE 000#300=;
     |SI FSalida = 0;
          #0#8 = #300#10;
          #0#19 = #300#10;
          #0#14 = #300#2;
          #0#20 = #300#3;
          #0#21 = #300#7;
          #0#59 = #300#6;
     |FINSI;
     |CIERRA #300;
|FPRC;

|CALCULO cogecon;|TIPO 0;
     control = 0;
|FCAL;

|CALCULO mirar_d;
     |ABRE #41;
     #41#0 = "A";
     |LEE 001#41=;
     |LIBERA #41;
     |SI FSalida ! 0; |DDEFECTO #41; |FINSI;
     |LIBERA #41;
     |CIERRA #41;
     n_dec = #41#8;
     n_pre = #41#9;
|FCAL;

|PROCESO pasa;
     |DDEFECTO #0;
     |ABRE #1;
     #1#0 = #99#4;
     |LEE 000#1=;
     |LIBERA #1;
     |CIERRA #1;
     |ABRE #50;
     #50#0 = #1#192;
     |LEE 000#50=;
     |LIBERA #50;
     |CIERRA #50;
     numero = "000000" + #99#1;
     numero = numero % -106;
     #0#0 = numero;                || Numero Pedido.
     #0#25 = #99#2;                || Serie Pedido.
     #0#1 = #99#3;                 || Fecha Pedido.
     #0#4 = #99#4;                 || Cod. Cliente.
     #0#8 = #1#2;                  || Nombre Cliente (comercial)
     #0#7 = #99#10;                || Representante.
     #0#5 = #99#11;                || Dto.
     #0#6 = #99#12;                || Dto. P.P.
     #0#9 = #1#20;                 || Forma de Pago.
     #0#19 = #1#2;                 || Entregar a. (nombre comercial)
     #0#14 = #1#5;                 || Direccion entraga.
     #0#20 = #1#6;                 || Pob. entre.
     #0#21 = #1#7;                 || Prov. entre.
     #0#59 = #1#180;
     #0#17 = #99#13;               || Dto. acumulado.
     #0#22 = #1#47;                || Regimen equiva.
     #0#23 = #1#41;                || Tipo Facturacion
     #0#11 = #99#8;                || Total Pedido.
     #0#12 = #99#8;                || Pendiente Servir.
     #0#35 = #1#192;
     #0#36 = #50#2;
     #0#41 = #50#2;
     #0#37 = #1#193;
     #0#40 = #1#192;
     #0#42 = #0#11;
     #0#43 = #0#12;
     #0#44 = #0#13;
     #0#45 = #0#11;
     #0#46 = #0#12;
     #0#47 = #0#13;
     #0#48 = #0#11;
     #0#49 = #0#13;
     #0#50 = #0#12;
     #0#64 = #1#15;

     |HAZ pedclie;
     |HAZ mirar_d;
     |HAZ cogecon;
     #0#0 = numero;                || Numero Pedido.
     #0#25 = #99#2;                || Serie Pedido.
     |ABRE #43;
     #43#0 = tipo;
     #43#2 = #0#25;
     |LEE 010#43=;
     |SI FSalida ! 0;
         #43#1 = #0#0 + 1;
         |GRABA 010#43n;
     |SINO;
         #43#1 = #0#0 + 1;
         |GRABA 010#43a;
     |FINSI;
     |LIBERA #43;
     |CIERRA #43;
     #0#57 = #99#32;
     |HAZ DirEnt;
     |SI #99#33 ! "01.01.0000";
          #0#2 = #99#33;
     |FINSI;
     aAlfa = #99#34; |QBF aAlfa;
     aAlfa = aAlfa + #99#41; |QBF aAlfa;
     aAlfa = aAlfa + #99#42; |QBF aAlfa;
     #0#15 = aAlfa;
     aAlfa = #99#37; |QBF aAlfa;
     |SI aAlfa ! "";
          #0#9 = #99#37; ||F.Pago
     |FINSI;
     |SI nSwCongecar = 0;
          #0#55 = #99#39;
     |FINSI;
     #0#60 = #1#202; ||agencia
     |SI nSwCoimasa = 0;
          #0#3 = #99#43; ||su pedido
          #0#26 = "TABLET";
          #0#52 = #1#167;
          |HAZ AuxCoimasa;
     |FINSI;
     |GRABA 121#0n;
     || -------- Generacion Recibos Adelantados -----------
     |SI #99#6 ! "N";
/*
         |DDEFECTO #44;
         |ABRE #44;
         #44#30 = "P";     || Tipo Documento.
         #44#20 = #0#25;   || Serie.
         #44#17 = #0#0;    || Numero.
         #44#18 = 1;       || Recibo.
         |LEE 101#44=;
         |SI FSalida ! 0;
             |GRABA 020#44b;
         |FINSI;
         #44#30 = "P";   || Tipo Documento.
         #44#20 = #0#25; || Serie.
         #44#17 = #0#0;  || Numero.
         #44#18 = 1;     || Recibo.
         #44#0 = "";     || Factura.
         #44#1 = 0;      || Numero Recibo.
         #44#2 = #0#4;   || Cliente.
         #44#3 = #0#8;   || Nombre Cliente.
         #44#4 = #1#29;  || Banco.
         #44#5 = "S";    || Domiciliado.
         #44#6 = "N";    || Aceptado.
         #44#7 = #0#1;   || Fecha Emision.
         #44#8 = #0#1;   || Fecha Vto.
         #44#9 = #99#7;  || Importe.
         #44#10 = "N";   || Impreso.
         #44#11 = "N";   || Contabilizado.
         #44#12 = #1#16; || Numero Contable.
         #44#13 = "S"; || Cobrado.
         #44#14 = "N";   || Impagado.
         #44#15 = "N";   || A Aceptar.
         #44#16 = efFecha; || Fecha De Cobro.
         #44#19 = "";    || Serie Recibo.
         #44#21 = "S";   || Afecta a Factura.
         #44#22 = 01;    || Tipo Recibo.
         #44#24 = #0#9;  || Forma De Pago.
         #44#25 = #99#7; || Importe Cobrado.
         #44#26 = 0;     || Importe Impagado.
         #44#28 = eaCuenta; || Cuenta Ingreso.
         |GRABA 020#44a;
         |LIBERA #44;
         |CIERRA #44;
*/

        |SI #99#6 ! "N";
           |ABRE #agifa091; |ABRE #agis0002;

           #agifa091#0 = #agifa024#20;
           |LEE 000#agifa091.=;
           |SI FSalida ! 0; |DDEFECTO #agifa091; |FINSI;

           nNumRec = 1; aAlfa = #99#2; |QBF aAlfa; aAlfa = (aAlfa + "     ") % 0105;
           #agis0002#30 = "P";
           numero = "000000" + #99#1; numero = numero % -106;
           #agis0002#20 = aAlfa;
           #agis0002#17 = #99#1;
           #agis0002#18 = 1;
           |LEE 000#agis0002.];
           |PARA; |SI FSalida = 0; |Y #agis0002#20 = aAlfa; |Y #agis0002#30 = "P"; |Y #agis0002#17 = #99#1; |HACIENDO;
              nNumRec = #agis0002#18 + 1;
              |LEE 000#agis0002.s;
           |SIGUE;
           |DDEFECTO #agis0002;
           #agis0002#30 = "P";
           #agis0002#20 = aAlfa;
           #agis0002#17 = numero;
           #agis0002#18 = nNumRec;
           |GRABA 020#agis0002.b;
           #agis0002#0  = numero;
           #agis0002#1  = nNumRec;
           #agis0002#2  = #99#4;
           #agis0002#3  = #agifa024#1;
           #agis0002#4  = #agifa024#29;
           #agis0002#5  = "N";
           #agis0002#6  = "N";
           #agis0002#7  = #99#3;
           #agis0002#8  = #99#3;
           #agis0002#9  = #99#7;
           #agis0002#10 = "N";
           #agis0002#11 = "N";
           #agis0002#12 = #agifa024#16;
           #agis0002#14 = "N";
           #agis0002#15 = "N";
           #agis0002#16 = efFecha;
           #agis0002#19 = #99#2;
           #agis0002#22 = #agifa091#69;
           #agis0002#23 = 0;
           #agis0002#24 = #agifa024#20;
           #agis0002#25 = 0;
           #agis0002#26 = 0;
           #agis0002#27 = 0;
           #agis0002#28 = eaCuenta;
           |GRABA 020#agis0002.a; |LIBERA #agis0002;

           |CIERRA #agifa091; |CIERRA #agis0002;

           |DBASS aAlfa;
           aAlfa = aAlfa + "dscarter/fich/dscam000.dat";
           |XABRE "E", aAlfa, nHandle;
           |SI FSalida = 0;
              |DBASS aPath;
              aPath = aPath + "dscarter/";
              aDef00 = aPath + "def/dscamrec";

              |CARGA_DEF aDef00, dscamrec@;
              |SI FSalida ! 0;
                 aMensa = "0000Error al cargar:" + aDef00;
                 |MENAV aMensa;
                 aDef00 = "";
              |SINO;
                 |HAZ CreaTempo; aTempo600 = Tempo;
                 |PATH_DAT #600 aPath; |NOME_DAT #600 aTempo600; |DELINDEX #600;
                 |ABRE #600;
                 aCPath = aPath; aCNome = aTempo600;
              |FINSI;

              |DFICE Comodin;
              Comodin = Comodin % -106;
              Comodin = Comodin % 0105;

              nDeci_Div = 2;

              |ABRE #agifa025;
              #agifa025#0 = #99#10;
              |LEE 000#agifa025.=;
              |SI FSalida ! 0; |DDEFECTO #agifa025; |FINSI;
              |CIERRA #agifa025;

              |ABRE #agifa024;
              #agifa024#0 = #agis0002#2;
              |LEE 000#agifa024.=;
              |CIERRA #agifa024;

              |DDEFECTO #dscamrec@;
              #600#1  = #agis0002#20;||Serie
              #600#2  = #agis0002#17;||Fact
              #600#3  = #agis0002#18;||N§ Rec
              #600#4  = #agis0002#8; ||F.V
              #600#5  = #agis0002#7; ||F.E
              #600#6  = #agis0002#12;||Cuenta Cli
              #600#7  = #agis0002#3; ||Nom Cli
              #600#8  = #agis0002#4; ||Nom Banco
              #600#9  = #agifa024#32;      ||Entidad
              #600#10 = #agifa024#33;      ||Sucursal
              #600#11 = #agifa024#31;      ||DC
              #600#12 = #agifa024#30;      ||Cuenta
              #600#13 = #agis0002#22;||Tipo Rec
              #600#15 = #agis0002#9; ||Importe
              #600#16 = #agis0002#15;||A aceptar
              #600#17 = #agis0002#6; ||Aceptado
              #600#18 = #agis0002#2; ||Cliente
              #600#19 = #99#10;      ||Codigo representante
              #600#20 = #agifa025#1; ||Nombre representante
              #600#21 = #agifa024#3; ||Zona
              #600#22 = 1;           ||Documento
              #600#25 = Comodin;     ||Empresa ges
              #600#27 = "V";         ||Tipo
              #600#28 = "A";         ||Ope
              #600#29 = "EUR";
              #600#30 = "EURO";           ||Nombre
              #600#31 = 1;                ||Cambio Divisa
              #600#32 = 1;                ||Cambio Base
              #600#33 = #agifa024#203;
              #600#34 = 0;
              #600#35 = "P";
              #600#36 = #agis0002#28;
              #600#38 = #agis0002#16;
              #600#39 = #agis0002#10;
              aAlfa = "|NC"; aAlfa = #600#aAlfa#;
              |SI aAlfa > 48;
                   #600#48 = #agifa024#215;
                   #600#49 = #agifa024#216;
              |FINSI;
              |SI aAlfa > 50;
                   #600#50 = #agifa024#217;
                   |ABRE #289;
                   #289#0 = #agifa024#0;
                   |LEE 000#289=;
                   |SI FSalida ! 0; |DDEFECTO #289; |FINSI;
                   |CIERRA #289;
                   #600#51 = #289#1;
              |FINSI;

              |GRABA 020#600n;

              |SUB_EJECUTA_NP ":dscarter/dsrecibo";

              #600#22 = 1;           ||Documento
              |LEE 000#600=;
              |SI FSalida ! 0; |O #600#37 = "ERROR               ";
                 nSwError = 1;
                 |MENAV "    La entrega tiene movimientos. Proceso abortado";
                 |SI aDef00 ! "";
                    |CIERRA #600; |DELINDEX #600; |DESCARGA_DEF #dscamrec@;
                 |FINSI;
                 |ERROR; |ACABA;
              |FINSI;

              |SI aDef00 ! "";
                 Tempo = aTempo600; |HAZ BoraTempo;
                 |CIERRA #600; |DELINDEX #600; |DESCARGA_DEF #dscamrec@;
              |FINSI;

              eaTag = "RAP"; |HAZ Riesgos;
           |FINSI;
        |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE lee_cab;
     #99#1;
     ;
     "P","     ",000000;
     "P","zzzzz",999999;
     be;
     NULL,pasa;
|FIN;

|PROGRAMA;
     |SI PARAMETRO = "DIRECTA";
          |NOME_DAT #99#eaFichero1#;
     |FINSI;
     |HAZ EsCongecar; nSwCongecar = FSalida;
     |HAZ EsCoimasa; nSwCoimasa = FSalida;

     aMoneda = "B";
     aDivisa = "EUR";
     |HAZ Divisas104;

     modo = 1;
     |ABRE #0;
     |BUCLE lee_cab;
     |LIBERA #0;
     |CIERRA #0;
|FPRO;

|CALCULO pedclie;
  |ABRE #1;
  #1#0 = #99#4;
  |LEE 101#1=;
  |SI 0 = FSalida;
      fmes = #0#1 % A402;
      mes = fmes - 1;
      mes = mes * 3;
      mes = mes + 114;
      #1mes = #1mes + #0#11;
      #1#150 = #1#150 + #0#11;
      |GRABA 020#1a;
  |FINSI;
  |LIBERA #1;
|FCAL;
