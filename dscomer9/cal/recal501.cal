|FICHEROS;
     agifa501  #0;
     agifa502@ #1;
     agifa019  #2;
|FIN;

|VARIABLES;
     &eaSerExp = "";
     &enPtoVerde = 0;
     &EURODB   = 0;
     &enIva    = 0;
     &enRec    = 0;
     &eaCli    = "";
     &enTiva   = 0;
     &efFiva = @;
     aDef      = "";
     iva       = 0;
     puente_n  = 0;
     puente_s  = 0;

|FIN;

|PROCESO Acumula;
     |SI #1#13 = 0;
          #0#30 = #0#30 +. puente_n;      ||Exenta
     |FINSI;
     |SI #1#13 = 1;
           #0#20 = #0#20 +. puente_n;
           #0#21 = #0#21 +. ((puente_n % enIva)!EURODB);
           |SI #0#29 = "S";            ||Tiene recargo
                #0#22 = #0#22 +. ((puente_n % enRec)!EURODB);
           |FINSI;
     |FINSI;
     |SI #1#13 = 2;
          #0#23 = #0#23 +. puente_n;    || Base imponible s/decimales
          #0#24 = #0#24 +. ((puente_n % enIva)!EURODB);
          |SI #0#29 = "S";            ||Tiene recargo
               #0#25 = #0#25 +. ((puente_n % enRec)!EURODB);
          |FINSI;
     |FINSI;
     |SI #1#13 = 3;
          #0#26 = #0#26 +. puente_n;
          #0#27 = #0#27 +. ((puente_n % enIva)!EURODB);
          |SI #0#29 = "S";            ||Tiene recargo
               #0#47 = #0#47 +. ((puente_n % enRec)!EURODB);
          |FINSI;
     |FINSI;
     |SI #1#13 = 4;
          #0#48 = #0#48 +. puente_n;
          #0#49 = #0#49 +. ((puente_n % enIva)!EURODB);
          |SI #0#29 = "S";            ||Tiene recargo
               #0#50 = #0#50 +. ((puente_n % enRec)!EURODB);
          |FINSI;
     |FINSI;
     |SI #1#13 = 5;
          #0#51 = #0#51 +. puente_n;
          #0#52 = #0#52 +. ((puente_n % enIva)!EURODB);
          |SI #0#29 = "S";            ||Tiene recargo
               #0#53 = #0#53 +. ((puente_n % enRec)!EURODB);
          |FINSI;
     |FINSI;
     #0#77 = #0#77 +. #1#42;
|FPRC;

|PROCESO Lin502;
     |SI eaSerExp = "S";
          #1#6 = #1#10;
          #1#7 = #1#21;
          #1#13 = 0;
          #1#19 = 0;
     |FINSI;

     #2#0 = #1#2;
     |LEE 020#2=;

     #1#42 = #1#5 * #2#208; ||P.Verde

     #1#23 = #2#9 * #1#5;         ||Coste linea
     #0#3 = #0#3 +. #1#21;        ||Total bruto
     puente_n = ((#1#21 < #0#17) < #0#19) < #0#18;

     #0#28 = #0#28 +. (#1#21 - puente_n);    ||Total descuentos

     eaCli = #0#1; enTiva = #1#13; efFiva = #0#14; |HAZ IVACli;

     |HAZ Acumula;

     #0#4=#0#21+#0#22+#0#24+#0#25+#0#27+#0#47+#0#49+#0#50+#0#52+#0#53;
     #0#9 = #0#3 + #0#4;
     #0#76 = #0#76 + #1#5;
     |GRABA 020#1a;
|FPRC;

|DEFBUCLE Lin502;
     #1#1003;
     ;
     #0#36, #0#0, 001;
     #0#36, #0#0, 999;
     be;
     NULL, Lin502;
|FIN;

|PROCESO Recal501;
     |DDEF aDef;
     aDef = aDef + "agifa502";
     |CARGA_DEF aDef, agifa502@;
     |SI FSalida = 0;
          #0#3 = 0;
          #0#4 = 0;
          #0#8 = 0;
          #0#9 = 0;
          #0#20 = 0;
          #0#21 = 0;
          #0#22 = 0;
          #0#23 = 0;
          #0#24 = 0;
          #0#25 = 0;
          #0#26 = 0;
          #0#27 = 0;
          #0#30 = 0;
          #0#47 = 0;
          #0#48 = 0;
          #0#49 = 0;
          #0#50 = 0;
          #0#51 = 0;
          #0#52 = 0;
          #0#53 = 0;
          #0#76 = 0;
          #0#77 = 0;
          |ABRE #2;
          |BUCLE Lin502;
          |CIERRA #2;
          |DESCARGA_DEF #agifa502@;
     |SINO;
          aDef = "0000Error al cargar:" + aDef;
          |MENAV aDef;
     |FINSI;
|FPRC;

|PROCESO Recal501_Sin;
     eaCli = #0#1; efFiva = #0#14; |HAZ IVACli;

     |SI #0#29 = "N"; enRec = 0; |FINSI;

     |SI enTiva = 1;
           #0#21 = #0#20 % enIva;
           #0#22 = #0#20 % enRec;
     |FINSI;
     |SI enTiva = 2;
          #0#24 = #0#23 % enIva;
          #0#25 = #0#23 % enRec;
     |FINSI;
     |SI enTiva = 3;
          #0#27 = #0#26 % enIva;
          #0#47 = #0#26 % enRec;
     |FINSI;
     |SI enTiva = 4;
          #0#49 = #0#48 % enIva;
          #0#50 = #0#48 % enRec;
     |FINSI;
     |SI enTiva = 5;
          #0#52 = #0#51 % enIva;
          #0#53 = #0#51 % enRec;
     |FINSI;

     #0#4 = #0#21+#0#22+#0#24+#0#25+#0#27+#0#47+#0#49+#0#50+#0#52+#0#53;
     #0#9 = #0#3 + #0#4 - #0#28;

     #0#77 = #0#77 +. enPtoVerde;
|FPRC;
