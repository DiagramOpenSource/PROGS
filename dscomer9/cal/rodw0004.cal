|FICHEROS;
     rodw0004 #0;
     rodm0001 #1;
     rodm0003 #3;
     rodm0005 #5;
     rodw0006 #6; ||Tmp Empresas
     rodw0007 #7; ||Tmp Borrados

     agifa010 #10;
     agifa071 #71;
     dsm00043 #43;
     dsm00044 #44;

     agifa200 #200;
     agifa208 #208;
     referen1@;
     referen2@;
|FIN;

|VARIABLES;
     &eaParametro = "";
     &eaRodExporta = "";
     &enEmpresa = 0;
     &Tempo = "";
     &enModo = 0;
     &enError = 0;
     &enSwEjecuta = 0;
     &eaSerRodAnt = "";
     &eaTipRodAnt = "";
     &eaSerie = "";
     &enCodigo = 0;
     &enForma = 0;

     aSwLocal = "";
     direc = "";
     aAlfa1 = "";
     aDirectorio = "";
     aNom = "";
     aEmp = "";
     aProg = "";
     aTipo = "";
     fFecha = @;
     aHora = "";
     aUsu = "";
     aAlfa = "";
     aPath = "";
     a1 = "";
     a2 = "";
     aTar = "";
     aTempo6 = "";
     nHay = 0;
     aFic = "";
     aDef = "";
     aCod1 = "";
     aCod2 = "";
     aCod3 = "";
     aLon = "";
     aCar = "";
     nPos = 0;
     i = 0;
     aOrg = "";
     aDes = "";
|FIN;

|PROCESO LaClave;
     aCod1 = "";
     aCod2 = "";
     aCod3 = "";
     aAlfa = #5#1; |QBF aAlfa;
     aLon = aAlfa % A0;
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aCar = aAlfa % nPos;
          |SI aCar = "|"; |SAL; |FINSI;
          aCod1 = aCod1 + aCar;
     |SIGUE;
     i = i + 1;
     |PARA; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aCar = aAlfa % nPos;
          |SI aCar = "|"; |SAL; |FINSI;
          aCod2 = aCod2 + aCar;
     |SIGUE;
     i = i + 1;
     |PARA; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aCar = aAlfa % nPos;
          aCod3 = aCod3 + aCar;
     |SIGUE;
|FPRC;

|PROCESO rodm0005;
     aFic = #5#2; |QBF aFic;
     |DDEF aDef;
     aAlfa = aDef + aFic;
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida = 0;
          |CARGA_DEF aAlfa, referen2@;
          |SI FSalida = 0;
               |PATH_DAT #referen2@#aPath#;
               |ABRE #referen1@;
               |ABRE #referen2@;
               |DDEFECTO #referen1@;
               |DDEFECTO #referen2@;
               |HAZ LaClave;
               |SI aFic = "agifa024"; #referen1@#0 = aCod1; |FINSI;
               |SI aFic = "agifa019"; #referen1@#0 = aCod1; |FINSI;
               |SI aFic = "agifa112"; #referen1@#0 = aCod1; |FINSI;
               |SI aFic = "dsm00003"; #referen1@#0 = aCod1; #referen1@#1 = aCod2; |FINSI;

               |SI aFic = "agifa023"; #referen1@#0 = aCod1; #referen1@#1 = aCod2; |FINSI;
               |SI aFic = "dsm00123"; #referen1@#0 = aCod1; #referen1@#1 = aCod2; #referen1@#2 = aCod3; |FINSI;
               |SI aFic = "agifa095"; #referen1@#0 = aCod1; #referen1@#1 = aCod2; |FINSI;
               |SI aFic = "agifa039"; #referen1@#0 = aCod1; #referen1@#1 = aCod2; |FINSI;
               |SI aFic = "agifa310"; #referen1@#0 = aCod1; #referen1@#1 = aCod2; #referen1@#2 = aCod3; |FINSI;
               |SI aFic = "agifa290"; #referen1@#0 = aCod1; #referen1@#41 = aCod2; |FINSI;
               |SI aFic = "dsm00117"; #referen1@#0 = aCod1; |FINSI;

               |SI aFic = "dsm00209"; #referen1@#0 = aCod1; |FINSI;
               |SI aFic = "dsm00210"; #referen1@#0 = aCod1; #referen1@#1 = aCod2; |FINSI;
               |SI aFic = "dsm00211"; #referen1@#0 = aCod1; |FINSI;
               |SI aFic = "dsm00212"; #referen1@#0 = aCod1; #referen1@#1 = aCod2; |FINSI;
               |LEE 000#referen1@.=;
               |SALVA_DATOS #referen1@;
               |REPON_DATOS #referen2@;
               |GRABA 040#referen2@.n;
               |CIERRA #referen2@;
               |CIERRA #referen1@;
               |DESCARGA_DEF #referen2@;
               nHay = 1;
               #5#7 = "S";
               #5#8 = fFecha;
               #5#9 = aHora;
               #5#10 = aUsu;
               |GRABA 020#5a;
          |FINSI;
          |DESCARGA_DEF #referen1@;
     |FINSI;
     |LIBERA #5;
|FPRC;

|PROCESO Ini5;
     |DBASE aPath;
     aPath = aPath + "fich/T/";
     |MKDIR aPath;
     aPath = aPath + "00000/";
     |MKDIR aPath;

     |DFICE aFic;
     aOrg = aFic + "agifa200.dat"; aDes = aPath + "agifa200.dat"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aFic + "agifa200.ixx"; aDes = aPath + "agifa200.ixx"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aFic + "agifa200.ddx"; aDes = aPath + "agifa200.ddx"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aFic + "agifa208.dat"; aDes = aPath + "agifa208.dat"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aFic + "agifa208.ixx"; aDes = aPath + "agifa208.ixx"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aFic + "agifa208.ddx"; aDes = aPath + "agifa208.ddx"; |COPIA_FICHERO aOrg, aDes;

     |DDEF aAlfa;
     aAlfa = aAlfa + "rodm0005";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida = 0;
          |PATH_DAT #referen1@#aPath#;
          |ABRE #referen1@;
          |SELECT #2#5;
          #5#7 = "N";
          |LEE 000#5];
          |PARA; |SI FSalida = 0; |Y #5#7 = "N"; |HACIENDO;
               |SALVA_DATOS #5;
               |REPON_DATOS #referen1@;
               |GRABA 020#referen1@.n;
               |LEE 000#5s;
          |SIGUE;
          |CIERRA #referen1@;
          |DESCARGA_DEF #referen1@;
     |FINSI;

     #6#0 = 0;      || La Empresa0
     |GRABA 040#6n;
|FPRC;

|DEFBUCLE rodm0005;
     #5#1;
     7;
     00000000, "N";
     99999999, "N";
     be;
     Ini5, rodm0005;
|FIN;

|PROCESO rodm0003;
     enSwEjecuta = 1;
     eaSerie = #3#0;
     enCodigo = #3#1;
     eaSerRodAnt = #3#6;
     eaTipRodAnt = #3#7;
     aProg = "rodw0001;" + #3#2; |QBF aProg;
     enModo = #3#14;
     enForma = #3#15;
     enEmpresa = #3#12;
/*
     || quito el sub_ejecuta y a¤ado el cal
     |SUB_EJECUTA_NP aProg;
*/
     eaParametro = #3#2; |QBF eaParametro;
     |HAZ Inicio1;

     |SI enError = 0;
          #3#8 = "S";
          #3#9 = fFecha;
          #3#10 = aHora;
          #3#11 = aUsu;
          |GRABA 020#3a;

          #6#0 = #3#12;       ||Tmp Empresas
          |GRABA 040#6n;
          nHay = 1;
     |FINSI;
     |LIBERA #3;
|FPRC;

|DEFBUCLE rodm0003;
     #3#1;
     8;
     00000000, "N";
     99999999, "N";
     be;
     NULL, rodm0003;
|FIN;

|PROCESO Empresas;
     aEmp = ("00000" + #6#0) % -105;
     aAlfa = fFecha;
     aTar = (aAlfa % 704) + (aAlfa % 402) + (aAlfa % 102);
     aTar = aTar + (aHora % 102) + (aHora % 402) + (aHora % 702); ||Nom Fichero
     |SI #6#0 = 0;
          aNom = aPath + "fich/T/" + aEmp + "/";
          a1 = aNom + aTar + " *.*";
          a2 = aNom;
          |ATAR a1, a2;
          a1 = aNom + aTar;
          |COMPRIME a1;
          a1 = a1 + ".gz";
          a2 = aPath + "fich/" + aTar + ".gz";
          |RENOMBRA_FICHERO a1, a2;
          aDirectorio = aPath + "fich/T/00000/";
          |HAZ BorraDir;
          |MKDIR aDirectorio;
          |RENOMBRA_FICHERO a2, a1;
     |SINO;
          aNom = aPath + "fich/" + aEmp + "/";
          a1 = aNom + aTar + " agifa010.* agifa071.* dsm00043.* dsm00044.* rodw0007.*";
          a2 = aNom;
          |ATAR a1, a2;
          a1 = aNom + aTar;
          |COMPRIME a1;
          |FBORRA a1;
          a1 = a1 + ".gz";

          a2 = aPath + "fich/T/";
          |MKDIR a2;
          a2 = a2 + aEmp + "/";
          |MKDIR a2;
          a2 = a2 + aTar + ".gz";
          |RENOMBRA_FICHERO a1, a2;

          |DBASE aAlfa;
          aAlfa = aAlfa + "fich/" + aEmp + "/";
          |PATH_DAT #7 aAlfa;
          |PATH_DAT #10 aAlfa;
          |PATH_DAT #71 aAlfa;
          |PATH_DAT #43 aAlfa;
          |PATH_DAT #44 aAlfa;
          |DELINDEX #7;
          |DELINDEX #10;
          |DELINDEX #71;
          |DELINDEX #43;
          |DELINDEX #44;
     |FINSI;
|FPRC;

|DEFBUCLE Empresas;
     #6#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Empresas;
|FIN;

|PROCESO BorraDir;          ||Borra todos los archivos de aDirectorio
     direc = ""; |DIRECTORIO direc; |QBF direc;
     |SI aDirectorio ! "/";
          aAlfa1 = direc + "bin/agirm -r " + aDirectorio;
          |SYSTEM aAlfa1;
     |FINSI;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     eaRodExporta = "S"; || Para que no haga los tipos 15,16,17

     |ABRE #1; |LEE 000#1p; |CIERRA #1;
     |HORA aHora;
     fFecha = ~;
     aUsu = Usuario % 810;
     |SI  #0#1 = "SI";
          |ABRE #6;
          |BUCLE rodm0003;
          |BUCLE rodm0005;
          |CIERRA #6;
          |SI nHay = 1;
               |DBASE aPath;
               |BUCLE Empresas;

               aNom = aPath + "fich/"
               aAlfa = fFecha;
               aTar = (aAlfa % 704) + (aAlfa % 402) + (aAlfa % 102);
               aTar = aTar + (aHora % 102) + (aHora % 402) + (aHora % 702); ||Nom Fichero
               a1 = aNom + aTar + " T";
               a2 = aNom;
               |ATAR a1, a2;

               aDirectorio = aPath + "fich/T/";
               |HAZ BorraDir;

               aPath = #1#5; |QBF aPath;
               a1 = aNom + aTar;
               a2 = aPath + aTar + ".tar";
               |SI aSwLocal = "S";
                    |COPIA_FICHERO a1, a2;
               |SINO;
                    |ENVIA_FICHERO a1, a2;
               |FINSI;
               |SI FSalida = 0;
                    |FBORRA a1;
               |SINO;
                    aAlfa =  "0000ERROR al copiar fichero en cliente:" + aTar;
                    |MENAV aAlfa;
               |FINSI;
          |SINO;
               |MENAV "0000No hay registros a procesar...";
          |FINSI;
     |FINSI;
     eaRodExporta = "N";
|FPRC;

|PROGRAMA;
     |IP_REMOTO aAlfa;
     |SI aAlfa ! ""; aSwLocal = "N"; |SINO; aSwLocal = "S"; |FINSI;

     |HAZ CreaTempo; aTempo6 = Tempo;
     |NOME_DAT #6 aTempo6; |DELINDEX #6;
     |ABRE #0;
     |LEE 101#0p;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;
     |CLS;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |CIERRA #0;
     |DELINDEX #6; Tempo = aTempo6; |HAZ BoraTempo;
|FPRO;
