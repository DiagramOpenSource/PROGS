|FICHEROS;
   otpz0004 #0;

   otpw0007 #10;
   otpm0003 #11;
   otpm0005 #12;
   agifa084 #13;
   agifa069 #14;
   otpw0008 #15;

   dscam003@ #100;
   dscam045@ #101;
   dscam000@ #102;
   otp00004@ #103;
|FIN;

|VARIABLES;
   &enCostesImp = 0;
   &enAlumnos   = 0;

   aAlfa  = "";
   aAlfa1 = "";

   nSwRec = 0;
|FIN;

|PROCESO LineasFra;
   aAlfa = #agifa069#2; |QBF aAlfa;
   |SI aAlfa = "COSTESIMPCEBI";
      #otpw0008#0 = #otpm0003#3;
      |LEE 000#otpw0008.=;
      |SI FSalida ! 0;
         |DDEFECTO #otpw0008;
         #otpw0008#0 = #otpm0003#3;
         |GRABA 020#otpw0008.c;
      |FINSI;
      #otpw0008#2 = #otpw0008#2 + #agifa069#7;
      |GRABA 020#otpw0008.a;
   |FINSI;

   aAlfa = #agifa069#2;   |QBF aAlfa;
   aAlfa1 = #agifa069#31; |QBF aAlfa1;
   |SI aAlfa1 = "F"; |Y aAlfa = "-";
      #otpw0008#0 = #otpm0003#3;
      |LEE 000#otpw0008.=;
      |SI FSalida ! 0;
         |DDEFECTO #otpw0008;
         #otpw0008#0 = #otpm0003#3;
         |GRABA 020#otpw0008.c;
      |FINSI;
      #otpw0008#1 = #otpw0008#1 + 1;
      |GRABA 020#otpw0008.a;
   |FINSI;
|FPRC;

|DEFBUCLE LineasFra;
#agifa069#1;
;
#agifa084#48, #agifa084#0, 001;
#agifa084#48, #agifa084#0, 999;
;
NULL, LineasFra;
|FIN;

|PROCESO FrasCEBI;
   #agifa084#48 = #otpm0003#0;
   #agifa084#0  = #otpm0003#1;
   |LEE 000#agifa084.=;
   |SI FSalida ! 0; |DDEFECTO #agifa084; |FINSI;
   |BUCLE LineasFra;

   #otpm0005#1 = #otpm0003#11;
   |LEE 000#otpm0005.=;
   |SI FSalida = 0;
      |SI #otpm0005#0 < #otpz0004#0; |O #otpm0005#0 > #otpz0004#1; |ACABA; |FINSI;
   |SINO;
      aAlfa = "    El SPA " + #otpm0003#11; |QBF aAlfa;
      aAlfa = aAlfa + " no esta codificado en la tabla SPAs facturas CEBI. No se imprimira el expediente ";
      aAlfa = aAlfa + #otpm0003#3; |QBF aAlfa;
      |MENAV aAlfa; |ACABA;
   |FINSI;

   |SI #agifa084#1 < #otpz0004#4; |O #agifa084#1 > #otpz0004#5; |ACABA; |FINSI;

   #dscam045@#0 = #48#0;
   #dscam045@#1 = 1;
   |LEE 000#dscam045@.];
   |PARA; |SI FSalida = 0; |Y #dscam045@#0 = #48#0; |HACIENDO;
      |SI #otpm0003#0 ] #dscam045@#4; |Y #otpm0003#0 [ #dscam045@#5; |SAL; |FINSI;
      |LEE 000#dscam045@.s;
   |SIGUE;

   |SI #otpm0003#0 ] #dscam045@#4; |Y #otpm0003#0 [ #dscam045@#5;
      #dscam000@#0 = #dscam045@#6;
      |LEE 000#dscam000@.=;
      |SI FSalida ! 0; |DDEFECTO #dscam000@; |FINSI;
      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "contagen/fich/" + (("00000" + #dscam000@#14) % -105) + #dscam000@#19 + "/";
      |PATH_DAT #otp00004@#aAlfa#; |ABRE #otp00004@;
      |SELECT #3#otp00004@;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dscarter/fich/" + (("00000" + #dscam045@#6) % -105) + "/";
      |PATH_DAT #dscam003@#aAlfa#; |ABRE #dscam003@;
      |SELECT #9#dscam003@;
      nSwRec = 1;
   |SINO;
      nSwRec = 0;
   |FINSI;

   |DDEFECTO #otpw0007;
   #otpw0007#0  = #otpm0005#0;
   #otpw0007#1  = #otpm0003#3;
   #otpw0007#2  = #agifa084#3;
   #otpw0007#3  = #agifa084#4;
   #otpw0007#8  = #otpm0003#2;
   #otpw0007#9  = #otpm0003#4;
   #otpw0007#10 = #otpm0003#5;
   |SI nSwRec = 1;
      |DDEFECTO #dscam003@;

      #dscam003@#0  = #otpm0003#0;
      #dscam003@#1  = #otpm0003#1;
      #dscam003@#2  = 1;
      |LEE 000#dscam003@.];
      |PARA; |SI FSalida = 0; |Y #dscam003@#0 = #otpm0003#0; |Y #dscam003@#1 = #otpm0003#1; |HACIENDO;
         |SI #dscam003@#4 = #agifa084#1;
            |SAL;
         |FINSI;
         |LEE 000#dscam003@.s;
      |SIGUE;
      |SI FSalida = 0; |Y #dscam003@#0 = #otpm0003#0; |Y #dscam003@#1 = #otpm0003#1;
       |Y #dscam003@#4 = #agifa084#1;
         #otpw0007#4 = #dscam003@#40;
         #otpw0007#5 = #dscam003@#3;
         #otpw0007#6 = #dscam003@#30;
         |SI #dscam003@#14 = "P"; #otpw0007#11 = "Pendiente";    |FINSI;
         |SI #dscam003@#14 = "L"; #otpw0007#11 = "Al corriente"; |FINSI;
         |SI #dscam003@#14 = "I"; #otpw0007#11 = "Impagado";     |FINSI;
      |FINSI;

      #otp00004@#5 = #otpw0007#1;
      |LEE 000#otp00004@.=;
      |SI FSalida = 0;
         #otpw0007#7 = #otp00004@#4;
      |FINSI;
   |FINSI;
   #otpw0007#12 = #otpm0003#6;
   |GRABA 020#otpw0007.n;

   |SI nSwRec = 1;
      |SELECT #1#dscam003@; |CIERRA #dscam003@;
      |SELECT #1#otp00004@; |CIERRA #otp00004@;
   |FINSI;
|FPRC;

|DEFBUCLE FrasCEBI;
#otpm0003#2;
;
#otpz0004#2;
#otpz0004#3;
be;
NULL, FrasCEBI;
|FIN;

|PROCESO ImprimeExp;
   #otpw0008#0 = #otpw0007#1;
   |LEE 000#otpw0008.=;
   |SI FSalida ! 0; |DDEFECTO #otpw0008; |FINSI;

   |PRINT;
|FPRC;

|DEFBUCLE ImprimeExp;
#otpw0007#1;
;
INICIO;
FINAL;
;
NULL, ImprimeExp;
|FIN;

|PROCESO CreaTemporal;
   enCostesImp = 0; enAlumnos = 0;

   aAlfa = "tm" + Usuario; |NOME_DAT #otpw0007#aAlfa#;
   |DELINDEX #otpw0007; |ABRE #otpw0007;
   aAlfa = "tp" + Usuario; |NOME_DAT #otpw0008#aAlfa#;
   |DELINDEX #otpw0008; |ABRE #otpw0008;
   |ABRE #agifa084; |ABRE #otpm0003; |ABRE #otpm0005;
   |SELECT #2#otpm0005;

   |DBASS aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "dscarter/def/dscam000.mas";
   |CARGA_DEF aAlfa, dscam000@;
   |SI FSalida = 0;
      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dscarter/def/dscam045.mas";
      |CARGA_DEF aAlfa, dscam045@;
      |SI FSalida = 0;
         |DBASS aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + "dscarter/fich/";
         |PATH_DAT #dscam000@#aAlfa#; |PATH_DAT #dscam045@#aAlfa#;
         |ABRE #dscam000@; |ABRE #dscam045@;

         |DBASS aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + "dscarter/def/dscam003.mas";
         |CARGA_DEF aAlfa, dscam003@;
         |SI FSalida = 0;
            |DBASS aAlfa; |QBF aAlfa;
            aAlfa = aAlfa + "contagen/def/otp00004.mas";
            |CARGA_DEF aAlfa, otp00004@;
            |SI FSalida = 0;
               |BUCLE FrasCEBI;
               |DESCARGA_DEF #otp00004@;
            |FINSI;
            |DESCARGA_DEF #dscam003@;
         |FINSI;
         |CIERRA #dscam045@; |DESCARGA_DEF #dscam045@;
      |FINSI;
      |CIERRA #dscam000@; |DESCARGA_DEF #dscam000@;
   |FINSI;

   |SELECT #1#otpm0005;
   |CIERRA #otpm0005; |CIERRA #otpm0003;   |CIERRA #agifa084;

   Impresora = "CrystalReport";
   |IMPRE -1;
   |SI FSalida = 0;
      |INFOR "otpz0004";
      |SI FSalida = 0;
         |BUCLE ImprimeExp;
         |PIEINF; |FININF;
      |FINSI;
      |FINIMP;
   |FINSI;

   |CIERRA #otpw0008; |DELINDEX #otpw0008;
   |CIERRA #otpw0007; |DELINDEX #otpw0007;
|FPRC;

|PROGRAMA;
   |CLS;
   |CABEZA "Informe Facturas CEBI";

   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0; |HAZ CreaTemporal; |FINSI;
|FPRO;
