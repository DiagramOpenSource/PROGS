     SacaRiesgoPCEG, RiesgosPCEG, CamposModiPCEG

|FICHEROS;
     pcegm004 #104; ||Pedido
     pcegm005 #73;
     agifa024 #24;
     dsm00025 #25;
     dscamrie@ #100;
     dscam038@ #101;
     dscam023@ #102;
     dscam051@;
     dscam024@ #1004;
|FIN;

|VARIABLES;
     &enForma = 0;
     nImpaga = 0;
     &enSigno = 0;
     aDef104 = "";
     aAlfa2 = "";
     nCalc = 0;
     &eaSerie = "";
     &eaExisteCliRie = "";
     &eaRieSuma = "";
     &eaCodCliente = "";
     &eaNomCliente = "";

     &aRPath   = "";
     &aRNome   = "";

     &eaTag    = "";
     &aDef111  = "";
     &aDef222  = "";
     &aDef333  = "";
     &nRieTotal = 0;
     &nRieUtili = 0;
     &aRieBloqu = "";
     &aBloquead = "";
     &nImpo    = 0;

     aDef = "";
     aAlfa = "";
     aTecla    = "";
     aFin      = "";
     aCentro   = "";
     nHandle1  = 0;
     nHandle2  = 0;
     aDat1     = "";
     aDat2     = "";
     nPrime    = 0;

     aAlfa1    = "";
     aParam    = "";
     aDef1     = "";
     aDef2     = "";
     aDef3     = "";
     aDef4     = "";
     aPath     = "";
     dPath     = "";
     aMensa    = "";
     nCartera  = 0;
     swCar     = 0;
     nCart     = 0;

     aSer      = "";
     aCli      = "";
     aNomCli   = "";
     nTotal    = 0;
     nRiesgo   = 0;
     sumalin  = 0;
     aTipodo  = "";
     bAlfa     = "";

     aNomUsu = "";
     aModulo = "";
     aSN = "";
|FIN;


|RUTINA AbreRiesgoPCEG;
     nCartera = 0;

     |DBASS aPath;
     aMensa = ""; aDef111 = "";

     aDef111 = aPath + "dscarter/def/" + "dscamrie";
     |CARGA_DEF aDef111, dscamrie@;
     |SI FSalida ! 0;
          nCartera = -1;
          |ACABA;
     |FINSI;


     aDef222 = aPath + "dscarter/def/" + "dscam038";
     |CARGA_DEF aDef222, dscam038@;
     |SI FSalida ! 0;
          nCartera = -1;
          |ACABA;
     |FINSI;

     aDef333 = aPath + "dscarter/def/" + "dscam023";
     |CARGA_DEF aDef333, dscam023@;
     |SI FSalida ! 0;
          nCartera = -1;
          |ACABA;
     |FINSI;

     aDef104 = aPath + "dscarter/def/" + "dscam024";
     |CARGA_DEF aDef104, dscam024@;
     |SI FSalida ! 0;
          nCartera = -1;
          |ACABA;
     |FINSI;

     aAlfa = aPath + "dscarter/fich/";

     |PATH_DAT #101 aAlfa;

     |DBASE aPath;

     aRPath = aPath +"fich/";
     |PATH_DAT #100 aRPath;

     aRNome = Usuario;
     |NOME_DAT #100 aRNome;
|FRUT;

|PROCESO dscarm038PCEG;
     |SI #101#3 > aSer; |O #101#4 < aSer; |ACABA; |FINSI;

     |SI swCar = 0;
          swCar = 1;
          nCart = #101#5;
     |FINSI;

     |DDEFECTO #100;
     sumalin = sumalin + 1;
     #100#0 = aAlfa;
     #100#1 = sumalin;
     #100#2 = nCart;
     #100#3 = aTipodo;
     #100#4 = aSer;
     #100#5 = nRiesgo;
     #100#6 = aCli;
     #100#9 = aNomCli;
     |GRABA 020#100n;
     nCart = #101#5;
|FPRC;

|DEFBUCLE dscarm038PCEG;
     #101#2004;
     ;
     00001,aAlfa,aAlfa2,001;
     99999,aAlfa,aAlfa2,999;
     ;
     NULL,dscarm038PCEG;
|FIN;

|RUTINA AcumulaRiesgoPCEG;
     |SI nRiesgo = 0; |Y eaTag ! ""; |ACABA; |FINSI;

     |DFICE aAlfa; |QBF aAlfa; aAlfa = aAlfa % -106; aAlfa = aAlfa % 0105;

     |ABRE #100;
     || nCart = -1;
     swCar = 0; aAlfa2 = aTipodo > aTipodo;
     |BUCLE dscarm038PCEG;
     |CIERRA #100;
|FRUT;

|RUTINA CierraRiesgoPCEG;
     |SI aDef104 ! ""; |DESCARGA_DEF #dscam024@; |FINSI;
     |SI aDef333 ! ""; |DESCARGA_DEF #dscam023@; |FINSI;
     |SI aDef222 ! ""; |DESCARGA_DEF #dscam038@; |FINSI;
     |SI aDef111 ! ""; |DESCARGA_DEF #dscamrie@; |FINSI;
|FRUT;

|RUTINA EjecutaRiesgoPCEG;
     dPath = ":" + "dscarter/dsriesgo.tab;" + aAlfa;
     |SUB_EJECUTA_NP dPath;
|FRUT;

|PROCESO RiesgosPCEG;
     nRiesgo = 0;
     aTipodo = "";
     sumalin = 0;
     nCart   = 0;
     swCar   = 0;
     |SI eaTag = "";
          aCli = #24#0;
          aNomCli = #24#1;
          aTipodo = "A";
          |HAZ AbreRiesgoPCEG;
          |SI nCartera ! 0;   |ACABA;   |FINSI;
          |HAZ AcumulaRiesgoPCEG;
          |HAZ CierraRiesgoPCEG;
          |HAZ EjecutaRiesgoPCEG;
     |FINSI;
     |SI eaTag = "PE";
          aSer = #104#25;
          aCli = #104#4;
          aNomCli = #104#8;
          |SI nImpo = 0;
             nRiesgo = 0 + (#104#12 * enForma);
          |SINO;
             nRiesgo = 0 + (nImpo * enForma);
          |FINSI;
          |SI enSigno ! 0;
             nRiesgo = nRiesgo * enSigno;
          |FINSI;
          aTipodo = "P";
          |HAZ AbreRiesgoPCEG;
          |SI nCartera ! 0;   |ACABA;   |FINSI;
          |HAZ AcumulaRiesgoPCEG;
          |HAZ CierraRiesgoPCEG;
          |HAZ EjecutaRiesgoPCEG;
     |FINSI;
|FPRC;

|PROCESO ImpagadoPCEG;
     nImpaga = nImpaga + #1004#7;
|FPRC;

|DEFBUCLE ImpagadoPCEG;
     #1004#1002;
     ;
     #102#0, 01;
     #102#0, 99;
     ;
     NULL, ImpagadoPCEG;
|FIN;

|PROCESO sacadatosPCEG;
     aAlfa = aPath + "dscarter/fich/" + (("00000" + #dscam038@#5) % -105) + "/";
     |PATH_DAT #dscam051@#aAlfa#; |ABRE #dscam051@;
     |LEE 000#dscam051@.p;
     |SI FSalida ! 0; |DDEFECTO #dscam051@; |FINSI;

     |SI #101#5 ! 0;
          |SI eaTag = ""; |Y #101#2 = "A"; eaRieSuma = "S"; |FINSI;
          |SI eaTag = "PE"; |Y #101#2 = "P"; eaRieSuma = "S"; |FINSI;
          |SI eaTag = "AV"; |Y #101#2 = "A"; eaRieSuma = "S"; |FINSI;
          |SI eaTag = "FD"; |Y #101#2 = "F"; eaRieSuma = "S"; |FINSI;
          |SI eaTag = "PORTATIL"; |Y #101#2 = "P"; eaRieSuma = "S"; |FINSI;

          bAlfa = #101#5;
          |QBF bAlfa;
          bAlfa = ( "00000" + bAlfa) % -105;
          aAlfa = aPath + "dscarter/fich/" + bAlfa + "/";
          |PATH_DAT #102 aAlfa;
          |PATH_DAT #1004 aAlfa;

          |ABRE #102;
          #102#0 = aCli;
          |LEE 000#102=;
          |SI FSalida = 0;
               eaExisteCliRie = "S";
               |SI nCart ! #101#5;
                    aAlfa = "|NC"; aAlfa = #dscam051@#aAlfa#; nCalc = aAlfa;
                    |SI nCalc ] 105;
                       |SI #dscam051@#105 = "S";
                          |SI eaSerie ] #dscam038@#3; |Y eaSerie [ #dscam038@#4;
                             nRieTotal = nRieTotal + #102#19;
                             nRieUtili = nRieUtili + #102#20;
                             nCart = #101#5;
                          |FINSI;
                       |SINO;
                          nRieTotal = nRieTotal + #102#19;
                          nRieUtili = nRieUtili + #102#20;
                          nCart = #101#5;
                       |FINSI;
                    |SINO;
                       nRieTotal = nRieTotal + #102#19;
                       nRieUtili = nRieUtili + #102#20;
                       nCart = #101#5;
                    |FINSI;
               |FINSI;
               |SI #102#9 = "S";
                    aRieBloqu = "S";
                    aBloquead = #102#10;
               |FINSI;
               |SI #102#9 = "A";
                    nImpaga = 0;
                    |BUCLE ImpagadoPCEG;
                    |SI nImpaga > 0;
                         aRieBloqu = "S";
                         aBloquead = #102#10;
                    |FINSI;
               |FINSI;
          |FINSI;
          |CIERRA #102;
     |FINSI;
     |CIERRA #dscam051@;
|FPRC;

|DEFBUCLE sacadatosPCEG;
     #101#2004;
     ;
     00001,#48#0," ",001;
     99999,#48#0,"z",999;
     ;
     NULL,sacadatosPCEG;
|FIN;

|PROCESO SacaRiesgoPCEG;
     |HAZ AbreRiesgoPCEG;
     |SI nCartera ! 0;   |ACABA;   |FINSI;
     nRieTotal  = 0;
     nRieUtili  = 0;
     aRieBloqu  = "";
     aBloquead  = "";
     swCar      = 0;
     nCart      = 0;
     eaRieSuma = "N";

     |SI eaTag = "PE";
          aCli = #104#4;
          aNomCli = #104#8;
     |FINSI;

     eaTag = eaTag % 108;
     |SI eaTag = "PORTATIL";
          aCli = eaTag % 906;
          aNomCli = eaTag % 1630;
     |FINSI;
     |SI eaTag = "";
        aCli = eaCodCliente;
        aNomCli = eaNomCliente;
     |FINSI;
     |DBASS aPath;
     eaExisteCliRie = "N";

     |DBASS aAlfa; aAlfa = aAlfa + "dscarter/def/dscam051.mas"
     |CARGA_DEF aAlfa, dscam051@;
     |SI FSalida ! 0;
        |MENAV "    No encuentro el def de parametros generales de cartera";
     |SINO;
        |BUCLE sacadatosPCEG;
        |DESCARGA_DEF #dscam051@;
     |FINSI;

     |HAZ CierraRiesgoPCEG;
|FPRC;


|PROCESO CamposModiPCEG; |TIPO 7;
     aNomUsu = Usuario % 810;
     |MODULO aModulo;
     |SI aModulo = "dsz99953"; |O aModulo = "dsz99914";
          aModulo = "agifa010";
     |FINSI;

     |ABRE #25;
     #25#0 = aNomUsu;
     |LEE 000#25=;
     |SI FSalida = 0;
          ||컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
          |SI aModulo = "agifa104";
               |C_M #104#9,  0, aSN;              || FP
               |SI aSN = "S"; |Y #25#87 = "N";
                    |C_M #104#9, 1, "N";
               |FINSI;
               |C_M #73#3,  0, aSN;              || Alma
               |SI aSN = "S"; |Y #25#1 = "N";
                    |C_M #73#3, 1, "N";
               |FINSI;
               |C_M #73#6, 0, aSN;              || Precio
               |SI aSN = "S"; |Y #25#2 = "N";
                    |C_M #73#6, 1, "N";
               |FINSI;
               |C_M #73#36, 0, aSN;              || Precio
               |SI aSN = "S"; |Y #25#2 = "N";
                    |C_M #73#36, 1, "N";
               |FINSI;
               |C_M #73#8,  0, aSN;              || Dto1
               |SI aSN = "S"; |Y #25#3 = "N";
                    |C_M #73#8, 1, "N";
               |FINSI;
               |C_M #73#29, 0, aSN;              || Dto2
               |SI aSN = "S"; |Y #25#4 = "N";
                    |C_M #73#29, 1, "N";
               |FINSI;
               |C_M #73#10, 0, aSN;              || Comi
               |SI aSN = "S"; |Y #25#5 = "N";
                    |C_M #73#10, 1, "N";
               |FINSI;
               |C_M #73#27, 0, aSN;              || DA
               |SI aSN = "S"; |Y #25#6 = "N";
                    |C_M #73#27, 1, "N";
               |FINSI;
               |C_M #73#14, 0, aSN;              || IVA
               |SI aSN = "S"; |Y #25#7 = "N";
                    |C_M #73#14, 1, "N";
               |FINSI;
               |C_M #73#22, 0, aSN;              || Rese
               |SI aSN = "S"; |Y #25#8 = "N";
                    |C_M #73#22, 1, "N";
               |FINSI;
               |C_M #73#15, 0, aSN;              || Bloq
               |SI aSN = "S"; |Y #25#9 = "N";
                    |C_M #73#15, 1, "N";
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #25;
|FPRC;
