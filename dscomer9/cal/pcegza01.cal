|FICHEROS;
   pcegz101 #0;

   agifa133 #10;
   pcegw016 #11;
   pcegm045 #12;
   pcegm046 #13;
   pcegw017 #14;
   agifa134 #15;
   agifa084 #16;

   Referen@ #1000;
|FIN;

|VARIABLES;
   &eaPath = "";
   &eaFich = "";

   aPathEmp = "";
   aPathBas = "";
   aAlfa   = "";
   aAlfa1  = "";
   aAlfa2  = "";
   aAlfa3  = "";
   aAstosCsv = "";
   aClienCsv = "";
   aSepara   = "";
   aIP       = "";

   nLinea  = 0;
   nTipo   = 0;
   fFecha  = @;
   fFechaFac = @;

   nHandle1 = 0;
   nHandle2 = 0;
   nCalc   = 0;
   nCalc1  = 0;
   nCalc2  = 0;
   nCont   = 0;
   nNumSec = 0;
   nTipoIVA = 0;
   aHoraAnt = "";

   nSwGraba = 0;
   nNroAgrupa = 0;

   aBase1  = ""; aBase2  = ""; aBase3  = ""; aBase4  = "";
   aCuota1 = ""; aCuota2 = ""; aCuota3 = ""; aCuota4 = "";
   aTotFac = "";
|FIN;

|PROCESO GrabaParte1;
   aAlfa = "1" + aSepara + "" + aSepara + "" + aSepara;
   aAlfa = aAlfa + " " + aSepara + " " + aSepara + " " + aSepara + " " + aSepara + " " + aSepara;
   aAlfa = aAlfa + ""  + aSepara + " " + aSepara + ""  + aSepara;
   |SI #pcegw016#2 ! "I";
      aAlfa = aAlfa + "1" + aSepara;
   |SINO;
      aAlfa = aAlfa + "" + aSepara;
   |FINSI;
   aAlfa = aAlfa + " " + aSepara + ""  + aSepara;
   |XGRABA nHandle1, aAlfa;
|FPRC;

|PROCESO GrabaParte2;
   aAlfa =   " " + aSepara + "" + aSepara + " " + aSepara + " " + aSepara;
   aAlfa = aAlfa + " " + aSepara + "" + aSepara;
   aAlfa = aAlfa + " " + aSepara + "" + aSepara + "" + aSepara + "" + aSepara + "" + aSepara;
   aAlfa = aAlfa + ""  + aSepara + "" + aSepara + "" + aSepara + "" + aSepara;
   aAlfa = aAlfa + ""  + aSepara + "" + aSepara + "" + aSepara + "999999" + aSepara;
   aAlfa = aAlfa + nNroAgrupa + aSepara + "S" + aSepara + "N" + &13 + &10;
   |XGRABA nHandle1, aAlfa;
|FPRC;

|PROCESO SecuencialCli;
   aAlfa = #pcegw016#24; |QBF aAlfa; |SI aAlfa = ""; |ACABA; |FINSI;

   aAlfa = #pcegw016#24; |QBF aAlfa; aAlfa = aAlfa + aSepara;
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = #pcegw016#25; |QBF aAlfa; aAlfa = aAlfa + aSepara;
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = (" " * 60) + aSepara; || Nombre de fantasia
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = (" " * 11) + aSepara; || RUT auxiliar
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = (" " * 1) + aSepara; || Activo
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = (" " * 3) + aSepara; || Codigo giro comercial
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = (" " * 3) + aSepara; || Codigo pais auxiliar
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = "" + aSepara;                   || Codigo de region
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = (" " * 7)  + aSepara; || Codigo ciudad
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = (" " * 7)  + aSepara; || Codigo comuna
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = (" " * 60) + aSepara; || Direccion auxiliar
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = (" " * 10) + aSepara; || Numero dir.
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =         (" " * 15) + aSepara; || Telefono auxiliar 1
   aAlfa = aAlfa + (" " * 15) + aSepara; || Telefono auxiliar 2
   aAlfa = aAlfa + (" " * 15) + aSepara; || Telefono auxiliar 3
   aAlfa = aAlfa + (" " * 15) + aSepara; || Fax auxiliar 1
   aAlfa = aAlfa + (" " * 15) + aSepara; || Fax auxiliar 2
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =         "N" + aSepara;        || Clasificacion cliente
   aAlfa = aAlfa + "N" + aSepara;        || Clasificacion proveedor
   aAlfa = aAlfa + "N" + aSepara;        || Clasificacion empleado
   aAlfa = aAlfa + "N" + aSepara;        || Clasificacion socio
   aAlfa = aAlfa + "N" + aSepara;        || Clasificacion distribuidor
   aAlfa = aAlfa + "N" + aSepara;        || Clasificacion otro
   aAlfa = aAlfa + " " * 15  + aSepara;  || Casilla auxiliar
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 100);
   aAlfa = aAlfa + (" " * 100);
   aAlfa = aAlfa + (" " * 50) + aSepara;                 || E-Mail auxiliar
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 100);
   aAlfa = aAlfa + (" " * 100);
   aAlfa = aAlfa + (" " * 50) + aSepara;                 || Sitio web auxiliar
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 100);
   aAlfa = aAlfa + (" " * 100);
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = " " * 55 + aSepara;                          || Notas auxiliar
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa = (" " * 30) + aSepara;         || Nombre de contacto
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = "    " + aSepara;             || Codigo cargo contacto
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = (" " * 15) + aSepara;         || Telefono de contacto
   |XGRABA nHandle2, aAlfa; aAlfa = "";
   aAlfa = (" " * 15) + aSepara;         || Fax de contacto
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =         (" " * 100);
   aAlfa = aAlfa + (" " * 100);
   aAlfa = aAlfa + (" " * 50) + aSepara;       || E-Mail de contacto
   |XGRABA nHandle2, aAlfa; aAlfa = "";

                                                     || Codigo vendedor y
                                                     ||   condicion de venta
   aAlfa =   "    " + aSepara + "   " + aSepara;
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   ||aAlfa = ("0" * 20) + aSepara;
   aAlfa = "" + aSepara;
   |XGRABA nHandle2, aAlfa; aAlfa = "";              || Monto autorizado

                                                     || Codigo categoria cliente y
                                                     || Codigo zona
   aAlfa =   "   " + aSepara + "  " + aSepara;
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   "   " + aSepara;            || Codigo canal venta
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 30) + aSepara;       || Lugar despacho
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 60) + aSepara;       || Direccion despacho
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 7) + aSepara;        || Codigo comuna
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 7) + aSepara;        || Codigo ciudad despacho
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 3) + aSepara;        || Codigo pais despacho
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 15) + aSepara;       || Telefono 1 despacho
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 15) + aSepara;       || Telefono 2 despacho
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 15) + aSepara;       || Telefono 3 despacho
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 15) + aSepara;       || Fax despacho
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 60) + aSepara;       || Atencion despacho
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 3) + aSepara;        || Codigo cobrador
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 60) + aSepara;       || Direccion cobranza
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 7) + aSepara;       || Codigo comuna cobranza
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 7) + aSepara;       || Codigo ciudad cobranza
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 3) + aSepara;       || Codigo pais cobranza
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 15) + aSepara;      || Telefono
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   ||aAlfa = "00" + aSepara;                          || Dia de pago
   aAlfa = "" + aSepara;                          || Dia de pago
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 3) + aSepara;       || Codigo lista precio
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa =   (" " * 100);
   aAlfa = aAlfa + (" " * 100);
   aAlfa = aAlfa + (" " * 50) + aSepara;       || E-Mail DTE
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa = "N" + aSepara;                || Receptor documentos electronicos
   |XGRABA nHandle2, aAlfa; aAlfa = "";

   aAlfa = "      " + &13 + &10; || Codigo clasif.Negocio
   |XGRABA nHandle2, aAlfa; aAlfa = "";
|FPRC;

|PROCESO Secuencial;
   #agifa133#4 = #pcegw016#0;
   #agifa133#0 = #pcegw016#1;
   #agifa133#1 = 1;
   |LEE 000#agifa133.];
   |SI FSalida ! 0; |O #agifa133#4 ! #pcegw016#0; |O #agifa133#0 ! #pcegw016#1;
      |DDEFECTO #agifa133;
   |FINSI;

   aAlfa = #pcegw016#4; |QBF aAlfa; aAlfa = aAlfa + aSepara; |XGRABA nHandle1, aAlfa;
   aAlfa = #pcegw016#6; |QBF aAlfa;
   |SI #pcegw016#5 = "H";
      ||aAlfa = "0" + aSepara + aAlfa + aSepara;
      aAlfa = "" + aSepara + aAlfa + aSepara;
   |SINO;
      || aAlfa = aAlfa + aSepara + "0" + aSepara;
      aAlfa = aAlfa + aSepara + "" + aSepara;
   |FINSI;
   |XGRABA nHandle1, aAlfa;

   aAlfa = (("000" + #pcegw016#7) % -103) + " " + #pcegw016#8; |QBF aAlfa;
   aAlfa = aAlfa + aSepara; |XGRABA nHandle1, aAlfa;

   |HAZ GrabaParte1;

   aAlfa = #pcegw016#24; |QBF aAlfa; aAlfa = aAlfa + aSepara; |XGRABA nHandle1, aAlfa;

   |SI #pcegw016#2 = "F";
      aAlfa = #pcegw016#0; |QBF aAlfa;
      aAlfa = aAlfa % 0102;
      |XGRABA nHandle1, aAlfa;
      |SI #pcegw016#1 = 0; aAlfa = ""; |SINO; aAlfa = #pcegw016#1; |QBF aAlfa; |FINSI;
      aAlfa = aSepara + aAlfa + aSepara; |XGRABA nHandle1, aAlfa;
      aAlfa = #pcegw016#9; |QBF aAlfa; aAlfa = (aAlfa % 102) + "/" + (aAlfa % 402) + "/" + (aAlfa % 704);
      aAlfa = aAlfa + aSepara; |XGRABA nHandle1, aAlfa;
      aAlfa = #agifa133#3; |QBF aAlfa; aAlfa = (aAlfa % 102) + "/" + (aAlfa % 402) + "/" + (aAlfa % 704);
      aAlfa = aAlfa + aSepara; |XGRABA nHandle1, aAlfa;

      aAlfa = #pcegw016#0; |QBF aAlfa; aAlfa = aAlfa % 0102; |XGRABA nHandle1, aAlfa;
      |SI #pcegw016#1 = 0; aAlfa = ""; |SINO; aAlfa = #pcegw016#1; |QBF aAlfa; |FINSI;
      aAlfa = aSepara + aAlfa + aSepara; |XGRABA nHandle1, aAlfa;

      |HORA aAlfa; |QBF aAlfa;
      |SI aAlfa ! aHoraAnt;
         nNumSec = 0; aHoraAnt = aAlfa;
         aAlfa = (aAlfa % 0702) + (aAlfa % 0402) + (aAlfa % 0102);
         nNumSec = aAlfa; nNumSec = nNumSec * 1000000;
         fFecha = ~; nCalc = fFecha; nNumSec = nNumSec + nCalc;
         nNumSec = nNumSec * 100;
      |FINSI;
      aAlfa1 = nNumSec; nNumSec = nNumSec + 1;
      aAlfa = " " + aSepara; |XGRABA nHandle1, aAlfa;

      |SI #pcegw016#12 = 0; aBase1  = ""; |SINO; aBase1  = #pcegw016#12; |FINSI;
      |SI #pcegw016#11 = 0; aBase2  = ""; |SINO; aBase2  = #pcegw016#11; |FINSI;
      |SI #pcegw016#13 = 0; aBase3  = ""; |SINO; aBase3  = #pcegw016#13; |FINSI;
      |SI #pcegw016#14 = 0; aBase4  = ""; |SINO; aBase4  = #pcegw016#14; |FINSI;
      |SI #pcegw016#16 = 0; aCuota1 = ""; |SINO; aCuota1 = #pcegw016#16; |FINSI;
      |SI #pcegw016#15 = 0; aCuota2 = ""; |SINO; aCuota2 = #pcegw016#15; |FINSI;
      |SI #pcegw016#17 = 0; aCuota3 = ""; |SINO; aCuota3 = #pcegw016#17; |FINSI;
      |SI #pcegw016#18 = 0; aCuota4 = ""; |SINO; aCuota4 = #pcegw016#18; |FINSI;
      |SI #pcegw016#19 = 0; aTotFac = ""; |SINO; aTotFac = #pcegw016#19; |FINSI;

      aAlfa =         aBase1  + aSepara + aBase2 + aSepara + aBase3 + aSepara;
      aAlfa = aAlfa + aBase4  + aSepara + aCuota1 + aSepara + aCuota2 + aSepara;
      aAlfa = aAlfa + aCuota3 + aSepara + aCuota4 + aSepara + "" + aSepara + aTotFac + aSepara;
      |XGRABA nHandle1, aAlfa;

      aAlfa = "" + aSepara + "999999" + aSepara + nLinea + aSepara + "S" + aSepara + "N" + &13 + &10; |XGRABA nHandle1, aAlfa;
      nNroAgrupa = nLinea; nLinea = nLinea + 1;

      #pcegw017#0 = #pcegw016#24;
      |LEE 000#pcegw017.=;
      |SI FSalida ! 0;
         |DDEFECTO #pcegw017;
         #pcegw017#0 = #pcegw016#24;
         #pcegw017#1 = #pcegw016#25;
         |GRABA 020#pcegw017.n;

         |HAZ SecuencialCli;
      |FINSI;
   |SINO;
      |HAZ GrabaParte2;
   |FINSI;
|FPRC;

|DEFBUCLE Secuencial;
#pcegw016#2;
;
INICIO;
FINAL;
;
NULL, Secuencial;
|FIN;

|PROCESO Temporal;
   |SI #Referen@#26 = "D"; |O #Referen@#26 = "R"; |ACABA; |FINSI;
   |SI #Referen@#9 = 0; |ACABA; |FINSI;

   |SI #Referen@#26 = "F";
      nLinea = 1;

      #agifa133#4 = #Referen@#12;
      #agifa133#0 = #Referen@#13;
      #agifa133#1 = 1;
      |LEE 000#agifa133.];
      |SI FSalida ! 0; |O #agifa133#4 ! #Referen@#12; |O #agifa133#0 ! #Referen@#13;
         |DDEFECTO #agifa133;
      |FINSI;

      |DDEFECTO #pcegw016;
      #pcegw016#0  = #Referen@#12;
      #pcegw016#1  = #Referen@#13;
      #pcegw016#2  = #Referen@#26;
      #pcegw016#3  = 0;
      #pcegw016#4  = #Referen@#4;
      #pcegw016#5  = #Referen@#8;
      #pcegw016#6  = #Referen@#9;
      #pcegw016#7  = #Referen@#6;
      #pcegw016#8  = #Referen@#7;
      #pcegw016#9  = #Referen@#29;
      #pcegw016#10 = #agifa133#3;
      #pcegw016#19 = #Referen@#9;
      #pcegw016#26 = nLinea; nLinea = nLinea + 1;

      aAlfa = #Referen@#44; |QBF aAlfa;
      aAlfa1 = aAlfa % 0; nCalc = aAlfa1; aAlfa2 = "";
      |PARA; |SI aAlfa ! ""; |HACIENDO;
         aAlfa1 = aAlfa % 0101; aAlfa = aAlfa % 0299;
         |SI aAlfa1 ] "0"; |Y aAlfa1 [ "9";
            aAlfa2 = aAlfa2 + aAlfa1;
         |FINSI;
      |SIGUE;
      #pcegw016#24 = aAlfa2;
      #pcegw016#25 = #Referen@#43;
      fFechaFac = #pcegw016#9;

      |GRABA 020#pcegw016.n;
   |SINO;
      nTipoIVA = 0;
      |SI #Referen@#28 [ 0;
         |SI #Referen@#27 ! 0;
            |ABRE #agifa134; |ABRE #agifa084;
            #agifa134#49 = #pcegw016#0;
            #agifa134#0  = #pcegw016#1;
            |LEE 000#agifa134.=;
            |SI FSalida = 0;
               |SI #Referen@#27 > 5; nTipoIVA = 0;            |FINSI;
               |SI #Referen@#27 = 1; nTipoIVA = #agifa134#39; |FINSI;
               |SI #Referen@#27 = 2; nTipoIVA = #agifa134#41; |FINSI;
               |SI #Referen@#27 = 3; nTipoIVA = #agifa134#43; |FINSI;
               |SI #Referen@#27 = 4; nTipoIVA = #agifa134#50; |FINSI;
               |SI #Referen@#27 = 5; nTipoIVA = #agifa134#52; |FINSI;
            |SINO;
               #agifa084#48 = #pcegw016#0;
               #agifa084#0  = #pcegw016#1;
               |LEE 000#agifa084.=;
               |SI FSalida = 0;
                  |SI #Referen@#27 > 5; nTipoIVA = 0;            |FINSI;
                  |SI #Referen@#27 = 1; nTipoIVA = #agifa084#50; |FINSI;
                  |SI #Referen@#27 = 2; nTipoIVA = #agifa084#52; |FINSI;
                  |SI #Referen@#27 = 3; nTipoIVA = #agifa084#54; |FINSI;
                  |SI #Referen@#27 = 4; nTipoIVA = #agifa084#56; |FINSI;
                  |SI #Referen@#27 = 5; nTipoIVA = #agifa084#58; |FINSI;
               |FINSI;
            |FINSI;
            |CIERRA #agifa084; |CIERRA #agifa134;
         |FINSI;
      |SINO;
         nTipoIVA = #Referen@#28;
      |FINSI;

      #pcegw016#0  = #Referen@#12;
      #pcegw016#1  = #Referen@#13;
      #pcegw016#2  = #Referen@#26;
      #pcegw016#3  = nTipoIVA;
      #pcegw016#4  = #Referen@#4;
      |LEE 000#pcegw016.=;
      |SI FSalida ! 0;
         |DDEFECTO #pcegw016;
         #pcegw016#0  = #Referen@#12;
         #pcegw016#1  = #Referen@#13;
         #pcegw016#2  = #Referen@#26;
         #pcegw016#3  = nTipoIVA;
         #pcegw016#4  = #Referen@#4;
         #pcegw016#5  = #Referen@#8;
         #pcegw016#6  = #Referen@#9;
         #pcegw016#7  = #Referen@#6;
         #pcegw016#8  = #Referen@#7;
         #pcegw016#26 = nLinea; nLinea = nLinea + 1;
         |GRABA 020#pcegw016.n;
      |FINSI;

      #pcegw016#0  = #Referen@#12;
      #pcegw016#1  = #Referen@#13;
      #pcegw016#2  = "F";
      #pcegw016#3  = 0;
      #pcegw016#4  = "";
      |LEE 000#pcegw016.];
      |SI FSalida = 0; |Y #pcegw016#0 = #Referen@#12; |Y #pcegw016#1 = #Referen@#13;
       |Y #pcegw016#2 = "F"; |Y #pcegw016#3  = 0;
         nTipo = 0;
         |PARA nCont = 20; |SI nCont [ 23; |HACIENDO nCont = nCont + 1;
            |SI nTipoIVA = #pcegw016#nCont#;
               |SI #Referen@#26 = "B";
                  nCalc = nCont - 9;
                  #pcegw016#nCalc# = #pcegw016#nCalc# + #Referen@#9;

                  nCalc = nCont - 4;
                  |SI #pcegw016#nCont# = 0; |Y #pcegw016#nCalc# ! 0;
                     nCalc = nCont - 9; nCalc1 = nCont - 4;
                     #pcegw016#nCalc1# = (#pcegw016#nCalc# % #pcegw016#nCont#) ! 2;
                  |FINSI;

                  nTipo = nCont - 19;
               |FINSI;
               |SI #pcegw016#nCont# ! 0;
                  |SI #Referen@#26 = "I";
                     nCalc = nCont - 5;
                     #pcegw016#nCalc# = #pcegw016#nCalc# + #Referen@#9;
                     nTipo = nCont - 19;
                  |FINSI;
               |FINSI;
            |FINSI;
         |SIGUE;

         |SI nTipo = 0; |Y nTipoIVA ! 0;
            |SI #Referen@#27 = 0; |O #Referen@#27 > 4;
               |SI #pcegw016#20 = 0;               #pcegw016#20 = nTipoIVA; nTipo = 1; |FINSI;
               |SI #pcegw016#21 = 0; |Y nTipo = 0; #pcegw016#21 = nTipoIVA; nTipo = 2; |FINSI;
               |SI #pcegw016#22 = 0; |Y nTipo = 0; #pcegw016#22 = nTipoIVA; nTipo = 3; |FINSI;
               |SI #pcegw016#23 = 0; |Y nTipo = 0; #pcegw016#23 = nTipoIVA; nTipo = 4; |FINSI;
               |SI nTipo ! 0;
                  nCalc = nTipo + 10;
                  |SI #Referen@#26 = "B"; #pcegw016#nCalc# = #pcegw016#nCalc# + #Referen@#9; |FINSI;
                  nCalc = nTipo + 14;
                  |SI #Referen@#26 = "I"; |Y nTipoIVA ! 0;
                     #pcegw016#nCalc# = #pcegw016#nCalc# + #Referen@#9;
                  |FINSI;
               |FINSI;
            |SINO;
               |SI #Referen@#26 = "B";
                  nCalc = 10 + #Referen@#27; #pcegw016#nCalc# = #pcegw016#nCalc# + #Referen@#9;
                  |SI nTipoIVA ] 0;
                     nCalc = 19 + #Referen@#27; #pcegw016#nCalc# = nTipoIVA;
                  |FINSI;
               |FINSI;
               |SI #Referen@#26 = "I";
                  nCalc = 14 + #Referen@#27; #pcegw016#nCalc# = #pcegw016#nCalc# + #Referen@#9;
               |FINSI;
            |FINSI;
         |FINSI;
         |GRABA 020#pcegw016.a;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Temporal;
#Referen@#1006;
;
00, "01.01.0000", 000000, 0000, 00000, 0;
99, "31.12.9999", 999999, 9999, 99999, 9;
;
NULL, Temporal;
|FIN;

|PROCESO RevisaTempo;
   nSwGraba = 0;
   |PARA nCont = 20; |SI nCont [ 23; |HACIENDO nCont = nCont + 1;
      nCalc = nCont - 5; nCalc1 = nCont - 9;
      |SI #pcegw016#nCont# ! 0; |Y #pcegw016#nCalc# = 0;
         nCalc2 = (#pcegw016#nCont# / 100) ! 2;
         #pcegw016#nCalc# = (#pcegw016#nCalc1# * nCalc2) ! 2;
         nSwGraba = 1;
      |FINSI;
   |SIGUE;

   |SI nSwGraba ! 0; |GRABA 020#pcegw016.a; |FINSI;
|FPRC;

|DEFBUCLE RevisaTempo;
#pcegw016#1;
;
INICIO;
FINAL;
;
NULL, RevisaTempo;
|FIN;

|PROCESO MiraRutaValida;
   aAlfa = #pcegz101#0; |QBF aAlfa;
   aAlfa1 = aAlfa % -101;
   |SI aAlfa1 ! "/"; |Y aAlfa1 ! "\";
      aAlfa1 = aAlfa - "/";
      |SI FSalida ! 0;
         aAlfa = #pcegz101#0; |QBF aAlfa;
         aAlfa = aAlfa + "/"; #pcegz101#0 = aAlfa; |PINTA #pcegz101#0;
      |SINO;
         aAlfa1 = aAlfa - "\";
         |SI FSalida ! 0;
            aAlfa = #pcegz101#0; |QBF aAlfa;
            aAlfa = aAlfa + "\"; #pcegz101#0 = aAlfa; |PINTA #pcegz101#0;
         |FINSI;
      |FINSI;
   |FINSI;

   aAlfa = #pcegz101#0; |QBF aAlfa;
   aAlfa = aAlfa + "prueba.txt";
   |XABRE "CW", aAlfa, nHandle1;
   |SI FSalida ] 0;
      aAlfa = "Prueba"; |XGRABA nHandle1, aAlfa;
      |XCIERRA nHandle1;

      aAlfa = #pcegz101#0; |QBF aAlfa;
      aAlfa = aAlfa + "prueba.txt";
      |XABRE "C", aAlfa, nHandle1;
      |SI FSalida ] 0;
         |XLEE nHandle1, 250, aAlfa;
         |SI FSalida < 0; |O aAlfa ! "Prueba";
            |XCIERRA nHandle1;
            |MENAV "    Ruta no valida. Indique otra."; |ERROR;
         |SINO;
            |XCIERRA nHandle1;
            aAlfa = #pcegz101#0; |QBF aAlfa;
            aAlfa = aAlfa + "prueba.txt"; |RFBORRA aAlfa;
         |FINSI;
      |SINO;
         |MENAV "    Ruta no valida. Indique otra."; |ERROR;
      |FINSI;
   |SINO;
      |MENAV "    Ruta no valida. Indique otra."; |ERROR;
   |FINSI;
|FPRC;

|PROCESO CopiaFicheros;
   aIP = ""; |IP_REMOTO aIP;

   |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + aAstosCsv;
   aAlfa1 = #pcegz101#0; |QBF aAlfa1; aAlfa1 = aAlfa1 + aAstosCsv;
   |SI aIP ! "";
      |ENVIA_FICHERO aAlfa, aAlfa1;
   |SINO;
      |COPIA_FICHERO aAlfa, aAlfa1;
   |FINSI;
   |FBORRA aAlfa;

   |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + aClienCsv;
   aAlfa1 = #pcegz101#0; |QBF aAlfa1; aAlfa1 = aAlfa1 + aClienCsv;
   |SI aIP ! "";
      |ENVIA_FICHERO aAlfa, aAlfa1;
   |SINO;
      |COPIA_FICHERO aAlfa, aAlfa1;
   |FINSI;
   |FBORRA aAlfa;
|FPRC;

|PROGRAMA;
   |ABRE #pcegm045;
   |LEE 000#pcegm045.p;
   |SI FSalida ! 0;
      |DDEFECTO #pcegm045;
      |GRABA 020#pcegm045.c;
   |FINSI;
   |CIERRA #pcegm045;

   |SI #pcegm045#1 = "N"; |ACABA; |FINSI;

   aAlfa = #pcegm045#2; |QBF aAlfa; aAlfa = aAlfa % 0; nCalc = aAlfa;
   |SI nCalc = 1;
      aSepara = #pcegm045#2; |QBF aSepara;
   |SINO;
      aAlfa = #pcegm045#2; |QBF aAlfa; aAlfa = aAlfa % 0299; nCalc = aAlfa;
      aSepara = &nCalc;
   |FINSI;

   |ABRE #pcegm046;
   #pcegm046#0 = Usuario % 0810;
   |LEE 101#pcegm046.=;
   |SI FSalida ! 0;
      |DDEFECTO #pcegm046;
      #pcegm046#0 = Usuario % 0810;
      |GRABA 020#pcegm046.b;
   |FINSI;
   #pcegz101#0 = #pcegm046#1;

   |CLS;
   |CABEZA "Exportacion contable PCEGroup Chile";
   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida ! 0;
      |LIBERA #pcegm046; |CIERRA #pcegm046;
      |ACABA;
   |FINSI;

   #pcegm046#1 = #pcegz101#0;
   |GRABA 020#pcegm046.a;

   aAlfa = "te" + Usuario; |NOME_DAT #pcegw016#aAlfa#;
   |DELINDEX #pcegw016; |ABRE #pcegw016;
   aAlfa = "tc" + Usuario; |NOME_DAT #pcegw017#aAlfa#;
   |DELINDEX #pcegw017; |ABRE #pcegw017;

   aAlfa = eaPath; |QBF aAlfa;
   aAlfa = aAlfa - "contagen";
   |SI FSalida ! 0;
      nCalc = FSalida + 91; aAlfa = aAlfa % nCalc;
      aPathBas = eaPath - aAlfa + "/";
      aPathEmp = eaPath;
   |SINO;
      aAlfa = aAlfa - "agicont";
      |SI FSalida ! 0;
         nCalc = FSalida + 92; aAlfa = aAlfa % nCalc;
         aPathBas = eaPath - aAlfa + "/";
         aPathEmp = eaPath;
      |FINSI;
   |FINSI;

   aAlfa = aPathBas + "def/caenlace.mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      |PATH_DAT #Referen@#eaPath#; |NOME_DAT #Referen@#eaFich#;
      |ABRE #Referen@;
      |LEE 000#Referen@.p;
      |SI FSalida = 0;
         |ABRE #agifa133;
         |BUCLE Temporal; |BUCLE RevisaTempo;
         |CIERRA #agifa133;

         || Preparo el secuencial de asientos
         |HORA aAlfa; |QBF aAlfa;
         aAlfa = (aAlfa % 0102) + (aAlfa % 0402) + (aAlfa % 0702);
         fFecha = ~; aAlfa1 = fFecha;
         aAlfa1 = (aAlfa1 % 0704) + (aAlfa1 % 0402) + (aAlfa1 % 0102) + aAlfa;
         aAstosCsv = "ast" + aAlfa1 + ".csv";
         aClienCsv = "cli" + aAlfa1 + ".csv";
         |DFICB aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + aAstosCsv;
         |XABRE "WB", aAlfa, nHandle1;
         |SI FSalida ] 0;
            |DFICB aAlfa; |QBF aAlfa;
            aAlfa = aAlfa + aClienCsv;
            |XABRE "WB", aAlfa, nHandle2;
            |SI FSalida ] 0;
               nNumSec = 0; aAlfa = "";
               |HORA aAlfa; |QBF aAlfa; aHoraAnt = aAlfa;
               aAlfa = (aAlfa % 0702) + (aAlfa % 0402) + (aAlfa % 0102);
               nNumSec = aAlfa; nNumSec = nNumSec * 1000000;
               fFecha = ~; nCalc = fFecha; nNumSec = nNumSec + nCalc;
               nNumSec = nNumSec * 100; nLinea = 1;

               |BUCLE Secuencial;
               |XCIERRA nHandle2;
            |FINSI;
            |XCIERRA nHandle1;
         |FINSI;
         |HAZ CopiaFicheros;
      |FINSI;
      |CIERRA #Referen@;
      |DESCARGA_DEF #Referen@;
   |FINSI;
   |LIBERA #pcegm046; |CIERRA #pcegm046;

   |CIERRA #pcegw017; |DELINDEX #pcegw017;
   |CIERRA #pcegw016; |DELINDEX #pcegw016;
|FPRO;
