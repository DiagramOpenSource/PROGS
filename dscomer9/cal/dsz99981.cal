|FICHEROS;
     marhu361@ #1;
     marhu362@ #2;
     marhu363@ #3;
     marhup07@ #7;
     marhup08@ #8;
     marhup09@ #9;
     marhu342@ #342;
     agifa142 #142;
     agifa129 #129;
     agifa023 #23;
     agifa025 #25;
     agifa019 #19;
|FIN;

|VARIABLES;
     &enPreTPV      = 0;
     &eaIVAsn       = "N";
     &enUniMarhu    = 0;
     &enDescuento1  = 0;
     &enComision    = 0;
     &eaCliente     = "";
     &eaArticulo    = "";
     &eaRepre       = "";
     &efFecha       = @;
     &pvp_ve        = 0;
     &dto_pt        = 0;
     nCampo         = 0;
     aDef           = "";
     aDef1          = "";
     aDef2          = "";
     aDef3          = "";
     aDef7          = "";
     aDef8          = "";
     aDef9          = "";
     aAlfa          = "";
     nEncuentra     = 0;
     nSwComi        = 0;
     aProg          = "";
     &eaSerie       = "";
|FIN;

|PROCESO PrecioMarhuenda;
     |DDEF aDef;
     aDef = aDef + "marhu342";
     |CARGA_DEF aDef, marhu342@;
     |SI FSalida = 0;
          |ABRE #342;
          #342#0 = eaSerie;
          |LEE 000#342=;
          |SI FSalida = 0;
               pvp_ve = pvp_ve > #342#1;
          |FINSI;
          |CIERRA #342;
          enPreTPV = pvp_ve;
          eaIVAsn  = "N";
          |DESCARGA_DEF #marhu342@;
     |FINSI;
|FPRC;

|PROCESO DescargaDefMarhu;
     |SI aDef9 ! ""; |DESCARGA_DEF #marhup09@; |FINSI;
     |SI aDef8 ! ""; |DESCARGA_DEF #marhup08@; |FINSI;
     |SI aDef7 ! ""; |DESCARGA_DEF #marhup07@; |FINSI;
     |SI aDef3 ! ""; |DESCARGA_DEF #marhu363@; |FINSI;
     |SI aDef2 ! ""; |DESCARGA_DEF #marhu362@; |FINSI;
     |SI aDef1 ! ""; |DESCARGA_DEF #marhu361@; |FINSI;
|FPRC;

|PROCESO ComisionMarhuenda;
     aDef1 = ""; aDef2 = ""; aDef3 = "";
     aDef7 = ""; aDef8 = ""; aDef9 = "";
     |DDEF aDef;

     aDef1 = aDef + "marhu361";
     |CARGA_DEF aDef1, marhu361@;
     |SI FSalida ! 0;
          aAlfa = "0000Error al cargar " + aDef1;
          |MENAV aAlfa;
          |HAZ DescargaDefMarhu;
          |ACABA;
     |FINSI;

     aDef2 = aDef + "marhu362";
     |CARGA_DEF aDef2, marhu362@;
     |SI FSalida ! 0;
          aAlfa = "0000Error al cargar " + aDef2;
          |MENAV aAlfa;
          |HAZ DescargaDefMarhu;
          |ACABA;
     |FINSI;

     aDef3 = aDef + "marhu363";
     |CARGA_DEF aDef3, marhu363@;
     |SI FSalida ! 0;
          aAlfa = "0000Error al cargar " + aDef3;
          |MENAV aAlfa;
          |HAZ DescargaDefMarhu;
          |ACABA;
     |FINSI;

     aDef7 = aDef + "marhup07";
     |CARGA_DEF aDef7, marhup07@;
     |SI FSalida ! 0;
          aAlfa = "0000Error al cargar " + aDef7;
          |MENAV aAlfa;
          |HAZ DescargaDefMarhu;
          |ACABA;
     |FINSI;

     aDef8 = aDef + "marhup08";
     |CARGA_DEF aDef8, marhup08@;
     |SI FSalida ! 0;
          aAlfa = "0000Error al cargar " + aDef8;
          |MENAV aAlfa;
          |HAZ DescargaDefMarhu;
          |ACABA;
     |FINSI;

     aDef9 = aDef + "marhup09";
     |CARGA_DEF aDef9, marhup09@;
     |SI FSalida ! 0;
          aAlfa = "0000Error al cargar " + aDef9;
          |MENAV aAlfa;
          |HAZ DescargaDefMarhu;
          |ACABA;
     |FINSI;

     |ABRE #25;
     #25#0 = eaRepre;
     |LEE 000#25=;
     |SI FSalida ! 0; |DDEFECTO #25; |FINSI;
     |CIERRA #25;

     |MODULO aProg;
     nEncuentra = 0;
     nSwComi = 0;
     |HAZ ComisionMarhuenda_2;
     |SI nEncuentra = 0;
          |ABRE #23;
          #23#0 = eaCliente;
          #23#1 = eaArticulo;
          |LEE 000#23=;
          |SI FSalida = 0;
               |SI efFecha ] #23#28; |Y efFecha [ #23#29;
                    |SI #23#34 = 0;
                         |SI #142#88 = "S";
                              enComision = #23#34;
                         |FINSI;
                    |SINO;
                         enComision = #23#34;
                    |FINSI;
                    |SI aProg  = "marhu356";  ||Recalculo
                         |SI #25#57 = "N"; |Y #23#34 = 0;
                              enComision = 1;
                         |FINSI;
                    |FINSI;
                    enDescuento1 = #23#32;
                    pvp_ve = #23#2;
                    dto_pt  = 0;
               |FINSI;
          |FINSI;
          |CIERRA #23;
     |FINSI;
     |HAZ DescargaDefMarhu;
|FPRC;

|PROCESO ComisionMarhuenda_2;
     |ABRE #1;
     #1#0 = eaCliente;
     |LEE 000#1=;
     |SI FSalida = 0;
          |ABRE #2;
          |ABRE #3;
          |HAZ MOferta;
          |CIERRA #2;
          |CIERRA #3;
     |SINO;
          |HAZ ComisionMarhuenda_3;
     |FINSI;
     |CIERRA #1;
|FPRC;

|PROCESO MOferta;
     #2#0 = #1#2;
     |LEE 000#2=;
     |SI FSalida = 0; |Y efFecha ] #2#4; |Y efFecha [ #2#5;
          #3#0 = #2#0;
          #3#1 = eaArticulo;
          |LEE 000#3=;
          |SI FSalida = 0;
               enDescuento1 = 0;
               pvp_ve = #3#3;
               |HAZ PrecioMarhuenda;
               dto_pt = 0;
               |SI #25#57 = "S";
                    enComision = #3#4;
               |SINO;
                    enComision = #3#5;
               |FINSI;
               nEncuentra = 1;
          |SINO;
               |HAZ MNormal;
          |FINSI;
     |SINO;
          |HAZ MNormal;
     |FINSI;
|FPRC;

|PROCESO MNormal;
     #2#0 = #1#1;
     |LEE 000#2=;
     |SI FSalida = 0; |Y efFecha ] #2#4; |Y efFecha [ #2#5;
          #3#0 = #2#0;
          #3#1 = eaArticulo;
          |LEE 000#3=;
          |SI FSalida = 0;
               enDescuento1 = 0;
               pvp_ve = #3#3;
               |HAZ PrecioMarhuenda;
               dto_pt = 0;
               |SI #25#57 = "S";
                    enComision = #3#4;
               |SINO;
                    enComision = #3#5;
               |FINSI;
               nEncuentra = 1;
          |SINO;
               |HAZ ComisionMarhuenda_3;
          |FINSI;
     |SINO;
          |HAZ ComisionMarhuenda_3;
     |FINSI;
|FPRC;

|PROCESO ComisionMarhuenda_3;
     |ABRE #8;
     #8#0 = eaArticulo;
     |LEE 000#8=;
     |SI FSalida = 0;
          |ABRE #7;
          #7#0 = #8#1;
          |LEE 000#7=;
          |SI FSalida ! 0; |DDEFECTO #7; |FINSI;
          |CIERRA #7;

          |ABRE #9;
          #9#0 = eaCliente;
          #9#3 = #8#1;
          |LEE 000#9=;
          |SI FSalida = 0; |Y #9#2 > 0;
               |ABRE #129;
               |SI #25#57 = "S";
                    #129#0 = #7#3;
               |SINO;
                    #129#0 = #7#2;
               |FINSI;
               |LEE 000#129=;
               |SI FSalida = 0;
                    |SI enUniMarhu < #19#4;
                         nCampo = ((#9#2 - 1) * 2) - 1;
                         |SI nCampo < 1;
                              nCampo = 1;
                         |FINSI;
                    |SINO;
                         nCampo = ((#9#2 - 1) * 2) + 1;
                    |FINSI;
                    enDescuento1 = #129nCampo;
                    nCampo = nCampo + 1;
                    enComision = #129nCampo;
                    nSwComi = 1;
               |FINSI;
               |CIERRA #129;
          |FINSI;
          |CIERRA #9;
     |FINSI;
     |CIERRA #8;
|FPRC;
컴컴컴컴컴컴컴컴횵MPRESION ALBARANES컴컴컴컴컴컴컴컴컴컴컴
|| Calculo Impresion Albaranes Marhuenda (agifa014)
|| Ordena articulos por orden de actuacion :-(

|FICHEROS;
     &marhu355@ #100;
     tmp00010   #10;
     tmp00071   #71;
     marhu042@  #42;     ||Orden
     agifa017   #17;
|FIN;

|VARIABLES;
     bAlfa      = "";
     &Tempo     = "";
     aTempo100  = "";
     &enSwMarhu = 0;
||     aAlfa      = "";
||     aDef       = "";
     aOrden     = "";
|FIN;

|PROCESO LinAlba;
     #17#0 = #71#2;
     #17#1 = #71#3;
     |LEE 000#17=;
     |SI FSalida ! 0; |DDEFECTO #17; |FINSI;

     aAlfa = #17#2;
     bAlfa = aAlfa % 101;
     #42#2 = bAlfa;
     bAlfa = aAlfa % 201;
     #42#3 = bAlfa;
     bAlfa = aAlfa % 301;
     #42#4 = bAlfa;
     bAlfa = aAlfa % 401;
     #42#5 = bAlfa;
     bAlfa = aAlfa % 502;
     #42#6 = bAlfa;
     |LEE 000#42=;
     |SI FSalida ! 0; |DDEFECTO #42; |FINSI;

     |SI #42#0 = "A"; aAlfa = "B"; |SINO; aAlfa = "A"; |FINSI;
     aOrden = aAlfa + (("0000" + #42#1) % -104) + #17#0;

     #100#0 = #71#29;
     #100#1 = #71#0;
     #100#2 = #71#1;
     #100#3 = aOrden;
     |GRABA 020#100n;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴Procesos Externos컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO OrdenaMarhu;
     |SI enSwMarhu ! 0; |ACABA; |FINSI;

     |ABRE #42; |SELECT #2#42;
     |ABRE #100;
     |ABRE #71;
     |ABRE #17;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = 1;
     |LEE 000#71];
     |PARA; |SI FSalida = 0; |Y #71#29 = #10#52; |Y #71#0  = #10#0; |HACIENDO;
          |HAZ LinAlba;
          |LEE 000#71s;
     |SIGUE;
     |CIERRA #17;
     |CIERRA #71;
     |CIERRA #100;
     |CIERRA #42;
|FPRC;

|PROCESO FinMarhu;
     |SI enSwMarhu = 0;
          |DELINDEX #100; Tempo = aTempo100; |HAZ BoraTempo;
          |DESCARGA_DEF #marhu042@;
          |DESCARGA_DEF #marhu355@;
     |FINSI;
|FPRC;

|PROCESO IniMarhu;
     aAlfa = ""; |DBIN aAlfa;
     aAlfa = aAlfa + "marhup07.tab";
     |XABRE "E", aAlfa, 0;
     enSwMarhu = FSalida;
     |SI enSwMarhu = 0;
          |DDEF aDef;
          aAlfa = aDef + "marhu355";
          |CARGA_DEF aAlfa, marhu355@;
          enSwMarhu = FSalida;
          |SI FSalida = 0;
               aAlfa = aDef + "marhu042";
               |CARGA_DEF aAlfa, marhu042@;
               enSwMarhu = FSalida;
               |SI FSalida = 0;
                    |HAZ CreaTempo; aTempo100 = Tempo;
                    |NOME_DAT #100 aTempo100; |DELINDEX #100;
               |SINO;
                    aAlfa = "0000Error al cargar " + aAlfa;
                    |MENAV aAlfa;
               |FINSI;
          |SINO;
               aAlfa = "0000Error al cargar " + aAlfa;
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|| Calculo Impresion Pedidos Marhuenda (agifa105)
|| Ordena articulos por orden de actuacion :-(

|FICHEROS;
     &marhu355@ #100;
     agifa104   #104;
     agifa073   #73;
     agifa017   #17;
     marhu042@  #42;
|FIN;

|VARIABLES;
     &b1      = 0;
     &b2      = 0;
     &b3      = 0;
     &b4      = 0;
     &b5      = 0;
     &v1      = 0;
     &r1      = 0;
     &v2      = 0;
     &r2      = 0;
     &v3      = 0;
     &r3      = 0;
     &v4      = 0;
     &r4      = 0;
     &v5      = 0;
     &r5      = 0;
     &eaCli     = "";
     &enTiva    = 0;
     &enRec     = 0;
     &enIva     = 0;
     &efFiva = @;
     &tolin     = 0;
|FIN;

|PROCESO LinPedido;
     #17#0 = #73#2;
     #17#1 = #73#3;
     |LEE 000#17=;
     |SI FSalida ! 0; |DDEFECTO #17; |FINSI;

     #42#2 = #17#2 % 101;
     #42#3 = #17#2 % 201;
     #42#4 = #17#2 % 301;
     #42#5 = #17#2 % 401;
     #42#6 = #17#2 % 502;
     |LEE 000#42=;
     |SI FSalida ! 0; |DDEFECTO #42; |FINSI;

     |SI #42#0 = "A"; aAlfa = "B"; |SINO; aAlfa = "A"; |FINSI;
     aOrden = aAlfa + (("0000" + #42#1) % -104) + #17#0;

     #100#0 = #73#28;
     #100#1 = #73#0;
     #100#2 = #73#1;
     #100#3 = aOrden;
     |GRABA 020#100n;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴Procesos Externos컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO OrdenaMarhuP;
     |SI enSwMarhu ! 0; |ACABA; |FINSI;

     |ABRE #42; |SELECT #2#42;
     |ABRE #100;
     |ABRE #17;
     |BUCLELIN 2 LinPedido #104;
     |CIERRA #17;
     |CIERRA #100;
     |CIERRA #42;
|FPRC;

|PROCESO FinMarhuP;
     |SI enSwMarhu = 0;
          |DELINDEX #100; aTempo100 = Tempo; |HAZ BoraTempo;
          |DESCARGA_DEF #marhu042@;
          |DESCARGA_DEF #marhu355@;
     |FINSI;
|FPRC;

|PROCESO IniMarhuP;
     |HAZ EsMarhuenda;
     enSwMarhu = FSalida;
     |SI enSwMarhu = 0;
          |DDEF aDef;
          aAlfa = aDef + "marhu355";
          |CARGA_DEF aAlfa, marhu355@;
          enSwMarhu = FSalida;
          |SI FSalida = 0;
               aAlfa = aDef + "marhu042";
               |CARGA_DEF aAlfa, marhu042@;
               enSwMarhu = FSalida;
               |SI FSalida = 0;
                    |HAZ CreaTempo; aTempo100 = Tempo;
                    |NOME_DAT #100 aTempo100; |DELINDEX #100;
               |SINO;
                    aAlfa = "0000Error al cargar " + aAlfa;
                    |MENAV aAlfa;
               |FINSI;
          |SINO;
               aAlfa = "0000Error al cargar " + aAlfa;
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CargaTotP;
     eaCli  = #104#4;
     enTiva = #73#14;
     efFiva = #104#1;
     |HAZ IVACli;

     |SI #73#14 = 1;
         b1 = b1 + tolin;
         v1 = enIva;
         |SI #104#22 = "S";  r1 = enRec;  |FINSI;
     |FINSI;

     |SI #73#14 = 2;
         b2 = b2 + tolin;
         v2 = enIva;
         |SI #104#22 = "S";  r2 =  enRec;  |FINSI;
     |FINSI;

     |SI #73#14 = 3;
         b3 = b3 + tolin;
         v3 = enIva;
         |SI #104#22 = "S";  r3 =  enRec;  |FINSI;
     |FINSI;

     |SI #73#14 = 4;
         b4 = b4 + tolin;
         v4 = enIva;
         |SI #104#22 = "S";  r4 =  enRec;  |FINSI;
     |FINSI;

     |SI #73#14 = 5;
         b5 = b5 + tolin;
         v5 = enIva;
         |SI #104#22 = "S";  r5 =  enRec;  |FINSI;
     |FINSI;
|FPRC;
