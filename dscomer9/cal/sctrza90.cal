|FICHEROS;
     sctrz090 #0;
     sctrm003 #3;
     sctrm008 #8;
     sctrm007 #7;
     sctrm012 #12
     sctrm017 #17;
     sctrw014 #14;
     sctrm018 #18;
     sctrm019 #19;
     sctrm020 #20;
     sctrm068 #68;
     sctrm070 #70;
     sctrm078 #78;
|FIN;

|VARIABLES;
     &enIncBillete = 0;
     &enTotBillete = 0;
     aDiaSemanaL = "";
     aDiaSemanaN = "";
     aSwAplicaSuple = "";
     aAlfa = "";
     aDiaV = "";
     aDiaS = "";
     nSwSuple = 0;
     nOk = 0;
     nHay = 0;
     aDias = "";
     nImpoV = 0;
     nImpoS = 0;
     nNume = 0;
     fFecha = @;
     aTemporada = "";
     nHayLin = 0;
     nDtoAuto = 0;
|FIN;

|PROCESO sctrm068;
     |SI #68#2 ! 0;
          |SI #68#2 ! #0#11; |ACABA; |FINSI;                    || Linea
          |SI #0#13 < #68#3; |O #0#13 > #68#4; |ACABA; |FINSI; || Servicio
     |FINSI;
     |SI #0#3 < #68#5; |O #0#3 > #68#7;; |ACABA; |FINSI;       || F.Rese
     |SI #0#15 < #68#6; |O #0#15 > #68#8;; |ACABA; |FINSI;       || H.Rese

     enIncBillete = enIncBillete + ((enTotBillete * #68#10 / 100)!0);
|FPRC;

|DEFBUCLE sctrm068;
     #68#2;
     11;
     #0#1, #0#14, 0000000, #0#6;
     #0#1, #0#14, 9999999, #0#6;
     ;
     NULL, sctrm068;
|FIN;

|PROCESO IncDisBillete;
     enIncBillete = 0;
     |BUCLE sctrm068;
|FPRC;

|PROCESO sctrm078;
     |SI #78#1 = #0#11;                       || Servicio
          |SI #78#2 = #20#1; |O #78#2 = 0;    || Grupo

               aAlfa = #78#5; |QBF aAlfa;
               |SI #78#5 = #20#0; |O aAlfa = ""; || Temporada

                    aAlfa = #78#6; |QBF aAlfa;
                    |SI #78#6 = #0#6; |O aAlfa = ""; || Sentido

                         |SI #78#7 = #0#13; |O #78#7 = 0; || Servicio
                              nHayLin = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE sctrm078;
     #78#1;
     ;
     #70#0, 000, 00, "          ", " ", 000000;
     #70#0, 999, 99, "zzzzzzzzzz", "z", 999999
     ;
     NULL, sctrm078;
|FIN;

|PROCESO sctrm070;
     |SI #70#1 = "W"; |O #70#1 = "T";
          |SI #0#12 = #70#2; |O #70#2 = 9;
               |SI #0#3 ] #70#3; |Y #0#3 [ #70#4;
                    |SI #0#1 ] #70#5; |Y #0#1 [ #70#6;
                         nHayLin = 0;
                         |BUCLE sctrm078
                         |SI nHayLin = 1;
                              nDtoAuto = #70#7;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE sctrm070;
     #70#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, sctrm070;
|FIN;

|PROCESO DtoAuto;
     nDtoAuto = 0;
     |BUCLE sctrm070;
|FPRC;

|PROCESO DiaSemana;
     |SI fFecha = "01.01.0000";
          aDiaSemanaN = ""; aDiaSemanaL = "";
     |SINO;
          fFecha = fFecha % A1; aAlfa = fFecha % 1102;
          |SI aAlfa = "Lu"; aDiaSemanaN = "1"; aDiaSemanaL = "L"; |FINSI;
          |SI aAlfa = "Ma"; aDiaSemanaN = "2"; aDiaSemanaL = "M"; |FINSI;
          |SI aAlfa = "Mi"; aDiaSemanaN = "3"; aDiaSemanaL = "X"; |FINSI;
          |SI aAlfa = "Ju"; aDiaSemanaN = "4"; aDiaSemanaL = "J"; |FINSI;
          |SI aAlfa = "Vi"; aDiaSemanaN = "5"; aDiaSemanaL = "V"; |FINSI;
          |SI aAlfa = "Sa"; aDiaSemanaN = "6"; aDiaSemanaL = "S"; |FINSI;
          |SI aAlfa = "Do"; aDiaSemanaN = "7"; aDiaSemanaL = "D"; |FINSI;
     |FINSI;
|FPRC;

|PROCESO BuscaTempo;
     |SI #0#3 ] #8#2; |Y #0#3 [ #8#3;
          aTemporada = #8#0;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaTempo;
     #8#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, BuscaTempo;
|FIN;

|PROCESO TariSuple;
     |SI nSwSuple = 1; |Y #18#14 = "S"; |ACABA; |FINSI;
     |SI nSwSuple = 2; |Y #18#14 = "N"; |ACABA; |FINSI;

     |SI #0#0 < #18#15; |O #0#0 > #18#16; |ACABA; |FINSI;


     |SI #0#2 = "01.01.0000";
          |SI #0#6 ! #18#13;
               |ACABA;
          |FINSI;
          |SI #0#1 < #18#11; |O #0#1 > #18#12;
               |ACABA;
          |FINSI;
          nOk = 1;
     |SINO;
          nOk = 0;
          |SI #0#1 ] #18#11; |Y #0#1 [ #18#12; |Y #0#6 = #18#13;
               nOk = 1;
          |FINSI;
          |SI #0#2 ] #18#11; |Y #0#2 [ #18#12; |Y #0#7 = #18#13;
                     |Y #0#0 ! 2;
               nOk = 2;
          |FINSI;
          |SI nOk = 0; |ACABA; |FINSI;
     |FINSI;

     nHay = 0;
     |SI #18#7 = "I"; |O #18#7 = "T";
          aDias = #18#8; |QBF aDias;
          |SI aDias = "*";
               nHay = 1;
               nImpoS = nImpoS + #18#9;
          |SINO;
               |SI nOk = 2; |Y #18#7 = "T";
                    aAlfa = aDias - aDiaV;
                    |SI FSalida > 0; nHay = 2; |FINSI;
               |FINSI;

               |SI nOk = 1;
                    aAlfa = aDias - aDiaS;
                    |SI FSalida > 0; nHay = 1; |FINSI;
               |FINSI;

               |SI nHay = 1; nImpoS = nImpoS + #18#9; |FINSI;
               |SI nHay = 2; nImpoV = nImpoV + #18#9; |FINSI;
          |FINSI;
     |FINSI;

     |SI #18#7 = "V"; |Y #0#0 = 3;   || ida y vuelta Cerrada
          aDias = #18#8; |QBF aDias;
          |SI aDias = "*";
               nHay = 1;
          |SINO;
               aAlfa = aDias - aDiaV;
               |SI FSalida > 0; nHay = 1; |FINSI;
          |FINSI;
          |SI nHay = 1; nImpoV = nImpoV + #18#9; |FINSI;
     |FINSI;

     |SI #18#7 = "O"; |Y #0#0 = 2;   || ida cerrada y vuelta Abierta
          aDias = #18#8; |QBF aDias;
          |SI aDias = "*";
               nHay = 1;
          |SINO;
               aAlfa = aDias - aDiaV;
               |SI FSalida > 0; nHay = 1; |FINSI;
          |FINSI;
          |SI nHay = 1; nImpoV = nImpoV + #18#9; |FINSI;
     |FINSI;

     |SI nSwSuple = 1; |Y nHay ! 0;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE TariSuple;
     #18#1;
     ;
     #20#0, #20#1, #20#2, 000;
     #20#0, #20#1, #20#2, 999;
     ;
     NULL, TariSuple;
|FIN;

|PROCESO TipTariFec;
     nNume = #0#1 - #0#4 + 1;
     fFecha = nNume;
     |SI fFecha ] #19#8; |Y fFecha [ #19#9;
          aDias = #19#7; |QBF aDias;
          |SI aDias = "*";
               nHay = 1;
          |SINO;
               aAlfa = aDias - aDiaS;
               |SI FSalida > 0; nHay = 1; |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE TipTariFec;
     #19#1;
     ;
     #20#0, #20#1, #20#2, 000;
     #20#0, #20#1, #20#2, 999;
     ;
     NULL, TipTariFec;
|FIN;

|PROCESO TariTrayectos;
     #17#0 = #20#0;
     #17#2 = #20#1;
     #17#4 = #20#2;
     |LEE 000#17=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |SI #17#9 = "N"; |ACABA; |FINSI;

     |SI #0#0 = 1; |O #0#0 = 3;
          |SI #17#14 = "A"; |ACABA; |FINSI;
     |SINO;
          |SI #17#14 = "C"; |ACABA; |FINSI;
     |FINSI;

     |SI #17#11 ! 0;
          nNume = #0#1 - #0#3;
          |SI nNume > #17#11; |ACABA; |FINSI;
     |FINSI;

     |SI #0#0 ! 1; |Y #17#7 = "S"; |ACABA; |FINSI;

     nHay = 0;
     |BUCLE TipTariFec;
     |SI nHay = 0; |ACABA; |FINSI;

     #7#0 = #17#2;
     |LEE 000#7=;
     |SI FSalida ! 0; |DDEFECTO #7; |FINSI;

     aAlfa = (("00" + #20#1) % -102) + "." + (("0000" + #20#2) % -104);
     #14#0 = aAlfa;
     #14#1 = #7#1;
     |SI #0#0 = 1;
          #14#2 = #20#7;
     |SINO;
          #14#2 = #20#8;
     |FINSI;
     nImpoS = 0; nImpoV = 0;
     |SI aSwAplicaSuple = "S";
          nSwSuple = 1; |BUCLE TariSuple;
          nSwSuple = 2; |BUCLE TariSuple;
     |FINSI;

     #14#3 = nImpoS;
     #14#4 = nImpoV;
     #14#5 = #14#2;

     |SI #0#1 ] #12#22; |Y #0#1 [ #12#23;
          #14#6 = #12#18;
     |SINO;
          #14#6 = 0;
     |FINSI;
     #14#6 = #14#6 + #14#3 + #14#4;

     #14#7 = #14#5 + #14#6;
     |HAZ DtoAuto;
     #14#8 = nDtoAuto;
     |GRABA 000#14n;
|FPRC;

|DEFBUCLE TariTrayectos;
     #20#1;
     ;
     aTemporada, 00, 0000, 000, #0#8, #0#9, #0#10;
     aTemporada, 99, 9999, 999, #0#8, #0#9, #0#10;
     ;
     NULL, TariTrayectos;
|FIN;

|PROCESO CargaTari;
     nNume = #0#2 - #0#5 + 1;
     fFecha = nNume; |HAZ DiaSemana; aDiaV = aDiaSemanaL;
     nNume = #0#1 - #0#4 + 1;
     fFecha = nNume; |HAZ DiaSemana; aDiaS = aDiaSemanaL;

     |ABRE #12;
     #12#0 = #0#11;
     |LEE 000#12=;
     |SI FSalida ! 0; |DDEFECTO #12; |FINSI;
     |CIERRA #12;

     aSwAplicaSuple = "S";
     |ABRE #3;
     #3#0 = #0#9;
     |LEE 000#3=;
     |SI #3#7 = "N";
          aSwAplicaSuple = "N";
     |SINO;
          #3#0 = #0#10;
          |LEE 000#3=;
          |SI #3#7 = "N";
               aSwAplicaSuple = "N";
          |FINSI;
     |FINSI;
     |CIERRA #3;

     |BUCLE BuscaTempo;

     |ABRE #17;
     |ABRE #7;
     |BUCLE TariTrayectos;
     |CIERRA #7;
     |CIERRA #17;
|FPRC;
