GenReciAdela (Entrega a cuenta + Recibo Cartera)


|FICHEROS;
     agifa024 #4;  || Clientes.
     agifa025 #5;  || Representantes.
     psioa004 #99; || Cabecera revision.
     psioa005 #98; || Lineas revision.
     agifa091 #100;
     agis0002 #101;
     dscamrec@ #600;
     dsm00289 #289;
|FIN;

|VARIABLES;
     nImpReci = 0;
     nImpDespre = 0;
     &eaSerie = "";
     &enDocu = 0;
     &Tempo = "";
     &nDeci_Div = 0;
     &efFecha = @;
     &eaCtaDesprecio = "";
     &aCPath  = "";
     &aCNome  = "";
     &eaTag = "";
     &eaCuenta = "";
     numero = "";
     aMensa = "";
     aTempo600 = "";
     aDef00 = "";
     aPath = "";
     aAlfa = "";
     nHandle = 0;
     nNumRec = 0;
     nNume = 0;
     Comodin = "";
     nSwError = 0;
|FIN;

|PROCESO JamaEntregaPen;
     |ABRE #100;
     #100#0 = #4#20;
     |LEE 000#100=;
     |SI FSalida ! 0; |DDEFECTO #100; |FINSI;
     |CIERRA #100;

     |ABRE #101;
     #101#30 = #99#0;
     #101#20 = #99#2;
     #101#17 = #99#1;
     #101#18 = 99;
     |LEE 000#101];
     |SI FSalida = 0;
          |LEE 000#101a;
     |SINO;
          |LEE 000#101u;
     |FINSI;
     |SI FSalida = 0; |Y #101#30 = #99#0; |Y #101#20 = #99#2; |Y #101#17 = #99#1;
          nNumRec = #101#18 + 1;
     |SINO;
          nNumRec = 1;
     |FINSI;

     |DDEFECTO #101;
     #101#30 = #99#0;
     #101#20 = #99#2;
     #101#17 = #99#1;
     #101#18 = nNumRec;
     #101#0  = #99#1;
     #101#1  = nNumRec;
     #101#2  = #99#4;
     #101#3  = #4#2;
     #101#4  = #4#29;
     #101#5  = "N";
     #101#6  = "N";
     #101#7  = #99#3;
     #101#8  = #99#3;
     #101#9  = #99#9 - #99#7;
     #101#10 = "N";
     #101#11 = "N";
     #101#12 = #4#16;
     #101#14 = "N";
     #101#15 = "N";
     #101#16 = efFecha;
     #101#19 = #99#2;
     #101#22 = 3;        ||Tipo recibo
     #101#23 = 0;
     #101#24 = #4#20;
     #101#25 = 0;
     #101#26 = 0;
     #101#27 = 0;
     #101#28 = eaCtaDesprecio;
     |GRABA 020#101n;
     |CIERRA #101;

     |DBASS aAlfa;
     aAlfa = aAlfa + "dscarter/fich/dscam000.dat";
     |XABRE "E", aAlfa, nHandle;
     |SI FSalida = 0;
          |DBASS aPath;
          aPath = aPath + "dscarter/";
          aDef00 = aPath + "def/dscamrec";

          |CARGA_DEF aDef00, dscamrec@;
          |SI FSalida ! 0;
               aMensa = "0000Error al cargar:" + aDef00;
               |MENAV aMensa;
          |SINO;
               |HAZ CreaTempo; aTempo600 = Tempo;
               |PATH_DAT #600 aPath; |NOME_DAT #600 aTempo600; |DELINDEX #600;
               |ABRE #600;
               aCPath = aPath; aCNome = aTempo600;

               |DFICE Comodin;
               Comodin = Comodin % -106;
               Comodin = Comodin % 0105;

               nDeci_Div = 2;

               |ABRE #agifa024;
               #agifa024#0 = #agis0002#2;
               |LEE 000#agifa024.=;
               |CIERRA #agifa024;
               |DDEFECTO #dscamrec@;
               #600#1  = #agis0002#20;||Serie
               #600#2  = #agis0002#17;||Fact
               #600#3  = #agis0002#18;||N§ Rec
               #600#4  = #agis0002#8; ||F.V
               #600#5  = #agis0002#7; ||F.E
               #600#6  = #agis0002#12;||Cuenta Cli
               #600#7  = #agis0002#3; ||Nom Cli
               #600#8  = #agis0002#4; ||Nom Banco
               #600#9  = #agifa024#32;      ||Entidad
               #600#10 = #agifa024#33;      ||Sucursal
               #600#11 = #agifa024#31;      ||DC
               #600#12 = #agifa024#30;      ||Cuenta
               #600#13 = #agis0002#22;||Tipo Rec
               #600#15 = #agis0002#9; ||Importe
               #600#16 = #agis0002#15;||A aceptar
               #600#17 = #agis0002#6; ||Aceptado
               #600#18 = #agis0002#2; ||Cliente
               #600#19 = #99#10;      ||Codigo representante
               #600#20 = #agifa025#1; ||Nombre representante
               #600#21 = #agifa024#3; ||Zona
               #600#22 = 1;           ||Documento
               #600#25 = Comodin;     ||Empresa ges
               #600#27 = "V";         ||Tipo
               #600#28 = "A";         ||Ope
               #600#29 = "EUR";
               #600#30 = "EURO";           ||Nombre
               #600#31 = 1;                ||Cambio Divisa
               #600#32 = 1;                ||Cambio Base
               #600#33 = #agifa024#203;
               #600#34 = 0;
               #600#35 = "A";
               #600#36 = #agis0002#28;
               #600#38 = #agis0002#16;
               #600#39 = #agis0002#10;

               aAlfa = "|NC"; aAlfa = #600#aAlfa#;
               |SI aAlfa > 48;
                    #600#48 = #agifa024#215;
                    #600#49 = #agifa024#216;
               |FINSI;
               |SI aAlfa > 50;
                    #600#50 = #agifa024#217;
                    |ABRE #289;
                    #289#0 = #agifa024#0;
                    |LEE 000#289=;
                    |SI FSalida ! 0; |DDEFECTO #289; |FINSI;
                    |CIERRA #289;
                    #600#51 = #289#1;
               |FINSI;

               |GRABA 020#600n;

               |SUB_EJECUTA_NP ":dscarter/dsrecibo";

               #600#22 = 1;           ||Documento
               |LEE 000#600=;
               |SI FSalida ! 0; |O #600#37 = "ERROR               ";
                    nSwError = 1;
                    |MENAV "    La entrega tiene movimientos. Proceso abortado";
               |SINO;
                    eaTag = "RAA"; |HAZ Riesgos;
               |FINSI;

               Tempo = aTempo600; |HAZ BoraTempo;
               |CIERRA #600; |DELINDEX #600;
               |DESCARGA_DEF #dscamrec@;
           |FINSI;
     |FINSI;
|FPRC;

     || -------- Generacion Recibos Adelantados -----------
|PROCESO GenReciAdela;
     |ABRE #99;
     #99#0 = "A";      ||#98#0;
     #99#1 = enDocu;   ||#98#1;
     #99#2 = eaSerie;  ||#98#2;
     |LEE 020#99=;       || LEE CABECERA REVISION PSION
     |CIERRA #99;

     |ABRE #4;
     #4#0 = #99#4;
     |LEE 000#4=;
     |SI FSalida ! 0; |DDEFECTO #4; |FINSI;
     |CIERRA #4;

     |ABRE #5;
     #5#0 = #99#10;
     |LEE 000#5=;
     |SI FSalida ! 0; |DDEFECTO #5; |FINSI;
     |CIERRA #5;

     |SI #99#6 ! "N";
              |Y #99#7 ! 0; || condicion a¤adida segun Tiquet:001901/483


          |SI #99#6 = "S";    ||Cobrado total o Parcial con resto despreciado
               nImpReci = #99#9;
               nImpDespre = #99#9 - #99#7;
          |FINSI;
          |SI #99#6 = "P";    ||Cobrado Parcial;
               nImpReci = #99#7;
               nImpDespre = 0;
          |FINSI;

          |ABRE #agifa091; |ABRE #agis0002;
          #agifa091#0 = #agifa024#20;
          |LEE 000#agifa091.=;
          |SI FSalida ! 0; |DDEFECTO #agifa091; |FINSI;

          nNumRec = 1; aAlfa = #99#2; |QBF aAlfa; aAlfa = (aAlfa + "     ") % 0105;
          #agis0002#30 = "A";
          numero = "000000" + #99#1; numero = numero % -106;
          #agis0002#20 = aAlfa;
          #agis0002#17 = #99#1;
          #agis0002#18 = 1;
          |LEE 000#agis0002.];
          |PARA; |SI FSalida = 0; |Y #agis0002#20 = aAlfa; |Y #agis0002#30 = "A"; |Y #agis0002#17 = #99#1; |HACIENDO;
             nNumRec = #agis0002#18 + 1;
             |LEE 000#agis0002.s;
          |SIGUE;
          |DDEFECTO #agis0002;
          #agis0002#30 = "A";
          #agis0002#20 = aAlfa;
          #agis0002#17 = numero;
          #agis0002#18 = nNumRec;
          #agis0002#0  = numero;
          #agis0002#1  = nNumRec;
          #agis0002#2  = #99#4;
          #agis0002#3  = #4#2;
          #agis0002#4  = #4#29;
          #agis0002#5  = "N";
          #agis0002#6  = "N";
          #agis0002#7  = #99#3;
          #agis0002#8  = #99#3;
          #agis0002#9  = #99#7;
          #agis0002#10 = "N";
          #agis0002#11 = "N";
          #agis0002#12 = #4#16;
          #agis0002#14 = "N";
          #agis0002#15 = "N";
          #agis0002#16 = efFecha;
          #agis0002#19 = #99#2;
          #agis0002#22 = #agifa091#69;
          #agis0002#23 = 0;
          #agis0002#24 = #agifa024#20;
          #agis0002#25 = 0;
          #agis0002#26 = 0;
          #agis0002#27 = 0;
          #agis0002#28 = eaCuenta;
          |SI #99#35 ! 0;
              #agis0002#22 = #99#35;  || Tipo Recibo
          |FINSI;
          |GRABA 020#agis0002.n;
          |CIERRA #agifa091; |CIERRA #agis0002;


          |DBASS aAlfa;
          aAlfa = aAlfa + "dscarter/fich/dscam000.dat";
          |XABRE "E", aAlfa, nHandle;
          |SI FSalida = 0;
               |DBASS aPath;
               aPath = aPath + "dscarter/";
               aDef00 = aPath + "def/dscamrec";

               |CARGA_DEF aDef00, dscamrec@;
               |SI FSalida ! 0;
                    aMensa = "0000Error al cargar:" + aDef00;
                    |MENAV aMensa;
               |SINO;
                    |HAZ CreaTempo; aTempo600 = Tempo;
                    |PATH_DAT #600 aPath; |NOME_DAT #600 aTempo600; |DELINDEX #600;
                    |ABRE #600;
                    aCPath = aPath; aCNome = aTempo600;

                    |DFICE Comodin;
                    Comodin = Comodin % -106;
                    Comodin = Comodin % 0105;

                    nDeci_Div = 2;

                    |ABRE #agifa024;
                    #agifa024#0 = #agis0002#2;
                    |LEE 000#agifa024.=;
                    |CIERRA #agifa024;
                    |DDEFECTO #dscamrec@;
                    #600#1  = #agis0002#20;||Serie
                    #600#2  = #agis0002#17;||Fact
                    #600#3  = #agis0002#18;||N§ Rec
                    #600#4  = #agis0002#8; ||F.V
                    #600#5  = #agis0002#7; ||F.E
                    #600#6  = #agis0002#12;||Cuenta Cli
                    #600#7  = #agis0002#3; ||Nom Cli
                    #600#8  = #agis0002#4; ||Nom Banco
                    #600#9  = #agifa024#32;      ||Entidad
                    #600#10 = #agifa024#33;      ||Sucursal
                    #600#11 = #agifa024#31;      ||DC
                    #600#12 = #agifa024#30;      ||Cuenta
                    #600#13 = #agis0002#22;||Tipo Rec
                    #600#15 = nImpReci;    ||Importe
                    #600#16 = #agis0002#15;||A aceptar
                    #600#17 = #agis0002#6; ||Aceptado
                    #600#18 = #agis0002#2; ||Cliente
                    #600#19 = #99#10;      ||Codigo representante
                    #600#20 = #agifa025#1; ||Nombre representante
                    #600#21 = #agifa024#3; ||Zona
                    #600#22 = 1;           ||Documento
                    #600#25 = Comodin;     ||Empresa ges
                    #600#27 = "V";         ||Tipo
                    #600#28 = "A";         ||Ope
                    #600#29 = "EUR";
                    #600#30 = "EURO";           ||Nombre
                    #600#31 = 1;                ||Cambio Divisa
                    #600#32 = 1;                ||Cambio Base
                    #600#33 = #agifa024#203;
                    #600#34 = 0;
                    #600#35 = "A";
                    #600#36 = #agis0002#28;
                    #600#38 = #agis0002#16;
                    #600#39 = #agis0002#10;
                    #600#47 = nImpDespre;
                    aAlfa = "|NC"; aAlfa = #600#aAlfa#;
                    |SI aAlfa > 48;
                         #600#48 = #agifa024#215;
                         #600#49 = #agifa024#216;
                    |FINSI;
                    |SI aAlfa > 50;
                         #600#50 = #agifa024#217;
                         |ABRE #289;
                         #289#0 = #agifa024#0;
                         |LEE 000#289=;
                         |SI FSalida ! 0; |DDEFECTO #289; |FINSI;
                         |CIERRA #289;
                         #600#51 = #289#1;
                    |FINSI;

                    |GRABA 020#600n;

                    |SUB_EJECUTA_NP ":dscarter/dsrecibo";

                    #600#22 = 1;           ||Documento
                    |LEE 000#600=;
                    |SI FSalida ! 0; |O #600#37 = "ERROR               ";
                         nSwError = 1;
                         |MENAV "    La entrega tiene movimientos. Proceso abortado";
                    |SINO;
                         eaTag = "RAA"; |HAZ Riesgos;
                    |FINSI;

                    Tempo = aTempo600; |HAZ BoraTempo;
                    |CIERRA #600; |DELINDEX #600; |DESCARGA_DEF #dscamrec@;
               |FINSI;
          |FINSI;
     |FINSI;

     |HAZ EsJamaica;
     |SI FSalida = 0;
          nNume = #99#9 - #99#7;
          |SI #99#6 = "S"; |Y nNume ! 0;
               |HAZ JamaEntregaPen;
          |FINSI;
     |FINSI;
|FPRC;
