|FICHEROS;
     sctrz089 #0;
     sctrm008 #8
     sctrm012 #12
     sctrw013 #13;  ||Tmp Trayectos Servicios
     sctrw014 #14;  ||Tmp Tarifa
     sctrw027 #27;  ||Tmp servicios
     sctrm024 #24;
     sctrm029 #29;
     sctrm030 #30;
     sctrm031 #31;
     sctrm069 #69;
     referen@;
|FIN;

|VARIABLES;
     &Tempo = "";
     aTmp13b = "";
     aDias = "";
     nSwTempoFRese = 0;
     nSwVuelta = 0;
     nSwBusServi = 0;
     nSwSugeridos = 0;
     aDiaSemanaN = "";
     aDiaSemanaL = "";
     fFecha = @;
     aAlfa = "";
     aTemporada = "";
     i = 0;
     j = 0;
     nHay = 0;
     aPobDes = "";
     aPobOrg = "";
     nLin = 0;
     nConta = 0;
     fDesde = @;
     fHasta = @;
     nError = 0;
     aLon = "";
     nPos = 0;
     aDia = "";
     nNume = 0;
     fFechaSalidaIda = @;
     fFechaSalidaVuelta = @;
     nFechaSalida = 0;
     aHora = "";
     nHora = 0;
     aMinu = "";
     nMinu = 0;
     nLinea = 0;
     aSentido = "";
     fFechaViaje = @;
     nPax = 0;
     aBloqueado = "";
|FIN;
----------------------------------------------------------------
|PROCESO CtrlViajerosCheq;
     |ABRE #69;
     #69#0 = nLinea;
     #69#1 = aSentido;
     #69#2 = fFechaViaje;
     |LEE 000#69=;
     |SI FSalida ! 0; |DDEFECTO #69; |FINSI;
     |CIERRA #69;
     nPax = #69#3 - #69#4;
     aBloqueado = #69#5;
|FPRC;

|PROCESO FormaHora;
     aHora = aAlfa % 102; nHora = aHora; nHora = nHora $ 24;
     aMinu = aAlfa % 402; nMinu = aMinu; nMinu = nMinu $ 60;
     aAlfa = (("00" + nHora)%-102) + ":" + (("00" + nMinu)%-102);
|FPRC;

|PROCESO DiaSemana;
     |SI fFecha = "01.01.0000";
          aDiaSemanaN = ""; aDiaSemanaL = "";
     |SINO;
          fFecha = fFecha % A1; aAlfa = fFecha % 1102;
          |SI aAlfa = "Lu"; aDiaSemanaN = "1"; aDiaSemanaL = "L"; |FINSI;
          |SI aAlfa = "Ma"; aDiaSemanaN = "2"; aDiaSemanaL = "M"; |FINSI;
          |SI aAlfa = "Mi"; aDiaSemanaN = "3"; aDiaSemanaL = "X"; |FINSI;
          |SI aAlfa = "Ju"; aDiaSemanaN = "4"; aDiaSemanaL = "J"; |FINSI;
          |SI aAlfa = "Vi"; aDiaSemanaN = "5"; aDiaSemanaL = "V"; |FINSI;
          |SI aAlfa = "Sa"; aDiaSemanaN = "6"; aDiaSemanaL = "S"; |FINSI;
          |SI aAlfa = "Do"; aDiaSemanaN = "7"; aDiaSemanaL = "D"; |FINSI;
     |FINSI;
|FPRC;

|PROCESO CambiaDias;     || Le suma el N§ dias trayecto
     aAlfa = "";
     aLon = aDias % A0;
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aDia = aDias % nPos;
          nNume = aDia + #13#11 - 1;
          nNume = nNume - 1;
          nNume = nNume $ 7;
          nNume = nNume + 1;
          aAlfa = aAlfa + nNume;
     |SIGUE;
     aDias = aAlfa;
|FPRC;

|PROCESO BuscaTempo;
     |SI nSwTempoFRese = 1;
          |SI #0#7 ] #8#2; |Y #0#7 [ #8#3;
               aTemporada = #8#0;
               |ERROR10;
          |FINSI;
     |SINO;
          |SI nSwVuelta = 0;
               |SI fFechaSalidaIda ] #8#2; |Y fFechaSalidaIda [ #8#3;
                    aTemporada = #8#0;
                    |ERROR10;
               |FINSI;
          |SINO;
               |SI fFechaSalidaVuelta ] #8#2; |Y fFechaSalidaVuelta [ #8#3;
                    aTemporada = #8#0;
                    |ERROR10;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaTempo;
     #8#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, BuscaTempo;
|FIN;

|PROCESO LeeEl29;
     |ABRE #29;
     #29#0 = #31#0;
     #29#2 = #31#1;
     #29#4 = #31#2;
     #29#5 = #31#3;
     #29#7 = #31#4;
     |LEE 000#29=;
     |SI nSwVuelta = 0;
          |SI FSalida = 0; |Y #29#9 = "S"; |Y fFechaSalidaIda ] #29#8; |Y fFechaSalidaIda [ #29#10;
               aAlfa = "0";
          |SINO;
               aAlfa = "1";
          |FINSI;
     |SINO;
          |SI FSalida = 0; |Y #29#9 = "S"; |Y fFechaSalidaVuelta ] #29#8; |Y fFechaSalidaVuelta [ #29#10;
               aAlfa = "0";
          |SINO;
               aAlfa = "1";
          |FINSI;
     |FINSI;
     |CIERRA #29;
     FSalida = aAlfa;
|FPRC;

|PROCESO RFreTrayectos;
     |PARA j = 12; |SI j [ 21; |HACIENDO j = j + 1;
          |SI #referen@#j# ! "     "; |Y j = i;
               #13#0 = #31#0;
               #13#1 = #31#1;
               #13#2 = #31#2;
               #13#3 = #30#6;
               #13#4 = #30#7;
               #13#5 = #31i;
               #13#6 = #referen@#j#;
               #13#7 = #referen@#11; || #30#14;
               #13#11 = #31#11;
               |GRABA 000#13n;
               nHay = 1;
          |FINSI;
     |SIGUE;
|FPRC;

|DEFBUCLE RFreTrayectos;
     #referen@#1006;
     9, 6;
     #31#0, #31#1, #31#2, #31#3, #31#4, 000, "D", aPobDes;
     #31#0, #31#1, #31#2, #31#3, #31#4, 999, "D", aPobDes;
     ;
     NULL, RFreTrayectos;
|FIN;

|PROCESO FreTrayectos;
     |PARA i = 12; |SI i [ 21; |HACIENDO i = i + 1;
          |SI #31i ! "     ";
               nLin = i - 11;
               |HAZ LeeEl29;
               |SI FSalida = 0;
                    #30#0 = #31#0;
                    #30#1 = #31#1;
                    #30#2 = #31#2;
                    #30#3 = #31#3;
                    #30#4 = #31#4;
                    #30#5 = nLin;
                    |LEE 000#30=;
                    |SI FSalida = 0;
                         nHay = 0;
                         |BUCLE RFreTrayectos;
                         ||SI nHay ! 0; |SAL; |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|DEFBUCLE FreTrayectos;
     #31#1;
     9, 6;
     "          ", 000, " " , 000, 00, 000, "O", aPobOrg;
     "zzzzzzzzzz", 999, "z" , 999, 99, 999, "O", aPobOrg;
     ;
     NULL, FreTrayectos;
|FIN;

|PROCESO PeriServi;
     nHay = 0;
     |SI nSwVuelta = 0;  || Org -> Des
          |SI fFechaSalidaIda = "01.01.0000";
               fFecha = #0#7;
          |SINO;
               fFecha = fFechaSalidaIda;
          |FINSI;
          |SI fFecha ] #24#5; |Y fFecha [ #24#6;
               nHay = 1;
               #13#8 = #24#5;
               #13#9 = #24#6;
               #13#10 = #24#7;
          |FINSI;
     |SINO;    || Des -> Org
          fFecha = fFechaSalidaVuelta;
          |SI fFecha ] #24#5; |Y fFecha [ #24#6;
               nHay = 1;
               #13#8 = #24#5;
               #13#9 = #24#6;
               #13#10 = #24#7;
          |FINSI;
     |FINSI;

     |SI nHay = 1;
          |SALVA_DATOS #13;
          |REPON_DATOS #referen@;
          nConta = nConta + 1;
          #referen@#12 = nConta;
          |GRABA 020#referen@.n;
     |FINSI;
|FPRC;

|DEFBUCLE PeriServi;
     #24#1;
     8;
     #13#0, #13#1, #13#2, #13#3, 00, "S";
     #13#0, #13#1, #13#2, #13#3, 99, "S";
     ;
     NULL, PeriServi;
|FIN;

|PROCESO TmpTrayectos;
     |BUCLE PeriServi;
|FPRC;

|DEFBUCLE TmpTrayectos;
     #13#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, TmpTrayectos;
|FIN;

|PROCESO CargaTrayectos;
     |CIERRA #13; |DELINDEX #13; |ABRE #13;
     |SI nSwVuelta = 0;
          aPobOrg = #0#1; aPobDes = #0#2;
     |SINO;
          aPobOrg = #0#2; aPobDes = #0#1;
     |FINSI;
     |DDEF aAlfa;
     aAlfa = aAlfa + "sctrm031";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #30;
          |BUCLE FreTrayectos;
          |CIERRA #30;
          |DESCARGA_DEF #referen@;
          |SI nSwBusServi = 0;
               || sctrm024 puede contener mas de 1 registro por cada uno del sctrw013
               || por eso se regraba el sctrw013 con todos los posibles

               |DDEF aAlfa; aAlfa = aAlfa + "sctrw013";
               |CARGA_DEF aAlfa, referen@;
               |SI FSalida = 0;
                    |HAZ CreaTempo; |NOME_DAT #referen@#Tempo#; aTmp13b = Tempo; |DELINDEX #referen@;
                    |ABRE #referen@;

                    nConta = 0;
                    |BUCLE TmpTrayectos;

                    |CIERRA #13; |DELINDEX #13; |ABRE #13;
                    |LEE 000#referen@.p;
                    |PARA; |SI FSalida = 0; |HACIENDO;
                         |SALVA_DATOS #referen@;
                         |REPON_DATOS #13;
                         |GRABA 020#13n;
                         |LEE 000#referen@.s;
                    |SIGUE;

                    |CIERRA #referen@;
                    Tempo = aTmp13b; |HAZ BoraTempo; |DELINDEX #referen@;
                    |DESCARGA_DEF #referen@;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BuscaServi;
     |SI nSwVuelta = 0;
          fFecha = fFechaSalidaIda;
     |SINO;
          fFecha = fFechaSalidaVuelta;
     |FINSI;

     fDesde = #13#8 + (#13#11 - 1);
     fHasta = #13#9 + (#13#11 - 1);
     |SI fFecha ] fDesde; |Y fFecha [ fHasta;
          aDias = #13#10; |QBF aDias;
          |SI aDias = "*";
               nHay = nHay + 1;
          |SINO;
               |HAZ CambiaDias;
               aAlfa = aDias - aDiaSemanaN;
               |SI FSalida > 0;
                    nHay = nHay + 1;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI nHay ] 1;
          |HAZ AsignaServi;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaServi;
     #13#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, BuscaServi;
|FIN;

|PROCESO AsignaServi;
     |SI nSwVuelta = 0;
          |PARA i = 0; |SI i [ 12; |HACIENDO i = i + 1;
               #27i = #13i;
          |SIGUE;
          #27#13 = "I";
          #27#14 = fFechaSalidaIda;

          |SI #13#11 = 2;
               #27#15 = fFechaSalidaIda;
          |SINO;
               nNume = fFechaSalidaIda;
               nNume = nNume + (#13#7 - 1);
               #27#15 = nNume;
          |FINSI;

          |ABRE #12;
          #12#0 = #13#1;
          |LEE 000#12=;
          |SI FSalida ! 0; |DDEFECTO #12; |FINSI;
          |CIERRA #12;

          #27#17 = #12#1;

          ||horas viaje
          nNume = (#27#15 - fFechaSalidaIda) * 24 * 60;
          |SI nNume = 0;
               aAlfa = #13#6; |HAZ FormaHora;
               nNume = nMinu + (nHora * 60);
               aAlfa = #13#5; |HAZ FormaHora;
               nNume = nNume - (nMinu + (nHora * 60));
          |SINO;
               nNume = nNume - (24 * 60);
               aAlfa = #13#6; |HAZ FormaHora;
               nNume = nNume + nMinu + (nHora * 60);
               aAlfa = #13#5; |HAZ FormaHora;
               nNume = nNume + (24 * 60) - (nMinu + (nHora * 60));
          |FINSI;
          nMinu = nNume $ 60;
          nHora = (nNume - nMinu) / 60;
          aAlfa = (("00" + nHora) % -102) + ":" + (("00" + nMinu) % -102);
          #27#16 = aAlfa;
          ||.............
          nLinea = #13#1;
          aSentido = #13#2;
          nNume = fFechaSalidaIda - #13#11 + 1;
          fFechaViaje = nNume;
          |HAZ CtrlViajerosCheq;
          #27#18 = aBloqueado;
          #27#19 = nPax;
     |SINO;
          |PARA i = 0; |SI i [ 12; |HACIENDO i = i + 1;
               #27i = #13i;
          |SIGUE;
          #27#13 = "V";
          #27#14 = fFechaSalidaVuelta;

          |SI #13#11 = 2;
               #27#15 = fFechaSalidaVuelta;
          |SINO;
               nNume = fFechaSalidaVuelta;
               nNume = nNume + (#13#7 - 1);
               #27#15 = nNume;
          |FINSI;

          |ABRE #12;
          #12#0 = #13#1;
          |LEE 000#12=;
          |SI FSalida ! 0; |DDEFECTO #12; |FINSI;
          |CIERRA #12;

          #27#17 = #12#1;

          ||horas viaje
          nNume = (#27#15 - fFechaSalidaVuelta) * 24 * 60;
          |SI nNume = 0;
               aAlfa = #13#6; |HAZ FormaHora;
               nNume = nMinu + (nHora * 60);
               aAlfa = #13#5; |HAZ FormaHora;
               nNume = nNume - (nMinu + (nHora * 60));
          |SINO;
               nNume = nNume - (24 * 60);
               aAlfa = #13#6; |HAZ FormaHora;
               nNume = nNume + nMinu + (nHora * 60);
               aAlfa = #13#5; |HAZ FormaHora;
               nNume = nNume + (24 * 60) - (nMinu + (nHora * 60));
          |FINSI;
          nMinu = nNume $ 60;
          nHora = (nNume - nMinu) / 60;
          aAlfa = (("00" + nHora) % -102) + ":" + (("00" + nMinu) % -102);
          |SI #13#5 = "     ";
               #27#16 = "";
          |SINO;
               #27#16 = aAlfa;
          |FINSI;
          ||.............
          nLinea = #13#1;
          aSentido = #13#2;
          nNume = fFechaSalidaIda - #13#11 + 1;
          fFechaViaje = nNume;
          |HAZ CtrlViajerosCheq;
          #27#18 = aBloqueado;
          #27#19 = nPax;
     |FINSI;
     |GRABA 020#27n;
|FPRC;

|PROCESO FecSalida;
||     |PARA nFechaSalida = #0#8; |SI nFechaSalida [ #0#9; |HACIENDO; nFechaSalida = nFechaSalida + 1;
||          fFechaSalidaIda = nFechaSalida;

          fFechaSalidaIda = #0#5;

          nSwVuelta = 0;
          |BUCLE BuscaTempo;
          fFecha = fFechaSalidaIda; |HAZ DiaSemana;

          |HAZ CargaTrayectos
          nHay = 0; aDias = "";
          |BUCLE BuscaServi;

||          |SI nError = 1; |SAL; |FINSI;
||     |SIGUE;
|FPRC;

|PROCESO FecVuelta;
||     |PARA nFechaSalida = #0#8; |SI nFechaSalida [ #0#9; |HACIENDO; nFechaSalida = nFechaSalida + 1;
||          fFechaSalidaVuelta = nFechaSalida;

          fFechaSalidaVuelta = #0#6;

          nSwVuelta = 1;
          |BUCLE BuscaTempo;
          fFecha = fFechaSalidaVuelta; |HAZ DiaSemana;

          |HAZ CargaTrayectos
          nHay = 0; aDias = "";
          |BUCLE BuscaServi;

||          |SI nError = 1; |SAL; |FINSI;
||     |SIGUE;
|FPRC;
