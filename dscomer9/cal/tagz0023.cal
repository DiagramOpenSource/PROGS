|FICHEROS;
     tmp00000 #0;
     agifa059 #59;
     tagm0087 #87;
     tagm0088 #88;
     agifa134 #134;
     agifa142 #142;
     agifa024 #24;
|FIN;

|VARIABLES;
     aUsu = "";
     aDoc = "";
     aPlan = "";
     aAsunto = "";
     aMail = "";
     aSignal = "";
     &eaTagloItem = "N";
     &eaPath = "";
     &eaNomFic = ""
     &eaImprime = "";
     &ser_fac = "";
     &num_fac = 0;
     &reimp = "";
     &eaOrdenado = "";
     &enSw_tagz0023 = 0;
     {1}aBaseLocal = "";
     aAlfa = "";
     f = "";
     c = "";
     aFic = "";
     nHandle = 0;
     aNom = "";
     aFecha = "";
     aFecImp = "";
     aNomCli = "";
     aCodCli = "";
     aEmp = "";
     aSer = "";
     aNum = "";
     aFec = "";
     aA¤o = "";
     aPath = "";
     fFec = @;
     aHora = "";
     aNuevo = "";
|FIN;

|PROCESO Graba;
     aAlfa = aAlfa + f;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO Apo;
     |SI aNuevo = "S";
          aFic = aPath + "PDF_" + aNom + ".apo";
     |SINO;
          aFic = aPath + aNom + ".apo";
     |FINSI;

     |XABRE "WBC", aFic, nHandle;
     |SI FSalida ] 0;
          |SI aNuevo = "S";
               aDoc = "doc_type(" + c + "PDF" + c + ");" + f;
               aPlan = "plantilla(" + c + "\\10.255.31.202\software\itemdoc\wireprint\plantillas\original.pdf"+ c+ ");";
               aAlfa = "list" + f + "{" + f + "template(" + c + c + ");"+ f + aDoc + "type("+ c + "180" + c + ");" + f + aPlan;
          |SINO;
               aAlfa = "list" + f + "{" + f + "template(" + c + c + ");"+ f + "type("+ c + "80" + c + ");";
          |FINSI;
          |HAZ Graba;
          aAlfa = "date(" + c + aFecImp + c + ");";
          |HAZ Graba;
          aAlfa = "       doc" + f + "               {";
          |HAZ Graba;
          |SI aNuevo = "S";
               aAlfa = "                       key(" + c + "PDF_80/" + aNom + c + ");";
          |SINO;
               aAlfa = "                       key(" + c + "80/" + aNom + c + ");";
          |FINSI;
          |HAZ Graba;
          aAlfa = "                       data" + f + "                               {";
          |HAZ Graba;
          aAlfa = "                                 (1)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (2)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (3)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (4)(" + c + aNomCli + c + "," + c + "A" + c + "," + c + (aNomCli%A0) + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (5)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (6)(" + c + aCodCli + c + "," + c + "A" + c + "," + c + (aCodCli%A0) + c + ");";
          |HAZ Graba;
          aAlfa = aEmp + "." + aSer + "." + aNum;
          aAlfa = "                                 (7)(" + c + aAlfa + c + "," + c + "A" + c + "," + c + (aAlfa%A0) + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (8)(" + c + aFec + c + "," + c + "A" + c + "," + c + (aFec%A0) + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (9)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (10)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (11)(" + c + aEmp + c + "," + c + "A" + c + "," + c + (aEmp%A0) + c + ");";
          |HAZ Graba;
          aAlfa = "                               }" + f + "                       contents";
          |HAZ Graba;
          aAlfa = "                               {" + f + "                                            1;" + f;
          |HAZ Graba;
          aAlfa = "                               }" + f + "               }" + f + "}";
          |HAZ Graba;
          |XCIERRA nHandle;
     |SINO;
          aAlfa = "0000Error al crear fichero:" + aFic;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO ApoAlb;
     aMail = #24#197; |QBF aMail;
     aAsunto = "Su Factura:" + #134#49; |QBF aAsunto;
     aAsunto = aAsunto + "/" + (("000000"+#134#0)%-106) + " Fecha:" + #134#1;
     aUsu = Usuario % 810;
     aSignal = "(" + c + "1642120|PDF_PDF_80/" + aNom + "!PDF_ALB_80/" + aNom + "|";
     aSignal = aSignal + aMail + "|" + aAsunto + "|"+aUsu+"|cuerpo.html|1|" + c + ")";

     aFic = aPath + "ALB_" + aNom + ".apo";
     |XABRE "WBC", aFic, nHandle;
     |SI FSalida ] 0;
          aAlfa = "list" + f + "{" + f + "template(" + c + c + ");"+ f
          aAlfa = aAlfa + "doc_type(" + c + "PDF" + c + ");" + f + "type("+ c + "280" + c + ");";
          |HAZ Graba;
          aAlfa = "date(" + c + aFecImp + c + ");";
          |HAZ Graba;
          aAlfa = "       doc" + f + "               {";
          |HAZ Graba;
          aAlfa = "                       key(" + c + "ALB_80/" + aNom + c + ");";
          |HAZ Graba;
          aAlfa = "                       data" + f + "                               {";
          |HAZ Graba;
          aAlfa = "                                 (1)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (2)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (3)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (4)(" + c + aNomCli + c + "," + c + "A" + c + "," + c + (aNomCli%A0) + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (5)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (6)(" + c + aCodCli + c + "," + c + "A" + c + "," + c + (aCodCli%A0) + c + ");";
          |HAZ Graba;
          aAlfa = aEmp + "." + aSer + "." + aNum;
          aAlfa = "                                 (7)(" + c + aAlfa + c + "," + c + "A" + c + "," + c + (aAlfa%A0) + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (8)(" + c + aFec + c + "," + c + "A" + c + "," + c + (aFec%A0) + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (9)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (10)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;
          aAlfa = "                                 (11)(" + c + aEmp + c + "," + c + "A" + c + "," + c + (aEmp%A0) + c + ");";
          |HAZ Graba;
          aAlfa = "                               }" + f + "                       contents";
          |HAZ Graba;
          aAlfa = "                               {" + f + "                                            1;" + f;
          |HAZ Graba;
          aAlfa = "                               }" + f + "                       signaling";
          |HAZ Graba;
          aAlfa = "                               {" + f + "                                            "+ aSignal + ";" + f;
          |HAZ Graba;
          aAlfa = "                               }" + f + "               }" + f + "}";
          |HAZ Graba;
          |XCIERRA nHandle;
     |SINO;
          aAlfa = "0000Error al crear fichero:" + aFic;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO Sal;
     aFic = aPath + aNom + ".sal";

     |XABRE "WBC", aFic, nHandle;
     |SI FSalida ] 0;
          aAlfa = "USER=" + (Usuario % 810);
          |HAZ Graba;
          aAlfa = "CONTENIDO=" + aPath + aNom + ".TIF"; aAlfa = aAlfa > "";
          |HAZ Graba;
          aAlfa = "PORTADA=" + aPath + aNom + ".APO"; aAlfa = aAlfa > "";
          |HAZ Graba;
          aAlfa = "NOTRANSFORM=1" + f + "WHATTODO=2" + f + "TIFF=1" + f;
          aAlfa = aAlfa + "TIF=1" + f + "FAX=" + f + "PDF=0";
          |HAZ Graba;
          |XCIERRA nHandle;
     |SINO;
          aAlfa = "0000Error al crear fichero:" + aFic;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO DetalleTxt;
     |DDEFECTO #88;
     #88#0 = #59#15;
     |LEE 000#88=;

     aSer = ("00" + #88#1) % -102;
     aNum = ("0000000" + #59#2) % -107;

     aAlfa = "DET:" + c + "90/" + aEmp + aSer + aNum + c + ";" + c + "00" + c;
     |HAZ Graba;
|FPRC;

|PROCESO Txt;
     aFic = aPath + aNom + ".txt";
     |XABRE "WBC", aFic, nHandle;
     |SI FSalida ] 0;
          aAlfa = "[ItemPrint]" + f;
          aAlfa = aAlfa + "CAB:" + c + "80/" + aNom + c + ";" + c + aSer;
          aAlfa = aAlfa + c + ";" + c + aSer + "/" + aNum + c + ";" + c;
          aAlfa = aAlfa + "AP:999" + c;
          |HAZ Graba;
          |BUCLELIN 2 DetalleTxt #134;
          |XCIERRA nHandle;
     |SINO;
          aAlfa = "0000Error al crear fichero:" + aFic;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO DetalleMin;
     |DDEFECTO #88;
     #88#0 = #59#15;
     |LEE 000#88=;

     aSer = ("00" + #88#1) % -102;
     aNum = ("00000000" + #59#2) % -107;

     aAlfa = "DET:" + c + "90/" + aEmp + aSer + aNum + c + ";"
     |HAZ Graba;
|FPRC;

|PROCESO Min;
     aFic = aPath + "ALB_" + aNom + ".min";
     |XABRE "WBC", aFic, nHandle;
     |SI FSalida ] 0;
          |BUCLELIN 2 DetalleMin #134;
          |XCIERRA nHandle;
     |SINO;
          aAlfa = "0000Error al crear fichero:" + aFic;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO Pdf;
     ser_fac = #0#0;
     num_fac = #0#1;
     reimp = #134#45;
     eaOrdenado = #142#141;

     |SI aNuevo = "S";
          eaImprime = "CrystalReport;" + aPath + "PDF_" + aNom + ".pdf";
     |SINO;
          eaImprime = "CrystalReport;" + aPath + aNom + ".pdf";
     |FINSI;

     enSw_tagz0023 = 1;
     |SUB_EJECUTA_NP "agifa136";
     enSw_tagz0023 = 0;
|FPRC;

|PROCESO Fecha;
     fFec = #134#1;
     |HORA aHora;
     aFecha = (fFec % 102) + "/" + (fFec % 402) + "/" + (fFec % 704);
     aFecha = aFecha + " " + aHora;
     aA¤o = fFec % 704;
     aFec = (aFecha % 106) + (aA¤o % -102);
|FPRC;

|PROCESO FechaImp;
     fFec = ~;
     |HORA aHora;
     aFecImp = (fFec % 102) + "/" + (fFec % 402) + "/" + (fFec % 704);
     aFecImp = aFecImp + " " + aHora;
|FPRC;

|PROCESO tmp00000;
     #134#49 = #0#0;
     #134#0 = #0#1;
     |LEE 020#134=;

     |DDEFECTO #88;
     #88#0 = #134#49;
     |LEE 000#88=;
     |SI FSalida ! 0; |O #88#2 = "N"; |ACABA; |FINSI;


     |DDEFECTO #24;
     #24#0 = #134#2;
     |LEE 000#24=;
     |SI FSalida ! 0; |DDEFECTO #24; |FINSI;

     aNuevo = "N";
     |SI #24#213 = "S"; |Y eaTagloItem = "X";
          aNuevo = "S";
     |FINSI;

     aEmp = "30";
     aSer = ("00" + #88#1) % -102;
     aNum = ("0000000" + #134#0) % -107;
     aNom = aEmp + aSer + aNum;
     aCodCli = #134#2;
     aNomCli = #134#3; |QBF aNomCli;

     aPath = "c:\ds\item\";
     |RMKDIR aPath;

     |HAZ Fecha;
     |HAZ FechaImp;

     |HAZ Pdf;

     |SI aNuevo = "S";
          |HAZ Apo;
          |HAZ ApoAlb;
          |HAZ Min;

          aAlfa = #87#3; |QBF aAlfa;
          aAlfa = "cmd " + c + "/c START /MIN /WAIT " + aAlfa + "factuprint.exe " + aPath + "PDF_" + aNom + ".pdf" + c;
          |RSYSTEM aAlfa;

          aFic = aPath + "ALB_" + aNom + ".apo"; |RFBORRA aFic;
          aFic = aPath + "PDF_" + aNom + ".apo"; |RFBORRA aFic;
          aFic = aPath + "ALB_" + aNom + ".min"; |RFBORRA aFic;
          aFic = aPath + "PDF_" + aNom + ".pdf"; |RFBORRA aFic;
     |SINO;
          eaPath = aPath; eaNomFic = aNom; |HAZ Pdf2Tif;
          |HAZ Apo;
          |HAZ Sal;
          |HAZ Txt;

          aAlfa = #87#3; |QBF aAlfa;
          aAlfa = "cmd " + c + "/c START /MIN /WAIT " + aAlfa + "jafsmb.exe " + aPath + aNom + ".sal" + c;
          |RSYSTEM aAlfa;

          aAlfa = #87#3; |QBF aAlfa;
          aAlfa = "cmd " + c + "/c START /MIN /WAIT " + aAlfa + "wireprin.exe " + aPath + aNom + ".txt" + c;
          |RSYSTEM aAlfa;

          aFic = aPath + aNom + ".apo"; |RFBORRA aFic;
          aFic = aPath + aNom + ".sal"; |RFBORRA aFic;
          aFic = aPath + aNom + ".txt"; |RFBORRA aFic;
          aFic = aPath + aNom + ".tif"; |RFBORRA aFic;
     |FINSI;
|FPRC;

|DEFBUCLE tmp00000;
     #0#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, tmp00000;
|FIN;

|PROGRAMA;
     aAlfa = PARAMETRO;

     |HAZ Traete_imagemagick;

     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     |ABRE #87; |LEE 000#87p; |CIERRA #87;

     f = &13; f = f + &10;
     c = &34;

     |NOME_DAT #0 aAlfa;
     |ABRE #88;
     |ABRE #134;
     |ABRE #24;
     |BUCLE tmp00000;
     |CIERRA #24;
     |CIERRA #134;
     |CIERRA #88;
|FPRO;
