|FICHEROS;
     vigz0039 #0;
     agifa019 #19;
     vigw0023 #23;  || tmp
     agifa067 #67;
|FIN

|VARIABLES;
     &eaDarti = "";
     &eaHarti = "";
     aMil = "";
     aAlfa = "";
     nPcm = 0;
     nPen = 0;
     nPre = 0;
     nVal = 0;
     nFactor = 0;
|FIN;

|PROCESO Articulos;
     |DDEFECTO #23;
     #23#0 = #19#0;
     |LEE 000#23=;
     |SI FSalida ! 0;
          #23#1 = #19#1;
          #23#2 = #19#6;
          #23#3 = #19#9;
          #23#4 = 0;
          #23#5 = 0;
          #23#6 = 0;
          #23#7 = 0;

          |GRABA 020#23n;
     |FINSI;
|FPRC;

|DEFBUCLE Articulos;
     #19#1;
     ;
     #0#0;
     #0#1;
     ;
     NULL, Articulos;
|FIN;

|PROCESO Tmp;
     |DDEFECTO #19;
     #19#0 = #23#0;
     |LEE 000#19=;

     #23#5 = (#23#2 * #23#3 + #23#8)/ (#23#2 + #23#4);

     |PRINT;
|FPRC;

|DEFBUCLE Tmp;
     #23#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Tmp;
|FIN;

|PROCESO Pedido;
     |DDEFECTO #23;
     #23#0 = #67#2;
     |LEE 101#23=;
     |SI FSalida ! 0; |GRABA 020#23b; |FINSI;

     |DDEFECTO #19;
     #19#0 = #67#2;
     |LEE 000#19=;

     nPen = #67#5 - #67#38;
     nPre = #67#6 < #67#8;
     nPre = nPre < #67#27;

     nFactor = 1;
     aMil = #19#110; |QBF aMil; aMil = aMil > "";
     |SI aMil = "S";
          nFactor = 1000;
     |FINSI;

     nPre = nPre / nFactor;

     nPcm = (#23#3 * #23#4) + (nPre * nPen);
     nPcm = nPcm / (#23#4 + nPen);

     #23#1 = #19#1;
     #23#2 = #19#6;
     #23#3 = #19#9;
     #23#4 = #23#4 + nPen;
||     #23#5 = nPcm;          || se calcula despues
     #23#6 = #67#6 / nFactor; ||   el ultimo precio del pedido
     #23#7 = #67#5;

     #23#8 = #23#8 + (nPen * nPre);

     |GRABA 020#23a;
     |LIBERA #23;
|FPRC;

|DEFBUCLE Pedido;
     #67#3;
     ;
     #0#0, "     ", 000001, "      ";
     #0#1, "zzzzz", 999999, "zzzzzz";
     ;
     NULL, Pedido;
|FIN;

|PROCESO Tipo 3; |TIPO 3;
     aAlfa = Usuario;
     |NOME_DAT #23 aAlfa; |DELINDEX #23;

     |SI #0#2 = "S";
          eaDarti = #0#0;
          eaHarti = #0#1;
          |SUB_EJECUTA_NP "agifa068;RECALCULA";
     |FINSI;

     |SI #0#3 = "S";
          eaDarti = #0#0;
          eaHarti = #0#1;
          |SUB_EJECUTA_NP "vigz0047;RECALCULA";
     |FINSI;

     |IMPRE 0;
     |SI FSalida = 0;
          |INFOR "vigz0039";
          |SI FSalida ! 0;
               |MENAV "0000Error en informe 'vigz0039'";
          |SINO;
               |ABRE #23;
               |ABRE #19;
               |BUCLE Pedido;
               |CIERRA #19;
               |BUCLE Articulos;
               |CIERRA #23;

               |ABRE #19;
               |BUCLE Tmp;
               |CIERRA #19;

               |PIEINF;
               |FININF;
          |FINSI;
          |FINIMP;
     |FINSI;

     |DELINDEX #23;
|FPRC;
