|FICHEROS;
 alba0034 #98; || Cabecera revision psion.
 alba0035 #99; || Lineas revision psion.
 agifa071 #0;  || LINEAS DE ALBARAN
 agifa010 #1;  || CABECERA DE ALBARAN
 agifa019 #2;  || ARTICULOS
 agifa024 #6;  || CLIENTES
 agifa017 #8;
 agifa065 #9;  || HISTORICO
 agifa038 #11;
 agifa025 #12; || REPRESENTANTES
 agifa048 #13;
 agifa049 #14;
 agifa142 #42; ||PARAMETROS GENERALES
 agifa321 #44;  || Divisas-Parametros.
 agifa324 #45;  || Divisas-Divisas.
 alba0007 #47,MANTE;
 dsm00024 #24;
|FIN;

|CAMPOS;
   #2#11 nec;     #2#15 sps;
   #2#16 spr;     #2#7 stmia;
   #2#104 stdia;  #2#17 pdva;
   #2#13 stfa;    #2#12 stres;
|FIN;

|VARIABLES;
     &enDescuento1 = 0;
     &enDescuento2 = 0;
     &eaTComision  = "";
     &enComision   = 0;

 resto = 0;
 neto = 0;
 diferencia = 0;
 sw = 0;
 numero = "";
 vacio = "                    ";
 totalba = 0;
 descu = 0;
 tf = 0;
 pc = 0;
 pc1 = 0;
 imneto = 0;
 asto = 0;
 margen = 0;
 wimneto = 0;
 wmargen = 0;
operacion1 = "AV";
operacion2 = "BV";
operacion = "  ";
a = 0;
modo = 0;
cantidad = 0;
articulo = " ";
fmes = "  ";
mes = 0;
me  = 0;
kl  = 0;
mescli = " ";
mensaje1 = "0000Esta linea proviene de un Pedido (use la opcion adecuada)";
mensaje2 = "0000Esta linea proviene de un Deposito (use la opcion adecuada)";
mensaje3 = "0410 Stock Disponible Almacen :             Stock Minimo : ";
mensaje4 = "0000 Supera el Stock disponible";
mensaje5 = "0000 Albaran para Exportacion. Tipo IVA = 0  !!!";
mensaje12 = "0000Este albaran esta FACTURADO";
totbu = 0;
flag = 0;
primera = 0;
swescan = 0;
alfa1 = "";
     &avisa_st = "S";
     &n_dec = 0;
     &n_pre = 0;
     &ext1 = "";
     sal_campo = 0;
     aviso = "";
     ok = "";
     tbruto = 0;
     &aMoneda = "";
     &aDivisa = "";
|FIN;

|INCLUYE i_varart;

|PROCESO Unidadess;
     |ABRE #47;
     #47#0 = "AV";
     #47#1 = #0#29;
     #47#2 = #0#0;
     #47#3 = #0#1;
     |LEE 101#47=;
     |SI FSalida ! 0; |GRABA 020#47b; |FINSI;
     #47#4 = #99#12;
     #47#5 = #99#13;
     #47#6 = #99#6;
     |GRABA 020#47a;
     |CIERRA #47;
     #0#5 = #47#6;  ||Uni1 Stock
     #0#48 = #47#4; ||Uni2 Factu

     eaArticulo = #0#2;
     |HAZ BseFactu2;
|FPRC;

|CALCULO mirespor;
   |SI #6#28 = AS;|Y #0#11 ! 0;
       #0#11 = 0;
   |FINSI;
|FCAL;

|CALCULO defecli;
|ABRE #12;
#12#0 = #98#10;
|LEE 000#12=;
|SI FSalida ! 0;
    |GRABA 000#12c;
|FINSI;
|LIBERA #12;
|CIERRA #12;
#0#15 = #1#3;
#0#16 = #12#7;
#1#34 = #12#7;
#0#17 = #6#4;

|SI #0#2 ! #2#0;
    |ABRE #2;
    #2#0 = #0#2;
    |LEE 100#2=;
    |LIBERA #2;
    |CIERRA #2;
|FINSI;

#0#13 = #2#2;

|SI #0#15 ! #6#0;
    |ABRE #6;
    #6#0 = #0#15;
    |LEE 001#6=;
    |LIBERA #6;
    |CIERRA #6;
|FINSI;
|FCAL;

|CALCULO lisubcom;
    enDescuento1 = #0#8;
    enDescuento2 = #0#33;
    eaTComision  = #0#16;
    eaCliente    = #1#3;
    eaArticulo   = #0#2;
    eaRepre      = #1#6;
    |HAZ Comisiones;
    #0#10 = enComision;

    mes = imneto % #0#10;
    #1#26 = #1#26 + mes;
|FCAL;

|CALCULO totli;
     |SI FSalida = 1;
         sal_campo = 1;
     |SINO;
         sal_campo = 0;
     |FINSI;
     #0#7 = #0#48 * #0#6;
     #0#9 = #0#7 < #0#8;
     #0#9 = #0#9 < #0#33;
     #0#9 = #0#9 ! #45#7;
|FCAL;

|PROCESO ActPartida;
   |ABRE #24;
   #24#0 = #0#2;
   #24#1 = #0#3;
   #24#2 = #0#49;
   |LEE 101#24=;
   |SI FSalida = 0;
        #24#11 = #24#11 + #0#5;
        #24#22 = #24#22 - #0#5;
        #24#31 = #24#31 - #0#5;
        |HAZ ValoraStock;
        |GRABA 020#24a;
   |FINSI;
   |CIERRA #24;
|FPRC;

|CALCULO liacarti;
   mes = 0 + 1;
   |SI Campo < 3; |Y sal_campo = 0;
       |HAZ defecli;
   |FINSI;
   imneto = #0#9 < #1#5;
   imneto = imneto < #1#32;
   imneto = imneto < #1#7;
   imneto = imneto ! #45#7;            || puesto el 01-02-90 .Javier
   |ABRE #2;
   #2#0 = #0#2;
   |LEE 121#2=;
   |LIBERA #2;
   |SI 0 = FSalida;
       |ABRE #8;
       #8#0 = #0#2;
       #8#1 = #0#3;
       |LEE 121#8=;
       |LIBERA #8;
       |SI 0 = FSalida;
           |SI #1#43 = AN;               || caso albaran
               stdia = stdia - #0#5;
               #2#6 = #2#6 - #0#5;
           |SINO;                        || caso abono
               stdia = stdia + #0#5;
               #2#6 = #2#6 + #0#5;
           |FINSI;
           asto = #2#6 - #2#17;
           |SI asto > 0;
               #2#10 = asto * #2#9;
           |SINO;
               #2#10 = 0;
           |FINSI;

           nec = sps + stmia; nec = nec - spr; nec = nec - stdia;
           nec = nec - pdva;  nec = nec - stfa;nec = nec - stres ;

           fmes = #1#1 % A402;
           mes = fmes - 1;
           mes = mes * 5;
           mes = mes + 34;
           |SI #1#43 = AN;              || caso albaran
               #2mes = #2mes + #0#5;
               margen = #0#48 * #2#9;
               #0#14 = margen; || coste de la linea
               margen = imneto - margen;
               #1#37 = #1#37 + margen;
               #2#94 = #2#94 + #0#5;

               #8#39 = #8#39 - #0#5;
               #8#5 = #8#5 - #0#5;
               asto = #8#5 - #8#4;
               |SI asto > 0;
                   #8#3 = asto * #2#9;
               |SINO;
                   #8#3 = 0;
               |FINSI;
               mes = fmes - 1;
               mes = mes * 2;
               mes = mes + 11;
               #8mes = #8mes + #0#5;
               #8#35 = #8#35 + #0#5;
           |SINO;                      || caso abono
               #2mes = #2mes - #0#5;
               margen = #0#48 * #2#9;
               #0#14 = margen; || coste de la linea
               margen = imneto - margen;
               #1#37 = #1#37 + margen;
               #2#94 = #2#94 - #0#5;

               #8#39 = #8#39 + #0#5;
               #8#5 = #8#5 + #0#5;
               asto = #8#5 - #8#4;
               |SI asto > 0;
                   #8#3 = asto * #2#9;
               |SINO;
                   #8#3 = 0;
               |FINSI;
               mes = fmes - 1;
               mes = mes * 2;
               mes = mes + 11;
               #8mes = #8mes - #0#5;
               #8#35 = #8#35 - #0#5;
           |FINSI;
           |HAZ ActPartida;
           #2#24 = #1#1;
           #2#25 = #0#5;
           |GRABA 040#2a;
           |LIBERA #2;
           #8#50 = #8#42 + #8#6 - #8#43 - #8#39; || necesidades
           #8#50 = #8#50 - #8#4 - #8#9 - #8#8;
           |GRABA 040#8a;
           |LIBERA #8;

           efFecha = #1#1;
           eaArticulo = #0#2;
           enAlmacen = #0#3;
           |SI #1#43 = "N";
                enUniVta = #0#5;
                enImpMar = margen;
                enUniSal = #0#5;
           |SINO;
                enUniVta = -#0#5;
                enImpMar = -margen;
                enUniSal = -#0#5;
           |FINSI;
           |HAZ AcumulaArt;
           |HAZ AcumulaAlm;

           |SI modo = 1;
               |HAZ altahis;
           |FINSI;
       |FINSI;
   |FINSI;
   |LIBERA #8;
   |CIERRA #8;
   |LIBERA #2;
   |CIERRA #2;


   enTiva = #0#11;
   efFiva = #1#1;
   |HAZ SacaIVA;

   #1#15 = #1#15 + #0#9;
   #1#75 = #1#15;
   #1#77 = #1#15;
   #1#79 = #1#15;
   |SI #0#11 = 0; #1#28 = #1#28 + imneto; |FINSI;
   |SI #0#11 = 1;
       #1#16 = #1#16 + imneto; mes = #1#16; #1#17 = mes % enIva;
       |SI #1#36 = "S";
           #1#18 = mes % enRec;
       |FINSI;
   |FINSI;
   |SI #0#11 = 2;
       #1#19 = #1#19 + imneto; mes = #1#19; #1#20 = mes % enIva;
       |SI #1#36 = "S";
           #1#21 = mes % enRec;
       |FINSI;
   |FINSI;
   |SI #0#11 = 3;
       #1#22 = #1#22 + imneto; mes = #1#22; #1#23 = mes % enIva;
       |SI #1#36 = "S";
           #1#54 = mes % enRec;
       |FINSI;
   |FINSI;
   |SI #0#11 = 4;
       #1#44 = #1#44 + imneto; mes = #1#44; #1#45 = mes % enIva;
       |SI #1#36 = "S";
           #1#46 = mes % enRec;
       |FINSI;
   |FINSI;
   |SI #0#11 = 5;
       #1#47 = #1#47 + imneto; mes = #1#47; #1#48 = mes % enIva;
       |SI #1#36 = "S";
           #1#49 = mes % enRec;
       |FINSI;
   |FINSI;
   mes = imneto % #0#10;
   #1#25 = #1#15 < #1#5;
   #1#25 = #1#25 < #1#32;
   #1#25 = #1#25 < #1#7;
   #1#25 = #1#15 - #1#25;
   #1#24=#1#17 +#1#18 +#1#20 +#1#21 +#1#23 +#1#54 +#1#45 +#1#46 +#1#48 +#1#49;
   #1#25 = #1#25 ! #45#7;
   #1#24 = #1#24 ! #45#7;
   totalba = (#1#15-#1#25) + (#1#11+#1#13+#1#24);
   #1#67 = totalba;
   #1#76 = totalba;
   #1#78 = totalba;
   #1#80 = totalba;
|FCAL;

|CALCULO miraques;
|SI #1#43 = AN;
    a = -1;
    operacion = operacion1;
|SINO;
    a = 1;
    operacion = operacion2;
|FINSI;
|FCAL;

|CALCULO altahis;
     |ABRE #9;
     |DDEFECTO #9;
     #0#2 = #99#4;       || Cod. Articulos
     #9#0 = #0#2;
     #9#11= #0#29;
     #9#1 = #1#1;
     #9#2 = operacion;
     #9#3 = #0#0;
     #9#4 = #0#1;
     #9#5 = #0#3;        || almacen
     #9#6 = #0#5 *  a;   || stock
     #9#7 = #2#6;
     #9#8 = #2#9;
     #9#9 = #0#6;
     #1#3 = #98#4;       || Cod. Cliente
     #9#10 = #1#3;
     #9#12 = #0#8;
     #9#13 = #0#33;
     #9#14 = #0#6 < #9#12;
     #9#14 = #9#14 < #9#13;
     #9#18 = #0#49;
     |GRABA 121#9n;
     |LIBERA #9;
     |CIERRA #9;
     swescan = 1;
     |HAZ para_ger;
     |SI #42#12 = "S";
         |HAZ actualiz;
     |FINSI;
|FCAL;

|CALCULO altaescan;
|ABRE #9;
|DDEFECTO #9;
#9#0 = #14#2;
#9#11= #0#29;
#9#1 = #1#1;
#9#2 = operacion;
#9#3 = #0#0;
#9#4 = #0#1;
#9#5 = #0#3;        || almacen
#9#6 = #0#5 *  a * #14#4;   || stock
#9#7 = #2#6 - #0#5 * #14#4;
#9#8 = #2#9;
#9#9 = #0#6;
#9#10 = #1#3;
#9#12 = #0#8;
#9#13 = #0#33;
#9#14 = #0#6 < #9#12;
#9#14 = #9#14 < #9#13;
|GRABA 121#9n;
|LIBERA #9;
|HAZ artialta;
|FCAL;

||***************************** CALCULO ESCANDALLOS *******************;
|CALCULO linescan;
     #2#0 = #14#2;
     |LEE 140#2=;
     |LIBERA #2;
     |SI swescan = 1;
         |HAZ altaescan;
     |FINSI;
|FCAL;

|CALCULO actualiz;
        |ABRE #13;
        #13#0 = #0#2;
        |LEE 140#13=;
        |LIBERA #13;
        |SI FSalida = 0;
            #2#0 = #13#0;
            |LEE 140#2=;
            |LIBERA #2;
            |BUCLELIN 0linescan#13;
        |FINSI;
        |LIBERA #13;
        |CIERRA #13;
|FCAL;

|CALCULO artialta;
   mes = 0 + 1;
   wimneto = #0#9 < #1#5;
   wimneto = wimneto < #1#32;
   wimneto = wimneto < #1#7;
   wimneto = wimneto ! #45#7;            || puesto el 01-02-90 Javier

   |DDEFECTO #8;
   #8#0 = #14#2; ||Articulo;
   #8#1 = #14#9; ||Almacen;
   |LEE 140#8=;
   |LIBERA #8;
   |SI FSalida = 0;
       wimneto = (wimneto * #14#6) /  #13#9;
       cantidad = #0#48 * #14#4
       |SI #1#43 = AN;               || caso albaran
           stdia = stdia - cantidad;
           #2#6 = #2#6 - cantidad;
       |SINO;                        || caso abono
           stdia = stdia + cantidad;
           #2#6 = #2#6 + cantidad;
       |FINSI;
       asto = #2#6 - #2#17;
       |SI asto > 0;
           #2#10 = asto * #2#9;
       |SINO;
           #2#10 = 0;
       |FINSI;
       nec = sps + stmia; nec = nec - spr; nec = nec - stdia;
       nec = nec - pdva;  nec = nec - stfa;nec = nec - stres ;

       fmes = #1#1 % A402;
       mes = fmes - 1;
       mes = mes * 5;
       mes = mes + 34;
       |SI #1#43 = AN;              || caso albaran
           #2mes = #2mes + cantidad;
           margen = cantidad * #2#9;
           margen = wimneto - margen;
           mes = mes + 1;
           #2mes = #2mes + wimneto;
           mes = mes + 1;
           #2mes = #2mes + margen;

           #2#94 = #2#94 + cantidad;
           #2#95 = #2#95 + wimneto;
           #2#96 = #2#96 + margen;

           #8#39 = #8#39 - cantidad;
           #8#5 = #8#5 - cantidad;
           asto = #8#5 - #8#4;
           |SI asto > 0;
               #8#3 = asto * #2#9;
           |SINO;
               #8#3 = 0;
           |FINSI;
           mes = fmes - 1;
           mes = mes * 2;
           mes = mes + 11;
           #8mes = #8mes + cantidad;
           #8#35 = #8#35 + cantidad;
       |SINO;                      || caso abono
           #2mes = #2mes - cantidad;
           margen = cantidad * #2#9;
           margen = wimneto - margen;
           mes = mes + 1;
           #2mes = #2mes - wimneto;
           mes = mes + 1;
           #2mes = #2mes - margen;

           #2#94 = #2#94 - cantidad;
           #2#95 = #2#95 - wimneto;
           #2#96 = #2#96 - margen;

           #8#39 = #8#39 + cantidad;
           #8#5 = #8#5 + cantidad;
           asto = #8#5 - #8#4;
           |SI asto > 0;
               #8#3 = asto * #2#9;
           |SINO;
               #8#3 = 0;
           |FINSI;
           mes = fmes - 1;
           mes = mes * 2;
           mes = mes + 11;
           #8mes = #8mes - cantidad;
           #8#35 = #8#35 - cantidad;
       |FINSI;
       #8#50 = #8#42 + #8#6 - #8#43 - #8#39; || necesidades
       #8#50 = #8#50 - #8#4 - #8#9 - #8#8;
       |GRABA 141#8a;
       |LIBERA #8;
       |GRABA 141#2a;
       |LIBERA #2;

       efFecha = #1#1;
       eaArticulo = #14#2;
       enAlmacen = #14#9;
       |SI #1#43 = "N";
            enUniVta = cantidad;
            enImpVta = wimneto;
            enImpMar = margen;
            enUniSal = cantidad;
       |SINO;
            enUniVta = -cantidad;
            enImpVta = -wimneto;
            enImpMar = -margen;
            enUniSal = -cantidad;
       |FINSI;
       |HAZ AcumulaArt;
       |HAZ AcumulaAlm;
   |FINSI;
|FCAL;

|PROCESO linalb;
     |HAZ LeeDivisa;
     numero = "";
     numero = "000000" + #99#1;
     numero = numero % -106;
     |SI numero ! #0#0; |O #99#2 ! #0#29;
         |SI sw = 1;
             |HAZ totalalb;
         |FINSI;
         sw = 1;
     |FINSI;
     |DDEFECTO #0;
     #0#0 = numero;      || Numero.
     #0#29 = #99#2;      || serie albaran
     |HAZ leecabeza;
     #0#1 = #99#3;       || Linea.
     #0#2 = #99#4;       || Cod. Articulo
     |ABRE #2;
     #2#0 = #99#4;
     |LEE 141#2=;
     |LIBERA #2;
     |CIERRA #2;
     #0#3 = #99#11;      || Almacen.
     #0#4 = #99#5;       || Descripcion
     #0#6 = #99#7;       || Precio
     #0#7 = #99#10;      || Importe
     #0#8 = #99#8;       || Dto
     #0#9 = 0;           || Importe total
     #0#11 = #99#9;      || Tipo iva
     #0#12 = 0;          || n.pedido
     #0#13 = #2#2;       || familia
     #0#14 = #2#9;       || coste
     #0#62 = #0#5 * #2#208; ||Punto Verde
     #0#49 = #99#17;  ||Partida
     |ABRE #98;
     #98#0 = #99#0;
     #98#1 = #99#1;
     #98#2 = #99#2;
     |LEE 141#98=;       || LEE CABECERA REVISION PSION
     |LIBERA #98;
     |CIERRA #98;
     #0#15 = #98#4;      || cliente

     |HAZ Unidadess;

     |HAZ totli;         || Calcula el total de la linea y albaran
     #0#36 = #0#6;
     #0#37 = #0#9;
     #0#38 = #0#6;
     #0#39 = #0#9;
     |ABRE #6;
     #6#0 = #98#4;
     |LEE 141#6=;
     |LIBERA #6;
     |CIERRA #6;
     #0#17 = #6#4;       || tipo cliente
     |HAZ miraques;
     |HAZ liacarti;
     |HAZ defecli;
     |HAZ lisubcom;
     |HAZ mirespor;
     |HAZ totli;
     |GRABA 141#0n;
     |LIBERA #0;
     |GRABA 141#1a;
     |LIBERA #1;
     |SI FSalida ! 0;
         aviso = "0000Linea " + #0#1 + " albaran / EXISTE";
     |FINSI;
     numero = #0
     tbruto = tbruto + #0#9;
|FPRC;

|DEFBUCLE leelin;
     #99#1;
     ;
     "A","     ",000000,000;
     "A","zzzzz",999999,999;
     be;
     NULL,linalb;
|FIN;

|PROGRAMA;
     aMoneda = "B";
     aDivisa = "EUR";
     |HAZ Divisas010;

     modo = 1;
     |ABRE #0;
     |BUCLE leelin;
     |HAZ totalalb;
     |CIERRA #0;
|FPRO;

|PROCESO totalalb;
           #1#15 = tbruto;
           neto = tbruto - #1#25;
           resto = #1#16 + #1#19 + #1#22 + #1#44 + #1#47
           diferencia = neto - resto;
           |SI diferencia ! 0;
               |SI #1#16 ! 0;
                   #1#16 = #1#16 + diferencia;
               |SINO;
                   |SI #1#19 ! 0;
                       #1#19 = #1#19 + diferencia;
                   |SINO;
                       |SI #1#22 ! 0;
                           #1#22 = #1#22 + diferencia;
                       |FINSI;
                   |FINSI;
               |FINSI;
           |FINSI;
           |GRABA 141#1a;
           |LIBERA #1;
           #1#15 = 0; tbruto = 0;
|FPRC;

|PROCESO leecabeza;
     #1#52 = #0#29;
     #1#0  = #0#0;
     |LEE 121#1=;
     |LIBERA #1;
|FPRC;

|PROCESO para_ger;
     |ABRE #42;
     #42#0 = "A";
     |LEE 001#42=;
     |SI FSalida ! 0; |DDEFECTO #42; |FINSI;
     |LIBERA #42;
     |CIERRA #42;
|FPRC;

|PROCESO LeeDivisa;
     |ABRE #44;
     |ABRE #45;
     #44#0 = "A";
     |LEE 001#44=;
     |SI FSalida ! 0; |DDEFECTO #44; |FINSI;
     #45#0 = #44#9;
     |LEE 001#45=;
     |SI FSalida ! 0; |DDEFECTO #45; |FINSI;
     |LIBERA #44;
     |LIBERA #45;
     |CIERRA #44;
     |CIERRA #45;
|FPRC;
