|| -------- Listado Totales Ventas Con Rappels (Fact.Contado) --------------

|FICHEROS;
fmart003 #0; || listresu #0;   || albad016
fmart002 #3; ||rappels  #3;   || albad005
fmart004 #4; ||tempresu #4;   || albad020
agifa024 #5;
fmart005 #6; ||temtresa #6;   || albad021
agifa019 #7;
agifa084 #21;
agifa069 #22;
|FIN;

|VARIABLES;
     nUniPromo = 0;
     nUniBase = 0;
     nImpDto = 0;
     nUniTotal = 0;
     informe  = "listresu";
     informe2 = "listrest";
     informe3 = "listre1";
     informe4 = "listre1t";
     resto = 0;
     unip = 0;
     rapp1 = 0;
     rapp2 = 0;
     rapp3 = 0;
     rapp33 = 0;
     pbon = 0;
     dpp = 0;
     vcaj = 0;
     dtolin = 0;
     &t1 = 0;
     &t2 = 0;
     &t3 = 0;
     &t4 = 0;
     &t5 = 0;
     &t6 = 0;
     &t7 = 0;
     &t10 = 0;
     obseq = 0;
     a = -1;
     sw = 0;
     codigo = "";
     precio = 0;
     implin = 0;
     imprap = 0;
|FIN;

|CALCULO flinpro;
     |SI #22#45 = -1; || Linea de promocion
          |ACABA;
     |FINSI;
     nUniPromo = #22#48;
     nUniBase = #22#5;
     nImpDto = #22#46;
     nUniTotal = nUniBase + nUniPromo;

     |ABRE #7;
     #7#0 = #22#2;
     |LEE 111#7=;
     |LIBERA #7;

     |SI #7#125 ] #0#15;|Y #7#125 [ #0#16;
     #4#0 = #21#3;
     #4#1 = #22#2;
     |LEE 101#4=;
     |SI FSalida ! 0;
       |GRABA 021#4c;
       |LIBERA #4;
     |FINSI;

     || ------ Acumulacion de Totales En Temporal --------------

       #4#2 = #4#2 + nUniTotal;         || Cantidad total incluido promociones
       precio = #22#6 + nImpDto;
       implin = nUniTotal * precio;
       #4#4 = #4#4 + implin;       || Importe total no incluido bonificaciones
       pbon = nImpDto * nUniTotal;
       #4#5 = #4#5 + pbon;         || Pesetas Bonificacion
       dtolin = #22#9 - #22#7;
       #4#5 = #4#5 + dtolin;       || Pesetas Bonificacion + Descuento Lineal

       dpp = #22#9 % #21#7;
       |SI #7#125 = "E";
         dpp = 0;
       |FINSI;
       #4#6 = #4#6 + dpp;          || Dto P.P.
       vcaj = nUniPromo * precio;
       #4#7 = #4#7 + vcaj;         || Valor Cajas Promocion a precio sin bonificaciones
       #4#9 = #4#9 + nUniBase;        || Unidades Base
       imprap = nUniBase * precio;
       #4#10 = #4#10 + imprap;     || Importe Para Rappels

       ||   -------- Rappels Entregados ------------
       |SI #21#48 ] "Z ";|Y #21#48 [ "ZZ";
         #4#11 = #4#11 + #22#9;
       |FINSI;

       ||   -------- Rappels ------------
       |SI #21#48 < "Z ";|O #21#48 > "ZZ";
         #3#0 = #21#3;
         #3#1 = #22#2;
         |LEE 001#3=;
         |LIBERA #3;
         |SI FSalida = 0;
           rapp1 = #4#10 % #3#2;
           rapp2 = #4#9 * #3#3;
           unip = #4#9 / #3#4;
           resto = #4#9 $ #3#4;
           resto = resto / #3#4;
           unip = unip - resto;
           rapp33 = unip * #3#5;
           rapp3 = rapp33 * precio;
           #4#3 = rapp1 + rapp2 + rapp3; ||Rappels
         |FINSI;
       |FINSI;

     |GRABA 021#4a;
     |LIBERA #4;

     imprap = 0;
     implin = 0;
     unip = 0;
     resto = 0;
     rapp1 = 0;
     rapp2 = 0;
     rapp33 = 0;
     rapp3 = 0;
     pbon = 0;
     dpp = 0;
     vcaj = 0;
     dtolin = 0;
     obseq = 0;
     precio = 0;
     #4#2 = 0;
     #4#3 = 0;
     #4#4 = 0;
     #4#5 = 0;
     #4#6 = 0;
     #4#7 = 0;
     #4#8 = 0;
     #4#9 = 0;
     #4#10 = 0;
     #4#11 = 0;

     |FINSI;
     |LIBERA #7;
     |CIERRA #7;
|FCAL;

|CALCULO fproceso;
     |HAZ fproceso1;
|FCAL;

|CALCULO fproceso1;        ||Todos Las Facturas Seleccionadas
#5#0 = #21#3;
|LEE 000#5=;
|SI FSalida = 0;
  |SI #5#158 ] #0#2;|Y #5#158 [ #0#3;  ||grupo
    |SI #5#3 ] #0#17;|Y #5#3 [ #0#18;  ||Zona
      |BUCLELIN 2flinpro#21;
    |FINSI;
  |FINSI;
|FINSI;
|LIBERA #5;
|FCAL;

|DEFBUCLE fistresu1;
#21#4;    || Serie, F.Factura, Numero y Cliente
3;
#0#7, #0#4, #0#9, #0#0;
#0#8, #0#5, #0#10, #0#1;
be;
NULL,fproceso;
#7#125,#7#2;
|FIN;

|CALCULO ftotales;
#6#0 = #4#1;
|LEE 101#6=;
|SI FSalida ! 0;
  |GRABA 021#6c;
  |LIBERA #6;
|FINSI;
  #6#0 = #4#1;
  #6#1 = #6#1 + #4#2;
  #6#2 = #6#2 + #4#3;
  #6#3 = #6#3 + #4#4;
  #6#4 = #6#4 + #4#5;
  #6#5 = #6#5 + #4#6;
  #6#6 = #6#6 + #4#7;
  #6#7 = #6#7 + #4#8;
  #6#8 = #6#8 + #4#9;
  #6#9 = #6#9 + #4#10;
  #6#10 = #6#10 + #4#11;
|GRABA 021#6a;
|LIBERA #6;

#6#1 = 0;
#6#2 = 0;
#6#3 = 0;
#6#4 = 0;
#6#5 = 0;
#6#6 = 0;
#6#7 = 0;
#6#8 = 0;
#6#9 = 0;
#6#10 = 0;
|FCAL;

|DEFBUCLE ftotal;
#4#1;
;
"      " , "                    ";
"zzzzzz" , "zzzzzzzzzzzzzzzzzzzz";
be;
NULL , ftotales;
|FIN;

|CALCULO facturas;
|ABRE #3;
|ABRE #4;
|ABRE #5;
|ABRE #6;
|ABRE #21;
|ABRE #22;
|BUCLE fistresu1;
|BUCLE ftotal;
|LIBERA #3;
|LIBERA #4;
|LIBERA #5;
|LIBERA #6;
|LIBERA #21;
|LIBERA #22;
|CIERRA #3;
|CIERRA #4;
|CIERRA #5;
|CIERRA #6;
|CIERRA #21;
|CIERRA #22;
|FCAL;
