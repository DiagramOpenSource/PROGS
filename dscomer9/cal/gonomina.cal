|FICHEROS;
     gonomina #0; ||Este Def.
     aomentr@ #1; ||Horas.
     aomobra@ #2; ||Maestro Obras.
     gomantho #3; ||Expedientes.
     gomantli #4; ||Lineas de Expedientes.
     gonomtmp #5; ||Temporal.
     gopre004 #6; ||Desglose Presupuesto.
     goparame #7; ||Parametros Obra.
     gonomtm2 #8; ||Temporal.
     aomhora@ #9; ||Tipos Horas.
     gopre001 #10;
     gocatcot #19;
     gotrabaj #21;
     gonomtm2 #8;
     gocatcon #30;
     gotrarel;
|FIN;

|VARIABLES;
     &Tempo = "";
     aTmp5 = "";
     aTmp8 = "";
     &efFecha     = @;
     nMoneCat     = "";
     nMoneExp     = "";
     &cCodMonDe   = "";
     &cCodMonA    = "";
     &nPrecioVent = 0;
     &nPrecioComp = 0;
     aPath  = "";
     aPatf  = "";
     aDef   = "";
     aDef1  = "";
     aDef2  = "";
     aDef3  = "";
     aDef4  = "";
     aDef5  = "";
     aDef6  = "";
     aDef7  = "";
     aDef8  = "";
     aDef9  = "";
     aDef10 = "";
     swErr  = 0;
     nObra  = 0;
     aEmpre = "";
     nThora = 0;
     nHora  = 0;
     nSal   = 0;
     aNomi  = "";
     nCodTrab = 0;
     nEmpr = 0;
     nTrab = 0;
|FIN;


|PROCESO xPrecio;
     |DDEFECTO #21;
     |ABRE #21;
     #21#0 = #8#0;
     |LEE 000#21=;
     |CIERRA #21;

     |DDEFECTO #30;
     |ABRE #30;
     #30#0 = #21#3;
     #30#0 = #21#2;
     |LEE 000#30=;
     |CIERRA #30;

     |ABRE #10;
     |ABRE #6;
     |ABRE #19;

/*
     |DDEFECTO #19;
     #19#0 = #21#3;  ||Categoria.
     #19#1 = #21#2;  ||Convenio.
     #19#2 = #8#7;   ||Tipo Horas.
     |LEE 000#19=;
     #19#5 = #9#1;
     |SI FSalida = 0;
          |GRABA 020#19a;
          |LIBERA #19;
     |SINO;
          |GRABA 020#19n;
     |FINSI;
*/
     #10#0 = #8#2;                            ||Serie Pres.
     #10#1 = #8#3;                            ||Numero Pres.
     |LEE 000#10=;
     |SI FSalida = 0;
          #8#14 = #10#18;                     ||Tipo Presupuesto.
          #8#13 = #10#7;                      ||Moneda Trabajo.

          #19#0 = #21#3; ||Categoria.
          #19#1 = #21#2; ||Convenio.
          #19#2 = #8#7;  ||Tipo Horas.
          |LEE 000#19=;
          |SI FSalida ! 0;
               |SI #10#18 = "P";
                    #8#12 = #30#4;                 ||PVP Pres.
               |FINSI;
               |SI #10#18 = "A";
                    #8#12 = #30#9;                 ||PVP Admi.
               |FINSI;
               |SI #10#18 = "E";
                    #8#12 = #30#10;                 ||PVP Extr.
               |FINSI;
          |SINO;
               |SI #10#18 = "P";
                    #8#12 = #19#5;                 ||PVP Pres.
               |FINSI;
               |SI #10#18 = "A";
                    #8#12 = #19#7;                 ||PVP Admi.
               |FINSI;
               |SI #10#18 = "E";
                    #8#12 = #19#9;                 ||PVP Extr.
               |FINSI;
          |FINSI;
          |SI nMoneCat ! nMoneExp;
               cCodMonDe   = nMoneCat;
               cCodMonA    = nMoneExp;
               nPrecioComp = #8#12;
               |HAZ DemonAmon;
               #8#12 = nPrecioComp;
          |FINSI;

          #6#0 = #8#2;                            ||Serie Pres.
          #6#1 = #8#3;                            ||Numero Pres.
          #6#3 = #8#5;                            ||Partida.
          #6#5 = #30#13;                          ||Codigo MO.
          |LEE 000#6=;

          |SI FSalida = 0;
               #8#11 = #6#9;
          |SINO;
               #19#0 = #21#3; ||Categoria.
               #19#1 = #21#2; ||Convenio.
               #19#2 = #8#7;  ||Tipo Horas.
               |LEE 000#19=;
               |SI FSalida ! 0;
                    |SI #10#18 = "P";
                         #8#11 = #30#3;                ||PVP.
                         #8#12 = #30#4;                ||PVC.
                    |FINSI;
                    |SI #10#18 = "A";
                         #8#11 = #30#7;                ||PVP.
                         #8#12 = #30#9;                ||PVP.
                    |FINSI;
                    |SI #10#18 = "E";
                         #8#11 = #30#8;                ||PVP.
                         #8#12 = #30#10;                ||PVP.
                    |FINSI;
               |SINO;
                    |SI #10#18 = "P";
                         #8#11 = #19#4;                 ||PVP.
                         #8#12 = #19#5;                 ||PVC.
                    |FINSI;
                    |SI #10#18 = "A";
                         #8#11 = #19#6;                 ||PVP.
                         #8#12 = #19#7;                 ||PVC.
                    |FINSI;
                    |SI #10#18 = "E";
                         #8#11 = #19#8;                 ||PVP.
                         #8#12 = #19#9;                 ||PVC.
                    |FINSI;
               |FINSI;
               |SI nMoneCat ! nMoneExp;
                    cCodMonDe   = nMoneCat;
                    cCodMonA    = nMoneExp;
                    nPrecioComp = #8#12;
                    |HAZ DemonAmon;
                    #8#12 = nPrecioComp;
               |FINSI;
               |SI nMoneCat ! nMoneExp;
                    cCodMonDe   = nMoneCat;
                    cCodMonA    = nMoneExp;
                    nPrecioVent = #8#11;
                    |HAZ DemonAmon;
                    #8#11 = nPrecioVent;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #10;
     |CIERRA #6;
     |CIERRA #19;
|FPRC;

|PROCESO BuscaTrab;
     nCodTrab = #gotrarel#0;
|FPRC;

|DEFBUCLE BuscaTrab;
     #gotrarel#1;
     1, 2;
     00001, "          ", nEmpr, nTrab;
     99999, "zzzzzzzzzz", nEmpr, nTrab;
     ;
     NULL, BuscaTrab;
|FIN;

|PROCESO aomopatm3;
     nHora = #1#5 % #5#5;
     |SI nHora ! 0;
          |DDEFECTO #9;
          #9#0 = #1#4;
          |LEE 000#9=;

          nCodTrab = 0;
          nEmpr = #1#2;
          nTrab = #1#3;
          |BUCLE BuscaTrab;
          |DDEFECTO #8;

          || #8#0 = #1#3; ||Cod.Trabajador.
          #8#0 = nCodTrab; ||Cod.Trabajador.
          |SI nCodTrab = 0;
               |ACABA;   || no he encontrado codigo de trabajador
          |FINSI;
          #8#1 = #1#0; ||Fecha.
          #8#2 = #5#0; ||Serie Presupuesto.
          #8#3 = #5#1; ||Numero Presupuesto.
          #8#4 = #5#2; ||Capitulo.
          #8#5 = #5#3; ||Partida.
          #8#7 = #1#4; ||Tipo HOras.
          |HAZ xPrecio;
          |LEE 101#8=;
          nSal = FSalida;
          #8#6 = #8#6 + nHora; ||Horas aSignadas.
          #8#8 = #3#0; ||Serie Expediente
          #8#9 = #3#1; ||Numero Expediente.
          #8#10 = #9#1;
          |SI nSal = 0; |GRABA 020#8a; |FINSI;
          |SI nSal ! 0; |GRABA 020#8n; |FINSI;
          |LIBERA #8;
     |FINSI;
|FPRC;

|DEFBUCLE aomopatm3;
     #5#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL,aomopatm3;
|FIN;

|PROCESO aomentra;
     |BUCLE aomopatm3;
|FPRC;

|DEFBUCLE aomentra;
     #1#1006;
     ;
     #0#1,#0#3,#0#5,nObra,000000,01;
     #0#2,#0#4,#0#6,nObra,999999,99;
     ;
     NULL,aomentra;
|FIN;

|PROCESO aomopatm2;
     #5#5 = (#5#4 * 100) / nThora;
     |GRABA 020#5a;
|FPRC;

|DEFBUCLE aomopatm2;
     #5#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL,aomopatm2;
|FIN;

|PROCESO aomopatm;
     nThora = nThora + #5#4;
|FPRC;

|DEFBUCLE aomopatm;
     #5#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL,aomopatm;
|FIN;

|PROCESO gopre004;
     |SI #7#5 ! #6#14; |ACABA; |FINSI;
     |DDEFECTO #5;
     #5#0 = #6#0;
     #5#1 = #6#1;
     #5#2 = #6#2;
     #5#3 = #6#3;
     |LEE 101#5=;
     nSal = FSalida;
     #5#4 = #5#4 + #6#8;
     #5#5 = 0;
     #5#6 = 0;
     |SI nSal ! 0; |GRABA 020#5n; |FINSI;
     |SI nSal = 0; |GRABA 020#5a; |FINSI;
     |LIBERA #5;
|FPRC;

|DEFBUCLE gopre004;
     #6#1;
     ;
     #4#3,#4#4,"                    ","                    ",  1;
     #4#3,#4#4,"zzzzzzzzzzzzzzzzzzzz","zzzzzzzzzzzzzzzzzzzz",999;
     ;
     NULL,gopre004;
|FIN;

|PROCESO gomantl1;
     |BUCLE gopre004;
|FPRC;

|DEFBUCLE gomantl1;
     #4#1;
     ;
     #3#0,#3#1,001;
     #3#0,#3#1,999;
     ;
     NULL,gomantl1;
|FIN;

|PROGRAMA;
     |HAZ CreaTempo; aTmp5 = Tempo;
     |HAZ CreaTempo; aTmp8 = Tempo;
     |NOME_DAT #5 aTmp5; |DELINDEX #5;
     |NOME_DAT #8 aTmp8; |DELINDEX #8;

     |CLS;
     |ABRE #0;
     #0#0 = 1;
     |LEE 101#0=;
     |SI FSalida ! 0;
          |DDEFECTO #0;
          |GRABA 020#0b;
     |FINSI;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida ! 0;  |CIERRA #0;  |ACABA;  |FINSI;
     |GRABA 020#0a;
     |HAZ CargaDef;
     |SI swErr = 1;
         |HAZ DesCargaDef;
     |SINO;
         |PATH_DAT #1 aPatf;
         |PATH_DAT #2 aPatf;
         |ABRE #2;
         |SELECT #3#2;
         #2#2 = #0#7;
         |LEE 000#2=;
         |SI FSalida = 0;
             nObra   = #2#0;
         |FINSI;
         |CIERRA #2;
         |ABRE #3;
         |SELECT #2#3;
         #3#28 = #0#7;
         |LEE 000#3=;
         |SI FSalida = 0;
             |DELINDEX #5;
             |DELINDEX #8;
             |ABRE #5;
             |ABRE #7;
             |DDEFECTO #7;
             #7#0 = "A";
             |LEE 000#7=;
             |CIERRA #7;
             |BUCLE gomantl1;
             |CIERRA #5;
             |BUCLE aomopatm;
             |BUCLE aomopatm2;
             |ABRE #8;
             |ABRE #9;
             |BUCLE aomentra;
             |CIERRA #8;
             |CIERRA #9;
             |HAZ segundaparte;
         |FINSI;
         |CIERRA #3;
     |FINSI;
     |LIBERA #0;
     |CIERRA #0;
     |HAZ DesCargaDef;

     Tempo = aTmp5; |HAZ BoraTempo; |DELINDEX #5;
     Tempo = aTmp8; |HAZ BoraTempo; |DELINDEX #8;
|FPRO;

|PROCESO CargaDef;
     |DBASS aPath;
     |QBF aPath;
     aNomi = #0#8;  |QBF aNomi;
     aPath = aPath + aNomi + "/";
     aPatf = aPath + "fich/";

     aDef1 = aPath + "def/" + "aomentra";
     aDef  = aDef1;
     |CARGA_DEF aDef, aomentr@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef1 = "";
          |ACABA;
     |FINSI;

     aDef2 = aPath + "def/" + "aomobras";
     aDef  = aDef2;
     |CARGA_DEF aDef, aomobra@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef2 = "";
          |ACABA;
     |FINSI;

     aDef3 = aPath + "def/" + "aomhoras";
     aDef  = aDef3;
     |CARGA_DEF aDef, aomhora@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef3 = "";
          |ACABA;
     |FINSI;

|FPRC;

|PROCESO DesCargaDef;
     |SI aDef3  ! ""; |DESCARGA_DEF #aomhora@; |FINSI;
     |SI aDef2  ! ""; |DESCARGA_DEF #aomobra@; |FINSI;
     |SI aDef1  ! ""; |DESCARGA_DEF #aomentr@; |FINSI;
|FPRC;
