|FICHEROS;
     agifa073 #0;   || Lineas de pedido
     agifa104 #1;   || Pedido
     agifa019 #2;   || Articulos
     agifa129 #3;   || Tipos de comision
     agifa128 #4;   || Comision tipo de cliente
     agifa039 #5;   || Descuentos
     agifa024 #6;   || Clientes
     agifa017 #8;   || Stocks almacenes
     agifa048 #13;  || Escandallos
     agifa049 #14;  || Lineas de escandallos
     agifa023 #10;  || Precio cliente/articulo
     albap004 #98;  || Cabecera revision.
     albap005 #99;  || Lineas revision.
|FIN;

|CAMPOS;
     #2#11 nec;  #2#15 sps;    #2#16 spr;
     #2#7 stmia; #2#104 stdia; #2#12 stres;
     #2#17 pdva; #2#13 stfa;
|FIN;

|VARIABLES;
     &EURODB = 0;
     vacio = "             ";
     descu = 0;
     tf = 0;
     comi1 = 0;
     comi2 = 0;
     comi3 = 0;
     menor = 0;
     pcr = 0;
     cantidad = 0;
     articulo = " ";
     mensaje3 = "0410 Stock Disponible Almacen :             Stock Minimo : ";
     mensaje  = "0000 Pedido para Exportacion.Tipo de IVA = 0  !!";
     pc = 0;
     &n_dec = 0;
     &n_pre = 0;
     codigo = "";
     &ext1 = "";
     modo = 0;
     mes = 0;
     sw_pend = 0;
     numero = "";
     pendiente = 0;
|FIN;

|CALCULO mirespor;|TIPO 0;
     |SI #6#28 = AS;|Y #0#14 ! 0;
||          |MENAV mensaje;
          #0#14 = 0;
||          |PINTA #0#14;
     |FINSI;
|FCAL;

|CALCULO lpinfo;|TIPO 0;
     ||MENSA mensaje3;
||     |PINTA 437,#8#39;
||     |PINTA 465,#8#6;
|FCAL;

|CALCULO lpcogea;|TIPO 0;
     articulo = #0#2;
|FCAL;

|CALCULO lpdefec;|TIPO 0;
     #0#16 = #1#7;  || #lin.pedidos#representante=#pedido#representante
     #0#17 = #1#16; || #lin.pedidos#tipo de comision=#pedidos#tipo de comision
     #0#20 = #1#4;  || #lin.pedidos#cliente=#pedidos#cliente
|| Esta linea la pongo aqui porque con un D003agifa104. Pasa de todo
|| Lorca 22/04/94
     #0#13= #1#2;   || #lin.pedidos#fecha entrega=#pedidos#fecha 1 entrega
     |SI #0#2 ! #2#0;
          |ABRE #2;
          #2#0 = #0#2;
          |LEE 000#2=;
          |LIBERA #2;
          |CIERRA #2;
     |FINSI;
     |SI #0#20 ! #6#0;
          |ABRE #6;
          #6#0 = #0#20;
          |LEE 000#6=;
          |LIBERA #6;
          |CIERRA #6;
     |FINSI;
     #0#18 = #2#2;
     #0#19 = #6#4;
     descu = FEntrada $ 100;
     |SI 1 = descu;|O articulo ! #0#2;
          articulo = #0#2;
          descu = 0;
          tf = #6#39;
          |ABRE #10;
          #10#0 = #0#20;
          #10#1 = #0#2;
          |LEE 040#10=;
          |LIBERA #10;
          |SI FSalida = 0; |Y #1#1 ] #10#28; |Y #1#1 [ #10#29;
               ||#0#6 = #10#2;||Precio Cliente/Articulo
||               |PINTA #0#6;
          |SINO;
               pc = tf + 17;
               ||#0#6 = #2pc;
||               |PINTA #0#6;
          |FINSI;
          |LIBERA #10;
          |CIERRA #10;             ||Antes no se cerraba
          FSalida = 0;
          |ABRE #5;
          #5#0 = #0#20;#5#1 = #0#18;
          |LEE 000#5=;
          |SI FSalida = 0; |Y #1#1 ] #5#3; |Y #1#1 [ #5#4;
               descu = #5#2;
          |FINSI;
          |LIBERA #5;
          |CIERRA #5;
          |SI descu = 0;
               pc = tf + 20;
               descu = #2pc;
          |FINSI;
          ||#0#8 = descu;||      |PINTA #0#8;
          comi1 = #2#31;
          FSalida = 0;
          |SI #4#0 ! #0#19;
               |ABRE #4;
               #4#0 = #0#19;
               |LEE 000#4=;
               |LIBERA #4;
          |FINSI;
          comi2 = 0;
          |SI 0 = FSalida
               comi2 = #4#1;
          |FINSI;
          |LIBERA #4;
          |CIERRA #4;
          |HAZ lpsubcom;
     |FINSI;
|FCAL;

|CALCULO lpcomis;|TIPO 0;
     |SI #0Campo ! Contenido;
          descu = #0Campo;
          |HAZ lpsubcom;
     |FINSI;
|FCAL;

|CALCULO lpsubcom;|TIPO 0;
     FSalida = 0;
     |SI #3#0 ! #0#17;
          |ABRE #3;
          comi3 = 0;
          #3#0 = #0#17;
          |LEE 000#3=;
          |LIBERA #3;
     |FINSI;
     |SI 0 = FSalida;
          menor = 100;
          |PARA pc = 1;|SI pc < 40;|HACIENDO pc = pc + 2;
               pcr = pc + 1;
               |SI #3pc ! 0;|Y #3pcr ! 0;
                    tf = #3pc;
                    |SI tf ] descu;|Y tf < menor;
                         menor = tf;
                         comi3 = #3pcr;
                    |FINSI;
               |SINO;
                    pc = 40;
               |FINSI;
          |SIGUE;
     |FINSI;
     |LIBERA #3;
     |CIERRA #3;
     menor = 100;
     |SI comi1 > 0;
          menor = comi1;
     |FINSI;
     |SI comi2 > 0;|Y comi2 < menor;
          menor = comi2;
     |FINSI;
     |SI comi3 > 0;|Y comi3 < menor;
          menor = comi3;
     |FINSI;
     |SI menor = 100;
          menor = 0;
     |FINSI;
     #0#10 = menor;||      |PINTA #0#10;
|FCAL;

|PROCESO unidades; |TIPO 0;
     #0#5 = #0#5 ! n_dec;
||     |PINTA #0#5;
|FPRC;

|CALCULO totallip;|TIPO 0;
     |SI Campo = 5;|Y #0#5 ! Contenido;
          menor = Contenido - #0#12;
          ||#0#12 = #0#5 - menor;
          |SI #0#12 < 0;
               |AVISO;
               #0#5 = menor;
||               |PINTA #0#5;
               ||#0#12 = 0;
          |FINSI;
||          |PINTA #0#12;
     |FINSI;
     ||SI #0#30 ! 0;
       #0#7 = #0#30 * #0#6;
     ||SINO;
       ||#0#7 = #0#5 * #0#6;
     ||FINSI;
     #0#34 = #0#5 * #0#33;
     ||#0#7 = #0#7 + #0#34;
     #0#9 = #0#7 < #0#8;
     #0#9 = #0#9 < #0#29;
     #0#9 = #0#9 < #1#5;
     ||#0#9 = #0#9 < #1#17;
     #0#9 = #0#9 < #1#6;
     #0#9 = #0#9 + #0#34;
     #0#9 = #0#9 ! EURODB;
||     |PINTA #0#9;
     #0#11 = #0#9;
|FCAL;


|CALCULO lpacarti;|TIPO 2;
||     modo = (FEntrada / 100) ! 0;
     mes = 0 +. 1;
     codigo = #0#2; |QBF codigo;
     |SI #0#12 = 0; |Y codigo ! ""; |Y modo = 2;
||sw_pend controla si se entra por primera o segunda vez
          |SI mes = -1; |O sw_pend = 1;
||               |SI sw_pend=0;|MENAV "0000Linea servida por completo"; |FINSI;
               sw_pend = 1;
               |ERROR;
               |ACABA;
          |FINSI;
     |SINO;
          sw_pend = 0;
     |FINSI;
     |SI Campo < 3;
          |HAZ lpdefec;
     |FINSI;
     |ABRE #2;
     #2#0 = #0#2;
     |LEE 121#2=;
     |LIBERA #2;
     |SI 0 = FSalida;
          #2#15 = #2#15 +. #0#12;
          |SI #0#22 = AS;
               stres = stres +. #0#12;
               stdia = stdia -. #0#12;
          |FINSI;
          nec = sps + stmia; nec = nec - spr; nec = nec - stdia;
          nec = nec - pdva;  nec = nec - stfa;nec = nec - stres;
          |GRABA 020#2a;
          |LIBERA #2;
     |FINSI;
     |ABRE #8;
     #8#0 = #0#2;
     #8#1 = #0#3;
     |LEE 121#8=;
     |LIBERA #8;
     |SI 0 = FSalida;
          |HAZ actualiz;
          |SI #0#22 = AS;
               #8#8 = #8#8 +. #0#12;
               #8#39 = #8#39 -. #0#12;
               |GRABA 020#8a;
               |LIBERA #8;
          |FINSI;
          |LIBERA #2;
          |LIBERA #8;
     |FINSI;
     |LIBERA #2;
     |CIERRA #2;
     |LIBERA #8;
     |CIERRA #8;
     #1#11 = #1#11 +. #0#9;
     #1#11 = #1#11 ! EURODB;
     #1#12 = #1#11;
     #1#12 = #1#12 ! EURODB;
     #1#13 = #1#11 - #1#12;
     #1#13 = #1#13 ! EURODB;
     #1#26 = #1#26 +. #0#34;

||     |PINTA 1448,#1#12;|PINTA 1459,#1#13;|PINTA 1469,#1#11;
|FCAL;

||***************************** CALCULO ESCANDALLOS *******************;

|CALCULO linescan;
   #2#0 = #14#2;
   |LEE 040#2=;
   |LIBERA #2;
   |SI FSalida = 0;
           cantidad = #0#5 * #14#4;
        #2#15 = #2#15 +. cantidad;
        |LEE 110#2=;
        |LIBERA #2;
        |GRABA 040#2a;
        |LIBERA #2;

        |DDEFECTO #8;
        #8#0 = #14#2; ||Articulo;
        #8#1 = #14#9; ||Almacen;
        |LEE 110#8=;
        |LIBERA #8;
        |SI FSalida = 0;
              cantidad = #0#5 * #14#4;
              #8#4 = #8#4 +. cantidad;
           |GRABA 040#8a;
           |LIBERA #8;
        |FINSI;
   |FINSI;
|FCAL;

|CALCULO actualiz;
     |ABRE #13;
     #13#0 = #0#2;
     |LEE 040#13=;
     |LIBERA #13;
     |SI FSalida = 0;
          #2#0 = #13#0;
          |LEE 040#2=;
          |LIBERA #2;
          |BUCLELIN 0linescan#13;
     |FINSI;
     |LIBERA #13;
     |CIERRA #13;
|FCAL;


|PROCESO pasa;
     numero = "000000" + #99#1;
     numero = numero % -106;
     |DDEFECTO #0;
     #0#0 = numero;                || Numero Pedido.
     #0#28 = #99#2;                || Serie Pedido.
     #1#0 = #0#0;                  || Numero Pedido Cabecera.
     #1#25 = #0#28;                || Serie Pedido Cab.
     |LEE 121#1=;                  || Lee cabecera de Pedidos.
     |LIBERA #1;
     #0#1 = #99#3;                 || Linea Pedidos.
     |ABRE #98;
          #98#0 = #99#0;
          #98#1 = #99#1;
          #98#2 = #99#2;
          |LEE 000#98=;
     |LIBERA #98;
     |CIERRA #98;
     #0#2 = #99#4;                 || Cod. Articulo.
     |ABRE #2;
          #2#0 = #99#4;
          |LEE 000#2=;
     |LIBERA #2;
     |CIERRA #2;
     #0#3 = #99#11;                || Nro. Almacen.
     #0#4 = #2#1;                  || Descrip. Articulo.
     #0#5 = #99#6;                 || Unidades.
     #0#6 = #99#7;                 || Precio.
     |SI #99#14 ! 0;
       #0#7 = #99#14 * #99#7;      || Importe.
     |SINO;
       #0#7 = #99#6 * #99#7;       || Importe.
     |FINSI;
     #0#8 = #99#8;                 || Dto.
     #0#33 = #99#15;
     #0#34 = #0#5 * #0#33;
     #0#7 = #0#7 + #0#34;
     #0#9 = #0#7 < #0#8;           || Importe Total.
     #0#11 = #0#9;                 || Importe Pendiente de servir.
     #0#12 = #0#5;                 || Pendiente de servir.
     #0#14 = #99#9;                || Tipo Iva.
     #0#18 = #2#2;                 || Familia.
     #0#20 = #98#4;                || Cliente.
     #0#30 = #99#14;               || Unidades Base.
     #0#31 = #99#12;               || Unidades Promocion.
     #0#32 = #99#13;               || Pesetas Promocion.
     |ABRE #6;
          #6#0 = #98#4;
          |LEE 000#6=;
     |LIBERA #6;
     |CIERRA #6;
     #0#19 = #6#4;                 || Tipo cliente.

     |HAZ lpcogea;
     |HAZ lpacarti;
     |HAZ lpdefec;
     |HAZ lpinfo;
     |HAZ mirespor;
     |HAZ unidades;
     |HAZ totallip;
     |HAZ lpcomis;
     |GRABA 121#0n;
     |LIBERA #0;
|FPRC;

|DEFBUCLE lee_lineas;
     #99#1;
     ;
     "P","  ",000000,001;
     "P","zz",999999,999;
     be;
     NULL,pasa;
|FIN;

|PROGRAMA;
     modo = 1;
     |ABRE #0;
     |ABRE #1;
     |BUCLE lee_lineas;
     |LIBERA #0;
     |CIERRA #0;
     |LIBERA #1;
     |CIERRA #1;
|FPRO;
