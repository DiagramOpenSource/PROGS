|FICHEROS;
     golis024 #0;
     gomantho #1;
     gomantl1 #2;
     gopre001 #3;
     gopre002 #4;
     gopre003 #5;
     gopartia #10;
     goparame #11;
     goartmer #12;
     agifa019 #19;
     gocercab #20;
     gocerlin #21;
     go000024 #24;
     goalbpa5 #50;
     agifa065 #65;
     guerw071 #71; || Tmp
     agifa084;
|FIN;

|VARIABLES;
     nHayPre = 0;
     nTotValor = 0;
     &enValIni = 0;
     &enValFin = 0;
     &enCapitulo = 0;
     &enPartida = 0;
     &enPre=0;
     &enEje=0;
     &enCer=0;
     nNume = 0;
     nHay = 0;
     aDesde = "";
     aHasta = "";
     &nVenta1 = 0;
     &nCoste1 = 0;
     &nCertifPer = 0;
     &nCertifTot = 0;
     &nFacturTot = 0;
     &nFacturPer = 0;
     nFactur = 0;

     nPrecio = 0;
     nPrecio44 = 0;
     nTotal = 0;
     nPrecio31 = 0;
     nPrecio32 = 0;
     nPrecio33 = 0;
     nTotalacer = 0;
     nTotalACert = 0;
     aSerPres = "";
     nNumPres = 0;
     nLinCer = 0;
     nTotalYACert = 0;
     nTotalYACalc = 0;

     fDFecha = @;
     fHFecha = @;
     nAlmacen = 0;
     nValor = 0;
     aAlfa = "";
|FIN;

|PROCESO Tmp;
     |PRINT;
|FPRC;

|DEFBUCLE Tmp;
     #71#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Tmp;
|FIN;

|PROCESO ImpTmp;
     |IMPRE 0;
     |SI FSalida = 0;
          |INFOR "goli0024";
          |SI FSalida = 0;
               |BUCLE Tmp;
               |PIEINF;
               |FININF;
          |FINSI;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO TmpValor;
     nTotValor = nTotValor + (#71#1 * #71#2);
|FPRC;

|DEFBUCLE TmpValor;
     #71#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, TmpValor;
|FIN;

|PROCESO BuscaLinea;
     nHayPre = 0;
     #50#0 = #65#11;
     #50#1 = #65#3;
     #50#2 = 1;
     |LEE 000#50];
     |PARA; |SI FSalida = 0; |Y #50#0 = #65#11; |Y #50#1 = #65#3; |HACIENDO;
          |SI #65#0 = #50#3;
               nHayPre = 1;
               |SAL;
          |FINSI;
          |LEE 000#50s;
     |SIGUE;;
|FPRC;

|PROCESO Historico;
     |DDEFECTO #19;
     #19#0 = #65#0;
     |LEE 000#19=;
     |SI #19#137 ! "S"; |ACABA; |FINSI;

     nPrecio = #65#14;
     |SI #65#2 = "ME";
          |HAZ BuscaLinea;
          |SI nHayPre = 1;
               nPrecio = #50#9;
          |SINO;
               |DDEFECTO #24;
               #24#0 = #65#11;
               #24#1 = #65#3;
               #24#2 = #65#4;
               |LEE 000#24=;
               |SI FSalida = 0;
                    nPrecio = #24#4;
               |SINO;
                    #12#0 = #65#0;
                    |LEE 000#12=;
                    |SI FSalida = 0; |Y #12#1 ! 0;
                         nPrecio = #12#1;
                    |SINO;
                         nPrecio = #19#9;
                    |FINSI;
                    #24#3 = #65#0;
                    #24#4 = nPrecio;
                    |GRABA 020#24n;
               |FINSI;
          |FINSI;
     |FINSI;

     |DDEFECTO #71;
     #71#0 = #65#0;
     |LEE 101#71=;
     |SI FSalida ! 0;
          #71#1 = #65#6;
          |SI #65#6 > 0;
               #71#2 = nPrecio;
          |FINSI;
          |GRABA 020#71b;
     |SINO;
          |SI #71#1 < 0;
               #71#1 = #71#1 + #65#6;
               #71#2 = nPrecio;
          |SINO;
               |SI #65#6 > 0;
                    nValor = #71#1 * #71#2;
                    nValor = nValor + (#65#6 * nPrecio);
                    #71#1 = #71#1 + #65#6;   || Unidades
                    #71#2 = nValor / #71#1;  || PCM
               |SINO;
                    #71#1 = #71#1 + #65#6;
               |FINSI;
          |FINSI;
          |GRABA 020#71a;
     |FINSI;
     |LIBERA #71;
|FPRC;

|DEFBUCLE Historico;
     #65#1;
     5;
     "                    ", fDFecha, "  ", 000000, 00000, "     ", nAlmacen;
     "zzzzzzzzzzzzzzzzzzzz", fHFecha, "zz", 999999, 99999, "zzzzz", nAlmacen;
     ;
     NULL, Historico;
|FIN;


/*
|PROCESO NoPresup;
     enEje = enEje + #10#14;
|FPRC;

|DEFBUCLE NoPresup;
     #10#3;
     ;
     #0#0, #0#2, "     ", 000001, "                    ", "                    ";
     #0#1, #0#3, "zzzzz", 999999, "                    ", "                    ";
     ;
     NULL, NoPresup;
|FIN;

|PROCESO ConsumosNoPres;
     enEje = 0;
     enPre = 0;
     enCer = 0;
     |BUCLE NoPresup;
     #5#0 = "ZZZZZ";
     #5#1 = 999999;
     #3#8 = "CONSUMOS NO PRESUPUESTADOS";
     enCapitulo = 0;
     #4#13 = "CAPITULO NO ASIGNADO";
     enPartida = 0;
     #5#5 = "PARTIDA NO ASIGNADA";
     |PRINT;
|FPRC;

|PROCESO gopartia;
     enEje = enEje + #10#14;
|FPRC;

|DEFBUCLE gopartia;
     #10#3;
     ;
     #1#0, #1#1, #3#0, #3#1, #5#2, #5#4;
     #1#0, #1#1, #3#0, #3#1, #5#2, #5#4;
     ;
     NULL, gopartia;
|FIN;

|PROCESO Partidas;
     nHay = 1;
     enPartida = enPartida + 1;

     enEje = 0;
     |BUCLE gopartia;

     enPre = #5#11;
     enCer = #5#13;
     |SI #11#55 = "S";
          nNume = #5#1 - #11#54;
          |SALVA_FICHA #5;
          #5#1 = nNume;
          |LEE 000#5=;
          |SI FSalida = 0;
               enCer = enCer + #5#13;
          |FINSI;
          |REPON_FICHA #5;
     |FINSI;
     |PRINT;
|FPRC;

|DEFBUCLE Partidas;
     #5#1;
     ;
     #4#0, #4#1, #4#12, 001;
     #4#0, #4#1, #4#12, 999;
     ;
     NULL, Partidas;
|FIN;

|PROCESO LinPresupu;
     enCapitulo = enCapitulo + 1;
     enPartida = 0;
     |BUCLE Partidas;
|FPRC;

|DEFBUCLE Presupuesto;
     #3#1;
     ;
     #2#3, #2#4;
     #2#3, #2#4;
     ;
     NULL, NULL, LinPresupu;
|FIN;

|PROCESO LinExpediente;
     enCapitulo = 0;
     |BUCLE Presupuesto;
     || migue
     |HAZ ConsumosNoPres;
|FPRC;

*/

|PROCESO gopartia;
     nHay = 1;

     |SI #0#4 [ #10#28; |Y #10#28 [ #0#5;
          nVenta1 = #10#13;
          nCoste1 = #10#14;
     |SINO;
          nVenta1 = 0;
          nCoste1 = 0;
     |FINSI;

     |PRINT;
|FPRC;

|DEFBUCLE gopartia;
     #10#3;
     28;
     #gomantho#0, #gomantho#1, "     ", 000001, aDesde, aDesde, "01.01.0000";
     #gomantho#0, #gomantho#1, "zzzzz", 999999, aHasta, aHasta, #0#5;
     ;
     NULL, gopartia;
|FIN;

|PROCESO BrutoCertif;
     |ABRE #gopre001;
     #gopre001#0 = #gocercab#0;
     #gopre001#1 = #gocercab#1;
     |LEE 000#gopre001.=;
     |SI FSalida = 0;
               nPrecio = nCertifTot;
               nPrecio44 = 0;
               nTotal    = 0;
               nPrecio31 = 0;
               nPrecio32 = 0;
               nPrecio33 = 0;

               nPrecio44 = (nPrecio % #gopre001#43) ! 2;
               nTotal = nPrecio - nPrecio44;
               nPrecio31 = (nTotal % #gopre001#26) ! 2;
               nPrecio32 = (nTotal % #gopre001#27) ! 2;
               nTotal = nTotal + nPrecio31 + nPrecio32;
               nPrecio33 = (nTotal % #gopre001#28) ! 2;
               nTotal = nTotal - nPrecio33;
               nCertifTot = nTotal;

               nPrecio = nCertifPer;
               nPrecio44 = 0;
               nTotalYACalc = 0;
               nPrecio31 = 0;
               nPrecio32 = 0;
               nPrecio33 = 0;

               nPrecio44 = (nPrecio % #gopre001#43) ! 2;
               nTotalYACalc = nPrecio - nPrecio44;
               nPrecio31 = (nTotalYACalc % #gopre001#26) ! 2;
               nPrecio32 = (nTotalYACalc % #gopre001#27) ! 2;
               nTotalYACalc = nTotalYACalc + nPrecio31 + nPrecio32;
               nPrecio33 = (nTotalYACalc % #gopre001#28) ! 2;
               nTotalYACalc = nTotalYACalc - nPrecio33;
               nCertifPer = nTotalYACalc;
     |SINO;
          |MENAV "    ATENCION: No existe el presupuesto";
     |FINSI;
     |CIERRA #gopre001;
|FPRC;

|PROCESO BuscaFactura;
     |ABRE #agifa084;
     #agifa084#48 = #gocerlin#4;
     #agifa084#0 = #gocerlin#5;
     |LEE 000#agifa084.=;
     |SI FSalida = 0;
          nFactur = #agifa084#72;
     |FINSI;
     |CIERRA #agifa084;
|FPRC;

|PROCESO gocerlin;
     nFactur = 0;
     |SI #gocerlin#7 = "S";
          |HAZ BuscaFactura;
     |FINSI;

     |SI #0#4 [ #gocerlin#3; |Y #gocerlin#3 [ #0#5;
          nCertifPer = nCertifPer + #gocerlin#6;
          nFacturPer = nFacturPer + nFactur;
     |FINSI;

     nCertifTot = nCertifTot + #gocerlin#6;
     nFacturTot = nFacturTot + nFactur;
|FPRC;

|DEFBUCLE gocerlin;
     #gocerlin#1;
     ;
     #gocercab#0, #gocercab#1, 001;
     #gocercab#0, #gocercab#1, 999;
     ;
     NULL, gocerlin;
|FIN;

|PROCESO gocercab;
     |BUCLE gocerlin;
     |HAZ BrutoCertif;
|FPRC;

|DEFBUCLE gocercab;
     #gocercab#2;
     ;
     #gomantho#0, #gomantho#1;
     #gomantho#0, #gomantho#1;
     ;
     NULL, gocercab;
|FIN;

|PROCESO LinExpediente;
     enCapitulo = 0;
     aDesde = "                    ";
     aHasta = "zzzzzzzzzzzzzzzzzzzz";

     nCertifPer = 0;
     nFacturPer = 0;
     nCertifTot = 0;
     nFacturTot = 0;
     nFactur = 0;

     |BUCLE gocercab;

     nVenta1 = 0;
     nCoste1 = 0;

     |BUCLE gopartia;

     |ABRE #24;
     |ABRE #50;
     |ABRE #19;
     |ABRE #12;

     nAlmacen = #1#11;
     |DELINDEX #71;

     fDFecha = "01.01.0000";
     nNume = #0#4 - 1;
     fHFecha = nNume;
     nValor = 0;
     |ABRE #71;
     |BUCLE Historico;
     |CIERRA #71;
     nTotValor = 0;
     |BUCLE TmpValor;
     enValIni = nTotValor;

     fDFecha = #0#4;
     fHFecha = #0#5;
     nValor = 0;
     |ABRE #71;
     |BUCLE Historico;
     |CIERRA #71;
     nTotValor = 0;
     |BUCLE TmpValor;
     enValFin = nTotValor;

     |CIERRA #12;
     |CIERRA #19;
     |CIERRA #50;
     |CIERRA #24;

     |PIEINF;
|FPRC;

|DEFBUCLE Expediente;
     #1#1;
     ;
     #0#0, #0#2;
     #0#1, #0#3;
     ;
     NULL, LinExpediente;
|FIN;

|PROGRAMA;
     aAlfa = Usuario;
     |NOME_DAT #71 aAlfa;

     |CLS;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |ABRE #11; |LEE 000#11p; |CIERRA #11;
          Impresora = "Crystal Reports";
          |IMPRE 0;
          |SI FSalida = 0;
               |SI Impresora = "CrystalReport";
                    |INFOR "golis024";
                    |SI FSalida = 0;
                         |BUCLE Expediente;
                         |SI nHay = 0;
                              |MENAV "0000No hay registros...";
                         |FINSI;
                         |FININF;
                    |FINSI;
               |SINO;
                    |MENAV "0000Informe confeccionado solo para Crystal Reports";
               |FINSI;
               |FINIMP;
          |FINSI;
     |FINSI;
/*
      *** Para pruebas
     |SI nHay ! 0; |HAZ ImpTmp; |FINSI;
*/
     |DELINDEX #71;
|FPRO;
