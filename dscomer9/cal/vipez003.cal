||ControlContrato. Aqui controlamos que es lo que se factura y lo que no.

|FICHEROS;
     vipez003 #0;

     vipem005 #905;      ||Conceptos
     vipem006 #906;      ||Edificios
     vipem007 #907;      ||Contratos

     vipem007@ #107;     ||Carga Def Contratos

     vipem008 #908;      ||Para. VIPEI Alquiler
     vipem009 #909;      ||% IPC por mes/a¤o
     vipem011 #911;      ||Pisos
     vipem012 #912;      ||Importes Edif/Concep
     vipem013 #913;      ||Importes Pisos
     vipem017 #917;      ||Control Facturacion
     vipew017 #517;      ||Aux. Facturacion

     agifa024 #24;       ||Clientes
     agifa025 #25;       ||Representantes
     agifa019 #19;       ||Articulos//Conceptos
     agifa010 #10;       ||Albaranes Vta. Cabs.
     agifa071 #71;       ||Albaranes Vtas.Lins.
     agifa066 #66;

     agifa007 #7;        ||Series

     agifa134 #134;      ||Facturas

     agifa321 #321;
     agifa324 #324;
|FIN;

|VARIABLES;
     nMenos = 0;
     aDiaSis = "";
     nOk = 0;

     &enTiva = 0;   || Variables para la gestion
     &efFiva = @;
     &enIva = 0;

     &enFacMasivaHuecos = 0;
     nSwHayContratosFac = 0;

     aAuxSer = "";

     nSwErrorSerie = 0;
     fFechaSerie = @;
     aFechaSerie = "";

     nSwSoloCuenta = 0;       ||Si vale 1, NO CREA LOS ALBARANES, SOLO CUENTA NUMERO FACTURAS

     nVoyGrupo = 0;
     nFacturasPri = 0;
     nFacturasSec = 0;
     &efFecHuecos = @;
     &enContaHuecos = 0;

     nSalida = 0;
     aAnyoSis = "";
     nAnyoSis = 0;
     aMesSis = "";
     nMesSis = 0;

     aBeta = "";
     nDiferencia = 0;
     nAtrasoIPC = 0;          ||Importe Mensual del atraso IPC
     nSwHayAtrasosIPC = 0;    ||Nos informa si hay atrasos IPC si o no.
     aMesAtraso1 = "";
     aMesAtraso2 = "";

     nSwPie = 0;
     aInforme = "";
     nSwHayLineas = 0;        ||Sirve para controlar si tengo que hacer o no el Albaran
     nImpConIva = 0;          ||Para agrupar Conceptos Mes . Con IVA y sin IVA
     nImpSinIva = 0;

     nContrato = 0;           ||Contrato que estoy procesando
     aCliContrato = "";       ||Cliente del Contrato que estoy procesando
     aFase = "";              ||Fase A. Conceptos tipo "M" del contrato en curso
                              ||Fase C. Conceptos tipo "M" del resto de contratos
                              ||Fase B. Conceptos tipos "U" y "A" contrato en curso
                              ||Fase D. Conceptos tipos "U" y "A" del resto de contratos

     aSerieReal = "";         ||SERIE REAL QUE TENGO QUE FACTURAR
     nGrupoReal = 0;          ||Sirve para agrupar las facturas
     nNumeroFactura = 0;
     fFechaAlbaran = @;
     aClienteAlbaran = "";
     aNomCliAlbaran = "";
     nSwHayFacturas = 0;

     aOtroMes = "";
     aOtraFecha = "";
     fOtraFecha = @;

     &eaMsgNoFacturado = "";
     nSwContinua = 0;

     fSistema = @;
     aSerie = "";
     aSistema = "";
     aSerie1 = "";
     aSerie2 = "";


     &eaSerFarVipei = "";
     nAnyoAux = 0;

     nPeriodo = 0;
     nSaltoMes = 0;
     nMes1 = 0;
     nMes2 = 0;
     nMes3 = 0;

     &enSwProRateo = 0;
     &enSwAlbaPen = 0;
     &eaImpViFac = "";
     &eaImpResumFac = "";

     &cli_alb = "";

     nBisiesto = 0;
     aSacaDia = "";
     nSacaDia = 0;
     aSacaAny = "";
     nSacaAny = 0;
     nTotalDias = 0;

     aSacaMes = "";
     nSacaMes = 0;
     nDiasMes = 0;
     nPorMes = 0;

     aAux1 = "";
     aAux2 = "";
     nAnyos = 0;
     fTope = @;
     aFecHasta = "";
     fFecHasta = @;
     nSwImporteFijo = 0;
     nImpoFijo = 0;
     nCampo = 0;

     &enSwIncIPC = 0;
     &eaAnyoMes = "";

     fFechaVer = @;
     aFechaVer = "";
     aMesVer = "";
     nMesVer = 0;
     aAnyVer = "";
     nAnyVer = 0;
     nSwHacerUnico = 0;

     &eaHuecosVipei = "";
     &eaHayHuecos = "";
     &eaSerHuecos = "";

     nPre = 0;
     nYaFacturado = 0;
     nSwActua = 0;
     nIncTotal = 0;
     &eaImprime = "";
     &ser_alb   = "";
     &num_alb   = 0;
     &abo_alb   = "";
     &fec_alb   = @;
     &eaImpre   = "";
     &eaInforme = "";

     nMesDos = 0;
     nAnyDos = 0;
     aMesDos = "";
     aAnyDos = "";
     aFechaLin = "";
     fFechaLin = @;
     nFechaLin = 0;

     aDesc = "";
     aDescPro  = "";
     &nDeci_PreBaseMx = 0;
     &nDeci_IVA = 0;
     &nDeci_IVAC = 0;
     &nDeci_Div = 0;
     &enErr   = 0;
     nSwIva = 0;
     &aArtLin = "";
     &nUniLin = 0;
     &nPreLin = 0;
     nImpDiv = 0;
     nMult = 0;
     &enForma = 1;
     &eaProgVta = "";

     nLinea = 0;
     nAlbaran = 0;

     &EURODB  = 0;
     aCP = "";
     &aDivisa = "";
     &aMoneda = "";

     aFechaUno = "";
     nImpo = 0;
     nAux = 0;
     nMesAtrasos = 0;

     nIPC = 0;

     nAnyDesde = 0;
     nAnyHasta = 0;
     nMesDesde = 0;
     nMesHasta = 0;
     nAnyFac = 0;
     nMesFac = 0;
     nMesDif = 0;
     nMesAux = 0;

     nMesesAtras = 0;

     aMesFac = "";
     aAnyFac = "";
     fFecha  = @;

     nExiste = 0;
     aMensaje = "";
     aParametro = "";
     aAlfa      = "";

     nMes       = 0;
     nAnyo      = 0;
     aMes       = "";
     aFechaSys  = "";
     aAnyo      = "";
     nSwHay     = 0;

     &enDesdeCon = 0;
     &enHastaCon = 0;
     &enAnyFac = 0;
     &enMesFac = 0;
     &eaSerFac = "";
     &efFecFac = @;
     &imp_alb  = 0;

     nSwIPC = 0;
|FIN;

|PROCESO DameMes;
     |SI nMes = 1;  aMes = "Enero";      |FINSI;
     |SI nMes = 2;  aMes = "Febrero";    |FINSI;
     |SI nMes = 3;  aMes = "Marzo";      |FINSI;
     |SI nMes = 4;  aMes = "Abril";      |FINSI;
     |SI nMes = 5;  aMes = "Mayo";       |FINSI;
     |SI nMes = 6;  aMes = "Junio";      |FINSI;
     |SI nMes = 7;  aMes = "Julio";      |FINSI;
     |SI nMes = 8;  aMes = "Agosto";     |FINSI;
     |SI nMes = 9;  aMes = "Septiembre"; |FINSI;
     |SI nMes = 10; aMes = "Octubre";    |FINSI;
     |SI nMes = 11; aMes = "Noviembre";  |FINSI;
     |SI nMes = 12; aMes = "Diciembre";  |FINSI;

     aMes = aMes > aMes;
|FPRC;

|PROCESO Tipo0C4z003; |TIPO 0;
     nSalida = FSalida;

     nMes = #0#4;
     |HAZ DameMes;
     #0#7 = aMes;
     |PINTA #0#7;

     aSistema = fSistema;
     aAnyoSis = aSistema % -104;
     nAnyoSis = aAnyoSis;

     aMesSis = aSistema % 402;
     nMesSis = aMesSis;
     aDiaSis = aSistema % 102;


     |SI #0#3 > nAnyoSis;
          ||TODO CORRECTO.
     |SINO;
          |SI #0#3 = nAnyoSis; |Y #0#4 ] nMesSis;
               ||TODO CORRECTO.
          |SINO;
               nOk = 1;
               |SI #0#3 = nAnyoSis;
                     nMenos = nMesSis - 1;
                     |SI #0#4 = nMesSis; |O #0#4 = nMenos;
                         |SI aDiaSis [ 10;
                              nOk = 0;  || Todo correcto
                         |FINSI;
                     |FINSI;
               |FINSI;
               |SI nOk = 1;
                    aMensaje = "0000No se permite facturar a mes Vencido";
                    |MENAV aMensaje;
                    |ERROR;
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo7C3z003; |TIPO 7;
     fFecha    = ~;
     aFechaSys = fFecha;
     aAnyo     = aFechaSys % -104;
     nAnyo     = aAnyo;
     aMes      = aFechaSys % 402;
     nMes      = aMes;
     nMes      = nMes + 1;
     |SI nMes = 13;
          nMes  = 1;
          nAnyo = nAnyo + 1;
     |FINSI;

     #0#3 = nAnyo;
     #0#4 = nMes;
     |PINTA #0#3;
     |PINTA #0#4;

     |HAZ Tipo0C4z003;
|FPRC;

|PROCESO vipem009;
     |SI #909#0 = nAnyDesde;
          |SI #909#1 ] nMesDesde; |Y #909#1 [ 12;
               nIPC = nIPC + #909#2;
          |FINSI;
     |SINO;
          |SI #909#1 ] 1; |Y #909#1 [ nMesHasta;
               nIPC = nIPC + #909#2;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE vipem009;
 #vipem009#1;
 ;
 nAnyDesde, 1;
 nAnyHasta, 12;
 ;
 NULL, vipem009;
|FIN;

|PROCESO vipem005;
     |SI #vipem005#17 = "S";

          aFechaUno = "01." + aMesFac + "." + aAnyFac;

          ||Importes EDIFICOS/CONCEPTOS
          nImpo = 0;
          |DDEFECTO #912;
          #912#0 = #907#1;
          #912#1 = #905#0;
          #912#2 = aFechaUno;
          |LEE 000#912.];
          |SI FSalida = 0;
               |LEE 000#912.a;
          |SINO;
               |LEE 000#912.u;
          |FINSI;
          |SI FSalida = 0; |Y #912#0 = #907#1; |Y #912#1 = #905#0;
               nImpo = #912#3;
          |SINO;
               nImpo = 0;
          |FINSI;

          |SI nImpo ! 0;
               |SI #907#22 ! 0;
                    nIncTotal = nIPC + #907#22;
               |SINO;
                    nIncTotal = nIPC;
               |FINSI;
               nAux = nImpo > nIncTotal;

               nDiferencia = nAux - nImpo;
               nAtrasoIPC = nAtrasoIPC + nDiferencia;

               |DDEFECTO #912;
               #912#0 = #907#1;
               #912#1 = #905#0;
               #912#2 = aFechaUno;
               |LEE 101#912.=;
               |SI FSalida ! 0; |GRABA 020#912b; |FINSI;
               #912#3 = nAux;
               |SI #907#22 ! 0;
                    #912#4 = "Actualización IPC: " + nIPC + "% + " + #907#22 + "% Inc. Adicional";
               |SINO;
                    #912#4 = "Actualización IPC: " + nIPC + "%";
               |FINSI;
               |GRABA 020#912.a;
               |LIBERA #912;
               nSwActua = 1;
          |FINSI;

          ||Importes PISOS
          nImpo = 0;
          |DDEFECTO #913;
          #913#0 = #907#1;
          #913#1 = #905#0;
          #913#2 = #907#2;
          #913#3 = aFechaUno;
          |LEE 000#913.];
          |SI FSalida = 0;
               |LEE 000#913.a;
          |SINO;
               |LEE 000#913.u;
          |FINSI;
          |SI FSalida = 0; |Y #913#0 = #907#1; |Y #913#1 = #905#0; |Y #913#2 = #907#2;
               nImpo = #913#4;
          |SINO;
               nImpo = 0;
          |FINSI;

          |SI nImpo ! 0;
               |SI #907#22 ! 0;
                    nIncTotal = nIPC + #907#22;
               |SINO;
                    nIncTotal = nIPC;
               |FINSI;
               nAux = nImpo > nIncTotal;
               nDiferencia = nAux - nImpo;
               nAtrasoIPC = nAtrasoIPC + nDiferencia;
               |DDEFECTO #913;
               #913#0 = #907#1;
               #913#1 = #905#0;
               #913#2 = #907#2;
               #913#3 = aFechaUno;
               |LEE 101#913.=;
               |SI FSalida ! 0; |GRABA 020#913b; |FINSI;
               #913#4 = nAux;
               |SI #907#22 ! 0;
                    #913#5 = "Actualización IPC: " + nIPC + "% + " + #907#22 + "% Inc. Adicional";
               |SINO;
                    #913#5 = "Actualización IPC: " + nIPC + "%";
               |FINSI;
               |GRABA 020#913.a;
               |LIBERA #913;
               nSwActua = 1;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE vipem005;
 #vipem005#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, vipem005;
|FIN;

|PROCESO ObtenSumaIPC;
     |SI nMesesAtras > 0;
          nMesDif = nMesFac - nMesesAtras;
          |SI nMesDif [ 0;
               nMesAux = nMesFac + 12;
               nMesDif = nMesAux - nMesesAtras;
               nAnyHasta = nAnyFac - 1;
          |SINO;
               nAnyHasta = nAnyFac;
          |FINSI;
          nMesHasta = nMesDif;
          |SI nMesHasta = 1;
               nAnyDesde = nAnyHasta;
          |SINO;
               nAnyDesde = nAnyHasta - 1;
          |FINSI;
     |SINO;
          nMesHasta = nMesFac;
          nAnyHasta = nAnyFac;
          nAnyDesde = nAnyHasta - 1;
     |FINSI;
     nMesDesde = nMesHasta + 1;
     |SI nMesDesde = 13;
          nMesDesde = 1;
     |FINSI;

     ||UNO
     ||BUCLE vipem009;
     |ABRE #vipem009;
     #vipem009#0 = nAnyHasta;
     #vipem009#1 = nMesHasta;
     |LEE 000#vipem009.=;
     |SI FSalida = 0;
          nIPC = #vipem009#2;
     |SINO;
          nIPC = 0;
     |FINSI;

     ||DOS
     nSwActua = 0;
     |BUCLE vipem005;
     |SI nSwActua = 1;
          #907#23 = aFechaUno;
          |GRABA 020#907.a;
     |FINSI;
|FPRC;

|PROCESO ActualizaIPC;
     nIPC = 0;
     |HAZ ObtenSumaIPC;
|FPRC;

|PROCESO DameNumAlbaran;
     #10#52 = aSerieReal;
     #10#0 = 999999;
     |LEE 000#10];
     |SI FSalida = 0;
          |LEE 000#10a;
     |SINO;
          |LEE 000#10u;
     |FINSI;
     aAux2 = #10#52;
     |QBF aAux2;
     |SI FSalida = 0; |Y aAux2 = aSerieReal;
          nAlbaran = #10#0 + 1;
     |SINO;
          nAlbaran = 1;
     |FINSI;
|FPRC;

|PROCESO Cabecera;
     nLinea = 0;

     |ABRE #321; |LEE 000#321p; |CIERRA #321;

     |DDEFECTO #24;
     #24#0 = #907#45;
     |LEE 020#24=;

     |DDEFECTO #25;
     #25#0 = #24#25;
     |LEE 000#25=;

     nAlbaran = 0;
     |HAZ DameNumAlbaran;

     |DDEFECTO #10;
     #10#52 = aSerieReal;
     #10#0 = nAlbaran;
     |LEE 101#10=;
     |SI FSalida ! 0; |GRABA 020#10b; |FINSI;

     #10#1 = #0#6;
     #10#3 = #907#45;
     #10#4 = #24#1;
     #10#6 = #agifa025#0;
     #10#9 = #agifa024#35;
     #10#88 = #agifa024#202;

     #10#29 = #agifa024#1;
     #10#30 = #agifa024#5;
     #10#31 = #agifa024#6;
     aCP = (("00" + #agifa024#178) % -102) + (("000" + #agifa024#179) % -103);
     #10#62 = aCP;
     #10#33 = #agifa024#7;
     #10#63 = #agifa024#15;
     #10#8 = #agifa024#20;

     #10#34 = #agifa025#7;
     #10#35 = #agifa024#4;
     #10#36 = #agifa024#47;
     #10#40 = #agifa024#41;
     #10#50 = #agifa024#40;
     #10#51 = "S";
     #10#68 = #agifa024#192;  ||Divisa
     #10#91 = #agifa024#206;  ||Rete.

     |ABRE #324;
     #324#0 = #10#68;
     |LEE 020#324=;

     #10#69 = #324#2;    ||Cambio
     #10#70 = "B";       ||Moneda
     #10#73 = #321#9;    ||Moneda Base

     #324#0 = #10#73;
     |LEE 020#324=;

     #10#74 = #324#2; ||Cambio
     #10#91 = #agifa024#206;
     #10#83 = ("00000000" + #907#0) % -108;

     aDivisa = #10#68;
     aMoneda = #10#70;
     |HAZ Divisas010;

     |CIERRA #324;
|FPRC;

|PROCESO FinCab;
     |HAZ LimCabAgifa010;
     |BUCLELIN 0 CalCabAgifa010 #10;

     |GRABA 020#10a;
     |LIBERA #agifa010;
|FPRC;

|PROCESO MeteLinea;
     nLinea = nLinea + 1;

     |DDEFECTO #71;
     #71#29 = #10#52;             ||serie albaran
     #71#0 = #10#0;               ||numero albaran
     #71#1 = nLinea;              ||Linea Albaran
     #71#2 = #19#0;               ||cod articulo
     #71#3 = 1;                   ||num almacen

     |QBF aDescPro;
     |SI aDescPro = "";
        #71#4 = #19#1;               ||Descripcion
     |SINO;
        #71#4 = aDescPro;
     |FINSI;
     |SI #71#1 = 1;      ||Siempre el nombre del mes en la primera linea
          nMes = #0#4;
          |HAZ DameMes;
          aDesc = #71#4;
          |QBF aDesc;
          aDesc = aDesc + " " + aMes;
          #71#4 = aDesc;
     |FINSI;

     #71#5 = nUniLin;             ||Unidades

     #71#6 = nPreLin;             ||precio
     #71#7 = (#71#5 * #71#6) ! nDeci_IVA; ||importe
     #71#8 = 0;                   ||Dto1
     #71#9 = (#71#5 * #71#6) ! nDeci_IVA; ||importe total = unidades * precio
     |SI nSwIva = 0;
           #71#11 = #19#30;             ||T.IVA
     |SINO;
           #71#11 = 0;                  ||T.IVA
     |FINSI;

     #71#13 = #19#2;        ||Familia
     #71#15 = #10#3;        ||Cliente
     #71#16 = #10#34;       ||tipo comision
     #71#17 = #10#35;       ||tipo cliente

     |SI #10#70 = "D";                    || Si mon. de trabajo es divisa ...
          #71#6  = #71#36 / #10#69 * #10#74; || Recalculo precio en mon. base
          #71#38 = #71#6;                  || Precio visual, en mon. base
     |SINO;                              || Si mon. de trabajo es mon. base
          #71#36 = #71#6 / #10#74 * #10#69;  || Recalculo precio en divisa
          #71#38 = #71#36;                 || Precio visual, en divisa
     |FINSI;

     #71#7    = (#71#5 * #71#6) ! nDeci_IVA;
     nImpDiv = #71#5 * #71#36;

     || nMult corrige el error del redondeo para negativos
     |SI #71#7 < 0; nMult = -1; |SINO; nMult = 1; |FINSI;

     #71#7    = (#71#7    * nMult) ! nDeci_IVA;
     nImpDiv = nImpDiv * nMult;

     #71#9  = (((#71#7 < #71#8) < #71#33)) ! nDeci_IVA;
     #71#37 = (((nImpDiv < #71#8) < #71#33));

     #71#7  = (#71#7 * nMult) ! nDeci_IVA;
     #71#9  = (#71#9 * nMult) ! nDeci_IVA;
     #71#37 = #71#37 * nMult;

     |SI #10#70 = "D";     || Si la moneda de trabajo es la divisa ...
          #71#39 = #71#9;   || el campo visualiz. es el importe en moneda base
     |SINO;               || Si la moneda de trabajo es la moneda base ...
          #71#39 = #71#37;  || el campo visualiz. es el importe en divisa
     |FINSI;

     #71#7 = #71#7 ! nDeci_IVA;

     |GRABA 020#71n;

     enForma = 1;
     eaProgVta = "agifa010";
     |HAZ AcumulaAV;
|FPRC;

|PROCESO vipem005_lin;
     ||ARA55
     |SI aFase = "A"; |O aFase = "C";
          |SI #vipem005#9 = "A"; |Y #vipem007#49 = "N";
               |ACABA;
          |FINSI;
          |SI #vipem005#9 = "U"; |Y #vipem007#50 = "N";
               |ACABA;
          |FINSI;
     |SINO;
          |SI #vipem005#9 = "M";
               |ACABA;
          |FINSI;
          |SI #vipem005#9 = "A"; |Y #vipem007#49 = "S";
               |ACABA;
          |FINSI;
          |SI #vipem005#9 = "U"; |Y #vipem007#50 = "S";
               |ACABA;
          |FINSI;
     |FINSI;


     nMesDos = nMesFac + 1;
     |SI nMesDos = 13;
          nMesDos = 1;
          nAnyDos = nAnyFac + 1;
     |SINO;
          nAnyDos = nAnyFac;
     |FINSI;
     aMesDos = ("00" + nMesDos) % -102;
     aAnyDos = ("0000" + nAnyDos) % -104;
     aFechaLin = "01." + aMesDos + "." + aAnyDos;
     fFechaLin = aFechaLin;
     nFechaLin = fFechaLin;
     nFechaLin = nFechaLin - 1;
     fFechaLin = nFechaLin;

     ||Primero Busco en Precios Conceptos/Edificios/Pisos
     ||sino no lo encuentro buso en Precio Edificios/Conceptos.

     nSwHacerUnico = 0;

     nImpo = 0;
     ||Importes PISOS
     |DDEFECTO #913;
     #913#0 = #907#1;
     #913#1 = #905#0;
     #913#2 = #907#2;
     #913#3 = aFechaLin;
     |LEE 000#913.];
     |SI FSalida = 0;
          |LEE 000#913.a;
     |SINO;
          |LEE 000#913.u;
     |FINSI;
     |SI FSalida = 0; |Y #913#0 = #907#1; |Y #913#1 = #905#0; |Y #913#2 = #907#2;
          nImpo = #913#4;

          fFechaVer = #913#3;
          aFechaVer = fFechaVer;
          aMesVer = aFechaVer % 402;
          nMesVer = aMesVer;
          aAnyVer = aFechaVer % -104;
          nAnyVer = aAnyVer;
          |SI #vipem005#9 = "U";
               |SI nMesVer = #vipez003#4; |Y nAnyVer = #vipez003#3;
                    nSwHacerUnico = 1;
               |FINSI;
          |SINO;
               |SI #vipem005#9 = "A"; |Y nMesVer = #vipez003#4;
                    nSwHacerUnico = 1;
               |FINSI;
          |FINSI;
     |SINO;
          ||Importes EDIFICOS/CONCEPTOS
          |DDEFECTO #912;
          #912#0 = #907#1;
          #912#1 = #905#0;
          #912#2 = aFechaLin;
          |LEE 000#912.];
          |SI FSalida = 0;
               |LEE 000#912.a;
          |SINO;
               |LEE 000#912.u;
          |FINSI;
          |SI FSalida = 0; |Y #912#0 = #907#1; |Y #912#1 = #905#0;
               nImpo = #912#3;
               fFechaVer = #912#2;
               aFechaVer = fFechaVer;
               aMesVer = aFechaVer % 402;
               nMesVer = aMesVer;
               aAnyVer = aFechaVer % -104;
               nAnyVer = aAnyVer;
               |SI #vipem005#9 = "U";
                    |SI nMesVer = #vipez003#4; |Y nAnyVer = #vipez003#3;
                         nSwHacerUnico = 1;
                    |FINSI;
               |SINO;
                    |SI #vipem005#9 = "A"; |Y nMesVer = #vipez003#4;
                         nSwHacerUnico = 1;
                    |FINSI;
               |FINSI;
          |SINO;
               nImpo = 0;
          |FINSI;
     |FINSI;

     |SI nImpo ! 0;

          aArtLin = #905#0;
          nUniLin = 1;

          ||IBI
          |SI #905#20 = "S";
               |SI #905#9 = "M";
                    |SI #905#16 = "S";
                         nImpo = (nImpo / 12) ! 2;
                    |SINO;
                         nImpo = nImpo;
                    |FINSI;
               |SINO;
                    ||TODO CCC. Depende del mes cobro IBI
                    |SI nSwHacerUnico = 1;
                         |SI #905#16 = "N";
                              nImpo = nImpo;
                         |SINO;
                              nImpo = (nImpo * 12) ! 2;
                         |FINSI;
                    |SINO;
                         |ACABA;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI #905#9 = "A"; |Y #905#16 = "S";
                     nImpo = (nImpo / 12) ! 2;
               |FINSI;

               ||El Unico, solo se factura, cuando la fecha desde es del mes y anyo facturado
               |SI #905#9 = "U"; |Y nSwHacerUnico = 0;
                    |ACABA;
               |FINSI;
          |FINSI;

          |DDEFECTO #agifa019;
          #agifa019#0 = aArtLin;
          |LEE 000#agifa019.=;

/*
          |ABRE #agifa066;
          |DDEFECTO #agifa066;
          #agifa066#0 = #agifa019#30;
          |LEE 000#agifa066.=;
          |CIERRA #agifa066;
*/

          enTiva = #agifa019#30;
          efFiva = #0#6;
          |HAZ SacaIVA;

          |SI #agifa019#130 = "N";
               nPreLin = nImpo;
          |SINO;
               |SI enIva ! 0;
                    nPre = nImpo;
                    nPre = (nPre * 100) / (100 + enIva);
                    nPreLin = nPre;
               |SINO;
                    nPreLin = nImpo;
               |FINSI;
          |FINSI;
          nPreLin = nPreLin % nPorMes;

          |SI #vipem007#46 = "S";
               |SI enIva ! 0;
                    nImpConIva = nImpConIva + nPreLin;
               |SINO;
                    nImpSinIva = nImpSinIva + nPreLin;
               |FINSI;
               |SI nSwHayAtrasosIPC = 1;
                    |SI enIva ! 0;
                         nImpConIva = nImpConIva + nAtrasoIPC;
                         nImpConIva = nImpConIva + nAtrasoIPC;
                    |SINO;
                         nImpSinIva = nImpSinIva + nAtrasoIPC;
                         nImpSinIva = nImpSinIva + nAtrasoIPC;
                    |FINSI;
               |FINSI;
          |SINO;
               |HAZ MeteLinea;
               |SI nSwHayAtrasosIPC = 1;
                    |SI #vipem005#17 = "S";
                         aMesAtraso1 = "";
                         aMesAtraso2 = "";
                         |HAZ DameMesAtraso;

                         ||Mete las lineas de atrasos de los 2 meses anteriores
                         ||#19#0 = "...";  ||Hay un codigo para los atrasos
                         |DDEFECTO #19;
                         #19#0 = #vipem007#54;
                         |LEE 000#19.=;
                         |SI FSalida ! 0;
                              #19#1 = "ATRASOS IPC " + aMesAtraso1;
                              #19#2 = "";
                              #19#30 = 2;
                         |SINO;
                              aBeta = #19#1;
                              |QBF aBeta;
                              aBeta = aBeta + " " + aMesAtraso1;
                              #19#1 = aBeta;
                         |FINSI;
                         nUniLin = 1;
                         nPreLin = nAtrasoIPC;
                         |HAZ MeteLinea;

                         ||#19#0 = "...";  ||Hay un codigo para los atrasos
                         |DDEFECTO #19;
                         #19#0 = #vipem007#54;
                         |LEE 000#19.=;
                         |SI FSalida ! 0;
                              #19#1 = "ATRASOS IPC " + aMesAtraso2;
                              #19#2 = "";
                              #19#30 = 2;
                         |SINO;
                              aBeta = #19#1;
                              |QBF aBeta;
                              aBeta = aBeta + " " + aMesAtraso2;
                              #19#1 = aBeta;
                         |FINSI;
                         nUniLin = 1;
                         nPreLin = nAtrasoIPC;
                         |HAZ MeteLinea;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DameMesAtraso;
     || aMesAtraso1
     || aMesAtraso2
     ||ARA55
     |SI #vipez003#4 = 1; aMesAtraso1 = "Noviembre"; aMesAtraso2 = "Diciembre"; |FINSI;
     |SI #vipez003#4 = 2; aMesAtraso1 = "Diciembre"; aMesAtraso2 = "Enero"; |FINSI;
     |SI #vipez003#4 = 3; aMesAtraso1 = "Enero"; aMesAtraso2 = "Febrero"; |FINSI;
     |SI #vipez003#4 = 4; aMesAtraso1 = "Febrero"; aMesAtraso2 = "Marzo"; |FINSI;
     |SI #vipez003#4 = 5; aMesAtraso1 = "Marzo"; aMesAtraso2 = "Abril"; |FINSI;
     |SI #vipez003#4 = 6; aMesAtraso1 = "Abril"; aMesAtraso2 = "Mayo"; |FINSI;
     |SI #vipez003#4 = 7; aMesAtraso1 = "Mayo"; aMesAtraso2 = "Junio"; |FINSI;
     |SI #vipez003#4 = 8; aMesAtraso1 = "Junio"; aMesAtraso2 = "Julio"; |FINSI;
     |SI #vipez003#4 = 9; aMesAtraso1 = "Julio"; aMesAtraso2 = "Agosto"; |FINSI;
     |SI #vipez003#4 = 10; aMesAtraso1 = "Agosto"; aMesAtraso2 = "Septiembre"; |FINSI;
     |SI #vipez003#4 = 11; aMesAtraso1 = "Septiembre"; aMesAtraso2 = "Octubre"; |FINSI;
     |SI #vipez003#4 = 12; aMesAtraso1 = "Octubre"; aMesAtraso2 = "Noviembre"; |FINSI;

     aMesAtraso1 = aMesAtraso1 > aMesAtraso1;
     aMesAtraso2 = aMesAtraso2 > aMesAtraso2;
|FPRC;

|DEFBUCLE vipem005_lin;
 #vipem005#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, vipem005_lin;
|FIN;

|PROCESO Lineas;
     |SI #vipem007#46 = "S";
          nImpConIva = 0;
          nImpSinIva = 0;
     |FINSI;
     |BUCLE vipem005_lin;
     |SI #vipem007#46 = "S";
          |SI nImpConIva ! 0;
               |HAZ MeteLineaConIva;
          |FINSI;
          |SI nImpSinIva ! 0;
               |HAZ MeteLineaSinIva;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MeteLineaConIva;
     #19#0 = ".";
     #19#1 = #vipem007#47;
     #19#2 = "";
     #19#30 = 2;
     nUniLin = 1;
     nPreLin = nImpConIva;
     |HAZ MeteLinea;
|FPRC;

|PROCESO MeteLineaSinIva;
     #19#0 = "..";
     #19#1 = #vipem007#48;
     #19#2 = "";
     #19#30 = 0;
     nUniLin = 1;
     nPreLin = nImpSinIva;
     |HAZ MeteLinea;
|FPRC;

|PROCESO CreaAlbaran;
     |ABRE #agifa024;
     |ABRE #agifa025;
     |ABRE #agifa019;
     |ABRE #agifa010;
     |ABRE #agifa071;

     |HAZ Divisas077;
     |HAZ Cabecera;

     ||Tiquet. 2805/1677.   Volver a meter los 5 campos de Revision IPC, importe fijo 5 a¤os
     enForma = 1;
     |SI nSwImporteFijo = 0;
          |HAZ Lineas;
     |SINO;         ||Importe Fijo. Lo tengo en el contrato.

          nLinea = 0;
          nImpoFijo = 0;
          aFecHasta = "01." + (("00" + #0#4) % -102) + "." + #0#3;
          fFecHasta = aFecHasta;
          |PARA nCampo = 1; |SI nCampo [ #907#36; |HACIENDO nCampo = nCampo + 1;
               nAnyos = nCampo / 1000000;
               fTope = #907#16 + nAnyos;
               |SI fTope > fFecHasta;
                    |SI nCampo = 1;
                         nImpoFijo = #907#37;
                    |FINSI;
                    |SI nCampo = 2;
                         nImpoFijo = #907#38;
                    |FINSI;
                    |SI nCampo = 3;
                         nImpoFijo = #907#39;
                    |FINSI;
                    |SI nCampo = 4;
                         nImpoFijo = #907#40;
                    |FINSI;
                    |SI nCampo = 5;
                         nImpoFijo = #907#41;
                    |FINSI;
                    |SAL;
               |FINSI;
          |SIGUE;
          ||Creo una unica linea con el nImpoFijo.

          aArtLin = #907#60;
          |DDEFECTO #agifa019;
          #agifa019#0 = aArtLin;
          |LEE 000#agifa019.=;
          nUniLin = 1;
          nPreLin = nImpoFijo % nPorMes;
          nSwIva = 0;

          |HAZ MeteLinea;
     |FINSI;

     |HAZ FinCab;

     ser_alb = #agifa010#52;
     num_alb = #agifa010#0;
     abo_alb = "N";
     fec_alb = #0#6;

     cli_alb = #agifa010#3;
     eaImpViFac = #0#10;
     eaImpResumFac = #0#9;

/*
     |SI aParametro = "AUTO";
          ||eaImprime = "CrystalReport";
          ||eaImpre   = "S";
          eaInforme   = "vipem057";
          imp_alb     = 0;
          |SI PARAMETRO = "";  imp_alb = 1;  |FINSI;

          eaSerFarVipei = #vipez003#5;

          |SUB_EJECUTA_NP "vipem057";       ||Facturar Albaranes
     |FINSI;
*/

     |CIERRA #agifa024;
     |CIERRA #agifa025;
     |CIERRA #agifa019;
     |CIERRA #agifa010;
     |CIERRA #agifa071;
|FPRC;

|PROCESO ActualizaPisos;
     |ABRE #911;
     #911#0 = #907#1;
     #911#1 = #907#2;
     |LEE 101#911.=;
     |SI FSalida = 0;
          #911#9 = #907#45;
          #911#10 = #0#6;
          |GRABA 020#911.a;
          |LIBERA #911;
     |FINSI;
     |CIERRA #911;
|FPRC;

|PROCESO vipem007;
     nSwHayAtrasosIPC = 0;
     nSwImporteFijo = 0;
     |SI aFase = "A"; |O aFase = "C";
          |SI #907#36 > 0;
               nAnyos = #907#36 / 1000000;
               fTope = #907#16 + nAnyos;

               aFecHasta = "01." + (("00" + #0#4) % -102) + "." + #0#3;
               fFecHasta = aFecHasta;
               |SI fTope > fFecHasta;
                    ||No se actualiza el IPC.
                    nSwImporteFijo = 1;
               |SINO;
                    nSwImporteFijo = 0;
               |FINSI;
          |SINO;
               nSwImporteFijo = 0;
          |FINSI;

          |SI #907#53 = "S";       ||Atrasos IPC
               nMesAtrasos = #907#21 + 2;
               |SI nMesAtrasos > 12;
                    nMesAtrasos = nMesAtrasos - 12;
               |FINSI;
               |SI #0#4 = nMesAtrasos;
                    |SI nSwImporteFijo = 0;
                         nMesesAtras = 2;         ||Estamos calculando el IPC 2 meses despues + los atrasos.
                         nSwHayAtrasosIPC = 1;
                         nAtrasoIPC = 0;
                         |HAZ ActualizaIPC;
                    |FINSI;
               |FINSI;
               ||ARA55
          |SINO;
               |SI #907#21 = #0#4;
                    |SI nSwImporteFijo = 0;
                         |HAZ ActualizaIPC;
                    |FINSI;
               |FINSI;
          |FINSI;

          nPorMes = 100;           ||En principio, se ha ocupado el mes completo
          |SI #907#51 = "S";
               aAux1 = fFecha;
               aAux2 = #907#16;         ||Fecha Ini
               aAux1 = aAux1 % -108;
               aAux2 = aAux2 % -108;
               |SI aAux1 = aAux2;
                    |SI fFecha = #907#16;
                         nPorMes = 100;      ||Dia 01.Mes.Anyo. Todo el mes
                    |SINO;
                         aSacaMes = aAux2 % 202;
                         nSacaMes = aSacaMes;
                         |SI nSacaMes = 1; |O nSacaMes = 3; |O nSacaMes = 5;
                          |O nSacaMes = 7; |O nSacaMes = 8; |O nSacaMes = 10;
                          |O nSacaMes = 12;
                              nDiasMes = 31;
                         |SINO;
                              |SI nSacaMes = 2;
                                   aSacaAny = aAux2 % -104;
                                   nSacaAny = aSacaAny;
                                   nSacaAny = nSacaAny $ 4;
                                   |SI nSacaAny = 0;
                                        nBisiesto = 1;
                                   |SINO;
                                        nBisiesto = 0;
                                   |FINSI;
                                   nDiasMes = 28 + nBisiesto;
                              |SINO;
                                   nDiasMes = 30;
                              |FINSI;
                         |FINSI;
                         aAux2 = #907#16;         ||Fecha Ini
                         aSacaDia = aAux2 % 102;
                         nSacaDia = aSacaDia;
                         |SI nSacaDia ] nDiasMes;
                              nTotalDias = 1;
                         |SINO;
                              nTotalDias = (nDiasMes - nSacaDia) + 1;
                         |FINSI;

                         ||nPorMes
                         nPorMes = (nTotalDias * 100) / nDiasMes;
                    |FINSI;
               |SINO;
                    ||Control FIN DEL CONTRATO
                    aAux1 = fFecha;
                    aAux2 = #907#17;         ||Fecha Fin
                    aAux1 = aAux1 % -108;
                    aAux2 = aAux2 % -108;
                    |SI aAux1 = aAux2;
                         aAux2 = #907#17;
                         aSacaMes = aAux2 % 402;
                         nSacaMes = aSacaMes;
                         |SI nSacaMes = 1; |O nSacaMes = 3; |O nSacaMes = 5;
                          |O nSacaMes = 7; |O nSacaMes = 8; |O nSacaMes = 10;
                          |O nSacaMes = 12;
                              nDiasMes = 31;
                         |SINO;
                              |SI nSacaMes = 2;
                                   aSacaAny = aAux2 % -104;
                                   nSacaAny = aSacaAny;
                                   nSacaAny = nSacaAny $ 4;
                                   |SI nSacaAny = 0;
                                        nBisiesto = 1;
                                   |SINO;
                                        nBisiesto = 0;
                                   |FINSI;
                                   nDiasMes = 28 + nBisiesto;
                              |SINO;
                                   nDiasMes = 30;
                              |FINSI;
                         |FINSI;
                         aSacaDia = aAux2 % 102;
                         nSacaDia = aSacaDia;
                         nTotalDias = nSacaDia;
                         |SI nTotalDias ] nDiasMes;
                              nPorMes = 100;
                         |SINO;
                              nPorMes = (nTotalDias * 100) / nDiasMes;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |HAZ GeneraAlbaranes;
     ||TODO CCC

|FPRC;

|PROCESO vipem005_miralin;
     ||ARA55
     |SI aFase = "A"; |O aFase = "C";
          |SI #vipem005#9 = "A"; |Y #vipem007#49 = "N";
               |ACABA;
          |FINSI;
          |SI #vipem005#9 = "U"; |Y #vipem007#50 = "N";
               |ACABA;
          |FINSI;
     |SINO;
          |SI #vipem005#9 = "M";
               |ACABA;
          |FINSI;
          |SI #vipem005#9 = "A"; |Y #vipem007#49 = "S";
               |ACABA;
          |FINSI;
          |SI #vipem005#9 = "U"; |Y #vipem007#50 = "S";
               |ACABA;
          |FINSI;
     |FINSI;

     nMesDos = nMesFac + 1;
     |SI nMesDos = 13;
          nMesDos = 1;
          nAnyDos = nAnyFac + 1;
     |SINO;
          nAnyDos = nAnyFac;
     |FINSI;
     aMesDos = ("00" + nMesDos) % -102;
     aAnyDos = ("0000" + nAnyDos) % -104;
     aFechaLin = "01." + aMesDos + "." + aAnyDos;
     fFechaLin = aFechaLin;
     nFechaLin = fFechaLin;
     nFechaLin = nFechaLin - 1;
     fFechaLin = nFechaLin;

     ||Primero Busco en Precios Conceptos/Edificios/Pisos
     ||sino no lo encuentro buso en Precio Edificios/Conceptos.

     nSwHacerUnico = 0;

     nImpo = 0;
     ||Importes PISOS
     |DDEFECTO #913;
     #913#0 = #907#1;
     #913#1 = #905#0;
     #913#2 = #907#2;
     #913#3 = aFechaLin;
     |LEE 000#913.];
     |SI FSalida = 0;
          |LEE 000#913.a;
     |SINO;
          |LEE 000#913.u;
     |FINSI;
     |SI FSalida = 0; |Y #913#0 = #907#1; |Y #913#1 = #905#0; |Y #913#2 = #907#2;
          nImpo = #913#4;

          fFechaVer = #913#3;
          aFechaVer = fFechaVer;
          aMesVer = aFechaVer % 402;
          nMesVer = aMesVer;
          aAnyVer = aFechaVer % -104;
          nAnyVer = aAnyVer;
          |SI #vipem005#9 = "U";
               |SI nMesVer = #vipez003#4; |Y nAnyVer = #vipez003#3;
                    nSwHacerUnico = 1;
               |FINSI;
          |SINO;
               |SI #vipem005#9 = "A"; |Y nMesVer = #vipez003#4;
                    nSwHacerUnico = 1;
               |FINSI;
          |FINSI;
     |SINO;
          ||Importes EDIFICOS/CONCEPTOS
          |DDEFECTO #912;
          #912#0 = #907#1;
          #912#1 = #905#0;
          #912#2 = aFechaLin;
          |LEE 000#912.];
          |SI FSalida = 0;
               |LEE 000#912.a;
          |SINO;
               |LEE 000#912.u;
          |FINSI;
          |SI FSalida = 0; |Y #912#0 = #907#1; |Y #912#1 = #905#0;
               nImpo = #912#3;
               fFechaVer = #912#2;
               aFechaVer = fFechaVer;
               aMesVer = aFechaVer % 402;
               nMesVer = aMesVer;
               aAnyVer = aFechaVer % -104;
               nAnyVer = aAnyVer;
               |SI #vipem005#9 = "U";
                    |SI nMesVer = #vipez003#4; |Y nAnyVer = #vipez003#3;
                         nSwHacerUnico = 1;
                    |FINSI;
               |SINO;
                    |SI #vipem005#9 = "A"; |Y nMesVer = #vipez003#4;
                         nSwHacerUnico = 1;
                    |FINSI;
               |FINSI;
          |SINO;
               nImpo = 0;
          |FINSI;
     |FINSI;

     ||Falta verificar si es IBI, si le toca o no facturar la linea.
     ||ARA55
     |SI #vipem005#20 = "S";
          |SI #vipem005#9 = "M";
               |SI #vipem005#16 = "S";
                    nImpo = (nImpo / 12) ! 2;
               |SINO;
                    nImpo = nImpo;
               |FINSI;
          |SINO;
               ||TODO CCC. Depende del mes cobro IBI
               |SI nSwHacerUnico = 1;
                    |SI #vipem005#16 = "N";
                         nImpo = nImpo;
                    |SINO;
                         nImpo = (nImpo * 12) ! 2;
                    |FINSI;
               |SINO;
                    |ACABA;
               |FINSI;
          |FINSI;
     |SINO;
          |SI #vipem005#9 = "A"; |Y #vipem005#16 = "S";
                nImpo = (nImpo / 12) ! 2;
          |FINSI;

          ||El Unico, solo se factura, cuando la fecha desde es del mes y anyo facturado
          |SI #vipem005#9 = "U"; |Y nSwHacerUnico = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI nImpo ! 0;
          nSwHayLineas = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE vipem005_miralin;
 #vipem005#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, vipem005_miralin;
|FIN;

|PROCESO MiraSiHayLineas;
     |BUCLE vipem005_miralin;
|FPRC;

|PROCESO GeneraAlbaranes;
     ||ARA Tengo que controlar y generar los albaranes que le correspondan.
     ||Incluyendo los albaranes de otros contratos. Segun la FASE.

     |SI aFase = "A"; |O aFase = "C";
          aSerieReal = aSerie1;
     |SINO;
          aSerieReal = aSerie2;
     |FINSI;

     nSwHayLineas = 0;
     |HAZ MiraSiHayLineas;
     |SI nSwHayLineas = 0;
          |SI aFase = "A"; |Y nSwImporteFijo = 1;
               ||OK. Tiene que crear la linea
          |SINO;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI nSwSoloCuenta = 0;
          |HAZ CreaAlbaran;
          |HAZ ActualizaPisos;
     |FINSI;

     nNumeroFactura = #agifa010#39;
     fFechaAlbaran = #agifa010#1;
     aClienteAlbaran = #agifa010#3;
     aNomCliAlbaran = #agifa010#4;

     |SI nSwSoloCuenta = 0;
          |DDEFECTO #vipew017;
          |SELECT #1#vipew017;
          #vipew017#0 = #agifa010#52;
          #vipew017#1 = #agifa010#0;
          |LEE 101#vipew017.=;
          |SI FSalida ! 0;

               nSwHayFacturas = 1;
               #vipew017#2 = fFechaAlbaran;
               #vipew017#3 = aSerieReal;
               #vipew017#4 = nGrupoReal;
               #vipew017#5 = nNumeroFactura;
               #vipew017#6 = #vipez003#6;
               #vipew017#7 = "S";
               #vipew017#8 = aClienteAlbaran;
               #vipew017#9 = aNomCliAlbaran;
               #vipew017#10 = #vipem007#0;
               #vipew017#11 = #vipez003#3;
               #vipew017#12 = #vipez003#4;
               |GRABA 020#vipew017.n;
               |LIBERA #vipew017;
          |FINSI;

          |DDEFECTO #vipem017;
          |SELECT #1#vipem017;
          #vipem017#4 = #agifa010#52;
          #vipem017#5 = #agifa010#0;
          |LEE 101#vipem017.=;
          |SI FSalida ! 0; |GRABA 020#vipem017.b; |FINSI;
          #vipem017#0 = #vipem007#0;
          #vipem017#1 = #vipez003#3;
          #vipem017#2 = #vipez003#4;
          #vipem017#6 = #vipez003#6;
          #vipem017#7 = aSerieReal;
          #vipem017#8 = nNumeroFactura;
          #vipem017#9 = aClienteAlbaran;
          #vipem017#10 = aNomCliAlbaran;
          |GRABA 020#vipem017.a;
          |LIBERA #vipem017;

          |SI #0#9 = "S";
               nSwHay = 1;
               |PRINT;
          |FINSI;
     |SINO;
          |SI nVoyGrupo ! nGrupoReal;
               |SI aFase = "A"; |O aFase = "C";
                    nFacturasPri = nFacturasPri + 1;
               |SINO;
                    nFacturasSec = nFacturasSec + 1;
               |FINSI;
               nVoyGrupo = nGrupoReal;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ControlContrato;
     nSwContinua = 1;
     eaMsgNoFacturado = "";

     ||0) Miro si el contrato esta activo. Es decir esta dentro de Fecha.
     |SI #907#17 ! "01.01.0000";
          |SI fFecha > #907#17;
               eaMsgNoFacturado = "Contrato [" + #vipem007#0;
               |QBF eaMsgNoFacturado;
               eaMsgNoFacturado = eaMsgNoFacturado + "] La fecha hasta del contrato es inferior al mes a facturar";
               nSwContinua = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI fFecha < #907#16;
          aAux1 = fFecha;
          aAux2 = #907#16;
          aAux1 = aAux1 % -108;
          aAux2 = aAux2 % -108;
          |SI aAux1 ! aAux2;
               eaMsgNoFacturado = "";
               nSwContinua = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     ||1) Tiene contrato Vinculado. No lo factura, pq. Facturara el contrato vinculado
     |SI #vipem007#57 ! 0;
          eaMsgNoFacturado = "Contrato [" + #vipem007#0;
          |QBF eaMsgNoFacturado;
          eaMsgNoFacturado = eaMsgNoFacturado + "] NO facturable, tiene un contrato Vinculado";
          nSwContinua = 0;
          |ACABA;
     |FINSI;

     ||2) Esta ya procesado este contrato, a¤o, mes
     |DDEFECTO #vipem017;
     |SELECT #3#vipem017;
     #vipem017#0 = #vipem007#0;
     #vipem017#1 = #vipez003#3;
     #vipem017#2 = #vipez003#4;
     |LEE 000#vipem017.=;
     |SI FSalida = 0;
          |SI #vipem017#13 = "N"; |Y #vipem017#14 = "N";
               eaMsgNoFacturado = "Contrato [" + #vipem007#0;
               |QBF eaMsgNoFacturado;
               eaMsgNoFacturado = eaMsgNoFacturado + "] Ya esta facturado para este A¤o/Mes";
               nSwContinua = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     ||3) Esta ya procesado en el auxiliar de Facturacion
     |SELECT #2#vipew017;
     #vipew017#10 = #vipem007#0;
     #vipew017#11 = #vipez003#3;
     #vipew017#12 = #vipez003#4;
     |LEE 000#vipew017.=;
     |SI FSalida = 0;
          eaMsgNoFacturado = "";   ||Ok. Este contrato YA ha sido procesado en este mismo proceso
          nSwContinua = 0;
          |ACABA;
     |FINSI;

     ||4) Segun el periodo de facturacion, le toca facturar? Mensual/Trimestral/Semestral/Anual
     |DDEFECTO #vipem006;
     #vipem006#0 = #907#1;
     |LEE 000#vipem006.=;
     nPeriodo = #vipem006#26;

     |SI nPeriodo = 3;
          nSaltoMes = 12;
     |SINO;
          |SI nPeriodo = 2;
               nSaltoMes = 6;
          |SINO;
               |SI nPeriodo = 1;
                    nSaltoMes = 3;
               |SINO;
                    nSaltoMes = 1;
               |FINSI;
          |FINSI;
     |FINSI;

     aAlfa = #907#16 % 402;    nMes = aAlfa;
     aAlfa = #907#16 % -104;   nAnyo = aAlfa;

     |SI nMes = #0#4;
          ||Es el mes en CURSO. TODO CORRECTO
     |SINO;
          |SI nSaltoMes = 12;
               ||Mes NO FACTURABLE.
               ||TODO CCC. Poner mensaje de aviso. Si se ejecuta desde asistente
               eaMsgNoFacturado = "Contrato [" + #vipem007#0;
               |QBF eaMsgNoFacturado;
               eaMsgNoFacturado = eaMsgNoFacturado + "] Facturacion Anual. Este mes NO corresponde facturar";
               nSwContinua = 0;
               |ACABA;
          |FINSI;
          |SI nSaltoMes = 6;
               nMes1 = nMes + 6;
               |SI nMes1 > 12;
                    nMes1 = nMes1 - 12;
               |FINSI;
               |SI nMes1 = #0#4;
                    ||Mes Facturable. TODO CORRECTO
               |SINO;
                    ||Mes NO FACTURABLE.
                    ||TODO CCC. Poner mensaje de aviso. Si se ejecuta desde asistente
                    eaMsgNoFacturado = "Contrato [" + #vipem007#0;
                    |QBF eaMsgNoFacturado;
                    eaMsgNoFacturado = eaMsgNoFacturado + "] Facturacion Semestral. Este mes NO corresponde facturar";
                    nSwContinua = 0;
                    |ACABA;
               |FINSI;
          |SINO;
               |SI nSaltoMes = 3;
                    nMes1 = nMes + 3;
                    nMes2 = nMes + 6;
                    nMes3 = nMes + 9;
                    |SI nMes1 > 12; nMes1 = nMes1 - 12; |FINSI;
                    |SI nMes2 > 12; nMes2 = nMes2 - 12; |FINSI;
                    |SI nMes3 > 12; nMes3 = nMes3 - 12; |FINSI;
                    |SI nMes1 = #0#4; |O nMes2 = #0#4; |O nMes3 = #0#4;
                         ||Mes Facturable. TODO CORRECTO
                    |SINO;
                         eaMsgNoFacturado = "Contrato [" + #vipem007#0;
                         |QBF eaMsgNoFacturado;
                         eaMsgNoFacturado = eaMsgNoFacturado + "] Facturacion Trimestral. Este mes NO corresponde facturar";
                         nSwContinua = 0;
                         |ACABA;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     ||5) Esta dentro del periodo de Carencia.
     |SI #vipem007#55 = "S";
          |SI fFecha < #vipem007#56;
               eaMsgNoFacturado = "Contrato [" + #vipem007#0;
               |QBF eaMsgNoFacturado;
               eaMsgNoFacturado = eaMsgNoFacturado + "] NO facturable, Periodo de Carencia";
               nSwContinua = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     ||6) Controlar si tiene el mes anterior Facturado o no.
     |SELECT #3#917;
     |SI nMes ! #0#4;  |O nAnyo ! #0#3;
          |SI nSaltoMes = 1;
               |SI #0#4 ! 1;
                   nMes   = #0#4 - 1;
                   #917#0 = #907#0;
                   #917#1 = #0#3;
                   #917#2 = nMes;
               |SINO;
                   nMes   = 12;
                   #917#0 = #907#0;
                   #917#1 = #0#3 - 1;
                   #917#2 = nMes;
               |FINSI;

               |SI #vipem007#55 = "S";
                    aOtroMes = ("00" + #917#2) % -102;
                    aOtraFecha = "01." + aOtroMes + "." + #917#1;
                    fOtraFecha = aOtraFecha;
                    |SI fOtraFecha < #vipem007#56;
                         ||Okie. La anterior Facturacion, entra dentro de Periodo de Cadencia
                    |SINO;
                         |LEE 000#917=;
                         |SI FSalida ! 0;
                             |HAZ DameMes;

                             aAlfa = #0#7;  |QBF aAlfa;
                             aAlfa = "0000NContrato " + #907#0 + " sin " + aMes + " facturado. Facturar " + aAlfa + " de todas formas?";
                             |CONFI aAlfa;
                             |SI FSalida ! 0;
                                  eaMsgNoFacturado = "";
                                  nSwContinua = 0;
                                  |ACABA;
                             |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI nAnyo ! #0#3;
                    |SI #0#4 > nSaltoMes;
                         nMes = #0#4 - nSaltoMes;
                         nAnyoAux = #0#3;
                    |SINO;
                         nMes = 12 - (#0#4 - nSaltoMes);
                         nAnyoAux = #0#3 - 1;
                    |FINSI;
                    #917#0 = #907#0;
                    #917#1 = nAnyoAux;
                    #917#2 = nMes;
                    |SI #vipem007#55 = "S";
                         aOtroMes = ("00" + #917#2) % -102;
                         aOtraFecha = "01." + aOtroMes + "." + #917#1;
                         fOtraFecha = aOtraFecha;
                         |SI fOtraFecha < #vipem007#56;
                              ||Okie. La anterior Facturacion, entra dentro de Periodo de Cadencia
                         |SINO;
                              |LEE 000#917=;
                              |SI FSalida ! 0;
                                   |HAZ DameMes;
                                   aAlfa = #0#7;  |QBF aAlfa;
                                   aAlfa = "0000NContrato " + #907#0 + " sin " + aMes + " facturado. Facturar " + aAlfa + " de todas formas?";
                                   |CONFI aAlfa;
                                   |SI FSalida ! 0;
                                        eaMsgNoFacturado = "";
                                        nSwContinua = 0;
                                        |ACABA;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |SINO;
                    |SI #0#4 > nSaltoMes;
                         nMes = #0#4 - nSaltoMes;
                         nAnyoAux = #0#3;
                         #917#0 = #907#0;
                         #917#1 = nAnyoAux;
                         #917#2 = nMes;
                         |SI #vipem007#55 = "S";
                              aOtroMes = ("00" + #917#2) % -102;
                              aOtraFecha = "01." + aOtroMes + "." + #917#1;
                              fOtraFecha = aOtraFecha;
                              |SI fOtraFecha < #vipem007#56;
                                   ||Okie. La anterior Facturacion, entra dentro de Periodo de Cadencia
                              |SINO;
                                   |LEE 000#917=;
                                   |SI FSalida ! 0;
                                        |HAZ DameMes;
                                        aAlfa = #0#7;  |QBF aAlfa;
                                        aAlfa = "0000NContrato " + #907#0 + " sin " + aMes + " facturado. Facturar " + aAlfa + " de todas formas?";
                                        |CONFI aAlfa;
                                        |SI FSalida ! 0;
                                             eaMsgNoFacturado = "";
                                             nSwContinua = 0;
                                             |ACABA;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO vipem007_resto;
     |SI #vipem007#0 ! nContrato;
          |SI #vipem007#45 = aCliContrato;
               |HAZ vipem007;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE vipem007_resto;
 #vipem007#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, vipem007_resto;

|FIN;

|PROCESO vipem007_cd;
     ||ARA.  Control Contratos.

     |DDEFECTO #vipem007;
     #vipem007#0 = #vipem007@#0;
     |LEE 000#vipem007.=;
     |SI FSalida = 0;
          nContrato = #vipem007#0;
          aCliContrato = #vipem007#45;
          |HAZ ControlContrato;
          |SI nSwContinua = 1;
               nGrupoReal = nGrupoReal + 1;
               aFase = "A";
               |HAZ vipem007;

               |SI #vipem007#52 = "S";
                   aFase = "C";
                   |BUCLE vipem007_resto;
               |FINSI;

               |DDEFECTO #vipem007;
               #vipem007#0 = nContrato;
               |LEE 000#vipem007.=;
               |SI FSalida = 0;
                    |SI #vipem007#49 = "N"; |O #vipem007#50 = "N";
                         nGrupoReal = nGrupoReal + 1;
                         aFase = "B";
                         |HAZ vipem007;

                         |SI #vipem007#52 = "S";
                              aFase = "D";
                              |BUCLE vipem007_resto;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI aParametro = "AUTO"; |Y eaMsgNoFacturado ! "";
                    aMensaje = "0000" + eaMsgNoFacturado;
                    |MENAV aMensaje;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE vipem007_cd;
 #vipem007@#1001;
 ;
 #0#1;
 #0#2;
 be;
 NULL, vipem007_cd;
|FIN;

|PROCESO vipem017_numfac;
     |ABRE #agifa010;
     #agifa010#52 = #vipem017#4;
     #agifa010#0 = #vipem017#5;
     |LEE 000#agifa010.=;
     |SI FSalida = 0;
          #vipem017#7 = #agifa010#53;
          #vipem017#8 = #agifa010#39;
          |SI #vipem017#8 ! 0;
               #vipem017#3 = "S";
          |FINSI;
          |SI eaImpResumFac = "S";
               |DDEFECTO #vipew017;
               |SELECT #1#vipew017;
               #vipew017#0 = #vipem017#4;
               #vipew017#1 = #vipem017#5;
               |LEE 101#vipew017.=;
               |SI FSalida = 0;
                    #vipew017#3 = #agifa010#53;
                    #vipew017#5 = #agifa010#39;
                    #vipew017#13 = #agifa010#8;
                    |GRABA 020#vipew017.a;
               |FINSI;
               |LIBERA #vipew017;
          |FINSI;
     |FINSI;
     |CIERRA #agifa010;
     |GRABA 020#vipem017.a;
|FPRC;

|DEFBUCLE vipem017_numfac;
 #vipem017#3;
 8;
        1, #vipez003#3, #vipez003#4, 0;
 99999999, #vipez003#3, #vipez003#4, 0;
 be;
 NULL, vipem017_numfac;
|FIN;

|PROCESO vipew017_borra;
     |BORRA 020#vipew017.a;
|FPRC;

|DEFBUCLE vipew017_borra;
 #vipew017#1;
 ;
 INICIO;
 FINAL;
 be;
 NULL, vipew017_borra;
|FIN;

|PROCESO vipew017_imp;
     |PRINT;
     nSwPie = 1;
|FPRC;

|DEFBUCLE vipew017_imp;
 #vipew017#4;
 ;
 INICIO;
 FINAL;
 be;
 NULL, vipew017_imp;
|FIN;

|PROCESO Principal;
     |HAZ DameSeries;
     |SI nSwErrorSerie = 1;
          |ACABA;
     |FINSI;

     |SI aParametro = "";
          enAnyFac = #vipez003#3;
          enMesFac = #vipez003#4;
          enSwIncIPC = 0;
          eaAnyoMes = "";
          |HAZ CtrlPorIncIPC;

          |SI enSwIncIPC = 0;
               aMensaje = "0000Imposible Facturar, falta % IPC anual. " + eaAnyoMes;
               |MENAV aMensaje;
               |ACABA;
          |FINSI;
     |FINSI;

     nAnyFac   = #0#3;
     aAnyFac   = nAnyFac;
     nMesFac   = #0#4;
     aMesFac   = ("00" + nMesFac) % -102;
     aFechaUno = "01." + aMesFac + "." + aAnyFac;
     fFecha    = aFechaUno;
     nSwHay    = 0;

     |ABRE #912;
     |ABRE #913;
     |ABRE #vipem006;
     |ABRET #vipem017;
     |ABRET #vipem007;

     |DDEF aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "vipem007";
     |CARGA_DEF aAlfa, vipem007@;
     |SI FSalida ! 0;
          aMensaje = "0000Problemas con el CARGA_DEF del vipem007";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     |SI eaHuecosVipei = "S";
          nSwSoloCuenta = 1;
          |BUCLE vipem007_cd;      ||CARGA_DEF

          |SI eaHuecosVipei = "S";
               |SI nFacturasPri ! 0;
                    eaHayHuecos = "N";
                    eaSerHuecos = aSerie1;
                    efFecHuecos = #vipez003#6;
                    enContaHuecos = nFacturasPri;
                    |HAZ MiraHuecosFV;
                    |SI eaHayHuecos = "N";
                         |SI enContaHuecos = 1;
                              aMensaje = "0000Proceso cancelado. No existe hueco en la serie [" + eaSerHuecos + "] para fecha: " + efFecHuecos;
                              |MENAV aMensaje;
                         |SINO;
                              aMensaje = "0000Proceso cancelado. No existen " + enContaHuecos + " huecos en la serie [" + eaSerHuecos + "] para fecha: " + efFecHuecos;
                              |MENAV aMensaje;
                         |FINSI;

                         |BUCLE vipew017_borra;
                         |DESCARGA_DEF #vipem007@;
                         |CIERRA #vipem006;
                         |CIERRA #912;
                         |CIERRA #913;
                         |CIERRAT #vipem007;
                         |CIERRAT #vipem017;

                         |ACABA;
                         ||ARA55
                    |FINSI;
               |FINSI;

               ||Vore si es gasta la segon Serie. (en tal cas si te huecos)
               |SI nFacturasSec ! 0;
                    eaHayHuecos = "N";
                    eaSerHuecos = aSerie2;
                    efFecHuecos = #vipez003#6;
                    enContaHuecos = nFacturasSec;
                    |HAZ MiraHuecosFV;
                    |SI eaHayHuecos = "N";
                         |SI enContaHuecos = 1;
                              aMensaje = "0000Proceso cancelado. No existe hueco en la serie [" + eaSerHuecos + "] para fecha: " + efFecHuecos;
                              |MENAV aMensaje;
                         |SINO;
                              aMensaje = "0000Proceso cancelado. No existen " + enContaHuecos + " huecos en la serie [" + eaSerHuecos + "] para fecha: " + efFecHuecos;
                              |MENAV aMensaje;
                         |FINSI;

                         |BUCLE vipew017_borra;
                         |DESCARGA_DEF #vipem007@;
                         |CIERRA #vipem006;
                         |CIERRA #912;
                         |CIERRA #913;
                         |CIERRAT #vipem007;
                         |CIERRAT #vipem017;

                         |ACABA;
                         ||ARA55
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     nSwHayFacturas = 0;

     nAnyFac   = #0#3;
     aAnyFac   = nAnyFac;
     nMesFac   = #0#4;
     aMesFac   = ("00" + nMesFac) % -102;
     aFechaUno = "01." + aMesFac + "." + aAnyFac;
     fFecha    = aFechaUno;
     nSwHay    = 0;

     nSwSoloCuenta = 0;
     |BUCLE vipem007_cd;      ||CARGA_DEF
     |DESCARGA_DEF #vipem007@;

     |SI nSwHayFacturas = 1;
          |SUB_EJECUTA_NP "vipem057;FACTURAAUTO";       ||Facturar Albaranes del Auxiliar

          |BUCLE vipem017_numfac;

          |SI eaImpResumFac = "S";
               nSwPie = 0;
               |IMPRE 0;
               |SI FSalida = 0;
                    aInforme = "vipew017";
                    |INFOR aInforme;
                    |SI FSalida = 0;
                         |BUCLE vipew017_imp;
                         |SI nSwPie = 1;
                              |PIEINF;
                         |FINSI;
                         |FININF;
                    |SINO;
                         aMensaje = "0000Informe " + aInforme + " inaccesible.";
                         |MENAV aMensaje;
                    |FINSI;
                    |FINIMP;
               |SINO;
                    |MENAV "0000Resumen de Facturacion cancelado.";
               |FINSI;
          |FINSI;
          |BUCLE vipew017_borra;
     |FINSI;

     |CIERRA #vipem006;
     |CIERRA #912;
     |CIERRA #913;
     |CIERRAT #vipem007;
     |CIERRAT #vipem017;
|FPRC;

|PROCESO Tipo80;  |TIPO 80;
     FSalida = 3299;
|FPRC;

|PROCESO Tipo0C5z003; |TIPO 0;
     eaHayHuecos = "N";
     eaSerHuecos = #vipez003#5;
     |HAZ MiraHuecosFV;
     |SI eaHayHuecos = "N";
          eaHuecosVipei = "N";
     |SINO;
          aMensaje = "0000SReutilizar huecos S/N?";
          |CONFI aMensaje;
          |SI FSalida = 0;
               eaHuecosVipei = "S";
          |SINO;
               eaHuecosVipei = "N";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DameSeries;
     nSwErrorSerie = 0;

     fFechaSerie = #vipez003#6;
     aFechaSerie = fFechaSerie;

     aAnyo = aFechaSerie % -102;
     |QBF aAnyo;

     aSerie = #908#17;
     |QBT aSerie;
     aSerie = aSerie + aAnyo;
     |ABRE #7;
     |DDEFECTO #7;
     #7#26 = aSerie;
     |LEE 000#7=;
     |SI FSalida ! 0;
          aMensaje = "0000No es posible facturar. Serie " + aSerie + " no dada de alta";
          |MENAV aMensaje;
          nSwErrorSerie = 1;
          |ACABA;
     |SINO;
          aSerie1 = aSerie;
     |FINSI;
     |CIERRA #7;
     aSerie = #908#18;
     |QBT aSerie;
     |SI aSerie ! "";
          aSerie = aSerie + aAnyo;
          |ABRE #7;
          |DDEFECTO #7;
          #7#26 = aSerie;
          |LEE 000#7=;
          |SI FSalida ! 0;
               aMensaje = "0000No es posible facturar. Serie " + aSerie + " no dada de alta";
               |MENAV aMensaje;
               nSwErrorSerie = 1;
               |ACABA;
          |SINO;
               aSerie2 = aSerie;
          |FINSI;
          |CIERRA #7;
     |FINSI;
|FPRC;

|PROCESO vipem007_Huecos;
     ||ARA66
     |ABRE #vipem017;
     |DDEFECTO #vipem017;
     |SELECT #3#vipem017;
     #vipem017#0 = #vipem007#0;
     #vipem017#1 = #vipez003#3;
     #vipem017#2 = #vipez003#4;
     |LEE 000#vipem017.=;
     |SI FSalida = 0;
          |SI #vipem017#13 = "N"; |Y #vipem017#14 = "N";
               nSwHayContratosFac = 1;
          |FINSI;
     |FINSI;
     |CIERRA #vipem017;
|FPRC;

|DEFBUCLE vipem007_Huecos;
 #vipem007#1;
 ;
 #vipez003#1;
 #vipez003#2;
 ;
 NULL, vipem007_Huecos;

|FIN;

|PROCESO MiraContratosFac;
     |BUCLE vipem007_Huecos;
|FPRC;

|PROCESO Tipo0C12z003; ||Miraamos si es Facturacion Masiva con huecos
     |SI #vipez003#12 = "N";
          enFacMasivaHuecos = 0;
     |SINO;
          nSwHayContratosFac = 0;
          |HAZ  MiraContratosFac;
          |SI nSwHayContratosFac = 1;
               aMensaje = "0000Hay contratos ya facturados para esta Mes/A¤o. No es posible reutilizar huecos";
               |MENAV aMensaje;
               #vipez003#12 = "N";
               |PINTA #vipez003#12;
               |ERROR;
               |ACABA;
          |SINO;
               |HAZ DameSeries;
               |SI nSwErrorSerie = 1;
                    enFacMasivaHuecos = 0;
                    |ERROR;
                    |ACABA;
               |SINO;
                    |ABRE #agifa134;
                    |DDEFECTO #agifa134;
                    #agifa134#49 = aSerie1;
                    #agifa134#0 = 999999;
                    |LEE 000#agifa134.];
                    |SI FSalida = 0;
                         |LEE 000#agifa134.a;
                    |SINO;
                         |LEE 000#agifa134.u;
                    |FINSI;
                    aAuxSer = #agifa134#49;
                    |QBF aAuxSer;
                    |SI FSalida = 0; |Y aAuxSer = aSerie1;
                         |SI #agifa134#1 > #vipez003#6;
                              enFacMasivaHuecos = 0;
                              aMensaje = "0000No hay huecos para esta fecha en la serie " + aSerie1;
                              |MENAV aMensaje;
                              #vipez003#12 = "N";
                              |PINTA #vipez003#12;
                              |ERROR;
                              |ACABA;
                         |FINSI;
                    |SINO;
                         enFacMasivaHuecos = 1;
                         ||Okie. No hay facturas para esta serie. OKIE.
                    |FINSI;

                    |DDEFECTO #agifa134;
                    #agifa134#49 = aSerie2;
                    #agifa134#0 = 999999;
                    |LEE 000#agifa134.];
                    |SI FSalida = 0;
                         |LEE 000#agifa134.a;
                    |SINO;
                         |LEE 000#agifa134.u;
                    |FINSI;
                    aAuxSer = #agifa134#49;
                    |QBF aAuxSer;
                    |SI FSalida = 0; |Y aAuxSer = aSerie2;
                         |SI #agifa134#1 > #vipez003#6;
                              enFacMasivaHuecos = 0;
                              aMensaje = "0000No hay huecos para esta fecha en la serie " + aSerie2;
                              |MENAV aMensaje;
                              #vipez003#12 = "N";
                              |PINTA #vipez003#12;
                              |ERROR;
                              |ACABA;
                         |FINSI;
                    |SINO;
                         enFacMasivaHuecos = 1;
                         ||Okie. No hay facturas para esta serie. OKIE.
                    |FINSI;
                    |CIERRA #agifa134;
                    ||ARA66
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROGRAMA;
     fSistema = ~;
     aSistema = fSistema;
     |ABRE #908;
     |DDEFECTO #908;
     |LEE 000#908p;
     |SI FSalida ! 0;
          |DDEFECTO #908;
     |FINSI;
     |CIERRA #908;

     |ABRET #vipew017;
     |LEE 000#vipew017.p;
     |SI FSalida = 0;
          aMensaje = "0000Hay otro proceso de facturacion activo en este momento. Espere unos instantes y vuelva a intentarlo";
          |MENAV aMensaje;
          |CIERRA #vipew017;
          |ACABA;
     |FINSI;

     ||Controlar tambien en vipe9999
     nMesesAtras = 2;
     aParametro = PARAMETRO;
     |QBF aParametro;
     |SI aParametro ! "";
          |ABRE #0;
          |DDEFECTO #0;
          #0#1 = enDesdeCon;
          #0#2 = enHastaCon;
          #0#3 = enAnyFac;
          #0#4 = enMesFac;
          #0#6 = efFecFac;

          nMes = enMesFac;
          |HAZ DameMes;
          #0#7 = aMes;
          #0#9 = eaImpResumFac;
          #0#10 = eaImpViFac;

          |HAZ Principal;
          |CIERRA #0;
     |SINO;
          eaHuecosVipei = "N";
          |CLS;
          |ABRE #0;
          |DDEFECTO #0;
          |LEE 101#0p;
          nExiste = FSalida;
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
          |SI FSalida = 0;
               |SI nExiste = 0;
                    |GRABA 020#0a;
               |SINO;
                    |GRABA 020#0n;
               |FINSI;
               |HAZ Principal;
          |FINSI;
          |LIBERA #0;
          |CIERRA #0;
     |FINSI;
     |CIERRAT #vipew017;
|FPRO;
