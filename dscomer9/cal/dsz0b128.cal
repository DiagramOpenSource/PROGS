|FICHEROS;
     dsz00128 #0;
     agifa010 #10;
     agifa019 #19;
     agifa024 #24;
     agifa025 #25;
     agifa059 #59;
     agifa071 #71;
     agifa134 #134;
     agifa142 #142;
     dsm00153 #153;
     referen@;
|FIN;

|VARIABLES;
     nSwChampiEmar = 0;
     &enError = 0;
     &enSwMenu = 0;
     &enCoste = 0;
     &enForma = 0;
     &enImpCliPen = 0;
     &enImpCliCom = 0;
     &enImpCliDto = 0;
     &enImpCliMar = 0;
     &enImpCliFac = 0;
     &enImpRepComi = 0;
     &enImpRepVta = 0;
     &enImpRepRete = 0;
     &efFecha = @;
     &eaCliente = "";
     &eaRepre = "";
     &eaTag = "";
     nForma = 0;
     nConta = 0;
     nContaAlb = 0;
     aAlfa = "";
     nMargen = 0;
     nRete = 0;
     nnMes = 0;
     nImpo = 0;
     nImNeto = 0;
     nDto = 0;
     nMes = 0;
     nImporte = 0;
     nCant = 0;
     nError = 0;
     nImneto = 0;
     aPath = "";
|FIN;

|PROCESO ModulosAlbLin
     |DDEF aPath;
     |SI nSwChampiEmar = 0;
          aAlfa = aPath + "champi04";
          |CARGA_DEF aAlfa, referen@;
          |SI FSalida = 0;
               |ABRE #referen@;
               #referen@#0 = #59#15;
               #referen@#1 = #59#2;
               #referen@#2 = #71#1;
               |LEE 000#referen@.=;
               |SI FSalida = 0;
                    #referen@#0 = #71#29;
                    #referen@#1 = #71#0;
                    |GRABA 020#referen@.n;
               |FINSI;
               |CIERRA #referen@;
               |DESCARGA_DEF #referen@;
          |SINO;
               |MENAV "0000Error al cargar 'champi04'...";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ModulosAlbCab;
     |DDEF aPath;
|FPRC;

|PROCESO ActualizaCli;
     |SI #10#15 ] 0;
          nImporte = 1;
     |SINO;
          nImporte = -1;
          #10#15 = -#10#15;
     |FINSI;
     nCant = #10#15 < #10#5;
     nCant = nCant < #10#32;
     nCant = nCant < #10#7;
     nCant = nCant * nImporte;
     #10#15 = #10#15 * nImporte;
     |ABRE #24;
     #24#0 = #10#3;
     |LEE 121#24=;
     |SI FSalida = 0;
          |SI #10#43 = AN;
               #24#50 = #24#50 + nCant;    || es albaran
          |SINO;
               #24#50 = #24#50 - nCant;    || es abono
           |FINSI;
           |GRABA 020#24a;
     |FINSI;
     |CIERRA #24;

     |SI #10#43 = "N";
          enImpCliPen = nCant * nForma;
     |SINO;
          enImpCliPen = -nCant * nForma;
     |FINSI;
     eaCliente = #10#3;
     efFecha = #10#1;
     |HAZ AcumulaCli;

     eaTag = "AV";  |HAZ Riesgos;
|FPRC;

|PROCESO ActLineas71;
     enForma = 1;
     |HAZ AcumulaAV;
     #71#14 = enCoste;

     |SI #71#9 > 0;
         nError = 1;
     |SINO;
         nError = -1;
         #71#9  = -#71#9;
         #71#37 = -#71#37;
     |FINSI;
     nImneto  = ((((#71#9  < #10#5) < #10#32) < #10#7)) * nError;
     #10#37 = #10#37 + (nImneto - enCoste);
     #71#9 = #71#9  * nError;
     #71#37 = #71#37 * nError;
     |GRABA 020#71a;
|FPRC;

|PROCESO ActLineas59;
     #10#52 = #59#15;
     #10#0 = #59#2;
     |LEE 121#10=;
     |SI FSalida = 0;
          #10#37 = 0;
          |BUCLELIN 0 ActLineas71 #10;
          |HAZ ActualizaCli;
          |GRABA 020#10a;
          |LIBERA #10;
     |FINSI;
|FPRC;

|PROCESO ActuaRepre;
     |ABRE #25;
     #25#0 = #134#7;
     |LEE 121#25=;
     |SI 0 = FSalida;
          nImNeto = #134#18 - #134#17;
          aAlfa = #134#1 % A402;
          nMes = ((aAlfa - 1) * 2) + 11;
          #25nMes = #25nMes + #134#8;

          nMes = nMes + 1;
          #25nMes = #25nMes + nImNeto;
          #25#35 = #25#35 + #134#8;
          #25#36 = #25#36 + nImNeto;
          nMes = (aAlfa - 1) + 40;
          #25nMes = #25nMes + #134#55;
          #25#52 = #25#52 + #134#55;
          |GRABA 020#25a;

          enImpRepComi = #134#8 * nForma;
          enImpRepVta = nImNeto * nForma;
          enImpRepRete = #134#55 * nForma;
          eaRepre = #134#7;
          efFecha = #134#1;
          |HAZ AcumulaRep;
     |FINSI;
     |CIERRA #25;
|FPRC;

|PROCESO ActuaCliente;
     |ABRE #24;
     #24#0 = #134#2;
     |LEE 121#24=;
     |SI 0 = FSalida;
          aAlfa = #134#1 % A402;
          nMes = ((aAlfa - 1) * 4) + 54;
          nImNeto = (#134#18 - #134#17);
          |SI #142#115 = "N";
               nImpo = (nImNeto * 100) / (100 - #134#6);
               nDto = #134#17 + (nImNeto - nImpo);
          |SINO;
               nImpo = nImNeto;
               nDto = #134#17;
          |FINSI;
          #24#50 = #24#50 -. nImNeto;        || pendiente de facturar
          #24nMes = #24nMes + nImpo;
          nMes = nMes + 1;
          #24nMes = #24nMes + nDto;
          nMes = nMes + 1;
          #24nMes = #24nMes + #134#46;
          #24#102 = #24#102 + nImpo;
          #24#103 = #24#103 + nDto;
          #24#104 = #24#104 + #134#46;
          ||*************** CALCULO DEL RIESGO;
          eaTag = "FAC";  |HAZ Riesgos;

          #24#45 = #134#1;
          #24#46 = nImNeto;
          #24#110 = #24#110 + nImNeto;
          |GRABA 020#24a;

          enImpCliPen = -nImNeto * nForma;
          enImpCliCom = nImpo * nForma;
          enImpCliDto = nDto * nForma;
          enImpCliMar = #134#46 * nForma;
          enImpCliFac = nImNeto * nForma;
          eaCliente = #134#2;
          efFecha = #134#1;
          |HAZ AcumulaCli;
     |FINSI;
     |CIERRA #24;
|FPRC;

|PROCESO Actualiza134;
     nForma = 1;
     |HAZ ActuaCliente;
     |HAZ ActuaRepre;
     |BUCLELIN 0 ActLineas59 #134;
|FPRC;

|PROCESO CopiaLineas71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#30 = #0#3;
     #71#26 = nConta;
     |GRABA 020#71n;
     |HAZ ModulosAlbLin
|FPRC;

|DEFBUCLE CopiaLineas71;
     #71#1;
     ;
     #59#15, #59#2, 001;
     #59#15, #59#2, 999;
     ;
     NULL, CopiaLineas71;
|FIN;

|PROCESO CopiaLineas59;
     |ABRE #71;
     |ABRE #10;
     #10#52 = #59#15;
     #10#0 = #59#2;
     |LEE 020#10=;
     |SI FSalida = 0;
          |SALVA_DATOS #10;
          #10#52 = #0#3;
          enSwMenu = 1;
          |HAZ ContaAV7;
          nContaAlb = #10#0;
          |GRABA 020#10n;
          #10#52 = #0#3;
          #10#0 = nContaAlb;
          |LEE 121#10=;
          |REPON_DATOS #10;
          #10#52 = #0#3;
          #10#0 = nContaAlb;
          |BUCLE CopiaLineas71;
          #10#43 = "S";
          #10#90 = "N";
          #10#53 = #0#3;
          #10#39 = nConta;
          #10#85 = "";        || quita el desglose Tiquet: 3218/3384
          |GRABA 020#10a;
          |HAZ ModulosAlbCab;

          #59#15 = #10#52;
          #59#2 = #10#0;
     |FINSI;
     |CIERRA #10;
     |CIERRA #71;
     #59#14 = #134#49;
     #59#0 = #134#0;
     |GRABA 020#59n;
|FPRC;

|DEFBUCLE CopiaLineas59;
     #59#1;
     ;
     #0#1, #0#2, 001;
     #0#1, #0#2, 999;
     ;
     NULL, CopiaLineas59;
|FIN;

|PROCESO FacVenta;
     |HAZ EsChampiEmar;
     nSwChampiEmar = FSalida;

     enError = 1;

     enSwMenu = 1;
     #134#49 = #0#3;
     |HAZ ContaFV7;
     |GRABA 020#134n;
     |SI FSalida = 0;
          nConta = #134#0;
          #134#49 = #0#1;
          #134#0 = #0#2;
          |LEE 020#134=;
          |SALVA_DATOS #134;
          #134#49 = #0#3;
          #134#0 = nConta;
          |LEE 121#134=;
          |REPON_DATOS #134;
          #134#49 = #0#3;
          #134#0 = nConta;
          #134#1 = ~;
          #134#45 = "N";
          #134#48 = "N";
          #134#57 = "S";
          |GRABA 020#134a;
          |BUCLE CopiaLineas59;
          |HAZ CalCabAgifa134
          |ABRE #10;
          |HAZ Actualiza134;
          |CIERRA #10;
          |GRABA 020#134a;

          #153#6 = #134#49;
          #153#7 = #134#0;
          #153#8 = #134#1;
          |GRABA 020#153a;
          enError = 0;
     |FINSI;
|FPRC;
