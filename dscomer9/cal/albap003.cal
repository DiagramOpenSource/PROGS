|FICHEROS;
     albap003 #0;
     albap004 #1;   || Cabecera.
     albap005 #2;   || Lineas.
     agifa024 #3;   || Clientes.
     agifa019 #4;   || Articulos.
     albap013 #6;   || Cobros Facturas.
     albap015 #7;   || Movimientos de Almacen.
     albap017 #9;   || Cobros Albaranes.
|FIN;

|VARIABLES;
     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;
     &EURODB = 0;
     resto = 0;
     resto1 = 0;
     liquid = 0;
     fra   = 0;
     conta = 0;
     texto = "PONGO EN EL CAMPO";
     texto1 = "EL DATO:"
     texto2 = "";
     empresa  = "";
     cadena   = "";
     fichero  = "";
     long     = "";
     caracter = "";
     campo    = "";
     i        = 0;
     f        = 0;
     ind      = 0;
     valor    = 0;
     sw       = 0;
     pasa     = 0;
     jj       = 0;
     sal      = 0;
     guarda   = 0;
     bruto    = 0;
     impuesto = 0;
     total    = 0;
     envase   = 0;
     linea    = 0;
     iva      = 0;
|FIN;

|| ----------------- LEE EL FICHERO SEQUENCIAL DEL PSION --------------------
|PROCESO cabecera;
     empresa  = "";
     cadena   = "";
     fichero  = "";
     long     = "";
     caracter = "";
     campo    = "";
     i        = 0;
     f        = 0;
     ind      = 0;
     valor    = 0;
     sw       = 0;
     pasa     = 0;
     jj       = 0;
     sal      = 0;
     guarda   = 0;
     |ABRE #1;
     |DFICE empresa;
     empresa = empresa + "cabalb.asc";
     |QBF empresa;
     fichero = "rt  " + empresa;
     |QBF empresa;
     |FABRE fichero;
     f = FSalida;
     sal = 0;
     |SI FSalida = 0;
       |PARA jj = 1; |SI sal ] 0; |HACIENDO jj = jj + 1;
          cadena = f + " " + 254;
          |FLEE cadena;
          sal = FSalida;
          |SI FSalida >1;
               long = cadena % 0;
               sw = 0;
               |PARA ind = 1; |SI ind [ long; |HACIENDO ind = ind + 1;
                    i = (ind * 100) + 1;
                    caracter = cadena % i;
                    valor = &caracter;
                    |SI valor ! 9; |Y valor ! 13;
                         campo = campo + caracter;
                    |FINSI;
                    |SI valor = 9; |O long = ind;
                         pasa = sw;
                         |SI sw = 5; pasa = 6; |FINSI;
                         |SI sw = 6; pasa = 7; |FINSI;
                         #1pasa = campo;
                         campo = "";
                         sw = sw + 1;
                         |SI pasa = 2;
                              |LEE 141#1=;
                              |LIBERA #1;
                              guarda = FSalida;
                         |FINSI;
                    |FINSI;
               |SIGUE;
               |HAZ grabacabeza;
               campo = "";
          |FINSI;
       |SIGUE;
     |FINSI;
     FSalida = f;
     |SI FSalida ] 0;
     |FCIERRA FSalida;
     |FINSI;
     |LIBERA #1;
     |CIERRA #1;
     Pos = -1;
|FPRC;

|| ------------------------ GRABA FICHERO CABECERA --------------------------
|PROCESO suma;
     total = total + #2#10;
     envase = envase + #2#16;

               enTiva = #2#9;
               efFiva = #1#3;
               |HAZ SacaIVA;
               impuesto = enIva;


               |ABRE #3;
               #3#0 = #1#4;
               |LEE 000#3=;
               |LIBERA #3;
               |SI #3#47 = "S"; impuesto = enIva + enRec; |FINSI;
          |CIERRA #3;
     iva = #2#10 < #3#37;
     iva = iva < #3#38;
     iva = iva > impuesto;
     liquid = liquid + iva;
|FPRC;

|DEFBUCLE totalalb;
     #2#1;
     ;
     #1#0,#1#2,#1#1,000;
     #1#0,#1#2,#1#1,999;
     be;
     NULL,suma;
|FIN;

|PROCESO grabacabeza;
     total = 0;
     envase = 0;
     liquid = 0;
     |BUCLE totalalb;
     #1#8 = total;
     #1#10 = envase;
     #1#9 = liquid;
     |LIBERA #3;
     |CIERRA #3;
     |ABRE #3;
          #3#0 = #1#4;
          |LEE 000#3=;
          |LIBERA #3;
          #1#5 = #3#1;
     |LIBERA #3;
     |CIERRA #3;
     |SI #1#7 [ 0;
         #1#6 = "N";
     |FINSI;
     |SI #1#7 ] #1#8;
         #1#6 = "S";
     |FINSI;
     |SI #1#7 < #1#8; |Y #1#7 > 0;
         #1#6 = "P";
     |FINSI;
     total = #1#9 - #1#7;
     |SI total = 1;
         #1#6 = "S";
         #1#7 = #1#9;
     |FINSI;
     |SI guarda ! 0;
          |GRABA 121#1n;
          |LIBERA #1;
     |SINO;
          |GRABA 121#1a;
          |LIBERA #1;
     |FINSI;
|FPRC;

|PROCESO grabacobros;
     |SI #6#4 = #6#5;
       #6#6 = "S";
     |SINO;
       #6#6 = "N";
     |FINSI;
     |SI guarda ! 0;
          |GRABA 121#6n;
          |LIBERA #6;
     |SINO;
          |GRABA 121#6a;
          |LIBERA #6;
     |FINSI;
|FPRC;

|PROCESO grabacobros1;
     |SI #9#4 = #9#5;
       #9#6 = "S";
     |SINO;
       #9#6 = "N";
     |FINSI;
     |SI guarda ! 0;
          |GRABA 121#9n;
          |LIBERA #9;
     |SINO;
          |GRABA 121#9a;
          |LIBERA #9;
     |FINSI;
|FPRC;

|PROCESO grabamovimi;
     #7#5 = ~;
     |SI guarda ! 0;
          |GRABA 121#7n;
          |LIBERA #7;
     |SINO;
          |GRABA 121#7a;
          |LIBERA #7;
     |FINSI;
|FPRC;

|| ------------- LEE LINEAS ---------------
|PROCESO lineas;
     empresa  = "";
     cadena   = "";
     fichero  = "";
     long     = "";
     caracter = "";
     campo    = "";
     i        = 0;
     f        = 0;
     ind      = 0;
     valor    = 0;
     sw       = 0;
     pasa     = 0;
     jj       = 0;
     sal      = 0;
     guarda   = 0;
     impuesto = 0;
     |ABRE #2;
     |DFICE empresa;
     empresa = empresa + "linalb.asc";
     |QBF empresa;
     fichero = "rt  " + empresa;
     |QBF empresa;
     |FABRE fichero;
     f = FSalida;
     sal = 0;
     linea = 1;

     |SI FSalida = 0;
       |PARA jj = 1; |SI sal ] 0; |HACIENDO jj = jj + 1;
          cadena = f + " " + 254;
          |FLEE cadena;
          sal = FSalida;
          |SI FSalida > 1;
          ||     linea = 1;
               long = cadena % 0;
               sw = 0;
               |PARA ind = 1; |SI ind [ long; |HACIENDO ind = ind + 1;
                    i = (ind * 100) + 1;
                    caracter = cadena % i;
                    valor = &caracter;
                    |SI valor ! 9; |Y valor ! 13;
                         campo = campo + caracter;
                    |FINSI;
                    |SI valor = 9; |O long = ind;
                         pasa = sw;
                         |SI pasa [ 17;

                          |SI pasa = 3;
                           |SI fra ! #2#1;
                             linea = 1
                             fra = #2#1;
                           |FINSI;
                            #2pasa = linea;
                            campo ="";
                            texto2 = texto + pasa + texto1 + linea;
                            linea = linea + 1;
                            sw = sw + 1;
                            |LEE 141#2=;
                            |LIBERA #2;
                             guarda = FSalida;
                          |SINO;
                            |SI pasa=5; pasa = 6;sw=sw+1;|FINSI;
                            |SI pasa = 10;
                              sw=sw + 2;
                            |SINO;
                              |SI pasa = 13;
                                   pasa = 14;
                              |SINO;
                                   |SI pasa = 14; pasa = 12;|FINSI;
                                   |SI pasa = 15; pasa = 13;|FINSI;
                                   |SI pasa=16; pasa = 15;|FINSI;
                                   |SI pasa=17; pasa = 16;|FINSI;
                              |FINSI;
                              #2pasa = campo;
                          |FINSI;
                            texto2 = texto + pasa + texto1 + campo;
                            campo = "";
                            sw = sw + 1;
                          |FINSI;
                        |FINSI;
                    |FINSI;
               |SIGUE;
               |HAZ grabalineas;
               campo = "";
          |FINSI;
       |SIGUE;
     |FINSI;
     FSalida = f;
     |SI FSalida ] 0;
     |FCIERRA FSalida;
     |FINSI;
     |LIBERA #2;
     |CIERRA #2;
     Pos = -1;
|FPRC;

|| ------------------------ GRABA FICHERO LINEAS ----------------------------
|PROCESO grabalineas;
     bruto    = 0;
     impuesto = 0;
     |ABRE #4;           || Articulos
          #4#0 = #2#4;
          |LEE 000#4=;
          |LIBERA #4;
          #2#5 = #4#1;
     |LIBERA #4;
     |CIERRA #4;

          enTiva = #2#9;
          efFiva = #1#3;
          |HAZ SacaIVA;
          impuesto = enIva;

          impuesto = enIva;
          |ABRE #3;
          #3#0 = #1#4;
          |LEE 000#3=;
          |LIBERA #3;
          |SI #3#47 = "S"; impuesto = enIva + enRec; |FINSI;

     ||SI #2#14 ! 0;
       bruto = #2#14 * #2#7 ! EURODB;          || base.
     ||SINO;
       ||bruto = #2#6 * #2#7 ! EURODB;           || base.
     ||FINSI;
     #2#16 = #2#6 * #2#15;
 ||    bruto = bruto + #2#16;
     bruto = bruto < #2#8;         || dto.
     bruto = bruto + #2#16;

     #2#10 = bruto;                || bruto.
     #2#11 = #0#0;                 || Almacen.
     |LIBERA #3;
     |CIERRA #3;
     |SI guarda ! 0;
          |GRABA 121#2n;
          |LIBERA #2;
     |SINO;
          |GRABA 121#2a;
          |LIBERA #2;
     |FINSI;
|FPRC;

|PROCESO movimi;
|| ----------------- LEE EL FICHERO SEQUENCIAL DEL PSION --------------------
     empresa  = "";
     cadena   = "";
     fichero  = "";
     long     = "";
     caracter = "";
     campo    = "";
     i        = 0;
     f        = 0;
     ind      = 0;
     valor    = 0;
     sw       = 0;
     pasa     = 0;
     jj       = 0;
     sal      = 0;
     guarda   = 0;
     |ABRE #7;
     |DFICE empresa;
     empresa = empresa + "movimie.asc";
     |QBF empresa;
     fichero = "rt  " + empresa;
     |QBF empresa;
     |FABRE fichero;
     f = FSalida;
     sal = 0;
     |SI FSalida = 0;
       |PARA jj = 1; |SI sal ] 0; |HACIENDO jj = jj + 1;
          cadena = f + " " + 254;
          |FLEE cadena;
          sal = FSalida;
          |SI FSalida >1;
               long = cadena % 0;
               sw = 0;
               |PARA ind = 1; |SI ind [ long; |HACIENDO ind = ind + 1;
                    i = (ind * 100) + 1;
                    caracter = cadena % i;
                    valor = &caracter;
                    |SI valor ! 9; |Y valor ! 13;
                         campo = campo + caracter;
                    |FINSI;
                    |SI valor = 9; |O long = ind;
                         pasa = sw;
                         #7pasa = campo;
                         campo = "";
                         sw = sw + 1;
                         |SI pasa = 2;
                              conta = conta +1;
                              #7#6 = conta;
                              |LEE 141#7=;
                              |LIBERA #7;
                              guarda = FSalida;
                         |FINSI;
                    |FINSI;
               |SIGUE;
               |HAZ grabamovimi;
               campo = "";
          |FINSI;
       |SIGUE;
     |FINSI;
     FSalida = f;
     |SI FSalida ] 0;
     |FCIERRA FSalida;
     |FINSI;
     |LIBERA #7;
     |CIERRA #7;
     Pos = -1;

|| ------------------------ GRABA FICHERO Movimi --------------------------
|FPRC;

|PROCESO cobros;
|| ----------------- LEE EL FICHERO SEQUENCIAL DEL PSION --------------------
     empresa  = "";
     cadena   = "";
     fichero  = "";
     long     = "";
     caracter = "";
     campo    = "";
     i        = 0;
     f        = 0;
     ind      = 0;
     valor    = 0;
     sw       = 0;
     pasa     = 0;
     jj       = 0;
     sal      = 0;
     guarda   = 0;
     |ABRE #6;
     |DFICE empresa;
     empresa = empresa + "cobros.asc";
     |QBF empresa;
     fichero = "rt  " + empresa;
     |QBF empresa;
     |FABRE fichero;
     f = FSalida;
     sal = 0;
     |SI FSalida = 0;
       |PARA jj = 1; |SI sal ] 0; |HACIENDO jj = jj + 1;
          cadena = f + " " + 254;
          |FLEE cadena;
          sal = FSalida;
          |SI FSalida >1;
               long = cadena % 0;
               sw = 0;
               |PARA ind = 1; |SI ind [ long; |HACIENDO ind = ind + 1;
                    i = (ind * 100) + 1;
                    caracter = cadena % i;
                    valor = &caracter;
                    |SI valor ! 9; |Y valor ! 13;
                         campo = campo + caracter;
                    |FINSI;
                    |SI valor = 9; |O long = ind;
                         pasa = sw;
                         #6pasa = campo;
                         campo = "";
                         sw = sw + 1;
                         |SI pasa = 2;
                              |LEE 141#6=;
                              |LIBERA #6;
                              guarda = FSalida;
                         |FINSI;
                    |FINSI;
               |SIGUE;
               |HAZ grabacobros;
               campo = "";
          |FINSI;
       |SIGUE;
     |FINSI;
     FSalida = f;
     |SI FSalida ] 0;
     |FCIERRA FSalida;
     |FINSI;
     |LIBERA #6;
     |CIERRA #6;
     Pos = -1;

|| ------------------------ GRABA FICHERO Movimi --------------------------
|FPRC;

|PROCESO cobros1;
|| ----------------- LEE EL FICHERO SEQUENCIAL DEL PSION --------------------
     empresa  = "";
     cadena   = "";
     fichero  = "";
     long     = "";
     caracter = "";
     campo    = "";
     i        = 0;
     f        = 0;
     ind      = 0;
     valor    = 0;
     sw       = 0;
     pasa     = 0;
     jj       = 0;
     sal      = 0;
     guarda   = 0;
     |ABRE #9;
     |DFICE empresa;
     empresa = empresa + "cobros1.asc";
     |QBF empresa;
     fichero = "rt  " + empresa;
     |QBF empresa;
     |FABRE fichero;
     f = FSalida;
     sal = 0;
     |SI FSalida = 0;
       |PARA jj = 1; |SI sal ] 0; |HACIENDO jj = jj + 1;
          cadena = f + " " + 254;
          |FLEE cadena;
          sal = FSalida;
          |SI FSalida >1;
               long = cadena % 0;
               sw = 0;
               |PARA ind = 1; |SI ind [ long; |HACIENDO ind = ind + 1;
                    i = (ind * 100) + 1;
                    caracter = cadena % i;
                    valor = &caracter;
                    |SI valor ! 9; |Y valor ! 13;
                         campo = campo + caracter;
                    |FINSI;
                    |SI valor = 9; |O long = ind;
                         pasa = sw;
                         #9pasa = campo;
                         campo = "";
                         sw = sw + 1;
                         |SI pasa = 2;
                              |LEE 141#9=;
                              |LIBERA #9;
                              guarda = FSalida;
                         |FINSI;
                    |FINSI;
               |SIGUE;
               |HAZ grabacobros1;
               campo = "";
          |FINSI;
       |SIGUE;
     |FINSI;
     FSalida = f;
     |SI FSalida ] 0;
     |FCIERRA FSalida;
     |FINSI;
     |LIBERA #9;
     |CIERRA #9;
     Pos = -1;
|FPRC;



|| ------------------------- RUTINA PRINCIPAL -------------------------------
|PROCESO captura; |TIPO 3;
     |SI #0#1 = "SI";
          |ABRE #1; |CIERRA #1; |DELINDEX #1;
          |ABRE #2; |CIERRA #2; |DELINDEX #2;
          |ABRE #6; |CIERRA #6; |DELINDEX #6;
          |ABRE #7; |CIERRA #7; |DELINDEX #7;
          |ABRE #9; |CIERRA #9; |DELINDEX #9;
          |ABRE #2;
          |HAZ lineas;
          |LIBERA #2;
          |CIERRA #2;

          |ABRE #1;
          |PINTA 2023 , "                               ";
          |PINTA 2023 , "Documentos .........";
          |HAZ cabecera;
          |LIBERA #1;
          |CIERRA #1;

          |ABRE #1;
          |ABRE #2;
          |HAZ cabecera;
          |LIBERA #2;
          |CIERRA #2;
          |LIBERA #1;
          |CIERRA #1;

          |ABRE #6;
          |PINTA 2023 , "Cobros Facturas .........";
          |HAZ cobros;
          |LIBERA #6;
          |CIERRA #6;

          |ABRE #9;
          |PINTA 2023 , "Cobros Albaran .........";
          |HAZ cobros1;
          |LIBERA #9;
          |CIERRA #9;

          |ABRE #7;
          |PINTA 2023 , "Movimientos Almacen .....";
          |HAZ movimi;
          |LIBERA #7;
          |CIERRA #7;
     |FINSI;
|FPRC;
