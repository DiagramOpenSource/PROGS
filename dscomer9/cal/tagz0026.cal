|FICHEROS;
     dsm00087 #1;
     tagm0030 #30;
     tagm0032 #32;
     tagm0052 #52;
     tagm0079 #79;
     tagm0081 #81;
     tagm0087 #87;
     tagm0088 #88;
     tagm0090 #90;
     agifa104 #104;
     agifa024 #24;
     tmp00000 #300;
     agifa146 #146;
|FIN;

|VARIABLES;
     aDoc = "";
     aNum = "";
     aKeyP = "";
     nSwProforma = 0;
     &enTipo = 0;
     &enSwImp = 0;
     &eaSerBlc = "";
     &enNumBlc = 0;
     &aDivisa = "";
     &aMoneda = "";
     &enGraba300 = 0;
     &ser_ped = "";
     &num_ped = 0;
     &eaImpresora = "";
     aAno = "";
     aPath = "";
     aAlfa = "";
     aTmp = "";
     aEmp = "";
     aNom = "";
     aLon = "";
     aCar = "";
     i = 0;
     nPos = 0;
     aExe = "";
     f = "";
     c = "";
     aFic = "";
     nHandle = 0;
     aNum4 = "";
     aNum6 = "";
     aNum7 = "";
     aNum8 = "";
     aNum9 = "";
     aNum11 = "";
     aNum12 = "";
     aNum13 = "";
     aNum14 = "";
     aNum15 = "";
     aNum16 = "";
     aNum17 = "";
     aNum18 = "";
     nNum4 = "";
     nNum6 = "";
     nNum7 = "";
     nNum8 = "";
     nNum9 = "";
     nNum11 = "";
     nNum12 = "";
     nNum13 = "";
     nNum14 = "";
     nNum15 = "";
     nNum16 = "";
     nNum17 = "";
     nNum18 = "";
     aFecha = "";
     aKey = "";
     fHoy = @;
     aDato = "";
|FIN;

|PROCESO Imprime;
     |PRINT;
|FPRC;

|PROCESO Accesorios;
     |SI enSwImp = 1;
          enSwImp = 2; |PRINT;
          enSwImp = 3;
     |FINSI;
     |PRINT;
|FPRC;

|DEFBUCLE Accesorios;
     #32#1;
     ;
     #30#0, #30#1, 001;
     #30#0, #30#1, 999;
     ;
     NULL, Accesorios;
|FIN;

|PROCESO ImprimeBlock;
     enTipo = 1;
     Impresora = eaImpresora;
     |IMPRE -1;
     |SI FSalida = 0;
          |INFOR "tagm0030";
          |SI FSalida = 0;
               enSwImp = 1;
               |BUCLELIN 0 Imprime #30;
               |BUCLE Accesorios;
               |PIEINF;
               |FININF;
          |SINO;
               |MENAV "0000No existe informe 'tagm0030'";
          |FINSI;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO Punto2Coma;
     aDato = "";
     aLon = aAlfa % A0;
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aCar = aAlfa % nPos;
          |SI aCar = ".";
               aCar = ",";
          |FINSI;
          aDato = aDato + aCar;
     |SIGUE;
     aAlfa = aDato;
|FPRC;

|PROCESO Graba;
     aAlfa = aAlfa + f;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO Apo;
     fHoy = ~;
     aFecha = (fHoy % 102) + "/" + (fHoy % 402) + "/" + (fHoy % 704);
     |HORA aAlfa;
     aFecha = aFecha + " " + aAlfa;

     |SI eaSerBlc = "";
          aKey = aEmp + (#104#25 % 102) + ("000000" + #104#0) % -106;
          aNum4 = #104#8; |QBF aNum4; nNum4 = aNum4 % A0;
          aNum6 = #104#4; nNum6 = aNum6 % A0;
          aNum7 = (#104#25 % 102) + "." + (("000000" + #104#0) % -106); nNum7 = aNum7 % A0;
          aNum8 = (#104#1 % 102) + "/" + (#104#1 % 402) + "/" + (#104#1 % 704); nNum8 = aNum8 % A0;
          aNum9 = aEmp;
          aNum11 = #24#18; |QBF aNum11; nNum11 = aNum11 % A0;
          aNum12 = #24#197; |QBF aNum12; nNum12 = aNum12 % A0;
          aNum13 = #81#1; |QBF aNum13; nNum13 = aNum13 % A0;
          aNum14 = ("0000" + #104#60) % -102; nNum14 = aNum14 % A0;

          aAlfa = #104#45; |HAZ Punto2Coma;
          aNum15 = aAlfa; nNum15 = aNum15 % A0;

          #90#0 = #104#9;
          |LEE 000#90=;
          |SI FSalida = 0;
               aNum16 = "SI";
          |SINO;
               aNum16 = "NO";
          |FINSI;

          aNum17 = Usuario % 810; |QBF aNum17; nNum17 = aNum17 % A0;
          aNum18 = #104#20; |QBF aNum18; nNum18 = aNum18 % A0;
     |SINO;
          aKey = aEmp + (#30#0 % 102) + ("000000" + #30#1) % -106;
          aNum4 = #30#6; |QBF aNum4; nNum4 = aNum4 % A0;
          aNum6 = #30#3; nNum6 = aNum6 % A0;
          aNum7 = (#30#0 % 102) + "." + (("000000" + #30#1) % -106); nNum7 = aNum7 % A0;
          aNum8 = (#30#2 % 102) + "/" + (#30#2 % 402) + "/" + (#30#2 % 704); nNum8 = aNum8 % A0;
          aNum9 = aEmp;
          aNum11 = #24#18; |QBF aNum11; nNum11 = aNum11 % A0;
          aNum12 = #24#197; |QBF aNum12; nNum12 = aNum12 % A0;
          aNum13 = "PUERTAS"; |QBF aNum13; nNum13 = aNum13 % A0;
          aNum14 = ("0000" + #104#60) % -102; nNum14 = aNum14 % A0;

          aAlfa = #30#29; |HAZ Punto2Coma;
          aNum15 = aAlfa; nNum15 = aNum15 % A0;

          #90#0 = #30#5;
          |LEE 000#90=;
          |SI FSalida = 0;
               aNum16 = "SI";
          |SINO;
               aNum16 = "NO";
          |FINSI;

          aNum17 = Usuario % 810; |QBF aNum17; nNum17 = aNum17 % A0;
          aNum18 = #30#19; |QBF aNum18; nNum18 = aNum18 % A0;
     |FINSI;

     aFic = aPath + aNom + ".apo";
     |XABRE "WBC", aFic, nHandle;
     |SI FSalida ] 0;
          aAlfa = "list" + f + "{" + f + "template(" + c + c + ");";
          |HAZ Graba;

          aAlfa = "doc_type(" + c + "PDF" + c + ");";
          |HAZ Graba;

          aAlfa = "type(" + c + "50" + c + ");";
          |HAZ Graba;

          aAlfa = "date(" + c + aFecha + c + ");";
          |HAZ Graba;

          aAlfa = "doc" + f + "{" + f + "key(" + c + "50/" + aKey + c + ");";
          |HAZ Graba;

          aAlfa = "data" + f + "{";
          |HAZ Graba;

          aAlfa = "(1)(" + c + "30" + c + "," + c + "A" + c + "," + c+ "2" + c + ");";
          |HAZ Graba;

          aAlfa = "(2)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;

          aAlfa = "(3)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;

          aAlfa = "(4)(" + c + aNum4 + c  + "," + c + "A" + c + "," + c + nNum4 +  c + ");";
          |HAZ Graba;

          aAlfa = "(5)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;

          aAlfa = "(6)(" + c + aNum6 + c + "," + c + "A" + c + "," + c + nNum6 + c + ");";
          |HAZ Graba;

          aAlfa = "(7)(" + c + "30." + aNum7 + c + "," + c + "A" + c + "," + c + "12" + c + ");";
          |HAZ Graba;

          aAlfa = "(8)(" + c + aNum8 + c + "," + c + "A" + c + "," + c + "10" + c + ");";
          |HAZ Graba;

          aAlfa = "(9)(" + c + aEmp + c + "," + c + "A" + c + "," + c + "2" + c + ");";
          |HAZ Graba;

          aAlfa = "(10)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");";
          |HAZ Graba;

          aAlfa = "(11)(" + c + aNum11 + c  + "," + c + "A" + c + "," + c + nNum11 + c + ");";
          |HAZ Graba;

          aAlfa = "(12)(" + c + aNum12 + c + "," + c + "A" + c + "," + c + nNum12 + c + ");";
          |HAZ Graba;

          aAlfa = "(13)(" + c + aNum13 + c + "," + c + "A" + c + "," + c + nNum13 + c + ");";
          |HAZ Graba;

          aAlfa = "(14)(" + c + aNum14 + c + "," + c + "A" + c + "," + c + nNum14 + c + ");";
          |HAZ Graba;

          aAlfa = "(15)(" + c + aNum15 + c + "," + c + "A" + c + "," + c + nNum15 + c + ");";
          |HAZ Graba;

          aAlfa = "(16)(" + c + aNum16 + c + "," + c + "A" + c + "," + c + nNum16 + c + ");";
          |HAZ Graba;

          aAlfa = "(17)(" + c + aNum17 + c + "," + c + "A" + c + "," + c + nNum17 + c + ");";
          |HAZ Graba;

          aAlfa = "(18)(" + c + aNum18 + c + "," + c + "A" + c + "," + c + nNum18 + c + ");";
          |HAZ Graba;

          aAlfa = "}" + f + "contents" + f + "{" + f + "1;" + f + "}" + f;
          |HAZ Graba;

          |SI nSwProforma = 0;
               aKeyP = "";
               aAlfa = "}" + f + "}";
          |SINO;
               |SI eaSerBlc = "";
                    aKeyP = "51/" + aEmp + (#146#48 % 102) + (("000000" + #146#0) % -106);
                    aAlfa = "signaling" + f + "{" + f + "(" + c + "1642017|50/" + aKey + "|" + aKeyP + "|" + c + ");" + f + "}" + f + "}" + f + "}";
               |SINO;
                    aKeyP = "51/" + aEmp + (#52#0 % 102) + (("000000" + #52#1) % -106);
                    aAlfa = "signaling" + f + "{" + f + "(" + c + "1642017|50/" + aKey + "|" + aKeyP + "|" + c + ");" + f + "}" + f + "}" + f + "}";
               |FINSI;
          |FINSI;
          |HAZ Graba;
          |XCIERRA nHandle;
     |SINO;
          aAlfa = "0000Error al crear fichero:" + aFic;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO Sal;
     aFic = aPath + aNom + ".sal";
     |XABRE "WBC", aFic, nHandle;
     |SI FSalida ] 0;
          aAlfa = "USER=" + Usuario % 810;
          |ABRE #1; |SELECT #2#1;
          aDoc =  ("000000" + #104#0) % -106;
          #1#1 = #104#25;
          #1#2 = aDoc;
          #1#3 = "PV";
          |LEE 000#1=;
          |SI FSalida = 0;
               aAlfa = "USER=" + #1#4; |QBF aAlfa;
          |FINSI;
          |CIERRA #1;

          |HAZ Graba;

          aAlfa = "CONTENIDO=" + aPath + aNom + ".pdf";
          |HAZ Graba;

          aAlfa = "PORTADA=" + aPath + aNom + ".apo";
          |HAZ Graba;

          aAlfa = "NOTRANSFORM=1" + f;
          aAlfa = aAlfa + "WHATTODO=2" + f;
          aAlfa = aAlfa + "TIFF=0" + f;
          aAlfa = aAlfa + "TIF=0" + f;
          aAlfa = aAlfa + "FAX=" + f;
          aAlfa = aAlfa + "PDF=1" + f;
          |HAZ Graba;
          |XCIERRA nHandle;
     |SINO;
          aAlfa = "0000Error al crear fichero:" + aFic;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO Block;
     |ABRE #30;
     #30#0 = eaSerBlc;
     #30#1 = enNumBlc;
     |LEE 020#30=;
     |CIERRA #30;

     #88#0 = #30#0;
     |LEE 000#88=;
     |SI FSalida = 0; |Y #88#3 = "S";
          aAno = #30#2 % 704;

          aNom = "P" + aEmp + (#30#0 % 102) + aAno + (("000000"+#30#1)%-106);
          eaImpresora = "CrystalReport;" + aPath + aNom + ".pdf";
          |HAZ ImprimeBlock;

          #24#0 = #30#3;
          |LEE 000#24=;
          |SI FSalida ! 0; |DDEFECTO #24; |FINSI;

          #79#0 = #30#0;
          #79#1 = #30#1;
          |LEE 000#79=;
          |SI FSalida ! 0; |DDEFECTO #79; |FINSI;

          #81#0 = #79#3;
          |LEE 000#81=;
          |SI FSalida ! 0; |DDEFECTO #81; |FINSI;

          |ABRE #52; |SELECT #3#52;
          #52#24 = #30#0;
          #52#25 = #30#1;
          |LEE 000#52=;
          |SI FSalida = 0;
               nSwProforma = 1;
          |SINO;
               nSwProforma = 0;
          |FINSI;
          |CIERRA #52;

          |HAZ Apo;
          |HAZ Sal;

          aExe = #87#5; |QBF aExe;
          aExe = aExe + "jafsmb.exe " + aPath + aNom + ".sal";
          |RSYSTEM aExe;
     |FINSI;
|FPRC;

|PROCESO Proforma;
     nSwProforma = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE Proforma;
     #146#6;
     ;
     "P", #104#25, aNum;
     "P", #104#25, aNum;
     ;
     NULL, Proforma;
|FIN;

|PROCESO Tmp;
     #88#0 = #300#0;
     |LEE 000#88=;
     |SI FSalida = 0; |Y #88#3 = "S";
          #104#25 = #300#0;
          #104#0 = #300#1;
          |LEE 020#104=;

          aAno = #104#1 % 704;

          aNom = "P" + aEmp + (#300#0 % 102) + aAno + (("000000"+#300#1)%-106);
          ser_ped = #300#0;
          num_ped = #300#1;
          eaImpresora = "CrystalReport;" + aPath + aNom + ".pdf";
          |SUB_EJECUTA_NP "agifa105";

          aDivisa = #104#35;
          aMoneda = #104#37;
          |HAZ Divisas104;

          #24#0 = #104#4;
          |LEE 000#24=;
          |SI FSalida ! 0; |DDEFECTO #24; |FINSI;

          #79#0 = #300#0;
          #79#1 = #300#1;
          |LEE 000#79=;
          |SI FSalida ! 0; |DDEFECTO #79; |FINSI;

          #81#0 = #79#3;
          |LEE 000#81=;
          |SI FSalida ! 0; |DDEFECTO #81; |FINSI;

          nSwProforma = 0;
          aNum = ("000000" + #104#0) % -106;
          |BUCLE Proforma;

          |HAZ Apo;
          |HAZ Sal;

          aExe = #87#5; |QBF aExe;
          aExe = aExe + "jafsmb.exe " + aPath + aNom + ".sal";
          |RSYSTEM aExe;
     |FINSI;
|FPRC;

|DEFBUCLE Tmp;
     #300#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Tmp;
|FIN;

|PROGRAMA;
     f = &13; f = f + &10;
     c = &34;
     enGraba300 = 1;
     aEmp = "30";

     |ABRE #87; |LEE 000#87p; |CIERRA #87;

     aPath = "c:\ds\item\";
     |RMKDIR aPath;

     |ABRE #104;
     |ABRE #90;
     |ABRE #88;
     |ABRE #81;
     |ABRE #79;
     |ABRE #24;

     |SI eaSerBlc = "";
          aTmp = PARAMETRO; |NOME_DAT #300 aTmp;
          |BUCLE Tmp;
     |SINO;
          |HAZ Block;
     |FINSI;

     |CIERRA #24;
     |CIERRA #79;
     |CIERRA #81;
     |CIERRA #88;
     |CIERRA #90;
     |CIERRA #104;

     eaImpresora = "";
     enGraba300 = 0;
|FPRO;
