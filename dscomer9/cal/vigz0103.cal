|FICHEROS;
   vigz0103 #0;

   agifa104 #10;
   agifa073 #11;

   agifa077 #20;
   agifa080 #21;
   agifa019 #22;

   vigm0001 #50;
|FIN;

|VARIABLES;
   aAlfa    = "";
   aAlfa1   = "";
   aAlfa2   = "";
   aIP      = "";
   aFicheroLCK = "";
   aOrigen  = "";
   aDestino = "";
   aUnidadDS = "";
   aDirRemoto = "";
   aBaseDatos = "";
{1}aContiene  = "";

   nHandle  = 0;
   nHandle1 = 0;
   nPausa   = 0;
|FIN;

|PROCESO Descomprime
   |SI aIP ! "";
      |RDESCOMPRIME aDestino;
      |RDETAR aDestino, aDirRemoto;
      |RFBORRA aDestino; aDestino = aDestino - ".tgz";
      aDestino = aDestino + ".tar"; |RFBORRA aDestino;
   |SINO;
      |DESCOMPRIME aDestino;
      |DETAR aDestino, aDirRemoto;
      |FBORRA aDestino; aDestino = aDestino - ".tgz";
      aDestino = aDestino + ".tar"; |FBORRA aDestino;
   |FINSI;
|FPRC;

|PROCESO CopiaConMD5;
   aContiene1 = aOrigen;
   |ESPECIFICA "MD5", aContiene;
   aAlfa = FSalida; |QBF aAlfa;

   aContiene1 = aDestino;
   |SI aIP = "";
      |ESPECIFICA "MD5", aContiene;
   |SINO;
      |ESPECIFICA "REMOTOMD5", aContiene;
   |FINSI;
   aAlfa1 = FSalida; |QBF aAlfa1;

   |SI aAlfa ! aAlfa1;
      |SI aIP = "";
         |COPIA_FICHERO aOrigen, aDestino;
      |SINO;
         |ENVIA_FICHERO aOrigen, aDestino;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO AlbaranesCmpLins;
   #agifa019#0 = #agifa080#2;
   |LEE 000#agifa019.=;
   |SI FSalida ! 0; |DDEFECTO #agifa019; |FINSI;
   aAlfa = #agifa019#126; |QBT aAlfa;
   |SI aAlfa ! "1"; |ACABA; |FINSI;

   #vigm0001#0 = #agifa080#2;
   |LEE 000#vigm0001.=;
   |SI FSalida ! 0; |DDEFECTO #vigm0001; |FINSI;

   aAlfa = #agifa077#1; |QBF aAlfa;
   aAlfa = (aAlfa % 0102) + "/" + (aAlfa % 0402) + "/" + (aAlfa % 0704) + &9;
   |XGRABA nHandle, aAlfa;

   aAlfa = #agifa080#37; |QBF aAlfa; aAlfa = aAlfa + &9;
   |XGRABA nHandle, aAlfa;
   aAlfa = #agifa077#0;  |QBF aAlfa; aAlfa = aAlfa + &9;
   |XGRABA nHandle, aAlfa;
   aAlfa = #agifa080#2;  |QBF aAlfa; aAlfa = aAlfa + &9;
   |XGRABA nHandle, aAlfa;
   aAlfa = #agifa077#3;  |QBF aAlfa; aAlfa = aAlfa + &9;
   |XGRABA nHandle, aAlfa;
   aAlfa = #agifa080#5;  |QBF aAlfa; aAlfa = aAlfa + &13 + &10;
   |XGRABA nHandle, aAlfa;
|FPRC;

|DEFBUCLE AlbaranesCmpLins;
#agifa080#1;
;
#agifa077#50, #agifa077#0, 001;
#agifa077#50, #agifa077#0, 999;
;
NULL, AlbaranesCmpLins;
|FIN;

|PROCESO AlbaranesCmp;
   |BUCLE AlbaranesCmpLins;

   #agifa077#75 = "S";
   |GRABA 020#agifa077.a; |LIBERA #agifa077;
|FPRC;

|DEFBUCLE AlbaranesCmp;
#agifa077#1;
1, 75;
#vigz0103#2, 000000, #vigz0103#0, "N";
#vigz0103#3, 999999, #vigz0103#1, "N";
be;
NULL, AlbaranesCmp;
|FIN;

|PROCESO PedidosVtaLins;
   #vigm0001#0 = #agifa073#2;
   |LEE 000#vigm0001.=;
   |SI FSalida ! 0; |DDEFECTO #vigm0001; |FINSI;

   aAlfa = #agifa104#1; |QBF aAlfa;
   aAlfa = (aAlfa % 0102) + "/" + (aAlfa % 0402) + "/" + (aAlfa % 0704) + &9;
   |XGRABA nHandle, aAlfa;

   aAlfa = #vigm0001#10; |QBF aAlfa; aAlfa = aAlfa + &9;
   |XGRABA nHandle, aAlfa;
   aAlfa = #agifa073#5; |QBF aAlfa; aAlfa = aAlfa + &9;
   |XGRABA nHandle, aAlfa;
   aAlfa = #agifa104#4; |QBF aAlfa; aAlfa = aAlfa + &9;
   |XGRABA nHandle, aAlfa;
   aAlfa = (("000000" + #agifa073#0) % -106) + "/" + (("000" + #agifa073#1) % -103); |QBF aAlfa; aAlfa = aAlfa + &9;
   |XGRABA nHandle, aAlfa;
   aAlfa = #agifa104#53; |QBF aAlfa;
   aAlfa = aAlfa + " " + #agifa104#54; |QBF aAlfa;
   aAlfa = aAlfa + " " + #agifa104#55; |QBF aAlfa; aAlfa = aAlfa + &13 + &10;
   |XGRABA nHandle, aAlfa;
|FPRC;

|DEFBUCLE PedidosVtaLins;
#agifa073#1;
;
#agifa104#25, #agifa104#0, 001;
#agifa104#25, #agifa104#0, 999;
;
NULL, PedidosVtaLins;
|FIN;

|PROCESO PedidosVta;
   |BUCLE PedidosVtaLins;

   #agifa104#27 = "S";
   |GRABA 020#agifa104.a; |LIBERA #agifa104;
|FPRC;

|DEFBUCLE PedidosVta;
#agifa104#1;
1, 27;
#vigz0103#2, 000000, #vigz0103#0, "N";
#vigz0103#3, 999999, #vigz0103#1, "N";
be;
NULL, PedidosVta;
|FIN;

|PROCESO Access;
   || Espero primero a que la base de datos este desbloqueada
   aAlfa1 = aDirRemoto + aBaseDatos;
   aAlfa2 = aDirRemoto + "abase.mdb";
   |XABRE "CE", aAlfa2, nHandle1;
   |PARA; |SI FSalida < 0; |HACIENDO;
      |RRENOMBRA_FICHERO aAlfa1, aAlfa2;
      |XABRE "CE", aAlfa2, nHandle1;

      |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
      |SIGUE;
      |MENSA "Esperando al desbloqueo de la base de datos";
   |SIGUE;
   |RRENOMBRA_FICHERO aAlfa2, aAlfa1;
   |BLIN 4;

   aFicheroLCK  = aDirRemoto + "fin" + Usuario + ".txt";
   |RFBORRA aFicheroLCK;

   aAlfa  = "START " + aDirRemoto + "dsabreextension.exe " + aDirRemoto + aBaseDatos + " " + aFicheroLCK;
   |RSYSTEM aAlfa;

   |PARA; |SI; |HACIENDO;
      |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
      |SIGUE;

      |XABRE "EC", aFicheroLCK, nHandle;
      |SI FSalida ] 0; |SAL; |FINSI;

      |PULSATECLA;
   |SIGUE;

   |RFBORRA aFicheroLCK;
   |PULSATECLA;
|FPRC;

|PROGRAMA;
   |CLS;
   |SI PARAMETRO = "PV";
      |CABEZA "Importacion access pedidos venta";
   |FINSI;
   |SI PARAMETRO = "AC";
      |CABEZA "Importacion access albaranes compra";
   |FINSI;
   |PINPA #0#0; |PINDA #0#0;
   |SI PARAMETRO = "PV";
      |ATRI R; |PINTA 0724, "PEDIDOS VENTA "; |ATRI N;
   |FINSI;
   |SI PARAMETRO = "AC";
      |ATRI R; |PINTA 0724, "ALBARANES COMPRA "; |ATRI N;
   |FINSI;
   |MENSA "    Esperando acceder a la base de datos ....";

   |ABRE #agifa019;
   |ABRE #vigz0103;
   |LEE 101#vigz0103.p;
   |SI FSalida ! 0;
      |DDEFECTO #vigz0103;
      |GRABA 000#vigz0103.b;
   |FINSI;

   |BLIN 4;
   |PINPA #0#0; |PINDA #0#0;
   |SI PARAMETRO = "PV";
      |ATRI R; |PINTA 0724, "PEDIDOS VENTA "; |ATRI N;
   |FINSI;
   |SI PARAMETRO = "AC";
      |ATRI R; |PINTA 0724, "ALBARANES COMPRA "; |ATRI N;
   |FINSI;

   aIP = ""; |IP_REMOTO aIP;
/*

   |SI aIP ! "";
      aContiene = "";
      |ESPECIFICA "RBASS", aContiene;
      aAlfa = aContiene1; |QBF aAlfa;
   |SINO;
      |DBASS aAlfa;
   |FINSI;
   aAlfa1 = ""; aAlfa2 = "";
   |PARA; |SI aAlfa2 ! "/"; |Y aAlfa2 ! "\"; |HACIENDO;
      aAlfa2 = aAlfa % 0101; aAlfa = aAlfa % 0299;
      aAlfa1 = aAlfa1 + aAlfa2;
   |SIGUE;
   aUnidadDS = aAlfa1;
   aAlfa = aUnidadDS + "coavic/";
   |SI aIP ! ""; |RMKDIR aAlfa; |SINO; |MKDIR aAlfa; |FINSI;
   aDirRemoto = aAlfa;
*/
   |ENDATOS #1#0;
   |SI FSalida = 0;
      aAlfa = #vigz0103#4; |QBF aAlfa;
      aAlfa1 = aAlfa % -101;
      |SI aAlfa1 ! "/"; |Y aAlfa1 ! "\";
         aAlfa = aAlfa + "/"; #vigz0103#4 = aAlfa;
      |FINSI;

      |GRABA 000#vigz0103.a;
      aDirRemoto = #vigz0103#4; |QBF aDirRemoto;

      |ABRE #vigm0001;
      |DBASE aAlfa; |QBF aAlfa;
      aAlfa1 = aAlfa + "tmp/"; |MKDIR aAlfa1;
      |SI PARAMETRO = "PV";
         aAlfa1 = aAlfa1 + "pedido.txt";
      |FINSI;
      |SI PARAMETRO = "AC";
         aAlfa1 = aAlfa1 + "albaran.txt";
      |FINSI;
      |XABRE "BW", aAlfa1, nHandle;
      |SI FSalida = 0;
         |SI PARAMETRO = "PV"; |BUCLE PedidosVta;   |FINSI;
         |SI PARAMETRO = "AC"; |BUCLE AlbaranesCmp; |FINSI;
         |XCIERRA nHandle;

         aAlfa = aDirRemoto; |QBF aAlfa;
         aAlfa = aAlfa + "consumos.mdb";
         |XABRE "CE", aAlfa, nHandle;
         |SI FSalida < 0;
            |DBASE aOrigen;  |QBF aOrigen;  aOrigen  = aOrigen  + "patrones/access/consumos.tgz";
            aDestino = aDirRemoto + "consumos.tgz";
            |HAZ CopiaConMD5;
            |HAZ Descomprime;
         |FINSI;

         |SI PARAMETRO = "PV";
            |DBASE aOrigen;  |QBF aOrigen;  aOrigen  = aOrigen  + "tmp/pedido.txt";
            aDestino = aDirRemoto + "pedido.txt";
         |FINSI;
         |SI PARAMETRO = "AC";
            |DBASE aOrigen;  |QBF aOrigen;  aOrigen  = aOrigen  + "tmp/albaran.txt";
            aDestino = aDirRemoto + "albaran.txt";
         |FINSI;
         |HAZ CopiaConMD5;

         |DBASE aOrigen;  |QBF aOrigen;  aOrigen  = aOrigen  + "plugins/dsabreextension.exe";
         aDestino = aDirRemoto + "dsabreextension.exe";
         |HAZ CopiaConMD5;

         aBaseDatos = "consumos.mdb"; |HAZ Access;
      |FINSI;
      |CIERRA #vigm0001;
   |FINSI;

   |LIBERA #vigz0103; |CIERRA #vigz0103;
   |CIERRA #agifa019;
|FPRO;
