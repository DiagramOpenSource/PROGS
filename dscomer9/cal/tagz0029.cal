|FICHEROS;
     tagm0030 #30;
     tagm0031 #31;
     tagm0032 #32;
     tagm0052 #52;
     tagm0053 #53;
     tagm0054 #54;
     tagm0090 #90;

     agifa024 #24;
     tagm0081 #81;
     tagm0087 #87;
     tagm0084 #84;
     tagm0090 #90;
|FIN;

|VARIABLES;
     &enTipo = 0;
     &enSwImp = 0;
     &eaSerBlc = "";
     &enNumBlc = 0;
     aPago = "";
     aAno = "";
     aPath = "";
     aAlfa = "";
     aTmp = "";
     aEmp = "";
     aNom = "";
     aLon = "";
     aCar = "";
     i = 0;
     nPos = 0;
     aExe = "";
     f = "";
     c = "";
     aFic = "";
     nHandle = 0;
     aNum4 = "";
     aNum6 = "";
     aNum7 = "";
     aNum8 = "";
     aNum9 = "";
     aNum10 = "";
     aNum11 = "";
     aNum12 = "";
     aNum13 = "";
     aNum14 = "";
     aNum15 = "";
     aNum16 = "";
     aNum17 = "";
     aNum18 = "";
     nNum4 = "";
     nNum6 = "";
     nNum7 = "";
     nNum8 = "";
     nNum9 = "";
     nNum10 = "";
     nNum11 = "";
     nNum12 = "";
     nNum13 = "";
     nNum14 = "";
     nNum15 = "";
     nNum16 = "";
     nNum17 = "";
     nNum18 = "";
     aFecha = "";
     aKey = "";
     fHoy = @;
     aDato = "";
|FIN;

|PROCESO Punto2Coma;
     aDato = "";
     aLon = aAlfa % A0;
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aCar = aAlfa % nPos;
          |SI aCar = ".";
               aCar = ",";
          |FINSI;
          aDato = aDato + aCar;
     |SIGUE;
     aAlfa = aDato;
|FPRC;

|PROCESO Graba;
     aAlfa = aAlfa + f;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO Sal;
     aFic = aPath + aNom + ".sal";
     |XABRE "WBC", aFic, nHandle;
     |SI FSalida ] 0;
          aAlfa = "USER=" + Usuario % 810;
          |HAZ Graba;

          aAlfa = "CONTENIDO=" + aPath + aNom + ".pdf";
          |HAZ Graba;

          aAlfa = "PORTADA=" + aPath + aNom + ".apo";
          |HAZ Graba;

          aAlfa = "NOTRANSFORM=1" + f;
          aAlfa = aAlfa + "WHATTODO=2" + f;
          aAlfa = aAlfa + "TIFF=0" + f;
          aAlfa = aAlfa + "TIF=0" + f;
          aAlfa = aAlfa + "FAX=" + f;
          aAlfa = aAlfa + "PDF=1" + f;
          |HAZ Graba;
          |XCIERRA nHandle;
     |SINO;
          aAlfa = "0000Error al crear fichero:" + aFic;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO Apo;
     fHoy = ~;
     aFecha = (fHoy % 102) + "/" + (fHoy % 402) + "/" + (fHoy % 704);
     |HORA aAlfa;
     aFecha = aFecha + " " + aAlfa;
     aKey = "51/" + aEmp + (#52#0 % 102) + (("000000" + #52#1) % -106);
     aNum4 = #52#6; |QBF aNum4; nNum4 = aNum4 % A0;
     aNum6 = #52#3; nNum6 = 6;
     aNum7 = "30." + (#52#0 % 102) + "." + (("000000" + #52#1) % -106); nNum7 = 12;
     aNum8 = (#52#2 % 102) + "/" + (#52#2 % 402) + "/" + (#52#2 % 704); nNum8 = 10;
     aNum9 = aEmp; nNum9 = 2;
     aNum11 = #24#18; |QBF aNum11; nNum11 = aNum11 % A0;
     aNum12 = #24#197; |QBF aNum12; nNum12 = aNum12 % A0;
     aNum13 = #81#1; |QBF aNum13; nNum13 = aNum13 % A0;
     aNum14 = "00"; nNum14 = 2;
     aAlfa = #52#26; |HAZ Punto2Coma;
     aNum15 = aAlfa; nNum15 = aNum15 % A0;
     aNum16 = aPago; nNum16 = 2;
     aNum17 = Usuario % 810; |QBF aNum15; nNum17 = aNum15 % A0;
     aNum18 = #52#19; |QBF aNum18; nNum18 = aNum18 % A0;

     aFic = aPath + aNom + ".apo";
     |XABRE "WBC", aFic, nHandle;
     |SI FSalida ] 0;
          aAlfa = "list";
          |HAZ Graba;

          aAlfa = "{";
          |HAZ Graba;

          aAlfa = "template(" + c + c + ");";
          |HAZ Graba;

          aAlfa = "doc_type(" + c + "PDF" + c + ");";
          |HAZ Graba;

          aAlfa = "type(" + c + "51" + c + ");"
          |HAZ Graba;

          aAlfa = "date(" + c + aFecha + c + ");";
          |HAZ Graba;

          aAlfa = " doc";
          |HAZ Graba;

          aAlfa = " {";
          |HAZ Graba;

          aAlfa = "      key(" + c + aKey + c + ");";
          |HAZ Graba;

          aAlfa = "      data";
          |HAZ Graba;

          aAlfa = "      {";
          |HAZ Graba;

          aAlfa = "           (1)(" + c + "30" + c + "," + c + "A" + c + "," + c + "2" + c + ");";
          |HAZ Graba;

          aAlfa = "           (2)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");"
          |HAZ Graba;

          aAlfa = "           (3)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");"
          |HAZ Graba;

          aAlfa = "           (4)(" + c + aNum4 + c + "," + c + "A" + c + "," + c + nNum4 + c +");";
          |HAZ Graba;

          aAlfa = "           (5)(" + c + c + "," + c + "A" + c + "," + c + "0" + c + ");"
          |HAZ Graba;

          aAlfa = "           (6)(" + c + aNum6 + c + "," + c + "A" + c + "," + c + nNum6 + c +");";
          |HAZ Graba;

          aAlfa = "           (7)(" + c + aNum7 + c + "," + c + "A" + c + "," + c + nNum7 + c +");";
          |HAZ Graba;

          aAlfa = "           (8)(" + c + aNum8 + c + "," + c + "A" + c + "," + c + nNum8 + c +");";
          |HAZ Graba;

          aAlfa = "           (9)(" + c + aNum9 + c + "," + c + "A" + c + "," + c + nNum9 + c +");";
          |HAZ Graba;

          aAlfa = "           (10)(" + c + aNum10 + c + "," + c + "A" + c + "," + c + nNum10 + c +");";
          |HAZ Graba;

          aAlfa = "           (11)(" + c + aNum11 + c + "," + c + "A" + c + "," + c + nNum11 + c +");";
          |HAZ Graba;

          aAlfa = "           (12)(" + c + aNum12 + c + "," + c + "A" + c + "," + c + nNum12 + c +");";
          |HAZ Graba;

          aAlfa = "           (13)(" + c + aNum13 + c + "," + c + "A" + c + "," + c + nNum13 + c +");";
          |HAZ Graba;

          aAlfa = "           (14)(" + c + aNum14 + c + "," + c + "A" + c + "," + c + nNum14 + c +");";
          |HAZ Graba;

          aAlfa = "           (15)(" + c + aNum15 + c + "," + c + "A" + c + "," + c + nNum15 + c +");";
          |HAZ Graba;

          aAlfa = "           (16)(" + c + aNum16 + c + "," + c + "A" + c + "," + c + nNum16 + c +");";
          |HAZ Graba;

          aAlfa = "           (17)(" + c + aNum17 + c + "," + c + "A" + c + "," + c + nNum17 + c +");";
          |HAZ Graba;

          aAlfa = "           (18)(" + c + aNum18 + c + "," + c + "A" + c + "," + c + nNum18 + c +");";
          |HAZ Graba;

          aAlfa = "      }";
          |HAZ Graba;

          aAlfa = " contents";
          |HAZ Graba;

          aAlfa = "      {";
          |HAZ Graba;

          aAlfa = "           1;";
          |HAZ Graba;

          aAlfa = "";
          |HAZ Graba;

          aAlfa = "      }";
          |HAZ Graba;

          aAlfa = " }";
          |HAZ Graba;

          aAlfa = "}";
          |HAZ Graba;

          |XCIERRA nHandle;
     |SINO;
          aAlfa = "0000Error al crear fichero:" + aFic;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO Imprime;
     |DDEFECTO #tagm0031;
     |PARA i = 0; |SI i [ 94; |HACIENDO i = i + 1;
          #tagm0031#i# = #tagm0053#i#;
     |SIGUE;
     |PRINT;
|FPRC;

|PROCESO Accesorios;
     |DDEFECTO #tagm0032;
     |PARA i = 0; |SI i [ 12; |HACIENDO i = i + 1;
          #tagm0032#i# = #tagm0054#i#;
     |SIGUE;

     |SI enSwImp = 1;
          enSwImp = 2; |PRINT;
          enSwImp = 3;
     |FINSI;
     |PRINT;
|FPRC;

|DEFBUCLE Accesorios;
     #54#1;
     ;
     #52#0, #52#1, 001;
     #52#0, #52#1, 999;
     ;
     NULL, Accesorios;
|FIN;

|PROCESO Impresion;
     aAlfa = "CrystalReport;" + aPath + aNom + ".pdf";

     enTipo = 2;  || Presupuesto
     Impresora = aAlfa;
     |IMPRE -1;
     |SI FSalida = 0;
          |DDEFECTO #tagm0030;
          |PARA i = 0; |SI i [ 23; |HACIENDO i = i + 1;
             #tagm0030#i# = #tagm0052#i#;
          |SIGUE;
          #tagm0030#29# = #tagm0052#26#; ||total

          |INFOR "tagm0030";
          |SI FSalida = 0;
               enSwImp = 1;
               |BUCLELIN 0 Imprime #52;
               |BUCLE Accesorios;
               |PIEINF;
               |FININF;
          |SINO;
               |MENAV "0000No existe informe 'tagm0030'";
          |FINSI;
          |FINIMP;
     |FINSI;
|FPRC;

|PROGRAMA;
     f = &13; f = f + &10;
     c = &34;
     aEmp = "30";

     |ABRE #87; |LEE 000#87p; |CIERRA #87;

     aPath = "c:\ds\item\";
     |RMKDIR aPath;

     |ABRE #52;
     #52#0 = eaSerBlc;
     #52#1 = enNumBlc;
     |LEE 020#52=;
     |SI FSalida = 0;
          aAno = #52#2 % 902;
          aNom = "R" + aEmp + (#52#0 % 102) + aAno + (("000000"+#52#1)%-106);

          |HAZ Impresion;

          |ABRE #24;
          #24#0 = #52#3;
          |LEE 000#24=;
          |CIERRA #24;

          |ABRE #84;
          #84#0 = #52#9;
          |LEE 000#84=;
          |CIERRA #84;

          |ABRE #81;
          #81#0 = #84#7;
          |LEE 000#81=;
          |CIERRA #81;

          |ABRE #90;
          #90#0 = #52#5;
          |LEE 000#90=;
          |SI FSalida = 0;
               aPago = "SI";
          |SINO;
               aPago = "NO";
          |FINSI;
          |CIERRA #90;

          |HAZ Apo;
          |HAZ Sal;

          aExe = #87#5; |QBF aExe;
          aExe = aExe + "jafsmb.exe " + aPath + aNom + ".sal";
          |RSYSTEM aExe;
     |FINSI;
     |CIERRA #52;
|FPRO;
