|FICHEROS;
     guerm215 #0;
     guerm216 #1,MANTE; || Tmp
     agifa019 #19;
     agifa024 #24;
     guerw058 #58,MANTE; || Tmp N§ Equipos
     agifa081 #81;
     agifa112 #112;
     gotrabaj #100;
     guerm200 #200; || parametros
     guerm201 #201; || Camion
     guerm202 #202; || Cli/obra
     guerm203 #203; || Conductores
     guerm204 #204; || Precio cli/obra/art
     guerm205 #205,MANTE; || Salida C
     guerm206 #206; || Salida L
     guerm207 #207;
     guerm210 #210; || Pedido
     guerm211 #211; || Pedido Lin
     guerm212 #212; || Horarios
     guerm214 #214; || Calendario
     guerm219 #219; || Asignados
     guerm220 #220; || Fichero Real Carga Orden Trabajo
     guerm225 #225,MANTE;
     guerm226 #226; || Parametros correo
     guerm216@ #1216;
     guerm201@;
     guerm203@;
     guerw058@ #1058;

|FIN;

|VARIABLES;
     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;
     nSigue = 0;
     nLinHis = 0;
     nSwIncluir = 0;
     fGuarda = @;
     aAct = "";
     aSerAsig = "";
     nNumAsig = 0;
     nLinAsig = 0;
     aDSub = "";
     aHSub = "";
     fFinal = @;
     &enCreaLineas = 0;
     &eaDHora = "";
     &eaHHora = "";
     &eaSerieTra = "";
     &enNumeroTra = 0;
     &enLineaTra = 0;
     &efFechaTra = 0;
     &eaProveTra = "";
     &EURODB = 0;
     &enSwMenu = 0;
     &eaSerie = "";
     &enNumero = 0;
     &Tempo = "";
     aAlfa = "";
     aTmp1 = "";
  {-1}aMenu = "";
     aMenu1 = "2400";
     aMenu2 = "1";
     aMenu3 = "Opciones: ";
     aMenu4 = "RACd";
     aMenu5 = " Repasar ";
     aMenu6 = " Aceptar ";
     aMenu7 = " Cancelar ";
     aMenu8 = " Listados ";

  {-1}aMenx = "";
     aMenx1 = "2400";
     aMenx2 = "1";
     aMenx3 = " ";
     aMenx4 = "MB";
     aMenx5 = " Modificar Salida ";
     aMenx6 = " Borrar Salida ";
     aMenx7 = " Cancelar ";

  {-1}aMenz = "";
     aMenz1 = "2400";
     aMenz2 = "1";
     aMenz3 = " ";
     aMenz4 = "RC";
     aMenz5 = " Repasar ";
     aMenz6 = " Continuar ";

  {-1}aLista = "";
     aLista1 = "2400";
     aLista2 = "1";
     aLista3 = "Opciones: ";
     aLista4 = "SR";
     aLista5 = " Sin Asignar ";
     aLista6 = " Reparto ";

     nHay = 0;
     nSwExiste = 0;
     nLin = 0;
     nModo = 0;
     nForma = 1;
     nTope = 0;
     fFecha = @;
     {-1}menu = "";
     menu1 = "2400";
     menu2 = "1";
     menu3 = "Contador:  ";
     menu4 = "AM";
     menu5 = " Automatico ";
     menu6 = " Manual ";
     nSalida = 0;
     nImpre = -1;
     nPrimeFax = 0;
     aDirDestino = "";
     aIP = "";
     aServidor = "";
     aFrom = "";
     aTo = "";
     aSubject = "";
     aMensaje = "";
     aDjunto = "";
     aFicMail = "";
     f = @;
     i = 0;
     ii = 0;
     nError = 0;
     fFin = @;
     aMatri = "";
     nDesde = 0;
     nHasta = 0;
     nFranja = 0;
     nConta = 0;
     aDef = "";
     nMaxFranja = 0;
     nIniFranja = 0;
     nVuelta = 0;
     nSalidas = 0;
     aTmp58 = "";
     nEquipos = 0;
     nSwCreaLin = 0;
     nDia = 0;
     nMes = 0;
     aTrabaja = "";
     aEquipo = "";
     nConductor = 0;
     nSw58 = 0;
     aDHora = "";
     aHHora = "";
     aAlfa1 = "";
     aAlfa2 = "";
     nNume = 0;
     nSwCheqAsig = 0;
     nD = 0;
     nH = 0;
     aSwLibre = "";
     aOcupado = "";
     aLaboral = "";
     nHora = 0;
     aHora = "";
     aHora1 = "";
     aHora2 = "";
     aGrabaTmp = "";
     nEstaLibre = 0;
|FIN;

|PROCESO SumaUno; ||Entra nHora, sale nHora+1
     aAlfa = ("0000" + nHora) % -104;
     aHora1 = aAlfa % 102;
     aHora2 = aAlfa % 302;
     nHora = aHora2 + 1;
     |SI nHora ] 60;
          aHora2 = "01";
          nHora = aHora1 + 1;
          aHora1 = ("00" + nHora) % -102;
     |SINO;
          aHora2 = ("00" + nHora) % -102;
     |FINSI;
     aHora1 = aHora1 + aHora2;
     nHora = aHora1;
|FPRC;


|PROCESO Imprime;
     |PRINT;
|FPRC;

|PROCESO EnviaFax;
     |SI #1#29 ! "S";
          |ACABA;
     |FINSI;
     |SI #1#21 = "S";
          |SI nPrimeFax = 0;
               nPrimeFax = 1;
               |IMPRE 0;
               nImpre = FSalida;
               |SI FSalida ! 0;
                    |ERROR10; |ACABA;
               |FINSI;
          |FINSI;

          |INFOR "guerm205";
          |SI FSalida ! 0;
               |ERROR10;
          |SINO;
               #205#0 = #1#27;
               |LEE 000#205=;
               |BUCLELIN 2 Imprime #205;
               |PIEINF;
               |FININF;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE EnviaFax;
     #1#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, EnviaFax;
|FIN;

|PROCESO EnviaMail;
     |SI #1#29 ! "S"; |O #1#35 = "S";
          |ACABA;
     |FINSI;

     || asigno los campos que se imprimen  en el informe
     |PARA i = 0; |SI i [ 28; |HACIENDO i = i + 1;
          #220i = #1i;
     |SIGUE;
     #220#29 = #0#0;
     #220#30 = #1#29;
     #220#31 = #1#30;
     #220#32 = #1#31;
     #220#33 = #1#32;
     #220#35 = #1#33;
     #220#36 = #1#34;
     #220#37 = #1#35;
     #220#38 = #1#36;

     |SI #1#20 = "S";
          |DFICE aAlfa;
          aFicMail = aAlfa + "salida_" + #1#27 + ".txt";
          Impresora = aFicMail;
          |IMPRE -77;
          |SI FSalida ! 0; |ACABA; |FINSI;
          |INFOR "guerm215";
          |SI FSalida ! 0; |FINIMP; |ACABA; |FINSI;

          #205#0 = #1#27;
          |LEE 000#205=;
          |BUCLELIN 2 Imprime #205;
          |PIEINF;
          |FININF;
          |FINIMP;

          |DDEFECTO #201;
          #201#0 = #1#17;
          |LEE 000#201=;

          |SI #1#24 = "S";  ||Subcontratado
               |DDEFECTO #112;
               #112#0 = #1#28;
               |LEE 000#112=;
               aDirDestino = #112#84;   || mail proveedor

               |DDEFECTO #203;
               #203#0 = #1#30;
               |LEE 000#203=;
               |SI #203#5 = "S";
                    aDirDestino = #203#6;
               |FINSI;
          |SINO;
               |DDEFECTO #100;
               #100#0 = #1#30;
               |LEE 000#100=;
               aDirDestino = #100#127;  || mail trabajador
          |FINSI;

          ||aFrom = #226#4; |QBF aFrom; || R.PRIEGO: lo dejo como antes y
                                        || solamente se parametriza
                                        || la IP  el servidor
          ||aServidor = "asmtp.diagram.es";
          ||aIP = "xdscorreo.dv.diagram.net";

          aFrom = aDirDestino;
          aServidor = #226#3; |QBF aServidor;
          |SI #226#1 = "F"; aIP = #226#2; |FINSI;
          |SI #226#1 = "L"; |IP_REMOTO aIP; |FINSI;
          |SI #226#1 = "S"; |IP_LOCAL aIP; |FINSI;
          |QBF aIP;

          aTo = aDirDestino;
          aSubject = "Salida nº:" + #1#27;
          aMensaje = "$$$$" + aFicMail;
          aDjunto = aFicMail;
          |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
          |SI FSalida < 0;
               aAlfa = "Salida nº " + (("000000" + #1#27) % -106);
               aAlfa = "0000Error al enviar correo:" + &13 + aAlfa;
               |MENAV aAlfa;
          |SINO;
               #1#35 = "S";    || Mail enviado
               |GRABA 020#1a;
          |FINSI;
          |FBORRA aFicMail;
     |FINSI;
     |LIBERA #1;
|FPRC;

|DEFBUCLE EnviaMail;
     #1#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, EnviaMail;
|FIN;

|PROCESO EstaTodo;
     FSalida = 1;
     aAlfa = #1#17; |QBF aAlfa;
     |SI aAlfa = ""; |ACABA; |FINSI;              || sin equipo
     |SI #1#30 = 0; |ACABA; |FINSI;               || sin conductor
     |SI #1#14 = 0; |Y #1#15 = 0; |ACABA; |FINSI; || sin horario
     |SI #1#29 =  "S"; |ACABA; |FINSI;            || actualizada
     FSalida = 0;
|FPRC;

|PROCESO CreaSalida;
     |HAZ EstaTodo;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |DDEFECTO #19;
     #19#0 = #1#7;
     |LEE 000#19=;

     |DDEFECTO #24;
     #24#0 = #1#5;
     |LEE 000#24=;

     |DDEFECTO #201;
     #201#0 = #1#17;
     |LEE 000#201=;

     enTiva = #19#30;
     efFiva = #0#0;
     |HAZ SacaIVA;

     |DDEFECTO #207;
     #207#0 = #1#4;
     |LEE 000#207=;

     |DDEFECTO #203;
     #203#0 = #1#30;
     |LEE 000#203=;

/**************************** ultimo+1
     |LEE 000#205u;
     |SI FSalida = 0;
          nSalida = #205#0 + 1;
     |SINO;
          nSalida = 1;
     |FINSI;
*****************************/
     nSalida = #200#35;
     |SI nSalida = 0; nSalida = 1; |FINSI;
     |PARA FSalida = 0; |SI FSalida = 0; |HACIENDO;
          #205#0 = nSalida;
          |LEE 000#205=;
          |SI FSalida = 0; nSalida = nSalida + 1; |FINSI;
     |SIGUE;
     |SI nSalida > 999999;
          |MENAV "0000Superado contador de salidas, no se crea";
          |ACABA;
     |FINSI;
     #200#35 = nSalida + 1;

     |DDEFECTO #205;
     #205#0 = nSalida;
     |GRABA 020#205b;
     |SI FSalida = 0;
          #205#1 = #0#0;
          #205#2 = #1#14;
          #205#3 = #1#5;
          #205#4 = #1#6;
          #205#5 = #24#5;
          #205#6 = #24#178;
          #205#7 = #24#179;
          #205#8 = #24#7;
          #205#9 = #24#6;
          #205#10 = #24#15;
          #205#11 = #201#0;
          #205#12 = #201#1;
          #205#13 = #201#2;
          #205#31 = #203#0;
          #205#32 = #203#1;

          #205#14 = enIva;
          #205#19 = #1#10;
          #205#20 = 1;

          #205#21 = 0;
          #205#22 = 0;
          #205#23 = 0;
          #205#24 = 0;

          #205#25 = 1;
          #205#29 = #1#23;
          #205#30 = #1#26;

          #205#47 = "S";
          #205#48 = #1#0;
          #205#49 = #1#1;
          #205#50 = #1#4;
          #205#53 = #207#11; ||"P";    ||#1#32;
          #205#54 = #1#2;

          #206#1 = #205#0;
          #206#0 = 1;
          #206#2 = #1#7;
          #206#3 = #1#8;
          #206#4 = #1#10;
          #206#5 = #1#11;  ||Precio
          #206#7 = #1#10;  ||Unidades
          #206#8 = #1#22;
          #206#6 = (#206#7 * #206#5) < #206#8;
          #206#9 = #1#36;
          |GRABA 020#206n;

          #205#33 = #205#33 + #206#7;
          #205#34 = #205#34 + #206#7;
          #205#56 = #205#56 + (#206#7 * #206#9);

          #205#20 = #206#6;
          #205#22 = #205#20 - #205#21;
          #205#23 = ((#205#22 * #205#14) / 100) ! EURODB;
          #205#24 = #205#22 + #205#23;
          |GRABA 020#205a;
          |LIBERA #205;

          #1#27 = #205#0;
          #1#29 = "S";
          |GRABA 020#1a;

          nSalidas = nSalidas + 1;
     |FINSI;
     |LIBERA #1;
|FPRC;

|DEFBUCLE CreaSalida;
     #1#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, CreaSalida;
|FIN;

|PROCESO Actualiza;
     |ABRE #203;
     |ABRE #205;
     |ABRE #206;
     |ABRE #19;
     |ABRE #24;
     |ABRE #201;
     |ABRE #200;
     |ABRE #207;
     |LEE 101#200=;
     |SI FSalida ! 0; |GRABA 020#200b; |FINSI;
     |BUCLE CreaSalida;
     |GRABA 020#200a;
     |CIERRA #207;
     |CIERRA #200;

     |BUCLE EnviaFax;
     |SI nImpre = 0; |FINIMP; |FINSI;
     |ABRE #203;
     |ABRE #112;
     |ABRE #100;
     |ABRE #220;
     |BUCLE EnviaMail;
     |CIERRA #220;
     |CIERRA #100;
     |CIERRA #112;
     |CIERRA #203;
     |CIERRA #201;
     |CIERRA #24;
     |CIERRA #19;
     |CIERRA #205;
     |CIERRA #206;
     |CIERRA #203;

     aAlfa = "0000Creadas " + nSalidas + " salidas.";
     |MENAV aAlfa;
|FPRC;

|PROCESO CheqAsigna;
     |SI #1#29 = "N";
          |HAZ EstaTodo;
          |SI FSalida ! 0; nSwCheqAsig = nSwCheqAsig + 1; |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE CheqAsigna;
     #1#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, CheqAsigna;
|FIN;

|PROCESO PedidoSub;
     |SI #1#24 = "N";
          |ACABA;
     |FINSI;
     |ABRE #81;
     #81#25 = #1#18;
     #81#0 = #1#19;
     |LEE 000#81=;
     |SI FSalida ! 0;
          |CONFI "0000SCrear Pedido de Subcontrata?";
          |SI FSalida = 0;
               |MENU menu;
               |SI FSalida = 1;
                    enSwMenu = 1;
                    |HAZ ContaPC7;
                    #1#19 = #81#0; |PINTA #1#19;
               |FINSI;
               enNumero = #1#19;
               eaSerie = #1#18;
               eaSerieTra = #1#0;
               enNumeroTra = #1#1;
               enLineaTra = #1#2;
               efFechaTra = #0#0;
               eaProveTra = #1#28;
               enCreaLineas = 1;
               |SUB_EJECUTA_NP "guerm217";
               eaSerieTra = "";
               |SI enNumero = 0;
                    |ERROR;
               |SINO;
                    #1#19 = enNumero;
                    |PINTA #1#19;
               |FINSI;
          |SINO;
               |ERROR;
          |FINSI;
     |FINSI;
     |CIERRA #81;
|FPRC;

|PROCESO Act219;
     |HAZ EstaTodo;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #203;
     #203#0 = #1#30;
     |LEE 000#203=;
     |CIERRA #203;

     |DDEFECTO #214;
     |ABRE #214;
     #214#0 = #203#2;
     #214#13 = #203#3;
     |LEE 000#214=;
     |CIERRA #214;

     |ABRE #219;
     |PARA f = #0#0; |SI f [ #1#13; |HACIENDO f = f + 1;
          aAlfa = f % 102; nDia = aAlfa;
          aAlfa = f % 402; nMes = aAlfa;
          aAlfa = #214nMes;
          nDia = nDia * 100 + 1;
          aTrabaja = aAlfa % nDia;
          |SI aTrabaja = 0;
               |SI nForma = 1;
                    #219#0 = #1#17;
                    #219#1 = f;
                    #219#2 = 99;
                    |LEE 000#219];
                    |SI FSalida = 0;
                         |LEE 000#219a;
                    |SINO;
                         |LEE 000#219u;
                    |FINSI;
                    |SI FSalida = 0; |Y #219#0 = #1#17; |Y #219#1 = f;
                         nLin = #219#2 + 1;
                    |SINO;
                         nLin = 1;
                    |FINSI;
                    |DDEFECTO #219;
                    #219#0 = #1#17;
                    #219#1 = f;
                    #219#2 = nLin;
                    #219#3 = #1#14;
                    #219#4 = #1#15;
                    #219#5 = #1#0;
                    #219#6 = #1#1;
                    #219#7 = #1#2;
                    #219#8 = #1#30;

                    #219#9 = #1#24;
                    #219#10 = #1#28;
                    #219#11 = #1#21;
                    #219#12 = #1#20;
                    #219#13 = #1#31;
                    #219#14 = #1#3;
                    |GRABA 020#219n;
               |SINO;
                    |SELECT #2#219;
                    #219#0 = #1#17;
                    #219#1 = f;
                    #219#3 = #1#14;
                    #219#4 = #1#15;
                    |BORRA 020#219c;
               |FINSI;
          |FINSI;
     |SIGUE;
     |CIERRA #219;
|FPRC;

|PROCESO BorraSalida;
     |PUSHV 0501 2380;
     |ABRE #205;
     #205#0 = #1#27;
     |LEE 101#205=;
     |SI FSalida = 0;
          |BUCLELIN 1 NULL #205;
     |FINSI;
     |CIERRA #205;
     #1#27 = 0;
     #1#29 = "N";
     |GRABA 020#1a;
     |POPV;
|FPRC;

|PROCESO ModiSalida;
     |PUSHV 0101 2380;
     |ABRE #205;
     #205#0 = #1#27;
     |LEE 121#205=;
     |SI FSalida = 0;
          |PINPA #0#205;
          |PINDA #0#205;
          |ENDATOS #2#205;
          |SI FSalida = 0;
               |GRABA 020#205a;
          |FINSI;
     |FINSI;
     |CIERRA #205;
     |POPV;
|FPRC;

|PROCESO CopiaHisto;
     |ABRE #203;
     #203#0 = #1#30;
     |LEE 000#203=;
     |CIERRA #203;

     |DDEFECTO #214;
     |ABRE #214;
     #214#0 = #203#2;
     #214#13 = #203#3;
     |LEE 000#214=;
     |CIERRA #214;

     |ABRE #220;
     f = #1#12 + 1;
     |PARA; |SI f [ #1#13; |HACIENDO f = f + 1;
          aAlfa = f % 102; nDia = aAlfa;
          aAlfa = f % 402; nMes = aAlfa;
          aAlfa = #214nMes;
          nDia = nDia * 100 + 1;
          aTrabaja = aAlfa % nDia;
          |SI aTrabaja = 0;
               fGuarda = #0#0;
               #0#0 = f;
               |HAZ CopiaReal;
               #0#0 = fGuarda;
          |FINSI;
     |SIGUE;
     |CIERRA #220;
|FPRC;

|PROCESO TmpEquipo;
     |SI nVuelta = 0;    || la 1§  es la linea actual
          #1#16 = 1;  || Equipos
          #1#25 = 0;
          #1#17 = #58#4;
          #1#30 = #58#6;
          #1#24 = #58#8;
          #1#14 = #58#9;
          #1#15 = #58#10;
          |SI #1#24 = "N";
               #1#28 = "";
          |FINSI;
          |SI #1#24 = "S";
               |ABRE #201;
               #201#0 = #1#17;
               |LEE 020#201=;
               |CIERRA #201;
               |DDEFECTO #225;
               |ABRE #225;
               #225#0 = #201#12;
               #225#6 = #1#5;
               #225#1 = #1#33;
               #225#3 = #1#7;
               |LEE 020#225=;
               |CIERRA #225;
               #1#28 = #201#12;
               #1#36 = #225#5;
          |FINSI;
          |GRABA 020#1a;
     |SINO;
          #guerm216@#0 = #1#0;
          #guerm216@#1 = #1#1;
          #guerm216@#2 = #1#2;
          #guerm216@#3 = 999;
          |LEE 000#guerm216@.];
          |SI FSalida = 0;
               |LEE 000#guerm216@.a;
          |SINO;
               |LEE 000#guerm216@.u;
          |FINSI;
          |SI FSalida = 0; |Y #guerm216@#0 = #1#0; |Y #guerm216@#1 = #1#1;
                    |Y #guerm216@#2 = #1#2;
               nLin = #guerm216@#3 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          || Lo hago del historico !!!
          |ABRE #220;
          #220#29 = #0#0;
          #220#0 = #1#0;
          #220#1 = #1#1;
          #220#2 = #1#2;
          #220#3 = 999;
          |LEE 000#220.];
          |SI FSalida = 0;
               |LEE 000#220.a;
          |SINO;
               |LEE 000#220.u;
          |FINSI;
          |SI FSalida = 0; |Y #220#0 = #1#0; |Y #220#1 = #1#1;
                    |Y #220#2 = #1#2; |Y #220#29 = #0#0;
               nLinHis = #220#3 + 1;
          |SINO;
               nLinHis = 1;
          |FINSI;
          |CIERRA #220;

          |SI nLin < nLinHis; nLin = nLinHis; |FINSI;

          |SALVA_DATOS #1;
          |REPON_DATOS #guerm216@;
          #guerm216@#3 = nLin;
          #guerm216@#16 = 1;     || Equipos
          #guerm216@#25 = #1#3;  || Linea nueva
          #guerm216@#17 = #58#4; || Equipo
          #guerm216@#30 = #58#6; || Conductor
          #guerm216@#24 = #58#8; || Subcontratado
          #guerm216@#12 = #0#0;
          #guerm216@#14 = #58#9;
          #guerm216@#15 = #58#10;
          |SI #guerm216@#24 = "N";
               #guerm216@#28 = "";
          |FINSI;

          #203#0 = #guerm216@#30;
          |LEE 020#203=;
          #guerm216@#20 = #203#4;  || Envia Mail

          |SI #guerm216@#24 = "S";
               |ABRE #201;
               #201#0 = #guerm216@#17;
               |LEE 020#201=;
               |CIERRA #201;
               |DDEFECTO #225;
               |ABRE #225;
               #225#0 = #201#12;
               #225#6 = #guerm216@#5;
               #225#1 = #guerm216@#33;
               #225#3 = #guerm216@#7;
               |LEE 020#225=;
               |CIERRA #225;
               #guerm216@#28 = #201#12;
               #guerm216@#36 = #225#5;
          |FINSI;
          |GRABA 020#guerm216@.n;

          |SALVA_DATOS #1;
          |SALVA_DATOS #guerm216@;
          |REPON_DATOS #1;

          |HAZ Act219;
          |HAZ CopiaHisto;

          |REPON_DATOS #1;
     |FINSI;
     nVuelta = nVuelta + 1;
     |BORRA 020#58a;
|FPRC;

|DEFBUCLE TmpEquipo;
     #58#1;
     ;
     #1#0, #1#1, #1#2, 001;
     #1#0, #1#1, #1#2, 999;
     ;
     NULL, TmpEquipo;
|FIN;

|PROCESO CreaNuevaLin;
     |DDEF aAlfa;
     aAlfa = aAlfa + "guerm216";
     |CARGA_DEF aAlfa, guerm216@;
     |SI FSalida = 0;
          |NOME_DAT #guerm216@#aTmp1#;
          |ABRE #guerm216@;
          nVuelta = 0;
          |ABRE #203;
          |BUCLE TmpEquipo;
          |CIERRA #203;
          |CIERRA #guerm216@;
          |DESCARGA_DEF #guerm216@;
     |FINSI;
|FPRC;

|PROCESO Tipo2; |TIPO 2;
     nModo = (FEntrada / 100) ! 0;
     nForma = 0 +. 1;

     #1#35 = "N"; || Mail enviado
     |PINTA #1#35;

     |SI nModo = 3; ||Igual que excluir
          |DDEFECTO #220;
          |ABRE #220;
          #220#0 = #1#0;
          #220#1 = #1#1;
          #220#2 = #1#2;
          #220#3 = #1#3;
          #220#29 = #0#0;
          |LEE 101#220=;
          |SI FSalida ! 0; |GRABA 020#220b; |FINSI;
          |PARA i = 4; |SI i [ 28; |HACIENDO i = i + 1;
               #220i = #1i;
          |SIGUE;
          #220#30 = #1#29;
          #220#31 = #1#30;
          #220#32 = #1#31;
          #220#33 = #1#32;
          #220#34 = "S"; || Excluida
          #220#35 = #1#33;
          #220#36 = #1#34;
          #220#38 = #1#36;
          |GRABA 020#220a;
          |SI FSalida = 0;
               #1#13 = #0#0;  || Para que solo excluya el dia actual
               |HAZ Act219;
          |FINSI;
          |CIERRA #220;
          |ACABA;
     |FINSI;

     |SI #1#29 = "S";
          |SI nForma = -1;
               |MENAV "0000Orden con salida efectuada....";
               |MENU aMenx;
               |SI FSalida ! 1; |Y FSalida ! 2;
                    |ERROR; |ACABA;
               |FINSI;
               |SI FSalida = 1;
                    |HAZ ModiSalida;
                    |GRABA 020#1a;
                    |ERROR; |ACABA;
               |FINSI;
               |SI FSalida = 2;
                    |HAZ BorraSalida;
                    |GRABA 020#1a;
                    |SI nModo ! 3;
                         |ERROR; |ACABA;
                    |FINSI;
               |FINSI;
          |SINO;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     |SI nModo = 2; |Y #1#24 = "N";
          |ABRE #211;
          #211#0 = #1#0;
          #211#1 = #1#1;
          #211#2 = #1#2;
          |LEE 000#211=;
          |SI FSalida = 0;
               #1#36 = #211#19;
               |PINTA #1#36;
          |FINSI;
          |CIERRA #211;
     |FINSI;

     |HAZ CreaNuevaLin;
     |SI nVuelta ! 0;
          |PONCONTROL 23, "SI";
          |PTEC 808;
     |FINSI;

     |HAZ Act219;
|FPRC;

|PROCESO PeriFecha; |TIPO 0;
|FPRC;

|PROCESO PeriHora; |TIPO 0;
|FPRC;

|PROCESO CuentaEquipo;
     nEquipos = nEquipos + 1;
     |SI nEquipos = 1;
          #1#17 = #58#4;
          #1#14 = #58#9;
          #1#15 = #58#10;
          #1#30 = #58#6;
          |PINTA #1#17;
          |PINTA #1#30;
     |FINSI;
|FPRC;

|DEFBUCLE CuentaEquipo;
     #58#1;
     ;
     #1#0, #1#1, #1#2, 01;
     #1#0, #1#1, #1#2, 99;
     ;
     NULL, CuentaEquipo;
|FIN;

|PROCESO Min58;
     #58#0 = #1#0;
     #58#1 = #1#1;
     #58#2 = #1#2;
     #58#3 = 01;
|FPRC;

|PROCESO Max58;
     #58#0 = #1#0;
     #58#1 = #1#1;
     #58#2 = #1#2;
     #58#3 = 99;
|FPRC;

|PROCESO Nequipo; |TIPO 0;
     |SI #1#24 = "M"; |Y #1#16 [ 1;
          |MENAV "0000El numero de Equipos debe se superior a 1";
          |ERROR;
          |ACABA;
     |FINSI;
     |C_M #1#17, 1, "S";
     |C_M #1#30, 1, "S";
     |SI #1#16 > 1; |Y FSalida = 0;
          |C_M #1#17, 1, "N";
          |C_M #1#30, 1, "N";
          |PUSHV 05012380;
          |ENTLINEAL #1#58, 4, 2, 22, 1, Min58, Max58;
          |POPV;
          nEquipos = 0;
          |BUCLE CuentaEquipo;
          |SI nEquipos ! #1#16;
               aAlfa = "0000El numero de equipos ha cambiado...";
               |MENAV aAlfa;
               #1#16 = nEquipos; |PINTA #1#16;
          |FINSI;
          |SI #1#16 = 0;
               #1#16 = 1; |PINTA #1#16;
               |C_M #1#17, 1, "S";
               |C_M #1#30, 1, "S";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ViaUni; |TIPO 0;
|FPRC;

|PROCESO EstaOcupado;
     nHora = #1#14; |HAZ SumaUno;
     |SI #1#15 ] #219#3; |Y nHora [ #219#4;
          aOcupado = "S";
          aSerAsig = #219#5;
          nNumAsig = #219#6;
          nLinAsig = #219#7;
     |FINSI;
|FPRC;

|DEFBUCLE EquipoOcupado;
     #219#1;
     ;
     aEquipo, fFecha, 01;
     aEquipo, fFecha, 99;
     ;
     NULL, EstaOcupado;
|FIN;

|PROCESO EquipoLibre;
     aSwLibre = "N";
     |SI #1#24 = "S";
          aLaboral = "S";
     |SINO;
          aOcupado = "N";
          |PARA fFecha = #0#0; |SI fFecha [ #1#13; |HACIENDO fFecha = fFecha + 1;
               aEquipo = #201#0;
               |BUCLE EquipoOcupado;
          |SIGUE;
          |SI aOcupado = "S"; |ACABA; |FINSI;

          |DDEFECTO #212;
          |ABRE #212;
          #212#0 = #201#10;
          |LEE 000#212=;      || Horarios
          |CIERRA #212;

          aLaboral = "N";
          |PARA i = 1; |SI i [ 59; |HACIENDO i = i + 2;
               ii = i + 1;
               nDesde = #212i;
               nHasta = #212ii;
               |SI nDesde > 0; |Y nHasta > 0;
                    |SI #1#15 ] nDesde; |Y #1#14 [ nHasta;
                         aLaboral = "S";
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI aGrabaTmp = "S";
          |SI aLaboral = "N"; |ACABA; |FINSI;
     |SINO;
     ||     |MENAV "0000Franja horaria incorrecta...";
     |FINSI;

     aSwLibre = "S";
     |SI nSw58 = 1; |Y #1#24 = "N";
          |DDEF aAlfa;
          aAlfa = aAlfa + "guerw058";
          |CARGA_DEF aAlfa, guerw058@;
          |SI FSalida = 0;
               |NOME_DAT #guerw058@#aTmp58#;
               |ABRE #guerw058@; |SELECT #2#guerw058@;
               #guerw058@#0 = #1#0;
               #guerw058@#1 = #1#1;
               #guerw058@#2 = #1#2;
               #guerw058@#4 = #201#0;
               |LEE 000#guerw058@.=;
               |SI FSalida = 0; aSwLibre = "N"; |FINSI;
               |CIERRA #guerw058@;
               |DESCARGA_DEF #guerw058@;
          |FINSI;
     |FINSI;
     |SI aSwLibre = "S"; |Y aGrabaTmp = "S";
          |SALVA_DATOS #201;
          |REPON_DATOS #guerm201@;
          |GRABA 020#guerm201@.n;
     |FINSI;
|FPRC;

|DEFBUCLE EquipoLibre;
     #201#1;
     11;
     "        ", aDSub;
     "zzzzzzzz", aHSub;
     ;
     NULL, EquipoLibre;
|FIN;

|PROCESO Equipo58_66; |TIPO 66;
     nSw58 = 1;
     |SALVA_DATOS #1;
     #1#17 = #58#4;
     #1#14 = #58#9;
     #1#15 = #58#10;
     #1#30 = #58#6;
     |HAZ Equipo66;
     |REPON_DATOS #1;
     nSw58 = 0;
|FPRC;

|PROCESO Equipo66; |TIPO 66;
     |DDEF aDef;
     aDef = aDef + "guerm201";
     |CARGA_DEF aDef, guerm201@;
     |SI FSalida = 0;
          |HAZ CreaTempo; |NOME_DAT #guerm201@#Tempo#;
          |DELINDEX #guerm201@;
          |ABRE #guerm201@;
          aGrabaTmp = "S";
          |SI #1#24 = "M";
               aDSub = " ";
               aHSub = "z";
          |SINO;
               aDSub = #1#24;
               aHSub = #1#24;
          |FINSI;
          |BUCLE EquipoLibre;
          |LEE 000#guerm201@.p;
          |CONSULTA_CLAVE #1#guerm201@;
          |SI FSalida ! 0;
               |ERROR;
          |SINO;
               |SI nSw58 = 1;
                    #58#4 = #guerm201@#0;
                    #58#6 = #guerm201@#8;
                    #58#8 = #guerm201@#11;
                    |PINTA #58#4;
                    |PINTA #58#8;
               |SINO;
                    #1#17 = #guerm201@#0;
                    #1#30 = #guerm201@#8;
                    |PINTA #1#17;
               |FINSI;
          |FINSI;
          |CIERRA #guerm201@;
          |DELINDEX #guerm201@;
          |HAZ BoraTempo;
          |DESCARGA_DEF #guerm201@;
     |FINSI;
|FPRC;

|PROCESO Equipo58_0; |TIPO 0;
     |ABRE #201;
     #201#0 = #58#4;
     |LEE 020#201=;
     |CIERRA #201;
     |SI #1#24 = "M";
          #58#8 = #201#11;
     |SINO;
          #58#8 = #1#24;
     |FINSI;
     |PINTA #58#8;

     |SI #58Campo ! Contenido;
          #58#6 = #201#8; |PINTA #58#6;
     |FINSI;

     |SALVA_DATOS #1;
     #1#17 = #58#4;
     #1#14 = #58#9;
     #1#15 = #58#10;
     #1#24 = #58#8;
     |HAZ Equipo0;
     |SI aSwLibre = "S"; |Y #58#8 = "S";
          |HAZ AltaArtPrvObra;
     |FINSI;
     |SI aSwLibre = "S"; |Y #58#8 = "N";
          |DDEF aAlfa;
          aAlfa = aAlfa + "guerw058";
          |CARGA_DEF aAlfa, guerw058@;
          |SI FSalida = 0;
               |NOME_DAT #guerw058@#aTmp58#;
               |ABRE #guerw058@; |SELECT #2#guerw058@;
               #guerw058@#0 = #1#0;
               #guerw058@#1 = #1#1;
               #guerw058@#2 = #1#2;
               #guerw058@#4 = #58#4;
               #guerw058@#8 = "N";
               |LEE 000#guerw058@.];
               |PARA; |SI FSalida = 0; |Y #guerw058@#0 = #1#0; |Y #guerw058@#1 = #1#1;
                         |Y #guerw058@#2 = #1#2; |Y #guerw058@#8 = "N"; |HACIENDO;
                    |SI #guerw058@#3 ! #58#3; |Y #guerw058@#4 = #58#4;
                         |MENAV "0000El equipo no esta libre...";
                         |ERROR; |SAL;
                    |FINSI;
                    |LEE 000#guerw058@.s;
               |SIGUE;
               |CIERRA #guerw058@;
               |DESCARGA_DEF #guerw058@;
          |FINSI;
     |FINSI;
     |REPON_DATOS #1;
|FPRC;

|PROCESO CheckBaja220;
     |SI #220#30 = "S";
          aAlfa = "0000Carga :" + #220#29 + " actualizada...";
          |MENAV aAlfa;
          aAct = "S";
     |FINSI;
|FPRC;

|DEFBUCLE CheckBaja220;
     #220#1;
     17;
     #0#0,        aSerAsig, nNumAsig, nLinAsig, 001, #1#17;
     "31.12.999", aSerAsig, nNumAsig, nLinAsig, 001, #1#17;
     ;
     NULL, CheckBaja220;
|FIN;

|PROCESO BajaReasig220;
     #220#17 = "";
     #220#31 = "";
     |GRABA 020#220a;
|FPRC;

|DEFBUCLE BajaReasig220;
     #220#1;
     17;
     #0#0,         aSerAsig, nNumAsig, nLinAsig, 001, #1#17;
     "31.12.9999", aSerAsig, nNumAsig, nLinAsig, 001, #1#17;
     be;
     NULL, BajaReasig220;
|FIN;

|PROCESO BajaReasig219;
     |BORRA 020#219a;
|FPRC;

|DEFBUCLE BajaReasig219;
     #219#3;
     0;
     #0#0,         aSerAsig, nNumAsig, nLinAsig, 0,  #1#17;
     "31.12.9999", aSerAsig, nNumAsig, nLinAsig, 999,#1#17;
     be;
     NULL, BajaReasig219;
|FIN;

|PROCESO BajaReasig216;
     #guerm216@#17 = "";
     #guerm216@#30 = "";
     |GRABA 020#guerm216@.a;
     |LIBERA #guerm216;
|FPRC;

|DEFBUCLE BajaReasig216;
     #guerm216@#1004;
     17;
     aSerAsig, nNumAsig, nLinAsig, 001, #1#17;
     aSerAsig, nNumAsig, nLinAsig, 999, #1#17;
     be;
     NULL, BajaReasig216;
|FIN;

|PROCESO BajaReasigna;
     aAct = "N";
     |BUCLE CheckBaja220;
     |SI aAct = "S";
          |MENAV "0000Reasignacion cancelada.";
     |SINO;
          |DDEF aAlfa; aAlfa = aAlfa + "guerm216";
          |CARGA_DEF aAlfa, guerm216@
          |SI FSalida = 0;
               |NOME_DAT #guerm216@#aTmp1#;
               |BUCLE BajaReasig216;
               |DESCARGA_DEF #guerm216@;
          |FINSI;
          |BUCLE BajaReasig219;
          |BUCLE BajaReasig220;
     |FINSI;
|FPRC;

|PROCESO Equipo0; |TIPO 0;
     |SI FSalida = 2; |ACABA; |FINSI;

     aSwLibre = "N";

     |ABRE #201;
     #201#0 = #1#17;
     |LEE 000#201=;
     |SI FSalida ! 0;
          |MENAV "0000No existe Equipo...";
          |ERROR; |ACABA;
     |SINO;
          |SI #201#11 = "S"; |Y #1#24 = "N";
               |MENAV "0000Equipo subcontratrado...";
               |ERROR; |ACABA;
          |FINSI;
          |SI #201#11 = "N"; |Y #1#24 = "S";
               |MENAV "0000El Equipo no esta subcontratrado...";
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;
     |CIERRA #201;

     aEquipo = #201#0;
     aGrabaTmp = "N";
     |HAZ EquipoLibre;
     |SI aSwLibre = "N";
          |MENAV "0000El equipo no esta libre...";
          FSalida = 0;
          |SI aOcupado = "S";
               aAlfa = "0000NEquipo Asignado al pedido:" + aSerAsig + "/" + (("000000" + nNumAsig) % -106);
               aAlfa = aAlfa + &13 + "¿Reasignar Equipo?";
               |CONFI aAlfa;
          |FINSI;
          |SI FSalida ! 0;
               |ERROR; |ACABA;
          |SINO;
               |HAZ BajaReasigna;
               |SI aAct = "S"; |ERROR; |ACABA; |FINSI;
          |FINSI;
     |FINSI;

     |SI #1Campo ! Contenido;
          #1#30 = #201#8; |PINTA #1#30;

          |ABRE #201;
          |ABRE #203;
          |HAZ CargaMail; |PINTA #1#20;
          |CIERRA #201;
          |CIERRA #203;
     |FINSI;

     |SI #1#24 = "S"; |Y #201#12 ! #1#28;
          aAlfa = "0000Equipo subcontratado a:" + #201#12;
          |MENAV aAlfa;
     |FINSI;

|FPRC;

|DEFBUCLE ConductorOcupado;
     #219#1;
     8;
     "        ", fFecha, 01, nConductor;
     "zzzzzzzz", fFecha, 09, nConductor;
     ;
     NULL, EstaOcupado;
|FIN;

|PROCESO ConductorLibre;
     aSwLibre = "N";
     aOcupado = "N";

     |DDEFECTO #214;
     |ABRE #214;
     #214#0 = #203#2;
     #214#13 = #203#3;
     |LEE 000#214=;
     |CIERRA #214;

     |SI #1#24 = "N";
          || calendario
          |SI #1#9 = "D";
               fFinal = #0#0; ||Solo comprueba el 1§ dia
          |SINO;
               fFinal = #1#13;
          |FINSI;
          |PARA f = #0#0; |SI f [ fFinal; |HACIENDO f = f + 1;
               aAlfa = f % 102; nDia = aAlfa;
               aAlfa = f % 402; nMes = aAlfa;
               aAlfa = #214nMes;
               nDia = nDia * 100 + 1;
               aTrabaja = aAlfa % nDia;
               |SI aTrabaja = 1; |SAL; |FINSI;
          |SIGUE;
          |SI aTrabaja = 1; |ACABA; |FINSI;

          |PARA fFecha = #0#0; |SI fFecha [ #1#13; |HACIENDO fFecha = fFecha + 1;
               nConductor = #203#0;
               |BUCLE ConductorOcupado;
          |SIGUE;
          |SI aOcupado = "S"; |ACABA; |FINSI;
     |FINSI;

     aSwLibre = "S";
     |SI nSw58 = 1; |Y #1#24 = "N";
          |DDEF aAlfa;
          aAlfa = aAlfa + "guerw058";
          |CARGA_DEF aAlfa, guerw058@;
          |SI FSalida = 0;
               |NOME_DAT #guerw058@#aTmp58#;
               |ABRE #guerw058@; |SELECT #3#guerw058@;
               #guerw058@#0 = #1#0;
               #guerw058@#1 = #1#1;
               #guerw058@#2 = #1#2;
               #guerw058@#6 = #203#0;
               |LEE 000#guerw058@.=;
               |SI FSalida = 0;
                    aSwLibre = "N";
               |FINSI;
               |CIERRA #guerw058@;
               |DESCARGA_DEF #guerw058@;
          |FINSI;
     |FINSI;
     |SI aSwLibre = "S"; |Y aGrabaTmp = "S";
          |SALVA_DATOS #203;
          |REPON_DATOS #guerm203@;
          |GRABA 020#guerm203@.n;
     |FINSI;
|FPRC;

|DEFBUCLE ConductorLibre;
     #203#1;
     5;
     00001, aDSub;
     99999, aHSub;
     ;
     NULL, ConductorLibre;
|FIN;

|PROCESO Conductor58_66; |TIPO 66;
     nSw58 = 1;
     #1#30 = #58#6;
     |HAZ Conductor66;
     nSw58 = 0;
|FPRC;

|PROCESO Conductor66; |TIPO 66;
     |DDEF aDef;
     aDef = aDef + "guerm203";
     |CARGA_DEF aDef, guerm203@;
     |SI FSalida = 0;
          |HAZ CreaTempo; |NOME_DAT #guerm203@#Tempo#;
          |DELINDEX #guerm203@;
          |ABRE #guerm203@;
          aGrabaTmp = "S";
          |SI #1#24 = "M";
               aDSub = " ";
               aHSub = "z";
          |SINO;
               aDSub = #1#24;
               aHSub = #1#24;
          |FINSI;
          |BUCLE ConductorLibre;
          |LEE 000#guerm203@.p;
          |CONSULTA_CLAVE #1#guerm203@;
          |SI FSalida ! 0;
               |ERROR;
          |SINO;
               |SI nSw58 = 1;
                    #58#6 = #guerm203@#0;
                    |PINTA #58#6;
               |SINO;
                    #1#30 = #guerm203@#0;
                    |PINTA #1#30;
               |FINSI;
          |FINSI;
          |CIERRA #guerm203@;
          |DELINDEX #guerm203@;
          |HAZ BoraTempo;
          |DESCARGA_DEF #guerm203@;
     |FINSI;
|FPRC;

|PROCESO Conductor58_0; |TIPO 0;
     |SALVA_DATOS #1;
     #1#30 = #58#6;
     #1#24 = #58#8;
     #1#14 = #58#9;
     #1#15 = #58#10;
     |HAZ Conductor0;
     |SI aSwLibre = "S"; |Y #58#8 = "N";
          |DDEF aAlfa;
          aAlfa = aAlfa + "guerw058";
          |CARGA_DEF aAlfa, guerw058@;
          |SI FSalida = 0;
               |NOME_DAT #guerw058@#aTmp58#;
               |ABRE #guerw058@; |SELECT #3#guerw058@;
               #guerw058@#0 = #1#0;
               #guerw058@#1 = #1#1;
               #guerw058@#2 = #1#2;
               #guerw058@#6 = #58#6;
               #guerw058@#8 = "N";
               |LEE 000#guerw058@.];
               |PARA; |SI FSalida = 0; |Y #guerw058@#0 = #1#0; |Y #guerw058@#1 = #1#1;
                         |Y #guerw058@#2 = #1#2; |Y #guerw058@#8 = "N"; |HACIENDO;
                    |SI #guerw058@#3 ! #58#3; |Y #guerw058@#6 = #58#6;
                         |MENAV "0000El conductor no esta libre.";
                         |ERROR; |SAL;
                    |FINSI;
                    |LEE 000#guerw058@.s;
               |SIGUE;
               |CIERRA #guerw058@;
               |DESCARGA_DEF #guerw058@;
          |FINSI;
     |FINSI;
     |REPON_DATOS #1;
|FPRC;

|PROCESO Conductor0; |TIPO 0;
     |SI FSalida = 2; |ACABA; |FINSI;

     |SI #1#24 = "M"; |ACABA; |FINSI;

     aSwLibre = "N";
     |ABRE #203;
     #203#0 = #1#30;
     |LEE 000#203=;
     |SI FSalida ! 0;
          |MENAV "0000No existe conductor...";
          |ERROR; |ACABA;
     |SINO;
          |SI #203#5 ! #1#24;
               |SI #1#24 = "S";
                    |MENAV "0000El conductor no esta subcontratado";
               |SINO;
                    |MENAV "0000El conductor esta subcontratado";
               |FINSI;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;
     |CIERRA #203;

     aGrabaTmp = "N";
     |HAZ ConductorLibre;
     |SI aSwLibre = "N";
          |MENAV "0000El conductor no esta libre...";
          |ERROR; |ACABA;
     |FINSI;

     |SI #1Campo ! Contenido;
          |ABRE #201;
          |ABRE #203;
          |HAZ CargaMail; |PINTA #1#20;
          |CIERRA #201;
          |CIERRA #203;
     |FINSI;
|FPRC;

|PROCESO Subcontra0; |TIPO 0;
     |SI #1#24 = "S";
          |ABRE #112;
          #112#0 = #1#28;
          |LEE 000#112=;
          |SI FSalida ! 0;
               |MENAV "0000No existe proveedor...";
               |ERROR;
          |SINO;
               |SI #1#28 ! Contenido;
                    |DDEFECTO #225;
                    |ABRE #225;
                    #225#0 = #1#28;
                    #225#6 = #1#5;
                    #225#1 = #1#33;
                    #225#3 = #1#7;
                    |LEE 000#225=
                    |SI FSalida = 0;
                         #1#36 = #225#5;
                         |PINTA #1#36;
                    |SINO;
                         #225#4 = #1#8;
                         #225#2 = #1#34;
                         |PUSHV 0501 2380;
                         |PINPA #0#225;
                         |PINDA #0#225;
                         |ENDATOS #1#225;
                         |SI FSalida = 0;
                              |POPV;
                              #1#36 = #225#5;
                              |PINTA #1#36;
                              |GRABA 020#225n;
                         |SINO;
                              |POPV;
                              |ERROR;
                         |FINSI;
                    |FINSI;
                    |CIERRA #225;
               |FINSI;
          |FINSI;
          |CIERRA #112;
     |FINSI;
|FPRC;

|PROCESO Subcon0; |TIPO 0;
     |SI #1#24 = "N";
          |C_M #1#28, 1, "N";
          #1#28 = ""; |PINTA #1#28;
     |SINO;
          |C_M #1#28, 1, "S";
     |FINSI;
     |SI #1#24 ! Contenido;
          |SI #1#24 = "N";    || del pedido
               |ABRE #211;
               #211#0 = #1#0;
               #211#1 = #1#1;
               #211#2 = #1#2;
               |LEE 000#211=;
               |SI FSalida = 0;
                    #1#36 = #211#19;
                    |PINTA #1#36;
               |FINSI;
               |CIERRA #211;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Subcon7; |TIPO 7;
|FPRC;

|PROCESO BusArti;
     |SI #211#3 = #1#7;
          #1#11 = #211#7;
          #1#22 = #211#12;
          nSwExiste = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|PROCESO Articu0; |TIPO 0;
     |SI #1Campo ! Contenido;
          nSwExiste = 0;
          |ABRE #210;
          #210#0 = #1#0;
          #210#1 = #1#1;
          |LEE 000#210=;
          |SI FSalida = 0;
               |BUCLELIN 2BusArti#210;
          |FINSI;
          |CIERRA #210;

          |ABRE #204;
          #204#0 = #1#5;
          #204#1 = #1#23;
          #204#2 = #1#7;
          |LEE 000#204=;
          |SI FSalida = 0; |Y nSwExiste = 0;
               #1#11 = #204#6;
               #1#22 = #204#7;
               |MENAV "0000No existe articulo en pedido, se asigna la tarifa de la obra";
               nSwExiste = 1;
          |FINSI;
          |CIERRA #204;
          |PINTA #1#11;
          |PINTA #1#22;
          |SI nSwExiste = 0;
               |MENAV "0000No existe articulo en pedido...";
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Servicio0; |TIPO 0;
     |SI #1#9 = "D";
          |C_M #1#10, 1, "N";
          |C_M #1#12, 1, "S";
          |C_M #1#13, 1, "S";
          |C_M #1#14, 1, "N";
          |C_M #1#15, 1, "N";
          |ABRE #212; |LEE 000#212p; |CIERRA #212; ||EL primero
          #1#14 = #212#1; |PINTA #1#14;
          |PARA i = 2; |SI i [ 60; |HACIENDO i = i + 2;
               |SI #212i = 0; |SAL; |FINSI;
               #1#15 = #212i;
          |SIGUE;
          |PINTA #1#15;
     |SINO;
          |C_M #1#10, 1, "S";
          |C_M #1#12, 1, "N";
          |C_M #1#13, 1, "N";
          |C_M #1#14, 1, "S";
          |C_M #1#15, 1, "S";
     |FINSI;
     |SI #1#24 = "S";
          |C_M #1#18, 1, "S";
          |C_M #1#19, 1, "S";
     |SINO;
          |C_M #1#18, 1, "N";
          |C_M #1#19, 1, "N";
     |FINSI;
|FPRC;

|PROCESO CargaMail;
     |DDEFECTO #201
     #201#0 = #1#17;
     |LEE 000#201=;
     |SI #201#11 = "N";
          |DDEFECTO #203;
          #203#0 = #1#30;
          |LEE 000#203=;
          #1#20 = #203#4;
     |SINO;
          #1#20 = #201#14;
     |FINSI;
|FPRC;

|PROCESO CargaPedi;
     |SI #0#0 < #211#9; |O #0#0 > #211#10;
          |ACABA;
     |FINSI;

     #220#0 = #211#0;
     #220#1 = #211#1;
     #220#2 = #211#2;
     #220#3 = 1;
     #220#29 = #0#0;
     |LEE 000#220=;
     |SI FSalida = 0; |Y #220#34 = "S"; |ACABA; |FINSI; ||Excluida

     nHay = 1;
     |DDEFECTO #1;
     #1#0 = #211#0;
     #1#1 = #211#1;
     #1#2 = #211#2;
     #1#3 = 1;           || Linea Auto
     #1#4 = #210#6;
     #1#5 = #210#3;
     #1#6 = #210#4;
     #1#7 = #211#3;
     #1#8 = #211#4;
     #1#9 = #211#5;
     #1#10 = #211#8;  ||Viajes/unidades
     #1#11 = #211#7;
     #1#36 = #211#19; || P.Coste

     |LEE 000#212p;  || El primer horario
     |SI #1#9 = "D";
          #1#14 = #212#1;
          |PARA i = 2; |SI i [ 60; |HACIENDO i = i + 2;
               |SI #212i = 0; |SAL; |FINSI;
               #1#15 = #212i;
          |SIGUE;
          #1#12 = #0#0; ||#211#9;
          #1#13 = #211#10;
     |SINO;   ||"G"
          #1#14 = 0;
          #1#15 = 0;
          #1#12 = #0#0;
          #1#13 = #0#0;
     |FINSI;
     #1#16 = 1;
     |SI #211#13 = "S";
          #1#14 = #212#1;
          #1#15 = #212#2;
          #1#17 = #211#15;
          #1#28 = #211#14;
          #1#18 = #211#16;
          #1#19 = #211#17;

          |DDEFECTO #201;
          #201#0 = #1#17
          |LEE 000#201=;

          #1#30 = #201#8;
     |FINSI;
     #1#22 = #211#12;
     #1#23 = #210#7;
     #1#24 = #211#13; ||Subcon S/N
     #1#26 = #210#8;
     #1#32 = #211#6;
     #1#33 = #210#7;
     #1#34 = #210#8;

     |SI #1#9 = "D";     || Diario
          |HAZ CargaMail;
          |SELECT #3#219;
          #219#1 = #0#0;
          #219#5 = #1#0;
          #219#6 = #1#1;
          #219#7 = #1#2;
          #219#14 = #1#3;
          |LEE 000#219=;
          |SI FSalida = 0;
               #1#17 = #219#0;
               #1#30 = #219#8;
               #1#14 = #219#3;
               #1#15 = #219#4;

               #1#24 = #219#9;
               #1#28 = #219#10;
               #1#20 = #219#12;
               #1#21 = #219#11;
               #1#31 = #219#13;
               |GRABA 040#1n; || No hace falta actualizar
          |SINO;
               |GRABA 040#1n;
               |SI FSalida = 0; nForma = 1; |HAZ Act219; |FINSI;
          |FINSI;
     |SINO;
          |HAZ CargaMail;
          |GRABA 040#1n;
          |SI FSalida = 0; nForma = 1; |HAZ Act219; |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE CargaPedi;
     #210#1;
     13;
     "     ", 000001, "S";
     "zzzzz", 999999, "S";
     ;
     NULL, NULL, CargaPedi;
|FIN;

|PROCESO CargaReal;
     |PARA i = 0; |SI i [ 28; |HACIENDO i = i + 1;
          #1i = #220i;
     |SIGUE;
     #1#29 = #220#30;
     #1#30 = #220#31;
     #1#31 = #220#32;
     #1#32 = #220#33;

     #210#0 = #220#0;
     #210#1 = #220#1;
     |LEE 020#210=;
     |SI FSalida = 0;
          #1#33 = #210#7;
          #1#34 = #210#8;
     |FINSI;
     |SI #1#9 = "D";     || Diario
          |SELECT #3#219;
          #219#1 = #0#0;
          #219#5 = #1#0;
          #219#6 = #1#1;
          #219#7 = #1#2;
          #219#14 = #1#3;
          |LEE 000#219=;
          |SI FSalida = 0;
               #1#17 = #219#0;
               #1#30 = #219#8;
               #1#14 = #219#3;
               #1#15 = #219#4;

               #1#24 = #219#9;
               #1#28 = #219#10;
               #1#20 = #219#12;
               #1#21 = #219#11;
               #1#31 = #219#13;
          |FINSI;
     |FINSI;
     |SI nSwIncluir = 1;
          #1#17 = "";
          #1#30 = "";
     |FINSI;
     #1#35 = #220#37; || Mail enviado
     #1#36 = #220#38; || P.Coste
     |SI #1#36 = 0; || si es 0 se coge del pedido
          #211#0 = #1#0;
          #211#1 = #1#1;
          #211#2 = #1#2;
          |LEE 000#211=;
          |SI FSalida = 0;
               #1#36 = #211#19;
          |FINSI;
     |FINSI;
     |GRABA 020#1n;
|FPRC;

|DEFBUCLE CargaReal;
     #220#1;
     34;
     #0#0, "     ", 000001, 001, 001, "N";
     #0#0, "zzzzz", 999999, 999, 999, "N";
     ;
     NULL, CargaReal;
|FIN;

|PROCESO Min;
     #1#0 = "     ";
     #1#1 = 1;
     #1#2 = 1;
     #1#3 = 1;
|FPRC;

|PROCESO Max;
     #1#0 = "zzzzz";
     #1#1 = 999999;
     #1#2 = 999;
     #1#3 = 999;
|FPRC;

|PROCESO Incluir;
     |ABRE #219;
     nSwIncluir = 1;
     |HAZ CargaReal;
     nSwIncluir = 0;
     |CIERRA #219;
     |BORRA 020#220a;
/*
     #1#13 = #0#0;  ||Solo el del dia (al igual que al excluir)
     nForma = 1; |HAZ Act219;
*/
|FPRC;

|DEFBUCLE Incluir;
     #220#1;
     34;
     #0#0, "     ", 000001, 001, 001, "S";
     #0#0, "zzzzz", 999999, 999, 999, "S";
     be;
     NULL, Incluir;
|FIN;

|PROCESO ExcluyeReal;
     #220#17 = "";
     #220#30 = 0;
     |GRABA 020#220a;
     |LIBERA #220;
|FPRC;

|DEFBUCLE ExcluyeReal;
     #220#1;
     ;
     #1#12, #1#0, #1#1, #1#2, #1#3;
     #1#13, #1#0, #1#1, #1#2, #1#3;
     be;
     NULL, ExcluyeReal;
|FIN;

|PROCESO CreaExReal;
     f = #1#12 + 1;
     |PARA; |SI f [ #1#13; |HACIENDO f = f + 1;
          #220#29 = f;
          #220#34 = "N";
          |GRABA 000#220n;    || Sin errores  por si ya existe
     |SIGUE;
|FPRC;

|PROCESO Tipo11; |TIPO 11;
     |SI FSalida = 10; || F2  Excluir
          |DDEFECTO #220;
          |ABRE #220;
          #220#0 = #1#0;
          #220#1 = #1#1;
          #220#2 = #1#2;
          #220#3 = #1#3;
          #220#29 = #0#0;
          |LEE 101#220=;
          |SI FSalida ! 0; |GRABA 020#220b; |FINSI;
          |PARA i = 4; |SI i [ 28; |HACIENDO i = i + 1;
               #220i = #1i;
          |SIGUE;
          #220#30 = #1#29;
          #220#31 = #1#30;
          #220#32 = #1#31;
          #220#33 = #1#32;
          #220#34 = "S"; || Excluida
          #220#35 = #1#33;
          #220#36 = #1#34;
          #220#38 = #1#36;
          |GRABA 020#220a;
          |SI FSalida = 0;
               || Se deja excluido para todo el periodo
               nForma = -1; |HAZ Act219;
               |HAZ CreaExReal;     || Crea el historico para poder
               |BUCLE ExcluyeReal;  || excluir todo el periodo
               |BORRA 040#1a;
          |FINSI;
          |CIERRA #220;

          |ERROR;
          |PTEC 808; || arriba
          |PONCONTROL 23, "SI";
     |FINSI;
     |SI FSalida = 12;  ||F4
          |ABRE #210;
          |BUCLE Incluir;
          |CIERRA #210;
          |ERROR;
          |PTEC 808; || arriba
          |PONCONTROL 23, "SI";
     |FINSI;
|FPRC;

|PROCESO NoAltas; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1; |ERROR; |FINSI;
|FPRC;

|PROCESO CopiaReal;
     |DDEFECTO #220;
     |PARA i = 0; |SI i [ 28; |HACIENDO i = i + 1;
          #220i = #1i;
     |SIGUE;
     #220#29 = #0#0;
     #220#30 = #1#29;
     #220#31 = #1#30;
     #220#32 = #1#31;
     #220#33 = #1#32;
     #220#35 = #1#33;
     #220#36 = #1#34;
     #220#37 = #1#35;    || Mail enviado
     #220#38 = #1#36;
     |GRABA 020#220n;
|FPRC;

|DEFBUCLE CopiaReal;
     #1#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, CopiaReal;
|FIN;

|PROCESO BorraReal;
     |BORRA 020#220a;
|FPRC;

|DEFBUCLE BorraReal;
     #220#1;
     34;
     #0#0, "     ", 000001, 001, 001, "N";
     #0#0, "zzzzz", 999999, 999, 999, "N";
     ;
     NULL, BorraReal;
|FIN;

|PROCESO EstaLibre;
     |SI aDHora ] #219#3; |Y aDHora [ #219#4;
          nEstaLibre = 1;
     |FINSI;
     |SI aHHora ] #219#3; |Y aHHora [ #219#4;
          nEstaLibre = 1;
     |FINSI;
|FPRC;

|DEFBUCLE EstaLibre;
     #219#1;
     ;
     #201#0, #0#0, 01;
     #201#0, #0#0, 99;
     ;
     NULL, EstaLibre;
|FIN;

|PROCESO EquiposSin;
     |DDEFECTO #212;
     #212#0 = #201#10;
     |LEE 000#212=;
     eaDHora = "";
     eaHHora = "";
     |PARA i = 1; |SI i [ 59; |HACIENDO i = i + 2;
          ii = i + 1;
          |SI #212i ! 0; |Y #212ii ! 0;
               aDHora = #212i;
               aHHora = #212ii;
               nEstaLibre = 0;
               |BUCLE EstaLibre;
               |SI nEstaLibre = 0;
                    aDHora  = ("0000" + aDHora) % -104;
                    aHHora  = ("0000" + aHHora) % -104;
                    aAlfa1 = aDHora % 102;
                    aAlfa2 = aDHora % 302;
                    nNume = aAlfa1;
                    eaDHora = nNume + ":" + aAlfa2;
                    eaDHora = (" " + eaDHora) % -105;
                    aAlfa1 = aHHora % 102;
                    aAlfa2 = aHHora % 302;
                    nNume = aAlfa1;
                    eaHHora = nNume + ":" + aAlfa2;
                    eaHHora = (" " + eaHHora) % -105;
                    |PRINT;
                    nHay = 1;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|DEFBUCLE EquiposSin;
     #201#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, EquiposSin;
|FIN;

|PROCESO Reparto;
     |SI #1#14 = 0; |Y #1#15 = 0;
          #1#30 = "";
          #1#17 = "";
     |FINSI;
     aAlfa = #1#17; |QBF aAlfa;
     |SI aAlfa = "";
          #1#30 = "";
     |FINSI;
     |DDEFECTO #202;
     #202#0 = #1#5;
     #202#2 = #1#23;
     |LEE 000#202=;

     |DDEFECTO #203;
     #203#0 = #1#30;
     |LEE 000#203=;

     aDHora  = ("0000" + #1#14) % -104;
     aHHora  = ("0000" + #1#15) % -104;
     aAlfa1 = aDHora % 102;
     aAlfa2 = aDHora % 302;
     nNume = aAlfa1;
     eaDHora = nNume + ":" + aAlfa2;
     eaDHora = (" " + eaDHora) % -105;
     aAlfa1 = aHHora % 102;
     aAlfa2 = aHHora % 302;
     nNume = aAlfa1;
     eaHHora = nNume + ":" + aAlfa2;
     eaHHora = (" " + eaHHora) % -105;
     |PRINT;
     nHay = 0;
|FPRC;

|DEFBUCLE Reparto;
    #1#1;
    ;
    INICIO;
    FINAL;
    ;
    NULL, Reparto;
|FIN;

|PROCESO Listado;
     nHay = 0;
     Impresora = "Crystal Reports";
     |IMPRE 0;
     |SI FSalida = 0;
          |SI aLista2 = 1;
               |INFOR "guera215";
               |SI FSalida ! 0;
                    |MENAV "0000No existe informe guera215";
               |SINO;
                    |ABRE #212;
                    |BUCLE EquiposSin;
                    |CIERRA #212;
                    |SI nHay ! 0; |PIEINF; |FINSI;
                    |FININF;
               |FINSI;
          |SINO;
               |INFOR "guerb215";
               |SI FSalida ! 0;
                    |MENAV "0000No existe informe guerb215";
               |SINO;
                    |ABRE #202;
                    |ABRE #203;
                    |BUCLE Reparto;
                    |CIERRA #203;
                    |CIERRA #202;
                    |SI nHay ! 0; |PIEINF; |FINSI;
                    |FININF;
               |FINSI;
          |FINSI;
          |FINIMP;
     |FINSI;
|FPRC;

|PROGRAMA;
     |ABRE #226; |LEE 000#226p; |CIERRA #226;
     |HAZ CreaTempo; aTmp1 = Tempo; |NOME_DAT #1#Tempo#; |DELINDEX #1;
     |HAZ CreaTempo; aTmp58 = Tempo; |NOME_DAT #58#Tempo#; |DELINDEX #58;
     |ABRE #0;
     |CLS;
     |PINPA #0#0;
     |ENTLINEAL #1#1, 1, 7, 14, 0, Min, Max;
     #0#0 = ~;
     |ENCAMPO #0#0;
     |SI FSalida = 0;
          nSigue = 1;
          |LEE 000#0=;
          |SI FSalida = 0;
               nSigue = 0;
               aAlfa = "0000Proceso bloqueado por otro usuario:" + #0#1;
               |QBF aAlfa;
               aAlfa = aAlfa + &13 + #0#2 + " " + #0#3;
               |MENAV aAlfa;
               |CONFI "0000NContinuar S/N";
               |SI FSalida = 0;
                    |BORRA 020#0c;
                    nSigue = 1;
               |FINSI;
          |FINSI;
          |SI nSigue = 1;
               #0#1 = Usuario % 810;
               #0#2 = ~;
               |HORA aAlfa;
               #0#3 = aAlfa;
               #0#4 = "guerm215";
               |GRABA 040#0n;
               |SI FSalida = 0;
                    |HAZ IniProceso;
                    |BORRA 040#0c;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #0;
     |DELINDEX #58; Tempo = aTmp58; |HAZ BoraTempo;
     |DELINDEX #1; Tempo = aTmp1; |HAZ BoraTempo;
|FPRO;

|PROCESO IniProceso;
     |ABRE #1;
     |ABRE #201;
     |ABRE #212;
     |ABRE #210;
     |ABRE #219;
     |ABRE #211;
     |ABRE #203;
     |BUCLE CargaReal;
     |CIERRA #203;
     |CIERRA #211;
     |CIERRA #219;
     |CIERRA #210;
     |ABRE #220;
     |ABRE #219;
     |ABRE #203;
     |BUCLE CargaPedi;
     |CIERRA #203;
     |CIERRA #219;
     |CIERRA #220;
     |CIERRA #212;
     |CIERRA #201;
     |CIERRA #1;
     ||SI nHay = 0;
     ||    |MENAV "0000No hay pedidos para esta fecha";
     ||SINO;
       |ET Menu1;
          |PARA; |SI aMenu2 = 1; |O aMenu2 = 4; |HACIENDO;
               |ENTLINEAL #1#1, 1, 2, 14, 0, Min, Max;
             |ET Menu2;
               |MENU aMenu;
               aMenu2 = FSalida;
               |SI aMenu2 = 4;
                    |MENU aLista;
                    aLista2 = FSalida;
                    |SI aLista2 ] 1; |HAZ Listado; |FINSI;
                    |VETE Menu2;
               |FINSI;
          |SIGUE;
          |SI aMenu2 = 2;
               nSwCheqAsig = 0;
               |BUCLE CheqAsigna;
               |SI nSwCheqAsig = 0;
                    |HAZ Actualiza;
               |SINO;
                    aAlfa = "0000Se han encontrado " + nSwCheqAsig + " lineas sin asignar...";
                    |MENAV aAlfa;
                    |MENU aMenz;
                    |SI FSalida = 1;
                         aMenu2 = 1; |VETE Menu1;
                    |SINO;
                         |HAZ Actualiza;
                    |FINSI;
               |FINSI;
          |SINO;
               |MENAV "0000Proceso cancelado...";
          |FINSI;

          ||----Pasa el TMP al fichero real
          |BUCLE BorraReal;
          |ABRE #220;
          |BUCLE CopiaReal;
          |CIERRA #220;
     ||FINSI;
|FPRC;

|PROCESO DefHora58_7; |TIPO 7;
     |SI #58#9 = 0; |Y #58#10 = 0;
          #58#9 = #1#14; |PINTA #58#9;
          #58#10 = #1#15; |PINTA #58#10;
     |FINSI;
|FPRC;

|PROCESO AltaArtPrvObra;
     |DDEFECTO #225;
     |ABRE #225;
     #225#0 = #201#12;
     #225#6 = #1#5;
     #225#1 = #1#33;
     #225#3 = #1#7;
     |LEE 000#225=
     |SI FSalida ! 0;
          #225#4 = #1#8;
          #225#2 = #1#34;
          |PUSHV 0501 2380;
          |PINPA #0#225;
          |PINDA #0#225;
          |ENDATOS #1#225;
          |SI FSalida = 0;
               |POPV;
               |GRABA 020#225n;
          |SINO;
               |POPV;
               |ERROR;
          |FINSI;
     |FINSI;
     |CIERRA #225;
|FPRC;
