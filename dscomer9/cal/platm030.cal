|FICHEROS;
 platm030 #0;
 platm011 #1;
 platm020 #2;
 platm012 #3;
 platm029 #4;
|FIN;

|VARIABLES;
 nCanti = 0;
 nModo = 0;
 nNumero = 0;
 aEstado = "";
 linea = 0;
 ii = 0;
 nVez = 0;
 &aOrigen = "";
 &fFecha = @;
|FIN;

|PROCESO MiraEstado;
|ABRE #1;
#1#0 = #0#2;
|LEE 010#1=;
|SI FSalida ! 0;|DDEFECTO #1;|FINSI;
|LIBERA #1;
|CIERRA #1;
|FPRC;

|PROCESO SumaTip;
|QBF aEstado;
|ABRE #platm012;
#platm012#0 = #platm011#2;
|LEE 010#platm012.=;
|SI FSalida = 0;
  |SI aEstado = "ALMACEN";
    #platm012#2 = #platm012#2 -. 1;
  |FINSI;
  |SI aEstado = "INSTALADO";
    #platm012#3 = #platm012#3 -. 1;
  |FINSI;
  |SI aEstado = "AVERIADO";
    #platm012#4 = #platm012#4 -. 1;
  |FINSI;
  |SI aEstado = "REPARADO";
    #platm012#5 = #platm012#5 -. 1;
  |FINSI;
  |SI aEstado = "ENVIOPLATA";
    #platm012#7 = #platm012#7 -. 1;
  |FINSI;
  #platm012#2 = #platm012#2 +. 1;
  #platm012#6 = #platm012#2 + #platm012#3 + #platm012#4 + #platm012#5 + #platm012#7;
  |GRABA 010#platm012.a;
|FINSI;
|LIBERA #platm012;
|CIERRA #platm012;
|FPRC;


|PROCESO AltaHis;
  |ABRE #1;
  #1#0 = #0#2;
  |LEE 010#1=;
  |SI FSalida = 0;
      aEstado = #1#7;
      #1#7 = "ALMACEN";
      |GRABA 010#1a;
  |FINSI;
  |LIBERA #1;
  |CIERRA #1;
  |ABRE #2;
  #2#0 = #0#2;
  #2#3 = 001;
  |LEE 010#2=;
  |SI FSalida ! 0;
    linea = 1;
  |SINO;
    |PARA ii = 1;|SI ii [100;|HACIENDO;
      linea = #2#3;
      |LEE 010#2s;
      |SI #2#0 ! #0#2;|O FSalida ! 0;
        |SAL;
      |FINSI;
    |SIGUE;
  |FINSI;
  |LIBERA #2;
  #2#0 = #0#2;
  #2#3 = linea+1;
  #2#1 = "ENTRADA";
  #2#2 = #4#2;
  #2#6 = #0#7; ||CANTIDAD
  |GRABA 010#2n;
  |LIBERA #2;
  |CIERRA #2;
|FPRC;

|CALCULO tipo3028;|TIPO 3;
nModo = (FEntrada/100)!0;
aEstado = #0#8;
|QBF aEstado;
|SI aEstado ! "ALMACEN";
  |HAZ AltaHis;
|FINSI;
|FCAL;

|PROCESO BajaHisto;
|ABRE #2;
|SELECT #3#2;
#2#0 = #0#2;
#2#1 = "ENTRADA";
#2#2 = #4#2;
|LEE 010#2=;
|SI FSalida = 0;
 |BORRA 010#2a;
|FINSI;
|LIBERA #2;
|CIERRA #2;
|FPRC;

|PROCESO SumaOtro;
|ABRE #1;
#1#0 = #0#2;
|LEE 010#1=;
|SI FSalida = 0;
  |ABRE #3;
  #3#0 = #1#2;
  |LEE 010#3=;
  |SI FSalida = 0;
     nCanti = #0#7;
     #3#2 = #3#2 +. nCanti;
     |SI #0#6 = 1; ||es nuevo
     |FINSI;
     |SI #0#6 = 2; ||es un envio anterior
       #3#7 = #3#7 -. nCanti;
     |FINSI;
     #3#6 = #3#2 + #3#3 + #3#4 + #3#5 + #3#7;
     |GRABA 010#3a;
  |FINSI;
  |LIBERA #3;
  |CIERRA #3;
|FINSI;
|LIBERA #1;
|CIERRA #1;
|FPRC;

|PROCESO RequeteSuma;
|HAZ MiraEstado;
aEstado = #1#7;
|QBF aEstado;
|ABRE #platm012;
#platm012#0 = #platm011#2;
|LEE 010#platm012.=;
|SI FSalida = 0;
  |SI aEstado = "ALMACEN";
    #platm012#2 = #platm012#2 + 1;
  |FINSI;
  |SI aEstado = "INSTALADO";
    #platm012#3 = #platm012#3 + 1;
  |FINSI;
  |SI aEstado = "AVERIADO";
    #platm012#4 = #platm012#4 + 1;
  |FINSI;
  |SI aEstado = "REPARADO";
    #platm012#5 = #platm012#5 + 1;
  |FINSI;
  #platm012#6 = #platm012#2 + #platm012#3 + #platm012#4 + #platm012#5 + #platm012#7;
  |GRABA 010#platm012.a;
|FINSI;
|LIBERA #platm012;
|CIERRA #platm012;
|FPRC;

|CALCULO tipo2028;|TIPO 2;
|HAZ MiraEstado;
aEstado = #1#7;
nModo = (FEntrada/100)!0;
|SI nModo = 3;
 |HAZ RecuperaEstado;
 |HAZ BajaHisto
|FINSI;
nVez = nVez +. 1;
|SI nModo = 2;
  |SI nVez = -1;
     |HAZ BajaHisto;
     |HAZ RecuperaEstado;
     aEstado = #0#8;
  |FINSI;
|FINSI;
|SI #0#5 = "S";
  |HAZ SumaTip;
|SINO;
  |HAZ SumaOtro;
|FINSI;
|FCAL;

|CALCULO MiraTipo;|TIPO 6;
|MODULO aOrigen;
fFecha = #platm029#2;
|ABRE #1;
#1#0 = #0#2;
|LEE 010#1=;
|SI FSalida = 0;
  |SI #1#8 = "S";
    aEstado = #1#7;
    |QBF aEstado;
    |SI aEstado ! "ENVIOPLATA";|Y aEstado ! "";
      aEstado = "0000 Esta mercancia tiene el estado: "+ aEstado;
      |MENAV aEstado;
      |ERROR;
    |FINSI;
  |FINSI;
|FINSI;
|FCAL;

|CALCULO Mira;
|SI #0#5 = "S";
 |C_M #0#6, 1, "N";
 |C_M #0#7, 1, "N";
|SINO;
 |C_M #0#6, 1, "S";
 |C_M #0#7, 1, "S";
|FINSI;
|FCAL;

|PROCESO RecuperaEstado;
|ABRE #platm011;
#platm011#0 = #platm030#2;
|LEE 010#platm011.=;
|SI FSalida = 0;
  #platm011#7 = #platm030#8;
  |GRABA 010#platm011.a;
|FINSI;
|LIBERA #platm011;
|CIERRA #platm011;
|FPRC;
