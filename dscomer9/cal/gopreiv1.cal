     ActArticulo, CreParInd, CalcuPorcentaje

|FICHEROS;
     gopre001 #1;
     gopre002 #2;
     gopre003 #3;
     gopre004 #4;
     referen@ #5;

     agifa019 #19;
     agi00063 #63;
     goparame #100;
|FIN;

|VARIABLES;
     aMarca = "";
     aFam = "";
     &enCosteInd = 0;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aCar = "";
     aLon = "";
     nPos = 0;
     aPrefijo = "";
     i = 0;
     nPrecio = 0;
     nHastaLin = 0;
     aArti = "";
     nTotal = 0;
     nLinea = 0;
|FIN;

|PROCESO RefDesglose;
     |SI aPrefijo = "";
          aAlfa = "";
     |SINO;
          aLon = aPrefijo % A0;
          nPos = 100 + aLon;
          aAlfa = #referen@#5;
          aAlfa = aAlfa % nPos;
     |FINSI;
     |SI aAlfa = aPrefijo;
          nPrecio = #referen@#12 + nPrecio;
     |FINSI;
|FPRC;

|DEFBUCLE RefDesglose;
     #referen@#1005;
     ;
     #3#0, #3#1, #3#2, #3#4, 001;
     #3#0, #3#1, #3#2, #3#4, nHastaLin;
     ;
     NULL, RefDesglose;
|FIN;

|PROCESO Desglose1;
     aAlfa1 = #4#5;
     aAlfa2 = aAlfa1 - "%";
     || Si contiene % el precio es la suma de los componentes anteriores
     || que empiezan por el prefijo
     |SI aAlfa1 ! aAlfa2;
          aPrefijo = "";
          aLon = aAlfa1 % A0;
          |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
               nPos = i * 100 + 1;
               aCar = aAlfa1 % nPos;
               |SI aCar = "%"; |SAL; |FINSI;
               aPrefijo = aPrefijo + aCar;
          |SIGUE;
          nPrecio = 0;
          nHastaLin = #4#4 - 1;
          |BUCLE RefDesglose;
          #4#9 = nPrecio * #4#8;
          #4#10 = #4#9;
          #4#11 = #4#9;
          #4#12 = #4#9;
          #4#8 = 1;
          |GRABA 020#4a;
     |FINSI;
     |LIBERA #4;
|FPRC;

|DEFBUCLE Desglose1;
     #4#1;
     ;
     #3#0, #3#1, #3#2, #3#4, 001;
     #3#0, #3#1, #3#2, #3#4, 999;
     be;
     NULL, Desglose1;
|FIN;

|PROCESO Partidas1;
     |BUCLE Desglose1;
|FPRC;

|DEFBUCLE Partidas1;
     #3#1;
     ;
     #1#0, #1#1, "                    ", 001;
     #1#0, #1#1, "zzzzzzzzzzzzzzzzzzzz", 999;
     ;
     NULL, Partidas1;
|FIN;

|PROCESO CalcuPorcentaje;
     |DDEF aAlfa;
     aAlfa = aAlfa + "gopre004";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |BUCLE Partidas1;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;
======================================================
|PROCESO PartidasInd;
     nTotal = #3#8 * enCosteInd / 100;
     #4#0 = #3#0;
     #4#1 = #3#1;
     #4#2 = #3#2;
     #4#3 = #3#4;
     #4#4 = 999;
     |LEE 000#4]
     |SI FSalida = 0;
          |LEE 000#4a;
     |SINO;
          |LEE 000#4u;
     |FINSI;
     |SI FSalida = 0;|Y #4#0 = #3#0;|Y #4#1 = #3#1;|Y #4#2 = #3#2;|Y #4#3 = #3#4;
          nLinea = #4#4 + 1;
     |SINO;
          nLinea = 1;
     |FINSI;
     |DDEFECTO #4;
     #4#0 = #3#0;
     #4#1 = #3#1;
     #4#2 = #3#2;
     #4#3 = #3#4;
     #4#4 = nLinea;
     #4#5 = #19#0;
     #4#6 = #19#1;
     #4#7 = #19#5;
     #4#8 = 1;
     #4#9 = nTotal;
     #4#10 = nTotal;
     #4#11 = nTotal;
     #4#12 = nTotal;
     #4#13 = 0;
     #4#14 = #63#0;
     #4#15 = #63#1;
     |GRABA 020#4n;
|FPRC;

|DEFBUCLE PartidasInd;
     #3#1;
     ;
     #1#0, #1#1, "                    ", 001;
     #1#0, #1#1, "zzzzzzzzzzzzzzzzzzzz", 999;
     ;
     NULL, PartidasInd;
|FIN;

|PROCESO CreParInd;
     |ABRE #100; |LEE 000#100p; |CIERRA #100;

     aArti = #100#91;
     |QBF aArti;
     |SI aArti = ""; |ACABA; |FINSI;

     |ABRE #19;
     #19#0 = aArti;
     |LEE 000#19=;
     |CIERRA #19;

     |ABRE #63;
     #63#0 = #19#126;
     |LEE 000#63=;
     |CIERRA #63;

     |ABRE #4;
     |BUCLE PartidasInd;
     |CIERRA #4;
|FPRC;
-------------------------------------------------------------------------
|PROCESO ActArtDesglose;
     aFam = #4#5 % 102;
     aMarca = #100#47;
     |SI aFam = "mq"; aMarca = #100#7; |FINSI;
     |SI aFam = "mo"; aMarca = #100#5; |FINSI;
     |SI aFam = "mt"; aMarca = #100#6; |FINSI;
     |DDEFECTO #19;
     #19#0 = #4#5;
     |LEE 000#19=;
     |SI FSalida ! 0; |GRABA 020#19b; |FINSI;
     #19#1 = #4#6;
     #19#5 = #4#7;  || Uni. Medida
     #19#28 = #4#9; || Ult. Precio Com
     #19#133 = #4#9;
     #19#163 = #4#9;
     #19#164= #4#9;
     #19#165 = "EUR";
     #19#126 = aMarca;
     #19#125 = "m";
     #19#2 = aFam;
     |SI aFam = "mt";
          #19#3 = #19#0 % 104;
     |FINSI;
     #19#127 = #19#3;
     |GRABA 020#19a;
     |LIBERA #19;

     |DDEFECTO #63;
     #63#0 = aMarca;
     |LEE 000#63=;

     #4#14 = #63#0;
     #4#15 = #63#1;
     |GRABA 020#4a;
     |LIBERA #4;
|FPRC;

|DEFBUCLE ActArtDesglose;
     #4#1;
     ;
     #1#0, #1#1, "                    ", "                    ", 001;
     #1#0, #1#1, "zzzzzzzzzzzzzzzzzzzz", "zzzzzzzzzzzzzzzzzzzz", 999;
     be;
     NULL, ActArtDesglose;
|FIN;

|PROCESO ActArticulo;
     |ABRE #19;
     |ABRE #63;
     |BUCLE ActArtDesglose;
     |CIERRA #63;
     |CIERRA #19;
|FPRC;
