     AceptaOferta, ConfirmaPedido, CalStockPedido, FacturaSinServ
     CreaOfePedRecha, AnulaAceOferta, AnulaAcePedido
     CreaOfeRepa, BorraPedido, AlbFac0, EnvioAlemania
|FICHEROS;
     pcegm002 #2;
     pcegm003 #3;
     pcegm004 #4;
     pcegm005 #5;
     pcegm006 #6;
     pcegz011 #11,MANTE;
     pcegz013 #13,MANTE;
     pcegm016 #16;

     agifa010 #10;
     agifa017 #17;
     agifa019 #19;
     dsm00020 #20;
     agifa024 #24;
     agifa025 #25;
     dsm00003 #30;
     pcegm038 #38;
     pcegm039 #39;
     pcegm040 #40;
     pcegm042 #42;
     pcegm043 #43;
     pcegm044 #44;
     agifa059 #59;
     agifa071 #71;
     dsm00087 #87;
     agifa091 #91;
     agis0002 #102;
     dsm00109 #109;
     agifa134 #134;
     agifa142 #142;
     agifa177 #177;
     dscamrec@ #600;
     dsm00024;
     agifa321 #321;
     agifa324 #324;
     dsm00113;
     agifa084;
     agifa007;
     agifa025;
     dsm00045,MANTE;
     agifa133;
     dsm00087;
     dsm00130;
     dsm00289 #289;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     fFecha = @;
     aSerRep = "";
     aOrg = "";
     aDes = "";
     aDato = "";
     aFic = "";
     nCampos = 0;
     nNume = 0;
     &eaTexto = "";
     &eaImpresora = "";
     &ser_alb = "";
     &num_alb = 0;
     aSerie = "";
     aSerSal = "";
     nNumSal = 0;
     aSirve = "N";
     nDto = 0;
     imneto = 0;
     f = @;
     aA¤o = "";
     aTxt1 = "";
     aTxt2 = "";
     nLinPed = 0;
     i = 0;
     aArti = "";
     &eaEmp = "";
     &enSwMenu = 0;
     &aDivisa = "";
     &aMoneda = "";
     nHayRese = 0;
     nHayFact = 0;
     nHayServ = 0;
     nOk = 0;
     nUni = 0;
     nHay = 0;
     nLin = 0;
     Divisa = "";
     CambioBase = 0;
     CambioDiv = 0;
     aAlfa = "";
     nHandle = 0;
     aPath = "";
     aDef00 = "";
     aMensa = "";
     aTempo600 = "";
     &Tempo = "";
     &aCPath = "";
     &aCNome = "";
     aSubProg = "|:dscarter/dsrecibo";
     &nDeci_Div = 0;
     &eaFich = "";
     aRese = "";
     aPend = "";
     aCali = "";
     nCobro = 0;
     fFecCobro = @;
     fFecVto = 0;
     aFP = "";
     &nImpo = 0;
     margen = 0;
     nForma = 0;
     fmes = "";
     mes = 0;
     &eaTag = "";


     &fed_dt = @;   || Fecha....
     &art_dt = "";  || Articulo.
     &cli_dt = "";  || Cliente..
     &fam_dt = "";  || Familia.
     &iva_dt = 0;   || Tipo Iva.
     &dtos_2 = 0;   || Descuento 2.
     &dto_pt = 0;   || Descuento Ptas.
     &dtos_1 = 0;   || Descuento 1.
     &pvp_ve = 0;   || Precio Venta.
     &tarifa = 0;   || Tarifa Cliente.
     &quedto = 0;   || 1=cli./art, 2=cli./familia, 3=cli./subfam.
     &gru_dt = "";  || Grupo Cliente.
     &uni_dt = 0;
     &enMensaje = 0;
     &aParam    = "";
     &nPromo = 0;
     &enDescuento1 = 0;
     &enDescuento2 = 0;
     &eaTComision  = "";
     &enComision   = 0;
|FIN;

|PROCESO ActuaFa;
     |ABRE #24;
     #24#0 = #134#2;
     |LEE 121#24=;
     |SI 0 = FSalida;
          fmes = #134#1 % A402;
          mes = ((fmes - 1) * 4) + 54;
          imneto = #134#18 - #134#17;
          |SI #142#115 = "N";
               nImpo = (imneto * 100) / (100 - #134#6);
               nDto = #134#17 + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
               nDto = #134#17;
          |FINSI;
          #24#50 = #24#50 -. imneto;        || pendiente de facturar
          #24mes = #24mes +. nImpo;
          mes = mes + 1;
          #24mes = #24mes +. nDto;
          mes = mes + 1;
          #24mes = #24mes +. #134#46;
          #24#102 = #24#102 +. nImpo;
          #24#103 = #24#103 +. nDto;
          #24#104 = #24#104 +. #134#46;
          #24#45 = #134#1;
          #24#46 = imneto;
          #24#110 = #24#110 +. imneto;
          #24#175 = "N";
          |GRABA 020#24a;

          enImpCliPen = -imneto;
          enImpCliCom = nImpo;
          enImpCliDto = nDto;
          enImpCliMar = #134#46;
          enImpCliFac = imneto;
          eaCliente = #134#2;
          efFecha = #134#1;
          |HAZ AcumulaCli;
     |FINSI;
     |CIERRA #24;

     |ABRE #25;
     #25#0 = #134#7;
     |LIBERA #25;
     |LEE 121#25=;
     |SI 0 = FSalida;
          imneto = #134#18 - #134#17;
          fmes = #134#1 % A402;
          mes = fmes - 1;
          mes = mes * 2;
          mes = mes + 11;
          #25mes = #25mes +. #134#8;

          mes = mes + 1;
          #25mes = #25mes +. imneto;
          #25#35 = #25#35 +. #134#8;
          #25#36 = #25#36 +. imneto;
          mes = fmes - 1;
          mes = mes + 40;
          #25mes = #25mes + #134#55;
          #25#52 = #25#52 + #134#55;

          #25#54 = "N";
          |GRABA 020#25a;

          enImpRepComi = #134#8;
          enImpRepVta = imneto;
          enImpRepRete = #134#55;
          eaRepre = #134#7;
          efFecha = #134#1;
          |HAZ AcumulaRep;

     |FINSI;
     |CIERRA #25;
     ||************* CALCULA EL RIESGO EN FACTURAS;
     eaTag = "FAC";  |HAZ Riesgos;
|FPRC;


|PROCESO HallaMoneda;
     Divisa  = #4#35;
     CambioBase = #4#41;
     CambioDiv = #4#36;
|FPRC;

|PROCESO ActFac;
     nForma = 1;
     #19#0 = #71#2;
     |LEE 121#19=;
     |SI FSalida = 0;
          #71#14 = #71#5 * #19#9;  ||Coste
          |GRABA 020#71a;

          |SI #19#194 = 2;
               nImpo = ((((#71#48 * #71#6) < #71#8) < #71#33) < #10#5) < #10#32;
          |SINO;
               nImpo = ((((#71#5 * #71#6) < #71#8) < #71#33) < #10#5) < #10#32;
          |FINSI;
          |SI #142#115 = "S";
               nImpo = nImpo < #10#7;
          |FINSI;
          margen = #71#14;             ||Coste albaran !!
          |SI #134#57 = "S";
               nImpo = -nImpo;
               margen = nImpo + margen;
          |SINO;
               margen = nImpo - margen;
          |FINSI;
          #10#37 = #10#37 + (margen * nForma);

          fmes = #134#1 % A402;
          mes = ((fmes - 1) * 5) + 35;

          #19mes = #19mes + (nImpo * nForma);      ||       imneto;
          mes = mes + 1;
          #19mes = #19mes + (margen * nForma);
          #19#95 = #19#95 + (nImpo * nForma);       ||    imneto;
          #19#96 = #19#96 + (margen * nForma);
          mes = (FEntrada / 100) ! 0;
          |SI 1 = mes;
               #19#24 = #134#1;
               #19#25 = #71#5;
          |FINSI;
          |GRABA 020#19a;

          efFecha = #134#1;
          eaArticulo = #71#2;
          enImpVta = (nImpo * nForma);
          enImpMar = (margen * nForma);
          |HAZ AcumulaArt;

          enForma = nForma;
          enImpKit = nImpo;
          enMrgKit = margen;
          |HAZ ImpArtKit;    || Acumulados Articulos con Kit
     |FINSI;
     |LIBERA #71;
|FPRC;

|PROCESO EntregaCartera;
     |DBASS aAlfa;
     aAlfa = aAlfa + "dscarter/fich/dscam000.dat";
     |XABRE "E", aAlfa, nHandle;
     |SI FSalida = 0;
          |DBASS aPath;
          aPath = aPath + "dscarter/";
          aDef00 = aPath + "def/dscamrec";

          |CARGA_DEF aDef00, dscamrec@;
          |SI FSalida ! 0;
               aMensa = "0000Error al cargar:" + aDef00;
               |MENAV aMensa;
          |SINO;
               |HAZ CreaTempo; aTempo600 = Tempo;
               |PATH_DAT #600 aPath; |NOME_DAT #600 aTempo600; |DELINDEX #600;
               |ABRE #600;
               aCPath = aPath; aCNome = aTempo600;

               |HAZ HallaMoneda;

               |ABRE #agifa324;
               #agifa324#0 = Divisa;
               |LEE 020#agifa324.=;
               |CIERRA #agifa324;

               |ABRE #agifa024;
               #agifa024#0 = #agis0002#2;
               |LEE 000#agifa024.=;
               |CIERRA #agifa024;

               nDeci_Div = #agifa324#7;
               |DDEFECTO #dscamrec@;
               ||#600#0  =              ||Libro
               #600#1  = #102#20;     ||Serie
               #600#2  = #102#17;     ||Fact
               #600#3  = #agis0002#18;||N§ Rec
               #600#4  = #agis0002#8; ||F.V
               #600#5  = #agis0002#7; ||F.E
               #600#6  = #agis0002#12;||Cuenta Cli
               #600#7  = #agis0002#3; ||Nom Cli
               #600#8  = #agis0002#4; ||Nom Banco
               #600#9  = #agifa024#32;      ||Entidad
               #600#10 = #agifa024#33;      ||Sucursal
               #600#11 = #agifa024#31;      ||DC
               #600#12 = #agifa024#30;      ||Cuenta
               #600#13 = #agis0002#22;||Tipo Rec
               ||#600#14 =      ||Departa
               #600#15 = #agis0002#9; ||Importe
               #600#16 = #agis0002#15;||A aceptar
               #600#17 = #agis0002#6; ||Aceptado
               #600#18 = #agis0002#2; ||Cliente
               #600#21 = #agifa024#3; ||Zona
               #600#22 = 1;           ||Documento
               ||#600#23 =      ||Empresa Contable
               ||#600#24 =      ||Periodo
               #600#25 = eaEmp;       ||Empresa ges
               ||#600#26 =      ||A cuenta
               #600#27 = "V";         ||Tipo
               #600#28 = "A";         ||Ope
               #600#29 = #agifa324#0;      ||Divisa
               #600#30 = #agifa324#1;      ||Nombre
               #600#31 = CambioDiv;        ||Cambio Divisa
               #600#32 = CambioBase;       ||Cambio Base
               #600#33 = #agifa024#203;
               #600#34 = 0;
               #600#35 = "P";
               #600#36 = #agis0002#28;
               #600#38 = #agis0002#16;
               #600#39 = #agis0002#10;
               aAlfa = "|NC"; aAlfa = #600#aAlfa#;
               |SI aAlfa > 48;
                    #600#48 = #agifa024#215;
                    #600#49 = #agifa024#216;
               |FINSI;
               |SI aAlfa > 50;
                    #600#50 = #agifa024#217;
                    |ABRE #289;
                    #289#0 = #agifa024#0;
                    |LEE 000#289=;
                    |SI FSalida ! 0; |DDEFECTO #289; |FINSI;
                    |CIERRA #289;
                    #600#51 = #289#1;
               |FINSI;
               |GRABA 020#600n;
               |SUB_EJECUTA_NP aSubProg;

               |CIERRA #600;
               |DELINDEX #600;
               |DESCARGA_DEF #dscamrec@;

               |HAZ BoraTempo;
          |FINSI;

          eaTag = "RAP";
          |HAZ Riesgos;
     |FINSI;
|FPRC;

|PROCESO EntregaPedido;
     |ABRE #91;
     #91#0 = aFP;
     |LEE 020#91=;
     |CIERRA #91;

     |DDEFECTO #102;
     |ABRE #102;
     #102#30 = "P";
     #102#20 = #4#25;
     #102#17 = #4#0;
     #102#18 = 1;

     #102#2 = #24#0;
     #102#3 = #24#1;
     #102#4 = #24#29;
     #102#7 = #4#1;
     #102#12 = #24#16;
     #102#24 = #4#9;
     #102#9 = nCobro;
     #102#16 = fFecCobro; ||F.Cobro
     #102#8 = fFecVto;  ||F.Vto
     #102#22 = #91#69;    || Tipo Rec
     |SI #142#63 = "S";
          |ABRE #177;
          #177#0 = #102#22;
          |LEE 000#177=;
          aAlfa = #177#3; |QBF aAlfa;
          |SI FSalida = 0; |Y aAlfa ! "";
               #102#28 = aAlfa;
          |FINSI;
          |CIERRA #177;
     |FINSI;
     |GRABA 020#102n;
     |CIERRA #102;
|FPRC;

|PROCESO LinOfePed0;
     nLinPed = nLinPed + 1;
     |DDEFECTO #5;
     #5#28 = #4#25;
     #5#0 = #4#0;
     #5#1 = nLinPed;
     #5#2 = #3#2;
     #5#3 = #3#3;
     #5#4 = #3#4;
     #5#5 = nUni;
     #5#6 = #3#6;
     #5#7 = #3#7;
     #5#8 = #3#8;
     #5#9 = #3#9;
     #5#10 = #3#10;
     #5#13 = #4#2;
     #5#14 = #3#11;
     #5#16 = #4#7;
     #5#17 = #4#16;
     #5#18 = #3#13;
     #5#19 = #4#18;
     #5#20 = #4#4;
     #5#23 = #4#5;
     #5#24 = #5#6;
     #5#26 = #4#9;
     #5#29 = #3#21;
     #5#35 = #3#22;
     #5#36 = #3#23;
     #5#38 = #3#24;
     #5#39 = #3#25;
     #5#40 = #3#26;
     #5#41 = #3#27;
     #5#42 = #5#5;
     #5#44 = #3#28;
     #5#45 = #3#29;
     #5#46 = #3#30;
     #5#48 = #5#44;
     #5#50 = #4#31;
     #5#51 = #4#32;
     #5#52 = #4#33;
     #5#61 = #3#40;
     #5#62 = #3#41;
     |GRABA 020#5n;
     |HAZ TotalLin004;
     enForma = 1;
     |HAZ AcumulaPV_PCEG;

     |ABRE #19;
     #19#0 = #5#2;
     |LEE 000#19=;
     |SI FSalida = 0;
          #4#81 = #4#81 + (#19#102 * #5#5);
     |FINSI;
     |CIERRA #19;
|FPRC;

|PROCESO LinOfePed;
     aArti = #3#2;
     aAlfa = aArti - "CAL";
     |SI aArti ! aAlfa;
          aTxt1 = #3#40;
          aTxt2 = #3#41
          |ABRE #39;
          |PARA i = 1; |SI i [ #3#5; |HACIENDO i = i + 1;
               nUni = 1;
               #39#0 = #3#20;
               #39#1 = #3#0;
               #39#2 = i;
               |LEE 000#39=;
               |SI FSalida = 0;
                    #3#40 = #39#3;
                    #3#41 = #39#4;
               |SINO;
                    #3#40 = aTxt1;
                    #3#41 = aTxt2;
               |FINSI;
               |HAZ LinOfePed0;
          |SIGUE;
          |CIERRA #39;
     |SINO;
          nUni = #3#5;
          |HAZ LinOfePed0;
     |FINSI;
|FPRC;

|PROCESO CabOfePed;
     nLinPed = 0;
     |ABRE #24;
     #24#0 = #11#99;
     |LEE 000#24=;
     |CIERRA #24;
     #4#1 = ~;
     #4#2 = #11#103;
     #4#4 = #24#0;
     #4#5 = #2#5;
     #4#6 = #2#7;
     #4#7 = #2#6;
     #4#8 = #11#123;
     #4#9 = #11#108;
     #4#14 = #11#113;
     #4#16 = #2#34;
     #4#17 = #2#32;
     #4#18 = #2#35;
     #4#19 = #11#105;
     #4#19 = #11#112;
     #4#20 = #11#114;
     #4#21 = #11#116;
     #4#22 = #2#36;
     #4#23 = #24#41;
     #4#35 = #2#65;
     #4#36 = #2#66;
     #4#37 = #2#67;
     #4#40 = #2#68;
     #4#41 = #2#69;
     #4#57 = #11#100;
     #4#59 = #11#115;
     #4#60 = #2#78;
     #4#62 = #11#102;
     #4#64 = #24#15;
     #4#65 = #11#101;
     #4#66 = #11#103;
     |SI #4#37 = "D";
          #4#98 = #11#104;
     |SINO;
          #4#67 = #11#104;
     |FINSI;
     #4#69 = #2#87;
     #4#70 = #11#121;
     #4#71 = #11#106;
     #4#72 = #11#107;
     #4#73 = #11#111;
     #4#74 = #11#117;
     #4#75 = #11#119;
     #4#77 = #11#125;
     #4#60 = #11#127;
     #4#82 = #11#129;
     #4#83 = Usuario % 810;
     #4#84 = #11#130;
     #4#61 = #11#131;

     #4#85 = #2#111;
     #4#86 = #2#112;
     #4#87 = #2#113;
     #4#88 = #2#114;
     #4#89 = #2#115;
     #4#92 = #2#125;
     #4#93 = #2#126;
     #4#95 = #2#130;
     #4#96 = #2#131;
     aDivisa = #4#35;
     aMoneda = #4#37;
     |HAZ Divisas104;
|FPRC;

|PROCESO GrabaOfedConObs;
     |ABRE #6;
     |PARA nLin = 0; |SI nLin [ 98; |HACIENDO nLin = nLin + 1;
          #6#0 = #4#25;
          #6#1 = #4#0;
          #6#2 = nLin + 1;
          |LEE 101#6=;
          #6#3 = #11nLin;
          |SI FSalida = 0;
               |GRABA 020#6a;
          |SINO;
               |GRABA 020#6n;
          |FINSI;
          |LIBERA #6;
     |SIGUE;
     |CIERRA #6;
|FPRC;
------------------------------------------------
|PROCESO BorLinPed;
     |BORRA 020#5a;
     enForma = -1;
     |HAZ AcumulaPV_PCEG;
|FPRC;

|PROCESO BorraPedido;
     #4#25 = #2#60;
     #4#0 = #2#61;
     |LEE 121#4=;
     |SI FSalida = 0;
          |BUCLELIN 0 BorLinPed #4;
          enForma = -1;
          eaTag = "PE";  |HAZ RiesgosPCEG;
          |HAZ BorOfeCondObs;
          |BORRA 020#4a;
          |LIBERA #4;
     |FINSI;
|FPRC;

|PROCESO BorOfeCondObs;
     |ABRE #6;
     |PARA nLin = 1; |SI nLin [ 99; |HACIENDO nLin = nLin + 1;
          #6#0 = #4#25;
          #6#1 = #4#0;
          #6#2 = nLin;
          |BORRA 000#6c;
          |LIBERA #6;
     |SIGUE;
     |CIERRA #6;
|FPRC;
------------------------------------------------
|PROCESO AceptaOferta;
     #4#25 = #2#48;
     enSwMenu = 1;
     |HAZ ContaPe7;
     |GRABA 020#4b;
     |SI FSalida = 0;
          |HAZ CabOfePed;
          |BUCLELIN 2 LinOfePed #2;
          |HAZ GrabaOfedConObs;
          |GRABA 020#4a;
          |LIBERA #4;
          |HAZ CalCabpcegm004;
          enForma = 1;
          eaTag = "PE";  |HAZ RiesgosPCEG;

          #2#83 = "A";
          #2#60 = #4#25;
          #2#61 = #4#0;
          |GRABA 020#2a;

          |SI #11#110 ! 0;
               nCobro = #11#110;
               fFecCobro = #11#126;
               fFecVto = #11#126;
               aFP = #2#8;
               |HAZ EntregaPedido;
               |HAZ EntregaCartera;
          |FINSI;
     |FINSI;
     |LIBERA #4;
|FPRC;

|PROCESO GrabaPedConObs;
     |ABRE #6;
     |PARA nLin = 0; |SI nLin [ 98; |HACIENDO nLin = nLin + 1;
          #6#0 = #4#25;
          #6#1 = #4#0;
          #6#2 = nLin + 1;
          |LEE 101#6=;
          #6#3 = #13nLin;
          |SI FSalida = 0;
               |GRABA 020#6a;
          |SINO;
               |GRABA 020#6n;
          |FINSI;
          |LIBERA #6;
     |SIGUE;
     |CIERRA #6;
|FPRC;
------------------------------------------------

|PROCESO ConfirmaPedido;
     #4#4 = #13#99;
     #4#57 = #13#100;
     #4#65 = #13#101;
     #4#62 = #13#102;
     #4#66 = #13#103;
     |SI #4#37 = "D";
          #4#98 = #13#104;
          #4#67 = #4#98 / #4#36 * #4#41;
     |SINO;
          #4#67 = #13#104;
          #4#98 = #4#67 * #4#36 / #4#41;
     |FINSI;
     #4#19 = #13#105;
     #4#71 = #13#106;
     #4#72 = #13#107;
     #4#9 = #13#108;
     #4#73 = #13#111;
     #4#19 = #13#112;
     #4#14 = #13#113;
     #4#20 = #13#114;
     #4#59 = #13#115;
     #4#21 = #13#116;
     #4#74 = #13#117;
     #4#75 = #13#119;
     #4#8 = #13#123;
     #4#70 = "C";
     #4#84 = #13#125;
     #4#60 = #13#127;
     #4#61 = #13#126;
     #4#77 = #13#129;
     |HAZ GrabaPedConObs;

     |C_M #13#110, 0, aAlfa;           || Si no es modificable es que ya
     |SI #13#110 ! 0; |Y aAlfa = "S";  || tenia la entrega realizada
          nCobro = #13#110;
          fFecCobro = #13#130;
          fFecVto = #13#130;
          aFP = #4#9;
          |HAZ EntregaPedido;
          |HAZ EntregaCartera;
     |FINSI;
|FPRC;
------------------------------------------------
|PROCESO CalStockPed;
     |HAZ AcumulaPV_PCEG;
|FPRC;

|PROCESO CalStockPedido;
     |BUCLELIN 2 CalStockPed #4;
|FPRC;
------------------------------------------------
|PROCESO PedLinAlba;
     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = #5#1;
     #71#2 = #5#2;
     #71#3 = #5#3;
     #71#4 = #5#4;
     #71#5 = #5#5 - #5#59;
     |SI #71#5 < 0; |ACABA; |FINSI;
     #71#6 = #5#6;
     #71#8 = #5#8;
     #71#10 = #5#10;
     #71#11 = #5#14;
     #71#12 = #5#0;
     #71#13 = #5#18;
     #71#15 = #10#3;
     #71#16 = #5#17;
     #71#17 = #5#19;
     #71#21 = #5#1;
     #71#27 = #5#27;
     #71#31 = #5#28;
     #71#33 = #5#29;
     #71#34 = #5#35;
     #71#35 = #5#36;
     #71#36 = #5#38;
     #71#49 =  #5#45;

     |HAZ TotalLin71;
     |HAZ CalCabAgifa010;
     |GRABA 020#71n;

     #5#59 = #5#59 + #71#5;

     |SI aSirve = "S";
          #5#43 = #5#5;
     |FINSI;
     |GRABA 020#5a;
     |LIBERA #5;
|FPRC;

|PROCESO PedCabAlba;
     |DDEFECTO #20;
     |ABRE #20;
     #20#0 = #4#60;
     |LEE 000#20=;
     |CIERRA #20;
     |ABRE #24;
     #24#0 = #4#4;
     |LEE 000#24=;
     |CIERRA #24;

     #10#1 = ~;
     #10#3 = #4#4;
     #10#4 = #4#8;
     #10#5 = #4#5;
     #10#6 = #4#7;
     #10#7 = #4#6;
     #10#8 = #4#9;
     #10#9 = #20#1;
     #10#12 = #4#82;
     #10#29 = #4#19;
     #10#30 = #4#14;
     #10#31 = #4#20;
     #10#32 = #4#17;
     #10#33 = #4#21;
     #10#34 = #4#16;
     #10#35 = #4#18;
     #10#36 = #24#47;
     #10#37 = #24#41;
     #10#55 = #4#53;
     #10#56 = #4#54;
     #10#57 = #4#55;
     #10#62 = #4#59;
     #10#63 = #4#64;
     #10#64 = #4#61;
     #10#68 = #4#35;
     #10#69 = #4#36;
     #10#70 = #4#37;
     #10#73 = #4#40;
     #10#74 = #4#41;
     #10#83 = #4#51;
     #10#84 = #4#57;

     aDivisa = #10#68;
     aMoneda = #10#70;
     |HAZ Divisas010;

     |SI #4#37 = "D";         || Albaran Z
          |SI #4#98 ! #4#100;
               #10#81 = #4#98;
               #10#11 = #4#67;
               #4#100 = #4#98;
               #4#97 = #4#67;
          |FINSI;
     |SINO;
          |SI #4#67 ! #4#97;
               #10#81 = #4#98;
               #10#11 = #4#67;
               #4#100 = #4#98;
               #4#97 = #4#67;
          |FINSI;
     |FINSI;

     |HAZ LimCabAgifa010;

     |GRABA 020#4a;
     |LIBERA #4;
|FPRC;

|PROCESO PedCabFac;
     #134#1 = ~;
     #134#2 = #10#3;
     #134#3 = #10#4;
     #134#4 = #10#5;
     #134#5 = #10#32;
     #134#6 = #10#7;
     #134#7 = #10#6;
     #134#9 = #24#29;
     #134#10 = #24#30;
     #134#11 = #10#8;
     #134#12 = #24#16;
     #134#13 = #10#36;
     #134#14 = #24#22;
     #134#15 = #24#23;
     #134#16 = #24#24;
     #134#58 = #10#68;
     #134#59 = #10#69;
     #134#60 = #10#70;
     #134#61 = #10#73;
     #134#62 = #10#74;
     #134#63 = 1;
     #134#115 = #10#84;
     #134#124 = #10#63;

     aDivisa = #134#58;
     aMoneda = #134#60;
     |HAZ Divisas134;
|FPRC;

|PROCESO PedLinFac;
     |DDEFECTO #59;
     #59#14 = #134#49;
     #59#0 = #134#0;
     #59#1 = 1;
     #59#2 = #10#0;
     #59#15 = #10#52;
     #59#18 = #10#68;
     #59#19 = #10#69;
     #59#20 = #10#70;
     |GRABA 020#59n;
     |ABRE #19;
     |BUCLELIN 0 ActFac #10;
     |CIERRA #19;
|FPRC;

|PROCESO FacturaSinServ;
     |ABRE #10;
     |ABRE #71;
     |DDEFECTO #10;
     #10#52 = "Z" + #4#25;
     enSwMenu = 1;
     |HAZ ContaAV7;
     |GRABA 020#10b;

     |SI FSalida ! 0; |ACABA; |FINSI;
     |HAZ PedCabAlba
     aSirve = "N";
     |BUCLELIN 0 PedLinAlba #4;
     |GRABA 020#10a;
     |CIERRA #71;

     |ABRE #134;
     |ABRE #59;

     f = ~;
     aA¤o = f % -102;
     aAlfa = #4#25 % 102;
     aAlfa = aAlfa + aA¤o;
     #134#49 = aAlfa;
     enSwMenu = 1;
     |HAZ ContaFV7;
     |GRABA 020#134b;
     |SI FSalida ! 0; |ACABA; |FINSI;

     #10#53 = #134#49;
     #10#39 = #134#0;
     |GRABA 020#10a;
     |CIERRA #10;

     |HAZ PedCabFac;
     |HAZ PedLinFac;

     |HAZ CalCabAgifa134;
     |HAZ VenciVta;
     |GRABA 020#134a;
     |HAZ ActuaFa;
     |CIERRA #59;
     |CIERRA #134;
|FPRC;
------------------------------------------------
|PROCESO PedCabOfe;
     |ABRE #20;
     #20#0 = #4#60;
     |LEE 000#20=;
     |CIERRA #20;
     |ABRE #24;
     #24#0 = #4#4;
     |LEE 000#24=;
     |CIERRA #24;

     #2#1 = ~;
     #2#3 = #4#4;
     #2#4 = #4#8;
     #2#5 = #4#5;
     #2#6 = #4#7;
     #2#7 = #4#5;
     #2#8 = #4#9;
     #2#9 = #20#1;
     #2#11 = #4#67;
     #2#29 = #4#19;
     #2#30 = #4#14;
     #2#31 = #4#20;
     #2#32 = #4#17;
     #2#33 = #4#21;
     #2#34 = #4#16;
     #2#35 = #4#18;
     #2#36 = #24#47;
     #2#40 = #24#16;
     #2#65 = #4#35;
     #2#66 = #4#36;
     #2#67 = #4#37;
     #2#68 = #4#40;
     #2#69 = #4#41;
     #2#78 = #4#60;
     #2#80 = #4#57;
     #2#81 = #4#59;
     #2#86 = #4#64;
     #2#87 = #4#69;
     #2#88 = #4#71;
     #2#89 = #4#72;
     #2#98 = Usuario % 810;
     #2#102 = #4#77;
     #2#103 = ~;
     |HORA aAlfa;
     #2#104 = aAlfa;
     #2#106 = #4#73;
     #2#107 = #4#74;
     #2#108 = #4#75;
     #2#109 =  #4#77;
     |HAZ LimCabpcegm002;
|FPRC;

|PROCESO PedLinOfe;
     |DDEFECTO #3;
     #3#20 = #2#48;
     #3#0 = #2#0;
     #3#1 = #5#1;
     #3#2 = #5#2;
     #3#3 = #5#3;
     #3#4 = #5#4;
     #3#5 = #5#5;
     #3#6 = #5#6;
     #3#7 = #5#7;
     #3#8 = #5#8;
     #3#11 = #5#14;
     #3#13 = #5#18;
     #3#15 = #2#3;
     #3#16 = #5#17;
     #3#17 = #5#19;
     #3#18 = #5#27;
     #3#21 = #5#29;
     #3#22 = #5#35;
     #3#23 = #5#36;
     #3#29 = #5#45;

     |HAZ TotalLin002;
     |HAZ CalCabpcegm002;
     ||GRABA 020#2n;
     |GRABA 020#3n;
|FPRC;

|PROCESO CreaOfePedRecha;
     #2#48 = #4#25;
     enSwMenu = 1;
     |HAZ ContaOf7;
     |GRABA 020#2b;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |HAZ PedCabOfe;
     |BUCLELIN 2 PedLinOfe #4;
     |GRABA 020#2a;
     |LIBERA #2;


     FSalida = 0;
|FPRC;
------------------------------------------------
|PROCESO CheqAnula;
     |SI #5#43 ! 0; nHayServ = 1; |FINSI;
     |SI #5#60 ! 0; nHayRese = 1; |FINSI;
     |SI #5#59 ! 0; nHayFact = 1; |FINSI;
|FPRC;

|PROCESO CheqCobrado;
     nHay = 1;
|FPRC;

|DEFBUCLE CheqCobrado;
     #102#1;
     ;
     "P", #4#25, #4#0, 01;
     "P", #4#25, #4#0, 99;
     ;
     NULL, CheqCobrado;
|FIN;

|PROCESO AnulaAceOfertaLin;
     enForma = -1;
     |HAZ AcumulaPV_PCEG;
     |BORRA 020#5a;
|FPRC;

|PROCESO BorraObsPed;
     |BORRA 020#6a;
|FPRC;

|DEFBUCLE BorraObsPed;
     #6#1;
     ;
     #4#25, #4#0, 01;
     #4#25, #4#0, 99;
     be;
     NULL, BorraObsPed;
|FIN;

|PROCESO AnulaAceOferta;
     nOk = 0;
     #4#25 = #2#60;
     #4#0 = #2#61;
     |LEE 121#4=;
     |SI FSalida = 0;
          nHay = 0;
          |BUCLE CheqCobrado;
          |SI nHay ! 0;
               |MENAV "0000El pedido tiene importe cobrado...";
               nOk = 1;
          |FINSI;
          nHayRese = 0;
          nHayServ = 0;
          nHayFact = 0;
          |BUCLELIN 2 CheqAnula #4;
          |SI nHayRese ! 0;
               |MENAV "0000El pedido tiene unidades reservadas...";
               nOk = 1;
          |FINSI;
          |SI nHayServ ! 0;
               |MENAV "0000El pedido tiene unidades servidas...";
               nOk = 1;
          |FINSI;
          |SI nHayFact ! 0;
               |MENAV "0000El pedido tiene unidades facturadas...";
               nOk = 1;
          |FINSI;

          ||..................Anula
          |SI nOk = 0;
               |BUCLELIN 0 AnulaAceOfertaLin #4;
               enForma = 1;
               eaTag = "PE";  |HAZ RiesgosPCEG;
               |BUCLE BorraObsPed;
               |BORRA 020#4a;
          |FINSI;
     |FINSI;
     |LIBERA #4;
     FSalida = nOk;
|FPRC;
------------------------------------------------
|PROCESO AnulaAcePedido;
     nOk = 0;

     nHay = 0;
     |BUCLE CheqCobrado;
     |SI nHay ! 0;
          |MENAV "0000El pedido tiene importe cobrado...";
          nOk = 1;
     |FINSI;
     nHayRese = 0;
     nHayServ = 0;
     nHayFact = 0;
     |BUCLELIN 2 CheqAnula #4;
     |SI nHayRese ! 0;
          |MENAV "0000El pedido tiene unidades reservadas...";
          nOk = 1;
     |FINSI;
     |SI nHayServ ! 0;
          |MENAV "0000El pedido tiene unidades servidas...";
          nOk = 1;
     |FINSI;
     |SI nHayFact ! 0;
          |MENAV "0000El pedido tiene unidades facturadas...";
          nOk = 1;
     |FINSI;

     FSalida = nOk;
|FPRC;

|PROCESO PrecioComi;
     aAlfa = #2#1 % 402;
     mes = aAlfa;
     fed_dt = #2#1;   || Fecha....
     art_dt = #3#2;   || Articulo.
     cli_dt = #3#15;  || Cliente..
     fam_dt = #3#13;  || Familia.
     iva_dt = #19#30;  || Tipo Iva.
     dtos_2 = 0;      || Descuento 2.
     dto_pt = 0;      || Descuento Ptas.
     dtos_1 = 0;      || Descuento 1.
     pvp_ve = 0;      || Precio Venta.
     tarifa = #24#39;  || Tarifa Cliente....
     gru_dt = #24#158; || Grupo Cliente.
     uni_dt = #3#5;
     enMensaje = 0;
     aParam = "";
     eaSerie = #3#20;
     enDirEnt = #2#80;
     |SI #19#176 = "S";  enMensaje = 1;  |FINSI;
     enAlmacen = #3#3;

     enInterno = tarifa;
     |HAZ calcdtos;    || Calculo Dtos.....
     |SI eaCliArtDiviSN = "S";
          |SI eaCliArtDivi ! #2#65;
               aAlfa = "0000La divisa del documento ("+ #2#65 + ") no se corresponde con la oferta (" + eaCliArtDivi + ").";
               |MENAV aAlfa;
               |PTEC 807;     || Ctrl+C
          |SINO;
               pvp_ve = pvp_ve * #2#69 / #2#66; ||Cam.Base * Cambio
          |FINSI;
     |FINSI;
     eaCliArtDiviSN = "N";

     #3#34 = enInterno;

     #3#6   = pvp_ve;  || Precio Venta. sin iva.
     #3#8   = dtos_1;  || 1¦ Dto.
     #3#21  = dtos_2;  || 2§ Dto.

     enDescuento1 = #3#8;
     enDescuento2 = #3#21;
     eaTComision  = #3#16;
     eaCliente    = #2#3;
     eaArticulo   = #3#2;
     eaRepre      = #2#6;
     efFecha      = #2#1;
     eaSerie      = #3#20;
     enDirEnt = #2#80;
     enAlmacen = #3#3;
     #3#8   = enDescuento1;
     #3#10  = enComision;
     #3#6   = pvp_ve;  || Precio Venta. sin iva.
     #3#24 = #3#6 / #2#69 * #2#66;
     |SI #2#67 = "D";  || Si la moneda de trabajo es la divisa ...
          #3#6 = #3#24 / #2#66 * #2#69;  || ... recalculo en funcion de la divisa
     |SINO;
          #3#24 = #3#6 / #2#69 * #2#66; || .. recalculo en funcion de la moneda base
     |FINSI;
     |SI #2#67 = "D";  || Si la moneda de trabajo es la divisa ...
       #3#26 = #3#6;   || ... el campo visualiz. es el precio en moneda base
     |SINO;            || Si la moneda de trabajo es la moneda base ...
       #3#26 = #3#24;  || ... el campo visual. es el precio en divisa
     |FINSI;


     enDescuento1 = #3#8;
     enDescuento2 = #3#21;
     eaTComision  = #3#16;
     eaCliente    = #2#3;
     eaArticulo   = #3#2;
     eaRepre      = #2#6;
     eaSerie      = #3#20;
     enDirEnt = #2#80;
     enAlmacen = #3#3;
     |HAZ Comisiones;
     #3#10 = enComision;
|FPRC;

|PROCESO CreaOfeRepa;
     aSerRep = #42#0; |HAZ ModSerie;
     #2#48 = aSerRep;
     enSwMenu = 1;
     |HAZ ContaOf7;
     |GRABA 020#2b;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #20;
     #20#0 = #42#20;
     |LEE 020#20=;
     |CIERRA #20;
     |ABRE #24;
     #24#0 = #42#3;
     |LEE 020#24=;
     |CIERRA #24;
     |ABRE #25;
     #25#0 = #24#25;
     |LEE 020#25=;
     |CIERRA #25;
     |ABRE #30;
     #30#0 = #42#3;
     #30#1 = #42#5;
     |LEE 020#30=;
     |CIERRA #30;

     #2#3 = #24#0;
     #2#4 = #24#2;
     #2#5 = #24#37;
     #2#6 = #24#25;
     #2#7 = #24#38;
     #2#8 = #24#20;
     #2#9 = #20#1;
     #2#29 = #30#10;
     #2#30 = #30#2;
     #2#31 = #30#3;
     #2#32 = #24#156;
     #2#33 = #30#7;
     #2#34 = #25#7;
     #2#35 = #24#4;
     #2#36 = #24#47;
     #2#40 = #24#16;
     #2#65 = #24#192;
     |ABRE #324;
     #324#0 = #2#65;
     |LEE 020#324=;
     #2#66 = #324#2;
     #2#67 = #24#193;
     #2#68 = #321#9;
     #324#0 = #2#68;
     |LEE 020#324=;
     #2#69 = #324#2;
     #2#78 = #20#0;
     #2#80 = #30#1;
     #2#81 = #30#6;
     #2#84 = #42#14;
     #2#85 = #24#208;
     #2#86 = #24#15;
     #2#87 = #30#22;
     #2#88 = #30#24;
     #2#89 = #30#21;
     #2#98 = Usuario % 810;
     #2#130 = #42#0;
     #2#131 = #42#1;

     |ABRE #40;
     #40#0 = #2#48;
     #40#1 = #2#0;
     #40#2 = 1;
     #40#3 = eaTexto;
     |GRABA 020#40n;

     |ABRE #19;
     #19#0 = #42#7;
     |LEE 020#19=;
     |CIERRA #19;
/* Se crea sin lineas
     |DDEFECTO #3;
     #3#20 = #2#48;
     #3#0 = #2#0;
     #3#1 = 1;
     #3#2 = #19#0;
     #3#3 = 1;
     #3#4 = #42#8;
     #3#5 = 1;
     |HAZ PrecioComi;
     ||#3#6
     ||#3#10
     #3#11 = #19#30;
     #3#13 = #19#2;
     #3#14 = #19#9;
     #3#15 = #2#3;
     #3#16 = #2#34;
     #3#17 = #2#35;
     #3#24 = #3#6;
     |HAZ TotalLin002;
     |HAZ CalCabpcegm002;
     |GRABA 020#3n;
*/
     |GRABA 020#2a;
     |LIBERA #2;

     FSalida = 0;
|FPRC;
----------------------------------------------
|PROCESO CreaLinAlb0;
     |DDEFECTO #19;
     #19#0 = #42#7;
     |LEE 000#19=;

     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = 1;
     #71#2 = #42#7;
     #71#3 = 1;
     #71#4 = #42#8;
     #71#11 = #19#30;
     #71#13 = #19#2;
     #71#15 = #10#3;
     |GRABA 020#71n;
|FPRC;

|PROCESO AlbFac00;
     #10#52 = aSerie;
     enSwMenu = 1;
     |HAZ ContaAV7;
     |GRABA 020#10b;
     |PARA; |SI FSalida ! 0; |HACIENDO;
          #10#0 = #10#0+ 1;
          |GRABA 020#10b;
     |SIGUE;

     #10#1 = ~;
     #10#3 = #24#0;
     #10#4 = #24#2;
     #10#6 = #24#25;
     #10#8 = #24#20;
     #10#9 = #42#21;
     #10#29 = #30#10;
     #10#30 = #30#2;
     #10#31 = #30#3;
     #10#33 = #30#7;
     #10#62 = #30#6;
     #10#63 = #24#15;
     #10#68 = #24#192;
     #10#70 = #24#193;
     #10#73 = #321#9;
     #10#84 = #30#1;
     #10#88 = #42#20;
     |GRABA 020#10a;
     |ABRE #19;
     |ABRE #71;
     |HAZ CreaLinAlb0;
     |CIERRA #71;
     |CIERRA #19;
     |LIBERA #10;
|FPRC;

|PROCESO ModSerie;
     aAlfa = aSerRep % 102;
     fFecha = ~;
     aAlfa = aAlfa + (fFecha % -102);
     aSerRep = aAlfa;
|FPRC;

|PROCESO AlbFac0;
     |DDEFECTO #24;
     |ABRE #24;
     #24#0 = #42#3;
     |LEE 000#24=;
     |CIERRA #24;

     |DDEFECTO #30;
     |ABRE #30;
     #30#0 = #24#0;
     #30#1 = 1;
     |LEE 000#30=;
     |CIERRA #30;

     aSerRep = #42#0; |HAZ ModSerie;

     |ABRE #10;
     aSerie = aSerRep; |HAZ AlbFac00
     aSerSal = #10#52; nNumSal = #10#0;
     |SALVA_DATOS #10;
     aSerie = "Z" + aSerRep; |HAZ AlbFac00
     |ABRE #16;
     #16#0 = #10#52;
     #16#1 = #10#0;
     #16#2 = aSerSal;
     #16#3 = nNumSal;
     |GRABA 020#16n;

     aAlfa = "*pcegz027;FACTURAR" + #10#52 + (("000000" + #10#0)%-106);
     |SUB_EJECUTA_NP aAlfa;
     aAlfa = #10#52 + "/" + (("000000" + #10#0) % -106);

     |LEE 020#10=;
     eaSerFac = #10#53;
     enNumFac = #10#39;

     |REPON_DATOS #10;
     |LEE 121#10=;
     |SI FSalida = 0;
          #10#55 = aAlfa;
          |GRABA 020#10a;
          |LIBERA #10;
     |FINSI;

     |CONFI "0000N¿Desea Imprimir el Albaran?";
     |SI FSalida = 0;
          eaImpresora = "CrystalReport";
          ser_alb = #10#52;
          num_alb = #10#0;
          |SUB_EJECUTA_NP "agifa014";   || Imp Alb
     |FINSI;


     |CIERRA #10;

     |ABRE #44;
     #44#0 = eaSerFac;
     #44#1 = enNumFac;
     |LEE 101#44=;
     |SI FSalida ! 0; |GRABA 020#44b; |FINSI;
     #44#2 = eaTexto;
     |GRABA 020#44a;
     |CIERRA #44;

     enError = 0;
|FPRC;

|PROCESO CreaLinCSV;
     aAlfa = "|NC"; aAlfa = #5aAlfa;
     nCampos = aAlfa;
     |PARA i = 0; |SI i < nCampos; |HACIENDO i = i + 1;
          aAlfa = "|C" + (("000" + i) % -103) + "TIPO";
          aAlfa = #4aAlfa;
          |SI aAlfa = "A";
               aDato = &34 + #4i + &34;
          |SINO;
               aDato = #5i;
          |FINSI;
          nNume = i - 1;
          |SI nNume < nCampos; aDato = aDato + ","; |FINSI;
          |XGRABA nHandle, aDato
     |SIGUE;
      aDato = &13; aDato = aDato + &10;
      |XGRABA nHandle, aDato;
|FPRC;

|PROCESO EnvioAlemania;
     |ABRE #38; |LEE 000#38p; |CIERRA #38;
     aFic = #4#25; |QBF aFic;
     aFic = aFic + (("000000" + #4#0) % -106) + ".csv";
     |DFICE aPath;
     aOrg = aPath + aFic;
     |XABRE "WB", aOrg, nHandle;
     |SI FSalida ] 0;
          aAlfa = "|NC"; aAlfa = #4aAlfa;
          nCampos = aAlfa;
          |PARA i = 0; |SI i < nCampos; |HACIENDO i = i + 1;
               aAlfa = "|C" + (("000" + i) % -103) + "TIPO";
               aAlfa = #4aAlfa;
               |SI aAlfa = "A";
                    aDato = &34 + #4i + &34;
               |SINO;
                    aDato = #4i;
               |FINSI;
               nNume = i - 1;
               |SI nNume < nCampos; aDato = aDato + ","; |FINSI;
               |XGRABA nHandle, aDato
          |SIGUE;
          aDato = &13; aDato = aDato + &10;
          |XGRABA nHandle, aDato;
          |BUCLELIN 2 CreaLinCSV #4;
          |XCIERRA nHandle;

          aPath = #38#7; |QBF aPath;
          aAlfa = aPath % -101;
          |SI aAlfa ! "/"; |Y aAlfa ! "\"; aPath = aPath + "/"; |FINSI;
          aDes = aPath + aFic;

          aAlfa = "";
          |IP_REMOTO aAlfa;
          |SI aAlfa = "";
               |MKDIR aPath;
               |COPIA_FICHERO aOrg, aDes;
          |SINO;
               |RMKDIR aPath;
               |ENVIA_FICHERO aOrg, aDes;
          |FINSI;
          |FBORRA aOrg;

          FSalida = 0;
     |SINO;
          |MENAV "0000Error al crear fichero csv";
          FSalida = 1;
     |FINSI;
|FPRC;
