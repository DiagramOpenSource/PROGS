|FICHEROS;
     sctrz097 #0;
     sctrw027 #27;
     sctrm052 #52;
     sctrm053 #53;
     sctrm074 #74;
     sctrm079 #79;
     sctrm080 #80;
     sctrm081 #81;

     sctrz093 #93;
|FIN;

|VARIABLES;
     &eaEsCambioTari = "";
     &Tempo = "";
     aError = "";
     nError = 0;
     nRegistro = 0;
     aTari = "";
     nGrupo = 0;
     nImpAntes = 0;
     nImpNuevo = 0;
     aTmp27 = "";
     aTmp28 = "";
     aTmp80 = "";
     aTmp81 = "";
     nPaxs = 0;
     nNume = 0;
     aParam = "";
     aDes = "";
     aPath = "";
     nHandle = 0;
     i = 0;
     aDato = "";
     aLon = "";
     nPos = 0;
     aLetra = "";
     aReg = "";
     aTab = "";
 {99}Valor = "";
     nCampo = 0;
     aNomFic = "";
     aAlfa = "";
|FIN;

|PROCESO ConsultaTari;
|FPRC;

|PROCESO BuscaGrupo;
     aAlfa = #81#3 % 102;
     nNume = aAlfa;
     |SI nNume = nGrupo;
          nRegistro = #81#1;
          aTari = #81#3;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaGrupo;
     #81#1;
     ;
     #79#0, 00, "       ";
     #79#0, 99, "zzzzzzz";
     be;
     NULL, BuscaGrupo;
|FIN;

|PROCESO Graba27;
     |PARA i = 0; |SI i [ 19; |HACIENDO i = i + 1;
          nCampo = i + 2;
          #27i = #80nCampo;
     |SIGUE;
     |GRABA 020#27n;
|FPRC;

|DEFBUCLE Graba27;
     #80#1;
     ;
     #79#0, 01;
     #79#0, 99;
     ;
     NULL, Graba27;
|FIN;

|PROCESO Borra81;
     |BORRA 020#81a;
|FPRC;

|DEFBUCLE Borra81;
     #81#1;
     ;
     #79#0, 00, "       ";
     #79#0, 99, "zzzzzzz";
     be;
     NULL, Borra81;
|FIN;

|PROCESO GrabaResultado;
     |DFICE aPath;
     aDes = aPath + aNomFic + ".sal";
     |XABRE "W", aDes, nHandle;
     |SI FSalida ] 0;
          aDato = "error" + aTab;
          aDato = aDato + "cerror" + aTab;
          aDato = aDato + "importe_antes" + aTab;
          aDato = aDato + "importe_nuevo" + aTab;
          |XGRABA nHandle, aDato;

          aDato = aError + aTab;
          aDato = aDato + nError + aTab;
          aDato = aDato + nImpAntes + aTab;
          aDato = aDato + nImpNuevo + aTab;
          |XGRABA nHandle, aDato;

          |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROCESO Dato;
     nCampo = 1;
     IValor = Valor1<-;
     aLon = aDato % A0;
     aReg = "";
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aLetra = aDato % nPos;
          |SI aLetra = aTab;
               |SI aReg = "None"; aReg = ""; |FINSI;
               Valor = aReg;
               aReg = "";
               nCampo = nCampo + 1;
               IValor = IValor + 1;
          |SINO;
               aReg = aReg + aLetra;
          |FINSI;
          |SI nCampo > 90; |SAL; |FINSI;     || Por si.... :)
     |SIGUE;
     |SI aReg = "None"; aReg = ""; |FINSI;
     Valor = aReg;
|FPRC;

|PROCESO LeePeticion;
    |DFICE aPath;
     aDes = aPath + aNomFic + ".ent";

     |XABRE "", aDes, nHandle;
     |SI FSalida ] 0;
          |XLEE nHandle, 250, aDato;    || los nombres
          |XLEE nHandle, 250, aDato;
          |HAZ Dato;
          |XCIERRA nHandle;

          #0#0 = Valor1;
          #0#1 = Valor2;
          #0#2 = Valor3;
     |FINSI;
|FPRC;

|PROGRAMA;
     aParam = PARAMETRO; |QBF aParam;
     aTab = &9;


     |HAZ CreaTempo; |NOME_DAT #27 Tempo; |DELINDEX #27; aTmp27 = Tempo; |ABRE #27;

     |SI aParam = "menu";
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
          || aParam = "valor a debugar";
          |DEBUG;
     |FINSI;

     aNomFic = aParam;
     |HAZ LeePeticion;

     eaEsCambioTari = "S";

     |ABRE #79;
     |SELECT #2#79;
     #79#18 = #0#0;
     |LEE 000#79=;
     |SI FSalida = 0;
          |ABRE #80;
          |ABRE #81;
          /* para simular al sctrz093 */
          |BUCLE Borra81;
          |BUCLE Graba27;
          |PARA i = 1; |SI i [ 16; |HACIENDO i = i + 1;
               #93i = #79i;
          |SIGUE;
          #93#17 = #79#21;

          #80#0 = #79#0;
          #80#1 = #79#19;
          |LEE 000#80=;
          /* */

          |HAZ BuscaTarifa;

          |ABRE #74;
          |SELECT #2#74;      || Equivalentes de grupos
          #74#0 = "999999";
          #74#3 = #0#2;
          |LEE 000#74=;
          |SI FSalida ! 0; |DDEFECTO #74; |FINSI;
          |CIERRA #74;

          nGrupo = #74#1;
          |BUCLE BuscaGrupo;

          |SI aTari = "";
               nError = 53;
               aError = "No existe tarifa.";
          |SINO;
               |ABRE #81;
               #81#0 = #79#0;
               #81#1 = nRegistro;
               #81#3 = aTari;
               |LEE 000#81=;
               |CIERRA #81;

               |ABRE #52;
               |ABRE #53;
               #52#0 = #0#1;
               |LEE 101#52=;
               |SI FSalida = 0;
                    #53#0 = #52#0;
                    #53#1 = 1;
                    |LEE 101#53=;
                    |SI FSalida = 0;
                         nImpAntes = #52#32;
                         |HAZ ActualizaReserva;
                         nImpNuevo = #52#32;

                         |HAZ ActualizaTodas;
                    |SINO;
                         nError = 53;
                         aError = "No existe paxs reserva.";
                    |FINSI;
               |SINO;
                    nError = 52;
                    aError = "No existe reserva.";
               |FINSI;
               |CIERRA #52;
               |CIERRA #53;
          |FINSI;
          |HAZ GrabaResultado;
          |CIERRA #81;
          |CIERRA #80;
     |SINO;
          |ABRE #52;
          |ABRE #53;
          #52#0 = #0#1;
          |LEE 000#52=;
          |SI FSalida = 0;
               #53#0 = #52#0;
               #53#1 = 1;
               |LEE 000#53=;
               |SI FSalida = 0;
                    |HAZ CreaTempo; |NOME_DAT #80 Tempo; |DELINDEX #80; aTmp80 = Tempo; |ABRE #80;
                    |HAZ CreaTempo; |NOME_DAT #81 Tempo; |DELINDEX #81; aTmp81 = Tempo; |ABRE #81;

                    |HAZ BuscaTarifaGes;

                    |ABRE #74;
                    |SELECT #2#74;      || Equivalentes de grupos
                    #74#0 = "999999";
                    #74#3 = #0#2;
                    |LEE 000#74=;
                    |SI FSalida ! 0; |DDEFECTO #74; |FINSI;
                    |CIERRA #74;

                    nGrupo = #74#1;
                    |BUCLE BuscaGrupo;

                    |SI aTari = "";
                         nError = 53;
                         aError = "No existe tarifa.";
                    |SINO;
                         |ABRE #81;
                         #81#0 = #79#0;
                         #81#1 = nRegistro;
                         #81#3 = aTari;
                         |LEE 000#81=;
                         |CIERRA #81;

                         #52#0 = #0#1;
                         |LEE 101#52=;

                         #53#0 = #52#0;
                         #53#1 = 1;
                         |LEE 101#53=;

                         nImpAntes = #52#32;
                         |HAZ ActualizaReserva;
                         nImpNuevo = #52#32;

                         |HAZ ActualizaTodasGes;
                    |FINSI;
                    |CIERRA #81; |DELINDEX #81; Tempo = aTmp81; |HAZ BoraTempo;
                    |CIERRA #80; |DELINDEX #80; Tempo = aTmp80; |HAZ BoraTempo;
               |SINO;
                    nError = 53;
                    aError = "No existe paxs reserva.";
               |FINSI;
          |SINO;
               nError = 52;
               aError = "No existe reserva.";
          |FINSI;
          |CIERRA #53;
          |CIERRA #52;
          |HAZ GrabaResultado;
     |FINSI;
     |CIERRA #79;
     |CIERRA #27; |DELINDEX #27; Tempo = aTmp27; |HAZ BoraTempo;
|FPRO;
