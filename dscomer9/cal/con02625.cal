|FICHEROS;
     con02625 #0;
     con00625 #1;
     con00626 #2;
     agifa065 #3;
     con01625 #5; ||Texto inicial
     con00634 #6; || Texto explicativo
     agifa007 #7;
     agifa017 #9;
     agifa019 #11;
     agifa065 #65;
     con00682 #682;
     con00612 #612; || Relacion albaran/orden
|FIN;

|VARIABLES;
     &nDeci_Taller = 0;
     &nDeci_PreOR = 0;

     nError = 0;
     numero = 0;
     aAlfa = "";
     nOrd = 0;
     nEmpre = 0;
     aSerAlb = "";
     nNumAlb = 0;
     &enUniVta = 0;
     &enUniSal = 0;
     &eaArticulo = "";
     &enAlmacen = 0;
     &enAlmaSer = 0;
     &efFecha = @;
     fmes = "";
     mes = 0;
|FIN;

|PROCESO LeeSerie;
     |ABRE #7;
     #7#26 = #1#0;
     |LEE 000#7=;
     |CIERRA #7;
     enAlmaSer = #7#29;
|FPRC;

|PROCESO Stock;
     |HAZ LeeSerie;

     |DDEFECTO #11;
     |ABRE #11;
     #11#0 = #2#2;
     |LEE 101#11=;
     |SI FSalida ! 0; |GRABA 020#11b; |FINSI;

     |ABRE #9;
     |DDEFECTO #9;
     #9#0 = #2#2;
     #9#1 = enAlmaSer;
     |LEE 101#9=;
     |SI FSalida ! 0; |GRABA 011#9b; |FINSI;

     #9#39 = #9#39 - #2#4;
     #9#5 = #9#5 - #2#4;
     fmes = #1#2 % A402;
     mes = fmes - 1;
     mes = mes * 2;
     mes = mes + 11;
     #9mes = #9mes + #2#4; ||salida mensual
     #9#35 = #9#35 + #2#4; ||salida anual

     #11#6 = #11#6 - #2#4;
     #11#104 = #11#104 - #2#4;
     fmes = #1#2 % A402;
     mes = fmes - 1;
     mes = mes * 5;
     mes = mes + 34;
     #11mes = #11mes + #2#4;
     #11#94 = #11#94 + #2#4;

     |HAZ ValoraStock;
     |GRABA 021#11a;
     |GRABA 021#9a;
     |CIERRA #11;
     |CIERRA #9;

     enUniVta = #2#4;
     enUniSal = #2#4;
     eaArticulo = #2#2;
     enAlmacen = enAlmaSer;
     efFecha = #1#2;
     |HAZ AcumulaArt;
     |HAZ AcumulaAlm;
|FPRC;

|PROCESO Opera; |TIPO 0;
     |DDEFECTO #1;
     |ABRE #1;
     #1#0 = #0#0;
     #1#1 = #0#1;
     |LEE 000#1=;
     |CIERRA #1;

     |SI #1#16 ! 0; |Y #1#16 ! 999999;
          aAlfa = "0000Orden Facturada: " + #1#15 + "/" + #1#16;
          |MENAV aAlfa;
          |SI #0#5 = "M";
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO cambia_li;
     |SI nEmpre = 0;
          nEmpre = #2#34;
          aSerAlb = #2#25;
          nNumAlb = #2#26;
     |FINSI;

     #2#0 = #0#2;
     #2#1 = #0#3;
     |BORRA 000#2c;
     |SI #0#5 = "D";
          #2#25 = "";
          #2#26 = 0;
          #2#27 = 0;
          #2#34 = 0;
          #2#35 = "";
          #2#36 = 0;
          #2#37 = "01.01.0000";
          #2#38 = "";
          |GRABA 020#2n;
          |SI #2#9 = 2; |O #2#9 = 4;
               |HAZ Stock;
          |FINSI;
     |SINO;
          |BORRA 020#2a;
          |GRABA 020#2n;
     |FINSI;
|FPRC;

|DEFBUCLE cambia_li;
     #2#1;
     ;
     #0#0 , #0#1 , 0001;
     #0#0 , #0#1 , 9999;
     ;
     NULL , cambia_li;
|FIN;

|PROCESO cambia_li_texto;
     #6#0 = #0#2;
     #6#1 = #0#3;
     |BORRA 000#6c;
     |SI #0#5 = "D";
          |GRABA 020#6n;
     |SINO;
          |BORRA 020#6a;
          |GRABA 020#6n;
     |FINSI;
|FPRC;

|DEFBUCLE cambia_li_texto;
     #6#1;
     ;
     #0#0 , #0#1 , 001;
     #0#0 , #0#1 , 999;
     ;
     NULL , cambia_li_texto;
|FIN;

|PROCESO Ordenes;
     |BUCLE cambia_li;
     |BUCLE cambia_li_texto;
     |ABRE #5;
     #5#0 = #1#0;
     #5#1 = #1#1;
     |LEE 001#5=;
     |SI FSalida = 0;
          #5#0 = #0#2;
          #5#1 = #0#3;
          |BORRA 000#5c;
          |SI #0#5 = "D";
               |GRABA 020#5n;
          |SINO;
               |BORRA 020#5a;
               |GRABA 020#5n;
          |FINSI;
     |FINSI;
     |LIBERA #5;
     |CIERRA #5;
     #1#0 = #0#2;
     #1#1 = #0#3;
     |BORRA 000#1c;
     |SI #0#5 = "D";
          #1#17 = "01.01.0000";
          #1#15 = "";
          #1#16 = "";
          |GRABA 020#1n;
     |SINO;
          |BORRA 020#1a;
          |GRABA 020#1n;
     |FINSI;
     |LIBERA #1;
|FPRC;

|DEFBUCLE Ordenes;
     #1#1;
     ;
     #0#0 , #0#1;
     #0#0 , #0#1;
     be;
     NULL , Ordenes;
|FIN;

|PROCESO agifa065;
     |SI #0#5 = "M";
          |BORRA 020#65a;
     |FINSI;
     #65#11 = #0#2;
     #65#3 = #0#3;
     |GRABA 020#65n;
|FPRC;

|DEFBUCLE agifa065;
     #65#1;
     ;
     "                    ", "01.01.0000", "OR", nOrd, 00001, #0#0;
     "zzzzzzzzzzzzzzzzzzzz", "31.12.9999", "OR", nOrd, 99999, #0#0;
     be;
     NULL, agifa065;
|FIN;

|PROCESO con00682;
     #682#4 = #0#2;
     #682#5 = #0#3;
     |GRABA 020#682a;
     |LIBERA #682;
|FPRC;

|DEFBUCLE con00682;
     #682#2;
     ;
     #0#0, #0#1, " ";
     #0#0, #0#1, "z";
     be;
     NULL, con00682;
|FIN;

|PROCESO Chequea;
     |SI #0#0 = #0#2; |Y #0#1 = #0#3; |Y FSalida ! 2;
          |MENAV "0000El origen y el destino no puede ser igual";
          nError = 1;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO tipo3; |TIPO 3;
     |HAZ TallerDeci;

     nOrd = #0#1;
     |SI #0#4 = "S"; |Y nError = 0;
          |BUCLE Ordenes;
          |SI #0#5 = "M";
               |BUCLE agifa065;
               |BUCLE con00682;
               |SI nEmpre ! 0;
                    |DBASE aAlfa;
                    aAlfa = aAlfa + "fich/" + (("00000" + nEmpre) % -105) + "/";
                    |PATH_DAT #612 aAlfa;
                    |ABRE #612;
                    #612#0 = aSerAlb;
                    #612#1 = nNumAlb;
                    |LEE 101#612=;
                    |SI FSalida = 0;
                         #612#2 = #0#2;
                         #612#3 = #0#3;
                         |GRABA 020#612a;
                    |FINSI;
                    |CIERRA #612;
               |FINSI;
          |SINO;
               |BUCLE agifa065;
          |FINSI;
     |FINSI;
|FPRC;
