     || copiado del con00642

|FICHEROS;
  ||con00642 #0;   || Lineas Facturas  ( se usan como temporales)
  con00637 #1;   || Cabecera Facturas  ( igual)
  con00625 #2;   || Ordenes de Reparacion
  con00626 #3,MANTE;   || Lineas de OR
  con00603 #63;
  agifa019 #11;
  con00606 #66;
  agifa007 #23;
  con00703 #703;
  con00683 #683;
  referen@;
|FIN;

|VARIABLES;
     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;
     &enTotal = 0;
     tipo_iva = 0;
     expor = "";
     &enLineaRie = 0;
     aAlfa = "";

     FEstado = 0;
|FIN;

|PROCESO CalculaTotal0;
     expor = "N";
     |ABRE #23;
     #23#0 = #3#0;
     |LEE 010#23=;
     |SI #23#30 = "S";
          expor = "S";
     |FINSI;
     |CIERRA #23;

     |SI #3#14 = "N";
          |SI #3#11 ] 1; |Y #3#11 [ 999; ||\\ mano de obra;
               #1#19 = #1#19 + #3#8;
               ||#0#5 = #0#5 + #3#8;
               #63#0 = #3#2;
               |LEE 000#63=;
               |SI FSalida ! 0; |DDEFECTO #63; |FINSI;
               tipo_iva = #63#5;
               |LIBERA #63;
          |FINSI;
          |SI #3#11 ] 1000; |Y #3#11 [ 1999; ||Piezas;
               #1#16 = #1#16 + #3#8;
               ||#0#5 = #0#5 + #3#8;
               #11#0 = #3#2;
               |LEE 000#11=;
               |SI FSalida ! 0 ; |DDEFECTO #11; |FINSI;
               tipo_iva = #11#30;
               |LIBERA #11;
          |FINSI;
          |SI #3#11 ] 2000; |Y #3#11 [ 2999; || S.exte;
               #1#18 = #1#18 + #3#8;
               ||#0#5 = #0#5 + #3#8;
               #66#0 = #3#2;
               |LEE 000#66=;
               |SI FSalida ! 0 ; |DDEFECTO #66; |FINSI;
               tipo_iva = #66#4;
               |LIBERA #66;
          |FINSI;
          |SI #3#11 ] 3000; |Y #3#11 [ 3999; ||lubricante;
                #1#17 = #1#17 + #3#8;
                ||#0#5 = #0#5 + #3#8;
                #11#0 = #3#2;
                |LEE 000#11=;
                |SI FSalida ! 0 ; |DDEFECTO #11; |FINSI;
                tipo_iva = #11#30;
                |LIBERA #11;
          |FINSI;
          ||\\ EN FUNCION DEL TIPO DE IVA ACUMULAR EN BASE 1 O BASE 2
          |SI expor = "N";
               enTiva = tipo_iva;
               efFiva = #1#2;
               |HAZ SacaIVA;
               |SI tipo_iva = 1;
                   #1#7 = #1#7 + #3#8;
                   #1#8 = tipo_iva;
                   #1#9 = enIva;
                   ||#0#6 = #0#6 + (#3#8 %  #1#9);
                   #1#10 = #1#10 + (#3#8 % #1#9);
               |FINSI;
               |SI tipo_iva = 2;
                   #1#23 = #1#23 + #3#8;
                   #1#24 = tipo_iva;
                   #1#25 = enIva;
                   ||#0#6 = #0#6 + (#3#8 %  #1#25);
                   #1#26 = #1#26 + (#3#8 %  #1#25);
               |FINSI;
               |SI tipo_iva = 0;
                    #1#6 = #1#6 + #3#8;
               |FINSI;
          |SINO;
               #1#6 = #1#6 + #3#8;
          |FINSI;
          ||#0#7 = #0#5 + #0#6;
     |FINSI;

     |SI #3#14 = "I";    ||importe interno
          |SI #2#7 = "VN";|O #2#7 = "VO";
               #1#11 = #1#11 + #3#8;
          |FINSI;
          ||#0#5 = #0#5 + #3#8;
          ||#0#7 = #0#6 + #0#5;
     |FINSI;
     #1#11 = #1#6 + #1#7 + #1#10 + #1#23 + #1#26;
     enTotal = #1#11;
|FPRC;

|DEFBUCLE CalculaTotal0;
     #3#1;
     ;
     #2#0 , #2#1 ,   1;
     #2#0 , #2#1 , 9999;
     ;
     NULL , CalculaTotal0;
|FIN;

|PROCESO CalculaTotal;
     ||DDEFECTO #0;
     |DDEFECTO #1;
     |ABRE #63;
     |ABRE #11;
     |ABRE #66;
     |BUCLE CalculaTotal0;
     |CIERRA #66;
     |CIERRA #11;
     |CIERRA #63;
|FPRC;
----------------------------------------------------------------
|PROCESO CalculaTotalRef0;
     expor = "N";
     |ABRE #23;
     #23#0 = #3#0;
     |LEE 010#23=;
     |SI #23#30 = "S";
          expor = "S";
     |FINSI;
     |CIERRA #23;

     |SI #referen@#11 = enLineaRie;
          |ACABA;
     |FINSI;
     |SI #referen@#14 = "N";
          |SI #referen@#11 ] 1; |Y #referen@#11 [ 999; ||\\ mano de obra;
               #1#19 = #1#19 + #referen@#8;
               ||#0#5 = #0#5 + #referen@#8;
               #63#0 = #referen@#2;
               |LEE 000#63=;
               |SI FSalida ! 0; |DDEFECTO #63; |FINSI;
               tipo_iva = #63#5;
               |LIBERA #63;
          |FINSI;
          |SI #referen@#11 ] 1000; |Y #referen@#11 [ 1999; ||Piezas;
               #1#16 = #1#16 + #referen@#8;
               ||#0#5 = #0#5 + #referen@#8;
               #11#0 = #referen@#2;
               |LEE 000#11=;
               |SI FSalida ! 0 ; |DDEFECTO #11; |FINSI;
               tipo_iva = #11#30;
               |LIBERA #11;
          |FINSI;
          |SI #referen@#11 ] 2000; |Y #referen@#11 [ 2999; || S.exte;
               #1#18 = #1#18 + #referen@#8;
               ||#0#5 = #0#5 + #referen@#8;
               #66#0 = #referen@#2;
               |LEE 000#66=;
               |SI FSalida ! 0 ; |DDEFECTO #66; |FINSI;
               tipo_iva = #66#4;
               |LIBERA #66;
          |FINSI;
          |SI #referen@#11 ] 3000; |Y #referen@#11 [ 3999; ||lubricante;
                #1#17 = #1#17 + #referen@#8;
                ||#0#5 = #0#5 + #referen@#8;
                #11#0 = #referen@#2;
                |LEE 000#11=;
                |SI FSalida ! 0 ; |DDEFECTO #11; |FINSI;
                tipo_iva = #11#30;
                |LIBERA #11;
          |FINSI;
          ||\\ EN FUNCION DEL TIPO DE IVA ACUMULAR EN BASE 1 O BASE 2
          |SI expor = "N";
               enTiva = tipo_iva;
               efFiva = #1#2;
               |HAZ SacaIVA;
               |SI tipo_iva = 1;
                   #1#7 = #1#7 + #referen@#8;
                   #1#8 = tipo_iva;
                   #1#9 = enIva;
                   ||#0#6 = #0#6 + (#referen@#8 %  #1#9);
                   #1#10 = #1#10 + (#referen@#8 % #1#9);
               |FINSI;
               |SI tipo_iva = 2;
                   #1#23 = #1#23 + #referen@#8;
                   #1#24 = tipo_iva;
                   #1#25 = enIva;
                   ||#0#6 = #0#6 + (#referen@#8 %  #1#25);
                   #1#26 = #1#26 + (#referen@#8 %  #1#25);
               |FINSI;
               |SI tipo_iva = 0;
                    #1#6 = #1#6 + #referen@#8;
               |FINSI;
          |SINO;
               #1#6 = #1#6 + #referen@#8;
          |FINSI;
          ||#0#7 = #0#5 + #0#6;
     |FINSI;

     |SI #referen@#14 = "I";    ||importe interno
          |SI #2#7 = "VN";|O #2#7 = "VO";
               #1#11 = #1#11 + #referen@#8;
          |FINSI;
          ||#0#5 = #0#5 + #referen@#8;
          ||#0#7 = #0#6 + #0#5;
     |FINSI;
     #1#11 = #1#6 + #1#7 + #1#10 + #1#23 + #1#26;
     enTotal = #1#11;
|FPRC;

|DEFBUCLE CalculaTotalRef0;
     #referen@#1003;
     ;
     #2#0 , #2#1 ,   1;
     #2#0 , #2#1 , 9999;
     ;
     NULL , CalculaTotalRef0;
|FIN;

|PROCESO CalculaTotalRef;
     |DDEF aAlfa;
     aAlfa = aAlfa + "con00626";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     ||DDEFECTO #0;
     |DDEFECTO #1;
     |ABRE #63;
     |ABRE #11;
     |ABRE #66;
     |BUCLE CalculaTotalRef0;
     |CIERRA #66;
     |CIERRA #11;
     |CIERRA #63;

     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO TomaSeccion;
   |ABRE #con00683;
   |DDEFECTO #con00683;
   |LEE 000#con00683.p;
   |SI FSalida ! 0; |DDEFECTO #con00683; |FINSI;
   |CIERRA #con00683;

   |SI #con00625#0 ! #683#11; |Y #con00625#0 ! #683#12; |Y #con00625#0 ! #683#13;
     |Y #con00625#0 ! #683#17; |Y #con00625#0 ! #683#18; |Y #con00625#0 ! #683#19;
     |Y #con00625#0 ! #683#21; |Y #con00625#0 ! #683#22; |Y #con00625#0 ! #683#23;
     |Y #con00625#0 ! #683#24; |Y #con00625#0 ! #683#25; |Y #con00625#0 ! #683#26;
     |Y #con00625#0 ! #683#27; |Y #con00625#0 ! #683#28; |Y #con00625#0 ! #683#29;
     |Y #con00625#0 ! #683#30; |Y #con00625#0 ! #683#31; |Y #con00625#0 ! #683#32;
     |Y #con00625#0 ! #683#33; |Y #con00625#0 ! #683#34; |Y #con00625#0 ! #683#35;
      |ACABA;
   |FINSI;

   aAlfa = #con00625#0; |QBF aAlfa;
   |SI aAlfa = ""; |ACABA; |FINSI;

   FSalida = 1;
   |PARA; |SI FSalida ! 0; |HACIENDO;
      aAlfa = #con00625#0 + #con00625#1;
      aAlfa = "con00703.tab;" + aAlfa;
      |SUB_EJECUTA aAlfa;

      |ABRE #con00703;
      #con00703#0 = #con00625#0;
      #con00703#1 = #con00625#1;
      |LEE 000#con00703.=;
      FEstado = FSalida;
      |CIERRA #con00703;

      FSalida = FEstado;
   |SIGUE;
|FPRC;
