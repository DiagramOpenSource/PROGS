  ----------------------  AGIFA077 (ALBARANES COMPRAS CABECERAS) -------

|FICHEROS;
     dszrec06;
     agifa077 #77;
     agifa080 #80;

     agifa019 #19;
     agifa112;
     agifa142;
     dsm00279;
     referen@;
|FIN;

|VARIABLES;
     nCanon = 0;
     nSwBolilla = 0;
     &nDeci_PreDiv = 0;
     &nDeci_IVAC = 0;
     &nDeci_BaseMx = 0;
     &nDeci_Div = 0;
     &nDeci_IVACDiv  = 0;

     nImporDescue1 = 0;
     nImporDescue2 = 0;
     nImporDescue3 = 0;
     nImporMoneda1 = 0;
     nImporMoneda2 = 0;
     nDescuMoneda1 = 0;
     nDescuMoneda2 = 0;

     nBasRete      = 0;
     nPPort1       = 0;
     nPPort2       = 0;
     nImpDiv       = 0;

     nError        = 0;
     nNume         = 0;
     nCanti        = 0;
     nMargen       = 0;
     nBrutoMoneda1 = 0;
     nBrutoMoneda2 = 0;

     &eaPrv        = "";
     &enTiva       = 0;
     &enIva        = 0;
     &enRec        = 0;
     &efFiva = @;
     nTotPVerde = 0;
     aDef = "";
     aAlfa = "";
     nPreTon = 0;
     nSwAlba = 0;
     nSwBsegui = 0;
|FIN;

|PROCESO BseVerdeBase6; ||Modulo Albadist
     |HAZ EsAlbadis; nSwAlba = FSalida;
     |HAZ EsBsegui; nSwBsegui = FSalida;
     |HAZ EsBolillas; nSwBolilla = FSalida;

     |SI nSwAlba ! 0; |Y nSwBsegui ! 0; |Y nSwBolilla ! 0;
               |Y #agifa142#177 ! "S";
          |ACABA;
     |FINSI;

     nBrutoMoneda1 = nBrutoMoneda1 + #agifa080#44;
     nBrutoMoneda2 = nBrutoMoneda2 + #agifa080#44;
     nTotPVerde = #agifa077#78;
|FPRC;

|PROCESO IvasAgifa077;
     efFiva = #agifa077#1;
     |HAZ IVAPrv;

     |SI enTiva = 0;
         #agifa077#28 = #agifa077#28 +. nBrutoMoneda1;
         #dszrec06#00 = #dszrec06#00 +. nBrutoMoneda2;
     |FINSI;

     |SI enTiva = 1;
         #agifa077#16 = #agifa077#16 +. nBrutoMoneda1;
         #agifa077#17 = #agifa077#16 % enIva;
         |SI #agifa077#36 = "S";
             #agifa077#18 = #agifa077#16 % enRec;
         |FINSI;

         #dszrec06#1  = #dszrec06#1  +. nBrutoMoneda2;
         #dszrec06#2  = #dszrec06#1 % enIva;
         |SI #agifa077#36 = "S";
             #dszrec06#3 =#dszrec06#1 % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 2;
         #agifa077#19 = #agifa077#19 +. nBrutoMoneda1;
         #agifa077#20 = #agifa077#19 % enIva;
         |SI #agifa077#36 = "S";
             #agifa077#21 = #agifa077#19 % enRec;
         |FINSI;

         #dszrec06#4  = #dszrec06#4  +. nBrutoMoneda2;
         #dszrec06#5  = #dszrec06#4 % enIva;
         |SI #agifa077#36 = "S";
             #dszrec06#6 = #dszrec06#4 % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 3;
         #agifa077#22 = #agifa077#22 +. nBrutoMoneda1;
         #agifa077#23 = #agifa077#22 % enIva;
         |SI #agifa077#36 = "S";
             #agifa077#49 = #agifa077#22 % enRec;
         |FINSI;

         #dszrec06#7  = #dszrec06#7  +. nBrutoMoneda2;
         #dszrec06#8  = #dszrec06#7 % enIva;
         |SI #agifa077#36 = "S";
             #dszrec06#9 = #dszrec06#7 % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 4;
         #agifa077#43 = #agifa077#43 +. nBrutoMoneda1;
         #agifa077#44 = #agifa077#43 % enIva;
         |SI #agifa077#36 = "S";
             #agifa077#45 = #agifa077#43 % enRec;
         |FINSI;

         #dszrec06#10 = #dszrec06#10 +. nBrutoMoneda2;
         #dszrec06#11 = #dszrec06#10 % enIva;
         |SI #agifa077#36 = "S";
             #dszrec06#12 = #dszrec06#10 % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 5;
         #agifa077#46 = #agifa077#46 +. nBrutoMoneda1;
         #agifa077#47 = #agifa077#46 % enIva;
         |SI #agifa077#36 = "S";
             #agifa077#48 = #agifa077#46 % enRec;
         |FINSI;

         #dszrec06#13 = #dszrec06#13 +. nBrutoMoneda2;
         #dszrec06#14 = #dszrec06#13 % enIva;
         |SI #agifa077#36 = "S";
             #dszrec06#15 = #dszrec06#13 % enRec;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO IvaRestoAgifa077;
     eaPrv = #agifa077#3;

     |SI #dsm00279#20 = "S";
          nBrutoMoneda1 = #agifa077#11;
          nBrutoMoneda2 = #agifa077#69;
     |SINO;
          nBrutoMoneda1 = 0;
          nBrutoMoneda2 = 0;
     |FINSI;

     enTiva = #agifa077#12;
     |HAZ IvasAgifa077;

     nBrutoMoneda1 = #agifa077#13;
     nBrutoMoneda2 = #agifa077#70;
     enTiva        = #agifa077#14;
     |HAZ IvasAgifa077;
|FPRC;

|PROCESO LimCabAgifa077;
     |ABRE #agifa142; |LEE 000#agifa142.p; |CIERRA #agifa142;
     |ABRE #dsm00279; |LEE 000#dsm00279.p; |CIERRA #dsm00279;

     |DDEFECTO #dszrec06;

     nTotPVerde = 0;

     #agifa077#15 = 0;
     #agifa077#16 = 0;
     #agifa077#17 = 0;
     #agifa077#18 = 0;
     #agifa077#19 = 0;
     #agifa077#20 = 0;
     #agifa077#21 = 0;
     #agifa077#22 = 0;
     #agifa077#23 = 0;
     #agifa077#24 = 0;
     #agifa077#25 = 0;
     #agifa077#28 = 0;
     #agifa077#37 = 0;
     #agifa077#43 = 0;
     #agifa077#44 = 0;
     #agifa077#45 = 0;
     #agifa077#46 = 0;
     #agifa077#47 = 0;
     #agifa077#48 = 0;
     #agifa077#49 = 0;
     #agifa077#53 = 0;
     #agifa077#63 = 0;
     #agifa077#64 = 0;
     #agifa077#78 = 0;
     #agifa077#80 = 0;
     |HAZ IvaRestoAgifa077;
|FPRC;

|PROCESO CalCabAgifa077;
     ||----------------------------  Margen
     |SI #agifa080#9 ] 0;
          nError = 1;
     |SINO;
          nError = -1;
          #agifa080#9   = -#agifa080#9;
          #agifa080#31  = -#agifa080#31;
     |FINSI;

     nCanti = #agifa080#9 < #agifa077#5;
     nCanti = nCanti < #agifa077#32;
     |SI #agifa142#115 = "S";
          nCanti = nCanti < #agifa077#7;
     |FINSI;
     nCanti = nCanti * nError;
     |SI #agifa019#196 = 1;
         nMargen = #agifa080#5  * #agifa019#9;
     |SINO;
         nMargen = #agifa080#36 * #agifa019#9;
     |FINSI;
     nMargen      = nCanti - nMargen;
     #agifa077#37 = #agifa077#37 + nMargen;
     #agifa080#9  = #agifa080#9  * nError;
     #agifa080#31 = #agifa080#31 * nError;
     ||----------------------------

     #agifa077#15 = #agifa077#15 +. #agifa080#9;
     #agifa077#63 = #agifa077#63 +. #agifa080#31;
     #agifa077#78 = #agifa077#78 +. #agifa080#44;

     nBrutoMoneda1 = #agifa080#9;
     nImporDescue1 = (nBrutoMoneda1 % #agifa077#5) ! nDeci_IVAC;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #agifa077#32) ! nDeci_IVAC;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #agifa077#7) ! nDeci_IVAC;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     nDescuMoneda1 = nImporDescue1 + nImporDescue2 + nImporDescue3;

     nBrutoMoneda2 = #agifa080#31;
     nImporDescue1 = (nBrutoMoneda2 % #agifa077#5) ! nDeci_IVAC;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #agifa077#32) ! nDeci_IVAC;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #agifa077#7) ! nDeci_IVAC;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     nDescuMoneda2 = nImporDescue1 + nImporDescue2 + nImporDescue3;
/*
     nBrutoMoneda1 = (#agifa080#9 < #agifa077#5) ! nDeci_BaseMx;
     nBrutoMoneda1 = (nBrutoMoneda1 < #agifa077#32) ! nDeci_BaseMx;
     nBrutoMoneda1 = (nBrutoMoneda1 < #agifa077#7) ! nDeci_BaseMx;

     nBrutoMoneda2 = (#agifa080#31 < #agifa077#5) ! nDeci_Div;
     nBrutoMoneda2 = (nBrutoMoneda2 < #agifa077#32) ! nDeci_Div;
     nBrutoMoneda2 = (nBrutoMoneda2 < #agifa077#7) ! nDeci_Div;
*/
     |HAZ BseVerdeBase6;

     eaPrv         = #agifa077#3;
     enTiva        = #agifa080#11;
     |HAZ IvasAgifa077;

     |SI #agifa080#50 = -1;
          nCanon = #agifa080#9 + (#agifa080#9 % enIva);
          |SI #agifa077#36 = "S";
               nCanon = nCanon + (#agifa080#9 % enRec);
          |FINSI;
          #agifa077#80 = #agifa077#80 +. nCanon;
     |FINSI;

     nNume = nBrutoMoneda1 % #agifa080#10;
     #agifa077#26 = #agifa077#26 +. nNume;

     #agifa077#25 = #agifa077#25 +. nDescuMoneda1;
/*
     |SI #agifa077#15 > 0;
         nError = 1;
     |SINO;
         nError = -1;
         #agifa077#15 = -#agifa077#15;
         #agifa077#63 = -#agifa077#63;
     |FINSI;

     #agifa077#25 = #agifa077#15 < #agifa077#5;
     #agifa077#25 = #agifa077#25 < #agifa077#32;
     #agifa077#25 = #agifa077#25 < #agifa077#7;
     #agifa077#25 = #agifa077#25 * nError;
     #agifa077#15 = #agifa077#15 * nError;
     #agifa077#25 = #agifa077#15 - #agifa077#25;
*/
     #agifa077#24 = #agifa077#17 + #agifa077#18 + #agifa077#20 + #agifa077#21;
     #agifa077#24 = #agifa077#24 + #agifa077#23 + #agifa077#44 + #agifa077#45;
     #agifa077#24 = #agifa077#24 + #agifa077#47 + #agifa077#48 + #agifa077#49;

     #dszrec06#17 = #dszrec06#17 +. nDescuMoneda2;
/*
     #dszrec06#17 = #agifa077#63 < #agifa077#5;
     #dszrec06#17 = #dszrec06#17 < #agifa077#32;
     #dszrec06#17 = #dszrec06#17 < #agifa077#7;
     #dszrec06#17 = #dszrec06#17 * nError;
     #agifa077#63 = #agifa077#63 * nError;
     #dszrec06#17 = #agifa077#63 - #dszrec06#17;
*/

     #dszrec06#16 = #dszrec06#02 + #dszrec06#03 + #dszrec06#05 + #dszrec06#06;
     #dszrec06#16 = #dszrec06#16 + #dszrec06#08 + #dszrec06#09 + #dszrec06#11;
     #dszrec06#16 = #dszrec06#16 + #dszrec06#12 + #dszrec06#14 + #dszrec06#15;

     |SI #dsm00279#20 = "S";
          #agifa077#55 = (#agifa077#15 - #agifa077#25) + (#agifa077#11 + #agifa077#13 + #agifa077#24); || - #agifa077#53;
          #agifa077#64 = (#agifa077#63 - #dszrec06#17) + (#agifa077#69 + #agifa077#70 + #dszrec06#16); || - #dszrec06#18;
     |SINO;
          #agifa077#55 = (#agifa077#15 - #agifa077#25) + (#agifa077#13 + #agifa077#24); || - #agifa077#53;
          #agifa077#64 = (#agifa077#63 - #dszrec06#17) + (#agifa077#70 + #dszrec06#16); || - #dszrec06#18;
     |FINSI;

     #agifa077#55 = #agifa077#55 + nTotPVerde;  || modulo Albadist
     #agifa077#64 = #agifa077#64 + nTotPVerde;  || modulo Albadist

     |SI #agifa077#58 = "D";
         #agifa077#65 = #agifa077#63;
         #agifa077#66 = #agifa077#64;
         #agifa077#67 = #agifa077#15;
         #agifa077#68 = #agifa077#55;
     |SINO;
         #agifa077#65 = #agifa077#15;
         #agifa077#66 = #agifa077#55;
         #agifa077#67 = #agifa077#63;
         #agifa077#68 = #agifa077#64;
     |FINSI;

     |DDEFECTO #agifa112;
     |ABRE #agifa112;
     #agifa112#0 = eaPrv;
     |LEE 000#agifa112.=;
     |CIERRA #agifa112;
/* lo mio
     |SI enTiva ! 0; |O #agifa112#93 = "S";
         |SI #agifa112#86 = "B";
               #dszrec06#19 = #dszrec06#19 +. #agifa080#9;
               #dszrec06#20 = #dszrec06#20 +. #agifa080#31;
         |SINO;
               nImp = #agifa080#9 - (#agifa080#9 - (((#agifa080#9 < #agifa077#5) < #agifa077#32) < #agifa077#7));
               #dszrec06#19 = #dszrec06#19 +. nImp;

               nImp = #agifa080#31 - (#agifa080#31 - (((#agifa080#31 < #agifa077#5) < #agifa077#32) < #agifa077#7));
               #dszrec06#20 = #dszrec06#20 +. nImp;
         |FINSI;
     |FINSI;
*/
     nBasRete = 0;
     |SI #agifa112#93 = "S";
          nBasRete = #agifa077#28;
     |FINSI;
     nBasRete =nBasRete+#agifa077#16+#agifa077#19+#agifa077#22+#agifa077#43+#agifa077#46;
     |SI #agifa112#86 = "N"
          nBasRete=nBasRete+#agifa077#17+#agifa077#20+#agifa077#23+#agifa077#44+#agifa077#47;
          nBasRete=nBasRete+#agifa077#18+#agifa077#21+#agifa077#49+#agifa077#45+#agifa077#48;
     |FINSI;
     #dszrec06#19 = nBasRete;
     #dszrec06#20 = nBasRete / #agifa077#57 * #agifa077#62;
/*
||lo de antes
     |SI #agifa077#24 ! 0;
         |SI #agifa112#86 = "B";
               #dszrec06#19 = #agifa077#15;
               #dszrec06#20 = #agifa077#63;
         |SINO;
               #dszrec06#19 = #agifa077#55;
               #dszrec06#20 = #agifa077#64;
         |FINSI;
     |FINSI;
||hasta aqui
*/
     #agifa077#53 = #dszrec06#19 % #agifa077#52;
     #dszrec06#18 = #dszrec06#20 % #agifa077#52;
|FPRC;

|| ----------------------  FIN AGIFA077 ---------------------------------

|PROCESO TotalLin80;
     |ABRE #19;
     #19#0 = #80#2;
     |LEE 020#19=;
     |CIERRA #19;

     nPreTon = 1;
     |HAZ EsVigor;
     |SI FSalida = 0;
          aAlfa = #19#110; |QBF aAlfa;   || Alfanumerico1
          aAlfa = aAlfa > "";
          |SI aAlfa = "S"; nPreTon = 1000; |FINSI;
     |FINSI;

     #80#44 = #80#5 * #19#208; ||Punto Verde

     |HAZ EsAlbadis; ||Para este modulo se factura con las unidades 2
     |SI FSalida = 0; #agifa019#196 = 2; |FINSI;

     |SI #77#58 = "D";
          #80#6    = #80#30 / #77#57 * #77#62;
          #80#32   = #80#6;
          nPPort1 = (#80#42 / #77#57 * #77#62); || sin redondeos tiquet:323/646
          nPPort2 = #80#42;
     |SINO;
          #80#30   = #80#6 / #77#62 * #77#57;
          #80#32   = #80#30;
          nPPort1 = #80#42;
          nPPort2 = (#80#42 / #77#62 * #77#57); || sin redondeo tiquet:323/646
     |FINSI;

     |SI #19#196 = 2;
          #80#7    = #80#36 * #80#6 / nPreTon;
          nImpDiv = (#80#36 * #80#30 / nPreTon) ! nDeci_IVACDiv;
     |SINO;
          #80#7    = #80#5  * #80#6 / nPreTon;
          nImpDiv = (#80#5  * #80#30 / nPreTon) ! nDeci_IVACDiv;
     |FINSI;

     #80#9  = ((#80#7 < #80#8) < #80#26) < #80#45;
     #80#31 = ((nImpDiv < #80#8) < #80#26) < #80#45;

     |SI #19#196 = 2;
          #80#9  = #80#9  + (#80#36 * nPPort1);  || Portes Linea
          #80#31 = #80#31 + (#80#36 * nPPort2);  || Portes Linea
     |SINO;
          #80#9  = #80#9  + (#80#5  * nPPort1);  || Portes Linea
          #80#31 = #80#31 + (#80#5  * nPPort2);  || Portes Linea
     |FINSI;

     |SI #77#58 = "D";     || Si mon. de trabajo es divisa ...
          #80#33 = #80#9;   || Importe visual, en mon. base
     |SINO;               || Si mon. de trabajo es mon. base ...
          #80#33 = #80#31;  || Importe visual, en divisa
     |FINSI;
|FPRC;
