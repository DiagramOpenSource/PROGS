|FICHEROS;
     dsm00043 #0;
     dsm00044 #1;
     agifa024 #24;
     dsm00005 #905;
     agifa142 #142;
     dsm00087@;
     refere1@;
     refere2@;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     aMaqui = "";
     aAlfa = "";
     aUsu = "";
     nContaLog = 0;
     aSer = "";
     aNum = "";
     aTipo = "";
     nTipo = 0;
     &nSwEleme = 0;
     nForma = 0;
     nConta    = 0;
     nModo     = 0;
     nNume     = 0;
     aInforme  = "dsm00043";
     aSerie    = "";
     aMensaje = "";

     &enSwEstaDoc = 0;
     &eaTipoMov = "";
     &eaSerAlb = "";
     &enNumAlb = 0;
     &enLinAlb = 0;

     &eaDocAlbero = "";       ||Nos dice si viene de un proceso Externo.
     &eaSerAlbero = "";
     &enNumAlbero = 0;
|FINSI;

|PROCESO ModFecha; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
          |C_M #0#1, 1, "S";
     |SINO;
          |C_M #0#1, 1, "N";
     |FINSI;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
|FPRC;

|PROCESO dsm00005;
     nSwEleme = 1;
     |PRINT;
|FPRC;

|DEFBUCLE dsm00005;
     #905#1;
     ;
     "T3", #1#21, #1#18, #1#8, "      ";
     "T3", #1#21, #1#18, #1#8, "zzzzzz";
     ;
     NULL, dsm00005;
|FIN;

|PROCESO Impresion;

     nSwEleme = 0;
     |PRINT;
     |BUCLE dsm00005;
|FPRC;

|PROCESO Tipo4; |TIPO 4;
     eaSerLog = #0#4;
     eaNumLog = (A\("000000" + #0#0) % -106);
     eaTipLog = "RE";
     |HAZ ImprimeLog;

     |HAZ EsGestral;
     |SI FSalida = 0;
          |DDEF aAlfa;
          aAlfa = aAlfa + "gestrm01";
          |CARGA_DEF aAlfa, refere1@;
          |SI FSalida = 0;
               |ABRE #refere1@; |LEE 000#refere1@.p; |CIERRA #refere1@;
               aInforme = #refere1@#43; |QBF aInforme;
               |DESCARGA_DEF #refere1@;
          |FINSI;
     |FINSI;

     |IMPRE 0;
     |SI FSalida = 0;
          |INFOR aInforme;
          |SI FSalida = 0;
               |BUCLELIN 2 Impresion #0;
               |PIEINF;
               |FININF;
          |FINSI;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO Imprime; |TIPO 30;
     |HAZ EsInforAlba;
     |SI FSalida = 0; |HAZ InforPideCli; |FINSI;

     |HAZ EsGesisat;
     |SI FSalida = 0; |HAZ GesiPideCli; |FINSI;

     |CONFI "2400NImprimir Documento S/N";
     |SI FSalida = 0;
          |HAZ Tipo4;
     |FINSI;

|FPRC;

|PROCESO Conta43; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo ! 1; |ACABA; |FINSI;
     aSerie = #0#4;
     #0#0 = 999999;
     |LEE 000#0];
     |SI FSalida = 0;
          |LEE 000#0a;
     |SINO;
          |LEE 000#0u;
     |FINSI;
     |SI FSalida = 0; |Y #0#4 = aSerie;
          nConta = #0#0 + 1;
     |SINO;
          nConta = 1;
     |FINSI;
     |DDEFECTO #0;
     #0#0 = nConta;
     #0#4 = aSerie;
|FPRC;

|PROCESO MiraCierre;
     efFec = #0#1;
     enAlma = #1#1;
     |HAZ MiraHis0;
     |SI enErrHis ! 0; |ERROR10; |FINSI;
|FPRC;

|PROCESO Tipo2_43; |TIPO 2;
     nModo = (FEntrada / 100) ! 0;
     nForma = 0 +. 1;
     |SI #0#5 = "S";
          |MENAV "0000Registro Exportado...";
          |ERROR;
     |FINSI;
     |SI nModo = 3;
          |BUCLELIN 2 MiraCierre #0;
          |SI enErrHis ! 0;
               |MENAV "0000Hay lineas con almacenes cerrados por inventario...";
               |ERROR;
          |FINSI;
     |FINSI;

     ||No puedo distinguir si viene o no de una mezclada .. AHORA YA SI.
     ||Tendre que meter en el albm0046 un campo de Generado Automaticamente S/N

     |HAZ EsAlbero;
     |SI FSalida = 0;
          |SI nModo = 2; |Y nForma = -1;
               enSwEstaDoc = 0;
               eaTipoMov = "ES";
               eaSerAlb = #dsm00043#4;
               enNumAlb = #dsm00043#0;
               |HAZ AlberoCtrlModBaj;
               |SI enSwEstaDoc = 1;
                    aMensaje = "0000Modificacion no permitida. Proceso Externo.";
                    |SI eaDocAlbero = "MZ";
                         aMensaje = aMensaje + " Mezclada: " + (("000000" + enNumAlbero) % -106);
                    |FINSI;
                    |SI eaDocAlbero = "TI";
                         aMensaje = aMensaje + " O.Tintado: " + (("000000" + enNumAlbero) % -106);
                    |FINSI;
                    |MENAV aMensaje;
                    |ERROR;
               |FINSI;
          |FINSI;
          |SI nModo = 3;
               enSwEstaDoc = 0;
               eaTipoMov = "ES";
               eaSerAlb = #dsm00043#4;
               enNumAlb = #dsm00043#0;
               |HAZ AlberoCtrlModBaj;
               |SI enSwEstaDoc = 1;
                    aMensaje = "0000Baja no permitida. Proceso Externo.";
                    |SI eaDocAlbero = "MZ";
                         aMensaje = aMensaje + " Mezclada: " + (("000000" + enNumAlbero) % -106);
                    |FINSI;
                    |MENAV aMensaje;
                    |ERROR;
               |FINSI;
          |FINSI;
     |FINSI;
     |HAZ EsGesenvia;
     |SI FSalida = 0;
          eaSerie = #0#4;
          enCodigo = #0#0;
          enForma = nForma;
          |SI nModo = 1; |GRABA 020#0a; |FINSI;
          |SUB_EJECUTA_NP "gesez001;REG";
     |FINSI;
|FPRC;

|PROCESO Tipo13_43; |TIPO 13;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     |SI #142#117 = "S";
          |C_V #1#22, 1, "S";
          |C_V #1#23, 1, "S";
          |C_V #1#24, 1, "S";
          |C_V #1#25, 1, "S";
          |ATRI I;
          |PINTA 2140, "Stock2 Total....:";
          |PINTA 2240, "Stock2 Disponib.:";
          |ATRI 0;
     |FINSI;
     |HAZ EsInforAlba;
     |SI FSalida = 0;
          |ATRI R; |PINTA 1155, "Matricula:"; |ATRI 0;
          |C_P #1#13, 1, 1165;
          |PINTA #1#13;
     |FINSI;
     |HAZ EsGesisat;
     |SI FSalida = 0;
          |ATRI R; |PINTA 1155, "Maquina..:"; |ATRI 0;
          |HAZ GesiLeeMaqui;
          aAlfa = #1#13; #1#13 = aMaqui;
          |C_P #1#13, 1, 1165;
          |PINTA #1#13;
          #1#13 = aAlfa;
     |FINSI;
|FPRC;

|PROCESO T043_15; |TIPO 15;
     nTipo = 15; |HAZ log043;
|FPRC;

|PROCESO T043_16; |TIPO 16;
     nTipo = 16; |HAZ log043;
|FPRC;

|PROCESO T043_17; |TIPO 17;
     nTipo = 17; |HAZ log043;
|FPRC;

|PROCESO log043;
     |DDEF aAlfa;
     aAlfa = aAlfa + "dsm00087";
     |CARGA_DEF aAlfa, dsm00087@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aSer = #0#4;
     aNum = ("000000" + #0#0) % -106;
     aTipo = "RE";

     |ABRE #dsm00087@;
     |DDEFECTO #dsm00087@;
     |SELECT #2#dsm00087@;
     #dsm00087@#1 = aSer;
     #dsm00087@#2 = aNum;
     #dsm00087@#3 = aTipo;
     |LEE 101#dsm00087@.=;
     |SI FSalida ! 0;
          |SELECT #1#dsm00087@;
          |LEE 000#dsm00087@.u;
          |SI FSalida = 0;
               nContaLog = #dsm00087@#0 + 1;
          |SINO;
               nContaLog = 1;
          |FINSI;
          |DDEFECTO #dsm00087@;
          #dsm00087@#0 = nContaLog;
          #dsm00087@#1 = aSer;
          #dsm00087@#2 = aNum;
          #dsm00087@#3 = aTipo;
          |GRABA 020#dsm00087@.b;
     |FINSI;
     |SI FSalida = 0;
          |HORA aAlfa;
          aUsu = Usuario % 810;
          |SI nTipo = 15;
               #dsm00087@#4 = aUsu;
               #dsm00087@#5 = ~;
               #dsm00087@#6 = aAlfa;
               #dsm00087@#7 = "";
               #dsm00087@#8 = "01.01.0000";
               #dsm00087@#9 = ""
               #dsm00087@#10 = "";
               #dsm00087@#11 = "01.01.0000";
               #dsm00087@#12 = ""
          |FINSI;
          |SI nTipo = 16;
               #dsm00087@#7 = aUsu;
               #dsm00087@#8 = ~;
               #dsm00087@#9 = aAlfa;
          |FINSI;
          |SI nTipo = 17;
               #dsm00087@#10 = aUsu;
               #dsm00087@#11 = ~;
               #dsm00087@#12 = aAlfa;
          |FINSI;
          |GRABA 020#dsm00087@.a;
     |FINSI;
     |CIERRA #dsm00087@;
     |DESCARGA_DEF #dsm00087@;
|FPRC;

|PROCESO MiraMatri;
     aAlfa = #1#13; |QBF aAlfa;
     |SI aAlfa ! "";
          |SUB_EJECUTA_NP "ialbz028";
          |ERROR10;
     |FINSI;
|FPRC;

|PROCESO ActMatri;
     #refere1@#0 = #1#13;
     |LEE 121#refere1@.=;
     |SI FSalida = 0;
          #refere1@#6 = #24#0;
          #refere1@#7 = #24#1;
          #refere1@#8 = #0#1;
          #refere1@#21 = #24#17;
          #refere1@#13 = #1#9;
          #refere1@#14 = #1#10;
          |GRABA 020#refere1@.a;
          |LIBERA #refere1@;
     |FINSI;
|FPRC;

|PROCESO InforPideCli;
     eaCli = "";
     |BUCLELIN 2 MiraMatri #0;
     |SI eaCli ! "";
          |DDEF aAlfa;
          aAlfa = aAlfa + "ialbm002";
          |CARGA_DEF aAlfa, refere1@;
          |SI FSalida = 0;
               |ABRE #24;
               #24#0 = eaCli;
               |LEE 020#24=;
               |CIERRA #24;
               |ABRE #refere1@;
               |BUCLELIN 2 ActMatri #0;
               |CIERRA #refere1@;
               |DESCARGA_DEF #refere1@;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MiraMaqui;
     |HAZ GesiLeeMaqui;
     aAlfa = aMaqui; |QBF aAlfa;
     |SI aAlfa ! "";
          |SUB_EJECUTA_NP "gesiz020";
          |ERROR10;
     |FINSI;
|FPRC;

|PROCESO ActMaqui;
     |HAZ GesiLeeMaqui;
     #refere1@#0 = aMaqui;
     |LEE 121#refere1@.=;
     |SI FSalida = 0;
          #refere1@#6 = #24#0;
          #refere1@#7 = #24#1;
          #refere1@#8 = #0#1;
          #refere1@#21 = #24#17;
          #refere1@#26 = #24#196;
          #refere1@#27 = #24#197;
          #refere1@#10 = #24#25;
          #refere1@#11 = #24#26;
          #refere1@#13 = #1#9;
          #refere1@#14 = #1#10;
          |GRABA 020#refere1@.a;
          |LIBERA #refere1@;
     |FINSI;
|FPRC;

|PROCESO GesiPideCli;
     eaCli = "";
     |BUCLELIN 2 MiraMaqui #0;
     |SI eaCli ! "";
          |DDEF aAlfa;
          aAlfa = aAlfa + "gesim002";
          |CARGA_DEF aAlfa, refere1@;
          |SI FSalida = 0;
               |ABRE #24;
               #24#0 = eaCli;
               |LEE 020#24=;
               |CIERRA #24;
               |ABRE #refere1@;
               |BUCLELIN 2 ActMaqui #0;
               |CIERRA #refere1@;
               |DESCARGA_DEF #refere1@;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GesiLeeMaqui;
     |DDEF aAlfa;
     aAlfa = aAlfa + "gesim024";
     |CARGA_DEF aAlfa, refere2@;
     |SI FSalida = 0;
          |ABRE #refere2@;
          #refere2@#0 = "RE";
          #refere2@#1 = #1#21;
          #refere2@#2 = #1#18;
          #refere2@#3 = #1#8;
          |LEE 000#refere2@.=;
          |SI FSalida = 0;
               aMaqui = #refere2@#4;
          |SINO;
               aMaqui = "";
          |FINSI;
          |CIERRA #refere2@;
          |DESCARGA_DEF #refere2@;
     |SINO;
          |MENAV "0000Error al cargar 'gesim024'";
     |FINSI;
|FPRC;
