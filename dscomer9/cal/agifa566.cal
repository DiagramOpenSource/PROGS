|FICHEROS;
     agifa566 #0;
     agifa509 #1;   ||Cierre caja
     agifa505 #2;   ||Parametros tpv
|FIN;

|VARIABLES;
     fecha = @;
     cerrar = 0;
     mensaje = "";
     puente = "";
     empresa = 0;
     guarda1 = "";
     guarda2 = "";
     guarda3 = "";
     guarda4 = "";
|FIN;


|PROCESO inicio;|TIPO 10;
|ENDATOS #1#0;
|SI FSalida ! 0; |ERROR;  |ACABA; |FINSI;
|SI #0#2 ! "SI"; |ERROR;  |ACABA; |FINSI;
|DFICE puente; |QBF puente;
puente = puente % -205;
empresa = puente;
|ABRE #1;
#1#63 = empresa;
#1#0 = #0#0;
#1#1 = "00.00.0000";
cerrar = 0;
|LEE 001#1];
|PARA ; |SI FSalida = 0; |Y #1#0 = #0#0; |Y #1#63 = empresa; |HACIENDO;
     |SI #1#56 = "S";
          cerrar = cerrar + 1;
          fecha = #1#1;
     |FINSI;
     |LEE 001#1s;
|SIGUE;
||---------------------- NUEVO (sigue mas abajo)
|SI cerrar ! 0;
     |SI cerrar = 1;
          |SI fecha = #0#1;
               |MENAV "0000La caja esta abierta...";
               |CIERRA #1;
               |ERROR;
               |ACABA;
          |FINSI;
          mensaje = "0000Caja:" + #0#0 + " -De la Fecha:" + fecha + " abierta...";
          |MENAV mensaje;
     |SINO;
          mensaje = "0000No puede haber mas de 1 dia con la caja abierta...";
          |MENAV mensaje;
          |CIERRA #1;
          |ERROR;
          |ACABA;
     |FINSI;
|FINSI;
||----------------------

#1#63 = empresa;
#1#0 = #0#0;   ||caja
#1#1 = #0#1;   ||Fecha
|LEE 121#1=;
|SI FSalida ! 0;
     |MENAV "0000Esta caja a esta fecha no existe en RESUMEN PARCIAL";
     |CIERRA #1;
     |ERROR;
     |ACABA;
|FINSI;

|ABRE #2;
#2#0 = #0#0;
|LEE 121#2=;
|SI FSalida ! 0;
     |MENAV "0000Esta caja no esta dada de alta en PARAMETROS TPV";
     |CIERRA #2;
     |ERROR;
     |ACABA;
|FINSI;
||---------------NUEVO
guarda1 = #1#56;
guarda2 = #1#59;
guarda3 = #2#23;
guarda4 = #2#24;
||----------------
#1#56 =  "S";
#1#59 = 0;
|GRABA 021#1a;

#2#23 = "S";
#2#24 = #0#1;
|GRABA 021#2a;
||--------------------NUEVO
|SI cerrar = 1;
     |LIBERA #1; |LIBERA #2;
     |SUB_EJECUTA_NP "agifa518";
     #2#0 = #0#0;   ||caja
     |LEE 121#2=;
     |SI #2#23 = "S";
          |MENAV "0000No se ha cerrado la caja, ANULACION DE CAJA ABORTADA..";
          #2#23 = guarda3;
          #2#24 = guarda4;
          |GRABA 021#2a;
          #1#63 = empresa;
          #1#0 = #0#0;   ||caja
          #1#1 = #0#1;   ||Fecha
          |LEE 121#1=;
          #1#56 = guarda1;
          #1#59 = guarda2;
          |GRABA 021#1a;
     |SINO;
          #2#23 = "S";
          #2#24 = fecha;
          |GRABA 021#2a;
     |FINSI;
|FINSI;
||------------------------
|CIERRA #1;
|CIERRA #2;

|ERROR;
|ACABA;
|FPRC;
