cuando 10#85=N regrabao historico

|FICHEROS;
     coimz005 #0;
     coima001 #1;
     agifa010 #10;
     coima013 #13;
     coima014 #14;
     agifa017 #17;
     agifa019 #19;
     dsm00020 #20;
     coima022 #22;
     dsm00003 #30;
     agifa024 #24;
     coima045 #45;
     agifa065 #65;
     agifa071 #71;
     agifa073 #73;
     agifa104 #104;
     dsm00113 #113;
     agifa142 #142;
     tempo134 #134;
|FIN;

|VARIABLES;
     {1}aBaseLocal;
     aDjunto = "";
     aServidor = "";
     aFrom = "";
     aTo = "";
     aEmail = "";
     aSubject = "";
     aMensaje = "";

     aQuito = "";
     &eaImpPL = "";
     nErrLin = 0;
     nPrime = 0;
     nLin = 0;
     &eaFicheroFalcon = "";
     aPathReal = "";
     aNombre = "";
     aOrigen = "";
     aDestino = "";

     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;
     aImpBul = "";
     &enHandle = 0;
     &enCodigo = 0;
     &eaMenav = "";
     &XVAR_DC_IMPRIME = 0;
     &Tempo = "";
     &eaProgVta = "";
     aTmp134 = "";
     aAlfa = "";
     aPath = "";
     aIP = "";
     aTipo = "";
     nHandle = 0;
     nCampo = 0;
     aLon = "";
     i = 0;
     nPos = 0;
     aLetra = "";
     aReg = "";
     aTab = "";
 {99}Valor = "";
     aDato = "";
     nLinea = 0;
     nUniNoSer = 0;
     nUniOrg = 0;
     &nPed_baja = 0;
     &aSer_baja = "";
     &nLin_baja = 0;
     nLinPed = 0;
     nLinAlb = 0;
     eaProg = "";
     &enForma = 0;
     &enCoste = 0;
     nNume1 = 0;
     nNume2 = 0;
     importe = 0;
     cant = 0;
     nForma = 0;
     &enImpCliPen = 0;
     &eaCliente = "";
     &efFecha = @;
     &eaTag = "";
     &nImpo = 0;
     fmes = "";
     mes = 0;
     &enImpCliPed = 0;
     &enSigno = 0;
     nCalc = 0;
     nImp = 0;
     &eaImpreAge = "";
     &eaImpreEti = "";
     &eaImpresora = "";
     &num_alb = 0;
     &ser_alb = "";
     &eaMenuImpre = "";
     aParam = "";
     aSer = "";
     aNum = "";
     aFic = "";
     aCar = "";
|FIN;

|PROCESO Historico;
     #19#0 = #71#2;
     |LEE 000#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;

     |DDEFECTO #65;
     #65#0 = #71#2;
     #65#1 = #10#1;
     #65#2 = "AV";
     #65#3 = #71#0;
     #65#4 = #71#1;
     #65#5 = #71#3;
     #65#6 = -#71#5;
     #65#8 = #19#9;
     #65#9 = #71#6;
     #65#10 = #71#15;
     #65#11 = #71#29;
     #65#12 = #71#8;
     #65#13 = #71#33;
     #65#14 = #65#9 < #65#12 < #65#13;
     #65#18 = #71#49;
     |GRABA 020#65n;
|FPRC;

|PROCESO CoimaMailAlb;
     aIP = ""; |IP_REMOTO aIP;
     |SI aIP = "";
          |DFICE aAlfa;
          aDjunto = aAlfa + #10#52 + "_" + (("000000" + #10#0)%-106)+ ".pdf";
          |QBT aDjunto;
          eaImpresora = "CrystalReport;" + aDjunto;
          ser_alb = #10#52;
          num_alb = #10#0;
          |SUB_EJECUTA_NP "agifa014";
     |SINO;
          |DFICE aAlfa;
          aDjunto = aAlfa + #10#52 + "_" + (("000000" + #10#0)%-106)+ ".pdf";
          |QBT aDjunto;
          |ESPECIFICA "RBASS", aBaseLocal;
          aAlfa = aBaseLocal1 + #10#52 + "_" + (("000000" + #10#0)%-106)+ ".pdf";
          |QBT aAlfa;
          eaImpresora = "CrystalReport;" + aAlfa;
          ser_alb = #10#52;
          num_alb = #10#0;
          |SUB_EJECUTA_NP "agifa014";
          |RECIBE_FICHERO aAlfa, aDjunto;
          |RFBORRA aAlfa;
     |FINSI;

     aIP = "";
     |SI #22#8 = "L";
          |IP_REMOTO aIP;
     |SINO;
          |SI #22#8 = "S";
               |IP_LOCAL aIP;
          |SINO;
               aIP = #22#7; |QBF aIP;
          |FINSI;
     |FINSI;
     aServidor = #22#14; |QBF aServidor;
     aFrom = #22#15; |QBF aFrom;
     aTo = aEmail;
     aSubject = "MERCANCIA ENVIADA POR AGENCIA";
     aMensaje = "LE ADJUNTAMOS PDF CON ALBARAN DE LA MERCANCÍA ENVIADA HOY POR LA AGENCIA DE TRANSPORTES";
     aMensaje = aMensaje + &13 + "RECIBA UN CORDIAL SALUDO.";
     aMensaje = aMensaje + &13 + "COIMASA.";

     |SI aTo ! "";
          |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
     |FINSI;
|FPRC;

|PROCESO CoimaEnviaMailAlb;
     |SI #10#84 = 1;
          |ABRE #24;
          #24#0 = #10#3;
          |LEE 000#24=;
          |CIERRA #24;
          aEmail = #24#214; |QBF aEmail;
          |SI aEmail = "";
               aEmail = #24#197; |QBF aEmail;
          |FINSI;
     |SINO;
          |ABRE #30;
          #30#0 = #10#3;
          #30#1 = #10#84;
          |LEE 000#30=;
          |CIERRA #30;
          aEmail = #30#24; |QBF aEmail;
     |FINSI;
     |SI aEmail = ""; |ACABA; |FINSI;

     |ABRE #22;
     |LEE 000#22p;
     |SI FSalida = 0;
          |HAZ CoimaMailAlb;
     |FINSI;
     |CIERRA #22;
|FPRC;

|PROCESO Imprime;
     #10#52 = #134#0;
     #10#0 = #134#1;
     |LEE 020#10=;

     ser_alb = #134#0;
     num_alb = #134#1;
     || Normal
     eaImpresora = "CrystalReport";
     eaMenuImpre = "N";
     XVAR_DC_IMPRIME = 1;
     |SUB_EJECUTA_NP "agifa014";

     || Albaranes Agencia
     eaImpreAge = #1#18; |QBF eaImpreAge;
     |||||SUB_EJECUTA_NP "agifa011";

     |SI aImpBul = "S";
          #20#0 = #10#88;
          |LEE 000#20=;
          |SI FSalida = 0; |Y #20#10 = "S";
               aAlfa = "coimz024;" + #10#52 + #10#0;    ||Etiqueta Azkar
               |SUB_EJECUTA_NP aAlfa;
          |SINO;
               || Etiquetas agencia
               eaImpreEti = #1#19; |QBF eaImpreEti;
               |SUB_EJECUTA_NP "agifa013";
          |FINSI;
     |FINSI;

     |SI #1#35 = "S"; |Y #10#2 ! 0;
          |HAZ CoimaEnviaMailAlb;
     |FINSI;
|FPRC;

|DEFBUCLE Imprime;
     #134#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Imprime;
|FIN;

|PROCESO ActCli;
     #19#0 = #73#2;
     |LEE 020#19=;

     #24#0 = #104#4;
     |LEE 121#24=;
     |SI FSalida = 0;
          |SI #19#194 = 2;
               nImp = ((((#73#44 * #73#6) < #73#8) < #73#29) < #104#5) < #104#17;
          |SINO;
               nImp = ((((#73#5 * #73#6) < #73#8) < #73#29) < #104#5) < #104#17;
          |FINSI;
          |SI #142#115 = "S";
               nImp = nImp < #104#6;
          |FINSI;
          nImp = nImp * nForma;
          fmes = #104#1 % A402;
          mes = fmes - 1;
          mes = mes * 3;
          mes = mes + 114;
          #24mes = #24mes + nImp;     || VENTA.
          #24#150 = #24#150 + nImp;
          |GRABA 020#24a;

          eaCliente = #104#4;
          efFecha = #104#1;
          enImpCliPed = nImp;
          |HAZ AcumulaCli;
     |FINSI;

     #113#0 = #104#4;
     #113#1 = #73#14;
     |LEE 000#113=;
     |SI FSalida = 0;
          nCalc = #agifa073#11 % #113#3;
          |SI #24#47 = "S";
               nCalc = nCalc + (#73#11 % #113#4);
          |FINSI;
     |SINO;
          enTiva = #73#14;
          efFiva = #104#1;
          |HAZ SacaIVA;

          nCalc = #73#11 % enIva;
          |SI #24#47 = "S";
               nCalc = nCalc + (#73#11 % enRec);
          |FINSI;
     |FINSI;

     nImpo = nImpo + (#73#11 + nCalc);
|FPRC;

|PROCESO ActCliPed;
     nImpo = 0;
     |ABRE #24;
     |ABRE #19;
     |ABRE #113;
     |ABRE #dsm00113;
     |BUCLELIN 2 ActCli #104;
     |CIERRA #113;
     |CIERRA #24;
     |CIERRA #19;
     nImpo = nImpo * nForma;
     eaTag = "PE";  |HAZ Riesgos;
|FPRC;

|PROCESO ActCliAlb;
     |SI #10#15 ] 0;
          importe = 1;
     |SINO;
          importe = -1;
          #10#15 = -#10#15;
     |FINSI;
     cant = #10#15 < #10#5;
     cant = cant < #10#32;
     cant = cant < #10#7;
     cant = cant * importe;
     #10#15 = #10#15 * importe;
     |ABRE #24;
     #24#0 = #10#3;
     |LEE 121#24=;
     |SI FSalida = 0;
          |SI #10#43 = AN;
               #24#50 = #24#50 + (cant * nForma);    || es albaran
          |SINO;
               #24#50 = #24#50 - (cant * nForma);    || es abono
          |FINSI;
          |GRABA 020#24a;
     |FINSI;
     |CIERRA #24;

     |SI #10#43 = "N";
          enImpCliPen = cant * nForma;
     |SINO;
          enImpCliPen =  -cant * nForma;
     |FINSI;
     eaCliente = #10#3;
     efFecha = #10#1;
     |HAZ AcumulaCli;

     enSigno = nForma;
     eaTag = "AV";  |HAZ Riesgos;
|FPRC;

|PROCESO BorraHisto;
     |ABRE #65;
     #65#0 = #71#2;
     #65#1 = #10#1;
     #65#2 = "AV";
     #65#3 = #71#0;
     #65#4 = #71#1;
     #65#11 = #71#29;
     |LEE 101#65=;
     |SI FSalida = 0;
          |BORRA 020#65a;
     |FINSI;
     |CIERRA #65;
|FPRC;

|PROCESO NuevaLinPed;
     |ABRE #19;
     #19#0 = Valor8;
     |LEE 000#19=;
     |CIERRA #19;

     |SALVA_DATOS #73;
     #73#1 = 999;
     |LEE 000#73];
     |SI FSalida = 0;
          |LEE 000#73a;
     |SINO;
          |LEE 000#73u;
     |FINSI;
     nLinPed = #73#1 + 1;
     |REPON_DATOS #73;

     #73#2 = #19#0;
     #73#1 = nLinPed;
     #73#4 = #19#1;
     #73#5 = Valor9;
     #73#18 = #19#2;
     #73#43 = #73#5;
     |GRABA 020#73n;

     |HAZ CalCabAgifa104;
     |GRABA 020#104a;
|FPRC;

|PROCESO NuevaLinAlb;
     |ABRE #19;
     #19#0 = Valor8;
     |LEE 000#19=;
     |CIERRA #19;

     |SALVA_DATOS #71;
     #71#1 = 999;
     |LEE 000#71];
     |SI FSalida = 0;
          |LEE 000#71a;
     |SINO;
          |LEE 000#71u;
     |FINSI;
     |SI FSalida = 0;
          nLinAlb = #71#1 + 1;
     |SINO;
          nLinAlb = 1;
     |FINSI;
     |REPON_DATOS #71;

     #71#1 = nLinAlb;
     #71#2 = #19#0;
     #71#4 = #19#1;
     #71#5 = Valor9;
     eaProg = "agifa010";
     enForma = 1;
     |HAZ AcumulaAV;
     #71#21 = nLinPed;
     #71#13 = #19#2;
     #71#14 = enCoste;
     |HAZ TotalLin71;
     |GRABA 020#71n;
|FPRC;

|PROCESO NuevoMenor;
     nUniOrg = #71#5;

     nNume1 = Valor28;
     |SI nNume1 = 0;
          |HAZ LeePedido;
          |SI FSalida = 0;
               nForma = -1; |HAZ ActCliPed;
               nUniNoSer = #71#5;
               |HAZ ActPedNoSer;
          |FINSI;

          enForma = -1; eaProgVta = "agifa010"; |HAZ AcumulaAV;
          |BORRA 020#71a;
          |HAZ BorraHisto;

          |SI #71#21 ! 0;
               |LIBERA #104;
               |LIBERA #73;

               nPed_baja = #71#12;
               aSer_baja = #71#31;
               nLin_baja = #71#21;
               eaMenav = "N";
               |SUB_EJECUTA "dsz00006";

               |HAZ LeePedido;
               |HAZ NuevaLinPed;
               nForma = 1; |HAZ ActCliPed;
          |FINSI;

          |HAZ NuevaLinAlb;
     |SINO;
          |HAZ LeePedido;
          |SI FSalida = 0;
               nForma = -1; |HAZ ActCliPed;
               nUniNoSer = #73#5;
               nUniNoSer = nUniNoSer - Valor28;
               |HAZ ActPedNoSer;
          |FINSI;

          enForma = -1; eaProgVta = "agifa010"; |HAZ AcumulaAV;
          #71#5 = Valor28;
          |HAZ TotalLin71;
          |GRABA 020#71a;
          enForma = 1; eaProgVta = "agifa010"; |HAZ AcumulaAV;

          |SI #71#21 ! 0;
               nPed_baja = #71#12;
               aSer_baja = #71#31;
               nLin_baja = #71#21;
               eaMenav = "N";
               |SUB_EJECUTA "dsz00006";

               |HAZ LeePedido;
               |SI FSalida = 0;
                    |HAZ NuevaLinPed;
                    nForma = 1; |HAZ ActCliPed;
               |FINSI;
          |FINSI;

          |HAZ NuevaLinAlb;
     |FINSI;

     |ABRE #14;
     |DDEFECTO #14;
     #14#0 = #71#29;
     #14#1 = #71#0;
     #14#2 = #71#1;
     #14#3 = #71#2;
     #14#4 = #71#4;
     #14#5 = nUniOrg;
     #14#6 = #19#0;
     #14#7 = #19#1;
     #14#8 = Valor9;
     #14#9 = #71#5;
     |GRABA 020#14n;
     |CIERRA #14;

     |HAZ LimCabAgifa010;
     |BUCLELIN 0 CalCabAgifa010 #10;
     |GRABA 020#10a;
|FPRC;

|PROCESO NuevoIgual;
     nUniOrg = #71#5;

     nNume1 = Valor28;
     |SI nNume1 = 0;
          |HAZ LeePedido;
          |SI FSalida = 0;
               nForma = -1; |HAZ ActCliPed;
               nUniNoSer = #71#5;
               |HAZ ActPedNoSer;
          |FINSI;

          enForma = -1; eaProgVta = "agifa010"; |HAZ AcumulaAV;
          |BORRA 020#71a;
          |HAZ BorraHisto;

          #71#1 = 1;
          |LEE 000#71];
          |SI FSalida ! 0; |O #71#29 ! #10#52; |O #71#0 ! #10#0;
               |BORRA 020#10a;
          |FINSI;

          |LIBERA #73;
          |LIBERA #104;
          nPed_baja = #71#12;
          aSer_baja = #71#31;
          nLin_baja = #71#21;
          eaMenav = "N";
          |SUB_EJECUTA "dsz00006";

          nForma = 1; |HAZ ActCliPed;
          |HAZ NuevaLinPed;
          |HAZ NuevaLinAlb;
     |SINO;
          |HAZ LeePedido;
          |SI FSalida = 0;
               nForma = -1; |HAZ ActCliPed;
               nUniNoSer = Valor9;
               |HAZ ActPedNoSer;
          |FINSI;

          enForma = -1; eaProgVta = "agifa010"; |HAZ AcumulaAV;
          #71#5 = Valor28;
          |HAZ TotalLin71;
          |GRABA 020#71a;
          enForma = 1; eaProgVta = "agifa010"; |HAZ AcumulaAV;

          |SI #71#21 ! 0;
               nPed_baja = #71#12;
               aSer_baja = #71#31;
               nLin_baja = #71#21;
               eaMenav = "N";
               |SUB_EJECUTA "dsz00006";

               |HAZ LeePedido;
               |SI FSalida = 0;
                    |HAZ NuevaLinPed;
                    nForma = -1; |HAZ ActCliPed;
               |FINSI;
          |FINSI;

          |HAZ NuevaLinAlb;
     |FINSI;

     |ABRE #14;
     |DDEFECTO #14;
     #14#0 = #71#29;
     #14#1 = #71#0;
     #14#2 = #71#1;
     #14#3 = #71#2;
     #14#4 = #71#4;
     #14#5 = nUniOrg;
     #14#6 = #19#0;
     #14#7 = #19#1;
     #14#8 = Valor9;
     #14#9 = #71#5;
     |GRABA 020#14n;
     |CIERRA #14;

     |HAZ LimCabAgifa010;
     |BUCLELIN 0 CalCabAgifa010 #10;
     |GRABA 020#10a;
|FPRC;

|PROCESO ActPedNoSer;
     #73#43 = #73#43 - nUniNoSer;
     |GRABA 020#73a;
     |HAZ CalCabAgifa104;
     |GRABA 020#104a;

     |ABRE #19;
     |ABRE #17;
     #19#0 = #73#2;
     |LEE 101#19=;
     |SI FSalida = 0;
          #17#0 = #73#2;
          #17#1 = #73#3;
          |LEE 101#17=;
          |SI FSalida = 0;
               #17#42 = #17#42 + nUniNoSer;
               |GRABA 020#17a;
          |FINSI;
          #19#15 = #19#15 + nUniNoSer;
          |GRABA 020#19a;
     |FINSI;
     |CIERRA #17;
     |CIERRA #19;
|FPRC;

|PROCESO NoSirve;
     enForma = -1; eaProgVta = "agifa010"; |HAZ AcumulaAV;
     nUniOrg = #71#5;
     #71#5 = #71#5 - nUniNoSer;
     |HAZ TotalLin71;
     |GRABA 020#71a;
     enForma = 1; eaProgVta = "agifa010"; |HAZ AcumulaAV;

     |SI #71#21 ! 0;
          |HAZ LeePedido;
          |SI FSalida = 0; |HAZ ActPedNoSer; |FINSI;
     |FINSI;

     |DDEFECTO #14;
     |ABRE #14;
     #14#0 = #71#29;
     #14#1 = #71#0;
     #14#2 = #71#1;
     #14#3 = #71#2;
     #14#4 = #71#4;
     #14#5 = nUniOrg;
     #14#9 = #71#5;
     |GRABA 020#14n;
     |CIERRA #14;

     |HAZ LimCabAgifa010;
     |BUCLELIN 0 CalCabAgifa010 #10;
     |GRABA 020#10a;
|FPRC;

|PROCESO LeePedido;
     #104#25 = #71#31;
     #104#0 = #71#12;
     |LEE 101#104=;
     |SI FSalida = 0;
          #73#28 = #71#31;
          #73#0 = #71#12;
          #73#1 = #71#21;
          |LEE 101#73=;
     |FINSI;
|FPRC;

|PROCESO LeeAlbaran;
     #10#52 = Valor1;
     #10#0 = Valor2;
     |LEE 101#10=;
     |SI FSalida = 0;
          #71#29 = Valor1;
          #71#0 = Valor2;
          #71#1 = Valor3;
          |LEE 101#71=;
     |FINSI;
|FPRC;

|PROCESO LinAlba;
     #65#0 = #71#2;
     #65#1 = #10#1;
     #65#2 = "AV";
     #65#3 = #10#0;
     #65#4 = #71#1;
     #65#11 = #10#52;
     |LEE 101#65=;
     |SI FSalida = 0;
          |BORRA 020#65a;
          |LIBERA #65;
          #65#1 = Valor9;
          |GRABA 020#65n;
     |FINSI;
|FPRC;

|PROCESO ActCab;
     |DDEFECTO #20;
     |ABRE #20;
     #20#0 = Valor6;
     |LEE 000#20=;
     |CIERRA #20;

     |ABRE #10;
     #10#52 = Valor1;
     #10#0 = Valor2;
     |LEE 101#10=;
     |SI FSalida = 0;
          |ABRE #65;
          |BUCLELIN 0 LinAlba #10;
          |CIERRA #65;
          #10#1 = Valor9;
          #10#2 = Valor4;
          #10#92 = Valor5;
          #10#83 = Valor7;
          #10#88 = #20#0;
          #10#9 = #20#1;
          #10#85 = "N";
          #10#86 = "";
          #10#87 = 0;
          |GRABA 020#10a;

          |BUCLELIN 0 BorraHisto #10;
          |ABRE #65;
          |ABRE #19;
          |BUCLELIN 0 Historico #10;
          |CIERRA #19;
          |CIERRA #65;

          #134#0 = #10#52;
          #134#1 = #10#0;
          |GRABA 000#134n;    ||Tmp impresion
     |FINSI;
     |CIERRA #10;

     |ABRE #13;
     #13#0 = Valor1;
     #13#1 = Valor2;
     |LEE 101#13=;
     |SI FSalida = 0;
          #13#5 = Valor9;
          #13#6 = Valor10;
          #13#7 = Valor8;
          #13#3 = "S";
          #13#4 = "S";
          |GRABA 020#13a;
     |FINSI;
     |CIERRA #13;
|FPRC;

/*
1.  Serie Albaran
2.   Nº Albaran
3.   Línea albaran
4.   Bultos
5.   Peso
6.   Código Agencia Transporte.
7.   Unidades no servidas. (Cuando no se haya cambiado el articulo)
8.   Nuevo código articulo. (Cuando se sirve de otro articulo)
9.   Unidades servidas del nuevo artículo. (Cuando se sirve de otro articulo)
Del 10 al 27 previsto para cambiar por mas articulos.
28.  Unidades servidas del anterior articulo. (Cuando se sirve de otro articulo)
En cabecera Valor 8 Nº terminal, 9 Fecha albaran, 10 Hora y 11 Impresion etiquetas.
*/
|PROCESO Dato;
     nCampo = 1;
     IValor = Valor1<-;
     aLon = aDato % A0;
     aReg = "";
     aTab = &9;
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aLetra = aDato % nPos;
          |SI aLetra = aTab;
               Valor = aReg;
               aReg = "";
               nCampo = nCampo + 1;
               IValor = IValor + 1;
          |SINO;
               aReg = aReg + aLetra;
          |FINSI;
          |SI nCampo > 90; |SAL; |FINSI;     || Por si.... :)
     |SIGUE;
     Valor = aReg;
|FPRC;

|PROCESO GrabaLin;
     |SI nPrime = 0;
          |HORA aAlfa;
          nPrime = 1;
          |ABRE #45;
          #45#0 = Valor1; Valor1 = #45#0;
          #45#1 = Valor2;
          #45#2 = 1;
          |LEE 000#45=;
          |SI FSalida = 0;
               nErrLin = 1;
               #45#2 = 999;
               |LEE 000#45];
               |SI FSalida = 0;
                    |LEE 000#45a;
               |SINO;
                    |LEE 000#45u;
               |FINSI;
               |SI FSalida = 0; |Y Valor1 = #45#0; |Y Valor2 = #45#1;
                    nLin = #45#2 + 1;
               |SINO;
                    nLin = 1;
               |FINSI;
               #45#0 = Valor1;
               #45#1 = Valor2;
               #45#2 = nLin;
          |SINO;
               nErrLin = 0;
          |FINSI;
          #45#3 = ~;
          #45#4 = aAlfa;
          #45#5 = Valor8;
          |GRABA 020#45n;
          |CIERRA #45;

          |SI nErrLin ! 0;
               aAlfa = "0000El Albaran " + #45#0 + "/" + #45#1 + " ya ha sido actualizado por otro terminal...";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ProcesaFic;
     aAlfa = aPath % -103; aAlfa = aAlfa < "";
     |SI aAlfa = "lot"; |ACABA; |FINSI;

     nPrime = 0;
     nErrLin = 0;

     |XABRE aTipo, aPath, nHandle;
     |SI FSalida ] 0;
          |XLEE nHandle, 250, aDato;
          |PARA; |SI FSalida ] 0; |HACIENDO;
               |HAZ Dato;
               |HAZ GrabaLin;
               |SI nErrLin = 0;
                    nLinea = Valor3;
                    |SI nLinea = 0;
                         aImpBul = Valor11;
                         |HAZ ActCab;
                    |SINO;
                         |ABRET #10;
                         |ABRET #71;
                         |ABRET #104;
                         |ABRET #73;
                         |HAZ LeeAlbaran;
                         |SI FSalida = 0;
                              #134#0 = #10#52;
                              #134#1 = #10#0;
                              |GRABA 000#134n;    ||Tmp impresion

                              #10#85 = "N";  || Quita Albaran hermano
                              #10#86 = "";
                              #10#87 = 0;
                              |GRABA 020#10a;

                              |BUCLELIN 0 BorraHisto #10;
                              |ABRE #65;
                              |ABRE #19;
                              |BUCLELIN 0 Historico #10;
                              |CIERRA #19;

                              #71#47 = "";
                              |GRABA 020#71a;

                              nForma = -1; |HAZ ActCliAlb;
                              nUniNoSer = Valor7;
                              |SI nUniNoSer ! 0;
                                   |HAZ NoSirve;
                              |SINO;
                                   |QBF Valor8;
                                   |SI Valor8 ! "";
                                        nNume1 = Valor9;
                                        nNume2 = Valor28;
                                        nNume1 = nNume1 + nNume2;
                                        |SI nNume1 = #71#5;
                                             |HAZ NuevoIgual;
                                        |SINO;
                                             |HAZ NuevoMenor;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                              nForma = 1; |HAZ ActCliAlb;
                         |FINSI;
                         |CIERRAT #73;
                         |CIERRAT #104;
                         |CIERRAT #71;
                         |CIERRAT #10;
                    |FINSI;
               |FINSI;
               |XLEE nHandle, 250, aDato;
          |SIGUE;
          |XCIERRA nHandle;
     |FINSI;

     aDestino = aPathReal + "procesados/";
     |RMKDIR aDestino;

     aNombre = aPath - aPathReal;
     |QBF aNombre;
     aOrigen = aPath;
     aDestino = aPathReal + "procesados/" + aNombre;
     |SI aIP = "";
          |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
          |RCOPIA_FICHERO aOrigen, aDestino;
     |FINSI;
     |RFBORRA aOrigen;

     || Busca fichero '.lot"
     aFic = "";
     aLon = aPath % A0;
     |PARA i = aLon; |SI i > 0; |HACIENDO i = i - 1;
          nPos = i * 100 + 1;
          aCar = aPath % nPos;
          |SI aCar = ".";
               i = i - 1;
               |PARA; |SI i > 0; |HACIENDO i = i - 1;
                    nPos = i * 100 + 1;
                    aCar = aPath % nPos;
                    aFic = aCar + aFic;
               |SIGUE;
               |SAL;
          |FINSI;
     |SIGUE;
     aFic = aFic + ".lot";

     |XABRE aTipo, aFic, enHandle;
     |SI FSalida ] 0;
          |SUB_EJECUTA_NP "coimz008";
          |XCIERRA enHandle;
     |FINSI;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     |SI #0#0 ! "SI"; |ACABA; |FINSI;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |HAZ CreaTempo; |NOME_DAT #134#Tempo#; aTmp134 = Tempo; |DELINDEX #134;
     |ABRE #134;

     aPath = #1#20; |QBF aPath;
     aAlfa = aPath % -101;
     |SI aAlfa ! "/"; |Y aAlfa ! "\"; aPath = aPath + "/"; |FINSI;

     aPathReal = aPath;

     aPath = aPath + "*.*";

     aIP = "";
     |IP_REMOTO aIP;
     |SI aIP = ""; aTipo = ""; |SINO; aTipo = "C"; |FINSI;

     |SI aParam ! "menu";
/*
          aQuito = #coima001#20;
          |QBF aQuito;
          aParam = aParam - aQuito;

          aPath = aParam;
          aAlfa = aParam % 104;
          aAlfa = aAlfa < "";
          |SI aAlfa = "pack";
*/

          aPath = aParam;
          aAlfa = aParam - "pack"
          |SI FSalida ! 0;
               eaImpPL = "S";
               eaFicheroFalcon = aParam;
               |SUB_EJECUTA_NP "coimz017";

               eaImpPL = "N";
               |ACABA;
          |SINO;
               |HAZ ProcesaFic;
          |FINSI;
     |SINO;
/*
     ||He quitado la opcion del menu.  Yo entiendo que para que sea correcto.
     ||faltaria la parte del |SDIR ....
     ||ESTO NO SE UTILIZA.  Si se activara .. hay que poner el control del "pack".

          |SI aIP = "";
               |_PDIR aPath;
               |PARA; |SI FSalida = 0; |HACIENDO;
                    |HAZ ProcesaFic;
     ||               |_SDIR aPath;
               |SIGUE;
          |SINO;
               |R_PDIR aPath;
               |PARA; |SI FSalida = 0; |HACIENDO;
                    |HAZ ProcesaFic;
     ||               |R_SDIR aPath;
               |SIGUE;
          |FINSI;
*/
     |FINSI;

     |CIERRA #134;
     |ABRE #20;
     |ABRE #10;
     |BUCLE Imprime;
     |CIERRA #10;
     |CIERRA #20;
     Tempo = aTmp134; |HAZ BoraTempo; |DELINDEX #134;
|FPRC;

|PROGRAMA;
     aParam = PARAMETRO; |QBF aParam;

     |ABRE #1; |LEE 000#1p; |CIERRA #1;

     |SI aParam = "menu";          || desde el menu (parametro menu)
          |MANTE #0;
     |SINO;
          #0#0 = "SI";
          |HAZ Tipo3;
/*
          |SI aParam = "";         || importar datos (sin parametro)
               #0#0 = "SI";
               |HAZ Tipo3;
          |SINO;                   || impresion (parametro=tipo+serie+alba)
                    ||No se usa
               aTipo = aParam % 101;
               aSer = aParam % 205;
               aNum = aParam % 706;
               |ABRE #10;
               #10#52 = aSer;
               #10#0 = aNum;
               |LEE 000#10=;
               |SI FSalida = 0;
                    ser_alb = #10#52;
                    num_alb = #10#0;
                    |SI aTipo = "N";    || Normal
                         eaImpresora = "CrystalReport";
                         eaMenuImpre = "N";
                         |SUB_EJECUTA_NP "agifa014";
                    |FINSI;
                    |SI aTipo = "A";    || Albaranes Agencia
                         eaImpreAge = #1#18; |QBF eaImpreAge;
                         |SUB_EJECUTA_NP "agifa011";
                    |FINSI;
                    |SI aTipo = "E";    || Etiquetas agencia
                         eaImpreEti = #1#19; |QBF eaImpreEti;
                         |SUB_EJECUTA_NP "agifa013";
                    |FINSI;
               |FINSI;
               |CIERRA #10;
          |FINSI;
*/
     |FINSI;
|FPRO;
