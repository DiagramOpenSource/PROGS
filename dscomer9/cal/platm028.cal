|FICHEROS;
 platm028 #0;
 platm011 #1;
 platm020 #2;
 platm012 #3;
 platm027 #4;
|FIN;

|VARIABLES;
 nCanti = 0;
 nModo = 0;
 nNumero = 0;
 aEstado = "";
 linea = 0;
 ii = 0;
 nVez = 0;
|FIN;

|PROCESO MiraEstado;
|ABRE #1;
#1#0 = #0#2;
|LEE 010#1=;
|SI FSalida ! 0;|DDEFECTO #1;|FINSI;
|LIBERA #1;
|CIERRA #1;
|FPRC;

|PROCESO SumaTip;
|QBF aEstado;
|ABRE #platm012;
#platm012#0 = #platm011#2;
|LEE 010#platm012.=;
|SI FSalida = 0;
  |SI aEstado = "ALMACEN";
    #platm012#2 = #platm012#2 -. 1;
  |FINSI;
  |SI aEstado = "INSTALADO";
    #platm012#3 = #platm012#3 -. 1;
  |FINSI;
  |SI aEstado = "AVERIADO";
    #platm012#4 = #platm012#4 -. 1;
  |FINSI;
  |SI aEstado = "REPARADO";
    #platm012#5 = #platm012#5 -. 1;
  |FINSI;
  #platm012#7 = #platm012#7 +. 1;
  #platm012#6 = #platm012#2 + #platm012#3 + #platm012#4 + #platm012#5 + #platm012#7;
  |GRABA 010#platm012.a;
|FINSI;
|LIBERA #platm012;
|CIERRA #platm012;
|FPRC;


|PROCESO AltaHis;
  |ABRE #1;
  #1#0 = #0#2;
  |LEE 010#1=;
  |SI FSalida = 0;
      aEstado = #1#7;
      #1#7 = "ENVIOPLATA";
      |GRABA 010#1a;
  |FINSI;
  |LIBERA #1;
  |CIERRA #1;

  |ABRE #2;
  #2#0 = #0#2;
  #2#3 = 999;
  |LEE 000#2];
  |SI FSalida = 0;
     |LEE 000#2a;
  |SINO;
     |LEE 000#2u;
  |FINSI;
  |SI FSalida = 0; |Y #2#0 = #0#2;
     linea = #2#3;
  |SINO;
     linea = 0;
  |FINSI;

  #2#0 = #0#2;
  #2#3 = linea+1;
  #2#1 = "ENVIOPLATAF";
  #2#2 = #4#2;
  #2#6 = #0#7; ||CANTIDAD
  |GRABA 010#2n;
  |LIBERA #2;
  |CIERRA #2;
|FPRC;

|CALCULO tipo3028;|TIPO 3;
nModo = (FEntrada/100)!0;

|CONFI "0000NActualizar historico";
|SI FSalida = 0;
     |HAZ AltaHis;
|FINSI;
|FCAL;

|PROCESO BajaHisto;
|ABRE #2;
|SELECT #3#2;
#2#0 = #0#2;
#2#1 = "ENVIOPLATAF";
#2#2 = #4#2;
|LEE 010#2=;
|SI FSalida = 0;
 |BORRA 010#2a;
|FINSI;
|LIBERA #2;
|CIERRA #2;
|FPRC;

|PROCESO SumaOtro;
|ABRE #1;
#1#0 = #0#2;
|LEE 010#1=;
|SI FSalida = 0;
  |ABRE #3;
  #3#0 = #1#2;
  |LEE 010#3=;
  |SI FSalida = 0;
     nCanti = #0#7;
     |SI #0#6 = 1; ||sale de almacen
       #3#2 = #3#2 -. nCanti;
     |FINSI;
     |SI #0#6 = 2; ||sale de averias
       #3#4 = #3#4 -. nCanti;
     |FINSI;
     #3#6 = #3#2 + #3#3 + #3#4 + #3#5 + #3#7;
     |GRABA 010#3a;
  |FINSI;
  |LIBERA #3;
  |CIERRA #3;
|FINSI;
|LIBERA #1;
|CIERRA #1;
|FPRC;

|PROCESO RequeteSuma;
|HAZ MiraEstado;
aEstado = #1#7;
|QBF aEstado;
|ABRE #platm012;
#platm012#0 = #platm011#2;
|LEE 010#platm012.=;
|SI FSalida = 0;
  |SI aEstado = "ALMACEN";
    #platm012#2 = #platm012#2 + 1;
  |FINSI;
  |SI aEstado = "INSTALADO";
    #platm012#3 = #platm012#3 + 1;
  |FINSI;
  |SI aEstado = "AVERIADO";
    #platm012#4 = #platm012#4 + 1;
  |FINSI;
  |SI aEstado = "REPARADO";
    #platm012#5 = #platm012#5 + 1;
  |FINSI;
  #platm012#6 = #platm012#2 + #platm012#3 + #platm012#4 + #platm012#5 + #platm012#7;
  |GRABA 010#platm012.a;
|FINSI;
|LIBERA #platm012;
|CIERRA #platm012;
|FPRC;

|CALCULO tipo2028;|TIPO 2;
|HAZ MiraEstado;
aEstado = #1#7;
nModo = (FEntrada/100)!0;
|SI nModo = 3;
 |HAZ RecuperaEstado;
 |HAZ BajaHisto
|FINSI;
nVez = nVez +. 1;
|SI nModo = 2;
  |SI nVez = -1;
     |HAZ BajaHisto;
     |HAZ RecuperaEstado;
     aEstado = #0#8;
  |FINSI;
|FINSI;
|SI #0#5 = "S";
  |HAZ SumaTip;
|SINO;
  |HAZ SumaOtro;
|FINSI;
|FCAL;

|CALCULO MiraTipo;|TIPO 6;
|ABRE #1;
#1#0 = #0#2;
|LEE 010#1=;
|SI FSalida = 0;
  |SI #1#8 = "S";
    aEstado = #1#7;
    |QBF aEstado;
    |SI aEstado ! "ALMACEN";|Y aEstado ! "AVERIADO";
      aEstado = "0000 Esta mercancia tiene el estado: "+ aEstado;
      |MENAV aEstado;
      |ERROR;
    |FINSI;
  |FINSI;
|FINSI;
|FCAL;

|CALCULO Mira;
|SI #0#5 = "S";
 |C_M #0#7, 1, "N";
 |C_M #0#6, 1, "N";
|SINO;
 |C_M #0#7, 1, "S";
 |C_M #0#6, 1, "S";
|FINSI;
|FCAL;

|PROCESO RecuperaEstado;
|ABRE #platm011;
#platm011#0 = #platm028#2;
|LEE 010#platm011.=;
|SI FSalida = 0;
  #platm011#7 = #platm028#8;
  |GRABA 010#platm011.a;
|FINSI;
|LIBERA #platm011;
|CIERRA #platm011;
|FPRC;
