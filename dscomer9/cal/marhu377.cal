||agifa010    AV
||agifa104    PV              NO, pq no van al historico
||agifa134    FV              NO, pq no van al historico

Vore en el historic els Depositos Ventas (DV)
||agifa036    DP         NO, porque no tiene campo Num. de Entrega.

|FICHEROS;
     marhu377 #0;
     marhu378 #378; ||Auxiliar para el cambio Cod. Cliente Dir. Entrega

     dsm00003 #3,MANTE;   ||Direcc.Entreg.Clien.

     agifa024 #24;  ||Clientes

     agifa010 #10;  ||Albaranes Vta. Cabs.
     agifa071 #71;  ||Albaranes Vta. Lin.
     agifa104 #104; ||Pedidos Ventas Cabs.
     agifa073 #73;  ||Pedidos Ventas Lin.
     agifa134 #134; ||Facturas.Vtas.Cabs.
     agifa059 #59;  ||Facturas.Vtas.Lin.

     agifa065 #65;  ||Historico
|FIN;

|VARIABLES;
     &eaLog = "";        ||Mensaje para el informe de anomalias
     aCodIni = "";
     aMensaje = "";
     aInforme = "";
     nCodBase = 0;
     aCodOri = "";
     aCodDes = "";
     aCliDes = "";
     nNumEnt = 0;
     nSwEsta = 0;
     nSwEstaCli = 0;

     ||Tema del Historico
     aArtHis = "";
     fFecHis = @;
     aCodHis = "";
     nNumHis = 0;
     nLinHis = 0;
     aSerHis = "";

     aCliFac = "";
     aCliAra = "";
     aCliAnt = "";
     nEntAra = 0;
     nEntAnt = 0;
     aNomCliAra = "";
     nSwCambiaCli = 0;
     nSwPie = 0;
|FIN;

|PROCESO min;
     #0#0 = "      ";
|FPRC;

|PROCESO max;
     #0#0 = "zzzzzz";
|FPRC;

|PROGRAMA;
     |CLS;
     |ABRE #0;
     |ENTLINEAL #1#0,-1,2,22,1,min,max;
     |SI FSalida=0;
          |CONFI "0000NRealizar el cambio de los codigos de Cliente?";
          |SI FSalida = 0;
               |HAZ Cambio;
          |FINSI;
     |FINSI;
     |CIERRA #0;
|FPRO;

|PROCESO VerifCodigo; |TIPO 0;
     aCodIni = #marhu377#2;
     |QBF aCodIni;
     |SI aCodIni = "";
          aMensaje = "0000Error: El Codigo no puede estar vacio.";
          |MENAV aMensaje;
          |ERROR;
     |SINO;
          |ABRE #agifa024;
          #agifa024#0 = #marhu377#2;
          |LEE 000#agifa024.=;
          |SI FSalida = 0;
               aMensaje = "0000Error: El Codigo no puede existir.";
               |MENAV aMensaje;
               |ERROR;
          |FINSI;
          |CIERRA #agifa024;
     |FINSI;
|FPRC;

|PROCESO dsm00003;
     |HAZ Principal;
|FPRC;

|DEFBUCLE dsm00003;
 #dsm00003;
 ;
 #marhu377#0, 0001;
 #marhu377#0, 9999;
 ;
 NULL, dsm00003;
|FIN;


|PROCESO marhu377;
     nCodBase = #marhu377#2;
     |BUCLE dsm00003;
|FPRC;

|DEFBUCLE marhu377;
 #marhu377#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, marhu377;
|FIN;

|PROCESO Cambio;
     |IMPRE 0;
     |SI FSalida = 0;
          aInforme = "marhu377";
          |INFOR aInforme;
          |SI FSalida = 0;
               ||TODO CCC
               |HAZ BorraAux;
               |ABRE #marhu378;
               |ABRE #agifa024;
               |BUCLE marhu377;
               |ABRE #marhu377;
               |ABRE #agifa065;
               |ABRE #agifa134;
               |HAZ RecorreAux;
               |CIERRA #agifa134;
               |CIERRA #agifa065;
               |CIERRA #agifa024;
               |CIERRA #marhu378;
               |CIERRA #marhu377;
               |SI nSwPie = 1;
                    |PIEINF;
               |FINSI;
               |FININF;
          |SINO;
               aMensaje = "0000Informe " + aInforme + " inaccesible.";
               |MENAV aMensaje;
          |FINSI;
          |FINIMP;
     |SINO;
          |MENAV "0000Proceso cancelado.";
     |FINSI;
|FPRC;

|PROCESO Principal;
     aCodOri = #marhu377#0;
     aCodDes = ("000000" + nCodBase) % -106;
     nNumEnt = #dsm00003#1;
     |DDEFECTO #agifa024;
     #agifa024#0 = aCodDes;
     |LEE 000#agifa024.=;
     |SI FSalida = 0;
          eaLog = aCodDes + ": Ya existe este codigo de Cliente";
          |PRINT;
          nSwPie = 1;
     |SINO;
          #agifa024#0 = aCodOri;
          |LEE 010#agifa024.=;
          |SI FSalida = 0;
               #agifa024#0 = aCodDes;
               |GRABA 020#agifa024.b;
               #agifa024#5 = #dsm00003#2;
               #agifa024#6 = #dsm00003#3;
               #agifa024#7 = #dsm00003#7;
               #agifa024#14 = #dsm00003#8;
               #agifa024#2 = #dsm00003#10;
               #agifa024#178 = #dsm00003#4;
               #agifa024#179 = #dsm00003#5;
               #agifa024#3 = #dsm00003#11;
               #agifa024#17 = #dsm00003#13;
               #agifa024#25 = #dsm00003#14;
               |GRABA 020#agifa024.a;
               |LIBERA #agifa024;

               |DDEFECTO #marhu378;
               #marhu378#0 = aCodOri;
               #marhu378#1 = nNumEnt;
               |LEE 101#marhu378.=;
               |SI FSalida ! 0; |GRABA 020#marhu378.b; |FINSI;
               #marhu378#2 = aCodDes;
               #marhu378#3 = #dsm00003#10;
               |GRABA 020#marhu378.a;
               |LIBERA #marhu378;
          |FINSI;
     |FINSI;
     nCodBase = nCodBase + 1;
|FPRC;

|PROCESO agifa071;
     aArtHis = #agifa071#2;
     fFecHis = #agifa010#1;
     aCodHis = "AV";
     nNumHis = #agifa071#0;
     nLinHis = #agifa071#1;
     aSerHis = #agifa071#29;
     |HAZ Historico;
|FPRC;

|DEFBUCLE agifa071;
 #agifa071#1;
 ;
 #agifa010#52, #agifa010#0, 001;
 #agifa010#52, #agifa010#0, 999;
 ;
 NULL, agifa071;
|FIN;

|PROCESO Lineas010;
     |BUCLE agifa071;
|FPRC;

|PROCESO agifa010a;
     aCodOri = #agifa010#3;
     nNumEnt = #agifa010#84;
     nSwEsta = 0;
     |HAZ BuscaAux;
     |SI nSwEsta = 1;
          #agifa010#3 = aCodDes;
          #agifa010#4 = aCliDes;
          #agifa010#84 = 1;
          |GRABA 020#agifa010.a;
          |LIBERA #agifa010;
          |HAZ Lineas010;
     |FINSI;
|FPRC;

|DEFBUCLE agifa010;
 #agifa010#1;
 ;
 INICIO;
 FINAL;
 be;
 NULL, agifa010a;
|FIN;

|PROCESO Procesa010;
     |BUCLE agifa010;
|FPRC;

|PROCESO agifa073;
     aArtHis = #agifa073#2;
     fFecHis = #agifa104#1;
     aCodHis = "PV";
     nNumHis = #agifa073#0;
     nLinHis = #agifa073#1;
     aSerHis = #agifa073#28;
     |HAZ Historico;
|FPRC;

|DEFBUCLE agifa073;
 #agifa073#1;
 ;
 #agifa104#25, #agifa104#0, 001;
 #agifa104#25, #agifa104#0, 999;
 ;
 NULL, agifa073;
|FIN;

|PROCESO Lineas104;
     |BUCLE agifa073;
|FPRC;

|PROCESO agifa104;
     aCodOri = #agifa104#4;
     nNumEnt = #agifa104#57;
     nSwEsta = 0;
     |HAZ BuscaAux;
     |SI nSwEsta = 1;
          #agifa104#4 = aCodDes;
          #agifa104#8 = aCliDes;
          #agifa104#57 = 1;
          |GRABA 020#agifa104.a;
          |LIBERA #agifa104;
          |HAZ Lineas104;
     |FINSI;
|FPRC;

|DEFBUCLE agifa104;
 #agifa104#1;
 ;
 INICIO;
 FINAL;
 be;
 NULL, agifa104;
|FIN;

|PROCESO Procesa104;
     |BUCLE agifa104;
|FPRC;

|PROCESO agifa134;
     aCliFac = #agifa134#2;
     nSwEstaCli = 0;
     |HAZ BuscaCli;
     |SI nSwEstaCli = 1;
          |HAZ MiraLinFac;
          |SI nSwCambiaCli = 1;
               ||TODO CCC
               #agifa134#2 = aCliAra;
               #agifa134#3 = aNomCliAra;
               |GRABA 020#agifa134.a;
               |LIBERA #agifa134;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE agifa134;
 #agifa134#1;
 ;
 INICIO;
 FINAL;
 be;
 NULL, agifa134;
|FIN;

|PROCESO Procesa134;
     ||TODO CCC
     |BUCLE agifa134;
|FPRC;

|PROCESO marhu378b;
     |BORRA 020#marhu378.a;
|FPRC;

|DEFBUCLE marhu378b;
 #marhu378#1;
 ;
 INICIO;
 FINAL;
 be;
 NULL, marhu378b;
|FIN;

|PROCESO BorraAux;
     |BUCLE marhu378b;
|FPRC;

|PROCESO RecorreAux;
     |HAZ Procesa010;    ||Albaranes
     |HAZ Procesa104;    ||Pedidos
     |ABRE #agifa010;
     |HAZ Procesa134;    ||Facturas
     |CIERRA #agifa010;
|FPRC;

|PROCESO BuscaAux;
     #marhu378#0 = aCodOri;
     #marhu378#1 = nNumEnt;
     |LEE 000#marhu378.=;
     |SI FSalida = 0;
          nSwEsta = 1;
          aCodDes = #marhu378#2;
          aCliDes = #marhu378#3;
     |FINSI;
|FPRC;

|PROCESO Historico;
     ||Cambia el codigo del cliente segun lo que le pasemos.
     |DDEFECTO #agifa065;
     #agifa065#0 = aArtHis;
     #agifa065#1 = fFecHis;
     #agifa065#2 = aCodHis;
     #agifa065#3 = nNumHis;
     #agifa065#4 = nLinHis;
     #agifa065#11 = aSerHis;
     |LEE 101#agifa065.=;
     |SI FSalida = 0;
          #agifa065#10 = aCodDes;
          |GRABA 020#agifa065.a;
          |LIBERA #agifa065;
     |FINSI;
|FPRC;

|PROCESO BuscaCli;
     #marhu377#0 = aCliFac;
     |LEE 000#marhu377.=;
     |SI FSalida = 0;
          nSwEstaCli = 1;
     |FINSI;
|FPRC;

|PROCESO agifa059;
     #agifa010#52 = #agifa059#15;
     #agifa010#0 = #agifa059#2;
     |LEE 000#agifa010.=;
     |SI FSalida = 0;
          aNomCliAra = #agifa010#4;
          aCliAra = #agifa010#3;
          nEntAra = #agifa010#84;
          |SI aCliAnt = ""; |Y nEntAnt = 0;
               aCliAnt = aCliAra;
               nEntAnt = nEntAra;
          |FINSI;
          |SI aCliAra ! aCliAnt; |O nEntAra ! nEntAnt;
               nSwCambiaCli = 0;
               eaLog = "Factura [" + #agifa134#49 + "/" + #agifa134#0 + "] contiene albaranes con distintas direcciones de entrega";
               |PRINT;
               nSwPie = 1;
               |ERROR10;
          |SINO;
               |SI aCliAra ! #agifa134#2;
                    nSwCambiaCli = 1;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE agifa059;
 #agifa059;
 ;
 #agifa134#49, #agifa134#0, 001;
 #agifa134#49, #agifa134#0, 999;
 ;
 NULL, agifa059;
|FIN;

|PROCESO MiraLinFac;
     nSwCambiaCli = 0;
     aCliAnt = "";
     nEntAnt = 0;
     |BUCLE agifa059;
|FPRC;
