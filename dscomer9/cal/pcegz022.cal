|FICHEROS;
     pcegm002 #2;
     pcegm004 #4;
     pcegm005 #5;
     pcegm016 #16;
     agifa010 #10;
     pcegm012 #12;  || Aux. Articulo
     agifa017 #17;
     agifa019 #19;
     dsm00020 #20;
     pcegm023 #23;
     agifa024 #24;
     pcegm042 #42;
     agifa025 #25;
     agifa059 #59;
     agifa071 #71;
     dsm00124 #124;
     agifa134 #134;
     agifa142 #142;
     agifa704;
     agifa716;
     agifa722;
     agifa071@;
     Referen@;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     &PRMNT_enError = 0;
     &enErrCarte = 0;
     &eaProg = "";
     &enSwMenu = 0;
     &aDivisa = "";
     &aMoneda = "";
     &ser_fac = "";
     &num_fac = 0;
     &reimp = "";
     &eaImprime = "";
     &ser_alb = "";
     &num_alb = 0;
     &enAlba = 0;
     &eaImpresora = "";

     nError = 0;
     aAlfa = "";
     aDoc = "";
     aTipo = "";
     aRese = "";
     aSer = "";
     aNum = "";
     nPrime = 0;
     nSw = 0;
     aArti = "";
     aEsCalibra = "";
     nPendiente = 0;
     aServir = "";
     nUni = 0;
     nNume = 0;
     aFase = "";
     aSerPed = "";
     nNumPed = 0;
     aSerSal = "";
     nNumSal = 0;
     aPath = "";
     aRes = "";
     aPen = "";
     aCali = "";
     fHoy = @;
     nLon = 0;
     aLon = "";
     nPos = 0;
     aA¤o = "";
     nLinBor = 0;
     &nImpo = 0;
     margen = 0;
     nForma = 0;
     fmes = "";
     mes = 0;
     &eaTag = "";
     imneto = 0;
     nDto = 0;
     nHay = 0;
|FIN;

|PROCESO ActuFa;
     |ABRE #24;
     #24#0 = #134#2;
     |LEE 121#24=;
     |SI 0 = FSalida;
          fmes = #134#1 % A402;
          mes = ((fmes - 1) * 4) + 54;
          imneto = #134#18 - #134#17;
          |SI #142#115 = "N";
               nImpo = (imneto * 100) / (100 - #134#6);
               nDto = #134#17 + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
               nDto = #134#17;
          |FINSI;
          #24#50 = #24#50 -. imneto;        || pendiente de facturar
          #24mes = #24mes +. nImpo;
          mes = mes + 1;
          #24mes = #24mes +. nDto;
          mes = mes + 1;
          #24mes = #24mes +. #134#46;
          #24#102 = #24#102 +. nImpo;
          #24#103 = #24#103 +. nDto;
          #24#104 = #24#104 +. #134#46;
          #24#45 = #134#1;
          #24#46 = imneto;
          #24#110 = #24#110 +. imneto;
          #24#175 = "N";
          |GRABA 020#24a;

          enImpCliPen = -imneto;
          enImpCliCom = nImpo;
          enImpCliDto = nDto;
          enImpCliMar = #134#46;
          enImpCliFac = imneto;
          eaCliente = #134#2;
          efFecha = #134#1;
          |HAZ AcumulaCli;
     |FINSI;
     |CIERRA #24;

     |ABRE #25;
     #25#0 = #134#7;
     |LIBERA #25;
     |LEE 121#25=;
     |SI 0 = FSalida;
          imneto = #134#18 - #134#17;
          fmes = #134#1 % A402;
          mes = fmes - 1;
          mes = mes * 2;
          mes = mes + 11;
          #25mes = #25mes +. #134#8;

          mes = mes + 1;
          #25mes = #25mes +. imneto;
          #25#35 = #25#35 +. #134#8;
          #25#36 = #25#36 +. imneto;
          mes = fmes - 1;
          mes = mes + 40;
          #25mes = #25mes + #134#55;
          #25#52 = #25#52 + #134#55;

          #25#54 = "N";
          |GRABA 020#25a;

          enImpRepComi = #134#8;
          enImpRepVta = imneto;
          enImpRepRete = #134#55;
          eaRepre = #134#7;
          efFecha = #134#1;
          |HAZ AcumulaRep;

     |FINSI;
     |CIERRA #25;
     ||************* CALCULA EL RIESGO EN FACTURAS;
     eaTag = "FAC";  |HAZ Riesgos;
|FPRC;

|PROCESO StockBaja;
     |SI #71#5 < 0; |ACABA; |FINSI;

|| Modificado  Subtiquet nro. 00320.0007
||     |SI aRese = "S";
          |DDEFECTO #12;
          |ABRE #12;
          #12#0 = #71#2;
          |LEE 101#12=;
          |SI FSalida ! 0; |GRABA 020#12b; |FINSI;
          #12#1 = #12#1 + #71#5;
          |GRABA 020#12a;
          |CIERRA #12;
||     |FINSI;

     |ABRE #17;
     |ABRE #19;
     |DDEFECTO #17;
     |DDEFECTO #19;
     #19#0 = #71#2;
     |LEE 101#19=;
     |SI FSalida ! 0; |GRABA 020#19b; |FINSI;
     #17#0 = #71#2;
     #17#1 = #71#3;
     |LEE 101#17=;
     |SI FSalida ! 0; |GRABA 020#17b; |FINSI;

     |SI aRese = "S";
          #19#12 = #19#12 + #71#5;
          #17#8 = #17#8 + #71#5;

          #19#104 = #19#104 - #71#5;
          #17#39 = #17#39 - #71#5;
     |FINSI;

     #19#15 = #19#15 + #71#5;
     #17#42 = #17#42 + #71#5;

     |HAZ ValoraStock;
     |GRABA 020#19a;
     |GRABA 020#17a;

     |CIERRA #19;
     |CIERRA #17;
|FPRC;

|PROCESO ReserPedido;
     |SI #71#5 < 0; |ACABA; |FINSI;

     |DDEFECTO #12;
     |ABRE #12;
     #12#0 = #71#2;
     |LEE 101#12=;
     |SI FSalida ! 0; |GRABA 020#12b; |FINSI;
     #12#1 = #12#1 - #71#5;
     |GRABA 020#12a;
     |CIERRA #12;

     |ABRE #17;
     |ABRE #19;
     |DDEFECTO #17;
     |DDEFECTO #19;
     #19#0 = #71#2;
     |LEE 101#19=;
     |SI FSalida ! 0; |GRABA 020#19b; |FINSI;
     #17#0 = #71#2;
     #17#1 = #71#3;
     |LEE 101#17=;
     |SI FSalida ! 0; |GRABA 020#17b; |FINSI;

     #19#15 = #19#15 - #71#5;
     #19#12 = #19#12 - #71#5;

     #17#42 = #17#42 - #71#5;
     #17#8 = #17#8 - #71#5;

     || incremento el disponilbe porque AcumulAV resta otra vez de este
     #19#104 = #19#104 + #71#5;
     #17#39 = #17#39 + #71#5;

     |HAZ ValoraStock;
     |GRABA 020#19a;
     |GRABA 020#17a;

     |CIERRA #19;
     |CIERRA #17;
|FPRC;

|PROCESO ImpFactura;
     |LIBERA #134;

     |SI #134#0 ! 0;
          ser_fac = #134#49;
          num_fac = #134#0;
          reimp = "N";
          eaImprime = "CrystalReport";
          |SUB_EJECUTA_NP "agifa136;"
     |FINSI;
|FPRC;

|PROCESO ImpAlbaran;
     |LIBERA #10;

     |SI #10#0 ! 0;
          eaImpresora = "CrystalReport";
          ser_alb = #10#52;
          num_alb = #10#0;
          |SUB_EJECUTA_NP "agifa014";
     |FINSI;
|FPRC;

|PROCESO BuscaPed;
     aSerPed = #71#31;
     nNumPed = #71#12;
|FPRC;

|PROCESO EsReparacion; ||-----------Comprueba si es de reparacion
     aTipo = "AV";
     |ABRE #71;
     #71#29 = aSer;
     #71#0 = aNum;
     #71#1 = 1;
     |LEE 000#71];
     |SI #71#29 = aSer; |Y #71#0 = aNum;
          |ABRE #4;
          #4#25 = #71#31;
          #4#0 = #71#12;
          |LEE 000#4=;
          |SI FSalida = 0; |Y #4#96 ! 0;
               aSer = #4#95;
               aNum = #4#96;
               aTipo = "RE";
          |FINSI;
          |CIERRA #4;
     |FINSI;
     |CIERRA #71;
|FPRC;

|PROCESO Etiqueta;
     |LIBERA #10;
     |SI #10#0 ! 0;
          aSer = #10#52;
          aNum = #10#0;
          aTipo = "AV";
          |HAZ EsReparacion;
          eaSerie = aSer;
          enDocu = aNum;
          eaTipo = aTipo;
          |SUB_EJECUTA_NP "pcegz019";
     |FINSI;
|FPRC;

|PROCESO ActFac;
     #19#0 = #71#2;
     |LEE 121#19=;
     |SI FSalida = 0;
          #71#14 = #71#5 * #19#9;  ||Coste
          |GRABA 020#71a;

          |SI #19#194 = 2;
               nImpo = ((((#71#48 * #71#6) < #71#8) < #71#33) < #10#5) < #10#32;
          |SINO;
               nImpo = ((((#71#5 * #71#6) < #71#8) < #71#33) < #10#5) < #10#32;
          |FINSI;
          |SI #142#115 = "S";
               nImpo = nImpo < #10#7;
          |FINSI;
          margen = #71#14;             ||Coste albaran !!
          |SI #134#57 = "S";
               nImpo = -nImpo;
               margen = nImpo + margen;
          |SINO;
               margen = nImpo - margen;
          |FINSI;
          #10#37 = #10#37 + (margen * nForma);

          fmes = #134#1 % A402;
          mes = ((fmes - 1) * 5) + 35;

          #19mes = #19mes + (nImpo * nForma);      ||       imneto;
          mes = mes + 1;
          #19mes = #19mes + (margen * nForma);
          #19#95 = #19#95 + (nImpo * nForma);       ||    imneto;
          #19#96 = #19#96 + (margen * nForma);
          mes = (FEntrada / 100) ! 0;
          |SI 1 = mes;
               #19#24 = #134#1;
               #19#25 = #71#5;
          |FINSI;
          |GRABA 020#19a;

          efFecha = #134#1;
          eaArticulo = #71#2;
          enImpVta = (nImpo * nForma);
          enImpMar = (margen * nForma);
          |HAZ AcumulaArt;

          enForma = nForma;
          enImpKit = nImpo;
          enMrgKit = margen;
          |HAZ ImpArtKit;    || Acumulados Articulos con Kit
     |FINSI;
     |LIBERA #71;
|FPRC;

|PROCESO CabFac;
     #134#1 = ~;
     #134#2 = #10#3;
     #134#3 = #10#4;
     #134#4 = #10#5;
     #134#5 = #10#32;
     #134#6 = #10#7;
     #134#7 = #10#6;
     #134#9 = #24#29;
     #134#10 = #24#30;
     #134#11 = #10#8;
     #134#12 = #24#16;
     #134#13 = #10#36;
     #134#14 = #24#22;
     #134#15 = #24#23;
     #134#16 = #24#24;
     #134#58 = #10#68;
     #134#59 = #10#69;
     #134#60 = #10#70;
     #134#61 = #10#73;
     #134#62 = #10#74;
     #134#63 = 1;
     #134#115 = #10#84;
     #134#124 = #10#63;
|FPRC;

|PROCESO LinFac;
     |DDEFECTO #59;
     #59#14 = #134#49;
     #59#0 = #134#0;
     #59#1 = 1;
     #59#2 = #10#0;
     #59#15 = #10#52;
     #59#18 = #10#68;
     #59#19 = #10#69;
     #59#20 = #10#70;
     |GRABA 020#59n;

     nForma = 1;
     |ABRE #19;
     |BUCLELIN 0 ActFac #10;
     |CIERRA #19;
|FPRC;

|PROCESO CreaFactura;
     aAlfa = #4#25;
     |HAZ CamA¤oSerie;

     |ABRE #134;
     |ABRE #59;
     #134#49 = aAlfa;

     |HAZ ContaHuecoFV;
/*
     enSwMenu = 1;
     |HAZ ContaFV7;
     |GRABA 000#134b;
     |PARA; |SI FSalida ! 0; |HACIENDO;
          #134#0 = #134#0 + 1;
          |GRABA 020#134b;
     |SIGUE;
*/
     #10#53 = #134#49;
     #10#39 = #134#0;
     |GRABA 020#10a;

     |HAZ CabFac;
     |HAZ LinFac;

     aDivisa = #134#58;
     aMoneda = #134#60;
     |HAZ Divisas134;
     |HAZ CalCabAgifa134;
     |HAZ VenciVta;
     |GRABA 020#134a;
     |HAZ ActuFa;
     |CIERRA #59;
     |CIERRA #134;
|FPRC;

|PROCESO CamA¤oSerie;
     |QBF aAlfa;
     aLon = aAlfa % A0;
     nLon = aLon;
     nPos = nLon - 2;
     fHoy = ~;
     aA¤o = fHoy % -102;
     |SI nPos [ 0;
          aAlfa = aA¤o;
     |SINO;
          nPos = nPos + 100;
          aAlfa = aAlfa % nPos;
          aAlfa = aAlfa + aA¤o;
     |FINSI;
|FPRC;

|PROCESO CabAlba;
     aAlfa = #4#25;
     |HAZ CamA¤oSerie;

     |SI nSw = 1;   || Alb.Sal
          #10#52 = aAlfa;
     |SINO;         || Alb.Vta
          #10#52 = "Z" + aAlfa;
     |FINSI;
     enSwMenu = 1;
     |HAZ ContaAV7;
     |GRABA 000#10b;
     |PARA; |SI FSalida ! 0; |HACIENDO;
          #10#0 = #10#0+ 1;
          |GRABA 020#10b;
     |SIGUE;

     |DDEFECTO #20;
     |ABRE #20;
     #20#0 = #4#60;
     |LEE 000#20=;
     |CIERRA #20;
     |ABRE #24;
     #24#0 = #4#4;
     |LEE 000#24=;
     |CIERRA #24;

     #10#1 = ~;
     #10#3 = #4#4;
     #10#4 = #4#8;
     #10#5 = #4#5;
     #10#6 = #4#7;
     #10#7 = #4#6;
     #10#8 = #4#9;
     #10#9 = #20#1;

     |SI nSw = 2;                  || = Albaran Z
          |SI #4#37 = "D";
               |SI #4#98 ! #4#100;
                    #10#81 = #4#98;
                    #10#11 = #4#67;
                    #4#100 = #4#98;
                    #4#97 = #4#67;
               |FINSI;
          |SINO;
               |SI #4#67 ! #4#97;
                    #10#81 = #4#98;
                    #10#11 = #4#67;
                    #4#100 = #4#98;
                    #4#97 = #4#67;
               |FINSI;
          |FINSI;
     |SINO;
          |SI #4#37 = "D";
               |SI #4#98 ! #4#99;
                    #10#81 = #4#98;
                    #10#11 = #4#67;
                    #4#99 = #4#98;
                    #4#68 = #4#67;
               |FINSI;
          |SINO;
               |SI #4#67 ! #4#68;
                    #10#81 = #4#98;
                    #10#11 = #4#67;
                    #4#99 = #4#98;
                    #4#68 = #4#67;
               |FINSI;
          |FINSI;
     |FINSI;

     #10#12 = #4#82;
     #10#29 = #4#19;
     #10#30 = #4#14;
     #10#31 = #4#20;
     #10#32 = #4#17;
     #10#33 = #4#21;
     #10#34 = #4#16;
     #10#35 = #4#18;
     #10#36 = #24#47;
     #10#37 = #24#41;
     #10#55 = #4#53;
     #10#56 = #4#54;
     #10#57 = #4#55;
     #10#62 = #4#59;
     #10#63 = #4#64;
     #10#64 = #4#61;
     #10#68 = #4#35;
     #10#69 = #4#36;
     #10#70 = #4#37;
     #10#73 = #4#40;
     #10#74 = #4#41;
     #10#83 = #4#51;
     #10#84 = #4#57;
     #10#88 = #20#0;

     aDivisa = #10#68;
     aMoneda = #10#70;
     |HAZ Divisas010;

     |HAZ LimCabAgifa010;

     |HAZ RecalTipoPed;
     |GRABA 020#4a;
     |GRABA 020#10a;
|FPRC;

|PROCESO CreaAlbaran;
     |SI nSw = 1;
          nUni = #5#60;            || Reservadas
     |SINO;
          nUni = #5#5 - #5#59;     || Pedidas - Facturadas
          |SI nUni [ 0; |ACABA; |FINSI;

          #agifa071@#29 = aSerSal;
          #agifa071@#0 = nNumSal;
          #agifa071@#1 = #5#1;
          |LEE 000#agifa071@.=;
          |SI FSalida ! 0; |ACABA; |FINSI;

          |SI nUni > #agifa071@#5;
               nUni = #agifa071@#5;     || Factura las unidades del albaran
          |FINSI;
     |FINSI;
     |SI nUni [ 0; |ACABA; |FINSI;

     |SI nPrime = 0;
          |HAZ CabAlba;
          nPrime = 1;
     |FINSI;

     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = #5#1;
     #71#2 = #5#2;
     #71#3 = #5#3;
     #71#4 = #5#4;
     #71#5 = nUni;
     #71#6 = #5#6;
     #71#8 = #5#8;
     #71#10 = #5#10;
     #71#11 = #5#14;
     #71#12 = #5#0;
     #71#13 = #5#18;
     #71#15 = #10#3;
     #71#16 = #5#17;
     #71#17 = #5#19;
     #71#21 = #5#1;
     #71#27 = #5#27;
     #71#31 = #5#28;
     #71#33 = #5#29;
     #71#34 = #5#35;
     #71#35 = #5#36;
     #71#36 = #5#38;
     #71#49 =  #5#45;

     |HAZ TotalLin71;
     |HAZ CalCabAgifa010;
     |GRABA 020#71n;
     #10#41 = #10#41 + 1;
     |GRABA 020#10a;

     |SI nSw = 1;        || Alb.Sal
          enForma = 1;
          |SI aDoc = "P";
               |HAZ ReserPedido;
          |FINSI;
          |HAZ AcumulaAV;
          #5#43 = #5#43 + #71#5;
          #5#60 = #5#60 - #71#5;
     |SINO;              || Alb.Vta
          #5#59 = #5#59 + #71#5;
     |FINSI;
     |GRABA 020#5a;
|FPRC;

|PROCESO CheqCalibra;
     aAlfa = #5#2;
     aAlfa = aAlfa - "CAL";
     |SI FSalida > 0;
          nNume = #5#5 - #5#43 - #5#60;
          |SI nNume > 0;
               aServir = "N";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO AceptaPedido;
     |ABRE #10;
     |ABRE #71;
     |ABRE #4;
     #4#25 = aSer;
     #4#0 = aNum;
     |LEE 121#4=;
     |SI FSalida = 0;
          aServir = "S";
          |BUCLELIN 2 CheqCalibra #4;
          |SI aServir = "N";
               |CONFI "0000NExisten calibraciones pendientes. ¿Aun así desea servir mercancia reservada?";
               |SI FSalida ! 0; |ACABA; |FINSI;
          |FINSI;

          nPrime = 0;
          nSw = 1; |BUCLELIN 2 CreaAlbaran #4; || Alb. Sal
          |SI nPrime = 0; |ACABA; |FINSI;
          aSerSal = #10#52; nNumSal = #10#0;

          |SALVA_DATOS #10;
          nPrime = 0;
          nSw = 2; |BUCLELIN 2 CreaAlbaran #4; || Alb. Vta
          |SI nPrime = 0;
               aAlfa = "";
               |DDEFECTO #134;
          |SINO;
               |ABRE #16;
               #16#0 = #10#52;
               #16#1 = #10#0;
               #16#2 = aSerSal;
               #16#3 = nNumSal;
               |GRABA 020#16n;
               |CIERRA #16;

               |HAZ CreaFactura;
               aAlfa = #10#52 + "/" + (("000000" + #10#0) % -106);
          |FINSI;
          |REPON_DATOS #10;
          |LEE 121#10=;
          |SI FSalida = 0; |Y aAlfa ! "";
               #10#55 = aAlfa;
               |GRABA 020#10a;
          |FINSI;

          |HAZ ImpAlbaran;
          |HAZ ImpFactura;
          |HAZ Etiqueta;
     |FINSI;
     |CIERRA #4;
     |CIERRA #10;
     |CIERRA #71;
|FPRC;
----------------------------------------------------------------
|PROCESO BorraLinAlba;
     nForma = -1;
     |HAZ ActFac;

     |BORRA 020#71a;
     |ABRE #4;
     |ABRE #5;
     #4#25 = #71#31;
     #4#0 = #71#12;
     |LEE 101#4=;
     |SI FSalida = 0;
          #5#28 = #71#31;
          #5#0 = #71#12;
          #5#1 = #71#21;
          |LEE 121#5=;
          |SI FSalida = 0;
               #5#59 = #5#59 - #71#5;
               |GRABA 020#5a;
          |FINSI;

          |SI nLinBor = 0;     || Para que solo reste una vez
               nLinBor = nLinBor + 1;
               #4#97 = #4#97 - #10#11;  || Albaran Z
               #4#100 = #4#100 - #10#81;
          |FINSI;

          |HAZ RecalTipoPed;
          |GRABA 020#4a;

          |ABRE #2; |SELECT #6#2; || Cambia situacion parte Reparacion
          #2#60 = #4#25;
          #2#61 = #4#0;
          |LEE 000#2=;
          |SI FSalida = 0;
               |ABRE #42; |SELECT #4#42;
               #42#15 = #2#48;
               #42#16 = #2#0;
               |LEE 101#42=;
               |SI FSalida = 0;
                    #42#17 = "01.01.0000";
                    #42#18 = "";
                    #42#22 = "F";
                    |GRABA 020#42a;
               |FINSI;
               |CIERRA #42;
          |FINSI;
          |CIERRA #2;

     |FINSI;
     |CIERRA #5;
     |CIERRA #4;
|FPRC;

|PROCESO BorraLinVta;
     |BORRA 020#59a;
     |ABRE #10;
     #10#52 = #59#15;
     #10#0 = #59#2;
     |LEE 121#10=;
     |SI FSalida = 0;
          nLinBor = 0;
          |ABRE #19;
          |BUCLELIN 2 BorraLinAlba #10;
          |CIERRA #19;
          |SI aDoc ! "X";  || si ex 'X' se borra en el "actufl" del agifa134
               |BORRA 020#10a;
          |FINSI;

          |ABRE #16;
          #16#0 = #10#52;
          #16#1 = #10#0;
          |LEE 101#16=;
          |SI FSalida = 0;
               aSer = #16#2;
               aNum = #16#3;
               |HAZ CancelaAlba;
               |BORRA 000#16a;
          |FINSI;
          |CIERRA #16;
     |FINSI;
     |CIERRA #10;
|FPRC;

|PROCESO AnulaFactura;
     |ABRE #134;
     #134#49 = aSer;
     #134#0 = aNum;
     |LEE 121#134=;
     |SI FSalida = 0;
          |SI #134#45 = "S";
               eaProg = "agifa134"; |HAZ MiraRecVenta;
               |SI enErrCarte ! 0;
                     aAlfa = "0000Recibos con movimientos, NO SE DARA DE BAJA... [" + enErrCarte + "]";
                     |MENAV aAlfa; |ACABA;
               |FINSI;
               eaProg = "agifa134";
               |HAZ BorraRecVenta;
               |HAZ BorraVenciVta;
          |FINSI;
          |BUCLELIN 2 BorraLinVta #134;
          |BORRA 020#134a;
     |FINSI;
     |CIERRA #134;
|FPRC;

|PROCESO BorraLinVta2;
     |ABRE #10;
     #10#52 = #59#15;
     #10#0 = #59#2;
     |LEE 121#10=;
     |SI FSalida = 0;
          nLinBor = 0;
          |ABRE #19;
          |BUCLELIN 2 BorraLinAlba #10;
          |CIERRA  #19;

          |ABRE #16;
          #16#0 = #10#52;
          #16#1 = #10#0;
          |LEE 101#16=;
          |SI FSalida = 0;
               aSer = #16#2;
               aNum = #16#3;
               |HAZ CancelaAlba;
               |BORRA 000#16a;
          |FINSI;
          |CIERRA #16;
     |FINSI;
     |CIERRA #10;
|FPRC;

|PROCESO BorraFactura;
     |ABRE #134;
     #134#49 = aSer;
     #134#0 = aNum;
     |LEE 020#134=;
     |SI FSalida = 0;
          |BUCLELIN 2 BorraLinVta2 #134;
     |FINSI;
     |CIERRA #134;
|FPRC;

|PROCESO BorraAlbLin;
     enForma = -1;
     |HAZ AcumulaAV;
     |BORRA 020#71a;

     |ABRE #4;
     |ABRE #5;
     #4#25 = #71#31;
     #4#0 = #71#12;
     |LEE 121#4=;
     |SI FSalida = 0;
          #5#28 = #71#31;
          #5#0 = #71#12;
          #5#1 = #71#21;
          |LEE 121#5=;
          |SI FSalida = 0;
               #5#43 = #5#43 - #71#5;
               |SI aRese = "S";
                    #5#60 = #5#60 + #71#5;
               |FINSI;
               |GRABA 020#5a;
               |HAZ StockBaja;
          |FINSI;
          |SI aRese = "S";
               #4#84 = aFase;
          |FINSI;
          |SI nLinBor = 0;     || Para que solo reste una vez
               nLinBor = nLinBor + 1;
               #4#68 = #4#68 - #10#11;    || Albaran Normal
               #4#99 = #4#99 - #10#81;
          |FINSI;
          |HAZ RecalTipoPed;

          |GRABA 020#4a;
     |FINSI;
     |CIERRA #5;
     |CIERRA #4;
|FPRC;

|PROCESO CancelaAlba;
     |ABRE #10;
     #10#52 = aSer; || Albaran Salida
     #10#0 = aNum;
     |LEE 101#10=;
     |SI FSalida = 0;
          nLinBor = 0;
          |BUCLELIN 2 BorraAlbLin #10;
          |BORRA 020#10a;

     |FINSI;
     |CIERRA #10;

     |HAZ EsReparacion;
     |ABRE #23;
     #23#0 = aTipo;
     #23#1 = aSer;
     #23#2 = aNum;
     |BORRA 000#23c;
     |CIERRA #23;
|FPRC;

|PROCESO BorraAlbLin2;
     |ABRE #4;
     |ABRE #5;
     #4#25 = #71#31;
     #4#0 = #71#12;
     |LEE 121#4=;
     |SI FSalida = 0;
          #5#28 = #71#31;
          #5#0 = #71#12;
          #5#1 = #71#21;
          |LEE 121#5=;
          |SI FSalida = 0;
               #5#43 = #5#43 - #71#5;
               |GRABA 020#5a;
               |HAZ StockBaja;
          |FINSI;
          |HAZ RecalTipoPed;
          |GRABA 020#4a;
     |FINSI;
     |CIERRA #5;
     |CIERRA #4;
|FPRC;

|PROCESO BorraAlbaran;
     |ABRE #10;
     #10#52 = aSer; || Albaran Salida
     #10#0 = aNum;
     |LEE 101#10=;
     |SI FSalida = 0;
          |BUCLELIN 2 BorraAlbLin2 #10;
     |FINSI;
     |CIERRA #10;

     |HAZ EsReparacion;
     |ABRE #23;
     #23#0 = aTipo;
     #23#1 = aSer;
     #23#2 = aNum;
     |BORRA 000#23c;
     |CIERRA #23;
|FPRC;

|PROCESO ConfirmaAlba;
     |ABRE #10;
     #10#52 = aSer;
     #10#0 = aNum;
     |LEE 121#10=;
     |SI FSalida = 0;
          aSerSal = #10#52; nNumSal = #10#0;
          |BUCLELIN 2 BuscaPed #10;
          |ABRE #4;
          #4#25 = aSerPed;
          #4#0 = nNumPed;
          |LEE 121#4=;
          |SI FSalida = 0;
               nSw = 2;
               |ABRE #71;
               |BUCLELIN 0 CreaAlbaran #4;
               |CIERRA #71;
               |SI nPrime = 0;
                    |MENAV "0000No se crea albaran, ya esta facturado";
                    |ABRE #16;
                    #16#0 = #10#52;
                    #16#1 = #10#0;
                    #16#2 = #10#52;
                    #16#3 = #10#0;
                    |GRABA 020#16n;
                    |CIERRA #16;
                    |HAZ Etiqueta;
               |SINO;
                    |ABRE #16;
                    #16#0 = #10#52;
                    #16#1 = #10#0;
                    #16#2 = aSerSal;
                    #16#3 = nNumSal;
                    |GRABA 020#16n;
                    |CIERRA #16;
                    |HAZ CreaFactura;
                 || |HAZ ImpAlbaran;
                    |HAZ ImpFactura;

                    aAlfa = #10#52 + "/" + (("000000" + #10#0) % -106);
                    |ABRE #10;
                    #10#52 = aSerSal;
                    #10#0 = nNumSal;
                    |LEE 121#10=;
                    |SI FSalida = 0;
                         #10#55 = aAlfa;
                         |GRABA 020#10a;
                    |FINSI;
                    |CIERRA #10;

                    |HAZ Etiqueta;
               |FINSI;
          |FINSI;
          |CIERRA #4;
     |FINSI;
     |CIERRA #10;
|FPRC;

|PROGRAMA;
     aDoc = PARAMETRO % 101;
     aTipo = PARAMETRO % 201;
     aSer = PARAMETRO % 305;
     aNum = PARAMETRO % 806;
     aRese = PARAMETRO % 1401;
     aFase = PARAMETRO % 1501;

     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     aAlfa = aPath  + "agifa071";
     |CARGA_DEF aAlfa, agifa071@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar 'agifa071'";
     |SINO;
          |ABRE #agifa071@;
          |SI aDoc = "P";     || Llama pcegz001 (Albaran reser.)
               |HAZ AceptaPedido;
          |FINSI;
          |SI aDoc = "F";     || Llama pcegz020
               |HAZ AnulaFactura;
          |FINSI;
          |SI aDoc = "A";
               |SI aTipo = "C";    || Llama pcegz020
                    |HAZ ConfirmaAlba;
               |FINSI;
               |SI aTipo = "B";    || Llama pcegz020
                    |HAZ CancelaAlba;
               |FINSI;
               |SI aTipo = "X";    || Llama agifa210
                    |HAZ BorraAlbaran;
               |FINSI;
          |FINSI;
          |SI aDoc = "X";     || Llama agifa134
               |HAZ BorraFactura;
          |FINSI;

          |CIERRA #agifa071@;
          |DESCARGA_DEF #agifa071@;
     |FINSI;
|FPRO;
