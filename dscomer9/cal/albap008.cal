|FICHEROS;
 albap004 #98; || Cabecera revision psion.
 albap005 #99; || Lineas revision psion.
 agifa071 #0;  || LINEAS DE ALBARAN
 agifa019 #2;  || ARTICULOS
 agifa024 #6;  || CLIENTES
 agifa017 #8;
 agifa065 #9;  || HISTORICO
 agifa038 #11;
 agifa025 #12; || REPRESENTANTES
 agifa048 #13;
 agifa049 #14;
 agifa142 #42; ||PARAMETROS GENERALES
 agifa321 #44;  || Divisas-Parametros.
 agifa324 #45;  || Divisas-Divisas.
 dsm00024 #24;
 dsm00134 #100;
|FIN;

|VARIABLES;
     nLinPromo = 0;
     nLinAlb = 0;
     aPartida = "";
     fFechaPar = @;
     aTipo = "";
     aSer = "";
     nNum = 0;
     nImpPro = 0;
     &enDescuento1 = 0;
     &enDescuento2 = 0;
     &eaTComision  = "";
     &enComision   = 0;

     &efFAlba = @;

 resto = 0;
 neto = 0;
 diferencia = 0;
 sw = 0;
 numero = "";
 vacio = "                    ";
 totalba = 0;
 descu = 0;
 tf = 0;
 pc = 0;
 pc1 = 0;
 imneto = 0;
 asto = 0;
 margen = 0;
 wimneto = 0;
 wmargen = 0;
operacion1 = "AV";
operacion2 = "BV";
operacion = "  ";
a = 0;
modo = 0;
cantidad = 0;
articulo = " ";
fmes = "  ";
mes = 0;
me  = 0;
kl  = 0;
mescli = " ";
mensaje1 = "0000Esta linea proviene de un Pedido (use la opcion adecuada)";
mensaje2 = "0000Esta linea proviene de un Deposito (use la opcion adecuada)";
mensaje3 = "0410 Stock Disponible Almacen :             Stock Minimo : ";
mensaje4 = "0000 Supera el Stock disponible";
mensaje5 = "0000 Albaran para Exportacion. Tipo IVA = 0  !!!";
mensaje12 = "0000Este albaran esta FACTURADO";
totbu = 0;
flag = 0;
primera = 0;
swescan = 0;
alfa1 = "";
     &avisa_st = "S";
     &n_dec = 0;
     &n_pre = 0;
     &ext1 = "";
     sal_campo = 0;
     aviso = "";
     ok = "";
     tbruto = 0;
     &aMoneda = "";
     &aDivisa = "";
|FIN;

|INCLUYE i_varart;

|PROCESO para_ger;
     |ABRE #42;
     #42#0 = "A";
     |LEE 001#42=;
     |SI FSalida ! 0; |DDEFECTO #42; |FINSI;
     |LIBERA #42;
     |CIERRA #42;
|FPRC;

|PROCESO LeeDivisa;
     |ABRE #44;
     |ABRE #45;
     #44#0 = "A";
     |LEE 001#44=;
     |SI FSalida ! 0; |DDEFECTO #44; |FINSI;
     #45#0 = #44#9;
     |LEE 001#45=;
     |SI FSalida ! 0; |DDEFECTO #45; |FINSI;
     |LIBERA #44;
     |LIBERA #45;
     |CIERRA #44;
     |CIERRA #45;
|FPRC;

|CALCULO mirespor;
   |SI #6#28 = AS;|Y #0#11 ! 0;
       #0#11 = 0;
   |FINSI;
|FCAL;

|CALCULO defecli;
     |ABRE #12;
     #12#0 = #98#10;
     |LEE 000#12=;
     |SI FSalida ! 0;
         |GRABA 000#12c;
     |FINSI;
     |LIBERA #12;
     |CIERRA #12;
     #0#16 = #12#7;
     #0#17 = #6#4;

     |ABRE #2;
     #2#0 = #0#2;
     |LEE 000#2=;
     |CIERRA #2;

     #0#13 = #2#2;

     |ABRE #6;
     #6#0 = #0#15;
     |LEE 000#6=;
     |CIERRA #6;
|FCAL;

|CALCULO lisubcom;
    enDescuento1 = #0#8;
    enDescuento2 = #0#33;
    eaTComision  = #0#16;
    eaCliente    = #0#15;
    eaArticulo   = #0#2;
    eaRepre      = #6#25;
    |HAZ Comisiones;
    #0#10 = enComision;
|FCAL;

|PROCESO dsm00024;
     |SI #dsm00024#4 ! "01.01.0000";         ||Fecha 1§ Entrada NO VACIA
          |SI #dsm00024#4 < fFechaPar;
               |SI #dsm00024#31 > #0#5;
                    fFechaPar = #dsm00024#4;
                    aPartida = #dsm00024#2;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsm00024;
 #dsm00024#1;
 ;
 #99#4, #99#11, "                              ";
 #99#4, #99#11, "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
 ;
 NULL, dsm00024;
|FIN;

|PROCESO DamePartida;
     |BUCLE dsm00024;
|FPRC;

|PROCESO UltLin;
     #0#29 = #99#2;      || serie albaran
     #0#0 = #99#1;      || Numero.
     #0#1 = 999;
     |LEE 000#0];
     |SI FSalida = 0;
          |LEE 000#0a;
     |SINO;
          |LEE 000#0u;
     |FINSI;
     |SI FSalida = 0; |Y #0#29 = #99#2; |Y #0#0 = #99#1;
          nLinAlb = #0#1 + 1;
     |SINO;
          nLinAlb = 1;
     |FINSI;
|FPRC;

|PROCESO LineaPromo;
     #98#0 = #99#0;
     #98#2 = #99#2;
     #98#1 = #99#1;
     |LEE 020#98=;

     |DDEFECTO #0;
     #0#29 = #99#2;      || serie albaran
     #0#0 = #99#1;      || Numero.
     #0#1 = nLinAlb;
     |LEE 101#0=;
     |SI FSalida = 0; |ACABA; |FINSI;

     #0#2 = #99#4;       || Cod. Articulo
     |ABRE #2;
     #2#0 = #99#4;
     |LEE 000#2=;
     |CIERRA #2;
     #0#3 = #99#11;      || Almacen.
     #0#4 = #99#5;       || Descripcion
     #0#6 = 0;       || Precio
     #0#7 = 0;      || Importe
     #0#8 = 0;       || Dto
     #0#15 = #98#4;      || cliente

     #0#11 = #99#9;      || Tipo iva
     #0#13 = #2#2;       || familia
     #0#14 = #2#9 * #0#5;       || coste

     #0#5 = #99#12;  ||Uni Promo
     #0#62 = #0#5 * #99#15; ||Punto Verde


     #0#36 = #0#6;
     #0#38 = #0#6;
     #0#39 = #0#9;
     |ABRE #6;
     #6#0 = #98#4;
     |LEE 000#6=;
     |CIERRA #6;
     #0#17 = #6#4;       || tipo cliente

     ||ARA
     |SI #2#180 = "S";        ||Articulo con Partida
          aPartida = "";
          fFechaPar = "31.12.2999";
          |HAZ DamePartida;
          #0#49 = aPartida;
     |FINSI;

     |HAZ defecli;
     |HAZ lisubcom;
     |HAZ mirespor;

     enForma = 1;
     efFAlba = #98#3;
     |HAZ AcumulaAV;
     #0#14 = enCoste;
     #0#63 = -1;
     |GRABA 040#0n
     nLinPromo = #0#1;
|FPRC;

|PROCESO linalb;
     #98#0 = #99#0;
     #98#2 = #99#2;
     #98#1 = #99#1;
     |LEE 020#98=;

     |HAZ UltLin;

     |DDEFECTO #0;
     #0#29 = #99#2;      || serie albaran
     #0#0 = #99#1;      || Numero.
     #0#1 = nLinAlb;       || Linea.
     |LEE 101#0=;
     |SI FSalida = 0; |ACABA; |FINSI;

     #0#2 = #99#4;       || Cod. Articulo
     |ABRE #2;
     #2#0 = #99#4;
     |LEE 000#2=;
     |CIERRA #2;
     #0#3 = #99#11;      || Almacen.
     #0#4 = #99#5;       || Descripcion
     #0#6 = #99#7;       || Precio
     #0#7 = #99#10;      || Importe
     #0#8 = #99#8;       || Dto
     #0#15 = #98#4;      || cliente

     nImpPro = #99#13;  ||| Dice Inma que siempre la de la linea del Psion
     |ABRE #100;
     #100#0 = #0#15;
     #100#1 = #0#2;
     |LEE 000#100=;
     |SI FSalida = 0; |Y #100#5 ! 0;
||          #0#6 = #0#6 * 100 / (100 - #100#5);
          #0#6 = #2#18;       || coje el precio de la tarifa 1 siempre
                              ||/ya que a veces venia con el precio sin
                              ||/la promocion incluida (INMA-PRIEGO 4/8/2006)
          #0#8 = #100#5;
          nImpPro = 0;
     |FINSI;
     |CIERRA #100;

     #0#11 = #99#9;      || Tipo iva
     #0#13 = #2#2;       || familia
     #0#14 = #2#9;       || coste
     #0#5 = #99#14; ||Uni Base
     #0#62 = #99#15 * #0#5; ||Punto Verde
     #0#64 = nImpPro;
     #0#65 = 0;
     #0#66 = #99#12; || Uni Promo

     #0#36 = #0#6;
     #0#38 = #0#6;
     #0#39 = #0#9;
     |ABRE #6;
     #6#0 = #98#4;
     |LEE 000#6=;
     |CIERRA #6;
     #0#17 = #6#4;       || tipo cliente

     ||ARA
     |SI #2#180 = "S";        ||Articulo con Partida
          aPartida = "";
          fFechaPar = "31.12.2999";
          |HAZ DamePartida;
          #0#49 = aPartida;
     |FINSI;

     |HAZ defecli;
     |HAZ lisubcom;
     |HAZ mirespor;

     enForma = 1;
     efFAlba = #98#3;
     |HAZ AcumulaAV;
     #0#14 = enCoste;
     |SI #99#12 ! 0;
          nLinAlb = nLinAlb + 1;
          #0#63 = nLinAlb;
     |FINSI;

     |GRABA 040#0n

     |SI #99#12 ! 0;
          |HAZ LineaPromo;
     |FINSI;
|FPRC;

|DEFBUCLE leelin;
     #99#1;
     ;
     "A","     ",000000, 001;
     "A","zzzzz",999999, 999;
     be;
     NULL,linalb;
|FIN;

|PROGRAMA;
     aMoneda = "B"
     aDivisa = "EUR";
     |HAZ Divisas010;
     |HAZ LeeDivisa;
     |HAZ para_ger;

     |ABRE #0;
     |ABRE #98;
     |BUCLE leelin;
     |CIERRA #98;
     |CIERRA #0;
|FPRO;
