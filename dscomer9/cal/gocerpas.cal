|FICHEROS;
    agifa166 #0;         || Pantalla de pase.
    agifa084 #4;         || Cabec. Facturas Contado.
    agifa069 #5;         || Lineas Facturas Contado.
    agifa024 #7;         || Clientes.
    agifa019 #8;         || Articulos.
    agifa025 #9;         || Comisionistas.
    agifa017 #10;        || Stock de almacenes.
    gopre004 #14;
    agifa321 #35;        || Parametros de Divisas
    agifa328 #36;        || Clientes/Divisas
    agifa329 #37;        || Lineas de Clientes/Divisas
    agifa324 #38;        || Divisas
    agifa007 #40;        || Series
    agifa142 #41;        || Parametros Generales
    goparame #100;       || Parametros Obras.
    gocerlin #101;       || Lineas Certificaciones.
    gocerhis #102,MANTE; || Lineas historico certificaciones.
    gocercab #103;       || Cabec. Certificaciones.
    gomantho #104;
    gopre001 #105;
    gopre002 #106;
    gopartia #125;
    guerm040 #140;
    guerm041 #141;
    guerm042 #142;
|FIN;
-----------------------------------------------------------------------------
|VARIABLES;
     n9 = 0;
     n10 = 0;
     n11 = 0;
     n12 = 0;
     n13 = 0;
     n14 = 0;
     n15 = 0;
     &enN5 = 0;
     &enN6 = 0;
     &enN8 = 0;
     &enN9 = 0;
     &enN10 = 0;
     &enN11 = 0;
     &enAp = 0;
     &enBase = 0;
     &enTope = 0;
     &enBasi = 0;
     &enResu = 0;
     &enRete = 0;
     nTipo = 0;
     nTivaCapi = 0;
     nSwForestales = 0;
     nForesIva = 0;
     nBene = 0;
     aDescri = "";
     aArticulo = "";
     nMiPrecio = 0;
     aFactu = "";
     nTotalPrecio = 0;
     nTotalPrecioE = 0;
     nContaMulti = 0;
     &enSwMenu = 0;
     aCliente = "";
     aNombre = "";
     nSwMulti = 0;
     nPreciox = 0;
     &enErrCarte      = 0;
     &eaProg          = "";
     &aDivisa         = "";
     &aMoneda         = "";
     aAlfa            = "";
     &nDeci_Base      = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase   = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx    = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBaseMx = 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_Div       = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDiv    = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVis    = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVis  = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVis    = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVis    = 0;   || Decimales en el Importe visual. (lineas)
     &nDeci_BaseMxF   = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBasMxF = 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_DivF      = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDivF   = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVisF   = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVisF = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVisF   = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVisF   = 0;   || Decimales en el Importe visual. (lineas)
     &decim_divisa    = 0;   || Decimales de la divisa
     &precio_divisa   = 0;   || Decimales del precio en divisa
     &decim_base      = 0;   || Decimales de la moneda base
     &precio_base     = 0;   || Decimales del precio en moneda base

     nerror           = 0;
     nMargen          = 0;
     nImpo            = 0;
     nDto             = 0;
     asto             = 0;
     contador         = "";
     fmes             = "";
     mes              = 0;
     campo            = 0;
     imneto           = 0;
     retencion        = 0;
     margen           = 0;
     control          = 0;
     nForma           = 0;
     mensaje01        = "0423Actualizando linea:";
     base0            = 0;
     base1            = 0;
     base2            = 0;
     base3            = 0;
     base4            = 0;
     base5            = 0;
     caltot           = 0;
     recalpre         = 0;
     importe          = 0;
     totfa            = 0;
     nLinea           = 0;
     modo             = 0;
     &nError          = 0;
     nConfi           = 0;
     nPrecio          = 0;
     nImpDiv          = 0;
     nMult            = 0;
     nPrecio44 = 0;
     nTotal    = 0;
     nPrecio31 = 0;
     nPrecio32 = 0;
     nPrecio33 = 0;
     nTotalHacer = 0;
     nTotalHacert = 0;
     aSerPres = "";
     nNumPres = 0;
     nLinCer = 0;
     nTotalYACert = 0;
     nTotalYACalc = 0;
     &nDeci_TTrab = 0;
|FIN;
-----------------------------------------------------------------------------
|INCLUYE i_varart;
-----------------------------------------------------------------------------
|PROCESO CalcuLLSS;
     enAp = ((#101#6-#101#29) * #101#26 / 100) ! nDeci_TTrab;
     enTope = ((#101#6-#101#29+enAp)*#101#27/100) ! nDeci_TTrab;
     enBasi = (100*#101#28/(#101#6-#101#29+(#101#6*#101#26/100))) nDeci_TTrab;
     |SI #101#28 < enTope; |O enBasi < #101#27;
          enResu = 0;
     |SINO;
          enResu = #101#28 - enTope;
     |FINSI;
     enRete = ((#101#6 - #101#29 - enResu) * 5 / 100) ! nDeci_TTrab;
     enBase = #101#6 + enAp - #101#29 - enResu;
     enBase = enBase - enRete;

     || para el informe gocerli3
     enTiva = #101#13;
     |SI #101#23 = "01.01.0000";
          efFiva = #101#3;
     |SINO;
          efFiva = #101#23;
     |FINSI;
     |HAZ SacaIVA;
     n9 = #101#6 - #101#29 - enResu;
     n10 = n9 + enAp;
     n11 = (-(n9 * 5 / 100)) ! nDeci_TTrab;
     n12 = n10 + n11;
     n13 = (enIva * n12 / 100) ! nDeci_TTrab;
     n14 = n12 + n13;
     n15 = n14 - n11;

     enN5 = n9;
     enN6 = n10;
     enN8 = n12;
     enN9 = n13;
     enN10 = n14;
     enN11 = n15;
|FPRC;

|PROCESO graba_cabfac;
     |DDEFECTO #105;
     |ABRE #105;
     #105#0 = #101#0;
     #105#1 = #101#1;
     |LEE 020#105=;
     |CIERRA #105;

     |DDEFECTO #4;
     |HAZ LeeDivisas0;         ||Proceso de DIVISAS
     aDivisa = #103#6;         ||#agifa084#65;
     aMoneda = #agifa084#67;
     |HAZ Divisas084;

     |SI nContaMulti = 0;
          #4#0  = #101#5;          ||Num Factura.
     |SINO;
          #4#0 = nContaMulti;
     |FINSI;
     #4#48 = #101#4;          ||Serie.
     #4#1  = #101#23;          ||Fecha.
     #4#2  = 1;               ||Total Bultos.
     #4#3  = aCliente;         ||Cod. Cliente.
     #4#4  = aNombre;         ||Nombre.

     #7#0  = #4#3;            ||Cliente
     |LEE 040#7=;
     |SI FSalida ! 0;
          |DDEFECTO #7;       ||Pongo todos los defectos de los campos
     |FINSI;

     |SI #goparame#100 = "S";
          nBene = #gocerlin#26;
     |SINO;
          nBene = #105#27;
     |FINSI;
     |SI #105#26 = 0; |Y nBene = 0; |Y #105#28 = 0;
          |SI #105#43 = 0;
               #4#5  = #7#37;           ||Dto. Especial.
          |SINO;
               #4#5 = #105#43;          ||%Dto
          |FINSI;
     |SINO;
          #4#5 = 0;
     |FINSI;

     ||TODO CCC
     #4#6  = #101#16;           ||Representante.
     #4#7  = #7#38;           ||Dto. PP.
     #4#8  = #101#24;           ||F.Pago.
     #4#10 = "N";             ||Impreso (S/N).
     #4#11 = 0;               ||Portes
     #4#12 = 0;               ||Tipo IVA portes
     #4#13 = 0;               ||Varios
     #4#14 = 0;               ||Tipo IVA Varios

     #4#26 = 0;               ||Total comision
     #4#29 = #7#1;            ||Entregar a
     #4#30 = #7#5;            ||Direccion entrega
     #4#31 = #7#6;            ||Poblacion entrega
     #4#32 = #7#156;          ||Dto. Acumulado
     #4#33 = #7#7;            ||Provincia entrega
     #9#0  = #7#25;           ||Representante
     |LEE 010#9=;

     |SI FSalida = 0;
          #4#34 = #9#7;       ||Tipo de comision
     |FINSI;

     #4#35 = #7#4;            ||Tipo de cliente
     #4#36 = #7#47;           ||Regimen equivalencia
     #4#37 = 0;               ||Margen factura c.
     #4#38 = 0;               ||Entrega a cuenta
     #4#39 = "N";             ||Contabilizada
     #4#40 = #7#16;           ||N.Contable
     #4#60 = #7#15;           ||CIF
     #4#61 = "N";             ||Exportado
     #4#62 = "00.00.0000"     ||Fecha exportacion
     #4#63 = 0;               ||A cuenta
     #4#64 = #7#183;          ||Cod.Postal
     #4#65 = #103#6;          ||Divisa
     #4#76 = 0;               ||Portes (tra)
     #4#77 = 0;               ||Varios (tra)
     #4#78 = #7#202;          ||Cod.Agencia Transp.

     |ABRE #104;
     #104#0 = #103#4;
     #104#1 = #103#5;
     |LEE 000#104=;
     |CIERRA #104;

     aAlfa = #103#4 + "/" + #103#5;
     #4#9 =  #105#8;
     #4#87 = aAlfa;
     |GRABA 020#4n;
     |LIBERA #4;
|FPRC;
-----------------------------------------------------------------------------
|PROCESO Actualizacion;
     |SI #5#9 > 0;
          nerror = 1;
     |SINO;
          nerror = -1;
          #5#9 = -#5#9;
     |FINSI;

     imneto = ((((#5#9 < #4#5) < #4#32) < #4#7)) * nerror;
     #5#9   = #5#9 * nerror;
     ||-------------------Actualiza Historico, Articulo y Almacen
     eaArti  = #5#2;
     eaSer   = #5#20;
     efFec   = #4#1;
     eaEsAbo = "N";
     enDocu  = #5#0;
     enLin   = #5#1;
     enAlma  = #5#3;
     enUnid  = #5#5;
     enPrec  = #5#6;
     eaCli   = #4#3;
     enDTO1  = #5#8;
     enDTO2  = #5#21;
     enDTOEs = #4#5;
     enDTOAc = #4#32;
     enDTOPp = #4#7;
     |HAZ AcumulaFC;

     ||------------------------------Importe Articulo
     fmes = #4#1 % A402;
     mes = fmes - 1;
     mes = mes * 5;
     mes = mes + 35;
     #8#0 = #5#2;
     |LEE 101#8=;

     |SI FSalida = 0;
          nImpo = ((((#5#5 * #5#6) < #5#8) < #5#21) < #4#5) < #4#32;

          |SI #41#115 = "S";
               nImpo = nImpo < #4#7;
          |FINSI;

          nMargen = nImpo - #5#14;
          #8mes = #8mes + (nImpo * enForma);
          #8#95 = #8#95 + (nImpo * enForma);
          mes = mes + 1;
          #8mes = #8mes + (nMargen * enForma);
          #8#96 = #8#96 + (nMargen * enForma);
          |GRABA 020#8a;
          |LIBERA #8;

          efFecha = #4#1;
          eaArticulo = #5#2;
          enImpVta = nImpo;
          enImpMar = nMargen;
          |HAZ AcumulaArt;
     |FINSI;
|FPRC;
-----------------------------------------------------------------------------
|PROCESO graba_linfac;
     |SI #100#139 = "S";
          enTiva = nTivaCapi;
          nLinea = nLinea + 1;
     |SINO;
          enTiva = #101#13;    ||IVA
          nLinea = 1;
     |FINSI;

     |SI nSwForestales = 0; |Y #103#15 = "A";
          nLinea = nForesIva + 1;
          enTiva = nForesIva;
     |FINSI;

     efFiva = #4#1;
     |HAZ SacaIVA;

     |DDEFECTO #8;
     #8#0 = "CERTIFICACION";
     |LEE 101#8=;
     |SI FSalida ! 0; |GRABA 020#8b; |FINSI;
     |LIBERA #8;

     |DDEFECTO #5;
     #5#20 = #4#48;                              ||Serie
     #5#0  = #4#0;                              ||N.factura contado
     #5#1  = nLinea;                              ||Linea

     #5#2 = #8#0;
     aAlfa = #101#10; |QBF aAlfa;
     |SI aAlfa = ""; aAlfa = "Certificacion N§:" + (("000" + #101#2)%-103); |FINSI;
     #5#4 = aAlfa;
     #5#5 = 1;

     #5#3 = #103#16;                         ||Numero almacen

     #5#6 = nMiPrecio;
     #5#26 = nMiPrecio;

     #5#11 = enTiva;                               ||Tipo IVA

     #8#0 = aArticulo;
     |LEE 000#8=;
     |SI FSalida = 0;
          #5#13 = #8#2;                           ||Familia
     |FINSI;

     #5#15 = #7#0;                                ||Cliente
     #5#16 = #4#34;                               ||Tipo de comision
     #5#17 = #4#35;                               ||Tipo de cliente

     |HAZ TotalLin69;
     |GRABA 020#5n;
     enForma = 1;
     |HAZ Actualizacion;

     |LIBERA #5;
|FPRC;

|PROCESO BrutoACert;
     |SI #gocerlin#2 ! nLinCer;
          nTotalYACert = nTotalYACert + #gocerlin#6;
     |FINSI;
     nTotalHacert = nTotalHacert + #gocerlin#6;
|FPRC;

|DEFBUCLE BrutoACert;
     #gocerlin#1;
     ;
     aSerPres, nNumPres, 1;
     aSerPres, nNumPres, nLinCer;
     ;
     NULL, BrutoACert;
|FIN;

|PROCESO BuscaProdu1;
     nPreciox = #14#12;
     |ERROR10;
|FPRC;

|DEFBUCLE BuscaProdu1;
     #14#3;
     ; ||Se/Pres       Part,                 Arti
     #125#0, #125#1, "                    ", #125#20 ;
     #125#0, #125#1, "zzzzzzzzzzzzzzzzzzzz", #125#20;
     ;
     NULL, BuscaProdu1;
|FIN;

|PROCESO LinCerti;
     |SI #103#15 = "A";
          aArticulo = #102#16;                          ||Codigo articulo, para buscar Familia
     |SINO;
          aArticulo = #102#4;
     |FINSI;

     |DDEFECTO #106;
     |ABRE #106;
     |SELECT #6#106;
     #106#0 = #102#0;                                 ||Serie Pres.
     #106#1 = #102#1;                                 ||N.Presupuesto
     #106#12 = #102#14;
     |LEE 000#106=;
     |CIERRA #106;

     |SI nSwForestales = 0; |Y #103#15 = "A";
          |DDEFECTO #8;
          #8#0 = #102#16;
          |LEE 000#8=;
          |SI nForesIva ! #8#30; |ACABA; |FINSI;
     |SINO;
          || *** LA ESTANDAR ***
          |SI #100#139 = "S";
               nTipo = nTivaCapi;
               |SI #106#15 = "S"; nTipo = 0; |FINSI;
               |SI #106#17 ! nTipo; |ACABA; |FINSI;
          |FINSI;
     |FINSI;

     nPrecio = #5#6; || antes era = #5#9
                     || Wed Oct  6 18:24:38 CEST 2004
                     || PRES/771 facturar linea 8 para probar

     |SI #103#15 = "A";
          #5#5 = #102#18;                         ||Cantidad Adm.

          |DDEFECTO #125;
          #125#34 = #102#23;
          #125#4 = #102#24;
          #125#5 = #102#25;
          #125#6 = #102#26;
          #125#7 = #102#27;
          |LEE 000#125=;
/*  (**)
          |SI #goparame#100 = "S";
               nPreciox = #125#12;
          |SINO;
               nPreciox = #125#11;
          |FINSI;
          |SI #100#70 = "A"; |Y #100#100 = "S"; |Y #125#34 = "T";
               || Tiquet 2805/1765
               nPreciox = #125#11;
          |FINSI;
*/
          || Segun  Subtiquet nro. 02644.0011 Cliente: 002805
          || coge el precio en la administrativa siempre el de la
          || linea de la certificacion  (**)
          nPreciox = #102#8;

          |SI #100#70 = "A";
/*  (**)
               |SI nPreciox = 0;
                    |DDEFECTO #8;
                    |ABRE #8;
                    #8#0 = #125#20;
                    |LEE 000#8=;
                    |CIERRA #8;
                    nPreciox = #8#18; ||PVP1
                    |SI nPreciox = 0;
                         nPreciox = #125#12;
                    |FINSI;
               |FINSI;
*/
          |SINO;
               |BUCLE BuscaProdu1;
          |FINSI;

     |SINO;
          #5#5  = #102#7;                         ||Cantidad Certificada.
          nPreciox = #102#8;
     |FINSI;

     |SI #4#67 = "D";
          #5#6 = nPreciox/ #4#66 * #4#69;          ||Precio en DIVISAS
          #5#7 = ((#5#6*#5#5) / #4#66 * #4#69);   ||Importe
          #5#9 = #5#7;                            ||Importe Total
     |SINO;
          #5#6 = nPreciox;                         ||Precio en PTAS.
          #5#7 = #5#6*#5#5;                       ||Importe
          #5#9 = #5#7;                            ||Importe Total
     |FINSI;

     nPrecio = nPrecio + #5#9;
     #5#5 = 1;

     |SI #goparame#100 = "S";
          nBene = #gocerlin#26;
     |SINO;
          nBene = #105#27;
     |FINSI;
     |SI #101#15 ! 0;
          nPrecio = #101#15;
          #5#6 = nPrecio;
     |SINO;
          |SI #105#26 = 0; |Y nBene = 0; |Y #105#28 = 0;
               |SI #101#15 ! 0; nPrecio = #101#15; |FINSI;
               #5#6 = nPrecio;
          |SINO;
               nPrecio = nTotalHacer;
               nPrecio44 = 0;
               nTotal    = 0;
               nPrecio31 = 0;
               nPrecio32 = 0;
               nPrecio33 = 0;

               nPrecio44 = (nPrecio % #105#43) ! 2;
               nTotal = nPrecio - nPrecio44;
               nPrecio31 = (nTotal % #105#26) ! 2;
               nPrecio32 = (nTotal % nBene) ! 2;
               nTotal = nTotal + nPrecio31 + nPrecio32;
               nPrecio33 = (nTotal % #105#28) ! 2;
               nTotal = nTotal - nPrecio33;
               #5#6 = nTotal;
          |FINSI;
     |FINSI;
     nMiPrecio = #5#6;
|FPRC;

|PROCESO NULO;
     |DDEFECTO #5;
     nMiPrecio = 0;
|FPRC;

|DEFBUCLE LinCerti;
     #102#1;
     ;
     #101#0,#101#1,#101#2,  1;
     #101#0,#101#1,#101#2,999;
     ;
     NULO, LinCerti;
|FIN;

|PROCESO LinCerti2;
     |DDEFECTO #106;
     |ABRE #106;
     |SELECT #6#106;
     #106#0 = #102#0;                                 ||Serie Pres.
     #106#1 = #102#1;                                 ||N.Presupuesto
     #106#12 = #102#14;
     |LEE 000#106=;
     |CIERRA #106;

     |SI nSwForestales = 0; |Y #103#15 = "A";
          |DDEFECTO #8;
          #8#0 = #102#16;
          |LEE 000#8=;
          |SI nForesIva ! #8#30; |ACABA; |FINSI;
     |SINO;
          || *** LA ESTANDAR ***
          |SI #100#139 = "S";
               nTipo = nTivaCapi;
               |SI #106#15 = "S"; nTipo = 0; |FINSI;
               |SI #106#17 ! nTipo; |ACABA; |FINSI;
          |FINSI;
     |FINSI;

     |SI #103#15 = "A";
          #5#5 = #102#18;                         ||Cantidad Adm.

          |DDEFECTO #125;
          #125#34 = #102#23;
          #125#4 = #102#24;
          #125#5 = #102#25;
          #125#6 = #102#26;
          #125#7 = #102#27;
          |LEE 000#125=;
          |SI #goparame#100 = "S";
               nPreciox = #125#12;
          |SINO;
               nPreciox = #125#11;
          |FINSI;
          |SI #100#70 = "A"; |Y #100#100 = "S"; |Y #125#34 = "T";
               || Tiquet 2805/1765
               nPreciox = #125#11;
          |FINSI;

          |SI #100#70 = "A";
               |SI nPreciox = 0;
                    |DDEFECTO #8;
                    |ABRE #8;
                    #8#0 = #125#20;
                    |LEE 000#8=;
                    |CIERRA #8;
                    nPreciox = #8#18; ||PVP1
                    |SI nPreciox = 0;
                         nPreciox = #125#12;
                    |FINSI;
               |FINSI;
          |SINO;
               |BUCLE BuscaProdu1;
          |FINSI;
     |SINO;
          nTotalHacer = nTotalHacer + #102#10;
            ||ahora cojo el importe total de la certificacion
            ||para evitar descuadres ver tiquet 002743/03056 15/6/2012
          |ACABA;

          #5#5  = #102#7;                         ||Cantidad Certificada.
          nPreciox = #102#8;
     |FINSI;

     |SI #4#67 = "D";
          #5#6 = nPreciox / #4#66 * #4#69;          ||Precio en DIVISAS
          #5#7 = ((#5#6*#5#5) / #4#66 * #4#69);   ||Importe
          #5#9 = #5#7;                            ||Importe Total
     |SINO;
          #5#6 = nPreciox;                          ||Precio en PTAS.
          #5#7 = #5#6*#5#5;                       ||Importe
          #5#9 = #5#7;                            ||Importe Total
     |FINSI;

     nTotalHacer = nTotalHacer + #5#9;
|FPRC;

|DEFBUCLE LinCerti2;
     #102#1;
     ;
     #101#0,#101#1,#101#2,  1;
     #101#0,#101#1,#101#2,999;
     ;
     NULO, LinCerti2;
|FIN;

|PROCESO ActuaCabecera;
     |HAZ CalCabAgifa084;
|FPRC;

-----------------------------------------------------------------------------
|PROCESO Factura;
     |DDEFECTO #40;
     #40#26= #101#4;          ||Serie factura, para buscar el Almacen
     |LEE 000#40=;

     nLinea = 0;
     |HAZ graba_cabfac;

     aDescri = "Certificacion N§:" + (("000" + #101#2)%-103);
     nTotalHacer = 0;

     |SI #goparame#100 = "S";
          nBene = #gocerlin#26;
     |SINO;
          nBene = #105#27;
     |FINSI;

     |HAZ EsForestales
     nSwForestales = FSalida;
     |SI FSalida = 0; |Y #103#15 = "A";
          |HAZ FactuForesta;
     |SINO;
          || *** LA ESTANDAR ***
          |SI #100#143 = "N";
               |ABRE #125;
               |SI #105#26 = 0; |Y nBene = 0; |Y #105#28 = 0;
                    |PARA nTivaCapi = 0; |SI nTivaCapi [ 5; |HACIENDO nTivaCapi = nTivaCapi + 1;
                         |BUCLE LinCerti;
                         |HAZ BrutoACert;
                         |SI nMiPrecio ! 0; |HAZ graba_linfac; |FINSI;
                         |SI #100#139 = "N"; |SAL; |FINSI;
                    |SIGUE;
               |SINO;
                    |PARA nTivaCapi = 0; |SI nTivaCapi [ 5; |HACIENDO nTivaCapi = nTivaCapi + 1;
                         nTotalHacer = 0;
                         |BUCLE LinCerti2;
                         |SI #101#15 ! 0; nTotalHacer = #101#15; |FINSI;
                         |BUCLE LinCerti;
                         |HAZ BrutoACert;
                         |SI nMiPrecio ! 0; |HAZ graba_linfac; |FINSI;
                         |SI #100#139 = "N"; |SAL; |FINSI;
                    |SIGUE;
               |FINSI;
               |CIERRA #125;
          |SINO;
               |HAZ CalcuLLSS;
               nMiPrecio = enBase;
               |HAZ graba_linfac;
          |FINSI;
     |FINSI;
     #4#0  = #101#5;          ||Numero Factura.
     #4#48 = #101#4;          ||Serie.
     |LEE 101#4=;
     |SI FSalida = 0;
         |HAZ LimCabAgifa084;
         |BUCLELIN 2 ActuaCabecera #4;
         |GRABA 020#4a;
         |LIBERA #4;
     |FINSI;
     |HAZ actua_cliente;
|FPRC;
-----------------------------------------------------------------------------
|PROCESO LineaMulti;
/* (3832/206)
     |SI nTotalPrecio ! 0;
          nMiPrecio = nTotalPrecio % #141#5;
          aDescri = #140#3;
          |HAZ graba_linfac;
     |FINSI;
*/
     |SI #100#143 = "N";
          |ABRE #125;
          |SI #105#26 = 0; |Y nBene = 0; |Y #105#28 = 0;
               |PARA nTivaCapi = 0; |SI nTivaCapi [ 5; |HACIENDO nTivaCapi = nTivaCapi + 1;
                    |BUCLE LinCerti;
                    |HAZ BrutoACert;
                    |SI nMiPrecio ! 0;
                         nMiPrecio = nMiPrecio % #141#5;
                         |HAZ graba_linfac;
                    |FINSI;
                    |SI #100#139 = "N"; |SAL; |FINSI;
               |SIGUE;
          |SINO;
               |PARA nTivaCapi = 0; |SI nTivaCapi [ 5; |HACIENDO nTivaCapi = nTivaCapi + 1;
                    nTotalHacer = 0;
                    |BUCLE LinCerti2;
                    |SI #101#15 ! 0; nTotalHacer = #101#15; |FINSI;
                    |BUCLE LinCerti;
                    |HAZ BrutoACert;
                    |SI nMiPrecio ! 0;
                         nMiPrecio = nMiPrecio % #141#5;
                         |HAZ graba_linfac;
                    |FINSI;
                    |SI #100#139 = "N"; |SAL; |FINSI;
               |SIGUE;
          |FINSI;
          |CIERRA #125;
     |SINO;
          |HAZ CalcuLLSS;
          nMiPrecio = enBase % #141#5;
          |HAZ graba_linfac;
     |FINSI;
|FPRC;

|PROCESO MultiFactu;
     |DDEFECTO #40;
     #40#26= #101#4;          ||Serie factura, para buscar el Almacen
     |LEE 000#40=;

     |SI nContaMulti = 0;
          nContaMulti = #101#5;
     |SINO;
          enSwMenu = 1;
          #4#48 = #101#4;
          |HAZ ContaFD7;
          nContaMulti = #4#0;
     |FINSI;

     aCliente = #141#3;
     aNombre = #141#4;
     |HAZ graba_cabfac;
     |HAZ LineaMulti;
     |LEE 101#4=;
     |SI FSalida = 0;
          |HAZ LimCabAgifa084;
          |BUCLELIN 2 ActuaCabecera #4;
          |GRABA 020#4a;
          |LIBERA #4;
     |FINSI;

     |HAZ actua_cliente;
     |SI #41#47 = "S";
          |HAZ VenciDir;
     |FINSI;

     #142#0 = #101#0;
     #142#1 = #101#1;
     #142#2 = #101#2;
     #142#3 = #4#48;
     #142#4 = #4#0;
     |GRABA 020#142n;
|FPRC;

|PROCESO PrecioMulti;
     |SI #goparame#100 = "S";
          nBene = #gocerlin#26;
     |SINO;
          nBene = #105#27;
     |FINSI;
     |ABRE #125;
     nTotalHacer = 0;
     |SI #105#26 = 0; |Y nBene = 0; |Y #105#28 = 0;
          |BUCLE LinCerti;
          |HAZ BrutoACert;
          nTotalPrecio = nMiPrecio;
     |SINO;
          nTotalHacer = 0;
          |BUCLE LinCerti2;
          |SI #101#15 ! 0; nTotalHacer = #101#15; |FINSI;
          |BUCLE LinCerti;
          |HAZ BrutoACert;
          nTotalPrecio = nMiPrecio;
     |FINSI;
     |CIERRA #125;
|FPRC;

|PROCESO AltaFact;
     |ABRE #41; |LEE 000#41p; |CIERRA #41;
     |ABRE #100; |LEE 000#100p; |CIERRA #100;

     |ABRE #4;
     |ABRE #5;
     |ABRE #7;
     |ABRET #8;
     |ABRE #9;
     |ABRE #10;
     |ABRE #40;
     |ABRE #142;
     aCliente = #101#11;
     aNombre = #101#12
     nContaMulti = 0;

     |ABRE #140;
     #140#0 = #103#4;
     #140#1 = #103#5;
     |LEE 000#140=;
     |SI FSalida = 0;
          /* (3832/206)
          |HAZ PrecioMulti;
          */
          |BUCLELIN 2 MultiFactu #140;
     |SINO;
          |HAZ Factura;
          |SI #41#47 = "S";
               |HAZ VenciDir;
          |FINSI;
     |FINSI;
     |CIERRA #140;
     |CIERRA #142;
     |CIERRA #4;
     |CIERRA #5;
     |CIERRA #7;
     |CIERRAT #8;
     |CIERRA #9;
     |CIERRA #10;
     |CIERRA #40;
|FPRC;
-----------------------------------------------------------------------------
--------------------------- PROCESOS DE ACTUALIZACION -----------------------
-----------------------------------------------------------------------------
|PROCESO Act_Arti;
     fmes = #4#1 % A402;
     mes = fmes - 1;
     mes = mes * 5;
     mes = mes + 35;
     #8#0 = #5#2;
     |LEE 101#8=;

     |SI FSalida = 0;

          |SI #8#194 = 2;
               nImpo = ((((#5#30 * #5#6) < #5#8) < #5#21) < #4#5) < #4#32;
          |SINO;
               nImpo = ((((#5#5 * #5#6) < #5#8) < #5#21) < #4#5) < #4#32;
          |FINSI;

          |SI #41#115 = "S";
               nImpo = nImpo < #4#7;
          |FINSI;

          nMargen = nImpo - #5#14;
          #8mes = #8mes + (nImpo * nForma);
          #8#95 = #8#95 + (nImpo * nForma);
          mes = mes + 1;
          #8mes = #8mes + (nMargen * nForma);
          #8#96 = #8#96 + (nMargen * nForma);
          |GRABA 020#8a;
          |LIBERA #8;

          efFecha = #4#1;
          eaArticulo = #5#2;
          enImpVta = (nImpo * nForma);
          enImpMar = (nMargen * nForma);
          |HAZ AcumulaArt;
     |FINSI;
|FPRC;
-----------------------------------------------------------------------------
|PROCESO actua_cliente;
     nForma = 0;
     |DDEFECTO #7;
     #7#0 = #4#3;
     |LEE 121#7=;

     |SI FSalida = 0;
          fmes = #4#1 % A402;
          mes = fmes - 1;
          mes = mes * 4;
          mes = mes + 54;
          imneto = #4#15 - #4#25;

          |SI #41#115 = "N";
               nImpo = (imneto * 100) / (100 - #4#7);
               nDto = #4#25 + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
               nDto = #4#25;
          |FINSI;
          #7mes = #7mes + nImpo;
          mes = mes + 1;
          #7mes = #7mes + nDto;
          mes = mes + 1;
          #7mes = #7mes + #4#37;
          #7#102 = #7#102 + nImpo;
          #7#103 = #7#103 + nDto;
          #7#104 = #7#104 + #4#37;
          mes = FEntrada / 100;
          mes = mes ! 0;
          |SI 1 = mes;
               #7#45 = #4#1;
               #7#46 = imneto;
          |FINSI;
          #7#110 = #7#110 + imneto;
          imneto = imneto + #4#24;
          |GRABA 020#7a;
          |LIBERA #7;

          enImpCliCom = nImpo;
          enImpCliDto = nDto;
          enImpCliFac = imneto;
          enImpCliMar = #4#37;
          eaCliente = #4#3;
          efFecha = #4#1;
          |HAZ AcumulaCli;
     |FINSI;

     |DDEFECTO #9;
     #9#0 = #4#6;
     |LEE 121#9=;

     |SI FSalida = 0;
          imneto = #4#15 - #4#25;
          fmes = #4#1 % A402;
          mes = fmes - 1;
          mes = mes * 2;
          mes = mes + 11;
          #9mes = #9mes + #4#26;
          retencion = #9mes % #9#39;
          mes = mes + 1;
          #9mes = #9mes + imneto;
          #9#35 = #9#35 + #4#26;
          #9#36 = #9#36 + imneto;
          mes = fmes - 1;
          mes = mes + 40;
          #9mes = retencion;
          retencion = #9#35 % #9#39;
          #9#52 = retencion;
          |GRABA 020#9a;
          |LIBERA #9;

          enImpRepComi = #4#26;
          enImpRepVta = imneto;
          enImpRepRete = retencion;
          eaRepre = #4#6;
          efFecha = #4#1;
          |HAZ AcumulaRep;
     |FINSI;

     |BUCLELIN 2 Act_Arti #4;
|FPRC;
-----------------------------------------------------------------------------
|PROCESO lee_param;
     |ABRE #41;
     #41#0 = "A";
     |LEE 001#41=;

     |SI FSalida ! 0;
          |DDEFECTO #41;
     |FINSI;

     |CIERRA #41;
|FPRC;

|PROCESO LeeDivisas0;
     |ABRE #35;
     #35#0 = "A";
     |LEE 000#35=;
     |ABRE #38;
     #38#0 = #103#6;
     |LEE 010#38=;

     |SI FSalida = 0;
          #4#66 = #38#2;

          |SI #103#6 = #35#9;
               #4#67 = "B";
          |SINO;
               #4#67 = "D";
          |FINSI;
     |FINSI;

     #4#68 = #35#9;
     #38#0 = #35#9;
     |LEE 010#38=;

     |SI FSalida = 0;
          #4#69 = #38#2;
     |FINSI;

     |CIERRA #38;
     |CIERRA #35;
|FPRC;
-----------------------------------------------------------------------------
|PROCESO guerm042Pru;
     nSwMulti = 1;
     aFactu = ("000000" + #142#4) % -106;
     aFactu = " [" + #142#3 + "/" + aFactu + "] ";
     |ABRE #4;
     #4#48 = #142#3;
     #4#0  = #142#4;
     |LEE 000#4=;
     |SI FSalida = 0;
          |SI #4#39 = "S";
               aAlfa = "0000NFactura:"+aFactu+"contabilizada: Desea continuar";
               |CONFI aAlfa;
               |SI FSalida ! 0;
                    nError = 1;
                    #101#7 = "S";
                    |ERROR10; |ACABA;
               |FINSI;
          |FINSI;
          |SI #41#47 = "S"; |Y #4#10 = "S";
               aAlfa = "0000NDesea dejar la factura:"+aFactu+"como NO impresa y anular los recibos";
               |CONFI aAlfa;
               |SI FSalida ! 0;
                    nError = 1;
                    #101#7 = "S";
                    |ERROR10; |ACABA;
               |FINSI;
               eaProg = "agifa084";
               |HAZ MiraRecVenta;
               |SI enErrCarte ! 0;
                    aAlfa = "0000Recibos:"+aFactu+"con movimientos: NO SE DARA DE BAJA";
                    |MENAV aAlfa;
                    nError = 1;
                    #101#7 = "S";
                    |ERROR10; |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #4;
|FPRC;

|PROCESO BorraLinFac;
     enForma = -1;
     |HAZ Actualizacion;
     |BORRA 020#5a;
|FPRC;

|PROCESO guerm042Bor;
     |ABRE #9;
     |ABRET #8;
     |ABRE #7;
     |ABRE #4;
     #4#48 = #142#3;
     #4#0  = #142#4;
     |LEE 101#4=;
     |SI FSalida = 0;
          |SI #41#47 = "S"; |Y #4#10 = "S";
               eaProg = "agifa084";
               |HAZ BorraRecVenta;
          |FINSI;
          |HAZ BorraVenciDir;
          |HAZ actua_cliente_B;
          |BUCLELIN 0 BorraLinFac #4;
          |BORRA 020#4a;
     |FINSI;
     |CIERRA #9;
     |CIERRA #7;
     |CIERRAT #8;
     |CIERRA #4;

     |BORRA 020#142a;
|FPRC;

|DEFBUCLE guerm042Pru;
     #142#1;
     ;
     #101#0, #101#1, #101#2, "     ", 000001;
     #101#0, #101#1, #101#2, "zzzzz", 999999;
     ;
     NULL, guerm042Pru;
|FIN;

|DEFBUCLE guerm042Bor;
     #142#1;
     ;
     #101#0, #101#1, #101#2, "     ", 000001;
     #101#0, #101#1, #101#2, "zzzzz", 999999;
     be;
     NULL, guerm042Bor;
|FIN;

|PROCESO BorraFact0;
     |ABRE #9;
     |ABRET #8;
     |ABRE #7;
     |ABRE #4;
     #4#48 = #101#4;
     #4#0  = #101#5;
     |LEE 000#4=;
     |SI FSalida = 0;
          |SI #4#39 = "S";
               |CONFI "0000NFactura contabilizada: Desea continuar";
               |SI FSalida ! 0;
                    nError = 1;
                    #101#7 = "S";
                    |ACABA;
               |FINSI;
          |FINSI;
          |SI #41#47 = "S"; |Y #4#10 = "S";
               |CONFI "0000NDesea dejar la factura como NO impresa y anular los recibos";
               |SI FSalida ! 0;
                    nError = 1;
                    #101#7 = "S";
                    |ACABA;
               |FINSI;
               eaProg = "agifa084"; |PULSATECLA;
               |HAZ MiraRecVenta;
               |SI enErrCarte ! 0;
                    |MENAV "0000Recibos con movimientos: NO SE DARA DE BAJA";
                    nError = 1;
                    #101#7 = "S";
                    |ACABA;
               |FINSI;
               eaProg = "agifa084";
               |HAZ BorraRecVenta;
          |FINSI;
          |HAZ BorraVenciDir;
          |HAZ actua_cliente_B;
          |BUCLELIN 0 BorraLinFac #4;
          |BORRA 020#4a;
     |FINSI;
     |CIERRA #9;
     |CIERRA #7;
     |CIERRAT #8;
     |CIERRA #4;
|FPRC;

|PROCESO BorraFact;
     nSwMulti = 0;
     nError = 0;
     |BUCLE guerm042Pru;   || Si no hay registros borramos como
     |SI nSwMulti = 0;
          |HAZ BorraFact0; || antes, modificado Thu Sep  9 11:56:32 CEST 2004
     |SINO;
          |SI nError = 0;
               |BUCLE guerm042Bor;
          |FINSI;
     |FINSI;
|FPRC;

-----------------------------------------------------------------------------
|PROCESO actua_cliente_B;
     nForma = -1;
     |DDEFECTO #7;
     #7#0 = #4#3;
     |LEE 121#7=;

     |SI FSalida = 0;
          fmes = #4#1 % A402;
          mes = fmes - 1;
          mes = mes * 4;
          mes = mes + 54;
          imneto = #4#15 - #4#25;

          |SI #41#115 = "N";
               nImpo = (imneto * 100) / (100 - #4#7);
               nDto = #4#25 + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
               nDto = #4#25;
          |FINSI;

          #7mes = #7mes - nImpo;   ||imneto
          mes = mes + 1;
          #7mes = #7mes - nDto;    ||#4#25
          mes = mes + 1;
          #7mes = #7mes - #4#37;
          #7#102 = #7#102 - nImpo; ||imneto
          #7#103 = #7#103 - nDto;
          #7#104 = #7#104 - #4#37;
          mes = FEntrada / 100;
          mes = mes ! 0;

          |SI 1 = mes;
               #7#45 = #4#1;
               #7#46 = imneto;
          |FINSI;

          #7#110 = #7#110 - imneto;
          imneto = imneto + #4#24;
          |GRABA 020#7a;
          |LIBERA #7;

          enImpCliCom = -nImpo;
          enImpCliDto = -nDto;
          enImpCliFac = -imneto;
          enImpCliMar = -#4#37;
          eaCliente = #4#3;
          efFecha = #4#1;
          |HAZ AcumulaCli;
     |FINSI;

     |DDEFECTO #9;
     #9#0 = #4#6;
     |LEE 121#9=;

     |SI FSalida = 0;
          imneto = #4#15 - #4#25;
          fmes = #4#1 % A402;
          mes = fmes - 1;
          mes = mes * 2;
          mes = mes + 11;
          #9mes = #9mes - #4#26;
          retencion = #9mes % #9#39;
          mes = mes + 1;
          #9mes = #9mes - imneto;
          #9#35 = #9#35 - #4#26;
          #9#36 = #9#36 - imneto;
          mes = fmes - 1;
          mes = mes + 40;
          #9mes = retencion;
          retencion = #9#35 % #9#39;
          #9#52 = retencion;
          |GRABA 020#9a;
          |LIBERA #9;
     |FINSI;

     |BUCLELIN 2 Act_Arti #4;
|FPRC;

//---------------------------//

|PROCESO FactuForesta;
     |ABRE #8;
     |ABRE #125;
     |SI #105#26 = 0; |Y nBene = 0; |Y #105#28 = 0;
          |PARA nForesIva = 0; |SI nForesIva [ 6; |HACIENDO nForesIva = nForesIva + 1;
               |BUCLE LinCerti;
               |HAZ BrutoACert;
               |SI nMiPrecio ! 0; |HAZ graba_linfac; |FINSI;
          |SIGUE;
     |SINO;
          |PARA nForesIva = 0; |SI nForesIva [ 6; |HACIENDO nForesIva = nForesIva + 1;
               |BUCLE LinCerti2;
               |SI #101#15 ! 0; nTotalHacer = #101#15; |FINSI;

               |BUCLE LinCerti;
               |HAZ BrutoACert;
               |SI nMiPrecio ! 0; |HAZ graba_linfac; |FINSI;
          |SIGUE;
     |FINSI;
     |CIERRA #125;
     |CIERRA #8;
|FPRC;
