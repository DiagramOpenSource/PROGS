|| -------- Listado Totales Ventas Con Rappels (Albaranes) ----------

|FICHEROS;
     fmart003 #0; ||  listresu #0;   || albad016
     agifa010 #1;
     agifa071 #2;
     fmart002 #3; || rappels  #3;   || albad005
     fmart004 #4; || tempresu #4;   || albad020
     agifa024 #5;
     fmart005 #6; || temtresa #6;   || albad021
     agifa019 #7;
     agifa084 #21;
     agifa069 #22;
/*
     albad003 #30;
*/
|FIN;

|VARIABLES;
     nHay  = 0;
     &Tempo = "";
     aTmp4 = "";
     aTmp6 = "";
     nUniPromo = 0;
     nUniBase = 0;
     nImpDto = 0;
     nUniTotal = 0;
     &EURODB = 0;
     informe  = "iistresu";
     informe2 = "iistrest";
     informe3 = "iistre1";
     informe4 = "iistre1t";
     resto = 0;
     unip = 0;
     rapp1 = 0;
     rapp2 = 0;
     rapp3 = 0;
     rapp33 = 0;
     pbon = 0;
     dpp = 0;
     dtolin = 0;
     dtolin1 = 0;
     vcaj = 0;
     &t1 = 0;
     &t2 = 0;
     &t3 = 0;
     &t4 = 0;
     &t5 = 0;
     &t6 = 0;
     &t7 = 0;
     &t10 = 0;
     obseq = 0;
     a = -1;
     sw = 0;
     codigo = "";
     precio = 0;
     implin = 0;
     imprap = 0;
|FIN;

|PROCESO Mensa7;
|FPRC;

|CALCULO pintap;
|SI FSalida = 5;
   |ERROR;
|FINSI;
|SI FSalida = 9;
          |PUSHV 501 2380;
               |PINPA #1#0;
          |PAUSA;
          |POPV;
|FINSI;
|FCAL;

|CALCULO tiplis;|TIPO 0;
|CAMPO_MODIFICA #0#11,1,"S";
|CAMPO_MODIFICA #0#12,1,"S";
|CAMPO_MODIFICA #0#13,1,"S";
|PINTA 1069 , "        ";
|PINTA 1169 , "        ";
|SI #0#20 = 2;
  #0#7 = "  ";
  |PINTA #0#7;
  #0#8 = "YZ";
  |PINTA #0#8;
  |PINTA 1069 , informe;
  |PINTA 1169 , informe2;
|SINO;
  #0#7 = "Z ";
  |PINTA #0#7;
  #0#8 = "ZZ";
  |PINTA #0#8;
  |CAMPO_MODIFICA #0#11,1,"N";
  |CAMPO_MODIFICA #0#12,1,"N";
  |CAMPO_MODIFICA #0#13,1,"N";
  |PINTA 1069 , informe3;
  |PINTA 1169 , informe4;
|FINSI;
|FCAL;

|CALCULO genera;|TIPO 0;
|SI #0#11 = "S";
  |CAMPO_MODIFICA #0#12,1,"S";
  |CAMPO_MODIFICA #0#13,1,"S";
|SINO;
  |CAMPO_MODIFICA #0#12,1,"N";
  |CAMPO_MODIFICA #0#13,1,"N";
|FINSI;
|FCAL;

|CALCULO linpro;
     |SI #2#63 = -1; || Linea de promocion
          |ACABA;
     |FINSI;

     nUniPromo = #2#66;
     nUniBase = #2#5;
     nImpDto = #2#64;
     nUniTotal = nUniBase + nUniPromo;

     |DDEFECTO #7;
     #7#0 = #2#2;
     |LEE 000#7=;
     |SI #7#125 ] #0#15;|Y #7#125 [ #0#16;
          |DDEFECTO #4;
          #4#0 = #1#3;
          #4#1 = #2#2;
          |LEE 101#4=;
          |SI FSalida ! 0;|GRABA 021#4b; |FINSI;

          || ------ Acumulacion de Totales En Temporal --------------
/*
          |DDEFECTO #30;
          #30#0 = #2#29;
          #30#1 = #2#0;
          |LEE 000#30=;

          |SI #30#2 = "N";
*/
               #4#2 = #4#2 + nUniTotal;         || Cantidad total incluido promociones
               precio = #2#6 + nImpDto;
               implin = (#2#5 * precio) + (#2#66 * precio);
               #4#4 = #4#4 + implin;       || Importe total no incluido bonificaciones
               pbon = nImpDto * #2#5;
               #4#5 = #4#5 + pbon;         || Pesetas Bonificacion
               dtolin = #2#7 < #2#8;
               dtolin1 = dtolin < #2#33;
               dtolin = #2#7 - dtolin1;
               dtolin = dtolin ! EURODB;
               #4#5 = #4#5 + dtolin;       || Pesetas Bonificacion + Descuento Lineal
               dpp = #2#7 % #1#7;
               |SI #7#125 = "E ";
                    dpp = 0;
               |FINSI;
               #4#6 = #4#6 + dpp;          || Dto P.P.
               vcaj = nUniPromo * precio;
               #4#7 = #4#7 + vcaj;         || Valor Cajas Promocion a precio sin bonificaciones
               #4#9 = #4#9 + nUniBase;        || Unidades Base
               imprap = nUniBase * precio;
               #4#10 = #4#10 + imprap;     || Importe Para Rappels

               ||   -------- Rappels Entregados ------------
               |SI #1#52 ] "Z    ";|Y #1#52 [ "ZZ   ";
                    #4#11 = #4#11 + #2#9;
               |FINSI;

                 ||   -------- Rappels ------------
               |SI #1#52 < "Z    ";|O #1#52 > "ZZ   ";
                    #3#0 = #1#3;
                    #3#1 = #2#2;
                    |LEE 000#3=;
                    |SI FSalida = 0;
                         rapp1 = #4#10 % #3#2;
                         rapp2 = #4#9 * #3#3;
                         unip = #4#9 / #3#4;
                         resto = #4#9 $ #3#4;
                         resto = resto / #3#4;
                         unip = unip - resto;
                         rapp33 = unip * #3#5;
                         rapp3 = rapp33 * precio;
                         #4#3 = rapp1 + rapp2 + rapp3; ||Rappels
                    |FINSI;
               |FINSI;
/*
          |SINO;
               obseq =  #2#9 * a;           || Obsequios no acumulando lo demas
               #4#8 = #4#8 + obseq;
          |FINSI;
*/
          |GRABA 021#4a;
          |LIBERA #4;

          imprap = 0;
          implin = 0;
          unip = 0;
          resto = 0;
          rapp1 = 0;
          rapp2 = 0;
          rapp33 = 0;
          rapp3 = 0;
          pbon = 0;
          dpp = 0;
          dtolin = 0;
          dtolin1 = 0;
          vcaj = 0;
          obseq = 0;
          precio = 0;
     |FINSI;
|FCAL;

|CALCULO listresu1;        ||Todos Los Albaranes Seleccionados
     #5#0 = #1#3;
     |LEE 000#5=;
     |SI FSalida = 0;
       |SI #5#158 ] #0#2;|Y #5#158 [ #0#3;
         |SI #5#3 ] #0#17;|Y #5#3 [ #0#18;
           |BUCLELIN 2linpro#1;
         |FINSI;
       |FINSI;
     |FINSI;
|FCAL;

|DEFBUCLE listresu1;
     #1#3;
     ;
     #0#0 , #0#4 , #0#7 , #0#9;
     #0#1 , #0#5 , #0#8 , #0#10;
     be;
     NULL,listresu1;
|FIN;

|CALCULO totales;
     |DDEFECTO #6;
     #6#0 = #4#1;
     |LEE 101#6=;
     |SI FSalida ! 0; |GRABA 021#6b; |FINSI;
     #6#0 = #4#1;
     #6#1 = #6#1 + #4#2;
     #6#2 = #6#2 + #4#3;
     #6#3 = #6#3 + #4#4;
     #6#4 = #6#4 + #4#5;
     #6#5 = #6#5 + #4#6;
     #6#6 = #6#6 + #4#7;
     #6#7 = #6#7 + #4#8;
     #6#8 = #6#8 + #4#9;
     #6#9 = #6#9 + #4#10;
     #6#10 = #6#10 + #4#11;
     |GRABA 021#6a;
     |LIBERA #6;
|FCAL;

|DEFBUCLE total;
     #4#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL , totales;
|FIN;

|CALCULO ImprimeResu;
     nHay = 1;
     |PRINT;
     t1 = t1 + #6#1;
     t2 = t2 + #6#2;
     t3 = t3 + #6#3;
     t4 = t4 + #6#4;
     t5 = t5 + #6#5;
     t6 = t6 + #6#6;
     t7 = t7 + #6#7;
     t10 = t10 + #6#10;
|FCAL;

|DEFBUCLE ImprimeResu;
     #6#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL,ImprimeResu;
|FIN;

|CALCULO ImprimeDeta;
     |SI sw = 0;
       sw = 1;
       codigo = #4#0;
     |FINSI;
     |SI codigo ! #4#0;
       codigo = #4#0;
       |PIEINF;
       t1 = 0;
       t2 = 0;
       t3 = 0;
       t4 = 0;
       t5 = 0;
       t6 = 0;
       t7 = 0;
       t10 = 0;
     |FINSI;
     nHay = 1;
     |PRINT;
     t1 = t1 + #4#2;
     t2 = t2 + #4#3;
     t3 = t3 + #4#4;
     t4 = t4 + #4#5;
     t5 = t5 + #4#6;
     t6 = t6 + #4#7;
     t7 = t7 + #4#8;
     t10 = t10 + #4#11;
|FCAL;

|DEFBUCLE ImprimeDeta;
     #4#1;
     ;
     #0#0 , "                    ";
     #0#1 , "zzzzzzzzzzzzzzzzzzzz";
     be;
     NULL,ImprimeDeta;
|FIN;

|PROCESO listresu;|TIPO 3;
     |HAZ CreaTempo; |NOME_DAT #4 Tempo; aTmp4 = Tempo; |DELINDEX #4;
     |HAZ CreaTempo; |NOME_DAT #6 Tempo; aTmp6 = Tempo; |DELINDEX #6;

     |ABRE #1;
     |ABRE #2;
     |ABRE #3;
     |ABRE #4;
     |ABRE #5;
     |ABRE #6;
     |ABRE #21;
     |ABRE #22;
     |ABRE #7;
/*
     |ABRE #30;
*/
     |SI #0#21 = "A";|O #0#21 = "T";
          |BUCLE listresu1;
          |BUCLE total;
     |FINSI;
     |SI #0#21 = "F";|O #0#21 = "T";
          |HAZ facturas;
     |FINSI;
     |IMPRE 1;
     |SI FSalida = 0;
          |SI #0#14 = "T";
               |SI #0#20 = 2;
                    |INFOR informe2;
               |SINO;
                    |INFOR informe4;
               |FINSI;
          |SINO;
               |SI #0#20 = 2;
                    |INFOR informe;
               |SINO;
                    |INFOR informe3;
               |FINSI;
          |FINSI;
          |SI FSalida = 0;
               |SI #0#14 = "D";
                    |BUCLE ImprimeDeta;
               |SINO;
                    |BUCLE ImprimeResu;
               |FINSI;
               |SI nHay ! 0; |PIEINF; |FINSI;
               |FININF;
          |FINSI;
          |FINIMP;
     |FINSI;
/*
     |CIERRA #30;
*/
     |CIERRA #7;
     |CIERRA #1;
     |CIERRA #2;
     |CIERRA #3;
     |CIERRA #4;
     |CIERRA #5;
     |CIERRA #6;
     |CIERRA #21;
     |CIERRA #22;
     |SI #0#11 = "S";
          |HAZ  generap;
     |FINSI;
     |DELINDEX #4;
     |DELINDEX #6;
|FPRC;
