     ExportaOpt

|FICHEROS;
     ortsm006 #6;
     ortsm013 #13;
     ortsz014 #14,MANTE;
     ortsm016 #16;
     ortsm017 #17;
     ortsm018 #18;
     agifa019 #19;
     ortsm023 #23;
     ortsm024 #24;
     agifa104 #104;
     ortsm019 #119;
|FIN;

|VARIABLES;
     aAlfa126 = "";
     &enError = 0;
     &eaRuta = "";
     aSepara = ";"
     nHandle = 0;
     aDato = "";
     {1}aLocal = "";
     aXls = "";
     aAlfa = "";
     aAlfa1 = "";
     aBase = "";
     aOrigen = "";
     aDestino = "";
     nReg = 0;
     nUni = 0;
     aFin = "";
|FIN;

|PROCESO Graba1;
     |QBF aAlfa;
     |SI nReg ! 0; aAlfa = aSepara + aAlfa; |FINSI;
     |XGRABA nHandle, aAlfa;
     nReg = nReg + 1;
|FPRC;

|PROCESO ExportaCsvLin;
     #104#25 = #24#2;
     #104#0 = #24#3;
     |LEE 000#104=;
     |SI FSalida ! 0; |DDEFECTO #104; |FINSI;

     |SELECT #2#13;
     #13#1 = #24#2;
     #13#2 = #24#3;
     |LEE 000#13=;
     |SI FSalida ! 0; |DDEFECTO #13; |FINSI;

     #16#28 = #24#2;
     #16#0 = #24#3;
     #16#1 = #24#4;
     |LEE 000#16=;
     |SI FSalida ! 0; |DDEFECTO #16; |FINSI;

     #119#0 = #16#2;
     |LEE 000#119=;
     |SI FSalida ! 0; |DDEFECTO #119; |FINSI;

     #17#0 = #24#2;
     #17#1 = #24#3;
     #17#2 = #24#4;
     #17#3 = #24#5;
     |LEE 000#17=;
     |SI FSalida ! 0; |DDEFECTO #17; |FINSI;

     #18#0 = #24#2;
     #18#1 = #24#3;
     #18#2 = #24#4;
     #18#3 = #24#5;
     #18#4 = #24#6;
     |LEE 000#18=;
     |SI FSalida ! 0; |DDEFECTO #18; |FINSI;

     #19#0 = #17#4;
     |LEE 000#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;

     #6#0 = #24#8;
     |LEE 000#6=;
     |SI FSalida ! 0; |DDEFECTO #6; |FINSI;

     nReg = 0;

     |SI #24#14 = 0;
          aAlfa = "TABTX" + #24#8; |HAZ Graba1;
     |SINO;
          aAlfa = "TAB" + (("00"+#24#14)%-102) + #24#8; |HAZ Graba1;
     |FINSI;

     aAlfa = #24#11; |HAZ Graba1;
     aAlfa = #24#12; |HAZ Graba1;
     aAlfa = #24#8; |HAZ Graba1;

     aAlfa = #24#14; |HAZ Graba1;
     aAlfa = #24#15; |HAZ Graba1;
     aAlfa = #24#16; |HAZ Graba1;
     aAlfa = #24#17; |HAZ Graba1;
     aAlfa = #24#18; |HAZ Graba1;
     aAlfa = #24#19; |HAZ Graba1;

     |SI #17#8 = "S";
          aAlfa = #18#6; |HAZ Graba1;
     |SINO;
          aAlfa = #17#11; |HAZ Graba1;
     |FINSI;
     |SI #24#6 = 0;
          aAlfa = ""; |HAZ Graba1;
     |SINO;
          aAlfa = #24#6 + " de " + #17#7; |HAZ Graba1;
     |FINSI;
     aAlfa = #16#2; |HAZ Graba1;
     aAlfa = #16#4; |HAZ Graba1;
     aAlfa = #17#5; |HAZ Graba1;
     aAlfa = #24#7; |HAZ Graba1;
     aAlfa = #19#2; |HAZ Graba1;
     aAlfa = #19#3; |HAZ Graba1;
     aAlfa = #24#20; |HAZ Graba1;

     aAlfa = #104#25; |QBF aAlfa;
     aAlfa = aAlfa + "-" + (("000000" + #104#0)%-106); |HAZ Graba1;

     aAlfa = #13#3;
     aAlfa = #13#6 + aAlfa; |HAZ Graba1;

     aAlfa = #104#4; |HAZ Graba1;
     aAlfa = #104#1; |HAZ Graba1;

     aAlfa126 = #19#126;
     |SI #19#2 = "N"; aAlfa126 = #19#126; |SINO; aAlfa126 = #17#28; |FINSI;

     #19#0 = #16#2;
     |LEE 000#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;

     aAlfa = #19#127; |HAZ Graba1;

     aAlfa = #24#7; |QBF aAlfa;
     |PARA; |SI; |HACIENDO;
          aAlfa1 = aAlfa - "-";
          |SI aAlfa1 = aAlfa; |SAL; |FINSI;
          aAlfa = aAlfa1;
     |SIGUE;
     |SI #119#2 = "S";
          |SI #119#2 = "S";
               |SI #17#8 = "N";
                    aAlfa = #17#20;
               |SINO;
                   aAlfa = #18#7;
                   |QBF aAlfa;
                   |SI aAlfa = ""; aAlfa = #17#20; |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #17#8 = "S"; aAlfa1 = #18#6; |SINO; aAlfa1 = #17#11; |FINSI;
     aAlfa1 = aAlfa1 % 102;
     |QBF aAlfa;
     aAlfa = aAlfa + aAlfa1; |HAZ Graba1;

     aAlfa = #24#2+"_"+(("000000"+#24#3)%-106)+"_"+(("000"+#24#4)%-103)+"_"+(("000"+#24#5)%-103)+"_"+(("000"+#24#6)%-103);
     |HAZ Graba1;

     aAlfa = #16#59; |HAZ Graba1;

     |SI #24#6 = 0;
          aAlfa = ""; |HAZ Graba1;
     |SINO;
          aAlfa = #24#6 + "-" + #24#8; |HAZ Graba1;
     |FINSI;

     aAlfa = aAlfa126; |HAZ Graba1;
     aAlfa = #6#1; |HAZ Graba1;

     |SI #119#2 = "N";
          aAlfa = "";
     |SINO;
          |SI #17#8 = "S";
               aAlfa = #18#8;
          |SINO;
               aAlfa = #17#21;
          |FINSI;
     |FINSI;
     |HAZ Graba1;

     |SI #119#2 = "N";
          aAlfa = "";
     |SINO;
         aAlfa = "I:\Factory\Imorder\" + #17#36; |QBF aAlfa;
         aAlfa = aAlfa + "\BITMAPS\" + #17#37; |QBF aAlfa;
         aAlfa = aAlfa + ".PNG";
     |FINSI;
     |HAZ Graba1;

     |XGRABA nHandle, aFin;
|FPRC;

|DEFBUCLE ExportaCsvLin;
     #24#1;
     9;
     #23#3, #23#0, 0000, "S";
     #23#3, #23#0, 9999, "S";
     ;
     NULL, ExportaCsvLin;
|FIN;

|PROCESO ExportaXlsLin;
     #104#25 = #24#2;
     #104#0 = #24#3;
     |LEE 000#104=;
     |SI FSalida ! 0; |DDEFECTO #104; |FINSI;

     |SELECT #2#13;
     #13#1 = #24#2;
     #13#2 = #24#3;
     |LEE 000#13=;
     |SI FSalida ! 0; |DDEFECTO #13; |FINSI;

     #16#28 = #24#2;
     #16#0 = #24#3;
     #16#1 = #24#4;
     |LEE 000#16=;
     |SI FSalida ! 0; |DDEFECTO #16; |FINSI;

     #119#0 = #16#2;
     |LEE 000#119=;
     |SI FSalida ! 0; |DDEFECTO #119; |FINSI;

     #17#0 = #24#2;
     #17#1 = #24#3;
     #17#2 = #24#4;
     #17#3 = #24#5;
     |LEE 000#17=;
     |SI FSalida ! 0; |DDEFECTO #17; |FINSI;

     #18#0 = #24#2;
     #18#1 = #24#3;
     #18#2 = #24#4;
     #18#3 = #24#5;
     #18#4 = #24#6;
     |LEE 000#18=;
     |SI FSalida ! 0; |DDEFECTO #18; |FINSI;

     #19#0 = #17#4;
     |LEE 000#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;

     #6#0 = #24#8;
     |LEE 000#6=;
     |SI FSalida ! 0; |DDEFECTO #6; |FINSI;

     nReg = nReg + 1;

     |SI #24#14 = 0;
          aAlfa = "TABTX" + #24#8;
     |SINO;
          aAlfa = "TAB" + (("00"+#24#14)%-102) + #24#8;
     |FINSI;
     aAlfa = "A" + nReg + "," + aAlfa; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "B" + nReg + "," + #24#11; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "C" + nReg + "," + #24#12; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "D" + nReg + "," + #24#8; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "E" + nReg + "," + #24#14; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "F" + nReg + "," + #24#15; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "G" + nReg + "," + #24#16; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "H" + nReg + "," + #24#17; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "I" + nReg + "," + #24#18; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "J" + nReg + "," + #24#19; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     |SI #17#8 = "S";
          aAlfa = "K" + nReg + "," + #18#6; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |SINO;
          aAlfa = "K" + nReg + "," + #17#11; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;
     |SI #24#6 = 0;
          aAlfa = "L" + nReg + "," + ""; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |SINO;
          aAlfa = #24#6 + " de " + #17#7;
          aAlfa = "L" + nReg + "," + aAlfa; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;
     aAlfa = "M" + nReg + "," + #16#2; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "N" + nReg + "," + #16#4; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "O" + nReg + "," + #17#5; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "P" + nReg + "," + #24#7; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "Q" + nReg + "," + #19#2; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "R" + nReg + "," + #19#3; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "S" + nReg + "," + #24#20; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = #104#25; |QBF aAlfa;
     aAlfa = aAlfa + "-" + (("000000" + #104#0)%-106);
     aAlfa = "T" + nReg + "," + aAlfa; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = #13#3;
     aAlfa = #13#6 + aAlfa;
     aAlfa = "U" + nReg + "," + aAlfa; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "V" + nReg + "," + #104#4; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "W" + nReg + "," + #104#1; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     |SI #119#2 = "N"; aAlfa126 = #19#126; |SINO; aAlfa126 = #17#28; |FINSI;

     #19#0 = #16#2;
     |LEE 000#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;

     aAlfa = "X" + nReg + "," + #19#127; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = #24#7; |QBF aAlfa;
     |PARA; |SI; |HACIENDO;
          aAlfa1 = aAlfa - "-";
          |SI aAlfa1 = aAlfa; |SAL; |FINSI;
          aAlfa = aAlfa1;
     |SIGUE;
     |SI #119#2 = "S";
          |SI #17#8 = "N";
               aAlfa = #17#20;
          |SINO;
              aAlfa = #18#7; |QBF aAlfa;
              |SI aAlfa = ""; aAlfa = #17#20; |FINSI;
          |FINSI;
     |FINSI;
     |SI #17#8 = "S"; aAlfa1 = #18#6; |SINO; aAlfa1 = #17#11; |FINSI;
     aAlfa1 = aAlfa1 % 102;
     |QBF aAlfa;
     aAlfa = aAlfa + aAlfa1;
     aAlfa = "Y" + nReg + "," + aAlfa; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = #24#2+"_"+(("000000"+#24#3)%-106)+"_"+(("000"+#24#4)%-103)+"_"+(("000"+#24#5)%-103)+"_"+(("000"+#24#6)%-103);
     aAlfa = "Z" + nReg + "," + aAlfa; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "AA" + nReg + "," + #16#59; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     |SI #24#6 = 0;
          aAlfa = "AB" + nReg + "," + ""; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |SINO;
          aAlfa = #24#6 + "-" + #24#8;
          aAlfa = "AB" + nReg + "," + aAlfa; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;

     aAlfa = "AC" + nReg + "," + aAlfa126; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "AD" + nReg + "," + #6#1; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     |SI #119#2 = "N";
          aAlfa = "";
     |SINO;
          |SI #17#8 = "S";
               aAlfa = #18#8;
          |SINO;
               aAlfa = #17#21;
          |FINSI;
     |FINSI;
     aAlfa = "AE" + nReg + "," + aAlfa; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     |SI #119#2 = "N";
          aAlfa = "";
     |SINO;
          aAlfa = "I:\Factory\Imorder\" + #17#36; |QBF aAlfa;
          aAlfa = aAlfa + "\BITMAPS\" + #17#37; |QBF aAlfa;
          aAlfa = aAlfa + ".PNG";
     |FINSI;
     aAlfa = "AF" + nReg + "," + aAlfa; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
|FPRC;

|DEFBUCLE ExportaXlsLin;
     #24#1;
     9;
     #23#3, #23#0, 0000, "S";
     #23#3, #23#0, 9999, "S";
     ;
     NULL, ExportaXlsLin;
|FIN;

|PROCESO Fichero14; |TIPO 0;
     |SI FSalida = 13;
          |HAZ DsSelect;
          |SI enError = 0;
               #13Campo = eaRuta; |PINTA #13Campo;
          |FINSI;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO ExportaOpt;
     |ABRE #14;
     |LEE 101#14=;
     |SI FSalida ! 0; |GRABA 020#14b; |FINSI;
     |PINPA #0#14;
     |PINDA #0#14;
     |ENDATOS #1#14;
     |SI FSalida = 0;
          |GRABA 020#14a;

          |SI #14#2 = "X";
               |DBASE aBase;
               aOrigen = aBase + "001655/ortsopt.xls";

               |ESPECIFICA "RBASS", aLocal;
               aBase = aLocal;
               aDestino = aBase + "tmp/";  |MKDIR aDestino;
               aDestino = aDestino + "ortsopt.xls";
               aXls = aDestino;

               |ENVIA_FICHERO aOrigen, aDestino;

               aDestino = #14#1; |QBF aDestino;
               aAlfa = aDestino % -104;
               |SI aAlfa ! ".xls"; aDestino = aDestino  + ".xls"; |FINSI;

               |CARGADLL "agixl97.dll";
               |SI FSalida < 0;
                   |MENAV "0000No se puede usar agixl97.dll";
               |SINO;
                    |ALFACALLDLL "agixl97.dll", "carga_book", aXls;
                    |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja1";

                    nReg = 1;
                    |ABRE #6;
                    |ABRE #13;
                    |ABRE #16;
                    |ABRE #17;
                    |ABRE #18;
                    |ABRE #19;
                    |ABRE #104;
                    |ABRE #119;
                    |BUCLE ExportaXlsLin;
                    |CIERRA #119;
                    |CIERRA #104;
                    |CIERRA #19;
                    |CIERRA #18;
                    |CIERRA #17;
                    |CIERRA #16;
                    |CIERRA #13;
                    |CIERRA #6;

                    |ALFACALLDLL "agixl97.dll", "fichero_destino", aDestino;
                    |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
                    |DESCARGADLL "agixl97.dll";
               |FINSI;
               |RFBORRA aXls;
          |SINO;
               aFin = &13 + &10;
               aDestino = #14#1; |QBF aDestino;
               aAlfa = aDestino % -104;
               |SI aAlfa ! ".csv"; aDestino = aDestino  + ".csv"; |FINSI;
               |XABRE "BCW", aDestino, nHandle;
               |SI FSalida ] 0;
                    aAlfa = "Material:"+aSepara+"Largo:"+aSepara+"Ancho"+aSepara+"Color Pieza:"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    aAlfa = "Tablero:"+aSepara+"Cantidad:"+aSepara+"Medidas:"+aSepara+"Chapado Exterior:"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    aAlfa = "Observaciones:"+aSepara+"Obs1:"+aSepara+"Tirador:"+aSepara+"Numerador:"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    aAlfa = "Artículo:"+aSepara+"Desc_Art:"+aSepara+"Descripción:"+aSepara+"Cod.Componente:"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    aAlfa = "Fami:"+aSepara+"Subfa:"+aSepara+"Grupo:"+aSepara+"Pedido:"+aSepara+"Control:"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    aAlfa = "Cte:"+aSepara+"Fecha:"+aSepara+"Orden:"+aSepara+"Cod_Bar:"+aSepara+"Descripción:"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    aAlfa = "Color Base:"+aSepara+"Paneles:"+aSepara+"Banco:"+aSepara+"Desc_Pieza:"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    aAlfa = "CNCBARCODE2:"+aSepara+"BITMAPS:"+aSepara
                    |XGRABA nHandle, aAlfa;
                    |XGRABA nHandle, aFin;
                    nReg = 0;
                    |ABRE #6;
                    |ABRE #13;
                    |ABRE #16;
                    |ABRE #17;
                    |ABRE #18;
                    |ABRE #19;
                    |ABRE #104;
                    |ABRE #119;
                    |BUCLE ExportaCsvLin;
                    |CIERRA #119;
                    |CIERRA #104;
                    |CIERRA #19;
                    |CIERRA #18;
                    |CIERRA #17;
                    |CIERRA #16;
                    |CIERRA #13;
                    |CIERRA #6;
                    |XCIERRA nHandle;
               |SINO;
                    |MENAV "0000Error al crear el fichero...";
               |FINSI;
          |FINSI;
          |LIBERA #14;
     |FINSI;
     |CIERRA #14;
|FPRC;
