|FICHEROS;
     albad035 #0;
     albad036 #1; || agifa227 en la dscomer9, agifa301 en albadist
     agifa134 #2;
     agifa010 #3;
     agifa071 #4;
     agifa059 #5;
     agifa024 #6;
     agifa019 #7;
     dsz99984 #11;
     agifa133 #17;       ||Vencimientos facturas
     agifa228 #18;       ||Numeros De Albaranes
     agifa017 #8;
     agifa091 #91;
     agifa324 #324;
     agifa321 #321;
     tempo134 #134;
     agifa136 #136;
     alba0003 #30;
|FINSI;

|VARIABLES;
     &ser_fac = "";
     &num_fac = 0;
     &enFormato = 0;
     aTmp1 = "";
     aTmp18 = "";
     &Tempo = "";
     &aDivisa = "";
     &aMoneda = "";
     nNume = 0;
     aNume = "";
     nCampo = 0;
     nContaCam = 0;
     nContaAlb = 0;
     &eaFichero = "";
     &enDirEnt = 0;
     &eaProg   = "";
     &nDeci_BaseMx = 0;
     &nDeci_PreBaseMx = 0;
     &nDeci_Base = 0;
     &nDeci_PreBase = 0;
     &nDeci_Div = 0;
     &nDeci_PreDiv = 0;
     aAlfa  = "";
     campo1 = "";
     campo2 = "";
     campo3 = "";
     campo4 = "";
     contalb = 0;
     mensaje   = "";
     informe   = "";
     ult_ser   = "";
     ult_fac   = 0;
     sw        = 0;
     sw_print  = 0;
     sw1       = 0;
     num1      = 0;
     num2      = 0;
     i         = 0;
     dirapl    = "";
     dirapl1   = "";
     unidades = 0;
     ncopias   = 0;
     vic       = 0;
     &f1 = @; &f2 = @; &f3 = @; &f4 = @; &f5 = @; &f6 = @; &f7 = @; &f8 = @;
     &i1 = 0; &i2 = 0; &i3 = 0; &i4 = 0; &i5 = 0; &i6 = 0; &i7 = 0; &i8 = 0;
     nBlancos = 0;
     aAlfa1 = "";
|FIN;

|PROCESO &leevenci;
     i1 = 0; i2 = 0; i3 = 0; i4 = 0; i5 = 0; i6 = 0; i7 = 0; i8 = 0;
     |ABRE #17;
     #17#4 = #2#49; ||serie
     #17#0  = #2#0;
     |SI sw = 1; num1 = num1 + 8; num2  = num2 + 8; |FINSI;
     |SI sw = 0; num1 = 1; num2 = 8; sw = 1; |FINSI;
     sw1 = 0;
     |DDEFECTO #136;
     |PARA i = 0; |SI i [ num2; |HACIENDO i = i + 1;
          sw1 = sw1 + 1;
          #17#1 = sw1;
          |LEE 001#17=;
          |SI FSalida = 0; |Y #17#0 = #2#0; |Y #17#4 = #2#49;
            |SI #2#31 < 0;|Y #17#2 > 0;#17#2 = #17#2 * - 1; |FINSI;
              |SI sw1 = 1;f1 = #17#3;i1 = #17#2;|FINSI;
              |SI sw1 = 2;f2 = #17#3;i2 = #17#2;|FINSI;
              |SI sw1 = 3;f3 = #17#3;i3 = #17#2;|FINSI;
              |SI sw1 = 4;f4 = #17#3;i4 = #17#2;|FINSI;
              |SI sw1 = 5;f5 = #17#3;i5 = #17#2;|FINSI;
              |SI sw1 = 6;f6 = #17#3;i6 = #17#2;|FINSI;
              |SI sw1 = 7;f7 = #17#3;i7 = #17#2;|FINSI;
              || Para igualarlo al agifa136
              |SI sw1 = 8;f8 = #17#3;i8 = #17#2;|FINSI;
              |SI sw1 = 1;#136#14 = #17#3;#136#13 = #17#2;|FINSI;
              |SI sw1 = 2;#136#16 = #17#3;#136#15 = #17#2;|FINSI;
              |SI sw1 = 3;#136#18 = #17#3;#136#17 = #17#2;|FINSI;
              |SI sw1 = 4;#136#20 = #17#3;#136#19 = #17#2;|FINSI;
              |SI sw1 = 5;#136#22 = #17#3;#136#21 = #17#2;|FINSI;
              |SI sw1 = 6;#136#24 = #17#3;#136#23 = #17#2;|FINSI;
              |SI sw1 = 7;#136#26 = #17#3;#136#25 = #17#2;|FINSI;
              |SI sw1 = 8;#136#28 = #17#3;#136#27 = #17#2;|FINSI;
              |SI sw1 = 9;#136#30 = #17#3;#136#29 = #17#2;|FINSI;
              |SI sw1 =10;#136#32 = #17#3;#136#31 = #17#2;|FINSI;
              |SI sw1 =11;#136#34 = #17#3;#136#33 = #17#2;|FINSI;
              |SI sw1 =12;#136#36 = #17#3;#136#35 = #17#2;|FINSI;
          |FINSI;
     |SIGUE;
     |LIBERA #17;
     |CIERRA #17;
     || num1 = 0;
     || num2 = 0;
     sw = 0;
|FPRC;

|PROCESO hazreci;
     |ABRE #91;
     #91#0 = #2#11;
     |LEE 000#91=;
     |CIERRA #91;

     |HAZ AbreRecVenta;

     |ABRE #17;
     #17#0 = #2#0;
     #17#4 = #2#49;
     #17#1 = 0;
     |LEE 001#17];
     |PARA ; |SI FSalida = 0; |Y #17#0 = #2#0;|Y #17#4 = #2#49; |HACIENDO;
          |DDEFECTO #11;
          #11#17 = #2#49;
          #11#0 = #2#0;
          #11#1 = #17#1; ||Linea;
          #11#2 = #2#2;  ||cliente
          #11#3 = #2#3;  ||nombre del cliente
          #11#4 = #2#9;  ||Banco
          #11#5 = "S";   ||domiciliado
          #11#6 = "N";   ||aceptado
          #11#7 = #2#1;  ||fecha de emision
          #11#8 = #17#3; ||Fecha de vencimiento
          #11#9 = #17#2; ||Importe
          |SI #2#31 < 0;|Y #17#2 > 0; #11#9 = #11#9 * - 1; |FINSI;
          #11#10 = "N";  ||Impreso
          #11#11 = "N";  ||Contabilizado
          #11#12 = #2#12;||numero contable
          #11#13 = "N";  ||Cobrado
          #11#14 = "N";  ||Impagado
          #11#15 = #6#161;    ||A aceptar
          #11#16 = "01.01.0000";   ||fecha de cobro
          #11#21 = #91#69;||Tipo Recibo
          #11#22 = "Pdte. Cobro";
          #11#24 = #91#0;
          #11#25 = #91#1;
          eaProg = "agifa134";
          ||HAZ CreaRecVenta;
          |HAZ RecVenta;
          |LEE 001#17s;
     |SIGUE;
     |CIERRA #17;
     |HAZ CierraRecVenta;
|FPRC;

|PROCESO cabe_factu;
     aDivisa = #2#58;
     aMoneda = #2#60;
     |HAZ Divisas134;

     campo1 = "";
     campo2 = "";
     campo3 = "";
     campo4 = "";
     mensaje = "Procesando Factura : " + #2#49 + "/" + #2#0;
     |PINTA 2420 , mensaje;
|FPRC;

|PROCESO lin_factu;
     |ABRE #6;
     #6#0 = #2#2;
     |LEE 000#6=;
     |CIERRA #6;

     #3#52 = #5#15;
     #3#0 = #5#2;
     |LEE 001#3=;
     |SI FSalida = 0;
          aDivisa = #3#68;
          aMoneda = #3#70;
          |HAZ Divisas010;
          |BUCLELIN 2graba_tmp#3;
     |FINSI;
     enDirEnt = #agifa010#84;

     |ABRE #18;
     #18#0 = #2#49;
     #18#1 = #2#0;
     |LEE 101#18=;
     |SI FSalida ! 0;
          contalb = 0;
          nContaAlb = 0;
          nContaCam = 0;
          |PARA i = 2; |SI i [ 24; |HACIENDO i = i + 1;
               #18#i# = "";
          |SIGUE;
          |GRABA 020#18b;
     |FINSI;

     contalb = contalb + 1;

     |SI contalb < 5;
       campo1 = #18#2;   |QBF campo1;
       #18#2 = campo1 + " -Albaran:" + #3#52 + "/" + #3#0;
       |SI #0#12 = "F";
           #18#2 = campo1 + " -Fecha:" + #3#1;
       |FINSI;
     |FINSI;

     |SI contalb ] 5;|Y contalb < 9;
       campo2 = #18#3;   |QBF campo2;
       #18#3 = campo2 + " -Albaran:" + #3#52 + "/" + #3#0;
       |SI #0#12 = "F";
           #18#3 = campo2 + " -Fecha:" + #3#1;
       |FINSI;
     |FINSI;

     |SI contalb ] 9;|Y contalb < 13;
       campo3 = #18#4;   |QBF campo3;
       #18#4 = campo3 + " -Albaran:" + #3#52 + "/" + #3#0;
       |SI #0#12 = "F";
           #18#4 = campo3 + " -Fecha:" + #3#1;
       |FINSI;
     |FINSI;

     |SI contalb ] 13;
       campo4 = #18#5;   |QBF campo4;
       #18#5 = campo4 + " -Albaran:" + #3#52 + "/" + #3#0;
       |SI #0#12 = "F";
           #18#5 = campo4 + " -Fecha:" + #3#1;
       |FINSI;
     |FINSI;

     |SI nContaCam < 18; ||| Maximo 18 campos
          aNume = ("000000" + #3#0) % -106;
          nCampo = nContaCam + 7;
          aAlfa = #18nCampo; |QBF aAlfa;
          aAlfa = aAlfa + " " + aNume;
          #18nCampo = aAlfa;

          nContaAlb = nContaAlb + 1;
          |SI nContaAlb ] 10; || Maximo 10 por Campo
               nContaAlb = 0;
               nContaCam = nContaCam + 1;
          |FINSI;
     |FINSI;

     |GRABA 020#18a;
     |CIERRA #18;
|FPRC;

|PROCESO graba_tmp;
     |SI #4#63 = -1;
          |ACABA;        ||  Linea Promocion
     |FINSI;

     nBlancos = nBlancos + 1;
     sw = 1;
     |DDEFECTO #1;
     #1#0 = #2#49;
     #1#1 = #2#0;
     #1#2 = #4#2;
     aAlfa1 = #1#2; |QBF aAlfa1;
     |SI aAlfa1 = "";
          #1#2 = "z";
          #1#5 = nBlancos;
     |SINO;
          #1#5 = #4#6;
     |FINSI;
     |LEE 101#1=;
     |SI FSalida ! 0;
          #1#7 = #2#2;
          #1#3 = #4#4;
          |GRABA 021#1b;
     |FINSI;
     unidades = #4#5;

     |DDEFECTO #30;
     |ABRE #30;
     #30#0 = #3#52;
     #30#1 = #3#0;
     |LEE 000#30=;
     |CIERRA #30;
     |SI #30#2 = "S";
          unidades = 0;
     |FINSI;

     #1#4 = #1#4 + unidades;
     unidades = 0;

     #1#10 = #3#68; ||DIVISA
     #1#11 = #3#70;
     #1#6 = #1#6 + #4#9;
     #1#8 = #1#8 + #4#37;
     #1#9 = #4#36;

     #7#0 = #4#2;
     |LEE 000#7=;
     |SI #7#125 = "E";
          #1#16 = #1#16 + #4#9;
     |SINO;
          #1#15 = #1#15 + #4#9;
     |FINSI;

     #1#13 = #3#68;
     #1#14 = #3#69;

     |SALVA_FICHA #4;
     #4#1 = #4#63;
     |LEE 000#4=;
     |SI FSalida = 0;
          #1#17 = #1#17 + #4#5;
          #1#18 = #1#18 + #4#64;
     |FINSI;
     |REPON_FICHA #4;

     |GRABA 021#1a;
     |LIBERA #1;
|FPRC;

|DEFBUCLE facturas;
   #2#1;
   2,1,45,31;
   #0#9, #0#2 , #0#0 , #0#4 , #0#6 ,  #0#7;
   #0#10,#0#3 , #0#1 , #0#5 , #0#6 ,  #0#8;
   be;
   NULL , cabe_factu , lin_factu;
|FIN;


|PROCESO otravez;
     aAlfa = #1#2; |QBF aAlfa;
     |SI aAlfa = "z"; #1#2 = ""; #1#5 = ""; |FINSI;
     |PRINT;
|FPRC;

|DEFBUCLE otravez;
     #1#1;
     ;
     ult_ser,ult_fac, "                    " , -9999999999;
     ult_ser,ult_fac, "zzzzzzzzzzzzzzzzzzzz" , 99999999999;
     ;
     NULL,otravez;
|FIN;

|PROCESO pepitoperez;
     |PARA vic = 1; |SI vic [ ncopias; |HACIENDO vic = vic + 1;
          |BUCLE otravez;
          |PIEINF;
     |SIGUE;
|FPRC;

|PROCESO imp_tmp;
     aDivisa = #1#13;
     aMoneda = #1#14;
     |HAZ Divisas010;

     aAlfa1 = #1#2; |QBF aAlfa1;
     |SI aAlfa1 = "z";
          #1#2 = "";
          #1#5 = 0;
     |FINSI;

     |SI sw_print = 0;
          ult_ser = #1#0;
          ult_fac = #1#1;
          |HAZ lee_clien;
          |HAZ lee_fac;
          sw_print = 1;
     |FINSI;
     |SI ult_ser ! #1#0; |O ult_fac ! #1#1;
          |SI #2#45 = "N";
               |HAZ hazreci;
               #2#45 = "S";
               |GRABA 021#2a;
          |FINSI;
          |LIBERA #2;
          |PIEINF;
          |SALVA_DATOS #1;
          |CIERRAT #1;
          |HAZ pepitoperez;
          |ABRET #1;
          |REPON_DATOS #1;
          |LEE 000#1=;
          |HAZ lee_clien;
          |HAZ lee_fac;
     |FINSI;
     #7#0 = #1#2;
     |LEE 001#7=;
     |SI FSalida ! 0; |DDEFECTO #7; |FINSI;
     |PRINT;
     ult_ser = #1#0;
     ult_fac = #1#1;
|FPRC;

|PROCESO lee_clien;
     #6#0 = #1#7;
     |LEE 001#6=;
     |SI FSalida ! 0; |DDEFECTO #6; |FINSI;
     ncopias = #6#44;
|FPRC;

|PROCESO lee_fac;
     campo1 = "";
     campo2 = "";
     campo3 = "";
     campo4 = "";
     contalb = 0;
     #2#49 = #1#0;
     #2#0 = #1#1;
     |LEE 101#2=;
     |SI FSalida ! 0; |DDEFECTO #2; |FINSI;
|FPRC;

|PROCESO fin_imp;
     |SI sw_print = 1;
          |SI #2#45 = "N";
               #2#45 = "S";
               |GRABA 021#2a;
               |HAZ hazreci;
          |FINSI;
          |LIBERA #2;
          |PIEINF;
          |SALVA_DATOS #1;
          |CIERRAT #1;
          |HAZ pepitoperez;
          |ABRET #1;
          |REPON_DATOS #1;
          |LEE 000#1=;
          |FININF;
          |FINIMP;
     |FINSI;
|FPRC;

|DEFBUCLE lee_tmp;
     #1#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL , imp_tmp , NULL , NULL , fin_imp;
|FIN;

|PROCESO tempo134;
     |ABRE #2;
     #2#49 = #134#0;
     #2#0 = #134#1;
     |LEE 121#2=;
     |SI FSalida = 0;
          |HAZ cabe_factu;
          |BUCLELIN 2 lin_factu #2;
     |FINSI;
     |CIERRA #2;
|FPRC;

|DEFBUCLE tempo134;
     #134#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, tempo134;
|FIN;


|PROCESO Imprime;
     sw = 0;
     |IMPRE 2;
     |SI FSalida = 0;
          ||informe = #0#11;
          |SI #0#14 = 1;
               informe = "agifa301";
          |SINO;
               informe = "agif1301";
          |FINSI;
          |QBF informe;
          |INFOR informe;
          |SI FSalida ! 0;
               informe = "0000No existe informe:'" + informe +"'";
               |MENAV informe;
          |SINO;
               |ABRE #6;
               |ABRE #7;
               |ABRE #2;
               |BUCLE lee_tmp;
               |CIERRA #6;
               |CIERRA #7;
               |CIERRA #2;
          |FINSI;
     |FINSI;
|FPRC;

|PROGRAMA;
     |HAZ SacaIVA;
     |HAZ CreaTempo; aTmp1 = Tempo;
     |HAZ CreaTempo; aTmp18 = Tempo;
     |NOME_DAT #1 aTmp1;
     |NOME_DAT #18 aTmp18;

     |DELINDEX #1;
     |DELINDEX #18;

     |SI eaFichero = "";
          |SI ser_fac ! "";
               #0#14 = enFormato;
               |ABRE #1;
               |ABRE #3;
               |ABRE #7;
               |ABRE #2;
               #2#49 = ser_fac;
               #2#0 = num_fac;
               |LEE 121#2=;
               |SI FSalida = 0;
                    |HAZ cabe_factu;
                    |BUCLELIN 2 lin_factu #2;
               |FINSI;
               |CIERRA #2;
               |CIERRA #7;
               |CIERRA #1;
               |CIERRA #3;
               |SI sw = 1;
                    |HAZ Imprime;
               |FINSI;
          |SINO;
               |CLS;
               |CABEZA "Imp.Fact.Agrupando Art.";
               |PINPA #0#0;
               |ABRE #0;
               |LEE 101#0p;
               |SI FSalida ! 0;    |GRABA 020#0b; |FINSI;
               |PINDA #0#0;
               |ENDATOS #1#0;
               |SI FSalida = 0;
                    |ABRE #1;
                    |ABRE #3;
                    |ABRE #7;
                    |BUCLE facturas;
                    |CIERRA #7;
                    |CIERRA #1;
                    |CIERRA #3;
                    |SI sw = 1;
                         |HAZ Imprime;
                    |FINSI;
                    |GRABA 020#0a;
               |FINSI;
               |CIERRA #0;
          |FINSI;
     |SINO;    || eaFichero ! ""
          |ABRE #0;
          |LEE 101#0p;
          |SI FSalida ! 0;    |GRABA 020#0b; |FINSI;

          |ABRE #1;
          |ABRE #3;
          |ABRE #7;
          |NOME_DAT #134 eaFichero;
          |BUCLE tempo134;
          |CIERRA #7;
          |CIERRA #3;
          |CIERRA #1;
          |SI sw = 1;
               |HAZ Imprime;
          |FINSI;
          |CIERRA #0;
     |FINSI;

     Tempo = aTmp1; |HAZ BoraTempo;  |DELINDEX #1;
     Tempo = aTmp18; |HAZ BoraTempo;  |DELINDEX #18;
|FPRO;
