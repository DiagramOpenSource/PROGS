/*
ABDON: dscomer9/con00666 (ejemplo enlace contagen y agicont)
CAROL: contalap/clapz003 (ejemplo enlace contagen y agicont)

|FICHEROS;
     tlfz0004 #0;    || tlfz0002
     tlfm0020 #19;   || tlfm0019

     tlfw0012 #9;    || encocuen -> trabajo
     encoemp5@ #30;  || para agicont

     caenlace@ #31; || para contagen

     canempr@ #1;
     calibro@ #3;

     caconasi@;

     tlfw0011 #11; ||Tmp

     tlfm0021 #4;  || agifa140 path
     agifa501 #501;
     agifa512 #512;
     agifa513 #513;
     agifa142 #142;
     agifa505 #505;

     tlfm0022 #174; || agifa174
     agifa024 #24;
|FIN;

|VARIABLES;
     &PRMNT_enVer   = 0;

     nDocum = 0;
     aSwAgicont = "";
     nError     = 0;
     sub_prog = "";
     empresa = "";
     anyo = "";
     cuenta_des = "";
     emp        = "";
     dir_fich = "";
     dir_fich2  = "";
     nombre     = "";
     nombre1    = "";
     docum      = 0;
     num        = 0;
     num1       = 0;

     nHay = 0;
     aAlfa = "";
     aDef1 = "";
     aDef3 = "";
     aDef4 = "";
     aDef5 = "";
     aDef6 = "";
     aPath = "";
     aMensa = "";
     nAsiento = 0;
     nLinea = 0;
     fFecha = @;
     aDef = "";
|FIN;

|PROCESO tlfm0022;
     |DDEFECTO #19;
     #19#0 = #174#20;
     |LEE 000#19=;

     |DDEFECTO #24;
     #24#0 = #174#4;
     |LEE 000#24=;

     |DDEFECTO #11;
     #11#0 = #174#21; ||Fecha
     #11#1 = "C";         ||Tipo
     #11#2 = #174#0; ||Ser
     #11#3 = #174#1;  ||Num
     #11#4 = #174#9 + #174#11;  ||Imp
     aAlfa = "COBRO FRA N:" + #11#2 + "/" + #11#3;
     #11#5 = aAlfa;   ||Des
     #11#6 = #24#16;  ||Cta
     #11#7 = "H";
     #11#8 = #19#2;   ||Nivel
     |GRABA 020#11n;

     |DDEFECTO #11;
     #11#0 = #174#21; ||Fecha
     #11#1 = "";      ||Tipo
     #11#2 = "";      ||Ser
     #11#3 = "";      ||Num
     |LEE 101#11=;
     |SI FSalida ! 0; |GRABA 020#11b; |FINSI;

     #11#4 = #11#4 + #174#9 + #174#11; ||Imp
     #11#5 = "CIERRE CAJA";  ||Des
     #11#6 = #19#1;          ||Cta
     #11#7 = "D";
     #11#8 = #19#2;          ||Nivel
     |GRABA 020#11a;
     |LIBERA #11;

     #174#10 = "S";
     |GRABA 020#174a;
     |LIBERA #174;
|FPRC;

|DEFBUCLE tlfm0022;
     #174#2;
     10;
     #0#8, #0#4, "N";
     #0#9, #0#5, "N";
     be;
     NULL, tlfm0022;
|FIN;

|PROCESO CobrosSematel;
     |ABRE #174;
     |ABRE #24;
     |BUCLE tlfm0022;
     |CIERRA #24;
     |CIERRA #174;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴

|PROCESO Tmp;  || encoemp5  para agicont
     nHay = 1;

     |SI fFecha ! #11#0; |O nLinea = 0;
          nAsiento = nAsiento + 1;
          docum = docum + 1;
          fFecha = #11#0;
     |FINSI;
     nLinea = nLinea + 1;

     |DDEFECTO #30;
     #30#0 = #0#3;
     #30#1 = #11#0;       ||Fecha
     #30#2 = docum;
     #30#3 = nAsiento;    ||Asiento
     #30#4 = nLinea;
     #30#11 = #11#7;     ||signo
     |SI #30#11 = "D";
          #30#5 = #11#6;   ||CUENTA DEBE
          #30#7 = #11#8;  ||NIVEL CUENTA DEBE
     |SINO;
          #30#6 = #11#6;   ||cuenta haber
          #30#8 = #11#8;  ||nivel debe
     |FINSI;
     #30#9  = 1;         ||concepto
     #30#10 = #11#5;     ||descripcion concepto
     #30#12 = #11#4;     ||importe
     #30#13 = "R";       ||Soportado/repercutido
     #30#14 = 1;         ||libro
     #30#45 = #0#1;
     #30#46 = #0#2;
     |GRABA 021#30n;
     |LIBERA #30;
|FPRC;

|DEFBUCLE Tmp;
     #11#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Tmp;
|FIN;

|PROCESO Contador;
     aAlfa = aPath + "fich/" + (("00000" + #0#1) % -105) + #0#2 + "/";
     |PATH_DAT #caconasi@#aAlfa#;
     |ABRE #caconasi@;
     |LEE 101#caconasi@.p;
     |SI FSalida ! 0;
          |DDEFECTO #caconasi@;
          |GRABA 020#caconasi@.b;
     |FINSI;
     #caconasi@#1 = #caconasi@#1 + 1;
     nDocum = #caconasi@#1;
     |GRABA 020#caconasi@.a; |LIBERA #caconasi@;
     |CIERRA #caconasi@;
|FPRC;

|PROCESO Tmp1; || caenlace para contagen
     nHay = 1;

     |SI fFecha ! #11#0; |O nLinea = 0;
          |HAZ Contador;
          nLinea = 0;
          nAsiento = nDocum;
          fFecha = #11#0;
     |FINSI;


     nLinea = nLinea + 1;
     |DDEFECTO #31;
     #31#0 = #0#3;
     #31#1 = #11#0;
     #31#2 = nAsiento;
     #31#3 = nLinea;

     #31#4 = #11#6;
     #31#5 = #11#8;
     #31#6  = 1;
     #31#7 = #11#5;
     #31#8 = #11#7;
     #31#9 = #11#4;
     #31#10 = "R";
     #31#11 = 1;

     #31#37 = #0#1;
     #31#38 = #0#2;
     |GRABA 020#31n;
     |LIBERA #31;

|FPRC;

|DEFBUCLE Tmp1;
     #11#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Tmp1;
|FIN;

|PROCESO DesCargaDef;
     |SI aDef6 ! ""; |DESCARGA_DEF #caconasi@; |FINSI;
     |SI aDef5 ! ""; |DESCARGA_DEF #caenlace@; |FINSI;
     |SI aDef4 ! ""; |DESCARGA_DEF #encoemp5@; |FINSI;
     |SI aDef3 ! ""; |DESCARGA_DEF #calibro@; |FINSI;
     |SI aDef1 ! ""; |DESCARGA_DEF #canempr@; |FINSI;
|FPRC;

|PROCESO CargaDef;
     aDef1 = aPath + "def/canempre";
     |CARGA_DEF aDef1, canempr@;
     |SI FSalida ! 0;
          aMensa = "0000Error al cargar:" + aDef1;
          |MENAV aMensa;
          aDef1 = "";
     |FINSI;

     aDef3 = aPath + "def/calibros";
     |CARGA_DEF aDef3, calibro@;
     |SI FSalida ! 0;
          aMensa = "0000Error al cargar:" + aDef3;
          |MENAV aMensa;
          aDef3 = "";
     |FINSI;

     aDef4 = aPath + "def/encoemp5";
     |CARGA_DEF aDef4, encoemp5@;
     |SI FSalida ! 0;
          aDef4 = "";
     |FINSI;

     aDef5 = aPath + "def/caenlace";
     |CARGA_DEF aDef5, caenlace@;
     |SI FSalida ! 0;
          aDef5 = "";
     |FINSI;

     aDef6 = aPath + "def/caconasi";
     |CARGA_DEF aDef6, caconasi@;
     |SI FSalida ! 0;
          aDef6 = "";
     |FINSI;
|FPRC;

|PROCESO Empresa; |TIPO 0;
     |SI FSalida = 2; |ACABA; |FINSI;
     empresa = #0#1;
     empresa = "00000" + empresa;
     empresa = empresa % -105;
     anyo = #0#2;
     anyo = "0" + anyo;
     anyo = anyo % -101;
     empresa = empresa + anyo;
     dir_fich = aPath + "fich/";
     |PATH_DAT #1 dir_fich;
     |ABRE #1;
     #1#2 = #0#1;
     #1#3 = #0#2;
     |LEE 040#1=;
     |SI FSalida ! 0;
          |MENAV "      No existe Empresa Contable";
          |ERROR;
     |SINO;
          aAlfa = aPath + "fich/" + empresa +  "/";
          |PATH_DAT #3aAlfa;
     |FINSI;
     |CIERRA #1;
|FPRC;

|PROCESO Tiquets;
     #19#0 = #501#12;
     |LEE 020#19=;

     |DDEFECTO #11;
     #11#0 = #501#14; ||Fecha
     #11#1 = #501#35; ||Tipo
     #11#2 = #501#57; ||Ser
     #11#3 = #501#58; ||Num
     #11#4 = #501#38; ||Imp
     aAlfa = "Cobrado " + #11#1 + ":" + #11#2 + "/" + #11#3;
     #11#5 = aAlfa;   ||Des
     #11#6 = #501#65; ||Cta
     #11#7 = "H";
     #11#8 = #19#2;   ||Nivel
     |GRABA 020#11n;


     |DDEFECTO #11;
     #11#0 = #501#14; ||Fecha
     #11#1 = "";      ||Tipo
     #11#2 = "";      ||Ser
     #11#3 = "";      ||Num
     |LEE 101#11=;
     |SI FSalida ! 0; |GRABA 020#11b; |FINSI;

     #11#4 = #11#4 + #501#38; ||Imp
     #11#5 = "CIERRE CAJA";   ||Des
     #11#6 = #19#1;           ||Cta
     #11#7 = "D";
     #11#8 = #19#2;           ||Nivel
     |GRABA 020#11a;
     |LIBERA #11;

     #501#6 = "S";
     |GRABA 020#501a;
     |LIBERA #501;
|FPRC;

|DEFBUCLE Tiquets;
     #agifa501#1;
     12,14,6;
     "  ", 000001,#0#8,#0#4,"N";
     "zz", 999999,#0#9,#0#5,"N";
     be;
     NULL,Tiquets;
|FIN;

|PROCESO Cobros;
     #19#0 = #513#5;
     |LEE 020#19=;

     |DDEFECTO #11;
     #11#0 = #513#11; ||Fecha
     #11#1 = "C";     ||Tipo
     #11#2 = #513#14; ||Ser
     #11#3 = #513#0;  ||Num
     #11#4 = #513#4;  ||Imp
     #11#5 = #513#3;  ||Des
     #11#6 = #513#2;  ||Cta
     #11#7 = "H";
     #11#8 = #19#2;   ||Nivel
     |GRABA 020#11n;

     |DDEFECTO #11;
     #11#0 = #513#11; ||Fecha
     #11#1 = "";      ||Tipo
     #11#2 = "";      ||Ser
     #11#3 = "";      ||Num
     |LEE 101#11=;
     |SI FSalida ! 0; |GRABA 020#11b; |FINSI;

     #11#4 = #11#4 + #513#4; ||Imp
     #11#5 = "CIERRE CAJA";  ||Des
     #11#6 = #19#1;          ||Cta
     #11#7 = "D";
     #11#8 = #19#2;          ||Nivel
     |GRABA 020#11a;
     |LIBERA #11;

     #513#15 = "S";
     |GRABA 020#513a;
     |LIBERA #513;
|FPRC;

|DEFBUCLE Cobros;
     #agifa513#1;
     12,5,11,15;
     "  ", 000001,"E",#0#8,#0#4, "N";
     "zz", 999999,"E",#0#9,#0#5, "N";
     be;
     NULL,Cobros;
|FIN;

|PROCESO Pagos;
     #19#0 = #512#5;
     |LEE 020#19=;

     |DDEFECTO #11;
     #11#0 = #512#11; ||Fecha
     #11#1 = "P";     ||Tipo
     #11#2 = #512#12; ||Ser
     #11#3 = #512#0;  ||Num
     #11#4 = #512#4;  ||Imp
     #11#5 = #512#3;  ||Des
     #11#6 = #512#2;  ||Cta
     #11#7 = "D";
     #11#8 = #19#2;   ||Nivel
     |GRABA 020#11n;

     |DDEFECTO #11;
     #11#0 = #512#11; ||Fecha
     #11#1 = "";      ||Tipo
     #11#2 = "";      ||Ser
     #11#3 = "";      ||Num
     |LEE 101#11=;
     |SI FSalida ! 0; |GRABA 020#11b; |FINSI;

     #11#4 = #11#4 - #512#4; ||Imp
     #11#5 = "CIERRE CAJA";   ||Des
     #11#6 = #19#1;           ||Cta
     #11#7 = "D";
     #11#8 = #19#2;           ||Nivel
     |GRABA 020#11a;
     |LIBERA #11;

     #512#13 = "S";
     |GRABA 020#512a;
     |LIBERA #512;
|FPRC;

|DEFBUCLE Pagos;
     #agifa512#1;
     5,11, 13;
     "  ", 000001,#0#8,#0#4, "N";
     "zz", 999999,#0#9,#0#5, "N";
     be;
     NULL,Pagos;
|FIN;


|PROCESO des_cuen;
     #9#0 = 1;      ||Codigo
     cuenta_des = #30#5;
     |QBT cuenta_des;
     |SI cuenta_des = "";
          #9#1 = #30#6;
          #9#2 = #30#8;
          #9#4 = "H";
     |SINO;
          #9#1 = #30#5;  ||Cuenta
          #9#2 = #30#7;  ||DC
          #9#4 = "D";    ||signo
     |FINSI;
     #9#3 = #30#1;       ||fecha
     #9#5 = 0;           ||Importe
     #9#6 = #30#0;       ||DIARIO
     |LEE 101#9];
     |SI FSalida = 0;
          #9#5 =#9#5 - #30#12;
     |FINSI;
     |GRABA 021#9a;
     |LIBERA #9;
|FPRC;

|PROCESO borrapasada;
     |ABRE #9;
     |LEE 001#30p;
     |PARA ; |SI FSalida = 0; |HACIENDO;
          |SI #30#47 ! 0;      ||si el nuevo documento ! 0, quiere decir que
               |HAZ des_cuen;     ||ya ha pasado a contabilidad
               |BORRA 021#30a;    ||Borro el actual
          |FINSI;
          |LEE 001#30s;
     |SIGUE;
     |CIERRA #9;
|FPRC;

|PROCESO TmpEnlace;
     |SI aSwAgicont = "N"; |ACABA; |FINSI;

     |DFICE emp;
     |QBF emp;
     emp = emp % -204;
     |DFICB dir_fich2;   |QBF dir_fich2;
     |PATH_DAT #30 dir_fich2;
     |PATH_DAT #9  dir_fich2;
     nombre = "000000" + emp;
     nombre = nombre % -104;
     nombre1 = "enco" + nombre;          ||nombre del fichero es enco+empresa
     |NOME_DAT #30  nombre1;

     nombre1 = "encu" + nombre;
     |NOME_DAT #9 nombre1;

     |ABRE #30;
     |LEE 001#30p;
     |SI FSalida=0; ||ha encontrado registros
          |AVISO;
          |CONFI "2400NYa existe un enlace de esta empresa, Desea Borrarlo : ";
          |SI FSalida = 0;
               |CIERRA #30;
               |DELINDEX #30;
               |DELINDEX #9;
             docum = 1;
          |SINO;
               |HAZ borrapasada;
               num = 0;
               |LEE 001#30p;
               |PARA ; |SI FSalida = 0; |HACIENDO;
                    num1 = #30#2;
                    |SI num1 ] num; docum = #30#2; num = num1; |FINSI;
                    |LEE 001#30s;
               |SIGUE;
               docum = docum + 1;
          |FINSI;
     |FINSI;
     |CIERRA #30;
|FPRC;

|PROCESO CheqCta;
     #19#0 = #505#0;
     |LEE 000#19=;
     aAlfa = #19#1; |QBF aAlfa;
     |SI FSalida ! 0; |O aAlfa = "";
          aAlfa = "0000Cta Caja: [" + #19#0 + "] no definida";
          |MENAV aAlfa;
          nError = 1;
     |FINSI;
|FPRC;

|DEFBUCLE CheqCta;
     #505#1;
     ;
     #0#8;
     #0#9;
     ;
     NULL, CheqCta;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #19;
     |BUCLE CheqCta;
     |CIERRA #19;
     |SI nError = 0;
          |HAZ TmpEnlace;
          aAlfa = Usuario;
          |NOME_DAT #11 aAlfa;
          |DELINDEX #11;

          |ABRE #19;
          |ABRE #11;
          |BUCLE Tiquets;
          |BUCLE Cobros;
          |BUCLE Pagos;

          |HAZ CobrosSematel;

          |CIERRA #11;
          |CIERRA #19;

          |SI aSwAgicont = "S";
               |ABRE #30;
               |BUCLE Tmp;
               |CIERRA #30;

               |SI nHay ! 0; |Y #142#23 = "S";
                    aAlfa = (("00000" + #0#1) % -105) + #0#2;
                    sub_prog = ":agicont/impgest5.run canempr1 " + aAlfa;
                    |SUB_EJECUTA_NP sub_prog;
               |FINSI;
          |SINO;
               nombre1 = "pu" + Usuario;
               |NOME_DAT #31 nombre1;
               aAlfa = aPath + "fich/" + (("00000" + #0#1) % -105) + #0#2 + "/";
               |PATH_DAT #31 aAlfa;
               |DELINDEX #31;

               |ABRE #31;
               |BUCLE Tmp1;
               |CIERRA #31;

               |SI nHay ! 0;
                   |HAZ CogeVersion;
                   || aAlfa = aPath + "fich/" + (("00000" + #0#1) % -105) + #0#2 + "/"
                    sub_prog = ":contagen/dsapunte.tab;" + aAlfa;
                    sub_prog = sub_prog + "," + nombre1;
                    |SUB_EJECUTA_NP sub_prog;
               |FINSI;
               |DELINDEX #31;
          |FINSI;
          |DELINDEX #11;
     |FINSI;
|FPRC;

|PROGRAMA;
     |ABRE #142;|LEE 000#142p; |CIERRA #142;

     |ABRE #4; |LEE 040#4p; |CIERRA #4;
     aPath = #4#1; |QBF aPath;

     aAlfa = aPath - "agicont";
     |SI FSalida ! 0;
          aSwAgicont = "S";
     |SINO;
          aSwAgicont = "N";
     |FINSI;

     |HAZ CargaDef;
     |SI aDef1 ! ""; |Y aDef3 ! "";
          |CLS;
          |ABRE #0;
          |LEE 101#0p;
          |SI FSalida ! 0; |GRABA 020#0b; |FINSI;
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
          |SI FSalida = 0;
               |GRABA 020#0a;
          |FINSI;
          |CIERRA #0;
     |SINO;
          |MENAV "0000Control Directorio ERRONEO";
     |FINSI;
     |HAZ DesCargaDef;
|FPRO;
*/
