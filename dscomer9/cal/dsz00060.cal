|FICHEROS;
     dsz00060 #0;
     agifa134 #134;
     agifa059 #59;
     agifa010 #10;
     agifa071 #71;
|FIN;

|VARIABLES;
     &nDeci_BaseMx = 0;
     &aDivisa = "";
     &aMoneda = "";
     nBase = 0;
     nLin = 0;
     nLinAlb = 0;
     nPre = 0;
     nDife = 0;
     aSerAlb = "";
     nNumAlb = 0;
     nTotalFac = 0;
     nLinFac = 0;
|FIN;

|PROCESO UltLinea;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = 999;
     |LEE 000#71];
     |SI FSalida = 0;
          |LEE 000#71a;
     |SINO;
          |LEE 000#71u;
     |FINSI;
     |SI FSalida = 0; |Y #71#29 = #10#52;  |Y #71#0 = #10#0;
          nLinAlb = #71#1 + 1;
     |SINO;
          nLinAlb = 1;
     |FINSI;
|FPRC;

|PROCESO CreaLinAlb;
     #10#52 = aSerAlb;
     #10#0 = nNumAlb;
     |LEE 101#10=;
     |SI FSalida = 0;
          aDivisa = #10#68;
          aMoneda = #10#70;
          |HAZ Divisas010;

          |HAZ UltLinea;
          |DDEFECTO #71;
          #71#29 = #10#52;
          #71#0 = #10#0;
          #71#1 = nLinAlb;
          #71#5 = 1;
          #71#6 = nPre;
          |HAZ TotalLin71;
          |GRABA 020#71n;

          |HAZ LimCabAgifa010;
          |BUCLELIN 0 CalCabAgifa010 #10;
          |GRABA 020#10a;
          |LIBERA #10;
     |FINSI;
|FPRC;

|PROCESO agifa134F;
     |SI nLin ! 1; |Y nTotalFac ! #134#31;
          nDife = #134#31 - nTotalFac;
          nPre = nDife / 1.16;
          |HAZ CreaLinAlb;
          |ABRE #59;
          #59#14 = #134#49;
          #59#0 = #134#0;
          #59#1 = nLinFac;
          |LEE 121#59=;
          |SI FSalida = 0;
               |GRABA 020#59a;
               #59#3 = #10#15; ||Bruto
               #59#8 = #10#19; ||Base2
               #59#10 = #10#24; ||T.Iva
               #59#11 = #10#67; ||Total
               #59#13 = #10#19; ||T.Base

               #59#21 = #10#15; ||Bruto
               #59#24 = #10#19; ||Base
               #59#25 = #10#24; ||T.Iva
               #59#26 = #10#67; ||Total

               #59#27 = #10#15; ||Bruto
               #59#30 = #10#19; ||Base
               #59#31 = #10#24; ||T.Iva
               #59#32 = #10#67; ||Total

               #59#33 = #10#15; ||Bruto
               #59#36 = #10#19; ||Base
               #59#37 = #10#24; ||T.Iva
               #59#38 = #10#67; ||Total
               |LIBERA #59;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO agifa059;
     |SI nLin = 1;
          #59#3 = #134#18; ||Bruto
          #59#8 = #134#24; ||Base2
          #59#10 =  #134#29; ||T.Iva
          #59#11 = #134#31; ||Total
          #59#13 = #134#24; ||T.Base

          #59#21 = #134#18; ||Bruto
          #59#24 = #134#24; ||Base
          #59#25 =  #134#29; ||T.Iva
          #59#26 = #134#31; ||Total

          #59#27 = #134#18; ||Bruto
          #59#30 = #134#24; ||Base
          #59#31 =  #134#29; ||T.Iva
          #59#32 = #134#31; ||Total

          #59#33 = #134#18; ||Bruto
          #59#36 = #134#24; ||Base
          #59#37 =  #134#29; ||T.Iva
          #59#38 = #134#31; ||Total
          |GRABA 020#59a;
          |LIBERA #59;

          #10#52 = #59#15;
          #10#0 = #59#2;
          |LEE 101#10=;
          |SI FSalida = 0;
               aDivisa = #10#68;
               aMoneda = #10#70;
               |HAZ Divisas010;
               |SI #59#32 ! #10#67; ||Total Albaran
                    nDife = #59#32 - #10#67;
                    nPre = nDife / 1.16;
                    aSerAlb = #10#52;
                    nNumAlb = #10#0;
                    |HAZ CreaLinAlb;
               |FINSI;
          |FINSI;
          |LIBERA #10;
     |SINO;              || Mas de 1 albaran
          |DDEFECTO #10;
          #10#52 = #59#15;
          #10#0 = #59#2;
          |LEE 000#10=;
          nTotalFac = (nTotalFac + #10#67) ! nDeci_BaseMx;

          #59#3 = #10#15; ||Bruto
          #59#8 = #10#19; ||Base2
          #59#10 = #10#24; ||T.Iva
          #59#11 = #10#67; ||Total
          #59#13 = #10#19; ||T.Base

          #59#21 = #10#15; ||Bruto
          #59#24 = #10#19; ||Base
          #59#25 = #10#24; ||T.Iva
          #59#26 = #10#67; ||Total

          #59#27 = #10#15; ||Bruto
          #59#30 = #10#19; ||Base
          #59#31 = #10#24; ||T.Iva
          #59#32 = #10#67; ||Total

          #59#33 = #10#15; ||Bruto
          #59#36 = #10#19; ||Base
          #59#37 = #10#24; ||T.Iva
          #59#38 = #10#67; ||Total
          |GRABA 020#59a;
          |LIBERA #59;
          aSerAlb = #10#52;
          nNumAlb = #10#0;
          nLinFac = #59#1;
     |FINSI;
|FPRC;

|PROCESO CuentaLin;
     nLin = nLin + 1;
|FPRC;

|PROCESO agifa134;
     aDivisa = #134#58;
     aMoneda = #134#60;
     |HAZ Divisas134;
     |SI #134#18 = #134#24; |ERROR; |ACABA; |FINSI;

     nBase = #134#31 / 1.16;

     #134#18 = nBase; ||Bruto
     #134#24 = nBase; ||T.Base
     #134#25 = #134#31 - #134#24; ||Cuota iva2
     #134#29 = #134#25; || T.IVA

     #134#65 = #134#18;
     #134#71 = #134#24;
     #134#72 = #134#25;
     #134#76 = #134#29;

     #134#88 = #134#18;
     #134#94 = #134#24;
     #134#95 = #134#25;
     #134#99 = #134#29;
     |GRABA 020#134a;
     |LIBERA #134;
     nLin = 0;
     nTotalFac = 0;
     |BUCLELIN 2CuentaLin#134;
|FPRC;

|DEFBUCLE agifa134;
     #134#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, agifa134, agifa059, agifa134F;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |SI #0#0 = "SI";
          |ABRE #10;
          |ABRE #71;
          |BUCLE agifa134;
          |CIERRA #71;
          |CIERRA #10;
     |FINSI;
|FPRC;
