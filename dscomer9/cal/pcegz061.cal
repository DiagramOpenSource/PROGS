|FICHEROS;
     pcegz061 #0;
     pcegm004 #4;
     pcegm038 #38;
     agifa059 #59;
     agifa071 #71;
     agifa134 #134;
     agifa142 #142;
     pcegm027 #27;
|FIN;

|VARIABLES;
     &eaImprime = "";
     &ser_fac = "";
     &num_fac = 0;
     &reimp = "";
     &eaOrdenado = "";
     aMail = "";
     aAlfa = "";
     aFic = "";
     aDjunto = "";
     aIPRemoto = "";
     aDes = "";
     aNomFic = "";
     aTo = "";
     aIP = "";
     aServidor = "";
     aFrom = "";
     aSubject = "";
     aAsunto = "";
     aMensaje = "";
     aCuerpo = "";
     CRLF = "";
     i = 0;
     nHandle = 0;
|FIN;

|PROCESO Envialo;
     aDjunto = aFic;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;
     |SI aIPRemoto ! "";
          |DFICE aDes;
          aDes = aDes + aNomFic;
          |RECIBE_FICHERO aFic, aDes;
          aDjunto = aDes;

          |RFBORRA aFic;
     |FINSI;
     aIP = #38#2; |QBF aIP;
     aServidor = #38#1; |QBF aServidor;
     aTo = aMail;
     aFrom = #38#3; |QBF aFrom;
     aSubject = aAsunto;
     aMensaje = "$$$$" + aCuerpo;
     |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
|FPRC;

|PROCESO EnviaMail;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;
     aNomFic = #134#49+"_"+(("000000"+#134#0)%-106)+ ".pdf"; |QBT aNomFic;
     |DBASS aFic;
     |SI aIPRemoto = "";
          |MKDIR "c:\dsmail\";
     |SINO;
          |RMKDIR "c:\dsmail\";
     |FINSI;

     aFic = "c:\dsmail\" + aNomFic;

     eaImprime = "CrystalReport;" + aFic;
     ser_fac = #134#49;
     num_fac = #134#0;
     reimp = #134#45;
     eaOrdenado = #142#141;
     |SUB_EJECUTA_NP "agifa136";

     aAsunto = "Factura nº: " + #134#49 + "/" + (("000000" + #134#0) % -106);
     |HAZ Envialo;
|FPRC;

|PROCESO LeePedido;
     aMail = "";
     |ABRE #59;
     #59#14 = #134#49;
     #59#0 = #134#0;
     #59#1 = 1;
     |LEE 000#59];
     |SI FSalida = 0; |Y #59#14 = #134#49; |Y #59#0 = #134#0;
          |ABRE #71;
          #71#29 = #59#15;
          #71#0 = #59#2;
          #71#1 = 1;
          |LEE 000#71];
          |SI FSalida = 0; |Y #71#29 = #59#15; |Y #71#0 = #59#2;
               |ABRE #4;
               #4#25 = #71#31;
               #4#0 = #71#12;
               |LEE 000#4=;
               |SI FSalida = 0;
                    aMail = #4#71; |QBF aMail;
               |FINSI;
               |CIERRA #4;
          |FINSI;
          |CIERRA #71;
     |FINSI;
     |CIERRA #59;
|FPRC;

|PROCESO Facturas;
     |HAZ LeePedido;
     |SI aMail ! "";
          |HAZ EnviaMail;
     |FINSI;
|FPRC;

|DEFBUCLE Facturas;
     #134#3;
     ;
     "      ", #0#0, "     ", 000001;
     "zzzzzz", #0#0, "zzzzz", 999999;
     ;
     NULL, Facturas;
|FIN;

|PROCESO LineaTexto;
     aAlfa = #27#2; |QBF aAlfa;
     |ANSI_OEM aAlfa, aAlfa;
     aAlfa = aAlfa + CRLF;
     |XGRABA nHandle, aAlfa;
|FPRC;

|DEFBUCLE LineaTexto;
     #27#1;
     ;
     #0#1, 1;
     #0#1, 99;
     ;
     NULL, LineaTexto;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     |ABRE #38; |LEE 000#38p; |CIERRA #38;

     CRLF = &13; CRLF = CRLF + &10;
     |DFICE aCuerpo;
     aCuerpo = aCuerpo + Usuario;
     |XABRE "W", aCuerpo, nHandle;
     |SI FSalida ] 0;
          |BUCLE LineaTexto;
          |XCIERRA nHandle;
     |FINSI;

     aAlfa = #38#1 + #38#2 + #38#3; |QBT aAlfa;
     |SI aAlfa = "";
          |MENAV "0000Parametros envio facturas no configurado...";
     |SINO;
          |BUCLE Facturas;
     |FINSI;

     |FBORRA aCuerpo;
|FPRC;
