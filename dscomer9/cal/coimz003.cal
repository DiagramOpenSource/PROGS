|FICHEROS;
     coimz003 #0;
     coimw004 #1,MANTE;
     coima002 #2;
     coima003 #3;
     coima001 #10;
     coima011 #11;
     coima012 #12;
     coima029 #29;
     coima027 #27;
     agifa074 #74;
     agifa112 #112;
     agifa142 #142;
     agifa048 #148;
     tempo134 #134;
|FIN;

|VARIABLES;
     &Tempo = "";
     &enTipo = 0;
 {-1}aMenu = "";
     aMenu1 = "2400";
     aMenu2 = "1";
     aMenu3 = "Opciones:";
     aMenu4 = "RAC";
     aMenu5 = " Repasar ";
     aMenu6 = " Aceptar ";
     aMenu7 = " Cancelar ";
     nInicial = 0;
     nTecla = 0;
     aAlfa = "";
     nHay = 0;
     nProceso = 0;
     nFecha = 0;
     aPrv = "";
     nConta = 0;
     nLin = 0;
     nNum1 = 0;
     nNum2 = 0;
     fHoy = @;
     nDias = 0;
     nPrime = 0;
|FIN;

|PROCESO Existe; |TIPO 0;
     |ABRE #11;
     #11#0 = #0#0;
     |LEE 000#11=;
     |SI FSalida = 0;
          |MENAV "0000Operación existente...";
          |ERROR;
     |FINSI;
     |CIERRA #11;
|FPRC;

|PROCESO Min2;
     #2#0 = #0#2;
     #2#1 = 0;
|FPRC;

|PROCESO Max2;
     #2#0 = #0#2;
     #2#1 = 99;
|FPRC;

|PROCESO Tipo66; |TIPO 66;
     |ABRE #2;
     #2#0 = #0#2;
     #2#1 = #0#3;
     |LEE 000#2];
     |CONSULTA_F_CLAVE #1#2, Min2, Max2;
     |SI FSalida = 0;
          #0#3 = #2#1; |PINTA #0#3;
     |SINO;
          |ERROR;
     |FINSI;
     |CIERRA #2;
|FPRC;

|PROCESO Contador; |TIPO 7;
     |SI #0#0 = 0;
          |ABRE #11;
          |LEE 000#11u;
          |SI FSalida = 0;
               #0#0 = #11#0 + 1;
          |SINO;
               #0#0 = 1;
          |FINSI;
          |CIERRA #11;
     |FINSI;
|FPRC;
-----------------------------------------------
|PROCESO MaxUni; |TIPO 0;
     |SI #1#12 < #1#11;
          #1#17 = "N";
          |AVISO;
          |CONFI "0000NDespreciar unidades restantes?";
          |SI FSalida = 0;
               #1#17 = "S";
          |FINSI;
          |GRABA 020#1a;
     |FINSI;
|FPRC;

|PROCESO Tecla; |TIPO 0;
     |SI #1Campo = Contenido; |Y FSalida = 0;
          |SI #1#15 = "*";
               #1#12 = 0;
               #1#13 = 0;
               #1#14 = "01.01.0000";
               #1#15 = "";
               |GRABA 020#1a;
          |SINO;
            |ET E1;
               #1#12 = #1#11;
               |ENCAMPO #12#1;
               |SI FSalida ! 0; |Y FSalida ! 3; |VETE Fin; |FINSI;
            |ET E2;
               #1#14 = nFecha;
               |ENCAMPO #14#1;
               |SI FSalida = 2;
                    |SI #10#0 = #0#3; |VETE E2; |SINO; |VETE E1; |FINSI;
               |FINSI;
               |SI FSalida ! 0; |Y FSalida ! 3; |VETE Fin; |FINSI;

               #1#15 = "*";
               |GRABA 020#1a;
             |ET Fin;
          |FINSI;
          |LEE 000#1=;
          |PINTA #1#12;
          |PINTA #1#13;
          |PINTA #1#14;
          |PINTA #1#15;
     |FINSI;
|FPRC;
-----------------------------------------------
|PROCESO LinProceso;
     nLin = nLin + 1;
     |DDEFECTO #12;
     #12#0 = #11#0;
     #12#1 = nLin;
     #12#2 = #1#1;
     #12#3 = #1#2;
     #12#4 = #1#3;
     #12#5 = #1#11;
     #12#6 = #1#12;
     #12#7 = #1#14;
     #12#8 = #1#4;
     #12#9 = #1#5;
     |GRABA 020#12n;
|FPRC;

|PROCESO CabProceso;
     nLin = 0;
     |SI nPrime = 0;
          nPrime = 1;
          nConta = #0#0;
     |SINO;
          |LEE 000#11u;
          |SI FSalida = 0;
               nConta = #11#0 + 1;
          |SINO;
               nConta = 1;
          |FINSI;
     |FINSI;
     |DDEFECTO #11;
     #11#0 = #0#0;
     #11#1 = #0#3;
     #11#2 = #0#1;
     #11#3 = #0#4;
     |GRABA 020#11n;

     #134#1 = #11#0;
     |GRABA 020#134n;
|FPRC;

|PROCESO AltaHisto;
     |DDEFECTO #3;
     #3#0 = "F";
     #3#1 = #12#2;
     #3#2 = #12#3;
     #3#3 = #12#4;
     #3#4 = #12#0;
     #3#5 = #12#1;
     #3#6 = #11#1;
     #3#7 = #12#6;
     #3#8 = 0;
     #3#9 = #11#2;
     #3#10 = #12#7;
     |SI #11#3 = #1#6;
          #3#11 = #1#6;
          #3#12 = #1#7;
     |SINO;
          |DDEFECTO #112;
          #112#0 = #11#3;
          |LEE 000#112=;
          #3#11 = #112#0;
          #3#12 = #112#1;
     |FINSI;
     #3#13 = #1#9;
     #3#14 = #1#10;
     #3#15 = "N";
     |GRABA 020#3n;

     |DDEFECTO #27;
     #27#0 = #3#13;
     #27#1 = #3#16;
     |LEE 101#27=;
     |SI FSalida ! 0; |GRABA 020#27b; |FINSI;
     |SI #27#2 < #1#14;
          #27#2 = #1#14;
          #27#3 = #1#12;
     |FINSI;
     nNum1 = fHoy;
     nNum2 = #1#14;
     nDias = #1#14 - fHoy;
     |SI nDias < #10#5;
          |SI #1#17 = "S";
               #27#4 = #27#4 - #1#11;
          |SINO;
               #27#4 = #27#4 + #1#12;
          |FINSI;
     |SINO;
          |SI #1#17 = "S";
               #27#5 = #27#5 - #1#11;
          |SINO;
               #27#5 = #27#5 + #1#12;
          |FINSI;
     |FINSI;
     |GRABA 020#27a;
     |LIBERA #27;
|FPRC;

|PROCESO ActHisto;
     #3#0 = #1#0;
     #3#1 = #1#1;
     #3#2 = #1#2;
     #3#3 = #1#3;
     #3#4 = #1#4;
     #3#5 = #1#5;
     |LEE 121#3=;
     |SI FSalida = 0;
          #3#8 = #3#8 + #12#6;
          |SI #3#7 = #3#8;
               #3#15 = "S";
          |SINO;
               #3#15 = "N";
          |FINSI;
          |SI #1#12 > #1#11; |O #1#17 = "S";
               #3#15 = "S";
          |FINSI;
          |GRABA 020#3a;
          |LIBERA #3;
     |FINSI;

     |DDEFECTO #27;
     #27#0 = #3#13;
     #27#1 = #3#16;
     |LEE 101#27=;
     |SI FSalida ! 0; |GRABA 020#27b; |FINSI;
     nNum1 = fHoy;
     nNum2 = #3#10;
     nDias = #3#10 - fHoy;
     |SI nDias < #10#5;
          |SI #1#17 = "S";
               #27#4 = #27#4 - #1#11;
          |SINO;
               #27#4 = #27#4 - #1#12;
          |FINSI;
     |SINO;
          |SI #1#17 = "S";
               #27#5 = #27#5 - #1#11;
          |SINO;
               #27#5 = #27#5 - #1#12;
          |FINSI;
     |FINSI;
     |GRABA 020#27a;
     |LIBERA #27;
|FPRC;

|PROCESO Tmp;
     |SI #1#15 ! "*";
          |ACABA;
     |FINSI;

     |SI #1#17 = "S"; |O #1#12 > #1#11;
          |HAZ RecalOrdenFab;
     |FINSI;

     |SI aPrv ! #1#6;
          |HAZ CabProceso;
          aPrv = #1#6;
     |FINSI;
     |HAZ LinProceso;
     |HAZ ActHisto;
     |HAZ AltaHisto;
|FPRC;

|DEFBUCLE Tmp;
     #1#2;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Tmp;
|FIN;

|PROCESO Historico;
     nInicial = 0;
     |SI #0#11 = "S";
          |SI #0#3 = 1;
               || Es el proceso normal no debe existir en coima029
               #29#0 = #3#13;
               |LEE 000#29=;
               |SI FSalida = 0; |Y #29#2 ! 1;
                    nInicial = 1;
               |FINSI;
          |SINO;
               || Proceso no inicia en 1, debe existir en coima029 y coincidir el proceso inicio.
               #29#0 = #3#13;
               |LEE 000#29=;
               |SI FSalida ! 0;
                    nInicial = 1;
               |SINO;
                    |SI  #29#2 ! #0#3;
                         nInicial = 1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #3#7 > #3#8; |Y nInicial = 0;
          nHay = 1;
          #1#0 = #3#0;
          #1#1 = #3#1;
          #1#2 = #3#2;
          #1#3 = #3#3;
          #1#4 = #3#4;
          #1#5 = #3#5;
          #1#7 = #3#12;
          |SI #0#4 ! "000000";
               #1#6 = #0#4;
               |DDEFECTO #112;
               #112#0 = #1#6;
               |LEE 000#112=;
               #1#7 = #112#1;
          |SINO;
               #1#6 = #3#11;
          |FINSI;
          #1#8 = #3#9;
          #1#9 = #3#13;
          #1#10 = #3#14;
          #1#11 = #3#7 - #3#8;
          #1#12 = 0;
          #1#13 = 0;
          #1#14 = "01.01.0000";
          #1#15 = "";
          #1#16 = #3#16;
          |GRABA 020#1n;
     |FINSI;
|FPRC;

|DEFBUCLE Historico;
     #3#1;
     11, 15, 6, 13;
     "F", #0#14, #0#16, 001, #0#8, 000, #0#6, "N", nProceso, #0#12;
     "F", #0#15, #0#17, 999, #0#9, 999, #0#7, "N", nProceso, #0#13;
     ;
     NULL, Historico;
|FIN;

|PROCESO Min;
     #1#9 = "                   ";
     #1#8 = "01.01.0000";
     #1#1 = "     ";
     #1#2 = 000000;
     #1#3 = 000;
|FPRC;

|PROCESO Max;
     #1#9 = "zzzzzzzzzzzzzzzzzzzz";
     #1#8 = "31.12.9999";
     #1#1 = "zzzzz";
     #1#2 = 999999;
     #1#3 = 999;
|FPRC;

|PROCESO ImpreEsca;
     enTipo = 2;
     |PRINT;
|FPRC;

|PROCESO ImpreLin;
     enTipo = 1;
     |PRINT;

     #74#9 = #12#2;
     #74#0 = #12#3;
     #74#1 = #12#4;
     |LEE 000#74=;
     |SI FSalida = 0;
          #148#0 = #74#2;
          |LEE 000#148=;
          |SI FSalida = 0;
               |BUCLELIN 0 ImpreEsca #148;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO tempo134;
     #11#0 = #134#1;
     |LEE 020#11=;
     |SI FSalida = 0;
          |BUCLELIN 2 ImpreLin #11;
     |FINSI;
     |PIEINF;
|FPRC;

|DEFBUCLE tempo134;
     #134#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, tempo134;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #2;
     #2#0 = #0#2;
     #2#1 = #0#3;
     |LEE 020#2=;
     |CIERRA #2;

     nFecha = #0#1;
     nFecha = nFecha + #2#3;
     |ABRE #10;
     |LEE 000#10p;
     |CIERRA #10;

     nProceso = #0#3 - 1 - #2#4;
     aAlfa = Usuario;
     |NOME_DAT #1 aAlfa;
     |DELINDEX #1;
     |ABRE #1;
     |ABRE #29;
     |ABRE #112;
     |BUCLE Historico;
     |CIERRA #112;
     |CIERRA #29;
     |CIERRA #1;
     |SI nHay ! 0;
          |PINPA #0#1;
          |PARA; |SI; |HACIENDO;
               |ENTLINEAL #3#1, 1, 4, 19, 0, Min, Max;
               |MENU aMenu;
               |SI FSalida ] 2; |SAL; |FINSI;
          |SIGUE;
          |SI FSalida = 2;
               |HAZ CreaTempo; |NOME_DAT #134 Tempo; |DELINDEX #134;
               |ABRE #112;
               |ABRE #12;
               |ABRE #11;
               |ABRE #3;
               |ABRE #27;
               |ABRE #134;
               |BUCLE Tmp;
               |CIERRA #134;
               |CIERRA #27;
               |CIERRA #3;
               |CIERRA #11;
               |CIERRA #12;
               |CIERRA #112;
               |CONFI "0000N¿Imprimir documento?";
               |SI FSalida = 0;
                    |IMPRE 0;
                    |SI FSalida = 0;
                         |INFOR "coima011";
                         |SI FSalida = 0;
                              |ABRE #11;
                              |ABRE #74;
                              |ABRE #148;
                              |BUCLE tempo134;
                              |CIERRA #148;
                              |CIERRA #74;
                              |CIERRA #11;
                              |FININF;
                         |FINSI;
                         |FINIMP;
                    |FINSI;
               |FINSI;
               |HAZ BoraTempo; |DELINDEX #134;
          |FINSI;
     |SINO;
          |MENAV "0000No hay registros...";
     |FINSI;
     |DELINDEX #1;
|FPRC;

|PROGRAMA;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |ABRE #0;
     |LEE 101#0p;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;
     |DDEFECTO #0;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |CIERRA #0;
|FPRO;
