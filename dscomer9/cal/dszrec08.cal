|FICHEROS;
     agifa104 #0;
     agifa019 #19;
     agifa073 #3;
     agifa142;
     referen@;
|FIN;

|VARIABLES;
     nSwChampiEmar = 0;
     nNume11   = 0;
     nNume7    = 0;
     &nDeci_DivP = 0;
     &nDeci_BaseMxP = 0;
     nImpo     = 0;
     nImpDiv   = 0;
     nMult     = 0;
     nImporDescue1 = 0;
     nImporDescue2 = 0;
     nImporDescue3 = 0;
     nImporMoneda1 = 0;
     nImporMoneda2 = 0;
     nBrutoMoneda1 = 0;
     nBrutoMoneda2 = 0;
     aAlfa = "";
     nPreTon = 0;
|FIN;

|CALCULO xLineasPedido;
     #3#16 = #0#7;
     #3#20 = #0#4;
     #3#23 = #0#5;
     #3#24 = #0#6;
     #3#25 = #0#17;
     #3#26 = #0#9;

     |HAZ TotalLin73;

     #0#11 = #0#11 + #3#9;
     #0#42 = #0#42 + #3#39;

     |SI #19#194 = 2;
          nImpo = ((#3#49 *#3#6)<#3#8)<#3#29;
          nImpDiv = ((#3#49*#3#38)<#3#8)<#3#29;
     |SINO;
          nImpo = ((#3#43 *#3#6)<#3#8)<#3#29;
          nImpDiv = ((#3#43*#3#38)<#3#8)<#3#29;
     |FINSI;
/*
     nImpo = (nImpo < #0#5) ! nDeci_BaseMxP;
     nImpo = (nImpo < #0#17) ! nDeci_BaseMxP;
     nImpo = (nImpo < #0#6) ! nDeci_BaseMxP;

     nImpDiv = (nImpDiv < #0#5) ! nDeci_DivP;
     nImpDiv = (nImpDiv < #0#17) ! nDeci_DivP;
     nImpDiv = (nImpDiv < #0#6) ! nDeci_DivP;
*/
     nBrutoMoneda1 = nImpo;
     nImporDescue1 = (nBrutoMoneda1 % #0#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #0#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #0#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     nImpo = nBrutoMoneda1;

     nBrutoMoneda2 = nImpDiv;
     nImporDescue1 = (nBrutoMoneda2 % #0#5) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #0#17) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #0#6) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     nImpDiv = nBrutoMoneda2;

     #0#13 = #0#13 + nImpo;
     #0#44 = #0#44 + nImpDiv;

     #0#12 = #0#11 - #0#13;
     #0#43 = #0#42 - #0#44;

     |SI #0#37 = "D";
          #0#45 = #0#42;
          #0#46 = #0#43;
          #0#47 = #0#44;
          #0#48 = #0#11;
          #0#49 = #0#12;
          #0#50 = #0#13;
     |SINO;
          #0#45 = #0#11;
          #0#46 = #0#12;
          #0#47 = #0#13;
          #0#48 = #0#42;
          #0#49 = #0#43;
          #0#50 = #0#44;
     |FINSI;
     #0#63 = #0#63 + #3#54;
     |SI #3#55 = -1;
          #0#65 = #0#65 + #3#9;    ||Canon
     |FINSI;
     |GRABA 020#3a;
     |LIBERA #3;
|FCAL;

|DEFBUCLE xLineasPedido;
     #3#1;
     ;
     #0#25, #0#0, 001;
     #0#25, #0#0, 999;
     be;
     NULL, xLineasPedido;
|FIN;

|PROCESO CalCabAgifa104;
     |HAZ EsChampiEmar; nSwChampiEmar = FSalida;

     |ABRE #agifa142; |LEE 000#agifa142.p; |CIERRA #agifa142;
     |ABRE #19;
     #0#11 = 0;
     #0#12 = 0;
     #0#13 = 0;
     #0#42 = 0;
     #0#43 = 0;
     #0#44 = 0;
     #0#63 = 0;
     #0#65 = 0;
     |BUCLE xLineasPedido;
     |SI nSwChampiEmar = 0;
          |HAZ ChampiEmarPortes;
     |FINSI;
     |GRABA 021#0a;
     |CIERRA #19;
|FPRC;

|PROCESO TotalLin73;
     |DDEFECTO #19;
     |ABRE #19;
     #19#0 = #3#2;
     |LEE 000#19=;
     |CIERRA #19;

     nPreTon = 1;
     |HAZ EsVigor;
     |SI FSalida = 0;
          aAlfa = #19#110; |QBF aAlfa;   || Alfanumerico1
          aAlfa = aAlfa > "";
          |SI aAlfa = "S"; nPreTon = 1000; |FINSI;
     |FINSI;

     #3#54 = #19#208 * #3#5; ||Punto Verde

     |SI #0#37 = "D";                    || Si la moneda de trabajo es la divisa ...
          #3#6  = #3#38 / #0#36 * #0#41;  || ... recalculo precio en funcion de la divisa
          #3#40 = #3#6;                  || ... el campo visualiz. es el precio en moneda base
     |SINO;
          #3#38 = #3#6 / #0#41 * #0#36;  || .. recalculo precio en funcion de la moneda base
          #3#40 = #3#38;                 || ... el campo visual. es el precio en divisa
     |FINSI;

     |SI #19#194 = 2;                     || Unidades de facturacion
          nImpo = #3#44 * #3#6;
     |SINO;
          nImpo = #3#5 * #3#6;
     |FINSI;

     || nMult corrige el error del redondeo para negativos
     |SI nImpo < 0; nMult = -1; |SINO; nMult = 1; |FINSI;

     |SI #19#194 = 2;                     || Unidades de facturacion
          nNume7  = ((#3#44 * #3#6 / nPreTon) ! nDeci_BaseMxP)  * nMult;
          nImpDiv = ((#3#44 * #3#38 / nPreTon) ! nDeci_DivP) * nMult;
          nNume11 = (#3#44 - #3#49) * #3#6 * nMult / nPreTon;
     |SINO;
          nNume7  = ((#3#5 * #3#6 / nPreTon) ! nDeci_BaseMxP) * nMult;
          nImpDiv = ((#3#5 * #3#38 / nPreTon) ! nDeci_DivP) * nMult;
          nNume11 = (#3#5 - #3#43) * #3#6 * nMult / nPreTon;
     |FINSI;
     nNume11 = nNume11 ! nDeci_DivP;
     #3#9 = (nNume7 < #3#8) < #3#29;
     #3#39 = (nImpDiv < #3#8) < #3#29;
/*
     #3#9 = #3#9 < #0#5;
     #3#9 = #3#9 < #0#17;
     #3#9 = #3#9 < #0#6;

     #3#39 = #3#39 < #0#5;
     #3#39 = #3#39 < #0#17;
     #3#39 = #3#39 < #0#6;
*/
     nBrutoMoneda1 = #3#9;
     nImporDescue1 = (nBrutoMoneda1 % #0#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #0#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #0#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     #3#9 = nBrutoMoneda1;

     nBrutoMoneda2 = #3#39;
     nImporDescue1 = (nBrutoMoneda2 % #0#5) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #0#17) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #0#6) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
/*
     nNume11 = ((nNume11 < #3#8) < #3#29) ! nDeci_DivP;
     nNume11 = (nNume11 < #0#5) ! nDeci_DivP;
     nNume11 = (nNume11 < #0#17) ! nDeci_DivP;
     nNume11 = (nNume11 < #0#6) ! nDeci_DivP;
*/
     nBrutoMoneda1 = ((nNume11 < #3#8) < #3#29) ! nDeci_DivP;
     nImporDescue1 = (nBrutoMoneda1 % #0#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #0#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #0#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;

     ||HAZ BseVerdeBase8;

     nNume11 = nBrutoMoneda1;
     #3#39 = nBrutoMoneda2;

     #3#7  = nNume7  * nMult;
     #3#11 = nNume11 * nMult;
     #3#9  = #3#9  * nMult;
     #3#39 = #3#39 * nMult;

     |SI #0#37 = "D";
          #3#41 = #3#9;
     |SINO;
          #3#41 = #3#39;
     |FINSI;
|FPRC;

|PROCESO ChampiEmarPortes;    || Los inventos de Carmelo!!!
     |DDEF aAlfa;
     aAlfa = aAlfa + "champi14";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          #referen@#0 = #0#25;
          #referen@#1 = #0#0;
          |LEE 000#referen@.=;
          |SI FSalida ! 0; |DDEFECTO #referen@; |FINSI;

          #0#11 = #0#11 + #referen@#2;
          #0#42 = #0#42 + #referen@#2;
          #0#45 = #0#45 + #referen@#2;
          #0#48 = #0#48 + #referen@#2;

          |SI #0#13 = 0;
               || por servir
               #0#12 = #0#12 + #referen@#2;
               #0#43 = #0#43 + #referen@#2;
               #0#46 = #0#46 + #referen@#2;
               #0#49 = #0#49 + #referen@#2;
          |SINO;
               || servido
               #0#13 = #0#13 + #referen@#2;
               #0#44 = #0#44 + #referen@#2;
               #0#47 = #0#47 + #referen@#2;
               #0#50 = #0#50 + #referen@#2;
          |FINSI;

          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;
