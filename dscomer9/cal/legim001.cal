|FICHEROS;
     legim001 #0;
     legim002 #2;
     agifa027 #41;       || Contador.

     legim005 #5;        ||Formatos por series

     legim006 #6;        ||Parametros modulo
     legim008 #8;        ||Calendario Laboral

     legim003 #3;        ||Partes CAB
     legim004 #4;        ||Partes LIN

     agifa024 #24;
     agifa019 #19;

     legim014 #14;
     legim017 #17;
     agifa219 #219;
     agifa220 #220;
|FIN;

|VARIABLES;
     nSwDA = "";
     aFin = "";
     nPuntero = 0;
     aAlfa = "";
     nBuffer = 0;
     nLineas = 0;
     nLin = 0;
     nCol = 0;


     nTotalLineas = 0;        ||Numero de Lineas. Para controlar la impresion
                              ||de la tabla.

     aDesPeriodo = "";
     nFila = 0;
     nFilaBase = 0;
     nTabla = 0;
     nTotalContrato = 0;
     aCP = "";
     modo = 0;
     &nPromo = 0;
     &enMensaje = 0;
     &aParam    = "";
     &eaSerie = "";
     &enDirEnt = 0;
     &enAlmacen = 0;
     &eaRepre = "";
     &efFecha = @;
     &enDescuento1 = 0;
     &enDescuento2 = 0;
     &eaTComision  = "";
     articulo = "";
     &enInterno = 0;
     &eaCliArtDiviSN = "";
     &eaCliente = "";
     &eaArticulo = "";


     &uni_dt = 0;   || Unidades
     &uni_dt2 = 0;   || Unidades2
     &fed_dt = @;   || Fecha....
     &art_dt = "";  || Articulo.
     &cli_dt = "";  || Cliente..
     &fam_dt = "";  || Familia.
     &iva_dt = 0;   || Tipo Iva.
     &dtos_2 = 0;   || Descuento 2.
     &dto_pt = 0;   || Descuento Ptas.
     &dtos_1 = 0;   || Descuento 1.
     &pvp_ve = 0;   || Precio Venta.
     &tarifa = 0;   || Tarifa Cliente.
     &quedto = 0;   || 1=cli./art, 2=cli./familia, 3=cli./subfam.
     &gru_dt = "";  || Grupo Cliente.

     &eaSerieParte = "";
     &enNumeroParte = 0;

     nPartesB = 0;
     nSwPartesAlba = 0;

     &enPartes = 0;
     &eaSerieContrato = "";
     &enNumeroContrato = 0;

     nUltimo = 0;
     aFechaVoy = "";
     aAnyo = "";
     nAnyo = 0;
     nSubLin = 0;

     fDiaSem = @;
     cDiaSem = "";

     nSwFestivo = 0;
     aPeriodo = "";
     nFechaVoy = 0;
     nFechaIni = 0;
     nFechaFin = 0;
     fFechaVoy = @;

     nNV = 0;
     aTipoXML = "";
     aVarXML = "";
     aValorXML = "";

     aUsuario = "";
     aFicheroTxt = "";
     aTxt = "";
     aExe = "";
     nHandle = 0;
     aBase = "";
     aPathCli = "";
     aIPRemoto = "";
     fFechaFin = @;
     fFechaIni = @;
     aFechaFin = "";
     &eaQuitaRaro = "";
     &eaOrigenPLB = "";
     &eaDestinoPLB = "";


 {-1}menu           = "";
     menu1          = "2400";
     menu2          = "1";
     menu3          = "Contador:  ";
     menu4          = "AM";
     menu5          = " Automatico ";
     menu6          = " Manual ";

     nForma = 0;
     nModo = 0;
     contador = 0;
     cont = "";

     aMensaje = "";
     aAlfa1 = "";

     qMod = 0;
     aSerie = "";
     nNumero = 0;

  {-1}aDato  = "";
  aDato1 = "2400";
  aDato2 = "1";
  aDato3 = " ";
  aDato4 = "IGBVHO";
  aDato5 = "Imprimir";
  aDato6 = "Gen.Partes";
  aDato7 = "Borr.Partes";
  aDato8 = "Ver Partes ";
  aDato9 = "Hoja Calidad";
  aDato10 = "Obsevaciones";

     aInforme = "";
     nSwPie = 0;

|FIN;

|PROCESO Tipo0C13m002;
     |SI #legim002#13 = "S";
          #legim002#14 = "Semanal";
     |FINSI;
     |SI #legim002#13 = "Q";
          #legim002#14 = "Quincenal";
     |FINSI;
     |SI #legim002#13 = "M";
          #legim002#14 = "Mensual";
     |FINSI;
     |SI #legim002#13 = "3";
          #legim002#14 = "Trimestral";
     |FINSI;
     |SI #legim002#13 = "4";
          #legim002#14 = "Quatrimestral";
     |FINSI;
     |SI #legim002#13 = "E";
          #legim002#14 = "Semestral";
     |FINSI;
     |SI #legim002#13 = "A";
          #legim002#14 = "Anual";
     |FINSI;
     |SI #legim002#13 = "N";
          #legim002#14 = "No";
     |FINSI;
     |PINTA #legim002#14;
|FPRC;

|PROCESO Borra14;
     |BORRA 020#14a;
|FPRC;

|DEFBUCLE Borra14;
     #14#1;
     ;
     #0#0, #0#1, 001;
     #0#0, #0#1, 999;
     be;
     NULL,  Borra14;
|FIN;

|PROCESO Tipo0C2m001; |TIPO 0;
     nModo = (FEntrada/100) ! 0;
     |SI nModo = 1;
          |ABRE #agifa024;
          |DDEFECTO #agifa024;
          #agifa024#0 = #legim001#2;
          |LEE 000#agifa024.=;
          |SI FSalida = 0; |Y #agifa024#158 = 99;
               aMensaje = "0000Cliente inactivo. No es posible realizar el contrato.";
               |MENAV aMensaje;
               |ERROR;
               |CIERRA #agifa024;
               |ACABA;
          |FINSI;
          |CIERRA #agifa024;
     |SINO;
          |SI nModo = 2;
               |SI Contenido ! #legim001#2;       ||Cambio de cliente
                    |ABRE #agifa024;
                    |DDEFECTO #agifa024;
                    #agifa024#0 = #legim001#2;
                    |LEE 000#agifa024.=;
                    |SI FSalida = 0; |Y #agifa024#158 = 99;
                         aMensaje = "0000Cliente inactivo. No es posible modificar el contrato.";
                         |MENAV aMensaje;
                         |ERROR;
                         |CIERRA #agifa024;
                         |ACABA;
                    |FINSI;
                    |CIERRA #agifa024;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo2legim001; |TIPO 2;
     nForma = 0 +. 1;
     nModo = (FEntrada/100) ! 0;
     |SI nModo = 3;
          |SI nForma = -1;
               |SI #legim001#7 = "S";
                    aMensaje = "0000NExisten partes asociados con este contrato, que tambien se borraran. Continuar?";
                    |CONFI aMensaje;
                    |SI FSalida ! 0;
                         |ERROR;
                         |ACABA;
                    |FINSI;

                    nSwPartesAlba = 0;
                    |HAZ HayPartesAlbaran;

                    |SI nSwPartesAlba = 1;
                         aMensaje = "0000No se pueden borrar los partes del contrata, puesto que YA estan albaranados";
                         |MENAV aMensaje;
                         |ERROR;
                         |ACABA;
                    |FINSI;

                    nPartesB = 0;
                    |HAZ BorradoPartes;
               |FINSI;
          |FINSI;
          |BUCLE Borra14;
     |FINSI;
|FPRC;

|PROCESO Tipo0C5; |TIPO 0;
     fFechaFin = #legim001#5;
     aFechaFin = fFechaFin;
     |SI aFechaFin = "01.01.0000";
          aMensaje = "0000Introduzca la fecha fin de contrato";
          |MENAV aMensaje;
          |ERROR;
     |SINO;
          |SI #legim001#5 < #legim001#4;
               aMensaje = "0000La fecha Fin de Contrato NO puede ser inferior a la fecha del contrato";
               |MENAV aMensaje;
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Totales;
     #legim002#9 = #legim002#7 * #legim002#8;
     #legim002#12 = #legim002#9 < #legim002#10;
     #legim002#12 = #legim002#12 < #legim002#11;
     |PINTA #legim002#9;
     |PINTA #legim002#12;
|FPRC;

|PROCESO Tipo20legim001;  |TIPO 20;
     aAlfa1 = FSalida;
     |SI aAlfa1 = "OPCION";
         FSalida = "Opciones";
         |ACABA;
     |FINSI;

     |SELECT #1#0;

     |LEE 101#0=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     qMod = (FEntrada / 100) ! 0;

     aSerie = #0#0;
     nNumero = #0#1;

     |PARA;  |SI;  |HACIENDO;
          |MENU aDato;
          aDato2 = FSalida;
          |SI aDato2 = "1";  |HAZ Imprimir;  |FINSI;
          |SI aDato2 = "2";  |HAZ GenPartes;  |FINSI;
          |SI aDato2 = "3";  |HAZ BorraPartes;  |FINSI;
          |SI aDato2 = "4";  |HAZ VerPartes;  |FINSI;
          |SI aDato2 = "5";  |HAZ HojaCalidad;  |FINSI;
          |SI aDato2 = "6";  |HAZ Observaciones;  |FINSI;
          |SI aDato2 < "1"; |O aDato2 > "6";  |SAL;  |FINSI;
     |SIGUE;
     |LIBERA #0;
|FPRC;


|PROCESO CogeLineas30;
     nPuntero = 1;
     |PARA nPuntero = 1; |SI nPuntero [ 999; |HACIENDO nPuntero = nPuntero + 1;
          #14#0 = #0#0;
          #14#1 = #0#1;
          #14#2 = nPuntero;
          |LEE 000#14=;
          |SI FSalida = 0;
               aAlfa = #14#3; |AL_BUF nBuffer, nPuntero, aAlfa;
               |BORRA 020#14a;
          |SINO;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO PoneLineas30;
     |PARA nPuntero = 999; |SI nPuntero ] 0; |HACIENDO nPuntero = nPuntero - 1;
          |DEL_BUF nBuffer, nPuntero, aAlfa;
          |SI aAlfa ! ""; nLineas = nPuntero; |SAL; |FINSI;
     |SIGUE;
     |PARA nPuntero = 1; |SI nPuntero [ nLineas; |HACIENDO nPuntero = nPuntero + 1;
          |DEL_BUF nBuffer, nPuntero, aAlfa;
          #14#0 = #0#0;
          #14#1 = #0#1;
          #14#2 = nPuntero;
          #14#3 = aAlfa;
          |GRABA 020#14n;
          |LIBERA #14;
     |SIGUE;
|FPRC;

|PROCESO Observa30;
     |ABRE #14;
     |PINPA #0#14;
     |DIMENSIONA 200, nBuffer, 0;
     |HAZ CogeLineas30;
     nModo = 100; nLin = 10; nCol = 78;
     |EDITA nBuffer, 1, 10, 1002, 2279, nModo, "", 0, nLin, nCol;
     |HAZ PoneLineas30;
     |FINDIM nBuffer;
     |CIERRA #14;
|FPRC;

|PROCESO Observaciones;
     |PUSHV 0501 2380;
     |HAZ Observa30;
     |POPV;
|FPRC;

|PROCESO GrabaTxt;
     |QBF aTxt;
     aTxt = aTxt + aFin;
     |XGRABA nHandle, aTxt;
|FPRC;

|PROCESO legim002xml;
     ||La fila 1 es el encabezado
     ||Empieza por la fila 2.

     nNV = nNV + 1;
     nFila = nNV + 1;

     |SI nNV = nTotalLineas;
          ||Es la ultima fila.  Solo tengo que poner los datos
     |SINO;
          ||Copio la fila base al final del documento y luego relleno la anterior fila base

          aTipoXML = "T";
          aVarXML = "}" + nTabla + "}" + nFila + "}1}+G";
          aValorXML = "";
          |HAZ MeteTxt;

          nFilaBase = nFila + 1;

          aTipoXML = "T";
          aVarXML = "}" + nTabla + "}" + nFilaBase + "}1}+P";
          aValorXML = "";
          |HAZ MeteTxt;
     |FINSI;

     aTipoXML = "T";
     aVarXML = "}" + nTabla + "}" + nFila + "}" + 2;
     aValorXML = #legim002#4;
     nSwDA = 1;
     |HAZ MeteTxt;
     nSwDA = 0;

     aDesPeriodo = #legim002#14
     aTipoXML = "T";
     aVarXML = "}" + nTabla + "}" + nFila + "}" + 3;
     aValorXML = aDesPeriodo;
     |HAZ MeteTxt;

     aTipoXML = "T";
     aVarXML = "}" + nTabla + "}" + nFila + "}" + 4;
     aValorXML = #legim002#12;
     |QBF aValorXML;
     aValorXML = aValorXML + " €"

     eaQuitaRaro = " m s I.V.A";
     |HAZ QuitaRaros003871;
     aValorXML = aValorXML + eaQuitaRaro;

     ||PROBLEMAS CON EL QUITARAROS
     ||HAZ MeteTxt;
     ||Pseudo  Metetxt (sin quitararos).
     aTxt = aTipoXML;
     |HAZ GrabaTxt;

     aTxt = aVarXML;
     |HAZ GrabaTxt;

     aTxt = aValorXML;
     |HAZ GrabaTxt;

/*
     aTipoXML = "V"; aVarXML = "#NUMLIN" + nNV + "#"; aValorXML = #legim002#2; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#ARTICULO" + nNV + "#"; aValorXML = #legim002#3; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#NOMBREART" + nNV + "#"; aValorXML = #legim002#4; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#FAMILIA" + nNV + "#"; aValorXML = #legim002#5; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#UNIDADES" + nNV + "#"; aValorXML = #legim002#7; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#PRECIO" + nNV + "#"; aValorXML = #legim002#8; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#IMPORTE" + nNV + "#"; aValorXML = #legim002#9; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#%DTO" + nNV + "#"; aValorXML = #legim002#10; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#%DTODOS" + nNV + "#"; aValorXML = #legim002#11; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#IMPTOTAL" + nNV + "#"; aValorXML = #legim002#12; |HAZ MeteTxt;
*/

     nTotalContrato = nTotalContrato + #legim002#12;
|FPRC;

|DEFBUCLE legim002xml;
 #legim002#1;
 ;
 #legim001#0, #legim001#1, 001;
 #legim001#0, #legim001#1, 999;
 ;
 NULL, legim002xml;
|FIN;

|PROCESO legim002xmlCuenta;
     nTotalLineas = nTotalLineas + 1;
|FPRC;

|DEFBUCLE legim002xmlCuenta;
 #legim002#1;
 ;
 #legim001#0, #legim001#1, 001;
 #legim001#0, #legim001#1, 999;
 ;
 NULL, legim002xmlCuenta;
|FIN;

|PROCESO DA;
     eaQuitaRaro = #17#5; |QBF eaQuitaRaro;
     |HAZ QuitaRaros003871;
     aTxt = " " + eaQuitaRaro;
     |XGRABA nHandle, aTxt;
|FPRC;

|DEFBUCLE DA;
     #17#1;
     ;
     "C", #2#0, #2#1, #2#2, 001;
     "C", #2#0, #2#1, #2#2, 999;
     ;
     NULL, DA;
|FIN;

|PROCESO MeteTxt;
     aTxt = aTipoXML;
     |HAZ GrabaTxt;

     aTxt = aVarXML;
     |HAZ GrabaTxt;

     eaQuitaRaro = aValorXML;
     |HAZ QuitaRaros003871;
     aTxt = eaQuitaRaro;
     |SI nSwDA = 1;
          |QBF aTxt;
          |XGRABA nHandle, aTxt;
          |BUCLE DA;
          |XGRABA nHandle, aFin;
     |SINO;
          |HAZ GrabaTxt;
     |FINSI;
|FPRC;

|PROCESO legim014;
     nFila = nFila + 1;

     aTipoXML = "T";
     aVarXML = "}" + nTabla + "}" + nFila + "}1}+G";
     aValorXML = "";
     |HAZ MeteTxt;

     nFilaBase = nFila + 1;

     aTipoXML = "T";
     aVarXML = "}" + nTabla + "}" + nFilaBase + "}1}+P";
     aValorXML = "";
     |HAZ MeteTxt;

     aTipoXML = "T";
     aVarXML = "}" + nTabla + "}" + nFila + "}" + 1;
     aValorXML = #legim014#3;
     |HAZ MeteTxt;
|FPRC;

|DEFBUCLE legim014;
 #legim014#1;
 ;
 #legim001#0, #legim001#1, 001;
 #legim001#0, #legim001#1, 999;
 ;
 NULL, legim014;
|FIN;

|PROCESO Imprimir;
     aFin = &13;
     aFin = aFin + &10;

     |ABRE #legim005;
     |DDEFECTO #legim005;
     #legim005#0 = #legim001#0;
     |LEE 000#legim005.=;
     aInforme = #legim005#2;
     |QBF aInforme;
     |CIERRA #legim005;

     |SI aInforme = "";
          aMensaje = "0000No hay definido ningun informe para esta impresion";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     |DBASE aBase;
     |QBF aBase;
     eaOrigenPLB = aBase + "word/" + aInforme + ".doc";
     |XABRE "E", eaOrigenPLB, nHandle;
     |SI FSalida < 0;
          aMensaje = "0000No existe el documento word: " + aInforme + ".doc";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     aPathCli = "c:\documentos\";
     |RMKDIR aPathCli;
     aPathCli = "c:\documentos\dscomer9\";
     |RMKDIR aPathCli;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;

     eaDestinoPLB = aPathCli + aInforme + ".doc";
     |SI aIPRemoto = "";
          |HAZ TraeFicheroPLB;
     |SINO;
          |HAZ RTraeFicheroPLB;
     |FINSI;

     eaOrigenPLB = aBase + "plugins/dsxml.exe";
     eaDestinoPLB = aPathCli + "dsxml.exe";
     |SI aIPRemoto = "";
          |HAZ TraeFicheroPLB;
     |SINO;
          |HAZ RTraeFicheroPLB;
     |FINSI;

     aUsuario = Usuario;
     |QBF aUsuario;
     aFicheroTxt = aPathCli + "contrato" + aUsuario + ".txt";

     |XABRE "BCW", aFicheroTxt, nHandle;
     |SI FSalida < 0;
          aMensaje = "0000Problemas al crear fichero " + aFicheroTxt;
          |MENAV aMensaje;
     |FINSI;

     aTxt = "[FICHERO]#" + aPathCli + aInforme + ".doc#" + aPathCli + "1" + aInforme + ".doc";
     |HAZ GrabaTxt;

/*
     aTipoXML = "V";
     aVarXML = "#NUMERO#";
     aValorXML = "12345";
     |HAZ MeteTxt;
*/
     |ABRE #agifa024;
     |DDEFECTO #agifa024;
     #agifa024#0 = #legim001#2;
     |LEE 000#agifa024.=;
     |CIERRA #agifa024;

     nTabla = 1;         ||Observaciones
     nFila = 0;
     |BUCLE legim014;


     aTipoXML = "V"; aVarXML = "#NOMBREEMPRESA#"; aValorXML = #agifa024#1; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#PERSONACONTACTO#"; aValorXML = #agifa024#36; |HAZ MeteTxt;

     aTipoXML = "V"; aVarXML = "#DIRECCIONCLIENTE#"; aValorXML = #agifa024#5; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#POBLACIONCLIENTE#"; aValorXML = #agifa024#6; |HAZ MeteTxt;

     aCP = (("00" + #agifa024#178) % -102) + (("000" + #agifa024#179) % -103);
     aTipoXML = "V"; aVarXML = "#CPCLIENTE#"; aValorXML = aCP; |HAZ MeteTxt;

     aTipoXML = "V"; aVarXML = "#PROVINCIACLIENTE#"; aValorXML = #agifa024#7; |HAZ MeteTxt;

     aTipoXML = "V"; aVarXML = "#TELEFONOCLIENTE#"; aValorXML = #agifa024#17; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#FAXCLIENTE#"; aValorXML = #agifa024#18; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#MOVILCLIENTE#"; aValorXML = #agifa024#196; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#EMAILCLIENTE#"; aValorXML = #agifa024#197; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#CIFEMPRESA#"; aValorXML = #agifa024#15; |HAZ MeteTxt;

     aTipoXML = "V"; aVarXML = "#SERIECONTRATO#"; aValorXML = #legim001#0; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#NUMEROCONTRATO#"; aValorXML = #legim001#1; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#CLIENTE#"; aValorXML = #legim001#2; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#NOMBRECLIENTE#";  aValorXML = #legim001#3; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#FECHAINI#"; aValorXML = #legim001#4; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#FECHAFIN#"; aValorXML = #legim001#5; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#PARTESGEN#"; aValorXML = #legim001#7; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#FINALIZADO#"; aValorXML = #legim001#8; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#REPRE#"; aValorXML = #legim001#9; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#NOMBREREPRE#"; aValorXML = #legim001#10; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#SERIEPRESU#"; aValorXML = #legim001#11; |HAZ MeteTxt;
     aTipoXML = "V"; aVarXML = "#NUMEROPRESU#"; aValorXML = #legim001#12; |HAZ MeteTxt;

     nTabla = 2;

/*
     ||(S) Semanal; (Q) Quincenal; (M) Mensual; (E) Semestral; (A) Anual; (N) No
     aDesPeriodo = "";
     |SI #legim001#6 = "S";
          aDesPeriodo = "Semanal";
     |FINSI;
     |SI #legim001#6 = "Q";
          aDesPeriodo = "Quincenal";
     |FINSI;
     |SI #legim001#6 = "M";
          aDesPeriodo = "Mensual";
     |FINSI;
     |SI #legim001#6 = "E";
          aDesPeriodo = "Semestral";
     |FINSI;
     |SI #legim001#6 = "A";
          aDesPeriodo = "Anual";
     |FINSI;
*/

     nTotalLineas = 0;
     |BUCLE legim002xmlCuenta;

     nTotalContrato = 0;
     nNV = 0;
     |BUCLE legim002xml;

     aTipoXML = "V"; aVarXML = "#TOTALCONTRATO#"; aValorXML = nTotalContrato; |HAZ MeteTxt;


     aTxt = "[IMPRESORA]#P";
     |HAZ GrabaTxt;

     |XCIERRA nHandle;

     ||Creo el contratoUsuario.txt
     ||Y ejecuto el dsxml.exe

     aExe = aPathCli + "dsxml.exe " + aFicheroTxt;
     |RSYSTEM aExe;

     ||RFBORRA aFicheroTxt;
     aAlfa = aPathCli + "contrato" + aUsuario + ".LCK";
     |RFBORRA aAlfa;

|FPRC;

|PROCESO legim002;
     |PRINT;
     nSwPie = 1;
|FPRC;

|DEFBUCLE legim002;
 #legim002#1;
 ;
 #legim001#0, #legim001#1, 001;
 #legim001#0, #legim001#1, 999;
 ;
 NULL, legim002;
|FIN;

|PROCESO HojaCalidad;
     |IMPRE 0;
     |SI FSalida = 0;
          |ABRE #legim005;
          |DDEFECTO #legim005;
          #legim005#0 = #legim001#0;
          |LEE 000#legim005.=;
          aInforme = #legim005#7;
          |QBF aInforme;
          |CIERRA #legim005;

          |INFOR aInforme;
          |SI FSalida = 0;
               |BUCLE legim002;
               |SI nSwPie = 1;
                    |PIEINF;
               |FINSI;
               |FININF;
          |SINO;
               aMensaje = "0000Informe " + aInforme + " inaccesible.";
               |MENAV aMensaje;
          |FINSI;
          |FINIMP;
     |SINO;
          |MENAV "0000Proceso cancelado.";
     |FINSI;
|FPRC;

|PROCESO BorraPartes;
     ||ARA39.
     ||Tengo que ver si estan YA facturados (albaranados) en tal caso
     ||se anula el proceso.

     |SI #legim001#7 = "N";
          aMensaje = "0000Este contrato NO tiene partes";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     nSwPartesAlba = 0;
     |HAZ HayPartesAlbaran;

     |SI nSwPartesAlba = 1;
          aMensaje = "0000No se pueden borrar los partes del contrata, puesto que YA estan albaranados";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     nPartesB = 0;
     |HAZ BorradoPartes;

     |SI nPartesB = 0;
          aMensaje = "0000No hay partes para borrar";
     |SINO;
          |SI nPartesB = 1;
               aMensaje = "0000Borrado 1 parte";
          |SINO;
               aMensaje = "0000Borrados " + nPartesB + " partes";
          |FINSI;
     |FINSI;
     |MENAV aMensaje;

     |LEE 101#legim001.=;
     |SI FSalida = 0;
          #legim001#7 = "N";
          |GRABA 020#legim001.a;
          |LIBERA #legim001;
          |PINTA #legim001#7;
     |FINSI;
|FPRC;

|PROCESO legim003HayAlba;
     |SI #legim003#15 = "S";
          nSwPartesAlba = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE legim003HayAlba;
 #legim003#2;
 ;
 #legim001#0, #legim001#1;
 #legim001#0, #legim001#1;
 be;
 NULL, legim003HayAlba;
|FIN;

|PROCESO HayPartesAlbaran;
     |BUCLE legim003HayAlba;
|FPRC;

|PROCESO BorraParteDA;
     |BORRA 020#17a;
|FPRC;

|DEFBUCLE BorraParteDA;
     #17#1;
     ;
     "P", #4#0, #4#1, #4#2, 001;
     "P", #4#0, #4#1, #4#2, 999;
     be;
     NULL, BorraParteDA;
|FIN;

|PROCESO legim004Borra;
     |BUCLE BorraParteDA;
     |BORRA 020#legim004.a;
|FPRC;

|DEFBUCLE legim004Borra;
 #legim004#1;
 ;
 #legim003#0, #legim003#1, 001;
 #legim003#0, #legim003#1, 999;
 be;
 NULL, legim004Borra;
|FIN;

|PROCESO legim003Borra;
     |BUCLE legim004Borra;
     |BORRA 020#legim003.a;
     nPartesB = nPartesB + 1;
|FPRC;

|DEFBUCLE legim003Borra;
 #legim003#2;
 ;
 #legim001#0, #legim001#1;
 #legim001#0, #legim001#1;
 be;
 NULL, legim003Borra;
|FIN;

|PROCESO BorradoPartes;
     |BUCLE legim003Borra;
|FPRC;


|PROCESO GenPartes;
     enPartes = 0;

     |SI #legim001#7 = "S";
          aMensaje = "0000Partes YA generados. Proceso cancelado";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     fFechaIni = #legim001#4
     fFechaFin = #legim001#5;
     aFechaFin = fFechaFin;
     |SI aFechaFin = "01.01.0000";
          aMensaje = "0000Introduzca la fecha fin de contrato";
          |MENAV aMensaje;
          |ERROR;
          |ACABA;
     |SINO;
          |SI #legim001#5 < #legim001#4;
               aMensaje = "0000La fecha Fin de Contrato NO puede ser inferior a la fecha del contrato";
               |MENAV aMensaje;
               |ERROR;
               |ACABA;
          |FINSI;
     |FINSI;

/*
     aPeriodo = #legim001#6;
     |QBF aPeriodo;
     |SI aPeriodo = "";
          aMensaje = "0000Indique la periodicidad del contrato";
          |MENAV aMensaje;
          |ERROR;
          |ACABA;
     |FINSI;

     |SI aPeriodo = "N";
          |SUB_EJECUTA_NP "legim003";
          |ACABA;
     |FINSI;
*/

     ||Proceso que genera los partes
     eaSerieContrato = #legim001#0;
     enNumeroContrato = #legim001#1;
     |SUB_EJECUTA_NP "legiz001";

     |SI enPartes = 0;
          aMensaje = "0000No se ha generado ningun parte";
     |SINO;
          |SI enPartes = 1;
               aMensaje = "0000Se ha generado 1 parte";
          |SINO;
               aMensaje = "0000Se han generado " + enPartes + " partes";
          |FINSI;

          |LEE 101#legim001.=;
          |SI FSalida = 0;
               #legim001#7 = "S";
               |GRABA 020#legim001.a;
               |LIBERA #legim001;
               |PINTA #legim001#7;
          |FINSI;
     |FINSI;
     |MENAV aMensaje;
|FPRC;

|PROCESO Baja003;
     #legim003#4 = #legim001#0;
     #legim003#5 = #legim001#1;
|FPRC;

|PROCESO Alta003;
     #legim003#4 = #legim001#0;
     #legim003#5 = #legim001#1;
|FPRC;

|PROCESO VerPartes;
     |SI #legim001#7 = "N";
          aMensaje = "0000Este contrato NO tiene partes";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;
     |ABRE #legim003;
     |CONSULTA_F_CLAVE #2#legim003, Baja003, Alta003;
     |SI FSalida = 0;
          |CIERRA #legim003;
          |PUSHV 0501 2380;
               eaSerieParte = #legim003#0;
               enNumeroParte = #legim003#1;
               |SUB_EJECUTA_NP "legim003;MODI";
          |POPV;
     |SINO;
          |CIERRA #legim003;
     |FINSI;
     ||ARA39
|FPRC;

|PROCESO Tipo7C1_legim001; |TIPO 7;
     nModo = (FEntrada/100) ! 0;
     |SI nModo = 1;
          |MENU menu;
          |SI FSalida = 1;    ||Automatico
               |ABRE #41;
               #41#2 = #0#0;
               #41#0 = "legcontr";
               |LEE 101#41=;
               |SI FSalida = 0;
                    contador = #41#1;
                    #41#1 = #41#1 + 1;
                    |GRABA 021#41a;
               |SINO;
                    contador = 1;
                    #41#1 = 2;
                    |GRABA 021#41n;
               |FINSI;
               cont = contador;
               cont = ("000000" + cont) % -106;
               #0Campo = cont;
               |PINTA #0Campo;
               |LIBERA #41;
               |CIERRA #41;
          |FINSI;
     |FINSI;
|FPRC;


|PROCESO PrecioArti;
     modo = (FEntrada / 100) ! 0;
     |SI #legim002#Campo# = Contenido; |ACABA; |FINSI;

     fed_dt = #legim001#4;   || Fecha....
     art_dt = #legim002#3;   || Articulo.
     cli_dt = #legim001#2;  || Cliente..
     fam_dt = #legim002#5;  || Familia.
     iva_dt = 2;      || Tipo Iva.
     dtos_2 = #legim002#11;      || Descuento 2.
     dtos_1 = #legim002#10;      || Descuento 1.
     pvp_ve = 0;      || Precio Venta.

     |ABRE #agifa024;
     |DDEFECTO #agifa024;
     #agifa024#0 = #legim001#2;
     |LEE 000#agifa024.=;
     |CIERRA #agifa024;

     |ABRE #agifa019;
     |DDEFECTO #agifa019;
     #agifa019#0 = #legim002#3;
     |LEE 000#agifa024.=;
     |CIERRA #agifa024;

     tarifa = #agifa024#39;  || Tarifa Cliente....
     gru_dt = #agifa024#158; || Grupo Cliente.
     nPromo = 0;
     uni_dt = #legim002#7;
     uni_dt2 = 0;
     enMensaje = 0;
     aParam = "";
     eaSerie = #legim001#0;
     enDirEnt = 1;
     enAlmacen = 1;
     |SI modo = 1; |O articulo ! #0#2;
          |SI #agifa019#176 = "S";  enMensaje = 1;  |FINSI;
          enInterno = tarifa;
          |HAZ calcdtos;              || Calculo Dtos.....
          eaCliArtDiviSN = "N";

          #legim002#8   = pvp_ve - dto_pt;   || Precio Venta. sin iva.
          #legim002#10  = dtos_1;            || 1¦ Dto.
          #legim002#11  = dtos_2;            || 2§ Dto.

          enDescuento1 = #legim002#10;
          enDescuento2 = #legim002#11;
          eaTComision  = "";
          eaCliente    = #legim001#2;
          eaArticulo   = #legim002#3;
          eaRepre      = #legim001#9;
          efFecha      = #legim001#4;
          enDirEnt = 1;
          enAlmacen = 1;
          uni_dt = #legim002#5;
          uni_dt2 = 0;
          |HAZ Comisiones;

          #legim002#10 = enDescuento1;
          #legim002#11 = enDescuento2;
          #legim002#8 = pvp_ve - dto_pt;   || Precio Venta. sin iva.

          |PINTA #legim002#8;
          |PINTA #legim002#10;
          |PINTA #legim002#11;
     |FINSI;
|FPRC;

|PROCESO LlenaDA;
     #17#0 = "C";
     #17#1 = #2#0;
     #17#2 = #2#1;
     #17#3 = #2#2;
     #17#4 = #220#1;
     #17#5 = #220#2;
     |GRABA 020#17n;
|FPRC;

|PROCESO BorraConDA;
     |BORRA 020#17a;
|FPRC;

|DEFBUCLE BorraConDA;
     #17#1;
     ;
     "C", #2#0, #2#1, #2#2, 001;
     "C", #2#0, #2#1, #2#2, 999;
     ;
     NULL, BorraConDA;
|FIN;

|PROCESO Min17;
     #17#0 = "C";
     #17#1 = #2#0;
     #17#2 = #2#1;
     #17#3 = #2#2;
     #17#4 = 001;
|FPRC;

|PROCESO Max17;
     #17#0 = "C";
     #17#1 = #2#0;
     #17#2 = #2#1;
     #17#3 = #2#2;
     #17#4 = 999;
|FPRC;

|PROCESO Tipo2Lin; |TIPO 2;
     nModo = (FEntrada / 100) ! 0;
     nForma = 0 +. 1;
     |SI nModo = 1;
          |ABRE #219;
          #219#0 = #2#3;
          |LEE 000#219=;
          |SI FSalida = 0; |Y #219#2 = "S";
               |BUCLE BorraConDA;
               |ABRE #17;
               |BUCLELIN 2 LlenaDA #219;
               |CIERRA #17;
          |FINSI;
          |CIERRA #219;
     |FINSI;
     |SI nForma = 1;
          |PUSHV 0501 2380;
          |ENTLINEAL #1#17, 5, 2, 22, 1, Min17, Max17;
          |POPV;
     |FINSI;
     |SI nModo = 3;
          |BUCLE BorraConDA;
     |FINSI;
|FPRC;

|PROCESO T11_legim002; |TIPO 11;
     |SI FSalida = 16;
          |PUSHV 0501 2380;
          |ENTLINEAL #1#17, 5, 4, 22, 1, Min17, Max17;
          |POPV;
     |FINSI;
|FPRC;
