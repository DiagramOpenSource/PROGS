|FICHEROS;
     vipem004 #0;
     vipew004 #804;
     vipem006 #906;
     vipem007 #907;
     vipem011 #911;
     vipem016 #916;
     vipem017 #917;
     vipem021 #921;
     vipem008 #908;
     agifa024 #24;
     agifa091 #91;

     referen@  #2000;
     refere1@  #2001;
|FIN;

|VARIABLES;

     aAux1 = "";
     nCampo = 0;
     nErrorNumero = 0;
     aTestea = "";
     nLong = 0;
     aLong = "";
     nVoy = 0;
     nSaca = 0;
     aSaca = "";
     aLetra = "";

     fSistema = @;
     nSwHayActivos = 0;
     nCliente = 0;
     &enNumEdificio = 0;
     &eaTipoContador = "";

     aCta = "";
     nConta = 0;
     nConta2 = 0;
     aAux = "";
     nAux = 0;

     &eaSucursal = "";
     &eaEntidad = "";
     &eaCuenta = "";
     &eaDC = "";
     aMensaje   = "";
     aFecha     = "";
     aMes       = "";
     aAlfa     = "";
     aEdifi    = "";
     aVeces    = "";
     aPiso2    = "";
     aCliente  = "";
     aClienteReal  = "";
     aCaracter = "";
     Comodin1  = "";
     Comodin2  = "";

     nSwError      = 0;
     nSwErrorOtro  = 0;
     nMes          = 0;
     nVeces        = 0;
     Digito1       = 0;
     Digito2       = 0;
     Cont          = 0;
     Calc          = 0;
     nMeses        = 0;
     nContenido    = 0;
     nProrroga     = 0;
     nForma        = 0;
     nContrato     = 0;
     nHayFacturas  = 0;
     nHayProrrogas = 0;

     fFecha    = @;
     fDFecha   = @;
     fHFecha   = @;
     fFFecha   = @;

     &enModo   = 0;

     nNume1 = 0;
     nBuscaCto = 0;
     nBuscaCtoOtro = 0;
     nBuscaProOtro = 0;
     nBuscaRes = 0;
     nBuscaResOtro = 0;
     fContenido    = @;
     fHoy          = @;

     aNifQbf1   = "";
     aNifQbf2   = "";

     &eaVarDni  = "";
     &enCalcCif = 0;
|FIN;

|PROCESO Tipo12Fw4; |TIPO 12;
     |SI FSalida ! 7;
          |SI #804#16 = "01.01.0000";
               aMensaje = "0000Por favor introduzca la fecha inicio del contrato.";
               |MENAV aMensaje;
               |POSICIONATE #804#16;
               |ERROR;
               |ACABA;
          |SINO;
               aAux1 = #804#11;
               |QBF aAux1;
               |SI aAux1 = "";
                    aMensaje = "0000Por favor introduzca CIF/NIF.";
                    |MENAV aMensaje;
                    |POSICIONATE #804#11;
                    |ERROR;
                    |ACABA;
               |FINSI;
               aAux1 = #804#4;
               |QBF aAux1;
               |SI aAux1 = "";
                    aMensaje = "0000Por favor introduzca Nombre Cliente.";
                    |MENAV aMensaje;
                    |POSICIONATE #804#4;
                    |ERROR;
                    |ACABA;
               |FINSI;
               aAux1 = #804#6;
               |QBF aAux1;
               |SI aAux1 = "";
                    aMensaje = "0000Por favor introduzca Direccion Cliente.";
                    |MENAV aMensaje;
                    |POSICIONATE #804#6;
                    |ERROR;
                    |ACABA;
               |FINSI;

               nSwError = 0;
               |HAZ Tipo0C17Fw4;
               |SI nSwError = 1;
                    |ERROR;
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BuscaFechaCto;
     nBuscaCto = 0;

     |SI #2000#0 = #804#0;  |ACABA;  |FINSI;

     |SI fDFecha ] #2000#16;  |Y fHFecha [ #2000#17;
         nBuscaCto = #2000#0;
         nSwError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     |SI fDFecha < #2000#16;  |Y fHFecha > #2000#17;
         nBuscaCto = #2000#0;
         nSwError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     |SI fDFecha ] #2000#16;  |Y fDFecha [ #2000#17;
         nBuscaCto = #2000#0;
         nSwError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     |SI fHFecha ] #2000#16;  |Y fHFecha [ #2000#17;
         nBuscaCto = #2000#0;
         nSwError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaFechaCto;
     #2000#2003;
     ;
     #804#1, #804#2, 00000001;
     #804#1, #804#2, 99999999;
     ;
     NULL, BuscaFechaCto;
|FIN;

|PROCESO BuscaFechaRes;
     nBuscaRes = 0;

     |SI fDFecha ] #2000#11;  |Y fHFecha [ #2000#12;
         nBuscaRes = #2000#0;
         nSwError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     |SI fDFecha < #2000#11;  |Y fHFecha > #2000#12;
         nBuscaRes = #2000#0;
         nSwError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     |SI fDFecha ] #2000#11;  |Y fDFecha [ #2000#12;
         nBuscaRes = #2000#0;
         nSwError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;

     |SI fHFecha ] #2000#11;  |Y fHFecha [ #2000#12;
         nBuscaRes = #2000#0;
         nSwError = 1;
         |ERROR10;
         |ACABA;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaFechaRes;
     #2000#2003;
     ;
     #804#1, #804#2, 00000001;
     #804#1, #804#2, 99999999;
     ;
     NULL, BuscaFechaRes;
|FIN;

|PROCESO prorrogas;
     nHayProrrogas = 1;

     |SI nProrroga = #2000#1;
         |ERROR10;
         |ACABA;
     |FINSI;

     fDFecha = #2000#2;
     fHFecha = #2000#4;
     |SI #804#17 < fHFecha;             || si cancelacion es menor
          fHFecha = #804#17;            ||/a la desde, coge cancelacion
     |FINSI;
|FPRC;

|DEFBUCLE prorrogas;
     #2000#1002;
     ;
     nContrato, 01;
     nContrato, 99;
     ;
     NULL, prorrogas;
|FIN;

|PROCESO vipem017;
     nHayFacturas = 1;

     aAlfa   = "01." + (("00" + #917#2) % -102) + "." + #917#1;

     fFFecha    = aAlfa;
     nMeses     = 1 / 1000;
     fFFecha    = fFFecha + nMeses;
     nMeses     = fFFecha;
     nMeses     = nMeses - 1;
     fFFecha    = nMeses;
|FPRC;

|DEFBUCLE vipem017;
     #917#3;
     ;
     nContrato, 0000, 00;
     nContrato, 9999, 99;
     ;
     NULL, vipem017;
|FIN;

|PROCESO SacaProrrogas;
     nContrato = #804#0;      || guarda nro. de contrato

     fDFecha   = #804#16;     || desde contrato
     fHFecha   = #804#34;     || hasta contrato
     |SI #804#17 < #804#34;             || si cancelacion es menor
          fHFecha = #804#17;            ||/a la desde, coge cancelacion
     |FINSI;

     nHayProrrogas = 0;
     |DDEF aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "vipem021";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |BUCLE prorrogas;
          |DESCARGA_DEF #referen@;
     |SINO;
          |MENAV "0000[vipem021.mas] no accesible. Consulte con su distribuidor.";
     |FINSI;

     fFFecha = "01.01.0000";
     nHayFacturas = 0;
     |BUCLE vipem017;         || busca si hay facturacion hecha para
                              ||/no dejar meter fechas inferiores a ella

/*
     |SI #804#17 = "01.01.0000";   || cancelacion vacia
          |MENAV "0000Cancelacion vacia.";
          |ERROR;
     |FINSI;

     |SI #804#17 < fDFecha;        || cancelacion menor a inicio
          |AVISO;
          |CONFI "0000NCancelacion menor a la fecha de inicio. Continuar?";
          |SI FSalida ! 0;
               |ERROR;
          |FINSI;
     |FINSI;
*/

     |SI #804#17 > fHFecha;        || cancelacion mayor a finalizacion
          |MENAV "0000Cancelacion incorrecta. Se ajustara automaticamente.";
          #804#17 = fHFecha;
          |PINTA #804#17;
     |FINSI;
|FPRC;

|PROCESO Tipo12Fm21;  |TIPO 12;
     |GRABA 020#921a;
     |LIBERA #921;

     nProrroga = 0;
     |HAZ SacaProrrogas;

     |DDEF aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "vipem007";
     |CARGA_DEF aAlfa, referen@;
     nSwError = 0;
     |BUCLE BuscaFechaCto;
     |DESCARGA_DEF #referen@;
     |SI nSwError = 1;
         aMensaje = "0000Contrato [" + nBuscaCto + "] vigente en esta fecha.";
         |MENAV aMensaje;
         |ERROR;
         |POSICIONATE #921#2;
         |ACABA;
     |FINSI;

     |DDEF aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "vipem020";
     |CARGA_DEF aAlfa, referen@;
     nSwError = 0;
     |BUCLE BuscaFechaRes;
     |DESCARGA_DEF #referen@;
     |SI nSwError = 1;
         aMensaje = "0000Reserva [" + nBuscaRes + "] vigente en esta fecha.";
         |MENAV aMensaje;
         nSwError = 0;
         |POSICIONATE #921#2;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO Tipo2Fm21;  |TIPO 2;
     nForma = (FEntrada / 100) ! 0;
     |SI nForma ! 3;  |ACABA;  |FINSI;

     nProrroga = #921#1;
     |HAZ SacaProrrogas;
|FPRC;

|PROCESO Tipo3Fm21;  |TIPO 3;
     nForma = (FEntrada / 100) ! 0;
     |SI nForma ! 1;  |ACABA;  |FINSI;

     #804#17 = #921#4;   || deja como fin la fecha hasta de la nueva prorroga
     |PINTA #804#17;
     |HAZ CompruebaCancelacion;
|FPRC;

|PROCESO Tipo7C2Fm21; |TIPO 7;
     nForma = (FEntrada / 100) ! 0;
     |SI nForma = 1;
          nNume1 = #804#17;
          nNume1 = nNume1 + 1;
          #921#2 = nNume1;
          |PINTA #921#2;
     |FINSI;
|FPRC;

|PROCESO Tipo0C36_w004; |TIPO 0;
     |SI #vipew004#36 = 0;
          #vipew004#37 = 0;
          #vipew004#38 = 0;
          #vipew004#39 = 0;
          #vipew004#40 = 0;
          #vipew004#41 = 0;
          #vipew004#60 = "";
          |C_M #vipew004#37, 1, "N";
          |C_M #vipew004#38, 1, "N";
          |C_M #vipew004#39, 1, "N";
          |C_M #vipew004#40, 1, "N";
          |C_M #vipew004#41, 1, "N";
          |C_M #vipew004#60, 1, "N";
      |SINO;
          |SI #vipew004#36 = 1;
               #vipew004#38 = 0;
               #vipew004#39 = 0;
               #vipew004#40 = 0;
               #vipew004#41 = 0;
               |C_M #vipew004#37, 1, "S";
               |C_M #vipew004#38, 1, "N";
               |C_M #vipew004#39, 1, "N";
               |C_M #vipew004#40, 1, "N";
               |C_M #vipew004#41, 1, "N";
          |FINSI;
          |SI #vipew004#36 = 2;
               #vipew004#39 = 0;
               #vipew004#40 = 0;
               #vipew004#41 = 0;
               |C_M #vipew004#37, 1, "S";
               |C_M #vipew004#38, 1, "S";
               |C_M #vipew004#39, 1, "N";
               |C_M #vipew004#40, 1, "N";
               |C_M #vipew004#41, 1, "N";
          |FINSI;
          |SI #vipew004#36 = 3;
               #vipew004#40 = 0;
               #vipew004#41 = 0;
               |C_M #vipew004#37, 1, "S";
               |C_M #vipew004#38, 1, "S";
               |C_M #vipew004#39, 1, "S";
               |C_M #vipew004#40, 1, "N";
               |C_M #vipew004#41, 1, "N";
          |FINSI;
          |SI #vipew004#36 = 4;
               #vipew004#41 = 0;
               |C_M #vipew004#37, 1, "S";
               |C_M #vipew004#38, 1, "S";
               |C_M #vipew004#39, 1, "S";
               |C_M #vipew004#40, 1, "S";
               |C_M #vipew004#41, 1, "N";
          |FINSI;
          |SI #vipew004#36 = 5;
               |C_M #vipew004#37, 1, "S";
               |C_M #vipew004#38, 1, "S";
               |C_M #vipew004#39, 1, "S";
               |C_M #vipew004#40, 1, "S";
               |C_M #vipew004#41, 1, "S";
          |FINSI;
          |C_M #vipew004#60, 1, "S";
     |FINSI;
     |PINTA #vipew004#37;
     |PINTA #vipew004#38;
     |PINTA #vipew004#39;
     |PINTA #vipew004#40;
     |PINTA #vipew004#41;
     |PINTA #vipew004#60;
|FPRC;

|PROCESO Tipo0C2Fm21; |TIPO 0;
     nProrroga  = #921#1;
     |HAZ SacaProrrogas;

     |SI #921#2 < fDFecha;
         |MENAV "0000Fecha inferior a la inicial.";
         |ERROR;
     |FINSI;

     |SI #921#2 [ fHFecha;
         |MENAV "0000Fecha inferior a la de cancelacion o finalizacion.";
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO Tipo0C3Fm21; |TIPO 0;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     nContenido = Contenido;
     nMeses     = #921#3 / 1000;
     #921#4     = #921#2 + nMeses;
     nMeses     = #921#4;
     nMeses     = nMeses - 1;
     #921#4     = nMeses;
     |PINTA #921#4;
|FPRC;

|PROCESO Tipo0C33Fw4; |TIPO 0;
     nContenido = Contenido;
     nMeses     = #804#33 / 1000;
     #804#34    = #804#16 + nMeses;
     nMeses     = #804#34;
     nMeses     = nMeses - 1;
     #804#34    = nMeses;
     |PINTA #804#34;
     |SI #804#17 = "01.01.0000";|O nContenido ! #804#33;
                                   || si han cambiado los meses
          #804#17 = #804#34;       ||/o es la primera vez
          |PINTA #804#17;
     |FINSI;

     nProrroga = 0;
     |HAZ SacaProrrogas;
|FPRC;

|PROCESO Tipo0C28Fw4; |TIPO 0;
     |ABRE #916;
     |DDEFECTO #916;
     #916#0 = #804#28;
     |LEE 000#916.=;
     #804#30 = #916#1;
     |PINTA #804#30;
     |CIERRA #916;
|FPRC;

|PROCESO Tipo0C42Fw4; |TIPO 0;
     |ABRE #agifa091;
     |DDEFECTO #agifa091;
     #agifa091#0 = #804#42;
     |LEE 000#agifa091.=;
     #804#43 = #agifa091#1;
     |PINTA #804#43;
     |CIERRA #agifa091;
|FPRC;



|PROCESO Tipo0C20Fw4; |TIPO 0;
     |SI #804#20 = "C";
          |C_M #804#21, 1, "N";
          aFecha = #804#16;
          |QBF aFecha;
          aMes = aFecha % 402;
          nMes = aMes;
          |SI nMes < 1; |O nMes > 12;
               #804#21 = 1;
          |SINO;
               #804#21 = nMes;
          |FINSI;
     |SINO;
          |SI #804#20 = "I";
               |C_M #804#21, 1, "N";
               #804#21 = 1;
          |SINO;         || #804#20 = "M"
               |C_M #804#21, 1, "S";
          |FINSI;
     |FINSI;
     |PINTA #804#21;
|FPRC;

|PROCESO Tipo0C17Fw4; |TIPO 0;
     nProrroga = 0;
     |HAZ SacaProrrogas;

     |HAZ CompruebaCancelacion;
|FPRC;

|PROCESO CompruebaCancelacion;
     nSwError = 0;
     |SI #804#17 < fFFecha;   || se ha facturado con posterioridad a la fecha
                              ||/de cancelacion informada
         nSwError = 1;
         aMensaje = "0000NCancelacion incorrecta. Ya se ha facturado hasta el [" + fFFecha + "]. Continuar?";
         |AVISO;
         |CONFI aMensaje;
         |SI FSalida ! 0;
              |ERROR;
              |ACABA;
         |FINSI;
     |FINSI;

     |DDEF aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "vipem007";
     |CARGA_DEF aAlfa, referen@;
     nSwError = 0;
     |BUCLE BuscaFechaCto;
     |DESCARGA_DEF #referen@;
     |SI nSwError = 1;
         aMensaje = "0000Contrato [" + nBuscaCto + "] vigente en esta fecha.";
         |MENAV aMensaje;
         |ERROR;
         |POSICIONATE #804#16;
         |ACABA;
     |FINSI;

     |DDEF aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "vipem020";
     |CARGA_DEF aAlfa, referen@;
     nSwError = 0;
     |BUCLE BuscaFechaRes;
     |DESCARGA_DEF #referen@;
     |SI nSwError = 1;
         aMensaje = "0000Reserva [" + nBuscaRes + "] vigente en esta fecha.";
         |MENAV aMensaje;
         nSwError = 0;
         |POSICIONATE #804#16;
         |ACABA;
     |FINSI;
|FPRC;


|PROCESO Tipo0C16Fw4; |TIPO 0;
     fContenido = Contenido;
     |SI fContenido ! #804#16;
          #804#34 = "01.01.0000";       || si se cambia el desde obliga a
          #804#17 = "01.01.0000";       ||/recalcular
          |PINTA #804#34;
          |PINTA #804#17;
     |FINSI;
     |HAZ Tipo0C20Fw4;
|FPRC;


|PROCESO CtrlCCC;
     nCampo = Campo;
     aTestea = #vipew004#nCampo#;
     |HAZ EsSoloNumero;
     |SI nErrorNumero = 1;
          aMensaje = "0000Error: Campo numerico";
          |MENAV aMensaje;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO EsSoloNumero;
     ||aTestea
     nErrorNumero = 0;
     |QBF aTestea;
     aLong = aTestea % A0;
     nLong = aLong;
     |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
          nSaca = 100 * nVoy;
          nSaca = nSaca + 1;
          aSaca = nSaca;
          aLetra = aTestea % aSaca;
          |SI aLetra ] "0"; |Y aLetra [ "9";
               ||TODO CORRECTO
          |SINO;
               nErrorNumero = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;


|PROCESO Tipo0C12Fw4;       ||DC
     |HAZ CtrlCCC;
     |SI nErrorNumero = 1;
          |ACABA;
     |FINSI;

     eaEntidad  = #804#14; |QBF eaEntidad; eaEntidad = eaEntidad % 104;
     eaSucursal = #804#15; |QBF eaSucursal; eaSucursal = eaSucursal % 104;
     eaCuenta   = #804#12; |QBF eaCuenta; eaCuenta = eaCuenta % 110;
     eaDC       = "";
     |HAZ CalculoDC;
     #804#13 = eaDC;
     |PINTA #804#13;
|FPRC;

|PROCESO Tipo0C11Fw4; TIPO 0;
     |SI Campo = 11;
          |SI FSalida = 10;
              eaVarDni   = #804#11;
              enCalcCif  = 1;
              |HAZ CalculoNIFCIF;
              #804#11 = eaVarDni;
              |PINTA #804#11;
              |ERROR;
              |ACABA;
          |FINSI;

          eaVarDni  = #804#11;
          enCalcCif = 0;
          |HAZ CalculoNIFCIF;
          aNifQbf1 = #804#11;   |QBF aNifQbf1;
          aNifQbf2 = eaVarDni;  |QBF aNifQbf2;

          |SI aNifQbf1 ! aNifQbf2; |Y aNifQbf1 ! "";
              |CONFI "0000SEl Nif puede ser Erroneo. Desea Calcularlo.";
              |SI FSalida = 0;
                  #804#11 = eaVarDni;  |PINTA #804#11;
                  |ERROR;
              |FINSI;
          |FINSI;

          |SI enModo = 1;
               aAux = #804#11;
               |QBF aAux;
               |SI aAux ! "";
                    |ABRE #908;
                    |DDEFECTO #908;
                    |LEE 000#908p;
                    |CIERRA #908;

                    |SI #908#15 = "S";
                         |ABRE #agifa024;
                         |SELECT #1#agifa024;
                         #agifa024#0 = #804#45;
                         |LEE 000#agifa024.=;
                         |SI FSalida ! 0;

                              |SELECT #4#agifa024;
                              #agifa024#15 = #804#11;
                              |LEE 000#agifa024.=;
                              |SI FSalida = 0;
                                   aMensaje = "0000El cliente existe con el codigo " + #agifa024#0;
                                   |QBF aMensaje;
                                   |MENAV aMensaje;
                                   |ERROR;
                                   |ACABA;
                              |FINSI;
                         |FINSI;
                         |CIERRA #agifa024;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo0C1Fw4; |TIPO 0;
     #vipem006#0 = #804#1;
     |LEE 000#vipem006.=;
     |SI FSalida = 0;
          #804#24 = #vipem006#1;
          |PINTA #804#24;
     |SINO;
          #804#24 = "";
          |PINTA #804#24;
          aMensaje = "0000No existe Número de Edificio.";
          |MENAV aMensaje;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Baja911w4;
     #911#0 = #804#1;
     #911#1 =  0;
|FPRC;

|PROCESO Alta911w4;
     #911#0 = #804#1;
     #911#1 = 999;
|FPRC;

|PROCESO Tipo66C2Fw4; |TIPO 66;
     |ABRE #911;
     |CONSULTA_F_CLAVE #1#911, Baja911w4, Alta911w4;
     |SI FSalida = 0;
          #804#2 = #911#1;
          |PINTA #804#2;
     |FINSI;
     |CIERRA #911;
|FPRC;

|PROCESO BuscaFechaProOtro;
     |SI fHoy ] #2001#2;  |Y fHoy [ #2001#4;
         nBuscaCtoOtro = #2001#0;
         nBuscaProOtro = #2001#1;
         nSwErrorOtro = 1;
         |ERROR10;
         |ACABA;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaFechaProOtro;
     #2001#1002;
     ;
     #2000#0, 01;
     #2000#0, 99;
     ;
     NULL, BuscaFechaProOtro;
|FIN;

|PROCESO BuscaFechaCtoOtro;
     nBuscaCtoOtro = 0;
     nBuscaProOtro = 0;

     |SI #2000#0 = #804#0;  |ACABA;  |FINSI;

     ||TODO CCC. Tiquet. 2805/948. El que manda es Fecha Cancelacion.
||     |SI fHoy ] #2000#16;  |Y fHoy [ #2000#34;
     |SI fHoy ] #2000#16;  |Y fHoy [ #2000#17;
         nBuscaCtoOtro = #2000#0;
         nBuscaProOtro = 0;
         nSwErrorOtro = 1;
         |ERROR10;
         |ACABA;
     |SINO;
          |BUCLE BuscaFechaProOtro;
          |SI nSwErrorOtro = 1;
               |ERROR10;
               |ACABA;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaFechaCtoOtro;
     #2000#2003;
     ;
     #804#1, #804#2, 00000001;
     #804#1, #804#2, 99999999;
     ;
     NULL, BuscaFechaCtoOtro;
|FIN;

|PROCESO BuscaFechaResOtro;
     nBuscaResOtro = 0;

     |SI fHoy ] #2000#11;  |Y fHoy [ #2000#12;
         nBuscaResOtro = #2000#0;
         nSwErrorOtro = 1;
         |ERROR10;
         |ACABA;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaFechaResOtro;
     #2000#2003;
     ;
     #804#1, #804#2, 00000001;
     #804#1, #804#2, 99999999;
     ;
     NULL, BuscaFechaResOtro;
|FIN;

|PROCESO CompruebaOtroContrato;
     |SI enModo ! 1;
          nSwErrorOtro = 0;
          |ACABA;
     |FINSI;

     fHoy = ~;

     |DDEF aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "vipem007";
     |CARGA_DEF aAlfa, referen@;
     |DDEF aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "vipem021";
     |CARGA_DEF aAlfa, refere1@;
     nSwErrorOtro = 0;
     |BUCLE BuscaFechaCtoOtro;
     |DESCARGA_DEF #refere1@;
     |DESCARGA_DEF #referen@;
     |SI nSwErrorOtro = 1;
         aMensaje = "0000Inmueble con contrato [" + nBuscaCtoOtro + "." + nBuscaProOtro + "] vigente hoy.";
         |MENAV aMensaje;
     |SINO;
          |DDEF aAlfa; |QBF aAlfa;
          aAlfa = aAlfa + "vipem020";
          |CARGA_DEF aAlfa, referen@;
          nSwErrorOtro = 0;
          |BUCLE BuscaFechaResOtro;
          |DESCARGA_DEF #referen@;
          |SI nSwErrorOtro = 1;
              aMensaje = "0000Inmueble con reserva [" + nBuscaResOtro + "] vigente hoy.";
              |MENAV aMensaje;
              nSwErrorOtro = 0;
              |ACABA;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo0C2Fw4; |TIPO 0;
     |ABRE #911;
     #911#0 = #804#1;
     #911#1 = #804#2;
     |LEE 000#911=;
     |SI FSalida = 0;                   ||RPRIEGO - TIQUET 2805-270:
          |HAZ CompruebaOtroContrato;   ||/aunque en las fechas del contrato
          |SI nSwErrorOtro = 0;         ||/se comprueba, el cliente tambien
               ||Ok. Todo correcto.     ||/lo quiere aqui

               |ABRE #908;
               |DDEFECTO #908;
               |LEE 000#908p;
               |CIERRA #908;

     ||ARA
               ||Calcula el codigo de cliente.  SOLO EN ALTA
               ||Formato:
               || Edificio + Contador Veces Arrendado + Inmueble
               ||    2     +            2             +  2

               ||Ahora en el edificio hay un campo que controla si es tipo
               ||(A) se usa 1 digito para contador   (3) para Inmueble
               ||(B) se usan 2 digitos para contador (2) para Inmueble

               |C_M #804#3, 1, "N";

               |SI enModo = 1;

||                    |SI #908#11 = "A";
                         aEdifi = ("00" + #804#1) % -102;
                         nVeces = #911#11;
                         enNumEdificio = #804#1;
                         |HAZ DameTipoContador;
                         |SI eaTipoContador = "A";
                              aVeces = ("00" + nVeces) % -102;
                              aPiso2 = ("00" + #804#2) % -102;
                         |SINO;
                              aVeces = ("0" + nVeces) % -101;
                              aPiso2 = ("000" + #804#2) % -103;
                         |FINSI;
                         aCliente = aEdifi + aVeces + aPiso2;
                         #804#3 = aCliente;
                         |PINTA #804#3;

/*
                         |ABRE #agifa024;
                         #agifa024#0 = aCliente;
                         |LEE 000#agifa024.=;
                         |SI FSalida = 0;
                              ||Ahora ya puede haber contratos del mismo cliente

                              aMensaje = "0000Error: Codigo cliente, Ya existe [" + aCliente + "]";
                              |MENAV aMensaje;
                              |ERROR;
                              |ACABA;
                         |FINSI;
*/

||                    |SINO;

                         |SI #908#11 = "U"; |O #908#11 = "A";    ||Para mi es lo mismo.
                              aAux = #804#45;
                              |QBF aAux;
                              |SI aAux = "000000";
                                   |ABRE #agifa024;
                                   |DDEFECTO #agifa024;
                                   |LEE 000#agifa024.u;
                                   |SI FSalida = 0;
                                        nCliente = #agifa024#0;
                                        nCliente = nCliente + 1;
                                   |SINO;
                                        nCliente = 1;
                                   |FINSI;
                                   |CIERRA #agifa024;
                                   aClienteReal = ("000000" + nCliente) % -106;
                              |FINSI;
                              |C_M #804#3, 1, "S";
                         |SINO;
                              |C_M #804#3, 1, "S";
                              aClienteReal = "000000";
                              ||ARA
                              ||Manual
                         |FINSI;
||                    |FINSI;
                    #804#45 = aClienteReal;
                    |PINTA #804#45;

                    #vipem006#0 = #804#1;
                    |LEE 000#vipem006.=;
                    |SI FSalida = 0;
                         ||ARA
                         aCta = "";
                         |PARA nConta = 11; |SI nConta [ 17; |HACIENDO nConta = nConta + 1;
                              nConta2 = nConta + 7;
                              |SI #906#nConta# = "F";
                                   aCta = aCta + #906#nConta2#;
                              |SINO;
                                   aAux = #906#nConta2#;
                                   nAux = aAux;
                                   |SI nAux = 1;
                                        aCaracter = #804#3 % 101;
                                   |SINO;
                                        |SI nAux = 2;
                                             aCaracter = #804#3 % 201;
                                        |SINO;
                                             |SI nAux = 3;
                                                  aCaracter = #804#3 % 301;
                                             |SINO;
                                                  |SI nAux = 4;
                                                       aCaracter = #804#3 % 401;
                                                  |SINO;
                                                       |SI nAux = 5;
                                                            aCaracter = #804#3 % 501;
                                                       |SINO;    ||6
                                                            aCaracter = #804#3 % 601;
                                                       |FINSI;
                                                  |FINSI;
                                             |FINSI;
                                        |FINSI;
                                   |FINSI;
                                   aCta = aCta + aCaracter;
                              |FINSI;
                         |SIGUE;
                         #804#35 = aCta;
                         |PINTA #804#35;
                    |SINO;
                         #804#24 = "";
                         |PINTA #804#24;
                         aMensaje = "0000No existe Número de Edificio.";
                         |MENAV aMensaje;
                         |POSICIONATE #804#1;
                    |FINSI;
               |FINSI;
          |SINO;
               |ERROR;
          |FINSI;
     |SINO;
          aMensaje = "0000No existe Número de Inmueble para este Edificio";
          |MENAV aMensaje;
          |ERROR;
     |FINSI;
     |CIERRA #911;
|FPRC;

|PROCESO Tipo0C0Fw4; |TIPO 0;
     |SI enModo ! 1;  |ACABA;  |FINSI;

     #907#0 = #804#0;
     |LEE 000#907=;
     |SI FSalida = 0;
         |MENAV "0000 El Codigo de Contrato ya Existe.";
         |POSICIONATE #804#0;
     |FINSI;
|FPRC;

|PROCESO Tipo7C0Fw4; |TIPO 7;
     nProrroga  = 0;
     |HAZ SacaProrrogas;

     |C_M #804#16, 1, "S";   |PINTA #804#16;
     |C_M #804#33, 1, "S";   |PINTA #804#33;

     |SI enModo ! 1;
          |SI nHayFacturas = 1;
              |C_M #804#16, 1, "N";   |PINTA #804#16;
              |C_M #804#33, 1, "N";   |PINTA #804#33;
          |FINSI;

          |SI nHayProrrogas = 1;
              |C_M #804#16, 1, "N";   |PINTA #804#16;
              |C_M #804#33, 1, "N";   |PINTA #804#33;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BuscaActivos;
     |SI fSistema < #2000#17;
          nSwHayActivos = #2000#0;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaActivos;
     #2000#1001;
     45;
     00000001, #804#45;
     99999999, #804#45;
     ;
     NULL, BuscaActivos;
|FIN;

|PROCESO CtrlCli; |TIPO 0;
     ||Ahora es Codigo Inmueble. No tenemos que tener este control
/*

     |SI enModo = 1;

          |ABRE #908;
          |DDEFECTO #908;
          |LEE 000#908p;
          |CIERRA #908;


          ||TODO CCC.   Ahora puede existir el cliente. REVISAR.
          |SI #908#11 = "M"; |O #908#11 = "U";
               |SI #804#45 = "000000";
                    aMensaje = "0000Por favor introduzca el codigo del cliente";
                    |MENAV aMensaje;
                    |ERROR;
                    |ACABA;
               |SINO;
                    |ABRE #agifa024;
                    |SELECT #1#agifa024;
                    #agifa024#0 = #804#45;
                    |LEE 000#agifa024.=;
                    |SI FSalida = 0;
                         |DDEF aAlfa; |QBF aAlfa;
                         aAlfa = aAlfa + "vipem007";
                         |CARGA_DEF aAlfa, referen@;
                         nSwHayActivos = 0;
                         fSistema = ~;
                         ||TODO CCC
                         |BUCLE BuscaActivos;
                         |DESCARGA_DEF #referen@;

                         |SI nSwHayActivos ! 0;
                              |SI #908#15 = "S";
                                   aMensaje = "0000NAtencion. Cliente con contrato [" + nSwHayActivos + "] activo. Continuar?";
                                   |CONFI aMensaje;
                                   |SI FSalida ! 0;
                                        |HAZ Vacia804;
                                        |ERROR;
                                        |ACABA;
                                   |FINSI;
                              |FINSI;
                         |FINSI;

                         #804#4 = #agifa024#1;
                         #804#5 = #agifa024#2;
                         #804#6 = #agifa024#8;
                         #804#7 = #agifa024#9;
                         #804#8 = #agifa024#10;
                         #804#9 = #agifa024#181;
                         #804#10 = #agifa024#182;
                         #804#11 = #agifa024#15;
                         #804#31 = #agifa024#17;
                         #804#32 = #agifa024#197;
                         #804#44 = #agifa024#163;

                         #804#42 = #agifa024#20;
                         |HAZ Tipo0C42Fw4;

                         #804#14 = #agifa024#32;
                         #804#15 = #agifa024#33;
                         #804#13 = #agifa024#31;
                         #804#12 = #agifa024#30;

                         #804#61 = #agifa024#205;      ||PAIS
                         #804#62 = #agifa024#14;
                    |SINO;
                         |HAZ Vacia804;
                    |FINSI;
                    |PINDA #0#804;
               |FINSI;
          |FINSI;
     |FINSI;
*/
|FPRC;

|PROCESO CtrlNomCli; |TIPO 0;
     |SI enModo = 1;

          |ABRE #908;
          |DDEFECTO #908;
          |LEE 000#908p;
          |CIERRA #908;

          |SI #908#15 = "S";
               |ABRE #agifa024;
               |SELECT #1#agifa024;
               #agifa024#0 = #804#45;
               |LEE 000#agifa024.=;
               |SI FSalida ! 0;
                    aAux = #804#4;
                    |QBF aAux;
                    |SI aAux ! "";
                         |SELECT #2#agifa024;
                         #agifa024#1 = #804#4;
                         |LEE 000#agifa024.=;
                         |SI FSalida = 0;
                              aMensaje = "0000El cliente existe con el codigo " + #agifa024#0;
                              |QBF aMensaje;
                              |MENAV aMensaje;
                              |ERROR;
                              |ACABA;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |CIERRA #agifa024;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Vacia804;
     #804#4 = "";
     #804#5 = "";
     #804#6 = "";
     #804#7 = "";
     #804#8 = "";
     #804#9 = 0;
     #804#10 = 0;
     #804#11 = "";
     #804#31 = "";
     #804#32 = "";
     #804#42 = "";
     #804#43 = "";
     #804#14 = "";
     #804#15 = "";
     #804#13 = "";
     #804#12 = "";


     |PINTA #804#4;
     |PINTA #804#5;
     |PINTA #804#6;
     |PINTA #804#7;
     |PINTA #804#8;
     |PINTA #804#9;
     |PINTA #804#10;
     |PINTA #804#11;
     |PINTA #804#31;
     |PINTA #804#32;
     |PINTA #804#42;
     |PINTA #804#43;
     |PINTA #804#14;
     |PINTA #804#15;
     |PINTA #804#13;
     |PINTA #804#12;
|FPRC;

|PROCESO Tipo0C46_w004; |TIPO 0;
     |SI #vipew004#46 = "S";
          |C_M #vipew004#47, 1, "S";
          |C_M #vipew004#48, 1, "S";
     |SINO;
          |C_M #vipew004#47, 1, "N";
          |C_M #vipew004#48, 1, "N";
     |FINSI;
     |PINTA #vipew004#47;
     |PINTA #vipew004#48;
|FPRC;

|PROCESO Tipo0C53_w004; |TIPO 0;
     |SI #vipew004#53 = "S";
          |C_M #vipew004#54, 1, "S";
     |SINO;
          |C_M #vipew004#54, 1, "N";
     |FINSI;
     |PINTA #vipew004#54;
|FPRC;

|PROCESO Tipo0C55_w004; |TIPO 0;
     |SI #vipew004#55 = "S";
          |C_M #vipew004#56, 1, "S";
     |SINO;
          |C_M #vipew004#56, 1, "N";
     |FINSI;
     |PINTA #vipew004#56;
|FPRC;

|PROCESO Tipo0C45_w004; |TIPO 0;
     |SI enModo = 1;
          |ABRE #agifa024;
          #agifa024#0 = #vipew004#45;
          |LEE 000#agifa024.=;
          |SI FSalida = 0;
               #vipew004#44 = #agifa024#163;
               |PINTA #vipew004#44;

               |SI #908#15 = "S"; |Y #908#16 = "S";       ||Es SPA y Control existencia Cliente
                    |DDEF aAlfa; |QBF aAlfa;
                    aAlfa = aAlfa + "vipem007";
                    |CARGA_DEF aAlfa, referen@;
                    nSwHayActivos = 0;
                    fSistema = ~;
                    ||TODO CCC
                    |BUCLE BuscaActivos;
                    |DESCARGA_DEF #referen@;

                    |SI nSwHayActivos ! 0;
                         aMensaje = "0000Atencion. Cliente con contrato [" + nSwHayActivos + "] activo.";
                         |MENAV aMensaje;
                         |HAZ Vacia804;
                         |ERROR;
                         |ACABA;
                    |FINSI;
              |FINSI;
          |FINSI;
          |CIERRA #agifa024;
     |FINSI;
|FPRC;
