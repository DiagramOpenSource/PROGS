|FICHEROS;
     dsz99986 #0,MANTE;
     referen@ #1;     ||dsm00046,...,dsm00051,
                      ||dsm00064, dsm00065, dsm00066, dsm00068
                      ||dsm00070 (para 004182)
     dsm00044 #44;
     agifa073 #73;
     agifa071 #71;
     agifa069 #69;
     agifa070 #70;
     agi00028 #28;
     agifa067 #67;
     agifa080 #80;

     agifa017 #17;
     agifa019 #19;
     agifa147 #147;
     agifa502 #502;
     agifa142 #142;
     dsm00055 #55;
     agifa007 #7;
     agifa048 #480;
     agifa049 #49;
     dsm00238 #238;
     dsm00139 #139;

     berm0002@;
     berm0003@;
     berm0004@;
     berm0008@;
     berm0009@;
|FIN;

|VARIABLES;
     &enSwNoLinealDesglose = 0;    ||En el SacaKit, no saca el lineal de desglose.
     &enImpGesKit = 0;             ||Modulo 004182

     nSwTagloma = 0;
     nSwBerria = 0;
     nSwGesenvia = 0;
     nForma = 0;
     nFactu = 0;
     nPrecio = 0;
     nCampo = 0;
     nTari = 0;
     nGuarda = 0;
     nEsKit = 0;
     &enUniKit = 0;
     &nDeci_Uni= 0;
     &nDispoKit= 0;
     &Tempo    = "";
     nNume     = 0;
     nAlmaSer  = 0;
     nAlmaDoc  = 0;
     aTempo0   = "";
     aProg     = "";
     aArti     = "";
     aAlfa     = "";
     aBase     = "";
     aSer      = "";
     aRef      = "";
     nModo     = 0;
     nLin      = 0;
     nLinKit   = 0;
     nNum      = 0;
     nNoHay    = 0;
     nFalta    = 0;
     nUni      = 0;
     nNeceUni  = 0;
     aTipo = "";
     aPath = "";
|FIN;

|INCLUYE i_varart;
|INCLUYE i_escank;

|PROCESO HallaProgKit;
     |HAZ EsBerria; nSwBerria = FSalida;
     |HAZ EsGesenvia; nSwGesenvia = FSalida;
     |HAZ EsTagloma; nSwTagloma = FSalida;

     nModo = (FEntrada / 100) ! 0;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     nDeci_Uni = #142#8;
     aRef = "";
     |MODULO aProg;

     |SI aProg = "dsz00071"; aProg = "agifa501"; |FINSI;
     |SI aProg = "psioa010"; aProg = "agifa084"; |FINSI;
     |SI aProg = "psioa012"; |O aProg = "coimz020";
          aProg = "agifa104";
     |FINSI;

     |SI aProg = "dsz99953"; |O aProg = "dsz99914";
               |O aProg = "psion008"; |O aProg = "psioa008";
          aProg = "agifa010";
     |FINSI;

     |SI aProg = "dsm00054";
          aRef = "dsm00068";
          aArti = #55#0;
          aSer = #55#28;
          nNum = #55#27;
          nLin = #55#11;
          nUni = #55#4;
          nAlmaDoc = #55#1;
     |FINSI;
     |SI aProg = "agifa010"; |O aProg = "agifa210"; |O aProg = "agifa033";
               |O aProg = "agifa134"; |O aProg = "dsm01000";
          aRef = "dsm00047";
          aArti = #71#2;
          aSer = #71#29;
          nNum = #71#0;
          nLin = #71#1;
          nUni = #71#5;
          nAlmaDoc = #71#3;
     |FINSI;
     |SI aProg = "agifa104"; |O enProg211 ! 0;
          aRef = "dsm00046";
          aArti = #73#2;
          aSer = #73#28;
          nNum = #73#0;
          nLin = #73#1;
          nUni = #73#5 - #73#43;
          nAlmaDoc = #73#3;
     |FINSI;
     |SI aProg = "agifa084";
          aRef = "dsm00048";
          aArti = #69#2;
          aSer = #69#20;
          nNum = #69#0;
          nLin = #69#1;
          nUni = #69#5;
          nAlmaDoc = #69#3;
     |FINSI;
     |SI aProg = "agifa036";
          aRef = "dsm00049";
          aArti = #70#2;
          aSer = #70#22;
          nNum = #70#0;
          nLin = #70#1;
          nUni = #70#5;
          nAlmaDoc = #70#3;
     |FINSI;
     |SI aProg = "agifa146";
          aRef = "dsm00050";
          aArti = #147#2;
          aSer = #147#20;
          nNum = #147#0;
          nLin = #147#1;
          nUni = #147#5;
          nAlmaDoc = #147#3;
     |FINSI;
     |SI aProg = "agifa501"; |O aProg = "agifa503";
          aRef = "dsm00051";
          aArti = #502#2;
          aSer = #502#20;
          nNum = #502#0;
          nLin = #502#1;
          nUni = #502#5;
          nAlmaDoc = #502#3;
     |FINSI;
     |SI aProg = "agi00027";
          aRef = "dsm00064";
          aArti = #28#2;
          aSer = "";
          nNum = #28#0;
          nLin = #28#1;
          nUni = #28#5;
          nAlmaDoc = 0;
     |FINSI;
     |SI aProg = "agifa081";
          aRef = "dsm00065";
          aArti = #67#2;
          aSer = #67#28;
          nNum = #67#0;
          nLin = #67#1;
          nUni = #67#5;
          nAlmaDoc = #67#3;
     |FINSI;
     |SI aProg = "agifa077"; |O aProg = "agifa212"; |O aProg = "dsm00140";
          aRef = "dsm00066";
          aArti = #80#2;
          aSer = #80#27;
          nNum = #80#0;
          nLin = #80#1;
          nUni = #80#5;
          nAlmaDoc = #80#3;
     |FINSI;
     |SI aProg = "dsm00138"; |O aProg = "dsm00142";
          aRef = "dsm00069";
          aArti = #139#2;
          aSer = #139#28;
          nNum = #139#0;
          nLin = #139#1;
          nUni = #139#5;
          nAlmaDoc = #139#3;
     |FINSI;

     |SI aProg = "dsm00043";
          aRef = "dsm00070";
          aArti = #44#0;
          aSer = #44#21;
          nNum = #44#18;
          nLin = #44#8;
          nUni = #44#4;
          nAlmaDoc = #44#1;
     |FINSI;

     |SI nSwBerria = 0;  ||Solo existen kits en pedidos
          |SI aProg ! "agifa104"; aRef = ""; |FINSI;
     |FINSI;

     |SI aRef = ""; |ACABA; |FINSI;

     |DBASE aBase;
     aRef = aBase + "def/" + aRef;

     |ABRE #7;
     #7#26 = aSer;
     |LEE 000#7=;
     |CIERRA #7;
     nAlmaSer = #7#29;

     aTipo = #142#12;
     |SI aTipo = "X";
          |ABRE #480;
          #480#0 = aArti;
          |LEE 000#480=;
          |SI FSalida = 0;
               aTipo = #480#33;
          |FINSI;
          |CIERRA #480;
     |FINSI;
|FPRC;

|PROCESO LeeArtiKit;
     nFactu = 1;
     #19#0 = #0#3;
     |LEE 020#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;
     |DDEFECTO #17;
     #17#0 = #0#3;
     #17#1 = #0#4;
     |LEE 000#17=;
     |SI FSalida ! 0; |DDEFECTO #17; |FINSI;
     |SI #19#179 = "S";
          #238#0 = #19#201;
          |LEE 000#238=;
          |SI FSalida = 0; |Y #238#6 = 2;
               nFactu = 2;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Borra;
     |BORRA 020#1a;
|FPRC;

|DEFBUCLE Borra;
     #1#1004;
     ;
     aSer, nNum, nLin, 001;
     aSer, nNum, nLin, 999;
     be;
     NULL, Borra;
|FIN;

|PROCESO Carga;
     #1#0 = aSer;
     #1#1 = nNum;
     #1#2 = nLin;
     #1#3 = #0#3;
     #1#4 = #0#4;
     #1#5 = #0#5;
     #1#6 = #0#6;
     #1#7 = #0#8;
     #1#8 = #0#10;
     #1#9 = #0#11;
     #1#10 = #0#12;
     #1#11 = #0#13;
     #1#12 = #0#14;
     #1#13 = #0#15;
     |GRABA 020#1n;
     enImpGesKit = enImpGesKit + (#0#5 * #0#10);
|FPRC;

|DEFBUCLE Carga;
     #0#1;
     ;
     001;
     999;
     ;
     NULL, Carga;
|FIN;

|PROCESO CargaKit;
     |CARGA_DEF aRef, referen@;
     |SI FSalida = 0;
          |BUCLE Borra;  || Me aseguro de que no exista nada
          |ABRE #1;
          |BUCLE Carga;
          |CIERRA #1;
          |DESCARGA_DEF #referen@;
     |SINO;
          aAlfa = "0000[" + FSalida + "]Carga. Error al cargar " + aRef;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO BorrKit;
     |CARGA_DEF aRef, referen@;
     |SI FSalida = 0;
          |BUCLE Borra;  || Me aseguro de que no exista nada
          |DESCARGA_DEF #referen@;
     |SINO;
          aAlfa = "0000[" + FSalida + "]Borra. Error al cargar " + aRef;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO Descarga;
     |DDEFECTO #0;
     nLinKit = nLinKit + 1;
     #0#0 = aSer;
     #0#1 = nNum;
     #0#2 = nLin;
     #0#3 = #1#3;
     #0#4 = #1#4;
     #0#5 = #1#5
     #0#6 = nLinKit;
     |HAZ LeeArtiKit;
     #0#7 = #19#1;
     #0#8 = #1#7;
     #0#9 = #17#39;
     #0#10 = #1#8;
     #0#11 = #1#9;
     #0#12 = #1#10;
     #0#13 = #1#11;
     #0#14 = #1#12;
     #0#15 = #1#13;
     |GRABA 020#0n;
     |SI FSalida = 0;
          nForma = 1;
          |HAZ TagloPreKit;
     |FINSI;
|FPRC;

|DEFBUCLE Descarga;
     #1#1004;
     ;
     aSer, nNum, nLin, 001;
     aSer, nNum, nLin, 999;
     ;
     NULL, Descarga;
|FIN;

|PROCESO DescargaKit;
     |CARGA_DEF aRef, referen@;
     |SI FSalida = 0;
          |BUCLE Descarga;
          |DESCARGA_DEF #referen@;
     |SINO;
          aAlfa = "0000[" + FSalida + "]Descarga. Error al cargar " + aRef;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO berm0003;
     #berm0009@#0 = aSer;
     #berm0009@#1 = nNum;
     #berm0009@#2 = nLin;
     #berm0009@#3 = #49#1; ||nLinKit;
     #berm0009@#4 = #berm0003@#2;
     #berm0009@#5 = #berm0003@#3;
     #berm0009@#6 = #berm0003@#4;
     |SI #berm0002@#26 = "M";
          #berm0009@#7 = #berm0003@#6;
     |FINSI;
     |SI #berm0009@#7 = "S";
          #berm0008@#16 = #berm0009@#5;
          #berm0008@#17 = #berm0009@#6;
          aAlfa = #berm0009@#5;
     |FINSI;
     #berm0009@#8 = #berm0003@#5;
     |GRABA 020#berm0009@.n;
|FPRC;

|DEFBUCLE berm0003;
     #berm0003@#1003;
     ;
     #49#0, #49#1, 001;
     #49#0, #49#1, 999;
     ;
     NULL, berm0003;
|FIN;

|PROCESO LinKit;
     nLinKit = nLinKit + 1;

     |SI nSwBerria = 0;
          |DDEFECTO #berm0002@;
          #berm0002@#0 = #49#0;
          #berm0002@#1 = #49#1;
          |LEE 000#berm0002@.=;

          |DDEFECTO #berm0008@;
          #berm0008@#0 = aSer;
          #berm0008@#1 = nNum;
          #berm0008@#2 = nLin;
          #berm0008@#3 = aEscan;
          #berm0008@#4 = nAlmaDoc;
          |SI #142#215 = "E"; #berm0008@#4 = nAlmaEscan; |FINSI;
          |SI #142#215 = "S"; #berm0008@#4 = nAlmaSer; |FINSI;
          #berm0008@#5 = #berm0008@#5 + nCantiEscan;
          #berm0008@#6 = #49#1; ||nLinKit;

          #0#3 = #berm0008@#3;
          #0#4 = #berm0008@#4;
          |HAZ LeeArtiKit;

          #berm0008@#7 = #49#7;
          #berm0008@#8 = #19#9;
          #berm0008@#9 = #49#17;
          #berm0008@#10 = #49#18;
          #berm0008@#11 = #49#19;
          #berm0008@#12 = #49#20;
          #berm0008@#13 = #berm0002@#24;
          #berm0008@#14 = #19#1;
          #berm0008@#18 = #berm0002@#22;
          aAlfa = #berm0008@#3;
          |SI #berm0008@#13 = "N";
               |BUCLE berm0003;
          |FINSI;

          #17#0 = aAlfa;
          #17#1 = #berm0008@#4;
          |LEE 000#17=;
          |SI FSalida = 0;
               #berm0008@#15 = #17#39;
          |FINSI;

          #berm0004@#0 = #berm0008@#18;
          |LEE 000#berm0004@.=;
          |SI FSalida = 0;
               #berm0008@#19 = #berm0004@#1;
          |FINSI;

          |GRABA 020#berm0008@.n;
     |SINO;    || la estandar
          |DDEFECTO #0;
          #0#0 = aSer;
          #0#1 = nNum;
          #0#2 = nLin;
          #0#3 = aEscan;
          #0#4 = nAlmaDoc;
          |SI #142#215 = "E"; #0#4 = nAlmaEscan; |FINSI;
          |SI #142#215 = "S"; #0#4 = nAlmaSer; |FINSI;
          #0#5 = #0#5 + nCantiEscan;
          #0#6 = nLinKit;
          |HAZ LeeArtiKit;
          #0#7 = #19#1;
          #0#9 = #17#39;
          aAlfa = aRef % -108;
          |SI nSwGesenvia = 0; |Y aAlfa = "dsm00066";  || alb.compras
               #0#10 = #49#6;
          |SINO;
               #0#10 = #19#9;
          |FINSI;

          #0#11 = #49#17;
          #0#12 = #49#18;
          #0#13 = #49#19;
          #0#14 = #49#20;
          |GRABA 020#0n;
          |SI FSalida = 0;
               nForma = 1;
               |HAZ TagloPreKit;
          |FINSI;
     |FINSI;
|FPRC;

|RUTINA MaxKit;
     #0#6 = 999;
|FRUT;

|RUTINA MinKit;
     #0#6 = 1;
|FRUT;

|PROCESO SacaKit;
     eaModiKit = "N";
     enPreKitCal = 0;
     |HAZ HallaProgKit;

     |SI aRef = ""; |ACABA; |FINSI;

     |SI aTipo ! "K";
          |HAZ BorrKit;  || Por si se ha modificado el articulo
          |ACABA;
     |FINSI;

     |SI nSwBerria = 0;
          |HAZ SacaKitBerria; |ACABA;
     |FINSI;


     |SI FSalida = 0;
          |HAZ TagloParamKit;
     |FINSI;

     |HAZ CreaTempo; aTempo0 = Tempo;
     |NOME_DAT #0 aTempo0; |DELINDEX #0;

     aEscan = aArti;
     nCantiEscan = 1;
     nMaxNivel = 999;
     nLinKit = 0;
     |ABRE #238;
     |ABRE #17;
     |ABRE #19;
     |ABRE #0;
     |SI nModo = 1; |O aArti ! Contenido;
          nSwVenta = 1;
          eaModiKit= "S";
          |HAZ DesglosaKit;
     |SINO;
          eaModiKit = "N";
          |HAZ DescargaKit;
     |FINSI;
     |LEE 000#0p;
     nNoHay = FSalida;
     |CIERRA #0;
     |SI enSwNoLinealDesglose = 0;
          |SI nNoHay = 0;
               |PUSHV 0501 2380;
               |ENTLINEAL #1#0, -1, 2, 22, 1, MinKit, MaxKit;
               |POPV;
          |FINSI;
     |FINSI;

     enImpGesKit = 0;
     |HAZ CargaKit;

     |CIERRA #19;
     |CIERRA #17;
     |CIERRA #238;
     |DELINDEX #0; Tempo = aTempo0; |HAZ BoraTempo;
|FPRC;

|PROCESO SacaKitPsion;
     eaModiKit = "N";
     enPreKitCal = 0;
     |HAZ HallaProgKit;

     |SI aRef = ""; |ACABA; |FINSI;

     |SI aTipo ! "K";
          |HAZ BorrKit;  || Por si se ha modificado el articulo
          |ACABA;
     |FINSI;

     |SI nSwTagloma = 0;
          |HAZ TagloParamKit;
     |FINSI;

     |HAZ CreaTempo; aTempo0 = Tempo;
     |NOME_DAT #0 aTempo0; |DELINDEX #0;

     aEscan = aArti;
     nCantiEscan = 1;
     nMaxNivel = 999;
     nLinKit = 0;
     |ABRE #238;
     |ABRE #17;
     |ABRE #19;

     |ABRE #0;
     nSwVenta = 1;
     eaModiKit= "S";
     |HAZ DesglosaKit;
     |CIERRA #0;

     |HAZ CargaKit;

     |CIERRA #19;
     |CIERRA #17;
     |CIERRA #238;
     |DELINDEX #0; Tempo = aTempo0; |HAZ BoraTempo;
|FPRC;

|PROCESO BorraKit;
     |HAZ HallaProgKit;

     |SI aRef = ""; |ACABA; |FINSI;

     |SI aTipo ! "K"; |ACABA; |FINSI;

     |SI nSwBerria = 0;
          |HAZ BorraKitBerria; |ACABA;
     |FINSI;

     |CARGA_DEF aRef, referen@;
     |SI FSalida = 0;
          |BUCLE Borra;
          |DESCARGA_DEF #referen@;
     |SINO;
          aAlfa = "0000[" + FSalida + "]Borra. Error al cargar " + aRef;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO VerKit;
     enPreKitCal = 0;
     |HAZ HallaProgKit;

     |SI aRef = ""; |ACABA; |FINSI;

     |SI aTipo ! "K"; |ACABA; |FINSI;

     |SI nSwBerria = 0;
          |HAZ VerKitBerria; |ACABA;
     |FINSI;

     |SI nSwTagloma = 0;
          |HAZ TagloParamKit;
     |FINSI;

     |HAZ CreaTempo; aTempo0 = Tempo;
     |NOME_DAT #0 aTempo0; |DELINDEX #0;

     |ABRE #238;
     |ABRE #17;
     |ABRE #19;
     |ABRE #0;
     nLinKit = 0;
     |HAZ DescargaKit;
     |CIERRA #19;
     |CIERRA #17;
     |CIERRA #238;
     |LEE 000#0p;
     nNoHay = FSalida;
     |CIERRA #0;
     |SI nNoHay = 0;
          |PUSHV 0501 2380;
          |ENTLINEAL #1#0, -1, 4, 22, 1, MinKit, MaxKit;
          |POPV;
     |FINSI;
     |DELINDEX #0; Tempo = aTempo0; |HAZ BoraTempo;
|FPRC;

|PROCESO CompruDispo;
     #17#0 = #1#3;
     #17#1 = #1#4;
     |LEE 020#17=;

     nNeceUni = nUni * #1#5;
     |SI nNeceUni > #17#39;
          nFalta = nNeceUni - #17#39;
          aAlfa = "0000Articulo:" + #1#3 + &13;
          aAlfa = aAlfa + "Dispo:" + #17#39 + " " + &13;
          aAlfa = aAlfa + "Falta:" + nFalta;
          |MENAV aAlfa;
          nDispoKit = 1;
          nNume = #17#39 / #1#5;
          |SI nNume < 0;
               enUniKit = 0;
          |SINO;
               |SI enUniKit < nNume;
                    enUniKit = nNume;
                    nNume = nNume ! 0;       ||Redondeao por abajo
                    |SI nNume > enUniKit;    ||sin decimales
                         enUniKit = nNume - 1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE CompruDispo;
     #1#1004;
     ;
     aSer, nNum, nLin, 001;
     aSer, nNum, nLin, 999;
     ;
     NULL, CompruDispo;
|FIN;

|PROCESO DispoKit;
     nDispoKit = 0;
     enUniKit = 0;
     |HAZ HallaProgKit;

     |SI aTipo ! "K"; |ACABA; |FINSI;

     |SI nSwBerria = 0;
          |HAZ DispoKitBerria; |ACABA;
     |FINSI;

     |CARGA_DEF aRef, referen@;
     |SI FSalida = 0;
          |ABRE #17;
          |BUCLE CompruDispo;
          |CIERRA #17;
          |DESCARGA_DEF #referen@;
     |SINO;
          aAlfa = "0000[" + FSalida + "]Disponible. Error al cargar " + aRef;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO EsKit;
     nEsKit = 1;
     |SI #agifa142#12 = "K"; |O #agifa142#12 = "X";
          |ABRE #agifa048;
          #agifa048#0 = eaArticulo;
          |LEE 000#agifa048.=;
          nEsKit = FSalida;
          |SI FSalida = 0; |Y  #agifa142#12 = "X"; |Y #agifa048#33 ! "K";
               nEsKit = -1;
          |FINSI;
          |CIERRA #agifa048;
     |FINSI;
     FSalida = nEsKit; || si 0 es kit
|FPRC;

|PROCESO EsEscandallo;
     nEsKit = 1;
     |ABRE #agifa048;
     #agifa048#0 = eaArticulo;
     |LEE 000#agifa048.=;
     nEsKit = FSalida;
     |CIERRA #agifa048;
     FSalida = nEsKit; || si 0 es Escandallo
|FPRC;

|PROCESO UniDobleKit; |TIPO 0;
 ||    eaCliente = "";
 ||    efFecha = "01.01.000";
 ||*** se cargan antes, al llamar a SacaKit

     enAlmacen = #0#4;
     eaArticulo = #0#3;
     enUnidad1 = #0#5;
     enUnidad2 = #0#11;
     enMedida1 = #0#12;
     enMedida2 = #0#13;
     enMedida3 = #0#14;
     eaPartida = #0#15;

     |MODULO eaProgKit;
     eaProgVta = "dsz99986";
     enModoVta = (FEntrada / 100) ! 0;
     |SUB_EJECUTA_NP "dsz99919";
     eaProgVta = "";
     enModoVta = 0;

     |C_M #0#5, 1, "S";
     |SI eaSw2Stock = "S";
          |C_M #0#5, 1, "N";
          #0#5 = enUnidad1; |PINTA #0#5;
          #0#11 = enUnidad2;
          #0#12 = enMedida1;
          #0#13 = enMedida2;
          #0#14 = enMedida3;
          #0#15 = eaPartida;
     |FINSI;
|FPRC;

|PROCESO VerUniDobleKit; |TIPO 11;
     |SI FSalida = 13; ||F5
          enAlmacen = #0#4;
          eaArticulo = #0#3;
          enUnidad1 = #0#5;
          enUnidad2 = #0#11;
          enMedida1 = #0#12;
          enMedida2 = #0#13;
          enMedida3 = #0#14;
          eaPartida = #0#15;

          |MODULO eaProgKit;
          eaProgVta = "dsz99986";
          enModoVta = (FEntrada / 100) ! 0;
          |SUB_EJECUTA_NP "dsz99919;V";
          eaProgVta = "";
          enModoVta = 0;
     |FINSI;
|FPRC;

|PROCESO DefArtKit; |TIPO 0;
     |SI #0Campo ! Contenido;
          ||eaCliente = *** se cargan antes, al llamar a SacaKit
          eaArticulo = #0#3;
          |SUB_EJECUTA_NP "dsz99919;D";
          #0#12 = enMedida1;
          #0#13 = enMedida2;
          #0#14 = enMedida3;
     |FINSI;
|FPRC;

|PROCESO TagloParamKit;
     |DDEF aAlfa;
     aAlfa = aAlfa + "tagmpara";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          |LEE 000#referen@.p;
          |CIERRA #referen@;
          nTari = #referen@#4;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO TipoKit13; |TIPO 13;
     |SI nSwGesenvia = 0;
          |ATRI R; |PINTA 1569, "   Precio "; |ATRI 0;
          |C_M #0#10, 1, "S";
     |FINSI;
     |SI nSwTagloma = 0;
          |DDEF aAlfa;
          aAlfa = aAlfa + "tagmpara";
          |CARGA_DEF aAlfa, referen@;
          |SI FSalida = 0;
               |ABRE #referen@;
               |LEE 000#referen@.p;
               |CIERRA #referen@;
               nTari = #referen@#4;
               |DESCARGA_DEF #referen@;
               |ABRE #19;
               #19#0 = aEscan;
               |LEE 000#19=;
               |SI nTari = 1; nCampo = 18; |FINSI;
               |SI nTari = 2; nCampo = 19; |FINSI;
               |SI nTari = 3; nCampo = 20; |FINSI;
               |SI nTari = 4; nCampo = 147; |FINSI;
               |SI nTari = 5; nCampo = 148; |FINSI;
               |SI nTari = 6; nCampo = 149; |FINSI;
               |C_A #0#7, 1, 39;
               |ATRI I;
               |PINTA 1359,      " PVP Kit   ";
               |PINTA 1453, " PVP Calculado   ";
               |PINTA 2352, " PVP Componente  ";
               |PINTA 1368, #19#18;
               #19#0 = #0#3;
               |LEE 000#19=;
               |SI nTari = 1; nCampo = 18; |FINSI;
               |SI nTari = 2; nCampo = 19; |FINSI;
               |SI nTari = 3; nCampo = 20; |FINSI;
               |SI nTari = 4; nCampo = 147; |FINSI;
               |SI nTari = 5; nCampo = 148; |FINSI;
               |SI nTari = 6; nCampo = 149; |FINSI;
               |PINTA 2368, #19nCampo;
               nGuarda = #19#18;
               #19#18 = enPreKitCal;
               |PINTA 1468, #19#18;
               #19#18 = nGuarda;
               |ATRI 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO TagloPreKit;
     |SI nTari = 1; nCampo = 18; |FINSI;
     |SI nTari = 2; nCampo = 19; |FINSI;
     |SI nTari = 3; nCampo = 20; |FINSI;
     |SI nTari = 4; nCampo = 147; |FINSI;
     |SI nTari = 5; nCampo = 148; |FINSI;
     |SI nTari = 6; nCampo = 149; |FINSI;
     nPrecio = #19nCampo;
     |SI nFactu = 1;
          enPreKitCal = enPreKitCal + (nPrecio * #0#5 * nForma);
     |SINO;
          enPreKitCal = enPreKitCal + (nPrecio * #0#11 * nForma);
     |FINSI;
|FPRC;

|PROCESO TipoKit2; |TIPO 2;
     eaModiKit = "S";
     |ABRE #238;
     |ABRE #17;
     |ABRE #19;
     |HAZ LeeArtiKit;
     |CIERRA #238;
     |CIERRA #17;
     |CIERRA #19;
     nForma = 0 +. 1;
     |HAZ TagloPreKit;
     |HAZ TipoKit13;
|FPRC;

|PROCESO PintaTot; |TIPO 0;
     |HAZ TipoKit13;
|FPRC;
---------------------KIT Berria 004379-----------------
|PROCESO berm0009;
     |BORRA 020#berm0009@.a;
|FPRC;

|DEFBUCLE berm0009Borra;
     #berm0009@#1005;
     ;
     aSer, nNum, nLin, 001, 001;
     aSer, nNum, nLin, 999, 999;
     be;
     NULL, berm0009;
|FIN;

|PROCESO berm0008;
     |BORRA 020#berm0008@.a;
|FPRC;

|DEFBUCLE berm0008Borra;
     #berm0008@#1004;
     ;
     aSer, nNum, nLin, 001;
     aSer, nNum, nLin, 999;
     be;
     NULL, berm0008;
|FIN;

|PROCESO CargaDefBerria;
     |DDEF aPath;
     aAlfa = aPath + "berm0002";
     |CARGA_DEF aAlfa, berm0002@;
     |SI FSalida = 0;
          aAlfa = aPath + "berm0003";
          |CARGA_DEF aAlfa, berm0003@;
          |SI FSalida = 0;
               aAlfa = aPath + "berm0004";
               |CARGA_DEF aAlfa, berm0004@;
               |SI FSalida = 0;
                    aAlfa = aPath + "berm0008";
                    |CARGA_DEF aAlfa, berm0008@;
                    |SI FSalida = 0;
                         aAlfa = aPath + "berm0009";
                         |CARGA_DEF aAlfa, berm0009@;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar 'berm0002/3/4/8/9'";
     |FINSI;
|FPRC;

|PROCESO SacaKitBerria;
     |HAZ CargaDefBerria;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aEscan = aArti;
     nCantiEscan = 1;
     nMaxNivel = 1;
     nLinKit = 0;
     |ABRE #238;
     |ABRE #17;
     |ABRE #19;
     |ABRE #berm0002@;
     |ABRE #berm0004@;
     |ABRE #berm0008@;
     |ABRE #berm0009@;

     |SI nModo = 1; |O aArti ! Contenido;
          |BUCLE berm0008Borra;
          |BUCLE berm0009Borra;
          nSwVenta = 1;
          eaModiKit= "S";
          |HAZ DesglosaKit;
     |SINO;
          eaModiKit = "N";
     |FINSI;
     |LEE 000#berm0008@.p;
     nNoHay = FSalida;
     |CIERRA #berm0002@;
     |CIERRA #berm0004@;
     |CIERRA #berm0008@;
     |CIERRA #berm0009@;
     |SI enSwNoLinealDesglose = 0;
          |SI nNoHay = 0;
               |PUSHV 0501 2380;
               aAlfa = "berm0008;M" + aSer + (("000000"+nNum)%-106) + (("000"+nLin)%-103) + aEscan + nModo;
               |SUB_EJECUTA_NP aAlfa;
               |POPV;
          |FINSI;
     |FINSI;

     |CIERRA #19;
     |CIERRA #17;
     |CIERRA #238;

     |DESCARGA_DEF #berm0009@; |DESCARGA_DEF #berm0008@;
     |DESCARGA_DEF #berm0004@; |DESCARGA_DEF #berm0003@;
     |DESCARGA_DEF #berm0002@;
|FPRC;

|PROCESO BorraKitBerria;
     |HAZ CargaDefBerria;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |BUCLE berm0008Borra;
     |BUCLE berm0009Borra;

     |DESCARGA_DEF #berm0009@; |DESCARGA_DEF #berm0008@;
     |DESCARGA_DEF #berm0004@; |DESCARGA_DEF #berm0003@;
     |DESCARGA_DEF #berm0002@;
|FPRC;

|PROCESO VerKitBerria;
     |PUSHV 0501 2380;
     aAlfa = "berm0008;V" + aSer + (("000000"+nNum)%-106) + (("000"+nLin)%-103);
     |SUB_EJECUTA_NP aAlfa;
     |POPV;
|FPRC;

|PROCESO berm0008Dispo;
     #17#0 = #berm0008@#3;
     #17#1 = #berm0008@#4;
     |LEE 020#17=;

     nNeceUni = nUni * #berm0008@#5;
     |SI nNeceUni > #17#39;
          nFalta = nNeceUni - #17#39;
          aAlfa = "0000Articulo:" + #berm0008@#3 + &13;
          aAlfa = aAlfa + "Dispo:" + #17#39 + " " + &13;
          aAlfa = aAlfa + "Falta:" + nFalta;
          |MENAV aAlfa;
          nDispoKit = 1;
          nNume = #17#39 / #berm0008@#5;
          |SI nNume < 0;
               enUniKit = 0;
          |SINO;
               |SI enUniKit < nNume;
                    enUniKit = nNume;
                    nNume = nNume ! 0;       ||Redondeao por abajo
                    |SI nNume > enUniKit;    ||sin decimales
                         enUniKit = nNume - 1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE berm0008Dispo;
     #berm0008@#1004;
     ;
     aSer, nNum, nLin, 001;
     aSer, nNum, nLin, 999;
     ;
     NULL, berm0008Dispo;
|FIN;

|PROCESO DispoKitBerria;
     |HAZ CargaDefBerria;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #17;
     |BUCLE berm0008Dispo;
     |CIERRA #17;

     |DESCARGA_DEF #berm0009@; |DESCARGA_DEF #berm0008@;
     |DESCARGA_DEF #berm0004@; |DESCARGA_DEF #berm0003@;
     |DESCARGA_DEF #berm0002@;
|FPRC;
