|FICHEROS;
     diaz0009;
     diam0001;
     diam0002;
     diam0015;
     diam0016;
     diam0017;
     diam0018;
     diam0019;
     diam0050;

     diaw0007;

     agifa024;
     agifa025;
     agifa073;
     agifa091;
     agifa104;

     :/dspartes/def/dsparm05;
     :/dspartes/def/dsparm01;
     :/dsp/def/dspm0004;
|FIN;

|VARIABLES;
     nSwImp = 0;
     nBoton1     = 0;
     nBoton2     = 0;
     nBoton3     = 0;
     nBoton4     = 0;
     nBoton5     = 0;
     nBoton6     = 0;
     nBoton7     = 0;
     nBoton8     = 0;
     nBoton9     = 0;
     nBtnDoc     = 0;
     nRango      = 0;
     nPosi1      = 0;
     nPosi2      = 0;
     nPanta      = 0;
     nVentana    = 0;
     nCampo      = 0;
     nGrid       = 0;
     nTecla      = 0;
     nLinea      = 0;
     nCampo6     = 0;
     nCampo8     = 0;
     nCampo9     = 0;
     nCampo10    = 0;
     nCampo11    = 0;
     nSwHay      = 0;
     nCoste      = 0;
     nModoDatos  = 0;
     nContaLin   = 0;
     nIncre      = 0;
     nModo       = 0;
     nVtn        = 0;

     aEsc        = "";
     aEsc1       = "";
     aEsc2       = "";
     aRetu       = "";
     aTecla      = "";
     aTecla1     = "";
     aAlfa       = "";
     aAlfa1      = "";
     aAlfa2      = "";
     aCampo4     = "";
     aCampo5     = "";
     aFam        = "";
     aIPServ     = "";
     aServCorreo = "";
     aFrom       = "";
     aTo         = "";
     aMensaje    = "";
     aAsunto     = "";
     aFic        = "";
     aTipo       = "";
     aUsuario    = "";
     aHora       = "";
     aBase       = "";
     aOrigen     = "";
     aDestino    = "";
     aDocu       = "";
     aCliente    = "";
     aFecha      = "";
     aDCliente   = "";
     aHCliente   = "";
     aFamilia    = "";
     aPathSer    = "";

     aDSeriePedido = "";
     aHSeriePedido = "";
     nDNumerPedido = 0;
     nHNumerPedido = 0;

     &eaCliente      = "";
     &eaFecha        = "";
     &eaSerie        = "";
     &eaFechaPedido  = "";
     &eaHora         = "";
     &eaCompras      = "";
     &eaFechaEntrega = "";
     &eaDef          = "";
     &eaClv          = "";

     &enTipoIVA       = 0;
     &enPedido        = 0;
     &enDesdePed      = 0;
     &enSalida        = 0;
     &enModif         = 0;
     &enPanta         = 0;
     &enExiste        = 0;
     &enForma         = 0;
     &enChequeAlbaran = 0;
     &enTotal         = 0;
|FIN;

|PROCESO ClaveBaja16;
     #diam0016#0  = aDCliente;
     #diam0016#1  = "01.01.0000";
     #diam0016#13 = "        ";
     #diam0016#14 = aDSeriePedido;
     #diam0016#15 = nDNumerPedido;
|FPRC;

|PROCESO ClaveAlta16;
     #diam0016#0  = aHCliente;
     #diam0016#1  = "31.12.9999";
     #diam0016#13 = "zzzzzzzz";
     #diam0016#14 = aHSeriePedido;
     #diam0016#15 = nHNumerPedido;
|FPRC;

|PROCESO CargaControl;
     nModo = (FEntrada / 100) ! 0;

     aAlfa = #diaz0009#1 % -104;
     |ABRE #diam0015;
     #diam0015#71 = aAlfa;
     |LEE 040#diam0015.=;
     |SI FSalida ! 0;
         |MENAV "     No existe Control del Asistente.";
         |ERROR;
         |CIERRA #diam0015;
         |ACABA;
     |FINSI;
     |CIERRA #diam0015;

     |SI nModo ! 1;  |ACABA;  |FINSI;

     #diaz0009#32  = #diam0015#1;   #diaz0009#33  = #diam0015#3;   #diaz0009#35  = #diam0015#46;
     #diaz0009#37  = #diam0015#5;   #diaz0009#38  = #diam0015#7;   #diaz0009#40  = #diam0015#46;
     #diaz0009#42  = #diam0015#9;   #diaz0009#43  = #diam0015#11;  #diaz0009#45  = #diam0015#46;
     #diaz0009#47  = #diam0015#13;  #diaz0009#48  = #diam0015#15;  #diaz0009#50  = #diam0015#46;
     #diaz0009#52  = #diam0015#17;  #diaz0009#53  = #diam0015#19;  #diaz0009#55  = #diam0015#46;
     #diaz0009#57  = #diam0015#21;  #diaz0009#58  = #diam0015#23;  #diaz0009#60  = #diam0015#46;
     #diaz0009#62  = #diam0015#25;  #diaz0009#63  = #diam0015#27;  #diaz0009#65  = #diam0015#50;
     #diaz0009#67  = #diam0015#28;  #diaz0009#68  = #diam0015#30;  #diaz0009#70  = #diam0015#47;  #diaz0009#72  = #diam0015#48;
     #diaz0009#74  = #diam0015#31;  #diaz0009#75  = #diam0015#33;  #diaz0009#76  = #diam0015#49;
     #diaz0009#82  = #diam0015#34;  #diaz0009#83  = #diam0015#36;
     #diaz0009#86  = #diam0015#37;  #diaz0009#87  = #diam0015#39;
     #diaz0009#94  = #diam0015#40;  #diaz0009#95  = #diam0015#42;
     #diaz0009#98  = #diam0015#43;  #diaz0009#99  = #diam0015#45;

     |PINDA #0#diaz0009;
|FPRC;

|PROCESO EnviaCorreo;
     |ABRE #dsparm01;
     |LEE 040#dsparm01.p;
     |SI FSalida ! 0;  |CIERRA #dsparm01;  |ACABA;  |FINSI;
     |CIERRA #dsparm01;

     |ABRE #dsparm05;
     #dsparm05#0 = #dsparm01#12;
     |LEE 000#dsparm05.=;
     |SI FSalida ! 0;  |CIERRA #dsparm05;  |ACABA;  |FINSI;
     |CIERRA #dsparm05;

     aTo      = #dsparm05#3;               |QBF aTo;
     aAsunto  = aTipo + #diam0016#0 + "/" + #diam0016#1 + "/" + #diam0016#13;
     aMensaje = aAsunto;
     aAlfa    = Usuario % 810;

     |SELECT #3#dsparm05;
     #dsparm05#2 = aAlfa;
     |LEE 000#dsparm05.=;

     aFic        = "vacio.txt";
     aFrom       = #dsparm05#3;     |QBF aFrom;
     aServCorreo = #dsparm01#7;     |QBF aServCorreo;
     aIPServ   = #dsparm01#8;       |QBF aIPServ;

||  aTo = "manolo@diagram.es";

     |DSCORREO_ENVIA aIPServ, aServCorreo, aFrom, aTo, aAsunto, aMensaje, aFic;
     |SI FSalida ! 0;
          |MENAV "0000Ha habido un error durante el envio.";
     |FINSI;
|FPRC;

|PROCESO GrabaLinea;
     nLinea = nLinea + 1;
     #diam0002#0  = #diam0001#0;
     #diam0002#1  = #diam0001#1;
     #diam0002#2  = #diam0001#13;
     #diam0002#3  = nLinea;
     #diam0002#4  = aCampo4;
     #diam0002#5  = aCampo5;
     #diam0002#6  = nCampo6;
     #diam0002#8  = nCampo8;
     #diam0002#9  = nCampo9;
     #diam0002#10 = nCampo10;
     #diam0002#11 = nCampo11;
     |GRABA 020#diam0002.n;
     |LIBERA #diam0002;
|FPRC;

|PROCESO diam0017R;
     nSwHay = 1;

     aCampo4  = #diam0017#5;
     aCampo5  = #diam0017#6;
     nCampo6  = #diam0017#7;
     nCampo8  = #diam0017#8;
     nCampo9  = #diam0017#9;
     |SI nCoste = 1;
         nCampo10 = #diam0017#10;
         nCampo11 = #diam0017#11;
     |FINSI;
     |HAZ GrabaLinea;
|FPRC;

|DEFBUCLE diam0017R;
     #diam0017#1;
     ;
     #diam0016#0, #diam0016#1, #diam0016#13, 001;
     #diam0016#0, #diam0016#1, #diam0016#13, 999;
     ;
     NULL, diam0017R;
|FIN;

|PROCESO BuscaFamilia;
     |SI #diam0015#1  = aFamilia;  aCampo4  = #diam0015#2;  aCampo5  = #diam0015#3;  |FINSI;
     |SI #diam0015#5  = aFamilia;  aCampo4  = #diam0015#6;  aCampo5  = #diam0015#7;  |FINSI;
     |SI #diam0015#9  = aFamilia;  aCampo4  = #diam0015#10; aCampo5  = #diam0015#11; |FINSI;
     |SI #diam0015#13 = aFamilia;  aCampo4  = #diam0015#14; aCampo5  = #diam0015#15; |FINSI;
     |SI #diam0015#17 = aFamilia;  aCampo4  = #diam0015#18; aCampo5  = #diam0015#19; |FINSI;
     |SI #diam0015#21 = aFamilia;  aCampo4  = #diam0015#22; aCampo5  = #diam0015#23; |FINSI;
     |SI #diam0015#28 = aFamilia;  aCampo4  = #diam0015#29; aCampo5  = #diam0015#30; |FINSI;
     |SI #diam0015#31 = aFamilia;  aCampo4  = #diam0015#32; aCampo5  = #diam0015#33; |FINSI;
     |SI #diam0015#34 = aFamilia;  aCampo4  = #diam0015#35; aCampo5  = #diam0015#36; |FINSI;
     |SI #diam0015#37 = aFamilia;  aCampo4  = #diam0015#38; aCampo5  = #diam0015#39; |FINSI;
     |SI #diam0015#40 = aFamilia;  aCampo4  = #diam0015#41; aCampo5  = #diam0015#42; |FINSI;
     |SI #diam0015#43 = aFamilia;  aCampo4  = #diam0015#44; aCampo5  = #diam0015#45; |FINSI;
|FPRC;

|PROCESO diam0017C;
     nLinea = nLinea + 1;

     #diam0002#0 = #diam0001#0;
     #diam0002#1 = #diam0001#1;
     #diam0002#2 = #diam0001#13;
     #diam0002#3 = nLinea;
     #diam0002#4 = #diam0017#5;
     #diam0002#5 = #diam0017#6;
     #diam0002#6 = #diam0017#7;
     #diam0002#8 = #diam0017#8;
     #diam0002#9 = #diam0017#9;
     #diam0002#10 = #diam0017#10;
     #diam0002#11 = #diam0017#11;
     |GRABA 020#diam0002.n;
|FPRC;

|DEFBUCLE diam0017C;
     #diam0017#1;
     ;
     #diam0016#0, #diam0016#1, #diam0016#13, 001;
     #diam0016#0, #diam0016#1, #diam0016#13, 999;
     ;
     NULL, diam0017C;
|FIN;

|PROCESO APrepedidos;
     aAlfa = #diam0016#1 % -104;

     |ABRE #diam0015;
     #diam0015#71 = aAlfa;
     |LEE 040#diam0015.=;
     |SI FSalida ! 0;  |DDEFECTO #diam0015;  |FINSI;
     |CIERRA #diam0015;

     |ABRE #diam0001;
     |ABRE #diam0002;

     |PARA nCampo = 0;  |SI nCampo [ 31;  |HACIENDO nCampo = nCampo + 1;
           #diam0001#nCampo# = #diam0016#nCampo#;
     |SIGUE;
     #diam0001#32 = #diam0016#115;
     #diam0001#33 = #diam0016#117;
     #diam0001#34 = #diam0016#118;
     |GRABA 020#diam0001.n;

     nLinea = 0;
     |BUCLE diam0017C;
     |CIERRA #diam0001;
     |CIERRA #diam0002;

     |SI enModif = 0;  |HAZ EnviaCorreo;  |FINSI;
|FPRC;

|PROCESO diam0002;
     |BORRA 020#diam0002.a;
     |LIBERA #diam0002;
|FPRC;

|DEFBUCLE diam0002;
     #diam0002#1;
     ;
     #diam0001#0, #diam0001#1, #diam0001#13, 000;
     #diam0001#0, #diam0001#1, #diam0001#13, 999;
     be;
     NULL, diam0002;
|FIN;

|PROCESO BajaPrepedidos;
     |ABRE #diam0001;
     #diam0001#0  = #diam0016#0;
     #diam0001#1  = #diam0016#1;
     #diam0001#13 = #diam0016#13;
     |LEE 101#diam0001.=;
     |SI FSalida = 0;
         |BUCLE diam0002;
         |BORRA 020#diam0001.a;
         |LIBERA #diam0001;
     |FINSI;
     |CIERRA #diam0001;
|FPRC;

|PROCESO diam0017B;
     |DBASE aAlfa;  |QBF aAlfa;
     aAlfa = aAlfa + "000577/documentos";
     aAlfa = aAlfa + "/" + #diam0017#14;  |QBF aAlfa;
     |FBORRA aAlfa;

     |BORRA 020#diam0017.a;
     |LIBERA #diam0017;
|FPRC;

|DEFBUCLE diam0017B;
     #diam0017#1;
     ;
     #diam0016#0, #diam0016#1, #diam0016#13, 001;
     #diam0016#0, #diam0016#1, #diam0016#13, 999;
     be;
     NULL, diam0017B;
|FIN;

|PROCESO  diam0018B;
     |BORRA 020#diam0018.a;
     |LIBERA #diam0018;
|FPRC;

|DEFBUCLE diam0018B;
     #diam0018#1;
     ;
     #diam0016#0, #diam0016#1, #diam0016#13, 001;
     #diam0016#0, #diam0016#1, #diam0016#13, 999;
     ;
     NULL, diam0018B;
|FIN;

|PROCESO diam0050B;
     aFic  = #diam0050#0;
     aFic  = aFic + (("0000" + #diam0050#2) % -104);
     aFic  = aFic + #diam0050#1;                    |QBF aFic;
     aFic  = aFic + "." + #diam0050#10;             |QBF aFic;

     aAlfa = aPathSer + aFic;
     |FBORRA aAlfa;

     |BORRA 020#diam0050.a;
     |LIBERA #diam0050;
|FPRC;

|DEFBUCLE diam0050B;
     #diam0050#1;
     ;
     eaDef, eaClv, 0001;
     eaDef, eaClv, 9999;
     be;
     NULL, diam0050B;
|FIN;

|PROCESO ModoModifica;
     |SELECT #1#diam0016;
     #diam0016#0  = aCliente;
     #diam0016#1  = aFecha;
     #diam0016#13 = aHora;

     |LEE 101#diam0016.=;
     |SI FSalida ! 0;
         |SELECT #3#diam0016;
         |REFRESCACONTROL nGrid;
         |ACABA;
     |FINSI;

     |ABRE #diam0001;
     #diam0001#0  = #diam0016#0;
     #diam0001#1  = #diam0016#1;
     #diam0001#13 = #diam0016#13;
     |LEE 040#diam0001.=;
     |SI FSalida = 0;
         #diam0016#14 = #diam0001#14;
         #diam0016#15 = #diam0001#15;
     |FINSI;
     |CIERRA #diam0001;

     |ABRE #agifa104;
     #agifa104#25 = #diam0016#14;
     #agifa104#0  = #diam0016#15;
     |LEE 040#agifa104.=;
     |SI FSalida = 0;
         #diam0016#104 = "SI";
         #diam0016#116 = #agifa104#45;
         #diam0016#14  = #agifa104#25;
         #diam0016#15  = #agifa104#0;
     |SINO;
         #diam0016#104 = "NO";
         #diam0016#14  = "";
         #diam0016#15  = 0;
     |FINSI;
     |CIERRA #agifa104;

     |VENTANA 0501, 4099, -1, -1, "";
     nVentana = FSalida;

     |DDEFECTO #diaz0009;
     |PARA nCampo = 0;  |SI nCampo [ 118;  |HACIENDO nCampo = nCampo + 1;
           #diaz0009#nCampo# = #diam0016#nCampo#;
     |SIGUE;
     |SI enDesdePed = 1;  |HAZ CargaControl;  |FINSI;

     |PINPA #0#diaz0009;
     enPanta = FSalida;
     |PINDA #0#diaz0009;

     |C_M #diaz0009#0,  1, "N";
     |C_M #diaz0009#1,  1, "N";
     |C_M #diaz0009#13, 1, "N";

     enModif  = 0;
     enSalida = 0;
     |SI #diam0016#104 = "NO";  |O enDesdePed = 1;
         |HAZ PonBotones;
         || No esta en pedidos
         |SI nModoDatos = 1;  |ENDATOS #1#diaz0009;  |FINSI;
         |SI nModoDatos = 2;  |ENDATOS #2#diaz0009;  |FINSI;
         |SI enSalida = 0;
             |PARA nCampo = 0;  |SI nCampo [ 118;  |HACIENDO nCampo = nCampo + 1;
                   #diam0016#nCampo# = #diaz0009#nCampo#;
             |SIGUE;
             aTipo = "Modificacion Prepedido:";

             |HAZ CopiaOferta;
             |HAZ BajaPrepedidos;
             |HAZ APrepedidos;

             |GRABA 020#diam0016.a;
             FSalida = "SKIPDEFAULT";

             |PINTA #diam0016#17;
             |PINTA #diam0016#104;
             |PINTA #diam0016#14;
             |PINTA #diam0016#15;
         |SINO;
             |SI enDesdePed = 1;
                 eaDef = "diam0016";
                 eaClv = #diam0016#0;
                 eaClv = eaClv + (#diam0016#1  % -104);
                 eaClv = eaClv + (#diam0016#1  % 402);
                 eaClv = eaClv + (#diam0016#1  % 102);
                 eaClv = eaClv + (#diam0016#13 % 102);
                 eaClv = eaClv + (#diam0016#13 % 402);
                 eaClv = eaClv + (#diam0016#13 % 702);
                 eaClv = (eaClv + (" " * 25)) % 125;

                 |DBASE aBase;  |QBF aBase;
                 aPathSer = aBase + "000577/documentos/";

                 |BUCLE diam0017B;
                 |BUCLE diam0018B;
                 |BUCLE diam0050B;

                 |BORRA 020#diam0016.a;
                 |LIBERA #diam0016;
             |FINSI;
         |FINSI;
         |HAZ QuitaBotones;
    |SINO;
         || Esta en Pedido
         enModif = 1;
         |HAZ ModoConsulta;

         |PARA nCampo = 0;  |SI nCampo [ 116;  |HACIENDO nCampo = nCampo + 1;
              #diam0016#nCampo# = #diaz0009#nCampo#;
         |SIGUE;

         |HAZ BajaPrepedidos;
         |HAZ APrepedidos;

         |GRABA 020#diam0016.a;
         FSalida = "SKIPDEFAULT";
    |FINSI;

    |LIBERA #diam0016;
    |FINVENTANA nVentana;

    |SELECT #3#diam0016;
    |LEE 040#diam0016.=;
    |REFRESCACONTROL nGrid;
    |PULSATECLA;
|FPRC;

|PROCESO Evento;
     nTecla = FSalida;

     |SI nTecla = 1;
         |LEE 040#diam0016.c;
         aCliente = #diam0016#0;
         aFecha   = #diam0016#1;
         aHora    = #diam0016#13;

         |ESTADO_CONTROL nBtnDoc, "ENABLE";
     |FINSI;

     |SI nTecla = 4;
         nModoDatos = 2;
         |HAZ ModoModifica;
     |FINSI;
|FPRC;

|PROCESO Boton1;
     |VENTANA 0501, 4099, -1, -1, "";
     nVentana = FSalida;

     |DDEFECTO #diaz0009;
     |PINPA #0#diaz0009;

     |HORA aAlfa;
     #diaz0009#12 = ~;
     #diaz0009#13 = aAlfa;

     |C_M #diaz0009#0,  1, "S";
     |C_M #diaz0009#1,  1, "S";
     |C_M #diaz0009#13, 1, "S";

     enModif  = 0;
     enSalida = 0;
     |PINDA #0#diaz0009;
     |ENDATOS #1#diaz0009;
     |SI enSalida = 0;
         |PARA nCampo = 0;  |SI nCampo [ 116;  |HACIENDO nCampo = nCampo + 1;
               #diam0016#nCampo# = #diaz0009#nCampo#;
         |SIGUE;

         aTipo = "Alta Prepedido:";
         |HAZ APrepedidos;

         |GRABA 020#diam0016.n;
         |LIBERA #diam0016;
     |FINSI;
     |FINVENTANA nVentana;

     |REFRESCACONTROL nGrid;

     |PULSATECLA;
|FPRC;

|PROCESO Boton2;
     |CONFI "0000NSeguro de Borrar el Registro.";
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |SELECT #1#diam0016;
     #diam0016#0  = aCliente;
     #diam0016#1  = aFecha;
     #diam0016#13 = aHora;
     |LEE 101#diam0016.=;
     |SI FSalida = 0;
         |SI #diam0016#104 = "NO";
             aTipo = "Baja Prepedido:";

             eaDef = "diam0016";
             eaClv = #diam0016#0;
             eaClv = eaClv + (#diam0016#1  % -104);
             eaClv = eaClv + (#diam0016#1  % 402);
             eaClv = eaClv + (#diam0016#1  % 102);
             eaClv = eaClv + (#diam0016#13 % 102);
             eaClv = eaClv + (#diam0016#13 % 402);
             eaClv = eaClv + (#diam0016#13 % 702);
             eaClv = (eaClv + (" " * 25)) % 125;

             |HAZ EnviaCorreo;
             |HAZ BajaPrepedidos;
             |BUCLE diam0017B;
             |BUCLE diam0018B;
             |BUCLE diam0050B;

             |BORRA 020#diam0016.a;

             |ABRE #diam0019;
             |SELECT #4#diam0019;
             #diam0019#0   = #diam0016#0;
             #diam0019#122 = #diam0016#1;
             #diam0019#13  = "";
             |LEE 101#diam0019.];
             |SI FSalida = 0;   |Y #diam0019#0   = #diam0016#0;
                                |Y #diam0019#122 = #diam0016#1;
                                |Y #diam0019#119 = "EN PEDIDOS";
                 #diam0019#119 = "PENDIENTE";
                 |GRABA 020#diam0019.a;
             |FINSI;
             |LIBERA #diam0019;
             |CIERRA #diam0019;
         |SINO;
             |MENAV "0000 El Registro no se puede borrar, esta en Pedidos.";
         |FINSI;
         |LIBERA #diam0016;
     |FINSI;

     |SELECT #3#diam0016;
     |LEE 040#diam0016.=;
     |REFRESCACONTROL nGrid;
     |PULSATECLA;
|FPRC;

|PROCESO ChequeaPedido;
     |ABRE #diam0001;
     |SELECT #2#diam0001;
     #diam0001#14 = #diaw0007#0;
     #diam0001#15 = #diaw0007#1;
     |LEE 040#diam0001.=;
     |SI FSalida = 0;
         #diam0016#0  = #diam0001#0;
         #diam0016#1  = #diam0001#1;
         #diam0016#13 = #diam0001#13;
         |LEE 040#diam0016.=;
         |SI FSalida = 0;
             |MENAV "0000 El Prepedido ya Existe.";
             enSalida = 1;
             |ACABA;
         |FINSI;
         |DDEFECTO #diam0016;

         |PARA nCampo = 0;  |SI nCampo [ 31;  |HACIENDO nCampo = nCampo + 1;
               #diam0016#nCampo# = #diam0001#nCampo#;
         |SIGUE;

         #diam0016#16   = 0;
         #diam0016#17   = 0;
         #diam0016#19   = 0;
         #diam0016#20   = 0;
         #diam0016#21   = 0;
         #diam0016#22   = 0;

         |GRABA 020#diam0016.n;

         FSalida    = 4;
         enDesdePed = 1;
         nModoDatos = 2;
         |HAZ ModoModifica;
         enDesdePed = 0;
     |SINO;
         |ABRE #agifa104;
         #agifa104#25 = #diaw0007#0;
         #agifa104#0  = #diaw0007#1;
         |LEE 040#agifa104.=;
         |SI FSalida ! 0;
             enSalida = 1;
             |CIERRA #agifa104;
             |ACABA;
         |FINSI;
         |CIERRA #agifa104;

         |SELECT #2#diam0016;
         #diam0016#14 = #agifa104#25;
         #diam0016#15 = #agifa104#0;
         |LEE 040#diam0016.=;
         |SI FSalida = 0;
             enSalida = 1;
             |MENAV "0000 El Prepedido ya Existe.";
             |ACABA;
         |FINSI;

         |SELECT #1#diam0016;
         |DDEFECTO #diam0016;

         |HORA aHora;
         #diam0016#0  = #agifa104#4;
         #diam0016#1  = #agifa104#1;
         #diam0016#13 = aHora;
         #diam0016#14 = #agifa104#25;
         #diam0016#15 = #agifa104#0;
         #diam0016#18 = #agifa104#7;
         #diam0016#28 = #agifa104#2;

         |GRABA 020#diam0016.n;

         FSalida    = 4;
         enDesdePed = 1;
         nModoDatos = 1;
         |HAZ ModoModifica;
         enDesdePed = 0;
     |FINSI;
     |CIERRA #diam0001;
     |SELECT #1#diam0001;

     |REFRESCACONTROL nGrid;
|FPRC;

|PROCESO agifa073;
     enForma    = -1;
     |HAZ AcumulaPV;

     enTipoIVA  = #agifa073#14;

     |BORRA 020#agifa073.a;
     |LIBERA #agifa073;
|FPRC;

|DEFBUCLE agifa073;
     #agifa073#1;
     ;
     #agifa104#25, #agifa104#0, 001;
     #agifa104#25, #agifa104#0, 999;
     be;
     NULL, agifa073;
|FIN;

|PROCESO TrataPedido;
     enTipoIVA = 0;

     |ABRE #agifa104;
     #agifa104#25 = #diam0016#14;
     #agifa104#0  = #diam0016#15;
     |LEE 101#agifa104.=;
     |SI FSalida = 0;
         |BUCLE agifa073;

         |BORRA 020#agifa104.a;
         |LIBERA #agifa104;
     |FINSI;
     |CIERRA #agifa104;

     eaCliente      = #diam0016#0;
     eaFecha        = #diam0016#1;
     eaSerie        = #diam0016#14;
     enPedido       = #diam0016#15;
     eaFechaPedido  = #agifa104#1;
     eaHora         = #diam0016#13;
     eaFechaEntrega = #diam0016#28;

     |ABRE #diam0001;
     #diam0001#0  = #diam0016#0;
     #diam0001#1  = #diam0016#1;
     #diam0001#13 = #diam0016#13;
     |LEE 101#diam0001.=;
     |SI FSalida = 0;
         #diam0001#14 = "";
         #diam0001#15 = "";
         |GRABA 020#diam0001.a;
         |LIBERA #diam0001;
     |FINSI;
     |CIERRA #diam0001;

     |DESTRUYECONTROL nGrid;

     |VENTANA 0501, 4099, -1, -1, "";
     |SUB_EJECUTA_NP "diaw0001";
     |FINVENTANA nVentana;

     |LEE 040#diam0016.p;
     nRango = 4 + 8 + 16 + 32;
     |LINEAL_SIMPLE #3#diam0016, nRango, nPosi1, nPosi2, ClaveBaja16, ClaveAlta16, Evento;
     nGrid = FSalida;
|FPRC;

|PROCESO Boton9;
     |SI #diam0016#104 = "SI";  |ACABA;  |FINSI;

     enExiste  = 0;

     |VENTANA 0930, 1473, -1, -1, "";
     nVentana = FSalida;

     |C_M #diaw0007#2, 1, "N";
     |C_M #diaw0007#3, 1, "N";

     enChequeAlbaran = 0;
     enTotal         = #diam0016#17;
     eaCliente       = #diam0016#0;

     |PINPA #0#diaw0007;
     |PINDA #0#diaw0007;
     |ENDATOS #1#diaw0007;
     |FINVENTANA nVentana;
     |PULSATECLA;

     |SI enSalida = 0;
         |ABRE #diam0001;
         |SELECT #2#diam0001;
         #diam0001#14 = #diaw0007#0;
         #diam0001#15 = #diaw0007#1;
         |LEE 040#diam0001.=;
         |SI FSalida = 0;
             |SALVA_DATOS #diam0016;
             #diam0016#0  = #diam0001#0;
             #diam0016#1  = #diam0001#1;
             #diam0016#13 = #diam0001#13;
             #diam0016#14 = #diam0001#14;
             #diam0016#15 = #diam0001#15;
             |LEE 040#diam0016.=;
             |SI FSalida = 0;
                 |MENAV "0000 El Prepedido ya Existe.";
                 |REPON_DATOS #diam0016;
                 |CIERRA #diam0001;
                 |ACABA;
             |FINSI;
             |REPON_DATOS #diam0016;
         |FINSI;

         |SELECT #1#diam0016;
         |LEE 101#diam0016.=;
         |SI FSalida = 0;
             #diam0016#14  = #diaw0007#0;
             #diam0016#15  = #diaw0007#1;
             #diam0016#104 = "SI";
             |GRABA 020#diam0016.a;
             |LIBERA #diam0016;

             |SELECT #1#diam0001;
             #diam0001#0  = #diam0016#0;
             #diam0001#1  = #diam0016#1;
             #diam0001#13 = #diam0016#13;
             |LEE 101#diam0001.=;
             |SI FSalida = 0;
                 #diam0001#14 = #diaw0007#0;
                 #diam0001#15 = #diaw0007#1;
                 |GRABA 020#diam0001.a;
                 |LIBERA #diam0001;
             |FINSI;
         |FINSI;
         |CIERRA #diam0001;

         |SELECT #3#diam0016;
         |LEE 040#diam0016.=;
         |REFRESCACONTROL nGrid;
         |PULSATECLA;
     |FINSI;
|FPRC;

|PROCESO Boton3;
     enExiste  = 0;

     |VENTANA 0930, 1473, -1, -1, "";
     nVentana = FSalida;

     |C_M #diaw0007#2, 1, "N";
     |C_M #diaw0007#3, 1, "N";

     enChequeAlbaran = 1;

     |PINPA #0#diaw0007;
     |PINDA #0#diaw0007;
     |ENDATOS #1#diaw0007;
     |FINVENTANA nVentana;
     |PULSATECLA;

     |SI enSalida = 0;
         |HAZ ChequeaPedido;
         |SI enSalida = 0;
             |HAZ TrataPedido;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Boton4;
     |LEE 040#diam0016.c;

     |SI #diam0016#104 = "SI";  |ACABA;  |FINSI;

     |ABRE #diam0001;
     #diam0001#0  = #diam0016#0;
     #diam0001#1  = #diam0016#1;
     #diam0001#13 = #diam0016#13;
     |LEE 040#diam0001.=;
     |SI FSalida ! 0;
         |CIERRA #diam0001;
         |HAZ APrepedidos;
     |SINO;
         |CIERRA #diam0001;
     |FINSI;

     enExiste = 1;
     |VENTANA 0930, 1473, -1, -1, "";
     nVentana = FSalida;

     |C_M #diaw0007#2, 1, "S";
     |C_M #diaw0007#3, 1, "S";

     enChequeAlbaran = 1;

     |PINPA #0#diaw0007;
     |PINDA #0#diaw0007;
     |ENDATOS #1#diaw0007;
     |FINVENTANA nVentana;
     |PULSATECLA;

     |SI enSalida = 0;
         eaCliente      = #diam0016#0;
         eaFecha        = #diam0016#1;
         eaSerie        = #diaw0007#0;
         enPedido       = #diaw0007#1;
         eaFechaPedido  = #diaw0007#2;
         enTipoIVA      = #diaw0007#3;
         eaHora         = #diam0016#13;
         eaFechaEntrega = #diam0016#28;

         |VENTANA 0501, 4099, -1, -1, "";
         |SUB_EJECUTA_NP "diaw0001";
         |FINVENTANA nVentana;

         |SELECT #3#diam0016;
         |REFRESCACONTROL nGrid;
         |PULSATECLA;
     |FINSI;
|FPRC;

|PROCESO diam0018Imprime;
     |SI nLinea = 0;
         nContaLin = nContaLin + 1;
         |ACABA;
     |FINSI;

     nLinea = nLinea + nIncre;

     |SI nLinea > 25;  |ERROR10;  |ACABA;  |FINSI;

     |SI #diam0018#5 ! 0;
         aAlfa = "B" + nLinea + "," + #diam0018#5;
         |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;

     aAlfa = "C" + nLinea + "," + #diam0018#8;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "D" + nLinea + "," + #diam0018#4;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "F" + nLinea + "," + #diam0018#6;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "G" + nLinea + "," + #diam0018#7;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
|FPRC;

|DEFBUCLE diam0018Imprime;
     #diam0018#1;
     ;
     #diam0016#0, #diam0016#1, #diam0016#13, 001;
     #diam0016#0, #diam0016#1, #diam0016#13, 999;
     ;
     NULL, diam0018Imprime;
|FIN;

|PROCESO CargaHoja;
     |ABRE #agifa091;
     #agifa091#0 = #diam0016#115;
     |LEE 040#agifa091.=;
     |SI FSalida ! 0;  |DDEFECTO #agifa091; |FINSI;
     |CIERRA #agifa091;

     |ABRE #agifa024;
     #agifa024#0 = #diam0016#0;
     |LEE 040#agifa024.=;
     |SI FSalida ! 0;  |DDEFECTO #agifa024; |FINSI;
     |CIERRA #agifa024;

     aAlfa = "D27," + #agifa091#1;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "D7," + #diam0016#3;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "D8," + #diam0016#5;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "D9," + #diam0016#8 + " " + #diam0016#6;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "D10," + #agifa024#15;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "D11," + #diam0016#10;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "G11," + #diam0016#11;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "B37," + #diam0016#23;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "B38," + #diam0016#24;
     |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     |SI #diam0016#15 ! 0;
         aAlfa = "B38," + "PEDIDO NUMERO : " + #diam0016#14 + "/" + (("000000" + #diam0016#15) % -106);
         |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;

     nLinea    = 0;
     nContaLin = 0;

     |BUCLE diam0018Imprime;

     |SI nContaLin > 11;
         |MENAV "0000 Hay mas de 11 Lineas de Presupuestos. Solo Imprimira hasta la 11";
     |FINSI;

     |SI nContaLin [ 5;
         nLinea = 14;
         nIncre = 2;
     |SINO;
         nLinea = 15;
         nIncre = 1;
         |SI nContaLin ] 11;
             nLinea = 14;
         |FINSI;
     |FINSI;

     |BUCLE diam0018Imprime;
|FPRC;

|PROCESO Boton5;
     |SELECT #1#diam0016;
     #diam0016#0  = aCliente;
     #diam0016#1  = aFecha;
     #diam0016#13 = aHora;

     |LEE 040#diam0016.=;
     |SI FSalida ! 0;  |DDEFECTO #diam0016;  |FINSI;

     |HAZ ImpCrystal;
|FPRC;

|PROCESO Boton6;
     aDSeriePedido = "     ";
     aHSeriePedido = "     ";
     nDNumerPedido = 0;
     nHNumerPedido = 0;

     |ESTADO_CONTROL nBoton6, "DISABLE";
     |ESTADO_CONTROL nBoton7, "ENABLE";
     |ESTADO_CONTROL nBoton8, "ENABLE";

     |DESTRUYECONTROL nGrid;

     |LEE 040#diam0016.p;
     nRango = 4 + 8 + 16 + 32;
     |LINEAL_SIMPLE #3#diam0016, nRango, nPosi1, nPosi2, ClaveBaja16, ClaveAlta16, Evento;
     nGrid = FSalida;
|FPRC;

|PROCESO Boton7;
     aDSeriePedido = "!    ";
     aHSeriePedido = "zzzzz";
     nDNumerPedido = 1;
     nHNumerPedido = 999999;

     |ESTADO_CONTROL nBoton7, "DISABLE";
     |ESTADO_CONTROL nBoton6, "ENABLE";
     |ESTADO_CONTROL nBoton8, "ENABLE";

     |DESTRUYECONTROL nGrid;

     |LEE 040#diam0016.p;
     nRango = 4 + 8 + 16 + 32;
     |LINEAL_SIMPLE #3#diam0016, nRango, nPosi1, nPosi2, ClaveBaja16, ClaveAlta16, Evento;
     nGrid = FSalida;
|FPRC;

|PROCESO Boton8;
     aDSeriePedido = "     ";
     aHSeriePedido = "zzzzz";
     nDNumerPedido = 0;
     nHNumerPedido = 999999;

     |ESTADO_CONTROL nBoton8, "DISABLE";
     |ESTADO_CONTROL nBoton6, "ENABLE";
     |ESTADO_CONTROL nBoton7, "ENABLE";

     |DESTRUYECONTROL nGrid;

     |LEE 040#diam0016.p;
     nRango = 4 + 8 + 16 + 32;
     |LINEAL_SIMPLE #3#diam0016, nRango, nPosi1, nPosi2, ClaveBaja16, ClaveAlta16, Evento;
     nGrid = FSalida;
|FPRC;

|PROCESO ConsultaPedido;
     |ABRE #diam0016;
     |SELECT #2#diam0016;
     aAlfa1 = PARAMETRO % 105;
     aAlfa2 = PARAMETRO % 606;
     #diam0016#14 = aAlfa1;
     #diam0016#15 = aAlfa2;
     |LEE 040#diam0016.=;
     |SI FSalida ! 0;
         |MENAV "0000 No existe el Pedido en Prepedidos.";
     |SINO;
         aCliente   = #diam0016#0;
         aFecha     = #diam0016#1;
         aHora      = #diam0016#13;
         nModoDatos = 2;
         |HAZ ModoModifica;
     |FINSI;
     |CIERRA #diam0016;
|FPRC;


|PROCESO ImpLin;
     |SI nSwImp = 1;
          enTotal = enTotal + #diam0018#7;
     |SINO;
          |PRINT;
     |FINSI;
|FPRC;

|DEFBUCLE ImpLin;
     #diam0018#1;
     ;
     #diam0016#0, #diam0016#1, #diam0016#13, 001;
     #diam0016#0, #diam0016#1, #diam0016#13, 999;
     ;
     NULL, ImpLin;
|FIN;

|PROCESO ImpCrystal;
     Impresora = "CrystalReport";
     |IMPRE -1;
     |SI FSalida = 0;
          |INFOR "diam0016";
          |SI FSalida = 0;
               |ABRE #agifa091;
               #agifa091#0 = #diam0016#115;
               |LEE 040#agifa091.=;
               |SI FSalida ! 0;  |DDEFECTO #agifa091; |FINSI;
               |CIERRA #agifa091;

               |ABRE #agifa024;
               #agifa024#0 = #diam0016#0;
               |LEE 040#agifa024.=;
               |SI FSalida ! 0;  |DDEFECTO #agifa024; |FINSI;
               |CIERRA #agifa024;

               |ABRE #agifa025;
               #agifa025#0 = #diam0016#18;
               |LEE 040#agifa025.=;
               |SI FSalida ! 0;  |DDEFECTO #agifa025; |FINSI;
               |CIERRA #agifa025;
               enTotal = 0;
               nSwImp = 1; |BUCLE ImpLin;
               nSwImp = 0; |BUCLE ImpLin;
               |PIEINF;
               |FININF;
          |FINSI;
          |FINIMP;
     |SINO;
          |MENAV "0000Error en impresora 'CrystalReport'...";
     |FINSI;
|FPRC;

|PROCESO Docs;
     eaDef = "diam0016";
     eaClv = #diam0016#0;
     eaClv = eaClv + (#diam0016#1  % -104);
     eaClv = eaClv + (#diam0016#1  % 402);
     eaClv = eaClv + (#diam0016#1  % 102);
     eaClv = eaClv + (#diam0016#13 % 102);
     eaClv = eaClv + (#diam0016#13 % 402);
     eaClv = eaClv + (#diam0016#13 % 702);
     eaClv = (eaClv + (" " * 25)) % 125;

     |VENTANA 0501, 2999, -1, 1, "";
     nVtn = FSalida;

     |SUB_EJECUTA "diam0050";

     |FINVENTANA nVtn;
|FPRC;

|PROGRAMA;
     |PINPA #0#diam0016;
     nPanta = FSalida;

     |SI PARAMETRO = "";
         |CONTROL_SIMPLE nPanta, "BOTON,Pasar a Pedido", 0653, 0668, Boton4;
         nBoton4 = FSalida;

         |CONTROL_SIMPLE nPanta, "BOTON,{{205}} Nota de Entrega", 0670, 0687, Boton5;
         nBoton5 = FSalida;

         |CONTROL_SIMPLE nPanta, "BOTON,{{199}} Borrar", 0690, 0697, Boton2;
         nBoton2 = FSalida;

         |CONTROL_SIMPLE nPanta, "BOTON,{{137}} Pendientes", 3180, 3199, Boton6;
         nBoton6 = FSalida;

         |CONTROL_SIMPLE nPanta, "BOTON,{{137}} En Pedidos", 3280, 3299, Boton7;
         nBoton7 = FSalida;

         |CONTROL_SIMPLE nPanta, "BOTON,{{137}} Todos", 3380, 3399, Boton8;
         nBoton8 = FSalida;

         |CONTROL_SIMPLE nPanta, "BOTON,{{197}}Documentos", 2903, 2916, Docs;
         nBtnDoc = FSalida;

         aDCliente = "";
         aHCliente = "zzzzzz";
     |SINO;
         aAlfa     = PARAMETRO % -101;
         |SI aAlfa = "P";
             |HAZ ConsultaPedido;
             |ACABA;
         |FINSI;

         aDCliente = PARAMETRO;
         aHCliente = PARAMETRO;
     |FINSI;

     aUsuario = Usuario % 810;
     |ABRE #dspm0004;
     #dspm0004#0 = aUsuario;
     |LEE 040#dspm0004.=;
     |SI FSalida ! 0;  |DDEFECTO #dspm0004;  |FINSI;
     |CIERRA #dspm0004;

     eaCompras = #dspm0004#7;

     |SI PARAMETRO = "";
         |SI #dspm0004#7 ! "S";
             |ESTADO_CONTROL nBoton3, "DISABLE";
             |ESTADO_CONTROL nBoton4, "DISABLE";
             |ESTADO_CONTROL nBoton9, "DISABLE";
         |FINSI;

         |ESTADO_CONTROL nBoton6, "DISABLE";
         |ESTADO_CONTROL nBtnDoc, "DISABLE";
     |FINSI;

     aDSeriePedido = "     ";
     aHSeriePedido = "     ";
     nDNumerPedido = 0;
     nHNumerPedido = 0;

     |ABRET #diam0016;
     nRango = 4 + 8 + 16 + 32;
     |LINEAL_SIMPLE #3#diam0016, nRango, nPosi1, nPosi2, ClaveBaja16, ClaveAlta16, Evento;
     nGrid = FSalida;

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::Salir";
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
         |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;
     aTecla = "";

     |CIERRAT #diam0016;

     |SI PARAMETRO = "";
         |FIN_CONTROL_WINDOWS nBoton4;
         |FIN_CONTROL_WINDOWS nBoton5;
         |FIN_CONTROL_WINDOWS nBoton6;
         |FIN_CONTROL_WINDOWS nBoton7;
         |FIN_CONTROL_WINDOWS nBoton8;
         |FIN_CONTROL_WINDOWS nBoton9;
         |FIN_CONTROL_WINDOWS nBtnDoc;
     |FINSI;

     |DESTRUYECONTROL nGrid;

     |PULSATECLA;
|FPRO;

|PROCESO Tipo80;  |TIPO 80;
     nPosi1  = 0903;
     nPosi2  = 2897;
     FSalida = 3299;
|FPRC;
