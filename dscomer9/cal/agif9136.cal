||Nos da un exceso de ficheros.
||EXCESO DE FICHEROS EN UN PRC (Limite 48).
||Por eso he puesto todo lo relativo al agifae02 aqui.

|FICHEROS;
     agifa136 #0;   || Este def.
     agifa134 #134;
     tmp00000 #300; || Temporal de albaranes que se imprimen
     agifae02 #1002;

     dscam045@ #2000;
     dscam003@ #2001;
     dscam051@ #2002;
     refere1@;
     refere2@;
     dsm00225 #225;
     dsm00156 #156;
     agifa024 #24;
     agifa071 #71;
     agifa010 #10;
|FIN;

|VARIABLES;
     aPath = "";
     &enEstaDentro = 0;
     &enSwMalpesa = 0;
     &eaArti = "";
     &eaAlfa = "";
     &enCuentaFac = 0;
     &eaTagloItem = "N";
     nSal = 0;
     nPrime = 0;
 {-1}aMenuTaglo = "";
     aMenuTaglo1 = "2400";
     aMenuTaglo2 = "1";
     aMenuTaglo3 = "Opciones: ";
     aMenuTaglo4 = "ID";
     aMenuTaglo5 = " Impresion Diagram ";
     aMenuTaglo6 = " Impresion ItemDoc ";

 {-1}aMenuTagloI = "";
     aMenuTagloI1 = "2400";
     aMenuTagloI2 = "1";
     aMenuTagloI3 = "Opciones: ";
     aMenuTagloI4 = "ID";
     aMenuTagloI5 = " Impresion Normal ";
     aMenuTagloI6 = " Según configuración ";

     &enSwInforpor = 0;
     &enSwInfoz004 = 0;
     &enSw_tagz0023 = 0;
     &enSwTagloma = 0;
     aTmp300 = "";
     aAlfa = "";
     &Tempo = "";
     &eaTempo1002 = "";

     &enSwModoArchivo = 0;
     &enNumFactura1002 = 0;
     &eaSerieFactura1002 = "";

     &eaObserv = "";
     &enNumOb1 = 0;
     &enNumOb2 = 0;
     &enNumOb3 = 0;
     &enNumOb4 = 0;
     &enNumOb5 = 0;
     &enNumOb6 = 0;
     &enNumOb7 = 0;
     &enNumOb8 = 0;
     &enNumOb9 = 0;

     nDocAgrup = 0;
     nCalc     = 0;
     nSwSaca   = 0;
|FIN;

|PROCESO CreaTempo1002;
     |HAZ CreaTempo; eaTempo1002 = Tempo;
     |NOME_DAT #1002 eaTempo1002; |DELINDEX #1002;
     |ABRE #1002;
|FPRC;

|PROCESO MataTempo1002;
     |CIERRA #1002;
     |DELINDEX #1002; Tempo = eaTempo1002; |HAZ BoraTempo;
|FPRC;

|PROCESO LeeTempo1002;
     |DDEFECTO #1002;
     |LEE 101#1002.p;
     |SI FSalida = 0;
          |SI #1002#0 = enSwModoArchivo;
               eaSerieFactura1002 = #1002#1;
               enNumFactura1002 = #1002#2;
               |BORRA 020#1002.a;
          |FINSI;
          |LIBERA #1002;
     |FINSI;
|FPRC;

|PROCESO GrabaTempo1002;
     |DDEFECTO #1002;
     #1002#0 = enSwModoArchivo;
     #1002#1 = eaSerieFactura1002;
     #1002#2 = enNumFactura1002;
     |LEE 101#1002.=;
     |SI FSalida ! 0;
          |GRABA 020#1002.n;
     |FINSI;
     |LIBERA #1002;
|FPRC;

|PROCESO RecogeAbonos;
   || En caso de reimpresion, hay que ver que es lo que se hizo en su momento
   ||   y reproducir lo que se grababa en el secuencial, es decir, buscar si
   ||   hay un recibo agrupador con la serie y factura de la factura actual
   ||   y si lo hay, sacar en las variables los datos de los abonos agrupados
   ||   en dicho recibo agrupador ....

   |DBASS aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "dscarter/def/dscam045.mas";
   |CARGA_DEF aAlfa, dscam045@;
   |SI FSalida = 0;
      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dscarter/def/dscam003.mas";
      |CARGA_DEF aAlfa, dscam003@;
      |SI FSalida = 0;
         |DBASS aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + "dscarter/def/dscam051.mas";
         |CARGA_DEF aAlfa, dscam051@;
         |SI FSalida = 0;
            |DBASS aAlfa; |QBF aAlfa;
            aAlfa = aAlfa + "dscarter/fich/"; |PATH_DAT #dscam045@#aAlfa#;
            |ABRE #dscam045@;
            #dscam045@#0 = #48#0;
            #dscam045@#1 = 0;
            |LEE 000#dscam045@.];
            |PARA; |SI FSalida = 0; |Y #dscam045@#0 = #48#0; |HACIENDO;
               |SI #dscam045@#2 = "V";
                  |SI #dscam045@#4 [ #agifa134#49; |Y #dscam045@#5 ] #agifa134#49; |SAL; |FINSI;
               |FINSI;
               |LEE 000#dscam045@.s;
            |SIGUE;

            |SI FSalida = 0; |Y #dscam045@#2 = "V"; |Y #dscam045@#4 [ #agifa134#49; |Y #dscam045@#5 ] #agifa134#49;
               |DBASS aAlfa; |QBF aAlfa;
               aAlfa = aAlfa + "dscarter/fich/" + (("00000" + #dscam045@#6) % -105) + "/";
               |PATH_DAT #dscam003@#aAlfa#; |PATH_DAT #dscam051@#aAlfa#;
               |ABRE #dscam051@; |LEE 000#dscam051@.p; |CIERRA #dscam051@;

               |ABRE #dscam003@; |SELECT #9#dscam003@;

               nDocAgrup = -1;
               enNumOb1 = 0; enNumOb2 = 0; enNumOb3 = 0;
               enNumOb4 = 0; enNumOb5 = 0; enNumOb6 = 0;
               enNumOb7 = 0; enNumOb8 = 0; enNumOb9 = 0;
               eaObserv = "";

               |DDEFECTO #dscam003@;
               #dscam003@#0  = #agifa134#49;
               #dscam003@#1  = #agifa134#0;
               |LEE 000#dscam003@.];
               |PARA; |SI FSalida = 0; |Y #dscam003@#0 = #agifa134#49; |Y #dscam003@#1 = #agifa134#0; |HACIENDO;
                  |SI #dscam003@#49 = "S";
                     |SI #dscam003@#4 = #agifa134#1; |SAL; |FINSI;
                  |FINSI;
                  |LEE 000#dscam003@.s;
               |SIGUE;

               |SI FSalida = 0; |Y #dscam003@#0 = #agifa134#49; |Y #dscam003@#1 = #agifa134#0;
                |Y #dscam003@#49 = "S"; |Y #dscam003@#4 = #agifa134#1;
                  nDocAgrup = #dscam003@#40;
               |FINSI;

               |SI nDocAgrup ] 0; |Y #dscam051@#120 = "S";
                  |SELECT #13#dscam003@;
                  #dscam003@#41 = nDocAgrup;
                  #dscam003@#40 = 0;
                  |LEE 000#dscam003@.];
                  |PARA; |SI FSalida = 0; |Y #dscam003@#41 = nDocAgrup; |HACIENDO;
                     nSwSaca = 0;
                     |SI #agifa134#101 ] 0; |Y #dscam003@#30 < 0; nSwSaca = 1; |FINSI;
                     |SI #agifa134#101 < 0; |Y #dscam003@#30 ] 0; nSwSaca = 1; |FINSI;
                     |SI nSwSaca = 1;
                        nCalc = #dscam003@#30;
                        aAlfa = #dscam003@#0; |QBF aAlfa;
                        |SI eaObserv = "";
                              eaObserv = eaObserv + "Compensaci¢n fra. " + aAlfa + "/" + (("000000" + #dscam003@#1) % -106);
                        |SINO;
                              eaObserv = eaObserv + ", " + aAlfa + "/" + (("000000" + #dscam003@#1) % -106);
                        |FINSI;
                        eaObserv = eaObserv + " " + nCalc + " Euros";
                        |SI enNumOb1 = 0; enNumOb1 = nCalc; |SINO;
                           |SI enNumOb2 = 0; enNumOb2 = nCalc; |SINO;
                              |SI enNumOb3 = 0; enNumOb3 = nCalc; |SINO;
                                 |SI enNumOb4 = 0; enNumOb4 = nCalc; |SINO;
                                    |SI enNumOb5 = 0; enNumOb5 = nCalc; |SINO;
                                       |SI enNumOb6 = 0; enNumOb6 = nCalc; |SINO;
                                          |SI enNumOb7 = 0; enNumOb7 = nCalc; |SINO;
                                             |SI enNumOb8 = 0; enNumOb8 = nCalc; |SINO;
                                                |SI enNumOb9 = 0; enNumOb9 = nCalc; |FINSI;
                                             |FINSI;
                                          |FINSI;
                                       |FINSI;
                                    |FINSI;
                                 |FINSI;
                              |FINSI;
                           |FINSI;
                        |FINSI;
                     |FINSI;
                     |LEE 000#dscam003@.s;
                  |SIGUE;
               |FINSI;
            |FINSI;
            |DESCARGA_DEF #dscam051@;

            |SELECT #1#dscam003@; |CIERRA #dscam003@;
         |FINSI;

         |DESCARGA_DEF #dscam003@;
      |FINSI;

      |CIERRA #dscam045@; |DESCARGA_DEF #dscam045@;
   |FINSI;
|FPRC;

|PROCESO GraInforpor;
     |DDEF aAlfa;
     aAlfa = aAlfa + "infom005";
     |CARGA_DEF aAlfa, refere1@;
     |SI FSalida = 0;
          |ABRE #refere1@;
          #refere1@#0 = "F";
          #refere1@#1 = #134#49;
          #refere1@#2 = #134#0;
          |GRABA 000#refere1@.n;
          |CIERRA #refere1@;
          |DESCARGA_DEF #refere1@;
     |SINO;
          |MENAV "0000Error al cargar 'infom005'";
     |FINSI;
|FPRC;
======================================================
|PROCESO Pregunta;
     #refere1@#0 = #134#49;
     |LEE 000#refere1@.=;
     |SI FSalida = 0; |Y #refere1@#2 = "S";
          |SI nPrime = 0;
               |MENU aMenuTaglo;
               |SI FSalida = 2;
                    eaTagloItem = "S";
                    |MENU aMenuTagloI;
                    |SI FSalida = 2;
                         eaTagloItem = "X";
                    |FINSI;
               |FINSI;
               nPrime = 1;
          |FINSI;
     |SINO;
          enCuentaFac = enCuentaFac + 1;
     |FINSI;
|FPRC;

|DEFBUCLE Pregunta;
     #134#1;
     2,1,45,31,11;
     #0#9, #0#2 , #0#0 , #0#4 , #0#6 ,  #0#7, #0#42;
     #0#10,#0#3 , #0#1 , #0#5 , #0#6 ,  #0#8, #0#43;
     be;
     NULL, Pregunta;
|FIN;

|PROCESO TagloTmpItem;
     #300#0 = #134#49;
     #300#1 = #134#0;
     #300#2 = #134#45;
     |GRABA 000#300n;
|FPRC;

|PROCESO TagloItemDoc;
     |SI enSw_tagz0023 = 0;
          eaTagloItem = "N";
          |DDEF aAlfa;
          aAlfa = aAlfa + "tagm0088";
          |CARGA_DEF aAlfa, refere1@;
          |SI FSalida = 0;
               |ABRE #refere1@;
               enCuentaFac = 0;
               |BUCLE Pregunta;
               |CIERRA #refere1@;
               |DESCARGA_DEF #refere1@;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO TagloSerItem;
     nSal = 1;
     |SI enSw_tagz0023 = 0;
          |DDEF aAlfa;
          aAlfa = aAlfa + "tagm0088";
          |CARGA_DEF aAlfa, refere1@;
          |SI FSalida = 0;
               |ABRE #refere1@;
               #refere1@#0 = #134#49;
               |LEE 000#refere1@.=;
               |SI FSalida = 0; |Y #refere1@#2 = "S";
                    nSal = 0
               |FINSI;
               |CIERRA #refere1@;
               |DESCARGA_DEF #refere1@;
          |FINSI;
     |FINSI;
     FSalida = nSal;
|FPRC;
======================================================
|PROCESO TmpGraDoc;
     #300#0 = #134#49;
     #300#1 = #134#0;
     #300#2 = #134#45;
     |GRABA 000#300n;
|FPRC;

|PROCESO TmpIniDoc;
     |HAZ CreaTempo; aTmp300 = Tempo; |NOME_DAT #300 Tempo; |DELINDEX #300; |ABRE #300;
|FPRC;

|PROCESO TmpFinDoc;
     |SI enSwTagloma = 0; |Y enSw_tagz0023 = 0; |Y eaTagloItem ! "N";
          aAlfa = "tagz0023;" + aTmp300;
          |SUB_EJECUTA_NP aAlfa;
     |FINSI;

     |SI enSwInforpor = 0; |Y enSwInfoz004  = 0;
          aAlfa = "infoz004;" + aTmp300;
          |SUB_EJECUTA_NP aAlfa;
     |FINSI;

     |HAZ EsDefelino;
     |SI FSalida = 0;
          aAlfa = "defelz07;" + aTmp300;
          |SUB_EJECUTA_NP aAlfa;
     |FINSI;

     |SI enSwMalpesa = 0;
          aAlfa = "malpe214;" + aTmp300;
          |SUB_EJECUTA_NP aAlfa;        || Chequeo de precios
     |FINSI;

     |CIERRA #300; Tempo = aTmp300; |HAZ BoraTempo; |DELINDEX #300;
|FPRC;


|PROCESO IdiomaArticulo;
     eaAlfa = "";
     |ABRE #225;
     #225#0 = #24#205;
     |LEE 000#225=;
     |SI FSalida = 0;
          |ABRE #156;
          #156#0 = eaArti;
          #156#1 = #225#5;
          |LEE 000#156=;
          |SI FSalida = 0;
               eaAlfa = #156#2; |QBF eaAlfa;
          |FINSI;
          |CIERRA #156;
     |FINSI;
     |CIERRA #225;
|FPRC;

|PROCESO MalpeRegraPrecio; || T11813
     enEstaDentro = 1;
     |DDEF aPath;
     aAlfa = aPath + "malpe091";
     |CARGA_DEF aAlfa, refere1@;
     |SI FSalida = 0;
          aAlfa = aPath + "agifa071";
          |CARGA_DEF aAlfa, refere2@;
          |SI FSalida = 0;
               |ABRE #refere1@;
               |ABRE #refere2@;
               #refere1@#29 = #10#52;
               #refere1@#0 = #10#0;
               #refere1@#1 = 0;
               |LEE 000#refere1@.];
               |PARA; |SI FSalida = 0; |Y #refere1@#29 = #10#52;
                         |Y #refere1@#0 = #10#0; |HACIENDO;
                    #refere2@#29 = #refere1@#29;
                    #refere2@#0 = #refere1@#0;
                    #refere2@#1 = #refere1@#1;
                    |LEE 121#refere2@.=;
                    |SI FSalida = 0;
                         #refere2@#6 = #refere1@#6;
                         #refere2@#36 = #refere1@#36;
                         #refere2@#38 = #refere1@#38;
                         |GRABA 020#refere2@.a;
                         |LIBERA #refere2@;
                    |FINSI;
                    |LEE 000#refere1@.s;
               |SIGUE;
               |CIERRA #refere2@;
               |CIERRA #refere1@;
               |DESCARGA_DEF #refere2@;
          |FINSI;
          |DESCARGA_DEF #refere1@;
     |FINSI;
     enEstaDentro = 0;
|FPRC;
