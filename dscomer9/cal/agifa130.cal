|FICHEROS;
     agifa130 #0;
     agifa059 #1;
     agifa010 #2;
     agifa071 #3;
     agifa019 #4;
     agifa024 #6;
     agifa025 #7;
     agifa091 #10;
     agifa142 #41;       ||parametros generales
     agifa027 #42;  || Contador.              || VIC Puesto el 15/07/98
     agi00002 #100;      || Trabajos(C).
     agi00003 #101;      || Trabajos(L).
     agifa007 #30;
     agifa321 #35;  || Parametros de Divisas
     agifa328 #36;  || Clientes/Divisas
     agifa329 #37;  || Lineas de Clientes/Divisas
     agifa324 #38;  || Divisas
     agifa325 #31;  || Historico
     agifa084 #84;
     dsm00114 #114;

     agifa704 #100;
     agifa716 #101;

     dsm00124 #124;
     dsm00153 #153;
     dsm00279 #279;
     agifa722 #200;
     dsm00087@;
     Referen@ #1000;
     referen@;
|FIN;

|VARIABLES;
     nSwNolog = 0;
     aUsu = "";
     nContaLog = 0;
     aSer = "";
     aNum = "";
     aTipo = "";
     nTipo = 0;
     &eaProg         = "";
     &enReContab     = 0;

     nEuro           = 0;
     nModo           = 0;
     FEstado         = 0;
     nCalc           = 0;
     aEuro           = "";
     nSal            = 0;
     aAlfa           = "";
     aAlfa1          = "";
     nSwHay          = 0;
     &enErrCarte     = 0;
     &eaTag          = "";
     aConfi          = "";
     nSwErr          = 0;
     nSwFlag         = 0;
     aPrograma       = "";
     nModo130        = 0;
     nImpo           = 0;
     nForma          = 0;
     nDto            = 0;
     &nDeci_Div      = 0;
     &nDeci_ImpVis   = 0;

     &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base
     &nDeci_DivF     = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDivF  = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVisF  = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVisF = 0;  || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVisF  = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVisF  = 0;   || Decimales en el Importe visual. (lineas)

     &eaCodigo       = "";
     &eaTipoCodigo   = "CL";
     nfecha    = 0;
                         || activadas y la serie es de divisas
     &decim_divisa = 0;  || Decimales de la divisa
     &precio_divisa = 0; || Decimales del precio en divisa
     &decim_base = 0;    || Decimales de la moneda base
     &precio_base = 0;   || Decimales del precio en moneda base
     div_act = 0;        || Divisa actualizada. Me sirve en un PARA para que
                         || no salga hasta que este actualizada (div_act=1)
     &cli_divisa = "";  || Codigo de Cliente. Se pasa a CLIENTES/DIVISAS
     &divisa = "";       || Codigo de Divisa. Se pasa a ACTUAL. de DIVISAS
     factor = 0;         || factor de diferencia de cambio de albaran /factura
     div    = "";        || Variable de pintado
     sali = 0;           || Para condicio de salida
     camb = 0;           || Var. aux. para guardar el cambio
     &sserie   = "";
     &nnumer   = 0;
     &ffecha   = @;
     &cclien   = "";
     &nnombr   = "";
     &consulta = "";
     &ccoste   = 0;

     &ser_fac       = "";
     &num_fac       = 0;
     &reimp         = "N";

     fecha          = "          ";
     cafe           = "";
     diafe          = "";
     dianu          = "";
     fmes           = " ";
     mensaje1       = "0000El cliente del abono NO coincide con el de la factura";
     mensaje2       = "0000Este Abono YA ESTA incluido en la factura: %s";
     mensaje3       = "0000Este abono NO corresponde a esta factura";
     mensaje4       = " ";
     mensaje5       = "Procesando Abono :         Linea :     Articulo :";
     mensaje10      = "0000No se puede modificar el CLIENTE";
     mensajei       = "2400NDesea imprimir esta factura? ";
     mensaje17      = "0000NDesea dejar la factura como NO impresa y anular los recibos?";
     mensabono      = "0000Este Albaran no es de Abono.Utilice mantenimiento de Facturas";
     blanca         = "                    ";

     &sw_modo       = 0;
     &diferencia    = 0;
     &importe_t     = 0;
     &total         = 0;
     &num_lin       = 0;

     primera        = 0;
     num            = 0;
     saltar         = 0;
     voy            = 0;
     con            = 0;
     mes            = 0;
     imneto         = 0;
     margen         = 0;
     impreso        = 0;
     redondeo       = 0;
     yaesta         = 0;
     base0          = 0;
     base1          = 0;
     base2          = 0;
     base3          = 0;
     base4          = 0;
     base5          = 0;
     bruto          = 0;
     b0             = 0;
     p0             = 0;
     b1             = 0;
     p1             = 0;
     b2             = 0;
     p2             = 0;
     b3             = 0;
     p3             = 0;
     b4             = 0;
     p4             = 0;
     b5             = 0;
     p5             = 0;
     br             = 0;
     tp             = 0;
     tv             = 0;
     i              = 0;
     importe        = 0;
     importe_n      = 0;
     resto          = 0;
     a              = 0;
     j              = 0;
     em             = 0;
     k              = 0;
     abono          = 0;
     c              = 0;
     entrada        = 0;
     mala           = 0;
     modo           = 0;
     mod_venci      = 0;
     mes_ven        = 0;
     tipo_imp       = 0;

     &fechae        = @;

     fecha_fac      = @;
     lafecha        = @;
          &SFactura = "";
          &NFactura = 0;
          &CFactura = "";
          &DesdeRec = 0;
          &TAcuenta = 0;
alfa = "";
cont     = "";
contador = 0;

     || MENU PARA INTRODUCIR EL CODIGO DEL CLIENTE DE FORMA AUTOMATICA.
 {-1}menu           = "";                   || VIC Puesto 15/07/98
     menu1          = "2400";
     menu2          = "1";
     menu3          = "Contador:  ";
     menu4          = "AM";
     menu5          = " Automatico ";
     menu6          = " Manual ";
     so             = "";
     no             = "";
     &nEditar = 99;

     fFechaAnt = @;
     aContab   = "";
     &PRMNT_enError = 0;
     aSerie    = "";
     nContador = 0;
     Comodin   = "";
     Comodin1  = "";
     nSw       = 0;

     aNifQbf1   = "";
     aNifQbf2   = "";

     &eaVarDni  = "";
     &enCalcCif = 0;
|FIN;

|INCLUYE i_varart;

|PROCESO CalculaNif;
     nSal = FSalida;

     |ABRE #6;
     #6#0 = #0#2;
     |LEE 000#6=;
     |CIERRA #6;
     eaPais = #6#205;

     |SI nSal = 9;
         eaVarDni   = #0Campo;
         enCalcCif  = 1;
         |HAZ CalculoNIFCIF;
         #0Campo = eaVarDni;
         |PINTA #0Campo;
         |ERROR;
         |ACABA;
     |FINSI;

     eaVarDni  = #0Campo;
     enCalcCif = 0;
     |HAZ CalculoNIFCIF;

     aNifQbf1 = #0Campo;   |QBF aNifQbf1;
     aNifQbf2 = eaVarDni;  |QBF aNifQbf2;

     |SI aNifQbf1 ! aNifQbf2; |Y aNifQbf1 ! "";
         |CONFI "0000SEl Nif puede ser Erroneo. Desea Calcularlo.";
         |SI FSalida = 0;
             #0Campo = eaVarDni;  |PINTA #0Campo;
             |ERROR;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Entra130; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |HAZ ControlUsuFV;
     |SI enErr ! 0; |PTEC 807; |ACABA; |FINSI;
     |ABRE #agifa142; |LEE 000#agifa142.p; |CIERRA #agifa142;
     |SI #agifa142#185 = "S"; #0#49 = #agifa142#189; |FINSI;

     |C_P #0#2, 0, enPosCli;
     |HAZ DefSerVta;
     |SI nModo = 1; |Y #279#24 = "S";
          |SI eaSerCli ! "";
               #0#49 = eaSerCli; |PTEC 802;
          |SINO;
               |PTEC 807; |PTEC 807; |ERROR; |ACABA;
          |FINSI;
     |FINSI;
|FPRC;


||este calculo se efectua al entra el n de factura y pone un flag a 0
|CALCULO fprevio;|TIPO 0;
     modo = (FEntrada / 100) ! 0;
     |SI modo = 1;
          |HAZ CtrlFecha134;
          |SI FSalida ! 0; |ERROR; |ACABA; |FINSI;
          primera = 0;
     |SINO;
          primera = 1;
     |FINSI;
     ||컴컴컴컴컴컴컴컴컴컴컴
     |HAZ EsTecatel;
     |SI FSalida = 0;
          efFecha = #0#1;
          |HAZ TecaModiFac;
          |SI FSalida ! 0;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;
     ||컴컴컴컴컴컴컴컴컴컴컴
|FCAL;

|PROCESO borrarec;
     eaProg = "agifa134";
     |HAZ MiraRecVenta;
     |SI enErrCarte ! 0;
          |MENAV "0000Recibos con movimientos, NO SE DARA DE BAJA...";
          nSwErr = 1; |ACABA;
     |FINSI;
     eaProg = "agifa134";
     |HAZ BorraRecVenta;
|FPRC;

|PROCESO baja11; |TIPO 1;
     nSwFlag = 0;
|FPRC;

|PROCESO MiraAbono;
     nSwErr = 0;
     |ABRE #1;      ||Linfac
     |ABRE #2;     ||alba
     #1#14 = #0#49; ||serie
     #1#0 = #0#0;
     #1#1 = 1;
     |LEE 001#1];
     |SI FSalida = 0; |Y #1#0 = #0#0; |Y #1#14 = #0#49;
          #2#52 = #1#15; ||serie albaran
          #2#0 = #1#2;
          |LEE 001#2=;
          |SI FSalida = 0;
               |SI #2#43 = "N";
                    |MENAV "0000Esta factura NO es de ABONO, utilize el proceso Facturas";
                    nSwErr = 1;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #1;
     |CIERRA #2;
|FPRC;

|PROCESO PermiteConta;
     |AVISO;
     |SI #41#216 = "N";
          |MENAV "0000Esta Factura Esta Contabilizada...";
          FSalida = 1;
     |SINO;
          |SI #41#216 = "R";
               aAlfa = Usuario % 810;
               |ABRE #124;
               #124#0 = aAlfa;
               |LEE 000#124=;
               |SI FSalida = 0;
                    |CONFI "0000NEsta Factura Esta Contabilizada: Desea Continuar? ";
               |SINO;
                    |MENAV "0000Esta Factura Esta Contabilizada...";
               |FINSI;
               aAlfa = FSalida;
               |CIERRA #124;
               FSalida = aAlfa;
          |SINO; || = "T"
               |CONFI "0000NEsta Factura Esta Contabilizada: Desea Continuar? ";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Asiento;
   nModo = (FEntrada / 100) ! 0;

   aAlfa1 = #agifa130#1; |QBF aAlfa1; aAlfa1 = aAlfa1 % -104; nSwHay = 0;
   |ABRE #agifa722;
   #agifa722#0 = "FV";
   #agifa722#1 = #agifa130#49;
   #agifa722#2 = #agifa130#0;
   #agifa722#11 = 1;
   |LEE 000#agifa722.];
   FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
   |PARA; |SI FSalida = 0; |Y #agifa722#0 = "FV"; |Y aAlfa = #agifa130#49;
    |Y nCalc = #agifa130#0; |HACIENDO;
      aAlfa = #agifa722#3; |QBF aAlfa;
      |SI aAlfa = aAlfa1; nSwHay = 1; |SAL; |FINSI;
      |LEE 000#agifa722.s;
      FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
   |SIGUE;
   |CIERRA #agifa722;

   aAlfa1 = "N";
   |SI nSwHay = 1;
      aAlfa = "ac" + Usuario; |NOME_DAT #agifa716#aAlfa#;
      |DELINDEX #agifa716; |ABRE #agifa716;

      |ABRE #agifa704;
      #agifa704#0 = #agifa722#10;
      |LEE 000#agifa704.=;
      |SI FSalida = 0;
         |SI #agifa704#8 = "S";
            |DDEFECTO #agifa716;
            #agifa716#15 = #agifa722#10;  #agifa716#0  = 1;
            #agifa716#13 = "agifa071";    #agifa716#14 = 30;
            #agifa716#11 = "A";           #agifa716#12 = 5;
            #agifa716#3  = #agifa130#49;  #agifa716#4  = #agifa130#49;
            |GRABA 020#agifa716.n;

            |DDEFECTO #agifa716;
            #agifa716#15 = #agifa722#10;  #agifa716#0  = 2;
            #agifa716#13 = "agifa071";    #agifa716#14 = 26;
            #agifa716#11 = "N";           #agifa716#12 = 6;
            #agifa716#5  = #agifa130#0;   #agifa716#6  = #agifa130#0;
            |GRABA 020#agifa716.n;
            |LIBERA #agifa716; |CIERRA #agifa716;
         |SINO;
            |DDEFECTO #agifa716;
            #agifa716#15 = #agifa722#10;  #agifa716#0  = 1;
            #agifa716#13 = "agifa134";    #agifa716#14 = 49;
            #agifa716#11 = "A";           #agifa716#12 = 5;
            #agifa716#3  = #agifa130#49;  #agifa716#4  = #agifa130#49;
            |GRABA 020#agifa716.n;

            |DDEFECTO #agifa716;
            #agifa716#15 = #agifa722#10;  #agifa716#0  = 2;
            #agifa716#13 = "agifa134";    #agifa716#14 = 0;
            #agifa716#11 = "N";           #agifa716#12 = 6;
            #agifa716#5  = #agifa130#0;   #agifa716#6  = #agifa130#0;
            |GRABA 020#agifa716.n;
            |LIBERA #agifa716; |CIERRA #agifa716;
         |FINSI;
      |FINSI;
      |CIERRA #agifa704;

      aSerie = #agifa130#49; nContador = #agifa130#0;
      |GRABA 020#agifa130.a;
      |LIBERA #agifa130; |CIERRAT #agifa130;

      Comodin1 = #agifa130#1; |QBF Comodin1; Comodin1 = Comodin1 % -104;
      Comodin = #agifa722#10; |QBF Comodin;
      |SI nSw = 1; || BORRA
         Comodin = "agifa711.tab;" + Comodin + ",B*" + Comodin1 + ",SINPRELV";
         aAlfa1 = "N";
      |FINSI;
      |SI nSw = 2; || ENLAZA
         Comodin = "agifa711.tab;" + Comodin + ",SINPRELV";
         aAlfa1 = "S";
      |FINSI;
      |SUB_EJECUTA_NP Comodin;
      |DELINDEX #agifa716;

      |ABRET #agifa130;
      #agifa130#49 = aSerie; #agifa130#0 = nContador;
      |LEE 121#agifa130.=;
   |FINSI;
   |SI PRMNT_enError = 0;
      #agifa130#48 = aAlfa1; |GRABA 020#agifa130.a;
   |FINSI;
   nSw = PRMNT_enError;
|FPRC;

|PROCESO actufa;|TIPO 2;
     con = (FEntrada / 100) ! 0;
     nForma = 0 +. 1;
     |SI con = 1; nSwFlag = 0; |FINSI;
     |SI nSwFlag = 1; |ACABA; |FINSI;

     |HAZ ControlUsuFC;
     |SI enErr ! 0; nSwFlag = 1; |ERROR; |ACABA; |FINSI;

     |SI con = 3;
          |HAZ CheqRecticativa;
          |SI enErr ! 0; nSwFlag = 1; |ERROR; |ACABA; |FINSI;
     |FINSI;

     |SI con = 2; |O con = 3;
          |HAZ MiraAbono;
          |SI nSwErr ! 0;
               nSwFlag = 1;
               |ERROR; |ACABA;
          |FINSI;
          ||컴컴컴컴컴컴컴컴컴컴컴
          |HAZ EsTecatel;
          |SI FSalida = 0;
               efFecha = #0#1;
               |HAZ TecaModiFac;
               |SI FSalida ! 0;
                    nSwFlag = 1;
                    |ERROR; |ACABA;
               |FINSI;
          |FINSI;
          ||컴컴컴컴컴컴컴컴컴컴컴
     |FINSI;

     |SI #0#48 = "S";
          |SI con ] 2; |Y nForma ! 1;
               |HAZ PermiteConta;
               aContab = "N"; fFechaAnt = #agifa130#1;
               |SI FSalida ! 0;
                  nSwFlag = 1; |ERROR; |ACABA;
               |SINO;
                  nSw = 1; aContab = "S"; |HAZ Asiento;
                  |SI nSw < 0;
                     nSwFlag = 1; |ERROR; |ACABA;
                  |FINSI;
                  #0#48 = "N"; |PINTA #0#48;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #0#45 = "S";
          |SI con ] 2;|Y nForma ! 1;
               eaProg = "agifa134"; |HAZ MiraRecVenta;
               |SI enErrCarte ! 0;
                    aAlfa = "0000Recibos con movimientos, NO SE DARA DE BAJA... [" + enErrCarte + "]";
                    |MENAV aAlfa; nSwFlag = 1; |ERROR; |ACABA;
               |FINSI;

               |AVISO;
               |CONFI "0000NDesea dejar la factura como NO impresa y anular los recibos?  ";
               |SI FSalida ! 0;
                    |SI aContab = "S";
                       |CONFI "N    Volver a dejar contabilizada la factura ? ";
                       |SI FSalida = 0;
                          enReContab = 1;
                          nSw = 2; |HAZ Asiento;
                          enReContab = 0;
                       |SINO;
                          |HAZ BorraHisEnlace;
                          aContab = "N";
                       |FINSI;
                    |FINSI;
                    nSwFlag = 1; |ERROR; |ACABA;
               |SINO;
                    |HAZ borrarec;
                    |SI nSwErr ! 0;
                       nSwFlag = 1; |ERROR; |ACABA;
                    |FINSI;
                    |HAZ BorraVenciVta;
               |FINSI;
          |FINSI;
          #0#45 = "N"; |PINTA #0#45;
     |FINSI;

     |SI nForma > 0;
          nSwNolog = 1;        || No se porque pero se ejecuta el TIPO 15
          |HAZ CalCabAgifa134;
          nSwNolog = 0;
          |SI aContab = "S";
             |SI #agifa130#1 = fFechaAnt;
                |CONFI "    SEsta factura estaba contabilizada.  Volver a enlazar ? ";
             |SINO;
                FSalida = 1;
             |FINSI;
             |SI FSalida = 0;
                nSw = 2; |HAZ Asiento;
             |SINO;
                |HAZ BorraHisEnlace;
             |FINSI;
             aContab = "N";
          |FINSI;
          |HAZ ttrabajo;
     |FINSI;

     |ABRE #6;
     #6#0 = #0#2;
     |LEE 121#6=;
     |SI FSalida = 0;
          fmes = #0#1 % A402;
          mes = fmes - 1;
          mes = mes * 4;
          mes = mes + 54;
          imneto = #0#18 - #0#17;
          |SI #41#115 = "N";
               nImpo = (imneto * 100) / (100 - #0#6);
               nDto = #0#17 + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
               nDto = #0#17;
          |FINSI;
          #6#50 = #6#50 -. imneto;      ||pendiente de facturar
          #6mes = #6mes +. nImpo;
          mes = mes + 1;
          #6mes = #6mes +. nDto;
          mes = mes + 1;
          #6mes = #6mes +. #0#46;
          #6#102 = #6#102 +. nImpo;
          #6#103 = #6#103 +. nDto;
          #6#104 = #6#104 +. #0#46;
          mes = fmes - 1;
          mes = mes * 3;
          mes = mes + 115;
          #6mes = #6mes -. nImpo;
          #6#151 = #6#151 -. nImpo;
          mes = FEntrada / 100;
          mes = mes ! 0;
          |SI 1 = mes;
               #6#45 = #0#1;
               #6#46 = imneto;
          |FINSI;
          #6#110 = #6#110 +. imneto;
          |GRABA 020#6a;
          |LIBERA #6;

          enImpCliPen = -imneto * nForma;
          enImpCliCom = nImpo * nForma;
          enImpCliDto = nDto * nForma;
          enImpCliMar = #0#46 * nForma;
          enImpCliFac = imneto * nForma;
          enImpCliAbo = -nImpo * nForma;
          eaCliente = #0#2;
          efFecha = #0#1;
          |HAZ AcumulaCli;

     |FINSI;
     |CIERRA #6;

     eaTag = "FAC";  |HAZ Riesgos;

     |ABRE #7;
     #7#0 = #0#7;
     |LEE 121#7=;
     |SI 0 = FSalida;
          imneto = #0#18 - #0#17;
          fmes = #0#1 % A402;
          mes = fmes - 1;
          mes = mes * 2;
          mes = mes + 11;
          #7mes = #7mes +. #0#8;

          mes = mes + 1;
          #7mes = #7mes +. imneto;
          #7#35 = #7#35 +. #0#8;
          #7#36 = #7#36 +. imneto;
          mes = fmes - 1;
          mes = mes + 40;
          #7mes = #7mes +. #0#55;
          #7#52 = #7#52 +. #0#55;

          |GRABA 020#7a;
          |LIBERA #7;

          enImpRepComi = #0#8 * nForma;
          enImpRepVta = imneto * nForma;
          enImpRepRete = #0#55 * nForma;
          eaRepre = #0#7;
          efFecha = #0#1;
          |HAZ AcumulaRep;
     |FINSI;
     |CIERRA #7;

     |SI con = 3;
          |HAZ BorraRecticativa;

          |HAZ EsAlbero;
          |SI FSalida = 0;
               |HAZ AlbeFacVBorra;
          |FINSI;

          |HAZ EsInforpor;
          |SI FSalida = 0;
               |HAZ BajaInforpor;
          |FINSI;
     |FINSI;

     ||컴컴컴컴컴컴Automatizacion Empresas
     |ABRE #dsm00114; |LEE 000#dsm00114.p; nSal = FSalida; |CIERRA #dsm00114;
     |SI nSal = 0;
          eaCli = #0#2;
          |SI nForma = 1;
               aAlfa = "dsz99983;FACALTA" + #0#49 + (("000000" + #0#0) % -106);
               |SUB_EJECUTA aAlfa;
          |SINO;
               aAlfa = "dsz99983;FACBAJA" + #0#49 + (("000000" + #0#0) % -106);
               |SUB_EJECUTA aAlfa;
          |FINSI;
     |FINSI;

     |HAZ EsSematel;
     |SI FSalida = 0;
          eaSerie = #0#49;
          enCodigo = #0#0;
          enForma = nForma;
          |SUB_EJECUTA_NP "tlfw0002;FACTURA";
     |FINSI;
     |HAZ EsWeb;
     |SI FSalida = 0;
          |HAZ DocWeb;
     |FINSI;
|FPRC;


|PROCESO fecha_pact_lin;
|SI #agifa325#4 > #2#72; |Y sali = 0; || Si la fecha en el hist. > fecha pactada ...
  #1#19 = camb;||Significa que me he pasado, el cambio valido es el anterior
  sali = 1; || Para que no vuelva a entrar en la condicion
  |SI camb = 0; || Si vale 0, significa que no hay actualizaciones anteriores, por tanto...
    |MENAV "0000Se utiliza como fecha de pacto la de la primera actualizacion";
    #1#19 = #agifa325#2; || Asigno el cambio de la 1a. actualizacion
  |FINSI;
|FINSI;
camb = #agifa325#2; ||Me guardo el cambio para la siguiente linea
|FPRC;

|PROCESO BorraHisEnlace;
     aAlfa1 = #agifa130#1; |QBF aAlfa1; aAlfa1 = aAlfa1 % -104; nSw = 0;
     |ABRE #agifa722;
     #agifa722#0 = "FV";
     #agifa722#1 = #agifa130#49;
     #agifa722#2 = #agifa130#0;
     #agifa722#11 = 1;
     |LEE 000#agifa722.];
     FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
     |PARA; |SI FSalida = 0; |Y #agifa722#0 = "FV"; |Y aAlfa = #agifa130#49;
      |Y nCalc = #agifa130#0; |HACIENDO;
        aAlfa = #agifa722#3; |QBF aAlfa;
        |SI aAlfa = aAlfa1; nSwHay = 1; |SAL; |FINSI;
        |LEE 000#agifa722.s;
        FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
      |SIGUE;
     |SI nSwHay = 1; |BORRA 020#agifa722.a; |FINSI;
     |CIERRA #agifa722;
|FPRC;

|DEFBUCLE fecha_pact; || Recorre el Historico de actualizaciones
#agifa325#2;          || 2a. Clave: divisa,fecha,guia
;
#1#18,"00.00.0000",0;
#1#18,"31.12.9999",99999999;
be;
NULL,fecha_pact_lin;
|FINSI;


|CALCULO defecfl;|TIPO 0;
     |ABRE #2;
     #2#52 = #1#15;
     #2#0 = #1#2;
     |LEE 000#2=;
     |HAZ controli;
     |SI FSalida ! 0;  |ERROR;  |ACABA;  |FINSI;
     |CIERRA #2;

     |SI #279#11 = "N";
          |SI #2#1 < "01.07.2010"; |Y #0#1 ] "01.07.2010";
               |MENAV "0000El % de iva no coincide con el de la factura";
               |ERROR; |ACABA;
          |FINSI;
          |SI #2#1 ] "01.07.2010"; |Y #0#1 < "01.07.2010";
               |MENAV "0000El % de iva no coincide con el de la factura";
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     #0#58 = #2#68; || Divisa (cabecera)
     #0#59 = #2#69; || Cambio Divisa (cabecera)
     #0#60 = #2#70; || Moneda de trabajo (cabecera)
     #0#122 = #2#91; || %Retencion
     #1#18 = #2#68; || Divisa (lineas)
     #1#19 = #2#69; || Cambio (lineas;
     #0#115 = #2#84;||Dir.Ent.

     |SI #2#71 = "A"; || Si en el alb., el cambio esta pact. a la fecha de la factura
         |HAZ Param_Divisas3; || Lee Parametros
     |FINSI;

     #1#20 = #2#70; || Moneda de trabajo (lineas)
     |SI #2#71 = "F"; || Si en el alb., el cambio esta pact. a la fecha de la factura
         |HAZ CambioDivisa3; || Coge el valor actual de la divisa
     |FINSI;

     |SI #2#71 = "O"; || Si en el alb. el cambio esta pactado a Otra fecha
         |ABRE #agifa325; || Abre Hist. de actualizaciones
         sali = 0;  || Inicializo
         camb = 0;
         |BUCLE fecha_pact; || Busca en el historico de actualizaciones
         |SI sali = 0;
             |MENAV "0000Se utiliza como fecha de pacto la de la ultima actualizacion";
             #1#19 = camb;
         |FINSI;
         |CIERRA #agifa325;
         |HAZ Param_Divisas3; || Lee Parametros
      |FINSI;

      |HAZ CalLinAgifa134;

      |PINTA #1#27;
      |PINTA #1#28;
      |PINTA #1#30;
      |PINTA #1#31;
      |PINTA #1#32;
|FCAL;

|CALCULO leepago;|TIPO 0;
   |DDEFECTO #10;
   |ABRE #10;
   #10#0 = #0#11;
   |LEE 021#10=;
   |CIERRA #10;
|FCAL;

|CALCULO kactuar;|TIPO 0;
     |PINTA 2450,#3#1;|PINTA 2465,#3#2;
     #4#0 = #3#2;
     |LEE 121#4=;
     |SI 0 = FSalida;
          |SI #4#194 = 2;
               nImpo = ((((#3#48 * #3#6) < #3#8) < #3#33) < #2#5) < #2#32;
          |SINO;
               nImpo = ((((#3#5 * #3#6) < #3#8) < #3#33) < #2#5) < #2#32;
          |FINSI;
          |SI #41#115 = "S";
               nImpo = nImpo < #2#7;
          |FINSI;
          margen = #3#14;             ||Coste albaran !!
          |SI #0#57 = "S";
               nImpo = -nImpo;
               margen = nImpo + margen;
          |SINO;
               margen = nImpo - margen;
          |FINSI;
          #2#37 = #2#37 + (margen * nForma);

          fmes = #0#1 % A402;
          mes = ((fmes - 1) * 5) + 35;

          #4mes = #4mes + (nImpo * nForma);      ||       imneto;
          mes = mes + 1;
          #4mes = #4mes + (margen * nForma);
          #4#95 = #4#95 + (nImpo * nForma);       ||    imneto;
          #4#96 = #4#96 + (margen * nForma);
          mes = (FEntrada / 100) ! 0;
          |SI 1 = mes; |Y #279#30 = "F";
               #4#24 = #0#1;
               #4#25 = #3#5;
          |FINSI;
          |GRABA 020#4a;
          |LIBERA #4;

          efFecha = #0#1;
          eaArticulo = #3#2;
          enImpVta = (nImpo * nForma);
          enImpMar = (margen * nForma);
          |HAZ AcumulaArt;

          enForma = nForma;
          enImpKit = nImpo;
          enMrgKit = margen;
          |HAZ ImpArtKit;    || Acumulados Articulos con Kit
     |FINSI;
     |LEE 110#3=;
     |SI nForma > 0;
          #3#26 = #0#0;           || pone numero factura en linea
          #3#30 = #0#49;
     |SINO;
          #3#26 = blanca;
          #3#30 = "  ";
     |FINSI;
     |GRABA 020#3a;
     |LIBERA #3;
|FCAL;

|CALCULO actufl;|TIPO 2;
     nForma = 0 +. 1;
     |ABRE #2;
     #2#52 = #1#15;
     #2#0 = #1#2;
     |LEE 101#2=;
     |SI FSalida ! 0;
          |ERROR; |ACABA;
     |SINO;
          |SI 0 = primera; primera = 1; |FINSI;
          |SI 0 < nForma;
               |HAZ controli;
          |FINSI;
          |SI 0 = FSalida;
               #0#63 = #0#63 +. 1;  || Numero de lineas existentes
               |SI #0#63 = 1;       || Si hay solo una linea ...
                    #0#58 = #1#18;     || ... cojo la divisa ...
                    #0#60 = #1#20;     || ... y la moneda de trabajo.
               |FINSI;
               |SI 0 < nForma;
                    #2#38 = AS;
                    #2#39 = #0#0;
                    #2#60 = #0#1;
                    #2#53 = #0#49;
               |SINO;
                    #2#60 = "01.01.0001";
                    #2#38 = "N";
                    |SI #2#58 = "E"; |O #2#58 = "R";
                         #2#39 = 999999;
                    |SINO;
                         #2#39 = 0;
                    |FINSI;
                    #2#53 ="  ";
                    #2#60 = "01.01.0001";
               |FINSI;
               #2#37 = 0;


               |ABRE #4;
               |PINTA 2413,mensaje5;|PINTA 2434,#2#0;
               |BUCLELIN 0kactuar#2;
               |CIERRA #4;
               |BLIN 24;

               #0#57 = "S";
               #2#10 = "S";
               |GRABA 020#2a;

               |HAZ EsAlbero;
               |SI FSalida = 0;
                    |HAZ AlbeAlb2Fac;
               |FINSI;

               |HAZ EsGrupoSolar;
               |SI FSalida = 0;
                    |HAZ GrSolMarcaFac;
               |FINSI;
          |SINO;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;
     |CIERRA #2;
|FCAL;

|CALCULO controli;|TIPO 0;
     |HAZ EsTagloma;
     |SI FSalida = 0;
          eaAlfa = #0#49;
          |HAZ TagloDefFP;
          |SI eaAlfa ! "";
               #0#11 = eaAlfa; #2#8 = eaAlfa;
          |FINSI;
          |SI eaQuitaDto = "S";
               #0#4 = 0; #0#5 = 0; #0#6 = 0;
               #2#5 = 0; #2#32 = 0; #2#7 = 0;
          |FINSI;
     |FINSI;
     |HAZ EsGestral;
     |SI FSalida = 0;
          eaAlfa = #0#49;
          |HAZ GestrDefFP;
          |SI eaAlfa ! "";
               #0#11 = eaAlfa; #2#8 = eaAlfa;
          |FINSI;
          |SI eaQuitaDto = "S";
               #0#4 = 0; #0#5 = 0; #0#6 = 0;
               #2#5 = 0; #2#32 = 0; #2#7 = 0;
          |FINSI;
     |FINSI;

     FSalida = 0;
     |SI #2#68 ! #0#58; |O #2#70 ! #0#60;  || Si la moneda de trabajo o la divisa no coinciden ...
          |SI #0#63 > 0;  || Si ya hemos puesto alguna linea ...
               |MENAV "0000La moneda de trabajo y la divisa de los albaranes deben coincidir";
               FSalida = 100; || Error
          |FINSI;
     |FINSI;

     |SI #2#43 = AS;
          |SI #0#2 ! #2#3;
               |MENAV mensaje1;
               FSalida = 100;
          |SINO;
               |SI #2#38 ! AN;
                    mensaje4 = #2#39 ! mensaje2;
                    |MENAV mensaje4;
                    FSalida = 100;
                |SINO;
                    |SI 0 = primera;
                         i = FEntrada / 100;
                         i = i ! 0;
                         |SI 1 = i;
                              #0#4 = #2#5;#0#6 = #2#7;#0#7 = #2#6;#0#5 = #2#32;
                              #0#11 = #2#8;
                              #0#124 = #2#63;
                              ||PINTA #0#4;||PINTA #0#5;
                              ||PINTA #0#6;|PINTA #0#11;|PINTA #0#7;
                         |FINSI;
                    |FINSI;
                    |SI #0#4 ! #2#5;|O #0#6 ! #2#7;|O #0#5 ! #2#32;
                        |MENAV "0000Los descuentos del Albaran NO coinciden con Factura";
                        FSalida = 100;
                    |FINSI;
                    |SI #0#11 ! #2#8;
                        |MENAV "0000La forma de pago del Albaran NO coincide con Factura";
                        FSalida = 100;
                    |FINSI;
                    |SI #0#7 ! #2#6;|Y #41#97 = "S";
                        |MENAV "0000El Representante del Albaran NO coincide con Factura";
                        FSalida = 100;
                    |FINSI;
                    |SI #0#124 ! #2#63;
                         |MENAV "0000EL NIF/CIF del Albaran NO coincide con Factura";
                         FSalida = 100;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #2#51 = "N";
               |MENAV "0000**** ATENCION Este Abono NO es Facturable ****";
               FSalida = 100;
          |FINSI;
     |SINO;
          |MENAV mensabono;
          FSalida = 100;
     |FINSI;
|FCAL;


|CALCULO ccffcc;|TIPO 6;
     |SI #0#1 < "01.01.0000"; #0#1 = "01.01.0000"; |PINTA #0#1; |FINSI;

     con = FEntrada / 100;
     con = con ! 0;
     |SI con ! 1;|Y #0Campo ! Contenido;
          |CAMPO_MODIFICA #0#2 , 1 , "N";
          |CAMPO_MODIFICA #0#11 , 1 , "N";
     |SINO;
          |CAMPO_MODIFICA #0#2 , 1 , "S";
          |CAMPO_MODIFICA #0#11 , 1 , "S";
     |FINSI;
     |HAZ CamposModi;
|FCAL;

|PROCESO lee_param;
     |ABRE #41; #41#0 = "A"; |LEE 001#41=;
     |SI FSalida ! 0; |DDEFECTO #41; |FINSI;
     |CIERRA #41;
|FPRC;

|CALCULO siimpre1;|TIPO 3;
     modo = (FEntrada / 100) ! 0;
     |ABRE #10;
     #10#0 = #0#11;
     |LEE 000#10=;
     |CIERRA #10;

     |SI mod_venci = 0; |Y #10#76 = "S";
          |HAZ VenciVta;
          |ABRE #agifa142;
          |DDEFECTO #agifa142;
          |LEE 001#agifa142.p;
          |CIERRA #agifa142;
          |SI #agifa142#2 = "S";
               |GRABA 021#agifa130.a;
               |LIBERA #agifa130;
               ser_fac = #agifa130#49;
               num_fac = #agifa130#0;
               |CIERRAT #agifa130;
               |SUB_EJECUTA_NP "agifa133.run";
               |ABRET #agifa130;
               #agifa130#49 = ser_fac;
               #agifa130#0 = num_fac;
               |LEE 101#agifa130.=;
          |FINSI;
     |FINSI;
     mod_venci = 0;
     |SI #agifa130#45 = "N";
          |CONFI "2400NDesea imprimir esta factura? ";
          |SI 0 = FSalida;
               |HAZ impreal1;
          |FINSI;
     |FINSI;
     |SI modo = 2;
          |HAZ EsInforpor;
          |SI FSalida = 0;
               |HAZ BajaInforpor;
          |FINSI;
     |FINSI;
|FCAL;

|PROCESO T130_4; |TIPO 4;
     |SELECT #1#0;
     |LEE 000#0=;
     |SI FSalida ! 0;
          |MENAV "0000Por favor, consulte el registro correcto antes de imprimir.";
          |ACABA;
     |SINO;
          |PINDA #0#0;
          FEntrada = 402;
     |FINSI;
     |HAZ impreal1;
|FPRC;

|CALCULO impreal1;
     modo = (FEntrada /100) ! 0;
     |ABRE #6;
     #6#0 = #0#2;
     |LEE 020#6=;
     |CIERRA #6;
     |SI modo = 1; |O modo = 2;
          |GRABA 021#0a;
          |LIBERA #0;
     |FINSI;
     |CIERRAT #0;
     ser_fac = #0#49;
     num_fac = #0#0;
     reimp = #0#45;

     aPrograma = "agifa136";

     |SUB_EJECUTA_NP aPrograma;

     |ABRET #0;
     #0#49 = ser_fac;
     #0#0 = num_fac;
     |SI modo = 4;
         |LEE 001#0=;
     |SINO;
         |LEE 101#0=;
     |FINSI;
|FCAL;

|CALCULO pantbono;|TIPO 6;
     modo = (FEntrada / 100) ! 0;
     |SI FSalida = 9; |Y modo = 4;
          ser_fac = #agifa130#49;
          num_fac = #agifa130#0;
          |CIERRAT #agifa130;
          |SUB_EJECUTA_NP "agifa133.run";
          |ABRET #agifa130;
          #agifa130#49 = ser_fac;
          #agifa130#0 = num_fac;
     |FINSI;
|FCAL;

||---------------------------------------------------------------------------
|| ACTUALIZA EL FICHERO DE TRABAJOS.
||---------------------------------------------------------------------------
|PROCESO ttrabajo;
     |ABRE #100;
     |SELECT #4#100;
     #100#2 = #1#14;
     #100#3 = #1#2;
     |LEE 000#100=;
     |SI FSalida = 0;
          |SELECT #1#100;
          |LEE 121#100=;
          #100#10 = #0#49;    || Serie Factura.
          #100#11 = #0#0;     || Numero Factura.
          #100#12 = #0#1;     || Fecha Factura.
          #100#13 = #0#31;    || Total Factura.
          |GRABA 021#100a;
          |LIBERA #100;
     |FINSI;
     |CIERRA #100;
|FPRC;

||---------------------------------------------------------------------------
|| CONSULTA LOS TRABAJOS DE LA FACTURA.
||---------------------------------------------------------------------------
|PROCESO consultas; |TIPO 11;
     |SI FSalida = 9;
          |PUSHV 501 2380;
          |PINPA #0#0;
          |PINDA #0#0;
          |PAUSA;
          |POPV;
          |ERROR;
     |FINSI;
     |SI FSalida = 16;
          |ABRE #100;
          |SELECT #4#100;
          #100#2 = #1#14;
          #100#3 = #1#2;
          |LEE 000#100=;
          |SI FSalida = 0;
               sserie = #1#15;
               nnumer = #1#2;
               |PUSHV 0501 2380;
               consulta = "S";
               |SUB_EJECUTA_NP "agi00002";
               |POPV;
          |FINSI;
          |ERROR;
     |FINSI;
|FPRC;

_____________________________________/ BUSCA UN CODIGO DE CLIENTE AUTOMATICO.
|PROCESO altac; |TIPO 6;
     nModo130 = (FEntrada / 100) ! 0;
     |SI FSalida = 11; |O #41#102 = "S"; |O #41#102 = "X";
          eaCodigo = #0#2;
          eaFuerza = "N";
          |SI FSalida = 11; eaFuerza = "S"; |FINSI;
          |SUB_EJECUTA_NP "dsz99994";
          |SI #41#102 = "N"; |Y nModo130 ! 2; |ERROR;  |FINSI;
     |FINSI;
                                     || VIC Puesto por vicente 15/07/98
     alfa = #0#2;
     |QBF alfa;
     |SI alfa ! "";
          |ABRE #6;
          #6#0 = #0#2;
          |LEE 000#6=;
          |SI FSalida ! 0;
               |ABRE #41;
               |LEE 000#41p;
               |SI #41#1 = "S";
                    |HAZ Menus;
               |FINSI;
               |CIERRA #41;
          |FINSI;
          |CIERRA #6;
     |FINSI;
|FPRC;

|PROCESO Menus;
     |MENU menu;
     |SI FSalida = 1;    ||Automatico
          |ABRE #42;
          #42#2 = "";
          #42#0 = "clientes";
          |LEE 101#42=;
          |SI FSalida = 0;
               #42#1 = #42#1 + 1;
               contador = #42#1;
               |GRABA 021#42a;
          |SINO;
               contador = 1;
               #42#1 = 1;
               |GRABA 021#42n;
          |FINSI;
          cont = contador;
          cont = ("000000" + cont) % -106;
          #0Campo = cont;
          |PINTA #0Campo;
          |LIBERA #42;
          |CIERRA #42;
     |FINSI;
|FPRC;

___________/ VIC 15-07-98

|PROCESO tipo13; |TIPO 7;  ||(Antes era tipo 13)
     |ABRE #agifa321;
     |LEE 000#agifa321.p;
     |CIERRA #agifa321;
     |ABRE #agifa007;
     #agifa007#26 = #0#49;
     |LEE 000#agifa007.=; || Leo la serie de la factura
     |CIERRA #agifa007;


     |SI #agifa007#39 = "S"; |Y #agifa321#3 = "S"; ||Si serie es de divisas y pintar = "S";
          ||div = "       Mon.Tra:    Divisa:      Cambio:         ";
          ||PINTA 1031, div;
          |PINTA 1038, "Mon.Tra:";
          |PINTA 1050, "Divisa:";
          |PINTA 1063, "Cambio:";
          |ATRI I;
          |PINTA 1047, #1#20; || Mon. de trabajo
          |PINTA 1058, #1#18; || Divisa
          |PINTA 1071, #1#19; || Cambio
          |ATRI 0;
          |SI #0#60 = "B";
               div = " (" + #0#58 + ") --->";
          |SINO;
               div = " (" + #0#61 + ") --->";
          |FINSI;
          ||div = div + "                                                                ";
          |PINTA 1104,div;
          |ATRI I;
          || Pinta campos vis.
          |PINTA 1019,#1#33;
          |PINTA 1030,#1#34;
          |PINTA 1042,#1#36;
          |PINTA 1055,#1#37;
          |PINTA 1067,#1#38;
          |ATRI 0;
     |SINO;
          |SI #agifa007#39 = "S"; || Si la serie es de divisas
               ||div = "       Mon.Tra:    Divisa:      Cambio:         ";
               ||PINTA 1131, div;
               |PINTA 1038, "Mon.Tra:";
               |PINTA 1050, "Divisa:";
               |PINTA 1063, "Cambio:";
               |ATRI I;
               |PINTA 1047, #1#20; || Moneda de trabajo
               |PINTA 1058, #1#18; || Divisa
               |PINTA 1071, #1#19; || Cambio
               |ATRI 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO LeeFac; |TIPO 13;
     |HAZ LeeMonBase2; || Lee los parametros de la moneda base
     |HAZ Param_Divisas3; || Lee los parametros de la divisa
     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbeFacVPinta;
     |FINSI;
     |HAZ EsTaller;
     |SI FSalida = 0;
          |C_V #0#125, 1, "S";
          |ATRI R; |PINTA 2202, "CANON";
          |ATRI I; |PINTA 2208, #0#125;
     |FINSI;
     |HAZ EsOTP;
     |SI FSalida = 0;
          |C_V #0#9, 1, "N";
          |C_V #0#10, 1, "N";
          |PINTA 1201, "                                                           ";
     |FINSI;
|FPRC;

|PROCESO LeeMonBase2; ||Lee los parametros de la moneda base
     |ABRE #agifa321;
     |ABRE #agifa324;
     |LEE 010#agifa321.p;   ||Leo parametros de divisa
     #agifa130#61 = #agifa321#9;  ||Cojo la Moneda Base de parametros
     #agifa324#0 = #agifa321#9;
     |LEE 010#agifa324.=;         ||Leo la ficha de la moneda base en Divisas
     #agifa130#62 = #agifa324#2;  ||Asigno el cambio de la moneda base con el euro
     decim_base = #agifa324#7;    ||Asigno los decimales de la moneda base
     precio_base = #agifa324#9;   ||Asigno los decimales del precio en la mon. base
     |CIERRA #agifa324;
     |CIERRA #agifa321;
|FPRC;


|PROCESO Param_Divisas3; |TIPO 0;
     |HAZ LeeMonBase2;

     |ABRE #agifa324;
     #agifa324#0 = #0#58;
     |LEE 001#agifa324.=;   || Leo la divisa
     |CIERRA #agifa324;

     decim_divisa = #agifa324#7;  || Decimales de la divisa
     precio_divisa = #agifa324#9;  || Decimales en el precio de la divisa
     nDeci_DivF = decim_divisa;   || Decimales de la divisa
     nDeci_PreDivF = precio_divisa;  || Decimales en el precio de la divisa
     |SI #0#60 = "B";   ||Si trabajo con la moneda base ...
          nDeci_PreVisF  = precio_divisa;
          nDeci_ImpVisF  = decim_divisa;
          nDeci_Base     = decim_base;
          nDeci_PreBase  = precio_base;
          nDeci_BaseMx   = decim_base;
          nDeci_PreBaseMx= precio_base;
          nDeci_TotVisF  = decim_base;
          nDeci_TotNoVisF = decim_divisa;
     |SINO;     ||Si trabajo con la divisa ...
          nDeci_PreVisF   = precio_base;
          nDeci_ImpVisF   = decim_base;
         |SI #0#59 = 1;
              nDeci_BaseMx    = decim_base;    || sin triangulacion
              nDeci_PreBaseMx = precio_base;
         |SINO;
              nDeci_BaseMx    = #agifa321#10;  || con triangulacion
              nDeci_PreBaseMx = #agifa321#11;
         |FINSI;
          nDeci_Base     = decim_base;
          nDeci_PreBase  = precio_base;
          nDeci_TotVisF  = decim_divisa;
          nDeci_TotNoVisF = decim_base;
     |FINSI;
     nDeci_Div = nDeci_DivF;
     nDeci_ImpVis = nDeci_TotVisF;
     |HAZ Deci_IVA;
|FPRC;

|PROCESO CambioDivisa3; |TIPO 0;
      |SI #agifa024#191 = "S"; || Si el Cliente es de divisa pactada
         |ABRE #agifa328;
         |ABRE #agifa329;
         #agifa329#0 = #agifa130#2;
         #agifa329#2 = #agifa059#18;
         #agifa329#7 = "N";
         |SELECT #2#agifa329;  || Con esta clave ...
         |LEE 011#agifa329.=;  || ... busco periodos no finalizados de esa divisa
         |SI FSalida = 0;  || Si existe un periodo no finalizado
           |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
             #agifa059#18 = #agifa329#2;        || Cargo la divisa ...
             #agifa059#19 = #agifa329#3;        || ...y el cambio
             |LEE 001#agifa329.=;   || Leo las lineas de Client/Divisas
             nfecha = #agifa130#1 - #agifa329#6;  || Resto la fecha de fin de periodo a la actual
             |SI nfecha > 0;  || Si la fecha actual supera a la del periodo asignado ...
                |MENAV "0000ATENCION deberia Actualizar primero la divisa en Clientes/Divisas";
                cli_divisa = #agifa130#2;  || Le envio el cod. de Cliente a "agifa328"
                |SUB_EJECUTA_NP "agifa328.tab";  || Ejecuto Clientes/Divisas
                |ERROR;
             |SINO;
                div_act = 1;  || Para salir del PARA
             |FINSI;
           |SIGUE;
         |SINO;  || Si no existe un periodo no finalizado para esa divisa
           |MENAV "0000No existe un periodo activo para la divisa en Clientes / Divisas";
           cli_divisa = #agifa130#2;  || Le paso a "agifa328" el Cliente
           |SUB_EJECUTA_NP "agifa328.tab";  || Ejecuto Clientes / Divisas
           |ERROR;
           ||#agifa059#18 = #agifa130#61;
           ||#agifa059#19 = #agifa130#62;
         |FINSI;
         |SELECT #1#agifa329;
         |CIERRA #agifa329;
         |CIERRA #agifa328;
      |SINO; || Si el Cliente no es de Divisa pactada ...
         |ABRE #agifa324; || ...miro directamente en divisas
         #agifa324#0 = #agifa059#18;
         |LEE 001#agifa324.=;
         |SI FSalida = 0; ||Si existe la divisa...
            #agifa059#19 = #agifa324#2; || la recojo
            |SI #agifa324#6 ! -1; || Si los dias de margen de actualizacion no
                                  || son = -1 (indefinidos)
              |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
                 #agifa059#18 = #agifa324#0;        ||Cargo el valor de la divisa
                 #agifa059#19 = #agifa324#2;        ||Cargo el valor del cambio
                 |LEE 001#agifa324.=;  || Leo la divisa
                 nfecha = #agifa130#1 - #agifa324#4;
                 |SI nfecha > #agifa324#6; |Y #agifa324#6 ! -1;  || Si la fecha actual
                    |MENAV "0000ATENCION deberia Actualizar primero la divisa";
                    divisa = #agifa059#18;
                    |SUB_EJECUTA_NP "agifa326.tab";
                    |ERROR;
                 |SINO;
                    div_act = 1;
                 |FINSI;
              |SIGUE;
            |FINSI;
         |FINSI;
         |CIERRA #agifa324;
      |FINSI;
      |HAZ Param_Divisas3;
|FPRC;

|PROCESO Banco130_7; |TIPO 7;
     |SI FSalida = 0;
          |HAZ EsAlbero;
          |SI FSalida = 0;
               |HAZ AlbeFacVEntra;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO T134_15; |TIPO 15;
     |SI nSwNolog = 0;
          nTipo = 15; |HAZ Log134;
     |FINSI;
|FPRC;

|PROCESO T134_16; |TIPO 16;
     nTipo = 16; |HAZ Log134;
|FPRC;

|PROCESO T134_17; |TIPO 17;
     nTipo = 17; |HAZ Log134;
|FPRC;

|PROCESO Log134;
     |DDEF aAlfa;
     aAlfa = aAlfa + "dsm00087";
     |CARGA_DEF aAlfa, dsm00087@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aSer = #0#49;
     aNum = ("000000" + #0#0) % -106;
     aTipo = "FV";

     |ABRE #dsm00087@;
     |DDEFECTO #dsm00087@;
     |SELECT #2#dsm00087@;
     #dsm00087@#1 = aSer;
     #dsm00087@#2 = aNum;
     #dsm00087@#3 = aTipo;
     |LEE 101#dsm00087@.=;
     |SI FSalida ! 0;
          |SELECT #1#dsm00087@;
          |LEE 000#dsm00087@.u;
          |SI FSalida = 0;
               nContaLog = #dsm00087@#0 + 1;
          |SINO;
               nContaLog = 1;
          |FINSI;
          |DDEFECTO #dsm00087@;
          #dsm00087@#0 = nContaLog;
          #dsm00087@#1 = aSer;
          #dsm00087@#2 = aNum;
          #dsm00087@#3 = aTipo;
          |GRABA 020#dsm00087@.b;
     |FINSI;
     |SI FSalida = 0;
          |HORA aAlfa;
          aUsu = Usuario % 810;
          |SI nTipo = 15;
               #dsm00087@#4 = aUsu;
               #dsm00087@#5 = ~;
               #dsm00087@#6 = aAlfa;
               #dsm00087@#7 = "";
               #dsm00087@#8 = "01.01.0000";
               #dsm00087@#9 = "";
               #dsm00087@#10 = "";
               #dsm00087@#11 = "01.01.0000";;
               #dsm00087@#12 = "";
          |FINSI;
          |SI nTipo = 16;
               #dsm00087@#7 = aUsu;
               #dsm00087@#8 = ~;
               #dsm00087@#9 = aAlfa;
          |FINSI;
          |SI nTipo = 17;
               #dsm00087@#10 = aUsu;
               #dsm00087@#11 = ~;
               #dsm00087@#12 = aAlfa;
          |FINSI;
          |GRABA 020#dsm00087@.a;
     |FINSI;
     |CIERRA #dsm00087@;
     |DESCARGA_DEF #dsm00087@;
|FPRC;

|PROCESO CtrlFecha134;
     nSal = 0;
     |ABRE #41; |LEE 000#41p; |CIERRA #41;
     |SI #41#73 = "S";
          |DDEF aAlfa;
          aAlfa = aAlfa + "agifa134";
          |CARGA_DEF aAlfa, Referen@;
          |SI FSalida = 0;
               |ABRE #Referen@;
               #Referen@#49 = #0#49;
               #Referen@#0 = #0#0;
               |LEE 000#Referen@.=;
               |LEE 000#Referen@.a;
               |SI FSalida = 0; |Y #Referen@#49 = #0#49; |Y #Referen@#0 < #0#0;
                    |SI #Referen@#1 > #0#1;
                         aAlfa = "0000Factura anterior con fecha " + #Referen@#1;
                         nSal = 1;
                    |FINSI;
               |FINSI;
               #Referen@#49 = #0#49;
               #Referen@#0 = #0#0;
               |LEE 000#Referen@.=;
               |LEE 000#Referen@.s;
               |SI FSalida = 0; |Y #Referen@#49 = #0#49; |Y #Referen@#0 > #0#0;
                    |SI #Referen@#1 < #0#1;
                         aAlfa = "0000Factura posterior con fecha " + #Referen@#1;
                         nSal = 2;
                    |FINSI;
               |FINSI;
               |CIERRA #Referen@;
               |DESCARGA_DEF #Referen@;
          |FINSI;
          |SI #41#26 = "S"; |Y nSal = 0;
               |ABRE #84;
               #84#48 = #0#49;
               #84#0 = #0#0;
               |LEE 000#84];
               |SI FSalida ! 0; |LEE 000#84u; |FINSI;
               |LEE 000#84a;
               |SI FSalida = 0; |Y #84#48 = #0#49; |Y #84#0 < #0#0;
                    |SI #84#1 > #0#1;
                         aAlfa = "0000Factura anterior con fecha " + #84#1;
                         nSal = 1;
                    |FINSI;
               |FINSI;
               #84#48 = #0#49;
               #84#0 = #0#0
               |LEE 000#84];
               |SI FSalida ! 0; |LEE 000#84u; |FINSI;
               |SI FSalida = 0; |Y #84#48 = #0#49; |Y #84#0 > #0#0;
                    |SI #84#1 < #0#1;
                         aAlfa = "0000Factura posterior con fecha " + #84#1;
                         nSal = 2;
                    |FINSI;
               |FINSI;
               |CIERRA #84;
          |FINSI;
     |FINSI;
     |SI nSal > 0; |MENAV aAlfa; |FINSI;
     FSalida = nSal;
|FPRC;

|PROCESO Pago7_130; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
          |HAZ EsTagloma;
          |SI FSalida = 0;
               eaAlfa = #0#49;
               |HAZ TagloDefFP;
               |SI eaAlfa ! ""; #0#11 = eaAlfa; |PINTA #0#11; |FINSI;
               |SI eaQuitaDto = "S";
                    #0#4 = 0; |PINTA #0#4;
                    #0#5 = 0; |PINTA #0#5;
                    #0#6 = 0; |PINTA #0#6;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;


|PROCESO Cli130_7; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI #279#24 = "S";
          |C_M #0#2, 1, "N";
          |SI nModo = 1;
               |SI eaSerCli ! ""; #0#2 = eaCliSer; |FINSI;
          |FINSI;
     |FINSI;
     |SI nModo = 2;
          |C_M #0#2, 1, "N"; |PINTA #0#2;
     |SINO;
          |C_M #0#2, 1, "S"; |PINTA #0#2;
     |FINSI;
|FPRC;

|PROCESO Cli130_0; |TIPO 0;
     |HAZ Pago7_130;
|FPRC;

|PROCESO T130_8; |TIPO 8;
     |ABRE #279; |LEE 000#279p; |CIERRA #279;
     |ABRE #41; |LEE 000#41p; |CIERRA #41;
|FPRC;

|PROCESO DocWeb;
     |DDEF aAlfa;
     aAlfa = aAlfa + "coima038";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          #referen@#0 = "FV";
          #referen@#1 = #0#49;
          #referen@#2 = #0#0;
          |SI con = 3;
               |BORRA 000#referen@.c;
          |SINO;
               |LEE 101#referen@.=;
               |SI FSalida ! 0; |GRABA 020#referen@.b; |FINSI;
               #referen@#3 = #0#1;
               #referen@#4 = "N";
               |GRABA 020#referen@.a;
          |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO BajaInforpor;
     |DDEF aAlfa;
     aAlfa = aAlfa + "infom005";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          #referen@#0 = "F";
          #referen@#1 = #0#49;
          #referen@#2 = #0#0;
          |BORRA 000#referen@.c;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;

     |DDEF aAlfa;
     aAlfa = aAlfa + "infom006";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          #referen@#0 = "F";
          #referen@#1 = #0#49;
          #referen@#2 = #0#0;
          |GRABA 000#referen@.n;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO CheqRecticativa;
     enErr = 0;
     |ABRE #153;
     #153#0 = "V";
     #153#1 = #0#49;
     #153#2 = #0#0;
     |LEE 000#153=;
     |SI FSalida = 0;
          aAlfa = "0000Factura con factura rectificativa:" +&13+ #153#6 + "/" + (("000000" + #153#7)%-106) + "...";
          |MENAV aAlfa;
          enErr = 1;
     |FINSI;
     |CIERRA #153;
|FPRC;

|PROCESO BorraRecticativa;
     |ABRE #153;
     |SELECT #2#153;
     #153#0 = "V";
     #153#6 = #0#49;
     #153#7 = #0#0;
     |LEE 101#153=;
     |SI FSalida = 0;
          |BORRA 020#153a;
     |FINSI;
     |CIERRA #153;
|FPRC;
