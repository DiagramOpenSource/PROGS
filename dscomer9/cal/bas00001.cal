|FICHEROS;
     bas00001 #0;
     agifa010 #10;
     agifa071 #71;
     agifa007 #7;
     agifa024 #24;
     agifa019 #19;
     dsm00020 #20;
     agifa025 #25;

     bas00003 #1;  ||Tempo
     bas00004 #2;  ||''
     bas00002 #3;  ||Histo
|FIN;

|VARIABLES;
     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;
     &eaCliente = "";
     &efFecha = @;
     &eaTag = "";

     nLinTxt = 0;
     nPrecio = 0;
     &enSwMenu = 0;
     nHayErrores = 0;
     nSwCheq = 0;
     aFic1 = "";
     aFic2 = "";
     nError = 0;
     &eaError = "";
     totalba = 0;
     nAlba  = 0;
     aAlfa  = "";
     aAlfa1 = "";
     aRuta  = "";
     nHandle = 0;
     aReg = "";
     nNume = 0;
     nIva = 0;
     &enForma = 0;
     &enMargen = 0;
     &aDivisa = "";
     &aMoneda = "";
     nImpDiv = 0;
     nMult = 0;
|FIN;

|PROCESO ActualizaCli;
     |ABRE #24;
     #24#0 = #10#3;
     |LEE 101#24=;
     |SI FSalida = 0;
           #24#50 = #24#50 + #10#15;
           |GRABA 020#24a;
     |FINSI;
     |CIERRA #24;

     eaCliente = #0#3;
     efFecha = #0#1;
     |HAZ AcumulaCli;
     eaTag = "AV";  |HAZ Riesgos;
/*
     |DDEFECTO #11;
     |ABRE #11;
     #11#0 = #10#3;
     |LEE 101#11=;
     |SI FSalida ! 0;
         |GRABA 020#11b;
     |FINSI;
     |SI #10#43 = "N";||Abono No;
         totalba = #10#16+#10#17+#10#18+#10#19+#10#20+#10#21+#10#22+#10#23;||Riesgo Albaranes;
         totalba = totalba + #10#44+#10#45+#10#46+#10#47+#10#48+#10#49+#10#28-#10#61;||Riesgo Albaranes;
         #11#9 = #11#9 + totalba;
     |SINO;
         totalba = #10#16+#10#17+#10#18+#10#19+#10#20+#10#21+#10#22+#10#23;||Riesgo Albaranes;
         totalba = totalba + #10#44+#10#45+#10#46+#10#47+#10#48+#10#49+#10#28-#10#61;||Riesgo Albaranes;
         #11#9 = #11#9 - totalba;
     |FINSI;
     #11#12 = #11#9 + #11#10 + #11#11 + #11#13;
     |GRABA 020#11a;
     |CIERRA #11;
*/
|FPRC;

|PROCESO CreaAlbaLin;
     #71#29 = #0#2;
     #71#0 = #10#0;
     #71#1 = #2#1;
     |LEE 000#71=;
     |SI FSalida = 0;
          aAlfa = ("000000" + #71#0) % -106;
          aAlfa1 = ("000" + #71#1) % -103;
          aAlfa = aAlfa + "-" + aAlfa1;
          aAlfa = "0000Linea Albaran " + #71#29 + "/" + aAlfa + " ya existe.";
          |MENAV aAlfa;
          |ACABA;
     |FINSI;

     |ABRE #19;
     #19#0 = #2#2;
     |LEE 000#19=;
     |CIERRA #19;

     enTiva = #19#30;
     efFiva = #10#1;
     |HAZ SacaIVA;

     |DDEFECTO #71;
     #71#29 = #0#2;
     #71#0 = #10#0;
     #71#1 = #2#1;
     #71#2 = #2#2;
     #71#43 = #2#43;
     nPrecio = #2#6 / #2#5;
     nPrecio = nPrecio / (1+(enIva/100));
     #71#6 = nPrecio;
     #71#15 = #10#3;      |||#2#15;
     #71#3 = 1;
     #71#4 = #19#1;
     #71#5 = #2#5;
     #71#36 = #71#6;
     #71#11 = #19#30;
     enForma = 1;
     |HAZ AcumulaAV;
     #71#14 = enMargen;
     |HAZ TotalLin71;
     |GRABA 020#71n;

     |DDEFECTO #3;
     #3#0 = #2#54;
     #3#1 = #71#29;
     #3#2 = #71#0;
     #3#3 = #71#1;
     |GRABA 020#3n;
|FPRC;

|DEFBUCLE CreaAlbaLin;
     #2#1;
     ;
     #1#52, #1#0, 001;
     #1#52, #1#0, 999;
     ;
     NULL, CreaAlbaLin;
|FIN;

|PROCESO ChequeaLin;
     #3#0 = #2#54;
     |LEE 000#3=;
     |SI FSalida = 0;
          aAlfa = ("000000" + #3#2) % -106;
          aAlfa1 = ("000" + #3#3) % -103;
          aAlfa = aAlfa + "-" + aAlfa1;
          |SI nSwCheq = 0;
               aAlfa = "0000Linea Albaran [" + #3#1 + "/" + aAlfa + "] ya existe.";
               ||MENAV aAlfa;
          |SINO;
               eaError = "Linea Albaran [" + #3#1 + "/" + aAlfa + "] ya existe";
               |PRINT;
          |FINSI;
          nError = 1;
     |FINSI;

     |ABRE #19;
     #19#0 = #2#2;
     |LEE 000#19=;
     |SI FSalida ! 0;
          |SI nSwCheq = 0;
               aAlfa = "0000No existe Articulo [" + #2#2 + "]";
               |MENAV aAlfa;
          |SINO;
               eaError = "Articulo [" + #2#2 + "] No existe";
               |PRINT;
          |FINSI;
          nError = 1;
     |FINSI;
     |CIERRA #19;
|FPRC;

|DEFBUCLE ChequeaLin;
     #2#1;
     ;
     #1#52, #1#0, 001;
     #1#52, #1#0, 999;
     ;
     NULL, ChequeaLin;
|FIN;

|PROCESO ChequeaCab;
     #3#0 = #1#90;
     |LEE 000#3=;
     |SI FSalida = 0;
          aAlfa = ("000000" + #3#2) % -106;
          |SI nSwCheq = 0;
               aAlfa = "0000Albaran [" + #3#1 + "/" + aAlfa + "] ya existe.";
               ||MENAV aAlfa;
          |SINO;
               eaError = "Albaran [" + #3#1 + "/" + aAlfa + "] ya existe.";
               |PRINT;
          |FINSI;
          nError = 1;
     |FINSI;

     |ABRE #24;
     #24#0 = #1#3;
     |LEE 000#24=;
     |SI FSalida ! 0;
          |SI nSwCheq = 0;
               aAlfa = "0000No existe el Cliente [" + #1#3 + "]";
               |MENAV aAlfa;
          |SINO;
               eaError = "Cliente [" + #1#3 + "] No existe";
               |PRINT;
          |FINSI;
          nError = 1;
     |FINSI;
     |CIERRA #24;
     |ABRE #20;
     #20#0 = #24#202;
     |LEE 000#20=;
     |CIERRA #20;
     |ABRE #25;
     #25#0 = #1#6;
     |LEE 000#25=;
     |SI FSalida ! 0;
          |SI nSwCheq = 0;
               aAlfa = "0000No existe el Representante [" + #1#6 + "]";
               |MENAV aAlfa;
          |SINO;
               eaError = "Representante [" + #1#6 + "] No existe";
               |PRINT;
          |FINSI;
          nError = 1;
     |FINSI;
     |CIERRA #25;
|FPRC;

|PROCESO CreaAlba;
     aAlfa = ("000000" + #1#0) % -106;
     aAlfa = "Creando Albaran:" + #0#2 + "/" + aAlfa;
     |PINTA 1616, aAlfa;

     nError = 0;
     |HAZ ChequeaCab;
     |SI nError = 0;
          |BUCLE ChequeaLin;
     |FINSI;
     |SI nError ! 0;
          aAlfa = ("000000" + #1#0) % -106;
          aAlfa = "0000ERROR. Albaran " + #10#52 + "/" + aAlfa + " no importado.";
          ||MENAV aAlfa;
          nHayErrores = 1;
          |ACABA;
     |FINSI;

     nAlba = nAlba + 1;

     |DDEFECTO #10;
     #10#52 = #0#2;
     #10#0 = #1#0;
     enSwMenu = 1;
     |HAZ ContaAV7;
     |GRABA 000#10b;
     |PARA; |SI FSalida ! 0; |HACIENDO;
          #10#0 = #10#0 + 1;
          |GRABA 000#10b;
     |SIGUE;

     #10#3 = #1#3;
     #10#55 = #1#55;
     #10#56 = #1#56;
     #10#57 = #1#57;
     #10#6 = #1#6;
     #10#1 = #1#1;
     ||
     #10#4 = #24#1;
     #10#8 = #24#20;
     #10#9 = #20#1;
     #10#29 = #24#2;
     #10#30 = #24#5;
     #10#31 = #24#6;
     #10#33 = #24#7;
     #10#34 = #25#7;
     #10#35 = #24#4;
     #10#36 = #24#47;
     #10#40 = #24#41;
     #10#50 = #24#40;
     #10#51 = #24#28;
     #10#62 = #24#180;
     #10#63 = #24#15;
     #10#68 = "EUR";
     #10#69 = 1;
     #10#70 = "B";
     #10#73 = "EUR";
     #10#74 = 1;
     #10#88 = #24#202;
     |GRABA 020#10a;

     |BUCLE CreaAlbaLin;

     |HAZ LimCabAgifa010;
     |BUCLELIN 0 CalCabAgifa010 #10;
     |GRABA 020#10a;
     |LIBERA #10;

     |HAZ ActualizaCli;

     |DDEFECTO #3;
     #3#0 = #1#90;
     #3#1 = #10#52;
     #3#2 = #10#0;
     |GRABA 020#3n;

     |BORRA 020#1a;
|FPRC;

|DEFBUCLE CreaAlba;
     #1#1;
     ;
     "     ", 000001;
     "zzzzz", 999999;
     ;
     NULL, CreaAlba;
|FIN;

||-----------------CABECERA
4 cliente o numero tiquet
2 numero de balanza
2 numero de sección
4 numero de ticket
6 numero de vendedor
2 numero de línea '00' para indicar TOTAL
4 hora
6 fecha ddmmaa
6 total importe (los cuatro primeros son la parte entera
y los dos siguientes la parte de los céntimos, el primero puede ser un signo '-')
2 numero de líneas de la venta
2 grupo de artículos (NO SE USA)
|PROCESO Cab;
     |DDEFECTO #1;
     aAlfa = aReg % 104;  ||Cliente
     aAlfa = ("00" + aAlfa);
     #1#3 = #0#3; |||aAlfa;

     aAlfa = aReg % 502;  ||Balanza
     #1#55 = aAlfa;

     aAlfa = aReg % 702;  ||seccion
     #1#56 = aAlfa;

     aAlfa = aReg % 904;  ||ticket
     #1#0 = aAlfa;

     aAlfa = aReg % 1306; ||vendedor
     aAlfa = aAlfa % -102;
     #1#6 = aAlfa;

     aAlfa = aReg % 1902; ||n§ linea

     aAlfa = aReg % 2104; ||hora
     #1#57 = aAlfa;

     aAlfa = aReg % 2506; ||fecha
     aAlfa = (aAlfa % 102)+"."+(aAlfa % 302)+".20"+(aAlfa % 502);
     #1#1 = aAlfa;

     aAlfa = aReg % 3106; ||total importe
     aAlfa = aReg % 3702; ||n§ lineas
     aAlfa = aReg % 3902; ||grupo
     #1#90 = aReg;
     |GRABA 040#1n;      || Sin AVISOS hay duplicados
|FPRC;
||-----------------LINEAS
4 cliente o numero tiquet
2 numero de balanza
2 numero de sección
4 numero de ticket
6 numero de vendedor
2 numero de línea
4 hora
4 plus (código articulo) si 9999 sin código, no pesado
6 peso o unidades (los tres primeros son la parte entera y
los tres segundos la parte decimal o gramos)
6 importe total línea (los cuatro primeros son la parte entera
y los dos siguientes la parte de los céntimos, el primero puede ser un signo '-')
|PROCESO Lin;
     |DDEFECTO #2;
     aAlfa = aReg % 104; ||Cliente
     aAlfa = ("00" + aAlfa);
     #2#15 = aAlfa;

     aAlfa = aReg % 502; ||balanza
     aAlfa = aReg % 702; ||secion

     aAlfa = aReg % 904; ||ticket
     #2#0 = aAlfa;

     aAlfa = aReg % 1306; ||vendedor

     aAlfa = aReg % 1902; ||linea
     #2#1 = aAlfa;

     aAlfa = aReg % 2104; ||hora

     aAlfa = aReg % 2504; ||codigo
     #2#2 = aAlfa;

     aAlfa = aReg % 2906; ||peso
     nNume = aAlfa;
     ||#2#43 = nNume / 1000;
     #2#5 = nNume / 1000;

     aAlfa = aReg % 3506; ||importe
     nNume = aAlfa;
     nNume = nNume / 100;
     #2#6 = nNume;
     #2#54 = aReg;
     |GRABA 040#2n;      || Sin AVISOS hay duplicados
|FPRC;

|PROCESO Registro;
     aAlfa = aReg % 1902;
     |SI aAlfa = "00";
          |HAZ Cab;
     |SINO;
          |HAZ Lin;
     |FINSI;
|FPRC;

|PROCESO Importa;
     nLinTxt = 0;
     aAlfa = #0#1; |QBF aAlfa;
     |XABRE "CU", aAlfa, nHandle;
     |SI FSalida ! 0;
          aAlfa = "0000No puedo abrir " + aAlfa;
          |MENAV aAlfa;
     |SINO;
          |PARA; |SI; |HACIENDO;
               |XLEE nHandle, 250, aReg;
               |SI FSalida [ 0; |SAL; |FINSI;
               nLinTxt = nLinTxt + 1;
               aAlfa = "Importando Linea:" + nLinTxt;
               |PINTA 1516, aAlfa;
               |HAZ Registro;
          |SIGUE;
          |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROCESO ImpErroresLin;
     |HAZ ChequeaLin;
|FPRC;

|DEFBUCLE ImpErroresLin;
     #2#1;
     ;
     #1#52, #1#0, 001;
     #1#52, #1#0, 999;
     ;
     NULL, ImpErroresLin;
|FIN;

|PROCESO ImpErroresCab;
     |HAZ ChequeaCab;
     |BUCLE ImpErroresLin;
|FPRC;

|DEFBUCLE ImpErrores;
     #1#1002;
     ;
     "     ", 000001;
     "zzzzz", 999999;
     ;
     NULL, ImpErroresCab;
|FIN;

|PROCESO Inicio;
     aDivisa = "EUR";
     aMoneda = "B";
     |HAZ Divisas010;

     aFic1 = Usuario; aFic1 = "1" + aFic1;
     aFic2 = Usuario; aFic2 = "2" + aFic2;
     |NOME_DAT #1 aFic1;
     |NOME_DAT #2 aFic2;

     |DELINDEX #1;
     |DELINDEX #2;

     |ABRE #1;
     |ABRE #2;
     |HAZ Importa;
     |CIERRA #1;
     |CIERRA #2;

     |ABRE #10;
     |ABRE #71;
     |ABRE #3;
     |BUCLE CreaAlba;
     |SI nAlba > 0;
          aAlfa = "0000Creados: " + nAlba + " albaranes...";
          |MENAV aAlfa;
     |FINSI;
     |SI nHayErrores ! 0;
          |CONFI "0000SHay registros no importados. Imprimir Errores";
          |SI FSalida = 0;
               |IMPRE 0;
               |SI FSalida = 0;
                    |INFOR "bas00001";
                    |SI FSalida ! 0;
                         |MENAV "0000No existe informe 'bas00001'";
                    |SINO;
                         nSwCheq = 1;
                         |BUCLE ImpErrores;
                         |PIEINF;
                         |FININF;
                    |FINSI;
                    |FINIMP;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #3;
     |CIERRA #71;
     |CIERRA #10;

     |DELINDEX #1;
     |DELINDEX #2;
|FPRC;

|PROCESO Browse;
     |SI FSalida ! 10;  |ACABA;  |FINSI;

     aRuta = #0#1;  |QBF aRuta;
     |SI aRuta = "";
         aRuta = "C:\*.*";
     |FINSI;
     aRuta = "F" + aRuta;

     |BROWSE aRuta;

     #0#1 = aRuta % 290;  |PINTA #0#1;
     |ERROR;
|FPRC;

|PROGRAMA;
     |ABRE #0;
     |LEE 101#0p;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;
     |CLS;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |HAZ Inicio;
          |GRABA 020#0a;
     |FINSI;
     |CIERRA #0;
|FPRO;
