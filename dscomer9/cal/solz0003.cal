|FICHEROS;
     solz0003 #0;
     solm0002 #2;
     solm0003 #3;
     solm0005 #5;
     solw0003 #30; || Tmp

     agifa019 #19;
     dsm00020 #20;
     agifa024 #24;
     agifa025 #25;
     agifa027 #27;
     agifa065 #65;
     agifa066 #66; ||*
     agifa069 #69;
     agifa084 #84;
     agifa324 #324;
     agifa321 #321;
     agifa142 #142;
     agifa041 #41;
|FIN;

|VARIABLES;
     nMANTE = 1;
     nAUTOF = 2;
     aCli = "";
     aSerAnt = "";
     nFacAnt = 0;
     aEmpAnt = "";
     fmes = "";
     mes = 0;
     nImpo = 0;
     nMargen = 0;
     nForma = 0;
     &efFecha = @;
     &eaArticulo = "";
     &enImpVta = 0;
     &enImpMar = 0;
     imneto = 0;
     nDto = 0;
     &enImpCliCom = 0;
     &enImpCliDto = 0;
     &enImpCliMar = 0;
     &enImpCliFac = 0;
     &eaCliente = "";
     &enImpRepComi = 0;
     &enImpRepVta = 0;
     &enImpRepRete = 0;
     &eaRepre = "";
     &eaTag = "";
     retencion = 0;
     nFactu = 0;
     aArti = "";
     nUni = 0;
     nPrecio = 0;
     &enSwMenu = 0;
     &enForma = 1;
     &eaProgVta = "";
     &enCoste = 0;
     &aMoneda = "";
     &aDivisa = "";
     aSerie = "";
     nHuerto = 0;
     nContrato = 0;
     aAlfa = "";
     fFecha = @;
     nInfor = 1;
     nImpre = 1;
     nPrime = 0;
     aPath = "";
     aPos = "";
     nPos = 0;
     aEmp = "";
     aEmp1 = "";
     aEmp2 = "";
     nLinea = 0;
|FIN;

|PROCESO LinFactu;
     |ABRE #69;
     |ABRE #19;

     |DDEFECTO #19;
     #19#0 = aArti;
     |LEE 000#19=;

     nLinea = nLinea + 1;
     |DDEFECTO #69;
     #69#20 = #84#48;
     #69#0 = #84#0;
     #69#1 = nLinea;
     #69#2 = #19#0;
     #69#3 = 1;
     #69#4 = #19#1;
     #69#5 = nUni;
     #69#6 = nPrecio;
     #69#26 = #69#6;
     #69#28 = #69#6;
     #69#11 = #19#30;
     #69#13 = #19#2;
     #69#15 = #84#3;
     #69#16 = #84#34;
     #69#17 = #84#35;
     |GRABA 020#69n;

     |CIERRA #19;
     |CIERRA #69;
|FPRC;

|PROCESO CabFactu;
     |ABRE #24;
     |ABRE #25;
     |ABRE #84;
     |ABRE #324;
     |ABRE #20;

     |DDEFECTO #24;
     #24#0 = aCli;
     |LEE 000#24=;

     |DDEFECTO #25;
     #25#0 = #24#25;
     |LEE 000#25=;

     nLinea = 0;

     |DDEFECTO #84;
     #84#48 = aSerie;
     enSwMenu = 1; |HAZ ContaFD7;
     #84#1 = #0#4;
     #84#3 = #24#0;
     #84#4 = #24#1;
     #84#5 = #24#37;
     #84#6 = #25#0;
     #84#26 = #25#0;
     #84#7 = #24#38;
     #84#8 = #24#20;
     #84#29 = #24#1;
     #84#30 = #24#8;
     #84#31 = #24#9;
     #84#32 = #24#156;
     #84#33 = #24#10;
     #84#34 = #25#7;
     #84#35 = #24#4;
     #84#36 = #24#47;
     #84#40 = #24#16;
     #84#60 = #24#15;
     #84#64 = #24#183;
     #84#65 = #24#192;

     #84#95 = "MANTENIMIENTO";
     |SI #30#0 = nAUTOF;
          #84#95 = "AUTOFACTURA";
          #84#87 = "Emp:" + aEmp1;
     |FINSI;

     #324#0 = #84#65;
     |LEE 000#324=;
     #84#66 = #324#2;

     #84#67 = #24#193;
     #84#68 = #321#9;

     #324#0 = #84#68;
     |LEE 000#324=;
     #84#69 = #324#2;

     #84#78 = #24#202;
     #84#88 = #24#23;
     #84#89 = #24#24;
     #84#90 = #24#25
     #84#91 = 1;         || Dir. Entrega

     #20#0 = #84#78;
     |LEE 000#20=;
     |SI FSalida = 0;
          #84#9 = #20#1;
     |FINSI;

     |GRABA 020#84n;
     nLinea = 0;

     |CIERRA #24;
     |CIERRA #25;
     |CIERRA #84;
     |CIERRA #324;
     |CIERRA #20;
|FPRC;

|PROCESO ActArti;
     fmes = #84#1 % A402;
     mes = fmes - 1;
     mes = mes * 5;
     mes = mes + 35;
     #19#0 = #69#2;
     |LEE 101#19=;
     |SI FSalida = 0;
          |SI #19#194 = 2;
               nImpo = ((((#69#30 * #69#6) < #69#8) < #69#21) < #84#5) < #84#32;
          |SINO;
               nImpo = ((((#69#5 * #69#6) < #69#8) < #69#21) < #84#5) < #84#32;
          |FINSI;
          |SI #142#115 = "S";
               nImpo = nImpo < #84#7;
          |FINSI;
          nMargen = nImpo - #69#14;
          #19mes = #19mes + (nImpo * nForma);
          #19#95 = #19#95 + (nImpo * nForma);
          mes = mes + 1;
          #19mes = #19mes + (nMargen * nForma);
          #19#96 = #19#96 + (nMargen * nForma);
          |GRABA 020#19a;
     |FINSI;
     |LIBERA #19;

     efFecha = #84#1;
     eaArticulo = #69#2;
     enImpVta = (nImpo * nForma);
     enImpMar = (nMargen * nForma);
     |HAZ AcumulaArt;
|FPRC;

|PROCESO Actualiza;
     nForma = 1;

     |ABRE #24;
     #24#0 = #84#3;
     |LEE 121#24=;
     |SI 0 = FSalida;
          fmes = #84#1 % A402;
          mes = fmes - 1;
          mes = mes * 4;
          mes = mes + 54;
          imneto = #84#15 - #84#25;
          |SI #142#115 = "N";
               nImpo = (imneto * 100) / (100 - #84#7);
               nDto = #84#25 + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
               nDto = #84#25;
          |FINSI;
          #24mes = #24mes +. nImpo; || imneto;
          mes = mes + 1;
          #24mes = #24mes +. nDto;
          mes = mes + 1;
          #24mes = #24mes +. #84#37;
          #24#102 = #24#102 +. nImpo; || imneto;
          #24#103 = #24#103 +. nDto;
          #24#104 = #24#104 +. #84#37;
          mes = FEntrada / 100;
          mes = mes ! 0;
          |SI 1 = mes;
               #24#45 = #84#1;
               #24#46 = imneto;
          |FINSI;
          #24#110 = #24#110 +. imneto;
          imneto = imneto + #84#24;
          |GRABA 020#24a;
          |LIBERA #24;

          enImpCliCom = nImpo * nForma;
          enImpCliDto = nDto * nForma;
          enImpCliMar = #84#37 * nForma;
          enImpCliFac = imneto * nForma;
          eaCliente = #84#3;
          efFecha = #84#1;
          |HAZ AcumulaCli;
     |FINSI;
     |CIERRA #24;

     |ABRE #25;
     #25#0 = #84#6;
     |LEE 121#25=;
     |SI 0 = FSalida;
           imneto = #84#15 - #84#25;
           fmes = #84#1 % A402;
           mes = fmes - 1;
           mes = mes * 2;
           mes = mes + 11;
           #25mes = #25mes +. #84#26;
           retencion = #25mes % #25#39;
           mes = mes + 1;
           #25mes = #25mes +. imneto;
           #25#35 = #25#35 +. #84#26;
           #25#36 = #25#36 +. imneto;
           mes = fmes - 1;
           mes = mes + 40;
           #25mes = retencion;
           retencion = #25#35 % #25#39;
           #25#52 = retencion;
           |GRABA 020#25a;
           |LIBERA #25;

          enImpRepComi = #84#26 * nForma;
          enImpRepVta = imneto * nForma;
          enImpRepRete = retencion * nForma;
          eaRepre = #84#6;
          efFecha = #84#1;
          |HAZ AcumulaRep;
     |FINSI;
     |CIERRA #25;

     |ABRE #19;
     |BUCLELIN 2 ActArti #84;
     |CIERRA #19;
/*
     |SI #142#47 = "S";  ||컴컴컴컴컴 Acumula en riesgos Si Crea Recibo
          eaTag = "FC";  |HAZ Riesgos;
     |FINSI;
*/
|FPRC;

|PROCESO CalcuLin;
     |HAZ TotalLin69;

     |HAZ CalCabAgifa084;

     enForma = 1;
     eaProgVta = "agifa084";
     |HAZ AcumulaFC;
     #69#14 = enCoste;

     |GRABA 020#69a;
     |LIBERA #69;
|FPRC;

|PROCESO CalcuFac;
     |ABRE #84;
     #84#48 = aSerAnt;
     #84#0 = nFacAnt;
     |LEE 121#84=;
     |SI FSalida = 0;
          aDivisa = #84#65;
          aMoneda = #84#67;
          |HAZ Divisas084;

          |HAZ LimCabAgifa084;
          |BUCLELIN 0 CalcuLin #84;
          |GRABA 020#84a;

          |HAZ Actualiza;
     |FINSI;
     |CIERRA #84;
|FPRC;

|PROCESO ModiPath;
     aAlfa = aPath + #30#5 + "/";
     ||cab
     |PATH_DAT #24 aAlfa;
     |PATH_DAT #25 aAlfa;
     |PATH_DAT #84 aAlfa;
     |PATH_DAT #324 aAlfa;
     |PATH_DAT #20 aAlfa;

     |PATH_DAT #27 aAlfa;

     ||lin
     |PATH_DAT #84 aAlfa;
     |PATH_DAT #69 aAlfa;
     |PATH_DAT #19 aAlfa;

     |PATH_DAT #65 aAlfa;
     |PATH_DAT #66 aAlfa;
|FPRC;

|PROCESO Factura;
     |SI nHuerto ! #30#1; |O nContrato ! #30#2;
               |O aSerAnt ! #30#4; |O aEmpAnt ! #30#5;
          |SI nFacAnt ! 0;
               |HAZ CalcuFac;
          |FINSI;
          |HAZ ModiPath;

          aSerie = #30#4;
          aCli = #30#7;
          |HAZ CabFactu;
     |FINSI;

     nUni = 1;
     aArti = #30#6;
     |SI #30#0 = nMANTE;
          nPrecio = #5#11;
     |SINO;
          nPrecio = #5#10;
     |FINSI;
     |HAZ LinFactu;

     nUni = -1;
     aArti = #30#8; |QBF aArti;
     |SI #30#0 = nMANTE;
          nPrecio = #5#23;
     |SINO;
          nPrecio = #5#22;
     |FINSI;
     |SI nPrecio ! 0; |Y aArti ! "";
          |HAZ LinFactu;
     |FINSI;

     nHuerto = #30#1;
     nContrato = #30#2;
     aSerAnt = #30#4;
     aEmpAnt = #30#5;
     nFacAnt = #84#0;
|FPRC;

|PROCESO Tmp;
     #5#0 = #30#1;
     #5#1 = #30#2;
     #5#2 = #30#3;
     #5#3 = #0#3;
     #5#4 = #0#2;
     |LEE 121#5=;
     |SI FSalida = 0;
          |HAZ Factura;
          |SI #30#0 = nMANTE;
               #5#12 = #84#48;
               #5#13 = #84#0;
               #5#18 = #69#1;
          |SINO;
               #5#14 = #30#5;
               #5#15 = #84#48;
               #5#16 = #84#0;
               #5#19 = #69#1;
          |FINSI;
          |GRABA 020#5a;
          |LIBERA #5;
     |FINSI;
|FPRC;

|DEFBUCLE Tmp;
     #30#2;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Tmp;
|FIN;

|PROCESO Imprime;
     |SI nPrime = 0;
          nPrime = 1;
          |IMPRE 0;
          nImpre = FSalida;
          |SI FSalida ! 0; |ACABA; |FINSI;
          |INFOR "solz0003";
          nInfor = FSalida;
          |SI FSalida ! 0; |ACABA; |FINSI;
     |FINSI;
     |SI nInfor = 0; |PRINT; |FINSI;
|FPRC;

|PROCESO Tipo7; |TIPO 7;
     |SI #0#2 = 0;
          fFecha = ~;
          aAlfa = fFecha % 402;
          #0#2 = aAlfa; |PINTA #0#2;
          aAlfa = fFecha % -104;
          #0#3 = aAlfa; |PINTA #0#3;
     |FINSI;
|FPRC;

|PROCESO solm0005;
     |SI #5#7 = 0;
          |HAZ Imprime;
     |SINO;
          #2#0 = #5#0;
          #2#1 = #5#1;
          |LEE 000#2=;
          |SI FSalida = 0;
               |SELECT #2#3;
               #3#3 = #5#2;
               #3#0 = #5#0;
               #3#1 = #5#1;
               |LEE 000#3=;
               |SI FSalida = 0;
                    |SI #5#13 = 0;
                         #30#0 = nMANTE;
                         #30#1 = #5#0;
                         #30#2 = #5#1;
                         #30#3 = #5#2;
                         #30#4 = #3#9;
                         #30#5 = aEmp1;
                         #30#6 = #3#8;
                         #30#7 = #2#4;
                         #30#8 = #3#15;
                         |GRABA 020#30n;
                    |FINSI;

                    aEmp2 = ("00000" + #3#11) % -105;
                    |SI #5#16 = 0; |Y #3#11 ! 0;
                         |DBASE aAlfa;
                         aAlfa = aAlfa + "fich/";
                         |PATH_DAT #41 aAlfa;
                         |ABRE #41;
                         #41#0 = #3#11;
                         |LEE 000#41=;
                         |SI FSalida = 0;
                              #30#0 = nAUTOF;
                              #30#1 = #5#0;
                              #30#2 = #5#1;
                              #30#3 = #5#2;
                              #30#4 = #3#12;
                              #30#5 = aEmp2;
                              #30#6 = #3#10;
                              #30#7 = #2#4;
                              #30#8 = #3#16;
                              |GRABA 020#30n;
                         |FINSI;
                         |CIERRA #41;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE solm0005;
     #5#1;
     ;
     #0#0, 0000, 0000, #0#3, #0#2;
     #0#1, 9999, 9999, #0#3, #0#2;
     ;
     NULL, solm0005;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |DFICE aAlfa;
     aPos = aAlfa % A0;
     nPos = aPos;
     nPos = nPos - 6 + 100;
     aPath = aAlfa % nPos;
     aEmp1 = aAlfa % -205;

     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     |ABRE #321; |LEE 000#321p; |CIERRA #321;

     aAlfa = Usuario;
     |NOME_DAT #30 aAlfa;
     |DELINDEX #30;

     |ABRE #30;
     |ABRE #2;
     |ABRE #3;
     |BUCLE solm0005;
     |CIERRA #3;
     |CIERRA #2;
     |CIERRA #30;
     |SI nPrime = 0;
          |ABRE #5;
          |BUCLE Tmp;
          |CIERRA #5;
          |SI nFacAnt ! 0;
               |HAZ CalcuFac;
          |FINSI;
     |SINO;
          |SI nInfor = 0; |PIEINF; |FININF; |FINSI;
          |SI nImpre = 0; |FINIMP; |FINSI;
     |FINSI;

     |DELINDEX #30;
|FPRC;
