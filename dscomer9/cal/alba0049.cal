|FICHEROS;
     alba0034 #99;  || Cabecera de Revision
     agifa084 #0;   || Cabecera de Fact. Contado.
     agifa024 #6;   || Clientes.
     agifa069 #3;   || Lineas Fac. Contado.
     agifa019 #2;   || Articulos.
     agifa025 #8;
     agifa038 #13;
     agifa048 #15;
     agifa049 #16;
     agifa007 #40;
     agifa142 #41;
     agifa027 #43;
||     agifa114 #44;
     agifa324 #50;

     dsz99984 #100;
     agifa091 #101;
     agifa177 #102;
     agifa133 #103;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     aSer = "";
     nNum = "";
     aParam = "";
     resto = 0;
     neto = 0;
     diferencia = 0;
     numero = "";
     imneto = 0;
     tf = 0;
     retencion = 0;
     con = 0;
     margen = 0;
     indtope = 0;
     ind = 0;
     control = 0;
     mensaje01 = "0423Actualizando linea:";
     fmes = "  ";
     mes = 0;
     mensajei  = "2400NDesea imprimir esta factura ?";
     informe = "";
     informe1 = "agifa084";
     &iva1 = 0;&iva2 = 0;&iva3 = 0;&re1 = 0;&re2 = 0;&re3 = 0;
     &iva4 = 0;&iva5 = 0;&re4 = 0;&re5 = 0;
     &codigo="";
     &descrip="";
     &precio=0;
     &dto=0;
     &dto1=0;
     &unid=0;
     &imptot=0;
     &tiva=0;
     &linea=0;
     vacio="";
     modo = 0;
     &n_dec = 0;
     &n_pre = 0;
     totalb = 0;
     &bl  = "                              ";
     tipo = "vfactuco";
     nImpo = 0;
     nDto = 0;
     &aMoneda = "";
     &aDivisa = "";

     nVto     = 0;
     &eaProg   = "";
|FIN;

|CALCULO fcaccli;
|SI control = 1;
    |HAZ actal;
|FINSI;

|ABRE #6;
#6#0 = #0#3;
|LEE 121#6=;
|LIBERA #6;
|SI 0 = FSalida;
    fmes = #0#1 % A402;
    mes = fmes - 1;
    mes = mes * 4;
    mes = mes + 54;
    imneto = #0#15 - #0#25;
    |SI #41#115 = "N";
         nImpo = (imneto * 100) / (100 - #0#7);
         nDto = #0#25 + (imneto - nImpo);
    |SINO;
         nImpo = imneto;
         nDto = #0#25;
    |FINSI;
    #6mes = #6mes + nImpo;
    mes = mes + 1;
    #6mes = #6mes + nDto;
    mes = mes + 1;
    #6mes = #6mes + #0#37;
    #6#102 = #6#102 + nImpo;
    #6#103 = #6#103 + nDto;
    #6#104 = #6#104 + #0#37;
    mes = FEntrada / 100;
    mes = mes ! 0;
    |SI 1 = mes;
         #6#45 = #0#1;
         #6#46 = imneto;
    |FINSI;
    #6#110 = #6#110 + imneto;
    imneto = imneto + #0#24;
    |GRABA 020#6a;
    |LIBERA #6;

     enImpCliCom = nImpo;
     enImpCliDto = nDto;
     enImpCliFac = imneto;
     enImpCliMar = #0#37;
     eaCliente = #0#3;
     efFecha = #0#1;
     |HAZ AcumulaCli;
|FINSI;
|CIERRA #6;

|ABRE #8;
#8#0 = #0#6;
|LEE 121#8=;
|LIBERA #8;
|SI 0 = FSalida;
    imneto = #0#15 - #0#25;
    fmes = #0#1 % A402;
    mes = fmes - 1;
    mes = mes * 2;
    mes = mes + 11;
    #8mes = #8mes + #0#26;
    retencion = #8mes % #8#39;
    mes = mes + 1;
    #8mes = #8mes + imneto;
    #8#35 = #8#35 + #0#26;
    #8#36 = #8#36 + imneto;
    mes = fmes - 1;
    mes = mes + 40;
    #8mes = retencion;
    retencion = #8#35 % #8#39;
    #8#52 = retencion;
    |GRABA 020#8a;
    |LIBERA #8;

     enImpRepComi = #0#26;
     enImpRepVta = imneto;
     enImpRepRete = retencion;
     eaRepre = #0#6;
     efFecha = #0#1;
     |HAZ AcumulaRep;

|FINSI;
|CIERRA #8;
|FCAL;

|CALCULO cogecon0;|TIPO 0;
   control = 0;
|FCAL;

|CALCULO pedcon0;|TIPO 6;
con = FEntrada / 100;
con = con ! 0;
|SI con = 2;|Y #0Campo ! Contenido;
    control = 1;
|FINSI;
|FCAL;

|CALCULO acttl;|TIPO 0;
     #3#15 = #0#3;
     #3#16 = #0#34;
     #3#17 = #0#35;
     |GRABA 020#3a;
     |LIBERA #3;
     imneto = #3#9 < #0#5;
     imneto = imneto < #0#32;
     imneto = imneto < #0#7;
     |SI #3#2 ! #2#0;
         |ABRE #2;
         #2#0 = #3#2;
         |LEE 000#2=;
         |LIBERA #2;
         |CIERRA #2;
     |FINSI;

     margen = #3#5 * #2#9;
     margen = imneto - margen;
     #0#37 = #0#37 + margen;

     |SI #3#11 = 0; #0#28 = #0#28 + imneto; |FINSI;

     |SI #3#11 = 1;
         #0#16 = #0#16 + imneto; mes = #0#16; #0#17 = mes % #0#50;
         |SI #0#36 = "S";
             #0#18 = mes % #0#51;
         |FINSI;
     |FINSI;

     |SI #3#11 = 2;
         #0#19 = #0#19 + imneto; mes = #0#19; #0#20 = mes % #0#52;
         |SI #0#36 = "S";
             #0#21 = mes % #0#53;
         |FINSI;
     |FINSI;

     |SI #3#11 = 3;
         #0#22 = #0#22 + imneto; mes = #0#22; #0#23 = mes % #0#54;
         |SI #0#36 = "S";
             #0#49 = mes % #0#55;
         |FINSI;
     |FINSI;

     |SI #3#11 = 4;
         #0#42 = #0#42 + imneto; mes = #0#42; #0#43 = mes % #0#56;
         |SI #0#36 = "S";
             #0#44 = mes % #0#57;
         |FINSI;
     |FINSI;

     |SI #3#11 = 5;
         #0#45 = #0#45 + imneto; mes = #0#45; #0#46 = mes % #0#58;
         |SI #0#36 = "S";
             #0#47 = mes % #0#59;
         |FINSI;
     |FINSI;

     mes = imneto % #3#10;
     #0#26 = #0#26 + mes;
     #0#25 = 0;
     #0#25 = #0#15 < #0#5;
     #0#25 = #0#25 < #0#32;
     #0#25 = #0#25 < #0#7;
     #0#25 = #0#15 - #0#25;
     #0#25 = #0#25 ! #50#7;
     #0#24 = #0#17+#0#20+#0#23+#0#18+#0#21+#0#49+#0#43+#0#44+#0#46+#0#47;
|FCAL;

|CALCULO actal;|TIPO 0;
#0#15 = 0;#0#16 = 0;#0#17 = 0;#0#18 = 0;#0#19 = 0;#0#20 = 0;#0#21 = 0;
#0#22 = 0;#0#23 = 0;#0#24 = 0;#0#25 = 0;#0#26 = 0;#0#28 = 0;#0#37 = 0;
#0#41 = 0;
|BUCLELIN 0acttl#0;
|BLIN 4;
|FCAL;

|PROCESO cargaiva;|TIPO 0;
|SI totalb = 0;
     enTiva = 1; efFiva = #0#1; |HAZ SacaIVA;
     #0#50 = enIva;#0#51 = enRec;

     enTiva = 2; efFiva = #0#1; |HAZ SacaIVA;
     #0#52 = enIva;#0#53 = enRec;

     enTiva = 3; efFiva = #0#1; |HAZ SacaIVA;
     #0#54= enIva;#0#55 = enRec;

     enTiva = 4; efFiva = #0#1; |HAZ SacaIVA;
     #0#56 = enIva;#0#57 = enRec;

     enTiva = 5; efFiva = #0#1; |HAZ SacaIVA;
     #0#58= enIva;#0#59 = enRec;
|FINSI;
|FPRC;

|PROCESO recoge;
     modo = 1;
     |SI modo = 1; |HAZ cargaiva; |FINSI;
|FPRC;

|PROCESO mira_d;
     |ABRE #41;
     |DDEFECTO #41;
     #41#0 = "A";
     |LEE 001#41=;
     |LIBERA #41;
     |CIERRA #41;
     n_dec = #41#8;
     n_pre = #41#9;
|FPRC;

|PROCESO pasa;
     |DDEFECTO #0;
     |ABRE #6;
     #6#0 = #99#4;
     |LEE 000#6=;
     |LIBERA #6;
     |CIERRA #6;
     |ABRE #50;
     #50#0 = #6#192;
     |LEE 000#50=;
     |LIBERA #50;
     |CIERRA #50;
     numero = "000000" + #99#1;
     numero = numero % -106;
     #0#0 = numero;                || Numero Factura.
     #0#48 = #99#2;                || Serie Factura.
     #0#1 = #99#3;                 || Fecha.
     #0#3 = #99#4;                 || Cod. Cliente.
     #0#4 = #6#1;                  || Nombre Cliente.
     #0#5 = #99#11;                || Dto.
     #0#6 = #99#10;                || Representante.
     #0#7 = #99#12;                || Dto. P.P.
     #0#8 = #6#20;                 || Forma de Pago.
     #0#9 = #6#35;                 || Agencia Transporte.
     #0#10 = "S";                  || Fact. Impresa.
     #0#25 = 0;                    || Total Descuento.
     #0#29 = #6#1;                 || Entregar a.
     #0#30 = #6#5;                 || Direccion entraga.
     #0#31 = #6#6;                 || Pob. entre.
     #0#33 = #6#7;                 || Prov. entre.
     #0#32  = #99#13;              || Dto. acumulado.
     #0#35 = #6#4;                 || Tipo Cliente.
     #0#36 = #6#47;                || Regimen equiva.
     #0#38 = #99#7;                || Entrega a Cuenta.
     #0#39 = "N";                  || Contabilizada.
     #0#40 = #6#16;                || Numero de cta.
     #0#15 = #99#8;                || Bruto Fact.
     #0#60 = #6#15;                || Cif.
     #0#63 = #99#7;
     #0#64 = #6#183;
     #0#65 = #6#192;
     #0#66 = #50#2;
     #0#69 = #50#2;
     #0#67 = #6#193;
     #0#68 = #6#192;
     #0#70 = #0#15;
     #0#71 = #0#41;
     #0#72 = #0#15;
     #0#73 = #0#41;
     #0#74 = #0#15;
     #0#75 = #0#41;
     #0#92 = #99#32;

     |HAZ cogecon0;
     |HAZ fcaccli;
     |HAZ recoge;
     |HAZ mira_d;
     |HAZ pedcon0;
     |ABRE #43;
     #43#2 = #0#48;
     #43#0 = tipo;
     |LEE 010#43=;
     |SI FSalida ! 0;
         #43#1 = #0#0 + 1;
         |GRABA 010#43n;
     |SINO;
         #43#1 = #0#0 + 1;
         |GRABA 010#43a;
     |FINSI;
     |LIBERA #43;
     |CIERRA #43;
     #0#25 = #0#15 < #0#5;
     #0#25 = #0#25 < #0#32;
     #0#25 = #0#25 < #0#7;
     #0#25 = #0#15 - #0#25;
     |GRABA 121#0n;
     |LIBERA #0;

     || --------- Generacion de recibos --------------;
     |SI #41#47 = "S";
/*
        |ABRE #agifa133;
        #agifa133#0 = #agifa084#0;
        #agifa133#4 = #agifa084#48;
        #agifa133#1 = 0;
        |LEE 001#agifa133.];
        nVto = 0;
        |SI FSalida ! 0; |O #agifa133#0 ! #agifa084#0;  |O #agifa133#4 ! #agifa084#48;
           |HAZ VenciDir;
        |FINSI;

        |ABRE #agifa177;
        nVto = 0;
        #agifa133#0 = #agifa084#0;
        #agifa133#4 = #agifa084#48;
        #agifa133#1 = 0;
        |LEE 001#agifa133.];
        |PARA ; |SI FSalida = 0; |Y #agifa133#0 = #agifa084#0;|Y #agifa133#4 = #agifa084#48; |HACIENDO;
             nVto = nVto + 1;
             |LEE 001#agifa133.s;
        |SIGUE;

        |HAZ AbreRecVenta;

        #agifa133#0 = #agifa084#0;
        #agifa133#4 = #agifa084#48;
        #agifa133#1 = 0;
        |LEE 001#agifa133.];
        |PARA ; |SI FSalida = 0; |Y #agifa133#0 = #agifa084#0;|Y #agifa133#4 = #agifa084#48; |HACIENDO;
             |DDEFECTO #dsz99984;
             #dsz99984#17 = #agifa084#48;
             #dsz99984#0  = #agifa084#0;
             #dsz99984#1  = #agifa133#1;           || Linea;
             #dsz99984#2  = #agifa084#3;            || cliente
             #dsz99984#3  = #agifa084#4;            || nombre del cliente
             #dsz99984#4  = #agifa024#29;           || Banco
             #dsz99984#5  = "S";             || domiciliado
             #dsz99984#6  = "N";             || aceptado
             #dsz99984#7  = #agifa084#1;            || fecha de emision
             #dsz99984#8  = #agifa133#3;           || Fecha de vencimiento
             #dsz99984#9  = #agifa133#2;           || Importe
             #dsz99984#10 = "N";            || Impreso
             #dsz99984#11 = "N";            || Contabilizado
             #dsz99984#12 = #agifa084#40;

             |ABRE #agifa091;
             |DDEFECTO #agifa091;
             #agifa091#0 = #agifa084#8;
             |LEE 000#agifa091.=;
             |CIERRA #agifa091;
             |SI #agifa142#63 = "S";
                  #agifa177#0 = #agifa091#69;
                  |LEE 000#agifa177.=;
                  |SI FSalida = 0;
                       #dsz99984#12 = #agifa177#3;     || NUMERO CTA.CONTABLE.
                  |SINO;
                       #dsz99984#12 = #agifa084#40;     || NUMERO CTA.CONTABLE.
                  |FINSI;
             |SINO;
                  #dsz99984#12 = #agifa084#40;          || NUMERO CTA.CONTABLE.
             |FINSI;
             #dsz99984#13 = "N";            || Cobrado
             #dsz99984#14 = "N";            || Impagado
             #dsz99984#15 = #agifa024#161;         || A aceptar
             #dsz99984#16 = "01.01.0000";   || fecha de cobro
             #dsz99984#18 = #agifa084#40;          || Cta
             #dsz99984#21 = #agifa091#69;          || Tipo de Recibo (forma de pago)
             #dsz99984#22 = "Pdte. Cobro";
             #dsz99984#23 = nVto;
             #dsz99984#24 = #agifa091#0;
             #dsz99984#25 = #agifa091#1;

             #dsz99984#26 = "";
             #dsz99984#27 = "";
             #dsz99984#29 = "";
             #dsz99984#28 = "";

             eaProg = "agifa084";
             |HAZ RecVenta;
             |LEE 001#agifa133.s;
        |SIGUE;
        |CIERRA #agifa133;
        |CIERRA #agifa177;
        enDirEnt = #agifa084#91; |HAZ CierraRecVenta;
*/
     |FINSI;
|FPRC;

|DEFBUCLE lee;
     #99#1;
     ;
     "F","     ",000000;
     "F","zzzzz",999999;
     be;
     NULL,pasa;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO RecalFactu;
     |ABRE #0;
     #0#48 = aSer
     #0#0 = nNum;
     |LEE 101#0=;
     |SI FSalida = 0;
||          |HAZ AltaCarnicasFD;  LAS CREA EN EL psion003
          |HAZ LimCabAgifa084;
          |BUCLELIN 2 CalCabAgifa084 #0;
          |GRABA 020#0a;
     |FINSI;
     |CIERRA #0;
|FPRC;

|PROCESO psion004;
     |SI aSer ! #99#2; |O nNum ! #99#1;
          aSer = #99#2;
          nNum = #99#1;
          |HAZ RecalFactu;
     |FINSI;
|FPRC;

|DEFBUCLE psion004;
     #99#1;
     ;
     "F","     ",000000;
     "F","zzzzz",999999;
     ;
     NULL, psion004;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROGRAMA;
     aMoneda = "B";
     aDivisa = "EUR";
     |HAZ Divisas084;

     aParam = PARAMETRO; |QBF aParam;
     |SI aParam = "CARNICAS";
          |BUCLE psion004;
     |SINO;
          modo = 1;
          |ABRE #0;
          |BUCLE lee;
          |LIBERA #0;
          |CIERRA #0;
     |FINSI;
|FPRO;
