   CONTADOR PEDIDO/ALBARAN: MalpePV7 MalpePV0 MalpeAV7 MalpeAV0
   STOCK PEDIDO/ALBARAN:  AcumulaAVMp AcumulaPVMp AcumulaAdjMp, ModiHistoAVMp
   CALCULO PRECIO/DTO: CalDtoMalpe1 CalDtoMalpe2

|FICHEROS;
     malpe087 #87; ||Pedidos Vta
     malpe088 #88;
     malpe090 #90;  ||Albaranes Vta
     malpe091 #91;

     malpe083 #83; ||Arti
     malpe085 #85; ||Lote
     malpe001 #101;
     malpe003 #103;
     malpe104@ #104;
     agifa310 #310;
     agifa017 #17;
     agifa019 #19;
     dsm00024 #24;
     agifa027 #27;
     agifa065 #65;
     agifa142 #142;
     agifa039 #5;
     agifa024 #6;
     agifa023 #23;
     malpt003 #3,MANTE;
|FIN;

|CAMPOS;
     #19#15  art_pser;  #17#42  alm_pser;
     #19#182 art_pser2; #17#44  alm_pser2;
     #19#16  art_prec;  #17#43  alm_prec;
     #19#183 art_prec2; #17#45  alm_prec2;
     #19#17  art_pval;  #17#4   alm_pval;
     #19#11  art_nece;
     #19#12  art_rese;  #17#8   alm_rese;
     #19#14  art_depo;  #17#10  alm_depo;
     #19#184 art_depo2; #17#46  alm_depo2;
     #19#13  art_fabr;  #17#9   alm_fabr;
     #19#10  art_vsto;  #17#3   alm_vsto;
     #19#7   art_mini;  #17#6   alm_mini;
     #19#8   art_maxi;  #17#7   alm_maxi;
     #19#6   art_tota;  #17#5   alm_tota;
     #19#185 art_tota2; #17#47  alm_tota2;
     #19#104 art_disp;  #17#39  alm_disp;
     #19#193 art_disp2;  #17#48 alm_disp2;
     #19#9   art_pcm;
     #24#9   par_ereal; #24#10  par_ereal2;
     #24#11  par_sreal; #24#12  par_sreal2;
     #24#18  par_prec2;  #24#19  par_prec;
     #24#16  par_pser;  #24#17  par_pser2;
     #24#20  par_depo;  #24#21  par_depo2;
     #24#22  par_tota;  #24#23  par_tota2;
     #24#31  par_disp;  #24#32  par_disp2;
     #24#14  par_merma;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     aOperacion = "";
     aOperaInte = "";
     nGuarda = 0;
     nDtoCli = 0;
     nDtoFam = 0;
     nDtoSubfam = 0;
     &eaLote = "";
     &eaLoteRese = "";
     nPreUni = 0;
     nCamDto = 0;
     aIva = "";
     aDef = "";
     &enUniPedi     = 0;
     &enSwMenu      = 0;
     &enCodAlbNegro = 0;
     &enSwSimula    = 0;
     &enDesdeX      = 0;
     nPreTon        = 0;
 {-1}aMenu          = "";
     aMenu1         = "2400";
     aMenu2         = "1";
     aMenu3         = " Contador: ";
     aMenu4         = "AM";
     aMenu5         = " Automatico ";
     aMenu6         = " Manual ";
     aClave         = "";
     aSerie         = "";
     aAlfa          = "";
     nConta         = 0;
     nNume          = 0;
     nModo          = 0;
     nSalMenu       = 0;

     nConta2        = 0;
     aRef           = "";
     aArti = "";
     aParti = "";
     nAlma = "";
     nPrecio = 0;
     nUnidades = 0;
     nMerma = 0;
     nCoste = 0;
     fUltFecha = @;
     aOpera = "";
     ||컴컴컴컴컴컴컴컴컴컴
     &enPreBas = 0;
     &enPreDto = 0;
     &enPrePor = 0;
     &enDto = 0;
     &enObra = 0;
     nDto1 = 0;
     nDto2 = 0;
     nDto3 = 0;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO CompruContaMalpe;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo ! 1; |ACABA; |FINSI;

     |SI #142#137 = "F"; |ACABA; |FINSI;

     |SI #142#136 ! "S";
          aAlfa = ("000000" + nConta ) % -106;
          |SI #142#136 = "N";
               |SI nNume > nConta;
                    aAlfa = "0000Numero incorrecto. No puede ser mayor de " + aAlfa;
                    |MENAV aAlfa;
                    |ERROR;
               |FINSI;
          |SINO;
               |SI nNume > nConta;
                    aAlfa = "0000Numero superior a " + aAlfa;
                    |MENAV aAlfa;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ContaFicMalpe;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |SI enSwMenu = 0;
          |SI enDesdeX = 1;
               aMenu1 = "2700";
          |FINSI;
          |MENU aMenu
          nSalMenu = FSalida;
          |SI nSalMenu ! 1; |ACABA; |FINSI;
     |FINSI;

     |SI #142#137 = "F";
          |ABRE #27;
          #27#2 = aSerie;
          #27#0 = aClave;
          |LEE  101#27=;
          |SI FSalida ! 0;
               #27#1 = 1;
               |GRABA 020#27b;
          |FINSI;
          nConta = #27#1;
          |SI enSwSimula = 0;       ||Lo usa la adj. de facturas ventas
               #27#1 = #27#1 + 1;
               |GRABA 020#27a;
          |FINSI;
          |CIERRA #27;
     |FINSI;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO MalpePV7; |TIPO 7;
     |SI enSwMenu = 0;
          nModo = (FEntrada/100) !  0;
          |SI nModo ! 1; |ACABA; |FINSI;
     |FINSI;
     eaSwClaveRepre = "";||Inicializa Sw Clave Representante ver 'dsz99995'

     nConta = 1;
     aSerie = #87#25;
     #87#0 = 999999;
     |LEE 000#87];
     |SI FSalida = 0;
          |LEE 000#87a;
     |SINO;
          |LEE 000#87u;
     |FINSI;
     |SI FSalida  = 0; |Y #87#25 = aSerie;
          nConta = #87#0 + 1;
     |FINSI;

     aClave = "vpedido";
     |HAZ ContaFicMalpe;

     |DDEFECTO #87;
     #87#25 = aSerie;
     |SI enSwMenu = 0;       ||llamado por agifa166
          |SI nSalMenu = 1;
               #87#0 = nConta;
               |PTEC 802;
          |SINO;
               #87#0 = 1;
          |FINSI;
     |SINO;
          #87#0 = nConta;
     |FINSI;
     enSwMenu = 0;
|FPRC;

|PROCESO MalpePV0; |TIPO 0;
     nNume = #87#0;
     |HAZ CompruContaMalpe;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO MalpeAV7; |TIPO 7;
     |SI enSwMenu = 0;
          nModo = (FEntrada/100) !  0;
          |SI nModo ! 1; |ACABA; |FINSI;
     |FINSI;
     eaSwClaveRepre = "";||Inicializa Sw Clave Representante ver 'dsz99995'

     nConta = 1;
     aSerie = #90#52;
     #90#0 = 999999;
     |LEE 000#90];
     |SI FSalida = 0;
          |LEE 000#90a;
     |SINO;
          |LEE 000#90u;
     |FINSI;
     |SI FSalida  = 0; |Y #90#52 = aSerie;
          nConta = #90#0 + 1;
     |FINSI;

     aClave = "valbaran";
     |HAZ ContaFicMalpe;

     |DDEFECTO #90;
     #90#52 = aSerie;
     |SI enSwMenu = 0;
          |SI nSalMenu = 1;
               #90#0 = nConta;
               |PTEC 802;
          |SINO;
               #90#0 = 1;
          |FINSI;
     |SINO;
          #90#0 = nConta;
     |FINSI;
     enSwMenu = 0;
|FPRC;

|PROCESO MalpeAV0; |TIPO 0;
     nNume = #90#0;
     |HAZ CompruContaMalpe;
|FPRC;

|PROCESO LeeArtiMp;
     |DDEFECTO #19;
     |DDEFECTO #17;
     |DDEFECTO #24;
     |DDEFECTO #85;
     |ABRE #19;
     |ABRE #17;
     |ABRE #24;
     |ABRE #85;
     #19#0 = aArti;
     |LEE 101#19=;
     |SI FSalida ! 0; |GRABA 020#19b; |FINSI;
     #17#0 = aArti;
     #17#1 = nAlma;
     |LEE 101#17=;
     |SI FSalida ! 0; |GRABA 020#17b; |FINSI;
     #24#0 = aArti;
     #24#1 = nAlma;
     #24#2 = aParti;
     |LEE 101#24=;
     |SI FSalida ! 0; |GRABA 020#24b; |FINSI;
     #85#0 = aArti;
     #85#1 = nAlma;
     #85#2 = aParti;
     |LEE 101#85=;
     |SI FSalida ! 0; |GRABA 020#85b; |FINSI;
|FPRC;

|PROCESO GrabaArtiMp;
     |HAZ ValoraStock;
     |GRABA 020#19a;
     |GRABA 020#17a;
     |GRABA 020#85a;
     |LIBERA #85;
     |GRABA 020#24a;
     |CIERRA #85;
     |CIERRA #24;
     |CIERRA #17;
     |CIERRA #19;
|FPRC;

|PROCESO AcumuLotePV;
     |DDEFECTO #24;
     #24#0 = #104#8;
     #24#1 = #104#9;
     #24#2 = #104#10;
     |LEE 101#24=;
     |SI FSalida ! 0; |GRABA 020#24b; |FINSI;
     #24#16 = #24#16 + ((#104#5 - #104#7) * enForma);
     |GRABA 020#24a;
|FPRC;

|DEFBUCLE AcumuLotePV;
     #104#1004;
     ;
     #88#28, #88#0, #88#1, 001;
     #88#28, #88#0, #88#1, 999;
     ;
     NULL, AcumuLotePV;
|FIN;

|PROCESO AcumulaPVMp;
     aArti = #88#2;
     nAlma = #88#3;
     aParti = #88#45;
     |HAZ LeeArtiMp;
     #19#15 = #19#15 + (#88#5 * enForma);
     #17#42 = #17#42 + (#88#5 * enForma);

     |DDEF aDef;
     aDef = aDef + "malpe104";
     |CARGA_DEF aDef, malpe104@;
     |SI FSalida = 0;
          |BUCLE AcumuLotePV;
          |DESCARGA_DEF #malpe104@;
     |FINSI;
     |HAZ GrabaArtiMp;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO HistoricoAVMp;
     |DDEFECTO #65;
     #65#0 = aArti;
     #65#1 = #90#1;
     #65#2 = aOpera;
     #65#3 = #91#0;
     #65#4 = #91#1;
     #65#11 = #91#29;
     |LEE 101#65=;
     |SI FSalida = 0;
          |SI enForma ! 1;
               |BORRA 040#65a;
          |FINSI;
     |SINO;
          |SI enForma = 1;
               |GRABA 020#65b;
          |FINSI;
     |FINSI;
     #65#5 = nAlma;
     |SI #90#43 = "S";
          #65#6 = #65#6 + nUnidades;
          #65#17 = 0;
     |SINO;
          #65#6 = #65#6 - nUnidades;
          #65#17 = 0;
     |FINSI;
     #65#7 = #19#6;
     #65#8 = #19#9;
     #65#9 = nPrecio;
     #65#10 = #90#3;
     #65#12 = #91#8;
     #65#13 = #91#33;                      || Dto Espe   ||Dto Ac
     #65#14 = ((((#65#9 < #65#12) < #65#13) < #90#5) < #90#32);
     |SI #142#115 = "S";   ||Dto Pp
          #65#14 = #65#14 < #90#7;
     |FINSI;
     #65#18 = aParti;
     #65#19 = nMerma;
     |SI enForma = 1; |GRABA 020#65a; |FINSI;
|FPRC;

|PROCESO StockAVMp;
     art_disp = art_disp - nUnidades;
     art_tota = art_tota - nUnidades;
 ||    art_pser = art_pser - (enUniPedi * enForma);
     alm_disp = alm_disp - nUnidades;
     alm_tota = alm_tota - nUnidades;
 ||    alm_pser = alm_pser - (enUniPedi * enForma);
     par_sreal = par_sreal + nUnidades;
     par_disp = par_disp - nUnidades;
     par_tota = par_tota - nUnidades;
 ||    par_pser = par_pser - (enUniPedi * enForma);

     |HAZ ValoraStock;
     nCoste = nCoste + (nUnidades * art_pcm);

     aAlfa = fUltFecha % 402;
     nNume = aAlfa;
     nNume = ((nNume - 1) * 5) + 34;

     #19nNume = #19nNume + nUnidades;
     #19#94   = #19#94   + nUnidades;
     nNume    = aAlfa;
     nNume    = ((nNume - 1) * 2) + 11;
     #17nNume = #17nNume + nUnidades;
     #17#35   = #17#35   + nUnidades;
     |HAZ GrabaArtiMp;

     enUniVta = nUnidades;
     enUniSal = nUnidades;
     efFecha = fUltFecha;
     eaArticulo = #17#0;
     enAlmacen = #17#1;
     |HAZ AcumulaArt;
     |HAZ AcumulaAlm;
|FPRC;

|PROCESO AcumulaAVMp;
     nCoste = 0;
     fUltFecha = #90#1;
     aArti = #91#2;
     nAlma = #91#3;
     aParti = #91#49;
     nMerma = #91#50;
     nPrecio = #91#6;
     |SI enForma = 1;
          nUnidades = #91#5;
     |SINO;
          nUnidades = -#91#5;
     |FINSI;
     aOpera = "AV";

     |ABRE #65;
     |HAZ LeeArtiMp;
     |HAZ StockAVMp;
     |HAZ HistoricoAVMp;
     enCoste = nCoste;
     |CIERRA #65;
|FPRC;

|PROCESO Precio12; |TIPO 12;
|FPRC;

|PROCESO CalDtoMalpe2;
     #3#0 = enPreBas;
     #3#1 = enPrecio;
     |PUSHV 05012380;
     |BLANCO 15272355;
     |PINPA #0#3;
     |PINDA #0#3;
     nGuarda = FEntrada;
     |ENDATOS #1#3;
     FEntrada = nGuarda;
     |POPV;

     |ABRE #101;
     #101#0 = eaCliente;
     #101#1 = enObra;
     |LEE 020#101=;
     |CIERRA #101;

     |ABRE #6;
     #6#0 = eaCliente;
     |LEE 020#6=;
     |CIERRA #6;

     |ABRE #19;
     #19#0 = eaArti;
     |LEE 020#19=;
     |CIERRA #19;

     |ABRE #83;
     #83#0 = eaArti;
     |LEE 020#83=;
     |CIERRA #83;

     |ABRE #85;
     #85#0 = eaArti;
     #85#1 = enAlma;
     #85#2 = eaLote;
     |LEE 020#85=;
     |CIERRA #85;

     |ABRE #103;
     #103#0 = #101#22;
     #103#3 = efFecha;
     |LEE 000#103];
     |SI FSalida ! 0;
          |LEE 000#103u;
     |SINO;
          |LEE 000#103a;
     |FINSI;
     |SI FSalida ! 0; |O #103#0 ! #101#22;
          |DDEFECTO #103;
     |FINSI;
     |CIERRA #103;

     nPreTon = #103#2;
||     nPreUni = #85#3;
     nPreUni = #19#102;

     enPreBas = #3#0;
     enPrecio = #3#1;
||     enPrePor =  (nPreUni /1000 * nPreTon) > 15;
||     enPrePor = nPreUni * ((nPreTon>15)!0) / 1000;

     enPrePor = (((nPreUni * nPreTon) > 15) ! 0) / 1000;

     enPreDto = #3#1 - enPrePor;
     enDto = 100 - (( 100 * enPreDto) / enPreBas);
|FPRC;

|PROCESO AcumulaAdjMp;
     aArti = #88#2;
     nAlma = #88#3;
     aParti = eaLote;
     |HAZ LeeArtiMp;
     #19#15 = #19#15 + (enUniPedi * enForma);
     #17#42 = #17#42 + (enUniPedi * enForma);
     #24#16 = #24#16 + (enUniPedi * enForma);
     |QBF eaLoteRese;
     |SI eaLoteRese ! "";
          #19#12 = #19#12 + (enUniPedi * enForma);
          #19#104 = #19#104 - (enUniPedi * enForma);
          #17#8 = #17#8 + (enUniPedi * enForma);
          #17#39 = #17#39 - (enUniPedi * enForma);
          #85#9 = #85#9 + (enUniPedi * enForma);
          #24#31 = #24#31 - (enUniPedi * enForma);
     |FINSI;
     |HAZ GrabaArtiMp;
|FPRC;

|PROCESO CalDtoMalpe1;
     |ABRE #19;
     #19#0 = eaArti;
     |LEE 000#19=;
     |CIERRA #19;

     |ABRE #6;
     #6#0 = eaCliente;
     |LEE 000#6=;
     |CIERRA #6;
     nDtoCli = #6#204;
     nDtoFam = 0;
     nDtoSubfam = 0;

     |ABRE #23;
     #23#0 = eaCliente;
     #23#1 = eaArti;
     |LEE 000#23=;
     |SI FSalida = 0; |Y efFecha ] #23#28; |Y efFecha [ #23#29;
          nPrecio = #23#2;  ||Precio Cliente/Articulo
     |SINO;
          nPrecio = #19#18; aIva = #19#130; nCamDto = 21;
          |SI #6#39 = 2; nPrecio = #19#19; aIva = #19#131; nCamDto = 22; |FINSI;
          |SI #6#39 = 3; nPrecio = #19#20; aIva = #19#132; nCamDto = 23; |FINSI;
          |SI #6#39 = 4; nPrecio = #19#147; aIva = #19#153; nCamDto = 150; |FINSI;
          |SI #6#39 = 5; nPrecio = #19#148; aIva = #19#154; nCamDto = 151; |FINSI;
          |SI #6#39 = 6; nPrecio = #19#149; aIva = #19#155; nCamDto = 152; |FINSI;
          |SI aIva = "S";
               enTiva = #19#30;
               efFiva = ~;
               |HAZ SacaIVA;
               nPrecio = nPrecio / ( 1 + (enIva/100));   ||Le quito el Iva
           |FINSI;
     |FINSI;
     |CIERRA #23;

     enPrecio = nPrecio;

     |ABRE #5;
     #5#0 = eaCliente;
     #5#1 = #19#2;
     |LEE 000#5=;
     |SI FSalida = 0; |Y efFecha ] #5#3; |Y efFecha [ #5#4;
          nDtoFam = #5#2;
     |FINSI;
     |CIERRA #5;

     |ABRE #310;
     #310#0 = eaCliente;
     #310#1 = #19#2;
     #310#2 = #19#3;
     |LEE 000#310=;
     |SI FSalida = 0; |Y efFecha ] #310#4; |Y efFecha [ #310#5;
          nDtoSubfam = #310#3;
     |FINSI;
     |CIERRA #310;

     enDto = 100 - (((100 < nDtoCli) < nDtoFam) < nDtoSubfam);

     |SI enDto = 0;
          enDto = #19nCamDto;
     |FINSI;
|FPRC;

|PROCESO ModiHistoAVMp0;
     #65#0 = aArti;
     #65#1 = #90#1;
     #65#2 = aOpera;
     #65#3 = #91#0;
     #65#4 = #91#1;
     #65#11 = #91#29;
     |LEE 101#65=;
     |SI FSalida = 0;
          #65#10 = #90#3; ||Cli
          #65#12 = #91#8; ||Dto1
          #65#13 = #91#33;||Dto2                ||Dto Espe ||Dto Ac
          #65#14 = ((((#65#9 < #65#12) < #65#13) < #90#5) < #90#32);
          |SI #142#115 = "S";   ||Dto Pp
               #65#14 = #65#14 < #90#7;
          |FINSI;
          |GRABA 020#65a;
          |LIBERA #65;
     |FINSI;
|FPRC;

|PROCESO TipoOperaMp;
     |SI #90#43 = "N";
          aOperacion = "AV";
          aOperaInte = "AC";
     |SINO;
          aOperacion = "BV";
          aOperaInte = "BC";
     |FINSI;
|FPRC;

|PROCESO ModiHistoAVMp;
     |ABRE #65;
     aArti = #91#2;
     |HAZ TipoOperaMp;
     aOpera = aOperacion
     |HAZ ModiHistoAVMp0;
     |CIERRA #65;
|FPRC;
