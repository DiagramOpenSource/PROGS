          || CreaPedidos

|FICHEROS;
     cong0001 #1;
     cong0003 #3;
     cong0004 #4;
     agifa019 #19;
     agifa024 #24;
     agifa025 #25;
     agifa073 #73;
     agifa104 #104;
     agifa142 #142;
     dsm00113;
|FIN;

|VARIABLES;
     &aDivisa = "";
     &aMoneda = "";
     &enEstaDentro = 0;
     &enSwMenu = 0;
     nReg = 0;
     aPedido = "";
     aCliente = "";
     aCp = "";
     aAlfa = "";
     aLon = "";
     nLin = 0;

     &nPromo = 0;
     &eaSerie = "";
     &enDirEnt = 0;
     &enAlmacen = 0;
     &fed_dt = @;   || Fecha....
     &art_dt = "";  || Articulo.
     &cli_dt = "";  || Cliente..
     &fam_dt = "";  || Familia.
     &iva_dt = 0;   || Tipo Iva.
     &dtos_2 = 0;   || Descuento 2.
     &dto_pt = 0;   || Descuento Ptas.
     &dtos_1 = 0;   || Descuento 1.
     &pvp_ve = 0;   || Precio Venta.
     &tarifa = 0;   || Tarifa Cliente.
     &quedto = 0;   || 1=cli./art, 2=cli./familia, 3=cli./subfam.
     &gru_dt = "";  || Grupo Cliente.
     &uni_dt = 0;
     &uni_dt2 = 0;
     &enMensaje = 0;
     &aParam    = "";
     &enDescuento1 = 0;
     &enDescuento2 = 0;
     &eaTComision  = "";
     &eaCliente    = "";
     &eaRepre      = "";
     &eaArticulo   = "";
     &efFecha      = @;
     &enComision   = 0;
     nCalc = 0;
     &enTiva = 0;
     &efFiva = @;
     &enRec = 0;
     &enIva = 0;
     &nImpo = 0;
     fmes = "";
     mes = 0;
     &enImpCliPed = 0;
     &enForma = 0;
     &eaTag = "";
     aCli = "";
     aCp1 = "";
     aCp2 = "";
     nNume = 0;
     aArti = "";
     aCB = "";
|FIN;

|PROCESO BuscaArti;
     |SELECT #6#19;
     #19#134 = #3#12;
     |LEE 000#19=;
     |SI FSalida ! 0;
          |SELECT #1#19;
          aArti = #3#12;
          aCB = #3#13; |QBF aCB;
          |SI aCB = ""; aCB = aArti; |FINSI;
          |PARA; |SI; |HACIENDO;
               aAlfa = "*dsz99895;" + aArti + &9 + aCB;
               |SUB_EJECUTA_NP aAlfa;
               #19#0 = aArti;
               |LEE 000#19=;
               |SI FSalida = 0; |SAL; |FINSI;
               |MENAV "0000Debe de dar de alta el art¡culo...";
          |SIGUE;
     |SINO;
          |SELECT #1#19;
          aArti = #19#0;
     |FINSI;
|FPRC;

|PROCESO CPostal;
     aAlfa = #3#6;
     aLon = aAlfa % A0;
     |SI aLon ] 5;
          aAlfa = aAlfa % 105;
     |SINO;
          nNume = 5 - aLon;
          aAlfa = "0" * nNume;
          aAlfa = aAlfa + #3#6;
     |FINSI;
     aCp1 = aAlfa % 102;
     aCp2 = aAlfa % 303;
     aCp = aAlfa;
|FPRC;

|PROCESO NuevoCliente;
     |LEE 000#24u;
     |SI FSalida = 0;
          nNume = #24#0;
          nNume = #24#0 + 1;
     |SINO;
          nNume = 1;
     |FINSI;

     aAlfa = ("000000" + nNume) % -106;
     |DDEFECTO #24;
     #24#0 = aAlfa;
     #24#1 = #3#4;
     #24#2 = #3#4;
     #24#205 = "ES";
     #24#14 = "ESPA¥A";
     #24#5 = #3#5; #24#8 = #3#5; #24#11 = #3#5;
     #24#7 = #3#7; #24#8 = #3#10; #24#13 = #3#7;
     |HAZ CPostal;
     #24#178 = aCp1; #24#181 = aCp1; #24#184 = aCp1;
     #24#179 = aCp2; #24#182 = aCp2; #24#185 = aCp2;
     #24#180 = aCp; #24#183 = aCp; #24#186 = aCp;

     aAlfa = "000000000000" + #24#0;
     nNume = -(100 + (#142#11 - 2));
     aAlfa = aAlfa % nNume;
     aAlfa = "43" + aAlfa;
     #24#16 = aAlfa;

     |SI #3#2 = "E";
          #24#166  = "SI";
          #24#168 = #3#3;
     |SINO;
          #24#166  = "NO";
          #24#168 = 0;
     |FINSI;
     |GRABA 000#24n;

     aCli = #24#0;
|FPRC;

|PROCESO BuscaCliente;
     aCli = "";
     |SI #3#2 = "E";
          |LEE 000#24p;
          |PARA; |SI FSalida = 0; |HACIENDO;
               aAlfa = #24#166; |QBF aAlfa;
               |SI #24#168 = #3#3; |Y aAlfa = "SI";
                    aCli = #24#0; |SAL;
               |FINSI;
               |LEE 000#24s;
          |SIGUE;
          |SI aCli = ""; |HAZ NuevoCliente; |FINSI;
     |SINO;
          aAlfa = ("000000" + #3#3) % -106;
          #24#0 = aAlfa;
          |LEE 000#24=;
          |SI FSalida = 0;
               aCli = #24#0;
          |SINO;
               |HAZ NuevoCliente;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CongeCalcConIva;
     |ABRE #dsm00113;
     #dsm00113#0 = #agifa104#4;
     #dsm00113#1 = #agifa073#14;
     |LEE 000#dsm00113.=;
     |SI FSalida = 0;
        nCalc = #agifa073#11 % #dsm00113#3;
        |SI #agifa024#47 = "S";
           nCalc = nCalc + (#agifa073#11 % #dsm00113#4);
        |FINSI;
     |SINO;
        enTiva = #73#14;
        efFiva = #104#1;
        |HAZ SacaIVA;

        nCalc = #agifa073#11 % enIva;
        |SI #agifa024#47 = "S";
             nCalc = nCalc + (#agifa073#11 % enRec);
        |FINSI;
     |FINSI;
     |CIERRA #dsm00113;

     nImpo = nImpo + (#agifa073#11 + nCalc);
|FPRC;

|DEFBUCLE CongeCalcConIva;
     #73#1;
     ;
     #104#25, #104#0,001;
     #104#25, #104#0,999;
     ;
     NULL, CongeCalcConIva;
|FIN;

|PROCESO CongeActCli;
     #19#0 = #3#2;
     |LEE 000#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;

     |DDEFECTO #24;
     #24#0 = #104#4;
     |LEE 101#24=;
     |SI FSalida ! 0; |GRABA 020#24b; |FINSI;
     |SI FSalida = 0;
          |SI #19#194 = 2;
               nImpo = ((((#73#44 * #73#6) < #73#8) < #73#29) < #104#5) < #104#17;
          |SINO;
               nImpo = ((((#73#5 * #73#6) < #73#8) < #73#29) < #104#5) < #104#17;
          |FINSI;
          |SI #142#115 = "S";
               nImpo = nImpo < #104#6;
          |FINSI;
          fmes = #104#1 % A402;
          mes = fmes - 1;
          mes = mes * 3;
          mes = mes + 114;
          #24mes = #24mes   + nImpo;     || VENTA.
          #24#150 = #24#150 + nImpo;
          |GRABA 020#24a;

          eaCliente = #agifa104#4;
          efFecha = #agifa104#1;
          enImpCliPed = nImpo;
          |HAZ AcumulaCli;
     |FINSI;
|FPRC;

|PROCESO CongePrecioComi;
     |SI #3#16 ! "S";
          fed_dt = #104#1;   || Fecha....
          art_dt = #73#2;   || Articulo.
          cli_dt = #73#20;  || Cliente..
          fam_dt = #73#18;  || Familia.
          iva_dt = #73#14;  || Tipo Iva.
          dtos_2 = 0;      || Descuento 2.
          dto_pt = 0;      || Descuento Ptas.
          dtos_1 = 0;      || Descuento 1.
          pvp_ve = 0;      || Precio Venta.
          tarifa = #24#39;  || Tarifa Cliente....
          gru_dt = #24#158; || Grupo Cliente.
          |SI #73#36 ! 0;
                uni_dt = #73#36;
          |SINO;
                uni_dt = #73#5;
          |FINSI;
          uni_dt2 = #73#44;
          nPromo = #104#56;
          enMensaje = 0;
          aParam = "";
          eaSerie = #73#28;
          enDirEnt = #104#57;
          enAlmacen = #73#3;
          |HAZ calcdtos;    || Calculo Dtos.....
          #73#6 = pvp_ve - dto_pt;  || Precio Venta. sin iva.
          #73#8 = dtos_1;  || 1¦ Dto.
          #73#29 = dtos_2;  || 2§ Dto.
          #73#40 = #73#6;
          #73#38 = #73#6;
          #73#40 = #73#6;
     |FINSI;

     enDescuento1 = #73#8;
     enDescuento2 = #73#29;
     eaTComision  = #73#17;
     eaCliente    = #104#4;
     eaRepre      = #104#7;
     eaArticulo   = #73#2;
     efFecha      = #104#1;
     eaSerie      = #73#28;
     enDirEnt = #104#57;
     enAlmacen = #73#3;
     |HAZ Comisiones;
     #73#8 = enDescuento1;
     #73#10 = enComision;
|FPRC;

|PROCESO CongeLinPed;
     |ABRE #19;
     |HAZ BuscaArti;
     #19#0 = aArti;
     |LEE 020#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;
     |CIERRA #19;

     nLin = nLin + 1;
     |DDEFECTO #73;
     #73#28 = #104#25;
     #73#0 = #104#0;
     #73#1 = nLin;
     #73#2 = #19#0;
     #73#3 = 1;
     #73#4 = #19#1;
     #73#5 = #3#14;
     #73#13 = #3#10;
     #73#14 = #19#30;
     #73#16 = #104#7;
     #73#17 = #104#16;
     #73#18 = #19#2
     #73#19 = #104#18;
     #73#20 = #104#4;
     #73#23 = #104#5;
     #73#24 = #104#6;
     #73#25 = #104#17;
     #73#26 = #104#9;
     #73#42 = #73#5;
     |HAZ CongePrecioComi;
     enForma = 1;
     |HAZ AcumulaPV;
     |GRABA 020#73n;
|FPRC;

|PROCESO CongeCabPed;
     |HAZ BuscaCliente;

     enSwMenu = 1;
     |DDEFECTO #104;
     #104#25 = #1#12;
     |HAZ ContaPV7;
     |GRABA 020#104b;

     #104#1 = #3#9;
     #104#2 = #3#10;
     #104#3 = #3#8;
     #104#4 = aCli;

     #24#0 = #104#4;
     |LEE 000#24=;
     |SI FSalida ! 0; |DDEFECTO #24; |FINSI;
     #25#0 = #24#25;
     |LEE 000#25=;
     |SI FSalida ! 0; |DDEFECTO #25; |FINSI;

     #104#5 = #24#37;
     #104#6 = #24#38;
     #104#7 = #24#25;
     #104#8 = #3#4;
     #104#9 = #24#20;
     #104#14 = #3#5;
     #104#15 = #3#11;
     #104#16 = #25#7;
     #104#17 = #24#156;
     #104#18 = #24#4;
     #104#19 = #3#4;
     #104#20 = #24#6;
     #104#21 = #3#7;
     #104#22 = #24#47;
     #104#23 = #24#41;

     aAlfa = ("00000000" + #3#1) % -108;
     #104#26 = aAlfa;                   ||Referencia = Numero Pedido

     #104#35 = "EUR";
     #104#36 = 1;
     #104#37 = "B";
     #104#40 = "EUR";
     #104#41 = 1;
     aAlfa = #3#11 % 0022; #104#53 = aAlfa;
     aAlfa = #3#11 % 2322; #104#54 = aAlfa;
     aAlfa = #3#11 % 4622; #104#55 = aAlfa;
     aCp = #3#6; aLon = aCp % A0;
     |SI aLon < 5;
          aCp = ("00000" + aCp) % -105;
     |FINSI;
     #104#59 = aCp;
     #104#60 = #24#202;
     #104#62 = #3#10;
     #104#64 = #24#15;
     |GRABA 020#104a;

     aDivisa = #104#35;
     aMoneda = #104#37;
     |HAZ Divisas104;
|FPRC;

|PROCESO CongeFinPed;
     |SI aPedido ! "";
          |HAZ CalCabAgifa104;
          |ABRE #1;
          |ABRE #19;
          |BUCLELIN 2 CongeActCli #104;
          |CIERRA #1;
          |CIERRA #19;

          nImpo = 0; |BUCLE CongeCalcConIva;
          eaTag = "PE";  |HAZ Riesgos;

          |LIBERA #104;
     |FINSI;
|FPRC;

|PROCESO cong0003;
     |SI aPedido ! #3#8; |O aCliente ! #3#3
          nLin = 0;
          |HAZ CongeFinPed;
          |HAZ CongeCabPed
          aPedido = #3#8;
          aCliente = #3#3
     |FINSI;
     |HAZ CongeLinPed;

     #3#21 = #73#28;
     #3#22 = #73#0;
     #3#23 = #73#1;
     #3#19 = "S";
     |GRABA 020#3a;

     |DDEFECTO #4;
     |LEE 000#4u;
     |SI FSalida = 0;
          nReg = #4#12 + 1;
     |SINO;
          nReg = 1;
     |FINSI;
     #4#0 = #3#0;
     #4#1 = #3#1;
     #4#2 = #3#2;
     #4#3 = #3#3;
     #4#4 = #3#9;
     #4#5 = #3#10;
     #4#6 = "01.01.0000";
     #4#7 = #3#12;
     #4#8 = #3#14;
     #4#9 = #3#15;
     #4#10 = "N";
     #4#11 = "";
     #4#12 = nReg;
     #4#13 = #3#20;
     #4#14 = #3#21;
     #4#15 = #3#22;
     #4#16 = #3#23;
     |GRABA 020#4n;
|FPRC;

|DEFBUCLE cong0003;
     #3#2;
     ;
     "N", 0000000;
     "N", 9999999;
     be;
     NULL, NULL, NULL, NULL, NULL, cong0003;
     #3#8, #3#3, #3#18;
|FIN;

|PROCESO CreaPedidos;
     enEstaDentro = 1;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     aPedido = "";
     |ABRE #4;
     |ABRE #24;
     |ABRE #25;
     |ABRE #73;
     |ABRE #104;
     |BUCLE cong0003;
     |HAZ CongeFinPed;
     |CIERRA #104;
     |CIERRA #73;
     |CIERRA #25;
     |CIERRA #24;
     |CIERRA #4;
     enEstaDentro = 0;
|FPRC;
