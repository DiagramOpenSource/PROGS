|FICHEROS;
     coimz017 #0;
     coima001 #1;        ||Parametros Coimasa

     coima044 #44;

     coiplm01 #501;
     coiplm02 #502;
     coiplm03 #503;

     agifa010 #10;
     agifa024 #24;
|FIN;

|VARIABLES;
     aAux = "";
     &eaImpPL = "";
     &eaFicheroFalcon = "";
     nSumaVolumen = 0;
     nSumaPesoBruto = 0;
     nSumaPesoNeto = 0;
     aDestino = "";
     aOrigen = "";
     nNumeroPL = 0;
     aCP = "";
     aCP1 = "";
     aCP2 = "";
     nUltSubLin = 0;

     aReturnUnix = "";
     aTab = "";
     nHandle = 0;
     nLinea = 0;
     aLinea = "";
     aLong = "";
     nLong = 0;
     nVoy = 0;
     aSaca = "";
     aLetra = "";


     aMensaje = "";
     aPath = "";
     aPathReal = "";
     aAlfa = "";
     aIP = "";
     aPathProcesadas = "";
     aExtension = "";
     aFichero = "";

     aSerieAlba = "";
     nNumAlba = 0;
     nBulto = 0;
     nPesoBruto = 0;
     nPesoNeto = 0;
     nVolumen = 0;
     aArticulo = "";
     nUdAdju = 0;
     aVariosAlba = "";
     nLinAlba = 0;
     nTipoCaja = 0;
     nContador = 0;
     aTextAux = "";
|FIN;

|PROCESO ProcesaRegistro;
     ||aMensaje = "0000Tipo Caja " + nTipoCaja + " Voy por registro:" + nLinea;
     ||MENAV aMensaje;

     |SI nLinea = 1;
          |DDEFECTO #coiplm01;
          |LEE 000#coiplm01.u;
          |SI FSalida = 0;
               nNumeroPL = #coiplm01#0 + 1;
          |SINO;
               nNumeroPL = 1;
          |FINSI;

          |DDEFECTO #coiplm01;
          #coiplm01#0 = nNumeroPL;
          |LEE 101#coiplm01.=;
          |SI FSalida ! 0; |GRABA 020#coiplm01.b; |FINSI;

          #coiplm01#1 = ~;
          |SI aVariosAlba = "S";
               #coiplm01#2 = "M";
               #coiplm01#3 = 0;
               #coiplm01#4 = "";
          |SINO;
               #coiplm01#2 = "A";
               #coiplm01#3 = nNumAlba;
               #coiplm01#4 = aSerieAlba;
          |FINSI;

          |DDEFECTO #agifa010;
          #agifa010#52 = aSerieAlba;
          #agifa010#0 = nNumAlba;
          |LEE 000#agifa010.=;

          #coiplm01#5 = #agifa010#30;
          #coiplm01#6 = #agifa010#31;
          #coiplm01#7 = #agifa010#33;
          aCP = #agifa010#62;
          aCP1 = aCP % 102;
          aCP2 = aCP % 303;
          #coiplm01#8 = aCP1;
          #coiplm01#9 = aCP2;

          |DDEFECTO #agifa024;
          #agifa024#0 = #agifa010#3;
          |LEE 000#agifa024.=;
          #coiplm01#10 = #agifa024#8;
          #coiplm01#11 = #agifa024#9;
          #coiplm01#12 = #agifa024#10;
          #coiplm01#13 = #agifa024#181;
          #coiplm01#14 = #agifa024#182;

          #coiplm01#18 = #agifa010#88;
          #coiplm01#19 = #agifa010#88;

          #coiplm01#21 = #agifa010#9;
          #coiplm01#22 = #agifa010#9;
          #coiplm01#23 = "A";
          #coiplm01#24 = "A";
          #coiplm01#25 = "A";
          #coiplm01#26 = "A";
          #coiplm01#27 = #agifa010#3;
          #coiplm01#28 = #agifa024#1;
          #coiplm01#29 = "";

          |GRABA 020#coiplm01.a;
          |LIBERA #coiplm01;
     |FINSI;

     |DDEFECTO #coiplm02;
     #coiplm02#0 = nNumeroPL;
     #coiplm02#1 = nBulto;
     |LEE 101#coiplm02.=;
     |SI FSalida ! 0;
          #coiplm02#4 = nVolumen;
          #coiplm02#5 = nPesoBruto;
          #coiplm02#6 = nPesoNeto;
          #coiplm02#7 = #coiplm02#7 + nUdAdju;
          #coiplm02#8 = nTipoCaja;

          |DDEFECTO #coima044;
          #coima044#0 = nTipoCaja;
          |LEE 000#coima044.=;
          #coiplm02#9 = #coima044#1;

          |GRABA 020#coiplm02.n;

          nSumaVolumen = nSumaVolumen + nVolumen;
          nSumaPesoBruto = nSumaPesoBruto + nPesoBruto;
          nSumaPesoNeto = nSumaPesoNeto + nPesoNeto;

     |SINO;
          #coiplm02#7 = #coiplm02#7 + nUdAdju;
          |GRABA 020#coiplm02.a;
     |FINSI;
     |LIBERA #coiplm02;

     |DDEFECTO #coiplm03;
     #coiplm03#0 = nNumeroPL;
     #coiplm03#1 = nBulto;
     #coiplm03#2 = 999;
     |LEE 000#coiplm03.];
     |SI FSalida = 0;
         |LEE 000#coiplm03.a;
     |SINO;
         |LEE 000#coiplm03.u;
     |FINSI;
     |SI FSalida = 0; |Y #coiplm03#0 = nNumeroPL; |Y #coiplm03#1 = nBulto;
          nUltSubLin = #coiplm03#2 + 1;
     |SINO;
          nUltSubLin = 1;
     |FINSI;

     |DDEFECTO #coiplm03;
     #coiplm03#0 = nNumeroPL;
     #coiplm03#1 = nBulto;
     #coiplm03#2 = nUltSubLin;
     |LEE 101#coiplm03.=;
     |SI FSalida ! 0; |GRABA 020#coiplm03.b; |FINSI;

     |SI aVariosAlba = "S";
          #coiplm03#3 = 0;
     |SINO;
          #coiplm03#3 = nLinAlba;
     |FINSI;
     #coiplm03#4 = aArticulo;
     #coiplm03#5 = "N";
     #coiplm03#6 = nUdAdju;
     |GRABA 020#coiplm03.a;
     |LIBERA #coiplm03;
|FPRC;

|PROCESO ProcesaFic;
     ||aFichero = aPath + eaFicheroFalcon;
     aFichero = eaFicheroFalcon;
     aExtension = aFichero % -104;
     |QBF aExtension;
     aExtension = aExtension < aExtension;
     |SI aExtension ! ".lin"; |ACABA; |FINSI;

     |XABRE "CU", aFichero, nHandle;
     |SI FSalida < 0;
          aMensaje = "0000No es posible abrir el fichero" + &13 + aFichero;
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     nSumaVolumen = 0;
     nSumaPesoBruto = 0;
     nSumaPesoNeto = 0;
     nNumeroPL = 0;

     nLinea = 0;
     |PARA; |SI; |HACIENDO;
          |XLEE nHandle, 250, aLinea;
          |SI FSalida < 0;
               |SAL;
          |SINO;
               nLinea = nLinea + 1;

               |QBF aLinea;
               aLong = aLinea % A0;
               nLong = aLong;
               |SI nLong = 0;
                    |SAL;
               |FINSI;

               aSerieAlba = "";
               nNumAlba = 0;
               nBulto = 0;
               nPesoBruto = 0;
               nPesoNeto = 0;
               nVolumen = 0;
               aArticulo = "";
               nUdAdju = 0;
               aVariosAlba = "";
               nLinAlba = 0;
               nTipoCaja = 0;

               nContador = 0;
               aTextAux = "";
               |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
                    aSaca = nVoy + "01";
                    aLetra = aLinea % aSaca;
                    |SI aLetra = aTab; |O aLetra = aReturnUnix;
                         nContador = nContador + 1;

                         |SI nContador = 1;
                              aSerieAlba = aTextAux;
                         |FINSI;
                         |SI nContador = 2;
                              nNumAlba = aTextAux;
                         |FINSI;
                         |SI nContador = 3;
                              nBulto = aTextAux;
                         |FINSI;
                         |SI nContador = 4;
                              nPesoBruto = aTextAux;
                         |FINSI;
                         |SI nContador = 5;
                              nPesoNeto = aTextAux;
                         |FINSI;
                         |SI nContador = 6;
                              nVolumen = aTextAux;
                         |FINSI;
                         |SI nContador = 7;
                              aArticulo = aTextAux;
                         |FINSI;
                         |SI nContador = 8;
                              nUdAdju = aTextAux;
                         |FINSI;
                         |SI nContador = 9;
                              aVariosAlba = aTextAux;
                         |FINSI;
                         |SI nContador = 10;
                              nLinAlba = aTextAux;
                         |FINSI;
                         |SI nContador = 11;
                              nTipoCaja = aTextAux;

                              |HAZ ProcesaRegistro;
                         |FINSI;
                         aTextAux = "";
                    |SINO;
                         aTextAux = aTextAux + aLetra;
                    |FINSI;
               |SIGUE;
               nContador = nContador + 1;
               |SI nContador = 11;
                    nTipoCaja = aTextAux;
                    |HAZ ProcesaRegistro;
               |FINSI;
          |FINSI;
     |SIGUE;
     |XCIERRA nHandle;

     |SI nNumeroPL ! 0;
          |DDEFECTO #coiplm01;
          #coiplm01#0 = nNumeroPL;
          |LEE 101#coiplm01.=;
          |SI FSalida = 0;
               #coiplm01#15 = nSumaVolumen;
               #coiplm01#16 = nSumaPesoBruto;
               #coiplm01#17 = nSumaPesoNeto;
               #coiplm01#20 = nBulto;

               |GRABA 020#coiplm01.a;
          |FINSI;
          |LIBERA #coiplm01;

          |SI eaImpPL = "S";
               aAux = nNumeroPL;
               aAux = "coiply01;" + aAux;
               |SUB_EJECUTA_NP aAux;
          |FINSI;
     |FINSI;

     aDestino = aPathReal + "procesados/";
     |RMKDIR aDestino;

     aOrigen = aFichero;
     aDestino = aPathReal + "procesados/" + eaFicheroFalcon;
     |SI aIP = "";
          |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
          |RCOPIA_FICHERO aOrigen, aDestino;
     |FINSI;
     |RFBORRA aOrigen;
|FPRC;


|PROGRAMA;
     aReturnUnix = &10;
     aTab = &9;
     aIP = "";
     |IP_REMOTO aIP;

     |QBF eaFicheroFalcon;
     |SI eaFicheroFalcon = "";
          |ACABA;
     |FINSI;

     |CLS;

     |ABRE #coima001;
     |DDEFECTO #coima001;
     |LEE 000#coima001.p;
     |CIERRA #coima001;

     aPath = #coima001#20;
     |QBF aPath;

     |SI aPath = "";
          aMensaje = "0000Carpeta recogida datos Falcon VACIA";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     aAlfa = aPath % -101;
     |SI aAlfa ! "/"; |Y aAlfa ! "\"; aPath = aPath + "/"; |FINSI;

     aPathReal = aPath;

     |ABRE #coiplm01;
     |ABRE #coiplm02;
     |ABRE #coiplm03;
     |ABRE #agifa010;
     |ABRE #agifa024;
     |ABRE #coima044;
     |HAZ ProcesaFic;
     |CIERRA #coiplm01;
     |CIERRA #coiplm02;
     |CIERRA #coiplm03;
     |CIERRA #agifa010;
     |CIERRA #agifa024;
     |CIERRA #coima044;

/*
     aPath = aPath + "*.pac";
     aIP = "";
     |IP_REMOTO aIP;

     |SI aIP = "";
          |_PDIR aPath;
          |PARA; |SI FSalida = 0; |HACIENDO;
               |HAZ ProcesaFic;
               |_SDIR aPath;
          |SIGUE;
     |SINO;
          |R_PDIR aPath;
          |PARA; |SI FSalida = 0; |HACIENDO;
               |HAZ ProcesaFic;
               |R_SDIR aPath;
          |SIGUE;
     |FINSI;
*/
|FPRO;
