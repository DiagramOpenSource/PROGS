COPIA de 'margen'

|FICHEROS;
     tecaz030 #0;
     agifa019 #1;
     agifa010 #2;
     agifa071 #3;
     agifa017 #17;
     dsm00128 #128;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     dart = "                    ";
     hart = "zzzzzzzzzzzzzzzzzzzz";
     imneto = 0;
     margen = 0;
     coste = 0;
     mes = 0;
     fmes = "";
     dserie = "";
     hserie = "zz";
     dalba  = 0;
     halba  = 999999;
     facturado = "S";
|FIN;

|PROCESO lineas;
     |DDEFECTO #17;
     #17#0 = #3#2;
     #17#1 = #3#3;
     |LEE 000#17=;

     |DDEFECTO #1;
     #1#0 = #3#2;
     |LEE 101#1=;
     |SI FSalida = 0;
         imneto = #3#9 < #2#5;
         imneto = imneto < #2#7;
         imneto = imneto < #2#32;
         coste  = #3#5 * #17#69;||Coste de la linea;
         margen = imneto - coste;
         fmes   = #2#1 % A402;
         mes = fmes - 1;
         mes = mes * 5;
         mes = mes + 35;
         mes = mes + 1;
         #1mes = #1mes + margen;       || Margen mes (Articulos)
         #1#96 = #1#96 + margen;       || Total margen.  (Articulos)
         |GRABA 020#1a;
         |LIBERA #1;

          efFecha = #2#1;
          eaArticulo = #3#2;
          enImpMar = margen;
          |HAZ AcumulaArt;
     |FINSI;
|FPRC;

|DEFBUCLE albaran;
     #2#1;
     38;
     dserie,dalba,facturado;
     hserie,halba,facturado;
     be;
     NULL, NULL, lineas;
|FIN;

|PROCESO dsm00128;
     #128#54 = 0;
     #128#55 = 0;
     #128#56 = 0;
     #128#57 = 0;
     #128#58 = 0;
     #128#59 = 0;
     #128#60 = 0;
     #128#61 = 0;
     #128#62 = 0;
     #128#63 = 0;
     #128#64 = 0;
     #128#65 = 0;
     #128#66 = 0;
     |GRABA 020#128a;
     |LIBERA #128;
|FPRC;

|DEFBUCLE dsm00128;
     #128#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, dsm00128;
|FIN;

|PROCESO ceroart;
     #1#36 = 0;
     #1#41 = 0;
     #1#46 = 0;
     #1#51 = 0;
     #1#56 = 0;
     #1#61 = 0;
     #1#66 = 0;
     #1#71 = 0;
     #1#76 = 0;
     #1#81 = 0;
     #1#86 = 0;
     #1#91 = 0;
     #1#96 = 0;
     |GRABA 020#1a;
     |LIBERA #1;
|FPRC;


|DEFBUCLE articulos;
     #1#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, ceroart;
|FIN;

|PROCESO margen;|TIPO 3;
     |SI #0#0 = "S";
          |HAZ DecimalesBase;
          |BUCLE articulos;
          |BUCLE dsm00128;
          |ABRE #1;
          |ABRE #17;
          |BUCLE albaran;
          |CIERRA #17;
          |CIERRA #1;
     |FINSI;
|FPRC;
