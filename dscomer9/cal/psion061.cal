|FICHEROS;
     psion061 #0;
     psion004 #1;   || Cabecera.
     psion005 #2;   || Lineas.
     psion062 #62;
     psion063 #63;
     psion064 #64;
     psion065 #65;
     agifa321 #14;  || Divisas-Parametros.
     agifa324 #15;  || Divisas-Divisas.
|FIN;

|VARIABLES;
     &eaFichero1 = "";
     &eaFichero2 = "";
     aTmp1 = "";
     aTmp2 = "";
     &Tempo = "";
     &enNumFic = 0;
     &enPedImpor = 0;
     nReg = "";
     aPathOrg = "";
     aPath = "";
     aFic = "";
     aAlfa = "";
     aExt = "";
     nHandle = 0;

 {90}Valor = "";
     aReg = "";
     aLon = "";
     aDato = "";
     nPos = 0;
     aLetra = "";
     aTab = "";
     i = 0;
     nCampo = 0;
|FIN;

|PROCESO Copia64;
     |DDEFECTO #64;
     #64#0 = #1#0;
     #64#1 = #1#1;
     #64#2 = #1#2;
     |LEE 101#64=;
     |SI FSalida ! 0; |GRABA 020#64b; |FINSI;
     |PARA i = 0; |SI i [ 37; |HACIENDO i = i + 1;
          #64i = #1i;
     |SIGUE;
     |GRABA 020#64a;
     |LIBERA #64;
|FPRC;

|PROCESO Copia65;
     |DDEFECTO #65;
     #65#0 = #2#0;
     #65#1 = #2#1;
     #65#2 = #2#2;
     |LEE 101#65=;
     |SI FSalida ! 0; |GRABA 020#65b; |FINSI;
     |PARA i = 0; |SI i [ 14; |HACIENDO i = i + 1;
          #65i = #2i;
     |SIGUE;
     |GRABA 020#65a;
     |LIBERA #65;
|FPRC;

|PROCESO Linea;
     |DDEFECTO #2;
     #2#0 = Valor1;
     #2#1 = Valor2;
     #2#2 = Valor3;
     #2#3 = Valor4;

     |LEE 101#2=;
     |SI FSalida ! 0; |GRABA 020#2b; |FINSI;
     #2#4 = Valor5;
     #2#6 = Valor6;
     #2#7 = Valor7;
     #2#8 = Valor8;
     #2#9 = Valor9;
     #2#5 = Valor10;
     #2#12 = Valor11;
     #2#15 = Valor12;
     #2#16 = Valor13;
     #2#17 = Valor14;
     |SI #2#11 = 0; #2#11 = 1; |FINSI; || Almacen
     |HAZ grabalineas;
     |GRABA 020#2a;
     |LIBERA #2;
     |HAZ Copia65;

     #1#0 = #2#0;
     #1#0 = #2#0;
     |LEE 101#1=;
     |SI FSalida = 0;
          |HAZ grabacabeza;
          |GRABA 020#1a;
          |LIBERA #1;
          |HAZ Copia64;
     |FINSI;
|FPRC;

|PROCESO Cabecera;
     |DDEFECTO #1;
     #1#0 = Valor1;
     #1#1 = Valor2;
     #1#2 = Valor3;
     |LEE 101#1=;
     |SI FSalida = 0; |ACABA; |FINSI;
     |SI FSalida ! 0; |GRABA 020#1b; |FINSI;
     #1#3 = Valor4;
     #1#4 = Valor5;
     #1#6 = Valor6;
     #1#7 = Valor7;
     #1#11 = Valor11;
     #1#12 = Valor12;
     #1#13 = Valor13;
     #1#32 = Valor14;
     #1#33 = Valor15;
     #1#34 = Valor16;
     #1#35 = Valor17;
     #1#37 = Valor10;
     #1#10 = Valor19;
     |SI #1#32 = 0; #1#32 = 1; |FINSI;  || Dir. Entrega
     #1#7 = #1#7 ! #15#7;
     |HAZ grabacabeza;
     |GRABA 020#1a;
     |LIBERA #1;
     |HAZ Copia64;
     enPedImpor = enPedImpor + 1;
|FPRC;

|PROCESO Dato;
     IValor = Valor1<-;
     |PARA i = 1; |SI i [ 90; |HACIENDO i = i + 1;
          Valor = "";
          IValor = IValor + 1;
     |SIGUE;
     nCampo = 1;
     IValor = Valor1<-;
     aLon = aDato % A0;
     aReg = "";
     aTab = &9;
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aLetra = aDato % nPos;
          |SI aLetra = aTab;
               Valor = aReg;
               aReg = "";
               nCampo = nCampo + 1;
               IValor = IValor + 1;
          |SINO;
               aReg = aReg + aLetra;
          |FINSI;
          |SI nCampo > 90; |SAL; |FINSI;     || Por si.... :)
     |SIGUE;
     Valor = aReg;
|FPRC;

|PROCESO ProcesaFic;
     |XABRE "", aPath, nHandle;
     |SI FSalida ] 0;
          |XLEE nHandle, 250, aDato;
          |PARA; |SI FSalida ] 0; |HACIENDO;
               |HAZ Dato;
               |SI aExt = "cab";
                    |HAZ Cabecera;
               |SINO;
                    |HAZ Linea;
               |FINSI;
               |XLEE nHandle, 250, aDato;
          |SIGUE;
          |XCIERRA nHandle;
          enNumFic = enNumFic + 1;
     |FINSI;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     |SI #0#0 = "NO"; |ACABA; |FINSI;

     |HAZ CreaTempo; |NOME_DAT #1#Tempo#; |DELINDEX #1; aTmp1 = Tempo;
     |HAZ CreaTempo; |NOME_DAT #2#Tempo#; |DELINDEX #2; aTmp2 = Tempo;


     |ABRE #63;
     |ABRE #1;
     |ABRE #2;
     |ABRE #64;
     |ABRE #65;

     aPathOrg = #62#1; |QBF aPathOrg;
     aPath = aPathOrg;
     |SI aPath ! "";
          |_PDIR aPath;
          |PARA; |SI FSalida = 0; |HACIENDO;
               aLon = aPathOrg % A0;
               nPos = aLon + 1;
               aFic = aPath % nPos;
               aExt = aFic % -103;
               aExt = aExt < "";
               |SI aExt = "cab"; |O aExt = "lin";
                    |SELECT #1#63;
                    |LEE 000#63u;
                    |SI FSalida = 0; nReg = #63#3; |SINO nReg = 0; |FINSI;

                    |SELECT #2#63;
                    #63#0 = aFic;
                    |LEE 000#63=;
                    |SI FSalida ! 0;
                         |HORA aAlfa;
                         #63#1 = ~;
                         #63#2 = aAlfa;
                         #63#3 = nReg + 1;
                         #63#4 = "";
                         |GRABA 020#63n;
                         |HAZ ProcesaFic;
                    |SINO;
                         enNumFic = enNumFic + 1;
                         |HORA aAlfa;
                         #63#1 = ~;
                         #63#2 = aAlfa;
                         #63#4 = "Pedido existente en Registro:" + #63#3;
                         #63#3 = nReg + 1;
                         |GRABA 020#63n;
                    |FINSI;
                    |SI #62#2 = "S"; |RFBORRA aPath; |FINSI;
               |FINSI;
               |_SDIR aPath;
          |SIGUE;
     |FINSI;

     aPathOrg = #62#5; |QBF aPathOrg;
     aPath = aPathOrg;
     |SI aPath ! "";
          |_PDIR aPath;
          |PARA; |SI FSalida = 0; |HACIENDO;
               aLon = aPathOrg % A0;
               nPos = aLon + 1;
               aFic = aPath % nPos;
               aExt = aFic % -103;
               aExt = aExt < "";
               |SI aExt = "cab"; |O aExt = "lin";
                    |SELECT #1#63;
                    |LEE 000#63u;
                    |SI FSalida = 0; nReg = #63#3; |SINO nReg = 0; |FINSI;

                    |SELECT #2#63;
                    #63#0 = aFic;
                    |LEE 000#63=;
                    |SI FSalida ! 0;
                         |HORA aAlfa;
                         #63#1 = ~;
                         #63#2 = aAlfa;
                         #63#3 = nReg + 1;
                         #63#4 = "";
                         |GRABA 020#63n;
                         |HAZ ProcesaFic;
                    |SINO;
                         enNumFic = enNumFic + 1;
                         |HORA aAlfa;
                         #63#1 = ~;
                         #63#2 = aAlfa;
                         #63#4 = "Pedido existente en Registro:" + #63#3;
                         #63#3 = nReg + 1;
                         |GRABA 020#63n;
                    |FINSI;
                    |SI #62#2 = "S"; |RFBORRA aPath; |FINSI;
               |FINSI;
               |_SDIR aPath;
          |SIGUE;
     |FINSI;

     |CIERRA #65;
     |CIERRA #64;
     |CIERRA #2;
     |CIERRA #1;
     |CIERRA #63;

     || Pasa a gestion
     eaFichero1 = aTmp1;
     eaFichero2 = aTmp2;
     aAlfa = "psion011;DIRECTA"; |SUB_EJECUTA_NP aAlfa;
     aAlfa = "psion012;DIRECTA"; |SUB_EJECUTA_NP aAlfa;

     Tempo = aTmp1; |HAZ BoraTempo; |DELINDEX #1;
     Tempo = aTmp2; |HAZ BoraTempo; |DELINDEX #2;
|FPRC;

|PROCESO LeeDivisa;
     |ABRE #14;
     |ABRE #15;
     |LEE 001#14p;
     #15#0 = #14#9;
     |LEE 001#15=;
     |CIERRA #14;
     |CIERRA #15;
|FPRC;

|PROGRAMA;
     enPedImpor = 0;

     |ABRE #0;
     |LEE 101#0p;   || Bloqueo
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;

     |ABRE #62; |LEE 000#62p; |CIERRA #62;
     |HAZ LeeDivisa;
     |SI PARAMETRO = "";
          #0#0 = "SI";
          |HAZ Tipo3;
     |SINO;
          |CLS;
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
     |FINSI;

     |CIERRA #0;
|FPRO;
