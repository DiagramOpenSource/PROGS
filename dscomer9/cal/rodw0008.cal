|FICHEROS;
     rodw0008 #0;

     rodm0006 #78; ||Rapels (C)
     rodm0007 #79; ||Rapels (L)
     rodm0008 #95; ||Series sin Rapel
     agifa134 #134;
     agifa059 #59;
     agifa010 #90;
     agifa071 #91;
     rodm0009 #96;
     rodm0010 #97;
     referen@ #100;
|FIN;

|VARIABLES;
     nMesAnt = 0;
     nAlba = 0;
     nLin = 0;
     fFecha = @;
     fIni = @;
     fFin = @;
     aAlfa = "";
     nNume = 0;
     nMeses = 0;
     nAno = 0;
     nMes = 0;
     nRapel = 0;
|FIN;

|PROCESO malpe079;
     |SI #96#6 < #79#3;
          |ERROR10;
     |FINSI;
     nRapel = #79#4;
|FPRC;

|DEFBUCLE malpe079;
     #79#1;
     ;
     #96#0, 001;
     #96#0, 999;
     ;
     NULL, malpe079;
|FIN;

|PROCESO CalcuRapel;
     nRapel = 0;
     |BUCLE malpe079;

     #96#7 = nRapel;
     #96#8 = #96#6 % #96#7;
     #96#9 = #78#3;
     |GRABA 020#96a;
     |LIBERA #96;
|FPRC;

|DEFBUCLE CalcuRapel;
     #96#1;
     ;
     #78#0, #0#2;
     #78#0, #0#2;
     be;
     NULL, CalcuRapel;
|FIN;

|PROCESO malpe091_2;
     |DDEFECTO #96;
     #96#0 = #78#0;
     #96#2 = #0#2;
     |LEE 101#96=;
     |SI FSalida ! 0; |GRABA 020#96b; |FINSI;

     |HAZ UltimaLin;
     |DDEFECTO #97;
     #97#0 = #96#0;
     #97#2 = #96#2;
     #97#5 = nLin;

     #97#6 = #134#49;
     #97#7 = #134#0;
     #97#8 = #91#29;
     #97#9 = #91#0;
     #97#10 = #91#1;
     #97#11 = #91#2;
     #97#12 = #91#5 * #91#6;
     #97#13 = #97#12;
     #97#14 = #78#5;
     |GRABA 020#97n;

     #96#5 = ~;
     #96#6 = #96#6 + #97#13;
     |GRABA 020#96a;
     |LIBERA #96;
|FPRC;

|DEFBUCLE malpe090_2;
     #90#1;
     ;
     #59#15, #59#2;
     #59#15, #59#2;
     ;
     NULL, NULL, malpe091_2;
|FIN;

|PROCESO agifa059_2;
     |BUCLE malpe090_2;
|FPRC;

|PROCESO agifa134_2;
     #95#0 = #134#49;
     |LEE 000#95=;
     |SI FSalida = 0; |ERROR; |FINSI;
|FPRC;

|DEFBUCLE agifa134_2;
     #134#3;
     ;
     #78#0, fIni, "     ", 000001;
     #78#0, fFin, "zzzzz", 999999;
     ;
     NULL, agifa134_2, agifa059_2;
|FIN;

|PROCESO UltimaLin;
     #97#0 = #96#0;
     #97#2 = #96#2;
     #97#5 = 99999;
     |LEE 000#97];
     |SI FSalida = 0;
          |LEE 000#97a;
     |SINO;
          |LEE 000#97u;
     |FINSI;
     |SI FSalida = 0; |Y #97#0 = #96#0; |Y #97#2 = #96#2;
          nLin = #97#5 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
|FPRC;

|PROCESO malpe091;
     |DDEFECTO #96;
     #96#0 = #78#0;
     #96#2 = #0#2;
     |LEE 101#96=;
     |SI FSalida ! 0; |GRABA 020#96b; |FINSI;

     |HAZ UltimaLin;
     |DDEFECTO #97;
     #97#0 = #96#0;
     #97#2 = #96#2;
     #97#5 = nLin;

     #97#6 = #134#49;
     #97#7 = #134#0;
     #97#8 = #91#29;
     #97#9 = #91#0;
     #97#10 = #91#1;
     #97#11 = #91#2;
     #97#12 = #91#5 * #91#6;
     #97#13 = #97#12;
     #97#14 = #78#5;
     |GRABA 020#97n;

     #96#5 = ~;
     #96#6 = #96#6 + #97#13;
     |GRABA 020#96a;
     |LIBERA #96;
|FPRC;

|DEFBUCLE malpe090;
     #90#1;
     ;
     #59#15, #59#2;
     #59#15, #59#2;
     ;
     NULL, NULL, malpe091;
|FIN;

|PROCESO agifa059;
     |BUCLE malpe090;
|FPRC;

|PROCESO agifa134;
     #95#0 = #134#49;
     |LEE 000#95=;
     |SI FSalida = 0; |ERROR; |FINSI;
|FPRC;

|DEFBUCLE agifa134;
     #134#3;
     ;
     #78#0, fIni, "     ", 000001;
     #78#0, fFin, "zzzzz", 999999;
     ;
     NULL, agifa134, agifa059;
|FIN;

|PROCESO Rapel;
     |ABRE #96;
     |ABRE #97;
     |BUCLE agifa134;
||||     |BUCLE agifa134_2;
     |CIERRA #97;
     |CIERRA #96;

     |ABRE #100;
     |BUCLE CalcuRapel;
     |CIERRA #100;
|FPRC;

|PROCESO Borra;
     |BUCLELIN 1 NULL #96;
     |BORRA 020#96a;
|FPRC;

|PROCESO Chequea;
     nAlba = #96#11;
     |SI nAlba ! 0; |ERROR10; |FINSI;
|FPRC;

|DEFBUCLE Rapel;
     #78#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Rapel;
|FIN;

|DEFBUCLE Borra;
     #96#1;
     ;
     "      ", #0#2;
     "zzzzzz", #0#2;
     be;
     NULL, Borra;
|FIN;

|DEFBUCLE Chequea;
     #96#1;
     ;
     "      ", #0#2;
     "zzzzzz", #0#2;
     ;
     NULL, Chequea;
|FIN;

|PROCESO Ano; |TIPO 7;
     |SI #0#2 = 0;
          fFecha = ~;
          aAlfa = fFecha % -104;
          #0#2 = aAlfa; |PINTA #0#2;
     |FINSI;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     |DDEF aAlfa;
     aAlfa = aAlfa + "rodm0009";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error en def";
          |ACABA;
     |FINSI;

     aAlfa = "01.01." + (("0000" + #0#2) % -104);
     fIni = aAlfa;
     aAlfa = "31.12." + (("0000" + #0#2) % -104);
     fFin = aAlfa;

     |ABRE #95;
     |BUCLE Chequea;
     |SI nAlba = 0;
          |BUCLE Borra;
          |BUCLE Rapel;
     |SINO;
          |MENAV "0000Calculo y Albaranes ya generados.";
     |FINSI;
     |CIERRA #95;

     |DESCARGA_DEF #referen@;
|FPRC;
