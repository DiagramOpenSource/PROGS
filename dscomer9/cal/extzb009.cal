FactuParte, Facturar, TraspasoEnt, TraspasoSal, ReabreParte, AltaSerFac
Albaran, BajaAlbaran

|FICHEROS;
     extw0001 #1;   ||Tmp Pdte Fac
     extw0002 #2;   ||Tmp Cli Fac
     agifa010 #10;
     extm0011 #11;
     extm0013 #13;
     extm0014 #14;
     extm0015 #15;
     extm0016 #16;
     agifa017 #17;
     extm0018 #18;
     agifa019 #19;
     extm0022 #22,MANTE;
     agifa024 #24;
     agifa025 #25;
     dsm00003 #30;
     dsm00054 #54;
     dsm00055 #55;
     agifa059 #59;
     agifa071 #71;
     tmp00000 #100;
     agifa142 #142;
     extz0026 #126,MANTE; || Pan Factu Parte
     extz0028 #128,MANTE; || Pan. Alba
     extz0029 #129,MANTE; ||Pan. Fecha fac
     agifa134 #134;
     extm0019 #190;
     agifa321 #321;
     agifa324 #324;
     tempo134 #500;
|FIN;

|VARIABLES;
     &eaMenuImpre = "";
     &eaDefImpre = "";
     &ser_fac = "";
     &num_fac = 0;
     &reimp = "";
     &eaOrdenado = "";
     &abono = "";
     &ser_alb = "";
     &num_alb = 0;
     &enDescuento1 = 0;
     &enDescuento2 = 0;
     &eaTComision  = "";
     &eaCliente    = "";
     &eaArticulo   = "";
     &eaRepre      = "";
     &efFecha      = @;
     &enDirEnt = 0;
     &enAlmacen = 0;
     &uni_dt = 0;
     &uni_dt2 = 0;
     &enComision = 0;

     &Tempo = "";
     &eaFichero = "";
     &enCoste = 0;
     &eaCli = "";
     &efFiva = @;
     &enTiva = 0;
     &enIva = 0;
     &enRec = 0;
     &enCodigo = 0;
     &enForma = 0;
     &enSwMenu = 0;
     &eaMovimi = "";
     &eaSerie = "";
     &enLinea = 0;
     aSerFac = "";
     aSerAlb = "";
     aCli = "";
     nDir = 0;
     aEdi = "";
     nLin = 0;
     nNume = 0;
     aTmp100 = "";
     aTmp500 = "";
     aCliFac = "";
     nDirFac = 0;
     fFecFac = @;
     aAlfa = "";
     aA¤o = "";
     fHoy = @;
     aTipoFac = "";
     nSwAlbaran = 0;
     nSwFactura = 0;
     nPrecio = 0;
     aDesArt = "";
     nLinFac = 0;
|FIN;

|PROCESO Comi;
     enDescuento1 = #71#8;
     enDescuento2 = #71#33;
     eaTComision  = #71#16;
     eaCliente    = #10#3;
     eaArticulo   = #71#2;
     eaRepre      = #10#6;
     efFecha      = #10#1;
     enDirEnt = #10#84;
     enAlmacen = #71#3;
     |SI #71#35 ! 0;
          uni_dt = #71#35;
     |SINO;
          uni_dt = #71#5;
     |FINSI;
     uni_dt2 = #71#48;
     |HAZ Comisiones;
|FPRC;

|PROCESO ArtDeja;
     |ABRE #54;
     |ABRE #55;
     |ABRE #19;
     |ABRE #17;
     |SI enForma = 1;
          #54#2 = #13#0;
          #54#0 = #13#1;
          #54#1 = #13#2;
          |GRABA 000#54n;
     |FINSI;
     |SI enForma = 0;
          #55#28 = #13#0;
          #55#27 = #13#1;
          #55#11 = #16#7;
          |LEE 101#55=;
          |SI FSalida = 0;
               eaMovimi = "ME_MS";
               enForma = -1;
               enCodigo = #55#27;
               eaSerie = #55#28;
               enLinea = #55#11;
               |SUB_EJECUTA_NP "dsz90001";
               |BORRA 020#55a;
          |FINSI;

          #55#28 = #13#0;
          #55#27 = #13#1;
          #55#11 = 0;
          |LEE 000#55];
          |SI FSalida ! 0; |O #55#28 ! #13#0; |O #55#27 ! #13#1;
               #54#2 = #13#0;
               #54#0 = #13#1;
               |BORRA 000#54c;
          |FINSI;
     |SINO;
          #55#28 = #13#0;
          #55#27 = #13#1;
          #55#11 = #16#7;
          |LEE 101#55=;
          |SI #16#7 = 0; |O FSalida ! 0;
               |HAZ UltLinTras;
               |DDEFECTO #55;
               #55#28 = #13#0;
               #55#27 = #13#1;
               #55#11 = nLin;
               |GRABA 020#55b;
               #16#7 = nLin;
               |GRABA 020#16a;
          |FINSI;
          #55#0 = #16#3;
          #55#1 = #18#13;
          #19#0 = #55#0;
          |LEE 000#19=;
          |SI FSalida ! 0; |DDEFECTO #19; |FINSI;
          #17#0 = #55#0;
          #17#1 = #55#1;
          |SI FSalida ! 0; |DDEFECTO #17; |FINSI;
          #55#2 = #19#1;
          #55#3 = #17#5;
          #55#4 = #16#5;
          #55#5 = #16#4;
          #55#9 = #17#41;
          #17#0 = #55#0;
          #17#1 = #55#5;
          |SI FSalida ! 0; |DDEFECTO #17; |FINSI;
          #55#6 = #17#5;
          #55#7 = #19#6;
          #55#8 = #54#1;
          #55#10 = #17#41;
          #55#29 = #19#133;
          |GRABA 020#55a;
          |LIBERA #55;
          eaMovimi = "ME_MS";
          enCodigo = #55#27;
          eaSerie = #55#28;
          enLinea = #55#11;
          |SUB_EJECUTA_NP "dsz90001";
          |SI enForma = -1;
               #55#28 = #13#0;
               #55#27 = #13#1;
               #55#11 = 0;
               |LEE 000#55];
               |SI FSalida ! 0; |O #55#28 ! #13#0; |O #55#27 ! #13#1;
                    #54#2 = #13#0;
                    #54#0 = #13#1;
                    |BORRA 000#54c;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #17;
     |CIERRA #19;
     |CIERRA #54;
     |CIERRA #55;
|FPRC;

|DEFBUCLE ArtDeja;
     #16#1;
     ;
     #13#0, #13#1, 001;
     #13#0, #13#1, 999;
     be;
     NULL, ArtDeja;
|FIN;

|PROCESO TraspasoSal;
     |BUCLE ArtDeja;
|FPRC;

|PROCESO UltLinTras;
     #55#28 = #13#0;
     #55#27 = #13#1;
     #55#11 = 99999;
     |LEE 000#55];
     |SI FSalida = 0;
          |LEE 000#55a;
     |SINO;
          |LEE 000#55u;
     |FINSI;
     |SI FSalida = 0; |Y #55#28 = #13#0; |Y #55#27 = #13#1;
          nLin = #55#11 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
|FPRC;

|PROCESO TraspasoEnt;
     #16#4 = #18#14;
     |ABRE #54;
     |ABRE #55;
     |ABRE #19;
     |ABRE #17;
     |SI enForma = 1;
          #54#2 = #13#0;
          #54#0 = #13#1;
          #54#1 = #13#2;
          |GRABA 000#54n;
     |FINSI;
     |SI enForma = 0;
          #55#28 = #13#0;
          #55#27 = #13#1;
          #55#11 = #16#6;
          |LEE 101#55=;
          |SI FSalida = 0;
               eaMovimi = "ME_MS";
               enForma = -1;
               enCodigo = #55#27;
               eaSerie = #55#28;
               enLinea = #55#11;
               |SUB_EJECUTA_NP "dsz90001";
               |BORRA 020#55a;
          |FINSI;

          #55#28 = #13#0;
          #55#27 = #13#1;
          #55#11 = 0;
          |LEE 000#55];
          |SI FSalida ! 0; |O #55#28 ! #13#0; |O #55#27 ! #13#1;
               #54#2 = #13#0;
               #54#0 = #13#1;
               |BORRA 000#54c;
          |FINSI;
     |SINO;
          #55#28 = #13#0;
          #55#27 = #13#1;
          #55#11 = #16#6;
          |LEE 101#55=;
          |SI #16#6 = 0; |O FSalida ! 0;
               |HAZ UltLinTras;
               |DDEFECTO #55;
               #55#28 = #13#0;
               #55#27 = #13#1;
               #55#11 = nLin;
               |GRABA 020#55b;
               #16#6 = nLin;
               |GRABA 020#16a;
          |FINSI;
          #55#0 = #16#3;
          #55#1 = #18#14;
          #19#0 = #55#0;
          |LEE 000#19=;
          |SI FSalida ! 0; |DDEFECTO #19; |FINSI;
          #17#0 = #55#0;
          #17#1 = #55#1;
          |SI FSalida ! 0; |DDEFECTO #17; |FINSI;
          #55#2 = #19#1;
          #55#3 = #17#5;
          #55#4 = #16#5;
          #55#5 = #18#13;
          #55#9 = #17#41;
          #17#0 = #55#0;
          #17#1 = #55#5;
          |SI FSalida ! 0; |DDEFECTO #17; |FINSI;
          #55#6 = #17#5;
          #55#7 = #19#6;
          #55#8 = #54#1;
          #55#10 = #17#41;
          #55#29 = #19#133;
          |GRABA 020#55a;
          |LIBERA #55;
          eaMovimi = "ME_MS";
          enCodigo = #55#27;
          eaSerie = #55#28;
          enLinea = #55#11;
          |SUB_EJECUTA_NP "dsz90001";
     |FINSI;
     |CIERRA #17;
     |CIERRA #19;
     |CIERRA #54;
     |CIERRA #55;
|FPRC;

|PROCESO LinAlb;
     |ABRE #19;
     #19#0 = #71#2;
     |LEE 000#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;
     |CIERRA #19;
     #71#3 = #18#14;
     |SI aDesArt = "";
          #71#4 = #19#1;
     |SINO;
          #71#4 = aDesArt;
     |FINSI;
     #71#11 = #19#30;
     #71#13 = #19#2;
     #71#16 = #10#34;
     #71#17 = #10#35;
     #71#26 = #10#39;
     #71#30 = #10#53;
     |HAZ Comi;
     #71#10 = enComision;
     |HAZ AcumulaAV;
     #71#14 = enCoste;
     |HAZ TotalLin71;
     |HAZ CalCabAgifa010;
     |GRABA 020#10a;

     |DDEFECTO #190;
     |ABRE #190;
     #190#0 = #71#2;
     #190#1 = #14#2;
     |LEE 101#190=;
     |SI FSalida ! 0; |GRABA 020#190b; |FINSI;
     #190#6 = #10#1;
     #190#7 = #10#3;
     #190#8 = #10#52;
     #190#9 = #10#0;
     #190#10 = #71#1;
     |GRABA 020#190a;
     |CIERRA #190;
|FPRC;

|PROCESO ArtExtra;
     nLin = nLin + 1;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = nLin;
     #71#2 = #15#3;
     #71#5 = #15#4;
     #71#6 = #15#5;
     #71#8 = #15#11;
     |HAZ LinAlb;
     |GRABA 020#71n;

     #15#8 = #71#29;
     #15#9 = #71#0;
     #15#10 = #71#1;
     #15#7 = #10#3;
     |GRABA 020#15a;
|FPRC;

|DEFBUCLE ArtExtra;
     #15#1;
     ;
     #13#0, #13#1, 001;
     #13#0, #13#1, 999;
     be;
     NULL, ArtExtra;
|FIN;

|PROCESO ArtParte;
     |SI #13#40 = "S";
          nPrecio = nPrecio + #14#17;
     |SINO;
          nLin = nLin + 1;
          #71#29 = #10#52;
          #71#0 = #10#0;
          #71#1 = nLin;
          #71#2 = #14#16;
          #71#5 = #14#6;
          #71#6 = #14#17;
          |HAZ LinAlb;
          |GRABA 020#71n;
     |FINSI;

     #11#0 = #14#2;
     |LEE 121#11=;
     |SI FSalida = 0;
          |SI #14#8 ! "01.01.0000";   ||F.Ult.Rev
               #11#23 = #14#9;     ||F.Ultima = Teorica
               #11#27 = #14#10;    ||F.Proxima = Proxima
               #11#24 = #14#25;    ||F.Real = Real
          |FINSI;
          |SI #14#13 ! "01.01.0000";   ||F.Ult.Rev
               #11#33 = #14#12;     ||F.Ultima = Teorica
               #11#37 = #14#13;    ||F.Proxima = Proxima
               #11#34 = #14#25;    ||F.Real = Real
          |FINSI;
          #11#15 = #14#19; || Obs.
          #11#16 = #14#20;
          #11#17 = #14#21;
          #11#18 = #14#22;
          #11#19 = #14#23;

          #11#45 = "";
          #11#46 = 0;
          |GRABA 020#11a;
          |LIBERA #11;
     |FINSI;
     |SI #14#18 = "N";
          #100#0 = #13#0;
          #100#1 = #13#1;
          |GRABA 000#100n;
     |FINSI;
|FPRC;

|DEFBUCLE ArtParte;
     #14#1;
     ;
     #13#0, #13#1, "                    ";
     #13#0, #13#1, "zzzzzzzzzzzzzzzzzzzz";
     be;
     NULL, ArtParte;
|FIN;

|PROCESO LineasArtParte;
     |SI nSwFactura = 0;
          |ABRE #11;
          nPrecio = 0;
          |BUCLE ArtParte;
          |SI #13#40 = "S";
               nLin = nLin + 1;
               #71#29 = #10#52;
               #71#0 = #10#0;
               #71#1 = nLin;
               #71#2 = #13#41;
               #71#5 = 1;
               #71#6 = nPrecio;
               aDesArt = #13#42;
               |HAZ LinAlb;
               aDesArt = "";
               |GRABA 020#71n;
          |FINSI;
          |CIERRA #11;
          |BUCLE ArtExtra;
     |FINSI;
|FPRC;

|PROCESO LineasFac;
     nLinFac = nLinFac + 1;
     #10#52 = #13#14;
     #10#0 = #13#15;
     |LEE 121#10=;
     |SI FSalida = 0;
          #10#39 = #134#0;
          #10#53 = #134#49;
          #10#60 = #134#1;
          |GRABA 020#10a;
          |LIBERA #10;
     |FINSI;
     #59#14 = #134#49;
     #59#0 = #134#0;
     #59#1 = nLinFac;
     #59#2 = #13#15;
     #59#15 = #13#14;
     |GRABA 020#59n;
|FPRC;

|PROCESO CabFac;
     nLinFac = 0;

     |DDEFECTO #24;
     |ABRE #24;
     #24#0 = aCliFac;
     |LEE 000#24=;
     |CIERRA #24;
     |DDEFECTO #25;
     |ABRE #25;
     #25#0 = #24#25;
     |LEE 000#25=;
     |CIERRA #25;
     |DDEFECTO #30;
     |ABRE #30;
     #30#0 = aCliFac;
     #30#1 = nDirFac;
     |LEE 000#30=;
     |CIERRA #30;

     #134#49 = aSerFac;
     |SI #13#12 = "S"; |Y nSwAlbaran = 0;  ||facturable
          enSwMenu = 1;
          |HAZ ContaFV7;
     |FINSI;
     #134#1 = fFecFac;
     #134#2 = #24#0;
     #134#3 = #24#1;
     #134#4 = #24#37;
     #134#5 = #24#156;
     #134#6 = #24#38;
     #134#7 = #25#0;
     #134#9 = #24#29;
     #134#10 = #24#30;
     #134#11 = #24#20;
     #134#12 = #24#16;
     #134#13 = #24#47;
     #134#14 = #24#22;
     #134#15 = #24#23;
     #134#16 = #24#24;
     |PARA enTiva = 1; |SI enTiva [ 5; |HACIENDO enTiva = enTiva + 1;
          eaCli = #134#2;
          efFiva = #134#1;
          |HAZ IVACli;
          |SI enTiva = 1; #134#39 = enIva; #134#40 = enRec; |FINSI;
          |SI enTiva = 2; #134#41 = enIva; #134#42 = enRec; |FINSI;
          |SI enTiva = 3; #134#43 = enIva; #134#44 = enRec; |FINSI;
          |SI enTiva = 4; #134#50 = enIva; #134#51 = enRec; |FINSI;
          |SI enTiva = 5; #134#52 = enIva; #134#53 = enRec; |FINSI;
     |SIGUE;
     #134#58 = #24#192;

     |ABRE #324;
     #324#0 = #134#58;
     |LEE 000#324=;
     |SI FSalida ! 0; |DDEFECTO #324; |FINSI;
     #134#59 = #324#2;
     #134#60 = #24#193;
     |ABRE #321; |LEE 000#321p; |CIERRA #321;
     #134#61 = #321#9;
     #324#0 = #134#61;
     |LEE 000#324=;
     |SI FSalida ! 0; |DDEFECTO #324; |FINSI;
     |CIERRA #324;
     #134#62 = #324#2;
     #134#63 = 1;
     #134#115 = #30#1;
     #134#124 = #24#15;
     |SI #13#12 = "S"; |Y nSwAlbaran = 0;  ||facturable
          |GRABA 020#134b;
     |FINSI;

     |SI nSwFactura = 0;
          #10#52 = aSerAlb;
          enSwMenu = 1;
          |HAZ ContaAV7;
          #10#1 = #134#1;
          #10#3 = #24#0;
          #10#4 = #24#2;
          #10#5 = #24#37;
          #10#6 = #25#0;
          #10#7 = #24#38;
          #10#8 = #24#20;
          #10#9 = #24#35;
          #10#29 = #30#10;
          #10#30 = #30#2;
          #10#31 = #30#3;
          #10#32 = #24#156;
          #10#33 = #30#7;
          #10#34 = #25#7;
          #10#35 = #24#4;
          #10#36 = #24#47;
          |SI #13#12 = "S"; |Y nSwAlbaran = 0;
               #10#38 = #13#12;    ||facturado
               #10#39 = #134#0;
               #10#53 = #134#49;
               #10#60 = #134#1;
          |FINSI;
          #10#40 = #24#41;
          #10#51 = #13#12;    ||facturable
          #10#62 = #30#6;
          |SI #30#14 = "  ";
               #10#6 = #24#25;
          |SINO;
               #10#6 = #30#14;
          |FINSI;
          #10#63 = #24#15;
          #10#68 = #24#192;
          |ABRE #324;
          #324#0 = #10#68;
          |LEE 000#324=;
          |SI FSalida ! 0; |DDEFECTO #324; |FINSI;
          #10#69 = #324#2;
          #10#70 = #24#193;
          #10#73 = #321#9;
          #324#0 = #10#73;
          |LEE 000#324=;
          |SI FSalida ! 0; |DDEFECTO #324; |FINSI;
          |CIERRA #324;
          #10#74 = #324#2;
          #10#84 = #30#1;
          |HAZ LimCabAgifa010;
          |GRABA 020#10b;

          #13#14 = #10#52
          #13#15 = #10#0;
          |GRABA 020#13a;

          |SI #13#12 = "S"; |Y nSwAlbaran = 0;  ||facturable
               #59#14 = #134#49;
               #59#0 = #134#0;
               #59#1 = 1;
               #59#2 = #10#0;
               #59#15 = #10#52;
               |GRABA 020#59n;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO TmpFac;
     #13#0 = #1#1;
     #13#1 = #1#2;
     |LEE 121#13=;

     |SI #1#18 = "      "; #1#18 = "000000"; |FINSI;
     #2#1 = #1#18;
     #2#2 = #1#7;
     |LEE 020#2=;

     aAlfa = #2#0; |QBF aAlfa;
     |SI aAlfa ! aTipoFac; aCli = ""; |FINSI;

     aTipoFac = #2#0; |QBF aTipoFac;
     |SI aTipoFac = "EDIFICIO";
          |SI aCli = ""; |O aCli ! #1#18; |O nDir ! #1#7; |O aEdi ! #1#8;
               |HAZ FinFactu;
               aCli = #1#18;
               nDir = #1#7;
               aEdi = #1#8;

               aCliFac = #13#17;
               nDirFac = #13#6;
               fFecFac = #129#0;
               |ABRE #22;
               #22#0 = #13#17;
               #22#1 = #13#8;
               |LEE 000#22=;
               |SI FSalida ! 0; |HAZ AltaSerFac2; |FINSI;
               |CIERRA #22;
               aSerFac = #22#2; |QBF aSerFac;
               aSerAlb = #13#0; |QBF aSerAlb; aSerAlb = aSerAlb % 103;
               aSerAlb = aSerAlb + (fFecFac % -102);
               |SI aSerFac = "";
                    aSerFac = aSerAlb;
               |SINO;
                    aSerFac = aSerFac + (fFecFac % -102);
               |FINSI;
               |HAZ CabFac;
          |FINSI;
          |HAZ LineasFac;
     |FINSI;
     |SI aTipoFac = "PARTE";
          aCli = #1#18;

          aCliFac = #13#17;
          nDirFac = #13#6;
          fFecFac = #129#0;
          |ABRE #22;
          #22#0 = #13#17;
          #22#1 = #13#8;
          |LEE 000#22=;
          |SI FSalida ! 0; |HAZ AltaSerFac2; |FINSI;
          |CIERRA #22;
          aSerFac = #22#2; |QBF aSerFac;
          aSerAlb = #13#0; |QBF aSerAlb; aSerAlb = aSerAlb % 103;
          aSerAlb = aSerAlb + (fFecFac % -102);
          |SI aSerFac = "";
               aSerFac = aSerAlb;
          |SINO;
               aSerFac = aSerFac + (fFecFac % -102);
          |FINSI;
          |HAZ CabFac;
          |HAZ LineasFac;
     |FINSI;
     |SI aTipoFac = "INSTALACION";
          |SI aCli = ""; |O aCli ! #1#18; |O nDir ! #1#7;
               |HAZ FinFactu;
               aCli = #1#18;
               nDir = #1#7;
               aEdi = #1#8;

               aCliFac = #13#17;
               nDirFac = #13#6;
               fFecFac = #129#0;
               |ABRE #22;
               #22#0 = #13#17;
               #22#1 = #13#8;
               |LEE 000#22=;
               |SI FSalida ! 0; |HAZ AltaSerFac2; |FINSI;
               |CIERRA #22;
               aSerFac = #22#2; |QBF aSerFac;
               aSerAlb = #13#0; |QBF aSerAlb; aSerAlb = aSerAlb % 103;
               aSerAlb = aSerAlb + (fFecFac % -102);
               |SI aSerFac = "";
                    aSerFac = aSerAlb;
               |SINO;
                    aSerFac = aSerFac + (fFecFac % -102);
               |FINSI;
               |HAZ CabFac;
          |FINSI;
          |HAZ LineasFac;
     |FINSI;

     |LIBERA #13;
     |HAZ Actualiza;
|FPRC;

|DEFBUCLE TmpFac;
     #1#2;
     ;
     "*", "     ", "                    ", "      ", 000001;
     "*", "zzzzz", "zzzzzzzzzzzzzzzzzzzz", "zzzzzz", 999999;
     ;
     NULL, TmpFac;
|FIN;

|PROCESO Facturar;
     |HAZ CreaTempo; |NOME_DAT #100 Tempo; aTmp100 = Tempo; |DELINDEX #100;
     |HAZ CreaTempo; |NOME_DAT #500 Tempo; aTmp500 = Tempo; |DELINDEX #500;
     |ABRE #100;
     |ABRE #500;

     nSwFactura = 1;
     aCli = "";
     |ABRE #134;
     |ABRE #59;
     |ABRE #10;
     |ABRE #71;
     |BUCLE TmpFac;
     |HAZ FinFactu;
     |CIERRA #71;
     |CIERRA #10;
     |CIERRA #59;
     |CIERRA #134;
     nSwFactura = 0;

     eaFichero = aTmp500;
     |SUB_EJECUTA_NP "extz0034";        || Recalcula facturas

     |CONFI "0000S¨Imprimir certificado?";
     |SI FSalida = 0;
          eaFichero = aTmp100; |SUB_EJECUTA_NP "extz0011;TMP";
     |FINSI;

     |CONFI "0000S¨Imprimir facturas?";
     |SI FSalida = 0;
          eaDefImpre = "Crystal Reports";
          eaFichero = aTmp500;
          eaOrdenado = #142#141;
          |SUB_EJECUTA_NP "agifa136";
     |FINSI;

     |CIERRA #100; Tempo = aTmp100; |HAZ BoraTempo; |DELINDEX #100;
     |CIERRA #500; Tempo = aTmp500; |HAZ BoraTempo; |DELINDEX #500;
|FPRC;

|PROCESO FinFactu;
     |SI #13#12 = "S"; |Y nSwAlbaran = 0;  ||facturable
          |SI aCli ! "";
               #500#0 = #134#49;
               #500#1 = #134#0;
               |GRABA 020#500n;
               ||||HAZ CalCabAgifa134; || Peta el diagram, hago un sub_ejecuta
               |GRABA 020#134a;
               |LIBERA #10;
               |LIBERA #134;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO FactuParte;
     |HAZ CreaTempo; |NOME_DAT #100 Tempo; aTmp100 = Tempo; |DELINDEX #100;
     |HAZ CreaTempo; |NOME_DAT #500 Tempo; aTmp500 = Tempo; |DELINDEX #500;

     |SI nSwAlbaran = 0;
          aSerAlb = #126#0;
          aSerFac = #126#1;
          fFecFac = #126#2;
          nDirFac = #126#3;
          aCliFac = #126#4;
     |FINSI;

     |ABRE #500;
     |ABRE #100;
     |ABRE #134;
     |ABRE #59;
     |ABRE #10;
     |ABRE #71;
     |HAZ CabFac;
     |HAZ LineasArtParte;
     aCli = #134#2;
     |HAZ FinFactu;
     |CIERRA #71;
     |CIERRA #10;
     |CIERRA #59;
     |CIERRA #134;
     |CIERRA #500;

     |HAZ Actualiza;

     eaFichero = aTmp500;
     |SUB_EJECUTA_NP "extz0034";        || Recalcula facturas

     |CONFI "0000S¨Imprimir certificado?";
     |SI FSalida = 0;
         eaFichero = aTmp100; |SUB_EJECUTA_NP "extz0011;TMP";
     |FINSI;

     |CONFI "0000S¨Imprimir albar n?";
     |SI FSalida = 0;
          eaDefImpre = "Crystal Reports";
          abono = #10#43;
          ser_alb = #10#52;
          num_alb = #10#0
          eaMenuImpre = "N";
          |SUB_EJECUTA_NP "agifa014";
     |FINSI;

     |SI nSwAlbaran = 0;
          |CONFI "0000S¨Imprimir factura?";
          |SI FSalida = 0;
               eaDefImpre = "Crystal Reports";
               ser_fac = #134#49;
               num_fac = #134#0;
               reimp = #134#45;
               eaOrdenado = #142#141;
               |SUB_EJECUTA_NP "agifa136";
          |FINSI;
     |FINSI;

     |CIERRA #100; Tempo = aTmp100; |HAZ BoraTempo; |DELINDEX #100;
     |CIERRA #500; Tempo = aTmp500; |HAZ BoraTempo; |DELINDEX #500;
|FPRC;

|PROCESO Albaran;
     aSerAlb = #128#0;
     nDirFac = #128#1;
     aCliFac = #128#2;
     fFecFac = #128#3;
     nSwAlbaran = 1;     || no crea factura
     |HAZ FactuParte;
     nSwAlbaran = 0;
|FPRC;

|PROCESO BorLinFac;
     |BORRA 020#59a;
|FPRC;

|DEFBUCLE BorLinFac;
     #59#1;
     ;
     #134#49, #134#0, 001;
     #134#49, #134#0, 999;
     be;
     NULL, BorLinFac;
|FIN;

|PROCESO BorLinAlb;
     |HAZ AcumulaAV;
     |BORRA 020#71a;
|FPRC;

|DEFBUCLE BorLinAlb;
     #71#1;
     ;
     #10#52, #10#0, 001;
     #10#52, #10#0, 999;
     be;
     NULL, BorLinAlb;
|FIN;

|PROCESO LinReabre;
     #11#0 = #14#2;
     |LEE 121#11=;
     |SI FSalida = 0;
          #11#24 = "01.01.0000";
          |SI #11#25 = "A"; nNume = 1/1000000; |FINSI;
          |SI #11#25 = "S"; nNume = 1/1000 * 6; |FINSI;
          |SI #11#25 = "T"; nNume = 1/1000 * 3; |FINSI;
          |SI #11#25 = "M"; nNume = 1/1000 * 1; |FINSI;
          |SI #11#23 ! "01.01.0000";
               #11#27 = #11#23 + nNume;
          |FINSI;
          #11#24 = "01.01.0000";
          |SI #11#33 ! "01.01.0000";
               nNume = #11#35/1000000;
               #11#37 = #11#33 + nNume;
          |FINSI;
          #11#45 = #13#0;
          #11#46 = #13#1;
          |GRABA 020#11a;
          |LIBERA #11;
     |FINSI;
     #14#18 = "N";
     |GRABA 020#14a;
     |LIBERA #14;
|FPRC;

|DEFBUCLE LinReabre;
     #14#1;
     ;
     #13#0, #13#1, "                    ";
     #13#0, #13#1, "zzzzzzzzzzzzzzzzzzzz";
     be;
     NULL, LinReabre;
|FIN;

|PROCESO TmpReabre;
     #13#0 = #100#0;
     #13#1 = #100#1;
     |LEE 121#13=;
     |SI FSalida = 0;
          #13#9 = "A";
          |GRABA 020#13a;
          |LIBERA #13;
          |HAZ DesActualiza;

          enForma = -1;
          #10#52 = #13#14;
          #10#0 = #13#15;
          |LEE 101#10=;
          |SI FSalida = 0;
               #134#49 = #10#53;
               #134#0 = #10#39;
               |LEE 101#134=;
               |SI FSalida = 0;
                    |BUCLE BorLinFac;
                    |BORRA 020#134a;
                    |LIBERA #134;
               |FINSI;
               |BUCLE BorLinAlb;
               |BORRA 020#10a;
               |LIBERA #10;
          |FINSI;
          enForma = 0;
          |HAZ TraspasoSal;
          |BUCLE LinReabre;
     |FINSI;
|FPRC;

|DEFBUCLE TmpReabre;
     #100#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, TmpReabre;
|FIN;

|PROCESO ReabreParte;
     |SELECT #1#13;
     |ABRE #10;
     |ABRE #134;
     |ABRE #11;
     |BUCLE TmpReabre;
     |CIERRA #11;
     |CIERRA #134;
     |CIERRA #10;
|FPRC;

|PROCESO ActArticu;
     #11#0 = #14#2;
     |LEE 121#11=;
     |SI FSalida = 0;
          #11#23 = #14#14;    ||F Ult Rev = F Recog Cli
          #11#27 = #14#10;    ||F Prox Rev = F Prox Rev

          |SI #14#13 ! "01.01.0000"; ||F Prox Timb
               #11#33 = #14#14;    || F Ult Retim Parte = F Recog Cli
          |FINSI;

          |GRABA 020#11a;
          |LIBERA #11;
     |FINSI;
|FPRC;

|DEFBUCLE ActArticu;
     #14#1;
     ;
     #13#0, #13#1, "                    ";
     #13#0, #13#1, "zzzzzzzzzzzzzzzzzzzz";
     ;
     NULL, ActArticu;
|FIN;

|PROCESO Actualiza;
     |ABRE #11;
     |BUCLE ActArticu;
     |CIERRA #11;
|FPRC;

|PROCESO DesArticu;
     #11#0 = #14#2;
     |LEE 121#11=;
     |SI FSalida = 0;
          #11#23 = #14#8;
          #11#27 = #14#9;
          #11#33 = #14#11;
          #11#27 = #14#12;
          |GRABA 020#11a;
          |LIBERA #11;
     |FINSI;
|FPRC;

|DEFBUCLE DesArticu;
     #14#1;
     ;
     #13#0, #13#1, "                    ";
     #13#0, #13#1, "zzzzzzzzzzzzzzzzzzzz";
     ;
     NULL, DesArticu;
|FIN;

|PROCESO DesActualiza;
     |ABRE #11;
     |BUCLE DesArticu;
     |CIERRA #11;
|FPRC;


|PROCESO BajaAlbaran;
     |HAZ DesActualiza;

     |ABRE #10;
     |ABRE #11;
     enForma = -1;
     #10#52 = #13#14;
     #10#0 = #13#15;
     |LEE 121#10=;
     |SI FSalida = 0;
          |BUCLE BorLinAlb;
          |BORRA 020#10a;
          |LIBERA #10;
     |FINSI;
     enForma = 0;
     |HAZ TraspasoSal;
     |BUCLE LinReabre;
     |CIERRA #10;
     |CIERRA #11;
|FPRC;


//------- para el MANTE del extz0026 -------//
|PROCESO SerFac; |TIPO 6;
     |C_M #126#1, 0, aAlfa;
     |SI aAlfa = "S";
          fHoy = ~; aA¤o = fHoy % -102;
          aAlfa = #126#1; aAlfa = aAlfa % 103; |QBF aAlfa;
          aAlfa = aAlfa + aA¤o;
          #126#1 = aAlfa; |PINTA #126#1;
     |FINSI;
|FPRC;

|PROCESO SerAlb; |TIPO 6;
     fHoy = ~; aA¤o = fHoy % -102;
     aAlfa = #126#0; aAlfa = aAlfa % 103; |QBF aAlfa;
     aAlfa = aAlfa + aA¤o;
     #126#0 = aAlfa; |PINTA #126#0;
|FPRC;

|PROCESO MinFac30;
     #30#0 = #126#4;
     #30#1 = 0001;
|FPRC;

|PROCESO MaxFac30;
     #30#0 = #126#4;
     #30#1 = 9999;
|FPRC;

|PROCESO DirFac66; |TIPO 66;
     |ABRE #30;
     #30#0 = #126#4;
     #30#1 = #126#3;
     |LEE 000#30];
     |CONSULTA_F_CLAVE #1#30, MinFac30, MaxFac30;
     |SI FSalida = 0;
          #126#3 = #30#1; |PINTA #126#3;
     |SINO;
          |ERROR;
     |FINSI;
     |CIERRA #30;
|FPRC;

|PROCESO DirFac0; |TIPO 0;
     |ABRE #30;
     #30#0 = #126#4;
     #30#1 = #126#3;
     |LEE 000#30=;
     |SI FSalida ! 0;
          |MENAV "0000No existe la direcci¢n de factura...";
          |ERROR;
     |FINSI;
     |CIERRA #30;
|FPRC;
//------- para el MANTE del extz0028 -------//
|PROCESO SerAlb28; |TIPO 6;
     fHoy = ~; aA¤o = fHoy % -102;
     aAlfa = #128#0; aAlfa = aAlfa % 103; |QBF aAlfa;
     aAlfa = aAlfa + aA¤o;
     #128#0 = aAlfa; |PINTA #128#0;
|FPRC;

|PROCESO MinFac28_30;
     #30#0 = #128#2;
     #30#1 = 0001;
|FPRC;

|PROCESO MaxFac28_30;
     #30#0 = #128#2;
     #30#1 = 9999;
|FPRC;

|PROCESO DirFac28_66; |TIPO 66;
     |ABRE #30;
     #30#0 = #128#2;
     #30#1 = #128#1;
     |LEE 000#30];
     |CONSULTA_F_CLAVE #1#30, MinFac28_30, MaxFac28_30;
     |SI FSalida = 0;
          #128#1 = #30#1; |PINTA #128#1;
     |SINO;
          |ERROR;
     |FINSI;
     |CIERRA #30;
|FPRC;

|PROCESO DirFac28_0; |TIPO 0;
     |ABRE #30;
     #30#0 = #128#2;
     #30#1 = #128#1;
     |LEE 000#30=;
     |SI FSalida ! 0;
          |MENAV "0000No existe la direcci¢n de instalaci¢n...";
          |ERROR;
     |FINSI;
     |CIERRA #30;
|FPRC;
//-------------//

|PROCESO AltaSerFac2;
     |PARA; |SI; |HACIENDO;
          |HAZ AltaSerFac;
          |LEE 000#22=;
          |SI FSalida = 0; |ACABA; |FINSI;
     |SIGUE;
|FPRC;

|PROCESO AltaSerFac;
     |VENTANA 0501, 3099, -1, 17, "Series facturaci¢n clientes/sistemas";
     |HAZ PushVenModal;

     |PINPA #0#22;
     |PINDA #0#22;
     |ENDATOS #1#22;
     |SI FSalida = 0; |GRABA 020#22n; |FINSI;

     |HAZ PopVenModal;
|FPRC;
