|| -----------------------------------------------------------------------||
|| diefaz16.cal                                        [dscomer9-001172]  ||
||                                                                        ||
|| Programa de volcado de datos sobre excel, segun plantillas.            ||
|| Las plantillas estan en el servidor.                                   ||
||                                                                        ||
||                                                                        ||
|| Ini: 22jun2006                                                         ||
|| Ult: 23jun2006                                           dsPRODUCCION  ||
|| -----------------------------------------------------------------------||
|FICHEROS;
     diefaz16       #00;      || este def
     diefa016       #10;      || las tablas
     diefaw20       #99,MANTE;      || TMP de las tablas

     :/dscomer9/def/agifa041  #101;          || acceso dscomer9
     :/agicont/def/canempre   #102;          || acceso star III
     :/dscarter/def/dscam005  #103;          || acceso cartera

     :/agicont/def/cacuenta   #200;

     :/dscomer9/def/agifa019  #201;
     :/dscomer9/def/agifa023  #202;
     :/dscomer9/def/agifa024  #203;
     :/dscomer9/def/agifa060  #204;
     :/dscomer9/def/agifa065  #205;
     :/dscomer9/def/agifa091  #206;
     :/dscomer9/def/agifa112  #207;
     :/dscomer9/def/agifa120  #208;
     :/dscomer9/def/agifa177  #209;
     :/dscomer9/def/agitp001  #210;


     :/dscarter/def/dscam014  #250;
     :/dscarter/def/dscam023  #251;


|FIN;

|VARIABLES;
     aDLL       = "agixl97.dll";
     aComillas  = "";

     aDBASS     = "";
     aPathTMP   = "C:\tmp\";
     aPathLocal = "";
     aPathXLS   = "";
     aPathCome  = "";
     aPathCont  = "";
     aPathCart  = "";

     aCol       = "";
     aDato      = "";
     aCelda     = "";
     nFila      = 0;
     nFILAINI   = 5;

     naux    = 0;
     naux2   = 0;
     aAlfa   = "";
     aAlfa2  = "";
     swError = 0;
|FIN;

/*
PENDIENTE ....
  - no funciona lo de dscarte4 (el nombre)


*/




|PROCESO Tipo80; |TIPO 80;
     |DBASS aDBASS; |QBF aDBASS;

     aAlfa = aDBASS + "dscomer9/fich/";
     |PATH_DAT #101 aAlfa;

     aAlfa = aDBASS + "dscarter/fich/";
     |PATH_DAT #103 aAlfa;

     aComillas = &34;
|FPRC;




|| -------------------------------------------------- entlineal
|| ACTIVANDO y desactivando el '*'
|RUTINA LInf;
     #99#00 = 0;
|FRUT;
|RUTINA LSup;
     #99#00 = 9999999;
|FRUT;

|PROCESO TecFunc;
     |SI FSalida ! 13; |ACABA; |FINSI;  || F5;

     |SI #99#02 = "*";
          #99#02 = "";
     |SINO;
          #99#02 = "*";
     |FINSI;
     |PINTA #99#02; |PTEC 809;
     |GRABA 040#99.a;
|FPRC;







|| -----------------------------------------------------------------
|PROCESO CargaTMP;
     |SALVA_DATOS #10;
     |REPON_DATOS #99;
     |GRABA 000#99.n;
|FPRC;
|DEFBUCLE _CargaTMP;
  #10#1;
  ;
  INICIO;
  FINAL;
  ;
  NULL, CargaTMP;
|FIN;
|| -----------------------------------------------------------------


|| -----------------------------------------------------------------
|PROCESO Exporta99;
     swError = 0;
     |HAZ TraePlantilla;
     |SI swError ! 0;
          aAlfa = "0000ERROR ["+ swError + "] en " + #99#00 + ".xls";
          |MENAV aAlfa;
          |ACABA;
     |FINSI;

     |SI #99#00 =  15; |HAZ Excel_15;  |FINSI;
||   |SI #99#00 =  18; |HAZ Excel_18;  |FINSI;
     |SI #99#00 =  19; |HAZ Excel_19;  |FINSI;
||   |SI #99#00 =  23; |HAZ Excel_23;  |FINSI;
     |SI #99#00 =  24; |HAZ Excel_24;  |FINSI;
||   |SI #99#00 =  27; |HAZ Excel_27;  |FINSI;
||   |SI #99#00 =  81; |HAZ Excel_81;  |FINSI;
     |SI #99#00 =  83; |HAZ Excel_83;  |FINSI;
     |SI #99#00 =  99; |HAZ Excel_99;  |FINSI;
     |SI #99#00 = 224; |HAZ Excel_224; |FINSI;
||   |SI #99#00 = 225; |HAZ Excel_225; |FINSI;
     |SI #99#00 = 270; |HAZ Excel_270; |FINSI;
     |SI #99#00 = 287; |HAZ Excel_287; |FINSI;
     |SI #99#00 = 288; |HAZ Excel_288; |FINSI;
     |SI #99#00 = 5722; |HAZ Excel_5722; |FINSI;
     |SI #99#00 = 5723; |HAZ Excel_5723; |FINSI;
||   |SI #99#00 = 7002; |HAZ Excel_7002; |FINSI;
||   |SI #99#00 = 7004; |HAZ Excel_7004; |FINSI;
||   |SI #99#00 = 7012; |HAZ Excel_7012; |FINSI;
||   |SI #99#00 = 7014; |HAZ Excel_7014; |FINSI;
||   |SI #99#00 = 10701; |HAZ Excel_10701; |FINSI;
||   |SI #99#00 = 10702; |HAZ Excel_10702; |FINSI;
||   |SI #99#00 = 50050; |HAZ Excel_50050; |FINSI;
||   |SI #99#00 = 7000014; |HAZ Excel_7000014; |FINSI;
||   |SI #99#00 = 7000015; |HAZ Excel_7000015; |FINSI;

|FPRC;

|DEFBUCLE _Exporta99;
  #99#1;
  2;
  0000000, "*";
  9999999, "*";
  ;
  NULL, Exporta99;
|FIN;
|| -----------------------------------------------------------------







|PROCESO Tipo3; |TIPO 3;

     || volcado de datos.
     |ABRE #99; |CIERRA #99; |DELINDEX #99;

     |ABRE   #99;
     |BUCLE _CargaTMP;
     |CIERRA #99;

     |ENTLINEAL #1#99, 1, 4, 22, 1, LInf, LSup;
     |CONFI "0000SProcedemos a la exportacion:";
     |SI FSalida = 0;

          || CARGAMOS la dll de excel
          |CARGADLL aDLL; ||Cargamos la dll
          |SI FSalida < 0;
               |MENAV "0000No se puede usar agixl97.dll";
               |ABRE #99; |CIERRA #99; |DELINDEX #99;
               |ACABA;
          |FINSI;

          aAlfa = #00#08; |QBF aAlfa;
          aPathLocal = aAlfa;
          |RMKDIR aPathLocal;
          |RMKDIR aPathTMP;

          aAlfa = #00#07; |QBF aAlfa;
          aPathXLS = aDBASS + aAlfa;

          aAlfa = ("00000" + #00#00) % -105;
          aPathCome  = aDBASS + "dscomer9/fich/" + aAlfa + "/";

          aAlfa = (("00000" + #00#02) % -105) + #00#03;
          aPathCont  = aDBASS + "agicont/fich/" + aAlfa + "/";

          aAlfa = ("00000" + #00#05) % -105;
          aPathCart  = aDBASS + "dscarter/fich/" + aAlfa + "/";

          || Y cada uno de los ficheros, ya les ponemos el path.
          |PATH_DAT #cacuenta#aPathCont#;

          |PATH_DAT #agifa019#aPathCome#;
          |PATH_DAT #agifa023#aPathCome#;
          |PATH_DAT #agifa024#aPathCome#;
          |PATH_DAT #agifa060#aPathCome#;
          |PATH_DAT #agifa065#aPathCome#;
          |PATH_DAT #agifa091#aPathCome#;
          |PATH_DAT #agifa112#aPathCome#;
          |PATH_DAT #agifa120#aPathCome#;
          |PATH_DAT #agifa177#aPathCome#;
          |PATH_DAT #agitp001#aPathCome#;

          |PATH_DAT #dscam014#aPathCart#;
          |PATH_DAT #dscam023#aPathCart#;

          || por cada cosa que esta marcada ...LA EXPORTACION EN SI MISMA
          |BUCLE _Exporta99;

          |DESCARGADLL aDLL;

     |FINSI;

     |ABRE #99; |CIERRA #99; |DELINDEX #99;

|FPRC;








|| --------------------------------------------------------------
|| procesos de exportacion
|| despacito y por orden ....
|| --------------------------------------------------------------
|PROCESO TraePlantilla;
     |SI #00#09 = "N";        || modo sobreescribir = NO
          aAlfa = aPathLocal + #99#00 + ".xls";
          |XABRE "CE", aAlfa, 0;
          |SI FSalida ] 0;
               aAlfa = "0000NDesea sobreescribir el fichero " + #99#00 + ".xls";
               |CONFI aAlfa;
               |SI FSalida ! 0;
                    swError = 1;
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     || COPIANDO el fichero en local.
     aAlfa  = aPathXLS + #99#00 + ".xls";
     aAlfa2 = aPathTMP + #99#00 + ".xls";
     |ENVIA_FICHERO aAlfa, aAlfa2;
     |SI FSalida ! 0;
          swError = 2;
     |FINSI;

|FPRC;






|| ---------------------------------- como se repite tanto ...
|PROCESO AbreXLS;
     aAlfa = "0000" + #99#01;
     |MENSA aAlfa;

     aAlfa = aPathTMP + #99#00 + ".xls";
     |ALFACALLDLL aDLL, "carga_book", aAlfa;

     aAlfa = #99#00;
     |ALFACALLDLL aDLL, "selecciona_hoja", aAlfa;

     nFila = nFILAINI;
|FPRC;

|PROCESO insCelda;
     aCelda = aCol + nFila + "," + aDato;
     |ALFACALLDLL aDLL, "poke_dato", aCelda;
|FPRC;

|PROCESO CierraXLS;
     aAlfa = aPathLocal + #99#00+ ".xls";
     |ALFACALLDLL aDLL, "fichero_destino", aAlfa;
     |ALFACALLDLL aDLL, "fin_book", "salva";
|FPRC;
|| ----------------------------------
















|| ------------------------------------------------------------------------
|| cacuenta
|PROCESO Excel_15;


     |HAZ AbreXLS;

     |ABRE #cacuenta;

     |LEE 000#cacuenta.p;
     |PARA; |SI FSalida = 0; |HACIENDO;

          aCol  = "A";
          aDato = #cacuenta#00;
          |HAZ insCelda;

          aCol  = "B";
          aDato = #cacuenta#02;
          |HAZ insCelda;

          aCol  = "C";
          |SI #cacuenta#03 = "S";
               aDato = "0";
          |SINO;
               aDato = "1";
          |FINSI;
          |HAZ insCelda;

          nFila = nFila + 1;

          |LEE 000#cacuenta.s;
     |SIGUE;
     |CIERRA #cacuenta;

     |HAZ CierraXLS;
|FPRC;






|| ------------------------------------------------------------------------
|| agifa024 - dto. fra cliente
|PROCESO Excel_19;

     |HAZ AbreXLS;

     |ABRE #agifa024;

     |LEE 000#agifa024.p;
     |PARA; |SI FSalida = 0; |HACIENDO;

          |SI #agifa024#37 ! 0;
               aCol  = "A";
               aDato = #agifa024#00;
               |HAZ insCelda;

               aCol  = "D";
               aDato = #agifa024#37;
               |HAZ insCelda;

               nFila = nFila + 1;
          |FINSI;
          |SI #agifa024#38 ! 0;
               aCol  = "A";
               aDato = #agifa024#00;
               |HAZ insCelda;

               aCol  = "D";
               aDato = #agifa024#38;
               |HAZ insCelda;

               nFila = nFila + 1;
          |FINSI;
          |SI #agifa024#156 ! 0;
               aCol  = "A";
               aDato = #agifa024#00;
               |HAZ insCelda;

               aCol  = "D";
               aDato = #agifa024#156;
               |HAZ insCelda;

               nFila = nFila + 1;
          |FINSI;

          |LEE 000#agifa024.s;
     |SIGUE;
     |CIERRA #agifa024;
     |HAZ CierraXLS;
|FPRC;








|| ------------------------------------------------------------------------
|| agifa112 - dto. fra proveedor
|PROCESO Excel_24;

     |HAZ AbreXLS;

     |ABRE #agifa112;

     |LEE 000#agifa112.p;
     |PARA; |SI FSalida = 0; |HACIENDO;

          |SI #agifa112#24 ! 0;
               aCol  = "A";
               aDato = #agifa112#00;
               |HAZ insCelda;

               aCol  = "D";
               aDato = #agifa112#24;
               |HAZ insCelda;

               nFila = nFila + 1;
          |FINSI;
          |SI #agifa112#25 ! 0;
               aCol  = "A";
               aDato = #agifa112#00;
               |HAZ insCelda;

               aCol  = "D";
               aDato = #agifa112#25;
               |HAZ insCelda;

               nFila = nFila + 1;
          |FINSI;
          |SI #agifa112#41  ! 0;
               aCol  = "A";
               aDato = #agifa112#00;
               |HAZ insCelda;

               aCol  = "D";
               aDato = #agifa112#41;
               |HAZ insCelda;

               nFila = nFila + 1;
          |FINSI;

          |LEE 000#agifa112.s;
     |SIGUE;
     |CIERRA #agifa112;
     |HAZ CierraXLS;
|FPRC;





|| ------------------------------------------------------------------------
|| agifa019 - Lin diario producto
|PROCESO Excel_83;

     |HAZ AbreXLS;

     |ABRE #agifa019;

     |LEE 000#agifa019.p;
     |PARA; |SI FSalida = 0; |HACIENDO;

          aCol  = "D";
          aDato = #agifa019#00;
          |HAZ insCelda;

          aCol  = "F";
          aDato = 1;
          |HAZ insCelda;

          aCol  = "I";
          aDato = #agifa019#06;
          |HAZ insCelda;

          aCol  = "J";
          aDato = #agifa019#05;
          |HAZ insCelda;

          aCol  = "K";
          aDato = #agifa019#09;
          |HAZ insCelda;

          nFila = nFila + 1;

         |LEE 000#agifa019.s;
     |SIGUE;
     |CIERRA #agifa019;
     |HAZ CierraXLS;
|FPRC;





|| ------------------------------------------------------------------------
|| agifa019 - tarifa compra
|PROCESO Excel_99;

     |HAZ AbreXLS;

     |ABRE #agifa019;

     |LEE 000#agifa019.p;
     |PARA; |SI FSalida = 0; |HACIENDO;

          aAlfa = #agifa019#134; |QBF aAlfa;
          naux = (A\ aAlfa % 0 );
          |SI naux = 0;
               |VETE FinBucle;
          |FINSI;

          aCol  = "A";
          aDato = #agifa019#27;
          |HAZ insCelda;

          aCol  = "B";
          aDato = #agifa019#00;
          |HAZ insCelda;

          aCol  = "D";
          aDato = #agifa019#134;
          |HAZ insCelda;

          nFila = nFila + 1;

     |ET FinBucle;

         |LEE 000#agifa019.s;
     |SIGUE;
     |CIERRA #agifa019;
     |HAZ CierraXLS;
|FPRC;






|| ------------------------------------------------------------------------
|| agifa112  - direccion pedido proveedor
|PROCESO Excel_224;

     |HAZ AbreXLS;

     |ABRE #agifa112;

     |LEE 000#agifa112.p;
     |PARA; |SI FSalida = 0; |HACIENDO;

          aCol  = "A";
          aDato = #agifa112#00;
          |HAZ insCelda;

          aCol  = "B";
          aDato = 1;
          |HAZ insCelda;

          aCol  = "C";
          aDato = #agifa112#01;
          |HAZ insCelda;

          aCol  = "D";
          aDato = #agifa112#02;
          |HAZ insCelda;

          aCol  = "E";
          aDato = #agifa112#03;
          |HAZ insCelda;

          aCol  = "G";
          aDato = #agifa112#04;
          |HAZ insCelda;

          aCol  = "I";
          aDato = #agifa112#06;
          |HAZ insCelda;

          aCol  = "M";
          aDato = #agifa112#07;
          |HAZ insCelda;

          aCol  = "O";
          aDato = #agifa112#76;
          |HAZ insCelda;

          nFila = nFila + 1;

          |LEE 000#agifa112.s;
     |SIGUE;
     |CIERRA #agifa112;
     |HAZ CierraXLS;
|FPRC;







|| ------------------------------------------------------------------------
|| dscam014  - bancos
|PROCESO Excel_270;

     |HAZ AbreXLS;

     |ABRE #dscam014;

     |LEE 000#dscam014.p;
     |PARA; |SI FSalida = 0; |HACIENDO;

          aCol  = "A";
          aDato = #dscam014#00;
          |HAZ insCelda;

          aCol  = "B";
          aDato = #dscam014#01;
          |HAZ insCelda;

          aCol  = "I";
          aDato = #dscam014#07;
          |HAZ insCelda;

          aCol  = "R";
          aDato = #dscam014#10;
          |HAZ insCelda;

          aCol  = "AO";
          aDato = #dscam014#34;
          |HAZ insCelda;

          aCol  = "AP";
          aDato = #dscam014#35;
          |HAZ insCelda;

          aCol  = "AQ";
          aDato = #dscam014#36;
          |HAZ insCelda;

          aCol  = "AR";
          aDato = #dscam014#37;
          |HAZ insCelda;

          nFila = nFila + 1;
          |LEE 000#dscam014.s;

     |SIGUE;
     |CIERRA #dscam014;
     |HAZ CierraXLS;
|FPRC;







|| ------------------------------------------------------------------------
|| agifa024 - bancos cliente
|PROCESO Excel_287;

     |HAZ AbreXLS;

     |ABRE #agifa024;

     |LEE 000#agifa024.p;
     |PARA; |SI FSalida = 0; |HACIENDO;

          aAlfa = #agifa024#32; |QBF aAlfa;
          naux  = (A\ aAlfa % 0 );
          naux2 = #agifa024#32;
          |SI naux = 0; |O naux2 =0;
               |VETE FinBucle2;
          |FINSI;

           aCol  = "A";
           aDato = #agifa024#00;
           |HAZ insCelda;

           aCol  = "B";
           aDato = #agifa024#32+#agifa024#33;
           |HAZ insCelda;

           aCol  = "Y";
           aDato = #agifa024#32;
           |HAZ insCelda;

           aCol  = "Z";
           aDato = #agifa024#33;
           |HAZ insCelda;

           aCol  = "AA";
           aDato = #agifa024#31;
           |HAZ insCelda;

           aCol  = "AB";
           aDato = #agifa024#30;
           |HAZ insCelda;

           nFila = nFila + 1;

     |ET FinBucle2;
          |LEE 000#agifa024.s;
     |SIGUE;
     |CIERRA #agifa024;
     |HAZ CierraXLS;
|FPRC;






|| ------------------------------------------------------------------------
|| agifa112 - bancos porveedor
|PROCESO Excel_288;

     |HAZ AbreXLS;

     |ABRE #agifa112;

     |LEE 000#agifa112.p;
     |PARA; |SI FSalida = 0; |HACIENDO;

          aAlfa = #agifa112#14; |QBF aAlfa;
          naux  = (A\ aAlfa % 0 );
          naux2 = #agifa112#14;

          |SI naux = 0; |O naux2 = 0;
               |VETE FinBucle3;
          |FINSI;

           aCol  = "A";
           aDato = #agifa112#00;
           |HAZ insCelda;

           aCol  = "B";
           aDato = #agifa112#14+#agifa112#15;
           |HAZ insCelda;

           aCol  = "Y";
           aDato = #agifa112#14;
           |HAZ insCelda;

           aCol  = "Z";
           aDato = #agifa112#15;
           |HAZ insCelda;

           aCol  = "AA";
           aDato = #agifa112#13;
           |HAZ insCelda;

           aCol  = "AB";
           aDato = #agifa112#12;
           |HAZ insCelda;

           nFila = nFila + 1;

     |ET FinBucle3;
          |LEE 000#agifa112.s;
     |SIGUE;
     |CIERRA #agifa112;
     |HAZ CierraXLS;
|FPRC;






|| ------------------------------------------------------------------------
|| agifa060 - categoria producto
|PROCESO Excel_5722;

     |HAZ AbreXLS;

     |ABRE #agifa060;

     |LEE 000#agifa060.p;
     |PARA; |SI FSalida = 0; |HACIENDO;

           aCol  = "A";
           aDato = #agifa060#00;
           |HAZ insCelda;

           aCol  = "B";
           aDato = #agifa060#01;
           |HAZ insCelda;

           nFila = nFila + 1;

          |LEE 000#agifa060.s;
     |SIGUE;
     |CIERRA #agifa060;
     |HAZ CierraXLS;
|FPRC;







|| ------------------------------------------------------------------------
|| agifa120 - grupo producto
|PROCESO Excel_5723;

     |HAZ AbreXLS;

     |ABRE #agifa120;

     |LEE 000#agifa120.p;
     |PARA; |SI FSalida = 0; |HACIENDO;

           aCol  = "A";
           aDato = #agifa120#00;
           |HAZ insCelda;

           aCol  = "C";
           aDato = #agifa120#01;
           |HAZ insCelda;

           nFila = nFila + 1;

          |LEE 000#agifa120.s;
     |SIGUE;
     |CIERRA #agifa120;
     |HAZ CierraXLS;
|FPRC;
