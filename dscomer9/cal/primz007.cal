|FICHEROS;
     primz007 #0;
     prim0003 #3;
     prim0005 #5;
     primw006 #6;
     agifa007 #7;
     agifa010 #10;
     agifa019 #19;
     dsm00020 #20;
     agifa024 #24;
     agifa071 #71;
     agifa073 #73;
     agifa104 #104;
||     prim0006 #106;
     tempo134 #134; ||Tmp albaranes creados
     agifa142 #142;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     aEstaPdte = "";
     nNumPed = 0;
     aSerPed = "";
     nSal = 0;
     nCalc = 0;
     nPdte = 0;
     nLinPedi = 0;
     nLinAlba = 0;
     nNume = 0;
     nLin = 0;
     aSerie = "";
     &eaMenuImpre = "";
     &ser_alb = "";
     &num_alb = 0;
     &eaImpresora = "";
     &eaTag = "";
     &enSigno = 0;
     &enSwMenu = 0;
     &nImpo = 0;
     nForma = 0;
     fmes = "";
     mes = 0;
     aSer = "";
     nNum = 0;
     &Tempo = "";
     aTmp134 = "";
     aTmp6 = "";
     nConta = 0;
     nHandle = 0;
     aPath = "";
     aPathOrg = "";
     aFic = "";
     aTipo = "";
     aAlfa = "";
     aDato = "";
     nCampo    = 0;
     aLon      = "";
     i         = 0;
     nPos      = 0;
     aLetra    = "";
     aReg      = "";
     aTab      = "";
 {99}Valor     = "";
     aSerAnt = "";
     nNumAnt = 0;
|FIN;

|PROCESO MiraPdte;
     |SI #73#5 ] 0;
          nPdte = #73#5 - #73#43;
     |SINO;
          nPdte = -#73#5 + #73#43;
     |FINSI;
     |SI nPdte > 0; |ERROR10; |FINSI;
|FPRC;

|PROCESO CheqPdte;
     nPdte = 0;
     #104#25 = #6#0;
     #104#0 = #6#1;
     |LEE 000#104=;
     |SI FSalida = 0;
          |BUCLELIN 2 MiraPdte #104;
     |FINSI;
     |SI nPdte [ 0;
          |BORRA 020#6a;
          |SI aSerAnt ! #6#0; |O nNumAnt ! #6#1;
               aAlfa = "0000Pedido sin unidades pendientes: " + #6#0 + "/" + (("000000" + #6#1)%-106);
               |MENAV aAlfa;
          |FINSI;
          aSerAnt = #6#0; nNumAnt = #6#1;
     |FINSI;
|FPRC;

|DEFBUCLE CheqPdte;
     #6#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, CheqPdte;
|FIN;

|PROCESO RiesgoPed;
     enTiva = #73#14;
     efFiva = #104#1;
     |HAZ SacaIVA;
     nCalc = #73#11 % enIva;
     |SI #agifa024#47 = "S";
          nCalc = nCalc + (#73#11 % enRec);
     |FINSI;
     nImpo = #73#11 + nCalc;
|FPRC;

|PROCESO QuitaRieLin;
     |HAZ RiesgoPed;
     enSigno = 1;
     eaTag = "PAU"; |HAZ Riesgos;
|FPRC;

|PROCESO QuitaRie;
     |SI aSerPed ! #6#0; |O nNumPed ! #6#1;
          aSerPed = #6#0;
          nNumPed = #6#1;
          #104#25 = #6#0;
          #104#0 = #6#1;
          |LEE 000#104=;
          |SI FSalida = 0;
               |BUCLELIN 2 QuitaRieLin #104;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO PonRieLin_CheqAdj;
     |HAZ RiesgoPed;
     enSigno = -1;
     eaTag = "PAU"; |HAZ Riesgos;


     |SI #73#5 ] 0;
          nPdte = #73#5 - #73#43;
     |SINO;
          nPdte = -#73#5 + #73#43;
     |FINSI;
     |SI nPdte > 0; aEstaPdte = "S"; |FINSI;
|FPRC;

|PROCESO PonRie_CheqAdj;
     |SI aSerPed ! #6#0; |O nNumPed ! #6#1;
          aSerPed = #6#0;
          nNumPed = #6#1;
          #104#25 = #6#0;
          #104#0 = #6#1;
          |LEE 000#104=;
          |SI FSalida = 0;
               aEstaPdte = "N";
               |BUCLELIN 2 PonRieLin_CheqAdj #104;
/*
               |SI aEstaPdte = "S";
                    #106#0 = #6#0;
                    #106#1 = #6#1;
                    |BORRA 000#106c;
               |FINSI;
*/
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE QuitaRie;
     #6#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, QuitaRie;
|FIN;

|DEFBUCLE PonRie_CheqAdj;
     #6#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, PonRie_CheqAdj;
|FIN;
-----------------------------

|PROCESO ActPrimicia;
     |ABRE #24;
     |HAZ ActualizaCliente;
     |CIERRA #24;
     #10#41 = #10#41 + 1;
|FPRC;

|PROCESO CargaLinPed;
     |ABRE #19;
     #19#0 = #73#2;
     |LEE 000#19=;
     |CIERRA #19;

     |SI #73#5 < 0; || Las negativas no se exportan al pda
          nPdte = -#73#5 + #73#43;
          |SI nPdte [ 0; |ACABA; |FINSI;
          nPdte = -nPdte;
     |SINO;
          aAlfa = #19#111; |QBF aAlfa;
          |SI aAlfa ! ""; |ACABA; |FINSI;

          nPdte = #73#5 - #73#43;
          |SI nPdte [ 0; |Y #73#5 ! 0; |ACABA; |FINSI;
     |FINSI;

     nLin = nLin + 1;
     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = nLin;
     #71#2 = #73#2;
     #71#3 = #73#3;
     #71#4 = #73#4;
     #71#5 = nPdte;
     #71#6 = #73#6;
     #71#8 = #73#8;
     #71#10 = #73#10;
     #71#11 = #73#14;
     #71#12 = #73#0;
     #71#13 = #73#18;
     #71#15 = #10#3;
     #71#16 = #73#17;
     #71#17 = #73#19;
     #71#21 = #73#1;
     #71#27 = #73#27;
     #71#31 = #73#28;
     #71#33 = #73#29;
     #71#34 = #73#35;
     #71#35 = #73#36;
     #71#36 = #73#38;
     #71#49 = #73#45;
     nForma = 1;
     |HAZ ActPrimicia;
     #71#14 = #71#5 * #19#9;     || Precio de coste medio.
     |HAZ TotalLin71;
     |GRABA 020#71n;

     enForma = 1;
     enUnidPend = #71#5;
     eaReservado = #73#22;
     eaDesprecia = "N";
     eaProgVta = "agifa210";
     |HAZ AcumulaAV;

     #73#43 = #73#43 + #71#5;  || Servidas
     |GRABA 020#73a;
     |LIBERA #73;
|FPRC;

|DEFBUCLE CargaLinPed;
     #73#1;
     ;
     aSerie, nNume, 001;
     aSerie, nNume, 999;
     be;
     NULL, CargaLinPed;
|FIN;

|PROCESO TmpAlba;
     #10#52 = #134#0;
     #10#0 = #134#1;
     |LEE 121#10=;
     |SI FSalida = 0;
          #71#29 = #134#0;
          #71#0 = #134#1;
          #71#1 = 999;
          |LEE 000#71];
          |SI FSalida = 0;
               |LEE 000#71a;
          |SINO;
               |LEE 000#71u;
          |FINSI;
          nLin = #71#1;
          aSerie = #71#31;
          nNume = #71#12;
          |BUCLE CargaLinPed;
          |HAZ LimCabAgifa010;
          |BUCLELIN 0 CalCabAgifa010 #10;
          |GRABA 020#10a;
          |LIBERA #10;

          |DDEFECTO #104;
          #104#25 = aSerie;
          #104#0 = nNume;
          |LEE 121#104=;
          |SI FSalida = 0;
               |HAZ CalCabAgifa104;
               |LIBERA #104;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE TmpAlba;
     #134#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, TmpAlba;
|FIN;

|PROCESO Impre;
     ser_alb = #134#0;
     num_alb = #134#1;
     eaMenuImpre = "N";
     |SUB_EJECUTA_NP "agifa014";
|FPRC;

|DEFBUCLE Impre;
     #134#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Impre;
|FIN;

|PROCESO actpf;
     eaTag = "AV";  |HAZ Riesgos;
|FPRC;

|PROCESO ActualizaCliente;
     |ABRE #19;
     #19#0 = #71#2;
     |LEE 020#19=;
     |CIERRA #19;

     #24#0 = #71#15;
     |LEE 121#24=;
     |SI 0 = FSalida;
          |SI #19#194 = 2;
               nImpo = (((((#71#48 * #71#6) < #71#8) < #71#33) < #71#5) < #71#32);
          |SINO;
               nImpo = (((((#71#5 * #71#6) < #71#8) < #71#33) < #71#5) < #71#32);
          |FINSI;
          |SI #142#115 = "S";
               nImpo = nImpo < #71#7;
          |FINSI;
          nImpo = nImpo * nForma;
          fmes = #10#1 % A402;
          mes = fmes - 1;
          mes = mes * 3;
          mes = mes + 114;
          |SI #10#43 = "S";
               #24mes  = #24mes   - nImpo;     || ABONO.
               #24#150 = #24#150  - nImpo;
          |SINO;
               #24mes  = #24mes   + nImpo;     || VENTA.
               #24#150 = #24#150  + nImpo;
          |FINSI;
          |GRABA 020#24a;

          |SI #10#43 = "S"; nImpo = -nImpo; |FINSI;
          eaCliente = #agifa104#4;
          efFecha = #agifa104#1;
          enImpCliPed = nImpo;
          |HAZ AcumulaCli;
     |FINSI;
|FPRC;

|PROCESO LinAlba;
     nLinAlba = nLinAlba + 1;
     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = nLinAlba; || #6#2;
     #71#2 = #6#3;
     #71#3 = #73#3;
     #71#4 = #6#4;
     #71#5 = #6#6;
     #71#6 = #73#6;
     #71#8 = #73#8;
     #71#10 = #73#10;
     #71#11 = #73#14;
     #71#12 = #6#1;
     #71#13 = #73#18;
     #71#15 = #10#3;
     #71#16 = #10#34;
     #71#17 = #10#35;
     #71#27 = #73#27;
     #71#21 = #73#1;
     #71#31 = #6#0;
     #71#33 = #73#29;
     #71#34 = #73#35;
     #71#35 = #73#36;
     #71#36 = #73#38;
     #71#38 = #73#40;
     #71#49 = #6#5;
     |HAZ ActPrimicia;
     #71#14 = #71#5 * #19#9;     || Precio de coste medio.
     |HAZ TotalLin71;
     |GRABA 020#71n;

     enForma = 1;
     enUnidPend = #71#5;
     eaReservado = #73#22;
     eaDesprecia = "N";
     eaProgVta = "agifa210";
     |HAZ AcumulaAV;

     |HAZ CalCabAgifa010;
     |GRABA 020#10a;
/*******************************/
     |DDEFECTO #3;
     #3#10 = #71#29;
     #3#11 = #71#0;
     #3#0 = #71#1;
     #3#2 = #71#5;
     #3#3 = #71#4;
     #3#4 = #71#3;
     #3#5 = #71#49;
     #3#7 = #6#0;
     #3#8 = #6#1;
     #3#9 = #71#2;
     #3#12 = #71#6;
     #3#13 = #71#8;
     #3#14 = #71#10;
     #3#15 = #71#11;
     #3#16 = #71#13;
     #3#17 = #71#16;
     #3#18 = #71#17;
     #3#19 = #71#27;
     #3#20 = #71#33;
     #3#21 = #71#34;
     #3#22 = #71#35;
     #3#23 = #71#36;
     #3#24 = nLinAlba; || #6#2;
     |GRABA 020#3n;
|FPRC;

|PROCESO CabAlba;
     nLinAlba = 0;

     #10#52 = aSer;
     enSwMenu = 1;
     |HAZ ContaAV7;

     |DDEFECTO #7;
     #7#26 = aSer;
     |LEE 000#7=;

     |DDEFECTO #20;
     #20#0 = #104#60;
     |LEE 000#20=;

     |DDEFECTO #24;
     #24#0 = #104#4;
     |LEE 000#24=;

     #10#1 = ~;
     #10#3 = #104#4;
     #10#4 = #104#8;
     #10#5 = #104#5;
     #10#6 = #104#7;
     #10#7 = #104#6;
     #10#8 = #104#9;
     #10#9 = #20#1;
     #10#29 = #104#19;
     #10#30 = #104#14;
     #10#31 = #104#20;
     #10#32 = #104#17;
     #10#33 = #104#21;
     #10#34 = #104#16;
     #10#35 = #104#18;
     #10#36 = #24#47;
     #10#40 = #24#41;
     #10#50 = #24#40;
     #10#51 = #7#28;
     #10#62 = #104#59;
     #10#63 = #104#64;
     #10#64 = #24#208;
     #10#68 = #104#35;
     #10#69 = #104#36;
     #10#70 = #104#37;
     #10#73 = #104#40;
     #10#74 = #104#41;
     #10#84 = #104#57;
     #10#88 = #20#0;
     #10#91 = #24#206;

     #10#55 = #104#53;
     #10#56 = #104#54;
     #10#57 = #104#55;

     |GRABA 020#10b;

     #134#0 = #10#52;
     #134#1 = #10#0;
     |GRABA 020#134n;
|FPRC;

|PROCESO BusLinPedi;
     nPdte = #73#5 - #73#43;
     |SI #73#2 = #6#3; |Y #73#6 = #6#7; |Y nPdte > 0; || Arti y Precio igual
          nLinPedi = #73#1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE BusLinPedi;
     #73#1;
     ;
     #6#0, #6#1, 001;
     #6#0, #6#1, 999;
     ;
     NULL, BusLinPedi;
|FIN;

|PROCESO Temporal;
     |DDEFECTO #104;
     #104#25 = #6#0;
     #104#0 = #6#1;
     |LEE 121#104=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |SI aSer ! #6#0; |O nNum ! #6#1;
          |SI aSer ! "";
               |HAZ actpf;
               |LIBERA #10;
          |FINSI;

          aSer = #6#0;
          nNum = #6#1;
          |HAZ CabAlba;
     |FINSI;

     nLinPedi = #6#2;
     |BUCLE BusLinPedi;

     |DDEFECTO #73;
     #73#28 = #6#0;
     #73#0 = #6#1;
     #73#1 = nLinPedi; || #6#2;
     |LEE 121#73=;
     |SI FSalida = 0;
          |HAZ LinAlba;

          #73#43 = #73#43 + #6#6;  || Servidas

          |GRABA 020#73a;
          |LIBERA #73;
     |FINSI;

     |HAZ CalCabAgifa104;

     |LIBERA #104;
|FPRC;

|DEFBUCLE Temporal;
     #6#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Temporal;
|FIN;

|PROCESO CreaTmp;
     #6#0 = Valor1;
     #6#1 = Valor2;
     #6#2 = Valor3;
     #6#3 = Valor4;
     #6#4 = Valor5;
     #6#5 = Valor6;
     #6#6 = Valor7;
     #6#7 = Valor8;
     |GRABA 020#6n;
|FPRC;

|PROCESO Dato;
     aTab = &9;
     nCampo = 1;
     IValor = Valor1<-;
     aLon = aDato % A0;
     aReg = "";
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aLetra = aDato % nPos;
          |SI aLetra = aTab;
               Valor = aReg;
               aReg = "";
               nCampo = nCampo + 1;
               IValor = IValor + 1;
          |SINO;
               aReg = aReg + aLetra;
          |FINSI;
          |SI nCampo > 90; |SAL; |FINSI;     || Por si.... :)
     |SIGUE;
     Valor = aReg;
|FPRC;

|PROCESO ProcesaFic;
     |XABRE aTipo, aFic, nHandle;
     |SI FSalida = 0;
          |XLEE nHandle, 250, aDato;
          |PARA; |SI FSalida ] 0; |HACIENDO;
               |HAZ Dato;
               |HAZ CreaTmp;
               |XLEE nHandle, 250, aDato;
          |SIGUE;
          |XCIERRA nHandle;
          aAlfa = aFic + ".ok";
          |SI #5#1 = "C";
               |RRENOMBRA_FICHERO aFic, aAlfa;
          |SINO;
               |RENOMBRA_FICHERO aFic, aAlfa;
          |FINSI;
          nConta = nConta + 1;
     |FINSI;
|FPRC;

|PROCESO Importa;
     |SI #5#1 = "C";
          aTipo = "C";
          |R_PDIR aPath;
          |PARA; |SI FSalida = 0; |HACIENDO;
               aFic = aPath;
               aAlfa = aFic % -104; aAlfa = aAlfa < "";
               |SI aAlfa = ".asc";
                    |HAZ ProcesaFic;
               |FINSI;
               |R_SDIR aPath;
          |SIGUE;
     |SINO;
          aTipo = "";
          |_PDIR aPath;
          |PARA; |SI FSalida = 0; |HACIENDO;
               aFic = aPath;
               aAlfa = aFic % -104; aAlfa = aAlfa < "";
               |SI aAlfa = ".asc";
                    |HAZ ProcesaFic;
               |FINSI;
               |_SDIR aPath;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     |SI #0#0 ! "SI"; |ACABA; |FINSI;

     |HAZ CreaTempo; aTmp6 = Tempo; |NOME_DAT #6 Tempo; |DELINDEX #6;
     |HAZ CreaTempo; aTmp134 = Tempo; |NOME_DAT #134 Tempo; |DELINDEX #134;

     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     |ABRE #5; |LEE 000#5p; |CIERRA #5;
     aPathOrg = #5#2; |QBF aPathOrg;
     aAlfa = aPathOrg % -101;
     |SI aPathOrg = "";
          |MENAV "0000Parametros PDA no dado de alta..";
     |SINO;
          |SI aAlfa ! "/"; |Y aAlfa ! "\"; aPathOrg = aPathOrg + "/"; |FINSI;
          |ABRE #6;
          aPath = aPathOrg + "*.asc"; |HAZ Importa;
          aPath = aPathOrg + "*.ASC"; |HAZ Importa;
          |CIERRA #6;

          |ABRE #104;
          |BUCLE CheqPdte;
          aSerPed = "";
          |BUCLE QuitaRie;
          |CIERRA #104;

          |ABRE #7;
          |ABRE #10;
          |ABRE #20;
          |ABRE #24;
          |ABRE #71;
          |ABRE #3;
          |ABRET #73;
          |ABRE #104;
          |ABRE #134;
          |BUCLE Temporal;
          |SI aSer ! "";
               |HAZ actpf;
/*
               |CONFI "0000N¿Imprimir albaranes importados?";
               |SI FSalida = 0;
                    |IMPRE 0;
                    |SI FSalida = 0;
                         eaImpresora = Impresora;
                         |FINIMP;
                         |BUCLE Impre;
                    |FINSI;
               |FINSI;
*/
          |FINSI;
          |CIERRA #134;

          |BUCLE TmpAlba;

          |CIERRA #104;
          |CIERRAT #73;
          |CIERRA #3;
          |CIERRA #71;
          |CIERRA #24;
          |CIERRA #20;
          |CIERRA #10;
          |CIERRA #7;

          aSerPed = "";
          |ABRE #104;
          ||ABRE #106;
          |BUCLE PonRie_CheqAdj;
          ||CIERRA #106;
          |CIERRA #104;

          aAlfa = "0000Procesados: " + nConta + " pedidos";
          |MENAV aAlfa;
     |FINSI;

     Tempo = aTmp6; |HAZ BoraTempo; |DELINDEX #6;
     Tempo = aTmp134; |HAZ BoraTempo; |DELINDEX #134;
|FPRC;

|PROGRAMA;
     |SI PARAMETRO = "AUTO";
          #0#0 = "SI";
          |HAZ Tipo3;
     |SINO;
          |MANTE #0;
     |FINSI;
|FPRO;
