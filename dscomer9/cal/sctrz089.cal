|FICHEROS;
     sctrz089 #0;
     sctrw027 #27;  || Tmp Servicios

     sctrm003 #3;
     sctrm072 #72;
     sctrm077 #77;
|FIN;

|VARIABLES;
     &Tempo = "";
     aTmp27 = "";
     aParam = "";
     fHoy = @;
     nNume = 0;
     aDes = "";
     aPath = "";
     nHandle = 0;
     i = 0;
     aDato = "";
     aLon = "";
     nPos = 0;
     aLetra = "";
     aReg = "";
     aTab = "";
 {99}Valor = "";
     nCampo = 0;
     aNomFic = "";
     aAlfa = "";
     aOrgDes = "";
|FIN;

|PROCESO sctrm077;
     #72#0 = "999999";   || Agencia
     #72#1 = #77#2;
     |LEE 000#72=;
     |SI FSalida ! 0; |DDEFECTO #72; |FINSI;

     aDato = aOrgDes + aTab + #77#2 + aTab + #72#4;
     |XGRABA nHandle, aDato;
|FPRC;

|DEFBUCLE sctrm077;
     #77#1;
     ;
     #3#0, 001;
     #3#0, 999;
     ;
     NULL, sctrm077;
|FIN;

|PROCESO Enlaces;
     |ABRE #72;
     |ABRE #3;
     #3#0 = #0#1;
     |LEE 000#3=;
     |SI FSalida = 0; |Y #3#15 = "N";
          aOrgDes = "O";
          |BUCLE sctrm077;
     |FINSI;
     #3#0 = #0#2;
     |LEE 000#3=;
     |SI FSalida = 0; |Y #3#15 = "N";
          aOrgDes = "D";
          |BUCLE sctrm077;
     |FINSI;
     |CIERRA #3;
     |CIERRA #72;
|FPRC;

|PROCESO GrabaEnlaces;
     |DFICE aPath;
     aDes = aPath + aNomFic + ".sal";
     |XABRE "W", aDes, nHandle;
     |SI FSalida ] 0;
          aDato = "origen_destino" + aTab;
          aDato = aDato + "enlace" + aTab;
          aDato = aDato + "id_enlace";
          |XGRABA nHandle, aDato;
          |HAZ Enlaces;
          |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROCESO Dato;
     nCampo = 1;
     IValor = Valor1<-;
     aLon = aDato % A0;
     aReg = "";
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aLetra = aDato % nPos;
          |SI aLetra = aTab;
               Valor = aReg;
               aReg = "";
               nCampo = nCampo + 1;
               IValor = IValor + 1;
          |SINO;
               aReg = aReg + aLetra;
          |FINSI;
          |SI nCampo > 90; |SAL; |FINSI;     || Por si.... :)
     |SIGUE;
     Valor = aReg;
|FPRC;

|PROCESO Inicio; |TIPO 3;
     || se busca 3 d¡as antes y 3 despu‚s
     nNume = #0#5; nNume = nNume - 3; #0#8 = nNume;
     nNume = #0#5; nNume = nNume + 3; #0#9 = nNume;
     nNume = #0#6; nNume = nNume - 3; #0#10 = nNume;
     nNume = #0#6; nNume = nNume + 3; #0#11 = nNume;

     |HAZ FecSalida;
     |SI #0#3 ] 2;
          |HAZ FecVuelta;
     |FINSI;
|FPRC;

|PROCESO TipoViaje; |TIPO 0;
     |SI #0#3 = 1;
          |C_M #0#6, 1, "N";
          #0#6 = "01.01.0000"; |PINTA #0#6;
     |SINO;
          |C_M #0#6, 1, "S";
     |FINSI;
|FPRC;

|PROCESO Min27;
     #27#13 = " ";
     #27#14 = "01.01.0000";
     #27#0 = "          ";
     #27#1 = 000;
     #27#2 = " ";
     #27#3 = 000000;
     #27#5 = "     ";
     #27#6 = "     ";
     #27#12 = 000;
|FPRC;

|PROCESO Max27;
     #27#13 = "z";
     #27#14 = "31.12.9999";
     #27#0 = "zzzzzzzzzz";
     #27#1 = 999;
     #27#2 = "z";
     #27#3 = 999999;
     #27#5 = "zzzzz";
     #27#6 = "zzzzz";
     #27#12 = 999;
|FPRC;

|PROCESO LeePeticion;
     |DFICE aPath;
     aDes = aPath + aNomFic + ".ent";
     |XABRE "", aDes, nHandle;
     |SI FSalida ] 0;
          |XLEE nHandle, 250, aDato;    || los nombres
          |XLEE nHandle, 250, aDato;
          |HAZ Dato;
          |XCIERRA nHandle;

          #0#1 = Valor1;
          #0#2 = Valor2;
          #0#3 = Valor3;
          #0#4 = Valor4;
          #0#5 = Valor5;
          #0#6 = Valor6;
          #0#7 = Valor7;
     |FINSI;
|FPRC;

|PROCESO GrabaResultado;
     |DFICE aPath;
     aDes = aPath + aNomFic + ".sal";
     |XABRE "W", aDes, nHandle;
     |SI FSalida ] 0;
          aDato = "temporada" + aTab;
          aDato = aDato + "linea" + aTab;
          aDato = aDato + "sentido" + aTab;
          aDato = aDato + "servicio" + aTab;
          aDato = aDato + "descripcion" + aTab;
          aDato = aDato + "hora_salida" + aTab;
          aDato = aDato + "hora_llegada" + aTab;
          aDato = aDato + "incremento_dias" + aTab;
          aDato = aDato + "desde_fecha" + aTab;
          aDato = aDato + "hasta_fecha" + aTab;
          aDato = aDato + "dias_servicio" + aTab;
          aDato = aDato + "dias_trayecto" + aTab;
          aDato = aDato + "contador" + aTab;
          aDato = aDato + "ida_vuelta" + aTab;
          aDato = aDato + "fecha_viaje" + aTab;
          aDato = aDato + "fecha_llegada" + aTab;
          aDato = aDato + "horas_viaje" + aTab;
          aDato = aDato + "descripcion_linea" + aTab;
          aDato = aDato + "bloqueado" + aTab;
          aDato = aDato + "pax_disponible" + aTab;
          |XGRABA nHandle, aDato;
          |LEE 000#27p;
          |PARA; |SI FSalida = 0; |HACIENDO;
               aDato = "";
               |PARA i = 0; |SI i [ 19; |HACIENDO i = i + 1;
                    aAlfa = #27i; |QBF aAlfa;
                    |SI i = 8; |O i = 9; |O i = 14; |O i = 15;
                         aAlfa = (aAlfa%704)+"-"+(aAlfa%402)+"-"+(aAlfa%102);
                    |FINSI;
                    aDato = aDato + aAlfa + aTab;
               |SIGUE;
               |XGRABA nHandle, aDato;
               |LEE 000#27s;
          |SIGUE;
          |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROGRAMA;
     aParam = PARAMETRO;

     aTab = &9;

     |HAZ CreaTempo; |NOME_DAT #27 Tempo; |DELINDEX #27; aTmp27 = Tempo; |ABRE #27;
     |SI aParam = "menu";
          |PINPA #0#0;
          |PARA; |SI; |HACIENDO;
               |PINDA #0#0;
               |ENTLINEAL #1#27, 1, 7, 22, 0, Min27, Max27;
               |ENDATOS #1#0;
               |SI FSalida ! 0; |SAL; |FINSI;
               |LEE 000#27p;
               |SI FSalida = 0;
                    |ENTLINEAL #1#27, 1, 4, 22, 0, Min27, Max27;
                    aNomFic = "resultado";
                    |HAZ GrabaResultado;
                    |LEE 000#27p;
                    |PARA; |SI FSalida = 0; |HACIENDO;
                         |BORRA 020#27a;
                         |LEE 000#27s;
                    |SIGUE;
               |SINO;
                    aNomFic = "resultado";
                    |HAZ GrabaEnlaces;
                    |MENAV "0000No hay servicios...";
               |FINSI;
          |SIGUE;
     |SINO;
          aNomFic = aParam;
          |HAZ LeePeticion;
          |HAZ Inicio;
          |LEE 000#27p;
          |SI FSalida = 0;
               |HAZ GrabaResultado;
          |SINO;
               |HAZ GrabaEnlaces;
          |FINSI;
     |FINSI;
     |CIERRA #27; |DELINDEX #27; Tempo = aTmp27; |HAZ BoraTempo;
|FPRO;
