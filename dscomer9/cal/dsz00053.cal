|FICHEROS;
     dsz00053 #0,MANTE;
     agifa079 #79;||Fac
     agifa072 #72;
     agifa077 #77;||Alb
     agifa080 #80;
     agifa019 #19;
     agifa112 #112;

     agifa072@ #1;
|FIN;

|VARIABLES;
     &eaSerAlbUlt = "";
     nSal      = 0;
     &aMoneda  = "";
     &aDivisa  = "";
     &enForma  = 1;
     nBase     = 0;
     &nDeci_PreDiv = 0;
     &eaDocu   = "";
     aAlfa     = "";
     nPPort1   = 0;
     nPPort2   = 0;
     nImpDiv   = 0;
     nLin      = 0;
|FIN;

|PROCESO LineFactu;
     |DDEF aAlfa;
     aAlfa = aAlfa + "agifa072";
     |CARGA_DEF aAlfa, agifa072@;
     |SI FSalida = 0;
          |ABRE #1;
          #1#16 = #72#16;
          #1#0 = #72#0;
          #1#1 = 999;
          |LEE 000#1];
          |SI FSalida = 0;
               |LEE 000#1a;
          |SINO;
               |LEE 000#1u;
          |FINSI;
          |SI #1#16 = #72#16; |Y #1#0 = #72#0;
               nLin = #1#1 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |CIERRA #1;
          |DESCARGA_DEF #agifa072@;
          |DDEFECTO #72;
          #72#16 = #79#66;
          #72#0 = #79#0;
          #72#1 = nLin;
          #72#2 = #0#2;
          #72#17 = #0#1;
          |GRABA 020#72b;
     |FINSI;
|FPRC;

|PROCESO CabeAlb;
     |DDEFECTO #77;
     #77#50 = #0#1;
     #77#0 = #0#2;
     #77#1 = #0#3;
     #77#3 = #112#0;
     #77#4 = #112#1;
     #77#5 = #79#4;
     #77#32 = #79#5;
     #77#7 = #79#6;
     #77#8 = #79#11;
     #77#36 = #112#58;
  ||   #77#38 = "S";
  ||   #77#39 = #79#0;
  ||   #77#51 = #79#66;
     #77#52 = #112#78;
     #77#56 = #79#75;
     #77#57 = #79#76;
     #77#58 = #79#77;
     #77#61 = #79#78;
     #77#62 = #79#79;
     |GRABA 020#77b;
|FPRC;

|PROCESO LineAlb;
     |DDEFECTO #80;
     #80#27 = #0#1;
     #80#0 = #0#2;
     #80#1 = 1;
     #80#2 = #19#0;
     #80#3 = 1;
     aAlfa = #19#195; |QBF aAlfa;
     |SI aAlfa = "";
          #80#4 = #19#1;
     |SINO;
          #80#4 = #19#195;
     |FINSI;
     #80#5 = 1;
     #80#6 = nBase;
     #80#30 = nBase;
     #80#11 = #19#30;
     #80#13 = #19#2;
     #80#15 = #112#0;
     #80#25 = #79#0;
     #80#28 = #79#66;
     #80#43 = #19#205;
     |HAZ TotalLin80;
     |GRABA 020#80n;
     eaDocu = "agifa080";
     |HAZ StockEntra;
|FPRC;

|PROCESO IniAjusta; |TIPO 3;
     |SI #0#2 = 0;
          |MENAV "0000El numero albaran no puede ser '0'...";
          |ACABA;
     |FINSI;

     |ABRE #77;
     #77#50 = #0#1;
     #77#0 = #0#2;
     |LEE 000#77=;
     |SI FSalida = 0;
          |MENAV "0000El Albaran EXISTE...";
          |ACABA;
     |FINSI;
     |CIERRA #77;

     |SALVA_FICHA #72;
     |HAZ CalCabAgifa079;
     |REPON_FICHA #72;
     nBase = #79#108 + #79#111 + #79#114 + #79#119 + #79#122 + #79#47;
     nBase = #0#5 - nBase;
     |ABRE #112;
     #112#0 = #79#2;
     |LEE 000#112=;
     |CIERRA #112;

     |ABRE #19;
     #19#0 = #0#4;
     |LEE 000#19=;
     |CIERRA #19;

     |ABRE #77;
     |ABRE #80;
     |HAZ CabeAlb;
     aDivisa = #77#56;
     aMoneda = #77#58;
     |HAZ Divisas077;
     |HAZ LineAlb;
     |HAZ CalCabAgifa077;
     |HAZ LimCabAgifa077;
     |GRABA 020#77a;
     |SI FSalida = 0;
          |HAZ LineFactu;
          |PTEC 808;
          |PONCONTROL 23, "SI";
          nSal = 0;
     |FINSI;
     |CIERRA #80;
     |CIERRA #77;
|FPRC;

|PROCESO ContaAju; |TIPO 7;
     |ABRE #77;
     #77#50 = #0#1;
     |HAZ ContaAC7;
     #0#2 = #77#0;
     |PINTA #0#2;
     |CIERRA #77;
|FPRC;

|PROCESO AjustaFactura;
     nSal = 1;
     |PUSHV 0501 2380;
     |ABRE #0;
     |LEE 101#0=;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;
     |SI eaSerAlbUlt = ""; eaSerAlbUlt = #79#66; |FINSI;
     #0#5 = 0;
     #0#1 = eaSerAlbUlt;
     #0#2 = 0;
     #0#3 = #79#1;
     |BLANCO 1221 2160;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |GRABA 020#0a;
     |FINSI;
     |CIERRA #0;
     |POPV;
     FSalida = nSal;
|FPRC;
