|FICHEROS;
     conp0001 #0;

     conp0625 #625;      ||Presupuestos Taller CAB
     conp0626 #626;      ||Presupuestos Taller LIN
     conp0634 #634;      ||Text Reparacion PRES
     conp1625 #1625;     ||Texto inicial PRES.

     con00625 #25;       ||O.R. CAB
     con00626 #26;       ||O.R. LIN
     con00634 #34;       ||Texto Reparacion
     con01625 #2625;     ||Texto inicial O.R.

     agifa019 #11;       || articulos
     agifa017 #9;        || almacen
     agifa065 #12;       || Historico
     agifa027 #27;       || Series
     con00691 #691;
     agifa007 #70;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     &nDeci_Taller = 0;
     &nDeci_PreOR = 0;

    aORGen = "";
    nSwHecho = 0;
    aMensaje = "";
    r_alfa = "";
    r_long = "";
    r_num = 0;
    alfa = "    ";
    tempo = " ";
    aNumero = "";
    nCampo = 0;
    mes = 0;
    fmes = "  ";
    mes_margen = 0;
    mes_importe = 0;
|FIN;

|PROCESO Deci;
     |ABRE #691; |LEE 000#691p; |CIERRA #691;
     nDeci_Taller = #691#5;
     nDeci_PreOR = 0;
|FPRC;

|PROGRAMA;
     |HAZ Deci;
     |CLS;
     |ABRE #0;
     |DDEFECTO #0;
     |LEE 101#0p;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |SI #conp0001#12 = "SI";
               |HAZ Principal;
          |FINSI;
     |FINSI;
     |LIBERA #0;
     |CIERRA #0;
|FPRO;

|PROCESO rellena4; |TIPO 0;
     r_alfa = #0#4;
     |QBF r_alfa;
     #0#4 = "000000";
     r_long = #0#4 % A0;
     r_alfa = "000000" + r_alfa;
     r_num = -(r_long + 100);
     #0#4 = r_alfa % r_num;
     |PINTA #0#4;


     |ABRE #conp0625;
     #conp0625#0 = #conp0001#2;
     #conp0625#1 = #conp0001#4;
     |LEE 000#conp0625.=;
     |SI FSalida = 0;
     ||TODO CCC
          |SI #conp0625#40 = 999999
               aMensaje = "0000Este Presupuesto esta CERRADO.";
               |MENAV aMensaje;
               |ERROR;
          |SINO;
               |SI #conp0625#38 = "S";
                    aMensaje = "0000Este Presupuesto ya esta ASIGNADO a una O.R.: " + #conp0625#39 + "/" + #conp0625#40;
                    |MENAV aMensaje;
                    |ERROR;
               |FINSI;
          |FINSI;
     |SINO;
          aMensaje = "0000No existe este presupuesto";
          |MENAV aMensaje;
          |ERROR;
     |FINSI;
     |CIERRA #conp0625;
|FPRC;

|PROCESO rellena5;
    r_alfa = #0#5;
    |QBF r_alfa;
    #0#5 = "000000";
    r_long = #0#5 % A0;
    r_alfa = "000000" + r_alfa;
    r_num = -(r_long + 100);
    #0#5 = r_alfa % r_num;
    |PINTA #0#5;
|FPRC;

|PROCESO conp0625;
     |HAZ Serie;
     |HAZ Cabecera;
     |SI nSwHecho = 1;
          |HAZ Lineas;
          |HAZ TextIni;
          |HAZ TextRep;
     |FINSI;
|FPRC;

|DEFBUCLE conp0625;
 #conp0625#1;
 38;
 #conp0001#2, #conp0001#4, "N";
 #conp0001#2, #conp0001#4, "N";
 be;
 NULL, conp0625;
|FIN;

|PROCESO Principal;
     nSwHecho = 0;
     |ABRE #con00625;
     |ABRE #con00626;
     |ABRE #agifa027;
     |ABRE #con00634;
     |ABRE #con01625;
     |BUCLE conp0625;
     |CIERRA #agifa027;
     |CIERRA #con00626;
     |CIERRA #con00625;
     |CIERRA #con00634;
     |CIERRA #con01625;
     |SI nSwHecho = 1;
          |MENAV aORGen;
     |SINO;
          aMensaje = "0000No se ha generado ninguna orden";
          |MENAV aMensaje;
     |FINSI;
|FPRC;

|PROCESO Serie;
     #agifa027#2 = #conp0001#1;
     #agifa027#0 = "partetra";
     |LEE 111#agifa027.=;
     |SI FSalida ! 0;
          #agifa027#1 = 1;
          |GRABA 111#agifa027.b;
     |FINSI;
     tempo = ("000000" + #agifa027#1) % -106;
     aNumero = tempo;
     #agifa027#1 = #agifa027#1 + 1;
     |GRABA 021#agifa027.a;
     |LIBERA #agifa027;
|FPRC;

|PROCESO actua_arti_p;
      |ABRE #9;
      |DDEFECTO #9;
      #9#0 = #con00626#2;
      #9#2 = 01;
      |LEE 101#9=;
      |SI FSalida ! 0;
          |GRABA 011#9b;
      |FINSI;
      #11#104 = #11#104 - #con00626#4;
      #9#39 = #9#39 - #con00626#4;
      #11#6 = #11#6 - #con00626#4;
      #9#5 = #9#5 - #con00626#4;
      |SI #11#6 > 0;
           #11#10 = #11#6 * #11#9;
      |SINO;
           #11#10 = 0;
      |FINSI;
      |SI #9#5 > 0;
            #9#3 = #9#5 * #11#9;
        |SINO;
            #9#3 = 0;
      |FINSI;
      #11#11 = #11#15 + #11#7 - #11#16 - #11#104 - #11#17 - #11#13 - #11#12;
      fmes = #con00625#2 % A402;
      mes = fmes - 1;
      mes = mes * 5;
      mes = mes + 34;
      mes_importe = mes + 1;
      mes_margen = mes + 2;
      #11mes = #11mes + #con00626#4;
/*
      |SI #con00626#14 = "G"; |O #con00626#14 = "S";
           #11mes_margen  = #11mes_margen -  #con00626#17;||\\ resto el coste
           #11#96 = #11#96 - #con00626#17;  ||anual
           enImpMar = #con00626#17;
      |SINO;
           #11mes_importe = #11mes_importe + #con00626#8; || Sumo la venta
           #11mes_margen  = #11mes_margen + (#con00626#8 - #con00626#17);||\\ resto el coste
           #11#95 = #11#95 + #con00626#8;            || ptas ventas anual
           #11#96 = #11#96 + (#con00626#8 - #con00626#17);  ||margen anual
           enImpVta = #con00626#8;
           enImpMar = #con00626#8 - #con00626#17
      |FINSI;
*/
      #11#94 = #11#94 + #con00626#4;
      enUniVta = #con00626#4;
      enUniSal = #con00626#4;
      |GRABA 020#11a;
      mes = fmes - 1;
      mes = mes * 2;
      mes = mes + 11;
      #9mes = #9mes + #con00626#4; ||salida mensual
      #9#35 = #9#35 + #con00626#4; ||salida anual
      #9#50 = #9#42 + #9#6 - #9#43 - #9#39; || necesidades
      #9#50 = #9#50 - #9#4 - #9#9 - #9#8;
      |GRABA 020#9a;
      |LIBERA #9; |CIERRA #9;
      |LIBERA #11;

      efFecha = #con00625#2;
      eaArticulo = #con00626#2;
      enAlmacen = 01;
      |HAZ AcumulaArt;
      |HAZ AcumulaAlm;
|FPRC;

|PROCESO actua_histo_p;
 |ABRE #70;
 #70#26 = #con00626#0;
 |LEE 000#70=;
 |CIERRA #70;

 |ABRE #12;
 |DDEFECTO #12;
 #12#0 = #con00626#2;||articulo
 #12#11= #con00626#0;||Serie
 #12#1 = #con00625#2;||FECHA
 #12#2 = "OR";|| tipo operacion
 #12#3 = #con00626#1;|| documento
 #12#4 = #con00626#11;|| linea
 #12#5 = #70#29;        || almacen
 #12#6 = #con00626#4 * -1 ;   || stock se hace la salida
 #12#7 = 0; || stock resultante (del articulo)
 #12#8 = 0; || precio costo medio
 |SI #con00626#14 = "G"; |O #con00626#14 = "S";
     #12#9 = 0; || precio de venta
     #12#14 = 0 < #con00626#6;  || precio con descuento
 |SINO;
     #12#9 = #con00626#5; || precio de venta
     #12#14 = #con00626#5 < #con00626#6;  || precio con descuento
 |FINSI;
 #12#10 = #con00625#11;  || cliente
 #12#12 = #con00626#6;   || porcentaje descuento
 #12#13 = 0;
 |GRABA 020#12n;
 |LIBERA #12;
 |CIERRA #12;
|FPRC;

|PROCESO alta_histo_p;
     |ABRE #11;
     #11#0 = #con00626#2;
     |LEE 101#11=;
     |SI FSalida = 0;
          |HAZ actua_arti_p;
          |HAZ actua_histo_p;
     |FINSI;
     |LIBERA #11;
     |CIERRA #11;
|FPRC;


|PROCESO Cabecera;
     |DDEFECTO #con00625;
     #con00625#0 = #conp0001#1;
     #con00625#1 = aNumero;
     |LEE 101#con00625.=;
     |SI FSalida ! 0;
          aORGen = "0000Generada O.S: " + #con00625#0 + "/" + #con00625#1;
          |PARA nCampo = 2; |SI nCampo [ 37; |HACIENDO nCampo = nCampo + 1;
               #con00625#nCampo# = #conp0625#nCampo#;
          |SIGUE;
          #con00625#38 = #conp0625#0;
          #con00625#39 = #conp0625#1;
          |GRABA 020#con00625.n;
          |LIBERA #con00625;
          #conp0625#38 = "S";
          #conp0625#39 = #con00625#0;
          #conp0625#40 = #con00625#1;
          |GRABA 020#conp0625.a;
          |LIBERA #conp0625;
          nSwHecho = 1;
     |FINSI;
|FPRC;

|PROCESO conp0626;
     |DDEFECTO #con00626;
     #con00626#0 = #con00625#0;
     #con00626#1 = #con00625#1;
     #con00626#11 = #conp0626#11;
     |LEE 101#con00626.=;
     |SI FSalida ! 0;
          |PARA nCampo = 2; |SI nCampo [ 10; |HACIENDO nCampo = nCampo + 1;
               #con00626#nCampo# = #conp0626#nCampo#;
          |SIGUE;
          |PARA nCampo = 12; |SI nCampo [ 23; |HACIENDO nCampo = nCampo + 1;
               #con00626#nCampo# = #conp0626#nCampo#;
          |SIGUE;
          #con00626#21 = "";
          #con00626#28 = #conp0626#27;
          |GRABA 020#con00626.n;
          |LIBERA #con00626;
          |HAZ alta_histo_p;
     |FINSI;
|FPRC;

|DEFBUCLE conp0626;
 #conp0626#1;
 ;
 #conp0625#0, #conp0625#1, 0001;
 #conp0625#0, #conp0625#1, 9999;
 ;
 NULL, conp0626;
|FIN;

|PROCESO Lineas;
     |BUCLE conp0626;
|FPRC;

|PROCESO conp0634;
     |DDEFECTO #con00634;
     #con00634#0 = #con00625#0;
     #con00634#1 = #con00625#1;
     #con00634#2 = #conp0634#2;
     |LEE 101#con00634.=;
     |SI FSalida ! 0;
          #con00634#3 = #conp0634#3;
          |GRABA 020#con00634.n;
          |LIBERA #con00634;
     |FINSI;
|FPRC;

|DEFBUCLE conp0634;
 #conp0634#1;
 ;
 #conp0625#0, #conp0625#1, 001;
 #conp0625#0, #conp0625#1, 999;
 ;
 NULL, conp0634;
|FIN;

|PROCESO TextRep;
     |BUCLE conp0634;
|FPRC;

|PROCESO conp1625;
     |DDEFECTO #con01625;
     #con01625#0 = #con00625#0;
     #con01625#1 = #con00625#1;
     |LEE 101#con01625.=;
     |SI FSalida ! 0;
          #con01625#2 = #conp1625#2;
          #con01625#3 = #conp1625#3;
          #con01625#4 = #conp1625#4;
          #con01625#5 = #conp1625#5;
          #con01625#6 = #conp1625#6;
          #con01625#7 = #conp1625#7;
          #con01625#8 = #conp1625#8;
          #con01625#9 = #conp1625#9;
          #con01625#10 = #conp1625#10;
          #con01625#11 = #conp1625#11;
          |GRABA 020#con01625.n;
          |LIBERA #con01625;
     |FINSI;
|FPRC;

|DEFBUCLE conp1625;
 #conp1625#1;
 ;
 #conp0625#0, #conp0625#1;
 #conp0625#0, #conp0625#1;
 ;
 NULL, conp1625;
|FIN;

|PROCESO TextIni;
     |BUCLE conp1625;
|FPRC;
