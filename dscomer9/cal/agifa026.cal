NO CALCULA STOCKS, DESDE martes, 15 de septiembre de 2009, 11:11:02 CEST

|FICHEROS;
     agifa026 #0;
     agifa104 #2;   ||Pedido
     agifa073 #3;   ||Lineas de Pedido
     agifa010 #4;   ||Albaranes
     agifa071 #5;
     agifa036 #6;   ||Depositos
     agifa070 #7;
     agifa134 #8;   ||Facturas
     agifa084 #10;  ||Facturas Contado
     agifa069 #11;

     agifa081 #12;  ||Pedidos Compras
     agifa067 #13;
     agifa077 #14;  ||Albaranes Compras
     agifa080 #15;
     agifa079 #16;  ||Facturas Compras
     agifa065 #17;  ||Historico

     agifa142 #42;  ||Parametros generales.
     dsm00047 #47;

     agifa024 #50;  ||Clientes
     agifa025 #51;  ||Representante
     agifa112 #52;  ||Proveedores
     agifa019 #53;  ||Articulos
     agifa017 #54;  ||Almacenes

     agifa501 #57;
     agifa502 #58;
     agis0002 #90;

     agif0041 #141;
     referen@ #100;
     dsm00238 #238;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     nNume = 0;
     nSwKit = 0;
     nTotaKit = 0;
     nImpKit = 0;
     nMrgKit = 0;
     &eaTallerCli1 = "";
     &eaTallerCli2 = "";
     &eaTallerCli3 = "";
     nSwTaller = 0;
     nSwPCEGroup = 0;
     nSwAlbadis = 0;
     nSwSanchez = 0;
     &efDfecha = @;
     &efHfecha = @;
     nHayArti = 0;
     nHayAlma = 0;
     nHayParti = 0;
     nCanti2   = 0;
     nUni0     = 0;
     &eaDarti  = "";
     &eaHarti  = "";
     nError    = 0;
     aDef      = "";
     aPath     = "";
     aAlfa     = "";
     nUni      = "";
     aParam    = "";
     nMargen   = 0;
     nDto      = 0;
     nImpo     = 0;
     fmes      = "";
     anyo      = "";
     beta      = 0;
     mes       = 0;
     canti1    = 0;
     canti2    = 0;
     i         = 0;
     imneto    = 0;
     ncoste    = 0;
     margen    = 0;

    scanti  = 0;
    canti   = 0;
    articul = "";
    almacen = 0;
    swopera = 0;
    fabSN   = "";
    &cierre = 0;
    &enAltaCliente = 0;
    fDesde = @;
    fHasta = @;
|FIN;

|PROCESO Antes7; |TIPO 7;
     |HAZ AnoPeri;
     |SI cierre = 1;
         #0#0 = "SI"; |PINTA #0#0;
     |FINSI;
|FPRC;

|PROCESO Antes0; |TIPO 0;
     aAlfa = #0#4;
     |C_M #0#3, 1, aAlfa;
|FPRC;

|PROCESO AnoPeri; |TIPO 0;
     |SI #0#8 = "A";
          #0#1 = #0#2 % 704; |PINTA #0#1;
          #0#6 = "01.01.0000"; |PINTA #0#6;
          #0#7 = "01.01.0000"; |PINTA #0#7;
          |C_M #0#1, 1, "S";
          |C_M #0#6, 1, "N";
          |C_M #0#7, 1, "N";
     |SINO;
          #0#1 = ""; |PINTA #0#1;
          aAlfa = "01.01." + (#0#2 % 704);
          #0#6 = aAlfa; |PINTA #0#6;
          aAlfa = "31.12." + (#0#2 % 704);
          #0#7 = aAlfa; |PINTA #0#7;
          |C_M #0#1, 1, "N";
          |C_M #0#6, 1, "S";
          |C_M #0#7, 1, "S";
     |FINSI;
|FPRC;

||============================= BORRADO DE CLIENTES =======================

|PROCESO borracli;
     #50#50 = 0;    ||Pendiente facturar
     #50#51 = 0;    ||Impagados
     #50#110 = 0;   ||Total facturado
     #50#45 = "01.01.0000";
     #50#46 = 0;

     |PDEFECTO #50, 54,108;
     #50#110 = 0;
     |PDEFECTO #50,114,154;
     #50#154 = 0;
     #50#109 = 0;

     |GRABA 020#50a;
     |LIBERA #50;
|FPRC;

|DEFBUCLE clientes;
     #50#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL , borracli;
|FIN;

||=========================== BORRADO DE COMISIONISTAS ====================

|PROCESO borracomi;
     |PDEFECTO #51, 11,37;
     |PDEFECTO #51, 40,53;
     #51#37 = 0;
     #51#38 = 0;
     #51#53 = 0;
     |GRABA 020#51a;
     |LIBERA #51;
|FPRC;

|DEFBUCLE comision;
     #51#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL , borracomi;
|FIN;

||======================== BORRADO DE PROVEEDORES =========================

|PROCESO borraprove;
     |PDEFECTO #52, 27, 40;
     |PDEFECTO #52, 43, 56;
     #52#40 = 0;
     #52#56 = 0;
     |GRABA 020#52a;
     |LIBERA #52;
|FPRC;


|DEFBUCLE proveedor;
     #52#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL , borraprove;
|FIN;

||========================= BORRADO DE ARTICULOS ==========================

|PROCESO borraarti;
     #53#194 = 1; ||Factu Venta
     #53#196 = 1; ||Factu Comp
     |SI #53#179 = "S";
          |DDEFECTO #238;
          #238#0 = #53#201;
          |LEE 000#238=;
          #53#188 = #238#8; ||Tipo
          #53#192 = #238#13;||Divisor
          #53#194 = #238#6; ||Factu Venta
          #53#196 = #238#7; ||Factu Comp
          #53#197 = #238#12; ||Pedir medidas
     |FINSI;

     |SI nSwAlbadis = 0;
          #53#196 = 2; ||Factu Comp
     |FINSI;

     |PDEFECTO #53,32,97;
     |HAZ ValoraStock;
     |GRABA 020#53a;
     |LIBERA #53;
|FPRC;

|DEFBUCLE articulo;
     #53#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL , borraarti;
|FIN;

||========================= BORRADO DE ALMACENES ==========================

|PROCESO borraalma;
     |PDEFECTO #54,11,37;
     |GRABA 020#54a;
     |LIBERA #54;
|FPRC;

|DEFBUCLE almacen;
     #54#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL , borraalma;
|FIN;

||======================== PROCESOS DE PEDIDOS ============================

|PROCESO cabpedi;
|FPRC;

|| -------------------- Actualiza los Pendientes de Servir PEDIDOS VENTA
|PROCESO linpedi;
     #53#2 = #3#2;
     |LEE 000#53=;

     anyo = #2#1 % 0704;
     ||SI anyo = #0#1;
     |SI #2#1 ] fDesde; |Y #2#1 [ fHasta;
         |DDEFECTO #50;
         #50#0 = #2#4;
         |LEE 101#50=;
         |SI FSalida ! 0;|Y enAltaCliente = 0;
             |GRABA 020#50b;
         |FINSI;
         fmes = #2#1 % 402; mes = fmes - 1; mes = mes * 3; mes = mes + 114;
         |SI #53#194 = 2; nUni0 = #3#44; |SINO; nUni0 = #3#5; |FINSI;
         nImpo = ((((nUni0 * #3#6) < #3#8) < #3#29) < #2#5) < #2#17;
         |SI #42#115 = "S";
               nImpo = nImpo < #2#6;
         |FINSI;
         #50mes = #50mes + nImpo;
         #50#150 = #50#150 + nImpo;
         |GRABA 000#50a;
         |LIBERA #50;
     |FINSI;
     ||SI anyo < #0#1;
     |SI #2#1 < fDesde;
         |DDEFECTO #50;
         #50#0 = #2#4;
         |LEE 101#50=;
         |SI FSalida ! 0;|Y enAltaCliente = 0;
             |GRABA 020#50b;
         |FINSI;
         |SI #53#194 = 2; nUni0 = #3#44; |SINO; nUni0 = #3#5; |FINSI;
         nImpo = ((((nUni0 * #3#6) < #3#8) < #3#29) < #2#5) < #2#17;
         |SI #42#115 = "S";
               nImpo = nImpo < #2#6;
         |FINSI;
         #50#153 = #50#153 + nImpo;
         |GRABA 000#50a;
         |LIBERA #50;
     |FINSI;

     |SI nSwSanchez = 0; |Y #3#3 = 0;
          |ACABA;
     |FINSI;
|FPRC;

|DEFBUCLE pedi;
     #2#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL  , cabpedi , linpedi;
|FIN;

||=========================== PROCESOS DE ALBARANES ======================

|PROCESO dsm00047;
     |SI nSwKit = 0;
          nTotaKit = nTotaKit + (#47#5 * #47#8);
     |SINO;
          |DDEFECTO #53;
          #53#0 = #47#3;
          |LEE 101#53=;
          |SI FSalida ! 0 ;|GRABA 020#53b; |FINSI;

          aAlfa = #4#1 % A402;
          nNume = ((aAlfa - 1) * 5) + 34;
          #53nNume = #53nNume + (#47#5 * #5#5);
          #53#94 = #53#94 + (#47#5 * #5#5);
          |SI #4#38 = "S";
               |SI #4#1 > #53#24;
                    #53#24 = #4#1;
                    #53#25 = #5#5 * #47#5;
               |FINSI;

               nImpo = nImpKit * (#47#5 * #47#8 / nTotaKit);
               nMargen = nMrgKit * (#47#5 * #47#8 / nTotaKit);

               nNume = ((aAlfa - 1) * 5) + 35;
               #53nNume = #53nNume + nImpo;
               nNume = nNume + 1;
               #53nNume = #53nNume + nMargen;
               #53#95 = #53#95 + nImpo;
               #53#96 = #53#96 + nMargen;
          |FINSI;
          |GRABA 020#53a;
          |LIBERA #53;
     |FINSI;
|FPRC;

|DEFBUCLE dsm00047;
     #47#1;
     ;
     #5#29, #5#0, #5#1, 001;
     #5#29, #5#0, #5#1, 999;
     ;
     NULL, dsm00047;
|FIN;

|PROCESO linalba;
     ||SI anyo = #0#1;
     |SI #4#1 ] fDesde; |Y #4#1 [ fHasta;
          |DDEFECTO #53;
          #53#0 = #5#2;
          |LEE 101#53=;
          |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#53b; |FINSI;
          nHayArti = FSalida;
          |DDEFECTO #54;
          #54#0 = #5#2;
          #54#1 = #5#3;
          |LEE 101#54=;
          |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#54b; |FINSI;
          nHayAlma = FSalida;
          fmes = #4#1 % 402; mes = fmes - 1; mes = mes * 5; mes = mes + 34;
          |SI #53#194 = 2; nUni0 = #5#48; |SINO; nUni0 = #5#5; |FINSI;
          |SI #4#43 = "N";
               #53mes = #53mes + nUni0;
               #53#94 = #53#94 + nUni0;
               mes = fmes - 1; mes = mes * 2; mes = mes + 11;
               #54mes = #54mes + nUni0;
               #54#35 = #54#35 + nUni0;
          |SINO;
               #53mes = #53mes - nUni0;
               #53#94 = #53#94 - nUni0;
               mes = fmes - 1; mes = mes * 2; mes = mes + 11;
               #54mes = #54mes - nUni0;
          |FINSI;

          |HAZ linalba2;
          |HAZ ValoraStock;
          |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
          |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
          |LIBERA #53;
          |LIBERA #54;
          |SI #53#194 = 2;
               nImpKit = (((((#5#48 * #5#6) < #5#8) < #5#33) < #4#5) < #4#32);
          |SINO;
               nImpKit = (((((#5#5 * #5#6) < #5#8) < #5#33) < #4#5) < #4#32);
          |FINSI;
          |SI #42#115 = "S";
               nImpKit = nImpKit < #4#7;
          |FINSI;
          nMrgKit = #5#14;
          nTotaKit = 0;
          nSwKit = 0; |BUCLE dsm00047
          nSwKit = 1; |BUCLE dsm00047
     |FINSI;
|FPRC;

|PROCESO linalba2;
     || Al importe total de la linea le quitamos los dtos. del cliente
     |SI #4#38 = "N"; |ACABA; |FINSI;    || Solo si esta facturado

     imneto = #5#9 < #4#5;
     imneto = imneto < #4#7;
     |SI #42#115 = "S";
          imneto = imneto < #4#32;
     |FINSI;

     #8#49 = #4#53;
     #8#0 = #4#39;
     |LEE 000#8=;
     |SI FSalida = 0;
          anyo = #8#1 % 0704;
          fmes = #8#1 % A402;
          mes = fmes - 1;
          mes = mes * 5;
          mes = mes + 35;
          ncoste = #5#14;                || Coste
          margen = imneto - ncoste;

          |SI #4#43 = "S";
               imneto = -imneto;
               margen = -margen;
          |FINSI;

          #53mes = #53mes + imneto;      || Ventas mes (Articulos)

          fmes = #8#1 % A402;
          mes = fmes - 1;
          mes = mes * 5 + 36;
          #53mes = #53mes + margen;       || Margen mes (Articulos)
          #53#95 = #53#95 + imneto;       || total ventas ptas.   (Articulos)
          #53#96 = #53#96 + margen;       || Total margen.  (Articulos)
     |FINSI;
|FPRC;

|PROCESO PcegAcuImp;
     |DDEFECTO #53;
     #53#0 = #5#2;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#53b; |FINSI;
     nHayArti = FSalida;
     |DDEFECTO #54;
     #54#0 = #5#2;
     #54#1 = #5#3;
     |LEE 101#54=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#54b; |FINSI;
     nHayAlma = FSalida;

     #4#38 = "S";        || los Z siempre estan facturados
     |HAZ linalba2;

     |HAZ ValoraStock;
     |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
     |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|PROCESO cabalba;
     |SI nSwPCEGroup = 0; |Y #4#52 ] "Z    ";
          |BUCLELIN 2 PcegAcuImp #4;
          |ERROR; |ACABA;
     |FINSI;
     |SI nSwTaller = 0;
          |HAZ AvPasadoOR;
          |SI FSalida = 0; |ACABA; |FINSI;
     |FINSI;

     anyo = #4#1 % 0704;
     |DDEFECTO #50;
     #50#0 = #4#3;
     |LEE 101#50=;
     |SI FSalida ! 0;|Y enAltaCliente = 0;
          |GRABA 020#50b;
     |FINSI;
     canti = #4#15 < #4#5;
     canti = canti < #4#32;
     canti = canti < #4#7;
     |SI #4#43 = "N";
          #50#50 = #50#50 + canti;      ||Pendiente de Facturar
     |SINO;
          #50#50 = #50#50 - canti;      ||Pendiente de Facturar
     |FINSI;
     |GRABA 000#50a;
     |LIBERA #50;
|FPRC;

|DEFBUCLE alba;
     #4#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL , cabalba , linalba;
|FIN;


||========================== PROCESOS DE FACTURAS =========================

|PROCESO cabfac;
     |DDEFECTO #50;
     #50#0 = #8#2;
     |LEE 101#50=;
     |SI FSalida ! 0;|Y enAltaCliente = 0;
         |GRABA 020#50b;
     |FINSI;

     canti = #8#18 - #8#17;
     |SI #42#115 = "N";
          nImpo = (canti * 100) / (100 - #8#6);
          nDto = #8#17 + canti - nImpo;
     |SINO;
          nImpo = canti;
          nDto = #8#17;
     |FINSI;
     anyo = #8#1 % 0704;
     ||SI anyo =  #0#1;
     |SI #8#1 ] fDesde; |Y #8#1 [ fHasta;
         #50#50 = #50#50 - canti;
         fmes = #8#1 % 402; mes = fmes - 1; mes = mes * 4; mes = mes + 54;
         #50mes = #50mes + nImpo; ||canti;
         mes = mes + 1;
         #50mes = #50mes + nDto;  ||#8#17;
         mes = mes + 1;
         #50mes = #50mes + #8#46;
         #50#102 = #50#102 + nImpo; ||canti;
         #50#103 = #50#103 + nDto;  ||#8#17;
         #50#104 = #50#104 + #8#46;
         #50#110 = #50#110 + canti;
         |SI #8#1 ] #50#45;
               #50#45 = #8#1;
               #50#46 = #8#18 - #8#17;
         |FINSI;
         |SI #8#31 < 0;
              mes = fmes - 1; mes = mes * 3; mes = mes + 115;
              #50mes = #50mes - canti;
              #50#151 = #50#151 - canti;
         |FINSI;
                             ||Empiezo con el comisionista
         |DDEFECTO #51;
         #51#0 = #8#7;
         |LEE 101#51=;
         |SI FSalida ! 0;
              |GRABA 020#51b;
         |FINSI;
         mes = fmes - 1; mes = mes * 2; mes = mes + 11;
         #51mes = #51mes + #8#8;
         canti1 = #51mes % #51#39;
         mes = mes + 1;
         #51mes = #51mes + canti;
         #51#35 = #51#35 + #8#8;
         #51#36 = #51#36 + canti;
         mes = fmes - 1; mes = mes + 40;
         #51mes = canti1;
         canti1 = #51#35 % #51#39;
         #51#52 = canti1;
         |GRABA 020#51a;
         |LIBERA #51;
     |SINO;
         #50#50  = #50#50 - canti;
         #50#110 = #50#110 + canti;

         #50#106 = #50#106 + nImpo;
         #50#107 = #50#107 + nDto;
     |FINSI;
     |GRABA 000#50a;
     |LIBERA #50;
|FPRC;

|DEFBUCLE factura;
     #8#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL , cabfac;
|FIN;

||========================== PROCESOS DE RECIBOS ADELANTA=================

||========================= PROCESOS FACTURAS CONTADO =====================

|PROCESO cabcont;
 anyo = #10#1 % 0704;
 ||SI anyo = #0#1;
 |SI #10#1 ] fDesde; |Y #10#1 [ fHasta;
     |DDEFECTO #50;
     #50#0 = #10#3;
     |LEE 101#50=;
     |SI FSalida ! 0;|Y enAltaCliente = 0;
          |GRABA 020#50b;
     |FINSI;
     fmes = #10#1 % 402; mes = fmes - 1; mes = mes * 4; mes = mes + 54;
     canti  = #10#15 - #10#25;
     |SI #42#115 = "N";
          nImpo = (canti * 100) / (100 - #10#7);
          nDto = #10#25 + (canti - nImpo);
     |SINO;
          nImpo = canti;
          nDto = #10#25;
     |FINSI;
     #50mes = #50mes + nImpo;
     mes = mes + 1;
     #50mes = #50mes + nDto;
     mes = mes + 1;
     #50mes = #50mes + #10#37;
     #50#102 = #50#102 + nImpo;
     #50#103 = #50#103 + nDto;
     #50#104 = #50#104 + #10#37;
     #50#110 = #50#110 + canti;
     |SI #10#1 ] #50#45;
          #50#45 = #10#1;
          #50#46 = #10#15 - #10#25;
     |FINSI;
     |GRABA 000#50a;
     |LIBERA #50;
                         ||Empiezo con el Representante
     |DDEFECTO #51;
     #51#0 = #10#6;
     |LEE 101#51=;
     |SI FSalida ! 0;
          |GRABA 020#51b;
     |FINSI;
     canti = #10#15 - #10#25;
     mes = fmes - 1; mes = mes * 2; mes = mes + 11;
     #51mes = #51mes + #10#26;
     canti1 = #51mes % #51#39;
     mes = mes + 1;
     #51mes = #51mes + canti;
     #51#35 = #51#35 + #10#26;
     #51#36 = #51#36 + canti;
     mes = fmes - 1;
     mes = mes + 40;
     #51mes = canti1;
     canti1 = #51#35 % #51#39;
     #51#52 = canti1;
     |GRABA 020#51a;
     |LIBERA #51;
 |FINSI;
 ||SI anyo < #0#1;
 |SI #10#1 < fDesde;
     |DDEFECTO #50;
     #50#0 = #10#3;
     |LEE 101#50=;
     |SI FSalida ! 0;|Y enAltaCliente = 0;
          |GRABA 020#50b;
     |FINSI;
     canti  = #10#15 - #10#25;
     |SI #42#115 = "N";
          nImpo = (canti * 100) / (100 - #10#7);
          nDto = #10#25 + (canti - nImpo);
     |SINO;
          nImpo = canti;
          nDto = #10#25;
     |FINSI;
     #50#106 = #50#106 + nImpo;
     #50#107 = #50#107 + nDto;
     |GRABA 000#50a;
     |LIBERA #50;
 |FINSI;
|FPRC;

|PROCESO lincont;
 ||SI anyo = #0#1;
  |SI #10#1 ] fDesde; |Y #10#1 [ fHasta;
     |DDEFECTO #53;
     #53#0 = #11#2;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#53b; |FINSI;
     nHayArti = FSalida;
     |DDEFECTO #54;
     #54#0 = #11#2;
     #54#1 = #11#3;
     |LEE 101#54=;
     |SI FSalida ! 0;|Y #0#5 = "S"; |GRABA 020#54b; |FINSI;
     nHayAlma = FSalida;
     canti = #11#9 < #10#5;
     canti = canti < #10#32;
     |SI #42#115 = "S";
          canti = canti < #10#7;
     |FINSI;
     fmes = #10#1 % 402; mes = fmes - 1; mes = mes * 5; mes = mes + 34;
     |SI #53#194 = 2; nUni0 = #11#30; |SINO; nUni0 = #11#5; |FINSI;
||     #53mes = #53mes + #11#5;
     #53mes = #53mes + nUni0;
     #53#94 = #53#94 + nUni0;

     mes = mes + 1;
     #53mes = #53mes + canti;
     canti1 = canti - #11#14;
     mes = mes + 1;
     #53mes = #53mes + canti1;
 ||    #53#94 = #53#94 + nUni0;
     #53#95 = #53#95 + canti;
     #53#96 = #53#96 + canti1;
     |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
     |LIBERA #53;

     mes = fmes - 1; mes = mes * 2; mes = mes + 11;
     #54mes = #54mes + nUni0;
     #54#35 = #54#35 + nUni0;
     |HAZ ValoraStock;
     |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
     |LIBERA #54;
 |FINSI;
|FPRC;

|DEFBUCLE contado;
     #10#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL , cabcont , lincont;
|FIN;

||========================= PROCESOS DE PEDIDOS COMPRAS ===================

|PROCESO linpedcom;
     #53#0 = #13#2;
     |LEE 000#53=;

     |DDEFECTO #52;
     #52#0 = #12#4;
     |LEE 101#52=;
     |SI FSalida ! 0; |GRABA 020#52b; |FINSI;
     fmes = #12#1 % 402;
     mes = fmes + 42;

     |SI #53#196 = 2; nUni0 = #13#41; |SINO; nUni0 = #13#5; |FINSI;
     nImpo = (((((nUni0 * #13#6) < #13#8) < #13#27) < #13#57) < #12#5) < #12#17;

     |SI #42#114 = "S";
          nImpo = nImpo < #12#6;
     |FINSI;

     anyo = #12#1 % 0704;
     ||SI anyo = #0#1;
     |SI #12#1 ] fDesde; |Y #12#1 [ fHasta;
          #52mes = #52mes + nImpo;
          #52#55 = #52#55 + nImpo;
     |FINSI;
     |SI #12#1 < fDesde;
          #52#56 = #52#56 + nImpo;
     |FINSI;
     |GRABA 020#52a; |LIBERA #52;
|FPRC;

|DEFBUCLE pedicom;
     #12#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, NULL, linpedcom;
|FIN;

||========================== PROCESOS ALBARANES COMPRAS ==================
|PROCESO linalbcom;
     |DDEFECTO #53;
     #53#0 = #15#2;
     |LEE 000#53=;

     |DDEFECTO #52;
     #52#0 = #14#3;
     |LEE 101#52=;
     |SI FSalida ! 0; |GRABA 020#52b; |FINSI;
     fmes = #14#1 % 402; mes = fmes - 1; mes = mes + 27;
     |SI #53#194 = 2; nUni0 = #15#36; |SINO; nUni0 = #15#5; |FINSI;
     nImpo = (((((nUni0 * #15#6) < #15#8) < #15#26) < #15#45) < #14#5) < #14#32;
     |SI #42#114 = "S";
           nImpo = nImpo < #14#7;
     |FINSI;

     anyo = #14#1 % 0704;
     ||SI anyo = #0#1;
     |SI #14#1 ] fDesde; |Y #14#1 [ fHasta;
         |SI #14#42 = "N";
              #52mes = #52mes + nImpo;
              #52#39 = #52#39 + nImpo;
         |SINO;
              #52mes = #52mes - nImpo;
              #52#39 = #52#39 - nImpo;
         |FINSI;
     |FINSI;
     |SI #14#1 < fDesde;
         |SI #14#42 = "N";
              #52#40 = #52#40 + nImpo;
         |SINO;
              #52#40 = #52#40 - nImpo;
         |FINSI;
     |FINSI;
     |GRABA 020#52a; |LIBERA #52;

     |DDEFECTO #53;
     #53#0 = #15#2;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#53b; |FINSI;
     nHayArti = FSalida;
     |DDEFECTO #54;
     #54#0 = #15#2;
     #54#1 = #15#3;
     |LEE 101#54=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#54b; |FINSI;
     nHayAlma = FSalida;
     fmes = #14#1 % 402; mes = fmes - 1; mes = mes * 5; mes = mes + 32;

     |SI #53#196 = 2; nUni0 = #15#36; |SINO; nUni0 = #15#5; |FINSI;
     nImpo = (((((nUni0 * #15#6) < #15#8) < #15#26) < #15#45) < #14#5) < #14#32;

     |SI #42#114 = "S";
          nImpo = nImpo < #14#7;
     |FINSI;
     canti = nImpo;

     ||SI anyo = #0#1;
     |SI #14#1 ] fDesde; |Y #14#1 [ fHasta;
          |SI #14#42 = "N";
               #53mes = #53mes + nUni0;
               #53#92 = #53#92 + nUni0;
               mes = mes + 1;
               #53mes = #53mes + canti;
               #53#93 = #53#93 + canti;
               mes = fmes - 1; mes = mes * 2; mes = mes + 12;
               #54mes = #54mes + nUni0;
               #54#36 = #54#36 + nUni0;
          |SINO;
               #53mes = #53mes - nUni0;
               #53#92 = #53#92 - nUni0;
               mes = mes + 1;
               #53mes = #53mes - canti;
               #53#93 = #53#93 - canti;
               mes = fmes - 1; mes = mes * 2; mes = mes + 12;
               #54mes = #54mes - nUni0;
               #54#36 = #54#36 - nUni0;
          |FINSI;
     |SINO;
     |FINSI;

     |HAZ ValoraStock;
     |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
     |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|DEFBUCLE albacom;
     #14#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL, NULL, linalbcom;
|FIN;
||============================= LECTURA DEL HISTORICO ====================
|PROCESO mirahist;
     |SI nSwPCEGroup = 0; |Y #17#2 = "AV";
          |SI #17#11 ] "Z    ";
               |ACABA;
          |FINSI;
     |FINSI;
     |DDEFECTO #53;
     #53#0 = #17#0;
     |LEE 000#53=;

     anyo = #17#1 % 0704;
     ||SI anyo = #0#1;
     |SI #17#1 ] fDesde; |Y #17#1 [ fHasta;
          |SI #17#2 = "ES"; |O #17#2 = "EV"; |O #17#2 = "SS";
                    |O #17#2 = "ME"; |O #17#2 = "MS";
               |DDEFECTO #54;
               #54#0 = #17#0;
               #54#1 = #17#5;
               |LEE 101#54=;
               |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#54b; |FINSI;
               nHayAlma = FSalida;
               fmes = #17#1 % 402; mes = fmes - 1; mes = mes * 2;
               |SI #53#194 = 2; nUni0 = #17#17; |SINO; nUni0 = #17#6; |FINSI;
               |SI #17#2 = "SS"; |O #17#2 = "MS";
                    mes = mes + 11;
                    #54#35 = #54#35 - nUni0;
                    #54mes = #54mes - nUni0;
               |SINO;
                    mes = mes + 12;
                    #54#36 = #54#36 + nUni0;
                    #54mes = #54mes + nUni0;
               |FINSI;
               |HAZ ValoraStock;
               |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
               |LIBERA #54;
          |FINSI;
          |SI #17#2="EV";        || *(1)
               |SI #53#196 = 2; nUni0 = #17#17; |SINO; nUni0 = #17#6; |FINSI;
               |DDEFECTO #53;
               #53#0 = #17#0;      || codigo de articulo
               |LEE 101#53=;
               |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#53b; |FINSI;
               nHayArti = FSalida;
               fmes = #17#1 % 402; mes = fmes - 1; mes = mes * 5; mes = mes + 32;
               #53mes = #53mes + nUni0;                || Unidades compradas mes
               #53#92 = #53#92 + nUni0;                || Unidades compradas total
               mes = mes + 1;
               #53mes = #53mes + (nUni0 * #17#14);      || Ptas. compradas mes
               #53#93 = #53#93 + (nUni0 * #17#14);      || Ptas. compradas total

               |HAZ ValoraStock;
               |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
               |LIBERA #53;
               |DDEFECTO #52;
               #52#0 = #17#10;
               |LEE 101#52=;
               |SI FSalida ! 0; |GRABA 020#52b; |FINSI;
               fmes = #17#1 % 402; mes = fmes - 1; mes = mes + 27;
               canti = nUni0 * #17#9;
               anyo = #17#1 % 0704;
               ||SI anyo = #0#1;
               |SI #17#1 ] fDesde; |Y #17#1 [ fHasta;
                    #52mes = #52mes + canti;
                    #52#39 = #52#39 + canti;
               |FINSI;
               |SI #17#1 < fDesde;
                    #52#40 = #52#40 + canti;
               |FINSI;
               |GRABA 020#52a; |LIBERA #52;
          |FINSI;
     |FINSI;
     ||GRABA 121#17a;    modificado para inforpor
     |LIBERA #17;
|FPRC;

|DEFBUCLE historico;
     #17#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL , mirahist;
|FIN;

--------------------------------------------------------------------------
|PROCESO agifa502;
     |DDEFECTO #53;
     #53#0 = #58#2;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#53b; |FINSI;
     nHayArti = FSalida;
     |DDEFECTO #54;
     #54#0 = #58#2;
     #54#1 = #58#3;
     |LEE 101#54=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#54b; |FINSI;
     nHayAlma = FSalida;
     |SI #57#35 = "T";
          fmes = #57#14 % A402;
          mes = ((fmes - 1) * 5) + 35;
          |SI #53#194 = 2; nUni0 = #58#29; |SINO; nUni0 = #58#5; |FINSI;
          nImpo = ((((nUni0 * #58#10) < #58#14) < #57#17) < #57#19);
          |SI #42#115 = "S";
               nImpo = nImpo < #57#18;
          |FINSI;
          ||SI anyo = #0#1;
          |SI #57#14 ] fDesde; |Y #57#14 [ fHasta;
               nMargen = nImpo - #58#23;
               #53mes = #53mes + nImpo;
               #53#95 = #53#95 + nImpo;
               mes = mes + 1;
               #53mes = #53mes + nMargen;
               #53#96 = #53#96 + nMargen;
               mes = mes - 2;
               #53mes = #53mes + nUni0;
               #53#94 = #53#94 + nUni0;
          |FINSI;
          |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
     |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|DEFBUCLE agifa502;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, agifa502;
|FIN;

|PROCESO agifa501;
     anyo = #57#14 % 0704;
     #50#0 = #57#1;
     |LEE 101#50=;
     |SI FSalida ! 0;|Y enAltaCliente = 0;
          |GRABA 020#50b;
     |FINSI;
     |SI #57#35 = "T";
          |SI #57#3 > 0; beta = 1; |SINO; beta = -1; |FINSI;
          #57#3 = #57#3 * beta;
          nDto = (((#57#3 < #57#17) < #57#19) < #57#18) * beta;
          #57#3 = #57#3 * beta;
          nDto = #57#3 - nDto;   || Total Dto Cabecera
          ||...............................................
          fmes = #57#14 % A402;
          mes = ((fmes - 1) * 4) + 54;
          imneto = #57#3 - nDto;

          |SI #42#115 = "N";
               nImpo = (imneto * 100) / (100 - #57#18);
               nDto = nDto + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
          |FINSI;
          ||SI anyo = #0#1;
          |SI #57#14 ] fDesde; |Y #57#14 [ fHasta;
                 #50mes = #50mes + nImpo;
                 mes = mes + 1;
                 #50mes = #50mes + nDto;
                 mes = mes + 1;
                 #50mes = #50mes + #57#8;
                 #50#102 = #50#102 + nImpo;
                 #50#103 = #50#103 + nDto;
                 #50#104 = #50#104 + #57#8;
                 #50#110 = #50#110 + imneto;
                 |GRABA 000#50a;
          |FINSI;
          |SI #57#14 < fDesde;
                 #50#106 = #50#106 + nImpo;
                 |GRABA 000#50a;
          |FINSI;
     |FINSI;
     |LIBERA #50;

     |BUCLE agifa502;
|FPRC;

|DEFBUCLE agifa501;
     #57#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, agifa501;
|FIN;

||========================================================================
||====================== INICIO DEL PROGRAMA =============================
||========================================================================

|PROCESO Antes50;        ||Clientes
     #100#0 = #50#0;
     |LEE 000#100=;
     |SI FSalida = 0;
          #50#153 = #100#150;
          #50#106 = #100#102;
          #50#107 = #100#103;
          #50#154 = #100#151;
          #50#109 = #100#105;
          |GRABA 020#50a;
     |FINSI;
     |LIBERA #50;
|FPRC;

|DEFBUCLE Antes50;
    #50#1;
    ;
    INICIO;
    FINAL;
    be;
    NULL, Antes50;
|FIN;

|PROCESO Antes51;        ||Representantes
     #100#0 = #51#0;
     |LEE 000#100=;
     |SI FSalida = 0;
          #51#37 = #100#35;
          #51#38 = #100#36;
          #51#53 = #100#52;
          |GRABA 020#51a;
     |FINSI;
     |LIBERA #51;
|FPRC;

|DEFBUCLE Antes51;
    #51#1;
    ;
    INICIO;
    FINAL;
    be;
    NULL, Antes51;
|FIN;

|PROCESO Antes52;        ||Proveedores
     #100#0 = #52#0;
     |LEE 000#100=;
     |SI FSalida = 0;
          #52#40 = #100#39;
          #52#56 = #100#55;
          |GRABA 020#52a;
     |FINSI;
     |LIBERA #52;
|FPRC;

|DEFBUCLE Antes52;
    #52#1;
    ;
    INICIO;
    FINAL;
    be;
    NULL, Antes52;
|FIN;

|PROCESO Antes53;        || Articulos
     #100#0 = #53#0;
     |LEE 000#100=;
     |SI FSalida = 0;
          #53#101 = #100#96;
          #53#97 = #100#92;
          #53#98 = #100#93;
          #53#99 = #100#94;
          #53#100 = #100#95;
          |GRABA 020#53a;
     |FINSI;
     |LIBERA #53;
|FPRC;

|DEFBUCLE Antes53;
    #53#1;
    ;
    INICIO;
    FINAL;
    be;
    NULL, Antes53;
|FIN;

|PROCESO Antes54;        ||Articulo/Almacen
     #100#0 = #54#0;
     #100#1 = #54#1;
     |LEE 000#100=;
     |SI FSalida = 0;
          #54#37 = #100#37;
          #54#38 = #100#38;
          |GRABA 020#54a;
     |FINSI;
     |LIBERA #54;
|FPRC;

|DEFBUCLE Antes54;
    #54#1;
    ;
    INICIO;
    FINAL;
    be;
    NULL, Antes54;
|FIN;

|PROCESO Anterior;
     |DDEF aDef;
     |DBASE aPath;
     aAlfa = ("00000" + #0#3) % -105;
     aPath = aPath + "fich/" + aAlfa + "/";

     aAlfa = aDef  + "agifa024";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar " + aAlfa;
     |SINO;
          |PATH_DAT #100 aPath;
          |ABRE #100;
          |BUCLE Antes50;
          |CIERRA #100;
          |DESCARGA_DEF #referen@;
     |FINSI;

     aAlfa = aDef  + "agifa025";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar " + aAlfa;
     |SINO;
          |PATH_DAT #100 aPath;
          |ABRE #100;
          |BUCLE Antes51;
          |CIERRA #100;
          |DESCARGA_DEF #referen@;
     |FINSI;

     aAlfa = aDef  + "agifa112";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar " + aAlfa;
     |SINO;
          |PATH_DAT #100 aPath;
          |ABRE #100;
          |BUCLE Antes52;
          |CIERRA #100;
          |DESCARGA_DEF #referen@;
     |FINSI;

     aAlfa = aDef  + "agifa019";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar " + aAlfa;
     |SINO;
          |PATH_DAT #100 aPath;
          |ABRE #100;
          |BUCLE Antes53;
          |CIERRA #100;
          |DESCARGA_DEF #referen@;
     |FINSI;

     aAlfa = aDef  + "agifa017";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar " + aAlfa;
     |SINO;
          |PATH_DAT #100 aPath;
          |ABRE #100;
          |BUCLE Antes54;
          |CIERRA #100;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO MiraAntes;
     nError = 1;
     |SI #0#4 = "S";
          |DBASE aAlfa;
          aAlfa = aAlfa + "fich/";
          |PATH_DAT #141 aAlfa;
          |ABRE #141;
          #141#0 = #0#3;
          |LEE 000#141=;
          |SI FSalida ! 0;
               |CIERRA #141;
               |MENAV "0000Empresa anterior no encontrada";
               |ACABA;
          |FINSI;
          |CIERRA #141;
     |FINSI;
     nError = 0;
|FPRC;

|PROCESO inicio; |TIPO 3;
     |SI #0#0 ! "SI"; |ACABA; |FINSI;
     |HAZ MiraAntes;
     |SI nError = 1; |ACABA; |FINSI;

     |HAZ EsSanchez;
     nSwSanchez = FSalida;

     |ABRE #42; |LEE 000#42p; |CIERRA #42;
     fabSN  = #42#12;   || Kit o fabricacion

     |SI #0#8 = "A";
          aAlfa = "01.01." + #0#1; fDesde = aAlfa;
          aAlfa = "31.12." + #0#1; fHasta = aAlfa;
     |SINO;
          fDesde = #0#6;
          fHasta = #0#7;
     |FINSI;

     |MENSA "0000Borrando Clientes";
     |BUCLE clientes;

     |MENSA "0000Borrando Comisiones";
     |BUCLE comision;

     |MENSA "0000Borrando Proveedores";
     |BUCLE proveedor;

     |MENSA "0000Borrando Articulos";
     |ABRE #238;
     |BUCLE articulo;
     |CIERRA #238;

     |MENSA "0000Borrando Almacenes";
     |BUCLE almacen;

     |ABRE #50;               ||Fichero de Clientes
     |ABRE #51;               ||Fichero de Comisionistas
     |ABRE #53;               ||Fichero de Articulos
     |ABRE #52;               ||Fichero de Proveedores
     |ABRE #54;               ||Fichero de Almacenes

     |MENSA "0000Calculando Pedidos Venta";
     |BUCLE pedi;             ||Bucle de pedidos

     |MENSA "0000Calculando Albaranes Venta";
     |ABRE #8;
     |BUCLE alba;             ||Bucle de albaranes
     |CIERRA #8;

     |MENSA "0000Calculando Facturas Venta";
     |BUCLE factura;          ||Bucle de facturas

     |MENSA "0000Calculando Facturas Directas";
     |BUCLE contado;          ||Bucle de Facturas Contado

     |MENSA "0000Calculando Tickets TPV";
     |BUCLE agifa501;

     |MENSA "0000Calculando Pedidos Compra";
     |BUCLE pedicom;          ||Bucle de Pedidos Compras

     |MENSA "0000Calculando Albaranes Compra";
     |BUCLE albacom;          ||Bucle de albaranes Compras

     |MENSA "0000Calculando Historico";
     |BUCLE historico;        ||Bucle de lectura del historico

     |CIERRA #51;
     |CIERRA #50;
     |CIERRA #52;
     |CIERRA #53;
     |CIERRA #54;

     |SI #0#4 = "S";
          |HAZ Anterior;
     |FINSI;

     |SI nSwTaller = 0; |HAZ RecalTaller; |FINSI;
|FPRC;

|PROGRAMA;
     aParam = PARAMETRO; |QBF aParam;

     |HAZ EsAlbadis; nSwAlbadis = FSalida;
     |HAZ EsPCEGroup; nSwPCEGroup = FSalida;
     |HAZ EsTaller; nSwTaller = FSalida;

     |SI nSwTaller = 0;
          |HAZ ParamTaller;
     |FINSI;

     |SI aParam ! "agifa655";
          |MANTE #0;
     |SINO;
          |DDEFECTO #0;
          #0#1 = #0#2 % 704;
          #0#0 = "SI";
          |HAZ inicio;
     |FINSI;
|FPRO;
