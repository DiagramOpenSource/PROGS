|FICHEROS;
     agifa218 #0;
     agifa019 #19;
     agifa017 #17;
     agifa104 #104;  || Pedidos de Venta Cab.
     agifa073 #73;  || Pedidos de Venta Lin.

     agifa081 #81;  || cab ped.compra
     agifa067 #67;  || lin ped compra

     agifa112 #35;  || Proveedores.
     expor073@ #41;
     agifa029 #29;  ||Almace
     dsm00041 #50;  || Alma Dependientes
     agifa007 #7;
     agifa142 #142;
     dsm00005 #5;   ||Entrada vertical

     agi00029 #1,MANTE;   || Tmp Consulta Prv
     agifa080 #13;
     agifa077 #14;
     dsm00082 #82;
     dsm00083 #83;
     referen@;
|FIN;

|VARIABLES;
     aDef = "";
     nNume = 0;
     nPre = 0;
     nDto = 0;
     aPro = "";
     linea = 0;
     aTempo1 = "";
     nLinV     = 0;
     &eaDocu   = "";
     &enPrecio = 0;
     &enPreDiv = 0;
     &enDto1   = 0;
     &enDto2   = 0;
     &enDto3   = 0;
     &Tempo    = "";
     aTempo0   = "";
     aTempo41  = "";
     aDef1     = "";
     aPath     = "";
     nPrecio = 0
     aMensa    = "";
     nModo          = 0;
     nAlma          = 0;
     nCampo         = 0;
     nLinea         = 0;

     ||-- Variables de comunicacion
     &enSwMenu      = 0;
     &aSeriePedido  = "";
     &aNumeroPedido = 0;
     &enForma       = 0;

     aProve         = "";
     nCampos        = 52;
     nLinVenta      = 0;
     nLinTmp        = 0;
     nSwPrimera     = 0;
     nUni           = 0;
     nDispo         = 0;
     nFalta         = 0;
     nConta         = 0;
     i              = 0;
     j              = 0;
     aAlfa          = "";
     aNomFich    = "";
|FIN;

|CAMPOS;
     #19#16  art_prec;
     #19#183 art_prec2;
     #17#43  alm_prec;
     #17#45  alm_prec2;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO CabePedCompra;
     |DDEFECTO #81;
     |HAZ Contador;
     #81#26 = #104#26;       || Traspaso la referencia interna
                            || del pedido de ventas al de compras.
     #81#4 = #35#0;
     #81#26 = #104#26;        || Traspaso la referencia interna
                              || del pedido de ventas al de compras.
     #81#4 = #35#0;           || cod.proveedor
     #81#5 = #35#24;          || dto.
     #81#6 = #35#25;          || dto.p/p
     #81#8 = #35#2;           || nombre proveedor
     #81#9 = #35#17;          || forma de pago
     #81#17 = #35#41;         || dto.acum.

     #81#27 = #104#35; || DIVISA
     #81#28 = #104#36; || CAMBIO
     #81#29 = #104#37; || MONEDA DE TRABAJO
     #81#32 = #104#40; || MONEDA BASE
     #81#33 = #104#41; || CAMBIO MONEDA BASE
     |GRABA 021#81b;

     |HAZ EsCercama;
     |SI FSalida = 0; |HAZ CercamaCli; |FINSI;
|FPRC;

|PROCESO GrabaEntVert;
   #dsm00005#0 = "PC";
   #dsm00005#1 = #67#28;
   #dsm00005#2 = #67#0;
   #dsm00005#3 = #67#1;
   |GRABA 020#dsm00005.n;
|FPRC;

|DEFBUCLE GrabaEntVert;
#dsm00005#1;
;
"PV",#73#28,#73#0,nLinV,"      ";
"PV",#73#28,#73#0,nLinV,"zzzzzz";
be;
NULL,GrabaEntVert;
|FIN;

|PROCESO dsm00082;
     #83#0 = "P";
     #83#1 = #67#28;
     #83#2 = #67#0
     #83#3 = #67#1;
     #83#4 = #82#1;
     #83#5 = #82#2;
     |GRABA 020#83n;
|FPRC;

|DEFBUCLE dsm00082;
     #82#1;
     ;
     #67#2, 001;
     #67#2, 999;
     ;
     NULL, dsm00082;
|FIN;

|PROCESO GrabaCompra;
     #73#28 = #104#25;
     #73#0 = #104#0;
     #73#1 = #0#8;
     |LEE 020#73=;

     |HAZ LeeArti;
     |HAZ LeeProveedor;
     |SI aProve ! #35#0;
          |SI aProve ! ""; |HAZ CalCabAgifa081; |FINSI;
          aProve = #35#0;
          |HAZ CabePedCompra;
/*
          |HAZ AceraPedCom;
*/
     |FINSI;

     |DDEFECTO #67;
     |PARA i = 0;|SI i [ 7;|HACIENDO i = i + 1;
          #67i = #73i;
     |SIGUE;
/*
     eaDocu = "agifa067";
     |HAZ LeePreDtoCom;
     #67#6 = enPrecio;
     #67#33 = enPreDiv;
     #67#8 = enDto1;
     #67#27 = enDto2;
*/
     #67#14 = #73#14;
     #67#6 = #0#10;
     #67#33 = #0#13;
     #67#8 = #0#9;
     #67#27 = #0#12;
     #67#57 = #0#14;

     |ABRE #7; #7#26 = #73#28; |LEE 020#7=; |CIERRA #7; ||SERIE

     nFalta = #0#6;

     #67#3 = #7#31;          || Almacen
     #67#5 = nFalta;         || Unidades pdtes= unidades
     #67#12= 0;              || variacion unidades
     #67#13 = #0#11;
     #67#29 = #73#0;         || Serie ped.venta;
     #67#30 = #73#28;        || N ped.venta;
     #67#31 = #73#1;         || Linea ped.venta;
     #67#32 = nFalta;        || Pone las unidades como reservadas.
     #67#37 = nFalta;        || unidades pedidas
     #67#39 = #73#35;
     #67#40 = #73#36;
     #67#41 = #73#44;
     #67#45 = #73#44;
     #67#42 = #73#45;
     #67#43 = #73#46;

     #67#47 = #73#50;
     #67#48 = #73#51;
     #67#49 = #73#52;

     #67#20 = #35#0; ||Proveedor

     #67#0 = #81#0;      || Numero pedido
     #67#28= #81#25;     || Serie


     |GRABA 020#67b;
     nLinV = #73#1;
     |BUCLE GrabaEntVert;
/*
     |HAZ RecalPedCom;
*/
     |LIBERA #67;

     |ABRE #19;
     |DDEFECTO #19;
     #19#0 = #67#2;
     |LEE 101#19=;
     |SI FSalida ! 0; |GRABA 020#19b; |FINSI;
     art_prec = art_prec + #67#5;
     art_prec2 = art_prec2 + #67#41;
     |GRABA 020#19a;
     |LIBERA #19;
     |CIERRA #19;

     |ABRE #17;
     |DDEFECTO #17;
     #17#0 = #67#2;
     #17#1 = #67#3;
     |LEE 101#17=;
     |SI FSalida ! 0; |GRABA 020#17a; |FINSI;
     alm_prec = alm_prec + #67#5;
     alm_prec2 = alm_prec2 + #67#41;
     |GRABA 020#17a;
     |LIBERA #17;
     |CIERRA #17;

     |SI #142#206 = "S";
          |ABRE #83;
          |BUCLE dsm00082;
          |CIERRA #83;
     |FINSI;

|FPRC;

|DEFBUCLE GrabaCompra;
     #0#2;
     ;
     "    ", "*", 001;
     "zzzz", "*", 999;
     ;
     NULL, GrabaCompra;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO GrabaVenta;
     |SI #41#0 = "*"; |ACABA; |FINSI;   || Es para Compras

     |PARA i = 0; |SI i < nCampos; |HACIENDO i = i + 1;
          #73i = #41i;
     |SIGUE;
     nLinVenta = nLinVenta + 1;
     #73#1 = nLinVenta;

     #19#0 = #73#2;
     |LEE 020#19=;
     #73#6 = #19#28;
     #73#38 = #19#28;

     |GRABA 020#73n;
|FPRC;

|DEFBUCLE GrabaVenta;
     #41#1003;
     ;
     "     ", 000001, 001;
     "zzzzz", 999999, 999;
     ;
     NULL, GrabaVenta;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO LeeProveedor;
     |ABRE #35;
     #35#0 = #0#7;
     |LEE 000#35=;
     |SI FSalida ! 0; |DDEFECTO #35; |FINSI;
     |CIERRA #35;
|FPRC;

|PROCESO LeeArti;
     |ABRE #19;
     #19#0 = #73#2;
     |LEE 021#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;
     |CIERRA #19;
|FPRC;

|PROCESO LeeAlmacen;
     |ABRE #29;
     #29#0 = nAlma;
     |LEE 000#29=;
     |SI FSalida ! 0; |DDEFECTO #29; |FINSI;
     |CIERRA #29;
|FPRC;

|PROCESO Contador;
     #81#25 = aSeriePedido;
     enSwMenu = 1;
     |HAZ ContaPC7;
     nConta = #81#0;
     |PARA; |SI FSalida = 0; |HACIENDO;
          #81#0  = nConta;
          #81#25 = aSeriePedido;
          |LEE 001#81=;
          |SI FSalida = 0; nConta  = nConta + 1; |FINSI;
     |SIGUE;
     |DDEFECTO #agifa081;
     #81#0  = nConta;
     #81#25 = aSeriePedido;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO Tipo2; |TIPO 2;
     |SI #0#0 = "*"; |ACABA; |FINSI;

     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1; |ERROR; |ACABA; |FINSI;

     |ABRE #41;
     #41#28 = #104#25;
     #41#0 = #104#0;
     #41#1 = #0#8;
     |LEE 020#41=;
     |SI FSalida = 0;
          |SI nModo = 3;
               |BORRA 020#41a;
          |SINO;
               #41#3 = #0#3;
               #41#5 = #0#6;
               |GRABA 020#41a;
          |FINSI;
     |FINSI;
     |CIERRA #41;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO GrabaTmpC;
     nAlma = #73#3;
     |HAZ LeeAlmacen;
     |HAZ LeeArti;

     nLinea = nLinea + 1;
     |ABRE #0;
     |DDEFECTO #0;
     #0#0 = "*";
     #0#1 = nLinea;
     #0#2 = #73#2; || Arti
     #0#3 = #73#3; || Alma
     #0#4 = #73#4; ||Des Arti
     #0#5 = #29#1; ||des Alma
     #0#6 = nFalta;
     #0#7 = #19#27;
     #0#8 = #73#1;

     ||Para Hallar el Precio
     |DDEFECTO #67;
     |PARA i = 0;|SI i [ 7;|HACIENDO i = i + 1;
          #67i = #73i;
     |SIGUE;
     eaDocu = "agifa067";
     |HAZ LeePreDtoCom;
     #0#10 = enPrecio;
     #0#13 = enPreDiv;
     #0#9 = enDto1;
     #0#12 = enDto2;
     #0#14 = enDto3;

     |GRABA 020#0n;
     |CIERRA #0;
|FPRC;

|PROCESO GrabaTmpV;
     nAlma = #41#3;
     |HAZ LeeAlmacen;

     nLinea = nLinea + 1;
     |ABRE #0;
     |DDEFECTO #0;
     #0#0 = "";
     #0#1 = nLinea;
     #0#2 = #41#2; || Arti
     #0#3 = #41#3; || Alma
     #0#4 = #41#4; ||Des Arti
     #0#5 = #29#1; ||des Alma
     #0#6 = #41#5; ||Uni
     #0#7 = "";
     #0#8 = #41#1;
     |GRABA 020#0n;
     |CIERRA #0;
|FPRC;

|PROCESO MiraDepeParcial;
     |PARA i = 11; |SI i [ 20; |Y nFalta > 0; |HACIENDO i = i + 1;
          nCampo = i - 10;
          |SI #50i = "P";
               #17#1 = #50nCampo;
               |LEE 000#17=;
               nDispo = #17#43 + #17#5 - #17#42;
               |SI nDispo > 0;
                    |PARA j = 0; |SI j < nCampos; |HACIENDO j = j + 1;
                         #41j = #73j;
                    |SIGUE;
                    nLinTmp = nLinTmp + 1;
                    #41#3 = #17#1;           ||Almacen
                    #41#1 = nLinTmp;

                    nUni = nDispo - nFalta;
                    |SI nUni ] 0;
                         #73#5 = #73#5 - nFalta;
                         |SI #73#5 = 0;
                              |BORRA 020#73a;
                         |SINO;
                              |GRABA 020#73a;
                         |FINSI;
                         #41#5 = nFalta;
                         |GRABA 020#41n;
                         |HAZ GrabaTmpV;
                         nFalta = 0;
                    |SINO;
                         #73#5 = #73#5 - nDispo;
                         |SI #73#5 = 0;
                              |BORRA 020#73a;
                         |SINO;
                              |GRABA 020#73a;
                         |FINSI;
                         #41#5 = nDispo;
                         |GRABA 020#41n;
                         |HAZ GrabaTmpV;
                         nFalta = nFalta - nDispo;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO MiraDepeTotal;
     |PARA i = 11; |SI i [ 20; |Y nFalta > 0; |HACIENDO i = i + 1;
          nCampo = i - 10;
          |SI #50i = "T";
               #17#1 = #50nCampo;
               |LEE 000#17=;
               nDispo = #17#43 + #17#5 - #17#42;
               |SI nDispo > nFalta;
                    |PARA j = 0; |SI j < nCampos; |HACIENDO j = j + 1;
                         #41j = #73j;
                    |SIGUE;
                    nLinTmp = nLinTmp + 1;
                    #41#3 = #17#1;           ||Almacen
                    #41#1 = nLinTmp;

                    #73#5 = #73#5 - nFalta;
                    |SI #73#5 = 0;
                         |BORRA 020#73a;
                    |SINO;
                         |GRABA 020#73a;
                    |FINSI;
                    #41#5 = nFalta;
                    |GRABA 020#41n;
                    |HAZ GrabaTmpV;
                    nFalta = 0;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO GrabaTmp;
     enForma = -1;
     |HAZ AcumulaPV;

     |ABRE #50;
     |ABRE #17;     ||Almacen
     |ABRE #19;
     #17#0 = #73#2;
     #17#1 = #73#3;
     |LEE 000#17=;
     |SI #agifa142#143 = "N";           || teniendo en cuenta el stock
                 ||P.Rec    Tota    P.Ser
          nFalta = #17#43 + #17#5 - #17#42 - #73#5;
          |SI nFalta < 0;
               nFalta = -nFalta;
               |SI nFalta > #73#5; nFalta = #73#5; |FINSI;

               #50#0 = #17#1;
               |LEE 000#50=;   ||Alma Depen
               |SI FSalida = 0;
                    |HAZ MiraDepeTotal;
                    |SI nFalta > 0;
                         |HAZ MiraDepeParcial;
                    |FINSI;
               |FINSI;
               |SI nFalta > 0;
                    |HAZ GrabaTmpC;
               |FINSI;
          |FINSI;
     |SINO;                             || sin tener en cuenta el stock
          nFalta = #73#5;

          #50#0 = #17#1;
          |LEE 000#50=;   ||Alma Depen
          |SI FSalida = 0;
               |HAZ MiraDepeTotal;
               |SI nFalta > 0;
                    |HAZ MiraDepeParcial;
               |FINSI;
          |FINSI;
          |SI nFalta > 0;
               |HAZ GrabaTmpC;
          |FINSI;
     |FINSI;
     |CIERRA #17;
     |CIERRA #19;
     |CIERRA #50;
     nLinVenta = #73#1;
|FPRC;

|DEFBUCLE GrabaTmp;
     #73#1;
     ;
     #104#25, #104#0, 001;
     #104#25, #104#0, 999;
     ;
     NULL, LeeArti, NULL, NULL, NULL, GrabaTmp;
     #19#27;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO RecalcuVenta;
     enForma = 1; |HAZ AcumulaPV;
/*
     |HAZ RecalPedVenta;
*/
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO Min;
     #0#1 = 1;
|FPRC;

|PROCESO Max;
     #0#1 = 999;
|FPRC;

|PROCESO GrabaAlba;
     linea = linea + 1;
     #1#0 = #35#0;                  || PROVEEDOR.
     |LEE 101#1=;
     |SI FSalida ! 0;
          #1#1 = #35#1;              || NOMBRE.
          #1#2 = #13#6;             || PRECIO.
          #1#3 = #13#5;             || CANTIDAD.
          #1#4 = #14#1;             || FECHA
          #1#5 = #13#8;             || % DTO.
          #1#6 = #1#2 < #1#5;       || PRECIO NETO.
          |GRABA 020#1n;
     |SINO;
          |SI #13#8 > #1#5;
               #1#1 = #35#1;              || NOMBRE.
               #1#2 = #13#6;             || PRECIO.
               #1#3 = #13#5;             || CANTIDAD.
               #1#4 = #14#1;             || FECHA
               #1#5 = #13#8;             || % DTO.
               #1#6 = #1#2 < #1#5;       || PRECIO NETO.
               |GRABA 020#1a;
          |FINSI;
     |FINSI;
     |LIBERA #1;
|FPRC;

|PROCESO BuscaAlba;
     |MENSA "2403Buscando....";
     |LEE 000#13p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          |SI #0#2 = #13#2;
               #14#50 = #13#27;
               #14#0 = #13#0;
               |LEE 000#14=;
               |SI FSalida = 0;
                    #35#0 = #14#3;
                    |LEE 000#35=;
                    |SI FSalida ! 0; |DDEFECTO #35; |FINSI;
                    |HAZ GrabaAlba;
               |FINSI;
          |FINSI;
          |LEE 000#13s;
     |SIGUE;
     |BLIN 24;
|FPRC;

|PROCESO mini;
     #1#0 = "      ";
     #1#6 = 0;
|FPRC;

|PROCESO maxi;
     #1#0 = "zzzzzz";
     #1#6 = 99999999;
|FPRC;

|PROCESO TeclaEnter; |TIPO 0;
     |SI #1Campo = Contenido; |Y FSalida = 0;
          aPro = #1#0;
          nPre = #1#2;
          nDto = #1#5;
          |ERROR;
          |PTEC 806;
     |FINSI;
|FPRC;

|PROCESO ProveArtiLin; |TIPO 11;
     |SI FSalida = 13;
          |HAZ ProveArti;
     |FINSI;
|FPRC;

|PROCESO ProveArti; |TIPO 0;
     |SI FSalida ! 13; |ACABA; |FINSI; || F5

     |HAZ CreaTempo; aTempo1 = Tempo;
     |NOME_DAT #1 aTempo1; |DELINDEX #1;
     |ABRE #1; |ABRE #35; |ABRE #13; |ABRE #14;
     linea = 1;
     |HAZ BuscaAlba;
     |SI linea ! 1;
          aPro = "";
          |PUSHV 0501 2380;
          ||ENTLINEAL #1#1,1,4,22,1,mini,maxi;     || por proveedor
          |ENTLINEAL #2#1,-1,4,22,1,mini,maxi;     || por precio neto
          |POPV;
          |SI aPro ! "";
               #0#7 = aPro;             || PROVEEDOR.
               #0#10 = nPre;             || PRECIO.
               #0#9 = nDto;             || % DTO.
               |PINTA #0#7;
               |PINTA #0#10;
               |PINTA #0#9;
          |FINSI;
     |SINO;
          |MENAV "0000No se encontraron compras anteriores.";
     |FINSI;
     |CIERRA #1; |CIERRA #35; |CIERRA #13; |CIERRA #14;
     |DELINDEX #1;
     Tempo = aTempo1; |HAZ BoraTempo;
     |ERROR;
|FPRC;

|PROGRAMA;
     |MENSA "0000Pedido de Compra Automatico...";

     || 컴컴컴컴컴컴컴컴 Carga Def.
     |DBASE aPath;
     aMensa = ""; aDef1 = "";

     aDef1 = aPath + "def/" + "agifa073";
     |CARGA_DEF aDef1, expor073@;
     |SI FSalida ! 0;
          aMensa = "0000Error al cargar:" + aDef1;
          aDef1 = "";
          |MENAV aMensa; |ACABA;
     |FINSI;

     aAlfa = "|NC";
     aAlfa = #73#aAlfa#;
     nCampos = aAlfa;

     |HAZ CreaTempo; aTempo0 = Tempo;
     |NOME_DAT #0 aTempo0; |DELINDEX #0;

     |HAZ CreaTempo; aTempo41 = Tempo;
     |NOME_DAT #41 aTempo41; |DELINDEX #41;

     |ABRE #agifa142;
     |LEE 000#agifa142.p;
     |CIERRA #agifa142;

     |ABRE #41;
     |ABRE #104;
     #104#0 = aNumeroPedido;
     #104#25 = aSeriePedido;
     |LEE 101#104=;
     |SI FSalida = 0;
          |ABRE #81;
          |ABRE #67;
          |BUCLE GrabaTmp;
          |CIERRA #81;
          |CIERRA #67;
          |ABRE #0;
          |LEE 000#0p;
          |SI FSalida = 0;
               #104#34 = "C";     ||Lo Marco
               |GRABA 020#104a;

               |PINPA #0#104;
               |PINDA #0#104;
               |ENTLINEAL #1#0, -2, 2, 20, 1, Min, Max;
          |FINSI;
          |CIERRA #0;

          |ABRE #73;
          |BUCLE GrabaVenta;
          |CIERRA #73;
/*
          |HAZ AceraPedVenta;
*/
          |BUCLELIN 0 RecalcuVenta #104;

          |HAZ CalCabAgifa104;

          |ABRE #81;
          |ABRE #67;
          |ABRE #73;
          |ABRE #19;
          aProve = "";
          |BUCLE GrabaCompra;
          |SI aProve ! ""; |HAZ CalCabAgifa081; |FINSI;
          |CIERRA #19;
          |CIERRA #81;
          |CIERRA #67;
          |CIERRA #73;
     |FINSI;
     |CIERRA #104;

     |CIERRA #41;
     |CIERRA #0;
     |DELINDEX #41;
     |DELINDEX #0;
     Tempo = aTempo0;  |HAZ BoraTempo;
     Tempo = aTempo41; |HAZ BoraTempo;

     ||컴컴컴컴컴컴 Descarga Def.
     |SI aDef1 ! ""; |DESCARGA_DEF #expor073@; |FINSI;
|FPRO;

|PROCESO CercamaCli;
     |DDEF aDef;
     aDef = aDef + "cerca001";
     |CARGA_DEF aDef, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #81#25;
          #referen@#1 = #81#0;
          |LEE 000#referen@.=;
          |SI FSalida ! 0; |GRABA 020#referen@.b; |FINSI;
          #referen@#2 = #104#4;
          #referen@#3 = #104#8;
          #referen@#4 = #104#25;
          #referen@#5 = #104#0;
          |GRABA 020#referen@.a;
          |CIERRA #referen@;
          |PINTA #referen@#2;
          |PINTA #referen@#3;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;
