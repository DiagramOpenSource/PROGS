|FICHEROS;
     dsfa0009 #0;
     agifa084 #84;
     agifa069 #69;
     agifa501 #501;
     agifa502 #502;
     agifa065 #65;
     agifa142 #142;
     agifa508 #51;
     agifa027 #5;
     agifa321;
     agifa501@ #100; || Temporal
|FIN;

|VARIABLES;
     &eaSerTpv   = "";
     &eaSerie    = "";
     &enNumero   = 0;
     &aDivisa  = "";
     &aMoneda  = "";
     &eaProg   = "";
     &enErrCarte= 0;
     aAlfa     = "";
     claveconta= "vtiquet";
     conta_reg = 0;
     aSer      = "";
|FIN;

|PROCESO contique; |TIPO 0;
     conta_reg = 0;
     |ABRE #51;
     |DDEFECTO #51;
     #51#0 = claveconta;
     claveconta = #51#0;        ||para que lo rellene de blancos
     #51#1 = #501#57;
     |LEE 101#51];
     |PARA; |SI FSalida = 0; |Y #51#0 = claveconta; |Y #51#1 = #501#57; |HACIENDO;
          claveconta = #51#0;
          |SI #51#3 = #501#14;
               conta_reg = #51#2;
               |BORRA 021#51a;
               |SAL;
          |FINSI;
          |LIBERA #51;
          |LEE 101#51s;
     |SIGUE;
     |CIERRA #51;

     |SI conta_reg = 0;
          |ABRE #5;
          #5#0 = claveconta;
          #5#2 = #501#57;
          |LEE 101#5=;
          |SI FSalida ! 0;
               #5#1 = 1;
               |GRABA 021#5b;
          |FINSI;
          conta_reg = #5#1;
          #5#1 = #5#1 + 1;
          |GRABA 021#5a;
          |CIERRA #5;
     |FINSI;
|FPRC;

|PROCESO SiguienteTiq;
     aSer = #501#57;
     #501#35 = "T";
     #501#58 = 999999;
     |LEE 000#501];
     |SI FSalida = 0;
          |LEE 000#501a;
     |SINO;
          |LEE 000#501u;
     |FINSI;
     |SI FSalida = 0; |Y #501#57 = aSer; |Y #501#35 = "T";
          conta_reg = #501#58 + 1;
     |SINO;
          conta_reg = 1;
     |FINSI;
|FPRC;

|PROCESO Contador;
     |SALVA_FICHA #501;
     #501#57 = #0#8;
     |SI #142#137 = "F";
          claveconta = "vtiquet";
          |HAZ contique;
     |SINO;
          |HAZ SiguienteTiq;
     |FINSI;
     |REPON_FICHA #501;
|FPRC;

|PROCESO Divisa;
     |ABRE #agifa321;
     |LEE 000#agifa321.p;
     |CIERRA #agifa321;

     aMoneda = "B";
     aDivisa = #agifa321#9;
     |HAZ Divisas084;
|FPRC;

|PROCESO GrabaHisto;
     |DDEFECTO #65;
     |ABRE #65;
     #65#0 = #502#2;
     #65#1 = #501#14;
     #65#2 = "TI";
     #65#3 = #501#58;
     #65#4 = #502#1;
     #65#5 = #502#3;
     #65#6 = -#502#5;
     #65#8 = 0;
     #65#9 = #502#10;
     #65#10 = #501#1;
     #65#11 = #501#57;
     #65#12 = #502#14;
     #65#13 = 0;
     #65#14 = ((((#65#9 < #65#12) < #65#13) < #501#17) < #501#19);
     |SI #142#115 = "S";
          #65#14 = #65#14 < #501#18;
     |FINSI;
     #65#17 = #502#29;
     #65#18 = #502#30;
     #65#19 = #502#31;
     |GRABA 021#65n;
     |CIERRA #65;
|FPRC;

|DEFBUCLE GrabaHisto;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, GrabaHisto;
|FIN;

|PROCESO FinCab;
     #501#35 = "F";
     #501#57 = #84#48;
     #501#58 = #84#0;
     |LEE 121#501];
     |PARA; |SI FSalida = 0; |Y #501#35 = "F"; |Y #501#57 = #84#48;
               |Y #501#58 = #84#0; |HACIENDO;
          #100#36 = #501#36;
          #100#0 = #501#0;
          |GRABA 020#100n;
          |LEE 000#501s;
     |SIGUE;

     |SELECT #1#501;
     |LEE 000#100p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          #501#36 = #100#36;
          #501#0 = #100#0;

          |LEE 121#501=;
          |SI FSalida = 0;
               |HAZ Contador;
               #501#35 = "T";
               #501#57 = #0#8;
               #501#58 = conta_reg;
               |GRABA 020#501a;
               |||BUCLELIN 2 GrabaHisto #501;
               |BUCLE GrabaHisto;
               |LIBERA #501;
          |FINSI;

          |BORRA 020#100a;
          |LEE 000#100p;
     |SIGUE;
     |SELECT #2#501;
|FPRC;

|PROCESO agifa069;
     |BORRA 020#69a;

     |ABRE #65;
     #65#0 = #69#2;
     #65#1 = #84#1;
     #65#2 = "FC";
     #65#3 = #69#0;
     #65#4 = #69#1;
     #65#11 = #69#20;
     |BORRA 020#65c;
     |CIERRA #65;
|FPRC;

|PROCESO agifa084;
     |SI #84#39 = "S";
          aAlfa = "0000Factura: [" + #84#48 + "/" + #84#0 + &13 + "] Contabilizada...";
          |MENAV aAlfa;
          |ERROR;
          |ACABA;
     |FINSI;

     #501#35 = "F";
     #501#57 = #84#48;
     #501#58 = #84#0;
     |LEE 000#501=;
     |SI FSalida ! 0;
          aAlfa = "0000Tiquet: [" + #84#48 + "/" + #84#0 + &13 + "] No existe Tiquet...";
          |MENAV aAlfa;
          |ERROR;
     |SINO;
          |SI eaSerie = "";
               |SI #142#47 = "S";
                    |HAZ MiraRecVenta;
                    |SI enErrCarte ! 0;
                         aAlfa = "0000Factura: [" + #84#48 + "/" + #84#0 + &13 + "] Recibos con movimientos...";
                         |MENAV aAlfa;
                         |ERROR; |ACABA;
                    |FINSI;
                    eaProg = "agifa084";
                    |HAZ BorraRecVenta;
                    |BORRA 020#84a;
               |FINSI;
               |HAZ BorraVenciDir;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE agifa084;
     #84#3;
     ;
     #0#4, #0#6, #0#0, #0#2;
     #0#5, #0#7, #0#1, #0#3;
     be;
     NULL, agifa084, agifa069, FinCab;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |DDEF aAlfa;
     aAlfa = aAlfa + "agifa501";
     |CARGA_DEF aAlfa, agifa501@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar 'agifa501'...";
     |SINO;
          aAlfa = Usuario;
          |NOME_DAT #100 aAlfa;
          |DELINDEX #100;
          |ABRE #100;

          |ABRE #142; |LEE 000#142.p; |CIERRA #142;
          |HAZ Divisa;

          |ABRE #501; |SELECT #2#501;
          |SI eaSerie = "";
               |BUCLE agifa084;
          |SINO;
               |ABRE #84;
               #84#48 = eaSerie;
               #84#0 = enNumero;
               |LEE 000#84=;
               |SI FSalida = 0;
                    |HAZ agifa084;
                    |HAZ FinCab;
               |FINSI;
               |CIERRA #84;
          |FINSI;
          |CIERRA #501;

          |CIERRA #100;
          |DELINDEX #100;
          |DESCARGA_DEF #agifa501@;
     |FINSI;
|FPRC;

|PROGRAMA;
     |SI eaSerie = "";
          |MANTE #0;
     |SINO;
          #0#8 = eaSerTpv;
          |HAZ Tipo3;
     |FINSI;
|FPRO;
