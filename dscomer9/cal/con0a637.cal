     RecalFactura, RedondeoTotales

|FICHEROS;
     con00642 #0;
     con00637 #1;
     con00626 #3;
     agifa019 #5;
     agifa010 #10;
     con00683 #19
     con00603 #63;
     con00606 #66;
     con00696 #696;
     con00691 #691;
|FIN;

|VARIABLES;
     nOk = 0;
     nForma = 0;
     tipo_iva = 0;
     expor = "N";
     &enTiva = 0;
     &efFiva = @;
     &enIva = 0;
     &aDivisa = "";
     &aMoneda = "";
|FIN;


 || Esta copiado del calculo 'Total' del con00642, exactamente igual
 || Aunque acumula en el #0 como no se graba no pasa nada

|PROCESO Sum_Total;
     nOk = 0;
     |HAZ EsTallerSC;
     |SI FSalida = 0;
          |SI #3#14 ! "S"; nOk = 1; |FINSI;
     |SINO;
          |SI #3#14 = "N"; |O #3#14 = "I"; nOk = 1; |FINSI;
     |FINSI;
     |SI nOk = 0; |ACABA; |FINSI;

||     |SI #3#14 = "N";
          |SI #3#11 ] 1; |Y #3#11 [ 999; ||\\ mano de obra;
               #1#19 = #1#19 + (#3#8 * nForma);
               #0#5 = #0#5 + (#3#8 * nForma);
               #63#0 = #3#2;
               |LEE 000#63=;
               |SI FSalida ! 0; |DDEFECTO #63; |FINSI;
               tipo_iva = #63#5;
          |FINSI;
          |SI #3#11 ] 1000; |Y #3#11 [ 1999; ||Piezas;
               #1#16 = #1#16 + (#3#8 * nForma);
               #0#5 = #0#5 + (#3#8 * nForma);
               #5#0 = #3#2;
               |LEE 000#5=;
               |SI FSalida ! 0 ; |DDEFECTO #5; |FINSI;
               tipo_iva = #5#30;
          |FINSI;
          |SI #3#11 ] 2000; |Y #3#11 [ 2999; || S.exte;
               #1#18 = #1#18 + (#3#8 * nForma);
               #0#5 = #0#5 + (#3#8 * nForma);
               #66#0 = #3#2;
               |LEE 000#66=;
               |SI FSalida ! 0 ; |DDEFECTO #66; |FINSI;
               tipo_iva = #66#4;
          |FINSI;
          |SI #3#11 ] 3000; |Y #3#11 [ 3999; ||lubricante;
                #1#17 = #1#17 + (#3#8 * nForma);
                #0#5 = #0#5 + (#3#8 * nForma);
                #5#0 = #3#2;
                |LEE 000#5=;
                |SI FSalida ! 0 ; |DDEFECTO #5; |FINSI;
                tipo_iva = #5#30;
          |FINSI;
          ||\\ EN FUNCION DEL TIPO DE IVA ACUMULAR EN BASE 1 O BASE 2
          |SI #0#0 = #19#11; |O #0#0 = #19#12; |O #0#0 = #19#13;
                    |O #0#0 = #19#17; |O #0#0 = #19#18; |O #0#0 = #19#19;
                    |O #0#0 = #19#21; |O #0#0 = #19#22; |O #0#0 = #19#23;
                    |O #0#0 = #19#24; |O #0#0 = #19#25; |O #0#0 = #19#26;
                    |O #0#0 = #19#27; |O #0#0 = #19#28; |O #0#0 = #19#29;
                    |O #0#0 = #19#30; |O #0#0 = #19#31; |O #0#0 = #19#32;
                    |O #0#0 = #19#33; |O #0#0 = #19#34; |O #0#0 = #19#35;
               tipo_iva = "0";
          |FINSI;

          |SI expor = "N";
               enTiva = tipo_iva;
               efFiva = #1#2;
               |HAZ SacaIVA;

               |SI tipo_iva = 1;
                    #1#7 = #1#7 + (#3#8 * nForma);
                    #1#8 = tipo_iva;
                    #1#9 = enIva;
                    #0#6 = #0#6 + ((#3#8 %  #1#9) * nForma);
                    #1#10 = #1#10 + ((#3#8 % #1#9) * nForma);
               |FINSI;
               |SI tipo_iva = 2;
                    #1#23 = #1#23 + (#3#8 * nForma);
                    #1#24 = tipo_iva;
                    #1#25 = enIva;
                    #0#6 = #0#6 + ((#3#8 %  #1#25) * nForma);
                    #1#26 = #1#26 + ((#3#8 %  #1#25) * nForma);
              |FINSI;
              |SI tipo_iva = 0;
                  #1#6 = #1#6 + (#3#8 * nForma);
              |FINSI;
          |SINO;
               #1#6 = #1#6 + (#3#8 * nForma);
          |FINSI;
          #0#7 = #0#5 + (#0#6 * nForma);
||     |FINSI;
/*
     |SI #3#14 = "I";    ||importe interno
          |SI #2#7 = "VN"; |O #2#7 = "VO";
               #1#11 = #1#11 + (#3#8 * nForma);
          |FINSI;
          #0#5 = #0#5 + (#3#8 * nForma);
          #0#7 = #0#6 + #0#5;
     |FINSI;
*/
     #1#11 = #1#6+#1#7+#1#10+#1#23+#1#26+#1#31+#1#34+#1#37+#1#32+#1#35+#1#38;

     |SI #3#28 = -1;          ||Linea Canon
          enTiva = tipo_iva;
          efFiva = #1#2;
          |HAZ SacaIVA;
          |SI expor = "N";
               #1#30 = #1#30 + #3#8;
          |SINO;
               #1#30 = #1#30 + (#3#8 + (#3#8 % enIva));
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Suma_Alb;
     #1#30 = #1#30 + (#10#96 * nForma);
     #1#6 = #1#6 + (#10#28 * nForma);
     #1#7 = #1#7 + (#10#16 * nForma);
     #1#10 = #1#10 + (#10#17 * nForma);
     #1#23 = #1#23 + (#10#19 * nForma);
     #1#26 = #1#26 + (#10#20 * nForma);
     #1#31 = #1#31 + (#10#22 * nForma);
     #1#32 = #1#32 + (#10#23 * nForma);
     #1#34 = #1#34 + (#10#44 * nForma);
     #1#35 = #1#35 + (#10#45 * nForma);
     #1#37 = #1#37 + (#10#47 * nForma);
     #1#38 = #1#38 + (#10#48 * nForma);
     #1#11 = #1#6+#1#7+#1#10+#1#23+#1#26+#1#31+#1#34+#1#37+#1#32+#1#35+#1#38;
|FPRC;

|PROCESO con00696;
     #3#0 = #696#3;
     #3#1 = #696#4;
     #3#11 = #696#5;
     |LEE 020#3=;
     |SI FSalida = 0;
          #0#0 = #696#0;
          #0#1 = #696#1;
          #0#2 = #696#2;
          |LEE 020#0=;
          |SI FSalida = 0;
               |SI #0#10 = "A";
/*
                    #10#52 = #0#3;
                    #10#0 = #0#4;
                    |LEE 020#10=;
                    |SI FSalida = 0;
                         aDivisa = #10#68;
                         aMoneda = #10#70;
                         |HAZ Divisas010;
                         |HAZ Suma_Alb;
                    |FINSI;
*/
               |SINO;
                    |HAZ Sum_Total;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE con00696;
     #696#1;
     ;
     #1#0, #1#1, 01, 0000;
     #1#0, #1#1, 99, 9999;
     ;
     NULL, con00696;
|FIN;

|PROCESO con00642;
     #10#52 = #0#3;
     #10#0 = #0#4;
     |LEE 020#10=;
     |SI FSalida = 0;
          aDivisa = #10#68;
          aMoneda = #10#70;
          |HAZ Divisas010;
          |HAZ Suma_Alb;
     |FINSI;
|FPRC;

|DEFBUCLE con00642;
     #0#1;
     10;
     #1#0, #1#1, 01, "A";
     #1#0, #1#1, 99, "A";
     ;
     NULL, con00642;
|FIN;

|PROCESO RecalFactura;
     #1#17 = 0;
     #1#18 = 0;
     #1#16 = 0;
     #1#19 = 0;
     #1#6 = 0;
     #1#7 = 0;
     #1#10 = 0;
     #1#23 = 0;
     #1#26 = 0;
     #1#30 = 0;
     #1#31 = 0;
     #1#32 = 0;
     #1#34 = 0;
     #1#37 = 0;
     #1#35 = 0;
     #1#38 = 0;
     |ABRE #19; |LEE 000#19p; |CIERRA #19;
     nForma = 1;
     |ABRE #0;
     |ABRE #3;
     |ABRE #5;
     |ABRE #10;
     |ABRE #63;
     |ABRE #66;
     |BUCLE con00696
     |BUCLE con00642;
     |CIERRA #66;
     |CIERRA #63;
     |CIERRA #10;
     |CIERRA #5;
     |CIERRA #3;
     |CIERRA #0;
|FPRC;

|PROCESO RedondeoTotales;
     #con00637#6 = #con00637#6 ! #con00691#9;
     #con00637#7 = #con00637#7 ! #con00691#9;
     #con00637#10 = #con00637#10 ! #con00691#9;
     #con00637#23 = #con00637#23 ! #con00691#9;
     #con00637#26 = #con00637#26 ! #con00691#9;
     #con00637#30 = #con00637#30 ! #con00691#9;
     #con00637#31 = #con00637#31 ! #con00691#9;
     #con00637#32 = #con00637#32 ! #con00691#9;
     #con00637#34 = #con00637#34 ! #con00691#9;
     #con00637#37 = #con00637#37 ! #con00691#9;
     #con00637#35 = #con00637#35 ! #con00691#9;
     #con00637#38 = #con00637#38 ! #con00691#9;

     #con00637#11 = #con00637#6 + #con00637#7 + #con00637#23 + #con00637#31 + #con00637#34 + #con00637#37;
     #con00637#11 = #con00637#11 + #con00637#10 + #con00637#26 + #con00637#32 + #con00637#35 + #con00637#38;
     #con00637#11 = #con00637#11 ! #con00691#9;
|FPRC;
