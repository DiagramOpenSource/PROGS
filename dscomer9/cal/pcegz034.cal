/*        El anterior, antes de separa en 2 avisos y preavisos

|FICHEROS;
     pcegz034 #0;
     pcegm004 #4;
     pcegm011 #11;
     pcegm016 #16;
     pcegm018 #18;
     pcegm019 #19;
     agifa024 #24;
     pcegm036 #36;
     pcegm037 #37;
     agifa059 #59;
     agifa071 #71;
     :/dscarter/def/dscam003 #3;
     :/dscarter/def/dscam045 #45;
|FIN;

|VARIABLES;
     fPreaviso = @;
     nSwPre = 0;
     aInf = "";
     aAntes = "";
     aDjunto = "";
     aDes = "";
     aNomFic = "";
     aIP = "";
     aServidor = "";
     aTo = "";
     aSubject = "";
     aMensaje = "";
     aFrom = "";
     nSwAuto = 0;
     nEmpresa = 0;
     nEmpCarte = 0;
     aAlfa = "";
     aBase = "";
     aEmp = "";
     fHoy = @;
     fVto = @;
     nNume1 = 0;
     nNume2 = 0;
     nDias = 0;
     nConta = 0;
     aFic = "";
     aEnvia = "";
     aFax = "";
     aTlf = "";
     aMail = "";
     aAsunto = "";
     aIPRemoto = "";
     nError = 0;
     fFecha = @;
     nNume = 0;
|FIN;

|PROCESO Envialo;
     aDjunto = aFic;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;
     |SI aIPRemoto ! "";
          |DFICE aDes;
          aDes = aDes + aNomFic;
          |RECIBE_FICHERO aFic, aDes;
          aDjunto = aDes;

          |RFBORRA aFic;
     |FINSI;
     aIP = #18#12; |QBF aIP;
     aServidor = #18#11; |QBF aServidor;
     aTo = aMail;
     aFrom = #18#16; |QBF aFrom;
     aSubject = aAsunto;
     aMensaje = aSubject;
     |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
     |SI FSalida = 0;
          nError = 0;
     |FINSI;
|FPRC;

|PROCESO EnviaMail;
     nError = 1;
     aMail = #19#18; |QBF aMail;
     |SI aMail = ""; |ACABA; |FINSI;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;
     aNomFic = #19#4+"_"+(("000000"+#19#5)%-106)+ ".pdf"; |QBT aNomFic;
     |DBASS aFic;
     |SI aIPRemoto = "";
          |MKDIR "c:\dsmail\";
     |SINO;
          |RMKDIR "c:\dsmail\";
     |FINSI;
     aFic = "c:\dsmail\" + aNomFic;
     Impresora = "CrystalReport;" + aFic;
     |IMPRE -1;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |SI #19#13 ! 0;
          aInf = #18#21; |QBF aInf;
     |SINO;
          aInf = #18#22; |QBF aInf;
     |FINSI;
     |INFOR aInf;
     |SI FSalida = 0;
          |PRINT;
          |PIEINF;
          |FININF;
          |HAZ Envialo;
     |FINSI;
     |FINIMP;
|FPRC;

|PROCESO EnviaFax;
     nError = 1;
     |SI #19#13 = 0;
          aAsunto = "Preaviso no pago documento:" + #19#4+"/"+(("000000"+#19#5)%-106);
     |SINO;
          aAsunto = "Aviso no pago documento:" + #19#4+"/"+(("000000"+#19#5)%-106);
          aAsunto = aAsunto + ". Numero de aviso " + #19#13;
     |FINSI;
     aFax = #19#12; |QBF aFax;
     |SI aFax = ""; |ACABA; |FINSI;

     |DDEFECTO #11;
     |ABRE #11;
     #11#0 = Usuario % 810;
     |LEE 000#11=;
     |CIERRA #11;

     aMail = #11#1; |QBF aMail;

     |SI #0#1 = "S";
          Impresora = "Fax";
          |IMPRE 0;
     |SINO;
          Impresora = "Fax;-" + aFax + "*" + aMail + "&" + aAsunto;
          |IMPRE -1;
     |FINSI;
     |SI FSalida = 0;
          |SI #19#13 ! 0;
               aInf = #18#21; |QBF aInf;
          |SINO;
               aInf = #18#22; |QBF aInf;
          |FINSI;
          |INFOR aInf;
          |SI FSalida = 0;
               |PRINT;
               |PIEINF;
               |FININF;
               nError = 0;
          |FINSI;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO ImpCarta;
     nError = 1;
     Impresora = "CrystalReport;" + aFic;
     |IMPRE -1;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |SI #19#13 ! 0;
          aInf = #18#21; |QBF aInf;
     |SINO;
          aInf = #18#22; |QBF aInf;
     |FINSI;
     |INFOR aInf;
     |SI FSalida = 0;
          |PRINT;
          |PIEINF;
          |FININF;
          nError = 0;
     |FINSI;
     |FINIMP;
|FPRC;

|PROCESO LeePedido;
     aFax = "";
     aTlf = "";
     aMail = "";
     |ABRE #59;
     #59#14 = #3#0;
     #59#0 = #3#1;
     #59#1 = 1;
     |LEE 000#59];
     |SI FSalida = 0; |Y #59#14 = #3#0; |Y #59#0 = #3#1;
          |ABRE #71;
          #71#29 = #59#15;
          #71#0 = #59#2;
          #71#1 = 1;
          |LEE 000#71];
          |SI FSalida = 0; |Y #71#29 = #59#15; |Y #71#0 = #59#2;
               |ABRE #4;
               #4#25 = #71#31;
               #4#0 = #71#12;
               |LEE 000#4=;
               |SI FSalida = 0;
                    aFax = #4#72; |QBF aFax;
                    aTlf = #4#77; |QBF aTlf;
                    aMail = #4#71; |QBF aMail;
               |FINSI;
               |CIERRA #4;
          |FINSI;
          |CIERRA #71;
     |FINSI;
     |CIERRA #59;
|FPRC;

|PROCESO Historico;
     |LEE 000#19u;
     |SI FSalida = 0;
          nConta = #19#0 + 1;
     |SINO;
          nConta = 1;
     |FINSI;

     |DDEFECTO #19;
     #19#0 = nConta;
     #19#1 = #3#40;
     #19#2 = #3#32;
     #19#3 = #3#6;
     #19#4 = #3#0;
     #19#5 = #3#1;
     #19#6 = #3#2;
     #19#7 = #3#64;
     #19#8 = #3#65;
     #19#9 = #3#3;
     #19#10 = fHoy;
     #19#11 = aTlf;
     #19#12 = aFax;
     #19#13 = #3#76;
     #19#18 = aMail;
|FPRC;

|PROCESO Recibos;
     |SI #3#14 = "A"; |O #3#64 [ 0;
          |ACABA;
     |FINSI;
     |SI #3#14 = "C"; |O #3#14 = "P";
          |SI #3#12 = #18#4; |O #3#12 = #18#5; |O #3#12 = #18#6;
                    |O #3#12 = #18#13; |O #3#12 = #18#14; |O #3#12 = #18#15;
                    |O #3#12 = #18#17; |O #3#12 = #18#18; |O #3#12 = #18#19;
               |ACABA;
          |FINSI;
          |SI #3#75 = #18#7; |O #3#75 = #18#8; |O #3#75 = #18#9;
               |ACABA;
          |FINSI;

          #36#0 = #3#32;
          |LEE 000#36=;
          |SI FSalida = 0; |ACABA; |FINSI;

          #37#0 = #3#0;
          #37#1 = #3#1;
          |LEE 000#37=;
          |SI FSalida = 0; |ACABA; |FINSI;

          fHoy = #0#2;
          fVto = #3#3;
          nNume1 = fHoy;
          nNume2 = #3#3;
          nDias = nNume1 - nNume2;
          aEnvia = "N";

          aAntes = #3#76;

          nSwPre = 0;
          fPreaviso = fHoy + #18#20;
          |SI fVto ] fHoy; |Y fVto [ fPreaviso;
               |SI #3#76 = "0 "; |O #3#76 = "1 "; |O #3#76 = "2 ";
                         |O #3#76 = "3 ";
                    |ACABA;
               |FINSI;
               #3#76 = "0 ";
               aEnvia = "S";
               nSwPre = 1;
          |FINSI;

          |SI nDias ] #18#1; |Y nDias < #18#2;
               |SI #3#76 = "1 "; |O #3#76 = "2 "; |O #3#76 = "3 ";
                    |ACABA;
               |FINSI;
               #3#76 = "1 ";
               aEnvia = "S";
          |FINSI;

          |SI nDias ] #18#2; |Y nDias < #18#3;
               |SI #3#76 = "2 "; |O #3#76 = "3 ";
                    |ACABA;
               |FINSI;
               #3#76 = "2 ";
               aEnvia = "S";
          |FINSI;

          |SI nDias ] #18#3;
               |SI #3#76 = "3 ";
                    |ACABA;
               |FINSI;
               #3#76 = "3 ";
               aEnvia = "S";
          |FINSI;

          |SI aEnvia = "S";
               |SI nSwPre = 1;
                    #3#76 = "0 ";
               |SINO;
                    |SI aAntes = "  "; |O aAntes = "0 ";
                         #3#76 = "1 ";
                    |FINSI;
                    |SI aAntes = "1 "; #3#76 = "2 "; |FINSI;
                    |SI aAntes = "2 "; #3#76 = "3 "; |FINSI;
               |FINSI;

               |HAZ LeePedido;
               |ABRE #19;
               |SI #0#3 = "N";
                    |HAZ Historico;
                    aAlfa = #19#12 + #19#18; |QBF aAlfa;
                    |SI aAlfa = "";
                         |HAZ ImpCarta;
                         |SI nError = 0; #19#17 = "S"; |FINSI;
                    |SINO;
                         |HAZ EnviaFax;
                         |SI nError = 0; #19#15 = "S"; |FINSI;
                         |HAZ EnviaMail;
                         |SI nError = 0; #19#16 = "S"; |FINSI;
                    |FINSI;
                    |GRABA 020#3a;
                    |GRABA 020#19n;
               |SINO;
                    |HAZ Historico;
                    |PRINT;
               |FINSI;
               |CIERRA #19;
          |FINSI;
     |FINSI;
     |LIBERA #3;
|FPRC;

|DEFBUCLE Recibos;
     #3#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, Recibos;
|FIN;

|PROCESO dscam045;
     |SI nEmpCarte ! #45#6;
          nEmpCarte = #45#6;

          aEmp = ("00000" + #45#6) % -105;
          aAlfa = aBase + "dscarter/fich/" + aEmp + "/";
          |PATH_DAT #3#aAlfa#;
          |BUCLE Recibos;
     |FINSI;
|FPRC;

|DEFBUCLE dscam045;
     #45#1;
     ;
     nEmpresa, 001;
     nEmpresa, 999;
     ;
     NULL, NULL, NULL, NULL, NULL, dscam045;
     #45#6;
|FIN;

|PROCESO BHistorico;
     #36#0 = #19#2;
     |LEE 000#36=;
     |SI FSalida = 0; |ACABA; |FINSI;

     #37#0 = #19#4;
     #37#1 = #19#5;
     |LEE 000#37=;
     |SI FSalida = 0; |ACABA; |FINSI;

     |SI #19#15 = "N";
          |HAZ EnviaFax;
          |SI nError = 0;
               #19#15 = "S";
               |GRABA 020#19a;
          |FINSI;
     |FINSI;
     |SI #19#16 = "N";
          |HAZ EnviaMail;
          |SI nError = 0;
               #19#16 = "S";
               |GRABA 020#19a;
          |FINSI;
     |FINSI;
     aAlfa = #19#12 + #19#18; |QBF aAlfa;
     |SI aAlfa = ""; |Y #19#17 = "N";
          |HAZ ImpCarta;
          |SI nError = 0;
               #19#17 = "S";
               |GRABA 020#19a;
          |FINSI;
     |FINSI;
     |LIBERA #19;
|FPRC;

|DEFBUCLE BHistorico;
     #19#2;
     ;
     "01.01.0000";
     fFecha;
     be;
     NULL, NULL, NULL, NULL, NULL, BHistorico;
     #19#0;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |SI #0#0 = "NO"; |ACABA; |FINSI;

     |ABRE #18; |LEE 000#18p; |CIERRA #18;

     |DBASS aBase;
     aAlfa = aBase + "dscarter/fich/";
     |PATH_DAT #45 aAlfa;

     |DFICE aAlfa;
     aAlfa = aAlfa % -205;
     nEmpresa = aAlfa;
     nEmpCarte = 0;

     |ABRE #36;
     |ABRE #37;
     |SI #0#3 = "N";
          |BUCLE dscam045;
          fFecha = #0#2;
          nNume = fFecha; nNume = nNume - 1;
          fFecha = nNume;
          |BUCLE BHistorico;
     |SINO;
          |IMPRE 0;
          |SI FSalida = 0;
               aInf = #18#23; |QBF aInf;
               |INFOR aInf;
               |SI FSalida = 0;
                    |BUCLE dscam045;
                    |PIEINF;
                    |FININF;
               |FINSI;
               |FINIMP;
          |FINSI;
     |FINSI;
     |CIERRA #37;
     |CIERRA #36;
|FPRC;

|PROGRAMA;
     |SI PARAMETRO = "menu";
          |MANTE #0;
     |SINO;
          #0#0 = "SI";
          #0#1 = "N";
          #0#2 = ~;
          #0#3 = "N";
          |HAZ Tipo3;
     |FINSI;
|FPRO;
*/
