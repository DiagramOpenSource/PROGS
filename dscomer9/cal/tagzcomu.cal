|FICHEROS;
     tagzcomu #0;    ||este def
     tagmpara #1;    ||fichero donde esta el path para los txt
     tagzlins #2;    ||fichero para la descarga de lineas (TMP)
     agifa024 #24;   ||fichero de CLIENTES
     agifa019 #19;   ||fichero de ARTICULOS
     dsm00238 #38;   ||fichero que guarda los TIPOS DE MEDIDA
     tagmpalm #69;   ||fichero de datos del palm
     tagm0021 #21;
     tagm0033;

     tagm0017 #17;
     tagm0018 #18;
     agifa010 #10;
     agifa142 #142;
     agifa321 #321;  || Divisas-Parametros.
     agifa324 #324;  || Divisas-Divisas.

     dscam038@ #101;
     dscam023@ #102;
     dscam024@ #103;
     tagm0001 #100;
|FIN;

|VARIABLES;
     nUni = 0;
     i = 0;
     nFichero = 0;
     aEmp = "";
     bAlfa = "";
     nImpa = 0;
     nCartera = 0;
     aDef104 = "";
     aDef333 = "";
     aDef222 = "";
     nSwMedi = 0;
     &fed_dt = @;
     &art_dt = "";
     &cli_dt = "";
     &fam_dt = "";
     &iva_dt = 0;  || Tipo Iva.
     &dtos_2 = 0;      || Descuento 2.
     &dto_pt = 0;      || Descuento Ptas.
     &dtos_1 = 0;      || Descuento 1.
     &pvp_ve = 0;      || Precio Venta.
     &tarifa = 0;  || Tarifa Cliente....
     &gru_dt = ""; || Grupo Cliente.
     &nPromo = 0;
     &uni_dt = 0;
     &enMensaje = 0;
     &aParam = "";
     &eaSerie = "";
     &enDirEnt = 0;

     &eaCli    = "";
     &enTiva   = 0;
     &enIva    = 0;
     &enRec    = 0;
     &efFiva = @;

     &enSwMenu = 0;

     nLinea = 0;
     fFecha = @;
     aCli = "";
     nVuelta = 0;
     aSerie = "";
     nConta = 0;
     nDeci = 0;
     nBruto = 0;
     nError = 0;
     nCamBase = 0;
     nCamIva = 0;
     nCamRec = 0;
     nImpre = 0;
     ||

     nExiste = 0;
     aMensaje = "";
     aAlfa = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aPath = "";
     nFd = 0;
     aDato = "";
     aFichLin = "";
     aParametro = "";
     aDirHis    = "";
     aOrigen    = "";
     aDestino   = "";
     aFichero   = "";

     aPalm       = "";
     aLong       = "";
     aCaracter   = "";

     nLong       = 0;
     nPos        = 0;
     nCaracter   = 0;

     ||campos fichero dsclientes.txt
     aCODIGOCLI = "";
     aNOMBRECLI = "";
     aPOBLACLI = "";
     aTELEFCLI = "";

     ||campos fichero dsarticulos.txt
     aCODIGOART = "";
     aDESCART = "";
     aCODBARRAS = "";
     aTIPOMEDIDA= "";
     aMed1 = "";
     aMed2 = "";
     aMed3 = "";

     ||campos fichero dslineas_?.txt
     aLINEA = "";
     nLINEA = 0;
     aNUMVUELTA = "";
     nNUMVUELTA = 0;
     aCLIENTE = "";
     aCODART = "";
     aDESC = "";
     aUNIDADES = "";
     nUNIDADES = 0;
     aLARGO = "";
     nLARGO = 0;
     aANCHO = "";
     nANCHO = 0;
     aALTO = "";
     nPALM = 0;

     nCanal = 0;
     aLinea = "";
     aDirFich = "";
     nUni2 = 0;
     aUsuario1 = "";
     aRiesgo = "";
|FIN;


|RUTINA ABreRiesgo;
     nCartera = 0;
     |DBASS aPath;

     aDef222 = aPath + "dscarter/def/" + "dscam038";
     |CARGA_DEF aDef222, dscam038@;
     |SI FSalida ! 0;
          nCartera = -1;
          |ACABA;
     |FINSI;

     aDef333 = aPath + "dscarter/def/" + "dscam023";
     |CARGA_DEF aDef333, dscam023@;
     |SI FSalida ! 0;
          nCartera = -1;
          |ACABA;
     |FINSI;

     aDef104 = aPath + "dscarter/def/" + "dscam024";
     |CARGA_DEF aDef104, dscam024@;
     |SI FSalida ! 0;
          nCartera = -1;
          |ACABA;
     |FINSI;

     aAlfa = aPath + "dscarter/fich/";

     |PATH_DAT #101 aAlfa;
|FRUT;

|RUTINA CIerraRiesgo;
     |SI aDef104 ! ""; |DESCARGA_DEF #dscam024@; |FINSI;
     |SI aDef333 ! ""; |DESCARGA_DEF #dscam023@; |FINSI;
     |SI aDef222 ! ""; |DESCARGA_DEF #dscam038@; |FINSI;
|FRUT;

|PROCESO LinRiesgo;
     nImpa = nImpa + #103#7;
|FPRC;

|DEFBUCLE LinRiesgo;
     #103#1002;
     ;
     #24#0, 01;
     #24#0, 99;
     ;
     NULL, LinRiesgo;
|FIN;

|PROCESO Saca_Datos;
     |SI #101#5 ! 0;
          bAlfa = #101#5;
          |QBF bAlfa;
          bAlfa = ( "00000" + bAlfa) % -105;
          aAlfa = aPath + "dscarter/fich/" + bAlfa + "/";
          |PATH_DAT #102 aAlfa;
          |PATH_DAT #103 aAlfa;

          |ABRE #102;
          #102#0 = #24#0;
          |LEE 000#102=;
          |SI FSalida = 0;
               |SI #102#9 = "S"; aRiesgo = "S"; |FINSI;
               |SI #102#9 = "A";
                    nImpa = 0;
                    |BUCLE LinRiesgo;
                    |SI nImpa ! 0; aRiesgo = "S"; |FINSI;
               |FINSI;
          |FINSI;
          |CIERRA #102;
     |FINSI;
|FPRC;

|DEFBUCLE Saca_Datos;
     #101#2004;
     ;
     00001, aEmp," ",001;
     99999, aEmp,"z",999;
     ;
     NULL,Saca_Datos;
|FIN;

|PROCESO BloqRiesgo;
     aRiesgo = "N";
     |HAZ ABreRiesgo;
     |SI nCartera = 0;
          |DFICE aEmp;
          aEmp = aEmp % -205;
          |DBASS aPath;
          |BUCLE Saca_Datos;
     |FINSI;
     |HAZ CIerraRiesgo;
|FPRC;
||*************************************************************************
||****** LINEAS               *********************************************

|PROCESO Lineas;
     aPath = #tagmpara#3;   ||Cambio de campo este contine la ruta donde la aplicacion recojera los ficheros dslineas_n§palm_n§contador.txt
     |QBF aPath;

     |MKDIR aPath;

     aFichLin = "dslineas_*.txt";
     aDirFich = aPath;
     aDirFich = aDirFich + aFichLin;
     aDirHis  = aPath + "Historico";  |MKDIR aDirHis;
     aDirHis  = aDirHis + "/";
     |_PDIR aDirFich;
     |PARA; |SI FSalida ] 0; |HACIENDO;
          |XABRE "SB", aDirFich, nCanal;
          nFichero = nFichero + 1;
          aFichero = aDirFich - aPath;
          ||nos quedamos con las cabeceras del txt
          |XLEE nCanal, 120, aLinea;
          |PARA; |SI FSalida > 0; |HACIENDO;
               aAlfa = aLinea;  |QBF aAlfa;
               |SI aAlfa ! "";
                    aLINEA = aLinea % 103;
                    |QBF aLINEA;
                    nLINEA = aLINEA;

                    aNUMVUELTA = aLinea % 503;
                    |QBF aNUMVUELTA;
                    nNUMVUELTA = aNUMVUELTA;

                    aCLIENTE = aLinea % 0906;
                    |QBF aCLIENTE;
                    aAlfa = "0" * 6;
                    aCLIENTE = aAlfa + aCLIENTE;
                    aCLIENTE = aCLIENTE % -106;

                    aCODART = aLinea % 1620;
                    |QBF aCODART;

                    aDESC = aLinea % 3750;
                    |QBF aDESC;

                    aUNIDADES = aLinea % 8806;
                    |QBF aUNIDADES;
                    nUNIDADES = aUNIDADES;

                    aLARGO = aLinea % 9508;
                    |QBF aLARGO;
                    nLARGO = aLARGO;

                    aANCHO = aLinea % 10308
                    |QBF aANCHO;
                    nANCHO = aANCHO;

                    aALTO = aLinea % 11108;

                    ||Ahora ya podemos ir metiendo en la tabla los campos del txt de lineas

                    |DDEFECTO #tagzlins;

                    aAlfa  = aDirFich - ".txt";
                    aAlfa  = aAlfa - aPath;
                    aAlfa  = aAlfa - "dslineas_";
                    aLong  = aAlfa % 0;
                    nLong  = aLong;
                    aPalm  = "";
                    |PARA nCaracter = 1;  |SI nCaracter [ nLong;  |HACIENDO nCaracter = nCaracter + 1;
                          nPos      = (100 * nCaracter) + 1;
                          aCaracter = aAlfa % nPos;
                          |SI aCaracter ! "_";
                              aPalm = aPalm + aCaracter;
                          |SINO;
                              |SAL;
                          |FINSI;
                    |SIGUE;
                    nPALM = aPalm;

                    |ABRE #tagzlins;

                    #tagzlins#0 = nPALM;
                    #tagzlins#1 = aCLIENTE;
                    #tagzlins#2 = nNUMVUELTA;
                    #tagzlins#3 = nLINEA;
                    #tagzlins#10 = nFichero;
                    |LEE 101#tagzlins.=;
                    |SI FSalida ! 0;    |GRABA 020#tagzlins.b;   |FINSI;
                    #tagzlins#4 = aCODART;
                    #tagzlins#5 = aDESC;
                    #tagzlins#6 = nUNIDADES;
                    #tagzlins#7 = nLARGO;
                    #tagzlins#8 = nANCHO;
                    #tagzlins#9 = aALTO;
                    |GRABA 020#tagzlins.a;
                    |LIBERA #tagzlins;
                    |CIERRA #tagzlins;

               |FINSI;
               |XLEE nCanal, 120, aLinea;
          |SIGUE;
          |XCIERRA nCanal;

         aOrigen  = aDirFich;
         aDestino = aDirHis + aFichero;
         |RENOMBRA_FICHERO aOrigen, aDestino;

         |_SDIR aDirFich;
    |SIGUE;
|FPRC;

||****** FIN LINEAS           *********************************************
||*************************************************************************



||*************************************************************************
||****** BUCLE PARA ARTICULOS *********************************************

||__________proceso al inicio del bucle
|PROCESO agifa019_1;
     || Abrimos el fichero txt para escritura (dsarticulos.txt)

     aPath = #tagmpara#1;
     |QBF aPath;

     |MKDIR aPath;
     aDestino = aPath + "dsarticulos.txt";
     |QBT aDestino;
     |XABRE "SWB",aDestino,nFd;
     |SI FSalida < 0;
          aAlfa = "0000ERROR AL ABRIR FICHERO " + aDestino;
          |MENAV aAlfa;
          |ERROR;
     |FINSI;

|FPRC;



||__________proceso por cada registro encontrado en el bucle
|PROCESO agifa019_2;

          aCODIGOART = "";
          aAlfa2 = "0";
          aAlfa = aAlfa2 * 20;
          aCODIGOART = aAlfa + #agifa019#0;
          aCODIGOART = aCODIGOART % -0120;

          aDESCART = "";
          aAlfa2 = " ";
          aAlfa = aAlfa2 * 50;
          aDESCART = #agifa019#1 + aAlfa;
          aDESCART = aDESCART % 0150;
          aDESCART = aDESCART > "";

          aCODBARRAS = "";
          aAlfa2 = " ";
          aAlfa = aAlfa2 * 20;
          aCODBARRAS = #agifa019#128 + aAlfa;
          aCODBARRAS = aCODBARRAS % 0120;

          |DDEFECTO #38;
          |ABRE #38;        ||abrimos dsm00238 para coger el tipo de medida.
          #38#0 = #agifa019#201;
          |LEE 000#38=;
          |CIERRA #38;

          aTIPOMEDIDA = #38#8;


          aDato = "";
          aDato = aCODIGOART + aDESCART + aCODBARRAS + aTIPOMEDIDA;

          || Grabamos la linea
          |XGRABA nFd,aDato;

          |SI nSwMedi = 0;
               aMed1 = #38#9;  aMed1 = aAlfa + aMed1; aMed1 = aMed1 % -110;
               aMed2 = #38#10; aMed2 = aAlfa + aMed2; aMed2 = aMed2 % -110;
               aMed3 = #38#11; aMed3 = aAlfa + aMed3; aMed3 = aMed3 % -110;
          |SINO;
               aMed1 = #21#4;  aMed1 = aAlfa + aMed1; aMed1 = aMed1 % -110;
               aMed2 = #21#5; aMed2 = aAlfa + aMed2; aMed2 = aMed2 % -110;
               aMed3 = #21#6; aMed3 = aAlfa + aMed3; aMed3 = aMed3 % -110;
          |FINSI;
          aDato = aMed1 + aMed2 + aMed3;
          |XGRABA nFd,aDato;


          || Grabamos un salto de linea
          aDato = &13 + &10;
          |XGRABA nFd,aDato;

|FPRC;



||__________proceso al final del bucle
|PROCESO agifa019_3;
     || Cerramos el fichero txt (dsarticulos.txt)
     |XCIERRA nFd;
|FPRC;


|| Recorre Clientes para generar dsarticulos.txt
|DEFBUCLE agifa019;
     #agifa019#1;
     2;
     #0#4, #0#6;
     #0#5, #0#7;
     ;
     agifa019_1,agifa019_2,NULL,NULL,agifa019_3;
|FIN;


||****** FIN ARTICULOS ****************************************************
||*************************************************************************

||*************************************************************************
||****** BUCLE PARA CLIENTES  *********************************************

||__________proceso al inicio del bucle
|PROCESO agifa024_1;
     || Abrimos el fichero txt para escritura (dsclientes.txt)

     aPath = #tagmpara#1;
     |QBF aPath;

     |MKDIR aPath;
     aDestino = aPath + "dsclientes.txt";
     |QBT aDestino;
     |XABRE "SWB",aDestino,nFd;
     |SI FSalida < 0;
          aAlfa = "0000ERROR AL ABRIR FICHERO " + aDestino;
          |MENAV aAlfa;
          |ERROR;
     |FINSI;
|FPRC;



||__________proceso por cada registro encontrado en el bucle
|PROCESO agifa024_2;

          aCODIGOCLI = "";
          aAlfa = "000000";
          aCODIGOCLI = aAlfa + #agifa024#0;
          aCODIGOCLI = aCODIGOCLI % -106;

          aNOMBRECLI = "";
          aAlfa2 = " ";
          aAlfa = aAlfa2 * 50;
          aNOMBRECLI = #agifa024#2 + aAlfa;
          aNOMBRECLI = aNOMBRECLI % 0150;
          aNOMBRECLI = aNOMBRECLI > "";

          aPOBLACLI = "";
          aAlfa2 = " ";
          aAlfa = aAlfa2 * 30;
          aPOBLACLI = #agifa024#6 + aAlfa;
          aPOBLACLI = aPOBLACLI % 0130;

          aTELEFCLI = "";
          aAlfa2 = " ";
          aAlfa = aAlfa2 * 9;
          aTELEFCLI = #agifa024#17 + aAlfa;
          aTELEFCLI = aTELEFCLI % 109;


          |HAZ BloqRiesgo;
          aDato = aCODIGOCLI + aNOMBRECLI + aPOBLACLI + aTELEFCLI + aRiesgo;

          || Grabamos la linea
          |XGRABA nFd,aDato;

          || Grabamos un salto de linea
          aDato = &13 + &10;
          |XGRABA nFd,aDato;

|FPRC;



||__________proceso al final del bucle
|PROCESO agifa024_3;
     || Cerramos el fichero txt (dsclientes.txt)
     |XCIERRA nFd;
|FPRC;


|| Recorre Clientes para generar dsclientes.txt
|DEFBUCLE agifa024;
     #agifa024#1;
     25;
     #0#0, #0#2;
     #0#1, #0#3;
     ;
     agifa024_1,agifa024_2,NULL,NULL,agifa024_3;
|FIN;


||****** FIN CLIENTES  ****************************************************
||*************************************************************************

||*************************************************************************
||****** BUCLE PARA taglobarras *********************************************

||__________proceso al inicio del bucle
|PROCESO tagm0033_1;
     || Abrimos el fichero txt para escritura (taglobarras.txt)

     aPath = #tagmpara#1;
     |QBF aPath;

     |MKDIR aPath;
     aDestino = aPath + "taglobarras.txt";
     |QBT aDestino;
     |XABRE "SWB",aDestino,nFd;
     |SI FSalida < 0;
          aAlfa = "0000ERROR AL ABRIR FICHERO " + aDestino;
          |MENAV aAlfa;
          |ERROR;
     |FINSI;
|FPRC;



||__________proceso por cada registro encontrado en el bucle
|PROCESO tagm0033_2;
          aDato = ("00" + #tagm0033#1) % -102;
          aDato = #tagm0033#0 + aDato;

          || Grabamos la linea
          |XGRABA nFd,aDato;

          || Grabamos un salto de linea
          aDato = &13 + &10;
          |XGRABA nFd,aDato;

|FPRC;



||__________proceso al final del bucle
|PROCESO tagm0033_3;
     || Cerramos el fichero txt (taglobarras.txt)
     |XCIERRA nFd;
|FPRC;


|| Recorre tagm0033 para generar taglobarras.txt
|DEFBUCLE tagm0033;
     #tagm0033#1;
     ;
     INICIO;
     FINAL;
     ;
     tagm0033_1,tagm0033_2,NULL,NULL,tagm0033_3;
|FIN;


||****** FIN BARRAS  ****************************************************
||*************************************************************************

|PROCESO tagm0021Ini;                  || artclien.txt
     aPath = #tagmpara#1; |QBF aPath;
     |MKDIR aPath;
     aDestino = aPath + "artclien.txt";
     |XABRE "WB",aDestino,nFd;
     |SI FSalida < 0;
          aAlfa = "0000ERROR AL ABRIR FICHERO " + aDestino;
          |MENAV aAlfa;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO tagm0021;
     |DDEFECTO #19;
     #19#0 = #21#2;
     |LEE 000#19=;
     |SI #19#2 < #0#6; |O #19#2 > #0#7; |ACABA; |FINSI;

     |SI #19#6= 0; |Y #19#185 = 0; |ACABA; |FINSI;

     |DDEFECTO #24;
     #24#0 = #21#0;
     |LEE 000#24=;
     |SI #24#25 < #0#2; |O #24#25 > #0#3; |ACABA; |FINSI;

     aDato = #24#0;
     |XGRABA nFd, aDato;

     nSwMedi = 1;
     |HAZ agifa019_2;
     nSwMedi = 0;
|FPRC;

|PROCESO tagm0021Fin;
     |XCIERRA nFd;
|FPRC;

|DEFBUCLE tagm0021;
     #21#2;
     ;
     #0#0, #0#4;
     #0#1, #0#5;
     ;
     tagm0021Ini, tagm0021, NULL, NULL, tagm0021Fin;
|FIN;

|PROCESO GeneraFicheros;
     |BUCLE agifa024;   ||Bucle clientes
     |BUCLE agifa019;   ||Bucle articulos
     |BUCLE tagm0033;

     |ABRE #24;
     |ABRE #19;
     |BUCLE tagm0021;
     |CIERRA #19;
     |CIERRA #24;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO Contador;
     aSerie = #1#2;

     #17#0 = "A";
     #17#2 = aSerie;
     #17#1 = 999999;
     |LEE 000#17];
     |SI FSalida = 0;
          |LEE 000#17a;
     |SINO;
          |LEE 000#17u;
     |FINSI;
     |SI FSalida = 0; |Y #17#0 = "A"; |Y  #17#2 = aSerie;
          nConta = #17#1 + 1;
     |SINO;
          nConta = 1;
     |FINSI;
|FPRC;

|PROCESO Cabecera;
     |ABRE #69;
     #69#0 = #2#0;
     |LEE 000#69=;
     aUsuario1 = #69#2;
     |DDEFECTO #24;
     #24#0 = #2#1;
     |LEE 000#24=;

     |HAZ Contador;

     |LIBERA #17;
     |DDEFECTO #17;
     #17#0 = "A";
     #17#1 = nConta;
     #17#2 = aSerie;
     #17#3 = fFecha;
     #17#4 = #24#0;
     #17#5 = #24#2;
     #17#10 = #24#25;
     #17#11 = #24#37;
     #17#12 = #24#38;
     #17#13 = #24#156;
     #17#42 = #2#0;
     #17#43 = aUsuario1;
     |GRABA 020#17b;
|FPRC;

|PROCESO Precio;
     fed_dt = fFecha;
     art_dt = #19#0;   || Articulo.
     cli_dt = #2#1;   || Cliente..
     fam_dt = #19#2;  || Familia.
     iva_dt = #19#30;  || Tipo Iva.
     dtos_2 = 0;      || Descuento 2.
     dto_pt = 0;      || Descuento Ptas.
     dtos_1 = 0;      || Descuento 1.
     pvp_ve = 0;      || Precio Venta.
     tarifa = #24#39;  || Tarifa Cliente....
     gru_dt = #24#158; || Grupo Cliente.
     nPromo = 0;
     uni_dt = #18#6;

     enMensaje = 0;
     aParam = "";
     eaSerie = #18#2;
     enDirEnt = 1;

     |HAZ calcdtos;              || Calculo Dtos.....
|FPRC;

|PROCESO Linea;
     |DDEFECTO #19;
     #19#0 = #2#4;
     |LEE 000#19=;

     |DDEFECTO #18;
     #18#0 = #17#0;
     #18#1 = #17#1;
     #18#2 = #17#2;
     #18#3 = nLinea;

     #18#4 = #2#4;
     #18#5 = #2#5;
     #18#6 = #2#6;
     #18#12 = #2#7;
     #18#15 = #2#7;
     |HAZ LosMetros;
     #18#13 = #2#8;
     #18#14 = #2#9;
     nUni2 = 0;

     |SI #19#179 = "S"; ||Doble Stock
          #38#0 = #19#201;
          |LEE 020#38=;
          |SI FSalida = 0;
               |SI #38#8 = 1; nUni2 = #18#6 * #18#12; |FINSI;
               |SI #38#8 = 2; nUni2 = #18#6 * #18#12*#18#13; |FINSI;
               |SI #38#8 = 3; nUni2 = #18#6 * #18#12*#18#13*#18#14; |FINSI;
          |FINSI;
     |FINSI;
     |HAZ Precio;
     #18#7 = pvp_ve - dto_pt;          ||precio
     #18#8 = dtos_1;                   ||%Dto
     #18#9 = #19#30;                   || Tipo iva
     |SI #38#6 = 1; |O #19#179 = "N";
          #18#10 = ((#18#6 * #18#7)!nDeci) < #18#8; ||Importe
     |SINO;
          #18#10 = ((nUni2 * #18#7)!nDeci)< #18#8; ||Importe
     |FINSI;
     #18#10 = #18#10 ! nDeci;
     #18#11 = 1;                       ||Almacen
     |GRABA 020#18n;
|FPRC;

|PROCESO ActCab;
     eaCli = #17#4;
     enTiva = #18#9;
     efFiva = #17#3;
     |HAZ IVACli;

||Bruto
     #17#8 = (#17#8 +. #18#10) ! nDeci;
     nBruto = (((#18#10 < #17#11) < #17#13) < #17#12);

     nError = 1;
     |SI #17#8 < 0; nError = -1; |FINSI;
     #17#8 = #17#8 * nError;

||Dto
     #17#30 = (((#17#8 < #17#11) < #17#13) < #17#12) ! nDeci;
     #17#30 = #17#30 * nError;
     #17#8 = #17#8 * nError;
     #17#30 = #17#8 - #17#30;

||Ivas
     |SI #18#9 = 0;
          #17#14 = (#17#14 +. nBruto) ! nDeci;
     |SINO;
          nCamBase = #18#9 - 1 + 15;
          nCamIva = #18#9 - 1 + 20;
          nCamRec = #18#9 - 1 + 25;
          #17nCamBase = (#17nCamBase +. nBruto) ! nDeci;
          #17nCamIva = (#17nCamBase %  enIva) ! nDeci;
          |SI #24#47 = "S";
               #17nCamRec = (#17nCamBase % enRec) ! nDeci;
          |FINSI;
     |FINSI;

||T.IVA
     #17#31 = #17#20+#17#21+#17#22+#17#23+#17#24+#17#25+#17#26+#17#27+#17#28+#17#29;
     #17#31 = #17#31 ! nDeci;

||Total
     #17#9 = (#17#8 - #17#30 + #17#31) ! nDeci;

     |GRABA 020#17a;
|FPRC;

|PROCESO tagzlins;
     |SI aCli ! #2#1; |O nVuelta ! #2#2; |O nFichero ! #2#10;
          |SI nImpre = 0; |Y aCli ! ""; |PIEINF; |FINSI;
          |HAZ Cabecera;
          aCli = #2#1;
          nVuelta = #2#2;
          nFichero = #2#10;
          nLinea = 0;
     |FINSI;
     nLinea = nLinea + #142#236;
     |HAZ Linea;
     |HAZ ActCab;
     |SI nImpre = 0; |PRINT; |FINSI;
|FPRC;

|DEFBUCLE tagzlins;
     #2#2;
     ;
     INICIO;
     FINAL;
     ;
     NULL, tagzlins;
|FIN;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO Divisas;
     |ABRE #321; |LEE 000#321p; |CIERRA #321;

     |ABRE #324;
     #324#0 = #321#9;
     |LEE 000#324=;
     |CIERRA #324;

     nDeci = #324#7;
|FPRC;

|PROCESO Tipo3;
     |ABRE #1; |LEE 000#1p; |CIERRA #1;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     aAlfa = Usuario;
     |NOME_DAT #2 aAlfa;
     |DELINDEX #2;
     |SI aParametro ! "";
        || Willy     15/09/2005
        ||CONFI "2400SImprimir Documentos Importados ";
        ||nImpre = FSalida;
        nImpre = -1;
        |SI nImpre = 0;
          |IMPRE 0;
          nImpre = FSalida;
          |SI FSalida = 0;
               |INFOR "tagm0017";
               nImpre = FSalida;
               |SI FSalida ! 0;
                    |MENAV "0000No existe informe 'tagm0017'";
                    |FINIMP;
               |FINSI;
          |FINSI;
        |FINSI;
     |SINO;
        |HAZ GeneraFicheros;
     |FINSI;

     |HAZ Lineas;       ||Proceso para las lineas

     |HAZ Divisas;
     fFecha = ~;
     |ABRE #17;
     |ABRE #18;
     |ABRE #19;
     |ABRE #24;
     |ABRE #38;
     |BUCLE tagzlins;
     |CIERRA #38;
     |CIERRA #24;
     |CIERRA #19;
     |CIERRA #18;
     |CIERRA #17;

     |SI nImpre = 0;
          |SI nLinea ! 0;
               |PIEINF;
               |FININF;
          |FINSI;
          |FINIMP;
     |FINSI;

     |DELINDEX #2;
|FPRC;

|| AQUI GUARDAREMOS LOS DATOS INTRODUCIDOS MEDIEANTE EL PROGRAMA----------------------------------------------------------------------------

|PROGRAMA;
     aParametro = PARAMETRO;  |QBF aParametro;

     |SI aParametro ! "";
         |MENSA "0000 Importando Documentos ";
         |DDEFECTO #0;
         |HAZ Tipo3;
         |ACABA;
     |FINSI;

     |CLS;
     |CABEZA "COMUNICACION";
     |PINPA #0#0;
     |ABRE #0;
     |LEE 101#0p;
     |SI FSalida ! 0;    |GRABA 020#0b; |FINSI;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |GRABA 020#0a;
          |HAZ Tipo3;
     |FINSI;
     |LIBERA #0;
     |CIERRA #0;
|FPRO;

|PROCESO LosMetros;
     nUni = 0;
     |ABRE #100;
     #100#0 = #19#3;
     |LEE 000#100=;
     |SI FSalida = 0;
          |PARA i = 1; |SI i [ 20; |HACIENDO i = i + 1;
               |SI #18#12 [ #100i;
                    nUni = #100i;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
     |CIERRA #100;
     |SI nUni ! 0;
          #18#15 = #18#12;
          #18#12 = nUni;
     |FINSI;
|FPRC;
