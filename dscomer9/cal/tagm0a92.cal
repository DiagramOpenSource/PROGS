  ImportaOptiAlta, ImportaOptiModi

|FICHEROS;
     tagm0092 #0;
     tagm0093 #1,MANTE;
     agifa019 #19;
     agifa024 #24;
     tagw0045 #45;  || Tmp Chapado
     tagw0047 #47;  || Tmp Orden
     tagm0094 #94;
     tagm0095 #95;
     dsm00238 #238;
     agifa142 #142;

     referen@;
|FIN;

|VARIABLES;
     nOrden = 0;
     aTmpRef = "";
     aTmp45 = "";
     aTmp47 = "";
     &Tempo = "";
     &eaPath = "";
     &eaFic = "";
     aAlfa = "";
     aFic = "";
     nHandle = 0;
 {90}aValor = "";
     i = 0;
     nComi = 0;
     aLon = "";
     aDato = "";
     nPos = 0;
     aCar = "";
     aComi = "";
     nPrime = 0;
     aNom = "";
     aTipo = "";
     nPrecio = 0;
     nLin = 0;
     nError = 0;
     aHora = "";
     aMinu = "";
     nSw = 0;
     nMinu = 0;
     aSwAlta = "N";
     aDes = "";
     nNume = 0;
     nUni = 0;
     nImpo = 0;
|FIN;

|PROCESO Minutos;
     aLon = aAlfa % A0;
     aMinu = "";
     aHora = "";
     nSw = 0;
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aCar = aAlfa % nPos;
          |SI aCar = ":";
               nSw = 1;
          |SINO;
               |SI nSw = 0;
                    aHora = aHora + aCar;
               |SINO;
                    aMinu = aMinu + aCar;
               |FINSI;
          |FINSI;
     |SIGUE;
     nMinu = (aHora * 60) + aMinu;
|FPRC;

|PROCESO SacaNom;
     aLon = eaFic % A0;
     aNom = "";
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = -(i * 100 + 1)
          aCar = eaFic % nPos;
          |SI aCar = "\"; |O aCar = "/"; |SAL; |FINSI;
          aNom = aCar + aNom;
     |SIGUE;
     aAlfa = aNom;
     aLon = aNom % A0;
     aNom = "";
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aCar = aAlfa % nPos;
          |SI aCar = "."; |SAL; |FINSI;
          aNom = aNom + aCar;
     |SIGUE;
|FPRC;

|PROCESO BorraLineas;
     |BORRA 020#1a;
|FPRC;

|DEFBUCLE BorraLineas;
     #1#1;
     ;
     #0#0, 001;
     #0#0, 999;
     be;
     NULL, BorraLineas;
|FIN;

|PROCESO UltimaLin_1;
     #1#0 = #0#0;
     #1#1 = 999;
     |LEE 000#1];
     |SI FSalida = 0;
          |LEE 000#1a;
     |SINO;
          |LEE 000#1u;
     |FINSI;
     |SI FSalida = 0; |Y #1#0 = #0#0;
          nLin = #1#1 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
     nLin = nLin + #142#236 - 1;
     nPrecio = 0;
|FPRC;

|PROCESO UltimaLin;
     #47#0 = #0#0;
     #47#1 = 999;
     |LEE 000#47];
     |SI FSalida = 0;
          |LEE 000#47a;
     |SINO;
          |LEE 000#47u;
     |FINSI;
     |SI FSalida = 0; |Y #47#0 = #0#0;
          nLin = #47#1 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
     nLin = nLin + #142#236 - 1;
     nPrecio = 0;
|FPRC;

|PROCESO Precio;
     |SI #24#39 = 1; nPrecio = #19#18; |FINSI;
     |SI #24#39 = 2; nPrecio = #19#19; |FINSI;
     |SI #24#39 = 3; nPrecio = #19#20; |FINSI;
     |SI #24#39 = 4; nPrecio = #19#147; |FINSI;
     |SI #24#39 = 5; nPrecio = #19#148; |FINSI;
     |SI #24#39 = 6; nPrecio = #19#149; |FINSI;
|FPRC;

|PROCESO Chapado;
     #95#0 = #47#4;
     |LEE 000#95];
     |SI FSalida ! 0; |LEE 000#95u; |FINSI;

     |DDEFECTO #45;
     #45#0 = #95#1;
     |LEE 101#45=;
     |SI FSalida ! 0; |GRABA 020#45b; |FINSI;
     #45#1 = #45#1 + #47#4;
     |GRABA 020#45a;
     |LIBERA #45;
|FPRC;

|PROCESO GraChapado;
     nOrden = 4;
     |HAZ UltimaLin;
     |DDEFECTO #47;
     #47#0 = #0#0;
     #47#1 = nLin;
     #47#2 = #45#0;

     #19#0 = #45#0;
     |LEE 000#19=;
     |SI FSalida = 0;
          #47#3 = #19#1;
          |HAZ Precio;
     |FINSI;
     #47#4 = #45#1;
     #47#5 = nPrecio;
     #47#7 = 1;
     #47#8 = #24#204;

     #238#0 = #19#201;
     |LEE 000#238=;
     |SI FSalida ! 0; |DDEFECTO #238; |FINSI;
     #47#10 = #238#9;
     #47#11 = #238#10;
     #47#12 = #238#11;
     |SI #238#8 = 1; #47#13 = #47#4 * #47#10; |FINSI;
     |SI #238#8 = 2; #47#13 = #47#4 * #47#10 * #47#11; |FINSI;
     |SI #238#8 = 3; #47#13 = #47#4 * #47#10 * #47#11 * #47#12; |FINSI;
     |SI #238#6 = 1;
          nImpo = #47#4 * #47#5;
     |SINO;
          nImpo = #47#4 * #47#13;
     |FINSI;
     nImpo = nImpo - (nImpo * #47#8 / 100);
     nImpo = nImpo - (nImpo * #47#9 / 100);
     #47#6 = nImpo;
     #47#14 = nOrden;
     |GRABA 020#47n;
|FPRC;

|DEFBUCLE GraChapado;
     #45#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, GraChapado;
|FIN;

|PROCESO RedonArriba;
     nNume = nUni ! 0;
     |SI nNume ! nUni;
          |SI nNume < nUni;
               nNume = nNume + 1;
          |FINSI;
          nUni = nNume;
     |FINSI;
|FPRC;

|PROCESO GrabaOpti;
     |SI aSwAlta = "S";
          |SI nPrime = 0;
               nPrime = 1;
               |HAZ SacaNom;

               aLon = aNom % A0;       || le quita el ultimo
               nPos = aLon - 1 + 100;  || caracter, la 't'
               aNom = aNom % nPos;

               #0#0 = aNom;
               |LEE 000#0=;
               |SI FSalida = 0;
                    |SI #0#10 = "  ";
                         |SI #0#14 = "S";
                              aAlfa = "0000NPrepedido existente y optimizado : " + #0#0 + ". ¨Continuar?";
                         |SINO;
                              aAlfa = "0000NPrepedido existente, no optimizado : " + #0#0 + ". ¨Continuar?";
                         |FINSI;
                         |CONFI aAlfa;
                         |SI FSalida ! 0;
                              nError = 3;
                              |ACABA;
                         |FINSI;
                    |SINO;
                         |SI #0#10 = "PR";
                              aAlfa = "0000Prepedido existente y pasado a proforma : " + #0#0;
                         |SINO;
                              aAlfa = "0000Prepedido existente y pasado a pedido : " + #0#0;
                         |FINSI;
                         |MENAV aAlfa;
                         nError = 3;
                         |ACABA;
                    |FINSI;
               |FINSI;
               #0#1 = ~;
               |BUCLE BorraLineas;
          |FINSI;
          |SI aValor2 = "Costes de trabajo";
               aAlfa = aValor3; |QBF aAlfa;
               #0#2 = ("000000" + aAlfa) % -106;

               |DDEFECTO #24;
               #24#0 = #0#2;
               |LEE 000#24=;
               |SI FSalida ! 0;
                    aAlfa = "0000No existe cliente: " + #0#2;
                    |MENAV aAlfa;
                    nError = 2;
               |FINSI;

               #0#3 = #24#25;
               #0#4 = #24#20;
               #0#5 = #24#37;
               #0#6 = #24#38;
               #0#7 = #24#156;
               #0#8 = #24#202;
          |FINSI;
     |FINSI;

     |SI aValor1 = "%1";
          aTipo = "";
          |SI aValor2 = "Tablero"; |O aValor2 = "Canteado";
                    |O aValor2 = "Operación";
               aTipo = aValor2;
          |FINSI;
     |FINSI;
     |SI aValor1 = "%3"; |Y aTipo = "Tablero";
          nOrden = 1;
          |HAZ UltimaLin;
          |DDEFECTO #47;
          #47#0 = #0#0;
          #47#1 = nLin;
          #47#2 = aValor2;

          #19#0 = #47#2;
          |LEE 000#19=;
          |SI FSalida = 0;
               #47#3 = #19#1;
               |HAZ Precio;
          |FINSI;
          #47#4 = aValor4;
          #47#5 = nPrecio;
          #47#7 = 1;
          #47#8 = #24#204;

          #238#0 = #19#201;
          |LEE 000#238=;
          |SI FSalida ! 0; |DDEFECTO #238; |FINSI;
          #47#10 = #238#9;
          #47#11 = #238#10;
          #47#12 = #238#11;
          |SI #238#8 = 1; #47#13 = #47#4 * #47#10; |FINSI;
          |SI #238#8 = 2; #47#13 = #47#4 * #47#10 * #47#11; |FINSI;
          |SI #238#8 = 3; #47#13 = #47#4 * #47#10 * #47#11 * #47#12; |FINSI;
          |SI #238#6 = 1;
               nImpo = #47#4 * #47#5;
          |SINO;
               nImpo = #47#4 * #47#13;
          |FINSI;
          nImpo = nImpo - (nImpo * #47#8 / 100);
          nImpo = nImpo - (nImpo * #47#9 / 100);
          #47#6 = nImpo;
          #47#14 = nOrden;
          |GRABA 020#47n;
     |FINSI;
     |SI aValor1 = "%3"; |Y aTipo = "Canteado";
          nOrden = 3;
          |HAZ UltimaLin;
          |DDEFECTO #47;
          #47#0 = #0#0;
          #47#1 = nLin;
          #47#2 = aValor2;

          #19#0 = #47#2;
          |LEE 000#19=;
          |SI FSalida = 0;
               #47#3 = #19#1;
               |HAZ Precio;
          |FINSI;
          nUni = aValor4; |HAZ RedonArriba;
          #47#4 = nUni;
          #47#5 = nPrecio;
          #47#7 = 1;
          #47#8 = #24#204;

          #238#0 = #19#201;
          |LEE 000#238=;
          |SI FSalida ! 0; |DDEFECTO #238; |FINSI;
          #47#10 = #238#9;
          #47#11 = #238#10;
          #47#12 = #238#11;
          |SI #238#8 = 1; #47#13 = #47#4 * #47#10; |FINSI;
          |SI #238#8 = 2; #47#13 = #47#4 * #47#10 * #47#11; |FINSI;
          |SI #238#8 = 3; #47#13 = #47#4 * #47#10 * #47#11 * #47#12; |FINSI;
          |SI #238#6 = 1;
               nImpo = #47#4 * #47#5;
          |SINO;
               nImpo = #47#4 * #47#13;
          |FINSI;
          nImpo = nImpo - (nImpo * #47#8 / 100);
          nImpo = nImpo - (nImpo * #47#9 / 100);
          #47#6 = nImpo;
          #47#14 = nOrden;
          |GRABA 020#47n;
          |HAZ Chapado;
     |FINSI;
     |SI aValor1 = "%3"; |Y aTipo = "Operación";
               |Y aValor2 = "Seccª";
          nOrden = 2;
          |HAZ UltimaLin;
          |DDEFECTO #47;
          #47#0 = #0#0;
          #47#1 = nLin;
          #47#2 = "002CORTE";

          #19#0 = #47#2;
          |LEE 000#19=;
          |SI FSalida = 0;
               #47#3 = #19#1;
               |HAZ Precio;
          |FINSI;

          aAlfa = aValor4; |HAZ Minutos;
          #47#4 = nMinu;
          #47#5 = nPrecio;
          #47#7 = 1;
          #47#8 = #24#204;

          #238#0 = #19#201;
          |LEE 000#238=;
          |SI FSalida ! 0; |DDEFECTO #238; |FINSI;
          #47#10 = #238#9;
          #47#11 = #238#10;
          #47#12 = #238#11;
          |SI #238#8 = 1; #47#13 = #47#4 * #47#10; |FINSI;
          |SI #238#8 = 2; #47#13 = #47#4 * #47#10 * #47#11; |FINSI;
          |SI #238#8 = 3; #47#13 = #47#4 * #47#10 * #47#11 * #47#12; |FINSI;
          |SI #238#6 = 1;
               nImpo = #47#4 * #47#5;
          |SINO;
               nImpo = #47#4 * #47#13;
          |FINSI;
          nImpo = nImpo - (nImpo * #47#8 / 100);
          nImpo = nImpo - (nImpo * #47#9 / 100);
          #47#6 = nImpo;
          #47#14 = nOrden;
          |GRABA 020#47n;
     |FINSI;
/*
     |SI aValor1 = "%3"; |Y aValor2 = "Canteadora";
          nOrden = 5
          |HAZ UltimaLin;
          |DDEFECTO #47;
          #47#0 = #0#0;
          #47#1 = nLin;
          #47#2 = "Canteadora";

          #19#0 = #47#2;
          |LEE 000#19=;
          |SI FSalida = 0;
               #47#3 = #19#1;
               |HAZ Precio;
          |FINSI;

          aAlfa = aValor4; |HAZ Minutos;
          #47#4 = nMinu;

          #47#5 = nPrecio;
          #47#7 = 1;
          #47#8 = #24#204;

          #238#0 = #19#201;
          |LEE 000#238=;
          |SI FSalida ! 0; |DDEFECTO #238; |FINSI;
          #47#10 = #238#9;
          #47#11 = #238#10;
          #47#12 = #238#11;
          |SI #238#8 = 1; #47#13 = #47#4 * #47#10; |FINSI;
          |SI #238#8 = 2; #47#13 = #47#4 * #47#10 * #47#11; |FINSI;
          |SI #238#8 = 3; #47#13 = #47#4 * #47#10 * #47#11 * #47#12; |FINSI;
          |SI #238#6 = 1;
               nImpo = #47#4 * #47#5;
          |SINO;
               nImpo = #47#4 * #47#13;
          |FINSI;
          nImpo = nImpo - (nImpo * #47#8 / 100);
          nImpo = nImpo - (nImpo * #47#9 / 100);
          #47#6 = nImpo;
          #47#14 = nOrden;
          |GRABA 020#47n;
     |FINSI;
*/
|FPRC;

|PROCESO LineaOpti;
     IaValor = aValor1<-;
     |PARA i = 1; |SI i [ 90; |HACIENDO i = i + 1;
          aValor = "";
          IaValor = IaValor + 1;
     |SIGUE;

     nComi = 0;
     aComi = &34;

     IaValor = aValor1<-;
     aLon = aDato % A0;
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aCar = aDato % nPos;
          |SI aCar = aComi;
               |SI nComi = 0;
                    nComi = 1;
               |SINO;
                    nComi = 0;
               |FINSI;
          |SINO;
               |SI aCar = ","; |Y nComi = 0;
                    aAlfa = aValor; |QBF aAlfa;
                    aValor = aAlfa;
                    IaValor = IaValor + 1;
               |SINO;
                    aValor = aValor + aCar;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO PasaTempo;
     |HAZ UltimaLin_1;
     |DDEFECTO #1;
     |PARA i = 0; |SI i [ 13; |HACIENDO i = i + 1;
          #1i = #47i;
     |SIGUE;
     #1#1 = nLin;
     |GRABA 020#1n;
|FPRC;

|DEFBUCLE PasaTempo;
     #47#2;
     ;
     INICIO;
     FINAL;
     ;
     NULL, PasaTempo;
|FIN;

|PROCESO ImportaOpti;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     nError = 1;
     nPrime = 0;
     |XABRE "C", eaFic, nHandle;
     |SI FSalida ] 0;
          |HAZ CreaTempo; |NOME_DAT #45 Tempo; |DELINDEX #45; aTmp45 = Tempo;
          |HAZ CreaTempo; |NOME_DAT #47 Tempo; |DELINDEX #47; aTmp45 = Tempo;
          |ABRE #47;
          |ABRE #45;
          |ABRE #95;
          |ABRE #19;
          |ABRE #24;
          |ABRE #238;

          |XLEE nHandle, 250, aDato;
          |PARA; |SI FSalida > 0; |HACIENDO;
               |HAZ LineaOpti;
               |HAZ GrabaOpti;
               |SI nError ! 1; |SAL; |FINSI;
               |XLEE nHandle, 250, aDato;
          |SIGUE;
          |XCIERRA nHandle;

          |SI nError = 1;
               #47#0 = #0#0;
               #47#1 = 1;
               |LEE 000#47];
               |SI FSalida = 0; |Y #47#0 = #0#0;
                    |BUCLE GraChapado;
                    nError = 0;
               |FINSI;
||CONSULTA_CLAVE #2#47;
               |BUCLE PasaTempo;

               aDes = eaPath + "importados/";
               |RMKDIR aDes;
               |HAZ SacaNom;
               aDes = aDes + aNom + ".exd";
               |RCOPIA_FICHERO eaFic, aDes;
               |SI FSalida = 0;
                    |RFBORRA eaFic;
               |SINO;
                    |MENAV "0000Error al mover fichero a 'importados'...";
               |FINSI;

               #0#14 = "S"; || Optimizado

               |PINDA #0#0;
               |SI aSwAlta = "S";
                    |PTEC 815;
                    |PTEC 802;
               |FINSI;
          |FINSI;

          |CIERRA #238;
          |CIERRA #24;
          |CIERRA #19;
          |CIERRA #95;
          |CIERRA #45;
          |CIERRA #47;
          Tempo = aTmp45; |DELINDEX #45; |HAZ BoraTempo;
          Tempo = aTmp47; |DELINDEX #47; |HAZ BoraTempo;

     |SINO;
          |MENAV "0000Error al abrir el fichero...";
     |FINSI;
     FSalida = nError;
|FPRC;

|PROCESO ImportaOptiAlta;
     eaPath = #94#8; |QBF eaPath;
     |HAZ DsSelect;

     aAlfa = eaPath % -101;
     |SI aAlfa ! "/"; |Y aAlfa ! "\"; eaPath = eaPath + "/"; |FINSI;

     |SI eaFic ! "";
          |HAZ DecimalesBase;
          aSwAlta = "S";
          |HAZ ImportaOpti;
     |FINSI;
|FPRC;

|PROCESO ReponLineas;
     |HAZ UltimaLin_1;
     |SALVA_DATOS #referen@;
     |REPON_DATOS #1;
     #1#1 = nLin;
     |GRABA 020#1n;
|FPRC;

|DEFBUCLE ReponLineas;
     #referen@#1002;
     ;
     #0#0, 001;
     #0#0, 999;
     ;
     NULL, ReponLineas;
|FIN;

|PROCESO CopiaLineas;
     |SALVA_DATOS #1;
     |REPON_DATOS #referen@;
     |GRABA 020#referen@.n;

     |BORRA 020#1a;
|FPRC;

|DEFBUCLE CopiaLineas;
     #1#1;
     ;
     #0#0, 001;
     #0#0, 999;
     be;
     NULL, CopiaLineas;
|FIN;

|PROCESO ImportaOptiModi;
     eaPath = #94#8; |QBF eaPath;
     aAlfa = eaPath % -101;
     |SI aAlfa ! "/"; |Y aAlfa ! "\"; eaPath = eaPath + "/"; |FINSI;

     eaFic = eaPath + #0#0; |QBF eaFic;
     eaFic = eaFic + "t.exd"; || a¤ade la 't' final + la extension

     |DDEF aAlfa;
     aAlfa = aAlfa + "tagm0093";
     |CARGA_DEF aAlfa, referen@;
     |HAZ CreaTempo;
     |NOME_DAT #referen@#Tempo#; |DELINDEX #referen@; aTmpRef = Tempo;
     |ABRE #referen@;

     |SI #0#13 = "S";
          || A¤ade lineas
          |BUCLE CopiaLineas;
     |SINO;
          |BUCLE BorraLineas
     |FINSI;

     aSwAlta = "N";
     |HAZ ImportaOpti;

     |BUCLE ReponLineas;
     |CIERRA #referen@;
     Tempo = aTmpRef; |HAZ BoraTempo; |DELINDEX #referen@;
     |DESCARGA_DEF #referen@;
|FPRC;
