|FICHEROS;
     tmp00000 #0;
     coima001 #1;
     dsm00003 #3;
     coima006@ #6;
     coima007@ #7;
     coima022 #22;
     coima023 #23;
     agifa024 #24;
     agifa025 #25;
     agifa019 #19;
     dsm00046 #46;
     agifa049 #49;
     agifa073 #73;
     agifa104 #104;
     coima024 #124;
     agifa142 #142;
     agifa321 #321;
     agifa324 #324;
     agifa048 #480;
     dsm00113;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     aTmp0 = "";
     &Tempo = "";
     &enModoCoimasa = 0;
     &enFormaCoimasa = 0;
     &eaImpresora = "";
     {1}aBaseLocal = "";
     &num_ped = 0;
     &ser_ped = "";
     aIP = "";
     aServidor = "";
     aFrom = "";
     aTo = "";
     aSubject = "";
     aMensaje = "";
     aDjunto = "";
     aPath = "";
     aAlfa = "";
     &aMoneda = "";
     &aDivisa = "";
     &fed_dt = @;   || Fecha....
     &art_dt = "";  || Articulo.
     &cli_dt = "";  || Cliente..
     &fam_dt = "";  || Familia.
     &iva_dt = 0;   || Tipo Iva.
     &dtos_2 = 0;   || Descuento 2.
     &dto_pt = 0;   || Descuento Ptas.
     &dtos_1 = 0;   || Descuento 1.
     &pvp_ve = 0;   || Precio Venta.
     &tarifa = 0;   || Tarifa Cliente.
     &quedto = 0;   || 1=cli./art, 2=cli./familia, 3=cli./subfam.
     &gru_dt = "";  || Grupo Cliente.
     &uni_dt = 0;
     &enMensaje = 0;
     &aParam    = "";
     &nPromo    = 0;

     &enSwMenu = 0;
     &enDescuento1 = 0;
     &enDescuento2 = 0;
     &eaTComision  = "";
     &enComision   = 0;

     aCli = "";
     nDir = "";
     aRep = "";
     aPeComple = "";
     aColComple = "";
     aSubfam = "";
     nLin = 0;
     nLinKit = 0;
     nImpo = 0;
     nForma = 1;
     fmes = "";
     mes = 0;
     &eaTag = "";
     nCalc = 0;
     aEmail = "";
     aMailRep1 = "";
     aMailRep2 = "";
|FIN;

|PROCESO RecalPed;
     #104#25 = #0#0;
     #104#0 = #0#1;
     |LEE 121#104=;
     |SI FSalida = 0;
          |HAZ CalCabAgifa104;
          |LIBERA #104;
     |FINSI;
|FPRC;

|DEFBUCLE RecalPed;
     #0#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, RecalPed;
|FIN;

|PROCESO CalcConIva;
     |ABRE #dsm00113;
     #dsm00113#0 = #agifa104#4;
     #dsm00113#1 = #agifa073#14;
     |LEE 000#dsm00113.=;
     |SI FSalida = 0;
        nCalc = #agifa073#11 % #dsm00113#3;
        |SI #agifa024#47 = "S";
           nCalc = nCalc + (#agifa073#11 % #dsm00113#4);
        |FINSI;
     |SINO;

        enTiva = #agifa073#14;
        efFiva = #agifa104#1;
        |HAZ SacaIVA;

         nCalc = #agifa073#11 % enIva;
        |SI #agifa024#47 = "S";
              nCalc = nCalc + (#agifa073#11 % enRec);
        |FINSI;
     |FINSI;
     |CIERRA #dsm00113;

     nImpo = nImpo + (#agifa073#11 + nCalc);
|FPRC;

|DEFBUCLE CalcConIva;
#agifa073#1;
;
#agifa104#25, #agifa104#0,001;
#agifa104#25, #agifa104#0,999;
;
NULL,CalcConIva;
|FIN;

|PROCESO ActCli;
     #19#0 = #73#2;
     |LEE 020#19=;

     #24#0 = #104#4;
     |LEE 121#24=;
     |SI FSalida = 0;
          |SI #19#194 = 2;
               nImpo = ((((#73#44 * #73#6) < #73#8) < #73#29) < #104#5) < #104#17;
          |SINO;
               nImpo = ((((#73#5 * #73#6) < #73#8) < #73#29) < #104#5) < #104#17;
          |FINSI;
          |SI #142#115 = "S";
               nImpo = nImpo < #104#6;
          |FINSI;
          nImpo = nImpo * nForma;
          fmes = #104#1 % A402;
          mes = fmes - 1;
          mes = mes * 3;
          mes = mes + 114;
          #24mes = #24mes   + nImpo;     || VENTA.
          #24#150 = #24#150 + nImpo;
          |GRABA 020#24a;

          eaCliente = #agifa104#4;
          efFecha = #agifa104#1;
          enImpCliPed = nImpo;
          |HAZ AcumulaCli;
     |FINSI;
|FPRC;

|PROCESO Final;
     |SI aCli = ""; |ACABA; |FINSI;

     |HAZ CalCabAgifa104;

     |ABRE #24;
     |ABRE #19;
     |BUCLELIN 2 ActCli #104;
     |CIERRA #24;
     |CIERRA #19;

     nImpo = 0; |BUCLE CalcConIva;
     eaTag = "PE";  |HAZ Riesgos;

     |SI #22#16 = "N"; |ACABA; |FINSI;

     aIP = ""; |IP_REMOTO aIP;
     |SI aIP = "";
          |DFICE aAlfa;
          aDjunto = aAlfa + #104#25 + "_" + (("000000" + #104#0)%-106)+ ".pdf";
          |QBT aDjunto;
          eaImpresora = "CrystalReport;" + aDjunto;
          ser_ped = #104#25;
          num_ped = #104#0;
          |SUB_EJECUTA_NP "agifa105";
     |SINO;
          |DFICE aAlfa;
          aDjunto = aAlfa + #104#25 + "_" + (("000000" + #104#0)%-106)+ ".pdf";
          |QBT aDjunto;
          |ESPECIFICA "RBASS", aBaseLocal;
          aAlfa = aBaseLocal1 + #104#25 + "_" + (("000000" + #104#0)%-106)+ ".pdf";
          |QBT aAlfa;
          eaImpresora = "CrystalReport;" + aAlfa;
          ser_ped = #104#25;
          num_ped = #104#0;
          |SUB_EJECUTA_NP "agifa105";
          |RECIBE_FICHERO aAlfa, aDjunto;
          |RFBORRA aAlfa;
     |FINSI;

     aIP = "";
     |SI #22#8 = "L";
          |IP_REMOTO aIP;
     |SINO;
          |SI #22#8 = "S";
               |IP_LOCAL aIP;
          |SINO;
               aIP = #22#7; |QBF aIP;
          |FINSI;
     |FINSI;
     aServidor = #22#14; |QBF aServidor;
     aFrom = #22#15; |QBF aFrom;
     aTo = aEmail;
     aSubject = "Confirmación pedido web.";
     aMensaje = "Adjunto pedido:" + #104#25 + "/" + (("000000" + #104#0)%-106);

     aMensaje = "Le adjuntamos PDF con la confirmacion de su pedido realizado a traves de nuestra web.";
     aMensaje = aMensaje + &13 + "Reciba un cordial saludo.";
     aMensaje = aMensaje + &13 + "Coimasa.";

     |XABRE "E", aDjunto, 0;
     |SI FSalida = 0;
          |SI aTo ! "";
               |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
          |FINSI;

          aTo = aMailRep1; |QBF aTo;
          |SI aTo ! "";
               |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
          |FINSI;
          aTo = aMailRep2; |QBF aTo;
          |SI aTo ! "";
               |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
          |FINSI;
     |SINO;
          aDjunto = "Sin pdf";
          aSubject = "NO EXISTE EL PDF. Confirmación pedido web.";
          aTo = "jorge.diaz@diagram.es";
          |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
     |FINSI;
|FPRC;

|PROCESO Comi;
     enDescuento1 = #73#8;
     enDescuento2 = #73#29;
     eaTComision  = #73#17;
     eaCliente    = #104#4;
     eaRepre      = #104#7;
     eaArticulo   = #73#2;
     efFecha      = #104#1;
     eaSerie      = #73#28;
     enDirEnt = #104#57;
     enAlmacen = #73#3;
     |HAZ Comisiones;
|FPRC;

|PROCESO Precio;
     fed_dt = #104#1;   || Fecha....
     art_dt = #73#2;   || Articulo.
     cli_dt = #104#4;  || Cliente..
     fam_dt = #73#18;  || Familia.
     iva_dt = #19#30;  || Tipo Iva.
     dtos_2 = 0;      || Descuento 2.
     dto_pt = 0;      || Descuento Ptas.
     dtos_1 = 0;      || Descuento 1.
     pvp_ve = 0;      || Precio Venta.
     tarifa = #24#39;  || Tarifa Cliente....
     gru_dt = #24#158; || Grupo Cliente.
     |SI #73#36 ! 0;
           uni_dt = #73#36;
     |SINO;
           uni_dt = #73#5;
     |FINSI;
     nPromo = #104#56;
     enMensaje = 0;
     aParam = "";
     eaSerie = #73#28;
     enDirEnt = #104#57;
     |SI #19#176 = "S";  enMensaje = 1;  |FINSI;
     enAlmacen = #73#3;
     |HAZ calcdtos;
|FPRC;

|PROCESO Cabecera;
     |DDEFECTO #3;
     |ABRE #3;
     #3#0 = #124#2;
     #3#1 = #124#3;
     |LEE 000#3=;
     |CIERRA #3;

     |LIBERA #104;
     |DDEFECTO #104;
     #104#25 = #22#10;
     enSwMenu = 1;
     |HAZ ContaPV7;
     #104#1 = ~;    || #23#2;
     #104#2 = #124#16;
     #104#3 = #124#15;
     #104#4 = #24#0;
     #104#5 = #24#37;
     #104#6 = #24#38;
     #104#7 = #25#0;
     #104#8 = #24#2;
     #104#9 = #24#20;

     #104#57 = #3#1;
     #104#19 = #3#10;
     #104#14 = #3#2;
     #104#20 = #3#3;
     #104#21 = #3#7;
     #104#59 = #3#6;

     #104#16 = #25#7;
     #104#17 = #24#156;
     #104#18 = #24#4;
     #104#22 = #24#47;
     #104#23 = #24#41;
     #104#26 = "WEB";
     #104#35 = #24#192;
     |ABRE #324;
     #324#0 = #104#35;
     |LEE 000#324=;
     #104#36 = #324#2;
     #104#37 = #24#193;
     #104#40 = #321#9;
     #324#0 = #104#40;
     |LEE 000#324=;
     #104#41 = #324#2;
     #104#60 = #24#202;
     #104#64 = #24#15;
     |CIERRA #324;
     #104#52 = #24#167;

     #104#53 = #124#12;
     #104#54 = #124#13;
     #104#55 = #124#14;
     |GRABA 020#104b;

     #0#0 = #104#25;
     #0#1 = #104#0;
     |GRABA 000#0n;

     aDivisa = #104#35;
     aMoneda = #104#37;
     |HAZ Divisas104;

     #6#0 = #104#25;
     #6#1 = #104#0;
     |SI #24#28 = "S"; |Y #1#27 ! 0;
          #6#2 = #1#27;
     |SINO;
          #6#2 = #22#12;
     |FINSI;
     #6#3 = #124#7;
     #6#4 = #124#8;
     #6#5 = "S";
     |GRABA 000#6n;
     |SI FSalida ! 0;
          |BORRA 000#6c;
          |GRABA 020#6n;
     |FINSI;

     aAlfa = #104#53 + #104#54 + #104#55; |QBT aAlfa;
     |SI aAlfa ! "";
          |HAZ EnviaMail;
     |FINSI;
|FPRC;

|PROCESO Kit;
     nLinKit = nLinKit + 1;
     |DDEFECTO #46;
     #46#0 = #73#28;
     #46#1 = #73#0;
     #46#2 = #73#1;
     #46#3 = #49#2;
     #46#4 = #49#9;
     #46#5 = #49#4;
     #46#6 = nLinKit;
     #46#8 = #19#9;
     |GRABA 020#46n;
|FPRC;

|PROCESO precio_divisa;
     #73#38 = #73#6 / #104#41 * #104#36;
     |SI #104#37 = "D";
          #73#6 = #73#38 / #104#36 * #104#41;
     |SINO;
          #73#38 = #73#6 / #104#41 * #104#36
     |FINSI;
     |SI #104#37 = "D";
          #73#40 = #73#6;
     |SINO;
          #73#40 = #73#38;
     |FINSI;
|FPRC;

|PROCESO Lineas;
     |DDEFECTO #19;
     |ABRE #19;
     #19#0 = #124#5;
     |LEE 000#19=;
     |CIERRA #19;

     nLin = nLin + 1;
     |DDEFECTO #73;
     #73#28 = #104#25;
     #73#0 = #104#0;
     #73#1 = nLin;
     #73#2 = #19#0;
     #73#3 = #22#11;
     #73#4 = #19#1;
     #73#5 = #124#6
     |HAZ Precio;
     #73#6 = pvp_ve - dto_pt;       || Precio
     #73#8 = dtos_1;
     #73#29 = dtos_2;
     |HAZ precio_divisa;
     |HAZ Comi;
     #73#10 = enComision;      || Comi
     #73#13 = #104#2;
     |SI #24#28 = "S";   || Exportacion
          #73#14 = 0;
     |SINO;
          #73#14 = #19#30;
     |FINSI;
     #73#16 = #104#7;
     #73#17 = #25#7;
     #73#18 = #19#2;
     #73#19 = #24#4;
     #73#20 = #104#4;
     #73#22 = #22#9;
     #73#23 = #104#5;
     #73#24 = #104#6;
     #73#25 = #104#17;
     #73#26 = #104#9;
     #73#42 = #73#5;
     |GRABA 020#73n;

     #480#0 = #73#2;
     |LEE 000#480=;
     |SI FSalida = 0; |Y #480#33 = "K";      || solo para kits
          |ABRE #46;
          nLinKit = 0;
          |BUCLELIN 2 Kit #480;
          |CIERRA #46;
     |FINSI;

     enForma = 1;
     |HAZ AcumulaPV;

     #7#0 = #73#28;
     #7#1 = #73#0;
     #7#2 = #73#1;
     #7#3 = "N";
     #7#9 = #104#4;
     |GRABA 000#7n;
     |SI FSalida ! 0;
          |BORRA 000#7c;
          |GRABA 020#7n;
     |FINSI;

     enModoCoimasa = 1;
     enFormaCoimasa = 1;
     |HAZ CtrlPrioridaReservarPed;

     || F.Calculo Aprox. Servicio
     eaArticulo = #73#2;
     enAlmacen = #73#3;
     efFecha = #104#62;
     |SI #73#13 > efFecha; efFecha = #73#13; |FINSI;
     eaSerie = #73#28;
     enCodigo = #73#0;
     enLinea  = #73#1;
     enUnidades = #73#5;
     |SUB_EJECUTA_NP "coimz021";
|FPRC;

|PROCESO coima024;
     #23#0 = #124#0;
     |LEE 000#23=;

     |ABRE #24;
     #24#0 = #124#2;
     |LEE 000#24=;
     |SI FSalida ! 0; |DDEFECTO #24; |FINSI;
     |CIERRA #24;

     |DDEFECTO #25;
     |ABRE #25;
     #25#0 = #124#4;
     |LEE 000#25=;
     |SI #25#57 = "S";
          |DDEFECTO #25;
          #25#0 = #24#25;
          |LEE 000#25=;
     |FINSI;
     |CIERRA #25;

     |SI aCli ! #124#2; |O nDir ! #124#3; |O aRep ! #25#0;
               |O aPeComple ! #124#7; |O aColComple ! #124#8;
               |O aSubfam ! #124#10;
          |HAZ Final;

          aMailRep1 = #25#62;
          aMailRep2 = #25#64;

          |ABRE #24;
          #24#0 = #124#2;
          |LEE 000#24=;
          |SI FSalida ! 0; |DDEFECTO #24; |FINSI;
          |CIERRA #24;
          |HAZ Cabecera;
          aCli = #124#2;
          nDir = #124#3;
          aRep = #25#0;
          aPeComple = #124#7;
          aColComple = #124#8;
          aSubfam = #124#10;
          aEmail = #124#11; |QBF aEmail;
          nLin = 0;
     |FINSI;
     |HAZ Lineas;

     #124#9 = "S";
     |GRABA 020#124a;
     |LIBERA #124;
|FPRC;

|DEFBUCLE coima024;
     #124#2;
     ;
     "N", "      ", 0001, "  ", " ", " ", "     ", 00000001;
     "N", "zzzzzz", 9999, "zz", "z", "z", "zzzzz", 99999999;
     be;
     NULL, coima024;
|FIN;

|PROGRAMA;
     |ABRE #1; |LEE 000#1p; |CIERRA #1;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     |ABRE #321; |LEE 000#321p; |CIERRA #321;
     |ABRE #22; |LEE 000#22p; |CIERRA #22;

     |HAZ CreaTempo; |NOME_DAT #0 Tempo; aTmp0 = Tempo; |DELINDEX #0;
     |ABRE #0;

     |DDEF aPath;
     aAlfa = aPath + "coima006"; |CARGA_DEF aAlfa, coima006@;
     aAlfa = aPath + "coima007"; |CARGA_DEF aAlfa, coima007@;
     |ABRE #6;
     |ABRE #7;

     |ABRET #104;
     |ABRET #73;
     |ABRE #23;
     |ABRE #480;
     |ABRE #46;
     |BUCLE coima024;
     |HAZ Final;
     |CIERRA #46;
     |CIERRA #480;
     |CIERRA #23;
     |CIERRAT #73;
     |CIERRAT #104;

     |CIERRA #6;
     |CIERRA #7;
     |DESCARGA_DEF #coima007@;
     |DESCARGA_DEF #coima006@;

     |ABRE #104;         || No deberia hacer falta, pero dicen
     |BUCLE RecalPed;    || que algunos pedidos no estan calculados !!!
     |CIERRA #104;

     |CIERRA #0; |DELINDEX #0;
     Tempo = aTmp0; |HAZ BoraTempo;
|FPRO;
