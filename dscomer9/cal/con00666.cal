                *** PASE FACTURAS VENTA AL AGICON ***
|FICHEROS;
     con00666 #0;        ||pantalla ventas;
     con00669 #5;        ||Serie para las cuentas especiales
     con00665 #6;        ||control pase;
     agifa134 #7;        ||facturas;
     con00667 #8;        ||trabajo;
     || encocue@ #9;        ||trabajo;
     agifa071 #10;       ||Lineas Albaran;
     agifa060 #11;       ||familias;
     con00649 #15;
     agifa059 #14;       ||Lineas de factura;
     agifa010 #17;       ||Cabecera de albaran;
     || encoemp@ #30;       ||Fichero de enlaces
     || encore@  #31;       ||Recibos enlaces
     agifa024 #32;       ||clientes
     agifa025 #33;       ||Representantes
     agifa142 #41;       ||Parametros Generales

     canempr@ #3;        ||empresas;
     caconce@ #12;       ||conceptos contabilidad;
     caconas@ #13;       ||contados asientos contabilidad;
     caenlac@ #1000;

     con00637 #100;

     agifa321 #333;
     agifa324 #444;
     agifa019 #555;
     agifa007 #777;

     con00002 #602;
     con00625 #625;
     con00626 #626;
     con00641 #641;
     con00642 #642;
     con00603 #603;
     con00606 #606;
     con00611;
     con00610;
     con00004;
     con00008 #608;
     con00683 #609;
     con00703 #610;
     con00696 #696;
     con00648 #648;

     agifa722;
|FIN;

|VARIABLES;
     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;

     nSwNuevo = 0;
     &enNoModif = 0;
     &PRMNT_enError = 0;
     &PRMNT_enVer   = 0;
     &PRMNT_enSwTaller = 0;

     &aMoneda         = "";
     &aDivisa         = "";
     &EURO            = 0;
     &EURODB          = 0;
     &EURODV          = 0;
     &fich_alta       = "";

     &eaEnlace        = "";
     &eaSerieA        = "";
     &enFactura       = 0;
     &enEmpresa       = 0;
     &enPeriodo       = 0;

     nBase            = 0;
     nSw              = 0;
     nSwError         = 0;

     nFactura = 0;
     aFactura = "";

     aDef3     = "";
     aDef9     = "";
     aDef30    = "";
     aDef31    = "";
     aDef12    = "";
     aDef13    = "";
     aMensa    = "";
     aPath     = "";
     aAlfa     = "";
     aAlfa1    = "";
     &swvta = 1;
     &swcom = 0;
     pclient= " ";
     &empre =    0;
     &periodo =  0;
     &cliente = "";
     &repre   = "";
     mes        = " ";
     nSwDesg = 0;
     nSwDesglosa = 0;
     nSwCoste = 0;

     nEmpresa = 0;
     nPeriodo = 0;

     nTipoIva  = 0;
     aTipoDato = "";

     nContPartida = 0;
     nContActual  = 0;

     ivapo      = 0;
     ivava      = 0;
     ivaporte   = 0;
     acuporte   = 0;
     ivavario   = 0;
     acuvario   = 0;
     iva1       = 0;
     iva2       = 0;
     iva3       = 0;
     iva4       = 0;
     iva5       = 0;
     re1        = 0;
     re2        = 0;
     re3        = 0;
     re4        = 0;
     re5        = 0;

     nCalc      = 0;
     nCalc1     = 0;
     nCalc2     = 0;
     nDesde     = 0;
     nHasta     = 0;
     nDec1      = 0;
     nDec2      = 0;
     nAnyo      = 0;
     aTipo      = "";

     impresa    = "S";
     dfamilia   = "  ";
     hfamilia   = "zz";
     dalba      = "000000";
     halba      = "999999";
     sw_pas     = 0;
     y          = 0;
     z          = 0;
     c          = 0;
     digito1    = 0;
     x          = 0;
     importe    = 0;
     niva       = 0;
     lincont    = 0;
     asi        = 0;
     s          = 0;
     fac        = 0;
     fec        = 0;
     sw_nueve   = 0;
     contador   = 0;
     conta      = 0;
     nContBucle = 0;
     digito     = 0;
     pongo      = 0;
     cojo       = 0;
     d_cuen     = "            ";
     h_cuen     = "zzzzzzzzzzzz";
     d          = "D"
     h          = "H";
     n          = "N";
     men1       = "     NO EXISTE EMPRESA !";
     men2       = "     Longitud de Cuenta Fuera de Nivel !";
     path       = "";
     long       = "  ";
     dir_fich   = "";
     &empresa   = "";
     anyo       = "";
     cod_emp1   = "";
     cod_emp2   = "";
     clave1     = "";
     clave2     = "";
     tra1       = 0;
     cod1       = 0;
     cod2       = 0;
     mes1       = "";
     traba1     = "";
     dia1       = "";
     fec1       = @;
     fec2       = @;
     cam        = 0;
     totfac     = 0;
     cue        = "";
     niv        = 0;
     deb        = "";
     imp        = 0;
     diario     = 0;
     fecha      = @;
     docume     = 0;
     asient     = 0;
     cabe       = 0;
     ordant     = 0;
     fecant     = @;
     cueant     = "";
     digant     = 0;
     coaant     = 0;
     desant     = "";
     conant     = "";
     dcoant     = 0;
     serant     = "";
     linea      = 0;
     linefal    = 0;
     cuenta     = "";
     cuentaan   = "";
     nconcep    = "";
     alfa       = "";
     alfa1      = "";
     cojo1      = "";
     arte       = "";
     &dig1      = 0;
     &dig3      = 0;
     &dig4      = 0;
     &dig5      = 0;
     &dig6      = 0;
     &dig7      = 0;
     &dig8      = 0;
     &dig9      = 0;
     nombre     = "";
     nombre1    ="";
     dir_fich2  = "";
     emp        = "";
     i          = 0;
     docum      = 0;
     num        = 0;
     num1       = 0;
     cuenta_des = "";
     pintar = "";
     sub_prog = "";
     mensaje    = "";
     desglo    = 0;
     num_lin   = 0;
     cta       = "";
     ctaan     = "";
     tipo      = 0;
     acum      = 0;

     swhot = 0;
     hot_tip  = 1;
     hot_cta  = "";
     alfa2      = "";
     alfa3      = "";
     n_alfa1    = "";
     n_alfa2    = "";
     nume1      = 0;
     nume2      = 0;
     nume3      = 0;
     masca      = "";
     seriec     = "";

     nCmpCta    = 0;

     nDiario = 0;  fFecha  = @;
     nDocum  = 0;  nAsto   = 0;
     nAcum   = 0;  nCont   = 0;
     aCuenta = ""; aTAcum  = "";
     nImpCuadre = 0;

     &enGenIva0 = 0;
     &enGenAsi0 = 0;

     aSerie   = "";
     aAlfa2   = "";
     nContAsto = 0;

     nTCosteAlm = 0;
     nTCosteTal = 0;
     nSwTotAlm  = 0;
     nSwTotTal  = 0;

     aCmpClave1 = "";
     aCmpClave2 = "";
     aCmpClave3 = "";
|FIN;

|PROCESO Impor0; |TIPO 0;
     aAlfa = #0#28;
     |C_M #0#29, 1, aAlfa;
     |C_M #0#30, 1, aAlfa;
     |SI aAlfa = "N";
        #0#29 = "N"; #0#30 = "N";
     |FINSI;
|FPRC;

|CALCULO cuencon;
     niva = 0; cuentaan = "";
     |ABRE #11;
     #11#0 = #10#13;
     |LEE 040#11=;
     |SI FSalida ! 0; |CIERRA #11; |ACABA; |FINSI;
     |SI #6x = 1;
          importe = #10#7;
     |SINO;
          importe = #10#9;
     |FINSI;
     |ABRE #17;
     #17#52 = #10#29;    #17#0 = #10#0;      |LEE 001#17=;
     |SI FSalida ! 0; |DDEFECTO #17; |FINSI;
     |CIERRA #17;
     |SI #17#43 = "S";
          importe = -importe;
     |FINSI;
     |SI #6y = "SEC         ";
          |SI #6x ] 77; |Y #6x [ 80;
             cuenta = #con00641#13;
             |SI #6s = "D";
                cuentaan = #con00641#14;
             |SINO;
                cuentaan = #con00641#7;
             |FINSI;
          |SINO;
             cuenta = #con00641#5;
             cuentaan = #con00641#7;
          |FINSI;
          |QBF cuenta;
          long = cuenta % 0;
          digito1 = 0;
          |SI long = dig4; digito1 = 1; |FINSI;
          |SI long = dig5; digito1 = 2; |FINSI;
          |SI long = dig6; digito1 = 3; |FINSI;
          |SI long = dig7; digito1 = 4; |FINSI;
          |SI long = dig8; digito1 = 5; |FINSI;
          |SI long = dig9; digito1 = 6; |FINSI;
          |SI #6x = 77; |O #6x = 78; |O #6x = 79; |O #6x = 80;
             importe = #con00641#10; niva = #con00641#11;
          |SINO;
             importe = #con00641#4; niva = #con00641#6;
             |SI #con00641#15 ! 0;
                importe = importe - #con00641#15;
             |FINSI;
          |FINSI;
     |FINSI;
     nSw = 0;
     |SI importe ! 0;                        nSw = 1; |FINSI;
     |SI importe = 0; |Y #con00666#28 = "S"; nSw = 1; |FINSI;
     |SI nSw ! 0;
          |SI #6y ! "SEC         ";
             |HAZ montacu1;
          |FINSI;
          |HAZ concepto;
          #8#0 = lincont;
          #8#1 = asi;
          #8#2 = #6x;
          #8#3 = cuenta;
          #8#4 = digito1;
          #8#5 = #6s;
          #8#9 = 1;
          num_lin = 1;
          |LIBERA #8; |LEE 101#8=;
          |SI FSalida = 0;
             |SI #6desglo = "S";
                cta = #8#3;    |QBF cta;
                |PARA; |SI FSalida = 0; |HACIENDO;
                    |SI #8#0 = lincont; |Y #8#1 = 1; |Y #8#2 = #6x;
                         |Y cta = cuenta; |Y #8#4 = digito1; |Y #8#5 = #6s;
                              num_lin = num_lin + 1;
                    |SINO;
                              FSalida = 1;
                              |SAL;
                    |FINSI;
                    |LIBERA #8; |LEE 101#8s;
                    cta = #8#3;    |QBF cta;
                |SIGUE;
             |SINO;
                cta = #8#3;    |QBF cta;
                ctaan = #8#14; |QBF ctaan;
                |PARA; |SI FSalida = 0; |HACIENDO;
                    |SI #8#0 = lincont; |Y #8#1 = 1; |Y #8#2 = #6x;
                         |Y cta = cuenta; |Y #8#4 = digito1; |Y #8#5 = #6s; ||Y ctaan = cuentaan;
                              num_lin = num_lin + 1;
                    |SINO;
                              FSalida = 1;
                              |SAL;
                    |FINSI;
                    |LIBERA #8; |LEE 101#8s;
                    cta = #8#3;    |QBF cta;
                    ctaan = #8#14; |QBF ctaan;
                |SIGUE;
             |FINSI;
          |FINSI;
          |SI FSalida ! 0;
               #8#0 = lincont;
               #8#1 = asi;
               #8#2 = #6x;
               #8#3 = cuenta;
               #8#4 = digito1;
               #8#5 = #6s;
               #8#6 = #6c;
               #8#7 = nconcep;
               #8#8 = 0;
               #8#9 = num_lin;
               #8#17 = #7#49;
               #8#18 = #7#0;
               #8#19 = #7#1;
               |GRABA 020#8b;
          |FINSI;
          #8#10 = #6tipo;
          #8#11 = #6acum;
          #8#8 = #8#8 + importe;
          #8#13 = niva;

          |SI #8#10 = "B";
             #8#14 = cuentaan;
             #8#15 = #con00641#8;
             #8#16 = #con00641#9;
             |SI #8#15 = 0; |Y #8#16 = 0;
                #8#15 = #0#13;
                #8#16 = #0#14;
             |FINSI;
          |SINO;
             |SI #con00641#10 ! 0;
                #8#14 = cuentaan;
                #8#15 = #con00641#8;
                #8#16 = #con00641#9;
             |SINO;
                #8#14 = "";
                #8#15 = #0#13;
                #8#16 = #0#14;
             |FINSI;
          |FINSI;
          |GRABA 020#8a;
          |LIBERA #8;
          cuentaan = "";
          cue = cuenta;
          niv = digito1;
          deb = #6s;
          imp = importe;
          |HAZ gratra;
     |FINSI;
     |CIERRA #11;
|FCAL;

|PROCESO asagi;
     |ABRE #10;
     |SELECT #2#10;
     #10#30 = #7#49;     ||serie factura
     #10#26 = #7#0;
     #10#13 = dfamilia;
     |LEE 001#10];
     |PARA FSalida = FSalida; |SI FSalida = 0;
                              |Y #10#26 = #7#0; |Y #10#30 = #7#49;
                              |HACIENDO FSalida = FSalida;
          |HAZ cuencon;
          |LEE 001#10s;
     |SIGUE;
     |CIERRA #10;
|FPRC;

|PROCESO asdesg;
     |SI #6x = 72; aAlfa = "C"; |FINSI;
     |SI #6x = 73; aAlfa = "A"; |FINSI;
     |SI #6x = 67; |O #6x = 77; aAlfa = "P"; |FINSI;
     |SI #6x = 68; |O #6x = 78; aAlfa = "L"; |FINSI;
     |SI #6x = 69; |O #6x = 79; aAlfa = "S"; |FINSI;
     |SI #6x = 70; |O #6x = 80; aAlfa = "M"; |FINSI;
     |SI #6x = 81; |O #6x = 82; aAlfa = "Y"; |FINSI;

     |ABRE #con00641; |DDEFECTO #con00641;
     #con00641#0 = #7#49;     ||serie factura
     #con00641#1 = #7#0;
     #con00641#2 = aAlfa;
     |LEE 000#con00641.];
     |PARA; |SI FSalida = 0; |Y #con00641#0 = #7#49;
      |Y #con00641#1 = #7#0; |Y #con00641#2 = aAlfa; |HACIENDO;
        |HAZ cuencon;
        |LEE 000#con00641.s;
     |SIGUE;
     |CIERRA #con00641;
|FPRC;

|PROCESO DesglosaTFact;
   #con00703#0 = #con00642#3;
   #con00703#1 = #con00642#4;
   |LEE 000#con00703.=;
   |SI FSalida ! 0; |DDEFECTO #con00703; |FINSI;

   #con00008#5 = #con00642#3;
   #con00008#6 = 0;
   #con00008#0 = #con00703#2;
   |LEE 000#con00008.=;
   |SI FSalida ! 0;
      |DDEFECTO #con00008;
   |SINO;
      |SI nSwCoste = 0; aAlfa = #con00008#3; |SINO; aAlfa = #con00008#8; |FINSI;
      |QBF aAlfa;
      aAlfa = ("000000" + aAlfa) % -106;
      aAlfa1 = aAlfa % 0105; #0#13 = aAlfa1;
      aAlfa1 = aAlfa % 0601; #0#14 = aAlfa1;
      |SI #0#13 = 0; |Y #0#14 = 0;
         #0#13 = nEmpresa; #0#14 = nPeriodo;
      |FINSI;
   |FINSI;

   #caenlac@#3 = linea; linea = linea + 1;
   |SI nSwCoste = 0; #caenlac@#4 = #con00008#2; |SINO; #caenlac@#4 = #con00008#7; |FINSI;
   #caenlac@#5 = #8#4;
   #caenlac@#6 = #8#6;        ||concepto
   #caenlac@#7 = #8#7;        ||descripcion concepto
   #caenlac@#8 = #8#5;        ||signo
   #caenlac@#9 = #con00642#7; ||importe
   #caenlac@#10 = "R";        ||Soportado/repercutido
   #caenlac@#11 = #6#2;       ||libro
   #caenlac@#12 = #7#49;      ||Serie #4#1
   #caenlac@#13 = #7#0;       ||Factura
   #caenlac@#20 = "N";
   #caenlac@#26 = #8#10;
   |SI #caenlac@#26 = " ";
      |SI #8#2 = 10; #caenlac@#26 = "F"; |FINSI;
   |FINSI;
   #caenlac@#27 = #8#11;
   #caenlac@#28 = #8#13;
   #caenlac@#29 = #caenlac@#1;
   |SI nSwCoste = 0; #caenlac@#39 = #con00008#4; |SINO; #caenlac@#39 = #con00008#9; |FINSI;
   #caenlac@#43 = #agifa134#3;
   #caenlac@#44 = #agifa024#15;

   |SI #8#8 < 0; |Y #0#25 = "S";
      |SI #caenlac@#8 = "D";        ||cambio el signo del apunte
          #caenlac@#8 = "H";       ||cuando el importe sea negativo
      |SINO;
          #caenlac@#8 = "D";
      |FINSI;
      #caenlac@#9 = -#caenlac@#9;        ||Cambio el signo del importe
   |FINSI;

   #caenlac@#15 = #6#123;         ||Departamento
   |SI #6#174 = "S";  #caenlac@#15 = #7#7;  |FINSI;  || Representante
   #caenlac@#37 = #8#15;
   #caenlac@#38 = #8#16;
   |GRABA 021#caenlac@.c; |LIBERA #caenlac@;
   |SI #caenlac@#8 = "D";
      nImpCuadre = nImpCuadre + (#caenlac@#9 ! 2);
   |SINO;
      nImpCuadre = nImpCuadre - (#caenlac@#9 ! 2);
   |FINSI;

   nDiario = #caenlac@#0; fFecha  = #caenlac@#1;
   nDocum  = #caenlac@#2; nAsto   = #caenlac@#3;
   aCuenta = #caenlac@#4; aTAcum  = #caenlac@#26;
   nAcum   = #caenlac@#27;
   nCont   = 0;

   |ABRE #agifa722;
   |SI nSwCoste = 1;
      #agifa722#0 = "CS";
   |SINO;
      #agifa722#0 = "VT";
   |FINSI;
   #agifa722#1 = #7#49;
   #agifa722#2 = #7#0;
   aAlfa = #7#1; |QBF aAlfa;
   aAlfa = aAlfa % -104; nAnyo = aAlfa;
   #agifa722#3 = nAnyo;
   #agifa722#8 = #0#13;
   #agifa722#9 = #0#14;
   #agifa722#11 = 1;
   |LEE 000#agifa722.=;
   |SI FSalida ! 0;
      |DDEFECTO #agifa722;
      |SI nSwCoste = 1;
         #agifa722#0 = "CS";
      |SINO;
         #agifa722#0 = "VT";
      |FINSI;
      #agifa722#1 = #7#49;
      #agifa722#2 = #7#0;
      aAlfa = #7#1; |QBF aAlfa; aAlfa = aAlfa % -104;
      nAnyo = aAlfa;
      #agifa722#3 = nAnyo;
      #agifa722#4 = nDiario;
      #agifa722#5 = fFecha;
      #agifa722#6 = nDocum;
      #agifa722#7 = 1;
      #agifa722#8 = #con00666#13;
      #agifa722#9 = #con00666#14;
      #agifa722#10 = #con00666#17;
      #agifa722#11 = 1;
      |GRABA 020#agifa722.n;
   |FINSI;
   |CIERRA #agifa722;
|FPRC;

|DEFBUCLE DesglosaTFact;
   #con00642#1;
   ;
   #agifa134#49, #agifa134#0, 01;
   #agifa134#49, #agifa134#0, 99;
   ;
   NULL, DesglosaTFact;
|FIN;

|CALCULO cuadre;
     |ABRE #agifa024;
     #agifa024#0 = #agifa134#2;
     |LEE 000#agifa024.=;
     |SI FSalida ! 0; |DDEFECTO #agifa024; |FINSI;
     |CIERRA #agifa024;

     sw_pas = 1;
     |SI cabe = 0;
          #0#13 = #8#15;
          #0#14 = #8#16;
          |HAZ cabecera;
          |SI nContActual > 999999; nSwError = -1; |ACABA; |FINSI;
          cabe = 1;
          |SI #0#6 = "P";
               linea = linefal - 1;
          |SINO;
               linea = 0;
          |FINSI;
     |FINSI;
     linea = linea + 1;
     |SI #0#6 = "P";
          linefal = linea + 1;
     |FINSI;

     nSwDesg = 0;
     |SI #609#11 = #con00666#24; |O #609#12 = #con00666#24; |O #609#13 = #con00666#24;
      |O #609#17 = #con00666#24; |O #609#18 = #con00666#24; |O #609#19 = #con00666#24;
      |O #609#21 = #con00666#24; |O #609#22 = #con00666#24; |O #609#23 = #con00666#24;
      |O #609#24 = #con00666#24; |O #609#25 = #con00666#24; |O #609#26 = #con00666#24;
      |O #609#27 = #con00666#24; |O #609#28 = #con00666#24; |O #609#29 = #con00666#24;
      |O #609#30 = #con00666#24; |O #609#31 = #con00666#24; |O #609#32 = #con00666#24;
      |O #609#33 = #con00666#24; |O #609#34 = #con00666#24; |O #609#35 = #con00666#24;

        nSwDesg = 1;
     |FINSI;

     |SI #8#2 = 10; |Y nSwDesg = 1;
        |ABRE #con00703; |ABRE #con00008;
        |BUCLE DesglosaTFact;
        |CIERRA #con00703; |CIERRA #con00008;
     |SINO;
        #caenlac@#3 = linea; linea = linea + 1;
        #caenlac@#4 = #8#3;
        #caenlac@#5 = #8#4;
        #caenlac@#6 = #8#6;      ||concepto
        #caenlac@#7 = #8#7;      ||descripcion concepto
        #caenlac@#8 = #8#5;      ||signo
        #caenlac@#9 = #8#8;      ||importe
        #caenlac@#10 = "R";       ||Soportado/repercutido
        #caenlac@#11 = #6#2;      ||libro
        #caenlac@#12 = #7#49;     ||Serie #4#1
        #caenlac@#13 = #7#0;      ||Factura
        #caenlac@#20 = "N";
        #caenlac@#26 = #8#10;
        |SI #caenlac@#26 = " ";
           |SI #8#2 = 10; #caenlac@#26 = "F"; |FINSI;
        |FINSI;
        #caenlac@#27 = #8#11;
        #caenlac@#28 = #8#13;
        #caenlac@#29 = #caenlac@#1;
        |SI #con00666#31 = "E";
           aAlfa = #8#14; |QBF aAlfa;
           #caenlac@#39 = #8#14;
        |SINO;
           |SI #caenlac@#26 = "B";
              |ABRE #agifa007;
              #agifa007#26 = #7#49;
              |LEE 000#agifa007.=;
              |SI FSalida ! 0; |DDEFECTO #agifa007; |FINSI;
              |CIERRA #agifa007;

              #caenlac@#39 = #agifa007#43;
           |FINSI;
        |FINSI;
        #caenlac@#43 = #agifa134#3;
        #caenlac@#44 = #agifa024#15;

        |SI #8#8 < 0; |Y #0#25 = "S";
           |SI #caenlac@#8 = "D";        ||cambio el signo del apunte
               #caenlac@#8 = "H";       ||cuando el importe sea negativo
           |SINO;
               #caenlac@#8 = "D";
           |FINSI;
           #caenlac@#9 = -#caenlac@#9;        ||Cambio el signo del importe
        |FINSI;

        #caenlac@#15 = #6#123;         ||Departamento
        |SI #6#174 = "S";  #caenlac@#15 = #7#7;  |FINSI;  || Representante

        #caenlac@#37 = #8#15;
        #caenlac@#38 = #8#16;
        |GRABA 021#caenlac@.c; |LIBERA #caenlac@;

        |SI #caenlac@#8 = "D";
           nImpCuadre = nImpCuadre + (#caenlac@#9 ! 2);
        |SINO;
           nImpCuadre = nImpCuadre - (#caenlac@#9 ! 2);
        |FINSI;
        nImpCuadre = nImpCuadre ! 2;

        nDiario = #caenlac@#0; fFecha  = #caenlac@#1;
        nDocum  = #caenlac@#2; nAsto   = #caenlac@#3;
        aCuenta = #caenlac@#4; aTAcum  = #caenlac@#26;
        nAcum   = #caenlac@#27;
        nCont   = 0;

        |ABRE #agifa722;
        |SI nSwCoste = 1;
           #agifa722#0 = "CS";
        |SINO;
           #agifa722#0 = "VT";
        |FINSI;
        #agifa722#1 = #7#49;
        #agifa722#2 = #7#0;
        aAlfa = #7#1; |QBF aAlfa;
        aAlfa = aAlfa % -104; nAnyo = aAlfa;
        #agifa722#3 = nAnyo;
        #agifa722#8 = #0#13;
        #agifa722#9 = #0#14;
        #agifa722#11 = 1;
        |LEE 000#agifa722.=;
        |SI FSalida ! 0;
           |DDEFECTO #agifa722;
           |SI nSwCoste = 1;
              #agifa722#0 = "CS";
           |SINO;
              #agifa722#0 = "VT";
           |FINSI;
           #agifa722#1 = #7#49;
           #agifa722#2 = #7#0;
           aAlfa = #7#1; |QBF aAlfa; aAlfa = aAlfa % -104;
           nAnyo = aAlfa;
           #agifa722#3 = nAnyo;
           #agifa722#4 = nDiario;
           #agifa722#5 = fFecha;
           #agifa722#6 = nDocum;
           #agifa722#7 = 1;
           #agifa722#8 = #con00666#13;
           #agifa722#9 = #con00666#14;
           #agifa722#10 = #con00666#17;
           #agifa722#11 = 1;
           |GRABA 020#agifa722.n;
        |FINSI;
        |CIERRA #agifa722;

        #caenlac@#0 = nDiario;
        #caenlac@#1 = fFecha;
        #caenlac@#2 = nDocum;
        #caenlac@#3 = 1;
        |LEE 000#caenlac@.];
        |PARA; |SI FSalida = 0; |Y #caenlac@#0 = nDiario; |Y #caenlac@#1 = fFecha; |Y #caenlac@#2 = nDocum; |HACIENDO;
           |SI aCuenta ! #caenlac@#4; |Y aTAcum = #caenlac@#26; |Y nAcum = #caenlac@#27; nCont = nCont + 1; |FINSI;
           |LEE 000#caenlac@.s;
        |SIGUE;

        aAlfa = #con00665#175; |QBF aAlfa;
        aAlfa = aAlfa - "contagen";
        |SI FSalida ! 0;
           #caenlac@#0 = nDiario;
           #caenlac@#1 = fFecha;
           #caenlac@#2 = nDocum;
           #caenlac@#3 = nAsto;
           |LEE 101#caenlac@.=;
           |SI FSalida = 0;
              aAlfa = #con00665#175; |QBF aAlfa;
              aAlfa = aAlfa - "contagen";
              |SI FSalida ! 0;
                 #caenlac@#27 = (nCont * 10) + #caenlac@#27;
              |SINO;
                 #caenlac@#27 = #caenlac@#27 + nCont;
              |FINSI;
              |GRABA 021#caenlac@.a; |LIBERA #caenlac@;
           |FINSI;
        |SINO;
           #caenlac@#0 = nDiario;
           #caenlac@#1 = fFecha;
           #caenlac@#2 = nDocum;
           #caenlac@#3 = nAsto;
           |LEE 000#caenlac@.=;
        |FINSI;
     |FINSI;
|FCAL;

|DEFBUCLE asagicon2;
#8#1;
;
1 , 1 , 00 , d_cuen , 0 , d ,   1;
8 , 1 , 99 , h_cuen , 6 , h , 999;
e;
NULL , cuadre;
|FIN;

|DEFBUCLE ascon00667;
#8#1;
;
1 , 2 , 00 , d_cuen , 1 , d ,   1;
8 , 2 , 99 , h_cuen , 6 , h , 999;
e;
NULL , cuadre;
|FIN;

|PROCESO DesgloseOrden;
   |SI #con00626#14 = "S"; |O #con00626#14 = "I"; |ACABA; |FINSI;

   #con00008#5 = #con00626#0;
   #con00008#6 = #con00626#9;
   #con00008#0 = #con00626#23;
   |LEE 000#con00008.=;
   |SI FSalida ! 0;
      |DDEFECTO #con00008;
      aAlfa = (("00000" + #0#13) % -105) + #0#14;
      |SI nSwCoste = 0;
         #con00008#3 = aAlfa;
      |SINO;
         #con00008#8 = aAlfa;
      |FINSI;
   |SINO;
      |SI nSwCoste = 0;
         |SI #con00008#3 = 0;
            aAlfa = (("00000" + #0#13) % -105) + #0#14;
            #con00008#3 = aAlfa;
         |FINSI;
      |SINO;
         |SI #con00008#8 = 0;
            aAlfa = (("00000" + #0#13) % -105) + #0#14;
            #con00008#8 = aAlfa;
         |FINSI;
      |FINSI;
   |FINSI;

   #con00002#0 = #con00626#23;
   |LEE 000#con00002.=;
   |SI FSalida ! 0; |DDEFECTO #con00002; |FINSI;

   |SI #con00626#9 = 1; aTipo = "M"; nCmpCta = 2; |FINSI;
   |SI #con00626#9 = 2; aTipo = "P"; nCmpCta = 3; |FINSI;
   |SI #con00626#9 = 3; aTipo = "S"; nCmpCta = 4; |FINSI;
   |SI #con00626#9 = 4; aTipo = "L"; nCmpCta = 5; |FINSI;
   |SI #con00626#9 = 5; aTipo = "C"; nCmpCta = 6; |FINSI;

   #con00641#0 = #agifa134#49; ||#con00625#15;
   #con00641#1 = #agifa134#0;  ||#con00625#16;
   #con00641#2 = aTipo;
   #con00641#3 = #con00626#23;
   |LEE 101#con00641.=;
   |SI FSalida ! 0;
      |DDEFECTO #con00641;
      #con00641#0 = #agifa134#49; ||#con00625#15;
      #con00641#1 = #agifa134#0;  ||#con00625#16;
      #con00641#2 = aTipo;
      #con00641#3 = #con00626#23;
      |GRABA 020#con00641.b;
   |FINSI;

   |SI nSwCoste = 0;
      #con00641#5 = #con00008#2;
      #con00641#7 = #con00008#4;
   |SINO;
      #con00641#5 = #con00008#7;
      #con00641#7 = #con00008#9;
   |FINSI;
   |SI #con00626#14 = "G";
      #con00641#10 = #con00641#10 + #con00626#8;
      |ABRE #agifa007;
      #agifa007#26 = #7#49;
      |LEE 000#agifa007.=;
      |SI FSalida ! 0; |DDEFECTO #agifa007; |FINSI;
      |CIERRA #agifa007;
      #con00641#12 = #agifa007#50;

      #con00008#5 = #agifa134#49;
      #con00008#6 = #con00626#9;
      #con00008#0 = #con00641#12;
      |LEE 000#con00008.=;
      |SI FSalida ! 0; |DDEFECTO #con00008; |FINSI;
      |SI nSwCoste = 0;
         #con00641#13 = #con00008#2;
         #con00641#14 = #con00008#4;
      |SINO;
         #con00641#13 = #con00008#7;
         #con00641#14 = #con00008#9;
      |FINSI;
   |SINO;
      #con00641#4 = #con00641#4 + #con00626#8;
   |FINSI;

   |SI nSwCoste = 0; aAlfa = #con00008#3; |SINO; aAlfa = #con00008#8; |FINSI;
   |QBF aAlfa;
   aAlfa =  ("000000" + aAlfa) % -106;
   aAlfa1 = aAlfa % 0105; #con00641#8 = aAlfa1; #0#13 = aAlfa1;
   aAlfa1 = aAlfa % 0601; #con00641#9 = aAlfa1; #0#14 = aAlfa1;
   |SI #con00626#11 ] 1; |Y #con00626#11 [ 999;
      |ABRE #con00603;
      #con00603#0 = #con00626#2;
      |LEE 000#con00603.=;
      |SI FSalida ! 0; |DDEFECTO #con00603; |FINSI;
      enTiva = #con00603#5;
      efFiva = #agifa134#1;
      |HAZ SacaIVA;

      |SI #con00626#14 = "G";
         #con00641#11 = enIva;
      |SINO;
         #con00641#6 = enIva;
      |FINSI;
      |CIERRA #con00603;
   |FINSI;
   |SI #con00626#11 ] 1000; |Y #con00626#11 [ 1999;
      |ABRE #agifa019;
      #agifa019#0 = #con00626#2;
      |LEE 000#agifa019.=;
      |SI FSalida ! 0; |DDEFECTO #agifa019; |FINSI;
      |CIERRA #agifa019;

      enTiva = #agifa019#30;
      efFiva = #agifa134#1;
      |HAZ SacaIVA;

      |SI #con00626#14 = "G";
         #con00641#11 = enIva;
      |SINO;
         #con00641#6 = enIva;
      |FINSI;
   |FINSI;
   |SI #con00626#11 ] 2000; |Y #con00626#11 [ 2999;
      |ABRE #con00606;
      #con00606#0 = #con00626#2;
      |LEE 000#con00606.=;
      |SI FSalida ! 0; |DDEFECTO #con00606; |FINSI;
      |CIERRA #con00606;

      enTiva = #con00606#4;
      efFiva = #agifa134#1;
      |HAZ SacaIVA;

      |SI #con00626#14 = "G";
         #con00641#11 = enIva;
      |SINO;
         #con00641#6 = enIva;
      |FINSI;
   |FINSI;
   |SI #con00626#11 ] 3000; |Y #con00626#11 [ 9999;
      |ABRE #agifa019;
      #agifa019#0 = #con00626#2;
      |LEE 000#agifa019.=;
      |SI FSalida ! 0; |DDEFECTO #agifa019; |FINSI;
      |CIERRA #agifa019;

      enTiva = #agifa019#30;
      efFiva = #agifa134#1;
      |HAZ SacaIVA;
      |SI #con00626#14 = "G";
         #con00641#11 = enIva;
      |SINO;
         #con00641#6 = enIva;
      |FINSI;
   |FINSI;

   || Si la factura no tiene Cuota IVA, el %IVA = 0
   #con00637#0 = #agifa134#49;  ||#con00625#15;
   #con00637#1 = #agifa134#0;   ||#con00625#16;
   |LEE 000#con00637.=;
   |SI FSalida = 0; |Y #con00637#10 = 0; |Y #con00637#26 = 0;
      |SI #con00626#14 = "G";
         #con00641#11 = 0;
      |SINO;
         #con00641#6 = 0;
      |FINSI;
   |FINSI;

   |GRABA 020#con00641.a; |LIBERA #con00641;

   |SI nSwCoste = 1;
      |DDEFECTO #con00648;
      #con00648#0 = #con00641#0;
      #con00648#1 = #con00641#1;
      #con00648#2 = #con00641#2;
      #con00648#3 = #con00641#3;
      #con00648#4 = #con00641#8;
      #con00648#5 = #con00641#9;
      #con00648#6 = #con00648#6 + #con00626#17;
      #con00648#7 = #con00648#7 + #con00626#18;
      #con00648#8 = #con00008#7;
      #con00648#11 = #con00008#9;
      |GRABA 020#con00648.n;
   |FINSI;
|FPRC;

|DEFBUCLE DesgloseOrden;
#con00626#1;
;
#con00625#0, #con00625#1, 0001;
#con00625#0, #con00625#1, 9999;
;
NULL,DesgloseOrden;
|FIN;

|PROCESO DesgloseNueOrden;
     nSwNuevo = 1;
     #con00625#0 = #con00626#0;
     #con00625#1 = #con00626#1;
     |LEE 020#con00625.=;
     |HAZ DesgloseOrden;
|FPRC;

|DEFBUCLE DesgloseNueOrden;
     #con00626#6;
     ;
     #agifa134#49, #agifa134#0, #con00642#3, #con00642#4, 0001;
     #agifa134#49, #agifa134#0, #con00642#3, #con00642#4, 9999;
     ;
     NULL, DesgloseNueOrden;
|FIN;

|PROCESO DesgloseLineas;
   |SI #con00642#10 = "O";
      nSwNuevo = 0;
      |ABRE #con00625;
      |ABRE #con00002;   |ABRE #con00008;
      |BUCLE DesgloseNueOrden;
      |CIERRA #con00002; |CIERRA #con00008;
      |SI nSwNuevo = 0;     || Antes la serie/factura estaba en la cabecera
           |SELECT #4#con00625;
           #con00625#15 = #agifa134#49;
           #con00625#16 = #agifa134#0;
           #con00625#17 = #agifa134#1;
           |LEE 000#con00625.];
           |PARA; |SI FSalida = 0; |Y #con00625#15 = #agifa134#49;
            |Y #con00625#16 = #agifa134#0; |Y #con00625#17 = #agifa134#1; |HACIENDO;
              |ABRE #con00002; |ABRE #con00008;
              |BUCLE DesgloseOrden;
              |CIERRA #con00002; |CIERRA #con00008;
              |LEE 000#con00625.s;
           |SIGUE;
           |SELECT #1#con00625;
      |FINSI;
      |CIERRA #con00625;
   |FINSI;

   |SI #con00642#10 = "A";
      nFactura = #con00642#4; aTipoDato = "C";
      nSwDesglosa = 1; |HAZ RecorreAlbaran; nSwDesglosa = 0;
   |FINSI;
|FPRC;

|DEFBUCLE DesgloseLineas;
     #con00642#1;
     ;
     #agifa134#49, #agifa134#0, 01;
     #agifa134#49, #agifa134#0, 99;
     ;
     NULL, DesgloseLineas;
|FIN;

|PROCESO GrabaPuente;
   |SI #con00665#nCont# = 81; |O #con00665#nCont# = 82;
      |DDEFECTO #caenlac@;

      #caenlac@#0 = nDiario;
      #caenlac@#1 = fFecha;
      #caenlac@#2 = nDocum;
      #caenlac@#3 = 1;
      |LEE 000#caenlac@.];
      |PARA; |SI FSalida = 0; |Y #caenlac@#0 = nDiario; |Y #caenlac@#1 = fFecha;
      |Y #caenlac@#2 = nDocum; |HACIENDO;
         |SI #caenlac@#37 = #con00648#4; |Y #caenlac@#38 = #con00648#5;
            nCalc = #caenlac@#21; nCalc1 = #con00665#nCont#;
            |SI nCalc = nCalc1; |SAL; |FINSI;
         |FINSI;
         |LEE 000#caenlac@.s;
      |SIGUE;
      |SI FSalida = 0; |Y #caenlac@#0 = nDiario; |Y #caenlac@#1 = fFecha;
       |Y #caenlac@#2 = nDocum; |Y #caenlac@#37 = #con00648#4; |Y #caenlac@#38 = #con00648#5;
       |Y nCalc = nCalc1;
         |SI #con00665#nCont# = 81; #caenlac@#9 = #caenlac@#9 + #con00648#6; |FINSI;
         |SI #con00665#nCont# = 82; #caenlac@#9 = #caenlac@#9 + #con00648#7; |FINSI;

         |GRABA 020#caenlac@.a;
      |SINO;
         |DDEFECTO #caenlac@;
         #caenlac@#0 = nDiario;
         #caenlac@#1 = fFecha;
         #caenlac@#2 = nDocum;
         #caenlac@#3 = linea; linea = linea + 1;
         nCalc2 = nCont + 8; aAlfa =  #con00665#nCalc2#; |QBF aAlfa;
         |SI aAlfa = "CLI"; aAlfa = #agifa024#16; |QBF aAlfa; |FINSI;
         |SI aAlfa = "REP"; |HAZ cuen_rep; aAlfa = #33#56; |QBF aAlfa; |FINSI;
         |SI aAlfa = "SER"; |HAZ cuenta_ser; aAlfa = cuenta; |QBF aAlfa; |FINSI;
         |SI aAlfa = "SEC"; aAlfa = #con00648#8; |QBF aAlfa; |FINSI;
         #caenlac@#4 = aAlfa;

         aAlfa2 = aAlfa % 0; nCalc2 = aAlfa2;
         |SI nCalc2 = dig4; #caenlac@#5 = 1; |FINSI;
         |SI nCalc2 = dig5; #caenlac@#5 = 2; |FINSI;
         |SI nCalc2 = dig6; #caenlac@#5 = 3; |FINSI;
         |SI nCalc2 = dig7; #caenlac@#5 = 4; |FINSI;
         |SI nCalc2 = dig8; #caenlac@#5 = 5; |FINSI;
         |SI nCalc2 = dig9; #caenlac@#5 = 6; |FINSI;
         |SI nCalc2 = 0;    #caenlac@#5 = 0; |FINSI;

         c = nCont + 32; fac = nCont + 40; fec = nCont + 48; |HAZ concepto;
         #caenlac@#6 = #con00665#c#;
         #caenlac@#7 = nconcep;
         nCalc2 = nCont + 24;
         #caenlac@#8 = #con00665#nCalc2#;
         #caenlac@#12 = #con00648#0; #caenlac@#13 = #con00648#1;

         #caenlac@#21 = #con00665#nCont#;
         #caenlac@#37 = #con00648#4;
         #caenlac@#38 = #con00648#5;
         nCalc2 = nCont + 8; aAlfa =  #con00665#nCalc2#; |QBF aAlfa;
         |SI aAlfa = "SEC";
            #caenlac@#39 = #con00648#11;
         |SINO;
            #caenlac@#39 = "";
         |FINSI;
         #caenlac@#15 = #con00665#123;         ||Departamento
         |SI #con00665#174 = "S";  #caenlac@#15 = #agifa134#7;  |FINSI;  || Representante

         |SI #con00665#nCont# = 81; #caenlac@#9 = #caenlac@#9 + #con00648#6; |FINSI;
         |SI #con00665#nCont# = 82; #caenlac@#9 = #caenlac@#9 + #con00648#7; |FINSI;

         |SI #caenlac@#9 ! 0;
            cam = 1;
            |GRABA 020#caenlac@.c;

            |SI #caenlac@#8 = "D";
               nImpCuadre = nImpCuadre + (#caenlac@#9 ! 2);
            |SINO;
               nImpCuadre = nImpCuadre - (#caenlac@#9 ! 2);
            |FINSI;
            nImpCuadre = nImpCuadre ! 2;
         |FINSI;
      |FINSI;
   |SINO;
      |DDEFECTO #caenlac@;
      #caenlac@#0 = nDiario;
      #caenlac@#1 = fFecha;
      #caenlac@#2 = nDocum;
      #caenlac@#3 = linea; linea = linea + 1;
      nCalc2 = nCont + 8; aAlfa =  #con00665#nCalc2#; |QBF aAlfa;
      |SI aAlfa = "CLI"; aAlfa = #agifa024#16; |QBF aAlfa; |FINSI;
      |SI aAlfa = "REP"; |HAZ cuen_rep; aAlfa = #33#56; |QBF aAlfa; |FINSI;
      |SI aAlfa = "SER"; |HAZ cuenta_ser; aAlfa = cuenta; |QBF aAlfa; |FINSI;
      |SI aAlfa = "SEC"; aAlfa = #con00648#8; |QBF aAlfa; |FINSI;
      #caenlac@#4 = aAlfa;

      aAlfa2 = aAlfa % 0; nCalc2 = aAlfa2;
      |SI nCalc2 = dig4; #caenlac@#5 = 1; |FINSI;
      |SI nCalc2 = dig5; #caenlac@#5 = 2; |FINSI;
      |SI nCalc2 = dig6; #caenlac@#5 = 3; |FINSI;
      |SI nCalc2 = dig7; #caenlac@#5 = 4; |FINSI;
      |SI nCalc2 = dig8; #caenlac@#5 = 5; |FINSI;
      |SI nCalc2 = dig9; #caenlac@#5 = 6; |FINSI;
      |SI nCalc2 = 0;    #caenlac@#5 = 0; |FINSI;

      c = nCont + 32; fac = nCont + 40; fec = nCont + 48; |HAZ concepto;
      #caenlac@#6 = #con00665#c#;
      #caenlac@#7 = nconcep;
      nCalc2 = nCont + 24;
      #caenlac@#8 = #con00665#nCalc2#;
      #caenlac@#12 = #con00648#0; #caenlac@#13 = #con00648#1;

      #caenlac@#21 = #con00665#nCont#;
      #caenlac@#37 = #con00648#4;
      #caenlac@#38 = #con00648#5;
      nCalc2 = nCont + 8; aAlfa =  #con00665#nCalc2#; |QBF aAlfa;
      |SI aAlfa = "SEC";
         #caenlac@#39 = #con00648#11;
      |SINO;
         #caenlac@#39 = "";
      |FINSI;
      #caenlac@#15 = #con00665#123;         ||Departamento
      |SI #con00665#174 = "S";  #caenlac@#15 = #agifa134#7;  |FINSI;  || Representante

      |SI #con00665#nCont# = 83; |Y #con00648#2 = "P"; #caenlac@#9 = #con00648#6; |FINSI;
      |SI #con00665#nCont# = 87; |Y #con00648#2 = "P"; #caenlac@#9 = #con00648#7; |FINSI;
      |SI #con00665#nCont# = 84; |Y #con00648#2 = "L"; #caenlac@#9 = #con00648#6; |FINSI;
      |SI #con00665#nCont# = 88; |Y #con00648#2 = "L"; #caenlac@#9 = #con00648#7; |FINSI;
      |SI #con00665#nCont# = 85; |Y #con00648#2 = "S"; #caenlac@#9 = #con00648#6; |FINSI;
      |SI #con00665#nCont# = 89; |Y #con00648#2 = "S"; #caenlac@#9 = #con00648#7; |FINSI;
      |SI #con00665#nCont# = 86; |Y #con00648#2 = "M"; #caenlac@#9 = #con00648#6; |FINSI;
      |SI #con00665#nCont# = 90; |Y #con00648#2 = "M"; #caenlac@#9 = #con00648#7; |FINSI;
      |SI #con00665#nCont# = 91; #caenlac@#9 = #con00648#6; |FINSI;
      |SI #con00665#nCont# = 92; #caenlac@#9 = #con00648#7; |FINSI;

      |SI #caenlac@#9 ! 0;
         cam = 1;
         |GRABA 020#caenlac@.c;

         |SI #caenlac@#8 = "D";
            nImpCuadre = nImpCuadre + (#caenlac@#9 ! 2);
         |SINO;
            nImpCuadre = nImpCuadre - (#caenlac@#9 ! 2);
         |FINSI;
         nImpCuadre = nImpCuadre ! 2;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO CambiaAsiento;
   |ABRE #agifa722;
   |DDEFECTO #agifa722;

   #agifa722#0 = "CS";
   #agifa722#1 = #con00648#0; aCmpClave1 = #agifa722#1;
   #agifa722#2 = #con00648#1; aCmpClave2 = #agifa722#2;
   aAlfa = #agifa134#1; |QBF aAlfa;
   aAlfa = aAlfa % -104; nAnyo = aAlfa;
   #agifa722#3 = nAnyo; aCmpClave3 = #agifa722#3;
   #agifa722#10 = "";
   #agifa722#11 = 0;
   |LEE 000#agifa722.];
   |PARA; |SI FSalida = 0; |Y aCmpClave1 = #agifa722#1; |Y aCmpClave2 = #agifa722#2; |Y aCmpClave3 = #agifa722#3; |HACIENDO;
      |SI #agifa722#8 = #con00648#4; |Y #agifa722#9 = #con00648#5; |SAL; |FINSI;
      |LEE 000#agifa722.s;
   |SIGUE;

   |SI FSalida = 0; |Y aCmpClave1 = #agifa722#1; |Y aCmpClave2 = #agifa722#2; |Y aCmpClave3 = #agifa722#3;
      |Y #agifa722#8 = #con00648#4; |Y #agifa722#9 = #con00648#5;
      nDocum = #agifa722#6;
      docume = nDocum;

      |DDEFECTO #caenlac@;
      #caenlac@#0 = #agifa722#4;
      #caenlac@#1 = #agifa722#5;
      #caenlac@#2 = #agifa722#6;
      #caenlac@#3 = 0;
      #caenlac@#9 = 0;
      #caenlac@#25 = "S";
      #caenlac@#37 = #agifa722#8;
      #caenlac@#38 = #agifa722#9;
      |GRABA 020#caenlac@.n;

      |DDEFECTO #caenlac@;
   |SINO;
      aAlfa = #con00665#175; |QBF aAlfa;
      aAlfa = aAlfa + "fich/" + (("00000" + #con00648#4) % -105) + #con00648#5 + "/";
      |PATH_DAT #caconas@#aAlfa#;

      |ABRE #caconas@;
      |LEE 101#caconas@.p;
      |SI FSalida ! 0;
         |DDEFECTO #caconas@;
         |GRABA 020#caconas@.b;
      |FINSI;
      #caconas@#1 = #caconas@#1 + 1;
      nDocum = #caconas@#1;
      docume = nDocum;
      |GRABA 020#caconas@.a; |LIBERA #caconas@;
      |CIERRA #caconas@;

      #agifa722#0 = "CS";
      #agifa722#1 = #con00648#0;
      #agifa722#2 = #con00648#1;
      aAlfa = #agifa134#1; |QBF aAlfa;
      aAlfa = aAlfa % -104; nAnyo = aAlfa;
      #agifa722#3 = nAnyo;
      #agifa722#4 = diario;
      |SI #0#6 = "R"; |Y #0#18 = "S";
         #agifa722#5 = fecha;
      |SINO;
         #agifa722#5 = fecant;
      |FINSI;
      #agifa722#6 = docume;
      #agifa722#8 = #con00648#4;
      #agifa722#9 = #con00648#5;
      #agifa722#10 = #con00666#17;
      #agifa722#11 = nContAsto;
      |GRABA 020#agifa722.n;
   |FINSI;

   linea = 1;

   #caenlac@#0 = diario;
   |SI #0#6 = "R"; |Y #0#18 = "S";
        #caenlac@#1 = fecha;
   |SINO;
        #caenlac@#1 = fecant;
   |FINSI;
   |SI #0#6 = "P";
        #caenlac@#1 = #0#8;
   |FINSI;
   #caenlac@#2 = docume;
   #caenlac@#3 = asient;
   |SI docume > nContActual; nContActual = docume; |FINSI;
|FPRC;

|PROCESO PuenteDesglose;
   |SI #con00648#6 = 0; |Y #con00648#7 = 0; |ACABA; |FINSI;

     #agifa134#49 = #con00648#0;
     #agifa134#0  = #con00648#1;
     |LEE 000#agifa134.=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #agifa024;
     #agifa024#0 = #agifa134#2;
     |LEE 000#agifa024.=;
     |SI FSalida ! 0; |DDEFECTO #agifa024; |FINSI;
     |CIERRA #agifa024;

     |SI aSerie ! #con00648#0; |O nFactura ! #con00648#1; |O nEmpresa ! #con00648#4; |O nPeriodo ! #con00648#5;
        |HAZ CambiaAsiento;

        nDiario = #caenlac@#0;
        fFecha  = #caenlac@#1;
        nDocum  = #caenlac@#2;

        aSerie   = #con00648#0;
        nFactura = #con00648#1;
        nEmpresa = #con00648#4;
        nPeriodo = #con00648#5;
     |FINSI;

     |PARA nContAsto = 1; |SI nContAsto [ 2; |HACIENDO nContAsto = nContAsto + 1;
        |SI nContAsto = 1; nDesde = 5;  nHasta = 12; |FINSI;
        |SI nContAsto = 2; nDesde = 61; nHasta = 68; |FINSI;
        |PARA nCont = nDesde; |SI nCont [ nHasta; |HACIENDO nCont = nCont + 1;
           |SI #con00665#nCont# = 81; |O #con00665#nCont# = 82;
              nCalc2 = nCont + 8; aAlfa =  #con00665#nCalc2#; |QBF aAlfa;
              |SI aAlfa = "CLI"; aAlfa = #agifa024#16; |QBF aAlfa; |FINSI;
              |SI aAlfa = "REP"; |HAZ cuen_rep; aAlfa = #33#56; |QBF aAlfa; |FINSI;
              |SI aAlfa = "SER"; |HAZ cuenta_ser; aAlfa = cuenta; |QBF aAlfa; |FINSI;
           |FINSI;
           |SI #con00665#nCont# ] 83; |Y #con00665#nCont# [ 90;
              nCalc2 = nCont + 8; aAlfa =  #con00665#nCalc2#; |QBF aAlfa;
              |SI aAlfa = "SEC"; aAlfa = #con00648#8; |QBF aAlfa; |FINSI;
           |FINSI;

           |SI #con00665#nCont# ] 81;
              |HAZ GrabaPuente;
           |FINSI;
        |SIGUE;
     |SIGUE;
|FPRC;

|DEFBUCLE PuenteDesglose;
#con00648#2;
;
INICIO;
FINAL;
;
NULL, PuenteDesglose;
|FIN;

|PROCESO CalculaTotales;
   |SI aSerie ! #con00648#0; |O nFactura ! #con00648#1; |O nEmpresa ! #con00648#4; |O nPeriodo ! #con00648#5;
      |SI nTCosteAlm ! 0; |O nTCosteTal ! 0;
         |SALVA_FICHA #con00648;
         #con00648#0 = aSerie;
         #con00648#1 = nFactura;
         #con00648#2 = "";
         #con00648#3 = 0;
         #con00648#4 = nEmpresa;
         #con00648#5 = nPeriodo;
         |LEE 000#con00648.];
         |PARA; |SI FSalida = 0; |Y #con00648#0 = aSerie; |Y #con00648#1 = nFactura; |HACIENDO;
            |SI #con00648#4 = nEmpresa; |Y #con00648#5 = nPeriodo;
               #con00648#9 = nTCosteAlm; #con00648#10 = nTCosteTal;
               |GRABA 020#con00648.a;
            |FINSI;
            |LEE 000#con00648.s;
         |SIGUE;
         |REPON_FICHA #con00648;
      |FINSI;
      aSerie   = #con00648#0; nFactura = #con00648#1;
      nEmpresa = #con00648#4; nPeriodo = #con00648#5;

      nTCosteAlm = 0; nTCosteTal = 0;
   |FINSI;

   nTCosteAlm = nTCosteAlm + #con00648#6;
   nTCosteTal = nTCosteTal + #con00648#7;
|FPRC;

|DEFBUCLE CalculaTotales;
#con00648#1;
;
INICIO;
FINAL;
;
NULL, CalculaTotales;
|FIN;

|PROCESO EnlaceCostes;
   aSerie   = ""; nFactura = 0;
   nEmpresa = 0;  nPeriodo = 0;
   |BUCLE PuenteDesglose;
|FPRC;

|CALCULO hacer;
     nSwError = 0;

     |DELINDEX #con00641; |ABRE #con00641;
     |DELINDEX #con00648; |ABRE #con00648;

     |BUCLE DesgloseLineas;

     |SI nSwCoste = 1;
        |BUCLE CalculaTotales;
        |SI nTCosteAlm ! 0; |O nTCosteTal ! 0;
           #con00648#0 = aSerie;
           #con00648#1 = nFactura;
           #con00648#2 = "";
           #con00648#3 = 0;
           #con00648#4 = nEmpresa;
           #con00648#5 = nPeriodo;
           |LEE 000#con00648.];
           |PARA; |SI FSalida = 0; |Y #con00648#0 = aSerie; |Y #con00648#1 = nFactura; |HACIENDO;
              |SI #con00648#4 = nEmpresa; |Y #con00648#5 = nPeriodo;
                 #con00648#9 = nTCosteAlm; #con00648#10 = nTCosteTal;
                 |GRABA 020#con00648.a;
              |FINSI;
              |LEE 000#con00648.s;
           |SIGUE;
        |FINSI;
     |FINSI;
     |CIERRA #con00641; |CIERRA #con00648;

     #con00637#0 = #agifa134#49;
     #con00637#1 = #agifa134#0;
     |LEE 000#con00637.=;
     |SI FSalida = 0;
        || Compruebo que la factura sea la misma comparando el total factura
        aAlfa = #con00637#11; |QBF aAlfa;
        aAlfa = aAlfa - ".";
        |SI FSalida ! 0;
           nCalc = FSalida + 98;
           aAlfa = aAlfa % nCalc; |QBF aAlfa;
           aAlfa = aAlfa % 0; nDec1 = aAlfa;
        |FINSI;
        aAlfa = #agifa134#101; |QBF aAlfa;
        aAlfa = aAlfa - ".";
        |SI FSalida ! 0;
           nCalc = FSalida + 98;
           aAlfa = aAlfa % nCalc; |QBF aAlfa;
           aAlfa = aAlfa % 0; nDec2 = aAlfa;
        |FINSI;
        |SI nDec1 > nDec2; nDec1 = nDec2; |SINO; nDec2 = nDec1; |FINSI;
        nCalc1 = #con00637#11 ! nDec1;
        nCalc2 = #agifa134#101 ! nDec2;
        |SI nCalc1 ! nCalc2; |DDEFECTO #con00637; |FINSI;
     |SINO;
        |DDEFECTO #con00637;
     |FINSI;

     swvta = 1;
     pclient = "Actualizando Cliente: " + #7#2;
     |PINTA 2250 , pclient;

     empre   =  #0#13;
     periodo =  #0#14;
     cliente = #7#2;
     repre   = #7#7;
     pintar = "Enlazando Factura : " + #7#0;
     |PINTA 2250 , pintar;
     |SI nSwCoste = 1;
        |HAZ EnlaceCostes;
        |ACABA;
     |FINSI;

     |SI cam = 0; fecant = #7#1; |HAZ acerar; cam = 1; |FINSI;
     |SI #0#6 = "F"; |O #0#6 = "P";
          |SI #0#6 = "P";
               fecant = #7#1;
          |FINSI;
          |SI fecant ! #7#1;
               |SI #6#4 = 1;
                    sw_pas = 0;
                    |BUCLE asagicon2;
                    |SI sw_pas = 1; |HAZ suma; |FINSI;
                    |SI nImpCuadre ! 0;  |Y nImpCuadre [ 1;
                       #caenlac@#0 = nDiario;
                       #caenlac@#1 = fFecha;
                       #caenlac@#2 = nDocum;
                       #caenlac@#3 = 1;
                       |LEE 000#caenlac@.];
                       |PARA; |SI FSalida = 0; |Y #caenlac@#0 = nDiario; |Y #caenlac@#1 = fFecha; |Y #caenlac@#2 = nDocum; |HACIENDO;
                         |SI #caenlac@#26 = "B";
                            #caenlac@#9 = #caenlac@#9 + nImpCuadre;
                            |GRABA 020#caenlac@.a;
                            |SAL;
                         |FINSI;
                         |LEE 000#caenlac@.s;
                      |SIGUE;
                    |FINSI;
                    nImpCuadre = 0;
                    |HAZ acerar;
               |SINO;
                    sw_pas = 0;
                    |BUCLE asagicon2;
                    |SI sw_pas = 1; |HAZ suma; |FINSI;
                    sw_pas = 0;
                    |BUCLE ascon00667;
                    |SI sw_pas = 1; |HAZ suma; |FINSI;
                    |SI nImpCuadre ! 0; |Y nImpCuadre [ 1;
                       #caenlac@#0 = nDiario;
                       #caenlac@#1 = fFecha;
                       #caenlac@#2 = nDocum;
                       #caenlac@#3 = 1;
                       |LEE 000#caenlac@.];
                       |PARA; |SI FSalida = 0; |Y #caenlac@#0 = nDiario; |Y #caenlac@#1 = fFecha; |Y #caenlac@#2 = nDocum; |HACIENDO;
                         |SI #caenlac@#26 = "B";
                            #caenlac@#9 = #caenlac@#9 + nImpCuadre;
                            |GRABA 020#caenlac@.a;
                            |SAL;
                         |FINSI;
                         |LEE 000#caenlac@.s;
                      |SIGUE;
                    |FINSI;

                    nImpCuadre = 0;
                    |HAZ acerar;
               |FINSI;
               fecant = #7#1;
          |FINSI;
     |SINO;
          fecant = #7#1;
     |FINSI;
     |HAZ factura1;
     |SI #6#4 ! 1;
          |HAZ agifa133;
     |FINSI;
     ||HAZ iva;
     |SI #0#6 = "P";
          |HAZ sumalin;
     |SINO;
          linefal = 0;
     |FINSI;
     |SI #0#6 = "R";
          |SI #6#4 = 1;
               sw_pas = 0;
               |BUCLE asagicon2;
               |SI sw_pas = 1; |HAZ suma; |FINSI;

               |SI nImpCuadre ! 0; |Y nImpCuadre [ 1;
                  #caenlac@#0 = nDiario;
                  #caenlac@#1 = fFecha;
                  #caenlac@#2 = nDocum;
                  #caenlac@#3 = 1;
                  |LEE 000#caenlac@.];
                  |PARA; |SI FSalida = 0; |Y #caenlac@#0 = nDiario; |Y #caenlac@#1 = fFecha; |Y #caenlac@#2 = nDocum; |HACIENDO;
                     |SI #caenlac@#26 = "B";
                        #caenlac@#9 = #caenlac@#9 + nImpCuadre;
                        |GRABA 020#caenlac@.a;
                        |SAL;
                     |FINSI;
                     |LEE 000#caenlac@.s;
                  |SIGUE;
               |FINSI;

               nImpCuadre = 0;
               |HAZ acerar;
          |SINO;
               sw_pas = 0;
               |BUCLE asagicon2;
               |SI sw_pas = 1; |HAZ suma; |FINSI;
               sw_pas = 0;
               |BUCLE ascon00667;
               |SI sw_pas = 1; |HAZ suma; |FINSI;

               |SI nImpCuadre ! 0;  |Y nImpCuadre [ 1;
                  #caenlac@#0 = nDiario;
                  #caenlac@#1 = fFecha;
                  #caenlac@#2 = nDocum;
                  #caenlac@#3 = 1;
                  |LEE 000#caenlac@.];
                  |PARA; |SI FSalida = 0; |Y #caenlac@#0 = nDiario; |Y #caenlac@#1 = fFecha; |Y #caenlac@#2 = nDocum; |HACIENDO;
                     |SI #caenlac@#26 = "B";
                        #caenlac@#9 = #caenlac@#9 + nImpCuadre;
                        |GRABA 020#caenlac@.a;
                        |SAL;
                     |FINSI;
                     |LEE 000#caenlac@.s;
                  |SIGUE;
               |FINSI;

               nImpCuadre = 0;
               |HAZ acerar;
          |FINSI;
     |FINSI;

     |SI nSwError = 0;
        || #7#48 = "S"; |GRABA 020#7a;
     |SINO;
        |SI nSwError = -1; |MENAV "    Contador de asientos fuera de rango. Se aborta el enlace."; |ERROR10; |FINSI;
     |FINSI;
     |LIBERA #7;
|FCAL;

|DEFBUCLE asagicon0;
#agifa134#3;
48,57,45;
#0#15 , #0#4 , #0#24 , #0#2 , n,     #0#26, impresa;
#0#16 , #0#5 , #0#24 , #0#3 , #0#32, #0#26, impresa;
be;
NULL , hacer;
|FIN;

|CALCULO suma;
     cabe = 0;
     docume = docume + 1;
     asient = asient + 1;
|FCAL;

|PROCESO sumalin;
     linefal = linefal + 1;
|FPRC;

|CALCULO acerar;
     |CIERRA #8;
     |DELINDEX #8;
     |ABRE #8;
|FCAL;

|PROCESO leeiva;
     iva1 = #7#39; re1 = #7#40;
     iva2 = #7#41; re2 = #7#42;
     iva3 = #7#43; re3 = #7#44;
     iva4 = #7#50; re4 = #7#51;
     iva5 = #7#52; re5 = #7#53;
|FPRC;

|CALCULO factura1;
     |PARA x = 5; |SI x [ 12; |HACIENDO x = x + 1;
          |SI x = 5;  lincont = 1; |FINSI;
          |SI x = 6;  lincont = 2; |FINSI;
          |SI x = 7;  lincont = 3; |FINSI;
          |SI x = 8;  lincont = 4; |FINSI;
          |SI x = 9;  lincont = 5; |FINSI;
          |SI x = 10; lincont = 6; |FINSI;
          |SI x = 11; lincont = 7; |FINSI;
          |SI x = 12; lincont = 8; |FINSI;
          |SI #6x ! 0;
               y = x + 8;          || Cuenta
               z = x + 16;         || Dig.
               s = x + 24;         || Signo
               c = x + 32;         || Concepto
               fac = x + 40;       || Inc. Fra.
               fec = x + 48;       || Inc. Fecha
               desglo = x + 153;   || Desglosar Cuentas
               tipo = x + 119;     || Tipo Acumulador
               acum = x + 127;     || Numero Acum.
               |SI #6x ! 1; |Y #6x ! 2; |Y #6y ! "SEC         ";
                    niva = 0; nSw = 0;
                    |HAZ importe;
                    |SI importe ! 0;                        nSw = 1; |FINSI;
                    |SI importe = 0; |Y #con00666#28 = "S"; nSw = 1; |FINSI;
                    |SI nSw ! 0;    ||Si existe importe
                         |HAZ montacu;
                         |HAZ concepto;
                         #8#0 = lincont;
                         #8#1 = 1;
                         #8#2 = #6x;
                         #8#3 = cuenta;
                         #8#4 = digito1;
                         #8#5 = #6s;
                         #8#9 = 1;
                         num_lin = 1;
                         |LIBERA #8; |LEE 101#8=;
                         |SI FSalida = 0; |Y #6desglo = "S";
                              cta = #8#3;    |QBF cta;
                              |PARA; |SI FSalida = 0; |HACIENDO;
                                   |SI #8#0 = lincont; |Y #8#1 = 1; |Y #8#2 = #6x;
                                        |Y cta = cuenta; |Y #8#4 = digito1; |Y #8#5 = #6s;
                                             num_lin = num_lin + 1;
                                        |SINO;
                                             FSalida = 1;
                                             |SAL;
                                        |FINSI;
                                   |LEE 001#8s;
                                   cta = #8#3;    |QBF cta;
                              |SIGUE;
                         |FINSI;
                         |SI FSalida ! 0;
                              #8#0 = lincont;
                              #8#1 = 1;
                              #8#2 = #6x;
                              #8#3 = cuenta;
                              #8#4 = digito1;
                              #8#5 = #6s;
                              #8#6 = #6c;
                              #8#7 = nconcep;
                              #8#8 = 0;
                              #8#9 = num_lin;
                              #8#17 = #7#49;
                              #8#18 = #7#0;
                              #8#19 = #7#1;
                              |GRABA 020#8b;
                         |FINSI;
                         #8#10 = #6tipo;
                         #8#11 = #6acum;
                         #8#8 = #8#8 + importe;
                         #8#13 = niva;
                         |SI #8#10 = "B";
                            #8#14 = cuentaan;
                            #8#15 = #con00641#8;
                            #8#16 = #con00641#9;
                            |SI #8#15 = 0; |Y #8#16 = 0;
                               #8#15 = #0#13;
                               #8#16 = #0#14;
                            |FINSI;
                         |SINO;
                            #8#14 = "";
                            #8#15 = #0#13;
                            #8#16 = #0#14;
                         |FINSI;
                         |GRABA 020#8a;
                         |LIBERA #8;
                         cue = cuenta;
                         cuentaan = "";
                         niv = digito1;
                         deb = #6s;
                         imp = importe;
                         |HAZ gratra;
                    |FINSI;
               |SINO;
                    |SI #6x = 1; |O #6x = 2;
                       asi = 1;
                       ||BUCLE asagicon1;
                       |HAZ asagi;
                    |SINO;
                       asi = 1;
                       |HAZ asdesg;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
|FCAL;

|CALCULO agifa133;
     |PARA x = 61; |SI x [ 68; |HACIENDO x = x + 1;
          |SI x = 61; lincont = 1; |FINSI;
          |SI x = 62; lincont = 2; |FINSI;
          |SI x = 63; lincont = 3; |FINSI;
          |SI x = 64; lincont = 4; |FINSI;
          |SI x = 65; lincont = 5; |FINSI;
          |SI x = 66; lincont = 6; |FINSI;
          |SI x = 67; lincont = 7; |FINSI;
          |SI x = 68; lincont = 8; |FINSI;
          |SI #6x ! 0;
               y = x + 8;
               z = x + 16;
               s = x + 24;
               c = x + 32;
               fac = x + 40;
               fec = x + 48;
               desglo = x + 105;
               tipo = x + 79;
               acum = x + 87;
               |SI #6x ! 1; |Y #6x ! 2;
                    |HAZ importe;
                    nSw = 0;
                    |SI importe ! 0;                        nSw = 1; |FINSI;
                    |SI importe = 0; |Y #con00666#28 = "S"; nSw = 1; |FINSI;
                    |SI nSw ! 0;    ||Si existe importe
                         |HAZ montacu;
                         |HAZ concepto;
                         #8#0 = lincont;
                         #8#1 = 2;
                         #8#2 = #6x;
                         #8#3 = cuenta;
                         #8#4 = digito1;
                         #8#5 = #6s;
                         #8#9 = 1;
                         num_lin = 1;
                         |LIBERA #8; |LEE 101#8=;
                         |SI FSalida = 0; |Y #6desglo = "S";
                              cta = #8#3;    |QBF cta;
                              |PARA; |SI FSalida = 0; |HACIENDO;
                                   |SI #8#0 = lincont; |Y #8#1 = 1; |Y #8#2 = #6x;
                                        |Y cta = cuenta; |Y #8#4 = digito1; |Y #8#5 = #6s;
                                             num_lin = num_lin + 1;
                                   |SINO;
                                             FSalida = 1;
                                             |SAL;
                                   |FINSI;
                                   |LEE 001#8s;
                                   cta = #8#3; |QBF cta;
                              |SIGUE;
                         |FINSI;
                         |SI FSalida ! 0;
                              #8#0 = lincont;
                              #8#1 = 2;
                              #8#2 = #6x;
                              #8#3 = cuenta;
                              #8#4 = digito1;
                              #8#5 = #6s;
                              #8#6 = #6c;
                              #8#7 = nconcep;
                              #8#8 = 0;
                              #8#9 = num_lin;
                              #8#17 = #7#49;
                              #8#18 = #7#0;
                              #8#19 = #7#1;
                              |GRABA 020#8b;
                         |FINSI;
                         #8#10 = #6tipo;
                         #8#11 = #6acum;
                         #8#8 = #8#8 + importe;
                         |SI #8#10 = "B";
                            #8#14 = cuentaan;
                            #8#15 = #con00641#8;
                            #8#16 = #con00641#9;
                            |SI #8#15 = 0; |Y #8#16 = 0;
                               #8#15 = #0#13;
                               #8#16 = #0#14;
                            |FINSI;
                         |SINO;
                            #8#14 = "";
                            #8#15 = #0#13;
                            #8#16 = #0#14;
                         |FINSI;
                         |GRABA 020#8a;
                         |LIBERA #8;
                         cue = cuenta;
                         cuentaan = "";
                         niv = digito1;
                         deb = #6s;
                         imp = importe;
                         |HAZ gratra;
                    |FINSI;
               |SINO;
                    asi = 2;
                    ||BUCLE asagicon1;
                    |HAZ asagi;
               |FINSI;
          |FINSI;
     |SIGUE;
|FCAL;

|CALCULO gratra;
     |SI imp < 0; |Y #0#25 = "S";
          imp = -imp;
          |SI deb = "D";
             deb = "H";
          |SINO;
             deb = "D";
          |FINSI;
     |FINSI;
     sw_nueve = 1;
/*
     |ABRE #9;
     #9#0 = 1;
     #9#1 = cue;
     #9#2 = niv;
     |SI #0#6 = "R"; |Y #0#18 = "S";
          #9#3 = fecha;   ||#0#8
     |SINO;
          #9#3 = fecant;
     |FINSI;
     |SI #0#6 = "P";
          #9#3 = #0#8;
     |FINSI;
     #9#4 = deb;
     #9#6 = #0#7;
     |LIBERA #9; |LEE 110#9=;
     |SI FSalida ! 0;
          |DDEFECTO #9;
          #9#0 = 1;
          #9#1 = cue;
          #9#2 = niv;
          |SI #0#6 = "R"; |Y #0#18 = "S";
               #9#3 = #0#8;
          |SINO;
               #9#3 = fecant;
          |FINSI;
          |SI #0#6 = "P";
               #9#3 = #0#8;
          |FINSI;
          #9#4 = deb;
          #9#6 = #0#7;
          |GRABA 020#9b;
     |FINSI;
     #9#5 = #9#5 + imp;
     |GRABA 0201#9a;
     |LIBERA #9;
     |CIERRA #9;
*/
|FCAL;
/*
|CALCULO cabecera;
     #30#0 = diario;
     |SI #0#6 = "R"; |Y #0#18 = "S";
          #30#1 = fecha;
     |SINO;
          #30#1 = fecant;
     |FINSI;
     |SI #0#6 = "P";
          #30#1 = #0#8;
     |FINSI;
     #30#2 = docume;
     #30#3 = asient;
     #30#4 = 0;
     #30#5 = 0;
     #30#6 = 0;
|FCAL;
*/
|CALCULO cabecera;
     |HAZ Contador;

     #caenlac@#0 = diario;
     |SI #0#6 = "R"; |Y #0#18 = "S";
          #caenlac@#1 = fecha;
     |SINO;
          #caenlac@#1 = fecant;
     |FINSI;
     |SI #0#6 = "P";
          #caenlac@#1 = #0#8;
     |FINSI;
     #caenlac@#2 = docume;
     #caenlac@#3 = asient;
     |SI docume > nContActual; nContActual = docume; |FINSI;

     |SI nContActual > 999999; nSwError = -1; |FINSI;
|FCAL;

|CALCULO concepto;
     |ABRE #12;
     #12#0 = #6c;
     |LEE 040#12=;
     |SI FSalida = 0;
          nconcep = #12#1;
          |QBF nconcep;
          |SI #0#6 = "R";
               |SI #6fac = "S";
                    nconcep = nconcep + " " + #7#49 + "/" + #7#0;
               |FINSI;
               |SI #6fec = "S";
                    nconcep = nconcep + " " + #7#1;
               |FINSI;
          |SINO;
               |SI #6fac = "S";
                    nconcep = nconcep + " " + #7#49 + "/" + #7#0;
               |SINO;
                    |SI #6fec = "S";
                         nconcep = nconcep + " " + #7#1;
                    |SINO;
                         nconcep = nconcep + " " + "VARIAS";
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #12;
|FCAL;

|CALCULO montacu;
     contador = 0;
     conta = 0;
     cuenta = #6y;
     |PARA nContBucle = 1; |SI nContBucle [ 12; |HACIENDO nContBucle = nContBucle + 1;
          conta = (nContBucle * 100) + 1;
          arte = cuenta % conta;
          |SI arte = "*"; contador = nContBucle; |FINSI;
     |SIGUE;
     |SI contador ! 0;
          conta = 100 + (contador - 1);
          cuenta = cuenta % conta;
          long = cuenta % 0;
          |SI #6z = 1; digito = dig4; digito1 = 1; |FINSI;
          |SI #6z = 2; digito = dig5; digito1 = 2; |FINSI;
          |SI #6z = 3; digito = dig6; digito1 = 3; |FINSI;
          |SI #6z = 4; digito = dig7; digito1 = 4; |FINSI;
          |SI #6z = 5; digito = dig8; digito1 = 5; |FINSI;
          |SI #6z = 6; digito = dig9; digito1 = 6; |FINSI;
          pongo = digito - long;
          alfa = #7#2;
          alfa = "000000000000" + alfa;
          cojo = (100 + pongo) * -1;
          cojo1 = cojo; ||nuevo
          alfa1 = alfa % cojo1;
          |QBT alfa1;
          |SI alfa1 = "";
               alfa = #7#2;
               |QBT alfa;
               alfa = "0000000000000000" + alfa;
               alfa1 = alfa % cojo1;
          |FINSI;
          cuenta = cuenta + alfa1;
     |SINO;
          |SI  #6y = "CLI         ";
                cuenta = #7#12;      ||Cuenta de las facturas
                |QBF cuenta;
          |SINO;
               |SI #6y = "REP         ";
                    |HAZ cuen_rep;
                    cuenta = #33#56;
                    |QBF cuenta;
               |SINO;
                    |SI #6y = "SER         ";
                        |HAZ cuenta_ser;
                        |QBF cuenta;
                    |SINO;
                        cuenta = #6y;
                        |QBF cuenta;
                    |FINSI;
               |FINSI;
          |FINSI;
          long = cuenta % 0;
          digito1 = 0;
          |SI long = dig4; digito1 = 1; |FINSI;
          |SI long = dig5; digito1 = 2; |FINSI;
          |SI long = dig6; digito1 = 3; |FINSI;
          |SI long = dig7; digito1 = 4; |FINSI;
          |SI long = dig8; digito1 = 5; |FINSI;
          |SI long = dig9; digito1 = 6; |FINSI;
     |FINSI;
|FCAL;

|CALCULO montacu1;
     cuenta = #11#2;||Cuenta contable venta de familias;
     |SI #6y = "SER         ";
         hot_cta = #11#2;
         |HAZ cuenta_ser1;
         cuenta = hot_cta;
     |FINSI;
     |QBF cuenta;
     long = cuenta % 0;
     digito1 = 0;
     |SI long = dig4; digito1 = 1; |FINSI;
     |SI long = dig5; digito1 = 2; |FINSI;
     |SI long = dig6; digito1 = 3; |FINSI;
     |SI long = dig7; digito1 = 4; |FINSI;
     |SI long = dig8; digito1 = 5; |FINSI;
     |SI long = dig9; digito1 = 6; |FINSI;
|FCAL;

|PROCESO LeeOrden;
   |SI #con00626#35 ! #con00642#0; |O #con00626#36 ! #con00642#1; |ACABA; |FINSI;

   |SI #con00626#14 = "N"; ||O #con00626#14 = "G";
      |SI #con00626#11 ] 1; |Y #con00626#11 [ 999;
         |ABRE #con00603;
         #con00603#0 = #con00626#2;
         |LEE 000#con00603.=;
         |SI FSalida ! 0; |DDEFECTO #con00603; |FINSI;
         nTipoIva = #con00603#5;
         |CIERRA #con00603;
      |FINSI;
      |SI #con00626#11 ] 1000; |Y #con00626#11 [ 1999;
         |ABRE #agifa019;
         #agifa019#0 = #con00626#2;
         |LEE 000#agifa019.=;
         |SI FSalida ! 0; |DDEFECTO #agifa019; |FINSI;
         nTipoIva = #agifa019#30;
         |CIERRA #agifa019;
      |FINSI;
      |SI #con00626#11 ] 2000; |Y #con00626#11 [ 2999;
         |ABRE #con00606;
         #con00606#0 = #con00626#2;
         |LEE 000#con00606.=;
         |SI FSalida ! 0; |DDEFECTO #con00606; |FINSI;
         nTipoIva = #con00606#4;
         |CIERRA #con00606;
      |FINSI;
      |SI #con00626#11 ] 3000; |Y #con00626#11 [ 3999;
         |ABRE #agifa019;
         #agifa019#0 = #con00626#2;
         |LEE 000#agifa019.=;
         |SI FSalida ! 0; |DDEFECTO #agifa019; |FINSI;
         nTipoIva = #agifa019#30;
         |CIERRA #agifa019;
      |FINSI;

      enTiva = nTipoIva;
      efFiva = #con00637#2;
      |HAZ SacaIVA;

      nCalc = (enIva / 100) ! 2;

      importe = importe + (#con00626#8 * nCalc);
   |FINSI;
|FPRC;

|DEFBUCLE LeeOrden;
#con00626#1;
;
#con00642#3, #con00642#4, 0001;
#con00642#3, #con00642#4, 9999;
;
NULL,LeeOrden;
|FIN;

|PROCESO LeeLinAlbaran;
   enTiva = #con00611#11;
   efFiva = #con00637#2;
   |HAZ SacaIVA;

   |SI aTipoDato = "C"; || Total cuotas
      nCalc1 = (enIva / 100) ! 2;
      nCalc = ((#con00611#9 < #con00610#5) < #con00610#32) < #con00610#7;
      nCalc = nCalc ! 2;
      importe = importe + (nCalc * nCalc1);
   |FINSI;
   |SI aTipoDato = "B"; || Total bases
      nCalc = ((#con00611#9 < #con00610#5) < #con00610#32) < #con00610#7;
      nCalc = nCalc ! 2;
      importe = importe + nCalc;
   |FINSI;
   |SI aTipoDato = "T"; || Total albaran
      nCalc1 = 1 + ((enIva / 100) ! 2);
      nCalc = ((#con00611#9 < #con00610#5) < #con00610#32) < #con00610#7;
      nCalc = nCalc ! 2;
      importe = importe + (nCalc * nCalc1);
   |FINSI;

   |SI nSwDesglosa = 1;
      |ABRE #con00004;
      #con00004#0 = #con00611#29;
      #con00004#1 = #con00611#0;
      #con00004#2 = #con00611#1;
      |LEE 000#con00004.=;
      |SI FSalida ! 0; |DDEFECTO #con00004; |FINSI;
      |CIERRA #con00004;

      |ABRE #con00008;
      #con00008#5 = #con00004#0;
      #con00008#6 = 0;
      #con00008#0 = #con00004#3;
      |LEE 000#con00008.=;
      |SI FSalida ! 0; |DDEFECTO #con00008; |FINSI;
      |CIERRA #con00008;

      #con00641#0 = #con00642#0;
      #con00641#1 = #con00642#1;
      #con00641#2 = "A"; ||De albaran
      #con00641#3 = #con00004#3;
      |LEE 101#con00641.=;
      |SI FSalida ! 0;
         |DDEFECTO #con00641;
         #con00641#0 = #con00642#0;
         #con00641#1 = #con00642#1;
         #con00641#2 = "A";
         #con00641#3 = #con00004#3;
         |GRABA 020#con00641.b;
      |FINSI;
      #con00641#4 = #con00641#4 + #con00611#9;
      #con00641#6 = enIva;
      |SI nSwCoste = 0;
         #con00641#5 = #con00008#2;
         #con00641#7 = #con00008#4;
         aAlfa = #con00008#3; |QBF aAlfa;
      |SINO;
         #con00641#5 = #con00008#7;
         #con00641#7 = #con00008#9;
         aAlfa = #con00008#8; |QBF aAlfa;
      |FINSI;
      aAlfa =  ("000000" + aAlfa) % -106;
      aAlfa1 = aAlfa % 0105; #con00641#8 = aAlfa1; #0#13 = aAlfa1;
      aAlfa1 = aAlfa % 0601; #con00641#9 = aAlfa1; #0#14 = aAlfa1;

      nCalc = #con00611#9 - (((#con00611#9 < #con00610#5) < #con00610#32) < #con00610#7);
      nCalc = nCalc ! 2;
      #con00641#15 = #con00641#15 + nCalc;
      |GRABA 020#con00641.a; |LIBERA #con00641;
   |FINSI;
|FPRC;

|DEFBUCLE LeeLinAlbaran;
#con00611#1;
;
#con00610#52, #con00610#0, 001;
#con00610#52, #con00610#0, 999;
;
NULL,LeeLinAlbaran;
|FIN;

|PROCESO LeeAlbaran;
   |BUCLE LeeLinAlbaran;
|FPRC;

|DEFBUCLE LeeAlbaran;
#con00610#1;
;
#con00642#3, nFactura;
#con00642#3, nFactura;
;
NULL,LeeAlbaran;
|FIN;

|PROCESO RepasaOrdenes;
   |SI #con00642#10 = "O"; |BUCLE LeeOrden; |FINSI;
   |SI #con00642#10 = "A";
      nFactura = #con00642#4; aTipoDato = "C";
      |BUCLE LeeAlbaran;
   |FINSI;
   importe = importe ! 2;
|FPRC;

|DEFBUCLE RepasaOrdenes;
#con00642#1;
;
#7#49, #7#0, 01;
#7#49, #7#0, 99;
;
NULL, RepasaOrdenes;
|FIN;

|PROCESO ImporteAlbaranes;
   nFactura = #con00642#4; aTipoDato = "B"; |BUCLE LeeAlbaran; importe = importe ! 2;
|FPRC;

|DEFBUCLE ImporteAlbaranes;
#con00642#1;
10;
#7#49, #7#0, 01, "A";
#7#49, #7#0, 99, "A";
;
NULL, ImporteAlbaranes;
|FIN;

|PROCESO LineaOR;
     |SI #6x = 81; importe = importe + #626#17; |FINSI;
     |SI #6x = 82; importe = importe + #626#18; |FINSI;
     |SI #con00626#11 ] 1; |Y #con00626#11 [ 999;
        |SI #6x = 86; importe = importe + #con00626#17; |FINSI;
        |SI #6x = 90; importe = importe + #con00626#18; |FINSI;
     |FINSI;
     |SI #con00626#11 ] 1000; |Y #con00626#11 [ 1999;
        |SI #6x = 83; importe = importe + #con00626#17; |FINSI;
        |SI #6x = 87; importe = importe + #con00626#18; |FINSI;
     |FINSI;
     |SI #con00626#11 ] 2000; |Y #con00626#11 [ 2999;
        |SI #6x = 85; importe = importe + #con00626#17; |FINSI;
        |SI #6x = 89; importe = importe + #con00626#18; |FINSI;
     |FINSI;
     |SI #con00626#11 ] 3000; |Y #con00626#11 [ 9999;
        |SI #6x = 84; importe = importe + #con00626#17; |FINSI;
        |SI #6x = 88; importe = importe + #con00626#18; |FINSI;
     |FINSI;
     |SI #6x = 91; importe = importe + #626#17; |FINSI;
     |SI #6x = 92; importe = importe + #626#18; |FINSI;
|FPRC;

|DEFBUCLE LineaOR;
     #626#1;
     ;
     #696#3, #696#4, #696#5;
     #696#3, #696#4, #696#5;
     ;
     NULL, LineaOR;
|FIN;

|PROCESO LineaFacOR;
     |BUCLE LineaOR;
|FPRC;

|DEFBUCLE LineaFacOR;
     #696#1;
     ;
     #642#0, #642#1, #642#2, 0000;
     #642#0, #642#1, #642#2, 9999;
     ;
     NULL, LineaFacOR;
|FIN;

|PROCESO FactuLinOR;
     |SI #642#10 = "O";
          |BUCLE LineaFacOR;
     |FINSI;
|FPRC;

|DEFBUCLE FactuLinOR;
     #642#1;
     10;
     #7#49, #7#0, 01, "O";
     #7#49, #7#0, 99, "O";
     ;
     NULL, FactuLinOR;
|FIN;

|CALCULO importe;
     importe = 0;
     acuvario = 0;
     acuporte = 0;
     ivavario = 0;
     ivaporte = 0;
|SI #6x = 3; importe = #7#17; |FINSI;             ||Importe Dto;
|SI #6x = 4; importe = #7#18; |FINSI;             ||Importe Bruto;
|SI #6x = 5; importe = #7#21+#7#24+#7#27+#7#33+#7#36+#7#47;|FINSI; ||Imponible
|SI #6x = 6; importe = #7#30; |FINSI;             ||Total iva Recargo;
|SI #6x = 7; importe = #7#29; |FINSI;             ||Total iva;
|SI #6x = 8; importe = #7#19; |FINSI;             ||Total Portes;
|SI #6x = 9; importe = #7#20; |FINSI;             ||Total Varios;
|SI #6x = 10;importe = #7#31; |FINSI;             ||Total Factura;
|SI #6x = 11;importe = #7#8;  |FINSI;             ||Total Comision;
|SI #6x = 19;importe = #7#30 + #7#29; |FINSI;
|SI #6x = 20;importe = #7#47; |FINSI;             ||base exenta
|SI #6x = 26;importe = #7#55; |FINSI;             ||Importe Retencion

     |SI #6x = 12;|O #6x = 13;          ||Calcula portes y varios
          |HAZ porte_var;
     |FINSI;
     |SI #6x ] 27; |Y #6x [ 36;
          |HAZ porte_var;
     |FINSI;

     |SI #6x = 12;importe = acuporte;   |FINSI;        ||Iva Portes
     |SI #6x = 13;importe = acuvario;   |FINSI;        ||Iva Varios
     |SI #6x = 14;importe = #7#22;      |FINSI;        ||Iva 1
     |SI #6x = 15;importe = #7#23;      |FINSI;        ||Iva Recargo 1
     |SI #6x = 16;importe = #7#25;      |FINSI;        ||Iva 2
     |SI #6x = 17;importe = #7#26;      |FINSI;        ||Iva Recargo 2
     |SI #6x = 18;importe = #7#28;      |FINSI;        ||Iva 3
     |SI #6x = 21;importe = #7#54; |FINSI;             ||Iva Recargo 3
     |SI #6x = 22;importe = #7#34; |FINSI;             ||Iva 4
     |SI #6x = 23;importe = #7#35; |FINSI;             ||Iva Recargo 4
     |SI #6x = 24;importe = #7#37; |FINSI;             ||Iva 5
     |SI #6x = 25;importe = #7#38; |FINSI;             ||Iva Recargo 5

     |SI #6x = 27;   ||Base Sin Portes
          importe = #7#21+#7#24+#7#27+#7#33+#7#36+#7#47- acuporte;
     |FINSI;
     |SI #6x = 28;   ||Base Sin Varios
          importe = #7#21+#7#24+#7#27+#7#33+#7#36+#7#47- acuvario;
     |FINSI;
     |SI #6x = 29; importe = #7#29 - ivaporte; |FINSI;
     |SI #6x = 30; importe = #7#29 - ivavario; |FINSI;
     |SI #6x = 31; importe = acuporte;         |FINSI;
     |SI #6x = 32; importe = acuvario;         |FINSI;
     |SI #6x = 33; importe = ivaporte;         |FINSI;
     |SI #6x = 34; importe = ivavario;         |FINSI;
     |SI #6x = 35;
          importe =#7#21+#7#24+#7#27+#7#33+#7#36+#7#47- acuporte -  acuvario;
     |FINSI;
     |SI #6x = 36; importe = #7#29 - ivaporte - ivavario; |FINSI;
     |SI #6x = 37; importe = #7#21;            |FINSI;
     |SI #6x = 38; importe = #7#24;            |FINSI;
     |SI #6x = 39; importe = #7#27;            |FINSI;
     |SI #6x = 40; importe = #7#33;            |FINSI;
     |SI #6x = 41; importe = #7#36;            |FINSI;
     |SI #6x = 42;
          |SI EURODB ! 0;
               nBase = (#7#21+#7#24+#7#27+#7#33+#7#36+#7#47) ! 2;
               importe = #7#31 ! 2;
               importe = importe - nBase;
          |SINO;
               nBase = (#7#21+#7#24+#7#27+#7#33+#7#36+#7#47) ! 0;
               importe = #7#31 ! 0;
               importe = importe - nBase;
          |FINSI;
     |FINSI;

     || Conceptos para los importes de piezas, mano de obra, etc de la
     ||   aplicacion de talleres
     |SI #6x = 67; importe = #con00637#16;              |FINSI;
     |SI #6x = 68; importe = #con00637#17;              |FINSI;
     |SI #6x = 69; importe = #con00637#18;              |FINSI;
     |SI #6x = 70; importe = #con00637#19;              |FINSI;
     |SI #6x = 72; importe = #con00637#30;              |FINSI;
     |SI #6x = 73; importe = 0; |BUCLE ImporteAlbaranes; |FINSI;
     |SI #6x = 81; importe = 0; |BUCLE FactuLinOR; |FINSI;
     |SI #6x = 82; importe = 0; |BUCLE FactuLinOR; |FINSI;
     |SI #6x ] 83; |Y #6x [ 90;
        importe = 0; |BUCLE FactuLinOR;
     |FINSI;

     |SI #6x = 71;
        importe = 0; |BUCLE RepasaOrdenes;
        |ABRE #agifa007;
        #agifa007#26 = #7#49;
        |LEE 000#agifa007.=;
        |SI FSalida ! 0; |DDEFECTO #agifa007; |FINSI;
        |CIERRA #agifa007;
        |SI #agifa007#30 = "S"; importe = 0; |FINSI;

        |ABRE #con00683;
        |LEE 000#con00683.p;
        |SI FSalida = 0;
           |SI #7#49 = #con00683#11; importe = 0; |FINSI;
           |SI #7#49 = #con00683#12; importe = 0; |FINSI;
           |SI #7#49 = #con00683#13; importe = 0; |FINSI;
           |SI #7#49 = #con00683#17; importe = 0; |FINSI;
           |SI #7#49 = #con00683#18; importe = 0; |FINSI;
           |SI #7#49 = #con00683#19; importe = 0; |FINSI;
           |SI #7#49 = #con00683#21; importe = 0; |FINSI;
           |SI #7#49 = #con00683#22; importe = 0; |FINSI;
           |SI #7#49 = #con00683#23; importe = 0; |FINSI;
           |SI #7#49 = #con00683#24; importe = 0; |FINSI;
           |SI #7#49 = #con00683#25; importe = 0; |FINSI;
           |SI #7#49 = #con00683#26; importe = 0; |FINSI;
           |SI #7#49 = #con00683#27; importe = 0; |FINSI;
           |SI #7#49 = #con00683#28; importe = 0; |FINSI;
           |SI #7#49 = #con00683#29; importe = 0; |FINSI;
           |SI #7#49 = #con00683#30; importe = 0; |FINSI;
           |SI #7#49 = #con00683#31; importe = 0; |FINSI;
           |SI #7#49 = #con00683#32; importe = 0; |FINSI;
           |SI #7#49 = #con00683#33; importe = 0; |FINSI;
           |SI #7#49 = #con00683#34; importe = 0; |FINSI;
           |SI #7#49 = #con00683#35; importe = 0; |FINSI;
        |FINSI;
        |CIERRA #con00683;

        |SI #7#29 = 0; importe = 0; |FINSI;
     |FINSI;   ||Total iva calculado;
     importe = importe ! 2;
|FCAL;

|PROCESO porte_var;
          |ABRE #14;
          |ABRE #17;
          #14#14 = #7#49;
          #14#0 = #7#0;
          #14#1 = 0;
          |LEE 001#14];
          |PARA FSalida = FSalida;|SI 0 = FSalida ;
                                  |Y #7#0 = #14#0; |Y #14#14 = #7#49;
                                  |HACIENDO FSalida = FSalida;
               |DDEFECTO #17;
               #17#52 = #14#15;
               #17#0  = #14#2; ||numero albaran factura;
               |LEE 001#17=;||Lee albaran de linea factura;
               |SI FSalida = 0;
                    |HAZ leeiva;
                    |SI #17#12 = 0; ivapo = 0; |FINSI;
                    |SI #17#12 = 1; ivapo = #17#11 % iva1; |FINSI;
                    |SI #17#12 = 2; ivapo = #17#11 % iva2; |FINSI;
                    |SI #17#12 = 3; ivapo = #17#11 % iva3; |FINSI;
                    |SI #17#12 = 4; ivapo = #17#11 % iva4; |FINSI;
                    |SI #17#12 = 5; ivapo = #17#11 % iva5; |FINSI;
                    |SI #17#43 = "S";
                         ivapo = -ivapo;
                         #17#11 = - #17#11;
                    |FINSI;
                    ivaporte = ivaporte + ivapo;
                    acuporte = acuporte + #17#11;
                    |SI #17#14 = 0; ivava = 0; |FINSI;
                    |SI #17#14 = 1; ivava = #17#13 % iva1; |FINSI;
                    |SI #17#14 = 2; ivava = #17#13 % iva2; |FINSI;
                    |SI #17#14 = 3; ivava = #17#13 % iva3; |FINSI;
                    |SI #17#14 = 4; ivava = #17#13 % iva4; |FINSI;
                    |SI #17#14 = 5; ivava = #17#13 % iva5; |FINSI;
                    |SI #17#43 = "S";
                         ivava = -ivava;
                         #17#13 = -#17#13;
                    |FINSI;
                    ivavario = ivavario + ivava;
                    acuvario = acuvario + #17#13;
               |FINSI;
               |LEE 001#14>;||Lee otra linea de factura;
          |SIGUE;
          |CIERRA #14;
          |CIERRA #17;
|FPRC;

|PROCESO Contador;
  |ABRE #agifa722;
  |SI nSwCoste = 1;
     #agifa722#0 = "CS";
  |SINO;
     #agifa722#0 = "VT";
  |FINSI;
  #agifa722#1 = #8#17;
  #agifa722#2 = #8#18;
  aAlfa = #8#19; |QBF aAlfa;
  aAlfa = aAlfa % -104; nAnyo = aAlfa;
  #agifa722#3 = nAnyo;
  #agifa722#8 = #0#13;
  #agifa722#9 = #0#14;
  #agifa722#11 = 1;
  |LEE 000#agifa722.=;
  |SI FSalida = 0;
     nDocum = #agifa722#6;
     docume = nDocum;

     |DDEFECTO #caenlac@;
     #caenlac@#0 = #agifa722#4;
     #caenlac@#1 = #agifa722#5;
     #caenlac@#2 = #agifa722#6;
     #caenlac@#3 = 0;
     #caenlac@#9 = 0;
     #caenlac@#10 = "R";
     #caenlac@#12 = #agifa722#1;
     #caenlac@#13 = #agifa722#2;
     #caenlac@#25 = "S";
     #caenlac@#37 = #agifa722#8;
     #caenlac@#38 = #agifa722#9;
     |GRABA 020#caenlac@.n;

     |DDEFECTO #caenlac@; |ACABA;
  |FINSI;

  aAlfa = #con00665#175; |QBF aAlfa;
  aAlfa = aAlfa + "fich/" + (("00000" + #0#13) % -105) + #0#14 + "/";
  |PATH_DAT #caconas@#aAlfa#;

  |ABRE #caconas@;
  |LEE 101#caconas@.p;
  |SI FSalida ! 0;
     |DDEFECTO #caconas@;
     |GRABA 020#caconas@.b;
  |FINSI;
  #caconas@#1 = #caconas@#1 + 1;
  nDocum = #caconas@#1;
  docume = nDocum;
  |GRABA 020#caconas@.a; |LIBERA #caconas@;
  |CIERRA #caconas@;
|FPRC;

|PROCESO MarcaCont;
   #agifa134#49 = #caenlac@#12;
   #agifa134#0  = #caenlac@#13;
   |LEE 101#agifa134.=;
   |SI FSalida = 0;
      #agifa134#48 = "S";
      |GRABA 020#agifa134.a; |LIBERA #agifa134;
   |FINSI;
|FPRC;

|DEFBUCLE MarcaCont;
#caenlac@#1006;
;
00, "01.01.0000", 000001, 0000, 00000, 0;
99, "31.12.9999", 999999, 9999, 99999, 9;
be;
NULL,MarcaCont;
|FIN;

|PROCESO HazEnlace;
     |ABRE #con00683;
     |LEE 020#con00683.p;
     |SI FSalida ! 0; |DDEFECTO #con00683; |FINSI;
     |CIERRA #con00683;

     |DFICE emp;
     |QBF emp;
     emp = emp % -202;
     |DFICB dir_fich2; |QBF dir_fich2;
     ||PATH_DAT #30 dir_fich2;

     aAlfa = #con00665#175; |QBF aAlfa;
     aAlfa = aAlfa + "fich/" + (("00000" + #con00665#0) % -105) + #con00665#1 + "/";
     |PATH_DAT #1000 aAlfa;

     nombre1 = "pu" + Usuario; |NOME_DAT #1000  nombre1;

     |SI nContActual > 999999; nSwError = -1; |FINSI;

     |DELINDEX #caenlac@;
     docum = 1;

     docum = docum + nContPartida;
     |SI docum > nContActual; nContActual = docum; |FINSI;

     |SI nContActual > 999999; nSwError = -1; |FINSI;

     sw_nueve = 0;
     diario = #0#7;
     fecha  = #0#8;
     docume = docum;        ||nuevo
     asient = docume;
     cabe = 0;
     |ABRE #8;
     |ABRE #con00637;
     |ABRE #caenlac@;
     cam = 0;
     |BUCLE asagicon0;

     |SI nSwCoste = 0;
        |SI #0#6 ! "R"; |Y cam = 1;
          |SI #6#4 = 1;
               |BUCLE asagicon2;
          |SINO;
               sw_pas = 0;
               |BUCLE asagicon2;
               |SI sw_pas = 1;
                    |HAZ suma;
               |FINSI;
               |BUCLE ascon00667;
          |FINSI;
        |FINSI;
     |FINSI;

     |CIERRA #caenlac@;
     |CIERRA #8;

     |CIERRA #con00637;

     |DELINDEX #8;
     |SI cam = 1;
          |ABRE #agifa142;
          #agifa142#0 = "A";
          |LEE 001#agifa142.=;
          |SI FSalida ! 0; |DDEFECTO #agifa142; |FINSI;
          |CIERRA #agifa142;
          |SI #agifa142#23 = "S";
               |SI #0#27 = "S";    || quieren mostrar un informe de asientos
                   |HAZ Informe_Asientos;
               |FINSI;

               aAlfa = #con00665#175; |QBF aAlfa;
               aAlfa = aAlfa + "fich/" + (("00000" + #con00665#0) % -105) + #con00665#1 + "/";
               fich_alta = aAlfa;
               nombre1 = "pu" + Usuario; |NOME_DAT #1000  nombre1;
               sub_prog = aAlfa; sub_prog = sub_prog - "agicont";
               |SI FSalida ! 0;
                  sub_prog = ":agicont";
               |SINO;
                  sub_prog = ":contagen";
               |FINSI;

               |SI #con00666#28 = "S";
                  |SI #con00666#30 = "S"; enGenIva0 = 1; |SINO; enGenIva0 = 0; |FINSI;
                  |SI #con00666#29 = "S"; enGenAsi0 = 1; |SINO; enGenAsi0 = 0; |FINSI;
               |SINO;
                  enGenIva0 = 0; enGenAsi0 = 0;
               |FINSI;
               |HAZ CogeVersion;
               PRMNT_enSwTaller = 1;
               PRMNT_enError = 0; enNoModif = 101;
               sub_prog = sub_prog + "/dsapunte.tab;";
               sub_prog = sub_prog + aAlfa;         |QBF sub_prog;
               sub_prog = sub_prog + "," + nombre1; |QBF sub_prog;
               |SUB_EJECUTA_NP sub_prog;
          |FINSI;
     |FINSI;
|FPRC;

|CALCULO actual; |TIPO 3;
     || Desdoblo esto para que se pueda llamar dos veces a un enlace (por los
     ||    enlaces de costes)
     nSwCoste = 0;
     nEmpresa = #0#13; nPeriodo = #0#14;
     |HAZ HazEnlace;

     |ABRE #con00649; |SELECT #2#con00649;
     |DDEFECTO #con00649;
     #con00649#1 = #con00666#17;
     |LEE 000#con00649.];
     |PARA; |SI FSalida = 0; |HACIENDO;
        |PINTA 2302, "  Ejecutando enlace simultaneo ... ";
        |ABRE #6;
        #6#120 = #con00649#0;
        |LEE 040#6=;
        |SI FSalida = 0;
           nEmpresa = #6#0; nPeriodo = #6#1;
           #0#13 = #6#0; #0#14 = #6#1;

           #con00666#17 = #con00649#0;
           nSwCoste = 1;
           |HAZ inicio;
           |HAZ HazEnlace;
        |SINO;
           aAlfa = "    !! ATENCION !! El enlace simultaneo " + #con00649#0 + " no existe. Se ignorara este pase.";
           |MENAV aAlfa;
        |FINSI;
        |CIERRA #6;

        |LEE 000#con00649.s;
     |SIGUE;
     |SELECT #1#con00649; |CIERRA #con00649;

     |SI PRMNT_enError = 0;
        |ABRE #agifa134;
        |BUCLE MarcaCont;
        |CIERRA #agifa134;
     |FINSI;

     |DELINDEX #caenlac@; |HAZ DesCargaDef;
|FCAL;

||**************** PREINFORME CONTABLE  - ANNA & ROBERT ***************
||**************** Alejandro 04/01/2000 *******************************
/*
|PROCESO encoemp5;
     |PRINT;             || imprime cada linea leeida del fichero encoemp5
|FPRC;

|DEFBUCLE encoemp5;      || bucle que recorre todo el fichero encoemp5
     #30#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL,NULL,NULL,NULL,NULL,encoemp5;
     #30#2;
|FIN;
*/
|PROCESO encoemp5;
     |PRINT;             || imprime cada linea leeida del fichero encoemp5
|FPRC;

|DEFBUCLE encoemp5;      || bucle que recorre todo el fichero encoemp5
     #1000#1004;
     ;
     00, "01,01,0000", 000000, 0000;
     99, "31,12,9999", 999999, 9999;
     ;
     NULL,encoemp5;
|FIN;

|PROCESO Informe_Asientos;
     |IMPRE 0;
     |SI FSalida = 0;
          |INFOR "con00666";       || nombre del preinforme contable
          |SI FSalida = 0;
               |BUCLE encoemp5;
               |PIEINF;
               |FININF;
          |SINO;
               |MENAV "    Informe Inexistente ....";
          |FINSI;
          |FINIMP;
     |SINO;
          |MENAV "    Impresora no Conectada ....";
     |FINSI;
|FPRC;

|| ************************ CALCULOS DE PANTALLA *************************

|CALCULO inicio; |TIPO 7;

     |HAZ DesCargaDef;
     |ABRE #6;
     #6#120  = #0#17;
     |LEE 040#6=;
     |SI FSalida ! 0;
        |MENAV "    Codigo inexistente en control pase";
        |CIERRA #6;
        |ERROR; |ACABA;
     |FINSI;
     |CIERRA #6;

     aPath = #6#175; |QBF aPath;
     path = #6#175; |QBF path;
     |HAZ CargaDef;
     empresa = #0#13;
     empresa = "00000" + empresa;
     empresa = empresa % -105;
     anyo = #0#14;
     anyo = "0" + anyo;
     anyo = anyo % -101;
     empresa = empresa + anyo;

     dir_fich = path + "fich/";
     |PATH_DAT #3 dir_fich;
     |ABRE #3;
     #3#2 = #0#13;
     #3#3 = #0#14;
     |LEE 040#3=;
     |SI FSalida ! 0;
          |MENAV "      No existe Empresa Contable";
          |ERROR;
     |SINO;
          |ABRE #6;
          #6#120   = #0#17;
          |LEE 040#6=;
          |SI FSalida ! 0;
               |MENAV "     No existe control con esta empresa.";
               |ERROR;
          |SINO;
               path = path + "fich/" + empresa +  "/";
               aAlfa = #6#175; |QBF aAlfa;
               aAlfa = aAlfa - "contagen/";
               |SI FSalida ! 0;
                   aAlfa = aAlfa + "modelos/fich/";
                   |PATH_DAT #12aAlfa;
               |SINO;
                   |PATH_DAT #12path;
               |FINSI;
               |PATH_DAT #13path;
               dig1 = #3#11;
               dig3 = #3#13;
               dig4 = #3#14;
               dig5 = #3#15;
               dig6 = #3#16;
               dig7 = #3#17;
               dig8 = #3#18;
               dig9 = #3#19;
               clave2 = ("00" + #3#26) % -102;
               cod2 = #3#26;
               tra1 = 100 + #3#11;
               mes1 = tra1 % -102;
               |SI cod2 < 80; |O cod2 > 99;
                    traba1 = "01." + mes1 + ".20" + clave2;
               |SINO;
                    traba1 = "01." + mes1 + ".19" + clave2;
               |FINSI;
               fec1 = traba1;
               tra1 = 100 + #3#12;
               mes1 = tra1 % -102;
               |SI #3#11 > #3#12;
                    cod2 = cod2 + 1;
               |FINSI;
               dia1 = "31";
               |SI #3#12 = 4; |O #3#12 = 6; |O #3#12 = 9; |O #3#12 = 11;
                    dia1 = "30";
               |FINSI;
               |SI #3#12 = 2;
                    dia1 = "28";
                    |SI cod2 = 88; |O cod2 = 92; |O cod2 = 96; |O cod2 = 0; |O cod2 = 4;
                         dia1 = 29;
                    |FINSI;
               |FINSI;
               tra1 = 100 + cod2;
               clave2 = tra1 % -102;
               |SI cod2 < 80; |O cod2 > 99;
                    traba1 = dia1 + "." + mes1 + ".20" + clave2;
               |SINO;
                    traba1 = dia1 + "." + mes1 + ".19" + clave2;
               |FINSI;
               fec2 = traba1;
               #0#4 = fec1;
               #0#5 = fec2;
               |PINTA #0#4;
               |PINTA #0#5;
          |FINSI;
          |CIERRA #6;
     |FINSI;
     |CIERRA #3;
|FCAL;

|CALCULO fecha;
     |SI #0Campo < fec1; |O #0Campo > fec2;
          |MENAV "     Fecha ERRONEA ";
          |ERROR;
     |FINSI;
|FCAL;

|PROCESO fechafac;
     |SI #0#6 = "F";
          |CAMPO_MODIFICA #0#18 , 1 , AN;
          |CAMPO_MODIFICA #0#8 , 1 , AN;
     |SINO;
          |CAMPO_MODIFICA #0#18 , 1 , AS;
          |CAMPO_MODIFICA #0#8 , 1 , AS;

          |SI #0#18 = "S";
               |CAMPO_MODIFICA #0#8 , 1 , AS;
          |SINO;
               |CAMPO_MODIFICA #0#8 , 1 , AN;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO borrapasada;
/*
     |ABRE #9;
     |ABRE #31;
     |LEE 001#30p;
     |PARA ; |SI FSalida = 0; |HACIENDO;
          |SI #30#47 ! 0;      ||si el nuevo documento ! 0, quiere decir que
               |HAZ desactual;     ||ya ha pasado a contabilidad
               |BORRA 021#30a;    ||Borro el actual
          |FINSI;
          |LEE 001#30s;
     |SIGUE;
     |CIERRA #31;
     |CIERRA #9;
*/
|FPRC;

|PROCESO desactual;
/*
     |SI #30#22 = 0; |Y #30#23 = 0; |Y #30#24 = 0;     ||ES apunte
          |HAZ des_cuen;      ||desactualizo el fichero encocuen
     |SINO;                                            ||ES iva
          |HAZ des_rec;
     |FINSI;
*/
|FPRC;

|PROCESO des_cuen;
/*
     #9#0 = 1;      ||Codigo
     cuenta_des = #30#5;
     |QBT cuenta_des;
     |SI cuenta_des = "";
          #9#1 = #30#6;
          #9#2 = #30#8;
          #9#4 = "H";
     |SINO;
          #9#1 = #30#5;  ||Cuenta
          #9#2 = #30#7;  ||DC
          #9#4 = "D";    ||signo
     |FINSI;
     #9#3 = #30#1;       ||fecha
     #9#5 = 0;           ||Importe
     #9#6 = #30#0;       ||DIARIO
     |LEE 101#9];
     |SI FSalida = 0;
          #9#5 =#9#5 - #30#12;
     |FINSI;
     |GRABA 021#9a;
     |LIBERA #9;
*/
|FPRC;

|PROCESO des_rec;        ||desactualizo los recibos
/*
     |LEE 001#31p;
     |PARA ; |SI FSalida = 0; |HACIENDO ;
          |SI #31#1 = #30#16;      ||Si el numero de orden de la factura
               |BORRA 021#31a;     ||es igual al del iva lo borro
          |FINSI;
          |LEE 001#31s;
     |SIGUE;
*/
|FPRC;

|PROCESO cuen_rep;
     |ABRE #33;
     #33#0 = #7#7;
     |LEE 001#33=;
     |SI FSalida ! 0; |DDEFECTO #33; |FINSI;
     |CIERRA #33;
|FPRC;


|| Controlo que no me meta una definicion de compras en un enlace de ventas
|| y pinta la descripcion del enlace
|PROCESO tipo;
   |ATRI R;
      |PINTA 0802,#con00665#156;
   |ATRI r;

   |SI #con00665#157 ! 0;|Y #con00665#157 ! 1;
        mensaje="0000La definicion del asiento no es de Ventas";
        |MENAV mensaje;
        |ERROR;
   |FINSI;
|FPRC;

|PROCESO cuenta_ser;
 seriec = #7#49;  || Serie de la Factura
 |HAZ abre_ser8;
 |SI swhot = 1; cuenta = ""; |ACABA; |FINSI;
 |SI hot_tip = 1; cuenta = #5#5; |FINSI;     || Cuenta de Ventas
 |SI hot_tip = 2; cuenta = #5#4; |FINSI;     || Cuenta de Compras
|FPRC;


|PROCESO cuenta_ser1;

 seriec = #10#29;  || Serie del Albaran
 |HAZ abre_ser8;
 |SI swhot = 1; |ACABA; |FINSI;

 alfa3 = hot_cta; |QBF alfa3;
 |SI alfa3 = "";
     |SI hot_tip = 1; hot_cta = #5#5; |FINSI;     || Cuenta de Ventas
     |SI hot_tip = 2; hot_cta = #5#4; |FINSI;     || Cuenta de Compras
     |ACABA;
 |FINSI;

|| -------------------------- Campos de control del Cambio
     n_alfa1 = "";
     nume1 = #5#1 - 1; || Antes
     |SI nume1 > 0;
         nume1 = 100 + nume1;
         n_alfa1 = nume1;
     |FINSI;

     n_alfa2 = "";
     nume2 = #5#1 + #5#2; || Despues
     |SI nume2 [ 12;
         nume3 = 13 - nume2;
         nume3 = nume2 * 100 + nume3;
         n_alfa2 = nume3;
     |FINSI;
     masca = #5#3;  |QBF masca;

     alfa3 = ""; alfa2 = "";
     |SI n_alfa1 ! "";
         alfa3 = hot_cta % n_alfa1;
     |FINSI;
     |SI n_alfa2 ! "";
         alfa2 = hot_cta % n_alfa2;
     |FINSI;
     hot_cta = alfa3 + masca + alfa2;
|FPRC;

|PROCESO abre_ser8;
 swhot = 0;
 |ABRE #5;
 |DDEFECTO #5;
 #5#0 = seriec;
 |LEE 001#5=;
 |SI FSalida ! 0;   || No existe registro de Cuentas
     swhot = 1;
 |FINSI;
 |CIERRA #5;
|FPRC;

|PROCESO DesCargaDef;
     |SI aDef13 ! ""; |DESCARGA_DEF #caconas@; aDef13 = ""; |FINSI;
     |SI aDef12 ! ""; |DESCARGA_DEF #caconce@; aDef12 = ""; |FINSI;
     |SI aDef30 ! ""; |DESCARGA_DEF #caenlac@; aDef30 = ""; |FINSI;
     |SI aDef3  ! ""; |DESCARGA_DEF #canempr@; aDef3  = ""; |FINSI;
|FPRC;

|PROCESO CargaDef;
     |ABRE #6;
     #6#120 = #0#17;
     |LEE 000#6=;
     |CIERRA #6;

     aPath = #6#175; |QBF aPath;
     path = #6#175; |QBF path;
     aMensa = "";

     aDef3 = aPath + "def/canempre";
     |CARGA_DEF aDef3, canempr@;
     |SI FSalida ! 0;
          aMensa = "0000Error al cargar:" + aDef3;
          |MENAV aMensa;
          aDef3 = "";
     |FINSI;

     aDef30 = aPath + "def/caenlace";
     |CARGA_DEF aDef30, caenlac@;
     |SI FSalida ! 0;
          aMensa = "0000Error al cargar:" + aDef30;
          |MENAV aMensa;
          aDef30 = "";
     |FINSI;

     aAlfa = aPath; |QBF aAlfa;
     aAlfa = aAlfa - "contagen/";
     |SI FSalida ! 0;
        aDef12 = aAlfa + "modelos/def/dsmom030.mas";
     |SINO;
        aDef12 = aPath + "def/caconcep";
     |FINSI;

     |CARGA_DEF aDef12, caconce@;
     |SI FSalida ! 0;
          aMensa = "0000Error al cargar:" + aDef12;
          |MENAV aMensa;
          aDef12 = "";
     |FINSI;

     aDef13 = aPath + "def/caconasi";
     |CARGA_DEF aDef13, caconas@;
     |SI FSalida ! 0;
          aMensa = "0000Error al cargar:" + aDef13;
          |MENAV aMensa;
          aDef13 = "";
     |FINSI;

     |SI aMensa ! "";
          |HAZ DesCargaDef;
          |PTEC 807;
     |FINSI;
|FPRC;

|PROCESO Tipo8; |TIPO 8;
     aMoneda = "B";
     |ABRE #agifa321;
     |LEE 000#agifa321.p;
     |CIERRA #agifa321;
     aDivisa = #agifa321#9;
     |HAZ Divisas134;
|FPRC;

|PROCESO Aviso;
   |SI FSalida = 2; |ACABA; |FINSI;
   |SI #0#29 ! #0#30;
      |CONFI "    NPara un pase de datos correcto debe ser de asientos y registro de IVA. Continuar ? ";
      |SI FSalida ! 0; |ERROR; |FINSI;
   |FINSI;
|FPRC;

|PROCESO RecorreAlbaran;
   |BUCLE LeeAlbaran;
|FPRC;

|PROGRAMA;
   |HAZ Tipo8;
   |SI eaEnlace = "";
      |MANTE #con00666;
   |SINO;
      #0#17 = eaEnlace;
      #0#24 = eaSerieA;
      #0#2  = enFactura;
      #0#3  = enFactura;
      #0#4  = "01.01.0000";
      #0#5  = "31.12.9999";
      #0#13 = enEmpresa;
      #0#14 = enPeriodo;
      #0#15 = "      ";
      #0#16 = "zzzzzz";

      |HAZ inicio;
      |HAZ actual;
   |FINSI;
|FPRO;
