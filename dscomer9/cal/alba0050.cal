|FICHEROS;
     alba0034 #98;       || Cabecera revision.
     alba0035 #99;       || Lineas revision.
     agifa069 #0;        || Lineas Fact. Contado.
     agifa084 #1;        || Cabecera Fact. Contad.
     agifa019 #2;        || Articulos.
     agifa024 #6;        || Clientes.
     agifa017 #8;
     agifa065 #9;
     agifa025 #12;       || Representantes.
     agifa048 #13;
     agifa049 #14;
     agifa142 #41;
||     agifa114 #44;
||     agifa174 #46;
     agifa321 #54;  || Divisas-Parametros.
     agifa324 #55;  || Divisas-Divisas.
     alba0007 #47,MANTE;
     dsm00024 #24;
     dsz99984 #100;
     agifa091 #101;
     agifa177 #102;
     agifa133 #103;
|FIN;

|CAMPOS;
     #2#11 nec;#2#15 sps;#2#16 spr; #2#12 stres;#2#13 stfa;
     #2#7 stmia;#2#104 stdia;#2#17 pdva;
|FIN;

|VARIABLES;
     &enDescuento1 = 0;
     &enDescuento2 = 0;
     &eaTComision  = "";
     &enComision   = 0;

     resto = 0;
     neto = 0;
     diferencia = 0;
     sw = 0;
     numero = "";
     tbruto = 0;
     vacio = "                    ";
     descu = 0;
     tf = 0;
     pc = 0;
     comi1 = 0;
     comi2 = 0;
     comi3 = 0;
     menor = 0;
     pc1 = 0;
     imneto = 0;
     margen = 0;
     a = 0;
     wimneto = 0;
     cantidad = 0;
     asto = 0;
     operacion = "FC";
     articulo = " ";
     fmes = "  ";
     mes = 0;
     me = 0;
     kl = 0;
     mescli= " ";
     mensaje3 = "0410 Stock Disponible Almacen :             Stock Minimo : ";
     mensaje  = "0000 Factura para exportacion.Tipo IVA = 0  !!!";
     totbu = 0;
     flag = 1;
     modo = 0;
     swescan = 0;
     &n_dec = 0;
     &n_pre = 0;
     primera = 0;
     retencion = 0;
     comision = 0;
     &aMoneda = "";
     &aDivisa = "";

     nVto     = 0;
     &eaProg   = "";
|FIN;

|INCLUYE i_varart;

|PROCESO Unidadess;
     |ABRE #47;
     #47#0 = "FD";
     #47#1 = #0#20;
     #47#2 = #0#0;
     #47#3 = #0#1;
     |LEE 101#47=;
     |SI FSalida ! 0; |GRABA 020#47b; |FINSI;
     #47#4 = #99#12;
     #47#5 = #99#13;
     #47#6 = #99#6;
     |GRABA 020#47a;
     |CIERRA #47;
     #0#5 = #47#6;  ||Uni1 Stock
     #0#30 = #47#4; ||Uni2 Factu

     eaArticulo = #0#2;
     |HAZ BseFactu2;
|FPRC;

|CALCULO defecfc;|TIPO 0;
|ABRE #12;
#12#0 = #98#10;
|LEE 000#12=;
|LIBERA #12;
|CIERRA #12;
#0#15 = #1#3;
#0#16 = #12#7;
#1#34 = #12#7;
#0#17 = #6#4;

|SI #0#2 ! #2#0;
    |ABRE #2;
    #2#0 = #0#2;
    |LEE 000#2=;
    |LIBERA #2;
    |CIERRA #2;
|FINSI;

#0#13 = #2#2;

|SI #0#15 ! #6#0;
    |ABRE #6;
    #6#0 = #0#15;
    |LEE 000#6=;
    #1#5 = #98#11;
    #1#7 = #98#12;
    #1#32 = #98#13;
    |LIBERA #6;
    |CIERRA #6;
|FINSI;
|FCAL;

|CALCULO lisubcom;|TIPO 0;
     enDescuento1 = #0#8;
     enDescuento2 = #0#21;
     eaTComision  = #0#16;
     eaCliente    = #1#3;
     eaArticulo   = #0#2;
     eaRepre      = #1#6;
     |HAZ Comisiones;
     #0#10 = enComision;
|FCAL;

|CALCULO comirep;
|ABRE #12;
#12#0 = #1#6;
|LEE 121#12=;
|SI FSalida ! 0;
    |GRABA 000#12c;
|FINSI;
|LIBERA #12;
comision = 0;
|SI 0 = FSalida;
      comision = imneto % #0#10;
      fmes = #1#1 % A402;
      mes = fmes - 1;
      mes = mes * 2;
      mes = mes + 11;
      #12mes = #12mes + comision;
      retencion = #12mes % #12#39;
      mes = mes + 1;
      #12#35 = #12#35 + comision;
      mes = fmes - 1;
      mes = mes + 40;
      #12mes = retencion;
      retencion = #12#35 % #12#39;
      #12#52 = retencion;
      |GRABA 020#12a;
      |LIBERA #12;

     enImpRepComi = comision;
     enImpRepVta = imneto;
     enImpRepRete = retencion;
     eaRepre = #1#6;
     efFecha = #1#1;
     |HAZ AcumulaRep;
|FINSI;
|LIBERA #12;
|CIERRA #12;
|FCAL;

|CALCULO totfc;|TIPO 0;
#0#7 = #0#30 * #0#6;
#0#9 = #0#7 < #0#8;
#0#9 = #0#9 < #0#21;
#0#9 = #0#9 ! #55#7;
#0#14 = #0#30 * #2#9;         ||Coste total linea 23-09-93 Jordi BCN
|FCAL;

|CALCULO fcacarti;
modo = 1;
|SI Campo < 3;
    |HAZ defecfc;
|FINSI;
imneto = imneto + (#0#9 < #1#5);
imneto = imneto < #1#32;
imneto = imneto < #1#7;
imneto = imneto ! #55#7;
|ABRE #2;
#2#0 = #0#2;
|LEE 121#2=;
|LIBERA #2;
|SI 0 = FSalida;
    stdia = stdia - #0#5;
    #2#6 = #2#6 - #0#5;
    #2#10 = #2#6 - #2#17;
    |SI #2#10 > 0;
        #2#10 = #2#10 * #2#9;
    |SINO;
        #2#10 = 0;
    |FINSI;
    nec = sps + stmia; nec = nec - spr; nec = nec - stdia;
    nec = nec - pdva; nec = nec - stfa; nec = nec - stres;

    fmes = #1#1 % A402;
    mes = fmes - 1;
    mes = mes * 5;
    mes = mes + 34;
    #2mes = #2mes + #0#5;
    mes = mes + 1;
    #2mes = #2mes + imneto;
    margen = #0#30 * #2#9;
    margen = imneto - margen;
    mes = mes + 1;
    #1#37 = #1#37 + margen;
    #2mes = #2mes + margen;
    #2#94 = #2#94 + #0#5;
    #2#95 = #2#95 + imneto;
    #2#96 = #2#96 + margen;
    #2#24 = #1#1;
    #2#25 = #0#5;
    |GRABA 020#2a;
    |LIBERA #2;

    |SI modo = 1;
        |HAZ altahis;
    |FINSI;

    |LIBERA #2;
    |CIERRA #2;
    |ABRE #8;
    #8#0 = #0#2;
    #8#1 = #0#3;
    |LEE 121#8=;
    |LIBERA #8;
    |SI 0 = FSalida;
        #8#39 = #8#39 - #0#5;
        #8#5 = #8#5 - #0#5;
        #8#3 = #8#5 - #8#4;
        |SI #8#3 > 0;
            #8#3 = #8#3 * #2#9;
        |SINO;
            #8#3 = 0;
        |FINSI;
        mes = fmes - 1;
        mes = mes * 2;
        mes = mes + 11;
        #8mes = #8mes + #0#5;
        #8#35 = #8#35 + #0#5;
        #8#50 = #8#42 + #8#6 - #8#43 - #8#39; || necesidades
        #8#50 = #8#50 - #8#4 - #8#9 - #8#8;
        |HAZ ActPartida;
        |GRABA 020#8a;
        |LIBERA #8;
    |FINSI;
    |CIERRA #8;
|FINSI;

efFecha = #1#1;
eaArticulo = #0#2;
enAlmacen = #0#3;
enUniVta = #0#5;
enImpVta = imneto;
enImpMar = margen;
enUniSal = #0#5;
|HAZ AcumulaArt;
|HAZ AcumulaAlm;


#1#15 = #1#15 + #0#9;

|SI #0#11 = 0; #1#28 = #1#28 + imneto; |FINSI;

|SI #0#11 = 1;
    #1#16 = #1#16 + imneto; mes = #1#16; #1#17 = mes % #1#50;
    |SI #1#36 = "S";
        #1#18 = mes % #1#51;
    |FINSI;
|FINSI;

|SI #0#11 = 2;
    #1#19 = #1#19 + imneto; mes = #1#19; #1#20 = mes % #1#52;
    |SI #1#36 = "S";
        #1#21 = mes % #1#53;
    |FINSI;
|FINSI;

|SI #0#11 = 3;
    #1#22 = #1#22 + imneto; mes = #1#22; #1#23 = mes % #1#54;
    |SI #1#36 = "S";
        #1#49 = mes % #1#55;
    |FINSI;
|FINSI;

|SI #0#11 = 4;
    #1#42 = #1#42 + imneto; mes = #1#42; #1#43 = mes % #1#56;
    |SI #1#36 = "S";
        #1#44 = mes % #1#57;
    |FINSI;
|FINSI;

|SI #0#11 = 5;
    #1#45 = #1#45 + imneto; mes = #1#45; #1#46 = mes % #1#58;
    |SI #1#36 = "S";
        #1#47 = mes % #1#59;
    |FINSI;
|FINSI;

mes = imneto % #0#10;
#1#17 = #1#17 ! #55#7; #1#20 = #1#20 ! #55#7;
#1#23 = #1#23 ! #55#7; #1#18 = #1#18 ! #55#7;#1#21 = #1#21 ! #55#7;
#1#24 = #1#17 + #1#20;
#1#24=#1#24+#1#23+#1#18+#1#21+#1#43+#1#44+#1#46+#1#47+#1#49;
|GRABA 101#1a;
|LIBERA #1;
|FCAL;

|CALCULO altahis;|TIPO 0;
     |ABRE #9;
     |DDEFECTO #9;
     #0#2 = #99#4;       || Cod. Articulo.
     #9#0 = #0#2;
     #9#11= #0#20;
     #9#1 = #1#1;
     #9#2 = operacion;
     #9#3 = #0#0;
     #9#4 = #0#1;
     #9#5 = #0#3;        || almacen
     #9#6 = #0#5 * -1;   || stock
     #9#7 = #2#6;
     #9#8 = #2#9;
     #9#9 = #0#6;
     #1#3 = #98#4;
     #9#10 = #1#3;
     #9#12 = #0#8;
     #9#13 = #0#21;
     #9#14 = #0#6 < #9#12;
     #9#14 = #9#14 < #9#13;
     #9#18 = #0#31;
     |GRABA 121#9n;
     |LIBERA #9;
     |CIERRA #9;
     swescan = 1;
     |HAZ para_ger;
     |SI #41#12 = "S";
         |HAZ actualiz;
     |FINSI;
|FCAL;

|CALCULO altaescan;
|ABRE #9;
|DDEFECTO #9;
#9#0 = #14#2;
#9#11= #0#20;
#9#1 = #1#1;
#9#2 = operacion;
#9#3 = #0#0;
#9#4 = #0#1;
#9#5 = #0#3;        || almacen
#9#6 = #0#5 *  a;   || stock
#9#7 = #2#6;
#9#8 = #2#9;
#9#9 = #0#6;
#9#10 = #1#3;
#9#12 = #0#8;
#9#13 = #0#21;
#9#14 = #0#6 < #9#12;
#9#14 = #9#14 < #9#13;
|GRABA 121#9n;
|LIBERA #9;
|HAZ artialta;
|FCAL;

||***************************** CALCULO ESCANDALLOS *******************;
|CALCULO linescan;
     #2#0 = #14#2;
     |LEE 110#2=;
     |LIBERA #2;
     |SI swescan = 1;
         |HAZ altaescan;
     |FINSI;
|FCAL;

|CALCULO actualiz;
       |ABRE #13;
       #13#0 = #0#2;
       |LEE 110#13=;
       |LIBERA #13;
       |SI FSalida = 0;
           #2#0 = #13#0;
           |LEE 110#2=;
           |LIBERA #2;
           |BUCLELIN 0linescan#13;
       |FINSI;
       |LIBERA #13;
       |CIERRA #13;
|FCAL;

|PROCESO ActPartida;
   |ABRE #24;
   #24#0 = #0#2;
   #24#1 = #0#3;
   #24#2 = #0#31;
   |LEE 101#24=;
   |SI FSalida = 0;
        #24#11 = #24#11 + #0#5;
        #24#22 = #24#22 - #0#5;
        #24#31 = #24#31 - #0#5;
        |HAZ ValoraStock;
        |GRABA 020#24a;
   |FINSI;
   |CIERRA #24;
|FPRC;

|CALCULO artialta;
   |ABRE #8;
   mes = 0 + 1;
   wimneto = #0#9 < #1#5;
   wimneto = wimneto < #1#32;
   wimneto = wimneto < #1#7;
   wimneto = wimneto ! #55#7;            || puesto el 01-02-90 Javier

    |DDEFECTO #8;
   #8#0 = #14#2; ||Articulo;
   #8#1 = #14#9; ||Almacen;
   |LEE 110#8=;
   |LIBERA #8;
   |SI FSalida = 0;
       wimneto = (wimneto * #14#6) /  #13#9;
       cantidad = #0#30 * #14#4
       stdia = stdia - cantidad;
       #2#6 = #2#6 - cantidad;
       asto = #2#6 - #2#17;
       |SI asto > 0;
           #2#10 = asto * #2#9;
       |SINO;
           #2#10 = 0;
       |FINSI;
       nec = sps + stmia; nec = nec - spr; nec = nec - stdia;
       nec = nec - pdva;  nec = nec - stfa;nec = nec - stres ;

       fmes = #1#1 % A402;
       mes = fmes - 1;
       mes = mes * 5;
       mes = mes + 34;
       #2mes = #2mes + cantidad;
       margen = cantidad * #2#9;
       margen = wimneto - margen;
       mes = mes + 1;
       #2mes = #2mes + wimneto;
       mes = mes + 1;

       #2mes = #2mes + margen;
       #2#94 = #2#94 + cantidad;
       #2#95 = #2#95 + wimneto;
       #2#96 = #2#96 + margen;

       #8#39 = #8#39 - cantidad;
       #8#5 = #8#5 - cantidad;
       asto = #8#5 - #8#4;
       |SI asto > 0;
           #8#3 = asto * #2#9;
       |SINO;
           #8#3 = 0;
       |FINSI;
       mes = fmes - 1;
       mes = mes * 2;
       mes = mes + 11;
       #8mes = #8mes + cantidad;
       #8#35 = #8#35 + cantidad;
       #8#50 = #8#42 + #8#6 - #8#43 - #8#39; || necesidades
       #8#50 = #8#50 - #8#4 - #8#9 - #8#8;
       |GRABA 121#8a;
       |LIBERA #8;
       |GRABA 121#2a;
       |LIBERA #2;
   |FINSI;
   |LIBERA #8;
   |CIERRA #8;

   efFecha = #1#1;
   eaArticulo = #14#2;
   enAlmacen = #14#9;
   enUniVta = cantidad;
   enImpVta = wimneto;
   enImpMar = margen;
   enUniSal = cantidad;
   |HAZ AcumulaArt;
   |HAZ AcumulaAlm;
|FCAL;

|PROCESO pasa;
     |HAZ LeeDivisa;
     numero = "000000" + #99#1;
     numero = numero % -106;
     |SI #0#0 ! numero; |O #0#20 ! #99#2;   |HAZ grabat;   |FINSI;
     |DDEFECTO #0;
     #0#0 = numero;                || Numero Factura.
     #0#20 = #99#2;                || Serie Factura.
     #1#0 = #0#0;                  || Numero Factura Cabecera.
     #1#48 = #0#20;                || Serie Fact. Cab.
     |LEE 121#1=;                  || Lee cabecera de fact. contado.
     |LIBERA #1;
     imneto=0;
     #0#1 = #99#3;                 || Linea Factura.
     |ABRE #98;
     #98#0 = #99#0;
     #98#1 = #99#1;
     #98#2 = #99#2;
     |LEE 000#98=;
     |LIBERA #98;
     |CIERRA #98;
     #0#2 = #99#4;                 || Cod. Articulo.
     |ABRE #2;
     #2#0 = #99#4;
     |LEE 000#2=;
     |LIBERA #2;
     |CIERRA #2;
     #0#3 = #99#11;                || Nro. Almacen.
     #0#4 = #2#1;                  || Descrip. Articulo.
     #0#6 = #99#7;                 || Precio.
     ||#0#7 = #99#10;                || Importe.
     #0#8 = #99#8;                 || Dto.
     #0#9 = #0#7 < #0#8;           || Importe Total.
     #0#9 = #0#9 ! #55#7;
     #0#11 = #99#9;                || Tipo Iva.
     #0#13 = #2#2;                 || Familia.
     #0#14 = #2#9;                 || P.M.C.
     #0#15 = #98#4;                || Cliente.
     |ABRE #6;
     #6#0 = #98#4;
     |LEE 000#6=;
     |LIBERA #6;
     |CIERRA #6;
     #0#17 = #6#4;                 || Tipo cliente.
     #0#19 = "N";                  || Actualizado.
     |HAZ Unidadess;
     |HAZ totfc;
     #0#26 = #0#6;
     #0#27 = #0#9;
     #0#28 = #0#6;
     #0#29 = #0#9;
     #0#44 = #99#15 * #99#6;
     #0#31 = #99#17; || Partida
     |HAZ fcacarti;
     |HAZ defecfc;
     |HAZ lisubcom;
     tbruto = tbruto + #0#9;
     |GRABA 121#0n;
     |LIBERA #0;
     |GRABA 121#1a;
     |LIBERA #1;
|FPRC;

|DEFBUCLE lee;
     #99#1;
     ;
     "F","     ",000000,001;
     "F","zzzzz",999999,999;
     be;
     NULL,pasa;
|FIN;

|PROGRAMA;
     aMoneda = "B";
     aDivisa = "EUR";
     |HAZ Divisas084;

     sw = 0;
     modo = 1;
     |ABRE #0;
     |ABRE #1;
     |BUCLE lee;
     |HAZ grabat;
     |LIBERA #0;
     |CIERRA #0;
     |LIBERA #1;
     |CIERRA #1;
|FPRO;

|PROCESO grabat;
     |SI sw = 1;
         #1#15 = tbruto;          || Total Bruto.
         neto = tbruto - #1#25;
         resto = #1#16 + #1#19 + #1#22 + #1#42 + #1#45
         diferencia = neto - resto;
         |SI diferencia ! 0;
             |SI #1#16 ! 0;
                 #1#16 = #1#16 + diferencia;
             |SINO;
                 |SI #1#19 ! 0;
                     #1#19 = #1#19 + diferencia;
                 |SINO;
                     |SI #1#22 ! 0;
                         #1#22 = #1#22 + diferencia;
                     |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;

         #1#41 = #1#15 - #1#25;
         #1#41 = #1#41 + #1#11;
         #1#41 = #1#41 + #1#13;
         #1#41 = #1#41 + #1#24;
         #1#71 = #1#41;
         #1#73 = #1#41;
         #1#75 = #1#41;
         #1#70 = #1#15;
         #1#72 = #1#15;
         #1#74 = #1#15;
         |GRABA 121#1a;
         |LIBERA #1;
         || --------- Generacion de total recibos --------------;
         |ABRE #41;
         |DDEFECTO #41;
         #41#0 = "A";
         |LEE 001#41=;
         |LIBERA #41;
         |CIERRA #41;
         |SI #41#47 = "S";
            |ABRE #agifa133;
            #agifa133#0 = #agifa084#0;
            #agifa133#4 = #agifa084#48;
            #agifa133#1 = 0;
            |LEE 001#agifa133.];
            nVto = 0;
            |SI FSalida ! 0; |O #agifa133#0 ! #agifa084#0;  |O #agifa133#4 ! #agifa084#48;
                |HAZ VenciDir;
            |FINSI;

            |ABRE #99;
            nVto = 0;
            #agifa133#0 = #agifa084#0;
            #agifa133#4 = #agifa084#48;
            #agifa133#1 = 0;
            |LEE 001#agifa133.];
            |PARA ; |SI FSalida = 0; |Y #agifa133#0 = #agifa084#0;|Y #agifa133#4 = #agifa084#48; |HACIENDO;
                 nVto = nVto + 1;
                 |LEE 001#agifa133.s;
            |SIGUE;

            |HAZ AbreRecVenta;

            #agifa133#0 = #agifa084#0;
            #agifa133#4 = #agifa084#48;
            #agifa133#1 = 0;
            |LEE 001#agifa133.];
            |PARA ; |SI FSalida = 0; |Y #agifa133#0 = #agifa084#0;|Y #agifa133#4 = #agifa084#48; |HACIENDO;
                 |DDEFECTO #dsz99984;
                 #dsz99984#17 = #agifa084#48;
                 #dsz99984#0  = #agifa084#0;
                 #dsz99984#1  = #agifa133#1;           || Linea;
                 #dsz99984#2  = #agifa084#3;            || cliente
                 #dsz99984#3  = #agifa084#4;            || nombre del cliente
                 #dsz99984#4  = #agifa024#29;           || Banco
                 #dsz99984#5  = "S";             || domiciliado
                 #dsz99984#6  = "N";             || aceptado
                 #dsz99984#7  = #agifa084#1;            || fecha de emision
                 #dsz99984#8  = #agifa133#3;           || Fecha de vencimiento
                 #dsz99984#9  = #agifa133#2;           || Importe
                 #dsz99984#10 = "N";            || Impreso
                 #dsz99984#11 = "N";            || Contabilizado
                 #dsz99984#12 = #agifa084#40;

                 |ABRE #agifa091;
                 |DDEFECTO #agifa091;
                 #agifa091#0 = #agifa084#8;
                 |LEE 000#agifa091.=;
                 |CIERRA #agifa091;
                 |SI #agifa142#63 = "S";
                      #agifa177#0 = #agifa091#69;
                      |LEE 000#agifa177.=;
                      |SI FSalida = 0;
                           #dsz99984#12 = #agifa177#3;     || NUMERO CTA.CONTABLE.
                      |SINO;
                           #dsz99984#12 = #agifa084#40;     || NUMERO CTA.CONTABLE.
                      |FINSI;
                 |SINO;
                      #dsz99984#12 = #agifa084#40;          || NUMERO CTA.CONTABLE.
                 |FINSI;
                 #dsz99984#13 = "N";            || Cobrado
                 #dsz99984#14 = "N";            || Impagado
                 #dsz99984#15 = #agifa024#161;         || A aceptar
                 #dsz99984#16 = "01.01.0000";   || fecha de cobro
                 #dsz99984#18 = #agifa084#40;          || Cta
                 #dsz99984#21 = #agifa091#69;          || Tipo de Recibo (forma de pago)
                 #dsz99984#22 = "Pdte. Cobro";
                 #dsz99984#23 = nVto;
                 #dsz99984#24 = #agifa091#0;
                 #dsz99984#25 = #agifa091#1;

                 #dsz99984#26 = "";
                 #dsz99984#27 = "";
                 #dsz99984#29 = "";
                 #dsz99984#28 = "";
                 eaProg = "agifa084";
                 |HAZ RecVenta;
                 |LEE 001#agifa133.s;
            |SIGUE;
            |CIERRA #agifa133;
            |CIERRA #agifa177;
            enDirEnt = #agifa084#91; |HAZ CierraRecVenta;
         |FINSI;

         #1#15 = 0;imneto = 0;tbruto = 0;
     |FINSI;

     sw = 1;
|FPRC;

|PROCESO para_ger;
     |ABRE #41;
     #41#0 = "A";
     |LEE 001#41=;
     |SI FSalida ! 0; |DDEFECTO #41; |FINSI;
     |LIBERA #41;
     |CIERRA #41;
|FPRC;

|PROCESO LeeDivisa;
     |ABRE #54;
     |ABRE #55;
     #54#0 = "A";
     |LEE 001#54=;
     |SI FSalida ! 0; |DDEFECTO #54; |FINSI;
     #55#0 = #54#9;
     |LEE 001#55=;
     |SI FSalida ! 0; |DDEFECTO #55; |FINSI;
     |LIBERA #54;
     |LIBERA #55;
     |CIERRA #54;
     |CIERRA #55;
|FPRC;
