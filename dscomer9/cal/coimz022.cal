|FICHEROS;
     coimz022 #0;
     coima003 #3;
     coima006 #6;
     coima007 #7;
     agifa010 #10;
     coimw015 #15; ||Tmp
     coima022 #22;
     agifa024 #24;
     dsm00003 #30;
     agifa071 #71;
     agifa073 #73;
     agifa104 #104;
     refere1@;
     refere2@;
     refere3@;
|FIN;

|VARIABLES;
     x = 0;
     &eaAct = "";
     aBase = "";
     aEmp = "";
     nEmpresa = 0;
     aSerie = "";
     nPedido = 0;
     aBloqueado = "N";
     {1}aBaseLocal = "";
     aMensaje = "";
     aIP = "";
     aSubject = "";
     aMailRep =
     aDjunto = "";
     aServidor = "";
     aFrom = "";
     aTo = "";
     aEmail = "";
     &enTipo = "";
     &Tempo = "";
     nPdte = 0;
     aFic = "";
     aDato = "";
     nHandle = 0;
     nCampo = 0;
     aTmp15 = "";
     aAlfa = "";
     aCli = "";
     nDir = 0;
     aSer = "";
     i = 0;
|FIN;

|INCLUYE i_varart;

|PROCESO dscam038;
     |SI aSerie ] #refere2@#3; |Y aSerie [ #refere2@#4;
          aEmp = ("00000" + #refere2@#5) % -105;
          aAlfa = aBase + "dscarter/fich/" + aEmp + "/";
          |PATH_DAT #refere3@#aAlfa#;
          #refere1@#0 = #refere2@#0;
          |LEE 020#refere1@.=;
          |SI FSalida = 0;
               |ABRE #refere3@;
               #refere3@#0 = #104#4;
               |LEE 000#refere3@.=;
               |SI FSalida = 0; |Y #refere3@#9 = "S";
                    aBloqueado = "S";
               |FINSI;
               |CIERRA #refere3@;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dscam038;
     #refere2@#1002;
     2;
     nEmpresa, 001, "A"; ||lee el control albaranes
     nEmpresa, 999, "A";
     ;
     NULL, dscam038;
|FIN;

|PROCESO RieCliBloq;
     aBloqueado = "N";
     |DBASS aBase;
     aAlfa = aBase + "dscarter/def/dscam037";
     |CARGA_DEF aAlfa, refere1@;
     |SI FSalida = 0;
          aAlfa = aBase + "dscarter/def/dscam038";
          |CARGA_DEF aAlfa, refere2@;
          |SI FSalida = 0;
               aAlfa = aBase + "dscarter/def/dscam023";
               |CARGA_DEF aAlfa, refere3@;
               |SI FSalida = 0;
                    |DFICE aAlfa; aAlfa = aAlfa % -205; nEmpresa = aAlfa;
                    aAlfa = aBase + "dscarter/fich/";
                    |PATH_DAT #refere2@#aAlfa#;
                    |PATH_DAT #refere1@#aAlfa#;
                    |ABRE #refere1@;
                    |BUCLE dscam038;
                    |CIERRA #refere1@;
                    |DESCARGA_DEF #refere3@;
               |FINSI;
               |DESCARGA_DEF #refere2@;
          |FINSI;
          |DESCARGA_DEF #refere1@;
     |FINSI;
|FPRC;

|PROCESO LinAlba;
     |SI #71#2 > #0#13; |Y #71#2 < #0#14;
          enTipo = 2; |PRINT;
     |FINSI;
|FPRC;

|PROCESO CalAlba;
     aAlfa = #10#83; |QBF aAlfa;
     |SI #10#2 ! 0; |O aAlfa ! "";
          |ERROR;
     |FINSI;
|FPRC;

|DEFBUCLE Albaran;
     #10#3;
     84, 2;
     aCli, "01.01.0000", aSer, 000001, nDir, 0;
     aCli, "31.12.9999", aSer, 999999, nDir, 0;
     ;
     NULL, CalAlba, LinAlba;
|FIN;

|PROCESO Albaranes;
     |SI aCli ] #0#11; |Y aCli [ #0#12;
          |SI aCli ! "";
               |SI aCli ! #15#5; |O nDir ! #15#6;
                    |SALVA_DATOS #15; || Para que funcione
                    #15#5 = aCli;     || la ordenacion
                    #15#6 = nDir;     || del crystal
                    |PARA i = 3; |SI i [ 10; |HACIENDO i = i + 1;
                         aSer = #0i;
                         |BUCLE Albaran;
                    |SIGUE;
                    |REPON_DATOS #15;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO TmpImpre;
     |HAZ Albaranes;

     #73#28 = #15#0;
     #73#0 = #15#1;
     #73#1 = #15#2;
     |LEE 020#73=;

     #104#25 = #15#0;
     #104#0 = #15#1;
     |LEE 020#104=;

     #7#0 = #15#0;
     #7#1 = #15#1;
     #7#2 = #15#2;
     |LEE 000#7=;
     |SI FSalida ! 0; |DDEFECTO #7; |FINSI;

     enTipo = 1; |PRINT;

     aCli = #15#5;
     nDir = #15#6;
|FPRC;

|DEFBUCLE TmpImpre;
     #15#3;
     ;
     INICIO;
     FINAL;
     ;
     NULL, TmpImpre;
|FIN;

|PROCESO Mail;
     |SI aCli ! "";
          |PIEINF;
          |FINIMP;
          |FININF;
          |SI aIP = "";
          |SINO;
               |RECIBE_FICHERO aFic, aDjunto;
               |RFBORRA aFic;
          |FINSI;

          |SI nDir = 1;
               #24#0 = aCli;
               |LEE 000#24=;
               aEmail = #24#214; |QBF aEmail;
               |SI aEmail = ""; aEmail = #24#197; |FINSI;
          |SINO;
               #30#0 = aCli;
               #30#1 = nDir;
               |LEE 000#30=;
               |SI FSalida ! 0; |DDEFECTO #30; |FINSI;
               aEmail = #30#24;
          |FINSI;
          |QBF aEmail;

          aIP = "";
          |SI #22#8 = "L";
               |IP_REMOTO aIP;
          |SINO;
               |SI #22#8 = "S";
                    |IP_LOCAL aIP;
               |SINO;
                    aIP = #22#7; |QBF aIP;
               |FINSI;
          |FINSI;
          aServidor = #22#14; |QBF aServidor;
          aFrom = #22#15; |QBF aFrom;
          aTo = aEmail;
          aSubject = "Fecha Aproximada Servicio";
          aMensaje = "Adjunto relación pedidos/albares";

          aMensaje = "Le adjundo PDF con la fecha aproximada de servicio de sus pedidos pendiente.";
          aMensaje = aMensaje + &13 + "Reciba un cordial saludo.";
          aMensaje = aMensaje + &13 + "Coimasa.";

          |SI aTo ! "";
               |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO TmpMail;
     |HAZ Albaranes;
     |SI aCli ! #15#5; |O nDir ! #15#6;
          |HAZ Mail;
          aIP = ""; |IP_REMOTO aIP;
          |SI aIP = "";
               |DFICE aAlfa;
               aDjunto = aAlfa + #15#5 + "_" + (("0000" + #15#6)%-104)+ ".pdf";
               |QBT aDjunto;
               Impresora = "CrystalReport;" + aDjunto;
          |SINO;
               |DFICE aAlfa;
               aDjunto = aAlfa + #15#5 + "_" + (("0000" + #15#6)%-104)+ ".pdf";
               |QBT aDjunto;
               |ESPECIFICA "RBASS", aBaseLocal;
               aFic = aBaseLocal1 + #15#5 + "_" + (("0000" + #15#6)%-104)+ ".pdf";
               |QBT aFic;
               Impresora = "CrystalReport;" + aFic;
          |FINSI;

          |IMPRE -1;
          |SI FSalida ! 0; |ERROR10; |ACABA; |FINSI;
          aAlfa = #0#17; |QBF aAlfa;
          |INFOR aAlfa;  ||coimzb22
          |SI FSalida ! 0; |FINIMP; |ERROR10; |ACABA; |FINSI;
     |FINSI;

     #73#28 = #15#0;
     #73#0 = #15#1;
     #73#1 = #15#2;
     |LEE 020#73=;

     #104#25 = #15#0;
     #104#0 = #15#1;
     |LEE 020#104=;

     #7#0 = #15#0;
     #7#1 = #15#1;
     #7#2 = #15#2;
     |LEE 000#7=;
     |SI FSalida ! 0; |DDEFECTO #7; |FINSI;

     enTipo = 1; |PRINT;

     aCli = #15#5;
     nDir = #15#6;
|FPRC;

|DEFBUCLE TmpMail;
     #15#3;
     ;
     INICIO;
     FINAL;
     ;
     NULL, TmpMail;
|FINI;

|PROCESO TmpActFecProx;
     #73#28 = #15#0;
     #73#0 = #15#1;
     #73#1 = #15#2;
     |LEE 020#73=;

     #104#25 = #15#0;
     #104#0 = #15#1;
     |LEE 020#104=;

     eaArticulo = #73#2;
     enAlmacen = #73#3;
     efFecha = #104#62;
     |SI #73#13 > efFecha; efFecha = #73#13; |FINSI;
     eaSerie = #73#28;
     enCodigo = #73#0;
     enLinea  = #73#1;
     enUnidades = #73#5;
     eaAct = #0#2;
     |SUB_EJECUTA_NP "coimz021;RECAL";
|FPRC;

|DEFBUCLE TmpActFecProx;
     #15#2;
     ;
     INICIO;
     FINAL;
     ;
     NULL, TmpActFecProx;
|FIN;

|PROCESO LinPedi;
     |SI #73#2 < #0#13; |O #73#2 > #0#14;
          |ACABA;
     |FINSI;

     #104#25 = #73#28;
     #104#0 = #73#0;
     |LEE 000#104=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |SI #104#4 < #0#11; |O #104#4 > #0#12; |ACABA; |FINSI;

     |SI aSerie ! #104#25; |O nPedido ! #104#0;
          aSerie = #104#25;
          nPedido = #104#0;
          aBloqueado = "N";
          |HAZ RieCliBloq;
     |FINSI;

     #6#0 = #73#28;
     #6#1 = #73#0;
     |LEE 000#6=;
     |SI FSalida ! 0; |DDEFECTO #6; |FINSI;

     nPdte = #73#5 - #73#43;
     |SI nPdte > 0;
          #15#0 = #73#28;
          #15#1 = #73#0;
          #15#2 = #73#1;
          #15#3 = #6#2;
          #15#4 = #104#62;
          #15#5 = #104#4;
          #15#6 = #104#57;
          |SI aBloqueado = "S";
               #15#3 = 9;
          |FINSI;
          |GRABA 020#15n;
     |FINSI;
|FPRC;

|DEFBUCLE LinPedi;
     #73#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, LinPedi;
|FIN;

|PROCESO HistoPro;
     |SI #3#15 = "N";
          |LEE 121#3=;
          #3#17 = 0;
          |GRABA 020#3a;
          |LIBERA #3;
     |FINSI;
|FPRC;

|DEFBUCLE HistoPro;
     #3#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, HistoPro;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #22; |LEE 000#22p; |CIERRA #22;

     |HAZ CreaTempo;
     |NOME_DAT #15 Tempo; |DELINDEX #15; aTmp15 = Tempo;

     |SI #0#15 = "S";
          |BUCLE HistoPro;
     |FINSI;

     |ABRE #104;
     |ABRE #15;
     |ABRE #6;
     |BUCLE LinPedi;
     |SI x = 1; |CONSULTA_CLAVE #1#15; |FINSI;
     |CIERRA #6;
     |CIERRA #15;
     |CIERRA #104;

     |SI #0#15 = "S";
          |ABRE #104;
          |ABRE #73;
          |BUCLE TmpActFecProx;
          |CIERRA #73;
          |CIERRA #104;
     |FINSI;

     |SI #0#1 = "S";
          aCli = ""; nDir = 0;
          |ABRE #104;
          |ABRE #73;
          |ABRE #7;
          Impresora = "CrystalReport";
          |IMPRE -1;
          |SI FSalida = 0;
               aAlfa = #0#16;
               |INFOR aAlfa;  ||coimza22
               |SI FSalida = 0;
                    |BUCLE TmpImpre;
                    #15#5 = "";
                    |HAZ Albaranes;
                    |PIEINF;
                    |FININF;
               |FINSI;
               |FINIMP;
          |FINSI;
          |CIERRA #7;
          |CIERRA #73;
          |CIERRA #104;
     |FINSI;

     |SI #0#2 = "S";
          aCli = ""; nDir = 0;
          |ABRE #104;
          |ABRE #73;
          |ABRE #7;
          |ABRE #24;
          |ABRE #30;
          |BUCLE TmpMail;
          #15#5 = "";
          |HAZ Albaranes;
          |HAZ Mail;
          |CIERRA #30;
          |CIERRA #24;
          |CIERRA #7;
          |CIERRA #73;
          |CIERRA #104;
     |FINSI;

     |CIERRA #15; Tempo = aTmp15; |HAZ BoraTempo; |DELINDEX #15;
|FPRC;

|PROCESO RecalFec; |TIPO 0;
     |SI #0#15 = "S";
          |C_M #0#11, 1, "N";
          |C_M #0#12, 1, "N";
          #0#11 = ""; |PINTA #0#11;
          #0#12 = "zzzzzz"; |PINTA #0#12;
     |SINO;
          |C_M #0#11, 1, "S";
          |C_M #0#12, 1, "S";
     |FINSI;
|FPRC;

|PROGRAMA;
     |ABRE #0;
     |LEE 101#0p;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;
     |SI PARAMETRO ! "";
          aFic = PARAMETRO;
          |XABRE "C", aFic, nHandle;
          |SI FSalida = 0;
               nCampo = 1;
               |XLEE nHandle, 250, aDato;
               |PARA; |SI FSalida ] 0; |HACIENDO;
                    |SI nCampo > 17; |SAL; |FINSI;
                    #0nCampo = aDato;
                    nCampo = nCampo + 1;
                    |XLEE nHandle, 250, aDato;
               |SIGUE;
               |XCIERRA nHandle;
               |HAZ Tipo3;
          |FINSI;
     |SINO;
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
          |SI FSalida = 0; |GRABA 020#0a; |FINSI;
     |FINSI;
     |CIERRA #0;
|FPRO;
