|FICHEROS;
     iber0139 #0;
     iber0137 #137;
     iber0138 #138;
     agifa501 #501;
     agifa502 #502;
     agifa024 #24;
|FIN;

|VARIABLES;
     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;
     &EURODB   = 0;
     aSerie    = "";
     aTipo     = "";
     fFecha    = @;
     nLinCab   = 0;
     nLinCon   = 0;
     nLin      = 0;
     nCam      = 0;
     nTotIva   = 0;
     nBase     = 0;
     nIva      = 0;
     nRec      = 0;
     nCanti    = 0;
     nCantiHasta = 0;
     nTotal    = 0;
     nSumTotal0 = 0;
     nSumTotal1 = 0;
     nSumTotal2 = 0;
     nSumTotal3 = 0;
     nSumTotal4 = 0;
     nSumTotal5 = 0;
|FIN;

|PROCESO MiraRepe;
     |SELECT #2#138;
     #138#0 = #137#0;
     #138#1 = #137#1;
     #138#2 = #137#2;
     #138#3 = #137#3;
     #138#5 = #502#2;
     |LEE 000#138];
     |PARA nLin = 0; |SI FSalida = 0; |Y nLin = 0; |Y #138#0 = #137#0;
               |Y #138#1 = #137#1; |Y #138#2 = #137#2;
               |Y #138#3 = #137#3; |Y #138#5 = #502#2; |HACIENDO;

          |SI #501#35 = "F";
               |SI #138#8 = #502#10; |Y #138#9 = #502#14; |Y #138#10 = #501#17;
                         |Y #138#11 = #501#18; |Y #138#12 = #501#19;
                         |Y #138#14 = #502#13;
                    nLin = #138#4;
               |FINSI;
          |SINO;
               |SI #138#8 = #502#6; |Y #138#9 = #502#14; |Y #138#10 = #501#17;
                         |Y #138#11 = #501#18; |Y #138#12 = #501#19;
                         |Y #138#14 = #502#13;
                    nLin = #138#4;
               |FINSI;
          |FINSI;

          |LEE 000#138s;
     |SIGUE;
     |SELECT #1#138;
|FPRC;

|PROCESO UltimaLinea;
     #138#0 = #137#0;
     #138#1 = #137#1;
     #138#2 = #137#2;
     #138#3 = #137#3;
     #138#4 = 99999;
     |LEE 000#138];
     |SI FSalida = 0;
          |LEE 000#138a;
     |SINO;
          |LEE 000#138u;
     |FINSI;
     |SI FSalida = 0; |Y #138#0 = #137#0; |Y #138#1 = #137#1;
               |Y #138#2 = #137#2; |Y #138#3 = #137#3;
          nLin = #138#4 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
|FPRC;

|PROCESO UltimoCon;
     |SELECT #2#137;
     #137#0 = #501#57;
     #137#2 = #501#35;
     #137#41 = 999999;
     |LEE 000#137];
     |SI FSalida = 0;
          |LEE 000#137a;
     |SINO;
          |LEE 000#137u;
     |FINSI;
     |SI FSalida = 0; |Y #137#0 = #501#57; |Y #137#2 = #501#35;
          nLinCon = #137#41 + 1;
     |SINO;
          nLinCon = 1;
     |FINSI;
     |SELECT #1#137;
|FPRC;

|PROCESO UltimaCab;
     #137#0 = #501#57;
     #137#1 = #501#14;
     #137#2 = #501#35;
     #137#3 = 999;
     |LEE 000#137];
     |SI FSalida = 0;
          |LEE 000#137a;
     |SINO;
          |LEE 000#137u;
     |FINSI;
     |SI FSalida = 0; |Y #137#0 = #501#57; |Y #137#1 = #501#14;
               |Y #137#2 = #501#35;
          nLinCab = #137#3 + 1;
     |SINO;
          nLinCab = 1;
     |FINSI;
|FPRC;

|PROCESO TotalFactura;
     #137#7 = #137#7 + nSumTotal0;

     #137#11 = #137#11 + nSumTotal1;
     #137#17 = #137#17 + nSumTotal2;
     #137#23 = #137#23 + nSumTotal3;
     #137#29 = #137#29 + nSumTotal4;
     #137#35 = #137#35 + nSumTotal5;

     |SI #24#47 = "S";
          #137#12 = (#137#11*#137#8)/100; #137#13 = (#137#11*#137#9)/100;
          #137#18 = (#137#17*#137#14)/100; #137#19 = (#137#17*#137#15)/100;
          #137#24 = (#137#23*#137#20)/100; #137#25 = (#137#23*#137#21)/100;
          #137#30 = (#137#29*#137#26)/100; #137#31 = (#137#29*#137#27)/100;
          #137#36 = (#137#35*#137#32)/100; #137#37 = (#137#35*#137#33)/100;
     |SINO;
          #137#12 = (#137#11*#137#8)/100;
          #137#18 = (#137#17*#137#14)/100;
          #137#24 = (#137#23*#137#20)/100;
          #137#30 = (#137#29*#137#26)/100;
          #137#36 = (#137#35*#137#32)/100;
     |FINSI;

     #137#10 = #137#11 + #137#12 + #137#13;
     #137#16 = #137#17 + #137#18 + #137#19;
     #137#22 = #137#23 + #137#24 + #137#25;
     #137#28 = #137#29 + #137#30 + #137#31;
     #137#34 = #137#35 + #137#36 + #137#37;

     #137#6 = #137#7 + #137#10 + #137#16 + #137#22 + #137#28 + #137#34;
|FPRC;

|PROCESO TotalTiquet;
     #137#6 = #137#6+nSumTotal0+nSumTotal1+nSumTotal2+nSumTotal3+nSumTotal4+nSumTotal5;
     #137#7 = #137#7 + nSumTotal0;

     #137#10 = #137#10 + nSumTotal1;
     #137#16 = #137#16 + nSumTotal2;
     #137#22 = #137#22 + nSumTotal3;
     #137#28 = #137#28 + nSumTotal4;
     #137#34 = #137#34 + nSumTotal5;

     |SI #24#47 = "S";
          #137#11 = (#137#10 / (1+(#137#8+#137#9)/100)) ! EURODB;
          #137#17 = (#137#16 / (1+(#137#14+#137#15)/100)) ! EURODB;
          #137#23 = (#137#22 / (1+(#137#20+#137#21)/100)) ! EURODB;
          #137#29 = (#137#28 / (1+(#137#26+#137#27)/100)) ! EURODB;
          #137#35 = (#137#34 / (1+(#137#32+#137#33)/100)) ! EURODB;
          nTotIva = #137#10 - #137#11;
          nIva = ((#137#11 * #137#8) / 100) ! EURODB;
          nRec = nTotIva - nIva;
          #137#12 = nIva; #137#13 = nRec;

          nTotIva = #137#16 - #137#17;
          nIva = ((#137#17 * #137#14) / 100) ! EURODB;
          nRec = nTotIva - nIva;
          #137#18 = nIva; #137#19 = nRec;

          nTotIva = #137#22 - #137#23;
          nIva = ((#137#23 * #137#20) / 100) ! EURODB;
          nRec = nTotIva - nIva;
          #137#24 = nIva; #137#25 = nRec;

          nTotIva = #137#28 - #137#29;
          nIva = ((#137#29 * #137#26) / 100) ! EURODB;
          nRec = nTotIva - nIva;
          #137#30 = nIva; #137#31 = nRec;

          nTotIva = #137#34 - #137#35;
          nIva = ((#137#35 * #137#32) / 100) ! EURODB;
          nRec = nTotIva - nIva;
          #137#36 = nIva; #137#37 = nRec;
     |SINO;
          #137#11 = (#137#10 / (1+(#137#8)/100)) ! EURODB;
          #137#17 = (#137#16 / (1+(#137#14)/100)) ! EURODB;
          #137#23 = (#137#22 / (1+(#137#20)/100)) ! EURODB;
          #137#29 = (#137#28 / (1+(#137#26)/100)) ! EURODB;
          #137#35 = (#137#34 / (1+(#137#32)/100)) ! EURODB;

          #137#12 = #137#10 - #137#11;
          #137#18 = #137#16 - #137#17;
          #137#24 = #137#22 - #137#23;
          #137#30 = #137#28 - #137#29;
          #137#36 = #137#34 - #137#35;
     |FINSI;
|FPRC;

|PROCESO agifa502;
     |HAZ MiraRepe;
     |SI nLin = 0;
          |HAZ UltimaLinea;
     |FINSI;

     enTiva = #502#13;
     efFiva = #501#14;
     |HAZ SacaIVA;

     |DDEFECTO #138;
     #138#0 = #137#0;
     #138#1 = #137#1;
     #138#2 = #137#2;
     #138#3 = #137#3;
     #138#4 = nLin;
     |LEE 101#138=;
     |SI FSalida ! 0; |GRABA 020#138b; |FINSI;

     #138#5 = #502#2;
     #138#6 = #502#8;
     #138#7 = #138#7 + #502#5;
     #138#9 = #502#14;
     #138#10 = #501#17;
     #138#11 = #501#18;
     #138#12 = #501#19;
     #138#14 = enTiva;
     #138#15 = enIva;
     #138#16 = enRec;
     |SI #501#35 = "F";
          nTotal = (((#502#21 < #138#9) < #138#10) < #138#11) < #138#12;
          nTotal = nTotal ! EURODB;
          #138#8 = #502#10;
          #138#13 = #138#13 + nTotal;
     |SINO;
          nTotal = (((#502#7 < #138#9) < #138#10) < #138#11) < #138#12;
          nTotal = nTotal ! EURODB;
          #138#8 = #502#6;
          #138#13 = #138#13 + nTotal;
     |FINSI;
     |GRABA 020#138a;
     |LIBERA #138;

     |SI #138#14 > 5; #138#14 = 5; |FINSI;
     |SI #138#14 < 0; #138#14 = 0; |FINSI;
     |SI #138#14 > 0;
          nCam = ((#138#14 - 1) * 6) + 8;
          #137nCam = #138#15; ||%IVA
          nCam = nCam + 1;
          #137nCam = #138#16; ||%REC
     |FINSI;

     |SI #138#14 = 0; nSumTotal0 = (nSumTotal0 + nTotal) ! EURODB; |FINSI;
     |SI #138#14 = 1; nSumTotal1 = (nSumTotal1 + nTotal) ! EURODB; |FINSI;
     |SI #138#14 = 2; nSumTotal2 = (nSumTotal2 + nTotal) ! EURODB; |FINSI;
     |SI #138#14 = 3; nSumTotal3 = (nSumTotal3 + nTotal) ! EURODB; |FINSI;
     |SI #138#14 = 4; nSumTotal4 = (nSumTotal4 + nTotal) ! EURODB; |FINSI;
     |SI #138#14 = 5; nSumTotal5 = (nSumTotal5 + nTotal) ! EURODB; |FINSI;
|FPRC;

|DEFBUCLE agifa502;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, agifa502;
|FIN;

|PROCESO agifa501;
     |SI #501#35 ! "F"; |Y #501#35 ! "T";
          |ERROR; |ACABA;
     |FINSI;

     nSumTotal0 = 0;
     nSumTotal1 = 0;
     nSumTotal2 = 0;
     nSumTotal3 = 0;
     nSumTotal4 = 0;
     nSumTotal5 = 0;
     nCantiHasta = #0#5 - #501#9;

     |SI aSerie ! #501#57; |O fFecha ! #501#14; |O aTipo ! #501#35;
               |O nCanti > nCantiHasta;
          aSerie = #501#57;
          fFecha = #501#14;
          aTipo = #501#35;
          nCanti = 0;
          |HAZ UltimaCab;
          |HAZ UltimoCon
          |DDEFECTO #137;
          #137#0 = #501#57;
          #137#1 = #501#14;
          #137#2 = #501#35;
          #137#3 = nLinCab;
          #137#4 = #501#58;   ||D.Numero Doc
          #137#39 = (A\(#137#0 % 103));
          #137#41 = nLinCon;
          |GRABA 020#137b;
     |FINSI;

     #24#0 = #501#1;
     |LEE 000#24=;
     |SI FSalida ! 0; |DDEFECTO #24; |FINSI;

     |BUCLE agifa502;
     |HAZ FinCab;
|FPRC;

|PROCESO FinCab;
     |SI #501#35 = "F";
          |HAZ TotalFactura;
     |SINO;
          |HAZ TotalTiquet;
     |FINSI;
     #137#5 = #501#58;
     |GRABA 020#137a;
     |LIBERA #137;
|FPRC;

|DEFBUCLE agifa501;
     #501#2;
     14, 31;
     " ", #0#1, 00001, #0#3, "B";
     "z", #0#2, 99999, #0#4, "Z";
     ;
     NULL, agifa501;
|FIN;

|PROCESO BorraCab;
     |BORRA 020#137a;
|FPRC;

|PROCESO BorraLin;
     |BORRA 020#138a;
|FPRC;

|DEFBUCLE Borra;
     #137#1;
     ;
     #0#1, #0#3, " ", 001;
     #0#2, #0#4, "z", 999;
     be;
     NULL, BorraCab, BorraLin;
|FIN;

|PROCESO Tipo3;
     |BUCLE Borra;
     |ABRE #137;
     |ABRE #138;
     |ABRE #24;
     |BUCLE agifa501;
     |CIERRA #24;
     |CIERRA #137;
     |CIERRA #138;
|FPRC;

|PROGRAMA;
     |HAZ DecimalesBase;
     |CLS;
     |ABRE #0;
     |LEE 101#0p;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #2#0;
     |SI FSalida = 0;
          |SI #0#6 = "2";
               |HAZ Tipo3;
          |SINO;
               |BUCLE Borra;
               |HAZ Nuevo;
          |FINSI;
          |GRABA 020#0a;
     |FINSI;
     |CIERRA #0;
|FPRO;
