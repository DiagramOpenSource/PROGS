|FICHEROS;
     web10006 #0;

     web10005 #5;   ||Parametros Correo
     web10007 #7;   ||Registro Correo (CAB)
     web10008 #8;   ||Registro Correo (LIN)
     agifa024 #24;  ||Fichero de Clientes;
     agifa019 #19;  ||Fichero de Articulos;
     agifa025 #25;   ||Fichero de Representantes;
     web10014 #14;  || Historico
|FIN;

|VARIABLES;
     aLon = "";
     nPos = 0;
     nLinHis = 0;
     aBase = "";
     aIP = "";
     aServidor = "";
     aFrom = "";
     aTo = "";
     aAdjunto = "";
     nSwCorructo = 0;
     aDirEco = "";
     aAsunto = "";
     aADjunto = "";
     &enAlmacen = 0;
     &fed_dt = @;
     &art_dt = "";
     &cli_dt = "";
     &fam_dt = "";
     &iva_dt = 0;  || Tipo Iva.
     &dtos_2 = 0;      || Descuento 2.
     &dto_pt = 0;      || Descuento Ptas.
     &dtos_1 = 0;      || Descuento 1.
     &pvp_ve = 0;      || Precio Venta.
     &tarifa = 0;  || Tarifa Cliente....
     &gru_dt = ""; || Grupo Cliente.
     &nPromo = 0;
     &uni_dt = 0;
     &enMensaje = 0;
     &aParam = "";
     &eaSerie = "";
     &enDirEnt = 0;

     &eaCli    = "";
     &enTiva   = 0;
     &enIva    = 0;
     &enRec    = 0;
     ||컴컴컴컴컴컴컴컴컴컴

     aMensaje = "";
     nError = 0;
     nCorreos = 0;
     nSalida = 0;
     aPath = "";
     aHora = "";
     fFecha = @;
     aNombre = "";
     aAlfa1 = "";
     aAlfa = "";
     aResposta = "";

     aDir      = "";
     aDSCorreo = "";
     aUsu      = "";
     aPwd      = "";
     aProxyEnt = "";
     aFic = "";

     nHandle = 0;
     aCli = "";
     aNomCli = "";
     aEmpresa = "";
     aDirCorreo = "";
     aPoblacion = "";
     aCP = "";
     aEmail = "";
     aTelefono = "";
     aFax = "";
     aFechaCorreo = "";
     aHoraCorreo = "";
     nConta = 0;
     aNumReg = "";
     nNumReg = 0;


     ||ADRIAN
     aCODREPRE = "";
     aCODEMPRE = "";
     aCODCOMER = "";
     aNUMPEDIDOS = "";
     nNUMPEDIDOS = 0;
     aNUMPED = "";
     nNUMPED = 0;
     aCODCLI = "";
     aFECHA = "";
     fFECHA = @;
     aHORA = "";
     aOBSER = "";
     aLINPED = "";
     nLINPED = 0;
     aCODART = "";
     aCANT = "";
     nCANT = 0;
     aPRECIO = "";
     nPRECIO = 0;
     aDTO = "";
     nDTO = 0;
     i = 0;
     j = 0;
     k = 0;
     aLongi = "";
     nLongi = 0;
     aCadena = "";
     nCont = 0;
     aPos = "";
     aCaracter = "";
     aLinea = "";
     nDescuento = 0;
     aDia = "";
     aMes = "";
     aAnyo = "";
     aCar = "";
     aCar2 = "";
     aNomRepre = "";
     aCodPostal = "";
     aLongCP = "";
     aCodE1 = "";
     aCodE2 = "";
     aFechaAct = "";
     fFechaAct = @;
     aAnyoAct = "";
     aRuta = "";
     aDire = "";
     aCodAgencia = "";
     nCodAgencia = 0;
     nSwCorrupto = 0;
|FIN;

|PROGRAMA;
     |HAZ DecimalesBase;

     |SI PARAMETRO ! "";
          |HAZ Principal;
     |SINO;
          |CLS;
          |DDEFECTO #0;
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
          |SI FSalida = 0;|Y #0#0 = "SI";
               |HAZ Principal;
          |FINSI;
     |FINSI;
|FPRO;

|PROCESO Principal;
     |ABRE #web10005;
     |LEE 000#web10005.p;
     |SI FSalida ! 0;
          aMensaje = "0000Error: Parametro Correo no definidos.";
          |MENAV aMensaje;
          |CIERRA #web10005;
          |ACABA;
     |FINSI;
     |CIERRA #web10005;

     nCorreos = 0;
     |PARA; |SI; |HACIENDO;
          nError = 0;
          nSalida = 0;
          nCorreos = nCorreos + 1;
          |HAZ Recoge;
          |SI nError ! 0;     |VETE Fuera;   |FINSI;

          |MENSA "2403Cargando...";
          aPath = #5#14;
          |QBF aPath;
          aPath = aPath + "/";
          |BLIN 24;

          |SI nSalida = 0;
               fFecha = ~;
               |HORA aHora;
               aHora = aHora % 108;

               |HAZ Historico;

               nSwCorrupto = 0; aCODREPRE = "";
               |HAZ ProcesarCorreo;
               |HAZ EnviaEco;
               |SLEEP 2;
          |FINSI;
     |SIGUE;

     |ET Fuera;
|FPRC;

|PROCESO Historico;
     aFic = "";
     aLon = aNombre % A0;
     nPos = -101;
     |PARA i = aLon; |SI i > 0; |HACIENDO i = i - 1;
          aAlfa = aNombre % nPos;
          |SI aAlfa = "/"; |O aAlfa = "\"; |SAL; |FINSI;
          aFic = aAlfa + aFic;
          nPos = nPos -100;
     |SIGUE;

     |ABRE #14;
     |LEE 000#14u;
     |SI FSalida = 0;
          nLinHis = #14#0 + 1;
     |SINO;
          nLinHis = 1;
     |FINSI;
     |DDEFECTO #14;
     #14#0 = nLinHis;
     #14#1 = aFic;
     #14#2 = fFecha;
     #14#3 = aHora;
     #14#4 = Usuario % 810;
     |GRABA 020#14n;
     |DBASE aBase;
     aAlfa = aBase + "000323"; |MKDIR aAlfa;
     aAlfa = aBase + "000323/adjuntos"; |MKDIR aAlfa;
     aAlfa  = aBase + "000323/adjuntos/" + aFic;
     |COPIA_FICHERO aNombre, aAlfa;
|FPRC;

____________________________________/ RECOGIDA DE CORREOS
|PROCESO Recoge;
     aDir = #5#14;       |QBF aDir;          || directorio destino
     |MKDIR aDir;   ||He de asegurarme que exista el directorio destino

     |SI #5#20 = "F";
          aDSCorreo = #5#19;  |QBF aDSCorreo;
     |SINO;
          |SI #5#20 = "L";   |IP_REMOTO aDSCorreo;    |FINSI;
          |SI #5#20 = "S";   |IP_LOCAL aDSCorreo;     |FINSI;
     |FINSI;
     aUsu = #5#12;       |QBF aUsu;          || usuario
     aPwd = #5#13;       |QBF aPwd;          || password
     aProxyEnt = #5#11;  |QBF aProxyEnt;     || servidor proxy entrante
     aNombre = "";

     aAlfa1 = "0000Recibiendo [" + aDSCorreo + "]";
     |MENSA aAlfa1;
     |DSCORREO_RECIBE aDSCorreo, aProxyEnt, aUsu, aPwd, aDir, aNombre;

     nError = FSalida;

     |PARA aAlfa = aNombre; |SI; |HACIENDO;
          aNombre = aNombre - ";";
          |SI aNombre = aAlfa; |SAL; |FINSI;
          aAlfa = aNombre;
     |SIGUE;

     |BLIN 4;
     |SI nError < 0;
          aMensaje = "    Problemas al recibir correo ..." + nError;
          |MENAV aMensaje;
     |FINSI;
     |SI nError = 0;
          aMensaje = "    Correo recibido con exito [" + nError + "][" + aNombre + "]";
          |MENSA aMensaje;
     |FINSI;
     |SI nError = 1;
          |SI nCorreos = 1;
               |MENAV "    No hay correo ...";
          |SINO;
               nCorreos = nCorreos - 1;
               aAlfa = "0000" + nCorreos + " Correos recibidos...";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

||AQUI
|PROCESO ProcesarCorreo;
     aFic = aNombre;
     |XABRE "U", aFic, nHandle;
     |SI FSalida ! 0;
          aMensaje = "0000Problemas procesando correo: " + aFic;
          |MENAV aMensaje;
     |SINO;

          |XLEE nHandle, 250, aAlfa;
          |QBF aAlfa;
          |SI FSalida < 0;
               |HAZ Corrupto; |ACABA;
          |SINO;
               |SI aAlfa = "";   || SI en el fichero se incluye una linea en blanco
                    |XLEE nHandle, 250, aAlfa;
                    |SI FSalida < 0;    |HAZ Corrupto; |ACABA;   |FINSI;
               |FINSI;
          |FINSI;

          aCODEMPRE = aAlfa % 102;
          aCODREPRE = aAlfa % -102;

          aCodE1 = aCODEMPRE % 201;
          aCodE2 = aCODEMPRE % 101;
          fFechaAct = ~;
          aFechaAct = fFechaAct;
          aAnyoAct = aFechaAct % -103;
          aRuta = aCodE1 + aCodE2 + aAnyoAct;

          |DFICB aDire;
          aDire = aDire + aRuta +"/";

          |PATH_DAT #7 aDire;
          |PATH_DAT #8 aDire;

          |ABRE #web10007;
          |ABRE #web10008;

          |XLEE nHandle, 250, aAlfa;
          |QBF aAlfa;
          |SI FSalida < 0;    |HAZ Corrupto; |ACABA;   |FINSI;
          aNUMPEDIDOS = aAlfa;
          nNUMPEDIDOS = aNUMPEDIDOS;

          |PARA i = 1; |SI i [ nNUMPEDIDOS ; |HACIENDO i = i + 1;

               |XLEE nHandle, 250, aAlfa;
               |QBF aAlfa;
               |SI FSalida < 0;    |HAZ Corrupto; |ACABA;   |FINSI;
               aNUMPED = aAlfa;

               |XLEE nHandle, 250, aAlfa;
               |QBF aAlfa;
               |SI FSalida < 0;    |HAZ Corrupto; |ACABA;   |FINSI;
               aCODCLI = aAlfa;

               |XLEE nHandle, 250, aAlfa;
               |QBF aAlfa;
               |SI FSalida < 0;    |HAZ Corrupto; |ACABA;   |FINSI;
               |HAZ PasaAfecha;

               |XLEE nHandle, 250, aAlfa;
               |QBF aAlfa;
               |SI FSalida < 0;    |HAZ Corrupto; |ACABA;   |FINSI;
               aHORA = aAlfa;
    ||----------------------------------------------------------------------
               |XLEE nHandle, 250, aAlfa;
               |QBF aAlfa;
               |SI FSalida < 0;    |HAZ Corrupto; |ACABA;   |FINSI;
               aCodAgencia = aAlfa;
               nCodAgencia = aCodAgencia;
               |XLEE nHandle, 250, aAlfa;
               |QBF aAlfa;
               |SI FSalida < 0;    |HAZ Corrupto; |ACABA;   |FINSI;
               aOBSER = aAlfa;

               |XLEE nHandle, 250, aAlfa;
               |QBF aAlfa;
               |SI FSalida < 0;    |HAZ Corrupto; |ACABA;   |FINSI;
               aLINPED = aAlfa;
               nLINPED = aLINPED;

               |ABRE #25;
               #agifa025#0 = aCODREPRE;
               |LEE 000#25=;
               |SI FSalida = 0;
                    aNomRepre = #25#1;
               |FINSI;

               |ABRE #24;
               #agifa024#0 = aCODCLI;
               |LEE 000#24=;
               |SI FSalida = 0;

                    |DDEFECTO #web10007;
                    #web10007#0 = aCODCLI;
                    #web10007#1 = fFECHA;
                    #web10007#2 = aHORA;
                    #web10007#21 = aNUMPED;
                    |LEE 101#web10007.=;
                    |SI FSalida ! 0; |GRABA 020#web10007.b; |FINSI;
                    #web10007#17 = aOBSER;
                    #web10007#19 = aCODCOMER;
                    #web10007#18 = aCODEMPRE;
                    #web10007#20 = aNomRepre;
                    #web10007#19 = aCODREPRE;

                    #web10007#3 = #agifa024#2;
                    ||#web10007#4 = #agifa024#2;
                    #web10007#5 = #agifa024#5;
                    #web10007#6 = #agifa024#6;
                    #web10007#7 = #agifa024#7;
                    aCodPostal = #agifa024#178+#agifa024#179;
                    aLongCP = aCodPostal % 0;
                    |SI aLongCP = 4;
                         aCodPostal = "0" + aCodPostal;
                    |FINSI;
                    #web10007#8 = aCodPostal;

                    #web10007#9 = #agifa024#197;
                    #web10007#10 = #agifa024#17;
                    #web10007#11 = #agifa024#18;
                    fFecha = ~;
                    |HORA aHora;
                    aHora = aHora % 108;
                    #web10007#12 = fFecha;
                    #web10007#13 = aHora;
            ||---------------------------------
                    #web10007#24 = nCodAgencia;
                    |GRABA 020#web10007.a;
                    |LIBERA #web10007;

               |SINO;
                    aAlfa1 = "0000Cliente [" + aCODCLI + "] desconocido.";
                    |MENAV aAlfa1;
               |FINSI;
               |CIERRA #24;

               |PARA j = 1; |SI j [ nLINPED ; |HACIENDO j = j + 1;

                    |XLEE nHandle, 250, aAlfa;
                    |QBF aAlfa;
                    |SI FSalida < 0;    |HAZ Corrupto; |ACABA;   |FINSI;
                    |HAZ SacaCampos;


                    |ABRE #19;
                    aCODART = aCODART + "                    ";
                    aCODART = aCODART % 0120;
                    #agifa019#0=aCODART;
                    |LEE 000#19=;
                    |SI FSalida = 0;
                         |DDEFECTO #web10008;
                         #web10008#0 = aCODCLI;
                         #web10008#1 = fFECHA;
                         #web10008#2 = aHORA;
                         #web10008#15 = #web10007#21;
                         #web10008#3 = j;
                         |LEE 101#web10008.=;
                         |SI FSalida ! 0; |GRABA 020#web10008.b; |FINSI;


                         #web10008#0 = aCODCLI;
                         #web10008#1 = fFECHA;
                         #web10008#2 = aHORA;
                         #web10008#2 = aHORA;
                         #web10008#4 = aCODART;
                         nCANT = aCANT;
                         #web10008#7 = nCANT;
                         nPRECIO = aPRECIO;
                         #web10008#8 = nPRECIO;
                         nDTO = aDTO;
                         #web10008#10 = nDTO;
                         #web10008#5 = #agifa019#1;
                         #web10008#9 = nPRECIO * nCANT;
                         nDescuento = #web10008#9 * nDTO;
                         nDescuento = nDescuento / 100;
                         #web10008#9 = #web10008#9 - nDescuento;

                         |HAZ Precio;
                         |GRABA 020#web10008.a;
                         |LIBERA #web10008;
                    |SINO;
                         aAlfa1 = "0000Articulo [" + aCODART + "] desconocido.";
                         |MENAV aAlfa1;
                    |FINSI;
                    |CIERRA #19;
               |SIGUE;
          |SIGUE;


          |XCIERRA nHandle;
          |CIERRA #web10007;
          |CIERRA #web10008;
          |FBORRA aFic;
     |FINSI;
|FPRC;

|PROCESO PasaAfecha;

               aAnyo = aAlfa % -104;
               aCar = aAlfa % 201;
               |SI aCar = "/";
                    aCar2 = aAlfa % 101;
                    aDia = "0" + aCar2;
               |SINO;
                    aDia = aAlfa % 102;
               |FINSI;
               aCar = aAlfa % -701;
               |SI aCar = "/";
                    aCar2 = aAlfa % -601;
                    aMes = "0" + aCar2;
               |SINO;
                    aMes = aAlfa % -602;
               |FINSI;
               aFECHA = aDia + "." + aMes + "." + aAnyo;

               fFECHA = aFECHA;

|FPRC;


|PROCESO SacaCampos;
     ||en aAlfa guardamos la linea que hemos cogido de importacion.txt
     aLinea = aAlfa;
     aLongi = aLinea % 0;
     nLongi = aLongi;

     aCadena = "";

     nCont = 1;

     ||hacemos un for que vaya cogiendo todos los caracteres del fichoer menos los 3 primeros (codProv + "#")
     |PARA k = 1; |SI k [ nLongi; |HACIENDO k = k + 1;
          aPos = k + "01";
          aCaracter = aLinea % aPos;
          |SI aCaracter ! ";";
               aCadena = aCadena + aCaracter;
          |SINO;
               |SI nCont = 1;
                    aCODART = aCadena;
                    aCadena = "";
               |FINSI;
               |SI nCont = 2;
                    aCANT = aCadena;
                    aCadena = "";
               |FINSI;
               |SI nCont = 3;
                    aPRECIO = aCadena;
                    aCadena = "";
               |FINSI;
               |SI nCont = 4;
                    aDTO = aCadena;
                    aCadena = "";
               |FINSI;
               nCont = nCont + 1;
          |FINSI;
     |SIGUE;
     |QBF aCadena;       ||esto es para el descuento por si no tiene ';' al final de la linea
     aDTO = aCadena;
     aCadena = "";

|FPRC;


|PROCESO Corrupto;
     nSwCorructo = 1;
     |MENAV "0000Correo no reconocido o deteriorado.";

     |XCIERRA nHandle;
     |CIERRA #web10007;
     |CIERRA #web10008;
     |FBORRA aFic;
|FPRC;

|PROCESO Precio;
     fed_dt = fFecha;
     art_dt = #19#0;   || Articulo.
     cli_dt = #24#0;   || Cliente..
     fam_dt = #19#2;  || Familia.
     iva_dt = #19#30;  || Tipo Iva.
     dtos_2 = 0;      || Descuento 2.
     dto_pt = 0;      || Descuento Ptas.
     dtos_1 = 0;      || Descuento 1.
     pvp_ve = 0;      || Precio Venta.
     tarifa = #24#39;  || Tarifa Cliente....
     gru_dt = #24#158; || Grupo Cliente.
     nPromo = 0;
     uni_dt = 0;

     enMensaje = 0;
     aParam = "";
     eaSerie = "";
     enDirEnt = 1;
     enAlmacen = #web10008#14;
     |HAZ calcdtos;              || Calculo Dtos.....

     #web10008#11 = pvp_ve - dto_pt;
     #web10008#12 = dtos_1;
|FPRC;

|PROCESO EnviaEco;

     |SI #5#23 = "N"; |ACABA; |FINSI;

     aDirEco = #25#62; |QBF aDirEco;
     |SI aCODREPRE = ""; |O aDirEco = ""; |ACABA; |FINSI;

     |SI #5#20 = "F";
          aDSCorreo = #5#19;  |QBF aDSCorreo;
     |SINO;
          |SI #5#20 = "L";   |IP_REMOTO aDSCorreo;    |FINSI;
          |SI #5#20 = "S";   |IP_LOCAL aDSCorreo;     |FINSI;
     |FINSI;

     |SI nSwCorrupto = 0;
          aAsunto = "Recibido en central: " + fFecha + " " + aHora;
     |SINO;
          aAsunto = "Error al procesar: " + fFecha + " " + aHora;
     |FINSI;

     aIP = aDSCorreo;
     aServidor = #5#21; |QBF aServidor;
     aFrom = #5#22; |QBF aFrom;
     aTo = aDirEco;
     aAdjunto = "vacio.txt";
     aMensaje = aAsunto;
     |SI aIP = ""; |O aServidor = ""; |O aFrom = ""; |O aTo = "";
          |SI PARAMETRO = "";
               |MENAV "0000Falta configuracion parametros envio...";
          |FINSI;
     |SINO;
          |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aAsunto, aMensaje, aAdjunto;
     |FINSI;
|FPRC;
