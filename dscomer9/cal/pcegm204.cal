          TotalLin004, CalCabpcegm004

|FICHEROS;
     pcegm004 #0;
     agifa019 #19;
     pcegm005 #3;
|FIN;

|VARIABLES;
     &eaCli        = "";
     &enTiva       = 0;
     &enIva        = 0;
     &enRec        = 0;
     &efFiva = @;
     nNume11   = 0;
     nNume7    = 0;
     &nDeci_DivP = 0;
     &nDeci_BaseMxP = 0;
     nImpIva = 0;
     nImpo     = 0;
     nImpDiv   = 0;
     nMult     = 0;
     nImporDescue1 = 0;
     nImporDescue2 = 0;
     nImporDescue3 = 0;
     nImporMoneda1 = 0;
     nImporMoneda2 = 0;
     nBrutoMoneda1 = 0;
     nBrutoMoneda2 = 0;
     aAlfa = "";
     nPreTon = 0;
|FIN;


|CALCULO xLineasPedido4;
     #3#16 = #0#7;
     #3#20 = #0#4;
     #3#23 = #0#5;
     #3#24 = #0#6;
     #3#25 = #0#17;
     #3#26 = #0#9;

     |HAZ TotalLin004;

     #0#11 = #0#11 + #3#9;
     #0#42 = #0#42 + #3#39;

     |SI #19#194 = 2;
          nImpo = ((#3#49 *#3#6)<#3#8)<#3#29;
          nImpDiv = ((#3#49*#3#38)<#3#8)<#3#29;
     |SINO;
          nImpo = ((#3#43 *#3#6)<#3#8)<#3#29;
          nImpDiv = ((#3#43*#3#38)<#3#8)<#3#29;
     |FINSI;
/*
     nImpo = (nImpo < #0#5) ! nDeci_BaseMxP;
     nImpo = (nImpo < #0#17) ! nDeci_BaseMxP;
     nImpo = (nImpo < #0#6) ! nDeci_BaseMxP;

     nImpDiv = (nImpDiv < #0#5) ! nDeci_DivP;
     nImpDiv = (nImpDiv < #0#17) ! nDeci_DivP;
     nImpDiv = (nImpDiv < #0#6) ! nDeci_DivP;
*/
     nBrutoMoneda1 = nImpo;
     nImporDescue1 = (nBrutoMoneda1 % #0#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #0#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #0#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     nImpo = nBrutoMoneda1;

     nBrutoMoneda2 = nImpDiv;
     nImporDescue1 = (nBrutoMoneda2 % #0#5) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #0#17) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #0#6) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     nImpDiv = nBrutoMoneda2;

     #0#13 = #0#13 + nImpo;
     #0#44 = #0#44 + nImpDiv;

     #0#12 = #0#11 - #0#13;
     #0#43 = #0#42 - #0#44;

     ||---------Calculo iva
     eaCli = #0#4;
     enTiva = #3#14;
     efFiva = #0#1;
     |HAZ IVACli;

     nImpIva = #3#9 % enIva;
     |SI #0#22 = "S"; nImpIva = nImpIva + (#3#9 % enRec); |FINSI;
     #0#90 = #0#90 + nImpIva;

     nImpIva = #3#39 % enIva;
     |SI #0#22 = "S"; nImpIva = nImpIva + (#3#39 % enRec); |FINSI;
     #0#91 = #0#91 + nImpIva;
     ||---------

     |HAZ CamposVis;

     #0#63 = #0#63 + #3#54;
     |GRABA 020#3a;
     |LIBERA #3;
|FCAL;

|PROCESO CamposVis;
     |SI #0#37 = "D";
          #0#45 = #0#42;
          #0#46 = #0#43;
          #0#47 = #0#44;
          #0#48 = #0#11;
          #0#49 = #0#12;
          #0#50 = #0#13;
     |SINO;
          #0#45 = #0#11;
          #0#46 = #0#12;
          #0#47 = #0#13;
          #0#48 = #0#42;
          #0#49 = #0#43;
          #0#50 = #0#44;
     |FINSI;
|FPRC;

|DEFBUCLE xLineasPedido4;
     #3#1;
     ;
     #0#25, #0#0, 001;
     #0#25, #0#0, 999;
     be;
     NULL, xLineasPedido4;
|FIN;

|PROCESO CalCabpcegm004;
     |ABRE #19;
     #0#11 = 0;
     #0#12 = 0;
     #0#13 = 0;
     #0#42 = 0;
     #0#43 = 0;
     #0#44 = 0;
     #0#63 = 0;
     #0#90 = 0;
     #0#91 = 0;

     |BUCLE xLineasPedido4;

     ||---------A¤adir Portes
     eaCli = #0#4;
     enTiva = #0#82;
     efFiva = #0#1;
     |HAZ IVACli;

     |SI #0#37 = "D";
          #0#67 = #0#98 / #0#36 * #0#41;
          #0#68 = #0#99 / #0#36 * #0#41;
          #0#97 = #0#100 / #0#36 * #0#41;
     |SINO;
          #0#98 = #0#67 * #0#36 / #0#41;
          #0#99 = #0#68 * #0#36 / #0#41;
          #0#100 = #0#97 * #0#36 / #0#41;
     |FINSI;

     #0#11 = #0#11 + (#0#67 + (#0#67 % enIva));
     |SI #0#22 = "S"; #0#11 = #0#11 + ( (#0#67 % enRec)); |FINSI;

     #0#42 = #0#42 + (#0#98 + (#0#98 % enIva));
     |SI #0#22 = "S"; #0#42 = #0#42 + ( (#0#98 % enRec)); |FINSI;
     ||---------A¤adir IVA
     #0#11 = #0#11 + #0#90;
     #0#42 = #0#42 + #0#91;
     ||-----------
     |HAZ CamposVis;

     |HAZ RecalTipoPed;

     |GRABA 021#0a;
     |LIBERA #0;
     |CIERRA #19;
|FPRC;

|PROCESO TotalLin004;
     |DDEFECTO #19;
     |ABRE #19;
     #19#0 = #3#2;
     |LEE 000#19=;
     |CIERRA #19;

     nPreTon = 1;

     #3#54 = #19#208 * #3#5; ||Punto Verde

     |SI #0#37 = "D";                    || Si la moneda de trabajo es la divisa ...
          #3#6  = #3#38 / #0#36 * #0#41;  || ... recalculo precio en funcion de la divisa
          #3#40 = #3#6;                  || ... el campo visualiz. es el precio en moneda base
     |SINO;
          #3#38 = #3#6 / #0#41 * #0#36;  || .. recalculo precio en funcion de la moneda base
          #3#40 = #3#38;                 || ... el campo visual. es el precio en divisa
     |FINSI;

     |SI #19#194 = 2;                     || Unidades de facturacion
          nImpo = #3#44 * #3#6;
     |SINO;
          nImpo = #3#5 * #3#6;
     |FINSI;

     || nMult corrige el error del redondeo para negativos
     |SI nImpo < 0; nMult = -1; |SINO; nMult = 1; |FINSI;

     |SI #19#194 = 2;                     || Unidades de facturacion
          nNume7  = ((#3#44 * #3#6 / nPreTon) ! nDeci_BaseMxP)  * nMult;
          nImpDiv = ((#3#44 * #3#38 / nPreTon) ! nDeci_DivP) * nMult;
          nNume11 = (#3#44 - #3#49) * #3#6 * nMult / nPreTon;
     |SINO;
          nNume7  = ((#3#5 * #3#6 / nPreTon) ! nDeci_BaseMxP) * nMult;
          nImpDiv = ((#3#5 * #3#38 / nPreTon) ! nDeci_DivP) * nMult;
          nNume11 = (#3#5 - #3#43) * #3#6 * nMult / nPreTon;
     |FINSI;
     nNume11 = nNume11 ! nDeci_DivP;
     #3#9 = (nNume7 < #3#8) < #3#29;
     #3#39 = (nImpDiv < #3#8) < #3#29;
/*
     #3#9 = #3#9 < #0#5;
     #3#9 = #3#9 < #0#17;
     #3#9 = #3#9 < #0#6;

     #3#39 = #3#39 < #0#5;
     #3#39 = #3#39 < #0#17;
     #3#39 = #3#39 < #0#6;
*/
     nBrutoMoneda1 = #3#9;
     nImporDescue1 = (nBrutoMoneda1 % #0#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #0#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #0#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     #3#9 = nBrutoMoneda1;

     nBrutoMoneda2 = #3#39;
     nImporDescue1 = (nBrutoMoneda2 % #0#5) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #0#17) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #0#6) ! nDeci_DivP;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     #3#39 = nBrutoMoneda2;
/*
     nNume11 = ((nNume11 < #3#8) < #3#29) ! nDeci_DivP;
     nNume11 = (nNume11 < #0#5) ! nDeci_DivP;
     nNume11 = (nNume11 < #0#17) ! nDeci_DivP;
     nNume11 = (nNume11 < #0#6) ! nDeci_DivP;
*/
     nBrutoMoneda1 = ((nNume11 < #3#8) < #3#29) ! nDeci_DivP;
     nImporDescue1 = (nBrutoMoneda1 % #0#5) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #0#17) ! nDeci_BaseMxP;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #0#6) ! nDeci_BaseMxP
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     nNume11 = nBrutoMoneda1;

     #3#7  = nNume7  * nMult;
     #3#11 = nNume11 * nMult;
     #3#9  = #3#9  * nMult;
     #3#39 = #3#39 * nMult;

     |SI #0#37 = "D";
          #3#41 = #3#9;
     |SINO;
          #3#41 = #3#39;
     |FINSI;
|FPRC;
