|FICHEROS;
     agifa024 #24;
     agifa112 #112;
     agifa142 #142;
     agifa200 #200;
     dsm00225 #225;

     agim0003@;
     agim0016@;
     caclipro@;
     canempre@;
     cacuenta@;
     cacuebal@;
     dsam0103@;
     dsam0104@;
|FIN;

|VARIABLES;
     aPan = "";
     aPeri = "";
     aNif = "";
     aCta = "";
     aEmp = "";
     nSal = 0;
     nCam14 = 0;
     nCam15 = 0;
     nCam16 = 0;
     nCam17 = 0;
     nCam18 = 0;
     nCam19 = 0;
     aAlfa = "";
     aTipo = "";
     aDef = "";
     aFich = "";
     nCampos = 0;
     aCuenta = "";
     aLon = "";
     nDigito = 0;
     aZona = "";
     aNonCta = "";
     aDMes = "";
     aHMes = "";
     aMes = "";
     nMes = 0;
     aAlfa1 = "";
|FIN;

|PROCESO SacaMes;
     |SI nMes = 01; aMes = "Enero";     |FINSI;
     |SI nMes = 02; aMes = "Febrero";   |FINSI;
     |SI nMes = 03; aMes = "Marzo";     |FINSI;
     |SI nMes = 04; aMes = "Abril";     |FINSI;
     |SI nMes = 05; aMes = "Mayo";      |FINSI;
     |SI nMes = 06; aMes = "Junio";     |FINSI;
     |SI nMes = 07; aMes = "Julio";     |FINSI;
     |SI nMes = 08; aMes = "Agosto";    |FINSI;
     |SI nMes = 09; aMes = "Septiembre";|FINSI;
     |SI nMes = 10; aMes = "Octubre";   |FINSI;
     |SI nMes = 11; aMes = "Noviembre"; |FINSI;
     |SI nMes = 12; aMes = "Diciembre"; |FINSI;
|FPRC;

|PROCESO LeeCta;
     aAlfa = aCta + "000000000000";

     aAlfa1 = aAlfa % A101;
     #cacuebal@#0 = aAlfa1;
     |LEE 040#cacuebal@.=;
     |SI FSalida = 0;
          |ACABA;
     |FINSI;

     aAlfa1 = aAlfa % A102;
     #cacuebal@#0 = aAlfa1;
     |LEE 040#cacuebal@.=;
     |SI FSalida = 0;
          |ACABA;
     |FINSI;

     aAlfa1 = aAlfa % A103;
     #cacuebal@#0 = aAlfa1;
     |LEE 040#cacuebal@.=;
     |SI FSalida = 0;
          |ACABA;
     |FINSI;

     aAlfa1 = aAlfa % A104;
     #cacuebal@#0 = aAlfa1;
     |LEE 040#cacuebal@.=;
     |SI FSalida ! 0;
          |DDEFECTO #cacuebal@;
     |FINSI;
|FPRC;

|PROCESO AltaCta;
     aAlfa = aDef + "cacuenta";
     |CARGA_DEF aAlfa, cacuenta@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aAlfa = aDef + "cacuebal";
     |CARGA_DEF aAlfa, cacuebal@;
     |SI FSalida = 0;
          |PATH_DAT #cacuenta@#aFich#;
          |PATH_DAT #cacuebal@#aFich#;

          |ABRE #cacuenta@;
          |ABRE #cacuebal@;

          #cacuenta@#0 = aCta;
          #cacuenta@#1 = nDigito;
          |LEE 101#cacuenta@.=;
          |SI FSalida ! 0; |GRABA 020#cacuenta@.b; |FINSI;

          #cacuenta@#2 = aNonCta;
          #cacuenta@#3 = "S";    ||Pase directo;


          |HAZ LeeCta;

          #cacuenta@#4 = #cacuebal@#1;   ||bloque - fichero cacuebal;
          #cacuenta@#5 = #cacuebal@#2;   ||tipo;
          #cacuenta@#6 = #cacuebal@#3;   ||agrupacion;
          #cacuenta@#7 = #cacuebal@#4;   ||epigrafe;
          #cacuenta@#8 = #cacuebal@#5;   ||partida;

          #cacuenta@#56 = aDMes;   ||Desde ejercicio;
          #cacuenta@#57 = aHMes;   ||Hasta ejercicio;

          aAlfa = aCta;  |QBF aAlfa;
          aAlfa = (aAlfa + "zzzzzzzzzzzzzzzzzzzz" % 112);
          #cacuenta@#54 = aAlfa;
          #cacuenta@#55 = nDigito;

          aAlfa = "|NC"; nCampos = #cacuenta@#aAlfa#;
          |SI nCampos > 61;
               #cacuenta@#61 = aZona;  || (SOLO EN CONTAGEN!)
          |FINSI;
          |GRABA 020#cacuenta@.a;

          |CIERRA #cacuenta@;
          |CIERRA #cacuebal@;
          |DESCARGA_DEF #cacuebal@;
     |FINSI;
     |DESCARGA_DEF #cacuenta@;
|FPRC;

|PROCESO SacaDigito;
     ||aCuenta = #caclipro@#10; |QBF aCuenta;
     ||aCuenta = #24#16;   |QBF aCuenta;
     aCuenta = aCta;       |QBF aCuenta;          || utiliza aCta, desde |PROGRAMA
     aLon = aCuenta % A0;
     |SI aLon = nCam14; nDigito = 1; |FINSI;
     |SI aLon = nCam15; nDigito = 2; |FINSI;
     |SI aLon = nCam16; nDigito = 3; |FINSI;
     |SI aLon = nCam17; nDigito = 4; |FINSI;
     |SI aLon = nCam18; nDigito = 5; |FINSI;
     |SI aLon = nCam19; nDigito = 6; |FINSI;
|FPRC;

|PROCESO Contabilidad;
     |SI aCta = ""; |ACABA; |FINSI;

     |DBASE aAlfa;
     aAlfa = aAlfa + "fich/" + aEmp + "/";
     |PATH_DAT #142#aAlfa#;

     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     aAlfa = #142#151; |QBF aAlfa;
     aDef = aAlfa + "def/";

     aFich = aAlfa + "fich/";
     aAlfa = aDef + "canempre";
     |CARGA_DEF aAlfa, canempre@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aPeri = ("00000" + #142#152) % -101;
     aEmp = ("00000" + #142#152) % -205;

     |PATH_DAT #canempre@#aFich#;
     |ABRE #canempre@;
     #canempre@#2 = aEmp;
     #canempre@#3 = aPeri;
     |LEE 000#canempre@.=;
     nSal = FSalida;
     |CIERRA #canempre@;
     nCam14 = #canempre@#14;
     nCam15 = #canempre@#15;
     nCam16 = #canempre@#16;
     nCam17 = #canempre@#17;
     nCam18 = #canempre@#18;
     nCam19 = #canempre@#19;

     nMes = #canempre@#11; |HAZ SacaMes; aDMes = aMes;
     nMes = #canempre@#12; |HAZ SacaMes; aHMes = aMes;

     |DESCARGA_DEF #canempre@

     |SI nSal ! 0; |ACABA; |FINSI; || NO existe empresa contable

     aAlfa = ("0000000" + #142#152) % -106;
     aFich = aFich + aAlfa + "/";
     aAlfa = aDef + "caclipro";
     |CARGA_DEF aAlfa, caclipro@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |PATH_DAT #caclipro@#aFich#;

     |ABRE #caclipro@;

     |HAZ SacaDigito;

     |SI aTipo = "C";
          |DDEFECTO #caclipro@;
          #caclipro@#23 = "C";
          #caclipro@#10 = aCta;
          #caclipro@#11 = nDigito;      || EN agicont ES CLAVE
          |LEE 101#caclipro@.=;
          |SI FSalida ! 0; |GRABA 020#caclipro@.b; |FINSI;
          #caclipro@#0 = #24#0;
          #caclipro@#23 = "C";
          #caclipro@#1 = #24#1;
          #caclipro@#2 = #24#8;
          #caclipro@#3 = #24#181;
          #caclipro@#4 = #24#182;
          #caclipro@#25 = #24#183;
          #caclipro@#24 = #24#205;
          #caclipro@#5 = #24#10;
          #caclipro@#6 = #24#9;
          #caclipro@#7 = #24#17;
          #caclipro@#8 = #24#18;
          #caclipro@#9 = #24#15;
          #caclipro@#10 = aCta;
          #caclipro@#11 = nDigito;
          || #caclipro@#12 = grupo iva;
          #caclipro@#13 = #24#29;
          #caclipro@#14 = #24#34;
          || #caclipro@#15 = cod1 banco;
          || #caclipro@#16 = cod2 banco;
          #caclipro@#17 = #24#30;
          aAlfa = #24#32 + #24#33 + #24#31; |QBT aAlfa;
          #caclipro@#18 = aAlfa;
          #caclipro@#19 = #24#162;
          #caclipro@#20 = #24#20;
          #caclipro@#28 = #24#203;


          aAlfa = "|NC"; nCampos = #caclipro@#aAlfa#;
          |SI nCampos > 29;
               #caclipro@#29 = #24#32;   ||Entidad
               #caclipro@#30 = #24#33;   ||Oficina
               #caclipro@#31 = #24#31;   ||DC
               #caclipro@#32 = #24#30;   ||Nº Cuenta
          |FINSI;
          |SI nCampos > 33;
               #caclipro@#33 = #24#3;    ||Zona.. (SOLO EN CONTAGEN!)
               #caclipro@#34 = #24#22; ||Dia fijo 1
               #caclipro@#35 = #24#23; ||Dia fijo 2
               #caclipro@#36 = #24#24; ||Dia fijo 3
          |FINSI;
          |SI nCampos > 43;
               #caclipro@#40 = #24#215;
               #caclipro@#41 = #24#216;
               #caclipro@#44 = #24#11;
               #caclipro@#45 = #24#184;
               #caclipro@#46 = #24#185;
               #caclipro@#47 = #24#13;
               #caclipro@#48 = #24#12;
               #caclipro@#49 = #24#27;
               #caclipro@#50 = #24#186;
          |FINSI;
          |GRABA 020#caclipro@.a;
     |SINO;
          |DDEFECTO #caclipro@;
          #caclipro@#23 = "P";
          #caclipro@#10 = aCta;
          #caclipro@#11 = nDigito;      || EN agicont ES CLAVE
          |LEE 101#caclipro@.=;
          |SI FSalida ! 0; |GRABA 020#caclipro@.b; |FINSI;
          #caclipro@#0 = #112#0;
          #caclipro@#23 = "P";
          #caclipro@#1 = #112#1;
          #caclipro@#2 = #112#3;
          #caclipro@#3 = #112#74;
          #caclipro@#4 = #112#75;
          #caclipro@#25 = #112#76;
          #caclipro@#24 = #112#89;
          #caclipro@#5 = #112#5;
          #caclipro@#6 = #112#4;
          #caclipro@#7 = #112#6;
          #caclipro@#8 = #112#7;
          #caclipro@#9 = #112#9;
          #caclipro@#11 = nDigito;
          #caclipro@#13 = #112#11;
          #caclipro@#14 = #112#16;
          #caclipro@#17 = #112#12;
          aAlfa = #112#14 + #112#15 + #112#13; |QBT aAlfa;
          #caclipro@#18 = aAlfa;
          #caclipro@#19 = #112#57;
          #caclipro@#20 = #112#17;
          #caclipro@#28 = #112#98;


          aAlfa = "|NC"; nCampos = #caclipro@#aAlfa#;
          |SI nCampos > 29;
               #caclipro@#29 = #112#14;
               #caclipro@#30 = #112#15;
               #caclipro@#31 = #112#13;
               #caclipro@#32 = #112#12;
               #caclipro@#33 = #112#92;   ||Zona.. (SOLO EN CONTAGEN!)
               #caclipro@#34 = #112#19;
               #caclipro@#35 = #112#20;
               #caclipro@#36 = #112#21;
               #caclipro@#37 = #112#99;
               #caclipro@#38 = #112#94;
               #caclipro@#39 = #112#95;
               #caclipro@#40 = #112#96;
               #caclipro@#41 = #112#97;
          |FINSI;
          |SI nCampos ] 43;
               aAlfa = #112#100; |QBF aAlfa;
               |SI aAlfa ! ""; #caclipro@#43 = #112#100; |FINSI;
               |SI nCampos > 43;
                    #caclipro@#44 = #112#101;
                    #caclipro@#45 = #112#102;
                    #caclipro@#46 = #112#103;
                    #caclipro@#47 = #112#104;
                    #caclipro@#48 = #112#105;
                    #caclipro@#49 = #112#106;
                    #caclipro@#50 = #112#107;
              |FINSI;
          |FINSI;
          |GRABA 020#caclipro@.a;
     |FINSI;

     |CIERRA #caclipro@;
     |DESCARGA_DEF #caclipro@;

     |HAZ AltaCta;
|FPRC;


|PROCESO CtrlEmp;
     |SI #200#1 = "S"; |O #200#2 = "S";
          aEmp = ("00000" + #200#0) % -105;
          |HAZ Contabilidad;
     |FINSI;
|FPRC;

|DEFBUCLE CtrlEmp;
     #200#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, CtrlEmp;
|FIN;

|PROCESO MiraPais;
     |ABRE #225;
     |SI aTipo = "C";
          #225#0 = #24#205;
     |SINO;
          #225#0 = #112#89;
     |FINSI;
     |LEE 000#225=;
     |CIERRA #225;

     |ABRE #agim0016@;
     #agim0016@#0 = #agim0003@#12;
     |LEE 000#agim0016@.=;
     |SI FSalida ! 0;
          |PUSHV 0501 2380;
          |MENAV "0000No existe el pais en el modulo integrador";
          #agim0016@#1 = #225#1;
          #agim0016@#5 = #225#6;
          |PINPA #0#agim0016@;
          |PINDA #0#agim0016@;
          |ENDATOS #1#agim0016@;
          |SI FSalida = 0;
               |GRABA 020#agim0016@.n;
          |FINSI;
          |POPV;
     |FINSI;
     |CIERRA #agim0016@;
|FPRC;

|PROCESO Basica;
     |SI aNif = ""; |ACABA; |FINSI;

     |DBASS aAlfa;
     aDef = aAlfa + "basica/def/agim0003";
     aFich = aAlfa + "basica/fich/";

     |CARGA_DEF aDef, agim0003@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |PATH_DAT #agim0003@#aFich#;
     |ABRE #agim0003@;

     aDef = aAlfa + "basica/def/agim0016";
     aFich = aAlfa + "basica/fich/";
     aPan = aAlfa + "basica/pan/";
     |CARGA_DEF aDef, agim0016@;
     |SI FSalida ! 0; |ACABA; |FINSI;
     |PATH_DAT #agim0016@#aFich#;
     |PATH_PAN #agim0016@#aPan#;

     |SI aTipo = "C";
          |DDEFECTO #agim0003@;
          #agim0003@#0 = #24#15;
          |LEE 000#agim0003@.=;
          |SI FSalida ! 0; |GRABA 020#agim0003@.b; |FINSI;

          #agim0003@#1 = #24#1;
          #agim0003@#2 = #24#8;
          #agim0003@#4 = #24#181;
          #agim0003@#5 = #24#182;
          #agim0003@#6 = #24#9;
          #agim0003@#7 = #24#10;
          #agim0003@#8 = #24#17;
          #agim0003@#12 = #24#205;
          |HAZ MiraPais;
          #agim0003@#13 = #agim0016@#1;
          #agim0003@#17 = #24#18;
          |GRABA 020#agim0003@.a;
     |SINO;
          |DDEFECTO #agim0003@;
          #agim0003@#0 = #112#9;
          |LEE 000#agim0003@.=;
          |SI FSalida ! 0; |GRABA 020#agim0003@.b; |FINSI;

          #agim0003@#1 = #112#1;
          #agim0003@#2 = #112#3;
          #agim0003@#4 = #112#74;
          #agim0003@#5 = #112#75;
          #agim0003@#6 = #112#4;
          #agim0003@#7 = #112#5;
          #agim0003@#8 = #112#6;
          #agim0003@#12 = #112#89;
          |HAZ MiraPais;
          #agim0003@#13 = #agim0016@#1;
          #agim0003@#17 = #112#7;
          |GRABA 020#agim0003@.a;
     |FINSI;

     |CIERRA #agim0003@;

     |DESCARGA_DEF #agim0016@;
     |DESCARGA_DEF #agim0003@;
|FPRC;

|PROCESO MiraPaisI;
     |ABRE #225;
     |SI aTipo = "C";
          #225#0 = #24#205;
     |SINO;
          #225#0 = #112#89;
     |FINSI;
     |LEE 000#225=;
     |CIERRA #225;

     |ABRE #dsam0104@;
     #dsam0104@#0 = #dsam0103@#12;
     |LEE 000#dsam0104@.=;
     |SI FSalida ! 0;
          |PUSHV 0501 2380;
          |MENAV "0000No existe el pais en el modulo integrador";
          #dsam0104@#1 = #225#1;
          #dsam0104@#5 = #225#6;
          |PINPA #0#dsam0104@;
          |PINDA #0#dsam0104@;
          |ENDATOS #1#dsam0104@;
          |SI FSalida = 0;
               |GRABA 020#dsam0104@.n;
          |FINSI;
          |POPV;
     |FINSI;
     |CIERRA #dsam0104@;
|FPRC;

|PROCESO Integral;
     |SI aNif = ""; |ACABA; |FINSI;

     |DBASS aAlfa;
     aDef = aAlfa + "integral/def/dsam0103";
     aFich = aAlfa + "integral/fich/";

     |CARGA_DEF aDef, dsam0103@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |PATH_DAT #dsam0103@#aFich#;
     |ABRE #dsam0103@;

     aDef = aAlfa + "integral/def/dsam0104";
     aFich = aAlfa + "integral/fich/";
     aPan = aAlfa + "integral/pan/";
     |CARGA_DEF aDef, dsam0104@;
     |SI FSalida ! 0; |ACABA; |FINSI;
     |PATH_DAT #dsam0104@#aFich#;
     |PATH_PAN #dsam0104@#aPan#;

     |SI aTipo = "C";
          |DDEFECTO #dsam0103@;
          #dsam0103@#0 = #24#15;
          |LEE 000#dsam0103@.=;
          |SI FSalida ! 0; |GRABA 020#dsam0103@.b; |FINSI;

          #dsam0103@#1 = #24#1;
          #dsam0103@#2 = #24#8;
          #dsam0103@#4 = #24#181;
          #dsam0103@#5 = #24#182;
          #dsam0103@#6 = #24#9;
          #dsam0103@#7 = #24#10;
          #dsam0103@#8 = #24#17;
          #dsam0103@#12 = #24#205;
          |HAZ MiraPaisI;
          #dsam0103@#13 = #dsam0104@#1;
          #dsam0103@#17 = #24#18;
          |GRABA 020#dsam0103@.a;
     |SINO;
          |DDEFECTO #dsam0103@;
          #dsam0103@#0 = #112#9;
          |LEE 000#dsam0103@.=;
          |SI FSalida ! 0; |GRABA 020#dsam0103@.b; |FINSI;

          #dsam0103@#1 = #112#1;
          #dsam0103@#2 = #112#3;
          #dsam0103@#4 = #112#74;
          #dsam0103@#5 = #112#75;
          #dsam0103@#6 = #112#4;
          #dsam0103@#7 = #112#5;
          #dsam0103@#8 = #112#6;
          #dsam0103@#12 = #112#89;
          |HAZ MiraPaisI;
          #dsam0103@#13 = #dsam0104@#1;
          #dsam0103@#17 = #112#7;
          |GRABA 020#dsam0103@.a;
     |FINSI;

     |CIERRA #dsam0103@;

     |DESCARGA_DEF #dsam0104@;
     |DESCARGA_DEF #dsam0103@;
|FPRC;

|PROGRAMA;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     aTipo = PARAMETRO % 101;
     |SI aTipo = "C";
          |ABRE #24;
          #24#0 = PARAMETRO % 206;
          |LEE 020#24=;
          |SI FSalida ! 0; |ACABA; |FINSI;
          |CIERRA #24;
          aNif = #24#15;
          aCta = #24#16;
          aZona = #24#3;
          aNonCta = #24#1;
     |SINO;
          |ABRE #112;
          #112#0 = PARAMETRO % 206;
          |LEE 020#112=;
          |SI FSalida ! 0; |ACABA; |FINSI;
          |CIERRA #112;
          aNif = #112#9;
          aCta = #112#10;
          aZona = #112#92;
          aNonCta = #112#1;
     |FINSI;
     |QBF aNif;
     |QBF aCta;

     |HAZ Basica;
     |HAZ Integral;

     |DFICE aEmp; aEmp = aEmp % -205;
     |HAZ Contabilidad;

     |BUCLE CtrlEmp;
|FPRO;
