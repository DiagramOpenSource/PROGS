Para depurar, todos los no /*  */ se tendrian que quitar y cambiar los
|GRABA ??b por |GRABA ??n de articulo y almacen


|FICHEROS;
     dsz00061 #0;
     agifa104 #2;   ||Pedido
     agifa073 #3;   ||Lineas de Pedido
     agifa010 #4;   ||Albaranes
     agifa071 #5;
     agifa036 #6;   ||Depositos
     agifa070 #7;
     agifa134 #8;   ||Facturas
     agifa084 #10;  ||Facturas Contado
     agifa069 #11;

     agifa081 #12;  ||Pedidos Compras
     agifa067 #13;
     agifa077 #14;  ||Albaranes Compras
     agifa080 #15;
     agifa079 #16;  ||Facturas Compras
     agifa065 #17;  ||Historico
     agifa090 #19;   ||ORDEN FABRICACION CABACERA
     agifa074 #18;   ||ORDENES FABRICACION LINEA

     agifa142 #42;  ||Parametros generales.

     agifa024 #50;  ||Clientes
     agifa025 #51;  ||Representante
     agifa112 #52;  ||Proveedores
     agifa019 #53;  ||Articulos
     agifa017 #54;  ||Almacenes

     agifa048 #55;  ||Escandallo
     agifa049 #56;  ||Lineas del Escandallo

     agifa501 #57;
     agifa502 #58;
     agis0002 #90;
     dsm00125 #125; ||Acu cli
     dsm00126 #126; ||Acu prv
     dsm00127 #127; ||Acu rep
     dsm00128 #128; ||Acu art
     dsm00129 #129; ||Acu alm

     dsm00238 #238; ||Unidades doble stock

||     agifa041 #141;
     referen@ #100;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     fFecha = @;
     aCliente = "";
     aProve = "";
     aRepre = "";
     aArticulo = "";
     nAlmacen = 0;
     nAno = 0;
     nMes = 0;
     nMesPed = 0;
     nMesCom = 0;
     nMesDto = 0;
     nMesAbo = 0;
     nMesMar = 0;
     nMesComi = 0;
     nMesVta = 0;
     nMesRete = 0;
     nMesUniCom = 0;
     nMesImpCom = 0;
     nMesUniVta = 0;
     nMesImpVta = 0;
     nMesImpMar = 0;
     nMesUniSal = 0;
     nMesUniEnt = 0;
     nImpCliPed = 0;
     nImpCliCom = 0;
     nImpCliDto = 0;
     nImpCliAbo = 0;
     nImpCliMar = 0;
     nImpPrvPed = 0;
     nImpPrvCom = 0;
     nImpRepComi = 0;
     nImpRepVta = 0;
     nImpRepRete = 0;
     nUniCom = 0;
     nImpCom = 0;
     nUniVta = 0;
     nImpVta = 0;
     nImpMar = 0;
     nUniSal = 0;
     nUniEnt = 0;

     nSwAlbadis = 0;
     nHayArti = 0;
     nHayAlma = 0;
     nHayParti = 0;
     nCanti2   = 0;
     nUni0     = 0;
     &eaDarti  = "";
     &eaHarti  = "";
     nError    = 0;
     aDef      = "";
     aPath     = "";
     aAlfa     = "";
     nUni      = "";
     aParam    = "";
     nMargen   = 0;
     nDto      = 0;
     nImpo     = 0;
     fmes      = "";
     anyo      = "";
     beta      = 0;
     mes       = 0;
     canti1    = 0;
     canti2    = 0;
     i         = 0;
     imneto    = 0;
     ncoste    = 0;
     margen    = 0;

    scanti  = 0;
    canti   = 0;
    articul = "";
    almacen = 0;
    swopera = 0;
    fabSN   = "";
    &cierre = 0;
    &enAltaCliente = 0;
|FIN;
========================Acumulados por A¤os===============================
|PROCESO AcumCli;
     aAlfa = fFecha; aAlfa = aAlfa % 402; nMes = aAlfa; nMes = nMes - 1;
     aAlfa = fFecha; aAlfa = aAlfa % 704; nAno = aAlfa;
     |DDEFECTO #125;
     #125#0 = aCliente;
     #125#1 = nAno;
     |LEE 101#125=;
     |SI FSalida ! 0; |GRABA 020#125b; |FINSI;

     nMesPed = nMes + 2;
     nMesCom = nMes + 15;
     nMesDto = nMes + 28;
     nMesAbo = nMes + 41;
     nMesMar = nMes + 55;

     #125nMesPed = #125nMesPed + nImpCliPed;
     #125nMesCom = #125nMesCom + nImpCliCom;
     #125nMesDto = #125nMesDto + nImpCliDto;
     #125nMesAbo = #125nMesAbo + nImpCliAbo;
     #125nMesMar = #125nMesMar + nImpCliMar;

     #125#14 = #125#14 + nImpCliPed;
     #125#27 = #125#27 + nImpCliCom;
     #125#40 = #125#40 + nImpCliDto;
     #125#54 = #125#54 + nImpCliAbo
     #125#67 = #125#67 + nImpCliMar;
     |GRABA 020#125a;
     |LIBERA #125;

     nImpCliPed = 0;
     nImpCliCom = 0;
     nImpCliDto = 0;
     nImpCliAbo = 0;
     nImpCliMar = 0;

|FPRC;

|PROCESO AcumPrv;
     aAlfa = fFecha; aAlfa = aAlfa % 402; nMes = aAlfa; nMes = nMes - 1;
     aAlfa = fFecha; aAlfa = aAlfa % 704; nAno = aAlfa;
     |DDEFECTO #126;
     #126#0 = aProve;
     #126#1 = nAno;
     |LEE 101#126=;
     |SI FSalida ! 0; |GRABA 020#126b; |FINSI;

     nMesPed = nMes + 2;
     nMesCom = nMes + 15;

     #126nMesPed = #126nMesPed + nImpPrvPed;
     #126nMesCom = #126nMesCom + nImpPrvCom;

     #126#14 = #126#14 + nImpPrvPed;
     #126#27 = #126#27 + nImpPrvCom;

     |GRABA 020#126a;
     |LIBERA #126;
     nImpPrvPed = 0;
     nImpPrvCom = 0;
|FPRC;

|PROCESO AcumRep;
     aAlfa = fFecha; aAlfa = aAlfa % 402; nMes = aAlfa; nMes = nMes - 1;
     aAlfa = fFecha; aAlfa = aAlfa % 704; nAno = aAlfa;
     |DDEFECTO #127;
     #127#0 = aRepre;
     #127#1 = nAno;
     |LEE 101#127=;
     |SI FSalida ! 0; |GRABA 020#127b; |FINSI;

     nMesComi = nMes + 2;
     nMesVta = nMes + 15;
     nMesRete = nMes + 28;

     #127nMesComi = #127nMesComi + nImpRepComi;
     #127nMesVta = #127nMesVta + nImpRepVta;
     #127nMesRete = #127nMesRete + nImpRepRete;

     #127#14 = #127#14 + nImpRepComi;
     #127#27 = #127#27 + nImpRepVta;
     #127#40 = #127#40 + nImpRepRete;

     |GRABA 020#127a;
     |LIBERA #127;

     nImpRepComi = 0;
     nImpRepVta = 0;
     nImpRepRete = 0;
|FPRC;

|PROCESO AcumArt;
     aAlfa = fFecha; aAlfa = aAlfa % 402; nMes = aAlfa; nMes = nMes - 1;
     aAlfa = fFecha; aAlfa = aAlfa % 704; nAno = aAlfa;
     |DDEFECTO #128;
     #128#0 = aArticulo;
     #128#1 = nAno;
     |LEE 101#128=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#128b; |FINSI;
     nHayArti = FSalida;

     nMesUniCom = nMes + 2;
     nMesImpCom = nMes + 15;
     nMesUniVta = nMes + 28;
     nMesImpVta = nMes + 41;
     nMesImpMar = nMes + 54;

     #128nMesUniCom = #128nMesUniCom + nUniCom;
     #128nMesImpCom = #128nMesImpCom + nImpCom;
     #128nMesUniVta = #128nMesUniVta + nUniVta;
     #128nMesImpVta = #128nMesImpVta + nImpVta;
     #128nMesImpMar = #128nMesImpMar + nImpMar;

     #128#14 = #128#14 + nUniCom;
     #128#27 = #128#27 + nImpCom;
     #128#40 = #128#40 + nUniVta;
     #128#53 = #128#53 + nImpCom;
     #128#66 = #128#66 + nImpMar;

     |SI nHayArti = 0; |GRABA 020#128a; |FINSI;
     |LIBERA #128;

     nUniCom = 0;
     nImpCom = 0;
     nUniVta = 0;
     nImpVta = 0;
     nImpMar = 0;
|FPRC;

|PROCESO AcumAlm;
     aAlfa = fFecha; aAlfa = aAlfa % 402; nMes = aAlfa; nMes = nMes - 1;
     aAlfa = fFecha; aAlfa = aAlfa % 704; nAno = aAlfa;
     |DDEFECTO #129;
     #129#0 = aArticulo;
     #129#1 = nAlmacen;
     #129#2 = nAno;
     |LEE 101#129=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#129b; |FINSI;
     nHayAlma = FSalida;

     nMesUniSal = nMes + 3;
     nMesUniEnt = nMes + 16;

     #129nMesUniSal = #129nMesUniSal + nUniSal;
     #129nMesUniEnt = #129nMesUniEnt + nUniEnt;

     #129#15 = #129#15 + nUniSal;
     #129#28 = #129#28 + nUniEnt;

     |SI nHayAlma = 0; |GRABA 020#129a; |FINSI;
     |LIBERA #129;
     nUniSal = 0;
     nUniEnt = 0;
|FPRC;
========================Borra Acumulados por A¤os=========================
|PROCESO dsm00125;
     |CDEFECTO #125, 1;
     |GRABA 020#125a;
     |LIBERA #125;
|FPRC;

|DEFBUCLE dsm00125;
     #125#1;
     ;
     "      ", 0000;
     "zzzzzz", 9999;
     be;
     NULL, dsm00125;
|FIN;

|PROCESO dsm00126;
     |CDEFECTO #126, 1;
     |GRABA 020#126a;
     |LIBERA #126;
|FPRC;

|DEFBUCLE dsm00126;
     #126#1;
     ;
     "      ", 0000;
     "zzzzzz", 9999;
     be;
     NULL, dsm00126;
|FIN;

|PROCESO dsm00127;
     |CDEFECTO #127, 1;
     |GRABA 020#127a;
     |LIBERA #127;
|FPRC;

|DEFBUCLE dsm00127;
     #127#1;
     ;
     "  ", 0000;
     "zz", 9999;
     be;
     NULL, dsm00127;
|FIN;

|PROCESO dsm00128;
     |CDEFECTO #128, 1;
     |GRABA 020#128a;
     |LIBERA #128;
|FPRC;

|DEFBUCLE dsm00128;
     #128#1;
     ;
     "                    ", 0000;
     "zzzzzzzzzzzzzzzzzzzz", 9999;
     be;
     NULL, dsm00128;
|FIN;

|PROCESO dsm00129;
     |CDEFECTO #129, 1;
     |GRABA 020#129a;
     |LIBERA #129;
|FPRC;

|DEFBUCLE dsm00129;
     #129#1;
     ;
     "                    ", 00001, 0000;
     "zzzzzzzzzzzzzzzzzzzz", 99999, 9999;
     be;
     NULL, dsm00129;
|FIN;
||============================= BORRADO DE CLIENTES =======================
|PROCESO borracli;
     #50#50 = 0;    ||Pendiente facturar
     #50#51 = 0;    ||Impagados
     #50#110 = 0;   ||Total facturado

     |PDEFECTO #50, 54,108;
     #50#110 = 0;
     |PDEFECTO #50,114,154;
     #50#154 = 0;
     #50#109 = 0;

     |GRABA 020#50a;
     |LIBERA #50;
|FPRC;

|DEFBUCLE clientes;
     #50#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL , borracli;
|FIN;

||=========================== BORRADO DE COMISIONISTAS ====================

|PROCESO borracomi;
     |PDEFECTO #51, 11,37;
     |PDEFECTO #51, 40,53;
     #51#37 = 0;
     #51#38 = 0;
     #51#53 = 0;
     |GRABA 020#51a;
     |LIBERA #51;
|FPRC;

|DEFBUCLE comision;
     #51#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL , borracomi;
|FIN;

||======================== BORRADO DE PROVEEDORES =========================

|PROCESO borraprove;
     |PDEFECTO #52, 27, 40;
     |PDEFECTO #52, 43, 56;
     #52#40 = 0;
     #52#56 = 0;
     |GRABA 020#52a;
     |LIBERA #52;
|FPRC;


|DEFBUCLE proveedor;
     #52#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL , borraprove;
|FIN;

||========================= BORRADO DE ARTICULOS ==========================

|PROCESO borraarti;
     #53#194 = 1; ||Factu Venta
     #53#196 = 1; ||Factu Comp
     |SI #53#179 = "S";
          |DDEFECTO #238;
          #238#0 = #53#201;
          |LEE 000#238=;
          #53#188 = #238#8; ||Tipo
          #53#192 = #238#13;||Divisor
          #53#194 = #238#6; ||Factu Venta
          #53#196 = #238#7; ||Factu Comp
          #53#197 = #238#12; ||Pedir medidas
     |FINSI;

     |SI nSwAlbadis = 0;
          #53#196 = 2; ||Factu Comp
     |FINSI;
/*
     |PDEFECTO #53,32,97;
     #53#104 = #53#104 + #53#14;
     #53#104 = #53#104 + #53#12;
     #53#15 = 0;    ||Pendiente de servir
     #53#16 = 0;    ||Pendiente de recibir
     #53#14 = 0;    ||Stock en deposito
     #53#13 = 0;    ||En fabricacion
     #53#12 = 0;    ||Stock Reservado
*/
     |HAZ ValoraStock;
     |GRABA 020#53a;
     |LIBERA #53;
|FPRC;

|DEFBUCLE articulo;
     #53#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL , borraarti;
|FIN;

||========================= BORRADO DE ALMACENES ==========================

|PROCESO borraalma;
     |PDEFECTO #54,11,37;
     #54#39 = #54#39 + #54#10;
     #54#39 = #54#39 + #54#8;
     #54#10 = 0;    ||Stock en deposito
     #54#8 = 0;     ||Stock Reservado
     #54#42 = 0;    ||Pte Servir
     #54#43 = 0;    ||Pte Recibir
     #54#50 = 0;
     |GRABA 020#54a;
     |LIBERA #54;
|FPRC;

|DEFBUCLE almacen;
     #54#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL , borraalma;
|FIN;

|| **********************************************************************
|| ********** Proceso Especial para Escandallos *************************
|| **********************************************************************
|CALCULO linescan;
     canti   = scanti * #56#4;
     articul = #56#2;
     almacen = #56#9;
     |SI swopera = 1; |HAZ pedive_a; |FINSI; || Pedido Venta
     |SI swopera = 2; |HAZ deposi_a; |FINSI; || Deposito
     |SI swopera = 3; almacen = #19#19; |HAZ fabric_a; |FINSI; || Fabrica
|FCAL;

|CALCULO escandallos;
     |ABRE #55;
     #55#0 = articul;
     |LEE 000#55=;
     |SI FSalida = 0;
          |BUCLELIN 0linescan#55;
     |FINSI;
     |CIERRA #55;
|FCAL;

||======================== PROCESOS DE PEDIDOS ============================
|PROCESO pedive_a;
     #53#0 = articul;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#5 = "S";
          |DDEFECTO #53;
          #53#0 = articul;
          |GRABA 020#53b;
     |FINSI;
     nHayArti = FSalida;

     #54#0 = articul;
     #54#1 = almacen;
     |LEE 101#54=;
     |SI FSalida ! 0; |Y #0#5 = "S";
          |DDEFECTO #54;
          #54#0 = articul;
          #54#1 = almacen;
          |GRABA 020#54b;
     |FINSI;
     nHayAlma = FSalida;
/*
     #53#15 = #53#15 + canti; || pendiente de servir;
     #53#182 = #53#182 + nCanti2;
     |SI #3#22 = "S";
          #53#12  = #53#12  + canti;
          #53#104 = #53#104 - canti;
          #53#193 = #53#193 - nCanti2;
     |FINSI;
     #54#42 = #54#42 + canti;      || pendiente de servir;
     |SI #3#22 = "S";
          #54#8  = #54#8  + canti;
          #54#39 = #54#39 - canti;
          #54#48 = #54#48 - nCanti2;
     |FINSI;
*/
     |HAZ ValoraStock;
     |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
     |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|PROCESO linpedi;
     #53#2 = #3#2;
     |LEE 000#53=;

     |SI #53#194 = 2; nUni0 = #3#44; |SINO; nUni0 = #3#5; |FINSI;
     nImpo = ((((nUni0 * #3#6) < #3#8) < #3#29) < #2#5) < #2#17;
     |SI #42#115 = "S";
          nImpo = nImpo < #2#6;
     |FINSI;

     fFecha = #2#1;
     aCliente = #2#4;
     nImpCliPed = nImpo;
     |HAZ AcumCli;

     scanti  = #3#5 - #3#43;
     canti   = #3#5 - #3#43;
     nCanti2 = #3#44 - #3#49;
     articul = #3#2;
     almacen = #3#3;
     |HAZ pedive_a; || Actualiza el principal
     swopera = 1;
     |SI fabSN = "S"; |HAZ escandallos; |FINSI;
|FPRC;

|DEFBUCLE pedi;
     #2#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL  , NULL , linpedi;
|FIN;

||=========================== PROCESOS DE DEPOSITOS ======================
|PROCESO deposi_a;
     #53#0 = articul;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#5 = "S";
          |DDEFECTO #53;
          #53#0 = articul;
          |GRABA 020#53b;
     |FINSI;
     nHayArti = FSalida;

     #54#0 = articul;
     #54#1 = almacen;
     |LEE 101#54=;
     |SI FSalida ! 0; |Y #0#5 = "S";
         |DDEFECTO #54;
         #54#0 = articul;
         #54#1 = almacen;
         |GRABA 020#54b;
     |FINSI;
     nHayAlma = FSalida;
/*
     #53#14  = #53#14  + canti; || En Deposito
     #53#184 = #53#184 + nCanti2;
     #53#104 = #53#104 - canti; || Stock Disponible;
     #53#193 = #53#193 - nCanti2;
     #54#10 = #54#10 + canti;
     #54#39 = #54#39 - canti;
     #54#46 = #54#46 + nCanti2;
     #54#48 = #54#48 - nCanti2;
*/
     |HAZ ValoraStock;
     |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
     |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|PROCESO lindepo;
     scanti  = #7#5;
     canti   = #7#5;
     articul = #7#2;
     almacen = #7#3;
     |HAZ deposi_a; || Actualiza el principal
     swopera = 2;
     |SI fabSN = "S"; |HAZ escandallos; |FINSI;
|FPRC;

|DEFBUCLE depo;
     #6#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL , NULL, lindepo;
|FIN;


||=========================== PROCESOS DE ALBARANES ======================

|PROCESO cabalba;
     |DDEFECTO #50;
     #50#0 = #4#3;
     |LEE 101#50=;
     |SI FSalida ! 0;|Y enAltaCliente = 0;
          |GRABA 020#50b;
     |FINSI;
     canti = #4#15 < #4#5;
     canti = canti < #4#32;
     canti = canti < #4#7;
     |SI #4#43 = "N";
          #50#50 = #50#50 + canti;      ||Pendiente de Facturar
     |SINO;
          #50#50 = #50#50 - canti;      ||Pendiente de Facturar
     |FINSI;
     |GRABA 000#50a;
     |LIBERA #50;
|FPRC;

|PROCESO linalba;
     |DDEFECTO #53;
     #53#0 = #5#2;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#53b; |FINSI;
     nHayArti = FSalida;
     |DDEFECTO #54;
     #54#0 = #5#2;
     #54#1 = #5#3;
     |LEE 101#54=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#54b; |FINSI;
     nHayAlma = FSalida;
     |SI #53#194 = 2; nUni0 = #5#48; |SINO; nUni0 = #5#5; |FINSI;
     |SI #4#43 = "N";
          nUniVta = nUni0;
          nUniSal = nUni0;
     |SINO;
          nUniVta = -nUni0;
          nUniSal = -nUni0;
     |FINSI;

     fFecha = #4#1;
     aArticulo = #5#2;
     nAlmacen = #5#3;
     |HAZ AcumArt;
     |HAZ AcumAlm;

     |HAZ linalba2;
     |HAZ ValoraStock;
     |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
     |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|PROCESO linalba2;
     || Al importe total de la linea le quitamos los dtos. del cliente
     |SI #4#38 = "N"; |ACABA; |FINSI;    || Solo si esta facturado

     imneto = #5#9 < #4#5;
     imneto = imneto < #4#7;
     |SI #42#115 = "S";
          imneto = imneto < #4#32;
     |FINSI;

     ncoste = #5#14;                || Coste
     margen = imneto - ncoste;

     nImpVta = imneto;
     nImpMar = margen;
     |HAZ AcumArt;
|FPRC;

|DEFBUCLE alba;
     #4#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL , cabalba , linalba;
|FIN;

||========================== PROCESOS DE FACTURAS =========================
|PROCESO cabfac;
     |DDEFECTO #50;
     #50#0 = #8#2;
     |LEE 101#50=;
     |SI FSalida ! 0;|Y enAltaCliente = 0;
         |GRABA 020#50b;
     |FINSI;

     canti = #8#18 - #8#17;
     |SI #42#115 = "N";
          nImpo = (canti * 100) / (100 - #8#6);
          nDto = #8#17 + canti - nImpo;
     |SINO;
          nImpo = canti;
          nDto = #8#17;
     |FINSI;

     #50#50  = #50#50 - canti;
     #50#110 = #50#110 + canti;
     |GRABA 000#50a;
     |LIBERA #50;

     fFecha = #8#1;
     aCliente = #8#2;
     nImpCliCom = nImpo;
     nImpCliDto = nDto;
     |SI #8#31 < 0; nImpCliAbo = -canti; |FINSI;
     nImpCliMar = #8#46;
     |HAZ AcumCli;
                    ||Empiezo con el comisionista
     |DDEFECTO #51;
     #51#0 = #8#7;
     |LEE 000#51=;
     |SI FSalida ! 0;
          |GRABA 020#51n;
     |FINSI;

     fFecha = #8#1;
     aRepre = #8#7;
     nImpRepComi = #8#8;
     nImpRepVta = canti;
     nImpRepRete = #51#35 % #51#39;
     |HAZ AcumRep;
|FPRC;

|DEFBUCLE factura;
     #8#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL , cabfac;
|FIN;

||========================= PROCESOS FACTURAS CONTADO =====================

|PROCESO cabcont;
     |DDEFECTO #50;
     #50#0 = #10#3;
     |LEE 101#50=;
     |SI FSalida ! 0;|Y enAltaCliente = 0;
          |GRABA 020#50b;
     |FINSI;
     canti  = #10#15 - #10#25;
     |SI #42#115 = "N";
          nImpo = (canti * 100) / (100 - #10#7);
          nDto = #10#25 + (canti - nImpo);
     |SINO;
          nImpo = canti;
          nDto = #10#25;
     |FINSI;
     #50#110 = #50#110 + canti;
     |GRABA 000#50a;
     |LIBERA #50;

     fFecha = #10#1;
     aCliente = #10#3;
     nImpCliCom = nImpo;
     nImpCliDto = nDto;
     nImpCliMar = #10#37;
     |HAZ AcumCli;
                         ||Empiezo con el Representante
     |DDEFECTO #51;
     #51#0 = #10#6;
     |LEE 000#51=;
     |SI FSalida ! 0;
          |GRABA 020#51n;
     |FINSI;

     fFecha = #10#1;
     aRepre = #10#6;
     nImpRepComi = #10#26;
     nImpRepVta = #10#15 - #10#25;
     nImpRepRete = #51#35 % #51#39;
     |HAZ AcumRep;
|FPRC;

|PROCESO lincont;
     |DDEFECTO #53;
     #53#0 = #11#2;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#53b; |FINSI;
     nHayArti = FSalida;
     |DDEFECTO #54;
     #54#0 = #11#2;
     #54#1 = #11#3;
     |LEE 101#54=;
     |SI FSalida ! 0;|Y #0#5 = "S"; |GRABA 020#54b; |FINSI;
     nHayAlma = FSalida;

     canti = #11#9 < #10#5;
     canti = canti < #10#32;
     |SI #42#115 = "S";
          canti = canti < #10#7;
     |FINSI;
     |SI #53#194 = 2; nUni0 = #5#48; |SINO; nUni0 = #5#5; |FINSI;
     canti1 = canti - #11#14;

     fFecha = #10#1;
     aArticulo = #11#2;
     nAlmacen = #11#3;
     nUniVta = nUni0;
     nImpVta = canti;
     nImpMar = canti1;
     nUniSal = nUni0;
     |HAZ AcumArt;
     |HAZ AcumAlm;
     |HAZ ValoraStock;
     |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
     |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|DEFBUCLE contado;
     #10#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL , cabcont , lincont;
|FIN;

||========================= PROCESOS DE PEDIDOS COMPRAS ===================
|PROCESO linpedcom;
     #53#0 = #13#2;
     |LEE 000#53=;

     |DDEFECTO #52;
     #52#0 = #12#4;
     |LEE 000#52=;
     |SI FSalida ! 0; |GRABA 020#52n; |FINSI;

     |SI #53#196 = 2; nUni0 = #13#41; |SINO; nUni0 = #13#5; |FINSI;
     nImpo = (((((nUni0 * #13#6) < #13#8) < #13#27) < #13#57) < #12#5) < #12#17;
     |SI #42#114 = "S";
          nImpo = nImpo < #12#6;
     |FINSI;

     fFecha = #12#1;
     aProve = #12#4;
     nImpPrvPed = nImpo;
     |HAZ AcumPrv;

     |DDEFECTO #53;
     #53#0 = #13#2;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#53b; |FINSI;
     nHayArti = FSalida;
     |DDEFECTO #54;
     #54#0 = #13#2;
     #54#1 = #13#3;
     |LEE 101#54=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#54b; |FINSI;
     nHayAlma = FSalida;
/*
     |SI #53#204 = "S";
          #53#16 = #53#16 + (#13#41 - #13#46);     ||Pendiente de Recibir
          #54#43 = #54#43 + (#13#41 - #13#46);     || Pendiente de Recibir
     |SINO;
          #53#16 = #53#16 + (#13#5 - #13#38);      ||Pendiente de Recibir
          #53#183 = #53#183 + (#13#41 - #13#46);
          #54#43 = #54#43 + (#13#5 - #13#38);       || Pendiente de Recibir
          #54#45 = #54#45 + (#13#41 - #13#46);      || Pendiente de Recibir
     |FINSI;
*/
     |HAZ ValoraStock;
     |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
     |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|DEFBUCLE pedicom;
     #12#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, NULL, linpedcom;
|FIN;

||========================== PROCESOS ALBARANES COMPRAS ==================
|PROCESO linalbcom;
     |DDEFECTO #53;
     #53#0 = #15#2;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#53b; |FINSI;
     nHayArti = FSalida;
     |DDEFECTO #54;
     #54#0 = #15#2;
     #54#1 = #15#3;
     |LEE 101#54=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#54b; |FINSI;
     nHayAlma = FSalida;

     |DDEFECTO #52;
     #52#0 = #14#3;
     |LEE 000#52=;
     |SI FSalida ! 0; |GRABA 020#52n; |FINSI;

     |SI #53#194 = 2; nUni0 = #15#36; |SINO; nUni0 = #15#5; |FINSI;
     nImpo = (((((nUni0 * #15#6) < #15#8) < #15#26) < #15#45) < #14#5) < #14#32;
     |SI #42#114 = "S";
           nImpo = nImpo < #14#7;
     |FINSI;

     fFecha = #14#1;
     aProve = #14#3;
     nImpPrvCom = nImpo;
     |HAZ AcumPrv;

     |SI #53#196 = 2; nUni0 = #15#36; |SINO; nUni0 = #15#5; |FINSI;
     nImpo = (((((nUni0 * #15#6) < #15#8) < #15#26) < #15#45) < #14#5) < #14#32;
     |SI nSwAlbadis = 0; nUni0 = #15#5; |FINSI;
     |SI #42#114 = "S";
          nImpo = nImpo < #14#7;
     |FINSI;

     fFecha = #14#1;
     aArticulo = #15#2;
     nAlmacen = #15#3;
     |SI #14#42 = "N";
          nUniCom = nUni0;
          nImpCom = nImpo;
     |SINO;
          nUniCom = -nUni0;
          nImpCom = -nImpo;
     |FINSI;
     |HAZ AcumArt;
     |HAZ AcumAlm;

     |HAZ ValoraStock;
     |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
     |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|DEFBUCLE albacom;
     #14#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL, NULL, linalbcom;
|FIN;
||============================= LECTURA DEL HISTORICO ====================
|PROCESO mirahist;
     |DDEFECTO #53;
     #53#0 = #17#0;
     |LEE 000#53=;

     |SI #17#2 = "ES"; |O #17#2 = "EV"; |O #17#2 = "SS";
               |O #17#2 = "ME"; |O #17#2 = "MS";
          |DDEFECTO #54;
          #54#0 = #17#0;
          #54#1 = #17#5;
          |LEE 101#54=;
          |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#54b; |FINSI;
          nHayAlma = FSalida;
          |SI #53#194 = 2; nUni0 = #17#17; |SINO; nUni0 = #17#6; |FINSI;
          |SI #17#2 = "SS"; |O #17#2 = "MS";
               nUniSal = -nUni0;
          |SINO;
               nUniSal = nUni0;
          |FINSI;
          fFecha = #17#1;
          aArticulo = #17#0;
          nAlmacen = #17#5;
          |HAZ AcumAlm;
          |HAZ ValoraStock;
          |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
          |LIBERA #54;
     |FINSI;
     |SI #17#2="EV";        || *(1)
          |SI #53#196 = 2; nUni0 = #17#17; |SINO; nUni0 = #17#6; |FINSI;
          |DDEFECTO #53;
          #53#0 = #17#0;      || codigo de articulo
          |LEE 101#53=;
          |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#53b; |FINSI;
          nHayArti = FSalida;

          fFecha = #17#1;
          aArticulo = #17#0;
          nAlmacen = #17#5;
          nUniCom = nUni0;
          nImpCom = nUni0 * #17#14
          |HAZ AcumArt;

          |HAZ ValoraStock;
          |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
          |LIBERA #53;
          |DDEFECTO #52;
          #52#0 = #17#10;
          |LEE 000#52=;
          |SI FSalida ! 0; |GRABA 020#52n; |FINSI;
          fFecha = #17#1;
          aProve = #17#10;
          nImpPrvCom = nUni0 * #17#9;
          |HAZ AcumPrv;
     |FINSI;
|FPRC;

|DEFBUCLE historico;
     #17#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL , mirahist;
|FIN;

|| -------------------------------------------------------------------------
|PROCESO fabricacion;
     canti   = #18#4 - #18#5;
     |SI canti [ 0; |ACABA; |FINSI;  || si ya esta servido sale

     scanti  = canti;
     articul = #18#2;
     almacen = #18#7;

     #53#0 = articul;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#5 = "S";
         |DDEFECTO #53;
         #53#0 = articul;
         |GRABA 020#53b;
     |FINSI;
     nHayArti = FSalida;

     #54#0 = articul;
     #54#1 = almacen;
     |LEE 101#54=;
     |SI FSalida ! 0; |Y #0#5 = "S";
         |DDEFECTO #54;
         #54#0 = articul;
         #54#1 = almacen;
         |GRABA 020#54b;
     |FINSI;
     nHayAlma = FSalida;
/*
     #53#13 = #53#13  + canti; || En Fabricacion
     #54#9 = #54#9 + canti;
*/
     |HAZ ValoraStock;
     |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
     |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
     |LIBERA #54;
     |LIBERA #53;

     swopera = 3;
     |HAZ escandallos;
|FPRC;

|PROCESO fabric_a;
     #53#0 = articul;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#5 = "S";
         |DDEFECTO #53;
         #53#0 = articul;
         |GRABA 020#53b;
     |FINSI;
     nHayArti = FSalida;
     #54#0 = articul;
     #54#1 = almacen;
     |LEE 101#54=;
     |SI FSalida ! 0; |Y #0#5 = "S";
         |DDEFECTO #54;
         #54#0 = articul;
         #54#1 = almacen;
         |GRABA 020#54b;
     |FINSI;
     nHayAlma = FSalida;
/*
     #53#12  = #53#12  + canti; || En Reservado
     #53#104 = #53#104 - canti; || Stock Disponible
     #54#8  = #54#8 + canti;  || Reservados
     #54#39 = #54#39 - canti; || Stock Disponible
*/
     |HAZ ValoraStock;
     |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
     |SI nHayAlma =  0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|DEFBUCLE fabricacion;
     #19#1;
     10;
     "      ", 000000, "N";
     "zzzzzz", 999999, "N";
     e;
     NULL, NULL, fabricacion;
|FIN;
--------------------------------------------------------------------------
|PROCESO agifa502;
     #53#0 = #58#2;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#53b; |FINSI;
     nHayArti = FSalida;
     #54#0 = #58#2;
     #54#1 = #58#3;
     |LEE 101#54=;
     |SI FSalida ! 0; |Y #0#5 = "S"; |GRABA 020#54b; |FINSI;
     nHayAlma = FSalida;
     aArticulo = #58#2;
     nAlmacen = #58#3;
     |SI #57#35 = "T";
          |SI #53#194 = 2; nUni0 = #58#29; |SINO; nUni0 = #58#5; |FINSI;
          nImpo = ((((nUni0 * #58#10) < #58#14) < #57#17) < #57#19);
          |SI #42#115 = "S";
               nImpo = nImpo < #57#18;
          |FINSI;
          nUniVta = nUni0;
          nImpVta = nImpo
          nImpMar = nMargen;
          nUniSal = nUni0;
          |HAZ AcumArt;
          |HAZ AcumAlm;
     |FINSI;
     |HAZ ValoraStock;
     |SI nHayArti =  0; |GRABA 020#53a; |FINSI;
     |SI nHayArti =  0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|DEFBUCLE agifa502;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, agifa502;
|FIN;

|PROCESO agifa501;
     #50#0 = #57#1;
     |LEE 101#50=;
     |SI FSalida ! 0;|Y enAltaCliente = 0;
          |GRABA 020#50b;
     |FINSI;

     fFecha = #57#14;
     aCliente = #57#1;

     |SI #57#35 = "T";
          |SI #57#3 > 0; beta = 1; |SINO; beta = -1; |FINSI;
          #57#3 = #57#3 * beta;
          nDto = (((#57#3 < #57#17) < #57#19) < #57#18) * beta;
          #57#3 = #57#3 * beta;
          nDto = #57#3 - nDto;   || Total Dto Cabecera
          ||...............................................
          imneto = #57#3 - nDto;
          |SI #42#115 = "N";
               nImpo = (imneto * 100) / (100 - #57#18);
               nDto = nDto + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
          |FINSI;

          #50#110 = #50#110 + imneto;
          |GRABA 000#50a;

          nImpCliCom = nImpo;
          nImpCliDto = nDto;
          nImpCliMar = #57#8;
          |HAZ AcumCli;
     |FINSI;
     |LIBERA #50;

     |BUCLE agifa502;
|FPRC;

|DEFBUCLE agifa501;
     #57#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, agifa501;
|FIN;

|PROCESO inicio; |TIPO 3;
     |SI #0#0 ! "SI"; |ACABA; |FINSI;

     |ABRE #42; |LEE 000#42p; |CIERRA #42;

     fabSN  = #42#12;   || Kit o fabricacion
     nAno = #0#1;

     |MENSA "0000Borrando Clientes";
     |BUCLE clientes;
     |BUCLE dsm00125;

     |MENSA "0000Borrando Representantes";
     |BUCLE comision;
     |BUCLE dsm00127;

     |MENSA "0000Borrando Proveedores";
     |BUCLE proveedor;
     |BUCLE dsm00126;

     |MENSA "0000Borrando Articulos";
     |ABRE #238;
     |BUCLE articulo;
     |CIERRA #238;
     |BUCLE dsm00128;

     |MENSA "0000Borrando Almacenes";
/*
     |BUCLE almacen;
*/
     |BUCLE dsm00129;

     |ABRE #125;
     |ABRE #126;
     |ABRE #127;
     |ABRE #128;
     |ABRE #129;
     |ABRE #50;               ||Fichero de Clientes
     |ABRE #51;               ||Fichero de Comisionistas
     |ABRE #53;               ||Fichero de Articulos
     |ABRE #52;               ||Fichero de Proveedores
     |ABRE #54;               ||Fichero de Almacenes
     |MENSA "0000Calculando Pedidos Venta";
     |BUCLE pedi;             ||Bucle de pedidos
     |MENSA "0000Calculando Depositos";
     |BUCLE depo;             ||Bucle de Depositos
     |MENSA "0000Calculando Albaranes Venta";
     |BUCLE alba;             ||Bucle de albaranes
     |MENSA "0000Calculando Facturas Venta";
     |BUCLE factura;          ||Bucle de facturas

     |MENSA "0000Calculando Facturas Directas";
     |BUCLE contado;          ||Bucle de Facturas Contado
     |MENSA "0000Calculando Tickets TPV";
     |BUCLE agifa501;

     |MENSA "0000Calculando Pedidos Compra";
     |BUCLE pedicom;          ||Bucle de Pedidos Compras
     |MENSA "0000Calculando Albaranes Compra";


     |BUCLE albacom;          ||Bucle de albaranes Compras

     |SI fabSN = "N";
         |MENSA "0000Calculando Ordenes";
         |BUCLE fabricacion;
     |FINSI;

     |MENSA "0000Calculando Historico";
     |BUCLE historico;        ||Bucle de lectura del historico
     |CIERRA #51;
     |CIERRA #50;
     |CIERRA #52;
     |CIERRA #53;
     |CIERRA #54;
     |CIERRA #125;
     |CIERRA #126;
     |CIERRA #127;
     |CIERRA #128;
     |CIERRA #129;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |HAZ EsMalpesa;
     |SI FSalida = 0;
          eaDarti = " " * 20;
          eaHarti = "z" * 20;
          |HAZ MalpeRecalStock;
     |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|FPRC;

|PROGRAMA;
     aParam = PARAMETRO; |QBF aParam;

     |HAZ EsAlbadis;
     nSwAlbadis = FSalida;

     |SI aParam ! "agifa655";
          |MANTE #0;
     |SINO;
          |DDEFECTO #0;
          #0#1 = #0#2 % 704;
          #0#0 = "SI";
          |HAZ inicio;
     |FINSI;
|FPRO;
