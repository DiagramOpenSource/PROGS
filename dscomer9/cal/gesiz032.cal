|FICHEROS;
     gesiz032 #0;
     dsm00003 #3;
     agifa010 #10;
     agifa019 #19;
     agifa024 #24;
     agifa069 #69;
     agifa071 #71;
     agifa084 #84;
     referen@;      ||Tmp clientes

     agifa071@;     ||Para buscar la linea promocion
     agifa069@;     ||Para buscar la linea promocion
|FIN;

|VARIABLES;
     &Tempo = "";
     &aDivisa = "";
     &aMoneda = "";
     &eaAlfa = "";
     nPanta = 0;
     nBtnPath = 0;
     aPath = "";
     fHoy = @;
     aAlfa = "";
     aDes = "";
     aOrg = "";
     aPathOrg = "";
     nHandle = 0;
     aFic = "";
     aNom = "";
     aLF = "";
     nNu1 = 0;
     nNu2 = 0;
     nAbo = 0;
     aTipo = "";
     nPos = 0;
     nLon = 0;
     aAlf1 = "";
     nDec = 0;
     nNume = 0;
     nImpo = 0;
     nTotal = 0;
     nTipo = 0;
     nLinea = 0;

     aParam = "";
     nCampo    = 0;
     aLon      = "";
     i         = 0;
     aLetra    = "";
     aReg      = "";
     aTab      = "";
     aDato     = "";
 {99}Valor     = "";

     fFecha = @;
     fFecha1 = @;
     aMes = "";
     aConcecionario = "";
     nSin = 0;
     nDto = 0;
     nFin = 0;
|FIN;

|PROCESO Relleno;
     |SI aTipo = "F";
          nPos = nLon;
          |SI aAlfa ! "";
               aAlfa = (aAlfa % -104) + (aAlfa % 402) + (aAlfa % 102);
          |FINSI;
          aAlf1 = " " * nPos;
          aAlfa = aAlfa + aAlf1;
          nPos = nPos + 100;
          aAlfa = aAlfa % nPos;
     |FINSI;

     |SI aTipo = "A";
          eaAlfa = aAlfa; |HAZ QuitaRarosExp; aAlfa = eaAlfa;
          aAlf1 = " " * nLon;
          aAlfa = aAlfa + aAlf1;
          nPos = nLon + 100;
          aAlfa = aAlfa % nPos;
          |SI nLon = 99; aAlfa = aAlfa + " "; |FINSI;

          |QBF aAlfa;
     |FINSI;

     |SI aTipo = "N";
          nNume = aAlfa;
          |SI nNume < 0; nAbo = -1; |SINO; nAbo = 1; |FINSI;
          |SI nNume < 0; nNume = nNume * - 1; |FINSI;
          nNu1 = nNume ! 0;
          |SI nNu1 > nNume; nNu1 = nNu1 - 1; |FINSI;
          nNu2 = nNume - nNu1;
          |SI nDec < 0;
               aAlfa = nNume;
          |SINO;
               |SI nDec = 0;
                    aAlfa = nNu1;
               |SINO;
                    aAlfa = nNu2;
                    aAlfa = aAlfa + "00000000000000000000000000";
                    nPos = nDec + 300;
                    aAlfa = aAlfa % nPos;

                    || CON PUNTO DECIMAL
                    aAlfa = nNu1 + "," + aAlfa;

                    || SIN PUNTO DECIMAL
                    ||aAlfa = nNu1 + aAlfa;
               |FINSI;
          |FINSI;
/*
          aAlfa = "000000000000000000000000000000000000000000000" + aAlfa;
          |SI nAbo = 1;
               nPos = -1 * (nLon + 100);
               aAlfa = aAlfa % nPos;
          |SINO;
               nPos = -1 * (nLon + 99);
               aAlfa = "-" + aAlfa % nPos;
          |FINSI;
*/
          nDec = 0;
     |FINSI;
     |SI nFin = 0;
          aAlfa = aAlfa + ";";
     |SINO;
          nFin = 0;
     |FINSI;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO Clientes;
     |DDEFECTO #3;
     #3#0 = #referen@#0;
     #3#1 = #referen@#1;
     |LEE 000#3=;

     |DDEFECTO #24;
     #24#0 = #referen@#0;
     |LEE 000#24=;

     || Concecionario A12
     aAlfa = #0#1;
     aTipo = "A"; nLon = 12; |HAZ Relleno;

     || C¢digo PDV  A12
     aAlfa = #3#0 + (("0000" + #3#1) % -104);
     aTipo = "A"; nLon = 12; |HAZ Relleno;

     || Nombre PDV A20
     aAlfa = #3#10;
     aTipo = "A"; nLon = 20; |HAZ Relleno;

     || Direcci¢n A100
     aAlfa = #3#2;
     aTipo = "A"; nLon = 99; |HAZ Relleno;

     || Poblaci¢n A50
     aAlfa = #3#3;
     aTipo = "A"; nLon = 50; |HAZ Relleno;

     || CP A5
     aAlfa = #3#6;
     aTipo = "A"; nLon = 5; |HAZ Relleno;

     || Raz¢n social A50
     aAlfa = #24#1;
     aTipo = "A"; nLon = 50; |HAZ Relleno;

     || NIF A15
     aAlfa = #24#15;
     aTipo = "A"; nLon = 15; |HAZ Relleno;

     || Dir  Raz¢n social A100
     aAlfa = #24#5;
     aTipo = "A"; nLon = 99; |HAZ Relleno;

     || Pobla  Raz¢n social A50
     aAlfa = #24#6;
     aTipo = "A"; nLon = 50; |HAZ Relleno;

     nFin = 1;
     || CP  Raz¢n social A5
     aAlfa = #24#180;
     aTipo = "A"; nLon = 5; |HAZ Relleno;

     |XGRABA nHandle, aLF;
|FPRC;

|DEFBUCLE Clientes;
     #referen@#1002;
     ;
     "      ", 0001;
     "zzzzzz", 9999;
     ;
     NULL, Clientes;
|FIN;

|PROCESO LinAlbaran;
     |SI #71#63 < 0;
          |ACABA;
     |FINSI;

     || Fecha estadística AAAAMM  A6
     aAlfa = (#10#1 % 704) + (#10#1 % 402);
     aTipo = "A"; nLon = 6; |HAZ Relleno;

     || Fecha albarán AAAAMMDD  A8
     aAlfa = (#10#1 % 704) + (#10#1 % 402) + (#10#1 % 102);
     aTipo = "A"; nLon = 8; |HAZ Relleno;

     || Número albarán A20
     aAlfa = #10#52; |QBF aAlfa;
     aAlfa = aAlfa + ("000000" + #10#0) % -106;
     aTipo = "A"; nLon = 20; |HAZ Relleno;

     || Concecionario A12
     aAlfa = #0#1;
     aTipo = "A"; nLon = 12; |HAZ Relleno;

     || Código PDV A12
     aAlfa = #10#3 + (("0000" + #10#84) % -104);
     aTipo = "A"; nLon = 12; |HAZ Relleno;

     || Articulo A8
     aAlfa = #19#134;
     aTipo = "A"; nLon = 8; |HAZ Relleno;

     || Uni entregadas N15
     nNume = #71#5 + #71#66;
     aAlfa = nNume;
     aTipo = "N"; nLon = 15; |HAZ Relleno;

     || Uni sin cargo N15
     |SI #71#6 = 0; |O #71#8 = 100;
          nSin = #71#5;
          nDto = 0;
     |SINO;
          nSin = #71#66;
          nDto = #71#64 * #71#5;
          |SI #71#7 ! #71#9;
               nDto = nDto + #71#7 - #71#9;
          |FINSI;
     |FINSI;
     aAlfa = nSin;
     aTipo = "N"; nLon = 15; |HAZ Relleno;

     || Importe Uni sin  cargi N15,3
     nSin = nSin * #71#6;
     aAlfa = nSin;
     aTipo = "N"; nLon = 19; nDec = 3; |HAZ Relleno;

     || Importe Dto N15,3
     aAlfa = nDto;
     aTipo = "N"; nLon = 19; nDec = 3; |HAZ Relleno;

     nFin = 1;
     || Total N15,3
     nNume = nSin + nDto;
     aAlfa = nNume;
     aTipo = "N"; nLon = 19; nDec = 3; |HAZ Relleno;

     |XGRABA nHandle, aLF;
|FPRC;

|PROCESO Albaranes;
     |SI #71#13 ] #0#5; |Y #71#13 [ #0#6; |Y #71#5 ! 0;
          #referen@#0 = #10#3;
          #referen@#1 = #10#84;
          |LEE 000#referen@.=;
          |SI FSalida ! 0;
               |GRABA 020#referen@.n;
          |FINSI;

          #19#0 = #71#2;
          |LEE 000#19=;
          |SI FSalida ! 0; |DDEFECTO #19; |FINSI;

          |HAZ LinAlbaran;
     |FINSI;
|FPRC;

|PROCESO CabAlb;
     #24#0 = #10#3;
     |LEE 000#24=;
     |SI FSalida ! 0; |DDEFECTO #24; |FINSI;

     aDivisa = #10#68;
     aMoneda = #10#70;
     |HAZ Divisas010;
|FPRC;

|DEFBUCLE Albaranes;
     #10#7;
     ;
     #0#3, "     ", 000001;
     #0#4, "zzzzz", 999999;
     ;
     NULL, CabAlb, Albaranes;
|FIN;

|PROCESO LinFactura;
     |SI #69#45 < 0;
          |ACABA;
     |FINSI;

     || Fecha estadística AAAAMM  A6
     aAlfa = (#84#1 % 704) + (#84#1 % 402);
     aTipo = "A"; nLon = 6; |HAZ Relleno;

     || Fecha albarán AAAAMMDD  A8
     aAlfa = (#84#1 % 704) + (#84#1 % 402) + (#84#1 % 102);
     aTipo = "A"; nLon = 8; |HAZ Relleno;

     || Número albarán A20
     aAlfa = #84#48; |QBF aAlfa;
     aAlfa = aAlfa + ("000000" + #84#0) % -106;
     aTipo = "A"; nLon = 20; |HAZ Relleno;

     || Concecionario A12
     aAlfa = #0#1;
     aTipo = "A"; nLon = 12; |HAZ Relleno;

     || Código PDV A12
     aAlfa = #84#3 + (("0000" + #84#91) % -104);
     aTipo = "A"; nLon = 12; |HAZ Relleno;

     || Articulo A8
     aAlfa = #19#134;
     aTipo = "A"; nLon = 8; |HAZ Relleno;

     || Uni entregadas N15
     nNume = #69#5 + #69#48;
     aAlfa = nNume;
     aTipo = "N"; nLon = 15; |HAZ Relleno;

     || Uni sin cargo N15
     |SI #69#6 = 0; |O #69#8 = 100;
          nSin = #69#5;
          nDto = 0;
     |SINO;
          nSin = #69#48;
          nDto = #69#46 * #69#5;
          |SI #69#7 ! #69#9;
               nDto = nDto + #69#7 - #69#9;
          |FINSI;
     |FINSI;
     aAlfa = nSin;
     aTipo = "N"; nLon = 15; |HAZ Relleno;

     || Importe Uni sin  cargi N15,3
     nSin = nSin * #69#6;
     aAlfa = nSin;
     aTipo = "N"; nLon = 19; nDec = 3; |HAZ Relleno;

     || Importe Dto N15,3
     aAlfa = nDto
     aTipo = "N"; nLon = 19; nDec = 3; |HAZ Relleno;

     nFin = 1;
     || Total N15,3
     nNume = nSin + nDto;
     aAlfa = nNume;
     aTipo = "N"; nLon = 19; nDec = 3; |HAZ Relleno;

     |XGRABA nHandle, aLF;
|FPRC;

|PROCESO Facturas;
     |SI #69#13 ] #0#5; |Y #69#13 [ #0#6; |Y #69#5 ! 0;
          #referen@#0 = #84#3;
          #referen@#1 = #84#91;
          |LEE 000#referen@.=;
          |SI FSalida ! 0;
               |GRABA 020#referen@.n;
          |FINSI;

          #19#0 = #69#2;
          |LEE 000#19=;
          |SI FSalida ! 0; |DDEFECTO #19; |FINSI;


          |HAZ LinFactura;
     |FINSI;
|FPRC;

|PROCESO CabFac;
     #24#0 = #84#3;
     |LEE 000#24=;
     |SI FSalida ! 0; |DDEFECTO #24; |FINSI;

     aDivisa = #84#65;
     aMoneda = #84#67;
     |HAZ Divisas084;
|FPRC;

|DEFBUCLE Facturas;
     #84#1;
     1;
     "     ", 000001, #0#3;
     "zzzzz", 999999, #0#4;
     ;
     NULL, CabFac, Facturas;
|FIN;

|PROCESO Copia;
     aPath = #0#2; |QBF aPath;
     aAlfa = aPath % -101;
     |SI aAlfa ! "/"; |Y aAlfa ! "\";
          aPath = aPath + "/";
     |FINSI;

     aDes = aPath + aFic;
     |ENVIA_FICHERO aOrg, aDes;
     |SI FSalida ! 0;
          |MENAV "0000Error al copiar al puesto...";
     |FINSI;
|FPRC;

|PROCESO Concecionario;
     aConcecionario = "";
     aAlfa = #0#1; |QBF aAlfa;
     aLon = aAlfa % A0;
     |PARA i = 0; |SI i [ 4; |HACIENDO i = i + 1;
          nPos = aLon;
          nPos = nPos - i;
          nPos = nPos * 100 + 1;
          aLetra = aAlfa % nPos;
         aConcecionario = aLetra + aConcecionario;
     |SIGUE;
|FPRC;

|PROCESO T3; |TIPO 3;
     fHoy = ~;
     |HAZ Concecionario;

     |DDEF aPath;
     aAlfa = aPath + "dsm00003";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          aAlfa = aPath + "agifa071";
          |CARGA_DEF aAlfa, agifa071@;
          |SI FSalida = 0;
               aAlfa = aPath + "agifa069";
               |CARGA_DEF aAlfa, agifa069@;
               |SI FSalida = 0;
                    |ABRE #agifa071@;
                    |ABRE #agifa069@;

                    |HAZ CreaTempo; |NOME_DAT #referen@#Tempo#;
                    |DELINDEX #referen@;
                    |ABRE #referen@;

                    |DFICE aPathOrg;

                    aFic = aConcecionario  + (fHoy % 402) + "A.csv";

                    aOrg = aPathOrg + aFic;
                    |XABRE "WB", aOrg, nHandle;
                    |SI FSalida ] 0;
                         |ABRE #19;
                         |ABRE #24;
                         |BUCLE Albaranes;
                         |BUCLE Facturas;
                         |CIERRA #24;
                         |CIERRA #19;
                         |XCIERRA nHandle;
                         |HAZ Copia;
                    |FINSI;


                    aFic = aConcecionario  + (fHoy % 402) + "C.csv";

                    aOrg = aPathOrg + aFic;
                    |XABRE "WB", aOrg, nHandle;
                    |SI FSalida ] 0;
                         |ABRE #3;
                         |ABRE #24;
                         |BUCLE Clientes;
                         |CIERRA #24;
                         |CIERRA #3;
                         |XCIERRA nHandle;
                         |HAZ Copia;
                    |FINSI;

                    |CIERRA #agifa069@;
                    |CIERRA #agifa071@;

                    |DESCARGA_DEF #agifa069@;
               |FINSI;
               |DESCARGA_DEF #agifa071@;
          |FINSI;
          |CIERRA #referen@;
          |DELINDEX #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO BtnPath;
     aPath = "D*.*";
     |BROWSE aPath;
     aPath = aPath % 2; |QBF aPath;
     |SI aPath ! "D";
          #0#2 = aPath; |PINTA #0#2;
     |FINSI;
|FPRC;

|PROCESO Dato;
     aTab = ";"
     nCampo = 1;
     IValor = Valor1<-;
     aLon = aDato % A0;
     aReg = "";
     |PARA i = 1; |SI i [ aLon; |HACIENDO i = i + 1;
          nPos = i * 100 + 1;
          aLetra = aDato % nPos;
          |SI aLetra = aTab;
               Valor = aReg;
               aReg = "";
               nCampo = nCampo + 1;
               IValor = IValor + 1;
          |SINO;
               aReg = aReg + aLetra;
          |FINSI;
          |SI nCampo > 90; |SAL; |FINSI;     || Por si.... :)
     |SIGUE;
     Valor = aReg;
|FPRC;

|PROCESO DFecha;
     fFecha = ~;
     fFecha1 = fFecha % A0;
     aMes = fFecha1 % 1104;
     nNume = fFecha;
     |PARA; |SI; |HACIENDO;
          nNume = nNume - 1;
          fFecha = nNume;
          fFecha1 = fFecha % A0;
          aAlfa = fFecha1 % 1104;
          |SI aAlfa ! aMes; |SAL; |FINSI;
     |SIGUE;
     aAlfa = fFecha;
     aAlfa = "01" + aAlfa % 308;
     fFecha = aAlfa;
|FPRC;

|PROGRAMA;
     aParam = PARAMETRO;

     |HAZ DecimalesBase;
     aLF = &13; aLF = aLF + &10;
     |SI aParam ! "";
          |ABRE #0; |LEE 000#0p; |CIERRA #0;
          |HAZ DFecha;
          #0#3 = fFecha;
          #0#4 = ~;

          aDato = aParam;
          |HAZ Dato;
          #0#5 = Valor1;
          #0#6 = Valor2;
          |HAZ T3;
     |SINO;
          |ABRE #0;
          |LEE 101#0p;
          |SI FSalida ! 0; |GRABA 020#0b; |FINSI;

          |HAZ DFecha;
          #0#3 = fFecha;
          #0#4 = ~;
          |PINPA #0#0; nPanta = FSalida;
          |PINDA #0#0;

          |CONTROL_SIMPLE nPanta, "BOTON,{{136}}...", 1117, 1121, BtnPath;
          nBtnPath = FSalida;

          |ENDATOS #1#0;
          |SI FSalida = 0; |GRABA 020#0a; |FINSI;
          |CIERRA #0;

          |FIN_CONTROL_WINDOWS nBtnPath;
     |FINSI;
|FPRO;
