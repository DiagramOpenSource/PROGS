|FICHEROS;
     con00611 #0;  || Lineas de albaran
     con00610 #1;
     agifa019 #2;  || Articulos
     agifa039 #5;
     agifa024 #6;
     agifa017 #8;
     agifa065 #9;

     agifa048 #13;
     agifa049 #14;

     agifa142 #20;       || Parametros Generales
     agifa007 #21;       || Series
     capsion  #22;
     agifa290 #25;       || Promociones Articulos;
     agifa291 #26;       || Pantalla Promociones;
     agifa321 #35;       || DIV - Parametros
     dsl00001 #36;       || Codigos de barras multiples
     agi00100 #90;       || Lotes.
     agi00101 #91;       || Historico Lotes.
     con00701 #50;
     dsm00005 #905;
     dsm00010 #910;
     con00004 #4,MANTE;
     con00009 #109;
     con00002 #200
     con00612 #612;
     con00683 #683;
     con00625 #625;
     con00626 #626;
     conp0626 #1626;
     referen@;
|FIN;

|VARIABLES;
     &eaAlbTaller = "";
     nLin = 0;
     &enModoCab10 = 0;
     nTallerBorLin = 0;
     &Tempo = "";
     aTmp22 = "";
     nCamp1        = 0;
     nCamp2        = 0;
     &enDescuento1 = 0;
     &enDescuento2 = 0;
     &eaTComision  = "";
     &enComision   = 0;

     &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_Div      = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDiv   = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVis   = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVis = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVis   = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVis   = 0;   || Decimales en el Importe visual. (lineas)
     &ac_divisa = ""; ||
     &pintado   = 0;|| Controla el pintado de mensa para que solo lo haga 1 vez
     &Envase    = "";
     &Unidades1 = 0;
     &Unidades2 = 0;
     &VArticulo = "";
     prevul     = 0;
     precom     = 0;
     prepcm     = 0;
     &programa      = "";
     &sserie        = "";
     &nnumer        = 0;
     &ffecha        = @;
     &cclien        = "";
     &nnombr        = "";
     &consulta      = "";
     &ccoste        = 0;
     &arti          = "";
     &unid          = 0;
     &desc          = "";
     &ext1          = "";     || Para < F5 >
     &c_clien       = "";
     &c_artic       = "";
     &c_serie       = "";
     &entrada       = 0;
     &r_arti        = "";
     &serfot        = "";
     &numfot        = 0;
     &linfot        = 0;
     &clifot        = "";
     &artfot        = "";
     &aRecoge = "N";
     &aModalidad    = "V";  || Ventas
     &aCliPro  = "";
     &aProceso = "con00611";

     &n_dec = 0;
     &uni_dt = 0;   || Unidades
     &fed_dt = @;   || Fecha....
     &art_dt = "";  || Articulo.
     &cli_dt = "";  || Cliente..
     &fam_dt = "";  || Familia.
     &iva_dt = 0;   || Tipo Iva.
     &dtos_2 = 0;   || Descuento 2.
     &dto_pt = 0;   || Descuento Ptas.
     &dtos_1 = 0;   || Descuento 1.
     &pvp_ve = 0;   || Precio Venta.
     &tarifa = 0;   || Tarifa Cliente.
     &quedto = 0;   || 1=cli./art, 2=cli./familia, 3=cli./subfam.
     &gru_dt = "";  || Grupo Cliente.
      verpre = "";
     &enMensaje = 0;
     &aParam    = "";

     aAlfa     = "";
     nPrecio    = 0;
     nForma     = 0;
     nNume      = 0;

     tecla      = "";
     mensa      = ""; || Linea de visualizacion

     titdiv = "";   || Encabezado de precio e imp. con la divisa "Imp.Tot(USD)"
     vcontrol = "";
     salidavic = 0;
     Unidades       = 0;
     sw_escan       = 0;
     mod            = 0;
     nlote          = "";
     tu             = 0;
     ind            = 0;
     {100}M         = "";
     {100}C         = "";
     hn             = 0;
     hn1            = 0;
     nn             = 0;
     nn1            = 0;
     hi             = 0;
     j              = 0;
     longi          = 0;
     halfa          = "";
     letra          = "";
     pos            = 0;
     resto          = 0;
     inc            = 0;
     numero         = 0;
     lotes          = "";
     lineaa         = 0;
     codiBarra      = "";
     i              = 0;
     ccomi          = 0;
     repr           = "";
     clie           = "";
     fami           = "";
     lin            = 0;
     path           = "";
     art            = "";
     varalfa        = "";
     fs             = 0;
     f1             = 0;
     jj             = 0;
     aux            = "";
     mensaje10      = "2400SPrepare el PSION !! Correcto (S/N): ";
     avisa_st       = "S";    || Avisa si hay stock
     kit            = "";     || Trabaja con kit
     recoge         = "N";    || Recoger Albaranes
     def_exp        = "N";    || Exportacion
     DescAmpli      = "N";    || Descarga descripcion ampliada de articulos          = 0;      || Decimales en unidades
     def_alm        = 0;      || Almacen Defecto
     aprograma      = "";
     fiac           = "  ";
     guarda         = "  ";
     relleno        = "                                       ";
     aponer         = "  ";
     vacio          = "                    ";
     operacion      = "  ";
     operainte      = "  ";
     articulo       = " ";
     mescli         = " ";
     mensaje3       = "";
     mensaje4       = "0000 Supera el Stock disponible";
     mensaje5       = "0000 Albaran para Exportacion. Tipo IVA = 0 !!!";
     serie          = "";
     albaran        = 0;
     albaran_o      = 0;
     serie_o        = "";
     alfa1          = "";
     alfa2          = "";
     descu          = 0;
     tf             = 0;
     pc             = 0;
     pcs            = 0;
     pcv            = 0;
     pcd            = 0;
     comi1          = 0;
     comi2          = 0;
     comi3          = 0;
     menor          = 0;
     pc1            = 0;
     pa             = 0;
     pa1            = 0;
     pa2            = 0;
     imneto         = 0;
     asto           = 0;
     margen         = 0;
     wimneto        = 0;
     wmargen        = 0;
     a              = 0;
     b              = 0;
     modo           = 0;  || La necesito en solis008
     cantidad       = 0;
     kl             = 0;
     totbu          = 0;
     flag           = 0;
     primera        = 0;
     swescan        = 0;
     sal_campo      = 0;
     sw_promocio    = 0;
     nlinea         = 0;
     linea_o        = 0;
     LineaD         = 0; || Linea destino
     campo          = 0;
     nerror         = 0;
     atmp           = 0;
     trabajo        = "";
     salida         = "";
     n_almacen      = 0;
     n_stock        = 0;
     n_operac       = "";
     tengo_dto = "";
     tengo_dto1 = 0;
|FIN;

|INCLUYE i_varart;

|PROCESO pivaalb;
     salida = FSalida;
     |SI salida = 12;
          |SI Campo = 6; |O Campo = 36;
               |C_V #0#9, 0, aAlfa;
               |SI aAlfa = "S";
                    nCamp1 = 9; nCamp2 = 6;
                    |C_M #0#9, 1, "S"; |ENCAMPO #9#0; |C_M #0#9, 1, "N";
               |FINSI;
               |C_V #0#37,0, aAlfa;
               |SI aAlfa = "S";
                    nCamp1 = 37; nCamp2 = 36;
                    |C_M #0#37, 1, "S"; |ENCAMPO #37#0; |C_M #0#37, 1, "N";
               |FINSI;
               |SI FSalida = 0;
                    #0nCamp2 = #0nCamp1 / #0#5;
               |SINO;
                    |AVISO; |ERROR;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI salida = 14;
         c_clien = #1#3;
         c_artic = #0#2;
         c_serie = #1#52;
         entrada = 1;
         |SUB_EJECUTA_NP "agifa283.run";
         |ERROR;
         salida = 0;
     |FINSI;

     |SI salida = 15;
          enTiva = #0#11;
          efFiva = #1#1;
          |HAZ SacaIVA;
          #0#6 = #0#6 / (1 + enIva/100);
          |HAZ visual_precio;
          salida = 0;
     |FINSI;
|FPRC;

|PROCESO LeeParam071;
     |ABRE #20;
     #20#0 = "A";
     |LEE 001#20=;
     |SI FSalida ! 0; |DDEFECTO #20; |FINSI;
     lotes = #20#51;
     |CIERRA #20;
     avisa_st = #20#5;
     kit  = #20#12;
     recoge = #20#27;
     DescAmpli = #20#40;     || Descargar descripcion ampliada
     codiBarra = #20#55;     || Lectura Cod. Barra
     verpre = #20#101;       || Para ver PC,PMC,PUV.
     |ABRE #21;
     #21#26 = #1#52;
     |LEE 001#21=;
     |SI FSalida ! 0; |DDEFECTO #21; |FINSI;
     |CIERRA #21;
     def_alm = #21#29;
     def_exp = #21#30;
|FPRC;

|PROCESO Tipo7_071; |TIPO 7;
     modo = (FEntrada / 100) ! 0;
     |HAZ LeeParam071;
|FPRC;

|PROCESO mirespor;|TIPO 0;
     |SI #6#28 = "S"; |Y #0#11 ! 0;
          |MENAV mensaje5; #0#11 = 0; |PINTA #0#11;
     |SINO;
          |SI #0#11 ! 0; |Y def_exp = "S";
               |MENSA mensaje5; #0#11 = 0; |PINTA #0#11;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO liinfo;|TIPO 0;
     |SI #8#39 < 0; |Y #1#43 = AN; |Y avisa_st = "S";
          |AVISO;
     |FINSI;
     |SI verpre ! "S";
        mensaje3 = "0410Stock Disponible Almacen : " + #8#39+"     Stock Minimo : "+#8#6;
        |MENSA mensaje3;
     |SINO;
        |HAZ verpre2;
        precom = #2#133 / #1#74 * #1#69;  || Calculo el importe en divisas
        prepcm = #2#9 / #1#74 * #1#69;    || Calculo el importe en divisas
        |SI #1#70 = "D";                     || Si la moneda de trabajo es la divisa ...
              precom = precom ! nDeci_PreDiv;
              prepcm = prepcm ! nDeci_PreDiv;
        |SINO;                               || Si la moneda de trabajo es la moneda base ...
              precom = precom ! nDeci_PreBase;
              prepcm = prepcm ! nDeci_PreBase;
        |FINSI;
        mensaje3 = "0401Disponible.: [" + #8#39 + "] Min.: [" + #8#6 + "] PC.: [" + precom + "] PMC.: [" +prepcm+"] PVU.: [" + prevul+"]";
        mensaje3 = mensaje3 % 180;
        |MENSA mensaje3;
     |FINSI;
|FPRC;

|PROCESO liinfo1;|TIPO 0;
     |SI #8#39 < #0#5; |Y #1#43 = AN; |Y avisa_st = "S";
          |MENAV mensaje4;
     |FINSI;
     mensaje3 = "0410Stock Disponible Almacen : " + #8#39+"     Stock Minimo : "+#8#6;
     |MENSA mensaje3;
|FPRC;

|PROCESO licogea;|TIPO 0;
      articulo = #0#2;
|FPRC;

|PROCESO PrecioArti;
     modo = (FEntrada / 100) ! 0;
     |SI modo = 1; |O articulo ! #0#2;
          articulo = #0#2;
          fed_dt = #1#1;   || Fecha....
          art_dt = #0#2;   || Articulo.
          cli_dt = #0#15;  || Cliente..
          fam_dt = #0#13;  || Familia.
          iva_dt = #2#30;  || Tipo Iva.
          dtos_2 = 0;      || Descuento 2.
          dto_pt = 0;      || Descuento Ptas.
          dtos_1 = 0;      || Descuento 1.
          pvp_ve = 0;      || Precio Venta.
          tarifa = #6#39;  || Tarifa Cliente....
          gru_dt = #6#158; || Grupo Cliente.
          uni_dt = #0#5;
          enMensaje = 0;
          aParam    = "";

          |SI #2#176 = "S";  enMensaje = 1;  |FINSI;

          |ABRE #50;
          #50#0 = #2#126;
          #50#1 = #6#163;
          |LEE 000#50=;
          |SI FSalida = 0;
              tengo_dto = "S";
              tengo_dto1 = #50#2;
          |FINSI;
          enDirEnt = #1#84;
          |HAZ calcdtos;              || Calculo Dtos.....
          |LIBERA #50;  |CIERRA #50;
          #0#6   = pvp_ve - dto_pt;   || Precio Venta. sin iva.
          #0#8   = dtos_1;            || 1¦ Dto.
          #0#33  = dtos_2;            || 2§ Dto.
          |HAZ precio_divisa;  ||Convierte el precio en divisa
          |PINTA #0#33;
          |PINTA #0#8;

          |SI tengo_dto = "S";
              #0#8 = tengo_dto1;
          |FINSI;

         enDescuento1 = #0#8;
         enDescuento2 = #0#33;
         eaTComision  = #0#16;
         eaCliente    = #1#3;
         eaArticulo   = #0#2;
         eaRepre      = #1#6;
         enDirEnt = #1#84;
         |HAZ Comisiones;
         #0#10 = enComision;
         |PINTA #0#10;
     |FINSI;
|FPRC;

|PROCESO defecli;|TIPO 0;
     #0#15 = #1#3;
     #0#16 = #1#34;
     #0#17 = #1#35;
     |SI #0#2 ! #2#0;
          |ABRE #2;
          #2#0 = #0#2;
          |LEE 100#2=;
          |CIERRA #2;

          |ABRE #8;
          #8#0 = #0#2;
          #8#1 = #0#3;
          |LEE 100#8=;
          |CIERRA #8;
     |FINSI;
     #0#13 = #2#2;
     |SI #0#15 ! #6#0;
          |ABRE #6;
          #6#0 = #0#15;
          |LEE 100#6=;
          |CIERRA #6;
     |FINSI;
     |HAZ mirespor;
     |HAZ PrecioArti;
|FPRC;

|PROCESO licomis;|TIPO 0;
     |SI #0Campo ! Contenido;
         enDescuento1 = #0#8;
         enDescuento2 = #0#33;
         eaTComision  = #0#16;
         eaCliente    = #1#3;
         eaArticulo   = #0#2;
         eaRepre      = #1#6;
         enDirEnt = #1#84;
         |HAZ Comisiones;
         #0#10 = enComision;
         |PINTA #0#10;
     |FINSI;
|FPRC;

|PROCESO unidad; |TIPO 0;
     #0#5 = #0#5 ! n_dec;
     |PINTA #0#5;
|FPRC;

|PROCESO totli;|TIPO 0;
     |SI FSalida = 1;
          sal_campo = 1;
     |SINO;
          sal_campo = 0;
     |FINSI;
     #0#7 = #0#5 * #0#6;
     |SI #0#7 > 0;
          nerror = 1;    ||Se utiliza esta variable, porque no afecta a calculo
     |SINO;
          nerror = -1;
          #0#7 = -#0#7;
     |FINSI;
     #0#9 = (((#0#7 < #0#8) < #0#33)) * nerror;
     #0#7 = #0#7 * nerror;
     |HAZ visual_importe;
|FPRC;

|PROCESO BorraSec;
     |ABRE #4;
     #4#0 = #0#29;
     #4#1 = #0#0;
     #4#2 = #0#1;
     |BORRA 000#4c;
     |CIERRA #4;
|FPRC;

|PROCESO PintaSec;
     |ABRE #200;
     #200#0 = #4#3;
     |LEE 000#200=;
     |CIERRA #200;
     |PINTA 1729, #200#1;
|FPRC;

|PROCESO PideSec;
     |PUSHV 0501 2380;
     |ABRE #4;
     #4#0 = #0#29;
     #4#1 = #0#0;
     #4#2 = #0#1;
     #4#3 = #612#7;
     |LEE 101#4=;
     |SI FSalida ! 0; |GRABA 020#4b; |FINSI;
     |BLANCO 14211961;
     |PINPA #0#4;
     |PINDA #0#4;
     |HAZ PintaSec;
     |ENCAMPO #3#4;
     |HAZ PintaSec;
     |GRABA 020#4a;
     |CIERRA #4;
     |POPV;
|FPRC;

|PROCESO liacarti; |TIPO 2;
     || *(2)
     nForma = 0 +. 1;
     modo = (FEntrada / 100) ! 0;

     |SI #0#63 = -1; |Y enModoCab10 ! 3;
          |SI nForma = -1;
               |MENAV "0000Linea canon de articulo, no se puede modificar";
          |FINSI;
          |ERROR; |ACABA;
     |FINSI;

     |SI modo = 2;|O modo = 3;
          efFec = #1#1;
          enAlma = #0#3;
          |HAZ MiraHisL;
          |SI enErrHis ! 0;
               |ERROR;
               |ACABA;
          |FINSI;
     |FINSI;
     |SI #0#19 = "S"; |O #0#20 = "S";|O #1#38 = "S"; |O #1#39 = 999999;
          |SI nForma < 0;
              |SI #0#19 = "S";
                  |MENAV "0000Esta linea proviene de un Pedido (use la opcion adecuada)";
              |FINSI;

              |SI #0#20 = "S";
                  |MENAV "0000Esta linea proviene de un Deposito (use la opcion adecuada)";
              |FINSI;

              |SI #1#38 = "S";
                  |MENAV "0000Este albaran esta FACTURADO";
              |FINSI;

              |SI #1#39 = 999999;
                  |MENAV "0000Este albaran esta en modo Exportacion";
              |FINSI;
          |FINSI;
          |ERROR;
          |ACABA;
     |FINSI;

     |SI nForma = 1;
          |HAZ PideSec;
     |FINSI;
     |SI modo = 3;
          |HAZ BorraSec;
     |FINSI;

     |SI campo < 3; |Y sal_campo = 0;
         |HAZ defecli;
     |FINSI;

     |SI #0#9 > 0;
         nerror = 1;
     |SINO;
         nerror = -1;
         #0#9 = -#0#9;
     |FINSI;

     imneto = ((((#0#9 < #1#5) < #1#32) < #1#7)) * nerror;
     #0#9   = #0#9 * nerror;

     ||-------------------Actualiza Historico, Articulo y Almacen
     enForma = 0 +. 1;
     eaAlbTaller = "S";
     |HAZ AcumulaAV;
     |HAZ HistoTaller;
     ||-------------------

     #0#14 = enCoste;
     #1#37 = #1#37 + (imneto - enCoste);

     |SI modo = 1; |O modo = 2;
         |HAZ grapre;                  || Graba Precio Cliente/Articulo
     |FINSI;

     enTiva = #0#11;
     efFiva = #1#1;
     |HAZ SacaIVA;

/************************************
     #1#15 = #1#15 +. #0#9;
     |SI #0#11 = 0; #1#28 = #1#28 +. imneto; |FINSI;

     |SI #0#11 = 1;
         #1#16 = #1#16 +. imneto; nNume = #1#16; #1#17 = nNume % enIva;
         |SI #1#36 = "S";  #1#18 = nNume % enRec;  |FINSI;
     |FINSI;

     |SI #0#11 = 2;
         #1#19 = #1#19 +. imneto; nNume = #1#19; #1#20 = nNume % enIva;

         |SI #1#36 = "S";  #1#21 = nNume % enRec;  |FINSI;
     |FINSI;

     |SI #0#11 = 3;
         #1#22 = #1#22 +. imneto; nNume = #1#22; #1#23 = nNume % enIva;

         |SI #1#36 = "S";  #1#54 = nNume % enRec;  |FINSI;
     |FINSI;

     |SI #0#11 = 4;
         #1#44 = #1#44 +. imneto; nNume = #1#44; #1#45 = nNume % enIva;

         |SI #1#36 = "S";  #1#46 = nNume % enRec;  |FINSI;
     |FINSI;

     |SI #0#11 = 5;
         #1#47 = #1#47 +. imneto; nNume = #1#47; #1#48 = nNume % enIva;

         |SI #1#36 = "S";  #1#49 = nNume % enRec;  |FINSI;
     |FINSI;

     nNume = imneto % #0#10;
     #1#26 = #1#26 +. nNume;
     |SI #1#15 > 0;
         nerror = 1;
     |SINO;
         nerror = -1;
         #1#15 = -#1#15;
     |FINSI;

     #1#25 = #1#15 < #1#5;
     #1#25 = #1#25 < #1#32;
     #1#25 = (#1#25 < #1#7) * nerror;
     #1#15 = #1#15 * nerror;
     #1#25 = #1#15 - #1#25;
     #1#24 = #1#17+#1#18+#1#20+#1#21+#1#23+#1#54+#1#45+#1#46+#1#48+#1#49;

     #1#67 = (#1#15-#1#25) + (#1#11+#1#13+#1#24);
     |GRABA 010#1a;
*/

     |HAZ CalCabAgifa010;
     |HAZ visual_totales;

     || ACTUALIZA FICHERO DE LOTES...........................................

     sserie = #0#29;
     nnumer = #0#0;
     ffecha = #1#1;
     arti   = #0#2;
     cclien = #1#3;
     unid   = #0#5;
     desc   = #0#4;
     lineaa = #0#1;
     |HAZ act_lotes;

     |SI modo = 3;
         eaTipo      = "AV";
         eaSerie     = #0#29;
         enCodigo    = #0#0;
         enLinea     = #0#1;
         efFecha     = #1#1;
         eaAbono     = #1#43;
         enTarifa    = #6#39;

         |SUB_EJECUTA_NP "dsz00002;BAJA";
     |FINSI;

     |HAZ TallerCanon71;
|FPRC;

|PROCESO Tipo3_071;|TIPO 3;
     modo = (FEntrada / 100) ! 0;

|FPRC;

|| ***********************************************************************
|PROCESO pantalla; |TIPO 13;
     #1#67 = (#1#15 - #1#25) + (#1#11 + #1#13 + #1#24);
     |HAZ visual_totales;
     |SI salida = 9;
          |PUSHV 501 2380;
          |PINPA #0#1;
          |PINDA #0#1;
          |PAUSA;
          |POPV;
          salida = 0;
     |FINSI;
|FPRC;

|PROCESO art6alv; |TIPO 6;          || Antes de la Relacion 4§ Clave.
     r_arti = "";                  || LIMPIA LA VARIABLE DEL ART.AUTOMATICO.

 |SI codiBarra = "N"; |ACABA; |FINSI;

|ABRE #36;
|SELECT #2#36;
#36#3=#0#2;
|LEE 010#36=;
|SI FSalida=0; |Y #0#2 ! #36#1;
  #0#2=#36#1;
  |ERROR;
  |PINTA #0#2;
|FINSI;
|FPRC;

|PROCESO nomodifi; |TIPO 0;
     modo = (FEntrada / 100) ! 0;
     |SI modo = 1; #0#3 = def_alm; |PINTA #0#3; |FINSI;
     |QBF r_arti;
     |SI r_arti ! "";
          #0#2 = r_arti;
          |PINTA #0#2;
     |FINSI;
     |SI #0#2 = vacio;
          |CAMPO_MODIFICA #0#3,  1, "N";
          |CAMPO_MODIFICA #0#5,  1, "N";
          |SI #1#70 = "B";
            |CAMPO_MODIFICA #0#6,  1, "N";
          |SINO;
            |CAMPO_MODIFICA #0#36,  1, "N";
          |FINSI;
          |CAMPO_MODIFICA #0#8,  1, "N";
          |CAMPO_MODIFICA #0#33,  1, "N";
          |CAMPO_MODIFICA #0#10, 1, "N";
          |CAMPO_MODIFICA #0#11, 1, "N";
          |CAMPO_MODIFICA #0#27, 1, "N";
     |SINO;
          |CAMPO_MODIFICA #0#3,  1, "S";
          |CAMPO_MODIFICA #0#5,  1, "S";
          |SI #1#70 = "B";
            |CAMPO_MODIFICA #0#6,  1, "S";
          |SINO;
            |CAMPO_MODIFICA #0#36,  1, "S";
          |FINSI;
          |CAMPO_MODIFICA #0#8,  1, "S";
          |CAMPO_MODIFICA #0#33, 1, "S";
          |CAMPO_MODIFICA #0#10, 1, "S";
          |CAMPO_MODIFICA #0#11, 1, "S";
          |CAMPO_MODIFICA #0#27, 1, "S";
     |FINSI;
|FPRC;


|PROCESO lee_tecla1;
     |SI salida = 14;
         c_clien = #1#3;
         c_artic = #0#2;
         c_serie = #1#52;
         entrada = 1;
         |SUB_EJECUTA_NP "agifa283.run";
         |ERROR;
         salida = 0;
     |FINSI;
     campo = Campo;
     |SI salida = 13;   ||F5
          modo = (FEntrada / 100) ! 0;
          |SI modo = 4;
               |ABRE #6;
               #6#0 = #1#3;
               |LEE 001#6=;
               |SI FSalida ! 0; |DDEFECTO #6; |FINSI;
               |CIERRA #6;
          |FINSI;
          |PUSHV 0501 2380;
          ext1 = #6#16;
          |SUB_EJECUTA_NP "caextrap.run";
          |POPV;
          salida = 0;
     |FINSI;
|FPRC;

|| *********************** *(1)
|PROCESO leeotro; |TIPO 11;
     salida = FSalida;
     trabajo = "N";
     |ABRE #20;
     |LEE 000#20p;
     |SI FSalida = 0;
          trabajo = #20#132;
     |FINSI;
     |CIERRA #20;
     |SI salida = 16; |Y trabajo = "S";     || F2.

          programa = Control % 109;
          sserie = #0#29;
          nnumer = #0#0;
          ffecha = #1#1;
          cclien = #1#3;
          nnombr = #1#4;
          |PUSHV 0501 2380;
          consulta = "S";
          |SUB_EJECUTA_NP "agi00002";
          |POPV;
          salida = 0;
     |FINSI;

     |CAMPO_POSICION #0#1 ,0,atmp;
     |SI salida = 12; |O salida = 17;     || F4 o F9
         |SI salida = 12; |Y recoge ="N"; ||F4
             |PUSHV 0400 0479;
             |MENAV "0000Opcion no activada en Utilidades Usuario de Parametros Generales";
             |POPV;
             |ERROR;
             |ACABA;
         |FINSI;
          modo = (FEntrada/100) ! 0;
          || compruebo que este en la ultima linea y en modo alta
          LineaD = #0#1;    || Guardo puntero
          LineaD = LineaD +1;      || Porque si estoy en alta la linea en la que
                                   || estoy todavia no esta grabada
          |LEE 001#0];
          |SI FSalida ! 0;|O #0#0 ! #1#0;
            |O #0#29 ! #1#52;|Y modo = 1;
               LineaD = LineaD -1;
               |||LEE 001#0[;  || Retrocedo
               || Recupero el puntero
               #0#0  = #1#0;    || Albaran
               #0#29 = #1#52;   || Serie
               #0#1  = LineaD;         || Numero de linea
               |LEE 001#0=;
               nerror = 0;
               |SI salida = 12; ||F4
                  |HAZ entradatos;
               |FINSI;
               |SI nerror = 0 ;
                    |SI salida = 12; ||F4
                       |HAZ leelineas;
                    |FINSI;
                    |HAZ control2;
                    || Le meto 3 ptec's para cuando cambia de pantalla
                    |PTEC 809;    || Flecha abajo
                    |PTEC 809;    || Flecha abajo
                    |PTEC 809;    || Flecha abajo
               |SINO;
                    |ERROR;
               |FINSI;
          |SINO;
               || Recupero el puntero
               LineaD = LineaD -1;
               #0#0  = #1#0;    || Albaran
               #0#29 = #1#52;   || Serie
               #0#1  = LineaD;         || Numero de linea
               |LEE 001#0=;
               |MENAV "0000Debe estar en la ultima linea";
               |ERROR;
          |FINSI;    || Si #0#1 = 1 ...
          salida = 0;
     |FINSI;         || Si FSalida ...
     |SI salida = 18;
          aAlfa = "dsw00007;" + #1#3;    || Extracto Articulo
          |SUB_EJECUTA_NP aAlfa;
          |ERROR;
     |FINSI;
|FPRC;

|| Recojo la serie y numero de albaran
|PROCESO entradatos;
         |PINTA 2420 , " Recogida de datos del albaran :   /    ";
         alfa1 = "";
         E_sup = 2;
         E_inf = "";
         alfa1 = 2453 ? 1;
         serie_o = alfa1;
         alfa2 = "";
         E_sup = 6;
         E_inf = "";
         alfa2 = 2456 ? 1;
         albaran_o = alfa2;
         |BLIN 24;

         ||No puedo leer en el que estoy sino se embuclaria
         |SI serie_o = #1#52;|Y albaran_o = #1#0;
             |MENAV "0000ATENCION !!! Esta en este albaran";
             nerror = 1;
         |FINSI;
|FPRC;

|PROCESO control1;
   aponer= Asino;
   |HAZ poncontr;
|FPRC;

|PROCESO control2;
   aponer= Anosi;
   |HAZ poncontr;
|FPRC;

|PROCESO poncontr;
         fiac = Control % A109;
         fiac = fiac + relleno;
         guarda = fiac % A109;
         fiac = Control % A1001;
         Control = Control + fiac;
         Control = Control + relleno;
         Control = Control % A120;
         Control = Control + aponer;
|FPRC;

|PROCESO CreaComponente;
     #905#0 = "AV";
     #905#1 = #0#29;
     #905#2 = #0#0;
     #905#3 = #0#1;
     #905#9 = #905#6;
     |GRABA 020#905n;
     |LIBERA #905;

     enUnidades   = #905#6;
     eaTipo       = "AV";
     eaSerie      = #0#29;
     enCodigo     = #0#0;
     enLinea      = #0#1;
     efFecha      = #1#1;
     eaArticulo   = #0#2;
     enAlmacen    = #0#3;
     eaComponente = #905#4;
     efFecha      = #1#1;

     |SUB_EJECUTA_NP "dsz00002;AVC";
|FPRC;

|DEFBUCLE dsm00005;
     #905#1;
     ;
     "AV", serie, albaran, nlinea, "      ";
     "AV", serie, albaran, nlinea, "zzzzzz";
     be;
     NULL, CreaComponente;
|FIN;

|PROCESO crealineasV;
    || Clave primaria
    #0#29= #1#52;    || Serie
    #0#0 = #1#0;     || Numero de Albaran
    #0#1 = LineaD;          || Numero de linea


    |DEFECTO #0#1;   || Cargo los valores de defecto de cab.albaran

    || Procedo a cambiar lo que no es igual
    #0#12 = "";             || Numero de pedido
    || Controles de procedencia, si vienen de pedido, deposito, etc..
    |PARA i = 18;|SI i [ 25;|HACIENDO i = i +1;
       #0i="";
    |SIGUE;
    #0#31 ="";    || Serie pedido
    #0#32 ="";    || Serie deposito


    |HAZ totli;        || Calculo total linea
    |HAZ liacarti;     || Lo envio al tipo 2 para que calcule lo mismo que si fuera
                       || una linea introducida por el operador
    |GRABA 021#0b;
    |LIBERA #0;

    |BUCLE dsm00005;

    LineaD =LineaD + 1;  || Aumento contador de lineas
|FPRC;

|PROCESO leelineas;
      #0#29= serie_o;
      #0#0 = albaran_o;
      #0#1 = 1;
      |LEE 001#0];
      |SI FSalida = 0;
           |PARA;|SI FSalida = 0;|Y #0#29=serie_o;|Y #0#0=albaran_o;
                                                     |HACIENDO;
                  || Me guardo el puntero
                  serie   = #0#29;   || Serie y albaran actual
                  albaran = #0#0;
                  nlinea  = #0#1;

                  |HAZ crealineasV;

                  || Recupero puntero
                  #0#29 = serie;
                  #0#0  = albaran;
                  #0#1  = nlinea;
                  |LEE 001#0=;

                  |LEE 001#0s;
           |SIGUE;
      |SINO;
           |MENAV "0000Atencion !!! No se ha encontrado el albaran indicado";
           |ERROR;
      |FINSI;

      || Devuelvo el puntero de la linea
      #0#29= #1#52; || Serie
      #0#0 = #1#0;  || Albaran
      #0#1 = LineaD;       || Linea
      |LEE 001#0=;
|FPRC;

|PROCESO leeps;|TIPO 0;
     |SI salida = 15;   ||F6
        |HAZ CreaTempo; aTmp22 = Tempo;
        |NOME_DAT #22 aTmp22; |DELINDEX #22;
        |CONFI mensaje10;
        |SI FSalida = 0;
          |SYSTEM "capser";   ||Captura Datos Psion
          |HAZ prepaps;
          |PUSHV 1213 2380;
          |SUB_EJECUTA_NP "capsion.run";
          |HAZ genelin;
          |POPV;
          |PTEC 807;
        |FINSI;
        Tempo = aTmp22; |HAZ BoraTempo; |DELINDEX #22;
        salida = 0;
     |FINSI;
|FPRC;

|PROCESO line;
lin = lin + 1;
#0#0 = #1#0;
#0#29 = #1#52;
#0#1 = lin;
#0#2 = #22#2;
|DDEFECTO #0;
#0#0 = #1#0;
#0#29 = #1#52;
#0#1 = lin;
#0#2 = #22#2;
#0#3 = 1;
#0#4 = #22#3;
#0#5 = #22#4;
#0#11 = #2#30;
#0#27 = #0#2;
|HAZ defecli;
|HAZ mirespor;
|HAZ totli;
|HAZ liacarti;
|GRABA 121#0c;
|LIBERA #0;
|FPRC;

|DEFBUCLE leelin;
#22#1;
5;
  1 ,    1 , "S";
999 , 9999 , "S";
be;
NULL,line;
|FIN;

|PROCESO genelin;
|ABRE #22;
lin = 0;
|BUCLE leelin;
|LIBERA #22;
|CIERRA #22;
|FPRC;

|PROCESO prepaps;          ||Preparacion Lineas Recogidas Del Psion
  lin = 0;
  path = "";
  |DFICE path;
  |QBF path;
  art ="rt  " + path + "ventas";
  |QBF art;
  |FABRE art;
  |SI FSalida < 0;  |ACABA;  |FINSI;
  f1 = FSalida;
  Pos = -1;
  varalfa = "";
  fs = 1;
  |PARA jj = 1; |SI fs ] 0;|HACIENDO jj = jj + 1;
        aux = "";
        varalfa = f1 + " 80";
        |FLEE varalfa;
        |SI FSalida < 0;  |SAL;  |FINSI;
        Pos = -1;
        aux = varalfa % 0104;   ||Numero Venta
        |QBF aux;
        |SI aux ! "    ";|Y aux ! "";
            lin = lin + 1;
            |ABRE #22;
            #22#0 = lin;
            #22#1 = varalfa % 0104;   ||Numero Venta
            #22#2 = varalfa % 0613;   ||Codigo articulo
            aux = varalfa % 2107;     ||Unidades Venta
            |QBF aux;
            #22#4 = aux;
            aux = "";
            |ABRE #2;
            #2#0 = #22#2;
            |LEE 001#2=;
            #22#3 = #2#1;             ||Descripcion
            |CIERRA #2;
            |GRABA 000#22c;
            |LIBERA #22;
            |CIERRA #22;
        |FINSI;
  |SIGUE;
  varalfa = f1;
  |FCIERRA varalfa;
  Pos = -1;
|FPRC;

||---------------------------------------------------------------------------
|| LOTES.
||---------------------------------------------------------------------------
|PROCESO act_lotes; |TIPO 2;
     |SI lotes = "S"; |Y #1#43 = "N";
          |ABRET #90;
          |ABRET #91;
          #90#0 = #0#2;                           || ARTICULO.
          |LEE 141#90=;
          |SI FSalida = 0;
               nlote = #90#2;                     || GUARDA EL N§.DE LOTE ACTUAL.
               nn = unid + #90#5;                 || UND.VENDIDAS + UND.ACUMULADAS.
               |SI nn = #90#4;                    || SI UND.ACUMULADAS = LIMITE UND.LOTES.
                    |HAZ hist_lotes;
                    |HAZ suma_lotes;
                    unid = 0;                     || PONE A 0 LA UND.DE LOTE ACTUAL.
               |SINO;
                    |SI nn > #90#4;               || SI UND.ACUMULADAS > LIMITE UND.LOTES.
                         nn = nn / #90#4;         || NUMERO DE LOTES.
                         tu = unid;               || GUARDA TOTAL UNIDADES VENDIDAS.
                         unid = #90#4 - #90#5;    || PRIMERAS UNIDADES.
                         nn1 = 0;
                         |PARA ind = 1; |SI ind < nn; |HACIENDO ind = ind + 1;
                              nn1 = nn1 + unid;
                              |HAZ hist_lotes;
                              |HAZ suma_lotes;
                              unid = #90#4;
                         |SIGUE;
                         |SI nn1 < tu;
                              unid = tu - nn1;
                              |HAZ hist_lotes;
                         |FINSI;
                         |SI unid = #90#4; unid = 0; |FINSI;
                    |SINO;
                         |HAZ hist_lotes;
                         unid = nn;               || PASO A unid EL TOTAL DE UNIDADES PARA ACTUALIZAR EL FICHERO DE LOTES.
                    |FINSI;
               |FINSI;
               #90#2 = nlote;
               #90#5 = unid;
               |GRABA 021#90a;
          |SINO;
               |ATRI P;
               |MENAV "0000EL ARTICULO INTRODUCIDO NO ESTA DADO DE ALTA EN EL FICHERO DE LOTES";
               |ATRI p;
          |FINSI;
          |CIERRAT #90;
          |CIERRAT #91;
     |FINSI;
|FPRC;

||---------------------------------------------------------------------------
|| ACTUALIZA EL HISTORICO DE LOTES.
||---------------------------------------------------------------------------
|PROCESO borraa;
     |BORRA 021#91a;
|FPRC;

|DEFBUCLE borra_lotes;
     #91#1;
     ;
     #0#29, #0#0, #0#1, "        ";
     #0#29, #0#0, #0#1, "zzzzzzzz";
     be;
     NULL, borraa;
|FIN;

|PROCESO hist_lotes; |TIPO 2;
     #91#0 = sserie;
     #91#1 = nnumer;
     #91#8 = lineaa;
     #91#5 = #90#2;      || NUMERO LOTE.
     |LEE 141#91=;
     #91#2 = ffecha;
     #91#3 = arti;
     #91#7 = cclien;
     mod = 0 +. 1;
     |SI FSalida ! 0; |Y mod = 1;
          #91#4 = desc;
          #91#6 = unid;
          |GRABA 021#91n;
     |SINO;
          |SI mod = 1;
               #91#4 = desc;
               #91#6 = unid;
               |GRABA 021#91a;
          |SINO;
               |BUCLE borra_lotes;
          |FINSI;
     |FINSI;
|FPRC;

||---------------------------------------------------------------------------
|| CALCULA EL NUMERO DE LOTE.
||---------------------------------------------------------------------------
|PROCESO Suma;
     IC = C1<-;
     inc = #90#3;                  || INCREMENTO.
     halfa = #90#2; |QBF halfa;    || NUMERO LOTE.
     halfa = halfa % A0;
     longi = halfa;
     halfa = #90#2; |QBF halfa;    || NUMERO LOTE.
     longi = (longi * 100) + 1;
     |PARA hi = longi; |SI hi ] 101; |HACIENDO hi = hi - 100;
          letra = halfa % hi;
          |HAZ HallaPos;
          numero = inc $ hn;
          pos = pos + numero + resto;
          inc = (inc - numero) / hn;
          |SI pos > hn;
               resto = 1;
               pos = pos - hn;
          |SINO;
               resto = 0;
          |FINSI;
          |HAZ Cadena;
          |SI inc = 0;|Y resto = 0;
               hi = hi - 100;
               |SAL;
          |FINSI;
     |SIGUE;
     |PARA; |SI hi ] 101; |HACIENDO hi = hi - 100;
          letra = halfa % hi;
          C = letra;
          IC = IC + 1;
          hn1 = hn1 + 1;
     |SIGUE;
     |SI resto = 1;
          C = M1;
          hn1 = hn1 + 1;
     |FINSI;
     IC = C1<-;
     halfa = "";
     |PARA hi = 1; |SI hi [ hn1; |HACIENDO hi = hi + 1;
          halfa = C + halfa;
          IC = IC + 1;
     |SIGUE;
     #90#2 = halfa;            || NUMERO LOTE.
     nlote = halfa;
|FPRC;

|PROCESO Cadena;
     IM = M1<-;
     IM = IM + pos - 1;
     C = M;
     IC = IC + 1;
     hn1 = hn1 + 1;
|FPRC;

|PROCESO HallaPos;
     IM = M1<-;
     |PARA pos = 1; |SI pos [ hn; |HACIENDO pos = pos + 1;
          |SI letra = M; |ACABA; |FINSI;
          IM = IM + 1;
     |SIGUE;
     |MENAV "0000­­­ La Cadena contiene caracteres extra¤os !!!";
|FPRC;

|PROCESO suma_lotes; |TIPO 0;
     |SI mod = 1;
          hn = 0;
          hn1 = 0;
          IM = M1<-;
          |SI #90#6 = "S"; |HAZ Numeros; |FINSI;
          |SI #90#7 = "S"; |HAZ Mayus;   |FINSI;
          |SI #90#8 = "S"; |HAZ Minus;   |FINSI;
          |HAZ Suma;
     |FINSI;
|FPRC;

|PROCESO Numeros;
     |PARA hi = 48; |SI hi [ 57; |HACIENDO hi = hi + 1;
          hn = hn + 1;
          M = &hi;
          IM = IM + 1;
     |SIGUE;
|FPRC;

|PROCESO Mayus;
     |PARA hi = 65; |SI hi [ 90; |HACIENDO hi = hi + 1;
          hn = hn + 1;
          M = &hi;
          IM = IM + 1;
     |SIGUE;
|FPRC;

|PROCESO Minus;
     |PARA hi = 97; |SI hi [ 122; |HACIENDO hi = hi + 1;
          hn = hn + 1;
          M = &hi;
          IM = IM + 1;
     |SIGUE;
|FPRC;

|PROCESO Conversion;  |TIPO 7;
     |SI #agifa142#72 = "S";
          Envase    = #0#34;
          Unidades1 = #0#35;
          Unidades2 = #0#5;
          VArticulo = #0#2;
          enAlmacen = #0#3;
          eaTipo = "V";
          |PUSHV 0101 2480;||Los sub_ejecutas provocaban efectos indeseados de pintado
          |SUB_EJECUTA_NP "agiw0004.tab;NOMEQUITESQUETECORTOLOSGUEVOS";
          |POPV;
          #0#34 = Envase;
          #0#35 = Unidades1;
          #0#5  = Unidades2;  |PINTA #0#5;
          |C_M #0#5, 1, "S";
          |SI Unidades1 ! 0;  |C_M #0#5, 1, "N";  |FINSI;
     |FINSI;
|FPRC;

||---------------------------------------------------------------------------
|| PONE LAS LINEAS DE ENTRADA DE BOLSAS, COMO NO FACTURADAS.
||---------------------------------------------------------------------------
|PROCESO bolsas; |TIPO 2;
     modo = (FEntrada/100) ! 0;
     |SI modo = 3;
          Pos = -1;
          alfa1 = "";    |DBIN alfa1;
          alfa1 = "rt  " + alfa1 + "/mod00013.tab";
          |FABRE alfa1;
          |SI FSalida = 0;
              |FCIERRA FSalida;
              serfot = #0#29;||Relacion Alb.Bolsas;
              numfot = #0#0;
              linfot = #0#1;
              clifot = #1#3;
              artfot = #0#2;
              |SUB_EJECUTA_NP "mod00013";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO grapre;
     |SI #20#79 = "S"; |O #20#79 = "P";
          |SI nForma = 1;
               cli_dt = #0#15;
               art_dt = #0#2;
               pvp_ve = #0#6;
               dtos_1 = #0#8;
               aParam = "grapre";
               enDirEnt = #1#84;
               |HAZ calcdtos;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO unidad1;
     |SI #2#176 = "S";
         |SI #1#70 = "D";  || Si la moneda de trabajo es la divisa ...
             #0#36 = nPrecio;
         |SINO;
             #0#6  = nPrecio;
        |FINSI;
    |FINSI;

    |SI #1#70 = "D";  || Si la moneda de trabajo es la divisa ...
        #0#6 = #0#36 / #1#69 * #1#74;  || ... recalculo en funcion de la divisa
    |SINO;
        #0#36 = #0#6 / #1#74 * #1#69; || .. recalculo en funcion de la moneda base
    |FINSI;
    |HAZ visual_precio; || Visualiza el precio
|FPRC;

|PROCESO LinDiv;  |TIPO 7;
|ABRE #agifa321;
|LEE 001#agifa321.p;  || Leo parametros de divisa
|SI ac_divisa = "S"; |Y pintado = 0; || Si divisas estan activadas y no he pintado ...
  |SI #1#70 = "D";   || Si la moneda de trabajo es la divisa la pinto en
    |ATRI R;         || el encabezado del precio y el importe
    titdiv = "Precio" + "(" + #1#68 + ")";
    |PINTA 1444,titdiv;
    titdiv = "I.Tot." + "(" + #1#68 + ")";
    |PINTA 1468,titdiv;
    |ATRI r;
  |FINSI;
  |SI #agifa321#3 = "S";  || Si la visualizacion esta activada ...
    mensa = "Precio:            Imp.:              T.Bruto:             T.ALB:             ";
    |PINTA 1102,mensa;  || ... pinto la linea de visualizacion
    |PINTA #0#38; || Pinto precio visual
    |PINTA #0#39; || Pinto importe visual
    |SI #1#70 = "D"; || Si la moneda de trabajo es la divisa
      #1#77 = #1#75;
      #1#78 = #1#76;
      #1#79 = #1#15;
      #1#80 = #1#67;
      |PINTA 1149,#1#79;
      |PINTA 1168,#1#80;
    |SINO;
      #1#77 = #1#15;
      #1#78 = #1#67;
      |PINTA 1149,#1#75;
      |PINTA 1168,#1#76;
    |FINSI;
    pintado = 1;  || Ya hemos pintado
  |FINSI;
|FINSI;
|CIERRA #agifa321;
|HAZ PinSeccion;
|FPRC;

|PROCESO precio_divisa;
   #0#36 = #0#6 / #1#74 * #1#69;  || Calculo el precio en divisa
   |HAZ unidad1;
|FPRC;

|PROCESO visual_precio; || Pinta el precio visual.
|SI #1#70 = "D";  || Si la moneda de trabajo es la divisa ...
  #0#38 = #0#6;   || ... el campo visualiz. es el precio en moneda base
  |PINTA #0#36;
|SINO;            || Si la moneda de trabajo es la moneda base ...
  #0#38 = #0#36;  || ... el campo visual. es el precio en divisa
  |PINTA #0#6;
|FINSI;
|SI ac_divisa = "S"; |Y #agifa321#3= "S";
  |PINTA #0#38; || Si las divisas y la visualizacion estan activadas, pinto
|FINSI;
|FPRC;


|PROCESO visual_importe;  || Pinta el importe visual
#0#37 = #0#9 / #1#74 * #1#69;  || Calculo el importe en divisas
|SI #1#70 = "D";  || Si la moneda de trabajo es la divisa ...
  #0#39 = #0#9;   || el campo visualiz. es el importe en moneda base
  |PINTA #0#37;
|SINO;            || Si la moneda de trabajo es la moneda base ...
  #0#39 = #0#37;  || el campo visualiz. es el importe en divisa
  |PINTA #0#9;
|FINSI;
|SI ac_divisa = "S"; |Y #agifa321#3= "S";
  |PINTA #0#39;   || Si las divisas y la visualizacion estan activadas, pinto
|FINSI;
|FPRC;

|PROCESO visual_totales;
     #1#75 = #1#15 / #1#74 * #1#69;
     #1#76 = #1#67 / #1#74 * #1#69;

     |ABRE #agifa321;
     |LEE 001#agifa321.p;
     |CIERRA #agifa321;

     |SI #1#70 = "D";
          #1#77 = #1#75;
          #1#78 = #1#76;
          #1#79 = #1#15;
          #1#80 = #1#67;
          |SI ac_divisa = "S"; |Y #agifa321#3= "S";
               |PINTA 1149,#1#79;
               |PINTA 1168,"        ";
               |PINTA 1168,#1#80;
          |FINSI;
          |PINTA 1349,#1#75;
          |PINTA 1366,#1#76;
     |SINO;
          #1#77 = #1#15;
          #1#78 = #1#67;
          #1#79 = #1#75;
          #1#80 = #1#76;
          |SI ac_divisa = "S"; |Y #agifa321#3= "S";
               |PINTA 1149,#1#75;
               |PINTA 1168,"        ";
               |PINTA 1168,#1#76;
          |FINSI;
          |PINTA 1349,#1#15;
          |PINTA 1366,#1#67;
     |FINSI;
|FPRC;

|PROCESO promart;
     |SI FSalida = 16;   ||F8
        |ABRE #25;
        #25#0 = #0#2;
        #25#41 = #6#158;
        |LEE 000#25=;
        |SI FSalida = 0;
           |PARA i = 0;|SI i [ 41;|HACIENDO i = i + 1;
              #26i = #25i;
           |SIGUE;
           |PUSHV 0559 1778;
           |PINPA #0#26;
           |PINDA #0#26;
           |PAUSA;
           |POPV;
        |FINSI;
        |ENCAMPO #5#0;
        |LIBERA #25;
        |CIERRA #25;
        |HAZ PrecioArti;
     |FINSI;
|FPRC;

|PROCESO equiv;
     |SI #agifa142#218 = "S";
          eaArticulo = #0#2;
          enAlmacen = #0#3;
          |SUB_EJECUTA_NP "agifa294.tab;aTempo294";
          |SI enAlmacen = 0;
               |ERROR;
          |SINO;
               #0#2 = eaArticulo; |PINTA #0#2;
               #0#3 = enAlmacen; |PINTA #0#3;
               |ABRE #2;
               #2#0 = #0#2;
               |LEE 000#2=;
               |CIERRA #2;
               #0#4 = #2#1;
               |PINTA #0#4;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CogeValores71;  |TIPO 7;
     |ABRE #20;
     |LEE 001#20p;
     |SI FSalida ! 0; |DDEFECTO #20; |FINSI;
     |CIERRA #20;

     |SI Campo = 3;
         |C_M #0Campo, 1, "S";
         |SI #20#99 = "S";
             |C_M #0Campo, 1, "N";
             #0Campo = 1;  |PINTA #0Campo;
         |FINSI;
     |FINSI;

     |SI #2#176 = "N";  |ACABA;  |FINSI;

     |SI Campo = 3;
         |SI enAlmacen ! 0;
             #0#3 = enAlmacen;  |PINTA #0#3;
         |FINSI;
     |FINSI;

     |SI Campo = 5;
         |SI #2#176 = "S";
             |SI #0#5 ! enUnidades;  Contenido = #0#5;  |FINSI;
             #0#5 = enUnidades;  |PINTA #0#5;
         |FINSI;
     |FINSI;

     |SI Campo = 6;
         |SI nPrecio ! 0;
             #0#6 = nPrecio;  |PINTA #0#6;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO PideArt71;  |TIPO 7;
     |C_M #0#2, 1, "S";
     |C_M #0#3, 1, "N";

     |SI #0#2 ! "                    ";
         |ABRE #2;
         #2#0 = #0#2;
         |LEE 000#2=;
         |SI FSalida ! 0;  |DDEFECTO #2;  |FINSI;
         |CIERRA #2;
         |SI #2#176 = "S";
             |C_M #0#2, 1, "N";
             |C_M #0#3, 1, "N";
             |ACABA;
         |FINSI;
     |FINSI;

     |ABRE #910;
     |LEE 040#910p;
     |SI FSalida ! 0;  |DDEFECTO #910;  |FINSI;
     |CIERRA #910;

     |SI #910#2 [ 2;    |ACABA;  |FINSI;

     eAlfa = #0Campo;
     |SUB_EJECUTA_NP "dsz99990";                 || Por Pantalla

     |SI eAlfa = "-1";  |PTEC 807;  |ACABA;  |FINSI;
     |SI eAlfa = "-2";              |ACABA;  |FINSI;

     eaArticulo = eAlfa;      ||  700000-4215

     #0Campo = eAlfa;
     |PINTA #0Campo;
     |PTEC 802;
|FPRC;

|PROCESO Calc671;  |TIPO 6;
     enAlta = 1;
     eaArticulo = #0Campo;
     |HAZ LlenaArticulo;
     |SI FSalida = 0;
          #0Campo = eaArticulo;
          |PINTA #0Campo;
     |SINO;
          |ERROR; |ACABA;
     |FINSI;

     modo = (FEntrada / 100) ! 0;

     |HAZ EsTallerSC;
     |SI FSalida = 0;
          eaArticulo = #0#2;
          |SUB_EJECUTA_NP "talle004;EXISTE";
     |FINSI;

     |SI modo = 1; |HAZ equiv;  |FINSI;

     |ABRE #2;
     #2#0 = #0#2;
     |LEE 000#2=;
     |SI FSalida ! 0;  |DDEFECTO #2;  |FINSI;
     |CIERRA #2;

     |SI #2#176 = "S";
         eaTipo      = "AV";
         eaSerie     = #0#29;
         enCodigo    = #0#0;
         enLinea     = #0#1;
         efFecha     = #1#1;
         eaArticulo  = #0#2;
         enAlmacen   = #0#3;
         enUnidades  = #0#5;
         enTBruto    = #0#7;
         eaAbono     = #1#43;
         enTarifa    = #6#39;
         eaCliente   = #1#3;

         |SUB_EJECUTA_NP "dsz00002";

         #0#3    = enAlmacen;
         nPrecio = enTBruto / enUnidades;

         |PTEC 802;
         |PTEC 802;
         |PTEC 802;
         |PTEC 802;
     |FINSI;

     |HAZ art6alv;
     |HAZ nomodifi;
|FPRC;

|PROCESO Tipo11071;  |TIPO 11;
     salida = FSalida;
     |SI FSalida = 7;  |Y #2#176 = "S";
         |MENAV "      Imposible abortar;  Termine de introducir la linea y efectue una Baja.";
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO verpre2;
     |ABRE #9;
     |SELECT #3#9;
     #9#10 = #1#3;  || Cliente.
     #9#0  = #0#2;  || Articulo.
     #9#1  = "31.12.2300";  || Fecha.
     #9#2  = "AV";  || Operacion.
     prevul = 0;
     |LEE 000#9];
     |SI FSalida = 0;
          |LEE 000#9a;
     |SINO;
          |LEE 000#9u;
     |FINSI;
     |SI FSalida = 0; |Y #9#10 = #1#3; |Y #9#0 = #0#2; |Y #9#2 = "AV";
          prevul = #9#9 / #1#74 * #1#69;  || Calculo el importe en divisas
          |SI #1#70 = "D";                     || Si la moneda de trabajo es la divisa ...
               prevul = prevul ! nDeci_PreDiv;
          |SINO;                               || Si la moneda de trabajo es la moneda base ...
               prevul = prevul ! nDeci_PreBase;
          |FINSI;
     |FINSI;
     |CIERRA #9;
|FPRC;

|PROCESO cierre; |TIPO 0;
     efFec = #1#1;
     enAlma = #0#3;
     |HAZ MiraHisL;
     |SI enErrHis ! 0;
          |ERROR;
          |SI #20#99 = "S";
               |PTEC 807;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO miraques;|TIPO 0;
|SI #1#43 = AN;
   a = -1; b = 1;
   operacion = "AV";
   operainte = "AC"; || Si es una Serie Interna
|SINO;
   a = 1;  b = -1;
   operacion = "BV";
   operainte = "BC"; || Si es una Serie Interna
|FINSI;
|FPRC;

|PROCESO CheqPCM_PVP611; |TIPO 0;
     eaArticulo = #0#2;
     enPrecio = #0#6;
     enDto1 = #0#8;
     enDto2 = #0#33;
     |HAZ CheqPCM_PVP;
|FPRC;

----------------------------------------------
|PROCESO TallerCreaLin71;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa071";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen@;
     |SI #0#63 > 0;
          nLin = #0#63;
          #referen@#29 = #0#29;
          #referen@#0 = #0#0;
          #referen@#1 = nLin;
          |LEE 121#referen@.=;
     |SINO;
          #referen@#29 = #0#29;
          #referen@#0 = #0#0;
          #referen@#1 = 999;
          |LEE 000#referen@.];
          |SI FSalida = 0;
               |LEE 000#referen@.a;
          |SINO;
               |LEE 000#referen@.u;
          |FINSI;
          |SI FSalida = 0; |Y #referen@#29 = #0#29;  |Y #referen@#0 = #0#0;
               nLin = #referen@#1 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |SI nLin [ #0#1; nLin = #0#1 + 1; |FINSI;
          |DDEFECTO #referen@;
          #referen@#29 = #0#29;
          #referen@#0 = #0#0;
          #referen@#1 = nLin;
          |GRABA 020#referen@.b;
     |FINSI;
     aAlfa = "CANON " + #0#4;
     #referen@#2 = "xxxxx";
     #referen@#3 = 1;
     #referen@#4 = aAlfa;
     #referen@#5 = #0#5;
     #referen@#6 = enCanon;
     #referen@#11 = #0#11;
     #referen@#13 = #0#13;
     #referen@#15 = #0#15;
     #referen@#36 = enCanon;
     #referen@#63 = -1;
     |SALVA_DATOS #0;

     |SALVA_DATOS #referen@;
     |REPON_DATOS #0;

     enForma = 1;
     eaAlbTaller = "S";
     |HAZ AcumulaAV;
     |HAZ HistoTaller;
     |HAZ TotalLin71;
     |HAZ AcuAlbaran;

     |SALVA_DATOS #0;
     |REPON_DATOS #referen@;
     |GRABA 020#referen@.a;

     |REPON_DATOS #0;

     #0#63 = nLin;  || Linea Promocion

     |CIERRA #referen@;
     |DESCARGA_DEF #referen@;


     || La seccion
     |ABRE #4;
     #4#0 = #0#29;
     #4#1 = #0#0
     #4#2 = #0#1;
     |LEE 000#4=;
     |SI FSalida = 0;
          #4#0 = #0#29;
          #4#1 = #0#0
          #4#2 = #0#63;
          |BORRA 000#4c;
          |GRABA 020#4n;
     |FINSI;
     |CIERRA #4;
|FPRC;

|PROCESO TallerAcuLin71;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa071";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen@;
     #referen@#29 = #0#29;
     #referen@#0 = #0#0;
     #referen@#1 = #0#63;     || Usa linea promocion
     |LEE 101#referen@.=;
     |SI FSalida = 0;
          |SALVA_DATOS #0;
          |SALVA_DATOS #referen@;
          |REPON_DATOS #0;
          #0#1 = #referen@#1;
          enForma = -1;
          eaAlbTaller = "S";
          |HAZ AcumulaAV;
          |HAZ HistoTaller;
          |HAZ TotalLin71;
          |HAZ AcuAlbaran;
          |REPON_DATOS #0;
     |FINSI;
     |CIERRA #referen@;

     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO TallerBorLin71;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa071";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen@;
     #referen@#29 = #0#29;
     #referen@#0 = #0#0;
     #referen@#1 = #0#63;     || Usa linea promocion
     |LEE 101#referen@.=;
     nTallerBorLin = FSalida;
     |SI FSalida = 0;
          |BORRA 020#referen@.a;
     |FINSI;
     |CIERRA #referen@;

     |DESCARGA_DEF #referen@;

     || La seccion
     |ABRE #4;
     #4#0 = #0#29;
     #4#1 = #0#0
     #4#2 = #0#63;
     |BORRA 000#4c;
     |CIERRA #4;
|FPRC;

|PROCESO TallerCanon71;
     eaArticulo = #0#2; |QBF eaArticulo;
     |HAZ TallerCanon;
     |SI nForma = 1;
          |SI enCanon ! 0;
               aponer = Asino; |HAZ poncontr;
               |HAZ TallerCreaLin71;
               aponer = Anosi; |HAZ poncontr;
               |PTEC 809; |PTEC 816; |PTEC 806;
          |SINO;
               |SI #0#63 > 0;      || ha cambiado a un articulo sin canon
                    |HAZ TallerBorLin71;
                    #0#63 = 0;
               |FINSI;
          |FINSI;
     |SINO;
          |SI modo = 3; |Y enModoCab10 ! 3;
               |HAZ TallerAcuLin71;
               |HAZ TallerBorLin71;
               |SI nTallerBorLin = 0;
                    |PONCONTROL 23, "SI";
                    |PTEC 809; |PTEC 808;
               |FINSI;
          |SINO;
               |SI modo = 2;
                    |HAZ TallerAcuLin71;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO AcuAlbaran;
     |HAZ CalCabAgifa010_2;
     |HAZ visual_totales;
|FPRC;

|PROCESO IVA611_66; |TIPO 66;
     enTiva = #0Campo;
     efFiva = #1#1;
     |HAZ ConsuIVA;
     |SI eaDiva = "";
          |ERROR;
     |SINO;
          #0Campo = enTiva; |PINTA #0Campo;
     |FINSI;
|FPRC;

|PROCESO IVA611_0; |TIPO 0;
     enTiva = #0Campo;
     efFiva = #1#1;
     |HAZ SacaIVA;
     |SI eaDiva = "";
          |MENAV "0000No existe tipo iva para esta fecha...";
          |ERROR; |ACABA;
     |SINO;
          |HAZ mirespor;
     |FINSI;
|FPRC;

|PROCESO PinSeccion;
     |ABRE #4;
     #4#0 = #0#29;
     #4#1 = #0#0;
     #4#2 = #0#1;
     |LEE 000#4=;
     |SI FSalida ! 0; |DDEFECTO #4; |FINSI;
     |CIERRA #4;
     |ATRI I; |PINTA 1342, #4#3; |ATRI 0;
|FPRC;

|PROCESO HistoTaller;
     |ABRE #612;
     #612#0 = #0#29;
     #612#1 = #0#0;
     |LEE 000#612=;
     |SI FSalida ! 0; |DDEFECTO #612; |FINSI;
     |CIERRA #612;
     |ABRE #4;
     #4#0 = #0#29;
     #4#1 = #0#0;
     #4#2 = #0#1;
     |LEE 000#4=;
     |SI FSalida ! 0; |DDEFECTO #4; |FINSI;
     |CIERRA #4;
     |ABRE #625;
     #625#0 = #612#2;
     #625#1 = #612#3;
     |LEE 000#625=;
     |SI FSalida ! 0; |DDEFECTO #625; |FINSI;
     |CIERRA #625;

     |ABRE #109;
     #109#0 = #0#2;
     #109#1 = #1#1;
     |SI #1#43 = "S";
          #109#2 = "BV";
     |SINO;
          #109#2 = "AV";
     |FINSI;
     #109#3 = #0#0;
     #109#4 = #0#1;
     #109#5 = #0#29;
     |LEE 101#109=;
     |SI enForma = 1;
          |SI FSalida ! 0; |GRABA 020#109b; |FINSI;
          #109#6 = #612#8;
          #109#7 = #612#2;
          #109#8 = #612#3;
          #109#9 = #625#11;
          #109#10 = #625#19;
          #109#11 = #4#3;
          #109#12 = "S";
          |GRABA 020#109a;
     |SINO;
          |SI FSalida = 0; |BORRA 020#109a; |FINSI;
     |FINSI;
     |CIERRA #109;
|FPRC;
