|FICHEROS;
     agis0002 #2;
     agifa010 #10;
     agis0002@;
     cafe0027@;
|FIN;

|VARIABLES;
     &enSwEntregaNoEntra = 0;
     &enCobro = 0;
     &enRecibo = 0;
     nTipo = 0;
     aPath = "";
     aCobro = "";
     aCobrado = "";
     aAlfa = "";
     nTotaCobra = 0;
     nTotalAlba = 0;
     nAbo = 0;
     nSwGesisat = 0;
     nSwJamaica = 0;
|FIN;

|PROCESO EsIber21_;
     |DBASE aPath;
     aPath = aPath + "bin/iber0001.tab";
     |XABRE "E", aPath, 0;
|FPRC;

|PROCESO Es_Jamaica;
     |DBASE aPath;
     aPath = aPath + "def/cafe0001.mas";
     |XABRE "E", aPath, 0;
     |SI FSalida ] 0;
          |HAZ EsIber21_;
          |SI FSalida ] 0;
               FSalida = 1;
          |SINO;
               FSalida = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Es_Gesisat;
     |DBASE aPath;
     aPath = aPath + "def/gesim001.mas";
     |XABRE "E", aPath, 0;
     |SI FSalida ] 0;
          |HAZ EsIber21_;
          |SI FSalida ] 0;
               FSalida = 1;
          |SINO;
               FSalida = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO &Entre15; |TIPO 15;
     nTipo = 15;
     |SI #2#30 = "A";
          |HAZ Es_Jamaica; nSwJamaica = FSalida;
          |HAZ Es_Gesisat; nSwGesisat = FSalida;
          |SI nSwJamaica = 0; |O nSwGesisat = 0;
               |HAZ AlbaEstaCobrado;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO &Entre16; |TIPO 16;
     nTipo = 16;
     |SI #2#30 = "A";
          |HAZ Es_Jamaica; nSwJamaica = FSalida;
          |HAZ Es_Gesisat; nSwGesisat = FSalida;
          |SI nSwJamaica = 0; |O nSwGesisat = 0;
               |HAZ AlbaEstaCobrado;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO &Entre17; |TIPO 17;
     nTipo = 17;
     |SI #2#30 = "A";
          |HAZ Es_Jamaica; nSwJamaica = FSalida;
          |HAZ Es_Gesisat; nSwGesisat = FSalida;
          |SI nSwJamaica = 0; |O nSwGesisat = 0;
               |HAZ AlbaEstaCobrado;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Mira_Cobro;
     |SI #agis0002@#30 = #2#30; |Y #agis0002@#20 = #2#20;
               |Y #agis0002@#17 = #2#17; |Y #agis0002@#18 = #2#18;
          |SI nTipo ! 17;
               |SI #2#32 = "N";
                    aCobro = "N";
               |SINO;
                    nTotaCobra = nTotaCobra - (#2#9 * nAbo);
               |FINSI;
          |FINSI;
     |SINO;
          |SI #agis0002@#32 = "N";
               aCobro = "N";
          |SINO;
               nTotaCobra = nTotaCobra - (#agis0002@#9 * nAbo);
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE Mira_Cobro;
     #agis0002@#1004;
     ;
     "A", #10#52, #10#0, 01;
     "A", #10#52, #10#0, 99;
     ;
     NULL, Mira_Cobro;
|FIN;

|PROCESO AlbaEstaCobrado;
     |SI enSwEntregaNoEntra = 1; |ACABA; |FINSI;
     |ABRE #10;
     #10#52 = #2#20;
     #10#0 = #2#17;
     |LEE 000#10=;
     |SI FSalida = 0;
          |DDEF aAlfa;
          aAlfa = aAlfa + "agis0002";
          |CARGA_DEF aAlfa, agis0002@;
          |SI FSalida = 0;
               nTotalAlba = #10#78 ! 2;
               nTotaCobra = nTotalAlba;
               nAbo = 1;
               |SI nTotaCobra < 0; nAbo = -1; |FINSI;
               nTotaCobra = nTotaCobra * nAbo;
               aCobro = "S";
               |BUCLE Mira_Cobro;
               |DESCARGA_DEF #agis0002@;

               |SI nTipo = 15;
                    |SI #2#32 = "N";
                         aCobro = "N";
                    |SINO;
                         nTotaCobra = nTotaCobra - (#2#9 * nAbo);
                    |FINSI;
               |FINSI;

               nTotaCobra = nTotaCobra ! 2;
               |SI aCobro = "S"; |Y nTotaCobra [ 0;
                    aCobrado = "S";
               |SINO;
                    nTotaCobra = nTotaCobra * nAbo;
                    |SI nTotaCobra = nTotalAlba;
                         aCobrado = "N";
                    |SINO;
                         aCobrado = "P";
                    |FINSI;
               |FINSI;

               |DDEF aAlfa;
               aAlfa = aAlfa + "cafe0027";
               |CARGA_DEF aAlfa, cafe0027@;
               |SI FSalida = 0;
                    |ABRE #cafe0027@;
                    #cafe0027@#0 = #10#52;
                    #cafe0027@#1 = #10#0;
                    |LEE 101#cafe0027@.=;
                    |SI aCobrado = "S";
                         |SI FSalida ! 0;
                              |GRABA 020#cafe0027@.n;
                              enRecibo = #2#18;
                              enCobro = #2#9;
                              |SI nSwJamaica = 0;
                                   aAlfa = "cafe0026;COBRASI" + #10#52 + #10#0;
                              |FINSI;
                              |SI nSwGesisat = 0;
                                   aAlfa = "cafe0026;CGESISI" + #10#52 + #10#0;
                              |FINSI;
                              |SUB_EJECUTA_NP aAlfa;
                         |FINSI;
                    |SINO;
                         |SI FSalida = 0;
                              |BORRA 020#cafe0027@.a;
                              enRecibo = #2#18;
                              enCobro = #2#9;
                              |SI nSwJamaica = 0;
                                   aAlfa = "cafe0026;COBRANO" + #10#52 + #10#0;
                              |FINSI;
                              |SI nSwGesisat = 0;
                                   aAlfa = "cafe0026;CGESINO" + #10#52 + #10#0;
                              |FINSI;
                              |SUB_EJECUTA_NP aAlfa;
                         |FINSI;
                    |FINSI;
                    |CIERRA #cafe0027@;
                    |DESCARGA_DEF #cafe0027@;
               |FINSI;
          |SINO;
               |MENAV "0000Error al cargar 'agis0002'...":
          |FINSI;
     |FINSI;
     |CIERRA #10;
|FPRC;
