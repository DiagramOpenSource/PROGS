|FICHEROS;
     agifa086 #0;
     agifa084 #1;
     agifa069 #2;
     agifa024 #3;
     agifa091 #6;   || formas de pago
     dsz99984 #11;
     agifa038 #13;
     agifa041 #14;
     agifa048 #15;
     agifa049 #16;
     agifa133 #17;  || vencimientos de facturas
     agifa007 #40;
     agifa142 #41;
     agifa177 #99;  || tipos de recibo
     dsm00053 #53;
     dsm00003 #43;
     dsm00048 #148;
     agifa505@ #505; || Parametros Caja
     agifa501 #501;
     agifa729 #729;
     agifa321 #321;
     agifa324 #324;
     agi00101 #100;

     pycm0011@ #900;
     visal000@ #902;
     ParamOTP@ #951;
     DirecOTP@ #952;
     BasesOTP@ #953;
     otpm0006@;

     tempo134 #134;
     dsm00109 #109;
     tagm0056@;
     Ref0001@ #1000;
     Ref0002@ #2000;
     referen@;

     agifae02 #1002;
     dsm00225 #225;
     dsm00156 #156;

     visalm01@ #950;
     pycm0004@;
     agifa069@;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     nSalida = 0;
     nCampos = 0;
     i       = 0;

     aArti = "";
     &eaDefEmpSerieFe = "";
     &eaDefDatosPagoFe = "";
     &eaDefAAPPFe = "";
     &eaTipoCopia = "";
     nLinFac = 0;
     nHayConfEmp = 0;
     nEmpresa = 0;
     aBorra = "";

     nDentroBucle = 0;
     aIPRemoto = "";
     &enSwBorraCabDet = 0;         ||Control Crystal
     &eaImpMotorCrystal = "";
     nSwSalirProg = 0;

     &enSwModoSilencio = 0;
     &eaAsuntoOTP = "";
     aInfAnt = "";
     &enMenuArchi = 0;
     &eaReimp = "";
     DEBUG = 0;
     MENAV = 0;
     nContaImp = 0;
     &enErrorImp = 0;
     &eaSelFactuE = "";

     ||FE
     &eaAplicacion = "";
     &eaDefFE = "";
     &eaEmpresaFE = "";
     &eaSerieFE = "";
     &eaNumeroFE = "";
     &eaDefLinFe = "";
     &eaDefEmpFe = "";
     &eaDefCliFe = "";
     &eaDefIvaFe = "";
     &eaCodCliFe = "";
     &eaEmpExt   = "";
     &eaPieFact  = "";
     &eaPieFact1 = "";
     &eaPieFact2 = "";

     ||FE2
     nSwHayPDF = 0;
     &eaFacturaPDFFe = "";
     aFicheroPDF = "";
     nSwGenerarPDF = 0;
     nHandlePDF = 0;
     aTempo1002 = "";
     &Tempo = "";
     nSwImpPapel = 0;
     nSwFacArchivo = 0;
     nSwModoArchivo = 0;

     nSwUnaFactura = 0; || Nos indica si es una unica factura o varias (se archivan independientes una a una)
     &eaArCodCli = "";  || Codigo Cliente
     &eaArNomCli = "";  || Nombre Cliente
     &eaArCodCif = "";  || Cif
     &eaArNomCif = "";  || Nombre Cif
     &eaArCodTra = "";  || Codigo Trabajador
     &eaArNomTra = "";  || Nombre Trabajador
     &eaArCamPDF = "";  || Camino al PDF a archivar
/*
     &eaArSerMin = "";  || Serie minuta en caso de ser archivar desde minutacion
     &eaArNumMin = "";  || Numero minuta en caso de ser archivar desde minutacion
     &eaArFecMin = "";  || Fecha minuta en caso de ser archivar desde minutacion
*/
     &eaArTipoDoc = ""; || Tipo documento.  FD, FV, etc ...
     &eaArSerDoc = "";  || Serie Docuemnto.
     &enArNumDoc = 0;   || Numero Documento
     &eaArFecDoc = "";  || Fecha Documento.

     &eaSwEnvioCorreo = "";  ||Indica si se enivia por correo al emitir la minuta
     &eaDirDesFE = "";  || Direccion destino para envio por correo
     &eaFirmarFE = "";  || Indica si tenemos que firmar o no el documento
     aOrig = "";
     aDest = "";
     aImpresora = "";
     aAuxCrys = "";

     nOpcion = 0;
     nArchi = 0;
     &eaArGrpMin = "";  || Grupo archivo en caso de archivar desde minutacion
     &eaArSbGMin = "";  || Subgrupo archivo en caso de archivar desde minutacion
     &eaArTipMin = "";  || Tipo archivo en caso de archivar desde minutacion
     {-1}aMenu  = "";
         aMenu1 = "2400";
         aMenu2 = "1";
         aMenu3 = "";
         aMenu4 = "APSC";
         aMenu5 = "Archivar";
         aMenu6 = "Papel";
         aMenu7 = "S/Conf.Cli.";
         aMenu8 = "Cancelar";

     &PRMNT_serie  = "";
     &PRMNT_numero = 0;
     &PRMNT_zona   = "";
     &PRMNT_aTipoImp = "";

     nSwFriesa = 0;
     nSwSanchez = 0;
     nTotal = 0;
     nTotalD = 0;
     aEsPostFormaso = "N";
     &enCliArt = 0;

     &eaSerieTa = "";
     &enCodigTa = 0;
     &eaImpresora = "";
     &eaFicTmpCab = "";
     &eaFicTmpLin = "";

     &eaNombreEmp = "";
     &eaDireccEmp = "";
     &eaPoblacEmp = "";
     &eaProvinEmp = "";
     &eaCIFEmp    = "";
     &eaTelefoEmp = "";
     &eaFaxEmp    = "";
     &eaLinea1Emp = "";
     &eaLinea2Emp = "";
     &eaDesIVA1   = "";
     &eaDesIVA2   = "";

     nRecibo = 0;
     nSwMailOTP = 0;
     nSwImpreso = 0;
     nCopia = 0;
     aMensaje = "";
     &nSwHazOTP = 0;
     {3}aPuntero = "";
     aRDirBass    = "";
     &eaDuplicado = "";
     &eaTipoImp   = "";

     &eaEntrada  = "";
     &eaSalida   = "";
     aIP         = "";
     aTexto      = "";
     aDirOrigen  = "";
     aDirDestino = "";
     aIPDSCorreo = "";
     aServidor   = "";
     aUsuario    = "";
     aClave      = "";
     aFichero    = "";
     aAsunto     = "";
     fFecha      = @;
     nNumChar    = 0;
     nCalc       = 0;
     nCont       = 0;
     nCont1      = 0;
     nNumero     = 0;
     nSwInfor    = 0;

     aInfCrystal = "";
     aModalImp   = "";

     &eaDoc = "";
     nSwPackList = 0;
     aMas        = "";
     aFich       = "";
     aImpre      = "";
     aQueEmpresa = "";
     aBaseCorreo = "";
     aAbre       = "";
     aCadena     = "";
     aLen        = "";
     aCaracter   = "";

     nHandle     = 0;
     nLen        = 0;
     nCampo      = 0;
     nPosi       = 0;
     nGrupoOTP   = 0;

     &eaLote  = "";
     &EURODB  = 0;
     &enHora  = "";
     &eaProg  = "";
     aBase    = "";
     aAlfa    = "";
     aAlfa1   = "";
     aAlfa2   = "";
     nSwTpv   = 0;
     nVto     = 0;
     &aDivisa = "";
     &aMoneda = "";
     &enEscan = 0;
     &venci1 = @;
     &venci2 = @;
     &venci3 = @;
     &venci4 = @;
     &venci5 = @;
     &venci6 = @;
     &venci7 = @;
     &venci8 = @;
     &venci9 = @;
     &venci10 = @;
     &venci11 = @;
     &venci12 = @;

     &impor1 = 0;
     &impor2 = 0;
     &impor3 = 0;
     &impor4 = 0;
     &impor5 = 0;
     &impor6 = 0;
     &impor7 = 0;
     &impor8 = 0;
     &impor9 = 0;
     &impor10 = 0;
     &impor11 = 0;
     &impor12 = 0;
     nSw     = 0;

     &serie    = ""; ||
     &numero   = 0;  ||  Cuando se llama desde facturas (agifa084)
     &reimpr   = ""; ||
     indtope = 0;
     ind = 0;
     informe = "";
     &iva1 = 0;
     &iva2 = 0;
     &iva3 = 0;
     &iva4 = 0;
     &iva5 = 0;
     &re1 = 0;
     &re2 = 0;
     &re3 = 0;
     &re4 = 0;
     &re5 = 0;
     &codigo="";
     &descrip="";
     &precio=0;
     &dto=0;
     &dto1=0;
     &unid=0;
     &imptot=0;
     &tiva=0;
     &linea=0;
     vacio="";
     &bl  = "                              ";
     &ascii = 0;
     digito = "";
     &impal = 0;
     &trans = 0;

     &eaEmpresa = "";
     &enNumCampos = 0;

     &enExplo = 0;
     &enCampa = 0;
     &eaSocio = "";
     &eaConta = "";
     &enMes = 0;
     &enAno = 0;
     &enSat = 0;
     &eaFacturaPDFOTP = "";
     &eaZonaBase      = "";

     || grupo para crystal
     &enContaLin = 0;
     &enGrupo = 0;
     &enLineas = 0;
     nDiv = 0;
|FIN;

ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄModulo 004159ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO Agrupador;
     nSalida = 1;
     |LEE 000#2p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          |SI #2#2 = #agifa069@#2; |Y #2#33 = #agifa069@#33; |Y #agifa069@#33!0;
               nSalida = 0; |SAL;
          |FINSI;
          |LEE 000#2s;
     |SIGUE;

     |SI nSalida = 0;
          #2#6 = #2#6 + #agifa069@#6;   ||Precio
          #2#7 = #2#7 + #agifa069@#7;   ||Impo
          #2#9 = #2#9 + #agifa069@#9;   ||Total
          #2#26 = #2#26 + #agifa069@#26;||Precio Div
          #2#27 = #2#27 + #agifa069@#27;||Total Div
          |GRABA 020#2a;
     |SINO;
          aAlfa = "|NC"; aAlfa = #2#aAlfa#;
          nCampos = aAlfa; nCampos = nCampos - 1;
          |PARA i = 0; |SI i [ nCampos; |HACIENDO i = i + 1;
               #2i = #agifa069@#i#;
          |SIGUE;
          |GRABA 020#2n;
     |FINSI;
|FPRC;

|DEFBUCLE Agrupador;
     #agifa069@#1003;
     ;
     #1#48, #1#0, 001;
     #1#48, #1#0, 999;
     ;
     NULL, Agrupador;
|FIN;

|PROCESO AgruArtiIni;
     |DDEF aAlfa;
     aAlfa = aAlfa + "agifa069";
     |CARGA_DEF aAlfa, agifa069@;
     nSwSanchez = FSalida;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aAlfa = Usuario;
     |NOME_DAT #2 aAlfa;
     |DELINDEX #2;
     |ABRE #2;
     |BUCLE Agrupador;
     |CIERRA #2;
|FPRC;

|PROCESO AgruArtiFin;
     |DESCARGA_DEF #agifa069@;
     |DELINDEX #2;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ



/*
 El proceso &Grupo se llama desde el informe, en este hay que definir
 las variables: &enContaLin, &enGrupo y &enLineas
 en la primera linea del inf en el F8 se asigna enLineas=10 (numero lineas por copia)
 y en el detalle se hace la llamada a Grupo, este retorna enGrupo que se
 asigna a una variable y se pinta en el inf, esta sera el campo a vincular el subinforme
 ver jduro.inf/rpt.
 Esto se ha realizado para el cliente 5541 comentarlo con Sergio
*/
|PROCESO &Grupo;
     nDiv = enContaLin / enLineas;
     enGrupo = nDiv ! 0;
     |SI enGrupo > nDiv;
          enGrupo = enGrupo - 1;
     |FINSI;
     enContaLin = enContaLin + 1;
|FPRC;


|PROCESO IdiomaArticulo;
     aAlfa = "";
     |ABRE #225;
     #225#0 = #3#205;
     |LEE 000#225=;
     |SI FSalida = 0;
          |ABRE #156;
          #156#0 = aArti;
          #156#1 = #225#5;
          |LEE 000#156=;
          |SI FSalida = 0;
               aAlfa = #156#2; |QBF aAlfa;
          |FINSI;
          |CIERRA #156;
     |FINSI;
     |CIERRA #225;
|FPRC;

|PROCESO SatAux;
     enExplo = #referen@#0;
     enCampa = #referen@#1;
     eaSocio = #referen@#2;
     eaConta = #referen@#3;
     enMes = #referen@#4;
     enAno = #referen@#5;
     enSat = 1;
     |PRINT;
     enSat = 0;
|FPRC;

|DEFBUCLE SatAux;
     #referen@#3002;
     ;
     #1#48, #1#0;
     #1#48, #1#0;
     ;
     NULL, SatAux;
|FIN;

|PROCESO ImpSAT;
     |HAZ EsSAT;
     |SI FSalida = 0;
          |DDEF aAlfa;
          aAlfa = aAlfa + "collm011";
          |CARGA_DEF aAlfa, referen@;
          |SI FSalida = 0;
               |BUCLE SatAux;
               |DESCARGA_DEF #referen@;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO &Hora;     || Para el informe del modulo 002472 (iber21)
     enHora = "";
|FPRC;

|PROCESO Encriptacion;
   nNumChar = 0;
   nCalc    = 0;
   nCont    = 0;
   eaSalida = "";
   aAlfa = eaEntrada; |QBF aAlfa;
   aAlfa = aAlfa % 0; nNumChar = aAlfa;
   |PARA nCont = 1; |SI nCont [ nNumChar; |HACIENDO nCont = nCont + 1;
      nCalc = (nCont * 100) + 1; aAlfa = eaEntrada % nCalc;
      nCalc = &aAlfa;
      |SI nCalc > 79;
         nCalc = 79 - (nCalc - 79);
      |SINO;
         nCalc = 79 + (79 - nCalc);
      |FINSI;
      eaSalida = eaSalida + &nCalc;
   |SIGUE;
|FPRC;

|PROCESO ImpresionFE;
     eaArCodCli = #agifa084#3;  || Codigo Cliente
     eaArNomCli = #agifa084#4;  || Nombre Cliente

     #3#0 = #agifa084#3;
     |LEE 000#3=;
     |SI FSalida ! 0;
          |DDEFECTO #3;
     |FINSI;

     eaArCodCif = #3#15;  || Cif
     eaArNomCif = #agifa084#4;  || Nombre Cif

     eaArTipoDoc = "FD";
     eaArSerDoc = #agifa084#48;
     enArNumDoc = #agifa084#0;
     eaArFecDoc = #agifa084#1;

     eaDirDesFE = #3#197;
     eaFirmarFE = #3#212;
     eaSwEnvioCorreo = #3#213;
     eaAplicacion = "dscomer9";
     eaDefFE = "agifa084";
     eaEmpresaFE = ("00000" + #48#0) % -105;
     eaSerieFE = #1#48;
     eaNumeroFE = #1#0;
     eaDefLinFe = "agifa069";
     eaDefEmpFe = "agifa280";
     eaDefCliFe = "agifa024";
     eaDefIvaFe = "agifa066";
     eaCodCliFe = #1#3;
     eaDefAAPPFe = "agifa281";
     eaDefDatosPagoFe = "agifa133";
     eaDefEmpSerieFe = "agifa284";

     |SI nSwHayPDF = 1;
          eaFacturaPDFFe = aFicheroPDF;
     |FINSI;

     |SUB_EJECUTA ":dsarchi/dsarz011.tab";

     |HAZ EmulaImpresion;
|FPRC;

|PROCESO EsGrupoOTP;
     nGrupoOTP = 0;

     |DBASS aBase;  |QBF aBase;
     aFichero = aBase + "dspreven/dspreven.ini";

     |XABRE "", aFichero, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |PARA;  |SI;  |HACIENDO;
             |XLEE nHandle, 250, aAlfa;
             |SI FSalida < 0;  |SAL;  |FINSI;

             |SI aAlfa = "GrupoOTP";
                 nGrupoOTP = 1;
                 |SAL;
             |FINSI;
     |SIGUE;

     |XCIERRA nHandle;
|FPRC;

|PROCESO Impresion;
     |HAZ EsGuerola;
     |SI FSalida = 0;
          |HAZ GuerImpCerti;
     |FINSI;

     |SI nSwPackList = 0;
          eaDoc = "FD" + #1#48 + #1#0;
          |HAZ PackListVar;
     |FINSI;

     |SI nSwTpv = 0;
          |ABRE #501;
          |SELECT #2#501;
          #501#35 = "F";
          #501#57 = #1#48;
          #501#58 = #1#0;
          |LEE 000#501=;
          |SI FSalida = 0;
               |ABRE #505;
               #505#0 = #501#12;
               |LEE 000#505=;
               |CIERRA #505;
          |FINSI;
          |CIERRA #501;
     |FINSI;

     aDivisa = #agifa084#65;
     aMoneda = #agifa084#67;
     |HAZ Divisas084;
     nSw = 0;
     venci1 = @;
     venci2 = @;
     venci3 = @;
     venci4 = @;
     venci5 = @;
     venci6 = @;
     venci7 = @;
     venci8 = @;
     venci9 = @;
     venci10= @;
     venci11= @;
     venci12= @;

     impor1 = 0;
     impor2 = 0;
     impor3 = 0;
     impor4 = 0;
     impor5 = 0;
     impor6 = 0;
     impor7 = 0;
     impor8 = 0;
     impor9 = 0;
     impor10= 0;
     impor11= 0;
     impor12= 0;
     nSw = 0;

     |ABRE #6;
     |DDEFECTO #6;
     #6#0 = #1#8;
     |LEE 000#6=;
     |CIERRA #6;

     #0#11 = 0;
     #0#12 = "01.01.0000";

     |ABRE #17;
     |DDEFECTO #17;
     #17#4 = #1#48;
     #17#0 = #1#0;
     #17#1 = 0;
     |LEE 001#17];
     |PARA ; |SI FSalida = 0; |Y #17#0 = #1#0;|Y #17#4 = #1#48; |HACIENDO;
          |SI #6#70 ! 0; || Fianza Retenida, es el ultimo recibo
               |SALVA_FICHA #17;
               |LEE 000#17s;
               |SI FSalida ! 0; |O #17#0 ! #1#0; |O #17#4 ! #1#48;
                    |REPON_FICHA #17;
                    #0#11 = #17#2;
                    #0#12 = #17#3;
                    |SAL;
               |FINSI;
               |REPON_FICHA #17;
          |FINSI;
          nSw = nSw + 1;
          |SI nSw = 1;
               venci1 = #17#3;
               impor1 = #17#2;
          |FINSI;
          |SI nSw = 2;
               venci2 = #17#3;
               impor2 = #17#2;
          |FINSI;
          |SI nSw = 3;
               venci3 = #17#3;
               impor3 = #17#2;
          |FINSI;
          |SI nSw = 4;
               venci4 = #17#3;
               impor4 = #17#2;
          |FINSI;
          |SI nSw = 5;
               venci5 = #17#3;
               impor5 = #17#2;
          |FINSI;
          |SI nSw = 6;
               venci6 = #17#3;
               impor6 = #17#2;
          |FINSI;
          |SI nSw = 7;
               venci7 = #17#3;
               impor7 = #17#2;
          |FINSI;
          |SI nSw = 8;
               venci8 = #17#3;
               impor8 = #17#2;
          |FINSI;
          |SI nSw = 9;
               venci9 = #17#3;
               impor9 = #17#2;
          |FINSI;
          |SI nSw = 10;
               venci10= #17#3;
               impor10= #17#2;
          |FINSI;
          |SI nSw = 11;
               venci11= #17#3;
               impor11= #17#2;
          |FINSI;
          |SI nSw = 12;
               venci12= #17#3;
               impor12= #17#2;
          |FINSI;
          |LEE 001#17s;
     |SIGUE;
     |CIERRA #17;

     #3#0 = #1#3;
     |LEE 021#3=;
     |SI 0 ! FSalida; |DDEFECTO #3; |FINSI;

     |HAZ mirainf;

     iva1 = #1#50; re1 = #1#51;
     iva2 = #1#52; re2 = #1#53;
     iva3 = #1#54; re3 = #1#55;
     iva4 = #1#56; re4 = #1#57;
     iva5 = #1#58; re5 = #1#59;



/*
*************** buscar Tiquet 3134/395

     aAuxCrys = Impresora % 113;
     |QBF aAuxCrys;
     |SI aAuxCrys ! "CrystalReport";
          |PULSATECLA;
          |PARA; |SI; |HACIENDO;
               eaImpMotorCrystal = Impresora;
               enSwBorraCabDet = 0;
               |HAZ BorraCabDetCrystal;

               |SI enSwBorraCabDet = 1;    ||He borrado cabecera/detalle .dbf
                    |SAL;
               |SINO;                      ||No he podido borra cabecera/detalle .dbf
                    aMensaje = "0000SEl proceso de impresion esta ocupado, Continuar?";
                    |CONFI aMensaje;
                    |SI FSalida = 0;
                         ||Volvemos a intetar borrar.
                    |SINO;
                         nSwSalirProg = 1;
                         |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;
          |SI nSwSalirProg = 1;
               |FINIMP;
               |ACABA;
          |FINSI;
          |INFOR informe;
     |SINO;
          |SI aInfCrystal = informe;
               FSalida = 0;
          |SINO;
               |SI aInfCrystal ! "";
                    |FININF;
               |FINSI;
               |PULSATECLA;
               |PARA; |SI; |HACIENDO;
                    eaImpMotorCrystal = Impresora;
                    enSwBorraCabDet = 0;
                    |HAZ BorraCabDetCrystal;

                    |SI enSwBorraCabDet = 1;    ||He borrado cabecera/detalle .dbf
                         |SAL;
                    |SINO;                      ||No he podido borra cabecera/detalle .dbf
                         aMensaje = "0000SEl proceso de impresion esta ocupado, Continuar?";
                         |CONFI aMensaje;
                         |SI FSalida = 0;
                              ||Volvemos a intetar borrar.
                         |SINO;
                              nSwSalirProg = 1;
                              |SAL;
                         |FINSI;
                    |FINSI;
               |SIGUE;
               |SI nSwSalirProg = 1;
                    |FINIMP;
                    |ACABA;
               |FINSI;
               |INFOR informe;
              || aInfCrystal = informe;
          |FINSI;
     |FINSI;
     |SI FSalida = 0;
          |PARA nCopia = #3#210; |SI nCopia ] 0; |HACIENDO nCopia = nCopia - 1;
               |SI nCopia = #3#210;
                    eaTipoCopia = "ORIGINAL";
               |SINO;
                    eaTipoCopia = "COPIA";
               |FINSI;

               |BUCLELIN 0 conimprl #1;
               |HAZ conimpr2;
          |SIGUE;
     |FINSI;

     |SI aAuxCrys = "CrystalReport";
          |FININF;
          aInfCrystal = "";
     |FINSI;
     ||ARA11

******** lo nuevo *****************
*/


     |SI Impresora = "CrystalReport";
          |PARA nCopia = #3#210; |SI nCopia ] 0; |HACIENDO nCopia = nCopia - 1;
               |SI nCopia = #3#210;
                    eaTipoCopia = "ORIGINAL";
               |SINO;
                    eaTipoCopia = "COPIA";
               |FINSI;
               |PARA; |SI; |HACIENDO;
                    eaImpMotorCrystal = Impresora;
                    enSwBorraCabDet = 0;
                    |HAZ BorraCabDetCrystal;

                    |SI enSwBorraCabDet = 1;    ||He borrado cabecera/detalle .dbf
                         |SAL;
                    |SINO;                      ||No he podido borra cabecera/detalle .dbf
                         aMensaje = "0000SEl proceso de impresion esta ocupado, Continuar?";
                         |CONFI aMensaje;
                         |SI FSalida = 0;
                              ||Volvemos a intetar borrar.
                         |SINO;
                              nSwSalirProg = 1;
                              |SAL;
                         |FINSI;
                    |FINSI;
               |SIGUE;
               |SI nSwSalirProg = 1;
                    |FINIMP;
                    |ACABA;
               |FINSI;
               |INFOR informe;
               |SI FSalida = 0;
                    |BUCLELIN 0 conimprl #1;
                    |HAZ ImpSAT;
                    |PIEINF;
                    |HAZ FinImpre;
                    |FININF;
               |FINSI;
          |SIGUE;
     |SINO;
          |PARA; |SI; |HACIENDO;
               eaImpMotorCrystal = Impresora;
               enSwBorraCabDet = 0;
               |HAZ BorraCabDetCrystal;

               |SI enSwBorraCabDet = 1;    ||He borrado cabecera/detalle .dbf
                    |SAL;
               |SINO;                      ||No he podido borra cabecera/detalle .dbf
                    aMensaje = "0000SEl proceso de impresion esta ocupado, Continuar?";
                    |CONFI aMensaje;
                    |SI FSalida = 0;
                         ||Volvemos a intetar borrar.
                    |SINO;
                         nSwSalirProg = 1;
                         |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;

          |SI nSwSalirProg = 1;
               |FINIMP;
               |ACABA;
          |FINSI;

          |SI nSwSanchez = 0; |HAZ AgruArtiIni; |FINSI;

          |INFOR informe;
          |SI FSalida = 0;
               |PARA nCopia = #3#210; |SI nCopia ] 0; |HACIENDO nCopia = nCopia - 1;
                    |SI nCopia = #3#210;
                         eaTipoCopia = "ORIGINAL";
                    |SINO;
                         eaTipoCopia = "COPIA";
                    |FINSI;

                    |BUCLELIN 0 conimprl #1;
                    |HAZ ImpSAT;
                    |PIEINF;
                    |HAZ FinImpre;
               |SIGUE;
               |FININF;

               |HAZ EsGrupoOTP;
               |SI nGrupoOTP = 1;
                   eaFacturaPDFOTP = aFicheroPDF;
                   eaZonaBase      = #48#0;
                   |SUB_EJECUTA ":dspreven/dspvz905";
               |FINSI;
          |FINSI;

          |SI nSwSanchez = 0; |HAZ AgruArtiFin; |FINSI;
     |FINSI;
|FPRC;

|PROCESO DesAmpli;
     |DDEFECTO #2;
     #2#1 = nLinFac;
     #2#3 = 0;      || Almacen
     #2#4 = #53#5;
     descrip = #2#4;
     codigo  = "";
     dto     = "";
     dto1    = "";
     precio  = "";
     unid    = "";
     imptot  = "";
     tiva    = "";
     enSwDA = 1;
     enLinDA = #53#4; ||para hacer un grupo en el crystal y salga ordenadas
     |PRINT;
     enLinDA = 0;
     enSwDA = 0;
|FPRC;

|DEFBUCLE DesAmpli;
     #53#1;
     ;
     "F", #2#20, #2#0, #2#1, 0001;
     "F", #2#20, #2#0, #2#1, 9999;
     ;
     NULL, DesAmpli;
|FIN;

|PROCESO dsm00048;
     unid = #2#5 * #148#5;
     |PRINT;
|FPRC;

|DEFBUCLE dsm00048;
     #148#1;
     ;
     #2#20, #2#0, #2#1, 001;
     #2#20, #2#0, #2#1, 999;
     ;
     NULL, dsm00048;
|FIN;

|PROCESO LeeLote;
     eaLote = "";
     |ABRE #100;
     #100#0 = #2#20;
     #100#1 = #2#0;
     #100#8 = #2#1;
     #100#5 = "";
     |LEE 000#100];
     |SI #100#0 = #2#20; |Y #100#1 = #2#0; |Y #100#8 = #2#1;
          eaLote = #100#5;
     |FINSI;
     |CIERRA #100;
|FPRC;

|PROCESO ConverCliArt
     |ABRE #109; |SELECT #2#109;
     #109#0 = #1#3;
     #109#2 = #2#2;
     |LEE 000#109=;
     |SI FSalida = 0;
          enCliArt = 1;
     |SINO;
          enCliArt = 0;
          #109#3 = #109#2;    || pongo el original sino esta, asi no es
          #109#4 = #2#4;      ||/necesario condicionar la linea en el inf
     |FINSI;
     |CIERRA #109;
|FPRC;

|PROCESO conimprl;|TIPO 0;
     eaSerLog = #2#20;
     eaNumLog = (A\("000000" + #2#0) % -106);
     eaTipLog = "FD";
     |HAZ ImprimeLog;

     |HAZ LeeLote;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ Modulo 000654
     |HAZ EsTagloma;
     |SI FSalida = 0;
          |SI eaSerieTa ! #2#20; |O enCodigTa ! #2#0;
               eaSerieTa = #2#20;
               enCodigTa = #2#0;
               eaTipo = "F";
               |HAZ TagloImpBlock;
          |FINSI;
          |SI #2#13 = "FMB"; |ACABA; |FINSI;
          |HAZ ImpUniFami;
          |HAZ TagPostFormado;
          |SI aEsPostFormaso = "S"; |ACABA; |FINSI;
     |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     enArtImp = #2#2; |QBF enArtImp;
     codigo  = #2#2;
     descrip = #2#4;
     dto     = #2#8;
     dto1    = #2#21;
     precio  = #2#6;
     unid    = #2#5;
     imptot  = #2#27;
     tiva    = #2#11;
     linea   = 1;
     digito  = #2#4 % "101";
     ascii   = &digito;
     |SI codigo = "9999999999999";||Puesto para Ciagan;
         impal = impal + #2#9;
         codigo = " ";
     |FINSI;

     |SI codigo = "9999999999998";
         trans = trans + #2#9;
         codigo = " ";
     |FINSI;

     |HAZ ConverCliArt;

     |HAZ EsAparecida;
     |SI FSalida = 0;
          eaArticulo = #2#2;
          |HAZ ImpAparecida;
     |FINSI;

     aArti = #2#2;
     |HAZ IdiomaArticulo;
     |SI aAlfa ! "";
          #2#4 = aAlfa;
          descrip = aAlfa;
     |FINSI;

     |SI nSwFriesa = 0;
          |HAZ FriImpFC;      || modulo 001690
     |SINO;
          |PRINT;             || La estandar
     |FINSI;
     nLinFac = #2#1;
     |SALVA_DATOS #2;
     |BUCLE DesAmpli;
     |REPON_DATOS #2;

     |HAZ impdesam;
     |SI #41#16 = "S";
          eaArticulo = #2#2;
          |HAZ EsEscandallo;
          |SI FSalida = 0;
               |HAZ EsKit;
               |SI FSalida = 0;
                    enEscan = 2;
                    |BUCLE dsm00048;
               |SINO;
                    enEscan = 1;
                    |BUCLELIN 0escanlinea#15;
               |FINSI;
               enEscan = 0;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO impdesam;|TIPO 0;
     #13#0 = #2#18;
     |ABRE #13;
     |LEE 101#13=;
     |SI 0=FSalida
          |HAZ xx;
     |FINSI;
     |LIBERA #13;
     |CIERRA #13;
|FPRC;

|PROCESO xx;
     indtope=0;
     |PARA ind=6;|SI ind>0;|HACIENDO ind=ind-1;
          descrip=#13ind;
          |QBF descrip;
          |SI descrip ! vacio;
               indtope=ind+1;
               ind=0;
          |FINSI;
     |SIGUE;

     |PARA ind=1;|SI ind < indtope;|HACIENDO ind=ind+1;
          descrip=#13ind;
          linea=0;
          |PRINT;
     |SIGUE;
|FPRC;

|PROCESO FinImpre;

     |SI #1#10 = AN; |Y #41#47 = "S"; |Y #0#6 = "N"; |Y #6#76 = "S";
          |SI #41#146 ! "N"; |O #1#73 ! 0;
               |HAZ crearec;
          |FINSI;
     |FINSI;
     #1#10 = AS;
     |GRABA 020#1a;

     enContaLin = 0;
|FPRC;

|PROCESO conimpr2;|TIPO 0;
nContaImp = nContaImp + 1;
|SI DEBUG > 0; |O  MENAV > 0;
     |SI MENAV > 0;
          aAlfa = "0000Conta:" + nContaImp;
          |MENAV aAlfa;
     |FINSI;
     |SI nContaImp = DEBUG;
          |DEBUG;
     |FINSI;
|FINSI;

     |PIEINF;
     |HAZ FinImpre;
     |SI Impresora ! "CrystalReport";
          |SI nCopia = 0;
               |FININF;
          |FINSI;
     |SINO;
          |SI aInfCrystal ! informe;
               aInfCrystal = informe;
          |FINSI;
     |FINSI;

     impal = 0;
     trans = 0;
|FPRC;

|PROCESO PreFirmaFactura;
     #3#0 = #agifa084#3;
     |LEE 000#3=;
     |SI FSalida ! 0;
          |DDEFECTO #3;
     |FINSI;

     |SI #3#212 = "S";
          |HAZ FirmaFactura;
     |SINO;
          |SI nSwHazOTP ! 1;     ||Estandar
               |HAZ Impresion;
          |SINO;
               #agifa086#9 = "P";
               |HAZ ImpresionOTP;
          |FINSI;
     |FINSI;
     |SI nSwSalirProg = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE MultFacArchi;
     #1#1;
     3,1,10;
     #0#7, #0#2, #0#0, #0#4, #0#6;
     #0#8, #0#3, #0#1, #0#5, #0#6;
     e;
     NULL, PreFirmaFactura;
|FIN;

|DEFBUCLE MultFacArchiSolo;
     #1#1;
     3,1,10;
     #0#7, #0#2, #0#0, #0#4, #0#6;
     #0#8, #0#3, #0#1, #0#5, #0#6;
     e;
     NULL, FirmaFactura;
|FIN;

|DEFBUCLE MultFac;
     #1#1;
     3,1,10;
     #0#7, #0#2, #0#0, #0#4, #0#6;
     #0#8, #0#3, #0#1, #0#5, #0#6;
     e;
     NULL,Impresion;
|FIN;

|DEFBUCLE MultFacOTP;
     #1#1;
     3,1,10;
     #0#7, #0#2, #0#0, #0#4, #0#6;
     #0#8, #0#3, #0#1, #0#5, #0#6;
     e;
     NULL, ImpresionOTP;
|FIN;

|PROCESO RellenaTempoImpresion;
     ||Leo el cliente.
     #3#0 = #agifa084#3;
     |LEE 000#3=;
     |SI FSalida ! 0;
          |DDEFECTO #3;
     |FINSI;

     |DDEFECTO #1002;
     |SI #3#212 = "S";
          #1002#0 = 1;
          nSwFacArchivo = nSwFacArchivo + 1;
     |SINO;
          #1002#0 = 0;
          nSwImpPapel = nSwImpPapel + 1;
     |FINSI;
     #1002#1 = #1#48;
     #1002#2 = #1#0;
     |LEE 101#1002.=;
     |SI FSalida ! 0;
          |GRABA 020#1002.n;
     |FINSI;
     |LIBERA #1002;
|FPRC;

|DEFBUCLE RellenaTempoImpresion;
     #1#1;
     3,1,10;
     #0#7, #0#2, #0#0, #0#4, #0#6;
     #0#8, #0#3, #0#1, #0#5, #0#6;
     ;
     NULL, RellenaTempoImpresion;
|FIN;

|PROCESO TempoFacturas;
     |ABRE #1;
     |DDEFECTO #1;
     #1#48 = #1002#1;
     #1#0 = #1002#2;
     |LEE 101#1.=;

     ||SI es nSwModoArchivo = 0.  Imprimir la factura
     ||SINO ... facturaE ... (si es PDF, primero creo el pdf y luego Facturae)

     |SI nSwModoArchivo = 0;
          |SI nSwHazOTP = 1;
               |HAZ ImpresionOTP;
          |SINO;
               |HAZ Impresion;
          |FINSI;
     |SINO;
          |HAZ ControlaSiFacturaPDF;
     |FINSI;

     |LIBERA #1;
     |CIERRA #1;
     |SI nSwSalirProg = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE TempoFacturas;
 #1002#1;
 ;
 nSwModoArchivo, "     ", 000001;
 nSwModoArchivo, "zzzzz", 999999;
 ;
 NULL, TempoFacturas;
|FIN;

|PROCESO conim;|TIPO 3;
     |ABRE #3;
||     Impresora = "CrystalReport;c:\ds\crystal\agifa086.pdf";
||     |IMPRE -1;

       |SI nSwHazOTP ! 1;     ||Estandar
          |SI nArchi = 1;
               |HAZ LeeSelImpFactuE;
               aMenu2 = eaSelFactuE;

               nOpcion = 0;
               |MENU aMenu;
               |SI FSalida < 1; |O FSalida > 3; |ACABA; |FINSI;
               nOpcion = FSalida;
               eaSelFactuE = nOpcion;
               |HAZ GrabaSelImpFactuE;

               |SI nOpcion = 1;
                    nDentroBucle = 1;
                    nSwUnaFactura = 0;
                    |BUCLE MultFacArchiSolo;  ||Estandar + SOLO ARCHIVA (NO IMPRIME)
                    nDentroBucle = 0;
               |FINSI;
               |SI nOpcion = 2;
                    |IMPRE 5;
                    |SI 0 = FSalida;
                        nDentroBucle = 1;
                        |BUCLE MultFac;      ||Estandar
                        nDentroBucle = 0;
                        |SI Impresora = "CrystalReport";
                            |FININF;
                        |FINSI;
                        |FINIMP;
                    |FINSI;
               |FINSI;

               |SI nOpcion = 3;
/*
                    ||ESTO YA NO SE USA. ES EL METODO ANTERIOR, AL USO DEL TEMPORAL
                    |IMPRE 5;
                    |SI 0 = FSalida;
                        nSwUnaFactura = 0;
                        |BUCLE MultFacArchi;  ||Estandar + DSARCHI (con firmado opcional)
                        |SI Impresora = "CrystalReport";
                            |FININF;
                        |FINSI;
                        |FINIMP;
                    |FINSI;
*/

                    ||ARA11
                    |HAZ CreaTempo; aTempo1002 = Tempo;
                    |NOME_DAT #1002 aTempo1002; |DELINDEX #1002;
                    |ABRE #1002;

                    nSwImpPapel = 0;
                    nSwFacArchivo = 0;
                    |BUCLE RellenaTempoImpresion;
                    |SI nSwImpPapel > 0;
                         |IMPRE 5;
                         |SI FSalida = 0;
                              nSwModoArchivo = 0;
                              |BUCLE TempoFacturas;
                         |FINSI;
                         |FINIMP;
                    |FINSI;
                    |SI nSwSalirProg = 0;
                         |SI nSwFacArchivo > 0;
                              nSwModoArchivo = 1;
                              |BUCLE TempoFacturas;
                         |FINSI;
                    |FINSI;
                    |CIERRA #1002;
                    |DELINDEX #1002; Tempo = aTempo1002; |HAZ BoraTempo;
               |FINSI;
          |SINO;
               |IMPRE 5;
               |SI 0 = FSalida;
                   nDentroBucle = 1;
                   |BUCLE MultFac;      ||Estandar
                   nDentroBucle = 0;
                   |SI Impresora = "CrystalReport";
                       |FININF;
                   |FINSI;
                   |FINIMP;
               |FINSI;
          |FINSI;
       |SINO;                 || Modulo OTP
          |SI #agifa086#9 = "P"; |O #agifa086#9 = "A";
              |IMPRE 0; aImpre = Impresora;
              nDentroBucle = 1;
              |BUCLE MultFacOTP;
              nDentroBucle = 0;
              |SI Impresora = "CrystalReport";
                  |FININF;
              |FINSI;
              |FINIMP;
          |FINSI;
          |SI #agifa086#9 = "C"; |O #agifa086#9 = "A";
               nSwMailOTP = 1;
               nDentroBucle = 1;
               |BUCLE MultFacOTP;
               nDentroBucle = 0;
               nSwMailOTP = 0;
          |FINSI;
          |SI #agifa086#9 = "E";
               |HAZ CreaTempo; aTempo1002 = Tempo;
               |NOME_DAT #1002 aTempo1002; |DELINDEX #1002;
               |ABRE #1002;

               ||ARA112
               nSwImpPapel = 0;
               nSwFacArchivo = 0;
               |BUCLE RellenaTempoImpresion;
               |SI nSwImpPapel > 0;
                    |IMPRE 5;
                    |SI FSalida = 0;
                         nSwMailOTP = 0;
                         nSwModoArchivo = 0;
                         |BUCLE TempoFacturas;
                    |FINSI;
                    |SI Impresora = "CrystalReport";
                         |FININF;
                    |FINSI;
                    |FINIMP;
               |FINSI;
               |SI nSwSalirProg = 0;
                    |SI nSwFacArchivo > 0;
                         nSwModoArchivo = 1;
                         |BUCLE TempoFacturas;
                    |FINSI;
               |FINSI;
               |CIERRA #1002;
               |DELINDEX #1002; Tempo = aTempo1002; |HAZ BoraTempo;

/*
                   ||SISTEMA ORIGINAL. AHORA SEPARAMOS LAS FACTURAS EN 2 GRUPOS. IMPRESION Y FACTURAE
                   |IMPRE 0; aImpre = Impresora;
                   nSwUnaFactura = 0;
                   |BUCLE MultFacArchi;  ||Estandar + DSARCHI (con firmado opcional)
                   |SI Impresora = "CrystalReport";
                       |FININF;
                   |FINSI;
                   |FINIMP;
*/
          |FINSI;
       |FINSI;
     |CIERRA #3;
|FPRC;

|PROCESO escanlinea;
    unid = #16#4 * #2#5;
    descrip = #16#3;
    codigo = "";
    dto = 0;
    precio = 0;
    imptot = 0;
    tiva = 0;
    linea = 1;

     aArti = #16#2;
     |HAZ IdiomaArticulo;
     |SI aAlfa ! "";
          #16#3 = aAlfa;
          descrip = aAlfa;
     |FINSI;

     |PRINT;
|FPRC;

|PROCESO mirainf;
     |ABRE #40;
     #40#26 = #1#48;
     |LEE 001#40=;
     |SI FSalida = 0;
          aAlfa = #40#11; |QBF aAlfa;
          |SI informe ! aAlfa;
             nSwInfor = 0;
          |FINSI;
          informe = #40#11; |QBF informe;
     |SINO;
          informe = "agifa084";
     |FINSI;
     |CIERRA #40;
|FPRC;

|PROCESO crearec;
     |ABRE #17;
     #17#0 = #1#0;
     #17#4 = #1#48;
     #17#1 = 0;
     |LEE 001#17];
     nVto = 0;
     |SI FSalida ! 0; |O #17#0 ! #1#0;  |O #17#4 ! #1#48;
         |HAZ VenciDir;
     |FINSI;

     |ABRE #99;
     nVto = 0;
     #17#0 = #1#0;
     #17#4 = #1#48;
     #17#1 = 0;
     |LEE 001#17];
     |PARA ; |SI FSalida = 0; |Y #17#0 = #1#0;|Y #17#4 = #1#48; |HACIENDO;
          nVto = nVto + 1;
          |LEE 001#17s;
     |SIGUE;

     |HAZ AbreRecVenta;

     nRecibo = 0;
     #17#0 = #1#0;
     #17#4 = #1#48;
     #17#1 = 0;
     |LEE 001#17];
     |PARA ; |SI FSalida = 0; |Y #17#0 = #1#0;|Y #17#4 = #1#48; |HACIENDO;
          |DDEFECTO #11;
          #11#17 = #1#48;
          #11#0  = #1#0;
          #11#1  = #17#1;           || Linea;
          #11#2  = #1#3;            || cliente
          #11#3  = #1#4;            || nombre del cliente
          #11#4  = #3#29;           || Banco
          #11#5  = "S";             || domiciliado
          #11#6  = "N";             || aceptado
          #11#7  = #1#1;            || fecha de emision
          #11#8  = #17#3;           || Fecha de vencimiento
          #11#9  = #17#2;           || Importe
          #11#10 = "N";            || Impreso
          #11#11 = "N";            || Contabilizado
          #11#12 = #1#40;

          |ABRE #6;
          |DDEFECTO #6;
          #6#0 = #1#8;
          |LEE 000#6=;
          |CIERRA #6;
          |SI #41#63 = "S";
               #99#0 = #6#69;
               |LEE 000#99=;
               |SI FSalida = 0;
                    #11#12 = #99#3;     || NUMERO CTA.CONTABLE.
               |SINO;
                    #11#12 = #1#40;     || NUMERO CTA.CONTABLE.
               |FINSI;
          |SINO;
               #11#12 = #1#40;          || NUMERO CTA.CONTABLE.
          |FINSI;
          #11#13 = "N";            || Cobrado
          #11#14 = "N";            || Impagado
          #11#15 = #3#161;         || A aceptar
          #11#16 = "01.01.0000";   || fecha de cobro
          #11#18 = #1#40;          || Cta
          #11#21 = #6#69;          || Tipo de Recibo (forma de pago)
          nRecibo = nRecibo + 1;
          |SI nRecibo = nVto; |Y #6#70 ! 0;
               #11#21 = #6#73;     || Tipo de Recibo (Fianza retenida)
          |FINSI;
          #11#22 = "Pdte. Cobro";
          #11#23 = nVto;
          #11#24 = #6#0;
          #11#25 = #6#1;

          #11#26 = "";
          #11#27 = "";
          #11#29 = "";
          #11#28 = "";
          #11#30 = "";
          |SI nSwHazOTP = 1;
               eAlfa1 = "_"; eAlfa2 = ""; eAlfa3 = ""; eAlfa4 = ""; eAlfa5 = "";
               eaCliente = #1#3;
               |HAZ CtaOTP;
               |QBF eAlfa5;
               |SI eAlfa5 ! "";
                    #11#4  = eAlfa5; ||Nom Banco
               |FINSI;

               aAlfa = #1#93 % 104;  #11#26 = aAlfa;
               aAlfa = #1#93 % 504;  #11#27 = aAlfa;
               aAlfa = #1#93 % 902;  #11#28 = aAlfa;
               aAlfa = #1#93 % 1110; #11#29 = aAlfa;
                                     #11#30 = #1#104;
          |FINSI;

          eaProg = "agifa084";
          ||HAZ CreaRecVenta;
          |HAZ RecVenta;
          |LEE 001#17s;
     |SIGUE;
     |CIERRA #17;
     |CIERRA #99;
     enDirEnt = #agifa084#91; |HAZ CierraRecVenta;
|FPRC;

|DEFBUCLE UnaFac;
     #1#1;
     10;
     #0#7, #0#2, #0#6;
     #0#8, #0#3, #0#6;
     e;
     NULL, Impresion;
|FIN;

|DEFBUCLE UnaFacFE;
     #1#1;
     10;
     #0#7, #0#2, #0#6;
     #0#8, #0#3, #0#6;
     e;
     NULL, ControlaSiFacturaPDF;
|FIN;


|PROCESO QuitaRaros;
     |QBF aAlfa;
     aCadena = "";
     aLen    = aAlfa % 0;
     nLen    = aLen;
     |PARA nCampo = 1;  |SI nCampo [ nLen;  |HACIENDO nCampo = nCampo + 1;
           nPosi = (100 * nCampo) + 1;
           aCaracter = aAlfa % nPosi;
           |SI aCaracter = "¥";  aCaracter = &209; |FINSI;
           |SI aCaracter = "¤";  aCaracter = &241; |FINSI;
           |SI aCaracter = " ";  aCaracter = &225; |FINSI;
           |SI aCaracter = "‚";  aCaracter = &233; |FINSI;
           |SI aCaracter = "¡";  aCaracter = &237; |FINSI;
           |SI aCaracter = "¢";  aCaracter = &243; |FINSI;
           |SI aCaracter = "£";  aCaracter = &250; |FINSI;
           |SI aCaracter = "§";  aCaracter = &176; |FINSI;
           |SI aCaracter = "¦";  aCaracter = &170; |FINSI;
           aCadena = aCadena + aCaracter;
     |SIGUE;
     aAlfa = aCadena;
|FPRC;

|PROCESO CuerpoDocumento;
     aQueEmpresa = "";

     |DBASS aBaseCorreo;  |QBF aBaseCorreo;
     aAlfa = aBaseCorreo + "dspreven/def/pycm0013.mas";
     |CARGA_DEF aAlfa, BasesOTP@;
     |SI FSalida = 0;
         aAlfa = aBaseCorreo + "dspreven/fich/" + eaEmpresa + "/";
         |PATH_DAT #953 aAlfa;
         |ABRE #953;
         |LEE 000#953p;
         |SI FSalida ! 0; |DDEFECTO #953; |FINSI;
         |CIERRA #953;

         aQueEmpresa = #953#11;

         |DESCARGA_DEF #BasesOTP@;
     |FINSI;

     aAbre = aBaseCorreo + "dspreven/documentos/tmp/";  |MKDIR aAbre;
     aAbre = aBaseCorreo + "dspreven/documentos/tmp/cuerpofactura.txt";

     |XABRE "BW", aAbre, nHandle;
     aAlfa = #otpm0006@#5; |QBF aAlfa; |HAZ QuitaRaros; aAlfa = aAlfa + &13 + &10; |XGRABA nHandle, aAlfa;
     aAlfa = #otpm0006@#6; |QBF aAlfa; |HAZ QuitaRaros; aAlfa = aAlfa + &13 + &10; |XGRABA nHandle, aAlfa;
     aAlfa = #otpm0006@#7; |QBF aAlfa; |HAZ QuitaRaros; aAlfa = aAlfa + &13 + &10; |XGRABA nHandle, aAlfa;
     aAlfa = #otpm0006@#8; |QBF aAlfa; |HAZ QuitaRaros; aAlfa = aAlfa + &13 + &10; |XGRABA nHandle, aAlfa;
     aAlfa = #otpm0006@#9; |QBF aAlfa; |HAZ QuitaRaros; aAlfa = aAlfa + &13 + &10; |XGRABA nHandle, aAlfa;
     aAlfa = #otpm0006@#10; |QBF aAlfa; |HAZ QuitaRaros; aAlfa = aAlfa + &13 + &10; |XGRABA nHandle, aAlfa;
     aAlfa = #otpm0006@#11; |QBF aAlfa; |HAZ QuitaRaros; aAlfa = aAlfa + &13 + &10; |XGRABA nHandle, aAlfa;
     aAlfa = #otpm0006@#12; |QBF aAlfa; |HAZ QuitaRaros; aAlfa = aAlfa + &13 + &10; |XGRABA nHandle, aAlfa;
     aAlfa = #otpm0006@#13; |QBF aAlfa; |HAZ QuitaRaros; aAlfa = aAlfa + &13 + &10; |XGRABA nHandle, aAlfa;
     aAlfa = #otpm0006@#14; |QBF aAlfa; |HAZ QuitaRaros; aAlfa = aAlfa + &13 + &10; |XGRABA nHandle, aAlfa;
     |XCIERRA nHandle;
|FPRC;

|PROCESO ImpresionOTP;
     #visalm01@#0 = #agifa084#3;
     |LEE 000#visalm01@.=;
     |SI FSalida ! 0; |DDEFECTO #visalm01@; |FINSI;

     eaDesIVA1 = "% IVA";
     eaDesIVA2 = "Importe IVA";

     |DBASS aAlfa;  |QBF aAlfa;
     aAlfa = aAlfa + "dspreven/def/pycm0004.mas";
     |CARGA_DEF aAlfa, pycm0004@;
     |SI FSalida = 0;
         |DBASS aAlfa;  |QBF aAlfa;
         aAlfa = aAlfa + "dspreven/fich/" + eaEmpresa + "/";
         |PATH_DAT #pycm0004@#aAlfa#;
         |ABRE #pycm0004@;
         #pycm0004@#0 = #visalm01@#5;
         |LEE 000#pycm0004@.=;
         |SI FSalida = 0;
             |SI #pycm0004@#51 = "S";
                 |SI #pycm0004@#7 = 51;  |O #pycm0004@#7 = 52;
                     eaDesIVA1 = "% IPSI";
                     eaDesIVA2 = "Importe IPSI";
                 |SINO;
                     eaDesIVA1 = "% IGIC";
                     eaDesIVA2 = "Importe IGIC";
                 |FINSI;
             |FINSI;
         |FINSI;
         |CIERRA #pycm0004@;
         |DESCARGA_DEF #pycm0004@;
     |FINSI;

     || Reviso si existe la direccion de entrega de la factura antes de emitir.
     ||   En caso contrario, aviso de que no existe.
     |ABRE #dsm00003;
     #dsm00003#0 = #agifa084#3;
     #dsm00003#1 = #agifa084#91;
     |LEE 000#dsm00003.=;
     |SI FSalida ! 0;
        aAlfa = "    Atencion. Factura " + #agifa084#48 + "/" + (("000000" + #agifa084#0) % -106) + " sin datos de envio. Revise la direccion de entrega 001 en candidatos";
        |MENAV aAlfa;
     |FINSI;
     |CIERRA #dsm00003;

     eaPieFact  = "";
     eaPieFact1 = "";
     eaPieFact2 = "";
     |DBASS aAlfa;  |QBF aAlfa;
     aAlfa = aAlfa + "dspreven/def/pycm0013.mas";
     |CARGA_DEF aAlfa, BasesOTP@;
     |SI FSalida = 0;
         |DBASS aAlfa;  |QBF aAlfa;
         aAlfa = aAlfa + "dspreven/fich/" + eaEmpresa + "/"; |PATH_DAT #BasesOTP@#aAlfa#;
         |ABRE #BasesOTP@;
         #BasesOTP@#0 = #48#0;
         |LEE 000#BasesOTP@.=;
         |SI FSalida ! 0;
            #BasesOTP@#0 = "";
            |LEE 000#BasesOTP@.=;
            |SI FSalida ! 0; |DDEFECTO #BasesOTP@; |FINSI;
         |FINSI;

         |PARA nCont1 = 83; |SI nCont1 [ 87; |HACIENDO nCont1 = nCont1 + 1;
            aAlfa = #BasesOTP@#nCont1#; |QBF aAlfa; |QBF eaPieFact;

            |SI eaPieFact ! "";
                eaPieFact = eaPieFact + " " + aAlfa;
            |SINO;
                eaPieFact = aAlfa;
            |FINSI;

            |SI nCont1 [ 85;
               |QBF eaPieFact1;
               |SI eaPieFact1 ! "";
                   eaPieFact1 = eaPieFact1 + " " + aAlfa;
               |SINO;
                   eaPieFact1 = aAlfa;
               |FINSI;
            |SINO;
               |QBF eaPieFact2;
               |SI eaPieFact2 ! "";
                   eaPieFact2 = eaPieFact2 + " " + aAlfa;
               |SINO;
                   eaPieFact2 = aAlfa;
               |FINSI;
            |FINSI;
         |SIGUE;

         |CIERRA #BasesOTP@; |DESCARGA_DEF #BasesOTP@;
     |FINSI;

     |SI nSwPackList = 0;
          eaDoc = "FD" + #1#48 + #1#0;
          |HAZ PackListVar;
     |FINSI;

     |SI nSwTpv = 0;
          |ABRE #501;
          |SELECT #2#501;
          #501#35 = "F";
          #501#57 = #1#48;
          #501#58 = #1#0;
          |LEE 000#501=;
          |SI FSalida = 0;
               |ABRE #505;
               #505#0 = #501#12;
               |LEE 000#505=;
               |CIERRA #505;
          |FINSI;
          |CIERRA #501;
     |FINSI;

     aDivisa = #agifa084#65;
     aMoneda = #agifa084#67;
     |HAZ Divisas084;
     nSw = 0;
     venci1 = @;
     venci2 = @;
     venci3 = @;
     venci4 = @;
     venci5 = @;
     venci6 = @;
     venci7 = @;
     venci8 = @;
     venci9 = @;
     venci10= @;
     venci11= @;
     venci12= @;

     impor1 = 0;
     impor2 = 0;
     impor3 = 0;
     impor4 = 0;
     impor5 = 0;
     impor6 = 0;
     impor7 = 0;
     impor8 = 0;
     impor9 = 0;
     impor10= 0;
     impor11= 0;
     impor12= 0;
     nSw = 0;

     |ABRE #17;
     |DDEFECTO #17;
     #17#4 = #1#48;
     #17#0 = #1#0;
     #17#1 = 0;
     |LEE 001#17];
     |PARA ; |SI FSalida = 0; |Y #17#0 = #1#0;|Y #17#4 = #1#48; |HACIENDO;
          nSw = nSw + 1;
          |SI nSw = 1;
               venci1 = #17#3;
               impor1 = #17#2;
          |FINSI;
          |SI nSw = 2;
               venci2 = #17#3;
               impor2 = #17#2;
          |FINSI;
          |SI nSw = 3;
               venci3 = #17#3;
               impor3 = #17#2;
          |FINSI;
          |SI nSw = 4;
               venci4 = #17#3;
               impor4 = #17#2;
          |FINSI;
          |SI nSw = 5;
               venci5 = #17#3;
               impor5 = #17#2;
          |FINSI;
          |SI nSw = 6;
               venci6 = #17#3;
               impor6 = #17#2;
          |FINSI;
          |SI nSw = 7;
               venci7 = #17#3;
               impor7 = #17#2;
          |FINSI;
          |SI nSw = 8;
               venci8 = #17#3;
               impor8 = #17#2;
          |FINSI;
          |SI nSw = 9;
               venci9 = #17#3;
               impor9 = #17#2;
          |FINSI;
          |SI nSw = 10;
               venci10= #17#3;
               impor10= #17#2;
          |FINSI;
          |SI nSw = 11;
               venci11= #17#3;
               impor11= #17#2;
          |FINSI;
          |SI nSw = 12;
               venci12= #17#3;
               impor12= #17#2;
          |FINSI;
          |LEE 001#17s;
     |SIGUE;
     |CIERRA #17;
     |SI #3#0 ! #1#3;
          #3#0 = #1#3;
          |LEE 021#3=;
          |SI 0 ! FSalida;
                |DDEFECTO #3;
          |FINSI;
     |FINSI;
     |HAZ mirainf;

     iva1 = #1#50; re1 = #1#51;
     iva2 = #1#52; re2 = #1#53;
     iva3 = #1#54; re3 = #1#55;
     iva4 = #1#56; re4 = #1#57;
     iva5 = #1#58; re5 = #1#59;

     |SI nSwMailOTP = 0; || Emision por Impresora
          |SI #agifa086#9 = "P"; |O #agifa086#9 = "A"; |O #agifa086#9 = "E";

/*
*************** buscar Tiquet 3134/395
               |SI Impresora ! "CrystalReport";
                    |PULSATECLA;
                    |PARA; |SI; |HACIENDO;
                         eaImpMotorCrystal = Impresora;
                         enSwBorraCabDet = 0;
                         |HAZ BorraCabDetCrystal;

                         |SI enSwBorraCabDet = 1;    ||He borrado cabecera/detalle .dbf
                              |SAL;
                         |SINO;                      ||No he podido borra cabecera/detalle .dbf
                              aMensaje = "0000SEl proceso de impresion esta ocupado, Continuar?";
                              |CONFI aMensaje;
                              |SI FSalida = 0;
                                   ||Volvemos a intetar borrar.
                              |SINO;
                                   nSwSalirProg = 1;
                                   |SAL;
                              |FINSI;
                         |FINSI;
                    |SIGUE;
                    |SI nSwSalirProg = 1;
                         |FINIMP;
                         |ACABA;
                    |FINSI;
                    |INFOR informe;
               |SINO;
                    |SI aInfCrystal = informe;
                         FSalida = 0;
                    |SINO;
                         |SI aInfCrystal ! "";
                              |FININF;
                         |FINSI;
                         |PULSATECLA;
                         |PARA; |SI; |HACIENDO;
                              eaImpMotorCrystal = Impresora;
                              enSwBorraCabDet = 0;
                              |HAZ BorraCabDetCrystal;

                              |SI enSwBorraCabDet = 1;    ||He borrado cabecera/detalle .dbf
                                   |SAL;
                              |SINO;                      ||No he podido borra cabecera/detalle .dbf
                                   aMensaje = "0000SEl proceso de impresion esta ocupado, Continuar?";
                                   |CONFI aMensaje;
                                   |SI FSalida = 0;
                                        ||Volvemos a intetar borrar.
                                   |SINO;
                                        nSwSalirProg = 1;
                                        |SAL;
                                   |FINSI;
                              |FINSI;
                         |SIGUE;
                         |SI nSwSalirProg = 1;
                              |FINIMP;
                              |ACABA;
                         |FINSI;
                         |INFOR informe;
                        || aInfCrystal = informe;
                    |FINSI;
               |FINSI;
               |PARA nCopia = #3#210; |SI nCopia ] 0; |HACIENDO nCopia = nCopia - 1;
                    |BUCLELIN 0 conimprl #1;
                    |HAZ conimpr2;
               |SIGUE;
          |FINSI;
********************************
*/

|| el Crystal esta preparado para la impresion de varias facturas
|| en el mismo, por eso no se hace FININF
               |SI Impresora = "CrystalReport";
                    |PARA nCopia = #3#210; |SI nCopia ] 0; |HACIENDO nCopia = nCopia - 1;
                         |SI nCopia = #3#210;
                              eaTipoCopia = "ORIGINAL";
                         |SINO;
                              eaTipoCopia = "COPIA";
                         |FINSI;

                         |SI aInfAnt ! informe;
                              |SI aInfAnt ! ""; |FININF; |FINSI;
                              |PARA; |SI; |HACIENDO;
                                   eaImpMotorCrystal = Impresora;
                                   enSwBorraCabDet = 0;
                                   |HAZ BorraCabDetCrystal;

                                   |SI enSwBorraCabDet = 1;    ||He borrado cabecera/detalle .dbf
                                        |SAL;
                                   |SINO;                      ||No he podido borra cabecera/detalle .dbf
                                        aMensaje = "0000SEl proceso de impresion esta ocupado, Continuar?";
                                        |CONFI aMensaje;
                                        |SI FSalida = 0;
                                             ||Volvemos a intetar borrar.
                                        |SINO;
                                             nSwSalirProg = 1;
                                             |SAL;
                                        |FINSI;
                                   |FINSI;
                              |SIGUE;
                              |SI nSwSalirProg = 1;
                                   |FINIMP;
                                   |ACABA;
                              |FINSI;
                              |INFOR informe;
                         |SINO;
                              FSalida = 0;
                         |FINSI;
                         |SI FSalida = 0;
                              aInfAnt = informe;
                              |BUCLELIN 0 conimprl #1;
                              |HAZ ImpSAT;
                              |PIEINF;
                              |HAZ FinImpre;
                         |FINSI;
                    |SIGUE;
               |SINO;
                    |PARA; |SI; |HACIENDO;
                         eaImpMotorCrystal = Impresora;
                         enSwBorraCabDet = 0;
                         |HAZ BorraCabDetCrystal;

                         |SI enSwBorraCabDet = 1;    ||He borrado cabecera/detalle .dbf
                              |SAL;
                         |SINO;                      ||No he podido borra cabecera/detalle .dbf
                              aMensaje = "0000SEl proceso de impresion esta ocupado, Continuar?";
                              |CONFI aMensaje;
                              |SI FSalida = 0;
                                   ||Volvemos a intetar borrar.
                              |SINO;
                                   nSwSalirProg = 1;
                                   |SAL;
                              |FINSI;
                         |FINSI;
                    |SIGUE;
                    |SI nSwSalirProg = 1;
                         |FINIMP;
                         |ACABA;
                    |FINSI;
                    |INFOR informe;
                    |SI FSalida = 0;
                         |PARA nCopia = #3#210; |SI nCopia ] 0; |HACIENDO nCopia = nCopia - 1;
                              |SI nCopia = #3#210;
                                   eaTipoCopia = "ORIGINAL";
                              |SINO;
                                   eaTipoCopia = "COPIA";
                              |FINSI;

                              |BUCLELIN 0 conimprl #1;
                              |HAZ ImpSAT;
                              |PIEINF;
                              |HAZ FinImpre;
                         |SIGUE;
                         |FININF;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nSwMailOTP = 0; |ACABA; |FINSI;

     ||************* Emision por Mail ****************

     aAlfa = #visalm01@#120; |QBF aAlfa;
     |SI #visalm01@#119 = "S"; |Y aAlfa ! "";
           |ESPECIFICA "RBASS", aPuntero; aRDirBass = aPuntero; |QBF aRDirBass;
           aAlfa = "CrystalReport;" + aRDirBass + "crystal/efactura.pdf";
           Impresora = aAlfa;
           |IMPRE -1;
           |SI FSalida = 0;
              |PULSATECLA;
              |PARA; |SI; |HACIENDO;
                   eaImpMotorCrystal = Impresora;
                   enSwBorraCabDet = 0;
                   |HAZ BorraCabDetCrystal;

                   |SI enSwBorraCabDet = 1;    ||He borrado cabecera/detalle .dbf
                        |SAL;
                   |SINO;                      ||No he podido borra cabecera/detalle .dbf
                        aMensaje = "0000SEl proceso de impresion esta ocupado, Continuar?";
                        |CONFI aMensaje;
                        |SI FSalida = 0;
                             ||Volvemos a intetar borrar.
                        |SINO;
                             nSwSalirProg = 1;
                             |SAL;
                        |FINSI;
                   |FINSI;
              |SIGUE;
              |SI nSwSalirProg = 1;
                   |FINIMP;
                   |ACABA;
              |FINSI;
              |INFOR informe;
              |SI FSalida = 0;
                 |BUCLELIN 0 conimprl #1;
                 |HAZ conimpr2;
                 |FININF;
              |FINSI;
              |FINIMP;
           |FINSI;
           |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dspreven/def/visalm36.mas";
           |CARGA_DEF aAlfa, ParamOTP@;
           |SI FSalida = 0;
               |HAZ EmpresaPrevencion;

              |DBASS aAlfa; |QBF aAlfa;
              aAlfa = aAlfa + "dspreven/fich/" + eaEmpresa + "/"; |PATH_DAT #ParamOTP@#aAlfa#;
              |ABRE #ParamOTP@;
              |SI enNumCampos = 4;
                  |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dspreven/def/maesm554.mas";
              |SINO;
                  |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dspreven/def/visalm37.mas";
              |FINSI;
              |CARGA_DEF aAlfa, DirecOTP@;
              |SI FSalida = 0;
                 |DDEF aAlfa;
                 aAlfa = aAlfa + "otpm0006";
                 |CARGA_DEF aAlfa, otpm0006@;
                 |SI FSalida = 0;
                      |ABRE #otpm0006@;
                      |LEE 000#ParamOTP@.p;
                      |LEE 000#otpm0006@.p;

                      ||aIPDSCorreo = #ParamOTP@#1 + "." + #ParamOTP@#2 + "." + #ParamOTP@#3 + "." + #ParamOTP@#4;
                      aIPDSCorreo = #ParamOTP@#42; |QBF aIPDSCorreo
                      aServidor   = #ParamOTP@#6;  |QBF aServidor;

                      |DBASS aAlfa; |QBF aAlfa;
                      |SI enNumCampos = 4;
                          aAlfa = aAlfa + "dspreven/fich/";
                      |SINO;
                          aAlfa = aAlfa + "dspreven/fich/" + eaEmpresa + "/";
                      |FINSI;
                      |PATH_DAT #DirecOTP@#aAlfa#;|ABRE #DirecOTP@;

                      #DirecOTP@#0 = #ParamOTP@#33;
                      |LEE 000#DirecOTP@.=;
                      |SI FSalida ! 0; |DDEFECTO #DirecOTP@; |FINSI;

                      aDirOrigen = #DirecOTP@#2; |QBF aDirOrigen;
                      #DirecOTP@#0 = #ParamOTP@#28;
                      |LEE 000#DirecOTP@.=;
                      |SI FSalida ! 0; |DDEFECTO #DirecOTP@; |FINSI;
                      |CIERRA #DirecOTP@;

                      |HAZ CuerpoDocumento;
                      aTexto    = "$$$$" + aAbre;

                      || aDirDestino = #DirecOTP@#2; |QBF aDirDestino;
                      aDirDestino = #visalm01@#120; |QBF aDirDestino;

                      |SI #ParamOTP@#9 = "S";
                          eaEntrada = #ParamOTP@#17; |HAZ Encriptacion;
                          aAlfa = eaSalida;            |QBF aAlfa; aAlfa = aAlfa + ":"
                          aAlfa = aAlfa + #ParamOTP@#7; |QBF aAlfa; aAlfa = aAlfa + ":"
                          aDirOrigen = aAlfa + aDirOrigen;
                      |FINSI;
                      aDirOrigen = "!" + aDirOrigen;

                      aDirOrigen = #otpm0006@#4; |QBF aDirOrigen;
                      aAsunto = #otpm0006@#3; |QBF aAsunto;

                      aAlfa = aRDirBass + "crystal/efactura.pdf";
                      |DFICE aFichero; |QBF aFichero; aFichero = aFichero + "ef" + Usuario + ".pdf";
                      aIP = ""; |IP_REMOTO aIP;
                      |SI aIP ! "";
                         |RECIBE_FICHERO aAlfa, aFichero;
                      |SINO;
                         |COPIA_FICHERO aAlfa, aFichero;
                      |FINSI;
                      |FBORRA aAlfa;
                      |DSCORREO_ENVIA aIPDSCorreo, aServidor, aDirOrigen, aDirDestino, aAsunto, aTexto, aFichero;
                      |SI FSalida = 0;
                         |ABRE #agifa729;
                         |LEE 000#agifa729.u;
                         |SI FSalida = 0;
                            nNumero = #agifa729#0 + 1;
                         |SINO;
                            nNumero = 1;
                         |FINSI;
                         |DDEFECTO #agifa729;
                         #agifa729#0 = nNumero;
                         |GRABA 020#agifa729.b;
                         #agifa729#1 = #agifa084#48;
                         #agifa729#2 = #agifa084#0;
                         #agifa729#3 = #agifa084#3;
                         #agifa729#4 = #agifa084#4;
                         fFecha = ~; |HORA aAlfa; aAlfa = aAlfa % 0105;
                         #agifa729#5 = fFecha;
                         #agifa729#6 = aAlfa;
                         #agifa729#9 = #agifa084#1;
                         |GRABA 020#agifa729.a; |LIBERA #agifa729;
                         |CIERRA #agifa729;
                      |SINO;
                         aAlfa = "    Problemas al enviar correo. Revisar conexion.";
                         |MENAV aAlfa;
                         aAlfa = "0000DSCORREO: " + aIPDSCorreo;
                         |QBF aAlfa;
                         aAlfa = aAlfa + "Serv:" + aServidor;
                         |QBF aAlfa;
                         aAlfa = aAlfa + "From:" + aDirOrigen;
                         |QBF aAlfa;
                         aAlfa = aAlfa + "Para:" + aDirDestino;
                         |MENAV aAlfa;
                      |FINSI;
                      |FBORRA aFichero;
                      |FBORRA aAbre;
                      |CIERRA #otpm0006@; |DESCARGA_DEF #otpm0006@;
                 |FINSI;
                 |CIERRA #DirecOTP@; |DESCARGA_DEF #DirecOTP@;
              |FINSI;
              |CIERRA #ParamOTP@; |DESCARGA_DEF #ParamOTP@;
           |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE UnaFacOTP;
     #1#1;
     10;
     #0#7, #0#2, #0#6;
     #0#8, #0#3, #0#6;
     e;
     NULL, ImpresionOTP;
|FIN;

|PROCESO SoloUna;
     |ABRE #3;
     |SI nSwHazOTP = 1;
          |SI #agifa086#9 = "E";
               ||ARA55
               #3#0 = #agifa084#3;
               |LEE 000#3=;
               |SI FSalida ! 0;
                    |DDEFECTO #3;
               |FINSI;

               |SI #3#212 = "S";
                    nSwUnaFactura = 1;
                    |HAZ mirainf;

/*
     ||ESTO YA LO HAGO DESPUES. AQUI SOBRA
                    |SI nSwGenerarPDF = 1;
                         eaDuplicado = "";
                         aMensaje = "0000NSe trata de un duplicado?";
                         |CONFI aMensaje;
                         |SI FSalida = 0;
                              eaDuplicado = "DUPLICADO";
                         |FINSI;

                         |ESPECIFICA "RBASS", aPuntero; aRDirBass = aPuntero; |QBF aRDirBass;
                         aFicheroPDF = aRDirBass + "crystal/facturae" + Usuario;
                         |QBF aFicheroPDF;
                         aFicheroPDF = aFicheroPDF + ".pdf";

                         aBorra = aFicheroPDF;
                         |RFBORRA aBorra;

                         aAlfa = "CrystalReport;" + aFicheroPDF;
                         Impresora = aAlfa;
                         |IMPRE -1;
                         |SI FSalida = 0;
                              aImpre = Impresora;
                              |BUCLE UnaFacOTP;
                              |FINIMP;
                              |XABRE "CE", aFicheroPDF, nHandlePDF;
                              |SI FSalida < 0;
                                   nSwHayPDF = 0;
                              |SINO;
                                   nSwHayPDF = 1;
                              |FINSI;
                         |SINO;
                              aFicheroPDF = "";
                              nSwHayPDF = 0;
                         |FINSI;
                    |FINSI;
*/

                    |HAZ FirmaFactura;
                    |CIERRA #3;
                    |ACABA;
               |SINO;
                    #agifa086#9 = "P";
               |FINSI;
          |FINSI;

          eaDuplicado = "";
          aMensaje = "0000NSe trata de un duplicado?";
          |CONFI aMensaje;
          |SI FSalida = 0;
               eaDuplicado = "DUPLICADO";
          |FINSI;
          |SI #agifa086#9 = "P"; |O #agifa086#9 = "A";
               |IMPRE 0;
               aImpre = Impresora;
               |BUCLE UnaFacOTP;
               |SI Impresora = "CrystalReport";
                    |FININF;
               |FINSI;
               |FINIMP;
          |FINSI;
          |SI #agifa086#9 = "C"; |O #agifa086#9 = "A";
               nSwMailOTP = 1;
               |BUCLE UnaFacOTP;
               nSwMailOTP = 0;
          |FINSI;
     |SINO;
          ||FE
          |SI nArchi = 1;
               |HAZ ArchivandoUna;
          |SINO;
               |SI enSwModoSilencio = 0;
                    |HAZ SelUnaFac;
               |SINO;
                    |ABRE #1;
                    #1#48 = serie;
                    #1#0 = numero;
                    |LEE 101#1=;
                    |SI FSalida = 0;
                         |HAZ EmulaImpresion;
                    |FINSI;
                    |CIERRA #1;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #3;
|FPRC;

||FE
|PROCESO ArchivandoUna;
   nSwUnaFactura = 1;
   |HAZ mirainf;

   |HAZ LeeSelImpFactuE;
   aMenu2 = eaSelFactuE;

   |SI enMenuArchi = 0;
          nOpcion = 0;
          |MENU aMenu;
          |SI FSalida < 1; |O FSalida > 3; |ACABA; |FINSI;
          nOpcion = FSalida;
   |SINO;
          nOpcion = enMenuArchi;
   |FINSI;

   eaSelFactuE = nOpcion;
   |HAZ GrabaSelImpFactuE;

   |SI nOpcion = 1;
        |HAZ FirmaFactura;
        |ACABA;
   |FINSI;

   |SI nOpcion = 3;
       #3#0 = #agifa084#3;
       |LEE 000#3=;
       |SI FSalida ! 0;
            |DDEFECTO #3;
       |FINSI;

       |SI #3#212 = "S";
             |HAZ FirmaFactura;
             |ACABA;
       |FINSI;
   |FINSI;

   |HAZ SelUnaFac;
|FPRC;

|PROCESO EmulaImpresion;
     |SI #1#10 = AN; |Y #41#47 = "S"; |Y #0#6 = "N";
          |SI #41#146 ! "N"; |O #1#73 ! 0;
               |HAZ crearec;
          |FINSI;
     |FINSI;
     #1#10 = AS;
     |GRABA 020#1a;
|FPRC;

|PROCESO ControlaSiFacturaPDF;
     |SI nSwGenerarPDF = 1;
          |ESPECIFICA "RBASS", aPuntero; aRDirBass = aPuntero; |QBF aRDirBass;
          aFicheroPDF = aRDirBass + "crystal/facturae" + Usuario;
          |QBF aFicheroPDF;
          aFicheroPDF = aFicheroPDF + ".pdf";

          aBorra = aFicheroPDF;
          |RFBORRA aBorra;

          aAlfa = "CrystalReport;" + aFicheroPDF;
          Impresora = aAlfa;
          |IMPRE -1;
          |SI FSalida = 0;
               |SI nSwHazOTP = 1;
                    |HAZ ImpresionOTP;
               |SINO;
                    |HAZ Impresion;
               |FINSI;
               |XABRE "CE", aFicheroPDF, nHandlePDF;
               |SI FSalida < 0;
                    nSwHayPDF = 0;
               |SINO;
                    nSwHayPDF = 1;
               |FINSI;
          |FINSI;
          |FINIMP;
     |FINSI;

     |SI nSwSalirProg = 0;
          |HAZ ImpresionFE;
     |FINSI;
|FPRC;

|PROCESO FirmaFactura;
     |SI nSwUnaFactura = 0;
          |HAZ ControlaSiFacturaPDF;

          |SI nDentroBucle = 1;
               |SI nSwSalirProg = 1;
                    |ERROR10;
               |FINSI;
          |FINSI;
     |SINO;
          |BUCLE UnaFacFE;
     |FINSI;
|FPRC;

||FE
|PROCESO SelUnaFac;
     |SI eaImpresora = "";
          |IMPRE 5;
     |SINO;
          Impresora = eaImpresora;
          |IMPRE -1;
     |FINSI;
     enErrorImp = FSalida;
     |SI FSalida = 0;
          |BUCLE UnaFac;

/* buscar Tiquet 3134/395

          |SI Impresora = "CrystalReport";
               |FININF;
          |FINSI;
*/
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO PintaModal; |TIPO 7;
|| Antest tenia esto el mensaje del campo
||<P> Papel; <C> Correo elec.; <A> Ambos(Papel+Correo), <E> S/Conf.ClientE
   |SI nSwHazOTP = 1;
      |CUADRO 2127 2365;
      |PINTA 2228 , " Modalidad impresion : ";
      |C_M #agifa086#9, 1, "S"; |C_V #agifa086#9, 1, "S";
      |PINTA #agifa086#9;
   |FINSI;
|FPRC;

|PROCESO MiraModal;
|ACABA;
   |SI nSwHazOTP = 1;
      |MENSA "    <C> Emision por correo electronico, <P> Emision en papel, <A> Ambas";
      aModalImp = "";
      |PARA; |SI aModalImp = ""; |HACIENDO;
         E_sup = 1; E_inf = "ACP";
         aModalImp = 2251 ? 1;
         |SI FSalida = 0;
            |SI aModalImp ! "C"; |Y aModalImp ! "P"; |Y aModalImp ! "A";
               aModalImp = "";
            |FINSI;
         |FINSI;
      |SIGUE;
      |BLIN 4;
   |FINSI;
|FPRC;

|PROCESO Temporal;
     #1#48 = #134#0;
     #1#0 = #134#1;
     |LEE 121#1=;

     |ABRE #3;
     |HAZ Impresion;
     |CIERRA #3;

     |LIBERA #1;
|FPRC;

|DEFBUCLE Temporal;
     #134#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Temporal;
|FIN;

|PROGRAMA;
     |HAZ SacaIVA;  || para que incluya el plb del iva

     |HAZ EsSanchez;
     nSwSanchez = FSalida;

/*
     |IP_REMOTO aIPRemoto;
     |QBF aIPRemoto;
     |SI aIPRemoto ! "192.168.10.47";
*/
          |HAZ EsSolar;
          |SI FSalida = 0;
               |CORRE "solz0005";
          |FINSI;
/*
     |FINSI;
*/


     ||FE
     nArchi = 0;
     |HAZ EsArchi;
     |SI FSalida = 0;
        |DBASS aAlfa; |QBF aAlfa;
        aAlfa = aAlfa + "dsarchi/def/dsarm001.mas";
        |CARGA_DEF aAlfa, Ref0001@;
        |SI FSalida = 0;

           ||Configuracion de Factura_E por empresa
           nHayConfEmp = 0;
           |DBASS aAlfa; |QBF aAlfa;
           aAlfa = aAlfa + "dsarchi/def/dsarm057.mas";
           |CARGA_DEF aAlfa, Ref0002@;
           |SI FSalida = 0;
                |DBASS aAlfa; |QBF aAlfa;
                aAlfa = aAlfa + "dsarchi/fich/"; |PATH_DAT #2000 aAlfa;
                nEmpresa = #48#0;
                |ABRE #Ref0002@;
                #Ref0002@#0 = nEmpresa;
                |LEE 000#Ref0002@.=;
                |SI FSalida = 0;
                     nHayConfEmp = 1;
                     |SI #Ref0002@#6 = "S";
                         nSwGenerarPDF = 1;
                     |SINO;
                         nSwGenerarPDF = 0;
                     |FINSI;
                |FINSI;
                |CIERRA #Ref0002@; |DESCARGA_DEF #Ref0002@;
           |FINSI;

           |DBASS aAlfa; |QBF aAlfa;
           aAlfa = aAlfa + "dsarchi/fich/"; |PATH_DAT #1000 aAlfa;
           |ABRE #Ref0001@;
           |DDEFECTO #Ref0001@;
           |LEE 000#Ref0001@.p;
           |SI FSalida ! 0; |DDEFECTO #Ref0001@; |FINSI;

           |SI #Ref0001@#31 = "S";
              nArchi = 1;
              eaArGrpMin = #Ref0001@#34;
              eaArSbGMin = #Ref0001@#35;
              eaArTipMin = #Ref0001@#36;
           |SINO;
              eaArGrpMin = "";
              eaArSbGMin = "";
              eaArTipMin = "";
           |FINSI;
           |SI nHayConfEmp = 0;
                |SI #Ref0001@#164 = "S";
                    nSwGenerarPDF = 1;
                |SINO;
                    nSwGenerarPDF = 0;
                |FINSI;
           |FINSI;
           |CIERRA #Ref0001@; |DESCARGA_DEF #Ref0001@;
        |FINSI;
     |FINSI;

     |SI eaFicTmpCab ! ""; |NOME_DAT #agifa084#eaFicTmpCab#; |FINSI;
     |SI eaFicTmpLin ! ""; |NOME_DAT #agifa069#eaFicTmpLin#; |FINSI;

     eaSerieTa = "";
     enCodigTa = 0;

     |HAZ MiraLogos; || Copia Logos para el Crystal

     |DDEF aBase;
     aAlfa = aBase + "agifa505.mas";
     |XABRE "E", aAlfa, 0;
     nSwTpv = FSalida;
     |SI nSwTpv = 0;
           |CARGA_DEF aAlfa, agifa505@;
     |FINSI;

     |HAZ EsFriesa;
     nSwFriesa = FSalida;

     |HAZ EsPackList;
     nSwPackList = FSalida;

     nSwHazOTP = 0;
     |HAZ EsOTP;
     |SI FSalida = 0;
        serie = PRMNT_serie;
        numero = PRMNT_numero;
        nSwHazOTP = 1;
        |DBASS aAlfa; |QBF aAlfa;
        aAlfa = aAlfa + "dspreven/def/visalm01.mas";
        |CARGA_DEF aAlfa, visalm01@;
        |SI FSalida = 0;
           |HAZ EmpresaPrevencion;
           |DBASS aAlfa; |QBF aAlfa;
           aAlfa = aAlfa + "dspreven/fich/" + eaEmpresa + "/";
           |PATH_DAT #visalm01@#aAlfa#; |ABRE #visalm01@;
        |SINO;
           nSwHazOTP = 0;
        |FINSI;
     |FINSI;

     |ABRE #41;|LEE 000#41p;|CIERRA #41;

     eaEmpExt = "";
     |SI PARAMETRO = "";
        eaNombreEmp = #48#1;
        eaDireccEmp = #48#2;
        eaPoblacEmp = #48#3;
        eaProvinEmp = #48#4;
        eaCIFEmp    = #48#5;
        eaTelefoEmp = #48#6;
        eaFaxEmp    = #48#7;
        eaLinea1Emp = #48#12;
        eaLinea2Emp = #48#13;
     |FINSI;

     |SI eaFichero ! "";      || Temporal de impresion
          |NOME_DAT #134 eaFichero;
          |ABRE #1;
          |IMPRE 5;
          |SI 0 = FSalida;
              |BUCLE Temporal;
              |SI Impresora = "CrystalReport";
                  |FININF;
              |FINSI;
              |FINIMP;
          |FINSI;
          |CIERRA #1;
     |SINO;
          aAlfa = PARAMETRO - "DSPREVEN";
          |SI FSalida ! 0;
              aAlfa1 = aAlfa % 105;  serie  = aAlfa1;
              aAlfa1 = aAlfa % 606;  numero = aAlfa1;
              aAlfa  = PARAMETRO % 2099;
              PARAMETRO = aAlfa;
          |FINSI;

          |SI numero ! 0;
               |SI PARAMETRO ! "";
                  eaTipoImp = PRMNT_aTipoImp;

                  || ABDON. LLamada desde otra aplicacion, pasar en el
                  ||        parametro de la llamada el camino de los ficheros
                  ||        de la empresa de gestion comercial. Se usa en la
                  ||        aplicacion dsprevex, en el cal dsviz014.
                  aAlfa = PARAMETRO;
                  aAlfa = aAlfa % -106;
                  eaEmpExt = aAlfa % 0105;
                  aAlfa = PARAMETRO;
                  |PATH_DAT #1 aAlfa;  |PATH_DAT #2 aAlfa;
                  |PATH_DAT #3 aAlfa;  |PATH_DAT #6 aAlfa;
                  |PATH_DAT #13 aAlfa; |PATH_DAT #15 aAlfa;
                  |PATH_DAT #16 aAlfa; |PATH_DAT #17 aAlfa;
                  |PATH_DAT #11 aAlfa; |PATH_DAT #40 aAlfa;
                  |PATH_DAT #41 aAlfa; |PATH_DAT #99 aAlfa;
                  |PATH_DAT #53 aAlfa; |PATH_DAT #148 aAlfa;
                  |PATH_DAT #505 aAlfa; |PATH_DAT #501 aAlfa;
                  |PATH_DAT #729 aAlfa; |PATH_DAT #100 aAlfa;
                  |PATH_DAT #324 aAlfa; |PATH_DAT #321 aAlfa;
                  |PATH_DAT #134 aAlfa; |PATH_DAT #43 aAlfa;

                  aAlfa = aAlfa - "fich/";
                  |SI FSalida ! 0;
                     nCalc = FSalida;
                     nCalc = ((nCalc / 100) ! 0) + 104;
                     aAlfa = PARAMETRO; |QBF aAlfa;
                     aAlfa = aAlfa % nCalc;
                     |PATH_DAT #14 aAlfa;
                     aAlfa = PARAMETRO; |QBF aAlfa;
                     aAlfa = aAlfa % -106; aAlfa = aAlfa % 0105;
                     |ABRE #14;
                     #14#0 = aAlfa;
                     |LEE 000#14=;
                     |SI FSalida ! 0; |DDEFECTO #14; |FINSI;
                     |CIERRA #14;
                     eaNombreEmp = #14#1;
                     eaDireccEmp = #14#2;
                     eaPoblacEmp = #14#3;
                     eaProvinEmp = #14#4;
                     eaCIFEmp    = #14#5;
                     eaTelefoEmp = #14#6;
                     eaFaxEmp    = #14#7;
                     eaLinea1Emp = #14#12;
                     eaLinea2Emp = #14#13;
                  |FINSI;
               |FINSI;
               |ABRE #1;
               #1#48 = serie;
               #1#0 = numero;
               |LEE 000#1=;
               |CIERRA #1;

               #0#7 = serie;
               #0#8 = serie;
               #0#2 = numero;
               #0#3 = numero;
               |SI eaReimp = "";
                    #0#6 = #1#10;
               |SINO;
                    #0#6 = eaReimp;
               |FINSI;
               #0#9 = eaTipoImp;
               |HAZ SoloUna;
          |SINO;
               |MANTE #0;
          |FINSI;
     |FINSI;

     |SI nSwHazOTP = 1;
        |CIERRA #visalm01@; |DESCARGA_DEF #visalm01@;
     |FINSI;

     |SI nSwTpv = 0;
          |DESCARGA_DEF #agifa505@;
     |FINSI;
|FPRO;

|PROCESO TagPostFormado;
     aEsPostFormaso = "N";
     |DDEF aAlfa;
     aAlfa = aAlfa + "tagm0056";
     |CARGA_DEF aAlfa, tagm0056@;
     |SI FSalida = 0;
          |ABRE #tagm0056@;
          #tagm0056@#0 = "FD";
          #tagm0056@#1 = #2#20;
          #tagm0056@#2 = #2#0;
          #tagm0056@#3 = #2#1;
          |LEE 000#tagm0056@.=;
          |SI FSalida = 0;
               descrip = #2#4;
               nTotal = #2#9;
               nTotalD = #2#27;
               |SALVA_FICHA #2;
               #2#1 = #tagm0056@#5;
               |LEE 000#2=;
               |SI FSalida = 0;
                    nTotal = nTotal + #2#9;
                    nTotalD = nTotalD + #2#27;
               |FINSI;
               |REPON_FICHA #2;
               #2#6 = nTotal / #2#5;
               #2#26 = nTotalD / #2#5;
               #2#9 = nTotal;
               #2#27 = nTotalD;
          |SINO;
               |SELECT #2#tagm0056@;
               #tagm0056@#5 = #2#1;
               |LEE 000#tagm0056@.=;
               |SI FSalida = 0;
                    aEsPostFormaso = "S";
               |FINSI;
          |FINSI;
          |CIERRA #tagm0056@;
          |DESCARGA_DEF #tagm0056@;
     |FINSI;
|FPRC;


|PROCESO Tipo0C9; |TIPO 0;
     |SI #agifa086#9 = "E";
          |SI nArchi = 0;
               aMensaje = "0000Modulo DSARCHI no instalado o no conectado con DSCOMER9";
               |MENAV aMensaje;
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;
