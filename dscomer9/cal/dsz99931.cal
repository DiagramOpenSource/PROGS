|FICHEROS;
     carm0001 #1;
     carm0002 #2;
     carw0001 #3;
     agifa010 #10;
     agifa019 #19;
     agifa024 #24;
     agifa071 #71;
     agifa084 #84;
     agifa069 #69;
     psion004 #40;
     psion005 #50;
     agifa007 #7;
     psioa004 #400;
     psioa005 #500;
|FIN;

|VARIABLES;
     nSwFriesa = 0;
     aDef      = "";
     aFic      = "";
     aArti     = "";
     fFecha    = @;
     fExiste   = @;
     nLin      = 0;
     nPrecio   = 0;
     nMult     = 0;
     nImpDiv   = 0;
     nUni      = 0;
     nExiste   = 0;
|FIN;

|PROCESO NoExiste;
     nExiste = 0;
|FPRC;

|PROCESO Existe;
     |SI #1#1 > fFecha;
          |ERROR10;
     |SINO;
          fExiste = #1#1;
          nExiste = 1;
     |FINSI;
|FPRC;

|DEFBUCLE Existe;
     #1#1;
     ;
     aArti, "01.01.0000";
     aArti, "31.12.9999";
     ;
     NoExiste, Existe;
|FIN;

|PROCESO MiraExiste;
     |BUCLE Existe;
     |SI nExiste = 1;
          |ABRE #1;
          #1#0 = aArti;
          #1#1 = fExiste;
          |LEE 000#1=;
          |CIERRA #1;
     |FINSI;
|FPRC;

|PROCESO Lineas71;
     nLin = #71#1;

     #2#0 = #71#2;
     |LEE 000#2=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     #19#0 = #71#2;
     |LEE 020#19=;

     aArti = #2#1;
     fFecha = #10#1;
     |HAZ MiraExiste;
     |SI nExiste = 0; |ACABA; |FINSI;

     |DDEFECTO #3;
     #3#0 = #1#0;
     |LEE 000#3=;
     |SI FSalida ! 0; |GRABA 020#3b; |FINSI;
     |SI #1#4 = "S";
          #3#1 = #3#1 + (#71#5 * #19#102 * #71#6);
          #3#2 = #3#2 + (#71#5 * #19#102);
     |SINO;
          #3#1 = #3#1 + (#71#5 * #71#6);
          #3#2 = #3#2 + #71#5;
     |FINSI;
     #3#4 = #1#3;
     #3#3 = #1#2;

     |SI nSwFriesa = 0;
          #3#5 = nLin;
     |FINSI;
     |GRABA 020#3a;
     |LIBERA #3;
|FPRC;

|PROCESO TotalLineaAV;
     |SI #10#70 = "D";                    || Si mon. de trabajo es divisa ...
          #71#6  = #71#36 / #10#69 * #10#74; || Recalculo precio en mon. base
          #71#38 = #71#6;                  || Precio visual, en mon. base
     |SINO;                              || Si mon. de trabajo es mon. base
          #71#36 = #71#6 / #10#74 * #10#69;  || Recalculo precio en divisa
          #71#38 = #71#36;                 || Precio visual, en divisa
     |FINSI;

     |SI #19#194 = 2;
         #71#7    = #71#48 * #71#6;
          nImpDiv = #71#48 * #71#36;
     |SINO;
          #71#7    = #71#5 * #71#6;
          nImpDiv = #71#5 * #71#36;
     |FINSI;

     || nMult corrige el error del redondeo para negativos
     |SI #71#7 < 0; nMult = -1; |SINO; nMult = 1; |FINSI;
     #71#7    = #71#7    * nMult;
     nImpDiv = nImpDiv * nMult;

     #71#9  = (((#71#7 < #71#8) < #71#33));
     #71#37 = (((nImpDiv < #71#8) < #71#33));

     #71#7  = #71#7  * nMult;
     #71#9  = #71#9  * nMult;
     #71#37 = #71#37 * nMult;

     |SI #10#70 = "D";
          #71#39 = #71#9;
     |SINO;
          #71#39 = #71#37;
     |FINSI;
|FPRC;

|PROCESO TemporalAV;
     nLin = nLin + 1;
     |DDEFECTO #19;
     #19#0 = #3#0;
     |LEE 000#19=;

     |SI #3#3 = "I";
          nUni = #3#2;
          nPrecio = #3#4;
     |SINO;
          nUni = #3#2;
          nPrecio = #3#1 * #3#4 / 100 / #3#2;
     |FINSI;

     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = nLin;
     #71#2 = #3#0;
     #71#3 = 1;       || Almacen
     #71#4 = #19#1;
     #71#5 = nUni;
     #71#6 = nPrecio;
     |SI #7#30 = "S";
          #71#11 = 0;
     |SINO;
          #71#11 = #19#30;
     |FINSI;
     #71#13 = #19#2;
     #71#15 = #24#0;
     #71#17 = #24#4;
     |SI nSwFriesa = 0;
          #71#51 = #3#5;       || Usa Medida_1 para guardar la linea
     |FINSI;
     |HAZ TotalLineaAV;
     |GRABA 020#71n;
|FPRC;

|DEFBUCLE TemporalAV;
     #3#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, TemporalAV;
|FIN;

|PROCESO BajaLineas71;
     aArti = #71#2;
     fFecha = #10#1;
     |HAZ MiraExiste;
     |SI nExiste = 0; |ACABA; |FINSI;

     |BORRA 020#71a;
|FPRC;

|DEFBUCLE Lineas71;
     #71#1;
     ;
     #10#52, #10#0, 001;
     #10#52, #10#0, 999;
     ;
     NULL, Lineas71;
|FIN;

|DEFBUCLE BajaLineas71;
     #71#1;
     ;
     #10#52, #10#0, 001;
     #10#52, #10#0, 999;
     be;
     NULL, BajaLineas71;
|FIN;
                     //컴컴컴컴컴컴컴컴컴컴컴//
|PROCESO Lineas69;
     nLin = #69#1;

     #2#0 = #69#2;
     |LEE 000#2=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     #19#0 = #69#2;
     |LEE 020#19=;

     aArti = #2#1;
     fFecha = #84#1;
     |HAZ MiraExiste;
     |SI nExiste = 0; |ACABA; |FINSI;

     |SI nSwFriesa = 0;       || NO AGRUPA
          |DDEFECTO #3;
          #3#0 = #1#0;
          #3#5 = nLin;
          |LEE 000#3=;
          |SI FSalida ! 0; |GRABA 020#3b; |FINSI;
          |SI #1#4 = "S";
               #3#1 = #3#1 + (#69#5 * #19#102 * #69#6);
               #3#2 = #3#2 + (#69#5 * #19#102);
          |SINO;
               #3#1 = #3#1 + (#69#5 * #69#6);
               #3#2 = #3#2 + #69#5;
          |FINSI;
          #3#4 = #1#3;
          #3#3 = #1#2;
     |SINO;
          |DDEFECTO #3;
          #3#0 = #1#0;
          |LEE 000#3=;
          |SI FSalida ! 0; |GRABA 020#3b; |FINSI;
          |SI #1#4 = "S";
               #3#1 = #3#1 + (#69#5 * #19#102 * #69#6);
               #3#2 = #3#2 + (#69#5 * #19#102);
          |SINO;
               #3#1 = #3#1 + (#69#5 * #69#6);
               #3#2 = #3#2 + #69#5;
          |FINSI;
          #3#4 = #1#3;
          #3#3 = #1#2;
     |FINSI;
     |GRABA 020#3a;
     |LIBERA #3;
|FPRC;

|PROCESO TotalLineaFD;
     |SI #84#67 = "D";
          #69#6 = #69#26 / #84#66 * #84#69;
          #69#28 = #69#6;
     |SINO;
          #69#26 = #69#6 / #84#69 * #84#66;
          #69#28 = #69#26;
     |FINSI;

     |SI #19#194 = 2;
          #69#7  = #69#30 * #69#6;
          nImpDiv = #69#30 * #69#26;
     |SINO;
          #69#7  = #69#5 * #69#6;
          nImpDiv = #69#5 * #69#26;
     |FINSI;

     || nMult corrige el error del redondeo para negativos
     |SI #69#7 < 0; nMult = -1; |SINO; nMult = 1; |FINSI;
     #69#7    = #69#7 * nMult;
     nImpDiv = nImpDiv * nMult;

     #69#9  = (#69#7 < #69#8) < #69#21;
     #69#27 = (nImpDiv < #69#8) < #69#21;

     #69#7  = #69#7   * nMult;
     #69#9  = #69#9   * nMult;
     #69#27 = #69#27  * nMult;

     |SI #84#67 = "D";
          #69#29 = #69#9;
     |SINO;
          #69#29 = #69#27;
     |FINSI;
|FPRC;

|PROCESO TemporalFD;
     nLin = nLin + 1;
     |DDEFECTO #19;
     #19#0 = #3#0;
     |LEE 000#19=;

     |SI #3#3 = "I";
          nUni = #3#2;
          nPrecio = #3#4;
     |SINO;
          nUni = #3#2;
          nPrecio = #3#1 * #3#4 / 100 / #3#2;
     |FINSI;

     |DDEFECTO #69;
     #69#20 = #84#48;
     #69#0 = #84#0;
     #69#1 = nLin;
     #69#2 = #3#0;
     #69#3 = 1;       || Almacen
     #69#4 = #19#1;
     #69#5 = nUni;
     #69#6 = nPrecio;
     |SI #7#30 = "S";
          #69#11 = 0;
     |SINO;
          #69#11 = #19#30;
     |FINSI;
     #69#13 = #19#2;
     #69#15 = #24#0;
     #69#17 = #24#4;
     |SI nSwFriesa = 0;
          #69#30 = #3#5;       || Usa Unidades_2 para guardar la linea
     |FINSI;
     |HAZ TotalLineaFD;
     |GRABA 020#69n;
|FPRC;

|DEFBUCLE TemporalFD;
     #3#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, TemporalFD;
|FIN;

|PROCESO BajaLineas69;
     aArti = #69#2;
     fFecha = #84#1;
     |HAZ MiraExiste;
     |SI nExiste = 0; |ACABA; |FINSI;

     |BORRA 020#69a;
|FPRC;

|DEFBUCLE Lineas69
     #69#1;
     ;
     #84#48, #84#0, 001;
     #84#48, #84#0, 999;
     ;
     NULL, Lineas69;
|FIN;

|DEFBUCLE BajaLineas69;
     #69#1;
     ;
     #84#48, #84#0, 001;
     #84#48, #84#0, 999;
     be;
     NULL, BajaLineas69;
|FIN;
                     //컴컴컴컴컴컴컴컴컴컴컴//
|PROCESO Lineas50;
     nLin = #50#3;

     #2#0 = #50#4;
     |LEE 000#2=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     #19#0 = #50#4;
     |LEE 020#19=;

     aArti = #2#1;
     fFecha = #40#3;
     |HAZ MiraExiste;
     |SI nExiste = 0; |ACABA; |FINSI;

     |DDEFECTO #3;
     #3#0 = #1#0;
     |LEE 000#3=;
     |SI FSalida ! 0; |GRABA 020#3b; |FINSI;
     |SI #1#4 = "S";
          #3#1 = #3#1 + (#50#6 * #19#102 * #50#7);
          #3#2 = #3#2 + (#50#6 * #19#102);
     |SINO;
          #3#1 = #3#1 + (#50#6 * #50#7);
          #3#2 = #3#2 + #50#6;
     |FINSI;
     #3#4 = #1#3;
     #3#3 = #1#2;
     |GRABA 020#3a;
     |LIBERA #3;
|FPRC;

|PROCESO TemporalPS;
     nLin = nLin + 1;
     |DDEFECTO #19;
     #19#0 = #3#0;
     |LEE 000#19=;

     |SI #3#3 = "I";
          nUni = #3#2;
          nPrecio = #3#4;
     |SINO;
          nUni = #3#2;
          nPrecio = #3#1 * #3#4 / 100 / #3#2;
     |FINSI;

     |DDEFECTO #50;
     #50#0 = #40#0;
     #50#1 = #40#1;
     #50#2 = #40#2;
     #50#3 = nLin;
     #50#4 = #3#0;
     #50#5 = #19#1;
     #50#6 = nUni;
     #50#7 = nPrecio;
     #50#8 = 0;
     |SI #7#30 = "S";
          #50#9 = 0;
     |SINO;
          #50#9 = #19#30;
     |FINSI;
     #50#10= #50#6 * #50#7;
     #50#11= 1;
     |GRABA 020#50n;
|FPRC;

|DEFBUCLE TemporalPS;
     #3#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, TemporalPS;
|FIN;

|DEFBUCLE Lineas50;
     #50#1;
     ;
     #40#0, #40#2, #40#1, 001;
     #40#0, #40#2, #40#1, 999;
     ;
     NULL, Lineas50;
|FIN;

                     //컴컴컴컴컴컴컴컴컴컴컴//
|PROCESO Lineas50a;
     nLin = #500#3;

     #2#0 = #500#4;
     |LEE 000#2=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     #19#0 = #500#4;
     |LEE 020#19=;

     aArti = #2#1;
     fFecha = #400#3;
     |HAZ MiraExiste;
     |SI nExiste = 0; |ACABA; |FINSI;

     |DDEFECTO #3;
     #3#0 = #1#0;
     |LEE 000#3=;
     |SI FSalida ! 0; |GRABA 020#3b; |FINSI;
     |SI #1#4 = "S";
          #3#1 = #3#1 + (#500#6 * #19#102 * #500#7);
          #3#2 = #3#2 + (#500#6 * #19#102);
     |SINO;
          #3#1 = #3#1 + (#500#6 * #500#7);
          #3#2 = #3#2 + #500#6;
     |FINSI;
     #3#4 = #1#3;
     #3#3 = #1#2;
     |GRABA 020#3a;
     |LIBERA #3;
|FPRC;

|PROCESO TemporalPSa;
     nLin = nLin + 1;
     |DDEFECTO #19;
     #19#0 = #3#0;
     |LEE 000#19=;

     |SI #3#3 = "I";
          nUni = #3#2;
          nPrecio = #3#4;
     |SINO;
          nUni = #3#2;
          nPrecio = #3#1 * #3#4 / 100 / #3#2;
     |FINSI;

     |DDEFECTO #500;
     #500#0 = #400#0;
     #500#1 = #400#1;
     #500#2 = #400#2;
     #500#3 = nLin;
     #500#4 = #3#0;
     #500#5 = #19#1;
     #500#6 = nUni;
     #500#7 = nPrecio;
     #500#8 = 0;
     |SI #7#30 = "S";
          #500#9 = 0;
     |SINO;
          #500#9 = #19#30;
     |FINSI;
     #500#10= #500#6 * #500#7;
     #500#11= 1;
     |GRABA 020#500n;
|FPRC;

|DEFBUCLE TemporalPSa;
     #3#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, TemporalPSa;
|FIN;

|DEFBUCLE Lineas50a;
     #500#1;
     ;
     #400#0, #400#2, #400#1, 001;
     #400#0, #400#2, #400#1, 999;
     ;
     NULL, Lineas50a;
|FIN;
||컴컴컴컴컴컴컴컴컴컴컴컴횾roceso Externos컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO BajaCarnicasAV;
     |BUCLE BajaLineas71;
|FPRC;

|PROCESO AltaCarnicasAV;
     |HAZ EsFriesa;
     nSwFriesa = FSalida;

     aFic = Usuario; |QBF aFic;
     |NOME_DAT #3 aFic;
     |DELINDEX #3;

     |ABRE #2;
     |ABRE #3;
     |ABRE #24;
     |ABRE #19;
     |BUCLE Lineas71;
     |CIERRA #19;

     #24#0 = #10#3;
     |LEE 000#24=;

     |ABRE #71;
     |ABRE #19;
     |BUCLE TemporalAV;
     |CIERRA #19;
     |CIERRA #71;

     |CIERRA #24;
     |CIERRA #3;
     |CIERRA #2;
     |DELINDEX #3;
|FPRC;
                     //컴컴컴컴컴컴컴컴컴컴컴//

|PROCESO BajaCarnicasFD;
     |BUCLE BajaLineas69;
|FPRC;

|PROCESO AltaCarnicasFD;
     |HAZ EsFriesa;
     nSwFriesa = FSalida;

     aFic = Usuario; |QBF aFic;
     |NOME_DAT #3 aFic;
     |DELINDEX #3;

     |ABRE #2;
     |ABRE #3;
     |ABRE #24;
     |ABRE #19;
     |BUCLE Lineas69;
     |CIERRA #19;

     #24#0 = #84#3;
     |LEE 000#24=;

     |ABRE #69;
     |ABRE #19;
     |BUCLE TemporalFD;
     |CIERRA #19;
     |CIERRA #69;

     |CIERRA #24;
     |CIERRA #3;
     |CIERRA #2;
     |DELINDEX #3;
|FPRC;
                     //컴컴컴컴컴컴컴컴컴컴컴//

|PROCESO AltaCarnicasPS;
     aFic = Usuario; |QBF aFic;
     |NOME_DAT #3 aFic;
     |DELINDEX #3;

     |ABRE #2;
     |ABRE #3;
     |ABRE #24;
     |ABRE #19;
     |BUCLE Lineas50;
     |CIERRA #19;

     #24#0 = #40#4;
     |LEE 000#24=;

     |ABRE #50;
     |ABRE #19;
     |BUCLE TemporalPS;
     |CIERRA #19;
     |CIERRA #50;

     |CIERRA #24;
     |CIERRA #3;
     |CIERRA #2;
     |DELINDEX #3;
|FPRC;

|PROCESO AltaCarnicasPSa;
     aFic = Usuario; |QBF aFic;
     |NOME_DAT #3 aFic;
     |DELINDEX #3;

     |ABRE #2;
     |ABRE #3;
     |ABRE #24;
     |ABRE #19;
     |BUCLE Lineas50a;
     |CIERRA #19;

     #24#0 = #400#4;
     |LEE 000#24=;

     |ABRE #500;
     |ABRE #19;
     |BUCLE TemporalPSa;
     |CIERRA #19;
     |CIERRA #500;

     |CIERRA #24;
     |CIERRA #3;
     |CIERRA #2;
     |DELINDEX #3;
|FPRC;
