|FICHEROS;
     agifa071 #0;
     agifa010 #1;
     agifa019 #2;
     agifa024 #6;
     agifa017 #8;
     agifa036 #9;
     agifa070 #10;
     agifa048 #13;
     agifa049 #14;
     agifa324 #34;    || DIVISAS
     agifa321 #35;    || DIV - Parametros
     tempo036 #81;
     agifa007 #21;
     dsm00005 #905;
     dsm00049 #949;
     dsm00047 #947;
     agifa142 #142;
     dsm00279 #279;
     referen@;
|FIN;

|VARIABLES;
     &Envase    = "";
     &Unidades1 = 0;
     &Unidades2 = 0;
     &VArticulo = "";
     &qAbono    = "";
     nSwSirviendo = 0;
     nUni = 0;
     nLinCanon = 0;
     &enModo036 = 0;
     nTallerBorLin = 0;
     nSwTaller = 0;
     nPreDtoAnt = 0;
     nTecla = 0;
     &enGuerAuto = 0;
     nDia = 0;
     nMes = 0;
     nDias = 0;
     nCalen = 0;
     fFecha = @;
     f = @;
     aTrabaja = "";
     aDef = "";
     aA¤o = "";
     aTipoFac = "";

     aPtec = "";
     nPtec = 0;
     nLin = 0;
     nLinV         = 0;
     &Tempo        = "";
     aTempo81      = "";
     salida        = 0;
     aAlfa         = "";
     DesAmpli      = "";
     nModo         = 0;
     &pvp_ve       = 0;
     &enDescuento1 = 0;
     &enDescuento2 = 0;
     &eaTComision  = "";
     &enComision   = 0;

     &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_Div      = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDiv   = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVis   = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVis = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVis   = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVis   = 0;   || Decimales en el Importe visual. (lineas)
     &nDeci_BaseMxD  = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBasMxD= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_DivD     = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDivD  = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVisD  = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVisD= 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVisD  = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVisD  = 0;   || Decimales en el Importe visual. (lineas)

     nForma     = 0;
     nerror     = 0;
     nNume      = 0;
     nPrecio    = 0;

     tecla      = "";
     &ac_divisa = ""; ||
     mensa      = ""; || Linea de visualizacion
     &pintado   = 0;|| Controla el pintado de mensa para que solo lo haga 1 vez
     titdiv = "";   || Encabezado de precio e imp. con la divisa "Imp.Tot(USD)"
     vcontrol = "";
     l1_inf = "";
     l1_sup = "";
     fich = "";
     Unidades = 0;
     sw_escan = 0;
     imneto = 0;
     margen = 0;
     tf = 0;
     comi1 = 0;
     comi2 = 0;
 comi3 = 0;
 menor = 0;
 pc = 0;
 pc1 = 0;
 asto = 0;
 swescan = 0;
 operacion = 0;
 a = 0;
 wimneto = 0;
 cantidad = 0;
 operacion1 = "DV";
 operacion2 = "AV";
modo = 0;
fmes = "  ";
mes = 0;
hacer = 0;
fiac = "  ";
guarda = "  ";
relleno = "                                       ";
aponer = "  ";
como = 0;
linea = 0;
i = 0;
descu = 0;
primera = 0;
totbu = 0;
flag = 0;
&n_dec = 0;
&n_pre = 0;
&eaUniMarhu = 0;

     nImpDiv = 0;
|FIN;

|INCLUYE i_varart;

|PROCESO Llena028; |TIPO 6;
     enAlta = 1;
     eaArticulo = #0Campo;
     |HAZ LlenaArticulo;
     |SI FSalida = 0;
          #0Campo = eaArticulo;
          |PINTA #0Campo;
     |SINO;
          |ERROR; |ACABA;
     |FINSI;
|FPRC;

|PROCESO poncontr;|TIPO 0;
     fiac = Control % A109;
     fiac = fiac + relleno;
     guarda = fiac % A109;
     fiac = Control % A1001;
     Control = Control + fiac;
     Control = Control + relleno;
     Control = Control % A120;
     Control = Control + aponer;
|FPRC;

|PROCESO mirarser;|TIPO 0;
     |SI #10#5 > 0; |O #10#28 > 0;
          hacer = 1;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO GrabaCompoN;
     |SALVA_DATOS #905;

     #905#0 = "AV";
     #905#1 = #0#29;
     #905#2 = #0#0;
     #905#3 = #0#1;
     #905#9 = 0;
     |GRABA 020#905n;
     |LIBERA #905;

     |REPON_DATOS #905;
     |LEE 040#905=;

     eaTipo        = "AV";
     eaSerie       = #0#29;
     enCodigo      = #0#0;
     enLinea       = #0#1;
     efFecha       = #1#1;
     eaArticulo    = #0#2;
     enAlmacen     = #0#3;
     eaComponente  = #905#4;
     enUnidades    = #0#5;
     enTBruto      = #0#7;
     enTarifa      = #6#39;
     eaSeriePedido = #0#32;
     enCodigPedido = #0#18;
     enLineaPedido = #0#22;
     eaAbono       = #1#43;
     eaDeposito    = "S";

     |SUB_EJECUTA_NP "dsz00002;AVC";
|FPRC;

|DEFBUCLE dsm00005N;
     #905#1;
     ;
     "DP", #0#32, #0#18, nLinV, "      ";
     "DP", #0#32, #0#18, nLinV, "zzzzzz";
     ;
     NULL, GrabaCompoN;
|FIN;

|PROCESO dsm00049;
     #947#0 = #0#29;
     #947#1 = #0#0;
     #947#2 = #0#1;
     #947#3 = #949#3;
     #947#4 = #949#4;
     #947#5 = #949#5;
     |GRABA 020#947n;
|FPRC;

|DEFBUCLE dsm00049;
     #949#1;
     ;
     #10#29, #10#0, #10#1, 001;
     #10#29, #10#0, #10#1, 999;
     ;
     NULL, dsm00049;
|FIN;

|PROCESO sirve;|TIPO 0;
     nSwSirviendo = 1;
     |ABRE #2;
     #2#0 = #10#2;
     |LEE 000#2=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;
     |CIERRA #2;

     |SI #10#5 [ 0; |ACABA; |FINSI;
     |SI #2#179 = "S"; |Y #10#28 = 0; |ACABA; |FINSI;

     efFec = #1#1;
     enAlma = #0#3;
     |HAZ MiraHisL;
     |SI enErrHis ! 0;
          |ERROR;
          |ACABA;
     |FINSI;

     #0#29 = #1#52;
     #0#0  = #1#0;
     |PARA FSalida = 1;|SI 0 ! FSalida; |Y linea [ 999; |HACIENDO linea = linea + 1;
           #0#1 = linea;
           |GRABA 010#0b;
           |SI FSalida = 0;
               |PARA i = 2;|SI i < 12;|HACIENDO i = i + 1;
                     #0i = #10i;
               |SIGUE;
               #0#63 = #10#38;

               aAlfa = #0#2; |QBF aAlfa;
               |SI aAlfa ! "";
                    |SI #142#203 = "S"; |O #142#40 = "S";
                         aTipoDA = "AD"; |HAZ AltaDA;
                    |FINSI;
               |FINSI;

               |ABRE #947;
               |BUCLE dsm00049;
               |CIERRA #947;

               #0#36 = #10#24; || Asigna el precio en divisa
               |HAZ decim1; ||Convierte el precio a divisa
               #0#18 = #9#0;#0#22 = #10#1;#0#20 = AS;
               #0#16 = #10#16;#0#17 = #10#17;#0#15 = #10#15;#0#13 = #10#13;
               #0#33 = #10#23;   ||dto 2
               #0#34  = #10#31;
               #0#35 = #10#32;
               |HAZ TotalLin71;
               #0#25 = #10#5;
               #0#27 = #10#21;
               |SI #2#176 = "N";
                    #0#5 = #10#5;
                    #0#48 = #10#28;
                    #0#49 = #10#29;
                    #0#50 = #10#30;
                    #0#51 = #10#33;
                    #0#52 = #10#34;
                    #0#53 = #10#35;
                    |SI #2#179 = "S";
                         |HAZ EsGuerola;
                         |SI FSalida = 0;
                              |HAZ GuerDiasFac;
                              #0#51 = nDias; ||Medida1
                              #0#48 = #0#5 * #0#51; || Unidades2

                              #10#33 = #0#51;
                              #10#28 = #0#48;
                              |GRABA 020#10a;
                         |FINSI;
                    |FINSI;

                    |HAZ TotalLin71;
                    |HAZ liacarti;
               |SINO;
                  nLinV = #0#22;
                  |BUCLE dsm00005N;

                  eaTipo        = "AV";
                  eaSerie       = #0#29;
                  enCodigo      = #0#0;
                  enLinea       = #0#1;
                  efFecha       = #1#1;
                  eaArticulo    = #0#2;
                  enAlmacen     = #0#3;
                  enUnidades    = #0#5;
                  enTBruto      = #0#7;
                  enTarifa      = #6#39;
                  eaSeriePedido = #0#32;
                  enCodigPedido = #0#18;
                  enLineaPedido = #0#22;
                  eaAbono       = #1#43;
                  eaDeposito    = "S";
                  enCamBas    = #1#69;
                  eaMoneda    = #1#70;
                  enCamDiv    = #1#74;

                  |SUB_EJECUTA_NP "dsz00002";

                  #0#5    = enUnidades;
                  nPrecio = enTBruto / enUnidades;
                  #0#6    = nPrecio;
                  |HAZ TotalLin71;
                  |HAZ liacarti;
               |FINSI;
               |GRABA 020#0a;
               |LIBERA #0;
           |FINSI;
     |SIGUE;
     nSwSirviendo = 0;
|FPRC;

|PROCESO rlcpl;|TIPO 0;
     |PINTA 445,#10#1;

     |HAZ CalCabAgifa036;
|FPRC;

|PROCESO rclped;|TIPO 0;
     |HAZ LimCabAgifa036;
     |BUCLELIN 0rlcpl#9;
     |GRABA 020#9a;
     |LIBERA #9;
|FPRC;

|PROCESO liadju;|TIPO 0;
     nModo  = (FEntrada / 100) ! 0;
     |SI nModo ! 1; |ACABA; |FINSI;

     |ABRE #9;
     #9#0 = #0#18;
     #9#46= #0#32;
     |LEE 120#9=;
     |SI FSalida ! 0;
          |ERROR;
     |SINO;
         |SI #1#3 ! #9#3;
             |MENAV "0000El cliente del deposito NO coincide con el del albaran";
             |ERROR;
         |SINO;
             hacer = 0;
             |BUCLELIN 2mirarser#9;
             |SI hacer = 1;
                 |SI primera = 0;
                     #1#4 = #9#4;#1#5 = #9#5;#1#7 = #9#7;#1#32 = #9#32;
                     #1#6 = #9#6;#1#8 = #9#8;#1#35 = #9#35;#1#31 = #9#31;
                     |ABRE #6;
                     #6#0 = #10#15;
                     |LEE 020#6=;
                     #1#33 = #9#33;#1#36 = #9#36;#1#40 = #6#41;#1#34 = #9#34;
                     |CIERRA #6;
                     #1#29 = #9#29;#1#30 = #9#30;
                 |FINSI;
                 FSalida = 0;
                 |SI #9#3 ! #1#3;|O #9#5 ! #1#5;|O #9#32 ! #1#32;
                  |O #9#7 ! #1#7;|O #9#6 ! #1#6;|O #9#8 ! #1#8;
                     |SI #9#39 > 0;
                         |MENAV "0000Este deposito NO corresponde a este albaran";
                          FSalida = 1;
                     |SINO;
                         |MENSA "0000Este deposito NO corresponde a este albaran";
                         |AVISO;
                         |CONFI "0000NAun asi desea incluir el deposito ? ";
                         |BLIN 4;
                     |FINSI;
                 |FINSI;

                 |SI FSalida = 0;
                     aponer = Asino;
                     |HAZ poncontr;
                     como = 1;
                     linea = #0#1;
                     |SI #0#22 = 0;
                         |BUCLELIN 0sirve#9;
                     |SINO;
                         |ABRE #10;
                         #10#22 = #0#32;
                         #10#0 = #0#18;
                         #10#1 = #0#22;
                         |LEE 101#10=;
                         |SI FSalida ! 0;
                              |CIERRA #10;
                              |MENAV "0000Linea inexistente...";
                              |ERROR; |ACABA;
                         |SINO;
                              |HAZ EsTaller;
                              |SI FSalida = 0; |Y #10#38 = -1;
                                   |MENAV "0000Linea de canon, adjudique la principal";
                                   |ERROR; |ACABA;
                              |FINSI;
                              nLinCanon = #10#38;

                              |HAZ sirve;

                              |HAZ EsTaller;
                              |SI FSalida = 0; |Y nLinCanon > 0;
                                   |SALVA_FICHA #0;
                                   #10#1 = nLinCanon;
                                   |LEE 101#10=;
                                   |SI FSalida = 0;
                                        |HAZ sirve;
                                        #0#63 = -1;
                                        |GRABA 020#0a;
                                   |FINSI;
                                   nLinCanon = #0#1;
                                   |REPON_FICHA #0;
                                   #0#63 = nLinCanon;
                                   |GRABA 020#0a;
                              |FINSI;
                         |FINSI;
                         |CIERRA #10;
                     |FINSI;

                     #9#3 = #1#3;#9#5 = #1#5;#9#32 = #1#32;
                     #9#7 = #1#7;#9#6 = #1#6;#9#8 = #1#8;
                     |HAZ rclped;

                     como = 0;
                     aponer = Anosi;
                     |HAZ poncontr;
                     |ERROR;
                     |PTEC 807;
                 |SINO;
                     |ERROR;
                 |FINSI;
             |SINO;
                 |ERROR;
                 |MENAV "0000Este Deposito esta Adjudicado";
             |FINSI;
         |FINSI;
         |LIBERA #9;
     |FINSI;
     |CIERRA #9;
|FPRC;

|PROCESO licomis;|TIPO 0;
     |SI #0Campo ! Contenido;
         enDescuento1 = #0#8;
         enDescuento2 = #0#33;
         eaTComision  = #0#16;
         eaCliente    = #1#3;
         eaArticulo   = #0#2;
         eaRepre      = #1#6;
         efFecha      = #1#1;
         eaSerie      = #0#29;
         enDirEnt = #1#84;
         enAlmacen = #0#3;
         |HAZ Comisiones;
         #0#10 = enComision;
         ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄMarhuenda
         eaUniMarhu = #0#5;
         |HAZ ComiMarhu;
         #0#8 = enDescuento1;
         #0#10 = enComision;
         #0#6 = pvp_ve;
         |PINTA #0#6;
         ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
         |PINTA #0#8;
         |PINTA #0#10;
     |FINSI;
|FPRC;


|PROCESO actulp;|TIPO 0;
     #10#5  = #10#5 -  (#0#5 * nForma);
     #10#28 = #10#28 - (#0#48 * nForma);

     #10#30 = #10#30 - (#0#50 * nForma);
     #10#18 = #10#18 + (#0#5 * nForma);
     #10#20 = #1#1;
     #0#25  = #10#5;

     |SI #2#194 = 2;
          #10#7   = #10#28 * #10#6;
          nImpDiv = #10#28 * #10#24;
     |SINO;
          #10#7   = #10#5  * #10#6;
          nImpDiv = #10#5  * #10#24;
     |FINSI;
     #10#9  = (#10#7   < #10#8) < #10#23;
     #10#25 = (nImpDiv < #10#8) < #10#23;

     |SI #9#51 = "B"; ||Si la Moneda de trabajo es la base ...
          #10#27 = #10#25; || ... el campo visual. es la divisa
     |SINO;
          #10#27 = #10#9;  || ... el campo visual es la moneda base
     |FINSI;

     |SI enGuerAuto ! 0;
          || Modulo Guerola , Adj deposito automatica
     |SINO;
          || La Estandar
          |GRABA 020#10a;
     |FINSI;
|FPRC;

|PROCESO lglp;|TIPO 0;
     |SI #0#20 = AS;
          |ABRE #10;
          |ABRE #9;
          #10#0 = #0#18;
          #10#1 = #0#22;
          #10#22= #0#32;
          |LEE 121#10=;
          |SI 0 = FSalida;
               #9#0 = #0#18;
               #9#46= #0#32;
               |LEE 121#9=;
               |SI 0 = FSalida;
                    |HAZ actulp;
                    |HAZ LimCabAgifa036;
                    |BUCLELIN 0rlcpl#9;
                    |GRABA 020#9a;
                    |LIBERA #9;
               |FINSI;
               |LIBERA #10;
          |FINSI;
          |CIERRA #10;
     |FINSI;
|FPRC;

|PROCESO liacarti;|TIPO 2;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     modo = (FEntrada / 100) ! 0;
     nForma = 0 +. 1;

     |HAZ EsTaller; nSwTaller = FSalida;

     |SI nSwTaller = 0; |Y nSwSirviendo = 0;
          |SI #0#63 = -1; |Y enModo036 ! 3;
               |SI nForma = -1;
                    |MENAV "0000Linea canon de articulo, no se puede modificar";
               |FINSI;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     |SI modo = 2;|O modo = 3;
           efFec = #1#1;
           enAlma = #0#3;
           |HAZ MiraHisL;
           |SI enErrHis ! 0;
                |ERROR;
                |ACABA;
           |FINSI;
     |FINSI;

     |SI como = 0;       || tipo2 normal
         |HAZ lglp;
     |SINO;              || sirviendo linea
         |HAZ actulp;
         |HAZ LimCabAgifa036;
         |BUCLELIN 0rlcpl#9;
         |GRABA 020#9a;
         |LIBERA #9;
     |FINSI;

     imneto = #0#9 < #1#5;
     imneto = imneto < #1#7;
     imneto = imneto < #1#32;

     #1#42 = #1#42 +. 1;

     ||-------------------Actualiza Historico, Articulo y Almacen
     enForma = 0 +. 1;
     |HAZ AcumulaAV;
     ||----------------------
     #0#14      = enCoste;
     #1#37      = #1#37 + (imneto - enCoste);

     |HAZ CalCabAgifa010;

     |SI modo ! 3; |HAZ visual_totales2; |FINSI;

     |SI nForma = 1;
          ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄModulo 001655
          |HAZ EsOrts;
          |SI FSalida = 0;
               eaSeriePedido = #agifa071#32;
               enCodigPedido = #agifa071#18;
               enLineaPedido = #agifa071#22;
               eaSerie = #agifa071#29;
               enCodigo = #agifa071#0;
               enLinea = #agifa071#1;
               |SUB_EJECUTA_NP "dsz99905;ADJDEP";
          |FINSI;
          ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |FINSI;

     |SI enGuerAuto = 0;
          |HAZ EsGuerola;
          |SI FSalida = 0;
               enForma = nForma;
               enModo = modo;
               efFecha = #1#1;
               |HAZ GueDepoRegula;
          |FINSI;
     |FINSI;


     |SI modo = 3;
          ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
          aTipoDA = "A"; |HAZ BajaDA;
          |HAZ BorraKit;
          ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
          eaTipo        = "AV";
          eaSerie       = #0#29;
          enCodigo      = #0#0;
          enLinea       = #0#1;
          efFecha       = #1#1;
          eaArticulo    = #0#2;
          enAlmacen     = #0#3;
          enUnidades    = #0#5;
          eaSeriePedido = #0#32;
          enCodigPedido = #0#18;
          enLineaPedido = #0#22;
          eaAbono       = #1#43;
          eaDeposito    = "S";
          |SUB_EJECUTA_NP "dsz00002;BAJA";

          |HAZ EsOrts;
          |SI FSalida = 0;
               eaDocu = "agifa071";
               eaSerie = #0#29;
               enCodigo = #0#0;
               enLinea = #0#1;
               |SUB_EJECUTA_NP "dsz99905;BORRA";
          |FINSI;
     |FINSI;

     |SI nSwTaller = 0; |Y enModo036 ! 3;
          |SI modo = 2; |HAZ TallerModiLin; |FINSI;
          |SI modo = 3; |HAZ TallerBorLin; |FINSI;
     |FINSI;
|FPRC;

|PROCESO pantdep2;|TIPO 13;

     |SI FSalida = 9;
          |PUSHV 501 2380;
          |PINPA #0#1;
          |PINDA #0#1;
          |PAUSA;
          |POPV;
     |FINSI;

     |HAZ visual_totales2;
|FPRC;

|PROCESO Descri28; |TIPO 0;
     |HAZ PintaDes28;
|FPRC;

|PROCESO decim;
     |SI Campo = 6; |O Campo = 36;
          |SI FSalida = 13;
               |HAZ EsAparecida;
               |SI FSalida = 0;
                    enPrecio = #0Campo;
                    eaArticulo = #0#2;
                    eaCliente = #1#3;
                    |SUB_EJECUTA_NP "aparm010";
                    #0Campo = enPrecio; |PINTA #0Campo;
                    |ERROR; |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     #0#5 = #0#5 ! n_dec;
     |PINTA #0#5;
     |SI #142#5 ! "N";
          |HAZ DispoKit;
     |FINSI;
|FPRC;

|PROCESO norec;
   |SI #9#15 > 0;
       #81#0 = #9#46; ||Serie
       #81#1 = #9#0;  ||Pedido
       |GRABA 001#81n;
   |FINSI;
|FPRC;


|DEFBUCLE leedeps;
#9#1;
3;
l1_inf , 000000 , #1#3 ;
l1_sup , 999999 , #1#3 ;
;
NULL,norec;
|FIN;

|PROCESO pendv; |TIPO 6;
     nTecla = FSalida;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1; |Y Campo = 32;
          |SI nTecla = 1; |O nTecla = 4; |O nTecla = 2; ||Anula ESC y Flechas
               |ERROR; |PTEC 807; |ACABA;
          |FINSI;
     |FINSI;

     |SI FSalida = 12;
        |HAZ CreaTempo; aTempo81 = Tempo;
        |NOME_DAT #81 aTempo81; |DELINDEX #81;

        |ABRE #81;
        |SI Campo = 32; ||Llamado desde campo serie
            l1_inf = "  ";
            l1_sup = "zz";
        |SINO; ||Llamado desde pedido
            l1_inf = #0#32;
            l1_sup = #0#32;
        |FINSI;
        |BUCLE leedeps;
        |SI Campo = 32; ||Llamado desde campo serie
            |CONSULTA_CLAVE #1#81;
            |SI FSalida = 0; ||Intro
               #0#32  = #81#0; ||Pongo Serie seleccionada
               #0#18  = #81#1; ||Pongo Npedido
               |PINTA #0#32;
               |PINTA #0#18;
               |PTEC 802;
            |SINO;
               |ERROR;
            |FINSI;
        |SINO;
            |CONSULTA_CLAVE #2#81; ||Llamado desde pedido
            |SI FSalida = 0; ||Intro
               #0#18  = #81#1; ||Pongo Npedido
               |PINTA #0#18;
            |SINO;
               |ERROR;
            |FINSI;
        |FINSI;
        |CIERRA #81;
        |DELINDEX #81; Tempo = aTempo81; |HAZ BoraTempo;
     |FINSI;
|FPRC;

||DIVISAS

|PROCESO decim1;
     |SI #2#176 = "S";  |Y nPrecio ! 0;
         |SI #1#70 = "D";  || Si la moneda de trabajo es la divisa ...
             #0#36 = nPrecio;
         |SINO;
             #0#6  = nPrecio;
        |FINSI;
     |FINSI;

     |SI #1#70 = "D";  || Si la moneda de trabajo es la divisa ...
         #0#6 = #0#36 / #1#69 * #1#74;  || ... recalculo en funcion de la divisa
     |SINO;
         #0#36 = #0#6 / #1#74 * #1#69; || .. recalculo en funcion de la moneda base
     |FINSI;

     |HAZ visual_precio2; || Visualiza el precio
|FPRC;


|PROCESO LinDiv2;  |TIPO 7;
     |ABRE #279; |LEE 000#279p; |CIERRA #279;
     nPreDtoAnt = 0;

     nModo = (FEntrada / 100) ! 0;
     |HAZ PintaMedidaV;
     |SI nModo = 1;
          |C_M #0#32, 1, "S";
          |C_M #0#18, 1, "S";
          |C_M #0#22, 1, "S";
     |SINO;
          |C_M #0#32, 1, "N";
          |C_M #0#18, 1, "N";
          |C_M #0#22, 1, "N";
     |FINSI;

     |ABRE #agifa321;
     |LEE 001#agifa321.p;  || Leo parametros de divisa
     |SI ac_divisa = "S"; |Y pintado = 0; || Si divisas estan activadas y no he pintado ...
       |SI #1#70 = "D";   || Si la moneda de trabajo es la divisa la pinto en
         |ATRI R;         || el encabezado del precio y el importe
         titdiv = "Precio" + "(" + #1#68 + ")";
         |PINTA 1544,titdiv;
         titdiv = "I.Tot." + "(" + #1#68 + ")";
         |PINTA 1568,titdiv;
         |ATRI r;
       |FINSI;
       |SI #agifa321#3 = "S";  || Si la visualizacion esta activada ...
         mensa = "Precio:            Imp.:              T.Bruto:             T.ALB:             ";
         |PINTA 1102,mensa;  || ... pinto la linea de visualizacion
         |PINTA #0#38; || Pinto precio visual
         |PINTA #0#39; || Pinto importe visual
         |SI #1#70 = "D"; || Si la moneda de trabajo es la divisa
           |PINTA 1149,#1#79;
           |PINTA 1168,#1#80;
         |SINO;
           |PINTA 1149,#1#75;
           |PINTA 1168,#1#76;
         |FINSI;
         pintado = 1;  || Ya hemos pintado
       |FINSI;
     |FINSI;
     |CIERRA #agifa321;
     |HAZ PintaDes28;
|FPRC;

|PROCESO visual_precio2; || Pinta el precio visual.
|SI #1#70 = "D";  || Si la moneda de trabajo es la divisa ...
  #0#38 = #0#6;   || ... el campo visualiz. es el precio en moneda base
  |PINTA #0#36;
|SINO;            || Si la moneda de trabajo es la moneda base ...
  #0#38 = #0#36;  || ... el campo visual. es el precio en divisa
  |PINTA #0#6;
|FINSI;
|SI ac_divisa = "S"; |Y #agifa321#3= "S";
  |PINTA #0#38; || Si las divisas y la visualizacion estan activadas, pinto
|FINSI;
|FPRC;

|PROCESO visual_importe2;  || Pinta el importe visual
|SI #1#70 = "D";  || Si la moneda de trabajo es la divisa ...
  #0#39 = #0#9;   || el campo visualiz. es el importe en moneda base
  |PINTA #0#37;
|SINO;            || Si la moneda de trabajo es la moneda base ...
  #0#39 = #0#37;  || el campo visualiz. es el importe en divisa
  |PINTA #0#9;
|FINSI;
|SI ac_divisa = "S"; |Y #agifa321#3= "S";
  |PINTA #0#39;   || Si las divisas y la visualizacion estan activadas, pinto
|FINSI;
|FPRC;

|PROCESO visual_totales2;
     |ABRE #agifa321;
     |LEE 001#agifa321.p;
     |SI #1#70 = "D";
          |SI ac_divisa = "S"; |Y #agifa321#3= "S";
               |PINTA 1149,#1#79;
               |PINTA 1168,"        ";
               |PINTA 1168,#1#80;
          |FINSI;
          |CIERRA #agifa321;
          |PINTA 1449,#1#75;
          |PINTA 1466,#1#76;
     |SINO;
          |SI ac_divisa = "S"; |Y #agifa321#3= "S";
               |PINTA 1149,#1#75;
               |PINTA 1168,"        ";
               |PINTA 1168,#1#76;
          |FINSI;
          |CIERRA #agifa321;
          |PINTA 1449,#1#15;
          |PINTA 1466,#1#67;
     |FINSI;
|FPRC;

|PROCESO DecimPedido;
     |ABRE #agifa324;
     pintado = 0;  ||Controla pintados de las lineas
     #agifa324#0 = #agifa036#49;
     |LEE 001#agifa324.=;   || Leo la divisa
     ||nDeci_DivD = #agifa324#7;   || Decimales de la divisa
     ||nDeci_PreDivD = #agifa324#9;  || Decimales en el precio de la divisa
     |CIERRA #agifa324;
|FPRC;

|PROCESO comp_div; |TIPO 0;
     |HAZ DecimPedido;
     |ABRE #9;
     #9#0   = #0#18;
     #9#46  = #0#32;
     |LEE 010#9=;
     |SI #9#49 ! #1#68; |O #9#51 ! #1#70;
          |MENAV "0000No coincide la divisa y/o la moneda de trabajo";
          |ERROR;
     |FINSI;
     |CIERRA #9;
|FPRC;

|PROCESO Tipo7Serie;  |TIPO 7;
     nModo = (FEntrada / 100) ! 0;

     |ABRE #2;
     #2#0 = #0#2;
     |LEE 040#2=;
     |SI FSalida ! 0;  |DDEFECTO #2;  |FINSI;
     |CIERRA #2;

     |SI #2#176 = "N";  |ACABA;  |FINSI;

     |C_M #0#18, 1, "N";
     |C_M #0#32, 1, "N";
|FPRC;

|PROCESO Tipo7Uni;  |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1; |ACABA; |FINSI;

     |HAZ DobleUniV;
     |SI eaSw2Stock = "S";
          |C_M #0#5, 1, "N";
     |FINSI;

     |SI #agifa142#72 = "S";
          |HAZ Envase028;
          |C_M #0#5, 1, "S";
          |SI enEntraEnvase ! 0;  |C_M #0#5, 1, "N";  |FINSI;
     |FINSI;


     |ABRE #2;
     #2#0 = #0#2;
     |LEE 040#2=;
     |SI FSalida ! 0;  |DDEFECTO #2;  |FINSI;
     |CIERRA #2;

     |SI #2#176 = "N";  |ACABA;  |FINSI;

     eaTipo        = "AV";
     eaSerie       = #0#29;
     enCodigo      = #0#0;
     enLinea       = #0#1;
     efFecha       = #1#1;
     eaArticulo    = #0#2;
     enAlmacen     = #0#3;
     enUnidades    = #0#5;
     enTBruto      = #0#7;
     enTarifa      = #6#39;
     eaSeriePedido = #0#32;
     enCodigPedido = #0#18;
     enLineaPedido = #0#22;
     eaAbono       = #1#43;
     eaDeposito    = "S";
     efFecha       = #1#1;
     eaCliente     = #1#3;
     enCamBas      = #1#69;
     eaMoneda      = #1#70;
     enCamDiv      = #1#74;

     |SUB_EJECUTA_NP "dsz00002";

     #0#3    = enAlmacen;
     #0#5    = enUnidades;
     nPrecio = enTBruto / enUnidades;
     #0#6    = nPrecio;

     |PTEC 802;
     |PTEC 802;
|FPRC;

|PROCESO Tipo11028;  |TIPO 11;
     |SI FSalida = 7;  |Y #2#176 = "S";
         |MENAV "      Imposible abortar;  Termine de introducir la linea y efectue una Baja.";
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO Tipo11Lin; |TIPO 11;
     salida = FSalida;
     |SI salida = 13;
          |HAZ EsOrts;
          |SI FSalida = 0;
               eaDocu = "agifa071";
               eaSerie = #0#29;
               enCodigo = #0#0;
               enLinea = #0#1;
               |SUB_EJECUTA_NP "dsz99905;VER";
          |FINSI;

          |HAZ VerDobleUniV;
          |HAZ VerKit;
          |ERROR;
     |FINSI;
     aAlfa = #0#2; |QBF aAlfa;
     |SI salida = 16; |Y aAlfa ! "";
          |SI #142#203 = "S"; |O #142#40 = "S";
               aTipoDA = "A"; |HAZ VerDA;
          |FINSI;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Tipo5_028;  |TIPO 5;
     |HAZ actal;
|FPRC;

|PROCESO MinC028
     #referen@#29 = #1#52;
     #referen@#0 = #1#0;
     #referen@#1 = 001;
|FPRC;

|PROCESO MaxC028;
     #referen@#29 = #1#52;
     #referen@#0 = #1#0;
     #referen@#1 = 999;
|FPRC;

|PROCESO Consulta028; |TIPO 66;
     nLin = 0;
     |DDEF aAlfa;
     aAlfa = aAlfa + "agifa028";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          |CONSULTA_F_CLAVE #1#referen@, MinC028, MaxC028;
          |SI FSalida = 0; nLin = #referen@#1; |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
     |SI nLin ! 0;
          |PTEC 802;
          aAlfa = ("000" + nLin) % -103;
          aPtec = aAlfa % 301; nPtec = &aPtec;
          |PTEC nPtec;
          aPtec = aAlfa % 201; nPtec = &aPtec;
          |PTEC nPtec;
          aPtec = aAlfa % 101; nPtec = &aPtec;
          |PTEC nPtec;
     |FINSI;
|FPRC;

|PROCESO CheqPCM_PVP28; |TIPO 0;
     eaArticulo = #0#2;
     enPrecio = #0#6;
     enDto1 = #0#8;
     enDto2 = #0#33;
     |HAZ CheqPCM_PVP;

     |SI #279#3 = "S";
          eaArticulo = #0#2;
          enPrecio = #0#6;
          enDto1 = #0#8;
          enDto2 = #0#33;
          nNume =  (enPrecio < enDto1) < enDto2;
          |SI nNume ! nPreDtoAnt;
               |SUB_EJECUTA_NP "dsz00100";
               |SI enError ! 0; |ERROR; |ACABA; |FINSI;
               nPreDtoAnt = nNume;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GuerDiasFac;
     nDias = 0;
     |DDEF aDef;
     aAlfa = aDef + "guerm056";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar 'guerm056'";
          |ACABA;
     |FINSI;
     |DDEFECTO #referen@;
     |ABRE #referen@;
     #referen@#0 = #10#22;
     #referen@#1 = #10#0;
     |LEE 000#referen@.=;
     fFecha = #referen@#4;
     |SI fFecha ! "01.01.0000";
          fFecha =  #referen@#4 + 1;
     |FINSI;
     |SI fFecha = "01.01.0000";
          fFecha = #9#1;
     |FINSI;

     |CIERRA #referen@;
     |DESCARGA_DEF #referen@;

     aAlfa = aDef + "guerm057";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar 'guerm057'";
          |ACABA;
     |FINSI;
     |DDEFECTO #referen@;
     |ABRE #referen@;
     |LEE 000#referen@.p;
     nCalen = #referen@#1;
     aA¤o = #referen@#2;
     |CIERRA #referen@;
     |DESCARGA_DEF #referen@;

     aAlfa = aDef + "guerm058";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar 'guerm058'";
          |ACABA;
     |FINSI;
     |DDEFECTO #referen@;
     |ABRE #referen@;
     #referen@#0 = #0#2;
     |LEE 000#referen@.=;
     aTipoFac = #referen@#1;
     |CIERRA #referen@;
     |DESCARGA_DEF #referen@;

     |SI aTipoFac = "R"; ||Dias Reales;
          nDias = #1#1 - fFecha + 1;

     |SINO;              || "L"   Segun Calendario
          aAlfa = aDef + "guerm214";
          |CARGA_DEF aAlfa, referen@;
          |SI FSalida ! 0;
               |MENAV "0000Error al cargar 'guerm214'";
               |ACABA;
          |FINSI;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = nCalen;
          #referen@#13 = aA¤o;
          |LEE 000#referen@.=;
          |PARA f = fFecha; |SI f [ #1#1; |HACIENDO f = f + 1;
               aAlfa = f % 102; nDia = aAlfa;
               aAlfa = f % 402; nMes = aAlfa;
               aAlfa = #referen@#nMes#;
               nDia = nDia * 100 + 1;
               aTrabaja = aAlfa % nDia;
               |SI aTrabaja = 0;
                    nDias = nDias + 1;
               |FINSI;
          |SIGUE;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO T028_6_0; |TIPO 0;
     |SI #279#3 = "S";
          eaArticulo = #0#2;
          enPrecio = #0#6;
          enDto1 = #0#8;
          enDto2 = #0#33;
          nNume =  (enPrecio < enDto1) < enDto2;
          |SI nNume ! nPreDtoAnt;
               |SUB_EJECUTA_NP "dsz00100";
               |SI enError ! 0; |ERROR; |ACABA; |FINSI;
               nPreDtoAnt = nNume;
          |FINSI;
     |FINSI;
|FPRC;

----------------------------------------------
|PROCESO TallerModiLin;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa071";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     nUni = #0#5;
     |ABRE #referen@;
     #referen@#29 = #0#29;
     #referen@#0 = #0#0;
     #referen@#1 = #0#63;     || Usa linea promocion
     |LEE 101#referen@.=;
     |SI FSalida = 0;
          #referen@#5 = nUni;
          |GRABA 020#referen@.a;
          |SALVA_DATOS #0;
          |SALVA_DATOS #referen@;
          |REPON_DATOS #0;
          |HAZ TallerAcumu;
          |REPON_DATOS #0;
     |FINSI;
     |CIERRA #referen@;

     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO TallerBorLin;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa071";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen@;
     #referen@#29 = #0#29;
     #referen@#0 = #0#0;
     #referen@#1 = #0#63;     || Usa linea promocion
     |LEE 101#referen@.=;
     nTallerBorLin = FSalida;
     |SI FSalida = 0;
          |SALVA_DATOS #0;
          |SALVA_DATOS #referen@;
          |REPON_DATOS #0;
          |HAZ TallerAcumu;
          |REPON_DATOS #0;
          |BORRA 020#referen@.a;
          |PONCONTROL 23, "SI";
          |PTEC 809; |PTEC 808;
     |FINSI;
     |CIERRA #referen@;

     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO AcuAlbaran;
     |HAZ CalCabAgifa010_2;
     |HAZ visual_totales2;
|FPRC;

|PROCESO TallerAcumu;
     |HAZ lglp;

     imneto = #0#9 < #1#5;
     imneto = imneto < #1#7;
     imneto = imneto < #1#32;

     #1#42 = #1#42 + nForma;

     ||-------------------Actualiza Historico, Articulo y Almacen
     enForma = nForma;
     |HAZ AcumulaAV;
     ||----------------------
     #0#14 = enCoste;
     #1#37 = #1#37 + (imneto - enCoste);

     |HAZ CalCabAgifa010;

     |SI modo ! 3; |HAZ visual_totales2; |FINSI;
|FPRC;

|PROCESO Precio28_7; |TIPO 7;
     aAlfa = "0000Precio";
     |HAZ EsAparecida;
     |SI FSalida = 0;
          aAlfa = "0000<F5> Tarifas";
     |FINSI;
     |MENSA aAlfa;
|FPRC;

|PROCESO PintaDes28;
     |HAZ EsAparecida;
     |SI FSalida = 0;
          |C_A #0#4, 0, nNume;
          |C_A #0#4, 1, 50;
          |PINTA 2302, "³Descripcion: ";
          |PINTA 2316, #0#4;
          |C_A #0#4, 1, nNume;
     |FINSI;
|FPRC;

|PROCESO IVA028_0; |TIPO 0;
     enTiva = #0Campo;
     efFiva = #1#1;
     |HAZ SacaIVA;
     |SI eaDiva = "";
          |MENAV "0000No existe tipo iva para esta fecha...";
          |ERROR; |ACABA;
     |FINSI;
|FPRC;

|PROCESO IVA028_66; |TIPO 66;
     enTiva = #0Campo;
     efFiva = #1#1;
     |HAZ ConsuIVA;
     |SI eaDiva = "";
          |ERROR;
     |SINO;
          #0Campo = enTiva; |PINTA #0Campo;
     |FINSI;
|FPRC;

|PROCESO Envase028;
     qAbono    = "N";
     Envase    = #0#34;
     Unidades1 = #0#35;
     Unidades2 = #0#5;
     VArticulo = #0#2;
     enAlmacen = #0#3;
     eaTipo = "V";
     eaProgEnv = "deposito";
     |HAZ EntraEnvase;
     #0#34 = Envase;
     #0#35 = Unidades1;
     #0#5  = Unidades2;  |PINTA #0#5;
|FPRC;
