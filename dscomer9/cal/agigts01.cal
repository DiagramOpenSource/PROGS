|FICHEROS;
     agigts01 #0;
     dsw00057 #1;
     dsw00058 #2;
     dsm00005 #5;
     dsm00006 #6;
     agifa007 #7;
     agifa010 #10;
     dsm00036 #36;
     dsm00037 #37;
     agifa071 #71;
     agifa065 #65;
     agifa019 #19;
     agifa084 #84;
     agifa069 #69;
     agifa077 #77;
     agifa080 #80;
     agifa142 #142;
     dsm00056 #56; ||Valora
     dsm00057 #57;
     dsm00043 #43; ||Regula
     dsm00044 #44;
     dsm00054 #54; ||Movi
     dsm00055 #55;
     dsm00010 #100;
     agifa048 #480;
     agifa049 #49;
     agifa501 #501;
     agifa502 #502;
     agist001 #200;
     agist002 #201;
     dsw00087 #87;
     referen@;

     conw0002@;     ||Tmp Taller (Albaranes hechos por el modulo)
     con00009@;     ||Aux Histo
     con00004@;
     con00612@;
     con00625@;
|FIN;

|VARIABLES;
     JUAN = 0;
     nUniEle = 0;
     aEsDesglose = "";
     nUniTotal = 0;
     nUniDesglose = 0;
     nError = 0;
     aOrg = "";
     aDes = "";
     nUniDoc = 0;
     aEsModulo = "";
     aPath = "";
     aTmpTaller = "";
     i = 0;
     nSwTaller = 0;
     nPreTon = 0;
     &Tempo = "";
     nUniMulti = 0;
     nUni1 = 0;
     nUni2 = 0;
     aDoble = "";
     aParti = "";
     aMulti = "";
     nAlma = 0;
     nDife = 0;
     nLin = 0;
     nSuma = 0;
     aAlfa = "";
     nAbo = 0;
     aTipo = "";
     nUni = 0;
     aEle = "";
     aEleUni = "";
     aTipoEsca = "";
     nEsEscan = 0;
     aArti = "";
     aDef = "";
     aSer = "";
     nNum = 0;
     aAlf1 = "";
|FIN;

|INCLUYE i_escand;

********************************************
Este proceso compara las unidades de los historicos despues del recalculo
al ejecutar la segunda vez no debe de haber diferencias
se activa con la variable JUAN = 1
(se usa para comprobar que el calculo es correcto)

|PROCESO CopiaHisto;
     |DFICE aPath;
     aOrg = aPath + "agifa065.dat";  aDes = aPath + "historic.dat"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aPath + "agifa065.ddx";  aDes = aPath + "historic.ddx"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aPath + "agifa065.ixx";  aDes = aPath + "historic.ixx"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aPath + "dsm00006.dat";  aDes = aPath + "historiv.dat"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aPath + "dsm00006.ddx";  aDes = aPath + "historiv.ddx"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aPath + "dsm00006.ixx";  aDes = aPath + "historiv.ixx"; |COPIA_FICHERO aOrg, aDes;
|FPRC;

|PROCESO CheqHisto;
     |DDEF aPath;
     aAlfa = aPath + "agifa065";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          aAlfa = "historic";
          |NOME_DAT #referen@#aAlfa#;
          |ABRE #referen@;
          |ABRE #65;
          |LEE 000#65p;
          |PARA; |SI FSalida = 0; |HACIENDO;
               #referen@#0 = #65#0;
               #referen@#1 = #65#1;
               #referen@#2 = #65#2;
               #referen@#3 = #65#3;
               #referen@#4 = #65#4;
               #referen@#11 = #65#11;
               |LEE 000#referen@.=:
               |SI FSalida = 0;
                    |SI #referen@#6 ! #65#6;
                         aAlfa = "0000ERROR mal calculado."; |MENAV aAlfa;
                         |DEBUG;
                    |SINO;
                         |BORRA 020#referen@.a;
                    |FINSI;
               |SINO;
                    aAlfa = "0000ERROR mal calculado."; |MENAV aAlfa;
                    |DEBUG;
               |FINSI;
               |LEE 000#65s;
          |SIGUE;

          |LEE 000#referen@.p;
          |SI FSalida = 0;
               aAlfa = "0000ERROR mal calculado."; |MENAV aAlfa;
               |DEBUG;
          |FINSI;

          |CIERRA #65;
          |CIERRA #referen@;
          |DELINDEX #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;

     aAlfa = aPath + "dsm00006";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          aAlfa = "historiv";
          |NOME_DAT #referen@#aAlfa#;
          |ABRE #referen@;
          |ABRE #6;
          |LEE 000#6p;
          |PARA; |SI FSalida = 0; |HACIENDO;
               #referen@#0 = #6#0;
               #referen@#1 = #6#1;
               #referen@#2 = #6#2;
               #referen@#3 = #6#3;
               #referen@#4 = #6#4;
               #referen@#5 = #6#5;
               #referen@#6 = #6#6;
               #referen@#7 = #6#7;
               |LEE 000#referen@.=:
               |SI FSalida = 0;
                    |SI #referen@#9 ! #6#9;
                         aAlfa = "0000ERROR mal calculado."; |MENAV aAlfa;
                         |DEBUG;
                    |SINO;
                         |BORRA 020#referen@.a;
                    |FINSI;
               |SINO;
                    aAlfa = "0000ERROR mal calculado."; |MENAV aAlfa;
                    |DEBUG;
               |FINSI;
               |LEE 000#6s;
          |SIGUE;

          |LEE 000#referen@.p;
          |SI FSalida = 0;
               aAlfa = "0000ERROR mal calculado."; |MENAV aAlfa;
               |DEBUG;
          |FINSI;
          |CIERRA #6;
          |CIERRA #referen@;
          |DELINDEX #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;
********************************************

|PROCESO CreaElemeInterno;
     #6#3 = #65#2;
     #6#9 = -#6#9;
     |BORRA 000#6c;
     |GRABA 020#6n;
|FPRC;

|DEFBUCLE CreaElemeInterno;
     #6#1;
     ;
     #65#0, #65#5, #65#1, aTipo, #65#11, #65#3, nLin, "      ";
     #65#0, #65#5, #65#1, aTipo, #65#11, #65#3, nLin, "zzzzzz";
     be;
     NULL, CreaElemeInterno;
|FIN;

|PROCESO TallerAuxHis;
     |SI nSwTaller = 0;
          |SI #65#2 = "AV"; |O #65#2 = "BV";
               #con00612@#0 = #65#11;
               #con00612@#1 = #65#3;
               |LEE 000#con00612@.=;
               |SI FSalida ! 0; |DDEFECTO #con00612@; |FINSI;

               #con00625@#0 = #con00612@#2;
               #con00625@#1 = #con00612@#3;
               |LEE 000#con00625@.=;
               |SI FSalida ! 0; |DDEFECTO #con00625@; |FINSI;

               aEsModulo = "N";      || Si existe en el Aux se ha hecho por el modulo
               #conw0002@#0 = #65#11;
               #conw0002@#1 = #65#3;
               #conw0002@#2 = #65#4;
               |LEE 000#conw0002@.=;
               |SI FSalida = 0; aEsModulo = "S"; |FINSI;

               #con00004@#0 = #65#11;
               #con00004@#1 = #65#3;
               #con00004@#2 = #65#4;
               |LEE 000#con00004@.=; || Si existe seccion se ha hecho por el modulo
               |SI FSalida = 0; aEsModulo = "S"; |FINSI;
               |SI FSalida ! 0; |DDEFECTO #con00004@; |FINSI;

               #con00009@#0 = #65#0;
               #con00009@#1 = #65#1;
               #con00009@#2 = #65#2;
               #con00009@#3 = #65#3;
               #con00009@#4 = #65#4;
               #con00009@#5 = #65#11;
               #con00009@#6 = #con00612@#8;
               #con00009@#7 = #con00612@#2;
               #con00009@#8 = #con00612@#3;
               #con00009@#9 = #con00625@#11;
               #con00009@#10 = #con00625@#19;
               #con00009@#11 = #con00004@#3;
               #con00009@#12 = aEsModulo;
               |GRABA 020#con00009@.n;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ProcesadoCab;
     |DDEFECTO #19;
     #19#0 = #36#4;||Articulo;
     |LEE 000#19=;

     #0#1 = "S1";  |PINTA #0#1;
     #0#2 = #36#0; |PINTA #0#2;
     #0#3 = 0;     |PINTA #0#3;

     |DDEFECTO #65;
     #65#0 = #36#4;
     #65#1 = #36#35;
     #65#2 = "S1";
     #65#3 = #36#0;
     #65#4 = 0;
     #65#5 = #36#5;
     #65#6 = -#36#7;
     ||#65#7 = #19#6;
     #65#8 = #19#9;
     #65#9 = #36#9;
     #65#10 = "";
     #65#11 = "";
     #65#12 = 0;
     #65#13 = 0;
     #65#14 = #65#9;
     #65#15 = "N";
     #65#16 = "01.01.0000";
     #65#17 = -#36#8;
     #65#18 = #36#6;
     #65#19 = #36#15;
     |HAZ Chequea;
     |SI FSalida ! 0;
          |GRABA 020#65n;
     |FINSI;
|FPRC;

|PROCESO ProcesadoLin;
     |DDEFECTO #19;
     #19#0 = #37#3;||Articulo;
     |LEE 000#19=;

     |DDEFECTO #65;
     #65#0 = #37#3;
     #65#1 = #36#35;
     #65#3 = #37#0;
     #65#4 = #37#1;
     #65#5 = #37#4;
     ||#65#7 = #19#6;
     #65#8 = #19#9;
     #65#9 = #37#15;
     #65#10 = "";
     #65#11 = "";
     #65#12 = 0;
     #65#13 = 0;
     #65#14 = #65#9;
     #65#15 = "N";
     #65#16 = "01.01.0000";
     #65#18 = #37#5;
     #65#19 = #37#17;

     |SI #37#2 = "P"; |O #37#2 = "S";
          #65#2 = "F1";
          #65#6 = #37#10;
          #65#17 = #37#16;
     |SINO;
          #65#2 = "S1";
          #65#6 = -#37#10;
          #65#17 = -#37#16;
     |FINSI;
     |HAZ Chequea;
     |SI FSalida ! 0;
          |GRABA 020#65n;
     |FINSI;
|FPRC;

|DEFBUCLE Procesado;
     #36#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, ProcesadoCab, ProcesadoLin;
|FIN;

|PROCESO LinEscan;
     |DDEFECTO #19;
     #19#0 = aEscan;
     |LEE 000#19=;

     #65#0 = aEscan;  ||Articulo;
     |LEE 101#65=;
     |SI FSalida ! 0; |GRABA 020#65b; |FINSI;
     #65#5 = #49#9;  ||Almacen
     #65#6 = nCantiEscan * nUni;
     #65#9 = #19#18;
     #65#12 = 0;
     #65#13 = 0;
     #65#21 = 0;
     #65#14 = #19#18;
     |GRABA 020#65a;
     |LIBERA #65;

     |HAZ TallerAuxHis;
|FPRC;

|PROCESO DesLinKit1;
     |DDEFECTO #19;
     #19#0 = #referen@#3;
     |LEE 000#19=;

     #65#0 = #referen@#3;  ||Articulo;
     |LEE 101#65=;
     |SI FSalida ! 0; |GRABA 020#65b; |FINSI;
     #65#5 = #referen@#4;  ||Almacen
     #65#6 = #referen@#5 * nUni;
     #65#9 = #19#18;
     #65#12 = 0;
     #65#13 = 0;
     #65#21 = 0;
     #65#14 = #19#18;
     |GRABA 020#65a;
     |LIBERA #65;

     |HAZ TallerAuxHis;
|FPRC;

|DEFBUCLE DesLinKit1;
     #referen@#1004;
     ;
     aSer, nNum, nLin, 001;
     aSer, nNum, nLin, 999;
     ;
     NULL, DesLinKit1;
|FIN;

|PROCESO DesLinKit;
     aDef = "";
     |SI #65#2 = "TI"; aDef = "dsm00051"; |FINSI;
     |SI #65#2 = "AV"; |O #65#2 = "BV"; aDef = "dsm00047"; |FINSI;
     |SI #65#2 = "FC"; aDef = "dsm00048"; |FINSI;

     |SI aDef = ""; |ACABA; |FINSI;

     |DDEF aAlfa;
     aAlfa = aAlfa + aDef;
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |BUCLE DesLinKit1;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO Escandallo;
     aArti = #65#0;
     aSer = #65#11;
     nNum = #65#3;
     nLin = #65#4;
     nUni = #65#6;

     aTipoEsca = #142#12;
     #480#0 = aArti;
     |LEE 000#480=;
     |SI FSalida = 0; |Y #142#12 = "X";
          aTipoEsca = #480#33;
     |FINSI;
     nEsEscan = FSalida;

     |SI aTipoEsca = "S";
          aEscan = aArti;
          nCantiEscan = 1;
          |HAZ DesglosaEscan;
     |FINSI;
     |SI aTipoEsca = "K";
          |SI nEsEscan = 0;
               |HAZ DesLinKit;
          |FINSI;
     |FINSI;
     |SI aTipoEsca = "N"; |Y #142#126 > 0;
          nMaxNivel = #142#126;
          aEscan = aArti;
          nCantiEscan = 1;
          |HAZ DesglosaEscan;
     |FINSI;
|FPRC;

|PROCESO TipoUni;
     aMulti = #142#163;
     aDoble = #142#117;
     |SI aMulti = "S";
          |SI aDoble = "S"; aDoble = #19#179; |FINSI;
          |SI aMulti = "S"; aMulti = #19#204; |FINSI;
     |FINSI;
     |SI aMulti = "S";
          nUniMulti = nUni1;
          nUni1 = nUni2;
          nUni2 = nUniMulti;
     |FINSI;
|FPRC;

|PROCESO CuadraEleme;
     |DDEFECTO #5;
     #5#0 = aTipo;
     #5#1 = #65#11;
     #5#2 = #65#3;
     #5#3 = #65#4;
     #5#4 = aEle;
     |LEE 101#5=
     |SI FSalida ! 0; |GRABA 020#5b; |FINSI;
     #5#6 = #5#6 + nDife;
     #5#7 = #65#9;
     #5#8 = #5#6 * #5#7;
     #5#13 = #5#7;
     #5#14 = #5#8;
     |GRABA 020#5a;
     |LIBERA #5;
     |HAZ Elemento;
|FPRC;

|PROCESO Elemento;
     |SI aEle = ""; aEle = #5#4; |FINSI;
     |SI #5#6 ! 0;
          |SI aEleUni = ""; aEleUni = #5#4; |FINSI;
     |FINSI;

     nUni = nUni + #5#6;
     nUniEle = #5#6;

     |SI aEsDesglose = "S";
          |SALVA_FICHA #5;
          #5#1 = #10#86;
          #5#2 = #10#87;
          |LEE 000#5=;
          |SI FSalida = 0;
               nUni = nUni + #5#6;
               nUniEle = nUniEle + #5#6;
          |FINSI;
          |REPON_FICHA #5;
     |FINSI;

     |DDEFECTO #6;
     #6#0 = #65#0;  ||Art
     #6#1 = #65#5;  ||Alm
     #6#2 = #65#1;  ||Fec
     #6#3 = #65#2;  ||Ope
     #6#4 = #65#11; ||Ser
     #6#5 = #65#3;  ||Doc
     #6#6 = #65#4;  ||Lin
     #6#7 = #5#4;   ||Compo
     |LEE 101#6=;
     |SI FSalida ! 0; |GRABA 020#6b; |FINSI;

     #6#8 = #5#5;   ||Des
     #6#9 = #6#9 + (nUniEle * nAbo * nSuma); ||Uni
     #6#10 = #5#7; ||Pre
     |GRABA 020#6a;
     |LIBERA #6;

     |SI aTipo = "T4";
          |DDEFECTO #6;
          #6#0 = #65#0;  ||Art
          #6#1 = nAlma;  ||Alm
          #6#2 = #65#1;  ||Fec
          #6#3 = "MS";   ||Ope
          #6#4 = #65#11; ||Ser
          #6#5 = #65#3;  ||Doc
          #6#6 = #65#4;  ||Lin
          #6#7 = #5#4;   ||Compo
          |LEE 101#6=;
          |SI FSalida ! 0; |GRABA 020#6b; |FINSI;
          #6#8 = #5#5;
          #6#9 = #6#9 + (-#5#6 * nAbo);
          #6#10 = #5#7;
          |GRABA 020#6a;
          |LIBERA #6;
     |FINSI;
|FPRC;

|DEFBUCLE Elemento;
     #5#1;
     ;
     aTipo, #65#11, #65#3, nLin, "      ";
     aTipo, #65#11, #65#3, nLin, "zzzzzz";
     ;
     NULL, Elemento;
|FIN;

|PROCESO Elemento0;
     #2#0 = #65#0;
     |LEE 000#2=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     nLin = #65#4;
     nUni = 0;
     aEle = "";
     aEleUni = "";
     |BUCLE Elemento;

     nDife = nUniDoc - nUni;
     |SI nDife ! 0;
          |SI aEleUni ! ""; aEle = aEleUni; |FINSI;
          |SI aEle = ""; aEle = #0#4; |FINSI;
          |ABRE #5;
          aEsDesglose = "N";
          |HAZ CuadraEleme;
          |CIERRA #5;
     |FINSI;
|FPRC;

|PROCESO Chequea;
     #1#0 = #65#0;
     #1#1 = #65#5;
     |LEE 000#1=;
     |SI FSalida = 0;
          |SI #65#1 < #1#2;
               FSalida = 0; ||Mal
          |SINO;
               FSalida = 1; ||Correcto
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO TiquetLin;
     |DDEFECTO #7;
     #7#26 = #501#57;
     |LEE 000#7=;

     |DDEFECTO #19;
     #19#0 = #502#2;||Articulo;
     |LEE 000#19=;

     #0#1 = "TI"; |PINTA #0#1;
     #0#2 = #501#36;|PINTA #0#2;
     #0#3 = #501#0; |PINTA #0#3;

     nSuma = -1;
     nAbo = 1;
     |DDEFECTO #65;

     nPreTon = 1;
     |HAZ EsVigor;
     |SI FSalida = 0;
          aAlfa = #agifa019#110; |QBF aAlfa;   || Alfanumerico1
          aAlfa = aAlfa > "";
          |SI aAlfa = "S"; nPreTon = 1000; |FINSI;
     |FINSI;

     |ABRE #65;
     |DDEFECTO #65;
     #65#0 = #502#2;
     #65#1 = #501#14;
     #65#2 = "TI";
     #65#3 = #501#58;
     #65#4 = #502#1;
     #65#11 = #501#57;
     #65#5 = #501#32;
     #65#6 = -#502#5;
     ||#65#7 = #19#6;
     #65#8 = #19#9;
     #65#9 = #502#10 / nPreTon;
     #65#10 = #501#1;
     #65#12 = #502#14;
     #65#13 = 0;
     #65#14 = ((((#65#9 < #65#12) < #65#13) < #501#17) < #501#19);
     |SI #142#115 = "S";
          #65#14 = #65#14 < #501#18;
     |FINSI;
     #65#17 = -#502#29;
     #65#18 = #502#30;
     #65#19 = #65#19 + #502#31;

     |HAZ Chequea;
     |SI FSalida ! 0;
          nUniDoc = #502#5;
          aTipo = "TI";
          |HAZ Elemento0;
          |GRABA 020#65n;

          |HAZ Escandallo;
     |FINSI;
|FPRC;

|PROCESO Valora;
     |DDEFECTO #19;
     #19#0 = #57#0;||Articulo;
     |LEE 000#19=;

     #0#1 = "EV"; |PINTA #0#1;
     #0#2 = "";    |PINTA #0#2;
     #0#3 = #57#27; |PINTA #0#3;

     nAbo = 1;
     nSuma = 1;
     |DDEFECTO #65;
     #65#0 = #57#0;  ||Articulo;
     #65#1 = #56#1;  ||Fecha;
     #65#2 = "EV";   ||Operacion;
     #65#3 = #57#27; ||Documento;
     #65#4 = #57#14; ||Linea;
     #65#5 = #57#1;
     #65#6 = #57#4;  ||Unidades Vta.
     #65#17 = #57#21; ||Uni2
     #65#8 = #19#9;  ||Pcm;
     #65#9 = #57#19; ||Pvp;
     #65#10= #57#5;  ||Cliente;
     #65#11= #57#28; ||Serie;
     #65#12= #57#7;  ||Dto1;
     #65#13= #57#20; ||Dto2;
     #65#21= #57#30; ||Dto3
     #65#14= (((((#57#19 < #57#7) < #57#20) < #57#30) < #57#8) < #57#9);
     |SI #142#115 = "S";
          #65#14 = #65#14 < #57#10;
     |FINSI;
     #65#18 = #57#22; ||Parti
     #65#19 = #57#23; ||Merma

     |HAZ Chequea;
     |SI FSalida ! 0;
          nUniDoc = #57#4;
          aTipo = "W1";
          |HAZ Elemento0;
          |GRABA 020#65n;
          |HAZ Escandallo;
     |FINSI;
|FPRC;

|PROCESO Regula;
     |DDEFECTO #19;
     #19#0 = #44#0;||Articulo;
     |LEE 000#19=;

     #0#1 = "ES"; |PINTA #0#1;
     #0#2 = "";|PINTA #0#2;
     #0#3 = #44#18; |PINTA #0#3;

     nSuma = 1;
     |DDEFECTO #65;
     #65#0 = #44#0; ||Articulo;
     #65#1 = #43#1; ||Fecha;
     |SI #44#7 = "E";
          #65#2 = "ES"; ||Operacion;
          nAbo = 1;
     |SINO;
          #65#2 = "SS";
          nAbo = -1;
     |FINSI;
     #65#3 = #44#18; ||Documento;
     #65#4 = #44#8; ||Linea;
     #65#5 = #44#1;
     #65#6 = #44#4 * nAbo;  ||Unidades Vta.
     #65#17 = #44#12 * nAbo; ||Uni2
     #65#8 = #19#9;  ||Pcm;
     #65#9 = 0;      ||Pvp;
     #65#10= "";     ||Cliente;
     #65#11= #44#21; ||Serie;
     #65#12= 0;      ||Dto1;
     #65#13= 0;      ||Dto2;
     #65#21= 0;      ||Dto3;
     #65#14= 0;
     #65#18 = #44#13; ||Parti
     #65#19 = #44#14; ||Merma

     |HAZ Chequea;
     |SI FSalida ! 0;
          nUniDoc = #44#4;
          aTipo = "T3";
          |HAZ Elemento0;
          |GRABA 020#65n;
          |HAZ Escandallo;
     |FINSI;
|FPRC;

|PROCESO Movimi;
     |DDEFECTO #19;
     #19#0 = #55#0;||Articulo;
     |LEE 000#19=;

     #0#1 = "ME"; |PINTA #0#1;
     #0#2 = "";|PINTA #0#2;
     #0#3 = #55#27; |PINTA #0#3;

     nAbo = 1;
     nSuma = 1;
     |DDEFECTO #65;
     #65#0 = #55#0;  ||Articulo;
     #65#1 = #54#1;  ||Fecha;
     #65#2 = "ME";   ||Operacion;
     #65#3 = #55#27; ||Documento;
     #65#4 = #55#11; ||Linea;
     #65#5 = #55#5;
     #65#6 = #55#4;  ||Unidades Vta.
     #65#17 = #55#15; ||Uni2
     #65#8 = #19#9;  ||Pcm;
     #65#9 = 0;      ||Pvp;
     #65#10= 0;      ||Cliente;
     #65#11= #55#28; ||Serie;
     #65#12= 0;      ||Dto1;
     #65#13= 0;      ||Dto2;
     #65#21= 0;      ||Dto3;
     #65#14= 0;
     #65#18 = #55#16; ||Parti
     #65#19 = #55#18; ||Merma

     |HAZ Chequea;
     |SI FSalida ! 0;
          nAlma = #55#1;
          nUniDoc = #55#4;
          aTipo = "T4";
          |HAZ Elemento0;
          |GRABA 020#65n;
          |HAZ Escandallo;
     |SINO;
          |ACABA;
     |FINSI;

     |DDEFECTO #65;
     #65#0 = #55#0;  ||Articulo;
     #65#1 = #54#1;  ||Fecha;
     #65#2 = "MS";   ||Operacion;
     #65#3 = #55#27; ||Documento;
     #65#4 = #55#11; ||Linea;
     #65#5 = #55#1;
     #65#6 = -#55#4; ||Unidades Vta.
     #65#17 = -#55#15; ||Uni2
     #65#8 = #19#9;  ||Pcm;
     #65#9 = 0;      ||Pvp;
     #65#10= 0;      ||Cliente;
     #65#11= #55#28; ||Serie;
     #65#12= 0;      ||Dto1;
     #65#13= 0;      ||Dto2;
     #65#21= 0;      ||Dto3;
     #65#14= 0;
     #65#18 = #55#17; ||Parti
     #65#19 = #55#18; ||Merma
     |GRABA 020#65n;
|FPRC;

|PROCESO AlbVta;
     |SI #10#85 = "X";  || Es un albaran hermano de desglose
          |ACABA;
     |FINSI;
     aEsDesglose = "N";
     nUniDesglose = 0;
     |SI #10#85 = "E";  || Es el principal de desglose
          aAlfa = #71#47;
          aAlfa = aAlfa % 101;
          |SI aAlfa = "U";    || Si el desglose es por unidades leeo el hermando
               |SALVA_FICHA #71;
               #71#29 = #10#86;
               #71#0 = #10#87;
               |LEE 000#71=;
               |SI FSalida = 0;
                    nUniDesglose = #71#5;
                    aEsDesglose = "S";
               |FINSI;
               |REPON_FICHA #71;
          |FINSI;
     |FINSI;

     |DDEFECTO #7;
     #7#26 = #71#29;
     |LEE 000#7=;

     |DDEFECTO #19;
     #19#0 = #71#2;||Articulo;
     |LEE 000#19=;

     #0#1 = "AV"; |PINTA #0#1;
     #0#2 = #71#29;|PINTA #0#2;
     #0#3 = #71#0; |PINTA #0#3;

     nSuma = -1;
     |DDEFECTO #65;
     #65#0 = #71#2; ||Articulo;
     #65#1 = #10#1; ||Fecha;
     |SI #10#43 = "S";
          #65#2 = "BV"; ||Operacion;
          nAbo = -1;
     |SINO;
          #65#2 = "AV"; ||Operacion;
          nAbo = 1;
     |FINSI;
     #65#3 = #71#0; ||Documento;
     #65#4 = #71#1; ||Linea;
     #65#5 = #71#3;

     nUniTotal = #71#5 + nUniDesglose;
     #65#6 = -nUniTotal * nAbo;  ||Unidades Vta.
     #65#17 = -#71#48 * nAbo; ||Uni2
     #65#8 = #19#9;  ||Pcm;
     #65#9 = #71#6;  ||Pvp;
     #65#10= #71#15; ||Cliente;
     #65#11= #71#29;||Serie;
     #65#12= #71#8;  ||Dto1;
     #65#13= #71#33; ||Dto2;
     #65#21= 0;      ||Dto3
     #65#14= ((((#71#6 < #71#8) < #71#33) < #10#5) < #10#32);
     |SI #142#115 = "S";
          #65#14 = #65#14 < #10#7;
     |FINSI;
     #65#18 = #71#49; ||Parti
     #65#19 = #71#50; ||Merma

     |HAZ Chequea;
     |SI FSalida ! 0;
          ||nUniDoc = #71#5;
          nUniDoc = nUniTotal;
          aTipo = "AV";
          |HAZ Elemento0;
          |GRABA 020#65n;
          |HAZ TallerAuxHis;

          |HAZ Escandallo;
     |FINSI;

     |SI #7#37 ! "S"; |ACABA; |FINSI;    || Serie Almacen Interno

     nSuma = 1;
     |DDEFECTO #65;
     #65#0 = #71#2; ||Articulo;
     #65#1 = #10#1; ||Fecha;
     |SI #10#43 = "S";
          #65#2 = "BC"; ||Operacion;
          nAbo = -1;
     |SINO;
          #65#2 = "AC"; ||Operacion;
          nAbo = 1;
     |FINSI;
     #65#3 = #71#0; ||Documento;
     #65#4 = #71#1; ||Linea;
     #65#5 = #7#31; || Almacen Interno
     #65#6 = #71#5 * nAbo;  ||Unidades Vta.
     #65#17 = #71#48 * nAbo; ||Uni2
     #65#8 = #19#9;  ||Pcm;
     #65#9 = #71#6;  ||Pvp;
     #65#10= #71#15; ||Cliente;
     #65#11= #71#29;||Serie;
     #65#12= #71#8;  ||Dto1;
     #65#13= #71#33; ||Dto2;
     #65#21= 0;
     #65#14= ((((#71#6 < #71#8) < #71#33) < #10#5) < #10#32);
     |SI #142#115 = "S";
          #65#14 = #65#14 < #10#7;
     |FINSI;
     #65#18 = #71#49; ||Parti
     #65#19 = #71#50; ||Merma
     |GRABA 020#65n;

     |BUCLE CreaElemeInterno;

     |HAZ TallerAuxHis;

     |HAZ Escandallo;
|FPRC;

|PROCESO Factura;
     |DDEFECTO #19;
     #19#0 = #69#2;||Articulo;
     |LEE 000#19=;

     #0#1 = "FC"; |PINTA #0#1;
     #0#2 = #69#20;|PINTA #0#2;
     #0#3 = #69#0; |PINTA #0#3;

     nSuma = -1;
     nAbo = 1;
     |DDEFECTO #65;
     #65#0 = #69#2; ||Articulo;
     #65#1 = #84#1;  ||Fecha;
     #65#2 = "FC";  ||Operacion;
     #65#3 = #69#0;  ||Documento;
     #65#4 = #69#1; ||Linea;
     #65#5 = #69#3;
     #65#6 = -#69#5;  ||Unidades Vta.
     #65#17 = -#69#30; ||Uni2
     #65#8 = #19#9;   ||Pcm;
     #65#9 = #69#6;  ||Pvp;
     #65#10= #69#15; ||Cliente;
     #65#12= #69#8;  ||Dto1;
     #65#11= #69#20; ||Serie;
     #65#13= #69#21; ||Dto2;
     #65#21 = 0;
     #65#14= ((((#69#6 < #69#8) < #69#21) < #84#5) < #84#32);
     |SI #142#115 = "S";
          #65#14 = #65#14 < #84#7;
     |FINSI;
     #65#18 = #69#31; ||Parti
     #65#19 = #69#32; ||Merma

     |HAZ Chequea;
     |SI FSalida ! 0;
          nUniDoc = #69#5;
          aTipo = "FC";
          |HAZ Elemento0;
          |GRABA 020#65n;
          |HAZ Escandallo;
     |FINSI;
|FPRC;

|PROCESO AlbCom;
     |DDEFECTO #19;
     #19#0 = #80#2;||Articulo;
     |LEE 000#19=;

     #0#1 = "AC";  |PINTA #0#1;
     #0#2 = #80#27;|PINTA #0#2;
     #0#3 = #80#0; |PINTA #0#3;

     nSuma = 1;
     |DDEFECTO #65;
     #65#0 = #80#2; ||Articulo;
     #65#1 = #77#1; ||Fecha;
     |SI #77#42 = "N";
          #65#2 = "AC";  ||Operacion;
          nAbo = 1;
     |SINO;
          #65#2 = "BC";  ||Operacion;
          nAbo = -1;
     |FINSI;
     #65#3 = #80#0;  ||Documento;
     #65#4 = #80#1;  ||Linea;
     #65#5 = #80#3;  ||Alma

     nUni1 = #80#5;
     nUni2 = #80#36;
     |HAZ TipoUni;
     #65#6 = nUni1 * nAbo;  ||Unidades Compra.
     #65#17 = nUni2 * nAbo; ||Uni2

     #65#8 = #19#9;   ||Pcm;
     #65#9 = #80#6;   ||Pc;
     #65#10 = #80#15; ||Proveedor;
     #65#11 = #80#27; ||Serie;
     #65#12 = #80#8;  ||Dto1;
     #65#13 = #80#26; ||Dto2;
     #65#21 = #80#45; ||Dto3
     #65#14 = (((((#80#6 < #80#8) < #80#26) < #80#45) < #77#5) < #77#32);
     |SI #142#114 = "S";
          #65#14 = #65#14 < #77#7;
     |FINSI;
     #65#18 = #80#37; ||Parti
     #65#19 = #80#38; ||Merma

     |HAZ Chequea;
     |SI FSalida ! 0;
          nUniDoc = #80#5;
          aTipo = "AC";
          |HAZ Elemento0;
          |GRABA 020#65n;
     |FINSI;
|FPRC;

|DEFBUCLE TiquetLin;
     #502#1;
     ;
     #501#36, #501#0, 001;
     #501#36, #501#0, 999;
     ;
     NULL, TiquetLin;
|FIN;

|PROCESO Tiquet;
     |BUCLE TiquetLin;
|FPRC;

|DEFBUCLE Tiquet;
     #501#1;
     35, 14;
     "     ", 000001, "T", #0#5;
     "zzzzz", 999999, "T", #0#6;
     ;
     NULL, Tiquet;
|FIN;

|DEFBUCLE AlbCom;
     #77#1;
     1;
     "     ", 000001, #0#5;
     "zzzzz", 999999, #0#6;
     ;
     NULL, NULL, AlbCom;
|FIN;

|DEFBUCLE Factura;
     #84#1;
     1;
     "     ", 000001, #0#5;
     "zzzzz", 999999, #0#6;
     ;
     NULL, NULL, Factura;
|FIN;

|DEFBUCLE AlbVta;
     #10#1;
     1;
     "     ", 000001, #0#5;
     "zzzzz", 999999, #0#6;
     ;
     NULL, NULL, AlbVta;
|FIN;

|DEFBUCLE Valora;
     #56#1;
     1;
     "     ", 000001, #0#5;
     "zzzzz", 999999, #0#6;
     ;
     NULL, NULL, Valora;
|FIN;

|DEFBUCLE Regula;
     #43#1;
     1;
     "     ", 000001, #0#5;
     "zzzzz", 999999, #0#6;
     ;
     NULL, NULL, Regula;
|FIN;

|DEFBUCLE Movimi;
     #54#1;
     1;
     "     ", 000001, #0#5;
     "zzzzz", 999999, #0#6;
     ;
     NULL, NULL, Movimi;
|FIN;

|PROCESO MoviEleBorra;
     |SI #6#3 = "EV"; |O #6#3 = "ME"; |O #6#3 = "MS";
               |O #6#3 = "AV"; |O #6#3 = "BV"; |O #6#3 = "FC";
               |O #6#3 = "AC"; |O #6#3 = "BC";
               |O #6#3 = "SS"; |O #6#3 = "ES";
               |O #6#3 = "TI";
          |BORRA 020#6a;
     |FINSI;
     #2#0 = #6#0;
     |GRABA 000#2n;
|FPRC;

|DEFBUCLE MoviEleBorra;
     #6#1;
     ;
     "                    ", 00000, #0#5, "  ", "     ", 000000, 00000, "      ";
     "zzzzzzzzzzzzzzzzzzzz", 99999, #0#6, "zz", "zzzzz", 999999, 99999, "zzzzzz";
     be;
     NULL, MoviEleBorra;
|FIN;

|PROCESO MoviSA;
     |SI #65#2 = "SA";
          #1#0 = #65#0;
          #1#1 = #65#5;
          #1#2 = #65#1;
          |GRABA 020#1n;
     |FINSI;
     |SI #65#2 = "EV"; |O #65#2 = "ME"; |O #65#2 = "MS";
               |O #65#2 = "AV"; |O #65#2 = "BV"; |O #65#2 = "FC";
               |O #65#2 = "AC"; |O #65#2 = "BC";
               |O #65#2 = "SS"; |O #65#2 = "ES";
               |O #65#2 = "TI";
               |O #65#2 = "F1"; |O #65#2 = "S1";
          |BORRA 020#65a;

          |SI nSwTaller = 0;  || Aux. Histo
               |SI #65#2 = "AV"; |O #65#2 = "BV";
                    #con00009@#0 = #65#0;
                    #con00009@#1 = #65#1;
                    #con00009@#2 = #65#2;
                    #con00009@#3 = #65#3;
                    #con00009@#4 = #65#4;
                    #con00009@#5 = #65#11;
                    |LEE 101#con00009@.=;
                    |SI FSalida = 0;
                         |SI #con00009@#12 = "S";  || Si esta hecho por modulo
                              #conw0002@#0 = #65#11;
                              #conw0002@#1 = #65#3;
                              #conw0002@#2 = #65#4;
                              |GRABA 020#conw0002@.n;
                         |FINSI;
                         |BORRA 020#con00009@.a;
                         |LIBERA #con00009@;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI nSwTaller = 0; |Y #65#2 = "OR";
          |BORRA 020#65a;
     |FINSI;
|FPRC;

|DEFBUCLE MoviSA;
     #65#1;
     ;
     "                    ", #0#5, "  ", 000000, 00000, "     ";
     "zzzzzzzzzzzzzzzzzzzz", #0#6, "zz", 999999, 99999, "zzzzz";
     be;
     NULL, MoviSA;
|FIN;

|PROCESO BorraSA;
     |SI #65#2 = "SA";
          |BORRA 020#65a;
     |FINSI;
     |LIBERA #65;
|FPRC;

|DEFBUCLE BorraSA;
     #65#1;
     ;
     "                    ", #0#5, "  ", 000000, 00000, "     ";
     "zzzzzzzzzzzzzzzzzzzz", #0#6, "zz", 999999, 99999, "zzzzz";
     be;
     NULL, BorraSA;
|FIN;

|PROCESO dsw00087;
     |DDEFECTO #65;
     #65#0 = #87#2;
     #65#1 = #87#15;
     #65#2 = "SA";
     #65#3 = #87#0;
     #65#4 = #87#1;
     #65#11 = #87#13;
     |LEE 101#65=;
     |SI FSalida ! 0; |GRABA 020#65b; |FINSI;

     #65#5 = #87#3;  || Almacen
     #65#6 = #87#4;  || Stock
     #65#7 = #87#4;  || Stock Resultante
     #65#8 = #87#5;  || Precio Medio Coste
     #65#9 = #65#8;
     #65#17 = #87#7;  || Uni2
     #65#18 = #87#8;  || Partida
     #65#19 = #87#9;  || Merma
     |GRABA 020#65a;
     |LIBERA #65;
|FPRC;

|DEFBUCLE dsw00087;
     #87#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsw00087;
|FIN;

|PROCESO agist002;
     |SELECT #2#87;
     #87#2 = #201#2;
     #87#3 = #201#3;
     |LEE 101#87=;
     |SI FSalida = 0; |Y #87#15 < #200#1;
          |BORRA 020#87a;
     |FINSI;
     |LIBERA #87;

     |SELECT #1#87;
     |PARA i = 0; |SI i [ 14; |HACIENDO i = i + 1;
          #87i = #201i;
     |SIGUE;
     #87#15 = #200#1;
     |GRABA 020#87n;
|FPRC;

|DEFBUCLE agist001;
     #200#1;
     4, 1;
     "     ", 000001, "S", #0#5;
     "zzzzz", 999999, "S", #0#6;
     ;
     NULL, NULL, agist002;
|FIN;

|PROCESO CreaSA;
     |ABRE #87;          || carga el temporal con los ultimos
     |BUCLE agist001;    || registros actualziados
     |CIERRA #87;

     |ABRE #65;
     |BUCLE dsw00087;    || crea historico SA
     |CIERRA #65;
|FPRC;

|PROCESO inicio;|TIPO 3;
     |SI #0#0 = "SI";
          |SI JUAN = 1; |HAZ CopiaHisto; |FINSI;

          aAlfa = Usuario; aAlfa = "1" + aAlfa;
          |NOME_DAT #1 aAlfa; |DELINDEX #1;
          aAlfa = Usuario; aAlfa = "2" + aAlfa;
          |NOME_DAT #2 aAlfa; |DELINDEX #2;
          aAlfa = Usuario; aAlfa = "3" + aAlfa;
          |NOME_DAT #87 aAlfa; |DELINDEX #87;

          |MENSA "0000Borrando SA...";
          |BUCLE BorraSA;
          |MENSA "0000Creando SA...";
          |HAZ CreaSA;

          |MENSA "0000Borrando...";
          |ABRE #1;
          |ABRE #2;
          |BUCLE MoviSA; ||Busca Movimientos SA y BORRA los otros
          |BUCLE MoviEleBorra;
          |MENSA "0000Procesando...";
          |ABRE #65;
          |ABRE #6;
          |ABRE #19;
          |ABRE #480;
          |ABRE #7;

          |BUCLE AlbVta;
          |BUCLE AlbCom;
          |BUCLE Factura;
          |BUCLE Valora;
          |BUCLE Regula;
          |BUCLE Movimi;
          |BUCLE Tiquet;
          |BUCLE Procesado;

          |CIERRA #7;
          |CIERRA #480;
          |CIERRA #19;
          |CIERRA #6;
          |CIERRA #65;
          |CIERRA #1;
          |CIERRA #2;

          |SI nSwTaller = 0;
               |HAZ Taller;
          |FINSI;

          |DELINDEX #1;
          |DELINDEX #2;
          |DELINDEX #87;

          |SI JUAN = 1; |HAZ CheqHisto; |FINSI;
     |FINSI;
|FPRC;

|PROGRAMA;
     |HAZ EsTaller; nSwTaller = FSalida;

     |CLS;
     |ABRE #100; |LEE 000#100p; |CIERRA #100;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |PINPA #0#0;
     |SI #100#19 ! "S";
          |PINTA 2209, "                                   ";
          |C_V #0#4, 1, "N";
     |FINSI;

     |SI nSwTaller = 0;
          |ATRI I; |PINTA 850, "- Ordenes Reparacion (OR)"; |ATRI 0;
          |DDEF aPath;
          aAlfa = aPath + "con00009"; |CARGA_DEF aAlfa, con00009@;
          aAlfa = aPath + "con00004"; |CARGA_DEF aAlfa, con00004@;
          aAlfa = aPath + "con00612"; |CARGA_DEF aAlfa, con00612@;
          aAlfa = aPath + "con00625"; |CARGA_DEF aAlfa, con00625@;
          aAlfa = aPath + "conw0002"; |CARGA_DEF aAlfa, conw0002@;
          |HAZ CreaTempo; |NOME_DAT #conw0002@#Tempo#; aTmpTaller = Tempo;
          |DELINDEX #conw0002@;
          |ABRE #con00009@;
          |ABRE #con00004@;
          |ABRE #con00612@;
          |ABRE #con00625@;
          |ABRE #conw0002@;
     |FINSI;

     |PINDA #0#0;
     |ENDATOS #1#0;

     |SI nSwTaller = 0;
          |CIERRA #conw0002@;
          |CIERRA #con00625@;
          |CIERRA #con00612@;
          |CIERRA #con00004@;
          |CIERRA #con00009@;
          Tempo = aTmpTaller; |HAZ BoraTempo; |DELINDEX #conw0002@;
          |DESCARGA_DEF #conw0002@;
          |DESCARGA_DEF #con00625@;
          |DESCARGA_DEF #con00612@;
          |DESCARGA_DEF #con00004@;
          |DESCARGA_DEF #con00009@;
     |FINSI;
|FPRO;
