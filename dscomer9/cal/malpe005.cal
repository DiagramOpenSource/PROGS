|FICHEROS;
     malpe005 #0;   || Este (L)
     malpe004 #1;   ||      (C)
     agifa019 #2;   || Articulos
     agifa129 #3;   || Tipo Comision
     agifa128 #4;   || Comision Tipo Cliente
     agifa039 #5;   || descuentos
     agifa024 #6;   || Clientes
     agifa025 #9;   || Representantes
     agifa023 #10;  || Precio Cliente / Articulo
     malpe087 #11;  || Pedidos (C)
     malpe088 #12;  ||         (L)
     agifa017 #17;
     malpe104 #21;  || Fecha de Servicios
     malpt001 #20,MANTE;  || Tmp
     malpt002 #22,MANTE;  || Tmp Servicios
     malpt004 #23;  || Pantalla Aviso Peso Max.
     agifa029 #29;
     dsm00024 #50; || Stock por lotes
     agifa007 #60; || series para ver tipo de iva
     malpe085 #85,MANTE;
     malpe081 #81;
     malpe089 #89;
     malpe001 #100;
     agifa142 #142;
|FIN;

|VARIABLES;
     nLin = 0;
     nUni = 0;
     axLote = "";
     axLoteRese = "";
     nPorCien = 0;
     aClave = "";
     nSupera = 0;
     aAlfa = "";
     nConta = 0;
     nError = 0;
     nImpo = 0;
     nTota = 0;
     &aDivisa = "";
     &aMoneda = "";
     &EURODB = 0;
     lote_reservado = "";
     lote = "";
     articulo = "";
     comi1    = 0;
     comi2    = 0;
     comi3    = 0;
     descu    = 0;
     tf       = 0;
     pc       = 0;
     menor    = 0;
     pcr      = 0;
     &n_pre   = 0;
     &n_dec   = 0;

     fichero = "";
     LinIni  = 0;
     pend    = 0;
     nModo   = 0;
     nForma   = 0;
     &acepta = 0;
     uni     = 0;
     impo    = 0;
|FIN;

|PROCESO arti; |TIPO 0;
     |ABRE #2;
     #2#0 = #0#2;    || Articulo
     |LEE 020#2=;
     |SI FSalida ! 0; |DDEFECTO #2; |FINSI;
     |CIERRA #2;

     |ABRE #50;
     #50#0 = #0#2;
     #50#1 = #0#3;
     #50#2 = #0#31;
     |LEE 020#50=;
     |SI FSalida ! 0 ; |DDEFECTO #50; |FINSI;
     |CIERRA #50;

     |ABRE #85;
     #85#0 = #0#2;
     #85#1 = #0#3;
     #85#2 = #0#31;
     |LEE 020#85=;
     |SI FSalida ! 0 ; |DDEFECTO #85; |FINSI;
     |CIERRA #85;
|FPRC;

|PROCESO unidades; |TIPO 0;
     |HAZ arti;
     #0#5 = #0#5 ! n_dec;
     #0#30 = #0#5 / #85#4;    || Palet
     |PINTA #0#5;
     |PINTA #0#30;
|FPRC;

|PROCESO palet; |TIPO 0;
     |HAZ arti;
     #0#5 = #0#30 * #85#4;    || Unidades
     |HAZ unidades;
|FPRC;

|PROCESO total; |TIPO 0;
     #0#7 = #0#5 * #0#6;
     #0#9 = #0#7 < #0#8;
     #0#9 = #0#9 < #0#29;
     #0#9 = #0#9 < #0#23;  || Dto
     #0#9 = #0#9 < #0#25; || Acumu
     #0#9 = #0#9 < #0#24;  || P.P.
     #0#9 = #0#9 ! EURODB;
     |PINTA #0#7;
|FPRC;

|PROCESO Stock;
     axLote = #21#10;
     axLoteRese = #21#12;
     |HAZ actlote;
     |HAZ ActArtiAlma;
|FPRC;

|PROCESO tipo2; |TIPO 2;
     nForma = 0 +. 1;
     nModo = (FEntrada / 100) ! 0;

     |HAZ arti;

     ||#0#37 = #0#30;

     |SI nForma = 1;
          nError = 0;
          |HAZ Porcentaje;
          |SI nError ! 0; |ERROR; |ACABA; |FINSI;
     |FINSI;
     |SI nModo = 3;
          |SI #0#36 = "S";
               |MENAV "0000Linea Confirmada...";
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     #1#18 = #1#18 +. ((#0#5 * #85#3) ! EURODB); || Peso actual
     #1#14 = #1#14 +. #0#9;
     |PINTA #1#18;

     |SI #1#18 > #1#13; |Y nForma = 1;
          |HAZ Aviso;
     |FINSI;
     |ABRE #21;
     |ABRE #12;
     |ABRE #11;
     |HAZ Lee;
     |SI FSalida ! 0; |Y nModo = 1;
          |MENAV "0000No encuento linea inicio servicio...";
          |ERROR;
     |SINO;
          |SI nForma = -1;          ||Modi/Baja
               |SI #0#5 > #21#7;
                    uni = #0#5 - #21#7;
                    nUni = #21#7; |HAZ Stock;
                    #21#7 = 0;
                    |SI #21#5=#21#7;#21#6="S";|SINO;#21#6="N";|FINSI;
                    |GRABA 021#21a;
                    |LIBERA #21;
                    |LEE 101#21>;
                    |PARA; |SI FSalida = 0; |Y #21#0 = #0#32;
                         |Y #21#1 = #0#33; |Y #21#2 = #0#34; |Y uni > 0;
                         |HACIENDO;
                         |SI uni ] #21#7;
                              nUni = #21#7; |HAZ Stock;
                              uni = uni - #21#7;
                              #21#7 = 0;
                         |SINO;
                              nUni = uni; |HAZ Stock;
                              #21#7 = #21#7 - uni;
                              uni = 0;
                         |FINSI;
                         |SI #21#5=#21#7;#21#6="S";|SINO;#21#6="N";|FINSI;
                         |GRABA 021#21a;
                         |LIBERA #21;
                         |LEE 101#21>;
                    |SIGUE;
               |SINO;
                    nUni = #0#5; |HAZ Stock;
                    #21#7 = #21#7 - #0#5;    || Servidas
                    |SI #21#5=#21#7;#21#6="S";|SINO;#21#6="N";|FINSI;
                    |GRABA 021#21a;
               |FINSI;
          |SINO;
               pend = #21#5 - #21#7;
               |SI #0#5 > pend;
                    uni = #0#5 - pend;
                    nUni = pend; |HAZ Stock;
                    #21#7 = #21#7 + pend;
                    |SI #21#5=#21#7;#21#6="S";|SINO;#21#6="N";|FINSI;
                    |GRABA 021#21a;
                    |LIBERA #21;
                    |LEE 101#21>;
                    |PARA; |SI FSalida = 0; |Y #21#0 = #0#32;
                         |Y #21#1 = #0#33; |Y #21#2 = #0#34; |Y uni > 0;
                         |HACIENDO;
                         pend = #21#5 - #21#7;
                         |SI uni ] pend;
                              nUni = pend; |HAZ Stock;
                              uni = uni - pend;
                              #21#7 = #21#5;
                         |SINO;
                              nUni = uni; |HAZ Stock;
                              #21#7 = #21#7 + uni;
                              uni = 0;
                         |FINSI;
                         |SI #21#5=#21#7;#21#6="S";|SINO;#21#6="N";|FINSI;
                         |GRABA 021#21a;
                         |LIBERA #21;
                         |LEE 101#21>;
                    |SIGUE;
               |SINO;
                    nUni = #0#5; |HAZ Stock;
                    #21#7 = #21#7 + #0#5;    || Servidas
                    |SI #21#5=#21#7;#21#6="S";|SINO;#21#6="N";|FINSI;
                    |GRABA 021#21a;
               |FINSI;
          |FINSI;
          |HAZ ActPedido;
     |FINSI;
     #malpe004#20 = #11#15;
     |CIERRA #21;
     |CIERRA #11;
     |CIERRA #12;
|FPRC;

|PROCESO actlote;
     |ABRE #85;
     |ABRE #50;

     #50#0 = #0#2;
     #50#1 = #0#3;
     #50#2 = axLote;
     |LEE 101#50=;
     |SI FSalida = 0;
          |DDEFECTO #85;
          #85#0 = #50#0;
          #85#1 = #50#1;
          #85#2 = #50#2;
          |LEE 101#85=;
          |SI FSalida ! 0; |GRABA 020#85b; |FINSI;
          aAlfa = axLoteRese; |QBF aAlfa;
          |SI aAlfa ! "";
               #85#9 = #85#9 - (nUni * nForma);
               #50#31 = #50#31 + (nUni * nForma);
          |FINSI;
          #50#16 = #50#16 - (nUni * nForma);

          #50#31 = #50#22 - #85#9; ||| parche Dispo
          |GRABA 021#85a;
          |LIBERA #85;
          |GRABA 021#50a;
     |FINSI;
     |CIERRA #50;
     |CIERRA #85;
|FPRC;

|PROCESO ActArtiAlma;
     |ABRE #17;
     |ABRE #2;
     #2#0 = #0#2;
     |LEE 101#2=;
     |SI FSalida = 0;
          #17#0 = #0#2;
          #17#1 = #0#3;
          |LEE 101#17=;
          |SI FSalida = 0;
               aAlfa = axLoteRese; |QBF aAlfa;
               |SI aAlfa ! "";
                    #2#12 = #2#12 - (nUni * nForma);
                    #2#104 = #2#104 + (nUni * nForma);
                    #17#8 = #17#8 - (nUni * nForma);
                    #17#39 = #17#39 + (nUni * nForma);
               |FINSI;
               #2#15 = #2#15 - (nUni * nForma);
               #17#42 = #17#42 - (nUni * nForma);

               #17#39 = #17#5 - #17#8; ||| parche Dispo

               |HAZ ValoraStock;
               |GRABA 021#2a;
               |GRABA 021#17a;
          |FINSI;
     |FINSI;
     |CIERRA #2;
     |CIERRA #17;
|FPRC;

|PROCESO CreaLinServi;
     #21#0 = #12#28;
     #21#1 = #12#0;
     #21#2 = #12#1;
     #21#3 = 999;
     |LEE 000#21];
     |SI FSalida = 0;
          |LEE 000#21a;
     |SINO;
          |LEE 000#21u;
     |FINSI;
     |SI FSalida = 0; |Y #21#0 = #12#28; |Y #21#1 = #12#0; |Y #21#2 = #12#1;
          nLin = #21#3 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
     |DDEFECTO #21;
     #21#0 = #12#28;
     #21#1 = #12#0;
     #21#2 = #12#1;
     #21#3 = nLin;
     #21#4 = #12#64;
     #21#5 = uni;
     #21#6 = "S";
     #21#7 = uni;
     #21#8 = #0#2;
     #21#9 = #0#3;
     #21#10 = #0#31;
     #21#11 = "N";
     #21#12 = #0#38;
     |GRABA 020#21n;
|FPRC;

|PROCESO ActPedido;
     uni = #0#5;
     #12#43 = #12#43 + (uni * nForma);
     #12#64 = #1#2;

     |SI nForma = 1;
          uni = #12#5 - #12#43;
           |SI uni < 0;             ||Si se adj. mas de las pedidas
               uni = -uni;
               #12#5 = #12#5 + uni; ||se ajusta el pedido
               #12#42 = #12#42 + uni;
               |HAZ CreaLinServi;   ||crea linea servicio
          |FINSI;
     |FINSI;

     |GRABA 020#12a;

     aDivisa = #11#35;
     aMoneda = #11#37;
     |HAZ Divisas104;
     |HAZ CalCabMalpe087;
     #11#24 = #11#24 + nForma;
     |GRABA 020#11a;
|FPRC;

|PROCESO Lee;
     #21#0  = #0#32; #21#1 = #0#33; #21#2 = #0#34; #21#3 = #0#35;
     #12#28 = #0#32; #12#0 = #0#33; #12#1 = #0#34;
     #11#25 = #0#32; #11#0 = #0#33;
     |LEE 101#21=;
     |SI FSalida = 0;
          |LEE 101#11=;
          |SI FSalida = 0;
               |LEE 101#12=;
               |SI FSalida = 0;
                    aDivisa = #11#35
                    aMoneda = #11#37;
                    |HAZ Divisas104;
                    FSalida = 0;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO TmpServi;
     |SI #22#12 = "*";
          |SI LinIni = 0;
               #0#32  = #22#0;     || Serie
               #0#33  = #22#1;     || Pedido
               #0#34  = #22#2;     || Linea
               #0#35  = #22#3;     || Linea Servicio Inicial
               LinIni = #22#3;
               #0#5   = 0;
          |FINSI;
          #0#5 = #0#5 + (#22#5 - #22#7);     || Unidades

          |SI lote = "";
               lote = #22#10;
          |FINSI;

          |SI lote_reservado = "";
               lote_reservado = #22#14;
          |FINSI;
          |SI lote_reservado ! #22#14;
               lote_reservado = "ERROR";
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE TmpServi;
     #22#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, TmpServi;
|FIN;

|PROCESO LinPed;                   || Graba Temporal
     #20#0 = #11#25; || Serie
     #20#1 = #11#0;  || Pedido
     #20#2 = #12#1;  || Linea
     #20#3 = #11#4;  || Cliente
     #20#4 = #11#29; || Obra
     #20#5 = #12#2;  || Articulo
     #20#6 = #12#57;  || Palet
     #20#7 = #12#5;  || Unidades
||     #20#8 = #12#42 - #12#43;
     #20#8 = #12#5 - #12#43;
     #20#9 = #12#4;
     |GRABA 021#20n;
|FPRC;

|DEFBUCLE Pedido;
     #11#2;
     63;
     #1#3, "     ", 000001, #1#4;
     #1#3, "zzzzz", 999999, #1#4;
     ;
     NULL, NULL, LinPed;
|FIN;

|PROCESO inf;
     #20#0 = "     ";
     #20#1 = 1;
     #20#2 = 001;
|FPRC;

|PROCESO sup;
     #20#0 = "zzzzz";
     #20#1 = 999999;
     #20#2 = 999;
|FPRC;

|PROCESO hay_stock;
|FPRC;

|PROCESO tecla_f1; |TIPO 0;
     |SI FSalida = 1; |PTEC 807; |ERROR; |FINSI;
     |SI FSalida ! 9; |ACABA; |FINSI;

     fichero = Usuario;
     |NOME_DAT #20 fichero;
     |DELINDEX #20;
     |ABRE #20;
     |BUCLE Pedido;
     |CIERRA #20;
     |PUSHV 0501 2380;
     |ENTLINEAL #1#20, 1, 4, 20, 1, inf, sup;
     |POPV;
     |DELINDEX #20;

     |SI acepta = 1;
          fichero = "1" + Usuario;
          |NOME_DAT #22 fichero;
          LinIni = 0;
          lote_reservado = "";
          lote = "";
          |BUCLE TmpServi;
          |DELINDEX #22;
          |ABRE #21;
          |ABRE #11;
          |ABRE #12;
          |HAZ Lee;
          |CIERRA #21;
          |CIERRA #11;
          |CIERRA #12;
          |HAZ DefectoPedi;
          |SI lote_reservado = "ERROR";
               |MENAV "0000No se pueden agrupar lotes reservados y no reservados...";
               |ERROR;
          |SINO;
               |ABRE #50;
               #50#0 = #0#2;
               #50#1 = #0#3;
               #50#2 = #0#31;
               |LEE 000#50=;
               |SI FSalida ! 0 ; |DDEFECTO #50; |FINSI;
               |CIERRA #50;

               |ABRE #85;
               #85#0 = #0#2;
               #85#1 = #0#3;
               #85#2 = #0#31;
               |LEE 000#85=;
               |SI FSalida ! 0 ; |DDEFECTO #85; |FINSI;
               |CIERRA #85;

               |HAZ unidades;
               |HAZ hay_stock;
               |HAZ Palets;
               |PTEC 815;      || Av-Pag.
          |FINSI;
     |SINO;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Palets;
     |ABRE #29;
     #29#0 = #0#3;
     |LEE 000#29=;
     |CIERRA #29;
     |SI #29#6 = 1;
          #0#37 = 0;
          #0#39 = 0;
     |SINO;
          #0#37 = #0#30;
          #0#39 = 9999;
     |FINSI;
|FPRC;

|PROCESO Carretilla; |TIPO 0;
     |SI #0#39 = 9999;
          #0#37 = #0#30;
          #0#39 = 9999;
     |FINSI;
|FPRC;

|PROCESO Aviso;
     |PUSHV 0501 2380;
     #23#0 = #1#13;                    || Peso Max
     #23#1 = (#1#18 - #1#13) / #2#102; || Uni
     #23#1 = #23#1 ! n_dec;
     #23#2 = #23#1 / #85#4;             || Palet
     |BLANCO 1019 1661;
     |PINPA #0#23;
     |PINDA #0#23;
     |AVISO;
     |PAUSA;
     |POPV;
|FPRC;

|PROCESO PideClave;
     |PUSHV 2401 2480;
     |ATRI S;
     |PINTA 2425, " Introduzca Clave:             ";
     |ATRI 0;
     E_sup = 10;
     E_inf = "";
     aClave = "";
     aClave = 2445 ? -1;
     |SI FSalida ! 0; aClave = ""; |FINSI;
     |POPV;
|FPRC;

|PROCESO Porcentaje;
     |ABRE #81; |LEE 000#81p; |CIERRA #81;

     |ABRE #11;
     #11#25 = #0#32;
     #11#0 = #0#33;
     |LEE 020#11=;
     |CIERRA #11;

     |ABRE #100;
     #100#0 = #1#3;
     #100#1 = #1#4;
     |LEE 020#100=;
     |CIERRA #100;
     |SI #11#68 = "S"; |Y #11#69 ! "99";
          nSupera = 0;
          nImpo = #11#47 + #0#7;
          nTota = #11#45 * #100#30 / 100;
          |SI nImpo ] nTota;
               nSupera = 2;
               nPorCien = #100#30;
               aAlfa = "0000Superado el " + #100#30 + "% del pedido";
               |MENAV aAlfa;
               |MENSA "0000Introduzca 'SALIR', para cancelar...";
               |PARA aClave = ""; |SI aClave ! #81#2; |Y aClave ! #81#3; |HACIENDO;
                    |HAZ PideClave;
                    aAlfa = aClave > ""; |QBT aAlfa;
                    |SI aAlfa = "SALIR"; |SAL; |FINSI;
                    |SI aClave ! #81#2; |Y aClave ! #81#3; |MENAV "0000Clave incorrecta..."; |FINSI;
               |SIGUE;
               |SI aClave ! #81#2; |Y aClave ! #81#3; nError = 1; |FINSI;
          |SINO;
               nTota = #11#45 * #100#29 / 100;
               |SI nImpo ] nTota;
                    nSupera = 1;
                    nPorCien = #100#29;
                    aAlfa = "0000Superado el " + #100#29 + "% del pedido";
                    |MENAV aAlfa;
                    |MENSA "0000Introduzca 'SALIR', para cancelar...";
                    |PARA aClave = ""; |SI aClave ! #81#2; |HACIENDO;
                         |HAZ PideClave;
                         aAlfa = aClave > ""; |QBT aAlfa;
                         |SI aAlfa = "SALIR"; |SAL; |FINSI;
                         |SI aClave ! #81#2; |MENAV "0000Clave incorrecta..."; |FINSI;
                    |SIGUE;
                    |SI aClave ! #81#2; nError = 1; |FINSI;
               |FINSI;
          |FINSI;
          |SI nError = 0; |Y nSupera ! 0;
               |ABRE #89;
               |LEE 000#89u;
               |SI FSalida ! 0;
                    nConta = 1;
               |SINO;
                    nConta = #89#0 + 1;
               |FINSI;
               #89#0 = nConta;
               #89#1 = #0#28;
               #89#2 = #0#0;
               #89#3 = ~;
               |HORA aAlfa;
               #89#4 = aAlfa;
               #89#5 = nSupera;
               aAlfa = Usuario % 810;
               #89#6 = aAlfa;
               #89#7 = aClave;
               #89#8 = nPorCien;
               |SI aClave = #81#2;
                    #89#9 = 1;
               |SINO;
                    #89#9 = 2;
               |FINSI;
               |GRABA 020#89n;
               |CIERRA #89;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CompruLote; |TIPO 0;
     aAlfa = #0#38;
     |QBF aAlfa;
     |SI aAlfa ! ""; |Y #0#38 ! #0#31;
          |MENAV "0000El lote no puede ser distinto al reservado...";
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO DefectoPedi;
     #0#2 = #12#2; |PINTA #0#2;
     #0#3 = #12#3; |PINTA #0#3;
     #0#4 = #12#4; |PINTA #0#4;
     #0#6 = #12#6; |PINTA #0#6;
     #0#8 = #12#8; |PINTA #0#8;
     #0#10 = #12#10; |PINTA #0#10;
     #0#14 = #12#14;
     #0#16 = #12#16;
     #0#17 = #12#17;
     #0#18 = #12#18;
     #0#19 = #12#19;
     #0#20 = #12#20;
     #0#22 = #12#22;
     #0#23 = #12#23;
     #0#24 = #12#24;
     #0#25 = #12#25;
     #0#26 = #12#26;
     #0#27 = #12#27;
     #0#29 = #12#29;
     #0#31 = lote;
     #0#38 = lote_reservado;
|FPRC;

|PROCESO DefectoCarga; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;

     |SI nModo ! 1; |O acepta = 1; acepta = 0;|ACABA; |FINSI;
     acepta = 0;
     |ABRE #12;
     #12#28 = #0#32;
     #12#0 = #0#33;
     #12#1 = #0#34;
     |LEE 020#12=;
     |SI FSalida ! 0;
          |ERROR;
     |SINO;
          |ABRE #11;
          #11#25 = #12#28;
          #11#0 = #12#0;
          |LEE 020#11=;
          |SI FSalida ! 0;
               |ERROR;
          |SINO;
               aDivisa = #11#35
               aMoneda = #11#37;
               |HAZ Divisas104;
               |HAZ DefectoPedi;
          |FINSI;
     |FINSI;
     |CIERRA #12;
|FPRC;

|PROCESO TipoLin7; |TIPO 7;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     n_dec = #142#8;
|FPRC;
