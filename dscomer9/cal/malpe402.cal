|FICHEROS;
     malpe402 #0;
     malpe401 #1; ||Ciclos Lineas
     malpe104 #2; || Lineas de Servicios
     agifa017 #3; || Stock por Almacen
     malpt017 #4; || tmp de stock disponible
     malpe403 #5; || ciclos
     malpe087 #10; ||* pedidos para ver si estan aparcados
     dsm00024 #50; ||* stock por lotes
     malpe085 #85;
     malpe084 #84;
|FIN;

|VARIABLES;
aTmp4 = "";
queda = 0;
stock_total = 0;
|FIN;

|PROCESO crea_tm4;
     |DDEFECTO #85;
     #85#0 = #50#0;
     #85#1 = #50#1;
     #85#2 = #50#1;
     |LEE 000#85=;
     |SI #85#5 ] #0#4; |Y #85#5 [ #0#5;
          stock_total = stock_total + #50#22;
     |FINSI;
|FPRC;

|DEFBUCLE crea_tmp4;
     #50#1;
     ;
     #2#8 , #2#9 , "               ";
     #2#8 , #2#9 , "zzzzzzzzzzzzzzz";
     ;
     NULL , crea_tm4;
|FIN;

|PROCESO lee_ser;
     ||\\ busco en el pedido que no este aparcado
     #10#25 = #2#0;
     #10#0  = #2#1;
     |LEE 001#10=;
     |SI FSalida ! 0 ; |DDEFECTO #10; |FINSI;
     |SI #10#72 ! "S";
          ||\\ busco en el temporal de stocks disponibles
          #4#0 = #2#8;
          #4#1 = #2#9;
          |LEE 001#4=;
          |SI FSalida ! 0; || no existe temporal. Lo creo
               ||\\ CREARLO CON UN BUCLE DE STOCK POR LOTES DESDE HASTA CALIDAD
               stock_total = 0;
               |ABRE #85;
               |BUCLE crea_tmp4;
               |CIERRA #85;

               |DDEFECTO #4;
               #4#0 = #2#8;
               #4#1 = #2#9;
               #4#2 = stock_total;
               |GRABA 001#4c;
          |FINSI;
          |LIBERA #4;
          ||\\ busco el temporal de ciclos
          #5#0 = #2#8;
          #5#1 = #2#9;
          #5#2 = #1#1;
          |LEE 001#5=;
          |SI FSalida ! 0;
               |DDEFECTO #5;
               #5#0 = #2#8;
               #5#1 = #2#9;
               #5#2 = #1#1;
               #3#0 = #2#8;
               #3#1 = #2#9;
               |LEE 001#3=;
               |SI FSalida ! 0 ; |DDEFECTO #3; |FINSI;

               |DDEFECTO #84;
               #84#0 = #3#0;
               #84#1 = #3#1;
               |LEE 000#84=;

               #5#4 = #4#2;
               #5#6 = #84#2;  ||| #3#42;
               |GRABA 001#5c;
               |LIBERA #3;
          |FINSI;
          |LIBERA #5;
          #5#3 = #5#3 + (#2#5 - #2#7);
          #5#5 = #5#3 - #5#4;
          |SI #5#5 < 0; #5#5 = 0; |FINSI;
          #5#7 = #5#5 / #5#6;
          queda = #4#2 - (#2#5 - #2#7);
          |SI queda  [ 0;
               queda = 0;
          |FINSI;
          #4#2 = queda;
          |GRABA 001#4a;
          |GRABA 001#5a;
          |LIBERA #4;
          |LIBERA #5;
     |FINSI; || de pedido aparcado
     |LIBERA #10;
|FPRC;

|DEFBUCLE lee_servi;
     #2#3;
     ;
     "                    " , #1#0 , "               " , #1#2 , "N";
     "zzzzzzzzzzzzzzzzzzzz" , #1#0 , "zzzzzzzzzzzzzzz" , #1#3 , "N";
     ;
     NULL , lee_ser;
|FIN;


|PROCESO lee_lin;
     |BUCLE lee_servi;
|FPRC;

|DEFBUCLE lee_lin_ciclo;
     #1#1;
     ;
     #0#0 ,#0#2;
     #0#1, #0#3;
     ;
     NULL , lee_lin;
|FIN;

|PROCESO tipo3; |TIPO 3;
     |DELINDEX #5;

     aTmp4 = "0" + Usuario;
     |NOME_DAT #4 aTmp4; |DELINDEX #4;|ABRE #4;
     |ABRE #5;
     |ABRE #3;
     |ABRE #10;
     |ABRE #85;
     |ABRE #84;
     |BUCLE lee_lin_ciclo;
     |CIERRA #84;
     |CIERRA #85;
     |CIERRA #10;
     |CIERRA #3;
     |CIERRA #4;
     |CIERRA #5;
     |DELINDEX #4;
|FPRC;
