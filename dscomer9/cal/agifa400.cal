|FICHEROS;
agifa400 #0;
tmprpmc #1;
agifa065 #2;
agifa019 #3;
agifa142 #42;
|FIN;

|VARIABLES;
     &Tempo = "";
     aTmp1 = "";
     importe = 0;
     n_pre = 0;
|FIN;

|CALCULO genera;
#2#14 = ((#2#9 < #2#12) < #2#13) < #2#21;   ||Calculo Ult.Precio Compra Con Dto

|SI #2#2 = "EV";|O #2#2 = "AC";|O #2#2 = "BC";|O #2#2 = "FB";
  |SI #2#9 ! 0;
    #1#0 = #2#0;
    |LEE 000#1=;
    |SI FSalida ! 0;
      |GRABA 000#1c;
      |LIBERA #1;
    |FINSI;
    #1#1 = #1#1 + #2#6;
    importe = #2#6 * #2#14;
    #1#2 = #1#2 + importe;
    |GRABA 000#1a;
    |LIBERA #1;
    #1#0 = "";
    #1#1 = 0;
    #1#2 = 0;
    importe = 0;
  |FINSI;
|FINSI;
||GRABA 121#2a;     modificado para inforpor
|BORRA 020#2a;
|GRABA 020#2n;
|LIBERA #2;
|FCAL;

|DEFBUCLE lee_histo;
#2#1;
;
"                    " , "01.01.0001" , "  " ,       0 , 00000 , "     ";
"zzzzzzzzzzzzzzzzzzzz" , #0#1         , "zz" ,  999999 , 99999 , "zzzzz";
be;
NULL,genera;
|FIN;

|CALCULO grabar;
|ABRE #3;
#3#0 = #1#0;
|LEE 000#3=;
|SI FSalida = 0;
  #3#9 = #1#2 / #1#1;
  #3#9 = #3#9 ! n_pre;
  |SI #3#6 ] 0;
    #3#10 = #3#9 * #3#6;
  |SINO;
    #3#10 = 0;
  |FINSI;
  |GRABA 000#3a;
|FINSI;
|LIBERA #3;
|CIERRA #3;
|FCAL;

|DEFBUCLE lee_tmp;
#1#1;
;
"                    ";
"zzzzzzzzzzzzzzzzzzzz";
be;
NULL,grabar;
|FIN;

|CALCULO rpmc;|TIPO 3;
     |HAZ para_ger;
     |SI #0#0 = "SI";
       |HAZ CreaTempo; aTmp1 = Tempo;
       |NOME_DAT #1 aTmp1; |DELINDEX #1;
       |ABRE #1;
       |ABRE #2;

       |BUCLE lee_histo;
       |BUCLE lee_tmp;

       |LIBERA #2;
       |CIERRA #1;
       |CIERRA #2;
       Tempo = aTmp1; |HAZ BoraTempo; |DELINDEX #1;
     |FINSI;
|FCAL;

|PROCESO para_ger;
     |ABRE #42;
     #42#0 = "A";
     |LEE 001#42=;
     |SI FSalida ! 0; |DDEFECTO #42; |FINSI;
     |CIERRA #42;
     n_pre = #42#9;
|FPRC;
