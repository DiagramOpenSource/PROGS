|FICHEROS;
     guerm045 #0;
     goparame #1;
     gomaw002 #2;
     gomaw003 #3,MANTE;
     goartmer #4;
     gomantho #10;
     gomantl1 #11;
     agifa019 #19;
     guerw039 #39; ||Tmp Expe
     goprepec #60;
     goprepel #61;
     agifa067 #67;
     agifa077 #77;
     agifa080 #80;
|FIN;

|VARIABLES;
     &enPreCosteF = 0;
     &aDivisa = "";
     &aMoneda = "";

     &enPrepe = 0;
     &enAlmaCompras = 0;
     &eaSerPreSal = "";
     &enNumPreSal = 0;
     &eaSerExpSal = "";
     &enNumExpSal = 0;
     &enError = 0;

     fFechaPre = @;
     nHayPre = 0;
     nNumPre = 0;
     nNumExp = 0;
     aSerPre = "";
     aSerExp = "";
     nConta = 0;
     nAlma = 0;
     aAlfa = "";
     aArticulo = "";
     nPrecio = 0;
     nDto1 = 0;
     nDto2 = 0;
     aSerAlbPre = "";
     nNumAlbPre = 0;
     nLinAlbPre = 0;
     aSerPed = "";
     nNumPed = 0;
     aSerAlb = "";
     nNumAlb = 0;
|FIN;

|PROCESO Borra0;
     |BORRA 020#0a;
|FPRC;

|DEFBUCLE Borra0;
     #0#1;
     ;
     #2#3, #2#4, 000;
     #2#3, #2#4, 999;
     ;
     NULL, Borra0;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO BuscaPresu;
     |SI nNumPre = 0; ||Y #11#10 = "C";
          aSerPre = #11#3;
          nNumPre = #11#4;
     |FINSI;
|FPRC;

|PROCESO BuscaExped;
     |SI #10#0 = #1#109; |Y #10#1 = #1#114;
            || No es expediente fabricacion
     |SINO;
          nNumPre = 0;
          aSerExp = #10#0;
          nNumExp = #10#1;

          nConta = nConta + 1;
          #39#0 = #10#0;
          #39#1 = #10#1;
          #39#2 = #10#29;
          |GRABA 020#39n;
     |FINSI;
|FPRC

|DEFBUCLE BuscaExped;
     #10#1;
     9, 11;
     "     ", 000001, "C", nAlma;
     "zzzzz", 999999, "C", nAlma;
     ;
     NULL, BuscaExped, BuscaPresu;
|FIN;

|DEFBUCLE BuscaPresu;
     #11#1;
     ;
     aSerExp, nNumExp, 001;
     aSerExp, nNumExp, 999;
     ;
     NULL, BuscaPresu;
|FIN;

|PROCESO BuscaExSal;
     aAlfa = Usuario;
     |NOME_DAT #39 aAlfa; |DELINDEX #39;
     |ABRE #39;

     nConta = 0;
     nNumExp = 0;
     nNumPre = 0;
     nAlma = enAlmaCompras;
     |BUCLE BuscaExped;
     |SI nNumPre = 0; |O nNumExp = 0;
          aAlfa = "0000No existe expediente en curso del almacen:" + nAlma;
          |MENAV aAlfa;
          enError = 1;
     |FINSI;
     |SI nConta > 1;
          nNumExp = 0;
          |LEE 000#39p;
          |CONSULTA_CLAVE #1#39;
          |SI FSalida = 0;
               aSerExp = #39#0;
               nNumExp = #39#1;
          |FINSI;
     |FINSI;
     |SI nNumExp = 0;
          enError = 1;
     |SINO;
          |SI nConta > 1; nNumPre = 0; |BUCLE BuscaPresu; |FINSI;
     |FINSI;
     |CIERRA #39;
     |DELINDEX #39;
     eaSerPreSal = aSerPre;
     enNumPreSal = nNumPre;
     eaSerExpSal = aSerExp;
     enNumExpSal = nNumExp;
     |BUCLE Borra0;
|FPRC;

컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO agifa080;
     nConta = nConta + 1;
     |SI aArticulo = #80#2;
          #77#50 = #80#27;
          #77#0 = #80#0;
          |LEE 020#77=;
          aDivisa = #agifa077#56;
          aMoneda = #agifa077#58;
          |HAZ Divisas077;

          nPrecio = #80#30;
          nDto1 = #80#8;
          nDto1 = #80#26;
          aSerAlbPre = #80#27;
          nNumAlbPre = #80#0;
          nLinAlbPre = #80#1;
          enError = 0;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE agifa080;
     #80#3;
     ;
     aSerPed, nNumPed, 001;
     aSerPed, nNumPed, 999;
     ;
     NULL, agifa080;
|FIN;

|PROCESO goprepel;
     |SI aArticulo = #61#2;
             |||Y #61#10 = "S"; quitado segun: 00225.0002 Cliente: 003774
          |SI #60#1 > fFechaPre;
               aAlfa = "";
               aSerPed = #61#28;
               nNumPed = #61#29;
               fFechaPre = #60#1;
          |FINSI;
     |FINSI;
     nHayPre = 1;
|FPRC;

|DEFBUCLE goprepec;
     #60#2;
     ;
     aSerExp, nNumExp;
     aSerExp, nNumExp;
     ;
     NULL, NULL, goprepel;
|FIN;

|PROCESO CheqArti; |TIPO 0;
     |HAZ EsForestales;
     |SI FSalida = 0;
          |HAZ ForesPreCoste;
          |SI enPreCosteF = 0; |ERROR; |ACABA; |FINSI;
     |FINSI;

     |SI #1#81 = "N";
          |HAZ GrabaOtro0;
          |ACABA;
     |FINSI;

     |HAZ DecimalesBase;

     nNumPre = 0;
     aSerExp = #2#1;
     nNumExp = #2#2;
     |BUCLE BuscaPresu;
     |ABRE #10;
     #10#0 = aSerExp;
     #10#1 = nNumExp;
     |LEE 020#10=;
     |CIERRA #10;
     nAlma = #10#11;
     aArticulo = #3#1;

     aSerAlbPre = "";
     nNumAlbPre = 0;
     nLinAlbPre = 0;
     nDto1 = 0;
     nDto2 = 0;
     |SI enPrepe ! 0;    || Sin Prepedido
          nPrecio = 0;
          |ABRE #19;
          #19#0 = aArticulo;
          |LEE 020#19=;
          |CIERRA #19;
          |ABRE #4;
          #4#0 = aArticulo;
          |LEE 000#4=;
          |SI FSalida = 0;
               nPrecio = #4#1;
          |FINSI;
          |CIERRA #4;

          |SI nPrecio = 0;
               nPrecio = #19#133;
          |FINSI;
          #3#4 = nPrecio;

          |HAZ GrabaEl0;
          |ACABA;
     |FINSI;

     nHayPre = 0;
     aAlfa = "0000No existe Articulo en el Prepedido, se recoge el ultimo Precio de Compra";
     fFechaPre = "01.01.0000";
     |BUCLE goprepec;
     |SI aAlfa ! "";
          |SI nHayPre = 0;
               aAlfa = ("000000" + nNumExp) % -106;
               aAlfa = "0000Expediente:" + aSerExp + "/" + aAlfa + " sin Prepedido";
               |MENAV aAlfa;
               enError = 1; |ACABA;
          |FINSI;
          |MENAV aAlfa;
          |ABRE #19;
          #19#0 = aArticulo;
          |LEE 020#19=;
          |CIERRA #19;
          nPrecio = #19#133;
          #3#4 = nPrecio;
          |ACABA;
     |FINSI;
     |SI nNumPed = 0;
          aAlfa = ("000000" + #60#0) % -106;
          aAlfa = "0000No se ha generado el Pedido del Prepedido:" + aAlfa;
          |MENAV aAlfa;
          enError = 1; |ACABA;
     |FINSI;
     nConta = 0;
     enError = 1;
     |ABRE #77;
     |BUCLE agifa080;
     |CIERRA #77;
     |SI enError = 1;
          |SI nConta = 0;
               aAlfa = ("000000" + nNumPed) % -106;
               aAlfa = "0000Pedido no adjudicado:" + aSerPed + "/" + aAlfa;
          |SINO;
               aAlfa = ("000000" + nNumAlb) % -106;
               aAlfa = "0000No se encuentra articulo en el Albaran:" + aSerAlb +"/"+aAlfa;
          |FINSI;
          |MENAV aAlfa;
          |ERROR;
     |SINO;
          |HAZ GrabaEl0;
          #3#4 = nPrecio;
          #3#5 = nDto1;
          #3#6 = nDto1;
          #3#7 = aSerAlbPre;
          #3#8 = nNumAlbPre;
          #3#9 = nLinAlbPre;
     |FINSI;
|FPRC;

|PROCESO GrabaOtro0;
     nAlma = #1#22;
     aSerExp = "";
     nNumExp = 0;
     aSerPre = "";
     nNumPre = 0;
     || Busca almacen central (=compras) en expedientes
     |ABRE #10;
     |ABRE #11;
     |LEE 000#10p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          |SI #10#11 = #1#22;
               aSerExp = #10#0;
               nNumExp = #10#1;
               #11#0 = #10#0;
               #11#1 = #10#1;
               #11#2 = 0;
               |LEE 000#11];
               |SI FSalida = 0; |Y #11#0 = #10#0; |Y #11#1 = #10#1;
                    aSerPre = #11#3;
                    nNumPre = #11#4;
               |FINSI;
               |SAL;
          |FINSI;
          |LEE 000#10s;
     |SIGUE;
     |CIERRA #11;
     |CIERRA #10;
     |ABRE #19;
     #19#0 = #3#1;
     |LEE 000#19=;
     |CIERRA #19;
     nPrecio = #19#133;
     |SI nPrecio = 0; nPrecio = #19#9; |FINSI;
     nDto1 = 0;
     nDto2 = 0;

     eaSerExpSal = aSerExp;
     enNumExpSal = nNumExp;
     eaSerPreSal = aSerPre;
     enNumPreSal = nNumPre;
     |ABRE #0;
     #0#0 = #2#3;
     #0#1 = #2#4
     #0#2 = #3#0;
     |LEE 101#0=;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;

     #0#3 = nPrecio;
     #0#16 = nDto1;
     #0#17 = nDto2;
||     #0#18 = aSerAlbPre;
||     #0#19 = nNumAlbPre;
||     #0#20 = nLinAlbPre;
     #0#4 = "";
     #0#5 = 0
||     #0#6 = aSerExp;
||     #0#7 = nNumExp;
||     #0#8 = aSerPre;
||     #0#9 = nNumPre;

     #0#10 = eaSerExpSal;
     #0#11 = enNumExpSal;
     #0#12 = eaSerPreSal;
     #0#13 = enNumPreSal;
     #0#14 = enAlmaCompras;
     #0#15 = nAlma;
     |GRABA 020#0a;
     |CIERRA #0;
|FPRC;

|PROCESO GrabaEl0;
     |ABRE #0;
     #0#0 = #2#3;
     #0#1 = #2#4
     #0#2 = #3#0;
     |LEE 101#0=;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;

     #0#3 = nPrecio;
     #0#16 = nDto1;
     #0#17 = nDto2;
     #0#18 = aSerAlbPre;
     #0#19 = nNumAlbPre;
     #0#20 = nLinAlbPre;
     #0#4 = "";
     #0#5 = 0
     #0#6 = aSerExp;
     #0#7 = nNumExp;
     #0#8 = aSerPre;
     #0#9 = nNumPre;

     #0#10 = eaSerExpSal;
     #0#11 = enNumExpSal;
     #0#12 = eaSerPreSal;
     #0#13 = enNumPreSal;
     #0#14 = enAlmaCompras;
     #0#15 = nAlma;
     |GRABA 020#0a;
     |CIERRA #0;
|FPRC;

|PROCESO CheqArti2; |TIPO 0;
     |SI #1#81 = "N";
          |HAZ GrabaOtro0;
          |ACABA;
     |FINSI;

     |HAZ DecimalesBase;
     nNumPre = 0;
     aSerExp = #2#1;
     nNumExp = #2#2;
     |BUCLE BuscaPresu;
     |ABRE #10;
     #10#0 = aSerExp;
     #10#1 = nNumExp;
     |LEE 020#10=;
     |CIERRA #10;
     nAlma = #10#11;
     aArticulo = #3#1;

     |ABRE #0;
     #0#0 = #2#3;
     #0#1 = #2#4
     #0#2 = #3#0;
     |LEE 101#0=;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;

     #0#3 = #3#4;
     #0#16 = #3#5;
     #0#17 = #3#6;
     #0#18 = #3#7;
     #0#19 = #3#8;
     #0#20 = #3#9;
     #0#4 = "";
     #0#5 = 0
     #0#6 = aSerExp;
     #0#7 = nNumExp;
     #0#8 = aSerPre;
     #0#9 = nNumPre;

     #0#10 = eaSerExpSal;
     #0#11 = enNumExpSal;
     #0#12 = eaSerPreSal;
     #0#13 = enNumPreSal;
     #0#14 = enAlmaCompras;
     #0#15 = nAlma;
     |GRABA 020#0a;
     |CIERRA #0;
|FPRC;

|PROCESO ForesPreCoste;
     enPreCosteF = 0;
     |ABRE #19;
     #19#0 = #3#1;
     |LEE 020#19=;
     |SI FSalida = 0;
          |SI #19#133 ! 0;
              enPreCosteF = #19#133;
          |SINO;
               |SI #19#9 ! 0;
                    enPreCosteF = #19#9;
               |SINO;
                    |SI #19#149 ! 0;
                         enPreCosteF = #19#149 - (#19#149 * #19#152 / 100);
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #19;
     |SI enPreCosteF = 0;
          |MENAV "0000Articulo sin precio de coste...";
          |ERROR;
     |FINSI;
|FPRC;
