|| --------- Generacion de Albaranes de Rappels -----------------------

|FICHEROS;
albad016 #0;
agifa010 #1;
agifa071 #2;
agifa027 #5;
agifa024 #6;
agifa017 #8;
agifa065 #9;
agifa019 #10;
albad020 #12;
||agif9114 #14;  Recibos
|FIN;

|CAMPOS;
   #10#11 nec;     #10#15 sps;
   #10#16 spr;     #10#7 stmia;
   #10#104 stdia;  #10#17 pdva;
   #10#13 stfa;    #10#12 stres;
|FIN;

|VARIABLES;
     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;
 &EURODB = 0;
 imneto = 0;
 asto = 0;
 margen = 0;
 wimneto = 0;
 wmargen = 0;
cantidad = 0;
fmes = "  ";
mes = 0;
me  = 0;
swescan = 0;
sw = 0;
sw1 = 0;

lin = 0;
menos = -1;
contador = 0;
mascara = "000000";
tempo = " ";
filtro = "-106";
codigo = "";
cliente = "";
bruto = 0;
total = 0;
base0 = 0;
base1 = 0;
base2 = 0;
base3 = 0;
base4 = 0;
base5 = 0;
cuota1 = 0;
cuota2 = 0;
cuota3 = 0;
cuota4 = 0;
cuota5 = 0;
|FIN;


|CALCULO genelin2;
|SI #12#3 ! 0;
  |ABRE #2;
  |ABRE #10;
  #10#0 = #12#1;
  |LEE 000#10=;
  |LIBERA #10;
  |SI FSalida = 0;
    sw1 = 1;
    #2#0 = codigo;
    lin = lin + 1;
    #2#1 = lin;
    #2#29 = #0#12;
    #2#2 = #12#1;
    #2#3 = 1;
    #2#4 = #10#1;
    #2#5 = 1 * menos;
    #2#6 = #12#3;
    #2#7 = #2#5 * #2#6;
    #2#9 = #2#5 * #2#6;
    bruto = bruto + #2#9;
    #2#11 = #10#30;
    || ---------- Calculo IVAS -----------
    enTiva = #2#11;
    efFiva = #1#1;
    |HAZ SacaIVA;


    |SI #2#11 = 0;
      base0 = base0 + #2#9;
    |FINSI;
    |SI #2#11 = 1;
      base1 = base1 + #2#9;
      cuota1 = base1 * enIva /100;
    |FINSI;
    |SI #2#11 = 2;
      base2 = base2 + #2#9;
      cuota2 = base2 * enIva /100;
    |FINSI;
    |SI #2#11 = 3;
      base3 = base3 + #2#9;
      cuota3 = base3 * enIva /100;
    |FINSI;
    |SI #2#11 = 4;
      base4 = base4 + #2#9;
      cuota4 = base4 * enIva /100;
    |FINSI;
    |SI #2#11 = 5;
      base5 = base5 + #2#9;
      cuota5 = base5 * enIva /100;
    |FINSI;
    total = bruto + cuota1 + cuota2 + cuota3 + cuota4 + cuota5;

    #2#13 = #10#2;
    #2#15 = #12#0;
    #2#33 = 0;
    #2#34 = #2#5;
    #2#35 = 0;
    #2#36 = 0;
    |GRABA 021#2n;
    |HAZ AlbaSinMovi;
    |LIBERA #2;
    |LIBERA #10;
  |FINSI;

  |LIBERA #2;
  |LIBERA #10;
  |CIERRA #2;
  |CIERRA #10;
|FINSI;
|FCAL;

|CALCULO genera2;
#6#0 = #12#0;
|LEE 101#6=;
|LIBERA #6;
|SI FSalida ! 0;
  |GRABA 021#6c;
  |LIBERA #6;
|FINSI;
|SI #6#158 ] #0#2;|Y #6#158 [ #0#3;
  |SI cliente ! #12#0;
    cliente = #12#0;
    |SI sw = 1;
      |HAZ graba_cab;
    |FINSI;
    sw = 1;
    total = 0;
    bruto = 0;
    base0 = 0;
    base1 = 0;
    base2 = 0;
    base3 = 0;
    base4 = 0;
    base5 = 0;
    cuota1 = 0;
    cuota2 = 0;
    cuota3 = 0;
    cuota4 = 0;
    cuota5 = 0;
    lin = 0;
  |ET contar;
    |ABRE #5;
    #5#2 = #0#12;
    #5#0 = "valbaran";
    |LEE 111#5=;
    |SI FSalida ! 0;
         contador = 1;
         |GRABA 111#5c;
    |FINSI;
      contador = #5#1;
      tempo = mascara + contador;
      codigo = tempo % filtro;
      contador = contador + 1;
      #5#1 = contador;
      |GRABA 021#5a;
    |LIBERA #5;
    |CIERRA #5;
    #1#0 = codigo;
    #1#52 = #0#12;
    |LEE 000#1=;
    |SI FSalida = 0;
      |VETE contar;
    |FINSI;
 |FINSI;


||  ----------------- Generacion Lineas Albaran Rappels -------------

    |HAZ genelin2;
|FINSI;
|FCAL;


|CALCULO graba_cab;
||  ----------------- Generacion Cabecera Albaran Rappels -------------
|SI sw1 = 1;
  sw1 = 0;
  #6#0 = #2#15;
  |LEE 000#6=;
  |LIBERA #6;
  #1#0 = codigo;
  #1#52 = #0#12;
  #1#1 = #0#13;
  #1#3 = #6#0;
  #1#4 = #6#1;
  #1#5 = 0;
  #1#7 = 0;
  #1#32 = 0;
  #1#8 = #6#20;
  #1#9 = #6#35;
  #1#15 = bruto;
  #1#16 = base1;
  #1#17 = cuota1;
  #1#18 = 0;
  #1#19 = base2;
  #1#20 = cuota2;
  #1#21 = 0;
  #1#22 = base3;
  #1#23 = cuota3;
  #1#24 = cuota1 + cuota2 + cuota3 + cuota4 + cuota5;
  #1#25 = 0;
  #1#27 = "";
  #1#28 = base0;
  #1#29 = #6#1;
  #1#30 = #6#5;
  #1#31 = #6#6;
  #1#33 = #6#7;
  #1#36 = #6#47;
  #1#38 = "N";
  #1#39 = "";
  #1#40 = #6#41;
  #1#43 = "N";
  #1#44 = base4;
  #1#45 = cuota4;
  #1#46 = 0;
  #1#47 = base5;
  #1#48 = cuota5;
  #1#49 = 0;
  #1#50 = #6#40;
  #1#51 = "S";
  #1#53 = "";
  #1#54 = 0;
  #1#55 = #6#53;
|||  #1#58 = "N";
  |LIBERA #6;
  |GRABA 021#1n;

   |HAZ LimCabAgifa010;
   |BUCLELIN 0 CalCabAgifa010 #agifa010;

  |LIBERA #1;
  |PRINT;
  ||HAZ hazr;
  |LIBERA #6;
|SINO;
  |ABRE #5;
  #5#2 = #0#12;
  #5#0 = "valbaran";
  |LEE 111#5=;
  |SI FSalida ! 0;
     contador = 1;
     |GRABA 111#5c;
  |FINSI;
  #5#1 = #5#1 - 1;
  |GRABA 021#5a;
  |LIBERA #5;
  |CIERRA #5;
|FINSI;
|FCAL;

|DEFBUCLE proceso1;
#12#1;
;
INICIO;
FINAL;
be;
NULL,genera2;
#12#0;
|FIN;

|PROCESO generap;|TIPO 0;
   |ABRE #1;
   |ABRE #2;
   |ABRE #5;
   |ABRE #6;
   |ABRE #12;

   |IMPRE 1;
   |INFOR "generesu";

   |BUCLE proceso1;
   |HAZ graba_cab;

   |PIEINF;
   |FININF;
   |FINIMP;

   |LIBERA #1;
   |LIBERA #2;
   |LIBERA #5;
   |LIBERA #6;
   |LIBERA #12;
   |CIERRA #1;
   |CIERRA #2;
   |CIERRA #5;
   |CIERRA #6;
   |CIERRA #12;
|FPRC;

|CALCULO altahis2;|TIPO 0;
|ABRE #9;
|DDEFECTO #9;
#9#0 = #2#2;
#9#1 = #0#13;
#9#2 = "AV";
#9#3 = #2#0;
#9#4 = #2#1;
#9#5 = #2#3;         || almacen de entrada
#9#6 = #2#5;
||#9#7 = #2#6;
||#9#8 = #2#9;
#9#9 = #2#6;
#9#10 = #2#15;
#9#11 = #2#29;
|GRABA 121#9n;
|LIBERA #9;
|CIERRA #9;
||HAZ artialta2;
|FCAL;

|CALCULO artialta2;
   |ABRE #8;
   |ABRE #10;
   #10#0 = #2#2;
   |LEE 000#10=;
   |SI FSalida ! 0;
     |GRABA 021#10c;
     |LIBERA #10;
   |FINSI;
   wimneto = #2#9 < #1#5;
   wimneto = wimneto < #1#32;
   wimneto = wimneto < #1#7;
   wimneto = wimneto ! EURODB;            || puesto el 01-02-90 Javier

   |DDEFECTO #8;
   #8#0 = #2#2; ||Articulo;
   #8#1 = #2#3; ||Almacen;
   |LEE 140#8=;
   |SI FSalida ! 0;
      |GRABA 021#8c;
      |LIBERA #8;
   |FINSI;
        cantidad = #2#5;
           stdia = stdia + cantidad;
           #10#6 = #10#104 + #10#12;
           asto = #10#6 - #10#17;
        |SI asto > 0;
           #10#10 = asto * #10#9;
        |SINO;
           #10#10 = 0;
        |FINSI;
        nec = sps + stmia; nec = nec - spr; nec = nec - stdia;
        nec = nec - pdva;  nec = nec - stfa;nec = nec - stres ;

        fmes = #1#1 % A402;
        mes = fmes - 1;
        mes = mes * 5;
        mes = mes + 34;
        |SI #1#43 = AN;              || caso albaran
           #10mes = #10mes + cantidad;
           margen = cantidad * #10#9;
           margen = wimneto - margen;
           mes = mes + 1;
           #10mes = #10mes + wimneto;
           mes = mes + 1;
           #10mes = #10mes + margen;

           #10#94 = #10#94 + cantidad;
           #10#95 = #10#95 + wimneto;
           #10#96 = #10#96 + margen;

           #8#39 = #8#39 + cantidad;
           #8#5 = #8#39 + #8#8;
           asto = #8#5 - #8#4;
           |SI asto > 0;
               #8#3 = asto * #10#9;
           |SINO;
               #8#3 = 0;
           |FINSI;
          mes = fmes - 1;
          mes = mes * 2;
          mes = mes + 11;
          #8mes = #8mes + cantidad;
          #8#35 = #8#35 + cantidad;
       |SINO;                      || caso abono
          #10mes = #10mes - cantidad;
          margen = cantidad * #10#9;
          margen = wimneto - margen;
          mes = mes + 1;
          #10mes = #10mes - wimneto;
          mes = mes + 1;
          #10mes = #10mes - margen;

          #10#94 = #10#94 - cantidad;
          #10#95 = #10#95 - wimneto;
          #10#96 = #10#96 - margen;

          #8#39 = #8#39 + cantidad;
          #8#5 = #8#39 + #8#8;
          asto = #8#5 - #8#4;
          |SI asto > 0;
             #8#3 = asto * #10#9;
          |SINO;
             #8#3 = 0;
          |FINSI;
          mes = fmes - 1;
          mes = mes * 2;
          mes = mes + 11;
          #8mes = #8mes - cantidad;
          #8#35 = #8#35 - cantidad;
       |FINSI;

      |GRABA 021#8a;
      |GRABA 021#10a;
      |LIBERA #8;
      |LIBERA #10;
|FCAL;
*/
/*
|PROCESO hazr;
     |ABRE #14;
          |DDEFECTO #14;
          #14#17 = #1#52;
          #14#0 = #1#0;
          #14#1 = 1;
          |LEE 101#14=;
          |SI FSalida ! 0; |GRABA 021#14b; |FINSI;
          #6#0 = #1#3;
          |LEE 101#6=;
          #14#2 = #1#3;  ||cliente
          #14#3 = #1#4;  ||nombre del cliente
          #14#4 = #6#29; ||Banco
          #14#5 = "S";   ||domiciliado
          #14#6 = "N";   ||aceptado
          #14#7 = #1#1;  ||fecha de emision
          #14#8 = #1#1;  ||Fecha de vencimiento
          #14#9 = 0;
          #14#9 = #1#16 + #1#19 + #1#22 + #1#28 + #1#44 + #1#47 + #1#17;||Importe
          #14#9 = #14#9 + #1#18 + #1#20 + #1#21 + #1#23 + #1#54 + #1#45;||Importe
          #14#9 = #14#9 + #1#46 + #1#48 + #1#49;    ||Importe
          #14#10 = "N";  ||Impreso
          #14#11 = "N";  ||Contabilizado
          #14#12 = #6#16;||numero contable
          #14#13 = "N";  ||Cobrado
          #14#14 = "N";  ||Impagado
          #14#15 = #6#161;||A aceptar
          #14#16 = "01.01.0000";   ||fecha de cobro

          |GRABA 021#14a;
          |LIBERA #6;
          |LIBERA #14;
          |CIERRA #14;
|FPRC;
