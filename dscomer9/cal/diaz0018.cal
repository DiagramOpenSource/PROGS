|FICHEROS;
   diaz0018 #0;

   diaw0019 #10;
   agifa019 #11;
   agi00063 #12;
   agifa553 #13;
   diam0028 #14;
   diam0031 #15;
   diam0019 #16;
   diam0029 #17;
   diam0015 #18;
   diam0016 #19;
   diam0020 #20;
   agifa073 #21;
   agifa071 #22;
   agifa104 #23;
   agifa010 #24;
   agifa060 #25;
|FIN;

|VARIABLES;

   fDFecha = @;
   fHFecha = @;
   fech1   = @;
   fech2   = @;

   nInf     = 0;
   nSwNuevo = 0;
   nCont    = 0;
   nDSemana = 0;
   nHSemana = 0;
   nSemana  = 0;
   nCalc    = 0;
   nAnyo    = 0;
   FEstado  = 0;

   sdia = 0;
   smas = 0;
   sdife = 0;
   srest = 0;
   nume1 = 0;
   nume2 = 0;

   alfa1  = "";
   alfa2  = "";

   fFecha   = @;

   aFam     = "";
   aCodArt  = "";
   aAlfa    = "";
   aVacio   = "";
   aLleno   = "";
|FIN;

|PROCESO LeeArticulo;
   #agifa019#0 = aCodArt;
   |LEE 000#agifa019.=;
   |SI FSalida ! 0; |DDEFECTO #agifa019; |FINSI;

   #agifa060#0 = #agifa019#2;
   |LEE 000#agifa060.=;
   |SI FSalida ! 0; |DDEFECTO #agifa060; |FINSI;

   #agi00063#0 = #agifa019#126;
   |LEE 000#agi00063.=;
   |SI FSalida ! 0; |DDEFECTO #agi00063; |FINSI;

   #agifa553#0 = #agifa019#125;
   |LEE 000#agifa553.=;
   |SI FSalida ! 0; |DDEFECTO #agifa553; |FINSI;

   #diam0028#0 = #diam0031#2;
   |LEE 000#diam0028.=;
   |SI FSalida ! 0; |DDEFECTO #diam0028; |FINSI;
|FPRC;

|PROCESO LineasPpto;

   #diam0031#0 = #diaw0019#0;
   #diam0031#1 = #diaw0019#1;
   #diam0031#2 = #diaw0019#2;
   #diam0031#3 = #diaw0019#3;
   |LEE 000#diam0031.=;
   |SI FSalida ! 0; |DDEFECTO #diam0031; |FINSI;

   #diaw0019#10 = #diaw0019#10 + #diam0031#5;
   |GRABA 020#diaw0019.a; |LIBERA #diaw0019;
|FPRC;

|DEFBUCLE LineasPpto;
#diaw0019#1;
;
INICIO;
FINAL;
;
NULL,LineasPpto;
|FIN;

|PROCESO LineasOferta;
   nSemana = 0; fFecha = #diam0019#1; |HAZ mirasem;
   |SI nSemana < #diaz0018#4; |O nSemana > #diaz0018#10; |ACABA; |FINSI;
   aAlfa = fFecha; |QBF aAlfa; aAlfa = aAlfa % -104; nAnyo = aAlfa;
   |SI nAnyo ! #diaz0018#2; |ACABA; |FINSI;

   #diam0029#1 = #diam0019#18;
   |LEE 000#diam0029.=;
   |SI FSalida = 0;
      |SI #diam0029#0 < #diaz0018#3; |O #diam0029#0 > #diaz0018#9;
         |ACABA;
      |FINSI;
   |SINO;
      |ACABA;
   |FINSI;

   |PARA nCont = 2; |SI nCont [ 22; |HACIENDO nCont = nCont + 4;
      #agifa019#0 = #diam0015#nCont#;
      |LEE 000#agifa019.=;
      |SI FSalida ! 0; |DDEFECTO #agifa019; |FINSI;
      |SI #diam0015#nCont# ] #diaz0018#8; |Y #diam0015#nCont# [ #diaz0018#14;
         aCodArt = #diam0015#nCont#; |HAZ LeeArticulo;
         #diaw0019#0 = nAnyo;
         #diaw0019#1 = nSemana;
         #diaw0019#2 = #diam0029#0;
         #diaw0019#3 = #diam0015#nCont#;
         |LEE 101#diaw0019.=;
         |SI FSalida ! 0;
            |DDEFECTO #diaw0019;
            #diaw0019#0 = nAnyo;
            #diaw0019#1 = nSemana;
            #diaw0019#2 = #diam0029#0;
            #diaw0019#3 = #diam0015#nCont#;
            #diaw0019#4 = #agifa019#1;
            #diaw0019#5 = #agifa019#126;
            #diaw0019#6 = #agi00063#1;
            #diaw0019#7 = #agifa019#125;
            #diaw0019#8 = #agifa553#1;
            #diaw0019#9 = #diam0028#1;
            #diaw0019#14 = #agifa019#2;
            #diaw0019#15 = #agifa060#1;
            |GRABA 020#diaw0019.b;
         |FINSI;
         nCalc = ((nCont - 2) / 4) ! 0; nCalc = 36 + (nCalc * 5);
         #diaw0019#11 = #diaw0019#11 + #diam0019#nCalc#;
         |GRABA 020#diaw0019.a; |LIBERA #diaw0019;
      |FINSI;
   |SIGUE;

   |PARA nCont = 29; |SI nCont [ 44; |HACIENDO nCont = nCont + 3;
      |SI nCont = 35; |O nCont = 38;
         |ABRE #diam0020;
         #diam0020#0 = #diam0019#0;
         #diam0020#1 = #diam0019#1;
         #diam0020#2 = #diam0019#13;
         |SI nCont = 35; aFam = #diam0019#82; |FINSI;
         |SI nCont = 38; aFam = #diam0019#86; |FINSI;
         #diam0020#3 = aFam;
         #diam0020#4 = 1;
         |LEE 000#diam0020.];
         |PARA; |SI FSalida = 0; |Y #diam0020#0 = #diam0019#0; |Y #diam0020#1 = #diam0019#1;
           |Y #diam0020#2 = #diam0019#13; |Y #diam0020#3 = aFam; |HACIENDO;
            aCodArt = #diam0020#5; |HAZ LeeArticulo;
            #diaw0019#0 = nAnyo;
            #diaw0019#1 = nSemana;
            #diaw0019#2 = #diam0029#0;
            #diaw0019#3 = #diam0020#5;
            |LEE 101#diaw0019.=;
            |SI FSalida ! 0;
               |DDEFECTO #diaw0019;
               #diaw0019#0 = nAnyo;
               #diaw0019#1 = nSemana;
               #diaw0019#2 = #diam0029#0;
               #diaw0019#3 = #diam0020#5;
               #diaw0019#4 = #agifa019#1;
               #diaw0019#5 = #agifa019#126;
               #diaw0019#6 = #agi00063#1;
               #diaw0019#7 = #agifa019#125;
               #diaw0019#8 = #agifa553#1;
               #diaw0019#9 = #diam0028#1;
               #diaw0019#14 = #agifa019#2;
               #diaw0019#15 = #agifa060#1;
               |GRABA 020#diaw0019.b;
            |FINSI;
            #diaw0019#11 = #diaw0019#11 + #diam0020#9;
            |GRABA 020#diaw0019.a; |LIBERA #diaw0019;
            |LEE 000#diam0020.s;
         |SIGUE;
         |CIERRA #diam0020;
      |SINO;
         #agifa019#0 = #diam0015#nCont#;
         |LEE 000#agifa019.=;
         |SI FSalida ! 0; |DDEFECTO #agifa019; |FINSI;
         |SI #diam0015#nCont# ] #diaz0018#8; |Y #diam0015#nCont# [ #diaz0018#14;
            aCodArt = #diam0015#nCont#; |HAZ LeeArticulo;
            #diaw0019#0 = nAnyo;
            #diaw0019#1 = nSemana;
            #diaw0019#2 = #diam0029#0;
            #diaw0019#3 = #diam0015#nCont#;
            |LEE 101#diaw0019.=;
            |SI FSalida ! 0;
               |DDEFECTO #diaw0019;
               #diaw0019#0 = nAnyo;
               #diaw0019#1 = nSemana;
               #diaw0019#2 = #diam0029#0;
               #diaw0019#3 = #diam0015#nCont#;
               #diaw0019#4 = #agifa019#1;
               #diaw0019#5 = #agifa019#126;
               #diaw0019#6 = #agi00063#1;
               #diaw0019#7 = #agifa019#125;
               #diaw0019#8 = #agifa553#1;
               #diaw0019#9 = #diam0028#1;
               #diaw0019#14 = #agifa019#2;
               #diaw0019#15 = #agifa060#1;
               |GRABA 020#diaw0019.b;
            |FINSI;
            |SI nCont = 29; nCalc = 71;  |FINSI;
            |SI nCont = 32; nCalc = 77;  |FINSI;
            |SI nCont = 35; nCalc = 85;  |FINSI;
            |SI nCont = 38; nCalc = 89;  |FINSI;
            |SI nCont = 41; nCalc = 97;  |FINSI;
            |SI nCont = 44; nCalc = 101; |FINSI;
            #diaw0019#11 = #diaw0019#11 + #diam0019#nCalc#;
            |GRABA 020#diaw0019.a; |LIBERA #diaw0019;
         |FINSI;
      |FINSI;
   |SIGUE;
|FPRC;

|DEFBUCLE LineasOferta;
#diam0019#1;
;
"      ", "01.01.1900", "        ";
"zzzzzz", "31.12.2999", "zzzzzzzz";
;
NULL,LineasOferta;
|FIN;

|PROCESO LineasPedidos;
   |SELECT #2#diam0016;
   #diam0016#14 = #agifa073#28;
   #diam0016#15 = #agifa073#0;
   |LEE 000#diam0016.=;
   FEstado = FSalida;
   |SI FSalida = 0;
      #diam0019#0  = #diam0016#0;
      #diam0019#1  = #diam0016#1;
      #diam0019#13 = #diam0016#13;
      |LEE 000#diam0019.=;
      FEstado = FSalida;
   |FINSI;
   |SELECT #1#diam0016;

   |SI #agifa073#2 ] #diaz0018#8; |Y #agifa073#2 [ #diaz0018#14;
      aCodArt = #agifa073#2; |HAZ LeeArticulo;
      #diaw0019#0 = nAnyo;
      #diaw0019#1 = nSemana;
      #diaw0019#2 = #diam0029#0;
      #diaw0019#3 = #agifa073#2;
      |LEE 101#diaw0019.=;
      |SI FSalida ! 0;
         |DDEFECTO #diaw0019;
         #diaw0019#0 = nAnyo;
         #diaw0019#1 = nSemana;
         #diaw0019#2 = #diam0029#0;
         #diaw0019#3 = #agifa073#2;
         #diaw0019#4 = #agifa019#1;
         #diaw0019#5 = #agifa019#126;
         #diaw0019#6 = #agi00063#1;
         #diaw0019#7 = #agifa019#125;
         #diaw0019#8 = #agifa553#1;
         #diaw0019#9 = #diam0028#1;
         #diaw0019#14 = #agifa019#2;
         #diaw0019#15 = #agifa060#1;
         |GRABA 020#diaw0019.b;
      |FINSI;
      |SI FEstado = 0;
         #diaw0019#12 = #diaw0019#12 + #agifa073#9;
      |SINO;
         #diaw0019#11 = #diaw0019#11 + #agifa073#9;
      |FINSI;
      |GRABA 020#diaw0019.a; |LIBERA #diaw0019;
   |FINSI;
|FPRC;

|DEFBUCLE LineasPedidos;
#agifa073#1;
;
#agifa104#25, #agifa104#0, 001;
#agifa104#25, #agifa104#0, 999;
;
NULL,LineasPedidos;
|FIN;

|PROCESO Pedidos;
   nSemana = 0; fFecha = #agifa104#1; |HAZ mirasem;
   |SI nSemana < #diaz0018#4; |O nSemana > #diaz0018#10; |ACABA; |FINSI;
   aAlfa = fFecha; |QBF aAlfa; aAlfa = aAlfa % -104; nAnyo = aAlfa;
   |SI nAnyo ! #diaz0018#2; |ACABA; |FINSI;

   #diam0029#1 = #agifa104#7;
   |LEE 000#diam0029.=;
   |SI FSalida = 0;
      |SI #diam0029#0 < #diaz0018#3; |O #diam0029#0 > #diaz0018#9;
         |ACABA;
      |FINSI;
   |SINO;
      |ACABA;
   |FINSI;

   |BUCLE LineasPedidos;

|FPRC;

|DEFBUCLE Pedidos;
#agifa104#1;
;
INICIO;
FINAL;
;
NULL,Pedidos;
|FIN;

|PROCESO LineasAlbaranes;
   |SI #agifa071#2 ] #diaz0018#8; |Y #agifa071#2 [ #diaz0018#14;
      aCodArt = #agifa071#2; |HAZ LeeArticulo;
      #diaw0019#0 = nAnyo;
      #diaw0019#1 = nSemana;
      #diaw0019#2 = #diam0029#0;
      #diaw0019#3 = #agifa071#2;
      |LEE 101#diaw0019.=;
      |SI FSalida ! 0;
         |DDEFECTO #diaw0019;
         #diaw0019#0 = nAnyo;
         #diaw0019#1 = nSemana;
         #diaw0019#2 = #diam0029#0;
         #diaw0019#3 = #agifa071#2;
         #diaw0019#4 = #agifa019#1;
         #diaw0019#5 = #agifa019#126;
         #diaw0019#6 = #agi00063#1;
         #diaw0019#7 = #agifa019#125;
         #diaw0019#8 = #agifa553#1;
         #diaw0019#9 = #diam0028#1;
         #diaw0019#14 = #agifa019#2;
         #diaw0019#15 = #agifa060#1;
         |GRABA 020#diaw0019.b;
      |FINSI;
      |SI #agifa071#12 = 0;
         #diaw0019#11 = #diaw0019#11 + #agifa073#9;
         #diaw0019#12 = #diaw0019#12 + #agifa073#9;
      |SINO;
         #diaw0019#13 = #diaw0019#13 + #agifa073#9;
      |FINSI;
      |GRABA 020#diaw0019.a; |LIBERA #diaw0019;
   |FINSI;
|FPRC;

|DEFBUCLE LineasAlbaranes;
#agifa071#1;
;
#agifa010#52, #agifa010#0, 001;
#agifa010#52, #agifa010#0, 999;
;
NULL,LineasAlbaranes;
|FIN;

|PROCESO Albaranes;
   nSemana = 0; fFecha = #agifa104#1; |HAZ mirasem;
   |SI nSemana < #diaz0018#4; |O nSemana > #diaz0018#10; |ACABA; |FINSI;
   aAlfa = fFecha; |QBF aAlfa; aAlfa = aAlfa % -104; nAnyo = aAlfa;
   |SI nAnyo ! #diaz0018#2; |ACABA; |FINSI;

   #diam0029#1 = #agifa010#6;
   |LEE 000#diam0029.=;
   |SI FSalida = 0;
      |SI #diam0029#0 < #diaz0018#3; |O #diam0029#0 > #diaz0018#9;
         |ACABA;
      |FINSI;
   |SINO;
      |ACABA;
   |FINSI;

   |BUCLE LineasAlbaranes;
|FPRC;

|DEFBUCLE Albaranes;
#agifa010#2;
;
aVacio, fDFecha, "     ", 000000;
aLleno, fHFecha, "zzzzz", 999999;
;
NULL,Albaranes;
|FIN;

|PROCESO Imprime;
|PRINT;
|FPRC;

|DEFBUCLE Imprime;
#diaw0019#1;
;
INICIO;
FINAL;
;
NULL,Imprime;
|FIN;

|PROCESO Impresion;
   aAlfa = "tm" + Usuario; |NOME_DAT #10 aAlfa;
   |DELINDEX #diaw0019; |ABRE #diaw0019;

   |ABRE #agifa019; |ABRE #agi00063; |ABRE #agifa553;
   |ABRE #diam0015; |ABRE #diam0029; |ABRE #diam0031;
   |ABRE #diam0016;
   |SELECT #2#diam0029;

   #diam0015#71 = #diaz0018#2;
   |LEE 000#diam0015.=;
   |SI FSalida ! 0; |DDEFECTO #diam0015; |FINSI;

   aVacio = " " * 60; aLleno = "z" * 60;

   |BUCLE LineasOferta;
   |BUCLE Pedidos;
   nDSemana = #diaz0018#4; nHSemana = #diaz0018#10; |HAZ CalcSemana;
   |BUCLE Albaranes;
   |BUCLE LineasPpto;

   |IMPRE 0;
   |SI FSalida = 0;
      |INFOR "diaz0018";
      |SI FSalida = 0;
         |BUCLE Imprime;
         |PIEINF; |FININF;
      |FINSI;
      |FINIMP;
   |FINSI;

   |CIERRA #diaw0019;   |DELINDEX #diaw0019;
   |SELECT #1#diam0029;
   |CIERRA #diam0016;
   |CIERRA #diam0029; |CIERRA #diam0015; |CIERRA #diam0031;
   |CIERRA #agifa019; |CIERRA #agi00063; |CIERRA #agifa553;
|FPRC;

|PROGRAMA;
   |ABRE #diaz0018;
   |CLS;
   |CABEZA "Informe de ventas";
   |PINPA #0#0; |PINDA #0#0;
   |PARA; |SI FSalida = 0; |HACIENDO;
      nSwNuevo = 0;
      |DDEFECTO #diaz0018;
      |ENCAMPO #0#0;
      |SI FSalida = 0; |O FSalida = 6;
         nInf = #diaz0018#0;
         |LEE 101#diaz0018.=;
         |SI FSalida ! 0;
            |DDEFECTO #diaz0018;
            #diaz0018#0 = nInf;
            |GRABA 020#diaz0018.b;
            nSwNuevo = 1;
         |FINSI;
         |PINPA #0#0; |PINDA #0#0;
         |ENDATOS #1#0;
         |SI FSalida = 0;
            |HAZ Impresion;
            |GRABA 020#diaz0018.a;
         |SINO;
            |SI nSwNuevo = 1; |BORRA 020#diaz0018.a; |FINSI;
         |FINSI;
         |LIBERA #diaz0018; FSalida = 0;
      |FINSI;
   |SIGUE;
   |CIERRA #diaz0018;
|FPRO;

|PROCESO mirasem;
    alfa1 = fFecha; alfa1 = alfa1 % -104;
    alfa1 = "01.01." + alfa1;
    fech1 = alfa1;            || primero saca el dia de la semana
    fech2 = fech1 % 1;        ||/que fue el uno de enero
    alfa1 = fech2 % 11;

|SI alfa1 = "Lunes";     sdia=1; smas=0; |FINSI;
|SI alfa1 = "Martes";    sdia=7; smas=1; |FINSI;
|SI alfa1 = "Miercoles"; sdia=6; smas=1; |FINSI;
|SI alfa1 = "Jueves";    sdia=5; smas=1; |FINSI; ||saca el dia del mes que fue
|SI alfa1 = "Viernes";   sdia=4; smas=1; |FINSI; ||el primer lunes del a¤o
|SI alfa1 = "Sabado";    sdia=3; smas=1; |FINSI;
|SI alfa1 = "Domingo";   sdia=2; smas=1; |FINSI;

    alfa1 = ("00" + sdia) % -102;  || construye el primer lunes del a¤o
    fech1 = fFecha;                ||/como fecha inicial de calculo
    alfa2 = fech1 % -104;
    alfa1 = alfa1 + ".01." + alfa2;
    fech1 = alfa1;
    nume1 = fech1;                 || calcula dias hasta primer lunes a¤o

    fech1 = fFecha;                || calcula dias hasta fecha actual
    nume2 = fech1;

    sdife = nume2 - nume1;         || calcula la diferencia desde el primer
|SI sdife ] 0;
        srest = sdife $ 7;           || lunes hasta la fecha actual,la redondea,
        sdife = sdife + (7 - srest); || la divide por 7 y le suma 1 por la
        nSemana = (sdife / 7) + smas;|| primera semana (en su caso !!!)
|SINO;
        nSemana = 1;
|FINSI;
|FPRC;

|PROCESO CalcSemana;
    fech1 = ~;
    alfa1 = fech1; alfa1 = alfa1 % -104;
    alfa1 = "01.01." + alfa1;
    fech1 = alfa1;            || primero saca el dia de la semana
    fech2 = fech1 % 1;        ||/que fue el uno de enero
    alfa1 = fech2 % 11;

|SI alfa1 = "Lunes";     sdia=1; smas=0; |FINSI;
|SI alfa1 = "Martes";    sdia=7; smas=1; |FINSI;
|SI alfa1 = "Miercoles"; sdia=6; smas=1; |FINSI;
|SI alfa1 = "Jueves";    sdia=5; smas=1; |FINSI; ||saca el dia del mes que fue
|SI alfa1 = "Viernes";   sdia=4; smas=1; |FINSI; ||el primer lunes del a¤o
|SI alfa1 = "Sabado";    sdia=3; smas=1; |FINSI;
|SI alfa1 = "Domingo";   sdia=2; smas=1; |FINSI;

    alfa1 = ("00" + sdia) % -102;  || construye el primer lunes del a¤o
    fech1 = ~;                ||/como fecha inicial de calculo
    alfa2 = fech1 % -104;
    alfa1 = alfa1 + ".01." + alfa2;
    fech1 = alfa1;

    nCalc = nDSemana; nCalc = nCalc * 7;
    nCalc = fech1; nCalc = nCalc + (nDSemana * 7);
    nCalc = nCalc - 7; fDFecha = nCalc;

    nCalc = nHSemana; nCalc = nCalc * 7;
    nCalc = fech1; nCalc = nCalc + (nHSemana * 7);
    fHFecha = nCalc;
|FPRC;
