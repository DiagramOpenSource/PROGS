|FICHEROS;
     vilaz006 #0;
     vilam002 #2;
     vilam004 #4;
     vilam005 #5;
     agifa024 #24;
     agifa025 #25;
     agifa069 #69;
     agifa084 #84;
     vilaw002 #102,MANTE;
     agifa142 #142;

     agifa133 #17;  || vencimientos
     agifa177 #99;  || tipos de recibo
     dsz99984 #11;

     :/dscarter/def/dscam003 #30;
     :/dscarter/def/dscam004 #40;
     :/dscarter/def/dscam045 #45;

     agifa722;
     agifa716;
|FIN;

|VARIABLES;
     &Tempo = "";
     aTmp2 = "";
     nHay = 0;
     aAlfa = "";
     {-1}aMenu = "";
     aMenu1 = "2400";
     aMenu2 = "1";
     aMenu3 = "Opciones:  ";
     aMenu4 = "RAC";
     aMenu5 = " Revisar ";
     aMenu6 = " Aceptar ";
     aMenu7 = " Cancelar ";
     fmes = "";
     mes = 0;
     imneto = 0;
     nImpo = 0;
     nForma = 0;
     nDto = 0;
     &enForma = 0;
     &enCoste = 0;
     &enImpCliCom = 0;
     &enImpCliDto = 0;
     &enImpCliMar = 0;
     &enImpCliFac = 0;
     &enImpRepComi = 0;
     &enImpRepVta = 0;
     &enImpRepRete = 0;
     &eaRepre = "";
     &eaCliente = "";
     &efFecha = @;
     &aDivisa = "";
     &aMoneda = "";
     retencion = 0;
     nEmpCarte = 0;
     aEmp = "";
     aBase = "";
     nEmpresa = 0;
     Modo = "";
     Comodin = "";
     FEstado = "";
     nCalc = 0;
|FIN;

|PROCESO BajaConta;
     |ABRE #agifa722;
     #agifa722#0 = "FD";
     #agifa722#1 = #agifa084#48;
     #agifa722#2 = #agifa084#0;
     #agifa722#11 = 1;
     |LEE 000#agifa722.];
     FEstado = FSalida;
     aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105;
     nCalc = #agifa722#2;
     FSalida = FEstado;
     |PARA; |SI FSalida = 0; |Y #agifa722#0 = "FD"; |Y aAlfa = #agifa084#48; |Y nCalc = #agifa084#0; |HACIENDO;
        |BORRA 020#agifa722.a;
        |LEE 000#agifa722.s;
     |SIGUE;
     |CIERRA #agifa722;


     |SI #agifa084#82 ! 0;
        aAlfa = "ac" + Usuario; |NOME_DAT #agifa716#aAlfa#;
        |DELINDEX #agifa716; |ABRE #agifa716;
        |DDEFECTO #agifa716;
        #agifa716#15 = #agifa084#86; #agifa716#0 = 1;
        #agifa716#13 = "agifa084";    #agifa716#14 = 48;
        #agifa716#11 = "A";
        #agifa716#3 = #agifa084#48; #agifa716#4 = #agifa084#48;
        |GRABA 020#agifa716.n;

        |DDEFECTO #agifa716;
        #agifa716#15 = #agifa084#86; #agifa716#0 = 2;
        #agifa716#13 = "agifa084"; #agifa716#14 = 0;
        #agifa716#11 = "N";
        #agifa716#5 = #agifa084#0; #agifa716#6 = #agifa084#0;
        |GRABA 020#agifa716.n;

        |LIBERA #agifa716;
        |CIERRA #agifa716;
        Modo = ",B";
        Comodin = #agifa084#86; |QBF Comodin;
        Comodin = "agifa711.tab;" + Comodin + Modo;
        |SUB_EJECUTA_NP Comodin;
     |FINSI;
|FPRC;

|PROCESO BajaRecibo;
     |ABRE #30;
     |ABRE #40;
     |SELECT #12#30;
     #30#0 = #84#48;
     #30#1 = #84#0;
     #30#2 = 0;
     #30#4 = "01.01.0000";
     #30#5 = "";
     #30#32 = "";
     |LEE 000#30];
     |PARA; |SI FSalida = 0; |Y #30#0 = #84#48; |Y #30#1 = #84#0; |HACIENDO;
          #40#17 = #30#40;
          #40#0 = 0;
          |LEE 101#40];
          |PARA; |SI FSalida = 0; |Y #40#17 = #30#40; |HACIENDO;
               |BORRA 020#40a;
               |LIBERA #40;
               |LEE 101#40s;
          |SIGUE;
          |BORRA 020#30a;
          |LIBERA #30;
          |LEE 101#30s;
     |SIGUE;
     |CIERRA #40;
     |CIERRA #30;
|FPRC;

|PROCESO CtrlRecibos;
     |SI nEmpCarte ! #45#6;
          nEmpCarte = #45#6;

          aEmp = ("00000" + #45#6) % -105;
          aAlfa = aBase + "dscarter/fich/" + aEmp + "/";
          |PATH_DAT #30#aAlfa#;
          |PATH_DAT #40#aAlfa#;
          |HAZ BajaRecibo;
     |FINSI;
|FPRC;

|DEFBUCLE CtrlRecibos;
     #45#1;
     ;
     nEmpresa, 001;
     nEmpresa, 999;
     ;
     NULL, NULL, NULL, NULL, NULL, CtrlRecibos;
     #45#6;
|FIN;

|PROCESO BorraCobro;
     |DBASS aBase;
     aAlfa = aBase + "dscarter/fich/";
     |PATH_DAT #45 aAlfa;

     |DFICE aAlfa;
     aAlfa = aAlfa % -205;
     nEmpresa = aAlfa;
     nEmpCarte = 0;
     |BUCLE CtrlRecibos;
|FPRC;

|PROCESO BorraRecibo;
     |ABRE #17;
     #17#0 = #84#0;
     #17#4 = #84#48;
     #17#1 = 0;
     |LEE 101#17];
     |SI FSalida = 0; |Y #17#0 = #84#0; |Y #17#4 = #84#48;
          |BORRA 020#17a;
          |LIBERA #17;
          |LEE 101#17s;
     |FINSI;
     |CIERRA #17;
|FPRC;

|PROCESO ActCliRep;
     |ABRE #24;
     #24#0 = #84#3;
     |LEE 121#24=;
     |SI 0 = FSalida;
          fmes = #84#1 % A402;
          mes = fmes - 1;
          mes = mes * 4;
          mes = mes + 54;
          imneto = #84#15 - #84#25;
          |SI #142#115 = "N";
               nImpo = (imneto * 100) / (100 - #84#7);
               nDto = #84#25 + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
               nDto = #84#25;
          |FINSI;
          #24mes = #24mes + (nImpo * nForma);
          mes = mes + 1;
          #24mes = #24mes + (nDto * nForma);
          mes = mes + 1;
          #24mes = #24mes + (#84#37 * nForma);
          #24#102 = #24#102 + (nImpo * nForma);
          #24#103 = #24#103 + (nDto * nForma);
          #24#104 = #24#104 + (#84#37 * nForma);
          mes = FEntrada / 100;
          mes = mes ! 0;
          |SI 1 = mes;
               #24#45 = #84#1;
               #24#46 = imneto;
          |FINSI;
          #24#110 = #24#110 + (imneto * nForma);
          imneto = imneto + #84#24;
          |GRABA 020#24a;
          |LIBERA #24;

          enImpCliCom = nImpo * nForma;
          enImpCliDto = nDto * nForma;
          enImpCliMar = #84#37 * nForma;
          enImpCliFac = imneto * nForma;
          eaCliente = #84#3;
          efFecha = #84#1;
          |HAZ AcumulaCli;
     |FINSI;
     |CIERRA #24;

     |ABRE #25;
     #25#0 = #84#6;
     |LEE 121#25=;
     |SI 0 = FSalida;
           imneto = #84#15 - #84#25;
           fmes = #84#1 % A402;
           mes = fmes - 1;
           mes = mes * 2;
           mes = mes + 11;
           #25mes = #25mes + (#84#26 * nForma);
           retencion = #25mes % #84#39;
           mes = mes + 1;
           #25mes = #25mes + (imneto * nForma);
           #25#35 = #25#35 + (#84#26 * nForma);
           #25#36 = #25#36 + (imneto * nForma);
           mes = fmes - 1;
           mes = mes + 40;
           #25mes = retencion;
           retencion = #25#35 % #25#39;
           #25#52 = retencion;
           |GRABA 020#25a;
           |LIBERA #25;

          enImpRepComi = #84#26 * nForma;
          enImpRepVta = imneto * nForma;
          enImpRepRete = retencion * nForma;
          eaRepre = #84#6;
          efFecha = #84#1;
          |HAZ AcumulaRep;
     |FINSI;
     |CIERRA #25;
|FPRC;

|PROCESO BajaLinFac;
      enForma = -1;
      |HAZ AcumulaFC;
      |BORRA 020#69a;
|FPRC;

|PROCESO Tmp;
     #5#0 = #0#0;
     #5#1 = #0#1;
     #5#2 = #102#5;
     #5#3 = #0#3;
     #5#4 = #102#0;
     #5#5 = #102#1;
     |BORRA 020#5c;
     |SI FSalida = 0;
          #4#0 = #5#0;
          #4#1 = #5#1;
          #4#2 = #5#2;
          #4#3 = #5#3;
          |LEE 101#4=;
          |SI FSalida = 0;
               #4#10 = #4#10 - #5#7;
               #4#11 = #4#9 - #4#10;
               |SI #4#11 = 0;
                    #4#7 = "S";
               |SINO;
                    #4#7 = "P";
               |FINSI;
               |SI #0#3 = 99;
                    |BORRA 020#4a;
               |SINO;
                    |GRABA 020#4a;
               |FINSI;
               |LIBERA #4;
          |FINSI;

          #2#0 = #5#0;
          #2#1 = #5#1;
          |LEE 121#2=;
          |SI FSalida = 0;
               |SI #0#3 = 99;
                    #2#24 = "N";
                    |GRABA 020#2a;
               |FINSI;
               |LIBERA #2;
          |FINSI;

          #84#48 = #5#4;
          #84#0 = #5#5;
          |LEE 121#84=;
          |SI FSalida = 0;
               aDivisa = #84#65;
               aMoneda = #84#67;
               |HAZ Divisas084;

               |BUCLELIN 0BajaLinFac#84;

               nForma = -1;
               |HAZ ActCliRep;

               || borrar cobro/enlace
               aAlfa = ":dscarter/dscaz152.tab;" + #84#48 + (("000000" + #84#0) % -106) + "000" + #84#1;
               aAlfa = aAlfa + (("00000" + #48#0) % -105);
               |SUB_EJECUTA aAlfa;

           |||    |HAZ BorraCobro; ANULADO
               |HAZ BorraRecibo;

               |BORRA 020#84a;

               |HAZ BajaConta;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE Tmp;
     #102#2;
     ;
     "*";
     "*";
     ;
     NULL, Tmp;
|FIN;

|PROCESO AnulaCobro;
     |ABRE #84;
     |ABRE #5;
     |ABRE #4;
     |ABRE #2;
     |BUCLE Tmp;
     |CIERRA #2;
     |CIERRA #4;
     |CIERRA #5;
     |CIERRA #84;
|FPRC;

|PROCESO Tecla; |TIPO 0;
     |SI #102Campo = Contenido; |Y FSalida = 0;
          |SI #0#3 = 0; |O #0#3 = 99;
               |MENAV "0000No se puede seleccionar, se anulan todos o ninguno.";
               |ERROR; |ACABA;
          |FINSI;
          |SI #102#4 = "*";
               #102#4 = "";
          |SINO;
               #102#4 = "*";
          |FINSI;
          |GRABA 020#102a;
          |PINTA #102#4;
     |FINSI;
|FPRC;

|PROCESO Facturas;
     nHay = 1;

     |DDEFECTO #84;
     #84#48 = #5#4;
     #84#0 = #5#5;
     |LEE 000#84=;

     #102#0 = #5#4;
     #102#1 = #5#5;
     #102#2 = #5#6;
     #102#3 = #5#7;
     #102#5 = #5#2;
     |SI #0#3 = 0; |O #0#3 = 99;
          #102#4 = "*";
     |FINSI;
     |GRABA 020#102n;
|FPRC;

|DEFBUCLE Facturas;
     #5#1;
     ;
     #0#0, #0#1, "      ", #0#3, "     ", 000001;
     #0#0, #0#1, "zzzzzz", #0#3, "zzzzz", 999999;
     ;
     NULL, Facturas;
|FIN;

|PROCESO Min;
     #102#0 = "     ";
     #102#1 = 1;
|FPRC;

|PROCESO Max;
     #102#0 = "zzzzz";
     #102#1 = 999999;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     |HAZ CreaTempo; |NOME_DAT #102 Tempo; aTmp2 = Tempo; |DELINDEX #102;
     |ABRE #102;
     |ABRE #84;
     |BUCLE Facturas;
     |CIERRA #84;
     |CIERRA #102;
     |SI nHay = 0;
          |MENAV "0000No hay registros...";
     |SINO;
          |PINPA #0#102;
          |ATRI I;
          |SI #0#3 = 0; |PINTA 1218, "Factura 1§ pago"; |FINSI;
          |SI #0#3 = 99;|PINTA 1218, "Factura final"; |FINSI;
          |SI #0#3 > 0; |Y #0#3 < 99; |PINTA 1218, "Factura prevencimiento"; |FINSI;
          |ATRI 0;
          |PARA; |SI; |HACIENDO;
               |ENTLINEAL #1#102, 1, 4, 22, 0, Min, Max;
               |MENU aMenu;
               |SI FSalida ! 1;
                    |SI FSalida = 2; |HAZ AnulaCobro; |FINSI;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;

     Tempo = aTmp2; |HAZ BoraTempo; |DELINDEX #102;
|FPRC;
