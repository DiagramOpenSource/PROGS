|FICHEROS;
  vigz0100 #0;

  camaasl@ #1;  ||camaasil
  camaniv@ #2;  ||caivarep - camaniva
  caivali@ #3;  ||caivasop - caivalin
  camaasc@ #4;  ||camaasic
  calibro@ #5;  ||calibros
  caconas@ #6;  ||caconasi
  caivaas@ #7;  ||caivaasi
  cacuv2c@ #8;  ||cacuiv2c
  cacuv2l@ #9;  ||cacuiv2l
  canempr@ #30; || empresa

  dsmom30@ #10; ||conceptos

  agifa142 #142;
|FIN;

|VARIABLES;
     aLon = "";
     nPos = 0;
     aHabitual = "";
     aFactura = "";
     aDesIva = "";
     nRegRep = 0;
     cuentarep= "";
     path     = "";
     empresa  = "";
     cadena   = "";
     fichero  = "";
     long     = "";
     caracter = "";
     campo    = "";
     campo1   = "";
     variable = "";
     clave    = "";
     cuenta   = "";
     sufijo   = "";
     signo    = "";
     impor    = "";
     impore   = 0;
     comen    = "";
     fecha    = "";
     claveiva = "";
     asiento  = 0;
     linea    = 0;
     i        = 0;
     f        = 0;
     g        = "C";
     f1       = 0;
     f2       = 0;
     f3       = 0;
     ind      = 0;
     valor    = 0;
     sw       = 0;
     pasa     = 0;
     jj       = 0;
     sal      = 0;
     guarda   = 0;
     nombre   = "";
     nombre1  = "";
     mes      = "";
     mes1     = 0;
     cuentasuf  = "";
     asientosuf = "";
     comensuf   = "";
     fechasuf   = "";
     final      = "";
     base1      = 0;
     base2      = 0;
     base3      = 0;
     iva1       = 0;
     iva2       = 0;
     iva3       = 0;
     cuota1     = 0;
     cuota2     = 0;
     cuota3     = 0;
     factura    = "";
     registro   = 0;
     barra      = "/";
     contado    = "";
     comision   = "";
     nFactor = 1;

     aDef1      = "";
     aDef2      = "";
     aDef3      = "";
     aDef4      = "";
     aDef5      = "";
     aDef6      = "";
     aDef7      = "";
     aDef8      = "";
     aDef9      = "";
     aDef10     = "";
     aDef30     = "";
     nError     = 0;
     aPath      = "";
     aPathFich  = "";
     aPathFichE = "";
     aPathFichM = "";
     aPathModelo = "";
     nDEmp      = 0;
     nHEmp      = 0;
     nInkey     = 0;

    aAlfa  = "";
    aAlfa1 = "";
    aAlfa2 = "";
    nNume1 = 0;
    nNume2 = 0;
    nNume3 = 0;
    aMensa = "";
    nEjercicio = 0;
    aContra = "";
    base = 0;
    iva = 0;
    cuota = 0;
    nLinIVA = 0;
    nDLibro = 0;
    nHLibro = 0;
    &sw_conase4 = 0;
    aEmpresa = "";
|FIN;

|| ************************************************************************
|PROCESO CargaConta; |TIPO 8;
  |ABRE #142;
  |LEE 000#142p;
  |CIERRA #142;

  nError = 0;
  aPath = #142#151; |QBF aPath;
  |SI aPath ! "";
      aAlfa = aPath % -101;
      |SI aAlfa ! "/"; |Y aAlfa ! "\"; aPath = aPath + "/"; |FINSI;
      aDef30 = aPath + "def/canempre";
      |CARGA_DEF aDef30, canempr@;
      |SI FSalida ! 0;
          nError = 1; aDef30 = "";
      |FINSI;
  |FINSI;
  |SI nError = 1; |O aPath = "";
      nError = 0;
      |DBASE aPath;
      aPath = aPath + "contagen/";
      aDef30 = aPath + "def/canempre";
      |CARGA_DEF aDef30, canempr@;
      |SI FSalida ! 0;
          nError = 1; aDef30 = "";
      |FINSI;
  |FINSI;

  |SI nError = 1;
      aMensa =  "    ERROR, NO ENCUENTRO LA CONTABILIDAD ... ";
  |SINO;
      aPathModelo = aPath - "contagen/";
      aPathModelo = aPathModelo + "modelos/";
      aDef1 = aPath + "def/camaasil";
      |CARGA_DEF aDef1, camaasl@;
      |SI FSalida ! 0;
          aMensa = "    Error cargando Camaasil";
          aDef1  = ""; nError = 1;
      |SINO;
          aDef2 = aPath + "def/camaniva";
          |CARGA_DEF aDef2, camaniv@;
          |SI FSalida ! 0;
              aMensa = "    Error cargando Camaniva";
              aDef2  = ""; nError = 1;
          |SINO;
              aDef3 = aPath + "def/caivalin";
              |CARGA_DEF aDef3, caivali@;
              |SI FSalida ! 0;
                  aMensa = "    Error cargando Caivalin";
                  aDef3 = ""; nError = 1;
              |SINO;
                  aDef4 = aPath + "def/camaasic";
                  |CARGA_DEF aDef4, camaasc@;
                  |SI FSalida ! 0;
                      aMensa = "    Error cargando Camaasic";
                      aDef4 = ""; nError = 1;
                  |SINO;
                      aDef5 = aPath + "def/calibros";
                      |CARGA_DEF aDef5, calibro@;
                      |SI FSalida ! 0;
                          aMensa = "    Error cargando Calibros";
                          aDef5 = ""; nError = 1;
                      |SINO;
                          aDef6 = aPath + "def/caconasi";
                          |CARGA_DEF aDef6, caconas@;
                          |SI FSalida ! 0;
                              aMensa = "    Error cargando caconasi";
                              aDef6 = ""; nError = 1;
                          |SINO;
                              aDef7 = aPath + "def/caivaasi";
                              |CARGA_DEF aDef7, caivaas@;
                              |SI FSalida ! 0;
                                  aMensa = "    Error cargando caivaasi";
                                  aDef7 = ""; nError = 1;
                              |SINO;
                                  aDef8 = aPath + "def/cacuiv2c";
                                  |CARGA_DEF aDef8, cacuv2c@;
                                  |SI FSalida ! 0;
                                      aMensa = "    Error cargando cacuiv2c";
                                      aDef8 = ""; nError = 1;
                                  |SINO;
                                      aDef9 = aPath + "def/cacuiv2l";
                                      |CARGA_DEF aDef9, cacuv2l@;
                                      |SI FSalida ! 0;
                                          aMensa = "    Error cargando cacuiv2l";
                                          aDef9 = ""; nError = 1;
                                      |SINO;
                                           aDef10 = aPathModelo + "def/dsmom030";
                                           |CARGA_DEF aDef10, dsmom30@;
                                            |SI FSalida ! 0;
                                                aMensa = "    Error cargando dsmom030";
                                                aDef10 = ""; nError = 1;
                                            |FINSI;
                                      |FINSI;
                                  |FINSI;
                              |FINSI;
                          |FINSI;
                      |FINSI;
                  |FINSI;
              |FINSI;
          |FINSI;
      |FINSI;
  |FINSI;

  |SI nError = 1;
      |MENAV aMensa;
      |PTEC 807;
  |SINO;
      aPathFich  = aPath + "fich/";
      aPathFichM = aPathModelo + "fich/";

      |PATH_DAT #30 aPathFich;
      |PATH_DAT #10 aPathFichM;
  |FINSI;
|FPRC;

|PROCESO DescargaConta; |TIPO 9;
 |SI aDef10 ! ""; |DESCARGA_DEF #dsmom30@; aDef10 = ""; |FINSI;
 |SI aDef9  ! ""; |DESCARGA_DEF #cacuv2l@; aDef9  = ""; |FINSI;
 |SI aDef8  ! ""; |DESCARGA_DEF #cacuv2c@; aDef8  = ""; |FINSI;
 |SI aDef7  ! ""; |DESCARGA_DEF #caivaas@; aDef7  = ""; |FINSI;
 |SI aDef6  ! ""; |DESCARGA_DEF #caconas@; aDef6  = ""; |FINSI;
 |SI aDef5  ! ""; |DESCARGA_DEF #calibro@; aDef5  = ""; |FINSI;
 |SI aDef4  ! ""; |DESCARGA_DEF #camaasc@; aDef4  = ""; |FINSI;
 |SI aDef3  ! ""; |DESCARGA_DEF #caivali@; aDef3  = ""; |FINSI;
 |SI aDef2  ! ""; |DESCARGA_DEF #camaniv@; aDef2  = ""; |FINSI;
 |SI aDef1  ! ""; |DESCARGA_DEF #camaasl@; aDef1  = ""; |FINSI;
 |SI aDef30 ! ""; |DESCARGA_DEF #canempr@; aDef30 = ""; |FINSI;
|FPRC;

|PROCESO LosPath;
  aAlfa1 = #0#4; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
  aAlfa2 = #0#5; |QBF aAlfa2; aAlfa2 = ("0" + aAlfa2) % -101;
  aPathFichE = aPathFich + aAlfa1 + aAlfa2 + "/";
  aEmpresa = aAlfa1 + aAlfa2;

  |PATH_DAT #1 aPathFichE;
  |PATH_DAT #2 aPathFichE;
  |PATH_DAT #3 aPathFichE;
  |PATH_DAT #4 aPathFichE;
  |PATH_DAT #5 aPathFichE;
  |PATH_DAT #6 aPathFichE;
  |PATH_DAT #7 aPathFichE;
  |PATH_DAT #8 aPathFichE;
  |PATH_DAT #9 aPathFichE;
|FPRC;

|| ///////////////////////////////
|RUTINA infA2;
   #30#2 = nDEmp;
   #30#3 = 0;
|FRUT;

|RUTINA supA2;
   #30#2 = nHEmp;
   #30#3 = 9;
|FRUT;

|CALCULO LeeEmpresa; |TIPO 0;
  nInkey = FSalida;

  |SI nInkey = 10;
     nDEmp = 0; nHEmp = 99999;
     |ABRE #30;
     |CONSULTA_F_CLAVE #1#30,infA2,supA2;
     #0#4 = #30#2; |PINTA #0#4;
     #0#5 = #30#3; |PINTA #0#5;
     |CIERRA #30;
     |PTEC 802;
     |ACABA;
  |FINSI;

  |ABRE #30;
  #30#2 = #0#4;
  #30#3 = 0;
  |LEE 011#30];
  |SI FSalida ! 0;  |O #30#2 ! #0#4;
      |MENAV "     NO Existe la empresa Contable";
      |ERROR;
  |SINO;
      #0#17 = #30#1;  |PINTA #0#17;
      #0#18 = #30#26; |PINTA #0#18;
  |FINSI;
  |CIERRA #30;
|FCAL;

|CALCULO LeeEmpresaP; |TIPO 0;
  nInkey = FSalida;
  |SI nInkey = 2; |ACABA; |FINSI;

  |SI nInkey = 10;
      nDEmp = #0#4; nHEmp = #0#4;
      |ABRE #30;
      |CONSULTA_F_CLAVE #1#30,infA2,supA2;
      #0#5 = #30#3; |PINTA #0#5;
      |CIERRA #30;
  |FINSI;

  |ABRE #30;
  #30#2 = #0#4;
  #30#3 = #0#5;
  |LEE 011#30=;
  |SI FSalida ! 0;
      |MENAV "     NO Existe Periodo en la Empresa Contable";
      |ERROR;
      |CIERRA #30;
      |ACABA;
  |SINO;
      #0#17   = #30#1;  |PINTA #0#17;
      #0#18   = #30#26; |PINTA #0#18;
  |FINSI;
  |CIERRA #30;

  |HAZ LosPath;

  |ABRE #7;
  |DDEFECTO #7;
  |LEE 000#7p;
  #0#6 = #7#3;  #0#19 = #7#5; #0#21 = #7#5;
  #0#7 = #7#29; #0#20 = #7#31;
  |PINTA #0#6; |PINTA #0#19; |PINTA #0#21;
  |PINTA #0#7; |PINTA #0#20;
|FCAL;


|CALCULO contasi;
  |HAZ LosPath;

  |ABRE #6;
  |DDEFECTO #6;
  |LEE 000#6p;
  |SI FSalida ! 0;
      |DDEFECTO #6;
      |GRABA 020#6n;
  |FINSI;
  |CIERRA #6;
  asiento = #6#1;
  #0#9    = #6#1; |PINTA #0#9;
|FCAL;

|CALCULO LeeConcepto;

  nError = 0;
  |ABRE #10;
  #10#0 = #0Campo;
  |LEE 001#10=;
  |SI FSalida ! 0;
      aAlfa1 = "    Error. No existe Concepto Contable";
      nError = 1;
  |FINSI;
  |SI nError = 1;
      |MENAV aAlfa1;
      |ERROR;
  |FINSI;
|FCAL;


|CALCULO Libro;
  |HAZ LosPath;

  nNume1 = 8; nNume2 = 12;
  |SI Campo = 6; nNume1 = 16; nNume2 = 11; |FINSI;
  |C_M #0nNume1, 1, "S"; |C_M #0nNume2, 1, "S"; |SI Campo = 6; |C_M #0#13, 1, "S"; |FINSI;
  |SI #0Campo = 0;
      |C_M #0nNume1, 1, "N";
      |C_M #0nNume2, 1, "N";
      #0nNume1 = 0;   |PINTA #0nNume1;
      #0nNume2 = "N"; |PINTA #0nNume2;
      |SI Campo = 6;
          |C_M #0#13, 1, "N";
          #0#13 = "N"; |PINTA #0#13;
     |FINSI;
     |ACABA;
  |FINSI;
  |ABRE #5;
  |DDEFECTO #5;
  #5#0 = #0Campo;
  |LEE 001#5=;
  |SI FSalida ! 0;
      |CONFI "    NNo existe Libro. Continuar S/N";
      |SI FSalida = 0;
          #5#0 = #0Campo;
          |SI Campo = 6;
              #5#1 = "LIBRO DE IVA REPERCUTIDO";
              #5#2 = "R";
              #5#3 = 1;
          |SINO;
              #5#1 = "LIBRO DE IVA SOPORTADO";
              #5#2 = "S";
              #5#3 = 10;
          |FINSI;
          #5#4 = 1;
          |GRABA 020#5n;
      |SINO;
          |CIERRA #5;
          |ERROR;
          |ACABA;
      |FINSI;
  |FINSI;
  |CIERRA #5;

  |SI Campo = 6; |Y #5#2 = "S";
      |MENAV "    Error. Este libro es de IVA Soportado";
      |ERROR;
  |FINSI;
  |SI Campo = 7; |Y #5#2 = "R";
      |MENAV "    Error. Este libro es de IVA Repercutido";
      |ERROR;
  |FINSI;
|FCAL;

|CALCULO contiva;|TIPO 7;
     |SI #0#7 = 0; |ACABA; |FINSI;
     |ABRE #5;
     |DDEFECTO #5;
     #5#0 = #0#7;
     |LEE 000#5=;
     |CIERRA #5;
     #0#8 = #5#4;
     |PINTA #0#8;
|FCAL;

|CALCULO ContRep;|TIPO 7;
     |SI #0#6 = 0; |ACABA; |FINSI;
     |ABRE #5;
     |DDEFECTO #5;
     #5#0 = #0#6;
     |LEE 000#5=;
     |CIERRA #5;
     #0#16 = #5#4;
     |PINTA #0#16;
|FCAL;


|| *********************************************************************
|| *********************************************************************
|CALCULO graba_tmp;

 |ABRE #1;
 |DDEFECTO #1;
 linea = linea + 1;
 #1#0 = #0#2;
 #1#1 = fecha;
 #1#2 = asiento;
 #1#3 = linea;
 #1#4 = cuenta;
 |LEE 101#1=;
 |SI FSalida ! 0;
    |DDEFECTO #1;
    #1#0 = #0#2;
    #1#1 = fecha;
    #1#2 = asiento;
    #1#3 = linea;
    #1#4 = cuenta;
    |GRABA 021#1b;
 |FINSI;
 #1#5 = 5;


 ||ARA40
 ||El concepto que le corresponda.
 ||No tengo claro si estoy en una compra o una venta
 #1#6 = 001;


 #1#7 = comen;
 #1#8 = signo;
 #1#9 = impore;
 |SI signo = "H";
     #1#10 = cuenta;
     #1#11 = 5;
     #1#16 = "            ";
     #1#17 = 0;
 |SINO;
    #1#16 = cuenta;
    #1#17 = 5;
    #1#10 = "            ";
    #1#11 = 0;
 |FINSI;
 |GRABA 021#1a;
 |LIBERA #1;
 |CIERRA #1;
|FCAL;

/*
|| *************************************************
|PROCESO BuscaTipoIva;
   |SI #9#2 = #3#7; |Y #9#4 = #3#9;
       #3#16 = #9#1;
       |SI #8#2 = "S";
           #3#13 = #9#3;
       |SINO;
           #3#13 = #8#6;
       |FINSI;
       |ERROR10;
   |FINSI;
|FPRC;

|DEFBUCLE BuscaTipoIva;
 #9#1003;
 ;
 #2#36,nEjercicio,01;
 #2#36,nEjercicio,99;
 ;
 NULL,BuscaTipoIva;
|FIN;
*/

|| *************************************************
|PROCESO BuscaTipoIva;
   |SI #9#2 = #3#7; |Y #9#4 = #3#9;
       #3#16 = #9#1;
       |SI #8#2 = "S";
           #3#13 = #9#3;
       |SINO;
           #3#13 = #8#6;
       |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE BuscaTipoIva;
 #9#1004;
 ;
 #2#36,nEjercicio,"01.01.2000", 01;
 #2#36,nEjercicio,fechasuf,     99;
 ;
 NULL,BuscaTipoIva;
|FIN;


|PROCESO BuscaContra;
 |ABRE #10;
 |DDEFECTO #10;
 #10#0 = #3#3;
 |LEE 001#10=;
 |CIERRA #10;
 nNume1 = 20; nNume2 = 22; |SI #2#36 = "S"; nNume1 = 22; nNume2 = 23; |FINSI;
 aContra = #10nNume1; |QBF aContra;
 |SI aContra = "";
     aContra = #0nNume2;
 |FINSI;
 #3#12 = aContra;


 |ABRE #8;
 |DDEFECTO #8;
 #8#0 = #2#36;
 #8#20 = nEjercicio;
 |LEE 001#8=;
 |CIERRA #8;

 |BUCLE BuscaTipoIva;
|FPRC;

|PROCESO GraboLinea;
     |ABRE #3;
     |DDEFECTO #3;
     #3#0 = #2#0;
     #3#1 = #2#1;
     #3#2 = nLinIVA;
     #3#3 = #2#27;
     #3#4 = #2#28;
     #3#6 = base;
     #3#7 = iva;
     #3#8 = cuota;
     |HAZ BuscaContra;

     |GRABA 020#3n;
     |LIBERA #3;
     |CIERRA #3;
     nLinIVA = nLinIVA + 1;

     #2#19 = #2#19 + #3#6;
     #2#15 = #2#15 + #3#6;
     #2#17 = #2#15 %  #2#16;
     #2#20 = #2#20 + #3#22;
     #2#23 = #2#23 + (#3#8 + #3#10);
     #2#26 = #2#26 + #3#11;
     #2#21 = #2#19 + #2#23 - #2#20;
     ||#2#9 = -1;
     #2#9 = asiento;
     #2#8 = #2#4;
|FPRC;
||  ************************************************

|CALCULO ivarep;
     nLinIVA = 1;

     ||factura = cadena % 606; ||fra

     factura = nRegRep;
     cuentasuf = cadena % 2506;
     aLon = #0#15; |QBF aLon;
     aLon = aLon % A0;
     nPos = aLon - 8;
     |SI nPos > 0;
          cuentasuf = "43" + ("0"*nPos) + cuentasuf;
     |SINO;
          cuentasuf = "43" + cuentasuf;
     |FINSI;

  |ABRE #2;
  |DDEFECTO #2;
  #2#0 = #0#6;
  #2#1 = factura;
  |LEE 101#2=;
  |SI FSalida ! 0;
     |DDEFECTO #2;
     #2#0 = #0#6;
     #2#1 = factura;
     |GRABA 020#2b;
  |FINSI;
  #2#2 = "";
  #2#3 = factura;
  #2#4 = fechasuf;
                  || ....> 7, 8, 9,
  #2#12 = cuentasuf;
  aAlfa1 = cadena % 4536; #2#13 = aAlfa1;   || Nombre
  aAlfa1 = cadena % 3609; #2#14 = aAlfa1;   || NIF

  #2#27 = #0#19;
  #2#28 = aDesIva;
  #2#29 = #2#27;
  #2#30 = #2#28;

  #2#36 = "R";  ||tipo repercutido

  mes   = fechasuf % 402;
  #2#5 = mes;
  |SI #2#5 > 9;
      #2#5 = 4;
  |SINO;
     |SI #2#5 > 6;
         #2#5 = 3;
     |SINO;
         |SI #2#5 > 3;
             #2#5  = 2;
         |SINO;
             #2#5 = 1;
         |FINSI;
     |FINSI;
  |FINSI;

  #2#15 = 0;
  #2#17 = 0;
  #2#19 = 0;
  #2#20 = 0;
  #2#21 = 0;
  #2#23 = 0;
  #2#26 = 0;

|| Proceso de lineas

   aAlfa1 = cadena % 15408;                     ||base 1;
   base1 = aAlfa1;
   base1 = (base1 / nFactor) ! 2;
   aAlfa1 = cadena % 16205;
     iva1 = aAlfa1;
   aAlfa1 = cadena % 16908;
   cuota1 = aAlfa1;                        ||Cuota 1;
   cuota1 = (cuota1 / nFactor) ! 2;


   aAlfa1 = cadena % 17908;                     ||base 2
   base2  = aAlfa1;
   base2  = (base2 / nFactor) ! 2;
   aAlfa1 = cadena % 18705;                      ||Iva% 2;
     iva2 = aAlfa1;
   aAlfa1 = cadena % 19408;                    ||Cuota 2;
   cuota2 = aAlfa1;
   cuota2 = (cuota2 / nFactor) ! 2;

   aAlfa1 = cadena % 20408;                     ||base 3
   base3  = aAlfa1;
   base3  = (base3 / nFactor) ! 2;
   aAlfa1 = cadena % 21205;                      ||Iva% 3;
     iva3 = aAlfa1;
   aAlfa1 = cadena % 21908;                    ||Cuota 3;
   cuota3 = aAlfa1;
   cuota3 = (cuota3 / nFactor) ! 2;

   |SI base1 ! 0;
       base = base1;
       iva  = iva1;
       cuota = cuota1;
       |HAZ GraboLinea;
   |FINSI;
   |SI base2 ! 0;
       base = base2;
       iva  = iva2;
       cuota = cuota2;
       |HAZ GraboLinea;
   |FINSI;
   |SI base3 ! 0;
       base = base3;
       iva  = iva3;
       cuota = cuota3;
       |HAZ GraboLinea;
   |FINSI;

  |GRABA 020#2a;
  |LIBERA #2;
  |CIERRA #2;
  cuentasuf  = "";
  fechasuf   = "";
  asientosuf = "";
  comensuf   = "";
|FCAL;

|CALCULO ivarepcon;

     |ABRE #2;
     #2#0 = #0#6;
||     factura = cadena % 606; ||fra
     factura = nRegRep;
     fecha   = cadena % 1802;
     fecha   = fecha + "." + (cadena % 1602);
     fecha   = fecha + "." + (cadena % 1204);

     #2#1 = factura;         ||fra
     |LEE 101#2=;
     |SI FSalida ! 0;
         |DDEFECTO #2;
         #2#0 = #0#6;
         #2#1 = factura;     ||fra
         |GRABA 020#2b;
     |FINSI;

     #2#2 = "";
     #2#3 = #2#1;
     #2#4 = fecha;
                  || ....> 7, 8, 9,
     #2#12 = #0#15;
     aAlfa1 = cadena % 4536; #2#13 = aAlfa1;
     aAlfa1 = cadena % 3609; #2#14 = aAlfa1;

    #2#27 = #0#21;
    #2#28 = aDesIva;
    #2#29 = #2#27;
    #2#30 = #2#28;
    #2#36 = "R";  ||tipo soportado

    mes   = fecha % 402;
    #2#5 = mes;
    |SI #2#5 > 9;
        #2#5 = 4;
    |SINO;
        |SI #2#5 > 6;
           #2#5 = 3;
        |SINO;
           |SI #2#5 > 3;
               #2#5  = 2;
           |SINO;
               #2#5 = 1;
           |FINSI;
       |FINSI;
    |FINSI;

    #2#15 = 0;
    #2#17 = 0;
    #2#19 = 0;
    #2#20 = 0;
    #2#21 = 0;
    #2#23 = 0;
    #2#26 = 0;

|| Proceso de lineas
 nLinIVA = 1;

     aAlfa1 = cadena % 15408;                     ||base 1;
     base1  = aAlfa1;
     base1  = (base1 / nFactor) ! 2;
     aAlfa1 = cadena % 16205;                      ||Iva% 1;
       iva1 = aAlfa1;
     aAlfa1 = cadena % 16908;                    ||Cuota 1;
     cuota1 = aAlfa1;
     cuota1 = (cuota1 / nFactor) ! 2;

     aAlfa1 = cadena % 17908;                     ||base 2
     base2  = aAlfa1;
     base2  = (base2 / nFactor) ! 2;
     aAlfa1 = cadena % 18705;                      ||Iva% 2;
       iva2 = aAlfa1;
     aAlfa1 = cadena % 19408;                    ||Cuota 2;
     cuota2 = aAlfa1;
     cuota2 = (cuota2 / nFactor) ! 2;

     aAlfa1 = cadena % 20408;                     ||base 3
     base3  = aAlfa1;
     base3  = (base3 / nFactor) ! 2;
     aAlfa1 = cadena % 21205;                      ||Iva% 3;
       iva3 = aAlfa1;
     aAlfa1 = cadena % 21908;                    ||Cuota 3;
     cuota3 = aAlfa1;
     cuota3 = (cuota3 / nFactor) ! 2;

   |SI base1 ! 0;
       base = base1;
       iva  = iva1;
       cuota = cuota1;
       |HAZ GraboLinea;
   |FINSI;
   |SI base2 ! 0;
       base = base2;
       iva  = iva2;
       cuota = cuota2;
       |HAZ GraboLinea;
   |FINSI;
   |SI base3 ! 0;
       base = base3;
       iva  = iva3;
       cuota = cuota3;
       |HAZ GraboLinea;
   |FINSI;

   |GRABA 000#2a;
   |LIBERA #2;
   |CIERRA #2;
   cuentasuf  = "";
   fechasuf   = "";
   asientosuf = "";
   comensuf   = "";
|FCAL;


|CALCULO ivasop;

 |ABRE #2;
 |DDEFECTO #2;
 #2#0 = #0#7;
 #2#1 = registro;         ||Registro Iva
 |LEE 001#2=;
 |SI FSalida ! 0;
     |DDEFECTO #2;
     #2#0 = #0#7;
     #2#1 = registro;
     |GRABA 020#2b;
 |FINSI;
 #2#2 = "";
 #2#3 = registro;
 #2#4 = fechasuf;
                  || ....> 7, 8, 9,
 #2#12 = cuentasuf;

 aAlfa1 = cadena % 4336; #2#13 = aAlfa1; || Nombre
 aAlfa1 = cadena % 3409; #2#14 = aAlfa1; || NIF

 #2#27 = #0#20;
 #2#28 = comensuf;
 #2#29 = #0#20;
 #2#30 = comensuf;

 #2#36 = "S";  ||tipo soportado

 mes   = fechasuf % 402;
 #2#5 = mes;
 |SI #2#5 > 9;
     #2#5 = 4;
 |SINO;
    |SI #2#5 > 6;
        #2#5 = 3;
    |SINO;
        |SI #2#5 > 3;
            #2#5  = 2;
        |SINO;
            #2#5 = 1;
        |FINSI;
    |FINSI;
 |FINSI;

 #2#15 = 0;
 #2#17 = 0;
 #2#19 = 0;
 #2#20 = 0;
 #2#21 = 0;
 #2#23 = 0;
 #2#26 = 0;

|| Proceso de lineas
 nLinIVA = 1;

 aAlfa1 = cadena % 15408;                     ||base 1;
 base1  = aAlfa1;
 base1  = (base1 / nFactor) ! 2;
 aAlfa1 = cadena % 16205;                      ||Iva% 1;
   iva1 = aAlfa1;
 aAlfa1 = cadena % 16908;                    ||Cuota 1;
 cuota1 = aAlfa1;
 cuota1 = (cuota1/ nFactor) ! 2;

 aAlfa1 = cadena % 18908;                     ||base 2
 base2  = aAlfa1;
 base2  = (base2 / nFactor) ! 2;
 aAlfa1 = cadena % 19705;                      ||Iva% 2;
   iva2 = aAlfa1;
 aAlfa1 = cadena % 20408;                    ||Cuota 2;
 cuota2 = aAlfa1;
 cuota2 = (cuota2 / nFactor) ! 2;

 aAlfa1 = cadena % 22408;                     ||base 3
 base3  = aAlfa1;
 base3  = (base3 / nFactor) ! 2;
 aAlfa1 = cadena % 23205;                      ||Iva% 3;
   iva3 = aAlfa1;
 aAlfa1 = cadena % 23908;                    ||Cuota 3;
 cuota3 = aAlfa1;
 cuota3 = (cuota3 / nFactor) ! 2;

 |SI base1 ! 0;
     base = base1;
     iva  = iva1;
     cuota = cuota1;
     |HAZ GraboLinea;
 |FINSI;
 |SI base2 ! 0;
     base = base2;
     iva  = iva2;
     cuota = cuota2;
     |HAZ GraboLinea;
 |FINSI;
 |SI base3 ! 0;
     base = base3;
     iva  = iva3;
     cuota = cuota3;
     |HAZ GraboLinea;
 |FINSI;

 |GRABA 020#2a;
 |LIBERA #2;
 |CIERRA #2;
 registro = registro + 1;
|FCAL;

||... Contadores
|CALCULO gracontiva;
 |ABRE #5;
 #5#0 = #0#7;
 |LEE 101#5=;
 |SI FSalida = 0;
     #5#4 = registro;
     |GRABA 020#5a;
 |FINSI;
 |LIBERA #5;
 |CIERRA #5;
 registro = #5#4;
|FCAL;

|CALCULO GraRepercutido;
     |ABRE #5;
     #5#0 = #0#6;
     |LEE 101#5=;
     |SI FSalida = 0;
         #5#4 = nRegRep;
         |GRABA 020#5a;
     |FINSI;
     |LIBERA #5;
     |CIERRA #5;
|FCAL;

|CALCULO gracontasi;
 |ABRE #6;
 |LEE 101#6p;
 |SI FSalida = 0;
     #6#1 = asiento;
     |GRABA 020#6a;
 |SINO;
     |DDEFECTO #6;
     #6#1 = asiento;
     |GRABA 020#6n;
 |FINSI;
 |LIBERA #6;
 |CIERRA #6;
 asiento = #6#1;
 asiento = asiento + 1;
|FCAL;

|| **********************************************************************
|PROCESO BorroLinea;
 |BORRA 020#3a;
 |LIBERA #3;
|FPRC;

|DEFBUCLE BorroLinea;
 #3#1003;
 ;
 nDLibro, 0000000001, 01;
 nHLibro, 9999999999, 99;
 be;
 NULL, BorroLinea;
|FIN;

|PROCESO BorroIVA;
 |BORRA 020#2a;
 |LIBERA #2;
|FPRC;

|DEFBUCLE BorroIVA;
 #2#1002;
 ;
 nDLibro, 0000000001;
 nHLibro, 9999999999;
 be;
 NULL, BorroIVA;
|FIN;

|CALCULO vigz0100;|TIPO 3;

    registro = #0#8;
    nRegRep  = #0#16;
    |SI #0#3 ! "SI"; |ACABA; |FINSI;

    |SI #0#18 < 80;
        nEjercicio = 2000 + #0#18;
    |SINO;
        nEjercicio = 1900 + #0#18;
    |FINSI;
    |HAZ LosPath;

/*
    |SI #0#10 = "S"; |DELINDEX #1; |FINSI;
    |SI #0#11 = "S"; |Y #0#13 = "S"; |Y #0#12 = "S";
        |DELINDEX #2;
        |DELINDEX #3;
    |SINO;
        |SI #0#6 ! 0;
            nDLibro = #0#6; nHLibro = #0#6;
            |BUCLE BorroIVA;
            |BUCLE BorroLinea;
        |FINSI;
        |SI #0#7 ! 0;
            nDLibro = #0#7; nHLibro = #0#7;
            |BUCLE BorroIVA;
            |BUCLE BorroLinea;
        |FINSI;
    |FINSI;
*/
    empresa = #0#0;
    |QBF empresa;
    empresa = empresa + #0#1;
    |QBF empresa;
    fichero = empresa;
    |QBF fichero;


    ||  .. . .. ... |XABRE g,fichero,f;
    |XABRE "U", fichero,f;
    |SI FSalida < 0;
        |XABRE "CU", fichero, f;
    |FINSI;
    sal = FSalida;
    |SI FSalida ] 0;
        |PARA jj = 1; |SI sal ] 0; |HACIENDO jj = jj + 1;
              |XLEE f,254,cadena;
              sal = FSalida;
              |SI FSalida > 1;
                  |PINTA 2004,"                                                                       ";
                  campo = cadena % 155;
                  |PINTA 2004,campo;
                  clave = cadena % 101;
                  campo = cadena % 1001;
                  |SI campo = ".";
                      ||TODO CCC. He descomentado lo que estaba comentado
                      || y dejo comentado lo que habia antes y no era correcto
                      || con la estructura (respecto a la cuenta con punto (.)

                      campo = cadena % 703;
                      ||campo = cadena % 602;
                      campo1 = cadena % 1106;
                      cuenta = campo + campo1;
                      sufijo = cadena % 703;
                      ||sufijo = cadena % 603;
                  |SINO;
                      cuenta = cadena % 809;
                      sufijo = "";
                  |FINSI;
                  cuentarep = cadena % 706;
                  |QBT cuenta; || por si trae 9 o menos
                  signo = cadena % 1701;
                  impor = cadena % 1811;
                  impore = impor;
                  impore = impore / nFactor;
                  impore = impore ! 2;
                  comen = cadena % 3330;|QBF comen;
                  campo = cadena % 6902;
                  campo1 = cadena% 6702;
                  fecha = campo + "." + campo1;
                  campo = cadena % 6304;
                  fecha = fecha + "." + campo;
                  campo = cadena % 7110;
                  comen = comen + " " + campo;
                  contado = cadena % 4521;
                  comision = cadena % 0103;

                  long = cadena % 0;
                  sw = 0;

                  |SI sufijo = "430";|O sufijo = "400";|O sufijo = "410";
                      cuentasuf  = cuenta;
                      fechasuf   = fecha;
                      asientosuf = asiento;
                      comensuf   = comen;
                  |FINSI;

                  |SI clave = "A";
                      |SI #0#10 = "S";
                          |HAZ graba_tmp;
                      |FINSI;
                  |SINO;
                      |SI clave = "H";
                          asiento = asiento + 1;
                          linea    = 0;
                      |FINSI;
                      |SI clave = "S";   ||Iva Soportado;
                          |SI cuentasuf ] "400000000";|Y cuentasuf [ "429999999";
                              |SI #0#12 = "S";
                                  |HAZ ivasop;
                              |FINSI;
                          |FINSI;
                      |FINSI;
                      aFactura = cadena % 210; |QBT aFactura;
                      aDesIva = cadena % 4540; |QBF aDesIva;
                      aDesIva = "Fra:" + aFactura + " " + aDesIva;
                      aHabitual = cadena % 2301;
                      |SI clave = "R";   ||Iva Repercutido;
                           |SI #0#11 = "S"; |Y aHabitual = "S";
                               |HAZ ivarep;
                               nRegRep = nRegRep + 1;
                           |FINSI;
                           |SI #0#13 = "S"; |Y aHabitual = "N";
                                |HAZ ivarepcon;
                                nRegRep = nRegRep + 1;
                           |FINSI;
                      |FINSI;
                  |FINSI;
                  campo = "";
              |FINSI;
        |SIGUE;
    |SINO;
        |MENAV "0000Error al abrir el fichero...";
        |ACABA;
    |FINSI;
    |XCIERRA f;

    |SI #0#11 = "S"; |O #0#13 = "S";
        |HAZ GraRepercutido;
    |FINSI;
    |SI #0#12 = "S";  ||Sopo
        |HAZ gracontiva;
    |FINSI;
    |SI #0#10 = "S";
        |HAZ gracontasi;
    |FINSI;

    sw_conase4 = 1;
    aAlfa1 = ":contagen/carecupe canempr1 " + aEmpresa + "; N";
    |SUB_EJECUTA_NP aAlfa1;

    aAlfa1 = ":contagen/careccab canempr1 " + aEmpresa + ";AUTO";
    |SUB_EJECUTA_NP aAlfa1;

    |AVISO;
    |AVISO;
    |MENAV "0000Pase Realizado con exito ";
|FCAL;
