|FICHEROS;
     coimz021 #0;
     coima001 #1;
     coima002 #2;
     coima003 #3;
     coima007 #7;
     coimw014 #14; ||Tmp
     agifa017 #17;
     agifa019 #19;
     coima027 #27;
     agifa049 #49;
     coima041 #41;
|FIN;

|VARIABLES;
     &eaAct = "";
     fHoy = @;
     nDisp = 0;
     aParam = "";
     nAcumProc = 0;
     aTmp14 = "";
     &Tempo = "";
     &eaArticulo = "";
     &enAlmacen = 0;
     &efFecha = @;
     &eaSerie = "";
     &enCodigo = 0;
     &enLinea = 0;
     &enUnidades = 0;
     nNume = 0;
     nHay = 0;
|FIN;

|PROCESO HistoPro;
     |SI aParam = "RECAL";
          nNume = #3#7 - #3#8 + #17#5 - #27#7 + nAcumProc - #3#17;
     |SINO;
          nNume = #3#7 - #3#8 + #17#39 + nAcumProc;
     |FINSI;
     nAcumProc = nAcumProc + #3#7 - #3#8;
     |SI nNume > 0;
          nHay = 1;
          #3#17 = #3#17 + enUnidades;
          |GRABA 020#3a;
          |ERROR10;
     |FINSI;
     |LIBERA #3;
|FPRC;

|DEFBUCLE HistoPro;
     #3#5;
     0, 6;
     eaArticulo, "N", "01.01.0000", #2#0, #2#1;
     eaArticulo, "N", "31.12.9999", #2#0, #2#1;
     be;
     NULL, HistoPro;
|FIN;

|PROCESO TipoPro;
     nAcumProc = 0;
     |BUCLE HistoPro;
     |SI nHay ! 0; |ERROR10; |FINSI;
|FPRC;

|DEFBUCLE TipoPro;
     #2#2;
     ;
     "z", 99;
     " ", 00;
     ;
     NULL, TipoPro;
|FIN;

|PROCESO ArtiNormal;
     |SI aParam = "RECAL";
          nDisp = #17#5 - #27#7 - enUnidades;
     |SINO;
          nDisp = #17#39;
     |FINSI;

     |SI nDisp ] 0;
          |SI aParam = "RECAL"; |Y eaAct = "S";
               #7#5 = #7#4;
          |FINSI;
          #7#8 = #7#7;
          nNume = efFecha + #1#31;
          #7#4 = nNume;
          #7#6 = efFecha;
          #7#7 = 1;
          |SI aParam = "RECAL";
               |LEE 101#27=;
               |SI FSalida ! 0; |GRABA 020#27b; |FINSI;
               #27#7 = #27#7 + enUnidades;
               |GRABA 020#27a;
          |FINSI;
     |SINO;
          nHay = 0;
          |BUCLE TipoPro;
          |SI nHay = 1;
               |ABRE #2;
               #2#0 = #3#0;
               #2#1 = #3#6;
               |LEE 000#2=;
               |SI FSalida ! 0; |DDEFECTO #2; |FINSI;
               |CIERRA #2;

               |SI aParam = "RECAL"; |Y eaAct = "S";
                    #7#5 = #7#4;
               |FINSI;
               #7#8 = #7#7;
               |SI #3#10 ] efFecha;
                    nNume = #3#10 + #1#32;
                    #7#4 = nNume;
                    #7#7 = 2;
               |SINO;
                    nNume = efFecha + #2#5 + #1#32;
                    #7#4 = nNume;
                    #7#7 = 3;
               |FINSI;
               #7#6 = #3#10;
          |SINO;
               |SI aParam = "RECAL"; |Y eaAct = "S";
                    #7#5 = #7#4;
               |FINSI;
               #7#8 = #7#7;

               |ABRE #coima041;
               |DDEFECTO #coima041;
               #coima041#0 = #agifa019#125;
               |LEE 000#coima041.=;
               |SI FSalida ! 0;
                    #7#4 = "31.12.9999";
                    #7#7 = 8;
               |SINO;
                    #7#4 = "31.12.8888";
                    #7#7 = 9;
               |FINSI;
               |CIERRA #coima041;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO HistoPro2;
     nNume = #3#7 - #3#8 - #3#17 - (enUnidades * #49#12) - (#27#7 * #49#12);
     nNume = nNume + nAcumProc;
     nAcumProc = nAcumProc + #3#7 - #3#8 - #3#17;
     |SI nNume > 0;
          #14#0 = #3#0;
          #14#1 = #3#1;
          #14#2 = #3#2;
          #14#3 = #3#3;
          #14#4 = #3#4;
          #14#5 = #3#5;
          #14#6 = #3#10;
          |GRABA 020#14n;
          nHay = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE HistoPro2;
     #3#5;
     0, 6;
     #49#2, "N", "01.01.0000", #2#0, #2#1;
     #49#2, "N", "31.12.9999", #2#0, #2#1;
     be;
     NULL, HistoPro2;
|FIN;

|PROCESO TipoPro2;
     nAcumProc = 0;
     |BUCLE HistoPro2;
     |SI nHay ! 0; |ERROR10; |FINSI;
|FPRC;

|DEFBUCLE TipoPro2;
     #2#2;
     ;
     "z", 99;
     " ", 00;
     ;
     NULL, TipoPro2;
|FIN;

|PROCESO LinEscan;
     nHay = 0;
     #27#0 = #49#2;
     #27#1 = enAlmacen;
     |LEE 000#27=;
     |SI FSalida = 0;
          |SI #27#4 ! 0; |O #27#5 ! 0;
               #17#0 = #27#0;
               #17#1 = enAlmacen;
               |LEE 000#17=;
               |SI  FSalida = 0; |Y #17#39 < 1;
                    |BUCLE TipoPro2;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE LinEscan;
     #49#1;
     ;
     eaArticulo, 001;
     eaArticulo, 999;
     ;
     NULL, LinEscan;
|FIN

|PROCESO ArtiKit;
     ||nNume = #17#9 - enUnidades;
     nNume = #17#9 - enUnidades - #27#7;
     |SI nNume ] 0;
          |SI aParam = "RECAL"; |Y eaAct = "S";
               #7#5 = #7#4;
          |FINSI;
          #7#8 = #7#7;
          nNume = efFecha + #1#31;
          #7#4 = nNume;
          #7#6 = efFecha;
          #7#7 = 1;
          |LEE 101#27=;
          |SI FSalida ! 0; |GRABA 020#27b; |FINSI;
          #27#7 = #27#7 + enUnidades
          |GRABA 020#27a;
     |SINO;
          nNume = #17#9 + #27#4 + #27#5;
          |SI nNume > 0;
               |DELINDEX #14;
               nHay = 0;
               |ABRE #14;
               |ABRE #17;
               |BUCLE LinEscan;
               |CIERRA #14;
               |CIERRA #17;

               |ABRE #14; |SELECT #2#14;
               |LEE 000#14p;
               |SI FSalida = 0;
                    |ABRE #3;
                    #3#0 = #14#0;
                    #3#1 = #14#1;
                    #3#2 = #14#2;
                    #3#3 = #14#3;
                    #3#4 = #14#4;
                    #3#5 = #14#5;
                    |LEE 121#3=;
                    |SI FSalida = 0;
                         #3#17 = #3#17 + enUnidades;
                         |GRABA 020#3a;
                    |FINSI;
                    |CIERRA #3;
                    |ABRE #2;
                    #2#0 = #3#0;
                    #2#1 = #3#6;
                    |LEE 000#2=;
                    |SI FSalida ! 0; |DDEFECTO #2; |FINSI;
                    |CIERRA #2;
                    #7#8 = #7#7;
                    |SI aParam = "RECAL"; |Y eaAct = "S";
                         #7#5 = #7#4;
                    |FINSI;
                    |SI #3#10 ] efFecha;
                         nNume = #3#10 + #1#32;
                         #7#4 = nNume;
                         #7#7 = 2;
                    |SINO;
                         nNume = efFecha + #2#5 + #1#32;
                         #7#4 = nNume;
                         #7#7 = 3;
                    |FINSI;
                    #7#6 = #3#10;
               |SINO;
                    |SI aParam = "RECAL"; |Y eaAct = "S";
                         #7#5 = #7#4;
                    |FINSI;
                    #7#8 = #7#7;
                    |ABRE #coima041;
                    |DDEFECTO #coima041;
                    #coima041#0 = #agifa019#125;
                    |LEE 000#coima041.=;
                    |SI FSalida ! 0;
                         #7#4 = "31.12.9999";
                         #7#7 = 8;
                    |SINO;
                         #7#4 = "31.12.8888";
                         #7#7 = 9;
                    |FINSI;
                    |CIERRA #coima041;
               |FINSI;
               |CIERRA #14;
          |SINO;
               |SI aParam = "RECAL"; |Y eaAct = "S";
                    #7#5 = #7#4;
               |FINSI;
               #7#8 = #7#7;
               |ABRE #coima041;
               |DDEFECTO #coima041;
               #coima041#0 = #agifa019#125;
               |LEE 000#coima041.=;
               |SI FSalida ! 0;
                    #7#4 = "31.12.9999";
                    #7#7 = 8;
               |SINO;
                    #7#4 = "31.12.8888";
                    #7#7 = 9;
               |FINSI;
               |CIERRA #coima041;
          |FINSI;
     |FINSI;
|FPRC;

|PROGRAMA;
     aParam = PARAMETRO;
     fHoy = ~;

     |ABRE #1; |LEE 000#1p; |CIERRA #1;

     |ABRE #19;
     #19#0 = eaArticulo;
     |LEE 000#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;
     |CIERRA #19;

     |ABRE #17;
     #17#0 = eaArticulo;
     #17#1 = enAlmacen;
     |LEE 000#17=;
     |SI FSalida ! 0; |DDEFECTO #17; |FINSI;
     |CIERRA #17;

     |DDEFECTO #27;
     |ABRE #27;
     #27#0 = eaArticulo;
     #27#1 = enAlmacen;
     |LEE 000#27=;

     |ABRE #7;
     #7#0 = eaSerie;
     #7#1 = enCodigo;
     #7#2 = enLinea;
     |LEE 101#7=;
     |SI FSalida = 0;
          |SI #19#135 = "N";
               |HAZ ArtiKit;
          |SINO;
               |HAZ CreaTempo; aTmp14 = Tempo;
               |NOME_DAT #14Tempo; |DELINDEX #14;
               |HAZ ArtiNormal;
               Tempo = aTmp14; |HAZ BoraTempo; |DELINDEX #14;
          |FINSI;
          |SI #7#4 < fHoy;
               |SI #7#7 = 1;
                    nNume = fHoy + #1#33;
                    #7#7 = 4;
               |SINO;
                    nNume = fHoy + #2#5 + #1#33;
                    |SI #7#7 = 2;
                         #7#7 = 5;
                    |SINO;
                         #7#7 = 6;
                    |FINSI;
               |FINSI;
               #7#4 = nNume;
          |FINSI;
          |GRABA 020#7a;
     |FINSI;
     |CIERRA #7;
     |CIERRA #27;
|FPRO;
