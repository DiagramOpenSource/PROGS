     CALCULO COMISIONES

|FICHEROS;
     agifa019 #19;
     agifa024 #24;
     agifa142 #142;
     agifa128 #128;
     agifa129 #129,MANTE;
     dsm00022 #922;
     agifa023 #23;
     agifa290 #290;
     dsm00123 #123;
     referen@ #100; || tecam023, tecam026, coima009
|FIN;

|VARIABLES;
     nSwDir         = 0;
     &enDirEnt      = 0;
     &enUniMarhu    = 0;
     &enDescuento1  = 0;
     &enDescuento2  = 0;
     &enComision    = 0;
     &eaRepre       = "";
     &eaCliente     = "";
     &eaArticulo    = "";
     &enAlmacen = 0;
     &eaTComision   = "";
     &efFecha       = @;
     &uni_dt        = 0;

     nSwError       = 0;

      aCero         = "";
      nCampo        = 0;
      nRepre        = 0;
      nPasada       = 0;
      nPrior        = 0;
      nComision1    = 0;
      nComision2    = 0;
      nComision3    = 0;
      nComision4    = 0;
      nComision5    = 0;
      nDescuento    = 0;
      nCCom         = 0;
      nCDto         = 0;
      nDescu        = 0;
      nMenor        = 0;
      nPrimera      = 0;
      aAlfa         = "";
      pa            = 0;
      pa1           = 0;
|FIN;

|PROCESO KK;
|| este proceso lo ejecuta el rucoz004 y no SE PORQUE

|| 28.01.2014 al cambiar la relacion 6 del rucoz003 del rucom001
|| por agifa142 ya no entra aqui!!!
|FPRC;

|PROCESO  PorPromoArtiAlma;
     |DDEF aAlfa;
     aAlfa = aAlfa + "tecam026";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000ERROR al cargar 'tecam026'";
          |ACABA;
     |FINSI;

     |ABRE #100;
     #100#0 = #19#0;
     #100#41 = #24#158
     #100#50 = enAlmacen;
     |LEE 000#100=;
     |SI FSalida = 0;
          pa1 = 41;
          |PARA pa = 1;|SI pa [ 15;|HACIENDO pa = pa + 2;
               pa1 = pa1 + 1;
               |SI #100pa ! 0;
                     |SI uni_dt ] #100pa;
                         |SI #100pa1 = 0;
                             |SI aCero = "S";  nComision5 = #100pa1; |FINSI;
                         |SINO;
                             nComision5 = #100pa1;
                         |FINSI;
                     |FINSI;
               |SINO;
                     |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
     |CIERRA #100;
     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO PorPromo;
     |HAZ EsTecatel;
     |SI FSalida = 0; |Y #142#9 = "S";
          |HAZ PorPromoArtiAlma;
          |ACABA;
     |FINSI;

     |ABRE #290;
     #290#0 = #19#0;
     #290#41 = #24#158
     |LEE 000#290=;
     |SI FSalida = 0;
          pa1 = 41;
          |PARA pa = 1;|SI pa [ 15;|HACIENDO pa = pa + 2;
               pa1 = pa1 + 1;
               |SI #290pa ! 0;
                     |SI uni_dt ] #290pa;
                         |SI #290pa1 = 0;
                             |SI aCero = "S";  nComision5 = #290pa1; |FINSI;
                         |SINO;
                             nComision5 = #290pa1;
                         |FINSI;
                     |FINSI;
               |SINO;
                     |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
     |CIERRA #290;
|FPRC;

|PROCESO PorTCliente;
     |ABRE #128;
     #128#0 = #24#4;
     |LEE 040#128=;
     |SI FSalida ! 0;  |CIERRA #128;  |ACABA; |FINSI;
     |CIERRA #128;

     |SI #128#1 = 0;
         |SI aCero = "S";  nComision1 = #128#1;  |FINSI;
     |SINO;
         nComision1 = #128#1;
     |FINSI;
|FPRC;

|PROCESO PorDtos;
     |ABRE #129;
     #129#0 = eaTComision;
     |LEE 000#129=;
     |SI FSalida ! 0;  |CIERRA #129;  |ACABA;  |FINSI;
     |CIERRA #129;

     |SI #129#41 = 1;  nDescuento = enDescuento1;  |FINSI;
     |SI #129#41 = 2;  nDescuento = enDescuento2;  |FINSI;
     |SI #129#41 = 3;
         nDescuento = enDescuento1;
         |SI nDescuento < enDescuento2;  nDescuento = enDescuento2;  |FINSI;
     |FINSI;
     |SI #129#41 = 4;
         nDescuento = enDescuento1;
         |SI nDescuento > enDescuento2;  nDescuento = enDescuento2;  |FINSI;
     |FINSI;
     |SI #129#41 = 5;  nDescuento = enDescuento1 + enDescuento2;     |FINSI;
     nMenor = 0;
     |PARA nCDto = 1;  |SI nCDto [ 39;|HACIENDO nCDto = nCDto + 2;
           nCCom = nCDto + 1;
           |SI nDescuento ] nMenor; |Y nDescuento [ #129nCDto;
               nComision2 = #129nCCom;
               |SAL;
           |FINSI;
           nMenor = #129nCDto;
     |SIGUE;
     |SI nComision2 = 0;
         |SI aCero = "N";  nComision2 = -1;  |FINSI;
     |FINSI;
|FPRC;

|PROCESO CogeGrupo;
     |SI #19#2   < #922#4;   |ACABA;  |FINSI;
     |SI #19#2   > #922#5;   |ACABA;  |FINSI;
     |SI #19#3   < #922#6;   |ACABA;  |FINSI;
     |SI #19#3   > #922#7;   |ACABA;  |FINSI;
     |SI #19#0   < #922#8;   |ACABA;  |FINSI;
     |SI #19#0   > #922#9;   |ACABA;  |FINSI;
     |SI #19#125 < #922#35;  |ACABA;  |FINSI;
     |SI #19#125 > #922#36;  |ACABA;  |FINSI;

     |SI #922#10 = "N";
         |SI eaRepre < #922#11;  |ACABA;  |FINSI;
         |SI eaRepre > #922#12;  |ACABA;  |FINSI;
     |SINO;
         nRepre = 0;
         |PARA nCampo = 13;  |SI nCampo [ 34;  |HACIENDO nCampo = nCampo + 1;
               |SI #922nCampo = eaRepre;  nRepre = 1;  |SAL;  |FINSI;
         |SIGUE;
         |SI nRepre = 0;  |ACABA;  |FINSI;
     |FINSI;

     |SI #922#3 = 0;
         |SI aCero = "S";  nComision3 = #922#3;  |FINSI;
     |SINO;
         nComision3 = #922#3;
     |FINSI;
|FPRC;

|DEFBUCLE dsm00022;
     #922#1;
     ;
     #24#158, 001;
     #24#158, 999;
     ;
     NULL, CogeGrupo;
|FIN;

|PROCESO CoimaGrupo;
     |SI enDescuento1 < #referen@#37; |O enDescuento1 > #referen@#38;
          |ACABA;
     |FINSI;

     |SI #19#2   < #referen@#4;   |ACABA;  |FINSI;
     |SI #19#2   > #referen@#5;   |ACABA;  |FINSI;
     |SI #19#3   < #referen@#6;   |ACABA;  |FINSI;
     |SI #19#3   > #referen@#7;   |ACABA;  |FINSI;
     |SI #19#0   < #referen@#8;   |ACABA;  |FINSI;
     |SI #19#0   > #referen@#9;   |ACABA;  |FINSI;
     |SI #19#125 < #referen@#35;  |ACABA;  |FINSI;
     |SI #19#125 > #referen@#36;  |ACABA;  |FINSI;

     |SI #referen@#10 = "N";
         |SI eaRepre < #referen@#11;  |ACABA;  |FINSI;
         |SI eaRepre > #referen@#12;  |ACABA;  |FINSI;
     |SINO;
         nRepre = 0;
         |PARA nCampo = 13;  |SI nCampo [ 34;  |HACIENDO nCampo = nCampo + 1;
               |SI #922nCampo = eaRepre;  nRepre = 1;  |SAL;  |FINSI;
         |SIGUE;
         |SI nRepre = 0;  |ACABA;  |FINSI;
     |FINSI;

     |SI #referen@#3 = 0;
         |SI aCero = "S";  nComision3 = #referen@#3;  |FINSI;
     |SINO;
         nComision3 = #referen@#3;
     |FINSI;
|FPRC;

|DEFBUCLE CoimaGrupo;
     #referen@#1002;
     ;
     #24#158, 001;
     #24#158, 999;
     ;
     NULL, CoimaGrupo;
|FIN;

|PROCESO PorGrupo;
     |HAZ EsCoimasa;
     |SI FSalida = 0;
          |DDEF aAlfa;
          aAlfa = aAlfa + "coima009";
          |CARGA_DEF aAlfa, referen@;
          |SI FSalida = 0;
               |BUCLE CoimaGrupo;
               |DESCARGA_DEF #referen@;
          |FINSI;
          |ACABA;
     |FINSI;


     |BUCLE dsm00022;
|FPRC;

|PROCESO PorArtiAlma;
     |DDEF aAlfa;
     aAlfa = aAlfa + "tecam023";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000ERROR al cargar 'tecam023'";
          |ACABA;
     |FINSI;

     |ABRE #100;
     #100#0 = eaCliente;
     #100#1 = eaArticulo;
     #100#2 = enAlmacen;
     |LEE 000#100=;
     |SI FSalida = 0;
          |SI efFecha ] #100#7; |Y efFecha [ #100#8;
               |SI #100#5 = 0;
                    |SI aCero = "S";
                         #19#31 = #100#5;
                    |FINSI;
               |SINO;
                    #19#31 = #100#5;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #23;

     |SI #19#31 = 0;
          |SI aCero = "S";
               nComision4 = #19#31;
          |FINSI;
     |SINO;
          nComision4 = #19#31;
     |FINSI;

     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO PorArticulo;
     |HAZ EsTecatel;
     |SI FSalida = 0; |Y #142#9 = "S";
          |HAZ PorArtiAlma;
          |ACABA;
     |FINSI;

     |ABRE #23;
     #23#0 = eaCliente;
     #23#1 = eaArticulo;
     |LEE 000#23=;
     |SI FSalida = 0;
          |SI efFecha ] #23#28; |Y efFecha [ #23#29;
               |SI #23#34 = 0;
                    |SI aCero = "S";
                         #19#31 = #23#34;
                    |FINSI;
               |SINO;
                    #19#31 = #23#34;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #23;

     |SI #19#31 = 0;
          |SI aCero = "S";
               nComision4 = #19#31;
          |FINSI;
     |SINO;
          nComision4 = #19#31;
     |FINSI;
|FPRC;

|PROCESO PorDirArticulo;
     nSwDir = 0;

     |ABRE #123;
     #123#0 = eaCliente;
     #123#1 = enDirEnt;
     #123#2 = eaArticulo;
     |LEE 000#123=;
     |SI FSalida = 0;
          |SI efFecha ] #123#7; |Y efFecha [ #123#8;
               |SI #123#5 = 0;
                    |SI aCero = "S";
                         #19#31 = #123#5;
                         nSwDir = 1;
                    |FINSI;
               |SINO;
                    #19#31 = #123#5;
                    nSwDir = 1;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #123;

     |SI nSwDir = 0;
          |HAZ PorArticulo;
     |SINO;
          |SI #19#31 = 0;
               |SI aCero = "S";
                    nComision4 = #19#31;
               |FINSI;
          |SINO;
               nComision4 = #19#31;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Comisiones;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |ABRE #19;
     #19#0 = eaArticulo;
     |LEE 040#19=;
     |SI FSalida ! 0;  |DDEFECTO #19;  |FINSI;
     |CIERRA #19;

     |ABRE #24;
     #24#0 = eaCliente;
     |LEE 040#24=;
     |SI FSalida ! 0;  |DDEFECTO #24;  |FINSI;
     |CIERRA #24;

     |HAZ EsRocai; |SI FSalida = 0; |HAZ ComisionRocai; |ACABA; |FINSI;

     enComision = 0;
     nComision1 = -1;
     nComision2 = -1;
     nComision3 = -1;
     nComision4 = -1;
     nComision5 = -1;

     |SI #142#105 ! 0; aCero = #142#106; |HAZ PorTCliente;  |FINSI;
     |SI #142#107 ! 0; aCero = #142#108; |HAZ PorDtos;      |FINSI;
     |SI #142#109 ! 0; aCero = #142#110; |HAZ PorGrupo;     |FINSI;
     |SI #142#111 ! 0; aCero = #142#112; |HAZ PorDirArticulo;  |FINSI;
     |SI #142#180 ! 0; aCero = #142#181; |HAZ PorPromo;     |FINSI;

     |SI #142#113 = 1;
         |PARA nPasada = 5; |SI nPasada ] 1; |HACIENDO nPasada = nPasada - 1;
               |PARA nPrior = 105; |SI nPrior [ 111; |HACIENDO nPrior = nPrior + 2;
                     |SI #142nPrior = nPasada;
                         |SI nPrior = 105;
                             |SI nComision1 ! -1;  enComision = nComision1;  |FINSI;
                         |FINSI;
                         |SI nPrior = 107;
                             |SI nComision2 ! -1;  enComision = nComision2;  |FINSI;
                         |FINSI;
                         |SI nPrior = 109;
                             |SI nComision3 ! -1;  enComision = nComision3;  |FINSI;
                         |FINSI;
                         |SI nPrior = 111;
                             |SI nComision4 ! -1;  enComision = nComision4;  |FINSI;
                         |FINSI;
                    |FINSI;
                    |SI #142#180 = nPasada;
                         |SI nComision5 ! -1;  enComision = nComision5;  |FINSI;
                    |FINSI;
               |SIGUE;
          |SIGUE;
     |SINO;
          nMenor = -1;
          |SI nComision1 ! -1;  nMenor = nComision1;  |FINSI;
          |SI nComision2 ! -1;
              |SI nMenor = -1;
                  nMenor = nComision2;
              |SINO;
                  |SI nMenor > nComision2;  nMenor = nComision2;  |FINSI;
              |FINSI;
          |FINSI;
          |SI nComision3 ! -1;
              |SI nMenor = -1;
                  nMenor = nComision3;
              |SINO;
                  |SI nMenor > nComision3;  nMenor = nComision3;  |FINSI;
              |FINSI;
          |FINSI;
          |SI nComision4 ! -1;
              |SI nMenor = -1;
                  nMenor = nComision4;
              |SINO;
                  |SI nMenor > nComision4;  nMenor = nComision4;  |FINSI;
              |FINSI;
          |FINSI;
          |SI nComision5 ! -1;
              |SI nMenor = -1;
                  nMenor = nComision5;
              |SINO;
                  |SI nMenor > nComision5;  nMenor = nComision5;  |FINSI;
              |FINSI;
          |FINSI;

          |SI nMenor = -1;
              enComision = 0;
          |SINO;
              enComision = nMenor;
          |FINSI;
     |FINSI;
|FPRC;

컴컴컴컴컴컴컴횺arhuenda컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO ComiMarhu;
|| *************************************
||     |HAZ EsMarhuenda;
||     |SI FSalida = 0;
||          |HAZ ComisionMarhuenda;
||
|| debe permanecer comentado por problemas en redondeo
|| en el agifa071 - Priego/Juan"
||     |FINSI;
||***************************************
|FPRC;

|PROCESO ComisionRocai;
     |DDEF aAlfa;
     aAlfa = aAlfa + "rocaim01";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          #referen@#0 = eaArticulo;
          |LEE 000#referen@.=;
          |SI FSalida ! 0; |DDEFECTO #referen@; |FINSI;
          |CIERRA #referen@;
          |SI #24#39 = 1; enComision = #referen@#1; |FINSI;
          |SI #24#39 = 2; enComision = #referen@#2; |FINSI;
          |SI #24#39 = 3; enComision = #referen@#3; |FINSI;
          |SI #24#39 = 4; enComision = #referen@#4; |FINSI;
          |SI #24#39 = 5; enComision = #referen@#5; |FINSI;
          |SI #24#39 = 6; enComision = #referen@#6; |FINSI;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;
