               Lo llama dsz99977, EstockEntra

|FICHEROS;
     goprepec #0;
     goprepel #1;
     agifa017 #17;
     agifa019 #19;
     guerm025 #25;
     guerm047 #47;
     dsm00054 #54;
     dsm00055 #55;
     goparame #100;
     guerm123 #123;
|FIN;

|VARIABLES;
     nAlm1 = 0;
     nAlm2 = 0;
     nPdte = 0;
     nUniPedi = 0;
     aGra47 = "";
     &eaReceAlmaObra = "";
     nConta = 0;
     nUni = 0;
|FIN;

|INCLUYE i_varart;

|PROCESO MoviAlma;
     nAlm1 = enAlmacen;
     nAlm2 = #100#51;

     |ABRE #54;
     |DDEFECTO #54;
     #54#2 = #25#0;
     #54#0 = #25#1;
     |LEE 101#54=;
     |SI FSalida ! 0; |GRABA 020#54n; |FINSI;
     |CIERRA #54;

     |ABRE #55;
     #55#28 = #54#2;
     #55#27 = #54#0;
     #55#11 = 99999;
     |LEE 000#55];
     |SI FSalida = 0;
          |LEE 000#55a;
     |SINO;
          |LEE 000#55u;
     |FINSI;
     |SI FSalida = 0; |Y #55#28 = #54#2;  |Y #55#27 = #54#0;
          nConta = #55#11 + 1;
     |SINO;
          nConta = 1;
     |FINSI;

     |DDEFECTO #55;
     #55#28 = #54#2;
     #55#27 = #54#0;
     #55#11 = nConta;
     #55#0 = #1#2;
     #55#1 = nAlm1;    ||Alm Sal = Comp
     #55#2 = #1#3;

     |ABRE #19;
     #19#0 = #1#2;
     |LEE 000#19=;
     |CIERRA #19;

     |ABRE #17;
     #17#0 = #1#2;
     #17#1 = nAlm2;
     |LEE 000#17=;

     #55#7 = #19#6;
     #55#3 = #17#5;
     #55#4 = nUni;
     #55#5 = nAlm2;    ||Alm Ent = Depo
     #55#9 = #17#41;

     #17#1 = nAlm2;
     |LEE 000#17=;
     |CIERRA #17;

     #55#6 = #17#5;
     #55#8 = #54#1;
     #55#10 = #17#41;
     |GRABA 020#55n;
     |CIERRA #55;
     enForma = 1;
     |HAZ AcumulaME_MS;
|FPRC;

|PROCESO Ultima25;
     #25#0 = #0#3;
     #25#1 = 99999;
     |LEE 000#25];
     |SI FSalida = 0;
          |LEE 000#25a;
     |SINO;
          |LEE 000#25u;
     |FINSI;
     |SI FSalida = 0; |Y #25#0 = #0#3;
          nConta = #25#1 + 1;
     |SINO;
          nConta = 1;
     |FINSI;
|FPRC;

|PROCESO ReservaAlma;
     |SELECT #2#25;
     #25#10 = #123#8;
     #25#11 = #123#9;
     |LEE 101#25=;
     |SI FSalida = 0;
          |SELECT #1#25;
          |LEE 121#25=;
     |SINO;
          |DDEFECTO #25;
          |HAZ Ultima25;
          #25#0 = #0#3;
          #25#1 = nConta;
          |GRABA 020#25b;
          #25#11 = #1#1;
     |FINSI;
     #25#2 = #0#1;
     #25#3 = #0#3;
     #25#4 = #0#7;
     #25#5 = #0#8;
     #25#6 = #0#9;
     #25#7 = #1#2;
     #25#8 = #1#3;
     #25#9 = #1#23;
     #25#16 = #25#16 + nUni;
     #25#17 = #25#9 - #25#16;
     #25#10 = #1#0;
     #25#11 = #1#1;
     #25#12 = "N";
     #25#13 = Usuario % 810;
     #25#14 = enAlmacen;
     #25#15 = #100#51;
     |GRABA 020#25a;
|FPRC;

|PROCESO ReservasPdt;
     |DDEFECTO #0;
     #0#0 = #123#8;
     |LEE 000#0=;

     #1#0 = #123#8;
     #1#1 = #123#9;
     |LEE 121#1=;
     |SI FSalida = 0;
          nPdte = #123#5 - #123#6;
          |SI nPdte > 0;
               |SI nPdte > nUniPedi;
                    nUni = nUniPedi;
               |SINO;
                    nUni = nPdte;
               |FINSI;

               #1#23 = #1#23 + nUni;
               |GRABA 020#1a;
               |LIBERA #1;

               |HAZ ReservaAlma;
               |HAZ MoviAlma;

               nUniPedi = nUniPedi - nUni;
               #123#6 = #123#6 + nUni;
               |GRABA 020#123a;
          |FINSI;
     |FINSI;
     |LIBERA #123;

     |SI nUniPedi = 0; |ERROR10; |FINSI;
|FPRC;

|DEFBUCLE ReservasPdt;
     #123#1;
     ;
     eaSerie, enCodigo, enLinea, 001;
     eaSerie, enCodigo, enLinea, 999;
     be;
     NULL, ReservasPdt;
|FIN;

|PROGRAMA;
     |ABRE #100; |LEE 000#100p; |CIERRA #100;

     aGra47 = "S";

     ||Pedido de Prepedido y este se recepciona en el almacen
     ||de la obra no debe de generar el fichero guerm047

     |ABRE #1;
     |SELECT #3#1;
     #1#28 = eaSeriePedido;
     #1#29 = enCodigPedido;
     |LEE 000#1=;
     |SI FSalida = 0; |Y eaReceAlmaObra = "S";
          aGra47 = "N";
     |FINSI;
     |CIERRA #1;

     |SI aGra47 = "S";
          enModo = (FEntrada / 100) ! 0;
          |DDEFECTO #47;
          |ABRE #47;
          #47#0 = eaSerie;
          #47#1 = enCodigo;
          #47#2 = enLinea;
          |SI enModo = 3;
               |BORRA 040#47c;
          |SINO;
               |LEE 101#47=;
               |SI FSalida ! 0; |GRABA 020#47b; |FINSI;
               #47#3 = eaSuAlba;
               #47#4 = eaArticulo;
               #47#5 = enUnidades;
               #47#7 = #47#5 - #47#6;
               |GRABA 020#47a;
         |FINSI;
         |CIERRA #47;
     |FINSI;
     ||-------------------------------------------
     nUniPedi = enUnidades;
     |ABRE #0;
     |ABRE #1;
     |ABRE #25;
     |BUCLE ReservasPdt;
     |CIERRA #25;
     |CIERRA #1;
     |CIERRA #0;
|FPRO;
