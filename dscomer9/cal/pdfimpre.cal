|FICHEROS;
     pdfimtmp #100;
     pdfcontr;
|FIN;

|VARIABLES;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aLinea = "";
     nLinea = 0;
     aValor = "";
     aCampo = "";
     &aArchivo = "";
     aArchivoPDF = "";
     aArchivoFDF = "";
     aPathLocPDF = "";
     aPathSerPDF = "";
     aPathLocFDF = "";
     aPathSerFDF = "";
     aPathReader = "";
     &aID = "";
     aOrigen = "";
     aDestino = "";
     nCanal = 0;
     aSystem = "";
     aDirBase = "";
     aLongitud = "";
     nLongitud = "";
     aCaracter = "";
     aCaracterSal = "";
     aCadena = "";
     aCadenaSal = "";
     nPos = 0;
     nBusca = 0;
     nAscii = 0;

     &enWeb = 0;
     &eaWebArchivo = "";
     &eaWebDirDes = "";
     &eaWebDirPDF = "";
     nTipo = 0;
     aIP = "";
     &swCopia = 0;
     &aProcedencia = "";
     &aListaFich = "";
     &swDondeEstoy = 0;
     aUsuario = "";
     &nTipoSalida = 0;
     &nTipoImpre = 0;
     &nNroCopias = 0;
     aParametros = "";
     i = 0;
     aFicheroBAT = "";
     &aVengoDe = "";
     aMiCaracter = "";
     nCaracter = 0;
     nPorDonde = 0;
     aEjecutable = "";
     aUnidad = "";
     aMatador = "";
     aElUltimo = "";
     aElUltimo2 = "";
     &swPDFMasivo = 0;
     &nContador = 0;
     j = 0;
     aOrigenS = "";
     aDestinoS = "";
     aRetardo = "";
     aRetardoExt = "";
     nNume = 0;
|FIN;

|PROCESO control;
/*
     |ABRE #nomcontr;
     |LEE 000#nomcontr.p;
     |SI FSalida = 0;
          aRetardo = #nomcontr#36;
          nNume = #nomcontr#36 + 5;
          aRetardoExt = nNume;
     |FINSI;
     |CIERRA #nomcontr;
*/
|FPRC;

|PROCESO CargaInicial;
     |DBASE aDirBase;
     aPathLocPDF = "/C/ds/spoolpdf/";  || para la plantilla PDF (si, este formato)
     aPathLocFDF = "C:\ds\spoolpdf\";  || aqui va la plantilla y el FDF local
     |SI aArchivo = "nomina.pdf";
          aPathSerPDF = aDirBase + "def/";  || aqui van todas las plantillas PDF
     |SINO;
          aPathSerPDF = aDirBase + "pdf/";  || aqui van todas las plantillas PDF
     |FINSI;
     aPathSerFDF = aDirBase + "fich/"; || aqui va el FDF en el servidor
|FPRC;

|PROCESO BuscaMata;          || ME TRAIGO EL mata.exe DEL SERVIDOR A LOCAL
     aIP = "";
     |IP_REMOTO aIP;
     |DBASE aOrigen;
     aOrigen = aDirBase + "pdf/mata.exe";
     aDestino = "C:\ds\spoolpdf\mata.exe";
     |QBF aOrigen;
     |QBF aDestino;
     ||XABRE "CE", aDestino, nCanal;
     ||SI FSalida < 0;         || FSalida = 0: no existe el mata.exe en C:\ds\spoolpdf
          |SI aIP ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
     ||FINSI;
     aMatador = aDestino;
     ||XCIERRA nCanal;
|FPRC;

|PROCESO BuscaWait;          || ME TRAIGO EL mata.exe DEL SERVIDOR A LOCAL
     aIP = "";
     |IP_REMOTO aIP;
     |DBASE aOrigen;
     aOrigen = aDirBase + "pdf/wait.exe";
     aDestino = aPathReader + "wait.exe";
     |QBF aOrigen;
     |QBF aDestino;
     ||XABRE "CE", aDestino, nCanal;
     ||SI FSalida < 0;         || FSalida = 0: no existe el mata.exe en C:\ds\spoolpdf
          |SI aIP ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
     ||FINSI;
     ||XCIERRA nCanal;
|FPRC;

|PROCESO BuscaRuta;
     |ABRE #pdfcontr;
     aIP = "";
     |IP_REMOTO aIP;
     |QBF aIP;
     #pdfcontr#0 = aIP;
     |LEE 000#pdfcontr.=;
|FPRC;

|PROCESO BuscaCaracter;
     aLongitud = aCadena % 0;
     nLongitud = aLongitud;
     |PARA nPos = 1; |SI nPos [ nLongitud; |HACIENDO nPos = nPos + 1;
          nCaracter = ((nPos * 100) + 1) * nPorDonde;
          aCaracter = aCadena % nCaracter;
          |SI aCaracter = aMiCaracter;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO imprime_nomina;
     aParametros = " /h /p";         || Impresora por defecto
     || aDestino = "start " + aEjecutable + aParametros + aListaFich;
     aDestino = aEjecutable + aParametros + aListaFich;
     aFicheroBAT = aPathLocFDF + Usuario + ".bat";
     |XABRE "CBW", aFicheroBAT, nCanal;
     |SI FSalida = 0;
          aAlfa = "@echo off" + &13 + &10;
          |XGRABA nCanal, aAlfa;
          aUnidad = aPathReader % 102;
          aAlfa = aUnidad + &13 + &10;
          |XGRABA nCanal, aAlfa;
          aAlfa = "cd " + &34 + aPathReader + &34 + &13 + &10;
          aAlfa = aAlfa - aUnidad;
          |XGRABA nCanal, aAlfa;
          |PARA i = 1; |SI i [ nContador; |HACIENDO i = i + 1;
               |PARA j = 1; |SI j [ nNroCopias; |HACIENDO j = j + 1;
                    aAlfa = i; aAlfa = "000" + aAlfa; aAlfa = aAlfa % -103;
                    aAlfa = "a" + aAlfa + ".fdf";
                    aUsuario = Usuario;
                    aAlfa = " " + &34 + "C:\ds\spoolpdf\" + Usuario + "\" + aAlfa + &34;
                    |SI i = 1; |Y j = 1;     || la primera lleva retardo extra
                         aAlfa = "wait -" + aRetardoExt + " " + aEjecutable + aParametros + aAlfa;
                    |SINO;
                         aAlfa = "wait -" + aRetardo + " " + aEjecutable + aParametros + aAlfa;
                    |FINSI;
                    aAlfa = aAlfa + &13 + &10;
                    |XGRABA nCanal, aAlfa;
               |SIGUE;
          |SIGUE;
     |FINSI;
     |XCIERRA nCanal;
|FPRC;

|PROGRAMA;
     |SI enWeb = 0;
          |HAZ BuscaRuta;
          |HAZ control;
          |HAZ CargaInicial;
          |HAZ BuscaMata;

          aPathReader = #pdfcontr#1;
          |QBF aPathReader;

          aCadena = aPathReader;
          aMiCaracter = "\";
          nPorDonde = -1;
          |HAZ BuscaCaracter;
          nPos = nPos -1;
          nPos = nPos + 100;
          nPos = (-1) * nPos;
          aEjecutable = aPathReader % nPos;
          aPathReader = aPathReader - aEjecutable;

          |HAZ BuscaWait;

          |SI nTipoSalida = 0; |Y aProcedencia ! "nomrecib"; || Solo Vista Previa
               aParametros = "";
               nNroCopias = 1;
          |FINSI;
          |SI nTipoSalida = 1;                    || Impresion
               |SI nTipoImpre = 1;
                    aParametros = " /p";            || Muesta cuadro impresion
                    nNroCopias = 1;
               |SINO;
                    aParametros = " /h /p /n";         || Impresora por defecto
                    nNroCopias = nNroCopias;
               |FINSI;
          |FINSI;

          /* |SI nTipoSalida = 1;               || el ultimo fichero pasa a lla-
               aAlfa = aListaFich % -108;    || marse "no.fdf" porque es nece-
               aAlfa = aAlfa - &34;          || sario para el mata.exe
               aAlfa = aAlfa - &34;
               aElUltimo = aPathReader + aAlfa;
               aElUltimo2 = aPathReader + "no.fdf";
               |RCOPIA_FICHERO aElUltimo, aElUltimo2;
               aAlfa = &34 + aAlfa + &34;
               aListaFich = aListaFich - aAlfa;
               aListaFich = aListaFich + &34 + "no.fdf" + &34;
          |FINSI;
          */

          |SI swPDFMasivo = 0;
               aDestino = "start " + aEjecutable + aParametros + aListaFich;
               aFicheroBAT = aPathLocFDF + Usuario + ".bat";
               |XABRE "CBW", aFicheroBAT, nCanal;
               |SI FSalida = 0;
                    aAlfa = "@echo off" + &13 + &10;
                    |XGRABA nCanal, aAlfa;
                    aUnidad = aPathReader % 102;
                    aAlfa = aUnidad + &13 + &10;
                    |XGRABA nCanal, aAlfa;
                    aAlfa = "cd " + &34 + aPathReader + &34 + &13 + &10;
                    aAlfa = aAlfa - aUnidad;
                    |XGRABA nCanal, aAlfa;
                    aAlfa = "start " + aEjecutable + aParametros;
                    |XGRABA nCanal, aAlfa;
                    |PARA i = 1; |SI i [ nNroCopias; |HACIENDO i = i + 1;
                         aAlfa = aListaFich;
                         |XGRABA nCanal, aAlfa;
                    |SIGUE;
                    |SI nTipoSalida ! 0;
                         aAlfa = " " + &34 + "no.pdf" + &34;
                         |XGRABA nCanal, aAlfa;
                    |FINSI;
                    aAlfa = &13 + &10;
                    |XGRABA nCanal, aAlfa;
                    |SI nTipoSalida ! 0;
                         aAlfa = aMatador + &13 + &10;
                         |XGRABA nCanal, aAlfa;
                    |FINSI;
               |FINSI;
               |XCIERRA nCanal;
               |RSYSTEM aFicheroBAT;

               aAlfa = aPathSerFDF + aArchivoFDF;
               |FBORRA aAlfa;
          |SINO;
               |HAZ imprime_nomina;

               |RSYSTEM aFicheroBAT;

               aAlfa1 = nContador;
               aAlfa2 = nNroCopias;
               aAlfa = "    Nro. de nominas impresas: " + aAlfa1 + ".";
               aAlfa = aAlfa + " Nro. de copias: " + aAlfa2 + ".";
               |MENAV aAlfa;
               aAlfa = aPathSerFDF + aArchivoFDF;
               |FBORRA aAlfa;
          |FINSI;

          aListaFich = "";
          |CIERRA #pdfcontr;
     |FINSI;
|FPRO;
