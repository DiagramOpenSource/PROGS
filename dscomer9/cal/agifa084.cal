|FICHEROS;
     agifa084 #0;  || Facturas directas
     agifa024 #6;
     agifa069 #3;
     agifa019 #2;
     agifa025 #8;
     agifa038 #13;
     agifa048 #15;
     agifa049 #16;
     agifa091 #20;
     agifa007 #40;
     agifa142 #41;
     agifa027 #42;
     agifa321 #35;  || Parametros de Divisas
     agifa328 #36;  || Clientes/Divisas
     agifa329 #37;  || Lineas de Clientes/Divisas
     agifa324 #38;  || Divisas
     dsm00003 #49,MANTE;
     tempo084 #50,MANTE;  || a Pagar.......
     dsm00117 #117;
     dsm00133 #133;
     agifa134 #134;
     agifa716 #100;
     agifa722 #101;
     dsm00246 #140;
     dsm00247 #141;
     dsw00056 #200,MANTE;
     agifa501 #501;
     agifa704 #704;
     dsm00279 #279;

     pycm0011@ #900;

     agifa204;
     Referen@ #1000;
     Ref0001@ #1001;
     dsm00134 #1134;
     referen@;
     ||dsm00087@;
     pycm0014@;
     dsm00248 #143; ||Auditoria
     otpw0002 #700,MANTE;
     dsvim017@ #710;
     dsvim018@ #711;
     dsvim021@ #712;
     dsvim022@ #713;
     visalm05@ #714;

     RefBloq@  #5000;    || ATENCION! se CARGA y DESCARGA en TIPO8 y TIPO9
     ParamOTP@ #5001;
     visalm01@ #901;
|FIN;

|VARIABLES;
     aCien = "";
     aPathErp = "";
     aPathDSPREVEN = "";
     aErp = "";
     aBass = "";
     nSwEstaDocErp = 0;
     aAplicaErp = "";
     nEmpErp = 0;
     aDefErp = "";
     aClaveErp = "";
     nSalida = 0;
     aMensaje = "";
     aExpediente = "";

     i = 0;
     nArchi = 0;
     aTieneLin = "N";
     nConAu = 0;
     aSal = "";
     nSwMalpesa = 0;
     nSwConsulta = 0;
     nSwSolar = 0;
     nSwPrime = 0;

     fFechaAnt = @;

     nSwConta = 0;
     nSwHay   = 0;
     aPos = "";
     aPath = "";
     aSinError = "";
     aSql = "";
     aDef = "";
     aUsu = "";
     nContaLog = 0;
     aSer = "";
     aNum = "";
     aTipo = "";
     nTipo = 0;
     nResto = 0;
     nUniPromo = 0;
     nModoEntrada = 0;
     nDias        = 0;
     nOk          = 0;


 {-1}aMenu = "";
     aMenu1 = "";
     aMenu2 = "1";
     aMenu3 = "";
     aMenu4 = "PCAX";
     aMenu5 = " Papel ";
     aMenu6 = " Correo ";
     aMenu7 = " Ambos ";
     aMenu8 = " Cancelar ";

 {-1}aMenuA = "";
     aMenuA1 = "";
     aMenuA2 = "1";
     aMenuA3 = "";
     aMenuA4 = "PCASX";
     aMenuA5 = " Papel";
     aMenuA6 = " Correo";
     aMenuA7 = " Papel+Correo";
     aMenuA8 = " S/Conf.Cli.";
     aMenuA9 = " Cancelar";

 {-1}aMenuO  = "";                         || Con dsarchi unicamente OTP
     aMenuO1 = "";
     aMenuO2 = "1";
     aMenuO3 = "";
     aMenuO4 = "PSC";
     aMenuO5 = " Papel ";
     aMenuO6 = " S/Conf.Cli. ";
     aMenuO7 = " Cancelar ";

     nResp = 0;
     nSal = 0;

     aFichAnt   = "";
     nCmpAnt    = 0;

     aAlfaX     = "";

     fFechaBloq = @;
     aAlfa2     = "";
     aAlfa3     = "";
     aAlfa4     = "";
     aAlfa5     = "";
     aAlfa6     = "";
     aAlfa7     = "";
     aZona      = "";

     aTipoAnt = "";
     aEmailAnt = "";
     aEmail    = "";
     nSwOTP = 0;
     nEsTpv = 0;
     nSwRes         = 0;
     nSwFlag        = 0;
     nPos           = 0;
     aUs            = "";
     nAudito        = 0;
     nMult          = 0;
 {-1}menu           = "";
     menu1          = "2400";
     menu2          = "1";
     menu3          = "Contador:  ";
     menu4          = "AM";
     menu5          = " Automatico ";
     menu6          = " Manual ";
     so             = "";
     no             = "";
     contador       = 0;
     cont           = "";

     aSerie = ""; nContador = 0;

     fecha           = "          ";

     fechas          = "";
     FEstado         = 0;
     nSw             = 0;
     nCalc           = 0;
     aAlfa           = "";
     aAlfa1          = "";

     nModo           = 0;
     nCambFec        = 0;
     nNume           = 0;
     nContLin        = 0;
     nForma          = 0;
     nMargen         = 0;
     nImpo           = 0;
     nDto            = 0;
     aOpera          = "";
     aArti           = "";
     nTecla          = 0;
     nErrBloq        = 0;
     nVinculo        = 0;
     nfecha    = 0;

     nModo084 = 0;
     valor               = "";
     nLin = 0;
     div_act = 0;        || Divisa actualizada. Me sirve en un PARA para que


     fmes                = "  ";
     mensajei            = "2400NDesea imprimir esta factura? ";
     mensarec           = "2400NDesea dejar la factura como NO impresa y anular los recibos? ";
     informe             = "";
     informe1            = "agifa084";
     tato = 0;
     tota = 0;
     base = 0;
     vacio               = "";
     puente              = "";
     digito              = "";

     imneto              = 0;
     tf                  = 0;
     retencion           = 0;
     con                 = 0;
     margen              = 0;
     indtope             = 0;
     ind                 = 0;
     control             = 0;
     mes                 = 0;
     modo                = 0;
     iva_ant             = 0;
     contenido           = 0;
     importe             = 0;
     bloqueo = "0000Cliente Bloqueado en Riesgos !!";

    base0 = 0;
    base1 = 0;
    base2 = 0;
    base3 = 0;
    base4 = 0;
    base5 = 0;
    aBase    = "";
    aMas     = "";
    aFich    = "";
    nEmpresa     = 0;
    nTotal       = 0;
    nTotal1      = 0;
    nTotal2      = 0;
    nContratoOTP = 0;

    ModoEntrada = 0; Flag = 0;
    Modo = ""; Comodin = ""; Comodin1 = "";
    nEuro = 0;
    aEuro = "";
    nImpDiv = 0;
 {-1}aMenuMal = "";
     aMenuMal1 = "2400";
     aMenuMal2 = "1";
     aMenuMal3 = "Opciones: ";
     aMenuMal4 = "IO";
     aMenuMal5 = " Imprimir ";
     aMenuMal6 = " Incidencias Obra ";

 {-1}aMenuOtp = "";
     aMenuOtp1 = "2400";
     aMenuOtp2 = "1";
     aMenuOtp3 = "Opciones: ";
     aMenuOtp4 = "IO";
     aMenuOtp5 = " Imprimir ";
     aMenuOtp6 = " Auxiliar CEBI ";

     aNifQbf1   = "";
     aNifQbf2   = "";

     aFichero   = "";
     nHandle    = 0;
     nGrupoOTP  = 0;
     aSwParamOTP = "";

     &enPeriodoBaja = 0;
     &enTecla = 0;
     &eaFecAnt = "";
     &PRMNT_serie  = "";
     &PRMNT_numero = 0;
     &enObra = 0;
     &enReContab = 0;

     &enSwLiquid  = 0;
     &enSwEmpCerrada = 0;
     &PRMNT_aHisto = "";
     &uni_dt = 0;   || Unidades
     &uni_dt2 = 0;   || Unidades2
     &fed_dt = @;   || Fecha....
     &art_dt = "";  || Articulo.
     &cli_dt = "";  || Cliente..
     &fam_dt = "";  || Familia.
     &iva_dt = 0;   || Tipo Iva.
     &dtos_2 = 0;   || Descuento 2.
     &dto_pt = 0;   || Descuento Ptas.
     &dtos_1 = 0;   || Descuento 1.
     &pvp_ve = 0;   || Precio Venta.
     &tarifa = 0;   || Tarifa Cliente.
     &quedto = 0;   || 1=cli./art, 2=cli./familia, 3=cli./subfam.
     &gru_dt = "";  || Grupo Cliente.
     &nPromo = 0;
     &enMensaje = 0;
     &aParam    = "";
     &enModoCab84 = 0;
     &PRMNT_enError = 0;
     &eaSerTpv = "";
     &enNumero   = 0;
     &eaTipoImp  = "";
     &efFechaForm = @;
     &eaProg        = "";
     &enErrCarte    = 0;
     &nRieTotal = 0;
     &nRieUtili = 0;
     &aRieBloqu = "";
     &aBloquead = "";
     &eaTag     = "";
     &nMasRies  = 0;
     &aPrograma      = "";
     &fechae         = @;
     &SFactura       = "";
     &NFactura       = 0;
     &CFactura       = 0;
     &TAcuenta       = 0;
     &DesdeRec       = 0;
     &ser_fac         = "";
     &num_fac         = 0;
     &cli            = "";
     &ser            = "";
     &eaCodigo       = "";
     &eaTipoCodigo   = "CL";

     &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_Div      = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDiv   = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVis   = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVis = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVis   = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVis   = 0;   || Decimales en el Importe visual. (lineas)
     &ac_divisa = "N";   || Vale "S" cuando las divisas en ventas estan
                         || activadas y la serie es de divisas
     &pintado = 0;       || Sirve para controlar los pintados de las lineas
     &decim_divisa = 0;  || Decimales de la divisa
     &precio_divisa = 0; || Decimales del precio en divisa
     &decim_base = 0;    || Decimales de la moneda base
     &precio_base = 0;   || Decimales del precio en moneda base
                         || no salga hasta que este actualizada (div_act=1)
     &cli_divisa = "";   || Codigo de Cliente. Se pasa a CLIENTES/DIVISAS
     &divisa = "";       || Codigo de Divisa. Se pasa a ACTUAL. de DIVISAS
     &ser_alb            = "";
     &num_alb            = 0;
     &serie              = "";  ||
     &numero             = 0;  || Usadas en el subejecuta de impresion
     &reimpr             = "";  ||
     &ext1               = "";
     &dto_prom           = "N";
     &def_exp            = "N";
     &bl                 = "                              ";
     &codigo             = "";
     &descrip            = "";
     &ascii              = 0;
     &iva1               = 0;
     &iva2               = 0;
     &iva3               = 0;
     &iva4               = 0;
     &iva5               = 0;
     &re1                = 0;
     &re2                = 0;
     &re3                = 0;
     &re4                = 0;
     &re5                = 0;
     &precio             = 0;
     &dto                = 0;
     &dto1               = 0;
     &unid               = 0;
     &imptot             = 0;
     &tiva               = 0;
     &linea              = 0;
     &n_pre              = 0;
     &def_alm            = 0;
     &n_dec              = 0;
     &eaEmpresa  = "";
     &eaVarDni   = "";
     &enCalcCif  = 0;
     &enContrato = 0;
     &eaIBAN     = "";
     &enOk       = 0;
|FIN;

|INCLUYE i_varart;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ

|PROCESO letranif2;
     nSal = FSalida;

     |ABRE #6;
     #6#0 = #0#3;
     |LEE 000#6=;
     |CIERRA #6;
     eaPais = #6#205;

     |SI nSal = 10;
         eaVarDni   = #0Campo;
         enCalcCif  = 1;
         |HAZ CalculoNIFCIF;
         #0Campo = eaVarDni;
         |PINTA #0Campo;
         |ERROR;
         |ACABA;
     |FINSI;

     eaVarDni  = #0Campo;
     enCalcCif = 0;
     |HAZ CalculoNIFCIF;
     aNifQbf1 = #0Campo;   |QBF aNifQbf1;
     aNifQbf2 = eaVarDni;  |QBF aNifQbf2;

     |SI aNifQbf1 ! aNifQbf2; |Y aNifQbf1 ! "";
         |CONFI "0000SEl Nif puede ser Erroneo. Desea Calcularlo.";
         |SI FSalida = 0;
             #0Campo = eaVarDni;  |PINTA #0Campo;
             |ERROR;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO MiraVto84; |TIPO 6;
     nModo = (FEntrada / 100) ! 0;
     |SI FSalida = 9; |Y nModo = 4;
          ser_fac = #agifa084#48;
          num_fac = #agifa084#0;
          aPrograma = "agifa084";
          enModo = nModo;
          |CIERRAT #agifa084;
          |SUB_EJECUTA_NP "agifa133;NOMODI";
          |ABRET #agifa084;
          #agifa084#48 = ser_fac;;
          #agifa084#0 = num_fac;
          |LEE 000#agifa084.=;
     |FINSI;
|FPRC;

|PROCESO Promo084_7; |TIPO 7;
     |SI #41#129 = "S";
          |C_M #0#79, 1, "S";
     |FINSI;
|FPRC;

|PROCESO Divi84; |TIPO 0;
     |SI FSalida = 0;
          |HAZ EsGuerola;
          |SI FSalida = 0;
               |HAZ GuerEntObra84;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Promo084_0; |TIPO 0;
     |SI #0#79 ! 0;
          |ABRE #117;
          #117#0 = #0#79;
          |LEE 000#117=;
          |SI FSalida ! 0;
               |MENAV "0000Promocion Inexistente...";
               |ERROR;
          |FINSI;
          |CIERRA #117;
     |FINSI;
|FPRC;

|PROCESO BorraAsto;
   nModo = (FEntrada / 100) ! 0;

   |DDEF aAlfaX; |QBF aAlfaX;
   aAlfaX = aAlfaX + "agifa743.mas";
   |CARGA_DEF aAlfaX, Referen@;
   |SI FSalida = 0;
      |DFICE aAlfaX; |QBF aAlfaX; |PATH_DAT #Referen@#aAlfaX#;
      |ABRE #Referen@;
      #Referen@#0 = "FD";
      #Referen@#1 = #agifa084#48;
      #Referen@#2 = #agifa084#0;
      aAlfaX = #agifa084#1; |QBF aAlfaX; aAlfaX = aAlfaX % -104;
      #Referen@#3 = aAlfaX;
      |LEE 000#Referen@.=;
      |SI FSalida = 0; efFechaForm = #Referen@#5; |FINSI;
      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
   |FINSI;

   |ABRE #agifa722; |DDEFECTO #agifa722;
   #agifa722#0 = "FD";
   #agifa722#1 = #agifa084#48;
   #agifa722#2 = #agifa084#0;
   #agifa722#11 = 1;
   |LEE 000#agifa722.];
   FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
   |SI FSalida = 0; |Y #agifa722#0 = "FD"; |Y aAlfa = #agifa084#48; |Y nCalc = #agifa084#0; nSw = 1; |FINSI;
   |CIERRA #agifa722;


   |SI nSw = 1;
      |ABRE #agifa704;
      #agifa704#0 = #agifa722#10;
      |LEE 000#agifa704.=;
      |SI FSalida = 0;
         aFichAnt = #agifa704#16; nCmpAnt = #agifa704#17;
         #agifa704#16 = "agifa069"; #agifa704#17 = 0;
      |FINSI;
      |LIBERA #agifa704; |CIERRA #agifa704;

      aAlfa = "ac" + Usuario; |NOME_DAT #agifa716#aAlfa#;
      |DELINDEX #agifa716; |ABRE #agifa716;
      |DDEFECTO #agifa716;
      #agifa716#15 = #agifa722#10;  #agifa716#0  = 1;
      #agifa716#13 = "agifa069";    #agifa716#14 = 20;
      #agifa716#11 = "A";           #agifa716#12 = 5;
      #agifa716#3  = #agifa084#48;  #agifa716#4  = #agifa084#48;
      |GRABA 020#agifa716.n;

      |DDEFECTO #agifa716;
      #agifa716#15 = #agifa722#10;  #agifa716#0  = 2;
      #agifa716#13 = "agifa069";    #agifa716#14 = 0;
      #agifa716#11 = "N";           #agifa716#12 = 6;
      #agifa716#5  = #agifa084#0;   #agifa716#6  = #agifa084#0;
      |GRABA 020#agifa716.n;
      |LIBERA #agifa716; |CIERRA #agifa716;

      aSerie = #agifa084#48; nContador = #agifa084#0;
      |LIBERA #agifa084; |CIERRAT #agifa084;

      Comodin1 = #agifa084#1; |QBF Comodin1; Comodin1 = Comodin1 % -104;
      Comodin = #agifa722#10; |QBF Comodin;
      Comodin = "agifa711.tab;" + Comodin + ",B*" + Comodin1;
      enPeriodoBaja = #agifa722#9;
      |SUB_EJECUTA_NP Comodin;
      enPeriodoBaja = 0;
      |DELINDEX #agifa716;

      |ABRE #agifa704;
      #agifa704#0 = #agifa722#10;
      |LEE 000#agifa704.=;
      |SI FSalida = 0;
         #agifa704#16 = aFichAnt; #agifa704#17 = nCmpAnt;
      |FINSI;
      |LIBERA #agifa704; |CIERRA #agifa704;

      |ABRET #agifa084;
      #agifa084#48 = aSerie; #agifa084#0 = nContador;
      |LEE 121#agifa084.=;
   |FINSI;
   |SI PRMNT_enError = 0;
      #agifa084#39 = "N"; |GRABA 020#agifa084.a;

      |SI nModo = 3;
         |ABRE #agifa722;
         #agifa722#0 = "FD";
         #agifa722#1 = #agifa084#48;
         #agifa722#2 = #agifa084#0;
         #agifa722#11 = 1;
         |LEE 000#agifa722.];
         FEstado = FSalida;
         aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105;
         nCalc = #agifa722#2;
         FSalida = FEstado;
         |PARA; |SI FSalida = 0; |Y #agifa722#0 = "FD"; |Y aAlfa = #agifa084#48; |Y nCalc = #agifa084#0; |HACIENDO;
            |BORRA 020#agifa722.a;
            |LEE 000#agifa722.s;
            FEstado = FSalida;
            aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105;
            nCalc = #agifa722#2;
            FSalida = FEstado;
         |SIGUE;
         |CIERRA #agifa722;
      |FINSI;
   |FINSI;
   nSwRes = PRMNT_enError;
|FPRC;

|PROCESO BajaTpv;
     |SI nEsTpv = 0;
          eaSerTpv = "";
          |HAZ PideSerTpv;
          |SI eaSerTpv ! "";
               eaSerie = #0#48;
               enNumero = #0#0;
               |SUB_EJECUTA_NP "dsfa0009";
          |SINO;
               nSwFlag = 1; |ERROR; |ACABA;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo084_1; |TIPO 1;
     nSwFlag = 0;
|FPRC;

|PROCESO BajaDSpreven;
     |DBASS aBase;  |QBF aMas;
     aMas = aBase + "dspreven/def/pycm0011.mas";
     |XABRE "E", aMas, 0;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |HAZ EmpresaPrevencion;

     aMas = aBase + "dspreven/def/pycm0011.mas";
     |CARGA_DEF aMas, pycm0011@;
     aFich = aBase + "dspreven/fich/" + eaEmpresa + "/";
     |PATH_DAT #900 aFich;
     |ABRE #900;

     |SELECT #3#900;
     #900#9  = #0#48;
     #900#10 = #0#0;
     |LEE 101#900=;
     |SI FSalida = 0;
         |SI #900#19 = "A";
             |DDEFECTO #700;
             |SI modo = 3;
                 #900#9  = "";
                 #900#10 = 0;
                 |GRABA 020#900a;
                 |LIBERA #900;
             |FINSI;
         |SINO;
             |SI modo ! 3;
                 #700#0 = #900#0;
                 #700#1 = #900#1;
                 |SI #900#5 ! 0;  #700#3 = #900#5;  |FINSI;
                 |SI #900#6 ! 0;  #700#4 = #900#6;  |FINSI;
             |FINSI;

             |BORRA 020#900a;
             |LIBERA #900;
         |FINSI;
     |FINSI;

     |SELECT #4#900;
     #900#11 = #0#48;
     #900#12 = #0#0;
     |LEE 101#900=;
     |SI FSalida = 0;
         |SI #900#19 = "A";
             |DDEFECTO #700;
             |SI modo = 3;
                 #900#11 = "";
                 #900#12 = 0;
                 |GRABA 020#900a;
                 |LIBERA #900;
             |FINSI;
         |SINO;
             |SI modo ! 3;
                 #700#0 = #900#0;
                 #700#1 = #900#1;
                 |SI #900#5 ! 0;  #700#3 = #900#5;  |FINSI;
                 |SI #900#6 ! 0;  #700#4 = #900#6;  |FINSI;
             |FINSI;

             |BORRA 020#900a;
             |LIBERA #900;
         |FINSI;
     |FINSI;
     |CIERRA #900;

     |DESCARGA_DEF #pycm0011@;

     nModoEntrada = (FEntrada / 100) ! 0;
     |SI nModoEntrada ! 3; |ACABA; |FINSI;
|FPRC;

|PROCESO PermiteConta;
     enSwLiquid = 0; enSwEmpCerrada = 0;
     |HAZ MiraSiLiquidada;

     |HAZ EsOTP;
     |SI FSalida = 0;
         nCambFec = 0;
         |HAZ BloqDSPREVEN;
         |SI nErrBloq ! 0;
             FSalida = 1;
             |ACABA;
         |FINSI;
     |FINSI;

     |AVISO;
     |SI #41#247 = "N";
          |MENAV "0000Esta Factura Esta Contabilizada...";
          FSalida = 1;
     |SINO;
          |SI #41#247 = "R";
               aAlfa = Usuario % 810;
               |ABRE #133;
               #133#0 = aAlfa;
               |LEE 000#133=;
               |SI FSalida = 0;
                    |SI enSwEmpCerrada = 0;
                       |SI enSwLiquid = 1;
                          |MENAV "0000Esta Factura ha sido liquidada en contabilidad. Proceso cancelado.";
                          FSalida = 1;
                       |SINO;
                          |CONFI "0000NEsta Factura Esta Contabilizada: Desea Continuar? ";
                       |FINSI;
                    |SINO;
                       |MENAV "0000La empresa contable está cerrada. Proceso cancelado.";
                       FSalida = 1;
                    |FINSI;
               |SINO;
                    |MENAV "0000Esta Factura Esta Contabilizada...";
               |FINSI;
               aAlfa = FSalida;
               |CIERRA #133;
               FSalida = aAlfa;
          |SINO; || = "T"
               |SI enSwEmpCerrada = 0;
                  |SI enSwLiquid = 1;
                     |MENAV "0000Esta Factura ha sido liquidada en contabilidad. Proceso cancelado.";
                     FSalida = 1;
                  |SINO;
                     |CONFI "0000NEsta Factura Esta Contabilizada: Desea Continuar? ";
                  |FINSI;
               |SINO;
                  |MENAV "0000La empresa contable está cerrada. Proceso cancelado.";
                  FSalida = 1;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|CALCULO bajarec; |TIPO 2;
     modo = (FEntrada / 100) ! 0;
     nForma = 0 +. 1;
     enModoCab84 = modo;

     |SI modo = 1; nSwFlag = 0; |FINSI;
     |SI nSwFlag = 1; |ACABA; |FINSI;

     |ABRE #41; |LEE 000#41p; |CIERRA #41;
     |HAZ ControlUsuFT;
     |SI enErr ! 0; nSwFlag = 1; |ERROR; |ACABA; |FINSI;

     |SI modo = 3;
          |HAZ CheqRecticativa;
          |SI enErr ! 0; nSwFlag = 1; |ERROR; |ACABA; |FINSI;


     |FINSI;

     |SI #0#66 = 0; || chequea el cambio
          |ABRE #agifa324;
          #agifa324#0 = #0#65;
          |LEE 020#agifa324.=;
          |SI FSalida = 0;
               #0#66 = #agifa324#2;
          |FINSI;
          |CIERRA #agifa324;
     |FINSI;

     |SI nForma < 0;
        |HAZ EsOTP;
        |SI FSalida = 0;
           || Si es OTP compruebo el bloqueo de la facturacion en
           ||     modo modificacion y baja, ya que el alta est  controlada
           ||     al entrar en el proceso 'LeeDesde' y por este TIPO 2 no
           ||     entrar¡a
           nModo = (FEntrada / 100) ! 0;
           |SI nModo ! 4; |Y nSwConsulta = 1;
              |MENAV "    Está activado el modo CONSULTA.  Pruebe a desactivarlo saliendo y volviendo a acceder a la opción."
              |ERROR; |ACABA;
           |FINSI;
        |FINSI;
     |FINSI;

     |SI nForma < 0;
        |SI #agifa084#39 = "S";
           fFechaBloq = "01.01.0000";
           |ABRE #agifa722;
           #agifa722#0 = "FD";
           #agifa722#1 = #agifa084#48;
           #agifa722#2 = #agifa084#0;
           #agifa722#11 = 1;
           |LEE 000#agifa722.];
           aAlfa2 = #agifa722#1;  |QBF aAlfa2;
           aAlfa3 = #agifa084#48; |QBF aAlfa3;
           |PARA; |SI FSalida = 0; |Y #agifa722#0 = "FD"; |Y aAlfa2 = aAlfa3; |Y #agifa722#2 = #agifa084#0; |HACIENDO;
              |ABRE #agifa704;
              #agifa704#0 = #agifa722#10;
              |LEE 000#agifa704.=;
              |SI FSalida ! 0; |DDEFECTO #agifa704; |FINSI;
              |CIERRA #agifa704;
              aAlfa = #agifa704#6; |QBF aAlfa;
              aAlfa = aAlfa - "contagen";
              |SI FSalida ! 0;
                 aAlfa = #agifa704#6; |QBF aAlfa;
                 aAlfa = aAlfa + "def/canempre.mas";
                 |CARGA_DEF aAlfa, Referen@;
                 |SI FSalida = 0;
                    aAlfa = #agifa704#6; |QBF aAlfa;
                    aAlfa = aAlfa + "fich/";
                    |PATH_DAT #Referen@#aAlfa#;
                    |ABRE #Referen@;
                    #Referen@#2 = #agifa722#8;
                    #Referen@#3 = #agifa722#9;
                    |LEE 000#Referen@.=;
                    |SI FSalida ! 0; |DDEFECTO #Referen@; |FINSI;
                    |SI #Referen@#34 ! "01.01.0000";
                       fFechaBloq = #Referen@#34; |SAL;
                    |FINSI;
                    |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
                 |FINSI;
              |FINSI;
              |LEE 000#agifa722.s;
              aAlfa2 = #agifa722#1;  |QBF aAlfa2;
              aAlfa3 = #agifa084#48; |QBF aAlfa3;
           |SIGUE;
           |CIERRA #agifa722;
           |SI fFechaBloq ! "01.01.0000";
              |SI #agifa084#1 [ fFechaBloq;
                 aAlfa = "    Factura contabilizada y con fecha anterior a bloqueo contabilidad [" + fFechaBloq + "]";
                 |MENAV aAlfa;
                 nSwFlag = 1; |ERROR; |ACABA;
              |FINSI;
           |FINSI;
        |FINSI;
     |FINSI;

     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |HAZ EsTecatel;
     |SI FSalida = 0;
          efFecha = #0#1;
          |HAZ TecaModiFac;
          |SI FSalida ! 0; nSwFlag = 1; |ERROR; |ACABA; |FINSI;
     |FINSI;
     |SI modo = 2; |Y nForma < 0;
          |HAZ EsConstru;
          |SI FSalida = 0;
               |HAZ AvisoAsistente;
          |FINSI;
     |FINSI;
     |SI modo = 2; |O modo = 3;
          |SI nForma < 0;
               |HAZ EsConstru;
               |SI FSalida = 0;
                    |HAZ ConstruCheqModi;
                    |SI nSwFlag = 1; |ERROR; |ACABA; |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI modo = 3;
          eaSer = #0#48;
          enDocu = #0#0;
          efFec = #0#1;
          |HAZ MiraHisF;
          |SI enErrHis ! 0; nSwFlag = 1; |ERROR; |ACABA; |FINSI;

          |HAZ EsSolar;
          |SI FSalida = 0;
               |HAZ SolarBajaCto;
               |SI FSalida ! 0; nSwFlag = 1; |ERROR; |ACABA; |FINSI;
               |HAZ SolarBaja;
               |SI FSalida ! 0; nSwFlag = 1; |ERROR; |ACABA; |FINSI;
          |FINSI;

          |HAZ EsConstru;
          |SI FSalida = 0;
               |HAZ BajaAsistente;
          |FINSI;

          |HAZ EsSecap;
          |SI FSalida = 0;
               |HAZ SecapUltima;
               |SI nSwFlag = 1; |ERROR; |ACABA; |FINSI;
          |FINSI;

          |HAZ EsOTP;
          |SI FSalida = 0;
              |HAZ OTPUltima;
              |SI nSwFlag = 1; |ERROR; |ACABA; |FINSI;
          |FINSI;
     |FINSI;

     |SI nForma = -1;
          |ABRE #501;
          |SELECT #2#501;
          #501#35 = "F";
          #501#57 = #0#48;
          #501#58 = #0#0;
          |LEE 000#501=;
          nEsTpv = FSalida;
          |SI FSalida = 0;
               |SI modo = 2;
                    |MENAV "0000Esta factura proviene del TPV...";
                    FSalida = 1;
               |SINO;
                    |CONFI "0000NEsta factura proviene del TPV. Continuar...";
               |FINSI;
               |SI FSalida ! 0;
                    nSwFlag = 1; |ERROR; |ACABA;
               |FINSI;
          |FINSI;
          |CIERRA #501;
          nSwConta = 0;
          |SI #0#39 = "S";
               |HAZ PermiteConta;
               |SI FSalida ! 0; nSwFlag = 1; |ERROR; |ACABA; |FINSI;
               nSwConta = 1;
          |FINSI;
          |SI #41#47 = "S"; |Y #0#10 = "S";
               |AVISO;
               |CONFI "0000NDesea dejar la factura como NO impresa y anular los recibos?  ";
               |SI FSalida ! 0; nSwFlag = 1; |ERROR; |ACABA; |FINSI;

               eaProg = "agifa084";
               |HAZ MiraRecVenta;
               |SI enErrCarte ! 0;
                    |MENAV "0000Recibos con movimientos: NO SE DARA DE BAJA";
                    nSwFlag = 1; |ERROR; |ACABA;
               |FINSI;

               |HAZ BajaTpv;
               |SI nSwFlag = 1; |ERROR; |ACABA; |FINSI;

               |SI #0#39 = "S"; |HAZ BorraAsto; |FINSI;
               |SI nSwRes < 0; nSwFlag = 1; |ERROR; |ACABA; |FINSI;
               eaProg = "agifa084"; |HAZ BorraRecVenta;
          |SINO;
               |HAZ BajaTpv;
               |SI nSwFlag = 1; |ERROR; |ACABA; |FINSI;

               |SI #0#39 = "S"; |HAZ BorraAsto; |FINSI;
               |SI nSwRes < 0; nSwFlag = 1; |ERROR; |ACABA; |FINSI;
          |FINSI;
          |HAZ BorraVenciDir;
          #0#10 = "N"; |GRABA 020#0a;
     |SINO;
          |SI nSwConta = 1;
             aAlfa = "    NEsta factura estaba contabilizada. " + &191 + " Volver a contabilizar ? ";
             |CONFI aAlfa;
             |SI FSalida = 0;
                nModo = (FEntrada / 100) ! 0;

                aAlfa1 = #agifa084#1; |QBF aAlfa1; aAlfa1 = aAlfa1 % -104; nSwHay = 0;

                efFechaForm = "01.01.0000";
                enReContab = 1;
                |DDEF aAlfaX; |QBF aAlfaX;
                aAlfaX = aAlfaX + "agifa743.mas";
                |CARGA_DEF aAlfaX, Referen@;
                |SI FSalida = 0;
                   |DFICE aAlfaX; |QBF aAlfaX; |PATH_DAT #Referen@#aAlfaX#;
                   |ABRE #Referen@;
                   #Referen@#0 = "FD";
                   #Referen@#1 = #agifa084#48;
                   #Referen@#2 = #agifa084#0;
                   aAlfaX = #agifa084#1; |QBF aAlfaX; aAlfaX = aAlfaX % -104;
                   #Referen@#3 = aAlfaX;
                   |LEE 000#Referen@.=;
                   |SI FSalida = 0; efFechaForm = #Referen@#5; |FINSI;
                   |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
                |FINSI;

                |ABRE #agifa722; |DDEFECTO #agifa722;
                #agifa722#0 = "FD";
                #agifa722#1 = #agifa084#48;
                #agifa722#2 = #agifa084#0;
                #agifa722#11 = 1;
                |LEE 000#agifa722.];
                FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
                |SI FSalida = 0; |Y #agifa722#0 = "FD"; |Y aAlfa = #agifa084#48; |Y nCalc = #agifa084#0;
                   nSwHay = 1;
                |FINSI;
                |CIERRA #agifa722;

                aAlfa1 = "N";
                |SI nSwHay = 1;
                   aAlfa = "ac" + Usuario; |NOME_DAT #agifa716#aAlfa#;
                   |DELINDEX #agifa716; |ABRE #agifa716;

                   |ABRE #agifa704;
                   #agifa704#0 = #agifa722#10;
                   |LEE 101#agifa704.=;
                   |SI FSalida = 0;
                      aFichAnt = #agifa704#16; nCmpAnt = #agifa704#17;

                      |DDEFECTO #agifa716;
                      #agifa716#15 = #agifa722#10;  #agifa716#0  = 1;
                      #agifa716#13 = "agifa084";    #agifa716#14 = 48;
                      #agifa716#11 = "A";           #agifa716#12 = 5;
                      #agifa716#3  = #agifa084#48;  #agifa716#4  = #agifa084#48;
                      |GRABA 020#agifa716.n;

                      |DDEFECTO #agifa716;
                      #agifa716#15 = #agifa722#10;  #agifa716#0  = 2;
                      #agifa716#13 = "agifa084";    #agifa716#14 = 0;
                      #agifa716#11 = "N";           #agifa716#12 = 6;
                      #agifa716#5  = #agifa084#0;   #agifa716#6  = #agifa084#0;
                      |GRABA 020#agifa716.n;
                      |LIBERA #agifa716; |CIERRA #agifa716;
                      #agifa704#16 = "agifa084"; #agifa704#17 = 0;
                      |GRABA 020#agifa704.a;
                   |FINSI;
                   |LIBERA #agifa704; |CIERRA #agifa704;

                   aSerie = #agifa084#48; nContador = #agifa084#0;
                   |GRABA 020#agifa084.a;
                   |LIBERA #agifa084; |CIERRAT #agifa084;

                   Comodin1 = #agifa084#1; |QBF Comodin1; Comodin1 = Comodin1 % -104;
                   Comodin = #agifa722#10; |QBF Comodin;
                   Comodin = "agifa711.tab;" + Comodin;
                   aAlfa1 = "S";
                   |SUB_EJECUTA_NP Comodin;
                   |DELINDEX #agifa716;

                   |ABRE #agifa704;
                   #agifa704#0 = #agifa722#10;
                   |LEE 101#agifa704.=;
                   |SI FSalida = 0;
                      #agifa704#16 = aFichAnt; #agifa704#17 = nCmpAnt;
                      |GRABA 020#agifa704.a;
                   |FINSI;
                   |LIBERA #agifa704; |CIERRA #agifa704;

                   |ABRET #agifa084;
                   #agifa084#49 = aSerie; #agifa084#0 = nContador;
                   |LEE 121#agifa084.=;
                |FINSI;
                |SI PRMNT_enError = 0;
                   #agifa084#39 = aAlfa1; |GRABA 020#agifa084.a;
                |FINSI;
                nSw = PRMNT_enError;
                enReContab = 0;
             |SINO;
                |DDEF aAlfaX; |QBF aAlfaX;
                aAlfaX = aAlfaX + "agifa743.mas";
                |CARGA_DEF aAlfaX, Referen@;
                |SI FSalida = 0;
                   |DFICE aAlfaX; |QBF aAlfaX; |PATH_DAT #Referen@#aAlfaX#;
                   |ABRE #Referen@;
                   #Referen@#0 = "FD";
                   #Referen@#1 = #agifa084#48;
                   #Referen@#2 = #agifa084#0;
                   aAlfaX = #agifa084#1; |QBF aAlfaX; aAlfaX = aAlfaX % -104;
                   #Referen@#3 = aAlfaX;
                   |LEE 000#Referen@.=;
                   |SI FSalida = 0; |BORRA 020#Referen@.a; |FINSI;
                   |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
                |FINSI;

                |ABRE #agifa722;
                #agifa722#0 = "FD";
                #agifa722#1 = #agifa084#48;
                #agifa722#2 = #agifa084#0;
                #agifa722#11 = 1;
                |LEE 000#agifa722.];
                FEstado = FSalida;
                aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105;
                nCalc = #agifa722#2;
                FSalida = FEstado;
                |PARA; |SI FSalida = 0; |Y #agifa722#0 = "FD"; |Y aAlfa = #agifa084#48; |Y nCalc = #agifa084#0; |HACIENDO;
                   |BORRA 020#agifa722.a;
                   |LEE 000#agifa722.s;
                   FEstado = FSalida;
                   aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105;
                   nCalc = #agifa722#2;
                   FSalida = FEstado;
                |SIGUE;
                |CIERRA #agifa722;
             |FINSI;
          |FINSI;
          nSwConta = 0;
     |FINSI;

     |HAZ fcaccli;

     |HAZ EsClipresa;
     |SI FSalida = 0; |Y nForma = 1;
          |HAZ ClipreComi;
     |FINSI;

     |HAZ EsOTP;
     |SI FSalida = 0; |Y nForma ! 1;
          |HAZ BajaDSpreven;
     |FINSI;

     ModoEntrada = (FEntrada / 100) ! 0; Flag = 0 +. 1;
     |SI #agifa084#82 ! 0;
        |SI ModoEntrada = 2; |Y Flag < 0; |ACABA; |FINSI;
        aAlfa = "ac" + Usuario; |NOME_DAT #agifa716#aAlfa#;
        |DELINDEX #agifa716; |ABRE #agifa716;
        |DDEFECTO #agifa716;
        #agifa716#15 = #agifa084#86; #agifa716#0 = 1;
        #agifa716#13 = "agifa084";    #agifa716#14 = 48;
        #agifa716#11 = "A";
        #agifa716#3 = #agifa084#48; #agifa716#4 = #agifa084#48;
        |GRABA 020#agifa716.n;

        |DDEFECTO #agifa716;
        #agifa716#15 = #agifa084#86; #agifa716#0 = 2;
        #agifa716#13 = "agifa084"; #agifa716#14 = 0;
        #agifa716#11 = "N";
        #agifa716#5 = #agifa084#0; #agifa716#6 = #agifa084#0;
        |GRABA 020#agifa716.n;

        |LIBERA #agifa716;
        |CIERRA #agifa716;
        |SI ModoEntrada = 3; Modo = ",B"; |SINO; Modo = ""; |FINSI;
        Comodin = #agifa084#86; |QBF Comodin;
        Comodin = "agifa711.tab;" + Comodin + Modo;
        |SUB_EJECUTA_NP Comodin;
        |DELINDEX #agifa716;
     |FINSI;
     |SI nForma = -1;
          ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄModlo '000car'
          |HAZ EsCarnicas;
          |SI FSalida = 0;
               |HAZ BajaCarnicasFD;
          |FINSI;
          ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |FINSI;
     |SI modo = 3;
          |HAZ BorraRecticativa;

          |HAZ EsReysor;
          |SI FSalida = 0;
               |HAZ ObraBajaFD;
          |FINSI;
          |HAZ EsTagloma;
          |SI FSalida = 0;
               |HAZ TagBajaFac;
          |FINSI;
          |HAZ EsAbymatic;
          |SI FSalida = 0;
               |HAZ AbyBajaFac;
          |FINSI;

          |HAZ EsGuerola;
          |SI FSalida = 0;
               |HAZ GuerBorObra84;
               |HAZ GuerBorCerti;
          |FINSI;

          |HAZ EsOTP;
          |SI FSalida = 0;
               eaSerie = #0#48;
               enNumero = #0#0;
               |SUB_EJECUTA_NP "otpm0003;BAJA";
          |FINSI;

          |HAZ EsSolar;
          |SI FSalida = 0;
               |HAZ SolarBorFac;
          |FINSI;
          |HAZ EsSecap;
          |SI FSalida = 0;
               |HAZ SecapAnuFac;
               |HAZ SecapModConta;
          |FINSI;
          |HAZ EsJumifor;
          |SI FSalida = 0;
               |HAZ JumiBorFac;
          |FINSI;
     |FINSI;
     |HAZ EsWeb;
     |SI FSalida = 0;
          |HAZ DocWeb;
     |FINSI;
|FCAL;

|PROCESO Chequea71;
     nOk = 0;
     |SI #Referen@#3 > "01.01.0000";  nOk = 1;  |FINSI;
     |SI #Referen@#5 > "01.01.0000";  nOk = 1;  |FINSI;

     |SI nOk = 0;  |ACABA;  |FINSI;

     |SI #Referen@#6 = "B";
         |SI nCambFec = 1;
             |SI #agifa084#1 [ #Referen@#3;
                 nDias = #Referen@#3;
                 nDias = nDias + 1;
                 #agifa084#1 = nDias;
             |FINSI;
         |FINSI;

         |SI #agifa084#1 ] #Referen@#5;  |Y #agifa084#1 [ #Referen@#3;
             aAlfa = "0000Serie bloqueada por " + #Referen@#4;  |QBF aAlfa;
             |SI #Referen@#5 > "01.01.0000";
                 aAlfa = aAlfa + " bloqueo desde el dia " + #Referen@#5;
                 aAlfa = aAlfa + " hasta el dia " + #Referen@#3;
             |SINO;
                 aAlfa = "0000Serie bloqueada por " + #Referen@#4;  |QBF aAlfa;
                 aAlfa = aAlfa + " bloqueo hasta el dia " + #Referen@#3;
             |FINSI;

             nErrBloq = 1;
         |FINSI;
     |FINSI;

     |SI #Referen@#6 = "P";
         |SI nCambFec = 1;
             |SI #agifa084#1 < #Referen@#5;  |O #agifa084#1 > #Referen@#3;
                 #agifa084#1 = #Referen@#5;
             |FINSI;
         |FINSI;

         |SI #agifa084#1 < #Referen@#5;  |O #agifa084#1 > #Referen@#3;
             aAlfa = "0000Serie con fechas permitidas por " + #Referen@#4;  |QBF aAlfa;
             aAlfa = aAlfa + " se permite fecha del dia " + #Referen@#5;
             aAlfa = aAlfa + " hasta el dia " + #Referen@#3;

             nErrBloq = 1;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Chequea70;
     nOk = 0;
     |SI #Referen@#2 > "01.01.0000";  nOk = 1;  |FINSI;
     |SI #Referen@#4 > "01.01.0000";  nOk = 1;  |FINSI;

     |SI nOk = 0;  |ACABA;  |FINSI;

     |SI #Referen@#5 = "B";
         |SI nCambFec = 1;
             |SI #agifa084#1 [ #Referen@#2;
                 nDias = #Referen@#2;
                 nDias = nDias + 1;
                 #agifa084#1 = nDias;
             |FINSI;
         |FINSI;

         |SI #agifa084#1 ] #Referen@#4;  |Y #agifa084#1 [ #Referen@#2;
             aAlfa = "0000Serie bloqueada por " + #Referen@#3;  |QBF aAlfa;
             |SI #Referen@#4 > "01.01.0000";
                 aAlfa = aAlfa + " bloqueo desde el dia " + #Referen@#4;
                 aAlfa = aAlfa + " hasta el dia " + #Referen@#2;
             |SINO;
                 aAlfa = aAlfa + " bloqueo hasta el dia " + #Referen@#2;
             |FINSI;

             nErrBloq = 1;
         |FINSI;
     |FINSI;

     |SI #Referen@#5 = "P";
         |SI nCambFec = 1;
             |SI #agifa084#1 < #Referen@#4;  |O #agifa084#1 > #Referen@#2;
                 #agifa084#1 = #Referen@#4;
             |FINSI;
         |FINSI;

         |SI #agifa084#1 < #Referen@#4;  |O #agifa084#1 > #Referen@#2;
             aAlfa = "0000Serie con fechas permitidas por " + #Referen@#3;  |QBF aAlfa;
             aAlfa = aAlfa + " se permite fecha del dia " + #Referen@#4;
             aAlfa = aAlfa + " hasta el dia " + #Referen@#2;

             nErrBloq = 1;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO BloqDSPREVEN;
     nErrBloq = 0;

     |DBASS aBase;  |QBF aMas;
     aMas = aBase + "dspreven/def/maesm071.mas";
     |XABRE "E", aMas, 0;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aPathDSPREVEN = aBase + "dspreven/fich/";

     |CARGA_DEF aMas, Referen@;
     |PATH_DAT #Referen@#aPathDSPREVEN#;

     |ABRE #Referen@;
     #Referen@#0 = #48#0;
     #Referen@#1 = #agifa084#48;
     |LEE 000#Referen@.=;
     |SI FSalida = 0;
         |HAZ Chequea71;
     |FINSI;
     |CIERRA #Referen@;
     |DESCARGA_DEF #Referen@;

     |SI nErrBloq = 1;
         |MENAV aAlfa;

         |ACABA;
     |FINSI;

     aMas = aBase + "dspreven/def/maesm070.mas";
     |CARGA_DEF aMas, Referen@;
     |PATH_DAT #Referen@#aPathDSPREVEN#;

     |ABRE #Referen@;
     #Referen@#0 = #48#0;
     |LEE 000#Referen@.=;
     |SI FSalida = 0;
         |HAZ Chequea70;
     |FINSI;
     |CIERRA #Referen@;
     |DESCARGA_DEF #Referen@;

     |SI nErrBloq = 1;
         |MENAV aAlfa;
     |FINSI;
|FPRC;

|CALCULO fecfc;|TIPO 7;
     modo = (FEntrada / 100) ! 0;

     |HAZ EsTagloma;
     |SI FSalida = 0;
          |MENSA "0000<F5> Documento de regularizacion";
     |FINSI;

     |HAZ EsOTP;
     |SI FSalida = 0;
         nCambFec = 0;
         |SI modo = 1;  nCambFec = 1;  |FINSI;
         |HAZ BloqDSPREVEN;
         |SI nErrBloq ! 0;
             |PTEC 807;
             |ACABA;
         |FINSI;
     |FINSI;
|FCAL;

|PROCESO ActArti;
     fmes = #0#1 % A402;
     mes = fmes - 1;
     mes = mes * 5;
     mes = mes + 35;
     #2#0 = #3#2;
     |LEE 101#2=;
     |SI FSalida = 0;
          |SI #2#194 = 2;
               nImpo = ((((#3#30 * #3#6) < #3#8) < #3#21) < #0#5) < #0#32;
          |SINO;
               nImpo = ((((#3#5 * #3#6) < #3#8) < #3#21) < #0#5) < #0#32;
          |FINSI;
          |SI #41#115 = "S";
               nImpo = nImpo < #0#7;
          |FINSI;
          nMargen = nImpo - #3#14;
          #2mes = #2mes + (nImpo * nForma);
          #2#95 = #2#95 + (nImpo * nForma);
          mes = mes + 1;
          #2mes = #2mes + (nMargen * nForma);
          #2#96 = #2#96 + (nMargen * nForma);
          |GRABA 020#2a;
     |FINSI;
     |LIBERA #2;

     efFecha = #0#1;
     eaArticulo = #3#2;
     enImpVta = (nImpo * nForma);
     enImpMar = (nMargen * nForma);
     |HAZ AcumulaArt;
|FPRC;

|CALCULO fcaccli;
     nForma = 0 +. 1;
     modo = (FEntrada / 100) ! 0;

     |ABRE #6;
     #6#0 = #0#3;
     |LEE 121#6=;
     |SI 0 = FSalida;
          fmes = #0#1 % A402;
          mes = fmes - 1;
          mes = mes * 4;
          mes = mes + 54;
          imneto = #0#15 - #0#25;
          |SI #41#115 = "N";
               nImpo = (imneto * 100) / (100 - #0#7);
               nDto = #0#25 + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
               nDto = #0#25;
          |FINSI;
          #6mes = #6mes +. nImpo; || imneto;
          mes = mes + 1;
          #6mes = #6mes +. nDto;  || #0#25;
          mes = mes + 1;
          #6mes = #6mes +. #0#37;
          #6#102 = #6#102 +. nImpo; || imneto;
          #6#103 = #6#103 +. nDto;  || #0#25;
          #6#104 = #6#104 +. #0#37;
          mes = FEntrada / 100;
          mes = mes ! 0;
          |SI 1 = mes;
               #6#45 = #0#1;
               #6#46 = imneto;
          |FINSI;
          #6#110 = #6#110 +. imneto;
          imneto = imneto + #0#24;
          |GRABA 020#6a;
          |LIBERA #6;

          enImpCliCom = nImpo * nForma;
          enImpCliDto = nDto * nForma;
          enImpCliMar = #0#37 * nForma;
          enImpCliFac = imneto * nForma;
          eaCliente = #0#3;
          efFecha = #0#1;
          |HAZ AcumulaCli;
     |FINSI;
     |CIERRA #6;

     |ABRE #8;
     #8#0 = #0#6;
     |LEE 121#8=;
     |SI 0 = FSalida;
           imneto = #0#15 - #0#25;
           fmes = #0#1 % A402;
           mes = fmes - 1;
           mes = mes * 2;
           mes = mes + 11;
           #8mes = #8mes +. #0#26;
           retencion = #8mes % #8#39;
           mes = mes + 1;
           #8mes = #8mes +. imneto;
           #8#35 = #8#35 +. #0#26;
           #8#36 = #8#36 +. imneto;
           mes = fmes - 1;
           mes = mes + 40;
           #8mes = retencion;
           retencion = #8#35 % #8#39;
           #8#52 = retencion;
           |GRABA 020#8a;
           |LIBERA #8;

          enImpRepComi = #0#26 * nForma;
          enImpRepVta = imneto * nForma;
          enImpRepRete = retencion * nForma;
          eaRepre = #0#6;
          efFecha = #0#1;
          |HAZ AcumulaRep;
     |FINSI;
     |CIERRA #8;
     ||***************** CALCULO DEL RIESGO;
     |ABRE #2;
     |BUCLELIN 2 ActArti #0;
     |CIERRA #2;
     |SI #41#47 = "S";  ||ÄÄÄÄÄÄÄÄÄÄÄ Acumula en riesgos Si Crea Recibo
          eaTag = "FC";  |HAZ Riesgos;
     |FINSI;
|FCAL;

|CALCULO cogecon0;|TIPO 0;
     control = 0;
     nModo = (FEntrada / 100) ! 0;
     |SI #41#26 = "S"; |Y nModo = 1;  || Fac Directa = Fact. Venta
          |ABRE #134;
          #134#49 = #0#48;
          #134#0 = #0#0;
          |LEE 101#134=;
          |SI FSalida = 0;
               |MENAV "0000Numero factura existente en Facturas Venta...";
               |ERROR;
          |FINSI;
          |CIERRA #134;
     |FINSI;
     |SI nModo = 1;
          |ABRE #40;
          #40#26 = #0#48;
          |LEE 000#40=;
          |SI FSalida = 0; |Y #40#30 = "S";
               #0#12 = 0; |PINTA #0#12;
               #0#14 = 0; |PINTA #0#14;
          |FINSI;
          |CIERRA #40;
     |FINSI;
|FCAL;

|PROCESO DefeFP;
     |SI #41#195 = "S";
          #0#8 = #41#196;
     |SINO;
          |ABRE #6;
          #6#1 = #0#3;
          |LEE 000#6=;
          |CIERRA #6;
          #0#8 = #6#20;
     |FINSI;
     |PINTA #0#8;
|FPRC;

|CALCULO pedcon0;|TIPO 6;
con = FEntrada / 100;
con = con ! 0;
|SI con = 2;|Y #0Campo ! Contenido;
  control = 1;
|FINSI;
|FCAL;

|| **********************************************************
|CALCULO acttl;
     |HAZ TotalLin69;
     |GRABA 001#3a;
     ||-----------------------------Calcula la Cabecera
     |HAZ CalCabAgifa084;

     ||-----------------------------Modifi His
     |HAZ ModiHistoFC;
|FCAL;

|DEFBUCLE agifa069;
     #3#1;
     ;
     #0#48, #0#0, 001;
     #0#48, #0#0, 999;
     ;
     NULL, acttl;
|FIN;

|CALCULO actal;
    |MENSA "0000Recalculando factura...";
    |HAZ LimCabAgifa084;
    |BUCLE agifa069;
    |MENSA "0000.";
|FCAL;

|PROCESO TieneLin084;
     aTieneLin = "S";
|FPRC;

|PROCESO pycm0007;
     |SI #900#72 ! aZona;  |Y #900#161 ! aZona;
         |ACABA;
     |FINSI;

     |SI #900#112 = "A";  |ACABA;  |FINSI;

     nContratoOTP = #900#0;
     nNume        = nNume + 1;
|FPRC;

|DEFBUCLE pycm0007;
     #900#3002;
     ;
     nEmpresa, 000000;
     nEmpresa, 999999;
     ;
     NULL, pycm0007;
|FIN;

|PROCESO Baja900;
     #900#0   = 1;
     #900#3   = nEmpresa;
|FPRC;

|PROCESO Alta900;
     #900#0   = 999999;
     #900#3   = nEmpresa;
|FPRC;

|PROCESO ChequeaCuota;
     aZona    = ("00000" + #48#0) % -105;
     nVinculo = 0;

     |C_M #700#3, 1, "S";
     |C_M #700#4, 1, "S";

     aMas = aBase + "dspreven/def/pycm0011.mas";
     |CARGA_DEF aMas, pycm0011@;
     aFich = aBase + "dspreven/fich/" + eaEmpresa + "/";
     |PATH_DAT #900 aFich;
     |ABRE #900;
     #900#0 = #700#0;
     #900#1 = #700#1;
     #900#2 = aZona;
     |LEE 000#900=;
     |SI FSalida = 0;
         |SI #900#10 ! 0;  |O #900#12 ! 0;
             |MENAV "0000Ya existe cuota con esa fecha y esta facturada. Debera indicar una fecha sin cuotas";
             |ERROR;
         |SINO;
             |CONFI "0000SExiste una cuota sin facturar con la misma fecha, vincular con dicha cuota?";
             |SI FSalida = 0;
                 #700#3 = #900#5;   |PINTA #700#3;
                 #700#4 = #900#6;   |PINTA #700#4;

                 |C_M #700#3, 1, "N";
                 |C_M #700#4, 1, "N";

                 nVinculo = 1;
             |SINO;
                 |MENAV "0000Debera indicar una fecha sin cuotas";
                 |ERROR;
             |FINSI;
         |FINSI;
     |FINSI;
     |CIERRA #900;
     |DESCARGA_DEF #pycm0011@;
|FPRC;

|PROCESO Tipo12Fotpw2;  |TIPO 12;
     nTotal1 = #700#2 ! 2;
     nTotal2 = (#700#3 + #700#4) ! 2;
     nTotal  = nTotal1 - nTotal2;

     |SI nTotal < 0;
         nTotal = -nTotal;
     |FINSI;

     |SI nTotal > 0.5;
         |MENAV "0000 El Importe de Tecnicas + Importe de Vigilancia debe ser igual Importe Factura";
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO BuscaContratoOTP;
     |SI nModo = 1;
         |DDEFECTO #700;
     |FINSI;

     |SI #700#0 = 0;
         |DDEFECTO #700;
     |FINSI;

     |DBASS aBase;  |QBF aMas;
     aMas = aBase + "dspreven/def/pycm0011.mas";
     |XABRE "E", aMas, 0;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |HAZ EmpresaPrevencion;

     aMas = aBase + "dspreven/def/pycm0007.mas";
     |CARGA_DEF aMas, pycm0011@;
     aFich = aBase + "dspreven/fich/" + eaEmpresa + "/";
     |PATH_DAT #900 aFich;

     nContratoOTP = #700#0;
     aZona        = ("00000" + #48#0) % -105;

     |SI #700#0 = 0;
         nNume        = 0;
         nEmpresa     = #0#3;
         nContratoOTP = 0;
         |BUCLE pycm0007;

         |SI nNume = 0;
             |MENAV "0000No hay contrato registrado asociado al Cliente.";
             |DESCARGA_DEF #pycm0011@;
             |ACABA;
         |FINSI;

         |SI nNume > 1;
             nContratoOTP = 0;
             |MENAV "0000El cliente tiene varios contratos. Por favor seleccione uno.";

             |ABRE #900;
             |CONSULTA_F_CLAVE #3#900, Baja900, Alta900;
             |SI FSalida = 0;
                 nContratoOTP = #900#0;
             |FINSI;
             |CIERRA #900;
         |FINSI;
     |FINSI;

     |SI nContratoOTP = 0;
         |MENAV "0000No se ha seleccionado contrato.La factura no se vinculara a ninguna cuota";
         |DESCARGA_DEF #pycm0011@;
         |ACABA;
     |FINSI;

     |ABRE #900;
     |SELECT #1#900;
     #900#0 = nContratoOTP;
     |LEE 000#900=;
     |SI FSalida = 0;
         |SI #900#150 = "S";
             |MENAV "0000El contrato tiene las cuotas bloqueadas. La factura no se vinculara a ninguna cuota";

             nContratoOTP = 0;
         |FINSI;

         |SI #900#7 = "N";
             |CONFI "0000 El contrato no esta registrado, desea vincular la factura a la cuota";
             |SI FSalida ! 0;  nContratoOTP = 0;  |FINSI;
         |FINSI;

         |SI #900#7 = "B";
             |CONFI "0000 El contrato esta dado de baja, desea vincular la factura a la cuota";
             |SI FSalida ! 0;  nContratoOTP = 0;  |FINSI;
         |FINSI;

         |SI #900#72 ! aZona;  |Y #900#161 ! aZona;
             |MENAV "0000La zona del contrato no pertenece a esta zona de facturaci¢n. La factura no se vinculara a ninguna cuota";

             nContratoOTP = 0;
         |FINSI;
     |FINSI;
     |CIERRA #900;
     |DESCARGA_DEF #pycm0011@;

     |SI nContratoOTP = 0;
         |ACABA;
     |FINSI;

     |PUSHV 0501 2380;

     |SI #700#0 = 0;
         #700#0 = nContratoOTP;
         #700#1 = #0#1;
     |FINSI;

     #700#2 = #0#73;

     |PINPA #0#700;
     |PINDA #0#700;
     |ENDATOS #1#700;
     |SI FSalida ! 0;
         |MENAV "0000 Se cancela la grabacion de la cuota.";
         |POPV;
         |ACABA;
     |FINSI;
     |POPV;

     |DBASS aBase;  |QBF aMas;
     aMas = aBase + "dspreven/def/pycm0011.mas";
     |XABRE "E", aMas, 0;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |HAZ EmpresaPrevencion;

     aAlfa1  = "";
     aAlfa2  = "";
     aAlfa3  = "";
     aAlfa4  = "";
     aAlfa5  = "";

     aMas = aBase + "dspreven/def/pycm0007.mas";
     |CARGA_DEF aMas, pycm0011@;
     aFich = aBase + "dspreven/fich/" + eaEmpresa + "/";
     |PATH_DAT #900 aFich;
     |SELECT #1#900;
     |ABRE #900;
     #900#0 = #700#0;
     |LEE 000#900=;
     |SI FSalida = 0;
         aAlfa1  = #900#101;
         aAlfa2  = #900#68;
         aAlfa3  = #900#69;
         aAlfa4  = #900#70;
         aAlfa5  = #900#71;
         aAlfa7  = #900#72;
         aAlfa   = aAlfa2 + aAlfa3 + aAlfa5 + aAlfa4;

         #0#93   = aAlfa;
         #0#104  = #900#172;
     |FINSI;
     |CIERRA #900;

     |DESCARGA_DEF #pycm0011@;

     aMas = aBase + "dspreven/def/pycm0011.mas";
     |CARGA_DEF aMas, pycm0011@;
     aFich = aBase + "dspreven/fich/" + eaEmpresa + "/";
     |PATH_DAT #900 aFich;
     |ABRE #900;

     |SI nVinculo = 0;
         |SELECT #1#900;
         #900#0  = #700#0;
         #900#1  = #700#1;
         #900#2  = aZona;
         #900#3  = #0#3;
         #900#4  = #0#4;

         |SI #700#3 ! 0;
             #900#5  = #700#3;
             #900#9  = #0#48;
             #900#10 = #0#0;
         |FINSI;

         |SI #700#4 ! 0;
             #900#6  = #700#4;
             #900#11 = #0#48;
             #900#12 = #0#0;
         |FINSI;

         #900#7  = #0#73;
         #900#13 = aAlfa1;
         #900#15 = aAlfa2;
         #900#16 = aAlfa3;
         #900#17 = aAlfa4;
         #900#18 = aAlfa5;
         #900#19 = "M";

         |GRABA 020#900n;
     |FINSI;

     |SI nVinculo = 1;
         |SELECT #1#900;
         #900#0  = #700#0;
         #900#1  = #700#1;
         #900#2  = aZona;
         |LEE 101#900=;
         |SI FSalida = 0;
             |SI #700#3 ! 0;
                 #900#9  = #0#48;
                 #900#10 = #0#0;
             |FINSI;

             |SI #700#4 ! 0;
                 #900#11 = #0#48;
                 #900#12 = #0#0;
             |FINSI;

             |GRABA 020#900a;
          |FINSI;
     |FINSI;

     |LIBERA #900;
     |CIERRA #900;

     |DESCARGA_DEF #pycm0011@;

     ||  enContrato = nContratoOTP;
     ||  aAlfa      = ":dspreven/dspvz005 visal000 " + eaEmpresa;
     ||  |SUB_EJECUTA aAlfa;

     |MENAV "0000Revise el contrato para que la cuota generada entre en el calculo de las cuotas pendientes";

     |DDEFECTO #700;
|FPRC;

|PROCESO Tipo3_84; |TIPO 3;
     aTieneLin = "N";
     |BUCLELIN 2 TieneLin084 #0;
     |SI aTieneLin = "N";
          |BORRA 020#0c;
          |ERROR; |ACABA;
     |FINSI;

     nModo = (FEntrada / 100) ! 0;

     |HAZ EsOTP;
     |SI FSalida = 0;
         |SI #700#0 ! 0;
             |HAZ BuscaContratoOTP;
         |SINO;
             |SI nModo = 1;
                 |CONFI "0000NVincular como cuota del contrato.";
                 |SI FSalida = 0;  |HAZ BuscaContratoOTP; |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|CALCULO siimpre; |TIPO 30;
     enModoCab84 = 0;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ ||Modulo '000car'
     |HAZ EsCarnicas;
     |SI FSalida = 0;
          |HAZ AltaCarnicasFD;
     |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |HAZ EsTecatel;
     |SI FSalida = 0; |Y PARAMETRO = "agrupa";
          |HAZ TecaAgrupaFac;
     |FINSI;

     |HAZ actal;
     |GRABA 020#0a; || T16942 faltaba el graba

     |PINTA #0#72;
     |PINTA #0#73;

     |ABRE #41; |LEE 000#41p; |CIERRA #41;

     |ABRE #20;
     #20#0 = #0#8;
     |LEE 000#20=;
     |CIERRA #20;

     |SI #41#47 = "S"; |Y #20#76 = "S";
          |HAZ VenciDir;
          |SI #agifa142#2 = "S";
                |GRABA 021#agifa084.a;
                |LIBERA #agifa084;
                ser_fac = #agifa084#48;
                num_fac = #agifa084#0;
                |CIERRAT #agifa084;
                |MODULO aPrograma;
                |SUB_EJECUTA_NP "agifa133";
                |ABRET #agifa084;
                #agifa084#48 = ser_fac;
                #agifa084#0 = num_fac;
                |LEE 101#agifa084.=;
          |FINSI;
     |FINSI;

     |SI #41#116 = "S";
          nNume = 0;
          |SI #0#16 ! 0; nNume = nNume + 1; |FINSI;
          |SI #0#19 ! 0; nNume = nNume + 1; |FINSI;
          |SI #0#22 ! 0; nNume = nNume + 1; |FINSI;
          |SI #0#42 ! 0; nNume = nNume + 1; |FINSI;
          |SI #0#45 ! 0; nNume = nNume + 1; |FINSI;
          |SI nNume = 1;
               |HAZ apagar;
          |FINSI;
     |FINSI;

     |CONFI mensajei;
     |SI 0 = FSalida;
          |HAZ impreal;
     |FINSI;
|FCAL;

|PROCESO EsGrupoOTP;
     nGrupoOTP = 0;

     |DBASS aBase;  |QBF aBase;
     aFichero = aBase + "dspreven/dspreven.ini";

     |XABRE "", aFichero, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |PARA;  |SI;  |HACIENDO;
             |XLEE nHandle, 250, aAlfa;
             |SI FSalida < 0;  |SAL;  |FINSI;

             |SI aAlfa = "GrupoOTP";
                 nGrupoOTP = 1;
                 |SAL;
             |FINSI;
     |SIGUE;

     |XCIERRA nHandle;
|FPRC;

|CALCULO impreal;
     nModo = (FEntrada/ 100) ! 0;
     |SI nModo [ 2;
          |GRABA 020#0a;
          |LIBERA #0;
     |FINSI;
     |CIERRAT #0;
     serie = #0#48;
     numero = #0#0;
     reimpr = #0#10;

     aTipoAnt = ""; aEmailAnt = "";

     |HAZ EsOTP; nSwOTP = FSalida;

     |SI nSwOTP = 0;
        PRMNT_serie = #0#48;
        PRMNT_numero = #0#0;
        nGrupoOTP    = 0;

        |HAZ EsArchi;
        |SI FSalida = 0;
            nArchi = 0;
            |DBASS aAlfa; |QBF aAlfa;
            aAlfa = aAlfa + "dsarchi/def/dsarm001.mas";
            |CARGA_DEF aAlfa, Ref0001@;
            |SI FSalida = 0;
                   |DBASS aAlfa; |QBF aAlfa;
                   aAlfa = aAlfa + "dsarchi/fich/"; |PATH_DAT #1001 aAlfa;
                   |ABRE #Ref0001@;
                   |DDEFECTO #Ref0001@;
                   |LEE 000#Ref0001@.p;
                   |SI FSalida ! 0; |DDEFECTO #Ref0001@; |FINSI;

                   |SI #Ref0001@#31 = "S";
                      nArchi = 1;
                   |FINSI;
                   |CIERRA #Ref0001@; |DESCARGA_DEF #Ref0001@;
            |FINSI;
            |SI nArchi = 1;
                |HAZ EsGrupoOTP;
                |SI nGrupoOTP = 0;
                    |MENU aMenuA;
                |SINO;
                    |MENU aMenuO;
                |FINSI;
            |SINO;
                |MENU aMenu;
            |FINSI;
        |SINO;
            |MENU aMenu;
        |FINSI;

        nResp = FSalida;
        |SI nResp = 0;         ||Tecla ESCAPE
          |ABRET #0;
          |LEE 000#0=;
          PRMNT_serie = "";
          PRMNT_numero = 0;
          |ACABA;
        |FINSI;

        |SI nGrupoOTP = 0;
            |SI nResp = 1; eaTipoImp = "P"; |FINSI;
            |SI nResp = 2; eaTipoImp = "C"; |FINSI;
            |SI nResp = 3; eaTipoImp = "A"; |FINSI;
            |SI nArchi = 1;
                |SI nResp = 4; eaTipoImp = "E"; |FINSI;
                |SI nResp = 5;
                     |ABRET #0;
                     |LEE 000#0=;
                     PRMNT_serie = "";
                     PRMNT_numero = 0;
                     |ACABA;
                |FINSI;
            |SINO;
                |SI nResp = 4;
                     |ABRET #0;
                     |LEE 000#0=;
                     PRMNT_serie = "";
                     PRMNT_numero = 0;
                     |ACABA;
                |FINSI;
            |FINSI;
        |SINO;
            |SI nResp = 1; eaTipoImp = "P"; |FINSI;
            |SI nResp = 2; eaTipoImp = "E"; |FINSI;
            |SI nResp = 3;
               |ABRET #0;
               |LEE 000#0=;
               PRMNT_serie = "";
               PRMNT_numero = 0;
               |ACABA;
            |FINSI;
        |FINSI;

        |SI eaTipoImp = "C"; |O eaTipoImp = "A";
           |DBASS aAlfa; |QBF aAlfa;
           aAlfa = aAlfa + "dspreven/def/visalm01.mas";
           |CARGA_DEF aAlfa, visalm01@;
           |SI FSalida = 0;
              |HAZ EmpresaPrevencion;

              |DBASS aAlfa; |QBF aAlfa;
              aAlfa = aAlfa + "dspreven/fich/" + eaEmpresa + "/";
              |PATH_DAT #visalm01@#aAlfa#;
              |ABRE #visalm01@;
              #visalm01@#0 = #agifa084#3;
              |LEE 000#visalm01@.=;
              |SI FSalida = 0;
                 |SI #visalm01@#119 = "N";
                    aTipoAnt  = #visalm01@#119; aEmailAnt = #visalm01@#120;
                    |PUSHV 0501 2380;
                    |BLANCO 2109 2372;
                    |CUADRO 2109 2372;
                    |ATRI R; |PINTA 2111, " Cuenta correo "; |ATRI N;
                    E_sup = 60; E_inf = "";
                    aEmail = 2211 ? 1;
                    |POPV;
                    #visalm01@#119 = "S";
                    #visalm01@#120 = aEmail;
                    |GRABA 020#visalm01@.a;
                 |FINSI;
              |FINSI;
              |CIERRA #visalm01@; |DESCARGA_DEF #visalm01@;
           |FINSI;
        |FINSI;
     |FINSI;

     |SUB_EJECUTA_NP "agifa086";

     |SI nSwOTP = 0; |Y aTipoAnt ! "";
        |SI aTipoAnt = "N";
           |DBASS aAlfa; |QBF aAlfa;
           aAlfa = aAlfa + "dspreven/def/visalm01.mas";
           |CARGA_DEF aAlfa, visalm01@;
           |SI FSalida = 0;
               |HAZ EmpresaPrevencion;

              |DBASS aAlfa; |QBF aAlfa;
              aAlfa = aAlfa + "dspreven/fich/" + eaEmpresa + "/";
              |PATH_DAT #visalm01@#aAlfa#;
              |ABRE #visalm01@;
              #visalm01@#0 = #agifa084#3;
              |LEE 000#visalm01@.=;
              |SI FSalida = 0;
                 #visalm01@#119 = aTipoAnt;
                 #visalm01@#120 = aEmailAnt;
                 |GRABA 020#visalm01@.a;
              |FINSI;
              |CIERRA #visalm01@; |DESCARGA_DEF #visalm01@;
           |FINSI;
        |FINSI;
     |FINSI;

     |ABRET #0;
     |LEE 000#0=;
     |SI nSwOTP = 0;
        PRMNT_serie = "";
        PRMNT_numero = 0;
     |FINSI;
|FCAL;

|CALCULO actutot;|TIPO 0;
   #0#41 = #0#15 - #0#25;
   #0#41 = #0#41 + #0#11;
   #0#41 = #0#41 + #0#13;
   #0#41 = #0#41 + #0#24;
   |PINTA  #0#41;
|FCAL;


|PROCESO ParGer0;
     nModo = (FEntrada / 100) ! 0;
     nTecla = FSalida;
     |HAZ ParGer;

     |SI nModo ! 1; |Y Campo = 1; |Y #0Campo ! Contenido;
          eaFecAnt = Contenido;
     |FINSI;

     |SI nModo = 1;
          |HAZ CtrlFecha084;
          |SI FSalida ! 0; |ERROR; |ACABA; |FINSI;
          ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
          |HAZ EsTecatel;
          |SI FSalida = 0;
               efFecha = #0#1;
               |HAZ TecaModiFac;
               |SI FSalida ! 0;
                    |ERROR; |ACABA;
               |FINSI;
          |FINSI;
          ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |FINSI;

     |HAZ EsOTP;
     |SI FSalida = 0;
         nCambFec = 0;
         |HAZ BloqDSPREVEN;
         |SI nErrBloq ! 0; |ERROR; |ACABA; |FINSI;
     |FINSI;

     |SI nTecla = 13; ||F5
          |HAZ EsTagloma;
          |SI FSalida = 0;
               |SI nModo = 1;
                    |MENAV "0000Opcion no disponible en alta...";
               |SINO;
                    aAlfa = "tagz0001;" + #0#48 + #0#0;
                    |SUB_EJECUTA aAlfa;
                    |ERROR;
               |FINSI;
          |FINSI;
     |FINSI;

     |HAZ CamposModi;
|FPRC;

|PROCESO ParGer;
     |ABRE #41; |LEE 000#41p; |CIERRA #41;
     n_dec = #41#8;
     n_pre = #41#9;
     dto_prom = #41#18;
     |SI #41#47 = "S";
          |C_M #0#8, 1, "S";
     |SINO;
          |C_M #0#8, 1, "N";
     |FINSI;
     |ABRE #agifa007;
     #agifa007#26 = #agifa084#48;
     |LEE 001#agifa007.=;
     |SI FSalida ! 0; |DDEFECTO #agifa007; |FINSI;
     |CIERRA #agifa007;
     def_alm = #agifa007#29;
     def_exp = #agifa007#30;
     |HAZ LeeMonBase;
     |HAZ LeeParamDiv;
|FPRC;

|PROCESO xxxxxxxTipo84_0; |TIPO 0;
     |HAZ mira_obs;
     |HAZ CamDiv;
     cli=#0#3;
     ser=#0#48;
     |SUB_EJECUTA_NP "agifv011.tab;por_ejemplo"
|FPRC;

|PROCESO mira_obs;
     |SI #agifa142#14 = "S";
          puente = #agifa024#53;     |QBF puente;
          |SI puente ! "";
               |PUSHV 1008 1370;
               |SI #agifa142#20 = "S"; |AVISO; |FINSI;
               |BLANCO 1009 1369;
               |CUADRO 1008 1370;
               |ATRI R;
               |PINTA 1110 , #agifa024#53;
               |ATRI 0;
               |PAUSA;
               |POPV;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO mira_riesgo;
     |SI aRieBloqu = "S";
          |HAZ BloqCart;
          |ERROR; nError6 = 1;
          |ACABA;
     |FINSI;
     |SI #agifa142#6 = "S";
          |SI nRieTotal ! 0;
               |PUSHV 0501 2380;
               |BLANCO 0948 1672;
               |CUADRO 1148 1672;
               |CUADRO 0948 1672;
               |ATRI R; |PINTA 1049, "  < CONTROL RIESGOS >  "; |ATRI 0;
               |ATRI I;
               |PINTA 1250, "Concedido:";
               |PINTA 1350, "Total ...:";
               |PINTA 1261, nRieTotal;
               |PINTA 1361, nRieUtili;
               |ATRI 0;
               |PAUSA;
               |POPV;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO LeeMonBase; ||Lee los parametros de la moneda base
     |ABRE #agifa321;
     |ABRE #agifa324;
     |LEE 010#agifa321.p;   ||Leo parametros de divisa
     #agifa084#68 = #agifa321#9;  ||Cojo la Moneda Base de parametros
     #agifa324#0 = #agifa321#9;
     |LEE 010#agifa324.=;         ||Leo la ficha de la moneda base en Divisas
     #agifa084#69 = #agifa324#2;  ||Asigno el cambio de la moneda base con el euro
     decim_base = #agifa324#7;    ||Asigno los decimales de la moneda base
     precio_base = #agifa324#9;   ||Asigno los decimales del precio en la mon. base
     |CIERRA #agifa324;
     |CIERRA #agifa321;
|FPRC;

|PROCESO Param_Divisas; |TIPO 0;
     pintado = 0;  ||Controla pintados de las lineas

     |ABRE #agifa324;
     #agifa324#0 = #agifa084#65;
     |LEE 001#agifa324.=;   || Leo la divisa
     |CIERRA #agifa324;

     decim_divisa = #agifa324#7;  || Decimales de la divisa
     precio_divisa = #agifa324#9;  || Decimales en el precio de la divisa
     nDeci_Div = decim_divisa;   || Decimales de la divisa
     nDeci_PreDiv = precio_divisa;  || Decimales en el precio de la divisa
     |SI #0#67 = "B";   || Si trabajo con la moneda base ...
          nDeci_PreVis   = precio_divisa;
          nDeci_ImpVis   = decim_divisa;
          nDeci_Base     = decim_base;
          nDeci_PreBase  = precio_base;
          nDeci_BaseMx  = decim_base;
          nDeci_PreBaseMx = precio_base;
          nDeci_TotVis   = decim_base;
          nDeci_TotNoVis = decim_divisa;
     |SINO;     || Si trabajo con la divisa ...
          nDeci_PreVis   = precio_base;
          nDeci_ImpVis   = decim_base;
          nDeci_Base     = decim_base;    || Max. precision en los decimales de la moneda base
          nDeci_PreBase  = precio_base;   || Max. precision en los dec. del precio de la moneda base
         |SI #0#66 = 1;
              nDeci_BaseMx    = decim_base;    || sin triangulacion
              nDeci_PreBaseMx = precio_base;
         |SINO;
              nDeci_BaseMx    = #agifa321#10;  || con triangulacion
              nDeci_PreBaseMx = #agifa321#11;
         |FINSI;
          nDeci_TotVis   = decim_divisa;
          nDeci_TotNoVis = decim_base;
     |FINSI;
     |HAZ Deci_IVA;
|FPRC;

|PROCESO LeeParamDiv; |TIPO 0;
     |ABRE #agifa321;
     |LEE 001#agifa321.p;    || Leo parametros de divisas
     |CIERRA #agifa321;

     |ABRE #agifa007;
     #agifa007#26 = #agifa084#48;
     |LEE 001#agifa007.=;        || Leo la serie
     |CIERRA #agifa007;

     |SI #agifa007#39 = "N"; |O #agifa321#1 = "N";
          #0#67 = "B";
     |FINSI;

     |SI #0#67 = "D";      || Si la mon. de trabajo es la divisa...
          || ...escondo los campos de la moneda base :
          |C_P #3#6 , 1 , 1009;
          |C_P #3#9 , 1 ,1026;
          |C_V #3#6 , 1 , "N";
          |C_V #3#9 , 1 , "N";
          |C_L #3#6 , 1 , "N";
          |C_L #3#9 , 1 , "N";
          |C_M #3#6 , 1 , "N";
          || ...y pongo en pantalla los de divisa
          |C_P #3#26 , 1 , 1544;
          |C_P #3#27 , 1 ,1568;
          |C_V #3#26 , 1 , "S";
          |C_V #3#27 , 1 , "S";
          |C_M #3#26 , 1 , "S";
          |C_L #3#26 , 1 , "S";
          |C_L #3#27 , 1 , "S";
          |SI #agifa007#39 = "S"; |Y #agifa321#1 = "S"; ||Si la serie es de ...
               ac_divisa = "S";  || ... divisas, y en parametros estan activadas ...
               || ... pongo como modificables los campos relacionados con divisas
               |C_M #0#65 , 1 , "S";
               |C_M #0#66 , 1 , "S";
               |C_M #0#67 , 1 , "S";
               |SI #agifa321#3 = "S";  || Si la visualizacion de parametros esta activada
                    || ... pongo los campos visual. de lineas como visualizables
                    |C_V #3#28, 1 , "S";
                    |C_V #3#29 , 1 , "S";
               |SINO;
                    || ... los pongo como no visualizables
                    |C_V #3#28 , 1 , "N";
                    |C_V #3#29 , 1 , "N";
               |FINSI;
          |SINO; || Si la serie no es de divisas, o no estan activados parametros
               ac_divisa = "N";
               #0#67 = "B";  || La moneda de trabajo es por fuerza la moneda base
               |PINTA #0#67;
               || Pongo como no modificables los campos relacionados con divisas
               |C_M #0#67 , 1 , "N";
               |C_M #0#65 , 1 , "N";
               |C_M #0#66 , 1 , "N";
               || Pongo como no visualizables los campos visual. de lineas
               |C_V #3#28, 1 , "N";
               |C_V #3#29, 1 , "N";
          |FINSI;
     |SINO;  || Si la moneda de trabajo es la moneda base
          || ...escondo los campos en divisa :
          |C_P #3#26 , 1 , 1009;
          |C_P #3#27 , 1 ,1026;
          |C_V #3#26 , 1 , "N";
          |C_V #3#27 , 1 , "N";
          |C_M #3#26 , 1 , "N";
          |C_L #3#26 , 1 , "N";
          |C_L #3#27 , 1 , "N";
          || ...coloco los campos en moneda base:
          |C_P #3#6 , 1 , 1544;
          |C_P #3#9 , 1 ,1568;
          |C_V #3#6 , 1 , "S";
          |C_V #3#9 , 1 , "S";
          |C_M #3#6 , 1 , "S";
          |C_L #3#6 , 1 , "S";
          |C_L #3#9 , 1 , "S";
          |SI #agifa007#39 = "S"; |Y #agifa321#1 = "S"; || Si la serie es de divisas...
               ac_divisa = "S"; || ... y divisas estan activadas en parametros
               || Pongo como modificables los campos relacionados con divisas
               |C_M #0#65 , 1 , "S";
               |C_M #0#66 , 1 , "S";
               |C_M #0#67 , 1 , "S";
               |SI #agifa321#3 = "S";  || Si la visualizacion esta activada en parametros ...
                    || Pongo como visualizables los campos visual. de las lineas
                    |C_V #3#28, 1 , "S";
                    |C_V #3#29 , 1 , "S";
               |SINO; || Los pongo como no visualizables
                    |C_V #3#28 , 1 , "N";
                    |C_V #3#29 , 1 , "N";
               |FINSI;
          |SINO;  || Si la serie no es de divisas o no estan activados los parametros
               ac_divisa = "N";
               #0#67 = "B";  || La moneda de trabajo es por fuerza la moneda base
               || Pongo como no modificables los campos relacionados con divisas
               |C_M #0#67 , 1 , "N";
               |C_M #0#65 , 1 , "N";
               |C_M #0#66 , 1 , "N";
               || Pongo como no visualizables los campos visual. de lineas
               |C_V #3#28, 1 , "N";
               |C_V #3#29, 1 , "N";
          |FINSI;
     |FINSI;
     ||ÄÄÄÄÄÄÄÄPortes/Varios
     |C_P #0#76, 0, nPos; |C_P #0#11, 1, nPos;
     |C_P #0#77, 0, nPos; |C_P #0#13, 1, nPos;
     |C_V #0#11, 1, "N";
     |C_V #0#13, 1, "N";
     |C_V #0#76, 1, "N";
     |C_V #0#77, 1, "N";
     |SI #0#67 = "D";
          |C_V #0#76, 1, "S";
          |C_V #0#77, 1, "S";
     |SINO;
          |C_V #0#11, 1, "S";
          |C_V #0#13, 1, "S";
     |FINSI;
     |HAZ Param_Divisas;
|FPRC;

|PROCESO CamDiv; |TIPO 0;
     nModo084 = (FEntrada / 100) ! 0;
     |SI nModo084 = 1;   ||Si cambia el valor o es alta
          |SI Campo = 3; || Si llamo al proceso desde el cod. de cliente ...
               |ABRE #agifa024;
               #agifa024#0 = #0#3;
               |LEE 020#agifa024.=;
               |CIERRA #agifa024;
               #0#36 = #agifa024#47;   || Regimen Equi.
               #0#65 = #agifa024#192;  || Asigno la divisa por defecto del cliente
               #0#67 = #agifa024#193;  || Asigno la moneda de trabajo del cliente
               |PINTA #0#67;
          |FINSI;
          |ABRE #agifa007;
          #agifa007#26 = #agifa084#48;
          |LEE 020#agifa007.=;  || Leo la serie
          |CIERRA #agifa007;
          |SI #agifa007#39 = "S"; |Y #agifa321#1 = "S";
               |SI #agifa024#191 = "S"; || Si el cliente es de divisa pactada
                    |ABRE #agifa328;
                    |ABRE #agifa329;
                    #agifa329#0 = #agifa084#3;
                    #agifa329#2 = #agifa084#65;
                    #agifa329#7 = "N";
                    |SELECT #2#agifa329;  || Con esta clave ...
                    |LEE 011#agifa329.=;  || ... busco periodos no finalizados de esa divisa
                    |SI FSalida = 0;  || Si existe un periodo no finalizado
                         |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
                              #agifa084#65 = #agifa329#2;        || Cargo la divisa ...
                              #agifa084#66 = #agifa329#3;        || ...y el cambio
                              |LEE 001#agifa329.=;   || Leo las lineas de Clientes/Divisas
                              nfecha = #agifa084#1 - #agifa329#6;  || Resto la fecha de fin de periodo a la actual
                              |SI nfecha > 0;  || Si la fecha actual supera a la del periodo asignado ...
                                   |MENAV "0000ATENCION deberia Actualizar primero la divisa en Clientes/Divisas";
                                   cli_divisa = #agifa084#3;  || Le envio el cod. de cliente a "agifa328"
                                   |SUB_EJECUTA_NP "agifa328.tab";  || Ejecuto Clientess/Divisas
                                   |ERROR;
                              |SINO;
                                   div_act = 1;  || Para salir del PARA
                              |FINSI;
                         |SIGUE;
                    |SINO;  || Si no existe un periodo no finalizado para esa divisa
                         |MENAV "0000No existe un periodo activo para la divisa en Clientes / Divisas";
                         cli_divisa = #agifa084#3;  || Le paso a "agifa328" el cliente
                         |SUB_EJECUTA_NP "agifa328.tab";  || Ejecuto Clientes / Divisas
                         |ERROR;
                    |FINSI;
                    |SELECT #1#agifa329;
                    |CIERRA #agifa329;
                    |CIERRA #agifa328;
               |SINO; || Si el Cliente no es de Divisa pactada ...
                    |ABRE #agifa324; || ...miro  directamente en divisas
                    #agifa324#0 = #agifa084#65;
                    |LEE 001#agifa324.=;
                    |SI FSalida = 0; ||Si existe la divisa...
                         #agifa084#66 = #agifa324#2; || la recojo
                         |SI #agifa324#5 ! -1; || Si los dias de margen de actualizacion no
                                           || son = -1 (indefinidos)
                              |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
                                   #agifa084#65 = #agifa324#0;        ||Cargo el valor de la divisa
                                   #agifa084#66 = #agifa324#2;        ||Cargo el valor del cambio
                                   |LEE 001#agifa324.=;  || Leo la divisa
                                   nfecha = #agifa084#1 - #agifa324#4;
                                   |SI nfecha > #agifa324#5; |Y #agifa324#5 ! -1;  || Si la fecha actual
                                        |MENAV "0000ATENCION deberia Actualizar primero la divisa";
                                        divisa = #agifa084#65;
                                        |SUB_EJECUTA_NP "agifa326.tab";
                                        |ERROR;
                                   |SINO;
                                        div_act = 1;
                                   |FINSI;
                              |SIGUE;
                         |FINSI;
                    |FINSI;
                    |CIERRA #agifa324;
               |FINSI;
          |SINO;
               #agifa084#65 = #agifa084#68;
               #agifa084#66 = #agifa084#69;
         |FINSI;
         |HAZ HisCamDiv;
         |PINTA #agifa084#65;
         |PINTA #agifa084#66;
         |SI Campo = 3; || Si llamo al proceso desde el cod. de cliente ...
               |HAZ LeeParamDiv;
         |SINO;
              |HAZ Param_Divisas;
         |FINSI;
    |FINSI;
|FPRC;

|PROCESO convportes; |TIPO 6;  || Convierte los portes a la mon. base
     |SI #0#67 = "D";
          #0#11 = #0#76 / #0#66 * #0#69;
     |SINO;
          #0#76 = #0#11 * #0#66 / #0#69;
     |FINSI;
|FPRC;

|PROCESO convvarios; |TIPO 6;  || Convierte los varios a la mon. base
     |SI #0#67 = "D";
          #0#13 = #0#77 / #0#66 * #0#69;
     |SINO;
          #0#77 = #0#13 * #0#66 / #0#69;
     |FINSI;
|FPRC;


|PROCESO LeeFac; |TIPO 13;  || Sirve para cargar los valores cada vez que
                            || cambio de ficha
     |HAZ EsGesineed;
     |SI FSalida = 0;
          nSwEstaDocErp = 0;
          |HAZ MiraSiEstaDocErp;
          |SI nSwEstaDocErp = 1;
               |PINTA 0525, "* DOCUMENTO ASOCIADO *";
          |SINO;
               |PINTA 0525, "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ";
          |FINSI;
     |FINSI;
     |HAZ ParGer;
     pintado = 0;   || controla pintado de las lineas
     |HAZ LeeMonBase;
     |HAZ LeeParamDiv;

     |HAZ EsGuerola;
     |SI FSalida = 0;
          |HAZ GuerPinObra84;
     |FINSI;
     |HAZ EsMalpesa;
     |SI FSalida = 0;
          |HAZ MalpPinInciObra;
     |FINSI;
|FPRC;

|CALCULO modomod; |TIPO 6;
   |SI nModo084 = 2; |Y #0Campo ! Contenido;
       |MENAV "0000No se puede modificar el campo.";
       #0Campo = Contenido;
       |PINTA #0Campo;
       |ERROR;
   |FINSI;
   |SI #0Campo ! Contenido; |Y Campo = 67;
     |HAZ LeeParamDiv;
   |FINSI;
|FCAL;

|PROCESO caltotal; |TIPO 0; ||Proceso especial para casos determinados como
                            ||modificar los campos de cabecera en dtos, cambio divisas etc
                            ||Recalcula total factura cont., descuentos y ivas de lineas
                            ||En el caso de cambiar el cambio de divisas recalcula tambien precio... de lineas

     |SI #0Campo ! Contenido;||Solo si cambia
          |HAZ convportes;
          |HAZ convvarios;
          |HAZ actal;
          |PINTA #0#73;
     |FINSI;
|FPRC;

|PROCESO LeeDesde; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |HAZ EsOTP;
     |SI FSalida = 0;
        || Si es OTP compruebo el bloqueo de la facturacion en alta, ya que
        ||    al entrar en modo alta no pasa por el TIPO 2

        |SI nModo = 1; |Y nSwConsulta = 1;
           |MENAV "    Está activado el modo CONSULTA.  Pruebe a desactivarlo saliendo y volviendo a acceder a la opción."
           |PTEC 807; |ACABA;
        |FINSI;
     |FINSI;

     |HAZ ControlUsuFT;
     |SI enErr ! 0; |PTEC 807; |ACABA; |FINSI;

     |C_P #0#3, 0, enPosCli;
     |HAZ DefSerVta;
     |SI nModo = 1; |Y #279#24 = "S";
          |SI eaSerCli ! "";
               #0#48 = eaSerCli; |PTEC 802;
          |SINO;
               |PTEC 807; |PTEC 807; |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     |SI PRMNT_aHisto ! "";
          ser_alb = PRMNT_aHisto % 105;
          num_alb = (A\(PRMNT_aHisto % 6));
          PRMNT_aHisto = "";

          #0#48 = ser_alb;
          #0#0 = num_alb;
          |PTEC 802;
          |PTEC 802;
          |PINTA #0#48;
          |PINTA #0#0;
          |ACABA;
     |FINSI;
|FPRC;

|PROCESO linf;
  #49#0 = #0#3;
  #49#1 = 1;
|FPRC;

|PROCESO lsup;
  #49#0 = #0#3;
  #49#1 = 9999;
|FPRC;

|PROCESO Extra; |TIPO 6;
     nTecla = FSalida;
     |SI nTecla = 13;
          modo = (FEntrada / 100) ! 0;
          |SI modo = 4;
               |ABRE #6;
               #6#0 = #0#3;
               |LEE 001#6=;
               |SI FSalida ! 0; |DDEFECTO #6; |FINSI;
               |CIERRA #6;
          |FINSI;
          |PUSHV 0501 2380;
          ext1 = #6#16;
          |SUB_EJECUTA_NP "caextrap.run";
          |POPV;
          |ERROR; nError6 = 1;
     |FINSI;
|FPRC;

|RUTINA InfDir84;
     #49#0 = #0#3;
     #49#1 = 1;
|FRUT;

|RUTINA SupDir84;
     #49#0 = #0#3;
     #49#1 = 9999;
|FRUT;

|PROCESO DatosCli;
     |SI #41#229 = "E";
          || Deja las del dsm00003
     |FINSI;

     |SI #41#229 = "F";
          #0#30 = #6#8;
          #0#31 = #6#9;
          #0#64 = #6#183;
          #0#33 = #6#10;
     |FINSI;
     |SI #41#229 = "C";
          #0#30 = #6#11;
          #0#31 = #6#12;
          #0#64 = #6#186;
          #0#33 = #6#13;
     |FINSI;

     |HAZ EsOTP;
     |SI FSalida = 0;
          #0#30 = #6#5;
          #0#31 = #6#6;
          #0#64 = #6#180;
          #0#33 = #6#7;
     |FINSI;
     |PINTA #0#30;
     |PINTA #0#31;
     |PINTA #0#64;
     |PINTA #0#33;
|FPRC;

|PROCESO DefeDirEnt;
     |ABRE #49;
     #49#0 = #0#3;
     #49#1 = #0#91;
     |LEE 000#49=;
     |SI FSalida = 0;
          #0#91 = #49#1; |PINTA #0#91;
          ||#0#4 = #49#10; |PINTA #0#4;
          #0#29 = #49#10;|PINTA #0#29;
          #0#30 = #49#2; |PINTA #0#30;
          #0#31 = #49#3; |PINTA #0#31;
          #0#33 = #49#7; |PINTA #0#33;
          #0#64 = #49#6; |PINTA #0#64;
          |SI #49#14 = "  ";
              #0#6 = #6#25;
          |SINO;
              #0#6 = #49#14;
          |FINSI;
          |HAZ DatosCli;
          |HAZ EsClipresa;
          |SI FSalida = 0;
               |HAZ ClipreRepre;
          |FINSI;
          |PINTA #0#6;
     |FINSI;
|FPRC;

|PROCESO Dir; |TIPO 0;  ||Direccion de entrega
     nModo084 = (FEntrada / 100) ! 0;
     nTecla = FSalida;

     |HAZ DefeFP;
     |ABRE #6;
     #6#0 = #0#3;
     |LEE 000#6=;
     |CIERRA #6;

     |SI nModo084 = 1; |O #0Campo ! Contenido;
          |HAZ DefeDirEnt;
          |HAZ EsClipresa;
          |SI FSalida = 0;
               |HAZ ClipreRepre;
          |FINSI;
     |FINSI;

     |SI nTecla = 12;
          |PUSHV 0501 2380;
          |ENTLINEAL #1#49, -2, 1, 22, 1, InfDir84, SupDir84;
          |POPV;
          |ERROR; nError6 = 1; |ACABA;
     |FINSI;
/*
     |SI #0#3 ! Contenido; |O nTecla = 10;
          |HAZ DatosCli;
          |ABRE #49;
          #49#0 = #0#3;
          #49#1 = 2;
          |LEE 000#49];
          |SI FSalida = 0; |Y #49#0 = #0#3;
               ||El cliente tiene mas de una direccion de entrega
               #49#1 = #0#91;
               |LEE 000#49];
               |CONSULTA_F_CLAVE #1#49,linf,lsup;
               |SI FSalida = 0;
                    #0#91 = #49#1; |PINTA #0#91;
                    ||#0#4 = #49#10; |PINTA #0#4;
                    #0#29 = #49#10;|PINTA #0#29;
                    #0#30 = #49#2; |PINTA #0#30;
                    #0#31 = #49#3; |PINTA #0#31;
                    #0#33 = #49#7; |PINTA #0#33;
                    #0#64 = #49#6; |PINTA #0#64;
                    |SI #49#14 = "  ";
                        #0#6 = #6#25;
                    |SINO;
                        #0#6 = #49#14;
                    |FINSI;
                    |PINTA #0#6;
               |FINSI;
          |FINSI;
          |CIERRA #49;
     |FINSI;
*/
     |SI nTecla = 11; |O #41#102 = "S"; |O #41#102 = "X";
          eaCodigo = #0#3;
          eaFuerza = "N";
          |SI nTecla = 11; eaFuerza = "S"; |FINSI;
          |SUB_EJECUTA_NP "dsz99994";
          |SI #41#102 = "N"; |Y nModo084 ! 2; |ERROR;  nError6 = 1; |FINSI;
     |FINSI;

     |ABRE #6;
     |DDEFECTO #6;
     #6#0 = #0#3;
     |LEE 000#6=;
     |SI FSalida ! 0;
          |SI #41#1 = "S";
                |HAZ Menus;
          |FINSI;
     |FINSI;
     |CIERRA #6;
|FPRC;

|PROCESO Menus;
     |MENU menu;
     |SI FSalida = 1;    ||Automatico
          |ABRE #42;
          #42#2 = "";
          #42#0 = "clientes";
          |LEE 101#42=;
          |SI FSalida = 0;
               #42#1 = #42#1 + 1;
               contador = #42#1;
               |GRABA 021#42a;
          |SINO;
               contador = 1;
               #42#1 = 1;
               |GRABA 021#42n;
          |FINSI;
          cont = contador;
          cont = ("000000" + cont) % -106;
          #0Campo = cont;
          |PINTA #0Campo;
          |LIBERA #42;
          |CIERRA #42;
     |FINSI;
|FPRC;


|PROCESO apagar;
               || solo si hay un tipo de iva
               || y esta parametrizado
     |PUSHV 0501 2380;
     #50#0 = #0#73;
     #50#1 = #0#73;
     #50#2 = #50#0 - #50#1;
     |PINPA #0#50;
     |PINDA #0#50;
     |ENDATOS #1#50;
     |SI FSalida = 0;
          |SI #50#2 ! 0;
               |HAZ Recalcula;
          |FINSI;
     |FINSI;
     |POPV;
|FPRC;

|PROCESO dif;
    #50#2 = #50#0 - #50#1;
    |PINTA #50#2;
|FPRC;

|PROCESO dif2;
    #50#1 = #50#0 - #50#2;
    |PINTA #50#1;
|FPRC;

|PROCESO Recalcula;
     |SI #0#16 ! 0; tato = #0#50 + 100; |FINSI;
     |SI #0#19 ! 0; tato = #0#52 + 100; |FINSI;
     |SI #0#22 ! 0; tato = #0#54 + 100; |FINSI;
     |SI #0#42 ! 0; tato = #0#56 + 100; |FINSI;
     |SI #0#45 ! 0; tato = #0#58 + 100; |FINSI;
     tota  = (#50#1 * 100) / tato;
     base  = #0#15 - tota;
     tato  = (base / #0#15) * 100;
     #0#7 = tato;
     |HAZ caltotal;
     |GRABA 020#0a;
|FPRC;

|PROCESO Riesgo;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ Control Riesgo Cliente.
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 4; |ACABA; |FINSI;

     nMasRies = 0;
     eaSerie = #0#48; eaTag = "FD";  |HAZ SacaRiesgo;
     |SI  #agifa142#6 = "S"; |Y eaExisteCliRie = "S";
          eaDocu = "C";
          eaTipo = "A";
          enImpoDoc = #0#41;
          eaMuestra = "S";
          |HAZ ControlRiesgo;
          |HAZ CtrlRiesgoTaglo;
          |SI enErrRie ! 0; nError6 = 1; |ERROR; |ACABA; |FINSI;
          |SI enAudito = 0;
               |ABRE #143;
               |LEE 000#143u;
               |SI FSalida = 0;
                    nConAu = #143#0 + 1;
               |SINO;
                    nConAu = 1;
               |FINSI;
               |DDEFECTO #143;
               #143#0 = nConAu;
               #143#12 = "FDIRECTA";
               #143#1 = #0#48;
               #143#2 = #0#0;
               #143#3 = #0#1;
               #143#4 = #0#3;
               #143#5 = #0#4;
               #143#6 = Usuario % 810;
               #143#7 = #141#0;
               #143#8 = #141#1;
               #143#9 = #141#2;
               #143#10 = #141#3;
               #143#11 = #141#4;
               |GRABA 020#143n;
               |CIERRA #143;
          |FINSI;
     |FINSI;
/*
     nMasRies = 0;
     eaSerie = #agifa084#48; eaTag = "FD";  |HAZ SacaRiesgo;
     |SI #agifa142#6 = "S"; |Y eaExisteCliRie = "S";
          |SI nRieUtili ] nRieTotal; |Y nRieTotal ! 0;
               |SI #agifa142#22 = "N";
                    |MENAV "0000Superado Riesgo Cliente";
                    |BLIN 4;
               |FINSI;
               |SI #agifa142#22 = "S";
                    |HAZ AvisaRiesgo;
               |FINSI;
               |SI #agifa142#22 = "P";
                    |ABRE #140;
                    aUs = Usuario % 0810;
                    #140#0 = "A";
                    #140#1 = aUs;
                    |LEE 000#140=;
                    |SI FSalida ! 0;
                         |CIERRA #140;
                         |HAZ mira_riesgo;
                         |ERROR; nError6 = 1; |ACABA;
                    |FINSI;
                    |CIERRA #140;
                    |DDEFECTO #141;
                    #141#0 = nRieTotal;
                    #141#1 = nRieUtili;
                    #141#2 = #140#2;
                    #141#5 = nRieUtili;
                    #141#3 = (nRieTotal % #140#2);
                    #141#4 = #140#3;
                    |SI #141#3 < #141#4;|Y #141#3 ! 0;
                         #141#6 = nRieTotal + #141#3;
                         nMasRies  = #141#3;
                    |SINO;
                         #141#6 = nRieTotal + #141#4;
                         nMasRies  = #141#4;
                    |FINSI;
                    |SI #141#6 [ #141#5;
                         #141#7 = "DENEGADA ";
                         nAudito = 1;
                         nMasRies = 0;
                    |SINO;
                         #141#7 = "PERMITIDA";
                         nAudito = 0;
                    |FINSI;
                    |PUSHV 0501 2380;
                    |PINPA #0#141;
                    |PINDA #0#141;
                    |PAUSA;
                    |POPV;
                    |SI nAudito = 1;
                         |ERROR; nError6 = 1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |HAZ mira_riesgo;
*/
     |HAZ EsTagloma;
     |SI FSalida = 0;
          eaCliente = #0#3;
          |HAZ TagCheqPend;
     |FINSI;
|FPRC;

|PROCESO PideSerTpv;
     |PUSHV 0501 2380;
     |BLANCO 1224 1855;
     eaSerTpv = "";
  |ET OtraSertpv;
     #200#0 = #0#48;
     |PINPA #0#200;
     |PINDA #0#200;
     |ENCAMPO #0#200;
     |SI FSalida = 0;
          |ABRE #40;
          #40#26 = #200#0;
          |LEE 000#40=;
          |SI FSalida ! 0;
               |MENAV "0000No existe serie...";
               |VETE OtraSertpv;
          |FINSI;
          eaSerTpv = #200#0;
          |CIERRA #40;
     |FINSI;
     |POPV;
|FPRC;

|PROCESO FPago840; |TIPO 0;
     |HAZ EsTagloma;
     |SI FSalida = 0;
          eAlfa1 = "FD";
          eAlfa2 = #0#8; ||F.Pago
          |HAZ TagAvisaFP;
     |FINSI;

     |HAZ EsOTP;
     |SI FSalida = 0;
          eaAlfa = #0#93;  |QBF eaAlfa;
          |SI eaAlfa = "";
               eAlfa1 = "";
               eaCliente = #0#3;
               |HAZ CtaOTP;
               #0#93   = eaAlfa; |PINTA #0#93;
               #0#104  = eaIBAN;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO PintaObs; |TIPO 14;
     |ABRE #agifa204; |LEE 000#agifa204.p; |CIERRA #agifa204;

     puente = #agifa204#23; |QBF puente;
     |SI puente ! "";
          |ATRI I;  |PINTA 2005 , puente;    |ATRI i;
          |C_M #0#93 , 1 , "S";
     |FINSI;

     puente = #agifa204#24; |QBF puente;
     |SI puente ! "";
          |ATRI I;  |PINTA 2030 , puente;    |ATRI i;
          |C_M #0#94 , 1 , "S";
     |FINSI;

     puente = #agifa204#25; |QBF puente;
     |SI puente ! "";
          |ATRI I;  |PINTA 2055 , puente;    |ATRI i;
          |C_M #0#95 , 1 , "S";
     |FINSI;
     |ATRI I;
|FPRC;

|PROCESO Nif084_7; |TIPO 7;
     |HAZ EsTecatel;
     |SI FSalida = 0;
          |MENSA "0000<F5> Recoger datos del cliente.   <F12> Calculo Letra Nif";
     |SINO;
          |MENSA "0000<F12> Calculo Letra Nif";
     |FINSI;
|FPRC;

|PROCESO Nif084_0; |TIPO 0;
     nSal = FSalida;
     |MENSA "0000...";
     |HAZ EsTecatel;
     |SI FSalida = 0;
          |ABRE #6;
          |SELECT #4#6;
          #6#15 = #0#60;
          |LEE 000#6=;
          |SI nSal ! 13; |Y #0#3 ! #6#0;
               |MENAV "0000Nif existente en otro codigo de Cliente";
               |CONFI "0000NRecoger Datos del Cliente:";
               |SI FSalida = 0; nSal = 13; |FINSI;
          |FINSI;
          |SI nSal = 13; ||F5
               #0#3 = #6#0; |PINTA #0#3;
               ||#0#4 = #6#2; |PINTA #0#4;
               #0#5 = #6#37; |PINTA #0#5;
               #0#7 = #6#38; |PINTA #0#7;

               #0#8 = #6#20; |PINTA #0#8;
               #0#32 = #6#156; |PINTA #0#32;
               |HAZ DefeDirEnt;
               |ERROR;
          |FINSI;
          |CIERRA #6;
     |FINSI;
     nSal = FSalida;
|FPRC;

|PROCESO TagBajaFac;
     |DDEF aAlfa;
     aAlfa = aAlfa + "tagm0017";
     |CARGA_DEF aAlfa, Referen@;
     |SI FSalida = 0;
          |ABRE #Referen@; |SELECT #3#Referen@;
          #Referen@#38 = "F";
          #Referen@#39 = #0#48;
          #Referen@#40 = #0#0;
          |LEE 101#Referen@.=;
          |SI FSalida = 0;
               |SELECT #1#Referen@;
               |LEE 121#Referen@.=;
               #Referen@#38 = "N";
               #Referen@#39 = "";
               #Referen@#40 = 0;
               |GRABA 020#Referen@.a;
          |FINSI;
          |CIERRA #Referen@;
          |DESCARGA_DEF #Referen@;
     |FINSI;
|FPRC;

|PROCESO LinModCLi;
     #3#15 = #0#3;
     #3#16 = #0#34;
     #3#17 = #0#35;
     |GRABA 020#3a;
     |LIBERA #3;
|FPRC;

|PROCESO Cliente84_7; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI #279#24 = "S";
          |C_M #0#3, 1, "N";
          |SI nModo = 1;
               |SI eaSerCli ! ""; #0#3 = eaCliSer; |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Cliente84_0;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1; |O #0Campo ! Contenido;
          |HAZ DefeDirEnt;
     |FINSI;
     |HAZ ObsCli84;

     |SI #0Campo ! Contenido;
         |HAZ EsOTP;
         |SI FSalida = 0;
             |ABRE #6;
             #6#0 = #0#3;
             |LEE 000#6=;
             |SI FSalida ! 0; |DDEFECTO #6; |FINSI;
             |CIERRA #6;
             #0#104 = #6#215; |PINTA #0#104;
             #0#93 = ""; |PINTA #0#93;
         |FINSI;
     |FINSI;

     |HAZ CamDiv;
     |SI #0Campo ! Contenido; |Y nModo = 2;
          |BUCLELIN 0 LinModCLi #0;
          |SI #41#250 = "S"; |HAZ FacModLin; |FINSI;
     |FINSI;

     eaCliente = #0#3;
     eaSerie = #0#48;
     eaTipo = "F";
     |HAZ ExisteCliRie;

     |HAZ EsOTP;
     |SI FSalida = 0;
        |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dspreven/def/visalm01.mas";
        |CARGA_DEF aAlfa, ParamOTP@;
        |SI FSalida = 0;
           |HAZ EmpresaPrevencion;

           |DBASS aAlfa; |QBF aAlfa;
           aAlfa = aAlfa + "dspreven/fich/" + eaEmpresa + "/"; |PATH_DAT #ParamOTP@#aAlfa#;
           |ABRE #ParamOTP@;
           #ParamOTP@#0 = #agifa084#3;
           |LEE 000#ParamOTP@.=;
           |SI FSalida = 0;
              |SI #ParamOTP@#121 = "S";
                 aAlfa = #ParamOTP@#122; |QBF aAlfa;
                 |PUSHV 0501 2380;
                 |BLANCO 1013 1767;
                 |CUADRO 1013 1767;
                 nContLin = 1115;
                 |PARA; |SI aAlfa ! ""; |HACIENDO;
                    aAlfa1 = aAlfa % 0150; aAlfa3 = aAlfa1 % -101; |QBF aAlfa1;
                    |SI aAlfa ! aAlfa1;
                       aAlfa2 = aAlfa % 5101;
                       |SI aAlfa2 ! " "; |Y aAlfa3 ! " ";
                          aAlfa2 = aAlfa1 % -101; aAlfa1 = aAlfa1 % -299;
                          |PARA; |SI aAlfa2 ! "."; |Y aAlfa2 ! ","; |Y aAlfa2 ! ";";
                               |Y aAlfa2 ! " "; |Y aAlfa2 ! "-"; |Y aAlfa2 ! "_"; |HACIENDO;
                             aAlfa2 = aAlfa1 % -101; aAlfa1 = aAlfa1 % -299;
                             |SI aAlfa2 = ""; |SAL; |FINSI;
                          |SIGUE;
                       |FINSI;
                    |FINSI;
                    aAlfa = aAlfa - aAlfa1;
                    aAlfa2 = aAlfa % 0101;
                    |PARA; |SI aAlfa2 = " "; |HACIENDO;
                       aAlfa2 = aAlfa % 10199;
                       aAlfa = aAlfa % 0299; aAlfa = aAlfa + aAlfa2;
                       aAlfa2 = aAlfa % 0101;
                    |SIGUE;
                    |ATRI I; |PINTA nContLin, aAlfa1; |ATRI N;
                    nContLin = nContLin + 100;
                 |SIGUE;
                 |PAUSA;
                 |POPV;
              |FINSI;
           |FINSI;
           |CIERRA #ParamOTP@; |DESCARGA_DEF #ParamOTP@;
        |FINSI;
     |FINSI;

     |HAZ Pago7_084;
     |HAZ DefePromo84;
     |SI nModo = 1; |Y #6#28 = "S"; || Cliente Exporacion
          #0#12 = 0; |PINTA #0#12;
          #0#14 = 0; |PINTA #0#14;
     |FINSI;
|FPRC;

|PROCESO Cliente84_6;
     nError6 = 0;
     |HAZ Extra;
     |SI #0Campo ! Contenido;
          |HAZ Dir;
     |FINSI;
     |HAZ EsTagloma;
     |SI FSalida = 0;
          eaCliente = #0#3;
          |SUB_EJECUTA_NP "tagz0024";
     |FINSI;
     |HAZ Riesgo;
     |SI nError6 ! 0; |ERROR; |FINSI;
|FPRC;

|PROCESO PrecioCab84;
     |ABRE #2;
     #2#0 = #3#2;
     |LEE 020#2=;
     |CIERRA #2;

     |ABRE #6;
     #6#0 = #0#3;
     |LEE 000#6=;
     |CIERRA #6;

     fed_dt = #0#1;   || Fecha....
     art_dt = #3#2;   || Articulo.
     cli_dt = #3#15;  || Cliente..
     fam_dt = #3#13;  || Familia.
     iva_dt = #2#30;  || Tipo Iva.
     dtos_2 = 0;      || Descuento 2.
     dto_pt = 0;      || Descuento Ptas.
     dtos_1 = 0;      || Descuento 1.
     pvp_ve = 0;      || Precio Venta.
     tarifa = #6#39;  || Tarifa Cliente....
     gru_dt = #6#158; || Grupo Cliente.
     uni_dt = #3#5;
     uni_dt2 = #3#30;
     nPromo = #0#79;
     enMensaje = 0;
     enDirEnt = #0#91;  ||Dir entrega
     aParam = "";
     eaSerie = #3#20;
     |SI #2#176 = "S";  enMensaje = 1;  |FINSI;
     enAlmacen = #3#3;
     |HAZ calcdtos;    || Calculo Dtos.....

     #3#6   = pvp_ve - dto_pt;  || Precio Venta. sin iva.
     #3#8   = dtos_1;  || 1¦ Dto.
     #3#21  = dtos_2;  || 2§ Dto.
|FPRC;

|PROCESO CreaLinProCab84;
     |ABRE #referen@;
     #referen@#20 = #3#20;
     #referen@#0 = #3#0;
     #referen@#1 = #3#45;
     |LEE 000#referen@.=;
     |SI FSalida = 0; |O #3#45 = 0;
          #referen@#1 = 999;
          |LEE 000#referen@.];
          |SI FSalida = 0;
               |LEE 000#referen@.a;
          |SINO;
               |LEE 000#referen@.u;
          |FINSI;
          |SI FSalida = 0; |Y #referen@#20 = #3#20;  |Y #referen@#0 = #3#0;
               nLin = #referen@#1 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |SI nLin = #0#1; nLin = nLin + 1; |FINSI;
          #referen@#20 = #3#20;
          #referen@#0 = #3#0;
          #referen@#1 = nLin;
          |GRABA 020#referen@.b;
     |SINO;
          nLin = #3#45;
          |GRABA 020#referen@.b;
     |FINSI;
     |SALVA_DATOS #3;
     |REPON_DATOS #referen@;

     #referen@#1 = nLin;
     #referen@#5 = #3#48;
     #referen@#6 = 0;
     #referen@#7 = 0;
     #referen@#8 = 0;
     #referen@#9 = 0;
     #referen@#26 = 0;
     #referen@#27 = 0;
     #referen@#28 = 0;
     #referen@#29 = 0;
     #referen@#45 = -1;

     |SALVA_DATOS #3;
     |SALVA_DATOS #referen@;
     |REPON_DATOS #3;
     #3#1 = #referen@#1;
     enForma = 1;
     |HAZ AcumulaFC;
     |REPON_DATOS #3;

     |GRABA 020#referen@.a;
     |LIBERA #referen@;
|FPRC;

|PROCESO FacModLinea;
     #1134#0 = #0#3;
     #1134#1 = #3#2;
     |LEE 000#1134=;
     |SI FSalida = 0; |Y #0#1 ] #1134#6; |Y #0#1 [ #1134#7;
          #3#15 = #0#3; || cliente
          |HAZ PrecioCab84;
          nUniPromo = #3#5 / #1134#2;
          nResto = #3#5 $ #1134#2;
          nResto = nResto / #1134#2;
          nUniPromo = nUniPromo  - nResto;
          #3#6 = (#3#6 - #1134#4) ! nDeci_Base;
          #3#46 = #1134#4;
          #3#47 = #1134#5;
          #3#48 = nUniPromo * #1134#3;
          #3#8 = #1134#5;
          |HAZ TotalLin69;
          |SI #3#48 = 0;
               #3#45 = 0;
          |SINO;
               |HAZ CreaLinProCab84;
               #3#45 = nLin;
          |FINSI;
          |GRABA 020#3a;
     |SINO;    || No tiene promocion
          #3#45 = 0;
          #3#46 = 0;
          #3#47 = 0;
          #3#48 = 0;
          |HAZ TotalLin69;
          |GRABA 020#3a;
     |FINSI;
     |LIBERA #3;
|FPRC;

|PROCESO BorraLinPromo84;
     |SI #3#45 = -1;
          enForma = -1;
          |HAZ AcumulaFC;
          |BORRA 020#3a;
     |FINSI;
|FPRC;

|PROCESO FacModLin;
     |CONFI "0000SActualizar promociones para el nuevo cliente?";
     |SI FSalida = 0;
          |DDEF aAlfa;
          aAlfa = aAlfa + "agifa069";
          |CARGA_DEF aAlfa, referen@;
          |SI FSalida = 0;
               |ABRE #1134;
               |ABRE #referen@;
               |BUCLELIN 0 BorraLinPromo84 #0;
               |BUCLELIN 0 FacModLinea #0;
               |CIERRA #referen@;
               |CIERRA #1134;
               |DESCARGA_DEF #referen@;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GuerBorObra84;
     |DDEF aAlfa;
     aAlfa = aAlfa + "guerm059";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #0#48;
          #referen@#1 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida = 0; |BORRA 020#referen@.a; |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO GuerPinObra84;
     |DDEF aAlfa;
     aAlfa = aAlfa + "guerm059";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #0#48;
          #referen@#1 = #0#0;
          |LEE 000#referen@.=;
          |CIERRA #referen@;
          |PINTA 1157, "Pre        Obra      ";
          |ATRI I;
          |PINTA 1161, #referen@#4;
          |PINTA 1173, #referen@#3;
          |ATRI 0;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO GuerEntObra84;
     aAlfa = "guerm059;" + #0#3 + #0#48 + #0#0;
     |SUB_EJECUTA aAlfa;
     |HAZ GuerPinObra84;
|FPRC;
/*
|PROCESO &T084_15; |TIPO 15;
     nTipo = 15; |HAZ Log084;
|FPRC;

|PROCESO &T084_16; |TIPO 16;
     nTipo = 16; |HAZ Log084;
|FPRC;

|PROCESO &T084_17; |TIPO 17;
     nTipo = 17; |HAZ Log084;
|FPRC;

|PROCESO Log084;
     |DDEF aAlfa;
     aAlfa = aAlfa + "dsm00087";
     |CARGA_DEF aAlfa, dsm00087@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aSer = #0#48;
     aNum = ("000000" + #0#0) % -106;
     aTipo = "FD";

     |ABRE #dsm00087@;
     |DDEFECTO #dsm00087@;
     |SELECT #2#dsm00087@;
     #dsm00087@#1 = aSer;
     #dsm00087@#2 = aNum;
     #dsm00087@#3 = aTipo;
     |LEE 101#dsm00087@.=;
     |SI FSalida ! 0;
          |SELECT #1#dsm00087@;
          |LEE 000#dsm00087@.u;
          |SI FSalida = 0;
               nContaLog = #dsm00087@#0 + 1;
          |SINO;
               nContaLog = 1;
          |FINSI;
          |DDEFECTO #dsm00087@;
          #dsm00087@#0 = nContaLog;
          #dsm00087@#1 = aSer;
          #dsm00087@#2 = aNum;
          #dsm00087@#3 = aTipo;
          |GRABA 020#dsm00087@.b;
     |FINSI;
     |SI FSalida = 0;
          |HORA aAlfa;
          aUsu = Usuario % 810;
          |SI nTipo = 15;
               #dsm00087@#4 = aUsu;
               #dsm00087@#5 = ~;
               #dsm00087@#6 = aAlfa;
               #dsm00087@#7 = "";
               #dsm00087@#8 = "01.01.0000";
               #dsm00087@#9 = ""
               #dsm00087@#10 = "";
               #dsm00087@#11 = "01.01.0000";
               #dsm00087@#12 = ""
          |FINSI;
          |SI nTipo = 16;
               #dsm00087@#7 = aUsu;
               #dsm00087@#8 = ~;
               #dsm00087@#9 = aAlfa;
          |FINSI;
          |SI nTipo = 17;
               #dsm00087@#10 = aUsu;
               #dsm00087@#11 = ~;
               #dsm00087@#12 = aAlfa;
          |FINSI;
          |GRABA 020#dsm00087@.a;
     |FINSI;
     |CIERRA #dsm00087@;
     |DESCARGA_DEF #dsm00087@;
|FPRC;
*/
|PROCESO AsignaDir084;
     #0#91 = #49#1; |PINTA #0#91;
     ||#0#4 = #49#10; |PINTA #0#4;
     #0#29 = #49#10;|PINTA #0#29;
     #0#30 = #49#2; |PINTA #0#30;
     #0#31 = #49#3; |PINTA #0#31;
     #0#33 = #49#7; |PINTA #0#33;
     #0#64 = #49#6; |PINTA #0#64;
     |SI #49#14 = "  ";
         #0#6 = #6#25;
     |SINO;
         #0#6 = #49#14;
     |FINSI;
     |PINTA #0#6;

     |HAZ DatosCli;
|FPRC;

|PROCESO MinDir084;
     #49#0 = #0#3;
     #49#1 = 1;
|FPRC;

|PROCESO MaxDir084;
     #49#0 = #0#3;
     #49#1 = 9999;
|FPRC;

|PROCESO Dir084_0; |TIPO 0;
     |SI FSalida = 2; |ACABA; |FINSI;
     nTecla = FSalida;
     |SI nTecla = 12;    || F4 Alta direccion
          |PUSHV 0501 2380;
          |ENTLINEAL #1#49, -2, 1, 22, 1, MinDir084, MaxDir084;
          |POPV;
          nTecla = 18;
     |FINSI;
     |ABRE #49;
     |SI nTecla = 18;   || F10  Todas las direcciones
          #49#0 = #0#3;
          #49#1 = #0#91;
          |LEE 000#49];
          |CONSULTA_F_CLAVE #1#49, MinDir084, MaxDir084;
          |SI FSalida = 0;
               |HAZ AsignaDir084;
          |SINO;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;
     #49#0 = #0#3;
     #49#1 = #0#91;
     |LEE 000#49=;
     |SI FSalida = 0;
          |SI #49#18 = "N";
               |CONFI "0000NDireccion de entrega desactiva. ¿Continuar?";
               |SI FSalida ! 0; |ERROR; |ACABA; |FINSI;
          |FINSI;
     |SINO;
          |MENAV "0000No existe direccion de entrega...";
          |ERROR; |ACABA;
     |FINSI;
     |CIERRA #49;
     |SI #0Campo ! Contenido;
          |HAZ AsignaDir084;
     |FINSI;
|FPRC;

|PROCESO Dir084_7; |TIPO 7;
     |SI #41#71 = "S";
          |ABRE #49;
          #49#0 = #0#3;
          #49#1 = 1;
          |LEE 000#49];
          |SI FSalida = 0; |Y #49#0 = #0#3;
               |LEE 000#49s;
               |SI FSalida = 0; |Y #49#0 = #0#3;
                    aSinError = "S";
                    |HAZ Dir084_66;
                    aSinError = "N";
                    |SI nSal = 0; |ERROR; |FINSI;
               |FINSI;
          |FINSI;
          |CIERRA #49;
     |FINSI;
|FPRC;

|PROCESO Dir084_66; |TIPO 66;
     nModo = (FEntrada / 100) ! 0;
     |ABRE #49;
     aSql = "SELECT * FROM dsm00003 INTO sq" + Usuario + ".def WHERE ";
     aSql = aSql + "0 == " + #0#3 + " AND 18 == S";
     |SQL aSql;
     |SI FSalida = 0;
          |DDEF aDef; |QBF aDef;
          aDef = aDef + "sq" + Usuario + ".mas";
          |CARGA_DEF aDef, referen@;
          |SI FSalida = 0;
               |ABRE #referen@;
               #referen@#0 = #0#3;
               #referen@#1 = #0#91;
               |LEE 000#referen@.]
               |CONSULTA_CLAVE #1#referen@;
               nSal = FSalida;
               |SI FSalida = 0;
                    |SI nModo ! 2; |O #referen@#0 ! #0#3; |O #referen@#1 ! #0#91;
                         #49#0 = #referen@#0;
                         #49#1 = #referen@#1;
                         |LEE 020#49=;
                         |HAZ AsignaDir084;
                    |FINSI;
               |SINO;
                    |SI aSinError ! "S";
                         |ERROR;
                    |FINSI;
               |FINSI;
               |CIERRA #referen@;
               |DELINDEX #referen@;
               |DESCARGA_DEF #referen@;
               |FBORRA aDef;
          |FINSI;
     |FINSI;
     |CIERRA #49;
|FPRC;


|PROCESO GuerBorCerti;
     |DDEF aDef;
     aDef = aDef + "guerm223";
     |CARGA_DEF aDef, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          |SELECT #2#referen@;
          #referen@#16 = #0#48;
          #referen@#17 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida = 0;
               #referen@#12 = "N";
               #referen@#13 = "";
               #referen@#15 = "01.01.0000";
               #referen@#16 = "";
               #referen@#17 = 0;
               |GRABA 020#referen@.a;
          |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO Pago7_084; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo ! 1;  |ACABA;  |FINSI;

     |SI Campo = 8;
         |HAZ CargaContagen;
         |SI enOk = 1;
             |ABRE #agifa091;
             #agifa091#0 = #agifa084#8;
             |LEE 000#agifa091.=;
             |CONSULTA_CLAVE #1#agifa091;
             |SI FSalida = 0;
                 #agifa084#8 = #agifa091#0;
             |FINSI;
             |CIERRA #agifa091;
         |FINSI;
     |FINSI;

     |HAZ EsTagloma;
     |SI FSalida = 0;
         eaAlfa = #0#48;
         |HAZ TagloDefFP;
         |SI eaAlfa ! ""; #0#8 = eaAlfa; |PINTA #0#8; |FINSI;

         |SI eaQuitaDto = "S";
             #0#5 = 0; |PINTA #0#5;
             #0#32 = 0; |PINTA #0#32;
             #0#7 = 0; |PINTA #0#7;
         |FINSI;
     |FINSI;

     |HAZ EsGestral;
     |SI FSalida = 0;
         eaAlfa = #0#48;
         |HAZ GestrDefFP;
         |SI eaAlfa ! ""; #0#8 = eaAlfa; |PINTA #0#8; |FINSI;

         |SI eaQuitaDto = "S";
             #0#5 = 0; |PINTA #0#5;
             #0#32 = 0; |PINTA #0#32;
             #0#7 = 0; |PINTA #0#7;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO SolarBorra1;
     |SI nSwPrime = 0;
          nSwPrime = 1;
          |CONFI "0000NFactura de contrato mantenimiento. Continuar?";
          |SI FSalida ! 0;
               nSwSolar = 1;
               |ERROR10; |ACABA;
          |FINSI;
     |FINSI;
     #Referen@#12 = "";
     #Referen@#13 = "";
     #Referen@#18 = "";

     #Referen@#24 = "";
     #Referen@#25 = "";
     #Referen@#26 = "";
     #Referen@#27 = "";
     #Referen@#28 = "";
     #Referen@#29 = "";
     #Referen@#30 = "";
     #Referen@#31 = "";

     |GRABA 020#Referen@.a;
     |LIBERA #Referen@;

     #referen@#0 = #Referen@#0;
     #referen@#1 = #Referen@#1;
     #referen@#2 = #Referen@#2;
     #referen@#3 = #Referen@#3;
     |LEE 101#referen@.=
     |SI FSalida = 0;
          #referen@#6 = #referen@#6 - #Referen@#9;
          |GRABA 020#referen@.a;
          |LIBERA #referen@;
     |FINSI;
|FPRC;

|DEFBUCLE SolarBorra1;
     #Referen@#4003;
     ;
     #0#48, #0#0, 0;
     #0#48, #0#0, 999;
     be;
     NULL, SolarBorra1;
|FIN;

|PROCESO SolarBorra2;
     |SI nSwPrime = 0;
          nSwPrime = 1;
          |CONFI "0000NFactura de contrato mantenimiento. Continuar?";
          |SI FSalida ! 0;
               nSwSolar = 1;
               |ERROR10; |ACABA;
          |FINSI;
     |FINSI;
     #Referen@#15 = "";
     #Referen@#16 = "";
     #Referen@#19 = "";
     |GRABA 020#Referen@.a;
     |LIBERA #Referen@;
|FPRC;

|DEFBUCLE SolarBorra2;
     #Referen@#5003;
     ;
     #0#48, #0#0, 0;
     #0#48, #0#0, 999;
     be;
     NULL, SolarBorra2;
|FIN;

|PROCESO SolarBaja;
     nSwPrime = 0;
     nSwSolar = 0;
     |DDEF aPath;
     aAlfa = aPath + "solm0005";
     |CARGA_DEF aAlfa, Referen@;
     |SI FSalida = 0;
          aAlfa = aPath + "solm0017";
          |CARGA_DEF aAlfa, referen@;
          |SI FSalida = 0;
               aAlfa = #0#87 % 505;
               |QBF aAlfa;
               |DFICE aPath;
               |SI aAlfa ! "";
                    aPos = aPath % A0;
                    nPos = aPos;
                    nPos = nPos - 6 + 100;
                    aPath = aPath % nPos;
                    aAlfa = aPath + aAlfa + "/";
                    |PATH_DAT #Referen@#aAlfa#;
                    |BUCLE SolarBorra2;
               |SINO;
                    |PATH_DAT #Referen@#aPath#;
                    |ABRE #referen@;
                    |BUCLE SolarBorra1;
                    |CIERRA #referen@;
               |FINSI;
               |DESCARGA_DEF #referen@;
          |FINSI;
          |DESCARGA_DEF #Referen@;
     |FINSI;
     FSalida = nSwSolar;
|FPRC;

|PROCESO SolarBajaCto;
     nSwSolar = 0;
     |DDEF aAlfa;
     aAlfa = aAlfa + "solm0010";
     |CARGA_DEF aAlfa, Referen@;
     |SI FSalida = 0;
          |ABRE #Referen@;
          |SELECT #3#Referen@;
          #Referen@#7 = #0#48;
          #Referen@#8 = #0#0;
          |LEE 101#Referen@.=;
          |SI FSalida = 0;
               |CONFI "0000NFactura de contrato ventas. Continuar?";
               |SI FSalida = 0;
                    #Referen@#7 = "";
                    #Referen@#8 = "";
                    |GRABA 020#Referen@.a;
                    nSwSolar = 0;
               |SINO;
                    nSwSolar = 1;
               |FINSI;
          |FINSI;
          |CIERRA #Referen@;
          |DESCARGA_DEF #Referen@;
     |FINSI;
     FSalida = nSwSolar;
|FPRC;

|PROCESO MalpPinInciObra;
     |PINTA 525, "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ";
     |DDEF aAlfa;
     aAlfa = aAlfa + "malpe185";
     |CARGA_DEF  aAlfa, Referen@;
     |SI FSalida = 0;
          |ABRE #Referen@;
          #Referen@#0 = #0#3;
          #Referen@#1 = #0#91;
          #Referen@#2 = 1;
          |LEE 000#Referen@.];
          |SI FSalida = 0; |Y #Referen@#0 = #0#3; |Y #Referen@#1 = #0#91;
               |ATRI S; |PINTA 525, " Obra con incidencias "; |ATRI 0;
               |PARA; |SI FSalida = 0; |Y #Referen@#0 = #0#3; |Y #Referen@#1 = #0#91; |HACIENDO;
                    |SI #Referen@#7 = "A";
                         |ATRI S; |PINTA 525, " OBRA CON INCIDENCIAS ABIERTAS "; |ATRI 0;
                    |FINSI;
                    |LEE 000#Referen@.s;
               |SIGUE;
          |FINSI;
          |CIERRA #Referen@;
          |DESCARGA_DEF #Referen@;
     |FINSI;
|FPRC;

|PROCESO MalpInciObra;
     eaCliente = #0#3;
     enObra = #0#91;
     enModo = 4;
     |SUB_EJECUTA_NP "malpe185";
|FPRC;

|PROCESO Tipo84_20; |TIPO 20;
     |SI FSalida ! "OPCION";
          |SELECT #1#0;
          |LEE 000#0=;
          |SI FSalida ! 0;
               |MENAV "0000Por favor, consulte el registro correcto antes de imprimir.";
               |ACABA;
          |SINO;
               |PINDA #0#0;
          |FINSI;
     |FINSI;
     |HAZ T84_20;
|FPRC;

|PROCESO T84_20;
     aSal = FSalida;

     |HAZ EsMalpesa; nSwMalpesa = FSalida;
     |HAZ EsOTP; nSwOTP = FSalida;

     |SI aSal = "OPCION";
          FSalida = "Imprimir"; ||... la estandar
          |SI nSwMalpesa = 0; |O nSwOTP = 0;
               FSalida = "Opciones";
          |FINSI;
     |SINO;
          |LEE 101#0=;
          |SI FSalida ! 0; |AVISO; |ACABA; |FINSI;

          |SI nSwMalpesa = 0;
               |MENU aMenuMal;
               |SI FSalida = 1;
                    |HAZ impreal;
               |FINSI;
               |SI FSalida = 2;
                    |HAZ MalpInciObra;
               |FINSI;
               |LIBERA #0;
               |ACABA;
          |FINSI;
          |SI nSwOTP = 0;
               |MENU aMenuOtp;
               |SI FSalida = 1;
                    |HAZ impreal;
               |FINSI;
               |SI FSalida = 2;
                    eaSerie = #0#48;
                    enNumero = #0#0;
                    |SUB_EJECUTA_NP "otpm0003";
               |FINSI;
               |LIBERA #0;
               |ACABA;
          |FINSI;

          ||... la estandar
          |HAZ impreal;
     |FINSI;
|FPRC;

|PROCESO BajaAsistente;
     |DDEF aAlfa;
     aAlfa = aAlfa + "guerm043";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          #referen@#0 = #0#48;
          #referen@#1 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida = 0; |BORRA 020#referen@.a; |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO AvisoAsistente;
     |DDEF aAlfa;
     aAlfa = aAlfa + "guerm043";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          #referen@#0 = #0#48;
          #referen@#1 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida = 0;
               |MENAV "0000Factura introducida desde el 'Asistente Imputación Obra'. Las modificaciones no se reflejaran.";
          |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO CtrlFecha084;
     nSal = 0;
     |ABRE #41; |LEE 000#41p; |CIERRA #41;
     |SI #41#73 = "S";
          |DDEF aAlfa;
          aAlfa = aAlfa + "agifa084";
          |CARGA_DEF aAlfa, Referen@;
          |SI FSalida = 0;
               |ABRE #Referen@;
               #Referen@#48 = #0#48;
               #Referen@#0 = #0#0;
               |LEE 000#Referen@.=;
               |LEE 000#Referen@.a;
               |SI FSalida = 0; |Y #Referen@#48 = #0#48; |Y #Referen@#0 < #0#0;
                    |SI #Referen@#1 > #0#1;
                         aAlfa = "0000Factura anterior con fecha " + #Referen@#1;
                         nSal = 1;
                    |FINSI;
               |FINSI;
               #Referen@#48 = #0#48;
               #Referen@#0 = #0#0;
               |LEE 000#Referen@.=;
               |LEE 000#Referen@.s;
               |SI FSalida = 0; |Y #Referen@#48 = #0#48; |Y #Referen@#0 > #0#0;
                    |SI #Referen@#1 < #0#1;
                         aAlfa = "0000Factura posterior con fecha " + #Referen@#1;
                         nSal = 2;
                    |FINSI;
               |FINSI;
               |CIERRA #Referen@;
               |DESCARGA_DEF #Referen@;
          |FINSI;
          |SI #41#26 = "S"; |Y nSal = 0;
               |ABRE #134;
               #134#49 = #0#48;
               #134#0 = #0#0;
               |LEE 000#134];
               |SI FSalida ! 0;
                    |LEE 000#134u;
               |SINO;
                    |LEE 000#134a;
               |FINSI;
               |SI FSalida = 0; |Y #134#49 = #0#48; |Y #134#0 < #0#0;
                    |SI #134#1 > #0#1;
                         aAlfa = "0000Factura anterior con fecha " + #134#1;
                         nSal = 1;
                    |FINSI;
               |FINSI;
               #134#49 = #0#48;
               #134#0 = #0#0
               |LEE 000#134];
               |SI FSalida ! 0; |LEE 000#134u; |FINSI;
               |SI FSalida = 0; |Y #134#49 = #0#48; |Y #134#0 > #0#0;
                    |SI #134#1 < #0#1;
                         aAlfa = "0000Factura posterior con fecha " + #134#1;
                         nSal = 2;
                    |FINSI;
               |FINSI;
               |CIERRA #134;
          |FINSI;
     |FINSI;
     |SI nSal > 0; |MENAV aAlfa; |FINSI;
     FSalida = nSal;
|FPRC;

|PROCESO Bloquea; |TIPO 8;
     nSwConsulta = 0;

     |HAZ EsOTP;
     |SI FSalida = 0;
          aSwParamOTP = "N";

          |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dspreven/def/visalm36.mas";
          |CARGA_DEF aAlfa, ParamOTP@;
          |SI FSalida = 0;
               |HAZ EmpresaPrevencion;

               |DBASS aAlfa; |QBF aAlfa;
               aAlfa = aAlfa + "dspreven/fich/" + eaEmpresa + "/"; |PATH_DAT #ParamOTP@#aAlfa#;
               |ABRE #ParamOTP@;
               |LEE 000#ParamOTP@.p;
               |SI FSalida ! 0; |DDEFECTO #ParamOTP@; |FINSI;
               aAlfa = "|NC"; aAlfa = #ParamOTP@#aAlfa#; nCalc = aAlfa;
               aSwParamOTP = #ParamOTP@#39;
               |CIERRA #ParamOTP@;
               |DESCARGA_DEF #ParamOTP@;

               |SI aSwParamOTP = "S";
                    |DFICE aAlfa6;
                    |DBASS aAlfa6; |QBF aAlfa6;
                    aAlfa6 = aAlfa6 + "dspreven/def/dsvim999.mas";
                    |CARGA_DEF aAlfa6, RefBloq@;
                    |SI FSalida = 0;
                         |DBASS aAlfa6; |QBF aAlfa6;
                         aAlfa6 = aAlfa6 + "dspreven/fich/" + (("00000" + #48#0) % -105) + "/";
                         |PATH_DAT #RefBloq@#aAlfa6#;
                         |ABRE #RefBloq@;
                         |LEE 140#RefBloq@.p;
                         |SI FSalida = 111;
                              |DDEFECTO #RefBloq@;
                              aAlfa = Usuario % 0810; #RefBloq@#1 = aAlfa;
                              |GRABA 020#RefBloq@.b;
                              nSwConsulta = 0;
                         |SINO;
                              |SI FSalida = 107;
                                   |LEE 000#RefBloq@.p;
                                   aAlfa = "    Usuario " + #RefBloq@#1; |QBF aAlfa;
                                   aAlfa = aAlfa + " facturando. Activado modo CONSULTA.";
                                   |MENAV aAlfa;
                                   nSwConsulta = 1;
                              |SINO;
                                   |SI FSalida = 0;
                                        aAlfa = Usuario % 0810; #RefBloq@#1 = aAlfa;
                                        |GRABA 020#RefBloq@.a;
                                        nSwConsulta = 0;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     FSalida = "::ENDATOS::SINBOTONES::";
|FPRC;

|PROCESO Desbloquea; |TIPO 9;
     |HAZ EsOTP;
     |SI FSalida = 0;
          |SI aSwParamOTP = "S";
               #RefBloq@#1 = "";
               |GRABA 040#RefBloq@.a;
               |LIBERA #RefBloq@;
               |CIERRA #RefBloq@;
               |DESCARGA_DEF #RefBloq@;
          |FINSI;
          nSwConsulta = 0;
     |FINSI;
|FPRC;

|PROCESO SolarBorFac;
     |DDEF aAlfa;
     aAlfa = aAlfa + "solm0016";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          |SELECT #2#referen@;
          #referen@#7 = #0#48;
          #referen@#8 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida = 0;
               |SELECT #1#referen@;
               |LEE 121#referen@.=;
               #referen@#7 = "";
               #referen@#8 = 0;
               |GRABA 020#referen@.a;
          |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO ConstruCheqModi;
     |DDEF aAlfa;
     aAlfa = aAlfa + "goparame";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar 'goparame'"; |ACABA;
     |FINSI;
     |ABRE #referen@; |LEE 000#referen@.p; |CIERRA #referen@;
     aAlfa = #referen@#125;
     |DESCARGA_DEF #referen@;
     |SI aAlfa = "N"; |ACABA; |FINSI;

     |DDEF aAlfa;
     aAlfa = aAlfa + "gocerlin";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error al cargar 'gocerlin'"; |ACABA;
     |FINSI;
     |ABRE #referen@; |SELECT #2#referen@;
     #referen@#4 = #0#48;
     #referen@#5 = #0#0;
     |LEE 000#referen@.=;
     |SI FSalida = 0;
          |MENAV "0000Factura de certificación. Modificar desde certificación.";
          nSwFlag = 1;
     |FINSI;
     |CIERRA #referen@;
     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO IVA084_66; |TIPO 66;
     enTiva = #0Campo;
     efFiva = #0#1;
     |HAZ ConsuIVA;
     |SI eaDiva = "";
          |ERROR;
     |SINO;
          #0Campo = enTiva; |PINTA #0Campo;
     |FINSI;
|FPRC;

|PROCESO IVA084_0; |TIPO 0;
     enTiva = #0Campo;
     efFiva = #0#1;
     |HAZ SacaIVA;
     |SI eaDiva = "";
          |MENAV "0000No existe tipo iva para esta fecha...";
          |ERROR; |ACABA;
     |SINO;
          |HAZ caltotal;
     |FINSI;
|FPRC;

|PROCESO Curso84_7; |TIPO 7;
     |HAZ EsForestales;
     |SI FSalida = 0;
          |MENSA "0000<F2> Seleccion expediente";
     |FINSI;
     |HAZ EsConstru;
     |SI FSalida = 0;
        |HAZ PonMensa000con;
     |FINSI;
|FPRC;

|PROCESO Curso84_0; |TIPO 0;
     nSalida = FSalida;
     |HAZ EsForestales;
     |SI FSalida = 0;
          |SI nSalida = 10;   ||F2
               |DDEF aAlfaX; |QBF aAlfaX;
               aAlfaX = aAlfaX + "gomantho.mas";
               |CARGA_DEF aAlfaX, Referen@;
               |SI FSalida = 0;
                    |ABRE #Referen@;
                    |CONSULTA_CLAVE #1#Referen@;
                    |SI FSalida = 0;
                         aExpediente = #Referen@#0;
                         |QBF aExpediente;
                         aExpediente = aExpediente + "/" + #Referen@#1;
                         |QBF aExpediente;
                         #agifa084#87 = aExpediente;
                         |PINTA #agifa084#87;
                         ||TODO CCC
                    |FINSI;
                    |CIERRA #Referen@;
                    |DESCARGA_DEF #Referen@;
               |FINSI;
          |FINSI;
          aAlfa = #0#87; |QBF aAlfa;
          |SI aAlfa = "";
               |MENAV "0000Campo obligatorio...";
               |ERROR;
          |SINO;
               |MENSA "0000                         ";
          |FINSI;
     |FINSI;
     |HAZ EsConstru;
     |SI FSalida = 0;
        enTecla = nSalida; |HAZ CogeObra000con;
     |FINSI;
|FPRC;

|PROCESO DocWeb;
     |DDEF aAlfa;
     aAlfa = aAlfa + "coima038";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          #referen@#0 = "FD";
          #referen@#1 = #0#48;
          #referen@#2 = #0#0;
          |SI enModoCab84 = 3;
               |BORRA 000#referen@.c;
          |SINO;
               |LEE 101#referen@.=;
               |SI FSalida ! 0; |GRABA 020#referen@.b; |FINSI;
               #referen@#3 = #0#1;
               #referen@#4 = "N";
               |GRABA 020#referen@.a;
          |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO Min84;
     #0#48 = aSer;
     #0#0 = 000001;
|FPRC;

|PROCESO Max84;
     #0#48 = aSer;
     #0#0 = 999999;
|FPRC;

|PROCESO T84_66; |TIPO 66;
     |HAZ EsSecap;
     |SI FSalida = 0;
          aSer = #0#48;
          |CONSULTA_F_CLAVE #1#0, Min84, Max84;
     |SINO;
          |CONSULTA_CLAVE #1#0;
     |FINSI;
|FPRC;

|PROCESO SecapAnuFac;
     |DDEF aAlfa;
     aAlfa = aAlfa + "dsecap10";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          |SELECT #2#referen@;
          #referen@#5 = #0#48;
          #referen@#6 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida = 0;
               aSer = #referen@#0; aNum = #referen@#1;
               #referen@#5 = "";
               #referen@#6 = 0;
               |GRABA 020#referen@.a;
          |FINSI;

          |SELECT #3#referen@;
          #referen@#8 = #0#48;
          #referen@#9 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida = 0;
               aSer = #referen@#0; aNum = #referen@#1;
               #referen@#8 = "";
               #referen@#9 = 0;
               |GRABA 020#referen@.a;
          |FINSI;

          |SELECT #4#referen@;
          #referen@#10 = #0#48;
          #referen@#11 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida = 0;
               aSer = #referen@#0; aNum = #referen@#1;
               #referen@#10 = "";
               #referen@#11 = 0;
               |GRABA 020#referen@.a;
          |FINSI;

          |SELECT #5#referen@;
          #referen@#12 = #0#48;
          #referen@#13 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida = 0;
               aSer = #referen@#0; aNum = #referen@#1;
               #referen@#12 = "";
               #referen@#13 = 0;
               |GRABA 020#referen@.a;
          |FINSI;

          |SELECT #1#referen@;
          #referen@#12 = aSer;
          #referen@#13 = aNum;
          |LEE 101#referen@.=;
          |SI FSalida = 0; |Y #referen@#6 = 0; |Y #referen@#9 = 0;
                    |Y #referen@#11 = 0; |Y #referen@#13 = 0;
               #referen@#4 = "P";
               |GRABA 020#referen@.a;
          |FINSI;

          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |SINO;
          |MENAV "0000Error al cargar 'dsecap10'";
     |FINSI;
|FPRC;

|PROCESO SecapUltima;
     aSerie = #0#48; nContador = #0#0;
     |SALVA_FICHA #0;
     |LEE 000#0s;
     |SI FSalida = 0; |Y #0#48 = aSerie;
          |AVISO;
          aAlfa = "0000NLa factura no es la ultima." + &13 + "Borrar Factura:";
          |CONFI aAlfa;
          |SI FSalida ! 0; nSwFlag = 1; |FINSI;
     |FINSI;
     |REPON_FICHA #0;
|FPRC;

|PROCESO SecapModConta;
     aSerie = #0#48; nContador = #0#0;
     |SALVA_FICHA #0;
     |LEE 000#0s;
     |SI FSalida ! 0; |O #0#48 ! aSerie;
          |SI #41#26 = "S";
               aAlfa = "vfactura";
          |SINO;
               aAlfa = "vfactuco";
          |FINSI;
          |ABRE #42;
          #42#2 = aSerie;
          #42#0 = aAlfa;
          |LEE 101#42=;
          |SI FSalida ! 0; |GRABA 020#42b; |FINSI;
          #42#1 = nContador;
          |GRABA 020#42a;
          |CIERRA #42;
     |FINSI;
     |REPON_FICHA #0;
|FPRC;

|PROCESO OTPUltima;
     |DBASS aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "dspreven/def/maesm015.mas";
     |CARGA_DEF aAlfa, ParamOTP@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |DBASS aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "dspreven/fich/";
     |PATH_DAT #ParamOTP@#aAlfa#;

     |ABRE #ParamOTP@;
     aAlfa = Usuario % 810;
     #ParamOTP@#0 = aAlfa;
     |LEE 000#ParamOTP@.=;
     |SI FSalida ! 0;  |DDEFECTO #ParamOTP@;  |FINSI;
     |CIERRA #ParamOTP@;

     aAlfa = #ParamOTP@#13;

     |DESCARGA_DEF #ParamOTP@;

     aSerie    = #0#48;
     nContador = #0#0;
     |SALVA_FICHA #0;
     |LEE 000#0s;
     |SI FSalida = 0; |Y #0#48 = aSerie;
         |SI aAlfa = "S";
             aAlfa = "0000NLa factura no es la ultima." + &13 + "Borrar Factura:";
             |CONFI aAlfa;
             |SI FSalida ! 0; nSwFlag = 1; |FINSI;
         |SINO;
             |MENAV "0000No puede borrar la factura por existir un numero superior.";
             nSwFlag = 1;
         |FINSI;
     |FINSI;
     |REPON_FICHA #0;
|FPRC;

|PROCESO JumiBorFac;
     |DDEF aAlfa;
     aAlfa = aAlfa + "juminf10";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          |SELECT #2#referen@;
          #referen@#5 = #0#48;
          #referen@#6 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida = 0;
               #referen@#4 = "P";
               #referen@#5 = "";
               #referen@#6 = 0;
               |GRABA 020#referen@.a;
          |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO DocErp;
     nSwEstaDocErp = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE DocErp;
     #referen@#1005;
     ;
     aAplicaErp, nEmpErp, aDefErp, aClaveErp, 01;
     aAplicaErp, nEmpErp, aDefErp, aClaveErp, 99;
     ;
     NULL, DocErp;
|FIN;

|PROCESO MiraSiEstaDocErp;
     |DBASS aBass;
     |QBF aBass;
     aErp = aBass + "dserp/def/dserpm09.mas";
     |XABRE "E", aErp, 0;
     |SI FSalida ] 0;
          |CARGA_DEF aErp, referen@;
          |SI FSalida = 0;
                 aPathErp = aBass + "dserp/fich/";
                 |PATH_DAT #referen@#aPathErp#;

                 aCien = " " * 100;
                 nEmpErp = #48#0;
                 aAplicaErp = "dscomer9";
                 aDefErp = "0";
                 aClaveErp = #0#48 + ("000000" + #0#0) % -106;
                 |QBF aClaveErp;
                 aClaveErp = (aClaveErp + aCien) % 199;
                 aClaveErp = aClaveErp + " ";

                 |BUCLE DocErp;

                 |DESCARGA_DEF #referen@;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CtrlRiesgoTaglo;
     |SI enErrRie ! 0;
          |HAZ EsTagloma;
          |SI FSalida = 0;
               |DDEF aAlfa; aAlfa = aAlfa + "tagm0059";
               |CARGA_DEF aAlfa, referen@;
               |SI FSalida = 0;
                    |ABRE #referen@;
                    #referen@#0 = #0#48;
                    |LEE 000#referen@.=;
                    |SI FSalida = 0;
                         |CONFI "0000N¿El pago se realizará en efectivo?";
                         |SI FSalida = 0; enErrRie = 0; |FINSI;
                    |FINSI;
                    |CIERRA #referen@;
                    |DESCARGA_DEF #referen@;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ObsCli84;
     |SI #agifa142#14 = "S";
          aAlfa = #agifa024#53;     |QBF aAlfa;
          |SI aAlfa ! "";
               |PUSHV 1008 1370;
               |SI #agifa142#20 = "S"; |AVISO; |FINSI;
               |BLANCO 1008 1370;
               |CUADRO 1008 1370;
               |ATRI R;
               |PINTA 1110 , #agifa024#53;
               |ATRI 0;
               |PAUSA;
               |POPV;
          |FINSI;
     |FINSI;
|FPRC;
