|FICHEROS;
     agifa010;
     agifa071;

     agifa134;
     agifa059;

     fa134@;
     fa059@;
     al010@;
     al071@;
|FIN;

|VARIABLES;
     nError              = 0;
     nHandle             = 0;
     nLong               = 0;
     nCarac              = 0;
     nPos                = 0;
     nOk                 = 0;
     nConta              = 0;
     nCampo              = 0;
     nCaracter           = 0;
     nCmp                = 0;
     nSwHay              = 0;
     nCalc               = 0;
     nCmpAnt             = 0;
     nSw                 = 0;
     nDLin               = 0;
     FEstado             = 0;

     aDef                = "";
     aMas                = "";
     aBase               = "";
     aCadena             = "";
     aCarac1             = "";
     aFic                = "";
     aTab                = "";
     aBorra              = "";
     aTextoIni           = "";
     aAbre               = "";
     aPath               = "";
     aAlfa               = "";
     aAlfa1              = "";
     aAlfaX              = "";
     aFichero            = "";
     aFichAnt            = "";
     aRuta               = "";
     aAux                = "";
     aPrograma           = "";
     aPathDSSelect       = "";
     aParaIni            = "";
     aCarpetaCaptura     = "/";
     aEjecuta            = "";
     aLong               = "";
     aCarac              = "";
     aProg               = "";
     aPos                = "";
     aDirLocal           = "";
     aFicCSV             = "";
     aContab             = "";
     Comodin             = "";
     Comodin1            = "";
     aCampoA             = "";
     aCampoB             = "";
     aCampoC             = "";
     aCampoD             = "";
     aCampoE             = "";
     aCampoF             = "";
     aCampoG             = "";

     {1}aLocal           = "";

     &eaUnidad           = "";
     &enError            = 0;
     &ser_fac            = "";
     &num_fac            = 0;
     &eaProg             = "";
     &enPres             = 0;
     &efFechaForm        = @;
     &PRMNT_enError      = 0;
     &enReContab         = 0;
|FIN;

/*
|PROCESO agifa071B;
     |BORRA 020#agifa071.a;
     |LIBERA #agifa071;
|FPRC;

|DEFBUCLE agifa071B;
     #agifa071#1;
     ;
     #agifa010#52, #agifa010#0, 000;
     #agifa010#52, #agifa010#0, 999;
     be;
     NULL, agifa071B;
|FIN;

|PROCESO agifa059B;
     #agifa010#52 = #agifa059#15;
     #agifa010#0  = #agifa059#2;
     |LEE 101#agifa010.=;
     |SI FSalida = 0;
         |BUCLE agifa071B;

         |BORRA 020#agifa010.a;
         |LIBERA #agifa010;
     |FINSI;

     |BORRA 020#agifa059.a;
     |LIBERA #agifa059;
|FPRC;

|DEFBUCLE agifa059B;
     #agifa059#1;
     ;
     #agifa134#49, #agifa134#0, 000;
     #agifa134#49, #agifa134#0, 999;
     be;
     NULL, agifa059B;
|FIN;

|PROCESO fa059;
     |PARA nCmp = 0;  |SI nCmp [ 45;  |HACIENDO nCmp = nCmp + 1;
           #agifa059#nCmp# = #fa059@#nCmp#;
     |SIGUE;

     #agifa059#14 = aCampoB;
     #agifa059#0  = aCampoC;
     |GRABA 020#agifa059.n;
     |LIBERA #agifa059;

     |BORRA 020#fa059@.a;
     |LIBERA #fa059@;
|FPRC;

|DEFBUCLE fa059;
     #fa059@#1003;
     ;
     #fa134@#49, #fa134@#0, 000;
     #fa134@#49, #fa134@#0, 999;
     be;
     NULL, fa059;
|FIN;

|PROCESO GrabaReg;
     |QBF aCampoB;
     |QBF aCampoC;
     |QBF aCampoD;
     |QBF aCampoE;
     |QBF aCampoF;
     |QBF aCampoG;

     #agifa134#49 = aCampoB;
     #agifa134#0  = aCampoC;
     |LEE 101#agifa134.=;
     |SI FSalida = 0;
         |BUCLE agifa059B;

         |BORRA 020#agifa134.a;
         |LIBERA #agifa134;
     |FINSI;

     |SI aCampoE ! "";
         #fa134@#49 = aCampoD;
         #fa134@#0  = aCampoE;
         |LEE 101#fa134@.=;
         |SI FSalida = 0;
             |BUCLE fa059;

             |PARA nCmp = 0;  |SI nCmp [ 125;  |HACIENDO nCmp = nCmp + 1;
                   #agifa134#nCmp# = #fa134@#nCmp#;
             |SIGUE;

             #agifa134#49 = aCampoB;
             #agifa134#0  = aCampoC;
             #agifa134#45 = "N";
             #agifa134#48 = "N";

             |GRABA 020#agifa134.n;
             |LIBERA #agifa134;

             |BORRA 020#fa134@.a;
             |LIBERA #fa134@;

             |ACABA;
         |FINSI;
     |FINSI;

     |SI aCampoG ! "";
         #agifa134#49 = aCampoF;
         #agifa134#0  = aCampoG;
         |LEE 101#agifa134.=;
         |SI FSalida = 0;
             #agifa134#45 = "N";
             #agifa134#48 = "N";

             |GRABA 020#agifa134.a;
             |LIBERA #agifa134;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO BorraCampos;
     aCampoA  = "";
     aCampoB  = "";
     aCampoC  = "";
     aCampoD  = "";
     aCampoE  = "";
     aCampoF  = "";
     aCampoG  = "";
|FPRC;

|PROCESO RecogeCSV;
     |DBASE aBase;

     aAbre = aFicCSV;
     |XABRE "C", aAbre, nHandle;
     |PARA;  |SI FSalida ] 0;  |HACIENDO;
          |XLEE nHandle, 250, aAlfa;
          |SI FSalida < 0;  |SAL;  |FINSI;

          |HAZ BorraCampos;

          aCadena = aAlfa;  |QBF aCadena;
          aLong   = aCadena % 0;
          nLong   = aLong;
          nCampo  = 1;
          aTab    = ";";

          |PARA nCaracter = 1;  |SI nCaracter [ nLong;  |HACIENDO nCaracter = nCaracter + 1;
                nPos    = (100 * nCaracter) + 1;
                aCarac1 = aCadena % nPos;
                |SI aCarac1 = aTab;
                    nCampo = nCampo + 1;
                |SINO;
                    |SI nCampo = 1;   aCampoA  = aCampoA  + aCarac1;  |FINSI;
                    |SI nCampo = 2;   aCampoB  = aCampoB  + aCarac1;  |FINSI;
                    |SI nCampo = 3;   aCampoC  = aCampoC  + aCarac1;  |FINSI;
                    |SI nCampo = 4;   aCampoD  = aCampoD  + aCarac1;  |FINSI;
                    |SI nCampo = 5;   aCampoE  = aCampoE  + aCarac1;  |FINSI;
                    |SI nCampo = 6;   aCampoF  = aCampoF  + aCarac1;  |FINSI;
                    |SI nCampo = 7;   aCampoG  = aCampoG  + aCarac1;  |FINSI;

                    |SI nCampo > 7;  |SAL;  |FINSI;
                |FINSI;
          |SIGUE;

          |HAZ GrabaReg;
     |SIGUE;
     |XCIERRA nHandle;
|FPRC;

|PROCESO CogeCSV;
     nOk   = 1;
     aRuta = "";
     |HAZ Traete_dsselect;
     |SI enError = 1;
         nOk = 1;
         |MENAV "0000No puedo instalar el dsselect.exe, consulte con su administrador";
     |FINSI;

     |ESPECIFICA "RBASS", aLocal;
     aDirLocal = aLocal;

     |HAZ DimeUnidad;
     aAux      = eaUnidad + ":\DOCUMENTOS";               |RMKDIR aAux;
     aAux      = eaUnidad + ":\DOCUMENTOS\DSCOMER9";      |RMKDIR aAux;
     aAux      = eaUnidad + ":\DOCUMENTOS\DSCOMER9\";
     aPrograma = aAux + "dsselect.exe";

     aPathDSSelect = aAux;
     aBorra = aPathDSSelect + "dsselect.txt";
     |RFBORRA aBorra;

     aParaIni = aAux + "dsselect.ini";
     |RFBORRA aParaIni;

     aCarpetaCaptura = "/";

     aTextoIni = &34 + aCarpetaCaptura + &34 + " " + &34 + aBorra + &34;
     |XABRE "CW", aParaIni, nHandle;
     |SI FSalida ] 0;
          |XGRABA nHandle, aTextoIni;
     |FINSI;
     |XCIERRA nHandle;

     aEjecuta = aPrograma;
     |RSYSTEM aEjecuta;

     aAbre = aPathDSSelect + "dsselect.txt";
     |XABRE "CU", aAbre, nHandle;
     |SI FSalida < 0;
        aPath = "";
        nOk   = 0;
        |ACABA;
     |FINSI;

     |XLEE nHandle, 250, aPath;
     |SI FSalida < 0
         aPath = "";
         nOk   = 0;
         |ACABA;
     |FINSI;

     |QBF aPath;
     |SI aPath ! "";
         aAlfa    = aPath;
         aFichero = "";
         aLong    = aAlfa % 0;
         nLong    = aLong;
         aRuta    = "";
         |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
               nPos   = (nCarac * 100) + 1;
               aCarac =  aAlfa % nPos;
               |SI aCarac = "/";  |O aCarac = "\";
                   aProg = "";
               |SINO;
                   aProg = aProg + aCarac;
               |FINSI;

               aRuta = aRuta + aCarac;
         |SIGUE;
     |FINSI;
     |XCIERRA nHandle;

     aBorra = aPathDSSelect + "dsselect.txt";
     |RFBORRA aBorra;

     aFicCSV = aRuta < "";

     aAlfa = aFicCSV - ".csv";
     |SI FSalida = 0;
         aAlfa = "0000El fichero deber  tener extesi¢n CSV";
         |MENAV aAlfa;
         nOk = 0;

         |ACABA;
     |FINSI;
|FPRC;

|PROGRAMA;
     |HAZ CogeCSV;
     |SI nOk = 0;  |ACABA;  |FINSI;

     |CONFI "0000SRealizamos el cambio";
     |SI FSalida ! 0;  |ACABA;  |FINSI;

|DEBUG;
     |HAZ RecogeCSV;
|FPRO;

|PROCESO T80;  |TIPO 80;
     |DDEF aDef;
     aMas = aDef + "agifa010.mas";  |CARGA_DEF aMas, al010@;
     aMas = aDef + "agifa071.mas";  |CARGA_DEF aMas, al071@;
     aMas = aDef + "agifa134.mas";  |CARGA_DEF aMas, fa134@;
     aMas = aDef + "agifa059.mas";  |CARGA_DEF aMas, fa059@;

     |ABRET #agifa134;
     |ABRET #agifa059;
     |ABRET #agifa010;
     |ABRET #agifa071;
     |ABRET #al010@;
     |ABRET #al071@;
     |ABRET #fa134@;
     |ABRET #fa059@;
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #agifa134;
     |CIERRAT #agifa059;
     |CIERRAT #agifa010;
     |CIERRAT #agifa071;
     |CIERRAT #al010@;
     |CIERRAT #al071@;
     |CIERRAT #fa134@;
     |CIERRAT #fa059@;

     |DESCARGA_DEF #fa059@;
     |DESCARGA_DEF #fa134@;
     |DESCARGA_DEF #al071@;
     |DESCARGA_DEF #al010@;
|FPRC;

*/

|PROCESO al071;
     |PARA nCmp = 0;  |SI nCmp [ 66;  |HACIENDO nCmp = nCmp + 1;
           #agifa071#nCmp# = #al071@#nCmp#;
     |SIGUE;

     |GRABA 020#agifa071.n;
     |LIBERA #agifa071;
|FPRC;

|DEFBUCLE al071;
     #al071@#1003;
     ;
     #al010@#52, #al010@#0, 000;
     #al010@#52, #al010@#0, 999;
     ;
     NULL, al071;
|FIN;

|PROCESO al010;
     #agifa010#52 = #al010@#52;
     #agifa010#0  = #al010@#0;
     |LEE 000#agifa010.=;
     |SI FSalida = 0;
         |ACABA;
     |FINSI;

     |BUCLE al071;

     |PARA nCmp = 0;  |SI nCmp [ 97;  |HACIENDO nCmp = nCmp + 1;
           #agifa010#nCmp# = #al010@#nCmp#;
     |SIGUE;

     aAlfa = (#agifa010#1 % 106) + "2018";
     #agifa010#1 = aAlfa;
     |GRABA 020#agifa010.n;
     |LIBERA #agifa010;
|FPRC;

|DEFBUCLE al010;
     #al010@#1002;
     ;
     "PAT  ", 000000;
     "PAT  ", 999999;
     ;
     NULL, al010;
|FIN;

|PROGRAMA;
|DEBUG;
     |BUCLE al010;
|FPRO;

|PROCESO T80;  |TIPO 80;
     |DDEF aDef;
     aMas = aDef + "agifa010.mas";  |CARGA_DEF aMas, al010@;
     aMas = aDef + "agifa071.mas";  |CARGA_DEF aMas, al071@;

     aPath = "/u/ase9999/dscomer9/fich/00002/";
     |PATH_DAT #al010@#aPath#;
     |PATH_DAT #al071@#aPath#;

     |ABRET #agifa010;
     |ABRET #agifa071;
     |ABRET #al010@;
     |ABRET #al071@;
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #al071@;  |DESCARGA_DEF #al071@;
     |CIERRAT #al010@;  |DESCARGA_DEF #al010@;
|FPRC;
