                 ||****** FACTURAS COMPRAS ***********
|FICHEROS;
     agifa079 #0;
     agifa072 #1;
     agifa077 #2;
     agifa080 #3;
     agifa019 #4;
     agifa112 #6;
     agifa017 #7;
     agifa091 #10;
     dsz99984 #11;
     agifa704 #15;
     dsm00025 #25;
     agifa007 #40;
     agifa142 #41;
     agifv014 #42,MANTE; || Entrada Dastos Manuales.
     agifa060 #45;       || Familias.
     agifa321 #45;  || Parametros de Divisas
     agifa322 #46;  || Lineas de Proveedores/Divisas
     agifa323 #47;  || Proveedores/Divisas
     agifa324 #42;  || Divisas
     agifa325 #30;  || Historico de Actualizaciones
     dsm00148 #148;
     agifa177 #177;

     agifa716 #1000;
     agifa722 #1001;
     agifa743 #1002;
     dsw00030 #88,MANTE;
     dsm00279 #279;

     godicaj@ #500;

     Referen@;
     dsm00087@;

     visal000@;
     autfm002@;
     referen@;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     nDiferencia = 0;
     nSwRavenida = 0;
     aAlbTMaquina = "";
     aFacTMaquina = "";
     nAlbReparto = 0;
     nFacReparto = 0;
     nBtnItemDocFC = -1;
     aNume = "";
     aA¤o = "";
     aUsu = "";
     nContaLog = 0;
     aSer = "";
     aNum = "";
     aTipo = "";
     nTipo = 0;
     aNomUsu = "";
     aSN = "";
     nSwHay = 0;
     nEuro = 0;
     aEuro = "";
     nSwSal         = 0;
     swEntra         = 0;

     nGuardaDiv      = 0;

     aFichAnt        = "";
     nCmpAnt         = 0;

     aAlfaX  = "";
     aAlfa1  = "";
     nSw     = 0;
     nCalc   = 0;
     FEstado = 0;
     nContador = 0;
     nSwCerr   = 0;

     fFechaBloq = @;
     aAlfa2     = "";
     aAlfa3     = "";

     nCamFec         = 0;
     nCamImp         = 0;
     nNumVtos        = 0;
     nCont           = 0;
     ii              = 0;
     jj              = 0;
     nForma          = 0;
     nSwFlag         = 0;
     aConfi          = "";
     nSwErr          = 0;
     aProv           = ""
     aOrdena         = "";
     nNume           = 0;
     aMensa          = "";
     aSerie          = "";
     aAlfa           = "";
     nModo           = 0;

     nfecha    = 0;
                         || activadas y la serie es de divisas
     div_act = 0;        || Divisa actualizada. Me sirve en un PARA para que
                         || no salga hasta que este actualizada (div_act=1)
     factor = 0;         || factor de diferencia de cambio de albaran /factura
     div    = "";        || Variable de pintado
     sali = 0;           || Para condicio de salida
     camb = 0;           || Var. aux. para guardar el cambio
 bet1 = 0;
 bet2 = 0;
 sumarec = 0;
 swmanu = 0;
 vic = 0;
 vic1 = 0;
 sumabase = 0;
 salir = 0;
 primera = 0;
 importe = 0;
 resto = 0;
 i = 0;
 j = 0;
 a = 0;
 saltar = 0;
 voy = 0;
 con = 0;
 mes = 0;
 imneto = 0;
 impreso = 0;
 mensaje1 = "0000El proveedor del albaran NO coincide con el de la factura";
 mensaje2 = "0000Este Albaran YA ESTA incluido en la factura: %s";
 mensaje3 = "0000No coinciden los dto y/o la forma de pago del albaran. Revise el albaran";
 mensaje4 = " ";
 mensaje5 = "Procesando Albaran :         Linea :     Articulo :";
 mensaje10 = "0000No se puede modificar el PROVEEDOR";
 mensaje33 = "0000! ATENCION ! Descuadra en... ";
 mensajo = "";
 mensajei  = "2400NDesea imprimir esta factura? ";
 mensabono = "0000Este albaran es de Abono. Use el mantenimiento adecuado";
 informe = "";
 informe1 = "agifa079";
 informe2 = "agif1079";
 pm = 0;
 extras = 0;
 pe = 0;
 de = 0;
 redondeo = 0;
 sto = 0;
 m1 = 0;
 m2 = 0;
 m3 = 0;
 canti2 = 0;
 prc = 0;
 baja = 0;
 lafecha = @;
 yaesta = 0;
     mala = 0;
     entrada = 0;
     tot_fac = 0;
     Modo = ""; Comodin = ""; Comodin1 = "";

     aContab = "";

     ModoEntrada = 0; Flag = 0;
     salida = 0;
     impor = 0;
     campotot = 0;
     modfac   = 0;

      nTecla       = 0;

     aBase          = "";
     aPathCorreo    = "";
     aFichero       = "";
     nHandleCorreo  = 0;
     nPrecio1       = 0;
     nPrecio2       = 0;
     aTo            = "";
     aIP            = "";
     aSalida        = "";
     aFrom          = "";
     aAsunto        = "";
     aMensaje       = "";
     aMas            = "";
     aQueQuiero      = "";
     aNumCampos      = "";
     aEmpresa        = "";
     aFich           = "";
     nNumCampos      = 0;

     &PRMNT_enError = 0;
     &endigC   = 0;
     &eaCta    = "";
     &eswCta   = 0;
     &enSwLiquid = 0;
     &enSwEmpCerrada = 0;
     &enReContab = 0;
     &nFactor        = 0;
     &aDivisa        = "";
     &enErrCarte     = 0;
     &eaImpreSiNo    = "N";
     &eaReimp        = "";
     &eaOrden        = "";
     &enSwModi       = 0;

     &efFechaForm = @;
     &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base
     &nDeci_DivF      = 0;   || Decimales en Totales de la divisa
     &nDeci_Div       = 0;
     &nDeci_PreDivP   = 0;   || Decimales en el Precio en divisa
     &nDeci_PreDivF   = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVisF   = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotVis    = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVisF = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_TotNoVis  = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVisF   = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVisF   = 0;   || Decimales en el Importe visual. (lineas)
     &nDeci_ImpVis    = 0;
     &nDeci_IVAC      = 0;
     &nDeci_IVACImp   = 0;
     &nDeci_IVACDiv   = 0;
     &nDeci_PreDiv    = 0;
     &decim_divisa = 0;  || Decimales de la divisa
     &precio_divisa = 0; || Decimales del precio en divisa
     &decim_base = 0;    || Decimales de la moneda base
     &precio_base = 0;   || Decimales del precio en moneda base
     &prov_divisa = "";  || Codigo de Proveedor. Se pasa a PROVEED/DIVISAS
     &divisa = "";       || Codigo de Divisa. Se pasa a ACTUAL. de DIVISAS
     &iva1 = 0;
     &iva2 = 0;
     &iva3 = 0;
     &iva4 = 0;
     &iva5 = 0;
     &re1 = 0;
     &re2 = 0;
     &re3 = 0;
     &re4 = 0;
     &re5 = 0;
     &fechae = @;
     &bl  = "                              ";
     &eaCodigo     = "";
     &eaTipoCodigo = "PR";
     &eaToIncidencia = "";
     &enOk = 0;
|FIN;

||INC-LUYE llena_c4;

|PROCESO Entra079; |TIPO 7;
     |HAZ ControlUsuFC;
     |SI enErr ! 0; |PTEC 807; |ACABA; |FINSI;
     |HAZ DefSerCom;
|FPRC;

|PROCESO MCta79; |TIPO 0;
  eaCta = #0Campo;
  |HAZ MFiltraPtos;
  #0Campo = eaCta; |PINTA #0Campo;

  |HAZ MCtaContable;
  |SI eswCta = 1;
      |MENAV "    Error. Longitud de Cuenta fuera de Nivel";
      |ERROR;
  |FINSI;
|FPRC;


este calculo se efectua al entrar el n de factura y pone un flag a 0
|CALCULO fprevio;|TIPO 0;
     modfac = (FEntrada / 100) ! 0;
     |SI modfac = 1;
          primera = 0;
     |SINO;
          primera = 1;
     |FINSI;
|FCAL;

|CALCULO borrareci;
     |HAZ MiraRecCompra;
     |SI enErrCarte ! 0;
          |MENAV "0000Recibos con movimientos, NO SE DARA DE BAJA...";
          nSwErr = 1; |ACABA;
     |FINSI;
     |HAZ BorraRecCompra;

     |PDEFECTO #0, 33, 45;
     |PDEFECTO #0, 68, 74;
|FCAL;

|PROCESO MiraAbono;
     nSwErr = 0;
     |ABRE #1;      ||Linfac
     |ABRE #2;      ||alba
     #1#16 = #0#66; ||serie
     #1#0  = #0#0;
     #1#1  = 1;
     |LEE 001#1];
     |SI FSalida = 0; |Y #1#0 = #0#0; |Y #1#16 = #0#66;
          #2#50 = #1#17; ||serie albaran
          #2#0  = #1#2;
          |LEE 001#2=;
          |SI FSalida = 0;
               |SI #2#42 = "S";
                    |MENAV mensabono;
                    nSwErr = 1;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #1;
     |CIERRA #2;
|FPRC;

|PROCESO Tipo079_1; |TIPO 1;
     nSwFlag = 0;
|FPRC;

|PROCESO Incidencia;
     |MENSA "0000 Enviando incidencia.";

     |DBASE aBase;
     aPathCorreo = aBase + "/correo";  |MKDIR aPathCorreo;
     aFichero    = aPathCorreo + "/incidencia.txt";
     |XABRE "W", aFichero, nHandleCorreo;
     |SI FSalida ] 0;
         aAlfa = "Incidencia en descontabilizar facturas compras" + &13 + &10;
         |XGRABA nHandleCorreo, aAlfa;

         aAlfa = "" + &13 + &10;                     |XGRABA nHandleCorreo, aAlfa;

         aAlfa = "SERIE: "   + #0#66 + &13 + &10;    |XGRABA nHandleCorreo, aAlfa;
         aAlfa = "FACTURA: " + #0#0 + &13 + &10;     |XGRABA nHandleCorreo, aAlfa;
         aAlfa = "PROVEEDOR: " + #0#2 + &13 + &10;   |XGRABA nHandleCorreo, aAlfa;
         aAlfa = "NOMBRE PROVEEDOR: " + #0#3 + &13 + &10;   |XGRABA nHandleCorreo, aAlfa;
         aAlfa = "CONTABILIZADA: " + #0#48 + &13 + &10;   |XGRABA nHandleCorreo, aAlfa;
         aAlfa = "IMPRESA: " + #0#45 + &13 + &10;   |XGRABA nHandleCorreo, aAlfa;

         aAlfa = "" + &13 + &10;                   |XGRABA nHandleCorreo, aAlfa;

         |SI PRMNT_enError < 0;
             aAlfa = "NO SE HA PODIDO DESCONTABILIZAR EN CONTABILIDAD" + &13 + &10;
         |SINO;
             aAlfa = "NO SE HA GRABADO EL CAMPO CONTABILIDAD COMO N" + &13 + &10;
         |FINSI;
         |XGRABA nHandleCorreo, aAlfa;
     |FINSI;
     |XCIERRA nHandleCorreo;

     aIP      = "xdscorreo.dv.diagram.net";
     aSalida  = "asmtp.diagram.es";  |QBF aSalida;
     aFrom    = "soporte@diagram.es";
     aTo      = eaToIncidencia;
     aAsunto  = "Incidencia en descontabilizacion de facturas compras (diagram014 /v/ase0823)";
     aMensaje = &13 + &10 + "Leer fichero adjunto.";

     |DSCORREO_ENVIA aIP, aSalida, aFrom, aTo, aAsunto, aMensaje, aFichero;

     |MENSA "       ";
|FPRC;

|PROCESO BorraAsto;
   nModo = (FEntrada / 100) ! 0;

   |ABRE #agifa743;
   #agifa743#0 = "FC";
   #agifa743#1 = #agifa079#66;
   #agifa743#2 = #agifa079#0;
   aAlfaX = #agifa079#1; |QBF aAlfaX; aAlfaX = aAlfaX % -104;
   #agifa743#3 = aAlfaX;
   |LEE 000#agifa743.=;
   |SI FSalida = 0; efFechaForm = #agifa743#5; |FINSI;
   |CIERRA #agifa743;

   aAlfa1 = #agifa079#1; |QBF aAlfa1; aAlfa1 = aAlfa1 % -104; nSw = 0;
   |ABRE #agifa722;
   #agifa722#0  = "FC";
   #agifa722#1  = #agifa079#66;
   #agifa722#2  = #agifa079#0;
   #agifa722#3  = "";
   #agifa722#11 = 1;
   |LEE 000#agifa722.];
   FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
   |PARA; |SI FSalida = 0; |Y #agifa722#0 = "FC"; |Y aAlfa = #agifa079#66;
    |Y nCalc = #agifa079#0; |HACIENDO;
      aAlfa = #agifa722#3; |QBF aAlfa;
      |SI aAlfa = aAlfa1; nSw = 1; |SAL; |FINSI;
      |LEE 000#agifa722.s;
      FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
   |SIGUE;

   |SI nSw = 1;
      aAlfa = "ac" + Usuario; |NOME_DAT #agifa716#aAlfa#;
      |DELINDEX #agifa716; |ABRE #agifa716;

      |ABRE #agifa704;
      #agifa704#0 = #agifa722#10;
      |LEE 101#agifa704.=;
      |SI FSalida = 0;
         aFichAnt = #agifa704#16; nCmpAnt = #agifa704#17;
         |SI #agifa704#8 = "S";
            |DDEFECTO #agifa716;
            #agifa716#15 = #agifa722#10;  #agifa716#0  = 1;
            #agifa716#13 = "agifa080";    #agifa716#14 = 28;
            #agifa716#11 = "A";           #agifa716#12 = 5;
            #agifa716#3  = #agifa079#66;  #agifa716#4  = #agifa079#66;
            |GRABA 020#agifa716.n;

            |DDEFECTO #agifa716;
            #agifa716#15 = #agifa722#10;  #agifa716#0  = 2;
            #agifa716#13 = "agifa080";    #agifa716#14 = 25;
            #agifa716#11 = "N";           #agifa716#12 = 6;
            #agifa716#5  = #agifa079#0;   #agifa716#6  = #agifa079#0;
            |GRABA 020#agifa716.n;
            |LIBERA #agifa716; |CIERRA #agifa716;

            #agifa704#16 = "agifa080";    #agifa704#17 = 25;
            |GRABA 020#agifa704.a;
         |SINO;
            |DDEFECTO #agifa716;
            #agifa716#15 = #agifa722#10;  #agifa716#0  = 1;
            #agifa716#13 = "agifa079";    #agifa716#14 = 66;
            #agifa716#11 = "A";           #agifa716#12 = 5;
            #agifa716#3  = #agifa079#66;  #agifa716#4  = #agifa079#66;
            |GRABA 020#agifa716.n;

            |DDEFECTO #agifa716;
            #agifa716#15 = #agifa722#10;  #agifa716#0  = 2;
            #agifa716#13 = "agifa079";    #agifa716#14 = 0;
            #agifa716#11 = "N";           #agifa716#12 = 6;
            #agifa716#5  = #agifa079#0;   #agifa716#6  = #agifa079#0;
            |GRABA 020#agifa716.n;
            |LIBERA #agifa716; |CIERRA #agifa716;
            #agifa704#16 = "agifa079";    #agifa704#17 = 0;
            |GRABA 020#agifa704.a;
         |FINSI;
      |FINSI;
      |LIBERA #agifa704; |CIERRA #agifa704;

      aSerie = #agifa079#66; nContador = #agifa079#0;
      |LIBERA #agifa079; |CIERRAT #agifa079;

      Comodin1 = #agifa079#1; |QBF Comodin1; Comodin1 = Comodin1 % -104;
      Comodin = #agifa722#10; |QBF Comodin;
      Comodin = "agifa711.tab;" + Comodin + ",B*" + Comodin1;
      |SUB_EJECUTA_NP Comodin;
      |DELINDEX #agifa716;

      |ABRE #agifa704;
      #agifa704#0 = #agifa722#10;
      |LEE 101#agifa704.=;
      |SI FSalida = 0;
         #agifa704#16 = aFichAnt; #agifa704#17 = nCmpAnt;
         |GRABA 020#agifa704.a;
      |FINSI;
      |LIBERA #agifa704; |CIERRA #agifa704;

      |ABRET #agifa079;
      #agifa079#66 = aSerie; #agifa079#0 = nContador;
      |LEE 121#agifa079.=;

      |SI PRMNT_enError = 0;
          #agifa079#48 = "N";   |PINTA #0#48;
          |GRABA 020#agifa079.a;
          ||BORRA 020#agifa722.a;
      |FINSI;
   |FINSI;

   nSw = PRMNT_enError;
   |CIERRA #agifa722;

   |SI #0#48 = "S";
       ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄMi¤ana
       |HAZ EsMinana;
       |SI FSalida = 0;  |Y  eaToIncidencia ! "";
           |HAZ Incidencia;
       |FINSI;
   |FINSI;
|FPRC;

|PROCESO AlbaImpr;
     #2#50 = #1#17;
     #2#0 = #1#2;
     |LEE 121#2=;
     |SI FSalida = 0;
          #2#10 = #0#45;
          |GRABA 020#2a;
          |LIBERA #2;
     |FINSI;
|FPRC;

|PROCESO Asiento;
   nModo = (FEntrada / 100) ! 0;

   efFechaForm = "01.01.0000";
   |ABRE #agifa743;
   #agifa743#0 = "FC";
   #agifa743#1 = #agifa079#66;
   #agifa743#2 = #agifa079#0;
   aAlfaX = #agifa079#1; |QBF aAlfaX; aAlfaX = aAlfaX % -104;
   #agifa743#3 = aAlfaX;
   |LEE 000#agifa743.=;
   |SI FSalida = 0; efFechaForm = #agifa743#5; |FINSI;
   |CIERRA #agifa743;

   aAlfa1 = #agifa079#1; |QBF aAlfa1; aAlfa1 = aAlfa1 % -104; nSwHay = 0;
   |ABRE #agifa722;
   #agifa722#0 = "FC";
   #agifa722#1 = #agifa079#66;
   #agifa722#2 = #agifa079#0;
   #agifa722#11 = 1;
   |LEE 000#agifa722.];
   FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
   |PARA; |SI FSalida = 0; |Y #agifa722#0 = "FC"; |Y aAlfa = #agifa079#66;
    |Y nCalc = #agifa079#0; |HACIENDO;
      aAlfa = #agifa722#3; |QBF aAlfa;
      |SI aAlfa = aAlfa1; nSwHay = 1; |SAL; |FINSI;
      |LEE 000#agifa722.s;
      FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
   |SIGUE;
   |CIERRA #agifa722;

   aAlfa1 = "N";
   |SI nSwHay = 1;
      aAlfa = "ac" + Usuario; |NOME_DAT #agifa716#aAlfa#;
      |DELINDEX #agifa716; |ABRE #agifa716;

      |ABRE #agifa704;
      #agifa704#0 = #agifa722#10;
      |LEE 101#agifa704.=;
      |SI FSalida = 0;
         aFichAnt = #agifa704#16; nCmpAnt = #agifa704#17;
         |SI #agifa704#8 = "S";
            |DDEFECTO #agifa716;
            #agifa716#15 = #agifa722#10;  #agifa716#0  = 1;
            #agifa716#13 = "agifa080";    #agifa716#14 = 28;
            #agifa716#11 = "A";           #agifa716#12 = 5;
            #agifa716#3  = #agifa079#66;  #agifa716#4  = #agifa079#66;
            |GRABA 020#agifa716.n;

            |DDEFECTO #agifa716;
            #agifa716#15 = #agifa722#10;  #agifa716#0  = 2;
            #agifa716#13 = "agifa080";    #agifa716#14 = 25;
            #agifa716#11 = "N";           #agifa716#12 = 6;
            #agifa716#5  = #agifa079#0;   #agifa716#6  = #agifa079#0;
            |GRABA 020#agifa716.n;
            |LIBERA #agifa716; |CIERRA #agifa716;

            #agifa704#16 = "agifa080"; #agifa704#17 = 25;
            |GRABA 020#agifa704.a;
         |SINO;
            |DDEFECTO #agifa716;
            #agifa716#15 = #agifa722#10;  #agifa716#0  = 1;
            #agifa716#13 = "agifa079";    #agifa716#14 = 66;
            #agifa716#11 = "A";           #agifa716#12 = 5;
            #agifa716#3  = #agifa079#66;  #agifa716#4  = #agifa079#66;
            |GRABA 020#agifa716.n;

            |DDEFECTO #agifa716;
            #agifa716#15 = #agifa722#10;  #agifa716#0  = 2;
            #agifa716#13 = "agifa079";    #agifa716#14 = 0;
            #agifa716#11 = "N";           #agifa716#12 = 6;
            #agifa716#5  = #agifa079#0;   #agifa716#6  = #agifa079#0;
            |GRABA 020#agifa716.n;
            |LIBERA #agifa716; |CIERRA #agifa716;
            #agifa704#16 = "agifa079"; #agifa704#17 = 0;
            |GRABA 020#agifa704.a;
         |FINSI;
      |FINSI;
      |LIBERA #agifa704; |CIERRA #agifa704;

      aSerie = #agifa079#66; nContador = #agifa079#0;
      |GRABA 020#agifa079.a;
      |LIBERA #agifa079; |CIERRAT #agifa079;

      Comodin1 = #agifa079#1; |QBF Comodin1; Comodin1 = Comodin1 % -104;
      Comodin = #agifa722#10; |QBF Comodin;
      |SI nSw = 1; || BORRA
         Comodin = "agifa711.tab;" + Comodin + ",B*" + Comodin1;
         aAlfa1 = "N";
      |FINSI;
      |SI nSw = 2; || ENLAZA
         Comodin = "agifa711.tab;" + Comodin;
         aAlfa1 = "S";
      |FINSI;
      |SUB_EJECUTA_NP Comodin;
      |DELINDEX #agifa716;

      |ABRE #agifa704;
      #agifa704#0 = #agifa722#10;
      |LEE 101#agifa704.=;
      |SI FSalida = 0;
         #agifa704#16 = aFichAnt; #agifa704#17 = nCmpAnt;
         |GRABA 020#agifa704.a;
      |FINSI;
      |LIBERA #agifa704; |CIERRA #agifa704;

      |ABRET #agifa079;
      #agifa079#66 = aSerie; #agifa079#0 = nContador;
      |LEE 121#agifa079.=;
   |FINSI;
   |SI PRMNT_enError = 0;
      #agifa079#48 = aAlfa1; |GRABA 020#agifa079.a;
   |FINSI;
   nSw = PRMNT_enError;
|FPRC;

|PROCESO BorraHisEnlace;
     |ABRE #agifa743;
     #agifa743#0 = "FC";
     #agifa743#1 = #agifa079#66;
     #agifa743#2 = #agifa079#0;
     aAlfaX = #agifa079#1; |QBF aAlfaX; aAlfaX = aAlfaX % -104;
     #agifa743#3 = aAlfaX;
     |LEE 000#agifa743.=;
     |SI FSalida = 0; |BORRA 020#agifa743.a; |FINSI;
     |CIERRA #agifa743;

     aAlfa1 = #agifa079#1; |QBF aAlfa1; aAlfa1 = aAlfa1 % -104; nSw = 0;
     |ABRE #agifa722;
     #agifa722#0 = "FC";
     #agifa722#1 = #agifa079#66;
     #agifa722#2 = #agifa079#0;
     #agifa722#11 = 1;
     |LEE 000#agifa722.];
     FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
     |PARA; |SI FSalida = 0; |Y #agifa722#0 = "FC"; |Y aAlfa = #agifa079#66;
      |Y nCalc = #agifa079#0; |HACIENDO;
        aAlfa = #agifa722#3; |QBF aAlfa;
        |SI aAlfa = aAlfa1; nSwHay = 1; |SAL; |FINSI;
        |LEE 000#agifa722.s;
        FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
      |SIGUE;
     |SI nSwHay = 1; |BORRA 020#agifa722.a; |FINSI;
     |CIERRA #agifa722;
|FPRC;

|PROCESO PermiteConta;
     enSwLiquid = 0; enSwEmpCerrada = 0; |HAZ MiraSiLiquidada;

     |SI #279#21 = "N";
          |AVISO;
          |MENAV "0000Esta Factura Esta Contabilizada...";
          FSalida = 1;
     |SINO;
          |SI #279#21 = "R";
               aAlfa = Usuario % 810;
               |ABRE #148;
               #148#0 = aAlfa;
               |LEE 000#148=;
               |SI FSalida = 0;
                    |SI enSwEmpCerrada = 0;
                       |SI enSwLiquid = 1; |Y #279#22 = "S";
                          |MENAV "0000Esta Factura ha sido liquidada en contabilidad. Proceso cancelado.";
                          FSalida = 1;
                       |SINO;
                          |CONFI "0000NEsta Factura Esta Contabilizada: Desea Continuar? ";
                       |FINSI;
                    |SINO;
                       |MENAV "0000Empresa contable cerrada. Proceso cancelado.";
                       FSalida = 1;
                    |FINSI;
               |SINO;
                    |MENAV "0000Esta Factura Esta Contabilizada...";
               |FINSI;
               aAlfa = FSalida;
               |CIERRA #148;
               FSalida = aAlfa;
          |SINO; || = "T"
               |SI enSwEmpCerrada = 0;
                  |SI enSwLiquid = 1; |Y #279#22 = "S";
                     |MENAV "0000Esta Factura ha sido liquidada en contabilidad. Proceso cancelado.";
                     FSalida = 1;
                  |SINO;
                     |CONFI "0000NEsta Factura Esta Contabilizada: Desea Continuar? ";
                  |FINSI;
               |SINO;
                  |MENAV "0000Empresa contable cerrada. Proceso cancelado.";
                  FSalida = 1;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO actufa;|TIPO 2;
     |HAZ ControlUsuFC;
     |SI enErr ! 0; |ERROR; |ACABA; |FINSI;
     con = (FEntrada / 100) ! 0;
     nForma = 0 +. 1;

     |SI nForma < 0;
        aContab = "N";
        |SI #agifa079#48 = "S";
           fFechaBloq = "01.01.0000"; nSwCerr = 0;
           |ABRE #agifa722;
           #agifa722#0 = "FC";
           #agifa722#1 = #agifa079#66;
           #agifa722#2 = #agifa079#0;
           #agifa722#11 = 1;
           |LEE 000#agifa722.];
           aAlfa2 = #agifa722#1;  |QBF aAlfa2;
           aAlfa3 = #agifa079#66; |QBF aAlfa3;
           |PARA; |SI FSalida = 0; |Y #agifa722#0 = "FC"; |Y aAlfa2 = aAlfa3; |Y #agifa722#2 = #agifa079#0; |HACIENDO;
              |ABRE #agifa704;
              #agifa704#0 = #agifa722#10;
              |LEE 000#agifa704.=;
              |SI FSalida ! 0; |DDEFECTO #agifa704; |FINSI;
              |CIERRA #agifa704;
              aAlfa = #agifa704#6; |QBF aAlfa;
              aAlfa = aAlfa - "contagen";
              |SI FSalida ! 0;
                 aAlfa = #agifa704#6; |QBF aAlfa;
                 aAlfa = aAlfa + "def/canempre.mas";
                 |CARGA_DEF aAlfa, Referen@;
                 |SI FSalida = 0;
                    aAlfa = #agifa704#6; |QBF aAlfa;
                    aAlfa = aAlfa + "fich/";
                    |PATH_DAT #Referen@#aAlfa#;
                    |ABRE #Referen@;
                    #Referen@#2 = #agifa722#8;
                    #Referen@#3 = #agifa722#9;
                    |LEE 000#Referen@.=;
                    |SI FSalida ! 0; |DDEFECTO #Referen@; |FINSI;
                    |SI #Referen@#34 ! "01.01.0000";
                       fFechaBloq = #Referen@#34; |SAL;
                    |FINSI;
                    |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
                 |FINSI;
                 aAlfa = #agifa704#6; |QBF aAlfa;
                 aAlfa = aAlfa + "def/camaasic.mas";
                 |CARGA_DEF aAlfa, Referen@;
                 |SI FSalida = 0;
                    aAlfa = #agifa704#6; |QBF aAlfa;
                    aAlfa = aAlfa + "fich/" + (("00000" + #agifa722#8) % -105) + #agifa722#9 + "/";
                    |PATH_DAT #Referen@#aAlfa#;
                    |ABRE #Referen@;
                    #Referen@#0 = 99;
                    #Referen@#1 = "01.01.0000";
                    #Referen@#2 = 1;
                    |LEE 000#Referen@.];
                    |SI FSalida = 0; |Y #Referen@#0 = 99;
                       nSwCerr = 1; |SAL;
                    |FINSI;
                    |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
                 |FINSI;
              |FINSI;
              |LEE 000#agifa722.s;
              aAlfa2 = #agifa722#1;  |QBF aAlfa2;
              aAlfa3 = #agifa079#66; |QBF aAlfa3;
           |SIGUE;
           |CIERRA #agifa722;
           |SI fFechaBloq ! "01.01.0000";
              |SI #agifa079#1 [ fFechaBloq;
                 aAlfa = "    Factura contabilizada y con fecha anterior a bloqueo contabilidad [" + fFechaBloq + "]";
                 |MENAV aAlfa;
                 nSwFlag = 1; nSwSal = 1; |ERROR; |ACABA;
              |FINSI;
           |FINSI;
           |SI nSwCerr = 1;
              aAlfa = "    Contabilidad cerrada. No se puede modificar el asiento";
              |MENAV aAlfa;
              nSwFlag = 1; nSwSal = 1; |ERROR; |ACABA;
           |FINSI;
        |FINSI;
     |FINSI;

     |SI con = 1; nSwFlag = 0; |FINSI;
     |SI nSwFlag = 1; |ACABA; |FINSI;

     |SI con = 2; |O con = 3;
          |HAZ MiraAbono;
          |SI nSwErr ! 0;
               nSwFlag = 1;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     |SI #0#48 = "S";
          |HAZ PermiteConta;
          |SI FSalida ! 0;
               nSwFlag = 1; |ERROR; |ACABA;
          |SINO;
               aContab = "S"; |HAZ BorraAsto;
               |SI nSw < 0;
                    nSwFlag = 1; nSwSal = 1; |ERROR; |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #0#45 = "S";
          |SI con ] 2; |Y nForma ! 1;

               |HAZ MiraRecCompra;
               |SI enErrCarte ! 0;
                  |MENAV "0000Recibos con movimientos, NO SE DARA DE BAJA...";
                  nSwFlag = 1; nSwSal = 1; |ERROR; |ACABA;
               |FINSI;

               |DBASE aAlfa; |QBF aAlfa;
               aAlfa = aAlfa + "def/godiacaj.mas";
               |CARGA_DEF aAlfa, godicaj@;
               |SI FSalida = 0;
                  |ABRE #godicaj@; |SELECT #3#godicaj@;
                  #godicaj@#32 = #agifa079#66;
                  #godicaj@#33 = #agifa079#0;
                  |LEE 000#godicaj@.=;
                  FEstado = FSalida;
                  |SELECT #1#godicaj@; |CIERRA #godicaj@;
                  |SI FEstado = 0;
                     |MENAV "    Factura introducida por control de caja. Proceso abortado.";
                     nSwFlag = 1; nSwSal = 1; |ERROR; |ACABA;
                  |FINSI;
               |FINSI;

               |HAZ MiraRecCompra;
               |SI enErrCarte ! 0;
                  |MENAV "0000Recibos con movimientos, NO SE DARA DE BAJA...";
                  nSwFlag = 1; nSwSal = 1; |ERROR; |ACABA;
               |FINSI;

               |AVISO;
               |CONFI "0000NDesea dejar la factura como NO impresa y anular los recibos?  ";
               |SI FSalida ! 0;
                    nSwFlag = 1; nSwSal = 1; |ERROR; |ACABA;
               |SINO;
                    |HAZ borrareci;
                    |SI nSwErr ! 0;
                         nSwFlag = 1;
                         |ERROR; |ACABA;
                    |FINSI;
                    #0#45 = "N"; |PINTA #0#45;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nForma > 0;
         |HAZ CalCabAgifa079;
     |FINSI;

     |SI con = 3;
          |HAZ borrareci;
          |SI nSwErr ! 0;
               |ERROR;
               |ACABA;
          |FINSI;
          aAlfa1 = #agifa079#1; |QBF aAlfa1; aAlfa1 = aAlfa1 % -104; nSw = 0;
          |ABRE #agifa722;
          #agifa722#0 = "FC";
          #agifa722#1 = #agifa079#66;
          #agifa722#2 = #agifa079#0;
          #agifa722#11 = 1;
          |LEE 000#agifa722.];
          FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
          |PARA; |SI FSalida = 0; |Y #agifa722#0 = "FC"; |Y aAlfa = #agifa079#49;
           |Y nCalc = #agifa079#0; |HACIENDO;
             aAlfa = #agifa722#3; |QBF aAlfa;
             |SI aAlfa = aAlfa1; nSwHay = 1; |SAL; |FINSI;
             |LEE 000#agifa722.s;
             FEstado = FSalida; aAlfa  = #agifa722#1; aAlfa = aAlfa % 0105; nCalc = #agifa722#2; FSalida = FEstado;
          |SIGUE;
          |SI nSwHay = 1; |BORRA 020#agifa722.a; |FINSI;
          |CIERRA #agifa722;
     |FINSI;
     |SI con > 1; |Y nForma = -1;
          |ABRE #2;
          |BUCLELIN 2 AlbaImpr #0;
          |CIERRA #2;
     |FINSI;

     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |SI con = 3;
          |HAZ EsAlbero;
          |SI FSalida = 0;
               |HAZ AlbeFacBorra;
          |FINSI;
          |HAZ EsVipei;
          |SI FSalida = 0;
               |HAZ VipeiFacBorra;
          |FINSI;
          |HAZ EsOTP;
          |SI FSalida = 0;
               |HAZ OTPFacBorra;
          |FINSI;
     |FINSI;
     |HAZ EsSematel;
     |SI FSalida = 0;
          eaSerie = #0#66;
          enCodigo = #0#0;
          efFecha = #0#1;
          enForma = nForma;
          |SUB_EJECUTA_NP "tlfw0001;FACTURA";
     |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ

     |SI nForma > 0; |Y aContab = "S";
        |CONFI "N    Volver a dejar contabilizada la factura ? ";
        |SI FSalida = 0;
           enReContab = 1;
           nSw = 2; |HAZ Asiento;
           enReContab = 0;
        |SINO;
           |HAZ BorraHisEnlace;
           aContab = "N";
        |FINSI;
        aContab = "N";
     |FINSI;

     ModoEntrada = (FEntrada / 100) ! 0; Flag = 0 +. 1;
     |SI #agifa079#137 ! 0;
        |SI ModoEntrada = 2; |Y Flag < 0; |ACABA; |FINSI;
        aAlfa = "ac" + Usuario; |NOME_DAT #agifa716#aAlfa#;
        |DELINDEX #agifa716; |ABRE #agifa716;
        |DDEFECTO #agifa716;
        #agifa716#15 = #agifa079#141; #agifa716#0 = 1;
        #agifa716#13 = "agifa079";    #agifa716#14 = 66;
        #agifa716#11 = "A";
        #agifa716#3 = #agifa079#66; #agifa716#4 = #agifa079#66;
        |GRABA 020#agifa716.n;

        |DDEFECTO #agifa716;
        #agifa716#15 = #agifa079#141; #agifa716#0 = 2;
        #agifa716#13 = "agifa079"; #agifa716#14 = 0;
        #agifa716#11 = "N";
        #agifa716#5 = #agifa079#0; #agifa716#6 = #agifa079#0;
        |GRABA 020#agifa716.n;

        |LIBERA #agifa716;
        |CIERRA #agifa716;
        |SI ModoEntrada = 3; Modo = ",B"; |SINO; Modo = ""; |FINSI;
        Comodin = #agifa079#141; |QBF Comodin;
        Comodin = "agifa711.tab;" + Comodin + Modo + ",SINPRELV";
        |SUB_EJECUTA_NP Comodin;
        |DELINDEX #agifa716;
     |FINSI;
|FPRC;


|PROCESO fecha_pact_lin;
|SI #agifa325#4 > #2#60; |Y sali = 0; || Si la fecha en el hist. > fecha pactada ...
  #1#19 = camb;||Significa que me he pasado, el cambio valido es el anterior
  sali = 1; || Para que no vuelva a entrar en la condicion
  |SI camb = 0; || Si vale 0, significa que no hay actualizaciones anteriores, por tanto...
    |MENAV "0000Se utiliza como fecha de pacto la de la primera actualizacion";
    #1#19 = #agifa325#3; || Asigno el cambio de la 1a. actualizacion
  |FINSI;
|FINSI;
camb = #agifa325#3; ||Me guardo el cambio para la siguiente linea
|FPRC;


|DEFBUCLE fecha_pact; || Recorre el Historico de actualizaciones
#agifa325#2;          || 2a. Clave: divisa,fecha,guia
;
#1#18,"00.00.0000",0;
#1#18,"31.12.9999",99999999;
be;
NULL,fecha_pact_lin;
|FIN;

|PROCESO CamposDiv;
     |PINTA #1#27;
     |PINTA #1#28;
     |PINTA #1#30;
     |PINTA #1#31;
     |PINTA #1#32;
|FPRC;

|CALCULO defecfl;|TIPO 0;
     |ABRE #2;
     #2#0 = #1#2;
     #2#50 = #1#17;
     |LEE 020#2=;
     |CIERRA #2;

     |HAZ controli;
     |SI  FSalida ! 0;  |ERROR;  |ACABA;  |FINSI;

     |SI #279#11 = "N";
          |SI #2#1 < "01.07.2010"; |Y #0#1 ] "01.07.2010";
               |MENAV "0000El % de iva no coincide con el de la factura";
               |ERROR; |ACABA;
          |FINSI;
          |SI #2#1 ] "01.07.2010"; |Y #0#1 < "01.07.2010";
               |MENAV "0000El % de iva no coincide con el de la factura";
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     #0#75 = #2#56; || Divisa (cabecera)
     #0#77 = #2#58; || Moneda de trabajo (cabecera)
     #0#144 = #2#52; || %Rete
     #1#18 = #2#56; || Divisa (lineas)
     #1#19 = #2#57; || Cambio (lineas;
     #1#20 = #2#58; || Moneda de trabajo (lineas)

     |SI #2#59 = "A"; || Si en el alb., el cambio esta pactado al del albaran
         |HAZ Param_Divisas3; || Lee Parametros
     |FINSI;

     |SI #2#59 = "F"; || Si en el alb., el cambio esta pact. a la fecha de la factura
         |HAZ CambioDivisa3; || Coge el valor actual de la divisa
     |FINSI;

     |SI #2#59 = "O"; || Si en el alb. el cambio esta pactado a Otra fecha
         |ABRE #agifa325; || Abre Hist. de actualizaciones
         sali = 0;  || Inicializo
         camb = 0;
         |BUCLE fecha_pact; || Busca en el historico de actualizaciones
         |SI sali = 0;
             |MENAV "0000Se utiliza como fecha de pacto la de la ultima actualizacion";
              #1#19 = camb;
         |FINSI;
         |CIERRA #agifa325;
         |HAZ Param_Divisas3; || Lee Parametros
     |FINSI;
     |HAZ CalLinAgifa079;
|FCAL;

|CALCULO leepago;|TIPO 0;
     |ABRE #10;
     #10#0 = #0#11;
     |LEE 021#10=;
     |SI 0 ! FSalida;
          |DDEFECTO #10;
     |FINSI;
     |CIERRA #10;
|FCAL;

|CALCULO actufl;|TIPO 2;
     |HAZ EsRavenida;
     nSwRavenida = FSalida;

     #0#80 = #0#80 +. 1;  || Numero de lineas existentes
     |SI #0#80 = 1;       || Si hay solo una linea ...
          #0#75 = #1#18;     || ... cojo la divisa ...
          #0#77 = #1#20;     || ... y la moneda base.
          |SI nSwRavenida = 0;
               |HAZ RavenidaGra79_1;
          |FINSI;
     |FINSI;
     nForma = 0 +. 1;

     |ABRE #2;
     #2#0 = #1#2;
     #2#50 = #1#17;
     |LEE 121#2=;

     |SI 0 = FSalida;|Y 0 < nForma;
          |HAZ controli;
     |FINSI;

     |SI FSalida = 100;
          |ERROR;
          |ACABA;
     |FINSI;

     |SI primera = 0;
         primera = 1;
     |FINSI;

     |SI 0 < nForma;
         #2#38 = "S";
         #2#39 = #0#0;
         #2#51 = #0#66;
         #2#77 = #0#1;
     |SINO;
         #2#38 = "N";
          #2#39 = A;
          #2#51 = "  ";
          #2#77 = "00.00.0000";
     |FINSI;

     #2#37 = 0;
     #2#10 = #0#45;
     |ABRE #7;
     |ABRE #4;
     |PINTA 2413,mensaje5;|PINTA 2434,#2#0;


     baja = (FEntrada / 100) ! 0;
     |BUCLELIN 0kactuar#2;
     |CIERRA #4;
     |CIERRA #7;
     |BLIN 24;

     |GRABA 020#2a;
     |CIERRA #2;

     |SI nSwRavenida = 0;
          |HAZ RavenidaGra79;
     |FINSI;

|FCAL;

|CALCULO kactuar;|TIPO 0;
     |LEE 110#3=;
     |SI baja ! 3;
          |PINTA 2450,#3#1;|PINTA 2465,#3#2;



          #4#0 = #3#2;
          |LEE 021#4=;
          |SI 0 = FSalida;
               #7#0 = #3#2;
               #7#1 = #3#3;
               |LEE 021#7=;
               |SI 0 = FSalida;
                    imneto = #3#9 < #2#5;
                    imneto = imneto < #2#7;
                    imneto = imneto < #2#32;
               |FINSI;
          |FINSI;
          #3#25 = #0#0;
          #3#28 = #0#66;
     |SINO;
          #3#25 = A;
          #3#28 = A;
     |FINSI;
     |GRABA 020#3a;
     |LIBERA #3;
|FCAL;

|CALCULO controli;|TIPO 0;
     |HAZ EsRavenida;
     |SI FSalida = 0;
          |HAZ Ravenida79;
     |FINSI;

     FSalida = 0;
     |SI #0#80 ! 0;  || Si ya hemos puesto alguna linea ...
          |SI #2#56 ! #0#75; |O #2#58 ! #0#77;  || Si la moneda de trabajo o la divisa no coinciden ...
               |MENAV "0000La moneda de trabajo y la divisa de los albaranes deben coincidir";
               FSalida = 100; || Error
          |FINSI;
          |SI aAlbTMaquina ! aFacTMaquina; |O nAlbReparto ! nFacReparto;
               |MENAV "0000El %Reparto y el Tipo Maquina deben de coincidir";
               FSalida = 100;
          |FINSI;
     |FINSI;
     |SI #2#42 = AN;
          |SI #0#2 ! #2#3;
               |MENAV mensaje1;
               FSalida = 100;
          |SINO;
              |SI #2#38 ! AN;
                    mensaje4 = #2#39 ! mensaje2;
                    |MENAV mensaje4;
                    FSalida = 100;
              |SINO;
                    |SI primera = 0;
                         i = (FEntrada / 100) ! 0;
                         |SI i = 1;
                              #0#4  = #2#5;#0#6 = #2#7;#0#5 = #2#32;#0#11 = #2#8;
                              #0#76 = #2#57; || Cambio
                         |FINSI;
                    |FINSI;

                    |SI #0#4 ! #2#5;|O #0#6 ! #2#7;|O #0#5 ! #2#32;|O #0#11 ! #2#8;
                         |MENAV mensaje3;
                          FSalida = 100;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          |MENAV mensabono;
          FSalida = 100;
     |FINSI;
|FCAL;

|CALCULO ccffcc;|TIPO 6;
nTecla = FSalida;
con = FEntrada / 100;
con = con ! 0;
|SI con = 2;|Y #0Campo ! Contenido;
  #0Campo = Contenido;
  |PINTA #0Campo;
  |MENAV mensaje10;
  |ERROR;
|FINSI;
|FCAL;

|CALCULO Salir;|TIPO 30;
     |HAZ EsTagloma;
     |SI FSalida = 0;
          eaSerie = #0#66;
          enCodigo = #0#0;
          |SUB_EJECUTA_NP "tagz0027;FAC";
     |FINSI;
|FCAL;

|CALCULO siimpre1;|TIPO 3;
     |SI nSwSal = 1;  |ACABA; |FINSI;

     |SI #41#7 = "S";
         enSwModi = 0;
         |HAZ ModiImportes;
         |HAZ CambioImportes;
     |FINSI;

     |SI #0#45 = AN;
          |HAZ VenciComp;
          |CONFI mensajei;
          |SI 0 = FSalida;
               |HAZ Impre079;
          |FINSI;
     |FINSI;
|FCAL;

|PROCESO T79_4; |TIPO 4;
     |SELECT #1#0;
     |LEE 000#0=;
     |SI FSalida ! 0;
          |MENAV "0000Por favor, consulte el registro correcto antes de imprimir.";
          |ACABA;
     |SINO;
          |PINDA #0#0;
          FEntrada = 402;
     |FINSI;
     |HAZ Impre079;
|FPRC;

|PROCESO Impre079;
     |SI #0#45 = "N";
          swmanu = 0;
          FSalida = 9;
          |HAZ entraven;
          swmanu = 0;
     |FINSI;
     |CONFI "2400NLineas de Factura ordenadas por numero de Albaran?";
     |SI FSalida = 0;
          aOrdena = "S";
     |SINO;
          aOrdena = "N";
     |FINSI;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1; |O nModo = 2;
          |GRABA 020#0a;
     |FINSI;
     |CIERRAT #0;
     eaSer = #0#66;
     enNum = #0#0;
     eaOrden = aOrdena;
     eaReimp = #0#45;
     |SUB_EJECUTA_NP "agifa056";
     |ABRET #0;
     #0#66 = eaSer;
     #0#0 = enNum;
     |SI nModo = 4;
          |LEE 000#0=;
     |SINO;
          |LEE 101#0=;
     |FINSI;
/*
     |SI eaImpreSiNo = "N"; |Y #0#45 = "N";
          |HAZ BorraRecCompra;
     |FINSI;
*/
|FPRC;

|PROCESO encampos;
|SI salir = 0;
  sumabase = #0#21 + #0#24 + #0#27 + #0#49 + #0#52;
  #0#29    = #0#22 + #0#25 + #0#28 + #0#50 + #0#53;
  #0#30    = #0#23 + #0#26 + #0#55 + #0#51 + #0#54;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;

|ET enc1;
  sumabase = sumabase - (#0#18);
  |ENCAMPO #18#0;
  sumabase = #0#21 + #0#24 + #0#27+ #0#49 + #0#52; || + #0#18;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc1; |FINSI;

|ET enc2;
  sumabase = sumabase - (#0#19);
  |ENCAMPO #19#0;
  sumabase = #0#21 + #0#24 + #0#27+ #0#49 + #0#52 + #0#19;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc1; |FINSI;

|ET enc3;
  sumabase = sumabase - (#0#20);
  |ENCAMPO #20#0;
  sumabase = #0#21 + #0#24 + #0#27+ #0#49 + #0#52 + #0#20;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc2; |FINSI;

|ET enc4;
  sumabase = sumabase + (#0#17);
  |ENCAMPO #17#0;
  sumabase = #0#21 + #0#24 + #0#27+ #0#49 + #0#52 + #0#17;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc3; |FINSI;

|ET enc5;
  sumabase = sumabase - (#0#47);
  |ENCAMPO #47#0;
  sumabase = #0#21 + #0#24 + #0#27+ #0#49 + #0#52 + #0#17;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc3; |FINSI;

|ET enc21;
  |ENCAMPO #21#0;
  sumabase = #0#21 + #0#24 + #0#27+ #0#49 + #0#52;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc5; |FINSI;

|ET enc22;
  |ENCAMPO #22#0;
  #0#29 = #0#22 + #0#25 + #0#28 + #0#50 + #0#53;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc21; |FINSI;

|ET enc23;
  |ENCAMPO #23#0;
  #0#30 = #0#23 + #0#26 + #0#55 + #0#51 + #0#54;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc22; |FINSI;

|ET enc24;
  |ENCAMPO #24#0;
  sumabase = #0#21 + #0#24 + #0#27+ #0#49 + #0#52;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc23; |FINSI;

|ET enc25;
  |ENCAMPO #25#0;
  #0#29 = #0#22 + #0#25 + #0#28 + #0#50 + #0#53;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc24; |FINSI;

|ET enc26;
  |ENCAMPO #26#0;
  #0#30 = #0#23 + #0#26 + #0#55 + #0#51 + #0#54;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc25; |FINSI;

|ET enc27;
  |ENCAMPO #27#0;
  sumabase = #0#21 + #0#24 + #0#27+ #0#49 + #0#52;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc26; |FINSI;

|ET enc28;
  |ENCAMPO #28#0;
  #0#29 = #0#22 + #0#25 + #0#28 + #0#50 + #0#53;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc27; |FINSI;

|ET enc55;
  |ENCAMPO #55#0;
  #0#30 = #0#23 + #0#26 + #0#55 + #0#51 + #0#54;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc28; |FINSI;

|ET enc49;
  |ENCAMPO #49#0;
  sumabase = #0#21 + #0#24 + #0#27+ #0#49 + #0#52;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc55; |FINSI;

|ET enc50;
  |ENCAMPO #50#0;
  #0#29 = #0#22 + #0#25 + #0#28 + #0#50 + #0#53;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc49; |FINSI;

|ET enc51;
  |ENCAMPO #51#0;
  #0#30 = #0#23 + #0#26 + #0#55 + #0#51 + #0#54;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc50; |FINSI;

|ET enc52;
  |ENCAMPO #52#0;
  sumabase = #0#21 + #0#24 + #0#27+ #0#49 + #0#52;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc51; |FINSI;

|ET enc53;
  |ENCAMPO #53#0;
  #0#29 = #0#22 + #0#25 + #0#28 + #0#50 + #0#53;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc52; |FINSI;

|ET enc54;
  |ENCAMPO #54#0;
  #0#30 = #0#23 + #0#26 + #0#55 + #0#51 + #0#54;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc53; |FINSI;

|ET enc29;
  |ENCAMPO #29#0;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc54; |FINSI;

|ET enc30;
  |ENCAMPO #30#0;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc29; |FINSI;

|ET enc31;
  |ENCAMPO #67#0;
  #0#31    = sumabase + #0#29 + #0#30 + #0#47 - #0#67;
  |PINTA #0#29;  |PINTA #0#30;  |PINTA #0#31;
  |SI FSalida = 5; |O FSalida = 1; |VETE Fin; |FINSI;
  |SI FSalida = 2; |VETE enc30; |FINSI;

  |ENCAMPO #31#0;
  |SI FSalida = 2; |VETE enc31; |FINSI;

|ET Fin;

|FINSI;
|FPRC;

|PROCESO sumavt; |TIPO 0;
     #42#13 = 0;
     |PARA vic=1; |SI vic < 13; |HACIENDO vic = vic +2;
          vic1 = vic - 1;
          #42#13 = #42#13 + #42vic;
          |SI #42vic = 0;
               #42vic1 = "01.01.0000";
               |PINTA #42vic1;
          |FINSI;
     |SIGUE;
     |PARA vic=15; |SI vic [ 25; |HACIENDO vic = vic +2;
          vic1 = vic - 1;
          #42#13 = #42#13 + #42vic;
          |SI #42vic = 0;
               #42vic1 = "01.01.0000";
               |PINTA #42vic1;
          |FINSI;
     |SIGUE;
     |PINTA #42#13;
|FPRC;

|PROCESO Tipo12v014; |TIPO 12;
     swmanu=1;
     #0#68 = #42#0;
     #0#69 = #42#2;
     #0#70 = #42#4;
     #0#71 = #42#6;
     #0#72 = #42#8;
     #0#73 = #42#10;

     #0#33 = #42#1  / nFactor;
     #0#34 = #42#3  / nFactor;
     #0#35 = #42#5  / nFactor;
     #0#36 = #42#7  / nFactor;
     #0#37 = #42#9  / nFactor;
     #0#38 = #42#11 / nFactor;
     #0#39 = #42#15 / nFactor;
     #0#40 = #42#17 / nFactor;
     #0#41 = #42#19 / nFactor;
     #0#42 = #42#21 / nFactor;
     #0#43 = #42#23 / nFactor;
     #0#44 = #42#25 / nFactor;

     #0#129 = #42#14;
     #0#130 = #42#16;
     #0#131 = #42#18;
     #0#132 = #42#20;
     #0#133 = #42#22;
     #0#134 = #42#24;

     #0#146 = #42#27 / nFactor;
     #0#147 = #42#28;
|FPRC;

|PROCESO entraven; |TIPO 0;
      |SI FSalida = 9;
          |HAZ leepago;
          nGuardaDiv = nDeci_Base;
          nDeci_Base = nDeci_TotVisF;
          swmanu = 0;
          |DDEFECTO #42;
          |PUSHV 0501 2380;
          #42#12 = #0#118;
          #42#0  = #0#68;
          #42#2  = #0#69;
          #42#4  = #0#70;
          #42#6  = #0#71;
          #42#8  = #0#72;
          #42#10 = #0#73;

          aDivisa = #0#75;
          |HAZ HallaFactor;
          #42#1  = #0#33 * nFactor;
          #42#3  = #0#34 * nFactor;
          #42#5  = #0#35 * nFactor;
          #42#7  = #0#36 * nFactor;
          #42#9  = #0#37 * nFactor;
          #42#11 = #0#38 * nFactor;
          #42#15 = #0#39 * nFactor;
          #42#17 = #0#40 * nFactor;
          #42#19 = #0#41 * nFactor;
          #42#21 = #0#42 * nFactor;
          #42#23 = #0#43 * nFactor;
          #42#25 = #0#44 * nFactor;

          #42#14 = #0#129;
          #42#16 = #0#130;
          #42#18 = #0#131;
          #42#20 = #0#132;
          #42#22 = #0#133;
          #42#24 = #0#134;
          |SI #10#70 ! 0;
               |SI #10#60 = "B";
                    #42#26 = #0#47 + #0#21 + #0#24 + #0#27 + #0#49 + #0#52;
               |SINO;
                    #42#26 = #0#31;
               |FINSI;
               #42#27 = #0#146 * nFactor;
               #42#28 = #0#147;
          |FINSI;
          |HAZ sumavt;
          |BLANCO 805 2074;
          |PINPA #0#42;
          |PINDA #0#42;
          |ENDATOS #1#42;
          nNumVtos = 0;
          |PARA nCont = 1; |SI nCont [ 24; |HACIENDO nCont = nCont + 2;
             |SI #42nCont ! 0;
                nNumVtos = nNumVtos + 1;
             |FINSI;
             |SI nCont = 11; nCont = 12; |FINSI;
          |SIGUE;
          |POPV;
          nDeci_Base = nGuardaDiv;
     |FINSI;
|FPRC;

|PROCESO tipo13; |TIPO 7;  ||(Antes era tipo 1 3)
     |ABRE #2;
     #2#50 = #1#17;
     #2#0 = #1#2;
     |LEE 000#2=;
     |SI FSalida ! 0; |DDEFECTO #2; |FINSI;
     |CIERRA #2;
     |ABRE #agifa321;
     |LEE 010#agifa321.p;
     |CIERRA #agifa321;
     |ABRE #agifa007;
     #agifa007#26 = #0#66;
     |LEE 010#agifa007.=; || Leo la serie de la factura
     |CIERRA #agifa007;

     |SI #agifa007#39 = "S"; |Y #agifa321#4 = "S"; ||Si serie es de divisas y pintar = "S";
          |||PINTA 1004, " Su Albaran n§:            ";
          |PINTA 1005, "Su Albaran n§:";
          |ATRI I; |PINTA 1020, #2#54; |ATRI 0;
          ||div = "       Mon.Tra:    Divisa:      Cambio:         ";
          |||PINTA 1031, div;
          |PINTA 1038, "Mon.Tra:";
          |PINTA 1050, "Divisa:";
          |PINTA 1063, "Cambio:";
          |ATRI I;
          |PINTA 1047, #1#20; || Mon. de trabajo
          |PINTA 1058, #1#18; || Divisa
          |PINTA 1071, #1#19; || Cambio
          |ATRI 0;
          |SI #0#77 = "B";
            div = " (" + #0#75 + ") --->";
          |SINO;
            div = " (" + #0#78 + ") --->";
          |FINSI;
          ||div = div + "                                                                ";
          |PINTA 1104,div;
          |ATRI I;
          || Pinta campos vis.
          |PINTA 1116,#1#33;
          |PINTA 1127,#1#34;
          |PINTA 1137,#1#35;
          |PINTA 1147,#1#36;
          |PINTA 1158,#1#37;
          |PINTA 1168,#1#38;
          |ATRI 0;
     |SINO;
          |||PINTA 1104, " Su Albaran n§:            ";
          |PINTA 1105, "Su Albaran n§:";
          |ATRI I; |PINTA 1120, #2#54; |ATRI 0;
          |SI #agifa007#39 = "S"; || Si la serie es de divisas
               ||div = "       Mon.Tra:    Divisa:      Cambio:         ";
               ||PINTA 1131, div;
               |PINTA 1038, "Mon.Tra:";
               |PINTA 1050, "Divisa:";
               |PINTA 1063, "Cambio:";
               |ATRI I;
               |PINTA 1147, #1#20; || Moneda de trabajo
               |PINTA 1158, #1#18; || Divisa
               |PINTA 1171, #1#19; || Cambio
               |ATRI 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO LeeFac; |TIPO 13;
     |HAZ LeeMonBase2; || Lee los parametros de la moneda base
     |HAZ Param_Divisas3; || Lee los parametros de la divisa
     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbeFacPinta;
     |FINSI;
     |HAZ EsVipei;
     |SI FSalida = 0;
          |HAZ VipeiPinFac;
     |FINSI;
     |HAZ EsTaller;
     |SI FSalida = 0;
          |ATRI R; |PINTA 2202, "CANON";
          |ATRI I; |PINTA 2208, #0#148;
     |FINSI;
     |HAZ EsRavenida;
     |SI FSalida = 0;
          |HAZ PinRavenida79;
     |FINSI;
|FPRC;

|PROCESO LeeMonBase2; ||Lee los parametros de la moneda base
     |ABRE #agifa321;
     |ABRE #agifa324;
     |LEE 010#agifa321.p;   ||Leo parametros de divisa
     #agifa079#78 = #agifa321#9;  ||Cojo la Moneda Base de parametros
     #agifa324#0 = #agifa321#9;
     |LEE 010#agifa324.=;         ||Leo la ficha de la moneda base en Divisas
     #agifa079#79 = #agifa324#3;  ||Asigno el cambio de la moneda base con el euro
     decim_base = #agifa324#7;    ||Asigno los decimales de la moneda base
     precio_base = #agifa324#9;   ||Asigno los decimales del precio en la mon. base
     |CIERRA #agifa324;
     |CIERRA #agifa321;
|FPRC;

|PROCESO Param_Divisas3; |TIPO 0;
     |ABRE #agifa324;
     #agifa324#0 = #0#75;
     |LEE 001#agifa324.=;   || Leo la divisa
     |CIERRA #agifa324;

     decim_divisa = #agifa324#7;  || Decimales de la divisa
     precio_divisa = #agifa324#9;  || Decimales en el precio de la divisa
     nDeci_DivF = decim_divisa;   || Decimales de la divisa
     nDeci_Div = decim_divisa;   || Decimales de la divisa
     nDeci_PreDivF = precio_divisa;  || Decimales en el precio de la divisa
     nDeci_PreDiv = precio_divisa;  || Decimales en el precio de la divisa
     nDeci_PreDivP = precio_divisa;  || Decimales en el precio de la divisa
     |SI #0#77 = "B";   ||Si trabajo con la moneda base ...
          nDeci_PreVisF   = precio_divisa;
          nDeci_ImpVisF   = decim_divisa;
          nDeci_ImpVis   = decim_divisa;
          nDeci_Base     = decim_base;
          nDeci_PreBase  = precio_base;
          nDeci_BaseMx   = decim_base;
          nDeci_PreBaseMx= precio_base;
          nDeci_TotVisF   = decim_base;
          nDeci_TotVis    = decim_base;
          nDeci_TotNoVisF = decim_divisa;
          nDeci_TotNoVis  = decim_divisa;
     |SINO;     ||Si trabajo con la divisa ...
          nDeci_PreVisF   = precio_base;
          nDeci_ImpVisF   = decim_base;
          nDeci_ImpVis   = decim_base;
         |SI #0#76 = 1;
              nDeci_BaseMx    = decim_base;    || sin triangulacion
              nDeci_PreBaseMx = precio_base;
         |SINO;
              nDeci_BaseMx    = #agifa321#10;  || con triangulacion
              nDeci_PreBaseMx = #agifa321#11;
         |FINSI;
          nDeci_Base     = decim_base;
          nDeci_PreBase  = precio_base;
          nDeci_TotVisF   = decim_divisa;
          nDeci_TotVis    = decim_divisa;
          nDeci_TotNoVisF = decim_base;
          nDeci_TotNoVis  = decim_base;
     |FINSI;
     |HAZ Deci_IVAC;
|FPRC;

|PROCESO CambioDivisa3; |TIPO 0;
      |SI #agifa112#80 = "S"; || Si el proveedor es de divisa pactada
         |ABRE #agifa323;
         |ABRE #agifa322;
         #agifa322#0 = #agifa079#2;
         #agifa322#2 = #agifa072#18;
         #agifa322#7 = "N";
         |SELECT #2#agifa322;  || Con esta clave ...
         |LEE 011#agifa322.=;  || ... busco periodos no finalizados de esa divisa
         |SI FSalida = 0;  || Si existe un periodo no finalizado
           |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
             #agifa072#18 = #agifa322#2;        || Cargo la divisa ...
             #agifa072#19 = #agifa322#3;        || ...y el cambio
             |LEE 001#agifa322.=;   || Leo las lineas de Proveed/Divisas
             nfecha = #agifa079#1 - #agifa322#6;  || Resto la fecha de fin de periodo a la actual
             |SI nfecha > 0;  || Si la fecha actual supera a la del periodo asignado ...
                |MENAV "0000ATENCION deberia Actualizar primero la divisa en Proveedores/Divisas";
                prov_divisa = #agifa079#2;  || Le envio el cod. de proveedor a "agifa323"
                |SUB_EJECUTA_NP "agifa323.tab";  || Ejecuto Proveedores/Divisas
                |ERROR;
             |SINO;
                div_act = 1;  || Para salir del PARA
             |FINSI;
           |SIGUE;
         |SINO;  || Si no existe un periodo no finalizado para esa divisa
           |MENAV "0000No existe un periodo activo para la divisa en Proveedores / Divisas";
           prov_divisa = #agifa079#2;  || Le paso a "agifa323" el proveedor
           |SUB_EJECUTA_NP "agifa323.tab";  || Ejecuto Proveedores / Divisas
           |ERROR;
           ||#agifa072#18 = #agifa079#78;
           ||#agifa072#19 = #agifa079#79;
         |FINSI;
         |SELECT #1#agifa322;
         |CIERRA #agifa322;
         |CIERRA #agifa323;
      |SINO; || Si el Proveedor no es de Divisa pactada ...
         |ABRE #agifa324; || ...miro directamente en divisas
         #agifa324#0 = #agifa072#18;
         |LEE 001#agifa324.=;
         |SI FSalida = 0; ||Si existe la divisa...
            #agifa072#19 = #agifa324#3; || la recojo
            |SI #agifa324#6 ! -1; || Si los dias de margen de actualizacion no
                                  || son = -1 (indefinidos)
              |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
                 #agifa072#18 = #agifa324#0;        ||Cargo el valor de la divisa
                 #agifa072#19 = #agifa324#3;        ||Cargo el valor del cambio
                 |LEE 001#agifa324.=;  || Leo la divisa
                 nfecha = #agifa079#1 - #agifa324#4;
                 |SI nfecha > #agifa324#6; |Y #agifa324#6 ! -1;  || Si la fecha actual
                    |MENAV "0000ATENCION deberia Actualizar primero la divisa";
                    divisa = #agifa072#18;
                    |SUB_EJECUTA_NP "agifa326.tab";
                    |ERROR;
                 |SINO;
                    div_act = 1;
                 |FINSI;
              |SIGUE;
            |FINSI;
         |FINSI;
         |CIERRA #agifa324;
      |FINSI;
      |HAZ Param_Divisas3;
|FPRC;

|PROCESO PriNumeSer;
     aNume = "0";
     |PARA i = 101; |SI i [ 501; |HACIENDO i = i + 100;
          aAlfa = #0#66 % i;
          aAlfa = "0123456789" - aAlfa;
          |SI FSalida > 0; aNume = #0#66 % i; |SAL; |FINSI;
     |SIGUE;
|FPRC;

|PROCESO ObsProveedor; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |SI #0Campo ! Contenido; |O nModo = 1;
          |HAZ EsPalmHotel;
          |SI FSalida = 0;
               |HAZ PriNumeSer;
               aAlfa = "40000" + aNume + #0#2;
               #0#12 = aAlfa; |PINTA #0#12;
          |FINSI;
     |FINSI;
     |SI nModo = 1;
          |ABRE #6;
          #6#0 = #0#2;
          |LEE 000#6=;
          |CIERRA #6;
          #0#3 = #6#1; |PINTA #0#3;
     |FINSI;
     |SI nTecla = 11; |O #41#102 = "S"; |O #41#102 = "X";
          eaCodigo = #0#2;
          eaFuerza = "N";
          |SI salida = 11; eaFuerza = "S"; |FINSI;
          |SUB_EJECUTA_NP "dsz99994";
          |SI #41#102 = "N"; |Y nModo ! 2; |ERROR;  |FINSI;
     |FINSI;
|FPRC;

|PROCESO SuFactura; |TIPO 0;
     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbeFacEntra;
     |FINSI;

     aAlfa = #0#74; |QBF aAlfa;
     |SI aAlfa = ""; |ACABA; |FINSI;

     aAlfa = #0#74;
     aSerie = #0#66;
     aProv = #0#2;
     aA¤o = #0#1 % -104;
     nNume = #0#0;
     aMensa = "";
     |SALVA_FICHA #0;
     |SELECT #4#0;
     |LEE 000#0];
     |PARA; |SI FSalida = 0; |Y aProv = #0#2; |Y #0#74 = aAlfa; |HACIENDO;
          |SI #0#66 ! aSerie; |O nNume ! #0#0;
               aAlfa = #0#1 % -104;
               |SI aA¤o = aAlfa;
                    aAlfa = ("000000" + #0#0) % -106;
                    aMensa = "0000Codigo existente en Factura:" + #0#66 + "/" + aAlfa;
               |FINSI;
               |SAL;
          |FINSI;
          |LEE 000#0s;
     |SIGUE;
     |SELECT #1#0;
     |REPON_FICHA #0;
     |SI aMensa ! "";
          |MENAV aMensa;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Pideposible; |TIPO 7;
     |SI #41#161 ! "S"; |ACABA; |FINSI;
     #88#0 = #0#142;
     #88#1 = #0#143;
     #88#2 = #88#0 + #88#1;
     #88#3 = #0#21 + #0#24 + #0#27 + #0#49 + #0#52;
     #88#4 = #0#22 + #0#25 + #0#28 + #0#50 + #0#53 + #0#23 + #0#26 + #0#55 + #0#51 + #0#54;
     #88#5 = #88#3 + #88#4;
     |PUSHV 0105 2380;
     |PINPA #0#88;
     |PINDA #0#88;
     |HAZ sacares;
     |PINPA #0#88;
     |PINDA #0#88;
     |HAZ sacares;
     |ENDATOS #1#88;
     |SI FSalida = 0;
          #0#142 = #88#0;
          #0#143 = #88#1;
     |FINSI;
     |POPV;
|FPRC;

|PROCESO sacares; |TIPO 0;
     #88#2 = #88#0 + #88#1;
     |SI #88#3 ! 0;
          #88#6 = #88#0 - #88#3;
     |SINO;
          #88#6 = 0;
     |FINSI;
     |SI #88#4 ! 0;
          #88#7 = #88#1 - #88#4;
     |SINO;
          #88#7 = 0;
     |FINSI;
     |SI #88#5 ! 0;
          #88#8 = #88#2 - #88#5;
     |SINO;
          #88#8 = 0;
     |FINSI;
     |PINTA #88#2;
     |PINTA #88#6;
     |PINTA #88#7;
     |PINTA #88#8;
|FPRC;

|PROCESO Tipo079_8; |TIPO 8;
     |ABRE #279; |LEE 000#279p; |CIERRA #279;
     |ABRE #41; |LEE 000#41p; |CIERRA #41;

     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄModulo 003026
     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbeFacCom8;
     |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |HAZ EsTagloma;
     |SI FSalida = 0;
          |CONTROL_SIMPLE 0, "BOTON, ItemDoc", 0570, 0579, BtnItemDocFC;
          nBtnItemDocFC = FSalida;
     |FINSI;
|FPRC;

|PROCESO Tipo079_9; |TIPO 9;
     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbeFacCom9;
     |FINSI;
     |SI nBtnItemDocFC ! -1; |FIN_CONTROL_WINDOWS nBtnItemDocFC; |FINSI;
|FPRC;

|PROCESO Pago79_7; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo ! 1;  |ACABA;  |FINSI;

/*
     |SI Campo = 11;
         |HAZ CargaContagen;
         |SI enOk = 1;
             |ABRE #agifa091;
             #agifa091#0 = #agifa079#11;
             |LEE 000#agifa091.=;
             |CONSULTA_CLAVE #1#agifa091;
             |SI FSalida = 0;
                 #agifa079#11 = #agifa091#0;
             |FINSI;
             |CIERRA #agifa091;
         |FINSI;
     |FINSI;
*/
|FPRC;

|PROCESO Pago79_0; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo ! 1;  |ACABA;  |FINSI;

     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbeFacFec;
          |HAZ AlbeFacPinta;
     |FINSI;
|FPRC;

|PROCESO LinFact;
   #agifa077#50 = #agifa072#17;
   #agifa077#0  = #agifa072#2;
   |LEE 000#agifa077.=;
   |SI FSalida = 0;
      #agifa077#77 = #agifa079#1;
      |GRABA 020#agifa077.a;
   |FINSI;
|FPRC;

|DEFBUCLE LinFact;
#agifa072#1;
;
#agifa079#66, #agifa079#0, 001;
#agifa079#66, #agifa079#0, 999;
be;
NULL,LinFact;
|FIN;

|PROCESO CambiaFecha;
     |ABRE #agifa077;
     |BUCLE LinFact;
     |CIERRA #agifa077;

     aNomUsu = Usuario % 810;
     |ABRE #25;
     #25#0 = aNomUsu;
     |LEE 000#25=;
     |SI FSalida = 0;
          |C_M #0#12,  1, aSN;
          |SI aSN = "S"; |Y #25#84 = "N";
               |C_M #0#12,  1, "N";
          |FINSI;
     |FINSI;
     |CIERRA #25;
|FPRC;

|PROCESO T079_15; |TIPO 15;
     nTipo = 15; |HAZ Log079;
|FPRC;

|PROCESO T079_16; |TIPO 16;
     nTipo = 16; |HAZ Log079;
|FPRC;

|PROCESO T079_17; |TIPO 17;
     nTipo = 17; |HAZ Log079;
|FPRC;

|PROCESO Log079;
     |DDEF aAlfa;
     aAlfa = aAlfa + "dsm00087";
     |CARGA_DEF aAlfa, dsm00087@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aSer = #0#66;
     aNum = ("000000" + #0#0) % -106;
     aTipo = "FC";

     |ABRE #dsm00087@;
     |DDEFECTO #dsm00087@;
     |SELECT #2#dsm00087@;
     #dsm00087@#1 = aSer;
     #dsm00087@#2 = aNum;
     #dsm00087@#3 = aTipo;
     |LEE 101#dsm00087@.=;
     |SI FSalida ! 0;
          |SELECT #1#dsm00087@;
          |LEE 000#dsm00087@.u;
          |SI FSalida = 0;
               nContaLog = #dsm00087@#0 + 1;
          |SINO;
               nContaLog = 1;
          |FINSI;
          |DDEFECTO #dsm00087@;
          #dsm00087@#0 = nContaLog;
          #dsm00087@#1 = aSer;
          #dsm00087@#2 = aNum;
          #dsm00087@#3 = aTipo;
          |GRABA 020#dsm00087@.b;
     |FINSI;
     |SI FSalida = 0;
          |HORA aAlfa;
          aUsu = Usuario % 810;
          |SI nTipo = 15;
               #dsm00087@#4 = aUsu;
               #dsm00087@#5 = ~;
               #dsm00087@#6 = aAlfa;
               #dsm00087@#7 = "";
               #dsm00087@#8 = "01.01.0000";
               #dsm00087@#9 = ""
               #dsm00087@#10 = "";
               #dsm00087@#11 = "01.01.0000";
               #dsm00087@#12 = ""
          |FINSI;
          |SI nTipo = 16;
               #dsm00087@#7 = aUsu;
               #dsm00087@#8 = ~;
               #dsm00087@#9 = aAlfa;
          |FINSI;
          |SI nTipo = 17;
               #dsm00087@#10 = aUsu;
               #dsm00087@#11 = ~;
               #dsm00087@#12 = aAlfa;
          |FINSI;
          |GRABA 020#dsm00087@.a;
     |FINSI;
     |CIERRA #dsm00087@;
     |DESCARGA_DEF #dsm00087@;
|FPRC;

|PROCESO VipeiPinFac;
     |DDEF aAlfa;
     aAlfa = aAlfa + "dsm00277";
     |CARGA_DEF aAlfa, Referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;
     |DDEFECTO #Referen@;
     |ABRE #Referen@;
     #Referen@#0 = #0#66;
     #Referen@#1 = #0#0;
     |LEE 000#Referen@.=;
     |CIERRA #Referen@;
     |PINTA 1002, "Refer.:";
     |ATRI I;
     |PINTA 1010, #Referen@#2;
     |ATRI 0;
     |DESCARGA_DEF #Referen@;
|FPRC;

|PROCESO SuFactura7; |TIPO 7;
     |HAZ EsVipei;
     |SI FSalida = 0;
          |DDEF aAlfa;
          aAlfa = aAlfa + "dsm00277";
          |CARGA_DEF aAlfa, Referen@;
          |SI FSalida ! 0; |ACABA; |FINSI;
          |DDEFECTO #Referen@;
          |ABRE #Referen@;
          #Referen@#0 = #0#66;
          #Referen@#1 = #0#0;
          |LEE 101#Referen@.=;
          |SI FSalida ! 0; |GRABA 020#Referen@.b; |FINSI;
          |ENCAMPO #2#Referen@;
          |SI FSalida = 0; |GRABA 020#Referen@.a; |FINSI;
          |CIERRA #Referen@;
          |DESCARGA_DEF #Referen@;
     |FINSI;
|FPRC;

|PROCESO VipeiFacBorra;
     |DDEF aAlfa;
     aAlfa = aAlfa + "dsm00277";
     |CARGA_DEF aAlfa, Referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;
     |ABRE #Referen@;
     #Referen@#0 = #0#66;
     #Referen@#1 = #0#0;
     |LEE 101#Referen@.=;
     |SI FSalida = 0; |BORRA 020#Referen@.a; |FINSI;
     |CIERRA #Referen@;
     |DESCARGA_DEF #Referen@;
|FPRC;

|PROCESO EmpresaPrevencion79;
     |DBASS aBase;  |QBF aMas;
     aMas = aBase + "dspreven/def/visal000.mas";

     |CARGA_DEF aMas, visal000@;
     aQueQuiero = "|NC";
     aNumCampos = #visal000@#aQueQuiero#;
     nNumCampos = aNumCampos;
     aEmpresa   = "00001";

     |SI nNumCampos = 4;
         aFich = aBase + "dspreven/fich/";
         |PATH_DAT #visal000@#aFich#;
         |ABRE #visal000@;
         |SELECT #2#visal000@;
         #visal000@#3 = "S";
         |LEE 000#visal000@.=;
         |SI FSalida = 0;
             aEmpresa = ("00000" + #visal000@#0) % -105;
         |FINSI;
         |CIERRA #visal000@;
     |FINSI;

     |DESCARGA_DEF #visal000@;
|FPRC;

|PROCESO OTPFacBorra;
     |DBASS aBase;  |QBF aMas;
     aMas = aBase + "dspreven/def/autfm002.mas";
     |XABRE "E", aMas, 0;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |HAZ EmpresaPrevencion79;

     aMas = aBase + "dspreven/def/autfm002.mas";
     |CARGA_DEF aMas, autfm002@;
     aFich = aBase + "dspreven/fich/" + aEmpresa + "/";
     |PATH_DAT #autfm002@#aFich#;

     |ABRE #autfm002@;
     |SELECT #2#autfm002@;
     aAlfa        = ("00000" + #48#0) % -105;
     #autfm002@#2 = aAlfa;
     #autfm002@#8 = #agifa079#66;
     #autfm002@#9 = #agifa079#0;
     |LEE 000#autfm002@.=;
     |SI FSalida = 0;
         |SELECT #1#autfm002@;
         |LEE 101#autfm002@.=;
         |SI FSalida = 0;
             #autfm002@#8  = "";
             #autfm002@#9  = 0;
             #autfm002@#10 = "";
             |GRABA 020#autfm002@.a;
             |LIBERA #autfm002@;
        |FINSI;
    |FINSI;

    |DESCARGA_DEF #autfm002@;
|FPRC;

|PROCESO T79_66; |TIPO 66;
     |CONSULTA_CLAVE #1#0;
     |SI FSalida ! 0; |ERROR; |FINSI;
|FPRC;

|PROCESO BtnItemDocFC;
     aAlfa = "tagz0025;FC" + #0#66 + #0#0;
     |SUB_EJECUTA_NP aAlfa;
|FPRC;

|PROCESO PinRavenida79;
     |DDEF aAlfa;
     aAlfa = aAlfa + "ravem006";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #0#66;
          #referen@#1 = #0#0;
          |LEE 000#referen@.=;
          |SI FSalida ! 0; |DDEFECTO #referen@; |FINSI;
          |CIERRA #referen@;
          |PINTA 0901, "³%Repar.³T³ F.Inicio ³ F.Final  ³DiferenciaÃ";
          |ATRI R;
          |PINTA 0902, "%Repar.³T³ F.Inicio ³ F.Final  ³Diferencia";
          |ATRI 0;
          |PINTA 1001, "³       ³ ³          ³          ³          ³ ";
          |PINTA 1101, "ÃÄÄÄÄÄÄÄÁÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄ";
          |ATRI I;
          |PINTA 1002, #referen@#3;
          |PINTA 1010, #referen@#2;
          |PINTA 1012, #referen@#5;
          |PINTA 1023, #referen@#6;
          |PINTA 1034, #referen@#4;
          |ATRI 0;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO C79_3; |TIPO 0;
     enModo = (FEntrada / 100) ! 0;
     |SI FSalida = 0;
          |HAZ EsRavenida;
          |SI FSalida = 0;
               eaSerie = #0#66;
               enCodigo = #0#0;
               |SUB_EJECUTA_NP "ravem006";
               |HAZ PinRavenida79;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Ravenida79;
     |DDEF aAlfa;
     aAlfa = aAlfa + "ravem004";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #2#50;
          #referen@#1 = #2#0;
          |LEE 000#referen@.=;
          |CIERRA #referen@;
          aAlbTMaquina = #referen@#4;
          nAlbReparto = #referen@#2;
          nDiferencia = #referen@#3
          |DESCARGA_DEF #referen@;
     |FINSI;

     |DDEF aAlfa;
     aAlfa = aAlfa + "ravem006";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #0#66;
          #referen@#1 = #0#0;
          |LEE 000#referen@.=;
          |CIERRA #referen@;
          aFacTMaquina = #referen@#2;
          nFacReparto = #referen@#3;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO RavenidaGra79_1;
     |DDEF aAlfa;
     aAlfa = aAlfa + "ravem006";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #0#66;
          #referen@#1 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida ! 0; |GRABA 020#referen@.b; |FINSI;
          #referen@#2 = aAlbTMaquina;
          #referen@#3 = nAlbReparto;
          #referen@#4 = 0;
          |GRABA 020#referen@.a;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO RavenidaGra79;
     |DDEF aAlfa;
     aAlfa = aAlfa + "ravem006";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #0#66;
          #referen@#1 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida ! 0; |GRABA 020#referen@.b; |FINSI;
          #referen@#4 = #referen@#4 + nDiferencia;
          |GRABA 020#referen@.a;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;
