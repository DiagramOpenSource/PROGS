|FICHEROS;
     dsm00227 #0;

     dsm00220 #30;  ||Control path del tpv

     porm0003  #32; ||-Clientes

     agifa024  #333;
     expor024@ #33;

     agifa104 #44;  ||-Pedidos Venta (C)
     expor104@ #45;

     agifa073 #46;  ||-Pedidos Venta (L)
     expor073@ #47;

     dsm00223 #100; ||Historico E/I Central

     porconrp #500; ||Objetivos Repres. C.
|FIN;

|VARIABLES;
     &Tempo = "";
     aTmp33 = "";
     aTmp45 = "";
     aTmp47 = "";
     &eaNomDef = "";
     &enCamposDef = 0;
     aParam = "";
     n010 = 0; n071 = 0; n084 = 0; n069 = 0; n134 = 0; n059 = 0;
     n133 = 0; n039 = 0; n023 = 0; n305 = 0; n306 = 0; n024 = 0;
     n019 = 0; n112 = 0; n025 = 0; n146 = 0; n147 = 0; n104 = 0;
     n073 = 0;
     &qFichero = "";
     aMensa = "";
     ddx = "";
     aPath = "";
     swErr = 0;
     fich = "";
     org = "";
     nLin  = 0;
     fFecha = @;
     num = 0;
     bufer = 0;
     err = 0;
     fdes = "";
     des = "";
     fdef = "";
     def = "";
     exp = 0;
     puente    = "";
     puente2   = 0;
     path      = "";
     empresa   = "";
     horat     = "";
     no        = "N";
     desfecha  = "00.00.0000";
     hasfecha  = "31.12.2000";
     blanco    ="                         ";
     blanco1   ="                    ";
     param     = "";
     tipo_exp  = "";

     sw_testigo= 0;
     sw_pasada = 0;
     i         = 0;

     fecha     = @;

     aDef     = "";
     aDef1    = "";
     aDef2    = "";
     aDef3    = "";
     aDef4    = "";
     aDef5    = "";
     aDef6    = "";
     aDef7    = "";
     aDef8    = "";
     aDef9    = "";
     aDef10   = "";
     aDef11   = "";
     aDef12   = "";
     aDef13   = "";
     aDef14   = "";
     aDef15   = "";
     aDef16   = "";
     aDef17   = "";
     aDef18   = "";
     aDef19   = "";
     aDef20   = "";
     aDef21   = "";
     aDef22   = "";

     aFic = "";
     aAlfa = "";
     dirfich = "";
     longfich = "";
     longfich1 = 0;
     longfich2 = "";
     aTar      = "";
     a1        = "";
     a2        = "";

     aHora = "";
     aHH = "";
     aMM = "";
     aRepre = "";
|FIN;

||_____________________________________________/ EXPORTACION DE CLIENTES


|PROCESO miracli;
     sw_pasada = 1;
     |PINTA 2163,blanco1;
     |PINTA 2163,#32#0;

     #33#0   = "N" + #32#0;
     #33#15  = #32#1;
     #33#1   = #32#2;
     #33#5   = #32#3;
     #33#8   = #32#3;
     #33#11  = #32#3;
     #33#178 = #32#4;
     #33#181 = #32#4;
     #33#184 = #32#4;
     #33#179 = #32#5;
     #33#182 = #32#5;
     #33#185 = #32#5;
     #33#6   = #32#6;
     #33#9   = #32#6;
     #33#12  = #32#6;
     #33#7   = #32#7;
     #33#10  = #32#7;
     #33#13  = #32#7;
     #33#17  = #32#8;
     #33#18  = #32#9;
     #33#197 = #32#10;
||             #32#11;||||
     #33#36  = #32#12;
     #33#20  = #32#13;
     #33#22  = #32#14;
     #33#23  = #32#15;
     #33#24  = #32#16;
     #33#32  = #32#17;
     #33#33  = #32#18;
     #33#31  = #32#19;
     #33#30  = #32#20;
     #33#47  = #32#21;
     #33#29  = #32#22;
     #33#34  = #32#23;
     #33#53  = #32#24;
     #33#4   = #32#25;
     |GRABA 011#33n;
     |BORRA 101#32a;
     |LIBERA #33;
|FPRC;

|DEFBUCLE clientes;        ||CLientes #1
   #32#1;
   ;
   "     ";
   "zzzzz";
   be;
   NULL,miracli;
|FIN;

||******************** ped.vta;
|PROCESO linpvta;
    |PARA i=0;|SI i [ n073;|HACIENDO i = i+1;
          #47i=#46i;
    |SIGUE;
    |GRABA 021#47n;
|FPRC;

|DEFBUCLE linpvta;
     #46#1;
     ;
     #44#25, #44#0, 001;
     #44#25, #44#0, 999;
     ;
     NULL, linpvta;
|FIN;

|PROCESO cabpvta;
     sw_pasada = 1;
     #0#0 = #44#25;  |PINTA #0#0;
     #0#1 = #44#0;   |PINTA #0#1;
     |PARA i=0;|SI i [ n104;|HACIENDO i = i +1;
          #45i = #44i;
     |SIGUE;

     |GRABA 020#45n;

     #44#27 = "S";
     #44#28 = #0#8;
     |GRABA 020#44a;
     |LIBERA #44;

     |BUCLE linpvta;
|FPRC;

||TODO CCC
|DEFBUCLE leepvta;
     #44#5;
     ;
     "N", "     ",      0;
     "N", "zzzzz", 999999;
     be;
     NULL, cabpvta;
|FIN;

------------------------------------------------------------------------
|PROCESO tipo3;
     fFecha = ~;
     |HAZ BusCampos;
     |ABRE #30;
     |LEE 001#30p;
     |SI FSalida ! 0;
          |CIERRA #30;
          |MENAV "0000No se encuentra el Control Path";
          |ERROR;
          |ACABA;
     |FINSI;
     |CIERRA #30;
     path = #30#2;  |QBF path;

     |ABRE #100;
     #100#0 = "E";
     #100#1 = fFecha;
     #100#2 = 0;
     |LEE 000#100];
     |SI FSalida = 0; |Y #100#0 = "E"; |Y #100#1 = fFecha;
||          |AVISO;
||          aAlfa = "0000NSe genero una exportacion hoy " + fFecha  + ". Crear otra S/N ";
||          |CONFI aAlfa;
||          |SI FSalida ! 0; |CIERRA #100; |ACABA; |FINSI;
     |FINSI;
     |CIERRA #100;

     |HAZ  CargaDef;
     |SI swErr ! 0;
          aMensa = "0000Error al cargar:" + aDef;
          |MENAV aMensa;
          |HAZ DesCargaDef;
          |ACABA;
     |FINSI;

     || Clientes
     |SI #0#4="S";
          |PINTA 2124 , blanco;
          |PINTA 2124 , "Clientes";
          |PATH_DAT #33 path;   || Marco camino de clientes exportacion
          |ABRE #33;  |CIERRA #33;
          |DELINDEX #33;
          |ABRE #33;
          |BUCLE clientes;
          |LIBERA #33;
          |CIERRA #33;
     |FINSI;
||******************** Pedidos Vta;
     |SI #0#17 = "S";
          |PINTA 2124 , blanco;
          |PINTA 2124 , "Pedidos Vta.";

          |PATH_DAT #45 path;

          |PATH_DAT #47 path;

          |ABRE #45; |CIERRA #45;

          |ABRE #47; |CIERRA #47;

          |DELINDEX #45;

          |DELINDEX #47;

          |ABRE #45;

          |ABRE #47;

          |BUCLE leepvta;
          |CIERRA #45;

          |CIERRA #47;

     |FINSI;

     |HAZ DesCargaDef;
     ||TODO CCC
     |SI sw_pasada = 1;
          |HAZ Comprime;
          |SI #0#22 = "S";        || SI quiere envio Por Correo.
               qFichero = path + aTar;
||               |CONFI "0000SEnviar Exportacion a central ahora: ";
||               |SI FSalida = 0;
||                   |MENAV "0000Atencion!! Debe estar conectado a internet";
                   |SUB_EJECUTA "dsm00228.tab";
||               |FINSI;
          |FINSI;
     |SINO;
||          |MENAV "0000No hay nada nuevo para exportar!!";
     |FINSI;
|FPRC;

|PROCESO mayus; |TIPO 0;
 #0Campo = #0Campo > " ";
 |PINTA #0Campo;
|FPRC;
=======================================================================
|PROCESO BusCampos;
     |DFICE org; |QBF org;
     |DBASE des; |QBF des;
     |DDEF  def; |QBF def;
     eaNomDef = "porm0003"; |HAZ CamposDef; n024 = enCamposDef;
     eaNomDef = "agifa104"; |HAZ CamposDef; n104 = enCamposDef;
     eaNomDef = "agifa073"; |HAZ CamposDef; n073 = enCamposDef;
|FPRC;

|PROCESO CargaDef;
     |DBASE aPath;

     aDef13= aPath + "def/" + "agifa024";
     aDef  = aDef13;
     |CARGA_DEF aDef, expor024@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef13 = "";
          |ACABA;
     |FINSI;

     aDef19= aPath + "def/" + "agifa104";
     aDef  = aDef19;
     |CARGA_DEF aDef, expor104@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef19 = "";
          |ACABA;
     |FINSI;

     aDef20= aPath + "def/" + "agifa073";
     aDef  = aDef20;
     |CARGA_DEF aDef, expor073@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef20 = "";
          |ACABA;
     |FINSI;
     |HAZ NomeDat;
|FPRC;

|PROCESO DesCargaDef;
     |SI aDef20 ! ""; |DESCARGA_DEF #expor073@; |FINSI;
     |SI aDef19 ! ""; |DESCARGA_DEF #expor104@; |FINSI;
     |SI aDef13 ! ""; |DESCARGA_DEF #expor024@; |FINSI;
|FPRC;

|PROCESO NomeDat;
     |NOME_DAT #47 "expor073";
     |NOME_DAT #45 "expor104";
     |NOME_DAT #33 "expor024";
|FPRC;

컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
  El Nombre del Fichero:  aammdd + empresa + "." + Linea Histo
           digitos....   Fecha(6)   (5)             (3)

     Esta dando problema de ficheros repetidos que se machacan unos
     a otros ... por lo que vamos a cambiar el nombre del fichero

     Antes  AAMMDDEEEEE.*
     Ahora  AMMDDHHMMRR.*

컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴


|PROCESO Comprime;
     |DFICE dirfich; |QBF dirfich; ||Directorio de la empresa
     empresa = dirfich % -205;

     |ABRE #100;
     #100#0 = "E";
     #100#1 = fFecha;
     #100#2 = 999;
     |LEE 000#100];
     |SI FSalida = 0;
          |LEE 000#100a;
     |SINO;
          |LEE 000#100u;
     |FINSI;
     |SI FSalida = 0; |Y #100#0 = "E"; |Y #100#1 = fFecha;
          nLin = #100#2 + 1;
     |SINO;
          nLin = 1;
     |FINSI;


     ||TODO CCC ... Cambiar el nombre del fichero
/*
     aFic = (fFecha % -102) + (fFecha % 402) + (fFecha % 102);
     aAlfa = ("000" + nLin) % -103;
     aTar = aFic + empresa + "." + aAlfa;    ||->Nombre del Fichero
*/
     |HORA aHora;
     aHora = aHora % 105;
     aHH = aHora % 102;
     aMM = aHora % -102;
     aRepre = ("00" + aRepre) % -102;

     aFic = (fFecha % -101) + (fFecha % 402) + (fFecha % 102);
     aAlfa = ("000" + nLin) % -103;
     aTar = aFic + aHH + aMM + aRepre + "." + aAlfa;    ||->Nombre del Fichero



     a1 = path + aTar + " *.dat *.ixx *.ddx";
     a2 = path;
     |ATAR a1, a2;

     a1 = path + aTar;
     |COMPRIME a1;
     |FBORRA a1;
     a2 = path + aFic + empresa + ".gz";
     |RENOMBRA_FICHERO a2, a1;

     aFic = path + aTar;
     |XABRE "E", aFic, 0;
     |SI FSalida ! 0;
          aAlfa = "0000No puede compactar... " + aTar;
          |MENAV aAlfa;
          aTar = "ERROR EN TAR";
     |SINO;
          aFic = path;
          |_PDIR aFic;
          |PARA; |SI FSalida = 0; |HACIENDO;
               aAlfa = aFic % -103;
               |SI aAlfa = "ddx"; |O aAlfa = "ixx"; |O aAlfa = "dat";
                    aAlfa = aFic % -0805;
                    |SI aAlfa = "expor"; |FBORRA aFic; |FINSI;
                    aAlfa = aFic % -0507;
                    |SI aAlfa = "testigo"; |FBORRA aFic; |FINSI;
               |FINSI;
               |_SDIR aFic;
          |SIGUE;
     |FINSI;
     ||--------------------Registro
     |HORA aAlfa;
     |DDEFECTO #100;
     #100#0 = "E";
     #100#1 = fFecha;
     #100#2 = nLin;
     #100#3 = aAlfa;
     #100#4 = Usuario % 810;
     #100#5 = aTar;
     |GRABA 020#100n;
     |CIERRA #100;
|FPRC;

|PROGRAMA;
     |HAZ CreaTempo; aTmp33 = Tempo; |NOME_DAT #33 Tempo; |DELINDEX #33;
     |HAZ CreaTempo; aTmp45 = Tempo; |NOME_DAT #45 Tempo; |DELINDEX #45;
     |HAZ CreaTempo; aTmp47 = Tempo; |NOME_DAT #47 Tempo; |DELINDEX #47;

     |ABRE #porconrp;
     |LEE 000#porconrp.p;
     |SI FSalida = 0;
          aRepre = #porconrp#0;
     |SINO;
          aRepre = "00";
     |FINSI;
     |CIERRA #porconrp;

     aParam = PARAMETRO;
     |QBF aParam;
     param = aParam;
     |ABRE #0;
     #0#23 = 1;
     |LEE 101#0=;
     |SI FSalida ! 0;
          |DDEFECTO #0;
          |GRABA 020#0b;
     |FINSI;
||     |SI aParam = "portataut";
          |HAZ tipo3;
||     |SINO;
||          |PINPA #0#0;
||          |PINDA #0#0;
||          |ENDATOS #1#0;
||          |SI FSalida = 0;
||               |GRABA 020#0a;
||               |HAZ tipo3;
||          |FINSI;
||     |FINSI;
     |CIERRA #0;

     Tempo = aTmp33; |HAZ BoraTempo; |DELINDEX #33;
     Tempo = aTmp45; |HAZ BoraTempo; |DELINDEX #45;
     Tempo = aTmp47; |HAZ BoraTempo; |DELINDEX #47;

|FPRO;
