|FICHEROS;
     sanch002;
     agifa007;
     agifa041;
     agifa019;
     agifa017;

     agifa104;
     agifa073;

     agifa077;
     agifa080;

     agifa112;
     agifa142;
     agifa321;
     agifa324;

     dsm00005;

     agifa073@;
|FIN;

|VARIABLES;
     aDirEmp        = "";
     aDatos         = "";
     aAlfa          = "";
     aFic           = "";
     aPath          = "";
     aMas           = "";

     nCodEmp        = 0;
     nConta         = 0;
     nLinV          = 0;
     nHayPed        = 0;
     nId            = 0;
     nSalida        = 0;
     nCampos        = 0;
     nCmp           = 0;

     &enSwMenu        = 0;
     &nDeci_Base      = 0;
     &nDeci_PreBase   = 0;
     &nDeci_BaseMx    = 0;
     &nDeci_PreBaseMx = 0;
     &nDeci_BaseMxP   = 0;
     &nDeci_PreBasMxP = 0;
     &nDeci_DivP      = 0;
     &nDeci_PreDivP   = 0;
     &nDeci_TotVisP   = 0;
     &nDeci_TotNoVisP = 0;
     &nDeci_PreVisP   = 0;
     &nDeci_ImpVisP   = 0;
     &decim_divisa    = 0;
     &precio_divisa   = 0;
     &decim_base      = 0;
     &precio_base     = 0;
     &nDeci_Div       = 0;
     &nDeci_PreDiv    = 0;
     &nDeci_TotVis    = 0;
     &nDeci_TotNoVis  = 0;
     &nDeci_PreVis    = 0;
     &nDeci_ImpVis    = 0;
|FIN;

|INCLUYE i_varart;

|PROCESO Param_Divisas;
     |ABRE #agifa324;
     #agifa324#0 = #agifa077#56;
     |LEE 001#agifa324.=;
     |CIERRA #agifa324;

     decim_divisa  = #agifa324#7;
     precio_divisa = #agifa324#9;
     nDeci_Div     = decim_divisa;
     nDeci_PreDiv   = precio_divisa;
     |SI #agifa077#58 = "B";
          nDeci_PreVis    = precio_divisa;
          nDeci_ImpVis    = decim_divisa;
          nDeci_Base      = decim_base;
          nDeci_PreBase   = precio_base;
          nDeci_BaseMx    = decim_base;
          nDeci_PreBaseMx = precio_base;
          nDeci_TotVis    = decim_base;
          nDeci_TotNoVis  = decim_divisa;
     |SINO;
          nDeci_PreVis   = precio_base;
          nDeci_ImpVis   = decim_base;
          nDeci_Base     = decim_base;
          nDeci_PreBase  = precio_base;
          |SI #agifa077#57 = 1;
              nDeci_BaseMx    = decim_base;    || sin triangulacion
              nDeci_PreBaseMx = precio_base;
          |SINO;
              nDeci_BaseMx    = #agifa321#10;  || con triangulacion
              nDeci_PreBaseMx = #agifa321#11;
          |FINSI;
          nDeci_TotVis     = decim_divisa;
          nDeci_TotNoVis   = decim_base;
     |FINSI;

     |HAZ Deci_IVAC;
|FPRC;

|PROCESO LeeMonBase; ||Lee los parametros de la moneda base
     #agifa077#61 = #agifa321#9;

     |ABRE #agifa324;
     #agifa324#0 = #agifa321#9;
     |LEE 010#agifa324.=;         ||Leo la ficha de la moneda base en Divisas
     |CIERRA #agifa324;

     #agifa077#62 = #agifa324#3;  ||Asigno el cambio de la moneda base con el euro

     decim_base  = #agifa324#7;    ||Asigno los decimales de la moneda base
     precio_base = #agifa324#9;   ||Asigno los decimales del precio en la mon. base
|FPRC;

|PROCESO LeeParamDiv;
     |HAZ LeeMonBase;
     |HAZ Param_Divisas;
|FPRC;

|PROCESO Contador;
     #agifa077#50 = eaSerie;
     enSwMenu = 1;
     |HAZ ContaAC7;
     nConta = #agifa077#0;
     |PARA; |SI FSalida = 0; |HACIENDO;
          #agifa077#0  = nConta;
          #agifa077#50 = eaSerie;
          |LEE 000#agifa077.=;
          |SI FSalida = 0; nConta  = nConta + 1; |FINSI;
     |SIGUE;
     |DDEFECTO #agifa077;
     #agifa077#0  = nConta;
     #agifa077#50 = eaSerie;
|FPRC;

|PROCESO LeeProveedor;
     |ABRE #agifa112;
     #agifa112#0 = #agifa077#3;
     |LEE 000#agifa112.=;
     |SI FSalida ! 0; |DDEFECTO #agifa112; |FINSI;
     |CIERRA #agifa112;
|FPRC;

|PROCESO LeeArticulo;
     #agifa019#0 = #agifa073#2;
     |LEE 021#agifa019.=;
     |SI FSalida ! 0; |DDEFECTO #agifa019; |FINSI;
|FPRC;

|PROCESO dsm00005;
     #dsm00005#0 = "AC";
     #dsm00005#1 = #agifa080#27;
     #dsm00005#2 = #agifa080#0;
     #dsm00005#3 = #agifa080#1;
     |GRABA 020#dsm00005.n;
|FPRC;

|DEFBUCLE dsm00005;
     #dsm00005#1;
     ;
     "AV", #agifa073#28, #agifa073#0, nLinV,"      ";
     "AV", #agifa073#28, #agifa073#0, nLinV,"zzzzzz";
     be;
     NULL, dsm00005;
|FIN;

|PROCESO PcmLinea;
     enPrecioB = #agifa324#9;
     enDeciB   = nDeci_PreBase;
     enForma   = 1;
     eaDocu    = "agifa077";
     |HAZ StockEntra;
|FPRC;

|PROCESO agifa104_2;
     |SI nHayPed = 0;
         |ACABA;
     |FINSI;

||     #agifa104#34 = "S";
     |GRABA 020#agifa104.a;
     |LIBERA #agifa104;
|FPRC;

|PROCESO agifa073Agru;
     |HAZ LeeArticulo;
     |DDEFECTO #agifa080;
     |SI #agifa019#213 ! #sanch002#7;
         |ACABA;
     |FINSI;

     nSalida = 1;
     |LEE 000#agifa073@.p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          |SI #agifa073@#2 = #agifa073#2;
              |SI #sanch002#10 = "A";
                  |SI #agifa073@#6 = #agifa073#6;
                      nSalida = 0;
                      |SAL;
                  |FINSI;
              |SINO;
                  nSalida = 0;
                  |SAL;
              |FINSI;
          |FINSI;
          |LEE 000#agifa073@.s;
     |SIGUE;

     |SI nSalida = 0;
          #agifa073@#5 = #agifa073@#5 + #agifa073#5;
          |GRABA 020#agifa073@.a;
     |SINO;
          aAlfa = "|NC"; aAlfa = #agifa073@#aAlfa#;
          nCampos = aAlfa; nCampos = nCampos - 1;
          |PARA nCmp = 0; |SI nCmp [ nCampos; |HACIENDO nCmp = nCmp + 1;
               #agifa073@#nCmp# = #agifa073#nCmp#;
          |SIGUE;
          |GRABA 020#agifa073@.n;
     |FINSI;
     |LIBERA #agifa073@;

     nHayPed = 1;
|FPRC;

|PROCESO agifa104_1;
     nHayPed = 0;

     aAlfa = "0000Pasando pedido: " + #agifa104#25 + "/" + (("000000" + #agifa104#0) % -106);
     |MENSA aAlfa;

     |SI #agifa104#34 = "S";
          aAlfa = "0000Pedido: " + #agifa104#25 + "/" + (("000000" + #agifa104#0) % -106) + ", pasado a compras...";
          |MENAV aAlfa;
          |ERROR;

          |LIBERA #agifa104;
          |ACABA;
     |FINSI;
|FPRC;

|DEFBUCLE agifa104Agru;
     #agifa104#1;
     1;
     #sanch002#0, #sanch002#2, #sanch002#4;
     #sanch002#1, #sanch002#3, #sanch002#5;
     be;
     NULL, agifa104_1, agifa073Agru, agifa104_2;
|FIN;

|PROCESO CabCompra;
     eaSerie = #sanch002#6;
     |HAZ Contador;
     |GRABA 020#agifa077.b;

     #agifa077#1 = #sanch002#8;
     #agifa077#3 = #sanch002#7;
     |HAZ LeeProveedor;

     #agifa077#3 = #agifa112#0;
     #agifa077#4 = #agifa112#1;
     #agifa077#8 = #agifa112#17;

     |DFICE aDirEmp;
     |DFICB aDatos;
     aDirEmp = aDirEmp % -205;
     nCodEmp = aDirEmp;
     |PATH_DAT #agifa041#aDatos#;

     |ABRE #agifa041;
     #agifa041#0 = nCodEmp;
     |LEE 000#agifa041.=;
     |CIERRA #agifa041;

     #agifa077#29 = #agifa041#1;        || nombre de la empresa
     #agifa077#30 = #agifa041#2;        || direccion de la empresa
     #agifa077#31 = #agifa041#3;        || poblacion de la empresa
     #agifa077#33 = #agifa041#4;        || provincia de la empresa
     #agifa077#36 = #agifa112#58;
     #agifa077#56 = #agifa112#81;

     #agifa324#0 = #agifa077#56;
     |LEE 000#agifa324.=;

     #agifa077#57 = #agifa324#3;
     #agifa077#58 = #agifa112#82;
     #agifa077#61 = #agifa321#9;

     #agifa324#0 = #agifa077#61;
     |LEE 000#agifa324.=;
     #agifa077#62 = #agifa324#3;

     |HAZ LeeParamDiv;

     |GRABA 020#agifa077.a;
|FPRC;

|PROCESO agifa073;
     |HAZ LeeArticulo;
     |DDEFECTO #agifa080;
     |SI #agifa019#213 ! #sanch002#7;
         |ACABA;
     |FINSI;

     nId = nId + 1;

     #agifa080#27 = #agifa077#50;
     #agifa080#0  = #agifa077#0;
     #agifa080#1  = nId;
     #agifa080#2  = #agifa073#2;
     #agifa080#4  = #agifa073#4;

     #agifa007#26 = #agifa080#27;
     |LEE 020#agifa007.=;

     #agifa080#3 = #agifa007#31;          || Almacen
     #agifa080#5 = #agifa073#5;

     #agifa080#11 = #agifa073#14;
     #agifa080#13 = #agifa073#18;
     #agifa080#15 = #agifa077#3;

     #agifa080#34 = #agifa073#35;
     #agifa080#35 = #agifa073#36;
     #agifa080#36 = #agifa073#44;
     #agifa080#38 = #agifa073#46;
     #agifa080#39 = #agifa073#50;
     #agifa080#40 = #agifa073#51;
     #agifa080#41 = #agifa073#52;
     #agifa080#43 = #agifa019#205;

     eaDocu = "agifa080";
     |HAZ LeePreDtoCom;

     #agifa080#6  = enPrecio;
     #agifa080#30 = enPreDiv;
     #agifa080#8  = enDto1;
     #agifa080#26 = enDto2;
     #agifa080#45 = enDto3;
     #agifa080#37 = #sanch002#9;

     |SI #sanch002#10 = "C";
          #agifa080#6  = #agifa019#28;
          #agifa080#30 = #agifa019#133;
     |FINSI;

     |SI #sanch002#10 = "A";
          #agifa080#6  = #agifa073#6;
          #agifa080#26 = #agifa073#40;
          #agifa080#8  = #agifa073#8;
          #agifa080#26 = #agifa073#29;
          #agifa080#45 = 0;
     |FINSI;

     |HAZ TotalLin80;
     |GRABA 020#agifa080.n;

     nLinV = #agifa073#1;
     |BUCLE dsm00005;

     enForma = 1;
     eaDocu = "agifa080";
     |HAZ StockEntra;
|FPRC;

|DEFBUCLE agifa073;
     #agifa073#3;
     ;
     INICIO;
     FINAL;
     ;
     NULL, agifa073;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #agifa142; |LEE 000#agifa142.p; |CIERRA #agifa142;
     |ABRE #agifa321; |LEE 000#agifa321.p; |CIERRA #agifa321;

     |ABRE #agifa077;
     |ABRE #agifa324;
     |ABRE #agifa019;
     |ABRE #agifa007;

     |DDEF aPath;
     aMas = aPath + "agifa073.mas";
     |CARGA_DEF aMas, agifa073@;
     aFic = "agifa073" + Usuario; |NOME_DAT #agifa073@#aFic#;

     |ABRE #agifa073@;  |CIERRA #agifa073@;  |DELINDEX #agifa073@;

     |ABRE #agifa073@;
     |BUCLE agifa104Agru;
     |CIERRA #agifa073@;

     nId = 0;

     |HAZ CabCompra;

     |NOME_DAT #agifa073#aFic#;

     |ABRE #agifa080;
     |BUCLE agifa073;
     |NOME_DAT #agifa073#"agifa073"#;

     |ABRE #agifa073@;  |CIERRA #agifa073@;  |DELINDEX #agifa073@;

     |HAZ LimCabAgifa077;
     |SI nId ! 0;
         |BUCLELIN 0 CalCabAgifa077 #agifa077;

         |BUCLELIN 0 PcmLinea #agifa077;
         |GRABA 020#agifa077.a;
     |SINO;
         |BORRA 020#agifa077.a;
     |FINSI;
     |LIBERA #agifa077;

     |CIERRA #agifa080;
     |CIERRA #agifa077;
     |CIERRA #agifa324;
     |CIERRA #agifa019;
     |CIERRA #agifa007;
|FPRC;
