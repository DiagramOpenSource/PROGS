||Queda sustituido por el Recalculo albz0022.


||Este proceso queda aparcado hasta que tenga el mantenimiento correctamente
||definido.

||Este recalculo, no es un recalculo completo, que habria que pensar como
||hacerlo, pq. como existen campos modificables, nos quedariamos sin esas
||modificaciones. Habria que tener en cuenta Mezcladas y Tintado en tal caso.

||Este recalculo lo que hace es recorrer los documentos involucados,
||borra las partidas incorrectas (sin cab ni lineas, sin cab o sin lineas)
||y las vuelve a regenerar desde cero.

|FICHEROS;
     albm0050 #0;

     albm0046 #46;       ||Art./Alm./PartidaCAB
     albm0047 #47;       ||Art./Alm./PartidaLIN

     agifa077 #77;       ||Albaranes Com. Cabs.
     agifa080 #80;       ||Albaranes Com. Lins.
     agist001 #201;      ||In.Stock Inicial (C)
     agist002 #202;      ||In.Stock Inicial (L)
     dsm00056 #56;       ||Entrada Valorada (C)
     dsm00057 #57;       ||Entrada Valorada (L)
     dsm00043 #43;       ||Reg. Existencias (C)
     dsm00044 #44;       ||Reg. Existencias (L)

     albm0035 #35;       ||Incidencias

     albw0028 #828;      ||Tmp Recal. Partidas
|FIN;

|VARIABLES;
     nExiste = 0;
     aMensaje = "";
     aRespuesta = "";
     aPartida = "";
     nUni1 = 0;
     nUni2 = 0;
     aArticulo = "";
     nAlmacen = 0;
     aPartida46 = "";
     aIncPar = "";
     nForma = 0;
     aObserva = "";
     nSalida = 0;

     aCerrada = "";
     aInciden = "";
     aObs = ""

     &Tempo    = "";
     aTempo828 = "";
     nSwPaso = 0;
     aArt28 = "";
     nAlm28 = 0;
     aPar28 = "";
     &enUni1 = 0;
     &enUni2 = 0;
     &enAlbForma = 0;
     &eaIncPar = "";

     &enRecalculo = 0;
     nSwBien = 0;
     nSwHayLin = 0;
|FIN;

|PROCESO MiraIncidencia;
     aIncPar = "";
     |DDEFECTO #albm0035;
     #albm0035#0 = #80#2;
     #albm0035#2 = #80#3;
     #albm0035#4 = #80#37;
     |LEE 000#albm0035.=;
     |SI FSalida = 0;
          |SI #albm0035#11 = "S"; |O #albm0035#12 = "S"; |O #albm0035#13 = "S"; |O #albm0035#14 = "S"; |O #albm0035#15 = "S";
               aIncPar = "S";
          |FINSI;
          |SI #albm0035#16 = "S"; |O #albm0035#17 = "S"; |O #albm0035#18 = "S"; |O #albm0035#19 = "S"; |O #albm0035#20 = "S";
               aIncPar = "S";
          |FINSI;
          |SI #albm0035#21 = "S"; |O #albm0035#22 = "S"; |O #albm0035#23 = "S"; |O #albm0035#24 = "S";
               aIncPar = "S";
          |FINSI;
          |SI #albm0035#25 = "S"; |O #albm0035#27 = "S";
               aIncPar = "S";
          |FINSI;
     |SINO;
          aIncPar = "N";
     |FINSI;
|FPRC;

|PROGRAMA;
     aMensaje = "0000Proceso Obsoleto. Ha sido sustituido por albz0022";
     |MENAV aMensaje;
     |ACABA;

     |CLS;
     |ABRE #0;
     |DDEFECTO #0;
     |LEE 101#0p;
     nExiste = FSalida;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          aRespuesta = #albm0050#4;
          #albm0050#4 = "NO";
          |SI nExiste = 0;
               |GRABA 020#0a;
          |SINO;
               |GRABA 020#0n;
          |FINSI;
          |SI aRespuesta = "SI";
               |HAZ Principal;
          |FINSI;
     |FINSI;
     |LIBERA #0;
     |CIERRA #0;
|FPRO;

|PROCESO albm0047;
     |BORRA 020#albm0047.a;
     |LIBERA #albm0047;
|FPRC;

|DEFBUCLE albm0047;
 #albm0047#1;
 ;
 #albw0028#1, #albw0028#2, 001;
 #albw0028#1, #albw0028#2, 999;
 be;
 NULL, albm0047;
|FIN;

|PROCESO albw0028;
     ||Borro las lineas y limpio los importes y las unidades, y el articulo original
     ||#albm0046#0 = #albw0028#0;
     #albm0046#1 = #albw0028#1;
     #albm0046#2 = #albw0028#2;
     |LEE 101#albm0046.=;
     |SI FSalida = 0;
          |PDEFECTO #albm0046, 9, 13;
          |PDEFECTO #albm0046, 16, 18;
          |PDEFECTO #albm0046, 20, 24;
          |PDEFECTO #albm0046, 29, 39;
          |PDEFECTO #albm0046, 43, 46;
          |GRABA 020#albm0046.a;
     |FINSI;
     |LIBERA #albm0046;

     |BUCLE albm0047;
|FPRC;

|DEFBUCLE albw0028;
 #albw0028#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, albw0028;
|FIN;

|PROCESO Principal;
     enRecalculo = 1;
     |ABRE #albm0046;
     |ABRE #albm0035;

     |HAZ CreaTempo; aTempo828 = Tempo;
     |NOME_DAT #828 aTempo828; |DELINDEX #828;

     |ABRE #828;
     nSwPaso = 1;                  ||Relleno el temporal
     |HAZ TodosProcesos;
     |CIERRA #828;

     |ABRE #albm0046;
     |BUCLE albw0028;
     |CIERRA #albm0046;

     |ABRE #828;
     nSwPaso = 2;                  ||El recalculo en si
     |HAZ TodosProcesos;
     |CIERRA #828;

     |DELINDEX #828; Tempo = aTempo828; |HAZ BoraTempo;

     |CIERRA #albm0035;
     |CIERRA #albm0046;
|FPRC;


|PROCESO TodosProcesos;
     |HAZ AlbaranesCompras;
     |HAZ EntradaValorada;
     |HAZ EntradaStockIni;
     |HAZ RegulacionExiste;
/*
     |HAZ Mezcladas;
     |HAZ Tintadas;
*/
|FPRC;

|PROCESO Mete828;
     nSwBien = 1;
     |HAZ MiraPartidaBien;
     |SI nSwBien = 0;
          ||#828#0 = aArt28;
          #828#1 = nAlm28;
          #828#2 = aPar28;
          |LEE 101#828=;
          |SI FSalida ! 0;
               |GRABA 020#828n;
          |FINSI;
          |LIBERA #828;
     |FINSI;
|FPRC;

|PROCESO agifa080;
     |SI nSwPaso = 1;
          aPartida = #agifa080#37;
          |QBT aPartida;
          |SI aPartida ! ""; |Y aPartida ! "0";
               aArt28 = #80#2;
               nAlm28 = #80#3;
               aPar28 = #80#37;
               |HAZ Mete828;
          |FINSI;
     |SINO;
          aPartida = #agifa080#37;
          |QBT aPartida;
          |SI aPartida ! ""; |Y aPartida ! "0";
               nAlm28 = #80#3;
               aPar28 = #80#37;
               #albw0028#1 = nAlm28;
               #albw0028#2 = aPar28;
               |LEE 000#albw0028.=;
               |SI FSalida = 0;
                    #albm0050#1 = "Albaranes";
                    #albm0050#2 = #agifa080#27;
                    #albm0050#3 = #agifa080#0;
                    |PINTA #albm0050#1;
                    |PINTA #albm0050#2;
                    |PINTA #albm0050#3;

                    |HAZ MiraIncidencia;
                    eaIncPar = aIncPar;
                    enUni1 = #80#5;
                    enUni2 = #80#36;
                    enAlbForma = 1;
                    |HAZ AlberoActPartidas;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE agifa077;
 #agifa077#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, NULL, agifa080;
|FIN;

|PROCESO AlbaranesCompras;
     |BUCLE agifa077;
|FPRC;

|PROCESO dsm00057;
     |SI nSwPaso = 1;
          aPartida = #57#22;
          |QBT aPartida;
          |SI aPartida ! ""; |Y aPartida ! "0";
               aArt28 = #57#0;
               nAlm28 = #57#1;
               aPar28 = #57#22;
               |HAZ Mete828;
          |FINSI;
     |SINO;
          aPartida = #57#22;
          |QBT aPartida;
          |SI aPartida ! ""; |Y aPartida ! "0";
               nAlm28 = #57#1;
               aPar28 = #57#22;
               #albw0028#1 = nAlm28;
               #albw0028#2 = aPar28;
               |LEE 000#albw0028.=;
               |SI FSalida = 0;
                    #albm0050#1 = "Entrada Val.";
                    #albm0050#2 = #dsm00056#2;
                    #albm0050#3 = #dsm00056#0;
                    |PINTA #albm0050#1;
                    |PINTA #albm0050#2;
                    |PINTA #albm0050#3;

                    enUni1 = #57#4;
                    enUni2 = #57#21;
                    enAlbForma = 1;
                    |HAZ AlberoActPartidasEV;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsm00056;
 #dsm00056#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, NULL, dsm00057;
|FIN;

|PROCESO EntradaValorada;
     |BUCLE dsm00056;
|FPRC;

|PROCESO agist002;
     |SI nSwPaso = 1;
          aPartida = #agist002#8;
          |QBT aPartida;
          |SI aPartida ! ""; |Y aPartida ! "0";
               aArt28 = #202#2;
               nAlm28 = #202#3;
               aPar28 = #202#8;
               |HAZ Mete828;
          |FINSI;
     |SINO;
          aPartida = #agist002#8;
          |QBT aPartida;
          |SI aPartida ! ""; |Y aPartida ! "0";
               nAlm28 = #202#3;
               aPar28 = #202#8;
               #albw0028#1 = nAlm28;
               #albw0028#2 = aPar28;
               |LEE 000#albw0028.=;
               |SI FSalida = 0;
                    #albm0050#1 = "Ent.StockIni";
                    #albm0050#2 = #agist001#2;
                    #albm0050#3 = #agist001#0;
                    |PINTA #albm0050#1;
                    |PINTA #albm0050#2;
                    |PINTA #albm0050#3;

                    enUni1 = #202#4;
                    enUni2 = #202#7;
                    enAlbForma = 1;
                    |HAZ AlberoActPartidasSA;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE agist001;
 #agist001#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, NULL, agist002;
|FIN;


|PROCESO EntradaStockIni;
     |BUCLE agist001;
|FPRC;

|PROCESO dsm00044;
     |SI nSwPaso = 1;
          aPartida = #dsm00044#13;
          |QBT aPartida;
          |SI aPartida ! ""; |Y aPartida ! "0";
               aArt28 = #44#0;
               nAlm28 = #44#1;
               aPar28 = #44#13;
               |HAZ Mete828;
          |FINSI;
     |SINO;
          aPartida = #dsm00044#13;
          |QBT aPartida;
          |SI aPartida ! ""; |Y aPartida ! "0";
               nAlm28 = #44#1;
               aPar28 = #44#13;
               #albw0028#1 = nAlm28;
               #albw0028#2 = aPar28;
               |LEE 000#albw0028.=;
               |SI FSalida = 0;
                    #albm0050#1 = "Reg.Existen.";
                    #albm0050#2 = #dsm00043#4;
                    #albm0050#3 = #dsm00043#0;
                    |PINTA #albm0050#1;
                    |PINTA #albm0050#2;
                    |PINTA #albm0050#3;
                    enUni1 = #44#4;
                    enUni2 = #44#12;
                    |SI #44#7 = "S";
                         enUni1 = enUni1 * -1;
                         enUni2 = enUni2 * -1;
                    |FINSI;
                    enAlbForma = 1;
                    |HAZ AlberoActPartidasES;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsm00043;
 #dsm00043#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, NULL, dsm00044;
|FIN;

|PROCESO RegulacionExiste;
     |BUCLE dsm00043;
|FPRC;

|PROCESO albm0047_esta;
     nSwHayLin = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE albm0047_esta;
 #albm0047#1;
 ;
 nAlm28, aPar28, 001;
 nAlm28, aPar28, 999;
 ;
 NULL, albm0047_esta;
|FIN;


|PROCESO MiraPartidaBien;
     ||Devuelve nSwBien

     #albm0046#1 = nAlm28
     #albm0046#2 = aPar28
     |LEE 000#albm0046.=;
     |SI FSalida = 0;
          |SI #46#9 = 0; |Y #46#10 = 0; |Y #46#11 = 0; |Y #46#12 = 0; |Y #46#31 = 0; |Y #46#32 = 0; |Y #46#43 = 0; |Y #46#44 = 0;
               nSwBien = 0;
          |SINO;
               nSwHayLin = 0;
               |BUCLE albm0047_esta;
               |SI nSwHayLin = 0;
                    nSwBien = 0;
               |SINO;
                    nSwBien = 1;
               |FINSI;
          |FINSI;
     |SINO;
          nSwBien = 0;
     |FINSI;
|FPRC;
