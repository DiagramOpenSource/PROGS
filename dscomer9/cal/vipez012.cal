|FICHEROS;
     vipez012 #0;
     vipem017 #917;
     vipem008 #8;        ||Para. VIPEI Alquiler
     vipew018 #918;      ||Aux.Equivalen.Abonos

     agifa010 #10;
     agifa019 #19;
     agifa071 #71;
     agifa024 #24;
     agifa025 #25;
     agifa059 #59;
     agifa134 #134;
     agifa142 #142;
     agifa324 #324;
     agis0002 #702;
     agifa704 #704;
     agifa716 #716;
     agifa722 #722;
     ref1z002@ #997;
     referen@  #999;
     agifa027 #27;

     vipez013  #513,MANTE;

     tempo134 #634,MANTE; || Temporal Impresion
|FIN;

|VARIABLES;
     nAux = 0;
     nSwHayMarca = 0;
     nCont = 0;
     nVoyPor = 0;
     aSerAnterior = "";
     nNumAnterior = 0;

     nUltAbonoFac = 0;
     nUltAbonoAlb = 0;

     nSwEstaEqui = 0;
     aSerEqui = "";
     nNumEqui = 0;

     aSerAbono = "";
     fSistema = @;
     aSistema = "";
     aAnyo = "";
     &eaFichero = "";
     nSwHayImp = 0;
     aTempo134 = "";
     aTempo918 = "";
     aMarca = "";
     nNumContrato = 0
     nA¤oContrato = 0;
     nMesContrato = 0;
     aSerFactura = "";
     nNumFactura = 0;

     nBotonImp = 0;
     nBotonAbono = 0;

     aDSerie = "";
     aHSerie = "";
     nDNumFac = 0;
     nHNumFac = 0;
     aSerAlbaran = "";
     nNumAlbaran = 0;

     nSwGridCargado = 0;
     aSQL = "";
     aFichSQL = "";
     nBotonLimpia = 0;

     nSwFiltrado = 0;
     nSalida = 0;
     nVentana = 0;
     nPantaFil = 0;
     aUsuario = "";

|| Del borrado

     &PRMNT_enError = 0;
     &enSwNoAcotaFecha = 0;
     &enSwEsAutoFac    = 0;
     &enSwAutoFactura  = 0;
     &qSerie       = "";
     &qAlbar       = 0;
     &qFecha       = @;
     &qAbono       = "";
     &qSufac       = "";
     &eaCalcAF = 0;
     &eaSerProforma = "";
     &enNumProforma = 0;
     &eaSerie116 = "";
     &enFactura116 = 0;
     &efFecha      = @;
     &enMrgKit     = 0;
     &enImpMar     = 0;
     &enImpKit     = 0;
     &enImpRepCom  = 0;
     &enImpRepVta  = 0;
     &enImpRepRete = 0;
     &enImpRepComi = 0;
     &enImpCliPen  = 0;
     &enImpCliCom  = 0;
     &enImpCliDto  = 0;
     &enImpCliMar  = 0;
     &enImpCliFac  = 0;
     &eaCliente    = "";
     &eaRepre      = "";
     &eaModo116 = "";
     &eaTipo116 = "";
     &eaTipoMov = "";
     &eaCli     = "";
     &eaCuenta  = "";
     &eaNombre  = "";
     &eaCif     = "";
     &eaImprime = "";
     &eaImpre   = "";
     &eaSERFAC = "";
     &enNUMFAC = 0;
     &eaSEREXP = "";
     &enNUMEXP = 0;
     &ser_alb  = "";
     &num_alb  = 0;
     &abo_alb  = "";
     &abono    = "";   || Lo utilizo en agifa014
     &fec_alb = @;
     &eaArticulo = "";
     &enImpVta   = 0;
     &enDFuera   = 0;
     &enImporte  = 0;
     &enSwHay    = 0;
     &eaInforme  = "";

     aDescPro  = "";
     nImpo  = 0;
     nDto   = 0;
     FEstado = 0;
     aSerie  = "";
     nContador = 0;
     Comodin1 = "";
     margen = 0;
     nLinMulti    = 1;
     nLinFac      = 0;
     aCodMayo = "";

     nSwBorradoOK = 0;
     imneto  = 0;
     mes     = 0;
     fmes    = " ";
     con     = 0;
     nForma  = 0;
     nModo   = 0;
     aAlfa1  = "";
     fFechaAnt = @;
     aContab = "";
     nSwFlag = 0;
     nSw     = 0;
     &eaProg = "";
     &enErrCarte = 0;
     nSwErr  = 0;
     nSal    = 0;
     nSwHay  = 0;
     primera = 0;
     nInterno = 0;

     nUnitsLCmp = 0;
     nTotalCoste = 0;
     nTotalCosteSI = 0;
     nCalc   = 0;
     nCalc1  = 0;
     aCtaCli = "";
     &eaCta    = "";
     nSwPax = 0;
     nPax = 0;
     aCP = "";
     ||Variables de la cartera
     aPath = ""; aDef00 = ""; aMensa = "";
     Comodin = "";
     aTempo600 = "";
     &aCPath = ""; &aCNome = "";
     &nDeci_PreBaseMx = 0;
     &nDeci_IVA = 0;
     &nDeci_IVAC = 0;
     &nDeci_Div = 0;
     &enErr   = 0;
     &TipoCta = "";
     Divisa = ""; CambioBase = 0; CambioDiv = 0;
     &SPedido = "";
     &NPedido = 0;
     nFlag     = 0;
     nSwError = 0;
     &eaTag = "";

     nSwIva = 0;
     nMayorista = 0;
     nMayoCli = 0;
     &aMayoAnt = "";
     &nPrimero = 0;

     &nAlbVta = 0;
     aArtLinCom = "";
     nImpLinCom = 0;
     &aArtIva = "";
     &nImpSal = 0;
     &nImpEnt = 0;
     &nPre = 0;

     nLineaCom = 0;
     aDirEmp = "";
     aDatos = "";
     &enSwMenu = 0;
     nAlbCompra = 0;
     &aSerMayo = "";
     &cCodMonTrab = "";

     &nDeci_PreDiv = 0;
     nPPort1   = 0;
     nPPort2   = 0;
     &eaDocu   = "";

     &aArtLin = "";
     &nUniLin = 0;
     &nPreLin = 0;

     nImpDiv = 0;
     nMult = 0;
     &enForma = 1;

     aMensaje = "";

     nSwHayCompras = 0;
     nLinea = 0;

     nGastos = 0;
     nTasas = 0;
     nSFcon = 0;
     nSFsin = 0;

     aTempo703 = "";
     &Tempo = "";

     &EURODB  = 0;
     &nDeci_PreDivF = 0;

     &aDivisa = "";
     &aMoneda = "";
     &eaProgVta = "";

|| Mias

     nPanta     = 0;
     nBoton1    = 0;
     nBoton2    = 0;
     nBoton3    = 0;
     nBoton4    = 0;
     nBoton5    = 0;
     nBoton6    = 0;
     nRango     = 0;
     nGrid1     = 0;
     nGrid2     = 0;
     nHandle    = 0;
     nDContrato = 0;
     nHContrato = 0;
     nDMes      = 0;
     nHMes      = 0;
     nDAnyo     = 0;
     nHAnyo     = 0;

     aFichero   = "";
     aFichero1  = "";
     aFichero2  = "";
     aNFicher   = "";
     aBase      = "";
     aMas       = "";
     aEsc1      = "";
     aEsc2      = "";
     aRetu      = "";
     aTecla     = "";
     aPatrones  = "";
     aDir       = "";
     aAlfa      = "";
     aFich      = "";
     aQueQuiero = "";
     aAbre      = "";
     aDFichero  = "";
     aHFichero  = "";
     aOrigen    = "";
     aDestino   = "";
|FIN;

|PROCESO Baja997;
     #997#0 = 0;
     #997#1 = 0;
     #997#2 = 1;
|FPRC;

|PROCESO Alta997;
     #997#0 = 99999999;
     #997#1 = 9999;
     #997#2 = 12;
|FPRC;


|PROCESO vipem017_marca;
     #997#11 = aMarca;
     |GRABA 020#997.a;
|FPRC;

|DEFBUCLE vipem017_marca;
 #997#2002;
 ;
 aSerFactura, nNumFactura;
 aSerFactura, nNumFactura;
 be;
 NULL, vipem017_marca;
|FIN;

|PROCESO Evento997;
     |SI FSalida = 1;  |O FSalida = 2;
          |LEE 000#997c;
     |FINSI;

     |SI FSalida = 4;
          |LEE 000#997c;
          |SI FSalida ! 0; |ACABA; |FINSI;

          ||ARA55
          aSerAlbaran = #997#4;
          nNumAlbaran = #997#5;
          nNumContrato = #997#0;
          nA¤oContrato = #997#1;
          nMesContrato = #997#2;
          aSerFactura = #997#7;
          nNumFactura = #997#8;
          |SI #997#11 = "*";
               aMarca = "";
          |SINO;
               aMarca = "*";
          |FINSI;

          |BUCLE vipem017_marca;


          |SELECT #3#997;
          #997#0 = nNumContrato;
          #997#1 = nA¤oContrato;
          #997#2 = nMesContrato;
          |LEE 000#997.=;
          |PARA; |SI; |HACIENDO;
               |SI FSalida = 0; |Y #997#0 = nNumContrato; |Y #997#1 = nA¤oContrato; |Y #997#2 = nMesContrato;
                    |SI aSerAlbaran = #997#4; |Y nNumAlbaran = #997#5;
                         |SAL;
                         ||OKIE. LO HEMOS ENCONTRADO. ES EN EL QUE ESTABAMOS
                    |SINO;
                         |LEE 000#997.s;
                    |FINSI;
               |SINO;
                    |SAL;
               |FINSI;
          |SIGUE;

          |REFRESCACONTROL nGrid1;
     |FINSI;
|FPRC;

|PROCESO Tipo80;  |TIPO 80;
     FSalida = 3299;
|FPRC;

|PROCESO LimpiaFiltro;
     |DDEFECTO #vipez013;
     #vipez013#0 = aUsuario;
     |PINDA #0#513;
|FPRC;

|PROCESO BorraLin;
     ||No hace nada. Esta aqui, porque existe el proceso en el temporal
|FPRC;

|PROCESO Mete134;
     |DDEFECTO #634;
     #634#0 = #997#7;
     #634#1 = #997#8;
     |LEE 101#634.=;
     |SI FSalida ! 0;
          |GRABA 020#634.n;
     |FINSI;
     |LIBERA #634;
     nSwHayImp = 1;
|FPRC;

|DEFBUCLE Mete134;
 #997#2002;
 11;
 "     ", 000000, "*";
 "zzzzz", 999999, "*";
 ;
 NULL, Mete134;
|FIN;

|PROCESO Imprimir;
     nDeci_PreDivF = 2;

     ||Creo el temporal 134  y luego hago el subejecuta
     ||de la misma forma que esta en el vipem057

     |HAZ CreaTempo; aTempo134 = Tempo; |NOME_DAT #634 aTempo134; |DELINDEX #634;

     |ABRE #634;
     nSwHayImp = 0;
     |BUCLE Mete134;
     |CIERRA #634;

     |SI nSwHayImp = 1;
          eaFichero = aTempo134; |SUB_EJECUTA "agifa136";
     |SINO;
          aMensaje = "0000Seleccione primero las facturas a imprimir";
          |MENAV aMensaje;
     |FINSI;

     |DELINDEX #634; Tempo = aTempo134; |HAZ BoraTempo;
|FPRC;

|PROCESO Filtro;
     nSwFiltrado = 0;

     |VENTANA 0501, 3299, -1, 1, "";
     nVentana = FSalida;

     |PINPA #0#513; nPantaFil = FSalida;

     |CONTROL_SIMPLE nPantaFil, "BOTON,{{199}} Limpia Filtro", 0878, 0896, LimpiaFiltro;
     nBotonLimpia = FSalida;

     |ABRE #vipez013;
     aUsuario = Usuario % 810;
     |QBF aUsuario;
     |DDEFECTO #vipez013;
     #vipez013#0 = aUsuario;
     |LEE 101#vipez013.=;
     nSalida = FSalida;
     |SI nSalida ! 0; |GRABA 020#vipez013.b; |FINSI;
     |PINDA #0#513;

     |ENDATOS #1#vipez013;
     |SI FSalida = 0;
          nSwFiltrado = 1;
          |GRABA 020#vipez013.a;
     |SINO;
          nSwFiltrado = 0;
          |SI nSalida ! 0;
               |BORRA 020#vipez013.a;
          |FINSI;
     |FINSI;
     |LIBERA #vipez013;

     |CIERRA #vipez013;

     |FIN_CONTROL_WINDOWS nBotonLimpia;

     |FINVENTANA nVentana;

     |SI nSwFiltrado = 1;
          |HAZ RefrescaGrid;
     |FINSI;
|FPRC;

|PROCESO RefrescaGrid;
     |SI nSwGridCargado = 1;
          nSwGridCargado = 0;
          |DESTRUYECONTROL nGrid1;
          |ABRE #997;  |CIERRA #997;  |DELINDEX #997;
          |DESCARGA_DEF #ref1z002@;
     |FINSI;

     aFichSQL = aFichero1;

     aSQL = "SELECT * FROM vipem017 INTO " + aFichSQL + ".def WHERE ";
     aSQL = aSQL + "0 BETWEEN " + #vipez013#1 + "," + #vipez013#2;
     aSQL = aSQL + " AND 1 BETWEEN " + #vipez013#3 + "," + #vipez013#4;
     aSQL = aSQL + " AND 2 BETWEEN " + #vipez013#5 + "," + #vipez013#6;
     aSQL = aSQL + " AND 7 BETWEEN " + #vipez013#7 + "," + #vipez013#8;
     aSQL = aSQL + " AND 8 BETWEEN " + #vipez013#9 + "," + #vipez013#10;
     aSQL = aSQL + " AND 9 BETWEEN " + #vipez013#11 + "," + #vipez013#12;
     aSQL = aSQL + " AND 6 BETWEEN " + #vipez013#13 + "," + #vipez013#14;

     |ABRE #vipem017;
     |SQL aSQL;
     |CIERRA #vipem017;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/vipem017.mas";
     |CARGA_DEF aMas, ref1z002@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     nSwGridCargado = 1;

     |NOME_DAT #997 aFichSQL;

     |ABRE #997;

     nRango = 4 + 8 + 16 + 32 + 128;

     |LINEAL_SIMPLE #3#997, nRango, 0702, 3198, Baja997, Alta997, Evento997;
     nGrid1 = FSalida;
|FPRC;

|PROCESO BuscaEnEquivalencia;
     |DDEFECTO #918;
     #918#0 = aSerAlbaran;
     #918#1 = nNumAlbaran;
     |LEE 000#918.=;
     |SI FSalida = 0;
          aSerEqui = #918#2;
          nNumEqui = #918#3;
          nSwEstaEqui = 1;
     |FINSI;

     ||OUT
     ||aSerEqui
     ||nNumEqui
     ||nSwEstaEqui
|FPRC;

|PROCESO ClonaAbonoAlbaran;
     ||TODO CCC

     |DDEFECTO #agifa010;
     #agifa010#52 = #agifa059#15;
     #agifa010#0 = #agifa059#2;
     |LEE 000#agifa010.=;
     |SI FSalida = 0;

          nUltAbonoAlb = nUltAbonoAlb + 1;

          nVoyPor = 0;
          |PARA; |SI; |HACIENDO;
               nVoyPor = nVoyPor + 1;
               |DDEFECTO #agifa071;
               #agifa071#29 = #agifa059#15;
               #agifa071#0 = #agifa059#2;
               #agifa071#1 = nVoyPor;
               |LEE 000#agifa071.];
               |SI FSalida = 0; |Y #agifa071#29 = #agifa059#15; |Y #agifa071#0 = #agifa059#2;
                    #agifa071#29 = aSerAbono;
                    #agifa071#0 = nUltAbonoAlb;
                    nVoyPor = #agifa071#1;

                    #agifa071#5 = #agifa071#5 * -1;
                    #agifa071#7 = #agifa071#7 * -1;
                    #agifa071#9 = #agifa071#9 * -1;
                    #agifa071#14 = #agifa071#14 * -1;
                    #agifa071#23 = #agifa071#23 * -1;
                    #agifa071#24 = #agifa071#24 * -1;
                    #agifa071#25 = #agifa071#25 * -1;
                    #agifa071#26 = nUltAbonoFac;
                    #agifa071#30 = aSerAbono;
                    #agifa071#35 = #agifa071#35 * -1;
                    #agifa071#37 = #agifa071#37 * -1;
                    #agifa071#39 = #agifa071#39 * -1;
                    #agifa071#41 = #agifa071#41 * -1;
                    #agifa071#42 = #agifa071#42 * -1;
                    #agifa071#44 = #agifa071#44 * -1;
                    #agifa071#45 = #agifa071#45 * -1;
                    #agifa071#46 = #agifa071#46 * -1;
                    #agifa071#62 = #agifa071#62 * -1;
                    #agifa071#64 = #agifa071#64 * -1;
                    #agifa071#65 = #agifa071#65 * -1;
                    #agifa071#66 = #agifa071#66 * -1;
                    |GRABA 020#agifa071.n;
                    |LIBERA #agifa071;
               |SINO;
                    |SAL;
               |FINSI;
          |SIGUE;

          ||Cabecera Albaran
          ||TODO CCC
          #agifa010#52 = aSerAbono;
          #agifa010#0 = nUltAbonoAlb;
          #agifa010#1 = ~;
          #agifa010#2 = #agifa010#2 * -1;
          #agifa010#11 = #agifa010#11 * -1;
          #agifa010#13 = #agifa010#13 * -1;

          |PARA nCont = 15; |SI nCont [ 26; |HACIENDO nCont = nCont + 1;
               #agifa010#nCont# = #agifa010#nCont# * -1;
          |SIGUE;
          #agifa010#28 = #agifa010#28 * -1;
          #agifa010#37 = #agifa010#37 * -1;
          #agifa010#39 = nUltAbonoFac;
          |PARA nCont = 44; |SI nCont [ 49; |HACIENDO nCont = nCont + 1;
               #agifa010#nCont# = #agifa010#nCont# * -1;
          |SIGUE;
          #agifa010#53 = aSerAbono;
          #agifa010#54 = #agifa010#54 * -1;
          #agifa010#60 = ~;
          #agifa010#67 = #agifa010#67 * -1;
          |PARA nCont = 75; |SI nCont [ 82; |HACIENDO nCont = nCont + 1;
               #agifa010#nCont# = #agifa010#nCont# * -1;
          |SIGUE;
          |GRABA 020#agifa010.n;
          |LIBERA #agifa010;

          |ABRE #agifa027;
          |DDEFECTO #agifa027;
          #agifa027#2 = aSerAbono;
          #agifa027#0 = "valbaran";
          |LEE 101#agifa027.=;
          |SI FSalida ! 0; |GRABA 020#agifa027.b; |FINSI;
          nAux = nUltAbonoAlb + 1;
          #agifa027#1 = nAux;
          |GRABA 020#agifa027.a;
          |LIBERA #agifa027;
          |CIERRA #agifa027;

          ||Temporal Equivalencias
          |DDEFECTO #918;
          #918#0 = #agifa059#15;
          #918#1 = #agifa059#2;
          |LEE 101#918.=;
          |SI FSalida ! 0;
               #918#2 = aSerAbono;
               #918#3 = nUltAbonoAlb;
               #918#4 = aSerAbono;
               #918#5 = nUltAbonoFac;
               |GRABA 020#918.n;
          |FINSI;
          |LIBERA #918;
     |FINSI;
|FPRC;

|PROCESO agifa059_albaranes;
     |HAZ ClonaAbonoAlbaran;
|FPRC;

|DEFBUCLE agifa059_albaranes;
 #agifa059#1;
 ;
 aSerFactura, nNumFactura,   1;
 aSerFactura, nNumFactura, 999;
 ;
 NULL, agifa059_albaranes;
|FIN;

|PROCESO Abono;
     |ABRET #agifa134;
     |ABRET #agifa059;
     |ABRET #agifa010;
     |ABRET #agifa071;

     |SI nUltAbonoFac = 0;

          |DDEFECTO #agifa134;
          #agifa134#49 = aSerAbono;
          #agifa134#0 = 999999;
          |LEE 000#agifa134.];
          |SI FSalida = 0;
               |LEE 000#agifa134.a;
          |SINO;
               |LEE 000#agifa134.u;
          |FINSI;
          |SI FSalida = 0; |Y #agifa134#49 = aSerAbono;
               nUltAbonoFac = #agifa134#0;
          |SINO;
               nUltAbonoFac = 0;
          |FINSI;
     |FINSI;

     |SI nUltAbonoAlb = 0;
          |DDEFECTO #agifa010;
          #agifa010#52 = aSerAbono;
          #agifa010#0 = 999999;
          |LEE 000#agifa010.];
          |SI FSalida = 0;
               |LEE 000#agifa010.a;
          |SINO;
               |LEE 000#agifa010.u;
          |FINSI;
          |SI FSalida = 0; |Y #agifa010#52 = aSerAbono;
               nUltAbonoAlb = #agifa010#0;
          |SINO;
               nUltAbonoAlb = 0;
          |FINSI;
     |FINSI;

     ||ARA55
     ||1ero.
     ||Miro si existe la factura

     ||Si existe .. la factura
     #agifa134#49 = aSerFactura;
     #agifa134#0 = nNumFactura;
     |LEE 000#agifa134.=;
     |SI FSalida = 0;

          nUltAbonoFac = nUltAbonoFac + 1;

/*
          #agifa134#49 = nUltAbonoFac;
          #agifa134#0 = aSerAbono;
          |LEE 101#agifa134.=;
          |SI FSalida ! 0; |GRABA 020#agifa134.b; |FINSI;
*/

          ||recorro la lineas de la factura, para averiguar los albaranes.
          ||Clono los albaranes. Haciendo Abonos.
          ||Grabo el temporal
          |BUCLE agifa059_albaranes;

||          |LIBERA #agifa134;

          ||Ahora desbloqueo la factura abono. Por ahora NO bloqueo la factura
          ||Y clono la factura.

          nVoyPor = 0;
          |PARA; |SI; |HACIENDO;
               nVoyPor = nVoyPor + 1;
               |DDEFECTO #agifa059;
               #agifa059#14 = aSerFactura;
               #agifa059#0 = nNumFactura;
               #agifa059#1 = nVoyPor;
               |LEE 000#agifa059.];
               |SI FSalida = 0; |Y #agifa059#14 = aSerFactura; |Y #agifa059#0 = nNumFactura;
                    #agifa059#14 = aSerAbono;
                    #agifa059#0 = nUltAbonoFac;
                    nVoyPor = #agifa059#1;

                    #agifa059#3 = #agifa059#3 * -1;
                    #agifa059#4 = #agifa059#4 * -1;
                    #agifa059#5 = #agifa059#5 * -1;
                    #agifa059#6 = #agifa059#6 * -1;
                    #agifa059#7 = #agifa059#7 * -1;
                    #agifa059#8 = #agifa059#8 * -1;
                    #agifa059#9 = #agifa059#9 * -1;
                    #agifa059#10 = #agifa059#10 * -1;
                    #agifa059#11 = #agifa059#11 * -1;
                    #agifa059#12 = #agifa059#12 * -1;
                    #agifa059#13 = #agifa059#13 * -1;

                    |DDEFECTO #918;
                    #918#0 = #agifa059#15;
                    #918#1 = #agifa059#2;
                    |LEE 000#918.=;
                    |SI FSalida = 0;
                         #agifa059#2 = #918#3;
                         #agifa059#15 = #918#2;
                    |FINSI;
                    #agifa059#16 = #agifa059#16 * -1;
                    #agifa059#17 = #agifa059#17 * -1;
                    #agifa059#21 = #agifa059#21 * -1;
                    #agifa059#22 = #agifa059#22 * -1;
                    #agifa059#23 = #agifa059#23 * -1;
                    #agifa059#24 = #agifa059#24 * -1;
                    #agifa059#25 = #agifa059#25 * -1;
                    #agifa059#26 = #agifa059#26 * -1;
                    #agifa059#27 = #agifa059#27 * -1;
                    #agifa059#28 = #agifa059#28 * -1;
                    #agifa059#29 = #agifa059#29 * -1;
                    #agifa059#30 = #agifa059#30 * -1;
                    #agifa059#31 = #agifa059#31 * -1;
                    #agifa059#32 = #agifa059#32 * -1;
                    #agifa059#33 = #agifa059#33 * -1;
                    #agifa059#34 = #agifa059#34 * -1;
                    #agifa059#35 = #agifa059#35 * -1;
                    #agifa059#36 = #agifa059#36 * -1;
                    #agifa059#37 = #agifa059#37 * -1;
                    #agifa059#38 = #agifa059#38 * -1;
                    |GRABA 020#agifa059.n;
                    |LIBERA #agifa059;
               |SINO;
                    |SAL;
               |FINSI;
          |SIGUE;
          #agifa134#49 = aSerFactura;
          #agifa134#0 = nNumFactura;
          |LEE 000#agifa134.=;
          |SI FSalida = 0;
               #agifa134#49 = aSerAbono;
               #agifa134#0 = nUltAbonoFac;
               #agifa134#1 = ~;
               #agifa134#8 = #agifa134#8 * -1;
               #agifa134#17 = #agifa134#17 * -1;
               #agifa134#18 = #agifa134#18 * -1;
               #agifa134#19 = #agifa134#19 * -1;

               |PARA nCont = 20; |SI nCont [ 38; |HACIENDO nCont = nCont + 1;
                    #agifa134#nCont# = #agifa134#nCont# * -1;
               |SIGUE;
               #agifa134#46 = #agifa134#46 * -1;
               #agifa134#47 = #agifa134#47 * -1;
               #agifa134#54 = #agifa134#54 * -1;
               #agifa134#55 = #agifa134#55 * -1;
               |PARA nCont = 64; |SI nCont [ 111; |HACIENDO nCont = nCont + 1;
                    #agifa134#nCont# = #agifa134#nCont# * -1;
               |SIGUE;
               |PARA nCont = 119; |SI nCont [ 123; |HACIENDO nCont = nCont + 1;
                    #agifa134#nCont# = #agifa134#nCont# * -1;
               |SIGUE;
               |GRABA 020#agifa134.n;
               |LIBERA #agifa134;

               |ABRE #agifa027;
               |DDEFECTO #agifa027;
               #agifa027#2 = aSerAbono;
               #agifa027#0 = "vfactura";
               |LEE 101#agifa027.=;
               |SI FSalida ! 0; |GRABA 020#agifa027.b; |FINSI;
               nAux = nUltAbonoFac + 1;
               #agifa027#1 = nAux;
               |GRABA 020#agifa027.a;
               |LIBERA #agifa027;
               |CIERRA #agifa027;

               aMensaje = "0000Generada Factura Abono [" + aSerAbono + "/" + nUltAbonoFac + "]";
               |MENAV aMensaje;
          |FINSI;
     |FINSI;

     |CIERRAT #agifa134;
     |CIERRAT #agifa059;
     |CIERRAT #agifa010;
     |CIERRAT #agifa071;
|FPRC;

|PROCESO vipem017_abono;
     ||No esta abonada ni es un abono.

     |SI #997#13 = "N"; |Y #997#14 = "N"
          ||ARA55
          aSerAlbaran = #997#4;
          nNumAlbaran = #997#5;
          nNumContrato = #997#0;
          nA¤oContrato = #997#1;
          nMesContrato = #997#2;
          aSerFactura = #997#7;
          nNumFactura = #997#8;

          |SI aSerFactura ! aSerAnterior; |Y nNumFactura ! nNumAnterior;
               nSwEstaEqui = 0;
               aSerEqui = "";
               nNumEqui = 0;
               |HAZ BuscaEnEquivalencia;
               |SI nSwEstaEqui = 1;
                    #997#13 = "S";
                    #997#15 = aSerEqui;
                    #997#16 = nNumEqui;
               |SINO;
                    |HAZ Abono;
               |FINSI;
          |FINSI;
          aSerAnterior = aSerFactura;
          nNumAnterior = nNumFactura;
     |FINSI;

     #997#11 = "";
     |GRABA 020#997.a;
|FPRC;

|DEFBUCLE vipem017_abono;
 #997#2002;
 11;
 "     ", 000000, "*";
 "zzzzz", 999999, "*";
 be;
 NULL, vipem017_abono;
|FIN;

|PROCESO HayMarcas;
     |SI #997#13 = "N"; |Y #997#13 = "N";
          nSwHayMarca = 1;
     |FINSI;
|FPRC;

|DEFBUCLE HayMarcas;
 #997#2002;
 11;
 "     ", 000000, "*";
 "zzzzz", 999999, "*";
 ;
 NULL, HayMarcas;
|FIN;

|PROCESO vipew018;
     ||TODO CCC
     #vipem017#4 = #vipew018#0;
     #vipem017#5 = #vipew018#1;
     |LEE 101#vipem017.=;
     |SI FSalida = 0;
          #vipem017#13 = "S";
          #vipem017#15 = #vipew018#2;
          #vipem017#16 = #vipew018#3;
          |GRABA 020#vipem017.a;
          |LIBERA #vipem017;
     |FINSI;

     #vipem017#4 = #vipew018#0;
     #vipem017#5 = #vipew018#1;
     |LEE 000#vipem017.=;
     |SI FSalida = 0;
          #vipem017#4 = #vipew018#2;
          #vipem017#5 = #vipew018#3;
          #vipem017#6 = ~;
          #vipem017#7 = #vipew018#4;
          #vipem017#8 = #vipew018#5;
          #vipem017#11 = "";
          #vipem017#13 = "N";
          #vipem017#14 = "S";
          #vipem017#15 = #vipew018#0;
          #vipem017#16 = #vipew018#1;
          |GRABA 020#vipem017.n;
          |LIBERA #vipem017;
     |FINSI;
|FPRC;

|DEFBUCLE vipew018;
 #vipew018#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, vipew018;
|FIN;

|PROCESO ActualizaAbonos;
     |ABRE #vipem017;
     |BUCLE vipew018;
     |CIERRA #vipem017;
|FPRC;

|PROCESO AbonoFactura;
     nSwHayMarca = 0;
     |BUCLE HayMarcas;
     |SI nSwHayMarca = 0;
          aMensaje = "0000Seleccione primero las facturas a abonar";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     nUltAbonoFac = 0;
     nUltAbonoAlb = 0;

     |ABRE #vipem008;
     |LEE 000#vipem008.p;
     |SI FSalida ! 0; |DDEFECTO #vipem008; |FINSI;

     aSerAbono = #vipem008#19;
     |QBF aSerAbono;
     |SI aSerAbono = "";
          |CIERRA #vipem008;
          aMensaje = "0000Error: Ho esta definida la Serie de Abonos en Parametros";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     fSistema = ~;
     aSistema = fSistema;
     aAnyo = aSistema % -102;
     aSerAbono = aSerAbono + aAnyo;
     aSerAbono = (aSerAbono + "     ") % 105;

     |CIERRA #vipem008;

     ||ARA55
     |HAZ CreaTempo; aTempo918 = Tempo; |NOME_DAT #918 aTempo918; |DELINDEX #918;

     |ABRE #918;
     aSerAnterior = "xxxxx";
     nNumAnterior = -1;
     |BUCLE vipem017_abono;

     |HAZ ActualizaAbonos;

     |CIERRA #918;
     |DELINDEX #918; Tempo = aTempo918; |HAZ BoraTempo;

     |SI nSwFiltrado = 1;
          |HAZ RefrescaGrid;
     |SINO;
          |REFRESCACONTROL nGrid1;
     |FINSI;

     |PTEC 806;
|FPRC;

|PROGRAMA;
     |CLS;
     |CABEZA "Borrado";

     |PINPA #0#0;  nPanta = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,Filtro Facturas", 0678, 0698, Filtro;
     nBoton6 = FSalida;

     |CONTROL_SIMPLE nPantaFil, "BOTON,{{205}}Imprimir", 3078, 3096, Imprimir;
     nBotonImp = FSalida;

     |CONTROL_SIMPLE nPantaFil, "BOTON,{{193}}Abono Factura", 3003, 3021, AbonoFactura;
     nBotonAbono = FSalida;


     |ESTADO_CONTROL nBoton5, "DISABLE";
     |ESTADO_CONTROL nBoton6, "ENABLE";

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/vipem017.mas";
     |CARGA_DEF aMas, ref1z002@;

     aFichero1 = ("sq3" + Usuario + "zzzzzzzz") % 108;

     |NOME_DAT #997 aFichero1;

     |ABRE #997;  |CIERRA #997;  |DELINDEX #997;

     |DFICE aFich;  |QBF aFich;
     aOrigen  = aFich + "vipem017.dat";
     aDestino = aFich + aFichero1 + ".dat";
     |COPIA_FICHERO aOrigen, aDestino;

     |ABRE #997;

     nRango = 4 + 8 + 16 + 32 + 128;


     |C_M #997#11, 1, "S";
     |C_V #997#11, 1, "S";
     |PINTA #997#11;

     |LINEAL_SIMPLE #3#997, nRango, 0702, 3198, Baja997, Alta997, Evento997;
     nGrid1 = FSalida;
     nSwGridCargado = 1;

     |FOCOTECLADO nGrid1;

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::{{001}}Salir," + nGrid1;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
         |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;

     |CIERRA #997;

     |DELINDEX #997;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton4;
     |FIN_CONTROL_WINDOWS nBoton5;
     |FIN_CONTROL_WINDOWS nBoton6;
     |FIN_CONTROL_WINDOWS nBotonImp;
     |FIN_CONTROL_WINDOWS nBotonAbono;

     |DESCARGA_DEF #ref1z002@;
|FPRO;
