|FICHEROS;
     dsy00006 #0;        || este def
     agifa071 #2;        || albaranes venta (L)
     agifa010 #3;        || albaranes venta (C)
     agifa024 #4;        || clientes
     agifa084 #5;        || facturas contado (C)
     agifa069 #6;        || facturas contado (L)
     dsw00042 #99;       || temporal de impresion
|FIN;

|VARIABLES;
     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;
     &nDeci_IVA = 0;
     nDto1 = 0;
     nDto2 = 0;
     nDto3 = 0;
     nBase = 0;
     nBruto = 0;
     nIva = 0;
     nRec = 0;
     nDto = 0;
     &eaArticulo = "";
     &aDivisa  = "";
     &aMoneda  = "";
     aAlfa     = "";
     nHapasado = 0;
|FIN;

|PROCESO agifa071;                 || para cada linea de albaran de venta
     |SI #2#2 ] #0#4; |Y #2#2 [ #0#5; |Y #2#13 ] #0#6; |Y #2#13 [ #0#7;
          nHapasado = 1;
          |DDEFECTO #99;
          #99#0 = #3#3;                || cod cliente
          |LEE 101#99=;
          |SI FSalida ! 0; |GRABA 020#99b; |FINSI;
          |SI #3#43 = "N";              || es un abono
               #99#3 = #99#3 + #2#5;    || acumula unidades
          |SINO;
               #99#3 = #99#3 - #2#5;    || es un abono
          |FINSI;

          enTiva = #2#11;
          efFiva = #3#1;
          |HAZ SacaIVA;

          |SI #4#47 = "N"; enRec = 0; |FINSI;

          nBruto = #2#9;
          nDto1 = (nBruto % #3#5) ! nDeci_IVA;
          nBruto = nBruto - nDto1;
          nDto2 = (nBruto % #3#32) ! nDeci_IVA;
          nBruto = nBruto - nDto2;
          nDto3 = (nBruto % #3#7) ! nDeci_IVA;
          nBruto = nBruto - nDto3;
          nDto = nDto1 + nDto2 + nDto3;
          nBruto = #2#9;
          nBase = nBruto - nDto;

          nIva = (nBase % enIva) ! nDeci_IVA;
          nRec = (nBase % enRec) ! nDeci_IVA;

          #99#5 = #99#5 + nBase;          || bases
          #99#6 = #99#6 + nIva;           || Iva
          #99#7 = #99#7 + nRec;           || RE
          #99#9 = #99#9 + nBruto;          || total bruto
          #99#10 = #99#10 +  nDto;         || total descuento
          #99#8 = #99#8 + (nBase + nIva + nRec)   || total

          #99#11 = #99#11 + #2#14;          || coste
          #99#12 = #99#12 + (#2#9 - #2#14); || beneficio

          |GRABA 020#99a;
          |LIBERA #99;
     |FINSI;
|FPRC;

|PROCESO agifa_010;
     |DDEFECTO #4;
     #4#0 = #3#3;
     |LEE 000#4=;
     |SI FSalida ! 0; |DDEFECTO #4; |FINSI;

     aDivisa = #3#68;
     aMoneda = #3#70;
     |HAZ Divisas010;
     nHapasado = 0;
     |BUCLELIN 0agifa071#3;   || voy a leer albaran venta lineas
     |SI nHapasado = 1;

          |DDEFECTO #99;
          #99#0 = #3#3;  || cod cliente
          |LEE 110#99=;
          |SI FSalida = 0;
               #99#2 = #4#6;
               |SI #0#8 = "F";
                    #99#1 = #4#1;
               |SINO;
                    #99#1 = #4#2;
               |FINSI;
               #99#4 = #99#4 + #3#81;   || acumula portes
/*
               #99#5 = #99#5 + #3#16 + #3#19 + #3#22 + #3#44 + #3#47 + #3#28;  || bases
               #99#6 = #99#6 + #3#24;
               #99#7 = #99#7 + #3#18 + #3#21 + #3#54 + #3#46 + #3#49;  || RE
               #99#9 = #99#9 + #3#15;   || total bruto
               #99#10 = #99#10 + #3#25; || total descuento
               #99#8 = #99#8 + #3#78;   || total
*/
               |GRABA 020#99a;
          |FINSI;
          |LIBERA #99;
     |FINSI;
|FPRC;

|DEFBUCLE agifa_010;
     #3#1;
     1,3;
     "     ",000001,#0#2,#0#0;
     "zzzzz",999999,#0#3,#0#1;
     be;
     NULL,agifa_010;
|FIN;

|PROCESO agifa069;                 || para cada linea de factura contado
     |SI #6#2 ] #0#4; |Y #6#2 [ #0#5; |Y #6#13 ] #0#6; |Y #6#13 [ #0#7;
          nHapasado = 1;
          |DDEFECTO #99;
          #99#0 = #5#3;                || cod cliente
          |LEE 101#99=;
          |SI FSalida ! 0; |GRABA 020#99b; |FINSI;

          #99#3 = #99#3 + #6#5;    || acumula unidades

          enTiva = #6#11;
          efFiva = #5#1;
          |HAZ SacaIVA;

          |SI #4#47 = "N"; enRec = 0; |FINSI;

          nBruto = #6#9;
          nDto1 = (nBruto % #5#5) ! nDeci_IVA;
          nBruto = nBruto - nDto1;
          nDto2 = (nBruto % #5#32) ! nDeci_IVA;
          nBruto = nBruto - nDto2;
          nDto3 = (nBruto % #5#7) ! nDeci_IVA;
          nBruto = nBruto - nDto3;
          nDto = nDto1 + nDto2 + nDto3;
          nBruto = #6#9;
          nBase = nBruto - nDto;

          nIva = (nBase % enIva) ! nDeci_IVA;
          nRec = (nBase % enRec) ! nDeci_IVA;

          #99#5 = #99#5 + nBase;          || bases
          #99#6 = #99#6 + nIva + nRec;    || Iva
          #99#7 = #99#7 + nRec;           || RE
          #99#9 = #99#9 + nBruto;          || total bruto
          #99#10 = #99#10 +  nDto;         || total descuento
          #99#8 = #99#8 + (nBase + nIva + nRec)   || total

          #99#11 = #99#11 + #6#14;          || coste
          #99#12 = #99#12 + (#6#9 - #6#14); || beneficio

          |GRABA 020#99a;
          |LIBERA #99;
     |FINSI;
|FPRC;

|PROCESO agifa_084;       || cabecera de factura contado
     |DDEFECTO #4;
     #4#0 = #5#3;
     |LEE 000#4=;
     |SI FSalida ! 0; |DDEFECTO #4; |FINSI;

     aDivisa = #5#65;
     aMoneda = #5#67;
     |HAZ Divisas084;
     nHapasado = 0;
     |BUCLELIN 0agifa069#5;
     |SI nHapasado = 1;

          |DDEFECTO #99;
          #99#0 = #5#3;  || cod cliente
          |LEE 110#99=;
          |SI FSalida = 0;
               #99#2 = #4#6;
               |SI #0#8 = "F";
                    #99#1 = #4#1;
               |SINO;
                    #99#1 = #4#2;
               |FINSI;
               #99#4 = #99#4 + #5#11;   || acumula portes
/*
               #99#5 = #99#5 + #5#16 + #5#19 + #5#22 + #5#42 + #5#45 + #5#28;  || bases
               #99#6 = #99#6 + #5#24;
               #99#7 = #99#7 + #5#18 + #5#21 + #5#49 + #5#44 + #5#47; || RE
               #99#9 = #99#9 + #5#15;
               #99#10 = #99#10 + #5#25;
               #99#8 = #99#8 + #5#73;  || total
*/
               |GRABA 020#99a;
          |FINSI;
          |LIBERA #99;
     |FINSI;
|FPRC;

|DEFBUCLE agifa_084;      || bucle de lectura factura contado (C)
     #5#3;
     ;
     #0#0, #0#2, "     ", 000001;
     #0#1, #0#3, "zzzzz", 999999;
     be;
     NULL,agifa_084;
|FIN;


|PROCESO Imprimir;
     |PRINT;
|FPRC;

|DEFBUCLE Imprimir;
     #99#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Imprimir;
|FIN;

|PROCESO Inicio;    |TIPO 3;
     aAlfa = Usuario % 108;
     |QBF aAlfa;
     |NOME_DAT #99 aAlfa;
     |DELINDEX #99;
     |ABRE #99;
     |ABRE #4;
     |BUCLE agifa_010;         || leer albaran venta cabecera
     |BUCLE agifa_084;         || leer facturas contado
     |IMPRE 0;
     |SI FSalida = 0;
         |SI #0#9 = "S";
               |INFOR "dsy000b6";
         |SINO;
               |INFOR "dsy00006";
         |FINSI;
         |SI FSalida = 0;
              |BUCLE Imprimir;         || imprime el informe
              |PIEINF;
              |FININF;
         |FINSI;
         |FINIMP;
     |FINSI;
     |CIERRA #99;
     |DELINDEX #99;
     |CIERRA #4;
|FPRC;

|PROCESO Llena006; |TIPO 6;
     eaArticulo = #0Campo;
     |HAZ LlenaArticulo;
     |SI FSalida = 0;
          #0Campo = eaArticulo;
          |PINTA #0Campo;
     |SINO;
          |ERROR; |ACABA;
     |FINSI;
|FPRC;
