|FICHEROS;
     ortsz003 #0;
     ortsm002 #2;
     ortsm003 #3;
     ortsm004 #4;

     agifa104 #104;
     agifa073 #73;
     agifa019 #19;
     agifa007 #7;
     agifa010 #10;
     agifa071 #71;
     agifa024 #24;
     agifa025 #25;
     dsm00020 #20;
     agifa321 #321;
     agifa324 #324;
     agifa142 #142;
     dsm00053 #53;
|FIN;

|VARIABLES;
     &enMargen = 0;
     &aDivisa  = "";
     &aMoneda  = "";
     &enSwMenu = 0;
     aAlfa     = "";
     aSerAlb   = "";
     nNumAlb   = 0;
     nImpDiv   = 0;
     nImpo     = 0;
     nPendiente= 0;
     nMult     = 0;
     aSerie    = "";
     aDesglo   = "";
     aDespreciar = "";
     nNume     = 0;
     fmes      = "";
     mes       = 0;
     nLin      = 0;
     aCli      = "";
     aRep      = "";
     aFp       = "";
     nDt1      = 0;
     nDt2      = 0;
     nDt3      = 0;
|FIN;

|INCLUYE i_varart;

|PROCESO CreaCab;
     aSerAlb = #0#4;

     |ABRE #24;
     #24#0 = #104#4;
     |LEE 020#24=;
     |CIERRA #24;

     |ABRE #25;
     #25#0 = #24#25;
     |LEE 000#25=;
     |CIERRA #25;

     |ABRE #20;
     #20#0 = #24#202;
     |LEE 000#20=;
     |CIERRA #20;

     #10#52 = aSerAlb;
     enSwMenu = 1;
     |HAZ ContaAV7;
     nNumAlb = #10#0;

     #10#3 = #24#0;
     #10#4 = #24#2;
     #10#5 = #24#37;
     #10#6 = #25#0;
     #10#7 = #24#38;
     #10#8 = #24#20;
     #10#9 = #20#1;
     #10#29 = #24#2;
     #10#30 = #24#5;
     #10#31 = #24#6;
     #10#32 = #24#156;
     #10#33 = #24#7;
     #10#34 = #25#7;
     #10#35 = #24#4;
     #10#36 = #24#47;
     #10#40 = #24#41;
     #10#50 = #24#40;
     #10#51 = #7#28;
     #10#62 = #24#180;
     #10#63 = #24#15;

     |ABRE #321; |LEE 000#321p; |CIERRA #321;
     |ABRE #324;

     #10#68 = #24#192; ||Div
     #324#0 = #24#192;
     |LEE 000#324=;
     #10#69 = #324#2;  ||Cambio

     #10#70 = #24#193; ||Mone Tra

     #10#73 = #321#9;  ||Mone Base
     #324#0 = #321#9;
     |LEE 000#324=;
     #10#74 = #324#2;  ||Cambio Base

     |CIERRA #324;
     #10#88 = #20#0;

     |GRABA 020#10b;

     aDivisa = #10#68;
     aMoneda = #10#70;
     |HAZ Divisas010;
|FPRC;

|PROCESO ActCliente;
     |ABRE #19;
     #19#0 = #71#2;
     |LEE 020#19=;
     |CIERRA #19;

     |ABRE #24;
     #24#0 = #71#15;
     |LEE 121#24=;
     |SI 0 = FSalida;
          |SI #19#194 = 2;
               nImpo = (((((#71#48 * #71#6) < #71#8) < #71#33) < #10#5) < #10#32);
          |SINO;
               nImpo = (((((#71#5 * #71#6) < #71#8) < #71#33) < #10#5) < #10#32);
          |FINSI;
          |SI #142#115 = "S";
               nImpo = nImpo < #10#7;
          |FINSI;
          fmes = #10#1 % A402;
          mes = fmes - 1;
          mes = mes * 3;
          mes = mes + 114;
          |SI #10#43 = "S";
               #24mes  = #24mes   - nImpo;     || ABONO.
               #24#150 = #24#150  - nImpo;
          |SINO;
               #24mes  = #24mes   + nImpo;     || VENTA.
               #24#150 = #24#150  + nImpo;
          |FINSI;
          |GRABA 020#24a;
     |FINSI;
     |CIERRA #24;
|FPRC;
/*
|PROCESO TotalLin73;
     |ABRE #19;
     #19#0 = #73#2;
     |LEE 020#19=;
     |CIERRA #19;

     |SI #104#37 = "D";                    || Si la moneda de trabajo es la divisa ...
          #73#6  = #73#38 / #104#36 * #104#41;  || ... recalculo precio en funcion de la divisa
          #73#40 = #73#6;                  || ... el campo visualiz. es el precio en moneda base
     |SINO;
          #73#38 = #73#6 / #104#41 * #104#36;  || .. recalculo precio en funcion de la moneda base
          #73#40 = #73#38;                 || ... el campo visual. es el precio en divisa
     |FINSI;

     |SI #19#194 = 2;                     || Unidades de facturacion
          nImpo = #73#44 * #73#6;
     |SINO;
          nImpo = #73#5 * #73#6;
     |FINSI;

     || nMult corrige el error del redondeo para negativos
     |SI nImpo < 0; nMult = -1; |SINO; nMult = 1; |FINSI;

     |SI #19#194 = 2;                     || Unidades de facturacion
          #73#7    = (#73#44 * #73#6)  * nMult;
          nImpDiv = (#73#44 * #73#38) * nMult;
          #73#11 = (#73#44 - #73#49) * #73#6 * nMult;
     |SINO;
          #73#7    = (#73#5 * #73#6)  * nMult;
          nImpDiv = (#73#5 * #73#38) * nMult;
          #73#11   = (#73#5 - #73#43) * #73#6 * nMult;
     |FINSI;

     #73#9  = ((((#73#7 < #73#8) < #73#29) < #104#5) < #104#17) < #104#6;
     #73#39 = ((((nImpDiv < #73#8) < #73#29) < #104#5) < #104#17) < #104#6;

     #73#11 = ((((#73#11 < #73#8) < #73#29) < #104#5) < #104#17) < #104#6;

     #73#7  = #73#7  * nMult;
     #73#11 = #73#11 * nMult;
     #73#9  = #73#9  * nMult;
     #73#39 = #73#39 * nMult;

     |SI #104#37 = "D";     || Si la moneda de trabajo es la divisa ...
          #73#41 = #73#9;   || el campo visualiz. es el importe en moneda base
     |SINO;               || Si la moneda de trabajo es la moneda base ...
          #73#41 = #73#39;  || el campo visualiz. es el importe en divisa
     |FINSI;
|FPRC;
*/
|PROCESO ActPedido;
     aDivisa = #104#35;
     aMoneda = #104#37;
     |HAZ Divisas104;

     aDespreciar = "N";
     #73#28 = #104#25;
     #73#0 = #104#0;
     #73#1 = #3#8;
     |LEE 121#73=;
     |SI FSalida = 0;
          nPendiente = #73#5 - #73#43;
          #73#43 = #73#43 + #3#11;             ||Servi
          |SI #73#43 > #73#42;                ||Servi>Pedidas
               #73#5 = #73#43;                ||Uni=Servi
               #73#12 = #73#43 - #73#42;      ||Variacion
          |SINO;
               |SI #3#5 = "S";                ||Despreciar
                    #73#5 = #73#43;           ||Uni=Servi
                    #73#12 = #73#43 - #73#42; ||Varia
               |FINSI;
          |FINSI;
          |HAZ TotalLin73;
          |GRABA 020#73a;
          |LIBERA #73;
     |FINSI;
     |HAZ CalCabAgifa104;

     eaSeriePedido = #agifa073#28;
     enCodigPedido = #agifa073#0;
     enLineaPedido = #agifa073#1;
     eaSerie = #agifa071#29;
     enCodigo = #agifa071#0;
     enLinea = #agifa071#1;
     |SUB_EJECUTA_NP "dsz99905;ADJPED";
|FPRC;
/*
|PROCESO TotalLin71;
     |ABRE #19;
     #19#0 = #71#2;
     |LEE 020#19=;
     |CIERRA #19;

     |SI #10#70 = "D";                    || Si mon. de trabajo es divisa ...
          #71#6  = #71#36 / #10#69 * #10#74; || Recalculo precio en mon. base
          #71#38 = #71#6;                  || Precio visual, en mon. base
     |SINO;                              || Si mon. de trabajo es mon. base
          #71#36 = #71#6 / #10#74 * #10#69;  || Recalculo precio en divisa
          #71#38 = #71#36;                 || Precio visual, en divisa
     |FINSI;

     |SI #19#194 = 2;
         #71#7    = #71#48 * #71#6;
         nImpDiv = #71#48 * #71#36;
     |SINO;
          #71#7    = #71#5 * #71#6;
          nImpDiv = #71#5 * #71#36;
     |FINSI;

     || nMult corrige el error del redondeo para negativos
     |SI #71#7 < 0; nMult = -1; |SINO; nMult = 1; |FINSI;
     #71#7    = #71#7    * nMult;
     nImpDiv = nImpDiv * nMult;

     #71#9  = (((#71#7 < #71#8) < #71#33));
     #71#37 = (((nImpDiv < #71#8) < #71#33));

     #71#7  = #71#7  * nMult;
     #71#9  = #71#9  * nMult;
     #71#37 = #71#37 * nMult;

     |SI #10#70 = "D";
          #71#39 = #71#9;
     |SINO;
          #71#39 = #71#37;
     |FINSI;
|FPRC;
*/
|PROCESO CreaLin;
     |SI #3#8 = 0;
          aAlfa = "0000Articulo [" + #3#2 + "]" + &13 + "No existe en pedido...";
          |MENAV aAlfa;
          |ACABA;
     |FINSI;

     |ABRE #19;
     #19#0 = #3#2;
     |LEE 000#19=;
     |CIERRA #19;

     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = #3#8;
     |LEE 101#71=;
     |SI FSalida ! 0;
          #71#2 = #19#0;
          #71#3 = 1;
          #71#4 = #19#1;
          |GRABA 020#71b;
     |FINSI;
     #71#5 = #71#5 + #3#11;
     #71#6 = #73#38;                || PRECIO
     #71#10 = #19#31; ||%Comi
     #71#11 = #19#30;
     #71#12 = #3#1;
     #71#13 = #19#2;
     #71#15 = #10#3;
     #71#16 = #10#34; ||Tipo comi
     #71#17 = #10#35; ||Tipo Cli
     #71#21 = #3#8;
     #71#31 = #3#0;
     #71#36 = #71#6;
     #71#38 = #71#6;
     #71#47 = aDesglo;
     |HAZ TotalLin71;
     |HAZ ActPedido;
     #10#41 = #10#41 + 1;

     |SI aDespreciar = "S";
         enUnidPend = #71#5 + (nPendiente - #71#5);
     |SINO;
          enUnidPend = #71#5;
     |FINSI;
     enForma = 1;
     |HAZ AcumulaAV;
     nNume = ((((#71#9 < #10#5) < #10#32) < #10#7));
     #71#13 = enMargen;
     |GRABA 020#71a;
     |HAZ ActCliente
     #10#37 = #10#37 + #10#37 + (nNume - enMargen);
     |GRABA 020#10a;
|FPRC;

|PROCESO RecalAlb;
     |SI aSerAlb ! "";
          #10#52 = aSerAlb;
          #10#0 = nNumAlb;
          |LEE 101#10=;
          |SI FSalida = 0;
               |HAZ LimCabAgifa010;
               |BUCLELIN 0 CalCabAgifa010 #10;
               |GRABA 020#10a;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO dsm00053;
     #53#0 = "A";
     #53#1 = #71#29;
     #53#2 = #71#0;
     #53#1 = #71#1;
     |GRABA 020#53n;
|FPRC;

|DEFBUCLE dsm00053;
     #53#1;
     ;
     "P", #3#0, #3#1, #3#8, 0001;
     "P", #3#0, #3#1, #3#8, 9999;
     ;
     NULL, dsm00053;
|FIN;

|PROCESO ortsm004;
     |BORRA 020#4a;
|FPRC;

|DEFBUCLE ortsm004;
     #4#1;
     ;
     #3#0, #3#1, #3#2, "                    ";
     #3#0, #3#1, #3#2, "zzzzzzzzzzzzzzzzzzzz";
     be;
     NULL, ortsm004;
|FIN;

|PROCESO ortsm003;
     |SI #3#11 = 0; |Y #3#5 = "N";
          |ACABA;
     |FINSI;

     #104#25 = #3#0;
     #104#0 = #3#1;
     |LEE 020#104=;

     #73#28 = #3#0;
     #73#0 = #3#1;
     #73#8 = #3#2;
     |LEE 020#73=;

     |SI aCli ! #104#4; |O aRep ! #104#7; |O aFp ! #104#9;
               |O nDt1 ! #104#5; |O nDt2 ! #104#17; |O nDt3 ! #104#6;
          |HAZ RecalAlb;

          |HAZ CreaCab;
          aCli = #104#4;
          aRep = #104#7;
          aFp = #104#9;
          nDt1 = #104#5;
          nDt2 = #104#17;
          nDt3 = #104#6;
          nLin = 0;
     |FINSI;
     |HAZ CreaLin;
     |BUCLE dsm00053;
     |BORRA 020#3a;
     |BUCLE ortsm004;

     |SI #2#0 ! #3#0; |O #2#1 ! #3#1;
          |ABRE #2;
          #2#0 = #3#0;
          #2#1 = #3#1;
          |BORRA 000#2c;
          |CIERRA #2;
     |FINSI;
|FPRC;

|PROCESO Orden;
     #104#25 = #3#0;
     #104#0 = #3#1;
     |LEE 020#104=;
|FPRC;

|DEFBUCLE ortsm003;
     #3#1;
     ;
     #0#0, #0#2, "                    ";
     #0#1, #0#3, "zzzzzzzzzzzzzzzzzzzz";
     be;
     NULL, Orden, NULL, NULL, NULL, ortsm003;
     #104#4, #104#7, #104#9, #104#5, #104#17, #104#6;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |ABRET #10;
     |ABRET #71;
     |ABRET #104;
     |ABRET #73;
     |BUCLE ortsm003;
     |HAZ RecalAlb;
     |CIERRAT #73;
     |CIERRAT #104;
     |CIERRAT #71;
     |CIERRAT #10;
|FPRC;
