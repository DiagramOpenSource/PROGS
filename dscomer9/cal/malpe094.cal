|FICHEROS;
     malpe094 #0;
     malpe001 #1;
     malpe078 #78; ||Rapels (C)
     malpe079 #79; ||Rapels (L)
     malpe095 #95; ||Series sin Rapel
     agifa134 #134;
     agifa059 #59;
     malpe090 #90;
     malpe091 #91;
     malpe096 #96;
     malpe097 #97;
     referen@ #100;
|FIN;

|VARIABLES;
     nMesAnt = 0;
     nAlba = 0;
     nLin = 0;
     fFecha = @;
     fIni = @;
     fFin = @;
     aAlfa = "";
     nNume = 0;
     nMeses = 0;
     nAno = 0;
     nMes = 0;
     nRapel = 0;
|FIN;

|PROCESO Mes0; |TIPO 0;
     |SI FSalida =2; |ACABA; |FINSI;

     |SI #0#0 = 2; |Y #0#1 ! 1; |Y #0#1 ! 3; |Y #0#1 ! 5; |Y #0#1 ! 7;
               |Y #0#1 ! 9; |Y #0#1 ! 11;
          |MENAV "0000Mes incorrecto..."; |ERROR;
     |FINSI;
     |SI #0#0 = 3; |Y #0#1 ! 1; |Y #0#1 ! 4; |Y #0#1 ! 7; |Y #0#1 ! 10;
          |MENAV "0000Mes incorrecto..."; |ERROR;
     |FINSI;
     |SI #0#0 = 4; |Y #0#1 ! 1; |Y #0#1 ! 7;
          |MENAV "0000Mes incorrecto..."; |ERROR;
     |FINSI;
     |SI #0#0 = 5; |Y #0#1 ! 1;
          |MENAV "0000Mes incorrecto..."; |ERROR;
     |FINSI;
|FPRC;

|PROCESO Mes7; |TIPO 7;
     |SI #0#0 = 1; aAlfa = "0000Tipo de calculo 1 (Mensual): Indicar de 1 a 12"; |FINSI;
     |SI #0#0 = 2; aAlfa = "0000Tipo de calculo 2 (Bimensual): Indicar 1,3,5,7,9 o 11"; |FINSI;
     |SI #0#0 = 3; aAlfa = "0000Tipo de calculo 3 (Trimestral): Indicar 1,4,7 o 10"; |FINSI;
     |SI #0#0 = 4; aAlfa = "0000Tipo de calculo 4 (Semestral): Indicar 1 o 7"; |FINSI;
     |SI #0#0 = 5; aAlfa = "0000Tipo de calculo 5 (Anual): Indicar 1"; |FINSI;
     |MENSA aAlfa;
|FPRC;

|PROCESO malpe079;
     |SI #96#6 < #79#3;
          |ERROR10;
     |FINSI;
     nRapel = #79#4;
|FPRC;

|DEFBUCLE malpe079;
     #79#1;
     ;
     #96#0, #96#4, 001;
     #96#0, #96#4, 999;
     ;
     NULL, malpe079;
|FIN;

|PROCESO CalcuRapel;
     nRapel = 0;
     |BUCLE malpe079;

     |SI #78#2 = 1; nMesAnt = #0#1 - 1; |FINSI;
     |SI #78#2 = 2; nMesAnt = #0#1 - 2; |FINSI;
     |SI #78#2 = 3; nMesAnt = #0#1 - 3; |FINSI;
     |SI #78#2 = 4; nMesAnt = #0#1 - 6; |FINSI;
     |SI #78#2 = 5; nMesAnt = #0#1 - 12; |FINSI;

     #100#0 = #96#0;
     #100#1 = #96#1;
     #100#2 = #96#2;
     #100#3 = nMesAnt;
     #100#4 = #96#4;
     |LEE 000#100=;
     |SI FSalida = 0;
          #96#14 = #100#8;
     |SINO;
          #96#14 = 0;
     |FINSI;

     #96#7 = nRapel;
     #96#8 = #96#6 % #96#7;
     #96#9 = #78#3;
     #96#13 = #78#4;
     #96#15 = #96#8 - #96#14;
     |GRABA 020#96a;
     |LIBERA #96;
|FPRC;

|DEFBUCLE CalcuRapel;
     #96#1;
     ;
     #78#0, #0#0, #0#2, #0#1, 0;
     #78#0, #0#0, #0#2, #0#1, 1;
     be;
     NULL, CalcuRapel;
|FIN;
****************************************************
|PROCESO malpe091_3;
     |SI #91#73 = "N";   ||Rapel
          |ACABA;
     |FINSI;

     |DDEFECTO #96;
     ||#96#0 = #90#3;
     #96#0 = #78#0;
     #96#1 = #0#0;
     #96#2 = #0#2;
     #96#3 = #0#1;
     #96#4 = 1;
     |LEE 101#96=;
     |SI FSalida ! 0; |GRABA 020#96b; |FINSI;

     |HAZ UltimaLin;
     |DDEFECTO #97;
     #97#0 = #96#0;
     #97#1 = #96#1;
     #97#2 = #96#2;
     #97#3 = #96#3;
     #97#4 = #96#4;
     #97#5 = nLin;

     #97#6 = #134#49;
     #97#7 = #134#0;
     #97#8 = #91#29;
     #97#9 = #91#0;
     #97#10 = #91#1;
     #97#11 = #91#2;
     #97#12 = #91#5 * #91#67;
     #97#13 = #97#12;
     #97#14 = #78#5;
     |GRABA 020#97n;

     #96#5 = ~;
     #96#6 = #96#6 + #97#13;
     |GRABA 020#96a;
     |LIBERA #96;
|FPRC;

|DEFBUCLE malpe090_3;
     #90#1;
     ;
     #59#15, #59#2;
     #59#15, #59#2;
     ;
     NULL, NULL, malpe091_3;
|FIN;

|PROCESO agifa059_3;
     |BUCLE malpe090_3;
|FPRC;

|PROCESO agifa134_3;
     #95#0 = #134#49;
     |LEE 000#95=;
     |SI FSalida = 0; |ERROR; |FINSI;
|FPRC;

|DEFBUCLE agifa134_3;
     #134#3;
     115;
     #1#0, fIni, "     ", 000001, #1#1;
     #1#0, fFin, "zzzzz", 999999, #1#1;
     ;
     NULL, agifa134_3, agifa059_3;
|FIN;

|PROCESO malpe001_1;
     |BUCLE agifa134_3;
|FPRC;

|DEFBUCLE malpe001_1;
     #1#3;
     ;
     #78#0;
     #78#0;
     ;
     NULL, malpe001_1;
|FIN;
***************************************
|PROCESO malpe091_2;
     |SI #91#73 = "N";   ||Rapel
          |ACABA;
     |FINSI;

     |DDEFECTO #96;
     ||#96#0 = #90#3;
     #96#0 = #78#0;
     #96#1 = #0#0;
     #96#2 = #0#2;
     #96#3 = #0#1;
     #96#4 = 1;
     |LEE 101#96=;
     |SI FSalida ! 0; |GRABA 020#96b; |FINSI;

     |HAZ UltimaLin;
     |DDEFECTO #97;
     #97#0 = #96#0;
     #97#1 = #96#1;
     #97#2 = #96#2;
     #97#3 = #96#3;
     #97#4 = #96#4;
     #97#5 = nLin;

     #97#6 = #134#49;
     #97#7 = #134#0;
     #97#8 = #91#29;
     #97#9 = #91#0;
     #97#10 = #91#1;
     #97#11 = #91#2;
     #97#12 = #91#5 * #91#67;
     #97#13 = #97#12;
     #97#14 = #78#5;
     |GRABA 020#97n;

     #96#5 = ~;
     #96#6 = #96#6 + #97#13;
     |GRABA 020#96a;
     |LIBERA #96;
|FPRC;

|DEFBUCLE malpe090_2;
     #90#1;
     ;
     #59#15, #59#2;
     #59#15, #59#2;
     ;
     NULL, NULL, malpe091_2;
|FIN;

|PROCESO agifa059_2;
     |BUCLE malpe090_2;
|FPRC;

|PROCESO agifa134_2;
     #95#0 = #134#49;
     |LEE 000#95=;
     |SI FSalida = 0; |ERROR; |FINSI;
|FPRC;

|DEFBUCLE agifa134_2;
     #134#3;
     115;
     #1#0, fIni, "     ", 000001, #1#1;
     #1#0, fFin, "zzzzz", 999999, #1#1;
     ;
     NULL, agifa134_2, agifa059_2;
|FIN;

|PROCESO malpe001;
     |BUCLE agifa134_2;
|FPRC;

|DEFBUCLE malpe001;
     #1#3;
     ;
     #78#0;
     #78#0;
     ;
     NULL, malpe001;
|FIN;

|PROCESO UltimaLin;
     #97#0 = #96#0;
     #97#1 = #96#1;
     #97#2 = #96#2;
     #97#3 = #96#3;
     #97#4 = #96#4;
     #97#5 = 99999;
     |LEE 000#97];
     |SI FSalida = 0;
          |LEE 000#97a;
     |SINO;
          |LEE 000#97u;
     |FINSI;
     |SI FSalida = 0; |Y #97#0 = #96#0; |Y #97#1 = #96#1; |Y #97#2 = #96#2;
               |Y #97#3 = #96#3; |Y #97#4 = #96#4;
          nLin = #97#5 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
|FPRC;

|PROCESO malpe091;
     |SI #91#73 = "N";   ||Rapel
          |ACABA;
     |FINSI;

     |DDEFECTO #96;
     ||#96#0 = #90#3;
     #96#0 = #78#0;
     #96#1 = #0#0;
     #96#2 = #0#2;
     #96#3 = #0#1;
     #96#4 = 0;
     |LEE 101#96=;
     |SI FSalida ! 0; |GRABA 020#96b; |FINSI;

     |HAZ UltimaLin;
     |DDEFECTO #97;
     #97#0 = #96#0;
     #97#1 = #96#1;
     #97#2 = #96#2;
     #97#3 = #96#3;
     #97#4 = #96#4;
     #97#5 = nLin;

     #97#6 = #134#49;
     #97#7 = #134#0;
     #97#8 = #91#29;
     #97#9 = #91#0;
     #97#10 = #91#1;
     #97#11 = #91#2;
     #97#12 = #91#5 * #91#67;
     #97#13 = #97#12;
     #97#14 = #78#5;
     |GRABA 020#97n;

     #96#5 = ~;
     #96#6 = #96#6 + #97#13;
     |GRABA 020#96a;
     |LIBERA #96;
|FPRC;

|DEFBUCLE malpe090;
     #90#1;
     ;
     #59#15, #59#2;
     #59#15, #59#2;
     ;
     NULL, NULL, malpe091;
|FIN;

|PROCESO agifa059;
     |BUCLE malpe090;
|FPRC;

|PROCESO agifa134;
     #95#0 = #134#49;
     |LEE 000#95=;
     |SI FSalida = 0; |ERROR; |FINSI;
|FPRC;

|DEFBUCLE agifa134;
     #134#3;
     ;
     #78#0, fIni, "     ", 000001;
     #78#0, fFin, "zzzzz", 999999;
     ;
     NULL, agifa134, agifa059;
|FIN;

|PROCESO malpe078_0;
     |ABRE #96;
     |ABRE #97;
     |BUCLE agifa134;
     |BUCLE malpe001;
     |CIERRA #97;
     |CIERRA #96;

     |ABRE #100;
     |BUCLE CalcuRapel;
     |CIERRA #100;
|FPRC;

|PROCESO malpe078_1;
     |ABRE #96;
     |ABRE #97;
     |BUCLE malpe001_1;
     |CIERRA #97;
     |CIERRA #96;

     |ABRE #100;
     |BUCLE CalcuRapel;
     |CIERRA #100;
|FPRC;

|PROCESO malpe096Bor;
     |BUCLELIN 1 NULL #96;
     |BORRA 020#96a;
|FPRC;

|PROCESO malpe096Cheq;
     nAlba = #96#11;
     |SI nAlba ! 0; |ERROR10; |FINSI;
|FPRC;

|DEFBUCLE malpe078_0;
     #78#1;
     2;
     "      ", 0, #0#0;
     "zzzzzz", 0, #0#0;
     ;
     NULL, malpe078_0;
|FIN;

|DEFBUCLE malpe078_1;
     #78#1;
     2;
     "      ", 1, #0#0;
     "zzzzzz", 1, #0#0;
     ;
     NULL, malpe078_1;
|FIN;

|DEFBUCLE malpe096Bor;
     #96#1;
     ;
     "      ", #0#0, #0#2, #0#1, 0;
     "zzzzzz", #0#0, #0#2, #0#1, 1;
     be;
     NULL, malpe096Bor;
|FIN;

|DEFBUCLE malpe096Cheq;
     #96#1;
     ;
     "      ", #0#0, #0#2, #0#1, 0;
     "zzzzzz", #0#0, #0#2, #0#1, 1;
     ;
     NULL, malpe096Cheq;
|FIN;

|PROCESO Ano; |TIPO 7;
     |SI #0#2 = 0;
          fFecha = ~;
          aAlfa = fFecha % -104;
          #0#2 = aAlfa; |PINTA #0#2;
     |FINSI;
|FPRC;

|PROCESO TipoCal; |TIPO 0;
     |SI #0#0 = 5;
          |C_M #0#1, 1, "N";
          #0#1 = 1; |PINTA #0#1;
     |SINO;
          |C_M #0#1, 1, "S";
     |FINSI;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     |DDEF aAlfa;
     aAlfa = aAlfa + "malpe096";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error en def";
          |ACABA;
     |FINSI;

     aAlfa = "01.01." + (("0000" + #0#2) % -104);
     fIni = aAlfa;
     |SI #0#0 = 1; nMeses = 1; |FINSI;
     |SI #0#0 = 2; nMeses = 2; |FINSI;
     |SI #0#0 = 3; nMeses = 3; |FINSI;
     |SI #0#0 = 4; nMeses = 6; |FINSI;
     |SI #0#0 = 5; nMeses = 12; |FINSI;
     nMeses = nMeses + #0#1 - 1;
     nMeses = (nMeses/1000) - 1;
     fFin = fIni + nMeses;

     aAlfa = "Perido: " + fIni + " - " + fFin
     |ATRI I; |PINTA 1721, aAlfa; |ATRI 0;

     |ABRE #95;
     |BUCLE malpe096Cheq;
     |SI nAlba = 0;
          |BUCLE malpe096Bor;
          |BUCLE malpe078_0;
          |BUCLE malpe078_1;
     |SINO;
          |MENAV "0000Calculo y Albaranes ya generados.";
     |FINSI;
     |CIERRA #95;

     |DESCARGA_DEF #referen@;
|FPRC;
