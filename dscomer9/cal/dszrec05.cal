  ----------------------  AGIFA146 (FACTURAS PROFORMAS CABECERAS) -------

|FICHEROS;
     dszrec05;
     agifa146 #0;
     agifa147 #3;

     agifa142;
     agifa019 #2;
|FIN;

|VARIABLES;
     nCanon = 0;
     nTotPVerde = 0;
     &enForma = 0;
     nImporDescue1 = 0;
     nImporDescue2 = 0;
     nImporDescue3 = 0;
     nImporMoneda1 = 0;
     nImporMoneda2 = 0;
     nDescuMoneda1 = 0;
     nDescuMoneda2 = 0;
     nImpDiv       = 0;
     &nDeci_Div    = 0;
     &nDeci_IVA    = 0;
     &nDeci_IVADiv = 0;
     nError        = 0;
     nNume         = 0;
     nCanti        = 0;
     nMargen       = 0;
     nBrutoMoneda1 = 0;
     nBrutoMoneda2 = 0;

     &eaCli        = "";
     &enTiva       = 0;
     &enIva        = 0;
     &enRec        = 0;
     &efFiva = @;
     aAlfa = "";
     nPreTon = 0;
|FIN;

|PROCESO BseVerdeBase5;
     |SI #agifa142#177 ! "S";
          |ACABA;
     |FINSI;

     nBrutoMoneda1 = nBrutoMoneda1 + #agifa147#35;
     nBrutoMoneda2 = nBrutoMoneda2 + #agifa147#35;
     nTotPVerde = #agifa146#82;
|FPRC;

|PROCESO IvasAgifa146;
     efFiva = #agifa146#1;
     |HAZ IVACli;

     |SI enTiva = 0;
         #agifa146#28 = #agifa146#28 +. nBrutoMoneda1;
         #dszrec05#00 = #dszrec05#00 +. nBrutoMoneda2;
     |FINSI;

     |SI enTiva = 1;
         #agifa146#16 = #agifa146#16 +. nBrutoMoneda1;
         nNume        = #agifa146#16;
         #agifa146#17 = #agifa146#16 % enIva;
         #agifa146#50 = enIva;
         |SI #agifa146#36 = "S";
             #agifa146#18 = nNume % enRec;
             #agifa146#51 = enRec;
         |FINSI;

         #dszrec05#1  = #dszrec05#1  +. nBrutoMoneda2;
         nNume        = #dszrec05#1;
         #dszrec05#2  = #dszrec05#1 % enIva;
         |SI #agifa146#36 = "S";
             #dszrec05#3 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 2;
         #agifa146#19 = #agifa146#19 +. nBrutoMoneda1;
         nNume        = #agifa146#19;
         #agifa146#20 = #agifa146#19 % enIva;
         #agifa146#52 = enIva;
         |SI #agifa146#36 = "S";
             #agifa146#21 = nNume % enRec;
             #agifa146#53 = enRec;
         |FINSI;

         #dszrec05#4  = #dszrec05#4  +. nBrutoMoneda2;
         nNume        = #dszrec05#4;
         #dszrec05#5  = #dszrec05#4 % enIva;
         |SI #agifa146#36 = "S";
             #dszrec05#6 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 3;
         #agifa146#22 = #agifa146#22 +. nBrutoMoneda1;
         nNume        = #agifa146#22;
         #agifa146#23 = #agifa146#22 % enIva;
         #agifa146#54 = enIva;
         |SI #agifa146#36 = "S";
             #agifa146#49 = nNume % enRec;
             #agifa146#55 = enRec;
         |FINSI;

         #dszrec05#7  = #dszrec05#7  +. nBrutoMoneda2;
         nNume        = #dszrec05#7;
         #dszrec05#8  = #dszrec05#7 % enIva;
         |SI #agifa146#36 = "S";
             #dszrec05#9 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 4;
         #agifa146#42 = #agifa146#42 +. nBrutoMoneda1;
         nNume        = #agifa146#42;
         #agifa146#43 = #agifa146#42 % enIva;
         #agifa146#56 = enIva;
         |SI #agifa146#36 = "S";
             #agifa146#44 = nNume % enRec;
             #agifa146#57 = enRec;
         |FINSI;

         #dszrec05#10 = #dszrec05#10 +. nBrutoMoneda2;
         nNume        = #dszrec05#10;
         #dszrec05#11 = #dszrec05#10 % enIva;
         |SI #agifa146#36 = "S";
             #dszrec05#12 = nNume % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 5;
         #agifa146#45 = #agifa146#45 +. nBrutoMoneda1;
         nNume        = #agifa146#45;
         #agifa146#46 = #agifa146#45 % enIva;
         #agifa146#58 = enIva;
         |SI #agifa146#36 = "S";
             #agifa146#47 = nNume % enRec;
             #agifa146#59 = enRec;
         |FINSI;

         #dszrec05#13 = #dszrec05#13 +. nBrutoMoneda2;
         nNume        = #dszrec05#13;
         #dszrec05#14 = #dszrec05#13 % enIva;
         |SI #agifa146#36 = "S";
             #dszrec05#15 = nNume % enRec;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO IvaRestoAgifa146;
     eaCli         = #agifa146#3;

     nBrutoMoneda1 = #agifa146#11;
     nBrutoMoneda2 = #agifa146#76;
     enTiva        = #agifa146#12;
     |HAZ IvasAgifa146;

     nBrutoMoneda1 = #agifa146#13;
     nBrutoMoneda2 = #agifa146#77;
     enTiva        = #agifa146#14;
     |HAZ IvasAgifa146;
|FPRC;

|PROCESO LimCabAgifa146;
     |ABRE #agifa142; |LEE 000#agifa142.p; |CIERRA #agifa142;
     |DDEFECTO #dszrec05;
     nTotPVerde = 0;
     #agifa146#15 = 0;
     #agifa146#37 = 0;
     #agifa146#16 = 0;
     #agifa146#17 = 0;
     #agifa146#18 = 0;
     #agifa146#19 = 0;
     #agifa146#20 = 0;
     #agifa146#21 = 0;
     #agifa146#22 = 0;
     #agifa146#23 = 0;
     #agifa146#24 = 0;
     #agifa146#25 = 0;
     #agifa146#26 = 0;
     #agifa146#28 = 0;
     #agifa146#37 = 0;
     #agifa146#41 = 0;
     #agifa146#42 = 0;
     #agifa146#43 = 0;
     #agifa146#44 = 0;
     #agifa146#45 = 0;
     #agifa146#46 = 0;
     #agifa146#47 = 0;
     #agifa146#49 = 0;
     #agifa146#70 = 0;
     #agifa146#71 = 0;
     #agifa146#82 = 0;
     #agifa146#87 = 0;

     |SI #agifa146#67 = "D";
          #agifa146#11 = #agifa146#76 / #agifa146#66 * #agifa146#69;
          #agifa146#13 = #agifa146#77 / #agifa146#66 * #agifa146#69;
     |SINO;
          #agifa146#76 = #agifa146#11 * #agifa146#66 / #agifa146#69;
          #agifa146#77 = #agifa146#13 * #agifa146#66 / #agifa146#69;
     |FINSI;

     |HAZ IvaRestoAgifa146;
|FPRC;

|PROCESO CalCabAgifa146;
     ||----------------------------  Margen
     |SI #agifa147#9 ] 0;
          nError = 1;
     |SINO;
          nError = -1;
          #agifa147#9   = -#agifa147#9;
          #agifa147#25  = -#agifa147#25;
     |FINSI;

     nCanti = #agifa147#9 < #agifa146#5;
     nCanti = nCanti < #agifa146#32;
     |SI #agifa142#115 = "S";
          nCanti = nCanti < #agifa146#7;
     |FINSI;
     nCanti = nCanti * nError;
     |SI #agifa019#194 = 1;
         nMargen = #agifa147#5 * #agifa019#9;
     |SINO;
         nMargen = #agifa147#28 * #agifa019#9;
     |FINSI;
     nMargen      = nCanti - nMargen;
     #agifa146#37 = #agifa146#37 + nMargen;
     #agifa147#9  = #agifa147#9  * nError;
     #agifa147#25 = #agifa147#25 * nError;
     ||----------------------------

     #agifa146#15 = #agifa146#15 +. #agifa147#9;
     #agifa146#70 = #agifa146#70 +. #agifa147#25;
     #agifa146#82 = #agifa146#82 +. #agifa147#35;

     nBrutoMoneda1 = #agifa147#9;
     nImporDescue1 = (nBrutoMoneda1 % #agifa146#5) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #agifa146#32) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #agifa146#7) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     nDescuMoneda1 = nImporDescue1 + nImporDescue2 + nImporDescue3;

     nBrutoMoneda2 = #agifa147#25;
     nImporDescue1 = (nBrutoMoneda2 % #agifa146#5) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #agifa146#32) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #agifa146#7) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     nDescuMoneda2 = nImporDescue1 + nImporDescue2 + nImporDescue3;
/*
     nBrutoMoneda1 = (#agifa147#9  < #agifa146#5) ! nDeci_IVA;
     nBrutoMoneda1 = (nBrutoMoneda1 < #agifa146#32) ! nDeci_IVA;
     nBrutoMoneda1 = (nBrutoMoneda1 < #agifa146#7) ! nDeci_IVA;

     nBrutoMoneda2 = (#agifa147#25 < #agifa146#5) ! nDeci_IVADiv;
     nBrutoMoneda2 = (nBrutoMoneda2 < #agifa146#32) ! nDeci_IVADiv;
     nBrutoMoneda2 = (nBrutoMoneda2 < #agifa146#7) ! nDeci_IVADiv;
*/
     |HAZ BseVerdeBase5;

     eaCli         = #agifa146#3;
     enTiva        = #agifa147#11;
     |HAZ IvasAgifa146;

     |SI #agifa147#36 = -1;
          nCanon = #agifa147#9 + (#agifa147#9 % enIva);
          |SI #agifa146#36 = "S";
               nCanon = nCanon + (#agifa147#9 % enRec);
          |FINSI;
          #agifa146#87 = #agifa146#87 +. nCanon;
     |FINSI;

     nNume = nBrutoMoneda1 % #agifa147#10;
     #agifa146#26 = #agifa146#26 +. nNume;

     #agifa146#25 = #agifa146#25 +. nDescuMoneda1;

/*
     |SI #agifa146#15 > 0;
         nError = 1;
     |SINO;
         nError = -1;
         #agifa146#15 = -#agifa146#15;
         #agifa146#70 = -#agifa146#70;
     |FINSI;
     #agifa146#25 = #agifa146#15 < #agifa146#5;
     #agifa146#25 = #agifa146#25 < #agifa146#32;
     #agifa146#25 = #agifa146#25 < #agifa146#7;
     #agifa146#25 = #agifa146#25 * nError;
     #agifa146#15 = #agifa146#15 * nError;
     #agifa146#25 = #agifa146#15 - #agifa146#25;
*/
     #agifa146#24 = #agifa146#17 + #agifa146#18 + #agifa146#20 + #agifa146#21+ #agifa146#23 + #agifa146#43 + #agifa146#44+ #agifa146#46 + #agifa146#47 + #agifa146#49;

     #dszrec05#17 = #dszrec05#17 +. nDescuMoneda2;
/*
     #dszrec05#17 = #agifa146#70 < #agifa146#5;
     #dszrec05#17 = #dszrec05#17 < #agifa146#32;
     #dszrec05#17 = #dszrec05#17 < #agifa146#7;
     #dszrec05#17 = #dszrec05#17 * nError;
     #agifa146#70 = #agifa146#70 * nError;
     #dszrec05#17 = #agifa146#70 - #dszrec05#17;
*/
     #dszrec05#16 = #dszrec05#02 + #dszrec05#03 + #dszrec05#05 + #dszrec05#06;
     #dszrec05#16 = #dszrec05#16 + #dszrec05#08 + #dszrec05#09 + #dszrec05#11;
     #dszrec05#16 = #dszrec05#16 + #dszrec05#12 + #dszrec05#14 + #dszrec05#15;

     #agifa146#41 =  (#agifa146#15 - #agifa146#25)+ (#agifa146#11 + #agifa146#13 + #agifa146#24);
     #agifa146#41 = #agifa146#41 + nTotPVerde;

     #agifa146#71 =  (#agifa146#70 - #dszrec05#17)+ (#agifa146#76 + #agifa146#77 + #dszrec05#16);
     #agifa146#71 = #agifa146#71 + nTotPVerde;

     |SI #agifa146#67 = "D";
         #agifa146#72 = #agifa146#70;
         #agifa146#73 = #agifa146#71;
         #agifa146#74 = #agifa146#15;
         #agifa146#75 = #agifa146#41;
     |SINO;
         #agifa146#72 = #agifa146#15;
         #agifa146#73 = #agifa146#41;
         #agifa146#74 = #agifa146#70;
         #agifa146#75 = #agifa146#71;
     |FINSI;
|FPRC;

|| ----------------------  FIN AGIFA146 ---------------------------------

|PROCESO TotalLin147;
     |ABRE #2
     #2#0 = #3#2;
     |LEE 020#2=;
     |CIERRA #2;

     nPreTon = 1;
     |HAZ EsVigor;
     |SI FSalida = 0;
          aAlfa = #2#110; |QBF aAlfa;   || Alfanumerico1
          aAlfa = aAlfa > "";
          |SI aAlfa = "S"; nPreTon = 1000; |FINSI;
     |FINSI;

     #3#35 = #3#5 * #2#208; ||Punto Verde

     |SI #0#67 = "D";                   || Si mon. de trabajo es divisa ...
          #3#6 = #3#24 / #0#66 * #0#69; || Recalculo precio en mon. base
          #3#26 = #3#6;                 || Precio visual, en mon. base
     |SINO;                             || Si mon. de trabajo es mon. base
          #3#24 = #3#6 / #0#69 * #0#66; || Recalculo precio en divisa
          #3#26 = #3#24;                || Precio visual, en divisa
     |FINSI;

     |SI #2#194 = 2;
          #3#7    = #3#28 * #3#6 / nPreTon;
          nImpDiv = (#3#28 * #3#24 / nPreTon) ! nDeci_Div;
     |SINO;
          #3#7    = #3#5  * #3#6 / nPreTon;
          nImpDiv = (#3#5  * #3#24 / nPreTon) ! nDeci_Div;
     |FINSI;
     #3#9  = (#3#7 < #3#8) < #3#21;
     #3#25 = (nImpDiv < #3#8) < #3#21;

     |SI #0#67 = "D";          || Si mon. de trabajo es divisa ...
          #3#27 = #3#9;        || Importe visual, en mon. base
     |SINO;                    || Si mon. de trabajo es mon. base ...
          #3#27 = #3#25;       || Importe visual, en divisa
     |FINSI;
|FPRC;

----------------------------------------------------------------------
     Calculo igual al CalCabAgifa146, solo cambia el +. por enForma
----------------------------------------------------------------------
|PROCESO CalCabAgifa146_2;
     ||----------------------------  Margen
     |SI #agifa147#9 ] 0;
          nError = 1;
     |SINO;
          nError = -1;
          #agifa147#9   = -#agifa147#9;
          #agifa147#25  = -#agifa147#25;
     |FINSI;

     nCanti = #agifa147#9 < #agifa146#5;
     nCanti = nCanti < #agifa146#32;
     |SI #agifa142#115 = "S";
          nCanti = nCanti < #agifa146#7;
     |FINSI;
     nCanti = nCanti * nError;
     |SI #agifa019#194 = 1;
         nMargen = #agifa147#5 * #agifa019#9;
     |SINO;
         nMargen = #agifa147#28 * #agifa019#9;
     |FINSI;
     nMargen      = nCanti - nMargen;
     #agifa146#37 = #agifa146#37 + nMargen;
     #agifa147#9  = #agifa147#9  * nError;
     #agifa147#25 = #agifa147#25 * nError;
     ||----------------------------

     #agifa146#15 = #agifa146#15 + (#agifa147#9 * enForma);
     #agifa146#70 = #agifa146#70 + (#agifa147#25 * enForma);
     #agifa146#82 = #agifa146#82 + (#agifa147#35 * enForma);

     nBrutoMoneda1 = #agifa147#9;
     nImporDescue1 = (nBrutoMoneda1 % #agifa146#5) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #agifa146#32) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #agifa146#7) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     nDescuMoneda1 = nImporDescue1 + nImporDescue2 + nImporDescue3;

     nBrutoMoneda2 = #agifa147#25;
     nImporDescue1 = (nBrutoMoneda2 % #agifa146#5) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #agifa146#32) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #agifa146#7) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     nDescuMoneda2 = nImporDescue1 + nImporDescue2 + nImporDescue3;
/*
     nBrutoMoneda1 = (#agifa147#9  < #agifa146#5) ! nDeci_IVA;
     nBrutoMoneda1 = (nBrutoMoneda1 < #agifa146#32) ! nDeci_IVA;
     nBrutoMoneda1 = (nBrutoMoneda1 < #agifa146#7) ! nDeci_IVA;

     nBrutoMoneda2 = (#agifa147#25 < #agifa146#5) ! nDeci_IVADiv;
     nBrutoMoneda2 = (nBrutoMoneda2 < #agifa146#32) ! nDeci_IVADiv;
     nBrutoMoneda2 = (nBrutoMoneda2 < #agifa146#7) ! nDeci_IVADiv;
*/
     |HAZ BseVerdeBase5;

     eaCli         = #agifa146#3;
     enTiva        = #agifa147#11;
     |HAZ IvasAgifa146;

     |SI #agifa147#36 = -1;
          nCanon = #agifa147#9 + (#agifa147#9 % enIva);
          |SI #agifa146#36 = "S";
               nCanon = nCanon + (#agifa147#9 % enRec);
          |FINSI;
          #agifa146#87 = #agifa146#87 + (nCanon * enForma);
     |FINSI;

     nNume = nBrutoMoneda1 % #agifa147#10;
     #agifa146#26 = #agifa146#26 + (nNume * enForma);

     #agifa146#25 = #agifa146#25 + (nDescuMoneda1 * enForma);

/*
     |SI #agifa146#15 > 0;
         nError = 1;
     |SINO;
         nError = -1;
         #agifa146#15 = -#agifa146#15;
         #agifa146#70 = -#agifa146#70;
     |FINSI;
     #agifa146#25 = #agifa146#15 < #agifa146#5;
     #agifa146#25 = #agifa146#25 < #agifa146#32;
     #agifa146#25 = #agifa146#25 < #agifa146#7;
     #agifa146#25 = #agifa146#25 * nError;
     #agifa146#15 = #agifa146#15 * nError;
     #agifa146#25 = #agifa146#15 - #agifa146#25;
*/
     #agifa146#24 = #agifa146#17 + #agifa146#18 + #agifa146#20 + #agifa146#21+ #agifa146#23 + #agifa146#43 + #agifa146#44+ #agifa146#46 + #agifa146#47 + #agifa146#49;

     #dszrec05#17 = #dszrec05#17 + (nDescuMoneda2 * enForma);
/*
     #dszrec05#17 = #agifa146#70 < #agifa146#5;
     #dszrec05#17 = #dszrec05#17 < #agifa146#32;
     #dszrec05#17 = #dszrec05#17 < #agifa146#7;
     #dszrec05#17 = #dszrec05#17 * nError;
     #agifa146#70 = #agifa146#70 * nError;
     #dszrec05#17 = #agifa146#70 - #dszrec05#17;
*/
     #dszrec05#16 = #dszrec05#02 + #dszrec05#03 + #dszrec05#05 + #dszrec05#06;
     #dszrec05#16 = #dszrec05#16 + #dszrec05#08 + #dszrec05#09 + #dszrec05#11;
     #dszrec05#16 = #dszrec05#16 + #dszrec05#12 + #dszrec05#14 + #dszrec05#15;

     #agifa146#41 = (#agifa146#15 - #agifa146#25)+ (#agifa146#11 + #agifa146#13 + #agifa146#24);
     #agifa146#41 = #agifa146#41 + nTotPVerde;

     #agifa146#71 = (#agifa146#70 - #dszrec05#17)+ (#agifa146#76 + #agifa146#77 + #dszrec05#16);
     #agifa146#71 = #agifa146#71 + nTotPVerde;

     |SI #agifa146#67 = "D";
         #agifa146#72 = #agifa146#70;
         #agifa146#73 = #agifa146#71;
         #agifa146#74 = #agifa146#15;
         #agifa146#75 = #agifa146#41;
     |SINO;
         #agifa146#72 = #agifa146#15;
         #agifa146#73 = #agifa146#41;
         #agifa146#74 = #agifa146#70;
         #agifa146#75 = #agifa146#71;
     |FINSI;
|FPRC;
