|| NO ACTUALIZA IMPORTES SOLO UNIDADES

|FICHEROS;
     agifa068 #0;
     agifa029 #1;   || Almacenes

     agifa104 #2;   || PEDIDOS (C)
     agifa073 #3;   ||PEDIDOS VENTAS
     agifa081 #81;
     agifa067 #4;   ||PEDIDOS COMPRAS
     agifa036 #360;
     agifa070 #5;   ||DEPOSITOS
     agifa090 #6;   ||ORDEN FABRICACION CABACERA
     agifa007 #7;   || Series
     agifa074 #8;   ||ORDENES FABRICACION LINEA
     dsm00036 #36;
     dsm00037 #37;
     dsm00052 #52;  ||Componentes Ord. Fab
     dsm00067 #67;  ||Entrada Ord. Fab
     agifa065 #17;  ||HISTORICO

     agifa019 #53;  ||Articulos
     agifa017 #54;  ||Almacenes
     dsm00024 #24;  ||Partida

     agifa142 #42;  ||Parametros Generales

     agifa019@ #100;

     dsm00004 #904;
     dsm00005 #905;
     dsm00006 #906;
     dsm00046 #946;
     dsm00049 #949;
     dsm00065 #965;
     dsm00238 #238;
     dsm00138 #138;
     dsm00139 #139;

     referen@;
     tagm0078@;

     dsw00112 #112; ||Tmp
     dsm00291 #291; ||F.Creacion
|FIN;

|CAMPOS;
     #53#180 PARTI;
     #53#179 DOBLE;
     #53#204 MULTI;
     #53#15  art_pser;  #54#42  alm_pser;
     #53#182 art_pser2; #54#44  alm_pser2;
     #53#16  art_prec;  #54#43  alm_prec;
     #53#183 art_prec2; #54#45  alm_prec2;
     #53#17  art_pval;  #54#4   alm_pval;
     #53#11  art_nece;  #54#50  alm_nece;
     #53#12  art_rese;  #54#8   alm_rese;
     #53#14  art_depo;  #54#10  alm_depo;
     #53#184 art_depo2; #54#46  alm_depo2;
     #53#13  art_fabr;  #54#9   alm_fabr;
     #53#10  art_vsto;  #54#3   alm_vsto;
     #53#7   art_mini;  #54#6   alm_mini;
     #53#8   art_maxi;  #54#7   alm_maxi;
     #53#6   art_tota;  #54#5   alm_tota;
     #53#185 art_tota2; #54#47  alm_tota2;
     #53#104 art_disp;  #54#39  alm_disp;
     #53#193 art_disp2; #54#48  alm_disp2;
     #53#9   art_pcm;   #54#69  alm_pcm;
     #24#9   par_ereal; #24#10  par_ereal2;
     #24#11  par_sreal; #24#12  par_sreal2;
     #24#18  par_prec2; #24#19  par_prec;
     #24#16  par_pser;  #24#17  par_pser2;
     #24#20  par_depo;  #24#21  par_depo2;
     #24#22  par_tota;  #24#23  par_tota2;
     #24#31  par_disp;  #24#32  par_disp2;
     #24#43  par_proc;  #24#34  par_proc2;
     #24#14  par_merma;
     #53#210 art_depoc; #53#211 art_depoc2;
     #54#94  alm_depoc; #54#95  alm_depoc2;
     #24#48  par_depoc; #24#49  par_depoc2;
|FIN;

|VARIABLES;
     nCanV = 0;
     fDCurso = @;
     fHCurso = @;
     fDesde = @;
     fHasta = @;
     fHoy = @;
     aTag78 = "";
     nSwSanchez = 0;
     nSwGestral = 0;
     nSwTagloma = 0;
     nSwPCEGroup = 0;
     nSwMecanogra = 0;
     nPos = 0;
     aDato = "";
     aDeci = "";
     aNume = "";
     aFactor = "";
     nFactor = 0;
     nCabFichero = 0;
     fFecha = @;
     aDiferencias = "";
     aBorrados = "";
     aFicMail = "";
     aIP = "";
     aServidor = "";
     aFrom = "";
     aTo = "";
     aSubject = "";
     aMensaje = "";
     aFic = "";
     aDjunto = "";
     nHandle = 0;
     aEmp = "";

     aDirDestino = "";
     &efDfecha  = @;
     &efHfecha = @;
     &enSwImp = 0;
     &enEntra1 = 0;
     &enEntra2 = 0;
     &enSali1 = 0;
     &enSali2 = 0;
     &enPenSe1 = 0;
     &enPenRe1 = 0;
     &enReser1 = 0;
     &enDepo1 = 0;
     &enTota1 = 0;
     &enDispo1 = 0;
     &enPenSe2 = 0;
     &enPenRe2 = 0;
     &enReser2 = 0;
     &enDepo2 = 0;
     &enTota2 = 0;
     &enDispo2 = 0;
     nPrime = 0;
     nAbreInfor = 0;
     nAbreImpre = 0;
     nHay = 0;
     aDef = "";
     aOrg = "";
     aDes = "";
     aPath = "";
     nSwAlbadis = 0;
     nSwAlbero = "";
     nHayArti = 0;
     nHayAlma = 0;
     nHayParti = 0;
     nUni0 = 0;
     &eaArticulo = "";
     nLinV = 0;
     &eaRecupera = "";
     &eaDarti    = "";
     &eaHarti    = "";
     &eaFichero1 = "";
     &eaFichero2 = "";
     &eaFichero3 = "";
     &eaFichero4 = "";

     &enCampo  = 0;
     &eaCampo  = "";
     &enValor1 = 0;
     &enValor2 = 0;
     aAlfa  = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";

     aParam = "";
     nCanti2 = 0;
     aOpe = "";
     aParti = "";
     nCampo = 0;
     nCamp0 = 0;
     nNume = 0;
     nNum1 = 0;
     margen=0;
     imneto=0;
     fmes = "";
     mes = 0;
     mes1 = 0;
     canti1 = 0;
     i = 0;
     ncoste=0;
     menos = -1;
     fecact = "";
     &bloque = "";

     scanti  = 0;
     sCanti2 = 0;
     canti   = 0;
     articul = "";
     almacen = 0;

     nDiferencia = 0;
     nDiferencia2 = 0;
     &Tempo = "";
     aTmp112 = "";
|FIN;

----------------------------------------------------------
|PROCESO TmpPartida;
     |DDEFECTO #24;
     #24#0 = #112#0;
     #24#1 = #112#1;
     #24#2 = #112#2;
     |LEE 000#24=;
     |SI FSalida ! 0;
          #24#4 = #112#3;
          #24#5 = #112#4;

          #291#0 = #112#0;
          #291#1 = #112#1;
          #291#2 = #112#2;
          |LEE 000#291=;
          |SI FSalida = 0;
               #24#27 = #291#3;
          |FINSI;
          |GRABA 020#24n;
     |FINSI;
|FPRC;

|DEFBUCLE TmpPartida;
     #112#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, TmpPartida;
|FIN;

|PROCESO Historico;
     |SI #0#11 = "S";
          |SI #17#2 = "AV"; |O #17#2 = "AC"; |O #17#2 = "EV";
               |DDEFECTO #112;
               #112#0 = #17#0;
               #112#1 = #17#5;
               #112#2 = #17#18;
               |LEE 101#112=;
               |SI FSalida ! 0; |GRABA 020#112b; |FINSI;
               |SI #17#2 = "AV";
                    |SI #17#1 > #112#4;
                         #112#4 = #17#1;
                    |FINSI;
               |SINO;
                    |SI #17#1 < #112#3;
                         #112#3 = #17#1;
                    |FINSI;
               |FINSI;
               |GRABA 020#112a;
               |LIBERA #112;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE Historico;
     #17#1;
     ;
     #0#3, fDesde, "  ",       0,     0, "     ";
     #0#4, fHasta, "zz",  999999, 99999, "zzzzz";
     ;
     NULL , Historico;
|FIN;

|PROCESO CreaTmp112;
     |HAZ CreaTempo; aTmp112 = Tempo;
     |NOME_DAT #112 Tempo; |DELINDEX #112; |ABRE #112;
|FPRC;

|PROCESO BorraTmp112;
     Tempo = aTmp112; |HAZ BoraTempo;
     |CIERRA #112; |DELINDEX #112;
|FPRC;
----------------------------------------------------------
|PROCESO Mail; |TIPO 7;
     aAlfa = #0#8;
     |C_M #0#9, 1, aAlfa;
|FPRC;

|CALCULO tipo7; |TIPO 7;
     |SI Campo = 3;
          #0#5 = #0#6 % 704;
          |PINTA #0#5;
     |FINSI;
     |SI bloque = ""; |ACABA; |FINSI;
     #0#2 = "SI";
     |PTEC 802;
|FCAL;

|PROCESO Llena068; |TIPO 6;
     eaArticulo = #0Campo;
     |HAZ LlenaArticulo;
     |SI FSalida = 0;
          #0Campo = eaArticulo;
          |PINTA #0Campo;
     |SINO;
          |ERROR; |ACABA;
     |FINSI;
|FPRC;
-------------------------------------------------------------------------
|PROCESO Formatea;
     aFactor = "1" + ("0" * #42#8);
     nFactor = aFactor;
     nNume = nNume * nFactor;
     aAlfa = nNume;
     aAlfa = "000000" + aAlfa;
     |SI #42#8 = 0;
          aDeci = "";
     |SINO;
          nPos = -(#42#8 + 100);
          aDeci = aAlfa % nPos;
     |FINSI;
     nPos = -#42#8 - 1;
     aNume = aAlfa % nPos;
     nNume = aNume;
     |SI nNume = 0;
          aAlfa = " ";
     |SINO;
          |SI aDeci = "";
               aAlfa = nNume;
          |SINO;
               aAlfa = nNume + "," + aDeci;
          |FINSI;
     |FINSI;
     aAlfa = ("       " + aAlfa) % -107;
     aDato = aDato + " " + aAlfa;
|FPRC;

|PROCESO GrabaFichero;
     |SI nCabFichero = 0;
          nCabFichero = 1;
          fFecha = ~;
          aAlfa = "";
          |XGRABA nHandle, aAlfa;
          |SI enSwImp = 1;
               aAlfa = "INFORME DE DIFERENCIAS DE ARTICULOS         Fecha: " + fFecha;
               |XGRABA nHandle, aAlfa;
               aAlfa = "=============================================================";
               |XGRABA nHandle, aAlfa;
               aAlfa = "";
               |XGRABA nHandle, aAlfa;
               aAlfa1 = " Articulo             Descripcion                                 ";
               aAlfa2 = "          Pendiente Servir       Pendiente Recibir           Reser";
               aAlfa3 = "vado               Deposito                  Total                Disponible";
               aAlfa = aAlfa1 + aAlfa2 + aAlfa3;
               |XGRABA nHandle, aAlfa;
          |FINSI;
          |SI enSwImp = 2;
               aAlfa = "INFORME DE DIFERENCIAS DE ARTICULO/ALMACEN  Fecha: " + fFecha;
               |XGRABA nHandle, aAlfa;
               aAlfa = "=============================================================";
               |XGRABA nHandle, aAlfa;
               aAlfa = "";
               |XGRABA nHandle, aAlfa;
               aAlfa1 = " Articulo            Alma    Descripcion                                    P";
               aAlfa2 = "endiente Servir       Pendiente Recibir           Reservado               Dep";
               aAlfa3 = "osito                  Total                Disponible";
               aAlfa = aAlfa1 + aAlfa2 + aAlfa3;
               |XGRABA nHandle, aAlfa;
          |FINSI;
          |SI enSwImp = 3;
               aAlfa = "INFORME DE DIFERENCIAS DE PARTIDAS          Fecha: " + fFecha;
               |XGRABA nHandle, aAlfa;
               aAlfa = "=============================================================";
               |XGRABA nHandle, aAlfa;
               aAlfa = "";
               |XGRABA nHandle, aAlfa;
               aAlfa1 = " Articulo            Alma   Partida        Descripcion                      "
               aAlfa2 = "                                                                          D";
               aAlfa3 = "eposito                  Total                Disponible";
               aAlfa = aAlfa1 + aAlfa2 + aAlfa3;
               |XGRABA nHandle, aAlfa;
          |FINSI;
          aAlfa1 = "                                                                        I";
          aAlfa2 = "nicial   Final   Dife. Inicial   Final   Dife. Inicial   Final   Dife. In";
          aAlfa3 = "icial   Final   Dife. Inicial   Final   Dife. Inicial   Final   Dife.";
          aAlfa = aAlfa1 + aAlfa2 + aAlfa3;
          |XGRABA nHandle, aAlfa;
          aAlfa1 = "----------------------------------------------------------------------- -"
          aAlfa2 = "---------------------- ----------------------- ----------------------- --"
          aAlfa3 = "--------------------- ----------------------- -----------------------";
          aAlfa = aAlfa1 + aAlfa2 + aAlfa3;
          |XGRABA nHandle, aAlfa;
     |FINSI;
     |SI enSwImp = 1;
          aAlfa = #53#0 + " " + #53#1;
          aDato = aAlfa % 171;
          nNume = enPenSe1; |HAZ Formatea;
          nNume = enPenSe2; |HAZ Formatea;
          nNume = #53#15; |HAZ Formatea;
          nNume = enPenRe1; |HAZ Formatea;
          nNume = enPenRe2; |HAZ Formatea;
          nNume = #53#16; |HAZ Formatea;
          nNume = enReser1; |HAZ Formatea;
          nNume = enReser2; |HAZ Formatea;
          nNume = #53#12; |HAZ Formatea;
          nNume = enDepo1; |HAZ Formatea;
          nNume = enDepo2; |HAZ Formatea;
          nNume = #53#14; |HAZ Formatea;
          nNume = enTota1; |HAZ Formatea;
          nNume = enTota2; |HAZ Formatea;
          nNume = #53#6; |HAZ Formatea;
          nNume = enDispo1; |HAZ Formatea;
          nNume = enDispo2; |HAZ Formatea;
          nNume = #53#104; |HAZ Formatea;
          |XGRABA nHandle, aDato;
     |FINSI;
     |SI enSwImp = 2;
          aAlfa = #54#0 + " " + #54#1 + " " + #54#40;
          aDato = aAlfa % 171;
          nNume = enPenSe1; |HAZ Formatea;
          nNume = enPenSe2; |HAZ Formatea;
          nNume = #54#42; |HAZ Formatea;
          nNume = enPenRe1; |HAZ Formatea;
          nNume = enPenRe2; |HAZ Formatea;
          nNume = #54#43; |HAZ Formatea;
          nNume = enReser1; |HAZ Formatea;
          nNume = enReser2; |HAZ Formatea;
          nNume = #54#18; |HAZ Formatea;
          nNume = enDepo1; |HAZ Formatea;
          nNume = enDepo2; |HAZ Formatea;
          nNume = #54#10; |HAZ Formatea;
          nNume = enTota1; |HAZ Formatea;
          nNume = enTota2; |HAZ Formatea;
          nNume = #54#5; |HAZ Formatea;
          nNume = enDispo1; |HAZ Formatea;
          nNume = enDispo2; |HAZ Formatea;
          nNume = #54#39; |HAZ Formatea;
          |XGRABA nHandle, aDato;
     |FINSI;
     |SI enSwImp = 3;
          aAlfa = #24#0 + " " + #24#1 + " " + #24#2 + " " + #53#1;
          aDato = aAlfa % 171;
          nNume = enPenSe1; |HAZ Formatea;
          nNume = enPenSe2; |HAZ Formatea;
          nNume = #24#16; |HAZ Formatea;
          nNume = enPenRe1; |HAZ Formatea;
          nNume = enPenRe2; |HAZ Formatea;
          nNume = #24#29; |HAZ Formatea;
          nNume = 0; |HAZ Formatea;
          nNume = 0; |HAZ Formatea;
          nNume = 0; |HAZ Formatea;
          nNume = enDepo1; |HAZ Formatea;
          nNume = enDepo2; |HAZ Formatea;
          nNume = #24#20; |HAZ Formatea;
          nNume = enTota1; |HAZ Formatea;
          nNume = enTota2; |HAZ Formatea;
          nNume = #24#22; |HAZ Formatea;
          nNume = enDispo1; |HAZ Formatea;
          nNume = enDispo2; |HAZ Formatea;
          nNume = #24#31; |HAZ Formatea;
          |XGRABA nHandle, aDato;
     |FINSI;
|FPRC;

|PROCESO CopiaFicheros;
     |DFICE aPath;
     aOrg = aPath + "agifa019.dat"; aDes = aPath + "019.dat"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aPath + "agifa019.ddx"; aDes = aPath + "019.ddx"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aPath + "agifa019.ixx"; aDes = aPath + "019.ixx"; |COPIA_FICHERO aOrg, aDes;

     aOrg = aPath + "agifa017.dat"; aDes = aPath + "017.dat"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aPath + "agifa017.ddx"; aDes = aPath + "017.ddx"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aPath + "agifa017.ixx"; aDes = aPath + "017.ixx"; |COPIA_FICHERO aOrg, aDes;

     aOrg = aPath + "dsm00024.dat"; aDes = aPath + "024.dat"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aPath + "dsm00024.ddx"; aDes = aPath + "024.ddx"; |COPIA_FICHERO aOrg, aDes;
     aOrg = aPath + "dsm00024.ixx"; aDes = aPath + "024.ixx"; |COPIA_FICHERO aOrg, aDes;
|FPRC;

|PROCESO Compru024;
     #referen@#0 = #24#0;
     #referen@#1 = #24#1;
     #referen@#2 = #24#2;
     |LEE 000#referen@.=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |DDEFECTO #53;
     #53#0 = #24#0;
     |LEE 000#53=;

     enDepo2 = #24#20;
     enTota2 = #24#22;
     enPenSe2 = #24#16;
     enPenRe2 = #24#29;
     enDispo2 = #24#31;

     enDepo1 = #referen@#20;
     enTota1 = #referen@#22;
     enPenSe1 = #referen@#16;
     enPenRe1 = #referen@#29;
     enDispo1 = #referen@#31;

     #24#20 = #24#20 - #referen@#20;
     #24#22 = #24#22 - #referen@#22;
     #24#16 = #24#16 - #referen@#16;
     #24#29 = #24#29 - #referen@#29;
     #24#31 = #24#31 - #referen@#31;
     |SI #24#20 ! 0; |O #24#22 ! 0;
               |O #24#16 ! 0; |O #24#29 ! 0; |O #24#31 ! 0;
          nHay = 1;
          enSwImp = 3;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|PROCESO Compru017;
     #referen@#0 = #54#0;
     #referen@#1 = #54#1;
     |LEE 000#referen@.=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     enPenSe2 = #54#42;
     enPenRe2 = #54#43;
     enReser2 = #54#8;
     enDepo2 = #54#10;
     enTota2 = #54#5;
     enDispo2 = #54#39;

     enPenSe1 = #referen@#42;
     enPenRe1 = #referen@#43;
     enReser1 = #referen@#8;
     enDepo1 = #referen@#10;
     enTota1 = #referen@#5;
     enDispo1 = #referen@#39;

     #54#42 = #54#42 - #referen@#42;
     #54#43 = #54#43 - #referen@#43;
     #54#8 = #54#8 - #referen@#8;
     #54#10 = #54#10 - #referen@#10;
     #54#5 = #54#5 - #referen@#5;
     #54#39 = #54#39 - #referen@#39;
     |SI #54#42 ! 0; |O #54#43 ! 0; |O #54#8 ! 0; |O #54#10 ! 0;
               |O #54#5 ! 0; |O #54#39 ! 0;
          nHay = 1;
          enSwImp = 2;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|PROCESO Compru019;
     #referen@#0 = #53#0;
     |LEE 000#referen@.=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     enPenSe2 = #53#15;
     enPenRe2 = #53#16;
     enReser2 = #53#12;
     enDepo2 = #53#14;
     enTota2 = #53#6;
     enDispo2 = #53#104;

     enPenSe1 = #referen@#15;
     enPenRe1 = #referen@#16;
     enReser1 = #referen@#12;
     enDepo1 = #referen@#14;
     enTota1 = #referen@#6;
     enDispo1 = #referen@#104;

     #53#15 = #53#15 - #referen@#15;
     #53#16 = #53#16 - #referen@#16;
     #53#12 = #53#12 - #referen@#12;
     #53#14 = #53#14 - #referen@#14;
     #53#6 = #53#6 - #referen@#6;
     #53#104 = #53#104 - #referen@#104;
     |SI #53#15 ! 0; |O #53#16 ! 0; |O #53#12 ! 0; |O #53#14 ! 0;
               |O #53#6 ! 0; |O #53#104 ! 0;
          nHay = 1;
          enSwImp = 1;
          |HAZ Imprime;
     |FINSI;
|FPRC;

|DEFBUCLE Compru019;
     #53#1;
     ;
     #0#3;
     #0#4;
     ;
     NULL, Compru019;
|FIN;

|DEFBUCLE Compru017;
     #54#1;
     ;
     #0#3, 00001;
     #0#4, 99999;
     ;
     NULL, Compru017;
|FIN;

|DEFBUCLE Compru024;
     #24#1;
     ;
     #0#3, 00001, "               ";
     #0#4, 99999, "zzzzzzzzzzzzzzz";
     ;
     NULL, Compru024;
|FIN;


|PROCESO Imprime;
     |SI nPrime = 0;
          nPrime = 1;
          |SI aDirDestino = "";
               |IMPRE 0;
          |SINO;
            ||   Impresora = aFicMail;
            ||   |IMPRE -77;
               |XABRE "W", aFicMail, nHandle;
          |FINSI;
          nAbreImpre = FSalida;
          |SI FSalida = 0;
               |SI aDirDestino = "";    || sino es fichero !!
                    |INFOR "agifa068";
                    nAbreInfor = FSalida;
                    |SI FSalida ! 0;
                         |MENAV "0000No existe informe agifa068";
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI aDirDestino ! "";
          |SI nHandle ] 0; |HAZ GrabaFichero; |FINSI;
     |SINO;
          |SI nAbreInfor = 0; |PRINT; |FINSI;
     |FINSI;
|FPRC;

|PROCESO Diferencias;
     |MENSA "0000Chequeando diferencias...";
     nHandle = -1;
     nAbreInfor = 1;
     nAbreImpre = 1;
     nPrime = 0;

     |DFICE aFicMail;
     aFicMail = aFicMail + Usuario;
     |QBF aFicMail;
     aFicMail = aFicMail + ".txt";

     nCabFichero = 0;
     nHay = 0;
     |DDEF aDef;
     aDef = aDef + "agifa019";
     |CARGA_DEF aDef, referen@;
     |SI FSalida = 0;
          aAlfa = "019";
          |NOME_DAT #referen@#aAlfa#;
          |ABRE #referen@;
          |BUCLE Compru019;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
     |SI nAbreInfor = 0;
          |SI nHay ! 0; |PIEINF; |FINSI;
     |FINSI;
     nCabFichero = 0;
     nHay = 0;
     |DDEF aDef;
     aDef = aDef + "agifa017";
     |CARGA_DEF aDef, referen@;
     |SI FSalida = 0;
          aAlfa = "017";
          |NOME_DAT #referen@#aAlfa#;
          |ABRE #referen@;
          |BUCLE Compru017;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
     |SI nAbreInfor = 0;
          |SI nHay ! 0; |PIEINF; |FINSI;
     |FINSI;
     nCabFichero = 0;
     nHay = 0;
     |DDEF aDef;
     aDef = aDef + "dsm00024";
     |CARGA_DEF aDef, referen@;
     |SI FSalida = 0;
          aAlfa = "024";
          |NOME_DAT #referen@#aAlfa#;
          |ABRE #referen@;
          |ABRE #53;
          |BUCLE Compru024;
          |CIERRA #53;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
     |SI nAbreInfor = 0;
          |SI nHay ! 0; |PIEINF; |FINSI;
          |FININF;
     |FINSI;
     |SI nAbreImpre = 0; |Y aDirDestino = ""; || y si no es fichero
          |FINIMP;
     |FINSI;
     |SI enSwImp = 0; |Y aDirDestino = "";
          |MENAV "0000No hay diferencias...";
     |FINSI;
     |SI aDirDestino ! "";
          |XCIERRA nHandle;
          |HAZ EnviaMail;
          |FBORRA aFicMail;
     |FINSI;
|FPRC;

|PROCESO EnviaMail;
     |DFICE aEmp;
     aEmp = aEmp %- 205;
     aIP = "xdscorreo.dv.diagram.net";
     aServidor = "asmtp.diagram.es";
     aFrom = aDirDestino;
     aTo = aDirDestino;
     |SI enSwImp = 0;
          aSubject = "Recalculo stock empresa: " + aEmp + " (correcto)";
          aMensaje = "Sin diferencias.";
          |XABRE "W", aFicMail, nHandle;
          |XGRABA nHandle, aMensaje;
          |XCIERRA nHandle;
     |SINO;
          aSubject = "Recalculo stock empresa: " + aEmp + " (con diferencias)";
          aMensaje = "Adjunta diferencias encontradas.";
     |FINSI;
     aDjunto = aFicMail;
     |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
|FPRC;

||========================= BORRADO DE ARTICULOS ==========================
|PROCESO BorraParti;
     par_ereal = 0;
     par_ereal2= 0;
     par_sreal = 0;
     par_sreal2= 0;
     par_pser  = 0;
     par_pser2 = 0;
     par_depo  = 0;
     par_depo2 = 0;
     par_prec = 0;
     par_prec2 = 0;
     par_tota = 0;
     par_tota2 = 0;
     par_disp = 0;
     par_disp2 = 0;
     par_depoc = 0;
     par_depoc2 = 0;
     par_proc = 0;
     par_proc2 = 0;
     #24#33 = 0;
     |SI nSwMecanogra = 0;
          #24#24 = 0;
     |FINSI;
     |GRABA 020#24a;
|FPRC;

|DEFBUCLE dsm00024;
     #24#1;
     ;
     #0#3, 00001, "                              ";
     #0#4, 99999, "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
     be;
     NULL, BorraParti;
|FIN;

|PROCESO borraarti;
     #53#194 = 1; ||Factu Venta
     #53#196 = 1; ||Factu Comp
     |SI #53#179 = "S";
          |DDEFECTO #238;
          #238#0 = #53#201;
          |LEE 000#238=;
          #53#188 = #238#8; ||Tipo
          #53#192 = #238#13;||Divisor
          #53#194 = #238#6; ||Factu Venta
          #53#196 = #238#7; ||Factu Comp
          #53#197 = #238#12; ||Pedir medidas
     |FINSI;

     |SI nSwAlbadis = 0;
          #53#196 = 2; ||Factu Comp
     |FINSI;

     |PARA nCampo = 32; |SI nCampo [ 96; |HACIENDO nCampo = nCampo + 5;
          #53nCampo = 0;
          nCamp0 = nCampo + 2;
          #53nCamp0 = 0;
     |SIGUE;

     art_pser = 0;
     art_pser2= 0;
     art_prec = 0;
     art_prec2= 0;
     art_nece = 0;
     art_rese = 0;
     art_depo = 0;
     art_depo2= 0;
     art_fabr = 0;
     art_vsto = 0;
     art_tota = 0;
     art_tota2= 0;
     art_disp = 0;
     art_disp2 = 0;
     art_mini = 0;
     art_maxi = 0;
     art_depoc = 0;
     art_depoc2 = 0;

     |SI nSwSanchez = 0;
          |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
     |SINO;
          |GRABA 020#53a;
     |FINSI;
|FPRC;

|DEFBUCLE agifa019;
     #53#1;
     ;
     #0#3;
     #0#4;
     be;
     NULL , borraarti;
|FIN;

|PROCESO borraalma;
     |PDEFECTO #54, 11, 39;
     alm_nece = 0;
     alm_pser = 0;
     alm_pser2= 0;
     alm_prec = 0;
     alm_prec2= 0;
     alm_rese = 0;
     alm_depo = 0;
     alm_depo2= 0;
     alm_fabr = 0;
     alm_vsto = 0;
     alm_tota = 0;
     alm_tota2= 0;
     alm_disp = 0;
     alm_disp2 = 0;
     alm_depoc = 0;
     alm_depo2 = 0;
     |GRABA 020#54a;
     |LIBERA #54;
|FPRC;

|DEFBUCLE agifa017;
     #54#1;
     ;
     #0#3 , 00001;
     #0#4 , 99999;
     be;
     NULL , borraalma;
|FIN;

|PROCESO BorraCompo;
     |PDEFECTO #904, 4, 14;
     #904#24 = 0;
     |GRABA 020#904a;
     |LIBERA #904;
|FPRC;

|DEFBUCLE dsm00004;
     #904#1;
     ;
     #0#3, 00000, "      ";
     #0#4, 99999, "zzzzzz";
     be;
     NULL, BorraCompo;
|FIN;

|PROCESO LeeParti;
     |SI PARTI = "N"; |ACABA; |FINSI;

     #24#0 = articul;
     #24#1 = almacen;
     #24#2 = aParti;
     |LEE 101#24=;
     |SI FSalida ! 0; |Y #0#7 = "S";
          |DDEFECTO #24;
          #24#0 = articul;
          #24#1 = almacen;
          #24#2 = aParti;
          |GRABA 020#24b;
     |FINSI;
     nHayParti = FSalida;
|FPRC;

|PROCESO LeeAlma;
     #54#0 = articul;
     #54#1 = almacen;
     |LEE 101#54=;
     |SI FSalida ! 0; |Y #0#7 = "S";
          |DDEFECTO #1;
          |ABRE #1;
          #1#0 = almacen;
          |LEE 000#1=;
          |SI FSalida ! 0;
               |GRABA 020#1n;
          |FINSI;
          |CIERRA #1;

          |DDEFECTO #54;
          #54#0 = articul;
          #54#1 = almacen;
          #54#40 = #53#1;
          #54#41 = #1#1;
          |GRABA 020#54b;
     |FINSI;
     nHayAlma = FSalida;
|FPRC;

|PROCESO LeeArti;
     #53#0 = articul;
     |LEE 101#53=;
     |SI FSalida ! 0; |Y #0#7 = "S";
         |DDEFECTO #53;
         #53#0 = articul;
         |GRABA 020#53b;
     |FINSI;
     nHayArti = FSalida;
|FPRC;

|PROCESO MaxMini;
     articul = #54#0;
     |HAZ LeeArti;
     |SI nHayArti = 0;
          art_mini = art_mini + alm_mini;
          art_maxi = art_maxi + alm_maxi;
           |SI nSwSanchez = 0;
               |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
           |SINO;
               |GRABA 020#53a;
           |FINSI;
     |FINSI;
     |LIBERA #53;
|FPRC;


|DEFBUCLE MaxMini;
     #54#1;
     ;
     #0#3, 00001;
     #0#4, 99999;
     ;
     NULL, MaxMini;
|FIN;

|PROCESO CompoVenta;
     |DDEFECTO #904;
     #904#0 = #906#0;
     #904#1 = #906#1;
     #904#2 = #906#7;
     |LEE 101#904=;
     |SI FSalida ! 0; |GRABA 020#904b; |FINSI;

     #904#13 = #904#13 + #906#9;
     #904#12 = #904#12 + #906#9;

     nNume = #904#12 - #904#6;
     |SI nNume > 0;
         #904#24 = nNume * art_pcm;
     |SINO;
         #904#24 = 0;
     |FINSI;

     |GRABA 020#904a;
     |LIBERA #904;

     nCanV = nCanV + #906#9;
|FPRC;

|DEFBUCLE dsm00006V;
     #906#1;
     ;
     #17#0, #17#5, #17#1, #17#2, #17#11, #17#3, #17#4, "      ";
     #17#0, #17#5, #17#1, #17#2, #17#11, #17#3, #17#4, "zzzzzz";
     ;
     NULL, CompoVenta;
|FIN;

|PROCESO CompoEntrada;
     |DDEFECTO #904;
     #904#0 = #906#0;
     #904#1 = #906#1;
     #904#2 = #906#7;
     |LEE 101#904=;
     |SI FSalida ! 0; |GRABA 020#904b; |FINSI;

     #904#13 = #904#13 + #906#9;
     #904#12 = #904#12 + #906#9;

     nNume = #904#12 - #904#6;
     |SI nNume > 0;
         #904#24 = nNume * art_pcm;
     |SINO;
         #904#24 = 0;
     |FINSI;

     |GRABA 020#904a;
     |LIBERA #904;

     nCanV = nCanV + #906#9;
|FPRC;

|DEFBUCLE dsm00006E;
     #906#1;
     ;
     #17#0, #17#5, #17#1, #17#2, #17#11, #17#3, #17#4, "      ";
     #17#0, #17#5, #17#1, #17#2, #17#11, #17#3, #17#4, "zzzzzz";
     ;
     NULL, CompoEntrada;
|FIN;

|PROCESO ent_sal; || <ES> Entrada Stock/ <SS> Salida Stock
     |SI #17#1 ] #0#0; |Y #17#1 [ #0#1;
          art_disp = art_disp + #17#6;
          art_disp2 = art_disp2 + nCanti2;
          art_tota = art_tota + #17#6;
          art_tota2 = art_tota2 + nCanti2;

          alm_disp = alm_disp + #17#6;
          alm_disp2 = alm_disp2 + nCanti2;
          alm_tota = alm_tota + #17#6;
          alm_tota2 = alm_tota2 + nCanti2;

          par_disp = par_disp + #17#6;
          par_disp2 = par_disp2 + nCanti2;
          par_tota = par_tota + #17#6;
          par_tota2 = par_tota2 + nCanti2;

          |SI aOpe = "ES";
               par_ereal = par_ereal + canti;
               par_ereal2 = par_ereal2 + nCanti2;
          |FINSI;
          |SI aOpe = "SS";
               par_sreal = par_sreal - canti;
               par_sreal2 = par_sreal2 - nCanti2;
          |FINSI;
          |HAZ ValoraStock;
     |FINSI;

     |SI #17#1 ] fDCurso ; |Y #17#1 [ fHCurso;
          fmes = #17#1 % 402; mes = fmes - 1; mes = mes * 2;
          |SI #17#2 = "SS";
              |SI #53#194 = 1; nUni0 = #17#6; |SINO; nUni0 = #17#17; |FINSI;
              mes = mes + 11;
         ||*     |SI #17#1 ] fecact;
                  #54#35 = #54#35 + (nUni0 * menos);
                  #54mes = #54mes + (nUni0 * menos);
         ||     |SINO;
         ||         #54#37 = #54#37 + (nUni0 * menos);
         ||     |FINSI;
          |SINO;
              |SI #53#196 = 1; nUni0 = #17#6; |SINO; nUni0 = #17#17; |FINSI;
              mes = mes + 12;
         ||*     |SI #17#1 ] fecact;
                  #54#36 = #54#36 + nUni0;
                  #54mes = #54mes + nUni0;
         ||     |SINO;
         ||         #54#38 = #54#38 + nUni0;
         ||     |FINSI;
          |FINSI;
     |FINSI;

     |SI #17#1 ] #0#0; |Y #17#1 [ #0#1;
          nCanV = 0;
          |ABRE #904;
          |BUCLE dsm00006E;
          |CIERRA #904;
     |FINSI;
|FPRC;

|PROCESO santerior;      || <SA> Saldo Anterior
     |SI #17#1 ] #0#0; |Y #17#1 [ #0#1;
          art_disp = art_disp + #17#6;
          art_disp2 = art_disp2 + nCanti2;

          art_tota = art_tota + #17#6;
          |HAZ ValoraStock;
     |FINSI;
|FPRC;

|PROCESO mov_alm; || <"TE"> <"TS"> <"ME"> <"MS"> <"SA">
     |SI #17#1 ] #0#0; |Y #17#1 [ #0#1;
          art_disp = art_disp + #17#6;
          art_disp2 = art_disp2 + nCanti2;

          art_tota = art_tota + #17#6;
          art_tota2 = art_tota2 + nCanti2;

          alm_disp = alm_disp + #17#6;
          alm_disp2 = alm_disp2 + nCanti2;

          alm_tota = alm_tota + #17#6;
          alm_tota2 = alm_tota2 + nCanti2;

          par_disp = par_disp + #17#6;
          par_disp2 = par_disp2 + nCanti2;
          par_tota = par_tota + #17#6;
          par_tota2 = par_tota2 + nCanti2;

          |SI aOpe = "ME"; |O aOpe = "SA"; |O aOpe = "TE";
               par_ereal = par_ereal + canti;
               par_ereal2 = par_ereal2 + nCanti2;
          |FINSI;
          |SI aOpe = "MS";
               || Cambiado por Abdon el 21/07/2004
               || Las unidades en este movimiento son negativas. Por eso
               || no puedo sumarlas a las salidas , tengo que restarlas
               || para que las salidas se incrementen, no se decrementen
               ||
               || par_sreal = par_sreal + canti;
               || par_sreal2 = par_sreal2 + nCanti2;
               par_sreal = par_sreal - canti;
               par_sreal2 = par_sreal2 - nCanti2;
          |FINSI;

          |HAZ ValoraStock;
     |FINSI;

     |SI #17#1 ] fDCurso ; |Y #17#1 [ fHCurso;
          |SI aOpe = "ME";
               fmes = #17#1 % 402; mes = fmes - 1; mes = mes * 2;
               mes = mes + 12;
               |SI #53#196 = 1; nUni0 = #17#6; |SINO; nUni0 = #17#17; |FINSI;
                ||* |SI #17#1 ] fecact;
                    #54#36 = #54#36 + nUni0;
                    #54mes = #54mes + nUni0;
                |||SINO;
                ||    #54#38 = #54#38 + nUni0;
                |||FINSI;
          |SINO;
               |SI aOpe ! "SA";
                    fmes = #17#1 % 402; mes = fmes - 1; mes = mes * 2;
                    mes = mes + 11;
                    |SI #53#194 = 1; nUni0 = #17#6; |SINO; nUni0 = #17#17; |FINSI;
                     ||* |SI #17#1 ] fecact;
                         #54#35 = #54#35 - nUni0;
                         #54mes = #54mes - nUni0;
                     |||SINO;
                     ||    #54#37 = #54#37 - nUni0;
                     |||FINSI;
                |FINSI;
          |FINSI;
     |FINSI;

     |SI #17#1 ] #0#0; |Y #17#1 [ #0#1;
          nCanV = 0;
          |ABRE #904;
          |BUCLE dsm00006V;
          |CIERRA #904;
     |FINSI;
|FPRC;

|PROCESO CompoCompra;
     |DDEFECTO #904;
     #904#0 = #906#0;
     #904#1 = #906#1;
     #904#2 = #906#7;
     |LEE 101#904=;
     |SI FSalida ! 0; |GRABA 020#904b; |FINSI;

     #904#13 = #904#13 + #906#9;
     #904#12 = #904#12 + #906#9;

     nNume = #904#12 - #904#6;
     |SI nNume > 0;
         #904#24 = nNume * art_pcm;
     |SINO;
         #904#24 = 0;
     |FINSI;

     |GRABA 020#904a;
     |LIBERA #904;

     nCanV = nCanV + #906#9;
|FPRC;

|DEFBUCLE dsm00006C;
     #906#1;
     ;
     #17#0, #17#5, #17#1, #17#2, #17#11, #17#3, #17#4, "      ";
     #17#0, #17#5, #17#1, #17#2, #17#11, #17#3, #17#4, "zzzzzz";
     ;
     NULL, CompoCompra;
|FIN;

|PROCESO compras; || <AC> <BC> <EV> <FB>
     |SI #17#1 ] #0#0; |Y #17#1 [ #0#1;
          art_disp = art_disp + canti;
          art_disp2 = art_disp2 + nCanti2;
          art_tota = art_tota + canti;
          art_tota2 = art_tota2 + nCanti2;

          alm_disp = alm_disp + canti;
          alm_disp2 = alm_disp2 + nCanti2;
          alm_tota = alm_tota + canti;
          alm_tota2 = alm_tota2 + nCanti2;

          par_disp = par_disp + canti;
          par_disp2 = par_disp2 + nCanti2;
          par_tota = par_tota + canti;
          par_tota2 = par_tota2 + nCanti2;

          |SI nSwAlbero ! 0;
               par_ereal = par_ereal + canti;
               par_ereal2 = par_ereal2 + nCanti2;
          |SINO; || Caso especial Modulo Albero
               |SI canti < 0; |O nCanti2 < 0;
                    par_sreal = par_sreal - canti;
                    par_sreal2 = par_sreal2 - nCanti2;
               |SINO;
                    par_ereal = par_ereal + canti;
                    par_ereal2 = par_ereal2 + nCanti2;
               |FINSI;
          |FINSI;
          |HAZ ValoraStock;
     |FINSI;

     |SI #17#1 ] fDCurso ; |Y #17#1 [ fHCurso;
          |SI #17#2 ! "FB";
               |SI #53#196 = 1; nUni0 = #17#6; |SINO; nUni0 = #17#17; |FINSI;
               fmes = #17#1 % A402;
               mes = fmes - 1;
               mes = mes * 5;
               mes = mes + 32;
          ||     |SI #17#1 ] fecact;
                   #53mes = #53mes + nUni0;    || unidades compradas
                   #53#92 = #53#92 + nUni0;    || total unidades
          ||     |SINO;
          ||         #53#97 = #53#97 + nUni0;    || total unidades
          ||     |FINSI;

               mes = fmes - 1;
               mes = mes * 2;
               mes = mes + 12;
          ||     |SI #17#1 ] fecact;
                   #54mes = #54mes + nUni0;
                   #54#36 = #54#36 + nUni0;
          ||     |SINO;
          ||         #54#38 = #54#38 + nUni0;
          ||     |FINSI;
          |FINSI;
     |FINSI;

     |SI #17#1 ] #0#0; |Y #17#1 [ #0#1;
          nCanV = 0;
          |ABRE #904;
          |BUCLE dsm00006C;
          |CIERRA #904;
     |FINSI;
|FPRC;

|PROCESO ventas; || <"AV"> <"BV"> <"FC"> <"TI">
     |SI #17#1 ] #0#0; |Y #17#1 [ #0#1;
          art_disp = art_disp + #17#6;
          art_disp2 = art_disp2 + nCanti2;
          art_tota = art_tota + #17#6;
          art_tota2 = art_tota2 + nCanti2;

          alm_disp = alm_disp + #17#6;
          alm_disp2 = alm_disp2 + nCanti2;
          alm_tota = alm_tota + #17#6;
          alm_tota2 = alm_tota2 + nCanti2;

          par_disp = par_disp + #17#6;
          par_disp2 = par_disp2 + nCanti2;
          par_tota = par_tota + #17#6;
          par_tota2 = par_tota2 + nCanti2;

          par_sreal = par_sreal - #17#6;
          par_sreal2 = par_sreal2 - nCanti2;
          |HAZ ValoraStock;
     |FINSI;

     |SI #17#1 ] fDCurso ; |Y #17#1 [ fHCurso;
          |SI #17#2 ! "SF";
               |SI #53#194= 1; nUni0 = #17#6; |SINO; nUni0 = #17#17; |FINSI;
               fmes = #17#1 % A402;
               mes = fmes - 1;
               mes = mes * 5;
               mes = mes + 34;
          ||     |SI #17#1 ] fecact;
                   #53mes = #53mes + (nUni0 * menos);
                   mes = mes + 1;
                   #53#94 = #53#94 + (nUni0 * menos);
          ||     |SINO;
          ||         #53#99 = #53#99 + (nUni0 * menos);
          ||     |FINSI;

               mes = fmes - 1;
               mes = mes * 2;
               mes = mes + 11;
          ||     |SI #17#1 ] fecact;
                   #54mes = #54mes + (nUni0 * menos);
                   #54#35 = #54#35 + (nUni0 * menos);
          ||     |SINO;
          ||         #54#37 = #54#37 + (nUni0 * menos);
          ||     |FINSI;
          |FINSI;
     |FINSI;

     |SI #17#1 ] #0#0; |Y #17#1 [ #0#1;
          nCanV = 0;
          |ABRE #904;
          |BUCLE dsm00006V;
          |CIERRA #904;
     |FINSI;
|FPRC;

|PROCESO mirahist;
     |SI nSwPCEGroup = 0; |Y #17#2 = "AV";
          |SI #17#11 ] "Z    ";
               |ACABA;
          |FINSI;
     |FINSI;

     |SI #17#2 = "DP"; |O #17#2 = "DV"; |ACABA; |FINSI;

     articul = #17#0; almacen = #17#5; canti = #17#6;
     aParti = #17#18; nCanti2 = #17#17; aOpe = #17#2;

     |HAZ LeeArti;
     |HAZ LeeAlma;
     |HAZ LeeParti;
     ||    |SI MULTI = "S"; canti = nCanti2; nCanti2 = 0; |FINSI;

     |SI #17#2 = "ES";|O #17#2 = "SS";
          |HAZ ent_sal;
     |FINSI;

     |SI #17#2 = "TE"; |O #17#2 = "TS";|O #17#2 = "ME"; |O #17#2 = "MS";|O #17#2 = "SA";
          |HAZ mov_alm;
     |FINSI;

     |SI #17#2 = "AC";|O #17#2 = "BC";|O #17#2 = "EV"; |O #17#2 = "FB";
          |HAZ compras;
     |FINSI;

     |SI #17#2 = "AV";|O #17#2 = "BV";|O #17#2 = "FC";|O #17#2 = "TI";
               |O #17#2 = "OR"; |O #17#2 = "SF";
          |HAZ ventas;
     |FINSI;

     |HAZ ValoraStock;

     |SI nSwSanchez = 0;
         |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
     |SINO;
         |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
     |FINSI;

     |SI nHayAlma = 0; |GRABA 020#54a; |FINSI;
     |SI nHayParti = 0; |Y PARTI = "S"; |GRABA 020#24a; |FINSI;
     |LIBERA #24;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|DEFBUCLE historico;
     #17#1;
     ;
     #0#3, fDesde, "  ",       0,     0, "     ";
     #0#4, fHasta, "zz",  999999, 99999, "zzzzz";
     ;
     NULL , mirahist;
|FIN;
|| --------------------  PEDIDOS VENTA
|PROCESO dsm00046;
     articul = #946#3;
     almacen = #946#4;
     canti   = #3#5 - #3#43;
     nCanti2 = canti * #946#9;
     canti   = canti * #946#5;

     |HAZ LeeArti;
     |HAZ LeeAlma;

     art_pser = art_pser + canti;
     art_pser2 = art_pser2 + nCanti2;
     alm_pser = alm_pser + canti;
     alm_pser2 = alm_pser2 + nCanti2;

     |SI #3#22 = "S";
          art_disp = art_disp - canti;
          art_disp2 = art_disp2 - nCanti2;
          art_rese = art_rese + canti;
          alm_disp = alm_disp - canti;
          alm_disp2 = alm_disp2 - nCanti2;
          alm_rese = alm_rese + canti;
     |FINSI;

     |HAZ ValoraStock;

     |SI nSwSanchez = 0;
         |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
     |SINO;
         |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
     |FINSI;

     |SI nHayAlma = 0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|DEFBUCLE dsm00046;
     #946#1;
     3;
     #3#28, #3#0, #3#1, 001, #0#3;
     #3#28, #3#0, #3#1, 999, #0#4;
     ;
     NULL, dsm00046;
|FIN;

|PROCESO pedive_a;
     |HAZ LeeArti;
     |HAZ LeeAlma;
     |HAZ LeeParti;
||     |SI MULTI = "S"; canti = nCanti2; nCanti2 = 0; |FINSI;

     art_pser = art_pser + canti;
     alm_pser = alm_pser + canti;
     par_pser = par_pser + canti;
     art_pser2 = art_pser2 + nCanti2;
     alm_pser2 = alm_pser2 + nCanti2;
     par_pser2 = par_pser2 + nCanti2;
     |SI #3#22 = "S";
         art_rese = art_rese + canti;
         art_disp = art_disp - canti;
         art_disp2 = art_disp2 - nCanti2;
         alm_rese = alm_rese + canti;
         alm_disp = alm_disp - canti;
         alm_disp2 = alm_disp2 - nCanti2;
         par_disp = par_disp - canti;
         par_disp2 = par_disp2 - nCanti2;
     |FINSI;

     |HAZ ValoraStock;

     |SI nSwSanchez = 0;
         |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
     |SINO;
         |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
     |FINSI;

     |SI nHayAlma = 0; |GRABA 020#54a; |FINSI;
     |SI nHayParti = 0; |Y PARTI = "S"; |GRABA 020#24a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
     |LIBERA #24;
|FPRC;

|PROCESO CompoPVentas;        || (7)
     |DDEFECTO #904;
     #904#0 = #3#2;
     #904#1 = #3#3;
     #904#2 = #905#4;
     |LEE 101#904=;
     |SI FSalida ! 0; |GRABA 020#904b; |FINSI;

     nCanV = nCanV + (#905#6-#905#12);

     #904#4 = #904#4  + (#905#6-#905#12);
     |SI #3#22 = "S";
          #904#13 = #904#13 - (#905#6 - #905#12);
          #904#7 = #904#7 + (#905#6 - #905#12);
     |FINSI;

     nNume = #904#12 - #904#6;
     |SI nNume > 0;
         #904#24 = nNume * art_pcm;
     |SINO;
         #904#24 = 0;
     |FINSI;

     |GRABA 020#904a;
     |LIBERA #904;
|FPRC;

|DEFBUCLE dsm00005PV;
     #905#1;
     ;
     "PV", #3#28, #3#0, nLinV, "      ";
     "PV", #3#28, #3#0, nLinV, "zzzzzz";
     ;
     NULL, CompoPVentas;
|FIN;

|PROCESO pedido;
     |SI #3#2 ] #0#3; |Y #3#2 [ #0#4;
          nCanV = 0;
          |ABRE #904;
          nLinV = #3#1;
          |BUCLE dsm00005PV;
          |CIERRA #904;
/*
          #2#25 = #3#28;
          #2#0 = #3#0;
          |LEE 000#2=;
*/
          canti = #3#5 - #3#43;


          nCanti2 = #3#44 - #3#49

          scanti  = #3#5 - #3#43;
          sCanti2  = #3#44 - #3#49;
          articul = #3#2;
          almacen = #3#3;
          aParti = #3#45;
          |HAZ pedive_a; || Actualiza el principal

          |BUCLE dsm00046;
     |FINSI;
|FPRC;
/*
|DEFBUCLE pedido;   || No se puede acotar por la clave del articulo
     #3#1;          ||por los kits/escandallos
     ;
     INICIO;
     FINAL;
     ;
     NULL, pedido;
|FIN;
*/

|DEFBUCLE pedido;
     #2#7;
     ;
     #0#0, "      ", 0000, "     ", 000001;
     #0#1, "zzzzzz", 9999, "zzzzz", 999999;
     ;
     NULL, NULL, pedido;
|FIN;

|| -------------------------------------------------------------------------
|| -------------------- PEDIDOS COMPRA

|PROCESO CompoPCompras;
     |DDEFECTO #904;
     #904#0 = #4#2;
     #904#1 = #4#3;
     #904#2 = #905#4;
     |LEE 101#904=;
     |SI FSalida ! 0; |GRABA 020#904b; |FINSI;

     nCanV  = nCanV + (#905#6 - #905#12);

     #904#5  = #904#5 + (#905#6 - #905#12);

     nNume = #904#12 - #904#6;
     |SI nNume > 0;
         #904#24 = nNume * art_pcm;
     |SINO;
         #904#24 = 0;
     |FINSI;

     |GRABA 020#904a;
     |LIBERA #904;
|FPRC;

|DEFBUCLE dsm00005PC;
     #905#1;
     ;
     "PC", #4#28, #4#0, nLinV, "      ";
     "PC", #4#28, #4#0, nLinV, "zzzzzz";
     ;
     NULL, CompoPCompras;
|FIN;

|PROCESO dsm00065;
     articul = #965#3;
     almacen = #965#4;
     canti   = #4#5 - #4#38;
     canti = canti * #965#5;

     |HAZ LeeArti;
     |HAZ LeeAlma;

     art_prec = art_prec + canti;

     alm_prec = alm_prec + canti;

     |HAZ ValoraStock;

     |SI nSwSanchez = 0;
         |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
     |SINO;
         |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
     |FINSI;

     |SI nHayAlma = 0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|DEFBUCLE dsm00065;
     #965#1;
     3;
     #4#28, #4#0, #4#1, 001, #0#3;
     #4#28, #4#0, #4#1, 999, #0#4;
     ;
     NULL, dsm00065;
|FIN;

|PROCESO pedicom;
     |SI #4#2 ] #0#3; |Y #4#2 [ #0#4;
          nCanV = 0;
          |ABRE #904;
          nLinV = #4#1;
          |BUCLE dsm00005PC;
          |CIERRA #904;

          articul = #4#2;
          almacen = #4#3;
          aParti = #4#42;
          canti   = #4#5 - #4#38;
          nCanti2 = #4#41 - #4#46;

          |HAZ LeeArti;
          |HAZ LeeAlma;
          |HAZ LeeParti;
     ||     |SI MULTI = "S"; canti = nCanti2; nCanti2 = 0; |FINSI;

          art_prec = art_prec + canti;
          art_prec2 = art_prec2 + nCanti2;

          alm_prec = alm_prec + canti;
          alm_prec2 = alm_prec2 + nCanti2;

          par_prec = par_prec + canti;
          par_prec2 = par_prec2 + nCanti2;

          |HAZ ValoraStock;

          |SI nSwSanchez = 0;
              |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
          |SINO;
              |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
          |FINSI;

          |SI nHayAlma = 0; |GRABA 020#54a; |FINSI;
          |SI nHayParti = 0; |Y PARTI = "S"; |GRABA 020#24a; |FINSI;
          |LIBERA #24;
          |LIBERA #53;
          |LIBERA #54;

          |BUCLE dsm00065;
     |FINSI;
|FPRC;
/*
|DEFBUCLE pedicom;  || No se puede  acotar por la clave del articulo
     #4#1;          || por los kits o escandallos
     ;
     INICIO;
     FINAL;
     e;
     NULL,pedicom;
|FIN;
*/

|DEFBUCLE pedicom;
     #81#1;
     1;
     "     ", 000001, #0#0;
     "zzzzz", 999999, #0#1;
     ;
     NULL, NULL, pedicom;
|FIN;

|| -------------------------------------------------------------------------
|| -------------------- Actualiza los Depositos

|PROCESO CompoDepo;
     |DDEFECTO #904;
     #904#0 = #5#2;
     #904#1 = #5#3;
     #904#2 = #905#4;
     |LEE 101#904=;
     |SI FSalida ! 0; |GRABA 020#904b; |FINSI;

     #904#13 = #904#13 - #905#6;
     #904#8  = #904#8  + #905#6;

     nNume = #904#12 - #904#6;
     |SI nNume > 0;
         #904#24 = nNume * art_pcm;
     |SINO;
         #904#24 = 0;
     |FINSI;

     |GRABA 020#904a;
     |LIBERA #904;
|FPRC;

|DEFBUCLE dsm00005DP;
     #905#1;
     ;
     "DP", #5#22, #5#0, nLinV, "      ";
     "DP", #5#22, #5#0, nLinV, "zzzzzz";
     ;
     NULL, CompoDepo;
|FIN;

|PROCESO dsm00049;
     articul = #949#3;
     almacen = #949#4;
     canti   = #5#5;
     nCanti2 = canti * #949#9;
     canti   = canti * #949#5;

     |HAZ LeeAlma;
     |HAZ LeeArti;

     #53#14 = #53#14 + canti;
     #53#184 = #53#184 + nCanti2;
     #53#104 = #53#104 - canti;
     #53#193 = #53#193 - nCanti2;

     |HAZ ValoraStock;

     |SI nSwSanchez = 0;
         |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
     |SINO;
         |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
     |FINSI;

     |SI nHayAlma = 0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|DEFBUCLE dsm00049;
     #949#1;
     3;
     #5#22, #5#0, #5#1, 001, #0#3;
     #5#22, #5#0, #5#1, 999, #0#4;
     ;
     NULL, dsm00049;
|FIN;

|PROCESO deposi_a;
     |HAZ LeeArti;
     |HAZ LeeAlma;
     |HAZ LeeParti;
||     |SI MULTI = "S"; canti = nCanti2; nCanti2 = 0; |FINSI;

     art_depo = art_depo + canti;
     art_depo2 = art_depo2 + nCanti2;
     art_disp = art_disp - canti;
     art_disp2 = art_disp2 - nCanti2;

     alm_depo = alm_depo + canti;
     alm_depo2 = alm_depo2 + canti;
     alm_disp = alm_disp - canti;
     alm_disp2 = alm_disp2 - nCanti2;

     par_depo = par_depo + canti;
     par_depo2 = par_depo2 + canti;
     par_disp = par_disp - canti;
     par_disp2 = par_disp2 - nCanti2;

     |HAZ ValoraStock;

     |SI nSwSanchez = 0;
         |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
     |SINO;
         |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
     |FINSI;

     |SI nHayAlma = 0; |GRABA 020#54a; |FINSI;
     |SI nHayParti = 0; |Y PARTI = "S"; |GRABA 020#24a; |FINSI;
     |LIBERA #24;
     |LIBERA #53;
     |LIBERA #54;

     |ABRE #904;
     nLinV = #5#1;
     |BUCLE dsm00005DP;
     |CIERRA #904;
|FPRC;

|PROCESO deposi;
     |SI #5#2 ] #0#3; |Y #5#2 [ #0#4;
          scanti  = #5#5;
          sCanti2  = #5#28;
          canti   = #5#5;
          nCanti2   = #5#28;
          articul = #5#2;
          almacen = #5#3;
          aParti = #5#29;
          |HAZ deposi_a; || Actualiza el principal

          |BUCLE dsm00049;
     |FINSI;
|FPRC;
/*
|DEFBUCLE deposito;
     #5#1;
     ;
     INICIO;
     FINAL;
     e;
     NULL, deposi;
|FIN;
*/
|DEFBUCLE deposito;
     #360#3;
     ;
     "      ", #0#0, "     ", 000001;
     "zzzzzz", #0#1, "zzzzz", 999999;
     ;
     NULL, NULL, deposi;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO dsm00052;
     |SI #52#3 < #0#3; |O #52#3 > #0#4; |ACABA; |FINSI;

     articul = #52#3;
     almacen = #52#5;
     aParti = #52#8;
     |HAZ LeeArti;
     |HAZ LeeAlma;
     |HAZ LeeParti;

     |SI #6#10 = "S";    || Orden Finalizada   (no entra!!!!)
     |SINO;
          nDiferencia = #52#4 - #52#7;
          nDiferencia2 = #52#9 - #52#10;

          art_disp = art_disp - nDiferencia;
          art_disp2 = art_disp2 - nDiferencia2;

          alm_disp = alm_disp - nDiferencia;
          alm_disp2 = alm_disp2 - nDiferencia2;

          art_rese = art_rese + nDiferencia;
          alm_rese = alm_rese + nDiferencia;

          par_disp = par_disp - nDiferencia;
          par_disp2 = par_disp2 - nDiferencia2;
          par_sreal = par_sreal + nDiferencia;
          par_sreal2 = par_sreal2 + nDiferencia2;
     |FINSI;
     |HAZ ValoraStock;

     |SI nSwSanchez = 0;
         |SI #54#1 ! 0; |GRABA 020#53a;    |FINSI;
     |SINO;
         |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
     |FINSI;

     |SI nHayAlma = 0; |GRABA 020#54a; |FINSI;
     |SI nHayParti = 0; |Y PARTI = "S"; |GRABA 020#24a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
     |LIBERA #24;
|FPRC;

|DEFBUCLE dsm00052;
     #52#1;
     ;
     #8#9, #8#0, #8#1, 001;
     #8#9, #8#0, #8#1, 999;
     ;
     NULL, dsm00052;
|FIN;

|PROCESO dsm00067;  || Producto Acabado no tiene doble stock!!!!
     articul = #8#2;
     almacen = #8#7;
     aParti = #67#3;
     |HAZ LeeArti;
     |HAZ LeeAlma;
     |HAZ LeeParti;

/*
     ||Esto ya se tiene en cuenta en los movimientos FB y SF
     art_disp = art_disp + #67#4;
     art_tota = art_tota + #67#4;

     alm_disp = alm_disp + #67#4;
     alm_tota = alm_tota + #67#4;

     par_disp = par_disp + #67#4;
     par_tota = par_tota + #67#4;
     par_ereal = par_ereal + #67#4;
*/

     |SI nSwGestral = 0;
          par_disp = par_disp + #67#4;
          par_tota = par_tota + #67#4;
          par_ereal = par_ereal + #67#4;
     |FINSI;

     art_fabr = art_fabr - #67#4;
     alm_fabr = alm_fabr - #67#4;

     |HAZ ValoraStock;

     |SI nSwSanchez = 0;
         |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
     |SINO;
         |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
     |FINSI;

     |SI nHayAlma = 0; |GRABA 020#54a; |FINSI;
     |LIBERA #53;
     |LIBERA #54;
/*
     |SI nHayParti = 0; |Y PARTI = "S"; |GRABA 020#24a; |FINSI;
*/
     |SI nSwGestral = 0;
          |SI nHayParti = 0; |Y PARTI = "S"; |GRABA 020#24a; |FINSI;
     |FINSI;

     |LIBERA #24;
|FPRC;

|DEFBUCLE dsm00067;
     #67#1;
     ;
     #8#9, #8#0, #8#1, "                              ";
     #8#9, #8#0, #8#1, "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
     ;
     NULL, dsm00067;
|FIN;

|PROCESO LinFab;
     |SI #8#2 ] #0#3; |Y #8#2 [ #0#4;
          articul = #8#2;
          almacen = #8#7;
          |HAZ LeeArti;
          |HAZ LeeAlma;

          art_fabr = art_fabr + (#8#4 - #8#5);
          alm_fabr = alm_fabr + (#8#4 - #8#5);

          |HAZ ValoraStock;

          |SI nSwSanchez = 0;
              |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
          |SINO;
              |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
          |FINSI;

          |SI nHayAlma = 0; |GRABA 020#54a; |FINSI;
          |LIBERA #53;
          |LIBERA #54;
          |BUCLE dsm00067;
     |FINSI;
     ||Ya actualiza los stocks en los movimientos "FB" y "SF"
     |BUCLE dsm00052;
|FPRC;

|DEFBUCLE Fabrica;
     #6#2;
     10;
     #0#0, "      ", 000001, "N";
     #0#1, "zzzzzz", 999999, "N";
     ;
     NULL, NULL, LinFab;
|FIN;

|PROCESO Articulos;
   #53#0 = #100#0;
   |LEE 000#53=;
   |SI FSalida = 0;
      enCampo = 0; enValor1 = 0; enValor2 = 0;
      |SI #53#6   ! #100#6;
         enCampo = 6;   enValor1 = #53#6;   enValor2 = #100#6;
         eaCampo = "Stock total          "; |PRINT;
      |FINSI;
      |SI #53#12  ! #100#12;
         enCampo = 12;  enValor1 = #53#12;  enValor2 = #100#12;
         eaCampo = "Stock reservado      "; |PRINT;
      |FINSI;
      |SI #53#13  ! #100#13;
         enCampo = 13;  enValor1 = #53#13;  enValor2 = #100#13;
         eaCampo = "Stock en fabricacion "; |PRINT;
      |FINSI;
      |SI #53#14  ! #100#14;
         enCampo = 14;  enValor1 = #53#14;  enValor2 = #100#14;
         eaCampo = "Stock en deposito    "; |PRINT;
      |FINSI;
      |SI #53#15  ! #100#15;
         enCampo = 15;  enValor1 = #53#15;  enValor2 = #100#15;
         eaCampo = "Pendiente de servir  "; |PRINT;
      |FINSI;
      |SI #53#16  ! #100#16;
         enCampo = 16;  enValor1 = #53#16;  enValor2 = #100#16;
         eaCampo = "Pendiente de recibir "; |PRINT;
      |FINSI;
      |SI #53#17  ! #100#17;
         enCampo = 17;  enValor1 = #53#17;  enValor2 = #100#17;
         eaCampo = "Pendiente de valorar "; |PRINT;
      |FINSI;
      |SI #53#104 ! #100#104;
         enCampo = 104; enValor1 = #53#104; enValor2 = #100#104;
         eaCampo = "Stock disponible     "; |PRINT;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Articulos;
#100#1001;
;
"                    ";
"zzzzzzzzzzzzzzzzzzzz";
;
NULL,Articulos;
|FIN;

|PROCESO DepositoCompra;
     |SI #139#2 ] #0#3; |Y #139#2 [ #0#4;
          articul = #139#2;
          almacen = #139#3;
          aParti = #139#37;

          |HAZ LeeArti;
          |HAZ LeeAlma;
          |HAZ LeeParti;

          art_depoc = art_depoc + #139#5;
          art_depoc2 = art_depoc2 + #139#36;

          alm_depoc = alm_depoc + #139#5;
          alm_depoc2 = alm_depo2 + #139#6;

          par_depoc = par_depoc + #139#5;
          par_depoc2 = par_depoc2 + #139#6;

          |HAZ ValoraStock;

          |SI nSwSanchez = 0;
              |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
          |SINO;
              |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
          |FINSI;

          |SI nHayAlma = 0; |GRABA 020#54a; |FINSI;
          |SI nHayParti = 0; |Y PARTI = "S"; |GRABA 020#24a; |FINSI;
          |LIBERA #24;
          |LIBERA #53;
          |LIBERA #54;
     |FINSI;
|FPRC;

|DEFBUCLE DepositoCompra;
     #138#3;
     ;
     "      ", #0#0, "     ", 000000;
     "zzzzzz", #0#1, "zzzzz", 999999;
     ;
     NULL, NULL, DepositoCompra;
|FIN;

|PROCESO ProcesaCab;
     articul = #36#4;
     almacen = #36#5;
     aParti = #36#6;

     |HAZ LeeArti;
     |HAZ LeeAlma;
     |HAZ LeeParti;

     |SI #36#3 = "N";
          art_rese = art_rese + #36#7;
          art_disp = art_disp - #36#7;
          art_disp2 = art_disp2 - #36#8;

          alm_rese = alm_rese + #36#7;
          alm_disp = alm_disp - #36#7;
          alm_disp2 = alm_disp2 - #36#8;

          par_proc = par_proc + #36#7;
          par_proc2 = par_proc2 + #36#8;
     |SINO;
          art_disp = art_disp - #36#7;
          art_disp2 = art_disp2 - #36#8;
          art_tota = art_tota - #36#7;
          art_tota2 = art_tota2 - #36#8;

          alm_disp = alm_disp - #36#7;
          alm_disp2 = alm_disp2 - #36#8;
          alm_tota = alm_tota - #36#7;
          alm_tota2 = alm_tota2 - #36#8;

          par_proc = par_proc - #36#7;
          par_proc2 = par_proc2 - #36#8;
          par_sreal = par_sreal + #36#7;
          par_sreal2 = par_sreal2 + #36#8;
          par_disp = par_disp - #36#7;
          par_disp2 = par_disp2 - #36#8;
          par_tota = par_tota - #36#7;
          par_tota2 = par_tota2 - #36#8;
     |FINSI;

     |HAZ ValoraStock;

     |SI nSwSanchez = 0;
         |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
     |SINO;
         |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
     |FINSI;

     |SI nHayAlma = 0; |GRABA 020#54a; |FINSI;
     |SI nHayParti = 0; |Y PARTI = "S"; |GRABA 020#24a; |FINSI;
     |LIBERA #24;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|PROCESO ProcesaLin;
     articul = #37#3;
     almacen = #37#4;
     aParti = #37#5;

     |HAZ LeeArti;
     |HAZ LeeAlma;
     |HAZ LeeParti;

     |SI #36#3 = "N";
          |SI #37#2 = "P"; |O #37#2 = "S";
               art_fabr = art_fabr + #37#10;
          |SINO;
               art_rese = art_rese + #37#10;
               art_disp = art_disp - #37#10;
               art_disp2 = art_disp2 - #37#16;

               alm_rese = alm_rese + #37#10;
               alm_disp = alm_disp - #37#10;
               alm_disp2 = alm_disp2 - #37#16;
          |FINSI;
     |SINO;
          |SI #37#2 = "P"; |O #37#2 = "S";
               art_disp = art_disp + #37#10;
               art_disp2 = art_disp2 + #37#16;
               art_tota = art_tota + #37#10;
               art_tota2 = art_tota2 + #37#16;

               alm_disp = alm_disp + #37#10;
               alm_disp2 = alm_disp2 + #37#16;
               alm_tota = alm_tota + #37#10;
               alm_tota2 = alm_tota2 + #37#16;

               par_ereal = par_ereal + #37#10;
               par_ereal2 = par_ereal2 + #37#16;
               par_disp = par_disp + #37#10;
               par_disp2 = par_disp2 + #37#16;
               par_tota = par_tota + #37#10;
               par_tota2 = par_tota2 + #37#16;
          |SINO;
               art_disp = art_disp - #37#10;
               art_disp2 = art_disp2 - #37#16;
               art_tota = art_tota - #37#10;
               art_tota2 = art_tota2 - #37#16;

               alm_disp = alm_disp - #37#10;
               alm_disp2 = alm_disp2 - #37#16;
               alm_tota = alm_tota - #37#10;
               alm_tota2 = alm_tota2 - #37#16;

               par_sreal = par_sreal + #37#10;
               par_sreal2 = par_sreal2 + #37#16;
               par_disp = par_disp - #37#10;
               par_disp2 = par_disp2 - #37#16;
               par_tota = par_tota - #37#10;
               par_tota2 = par_tota2 - #37#16;
          |FINSI;
     |FINSI;

     |HAZ ValoraStock;

     |SI nSwSanchez = 0;
         |SI #54#1 ! 0; |GRABA 020#53a; |FINSI;
     |SINO;
         |SI nHayArti = 0; |GRABA 020#53a; |FINSI;
     |FINSI;

     |SI nHayAlma = 0; |GRABA 020#54a; |FINSI;
     |SI nHayParti = 0; |Y PARTI = "S"; |GRABA 020#24a; |FINSI;
     |LIBERA #24;
     |LIBERA #53;
     |LIBERA #54;
|FPRC;

|DEFBUCLE Procesado;
     #36#1;
     2;
     000001, #0#0;
     999999, #0#1;
     ;
     NULL, ProcesaCab, ProcesaLin;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
||========================================================================
||====================== INICIO ==========================================
||========================================================================

|PROCESO inicio; |TIPO 3;
     aDirDestino = #0#9; |QBF aDirDestino;
     aDiferencias = #0#8;
     aBorrados = #0#7;

     |SI #0#8 = "N"; aDirDestino = ""; |FINSI;

     |SI #0#2 ! "SI"; |ACABA; |FINSI;

     aAlfa1 = #0#5;
     |QBF aAlfa1;             || por si el a쨚 viene vacio
     |SI aAlfa1 = "";
          #0#6 = ~;
          #0#5 = #0#6 % 704;
     |FINSI;

     |SI #0#8 = "S";
          |HAZ CopiaFicheros;
     |FINSI;

     |SI PARAMETRO = "INFORME"; || para Malpesa (se llama del menu 001254.men)
        |DFICE aAlfa; |QBF aAlfa;
        aAlfa1 = aAlfa + "agifa019.dat"; aAlfa2 = aAlfa + "_gifa019.dat"; |COPIA_FICHERO aAlfa1, aAlfa2;
        aAlfa1 = aAlfa + "agifa019.ddx"; aAlfa2 = aAlfa + "_gifa019.ddx"; |COPIA_FICHERO aAlfa1, aAlfa2;
        aAlfa1 = aAlfa + "agifa019.ixx"; aAlfa2 = aAlfa + "_gifa019.ixx"; |COPIA_FICHERO aAlfa1, aAlfa2;
        aAlfa2 = "_gifa019"; |NOME_DAT #53 aAlfa2;
        aAlfa1 = aAlfa + "agifa017.dat"; aAlfa2 = aAlfa + "_gifa017.dat"; |COPIA_FICHERO aAlfa1, aAlfa2;
        aAlfa1 = aAlfa + "agifa017.ddx"; aAlfa2 = aAlfa + "_gifa017.ddx"; |COPIA_FICHERO aAlfa1, aAlfa2;
        aAlfa1 = aAlfa + "agifa017.ixx"; aAlfa2 = aAlfa + "_gifa017.ixx"; |COPIA_FICHERO aAlfa1, aAlfa2;
        aAlfa2 = "_gifa017"; |NOME_DAT #54 aAlfa2;
        aAlfa1 = aAlfa + "dsm00004.dat"; aAlfa2 = aAlfa + "_sm00004.dat"; |COPIA_FICHERO aAlfa1, aAlfa2;
        aAlfa1 = aAlfa + "dsm00004.ddx"; aAlfa2 = aAlfa + "_sm00004.ddx"; |COPIA_FICHERO aAlfa1, aAlfa2;
        aAlfa1 = aAlfa + "dsm00004.ixx"; aAlfa2 = aAlfa + "_sm00004.ixx"; |COPIA_FICHERO aAlfa1, aAlfa2;
        aAlfa2 = "_sm00004"; |NOME_DAT #904 aAlfa2;
        aAlfa1 = aAlfa + "dsm00024.dat"; aAlfa2 = aAlfa + "_sm00024.dat"; |COPIA_FICHERO aAlfa1, aAlfa2;
        aAlfa1 = aAlfa + "dsm00024.ddx"; aAlfa2 = aAlfa + "_sm00024.ddx"; |COPIA_FICHERO aAlfa1, aAlfa2;
        aAlfa1 = aAlfa + "dsm00024.ixx"; aAlfa2 = aAlfa + "_sm00024.ixx"; |COPIA_FICHERO aAlfa1, aAlfa2;
        aAlfa2 = "_sm00024"; |NOME_DAT #24 aAlfa2;
     |FINSI;

     |ABRE #42;                       ||lee paramentros generales
     |DDEFECTO #42;
     |LEE 000#42p;
     |CIERRA #42;

     fecact = "01.01." + #0#5;

     fHoy = ~;
     fDesde = #0#0;
     fHasta = #0#1;
     aAlfa = "01.01." + (fHoy % 704);
     fDCurso = aAlfa;
     aAlfa = "31.12." + (fHoy % 704);
     fHCurso = aAlfa;
     |SI fDesde > fDCurso; fDesde = fDCurso; |FINSI;
     |SI fHasta < fHCurso; fHasta = fHCurso; |FINSI;

     |SI #0#11 = "S";
          |HAZ CreaTmp112;
          |BUCLE Historico;
          |ABRE #24;
          |ABRE #291;
          |BUCLE TmpPartida;
          |CIERRA #291;
          |CIERRA #24;
          |HAZ BorraTmp112;
     |FINSI;

     |ABRE #238;
     |BUCLE agifa019;
     |CIERRA #238;
     |BUCLE agifa017;
     |BUCLE dsm00024;
     |BUCLE dsm00004;

     |ABRE #53;               ||Fichero de Articulos
     |ABRE #54;               ||Fichero de Almacenes
     |ABRE #24;

     |ABRE #7;
     |BUCLE historico;          ||Bucle de lectura del historico
     |CIERRA #7;

     |ABRE #2;
     |BUCLE pedido;             ||Pedido Ventas
     |CIERRA #2;

     |BUCLE pedicom;            ||Pedido Compras

     |BUCLE deposito;           || Depositos

     |BUCLE DepositoCompra;           || Depositos

     |SI #42#12 = "N"; |O #42#12 = "X"; || Utiliza Fabricacion
          |BUCLE Fabrica;
     |FINSI;

     |BUCLE Procesado;

     |BUCLE MaxMini;

     |HAZ EsTecatel;
     |SI FSalida = 0;
          eaDarti = #0#3;
          eaHarti = #0#4;
          |HAZ TecaRecalStock;
     |FINSI;

     ||컴컴컴컴컴컴컴컴컴
     |HAZ EsMalpesa;
     |SI FSalida = 0;
          eaDarti = #0#3;
          eaHarti = #0#4;
          |HAZ MalpeRecalStock;
     |FINSI;
     ||컴컴컴컴컴컴컴컴컴

     |SI PARAMETRO = "INFORME";
        |DBASE aAlfa; |QBF aAlfa;
        aAlfa = aAlfa + "def/agifa019.mas";
        |CARGA_DEF aAlfa, agifa019@;
        |SI FSalida = 0;
           |DFICE aAlfa; |QBF aAlfa; |PATH_DAT #100 aAlfa;
           |ABRE #100;
           |IMPRE 0;
           |SI FSalida = 0;
              |INFOR "informe";
              |SI FSalida = 0;
                 |BUCLE Articulos; |PIEINF; |FININF;
              |FINSI;
           |FINSI;
           |FINIMP;
           |CIERRA #agifa019@; |DESCARGA_DEF #agifa019@;
        |FINSI;
     |FINSI;
     |CIERRA #53;
     |CIERRA #54;
     |CIERRA #24;

     ||------ Recalculo modulos
     eaDarti = #0#3;
     eaHarti = #0#4;
     efDfecha = #0#0;
     efHfecha = #0#1;
     |SI nSwTagloma = 0;
          |SUB_EJECUTA_NP "tagw0024";
     |FINSI;

     |HAZ EsVisever;
     |SI FSalida = 0;
          |SUB_EJECUTA_NP "visez006";
     |FINSI;

     |SI nSwMecanogra = 0;
          |SUB_EJECUTA_NP "mecaz003";
     |FINSI;

     |SI nSwPCEGroup = 0;
          eaDarti = #0#3;
          eaHarti = #0#4;
          efDfecha = #0#0;
          efHfecha = #0#1;
          eaRecupera = #0#7;
          |SUB_EJECUTA_NP "pcegz012";
     |FINSI;
     ||------
     |SI #0#8 = "S";
          |HAZ Diferencias;
     |FINSI;

     |ABRE #0;
     |LEE 000#0p;
     #0#7 = aBorrados;
     #0#8 = aDiferencias;
     #0#9 = aDirDestino;
     |GRABA 020#0a;
     |CIERRA #0;

|FPRC;

|PROCESO Fin;
     |SI aTag78 ! ""; |DESCARGA_DEF #tagm0078@; |FINSI;
|FPRC;

|PROGRAMA;

     |ABRE #0;
     |LEE 000#0p;
     |SI FSalida ! 0; |GRABA 020#0n; |FINSI;
     |CIERRA #0;

     aBorrados = #0#7;
     aDiferencias = #0#8;
     aDirDestino = #0#9; |QBF aDirDestino;

     |HAZ EsSanchez; nSwSanchez = FSalida;
     |HAZ EsAlbero; nSwAlbero = FSalida;
     |HAZ EsAlbadis; nSwAlbadis = FSalida;
     |HAZ EsMecanogra; nSwMecanogra = FSalida;
     |HAZ EsPCEGroup; nSwPCEGroup = FSalida;
     |HAZ EsTagloma; nSwTagloma = FSalida;
     |HAZ EsGestral; nSwGestral = FSalida;

     |SI nSwTagloma = 0;
          #0#7 = "N";
          |C_M #0#7, 1, "N";
          |DDEF aAlfa;
          aTag78 = aAlfa + "tagm0078";
          |CARGA_DEF aTag78, tagm0078@;
          |SI FSalida ! 0;
               aTag78 = "";
               |MENAV "0000Error al cargar 'tagm0078'";
          |SINO;
               |ABRE #tagm0078@;
          |FINSI;
     |FINSI;

     aParam = PARAMETRO;
     |QBF aParam;
     |SI aParam = "RECALCULA";
          #0#2 = "SI";
          #0#3 = eaDarti;
          #0#4 = eaHarti;
          #0#5 = #0#6 % 704;
          |HAZ inicio;
          |HAZ Fin;
          |ACABA;
     |FINSI;
     |SI aParam = "CHEQUEO";          || llamado por 'dsz00016'
          |NOME_DAT #53 eaFichero1;
          |NOME_DAT #54 eaFichero2;
          |NOME_DAT #904 eaFichero3;
          |NOME_DAT #24 eaFichero4;
          #0#2 = "SI";
          #0#3 = eaDarti;
          #0#4 = eaHarti;
          |HAZ inicio;
     |SINO;
          |SI aParam = "AUTO";
               #0#2 = "SI";
               |HAZ inicio;
               |HAZ Fin;
               |ACABA;
          |FINSI;
          |SI aParam = "malpesa";
               |DDEFECTO #0;
               #0#2 = "SI";
               #0#0 = "01.01.0000";
               #0#1 = "31.12.9999";
               #0#5 = #0#6 % 704;
               |HAZ inicio;
               |HAZ Fin;
               |ACABA;
          |FINSI;

          |SI aParam = "agifa655";
               |DDEFECTO #0;
               |SI nSwTagloma = 0; #0#7 = "N"; |FINSI;
               #0#2 = "SI";
               #0#5 = #0#6 % 704;
               |HAZ inicio;
               |HAZ Fin;
               |ACABA;
          |FINSI;

          |DDEFECTO #0;
          |SI nSwTagloma = 0; #0#7 = "N"; |FINSI;
          #0#9 = aDirDestino;
          #0#8 = aDiferencias;
          |CLS;
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
     |FINSI;
     |HAZ Fin;
|FPRO;
