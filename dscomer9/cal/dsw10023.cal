|FICHEROS;
     dsw00023 #23;
     agifa501 #1;        ||Entrada tiquets (C)
     agifa502 #2;        ||Entrada tiquets (L)
     agifa505 #3;        ||Parametros caja
     agifa007 #4;        ||Series
|FIN;

|VARIABLES;
     fGuarda      = @;
     aAlfa        = "";
     &eaCli       = "";
     &enTiva      = 0;
     &enIva       = 0;
     &enRec       = 0;
     &efFiva = @;

     iva            = 0;
     puente_s       = 0;
     puente_n       = 0;
     i              = 0;

     &tipo                    = "";
     &aser                    = "";
     &aregis                  = -1;
     &reimp                   = "N";
     &afecha                  = "";
     dtipo                    = "";
     htipo                    = "";
     ult_serie                = "xd";
     inf                      = "a";
     informc                  = "";
     informl                  = "";
     informp                  = "";
     &xSer                    = "";
     &xAlb                    = 0;
     &nnumanu               = 0;
|FIN;

||INC-LUYE llena_c4;



|PROCESO lee_serie;
     #agifa007#26 = #agifa501#57;
     |LEE 001#agifa007.=;
     |SI FSalida ! 0;
          |DDEFECTO #agifa007;
     |FINSI;
|FPRC;

|PROCESO acum_iva;
     iva = 0;
     |SI #2#13 = 0;
          #1#30 = #1#30 +. puente_n;||Exenta
     |FINSI;
     |SI #2#13 = 1;
           #1#20 = #1#20 +. puente_n;
           #1#21 = #1#21 +. ((puente_n % enIva)!0);
           iva = puente_n % enIva;
           |SI #1#29 = "S";            ||Tiene recargo
                #1#22 = #1#22 +. ((puente_n % enIva)!0);
                iva = iva + ((puente_n % enIva)!0);
           |FINSI;
     |FINSI;
     |SI #2#13 = 2;
          #1#23 = #1#23 +. puente_n;    || Base imponible s/decimales
          #1#24 = #1#24 +. ((puente_n % enIva)!0);
          iva = puente_n % enIva;
          |SI #1#29 = "S";            ||Tiene recargo
               #1#25 = #1#25 +. ((puente_s % enIva)!0);
               iva = iva + ((puente_n % enIva)!0);
          |FINSI;
     |FINSI;
     |SI #2#13 = 3;
          #1#26 = #1#26 +. puente_n;
          #1#27 = #1#27 +. ((puente_n % enIva)!0);
          iva = puente_n % enIva;
          |SI #1#29 = "S";            ||Tiene recargo
               #1#47 = #1#47 +. ((puente_n % enIva)!0);
               iva = iva + ((puente_n % enIva)!0);
          |FINSI;
     |FINSI;
     |SI #2#13 = 4;
          #1#48 = #1#48 +. puente_n;
          #1#49 = #1#49 +. ((puente_s % enIva)!0);
          iva = puente_s % enIva;
          |SI #1#29 = "S";            ||Tiene recargo
               #1#50 = #1#50 +. ((puente_s % enIva)!0);
               iva = iva + ((puente_s % enIva)!0);
          |FINSI;
     |FINSI;
     |SI #2#13 = 5;
          #1#51 = #1#51 +. puente_n;
          #1#52 = #1#52 +. ((puente_s % enIva)!0);
          iva = puente_s % enIva;
          |SI #1#29 = "S";            ||Tiene recargo
               #1#53 = #1#53 +. ((puente_s % enIva)!0);
               iva = iva + ((puente_s % enIva)!0);
          |FINSI;
     |FINSI;
     #1#4=#1#21+#1#22+#1#24+#1#25+#1#27+#1#47+#1#49+#1#50+#1#52+#1#53;
|FPRC;

|PROCESO CabDesglose;
     #1#3 = #1#3 +. #2#21;        ||Total bruto
     puente_n = ((#2#21 < #1#17) < #1#19) < #1#18;
     puente_s = (((#2#10 * #2#5) < #1#17) < #1#19) < #1#18;

     puente_s = puente_s ! 2;
     puente_n = puente_n ! 2;

     #1#28 = #1#28 +. (#2#21 - puente_n);   ||Total descuentos

     eaCli = #1#1;
     enTiva = #2#13;
     efFiva = #1#14;
     |HAZ IVACli;

     |HAZ acum_iva;

     #1#9 = #1#9 +. (puente_n + iva);
|FPRC;

|PROCESO AceraCab;
     #1#3 = 0;
     #1#4 = 0;
     #1#9 = 0;
     |PARA i = 20; |SI i [ 28; |HACIENDO i = i + 1;
          #1i = 0;
     |SIGUE;
     #1#30 = 0;
     |PARA i = 47; |SI i [ 53; |HACIENDO i = i + 1;
          #1i = 0;
     |SIGUE;
|FPRC;

|DEFBUCLE Desglose;
     #2#1;
     ;
     #1#5, #1#0, 001;
     #1#5, #1#0, 999;
     ;
     NULL, CabDesglose;
|FIN;

|PROCESO imprelin;
     aAlfa = (#1#34 % 102) + (#1#34 % 402);
     fGuarda = #1#14;
     |SI  aAlfa ] #3#155; |Y aAlfa [ #3#156;
          #1#14 = #1#14 + 1;
     |FINSI;
     |PRINT;
     #1#14 = fGuarda;
|FPRC;

|DEFBUCLE CabDesglose;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, CabDesglose;
|FIN;

|DEFBUCLE imprelin;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, imprelin;
|FIN;

|PROCESO imprecab;
     |ABRE #3;
     #3#0 = #1#12;
     |LEE 000#3=;
     |SI FSalida ! 0; |DDEFECTO #3; |FINSI;
     |CIERRA #3;

     Impresora = #3#121; |QBF Impresora;

     |IMPRE -1;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |HAZ lee_serie;
     informc = #agifa007#21;
     informl = #agifa007#32;
     informp = #agifa007#33;

     #agifa501#13 = "S";
     #agifa501#16 = #agifa501#16 + 1;
     |GRABA 021#agifa501.a;
     |LIBERA #agifa501;

     |SI #1#5 ! "  ";           || Tiquet de Desglose
          |SALVA_DATOS #1;
          |HAZ AceraCab;
          |||BUCLELIN 2 CabDesglose #1;
          |BUCLE CabDesglose;
          |BUCLE Desglose;
          |GRABA 020#1a;           ||Grabo la cabecera
     |FINSI;

     aAlfa = (#1#34 % 102) + (#1#34 % 402);
     fGuarda = #1#14;
     |SI  aAlfa ] #3#155; |Y aAlfa [ #3#156;
          #1#14 = #1#14 + 1;
     |FINSI;

     aAlfa = informl + informp; |QBF aAlfa;
     |SI aAlfa = "";
          |INFOR informc;
          |BUCLE imprelin;
          |SI #1#5 ! "  ";           || Tiquet de Desglose
               |REPON_DATOS #1;
               |GRABA 020#1a;      || Restaura cabecera

               |SALVA_FICHA #1;
               |SELECT #1#1;
               #1#36 = #1#5;
               |LEE 000#1=;
               |BUCLE imprelin;
               |REPON_FICHA #1;
          |FINSI;
          |PIEINF; |FININF;
     |SINO;
          |INFOR informc; |PRINT; |PIEINF; |FININF;

          #1#14 = fGuarda;

          |INFOR informl;
          |BUCLE imprelin;
          |SI #1#5 ! "  ";           || Tiquet de Desglose
               |REPON_DATOS #1;
               |GRABA 020#1a;      || Restaura cabecera

               |SALVA_FICHA #1;
               |SELECT #1#1;
               #1#36 = #1#5;
               |LEE 000#1=;
               |BUCLE imprelin;
               |REPON_FICHA #1;
          |FINSI;

          |PIEINF; |FININF;

          |INFOR informp; |PRINT; |PIEINF; |FININF;
     |FINSI;
     |FINIMP;
|FPRC;

|DEFBUCLE PorSerie;
     #1#2;
     ;
     dtipo, #23#0, nnumanu;
     htipo, #23#0, nnumanu;
     be;
     NULL , imprecab;
|FIN;


|PROCESO Tipo30;
     |CONFI "2010NImprimir tiquet?";
     |SI FSalida = 0;
          htipo = "T";
          dtipo = "T";
          FSalida = 0;
          |ABRE #agifa505;
          |ABRE #agifa007;
          |BUCLE PorSerie;
          |CIERRA #agifa505;
          |CIERRA #agifa007;
     |FINSI;
|FPRC;
