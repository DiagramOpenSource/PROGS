|FICHEROS;
     dsm00139 #0;
     dsm00138 #1;
     agifa019 #2;    || Articulos
     agifa112 #6;
     agifa017 #8;
     agifa007 #11;   || Fichero de series;
     agitp001 #12;   || Tarifas Actualizadas Proveedor / Articulo.
     agifa142 #142;  || Param. Gen.
     agifa321 #15;    || DIV - Parametros

     dsm00014 #914;
     dsm00010 #910;
     dsm00004 #904;
     dsm00005 #905;
     dsm00006 #906;
     dsw00045 #100;
     iber0113@ #113;
     agifa561 #561;
     referen@ #555;
     agifa029 #29;
     dsm00226 #226;
     dsm00237 #237;
     agifa081 #81;
     agifa067 #67;
     dsm00024 #24;
|FIN;

|VARIABLES;
     nSalida =0;
     nLinCanon = 0;
     nTallerBorLin = 0;
     nSwTaller = 0;
     nTecla = 0;
     nCampo = 0;
     nUnidPend = 0;
     nUnidPend2 = 0;
     nLinea = 0;
     nCan = 0;
     nAlma = 0;
     aMecaDes = "";
     nMecaPre = 0;
     nMecaDto1 = 0;
     nMecaDto2 = 0;
     nMecaDto3 = 0;
     nUni = 0;
     aParti = "";
     aPath = "";
     nHay = 0;
     &enModoCab = 0;
     &enAlmaExpe = 0;
     nSal = 0;
     &eaModuloCon = "";
     &enDto = 0;
     nalmacen = 0;
     &eArtChampi = "";
     aPtec = "";
     nPtec = 0;
     nLin = 0;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     &eaModulo = "";

     &Tempo    = "";
     aAlfa     = "";
     &enSwIber = 0;
     &Envase    = "";
     &Unidades1 = 0;
     &Unidades2 = 0;
     &VArticulo = "";
     nNume      = 0;
     nModo      = 0;
     nPrecio         = 0;
     nForma          = 0;

     &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_Div      = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDiv   = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVis   = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVis = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVis   = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVis   = 0;   || Decimales en el Importe visual. (lineas)
     tecla      = "";
     &ac_divisa = ""; ||
     mensa      = ""; || Linea de visualizacion
     &pintado   = 0;|| Controla el pintado de mensa para que solo lo haga 1 vez
     titdiv = "";   || Encabezado de precio e imp. con la divisa "Imp.Tot(USD)"
     precio = 0;
     forma = 0;
     dto1 = 0;
     dto2 = 0;
     alfa = "";
     Unidades = 0;
     asto = 0;
     salida    = 0;
     descu = 0;
     imneto = 0;
     tf = 0;
     modo = 0;
     articulo = " ";
     fmes = "  ";
     mes = 0;
     mensaje3 = "";
     a = 0;
     sto = 0;
     vacio = "                    ";
     previo = 0;
     de = 0;
     pm = 0;
     pe = 0;
     m1 = 0;
     m2 = 0;
     m3 = 0;
     canti2 = 0;
     mes1 = 0;
     modo1 = 0;
     &n_dec = 0;
     &n_pre = 0;
     neto = 0;
     &def_alm = 0;
     campo = 0;
     mensaje5 = "0000 Deposito para exportacion Tipo iva = 0 !!";
     expor = "";

     serie     = "";
     serie_o   = "";
     albaran   = 0;
     albaran_o = 0;

     alfa1     = "";
     alfa2     = "";
     fiac      = "  ";
     guarda    = "  ";
     relleno   = "                                       ";
     aponer    = "  ";
     nerror    = 0;
     &LineaD  = 0;   || Lo utilizo en solis008
     nlinea    = 0;
     i         = 0;
     aprograma = "";
     impret = 0;
     &c_prove   = "";
     &c_artic   = "";
     &c_serie   = "";
     &entrada   = 0;
     inkey      = 0;
     &codiBarra = "";
     &r_arti    = "";
     &aRecoge      = "N";
     &aModalidad   = "C";  || Compras
     &aProceso     = "dsm00139";
     nHayPrecio    = 0;
     aCentro       = "";
     aModi6        = "";
     aModi30       = "";
     aDef          = "";
     nSwPreIber    = 0;
|FIN;

|INCLUYE i_varart;
|INCLUYE i_cdbarr;

|PROCESO Tipo139_3; |TIPO 3;
     |SI #agifa142#133 = "S";
          aTipoDA = "D"; |HAZ AltaDAC;
     |FINSI;

     nModo = (FEntrada/ 100) ! 0;
|FPRC;

|PROCESO NoEntra; |TIPO 7;
|FPRC;


|PROCESO civaalb;
     inkey = FSalida;
     |SI inkey = 14;
          c_prove = #1#3;
          c_artic = #0#2;
          c_serie = #1#50;
          entrada = 1;
          |SUB_EJECUTA_NP "agifa383.run";
          |ERROR;
          inkey = 0;
     |FINSI;
     |SI inkey = 15;
          eaPrv = #0#15;
          enTiva = #0#11;
          efFiva = #1#1;
          |HAZ IVAPrv;
          #0#6 = #0#6 / (1 + enIva/100);
          |HAZ visual_precio;
     |FINSI;
|FPRC;

|PROCESO licogeas;|TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     articulo = #0#2;
     nalmacen = #0#3;
     |SI aModi6 = "";            || Solo al entrar
          |C_M #0#6, 0, aModi6;
          |C_M #0#30, 0, aModi30;
     |FINSI;

     |SI nModo ! 1;
          |C_M #0#29, 1, "N";
          |C_M #0#12, 1, "N";
          |C_M #0#21, 1, "N";
     |SINO;
          |C_M #0#29, 1, "S";
          |C_M #0#12, 1, "S";
          |C_M #0#21, 1, "S";
     |FINSI;
|FPRC;


|PROCESO totlis;|TIPO 0;
     |HAZ TotalLin139;
     |HAZ visual_importe;
|FPRC;

|PROCESO Envase139;
     Envase    = #0#34;
     Unidades1 = #0#35;
     Unidades2 = #0#5;
     VArticulo = #0#2;
     enAlmacen = #0#3;
     eaTipo = "C";
     eaProgEnv = "albaran";
     |HAZ EntraEnvase;
     #0#34 = Envase;
     #0#35 = Unidades1;
     #0#5  = Unidades2;  |PINTA #0#5;
|FPRC;

|PROCESO Conversion;  |TIPO 7;
     eaDocu = "dsm00139";
     ||ÄÄÄÄÄÄÄÄÄÄÄÄ Doble/MultiÄ
     |HAZ DobleUni;
     |SI eaSw2Stock = "S";
          |C_M #0#5, 1, "N";
     |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |SI #agifa142#72 = "S";
          |HAZ Envase139;
          |C_M #0#5, 1, "S";
          |SI enEntraEnvase ! 0;  |C_M #0#5, 1, "N";  |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaElemento;
     |ABRE #914;
     #914#0 = eaEleme;
     |LEE 000#914=;
     |CIERRA #914;

     |ABRE #905;
     |DDEFECTO #905;
     #905#0 = "DC";
     #905#1 = #0#27;
     #905#2 = #0#0;
     #905#3 = #0#1;
     #905#4 = eaEleme;
     #905#5 = #914#1;
     #905#6 = #0#5;
     #905#7 = #0#32;
     #905#8 = #905#6 * #905#7;
     #905#11 = #0#5;
     |GRABA 020#905n;

     |DDEFECTO #904;
     |ABRE #904;
     #904#0 = #0#2;
     #904#1 = #0#3;
     #904#2 = eaEleme;
     |LEE 101#904=;
     |SI FSalida ! 0; |GRABA 020#904b; |FINSI;
     #904#3 = #914#1;
     |SI #1#42 = "N";
          #904#12 = #904#12 + #0#5;
          #904#13 = #904#13 + #0#5;
     |SINO;
          #904#12 = #904#12 + #0#5;
          #904#13 = #904#13 + #0#5;
     |FINSI;
     nNume = #904#12 - #904#6;
     |SI nNume > 0;
          #904#24 = nNume * #2#9;
     |SINO;
          #904#24 = 0;
     |FINSI;
     |GRABA 020#904a;
     |ABRE #906;
     #906#0 = #0#2;
     #906#1 = #0#3;
     #906#2 = #1#1;
     #906#3 = "AC";
     #906#4 = #0#27;
     #906#5 = #0#0;
     #906#6 = #0#1;
     #906#7 = eaEleme;
     #906#8 = #914#1;
     #906#9 = #0#5;
     #906#10= #0#30;
     |GRABA 020#906n;
     |CIERRA #906;
|FPRC;

|PROCESO liacartiC;|TIPO 2;
     modo   = (FEntrada / 100) !0;
     nForma = 0 +. 1;
     enForma = 0 +. 1;

     |HAZ EsTaller; nSwTaller = FSalida;

     |SI nSwTaller = 0;
          |SI #0#46 = -1; |Y enModoCab ! 3;
               |SI nForma = -1;
                    |MENAV "0000Linea canon de articulo, no se puede modificar";
               |FINSI;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     |SI modo = 2;|O modo = 3;
          efFec = #1#1;
          enAlma = #0#3;
          |HAZ MiraHisL;
          |SI enErrHis ! 0;
               |ERROR;
               |ACABA;
          |FINSI;
     |FINSI;

     imneto = #0#9 < #1#5;
     imneto = imneto < #1#32;
     imneto = imneto < #1#7;

     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |SI codiBarra = "S"; |Y nModo = 1; |Y enForma = 1; |Y #2#176 = "S";
          |HAZ GrabaElemento;
     |FINSI;


     enTipEnvase = 2;
     |HAZ Envase139;

     |HAZ CalCabDsm00138;

     |SI modo = 3;
          eaTipo      = "DC";
          eaSerie     = #0#27;
          enCodigo    = #0#0;
          enLinea     = #0#1;
          efFecha     = #1#1;
          eaAbono     = #1#42;
          enTarifa    = 0;
          eaArticulo   = #0#2;
          enAlmacen    = #0#3;
          |SUB_EJECUTA_NP "dsz00002;BAJA";

          |HAZ BorraKit;

          |SI #agifa142#133 = "S";
               aTipoDA = "D"; |HAZ BajaDAC;
          |FINSI;
     |FINSI;

     |SI modo ! 3; |HAZ pantcomp; |FINSI;

     #1#26 = #1#26 +. 1; ||Control Pedido

     |HAZ ActuaPedi;

     |SI nSwTaller = 0; |Y #0#12 ! 0;
          |SI modo = 2;
               |HAZ TallerModiLin;
          |FINSI;
          |SI modo = 3; |Y enModoCab ! 3;
               |HAZ TallerBorLin;
          |FINSI;
     |FINSI;

     |SI nSwTaller = 0; |Y #0#12 = 0; |HAZ TallerCanon139; |FINSI;
|FPRC;

|PROCESO agitp001;
     |PARA i = 0; |SI i [ 9; |HACIENDO i = i + 1;
          #100i = #12i;
     |SIGUE;
     |GRABA 020#100n;
|FPRC;

|DEFBUCLE agitp001;
     #12#1;
     ;
     #1#3, "                    ";
     #1#3, "zzzzzzzzzzzzzzzzzzzz";
     ;
     NULL, agitp001;
|FIN;

|PROCESO art6alc;
     modo = (FEntrada / 100)  ! 0;
     r_arti = "";
     inkey = salida;
     |SI codiBarra = "S"; |Y modo = 1;
          eaArti = #0#2;

          |HAZ HallaArti;
          |SI eaArti = ""; |Y #910#19 = "S"; |ERROR; |ACABA; |FINSI;
          |SI #2#176 = "S"; |Y eaEleme = "";
               |MENAV "0000Codigo incompleto...";
               |ERROR; |ACABA;
          |FINSI;
          |SI eaArti ! ""; #0#2 = eaArti; |FINSI;
     |FINSI;
     |SI inkey = 10;
          |SI #142#74 = "T";
               |ABRE #2;
               |SELECT #6#2;
               #2#134 = #0#2;
               |LEE 000#2];
               |CONSULTA_CLAVE #6#2;
               |SI FSalida = 0;
                    #0#2 = #2#0;
                    #0#4 = #2#1;
                    |PINTA #0#2;
                    |PINTA #0#4;
               |SINO;
                    |ERROR;
               |FINSI;
               |CIERRA #2;
          |SINO;
               |HAZ CreaTempo; |NOME_DAT #100 Tempo; |DELINDEX #100;
               |ABRE #100;
               |BUCLE agitp001;
               #100#0 = #1#3;
               #100#1 = #0#2;
               |LEE 000#100];
               |CONSULTA_CLAVE #1#100;
               |SI FSalida = 0;
                    #0#2 = #100#1;
                    #0#4 = #100#7;
                    |PINTA #0#2;
                    |PINTA #0#4;
               |SINO;
                    |ERROR;
               |FINSI;
               |CIERRA #100;
               |DELINDEX #100; |HAZ BoraTempo;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO nomodif5; |TIPO 0;
     |QBF r_arti;
     |SI r_arti ! "";
          #0#2 = r_arti;
          |PINTA #0#2;
     |FINSI;
     modo = (FEntrada / 100) ! 0;
     |SI modo = 1;
          #0#3 = def_alm;
          |PINTA #0#3;
     |FINSI;
     |SI #0#2 = vacio;
          |CAMPO_MODIFICA #0#3,  1, "N";
          |CAMPO_MODIFICA #0#5,  1, "N";
          |SI #1#58 = "B"; || Si la moneda de trabajo es la moneda base
            |CAMPO_MODIFICA #0#6,  1, "N";
          |SINO;
            |CAMPO_MODIFICA #0#30,  1, "N";
          |FINSI;
          |CAMPO_MODIFICA #0#8,  1, "N";
          |CAMPO_MODIFICA #0#26,  1, "N";
          |CAMPO_MODIFICA #0#45,  1, "N";
          |CAMPO_MODIFICA #0#10, 1, "N";
          |CAMPO_MODIFICA #0#11, 1, "N";
     |SINO;
          |CAMPO_MODIFICA #0#3,  1, "S";
          |CAMPO_MODIFICA #0#5,  1, "S";
          |SI #1#58 = "B";
            |CAMPO_MODIFICA #0#6,  1, "S";
          |SINO;
            |CAMPO_MODIFICA #0#30,  1, "S";
          |FINSI;
          |CAMPO_MODIFICA #0#8,  1, "S";
          |CAMPO_MODIFICA #0#26,  1, "S";
          |CAMPO_MODIFICA #0#45,  1, "S";
          |CAMPO_MODIFICA #0#10, 1, "S";
          |CAMPO_MODIFICA #0#11, 1, "S";
     |FINSI;
|FPRC;

|PROCESO decim; |TIPO 6;
     nSalida = FSalida;
     |SI FSalida = 13;
          enTipEnvase = 1;
          |HAZ Envase139;
     |FINSI;
     |HAZ EsDesanch;
     |SI FSalida = 0;
          eaDocu = "dsm00139";
          |SI nSalida = 10;
               |HAZ DesanOfeCon;
               |ERROR; |ACABA;
          |SINO;
               |SI #0Campo = Contenido; |ACABA; |FINSI;
               enPrecio = #0#6;
               enPreDiv = #0#30;
               enDto1 = #0#8;
               enDto2 = #0#26;
               enDto3 = #0#45;
               |HAZ DesanOferta;
          |FINSI;
          #0#6 = enPrecio;
          #0#30 = enPreDiv;
          #0#8 = enDto1;
          #0#26 = enDto2;
          #0#45 = enDto3;
          |PINTA #0#8;
          |PINTA #0#26;
          |PINTA #0#45;
          |HAZ upc_div;
     |FINSI;

     #0#5 = #0#5 ! n_dec;
     |PINTA #0#5;
     |ABRE #2;
     #2#0 = #0#2;
     |LEE 000#2=;
     |CIERRA #2;
     |SI #0#5 < #2#212; |Y #0#5 > 0;
          aAlfa = "0000Unidades Minimas Compra " + #2#212;
          |MENAV aAlfa;
          |ERROR; |ACABA;
     |FINSI;
|FPRC;

|PROCESO decim1;
     |SI #2#176 = "S";
          |SI codiBarra = "N"; |O modo ! 1;
               |SI #1#58 = "D";  || Si la moneda de trabajo es la divisa ...
                    #0#30 = nPrecio;
               |SINO;
                    #0#6  = nPrecio;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #1#58 = "D";  || Si la moneda de trabajo es la divisa ...
         #0#6 = #0#30 / #1#57 * #1#62;  || ... recalculo en funcion de la divisa
     |SINO;
         #0#30 = #0#6 / #1#62 * #1#57; || .. recalculo en funcion de la moneda base
     |FINSI;

     |HAZ visual_precio; || Visualiza el precio
     ||ÄÄÄÄÄÄÄÄÄÄÄÄ Doble/MultiÄ
     eaDocu = "dsm00139";
     |HAZ PintaUniMediC;
|FPRC;

|| *********************** *(1)
|PROCESO leeotroC; |TIPO 11;
     inkey = FSalida;
     modo = (FEntrada/100) !0;

     |SI inkey = 10;     ||F2
          |HAZ MenuTrack139;
          |SI FSalida = 0; |ERROR; |ACABA; |FINSI;
          inkey = FSalida;
     |FINSI;
     |SI inkey = 9;
          |PUSHV 0101 2380;
          |CLS;
          |PINPA #0#1;
          |PINDA #0#1;
          |PAUSA;
          |POPV;
          |ERROR;
          Control = "dsm00139";
     |FINSI;

     |SI inkey = 14;
          |SI modo = 1;
              c_artic = "";
          |SINO;
              c_artic = #0#2;
          |FINSI;
          c_prove = #1#3;
          c_serie = #1#50;
          entrada = 1;
          |SUB_EJECUTA_NP "agifa383.run";
          |ERROR;
          inkey = 0;
     |FINSI;

     |SI inkey = 13;          || F5
          |HAZ VerKit;
          eaDocu = "dsm00139";
          ||ÄÄÄÄÄÄÄÄÄÄÄÄ Doble/MultiÄ
          |HAZ VerDobleUni;
          |ERROR; |ACABA;
          ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |FINSI;

     |SI inkey = 12; |O inkey = 17;     || F4 o F9
          |SI inkey = 12; |Y #agifa142#36 = "N";   ||F4
               |PUSHV 0400 0479;
               |MENAV "0000Opcion no activada en Utilidades Usuario de Parametros Generales";
               |POPV;
               |ERROR;
               |ACABA;
          |FINSI;
           || compruebo que este en la ultima linea y en modo alta
          LineaD = #0#1;    || Guardo puntero
          LineaD = LineaD +1;     || Porque si estoy en alta la linea en la que
                                     || estoy todavia no esta grabada
          |LEE 001#0];

          |SI FSalida ! 0;|O #0#0 ! #1#0;
                          |O #0#27 ! #1#50;|Y modo = 1;

               LineaD = LineaD -1;

               || Recupero el puntero
               #0#0  = #1#0;    || Albaran
               #0#27 = #1#50;   || Serie
               #0#1  = LineaD;        || Numero de linea
               |LEE 001#0=;

               nerror = 0;
               |SI inkey = 12; ||F4
                    |HAZ entradatosC;
               |FINSI;
               |SI nerror = 0 ;
                    |SI inkey = 12;
                         |HAZ leelineasC;
                    |FINSI;
                    |HAZ control2C;
                      || Le meto 3 ptec's para cuando cambia de pantalla
                    |PTEC 809;    || Flecha abajo
                    |PTEC 809;    || Flecha abajo
                    |PTEC 809;    || Flecha abajo
               |SINO;
                    |ERROR;
               |FINSI;
          |SINO;
                   || Recupero el puntero
               LineaD = LineaD -1;
               #0#0  = #1#0;    || Albaran
               #0#27 = #1#50;   || Serie
               #0#1  = LineaD;        || Numero de linea
               |LEE 001#0=;

               |MENAV "0000Para recoger un albaran debe estar en la ultima linea  y en Alta";
               |ERROR;
          |FINSI;    || Si #0#1 = 1 ...
     |FINSI;      || Si FSalida ...

     |SI inkey = 16; |Y #agifa142#133 = "S";
          aTipoDA = "D"; |HAZ VerDAC;
          |ERROR; |ACABA;
     |FINSI;
     |SI inkey = 25; || Ctrl-F7
          |HAZ CreaTempo;
          eaFichero = Tempo;
          |SUB_EJECUTA_NP "psion066";
          |HAZ BoraTempo;
          |SI enError = 0; |HAZ ImportaPDA139; |FINSI;
          |ERROR; |ACABA;
     |FINSI;
|FPRC;

|| Recojo la serie y numero de albaran
|PROCESO entradatosC;
         |PINTA 2420 , " Recogida de datos del albaran :      /    ";
         alfa1 = "";
         E_sup = 5;
         E_inf = "";
         alfa1 = 2453 ? 1;
         serie_o = alfa1;
         alfa2 = "";
         E_sup = 6;
         E_inf = "";
         alfa2 = 2459 ? 1;
         albaran_o = alfa2;
         |BLIN 24;

         || No puedo leer en el que estoy sino se embuclaria
         |SI  serie_o = #1#50;|Y albaran_o = #1#0;
             |MENAV "0000ATENCION !!! Esta en este deposito";
             nerror = 1;
         |FINSI;
|FPRC;

|PROCESO control1C;
   aponer= Asino;
   |HAZ poncontrC;
|FPRC;

|PROCESO control2C;
   aponer= Anosi;
   |HAZ poncontrC;
|FPRC;

|PROCESO poncontrC;
         fiac = Control % A109;
         fiac = fiac + relleno;
         guarda = fiac % A109;
         fiac = Control % A1001;
         Control = Control + fiac;
         Control = Control + relleno;
         Control = Control % A120;
         Control = Control + aponer;
|FPRC;

|PROCESO CreaComponente;
     #905#0 = "DC";
     #905#1 = #0#27;
     #905#2 = #0#0;
     #905#3 = #0#1;
     #905#9 = #905#6;
     |GRABA 020#905n;
     |LIBERA #905;

     enUnidades   = #905#6;
     eaTipo       = "DC";
     eaSerie      = #0#27;
     enCodigo     = #0#0;
     enLinea      = #0#1;
     efFecha      = #1#1;
     eaArticulo   = #0#2;
     enAlmacen    = #0#3;
     eaComponente = #905#4;
     efFecha      = #1#1;
     enCamBas     = #1#57;
     eaMoneda     = #1#58;
     enCamDiv     = #1#62;

     |SUB_EJECUTA_NP "dsz00002;DCC";
|FPRC;

|DEFBUCLE dsm00005;
     #905#1;
     ;
     "DC", serie, albaran, nlinea, "      ";
     "DC", serie, albaran, nlinea, "zzzzzz";
     be;
     NULL, CreaComponente;
|FIN;

|PROCESO crealineasC;
    || Clave primaria
    #0#27= #1#50;    || Serie
    #0#0 = #1#0;     || Numero de Albaran
    #0#1 = LineaD;         || Numero de linea


    |DEFECTO #0#1;   || Cargo los valores de defecto de cab.albaran

    || Ahora cambio lo que es particular de este albaran y que por tanto
    || no puede ver como copia de otro
    #0#12 = "";                  || Familia
    || !!!! Descargar el coste !!! (pdte)
    |PARA i = 16;|SI i [ 26; |HACIENDO i = i+1;
          #0#i# = "";
    |SIGUE;
    #0#28 = ""; || Serie Factura
    #0#29 = ""; || Serie Pedido

    |HAZ totlis;       || Calculo total linea
    |HAZ liacartiC;    || Lo envio al t ipo 2 para que calcule lo mismo que si fuera
                       || una linea introducida por el operador
    |GRABA 021#0b;
    |LIBERA #0;

    |BUCLE dsm00005;

    LineaD =LineaD + 1;  || Aumento contador de lineas
|FPRC;


|PROCESO leelineasC;
      #0#27= serie_o;
      #0#0 = albaran_o;
      #0#1 = 1;
      |LEE 001#0];
      |SI FSalida =0;
           |PARA;|SI FSalida =0;|Y #0#27=serie_o;|Y #0#0=albaran_o;
                                                     |HACIENDO;
                  || Me guardo el puntero
                  serie   = #0#27;   || Serie y albaran actual
                  albaran = #0#0;
                  nlinea  = #0#1;

                  |HAZ crealineasC;

                  || Recupero puntero
                  #0#27 = serie;
                  #0#0  = albaran;
                  #0#1  = nlinea;
                  |LEE 001#0=;

                  |LEE 001#0s;
           |SIGUE;
      |SINO;
           |MENAV "0000Atencion !!! No se ha encontrado el deposito indicado";
           |ERROR;
      |FINSI;

      || Devuelvo el puntero de la linea
      #0#27= #1#50; || Serie
      #0#0 = #1#0;  || Albaran
      #0#1 = LineaD;      || Linea
      |LEE 001#0=;
|FPRC;


|PROCESO param;|TIPO 7;
     nModo = (FEntrada / 100) ! 0;

     |ABRE #11;
     |DDEFECTO #11;
     #11#26 = #0#27;
     |LEE 001#11=;
     expor = #11#30;
     |CIERRA #11;

     |SI nModo = 1;
          #0#1 = #0#1 + #agifa142#236 - 1;
     |FINSI;
|FPRC;

|PROCESO mirespor;|TIPO 0
     |SI #0#11 ! 0; |Y expor = "S";
          |MENSA mensaje5;
          #0#11 = 0;
          |PINTA #0#11;
    |FINSI;
    |ABRE #6;
    #6#0 = #1#3;
    |LEE 000#6=;
    |CIERRA #6;
    |SI #0#11 ! 0; |Y #6#90 = "S";
          |MENSA mensaje5;
          #0#11 = 0; |PINTA #0#11;
    |FINSI;
|FPRC;

|PROCESO Mensaje;
     |PUSHV 0501 2380;
     |AVISO;
     |COLOR 0, 0; |ATRI 0;
     |BLANCO 0815 1265;
     |COLOR 4, 0; |ATRI 0;
     |D_CUADRO 0815,1265;
     |PINTA 1017, alfa;
     |ATRI 0;
     |PAUSA;
     |POPV;
|FPRC;

|PROCESO cambipre; |TIPO 0;
     |SI #142#75 ! "S"; |ACABA; |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄ Doble/MultiÄ
     eaDocu = "dsm00139";
     |HAZ LeePreDtoCom;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |SI #1#58 = "B";
          |SI enPrecio ! #0#6;
               alfa = "­ ATENCION ! POSIBLE CAMBIO DE PRECIO COSTE...";
               |HAZ Mensaje;
          |FINSI;
     |SINO;
          |SI enPreDiv ! #0#30;
               alfa = "­ ATENCION ! POSIBLE CAMBIO DE PRECIO COSTE...";
               |HAZ Mensaje;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO cambidto;
     |SI #142#75 ! "S"; |ACABA; |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄ Doble/MultiÄ
     eaDocu = "dsm00139";
     |HAZ LeePreDtoCom;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |SI enDto1 ! #0#8; |Y Campo = 8;
          alfa = "­ ATENCION ! POSIBLE CAMBIO DE DESCUENTO 1 ...";
          |HAZ Mensaje;
     |FINSI;
     |SI enDto2 ! #0#26; |Y Campo = 26;
          alfa = "­ ATENCION ! POSIBLE CAMBIO DE DESCUENTO 2 ...";
          |HAZ Mensaje;
     |FINSI;
     |SI enDto3 ! #0#45; |Y Campo = 45;
          alfa = "­ ATENCION ! POSIBLE CAMBIO DE DESCUENTO 3 ...";
          |HAZ Mensaje;
     |FINSI;
|FPRC;
------------------ ACTUALIZA ARTICULOS Y ALMACEN -------------------------
|PROCESO pantcomp; |TIPO 13;
     |SI enModoCab = 3; |ACABA; |FINSI;
     |HAZ visual_totales; || Visualiza los totales
     |SI #142#148 = "S";
          |PINTA 1337, "Portes:"
     |FINSI;
|FPRC;


|PROCESO LinDiv;  |TIPO 7;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄ Doble/MultiÄ
     eaDocu = "dsm00139";
     |HAZ PintaUniMediC;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |ABRE #agifa321;
     |LEE 001#agifa321.p;  || Leo parametros de divisa
     |CIERRA #agifa321;

     |SI ac_divisa ! "S";
          |ATRI R;
          |PINTA 1547, "Precio";
          |PINTA 1563, "Imp. Total";
          |ATRI r;
     |SINO;
          |SI pintado = 0; || Si divisas estan activadas y no he pintado ...
               |SI #1#58 = "D";   || Si la moneda de trabajo es la divisa la pinto en
                    |ATRI R;         || el encabezado del precio y el importe
                    titdiv = "Precio" + "(" + #1#56 + ")";
                    |PINTA 1444,titdiv;
                    titdiv = "I.Tot." + "(" + #1#56 + ")";
                    |PINTA 1468,titdiv;
                    |ATRI r;
               |SINO;
                    |ATRI R;
                    |PINTA 1547, "Precio";
                    |PINTA 1563, "Imp. Total";
                    |ATRI r;
               |FINSI;
               |SI #agifa321#4 = "S";  || Si la visualizacion esta activada ...
                    ||mensa = "Precio:            Imp.:              T.Bruto:             T.ALB:             ";
                    ||PINTA 1102,mensa;  || ... pinto la linea de visualizacion
                    |PINTA 1102, "Precio:";
                    |PINTA 1120, "Imp:";
                    |PINTA 1141, "T.Bruto:";
                    |PINTA 1162, "T.ALB:";
                    |PINTA #0#32; || Pinto precio visual
                    |PINTA #0#33; || Pinto importe visual
                    |SI #1#58 = "D"; || Si la moneda de trabajo es la divisa
                         |PINTA 1149,#1#67;
                         |PINTA 1168,#1#68;
                    |SINO;
                         |PINTA 1149,#1#63;
                         |PINTA 1168,#1#64;
                    |FINSI;
                    pintado = 1;  || Ya hemos pintado
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO upc_div;
     |SI eaDivisa = #1#56;
          #0#6 = #0#30 * #1#62 / #1#57;
     |SINO;
          #0#30 = #0#6 / #1#62 * #1#57;
     |FINSI;
     |HAZ visual_precio;
|FPRC;

|PROCESO visual_precio; || Pinta el precio visual.
|SI #1#58 = "D";  || Si la moneda de trabajo es la divisa ...
  #0#32 = #0#6;   || ... el campo visualiz. es el precio en moneda base
  |PINTA #0#30;
|SINO;            || Si la moneda de trabajo es la moneda base ...
  #0#32 = #0#30;  || ... el campo visual. es el precio en divisa
  |PINTA #0#6;
|FINSI;
|SI ac_divisa = "S"; |Y #agifa321#4= "S";
  |PINTA #0#32; || Si las divisas y la visualizacion estan activadas, pinto
|FINSI;
|FPRC;


|PROCESO visual_importe;  || Pinta el importe visual
|SI #1#58 = "D";  || Si la moneda de trabajo es la divisa ...
  #0#33 = #0#9;   || el campo visualiz. es el importe en moneda base
  |PINTA #0#31;
|SINO;            || Si la moneda de trabajo es la moneda base ...
  #0#33 = #0#31;  || el campo visualiz. es el importe en divisa
  |PINTA #0#9;
|FINSI;
|SI ac_divisa = "S"; |Y #agifa321#4= "S";
  |PINTA #0#33; || Si las divisas y la visualizacion estan activadas, pinto
|FINSI;
|FPRC;

|PROCESO visual_totales;
          |ABRE #agifa321;
          |LEE 001#agifa321.p;
          |SI #1#58 = "D";
               |SI ac_divisa = "S"; |Y #agifa321#4= "S";
                    |PINTA 1149,#1#67;
                    |PINTA 1168,"        ";
                    |PINTA 1168,#1#68;
               |FINSI;
               |CIERRA #agifa321;
               |PINTA 1449,#1#63;
               |PINTA 1466,#1#64;
          |SINO;
               |SI ac_divisa = "S"; |Y #agifa321#4= "S";
                    |PINTA 1149,#1#63;
                    |PINTA 1168,"        ";
                    |PINTA 1168,#1#64;
              |FINSI;
              |CIERRA #agifa321;
              |PINTA 1449,#1#15;
              |PINTA 1466,#1#55;
          |FINSI;
|FPRC;

|PROCESO CogeValores139;  |TIPO 7;
     |SI Campo = 5;
          aAlfa = "0000<F5> Envases";
          |HAZ EsDesanch;
          |SI FSalida = 0;
               aAlfa = "0000<F2> Ofertas   <F5> Envases";
          |FINSI;
          |MENSA aAlfa;
     |FINSI;
     |SI Campo = 3;
         |C_M #0Campo, 1, "S";
         |SI #142#99 = "S";
             |C_M #0Campo, 1, "N";
             #0Campo = 1;  |PINTA #0Campo;
         |FINSI;
     |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄ MODULO AGROGENIL ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ

     |SI #2#176 = "N";  |ACABA;  |FINSI;

     |SI Campo = 3;
         |SI enAlmacen ! 0;
             #0#3 = enAlmacen;  |PINTA #0#3;
         |FINSI;
     |FINSI;

     |SI Campo = 5;
         |SI enUnidades ! 0;
             |SI #0#5 ! enUnidades;  Contenido = #0#5;  |FINSI;
             #0#5 = enUnidades;  |PINTA #0#5;
         |FINSI;
     |FINSI;

     |SI Campo = 6;
         |SI nPrecio ! 0;
             #0#6 = nPrecio;  |PINTA #0#6;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO PideArt139;  |TIPO 7;
     nModo = (FEntrada/100) ! 0;
     |SI #142#140 = "S"; |Y nModo = 1; #0#2 = eaArtAnt; |FINSI;

     |C_M #0#2, 1, "S";
     |C_M #0#3, 1, "N";

     |SI #0#2 ! "                    ";
         |ABRE #2;
         #2#0 = #0#2;
         |LEE 000#2=;
         |SI FSalida ! 0;  |DDEFECTO #2;  |FINSI;
         |CIERRA #2;
         |SI #2#176 = "S";
             |C_M #0#2, 1, "N";
             |C_M #0#3, 1, "N";
             |ACABA;
         |FINSI;
     |FINSI;

     |ABRE #910;
     |LEE 040#910p;
     |SI FSalida ! 0;  |DDEFECTO #910;  |FINSI;
     |CIERRA #910;

     |SI #910#2 [ 2;    |ACABA;  |FINSI;

     eAlfa = #0Campo;
     |SUB_EJECUTA_NP "dsz99990";                 || Por Pantalla

     |SI eAlfa = "-1";  |PTEC 807;  |ACABA;  |FINSI;
     |SI eAlfa = "-2";              |ACABA;  |FINSI;

     eaArticulo = eAlfa;      ||  700000-4215

     #0Campo = eAlfa;
     |PINTA #0Campo;
     |PTEC 802;
|FPRC;

|PROCESO Calc6139;  |TIPO 6;
     eaArtAnt = #0#2;
     salida = FSalida;

     ||ÄÄÄÄÄÄÄÄÄÄÄÄ Doble/MultiÄ
     eaDocu = "dsm00139";
     |HAZ UniPartiCB;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |SI #0Campo ! Contenido; |Y Campo = 2;
          eaArticulo = #0#2;
          |HAZ DefectoMediC;
          #0#39 = enMedida1;
          #0#40 = enMedida2;
          #0#41 = enMedida3;
     |FINSI;

     enAlta = 1;
     eaArticulo = #0Campo;
     |HAZ LlenaArticulo;
     |SI FSalida = 0;
          #0Campo = eaArticulo;
          |PINTA #0Campo;
     |SINO;
          |ERROR; |ACABA;
     |FINSI;

     |HAZ art6alc;

     |SI codiBarra = "S"; |Y #910#19 = "S"; |Y modo = 1;
          |ACABA;
     |FINSI;

     |ABRE #2;
     #2#0 = #0#2;
     |LEE 101#2=;
     |SI FSalida = 0; |Y #142#209 = "S"; |Y #2#27 ! #1#3;
          aAlfa = "0000NModificar Proveedor en Articulo:"+&13+"Actual:["+#2#27+"]";
          |CONFI aAlfa;
          |SI FSalida = 0; #2#27 = #1#3; |GRABA 020#2a; |FINSI;
     |FINSI;
     |CIERRA #2;

     |HAZ SacaKit;
|FPRC;

|PROCESO Tipo0139; |TIPO 0;
     |HAZ EsDesanch;
     |SI FSalida = 0;
          |ABRE #2;
          #2#0 = #0#2;
          |LEE 020#2=;
          |CIERRA #2;
          |SI #2#135 = "N";
               |MENAV "0000El articulo no es de entrada...";
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     |HAZ nomodif5;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄ Doble/MultiÄ
     eaDocu = "dsm00139";
     |HAZ PintaUniMediC;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |SI #agifa142#133 = "S";
          aTipoDA = "D"; |HAZ DescriDAC;
     |FINSI;

     |SI #agifa142#77 = "N";
          |ABRE #237;
          |SELECT #2#237;

          #237#7 = #1#3;
          #237#2 = #0#2;
          |LEE 000#237=;
          |SI FSalida ! 0;
               |MENAV "0000No existe Oferta Proveedor/Articulo";
               |ERROR; |ACABA;
          |SINO;
               |ABRE #226;
               #226#0 = #237#0;
               |LEE 000#226=;
               |SI #1#1 < #226#2; |O #1#1 > #226#3;
                    |MENAV "0000Oferta Proveedor/Articulo fuera de perido";
                    |ERROR; |ACABA;
               |FINSI;
               |CIERRA #226;
          |FINSI;
          |CIERRA #237;
     |FINSI;

     |ABRE #2; #2#0 = #0#2; |LEE 000#2=; |CIERRA #2;
     |SI #2#176 = "S";
         eaTipo      = "DC";
         eaSerie     = #0#27;
         enCodigo    = #0#0;
         enLinea     = #0#1;
         efFecha     = #1#1;
         eaArticulo  = #0#2;
         enAlmacen   = #0#3;
         enUnidades  = #0#5;
         enTBruto    = #0#7;
         eaAbono     = #1#42;
         enTarifa    = 0;
         eaProve     = #1#3;
         enCamBas     = #1#57;
         eaMoneda     = #1#58;
         enCamDiv     = #1#62;
         eaProve = #1#3;
         |SUB_EJECUTA_NP "dsz00002";

         #0#3    = enAlmacen;
         nPrecio = enTBruto / enUnidades;

         |PTEC 802;
         |PTEC 802;
         |PTEC 802;
         |PTEC 802;
     |FINSI;
|FPRC;

|PROCESO Multi139; |TIPO 66;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄ Doble/MultiÄ
     eaDocu = "dsm00139";
     |HAZ CambiaUniMulti;
     |HAZ LeePreDtoCom;
     #0#6 = enPrecio;
     #0#30= enPreDiv;
     #0#8 = enDto1;
     #0#26 = enDto2;
     #0#45 = enDto3;
     |PINTA #0#8;
     |PINTA #0#26;
     |PINTA #0#45;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |HAZ upc_div;
|FPRC;

|PROCESO Tipo11139;  |TIPO 11;
     |SI FSalida = 7;  |Y #2#176 = "S";
         |MENAV "      Imposible abortar;  Termine de introducir la linea y efectue una Baja.";
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO MinAlma80;
     #8#0 = #0#2;
     #8#1 = 1;
|FPRC;

|PROCESO MaxAlma80;
     #8#0 = #0#2;
     #8#1 = 99999;
|FPRC;


|PROCESO Tipo5_139;  |TIPO 5;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo ! 4;
          |HAZ actalc;
     |FINSI;
|FPRC;

|PROCESO MinC080;
     #referen@#27 = #1#50;
     #referen@#0 = #1#0;
     #referen@#1 = 001;
|FPRC;

|PROCESO MaxC080;
     #referen@#27 = #1#50;
     #referen@#0 = #1#0;
     #referen@#1 = 999;
|FPRC;

|PROCESO Consulta139; |TIPO 66;
     nLin = 0;
     |DDEF aAlfa;
     aAlfa = aAlfa + "dsm00139";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          |CONSULTA_F_CLAVE #1#referen@, MinC080, MaxC080;
          |SI FSalida = 0; nLin = #referen@#1; |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
     |SI nLin ! 0;
          |PTEC 802;
          aAlfa = ("000" + nLin) % -103;
          aPtec = aAlfa % 301; nPtec = &aPtec;
          |PTEC nPtec;
          aPtec = aAlfa % 201; nPtec = &aPtec;
          |PTEC nPtec;
          aPtec = aAlfa % 101; nPtec = &aPtec;
          |PTEC nPtec;
     |FINSI;
|FPRC;

|PROCESO ImportaPDA139;
     |DDEF aAlfa; aAlfa = aAlfa + "dsm00139";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;
     |ABRE #referen@;
     #referen@#27 = #1#50;
     #referen@#0 = #1#0;
     #referen@#1 = 999;
     |LEE 000#referen@.];
     |SI FSalida = 0;
          |LEE 000#referen@.a;
     |SINO;
          |LEE 000#referen@.u;
     |FINSI;
     |SI FSalida = 0; |Y #referen@#27 = #1#50; |Y #referen@#0 = #1#0;
          nLin = #referen@#1 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
     |CIERRA #referen@;
     |DESCARGA_DEF #referen@;

     |DDEF aAlfa; aAlfa = aAlfa + "psion067";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;
     |NOME_DAT #referen@#eaFichero#;
     |ABRE #referen@;
     |LEE 000#referen@.p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          #0#27 = #1#50;
          #0#0 = #1#0;
          #0#1 = nLin;
          |GRABA 020#0b;
          #0#2 = #referen@#0; ||Arti
          #0#4 = #referen@#1; ||Des
          #0#3 = #referen@#2; ||Alma
          #0#5 = #referen@#3; ||Uni
          #0#37 = #referen@#9; ||Parti
          FEntrada = 100;     ||simula alta
          |HAZ defeclis;
          |HAZ TotalLin139;
          |HAZ liacartiC;
          |GRABA 020#0a;
          |LIBERA #0;
          nLin = nLin + 1;
          |LEE 000#referen@.s;
     |SIGUE;
     |CIERRA #referen@;
     |DELINDEX #referen@;
     |DESCARGA_DEF #referen@;
     |PONCONTROL 23, "SI"
     |PTEC 809;
     |PTEC 808;
|FPRC;

|PROCESO MenuTrack139;
     |VARIABLES; {20} aPopup = ""; |FINSI;
     aPopup1 = "-1";  || Si fuera -1 en la posicion
     aPopup2 = 6;
     aPopup3 = "<F4> Recoger Lineas";
     aPopup4 = "<F5> Doble Stock/Kit";
     aPopup5 = "<F6> Precios Proveedor";
     aPopup6 = "<F8> Descripción Ampliada";
     aPopup7 = "<F12> Consulta Cabecera";
     aPopup8 = "<Ctrl+F7> Captura PDA";
     IaPopup = aPopup1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;
     nSal = FSalida;
     |SI FSalida = 1; nSal = 12; |FINSI;
     |SI FSalida = 2; nSal = 13; |FINSI;
     |SI FSalida = 3; nSal = 14; |FINSI;
     |SI FSalida = 4; nSal = 16; |FINSI;
     |SI FSalida = 5; nSal = 9; |FINSI;
     |SI FSalida = 6; nSal = 25; |FINSI;
     FSalida = nSal;
     inkey = nSal;
|FPRC;

|PROCESO Alma139_66; |TIPO 66;
     |ABRE #29;
     #29#0 = #0#3;
     |LEE 000#29];
     |CONSULTA_CLAVE #1#29;
     |SI FSalida = 0;
          #0#3 = #29#0;
          |PINTA #0#3;
     |SINO;
          |ERROR;
     |FINSI;
     |CIERRA #29;
|FPRC;

|PROCESO defeclis;
     #0#15 = #1#3;

     |SI #0#2 ! #2#0;
          |ABRE #2;
          #2#0 = #0#2;
          |LEE 000#2=;
          |CIERRA #2;
     |FINSI;
     #0#13 = #2#2;

     |SI #0#15 ! #6#0;
          |ABRE #6;
          #6#0 = #0#15;
          |LEE 000#6=;
          |CIERRA #6;
     |FINSI;

     |HAZ mirespor;

     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1; |O articulo ! #0#2; |O nalmacen ! #0#3;
          articulo = #0#2;
          nalmacen = #0#3;
          ||ÄÄÄÄÄÄÄÄÄÄÄÄ Doble/MultiÄ
          eaDocu = "dsm00139";
          |HAZ LeePreDtoCom;
          #0#6 = enPrecio;
          #0#30 = enPreDiv;
          #0#8 = enDto1;
          #0#26 = enDto2;
          #0#45 = enDto3;
          ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
          |PINTA #0#8;
          |PINTA #0#26;
          |PINTA #0#45;
          |HAZ upc_div;
     |FINSI;
|FPRC;

|PROCESO Alma139_0; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;

     |SI FSalida = 13; || F5;
          |ABRE #8;
          #8#0 = #0#2;
          #8#1 = #0#3;
          |LEE 000#8];
          |CONSULTA_F_CLAVE #1#8, MinAlma80, MaxAlma80;
          |SI FSalida = 0;
               #0#3 = #8#1; |PINTA #0#3;
          |SINO;
               |ERROR; |ACABA;
          |FINSI;
          |CIERRA #8;
     |FINSI;

     efFec = #1#1;
     enAlma = #0#3;
     |HAZ MiraHisL;
     |SI enErrHis ! 0;
          |ERROR;
          |ACABA;
     |FINSI;

     |HAZ defeclis;

     mensaje3 = "0410Stock Disponible Almacen : " + #8#39+"     Stock Minimo : "+#8#6;
     |MENSA mensaje3;
|FPRC;

|PROCESO SerDepoDefe; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
          #0#29 = #1#50;
     |FINSI;
|FPRC;

|PROCESO NumDepo; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |SI FSalida = 2; |O nModo ! 1; |ACABA; |FINSI;
     |C_M #0#21 , 1, "S";

     |SI #0#12 ! 0; |O #0#29 ! "     ";
          |ABRE #81;
          #81#25 = #0#29;
          #81#0 = #0#12;
          |LEE 000#81=;
          |SI FSalida ! 0;
               |MENAV "0000No existe pedido...";
               |ERROR;
          |SINO;
               |SI #1#58 ! #81#29; |O #1#56 ! #81#27;
                    |MENAV "0000La divisa no coincide con el actual";
                    |ERROR;
               |FINSI;
               |SI #1#3 ! #81#4;
                    aAlfa = "0000Proveedor del pedido:" + #81#4 + ", distinto del actual";
                    |MENAV aAlfa;
                    |ERROR;
               |FINSI;
               |SI #1#5 ! #81#5; |Y #1#32 ! #81#17; |Y #1#7 ! #81#6;
                    |MENAV "0000Los dtos del pedido no coincide con el actual";
                    |ERROR;
               |FINSI;
          |FINSI;
          |CIERRA #81;
     |SINO;
          |C_M #0#21 , 1, "N";
     |FINSI;
|FPRC;

|PROCESO SirveLinPedi;
     nModo = (FEntrada / 100) ! 0;
     nUnidPend = #67#5 - #67#38;
     nUnidPend2 = #67#41 - #67#46;

     |SI nUnidPend [ 0;
          |ACABA;
     |FINSI;

     #81#24 = #81#24 + 1;
     |GRABA 020#81a;

     #0#27 = #1#50;
     #0#0 = #1#0;
     #0#1 = nLinea;
     #0#2 = #67#2;
     #0#3 = #67#3;
     #0#4 = #67#4;
     #0#5 = nUnidPend;
     #0#6 = #67#6;
     #0#8 = #67#8;
     #0#11 = #67#14;
     #0#13 = #67#18;
     #0#15 = #67#20;
     #0#21 = #67#1;
     #0#23 = #67#5;
     #0#26 = #67#27;
     #0#34 = #67#39;
     #0#35 = #67#40;
     #0#36 = nUnidPend2;
     #0#37 = #67#42;
     #0#38 = #67#43;
     #0#39 = #67#47;
     #0#40 = #67#48;
     #0#41 = #67#49;
     #0#42 = #67#50;
     #0#43 = #67#54;
     #0#45 = #67#57;
     #0#46 = #67#58;

     |PARA FSalida = 1; |SI FSalida ! 0; |HACIENDO;
          #0#1 = nLinea;
          |GRABA 040#0b;
          nLinea = nLinea + 1;
     |SIGUE;

     #1#26 = #1#26 + 1; || Control deposito
     nHay = 1;

     nUnidPend = #67#5 - #67#38;
     nUnidPend2 = #67#41 - #67#46;
     nForma = 1;
     |HAZ ActuaStock;

     |HAZ TotalLin139;
     |HAZ CalCabDsm00138;

     |GRABA 020#0a;
     |LIBERA #0;

     #67#38 = #67#38 + nUnidPend;
     #67#46 = #67#46 + nUnidPend2;
     |GRABA 020#67a;
     |LIBERA #67;
|FPRC;

|PROCESO LinDepo; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |SI FSalida = 2; |ACABA; |O nModo ! 1; |FINSI;

     |SI #0#12 ! 0;
          nHay = 0;
          nLinea = #0#1;
          |ABRE #81;
          |ABRE #67;
          #81#25 = #0#29;
          #81#0 = #0#12;
          |LEE 121#81=;
          |SI FSalida ! 0; |ERROR; |ACABA; |FINSI;

          aponer = Asino;
          |HAZ poncontrC;

          |SI #0#21 = 0;
               |BUCLELIN 0 SirveLinPedi #81;
               |SI nHay = 0;
                    |MENAV "0000Pedido servido completo...";
                    |ERROR; |ACABA;
               |FINSI;
               |PTEC 809;
               |PTEC 816;
               |PTEC 812;
               |PTEC 807;
               |HAZ RecalPedi;
          |SINO;
               #67#28 = #0#29;
               #67#0 = #0#12;
               #67#1 = #0#21;
               |LEE 101#67=;
               |SI FSalida ! 0;
                    |MENAV "0000No existe linea de pedido...";
                    |ERROR;
               |SINO;
                    |HAZ EsTaller;
                    |SI FSalida = 0; |Y #67#58 = -1;
                         |MENAV "0000Linea de promocion, adjudique la principal";
                         |ERROR; |ACABA;
                    |FINSI;
                    nLinCanon = #67#58;

                    |HAZ SirveLinPedi;
                    |SI nHay = 0;
                         |MENAV "0000Linea pedido servida...";
                         |ERROR;|ACABA;
                    |FINSI;

                    |HAZ EsTaller;
                    |SI FSalida = 0; |Y nLinCanon > 0;
                         |SALVA_FICHA #0;
                         #67#1 = nLinCanon;
                         |LEE 101#67=;
                         |SI FSalida = 0;
                              |HAZ SirveLinPedi;
                              #0#46 = -1;
                              |GRABA 020#0a;
                         |FINSI;
                         nLinCanon = #0#1;
                         |REPON_FICHA #0;
                         #0#46 = nLinCanon;
                         |GRABA 020#0a;
                    |FINSI;

                    |PTEC 806;
                    |PTEC 807;
                    |HAZ RecalPedi;
               |FINSI;
          |FINSI;

          aponer = Anosi;
          |HAZ poncontrC;

          |CIERRA #67;
          |CIERRA #81
     |FINSI;
|FPRC;

|PROCESO RecalPedi;
     |HAZ CalCabAgifa081;
     |GRABA 020#81a;
     |LIBERA #81;
|FPRC;

|PROCESO ActuaStock;
     |ABRE #2;
     |ABRE #8;
     |ABRE #24;
     #2#0 = #0#2;
     |LEE 101#2=;
     |SI FSalida = 0;
          #2#210 = #2#210 + (#0#5 * nForma);
          #2#211 = #2#211 + (#0#36 * nForma);

          #2#16 = #2#16 - (nUnidPend * nForma);
          #2#183 = #2#183 - (nUnidPend2 * nForma);

          #8#0 = #0#2;
          #8#1 = #0#3;
          |LEE 101#8=;
          |SI FSalida = 0;
               #8#94 = #8#94 + (#0#5 * nForma);
               #8#95 = #8#95 + (#0#36 * nForma);

               #8#43 = #8#43 - (nUnidPend * nForma);
               #8#45 = #8#45 - (nUnidPend2 * nForma);

               |SI #2#180 = "S";
                    #24#0 = #0#2;
                    #24#1 = #0#3;
                    #24#2 = #0#37;
                    |LEE 101#24=;
                    |SI FSalida = 0;
                         #24#48 = #24#48 + (#0#5 * nForma);
                         #24#49 = #24#49 + (#0#36 * nForma);

                         #24#29 = #24#29 - (nUnidPend * nForma);
                         #24#30 = #24#30 - (nUnidPend2 * nForma);
                         |HAZ ValoraStock;
                         #24#3 = #1#3;
                         |GRABA 020#24a;
                    |FINSI;
               |SINO;
                    |HAZ ValoraStock;
               |FINSI;
               |GRABA 020#8a;
          |FINSI;
          #2#27 = #1#3;
          |GRABA 020#2a;
     |FINSI;
     |CIERRA #24;
     |CIERRA #8;
     |CIERRA #2;
|FPRC;

|PROCESO ActuaPedi;
     |ABRE #81;
     |ABRE #67;
     #81#25 = #0#29;
     #81#0 = #0#12;
     |LEE 101#81=;
     |SI FSalida = 0;
          #67#28 = #0#29;
          #67#0 = #0#12;
          #67#1 = #0#21;
          |LEE 101#67=;
          |SI FSalida = 0;
               nUnidPend = #0#5;
               nUnidPend2 = #0#36;
               #67#38 = #67#38 + (#0#5 * nForma);
               |SI #67#38 > #67#37;
                    #67#12 = #67#12 + (#67#38 - #67#37);
                    #67#5 = #67#5 + #67#12;
                    nUnidPend = nUnidPend - (#67#38 - #67#37);
               |FINSI;
               #67#46 = #67#46 + (#0#36 * nForma);
               |SI #67#46 > #67#45;
                    #67#44 = #67#44 + (#67#46 - #67#45);
                    #67#41 = #67#41 + #67#44;
                    nUnidPend = nUnidPend - (#67#46 - #67#45);
               |FINSI;

               |GRABA 020#67a;

               |HAZ ActuaStock;
               #81#24 = #81#24 + nForma;
               |HAZ RecalPedi;
          |FINSI;
     |FINSI;
     |CIERRA #67;
     |CIERRA #81;
|FPRC;

|PROCESO PedPdte; |TIPO 6;
     nTecla = FSalida;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1; |Y Campo = 29;
          |SI nTecla = 1; |O nTecla = 4; |O nTecla = 2; ||Anula ESC y Flechas
               |ERROR; |PTEC 807; |ACABA;
          |FINSI;
     |FINSI;
     |SI FSalida = 10; ||F2
          nCampo = Campo;
          eaSerie = "";
          enCodigo = 0;
          enLinea = 0;
          eaProve = #1#3;
          |SUB_EJECUTA_NP "dsw00086";
          |ERROR;
          |SI enCodigo ! 0;
               #0#29 = eaSerie;
               #0#12 = enCodigo;
               #0#21 = enLinea;
               |PTEC 802;
               |PTEC 802;
               |SI nCampo = 29;
                    |PTEC 802;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

----------------------------------------------
|PROCESO TallerCreaLin139;
     |DDEF aAlfa; aAlfa = aAlfa + "dsm00139";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen@;
     |SI #0#46 > 0;
          nLin = #0#46;
          #referen@#27 = #0#27;
          #referen@#0 = #0#0;
          #referen@#1 = nLin;
          |LEE 121#referen@.=;
     |SINO;
          #referen@#27 = #0#27;
          #referen@#0 = #0#0;
          #referen@#1 = 999;
          |LEE 000#referen@.];
          |SI FSalida = 0;
               |LEE 000#referen@.a;
          |SINO;
               |LEE 000#referen@.u;
          |FINSI;
          |SI FSalida = 0; |Y #referen@#27 = #0#27;  |Y #referen@#0 = #0#0;
               nLin = #referen@#1 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |SI nLin [ #0#1; nLin = #0#1 + 1; |FINSI;
          |DDEFECTO #referen@;
          #referen@#27 = #0#27;
          #referen@#0 = #0#0;
          #referen@#1 = nLin;
          |GRABA 020#referen@.b;
     |FINSI;
     aAlfa = "CANON " + #0#4;
     #referen@#2 = "xxxxx";
     #referen@#3 = 1;
     #referen@#4 = aAlfa;
     #referen@#5 = #0#5;
     #referen@#6 = enCanon;
     #referen@#11 = #0#11;
     #referen@#13 = #0#13;
     #referen@#15 = #0#15;
     #referen@#30 = enCanon;
     #referen@#46 = -1;
     |SALVA_DATOS #0;

     |SALVA_DATOS #referen@;
     |REPON_DATOS #0;

     enForma = 1;
     eaDocu = "dsm00139";
     |HAZ StockEntra;
     |HAZ TotalLin139;
     |HAZ AcuDeposito;

     |SALVA_DATOS #0;
     |REPON_DATOS #referen@;
     |GRABA 020#referen@.a;

     |REPON_DATOS #0;

     #0#46 = nLin;       || Linea Promocion

     |CIERRA #referen@;
     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO TallerAcuLin139;
     |DDEF aAlfa; aAlfa = aAlfa + "dsm00139";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen@;
     #referen@#27 = #0#27;
     #referen@#0 = #0#0;
     #referen@#1 = #0#46;     || Usa linea promocion
     |LEE 101#referen@.=;
     |SI FSalida = 0;
          |SALVA_DATOS #0;
          |SALVA_DATOS #referen@;
          |REPON_DATOS #0;
          #0#1 = #referen@#1;
          enForma = -1;
          eaDocu = "dsm00139";
          |HAZ StockEntra;
          |HAZ TotalLin70;
          |HAZ AcuDeposito;
          |REPON_DATOS #0;
     |FINSI;
     |CIERRA #referen@;

     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO TallerBorLin139;
     |DDEF aAlfa; aAlfa = aAlfa + "dsm00139";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen@;
     #referen@#27 = #0#27;
     #referen@#0 = #0#0;
     #referen@#1 = #0#46;     || Usa linea promocion
     |LEE 101#referen@.=;
     nTallerBorLin = FSalida;
     |SI FSalida = 0;
          |BORRA 020#referen@.a;
     |FINSI;
     |CIERRA #referen@;

     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO TallerCanon139;
     eaArticulo = #0#2; |QBF eaArticulo;
     |HAZ TallerCanon;
     |SI nForma = 1;
          |SI enCanon ! 0;
               aponer = Asino; |HAZ poncontrC;
               |HAZ TallerCreaLin139;
               aponer = Anosi; |HAZ poncontrC;
               |PTEC 809; |PTEC 816; |PTEC 806;
          |SINO;
               |SI #0#46 > 0;      || ha cambiado a un articulo sin canon
                    |HAZ TallerBorLin139;
                    #0#46 = 0;
               |FINSI;
          |FINSI;
     |SINO;
          |SI modo = 3; |Y enModoCab ! 3;
               |HAZ TallerAcuLin139;
               |HAZ TallerBorLin139;
               |SI nTallerBorLin = 0;
                    |PONCONTROL 23, "SI";
                    |PTEC 809; |PTEC 808;
               |FINSI;
          |SINO;
               |SI modo = 2;
                    |HAZ TallerAcuLin139;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO AcuDeposito;
     |HAZ CalCabDsm00138;
     |HAZ visual_totales;
|FPRC;
---
|PROCESO TallerModiLin;
     |DDEF aAlfa; aAlfa = aAlfa + "dsm00139";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     nUni = #0#5;
     |ABRE #referen@;
     #referen@#27 = #0#27;
     #referen@#0 = #0#0;
     #referen@#1 = #0#46;     || Usa linea promocion
     |LEE 101#referen@.=;
     |SI FSalida = 0;
          #referen@#5 = nUni;
          |GRABA 020#referen@.a;
          |SALVA_DATOS #0;
          |SALVA_DATOS #referen@;
          |REPON_DATOS #0;
          |HAZ TallerAcumu;
          |REPON_DATOS #0;
     |FINSI;
     |CIERRA #referen@;

     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO TallerBorLin;
     |DDEF aAlfa; aAlfa = aAlfa + "dsm00139";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen@;
     #referen@#27 = #0#27;
     #referen@#0 = #0#0;
     #referen@#1 = #0#46;     || Usa linea promocion
     |LEE 101#referen@.=;
     nTallerBorLin = FSalida;
     |SI FSalida = 0;
          |SALVA_DATOS #0;
          |SALVA_DATOS #referen@;
          |REPON_DATOS #0;
          |HAZ TallerAcumu;
          |REPON_DATOS #0;
          |BORRA 020#referen@.a;
          |PONCONTROL 23, "SI";
          |PTEC 809; |PTEC 808;
     |FINSI;
     |CIERRA #referen@;

     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO TallerAcumu;
     imneto = #0#9 < #1#5;
     imneto = imneto < #1#32;
     imneto = imneto < #1#7;

     enTipEnvase = 2;
     |HAZ Envase139;

     |HAZ CalCabDsm00138;

     |SI modo ! 3; |HAZ pantcomp; |FINSI;

     #1#26 = #1#26 + nForma; ||Control Pedido

     |HAZ ActuaPedi;
|FPRC;

|PROCESO IVA143_66; |TIPO 66;
     enTiva = #0Campo;
     efFiva = #1#1;
     |HAZ ConsuIVA;
     |SI eaDiva = "";
          |ERROR;
     |SINO;
          #0Campo = enTiva; |PINTA #0Campo;
     |FINSI;
|FPRC;

|PROCESO IVA143_0; |TIPO 0;
     enTiva = #0Campo;
     efFiva = #1#1;
     |HAZ SacaIVA;
     |SI eaDiva = "";
          |MENAV "0000No existe tipo iva para esta fecha...";
          |ERROR; |ACABA;
     |FINSI;
|FPRC;
