|FICHEROS;
     malpe090 #0;        || Albaranes
     agifa019 #2;
     malpe091 #3;
     agifa024 #4;
     agifa027 #41;       || Contador.              || VIC Puesto el 15/07/98
     agifa142 #42;       || Parametros Generales
     agifa204 #43;       || Titulos Varios
     agifa007 #44;       || Series
     agi00002 #100;
     agi00003 #101;
     agifa321 #35;  || Parametros de Divisas
     agifa328 #36;  || Clientes/Divisas
     agifa329 #37;  || Lineas de Clientes/Divisas
     agifa324 #38;  || Divisas

     malpe004 #104;

     agis0002 #200;
     tempo084 #500,MANTE;  || a Pagar.......

     agifa065 #165;
     agifa048 #148;
     agifa049 #149;
     dsm00114 #114;
     dsm00117 #117;
     dsm00246 #140; ||Control Riesgo Por Usuarios.
     dsm00247 #141; ||Pantalla Informe Riesgo.
     dsm00248 #143; ||Auditoria.
     malpe137 #137;
     malpe081 #81;
     malpe185 #185;
     malpe209 #209;
     malpe210 #210;
     malpe211 #211;
     malpe001 #1000;
|FIN;

|VARIABLES;
     nLin = 0;
     nPesoMortero = 0;
     nEncuentra = 0;
     nPortes = 0;
     aEsMortero = "";
     &PRMNT_aHisto = "";
     &eaSumaRie = "";
     nForma = 0;
     &enPreBas = 0;
     &enPreDto = 0;
     &enPrePor = 0;
     &enDto = 0;
     &enObra = 0;
     &eaPorte = "";
     &eaTieneDto = "";

     nPos       = 0;
     nConAu     = 0;
     aUs        = "";
     &nMasRies  = 0;
     nTries     = 0;
     nAudito    = 0;
     nSal      = 0;
     aAlfa     = "";
     nMult     = 0;
     nModo     = 0;
     nGuarda   = 0;
     &nRieTotal = 0;
     &nRieUtili = 0;
     &aRieBloqu = "";
     &aBloquead = "";
     &eaTag    = "";
     aArti     = "";
     aOpera    = "";
     nCta     = 0;
     naCum    = 0;
     NoExiste = 0;
     &eaCodigo  = "";
     &eaTipoCodigo = "CL";

     &Cliente = "";
     &SPedido = "";
     &NPedido = 0;
     &PPedido = "";
     &FPedido = @;
     &TPedido = 0;
     &BAdela  = 0;
     &TipoCta = "A";
     &doc = 0;
     &nDeci_IVADiv   = 0;
     &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_Div      = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDiv   = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVis   = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVis = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVis   = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVis   = 0;   || Decimales en el Importe visual. (lineas)
     nfecha    = 0;
     &ac_divisa = "N";   || Vale "S" cuando las divisas en ventas estan
                         || activadas y la serie es de divisas
     &pintado = 0;       || Sirve para controlar los pintados de las lineas
     &decim_divisa = 0;  || Decimales de la divisa
     &precio_divisa = 0; || Decimales del precio en divisa
     &decim_base = 0;    || Decimales de la moneda base
     &precio_base = 0;   || Decimales del precio en moneda base
     div_act = 0;        || Divisa actualizada. Me sirve en un PARA para que
                         || no salga hasta que este actualizada (div_act=1)
     &cli_divisa = "";   || Codigo de Cliente. Se pasa a CLIENTES/DIVISAS
     &divisa = "";       || Codigo de Divisa. Se pasa a ACTUAL. de DIVISAS
     nModo010 = 0;
     &err = 0;
     salida = 0;
     tipo = 0;
     &cli="";
     &ser="";
     &ext1     = "";
     &ser_alb  = "";
     &num_alb  = 0;
     &abo_alb  = "";
     &abono    = "";   || Lo utilizo en agifa014
     &n_dec    = 0;
     avisa_st = "S";
     kit      = "S";
     dto_prom = "N";
     recoge   = "N";
     def_exp  = "N";
     DescAmpli = "N";
     n_pre    = 0;
     def_alm  = 0;

     puente    = "";
     totalba    = 0;
     imneto    = 0;
     tf        = 0;
     mes       = 0;
     con       = 0;
     margen    = 0;
     control   = 0;
     cant      = 0;
     modo      = 0;
     sw_pinta  = 0;
     contenido = 0;
     iva_ant   = 0;
     importe   = 0;
     &consulta = "";
     &sserie   = "";
     &nnumer   = 0;
     &ffecha   = @;
     &cclien   = "";
     &nnombr   = "";
     &iimpor   = 0;
     &ccoste   = 0;
     &fec_alb = @;

     alfa = "";
     cont     = "";
     contador = 0;

     || MENU PARA INTRODUCIR EL CODIGO DEL CLIENTE DE FORMA AUTOMATICA.
 {-1}menu           = "";
     menu1          = "2400";
     menu2          = "1";
     menu3          = "Contador:  ";
     menu4          = "AM";
     menu5          = " Automatico ";
     menu6          = " Manual ";
     so             = "";
     no             = "";
     caltot         = 0;
     recalpre       = 0;
     &clien    = "";
     &fpago    = "";
     &repres   = "";
     &dto      = 0;
     &dtoa     = 0;
     &dtop     = 0;
     &factur   = 0;
     nImpDiv   = 0;
 {-1}aMenu          = "";
     aMenu1         = "2400";
     aMenu2         = "1";
     aMenu3         = "Opciones: ";
     aMenu4         = "IO";
     aMenu5         = " Imprimir ";
     aMenu6         = " Incidencias Obra ";
|FIN;

||IN-CLUYE llena_c4;
|INCLUYE i_varart;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|CALCULO clien;|TIPO 0;
     |SI factur = 1;|O factur = 2;
          |SI factur = 2;
               #0#43 = "S";
               |PINTA #0#43;
          |FINSI;
          #0#3 = clien;
          #0#8 = fpago;
          #0#6 = repres;
          #0#5 = dto;
          #0#32 = dtoa;
          #0#7 = dtop;
          |PINTA #0#3;
          |PINTA #0#8;
          |PINTA #0#6;
          |PINTA #0#5;
          |PINTA #0#32;
          |PINTA #0#7;
     |FINSI;
|FCAL;

|PROCESO Promo010_7; |TIPO 7;
     |SI #42#129 = "S";
          |C_M #0#89, 1, "S";
     |FINSI;
|FPRC;

|PROCESO Promo010_0; |TIPO 0;
     |SI #0#89 ! 0;
          |ABRE #117;
          #117#0 = #0#89;
          |LEE 000#117=;
          |SI FSalida ! 0;
               |MENAV "0000Promocion Inexistente...";
               |ERROR;
          |FINSI;
          |CIERRA #117;
     |FINSI;
|FPRC;

|PROCESO fecalb;|TIPO 7;
     ||HAZ entra_1;      || esto jodia el tema de la serie por defecto
                         ||/cuando, una vez presentada, la cambiaba el
                         ||/usuario
                         || ENTRE OTRAS COSAS NO SE PARA QUE SE EJECUTABA
                         ||/ESTO AQUI OTRA VEZ !!!     (PRIEGO-AGO/02)
     modo = (FEntrada / 100) ! 0;
     |C_M #0#3, 1, "S";
     |C_M #0#84, 1, "S";
     |SI modo = 2;
          |C_M #0#1 , 1 , "N";
          |SI #0#97 ! 0;
               |C_M #0#3, 1, "N";
               |C_M #0#84, 1, "N";
          |FINSI;
     |SINO;
          |C_M #0#1 , 1 , "S";
     |FINSI;
|FPRC;


|PROCESO cogecon0;|TIPO 0;
     control = 0;
|FPRC;

|PROCESO pedcon0;|TIPO 6;
     con = (FEntrada / 100) ! 0;
     |HAZ PintRemanente;
     |SI con = 2;|Y #0Campo ! Contenido;
          |SI #0#42 > 0;|O #0#38 = AS; |O #0#39 = 999999;
               #0Campo = Contenido;
               |PINTA #0Campo;
               |SI #0#42 > 0;
               |MENAV "0000Este albaran contiene lineas provenientes de Depositos";
                    |ERROR; nError6 = 1;
                    |ACABA;
               |FINSI;
               |SI #0#39 = 999999;
                    |MENAV  "0000Este albaran esta en modo Exportacion";
                    |ERROR; nError6 = 1;
                    |ACABA;
               |FINSI;
               |SI #0#38 = "S";
                    |SI #0#43 = AN;
                         |MENAV "0000Este albaran esta FACTURADO";
                         |ERROR; nError6 = 1;
                         |ACABA;
                    |SINO;
                         |MENAV "0000Este albaran esta FACTURADO";
                         |ERROR; nError6 = 1;
                         |ACABA;
                    |FINSI;
               |FINSI;
               |SI #0#39 = 999999;
                   |MENAV "0000Este albaran esta en modo Exportacion";
               |FINSI;
          |SINO;
               control = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Medida0; |TIPO 0;
     |SI enErrRie ! 0; |ERROR; |ACABA; |FINSI;
|FPRC;

|PROCESO dcon;|TIPO 6;
     con = (FEntrada / 100) ! 0;
     |SI #0Campo ! Contenido;
          |SI #0#38 = "S"; |O #0#39 = 999999;
               |SI #0#38 = "S";
                    |MENAV "0000Este albaran esta FACTURADO";
               |SINO;
                    |MENAV "0000Este albaran esta en modo Exportacion";
               |FINSI;
               |ERROR;
         |SINO;
            control = 1;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO MiraEsMortero;
     #2#0 = #3#2;
     |LEE 020#2=;
     aEsMortero = #2#181;
     |ERROR10;
|FPRC;

|PROCESO acacp;|TIPO 2;
     |HAZ ControlUsuAV;
     |SI enErr ! 0; |ERROR; |ACABA; |FINSI;
     ||--------------------------------
     con = (FEntrada / 100) ! 0;
     tipo = 0 +. 1;
     nForma = 0 +. 1;
     |SI con ! 1; |Y tipo = -1; |Y #0#65 = "S";
          |AVISO;
          |CONFI "2400NAlbaran pasado a Compras. Continuar (S/N).: ";
          |SI FSalida ! 0;
               |ERROR; |ACABA;
          |SINO;
               err = 0;
               alfa = "agiw0005" + &59 + #0#52 + #0#0;
               |SUB_EJECUTA_NP alfa;   || BORRA ALBARAN COMPRAS
               |SI err = 1;
                    |MENAV "0000Error al borrar la compra...";
                    |ERROR; |ACABA;
               |SINO;
                    #0#65 = "N";
                    |SI con ! 3; |GRABA 021#0a; |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #0#41 > 0;|O #0#42 > 0;|O #0#38 = "S"; |O #0#39 = 999999;
          enErr = 1;
          |SI #0#41 > 0;
               |SI con = 3;
                    |MENAV "0000Este albaran contiene lineas provenientes de Pedidos";
                    |ERROR;|ACABA;
               |FINSI;
          |FINSI;
          |SI #0#42 > 0;
               |MENAV "0000Este albaran contiene lineas provenientes de Depositos";
               |ERROR;   |ACABA;
          |FINSI;
          |SI #0#38 = AS;
               |MENAV "0000Este albaran esta FACTURADO";
               |ERROR;   |ACABA;
          |FINSI;
          |SI #0#39 = 999999;
               |MENAV "0000Este albaran esta en modo Exportacion";
               |ERROR;   |ACABA;
          |FINSI;
          enErr = 0;
     |SINO;
          |SI control = 1;
               |HAZ actal;
          |FINSI;
     |FINSI;
     |HAZ actpf;
     |SI con = 3;
          ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
          |HAZ bajatrabajo;
          ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
          BAdela = 1;
          TipoCta = "A"; SPedido = #0#52; NPedido = #0#0;
          |SUB_EJECUTA_NP "agis0002;NOMEQUITES"; || Borra Entragas a cuenta
     |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄAutomatizacion Empresas
     |ABRE #dsm00114; |LEE 000#dsm00114.p; nSal = FSalida; |CIERRA #dsm00114;
     |SI nSal = 0;
          eaCli = #0#3;
          |SI tipo = 1;
               aAlfa = "dsz99983;ALBALTA" + #0#52 + (("000000" + #0#0) % -106);
               |SUB_EJECUTA aAlfa;
          |SINO;
               aAlfa = "dsz99983;ALBBAJA" + #0#52 + (("000000" + #0#0) % -106);
               |SUB_EJECUTA aAlfa;
          |FINSI;
     |FINSI;

     |SI nForma = -1;
          |ABRE #81; |LEE 000#81p; |CIERRA #81;
          |BUCLELIN 2 MiraRapel #0;
          |SI con = 2;
               |ABRE #104; |SELECT #5#104;
               #104#0 = #0#52;
               #104#17 = #0#0;
               |LEE 000#104=;
               |SI FSalida = 0;
                    aEsMortero = "N";
                    |ABRE #2;
                    |BUCLELIN 0 MiraEsMortero #0;
                    |CIERRA #2;
                    |SI aEsMortero = "S";
                         |MENAV "0000Si se cambia algún dato se deberán cambiar los portes de forma manual";
                    |FINSI;
               |FINSI;
               |CIERRA #104;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MiraRapel;
     |SI #3#2 = #81#6;
          |MENAV "0000ATENCION, se esta modificando un albaran de rapels";
          |ERROR10;
     |FINSI;
|FPRC;

||---------------------------------------------------------------------------
|| CALCULA EL COSTE TOTAL DEL ALBARAN.
||---------------------------------------------------------------------------
|PROCESO calcos;
     ccoste = ccoste + #3#14;
|FPRC;

|DEFBUCLE calcoste;
     #3#1;
     ;
     #0#52,#0#0,001;
     #0#52,#0#0,999;
     ;
     NULL,calcos;
|FIN;

||---------------------------------------------------------------------------

|PROCESO dif;
    #500#2 = #500#0 - #500#1;
    |PINTA #500#2;
|FPRC;

|PROCESO dif2;
    #500#1 = #500#0 - #500#2;
    |PINTA #500#1;
|FPRC;

|PROCESO apagar;
     |PUSHV 0501 2380;
     |PINPA #0#500;
     #500#0 = #0#78;
     #500#1 = #0#61;
     #500#2 = #500#0 - #500#1;
     |PINDA #0#500;
     |ENDATOS #1#500;
     |SI FSalida = 0;
          #0#61 = #500#1;
          |GRABA 020#0a;
     |FINSI;
     |POPV;
     |PINTA #0#61;
|FPRC;

|PROCESO alriesgo;|TIPO 0;
     |HAZ clien;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ Observaciones Clientes.
     |SI #agifa142#14 = "S";
          puente = #agifa024#53;     |QBF puente;
          |SI puente ! "";
               |PUSHV 1008 1370;
               |SI #agifa142#20 = "S"; |AVISO; |FINSI;
               |BLANCO 1009 1369;
               |CUADRO 1008 1370;
               |ATRI R;
               |PINTA 1110 , #agifa024#53;
               |ATRI 0;
               |PAUSA;
               |POPV;
          |FINSI;
     |FINSI;

     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ Control Riesgo Cliente.
     nMasRies = 0;
     enErrRie = 0;
     eaSerie = #0#52;
     eaTag = "AV";  |HAZ SacaRiesgoMalpe;
     |SI #0#43 = AN; |Y #agifa142#6 = "S"; |Y eaExisteCliRie = "S";
          eaDocu = "C";
          eaTipo = "A";
          enImpoDoc = #0#67;
          ||eaMuestra =
          |HAZ ControlRiesgo;
          |SI enErrRie ! 0; |ERROR; nError6 = 1; |ACABA; |FINSI;
          |SI enAudito = 0;
               |ABRE #143;
               |LEE 000#143u;
               |SI FSalida = 0;
                    nConAu = #143#0 + 1;
               |SINO;
                    nConAu = 1;
               |FINSI;
               |DDEFECTO #143;
               #143#0 = nConAu;
               #143#12 = "ALBARAN";
               #143#1 = #0#52;
               #143#2 = #0#0;
               #143#3 = #0#1;
               #143#4 = #0#3;
               #143#5 = #0#4;
               #143#6 = Usuario % 810;
               #143#7 = #141#0;
               #143#8 = #141#1;
               #143#9 = #141#2;
               #143#10 = #141#3;
               #143#11 = #141#4;
               |GRABA 020#143n;
               |CIERRA #143;
          |FINSI;
     |FINSI;
|FPRC;


|PROCESO actpf;
|SI #0#15 ] 0;
     importe = 1;
|SINO;
     importe = -1;
     #0#15 = -#0#15;
|FINSI;
cant = #0#15 < #0#5;
cant = cant < #0#32;
cant = cant < #0#7;
cant = cant * importe;
#0#15 = #0#15 * importe;
|ABRE #4;
#4#0 = #0#3;
|LEE 121#4=;
|SI FSalida = 0;
   |SI #0#43 = AN;
      #4#50 = #4#50 +. cant;    || es albaran
   |SINO;
      #4#50 = #4#50 -. cant;    || es abono
   |FINSI;
   |GRABA 020#4a;
   |LIBERA #4;
|FINSI;
|CIERRA #4;

     |SI #0#43 = "N";
          enImpCliPen = cant * nForma;
     |SINO;
          enImpCliPen =  -cant * nForma;
     |FINSI;
     eaCliente = #0#3;
     efFecha = #0#1;
     |HAZ AcumulaCli;

     |HAZ riesgo_cli;
|FPRC;


|PROCESO abo;|TIPO 0;
con = (FEntrada / 100) ! 0;
|SI con = 2;|Y #0#43 ! Contenido;
   |MENAV "0000No puede modificar este campo !";
   |ERROR;
|FINSI;
|FPRC;

|PROCESO totalba;|TIPO 14;
|PINTA 0577,"  ";
|SI #0#41 = 0;|Y #0#42 = 0;
     |PINTA 0577,"AV";
|SINO;
     |SI #0#41 ! 0;
          |PINTA 0577,"PV";
     |SINO;
          |SI #0#42 ! 0;
               |PINTA 0577,"AD";
          |FINSI;
     |FINSI;
|FINSI;
|FPRC;

|PROCESO para_ger;
     nModo = (FEntrada / 100) ! 0;
     |ABRE #42; |LEE 001#42p; |CIERRA #42;
     avisa_st = #42#5;
     n_dec = #42#8;
     n_pre = #42#9;
     kit  = #42#12;
     dto_prom = #42#18;
     recoge = #42#27;
     DescAmpli = #agifa142#40;     || Descargar descripcion ampliada
     |ABRE #44;
     #44#26 = #0#52;
     |LEE 001#44=;
     |SI FSalida ! 0; |DDEFECTO #44; |FINSI;
     |CIERRA #44;
     def_alm = #44#29;
     def_exp = #44#30;
     |SI #44#30 = "S";
          #0#12 = 0;
          #0#14 = 0;
          |PINTA #0#12;
          |PINTA #0#14;
     |FINSI;
     |SI nModo = 1;
          |C_M #0#51, 1, "S";
          #0#51 = #44#28;
          |SI #44#37 = "S"; #0#51 = "N"; |C_M #0#51,1,"N"; |FINSI;
     |FINSI;
     |PINTA #0#51;
     |HAZ LeeMonBase;
     |HAZ LeeParamDiv;
|FPRC;


|PROCESO mira_d;
     #0#2 = #0#2 ! n_dec;
     |PINTA #0#2;
|FPRC;

|PROCESO extracto;
          modo = (FEntrada / 100) ! 0;
          |SI modo = 4;
               |ABRE #4;
               #4#0 = #0#3;
               |LEE 001#4=;
               |SI FSalida ! 0; |DDEFECTO #4; |FINSI;
               |CIERRA #4;
          |FINSI;
          |PUSHV 0501 2380;
          ext1 = #4#16;
          |SUB_EJECUTA_NP "caextrap";
          |POPV;
|FPRC;

|PROCESO entra_1; |TIPO 7;
     |HAZ ControlUsuAV;
     |SI enErr ! 0; |PTEC 807; |ACABA; |FINSI;

     |HAZ DefSerVta;

     |SI PRMNT_aHisto ! "";
          ser_alb = PRMNT_aHisto % 105;
          num_alb = (A\(PRMNT_aHisto % 6));

          #0#52 = ser_alb;
          #0#0 = num_alb;
          |PTEC 802;
          |PTEC 802;
          |PINTA #0#52;
          |PINTA #0#0;
     |FINSI;
     |SI sw_pinta = 0;
          |ABRE #agifa204;
          #agifa204#0 = "A";
          |LEE 001#agifa204.=;
          |CIERRA #agifa204;
          sw_pinta = 1;
     |FINSI;
|FPRC;

|PROCESO pinta_obs; |TIPO 14;
     puente = #agifa204#6; |QBF puente;
     |SI puente ! "";
         |ATRI I;  |PINTA 2005 , puente;    |ATRI 0;
         |C_M #0#55 , 1 , "S";
     |FINSI;

     puente = #agifa204#7; |QBF puente;
     |SI puente ! "";
         |ATRI I;  |PINTA 2030 , puente;    |ATRI 0;
         |C_M #0#56 , 1 , "S";
     |FINSI;

     puente = #agifa204#8; |QBF puente;
     |SI puente ! "";
         |ATRI I;  |PINTA 2055 , puente;    |ATRI 0;
         |C_M #0#57 , 1 , "S";
     |FINSI;

     |ATRI I;
|FPRC;

|PROCESO riesgo_cli;
     eaTag = "AV";  |HAZ RiesgosMalpe;
|FPRC;

|PROCESO mira_riesgo;
     |SI aRieBloqu = "S";
          aAlfa = "    Riesgo bloqueado. Referencia : " + aBloquead;
          |MENAV aAlfa;
          |ERROR;
          |ACABA;
     |FINSI;
     |SI #agifa142#6 = "S";
          |SI nRieTotal ! 0;
               |PUSHV 0501 2380;
               |BLANCO 0948 1672;
               |CUADRO 1148 1672;
               |CUADRO 0948 1672;
               |ATRI R; |PINTA 1049, "  < CONTROL RIESGOS >  "; |ATRI 0;
               |ATRI I;
               |PINTA 1250, "Concedido:";
               |PINTA 1350, "Total ...:";
               |PINTA 1261, nRieTotal;
               |PINTA 1361, nRieUtili;
               |ATRI 0;
               |PAUSA;
               |POPV;
          |FINSI;
     |FINSI;
|FPRC;


|PROCESO consulta; |TIPO 0;  || Consulta Por Clientes
     modo = (FEntrada / 100) ! 0;
     |SI FSalida = 9;
          |SI modo = 1;
               |MENAV "0000No es posible la consulta en modo ALTA";
               |ERROR;
          |SINO;
               |CONSULTA_CLAVE #2#0;
          |FINSI;
     |FINSI;
|FPRC;


|| Borrar los trabajos de Albaranes

|PROCESO bortrab1;
 |BUCLELIN 1NULL#100;
 |BORRA 020#100a;
 |LIBERA #100;
|FPRC;

|DEFBUCLE bortrab;
 #100#4;
 ;
 sserie,nnumer;
 sserie,nnumer;
 be;
 NULL, bortrab1;
|FIN;

|PROCESO bajatrabajo;
     |ABRE #42; |LEE 000#42p; |CIERRA #42;

     |SI #42#132 = "S";
         sserie = #0#52;
         nnumer = #0#0;
         |BUCLE bortrab;
     |FINSI;
|FPRC;


___________/ VIC 15-07-98

_____________________________________/ COMPROBACION CLIENTE / SERIE.



|PROCESO LeeMonBase; ||Lee los parametros de la moneda base
     |ABRE #agifa321;
     |ABRE #agifa324;
     |LEE 010#agifa321.p;   ||Leo parametros de divisa
     #malpe090#73 = #agifa321#9;  ||Cojo la Moneda Base de parametros
     #agifa324#0 = #agifa321#9;
     |LEE 010#agifa324.=;         ||Leo la ficha de la moneda base en Divisas
     #malpe090#74 = #agifa324#2;  ||Asigno el cambio de la moneda base con el euro
     decim_base = #agifa324#7;    ||Asigno los decimales de la moneda base
     precio_base = #agifa324#9;   ||Asigno los decimales del precio en la mon. base
     |CIERRA #agifa324;
     |CIERRA #agifa321;
|FPRC;

|PROCESO Param_Divisas; |TIPO 0;
     pintado = 0;  ||Controla pintados de las lineas

     |ABRE #agifa324;
     #agifa324#0 = #malpe090#68;
     |LEE 001#agifa324.=;   || Leo la divisa
     |CIERRA #agifa324;

     decim_divisa = #agifa324#7;  || Decimales de la divisa
     precio_divisa = #agifa324#9;  || Decimales en el precio de la divisa
     nDeci_Div = decim_divisa;   || Decimales de la divisa
     nDeci_PreDiv = precio_divisa;  || Decimales en el precio de la divisa
     |SI #0#70 = "B";   || Si trabajo con la moneda base ...
          nDeci_PreVis   = precio_divisa;
          nDeci_ImpVis   = decim_divisa;
          nDeci_Base     = decim_base;
          nDeci_PreBase  = precio_base;
          nDeci_BaseMx  = decim_base;
          nDeci_PreBaseMx = precio_base;
          nDeci_TotVis   = decim_base;
          nDeci_TotNoVis = decim_divisa;
     |SINO;     || Si trabajo con la divisa ...
          nDeci_PreVis   = precio_base;
          nDeci_ImpVis   = decim_base;
          nDeci_Base     = decim_base; || Max. precision en los decimales de la moneda base
          nDeci_PreBase  = precio_base;  || Max. precision en los dec. del precio de la moneda base
          |SI #malpe090#69 = 1;
               nDeci_BaseMx    = decim_base;    || sin triangulacion
               nDeci_PreBaseMx = precio_base;
          |SINO;
               nDeci_BaseMx    = #agifa321#10;  || con triangulacion
               nDeci_PreBaseMx = #agifa321#11;
          |FINSI;
          nDeci_TotVis   = decim_divisa;
          nDeci_TotNoVis = decim_base;
     |FINSI;
     |HAZ Deci_IVA;
|FPRC;

|PROCESO LeeParamDiv; |TIPO 0;
     |ABRE #agifa321;
     |LEE 001#agifa321.p;    || Leo parametros de divisas
     |ABRE #agifa007;
     #agifa007#26 = #malpe090#52;
     |LEE 001#agifa007.=;        || Leo la serie

     |SI #agifa007#39 = "N"; |O #agifa321#1 = "N";
          #0#70 = "B";
     |FINSI;
     ||ÄÄÄÄÄÄÄÄPortes/Varios
     |C_P #0#81, 0, nPos; |C_P #0#11, 1, nPos;
     |C_P #0#82, 0, nPos; |C_P #0#13, 1, nPos;
     |C_V #0#11, 1, "N";
     |C_V #0#13, 1, "N";
     |C_V #0#81, 1, "N";
     |C_V #0#82, 1, "N";
     |SI #0#70 = "D";
          |C_V #0#81, 1, "S";
          |C_V #0#82, 1, "S";
     |SINO;
          |C_V #0#11, 1, "S";
          |C_V #0#13, 1, "S";
     |FINSI;

     |CIERRA #agifa007;
     |CIERRA #agifa321;
     |HAZ Param_Divisas;
|FPRC;

|PROCESO CambioDivisa; |TIPO 0;
     nModo010 = (FEntrada / 100) ! 0;
     |SI nModo010 = 1;   ||Si cambia el valor o es alta
          |SI Campo = 3; || Si llamo al proceso desde el cod. de cliente ...
               |ABRE #agifa024;
               #agifa024#0 = #0#3;
               |LEE 020#agifa024.=;
               |CIERRA #agifa024;
               #0#68 = #agifa024#192;  || Asigno la divisa por defecto del cliente
               #0#70 = #agifa024#193;  || Asigno la moneda de trabajo del cliente
               #0#36 = #agifa024#47;   || Regimen Equi
               |PINTA #0#70;
          |FINSI;
          |ABRE #agifa007;
          #agifa007#26 = #malpe090#52;
          |LEE 020#agifa007.=;  || Leo la serie
          |CIERRA #agifa007;
          |SI #agifa007#39 = "S"; |Y #agifa321#1 = "S";
               |SI #agifa024#191 = "S"; || Si el cliente es de divisa pactada
                    |ABRE #agifa328;
                    |ABRE #agifa329;
                    #agifa329#0 = #malpe090#3;
                    #agifa329#2 = #malpe090#68;
                    #agifa329#7 = "N";
                    |SELECT #2#agifa329;  || Con esta clave ...
                    |LEE 011#agifa329.=;  || ... busco periodos no finalizados de esa divisa
                    |SI FSalida = 0;  || Si existe un periodo no finalizado
                         |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
                              #malpe090#68 = #agifa329#2;        || Cargo la divisa ...
                              #malpe090#69 = #agifa329#3;        || ...y el cambio
                              |LEE 001#agifa329.=;   || Leo las lineas de Clientes/Divisas
                              nfecha = #malpe090#1 - #agifa329#6;  || Resto la fecha de fin de periodo a la actual
                              |SI nfecha > 0;  || Si la fecha actual supera a la del periodo asignado ...
                                   |MENAV "0000ATENCION deberia Actualizar primero la divisa en Clientes/Divisas";
                                   cli_divisa = #malpe090#3;  || Le envio el cod. de cliente a "agifa328"
                                   |SUB_EJECUTA_NP "agifa328.tab";  || Ejecuto Clientess/Divisas
                                   |ERROR;
                              |SINO;
                                   div_act = 1;  || Para salir del PARA
                              |FINSI;
                         |SIGUE;
                    |SINO;  || Si no existe un periodo no finalizado para esa divisa
                        |MENAV "0000No existe un periodo activo para la divisa en Clientes / Divisas";
                        cli_divisa = #malpe090#3;  || Le paso a "agifa328" el cliente
                        |SUB_EJECUTA_NP "agifa328.tab";  || Ejecuto Clientes / Divisas
                        |ERROR;
                    |FINSI;
                    |SELECT #1#agifa329;
                    |CIERRA #agifa329;
                    |CIERRA #agifa328;
               |SINO; || Si el Cliente no es de Divisa pactada ...
                    |ABRE #agifa324; || ...miro directamente en divisas
                    #agifa324#0 = #malpe090#68;
                    |LEE 001#agifa324.=;
                    |SI FSalida = 0; ||Si existe la divisa...
                         #malpe090#69 = #agifa324#2; || la recojo
                         |SI #agifa324#5 ! -1; || Si los dias de margen de actualizacion no
                                       || son = -1 (indefinidos)
                              |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
                                   #malpe090#68 = #agifa324#0;        ||Cargo el valor de la divisa
                                   #malpe090#69 = #agifa324#2;        ||Cargo el valor del cambio
                                   |LEE 001#agifa324.=;  || Leo la divisa
                                   nfecha = #malpe090#1 - #agifa324#4;
                                   |SI nfecha > #agifa324#5; |Y #agifa324#5 ! -1;  || Si la fecha actual
                                        |MENAV "0000ATENCION deberia Actualizar primero la divisa";
                                        divisa = #malpe090#68;
                                        |SUB_EJECUTA_NP "agifa326.tab";
                                        |ERROR;
                                   |SINO;
                                        div_act = 1;
                                   |FINSI;
                              |SIGUE;
                         |FINSI;
                    |FINSI;
                    |CIERRA #agifa324;
               |FINSI;
          |SINO;
               #malpe090#68 = #malpe090#73;
               #malpe090#69 = #malpe090#74;
          |FINSI;
          |PINTA #malpe090#68;
          |PINTA #malpe090#69;
          |SI Campo = 3; || Si llamo al proceso desde el cod. de cliente ...
               |HAZ LeeParamDiv;
          |SINO;
               |HAZ Param_Divisas;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO convportes; |TIPO 6;
     |SI #0#70 = "D";
          #0#11 = #0#81 / #0#69 * #0#74;
     |SINO;
          #0#81 = #0#11 * #0#69 / #0#74;
     |FINSI;
     |HAZ dcon;
|FPRC;

|PROCESO convvarios; |TIPO 6;
     |SI #0#70 = "D";
          #0#13 = #0#82 / #0#69 * #0#74;
     |SINO;
          #0#82 = #0#13 * #0#69 / #0#74;
     |FINSI;
     |HAZ dcon;
|FPRC;

|PROCESO PintRemanente;
     |DDEFECTO #137;
     |ABRE #137;
     #137#0 = #0#6;
     |LEE 000#137=;
     |CIERRA #137;
     |PINTA 845, #137#7;
     |PINTA 865, #137#8;
|FPRC;

|PROCESO LeeAlb; |TIPO 13;
     pintado = 0;   || controla pintado de las lineas
     |HAZ LeeMonBase;
     |HAZ LeeParamDiv;
     |HAZ PintRemanente;
     |HAZ PinInciObra;
|FPRC;

|PROCESO cambfecha;
     |SI #0#71 ! "O";
       #0#72 = "        ";
       |PINTA #0#72;
       |C_M #0#72,1,"N";
       |C_V #0#72,1,"N";
     |SINO;
       |C_M #0#72,1,"S";
       |C_V #0#72,1,"S";
     |FINSI;
|FPRC;

|PROCESO xmodomod; |TIPO 6;
   |SI nModo010 = 2; |Y #0Campo ! Contenido;
       |MENAV "0000No se puede modificar el campo.";
       #0Campo = Contenido;
       |PINTA #0Campo;
       |ERROR;
   |FINSI;
   |SI #0Campo ! Contenido; |Y Campo = 70;
     |HAZ LeeParamDiv;
   |FINSI;
|FPRC;

|PROCESO caltotal; |TIPO 0; ||Proceso especial para casos determinados como
                            ||modificar los campos de cabecera en dtos, cambio divisas etc
                            ||Recalcula total albaran, descuentos y ivas de lineas
                            ||En el caso de cambiar el cambio de divisas recalcula tambien precio... de lineas

     |SI #0Campo ! Contenido;|O control = 1; ||Solo si cambia
          caltot = 1;
          |SI Campo = 69; ||Si viene del cambio divisa
              recalpre = 1; ||Recalcular tambien precios linea
          |FINSI;
          |HAZ convportes;
          |HAZ convvarios;
          |HAZ actal;

          |PINTA #0#78;
          caltot = 0;
          recalpre = 0;
     |FINSI;
|FPRC;

|PROCESO PortesPD; |TIPO 7;
/*
     |SI #0#64 = " ";
          #0#64 = #42#100;
          |PINTA #0#64;
     |FINSI;
*/
|FPRC;

|PROCESO SumaImpCta;
       naCum = naCum + #200#9;
|FPRC;

|DEFBUCLE SumaImp;
     #200#1;
     ;
     "A",SPedido,NPedido, 00;
     "A",SPedido,NPedido, 99;
     be;
     NULL, SumaImpCta;
|FIN;


||________________________// 27 - 04 - 98
|PROCESO a_cta; |TIPO 0;
     salida = FSalida;
     |SI salida = 9;                         || F1
          |SI #42#86 ! "S";
              |MENAV "    Pagos a cuenta con recibo, desactivados ...";
          |SINO;
              |HAZ a_cta2;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO a_cta2;
         TipoCta = "A";
         Cliente = #0#3;
         SPedido = #0#52;
         NPedido = #0#0;
         FPedido = #0#1;
         PPedido = #0#8;
         TPedido = 0;
         BAdela  = 0;
         |GRABA 020#0a;
         |LIBERA #0;
         |CIERRAT #0;
         |SUB_EJECUTA_NP "agis0002";
         |ABRET #0;
         |LEE 101#0=;
         |BUCLE SumaImp;

         #0#61=naCum;
         |PINTA #0#61;
         naCum = 0;

         |ERROR;
|FPRC;

|PROCESO acttl;|TIPO 0;
     nModo = (FEntrada / 100) ! 0;

     |ABRE #2;
     #2#0 = #3#2;
     |LEE 000#2=;
     |CIERRA #2;

     |SI caltot = 0;
         |PINTA 443,#3#1;
         #3#15 = #0#3;
         #3#16 = #0#34;
         #3#17 = #0#35;
         |SI nModo ! 4;
               |HAZ TotalLinMp;
               |GRABA 020#3a;
               |SI #0#70 = "D";     || Si la moneda de trabajo es la divisa ...
                    |PINTA #3#37;
               |SINO;               || Si la moneda de trabajo es la moneda base ...
                    |PINTA #3#9;
               |FINSI;
               |SI ac_divisa = "S"; |Y #agifa321#3= "S";
                    |PINTA #3#39;   || Si las divisas y la visualizacion estan activadas, pinto
               |FINSI;
          |FINSI;
     |FINSI;

     |HAZ CalCabMalpe090;

     ||------------Historico
     |SI nModo ! 4;
          |HAZ ModiHistoAVMp;
     |FINSI;

     |LIBERA #3;
|FPRC;

|DEFBUCLE malpe091;
     #3#1;
     ;
     #0#52, #0#0, 001;
     #0#52, #0#0, 999;
     be;
     NULL, acttl;
|FIN;

|PROCESO ElTipo3; |TIPO 3;
     |SI enErr = 0;
          nModo = (FEntrada / 100) ! 0;
          |HAZ LinCabMalpe090;
          |BUCLE malpe091;
     |FINSI;
     enErr = 0;
|FPRC;

|PROCESO actal;
     |HAZ LinCabMalpe090;
     |BUCLE malpe091;
|FPRC;

|PROCESO siimpre;|TIPO 30;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |SI #42#86 = "X";
         |HAZ apagar;
     |FINSI;

     |SI #42#132 = "S";
          |CONFI "0000N¨Desea introducir la descripcion del trabajo? (S/N) ";
          |SI FSalida = 0;
               sserie = #0#52;
               nnumer = #0#0;
               ffecha = #0#1;
               cclien = #0#3;
               nnombr = #0#4;
               iimpor = #0#15 - #0#25;
               ccoste = 0;
               |BUCLE calcoste;
               |PUSHV 0501 2380;
               consulta = "N";
               |SUB_EJECUTA_NP "agi00002";
               |POPV;
          |FINSI;
     |FINSI;

     ||-------------------------------------------
     |CONFI "2400NDesea imprimir este albaran? ";
     |SI FSalida = 0;
         |GRABA 021#0a;
         |LIBERA #0;

         |HAZ impreal;

         |LEE 101#0=;
     |FINSI;

     |HAZ ChequeaDivisa;
     |SI FSalida ! 0;
          |MENAV "0000Moneda de trabajo del albaran erronea...";
          |MENAV "0000Consultar con administracion para solventar el problema.";
          |ACABA;
     |FINSI;

     |MODULO puente;     |QBF puente;
     |SI #42#17 = "S"; |Y #0#51 = "S"; |Y puente = "malpe090";
          |SI #42#19 = "S";
               |CONFI "2400NDesea Facturar este Albaran : ";
               |SI FSalida ! 0;  |ACABA;  |FINSI;
          |FINSI;

          |GRABA 021#0a;
          |LIBERA #0;
          |CIERRAT #0;

          ser_alb = #0#52;
          num_alb = #0#0;
          fec_alb = #0#1;
          abo_alb = #0#43;
          |PUSHV 0101 2480;
               |SUB_EJECUTA_NP "agifa057";       ||Facturar Albaranes
          |POPV;
          |ABRET #0;
          #0#0 = num_alb;
          #0#52 = ser_alb;
          |LEE 101#0=;
     |FINSI;
|FPRC;

|PROCESO impreal;
     ser_alb = #0#52;
     num_alb = #0#0;
     abono = #0#43;                 || Abono S/N para discriminar los formatos
                                    || en agifa014

     |CIERRAT #0;
     |SUB_EJECUTA_NP "agifa014";    || Impresion de albaranes
     |ABRET #0;

     #0#52 = ser_alb;
     #0#0 = num_alb;
     |LEE 000#0=;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
_____________________________________/ BUSCA UN CODIGO DE CLIENTE AUTOMATICO.
|PROCESO Menus2;
     |MENU menu;
     |SI FSalida = 1;    ||Automatico
          |ABRE #41;
          #41#2 = "";
          #41#0 = "clientes";
          |LEE 101#41=;
          |SI FSalida = 0;
               #41#1 = #41#1 + 1;
               contador = #41#1;
               |GRABA 021#41a;
          |SINO;
               contador = 1;
               #41#1 = 1;
               |GRABA 021#41n;
          |FINSI;
          cont = contador;
          cont = ("000000" + cont) % -106;
          #0Campo = cont;
          |PINTA #0Campo;
          |LIBERA #41;
          |CIERRA #41;
     |FINSI;
|FPRC;

|PROCESO AltaCli;
     NoExiste = 0;
     alfa = #0#3; |QBF alfa;
     |SI alfa ! ""; |Y #42#1 = "S";
          |ABRE #4;
          #4#0 = #0#3;
          |LEE 000#4=;
          |SI FSalida ! 0;
               NoExiste = 1;
               |HAZ Menus2;
          |FINSI;
          |CIERRA #4;
     |FINSI;
     |SI #42#1 = "N";
          |HAZ Clie6;
     |FINSI;
|FPRC;

|PROCESO Cli10_0; |TIPO 0;
     |HAZ CambioDivisa;

     eaCliente = #0#3;
     eaSerie = #0#52;
     eaTipo = "A";
     |HAZ ExisteCliRie;
|FPRC;

|PROCESO Cli10_6; |TIPO 6;
     nModo010 = (FEntrada / 100) ! 0;
     salida = FSalida
     nError6 = 0;

     |HAZ AltaCli;

     |ABRE #4;
     #4#0 = #0#3;
     |LEE 000#4=;
     |CIERRA #4;
     |SI nModo010 = 1; #0#6 = #4#25; |FINSI;

     |HAZ pedcon0;

     |SI NoExiste ! 0; |ACABA; |FINSI;

     |SI salida = 13;
          |HAZ extracto;                       || F5 (extracto)
     |FINSI;
     |SI salida = 11; |O #42#102 = "S"; |O #42#102 = "X";|| F3 Observaciones
          |SI salida ! 2;
               eaFuerza = "N";
               |SI salida = 11; eaFuerza = "S"; |FINSI;
               eaCodigo = #0#3;
               |SUB_EJECUTA_NP "dsz99994";
               |SI #42#102 = "N"; |Y nModo010 ! 2; nError6 = 1; |FINSI;
          |FINSI;
     |FINSI;
     |HAZ alriesgo;
     |SI nError6 ! 0; |ERROR;  |FINSI;
|FPRC;

|PROCESO Dto10_7; |TIPO 7;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO Clie6; |TIPO 6; || POR PROBLEMAS CON RELACIONES
     |ABRE #4;
     #4#0 = #0#3;
     |LEE 000#4=;
     |SI FSalida ! 0;
          aAlfa = "dsz99955;" + #0#3;
          |SUB_EJECUTA_NP aAlfa;
     |FINSI;
     |CIERRA #4;
|FPRC;

|PROCESO ModRema; |TIPO 0;
     aAlfa = #0#103;
     ||C_M #3#74, 1, aAlfa;
     ||C_M #3#75, 1, aAlfa;
     ||C_M #3#76, 1, aAlfa;
|FPRC;

|PROCESO ChequeaDivisa;
     |ABRE #38;
     #38#0 = #0#68;
     |LEE 000#38=
     aAlfa = FSalida;
     |CIERRA #38;
     FSalida = aAlfa;
|FPRC;

|PROCESO PinInciObra;
     |PINTA 520, "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ";
     |ABRE #185;
     #185#0 = #0#3;
     #185#1 = #0#84;
     #185#2 = 1;
     |LEE 000#185];
     |SI FSalida = 0; |Y #185#0 = #0#3; |Y #185#1 = #0#84;
          |ATRI S; |PINTA 520, " Obra con incidencias "; |ATRI 0;
          |PARA; |SI FSalida = 0; |Y #185#0 = #0#3; |Y #185#1 = #0#84; |HACIENDO;
               |SI #185#7 = "A";
                    |ATRI S; |PINTA 520, " OBRA CON INCIDENCIAS ABIERTAS "; |ATRI 0;
               |FINSI;
               |LEE 000#185s;
          |SIGUE;
     |FINSI;
     |CIERRA #185;
|FPRC;

|PROCESO InciObra;
     eaCliente = #0#3;
     enObra = #0#84;
     enModo = 4;
     |SUB_EJECUTA_NP "malpe185";
|FPRC;

|PROCESO Tipo90_20; |TIPO 20;
     |SI FSalida = "OPCION";
          FSalida = "Opciones";
     |SINO;
          |SELECT #1#0;
          |LEE 101#0=;
          |SI FSalida ! 0; |AVISO; |ACABA; |FINSI;
          |MENU aMenu;
          |SI FSalida = 1;
               |HAZ impreal;
          |FINSI;
          |SI FSalida = 2;
               |HAZ InciObra;
          |FINSI;
          |LIBERA #0;
     |FINSI;
|FPRC;

|PROCESO Obra; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
          |ABRE #1000;
          #100#0 = #0#3;
          #100#1 = #0#84;
          |LEE 000#1000=;
          |SI FSalida = 0;
               #0#93 = #1000#2; |PINTA #0#93;
               #0#94 = #1000#3; |PINTA #0#94;
               #0#95 = #1000#4; |PINTA #0#95;
               #0#30 = #1000#5; |PINTA #0#30;
               #0#31 = #1000#6; |PINTA #0#31;
               #0#62 = #1000#25; |PINTA #0#62;
               #0#33 = #1000#7; |PINTA #0#33;
          |FINSI;
          |CIERRA #1000;
     |FINSI;
|FPRC;

|PROCESO IVA090_66; |TIPO 66;
     enTiva = #0Campo;
     efFiva = #0#1;
     |HAZ ConsuIVA;
     |SI eaDiva = "";
          |ERROR;
     |SINO;
          #0Campo = enTiva; |PINTA #0Campo;
     |FINSI;
|FPRC;

|PROCESO IVA090_0; |TIPO 0;
     enTiva = #0Campo;
     efFiva = #0#1;
     |HAZ SacaIVA;
     |SI eaDiva = "";
          |MENAV "0000No existe tipo iva para esta fecha...";
          |ERROR; |ACABA;
     |SINO;
          |HAZ caltotal;
     |FINSI;
|FPRC;
