|FICHEROS;
   agifa711 #0;
   agifa712 #1;
   agifa705 #2,MANTE;
   agifa706 #3,MANTE;
   agifa702 #4;
   agifa717 #71,MANTE;
   agifa718 #72,MANTE;
   agifa721 #73;
   agifa723 #74;
   agifa077 #75;
   agifa080 #76;

   agifa716 #5,MANTE;

   agifa714 #714;
   agifa715 #715;
   agifa007 #70;

   &FMaster@ #9;
   FEsclav@ #10;
   Referen@ #11;
   Princip@ #12;
   RegNifs@ #16;

   agifa704 #13;
   agifa707 #14,MANTE;
   agifa722 #15;

   con00002 #50;
   con00004 #51;
   con00005 #52;

   canempr@ #20;
   &caenlac@ #23;
   caconas@ #24;
   camoned@ #25;
   calibro@ #26;
   camasic@ #27;

   Tempo00@ #60;
   agifa024 #61;
   agifa112 #62;

   agifa321 #100;
   agifa324 #101;

   RefDato@ #500;
   agifa727 #1000;

   agifa071 #5000;
   agifa010 #5001;
   agifa080 #5002;
   agifa077 #5003;
   agifa134 #5004;
   agifa059 #5005;
   agifa084 #5006;
   agifa069 #5007;
   agifa079 #5008;
   agifa072 #5009;
|FIN;

|VARIABLES;
   nCuenta = 0;
   &eaDef = "";
   &enPeriodoBaja = 0;
   nSwTagloma = 0;
   &efFecCta = @;
   &eaBloqLiquiVta = "";
   &eaBloqLiquiCom = "";
   aSwBloqueoLiqui = "S";
   aTieneRecargo   = "";

   aSobreIRPF      = "";
   nBruto          = 0;
   nNeto           = 0;

   &enTipoREC = 0;
   &eaSerFac = "";
   &enNumFac = 0;
   &enSwTaller = 0;
   &enSwAgifa079 = 0;
   &enSwCarga620 = 0;
   &eaSwObra     = "";

   &enSwEnlSeries = 0;

   &enEmpresaOriClon = 0;
   &eaSerieOriClon   = "";
   &enNumFraOriClon  = 0;
   &enReContab       = 0;

   aContrato = "";
   nContrato = 0;
   nSwSematel = 0;
   nNumDoc    = 0;

   &enTipoIVA = 0;
   &efFechaIVA = @;
   &enSwMensa  = 0;

   &enGenAsi0 = 0;
   &enGenIva0 = 0;
   &enSwExport = 0;
   &eaCtaAna = "";
   &eaCuaAuto = "";
   &eaRecAuto = "";
   &enEdificio  = 0;
   &enDiario    = 0;
   &efFecha     = @;
   &enDocum     = 0;
   &enApunt     = 0;
   &enImporte   = 0;
   &eaCuenta    = "";
   &eaTipoAviso = "";
   &eaAviso     = "";
   &eaEmpProced = "";

   &enSw      = 0;

   &eaPath    = "";
   &eaFich    = "";

   &enNoModif = 0;
   &enFactura116 = 0;
   &eaCodEnlace = "";
   &enNumRegs   = 0;
   &eaPathAplic = "";
   &eaCtaAnalit = "";

   &eaSerie     = "";
   &enFactura   = 0;
   &eaFamilia   = "";
   &enIncLin    = 0;
   &eaArticulo = "";
   &eaProveedor = "";
   &eaTipoEnl   = "";

   &nDeci_nDec = 0;

   &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
   &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
   &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base
   &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base
   &nDeci_DivF     = 0;   || Decimales en Totales de la divisa
   &nDeci_PreDivF  = 0;   || Decimales en el Precio en divisa
   &nDeci_TotVisF  = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
   &nDeci_TotNoVisF = 0;  || Decimales en Totales no visibles (el de la otra moneda)
   &nDeci_PreVisF  = 0;   || Decimales en el Precio visual. (lineas)
   &nDeci_ImpVisF  = 0;   || Decimales en el Importe visual. (lineas)
   &nDeci_IVA      = 0;
   &nDeci_IVADiv   = 0;
   &nDeci_IVAImp   = 0;
   &aDivisa = "";
   &aMoneda = "";
   &enSwComport = 0;

   &enEmpresa = 0;
   &enPeriodo = 0;

   &eaNombre = "";
   &eaCif    = "";
   &eaSinCompr = 0;
   &eaRuta   = "";

   &PRMNT_enError = 0;
   &PRMNT_enVer   = 0;
   &PRMNT_enSwPCEG = 0;
   &PRMNT_enLuxeRec = 0;
   &PRMNT_ActCliPro = "";

   &enSwError    = 0;
   &eaSerAlbaran = "";
   &enNumAlbaran = 0;
   &eaTipoImporte = "";

   nHayDto      = 0;
   nImpDto      = 0;
   nErrContador = 0;
   nSwBusca = 0;
   nCaja = 0;
   nSwError = 0;
   nLinPinta = 0;
   nSalva    = 0;
   nSinPrelv = 0;
   nNumBase  = 0;
   nSwTipo   = 0;
   nSwPCEG   = 0;

   fFechaEje = @;
   fFechaIni = @;
   fFechaFin = @;

   fFechaHEnl = @;

   aDepart  = "";
   aSubDep  = "";
   aCodigo  = "";
   aVersion = "";
   aFicSQL  = "";

   aClaveA = "";
   aClaveB = "";

   nSigue = 0;
   aCmp1 = "";
   aCmp2 = "";
   aCmp3 = "";
   nCmp1 = 0;
   nCmp2 = 0;
   nDi = 0; fFe = @; nDo = 0; nEm = 0; nPe = 0; nSaldo = 0;
   aMensaje = "";
   nHandle  = 0;
   nHandle1 = 0;
   nPerAnt  = 0;
   nSwErrCta = 0;

   nSwCambioReg = 0;
   nCalc1 = 0; nCalc2 = 0; nCalc3 = 0; nCalc4 = 0;

   nAsError = 0; nEjerc = 0;

   nCampo1 = 0;
   nCampo2 = @;
   nCampo3 = 0;
   nCampo4 = 0;
   nCampo5 = 0;
   nCampo6 = 0;

   aGrupoCta = "";

   aCifCand = ""; aTipoCif = "";
   aCandiAnt = ""; aClvAnt1 = ""; aClvAnt2 = "";
   aAlfa1Cand = ""; aAlfa2Cand = "";

   nPeriodo = 0;  nEmp = 0; nPer = 0; nAnyo = 0; nEje = 0; nFlag = 0;
   nEmpr1   = 0;  nPeri1 = 0;  nContador = 0;
   TotalRec = 0;  TotalIva = 0; Depart = "";
   Direc    = ""; MarcaPant = "|";
   aAlfa = ""; aAlfa1 = ""; aAlfa2 = ""; aAlfa3 = ""; aAlfa4 = ""; aAlfa11 = "";
   aAlfa5 = ""; aAlfa6 = ""; aAlfa7 = ""; aAlfaN = "";

   nCalcX = 0; nCalc1X = 0;
   aAlfaX  = ""; aAlfa1X = ""; aAlfa2X = "";
   aAlfa3X = ""; aAlfa4X = "";
   nSwFormato = 0;
   &efFechaForm = @;

   DComodin = ""; HComodin  = ""; Ref = ""; Mast = "";
   Comodin  = ""; PathAplic = ""; Fichero = ""; MemoAnt   = "";
   Comodin1 = ""; Comodin2  = ""; Mensaje = ""; Expresion = "";
   ComodNum = 0;  Primero   = 0;  ConIva = 0;
   Calc = 0; Calc1 = 0; Calc2 = 0; Calc3 = 0; Calc4 = 0;
   Cont = 0; Cont1 = 0; Cont2 = 0; nCont = 0;
   aLong = "";     nLong = 0;
   Oper1 = 0;      Oper2 = 0;
   Operacion = ""; NVuelta = 0; Resultado = 0;
   FacContra = 0;  aNome = "";

   Tipo = ""; nNumero = 0; Modif = ""; Emision = ""; Caracter = "";

   Cuenta = ""; Descr = ""; Cadena = ""; nImporte = 0; nCalc = 0;
   UltimoAsiento = 0;
   UltimoApunte  = 0;
   nMaxApunte    = 0;

   TipoDato = ""; LongDato = 0; aTipoEnl = ""; aCtaAn = "";

   aCiagan = "";
   Fich = ""; LinRel = 0; Fich1 = "";
   Cmp  = ""; SwCondic = 0; nNume = 0; nAsientAnt = 0;

   Salir = 0; Opcion = 0; NumIva = 0; NumBase = 0; NumRec = 0;

   &CodEnlace = ""; CmpContab = 0; CmpRegist = 0;

   PosicAPar = 0;  PosicCPar = 0;
   Cad1 = ""; Cad2 = "";
   Neg = 0; Modo = "";
   &fich_alta = "";
   aBusca = "";
   aClave1 = ""; aClave2 = ""; aClave3 = "";
   nHayPortes = 0; nHayVarios = 0;

   NumAsientos = 0; NumRegistro = 0; TotalRegs = 0;

   NomFich = ""; NumCmps = 0; FichRelac = ""; NombreRel = "";
   NumCmps1 = 0; NumCmps2 = 0; nImpCuadre = 0;

   Clave1 = ""; Clave2 = ""; Clave11 = "";
   CmpClave1 = 0; CmpClave2 = 0;

   Empresa = 0; Periodo = 0; PathEnlace = ""; Tecla = 0;

   CmpDebe  = 0; CmpHaber = 0; CmpSaldo = 0;
   TotDebe  = 0; TotHaber = 0; TotSaldo = 0;
   SwNivel = 0; Nivel = 0; UltDocum = 0; UltApunt = 0;
   Dig1 = 0; Dig2 = 0; Dig3 = 0; Dig4 = 0; Dig5 = 0; Dig6 = 0;

   DigFormat = 0; FEstado = 0;
   NumReg = 0;

   UltFecha  = @; UltRecibo = 0; ReciboAct = 0; fFecha = @; Fecha = @;
   fFechaAnt = @;
   CmpClave1Cab = ""; CmpClave2Cab = ""; CmpClave3Cab = "";
   fFechaAcot1 = @; fFechaAcot2 = @;

   NumApunte = 1; NumAsto = 0;

   Libro = 0; Serie = 0; Factura = 0; Recibo = 0;
   FichEsclavo = ""; FichMaster = ""; Marca = 0;
   nSwitch = 0; nSwitch1 = 0; nSw = 0;
   aSerie = ""; nFactura = 0;

   &EURO = 1; &EURODB = 0; &EURODV = 0;

   aCabecera = "";
   aSerieF   = "";
   nNumFra   = 0;

   nSwPalmHoteles = 0;
   nIdPalm        = 0;

   nDiario = 0; nDocum = 0; nApunt = 0;
   nDiario1 = 0; fFecha1 = @; fFecha2 = @; nDocum1 = 0; nApunt1 = 0;
{-1}Menu  = "";
    Menu1 = "2400";
    Menu2 = "1";
    Menu3 = "";
    Menu4 = "REC";
    Menu5 = " Revisar ";
    Menu6 = " Enlazar ";
    Menu7 = " Cancelar ";

    nNumFicheros = 6;

{-1}TiposEnlaces  = "";
    TiposEnlaces1 = "FV";
    TiposEnlaces2 = "FC";
    TiposEnlaces3 = "FD";
    TiposEnlaces4 = "TI";
    TiposEnlaces5 = "CC";
    TiposEnlaces6 = "CR";

{-1}FichCab = "";
    FichCab1 = "agifa134";    || Cabecera Facturas Venta
    FichCab2 = "agifa079";    || Cabecera Facturas Compra
    FichCab3 = "agifa084";    || Cabecera Facturas Directas
    FichCab4 = "agifa501";    || Cabecera Tickets
    FichCab5 = "agifa509";    || Resumenes de cierres de caja
    FichCab6 = "agifa571";    ||

{-1}Cabec = "";
    Cabec1 = "agifa010";
    Cabec2 = "agifa077";
    Cabec3 = "agifa084";
    Cabec4 = "agifa501";
    Cabec5 = "";
    Cabec6 = "";

{-1}Ficheros  = "";
    Ficheros1 = "agifa071";   || Albaranes de venta
    Ficheros2 = "agifa080";   || Albaranes de compra
    Ficheros3 = "agifa069";   || Facturas directas
    Ficheros4 = "agifa502";   || Tickets
    Ficheros5 = "agifa509";   || Resumenes de cierres de caja
    Ficheros6 = "agifa572";   ||

{-1}nAsiento  = 0;
    nAsiento1 = 54;
    nAsiento2 = 39;
    nAsiento3 = 36;
    nAsiento4 = 35;
    nAsiento5 = 85;
    nAsiento6 = 0;

{-1}Campo1Clave  = 0;
    Campo1Clave1 = 30;
    Campo1Clave2 = 28;
    Campo1Clave3 = 20;
    Campo1Clave4 = 20;
    Campo1Clave5 = 63;
    Campo1Clave6 = 0;

{-1}Campo2Clave  = 0;
    Campo2Clave1 = 26;
    Campo2Clave2 = 25;
    Campo2Clave3 = 0;
    Campo2Clave4 = 0;
    Campo2Clave5 = 0;
    Campo2Clave6 = 1;

{-1}Campo3Clave  = 0;
    Campo3Clave1 = 1;
    Campo3Clave2 = 1;
    Campo3Clave3 = 1;
    Campo3Clave4 = 1;
    Campo3Clave5 = 1;
    Campo3Clave6 = 1;

{-1}CmpEmpresa  = 0;
    CmpEmpresa1 = 58;
    CmpEmpresa2 = 43;
    CmpEmpresa3 = 40;
    CmpEmpresa4 = 39;
    CmpEmpresa5 = 89;
    CmpEmpresa6 = 0;

{-1}CmpPeriodo  = 0;
    CmpPeriodo1 = 59;
    CmpPeriodo2 = 44;
    CmpPeriodo3 = 41;
    CmpPeriodo4 = 40;
    CmpPeriodo5 = 90;
    CmpPeriodo6 = 0;

{-1}CmpEnlace  = 0;
    CmpEnlace1 = 60;
    CmpEnlace2 = 45;
    CmpEnlace3 = 42;
    CmpEnlace4 = 41;
    CmpEnlace5 = 91;
    CmpEnlace6 = 0;

{-1}Fechas  = 0;
    Fechas1 = 1;
    Fechas2 = 1;
    Fechas3 = 1;
    Fechas4 = 14;
    Fechas5 = 1;
    Fechas6 = 5;

{-1}Ser  = 0;
    Ser1 = 29;
    Ser2 = 27;
    Ser3 = 20;
    Ser4 = 20;
    Ser5 = 0;
    Ser6 = 2;

{-1}TipoIva = 0;
    TipoIva1 = 11;
    TipoIva2 = 11;
    TipoIva3 = 11;
    TipoIva4 = 13;
    TipoIva5 = 0;
    TipoIva6 = 0;

{-1}Contabil = 0;
    Contabil1 = 48;
    Contabil2 = 48;
    Contabil3 = 39;
    Contabil4 = 6;
    Contabil5 = 62;
    Contabil6 = 0;

{-1}Clave1Cab = 0;
    Clave1Cab1 = 49;
    Clave1Cab2 = 66;
    Clave1Cab3 = 48;
    Clave1Cab4 = 36;
    Clave1Cab5 = 63;
    Clave1Cab6 = 0;

{-1}Clave2Cab = 0;
    Clave2Cab1 = 0;
    Clave2Cab2 = 0;
    Clave2Cab3 = 0;
    Clave2Cab4 = 0;
    Clave2Cab5 = 0;
    Clave2Cab6 = 0;
    nSwRegNif = 0;
    &eaFicRegNif = "";
|FIN;

|PROCESO ImpCuadre;
     |SI #agifa712#15 ! "N";
          |SI #agifa712#8 = "D";
               nImpCuadre = nImpCuadre + (#agifa712#9 ! 2);
          |SINO;
               nImpCuadre = nImpCuadre - (#agifa712#9 ! 2);
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE ImpCuadre;
     #agifa712#1;
     ;
     00, "01.01.0000", 000000, 0000, 00000, 0;
     99, "31.12.9999", 999999, 9999, 99999, 9;
     ;
     NULL, ImpCuadre;
|FIN;

|PROCESO GraTmpCuadre;
     aAlfa = #caenlac@#18; |QBF aAlfa;
     |SI aAlfa = "S"; |ACABA; |FINSI;

     |DDEFECTO #agifa712;
     #agifa712#0  = #caenlac@#0;
     #agifa712#1  = #caenlac@#1;
     #agifa712#2  = #caenlac@#2;
     #agifa712#3  = #caenlac@#3;
     #agifa712#12 = #caenlac@#37;
     #agifa712#13 = #caenlac@#38;
     |LEE 101#agifa712.=;
     |SI FSalida ! 0; |GRABA 020#agifa712.b; |FINSI;
     #agifa712#4  = #caenlac@#4;
     #agifa712#5  = #caenlac@#5;
     #agifa712#6  = #caenlac@#6;
     #agifa712#7  = #caenlac@#7;
     #agifa712#8  = #caenlac@#8;
     #agifa712#9  = #caenlac@#9;
     #agifa712#10 = #caenlac@#16;
     #agifa712#11 = #caenlac@#16;
     #agifa712#14 = #caenlac@#15;
     #agifa712#15 = #caenlac@#18; ||Anulado
     |GRABA 020#agifa712.a;
     |LIBERA #agifa712;
|FPRC;

|| Tiquet: 3068/647
|| Bloqueo Facturas Liquidadas (segun parametros)
|PROCESO CheqCamaniva;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |SI #agifa704#2 = "FV"; |Y eaBloqLiquiVta = "N"; |ACABA; |FINSI;
     |SI #agifa704#2 = "FC"; |Y eaBloqLiquiCom = "N"; |ACABA; |FINSI;

     aAlfa = #agifa704#6; |QBF aAlfa;
     aAlfa = aAlfa - "contagen";
     |SI FSalida ! 0;
         aAlfa = #agifa704#6; |QBF aAlfa;
         aAlfa = aAlfa + "def/camaniva.mas";
         |CARGA_DEF aAlfa, calibro@;
         |SI FSalida = 0;
            aAlfa = #agifa704#6; |QBF aAlfa;
            aAlfa = aAlfa + "fich/" + (("00000" + #agifa722#8) % -105) + #agifa722#9 + "/";
            |PATH_DAT #calibro@#aAlfa#;
            |ABRE #calibro@;
            |SELECT #2#calibro@;
            #calibro@#7 = #agifa722#4; nDiario = #calibro@#7;
            #calibro@#8 = #agifa722#5; fFecha  = #calibro@#8;
            #calibro@#9 = #agifa722#6; nDocum  = #calibro@#9;
            |LEE 000#calibro@.];
            |PARA; |SI FSalida = 0; |Y #calibro@#7 = nDiario; |Y #calibro@#8 = fFecha;
                    |Y #calibro@#9 = nDocum; |HACIENDO;
               |SI #agifa704#2 = "FV";
                    |SI #Princip@#49 = #calibro@#2; |Y #Princip@#0 = #calibro@#3;
                         |SAL;
                    |FINSI;
               |FINSI;
               |SI #agifa704#2 = "FC";
                    |SI #Princip@#66 = #calibro@#2; |Y #Princip@#0 = #calibro@#3;
                         |SAL;
                    |FINSI;
               |FINSI;
               |LEE 000#calibro@.s;
            |SIGUE;
            |SI #agifa704#2 = "FV";
                 |SI FSalida = 0; |Y #calibro@#7 = nDiario; |Y #calibro@#8 = fFecha;
                    |Y #calibro@#9 = nDocum; |Y #Princip@#49 = #calibro@#2;
                    |Y #Princip@#0 = #calibro@#3;
                    |SI #calibro@#40 ! 0; aSwBloqueoLiqui = "S"; |FINSI;
                 |FINSI;
            |FINSI;
            |SI #agifa704#2 = "FC";
                 |SI FSalida = 0; |Y #calibro@#7 = nDiario; |Y #calibro@#8 = fFecha;
                    |Y #calibro@#9 = nDocum; |Y #Princip@#66 = #calibro@#2;
                    |Y #Princip@#0 = #calibro@#3;
                    |SI #calibro@#40 ! 0; aSwBloqueoLiqui = "S"; |FINSI;
                 |FINSI;
            |FINSI;
            |CIERRA #calibro@;
            |DESCARGA_DEF #calibro@;
         |FINSI;
     |FINSI;

     |SI aSwBloqueoLiqui = "S";
          FSalida = "1";
     |SINO;
          FSalida = 0;
     |FINSI;
|FPRC;

|PROCESO RegNif;
     |SI nSwRegNif = 0; |ACABA; |FINSI;

     |SI nSwRegNif = 1;
          aAlfaN = #agifa704#6; |QBF aAlfaN;
          aAlfaN = aAlfaN + "fich/" + (("00000" + #caenlac@#37) % -105) + #caenlac@#38 + "/";
          eaFicRegNif = aAlfaN;
          |PATH_DAT #RegNifs@#aAlfaN#;
          aAlfaN = "p1" + Usuario; |NOME_DAT #RegNifs@#aAlfaN#;
          |ABRE #RegNifs@;
          nSwRegNif = 2;
     |FINSI;

     |SI aTipoCif = "C";
          #RegNifs@#0 = #agifa024#15;
          #RegNifs@#1 = #agifa024#2;
          #RegNifs@#2 = #agifa024#8;
          #RegNifs@#3 = #agifa024#181;
          #RegNifs@#4 = #agifa024#182;
          #RegNifs@#5 = #agifa024#9;
          #RegNifs@#6 = #agifa024#10;
          #RegNifs@#7 = #agifa024#17;
          #RegNifs@#8 = #agifa024#18;
          #RegNifs@#9 = #agifa024#16;

          #RegNifs@#10 = #agifa024#32;
          #RegNifs@#11 = #agifa024#33;
          #RegNifs@#12 = #agifa024#31;
          #RegNifs@#13 = #agifa024#30;
          #RegNifs@#16 = #agifa024#215;
          #RegNifs@#17 = #agifa024#216;
     |SINO;
          #RegNifs@#0 = #agifa112#9;
          #RegNifs@#1 = #agifa112#2;
          #RegNifs@#2 = #agifa112#3;
          #RegNifs@#3 = #agifa112#74;
          #RegNifs@#4 = #agifa112#75;
          #RegNifs@#5 = #agifa112#4;
          #RegNifs@#6 = #agifa112#5;
          #RegNifs@#7 = #agifa112#6;
          #RegNifs@#8 = #agifa112#7;
          #RegNifs@#9 = #agifa112#10;

          #RegNifs@#10 = #agifa112#14;
          #RegNifs@#11 = #agifa112#15;
          #RegNifs@#12 = #agifa112#13;
          #RegNifs@#13 = #agifa112#12;
          #RegNifs@#14 = #agifa112#94;
          #RegNifs@#15 = #agifa112#95;
          #RegNifs@#16 = #agifa112#96;
          #RegNifs@#17 = #agifa112#97;
     |FINSI;
     |GRABA 000#RegNifs@.n;
|FPRC;

|| **************************************************************************
|| **************************************************************************
|| ****              RESOLUCION DE EXPRESIONES Y FORMULAS                ****
|| **************************************************************************
|| **************************************************************************

/*
   Recoge de la variable 'cadena' la expresion a resolver y devuelve el
   valor de la expresion en la variable 'Resultado'
*/

|PROCESO ResuelveExpr;
   |HAZ ResolCampos;
   |QBT Cadena;

|ET Comienzo;
   PosicAPar = 0;  PosicCPar = 0;
   Cad1 = "";

   Comodin = Cadena;
   Comodin1 = Comodin - "(";
   |SI FSalida ! 0;
      aLong = Comodin % 0; nLong = aLong;
      |PARA Cont = 1; |SI Cont [ nLong; |HACIENDO Cont = Cont + 1;
         Calc = (Cont * 100) + 1;
         Comodin1 = Comodin % Calc;
         |SI Comodin1 = "(";
            PosicAPar = Cont;
            Cad1 = "";
         |SINO;
            |SI Comodin1 = ")";
               PosicCPar = Cont;
               |SI PosicAPar ! 0;
                  |HAZ ResolSimple;
                  Calc1 = 100 + (PosicAPar - 1);
                  Calc2 = ((PosicCPar + 1) * 100) + 99;
                  Comodin1 = Comodin % Calc1;
                  Comodin1 = Comodin1 + Cad1;
                  Comodin1 = Comodin1 + (Comodin % Calc2);
                  Cadena   = Comodin1;
                  |VETE Comienzo;
               |SINO;
                  |MENAV "    Error de sintaxis en la expresion";
                  |ERROR;
                  |ACABA;
               |FINSI;
            |SINO;
               Cad1 = Cad1 + Comodin1;
            |FINSI;
         |FINSI;
      |SIGUE;
   |FINSI;

   Cad1 = Cadena;
   |HAZ ResolSimple;
   Resultado = Cad1;
|FPRC;

|PROCESO ResolSimple;

   Oper1 = 0; Oper2 = 0; Operacion = ""; Cad2 = ""; Neg = 0;

   aLong = Cad1 % 0; nLong = aLong;

   |PARA Cont1 = 1; |SI Cont1 [ nLong; |HACIENDO Cont1 = Cont1 + 1;
      Calc1 = (Cont1 * 100) + 1;
      Comodin1 = Cad1 % Calc1;
      |SI Comodin1 = "+"; |O Comodin1 = "-";
       |O Comodin1 = "/"; |O Comodin1 = "*";
       |O Comodin1 = "%"; |O Comodin1 = "[";
       |O Comodin1 = "!"; |O Comodin1 = "?";
         |SI Oper1 = 0;
            Oper1 = Cad2;
            |SI Neg = 1; Oper1 = 0 - Oper1; Neg = 0; |FINSI;
            |SI Cad2 = "";
               Neg = 1;
            |SINO;
               Operacion = Comodin1;
               Cad2 = "";
               Neg = 0;
            |FINSI;
         |SINO;
            |SI Cad2 = "";
               |SI Comodin1 = "-"; Neg = 1; |FINSI;
            |SINO;
               Oper2 = Cad2;
               |SI Neg = 1; Oper2 = 0 - Oper2; |FINSI;
               |SI Operacion = "+"; Oper1 = Oper1 + Oper2; |FINSI;
               |SI Operacion = "-"; Oper1 = Oper1 - Oper2; |FINSI;
               |SI Operacion = "/"; Oper1 = Oper1 / Oper2; |FINSI;
               |SI Operacion = "*"; Oper1 = Oper1 * Oper2; |FINSI;
               |SI Operacion = "%"; Oper1 = Oper1 % Oper2; |FINSI;
               |SI Operacion = "!"; Oper1 = Oper1 ! Oper2; |FINSI;
               |SI Operacion = "?"; |SI Oper1 < 0; Oper1 = 0 - Oper1; |FINSI; |FINSI;
               Operacion = Comodin1; Cad2 = "";
            |FINSI;
         |FINSI;
      |SINO;
         Cad2 = Cad2 + Comodin1;
      |FINSI;
   |SIGUE;

   |QBF Operacion;
   |SI Operacion ! "";
      |SI Cad2 = "";
         |SI Comodin1 = "-"; Neg = 1; |FINSI;
      |SINO;
         Oper2 = Cad2;
         |SI Neg = 1; Oper2 = 0 - Oper2; Neg = 0; |FINSI;
         |SI Operacion = "+"; Oper1 = Oper1 + Oper2; |FINSI;
         |SI Operacion = "-"; Oper1 = Oper1 - Oper2; |FINSI;
         |SI Operacion = "/"; Oper1 = Oper1 / Oper2; |FINSI;
         |SI Operacion = "*"; Oper1 = Oper1 * Oper2; |FINSI;
         |SI Operacion = "%"; Oper1 = Oper1 % Oper2; |FINSI;
         |SI Operacion = "!"; Oper1 = Oper1 ! Oper2; |FINSI;
         |SI Operacion = "?"; |SI Oper1 < 0; Oper1 = 0 - Oper1; |FINSI; |FINSI;
      |FINSI;
   |SINO;
      Oper1 = Cad1;
   |FINSI;
   Cad1 = Oper1;
|FPRC;

|PROCESO ResolCampos;
|| Esta rutina obtiene el valor del campo dado por la expresion
||   [fichero][n§ campo] del temporal de datos relacionados
|| Ademas se incluyen las expresiones [Memoria]
   Cad1 = ""; DigFormat = 0;
   Cad2 = "";
   ||Cadena = #agifa706#8;
   Cadena = Cadena - "][";
   |SI FSalida ! 0;
      |PARA; |SI FSalida ! 0; |HACIENDO;
         ComodNum = ((FSalida / 100) ! 0);
         Calc = ((ComodNum+3) * 100) + 1;
         Cad1 = Cadena % Calc;
         |SI Cad1 = "]";
            Calc = 102 + ComodNum;              Cad1 = Cadena % Calc;
            Calc = ((ComodNum + 4) * 100) + 99; Cad2 = Cadena % Calc;
            Cadena = Cad1 + Cad2;
         |FINSI;
         |PARA ComodNum; |SI ComodNum > 0; |HACIENDO ComodNum = ComodNum - 1;
            Calc = (ComodNum * 100) + 1;
            Cad1 = Cadena % Calc;
            |SI Cad1 = "[";
               Calc = 100 + (ComodNum - 1);        Cad1 = Cadena % Calc;
               Calc = ((ComodNum + 1) * 100) + 99; Cad2 = Cadena % Calc;
               Cadena = Cad1 + Cad2;
               |SAL;
            |FINSI;
         |SIGUE;

         ComodNum = 100 + (ComodNum - 1);
         Cad1 = Cadena % ComodNum; Cadena = Cadena - Cad1;
         Fich = Cadena % 0108; |QBF Fich; Cadena = Cadena - Fich;
         Cmp  = Cadena % 0103; Cadena = Cadena - Cmp;
         Cad2 = Cadena;
         || ABRE #agifa715;
         |HAZ TomaDatos;
         || CIERRA #agifa715;
         |SI Comodin = "S"; Comodin = "1"; |FINSI;
         |SI Comodin = "N"; Comodin = "0"; |FINSI;
         Cadena = Cad1 + Comodin + Cad2;
         Cadena = Cadena - "][";
      |SIGUE;
   |FINSI;

   Cadena = Cadena - "[";
   |SI FSalida ! 0;
      |PARA; |SI FSalida ! 0; |HACIENDO;
         ComodNum = FSalida;
         ComodNum = ((ComodNum / 100) ! 0);
         Cadena = Cadena - "]";
         Calc = ((FSalida / 100) ! 0) - 1;
         Calc = (ComodNum * 100) + (Calc - ComodNum + 1);
         Cad1 = Cadena % Calc; Cadena = Cadena - Cad1;
         #agifa721#0 = Cad1;
         |LEE 000#agifa721.=;
         |SI FSalida = 0;
            Cad2 = #agifa721#2; |QBF Cad2;
            Calc = 100 + (ComodNum - 1); Cad1 = Cadena % Calc;
            Cad2 = Cad1 + Cad2;
            Calc = (ComodNum * 100) + 98; Cad1 = Cadena % Calc;
            Cad2 = Cad2 + Cad1;
            Cadena = Cad2;
         |FINSI;
         ||CIERRA #agifa721;
         Cadena = Cadena - "[";
      |SIGUE;
   |FINSI;
|FPRC;


|| **************************************************************************
|| **************************************************************************
|| ****                     RESOLUCION DE RELACIONES                     ****
|| **************************************************************************
|| **************************************************************************

/*

  La llamada al proceso principal 'ResuelveRels' toma el valor de la variable
  'FichRelac' que contiene el nombre del fichero del cual se resolveran las
  relaciones. En base al registro corriente del fichero 'FichRelac', se
  rellena el fichero 'agifa715' con los registros correspondientes de los
  ficheros relacionados con el indicado.

*/

|PROCESO CargaRegAct;
   Mensaje = "Cargando registro : " + nCont + "  ";
   nCalc = (nLinPinta * 100) + 7;
   |ATRI I; |PINTA nCalc, Mensaje; |ATRI N; nCont = nCont + 1;
   ComodNum = #agifa715#1;
   |SI #agifa715#2 = "A"; #FMaster@#ComodNum# = #agifa715#3; |FINSI;
   |SI #agifa715#2 = "N"; #FMaster@#ComodNum# = #agifa715#4; |FINSI;
   |SI #agifa715#2 = "F"; #FMaster@#ComodNum# = #agifa715#5; |FINSI;
|FPRC;

|DEFBUCLE CargaRegAct;
#agifa715#1;
;
#agifa714#1,000;
#agifa714#1,256;
;
NULL,CargaRegAct;
|FIN;

|PROCESO SacaRels;
   |ABRE #agifa702; |SELECT #2#agifa702;
   |DBASE Direc;
   Comodin = #agifa714#1; |QBF Comodin; FichMaster = Comodin;

   Comodin = Direc + "def/" + Comodin + ".mas";
   |CARGA_DEF Comodin, FMaster@; Mast = Comodin;
   |SI FSalida = 0;
      |PATH_DAT #9 PathAplic;
      |ABRE #FMaster@;

      nCont = 0; |BUCLE CargaRegAct;

      Comodin = "|NR";
      Calc1 = #FMaster@#Comodin#;

      nCalc = (nLinPinta * 100) + 7;
      |ATRI I; |PINTA nCalc, "Resolviendo relaciones           "; |ATRI N;
      |PARA Cont = 0; |SI Cont < Calc1; |HACIENDO Cont = Cont + 1;
         Comodin = ("000" + Cont) % -103;
         Comodin = "|R" + Comodin;
         Comodin = #FMaster@#Comodin#;
         Comodin1 = Comodin % 108;
         NombreRel = Comodin1;

         aCiagan = NombreRel;
         #agifa702#1 = NombreRel;
         #agifa702#0 = 1;
         |LEE 000#agifa702.]
         |SI FSalida = 0; |Y #agifa702#1 = NombreRel;
            Comodin = Comodin - Comodin1;
            Comodin = Comodin - "|";
            Comodin = Comodin - "-";
            |SI FSalida = 0;
               |DBASE Direc;
               FichEsclavo = Comodin1;
               Comodin1 = Direc + "def/" + Comodin1 + ".mas";
               |CARGA_DEF Comodin1, FEsclav@;
               |SI FSalida = 0;
/*
                  |ATRI I; Mensaje = "Enlazando, espere por favor ..... " + MarcaPant; |HAZ ActMarca;
                  nCalc = (nLinPinta * 100) + 7;
                  |PINTA nCalc, Mensaje; |ATRI R;
*/
                  |PATH_DAT #10 PathAplic;
                  |ABRE #FEsclav@;

                  || Cargo la clave del fichero nuevo y lo busco

                  Comodin1 = Comodin % 103;
                  Comodin = Comodin - Comodin1;
                  Calc2 = Comodin1;

                  Clave1 = Comodin; Clave11 = Comodin;
                  Comodin = "|K000";
                  Comodin = #FEsclav@#Comodin#;
                  Clave2 = Comodin % 0499;

                  |PARA Cont1 = 0; |SI Cont1 < Calc2; |HACIENDO Cont1 = Cont1 + 1;
                     Comodin = Clave1 % 0103;
                     Clave1 = Clave1 - Comodin;
                     CmpClave1 = Comodin;
                     CmpClave1 = CmpClave1 - 1;

                     Comodin = Clave2 % 0103;
                     Clave2 = Clave2 - Comodin;
                     CmpClave2 = Comodin;
                     #FEsclav@#CmpClave2# = #FMaster@#CmpClave1#;
                  |SIGUE;

                  |SI aCiagan = "agifa133";
                     |LEE 010#FEsclav@.];
                     |SI FSalida = 0;
                        Clave1 = Clave11;
                        Comodin = "|K000";
                        Comodin = #FEsclav@#Comodin#;
                        Clave2 = Comodin % 0499;

                        |PARA Cont1 = 0; |SI Cont1 < Calc2; |HACIENDO Cont1 = Cont1 + 1;
                           Comodin = Clave1 % 0103; Clave1 = Clave1 - Comodin; CmpClave1 = Comodin;
                           CmpClave1 = CmpClave1 - 1;
                           Comodin = Clave2 % 0103; Clave2 = Clave2 - Comodin; CmpClave2 = Comodin;
                           |SI #FEsclav@#CmpClave2# ! #FMaster@#CmpClave1#;
                              FSalida = 111;
                              |SAL;
                           |SINO;
                              FSalida = 0;
                           |FINSI;
                        |SIGUE;
                     |FINSI;
                  |SINO;
                     |LEE 010#FEsclav@.=;
                  |FINSI;

                  || Si se encuentra , grabo los datos en el temporal de datos relaccionados

                  |SI FSalida = 0;
                     Comodin1 = "|NC";
                     NumCmps = #FEsclav@#Comodin1# - 1;
                     |SELECT #3#agifa702;
                     |PARA Cont2 = 0; |SI Cont2 [ NumCmps; |HACIENDO Cont2 = Cont2 + 1;
                        #agifa702#1 = NombreRel;
                        #agifa702#2 = Cont2;
                        #agifa702#4 = #agifa704#2;
                        |LEE 000#agifa702.=;
                        |SI FSalida = 0;
                           #agifa715#0 = NombreRel;
                           #agifa715#1 = Cont2;
                           |LEE 000#agifa715.=;
                           FEstado = FSalida;

                           |SI nSwSematel = 1;
                              |SI NombreRel = "agifa007"; |Y Cont2 = 43;
                                 || Si no se hace esto, en un enlace por familias
                                 ||    se cogera la cuenta analitica de la serie
                                 ||    del albaran
                                 |SI #agifa704#2 = "FV"; |Y #agifa704#8 = "S"; |Y FichMaster = "agifa010";
                                    FEstado = 0;
                                 |FINSI;
                              |FINSI;
                           |FINSI;

                           |SI FEstado ! 0;
                              |DDEFECTO #agifa715;
                              #agifa715#0 = NombreRel;
                              #agifa715#1 = Cont2;
                              Comodin1 = ("000" + Cont2) % -103;
                              Comodin1 = "|C" + Comodin1 + "TIPO";
                              Comodin1 = #FEsclav@#Comodin1#;
                              #agifa715#2 = Comodin1;
                              |SI Comodin1 = "A"; #agifa715#3 = #FEsclav@#Cont2#; |FINSI;
                              |SI Comodin1 = "N"; #agifa715#4 = #FEsclav@#Cont2#; |FINSI;
                              |SI Comodin1 = "F"; #agifa715#5 = #FEsclav@#Cont2#; |FINSI;
                              Comodin1 = ("000" + Cont2) % -103;
                              Comodin1 = "|C" + Comodin1 + "LONGITUD";
                              #agifa715#6 = #FEsclav@#Comodin1#;

                              |SI nSwPalmHoteles = 1;
                                 |SI #agifa715#0 = "agifa077";
                                    |SI #agifa715#1 = 39; |O #agifa715#1 = 51;
                                       |SI #agifa715#1 = 51; aAlfa = "Z" + #FEsclav@#50; #agifa715#3 = aAlfa; |FINSI;
                                       |SI #agifa715#1 = 39; #agifa715#4 = #FEsclav@#0;  |FINSI;
                                    |FINSI;
                                 |FINSI;
                                 |SI #agifa715#0 = "agifa080";
                                    |SI #agifa715#1 = 28; |O #agifa715#1 = 25;
                                       |SI #agifa715#1 = 28; aAlfa = "Z" + #FEsclav@#27; #agifa715#3 = aAlfa; |FINSI;
                                       |SI #agifa715#1 = 25; #agifa715#4 = #FEsclav@#0;  |FINSI;
                                    |FINSI;
                                 |FINSI;
                              |FINSI;
                              |GRABA 020#agifa715.n;
                           |FINSI;
                        |FINSI;
                     |SIGUE;
                     |SELECT #2#agifa702;

                     |SALVA_FICHA #agifa714;
                     |SELECT #2#agifa714;
                     #agifa714#1 = NombreRel;
                     |LEE 000#agifa714.=;
                     |SI FSalida ! 0;
                        |DDEFECTO #agifa714;
                        #agifa714#0 = LinRel; LinRel = LinRel + 1;
                        #agifa714#1 = NombreRel;
                        |GRABA 000#agifa714.n;
                     |FINSI;
                     |SELECT #1#agifa714;
                     |LEE 000#agifa714.p; |REPON_FICHA #agifa714;
                  |FINSI;

                  |CIERRA #FEsclav@;
                  |DESCARGA_DEF #FEsclav@;
               |FINSI;
            |FINSI;
         |FINSI;
      |SIGUE;
      |CIERRA #FMaster@;
      |DESCARGA_DEF #FMaster@;
   |FINSI;
   |BORRA 020#agifa714.a;

   |CIERRA #agifa702;
|FPRC;

|PROCESO ResuelveRels;
|| Esta rutina rellena un temporal con el registro del fichero principal que
||   se esta tratando, ademas de rellenarlo con los registros de todos los
||   ficheros que estan relacionados con el. Para esto se apoya sobre un
||   temporal que indica los ficheros relacionados con el fichero principal
||   y los relacionados entre si, comenzando luego escribiendo el registro
||   actual del fichero principal y buscando los registros relacionados a
||   partir de ahi

||  Primero, rellenamos el temporal para saber todos los ficheros que
||    tendremos que leer .... (excluimos los que no hemos indicado en
||    el control

   |ABRE #agifa702; |SELECT #2#agifa702;

   |PATH_DAT #715 PathAplic;
   Comodin2 = Usuario; |QBF Comodin2; Comodin2 = "07" + Comodin2;
   |NOME_DAT #714 Comodin2;
   Comodin2 = Usuario; |QBF Comodin2; Comodin2 = "08" + Comodin2;
   |NOME_DAT #715 Comodin2;
   |DELINDEX #agifa714; |DELINDEX #agifa715;
   |ABRE #agifa714;
   LinRel = 1;

   |DDEFECTO #agifa714;
   #agifa714#0 = LinRel; LinRel = LinRel + 1;
   #agifa714#1 = FichRelac;
   |GRABA 020#agifa714.n;

   |ABRE #agifa715;
   |DBASE Direc;
   FichMaster = FichRelac;

   Comodin = Direc + "def/" + FichRelac + ".mas";
   |CARGA_DEF Comodin, FMaster@;
   |SI FSalida = 0;
      |PATH_DAT #9 PathAplic;
      |ABRE #FMaster@;

      Comodin1 = "|NC";
      NumCmps = #FMaster@#Comodin1# - 1;
      |PARA Cont = 0; |SI Cont [ NumCmps; |HACIENDO Cont = Cont + 1;
         #FMaster@#Cont# = #Referen@#Cont#;
      |SIGUE;
      |LEE 000#FMaster@.=;
      |PARA Cont = 0; |SI Cont [ NumCmps; |HACIENDO Cont = Cont + 1;
         |DDEFECTO #agifa715;
         #agifa715#0 = FichRelac;
         #agifa715#1 = Cont;
         Comodin1 = ("000" + Cont) % -103;
         Comodin1 = "|C" + Comodin1 + "TIPO";
         Comodin1 = #FMaster@#Comodin1#;
         #agifa715#2 = Comodin1;

         aAlfa = #FMaster@#Cont#;

         |SI Comodin1 = "A";  #agifa715#3 = #FMaster@#Cont#; |FINSI;
         |SI Comodin1 = "N";  #agifa715#4 = #FMaster@#Cont#; |FINSI;
         |SI Comodin1 = "F";  #agifa715#5 = #FMaster@#Cont#; |FINSI;
         Comodin1 = ("000" + Cont) % -103;
         Comodin1 = "|C" + Comodin1 + "LONGITUD";
         #agifa715#6 = #FMaster@#Comodin1#;

         |SI nSwPalmHoteles = 1;
            |SI #agifa715#0 = "agifa077";
               |SI #agifa715#1 = 39; |O #agifa715#1 = 51;
                  |SI #agifa715#1 = 51; aAlfa = "Z" + #FMaster@#50; #agifa715#3 = aAlfa; |FINSI;
                  |SI #agifa715#1 = 39; #agifa715#4 = #FMaster@#0;  |FINSI;
               |FINSI;
            |FINSI;
            |SI #agifa715#0 = "agifa080";
               |SI #agifa715#1 = 28; |O #agifa715#1 = 25;
                  |SI #agifa715#1 = 28; aAlfa = "Z" + #FMaster@#27; #agifa715#3 = aAlfa; |FINSI;
                  |SI #agifa715#1 = 25; #agifa715#4 = #FMaster@#0;  |FINSI;
               |FINSI;
            |FINSI;
         |FINSI;
         |GRABA 020#agifa715.n;
      |SIGUE;

      |SI enSwTaller = 0; |Y FichRelac = "agifa080";
          || Mete la cta de la seccion en el campo partida
          |HAZ TallerCuentaSeccion;
      |FINSI;

      Comodin = "|NR";
      Calc1 = #FMaster@#Comodin#;

      |PARA Cont = 0; |SI Cont < Calc1; |HACIENDO Cont = Cont + 1;
         Comodin = ("000" + Cont) % -103;
         Comodin = "|R" + Comodin;
         Comodin = #FMaster@#Comodin#;
         Comodin = Comodin % 108;

         #agifa702#1 = Comodin;
         #agifa702#0 = 1;
         |LEE 000#agifa702.]
         |SI FSalida = 0; |Y #agifa702#1 = Comodin;
            |DDEFECTO #agifa714;
            #agifa714#0 = LinRel; LinRel = LinRel + 1;
            #agifa714#1 = Comodin;
            |GRABA 020#agifa714.n;
         |FINSI;
      |SIGUE;

      |CIERRA #FMaster@;
      |DESCARGA_DEF #FMaster@;
   |FINSI;

||  ... y una vez lo tenemos , vamos obteniendo los registros relacionados
||   con el registro actual del fichero principal o con cualquiera
||   relacionado con este

   |LEE 010#agifa714.p;
   |PARA; |SI FSalida = 0; |HACIENDO;
      |HAZ SacaRels;
      |LEE 010#agifa714.p;
   |SIGUE;

   |CIERRA #agifa715;   |CIERRA #agifa714;
   |CIERRA #agifa702;

   |HAZ AnadeMas; || Incluye datos especiales de ficheros no relacionados
|FPRC;

|PROCESO EscogeFic;

|| Parametriza la linea del fichero de acotacion en base a la naturaleza del campo
||   que se esta tratando

         TipoDato = #agifa716#11; LongDato = #agifa716#12;
         |SI TipoDato = "A";
            |CAMPO_ANCHO #agifa716#3,1,LongDato;
            |CAMPO_MAXIMO #agifa716#3,1,"#";
            |CAMPO_ANCHO #agifa716#4,1,LongDato;
            |CAMPO_MAXIMO #agifa716#4,1,"#";
            |C_M #agifa716#3,1,"S"; |C_V #agifa716#3,1,"S"; |PINTA #agifa716#3;
            |C_M #agifa716#4,1,"S"; |C_V #agifa716#4,1,"S"; |PINTA #agifa716#4;
            |C_M #agifa716#5,1,"N"; |C_V #agifa716#5,1,"N";
            |C_M #agifa716#6,1,"N"; |C_V #agifa716#6,1,"N";
            |C_M #agifa716#7,1,"N"; |C_V #agifa716#7,1,"N";
            |C_M #agifa716#8,1,"N"; |C_V #agifa716#8,1,"N";
         |FINSI;
         |SI TipoDato = "N";
            |C_M #agifa716#3,1,"N"; |C_V #agifa716#3,1,"N";
            |C_M #agifa716#4,1,"N"; |C_V #agifa716#4,1,"N";
            |C_M #agifa716#5,1,"S"; |C_V #agifa716#5,1,"S"; |PINTA #agifa716#5;
            |C_M #agifa716#6,1,"S"; |C_V #agifa716#6,1,"S"; |PINTA #agifa716#6;
            |C_M #agifa716#7,1,"N"; |C_V #agifa716#7,1,"N";
            |C_M #agifa716#8,1,"N"; |C_V #agifa716#8,1,"N";
         |FINSI;
         |SI TipoDato = "F";
            |C_M #agifa716#3,1,"N"; |C_V #agifa716#3,1,"N";
            |C_M #agifa716#4,1,"N"; |C_V #agifa716#4,1,"N";
            |C_M #agifa716#5,1,"N"; |C_V #agifa716#5,1,"N";
            |C_M #agifa716#6,1,"N"; |C_V #agifa716#6,1,"N";
            |C_M #agifa716#7,1,"S"; |C_V #agifa716#7,1,"S"; |PINTA #agifa716#7;
            |C_M #agifa716#8,1,"S"; |C_V #agifa716#8,1,"S"; |PINTA #agifa716#8;
         |FINSI;
|FPRC;

|PROCESO TomaVal; |TIPO 2;

   nFlag = 0 +. 1;
   |SI nFlag < 0; |ACABA; |FINSI;

|| Parametriza la linea del fichero de acotacion en base a la naturaleza del campo
||   que se esta tratando

   |SI TipoDato = "A"; #agifa716#9 = #agifa716#3; #agifa716#10 = #agifa716#4; |FINSI;
   |SI TipoDato = "N"; #agifa716#9 = #agifa716#5; #agifa716#10 = #agifa716#6; |FINSI;
   |SI TipoDato = "F"; #agifa716#9 = "   " + #agifa716#7; #agifa716#10 = "   " + #agifa716#8; |FINSI;

   |C_M #agifa716#3,1,"N"; |C_V #agifa716#3,1,"N";
   |C_M #agifa716#4,1,"N"; |C_V #agifa716#4,1,"N";
   |C_M #agifa716#5,1,"N"; |C_V #agifa716#5,1,"N";
   |C_M #agifa716#6,1,"N"; |C_V #agifa716#6,1,"N";
   |C_M #agifa716#7,1,"N"; |C_V #agifa716#7,1,"N";
   |C_M #agifa716#8,1,"N"; |C_V #agifa716#8,1,"N";
                           |C_V #agifa716#9,1,"S";
                           |C_V #agifa716#10,1,"S";
|FPRC;

|PROCESO MiraEmp;
   |SI FSalida = 2; |ACABA; |FINSI;
   Tecla = FSalida;
   nSwError = 0;

   Comodin  = PathEnlace; |QBF Comodin; Comodin1 = Comodin;
   Comodin  = Comodin + "def/canempre.mas";
   Comodin1 = Comodin1 + "fich/"; |CARGA_DEF Comodin , canempr@;
   |SI FSalida = 0;
      |PATH_DAT #20 Comodin1; |ABRE #canempr@;
      |SI Tecla = 10;
         |CONSULTA_CLAVE #1#canempr@;
         |SI FSalida ] 0;
            #agifa711#4 = #canempr@#2; |PINTA #agifa711#4;
            #agifa711#5 = #canempr@#3; |PINTA #agifa711#5;
            Dig1 = #canempr@#14; Dig2 = #canempr@#15; Dig3 = #canempr@#16;
            Dig4 = #canempr@#17; Dig5 = #canempr@#18; Dig6 = #canempr@#19;
            |PINTA 0738, #canempr@#1;
            nEjerc = #canempr@#26;
            |SI nEjerc ] 80; nEjerc = nEjerc + 1900; |SINO; nEjerc = nEjerc + 2000; |FINSI;
         |SINO;
            nSwError = 0; |ERROR;
         |FINSI;
      |SINO;
         Empresa = #agifa711#4;
         #canempr@#2 = #agifa711#4;
         #canempr@#3 = #agifa711#5;
         |LEE 000#canempr@.=;
         |SI FSalida = 0;
            fFechaEje = ~;
            nPerAnt = #agifa711#5;
            nPeriodo = #agifa711#5; |HAZ BuscaPeriodo;
            nSwBusca = 1;
         |SINO;
            nPerAnt = #agifa711#5;
            nPeriodo = #agifa711#5;
            nSwBusca = 0;
         |FINSI;
|ET Otra;
         Periodo = nPeriodo;
         |SI #agifa711#5 ! nPeriodo;
            |SI eaSinCompr = 0;
               |SI PARAMETRO = "";
                  |CONFI "    SEl periodo que esta seleccionando no es del ejercicio actual. Continuar ?";
                  |SI FSalida ! 0;
                     #agifa711#5 = nPeriodo;
                  |SINO;
                     nPeriodo = #agifa711#5;
                  |FINSI;
                  |PINTA #agifa711#5;
               |SINO;
                  #agifa711#5 = nPeriodo;
               |FINSI;
            |SINO;
               nPeriodo = #agifa711#5;
            |FINSI;
         |FINSI;
         #canempr@#2 = Empresa;
         #canempr@#3 = nPeriodo;
         |LEE 000#canempr@.=;
         |SI FSalida = 0;
            Dig1 = #canempr@#14; Dig2 = #canempr@#15; Dig3 = #canempr@#16;
            Dig4 = #canempr@#17; Dig5 = #canempr@#18; Dig6 = #canempr@#19;
            |SI PARAMETRO = ""; |PINTA 0738, #canempr@#1; |FINSI;
            nEjerc = #canempr@#26;
            |SI nEjerc ] 80; nEjerc = nEjerc + 1900; |SINO; nEjerc = nEjerc + 2000; |FINSI;
         |SINO;
            |SI nSwBusca = 0;
               |SI nPeriodo = -1;
                  aAlfa = "    No existe empresa contable del ejercicio " + nAnyo;
                  |MENAV aAlfa;
                  nSwError = 1; |ERROR;
               |SINO;
                  aAlfa = "    La empresa " + (("00000" + Empresa) % -105) + " periodo " + Periodo;
                  aAlfa = aAlfa + " no existe ";
                  |MENAV aAlfa;
                  nSwError = 1; |ERROR;
               |FINSI;
            |SINO;
               nPeriodo = nPerAnt; #agifa711#5 = nPeriodo;
               |VETE Otra;
            |FINSI;
         |FINSI;
      |FINSI;

      Comodin = "|NC"; Comodin = #canempr@#Comodin#;

      |SI Comodin = 27;
         Comodin  = PathEnlace; |QBF Comodin;
         Comodin1 = Comodin;
         Comodin  = Comodin + "def/camoneda.mas";
         Comodin1 = Comodin1 + "fich/000000/";
         |CARGA_DEF Comodin , camoned@;
         |SI FSalida = 0;
            |PATH_DAT #25 Comodin1;
            |ABRE #camoned@;
            #camoned@#0 = #agifa711#4; #camoned@#1 = #agifa711#5;
            |LEE 000#camoned@.=;
            |SI FSalida = 0;
               |SI #camoned@#2 = "P";
                  EURO = 1 / 166.386; EURODB = 0; EURODV = 2;
               |SINO;
                  EURO = 166.386; EURODB = 2; EURODV = 0;
               |FINSI;
            |SINO;
               EURO = 1 / 166.386; EURODB = 0; EURODV = 2;
            |FINSI;
            |CIERRA #camoned@; |DESCARGA_DEF #camoned@;
         |FINSI;
      |SINO;
         |SI #canempr@#28 = "P";
            EURO = 1 / 166.386; EURODB = 0; EURODV = 2;
         |SINO;
            EURO = 166.386; EURODB = 2; EURODV = 0;
         |FINSI;
      |FINSI;

      |CIERRA #canempr@; |DESCARGA_DEF #canempr@;
   |FINSI;

   |SI nSwError = 0;
      Comodin  = PathEnlace; |QBF Comodin; Comodin1 = Comodin;
      Comodin  = Comodin + "def/camaasic.mas";
      Comodin1 = Comodin1 + "fich/" + (("00000" + Empresa) % -105) + nPeriodo + "/"; |CARGA_DEF Comodin , camasic@;
      |SI FSalida = 0;
         |PATH_DAT #27 Comodin1; |ABRE #camasic@;
         |DDEFECTO #camasic@;
         #camasic@#0 = 99;
         #camasic@#1 = "01.01.0000";
         #camasic@#2 = 1;
         |LEE 000#camasic@.];
         |SI FSalida = 0; |Y #camasic@#0 = 99;
            |SI enSwMensa = 0;
               |MENAV "    La empresa contable esta cerrada.Proceso cancelado.";
            |FINSI;
            nSwError = 1; |ERROR;
         |FINSI;
         |CIERRA #camasic@; |DESCARGA_DEF #camasic@;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO TomaDefectos;
   |SI PARAMETRO = "";
      eaCodEnlace = #agifa711#0;
      CodEnlace = #agifa711#0;
   |SINO;
      Comodin = PARAMETRO;
      Comodin = Comodin - ",SINPRELV";
      Comodin = Comodin - ",CAJA";
      |SI FSalida ! 0; nCaja = 1; |SINO; nCaja = 0; |FINSI;
      Comodin = Comodin - ",M";
      |SI FSalida ! 0; Modif = "S"; |SINO; Modif = "N"; |FINSI;
      Comodin = Comodin - ",E";
      |SI FSalida ! 0; Emision = "S"; |SINO; Emision = "N"; |FINSI;
      Comodin = Comodin - ",B";
      Comodin = Comodin - "*";
      |SI FSalida ! 0;
         Calc = FSalida + 3;
         Comodin1 = Comodin % Calc;
         Comodin = Comodin - Comodin1;
      |FINSI;
      CodEnlace = Comodin;
      eaCodEnlace = CodEnlace;
   |FINSI;

   |ABRE #agifa704;
   #agifa704#0 = CodEnlace;
   |LEE 000#agifa704.=;
   |SI FSalida = 0;
      |SI #agifa704#17 ! 999;
         |DDEF aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + #agifa704#16 + ".mas";
         |CARGA_DEF aAlfa, RefDato@;
         |SI FSalida = 0;
            aAlfa1 = "|TITULO"; aAlfa1 = #RefDato@#aAlfa1#;
            aAlfa = " Campo clave enlace : [" + aAlfa1; |QBF aAlfa;
            aAlfa1 = "|C" + (("000" + #agifa704#17) % -103) + "NOMBRE"; aAlfa1 = #RefDato@#aAlfa1#;
            aAlfa = aAlfa + "][" + aAlfa1; |QBF aAlfa;
            |DESCARGA_DEF #RefDato@;
            aAlfa = aAlfa + "]";
         |FINSI;
      |SINO;
         aAlfa = &196 * 60;
      |FINSI;

      |PINTA 0915, aAlfa;

      Empresa = #agifa704#4; Periodo = #agifa704#5;
      Comodin  = PathEnlace; |QBF Comodin; Comodin1 = Comodin;
      Comodin  = Comodin + "def/canempre.mas";
      Comodin1 = Comodin1 + "fich/"; |CARGA_DEF Comodin , canempr@;
      |SI FSalida = 0;
         |PATH_DAT #20 Comodin1; |ABRE #canempr@;
         fFechaEje = ~;
         nPeriodo = Periodo; |HAZ BuscaPeriodo;
         |SI nPeriodo = -1; nPeriodo = #agifa711#5; |FINSI;
         Periodo = nPeriodo; #agifa711#5 = nPeriodo;
         |CIERRA #canempr@; |DESCARGA_DEF #canempr@;
      |FINSI;
      PathEnlace = #agifa704#6;
      #agifa711#4 = Empresa; |PINTA #agifa711#4;
      #agifa711#5 = Periodo; |PINTA #agifa711#5;
      #agifa711#6 = #agifa704#14; |PINTA #agifa711#6;
      #agifa711#7 = #agifa704#15; |PINTA #agifa711#7;

      |SI #agifa704#18 ! "A"; |Y #agifa704#18 ! "B"; |Y #agifa704#18 ! "C"; |Y #agifa704#18 ! "D";
         |LEE 101#agifa704.=;
         |SI FSalida = 0;
            #agifa704#18 = "A";
            |GRABA 020#agifa704.a; |LIBERA #agifa704;
         |FINSI;
      |FINSI;
      |SI #agifa704#18 ! "A";
         |SI efFechaForm ! "01.01.0000"; |Y efFechaForm ! "00.00.0000";
            #agifa711#8 = efFechaForm;
         |SINO;
            #agifa711#8 = ~;
         |FINSI;
         |PINTA 0802, " Fecha manual : ";
         |C_M #agifa711#8, 1, "S"; |C_V #agifa711#8, 1, "S";
         |PINTA #agifa711#8;
      |SINO;
         #agifa711#8 = "01.01.0000";
         |PINTA 0803, "                          ";
         |C_M #agifa711#8, 1, "N"; |C_V #agifa711#8, 1, "N";
      |FINSI;
   |FINSI;
   |CIERRA #agifa704;
|FPRC;

|PROCESO ActMarca;
   |SI MarcaPant = "|"; MarcaPant = "/"; |ACABA; |FINSI;
   |SI MarcaPant = "/"; MarcaPant = "-"; |ACABA; |FINSI;
   |SI MarcaPant = "-"; MarcaPant = "\"; |ACABA; |FINSI;
   |SI MarcaPant = "\"; MarcaPant = "|"; |ACABA; |FINSI;
|FPRC;

|PROCESO Acotaciones;
|SI aVersion ] "9.10V";
   aCabecera = "";
   |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
      IFicheros = Ficheros1<-; IFicheros = IFicheros + Cont;
      ICabec    = Cabec1<-;    ICabec    = ICabec    + Cont;
      |SI Fich1 = Ficheros; aCabecera = Cabec; |SAL; |FINSI;
   |SIGUE;

   aAlfa4 = #agifa716#13; |QBF aAlfa4;
   |SI aAlfa4 ! Fich1; |Y aAlfa4 ! aCabecera;
      |ACABA;
   |FINSI;

   || Bloque para las facturas de compra del modulo de Palm Hoteles
   |SI nSwPalmHoteles = 1;
      |SI aAlfa7 = "agifa077";
         |SI #agifa716#14 = 51;
            aAlfa7 = #agifa716#3; |QBF aAlfa7;
            aAlfa7 = aAlfa7 % 0299; #agifa716#3 = aAlfa7;
            aAlfa7 = #agifa716#4; |QBF aAlfa7;
            aAlfa7 = aAlfa7 % 0299; #agifa716#4 = aAlfa7;
            #agifa716#14 = 50;     || Campo 'Serie Albaran'
         |FINSI;
         |SI #agifa716#14 = 39;
            #agifa716#14 = 0;      || Campo 'N§ Albaran'
         |FINSI;
      |FINSI;
      |SI aAlfa4 = "agifa080";
         |SI #agifa716#14 = 28;
            aAlfa7 = #agifa716#3; |QBF aAlfa7;
            aAlfa7 = aAlfa7 % 0299; #agifa716#3 = aAlfa7;
            aAlfa7 = #agifa716#4; |QBF aAlfa7;
            aAlfa7 = aAlfa7 % 0299; #agifa716#4 = aAlfa7;
            #agifa716#14 = 27;     || Campo 'Serie Albaran'
         |FINSI;
         |SI #agifa716#14 = 25;
            #agifa716#14 = 0;      || Campo 'N§ Albaran'
         |FINSI;
      |FINSI;
   |FINSI;

   Comodin1 = " " * #agifa716#12; Calc = -(100 + #agifa716#12);
   |SI #agifa716#11 = "A";
      Calc = 0 - Calc;
      aAlfa1 = #agifa716#3; aAlfa1 = (aAlfa1 + Comodin1) % Calc;
      aAlfa2 = #agifa716#4; aAlfa2 = (aAlfa2 + Comodin1) % Calc;
      || aAlfa1 = #agifa716#3; ||QBF aAlfa1; aAlfa1 = (aAlfa1 + Comodin1) % Calc;
      || aAlfa2 = #agifa716#4; ||QBF aAlfa2; aAlfa2 = (aAlfa2 + Comodin1) % Calc;
      |SI aAlfa1 = aAlfa2;
         Comodin = Comodin + aAlfa4 + "." + #agifa716#14 + " == '" + aAlfa1 + "' ";
      |SINO;
         Comodin = Comodin + aAlfa4 + "." + #agifa716#14 + " BETWEEN '" + aAlfa1 + "','" + aAlfa2 + "' ";
      |FINSI;
   |FINSI;
   |SI #agifa716#11 = "N";
      aAlfa1 = #agifa716#5; |QBT aAlfa1; aAlfa1 = (Comodin1 + aAlfa1) % Calc;
      aAlfa2 = #agifa716#6; |QBT aAlfa2; aAlfa2 = (Comodin1 + aAlfa2) % Calc;
      |SI aAlfa1 = aAlfa2;
         Comodin = Comodin + aAlfa4 + "." + #agifa716#14 + " == " + aAlfa1 + " ";
      |SINO;
         Comodin = Comodin + aAlfa4 + "." + #agifa716#14 + " BETWEEN " + aAlfa1 + ", " + aAlfa2 + " ";
      |FINSI;
   |FINSI;
   |SI #agifa716#11 = "F";
      aAlfa1 = #agifa716#7; |QBT aAlfa1; aAlfa1 = (Comodin1 + aAlfa1) % Calc;
      aAlfa2 = #agifa716#8; |QBT aAlfa2; aAlfa2 = (Comodin1 + aAlfa2) % Calc;
      |SI aAlfa1 = aAlfa2;
         Comodin = Comodin + aAlfa4 + "." + #agifa716#14 + " == " + aAlfa1 + " ";
      |SINO;
         Comodin = Comodin + aAlfa4 + "." + #agifa716#14 + " BETWEEN " + aAlfa1 + "," + aAlfa2 + " ";
      |FINSI;
   |FINSI;
   |SALVA_FICHA #agifa716;
   |LEE 000#agifa716.s;
   |SI FSalida = 0;
      aAlfa4 = #agifa716#13; |QBF aAlfa4;
      |SI aAlfa4 = Fich1; |O aAlfa4 = aCabecera;
         Comodin = Comodin + "AND ";
      |FINSI;
   |FINSI;
   |LEE 000#agifa716.p; |REPON_FICHA #agifa716;
|SINO;
   |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
      IFicheros = Ficheros1<-; IFicheros = IFicheros + Cont;
      ICabec    = Cabec1<-;    ICabec    = ICabec    + Cont;
      |SI Fich1 = Ficheros; aCabecera = Cabec; |SAL; |FINSI;
   |SIGUE;

   aAlfa4 = #agifa716#13; |QBF aAlfa4;
   |SI aAlfa4 ! Fich1; |ACABA; |FINSI;

   Comodin1 = " " * #agifa716#12; Calc = -(100 + #agifa716#12);
   |SI #agifa716#11 = "A";
      aAlfa1 = #agifa716#3; ||QBF aAlfa1; aAlfa1 = (Comodin1 + aAlfa1) % Calc;
      aAlfa2 = #agifa716#4; ||QBF aAlfa2; aAlfa2 = (Comodin1 + aAlfa2) % Calc;
      |SI aAlfa1 = aAlfa2;
         Calc = 100 + #agifa716#12;
         aAlfa1 = aAlfa1 % Calc;
         Comodin = Comodin + #agifa716#14 + " == '" + aAlfa1 + "' ";
      |SINO;
         Comodin = Comodin + #agifa716#14 + " BETWEEN '" + aAlfa1 + "','" + aAlfa2 + "' ";
      |FINSI;
   |FINSI;
   |SI #agifa716#11 = "N";
      aAlfa1 = #agifa716#5; |QBT aAlfa1; aAlfa1 = (Comodin1 + aAlfa1) % Calc;
      aAlfa2 = #agifa716#6; |QBT aAlfa2; aAlfa2 = (Comodin1 + aAlfa2) % Calc;
      |SI aAlfa1 = aAlfa2;
         Comodin = Comodin + #agifa716#14 + " == " + aAlfa1 + " ";
      |SINO;
         Comodin = Comodin + #agifa716#14 + " BETWEEN " + aAlfa1 + ", " + aAlfa2 + " ";
      |FINSI;
   |FINSI;
   |SI #agifa716#11 = "F";
      aAlfa1 = #agifa716#7; |QBT aAlfa1; aAlfa1 = (Comodin1 + aAlfa1) % Calc;
      aAlfa2 = #agifa716#8; |QBT aAlfa2; aAlfa2 = (Comodin1 + aAlfa2) % Calc;
      |SI aAlfa1 = aAlfa2;
         Comodin = Comodin + #agifa716#14 + " == " + aAlfa1 + " ";
      |SINO;
         Comodin = Comodin + #agifa716#14 + " BETWEEN " + aAlfa1 + "," + aAlfa2 + " ";
      |FINSI;
   |FINSI;
   |SALVA_FICHA #agifa716;
   |LEE 000#agifa716.s;
   |SI FSalida = 0;
      aAlfa4 = #agifa716#13; |QBF aAlfa4;
      |SI aAlfa4 = Fich1; |O aAlfa4 = aCabecera;
         Comodin = Comodin + "AND ";
      |FINSI;
   |FINSI;
   |LEE 000#agifa716.p; |REPON_FICHA #agifa716;
|FINSI;
|FPRC;

|DEFBUCLE Acotaciones;
#agifa716#1;
;
CodEnlace,001;
CodEnlace,999;
;
NULL,Acotaciones;
|FIN;

|PROCESO GeneraSQL;
|SI aVersion ] "9.10V";
   aCabecera = "";
   Cadena = Usuario; |QBF Cadena; Cadena = "sq" + Cadena;
   aAlfa = "ac" + Usuario; |NOME_DAT #agifa716#aAlfa#;
   |ABRE #agifa716; |LEE 000#agifa716.p;
   Comodin = ""; |BUCLE Acotaciones;
   |CIERRA #agifa716;

   |DFICE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "Qu" + Usuario + ".txt";
   aAlfa = "wb  " + aAlfa;
   |FABRE aAlfa;
   |SI FSalida ] 0;
      nHandle = FSalida;
      |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "def/" + Fichero + ".mas";
      |CARGA_DEF aAlfa,Referen@;
      |SI FSalida = 0;
         aAlfa = "|NC"; aAlfa = #Referen@#aAlfa#; nCalc = aAlfa;
         aClaveA = "|K000"; aClaveA = #Referen@#aClaveA#;
         aClaveB = "|K001"; aClaveB = #Referen@#aClaveB#;
         |DESCARGA_DEF #Referen@; nCalc = nCalc - 1;
         |PARA nCont = 0; |SI nCont [ nCalc; |HACIENDO nCont = nCont + 1;
            |SI nCont ! 0; aAlfa = nHandle + " ,"; |FGRABA aAlfa; |FINSI;
            aAlfa = Fichero + "." + (("000" + nCont) % -103);
            aAlfa = nHandle + " " + aAlfa; |FGRABA aAlfa;
         |SIGUE;
      |FINSI;
      aAlfa = nHandle + "  FROM " + Fichero;
      |SI aCabecera ! "";
         aAlfa = aAlfa + "," + aCabecera;
      |FINSI;
      aAlfa = aAlfa + " INTO " + Cadena + ".def WHERE ";
      |FGRABA aAlfa;

      aAlfa = nHandle + " " + Comodin; |FGRABA aAlfa;
      aAlfa = nHandle + " ORDER BY "; |FGRABA aAlfa;
      aAlfa = aClaveA % 0103; aClaveA = aClaveA % 0499;
      nCalc = aAlfa;
      |PARA nCont = 1; |SI nCont [ nCalc; |HACIENDO nCont = nCont + 1;
         aAlfa = aClaveA % 0103; aClaveA = aClaveA % 0499;
         aAlfa = Fichero + "." + aAlfa;
         |SI nCont ! nCalc; aAlfa = aAlfa + ","; |FINSI;
         aAlfa = nHandle + " " + aAlfa; |FGRABA aAlfa;
      |SIGUE;

      aAlfa = nHandle + "  AND "; |FGRABA aAlfa;
      aAlfa = aClaveB % 0103; aClaveB = aClaveB % 0499;
      nCalc = aAlfa;
      |PARA nCont = 1; |SI nCont [ nCalc; |HACIENDO nCont = nCont + 1;
         aAlfa = aClaveB % 0103; aClaveB = aClaveB % 0499;
         aAlfa = Fichero + "." + aAlfa;
         |SI nCont ! nCalc; aAlfa = aAlfa + ","; |FINSI;
         aAlfa = nHandle + " " + aAlfa; |FGRABA aAlfa;
      |SIGUE;

      FSalida = nHandle; |FCIERRA FSalida;
   |FINSI;

   |DFICE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "Qu" + Usuario + ".txt";
   Cadena = "SELECT @" + aAlfa; Fichero = Cadena;
|SINO;
   aCabecera = "";
   Cadena = Usuario; |QBF Cadena; Cadena = "sq" + Cadena;
   aAlfa = "ac" + Usuario; |NOME_DAT #agifa716#aAlfa#;
   |ABRE #agifa716;
   Comodin = ""; |BUCLE Acotaciones;
   |CIERRA #agifa716;

   Cadena = "SELECT * FROM " + Fichero + " INTO " + Cadena + ".def WHERE ";
   Cadena = Cadena + Comodin; Fichero = Cadena;
|FINSI;

|FPRC;

|PROCESO AntesLibro; |TIPO 7;
   |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FC"; |O #agifa704#2 = "FD";
    |O #agifa704#2 = "TI"; |O #agifa704#2 = "CC"; |O #agifa704#2 = "CR";
       |C_M #agifa711#6,1,"S";
   |SINO;
       #agifa711#6 = 0;  |PINTA #agifa711#6;
       #agifa711#7 = ""; |PINTA #agifa711#7;
       |C_M #agifa711#6,1,"N";
   |FINSI;
|FPRC;

|PROCESO TrasLibro;
   |SI #agifa704#2 = "CC"; |ACABA; |FINSI;
   Comodin  = PathEnlace; |QBF Comodin; Comodin  = Comodin + "def/";
   Comodin1 = Comodin + "calibros.mas";
   |CARGA_DEF Comodin1, calibro@;
   |SI FSalida ! 0;
      |MENAV "    No encuentro el fichero de libros de contabilidad";
      |ERROR; |ACABA;
   |FINSI;

   Comodin = PathEnlace; |QBF Comodin;
   Comodin1 = Comodin + "fich/" + ((("00000" + #agifa711#4) % -105) + #agifa711#5) + "/";
   |PATH_DAT #26 Comodin1;
   |ABRE #calibro@;
   #calibro@#0 = #agifa711#6;
   |LEE 000#calibro@.=;
   |SI FSalida = 0;
      |SI #calibro@#2 = "S"; |Y #agifa704#2 ! "FC";
         |MENAV "    Tipo de libro incorrecto";
         |ERROR;
      |FINSI;
      |SI #calibro@#2 = "R"; |Y #agifa704#2 ! "FV"; |Y #agifa704#2 ! "FD";
       |Y #agifa704#2 ! "TI"; |Y #agifa704#2 ! "CC"; |Y #agifa704#2 ! "CR";
         |MENAV "    Tipo de libro incorrecto";
         |ERROR;
      |FINSI;
      #agifa711#7 = #calibro@#1; |PINTA #agifa711#7;
   |SINO;
      |MENAV "    Libro inexistente";
      |ERROR;
   |FINSI;
   |CIERRA #calibro@; |DESCARGA_DEF #calibro@;
|FPRC;

|PROCESO VuelcaMemo;
   nCalc = (nLinPinta * 100) + 7;
   |ATRI I; |PINTA nCalc, "Resolviendo memorias              "; |ATRI N;
   |SI #agifa718#1 ! MemoAnt;
      |SI Primero = 0;
         Cadena = Expresion; |HAZ ResuelveExpr; nImporte = Resultado;
         |DDEFECTO #agifa721;
         #agifa721#0 = MemoAnt;
         #agifa721#1 = "N";
         #agifa721#2 = nImporte;
         |GRABA 020#agifa721.n;
      |SINO;
         Primero = 0;
      |FINSI;

      #agifa717#0 = #agifa718#0;
      #agifa717#1 = #agifa718#1;
      |LEE 000#agifa717.=;
      MemoAnt = #agifa718#1;
      Expresion = #agifa718#3; |QBF Expresion;
   |SINO;
      Expresion = Expresion + #agifa718#3; |QBF Expresion;
   |FINSI;

|FPRC;

|DEFBUCLE VuelcaMemo;
#agifa718#1;
;
#agifa711#0,"               ",001;
#agifa711#0,"zzzzzzzzzzzzzzz",999;
;
NULL,VuelcaMemo;
|FIN;

|PROCESO ResuelveMemo;
   |ABRE #agifa717;
   Primero = 1; MemoAnt = "";
   |BUCLE VuelcaMemo;
   Cadena = Expresion; |HAZ ResuelveExpr; nImporte = Resultado;
   |DDEFECTO #agifa721;
   #agifa721#0 = MemoAnt;
   #agifa721#1 = "N";
   #agifa721#2 = nImporte;
   |GRABA 020#agifa721.n;
   |CIERRA #agifa717;
|FPRC;

|RUTINA infer723;
   #agifa723#0 = #agifa716#15;
   #agifa723#1 = #agifa716#0;
   #agifa723#2 = 1;
|FRUT;

|RUTINA super723;
   #agifa723#0 = #agifa716#15;
   #agifa723#1 = #agifa716#0;
   #agifa723#2 = 999;
|FRUT;

|PROCESO Exclusion; |TIPO 3;
   |PUSHV 0959 1979;
   |SI #agifa716#11 = "A";
      LongDato = #agifa716#12;
      |CAMPO_ANCHO #agifa723#3,1,LongDato;
      |CAMPO_MAXIMO #agifa723#3,1,"#";
      |C_V #agifa723#3,1,"S"; |C_M #agifa723#3,1,"S";
   |SINO;
      |C_V #agifa723#3,1,"N"; |C_M #agifa723#3,1,"N";
   |FINSI;
   |SI #agifa716#11 = "N";
      |C_V #agifa723#4,1,"S"; |C_M #agifa723#4,1,"S";
   |SINO;
      |C_V #agifa723#4,1,"N"; |C_M #agifa723#4,1,"N";
   |FINSI;
   |SI #agifa716#11 = "F";
      |C_V #agifa723#5,1,"S"; |C_M #agifa723#5,1,"S";
   |SINO;
      |C_V #agifa723#5,1,"N"; |C_M #agifa723#5,1,"N";
   |FINSI;
   |C_V #agifa723#6,1,"N";
   |ENTLINEAL #1#agifa723,-3,1,18,1,infer723,super723;
   |C_V #agifa723#3,1,"N"; |C_M #agifa723#3,1,"N";
   |C_V #agifa723#4,1,"N"; |C_M #agifa723#4,1,"N";
   |C_V #agifa723#5,1,"N"; |C_M #agifa723#5,1,"N";
   |C_V #agifa723#6,1,"S";
   |POPV;
|FPRC;

|PROCESO MiraNDecis;
   |SI aTipoEnl = "FV"; |O aTipoEnl = "AV";
      aMoneda = #Princip@#60;
      aDivisa = #Princip@#61; |HAZ Divisas134;
   |FINSI;
   |SI aTipoEnl = "FC"; |O aTipoEnl = "AC";
      aMoneda = #Princip@#77;
      aDivisa = #Princip@#78; |HAZ Divisas079;
   |FINSI;
   |SI aTipoEnl = "FD";
       aMoneda = #Princip@#67;
       aDivisa = #Princip@#68; |HAZ Divisas084;
   |FINSI;
|FPRC;

|PROCESO CompruebaConta;
   aAlfa = "|NC"; aAlfa = #caenlac@#aAlfa#; nCalc3 = aAlfa;
   |SI nCalc3 < 52;
      |MENAV "    Versión requerida de CONTAGEN 09.01.042 o superior. Campo fecha operación sin tratamiento";
      nSw = 1;
   |FINSI;
|FPRC;

|PROCESO FormatoFechas;
   |ABRE #agifa704;
   #agifa704#0 = CodEnlace;
   |LEE 000#agifa704.=;
   |SI FSalida = 0;
      |SI #agifa704#18 = "A"; |CIERRA #agifa704; |ACABA; |FINSI;
      |SI #agifa704#18 = "B";
         |SI Modo = "B"; |HAZ MiraFechaForm; |FINSI;
         |SI #caenlac@#29 = "00.00.0000"; || Viene de la fecha contable
            |CIERRA #agifa704; |ACABA;
         |SINO;
            nSw = 0; |HAZ CompruebaConta;
            |SI nSw = 0; #caenlac@#51 = #caenlac@#29; |FINSI;
            #caenlac@#29 = #agifa711#8;
         |FINSI;
      |FINSI;
      |SI #agifa704#18 = "C";
         |SI Modo = "B"; |HAZ MiraFechaForm; |FINSI;
         |SI #caenlac@#29 = "00.00.0000"; || Viene de la fecha contable
            #caenlac@#1 = #agifa711#8;
         |SINO;
            nSw = 0; |HAZ CompruebaConta;
            |SI nSw = 0; #caenlac@#51 = #caenlac@#29; |FINSI;
            #caenlac@#29 = #agifa711#8;
         |FINSI;
      |FINSI;
      |SI #agifa704#18 = "D";
         |SI Modo = "B"; |HAZ MiraFechaForm; |FINSI;
         |SI #caenlac@#29 = "00.00.0000"; || Viene de la fecha contable
            #caenlac@#1 = #agifa711#8;
         |SINO;
            |CIERRA #agifa704; |ACABA;
         |FINSI;
      |FINSI;
   |FINSI;
   |CIERRA #agifa704;
|FPRC;

|PROCESO MiraFechaForm;
   efFechaForm = "01.01.0000"; nSwFormato = 0;

   nCalcX = Clave1Cab; aAlfaX  = #Princip@#nCalcX#; |QBF aAlfaX;
   nCalcX = Clave2Cab; aAlfa1X = #Princip@#nCalcX#; |QBF aAlfa1X;

   #agifa722#0 = #agifa704#2;
   #agifa722#1 = aAlfaX;
   #agifa722#2 = aAlfa1X;
   #agifa722#3 = nAnyo;
   |LEE 000#agifa722.];
   aAlfa2X = #agifa722#1; |QBF aAlfa2X;
   aAlfa3X = #agifa722#2; |QBF aAlfa3X;
   nCalcX = #agifa722#3;
   |PARA; |SI FSalida = 0; |Y #agifa722#0 = #agifa704#2; |Y aAlfa2X = aAlfaX; |Y aAlfa3X = aAlfa1X; |Y nCalcX = nAnyo; |HACIENDO;
      |SI nSwFormato = 0;
         efFechaForm = #agifa722#5;
         nSwFormato = 1;
      |SINO;
         efFechaForm = "01.01.0000";
      |FINSI;

      |LEE 000#agifa722.s;
      aAlfa2X = #agifa722#1; |QBF aAlfa2X;
      aAlfa3X = #agifa722#2; |QBF aAlfa3X;
      nCalcX = #agifa722#3;
   |SIGUE;

   |SI nSwFormato = 1; |Y efFechaForm ! "01.01.0000";
      |DDEF aAlfa2X; |QBF aAlfa2X;
      aAlfa2X = aAlfa2X + "agifa743.mas";
      |CARGA_DEF aAlfa2X, RefDato@;
      |SI FSalida = 0;
         |DFICE aAlfa2X; |QBF aAlfa2X;
         |PATH_DAT #RefDato@#aAlfa2X#; |ABRE #RefDato@;
         #RefDato@#0 = #agifa704#2;
         #RefDato@#1 = aAlfaX;
         #RefDato@#2 = aAlfa1X;
         #RefDato@#3 = nAnyo;
         |LEE 000#RefDato@.=;
         |SI FSalida ! 0;
            |DDEFECTO #RefDato@;
            #RefDato@#0 = #agifa704#2;
            #RefDato@#1 = aAlfaX;
            #RefDato@#2 = aAlfa1X;
            #RefDato@#3 = nAnyo;
            #RefDato@#4 = #agifa704#18;
            #RefDato@#5 = efFechaForm;
            #RefDato@#6 = #agifa704#0;
            |GRABA 020#RefDato@.n;
         |FINSI;
         |CIERRA #RefDato@; |DESCARGA_DEF #RefDato@;
      |FINSI;
   |FINSI;
|FPRC;

/************************************************/

|RUTINA inferior;
   #agifa712#0 = 00;
   #agifa712#1 = "01.01.1900";
   #agifa712#2 = 000001;
   #agifa712#3 = 0001;
   #agifa712#12 = 00000;
   #agifa712#13 = 0;
|FRUT;

|RUTINA superior;
   #agifa712#0 = 99;
   #agifa712#1 = "31.12.2999";
   #agifa712#2 = 999999;
   #agifa712#3 = 9999;
   #agifa712#12 = 99999;
   #agifa712#13 = 9;
|FRUT;

|PROCESO TomaDatos;

/*
   Si se le pasa en la variable 'Fich' el nombre del fichero del que quieres
   extraer el dato y en la variable 'Cmp' el numero del campo, devuelve en la
   variable 'Comodin' el valor correspondiente
*/
   Comodin = "";
   #agifa715#0 = Fich;
   #agifa715#1 = Cmp;
   |LEE 010#agifa715.=;
   |SI FSalida = 0;
      |SI #agifa715#2 = "A"; Comodin = #agifa715#3; |FINSI;
      |SI #agifa715#2 = "N"; Comodin = #agifa715#4; |FINSI;
      |SI #agifa715#2 = "F"; Comodin = #agifa715#5; |FINSI;
   |FINSI;

   |SI DigFormat ! 0;
      |SI DigFormat < 0;
         DigFormat = 0 - DigFormat;
         |SI #agifa715#2 = "N";
            Comodin1 = "0" * DigFormat;
            |QBF Comodin;
            Calc = 0 - (100 + DigFormat);
            Comodin = (Comodin1 + Comodin) % Calc;
         |FINSI;
         |SI #agifa715#2 = "A";
            Comodin1 = " " * DigFormat;
            |QBF Comodin;
            Calc = 0 - (100 + DigFormat);
            Comodin = (Comodin1 + Comodin) % Calc;
         |FINSI;
      |SINO;
         |SI #agifa715#2 = "N";
            Comodin1 = "0" * DigFormat;
            |QBF Comodin;
            Calc = 0 - (100 + DigFormat);
            Comodin = (Comodin1 + Comodin) % Calc;
         |FINSI;
         |SI #agifa715#2 = "A";
            Comodin1 = " " * DigFormat;
            Calc = 100 + DigFormat;
            Comodin = (Comodin + Comodin1) % Calc;
         |FINSI;
      |FINSI;
   |SINO;
      |QBF Comodin;
   |FINSI;

|FPRC;

|PROCESO BuscaPeriodo;
   |SI Modo = "B"; |Y enPeriodoBaja ! 0;
         nPeriodo = enPeriodoBaja;  || Por ahora solo se carga en el agifa084
         |ACABA;
   |FINSI;

   nPeriodo = -1;
   nEmp = 2; nPer = 3; nEje = 26;
   #canempr@#nEmp# = #agifa704#4;
   #canempr@#nPer# = 0;
   |LEE 000#canempr@.];
   |PARA; |SI FSalida = 0; |Y #canempr@#nEmp# = #agifa704#4; |HACIENDO;
      nCalc = #canempr@#nEje#;
      |SI nCalc ] 80; nCalc = nCalc + 1900; |SINO; nCalc = nCalc + 2000; |FINSI;
      nEjerc = nCalc;
      aAlfa = "01." + (("00" + #canempr@#11) % -102) + "." + nCalc;       fFechaIni = aAlfa;
      nCalc = nCalc + 1;
      nCalc1 = #canempr@#12 + 1;
      |SI nCalc1 > 12; nCalc1 = 1; |FINSI;
      aAlfa = "01." + (("00" + nCalc1) % -102) + "." + nCalc; fFechaFin = aAlfa;
      nCalc1 = fFechaFin; nCalc1 = nCalc1 - 1; fFechaFin = nCalc1;
      |SI fFechaIni [ fFechaEje; |Y fFechaEje [ fFechaFin;
         nPeriodo = #canempr@#nPer#; |SAL;
      |FINSI;
      |LEE 000#canempr@.s;
   |SIGUE;
|FPRC;

/*
|PROCESO SacaEmpresa;
   #canempr@#2 = #agifa711#4;
   #canempr@#3 = #agifa711#5;
   |LEE 000#canempr@.=;
   |SI FSalida = 0;
      aAlfa = #caenlac@#1; |QBF aAlfa;
      |SI aAlfa ! ""; aAlfa = aAlfa % -104; nAnyo = aAlfa; |FINSI;
      nCalc = #canempr@#26;
      |SI nCalc ] 80; nCalc = nCalc + 1900; |SINO; nCalc = nCalc + 2000; |FINSI;
      nEjerc = nCalc;

      aAlfa = "01." + (("00" + #canempr@#11) % -102) + "." + nCalc; fFechaIni = aAlfa;
      aAlfa = "01." + (("00" + (#canempr@#12 + 1)) % -102) + "." + (nCalc+1); fFechaFin = aAlfa;
      nCalc1 = fFechaFin; nCalc1 = nCalc1 - 1; fFechaFin = nCalc1;

      |SI nCalc ! nAnyo; |O #caenlac@#1 < fFechaIni; |O #caenlac@#1 > fFechaFin;
         nPeriodo = -1;
         nEmp = 2; nPer = 3; nEje = 26;
         #canempr@#nEmp# = #agifa704#4;
         #canempr@#nPer# = 0;
         |LEE 000#canempr@.];
         |PARA; |SI FSalida = 0; |Y #canempr@#nEmp# = #agifa704#4; |HACIENDO;
            nCalc = #canempr@#nEje#;
            |SI nCalc ] 80; nCalc = nCalc + 1900; |SINO; nCalc = nCalc + 2000; |FINSI;
            nEjerc = nCalc;
            |SI nCalc = nAnyo; |Y #caenlac@#1 ] fFechaIni; |Y #caenlac@#1 [ fFechaFin;
               nPeriodo = #canempr@#nPer#; |SAL;
            |FINSI;
            |LEE 000#canempr@.s;
         |SIGUE;
         |SI nPeriodo = -1;
            #caenlac@#37 = #agifa711#4; #caenlac@#38 = #agifa711#5;
         |SINO;
            #caenlac@#37 = #agifa711#4; #caenlac@#38 = nPeriodo;
         |FINSI;
      |SINO;
         #caenlac@#37 = #agifa711#4; #caenlac@#38 = #agifa711#5;
      |FINSI;
   |FINSI;
|FPRC;
*/

|PROCESO GestionaPorVar;
   || Compruebo si la base a procesar no es de las normales (portes, varios, etc)
   ||    Si es as¡ indico el tipo de iva manualmente, pero grabo
   ||    solo una vez, puesto que es un importe de cabecera
   aAlfa = #agifa706#8; |QBF aAlfa; nSwTipo = 0;

     |SI aAlfa = "[agifa077][069]"; |O aAlfa = "[agifa077][070]";
          Fich = "agifa077"; Cmp = 0; DigFormat = 0; |HAZ TomaDatos;
          |ABRE #agifa112;
          #agifa112#0 = Comodin;
          |LEE 000#agifa112.=;
          |CIERRA #agifa112;
          aTieneRecargo = #agifa112#58;
          aSobreIRPF    = #agifa112#86;
     |FINSI;
     |SI aAlfa = "[agifa010][081]"; |O aAlfa = "[agifa010][082]";
          Fich = "agifa024"; Cmp = 0; DigFormat = 0; |HAZ TomaDatos;
          |ABRE #agifa024;
          #agifa024#0 = Comodin;
          |LEE 000#agifa024.=;
          |CIERRA #agifa024;
          aTieneRecargo = #agifa024#47;
          aSobreIRPF    = #agifa024#207;
     |FINSI;

   |SI aAlfa = "[agifa077][069]"; |O aAlfa = "[agifa010][081]";
      eaTipoImporte = "P";
      enSwError = 0;
      |SI aAlfa = "[agifa077][069]";
         Fich = "agifa077"; Cmp = 50; DigFormat = 0; |HAZ TomaDatos;
         eaSerAlbaran = Comodin;
         Fich = "agifa077"; Cmp = 0;  DigFormat = 0; |HAZ TomaDatos;
         enNumAlbaran = Comodin;
      |SINO;
         Fich = "agifa010"; Cmp = 52; DigFormat = 0; |HAZ TomaDatos;
         eaSerAlbaran = Comodin;
         Fich = "agifa010"; Cmp = 0;  DigFormat = 0; |HAZ TomaDatos;
         enNumAlbaran = Comodin;
      |FINSI;
      |HAZ MiraSiPasadoAlbaran;
      |SI enSwError = 0;
         #caenlac@#27 = #caenlac@#27 + 5; || Para separar el iva de portes
         |SI nHayPortes ! 0;
            || nCalc1X = #caenlac@#9;
            nCalc1X = nImporte;
            #caenlac@#3 = nHayPortes;
            |LEE 000#caenlac@.=;
            |SI FSalida = 0;
               #caenlac@#9 = #caenlac@#9 + nCalc1X;
            |FINSI;
         |FINSI;
         |SI aAlfa = "[agifa077][069]";
            Fich = "agifa077"; Cmp = 1; DigFormat = 0; |HAZ TomaDatos;
            efFechaIVA = Comodin;
            Fich = "agifa077"; Cmp = 12; DigFormat = 0; |HAZ TomaDatos;
         |SINO;
            Fich = "agifa010"; Cmp = 1; DigFormat = 0; |HAZ TomaDatos;
            efFechaIVA = Comodin;
            Fich = "agifa010"; Cmp = 12; DigFormat = 0; |HAZ TomaDatos;
         |FINSI;
         enTipoIVA = Comodin; |HAZ RecogeIva;
         #caenlac@#28 = enTipoIVA;
         |SI aTieneRecargo = "S"; #caenlac@#33 = enTipoREC; |FINSI;
         nSwTipo = 1;
         |SI nHayPortes = 0;
            |SI #caenlac@#9 ! 0;
               nHayPortes = #caenlac@#3;
               |SI NVuelta > 1;
                  |HAZ MiraRectif;
                  |SI Salir = 0;
                     |GRABA 020#caenlac@.c;
                  |SINO;
                     |GRABA 020#caenlac@.a;
                  |FINSI;
                  |HAZ GraTmpCuadre;
               |FINSI;
            |FINSI;
         |SINO;
            |SI NVuelta > 1;
                  |GRABA 020#caenlac@.a;
                  |HAZ GraTmpCuadre;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;
   |SI aAlfa = "[agifa077][070]"; |O aAlfa = "[agifa010][082]";
      eaTipoImporte = "V";
      enSwError = 0;
      |SI aAlfa = "[agifa077][070]";
         Fich = "agifa077"; Cmp = 50; DigFormat = 0; |HAZ TomaDatos;
         eaSerAlbaran = Comodin;
         Fich = "agifa077"; Cmp = 0;  DigFormat = 0; |HAZ TomaDatos;
         enNumAlbaran = Comodin;
      |SINO;
         Fich = "agifa010"; Cmp = 52; DigFormat = 0; |HAZ TomaDatos;
         eaSerAlbaran = Comodin;
         Fich = "agifa010"; Cmp = 0;  DigFormat = 0; |HAZ TomaDatos;
         enNumAlbaran = Comodin;
      |FINSI;
      |HAZ MiraSiPasadoAlbaran;
      |SI enSwError = 0;
         #caenlac@#27 = #caenlac@#27 + 6; || Para separar el iva de varios
         |SI nHayVarios ! 0;
            nCalc1X = #caenlac@#9;
            #caenlac@#3 = nHayVarios;
            |LEE 000#caenlac@.=;
            |SI FSalida = 0;
               #caenlac@#9 = #caenlac@#9 + nCalc1X;
            |FINSI;
         |FINSI;
         |SI aAlfa = "[agifa077][070]";
            Fich = "agifa077"; Cmp = 1; DigFormat = 0; |HAZ TomaDatos;
            efFechaIVA = Comodin;
            Fich = "agifa077"; Cmp = 14; DigFormat = 0; |HAZ TomaDatos;
         |SINO;
            Fich = "agifa010"; Cmp = 1; DigFormat = 0; |HAZ TomaDatos;
            efFechaIVA = Comodin;
            Fich = "agifa010"; Cmp = 14; DigFormat = 0; |HAZ TomaDatos;
         |FINSI;
         enTipoIVA = Comodin; |HAZ RecogeIva;
         #caenlac@#28 = enTipoIVA;
         |SI aTieneRecargo = "S"; #caenlac@#33 = enTipoREC; |FINSI;
         nSwTipo = 1;
         |SI nHayVarios = 0;
            |SI #caenlac@#9 ! 0;
               nHayVarios = #caenlac@#3;
               |SI NVuelta > 1;
                  |HAZ MiraRectif;
                  |GRABA 020#caenlac@.c;
               |FINSI;
            |FINSI;
         |SINO;
            |SI NVuelta > 1;
               |HAZ MiraRectif;
               |GRABA 020#caenlac@.a;
               |HAZ GraTmpCuadre;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO RevisaCif;
   |QBF aCifCand; |QBF eaCif;
   |SI eaCif = ""; eaCif = aCifCand; |ACABA; |FINSI;

   |SI aCifCand ! eaCif;
      |SI #agifa706#13 = "F";
         eaTipoAviso = "A";
         |SI #agifa704#2 = "FV"; eaAviso = "[" + #Princip@#49 + "/" + (("000000" + #Princip@#0) % -106); |FINSI;
         |SI #agifa704#2 = "FC"; eaAviso = "[" + #Princip@#66 + "/" + (("000000" + #Princip@#0) % -106); |FINSI;
         |SI #agifa704#2 = "FD"; eaAviso = "[" + #Princip@#48 + "/" + (("000000" + #Princip@#0) % -106); |FINSI;
         |SI aTipoCif = "C";
            eaAviso = eaAviso + "] El CIF del cliente no es el mismo que el indicado en la ficha de clientes";
         |SINO;
            eaAviso = eaAviso + "] El CIF del proveedor no es el mismo que el indicado en la ficha de proveedores";
         |FINSI;
         eaAviso = eaAviso + " (" + eaCif + " - " + aCifCand + ")";
         |HAZ AnadeAviso;
      |FINSI;
   |FINSI;

   aCandiAnt = aCifCand;
   aClvAnt1 = #caenlac@#12; aClvAnt2 = #caenlac@#13;
|FPRC;

|PROCESO agifa706a;
/*
   Consta de tres partes :
    1 - Se resuelve la expresion o se recoge el valor fijo que se indico como
        la cuenta que ira referida a la linea que estamos tratando.
    2 - Resolvera la expresion indicada para usar como descripcion en la
        linea del asiento
    3 - Se resolvera el importe del asiento en base a la cantidad o la
        expresion indicadas para ello

   Una vez calculado todo esto, se escribe la linea del asiento en el fichero
   puente.

   Ademas se ocupa de marcar el registro del fichero principal del enlace
   con el numero de empresa y el periodo con el que se ejecuta el enlace asi
   como el codigo de enlace usado.
*/

   ||HAZ EsCompaq;
   ||SI FSalida = 0; |HAZ MiraSiIntracom; |FINSI;
   |SI #agifa704#2 = "FC"; |Y #agifa704#8 = "S"; |HAZ MiraSiIntracom; |FINSI;

   |ATRI I; Mensaje = "Enlazando, espere por favor ..... " + MarcaPant; |HAZ ActMarca;
   nCalc = (nLinPinta * 100) + 7;
   |PINTA nCalc, "Escribiendo asientos";
   nCalc = nCalc + 100;
   |PINTA nCalc, Mensaje; |ATRI R;

||************************************* PARTE 1

   |SI #agifa704#2 = "CC"; |Y #agifa704#8 = "S"; |Y #agifa706#12 = "S";
      || Utilizo el campo 'Acumular valor' para distinguir las lineas que
      ||    tengo que reemplazar por el grupo.
      || Debo hacer un bucle por cada linea con 'Acumular valor' = "S" de
      ||    todos los tiquets con la fecha de cierre del cierre de caja
      ||    recogiendo los campos mas representativos para usarlos en el
      ||    enlace.
      ||efFechaCierre = #Referen@#1;
      ||eaCtaAnalit = #agifa706#16;
      ||HAZ Tiquets;
      ||ACABA;
   |FINSI;

   |SALVA_DATOS #caenlac@;
   |ABRE #agifa715;
   Cuenta = #agifa706#3; |QBF Cuenta;
   |SI Cuenta = "[LUXE]";
      eaCuenta = "";
      |HAZ EsCompaq;
      |SI FSalida = 0; |Y #agifa704#8 = "S";
         Fich = "agifa019"; Cmp = 0; |HAZ TomaDatos; eaArticulo = Comodin;
         |SI #agifa704#2 = "FC";
            Fich = "agifa077"; Cmp = 3; |HAZ TomaDatos; eaProveedor = Comodin;

            ||CCC Tiquet 1483.2191. No pillaba bien el eaArticulo. Lo pillaba vacio
            |SI eaArticulo = "";
                 Fich = "agifa080"; Cmp = 2; |HAZ TomaDatos; eaArticulo = Comodin;
            |FINSI;
         |FINSI;
         eaTipoEnl = #agifa704#2; eaCuenta = ""; |HAZ BuscaCtaLuxe;
      |FINSI;
      Cuenta = eaCuenta;
   |SINO;
      |SI Cuenta = "[REVISION]";
         Fich = "agifa084"; Cmp = 48; |HAZ TomaDatos; eaSerie   = Comodin;
         Fich = "agifa084"; Cmp = 0;  |HAZ TomaDatos; enFactura = Comodin;
         Fich = "agifa069"; Cmp = 13; |HAZ TomaDatos; eaFamilia = Comodin;
         |QBF eaFamilia;
         |SI eaFamilia = "";
            Fich = "agifa019"; Cmp = 2; |HAZ TomaDatos; eaFamilia = Comodin;
         |FINSI;
         eaCuenta = ""; |HAZ BuscaCtaRevision;
         |SI eaCuenta = "";
            Fich = "agifa060"; Cmp = 2; |HAZ TomaDatos; eaCuenta = Comodin;
         |FINSI;
         Cuenta = "";
      |FINSI;

      |QBF eaCuenta; |QBF Cuenta;
      |SI eaCuenta ! ""; |Y Cuenta = "";
         Cuenta = eaCuenta;
         eaCuenta = "";
      |SINO;
         Cuenta = #agifa706#3; |QBF Cuenta;
         |SI enSwTaller = 0; |Y Cuenta = "[con00002][002]";
               || Cambia por el campo partida cargado anteriormente
               Cuenta = "[agifa080][037]";
         |FINSI;
         aLong = Cuenta % 0; nLong = aLong;
         |PARA nCont = 1; |SI nCont [ nLong; |HACIENDO nCont = nCont + 1;
            Calc = (nCont * 100) + 1;
            Caracter = Cuenta % Calc;
            |SI Caracter = "[";
               Calc1 = Calc + 100; Caracter = Cuenta % Calc1;
               |SI Caracter = "%";
                  Calc1 = Calc1 + 100; aAlfa = Cuenta % Calc1;
                  |SI aAlfa = "-";
                     Calc1 = Calc + 18;
                  |SINO;
                     Calc1 = Calc + 17;
                  |FINSI;
                  Cadena = Cuenta % Calc1; Cuenta = Cuenta - Cadena;
                  |SI aAlfa = "-";
                     aLong = Cadena % 0402;
                     DigFormat = 0 - aLong;
                     Fich  = Cadena % 0608; Cmp   = Cadena % 1603;
                  |SINO;
                     aLong = Cadena % 0302;
                     DigFormat = aLong;
                     Fich  = Cadena % 0508; Cmp   = Cadena % 1503;
                  |FINSI;
                  |HAZ TomaDatos;
               |SINO;
                  Calc1 = Calc + 14;
                  Cadena = Cuenta % Calc1; Cuenta = Cuenta - Cadena;
                  DigFormat = 0;
                  Fich  = Cadena % 0208; Cmp   = Cadena % 1203;
                  |HAZ TomaDatos;
               |FINSI;
               Calc1 = 100 + (nCont - 1);
               Cadena = Cuenta % Calc1; Cuenta = Cuenta - Cadena;
               Cuenta = Cadena + Comodin + Cuenta;
               nCont = nCont - 1;
            |FINSI;
         |SIGUE;
      |FINSI;
   |FINSI;

   nSwErrCta = 0;
   aAlfa = Cuenta; |QBF aAlfa;
   |SI aAlfa = "";
      eaCuenta = Cuenta;
      |HAZ Reemplaza;
      |SI eaCuenta ! Cuenta; nSwErrCta = 1; |FINSI;
      Cuenta = eaCuenta;
   |FINSI;

   Comodin = Cuenta; |QBF Comodin;
   aLong = Comodin % 0; nLong = aLong;
   SwNivel = 0;
   |SI nLong = Dig1; SwNivel = 1; Nivel = 1; |FINSI;
   |SI nLong = Dig2; SwNivel = 1; Nivel = 2; |FINSI;
   |SI nLong = Dig3; SwNivel = 1; Nivel = 3; |FINSI;
   |SI nLong = Dig4; SwNivel = 1; Nivel = 4; |FINSI;
   |SI nLong = Dig5; SwNivel = 1; Nivel = 5; |FINSI;
   |SI nLong = Dig6; SwNivel = 1; Nivel = 6; |FINSI;
   |SI SwNivel = 0; Nivel = 0; |FINSI;

||************************************* PARTE 2
   DigFormat = 0;
   Comodin = #agifa706#6; |QBF Comodin;

   |SI Comodin ! "[=]";
      Cadena = "";
      Comodin = "";
      Descr = #agifa706#6;
      Descr = Descr - "][";
      |SI FSalida ! 0;
         |PARA; |SI FSalida ! 0; |HACIENDO;
            Descr = Descr - "[";
            Calc = FSalida;
            Comodin1 = Descr % Calc;
            |SI Comodin1 = "%";
               Calc = Calc + 100; Comodin1 = Descr % Calc;
               |SI Comodin1 = "-";
                  Calc = Calc + 100; Comodin1 = Descr % Calc;
                  aAlfa = "-";
               |FINSI;
               |SI Comodin1 ] "0"; |Y Comodin1 [ "9";
                  Calc = Calc + 2;
                  Comodin1 = Descr % Calc;
                  |SI aAlfa = "-";
                     Descr = Descr - "%-";
                     DigFormat = 0 - Comodin1;
                  |SINO;
                     Descr = Descr - "%";
                     DigFormat = Comodin1;
                  |FINSI;
                  Descr = Descr - Comodin1;
               |FINSI;
            |FINSI;
            ComodNum = FSalida;
            ComodNum = ((ComodNum / 100) ! 0);
            ComodNum = 100 + (ComodNum - 1);
            Comodin1 = Descr % ComodNum; Descr = Descr - Comodin1;
            Cadena   = Cadena + Comodin1; ||QBF Cadena;
            Fich = Descr % 0108; |QBF Fich; Descr = Descr - Fich;
            Cmp  = Descr % 0103; Descr = Descr - Cmp;
            Descr = Descr - "]";
            |HAZ TomaDatos; DigFormat = 0;
            Cadena = Cadena + Comodin;
            Descr = Descr - "][";
         |SIGUE;
         Descr = Cadena + Descr;
      |FINSI;
   |FINSI;


||************************************* PARTE 3
   DigFormat = 0;
   Cadena = #agifa706#8; |HAZ ResuelveExpr; nImporte = Resultado;
||  A partir de aqui, se genera la/s linea/s del fichero puente necesarias
||    para dar de alta el/los asiento/s necesario/s

   UltimoApunte  = NumApunte;
   |SI #agifa704#7 = "S";
      UltApunt = -1;
      ||SALVA_FICHA #caenlac@;
      nCampo1 = #caenlac@#0;
      nCampo2 = #caenlac@#1;
      nCampo3 = #caenlac@#2;
      nCampo4 = #caenlac@#3;
      nCampo5 = #caenlac@#37;
      nCampo6 = #caenlac@#38;

      nDiario  = #caenlac@#0;
      Fecha    = #caenlac@#1;
      nCalc    = Fecha; nCalc = nCalc + 1;
      #caenlac@#1 = nCalc;
      nDocum   = #caenlac@#2;
      #caenlac@#2 = 1;
      #caenlac@#3 = 1;
      nEmpr1   = #caenlac@#37;
      nPeri1   = #caenlac@#38;
      |LEE 000#caenlac@.];
      |SI FSalida = 0;
         |LEE 000#caenlac@.a;
         |SI FSalida = 0; |Y #caenlac@#37 = nEmpr1; |Y #caenlac@#38 = nPeri1;
          |Y #caenlac@#0 = nDiario; |Y #caenlac@#1 = Fecha;
             UltApunt = #caenlac@#3 + 1; nDocum = #caenlac@#2;
         |FINSI;
      |SINO;
         |LEE 000#caenlac@.u;
         |SI FSalida = 0; |Y #caenlac@#37 = nEmpr1; |Y #caenlac@#38 = nPeri1;
          |Y #caenlac@#0 = nDiario; |Y #caenlac@#1 = Fecha;
             UltApunt = #caenlac@#3 + 1; nDocum = #caenlac@#2;
         |FINSI;
      |FINSI;

      ||REPON_FICHA #caenlac@;
      #caenlac@#0 = nCampo1;
      #caenlac@#1 = nCampo2;
      #caenlac@#2 = nCampo3;
      #caenlac@#3 = nCampo4;
      #caenlac@#37 = nCampo5;
      #caenlac@#38 = nCampo6;
      |LEE 000#caenlac@.=;

      |SI UltApunt ] 0;
         NumApunte = UltApunt; UltApunt = UltApunt - 1;
         #caenlac@#2 = nDocum;
         #caenlac@#3 = UltApunt;
         |LEE 000#caenlac@.=;
         #caenlac@#25 = "N";
      |FINSI;
   |FINSI;
   aGrupoCta = Cuenta; |QBF aGrupoCta;
   aGrupoCta = aGrupoCta % 0101;
   Comodin = "";
   |SI #agifa704#8 = "S";
      |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FD";
       |O #agifa704#2 = "TI"; |O #agifa704#2 = "FC";
         |SI nCaja = 1;
            |SI #agifa704#2 = "FV";
               aCodigo = #Princip@#2;
               aAlfa = eaNombre; |QBF aAlfa;
               |SI aAlfa = ""; eaNombre = #Princip@#3; |FINSI;

               aCifCand = #Princip@#124; aTipoCif = "C"; |HAZ RevisaCif;
               |SI eaCif = "";
                  Fich = "agifa024"; Cmp = 15; DigFormat = 0; |HAZ TomaDatos;
                  aCifCand = Comodin; aTipoCif = "C"; |HAZ RevisaCif;
               |FINSI;

               |ABRE #agifa024;
               #agifa024#0 = aCodigo;
               |LEE 000#agifa024.=;
               |SI FSalida = 0;
                  aCifCand = #agifa024#15; aTipoCif = "C"; |HAZ RevisaCif;
                  |HAZ RegNif;
               |FINSI;
               |CIERRA #agifa024;
            |FINSI;

            |SI #agifa704#2 = "FC";
               aCodigo = #Princip@#2;
               aAlfa = eaNombre; |QBF aAlfa;
               |SI aAlfa = ""; eaNombre = #Princip@#3; |FINSI;

               Fich = "agifa112"; Cmp = 9; DigFormat = 0; |HAZ TomaDatos;
               aCifCand = Comodin; aTipoCif = "P"; |HAZ RevisaCif;

               |ABRE #agifa112;
               #agifa112#0 = aCodigo;
               |LEE 000#agifa112.=;
               |SI FSalida = 0;
                  aCifCand = #agifa112#9; aTipoCif = "P"; |HAZ RevisaCif;
                  |HAZ RegNif;
               |FINSI;
               |CIERRA #agifa112;
            |FINSI;
            |SI #agifa704#2 = "FD";
               aCodigo = #Princip@#3;
               aAlfa = eaNombre; aAlfa = "";
               |SI aAlfa = ""; eaNombre = #Princip@#4; |FINSI;

               aCifCand = #Princip@#60; aTipoCif = "C"; |HAZ RevisaCif;
               |SI eaCif = "";
                  Fich = "agifa024"; Cmp = 15; DigFormat = 0; |HAZ TomaDatos;
                  aCifCand = Comodin; aTipoCif = "C"; |HAZ RevisaCif;
               |FINSI;

               |ABRE #agifa024;
               #agifa024#0 = aCodigo;
               |LEE 000#agifa024.=;
               |SI FSalida = 0;
                  aCifCand = #agifa024#15; aTipoCif = "C"; |HAZ RevisaCif;
                  |HAZ RegNif;
               |FINSI;
               |CIERRA #agifa024;
            |FINSI;
            #caenlac@#43 = eaNombre;
            #caenlac@#44 = eaCif;
         |SINO;
            |SI #agifa704#2 = "FV";
               #caenlac@#43 = #Princip@#3;
               aAlfa = #Princip@#124; |QBF aAlfa;
               |SI aAlfa = "";
                  |ABRE #agifa024;
                  #agifa024#0 = #Princip@#2;
                  |LEE 000#agifa024.=;
                  |SI FSalida = 0;
                     aAlfa      = #agifa024#15;
                     aSobreIRPF = #agifa024#207;
                  |FINSI;
                  |CIERRA #agifa024;
               |FINSI;
               #caenlac@#44 = aAlfa;
            |FINSI;
            |SI #agifa704#2 = "FC";
               |ABRE #agifa112;
               #agifa112#0 = #Princip@#2;
               |LEE 000#agifa112.=;
               |SI FSalida = 0;
                  #caenlac@#43 = #Princip@#3;
                  #caenlac@#44 = #agifa112#9;
                  aSobreIRPF   = #agifa112#86;
               |FINSI;
               |CIERRA #agifa112;
            |FINSI;
            |SI #agifa704#2 = "FD";
               aAlfa = #Princip@#60; |QBF aAlfa;
               |SI aAlfa ! "";
                  #caenlac@#43 = #Princip@#4;
                  #caenlac@#44 = #Princip@#60;
               |SINO;
                  #caenlac@#43 = "";
                  #caenlac@#44 = "";
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
      |SI #agifa706#16 = "C";
         |SI #agifa704#2 = "TI";
         |FINSI;
         |SI #agifa704#2 = "CC";
            Fich = "agifa505"; Cmp = 166; DigFormat = 0; |HAZ TomaDatos;
         |FINSI;
      |FINSI;
      |SI #agifa706#16 = "S";
         Fich = "agifa007"; Cmp = 43; DigFormat = 0; |HAZ TomaDatos;
      |FINSI;
      |SI #agifa706#16 = "L";
         Fich = "agifa080"; Cmp = 3; DigFormat = 0; |HAZ TomaDatos;
         Comodin = ("00000" + Comodin) % -105;
      |FINSI;

      aDepart = ""; aSubDep = ""; enSwComport = 0;
      |SI #agifa706#16 = "A";
         |HAZ EsViarsa;
         |SI FSalida = 0;
            |DDEF aAlfa; |QBF aAlfa;
            |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FC";
               |SI #agifa704#8 = "S";
                  |SI #agifa704#2 = "FV"; aAlfa = aAlfa + "viarsa01.mas"; |FINSI;
                  |SI #agifa704#2 = "FC"; aAlfa = aAlfa + "viarsa02.mas"; |FINSI;
               |SINO;
                  aAlfa = "";
               |FINSI;
            |FINSI;
            |SI #agifa704#2 = "FD"; aAlfa = aAlfa + "viarsa03.mas"; |FINSI;
            |SI aAlfa ! "";
               |CARGA_DEF aAlfa, RefDato@;
               |SI FSalida = 0;
                  |ABRE #RefDato@;
                  aAlfa = "|K001"; aAlfa = #Referen@#aAlfa#;
                  aAlfa2 = "|K000"; aAlfa2 = #RefDato@#aAlfa2#;
                  aAlfa = aAlfa % 0499; aAlfa2 = aAlfa2 % 0499;
                  |PARA; |SI aAlfa ! ""; |HACIENDO;
                     aAlfa1 = aAlfa % 0103; aAlfa = aAlfa % 0499;
                     aAlfa3 = aAlfa2 % 0103; aAlfa2 = aAlfa2 % 0499;
                     |QBF aAlfa1; |QBF aAlfa3;
                     nCalc = aAlfa1; nCalc1 = aAlfa3;
                     |SI aAlfa3 ! "";
                        #RefDato@#nCalc1# = #Referen@#nCalc#;
                     |FINSI;
                  |SIGUE;
                  |LEE 000#RefDato@.=;
                  |SI FSalida = 0;
                     Comodin = #RefDato@#3; aDepart = #RefDato@#4;
                     aSubDep = #RefDato@#5;
                  |SINO;
                     Comodin = ""; aDepart = ""; aSubDep = "";
                  |FINSI;
                  |CIERRA #RefDato@; |DESCARGA_DEF #RefDato@;
               |FINSI;
            |FINSI;
         |SINO;
            |HAZ EsVipei;
            |SI FSalida = 0;
                 enSwComport = 0;
                 ||ARA
                 |DDEF aAlfa; |QBF aAlfa;
                 |SI #agifa704#2 = "FV";
                    Fich = "agifa010"; Cmp = 83; DigFormat = 0; |HAZ TomaDatos;
                    aContrato = Comodin;
                    nContrato = aContrato;

                    |DDEF aAlfa; |QBF aAlfa;
                    aAlfa = aAlfa + "vipem007.mas";
                 |FINSI;
                 |SI aAlfa ! "";
                    |CARGA_DEF aAlfa, RefDato@;
                    |SI FSalida = 0;
                       |ABRE #RefDato@;
                       #RefDato@#0 = nContrato;
                       |LEE 000#RefDato@.=;
                       |SI FSalida = 0;
                          ||A partir del tiquet. 2805/297. La cta. esta en el contrato
                          ||En el edificio, esta la configuracion de esta Cuenta.
                          enEdificio = #RefDato@#1;
                          |HAZ DameCtaAna;
                          Comodin = #RefDato@#35;
                       |SINO;
                          Comodin = "";
                       |FINSI;
                       |CIERRA #RefDato@; |DESCARGA_DEF #RefDato@;
                    |FINSI;
                 |FINSI;
            |SINO;
               |HAZ EsConstru;
               |SI FSalida = 0;
                  |SI #agifa704#2 = "FV";
                     |SI #agifa704#8 = "S";
                        Fich = "agifa010"; Cmp = 83; DigFormat = 0; |HAZ TomaDatos;
                     |FINSI;
                  |FINSI;
                  |SI #agifa704#2 = "FD";
                     Fich = "agifa084"; Cmp = 87; DigFormat = 0; |HAZ TomaDatos;
                  |FINSI;
                  |QBF Comodin;
                  Comodin = Comodin - "/";
                  |SI FSalida ! 0;
                     nCalc = ((FSalida / 100) ! 0) + 99;
                     Comodin = Comodin % nCalc;
                  |FINSI;
                  |QBF Comodin;

                  eaSwObra = Comodin; |HAZ MiraObra;  Comodin = eaSwObra;
               |SINO;
                  |HAZ EsPalmHotel;
                  |SI FSalida = 0;
                     |SI #agifa704#2 = "FC";
                        Fich = "palmhm01"; Cmp = 3; DigFormat = 0; |HAZ TomaDatos;
                     |SINO;
                        Fich = "palmhm01"; Cmp = 5; DigFormat = 0; |HAZ TomaDatos;
                     |FINSI;
                  |SINO;
                     |HAZ EsCampoJerez;
                     |SI FSalida = 0;
                        |DDEF aAlfa; |QBF aAlfa;
                        |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FC";
                           |SI #agifa704#8 = "S";
                              |SI #agifa704#2 = "FV"; aAlfa = aAlfa + "cpjz0002.mas"; |FINSI;
                              |SI #agifa704#2 = "FC"; aAlfa = aAlfa + "cpjz0001.mas"; |FINSI;
                           |SINO;
                              aAlfa = "";
                           |FINSI;
                        |SINO;
                           aAlfa = "";
                        |FINSI;
                        |SI aAlfa ! "";
                           |CARGA_DEF aAlfa, RefDato@;
                           |SI FSalida = 0;
                              |ABRE #RefDato@;
                              aAlfa = "|K001"; aAlfa = #Referen@#aAlfa#;
                              aAlfa2 = "|K000"; aAlfa2 = #RefDato@#aAlfa2#;
                              aAlfa = aAlfa % 0499; aAlfa2 = aAlfa2 % 0499;
                              |PARA; |SI aAlfa ! ""; |HACIENDO;
                                 aAlfa1 = aAlfa % 0103; aAlfa = aAlfa % 0499;
                                 aAlfa3 = aAlfa2 % 0103; aAlfa2 = aAlfa2 % 0499;
                                 |QBF aAlfa1; |QBF aAlfa3;
                                 nCalc = aAlfa1; nCalc1 = aAlfa3;
                                 |SI aAlfa3 ! "";
                                    #RefDato@#nCalc1# = #Referen@#nCalc#;
                                 |FINSI;
                              |SIGUE;
                              |LEE 000#RefDato@.=;
                              |SI FSalida = 0;
                                 Comodin = #RefDato@#3; aDepart = #RefDato@#4;
                                 aSubDep = #RefDato@#5;
                              |SINO;
                                 Comodin = ""; aDepart = ""; aSubDep = "";
                              |FINSI;
                              |CIERRA #RefDato@; |DESCARGA_DEF #RefDato@;
                           |FINSI;
                        |FINSI;
                     |FINSI;
                  |FINSI;
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;

      |SI #agifa706#16 = "F";
         |HAZ EsTaller;
         |SI FSalida = 0;
            |SI #agifa704#2 = "FV";
               |ABRE #con00004; |ABRE #con00002;
               #con00004#0 = #Referen@#29;
               #con00004#1 = #Referen@#0;
               #con00004#2 = #Referen@#2;
               |LEE 000#con00004.=;
               |SI FSalida ! 0; |DDEFECTO #con00004; |FINSI;
               #con00002#0 = #con00004#3;
               |LEE 000#con00002.=;
               |SI FSalida ! 0; |DDEFECTO #con00002; |FINSI;
               Comodin = #con00002#6;
               |CIERRA #con00004; |CIERRA #con00002;
            |FINSI;
            |SI #agifa704#2 = "FC";
               |ABRE #con00005; |ABRE #con00002;
               #con00005#0 = #Referen@#29;
               #con00005#1 = #Referen@#0;
               #con00005#2 = #Referen@#2;
               |LEE 000#con00005.=;
               |SI FSalida ! 0; |DDEFECTO #con00005; |FINSI;
               #con00002#0 = #con00005#3;
               |LEE 000#con00002.=;
               |SI FSalida ! 0; |DDEFECTO #con00002; |FINSI;
               Comodin = #con00002#6;
               |CIERRA #con00005; |CIERRA #con00002;
            |FINSI;
         |SINO;
            |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FD"; |O #agifa704#2 = "TI";
               Fich = "agifa060"; Cmp = 4; DigFormat = 0; |HAZ TomaDatos;
            |FINSI;
            |SI #agifa704#2 = "FC";
               Fich = "agifa060"; Cmp = 5; DigFormat = 0; |HAZ TomaDatos;
            |FINSI;
         |FINSI;
      |FINSI;

      aAlfa = "|NC"; aAlfa = #caenlac@#aAlfa#; nCalc = aAlfa;
      |SI nCalc ] 49;
         nCalc = 49; #caenlac@#nCalc# = aDepart;
         nCalc = 50; #caenlac@#nCalc# = aSubDep;
      |FINSI;

      |SI enSwComport = 0;
         |SI aGrupoCta = "6"; |O aGrupoCta = "7";
            #caenlac@#39 = Comodin;
            #caenlac@#40 = Comodin;
         |SINO;
            #caenlac@#39 = "";
            #caenlac@#40 = "";
         |FINSI;
      |SINO;
         |SI #agifa706#13 = "B"; |O #agifa706#13 = "b";
            #caenlac@#39 = Comodin;
            #caenlac@#40 = Comodin;
         |SINO;
            #caenlac@#39 = "";
            #caenlac@#40 = "";
         |FINSI;
      |FINSI;

      |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FC"; |O #agifa704#2 = "FD"; |O #agifa704#2 = "TI";
         |SI nCaja = 1;
            |SI #agifa704#2 = "FV";
               aCifCand = #Princip@#124; aTipoCif = "C"; |HAZ RevisaCif;
               |SI eaCif = "";
                  Fich = "agifa024"; Cmp = 15; DigFormat = 0; |HAZ TomaDatos;
                  aCifCand = Comodin; aTipoCif = "C"; |HAZ RevisaCif;
               |FINSI;

               aCodigo = #Princip@#2;
               aAlfa = eaNombre; |QBF aAlfa;
               |SI aAlfa = ""; eaNombre = #Princip@#3; |FINSI;

               || Fich = "agifa024"; Cmp = 15; DigFormat = 0; |HAZ TomaDatos; eaCif = Comodin;
               |ABRE #agifa024;
               #agifa024#0 = aCodigo;
               |LEE 000#agifa024.=;
               |SI FSalida = 0;
                  aCifCand = #agifa024#15; aTipoCif = "C"; |HAZ RevisaCif;
                  |HAZ RegNif;
               |FINSI;
               |CIERRA #agifa024;
            |FINSI;
            |SI #agifa704#2 = "FC";
               aCodigo = #Princip@#2;
               aAlfa = eaNombre; |QBF aAlfa;
               |SI aAlfa = ""; eaNombre = #Princip@#3; |FINSI;

               Fich = "agifa112"; Cmp = 9; DigFormat = 0; |HAZ TomaDatos;
               aCifCand = Comodin; aTipoCif = "P"; |HAZ RevisaCif;

               |ABRE #agifa112;
               #agifa112#0 = aCodigo;
               |LEE 000#agifa112.=;
               |SI FSalida = 0;
                  aCifCand = #agifa112#9; aTipoCif = "P"; |HAZ RevisaCif;
                  |HAZ RegNif;
               |FINSI;
               |CIERRA #agifa112;
            |FINSI;
            |SI #agifa704#2 = "FD";
               Fich = "agifa024"; Cmp = 15; DigFormat = 0; |HAZ TomaDatos;
               aCifCand = Comodin; aTipoCif = "C"; |HAZ RevisaCif;

               aCodigo = #Princip@#3;
               aAlfa = eaNombre; aAlfa = "";
               |SI aAlfa = ""; eaNombre = #Princip@#4; |FINSI;

               |ABRE #agifa024;
               #agifa024#0 = aCodigo;
               |LEE 000#agifa024.=;
               |SI FSalida = 0;
                  aCifCand = #agifa024#15; aTipoCif = "C"; |HAZ RevisaCif;
                  |HAZ RegNif;
               |FINSI;
               |CIERRA #agifa024;
            |FINSI;
            #caenlac@#43 = eaNombre;
            #caenlac@#44 = eaCif;
         |SINO;
             |SI #agifa704#2 = "FV";
                #caenlac@#43 = #Princip@#3;
                aAlfa = #Princip@#124; |QBF aAlfa;
                |ABRE #agifa024;
                #agifa024#0 = #Princip@#2;
                |LEE 000#agifa024.=;
                |SI FSalida = 0;
                    |SI aAlfa = "";
                        aAlfa = #agifa024#15;
                        aSobreIRPF = #agifa024#207;
                    |FINSI;
                    aTipoCif = "C"; |HAZ RegNif;
                |FINSI;
                |CIERRA #agifa024;
                #caenlac@#44 = aAlfa;
             |FINSI;
             |SI #agifa704#2 = "FC";
                |ABRE #agifa112;
                #agifa112#0 = #Princip@#2;
                |LEE 000#agifa112.=;
                |SI FSalida = 0;
                   #caenlac@#43 = #Princip@#3;
                   #caenlac@#44 = #agifa112#9;
                   aSobreIRPF   = #agifa112#86;
                   aTipoCif = "P"; |HAZ RegNif;
                |FINSI;
                |CIERRA #agifa112;
             |FINSI;
             |SI #agifa704#2 = "FD";
                aAlfa = #Princip@#60; |QBF aAlfa;
                |SI aAlfa ! "";
                   #caenlac@#43 = #Princip@#4;
                   #caenlac@#44 = #Princip@#60;
                |SINO;
                   #caenlac@#43 = "";
                   #caenlac@#44 = "";
                |FINSI;
                |ABRE #agifa024;
                #agifa024#0 = #Princip@#3;
                |LEE 000#agifa024.=;
                |SI FSalida = 0;
                    aTipoCif = "C"; |HAZ RegNif;
                |FINSI;
                |CIERRA #agifa024;
             |FINSI;
         |FINSI;
         |SI #agifa706#16 = "S";
            Fich = "agifa007"; Cmp = 43; DigFormat = 0; |HAZ TomaDatos;
         |FINSI;
         |SI #agifa706#16 = "A";
            |HAZ EsViarsa;
            |SI FSalida = 0;
               |DDEF aAlfa; |QBF aAlfa;
               |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FC";
                  |SI #agifa704#8 = "S";
                     |SI #agifa704#2 = "FV"; aAlfa = aAlfa + "viarsa01.mas"; |FINSI;
                     |SI #agifa704#2 = "FC"; aAlfa = aAlfa + "viarsa02.mas"; |FINSI;
                  |SINO;
                     aAlfa = "";
                  |FINSI;
               |FINSI;
               |SI #agifa704#2 = "FD"; aAlfa = aAlfa + "viarsa03.mas"; |FINSI;
               |SI aAlfa ! "";
                  |CARGA_DEF aAlfa, RefDato@;
                  |SI FSalida = 0;
                     |ABRE #RefDato@;
                     aAlfa = "|K001"; aAlfa = #Referen@#aAlfa#;
                     aAlfa2 = "|K000"; aAlfa2 = #RefDato@#aAlfa2#;
                     aAlfa = aAlfa % 0499; aAlfa2 = aAlfa2 % 0499;
                     |PARA; |SI aAlfa ! ""; |HACIENDO;
                        aAlfa1 = aAlfa % 0103; aAlfa = aAlfa % 0499;
                        aAlfa3 = aAlfa2 % 0103; aAlfa2 = aAlfa2 % 0499;
                        |QBF aAlfa1; |QBF aAlfa3;
                        nCalc = aAlfa1; nCalc1 = aAlfa3;
                        |SI aAlfa3 ! "";
                           #RefDato@#nCalc1# = #Referen@#nCalc#;
                        |FINSI;
                     |SIGUE;
                     |LEE 000#RefDato@.=;
                     |SI FSalida = 0;
                        Comodin = #RefDato@#3; aDepart = #RefDato@#4;
                        aSubDep = #RefDato@#5;
                     |SINO;
                        Comodin = ""; aDepart = ""; aSubDep = "";
                     |FINSI;
                     |CIERRA #RefDato@; |DESCARGA_DEF #RefDato@;
                  |FINSI;
               |FINSI;
            |SINO;
               |HAZ EsVipei;
               |SI FSalida = 0;
                    enSwComport = 0;
                    ||ARA
                    |DDEF aAlfa; |QBF aAlfa;
                    |SI #agifa704#2 = "FV";
                       Fich = "agifa010"; Cmp = 83; DigFormat = 0; |HAZ TomaDatos;
                       aContrato = Comodin;
                       nContrato = aContrato;

                       |DDEF aAlfa; |QBF aAlfa;
                       aAlfa = aAlfa + "vipem007.mas";
                    |FINSI;
                    |SI aAlfa ! "";
                       |CARGA_DEF aAlfa, RefDato@;
                       |SI FSalida = 0;
                          |ABRE #RefDato@;
                          #RefDato@#0 = nContrato;
                          |LEE 000#RefDato@.=;
                          |SI FSalida = 0;
                             ||A partir del tiquet. 2805/297. La cta. esta en el contrato
                             ||En el edificio, esta la configuracion de esta Cuenta.
                             enEdificio = #RefDato@#1;
                             |HAZ DameCtaAna;
                             Comodin = #RefDato@#35;
                          |SINO;
                             Comodin = "";
                          |FINSI;
                          |CIERRA #RefDato@; |DESCARGA_DEF #RefDato@;
                       |FINSI;
                    |FINSI;
               |SINO;
                  |HAZ EsForestales;
                  |SI FSalida = 0;
                     |SI #agifa704#2 = "FD";
                        Fich = "agifa084"; Cmp = 87; DigFormat = 0; |HAZ TomaDatos;
                     |FINSI;
                     |QBF Comodin;
                     Comodin = Comodin - "/";
                     |SI FSalida ! 0;
                        nCalc = ((FSalida / 100) ! 0) + 99;
                        Comodin = Comodin % nCalc;
                     |FINSI;
                     |QBF Comodin;

                     #agifa007#26 = Comodin;
                     |LEE 000#agifa007.=;
                     |SI FSalida ! 0; |DDEFECTO #agifa007; |FINSI;
                     Comodin = #agifa007#43;
                  |SINO;
                     |HAZ EsPalmHotel;
                     |SI FSalida = 0;
                        |SI #agifa704#2 = "FC";
                           Fich = "palmhm01"; Cmp = 3; DigFormat = 0; |HAZ TomaDatos;
                        |SINO;
                           Fich = "palmhm01"; Cmp = 5; DigFormat = 0; |HAZ TomaDatos;
                        |FINSI;
                     |SINO;
                        |HAZ EsConstru;
                        |SI FSalida = 0;
                           |SI #agifa704#2 = "FV";
                              |SI #agifa704#8 = "S";
                                 Fich = "agifa010"; Cmp = 83; DigFormat = 0; |HAZ TomaDatos;
                              |FINSI;
                           |FINSI;
                           |SI #agifa704#2 = "FD";
                              Fich = "agifa084"; Cmp = 87; DigFormat = 0; |HAZ TomaDatos;
                           |FINSI;
                           |QBF Comodin;
                           eaSwObra = Comodin; |HAZ MiraObra;  Comodin = eaSwObra;
                        |FINSI;
                     |FINSI;
                  |FINSI;
               |FINSI;
            |FINSI;
         |FINSI;
      |SINO;
         Fich = "agifa505"; Cmp = 166; DigFormat = 0; |HAZ TomaDatos;
      |FINSI;
      |SI enSwComport = 0;
         |SI aGrupoCta = "6"; |O aGrupoCta = "7";
            #caenlac@#39 = Comodin;
            #caenlac@#40 = Comodin;
         |SINO;
            #caenlac@#39 = "";
            #caenlac@#40 = "";
         |FINSI;
      |SINO;
         |SI #agifa706#13 = "B"; |O #agifa706#13 = "b";
            #caenlac@#39 = Comodin;
            #caenlac@#40 = Comodin;
         |SINO;
            #caenlac@#39 = "";
            #caenlac@#40 = "";
         |FINSI;
      |FINSI;
   |SINO;
      |SI #agifa704#2 = "FV";
         #caenlac@#43 = #Princip@#3;
         aAlfa = #Princip@#124; |QBF aAlfa;
         |SI aAlfa = "";
            |ABRE #agifa024;
            #agifa024#0 = #Princip@#2;
            |LEE 000#agifa024.=;
            |SI FSalida = 0;
                aTipoCif = "C"; |HAZ RegNif;
                aAlfa      = #agifa024#15;
                aSobreIRPF = #agifa024#207;
            |FINSI;
            |CIERRA #agifa024;
         |FINSI;
         #caenlac@#44 = aAlfa;
      |FINSI;
      |SI #agifa704#2 = "FC";
         |ABRE #agifa112;
         #agifa112#0 = #Princip@#2;
         |LEE 000#agifa112.=;
         |SI FSalida = 0;
            aTipoCif = "P"; |HAZ RegNif;
            #caenlac@#43 = #Princip@#3;
            #caenlac@#44 = #agifa112#9;
            aSobreIRPF   = #agifa112#86;
         |FINSI;
         |CIERRA #agifa112;
      |FINSI;
      |SI #agifa704#2 = "FD";
         aAlfa = #Princip@#60; |QBF aAlfa;
         |SI aAlfa ! "";
            #caenlac@#43 = #Princip@#4;
            #caenlac@#44 = #Princip@#60;
         |SINO;
            #caenlac@#43 = "";
            #caenlac@#44 = "";
         |FINSI;
         |ABRE #agifa024;
         #agifa024#0 = #Princip@#3;
         |LEE 000#agifa024.=;
         |SI FSalida = 0;
            aTipoCif = "C"; |HAZ RegNif;
         |FINSI;
         |CIERRA #agifa024;
      |FINSI;

      |SI #agifa706#16 = "S";
         Fich = "agifa007"; Cmp = 43; DigFormat = 0; |HAZ TomaDatos;
      |FINSI;

      |SI #agifa706#16 = "C";
         |SI #agifa704#2 = "CC";
            Fich = "agifa505"; Cmp = 166; DigFormat = 0; |HAZ TomaDatos;
         |FINSI;
      |FINSI;

      |SI enSwComport = 0;
         |SI aGrupoCta = "6"; |O aGrupoCta = "7";
            #caenlac@#39 = Comodin;
            #caenlac@#40 = Comodin;
         |SINO;
            #caenlac@#39 = "";
            #caenlac@#40 = "";
         |FINSI;
      |SINO;
         |SI #agifa706#13 = "B"; |O #agifa706#13 = "b";
            #caenlac@#39 = Comodin;
            #caenlac@#40 = Comodin;
         |SINO;
            #caenlac@#39 = "";
            #caenlac@#40 = "";
         |FINSI;
      |FINSI;
   |FINSI;

   |SI #agifa706#7 = "S";
      nDiario = #caenlac@#0;
      Fecha   = #caenlac@#1;
      nDocum  = #caenlac@#2;
      aCtaAn  = #caenlac@#39;
      nCalc = NumApunte; |SI nMaxApunte < nCalc; nMaxApunte = nCalc; |FINSI;
      |SI #agifa704#7 = "N";
         |SELECT #3#caenlac@;
      |SINO;
         |SELECT #2#caenlac@;
      |FINSI;
      |QBF Cuenta; Cuenta = (Cuenta + (" " * 12)) % 0112;
      Salir = 0; nSwitch = 0;
      |SI #agifa704#8 = "N";
         nEmpr1 = #caenlac@#37;
         nPeri1 = #caenlac@#38;
         #caenlac@#4 = Cuenta;
         |LEE 000#caenlac@.];
         |PARA; |SI FSalida = 0; |Y #caenlac@#4 = Cuenta; |HACIENDO;
            |SI #caenlac@#26 = #agifa706#13; |Y #caenlac@#27 = #agifa706#14;
             |Y nDiario = #caenlac@#0; |Y nDocum  = #caenlac@#2; |Y aCtaAn  = #caenlac@#39;
             |Y #caenlac@#37 = nEmpr1; |Y #caenlac@#38 = nPeri1;
               Salir = 1; nSwitch = 1;
               nDiario = #caenlac@#0; Fecha   = #caenlac@#1;
               nDocum  = #caenlac@#2; nApunt  = #caenlac@#3;
               aCtaAn  = #caenlac@#39;
               nEmpr1 = #caenlac@#37; nPeri1 = #caenlac@#38;
               |SAL;
            |FINSI;
            |LEE 000#caenlac@.s;
         |SIGUE;
         |SELECT #1#caenlac@;
         |SI Salir = 0;
            #caenlac@#0  = nDiario;
            #caenlac@#1  = Fecha;
            #caenlac@#2  = nDocum;
            #caenlac@#37 = nEmpr1;
            #caenlac@#38 = nPeri1;
            #caenlac@#39 = aCtaAn;
            #caenlac@#40 = aCtaAn;
         |FINSI;
         |LEE 000#caenlac@.=;
         #caenlac@#25 = "N";
      |SINO;
         nSwitch1 = 0;
         nEmpr1 = #caenlac@#37;
         nPeri1 = #caenlac@#38;
         #caenlac@#4 = Cuenta;
         |LEE 000#caenlac@.];
         |PARA; |SI FSalida = 0; |Y #caenlac@#4 = Cuenta; |HACIENDO;
            || nSwitch1 = 1; ABDON
            Fich = "agifa066"; Cmp = 2; DigFormat = 0; |HAZ TomaDatos; nCalc = Comodin;
            |SI #agifa706#13 = "D";
               |SI #caenlac@#26 = #agifa706#13; |Y nDiario = #caenlac@#0;
                |Y nDocum  = #caenlac@#2; |Y aCtaAn  = #caenlac@#39;
                |Y #caenlac@#37 = nEmpr1; |Y #caenlac@#38 = nPeri1;
                   |SI #agifa704#7 = "S";
                      |SI #caenlac@#12 = CmpClave1Cab; |Y #caenlac@#13 = CmpClave2Cab; |Y #caenlac@#8 = #agifa706#4;
                         Salir = 1; nSwitch = 1;
                         nDiario = #caenlac@#0; Fecha   = #caenlac@#1;
                         nDocum  = #caenlac@#2; nApunt  = #caenlac@#3;
                         aCtaAn  = #caenlac@#39;
                         |SAL;
                      |FINSI;
                   |SINO;
                      Salir = 1; nSwitch = 1;
                      nDiario = #caenlac@#0; Fecha   = #caenlac@#1;
                      nDocum  = #caenlac@#2; nApunt  = #caenlac@#3;
                      aCtaAn  = #caenlac@#39;
                      |SAL;
                   |FINSI;
               |FINSI;
            |SINO;
               |SI #caenlac@#26 = #agifa706#13; |Y nCalc = #caenlac@#28;
                |Y nDiario = #caenlac@#0; |Y nDocum  = #caenlac@#2; |Y aCtaAn  = #caenlac@#39;
                |Y #caenlac@#37 = nEmpr1; |Y #caenlac@#38 = nPeri1;
                   |SI #agifa704#7 = "S";
                      |SI #caenlac@#12 = CmpClave1Cab; |Y #caenlac@#13 = CmpClave2Cab; |Y #caenlac@#8 = #agifa706#4;
                         Salir = 1; nSwitch = 1;
                         nDiario = #caenlac@#0; Fecha   = #caenlac@#1;
                         nDocum  = #caenlac@#2; nApunt  = #caenlac@#3;
                         aCtaAn  = #caenlac@#39;
                         |SAL;
                      |FINSI;
                   |SINO;
                      Salir = 1; nSwitch = 1;
                      nDiario = #caenlac@#0; Fecha   = #caenlac@#1;
                      nDocum  = #caenlac@#2; nApunt  = #caenlac@#3;
                      aCtaAn  = #caenlac@#39;
                      |SAL;
                   |FINSI;
               |FINSI;
            |FINSI;
            |LEE 000#caenlac@.s;
         |SIGUE;
         |SELECT #1#caenlac@;
         #caenlac@#0 = nDiario;
         #caenlac@#1 = Fecha;
         #caenlac@#2 = nDocum;
         #caenlac@#37 = nEmpr1;
         #caenlac@#38 = nPeri1;
         #caenlac@#39 = aCtaAn;
         #caenlac@#40 = aCtaAn;
         |SI nSwitch1 = 0; NumApunte = nMaxApunte; |FINSI;
         |SI Salir = 1;
            |LEE 000#caenlac@.=
         |FINSI;
         #caenlac@#25 = "N";
      |FINSI;

      |SI Salir = 1;
         #caenlac@#7 = Descr;
         #caenlac@#9 = #caenlac@#9 + nImporte;
         |SI #caenlac@#26 = "P"; |O #caenlac@#26 = "p";
             nCalc = (#caenlac@#9 * 100) / #caenlac@#41;
             #caenlac@#42 = nCalc;
           || |SI aSobreIRPF = "B";
           ||     #caenlac@#42 = ???
           || |SINO;
           ||     #caenlac@#42 = ???
           || |FINSI;
         |FINSI;
         |SI #caenlac@#26 = "B"; |O #caenlac@#26 = "b";
            |SI #agifa704#8 = "S";
               |HAZ GestionaPorVar;
            |FINSI;
         |FINSI;
         |SI #agifa706#12 = "N";
            |SI NVuelta = 1;
               |HAZ EsJamaica;
               |SI FSalida = 0;
                  NumApunte = #caenlac@#3 + 1;
               |SINO;
                  |HAZ EsCompaq;
                  |SI FSalida = 0;
                     NumApunte = #caenlac@#3 + 1;
                  |SINO;
                     |HAZ EsMarcosJi;
                     |SI FSalida = 0;
                        NumApunte = #caenlac@#3 + 1;
                     |SINO;
                        |HAZ EsPalmHotel;
                        |SI FSalida = 0;
                           NumApunte = #caenlac@#3 + 1;
                        |SINO;
                           |HAZ EsInforAlba;
                           |SI FSalida = 0;
                              NumApunte = #caenlac@#3 + 1;
                           |SINO;
                              NumApunte = #caenlac@#3 + enIncLin;
                           |FINSI;
                        |FINSI;
                     |FINSI;
                  |FINSI;
               |FINSI;
               |SI nSwErrCta = 1;
                  eaTipoAviso = "A";
                  eaAviso = "[" + #caenlac@#12 + "/" + (("000000" + #caenlac@#13) % -106) + "] El apunte ";
                  eaAviso = eaAviso + (("00" + #caenlac@#0) % -102) + "/" + #caenlac@#1 + "/";
                  eaAviso = eaAviso + (("00000" + #caenlac@#2) % -105) + "/";
                  eaAviso = eaAviso + (("0000" + #caenlac@#3) % -104) ;
                  eaAviso = eaAviso + " tenia la cuenta en blanco y se ha reemplazado.";
                  |HAZ AnadeAviso;
               |FINSI;
               #caenlac@#48 = #agifa704#19;
               |GRABA 020#caenlac@.a; ||LEE 010#caenlac@.=; |LIBERA #caenlac@;
               |HAZ GraTmpCuadre;
               |SI #agifa706#4 = "D";
                  nImpCuadre = nImpCuadre + (nImporte ! 2);
               |SINO;
                  nImpCuadre = nImpCuadre - (nImporte ! 2);
               |FINSI;
               |HAZ GuardaParaCuadre;
            |FINSI;
         |SINO;
            |HAZ EsJamaica;
            |SI FSalida = 0;
               NumApunte = #caenlac@#3 + 1;
            |SINO;
               |HAZ EsCompaq;
               |SI FSalida = 0;
                  NumApunte = #caenlac@#3 + 1;
               |SINO;
                  |HAZ EsMarcosJi;
                  |SI FSalida = 0;
                     NumApunte = #caenlac@#3 + 1;
                  |SINO;
                     |HAZ EsPalmHotel;
                     |SI FSalida = 0;
                        NumApunte = #caenlac@#3 + 1;
                     |SINO;
                        |HAZ EsInforAlba;
                        |SI FSalida = 0;
                           NumApunte = #caenlac@#3 + 1;
                        |SINO;
                           NumApunte = #caenlac@#3 + enIncLin;
                        |FINSI;
                     |FINSI;
                  |FINSI;
               |FINSI;
            |FINSI;
            |SI nSwErrCta = 1;
               eaTipoAviso = "A";
               eaAviso = "[" + #caenlac@#12 + "/" + (("000000" + #caenlac@#13) % -106) + "] El apunte ";
               eaAviso = eaAviso + (("00" + #caenlac@#0) % -102) + "/" + #caenlac@#1 + "/";
               eaAviso = eaAviso + (("00000" + #caenlac@#2) % -105) + "/";
               eaAviso = eaAviso + (("0000" + #caenlac@#3) % -104) ;
               eaAviso = eaAviso + " tenia la cuenta en blanco y se ha reemplazado.";
               |HAZ AnadeAviso;
            |FINSI;
            #caenlac@#48 = #agifa704#19;
            |GRABA 020#caenlac@.a; |LEE 010#caenlac@.=; |LIBERA #caenlac@;
            |HAZ GraTmpCuadre;
            |SI #agifa706#4 = "D";
               nImpCuadre = nImpCuadre + (nImporte ! 2);
            |SINO;
               nImpCuadre = nImpCuadre - (nImporte ! 2);
            |FINSI;
            |HAZ GuardaParaCuadre;
         |FINSI;
      |SINO;
         #caenlac@#3  = NumApunte;
         |HAZ EsJamaica;
         |SI FSalida = 0;
            NumApunte = NumApunte + 1;
         |SINO;
            |HAZ EsCompaq;
            |SI FSalida = 0;
               NumApunte = NumApunte + 1;
            |SINO;
               |HAZ EsMarcosJi;
               |SI FSalida = 0;
                  NumApunte = NumApunte + 1;
               |SINO;
                  |HAZ EsPalmHotel;
                  |SI FSalida = 0;
                     NumApunte = NumApunte + 1;
                  |SINO;
                     |HAZ EsInforAlba;
                     |SI FSalida = 0;
                        NumApunte = NumApunte + 1;
                     |SINO;
                        NumApunte = NumApunte + enIncLin;
                     |FINSI;
                  |FINSI;
               |FINSI;
            |FINSI;
         |FINSI;
         #caenlac@#4 = Cuenta;
         #caenlac@#5 = Nivel;
         #caenlac@#6 = #agifa706#5;
         #caenlac@#7 = Descr;
         #caenlac@#8 = #agifa706#4;
         #caenlac@#9 = nImporte;
         #caenlac@#39 = aCtaAn;
         #caenlac@#40 = aCtaAn;
         |SI #agifa704#2 = "FC";
            aAlfa = "|NC"; aAlfa = #caenlac@#aAlfa#; nCalc = aAlfa;
            |SI nCalc ] 46;
               nCalc = 45; #caenlac@#nCalc# = #Princip@#74;
            |FINSI;
         |FINSI;

         |SI #agifa704#2 = "FV"; |Y ConIva = 1; #caenlac@#10 = "R"; |FINSI;
         |SI #agifa704#2 = "FC"; |Y ConIva = 1; #caenlac@#10 = "S"; |FINSI;
         |SI #agifa704#2 = "FD"; |Y ConIva = 1; #caenlac@#10 = "R"; |FINSI;
         |SI #agifa704#2 = "TI"; |Y ConIva = 1; #caenlac@#10 = "R"; |FINSI;
         |SI #agifa704#2 = "CC"; |Y ConIva = 1; #caenlac@#10 = "R"; |FINSI;
         |SI #agifa704#2 = "CR"; |Y ConIva = 1; #caenlac@#10 = "R"; |FINSI;
         |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
            ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
            IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
            IFichCab      = FichCab1<-;      IFichCab      = IFichCab      + Cont;
            IFechas       = Fechas1<-;       IFechas       = IFechas       + Cont;
            ISer          = Ser1<-;          ISer          = ISer          + Cont;
            ITipoIva      = TipoIva1<-;      ITipoIva      = ITipoIva      + Cont;
            |SI #agifa704#2 = TiposEnlaces; #agifa715#0 = Ficheros; |SAL; |FINSI;
         |SIGUE;
         |SI ConIva = 1;
            #caenlac@#11 = #agifa711#6;
            aAlfa = Ficheros; |QBF aAlfa;
            |SI aAlfa = "agifa071";
               Fich = "agifa010"; Cmp = 53; DigFormat = 5; |HAZ TomaDatos; #caenlac@#12 = Comodin;
               Fich = "agifa010"; Cmp = 39; DigFormat = 6; |HAZ TomaDatos; #caenlac@#13 = Comodin;
            |SINO;
               Fich = Ficheros; Cmp = Campo1Clave; DigFormat = 5;  |HAZ TomaDatos; #caenlac@#12 = Comodin;
               Fich = Ficheros; Cmp = Campo2Clave; DigFormat = 6;  |HAZ TomaDatos; #caenlac@#13 = Comodin;
            |FINSI;
            |SI #agifa704#2 = "CC";
               #caenlac@#12 = "  "; #caenlac@#13 = -1;
            |FINSI;
            ||SI #agifa704#2 = "TI"; #caenlac@#13 = -1; |FINSI;
            #caenlac@#34 = #agifa704#10;
            #caenlac@#35 = #agifa704#11;
            #caenlac@#36 = 0;
         |FINSI;

         aAlfa = "|NC"; aAlfa = #caenlac@#aAlfa#; Calc = aAlfa;
         |SI Calc > 46;
            aAlfa = Ficheros; |QBF aAlfa;
            |SI aAlfa = "agifa071";
               Fich = "agifa010"; Cmp = 53; DigFormat = 5; |HAZ TomaDatos; #caenlac@#46 = Comodin;
               Fich = "agifa010"; Cmp = 39; DigFormat = 6; |HAZ TomaDatos; #caenlac@#47 = Comodin;
            |SINO;
               Fich = Ficheros; Cmp = Campo1Clave; DigFormat = 5;  |HAZ TomaDatos; #caenlac@#46 = Comodin;
               Fich = Ficheros; Cmp = Campo2Clave; DigFormat = 6;  |HAZ TomaDatos; #caenlac@#47 = Comodin;
            |FINSI;
         |FINSI;
         Fich = FichCab;  Cmp = Fechas; DigFormat = 0;  |HAZ TomaDatos; #caenlac@#29 = Comodin;
         |HAZ FormatoFechas;

         |SI Fich = "agifa134";
            Cmp = 99;  DigFormat = 0; |HAZ TomaDatos; TotalIva = Comodin;
            Cmp = 100; DigFormat = 0; |HAZ TomaDatos; TotalRec = Comodin;
         |FINSI;
         |SI Fich = "agifa079";
            Cmp = 116; DigFormat = 0; |HAZ TomaDatos; TotalIva = Comodin;
            Cmp = 117; DigFormat = 0; |HAZ TomaDatos; TotalRec = Comodin;
         |FINSI;
         |SI Fich = "agifa084";
            Cmp = 17; DigFormat = 0; |HAZ TomaDatos; TotalIva = Comodin;
            Cmp = 20; DigFormat = 0; |HAZ TomaDatos; TotalIva = TotalIva + Comodin;
            Cmp = 23; DigFormat = 0; |HAZ TomaDatos; TotalIva = TotalIva + Comodin;
            Cmp = 43; DigFormat = 0; |HAZ TomaDatos; TotalIva = TotalIva + Comodin;
            Cmp = 46; DigFormat = 0; |HAZ TomaDatos; TotalIva = TotalIva + Comodin;
            Cmp = 18; DigFormat = 0; |HAZ TomaDatos; TotalRec = Comodin;
            Cmp = 21; DigFormat = 0; |HAZ TomaDatos; TotalRec = TotalRec + Comodin;
            Cmp = 49; DigFormat = 0; |HAZ TomaDatos; TotalRec = TotalRec + Comodin;
            Cmp = 44; DigFormat = 0; |HAZ TomaDatos; TotalRec = TotalRec + Comodin;
            Cmp = 47; DigFormat = 0; |HAZ TomaDatos; TotalRec = TotalRec + Comodin;
         |FINSI;
         |SI Fich = "agifa501";
            Cmp = 21; DigFormat = 0; |HAZ TomaDatos; TotalIva = Comodin;
            Cmp = 24; DigFormat = 0; |HAZ TomaDatos; TotalIva = TotalIva + Comodin;
            Cmp = 27; DigFormat = 0; |HAZ TomaDatos; TotalIva = TotalIva + Comodin;
            Cmp = 49; DigFormat = 0; |HAZ TomaDatos; TotalIva = TotalIva + Comodin;
            Cmp = 52; DigFormat = 0; |HAZ TomaDatos; TotalIva = TotalIva + Comodin;
            Cmp = 22; DigFormat = 0; |HAZ TomaDatos; TotalRec = Comodin;
            Cmp = 25; DigFormat = 0; |HAZ TomaDatos; TotalRec = TotalRec + Comodin;
            Cmp = 47; DigFormat = 0; |HAZ TomaDatos; TotalRec = TotalRec + Comodin;
            Cmp = 50; DigFormat = 0; |HAZ TomaDatos; TotalRec = TotalRec + Comodin;
            Cmp = 53; DigFormat = 0; |HAZ TomaDatos; TotalRec = TotalRec + Comodin;
         |FINSI;
         |SI Fich = "agifa509";
            Cmp = 25; DigFormat = 0; |HAZ TomaDatos; TotalIva = Comodin;
            Cmp = 26; DigFormat = 0; |HAZ TomaDatos; TotalRec = Comodin;
         |FINSI;

         |SI #agifa704#21 ! "  ";
             Depart = #agifa704#21;
         |SINO;
             Depart = #agifa706#15;
             aLong  = Depart % 0; nLong = aLong;

             |PARA nCont = 1; |SI nCont [ nLong; |HACIENDO nCont = nCont + 1;
                   Calc = (nCont * 100) + 1;
                   Caracter = Depart % Calc;
                   |SI Caracter = "[";
                       Calc1 = Calc + 100; Caracter = Depart % Calc1;
                       |SI Caracter = "%";
                           Calc1 = Calc1 + 100; aAlfa = Depart % Calc1;
                           |SI aAlfa = "-";
                               Calc1 = Calc + 18;
                           |SINO;
                               Calc1 = Calc + 17;
                           |FINSI;
                           Cadena = Depart % Calc1; Depart = Depart - Cadena;
                           |SI aAlfa = "-";
                               aLong = Cadena % 0402;
                               DigFormat = 0 - aLong;
                               Fich  = Cadena % 0608; Cmp   = Cadena % 1603;
                           |SINO;
                               aLong = Cadena % 0302;
                               DigFormat = aLong;
                               Fich  = Cadena % 0508; Cmp   = Cadena % 1503;
                           |FINSI;

                           |HAZ TomaDatos;
                       |SINO;
                           Calc1 = Calc + 14;
                           Cadena = Depart % Calc1; Depart = Depart - Cadena;
                           DigFormat = 0;
                           Fich  = Cadena % 0208; Cmp   = Cadena % 1203;

                          |HAZ TomaDatos;
                       |FINSI;

                       Calc1 = 100 + (nCont - 1);
                       Cadena = Depart % Calc1; Depart = Depart - Cadena;
                       Depart = Cadena + Comodin + Depart;
                       nCont = nCont - 1;
                   |FINSI;
             |SIGUE;
         |FINSI;
         #caenlac@#15 = Depart;
         #caenlac@#17 = 0; #caenlac@#18 = "";
         Comodin = Usuario % 0810;
         #caenlac@#19 = Comodin;
         #caenlac@#24 = #agifa704#2;
         #caenlac@#26 = #agifa706#13;
         |SI #caenlac@#26 = "D"; |O #caenlac@#26 = "d";
            |SI #agifa706#14 = 0;
               nHayDto = #caenlac@#3; nImpDto = #caenlac@#9;
            |SINO;
               #caenlac@#27 = #agifa706#14;
            |FINSI;
         |FINSI;
         |SI #caenlac@#26 = " "; |O #caenlac@#26 = "F"; |O #caenlac@#26 = "f"; #caenlac@#27 = 0; |FINSI;
         |SI #agifa704#8 = "S";
            |SI #caenlac@#26 = "I";
              |SI #agifa706#12 = "S";
                 Calc = TipoIva; #caenlac@#27 = #Referen@#Calc#;
              |SINO;
                 #caenlac@#27 = #agifa706#14;
              |FINSI;
            |SINO;
               |SI #agifa706#12 = "S"; |O #agifa706#7 = "N";
                  Calc = TipoIva; #caenlac@#27 = #Referen@#Calc#;
               |FINSI;
            |FINSI;
         |SINO;
            |SI #agifa706#14 = 0; |Y #caenlac@#26 ! "F"; |Y #caenlac@#26 ! "f";
               |SI #caenlac@#26 = "B"; |O #caenlac@#26 = "b";
                  #caenlac@#27 = NumBase; NumBase = NumBase + 1;
               |FINSI;
            |SINO;
               #caenlac@#27 = #agifa706#14;
            |FINSI;
         |FINSI;

         aAlfa = #agifa704#6; |QBF aAlfa;
         aAlfa = aAlfa - "contagen";
         |SI FSalida ! 0;
            ||SI #caenlac@#26 = "D"; |O #caenlac@#26 = "d";  #caenlac@#27 = 99; |FINSI;
         |SINO;
            |SI #caenlac@#27 = 0;
               |SI #agifa706#14 ! 0; #caenlac@#27 = #agifa706#14; |FINSI;
            |FINSI;
            ||#caenlac@#27 = #agifa706#14;
         |FINSI;

         |SI #caenlac@#26 = "I"; |O #caenlac@#26 = "i";
            |SI #agifa704#8 = "N"; #caenlac@#28 = -1; |FINSI;
         |FINSI;

         |SI #caenlac@#26 = "B"; |O #caenlac@#26 = "b";
            |SI #agifa704#8 = "S";
               |HAZ GestionaPorVar;
               |SI nSwTipo = 0;
                  |SI TotalIva ! 0;
                     Fich = "agifa066"; Cmp = 2; DigFormat = 0;
                     |HAZ TomaDatos;
                     #caenlac@#28 = Comodin;
                  |FINSI;
                  |SI TotalRec ! 0;
                     Fich = "agifa066"; Cmp = 3; DigFormat = 0;
                     |HAZ TomaDatos;
                     #caenlac@#33 = Comodin;
                  |FINSI;
               |FINSI;
            |SINO;
               || ABDON 27/02/2012   Tiquet 003068/00504
               || Esto es suficiente ya que puedo obtener el tipo de iva
               ||     teniendo la base y la cuota. El problema viene cuando
               ||     la base es muy peque¤a. Los importes vienen redondeados
               ||     por los campos y cuando la base es muy peque¤a hay varios
               ||     porcentajes que coinciden con la cuota. En este caso hay
               ||     que pasar el tipo de iva de la base.
               |SI #caenlac@#9 < 0.5; |Y #caenlac@#9 > 0; |Y #caenlac@#27 > 0; |Y #caenlac@#27 < 6;
                  #caenlac@#28 = -1; #caenlac@#33 = -1;
                  |SI #agifa704#2 = "FV";
                     || Compruebo que hay cuota de iva
                     Fich = "agifa134";
                     |SI #caenlac@#27 = 1; Cmp = 22; |FINSI;
                     |SI #caenlac@#27 = 2; Cmp = 25; |FINSI;
                     |SI #caenlac@#27 = 3; Cmp = 28; |FINSI;
                     |SI #caenlac@#27 = 4; Cmp = 34; |FINSI;
                     |SI #caenlac@#27 = 5; Cmp = 37; |FINSI;
                     DigFormat = 0; |HAZ TomaDatos;
                     |SI Comodin ! 0;
                        Fich = "agifa134";
                        |SI #caenlac@#27 = 1; Cmp = 39; |FINSI;
                        |SI #caenlac@#27 = 2; Cmp = 41; |FINSI;
                        |SI #caenlac@#27 = 3; Cmp = 43; |FINSI;
                        |SI #caenlac@#27 = 4; Cmp = 50; |FINSI;
                        |SI #caenlac@#27 = 5; Cmp = 52; |FINSI;
                        DigFormat = 0; |HAZ TomaDatos; #caenlac@#28 = Comodin;
                     |FINSI;
                     || Compruebo que hay cuota de recargo
                     Fich = "agifa134";
                     |SI #caenlac@#27 = 1; Cmp = 23; |FINSI;
                     |SI #caenlac@#27 = 2; Cmp = 26; |FINSI;
                     |SI #caenlac@#27 = 3; Cmp = 54; |FINSI;
                     |SI #caenlac@#27 = 4; Cmp = 35; |FINSI;
                     |SI #caenlac@#27 = 5; Cmp = 38; |FINSI;
                     DigFormat = 0; |HAZ TomaDatos;
                     |SI Comodin ! 0;
                        Fich = "agifa134";
                        |SI #caenlac@#27 = 1; Cmp = 40; |FINSI;
                        |SI #caenlac@#27 = 2; Cmp = 42; |FINSI;
                        |SI #caenlac@#27 = 3; Cmp = 44; |FINSI;
                        |SI #caenlac@#27 = 4; Cmp = 51; |FINSI;
                        |SI #caenlac@#27 = 5; Cmp = 53; |FINSI;
                        DigFormat = 0;
                        |HAZ TomaDatos;
                        #caenlac@#33 = Comodin;
                     |FINSI;
                  |FINSI;
                  |SI #agifa704#2 = "FD";
                     || Compruebo que hay cuota de iva
                     Fich = "agifa084";
                     |SI #caenlac@#27 = 1; Cmp = 17; |FINSI;
                     |SI #caenlac@#27 = 2; Cmp = 20; |FINSI;
                     |SI #caenlac@#27 = 3; Cmp = 23; |FINSI;
                     |SI #caenlac@#27 = 4; Cmp = 43; |FINSI;
                     |SI #caenlac@#27 = 5; Cmp = 46; |FINSI;
                     DigFormat = 0; |HAZ TomaDatos;
                     |SI Comodin ! 0;
                        Fich = "agifa084";
                        |SI #caenlac@#27 = 1; Cmp = 50; |FINSI;
                        |SI #caenlac@#27 = 2; Cmp = 52; |FINSI;
                        |SI #caenlac@#27 = 3; Cmp = 54; |FINSI;
                        |SI #caenlac@#27 = 4; Cmp = 56; |FINSI;
                        |SI #caenlac@#27 = 5; Cmp = 58; |FINSI;
                        DigFormat = 0; |HAZ TomaDatos; #caenlac@#28 = Comodin;
                     |FINSI;
                     || Compruebo que hay cuota de recargo
                     Fich = "agifa084";
                     |SI #caenlac@#27 = 1; Cmp = 18; |FINSI;
                     |SI #caenlac@#27 = 2; Cmp = 21; |FINSI;
                     |SI #caenlac@#27 = 3; Cmp = 49; |FINSI;
                     |SI #caenlac@#27 = 4; Cmp = 44; |FINSI;
                     |SI #caenlac@#27 = 5; Cmp = 47; |FINSI;
                     DigFormat = 0; |HAZ TomaDatos;
                     |SI Comodin ! 0;
                        Fich = "agifa084";
                        |SI #caenlac@#27 = 1; Cmp = 50; |FINSI;
                        |SI #caenlac@#27 = 2; Cmp = 52; |FINSI;
                        |SI #caenlac@#27 = 3; Cmp = 54; |FINSI;
                        |SI #caenlac@#27 = 4; Cmp = 56; |FINSI;
                        |SI #caenlac@#27 = 5; Cmp = 58; |FINSI;
                        DigFormat = 0;
                        |HAZ TomaDatos;
                        #caenlac@#33 = Comodin;
                     |FINSI;
                  |FINSI;
                  |SI #agifa704#2 = "FC";
                     || Compruebo que hay cuota de iva
                     Fich = "agifa079";
                     |SI #caenlac@#27 = 1; Cmp = 22; |FINSI;
                     |SI #caenlac@#27 = 2; Cmp = 25; |FINSI;
                     |SI #caenlac@#27 = 3; Cmp = 28; |FINSI;
                     |SI #caenlac@#27 = 4; Cmp = 50; |FINSI;
                     |SI #caenlac@#27 = 5; Cmp = 53; |FINSI;
                     DigFormat = 0; |HAZ TomaDatos;
                     |SI Comodin ! 0;
                        Fich = "agifa079";
                        |SI #caenlac@#27 = 1; Cmp = 56; |FINSI;
                        |SI #caenlac@#27 = 2; Cmp = 58; |FINSI;
                        |SI #caenlac@#27 = 3; Cmp = 60; |FINSI;
                        |SI #caenlac@#27 = 4; Cmp = 62; |FINSI;
                        |SI #caenlac@#27 = 5; Cmp = 64; |FINSI;
                        DigFormat = 0; |HAZ TomaDatos; #caenlac@#28 = Comodin;
                     |FINSI;
                     || Compruebo que hay cuota de recargo
                     Fich = "agifa079";
                     |SI #caenlac@#27 = 1; Cmp = 23; |FINSI;
                     |SI #caenlac@#27 = 2; Cmp = 26; |FINSI;
                     |SI #caenlac@#27 = 3; Cmp = 55; |FINSI;
                     |SI #caenlac@#27 = 4; Cmp = 51; |FINSI;
                     |SI #caenlac@#27 = 5; Cmp = 54; |FINSI;
                     DigFormat = 0; |HAZ TomaDatos;
                     |SI Comodin ! 0;
                        Fich = "agifa079";
                        |SI #caenlac@#27 = 1; Cmp = 57; |FINSI;
                        |SI #caenlac@#27 = 2; Cmp = 59; |FINSI;
                        |SI #caenlac@#27 = 3; Cmp = 61; |FINSI;
                        |SI #caenlac@#27 = 4; Cmp = 63; |FINSI;
                        |SI #caenlac@#27 = 5; Cmp = 65; |FINSI;
                        DigFormat = 0;
                        |HAZ TomaDatos;
                        #caenlac@#33 = Comodin;
                     |FINSI;
                  |FINSI;
               || FIN ABDON 27/02/2012   Tiquet 003068/00504
               |SINO;
                  #caenlac@#28 = -1; #caenlac@#33 = -1;
               |FINSI;
            |FINSI;
         |FINSI;
         |SI #caenlac@#26 = "P"; |O #caenlac@#26 = "p";
            |SI #agifa704#2 = "FC";
               || ABDON  11/06/2013     Tiquet 003042/00785
               || Antes se hacia asi porque no existian los campos % de IRPF en la factura ni
               ||    el albaran. Ahora que si existen, lo cambio para que los coja de ahí
               || Fich = "agifa112"; Cmp = 78; DigFormat = 0; |HAZ TomaDatos; #caenlac@#41 = Comodin;
               |SI FichCab = "agifa079";
                    #caenlac@#41 = #Princip@#144;
                    nBruto = #Princip@#105;
                    nNeto  = #Princip@#105 + #Princip@#116;
               |FINSI;
               |SI FichCab = "agifa077";
                    #caenlac@#41 = #Princip@#52;
                    nBruto = #Princip@#65;
                    nNeto  = #Princip@#66;
               |FINSI;

               || nCalc = (#caenlac@#9 * 100) / #caenlac@#41;
               || #caenlac@#42 = nCalc;
               |SI #caenlac@#41 ! 0;
                   |SI aSobreIRPF = "B";
                       #caenlac@#42 = nBruto;
                   |SINO;
                       #caenlac@#42 = nNeto;
                   |FINSI;
               |FINSI;
            |FINSI;

            |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FD";
               Fich = "agifa024"; Cmp = 206; DigFormat = 0; |HAZ TomaDatos;
               #caenlac@#41 = Comodin;
               |SI FichCab = "agifa134";
                    #caenlac@#41 = #Princip@#122;
                    nBruto       = #Princip@#88;
                    nNeto        = #Princip@#88 + #Princip@#99;
               |FINSI;
               || nCalc = (#caenlac@#9 * 100) / #caenlac@#41;
               || #caenlac@#42 = nCalc;
               |SI #caenlac@#41 ! 0;
                   |SI aSobreIRPF = "B";
                       #caenlac@#42 = nBruto;
                   |SINO;
                       #caenlac@#42 = nNeto;
                   |FINSI;
               |FINSI;
            |FINSI;
         |FINSI;

         |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
            ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
            IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
            ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
            ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
            ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
            |SI #agifa704#2 = TiposEnlaces;
               Comodin = Campo1Clave; |QBF Comodin; #caenlac@#21 = Comodin;
               Comodin = Campo2Clave; |QBF Comodin; #caenlac@#22 = Comodin;
               Comodin = Campo3Clave; |QBF Comodin; #caenlac@#23 = Comodin;
               |SAL;
            |FINSI;
         |SIGUE;

         #agifa007#26 = #caenlac@#12;
         |LEE 000#agifa007.=;
         |SI FSalida = 0;
            #caenlac@#30 = #agifa007#40;
         |FINSI;
         |SI #agifa706#12 = "N";
            |SI NVuelta = 1;
               |SI nSwErrCta = 1;
                  eaTipoAviso = "A";
                  eaAviso = "[" + #caenlac@#12 + "/" + (("000000" + #caenlac@#13) % -106) + "] El apunte ";
                  eaAviso = eaAviso + (("00" + #caenlac@#0) % -102) + "/" + #caenlac@#1 + "/";
                  eaAviso = eaAviso + (("00000" + #caenlac@#2) % -105) + "/";
                  eaAviso = eaAviso + (("0000" + #caenlac@#3) % -104) ;
                  eaAviso = eaAviso + " tenia la cuenta en blanco y se ha reemplazado.";
                  |HAZ AnadeAviso;
               |FINSI;
               #caenlac@#48 = #agifa704#19;
               |HAZ MiraRectif;
               |SI nSwitch = 0;
                  |GRABA 020#caenlac@.c;
               |SINO;
                  |GRABA 020#caenlac@.a;
               |FINSI;
               |LIBERA #caenlac@;
               |HAZ GraTmpCuadre;
               |SI #agifa706#4 = "D";
                  nImpCuadre = nImpCuadre + (nImporte ! 2);
               |SINO;
                 nImpCuadre = nImpCuadre - (nImporte ! 2);
               |FINSI;
               |HAZ GuardaParaCuadre;
            |FINSI;
         |SINO;
            |SI nSwErrCta = 1;
               eaTipoAviso = "A";
               eaAviso = "[" + #caenlac@#12 + "/" + (("000000" + #caenlac@#13) % -106) + "] El apunte ";
               eaAviso = eaAviso + (("00" + #caenlac@#0) % -102) + "/" + #caenlac@#1 + "/";
               eaAviso = eaAviso + (("00000" + #caenlac@#2) % -105) + "/";
               eaAviso = eaAviso + (("0000" + #caenlac@#3) % -104) ;
               eaAviso = eaAviso + " tenia la cuenta en blanco y se ha reemplazado.";
               |HAZ AnadeAviso;
            |FINSI;
            #caenlac@#48 = #agifa704#19;
            |HAZ MiraRectif;
            |SI nSwitch = 0;
               |GRABA 020#caenlac@.c;
            |SINO;
               |GRABA 020#caenlac@.a;
            |FINSI;
            |LIBERA #caenlac@;
            |HAZ GraTmpCuadre;
            |SI #agifa706#4 = "D";
               nImpCuadre = nImpCuadre + (nImporte ! 2);
            |SINO;
               nImpCuadre = nImpCuadre - (nImporte ! 2);
            |FINSI;
            |HAZ GuardaParaCuadre;
         |FINSI;
      |FINSI;
   |SINO;
      |SALVA_DATOS #caenlac@; FSalida = 0;
      |PARA; |SI FSalida = 0; |HACIENDO;
         #caenlac@#3 = NumApunte;
         |LEE 000#caenlac@.=;
         |SI FSalida = 0;
            |HAZ EsJamaica;
            |SI FSalida = 0;
               NumApunte = NumApunte + 1;
            |SINO;
               |HAZ EsCompaq;
               |SI FSalida = 0;
                  NumApunte = NumApunte + 1;
               |SINO;
                  |HAZ EsMarcosJi;
                  |SI FSalida = 0;
                     NumApunte = NumApunte + 1;
                  |SINO;
                     |HAZ EsPalmHotel;
                     |SI FSalida = 0;
                        NumApunte = NumApunte + 1;
                     |SINO;
                        |HAZ EsInforAlba;
                        |SI FSalida = 0;
                           NumApunte = NumApunte + 1;
                        |SINO;
                           NumApunte = NumApunte + enIncLin;
                        |FINSI;
                     |FINSI;
                  |FINSI;
               |FINSI;
            |FINSI;
         |FINSI;
      |SIGUE;
      |REPON_DATOS #caenlac@;
      #caenlac@#3 = NumApunte;
      |HAZ EsJamaica;
      |SI FSalida = 0;
         NumApunte = NumApunte + 1;
      |SINO;
         |HAZ EsCompaq;
         |SI FSalida = 0;
            NumApunte = NumApunte + 1;
         |SINO;
            |HAZ EsMarcosJi;
            |SI FSalida = 0;
               NumApunte = NumApunte + 1;
            |SINO;
               |HAZ EsPalmHotel;
               |SI FSalida = 0;
                  NumApunte = NumApunte + 1;
               |SINO;
                  |HAZ EsInforAlba;
                  |SI FSalida = 0;
                     NumApunte = NumApunte + 1;
                  |SINO;
                     NumApunte = NumApunte + enIncLin;
                  |FINSI;
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;

      #caenlac@#4 = Cuenta;
      #caenlac@#5 = Nivel;
      #caenlac@#6 = #agifa706#5;
      #caenlac@#7 = Descr;
      #caenlac@#8 = #agifa706#4;
      #caenlac@#9 = nImporte;

      |SI #agifa704#2 = "FC";
         aAlfa = "|NC"; aAlfa = #caenlac@#aAlfa#; nCalc = aAlfa;
         |SI nCalc ] 46;
            nCalc = 45; #caenlac@#nCalc# = #Princip@#74;
         |FINSI;
      |FINSI;

      |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
         ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
         IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
         IFichCab      = FichCab1<-;      IFichCab      = IFichCab      + Cont;
         IFechas       = Fechas1<-;       IFechas       = IFechas       + Cont;
         ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
         ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
         ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
         ISer          = Ser1<-;          ISer          = ISer          + Cont;
         ITipoIva      = TipoIva1<-;      ITipoIva      = ITipoIva      + Cont;
         |SI #agifa704#2 = TiposEnlaces;
            |SI #agifa704#2 = "FV"; |Y ConIva = 1; #caenlac@#10 = "R"; |FINSI;
            |SI #agifa704#2 = "FC"; |Y ConIva = 1; #caenlac@#10 = "S"; |FINSI;
            |SI #agifa704#2 = "FD"; |Y ConIva = 1; #caenlac@#10 = "R"; |FINSI;
            |SI #agifa704#2 = "TI"; |Y ConIva = 1; #caenlac@#10 = "R"; |FINSI;
            |SI #agifa704#2 = "CC"; |Y ConIva = 1; #caenlac@#10 = "R"; |FINSI;
            |SI #agifa704#2 = "CR"; |Y ConIva = 1; #caenlac@#10 = "R"; |FINSI;
            |SAL;
         |FINSI;
      |SIGUE;
      |SI ConIva = 1;
         #caenlac@#11 = #agifa711#6;
         aAlfa = Ficheros; |QBF aAlfa;
         |SI aAlfa = "agifa071";
            Fich = "agifa010"; Cmp = 53; DigFormat = 5; |HAZ TomaDatos; #caenlac@#12 = Comodin;
            Fich = "agifa010"; Cmp = 39; DigFormat = 6; |HAZ TomaDatos; #caenlac@#13 = Comodin;
         |SINO;
            Fich = Ficheros; Cmp = Campo1Clave; DigFormat = 5; |HAZ TomaDatos; #caenlac@#12 = Comodin;
            Fich = Ficheros; Cmp = Campo2Clave; DigFormat = 6; |HAZ TomaDatos; #caenlac@#13 = Comodin;
         |FINSI;
         |SI #agifa704#2 = "CC";
            #caenlac@#12 = "  "; #caenlac@#13 = -1;
         |FINSI;
         ||SI #agifa704#2 = "TI"; #caenlac@#13 = -1; |FINSI;
         #caenlac@#34 = #agifa704#10;
         #caenlac@#35 = #agifa704#11;
         #caenlac@#36 = 0;
      |FINSI;

      aAlfa = "|NC"; aAlfa = #caenlac@#aAlfa#; Calc = aAlfa;
      |SI Calc > 46;
         aAlfa = Ficheros; |QBF aAlfa;
         |SI aAlfa = "agifa071";
            Fich = "agifa010"; Cmp = 53; DigFormat = 5; |HAZ TomaDatos; #caenlac@#46 = Comodin;
            Fich = "agifa010"; Cmp = 39; DigFormat = 6; |HAZ TomaDatos; #caenlac@#47 = Comodin;
         |SINO;
            Fich = Ficheros; Cmp = Campo1Clave; DigFormat = 5;  |HAZ TomaDatos; #caenlac@#46 = Comodin;
            Fich = Ficheros; Cmp = Campo2Clave; DigFormat = 6;  |HAZ TomaDatos; #caenlac@#47 = Comodin;
         |FINSI;
      |FINSI;
      Fich = FichCab;  Cmp = Fechas;      DigFormat = 0; |HAZ TomaDatos; #caenlac@#29 = Comodin;
      |HAZ FormatoFechas;

      Depart = #agifa706#15; aLong = Depart % 0; nLong = aLong;
      |PARA nCont = 1; |SI nCont [ nLong; |HACIENDO nCont = nCont + 1;
         Calc = (nCont * 100) + 1;
         Caracter = Depart % Calc;
         |SI Caracter = "[";
            Calc1 = Calc + 100; Caracter = Depart % Calc1;
            |SI Caracter = "%";
               Calc1 = Calc1 + 100; aAlfa = Depart % Calc1;
               |SI aAlfa = "-";
                  Calc1 = Calc + 18;
               |SINO;
                  Calc1 = Calc + 17;
               |FINSI;
               Cadena = Depart % Calc1; Depart = Depart - Cadena;
               |SI aAlfa = "-";
                  aLong = Cadena % 0402;
                  DigFormat = 0 - aLong;
                  Fich  = Cadena % 0608; Cmp   = Cadena % 1603;
               |SINO;
                  aLong = Cadena % 0302;
                  DigFormat = aLong;
                  Fich  = Cadena % 0508; Cmp   = Cadena % 1503;
               |FINSI;
               |HAZ TomaDatos;
            |SINO;
               Calc1 = Calc + 14;
               Cadena = Depart % Calc1; Depart = Depart - Cadena;
               DigFormat = 0;
               Fich  = Cadena % 0208; Cmp   = Cadena % 1203;
               |HAZ TomaDatos;
            |FINSI;
            Calc1 = 100 + (nCont - 1);
            Cadena = Depart % Calc1; Depart = Depart - Cadena;
            Depart = Cadena + Comodin + Depart;
            nCont = nCont - 1;
         |FINSI;
      |SIGUE;
      #caenlac@#15 = Depart;
      #caenlac@#17 = 0; #caenlac@#18 = "";
      Comodin = Usuario % 0810;
      #caenlac@#19 = Comodin;
      #caenlac@#24 = #agifa704#2;
      #caenlac@#26 = #agifa706#13;
      |SI #caenlac@#26 = "D"; |O #caenlac@#26 = "d";
         |SI #agifa706#14 = 0;
            nHayDto = #caenlac@#3; nImpDto = #caenlac@#9;
         |SINO;
            #caenlac@#27 = #agifa706#14;
         |FINSI;
      |FINSI;
      |SI #caenlac@#26 = " "; |O #caenlac@#26 = "F"; |O #caenlac@#26 = "f"; #caenlac@#27 = 0; |FINSI;
      |SI #agifa704#8 = "S";
         |SI #caenlac@#26 = "I";
            |SI #agifa706#12 = "S";
               Calc = TipoIva; #caenlac@#27 = #Referen@#Calc#;
            |SINO;
               #caenlac@#27 = #agifa706#14;
            |FINSI;
         |SINO;
            |SI #agifa706#12 = "S"; |O #agifa706#7 = "N";
               Calc = TipoIva; #caenlac@#27 = #Referen@#Calc#;
            |FINSI;
         |FINSI;
      |SINO;
         |SI #agifa706#14 = 0; |Y #caenlac@#26 ! "F"; |Y #caenlac@#26 ! "f";
            |SI #caenlac@#26 = "B"; |O #caenlac@#26 = "b";
               #caenlac@#27 = NumBase; NumBase = NumBase + 1;
            |FINSI;
         |SINO;
            #caenlac@#27 = #agifa706#14;
         |FINSI;
      |FINSI;

      |SI #caenlac@#26 = "B"; |O #caenlac@#26 = "b";
         |SI #agifa704#8 = "S";
            || Compruebo si la base a pocesar no es de las normales (portes, varios, etc)
            ||    Si es as¡ indico el tipo de iva manualmente
            aAlfa = #agifa706#8; |QBF aAlfa; nSwTipo = 0;
            |SI aAlfa = "[agifa077][069]";
               Fich = "agifa077"; Cmp = 1; DigFormat = 0; |HAZ TomaDatos;
               efFechaIVA = Comodin;
               Fich = "agifa077"; Cmp = 12; DigFormat = 0; |HAZ TomaDatos;
               #caenlac@#27 = #caenlac@#27 + 5; || Para separar el iva de portes
               enTipoIVA = Comodin; |HAZ RecogeIva;
               #caenlac@#28 = enTipoIVA; nSwTipo = 1;
            |FINSI;
            |SI aAlfa = "[agifa077][070]";
               Fich = "agifa077"; Cmp = 1; DigFormat = 0; |HAZ TomaDatos;
               efFechaIVA = Comodin;
               #caenlac@#27 = #caenlac@#27 + 6; || Para separar el iva de varios
               Fich = "agifa077"; Cmp = 14; DigFormat = 0; |HAZ TomaDatos;
               enTipoIVA = Comodin; |HAZ RecogeIva;
               #caenlac@#28 = enTipoIVA; nSwTipo = 1;
            |FINSI;

            |SI nSwTipo = 0;
               |SI TotalIva ! 0;
                  Fich = "agifa066"; Cmp = 2; DigFormat = 0;
                  |HAZ TomaDatos;
                  #caenlac@#28 = Comodin;
               |FINSI;
               |SI TotalRec ! 0;
                  Fich = "agifa066"; Cmp = 3; DigFormat = 0;
                  |HAZ TomaDatos;
                  #caenlac@#33 = Comodin;
               |FINSI;
            |FINSI;
         |SINO;
            #caenlac@#28 = -1; #caenlac@#33 = -1;
         |FINSI;
      |FINSI;
      |SI #caenlac@#26 = "P"; |O #caenlac@#26 = "p";
         |SI #agifa704#2 = "FC";
           || Tiquet 3042/842
           || Fich = "agifa112"; Cmp = 78; DigFormat = 0; |HAZ TomaDatos; #caenlac@#41 = Comodin;
           || nCalc = (#caenlac@#9 * 100) / #caenlac@#41;
           || #caenlac@#42 = nCalc;
           |SI FichCab = "agifa079";
               #caenlac@#41 = #Princip@#144;
               nBruto = #Princip@#105;
               nNeto  = #Princip@#105 + #Princip@#116;
           |FINSI;
           |SI FichCab = "agifa077";
               #caenlac@#41 = #Princip@#52;
               nBruto = #Princip@#65;
               nNeto  = #Princip@#66;
           |FINSI;

           || nCalc = (#caenlac@#9 * 100) / #caenlac@#41;
           || #caenlac@#42 = nCalc;
           |SI #caenlac@#41 ! 0;
               |SI aSobreIRPF = "B";
                   #caenlac@#42 = nBruto;
               |SINO;
                   #caenlac@#42 = nNeto;
               |FINSI;
           |FINSI;
         |FINSI;

         |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FD";
            Fich = "agifa024"; Cmp = 206; DigFormat = 0; |HAZ TomaDatos;
            #caenlac@#41 = Comodin;
            |SI FichCab = "agifa134";
                #caenlac@#41 = #Princip@#122;
                nBruto       = #Princip@#88;
                nNeto        = #Princip@#88 + #Princip@#99;
            |FINSI;
            || nCalc = (#caenlac@#9 * 100) / #caenlac@#41;
            || #caenlac@#42 = nCalc;
            |SI #caenlac@#41 ! 0;
                |SI aSobreIRPF = "B";
                    #caenlac@#42 = nBruto;
                |SINO;
                    #caenlac@#42 = nNeto;
                |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;

      |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
         ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
         IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
         ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
         ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
         ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
         |SI #agifa704#2 = TiposEnlaces;
            Comodin = Campo1Clave; |QBF Comodin; #caenlac@#21 = Comodin;
            Comodin = Campo2Clave; |QBF Comodin; #caenlac@#22 = Comodin;
            Comodin = Campo3Clave; |QBF Comodin; #caenlac@#23 = Comodin;
            |SAL;
         |FINSI;
      |SIGUE;

      #agifa007#26 = #caenlac@#12;
      |LEE 000#agifa007.=;
      |SI FSalida = 0;
         #caenlac@#30 = #agifa007#40;
      |FINSI;
      |SI #agifa706#12 = "N";
         |SI NVuelta = 1;
            |SI nSwErrCta = 1;
               eaTipoAviso = "A";
               eaAviso = "[" + #caenlac@#12 + "/" + (("000000" + #caenlac@#13) % -106) + "] El apunte ";
               eaAviso = eaAviso + (("00" + #caenlac@#0) % -102) + "/" + #caenlac@#1 + "/";
               eaAviso = eaAviso + (("00000" + #caenlac@#2) % -105) + "/";
               eaAviso = eaAviso + (("0000" + #caenlac@#3) % -104) ;
               eaAviso = eaAviso + " tenia la cuenta en blanco y se ha reemplazado.";
               |HAZ AnadeAviso;
            |FINSI;
            #caenlac@#48 = #agifa704#19;
            |HAZ MiraRectif;
            |GRABA 020#caenlac@.n; |LEE 000#caenlac@.=; |LIBERA #caenlac@;
            |HAZ GraTmpCuadre;
            |SI #agifa706#4 = "D";
               nImpCuadre = nImpCuadre + (nImporte ! 2);
            |SINO;
               nImpCuadre = nImpCuadre - (nImporte ! 2);
            |FINSI;
            |HAZ GuardaParaCuadre;
         |FINSI;
      |SINO;
         |SI nSwErrCta = 1;
            eaTipoAviso = "A";
            eaAviso = "[" + #caenlac@#12 + "/" + (("000000" + #caenlac@#13) % -106) + "] El apunte ";
            eaAviso = eaAviso + (("00" + #caenlac@#0) % -102) + "/" + #caenlac@#1 + "/";
            eaAviso = eaAviso + (("00000" + #caenlac@#2) % -105) + "/";
            eaAviso = eaAviso + (("0000" + #caenlac@#3) % -104) ;
            eaAviso = eaAviso + " tenia la cuenta en blanco y se ha reemplazado.";
            |HAZ AnadeAviso;
         |FINSI;

         #caenlac@#48 = #agifa704#19;
         |HAZ MiraRectif;
         |GRABA 020#caenlac@.n; |LEE 000#caenlac@.=; |LIBERA #caenlac@;
         |HAZ GraTmpCuadre;
         |SI #agifa706#4 = "D";
            nImpCuadre = nImpCuadre + (nImporte ! 2);
         |SINO;
            nImpCuadre = nImpCuadre - (nImporte ! 2);
         |FINSI;
         |HAZ GuardaParaCuadre;
      |FINSI;
   |FINSI;

   |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
      ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
      IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
      ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
      ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
      ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
      |SI #agifa704#2 = TiposEnlaces;
         #agifa722#0 = #agifa704#2;
/*    PEPE
         |SI nSwPalmHoteles = 1; |Y #agifa704#8 = "S";
            Calc = Campo1Clave;
            |SI Calc = 28;
               Comodin = #Referen@#27; |QBF Comodin;
               Comodin = "Z" + Comodin; #agifa722#1 = Comodin;
            |FINSI;
            Calc = Campo2Clave;
            |SI Calc = 25;
               Comodin = #Referen@#0; #agifa722#2 = Comodin;
            |FINSI;
         |SINO;
*/
            Calc = Campo1Clave; Comodin = #Referen@#Calc#; #agifa722#1 = Comodin;
            Calc = Campo2Clave; Comodin = #Referen@#Calc#; #agifa722#2 = Comodin;
         ||FINSI; PEPE
         |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FC";
            Calc = Campo3Clave; Comodin = #Princip@#Calc#; Comodin = Comodin % 0704;
            #agifa722#3 = Comodin;
         |SINO;
            Calc = Campo3Clave; Comodin = #Referen@#Calc#; #agifa722#3 = Comodin;
         |FINSI;
         #agifa722#11 = #agifa705#2;
         |LEE 101#agifa722.=;
         |SI FSalida ! 0;
            |DDEFECTO #agifa722;
            #agifa722#0 = #agifa704#2;
/*    PEPE
            |SI nSwPalmHoteles = 1; |Y #agifa704#8 = "S";
               Calc = Campo1Clave;
               |SI Calc = 28;
                  Comodin = #Referen@#27; |QBF Comodin;
                  Comodin = "Z" + Comodin; #agifa722#1 = Comodin;
               |FINSI;
               Calc = Campo2Clave;
               |SI Calc = 25;
                  Comodin = #Referen@#0; #agifa722#2 = Comodin;
               |FINSI;
            |SINO;
*/
               Calc = Campo1Clave; Comodin = #Referen@#Calc#; #agifa722#1 = Comodin;
               Calc = Campo2Clave; Comodin = #Referen@#Calc#; #agifa722#2 = Comodin;
            ||FINSI;    PEPE
            |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FC";
               Calc = Campo3Clave; Comodin = #Princip@#Calc#; Comodin = Comodin % 0704;
               #agifa722#3 = Comodin;
            |SINO;
               Calc = Campo3Clave; Comodin = #Referen@#Calc#; #agifa722#3 = Comodin;
            |FINSI;
            #agifa722#11 = #agifa705#2;
            #agifa722#8  = #caenlac@#37;
            #agifa722#9  = #caenlac@#38;
            |GRABA 020#agifa722.b;
         |FINSI;
         #agifa722#4  = #caenlac@#0;
         #agifa722#5  = #caenlac@#1;
         #agifa722#6  = #caenlac@#2;
         #agifa722#7  = #caenlac@#3;
         #agifa722#10 = CodEnlace;
         |GRABA 020#agifa722.a; |LIBERA #agifa722;
         |SAL;
      |FINSI;
   |SIGUE;

   |CIERRA #agifa715;
   |REPON_DATOS #caenlac@;
|FPRC;

|DEFBUCLE agifa706a;
#agifa706#1;
;
CodEnlace,#agifa705#2,0001;
CodEnlace,#agifa705#2,9999;
be;
NULL,agifa706a;
|FIN;

|PROCESO MiraIva;
     |SI #agifa706#13 ! " "; ConIva = 1; |ERROR10; |FINSI;
|FPRC;

|DEFBUCLE MiraIva;
     #agifa706#1;
     ;
     CodEnlace,#agifa705#2,0001;
     CodEnlace,#agifa705#2,9999;
     ;
     NULL,MiraIva;
|FIN;

|PROCESO Asiento;
   NumBase = 1; NumIva = 1; NumRec = 1;
   Comodin2 = Usuario; |QBF Comodin2; Comodin2 = "21" + Comodin2;
   |NOME_DAT #73 Comodin2;
   |DELINDEX #agifa721; |ABRE #agifa721;
   |HAZ ResuelveMemo;
   FacContra = 0; ConIva = 0; |BUCLE MiraIva;
   PRMNT_enLuxeRec = 0;
   |BUCLE agifa706a;
   |CIERRA #agifa721;
|FPRC;


|PROCESO BuscaLinea;
   aAlfa6 = aBusca > aBusca;
   |SI #caenlac@#26 = aAlfa6; |Y aCtaAn = #caenlac@#39; |Y #caenlac@#9 ! 0; |ERROR10; |FINSI;
   aAlfa6 = aBusca < aBusca;
   |SI #caenlac@#26 = aAlfa6; |Y aCtaAn = #caenlac@#39; |Y #caenlac@#9 ! 0; |ERROR10; |FINSI;
|FPRC;

|DEFBUCLE BuscaLinea;
#caenlac@#1006;
;
nDiario1,fFecha1,nDocum1,0001,00000,0;
nDiario1,fFecha1,nDocum1,9999,99999,9;
;
NULL,BuscaLinea;
|FIN;


|PROCESO Contador;
   |HAZ EsForestales;
   |SI FSalida = 0;
      Comodin  = PathEnlace; |QBF Comodin; Comodin  = Comodin + "def/";
      Comodin1 = Comodin + "cacontar.mas"; |CARGA_DEF Comodin1, RefDato@;
      Comodin2 = ("00000" + #caenlac@#37) % -105;
      Comodin2 = Comodin2 + #caenlac@#38 + "/";
      Comodin1 = PathEnlace; |QBF Comodin1;
      Comodin1 = Comodin1 + "fich/" + Comodin2;
      |PATH_DAT #RefDato@#Comodin1#; |ABRE #RefDato@;

      #RefDato@#0 = #caenlac@#0;
      |LEE 101#RefDato@.=;
      |SI FSalida ! 0;
         |DDEFECTO #RefDato@;
         #RefDato@#0 = #caenlac@#0;
         |GRABA 020#RefDato@.b;
      |FINSI;
      #RefDato@#2 = #RefDato@#2 + 1; NumAsientos = #RefDato@#2;
      |GRABA 020#RefDato@.a; |LIBERA #RefDato@;

      |CIERRA #RefDato@; |DESCARGA_DEF #RefDato@;
      |VETE FinContador;
   |FINSI;

   |ABRE #caconas@;
   |LEE 101#caconas@.p;
   |SI FSalida ! 0;
      |DDEFECTO #caconas@;
      |GRABA 020#caconas@.n;
      |LEE 101#caconas@.p;
   |FINSI;

   #caconas@#1 = #caconas@#1 + 1;
   Comodin = "|NC"; Calc = #caconas@#Comodin#;
   |SI Calc > 2; #caconas@#2 = #caconas@#2 + 1; |FINSI;
   NumAsientos = #caconas@#1;

   |GRABA 020#caconas@.a;
   |LIBERA #caconas@;
   |CIERRA #caconas@;

|ET FinContador;
   |ABRE #camasic@;
   #camasic@#0 = #caenlac@#0;
   #camasic@#1 = #caenlac@#1;
   #camasic@#2 = NumAsientos;
   |LEE 000#camasic@.=;
   |SI FSalida = 0;
      nErrContador = 1;
   |SINO;
      nErrContador = 0;
   |FINSI;
   |CIERRA #camasic@;
|FPRC;

|RUTINA infe1;
   #agifa716#15 = CodEnlace;
   #agifa716#0 = 001;
|FRUT;

|RUTINA supe1;
   #agifa716#15 = CodEnlace;
   #agifa716#0 = 999;
|FRUT;

|PROCESO Exclusiones;
   |SI #agifa716#11 = "A";
      Calc = 100 + #agifa715#6;
      DComodin = #agifa723#3; DComodin = DComodin % Calc;
      |SI DComodin = Comodin; SwCondic = 0; |ERROR10; |FINSI;
   |FINSI;
   |SI #agifa716#11 = "N";
      |SI #agifa723#4 = Comodin; SwCondic = 0; |ERROR10; |FINSI;
   |FINSI;
   |SI #agifa716#11 = "F";
      |SI #agifa723#5 = Comodin; SwCondic = 0; |ERROR10; |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Exclusiones;
#agifa723#1;
;
#agifa716#15,#agifa716#0,001;
#agifa716#15,#agifa716#0,999;
;
NULL,Exclusiones;
|FIN;

|PROCESO Condicion;
/*
   Se devuelve en la variable 'SwCondic' un uno si el registro actual del
   fichero principal del enlace (o de cualquiera de sus relaciones) entra
   dentro de la acotacion que tenemos recogida en el fichero 'agifa716'. Si
   no es asi, devuelve un cero.
*/
   nLong = 0;
   |SI #agifa716#11 = "N";
      |DBASE aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "def/" + #agifa716#13;
      |CARGA_DEF aAlfa, RefDato@;
      |SI FSalida = 0;
         aAlfa = "|C" + (("000" + #agifa716#14) % -103) + "MINIMO";
         aAlfa = #RefDato@#aAlfa#;
         aAlfa = aAlfa - ".";
         |SI FSalida ! 0;
            nCalc = FSalida; nCalc1 = nCalc + 98; aAlfa = aAlfa % nCalc1; |QBF aAlfa;
            aLong = aAlfa % 0; nLong = aLong;
            aAlfa1 = "9" * nLong;
            |SI aAlfa ! aAlfa1;
               aAlfa = "|C" + (("000" + #agifa716#14) % -103) + "MAXIMO";
               aAlfa = #RefDato@#aAlfa#;
               aAlfa = aAlfa - ".";
               |SI FSalida ! 0;
                  nCalc1 = FSalida; nCalc1 = nCalc1 + 98; aAlfa = aAlfa % nCalc1; |QBF aAlfa;
               |FINSI;
               aLong = aAlfa % 0; nCalc1 = aLong;
               nCalc2 = (nCalc / 100) ! 0;
               |SI nCalc1 > nCalc2; nCalc = (nCalc1 + 1) * 100; |FINSI;
               nCalc1 = (nCalc / 100) ! 0; nLong = 15 - nCalc1;
            |FINSI;
         |FINSI;
         |DESCARGA_DEF #RefDato@;
      |FINSI;
   |FINSI;
   nDeci_nDec = nLong;

   nCalc = (nLinPinta * 100) + 10;
   |ATRI I; |PINTA nCalc, "Resolviendo condiciones        "; |ATRI R;

   #agifa715#0 = #agifa716#13;
   #agifa715#1 = #agifa716#14;
   |LEE 010#agifa715.=;
   |SI FSalida = 0;
      |SI #agifa715#2 = "A"; Comodin = #agifa715#3; |FINSI;
      |SI #agifa715#2 = "N"; Comodin = #agifa715#4; |FINSI;
      |SI #agifa715#2 = "F"; Comodin = #agifa715#5; |FINSI;
      |SI #agifa716#11 = "A";
         Calc = 100 + #agifa715#6; Comodin = Comodin % Calc;
         DComodin = #agifa716#3; DComodin = DComodin % Calc;
         HComodin = #agifa716#4; HComodin = HComodin % Calc;
         |SI DComodin [ Comodin; |Y Comodin [ HComodin;
            SwCondic = 1; aAlfa = Comodin;
            |SI #agifa716#13 = "agifa080"; |Y #agifa716#14 = 28;
               Fich = "agifa077"; Cmp = 51; DigFormat = 5; |HAZ TomaDatos;
               |SI Comodin ! aAlfa;
                  |SI nSwPalmHoteles = 0;
                     Fich = "agifa080"; Cmp = 1; DigFormat = 3; |HAZ TomaDatos;
                     aAlfa = "    Se ha encontrado que la linea " + Comodin;
                     Fich = "agifa080"; Cmp = 27; DigFormat = 5; |HAZ TomaDatos;
                     aAlfa = aAlfa + " del albaran de compra " + Comodin;
                     Fich = "agifa080"; Cmp = 0;  DigFormat = 6; |HAZ TomaDatos;
                     aAlfa = aAlfa + " / " + Comodin + " informa de estar facturado a una numeracion incorrecta";
                     |MENAV aAlfa;
                     SwCondic = 0; |ERROR10;
                  |FINSI;
               |FINSI;
            |FINSI;
            |SI #agifa716#13 = "agifa071"; |Y #agifa716#14 = 30;
               Fich = "agifa010"; Cmp = 53; DigFormat = 5; |HAZ TomaDatos;
               |SI Comodin ! aAlfa;
                  Fich = "agifa071"; Cmp = 1; DigFormat = 3; |HAZ TomaDatos;
                  aAlfa = "    Se ha encontrado que la linea " + Comodin;
                  Fich = "agifa071"; Cmp = 29; DigFormat = 5; |HAZ TomaDatos;
                  aAlfa = aAlfa + " del albaran de venta " + Comodin;
                  Fich = "agifa071"; Cmp = 0;  DigFormat = 6; |HAZ TomaDatos;
                  aAlfa = aAlfa + " / " + Comodin + " informa de estar facturado a una numeracion incorrecta";
                  |MENAV aAlfa;
                  SwCondic = 0; |ERROR10;
               |FINSI;
            |FINSI;
         |SINO;
            SwCondic = 0; |ERROR10;
         |FINSI;
      |FINSI;
      |SI #agifa716#11 = "N";
         |SI #agifa716#5 [ Comodin; |Y Comodin [ #agifa716#6;
            SwCondic = 1; nCalc = Comodin;
            |SI #agifa716#13 = "agifa080"; |Y #agifa716#14 = 25;
               Fich = "agifa077"; Cmp = 39; DigFormat = 0; |HAZ TomaDatos; nCalc1 = Comodin;
               |SI nCalc ! nCalc1;
                  |SI nSwPalmHoteles = 0;
                     Fich = "agifa080"; Cmp = 1; DigFormat = 3; |HAZ TomaDatos;
                     aAlfa = "    Se ha encontrado que la linea " + Comodin;
                     Fich = "agifa080"; Cmp = 27; DigFormat = 5; |HAZ TomaDatos;
                     aAlfa = aAlfa + " del albaran de compra " + Comodin;
                     Fich = "agifa080"; Cmp = 0;  DigFormat = 6; |HAZ TomaDatos;
                     aAlfa = aAlfa + " / " + Comodin + " informa de estar facturado a una numeracion incorrecta";
                     |MENAV aAlfa;
                     SwCondic = 0; |ERROR10;
                  |FINSI;
               |FINSI;
            |FINSI;
            |SI #agifa716#13 = "agifa071"; |Y #agifa716#14 = 26;
               Fich = "agifa010"; Cmp = 39; DigFormat = 0; |HAZ TomaDatos; nCalc1 = Comodin;
               |SI nCalc ! nCalc1;
                   Fich = "agifa071"; Cmp = 1; DigFormat = 3; |HAZ TomaDatos;
                   aAlfa = "    Se ha encontrado que la linea " + Comodin;
                   Fich = "agifa071"; Cmp = 29; DigFormat = 5; |HAZ TomaDatos;
                   aAlfa = aAlfa + " del albaran de venta " + Comodin;
                   Fich = "agifa071"; Cmp = 0;  DigFormat = 6; |HAZ TomaDatos;
                   aAlfa = aAlfa + " / " + Comodin + " informa de estar facturado a una numeracion incorrecta";
                  |MENAV aAlfa;
                   SwCondic = 0; |ERROR10;
               |FINSI;
            |FINSI;
         |SINO;
            SwCondic = 0; |ERROR10;
         |FINSI;
      |FINSI;
      |SI #agifa716#11 = "F";
         |QBF Comodin; fFecha = Comodin;
         |SI #agifa716#7 [ fFecha; |Y fFecha [ #agifa716#8;
            SwCondic = 1;
         |SINO;
            SwCondic = 0; |ERROR10;
         |FINSI;
      |FINSI;
      |SI SwCondic = 1;
         |BUCLE Exclusiones;
         |SI SwCondic = 0; |ERROR10; |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Condicion;
#agifa716#1;
;
CodEnlace,001;
CodEnlace,999;
;
NULL,Condicion;
|FIN;

|PROCESO agifa727;
   Calc2 = Clave1Cab;   Calc3 = Clave2Cab;
   #Princip@#Calc2# = #agifa727#1;
   #Princip@#Calc3# = #agifa727#2;
   |LEE 101#Princip@.=;
   |SI FSalida = 0;
      Calc = #agifa727#3; #Princip@#Calc# = "S";
      |GRABA 020#Princip@.a;
      eaSerFac = #agifa727#1;
      enNumFac = #agifa727#2;
      |HAZ TallerMarcaVO;
   |FINSI;
|FPRC;

|DEFBUCLE agifa727;
#agifa727#1;
;
INICIO;
FINAL;
be;
NULL,agifa727;
|FIN;

|PROCESO GuardaParaCuadre;
     nDiario1 = #caenlac@#0;
     fFecha1  = #caenlac@#1;
     nDocum1  = #caenlac@#2;
     nApunt1  = #caenlac@#3;

     enDiario = #caenlac@#0;
     efFecha  = #caenlac@#1;
     enDocum  = #caenlac@#2;
     enApunt  = #caenlac@#3;
     enEmpresa = #caenlac@#37;
     enPeriodo = #caenlac@#38;
|FPRC;

|PROCESO MiraAcotPalm;
   || Bloque para las facturas de compra del modulo de Palm Hoteles

   |SI #agifa704#2 = "FC";
      aAlfa7 = #agifa716#13; |QBF aAlfa7;
      |SI aAlfa7 = "agifa077";
         |SI #agifa716#14 = 51;
            aAlfa7 = #agifa716#3; |QBF aAlfa7;
            aAlfa7 = aAlfa7 % 0101;
            |SI aAlfa7 = "Z";
               aAlfa7 = #agifa716#4; |QBF aAlfa7;
               aAlfa7 = aAlfa7 % 0101;
               |SI aAlfa7 = "Z"; nSwPalmHoteles = 1; |ERROR10; |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
      |SI aAlfa7 = "agifa080";
         |SI #agifa716#14 = 28;
            aAlfa7 = #agifa716#3; |QBF aAlfa7;
            aAlfa7 = aAlfa7 % 0101;
            |SI aAlfa7 = "Z";
               aAlfa7 = #agifa716#4; |QBF aAlfa7;
               aAlfa7 = aAlfa7 % 0101;
               |SI aAlfa7 = "Z"; nSwPalmHoteles = 1; |ERROR10; |FINSI;
            |FINSI;
         |FINSI;
         |SI #agifa716#14 = 27; |Y nIdPalm = 1;
            aAlfa7 = #agifa716#3; |QBF aAlfa7;
            aAlfa7 = aAlfa7 % 0101;
            |SI aAlfa7 ! "Z";
               aAlfa7 = #agifa716#4; |QBF aAlfa7;
               aAlfa7 = aAlfa7 % 0101;
               |SI aAlfa7 ! "Z"; nSwPalmHoteles = 1; |ERROR10; |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE MiraAcotPalm;
#agifa716#1;
;
CodEnlace,001;
CodEnlace,999;
;
NULL,MiraAcotPalm;
|FIN;

|PROCESO Asientos;
/*
   Esta rutina crea los asientos en base a la plantilla que nosotros hemos
   generado anteriormente en la parametrizacion. Recorre el fichero
   'agifa705'. Por cada linea que encuentra de este fichero (que representa
   un asiento) recogeremos los datos que estan relacionados con el registro
   ,miraremos si el registro entra dentro de la acotacion que tenemos y si es
   validado recorreremos el fichero 'agifa706' con la clave correspondiente
*/

|| Primero reviso si el asiento ya ha sido enlazado ...

   NumAsientos = -1; NumApunte = 1; NVuelta = 1;
   nHayPortes = 0; nHayVarios = 0;
   |DBASE Comodin; |QBF Comodin;
   Comodin = Comodin + "def/";
   |SI #agifa704#2 = "FV"; Comodin = Comodin + FichCab1 + ".mas"; |FINSI;
   |SI #agifa704#2 = "FC"; Comodin = Comodin + FichCab2 + ".mas"; |FINSI;
   |SI #agifa704#2 = "FD"; Comodin = Comodin + FichCab3 + ".mas"; |FINSI;
   |SI #agifa704#2 = "TI"; Comodin = Comodin + FichCab4 + ".mas"; |FINSI;
   |SI #agifa704#2 = "CC"; Comodin = Comodin + FichCab5 + ".mas"; |FINSI;
   |SI #agifa704#2 = "CR"; Comodin = Comodin + FichCab6 + ".mas"; |FINSI;
   |CARGA_DEF Comodin, Princip@;
   |SI FSalida ! 0; |ACABA; |FINSI;

   aAlfa = Comodin - "agifa079";
   enSwAgifa079 = FSalida;  || Para Taller/Tagloma

   |PUSHV 1022 1663;
   |SI nSinPrelv = 0; |HAZ Prelavado; |FINSI;

   |SI enSwEnlSeries = 1;
      || Compruebo si hay campo clave del enlace
      ||... Si no lo hay y no ha habido preseleccion, sigo como siempre ...
      |SI #agifa704#17 ! 999;
         || ... y si lo hay y no ha habido preseleccion, no sigo
         |SI enNumRegs [ 0; |VETE Final; |FINSI;
      |FINSI;
   |FINSI;

   |ABRE #Princip@;

   || Compruebo para el modulo de Palm Hoteles si tengo que hacer el cambio
   ||    de acotaciones para las facturas automaticas desde albaranes de
   ||    compra.
   || (Juan: se comprueba que la serie comience por "Z")
   |SI nSwPalmHoteles = 1;
      nSwPalmHoteles = 0; |BUCLE MiraAcotPalm;
   |FINSI;

   Fichero = Fich1; |HAZ GeneraSQL;
   |SQL Fichero;
   |SI FSalida < 0;
      |MENAV "    Error en la sentencia de la consulta"; |VETE Final;
   |SINO;
      aAlfa2 = FSalida; aAlfa2 = aAlfa2 % 0399;
      |DDEF aAlfa;   |QBF aAlfa; aAlfa = aAlfa + Fich1 + ".mas";
      |DFICE aAlfa1; |QBF aAlfa1;
      |LEEDEDEF aAlfa, aAlfa1; aAlfa = FSalida % 1815; |QBT aAlfa;
      |SI enNumRegs = -1; enNumRegs = aAlfa; |FINSI;
      aAlfa = "    Totales:" + aAlfa + "   Preseleccionados:" + enNumRegs + "   " + aAlfa2;
      |MENSA aAlfa;
      aAlfa2 = "0 " + aAlfa2; FSalida = aAlfa2;
   |FINSI;

   aAlfa = FSalida; aAlfa2 = ""; NumRegistro = 1;
   |PARA; |SI; |HACIENDO;
      aAlfa1 = aAlfa % -101;
      aLong = aAlfa % 0; nLong = aLong; Calc = 100 + (nLong - 1);
      aAlfa = aAlfa % Calc;
      |SI aAlfa1 = ":";
         TotalRegs = aAlfa2;
         |SAL;
      |SINO;
         aAlfa2 = aAlfa1 + aAlfa2;
      |FINSI;
   |SIGUE;
   aAlfa = aAlfa % -102;
   |SI aAlfa ! ":0";
      Comodin2 = Usuario; |QBF Comodin2; Comodin2 = "sq" + Comodin2;
      |CARGA_DEF Comodin2,Referen@;
      |SI FSalida = 0;
         |ABRE #Referen@;
         |SI nSwPalmHoteles = 1;
            || Cambio en el temporal todos los vinculos a la factura normal
            ||     por la factura ficticia
            aFicSQL = "|C000IDCAMPO"; aFicSQL = #Referen@#aFicSQL#;
            aAlfa = aFicSQL - ".";
            |SI FSalida ! 0;
               nCalc = FSalida + 98;
               aAlfa = aFicSQL % nCalc;
               aFicSQL = aFicSQL - aAlfa;
            |FINSI;
            |QBF aFicSQL;

            |LEE 101#Referen@.p;
            |PARA; |SI FSalida = 0; |HACIENDO;
               |SI aFicSQL = "agifa077";
                  aAlfa = #Referen@#50; |QBF aAlfa;
                  aAlfa = "Z" + aAlfa;
                  #Referen@#51 = aAlfa;
                  #Referen@#39 = #Referen@#0;
                  |GRABA 020#Referen@.a; |LIBERA #Referen@;
               |FINSI;
               |SI aFicSQL = "agifa080";
                  aAlfa = #Referen@#27; |QBF aAlfa;
                  aAlfa = "Z" + aAlfa;
                  #Referen@#28 = aAlfa;
                  #Referen@#25 = #Referen@#0;
                  |GRABA 020#Referen@.a; |LIBERA #Referen@;
               |FINSI;
               |LEE 101#Referen@.s;
            |SIGUE;
         |FINSI;

         |SI aVersion ] "9.10V"; |SELECT #2#Referen@; |FINSI;
         aTipoEnl = "";
         |SI #agifa704#2 = "FV";
            |SI #agifa704#8 = "N"; aTipoEnl = "FV"; |SINO; aTipoEnl = "AV"; |FINSI;
         |FINSI;
         |SI #agifa704#2 = "FC";
            |SI #agifa704#8 = "N"; aTipoEnl = "FC"; |SINO; aTipoEnl = "AC"; |FINSI;
         |FINSI;
         |SI #agifa704#2 = "FD"; aTipoEnl = "FD"; |FINSI;
         |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FC";
            |SI #agifa704#8 = "S";
               |SI aVersion ] "9.10V";
                  |SELECT #3#Referen@;
               |SINO;
                  |SELECT #2#Referen@;
               |FINSI;
            |FINSI;
         |FINSI;

         nImpCuadre = 0;

         NumAsto = NumAsto + 1;
         |LEE 101#Referen@.p;
         |SI FSalida = 0;

            Comodin2 = Usuario; |QBF Comodin2; Comodin2 = "12" + Comodin2;
            |NOME_DAT #1 Comodin2;
            |DELINDEX #agifa712;
            |ABRE #agifa712;

            |PARA; |SI FSalida = 0; |HACIENDO;
               |ATRI I;
               Mensaje = "Recorriendo resultados                Enlazando registro ...... : " + NumRegistro;
               nCalc = (nLinPinta * 100) + 7;
               |PINTA nCalc, Mensaje;
               Mensaje = "Enlazando, espere por favor ..... " + MarcaPant;
               |HAZ ActMarca;
               Mensaje = Mensaje + "   Total registros a enlazar : " + TotalRegs;
               nCalc = nCalc + 100;
               |PINTA nCalc, Mensaje; |ATRI R;

               |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
                   ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
                   ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
                   ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
                   ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
                   IClave1Cab    = Clave1Cab1<-;    IClave1Cab    = IClave1Cab    + Cont;
                   IClave2Cab    = Clave2Cab1<-;    IClave2Cab    = IClave2Cab    + Cont;
                   |SI #agifa704#2 = TiposEnlaces;

                      aAlfaX  = "|NC";     aAlfaX  = #Princip@#aAlfaX#;
                      aAlfa1X = "|DEF"; aAlfa1X = #Princip@#aAlfa1X#;

                      Calc = Campo1Clave; Calc1 = Campo2Clave; Calc4 = Campo3Clave;
                      |SI #agifa704#8 = "S";
                         |SI CmpClave1Cab ! #Referen@#Calc#; |O CmpClave2Cab ! #Referen@#Calc1#;
                            nSwCambioReg = 1; NVuelta = 0;
                         |SINO;
                            nSwCambioReg = 0;
                         |FINSI;
                      |SINO;
                         |SI #agifa704#2 ! "CC";
                            |SI CmpClave1Cab ! #Referen@#Calc#; |O CmpClave2Cab ! #Referen@#Calc1#; ||O CmpClave3Cab ! #Referen@#Calc4#;
                               nSwCambioReg = 1; NVuelta = 0;
                            |SINO;
                               nSwCambioReg = 0;
                            |FINSI;
                         |SINO;
                            |SI CmpClave1Cab ! #Referen@#Calc#; |O CmpClave2Cab ! #Referen@#Calc1#; |O CmpClave3Cab ! #Referen@#Calc4#;
                               nSwCambioReg = 1; NVuelta = 0;
                            |SINO;
                               nSwCambioReg = 0;
                            |FINSI;
                         |FINSI;
                      |FINSI;
                      CmpClave1Cab = #Referen@#Calc#;
                      CmpClave2Cab = #Referen@#Calc1#;
                      CmpClave3Cab = #Referen@#Calc4#;
                      Calc2 = Clave1Cab;   Calc3 = Clave2Cab;
                      #Princip@#Calc2# = #Referen@#Calc#;
                      #Princip@#Calc3# = #Referen@#Calc1#;
                      |SI #agifa704#2 = "CC"; #Princip@#1 = #Referen@#1; |FINSI;
                      |LEE 000#Princip@.=;
                      |SAL;
                   |FINSI;
               |SIGUE;
               |HAZ MiraNDecis;
               FichRelac = Fich1; |HAZ ResuelveRels;

               SwCondic = 0;
               |ABRE #agifa715;
               |BUCLE Condicion;
/*    PEPE
               |SI nSwPalmHoteles = 1; |Y SwCondic = 1;
                  Fich = "agifa079"; Cmp = 66; DigFormat = 0; |HAZ TomaDatos;
                  aAlfa11 = Comodin; |QBF aAlfa11;
                  aAlfa11 = aAlfa11 % 0101;
                  |SI aAlfa11 ! "Z"; SwCondic = 0; |FINSI;
               |FINSI;
*/
               |SI SwCondic = 1;
                  || Primero obtengo la fecha del registro a enlazar para comprobaciones .....
                  nAsientAnt = #caenlac@#2; fFechaAnt = #caenlac@#1;
                  |DDEFECTO #caenlac@;
                  #caenlac@#0 = #agifa705#3;
                  #caenlac@#1 = #agifa705#4;

                  |SI #caenlac@#1 = "00.00.0000"; #caenlac@#1 = ~; |FINSI;
                  |SI #caenlac@#1 = "01.01.0000";
                     |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
                        ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
                        IFechas       = Fechas1<-;       IFechas       = IFechas       + Cont;
                        IFichCab      = FichCab1<-;      IFichCab      = IFichCab      + Cont;
                        |SI #agifa704#2 = TiposEnlaces;
                           Fich = FichCab; Cmp = Fechas; |HAZ TomaDatos;
                           #caenlac@#1 = Comodin;
                           |SAL;
                        |FINSI;
                     |SIGUE;
                  |FINSI;
                  #caenlac@#29 = "00.00.0000";
                  |HAZ FormatoFechas;

                  || Compruebo que la fecha del registro que vamos a enlazar coincida con el ejercicio de la
                  ||     empresa de contabilidad ......

                  Comodin  = PathEnlace; |QBF Comodin; Comodin1 = Comodin;
                  Comodin = Comodin + "def/canempre.mas"; Comodin1 = Comodin1 + "fich/";
                  |CARGA_DEF Comodin , canempr@;
                  |SI FSalida = 0;
                     |PATH_DAT #20 Comodin1; |ABRE #canempr@;
                     #canempr@#2 = #agifa711#4;
                     #canempr@#3 = #agifa711#5;
                     |LEE 000#canempr@.=;
                     |SI FSalida = 0;
/* ABDON Tiquet 004077/00200   Hasta ahora solo comprobaba el ejercicio. Ahora
                               comprueba las fechas, ya que el ejercicio puede
                               estar partido

                        aAlfa = #caenlac@#1; |QBF aAlfa;
                        |SI aAlfa ! ""; aAlfa = aAlfa % -104; nAnyo = aAlfa; |FINSI;
                        nCalc = #canempr@#26;
                        |SI nCalc ] 80; nCalc = nCalc + 1900; |SINO; nCalc = nCalc + 2000; |FINSI;
                        nEjerc = nCalc;
                        |SI nCalc ! nAnyo;
*/
                        fFechaEje = #caenlac@#1;
                        nCalc = #canempr@#26;
                        |SI nCalc > 80; nCalc = nCalc + 1900; |SINO; nCalc = nCalc + 2000; |FINSI;
                        aAlfa = "01." + (("00" + #canempr@#11) % -102) + "." + nCalc;       fFechaIni = aAlfa;
                        nCalc = nCalc + 1;
                        nCalc1 = #canempr@#12 + 1;
                        |SI nCalc1 > 12; nCalc1 = 1; |FINSI;
                        aAlfa = "01." + (("00" + nCalc1) % -102) + "." + nCalc; fFechaFin = aAlfa;
                        nCalc1 = fFechaFin; nCalc1 = nCalc1 - 1; fFechaFin = nCalc1;
                        |SI fFechaIni > fFechaEje; |O fFechaEje > fFechaFin;
                           |HAZ BuscaPeriodo;
                           |SI nPeriodo = -1;
                              #caenlac@#37 = #agifa711#4; #caenlac@#38 = #agifa711#5;
                           |SINO;
                              #caenlac@#37 = #agifa711#4; #caenlac@#38 = nPeriodo;
                           |FINSI;
                        |SINO;
                           #caenlac@#37 = #agifa711#4; #caenlac@#38 = #agifa711#5;
                        |FINSI;
                     |FINSI;
                     |CIERRA #canempr@; |DESCARGA_DEF #canempr@;
                  |FINSI;
                  |CIERRA #caconas@;
                  Comodin2 = ("00000" + #caenlac@#37) % -105;
                  Comodin2 = Comodin2 + #caenlac@#38 + "/";
                  Comodin1 = PathEnlace; |QBF Comodin1;
                  Comodin1 = Comodin1 + "fich/" + Comodin2;
                  |PATH_DAT #24 Comodin1;
                  |ABRE #caconas@;

                  || Aqui lo que se hace es mirar si existe la factura en el historico de enlaces. Si esta
                  ||   escribo una linea que hace que el registro anterior se borre y arrastro el numerador.
                  ||   Si no esta cojo un numerador nuevo siempre que no sea un enlace de facturas directas .....
                  aSwBloqueoLiqui = "N";
                  |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
                     ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
                     InAsiento     = nAsiento1<-;     InAsiento     = InAsiento     + Cont;
                     ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
                     ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
                     ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
                     IClave1Cab    = Clave1Cab1<-;    IClave1Cab    = IClave1Cab    + Cont;
                     IClave2Cab    = Clave2Cab1<-;    IClave2Cab    = IClave2Cab    + Cont;
                     IContabil     = Contabil1<-;     IContabil     = IContabil     + Cont;
                     |SI #agifa704#2 = TiposEnlaces;
                        #agifa722#0 = #agifa704#2;
/*    PEPE
                        |SI nSwPalmHoteles = 1; |Y #agifa704#8 = "S";
                           Calc = Campo1Clave;
                           |SI Calc = 28;
                              Comodin = #Referen@#27; |QBF Comodin;
                              Comodin = "Z" + Comodin; #agifa722#1 = Comodin;
                           |FINSI;
                           Calc = Campo2Clave;
                           |SI Calc = 25;
                              Comodin = #Referen@#0; #agifa722#2 = Comodin;
                           |FINSI;
                        |SINO;
*/
                           Calc = Campo1Clave; Comodin = #Referen@#Calc#;
                           #agifa722#1 = Comodin;
                           Calc = Campo2Clave; Comodin = #Referen@#Calc#;
                           #agifa722#2 = Comodin;
                        ||FINSI; PEPE

                        |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FC";
                           Calc = Campo3Clave; Comodin = #Princip@#Calc#;
                           Comodin = Comodin % 0704;
                        |SINO;
                           Calc = Campo3Clave; Comodin = #Referen@#Calc#;
                        |FINSI;
                        #agifa722#3 = Comodin;
                        #agifa722#8 = #caenlac@#37;
                        #agifa722#9 = #caenlac@#38;
                        #agifa722#11 = #agifa705#2;
                        |LEE 101#agifa722.=;
                        |HAZ CheqCamaniva;
                        |SI FSalida = 0;
                           || .... y si ha sido enlazado , escribimos las lineas pertinentes
                           ||      del fichero de enlace para que las borre

                           || Esto se pone porque aun no se sabe si hay
                           || registros en el fichero #caenlac@ y si no hay y
                           || se hace el REPON_DATOS, el basico da un error
                           |SALVA_DATOS #caenlac@;
                           nSalva = 0;
                           |LEE 000#caenlac@.c;
                           |SI FSalida = 0;
                              nSalva = 1;
                           |FINSI;
                           |REPON_DATOS #caenlac@;
                           |SALVA_FICHA #caenlac@;

                           |DDEFECTO #caenlac@;
                           #caenlac@#37 = #agifa722#8;
                           #caenlac@#38 = #agifa722#9;
                           #caenlac@#0 = #agifa722#4;
                           #caenlac@#1 = #agifa722#5;
                           #caenlac@#2 = #agifa722#6;
                           #caenlac@#3 = 0;
                           |LEE 000#caenlac@.=;
                           |SI FSalida ! 0;
                              #caenlac@#37 = #agifa722#8;
                              #caenlac@#38 = #agifa722#9;
                              #caenlac@#0 = #agifa722#4;
                              #caenlac@#1 = #agifa722#5;
                              #caenlac@#2 = #agifa722#6;
                              #caenlac@#3 = 0;
                              #caenlac@#9 = 0;
                              #caenlac@#12 = #agifa722#1;
                              #caenlac@#13 = #agifa722#2;
                              #caenlac@#25 = "S";
                              |GRABA 020#caenlac@.n; |LEE 000#caenlac@.=;
                              |HAZ GraTmpCuadre;
                              fFechaHEnl = #agifa722#5;
                           |FINSI;
                           |SI enFactura116 ! 0;
                              |SI nSalva = 1; |REPON_FICHA #caenlac@; |FINSI;
                           |SINO;
                              |REPON_FICHA #caenlac@;
                           |FINSI;
                           |SI enReContab = 1; #caenlac@#1 = fFechaHEnl; |FINSI;

                           Calc = #agifa722#6;
                           |SI NumAsientos ! Calc;
                              UltFecha  = #caenlac@#1; || 27/01/2003 (1)
                              NumAsientos = Calc; NumApunte = 1; NVuelta = 0;
                              nHayPortes = 0; nHayVarios = 0;
                           |FINSI;
                           |SI #agifa704#7 = "S";
                              Calc  = Campo1Clave; aAlfa1 = #Referen@#Calc#;  |QBF aAlfa1;
                              Calc1 = Campo2Clave; aAlfa2 = #Referen@#Calc1#; |QBF aAlfa2;
                              |SI #agifa704#2 = "CC";
                                 Calc2 = Campo3Clave; aAlfa3 = #Referen@#Calc2#; |QBF aAlfa3;
                              |SINO;
                                 aAlfa3 = aClave3;
                              |FINSI;
                              |SI aClave1 ! aAlfa1; |O aClave2 ! aAlfa2; |O aClave3 ! aAlfa3;
                                 |SI aClave1 ! ""; |Y aClave2 ! ""; NVuelta = 0; |FINSI;
                                 aClave1 = aAlfa1; aClave2 = aAlfa2; aClave3 = aAlfa3;
                                 |QBF aClave1; |QBF aClave2; |QBF aClave3;
                              |FINSI;
                           |FINSI;
                           Calc  = Campo1Clave; CmpClave1Cab = #Referen@#Calc#;
                           Calc1 = Campo2Clave; CmpClave2Cab = #Referen@#Calc1#;
                           Calc4 = Campo3Clave; CmpClave3Cab = #Referen@#Calc4#;
                           Calc2 = Clave1Cab;   Calc3 = Clave2Cab;
                        |SINO;
                           |SI #agifa704#7 ! "S";
                              |SI #agifa704#2 = "FD"; |O #agifa704#2 = "TI";
                                 |SI nSwCambioReg = 1;
                                    NumAsientos = -1;
                                 |FINSI;
                              |SINO;
                                 NumAsientos = -1;
                              |FINSI;
                           |FINSI;
                        |FINSI;
                        |SAL;
                     |FINSI;
                  |SIGUE;

                  |SI aSwBloqueoLiqui = "S"; |ACABA; |FINSI;

                  |SI Modo = "B"; |ACABA; |FINSI;

                  |SI #agifa705#5 = "N";
                     |SI #agifa704#7 = "S";  || 27/01/2003
                        Calc  = Campo1Clave; aAlfa1 = #Referen@#Calc#;  |QBF aAlfa1;
                        Calc1 = Campo2Clave; aAlfa2 = #Referen@#Calc1#; |QBF aAlfa2;
                        |SI #agifa704#2 = "CC";
                           Calc2 = Campo3Clave; aAlfa3 = #Referen@#Calc2#; |QBF aAlfa3;
                        |SINO;
                           aAlfa3 = aClave3;
                        |FINSI;
                        |SI aClave1 ! aAlfa1; |O aClave2 ! aAlfa2; |O aClave3 ! aAlfa3;
                           |SI aClave1 ! ""; |Y aClave2 ! ""; NVuelta = 0; |FINSI;
                           aClave1 = aAlfa1; aClave2 = aAlfa2; aClave3 = aAlfa3;
                           |QBF aClave1; |QBF aClave2; |QBF aClave3;
                        |FINSI;
                     |FINSI;
                     Calc = Campo1Clave; Calc1 = Campo2Clave; Calc2 = Campo3Clave;
                     |SI #agifa704#2 ! "CC";
                        CmpClave3Cab = #Referen@#Calc2#;
                     |FINSI;
/*
                     |SI #agifa704#7 = "S"; || PEPE
                        |SI fFechaAnt ! #caenlac@#1;
                           CmpClave1Cab = ""; CmpClave2Cab = ""; CmpClave3Cab = "";
                        |FINSI;
                     |FINSI;
*/
                     || ABDON 29/06/2010   Tiquet 002775/00484
                     || Pongo esta condicion porque cuando el enlace es agru-
                     ||   pado por fechas y enlazas documentos que no estan
                     ||   en el historico de enlaces, la variable 'nAsientAnt'
                     ||   tiene el mismo valor que 'NumAsientos', por lo que
                     ||   el cuadre automatico lo coloca en el ultimo asiento.
                     ||   Como la variable 'fFechaAnt' si que detecta que la
                     ||   fecha ha cambiado, fuerzo a 'nAsientAnt' a que sea
                     ||   distinta de 'NumAsientos' para que grabe el cuadre
                     ||   automatico
                     |SI fFechaAnt ! #caenlac@#1; |Y #agifa704#7 = "S";
                              |Y eaCuaAuto ! "N";
                        |SI nAsientAnt = NumAsientos; nAsientAnt = 0; |FINSI;
                     |FINSI;

                     |SI CmpClave1Cab ! #Referen@#Calc#; |O CmpClave2Cab ! #Referen@#Calc1#; |O CmpClave3Cab ! #Referen@#Calc2#;
                        NumAsientos = -1; NumApunte = 1; NVuelta = 1;
                        nHayPortes = 0; nHayVarios = 0;
                        CmpClave1Cab = #Referen@#Calc#;
                        CmpClave2Cab = #Referen@#Calc1#;
                        CmpClave3Cab = #Referen@#Calc2#;
                     |SINO;
                        NVuelta = NVuelta + 1;
                     |FINSI;
                  |SINO;
                     NVuelta = NVuelta + 1;
                  |FINSI;

                  |SI NumAsientos < 0;
                     |HAZ Contador; NumApunte = 1; NVuelta = 1;
                     nHayPortes = 0; nHayVarios = 0;
                     |SI nErrContador = 1; |SAL; |FINSI;
                  |FINSI;
                  |SI NumApunte = 1; nMaxApunte = 1; |FINSI;
                  nImpCuadre = nImpCuadre ! 2;
                  |SI nImpCuadre ! 0; |Y nAsientAnt ! NumAsientos;
                          |Y eaCuaAuto ! "N";
                     |SALVA_FICHA #caenlac@;

                     enImporte = nImpCuadre ! 2;
                     |SI eaCuaAuto = "S"; |HAZ Rectifica; |FINSI;
                     |SI enImporte ! 0; |Y eaCuaAuto = "I";
                        |SI nImpCuadre < 1; |O nImpCuadre > -1;
                           aBusca = "B"; |BUCLE BuscaLinea;
                           |SI #caenlac@#26 = "B"; |O #caenlac@#26 = "b";
                              |LEE 101#caenlac@.=;
                              |SI #caenlac@#8 = "D";
                                 #caenlac@#9 = #caenlac@#9 - nImpCuadre;
                              |SINO;
                                 #caenlac@#9 = #caenlac@#9 + nImpCuadre;
                              |FINSI;
                              #caenlac@#48 = #agifa704#19;
                              |GRABA 020#caenlac@.a; |LIBERA #caenlac@;
                              |HAZ GraTmpCuadre;
                           |SINO;
                              aBusca = "I"; |BUCLE BuscaLinea;
                              |SI #caenlac@#26 = "I"; |O #caenlac@#26 = "i";
                                 |LEE 101#caenlac@.=;
                                 |SI #caenlac@#8 = "D";
                                    #caenlac@#9 = #caenlac@#9 - nImpCuadre;
                                 |SINO;
                                    #caenlac@#9 = #caenlac@#9 + nImpCuadre;
                                 |FINSI;
                                 #caenlac@#48 = #agifa704#19;
                                 |GRABA 020#caenlac@.a; |LIBERA #caenlac@;
                                 |HAZ GraTmpCuadre;
                              |SINO;
                                 aBusca = "F"; |BUCLE BuscaLinea;
                                 |LEE 101#caenlac@.=;
                                 |SI #caenlac@#26 = "F"; |O #caenlac@#26 = "f";
                                    |SI #caenlac@#8 = "D";
                                       #caenlac@#9 = #caenlac@#9 - nImpCuadre;
                                    |SINO;
                                       #caenlac@#9 = #caenlac@#9 + nImpCuadre;
                                    |FINSI;
                                    #caenlac@#48 = #agifa704#19;
                                    |GRABA 020#caenlac@.a; |LIBERA #caenlac@;
                                    |HAZ GraTmpCuadre;
                                 |FINSI;
                              |FINSI;
                           |FINSI;
                        |FINSI;
                     |FINSI;

                     |LEE 000#caenlac@.p;
                     |REPON_FICHA #caenlac@;
                     nImpCuadre = 0;
                  |FINSI;

                  |SI #agifa705#5 = "N";
                     |SI #agifa704#7 = "S";
                        |SI UltFecha ! #caenlac@#1;
                           |HAZ Contador; NumApunte = 1; NVuelta = 1;
                           nHayPortes = 0; nHayVarios = 0;
                           |SI nErrContador = 1;
                              |SAL;
                           |FINSI;
                        |FINSI;
                     |FINSI;
                  |FINSI;
                  #caenlac@#2 = NumAsientos;
                  UltFecha  = #caenlac@#1;

                  |SI nSwCambioReg = 1;
                     nHayDto = 0; nImpDto = 0;
                  |FINSI;

                  |HAZ Asiento;

                  || Esto marca el registro que sea como contabilizado .....
                  |SI #agifa704#2 = "CC";
                     Calc  = Campo1Clave; CmpClave1Cab = #Referen@#Calc#;
                     Calc1 = Campo2Clave; CmpClave2Cab = #Referen@#Calc1#;
                     Calc4 = Campo3Clave; CmpClave3Cab = #Referen@#Calc4#;
                     Calc2 = Clave1Cab;   Calc3 = Clave2Cab;
                     #Princip@#Calc2# = #Referen@#Calc#;
                     #Princip@#Calc3# = #Referen@#Calc1#;
                     #Princip@#1 = #Referen@#1;
                     |LEE 101#Princip@.=;
                     |SI FSalida = 0;
                        aAlfa = #caenlac@#1; |QBF aAlfa;
                        |SI aAlfa ! ""; aAlfa = aAlfa % -104; nAnyo = aAlfa; |FINSI;
                        |SI nEjerc = nAnyo;
                           Calc = Contabil; #Princip@#Calc# = "S";
                           |GRABA 020#Princip@.a;
                           eaSerFac = #Referen@#Calc#;
                           enNumFac = #Referen@#Calc1#;
                           |HAZ TallerMarcaVO;
                        |FINSI;
                        |LIBERA #Princip@;
                     |FINSI;
                  |FINSI;
                  |SI Modo ! "B"; |Y #agifa704#18 ! "A";
                     nCalcX = Campo1Clave; aAlfaX  = #Referen@#nCalcX#;
                     nCalcX = Campo2Clave; aAlfa1X = #Referen@#nCalcX#;

                     |DDEF aAlfa2X; |QBF aAlfa2X;
                     aAlfa2X = aAlfa2X + "agifa743.mas";
                     |CARGA_DEF aAlfa2X, RefDato@;
                     |SI FSalida = 0;
                        |DFICE aAlfa2X; |QBF aAlfa2X;
                        |PATH_DAT #RefDato@#aAlfa2X#; |ABRE #RefDato@;
                        #RefDato@#0 = #agifa704#2;
                        #RefDato@#1 = aAlfaX;
                        #RefDato@#2 = aAlfa1X;
                        #RefDato@#3 = nAnyo;
                        |LEE 101#RefDato@.=;
                        |SI FSalida ! 0;
                           |DDEFECTO #RefDato@;
                           #RefDato@#0 = #agifa704#2;
                           #RefDato@#1 = aAlfaX;
                           #RefDato@#2 = aAlfa1X;
                           #RefDato@#3 = nAnyo;
                           |GRABA 020#RefDato@.b;
                        |FINSI;
                        #RefDato@#4 = #agifa704#18;
                        #RefDato@#5 = #agifa711#8;
                        #RefDato@#6 = #agifa704#0;
                        |GRABA 020#RefDato@.a; |LIBERA #RefDato@;
                        |CIERRA #RefDato@; |DESCARGA_DEF #RefDato@;
                     |FINSI;
                  |FINSI;
               |FINSI;
               |CIERRA #agifa715;

               |SI nHayDto ! 0;
                  nNumBase = 0;
                  |SALVA_FICHA #caenlac@;
                  nDiario = #caenlac@#0;
                  fFecha  = #caenlac@#1;
                  nDocum  = #caenlac@#2;
                  #caenlac@#3 = 1;
                  |LEE 000#caenlac@.];
                  |PARA; |SI FSalida = 0; |Y nDiario = #caenlac@#0; |Y fFecha = #caenlac@#1;
                          |Y nDocum = #caenlac@#2; |HACIENDO;
                     |SI #caenlac@#26 = "B"; |O #caenlac@#26 = "b";
                        nNumBase = #caenlac@#27;
                        |SI #caenlac@#9 > 0;
                           |SI #caenlac@#9 > nImpDto; |SAL; |FINSI;
                        |FINSI;
                        |SI #caenlac@#9 < 0;
                           |SI #caenlac@#9 < nImpDto; |SAL; |FINSI;
                        |FINSI;
                     |FINSI;
                     |LEE 000#caenlac@.s;
                  |SIGUE;
                  #caenlac@#0 = nDiario;
                  #caenlac@#1 = fFecha;
                  #caenlac@#2 = nDocum;
                  #caenlac@#3 = nHayDto;
                  |LEE 101#caenlac@.=;
                  |SI FSalida = 0; |Y #caenlac@#26 = "D";
                     #caenlac@#27 = nNumBase;
                     #caenlac@#48 = #agifa704#19;
                     |GRABA 020#caenlac@.a;
                     |HAZ GraTmpCuadre;
                  |FINSI;
                  |LIBERA #caenlac@;
                  |REPON_FICHA #caenlac@;
               |FINSI;
               |LIBERA #Referen@;
               |LEE 101#Referen@.s; NumRegistro = NumRegistro + 1;
            |SIGUE;

            |CIERRA #agifa712;
            nImpCuadre = 0; |BUCLE ImpCuadre;
            |DELINDEX #agifa712;
         |FINSI;

         nImpCuadre = nImpCuadre ! 2;

         |SI nImpCuadre ! 0; |Y eaCuaAuto ! "N";
            nDiario1 = #caenlac@#0; fFecha1  = #caenlac@#1;
            nDocum1  = #caenlac@#2; nApunt1  = #caenlac@#3;
            aCtaAn   = #caenlac@#39;
            |SALVA_FICHA #caenlac@;

            enImporte = nImpCuadre ! 2;
            enDiario  = #caenlac@#0;
            efFecha   = #caenlac@#1;
            enDocum   = #caenlac@#2;
            enApunt   = #caenlac@#3;
            enEmpresa = #caenlac@#37; enPeriodo = #caenlac@#38;

            |SI eaCuaAuto = "S"; |HAZ Rectifica; |FINSI;
            |SI enImporte ! 0; |Y eaCuaAuto = "I";
               aBusca = "B"; |BUCLE BuscaLinea;
               |SI #caenlac@#26 = "B"; |O #caenlac@#26 = "b";
                  |LEE 101#caenlac@.=;
                  |SI #caenlac@#8 = "D";
                     #caenlac@#9 = #caenlac@#9 - nImpCuadre;
                  |SINO;
                     #caenlac@#9 = #caenlac@#9 + nImpCuadre;
                  |FINSI;
                  #caenlac@#48 = #agifa704#19;
                  |GRABA 020#caenlac@.a; |LIBERA #caenlac@;
                  |HAZ GraTmpCuadre;
               |SINO;
                  aBusca = "I"; |BUCLE BuscaLinea;
                  |SI #caenlac@#26 = "I";
                     |LEE 101#caenlac@.=;
                     |SI #caenlac@#8 = "D";
                        #caenlac@#9 = #caenlac@#9 - nImpCuadre;
                     |SINO;
                        #caenlac@#9 = #caenlac@#9 + nImpCuadre;
                     |FINSI;
                     #caenlac@#48 = #agifa704#19;
                     |GRABA 020#caenlac@.a; |LIBERA #caenlac@;
                     |HAZ GraTmpCuadre;
                  |SINO;
                     aBusca = "F"; |BUCLE BuscaLinea;
                     |SI #caenlac@#26 = "F";
                        |LEE 101#caenlac@.=;
                        |SI #caenlac@#8 = "D";
                           #caenlac@#9 = #caenlac@#9 - nImpCuadre;
                        |SINO;
                           #caenlac@#9 = #caenlac@#9 + nImpCuadre;
                        |FINSI;
                        #caenlac@#48 = #agifa704#19;
                        |GRABA 020#caenlac@.a; |LIBERA #caenlac@;
                        |HAZ GraTmpCuadre;
                     |FINSI;
                  |FINSI;
               |FINSI;
            |FINSI;
            |LEE 000#caenlac@.p;
            |REPON_FICHA #caenlac@;
         |FINSI;

         nImpCuadre = 0;

         |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FC";
            |SI #agifa704#8 = "S";
               |SI aVersion ] "9.10V";
                  |SELECT #2#Referen@;
               |SINO;
                  |SELECT #1#Referen@;
               |FINSI;
            |FINSI;
         |FINSI;
         |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
      |FINSI;
   |SINO;
      |MENAV "    Seleccion vacia";
   |FINSI;

   |ET Final;
   |POPV;


   |SI #agifa704#8 ! "S"; |BUCLE agifa727; |FINSI;

   |DBASE Comodin; |QBF Comodin;
   Comodin2 = Usuario; |QBF Comodin2;
   Comodin1 = Comodin + "def/sq" + Comodin2 + ".mas"; |FBORRA Comodin1;
   |DFICE Comodin; |QBF Comodin;
   Comodin1 = Comodin + "sq" + Comodin2 + ".dat"; |FBORRA Comodin1;
   Comodin1 = Comodin + "sq" + Comodin2 + ".ddx"; |FBORRA Comodin1;
   Comodin1 = Comodin + "sq" + Comodin2 + ".ixx"; |FBORRA Comodin1;
   |CIERRA #Princip@; |DESCARGA_DEF #Princip@;

   |DFICE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "Qu" + Usuario + ".txt"; |FBORRA aAlfa;
|FPRC;

|DEFBUCLE Asientos;
     #agifa705#1;
     ;
     CodEnlace,000001;
     CodEnlace,999999;
     ;
     NULL, Asientos;
|FIN;


|PROCESO ImprimeErr;
   aMensaje = #agifa712#0 + "/" + #agifa712#1 + "/" + #agifa712#2;
   aMensaje = aMensaje + " " + (#agifa712#7 + (" " * 30)) % 0130;
   nCalc2 = #agifa712#9 ! 2;
   aMensaje = aMensaje + " " + nCalc2;
   |IMPRIME aMensaje;
|FPRC;

|DEFBUCLE ImprimeErr;
#agifa712#1;
15;
00,"01.01.0000",000000,0000,00000,0,"*";
99,"31.12.9999",999999,9999,99999,9,"*";
;
NULL,ImprimeErr;
|FIN;

|PROCESO MiraSiDesc;
     |SI #caenlac@#8 = "D";
          nSaldo = (nSaldo - #caenlac@#9) ! 2; || 5;
     |FINSI;
     |SI #caenlac@#8 = "H";
          nSaldo = (nSaldo + #caenlac@#9) ! 2; || 5;
     |FINSI;
|FPRC;

|DEFBUCLE MiraSiDesc;
     #caenlac@#1006;
     ;
     #agifa712#0, #agifa712#1, #agifa712#2, 0000, #agifa712#12, #agifa712#13;
     #agifa712#0, #agifa712#1, #agifa712#2, 9999, #agifa712#12, #agifa712#13;
     ;
     NULL,MiraSiDesc;
|FIN;

|PROCESO RepasaLog;
     aAlfa = #agifa712#7; |QBF aAlfa;
     |SI nDi ! #agifa712#0; |O fFe ! #agifa712#1; |O nDo ! #agifa712#2;
               |O nEm ! #agifa712#12; |O nPe ! #agifa712#13;
          nDi = #agifa712#0;
          fFe = #agifa712#1;
          nDo = #agifa712#2;
          nEm = #agifa712#12;
          nPe = #agifa712#13;
          nSaldo = 0; |BUCLE MiraSiDesc;
          nSaldo = nSaldo ! 2;
     |FINSI;
     |SI nSaldo = 0;
          #agifa712#15 = " ";
     |SINO;
          #agifa712#15 = "*"; nAsError = 1;
     |FINSI;
     |GRABA 020#agifa712.a;
|FPRC;

|DEFBUCLE RepasaLog;
     #agifa712#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL,RepasaLog;
|FIN;

|PROCESO ElimHist;
   |BORRA 020#agifa722.a;
|FPRC;

|DEFBUCLE ElimHist;
#agifa722#1;
;
#agifa704#2, aCmp1, aCmp2, aCmp3, 000000, nCmp1, nCmp2;
#agifa704#2, aCmp1, aCmp2, aCmp3, 999999, nCmp1, nCmp2;
be;
NULL,ElimHist;
|FIN;

|PROCESO LineasLog;
   |DDEFECTO #agifa712;
   #agifa712#0  = #caenlac@#0;
   #agifa712#1  = #caenlac@#1;
   #agifa712#2  = #caenlac@#2;
   #agifa712#3  = #caenlac@#3;
   #agifa712#4  = #caenlac@#4;
   #agifa712#5  = #caenlac@#5;
   #agifa712#6  = #caenlac@#6;
   #agifa712#7  = #caenlac@#7;
   #agifa712#8  = #caenlac@#8;
   #agifa712#9  = #caenlac@#9;
   #agifa712#10 = #caenlac@#16;
   #agifa712#11 = #caenlac@#16;
   #agifa712#12 = #caenlac@#37;
   #agifa712#13 = #caenlac@#38;
   #agifa712#14 = #caenlac@#15;
   aAlfa = #caenlac@#18; |QBF aAlfa;
   |SI #agifa712#9 ! 0; |Y aAlfa ! "S";
      |GRABA 020#agifa712.n;
   |FINSI;

   |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
      ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
      ICmpEmpresa   = CmpEmpresa1<-;   ICmpEmpresa   = ICmpEmpresa   + Cont;
      ICmpPeriodo   = CmpPeriodo1<-;   ICmpPeriodo   = ICmpPeriodo   + Cont;
      IClave1Cab    = Clave1Cab1<-;    IClave1Cab    = IClave1Cab    + Cont;
      IClave2Cab    = Clave2Cab1<-;    IClave2Cab    = IClave2Cab    + Cont;
      ICampo3Clave  = Campo3Clave1<-;  ICampo3Clave  = ICampo3Clave  + Cont;
      IContabil     = Contabil1<-;     IContabil     = IContabil     + Cont;

      aAlfa = #caenlac@#18; |QBF aAlfa;
      |SI PRMNT_enError = 0;
         ||SI #agifa704#8 ! "S"; ¨ Por que no se han de marcar las facturas en
         ||                        los enlaces por familias como contabilizadas ?
            |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FC"; |O #agifa704#2 = "FD"; |O #agifa704#2 = "TI";
               aAlfa = "|NC"; aAlfa = #caenlac@#aAlfa#; Calc = aAlfa;
               |SI Calc > 46;
                  aSerieF = #caenlac@#46;
                  nNumFra = #caenlac@#47;
               |SINO;
                  aSerieF = #caenlac@#12;
                  nNumFra = #caenlac@#13;
               |FINSI;
               Calc2 = Clave1Cab;   Calc3 = Clave2Cab;

               Calc = Contabil;
               #Princip@#Calc2# = aSerieF;
               #Princip@#Calc3# = nNumFra;
               |LEE 101#Princip@.=;
               |SI FSalida = 0; |Y #Princip@#Calc# = "N";
                  Calc = Contabil; #Princip@#Calc# = "S";
                  aAlfa = #caenlac@#18; |QBF aAlfa;
                  |SI aAlfa ! "S";
                         |GRABA 020#Princip@.a;

                         eaSerFac = aSerieF;
                         enNumFac = nNumFra;
                         |HAZ TallerMarcaVO;

                         |SI nSwTagloma = 0; |Y enSwAgifa079 ! 0;
                              efFecCta = #caenlac@#1;
                              |SUB_EJECUTA_NP "tagz0027;EFC";
                         |FINSI;
                  |FINSI;
                  |LIBERA #Princip@;

                  ||TODO CCC.  Para poner si corresponde en la aplicacion origen
                  ||si es un CLONADO a la dscomer9. el campo CONTABILIZADO a "S".
                  |SI #agifa704#2 = "FV";
                       enEmpresaOriClon = #Princip@#116; ||SOLO para Artenvas
                       eaSerieOriClon = aSerieF;
                       enNumFraOriClon = nNumFra;
                       |HAZ PonContabilizadoSIClon;
                  |FINSI;
               |FINSI;
            |SINO;
               aAlfa = "|NC"; aAlfa = #caenlac@#aAlfa#; Calc = aAlfa;
               |SI Calc > 46;
                  aSerieF = #caenlac@#46;
                  nNumFra = #caenlac@#47;
               |SINO;
                  aSerieF = #caenlac@#12;
                  nNumFra = #caenlac@#13;
               |FINSI;
               |DDEFECTO #agifa727;
               |SI #agifa704#2 = "FC";
                  #agifa727#0 = "C";
               |SINO;
                  #agifa727#0 = "V";
               |FINSI;
               #agifa727#1 = aSerieF;
               #agifa727#2 = nNumFra;
               |LEE 000#agifa727.=;
               |SI FSalida ! 0;
                  |DDEFECTO #agifa727;
                  |SI #agifa704#2 = "FC";
                     #agifa727#0 = "C";
                  |SINO;
                     #agifa727#0 = "V";
                  |FINSI;
                  #agifa727#1 = aSerieF;
                  #agifa727#2 = nNumFra;
                  Calc = Contabil; #agifa727#3 = Calc;
                  |GRABA 020#agifa727.n;
               |FINSI;
            |FINSI;
         ||FINSI;

         |SI #agifa704#2 = TiposEnlaces; |SAL; |FINSI;
      |SINO;
         |SI #agifa704#2 = "FV"; |O #agifa704#2 = "FC"; |O #agifa704#2 = "FD";
            aAlfa = "|NC"; aAlfa = #caenlac@#aAlfa#; Calc = aAlfa;
            |SI Calc > 46;
               aSerieF = #caenlac@#46;
               nNumFra = #caenlac@#47;
            |SINO;
               aSerieF = #caenlac@#12;
               nNumFra = #caenlac@#13;
            |FINSI;
            Calc2 = Clave1Cab;   Calc3 = Clave2Cab;

            Calc = Contabil;
            #Princip@#Calc2# = aSerieF;
            #Princip@#Calc3# = nNumFra;
            |LEE 000#Princip@.=;
            |SI FSalida = 0; |Y #Princip@#Calc# = "N";
               aCmp1 = aSerieF; |QBF aCmp1; aCmp1 = aCmp1 + ((" " * 10) % 0110);
               aCmp2 = nNumFra; |QBF aCmp2; aCmp2 = aCmp2 + ((" " * 10) % 0110);
               nCmp1 = Campo3Clave;
               aCmp3 = #Princip@#nCmp1#; |QBF aCmp3;
               aCmp3 = aCmp3 % -104;
               |QBF aCmp3; aCmp3 = aCmp3 + ((" " * 10) % 0110);
               nCmp1 = #caenlac@#37; nCmp2 = #caenlac@#38;
               |BUCLE ElimHist;
            |FINSI;
         |FINSI;
         |SI #agifa704#2 = TiposEnlaces; |SAL; |FINSI;
      |FINSI;
   |SIGUE;
|FPRC;

|DEFBUCLE LineasLog;
#caenlac@#1006;
;
00,"00.00.0000",000001,0001,00000,0;
99,"31.12.2999",999999,9999,99999,9;
;
NULL,LineasLog;
|FIN;

|PROCESO RellenaAcot;
   |DDEFECTO #agifa716;
   |PARA Cont = 0; |SI Cont [ 17; |HACIENDO Cont = Cont + 1;
      #agifa716#Cont# = #agifa707#Cont#;
   |SIGUE;
   |SI #agifa707#11 = "F";
      fFechaAcot1 = #agifa707#7; fFechaAcot2 = ~;
      aAlfa = fFechaAcot2; aAlfa = aAlfa % -104; nCalc = aAlfa;
      nCalc = nCalc - 6;
      aAlfa = fFechaAcot2; aAlfa = (aAlfa % 0106) + nCalc;
      fFechaAcot2 = aAlfa;
      |SI fFechaAcot1 < fFechaAcot2;
         #agifa716#7 = fFechaAcot2;
         #agifa716#9 = fFechaAcot2;
      |FINSI;
   |FINSI;
   |GRABA 020#agifa716.n;
|FPRC;

|DEFBUCLE RellenaAcot1;
#agifa707#2;
;
CodEnlace,"S",001;
CodEnlace,"S",999;
;
NULL,RellenaAcot;
|FIN;

|DEFBUCLE RellenaAcot2;
#agifa707#2;
;
CodEnlace,"N",001;
CodEnlace,"N",999;
;
NULL,RellenaAcot;
|FIN;

|PROGRAMA;
   |HAZ Parametros2;
   |HAZ CogeVersion;
   enGenAsi0   = 0;
   enGenIva0   = 1;
   |HAZ RecogeParametros;

   |HAZ EsSematel
   |SI FSalida = 0;
      nSwSematel = 1;
   |SINO;
      nSwSematel = 0;
   |FINSI;

   |HAZ EsPalmHotel;
   |SI FSalida = 0;
      nSwPalmHoteles = 1;
   |SINO;
      nSwPalmHoteles = 0;
   |FINSI;

   |HAZ EsGuerola;
   |SI FSalida = 0;
      enSwExport = 1;
   |SINO;
      enSwExport = 0;
   |FINSI;

   |HAZ EsTaller; enSwTaller = FSalida;
   |HAZ EsTagloma; nSwTagloma = FSalida;

   nIdPalm = 0;
   Comodin = PARAMETRO; |QBF Comodin;
   Comodin = Comodin - ":PALM";
   |SI FSalida ! 0;
      |SI nSwPalmHoteles = 1; nIdPalm = 1; |FINSI;
      PARAMETRO = Comodin;
   |FINSI;

   |DDEF Comodin; |QBF Comodin;
   Comodin2 = Usuario; |QBF Comodin2;
   Comodin1 = Comodin + "sq" + Comodin2 + ".mas"; |FBORRA Comodin1;

   aVersion = ""; |VERSIONRTME aVersion; |QBF aVersion;

   |SI enFactura116 = 0;
      nLinPinta = 22;
   |SINO;
      nLinPinta = 26;
   |FINSI;

   |HAZ CogeDefectos;

   nContador = 0;
   |SI PARAMETRO ! "";
      aAlfa = PARAMETRO; aAlfa = aAlfa - ",SINPRELV";
      |SI FSalida ! 0;
         nSinPrelv = 1;
      |FINSI;

      CodEnlace = PARAMETRO; aAlfa = CodEnlace;

      CodEnlace = CodEnlace - ",CAJA";
      |SI FSalida ! 0; nCaja = 1; |SINO; nCaja = 0; |FINSI;

      CodEnlace = CodEnlace - "*";
      |SI FSalida ! 0;
         Calc = FSalida + 3;
         Comodin = CodEnlace % Calc;
         CodEnlace = CodEnlace - Comodin;
         nAnyo = Comodin;
      |SINO;
         fFecha2 = ~; aAlfa = fFecha2; |QBF aAlfa;
         aAlfa = aAlfa % -104; nAnyo = aAlfa;
      |FINSI;
      CodEnlace = CodEnlace - "|";
      |SI FSalida ! 0;
         Calc = (((FSalida / 100) ! 0) * 100) + 99;
         PathAplic = CodEnlace % Calc;
         CodEnlace = CodEnlace - PathAplic;
      |SINO;
         |DFICE PathAplic;
      |FINSI;
      eaPathAplic = PathAplic; |HAZ MiraSiCuaAuto;
      |PATH_DAT #13 PathAplic;  |PATH_DAT #2 PathAplic; |PATH_DAT #3 PathAplic;
      |PATH_DAT #100 PathAplic; |PATH_DAT #101 PathAplic;
      CodEnlace = CodEnlace - ",B";
      |SI FSalida ! 0; Modo = "B"; |FINSI;

      |ABRE #agifa007; |ABRE #agifa722;
      |ABRE #agifa321; |ABRE #agifa324;
      |ABRE #agifa704;
      #agifa704#0 = CodEnlace;
      |LEE 000#agifa704.=;
      |SI FSalida = 0;
         PathEnlace = #agifa704#6;
         #agifa711#0 =#agifa704#0;
         #agifa711#1 =#agifa704#1;
         #agifa711#4 =#agifa704#4;
         #agifa711#5 =#agifa704#5;
         #agifa711#6 =#agifa704#14;
         nSwError = 0; |HAZ MiraEmp;

         |SI #agifa704#18 ! "A";
            |SI efFechaForm ! "01.01.0000"; |Y efFechaForm ! "00.00.0000";
               #agifa711#8 = efFechaForm;
            |FINSI;
         |FINSI;
      |FINSI;
      |CIERRA #agifa704;
      |SI nSwError ! 0;
         PRMNT_enError = -1;
         |CIERRA #agifa007; |CIERRA #agifa722;
         |CIERRA #agifa321; |CIERRA #agifa324; |ACABA;
      |FINSI;

      FSalida = 0;
   |SINO;
      fFecha2 = ~; aAlfa = fFecha2; |QBF aAlfa;
      aAlfa = aAlfa % -104; nAnyo = aAlfa;
      |DFICE PathAplic; eaPathAplic = PathAplic; |HAZ MiraSiCuaAuto;
      |ABRE #agifa007; |ABRE #agifa722;
      |ABRE #agifa321; |ABRE #agifa324;
      |CLS;
      |PINPA #0#0; |PINDA #0#0;
      |ENDATOS #1#agifa711;
   |FINSI;

   |SI FSalida = 0;
      |SI #agifa704#8 = "N";
         |SI #agifa704#2 = "FV";
            Ficheros1 = "agifa134";   || Facturas de venta
            nAsiento1 = 39; Ser1 = 49;
            Campo1Clave1 = 49; Campo2Clave1 = 0; Campo3Clave1 = 1;
         |FINSI;
         |SI #agifa704#2 = "FC";
            Ficheros2 = "agifa079";   || Facturas de compra
            nAsiento2 = 39; Ser2 = 66;
            Campo1Clave2 = 66; Campo2Clave2 = 0; Campo3Clave2 = 1;
         |FINSI;
      |SINO;
         |SI #agifa704#2 = "FV";
            Ficheros1 = "agifa071";   || Albaranes de venta
            nAsiento1 = 54; Ser1 = 29;
            Campo1Clave1 = 30; Campo2Clave1 = 26; Campo3Clave1 = 1;
         |FINSI;
         |SI #agifa704#2 = "FC";
            Ficheros2 = "agifa080";   || Albaranes de compra
            nAsiento2 = 39; Ser2 = 27;
            Campo1Clave2 = 28; Campo2Clave2 = 25; Campo3Clave2 = 1;
         |FINSI;
      |FINSI;
      |SI PARAMETRO = "";
         CodEnlace = #agifa711#0;
         Comodin2 = Usuario; |QBF Comodin2; Comodin2 = "ac" + Comodin2;
         |NOME_DAT #5 Comodin2;
         |DELINDEX #agifa716; |ABRE #agifa716;
         |BUCLE RellenaAcot1;
         |PARA; |SI; |HACIENDO;
            |PTEC 808;
            |PINPA #0#agifa716;
            |ENTLINEAL #2#agifa716,-3,1,21,0,infe1,supe1;
            |MENU Menu;
            Opcion = FSalida;
            |SI Opcion = 2; Salir = 0; |SAL; |FINSI;
            |SI Opcion = 3; Salir = 1; |SAL; |FINSI;
         |SIGUE;
         |BUCLE RellenaAcot2;
         |CIERRA #agifa716;
      |SINO;
         |HAZ TomaDefectos;
      |FINSI;

      |SI Salir = 1; |ACABA; |FINSI;

      |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
         ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
         IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
         |SI #agifa704#2 = TiposEnlaces;
            Fich1 = Ficheros;
            |SAL;
         |FINSI;
      |SIGUE;

      Comodin  = PathEnlace; |QBF Comodin; Comodin  = Comodin + "def/";
      Comodin1 = Comodin + "canempre.mas";
      |XABRE "E", Comodin1, nHandle1;
      |SI FSalida ] 0;
         |DBASE Direc;
         Comodin = Direc + "def/" + Fich1 + ".mas";
         |CARGA_DEF Comodin, Tempo00@;
         |SI FSalida = 0;
            Comodin  = PathEnlace; |QBF Comodin; Comodin  = Comodin + "def/";
            Comodin1 = Comodin + "caenlace.mas"; |CARGA_DEF Comodin1, caenlac@;
            Comodin1 = Comodin + "caconasi.mas"; |CARGA_DEF Comodin1, caconas@;
            Comodin1 = Comodin + "camaasic.mas"; |CARGA_DEF Comodin1, camasic@;
            Comodin2 = ("00000" + #agifa711#4) % -105;
            Comodin2 = Comodin2 + #agifa711#5 + "/";
            Comodin1 = PathEnlace; |QBF Comodin1;
            Comodin1 = Comodin1 + "fich/" + Comodin2; eaPath = Comodin1;
            |PATH_DAT #23 Comodin1; |PATH_DAT #24 Comodin1; |PATH_DAT #27 Comodin1;

            eaRuta = Comodin1;
            eaDef = Comodin;
            |HAZ Inicia732;

            |HAZ InicializaTmpAlbaranes;

            aNome = Usuario; |QBF aNome; aNome = "pu" + aNome;
            |NOME_DAT #23 aNome; eaFich = aNome;

            Comodin2 = Usuario; |QBF Comodin2; Comodin2 = "27" + Comodin2;
            |NOME_DAT #1000 Comodin2; |DELINDEX #agifa727; |ABRE #agifa727;

            |DELINDEX #caenlac@; |ABRE #caenlac@;
            |ABRE #caconas@; |ABRE #camasic@;

            NumAsientos = -1; NumApunte = 1; NumAsto = 0;
            nHayPortes = 0; nHayVarios = 0;

            aAlfa = #agifa704#6; |QBF aAlfa;
            aAlfa = aAlfa + "def/capaclpr.mas";
            |CARGA_DEF aAlfa, RegNifs@;
            |SI FSalida = 0; nSwRegNif = 1; |FINSI;

            |BUCLE Asientos;          ||  MEOLLO !!!!!!!!! .......
/*
|CONSULTA_CLAVE #1#RegNifs@;
*/
            |SI nSwRegNif ! 0; |CIERRA #RegNifs@; |DESCARGA_DEF #RegNifs@; |FINSI;
/*
|CONSULTA_CLAVE #1#caenlac@;
*/
            |SI nErrContador ! 0;
               nSigue = 0;
               |LEE 000#caenlac@.p;
               |SI FSalida = 0;
                  |CONFI "    NProblemas con el contador de contabilidad. ¿ Enlazar lo que hay preparado ?";
                  |SI FSalida = 0;
                     nSigue = 1;
                     Comodin2 = ("00000" + #agifa711#4) % -105;
                     Comodin2 = Comodin2 + #agifa711#5 + "/";
                     fich_alta = Comodin2;

                     eaEmpProced = " Empresa (" + #48#0 + ") ";
                     eaEmpProced = eaEmpProced + #48#1; |QBF eaEmpProced;
                     Comodin = PathEnlace; |QBF Comodin;
                     Comodin = Comodin - "agicont";
                     |SI FSalida = 0;
                        Comodin = PathEnlace; |QBF Comodin;
                        Comodin = ":contagen/dsapunte.tab;" + Comodin;
                     |SINO;
                        Comodin = PathEnlace; |QBF Comodin;
                        Comodin = ":agicont/dsapunte.tab;" + Comodin;
                     |FINSI;
                     Comodin2 = ("00000" + #agifa711#4) % -105;
                     Comodin2 = Comodin2 + #agifa711#5 + "/";
                     Comodin = Comodin + "fich/" + Comodin2 + "," + aNome;
                     Comodin = Comodin < Comodin;
                     |SI enNoModif = 0; enNoModif = 100; |FINSI;
                     |CIERRA #caenlac@;
                     |HAZ Renumera;
                     |SUB_EJECUTA_NP Comodin;
                     |ABRE #caenlac@; |LEE 000#caenlac@.c;
                  |FINSI;
               |SINO;
                  |MENAV "    Problemas con el contador de contabilidad. Proceso abortado";
                  nSigue = 0;
               |FINSI;
            |SINO;
               Comodin2 = ("00000" + #agifa711#4) % -105;
               Comodin2 = Comodin2 + #agifa711#5 + "/";
               fich_alta = Comodin2;

               nSwPCEG = 0;
               |HAZ EsPCEGroup;
               |SI FSalida = 0;
                  enSw = 0; |HAZ MiraSiActCtas;
                  |SI enSw = 1;
                     PRMNT_enSwPCEG = 1;
                  |SINO;
                     PRMNT_enSwPCEG = 0;
                  |FINSI;
                  nSwPCEG = 1;
               |SINO;
                  PRMNT_enSwPCEG = 0;
                  nSwPCEG = 0;
               |FINSI;

               eaEmpProced = " Empresa (" + #48#0 + ") ";
               eaEmpProced = eaEmpProced + #48#1; |QBF eaEmpProced;
               Comodin = PathEnlace; |QBF Comodin;
               Comodin = Comodin - "agicont";
               |SI FSalida = 0;
                  Comodin = PathEnlace; |QBF Comodin;
                  Comodin = ":contagen/dsapunte.tab;" + Comodin;
               |SINO;
                  Comodin = PathEnlace; |QBF Comodin;
                  Comodin = ":agicont/dsapunte.tab;" + Comodin;
               |FINSI;
               Comodin2 = ("00000" + #agifa711#4) % -105;
               Comodin2 = Comodin2 + #agifa711#5 + "/";
               Comodin = Comodin + "fich/" + Comodin2 + "," + aNome;
               Comodin = Comodin < Comodin;
               |SI enNoModif = 0; enNoModif = 100; |FINSI;
               |CIERRA #caenlac@;
               |HAZ Renumera;
               |SUB_EJECUTA_NP Comodin;
               |ABRE #caenlac@; |LEE 000#caenlac@.c;
               nSigue = 1;
            |FINSI;
            Comodin2 = Usuario; |QBF Comodin2; Comodin2 = "12" + Comodin2;
            |NOME_DAT #1 Comodin2;
            |DELINDEX #agifa712;

            |SI nSigue = 1;
               |DBASE Comodin; |QBF Comodin;
               Comodin = Comodin + "def/";
               |SI #agifa704#2 = "FV"; Comodin = Comodin + FichCab1 + ".mas"; |FINSI;
               |SI #agifa704#2 = "FC"; Comodin = Comodin + FichCab2 + ".mas"; |FINSI;
               |SI #agifa704#2 = "FD"; Comodin = Comodin + FichCab3 + ".mas"; |FINSI;
               |SI #agifa704#2 = "TI"; Comodin = Comodin + FichCab4 + ".mas"; |FINSI;
               |SI #agifa704#2 = "CC"; Comodin = Comodin + FichCab5 + ".mas"; |FINSI;
               |SI #agifa704#2 = "CR"; Comodin = Comodin + FichCab6 + ".mas"; |FINSI;
               |CARGA_DEF Comodin, Princip@;
               |ABRE #Princip@; |ABRE #agifa712;
               nAsError = 0;

               |BUCLE LineasLog;

               |BUCLE RepasaLog;

               |VERSIONRTME aAlfa;
               aAlfa1 = aAlfa - "9.10";
               |SI FSalida ! 0;
                  aAlfa = aAlfa % -101;
                  |SI aAlfa < "T";
                     PRMNT_enError = 0;
                  |SINO;
                     nAsError = 0;
                  |FINSI;
               |SINO;
                  PRMNT_enError = 0;
               |FINSI;

               |SI nAsError = 1;
                  aAlfa = "0000SSe han encontrado asientos descuadrados." + &13+ "¿ Desea listarlos ? ";
                  |CONFI aAlfa;
                  |SI FSalida = 0;
                      FSalida = 1;
                      |PARA; |SI FSalida ! 0; |HACIENDO; |IMPRE 0; |SIGUE;
                      aMensaje = " " + ("*" * 78); |IMPRIME aMensaje;
                      aMensaje = "      LISTADO DE ASIENTOS NO CONTABILIZADOS POR UBICACION IMPOSIBLE     ";
                      |IMPRIME aMensaje;
                      aMensaje = " " + ("*" * 78); |IMPRIME aMensaje;
                      aMensaje = ""; |IMPRIME aMensaje;
                      aMensaje = " Asiento              Descripcion                    Importe     ";
                      |IMPRIME aMensaje;
                      aMensaje = " ----------------------------------------------------------------";
                      |IMPRIME aMensaje;
                      |BUCLE ImprimeErr;
                      |FINIMP;
                  |FINSI;
               |FINSI;
               |CIERRA #agifa712;
               |CIERRA #Princip@; |DESCARGA_DEF #Princip@;
            |FINSI;
            |CIERRA #caconas@; |DESCARGA_DEF #caconas@;
            |CIERRA #caenlac@; |DESCARGA_DEF #caenlac@;
            |HAZ Finaliza732;
            |HAZ InicializaTmpAlbaranes;

            |SI PARAMETRO = ""; |Y PRMNT_enError = 0;
               ||ENTLINEAL #1#agifa712,-4,1,21,1,inferior,superior;
               |ENTLINEAL #1#agifa712,-1,4,21,1,inferior,superior;
            |FINSI;


            |DESCARGA_DEF #Tempo00@;

            |HAZ EsPCEGroup;
            |SI FSalida = 0; |Y PRMNT_enError = 0;
               |SUB_EJECUTA "pcegz101.tab";
               |SUB_EJECUTA "pcegz102.tab";
            |FINSI;
         |FINSI;
      |SINO;
         aAlfa = "    No hay contabilidad en el directorio indicado en el enlace " + #agifa704#0;
         |MENAV aAlfa;
      |FINSI;
      |CIERRA #agifa722; |CIERRA #agifa007; |CIERRA #agifa727;
      |CIERRA #agifa324; |CIERRA #agifa321;
   |FINSI;


   efFechaForm = "01.01.0000";

   PRMNT_enLuxeRec = 0;
|FPRO;
