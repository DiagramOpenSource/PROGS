|FICHEROS;
  bsem0002 #1; || vinos001 #1;
  bsem0003 #2; || vinos002 #2;
  bsem0004 #0; || vinos003 #0;;
  agifa019 #19;
  agifa048 #148;
  agifa049 #49;
  agifa017 #17;
  agifa029 #29;
|FIN;

|VARIABLES;
     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;

     otroscostes = 0;
        nLinea  = 0;
        aAlfa1  = "";
        CabExito= "N";
        i       = 0;
        x       = 0;
        salida  = 0;
        calpre  = 0;
     &nDeci_PreDiv  = 0;
     &nDeci_Base = 0;
     &nDeci_PreBase = 0;
     cambio_div = 0;
     cambio_base = 0;
     factordec = 0;
     tpcontro  = 0;  ||Controla si se han modificado los campos que afectan a tarifas-proveedor
     m1        = 0;
     m2        = 0;
     m3        = 0;
     m4        = 0;
     m5        = 0;
     m6        = 0;
     precio    = 0;
     a          = 0;
     nAcum     = 0;
     informe = "bsem0004"; || -> "vinos001";
     infreal = "agifa048";
  {-1}menu = "";
  menu1 = "2400";
  menu2 = "0";
  menu3 = "Imprimir : ";
  menu4 = "RVA";
  menu5 = "Reales";
  menu6 = "Vinos";
  menu7 = "Ambos";
  Sw = 0;
  &w
  &wtip = 0;
|FIN;

|CAMPOS;
     #19#18 pvp11;
     #19#19 pvp22;
     #19#20 pvp33;
     #19#147 pvp44;
     #19#148 pvp55;
     #19#149 pvp66;
     #19#109 redo;
     #19#18 pvp1;   ||Para redondeos segun variable de divisas
     #19#19 pvp2;
     #19#20 pvp3;
     #19#147 pvp4;
     #19#148 pvp5;
     #19#149 pvp6;
|FIN;

|CALCULO pvp;
     |SI #0#21 =  "S";|O #0#21 = "G";
          precio = #19#9;
          |SI #19#108 = "S";
               |SI #19#105 ! 0; pvp1 = precio > #19#105; |FINSI;
               |SI #19#106 ! 0; pvp2 = precio > #19#106; |FINSI;
               |SI #19#107 ! 0; pvp3 = precio > #19#107; |FINSI;
               |SI #19#156 ! 0; pvp4 = precio > #19#156; |FINSI;
               |SI #19#157 ! 0; pvp5 = precio > #19#157; |FINSI;
               |SI #19#158 ! 0; pvp6 = precio > #19#158; |FINSI;
          |SINO;
               |SI #19#105 ! 0; pvp1 = (precio * 100) / (100 - #19#105); |FINSI;
               |SI #19#106 ! 0; pvp2 = (precio * 100) / (100 - #19#106); |FINSI;
               |SI #19#107 ! 0; pvp3 = (precio * 100) / (100 - #19#107); |FINSI;
               |SI #19#156 ! 0; pvp4 = (precio * 100) / (100 - #19#156); |FINSI;
               |SI #19#157 ! 0; pvp5 = (precio * 100) / (100 - #19#157); |FINSI;
               |SI #19#158 ! 0; pvp6 = (precio * 100) / (100 - #19#158); |FINSI;
          |FINSI;
     ||****************** 07-07-98 JUAN
          enTiva = #19#30;
          efFiva = ~;
          |HAZ SacaIVA;

          |SI #19#130 = "S"; |Y #19#105 ! 0; pvp1 = pvp1 > enIva; |FINSI;
          |SI #19#131 = "S"; |Y #19#106 ! 0; pvp2 = pvp2 > enIva; |FINSI;
          |SI #19#132 = "S"; |Y #19#107 ! 0; pvp3 = pvp3 > enIva; |FINSI;
          |SI #19#153 = "S"; |Y #19#156 ! 0; pvp4 = pvp4 > enIva; |FINSI;
          |SI #19#154 = "S"; |Y #19#157 ! 0; pvp5 = pvp5 > enIva; |FINSI;
          |SI #19#155 = "S"; |Y #19#158 ! 0; pvp6 = pvp6 > enIva; |FINSI;
     ||******************
          |SI redo > 0;
               |HAZ redondeo;
          |FINSI;
          pvp11 = pvp1;
          pvp22 = pvp2;
          pvp33 = pvp3;
          pvp44 = pvp4;
          pvp55 = pvp5;
          pvp66 = pvp6;
          |PINTA pvp11;
          |PINTA pvp22;
          |PINTA pvp33;
          |PINTA pvp44;
          |PINTA pvp55;
          |PINTA pvp66;
     |FINSI;
|FCAL;

|CALCULO redondeo;|TIPO 0;
     |SI redo > 1;
          factordec = 1; ||Necesario redondeo divisas
          |PARA i = 1;|SI i [ nDeci_PreBase;|HACIENDO i = i + 1;
             factordec = factordec * 10;
          |SIGUE;
          pvp1 = pvp1 * factordec;
          pvp2 = pvp2 * factordec;
          pvp3 = pvp3 * factordec;
          pvp4 = pvp4 * factordec;
          pvp5 = pvp5 * factordec;
          pvp6 = pvp6 * factordec;

          m1 = pvp1 $ redo;
          m2 = pvp2 $ redo;
          m3 = pvp3 $ redo;
          m4 = pvp4 $ redo;
          m5 = pvp5 $ redo;
          m6 = pvp6 $ redo;
          |SI m1 ! 0;
               pvp1 = pvp1 + redo - m1;
          |FINSI;
          |SI m2 ! 0;
               pvp2 = pvp2 + redo - m2;
          |FINSI;
          |SI m3 ! 0;
               pvp3 = pvp3 + redo - m3;
          |FINSI;
          |SI m4 ! 0;
               pvp4 = pvp4 + redo - m4;
          |FINSI;
          |SI m5 ! 0;
               pvp5 = pvp5 + redo - m5;
          |FINSI;
          |SI m6 ! 0;
               pvp6 = pvp6 + redo - m6;
          |FINSI;
          pvp1 = pvp1 / factordec;
          pvp2 = pvp2 / factordec;
          pvp3 = pvp3 / factordec;
          pvp4 = pvp4 / factordec;
          pvp5 = pvp5 / factordec;
          pvp6 = pvp6 / factordec;
     |FINSI;
|FCAL;


|PROCESO CreaArt;
        |ABRE #19;
        #19#0=#0#2;
        |LEE 000#19=;
        salida=FSalida;
        |SI FSalida ! 0;
          #19#1=#0#1;
          #19#2=#0#4;
          #19#3=#0#5;
          ||#19#9=#1#7;
          #19#133=#148#9; ||#1#7; ||Ult. precio compra
          #19#133 = #148#9;
          #19#30=#0#8;
          #19#105=#0#9;
          #19#106=#0#10;
          #19#107=#0#11;
          #19#108=#0#21;
          #19#114=#1#63;
          #19#123="N";
          #19#125=#0#3;
          #19#126=#0#6;
          #19#156=#0#12;
          #19#157=#0#13;
          #19#158=#0#14;
          #19#130=#0#15;
          #19#131=#0#16;
          #19#132=#0#17;
          #19#153=#0#18;
          #19#154=#0#19;
          #19#155=#0#20;
          #19#175=#0#7;
          |HAZ pvp;
        |FINSI;
        |SI salida=0;
          ||TONI
          #19#143 = #1#3;
          ||#19#9 = #1#3;
          #19#114 = #1#63;
          #19#133 = #148#9;  || Ult. precio compra
          #19#133 = #148#9;  || Ult. precio compra con dto.
          |HAZ pvp;
          |GRABA 020#19a;
        |SINO;
                |GRABA 020#19n;
        |FINSI;

        |ABRE #29;
        #29#0=#0#22;
        |LEE 000#29=;
        |ABRE #17;
        #17#0=#19#0;
        #17#1=#0#22;
        #17#40=#19#1;
        #17#41=#29#1;
        |LEE 010#17=;
        |SI FSalida = 0;
          |GRABA 010#17a;
        |SINO;
          |GRABA 020#17n;
        |FINSI;
        |CIERRA #19;

|FPRC;

|PROCESO CreaLin;
        nLinea=1;
                    otroscostes = 0;
        ||Crear las lineas de escandallo
        ||Primero incluimos los 5 vinos
        aAlfa1=#1#8;
        |QBT aAlfa1;
        |SI aAlfa1 ! "";
                #49#0=#148#0;
                #49#1=nLinea;
                #49#2=#1#8;
                #49#3=#1#9;
                #49#4=#1#17/100;  ||En las unidades ponemos el % para que se suponga que es
                                      ||la cantidad por hectólitro
                #49#5=#1#12;    ||Aquí pongo la p.prop. del precio por hectólitro
                otroscostes = otroscostes + ((#1#15+#1#14)*#1#17/100);
                #49#6= #49#4 * #49#5;
                #49#9=#0#22;
                #49#12 = #49#4;|| (Unidades multi)
                #49#15 = #49#5;|| (precio multi);
                |LEE 010#49=;
                |SI FSalida = 0;
                    |GRABA 020#49a;
                |SINO;
                    |GRABA 020#49n;
                |FINSI;
                nLinea=nLinea + 1;
                nAcum = nAcum + #49#6;
        |FINSI;
        aAlfa1=#1#19;
        |QBT aAlfa1;
        |SI aAlfa1 ! "";
                #49#0=#148#0;
                #49#1=nLinea;
                #49#2=#1#19;
                #49#3=#1#20;
                #49#4=#1#28/100;  ||En las unidades ponemos el % para que se suponga que es
                                      ||la cantidad por hectólitro
                #49#5=#1#23;    ||Aquí pongo la p.prop. del precio por hectólitro
                                        otroscostes = otroscostes + ((#1#26+#1#25)*#1#28/100);
                ||#49#5=#1#29;|| * 100;    ||Aquí pongo la p.prop. del precio por hectólitro
                #49#6= #49#4 * #49#5;
                #49#9=#0#22;
                #49#12 = #49#4;|| (Unidades multi)
                #49#15 = #49#5;|| (precio multi);
                |LEE 010#49=;
                |SI FSalida = 0;
                    |GRABA 020#49a;
                |SINO;
                    |GRABA 020#49n;
                |FINSI;
                nLinea=nLinea + 1;
                nAcum = nAcum + #49#6;
        |FINSI;
        aAlfa1=#1#30;
        |QBT aAlfa1;
        |SI aAlfa1 ! "";
                #49#0=#148#0;
                #49#1=nLinea;
                #49#2=#1#30;
                #49#3=#1#31;
                #49#4=#1#39/100;  ||En las unidades ponemos el % para que se suponga que es
                                      ||la cantidad por hectólitro
                #49#5=#1#34;    ||Aquí pongo la p.prop. del precio por hectólitro
                                        otroscostes = otroscostes + ((#1#37+#1#36)*#1#39/100);
                ||#49#5=#1#40;|| * 100;    ||Aquí pongo la p.prop. del precio por hectólitro
                #49#6= #49#4 * #49#5;
                #49#9=#0#22;
                #49#12 = #49#4;|| (Unidades multi)
                #49#15 = #49#5;|| (precio multi);
                |LEE 010#49=;
                |SI FSalida = 0;
                     |GRABA 000#49a;
                |SINO;
                     |GRABA 000#49n;
                |FINSI;
                nLinea=nLinea + 1;
                nAcum = nAcum + #49#6;
        |FINSI;
        aAlfa1=#1#41;
        |QBT aAlfa1;
        |SI aAlfa1 ! "";
                #49#0=#148#0;
                #49#1=nLinea;
                #49#2=#1#41;
                #49#3=#1#42;
                #49#4=#1#50/100;  ||En las unidades ponemos el % para que se suponga que es
                                      ||la cantidad por hectólitro
                #49#5=#1#45;    ||Aquí pongo la p.prop. del precio por hectólitro
                                        otroscostes = otroscostes + ((#1#48+#1#47)*#1#50/100);
                ||#49#5=#1#51;|| * 100;    ||Aquí pongo la p.prop. del precio por hectólitro
                #49#6= #49#4 + #49#5;
                #49#9=#0#22;
                #49#12 = #49#4;|| (Unidades multi)
                #49#15 = #49#5;|| (precio multi);
                |LEE 010#49=;
                |SI FSalida = 0;
                |GRABA 020#49a;
                |SINO;
                |GRABA 020#49n;
                |FINSI;
                nLinea=nLinea + 1;
                nAcum = nAcum + #49#6;
        |FINSI;
        aAlfa1=#1#52;
        |QBT aAlfa1;
        |SI aAlfa1 ! "";
                #49#0=#148#0;
                #49#1=nLinea;
                #49#2=#1#52;
                #49#3=#1#53;
                #49#4=#1#61/100;  ||En las unidades ponemos el % para que se suponga que es
                                      ||la cantidad por hectólitro
                #49#5=#1#56;    ||Aquí pongo la p.prop. del precio por hectólitro
                                        otroscostes = otroscostes + ((#1#59+#1#58)*#1#61/100);
                ||#49#5=#1#62;|| * 100;    ||Aquí pongo la p.prop. del precio por hectólitro
                #49#6= #49#4 * #49#5;
                #49#9=#0#22;
                #49#12 = #49#4;|| (Unidades multi)
                #49#15 = #49#5;|| (precio multi);
                |LEE 010#49=;
                |SI FSalida = 0;
                |GRABA 020#49a;
                |SINO;
                |GRABA 020#49n;
                |FINSI;
                nLinea=nLinea + 1;
                nAcum = nAcum + #49#6;
        |FINSI;
        ||Ahora creamos las líneas estandar
        |ABRE #2;
        #2#0=#1#0;
        |PARA i=1;|SI i[999;|HACIENDO i=i+1;
                #2#1=i;
                |LEE 000#2=;
                |SI FSalida ! 0;
                        |SAL;
                |SINO;
                        #49#0=#148#0;
                        #49#1=nLinea;
                        #49#2=#2#2;
                        #49#3=#2#3;
                        #49#4=#2#4/100;
                        #49#5=#2#5;
                        #49#6=#49#4*#49#5;
                        #49#9=#0#22;
                        ||#49#10 = 4; || en líneas no dsiminuye el stock
                        #49#12 = #49#4;|| (Unidades multi)
                        #49#15 = #49#5;|| (precio multi);
                        |LEE 010#49=;
                        |SI FSalida = 0;
                        |GRABA 020#49a;
                        |SINO;
                        |GRABA 020#49n;
                        |FINSI;
                        nLinea=nLinea + 1;
                        nAcum = nAcum + #49#6;
                |FINSI;
        |SIGUE;
        |ABRE #148;
        #148#0=#0#2;
        |LEE 000#148=;

        #148#8=nAcum;
        #148#4=otroscostes;     ||Otros costes
        #148#5 = #148#4 + #148#3 + #148#2;
        #148#11=#148#8 + #148#5;
        #148#9=#148#8 + #148#5;
        |GRABA 020#148a;
|FPRC;

|PROCESO CreaCab;

        |ABRE #148;  || escandallo real
        #148#0=#0#2;
        |LEE 000#148=;
        a=FSalida;
        |ABRE #19;
        #19#0=#0#2;
        |LEE 020#19=;
        #148#1=#19#1;||TONI
        |CIERRA #19;                       ||Descripcion escandallo
        #148#2=#1#4/100;                   ||Mano obra hectólitro
        #148#3=0;                          ||Costes indirectos
        #148#4=otroscostes;                ||Otros costes
        #148#5=#148#4 + #148#3 + #148#2;            ||Suma otros costes
        #148#7=0;                          ||% merma
        #148#8=0; || #1#2/100;                   ||Coste componentes hectólitro
        #148#9=#148#5; || + (#1#6/100);          ||Coste total unitario hectólitro
        #148#10=#0#22;                     ||Almacén
        #148#12=1;
        #148#13=1;                   ||Factor de conversión.
        |SI a!0;
                |GRABA 020#148n;
        |SINO;
                |GRABA 020#148a;
        |FINSI;

        |ABRE #19;
        ||Busco vino 1 y si no existe, lo doy de alta
        aAlfa1=#1#8;
        |QBT aAlfa1;
        |SI aAlfa1 ! "";
                    #19#0=#1#8;
                    |LEE 000#19=;
                    |SI FSalida ! 0;
                        |DDEFECTO #19;
                        #19#0=#1#8;
                        #19#1=#1#9;
                        #19#114=#1#11;
                        |GRABA 020#19b;
                        |PUSHV 0501 2380;
                        |PINPA #0#19;
                        |PINDA #0#19;
                        |ENDATOS #1#19;
                        |SI FSalida = 0;
                            |GRABA 020#19a;
                        |FINSI;
                        |LIBERA #1;
                        |POPV;
                    |FINSI;
        |FINSI;
        ||Busco vino 2 y si no existe, lo doy de alta
        aAlfa1=#1#19;
        |QBT aAlfa1;
        |SI aAlfa1 ! "";
        #19#0=#1#19;
        |LEE 000#19=;
        |SI FSalida ! 0;
                        |DDEFECTO #19;
                        #19#0=#1#19;
                        #19#1=#1#20;
                        #19#114=#1#22;
                        |GRABA 020#19b;
                        |PUSHV 0501 2380;
                        |PINPA #1#19;
                        |PINDA #0#19;
                        |ENDATOS #1#19;
                        |SI FSalida = 0;
                            |GRABA 020#19a;
                        |FINSI;
                        |LIBERA #1;
                        |POPV;
                    |FINSI;
        |FINSI;
        ||Busco vino 3 y si no existe, lo doy de alta
        aAlfa1=#1#30;
        |QBT aAlfa1;
        |SI aAlfa1 ! "";
                    #19#0=#1#30;
                    |LEE 000#19=;
                    |SI FSalida ! 0;
                        |DDEFECTO #19;
                        #19#0=#1#30;
                        #19#1=#1#31;
                        #19#114=#1#33;
                        |GRABA 020#19b;
                        |PUSHV 0501 2380;
                        |PINPA #1#19;
                        |PINDA #0#19;
                        |ENDATOS #1#19;
                        |SI FSalida = 0;
                            |GRABA 020#19a;
                        |FINSI;
                        |LIBERA #1;
                        |POPV;
                    |FINSI;
        |FINSI;
        ||Busco vino 4 y si no existe, lo doy de alta
        aAlfa1=#1#41;
        |QBT aAlfa1;
        |SI aAlfa1 ! "";
                    #19#0=#1#41;
                    |LEE 000#19=;
                    |SI FSalida ! 0;
                        |DDEFECTO #19;
                        #19#0=#1#41;
                        #19#1=#1#42;
                        #19#114=#1#44;
                        |GRABA 020#19b;
                        |PUSHV 0501 2380;
                        |PINPA #1#19;
                        |PINDA #0#19;
                        |ENDATOS #1#19;
                        |SI FSalida = 0;
                            |GRABA 020#19a;
                        |FINSI;
                        |LIBERA #1;
                        |POPV;
                    |FINSI;
        |FINSI;
        ||Busco vino 5 y si no existe, lo doy de alta
        aAlfa1=#1#52;
        |QBT aAlfa1;
        |SI aAlfa1 ! "";
                    #19#0=#1#52;
                    |LEE 000#19=;
                    |SI FSalida ! 0;
                        |DDEFECTO #19;
                        #19#0=#1#52;
                        #19#1=#1#53;
                        #19#114=#1#55;
                        |GRABA 020#19b;
                        |PUSHV 0501 2380;
                        |PINPA #1#19;
                        |PINDA #0#19;
                        |ENDATOS #1#19;
                        |SI FSalida = 0;
                            |GRABA 020#19a;
                        |FINSI;
                        |LIBERA #1;
                        |POPV;
                    |FINSI;
        |FINSI;
|FPRC;


|PROCESO bl;
     |BORRA 020#49a;
|FPRC;

|DEFBUCLE borraescanl;
     #49#1;
     ;
     #0#2,1;
     #0#2,999;
     be;
     NULL, bl;
|FIN;


|PROCESO Borraescan;
#148#0 = #0#2;
|LEE 020#148=;
||BORRA 020#148a;
|BUCLE borraescanl;
|FPRC;


|PROCESO CreaEscan;
        |ABRE #1;
        #1#0=#0#0;
        |LEE 000#1=;  ||FindKey
        |SI FSalida=0;
                |HAZ CreaCab;
                |ABRE #49;
                |HAZ Borraescan;
                |HAZ CreaLin;
                |CIERRA #49;
                |HAZ CreaArt;
        |FINSI;
        |CIERRA #1;
|FPRC;

|PROCESO Tip30; |TIPO 30;
  |SI FSalida=0;
    |HAZ CreaEscan;
  |FINSI;
|FPRC;

|| Impresion INICIO ---------------------------------------------------------
|PROCESO IMPvinos002;
     |PRINT;
|FPRC;

|DEFBUCLE IMPvinos002;
     #2#1;
     ;
     #1#0,1;
     #1#0,999;
     be;
     NULL,IMPvinos002;
|FIN;

/*
|PROCESO Imprime;|TIPO 4;
     |CONFI "0000SImprimir informe de escandallos de vinos?";
     |SI FSalida=0;
       |ABRE #1;
       #1#0 = #0#0;
       |LEE 000#1=;
       |SI FSalida = 0;
         |IMPRE 0;
         |INFOR informe;
         |BUCLE IMPvinos002;
         |PIEINF;
         |FININF;
         |FINIMP;
       |FINSI;
       |CIERRA #1;
     |FINSI;
|FPRC;
*/
|| Impresion FIN ------------------------------------------------------------

|PROCESO imp49;
  |PRINT;
|FPRC;

|DEFBUCLE imp148;
#49#1;
;
#148#0,1;
#148#0,999;
;
NULL,imp49;
|FIN;
/*
|PROCESO imp18;
  wtip = 1;
  |PRINT;
|FPRC;

|DEFBUCLE imp18;
#18#1;
;
#148#0,1;
#148#0,99;
;
NULL,imp18;
|FIN;
*/
|CALCULO Imprime;|TIPO 4;
     |MENU menu;
     Sw = FSalida;
     |IMPRE 0;

     |SI FSalida=0;
       |SI Sw = 2;|O Sw=3; ||Vinos
         |ABRE #1;
         #1#0 = #0#0;
         |LEE 000#1=;
         |SI FSalida = 0;
           |INFOR informe;
           |BUCLE IMPvinos002;
           |PIEINF;
           |FININF;
           |FINIMP;
         |FINSI;
         |CIERRA #1;
       |FINSI;
       |SI Sw = 1;|O Sw=3; ||Vinos
         |ABRE #148;
         #148#0 = #0#2;
         |LEE 000#148=;
         |SI FSalida = 0;
           |IMPRE 0;
           |INFOR infreal;
           ||BUCLE imp18;
           wtip = 2;
           |BUCLE imp148;
           |PIEINF;
           |FININF;
           |FINIMP;
         |FINSI;
         |CIERRA #148;
       |FINSI;
     |FINSI;
|FCAL;

|PROCESO vino;|TIPO 30;
      |HAZ CreaEscan;
|FPRC;

|PROCESO IVA004_0; |TIPO 0;
     enTiva = #0Campo;
     efFiva = ~;
     |HAZ SacaIVA;
     |SI eaDiva = "";
          |MENAV "0000No existe tipo iva para esta fecha...";
          |ERROR; |ACABA;
     |FINSI;
|FPRC;

|PROCESO IVA004_66; |TIPO 66;
     enTiva = #0Campo;
     efFiva = ~;
     |HAZ ConsuIVA;
     |SI eaDiva = "";
          |ERROR;
     |SINO;
          #0Campo = enTiva; |PINTA #0Campo;
     |FINSI;
|FPRC;
