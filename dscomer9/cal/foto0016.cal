|FICHEROS;
     foto0015 #0; ||Cabecera de sobres
     foto0016 #1; ||Lineas de sobres
     agifa019 #2; ||Articulos
     agifa024 #3; |Clientes
     foto0026 #10;
     foto0042 #44;
|FIN;

|VARIABLES;
     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;
     &nDeci_sob = 2;
     &nDeci_sob1= 4;
     tarifa=1;
     fec=~;
     Hora="00:00";
     nTipoIVA=0;
     euros=166.386;
     nPorcIVA=0;
     nPorcRE=0;
     recargo="";
     a39="";          ||etiqueta *
     a1="";          ||cliente *
     a2="";          ||nombre cliente *
     a15="";          ||telefono cliente *
     a16="";          ||tienda *
     a17="";          ||exportado *
     a23="";          ||fecha exportado *
     a5="";          ||estado *
     a8="";          ||enviado fecha *
     a9="";          ||enviado hora *
     a20="";          ||facturado fecha *
     a21="";          ||facturado hora *
     a6="";          ||recogido cajero *
     a7="";          ||recogido nombre cajero *
     a10="";          ||recogido fecha *
     a11="";          ||recogido hora *
     a40="";          ||recogido se/alba *
     a41="";          ||recogido nu/alba *
     a12="";          ||recogido se/tiqu *
     a13="";          ||recogido nu/tiqu *
     a42="";          ||recogido se/fra *
     a43="";          ||recogido nu/fra *
     a44="";          ||tipo facturacion
     a22="";          ||pack *
     &a123         = "";     ||codigo
     &a124         = "";     ||descripcion
     &a125         = "";     ||precio
     &a126         = "";     ||descuento
     &a127         = "";     ||total linea
     linea         = "";     ||linea articulo
|FIN;

|CAMPOS;
     #2#130 cArt_ii1;
     #2#131 cArt_ii2;
     #2#132 cArt_ii3;
     #2#153 cArt_ii4;
     #2#154 cArt_ii5;
     #2#155 cArt_ii6;
     #2#18  cArt_pre1;
     #2#19  cArt_pre2;
     #2#20  cArt_pre3;
     #2#147 cArt_pre4;
     #3#148 cArt_pre5;
     #2#149 cArt_pre6;
     #2#30  cArt_tipI;
     #1#8   cLS_prDIV;
     #1#9   cLS_ttDIV;
     #1#10  cLS_psi;
     #1#11  cLS_tti;
     #1#12  cLS_ttr;
     #1#13  cLS_psiDIV;
     #1#14  cLS_ttiDIV;
     #1#15  cLS_ttrDIV;
     #2#21 cArt_dto1;
     #2#22 cArt_dto2;
     #2#23 cArt_dto3;
     #2#150 cArt_dto4;
     #2#151 cArt_dto5;
     #2#152 cArt_dto6;

|FIN;

|PROCESO CalcTotal;
     #foto0016#6=#foto0016#4*#foto0016#5;
     cLS_psi=cLS_psi*#foto0016#4;
     cLS_tti=cLS_tti*#foto0016#4;
     cLS_ttr=cLS_ttr*#foto0016#4;
     cLS_psiDIV=cLS_psiDIV*#foto0016#4;
     cLS_ttiDIV=cLS_ttiDIV*#foto0016#4;
     cLS_ttrDIV=cLS_ttrDIV*#foto0016#4;
     cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV+cLS_ttrDIV;
     |PINTA #foto0016#6;
|FPRC;

|PROCESO Precio; |TIPO 7;
     |ABRE #agifa024;
     #agifa024#0=#0#1;
     |LEE 010#agifa024.=; ||busco el cliente
     |SI FSalida=0;
          tarifa=#agifa024#39; ||si lo encuentro recogo tarifa y recargo
          recargo=#agifa024#47;
     |SINO;                    ||si no lo encuentro (posible cliente en blanco)
          tarifa=1;            ||pongo tarifa = 1 y recargo = no
          recargo="N";
     |FINSI;
     |ABRE #agifa019;
     #agifa019#0=#foto0016#2;
     |LEE 020#agifa019.=;
     |SI FSalida=0;
          nTipoIVA=cArt_tipI;
          enTiva = nTipoIVA;
          efFiva = #0#8;
          |HAZ SacaIVA;

          nPorcIVA=enIva;
          nPorcRE =enRec;
       ||cArt_dto1 = 1 + (cArt_dto1/100);
       ||cArt_dto2 = 1 + (cArt_dto2/100);
       ||cArt_dto3 = 1 + (cArt_dto3/100);
       ||cArt_dto4 = 1 + (cArt_dto4/100);
       ||cArt_dto5 = 1 + (cArt_dto5/100);
       ||cArt_dto6 = 1 + (cArt_dto6/100);
          ||En los siguientes SI compruebo la tarifa. Segun la que sea
          ||compruebo si tiene el IVA incluido y si lo tiene hace los calculos
          ||descontando el IVA y calculando los datos intermedios para los
          ||euros.
          |SI tarifa=1;
          cArt_pre1= cArt_pre1 < cArt_dto1;
               |SI cArt_ii1 ="S";
                   cLS_psi=cArt_pre1 / (1+(nPorcIVA/100));
                   cLS_tti=((cLS_psi*nPorcIVA)/100);
                   cLS_psiDIV=cLS_psi/euros;
                   cLS_ttiDIV=cLS_tti/euros;
                   |SI recargo="S";
                       cLS_ttr=((cLS_psi*nPorcRE)/100);
                       cLS_ttrDIV=cLS_ttr/euros;
                       #foto0016#5=cArt_pre1;||cLS_psi+cLS_tti+cLS_ttr;
                       cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV+cLS_ttrDIV;
                   |SINO;
                       |SI recargo = "N";
                        #foto0016#5=cArt_pre1;||cLS_psi+cLS_tti;
                        cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV;
                       |FINSI;
                   |FINSI;
               |SINO;
                  cLS_psi=cArt_pre1;
                  cLS_tti=((cArt_pre1*nPorcIVA)/100);
                  cLS_psiDIV=cLS_psi/euros;
                  cLS_ttiDIV=cLS_tti/euros;
                  |SI recargo="S";
                      cLS_ttr=((cLS_psi*nPorcRE)/100);
                      cLS_ttrDIV=cLS_ttr/euros;
                      #foto0016#5=cLS_psi;||cLS_psi+cLS_tti+cLS_ttr; ||nando
                      cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV+cLS_ttrDIV;
                      |SINO;
                      #foto0016#5=cLS_psi;||cLS_psi+cLS_tti; ||nando
                      cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV;
                  |FINSI;
               |FINSI;
          |FINSI;
          |SI tarifa=2;
          cArt_pre2= cArt_pre2 < cArt_dto2;
               |SI cArt_ii2 ="S";
                   cLS_psi=cArt_pre2 / (1+(nPorcIVA/100));
                   cLS_tti=((cLS_psi*nPorcIVA)/100);
                   cLS_psiDIV=cLS_psi/euros;
                   cLS_ttiDIV=cLS_tti/euros;
                   |SI recargo="S";
                       cLS_ttr=((cLS_psi*nPorcRE)/100);
                       cLS_ttrDIV=cLS_ttr/euros;
                       #foto0016#5=cArt_pre2;||cLS_psi+cLS_tti+cLS_ttr;
                       cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV+cLS_ttrDIV;
                       |SINO;
                       #foto0016#5=cArt_pre2;||cLS_psi+cLS_tti;
                       cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV;
                  |FINSI;
               |SINO;
                  cLS_psi=cArt_pre2;
                  cLS_tti=((cArt_pre2*nPorcIVA)/100);
                  cLS_psiDIV=cLS_psi/euros;
                  cLS_ttiDIV=cLS_tti/euros;
                  |SI recargo="S";
                      cLS_ttr=((cLS_psi*nPorcRE)/100);
                      cLS_ttrDIV=cLS_ttr/euros;
                      #foto0016#5=cArt_pre2;||cLS_psi+cLS_tti+cLS_ttr;
                      cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV+cLS_ttrDIV;
                      |SINO;
                      #foto0016#5=cArt_pre2;||cLS_psi+cLS_tti;
                      cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV;
                  |FINSI;
               |FINSI;
          |FINSI;
          |SI tarifa=3;
          cArt_pre3= cArt_pre3 < cArt_dto3;
               |SI cArt_ii1 ="S";
                   cLS_psi=cArt_pre3 / (1+(nPorcIVA/100));
                   cLS_tti=((cLS_psi*nPorcIVA)/100);
                   cLS_psiDIV=cLS_psi/euros;
                   cLS_ttiDIV=cLS_tti/euros;
                   |SI recargo="S";
                       cLS_ttr=((cLS_psi*nPorcRE)/100);
                       cLS_ttrDIV=cLS_ttr/euros;
                       #foto0016#5=cArt_pre3;||cLS_psi+cLS_tti+cLS_ttr;
                       cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV+cLS_ttrDIV;
                       |SINO;
                       #foto0016#5=cArt_pre3;||cLS_psi+cLS_tti;
                       cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV;
                  |FINSI;
               |SINO;
                  cLS_psi=cArt_pre3;
                  cLS_tti=((cArt_pre3*nPorcIVA)/100);
                  cLS_psiDIV=cLS_psi/euros;
                  cLS_ttiDIV=cLS_tti/euros;
                  |SI recargo="S";
                      cLS_ttr=((cLS_psi*nPorcRE)/100);
                      cLS_ttrDIV=cLS_ttr/euros;
                      #foto0016#5=cArt_pre3;||cLS_psi+cLS_tti+cLS_ttr;
                      cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV+cLS_ttrDIV;
                      |SINO;
                      #foto0016#5=cArt_pre3;||cLS_psi+cLS_tti;
                      cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV;
                  |FINSI;
               |FINSI;
          |FINSI;
          |SI tarifa=4;
          cArt_pre4= cArt_pre4 < cArt_dto4;

                         |SI cArt_ii4 ="S";
                             cLS_psi=cArt_pre4 / (1+(nPorcIVA/100));
                             cLS_tti=((cLS_psi*nPorcIVA)/100);
                             cLS_psiDIV=cLS_psi/euros;
                             cLS_ttiDIV=cLS_tti/euros;
                             |SI recargo="S";
                                 cLS_ttr=((cLS_psi*nPorcRE)/100);
                                 cLS_ttrDIV=cLS_ttr/euros;
                                 #foto0016#5=cArt_pre4;||cLS_psi+cLS_tti+cLS_ttr;
                                 cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV+cLS_ttrDIV;
                                 |SINO;
                                 #foto0016#5=cArt_pre4;||cLS_psi+cLS_tti;
                                 cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV;
                            |FINSI;
                         |SINO;
                            cLS_psi=cArt_pre4;
                            cLS_tti=((cArt_pre4*nPorcIVA)/100);
                            cLS_psiDIV=cLS_psi/euros;
                            cLS_ttiDIV=cLS_tti/euros;
                            |SI recargo="S";
                                cLS_ttr=((cLS_psi*nPorcRE)/100);
                                cLS_ttrDIV=cLS_ttr/euros;
                                #foto0016#5=cArt_pre4;||cLS_psi+cLS_tti+cLS_ttr;
                                cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV+cLS_ttrDIV;
                                |SINO;
                                #foto0016#5=cArt_pre4;||cLS_psi+cLS_tti;
                                cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV;
                            |FINSI;
                         |FINSI;
          |FINSI;
          |SI tarifa=5;
          cArt_pre5= cArt_pre5 < cArt_dto5;

                         |SI cArt_ii5 ="S";
                             cLS_psi=cArt_pre5 / (1+(nPorcIVA/100));
                             cLS_tti=((cLS_psi*nPorcIVA)/100);
                             cLS_psiDIV=cLS_psi/euros;
                             cLS_ttiDIV=cLS_tti/euros;
                             |SI recargo="S";
                                 cLS_ttr=((cLS_psi*nPorcRE)/100);
                                 cLS_ttrDIV=cLS_ttr/euros;
                                 #foto0016#5=cArt_pre5;||cLS_psi+cLS_tti+cLS_ttr;
                                 cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV+cLS_ttrDIV;
                                 |SINO;
                                 #foto0016#5=cArt_pre5;||cLS_psi+cLS_tti;
                                 cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV;
                            |FINSI;
                         |SINO;
                            cLS_psi=cArt_pre5;
                            cLS_tti=((cArt_pre5*nPorcIVA)/100);
                            cLS_psiDIV=cLS_psi/euros;
                            cLS_ttiDIV=cLS_tti/euros;
                            |SI recargo="S";
                                cLS_ttr=((cLS_psi*nPorcRE)/100);
                                cLS_ttrDIV=cLS_ttr/euros;
                                #foto0016#5=cArt_pre5;||cLS_psi+cLS_tti+cLS_ttr;
                                cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV+cLS_ttrDIV;
                                |SINO;
                                #foto0016#5=cArt_pre5;||cLS_psi+cLS_tti;
                                cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV;
                            |FINSI;
                         |FINSI;
          |FINSI;
          |SI tarifa=6;
          cArt_pre6= cArt_pre6 < cArt_dto6;
                         |SI cArt_ii6 ="S";
                             cLS_psi=cArt_pre6 / (1+(nPorcIVA/100));
                             cLS_tti=((cLS_psi*nPorcIVA)/100);
                             cLS_psiDIV=cLS_psi/euros;
                             cLS_ttiDIV=cLS_tti/euros;
                             |SI recargo="S";
                                 cLS_ttr=((cLS_psi*nPorcRE)/100);
                                 cLS_ttrDIV=cLS_ttr/euros;
                                 #foto0016#5=cArt_pre6;||cLS_psi+cLS_tti+cLS_ttr;
                                 cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV+cLS_ttrDIV;
                                 |SINO;
                                 #foto0016#5=cArt_pre6;||cLS_psi+cLS_tti;
                                 cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV;
                            |FINSI;
                         |SINO;
                            cLS_psi=cArt_pre6;
                            cLS_tti=((cArt_pre6*nPorcIVA)/100);
                            cLS_psiDIV=cLS_psi/euros;
                            cLS_ttiDIV=cLS_tti/euros;
                            |SI recargo="S";
                                cLS_ttr=((cLS_psi*nPorcRE)/100);
                                cLS_ttrDIV=cLS_ttr/euros;
                                #foto0016#5=cArt_pre6;||cLS_psi+cLS_tti+cLS_ttr;
                                cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV+cLS_ttrDIV;
                                |SINO;
                                #foto0016#5=cArt_pre6;||cLS_psi+cLS_tti;
                                cLS_ttDIV=cLS_psiDIV+cLS_ttiDIV;
                            |FINSI;
                         |FINSI;
          |FINSI;
          |PINTA #foto0016#5;
     |FINSI;
|FPRC;

|PROCESO LeerDefectos16;
     |ABRE #44;
     #44#0="A";
     |LEE 020#44=;
     a1=#44#3;     ||cliente *
     a2=#44#4;     ||nombre cliente *
     a15=#44#5;     ||telefono cliente *
     a16=#44#6;     ||tienda *
     a17=#44#7;     ||exportado *
     a23=#44#8;     ||fecha exportado *
     a5=#44#9;     ||estado *
     a8=#44#10;     ||enviado fecha *
     a9=#44#11;     ||enviado hora *
     a20=#44#12;     ||facturado fecha *
     a21=#44#13;     ||facturado hora *
     a6=#44#14;     ||recogido cajero *
     a7=#44#15;     ||recogido nombre cajero *
     a10=#44#16;     ||recogido fecha *
     a11=#44#17;     ||recogido hora *
     a40=#44#18;     ||recogido se/alba *
     a41=#44#19;     ||recogido nu/alba *
     a12=#44#20;     ||recogido se/tiqu *
     a13=#44#21;     ||recogido nu/tiqu *
     a42=#44#22;     ||recogido se/fra *
     a43=#44#23;     ||recogido nu/fra *
     a124=#44#25;     ||descripcion
     a125=#44#26;     ||precio
     ||a126=#44#27;     ||descuento
     a127=#44#28;     ||total linea
     a22=#44#29;     ||pack *
     a44=#44#43;     ||tipo facturacion
     linea = #44#46;
     |CIERRA #44;
|FPRC;


|PROCESO lin;
    |HAZ LeerDefectos16;
 |ABRE #2;
 #2#0 = #1#2;
 |LEE 000#2=;
 |SI linea  = #2#125;
    |C_M #1#3 , 1, "S";
    |C_M #1#5 , 1, "S";
    |C_M #1#6 , 1, "S";
 |SINO;
    |C_M #1#3 , 1, a124;
    |C_M #1#5 , 1, a125;
    |C_M #1#6 , 1, a127;
 |FINSI;
|CIERRA #2;
|FPRC;


|PROCESO ActCab; |TIPO 7;
     |SI #1#1>1;
          #0#5="F";
          #0#20=~;
          |HORA Hora;
          Hora = Hora % 105;
          #0#21 = Hora;
          |PINTA #0#20;
          |PINTA #0#21;
          |GRABA 020#0a;
          |PINTA #0#5;
     |FINSI;
|FPRC;

|PROCESO TotalSobre;|TIPO 2;
      #0#14=#0#14 +. #foto0016#6;
      #0#37=#0#37 +. cLS_psi;
      #0#38=#0#38 +. cLS_psiDIV;
      #0#24=#0#24 +. cLS_ttDIV;
      |SI nTipoIVA=1;
          #0#25=#0#25 +. cLS_tti;
          #0#28=#0#28 +. cLS_ttiDIV;
          |SI recargo="S";
               #0#31=#0#31 +. cLS_ttr;
               #0#34=#0#34 +. cLS_ttrDIV;
          |FINSI;
      |FINSI;
      |SI nTipoIVA=2;
          #0#26=#0#26 +. cLS_tti;
          #0#29=#0#29 +. cLS_ttiDIV;
          |SI recargo="S";
               #0#32=#0#32 +. cLS_ttr;
               #0#35=#0#35 +. cLS_ttrDIV;
          |FINSI;
      |FINSI;
      |SI nTipoIVA=3;
          #0#27=#0#27 +. cLS_tti;
          #0#30=#0#30 +. cLS_ttiDIV;
          |SI recargo="S";
               #0#33=#0#33 +. cLS_ttr;
               #0#36=#0#36 +. cLS_ttrDIV;
          |FINSI;
      |FINSI;
     |PINTA #0#14;
     |PINTA #0#25;
     |PINTA #0#26;
     |PINTA #0#27;
     |PINTA #0#31;
     |PINTA #0#32;
     |PINTA #0#33;
     |PINTA #0#37;
|FPRC;
