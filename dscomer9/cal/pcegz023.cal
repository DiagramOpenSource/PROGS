|FICHEROS;
     pcegz023 #0,MANTE;
     pcegm004 #4;   || Ped. Vta. Cab.
     pcegm005 #5;   || Ped. Vta. Lin.
     agifa017 #17;
     agifa019 #19;
     pcegm042 #42;
     agifa080 #80;  || Alb. Com. Li.n
     pcegm005@;
|FIN;

|VARIABLES;
     &Tempo = "";
     &eaSerie = "";
     &enCodigo = 0;
     &enLinea = 0;
     &eaArticulo = "";
     &eaProve = "";
     &enError = 0;
     &enModo = 0;
     &enForma = 0;
     &enPedido = 0;
     &efFecha = @;
     nPen = 0;
     aAlfa = "";
     aSerie = "";
     nPedido = 0;
     nLin = 0;
     aSerieAnt = "";
     nPedidoAnt = 0;
     nLinAnt = 0;
     aHayPed = "";
     nPendiente = 0;
     nHay = 0;
     nSal = 0;
|FIN;

|PROCESO PedVta;
     |SI #5#2 = eaArticulo; |Y #5#30 = 0;
          nPen = #5#5 - #5#43;
          |SI nPen [ 0; |ACABA; |FINSI;
          |SI #5#60 ! 0; |ACABA; |FINSI;
          |SALVA_DATOS #5;
          |REPON_DATOS #pcegm005@;
          |GRABA 020#pcegm005@.n;
          aHayPed = "S";
     |FINSI;
|FPRC;

|DEFBUCLE PedVta;
     #4#4;
     ;
     "C", #0#0, 0001, "     ", 000001
     "C", #0#0, 9999, "zzzzz", 999999;
     ;
     NULL, NULL, PedVta;
|FIN;

|PROCESO Tipo12; |TIPO 12;
|FPRC;

|PROCESO DesasignaPedido;
     |ABRE #5;
     |SELECT #4#5;
     #5#31 = eaSerie;
     #5#30 = enCodigo;
     #5#32 = enLinea;
     |LEE 000#5=;
     |SI FSalida = 0;
          aSerieAnt = #5#28;
          nPedidoAnt = #5#0;
          nLinAnt = #5#1;

          |SELECT #1#5;
          #5#28 = aSerieAnt;
          #5#0 = nPedidoAnt;
          #5#1 = nLinAnt;
          |LEE 101#5=;
          |SI FSalida = 0;
               #5#31 = "";
               #5#30 = 0;
               #5#32 = 0;
               |GRABA 020#5a;
               |LIBERA #5;
               |ABRE #4;
               #4#25 = #5#28;
               #4#0 = #5#0;
               |LEE 121#4=;
               |SI FSalida = 0;
                    |HAZ RecalTipoPed;
                    |GRABA 020#4a;
               |FINSI;
               |CIERRA #4;
          |FINSI;
     |FINSI;
     |CIERRA #5;
|FPRC;

|PROCESO AsignaPedido;
     |AVISO;
     enError = 0;

     |ABRE #5;
     |SELECT #4#5;
     #5#31 = eaSerie;
     #5#30 = enCodigo;
     #5#32 = enLinea;
     |LEE 000#5=;
     |SI FSalida = 0;
          #0#0 = #5#20;
          aSerie = #5#28;
          nPedido = #5#0;
          nLin = #5#1;
          aSerieAnt = #5#28;
          nPedidoAnt = #5#0;
          nLinAnt = #5#1;
     |FINSI;
     |CIERRA #5;

     |PUSHV 0501 2380;
     |PINPA #0#0;
     |PINDA #0#0;
  |ET Sigue;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |DDEF aAlfa;
          aAlfa = aAlfa + "pcegm005";
          |CARGA_DEF aAlfa, pcegm005@;
          |SI FSalida = 0;
               |HAZ CreaTempo; |NOME_DAT #pcegm005@#Tempo#;
               |DELINDEX #pcegm005@;

               |ABRE #pcegm005@;
               aHayPed = "N";
               |BUCLE PedVta;
               |SI aHayPed = "N";
                    |MENAV "0000No hay pedidos para este cliente";
               |SINO;
                    |SI nLin = 0;
                         |LEE 000#pcegm005@.p;
                    |SINO;
                         #pcegm005@#28 = aSerie;
                         #pcegm005@#0 = nPedido;
                         #pcegm005@#0 = nLin;
                         |LEE 000#pcegm005@.=;
                    |FINSI;
                    |CONSULTA_CLAVE #1#pcegm005@;
                    |SI FSalida = 0;
                         aSerie = #pcegm005@#28;
                         nPedido = #pcegm005@#0;
                         nLin = #pcegm005@#1;
                    |SINO;
                         |SI enModo = 1; nLin = 0; |FINSI;
                    |FINSI;
               |FINSI;
               |CIERRA #pcegm005@;
               |DELINDEX #pcegm005@;
               |HAZ BoraTempo;
               |DESCARGA_DEF #pcegm005@;

               |SI aHayPed = "N"; nLin = 0; |FINSI;

               |SI nLin = 0; |Y enModo = 1;
                    |CONFI "0000NEsta seguro de anular la linea";
                    |SI FSalida = 0;
                         enError = 1;
                    |SINO;
                         |VETE Sigue;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI nLin ! 0;
               |ABRET #5;
               #5#28 = aSerieAnt;
               #5#0 = nPedidoAnt;
               #5#1 = nLinAnt;
               |LEE 101#5=;
               |SI FSalida = 0;
                    #5#31 = "";
                    #5#30 = 0;
                    #5#32 = 0;
                    |GRABA 020#5a;
                    |LIBERA #5;
                    |ABRE #4;
                    #4#25 = #5#28;
                    #4#0 = #5#0;
                    |LEE 121#4=;
                    |SI FSalida = 0;
                         |HAZ RecalTipoPed;
                         |GRABA 020#4a;
                    |FINSI;
                    |CIERRA #4;
               |FINSI;
               #5#28 = aSerie;
               #5#0 = nPedido;
               #5#1 = nLin;
               |LEE 101#5=;
               |SI FSalida = 0;
                    #5#31 = eaSerie;
                    #5#30 = enCodigo;
                    #5#32 = enLinea;
                    |GRABA 020#5a;
                    |LIBERA #5;
                    |ABRE #4;
                    #4#25 = #5#28;
                    #4#0 = #5#0;
                    |LEE 121#4=;
                    |SI FSalida = 0;
                         |HAZ RecalTipoPed;
                         |GRABA 020#4a;
                    |FINSI;
                    |CIERRA #4;
                    enError = 0;
               |SINO;
                    |SI enModo = 1;
                         |MENAV "0000No existe pedido, se anula la linea...";
                    |SINO;
                         |MENAV "0000No existe pedido, no se modifica...";
                    |FINSI;
                    enError = 1;
               |FINSI;
               |CIERRAT #5;
          |FINSI;
     |SINO;
          |SI enModo = 1;
               |CONFI "0000NEsta seguro de anular la linea";
               |SI FSalida = 0;
                    enError = 1;
               |SINO;
                    |VETE Sigue;
               |FINSI;
          |FINSI;
     |FINSI;

     |POPV;
|FPRC;

|PROCESO ReservaStock;
     |ABRE #19;
     |ABRE #17;
     #19#0 = #80#2;
     |LEE 101#19=;
     |SI FSalida = 0;
          #17#0 = #80#2;
          #17#1 = #80#3;
          |LEE 101#17=;
          |SI FSalida = 0;
               #17#8 = #17#8 + (#80#5 * enForma);
               #17#39 = #17#39 - (#80#5 * enForma);
               #19#12 = #19#12 + (#80#5 * enForma);
               #19#104 = #19#104 - (#80#5 * enForma);
               |HAZ ValoraStock;
               |GRABA 020#19a;
               |GRABA 020#17a;
          |FINSI;
     |FINSI;
     |CIERRA #17;
     |CIERRA #19;
|FPRC;

|PROCESO ErrRepara;
     nHay = 0;
     |SI enLinea [ 0;
          |SI enLinea = -1;
               aAlfa = "0000El artículo pertenece a la reparación:";
               aAlfa = aAlfa + #42#0 + "/" + (("000000" + #42#1)%-106);
               |MENAV aAlfa;
          |FINSI;
     |SINO;
          |SI enModo ! 3; |Y enForma = 1;
               aAlfa = "0000No se sirve automáticamente porque pertenece a la reparación:";
               aAlfa = aAlfa + #42#0 + "/" + (("000000" + #42#1)%-106);
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
     |ERROR10;
|FPRC;

|PROCESO EsCalibraRepa;
     nHay = 1;
     |ABRE #42;
     |ABRE #4;
     |ABRE #5;
     |SELECT #5#4;
     #5#31 = #80#27;
     #5#30 = #80#0;
     #5#32 = #80#1;
     |LEE 000#5=;
     |SI FSalida = 0;
          #42#0 = #4#95;
          #42#1 = #4#96;
          |LEE 000#42=;
          |SI FSalida = 0;
               |HAZ ErrRepara;
          |FINSI;
     |FINSI;
     |CIERRA #5;
     |CIERRA #4;
     |CIERRA #42;
     FSalida = nHay;
|FPRC;

|PROCESO EntraAlbaran;
     |ABRE #80;
     #80#27 = eaSerie;
     #80#0 = enCodigo;
     #80#1 = enLinea;
     |LEE 000#80=;
     |SI FSalida = 0;
          |HAZ ReservaStock;
          |ABRE #5;
          |SELECT #4#5;
          #5#31 = #80#29;
          #5#30 = #80#12;
          #5#32 = #80#21;
          |LEE 101#5=;
          |SI FSalida = 0;
               |ABRE #4;
               #4#25 = #5#28;
               #4#0 = #5#0;
               |LEE 000#4=;
               |SI FSalida = 0;
                    #5#60 = #5#60 + (#80#5 * enForma);  || Reserva pedido ventas
                    |GRABA 020#5a;
                    |LIBERA #5;

                    |HAZ EsCalibraRepa;
                    |SI enModo = 1; |Y FSalida ! 0;
                         eaSerie = #4#25;
                         enPedido = #4#0;
                         efFecha = #4#66;
                         |SUB_EJECUTA_NP "pcegz018";
                    |FINSI;
               |FINSI;
               |CIERRA #4;
          |FINSI;
          |CIERRA #5;
     |FINSI;
     |CIERRA #80;
|FPRC;

|PROGRAMA;
     |SI PARAMETRO = "PEDIDO";
          |SI enModo = 3;
               |HAZ DesasignaPedido;
          |SINO;
               |HAZ AsignaPedido;
               |SI enError = 0;
                    aAlfa = "0000Pedido asignado " + #5#28 + "/" + (("000000" + #5#0) % -106) + ", Cliente:" + #5#20;
                    |MENAV aAlfa;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI PARAMETRO = "ALBARAN";
          |HAZ EntraAlbaran;
     |FINSI;
     |SI PARAMETRO = "ESREPARA";
          nSal = 1;
          |ABRE #80;
          #80#27 = eaSerie;
          #80#0 = enCodigo;
          #80#1 = 0;
          |LEE 000#80];
          |PARA; |SI FSalida = 0; |Y #80#27 = eaSerie; |Y #80#0 = enCodigo; |HACIENDO;
               |HAZ EsCalibraRepa;
               |SI FSalida = 0; nSal = 0; |FINSI;
               |LEE 000#80s;
          |SIGUE;
          |CIERRA #80;
          enLinea = nSal;     || SI es 0 es de reparacion
     |FINSI;
|FPRO;
