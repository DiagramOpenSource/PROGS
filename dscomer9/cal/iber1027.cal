|FICHEROS;
     agifa081 #0;
     agifa019 #2;
     agifa067 #3;
     dsw00040@ #239;||Tmp Promocion
     dsw00040 #240; ||Tmp Promocion
     dsm00241 #241; ||Medida
     dsm00244 #244; ||Promo C
     dsm00245 #245; ||Promo L
|FIN;

|VARIABLES;
     aInforme  = "iber0027";

     &nDeci_PreVisP = 0;
     &nDeci_ImpVisP 0;
     &nDeci_Base = 0;
     &nDeci_PreBase = 0;
     &nDeci_BaseMxP   = 0;
     &nDeci_PreBasMxP= 0;
     &nDeci_TotVisP = 0;
     &nDeci_TotNoVisP = 0;
     &nDeci_DivP = 0;
     &nDeci_PreDivP = 0;
     &nDeci_ImpVisP = 0;

     &nFalta   = 0; || Para Informe
     &enSwConfi= -1;

     nSwPinta  = 0;
     nDec      = 0;
     nImporte  = 0;
     nSwImpre  = 0;
     nSwPromo  = 0;
     nFactor   = 0;
     nTotUni   = 0;
     nUni      = 0;
     nResto    = 0;
     nRegalo   = 0;
     nPrecio   = 0;
     nPrecIni  = 0;
     nCamPre   = 0;
     nPromo    = 0;
     aDef      = "";
     aAlfa     = "";
     &Tempo    = "";
     aTempo240 = "";
     nSwFalta  = 0;
|FIN;

|PROCESO Impresion;
     |SI nSwImpre = 0;
          nSwImpre = 1;
          |CONFI "24000Imprimir Faltas de Promociones";
          enSwConfi = FSalida;
          |SI enSwConfi = 0;
               |IMPRE 0;
               |SI FSalida = 0;
                    |INFOR aInforme;
                    |SI FSalida ! 0; |FINIMP; |FINSI;
                    enSwConfi = FSalida;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI enSwConfi = 0;
          |PRINT;
     |FINSI;
|FPRC;

|PROCESO TotalLin2;
     #2#0 = #3#2;
     |LEE 020#2=;

     |SI #0#29 = "D";
          #3#6 = #3#33 / #0#28 * #0#33;
          #3#35 = #3#6;
     |SINO;
         #3#33 = #3#6 / #0#33 * #0#28;
         #3#35 = #3#33;
     |FINSI;

     |SI #2#196 = 2;
          #3#7 = #3#41 * #3#6; ||Importe
     |SINO;
          #3#7 = #3#5 * #3#6; ||Importe
     |FINSI;

     nImporte = ((#3#7 < #3#8) < #3#27) < #3#57;
     |SI #2#196 = 2;
          nImporte = (nImporte + (#3#41 * #3#50));
     |SINO;
          nImporte = (nImporte + (#3#5 * #3#50));
     |FINSI;
     #3#9 = ((nImporte < #0#5) < #0#17) < #0#6;

     #3#34 = #3#9 / #0#33 * #0#28;
     #3#34 = #3#9 / #0#33 * #0#28;
     |SI #0#29 = "D";
          #3#36 = #3#9;
     |SINO;
          #3#36 = #3#34;
     |FINSI;
     |SI #2#196 = 2;
          #3#11 = (#3#41 - #3#38) * #3#6;
     |SINO;
          #3#11 = (#3#5 - #3#38) * #3#6;
     |FINSI;
     #3#11 = (((((#3#11 < #3#8) < #3#27) < #3#57) < #0#5) < #0#17) < #0#6;
|FPRC;

|CALCULO actlinpc;
     #3#20 = #0#4;
     #3#23 = #0#5;
     #3#24 = #0#6;
     #3#25 = #0#17;
     #3#26 = #0#9;
     |HAZ TotalLin2;
     #0#11 = #0#11 + #3#9;
     #0#12 = #0#12 + #3#11;
     #0#13 = #0#11 - #0#12;
     |GRABA 020#3a;
     |LIBERA #3;
|FCAL;

|PROCESO caltotal1;
     #0#11 = 0;
     #0#12 = 0;
     |BUCLELIN 2actlinpc#0;
     #0#34 = #0#11 / #0#33 * #0#28;
     #0#35 = #0#12 / #0#33 * #0#28;
     #0#36 = #0#13 / #0#33 * #0#28;
     |SI #0#29 = "D";
          #0#37 = #0#34;
          #0#38 = #0#35;
          #0#39 = #0#36;
          #0#40 = #0#11;
          #0#41 = #0#12;
          #0#42 = #0#13;
     |SINO;
          #0#37 = #0#11;
          #0#38 = #0#12;
          #0#39 = #0#13;
          #0#40 = #0#34;
          #0#41 = #0#35;
          #0#42 = #0#36;
     |FINSI;
     |GRABA 021#0a;
|FPRC;


|PROCESO ModiLinPedi;
     nResto = nTotUni $ (#239#4 + #239#5);
     nFalta = (#239#4 + #239#5) - nResto;
     nRegalo = (nTotUni-nResto) / (#239#4 + #239#5);
     nRegalo = nRegalo * #239#5;
     #3#28 = #0#25;
     #3#0 = #0#0;
     #3#1 = #239#0;
     |LEE 121#3=;
     |SI FSalida = 0;
          #3#55 = #3nCamPre;             || Guardo Original
          #3nCamPre = (#3nCamPre - ((nPrecio * nRegalo) / nTotUni)) ! nDec;
          |GRABA 020#3a;
          |LIBERA #3;
     |FINSI;
     |SI nSwFalta = 0;
          nSwFalta = 1;
          |HAZ Impresion;
     |FINSI;
|FPRC;

|PROCESO IniLinPedi;
     nSwFalta = 0;
|FPRC;

|DEFBUCLE ModiLinPedi;
     #239#2002;
     ;
     nPromo, nPrecio;
     nPromo, nPrecio;
     ;
     IniLinPedi, ModiLinPedi;
|FIN;

|PROCESO dsw00040;
     |SI nPromo ! #240#1;
          |SI nPromo ! 0;
               |BUCLE ModiLinPedi;
          |FINSI;
          nPromo = #240#1;
          nPrecio = #240#2;
          nTotUni = 0;
     |FINSI;
     |SI nPrecio ! #240#2;
     ||     aAlfa = "0000Precios distintos en Promocion:" + #240#1;
     ||     |MENAV aAlfa;
          |BUCLE ModiLinPedi;
          nPrecio = #240#2;
          nTotUni = 0;
     |FINSI;
     nTotUni = nTotUni + #240#3;
|FPRC;

|DEFBUCLE dsw00040;
     #240#2;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsw00040;
|FIN;

|PROCESO LineaPedi;
     #245#0 = #0#4;
     #245#2 = #3#2;
     |LEE 000#245=;
     |SI FSalida = 0;
          #244#0 = #245#0;
          #244#1 = #245#1;
          |LEE 000#244=;
          |SI FSalida = 0; |Y #3#54 = #244#2;
               #240#0 = #3#1;
               #240#1 = #244#1;
               #240#2 = #3nCamPre;
               #240#3 = #3#5;
               #240#4 = #244#3;
               #240#5 = #244#4;
               |GRABA 020#240n;
               nSwPromo = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Promociones;
     |DDEF aDef;
     aDef = aDef + "dsw00040";
     |CARGA_DEF aDef, dsw00040@;
     |SI FSalida ! 0;
          aDef = "0000Error al cargar " + aDef;
          |MENAV aDef; |ACABA;
     |FINSI;

     |HAZ CreaTempo; aTempo240 = Tempo;
     |NOME_DAT #240 aTempo240; |DELINDEX #240;
     |NOME_DAT #239 aTempo240;

     |SI #0#29 = "D";
          nCamPre = 33;
          nDec = nDeci_PreDivP;
     |SINO;
          nCamPre = 6;
          nDec = nDeci_PreBasMxP;
     |FINSI;
     nSwPromo = 0;
     |ABRE #240;
     |ABRE #244;
     |ABRE #245; |SELECT #2#245;
     |BUCLELIN 2LineaPedi#0;
     |CIERRA #244;
     |CIERRA #245;
     |CIERRA #240;
     |SI nSwPromo ! 0;
          |ABRE #239;
          |ABRE #3;
          nPromo = 0;
          |BUCLE dsw00040;
          |SI nPromo ! 0;
               |BUCLE ModiLinPedi;
          |FINSI;
          |CIERRA #3;
          |CIERRA #239;
          |HAZ caltotal1;
     |FINSI;
     |DELINDEX #240; Tempo = aTempo240; |HAZ BoraTempo;
     |DESCARGA_DEF #dsw00040@;
|FPRC;
