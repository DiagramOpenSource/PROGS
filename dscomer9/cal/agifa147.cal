|FICHEROS;
     agifa147 #0;
     agifa146 #1;
     agifa019 #2;
     agifa039 #5;
     agifa024 #6;
     agifa017 #8;

     agifa048 #13;
     agifa049 #14;
     agifa321 #35;    || DIV - Parametros
     dsm00247 #41;
     dsm00248 #43;
     dsm00050 #50;
     agifa142 #142;

     dsm00005 #905;
     dsm00010 #910;
     dsm00046 #946;
     agifa029 #29;
     dsm00279 #279;
     dsm00134 #134;

     referen1@;
     referen2@;
     referen3@;

     mecam001@;
     mecam018@;
     mecaw001@;
|FIN;

|VARIABLES;
     nComiRocai = 0;
     aArtiPromo = "";
     &eaTmpPR816 = "";
     &eaTag = "";
     &nRieUtili = 0;
     &nRieTotal = 0;
     nConAu = 0;
     &nMasRies  = 0;
     nSwAparecida = 0;
     nTallerBorLin = 0;
     nSwTaller = 0;
     &eaFicMeca = "";
     &eaCodCliente = "";
     &eaNomCliente = "";
     nAbo = 0;
     aSeri = "";
     aPedi = "";
     aFilm = "";
     nMecaMaestra = 0;
     nSwMecanogra = 0;
     aPath = "";
     nNume = 0;
     nPreDtoAnt = 0;
     nTagBorLinPost = 0;
     nTagQuitaPost = 0;
     nSwTagloma = 0;
     nSali = 0;
     nTagPre = 0;
     aTagDes = "";
     aTagArt = "";
     &enModo146 = 0;
     nForma = 0;
     nSal = 0;
     &enDto = 0;
     &nDispoKit = 0;
     aPtec = "";
     nPtec = 0;
     nLin = 0;
     &eaModulo       = "";

     nTecla         = 0;
     &eaUniMarhu    = 0;
     aTipoTar       = "";
     serie          = "";
     pedido         = 0;
     pedido_o       = 0;
     serie_o        = "";
     alfa1          = "";
     alfa2          = 0;
     recoge        = "";
     nLineaD       = 0;
     nerror        = 0;
     &Tempo        = "";
     aTempo294     = "";
     aAlfa         = "";
     nModo         = 0;

     &enDescuento1 = 0;
     &enDescuento2 = 0;
     &eaTComision  = "";
     &enComision   = 0;

     &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_Div      = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDiv   = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVis   = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVis = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVis   = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVis   = 0;   || Decimales en el Importe visual. (lineas)
     tecla      = "";
     &ac_divisa = ""; ||
     mensa      = ""; || Linea de visualizacion
     &pintado   = 0;|| Controla el pintado de mensa para que solo lo haga 1 vez
     titdiv = "";   || Encabezado de precio e imp. con la divisa "Imp.Tot(USD)"
     &Envase = "";
     &Unidades1 = 0;
     &Unidades2 = 0;
     &VArticulo = "";
     &qAbono    = "";
     &enMensaje = 0;
     &aParam    = "";
     nPrecio = 0;

 vacio = "                    ";
 descu = 0;
 tf = 0;
 pc = 0;
 comi1 = 0;
 comi2 = 0;
 comi3 = 0;
 menor = 0;
 pc1 = 0;
 pa  = 0;
 pa1 = 0;
 pa2 = 0;
 imneto = 0;
 margen = 0;
 a = 0;
 i = 0;
 wimneto = 0;
 cantidad = 0;
 asto = 0;
operacion = "FC";
articulo = " ";
fmes = "  ";
mes = 0;
me = 0;
kl = 0;
mescli= " ";
mensaje3 = "";
mensaje  = "0000 Factura para exportacion.Tipo IVA = 0  !!!";
totbu = 0;
flag = 1;
modo = 0;
swescan = 0;
&n_dec = 0;
&n_pre = 0;
&def_alm = 0;
&def_exp = "N";
campo = 0;
     &c_clien   = "";
     &c_artic   = "";
     &c_serie   = "";
     &entrada   = 0;
     inkey      = 0;
     &codiBarra = "";
     &r_arti    = "";
     pcs            = 0;
     pcv            = 0;
     pcd            = 0;
     &fed_dt = @;   || Fecha....
     &art_dt = "";  || Articulo.
     &cli_dt = "";  || Cliente..
     &fam_dt = "";  || Familia.
     &iva_dt = 0;   || Tipo Iva.
     &dtos_2 = 0;   || Descuento 2.
     &dto_pt = 0;   || Descuento Ptas.
     dtopts  = 0;
     &dtos_1 = 0;   || Descuento 1.
     &pvp_ve = 0;   || Precio Venta.
     &tarifa = 0;   || Tarifa Cliente.
     &gru_dt = "";  || Grupo Cliente.
     &uni_dt = 0;
     &uni_dt2 = 0;
     DescAmpli      = "N";    || Descarga descripcion ampliada de articulos          = 0;      || Decimales en unidades
     fiac           = "  ";
     guarda         = "  ";
     relleno        = "                                       ";
     aponer         = "  ";
     nlinea         = 0;
     &qArti         = "";
     &qUnid         = 0;
|FIN;

|INCLUYE i_varart;

|PROCESO Calc0147;
     |HAZ EsOrts;
     |SI FSalida = 0;
          eaDocu = "agifa147";
          eaSerie = #0#20;
          enCodigo = #0#0;
          enLinea = #0#1;
          |SUB_EJECUTA_NP "dsz99905;ENTRA";
     |FINSI;

     |SI DescAmpli = "S";
          aTipoDA = "X"; |HAZ DescriDA;
     |FINSI;
|FPRC;

|CALCULO pivapro;
     inkey = FSalida;
     |SI inkey = 13;
          |HAZ EsAparecida;
          |SI FSalida = 0;
               enPrecio = #0Campo;
               eaArticulo = #0#2;
               eaCliente = #1#3;
               |SUB_EJECUTA_NP "aparm010";
               #0Campo = enPrecio; |PINTA #0Campo;
               |ERROR;
          |FINSI;
     |FINSI;
     |SI inkey = 14;
         c_clien = #1#3;
         c_artic = #0#2;
         c_serie = #0#20;
         entrada = 1;
         |SUB_EJECUTA_NP "agifa283.run";
         inkey = 0;
         |ERROR;
     |FINSI;
     |SI FSalida = 15;
          eaCli = "";
          enTiva = #0#11;
          efFiva = #1#1;
          |HAZ IVACli;
          #0#6 = #0#6 / (1 + enIva/100);
          |HAZ visual_precio;
     |FINSI;
     |SI inkey = 17;     || F9
          |HAZ EsTagloma;
          |SI FSalida = 0;
               eaDocu = "PR";
               eaSerie = #0#20;
               enCodigo = #0#0;
               enLinea = #0#1;
               eaDes = #0#4;
               |SUB_EJECUTA_NP "tagm0058";
               #0#4 = eaDes; |PINTA #0#4;
          |FINSI;
     |FINSI;
     |SI inkey = 11; || F3
          |HAZ EsRocai;
          |SI FSalida = 0;
               enPrecio = #0#6;
               enComision = #0#10;
               eaCliente = #1#3;
               eaArticulo = #0#2;
               |SUB_EJECUTA_NP "rocaiz01";
               #0#10 = enComision; |PINTA #0#10;
               #0#6 = enPrecio; |PINTA #0#6;
          |FINSI;
     |FINSI;
     |C_M #0Campo, 0, aAlfa;
     |SI #142#250 = "X"; |Y aAlfa = "S";
          eaDocu = "PR";
          eaSerie = #0#20;
          enCodigo = #0#0;
          enLinea = #0#1;
          eaArticulo = #0#2;
          eaCli = #1#3;
          enModo = (FEntrada / 100) ! 0;
          enDto = #0#8;
          enPrecio = #0#6;
          enUnid1 = #0#5;
          enUnid2 = #0#39;
          enUnid3 = #0#23;
          Envase = #0#22;
          enImpDtoPromo = #0#37;
          enDtoPrePromo = #0#38;
          eaDivisa = #1#65;
          |SUB_EJECUTA_NP "dsz00080";
          |SI enError ! 0; |ERROR; |ACABA; |FINSI;
          #0#8 = enDto;
          #0#6 = enPrecio;
          #0#5 = enUnid1;
          #0#39 = enUnid2;
          #0#23 = enUnid3;
          #0#22 = Envase;
          #0#37 = enImpDtoPromo;
          #0#38 = enDtoPrePromo;
     |FINSI;
|FCAL;

|CALCULO mirespor;|TIPO 0;

    |SI #6#28 = AS ;|Y #0#11 ! 0;
          |MENAV mensaje;#0#11 = 0; |PINTA #0#11;
     |SINO;
          |SI #0#11 ! 0; |Y def_exp = "S";
               |MENSA mensaje;#0#11 = 0;|PINTA #0#11;
          |FINSI;
    |FINSI;
|FCAL;


|CALCULO lcinfo;|TIPO 0;
     mensaje3 = "0410Stock Disponible Almacen : " + #8#39+"     Stock Minimo : "+#8#6;
     |MENSA mensaje3;

     |SI Campo ! 5; |ACABA; |FINSI;

     |SI #agifa142#234 ! "N";
          eaArticulo = #agifa147#2;
          |HAZ EsKit;
          |SI FSalida = 0;
               |HAZ DispoKit;
               |SI nDispoKit ! 0;
                    |MENAV "0000Superado Stock para KIT.";
                    |SI #agifa142#234 = "X"; |ERROR; |ACABA; |FINSI;
               |FINSI;
          |SINO;
               |ABRE #8;
               #8#0 = #0#2;
               #8#1 = #0#3;
               |LEE 000#8=;
               |CIERRA #8;
               |SI #8#39 < #0#5;
                    aAlfa = "0000Supera el Stock disponible: " + #8#39;
                    |MENAV aAlfa;
                    |SI #agifa142#234 = "X"; |ERROR; |ACABA; |FINSI;
               |FINSI;
          |FINSI;
          nStock = #8#5 - #0#5;
          |SI #8#6 > nStock; |Y #agifa142#219 = "S";
               |MENAV "0000Supera el Stock minimo...";
          |FINSI;
     |FINSI;

     |SI #8#39 < #0#5; |Y #agifa142#218 = "S"; |Y Campo = 5;
          eaAuto = "S";
          |HAZ Equivalentes;
     |FINSI;
|FCAL;

|CALCULO lccogea;|TIPO 0;
     eaArtiAntes = #0#2;
     articulo = #0#2;
     aArtiPromo = #0#2;
|FCAL;

|PROCESO MinAlma147;
     #8#0 = #0#2;
     #8#1 = 1;
|FPRC;

|PROCESO MaxAlma147;
     #8#0 = #0#2;
     #8#1 = 99999;
|FPRC;

|PROCESO Alma147_0; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |HAZ PrecArt;
     |SI nModo = 1;
          |HAZ EsMecanogra;
          |SI FSalida = 0;
               eaArticulo = #0#2;
               eaFicMeca = "mc" + Usuario;
               |SUB_EJECUTA_NP "mecaw001";
          |FINSI;
     |FINSI;
|FPRC;

|CALCULO defecfc;|TIPO 0;
     |SI FSalida = 13; || F5;
          |ABRE #8;
          #8#0 = #0#2;
          #8#1 = #0#3;
          |LEE 000#8];
          |CONSULTA_F_CLAVE #1#8, MinAlma147, MaxAlma147;
          |SI FSalida = 0;
               #0#3 = #8#1; |PINTA #0#3;
          |SINO;
               |ERROR; |ACABA;
          |FINSI;
          |CIERRA #8;
     |FINSI;

#0#15 = #1#3;
#0#16 = #1#34;
#0#17 = #1#35;

|SI #0#2 ! #2#0;
   |ABRE #2;
   #2#0 = #0#2;
   |LEE 000#2=;
   |CIERRA #2;
|FINSI;
#0#13 = #2#2;
|SI #0#15 ! #6#0;
   |ABRE #6;
   #6#0 = #0#15;
   |LEE 000#6=;
   |CIERRA #6;
|FINSI;
|FCAL;

|PROCESO CalcuComi;
     enDescuento1 = #0#8;
     enDescuento2 = #0#21;
     eaTComision  = #0#16;
     eaCliente    = #1#3;
     eaArticulo   = #0#2;
     eaRepre      = #1#6;
     efFecha      = #1#1;
     eaSerie      = #0#20;
     enDirEnt = #1#80;
     enAlmacen = #0#3;
     |HAZ Comisiones;
     ||컴컴컴컴컴컴컴횺arhuenda
     eaUniMarhu = #0#5;
     |HAZ ComiMarhu;
     #0#10  = enComision;
|FPRC;

|PROCESO PrecArt;
     modo = (FEntrada / 100) ! 0;
     mescli = #1#1 % 402;
     mes = mescli;
     fed_dt = #1#1;   || Fecha....
     art_dt = #0#2;   || Articulo.
     cli_dt = #0#15;  || Cliente..
     fam_dt = #0#13;  || Familia.
     iva_dt = #2#30;  || Tipo Iva.
     dtos_2 = 0;      || Descuento 2.
     dto_pt = 0;      || Descuento Ptas.
     dtos_1 = 0;      || Descuento 1.
     pvp_ve = 0;      || Precio Venta.
     tarifa = #6#39;  || Tarifa Cliente....
     gru_dt = #6#158; || Grupo Cliente.
     uni_dt = #0#5;
     uni_dt2 = #0#28;
     enMensaje = 0;
     aParam = "";
     eaSerie = #0#20;
     enDirEnt = #1#80;
     |SI #2#176 = "S";  enMensaje = 1;  |FINSI;
     enAlmacen = #0#3;
     |SI modo = 1; |O articulo ! #0#2;
          enInterno = tarifa;
          |HAZ calcdtos;    || Calculo Dtos.....
          |SI eaCliArtDiviSN = "S";
               |SI eaCliArtDivi ! #1#65;
                    aAlfa = "0000La divisa del documento ("+ #1#65 + ") no se corresponde con la oferta (" + eaCliArtDivi + ").";
                    |MENAV aAlfa;
                    |PTEC 807;     || Ctrl+C
               |SINO;
                    pvp_ve = pvp_ve * #1#69 / #1#66; ||Cam.Base * Cambio
               |FINSI;
          |FINSI;
          eaCliArtDiviSN = "N";

          #0#34 = enInterno;

          #0#6   = pvp_ve;  || Precio Venta. sin iva.
          #0#8   = dtos_1;  || 1 Dto.
          #0#21  = dtos_2;  || 2 Dto.
          dtopts = dto_pt;  || Dto.en ptas.
          |HAZ precio_divisa;
          |PINTA #0#21;
          |PINTA #0#8;

          |HAZ CalcuComi;

          |SI aTipoTar  = "S";
              |ABRE #2;
              #2#0 = art_dt;
              |LEE 000#2=;
              |SI tarifa = 1; pvp_ve = #2#18;  enDescuento1 = #2#21;  |FINSI;
              |SI tarifa = 2; pvp_ve = #2#19;  enDescuento1 = #2#22;  |FINSI;
              |SI tarifa = 3; pvp_ve = #2#20;  enDescuento1 = #2#23;  |FINSI;
              |SI tarifa = 4; pvp_ve = #2#147; enDescuento1 = #2#150; |FINSI;
              |SI tarifa = 5; pvp_ve = #2#148; enDescuento1 = #2#151; |FINSI;
              |SI tarifa = 6; pvp_ve = #2#149; enDescuento1 = #2#152; |FINSI;
              #0#21  = 0;
              dtopts = 0;
              |CIERRA #2;
          |FINSI;
          #0#8   = enDescuento1;
          #0#6   = pvp_ve;  || Precio Venta. sin iva.
          |HAZ EsTagloma;     || Precio Kit (dsz99986)
          |SI FSalida = 0;
               eaArticulo = #0#2;
               |HAZ EsKit;
               |SI FSalida = 0;
                    #0#6 = enPreKitCal;
               |FINSI;
          |FINSI;
         |HAZ precio_divisa;
         ||컴컴컴컴컴컴컴컴컴컴컴컴
         |PINTA #0#8;
         |PINTA #0#10;
     |FINSI;
|FPRC;

|CALCULO fccomis;|TIPO 0;
     |SI #0Campo ! Contenido;
         enDescuento1 = #0#8;
         enDescuento2 = #0#21;
         eaTComision  = #0#16;
         eaCliente    = #1#3;
         eaArticulo   = #0#2;
         eaRepre      = #1#6;
         eaSerie      = #0#20;
         enDirEnt = #1#80;
         enAlmacen = #0#3;
         |HAZ Comisiones;
         ||컴컴컴컴컴컴컴횺arhuenda
         eaUniMarhu = #0#5;
         |HAZ ComiMarhu;
         #0#10 = enComision;
         |PINTA #0#10;
     |FINSI;
|FCAL;

|CALCULO totfc;|TIPO 0;
     |HAZ TotalLin147;
     |HAZ visual_importe;
     #0#14 = #0#5 * #2#9;
|FCAL;

|CALCULO fcacarti;|TIPO 2;
     modo = (FEntrada/100) ! 0;
     nForma = 0 +. 1;

     |HAZ EsTagloma; nSwTagloma = FSalida;
     |HAZ EsMecanogra; nSwMecanogra = FSalida;
     |HAZ EsTaller; nSwTaller = FSalida;
     |HAZ EsAparecida; nSwAparecida = FSalida;

     |SI nSwTaller = 0;
          |SI #0#36 = -1; |Y enModo146 ! 3;
               |SI nForma = -1;
                    |MENAV "0000Linea canon de articulo, no se puede modificar";
               |FINSI;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;
     |SI nSwAparecida = 0;
          |SI #0#36 = -1; |Y enModo146 ! 3;
               |SI nForma = -1;
                    |MENAV "0000Linea auto-descarga, no se puede modificar";
               |FINSI;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     |SI nSwTagloma = 0;
          |HAZ TagEsLinPost;
          |SI FSalida = 0; |Y enModo146 ! 3;
               |SI nForma = -1;
                    |MENAV "0000Linea de incremento de postformado, no se puede modificar...";
               |FINSI;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     |SI #0#36 = -1; |Y enModo146 ! 3;
          |SI nForma = -1;
               |MENAV "0000Linea de Promocion, no se puede modificar...";
          |FINSI;
          |ERROR; |ACABA;
     |FINSI;

     |SI nSwMecanogra = 0; |Y enModo146 ! 3;
          |HAZ MecaTipoLin;
          |SI nMecaMaestra ! 0; |Y modo = 3;
               |SI nForma = -1;
                    |MENAV "0000Linea automatica, no se puede borrar";
               |FINSI;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     |SI nForma = 1;
|| RIESGO DE CLIENTE
          |HAZ EsInforAlba;
          |SI FSalida = 0;
               |HAZ Riesgos147;
               |SI enErrRie = 1; |ERROR; |ACABA; |FINSI;
          |SINO;
               |HAZ EsPrimicias;
               |SI FSalida = 0;
                  |HAZ Riesgos147;
                  |SI enErrRie = 1; |ERROR; |ACABA; |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |HAZ defecfc;

     |HAZ CalCabAgifa146;
     |HAZ visual_totales;

     |SI modo = 3;
          |HAZ EsAlbadis;
          |SI FSalida = 0;
               eaDocu = "PR";
               eaSerie = #0#20;
               enCodigo = #0#0;
               enLinea = #0#1;
               enPrecio = #0#6;
               enPVerde = #0#35;
               |HAZ BseBorraUni;
          |FINSI;

          |SI nSwMecanogra = 0;
               |SI enModo146 ! 3;
                    |HAZ MecaBorraLin;
               |FINSI;
               eaSerie = #0#20;
               enCodigo = #0#0;
               enLinea = #0#1;
               |SUB_EJECUTA_NP "mecam018;BAJA";
          |FINSI;

          aTipoDA = "X"; |HAZ BajaDA;
          |HAZ BorraKit;

          |HAZ EsOrts;
          |SI FSalida = 0;
               eaDocu = "agifa147";
               eaSerie = #0#20;
               enCodigo = #0#0;
               enLinea = #0#1;
               |SUB_EJECUTA_NP "dsz99905;BORRA";
          |FINSI;
     |FINSI;

     enTipEnvase = 2;
     |HAZ Envase147;

     |SI #142#250 ! "N";
          |SI nForma = 1;
               ||SI #0#39 > 0;
               |SI #0#39 ! 0;
                    aponer = Asino; |HAZ poncontr;
                    |HAZ CreaLinPromo147;
                    #0#36 = nLin;
                    aponer = Anosi; |HAZ poncontr;
                    |PTEC 809; |PTEC 816; |PTEC 806;
               |SINO;
                    |HAZ BorraLinPromo147;
               |FINSI;
          |SINO;
               |SI modo = 3; |Y enModo146 ! 3;
                    |HAZ BorraLinPromo147;
                    |PTEC 809; |PTEC 808;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nSwTagloma = 0; |HAZ TagLinPost; |FINSI;
     |SI nSwMecanogra = 0;
          |SI modo = 1; |HAZ MecaCreaLin; |FINSI;
     |FINSI;
     |SI nSwTaller = 0; |HAZ TallerCanon147; |FINSI;
     |SI nSwAparecida = 0; |HAZ Aparecida147; |FINSI;

     |HAZ EsChampiEmar;
     |SI FSalida = 0;
          |SI modo = 1; |HAZ ChampiEmarEnv; |FINSI;
          |SI modo = 3; |HAZ ChampiEmarBor; |FINSI;
     |FINSI;
|FCAL;

|PROCESO CreaLinPromo147;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa147";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen1@;
     #referen1@#20 = #0#20;
     #referen1@#0 = #0#0;
     #referen1@#1 = #0#36;
     |LEE 000#referen1@.=;
     |SI FSalida = 0;
          nLin = #0#36;
     |SINO;
          #referen1@#1 = 999;
          |LEE 000#referen1@.];
          |SI FSalida = 0;
               |LEE 000#referen1@.a;
          |SINO;
               |LEE 000#referen1@.u;
          |FINSI;
          |SI FSalida = 0; |Y #referen1@#20 = #0#20;  |Y #referen1@#0 = #0#0;
               nLin = #referen1@#1 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |SI nLin = #0#1; nLin = nLin + 1; |FINSI;
          #referen1@#20 = #0#20;
          #referen1@#0 = #0#0;
          #referen1@#1 = nLin;
          |GRABA 020#referen1@.b;
     |FINSI;
     ||SI #0#39 > 0;
     |SI #0#39 ! 0;
          |SALVA_DATOS #0;
          |REPON_DATOS #referen1@;

          #referen1@#1 = nLin;
          #referen1@#5 = #0#39;
          #referen1@#6 = 0;
          #referen1@#7 = 0;
          #referen1@#8 = 0;
          #referen1@#9 = 0;
          #referen1@#24 = 0;
          #referen1@#25 = 0;
          #referen1@#26 = 0;
          #referen1@#27 = 0;
          #referen1@#36 = -1;

          |GRABA 020#referen1@.a;
     |SINO;
          |BORRA 020#referen1@.c;
     |FINSI;
     |CIERRA #referen1@;
     |DESCARGA_DEF #referen1@;
|FPRC;

|PROCESO BorraLinPromo147;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa147";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen1@;
     #referen1@#20 = #0#20;
     #referen1@#0 = #0#0;
     #referen1@#1 = #0#36;
     |LEE 101#referen1@.=;
     |SI FSalida = 0;
          |BORRA 020#referen1@.a;
          |PONCONTROL 23, "SI";
     |FINSI;
     |CIERRA #referen1@;
     |DESCARGA_DEF #referen1@;
|FPRC;

|PROCESO cabecont;|TIPO 13;
     |HAZ visual_totales;

     |HAZ EsMecanogra;
     |SI FSalida = 0;
          |HAZ MecanoPin147;
     |FINSI;
|FPRC;

|CALCULO tipo11; |TIPO 11;
     inkey = FSalida;
     modo = (FEntrada / 100) ! 0;

     |SI inkey = 10;     ||F2
          |HAZ MenuTrack147;
          |SI FSalida = 0; |ERROR; |ACABA; |FINSI;
          inkey = FSalida;
     |FINSI;
     |SI inkey = 9;
         |PUSHV 501 2380;
         |PINPA #0#1;
         |PINDA #0#1;
         |PAUSA;
         |POPV;
         inkey = 0;
         |ERROR;
     |FINSI;
     |SI inkey = 12;          || Copia
          |HAZ Recoge;
     |FINSI;
     |SI inkey = 13;     || F5
          |HAZ EsAlbadis; ||*
          |SI FSalida = 0;
               eaDocu = "PR";
               eaSerie = #0#20;
               enCodigo = #0#0;
               enLinea = #0#1;
               enPVerde = #0#35;
               |HAZ BseVerUni;
               |ERROR; |ACABA;
          |FINSI;
          |HAZ EsOrts;
          |SI FSalida = 0;
               eaDocu = "agifa147";
               eaSerie = #0#20;
               enCodigo = #0#0;
               enLinea = #0#1;
               |SUB_EJECUTA_NP "dsz99905;VER";
          |FINSI;

          |HAZ VerKit;
          |HAZ VerDobleUniV;
          |ERROR; |ACABA;
     |FINSI;
     |SI inkey = 14; |Y modo ! 1;
         c_clien = #1#3;
         c_artic = #0#2;
         c_serie = #0#20;
         entrada = 1;
         |SUB_EJECUTA_NP "agifa283.run";
         inkey = 0;
         |ERROR;
     |FINSI;
     aAlfa = #0#2; |QBF aAlfa;
     |SI inkey = 16; |Y aAlfa ! ""; |Y DescAmpli = "S";
          aTipoDA = "X"; |HAZ VerDA;
          |ERROR;
     |FINSI;
     |SI inkey = 25; || Ctrl-F7
          |HAZ CreaTempo;
          eaFichero = Tempo;
          |SUB_EJECUTA_NP "psion066";
          |HAZ BoraTempo;
          |SI enError = 0; |HAZ ImportaPDA147; |FINSI;
          |ERROR; |ACABA;
     |FINSI;
|FCAL;

|PROCESO art6pfv; |TIPO 6;          || Antes de la Relacion 4 Clave.
     r_arti = "";                  || LIMPIA LA VARIABLE DEL ART.AUTOMATICO.
 |SI codiBarra = "N"; |ACABA; |FINSI;

 |ABRE #2;
 |SELECT #4#2;
 #2#128 = #0Campo;
 |LEE 101#2=;
 |SI FSalida = 0;
     #0Campo = #2#0;
    |PINTA #0Campo;
 |FINSI;
 |LIBERA #2;

 |SELECT #1#2;
 |CIERRA #2;
|FPRC;


|PROCESO nomodif1; |TIPO 0;
     |QBF r_arti;
     |SI r_arti ! "";
          #0#2 = r_arti;
          |PINTA #0#2;
     |FINSI;
     modo = (FEntrada / 100) ! 0;
     |SI modo = 1; #0#3 = def_alm; |PINTA #0#3; |FINSI;
     |SI #0#2 = vacio;
          |CAMPO_MODIFICA #0#3,  1, "N";
          |CAMPO_MODIFICA #0#5,  1, "N";
          |SI #1#67 = "B";
            |CAMPO_MODIFICA #0#6,  1, "N";
          |SINO;
            |CAMPO_MODIFICA #0#24,  1, "N";
          |FINSI;
          |CAMPO_MODIFICA #0#8,  1, "N";
          |CAMPO_MODIFICA #0#21,  1, "N";
          |CAMPO_MODIFICA #0#10, 1, "N";
          |CAMPO_MODIFICA #0#11, 1, "N";
          |CAMPO_MODIFICA #0#18, 1, "N";
     |SINO;
          |CAMPO_MODIFICA #0#3,  1, "S";
          |CAMPO_MODIFICA #0#5,  1, "S";
          |SI #1#67 = "B";
            |CAMPO_MODIFICA #0#6,  1, "S";
          |SINO;
            |CAMPO_MODIFICA #0#24,  1, "S";
          |FINSI;
          |CAMPO_MODIFICA #0#8,  1, "S";
          |CAMPO_MODIFICA #0#21,  1, "S";
          |CAMPO_MODIFICA #0#10, 1, "S";
          |CAMPO_MODIFICA #0#11, 1, "S";
          |CAMPO_MODIFICA #0#18, 1, "S";
     |FINSI;
|FPRC;

|PROCESO decim;
     nTecla = FSalida;
     nModo = (FEntrada / 100) ! 0;
     |HAZ Promart;
     |SI nTecla = 13;
          enTipEnvase = 1;
          |HAZ Envase147;
     |FINSI;

     |SI nTecla = 14;             ||F6
          eaAuto = "N";
          |HAZ Equivalentes;
          |ERROR;
          |ACABA;
     |FINSI;

     |HAZ EsCongecar;
     |SI FSalida = 0; |Y nModo = 2;
          enInterno = #0#34;
          |HAZ ModiTariCongecar;
          |SI #0#34 ! enInterno;
               #0#34 = enInterno;
               #0#6 = pvp_ve;
               |HAZ precio_divisa;
          |FINSI;
     |FINSI;

     |HAZ lcinfo;

     #0#5 = #0#5 ! n_dec;
     |PINTA #0#5;
     |SI #0#5 [ 0; |ACABA; |FINSI;
     qArti = #0#2;
     qUnid = #0#5;
     |HAZ ComproMin;
     |SI enErr ! 0;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Envase147;
     Envase    = #0#22;
     Unidades1 = #0#23;
     Unidades2 = #0#5;
     VArticulo = #0#2;
     enAlmacen = #0#3;
     eaTipo = "V";
     eaProgEnv = "proforma";
     |HAZ EntraEnvase;
     #0#22 = Envase;
     #0#23 = Unidades1;
     #0#5  = Unidades2;  |PINTA #0#5;
|FPRC;

|PROCESO Conversion;  |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI #142#250 = "S";
          |HAZ PrecArt;
          eaDocu = "PR";
          eaSerie = #0#20;
          enCodigo = #0#0;
          enLinea = #0#1;
          eaArticulo = #0#2;
          eaCli = #1#3;
          enModo = (FEntrada / 100) ! 0;
          enDto = #0#8;
          enPrecio = #0#6;
          enUnid1 = #0#5;
          enUnid2 = #0#39;
          enUnid3 = #0#23;
          Envase = #0#22;
          enImpDtoPromo = #0#37;
          enDtoPrePromo = #0#38;
          eaDivisa = #1#65;
          |SUB_EJECUTA_NP "dsz00080";
          |SI enError ! 0; |ERROR; |ACABA; |FINSI;
          #0#8 = enDto;
          #0#6 = enPrecio;
          #0#5 = enUnid1;
          #0#39 = enUnid2;
          #0#23 = enUnid3;
          #0#22 = Envase;
          #0#37 = enImpDtoPromo;
          #0#38 = enDtoPrePromo;
          |SI eaProCliArt = "S"; |C_M #0#5, 1, "N"; |FINSI;
     |FINSI;

     |HAZ EsMecanogra;
     |SI FSalida = 0;
          |SI nModo = 2; |C_M #0#5, 1, "N"; |ACABA; |FINSI;
     |FINSI;

     |HAZ EsChampiEmar;
     |SI FSalida = 0;
          eaTipo = "PR";
          eaSerie = #0#20;
          enCodigo = #0#0;
          enLinea = #0#1;
          eaArticulo = #0#2;
          |SI nModo = 1;
               aAlfa = "champi09;" + eaTmpPR816;
               |SUB_EJECUTA_NP aAlfa;
          |SINO;
               |SUB_EJECUTA_NP "champi03";
          |FINSI;
          |HAZ ChampiPinEmar;
          #0#5 = enUnidades;
          |C_M #0#5, 1, "N";
     |FINSI;

     |HAZ DobleUniV;
     |SI eaSw2Stock = "S";
          |C_M #0#5, 1, "N";
     |FINSI;

     |SI #142#250 = "X";
          |SI #142#68 = "S";
               |C_M #0#5, 1, "N";
          |SINO;
               |ABRE #134;
               #134#0 = #1#3;
               #134#1 = #0#2;
               |LEE 000#134=;
               |SI FSalida = 0; |C_M #0#5, 1, "N"; |FINSI;
               |CIERRA #134;
          |FINSI;
     |FINSI;

     |SI #142#72 = "S";
          |HAZ Envase147;
          |C_M #0#5, 1, "S";
          |SI enEntraEnvase ! 0;  |C_M #0#5, 1, "N";  |FINSI;
     |FINSI;
|FPRC;

|PROCESO LeeParam147; |TIPO 7;
     |ABRE #142; |LEE 001#142p; |CIERRA #142;
     |ABRE #279; |LEE 000#279p; |CIERRA #279;
     nPreDtoAnt = 0;

     DescAmpli = #142#201;
     |SI DescAmpli = "N";
          DescAmpli = #142#40;
     |FINSI;
     recoge    = #142#170;
     aTipoTar  = #1#79; ||---- Tarifa Norma o Con Dtos.
     |HAZ LinDiv2;
|FPRC;

|PROCESO LinDiv2;
     |HAZ PintaMedidaV;
     |ABRE #agifa321;
     |LEE 001#agifa321.p;  || Leo parametros de divisa
     |CIERRA #agifa321;

     |SI ac_divisa ! "S";
          |ATRI R;
          |PINTA 1446, "Precio";
          |PINTA 1470, "I.Total";
          |ATRI r;
     |SINO;
          |SI pintado = 0; || Si divisas estan activadas y no he pintado ...
               |SI #1#67 = "D";   || Si la moneda de trabajo es la divisa la pinto en
                    |ATRI R;         || el encabezado del precio y el importe
                    titdiv = "Precio" + "(" + #1#65 + ")";
                    |PINTA 1444,titdiv;
                    titdiv = "I.Tot." + "(" + #1#65 + ")";
                    |PINTA 1468,titdiv;
                    |ATRI r;
               |SINO;
                    |ATRI R;
                    |PINTA 1446, "Precio";
                    |PINTA 1470, "I.Total";
                    |ATRI r;
               |FINSI;
               |SI #agifa321#3 = "S";  || Si la visualizacion esta activada ...
                    ||mensa = "Precio:            Imp:              T.Bruto:             T.FAC:            ";
                    ||PINTA 1103,mensa;  || ... pinto la linea de visualizacion
                    |PINTA 1103, "Precio:";
                    |PINTA 1122, "Imp:";
                    |PINTA 1140, "T.Bruto:";
                    |PINTA 1161, "T.FAC:";
                    |PINTA #0#26; || Pinto precio visual
                    |PINTA #0#27; || Pinto importe visual
                    |SI #1#67 = "D"; || Si la moneda de trabajo es la divisa
                         |PINTA 1149,#1#74;
                         |PINTA 1168,#1#75;
                    |SINO;
                         |PINTA 1149,#1#70;
                         |PINTA 1168,#1#71;
                    |FINSI;
                    pintado = 1;  || Ya hemos pintado
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO precio_divisa;
   #0#24 = #0#6 / #1#69 * #1#66;  || Calculo el precio en divisa
   |HAZ decim1;
|FPRC;

|PROCESO decim1;
     |SI #1#67 = "D";  || Si la moneda de trabajo es la divisa ...
       #0#6 = #0#24 / #1#66 * #1#69;  || ... recalculo en funcion de la divisa
     |SINO;
       #0#24 = #0#6 / #1#69 * #1#66; || .. recalculo en funcion de la moneda base
     |FINSI;
     |HAZ visual_precio; || Visualiza el precio
|FPRC;

|PROCESO visual_precio; || Pinta el precio visual.
|SI #1#67 = "D";  || Si la moneda de trabajo es la divisa ...
  #0#26 = #0#6;   || ... el campo visualiz. es el precio en moneda base
  |PINTA #0#24;
|SINO;            || Si la moneda de trabajo es la moneda base ...
  #0#26 = #0#24;  || ... el campo visual. es el precio en divisa
  |PINTA #0#6;
|FINSI;
|SI ac_divisa = "S"; |Y #agifa321#3= "S";
  |PINTA #0#26; || Si las divisas y la visualizacion estan activadas, pinto
|FINSI;
|FPRC;


|PROCESO visual_importe;  || Pinta el importe visual
|SI #1#67 = "D";  || Si la moneda de trabajo es la divisa ...
  #0#27 = #0#9;   || el campo visualiz. es el importe en moneda base
  |PINTA #0#25;
|SINO;            || Si la moneda de trabajo es la moneda base ...
  #0#27 = #0#25;  || el campo visualiz. es el importe en divisa
  |PINTA #0#9;
|FINSI;
|SI ac_divisa = "S"; |Y #agifa321#3= "S";
  |PINTA #0#27;   || Si las divisas y la visualizacion estan activadas, pinto
|FINSI;
|FPRC;

|PROCESO visual_totales;
   |ABRE #agifa321;
   |LEE 001#agifa321.p;
   |SI #1#67 = "D";
     |SI ac_divisa = "S"; |Y #agifa321#3= "S";
       |PINTA 1149,#1#74;
       |PINTA 1168,"        ";
       |PINTA 1168,#1#75;
     |FINSI;
     |CIERRA #agifa321;
     |PINTA 1349,#1#70;
     |PINTA 1366,#1#71;
   |SINO;
     |SI ac_divisa = "S"; |Y #agifa321#3= "S";
       |PINTA 1149,#1#70;
       |PINTA 1168,"        ";
       |PINTA 1168,#1#71;
     |FINSI;
     |CIERRA #agifa321;
     |PINTA 1349,#1#15;
     |PINTA 1366,#1#41;
 |FINSI;
|FPRC;

|CALCULO Promart;
     |SI #142#250 ! "N"; |Y eaProCliArt = "S";
          articulo = #0#2;
          |ACABA;
     |FINSI;

     |SI nTecla = 16;
          eaArticulo = #0#2;
          eaGrupo = #6#158;
          enAlmacen = #0#3;
          eaCliente = #1#3;
          |HAZ PintaPromo;
          |ENCAMPO #5#0;
     |FINSI;
     enPromo = 1;
     |HAZ PrecArt;
     enPromo = 0;
     ||컴컴컴컴컴컴컴컴컴컴컴컴컴
     articulo = #0#2;
|FCAL;

|PROCESO CogeValores147;  |TIPO 7;
     |SI Campo = 6;
          aAlfa = "0000<F6> Consulta Precios, <F7> Calculo Precio Sin Iva ";
          |HAZ EsTagloma;
          |SI FSalida = 0;
               aAlfa = "0000<F6> Consulta Precios, <F7> Calculo Precio Sin Iva <F9> Cal.Postform.";
          |FINSI;
          |HAZ EsAparecida;
          |SI FSalida = 0;
               aAlfa = "0000<F5> Tarifas  <F6> Consulta Precios   <F7> Calculo Precio Sin Iva ";
          |FINSI;
          |HAZ EsRocai;
          |SI FSalida = 0;
               aAlfa = "0000<F3>Tarifa  <F6>Consulta Precios  <F7>Calculo Precio Sin Iva ";
          |FINSI;
          |MENSA aAlfa;
     |FINSI;
     |SI Campo = 3;
         |C_M #0Campo, 1, "S";
         |SI #142#99 = "S";
             |C_M #0Campo, 1, "N";
             #0Campo = 1;  |PINTA #0Campo;
         |FINSI;
     |FINSI;

     |SI #2#176 = "N";  |ACABA;  |FINSI;

     |SI Campo = 3;
         |SI enAlmacen ! 0;
             #0#3 = enAlmacen;  |PINTA #0#3;
         |FINSI;
     |FINSI;

     |SI Campo = 5;
         |SI enUnidades ! 0;
             |SI #0#5 ! enUnidades;  Contenido = #0#5;  |FINSI;
             #0#5 = enUnidades;  |PINTA #0#5;
         |FINSI;
     |FINSI;

     |SI Campo = 6;
          |SI nPrecio ! 0;
               #0#6 = nPrecio;  |PINTA #0#6;

               |HAZ EsRocai;
               |SI FSalida = 0; #0#10 = nComiRocai; |PINTA #0#10; |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO PideArt147;  |TIPO 7;
     nModo = (FEntrada/100) ! 0;
     |SI #142#140 = "S"; |Y nModo = 1; #0#2 = eaArtAnt; |FINSI;

     |HAZ EsMecanogra;
     |SI FSalida = 0;
          |HAZ MecaTipoLin;
          |SI nMecaMaestra ! 0; |C_M #0#2, 1, "N"; |ACABA; |FINSI;
     |FINSI;
     |HAZ EsForestales;
     |SI FSalida = 0;
          |MENSA "0000<F3> Buscar articulo";
     |FINSI;

     |C_M #0#2, 1, "S";
     |C_M #0#3, 1, "N";

     |SI #0#2 ! "                    ";
         |ABRE #2;
         #2#0 = #0#2;
         |LEE 000#2=;
         |SI FSalida ! 0;  |DDEFECTO #2;  |FINSI;
         |CIERRA #2;
         |SI #2#176 = "S";
             |C_M #0#2, 1, "N";
             |C_M #0#3, 1, "N";
             |ACABA;
         |FINSI;
     |FINSI;

     |ABRE #910;
     |LEE 040#910p;
     |SI FSalida ! 0;  |DDEFECTO #910;  |FINSI;
     |CIERRA #910;

     |SI #910#2 [ 2;    |ACABA;  |FINSI;

     eAlfa = #0Campo;
     |SUB_EJECUTA_NP "dsz99990";                 || Por Pantalla

     |SI eAlfa = "-1";  |PTEC 807;  |ACABA;  |FINSI;
     |SI eAlfa = "-2";              |ACABA;  |FINSI;

     eaArticulo = eAlfa;      ||  700000-4215

     #0Campo = eAlfa;
     |PINTA #0Campo;
     |PTEC 802;
|FPRC;

|PROCESO Calc6147;  |TIPO 6;
     eaArtAnt = #0#2;

     |SI FSalida = 11;   ||F3
          |HAZ EsForestales;
          |SI FSalida = 0;
               |SUB_EJECUTA_NP "goma0008";
               |SI eaArticulo ! "";
                    #0Campo = eaArticulo;
                    |PINTA #0Campo;
               |SINO;
                    |ERROR; |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #0Campo ! Contenido; |Y Campo = 2;
          |HAZ EsTagloma;
          |SI FSalida = 0;    || Quita el F9 del postformado
               nTagQuitaPost = 1;
          |FINSI;
          eaArticulo = #0#2;
          eaCliente = #1#3;
          |HAZ DefectoMediV;
          #0#31 = enMedida1;
          #0#32 = enMedida2;
          #0#33 = enMedida3;
          |HAZ PintaMedidaV;
     |FINSI;
     |HAZ DobleArtiV;
     |SI eaSw2Stock = "S"; |ACABA; |FINSI;

     enAlta = 1;
     eaArticulo = #0Campo;
     |HAZ LlenaArticulo;
     |SI FSalida = 0;
          #0Campo = eaArticulo;
          |PINTA #0Campo;
     |SINO;
          |ERROR; |ACABA;
     |FINSI;

     |ABRE #2;
     #2#0 = #0#2;
     |LEE 000#2=;
     |SI FSalida ! 0;  |DDEFECTO #2;  |FINSI;
     |CIERRA #2;

     |SI #2#176 = "S";
         eaTipo      = "FP";
         eaSerie     = #0#20;
         enCodigo    = #0#0;
         enLinea     = #0#1;
         eaArticulo  = #0#2;
         enAlmacen   = #0#3;
         enUnidades  = #0#5;
         enTBruto    = #0#7;
         eaAbono     = "N";
         enTarifa    = #6#39;
         eaCliente   = #1#3;
         efFecha     = #1#1;
         enCamBas    = #1#66;
         eaMoneda    = #1#67;
         enCamDiv    = #1#69;

         |HAZ EsRocai; |SI FSalida = 0; |HAZ CalcuComi; |FINSI;
         enComision = #0#10;

         |SUB_EJECUTA_NP "dsz00002";

         nComiRocai = enComision;

         #0#3    = enAlmacen;
         nPrecio = enTBruto / enUnidades;

         |PTEC 802;
         |PTEC 802;
         |PTEC 802;
         |PTEC 802;
         |PTEC 802;
         |PTEC 802;
         |PTEC 802;
     |FINSI;

     |HAZ art6pfv;
     |HAZ nomodif1;

     eaCliente = #1#3;
     efFecha = #1#1;
     Contenido = articulo;
     |HAZ SacaKit;
     |SI eaModiKit = "S";     || Se ha mdoificado el kit
          |HAZ EsTagloma;     || Precio Kit (dsz99986)
          |SI FSalida = 0;
               #0#6 = enPreKitCal;
               |HAZ precio_divisa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo11147;  |TIPO 11;
     |SI FSalida = 7;  |Y #2#176 = "S";
         |MENAV "      Imposible abortar;  Termine de introducir la linea y efectue una Baja.";
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO control2;
   aponer= Anosi;
   |HAZ poncontr;
|FPRC;

|PROCESO poncontr;
         fiac = Control % A109;
         fiac = fiac + relleno;
         guarda = fiac % A109;
         fiac = Control % A1001;
         Control = Control + fiac;
         Control = Control + relleno;
         Control = Control % A120;
         Control = Control + aponer;
|FPRC;

|PROCESO Tipo3_147;|TIPO 3;
     aAlfa = #0#2;
     |SI aAlfa ! ""; |Y DescAmpli = "S";
          aTipoDA = "X"; |HAZ AltaDA;
     |FINSI;
|FPRC;

|PROCESO Recoge;
     |SI recoge = "N";
          |PUSHV 0400 0479;
          |MENAV "0000Opcion no activada en Parametros Generales";
          |POPV;
          |ERROR;
          |ACABA;
     |FINSI;
     || compruebo que este en la ultima linea y en modo alta
     nLineaD = #0#1;    || Guardo puntero
     nLineaD = nLineaD +1;     || Porque si estoy en alta la linea en la que
                               || estoy todavia no esta grabada
     |LEE 001#0];

     |SI modo ! 1; FSalida = -1; |FINSI;

     |SI FSalida ! 0; |O #0#0 ! #1#0; |O #0#20 ! #1#48;
          nLineaD = nLineaD -1;

          || Recupero el puntero
          #0#0  = #1#0;    || pedido
          #0#20 = #1#48;   || Serie
          #0#1  = nLineaD;        || Numero de linea
          |LEE 000#0=;

          nerror = 0;
          |HAZ entradatos;
          |SI nerror = 0 ;
               aponer = Asino; |HAZ poncontr;
               |HAZ leelineas;
               aponer = Anosi; |HAZ poncontr;
               |PTEC 816;
               |PTEC 812;
          |SINO;
               |ERROR;
          |FINSI;
     |SINO;
          || Recupero el puntero
          nLineaD = nLineaD - 1;
          #0#0  = #1#0;     || pedido
          #0#20 = #1#48;    || Serie
          #0#1  = nLineaD;         || Numero de linea
          |LEE 000#0=;

          |MENAV "0000Debe estar en la ultima linea";
          |ERROR;
     |FINSI;    || Si #0#1 = 1 ...
|FPRC;

|PROCESO entradatos;
     |SUB_EJECUTA_NP "dsz00106";
     serie_o = eaSerie;
     pedido_o = enCodigo;
     |SI serie_o = #1#48;|Y pedido_o = #1#0;
         |MENAV "0000ATENCION !!! Esta en esta F.Proforma";
         nerror = 1;
     |FINSI;
|FPRC;

|PROCESO dsm00046Kit;
     #946#0 = #0#20;
     #946#1 = #0#0;
     #946#2 = #0#1;
     |GRABA 020#946n;
|FPRC;

|DEFBUCLE dsm00046Kit;
     #946#1;
     ;
     serie, pedido, nlinea, 001;
     serie, pedido, nlinea, 999;
     ;
     NULL, dsm00046Kit;
|FIN;

|PROCESO CreaComponente;
     #905#0 = "PV";
     #905#1 = #0#20;
     #905#2 = #0#0;
     #905#3 = #0#1;
     #905#7 = #0#6;
     #905#8 = #905#6 * #905#7;
     #905#9 = 0;
     #905#11 = 0;
     #905#12 = 0;
     |GRABA 020#905n;
     |LIBERA #905;
|FPRC;

|DEFBUCLE dsm00005;
     #905#1;
     ;
     "PV", serie, pedido, nlinea, "      ";
     "PV", serie, pedido, nlinea, "zzzzzz";
     be;
     NULL, CreaComponente;
|FIN;

|PROCESO crealineasV;
    || Clave primaria
    #0#20= #1#48;        || Serie
    #0#0 = #1#0;         || Numero de Pedido
    #0#1 = nLineaD;      || Numero de linea

    |BUCLE dsm00046Kit; || Kit

    |DEFECTO #0#1;   || Cargo los valores de defecto de cab.pedido

    || Procedo a cambiar lo que no es igual

    |HAZ defecfc;                  || Este proceso carga los defectos, ya que
                                   || estos no estan puestos en D000.....
                                   || porque no iba bien.
    || Procedo a cambiar lo que no es igual
    #0#12 = "";             || Numero de pedido
    nPrecio = #0#6;

    |HAZ totfc;        || Calculo total linea
    |HAZ fcacarti;     || Lo envio al t ipo 2 para que calcule lo mismo que si fuera
                       || una linea introducida por el operador
    #0#6 = nPrecio;
    |GRABA 021#0b;
    |LIBERA #0;

    |BUCLE dsm00005;

    nLineaD = nLineaD + #142#236;  || Aumento contador de lineas
|FPRC;

|PROCESO RecalLin;
     |HAZ TotalLin147;
     |HAZ CalCabAgifa146;
     |GRABA 020#0a;
     |LIBERA #0;
|FPRC;

|DEFBUCLE RecalLin;
     #0#1;
     ;
     #1#48, #1#0, 001;
     #1#48, #1#0, 999;
     be;
     NULL, RecalLin;
|FIN;

|PROCESO CopiaCompo;
     #50#0 = #1#48;
     #50#1 = #1#0;
     #50#2 = nLineaD;
     |GRABA 020#50n;
|FPRC;

|DEFBUCLE CopiaCompo;
     #50#1;
     ;
     #0#20, #0#0, #0#1, 001;
     #0#20, #0#0, #0#1, 999;
     ;
     NULL, CopiaCompo;
|FIN;

|PROCESO leelineas;
      #0#20 = serie_o;
      #0#0  = pedido_o;
      #0#1  = 1;
      |LEE 001#0];
      |SI FSalida = 0;
          |PARA; |SI FSalida =0; |Y #0#20 = serie_o; |Y #0#0 = pedido_o;
                    |HACIENDO;
               |BUCLE CopiaCompo;
               || Me guardo el puntero
               serie   = #0#20;   || Serie y pedido actual
               pedido  = #0#0;
               nlinea  = #0#1;

               |HAZ crealineasV;

               || Recupero puntero
               #0#20 = serie;
               #0#0  = pedido;
               #0#1  = nlinea;
               |LEE 001#0=;

               |LEE 001#0s;

               |SI nLineaD > 1000;
                    |MENAV "0000Se supera la linea 999...";
                    |SAL;
               |FINSI;
           |SIGUE;
           |HAZ LimCabAgifa146;
           |BUCLE RecalLin;

           #1#89 = serie_o;
           #1#90 = pedido_o;
      |SINO;
           |MENAV "0000Atencion !!! No se ha encontrado la F.Proforma indicada";
           |ERROR;
      |FINSI;

      pedido_o = 0;

      || Devuelvo el puntero de la linea
      #0#20= #1#48;       || Serie
      #0#0 = #1#0;        || pedido
      #0#1 = nLineaD;     || Linea
      |LEE 001#0=;
|FPRC;

|PROCESO Tipo5_147;  |TIPO 5;
     nModo = (FEntrada / 100) ! 0;
     |HAZ actal;

     |SI nModo = 1;
          |HAZ EsTagloma;
          |SI FSalida = 0;
               aAlfa = aAlfa + "tagm0091";
               |CARGA_DEF aAlfa, referen1@;
               |SI FSalida = 0;
                    |ABRE #referen1@;
                    #referen1@#0 = #1#48;
                    #referen1@#1 = #1#0;
                    |LEE 000#referen1@.=;
                    aAlfa = #referen1@#2; |QBF aAlfa;
                    |SI FSalida ! 0; |O aAlfa = "";
                         |MENAV "0000Seccion no informada...";
                         |PTEC 807;
                    |FINSI;
                    |CIERRA #referen1@;
                    |DESCARGA_DEF #referen1@;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CtaArt1;
     eaModulo = "agifa146"; |HAZ CtaArt;

     |HAZ EsMecanogra;
     |SI FSalida = 0;
          |HAZ MecaCheqArti;
          |SI FSalida = 0; |ERROR; |ACABA; |FINSI;
     |FINSI;
     |HAZ EsDesanch;
     |SI FSalida = 0;
          |ABRE #2;
          #2#0 = #0#2;
          |LEE 020#2=;
          |CIERRA #2;
          |SI #2#136 = "N";
               |MENAV "0000El articulo no es de venta...";
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Equivalentes;
     eaArticulo = #0#2;
     enAlmacen = #0#3;
     |SUB_EJECUTA_NP "agifa294";
     #0#2 = eaArticulo; |PINTA #0#2;
     #0#3 = enAlmacen; |PINTA #0#3;
     |ABRE #2;
     #2#0 = #0#2;
     |LEE 000#2=;
     |CIERRA #2;
     #0#4 = #2#1;
     |PINTA #0#4;
     |SI enSalida ! 0; |Y eaAuto = "N"; |ERROR; |FINSI;
|FPRC;

|PROCESO Descri147; |TIPO 6;
     |SI FSalida = 14;             ||F6
          eaAuto = "N";
          |HAZ Equivalentes;
     |FINSI;
     |HAZ PintaDes147;
|FPRC;

|PROCESO Minc147;
     #referen1@#20 = #1#48;
     #referen1@#0 = #1#0;
     #referen1@#1 = 001;
|FPRC;

|PROCESO Maxc147;
     #referen1@#20 = #1#48;
     #referen1@#0 = #1#0;
     #referen1@#1 = 999;
|FPRC;

|PROCESO Consulta147; |TIPO 66;
     nLin = 0;
     |DDEF aAlfa;
     aAlfa = aAlfa + "agifa147";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida = 0;
          |ABRE #referen1@;
          |CONSULTA_F_CLAVE #1#referen1@, Minc147, Maxc147;
          |SI FSalida = 0; nLin = #referen1@#1; |FINSI;
          |CIERRA #referen1@;
          |DESCARGA_DEF #referen1@;
     |FINSI;
     |SI nLin ! 0;
          |PTEC 802;
          aAlfa = ("000" + nLin) % -103;
          aPtec = aAlfa % 301; nPtec = &aPtec;
          |PTEC nPtec;
          aPtec = aAlfa % 201; nPtec = &aPtec;
          |PTEC nPtec;
          aPtec = aAlfa % 101; nPtec = &aPtec;
          |PTEC nPtec;
     |FINSI;
|FPRC;

|PROCESO T7_147; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
          #0#1 = #0#1 + #agifa142#236 - 1;
     |FINSI;
     |HAZ PintaDes147;

     |HAZ EsChampiEmar;
     |SI FSalida = 0;
          eaTipo      = "PR";
          eaSerie     = #0#20;
          enCodigo    = #0#0;
          enLinea     = #0#1;
          |HAZ ChampiPinEmar;
     |FINSI;
|FPRC;

|PROCESO ImportaPDA147;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa147";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida ! 0; |ACABA; |FINSI;
     |ABRE #referen1@;
     #referen1@#20 = #1#48;
     #referen1@#0 = #1#0;
     #referen1@#1 = 999;
     |LEE 000#referen1@.];
     |SI FSalida = 0;
          |LEE 000#referen1@.a;
     |SINO;
          |LEE 000#referen1@.u;
     |FINSI;
     |SI FSalida = 0; |Y #referen1@#20 = #1#48; |Y #referen1@#0 = #1#0;
          nLin = #referen1@#1 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
     |CIERRA #referen1@;
     |DESCARGA_DEF #referen1@;

     |DDEF aAlfa; aAlfa = aAlfa + "psion067";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida ! 0; |ACABA; |FINSI;
     |NOME_DAT #referen1@#eaFichero#;
     |ABRE #referen1@;
     |LEE 000#referen1@.p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          #0#20 = #1#48;
          #0#0 = #1#00;
          #0#1 = nLin;
          |GRABA 020#0b;
          #0#2 = #referen1@#0; ||Arti
          #0#4 = #referen1@#1; ||Des
          #0#3 = #referen1@#2; ||Alma
          #0#5 = #referen1@#3; ||Uni
          #0#29 = #referen1@#9; ||Parti
          FEntrada = 100;     ||simula alta
          |HAZ PrecArt;
          |HAZ TotalLin147;
          |HAZ fcacarti;
          |GRABA 020#0a;
          |LIBERA #0;
          nLin = nLin + 1;
          |LEE 000#referen1@.s;
     |SIGUE;
     |CIERRA #referen1@;
     |DELINDEX #referen1@;
     |DESCARGA_DEF #referen1@;
     |PONCONTROL 23, "SI"
     |PTEC 809;
     |PTEC 808;
|FPRC;

|PROCESO MenuTrack147;
     |VARIABLES; {20} aPopup = ""; |FINSI;
     aPopup1 = "-1";  || Si fuera -1 en la posicion
     aPopup2 = 6;
     aPopup3 = "<F4> Copia Proforma";
     aPopup4 = "<F5> Doble Stock/Kit";
     aPopup5 = "<F6> Precios Cliente";
     aPopup6 = "<F8> Descripcion Ampliada";
     aPopup7 = "<12> Consulta Cabecera";
     aPopup8 = "<Ctrl+F7> Captura PDA";
     IaPopup = aPopup1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;
     nSal = FSalida;
     |SI FSalida = 1; nSal = 12; |FINSI;
     |SI FSalida = 2; nSal = 13; |FINSI;
     |SI FSalida = 3; nSal = 14; |FINSI;
     |SI FSalida = 4; nSal = 16; |FINSI;
     |SI FSalida = 5; nSal = 9; |FINSI;
     |SI FSalida = 6; nSal = 25; |FINSI;
     FSalida = nSal;
|FPRC;

|PROCESO Alma147_66; |TIPO 66;
     |ABRE #29;
     #29#0 = #0#3;
     |LEE 000#29];
     |CONSULTA_CLAVE #1#29;
     |SI FSalida = 0;
          #0#3 = #29#0;
          |PINTA #0#3;
     |SINO;
          |ERROR;
     |FINSI;
     |CIERRA #29;
|FPRC;

|PROCESO CheqPCM_PVP147; |TIPO 0;
     eaArticulo = #0#2;
     enPrecio = #0#6;
     enDto1 = #0#8;
     enDto2 = #0#21;
     |HAZ CheqPCM_PVP;

     |SI #279#3 = "S";
          eaArticulo = #0#2;
          enPrecio = #0#6;
          enDto1 = #0#8;
          enDto2 = #0#21;
          nNume =  (enPrecio < enDto1) < enDto2;
          |SI nNume ! nPreDtoAnt;
               |SUB_EJECUTA_NP "dsz00100";
               |SI enError ! 0; |ERROR; |ACABA; |FINSI;
               nPreDtoAnt = nNume;
          |FINSI;
     |FINSI;
|FPRC;

----------------------TAGLOMA POSTFORMADOS--------------------------------
|PROCESO TagEsLinPost;
     nSali = 1; || No es
     |DDEF aAlfa;
     aAlfa = aAlfa + "tagm0056";
     |CARGA_DEF aAlfa, referen3@;
     |SI FSalida = 0;
          |ABRE #referen3@;
          |SELECT #2#referen3@;
          #referen3@#0 = "PR";
          #referen3@#1 = #0#20;
          #referen3@#2 = #0#0;
          #referen3@#5 = #0#1;
          |LEE 000#referen3@.=;
          nSali = FSalida;
          |CIERRA #referen3@;
          |DESCARGA_DEF #referen3@;
     |FINSI;
     FSalida = nSali;
|FPRC;

|PROCESO TagLinPost;
     nSali = 1; || No es
     |DDEF aAlfa;
     aAlfa = aAlfa + "tagm0056";
     |CARGA_DEF aAlfa, referen3@;
     |SI FSalida = 0;
          |ABRE #referen3@;
          #referen3@#0 = "PR";
          #referen3@#1 = #0#20;
          #referen3@#2 = #0#0;
          #referen3@#3 = #0#1;
          |LEE 101#referen3@.=;
          nSali = FSalida;

          |SI nForma = 1;
               |SI nSali = 0;
                    aponer = Asino; |HAZ poncontr;
                    |SI nTagQuitaPost = 1;   || Cambia de articulo
                              |Y enTagEligePost = 0; ||y no elige otro incr.
                         |HAZ TagBorraLinPost;
                         |BORRA 040#referen3@.c;
                    |SINO;
                         |HAZ TagCreaLinPost;
                         #referen3@#5 = nLin;
                         |GRABA 020#referen3@.a;
                    |FINSI;
                    aponer = Anosi; |HAZ poncontr;
                    |PTEC 809; |PTEC 816; |PTEC 806;
               |SINO;
                    || enTagLinBorra la carga el tagm0058
                    ||
                    #referen3@#5 = enTagLinBorra;
                    |HAZ TagBorraLinPost;
                    |SI nTagBorLinPost = 0;
                         |PONCONTROL 23, "SI";
                    |FINSI;
               |FINSI;
          |SINO;
               |SI modo = 3; |Y enModo146 ! 3;
                    |HAZ TagBorraLinPost;
                    |BORRA 040#referen3@.c;
                    |PONCONTROL 23, "SI";
                    |PTEC 809; |PTEC 808;
               |FINSI;
               |SI modo = 3; |Y enModo146 = 3;
                    |BORRA 040#referen3@.c;
               |FINSI;
          |FINSI;

          |CIERRA #referen3@;
          |DESCARGA_DEF #referen3@;
     |FINSI;
     nTagQuitaPost = 0;
     enTagEligePost = 0;
|FPRC;

|PROCESO TagPreDesPost;
     nTagPre = 0;
     aTagDes = "";
     |DDEF aAlfa;
     aAlfa = aAlfa + "tagm0055";
     |CARGA_DEF aAlfa, referen2@;
     |SI FSalida = 0;
          |ABRE #referen2@;
          #referen2@#0 = #referen3@#4;
          |LEE 000#referen2@.=;
          |SI FSalida = 0;
               aTagDes = #referen2@#1;
               nTagPre = #referen2@#2;
               aTagArt = #referen2@#4;
          |FINSI;
          |CIERRA #referen2@;
          |DESCARGA_DEF #referen2@;
     |FINSI;
|FPRC;

|PROCESO AcuProforma;
     |HAZ CalCabAgifa146_2;
     |HAZ visual_totales;
|FPRC;

|PROCESO TagCreaLinPost;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa147";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen1@;
     #referen1@#20 = #0#20;
     #referen1@#0 = #0#0;
     #referen1@#1 = #referen3@#5;
     |LEE 000#referen1@.=;
     |SI FSalida = 0;
          nLin = #referen3@#5;
          |SALVA_DATOS #0;
          |SALVA_DATOS #referen1@;
          |REPON_DATOS #0;
          enForma = -1;
          |HAZ AcuProforma;
          |REPON_DATOS #0;
     |SINO;
          #referen1@#1 = 999;
          |LEE 000#referen1@.];
          |SI FSalida = 0;
               |LEE 000#referen1@.a;
          |SINO;
               |LEE 000#referen1@.u;
          |FINSI;
          |SI FSalida = 0; |Y #referen1@#20 = #0#20;  |Y #referen1@#0 = #0#0;
               nLin = #referen1@#1 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |SI nLin [ #0#1; nLin = #0#1 + 1; |FINSI;
          |DDEFECTO #referen1@;
          #referen1@#20 = #0#20;
          #referen1@#0 = #0#0;
          #referen1@#1 = nLin;
          |GRABA 020#referen1@.b;
     |FINSI;

     |HAZ TagPreDesPost;
     #referen1@#2 = aTagArt;
     #referen1@#3 = 1;
     #referen1@#4 = aTagDes;
     #referen1@#5 = #0#5;
     #referen1@#6 = nTagPre;
     #referen1@#8 = #0#8;
     #referen1@#10 = #0#10;
     #referen1@#11 = #0#11;

     |ABRE #2;
     #2#0 = #referen1@#2;
     |LEE 020#2=;
     |CIERRA #2;
     #referen1@#13 = #2#2;

     #referen1@#15 = #0#15;
     #referen1@#16 = #0#16;
     #referen1@#17 = #0#17;
     #referen1@#21 = #0#21;
     #referen1@#24 = nTagPre;
     |SALVA_DATOS #0;

     |SALVA_DATOS #referen1@;
     |REPON_DATOS #0;
     enForma = 1;
     |HAZ TotalLin147;
     |HAZ AcuProforma;
     |SALVA_DATOS #0;
     |REPON_DATOS #referen1@;
     |GRABA 020#referen1@.a;

     |REPON_DATOS #0;

     |CIERRA #referen1@;
     |DESCARGA_DEF #referen1@;
|FPRC;

|PROCESO TagBorraLinPost;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa147";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen1@;
     #referen1@#20 = #0#20;
     #referen1@#0 = #0#0;
     #referen1@#1 = #referen3@#5;
     |LEE 101#referen1@.=;
     nTagBorLinPost = FSalida;
     |SI FSalida = 0;
          |SALVA_DATOS #0;
          |SALVA_DATOS #referen1@;
          |REPON_DATOS #0;

          enForma = -1;
          |HAZ AcuProforma;
          |REPON_DATOS #0;
          |BORRA 020#referen1@.a;
     |FINSI;
     |CIERRA #referen1@;
     |DESCARGA_DEF #referen1@;
|FPRC;
--------------------------------------------------------------------------

|PROCESO T147_6_0; |TIPO 0;
     |SI inkey = 0; |O inkey = 3;
          |HAZ EsMecanogra;
          |SI FSalida = 0;
               eaSerie = #0#20;
               enCodigo = #0#0;
               enLinea = #0#1;
               |SUB_EJECUTA_NP "mecam018";
               |HAZ MecanoPin147;
          |FINSI;
     |FINSI;
     |SI #279#3 = "S";
          eaArticulo = #0#2;
          enPrecio = #0#6;
          enDto1 = #0#8;
          enDto2 = #0#21;
          nNume =  (enPrecio < enDto1) < enDto2;
          |SI nNume ! nPreDtoAnt;
               |SUB_EJECUTA_NP "dsz00100";
               |SI enError ! 0; |ERROR; |ACABA; |FINSI;
               nPreDtoAnt = nNume;
          |FINSI;
     |FINSI;
|FPRC;
-----------------------------------------------------------------
|PROCESO MecanoPin147;
     |DDEF aAlfa;
     aAlfa = aAlfa + "mecam018";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida = 0;
          |DDEFECTO #referen1@;
          |ABRE #referen1@;
          #referen1@#0 = #0#20;
          #referen1@#1 = #0#0;
          #referen1@#2 = #0#1;
          |LEE 000#referen1@.=;
          |CIERRA #referen1@;
          |PINTA 1002, "쿑ilm   Solape Iz            Solape De           ";
          |PINTA 1052, "F.Entrega            LM    ";
          |ATRI I;
          |PINTA #referen1@#3;
          |PINTA #referen1@#4;
          |PINTA #referen1@#5;
          |PINTA #referen1@#6;
          |PINTA #referen1@#7;
          |ATRI 0;
          |DESCARGA_DEF #referen1@;
     |FINSI;
|FPRC;

|PROCESO MecaCheqArti;
     nSal = 1;
     |DDEF aPath;
     aAlfa = aPath + "mecam001";
     |CARGA_DEF aAlfa, mecam001@;
     |SI FSalida = 0;
          |ABRE #mecam001@;
          #mecam001@#0 = #0#2;
          |LEE 000#mecam001@.=;
          |CIERRA #mecam001@;
          aAlfa = #mecam001@#3;    ||Articulo Fabricacion
          nNume = #mecam001@#1;    ||Uni paquete
          |DESCARGA_DEF #mecam001@;
          |SI aAlfa = "S";
               |SI nNume = 0;
                    aAlfa = "0000Articulo de fabricacion sin unidades paquete " + #0#2;
                    |MENAV aAlfa;
                    nSal = 0;
               |FINSI;
               |ABRE #13;
               #13#0 = #0#2;
               |LEE 000#13=;
               |SI FSalida ! 0;
                    aAlfa = "0000Articulo de fabricacion sin escandallo " + #0#2;
                    |MENAV aAlfa;
                    nSal = 0;
               |FINSI;
               |CIERRA #13;
          |FINSI;
     |FINSI;

     FSalida = nSal;
|FPRC;

|PROCESO MecaTipoLin;
     nMecaMaestra = 0;
     |DDEF aPath;
     aAlfa = aPath + "mecam018";
     |CARGA_DEF aAlfa, mecam018@;
     |SI FSalida = 0;
          |ABRE #mecam018@;
          |DDEFECTO #mecam018@;
          #mecam018@#0 = #0#20;
          #mecam018@#1 = #0#0;
          #mecam018@#2 = #0#1;
          |LEE 000#mecam018@.=;
          |SI FSalida = 0;
               aFilm = #mecam018@#3;
               nMecaMaestra = #mecam018@#6;
          |FINSI;
          |CIERRA #mecam018@;
          |DESCARGA_DEF #mecam018@;
     |FINSI;
|FPRC;


|PROCESO MecaBorraLin;
     nMecaMaestra = #0#1;
     aSeri = #0#20;
     aPedi = #0#0;
     |DDEF aPath; aAlfa = aPath + "agifa147";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aAlfa = aPath + "mecam018";
     |CARGA_DEF aAlfa, mecam018@;
     |SI FSalida = 0;
          |ABRE #referen1@;
          |ABRE #mecam018@;
          #referen1@#20 = aSeri;
          #referen1@#0 = aPedi;
          #referen1@#1 = #0#1 + 1;|| porque la linea actual esta bloqueada (windows)
          |LEE 101#referen1@.];
          |PARA; |SI FSalida = 0; |Y #referen1@#20 = aSeri; |Y #referen1@#0 = aPedi;
                    |HACIENDO;
               |DDEFECTO #mecam018@;
               #mecam018@#0 = #referen1@#20;
               #mecam018@#1 = #referen1@#0;
               #mecam018@#2 = #referen1@#1;
               |LEE 000#mecam018@.=;
               |SI #mecam018@#6 = nMecaMaestra;
                    |BORRA 020#referen1@.a;
                    |LIBERA #referen1@;
                    |BORRA 040#mecam018@.a;
                    |LIBERA #mecam018@;
               |FINSI;
               |LEE 101#referen1@.s;
          |SIGUE;
          |CIERRA #mecam018@;
          |CIERRA #referen1@;
          |DESCARGA_DEF #mecam018@;
     |FINSI;

     |DESCARGA_DEF #referen1@;
|FPRC;

|PROCESO MecaGraAuxi;
     aAlfa = aPath + "mecam018";
     |CARGA_DEF aAlfa, mecam018@;
     |SI FSalida = 0;
          |ABRE #mecam018@;
          |DDEFECTO #mecam018@;
          #mecam018@#0 = #0#20;
          #mecam018@#1 = #0#0;
          #mecam018@#2 = #0#1;
          |LEE 101#mecam018@.=;
          |SI FSalida ! 0; |GRABA 020#mecam018@.b; |FINSI;
          #mecam018@#3 = aFilm;
          #mecam018@#6 = nMecaMaestra;
          |GRABA 020#mecam018@.a;
          |CIERRA #mecam018@;
          |DESCARGA_DEF #mecam018@;
     |FINSI;
|FPRC;

|PROCESO MecaCreLin;
     #2#0 = #mecaw001@#2;
     |LEE 000#2=;

     #referen1@#20 = #0#20;
     #referen1@#0 = #0#0;
     #referen1@#1 = 999;
     |LEE 000#referen1@.];
     |SI FSalida = 0;
          |LEE 000#referen1@.a;
     |SINO;
          |LEE 000#referen1@.u;
     |FINSI;
     |SI FSalida = 0; |Y #referen1@#20 = #0#20;  |Y #referen1@#0 = #0#0;
          nLin = #referen1@#1 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
     |SI nLin [ #0#1; nLin = #0#1 + 1; |FINSI;
     |DDEFECTO #referen1@;
     #referen1@#20 = #0#20;
     #referen1@#0 = #0#0;
     #referen1@#1 = nLin;
     |GRABA 020#referen1@.b;
     #referen1@#2 = #mecaw001@#2;
     #referen1@#3 = #0#3;
     #referen1@#4 = #mecaw001@#3;

     |SI #mecaw001@#5 = "U";
          #referen1@#5 = #0#5 * #mecaw001@#4;   || Uni1
          #referen1@#31 = #0#31;                || Medida1
     |SINO;
          #referen1@#5 = #0#28 * #mecaw001@#4;
          nAbo = 1;
          |SI #referen1@#5 < 0; nAbo = -1; |FINSI;
          #referen1@#5 = #referen1@#5 * nAbo;
          nNume = #referen1@#5 ! 0;
          |SI nNume ! #referen1@#5;
               |SI nNume > #referen1@#5; #referen1@#5 = nNume; |FINSI;
               |SI nNume < #referen1@#5; #referen1@#5 = nNume + 1; |FINSI;
          |FINSI;
          #referen1@#5 = #referen1@#5 * nAbo;
          #referen1@#31 = 0;
     |FINSI;
     #referen1@#28 = #referen1@#5 * #referen1@#31; || Uni2

     #referen1@#11 = #0#11;
     #referen1@#13 = #0#13;
     #referen1@#15 = #0#15;
     #referen1@#16 = #0#16;
     #referen1@#17 = #0#17;
||---
     |SALVA_DATOS #0;

     |SALVA_DATOS #referen1@;
     |REPON_DATOS #0;
     enForma = 1;
     |HAZ TotalLin147;
     |HAZ MecaGraAuxi;
     nForma = 1;
     |SALVA_DATOS #0;
     |REPON_DATOS #referen1@;
     |GRABA 020#referen1@.a;

     |REPON_DATOS #0;
|FPRC;

|DEFBUCLE MecaCreLin;
     #mecaw001@#1002;
     ;
     "                    ", 001;
     "zzzzzzzzzzzzzzzzzzzz", 999;
     ;
     NULL, MecaCreLin;
|FIN;

|PROCESO MecaCreaLin;
     |HAZ MecaTipoLin;
     |DDEF aPath;
     aAlfa = aPath + "mecaw001";
     |CARGA_DEF aAlfa, mecaw001@;
     |SI FSalida = 0;
          aAlfa = aPath + "agifa147";
          |CARGA_DEF aAlfa, referen1@;
          |SI FSalida = 0;
               nMecaMaestra = #0#1;
               |NOME_DAT #mecaw001@#eaFicMeca#;
               |ABRE #referen1@;
               |ABRE #2;
               aponer = Asino; |HAZ poncontr;
               |BUCLE MecaCreLin;
               aponer = Anosi; |HAZ poncontr;
               |PTEC 809; |PTEC 816; |PTEC 806;
               |CIERRA #2;
               |CIERRA #referen1@;
               |DELINDEX #mecaw001@;
               |DESCARGA_DEF #referen1@;
          |FINSI;
          |DESCARGA_DEF #mecaw001@;
     |FINSI;
|FPRC;

----------------------------------------------
|PROCESO TallerCreaLin147;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa147";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen1@;
     |SI #0#36 > 0;
          nLin = #0#36;
          #referen1@#20 = #0#20;
          #referen1@#0 = #0#0;
          #referen1@#1 = nLin;
          |LEE 121#referen1@.=;
     |SINO;
          #referen1@#20 = #0#20;
          #referen1@#0 = #0#0;
          #referen1@#1 = 999;
          |LEE 000#referen1@.];
          |SI FSalida = 0;
               |LEE 000#referen1@.a;
          |SINO;
               |LEE 000#referen1@.u;
          |FINSI;
          |SI FSalida = 0; |Y #referen1@#20 = #0#20;  |Y #referen1@#0 = #0#0;
               nLin = #referen1@#1 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |SI nLin [ #0#1; nLin = #0#1 + 1; |FINSI;
          |DDEFECTO #referen1@;
          #referen1@#20 = #0#20;
          #referen1@#0 = #0#0;
          #referen1@#1 = nLin;
          |GRABA 020#referen1@.b;
     |FINSI;
     aAlfa = "CANON " + #0#4;
     #referen1@#2 = "xxxxx";
     #referen1@#3 = 1;
     #referen1@#4 = aAlfa;
     #referen1@#5 = #0#5;
     #referen1@#6 = enCanon;
     #referen1@#11 = #0#11;
     #referen1@#13 = #0#13;
     #referen1@#15 = #0#15;
     #referen1@#24 = enCanon;
     #referen1@#36 = -1;
     |SALVA_DATOS #0;

     |SALVA_DATOS #referen1@;
     |REPON_DATOS #0;

     enForma = 1;
     |HAZ TotalLin147;
     |HAZ AcuProforma;

     |SALVA_DATOS #0;
     |REPON_DATOS #referen1@;
     |GRABA 020#referen1@.a;

     |REPON_DATOS #0;

     #0#36 = nLin;       || Linea Promocion

     |CIERRA #referen1@;
     |DESCARGA_DEF #referen1@;
|FPRC;

|PROCESO TallerAcuLin147;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa147";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen1@;
     #referen1@#20 = #0#20;
     #referen1@#0 = #0#0;
     #referen1@#1 = #0#36;     || Usa linea promocion
     |LEE 101#referen1@.=;
     |SI FSalida = 0;
          |SALVA_DATOS #0;
          |SALVA_DATOS #referen1@;
          |REPON_DATOS #0;
          #0#1 = #referen1@#1;
          enForma = -1;
          |HAZ TotalLin147;
          |HAZ AcuProforma;
          |REPON_DATOS #0;
     |FINSI;
     |CIERRA #referen1@;

     |DESCARGA_DEF #referen1@;
|FPRC;

|PROCESO TallerBorLin147;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa147";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #referen1@;
     #referen1@#20 = #0#20;
     #referen1@#0 = #0#0;
     #referen1@#1 = #0#36;     || Usa linea promocion
     |LEE 101#referen1@.=;
     nTallerBorLin = FSalida;
     |SI FSalida = 0;
          |BORRA 020#referen1@.a;
     |FINSI;
     |CIERRA #referen1@;

     |DESCARGA_DEF #referen1@;
|FPRC;

|PROCESO TallerCanon147;
     eaArticulo = #0#2; |QBF eaArticulo;
     |HAZ TallerCanon;
     |SI nForma = 1;
          |SI enCanon ! 0;
               aponer = Asino; |HAZ poncontr;
               |HAZ TallerCreaLin147;
               aponer = Anosi; |HAZ poncontr;
               |PTEC 809; |PTEC 816; |PTEC 806;
          |SINO;
               |SI #0#36 > 0;      || ha cambiado a un articulo sin canon
                    |HAZ TallerBorLin147;
                    #0#36 = 0;
               |FINSI;
          |FINSI;
     |SINO;
          |SI modo = 3; |Y enModo146 ! 3;
               |HAZ TallerAcuLin147;
               |HAZ TallerBorLin147;
               |SI nTallerBorLin = 0;
                    |PONCONTROL 23, "SI";
                    |PTEC 809; |PTEC 808;
               |FINSI;
          |SINO;
               |SI modo = 2;
                    |HAZ TallerAcuLin147;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO PintaDes147;
     |HAZ EsAparecida;
     |SI FSalida = 0;
          |C_A #0#4, 0, nNume;
          |C_A #0#4, 1, 50;
          |PINTA 2302, "쿏escripcion: ";
          |PINTA 2316, #0#4;
          |C_A #0#4, 1, nNume;
     |FINSI;
|FPRC;

|PROCESO ApareceCreaLin147;
     |DDEF aAlfa; aAlfa = aAlfa + "agifa147";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |ABRE #2;
     #2#0 = "9759999";
     |LEE 000#2=;
     |CIERRA #2;

     |ABRE #referen1@;
     |SI #0#36 > 0;
          nLin = #0#36;
          #referen1@#20 = #0#20;
          #referen1@#0 = #0#0;
          #referen1@#1 = nLin;
          |LEE 121#referen1@.=;
     |SINO;
          #referen1@#20 = #0#20;
          #referen1@#0 = #0#0;
          #referen1@#1 = 999;
          |LEE 000#referen1@.];
          |SI FSalida = 0;
               |LEE 000#referen1@.a;
          |SINO;
               |LEE 000#referen1@.u;
          |FINSI;
          |SI FSalida = 0; |Y #referen1@#20 = #0#20;  |Y #referen1@#0 = #0#0;
               nLin = #referen1@#1 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |SI nLin [ #0#1; nLin = #0#1 + 1; |FINSI;
          |DDEFECTO #referen1@;
          #referen1@#20 = #0#20;
          #referen1@#0 = #0#0;
          #referen1@#1 = nLin;
          |GRABA 020#referen1@.b;
     |FINSI;
     #referen1@#2 = #2#0;
     #referen1@#3 = #0#3;
     #referen1@#4 = #2#1;
     #referen1@#5 = -#0#5;
     #referen1@#6 = #0#6;
     #referen1@#8 = #0#8;
     #referen1@#10 = #0#10;
     #referen1@#11 = #0#11;
     #referen1@#13 = #2#2;
     #referen1@#14 = -#0#14;
     #referen1@#15 = #0#15;
     #referen1@#16 = #0#16;
     #referen1@#17 = #0#17;
     #referen1@#21 = #0#21;
     #referen1@#24 = #0#24;
     #referen1@#26 = #0#26;
     #referen1@#36 = -1;
     |SALVA_DATOS #0;

     |SALVA_DATOS #referen1@;
     |REPON_DATOS #0;

     enForma = 1;
     |HAZ TotalLin147;
     |HAZ AcuProforma;

     |SALVA_DATOS #0;
     |REPON_DATOS #referen1@;
     |GRABA 020#referen1@.a;

     |REPON_DATOS #0;

     #0#36 = nLin;       || Linea Promocion

     |CIERRA #referen1@;
     |DESCARGA_DEF #referen1@;
|FPRC;

|PROCESO Aparecida147;
     |ABRE #6;
     #6#0 = #1#4;
     |LEE 000#6=;
     |CIERRA #6;
     |SI #6#113 ! "N"; |ACABA; |FINSI;
     |ABRE #2;
     #2#0 = #0#2;
     |LEE 000#2=;
     |CIERRA #2;

     |SI nForma = 1;
          |SI #2#2 = "975";
               aponer = Asino; |HAZ poncontr;
               |HAZ ApareceCreaLin147;
               aponer = Anosi; |HAZ poncontr;
               |PTEC 809; |PTEC 816; |PTEC 806;
          |SINO;
               |SI #0#36 > 0;      || ha cambiado a un articulo sin
                    |HAZ TallerBorLin147;
                    #0#36 = 0;
               |FINSI;
          |FINSI;
     |SINO;
          |SI modo = 3; |Y enModo146 ! 3;
               |HAZ TallerAcuLin147;
               |HAZ TallerBorLin147;
               |SI nTallerBorLin = 0;
                    |PONCONTROL 23, "SI";
                    |PTEC 809; |PTEC 808;
               |FINSI;
          |SINO;
               |SI modo = 2;
                    |HAZ TallerAcuLin147;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Riesgos147;
     eaCodCliente = #agifa146#3; eaNomCliente = #agifa146#4;
     eaSerie = #0#20; eaTag = "PROFO";  |HAZ SacaRiesgo;
     |SI eaRieSuma = "S"; nRieUtili = nRieUtili + #1#41 + #0#9; |FINSI;

     |SI #agifa142#166 = "S";
          eaDocu = "L";
          eaTipo = "P";
          enImpoDoc = #1#41 + #0#9;
          eaDesdeLinea = "S";
          |HAZ ControlRiesgo;
          eaDesdeLinea = "N";
          |SI enErrRie = 1; |ERROR; |ACABA; |FINSI;
          |SI enAudito = 0;
               |ABRE #43;
               |LEE 000#43u;
               |SI FSalida = 0;
                    nConAu = #43#0 + 1;
               |SINO;
                    nConAu = 1;
               |FINSI;
               |DDEFECTO #43;
               #43#0 = nConAu;
               #43#12 = "PROFORMA";
               #43#1 = #1#48;
               #43#2 = #1#0;
               #43#3 = #1#1;
               #43#4 = #1#3;
               #43#5 = #1#4;
               #43#6 = Usuario % 810;
               #43#7 = nRieTotal;
               #43#8 = nRieUtili;
               #43#9 = #41#2;
               #43#10= #41#3;
               #43#11= #41#4;
               |GRABA 020#43n;
               |CIERRA #43;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ModRie147; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 2; |Y #0Campo ! Contenido;
          |HAZ Riesgos147;
          |SI enErrRie = 1; |ERROR; |FINSI;
     |FINSI;
|FPRC;

|PROCESO IVA147_66; |TIPO 66;
     enTiva = #0Campo;
     efFiva = #1#1;
     |HAZ ConsuIVA;
     |SI eaDiva = "";
          |ERROR;
     |SINO;
          #0Campo = enTiva; |PINTA #0Campo;
     |FINSI;
|FPRC;

|PROCESO IVA147_0; |TIPO 0;
     enTiva = #0Campo;
     efFiva = #1#1;
     |HAZ SacaIVA;
     |SI eaDiva = "";
          |MENAV "0000No existe tipo iva para esta fecha...";
          |ERROR; |ACABA;
     |SINO;
          |HAZ mirespor;
     |FINSI;
|FPRC;

|PROCESO ChampEnvase;
     nLin = nLin + 1;
     |SI nLin > 1;
          |SI nLin = 2;
               aponer = Asino; |HAZ poncontr;
          |FINSI;
          #referen1@#20 = #0#20;
          #referen1@#0 = #0#0;
          #referen1@#1 = 999;
          |LEE 000#referen1@.];
          |SI FSalida = 0;
               |LEE 000#referen1@.a;
          |SINO;
               |LEE 000#referen1@.u;
          |FINSI;
          |SI FSalida = 0; |Y #referen1@#20 = #0#20; |Y #referen1@#0 = #0#0;
               nLin = #referen1@#1 + #142#236;
          |SINO;
               nLin = #142#236;
          |FINSI;
          |SI nLin = #0#1; nLin = nLin + 1; |FINSI;

          |SALVA_DATOS #0;
          |REPON_DATOS #referen1@;
          #referen1@#1 = nLin;
          #referen1@#5 = #referen3@#3 - #referen3@#4;
          |SALVA_DATOS #referen1@;
          |REPON_DATOS #0;
          #0#14 = #0#5 * #2#9;
          |HAZ TotalLin147
          |HAZ AcuProforma;
          |SALVA_DATOS #0;
          |REPON_DATOS #referen1@;
          |GRABA 020#referen1@.n;

          |DDEFECTO #referen2@;
          #referen2@#0 = #referen1@#20;
          #referen2@#1 = #referen1@#0;
          #referen2@#2 = #referen1@#1;
          |LEE 101#referen2@.=;
          |SI FSalida ! 0; |GRABA 020#referen2@.b; |FINSI;
          #referen2@#3 = #referen3@#2;
          #referen2@#4 = #referen3@#3;
          #referen2@#5 = #referen3@#4;
          #referen2@#6 = #referen3@#1;
          |GRABA 020#referen2@.a;
          |LIBERA #referen2@;
     |FINSI;
|FPRC;

|DEFBUCLE ChampEnvase;
     #referen3@#1001;
     ;
     001;
     999;
     ;
     NULL, ChampEnvase;
|FIN;

|PROCESO ChampiEmarEnv;
     |DDEF aPath;
     aAlfa = aPath + "agifa147";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida = 0;
          aAlfa = aPath + "champi11";
          |CARGA_DEF aAlfa, referen2@;
          |SI FSalida = 0;
               aAlfa = aPath + "champi09";
               |CARGA_DEF aAlfa, referen3@;
               |SI FSalida = 0;
                    |NOME_DAT #referen3@#eaTmpPR816#;
                    nLin = 0;

                    |SALVA_DATOS #0;
                    |ABRE #referen1@;
                    |ABRE #referen2@;
                    |BUCLE ChampEnvase;
                    |CIERRA #referen2@;
                    |CIERRA #referen1@;
                    |REPON_DATOS #0;
                    |SI nLin > 1;
                         aponer = Anosi; |HAZ poncontr;
                         |PTEC 809; |PTEC 816; |PTEC 806;
                    |FINSI;

                    |DELINDEX #referen3@;
                    |DESCARGA_DEF #referen3@;
               |SINO;
                    |MENAV "0000Error al cargar 'champi09'";
               |FINSI;
               |DESCARGA_DEF #referen2@;
          |SINO;
               |MENAV "0000Error al cargar 'champi11'";
          |FINSI;
          |DESCARGA_DEF #referen1@;
     |SINO;
          |MENAV "0000Error al cargar 'agifa147'";
     |FINSI;
|FPRC;

|PROCESO ChampiEmarBor;
     |DDEF aPath;
     aAlfa = aPath + "champi11";
     |CARGA_DEF aAlfa, referen1@;
     |SI FSalida = 0;
          |ABRE #referen1@;
          #referen1@#0 = #0#20;
          #referen1@#1 = #0#0;
          #referen1@#2 = #0#1;
          |BORRA 000#referen1@.c;
          |CIERRA #referen1@;
     |SINO;
          |MENAV "0000Error al cargar 'champi11'";
     |FINSI;
|FPRC;

|PROCESO Precio7; |TIPO 7;
     |C_M #0Campo, 0, aAlfa;
     |SI #142#250 = "X"; |Y aAlfa = "S";
          |SI aArtiPromo = #0#2;
               #0Campo = #0Campo + #0#37;
          |SINO;
               aArtiPromo = #0#2;
               #0#37 = 0;
          |FINSI;
     |FINSI;
|FPRC;
