|FICHEROS;
     agifa071 #0;        || Lineas Adjudicacion
     agifa010 #1;        || Cabecera Adjudicacion
     agifa104 #2;        || Cabecera Pedidos
     agifa073 #3;        || Lineas Pedidos
     agifa019 #4;        || Articulos
     agifa017 #5;        || Almacen
     agifa024 #6;        || Clientes
     agifa065 #7;        || Historico
     agifa112 #9;        || Proveedores
     agifa215 #20;       || Temporal seleccion Articulos
     agifa007 #21;       || Series.
     tempo081 #81;
     agifa321 #15;       || DIV - Parametros
     agifa324 #15;       || DIVISAS
     agifa142 #42;
     dsm00005 #905;
     dsm00010 #910;
     dsw00022 #922;      || Tmp Adj por Articulos Elemento
     dsm00046 #946;
     dsm00047 #947;
     dsm00234 #234;
     dsm00235 #235;
     dsm00246 #40;       ||Control Riesgo Por Usuarios.
     dsm00247 #41;       ||Pantalla Informe Riesgo.
     dsm00248 #43;
     agifa048 #480;
     dsm00020 #200;

     agis0002 #1000;
|FIN;

|VARIABLES;
     &enUdPedUno = 0;
     &enUdPedDos = 0;

     nLinV          = 0;
     &enUniKit      = 0;
     nSwServida     = 0;
     &dtos_1        = 0;
     &dtos_2        = 0;
     &art_dt        = "";
     nModo          = 0;
     &nDispoKit     = 0;
     &Nopregunta    = 0;
     &nPed_baja     = 0;
     &aSer_baja     = "";
     &nLin_baja     = 0;

     nCalc = 0;
     nImpAd = 0;

     nEsKit         = 0;
     nConAu         = 0;
     &nMasRies      = 0;
     nTries         = 0;
     nAudito        = 0;
     aUs            = "";
     &Tempo         = "";
     aTempo81       = "";
     &eaTempo020    = "";
     &eaTempo922    = "";
     nDesprecia     = 0;
     aMensa         = "";
     aObs           = "";
     &eaTag         = "";
     nMult          = 0;
     &nImpo         = 0;
     mes            = 0;
     &enTipo        = 0;
     &aSerAntes     = "";
     &nNumAntes     = 0;
     aPtec          = "";
     nPtec          = 0;
     nPrecio        = 0;
     nLin           = 0;
     nNume          = 0;
     nForma         = 0;
     nCampo         = 0;
     aAlfa          = "";
     nTecla         = 0;

     &ser_alb        = "";
     &num_alb        = 0;
     &enLineaAlb     = 0;
     &enSwPanta      = 1;
     &enPedCab       = 0;
     &ser_ped        = "";
     &num_ped        = 0;
     &lin_ped        = 0;

     &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_Div      = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDiv   = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVis   = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVis = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVis   = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVis   = 0;   || Decimales en el Importe visual. (lineas)
     &nDeci_BaseMxP  = 0;   || Decimales en Totales de la moneda base (Maxima precision)
     &nDeci_PreBasMxP= 0;   || Decimales en el Precio en moneda base (Maxima precision)
     &nDeci_DivP     = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDivP  = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVisP  = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVisP= 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVisP  = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVisP  = 0;   || Decimales en el Importe visual. (lineas)
     tecla      = "";
     &ac_divisa = ""; ||
     mensa      = ""; || Linea de visualizacion
     &pintado   = 0;|| Controla el pintado de mensa para que solo lo haga 1 vez
     titdiv = "";   || Encabezado de precio e imp. con la divisa "Imp.Tot(USD)"
     aprograma = "";
     vcontrol       = "";
     &Envase    = "";
     &Unidades1 = 0;
     &Unidades2 = 0;
     &VArticulo = "";
     &qAbono    = "";

     sw_adjf1       = 0;
     asto           = 0;
     tuni           = 0;
     a              = 0;
     b              = 0;
     operacion      = "";
     operainte      = "";
     inkey          = 0;
     &act_ent       = "N";
     &correcto      = "N";
     &fichero       = "";
     &cliente       = "";
     &serv_art      = "N";
     &programa      = "agifa210";
     servir         = "N";
     fmes           = "";
     fiac           = "  ";
     guarda         = "  ";
     relleno        = "                                       ";
     aponer         = "  ";
     mensaje        = "";
     &n_dec         = 0;
     &n_pre         = 0;
     &sw_modo       = 0;
     modo           = 0;
     i              = 0;
     linea          = 0;
     cantidad       = 0;
     importe        = 0;
     &serie         = "";
     &pedido        = 0;
     &lineap        = 0;
     &codigo        = "";
     &descrip       = "";
     &unid          = 0;
     &Cliente = "";
     &SPedido = "";
     &NPedido = 0;
     &PPedido = "";
     &FPedido = @;
     &TPedido = 0;
     &BAdela  = 0;
     &TipoCta = "A";
     &ser           = "";
     &doc           = 0;
     abono          = 1;

     l1_inf         = "";
     l1_sup         = "";
     &ser_ped_inf   = ""; ||Serie (inf. y sup.) del pedido que pasaremos
     &ser_ped_sup   = ""; ||al defbucle de agit0001
     fich           = "";

     aDespreciar    = "";
     aPedCompleto   = "N";
     nPendiente     = 0;
     nPendiente2    = 0;
     nPorArticulo   = 0;
     nSoloEstas1    = 0;
     nSoloEstas2    = 0;
     &nRieUtili     = 0;
     &nRieTotal     = 0;

     &qArti         = "";
     &qUnid         = 0;

     importeD      = 0;
     nImpDiv        = 0;

     &enSubBoton1   = 0;
     &enSubBoton2   = 0;
     &enSubBoton3   = 0;
     &enSubBoton4   = 0;
     &enSubBoton5   = 0;
     &enSubBoton6   = 0;
|FIN;

|INCLUYE i_varart;

|PROCESO licogea; |TIPO 0;
     sw_adjf1     = 0;
     aPedCompleto = "N";
     modo         = (FEntrada / 100) ! 0;
|FPRC;

|PROCESO GrabaCompoN;
     |SALVA_DATOS #905;

     #905#0  = "AV";
     #905#1  = #0#29;
     #905#2  = #0#0;
     #905#3  = #0#1;
     #905#6  = #905#6 - #905#12;
     #905#8  = #905#6 * #905#7;
     #905#9  = 0;
     #905#11 = 0;
     #905#12 = 0;
     |GRABA 020#905n;
     |LIBERA #905;

     |REPON_DATOS #905;
     |LEE 040#905=;

     eaTipo        = "AV";
     eaSerie       = #0#29;
     enCodigo      = #0#0;
     enLinea       = #0#1;
     efFecha       = #1#1;
     eaArticulo    = #0#2;
     enAlmacen     = #0#3;
     eaComponente  = #905#4;
     enUnidades    = #0#5;
     enTBruto      = #0#7;
     eaAbono       = #1#43;
     enTarifa      = #6#39;
     eaSeriePedido = #0#31;
     enCodigPedido = #0#12;
     enLineaPedido = #0#21;
     eaEsNecesario = "S";
     enCamBas      = #1#69;
     eaMoneda      = #1#70;
     enCamDiv      = #1#74;
     |SUB_EJECUTA_NP "dsz00002;AVC";
|FPRC;

|DEFBUCLE dsm00005N;
     #905#1;
     ;
     "PV", #0#31, #0#12, nLinV, "      ";
     "PV", #0#31, #0#12, nLinV, "zzzzzz";
     ;
     NULL, GrabaCompoN;
|FIN;

|PROCESO ActuaResto;
     #1#41  = #1#41 +. 1;
     nForma = 0     +. 1;

     |ABRE #4;
     |ABRE #6;
     |ABRE #7;
     |ABRE #9;

     |HAZ lee_arti;
     |HAZ lee_clien;


     |SI #0#12 ! 0; |O #0#31 ! "  ";
         |HAZ AlPedido;
     |FINSI;

     importe = ((((#0#9 < #1#5) < #1#32) < #1#7));
     #0#23 = #3#5 * abono;
     #0#24 = #3#5 - #3#43;

     |LIBERA #4;
     |HAZ actua_cabe;

     #6#50 = #6#50 +. importe;
     |GRABA 021#6a;
     |LIBERA #6;
     |CIERRA #6;
     |CIERRA #4;
     |CIERRA #7;
     |CIERRA #9;

     enImpCliPen = importe * nForma;
     eaCliente = #1#3;
     efFecha = #1#1;
     |HAZ AcumulaCli;
|FPRC;

|PROCESO dsm00046;
     |DDEFECTO #947;
     #947#0 = #0#29;
     #947#1 = #0#0;
     #947#2 = #0#1;
     #947#3 = #946#3;
     #947#4 = #946#4;
     #947#5 = #946#5;
     #947#6 = #946#6;
     #947#7 = #946#7;
     #947#8 = #946#8;
     |GRABA 020#947n;
|FPRC;

|DEFBUCLE dsm00046;
     #946#1;
     ;
     #3#28, #3#0, #3#1, 001;
     #3#28, #3#0, #3#1, 999;
     ;
     NULL, dsm00046;
|FIN;

|PROCESO SirveLinea;
     |SI #3#15 = "S"; |ACABA; |FINSI;   || Linea Bloqueada

     |ABRE #4; #4#0 = #3#2; |LEE 000#4=; |CIERRA #4;

     aAlfa = #3#2; |QBF aAlfa;
     |SI aAlfa ! "";
          |SI #42#224 = "B";
               |SI #4#179 = "S";
                    |SI #3#43 = #3#5; |Y #3#49 = #3#44; |ACABA; |FINSI;
               |SINO;
                    |SI #3#43 = #3#5;  |ACABA; |FINSI;
               |FINSI;
          |SINO;
               |SI #3#43 = #3#5;  |ACABA; |FINSI;
               |SI #4#179 = "S";
                    |SI #3#49 = #3#44; |ACABA; |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     efFec = #1#1;
     enAlma = #3#3;
     |HAZ MiraHisL;
     |SI enErrHis ! 0;
          |ACABA;
     |FINSI;

     eaArticulo = #3#2;
     |HAZ EsKit;
     nEsKit = FSalida;

     |SI aPedCompleto ! "S";
          |SI nEsKit = 0;
               |SI ctrl_st ! "N";
                    enProg211 = 1;
                    |HAZ DispoKit;
                    enProg211 = 0;
               |FINSI;
               |SI nDispoKit ! 0;
                    |SI ctrl_st = "S"; |O ctrl_st = "X";
                         aMensa = "0000Superado Stock para KIT."+&13+"Linea Pedido:" + #3#1;
                         |MENAV aMensa;
                         |SI enUniKit > 0;
                              aAlfa = "0000NDisponibles:" + enUniKit + &13 + "Adjudicar disponible";
                               |CONFI aAlfa;
                         |SINO;
                              FSalida = 1;
                         |FINSI;
                         |SI FSalida ! 0;
                              |SI ctrl_st = "X";
                                   servir = "N";
                                   |ACABA;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI aPedCompleto = "S";
          |SI nEsKit = 0;
               |SI ctrl_st ! "N";
                    enProg211 = 1;
                    |HAZ DispoKit;
                    enProg211 = 0;
               |FINSI;
               |SI nDispoKit ! 0;
                    |SI ctrl_st = "S"; |O ctrl_st = "X";
                         aMensa = "0000Superado Stock para KIT."+&13+"Linea Pedido:" + #3#1;
                         |MENAV aMensa;
                         |SI ctrl_st = "X";
                              |SI enUniKit > 0;
                                   aAlfa = "0000NDisponibles:" + enUniKit + &13 + "Adjudicar disponible";
                                    |CONFI aAlfa;
                              |SINO;
                                   FSalida = 1;
                              |FINSI;
                              |SI FSalida ! 0;
                                   servir = "N";
                                   |ACABA;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI ctrl_st = "S"; |O ctrl_st = "X";
                    |ABRE #5;
                    #5#0 = #3#2;
                    #5#1 = #3#3;
                    |LEE 001#5=;
                    |SI FSalida ! 0; |DDEFECTO #5; |FINSI;
                    |CIERRA #5;

                    nPendiente  = #3#5 - #3#43;
                    nPendiente2 = #3#44 - #3#49;
                    aMensa = "";
                    |SI #5#5 < nPendiente; |O #5#47 < nPendiente2;
                        aMensa = "0000Superado Stock:"+ #3#2 +&13+"Linea Pedido:" + #3#1;
                    |SINO;
                        i = #5#5 - #3#5;
                        |SI i < #5#6;  |Y #5#6 ! 0;
                            aMensa = "0000Superado Stock Minimo:"+#3#2+&13+" Linea Pedido:" + #3#1;
                            |MENAV aMensa; aMensa  = "";
                        |FINSI;
                    |FINSI;

                    |SI aMensa ! "";
                        |SI ctrl_st = "X";
                            |SI #5#5 [ 0; |Y #5#47 [ 0;
                                mensaje = "0000Superado Stock Disponible.  Servido : 0";
                                |MENAV mensaje;
                                |ACABA;
                            |SINO;
                                mensaje = "0000Superado Stock Disponible.  Servido : " + #5#5;
                                |MENAV mensaje;
                                servir = "S";
                                nSoloEstas1 = #5#5;
                                nSoloEstas2 = #5#47;
                            |FINSI;
                         |SINO;
                             |MENAV aMensa;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     eaSerie = #agifa071#29; eaTag = "AV";  |HAZ SacaRiesgo;
     |SI eaRieSuma = "S"; nRieUtili = nRieUtili + #3#9 + #1#67; |FINSI;
     |HAZ VerAumento;
     |SI nRieUtili ] nRieTotal; |Y #agifa142#6 = "S"; |Y #1#43 = "N";
         |SI #agifa142#22 = "S"; |AVISO; |FINSI;
         mensaje = "0000Se supera el Riesgo Limite del cliente";
         |SI #agifa142#22 = "P";
             mensaje = "0000Se supera el Riesgo Limite del cliente, No se adjudica Pedido " + #3#0 + " Linea " + #3#1;
             |MENAV mensaje;
             servir = "N";
             |ACABA;
         |FINSI;
         |MENAV mensaje;
     |FINSI;

     ||********************* SERVIMOS LA LINEA ****************
     nSwServida = nSwServida + 1;

     linea   = #0#1;
     |PARA FSalida = 0;  |SI FSalida = 0;  |HACIENDO ;
          |DDEFECTO #0;
          #0#29 = #1#52;       ||Serie
          #0#0 = #1#0;         ||Albaran
          #0#1 = linea;
          |LEE 001#0=;
          linea = linea + 1;
     |SIGUE;

     |PARA i = 2; |SI i [ 10; |HACIENDO i = i + 1;
           #0i = #3i;
     |SIGUE;
     |HAZ AgeTrans;
     aAlfa = #0#2; |QBF aAlfa;
     |SI aAlfa ! "";
          |SI #42#202 = "S"; |O #42#40 = "S";
               aTipoDA = "AP"; |HAZ AltaDA;
          |FINSI;
     |FINSI;

     |SI enUniKit ! 0;
          #0#5 = enUniKit;                   ||Uni disponible en kit
     |SINO;
          |SI correcto = "S";
               #0#5 = #20#6;                 || Cantidad a Servir del 215
          |SINO;
               #0#5  = #3#5 - #3#43;          || Unidades Pedido
               #0#48 = #3#44 - #3#49;
          |FINSI;
     |FINSI;

     |SI nSoloEstas1 > 0;  #0#5  = nSoloEstas1;  |FINSI;
     |SI nSoloEstas2 > 0;  #0#47 = nSoloEstas2;  |FINSI;

     nSoloEstas1 = 0;
     nSoloEstas2 = 0;

     eaArticulo = #0#2;
     |HAZ EsKit;
     |SI FSalida = 0;
          |ABRE #947;
          |BUCLE dsm00046;
          |CIERRA #947;
     |FINSI;

     |ABRE #6;
     #6#0 = #1#3;
     |LEE 020#6=;
     |CIERRA #6;
     |ABRE #21;
     #21#26 = #0#29;
     |LEE 000#21=;
     |CIERRA #21;

     #0#5  = #0#5 * abono;              || Multiplica por -1 cuando el pedido es abono.
     #0#48 = #0#48 * abono;
     #0#49 = #3#45;                     || Partida
     #0#50 = #3#46;                     || Merma
     #0#51 = #3#50;                     || Medida1
     #0#52 = #3#51;                     || Medida2
     #0#53 = #3#52;                     || Medida3

     |SI #6#28 = "S"; |O #21#30 = "S";  || Exportacion
          #0#11 = 0;
     |SINO;
          #0#11 = #3#14;                || Tipo de Iva
     |FINSI;
     #0#12 = #3#0;                      || Pedido
     #0#13 = #3#18;                     || Familia
     #0#15 = #1#3;                      || Cliente
     #0#16 = #3#17;                     || Tipo comision
     #0#17 = #2#19;                     || Tipo Cliente
     #0#19 = "S";                       || Entrega Pedido
     #0#21 = #3#1;                      || Linea Pedido
     #0#23 = #3#5 - #3#43;              || Unidades Pedidas
     #0#24 = 0;                         || Unidades Pendientes
     #0#27 = #3#27;                     || Desc. Ampliada
     #0#31 = #3#28;                     || Serie Pedido
     #0#33 = #3#29;                     || Dto 2
     #0#34 = #3#35;                     || Envase Conversion
     #0#35 = #3#36 - #3#37;
     #0#36 = #3#38;                     || Precio en divisa

     |HAZ TotalLin71;
     |PINDA #0#0;

     |SI aPedCompleto = "S";
         |HAZ ActuaResto;
     |FINSI;

     |SI #2#52 ! 0;
          aAlfa = #6#198 + "P" + (("000" + #2#52) % -103);
          #0#47 = aAlfa;
          #1#85 = "E";
     |FINSI;

     |GRABA 021#0c;
     nLinV = #0#21;
     |BUCLE dsm00005N;
|FPRC;

|PROCESO comp_215;
     |SI #20#6 [ 0; |ACABA;  |FINSI;

     #3#28 = #20#2;
     #3#0  = #20#3;
     #3#1  = #20#4;
     |LEE 001#3=;
     |SI FSalida = 0;  |HAZ SirveLinea;  |FINSI;
|FPRC;

|DEFBUCLE lee_215;
     #20#1;
     ;
     "                    " ,   1;
     "zzzzzzzzzzzzzzzzzzzz" , 999;
     ;
     NULL, comp_215;
|FIN;

|PROCESO poncontr211;
         fiac = Control % A109;
         fiac = fiac + relleno;
         guarda = fiac % A109;
         fiac = Control % A1001;
         Control = Control + fiac;
         Control = Control + relleno;
         Control = Control % A120;
         Control = Control + aponer;
|FPRC;

|RUTINA Ptecs;          ||Pone los Ptec en la linea de pedido
     |ABRE #3;
     #3#28 = #2#25
     #3#0 = #2#0;
     #3#1 = 999;
     |LEE 000#3];
     |SI FSalida = 0;
          |LEE 000#3a
     |SINO;
          |LEE 000#3u;
     |FINSI;
     |SI FSalida = 0; |Y #3#28 = #2#25; |Y #3#0 = #2#0;
          nLin = #3#1 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
     |CIERRA #3;

     |SI nLin < #42#123; nLin = #42#123; |FINSI;
     aAlfa = ("000" + nLin) % -103;
     aPtec = aAlfa % 301; nPtec = &aPtec;
     |PTEC nPtec;
     aPtec = aAlfa % 201; nPtec = &aPtec;
     |PTEC nPtec;
     aPtec = aAlfa % 101; nPtec = &aPtec;
     |PTEC nPtec;
|FRUT;

|DEFBUCLE SirveLi2;
     #3#1;
     15;
     #0#31,#0#12,  1, "N";
     #0#31,#0#12,999, "N";
     ;
     NULL,NULL,NULL,NULL,NULL,SirveLinea;
     #3#2;
|FIN;

|PROCESO graba_lin;
     nSwServida = 0;
     |SI aPedCompleto = "S";
          |ABRE #2;
          aponer = Asino;
          |HAZ poncontr211;
          |SI #0#21 = 0; |Y nPorArticulo = 1;
               |BUCLE SirveLi2;
          |SINO;
               |BUCLELIN 2 SirveLinea #2;
          |FINSI;
          aponer = Anosi;
          |HAZ poncontr211;
          |CIERRA #2;
     |SINO;
          |SI #3#2 = "                    ";
               ||C_M #0#3  , 1 , "N";
               |C_M #0#5  , 1 , "N";
          |SINO;
               ||C_M #0#3  , 1 , "S";
               |C_M #0#5  , 1 , "S";
          |FINSI;
          |HAZ SirveLinea;
     |FINSI;
|FPRC;

|PROCESO miraserv;       ||Verifica que las lineas se puedan servir
     #4#0 = #3#2;
     |LEE 000#4=;
     nPendiente = #3#5 - #3#43;
     nPendiente2 = #3#44 - #3#49;
     |SI #4#179 = "N"; |O #agifa142#117 = "N";  || Tiene Doble Stock
          |SI nPendiente ! 0;
               servir = "S";
               |ERROR;
          |FINSI;
     |SINO;
          |SI #agifa142#224 = "B";
               |SI nPendiente ! 0; |O nPendiente2 ! 0;
                    servir = "S";
                    |ERROR;
               |FINSI;
          |SINO;
               |SI nPendiente ! 0; |Y nPendiente2 ! 0;
                    servir = "S";
                    |ERROR;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Envase211;
     qAbono    = "N";
     Envase    = #0#34;
     Unidades1 = #0#35;
     Unidades2 = #0#5;
     VArticulo = #0#2;
     enAlmacen = #0#3;
     eaProgEnv = "albaran";
     eaTipo = "V";
     |HAZ EntraEnvase;
     #0#34 = Envase;
     #0#35 = Unidades1;
     #0#5  = Unidades2;  |PINTA #0#5;
|FPRC;

|PROCESO Conver211;  |TIPO 7;
     eaArticulo    = #0#2;
     enAlmacen     = #0#3;

     |HAZ DobleUniV;
     |SI eaSw2Stock = "S";
          |C_M #0#5, 1, "N";
     |FINSI;
     |SI #agifa142#72 = "S";
          |HAZ Envase211;
          |C_M #0#5, 1, "S";
          |SI enEntraEnvase ! 0;  |C_M #0#5, 1, "N";  |FINSI;
     |FINSI;
|FPRC;

|PROCESO ControlDispo;
|FPRC;

|PROCESO mas_o_menos; |TIPO 0;          ||Verifico si estoy sirviendo mas o
     |SI #0#12 = 0;  |ACABA;  |FINSI;
                               ||menos de lo pedido
     |HAZ decimal;
     |SI modo = 1; |Y #0#21 = 0;
         aPedCompleto = "S";
     |FINSI;

     |SI aPedCompleto = "N"; |Y correcto = "N"; |Y sw_adjf1 = 0;
          |SI ctrl_st = "S"; |O ctrl_st = "X";
               servir = "S";
               |ABRE #5;
               #5#0 = #3#2;         ||Articulo
               #5#1 = #3#3;         ||Almacen
               |LEE 001#5=;
               |SI FSalida ! 0;|DDEFECTO #5; |FINSI;
               |CIERRA #5;

               eaArticulo = #3#2;
               |HAZ EsKit;
               nEsKit = FSalida;

               |SI nEsKit = 0;
                    |SI ctrl_st ! "N";
                         |HAZ DispoKit;
                    |FINSI;
                    |SI nDispoKit ! 0; servir = "N"; |FINSI;
               |SINO;
                    |SI #3#22 = "S";         || Linea pedido reservada
                         tuni = #5#39 + #5#8;
                    |SINO;
                         tuni = #5#39;
                    |FINSI;
                    |SI tuni < #0#5;
                         mensaje = "0000No existe Stock Disponible";
                         servir = "N";
                    |SINO;
                         i = #5#5 - #0#5;
                         |SI i < #5#6;  |Y i ! 0;
                              ||mensaje = "0000Se sobrepasa el Stock Minimo";
                              ||servir = "N";
                              ||quitado por R.PRIEGO por orden de R.AURA
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI servir = "N";
                    |MENAV mensaje;
                    |SI ctrl_st = "X";
                         |SI Unidades1 = 0;
                              |ERROR;
                         |SINO;
                              |HAZ Conver211;
                              |ERROR;
                          |FINSI;
                          |ACABA;
                     |FINSI;
               |FINSI;
         |FINSI;

         |SI #0#12 ! 0; |O #0#31 ! "  ";  || (7)
             aDespreciar = "N";
             nPendiente  = #3#5 - #3#43;
             nPendiente2 = #3#44 - #3#49;

             |SI #0#5 > nPendiente; |O #0#48 > nPendiente2;
                 |SI #4#176 ! "S";
                     |AVISO;
                     FSalida = 1;
                     |SI nPendiente [ 0; |O nPendiente2 [ 0;
                         |SI #agifa142#224 = "B";
                              FSalida = 0;
                         |FINSI;
                     |FINSI;
                     |SI FSalida = 1;
                          |CONFI "2400NEsta sirviendo mas de lo Pedido, Continuar : ";
                     |FINSI;

                     |SI FSalida ! 0;
                         #0#5  = nPendiente;
                         #0#48 = nPendiente2;
                         #0#35 = #3#36 - #3#37;
                         |PINTA #0#5;
                         |PTEC 814;
                         |ERROR;
                         |ACABA;
                     |SINO;
                         aDespreciar = "S";
                     |FINSI;
                 |FINSI;
             |FINSI;
             |SI #0#5 < nPendiente; |O #0#48 < nPendiente2;
                 |SI #4#176 ! "S"; || Si Division Vertical
                     |SI ctrl_st ! "X";
                         |SI #42#211 = "E";
                              |AVISO;
                              |CONFI "2400NEsta sirviendo menos de lo Pedido, Despreciar : ";
                         |FINSI;
                         |SI #42#211 = "D"; FSalida = 0; |FINSI;
                         |SI #42#211 = "P"; FSalida = 1; |FINSI;
                     |SINO;
                         FSalida = 1;
                     |FINSI;
                     |SI FSalida = 0;
                         nDesprecia = nPendiente - #0#5;
                         |HAZ HistoDespreciar;
                         aDespreciar = "S";
                     |SINO;
                         aDespreciar = "N";
                     |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |HAZ TotalLin71;
|FPRC;

|PROCESO BorraHistoDespreciar;
     |DFICE aAlfa; aAlfa = aAlfa % -205;

     |ABRE #235;
     #235#0 = aAlfa;
     #235#1 = #0#29;
     #235#2 = #0#0;
     #235#3 = #0#1;
     |BORRA 101#235c;
     |CIERRA #235;
|FPRC;

|PROCESO HistoDespreciar;
     |ABRE #234;
     |LEE 000#234p;
     |SI FSalida ! 0; |CIERRA #234; |ACABA; |FINSI;

     |PARA FSalida = 1; |SI FSalida ! 0; |HACIENDO;
          |CONSULTA_CLAVE #1#234;
     |SIGUE;
     |CIERRA #234;

     |DFICE aAlfa; aAlfa = aAlfa % -205;

     |ABRE #235;
     |DDEFECTO #235;
     #235#0 = aAlfa;
     #235#1 = #0#29;
     #235#2 = #0#0;
     #235#3 = #0#1;
     |LEE 101#235=;
     |SI FSalida ! 0; |GRABA 020#235b; |FINSI;
     #235#4 = #0#31;
     #235#5 = #0#12;
     #235#6 = #0#21;
     #235#7 = #0#2;
     #235#8 = #3#42;              || Ped
     |SI #234#2 = "D";
          #235#9 = nDesprecia;    || Devu
          #235#10= 0;             || Recha
     |SINO;
          #235#9 = 0;             || Devu
          #235#10 = nDesprecia;   || Recha
     |FINSI;
     #235#11= #234#0;
     #235#12= #234#1;
     |GRABA 020#235a;
     |CIERRA #235;
|FPRC;

|PROCESO liacarti; |TIPO 2;
     |HAZ ActivaSubBotones;

     |ABRE #42; |LEE 000#42p; |CIERRA #42;
     modo   = (FEntrada / 100) ! 0;
     nForma = 0 +. 1;

     || Si es en modo de baja a todos los efectos es como si no fuera
     || completo
     |SI modo = 2;|O modo = 3;
          efFec = #1#1;
          enAlma = #0#3;
          |HAZ MiraHisL;
          |SI enErrHis ! 0;
               |ERROR;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI modo = 3;  aPedCompleto = "N";  |FINSI;

     |SI aPedCompleto = "N";
         |HAZ ActuaResto;
     |FINSI;
     |SI #0#12 = 0; |Y modo = 1;
         |HAZ ActuaResto;
     |FINSI;
     |SI #0#12 = 0;
          enForma = 0 +. 1;
          |HAZ AcumulaAV;
          enTipEnvase = 2;
          |HAZ Envase211;
     |FINSI;

     |SI modo = 2;
          |ABRE #6;
          |ABRE #4;
          |HAZ ActualizaCliente;
          |CIERRA #4;
          |CIERRA #6;

          |SI enForma = 1;
               |ABRE #2;
               |ABRE #3;
               #2#25 = #0#31;
               #2#0 = #0#12;
               |LEE 000#2=;                       || Leo el pedido Original.
               |SI FSalida = 0;
                    #3#28 = #2#25;
                    #3#0  = #2#0;
                    #3#1  = #0#21;                 || Linea de Pedido.
                    |LEE 101#3=;                  || Leo la linea de pedido.
                    |SI FSalida = 0;
                         |SI #3#3 ! #0#3;
                              #3#3 = #0#3;
                              |GRABA 020#3a;
                         |FINSI;
                         |LIBERA #3;
                    |FINSI;
               |FINSI;
               |CIERRA #3;
               |CIERRA #2;
          |FINSI;
     |FINSI;


     |SI modo = 3;
          |HAZ BorraHistoDespreciar;
          ||컴컴컴컴컴컴컴컴컴컴
          aTipoDA = "A"; |HAZ BajaDA;
          ||컴컴컴컴컴컴컴컴컴컴
          |HAZ BorraKit;
          ||컴컴컴컴컴컴컴컴컴컴
          eaTipo        = "AV";
          eaSerie       = #0#29;
          enCodigo      = #0#0;
          enLinea       = #0#1;
          efFecha       = #1#1;
          eaArticulo    = #0#2;
          enAlmacen     = #0#3;
          enUnidades    = #0#5;
          eaAbono       = #1#43;
          eaSeriePedido = #0#31;
          enCodigPedido = #0#12;
          enLineaPedido = #0#21;
          eaEsNecesario = "S";
          |SUB_EJECUTA_NP "dsz00002;BAJA";
          |SI Nopregunta = 0;  |Y #0#12 ! 0;
               |AVISO;
               aAlfa = "2400NDespreciar Pedido S/N";
               |CONFI aAlfa;
               |SI FSalida = 0;
                    nPed_baja = #0#12;
                    aSer_baja = #0#31;
                    nLin_baja = #0#21;
                    |SUB_EJECUTA "dsz00006";
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ActualizaCliente;
     #4#0 = #0#2;
     |LEE 020#4=;

     #6#0 = #0#15;
     |LEE 121#6=;
     |SI 0 = FSalida;
          |SI #4#194 = 2;
               nImpo = (((((#0#48 * #0#6) < #0#8) < #0#33) < #1#5) < #1#32);
          |SINO;
               nImpo = (((((#0#5 * #0#6) < #0#8) < #0#33) < #1#5) < #1#32);
          |FINSI;
          |SI #42#115 = "S";
               nImpo = nImpo < #1#7;
          |FINSI;
          nImpo = nImpo * nForma;
          fmes = #1#1 % A402;
          mes = fmes - 1;
          mes = mes * 3;
          mes = mes + 114;
          |SI #1#43 = "S";
               #6mes  = #6mes   - nImpo;     || ABONO.
               #6#150 = #6#150  - nImpo;
          |SINO;
               #6mes  = #6mes   + nImpo;     || VENTA.
               #6#150 = #6#150  + nImpo;
          |FINSI;
          |GRABA 020#6a;

          |SI #1#43 = "S"; nImpo = -nImpo; |FINSI;
          eaCliente = #agifa104#4;
          efFecha = #agifa104#1;
          enImpCliPed = nImpo;
          |HAZ AcumulaCli;
     |FINSI;
|FPRC;

|PROCESO actua_cabe;
     |HAZ CalCabAgifa010;

     aObs = #2#53;
     |QBF aObs;
     |SI aObs ! "";
          #1#55 = #2#53;
     |FINSI;
     aObs = #2#54;
     |QBF aObs;
     |SI aObs ! "";
          #1#56 = #2#54;
     |FINSI;
     aObs = #2#55;
     |QBF aObs;
     |SI aObs ! "";
         #1#57 = #2#55;
     |FINSI;

     |HAZ pantcomp2;
|FPRC;

|PROCESO AlPedido;

     |ABRE #2;
     |ABRE #3;
     #2#25 = #0#31;
     #2#0 = #0#12;
     |LEE 101#2=;                       || Leo el pedido Original.
     |SI FSalida = 0;
          #3#28 = #2#25;
          #3#0  = #2#0;
          #3#1  = #0#21;                 || Linea de Pedido.
          |LEE 101#3=;                  || Leo la linea de pedido.
          |SI FSalida = 0;
               #0#14 = #0#5 * #4#9;     || Precio de coste medio.
               cantidad = #0#5;
               |HAZ lee_clien;

               |HAZ ActuaPedido;

               |HAZ tot_ped_div; || Calcula totales de pedido en divisa y campos visual. y no visual.
               |GRABA 021#3a;
               |LIBERA #3;
          |FINSI;
          |GRABA 021#2a;
     |FINSI;
     |LIBERA #2;
     |CIERRA #2;
     |CIERRA #3;
     ||컴컴컴컴컴컴컴컴컴컴
     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbePed2Alb;
     |FINSI;
     ||컴컴컴컴컴컴컴컴컴컴
|FPRC;

__________________________________/ ACTUALIZA EL PEDIDO

|PROCESO VariPedido;
     nPendiente = nPendiente + (#905#6 - #905#12 - #905#11);
     #3#12 = #3#12 + #905#9;
|FPRC;

|DEFBUCLE VariPedido;
     #905#1;
     ;
     "PV", #0#31, #0#12, #0#21, "      ";
     "PV", #0#31, #0#12, #0#21, "zzzzzz";
     ;
     NULL, VariPedido;
|FIN;

|PROCESO MiraQueTraes;
     aDespreciar = "S";
     #905#12 = 0;
     |GRABA 020#905a;
     |LIBERA #905;
|FPRC;

|DEFBUCLE dsm00005P;
     #905#1;
     12;
     "AV", #0#29, #0#0, nLinV, "      ", 1;
     "AV", #0#29, #0#0, nLinV, "zzzzzz", 1;
     be;
     NULL, MiraQueTraes;
|FIN;

|RUTINA ActuaPedido;
     nLinV = #0#1;
     |SI #4#176 = "S"; |BUCLE dsm00005P;  |FINSI;

     || nMult corrige redondeo importe negativo
     |SI #4#194 = 2;
          nImpo = #3#44 * #3#6;
     |SINO;
          nImpo = #3#5 * #3#6;
     |FINSI;
     |SI nImpo < 0; nMult = -1; |SINO; nMult = 1; |FINSI;

     importe  = #2#13;
     importeD = #2#44;
     |SI #4#194 = 2;
          #2#13 = (#3#49 * #3#6)  * nMult;
          #2#44 = (#3#49 * #3#38) * nMult;
     |SINO;
          #2#13 = (#3#43 * #3#6)  * nMult;
          #2#44 = (#3#43 * #3#38) * nMult;
     |FINSI;
     #2#13 = ((((#2#13 < #3#8) < #3#29) < #2#5) < #2#17) < #2#6;
     #2#13 = importe - (#2#13 * nMult);       || Imp Servido (C)

     #2#44 = ((((#2#44 < #3#8) < #3#29) < #2#5) < #2#17) < #2#6;
     #2#44 = importeD - (#2#44 * nMult);       || Imp Servido (C)

     #3#43 = #3#43 +. #0#5;
     #3#49 = #3#49 +. #0#48;

     |SI aDespreciar = "S";
          |SI #4#176 = "S";
               #3#12 = 0;
               |BUCLE VariPedido;
          |SINO;
               #3#12 = #3#43 - #3#42;
               #3#47 = #3#49 - #3#48;
          |FINSI;
     |SINO;
          |SI #42#224 = "B";
               |SI #3#42 = 0;
                    #3#12 = #3#43 - #3#42;
               |FINSI;
               |SI #3#48 = 0;
                    #3#47 = #3#49 - #3#48;
               |FINSI;
          |FINSI;
     |FINSI;

     #2#11 = #2#11 - #3#9;
     #2#42 = #2#42 - #3#39;

     #3#5  = #3#42 + #3#12;
     #3#44 = #3#48 + #3#47;

     |SI #4#194 = 2;
          #3#7    = (#3#44 * #3#6) * nMult;
          nImpDiv = (#3#44 * #3#38) * nMult;
     |SINO;
          #3#7    = (#3#5 * #3#6)  * nMult;
          nImpDiv = (#3#5 * #3#38) * nMult;
     |FINSI;

     #3#9  = ((((#3#7 < #3#8) < #3#29) < #2#5) < #2#17) < #2#6;
     #3#39 = ((((nImpDiv < #3#8) < #3#29) < #2#5) < #2#17) < #2#6;

     #3#7  = #3#7 * nMult;
     #3#9  = #3#9 * nMult;
     #3#39 = #3#39 * nMult;

     #2#11 = #2#11 + #3#9;
     #2#42 = #2#42 + #3#39;

     |SI #2#37 = "D";
         #3#41 = #3#9;
     |SINO;
         #3#41 = #3#39;
     |FINSI;

     |SI #4#194 = 2;
          importe  = (#3#49 * #3#6)  * nMult;
          importeD = (#3#49 * #3#38) * nMult;
     |SINO;
          importe  = (#3#43 * #3#6)  * nMult;
          importeD = (#3#43 * #3#38) * nMult;
     |FINSI;
     importe  = ((((importe  < #3#8) < #3#29) < #2#5) < #2#17) < #2#6;
     importeD = ((((importeD < #3#8) < #3#29) < #2#5) < #2#17) < #2#6;

     enTiva = #3#14;
     efFiva = #2#1;
     |HAZ SacaIVA;
     nCalc = #3#11 % enIva;
     |SI #agifa024#47 = "S";
           nCalc = nCalc + (#3#11 % enRec);
     |FINSI;

     nImpo = #3#11 + nCalc;

     eaTag = "PAA";  |HAZ Riesgos;

     #3#11 = #3#9  - (importe * nMult);|| Imp. Pdte (L)
     #3#37 = #3#37 +. #0#35;

     enTiva = #3#14;
     efFiva = #2#1;
     |HAZ SacaIVA;
     nCalc = #3#11 % enIva;
     |SI #agifa024#47 = "S";
           nCalc = nCalc + (#3#11 % enRec);
     |FINSI;

     nImpo = #3#11 + nCalc;
     eaTag = "PAM";  |HAZ Riesgos;

     nImpo = #2#13;
     #2#13 = importe;                 || Imp Servido (C)
     #2#13 = (#2#13 * nMult) + nImpo;
     #2#12 = #2#11 - #2#13;           || Imp Pdte serv (C)

     nImpo = #2#44;
     #2#44 = importeD;                || Imp Servido (C)
     #2#44 = (#2#44 * nMult) + nImpo;
     #2#43 = #2#42 - #2#44;           || Imp Pdte serv (C)


     #2#24 = #2#24 +. #0#5;           || Ctrl Servido (C)

     ||-------------------Actualiza Historico, Articulo y Almacen
     |SI aDespreciar = "S";
          |SI #4#176 = "S";
               enUnidPend = -nPendiente;
          |SINO;
               enUnidPend = #0#5 + (nPendiente - #0#5);
               enUnidPend2 = #0#48 + (nPendiente2 - #0#48);
          |FINSI;
     |SINO;
          enUnidPend = #0#5;
          enUnidPend2 = #0#48;
          |SI #3#42 = 0; enUnidPend = 0; |FINSI;  ||#3#43
          |SI #3#48 = 0; enUnidPend2 = 0; |FINSI;
     |FINSI;
     enForma = nForma;
     eaReservado = #3#22;
     |HAZ AcumulaAV;

     enTipEnvase = 2;
     |HAZ Envase211;

     nNume  = ((((#0#9 < #1#5) < #1#32) < #1#7)) * nForma;
     #0#14  = enCoste;
     #1#37  = #1#37 + (nNume - enCoste)
     aDespreciar = "N";
|FRUT;

||__________________________________________/ ACTUALIZACIONES

|RUTINA lee_arti;
     #4#0 = #0#2;
     |LEE 101#4=;
     |SI FSalida ! 0;
          |DDEFECTO #4;
          #4#0 = #0#2;
          #4#1 = #0#4;
          |GRABA 021#4b;
     |FINSI;
     |LIBERA #4;
|FRUT;

|RUTINA lee_clien;
     #6#0 = #0#15;
     |LEE 101#6=;
     |SI FSalida ! 0;
          |DDEFECTO #6;
          #6#0 = #0#15;
          |GRABA 021#6b;
     |FINSI;
|FRUT;

_____________________________________/ ACTUALIZA EL HISTORICO DE MOVIMIENTOS.
|CALCULO miraques;|TIPO 0;
     |SI #1#43 = AN;
          a = -1; b = 1;
          operacion = "AV";
          operainte = "AC"; || Si es una Serie Interna
     |SINO;
          a = 1;  b = -1;
          operacion = "BV";
          operainte = "BC"; || Si es una Serie Interna
     |FINSI;
|FCAL;

|PROCESO PintaCampos; |TIPO 7;
     |PINTA #0#5;
     |PINTA #0#48;
|FPRC;

|PROCESO decimal; |TIPO 0;
     #0#5 = #0#5 ! n_dec;
     |PINTA #0#5;
     |PINTA #0#48;
|FPRC;

|PROCESO Mini; |TIPO 0;
     |SI FSalida = 5;
          enTipEnvase = 1;
          |HAZ Envase211;
     |FINSI;

     |SI #0#5 [ 0; |ACABA; |FINSI;
     qArti = #0#2;
     qUnid = #0#5;
     |HAZ ComproMin;
     |SI enErr ! 0;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO a_cta;|TIPO 11;
     nTecla = FSalida;
     |SI nTecla = 13;
          |HAZ VerKit;
          |HAZ VerDobleUniV;
          |ERROR; |ACABA;
     |FINSI;

     |SI nTecla = 10;
         ser_ped = #0#31;
         num_ped = #0#12;
         lin_ped = #0#21;

         |SUB_EJECUTA_NP "dsy00002";
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #0#2; |QBF aAlfa;
     |SI nTecla = 16; |Y aAlfa ! "";
          |SI #42#202 = "S"; |O #42#40 = "S";
               aTipoDA = "A"; |HAZ VerDA;
          |FINSI;
          |ERROR;
     |FINSI;

     |SI nTecla =  9;
          TipoCta = "P";
          Cliente = #0#15;
          SPedido = #0#31;
          NPedido = #0#12;
          FPedido = #1#1;
          PPedido = #1#8;
          TPedido = 0;
          BAdela  = 0;
          |SUB_EJECUTA_NP "agis0002";
          |BLIN 24;
          |CONFI "2400NDesea imprimir el recibo? ";
          |SI FSalida = 0;
               ser = SPedido;
               doc = NPedido;
               eaDivisa = #agifa104#35;
               |HAZ ImpreACta;
           |FINSI;
           |ERROR;
     |FINSI;
|FPRC;

|CALCULO pantcomp2;|TIPO 13;
   |HAZ visual_totales2; || Visualiza los totales
|FCAL;

|PROCESO decim2;
     |SI #1#70 = "D";  || Si la moneda de trabajo es la divisa ...
         #0#6 = #0#36 / #1#69 * #1#74;  || ... recalculo en funcion de la divisa
     |SINO;
         #0#36 = #0#6 / #1#74 * #1#69; || .. recalculo en funcion de la moneda base
     |FINSI;

     #0#9 = #0#5 * #0#6;
     |PINTA #0#9;
     |PINTA #0#5;
     |PINTA #0#48;
|FPRC;

|PROCESO ActivaSubBotones;
     |ESTADO_CONTROL enSubBoton1, "ENABLE";
     |ESTADO_CONTROL enSubBoton2, "ENABLE";
     |ESTADO_CONTROL enSubBoton3, "ENABLE";
     |ESTADO_CONTROL enSubBoton4, "ENABLE";
     |ESTADO_CONTROL enSubBoton5, "ENABLE";
     |ESTADO_CONTROL enSubBoton6, "ENABLE";
|FPRC;

|PROCESO LinDiv2;  |TIPO 7;
     |HAZ PintaMedidaV;
     |ABRE #agifa321;
     |LEE 001#agifa321.p;  || Leo parametros de divisa
     |SI ac_divisa = "S"; |Y pintado = 0; || Si divisas estan activadas y no he pintado ...
       |SI #1#70 = "D";   || Si la moneda de trabajo es la divisa la pinto en
         |ATRI R;         || el encabezado del precio y el importe
         titdiv = "Precio" + "(" + #1#68 + ")";
         ||PINTA 1444,titdiv;
         titdiv = "I.Tot." + "(" + #1#68 + ")";
         ||PINTA 1468,titdiv;
         |ATRI r;
       |FINSI;
       |SI #agifa321#3 = "S";  || Si la visualizacion esta activada ...
         mensa = "Precio:            Imp.:              T.Bruto:             T.ALB:             ";
         ||PINTA 1102,mensa;  || ... pinto la linea de visualizacion
         ||PINTA #0#38; || Pinto precio visual
         ||PINTA #0#39; || Pinto importe visual
         |SI #1#70 = "D"; || Si la moneda de trabajo es la divisa
           ||PINTA 1149,#1#79;
           ||PINTA 1168,#1#80;
         |SINO;
           ||PINTA 1149,#1#75;
           ||PINTA 1168,#1#76;
         |FINSI;
         pintado = 1;  || Ya hemos pintado
       |FINSI;
     |FINSI;
     |CIERRA #agifa321;
|FPRC;

|PROCESO visual_precio2; || Pinta el precio visual.
|SI #1#70 = "D";  || Si la moneda de trabajo es la divisa ...
  #0#38 = #0#6;   || ... el campo visualiz. es el precio en moneda base
  ||PINTA #0#36;
|SINO;            || Si la moneda de trabajo es la moneda base ...
  #0#38 = #0#36;  || ... el campo visual. es el precio en divisa
  ||PINTA #0#6;
|FINSI;
|SI ac_divisa = "S"; |Y #agifa321#3= "S";
  ||PINTA #0#38; || Si las divisas y la visualizacion estan activadas, pinto
|FINSI;
|FPRC;


|PROCESO visual_importe2;  || Pinta el importe visual
|SI #1#70 = "D";  || Si la moneda de trabajo es la divisa ...
  #0#39 = #0#9;   || el campo visualiz. es el importe en moneda base
  ||PINTA #0#37;
|SINO;            || Si la moneda de trabajo es la moneda base ...
  #0#39 = #0#37;  || el campo visualiz. es el importe en divisa
  ||PINTA #0#9;
|FINSI;
|SI ac_divisa = "S"; |Y #agifa321#3= "S";
  ||PINTA #0#39;   || Si las divisas y la visualizacion estan activadas, pinto
|FINSI;
|FPRC;

|PROCESO visual_totales2;
     |ABRE #agifa321;
     |LEE 001#agifa321.p;
     |SI #1#70 = "D";
          |SI ac_divisa = "S"; |Y #agifa321#3= "S";
               ||PINTA 1149,#1#79;
               ||PINTA 1168,"        ";
               ||PINTA 1168,#1#80;
          |FINSI;
          |CIERRA #agifa321;
          ||PINTA 1349,#1#75;
          ||PINTA 1366,#1#76;
     |SINO;
          |SI ac_divisa = "S"; |Y #agifa321#3= "S";
               ||PINTA 1149,#1#75;
               ||PINTA 1168,"        ";
               ||PINTA 1168,#1#76;
          |FINSI;
          |CIERRA #agifa321;
          ||PINTA 1349,#1#15;
          ||PINTA 1366,#1#67;
     |FINSI;
|FPRC;

|PROCESO tot_ped_div;
     |SI #2#37 = "B";  || Asigna campos visual. y no visual. en el pedido segun la moneda de trabajo
       #2#45 = #2#11;
       #2#46 = #2#12;
       #2#47 = #2#13;
       #2#48 = #2#42;
       #2#50 = #2#43;
       #2#49 = #2#44;
     |SINO;
       #2#45 = #2#42;
       #2#46 = #2#43;
       #2#47 = #2#44;
       #2#48 = #2#11;
       #2#50 = #2#12;
       #2#49 = #2#13;
     |FINSI;
|FPRC;

|PROCESO AgeTrans;
     |ABRE #200;
     #200#0 = #1#88;
     |LEE 000#200=;
     |CIERRA #200;

     #1#9 = #200#1;
|FPRC;

|PROCESO comp_div; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;

     ||컴컴컴컴컴컴컴Modulo 000577
     |HAZ EsDiagram;
     |SI FSalida = 0;
          |HAZ DiagAdjPed;
          |SI FSalida ! 0;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;
     ||컴컴컴컴컴컴컴컴컴컴컴컴컴
     |HAZ DecimPedido;
     |SI #0#12 ! 0;
          |ABRE #2;
          #2#0   = #0#12;
          #2#25  = #0#31;
          |LEE 000#2=;
          |SI FSalida = 0;
               |SI #2#35 ! #1#68; |O #2#37 ! #1#70;
                    |MENAV "0000No coincide la divisa y/o la moneda de trabajo";
                    |ERROR; |ACABA;
               |FINSI;
               |SI #2#4 ! #1#3;  || (7)
                    |MENAV "0000Este Pedido es de otro Cliente...";
                    |ERROR; |ACABA;
               |FINSI;
               |SI #1#84 ! #2#57; |Y nModo = 1;
                    |AVISO;
                    aAlfa = "0000NPedido con Dir. Entrega [" + #2#57 + "]."+&13+"Continuar :";
                    |CONFI aAlfa;
                    |SI FSalida ! 0;
                         |ERROR; |ACABA;
                    |FINSI;
               |FINSI;

               |SI #1#88 = 0;
                    #1#88 = #2#60;
                    |HAZ AgeTrans;
               |FINSI;

               |SI #1#88 ! #2#60;
                    |AVISO;
                    aAlfa = "0000NAgencia del Pedido distinta a la del Albaran. Recoger la del Pedido";
                    |CONFI aAlfa;
                    |SI FSalida = 0;
                        #1#88 = #2#60;
                        |HAZ AgeTrans;
                    |FINSI;
               |FINSI;
          |SINO;
               |MENAV "0000El pedido no existe...";
               |ERROR;
          |FINSI;
          |CIERRA #2;
     |FINSI;
|FPRC;

|PROCESO DecimPedido; |TIPO 0;
     |ABRE #agifa324;
     pintado = 0;  ||Controla pintados de las lineas
     #agifa324#0 = #agifa104#35;
     |LEE 001#agifa324.=;   || Leo la divisa
     nDeci_DivP    = #agifa324#7;   || Decimales de la divisa
     nDeci_PreDivP = #agifa324#9;  || Decimales en el precio de la divisa
     |CIERRA #agifa324;

     |SI #2#37 = "B";   ||Si trabajo con la moneda base ...
          nDeci_TotVisP   = #agifa324#9;
          nDeci_TotNoVisP = #agifa324#7;
     |SINO;     ||Si trabajo con la divisa ...
          nDeci_TotVisP   = #agifa324#7;
          nDeci_TotNoVisP = #agifa324#9;
     |FINSI;
|FPRC;


|PROCESO ControlIVA; |TIPO 0;
     |SI #6#28 = "S"; |O #21#30 = "S";  || Exportacion
          #0#11 = 0;
          |PINTA #0#11;
     |FINSI;
|FPRC;


|PROCESO PideArt211;  |TIPO 7;
     |SI #0#12 ! 0; |ACABA; |FINSI;
     |C_M #0#2, 1, "S";
     ||C_M #0#3, 1, "N";

     |SI #0#2 ! "                    ";
         |ABRE #4;
         #4#0 = #0#4;
         |LEE 000#4=;
         |SI FSalida ! 0;  |DDEFECTO #4;  |FINSI;
         |CIERRA #4;
         |SI #4#176 = "S";
             |C_M #0#2, 1, "N";
             ||C_M #0#3, 1, "N";
             |ACABA;
         |FINSI;
     |FINSI;

     |ABRE #910;
     |LEE 040#910p;
     |SI FSalida ! 0;  |DDEFECTO #910;  |FINSI;
     |CIERRA #910;

     |SI #910#2 [ 2;    |ACABA;  |FINSI;

     eAlfa = #0Campo;
     |SUB_EJECUTA_NP "dsz99990";                 || Por Pantalla

     |SI eAlfa = "-1";  |PTEC 807;  |ACABA;  |FINSI;
     |SI eAlfa = "-2";              |ACABA;  |FINSI;

     eaArticulo = eAlfa;      ||  700000-4215

     #0Campo = eAlfa;
     ||PINTA #0Campo;
     |PTEC 802;
|FPRC;

|PROCESO Tipo7Uni;  |TIPO 7;
     |SI #4#176 = "N";  |ACABA;  |FINSI;

     eaTipo        = "AV";
     eaSerie       = #0#29;
     enCodigo      = #0#0;
     enLinea       = #0#1;
     efFecha       = #1#1;
     eaArticulo    = #0#2;
     enAlmacen     = #0#3;
     enUnidades    = #0#5;
     enTBruto      = #0#7;
     eaAbono       = #1#43;
     enTarifa      = #6#39;
     eaSeriePedido = #0#31;
     enCodigPedido = #0#12;
     enLineaPedido = #0#21;
     eaCliente     = #1#3;
     eaPedRese     = #3#22;
     enCamBas      = #1#69;
     eaMoneda      = #1#70;
     enCamDiv      = #1#74;
     |SUB_EJECUTA_NP "dsz00002";
     eaPedRese     = "N";
     #0#3    = enAlmacen;
     #0#5    = enUnidades;
     nPrecio = enTBruto / enUnidades;
     |SI #1#70 = "D";  || Si la moneda de trabajo es la divisa ...
          #0#36 = nPrecio;
     |SINO;
          #0#6  = nPrecio;
     |FINSI;

     |PTEC 802;
     |PTEC 802;
|FPRC;

|PROCESO Tipo11211;  |TIPO 11;
     |SI FSalida = 7;  |Y #4#176 = "S";
         |MENAV "      Imposible abortar;  Termine de introducir la linea y efectue una Baja.";
         |ERROR;
     |FINSI;
|FPRC;

|PROCESO VerAumento;
     |SI #agifa142#22 ! "P";
          |ACABA;
     |FINSI;

     |ABRE #40;
     aUs = Usuario % 0810;
     #40#0 = "A";
     #40#1 = aUs;
     |LEE 000#40=;
     |SI FSalida ! 0;
          |CIERRA #40;
          |ACABA;
     |FINSI;
     |CIERRA #40;

     |DDEFECTO #41;
     #41#0 = nRieTotal;
     #41#1 = nRieUtili;
     #41#2 = #40#2;
     #41#5 = nRieUtili;
     #41#3 = (nRieTotal % #40#2);
     #41#4 = #40#3;
     |SI #41#3 < #41#4;|Y #41#3 ! 0;
          #41#6 = nRieTotal + #41#3;
          nMasRies  = #41#3;
     |SINO;
          #41#6 = nRieTotal + #41#4;
          nMasRies  = #41#4;
     |FINSI;

     |SI #41#6 [ #41#5;
          #41#7 = "DENEGADA ";
          nMasRies = 0;
     |SINO;
          #41#7 = "PERMITIDA";
          |ABRE #43;
          |LEE 000#43u;
          |SI FSalida = 0;
               nConAu = #43#0 + 1;
          |SINO;
               nConAu = 1;
          |FINSI;
          |DDEFECTO #43;
          #43#0 = nConAu;
          #43#12 = "ALBARAN";
          #43#1 = #1#52;
          #43#2 = #1#0;
          #43#3 = #1#1;
          #43#4 = #1#3;
          #43#5 = #1#4;
          #43#6 = aUs;
          #43#7 = nRieTotal;
          #43#8 = nRieUtili;
          #43#9 = #41#2;
          #43#10= #41#3;
          #43#11= #41#4;
          |GRABA 020#43n;
          |CIERRA #43;
     |FINSI;

     nRieTotal = #41#6;
|FPRC;

|PROCESO Tipo5_211;  |TIPO 5;
     |HAZ actal;
|FPRC;

|PROCESO Dto211; |TIPO 0;
     |HAZ TotalLin71;
     ||컴컴컴컴컴컴컴컴컴
     |HAZ EsTecatel;
     |SI FSalida = 0;
          art_dt = #0#2;
          dtos_1 = #0#8;
          dtos_2 = #0#33;
          |HAZ TecaCheqFijo;
          |SI FSalida ! 0; |ERROR; |FINSI;
     |FINSI;
     ||컴컴컴컴컴컴컴컴컴
|FPRC;

|PROCESO IVA002_66; |TIPO 66;
     enTiva = #0Campo;
     efFiva = #1#1;
     |HAZ ConsuIVA;
     |SI eaDiva = "";
          |ERROR;
     |SINO;
          #0Campo = enTiva; |PINTA #0Campo;
     |FINSI;
|FPRC;

|PROCESO IVA002_0; |TIPO 0;
     enTiva = #0Campo;
     efFiva = #1#1;
     |HAZ SacaIVA;
     |SI eaDiva = "";
          |MENAV "0000No existe tipo iva para esta fecha...";
          |ERROR; |ACABA;
     |FINSI;
|FPRC;
