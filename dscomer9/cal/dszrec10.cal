  ----------------------  dsm00138 (DEPOSITOS COMPRAS CABECERAS) -------

|FICHEROS;
     dszrec10;
     dsm00138 #77;
     dsm00139 #80;

     agifa019 #19;
     agifa112;
     agifa142;
|FIN;

|VARIABLES;
     nCanon = 0;
     &nDeci_PreDiv = 0;
     &nDeci_IVAC = 0;
     &nDeci_BaseMx = 0;
     &nDeci_Div = 0;
     &nDeci_IVACDiv  = 0;

     nImporDescue1 = 0;
     nImporDescue2 = 0;
     nImporDescue3 = 0;
     nImporMoneda1 = 0;
     nImporMoneda2 = 0;
     nDescuMoneda1 = 0;
     nDescuMoneda2 = 0;

     nBasRete      = 0;
     nPPort1       = 0;
     nPPort2       = 0;
     nImpDiv       = 0;

     nError        = 0;
     nNume         = 0;
     nCanti        = 0;
     nMargen       = 0;
     nBrutoMoneda1 = 0;
     nBrutoMoneda2 = 0;

     &eaPrv        = "";
     &enTiva       = 0;
     &enIva        = 0;
     &enRec        = 0;
     &efFiva = @;
     nTotPVerde = 0;
     aDef = "";
     aAlfa = "";
     nPreTon = 0;
|FIN;

|PROCESO BseVerdeBase10;  || Modulo
     |SI #agifa142#177 ! "S";
          |ACABA;
     |FINSI;

     nBrutoMoneda1 = nBrutoMoneda1 + #dsm00139#44;
     nBrutoMoneda2 = nBrutoMoneda2 + #dsm00139#44;
     nTotPVerde = #dsm00138#78;
|FPRC;

|PROCESO Ivasdsm00138;
     efFiva = #dsm00138#1;
     |HAZ IVAPrv;

     |SI enTiva = 0;
         #dsm00138#28 = #dsm00138#28 +. nBrutoMoneda1;
         #dszrec10#00 = #dszrec10#00 +. nBrutoMoneda2;
     |FINSI;

     |SI enTiva = 1;
         #dsm00138#16 = #dsm00138#16 +. nBrutoMoneda1;
         #dsm00138#17 = #dsm00138#16 % enIva;
         |SI #dsm00138#36 = "S";
             #dsm00138#18 = #dsm00138#16 % enRec;
         |FINSI;

         #dszrec10#1  = #dszrec10#1  +. nBrutoMoneda2;
         #dszrec10#2  = #dszrec10#1 % enIva;
         |SI #dsm00138#36 = "S";
             #dszrec10#3 =#dszrec10#1 % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 2;
         #dsm00138#19 = #dsm00138#19 +. nBrutoMoneda1;
         #dsm00138#20 = #dsm00138#19 % enIva;
         |SI #dsm00138#36 = "S";
             #dsm00138#21 = #dsm00138#19 % enRec;
         |FINSI;

         #dszrec10#4  = #dszrec10#4  +. nBrutoMoneda2;
         #dszrec10#5  = #dszrec10#4 % enIva;
         |SI #dsm00138#36 = "S";
             #dszrec10#6 = #dszrec10#4 % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 3;
         #dsm00138#22 = #dsm00138#22 +. nBrutoMoneda1;
         #dsm00138#23 = #dsm00138#22 % enIva;
         |SI #dsm00138#36 = "S";
             #dsm00138#49 = #dsm00138#22 % enRec;
         |FINSI;

         #dszrec10#7  = #dszrec10#7  +. nBrutoMoneda2;
         #dszrec10#8  = #dszrec10#7 % enIva;
         |SI #dsm00138#36 = "S";
             #dszrec10#9 = #dszrec10#7 % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 4;
         #dsm00138#43 = #dsm00138#43 +. nBrutoMoneda1;
         #dsm00138#44 = #dsm00138#43 % enIva;
         |SI #dsm00138#36 = "S";
             #dsm00138#45 = #dsm00138#43 % enRec;
         |FINSI;

         #dszrec10#10 = #dszrec10#10 +. nBrutoMoneda2;
         #dszrec10#11 = #dszrec10#10 % enIva;
         |SI #dsm00138#36 = "S";
             #dszrec10#12 = #dszrec10#10 % enRec;
         |FINSI;
     |FINSI;

     |SI enTiva = 5;
         #dsm00138#46 = #dsm00138#46 +. nBrutoMoneda1;
         #dsm00138#47 = #dsm00138#46 % enIva;
         |SI #dsm00138#36 = "S";
             #dsm00138#48 = #dsm00138#46 % enRec;
         |FINSI;

         #dszrec10#13 = #dszrec10#13 +. nBrutoMoneda2;
         #dszrec10#14 = #dszrec10#13 % enIva;
         |SI #dsm00138#36 = "S";
             #dszrec10#15 = #dszrec10#13 % enRec;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO IvaRestoDsm00138;
     eaPrv         = #dsm00138#3;

     nBrutoMoneda1 = #dsm00138#11;
     nBrutoMoneda2 = #dsm00138#69;
     enTiva        = #dsm00138#12;
     |HAZ Ivasdsm00138;

     nBrutoMoneda1 = #dsm00138#13;
     nBrutoMoneda2 = #dsm00138#70;
     enTiva        = #dsm00138#14;
     |HAZ Ivasdsm00138;
|FPRC;

|PROCESO LimCabDsm00138;
     |DDEFECTO #dszrec10;

     nTotPVerde = 0;

     #dsm00138#15 = 0;
     #dsm00138#16 = 0;
     #dsm00138#17 = 0;
     #dsm00138#18 = 0;
     #dsm00138#19 = 0;
     #dsm00138#20 = 0;
     #dsm00138#21 = 0;
     #dsm00138#22 = 0;
     #dsm00138#23 = 0;
     #dsm00138#24 = 0;
     #dsm00138#25 = 0;
     #dsm00138#28 = 0;
     #dsm00138#37 = 0;
     #dsm00138#43 = 0;
     #dsm00138#44 = 0;
     #dsm00138#45 = 0;
     #dsm00138#46 = 0;
     #dsm00138#47 = 0;
     #dsm00138#48 = 0;
     #dsm00138#49 = 0;
     #dsm00138#53 = 0;
     #dsm00138#63 = 0;
     #dsm00138#64 = 0;
     #dsm00138#78 = 0;
     #dsm00138#79 = 0;
     |HAZ IvaRestoDsm00138;
|FPRC;

|PROCESO CalCabDsm00138;
     ||----------------------------  Margen
     |SI #dsm00139#9 ] 0;
          nError = 1;
     |SINO;
          nError = -1;
          #dsm00139#9   = -#dsm00139#9;
          #dsm00139#31  = -#dsm00139#31;
     |FINSI;

     nCanti = #dsm00139#9 < #dsm00138#5;
     nCanti = nCanti < #dsm00138#32;
     |SI #agifa142#115 = "S";
          nCanti = nCanti < #dsm00138#7;
     |FINSI;
     nCanti = nCanti * nError;
     |SI #agifa019#196 = 1;
         nMargen = #dsm00139#5  * #agifa019#9;
     |SINO;
         nMargen = #dsm00139#36 * #agifa019#9;
     |FINSI;
     nMargen      = nCanti - nMargen;
     #dsm00138#37 = #dsm00138#37 + nMargen;
     #dsm00139#9  = #dsm00139#9  * nError;
     #dsm00139#31 = #dsm00139#31 * nError;
     ||----------------------------

     #dsm00138#15 = #dsm00138#15 +. #dsm00139#9;
     #dsm00138#63 = #dsm00138#63 +. #dsm00139#31;
     #dsm00138#78 = #dsm00138#78 +. #dsm00139#44;

     nBrutoMoneda1 = #dsm00139#9;
     nImporDescue1 = (nBrutoMoneda1 % #dsm00138#5) ! nDeci_IVAC;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #dsm00138#32) ! nDeci_IVAC;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #dsm00138#7) ! nDeci_IVAC;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     nDescuMoneda1 = nImporDescue1 + nImporDescue2 + nImporDescue3;

     nBrutoMoneda2 = #dsm00139#31;
     nImporDescue1 = (nBrutoMoneda2 % #dsm00138#5) ! nDeci_IVAC;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #dsm00138#32) ! nDeci_IVAC;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #dsm00138#7) ! nDeci_IVAC;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     nDescuMoneda2 = nImporDescue1 + nImporDescue2 + nImporDescue3;
/*
     nBrutoMoneda1 = (#dsm00139#9 < #dsm00138#5) ! nDeci_BaseMx;
     nBrutoMoneda1 = (nBrutoMoneda1 < #dsm00138#32) ! nDeci_BaseMx;
     nBrutoMoneda1 = (nBrutoMoneda1 < #dsm00138#7) ! nDeci_BaseMx;

     nBrutoMoneda2 = (#dsm00139#31 < #dsm00138#5) ! nDeci_Div;
     nBrutoMoneda2 = (nBrutoMoneda2 < #dsm00138#32) ! nDeci_Div;
     nBrutoMoneda2 = (nBrutoMoneda2 < #dsm00138#7) ! nDeci_Div;
*/
     |HAZ BseVerdeBase10;

     eaPrv         = #dsm00138#3;
     enTiva        = #dsm00139#11;
     |HAZ Ivasdsm00138;

     |SI #dsm00139#46 = -1;
          nCanon = #dsm00139#9 + (#dsm00139#9 % enIva);
          |SI #dsm00138#36 = "S";
               nCanon = nCanon + (#dsm00139#9 % enRec);
          |FINSI;
          #dsm00138#79 = #dsm00138#79 +. nCanon;
     |FINSI;

     nNume = nBrutoMoneda1 % #dsm00139#10;
     #dsm00138#26 = #dsm00138#26 +. nNume;

     #dsm00138#25 = #dsm00138#25 +. nDescuMoneda1;
/*
     |SI #dsm00138#15 > 0;
         nError = 1;
     |SINO;
         nError = -1;
         #dsm00138#15 = -#dsm00138#15;
         #dsm00138#63 = -#dsm00138#63;
     |FINSI;

     #dsm00138#25 = #dsm00138#15 < #dsm00138#5;
     #dsm00138#25 = #dsm00138#25 < #dsm00138#32;
     #dsm00138#25 = #dsm00138#25 < #dsm00138#7;
     #dsm00138#25 = #dsm00138#25 * nError;
     #dsm00138#15 = #dsm00138#15 * nError;
     #dsm00138#25 = #dsm00138#15 - #dsm00138#25;
*/
     #dsm00138#24 = #dsm00138#17 + #dsm00138#18 + #dsm00138#20 + #dsm00138#21;
     #dsm00138#24 = #dsm00138#24 + #dsm00138#23 + #dsm00138#44 + #dsm00138#45;
     #dsm00138#24 = #dsm00138#24 + #dsm00138#47 + #dsm00138#48 + #dsm00138#49;

     #dszrec10#17 = #dszrec10#17 +. nDescuMoneda2;
/*
     #dszrec10#17 = #dsm00138#63 < #dsm00138#5;
     #dszrec10#17 = #dszrec10#17 < #dsm00138#32;
     #dszrec10#17 = #dszrec10#17 < #dsm00138#7;
     #dszrec10#17 = #dszrec10#17 * nError;
     #dsm00138#63 = #dsm00138#63 * nError;
     #dszrec10#17 = #dsm00138#63 - #dszrec10#17;
*/

     #dszrec10#16 = #dszrec10#02 + #dszrec10#03 + #dszrec10#05 + #dszrec10#06;
     #dszrec10#16 = #dszrec10#16 + #dszrec10#08 + #dszrec10#09 + #dszrec10#11;
     #dszrec10#16 = #dszrec10#16 + #dszrec10#12 + #dszrec10#14 + #dszrec10#15;

     #dsm00138#55 = (#dsm00138#15 - #dsm00138#25) + (#dsm00138#11 + #dsm00138#13 + #dsm00138#24); || - #dsm00138#53;
     #dsm00138#55 = #dsm00138#55 + nTotPVerde;  || modulo Albadist

     #dsm00138#64 = (#dsm00138#63 - #dszrec10#17) + (#dsm00138#69 + #dsm00138#70 + #dszrec10#16); || - #dszrec10#18;
     #dsm00138#64 = #dsm00138#64 + nTotPVerde;  || modulo Albadist

     |SI #dsm00138#58 = "D";
         #dsm00138#65 = #dsm00138#63;
         #dsm00138#66 = #dsm00138#64;
         #dsm00138#67 = #dsm00138#15;
         #dsm00138#68 = #dsm00138#55;
     |SINO;
         #dsm00138#65 = #dsm00138#15;
         #dsm00138#66 = #dsm00138#55;
         #dsm00138#67 = #dsm00138#63;
         #dsm00138#68 = #dsm00138#64;
     |FINSI;

     |DDEFECTO #agifa112;
     |ABRE #agifa112;
     #agifa112#0 = eaPrv;
     |LEE 000#agifa112.=;
     |CIERRA #agifa112;
/* lo mio
     |SI enTiva ! 0; |O #agifa112#93 = "S";
         |SI #agifa112#86 = "B";
               #dszrec10#19 = #dszrec10#19 +. #dsm00139#9;
               #dszrec10#20 = #dszrec10#20 +. #dsm00139#31;
         |SINO;
               nImp = #dsm00139#9 - (#dsm00139#9 - (((#dsm00139#9 < #dsm00138#5) < #dsm00138#32) < #dsm00138#7));
               #dszrec10#19 = #dszrec10#19 +. nImp;

               nImp = #dsm00139#31 - (#dsm00139#31 - (((#dsm00139#31 < #dsm00138#5) < #dsm00138#32) < #dsm00138#7));
               #dszrec10#20 = #dszrec10#20 +. nImp;
         |FINSI;
     |FINSI;
*/
     nBasRete = 0;
     |SI #agifa112#93 = "S";
          nBasRete = #dsm00138#28;
     |FINSI;
     nBasRete =nBasRete+#dsm00138#16+#dsm00138#19+#dsm00138#22+#dsm00138#43+#dsm00138#46;
     |SI #agifa112#86 = "N"
          nBasRete=nBasRete+#dsm00138#17+#dsm00138#20+#dsm00138#23+#dsm00138#44+#dsm00138#47;
          nBasRete=nBasRete+#dsm00138#18+#dsm00138#21+#dsm00138#49+#dsm00138#45+#dsm00138#48;
     |FINSI;
     #dszrec10#19 = nBasRete;
     #dszrec10#20 = nBasRete / #dsm00138#57 * #dsm00138#62;
/*
||lo de antes
     |SI #dsm00138#24 ! 0;
         |SI #agifa112#86 = "B";
               #dszrec10#19 = #dsm00138#15;
               #dszrec10#20 = #dsm00138#63;
         |SINO;
               #dszrec10#19 = #dsm00138#55;
               #dszrec10#20 = #dsm00138#64;
         |FINSI;
     |FINSI;
||hasta aqui
*/
     #dsm00138#53 = #dszrec10#19 % #dsm00138#52;
     #dszrec10#18 = #dszrec10#20 % #dsm00138#52;
|FPRC;

|| ----------------------  FIN AGIFA077 ---------------------------------

|PROCESO TotalLin139;
     |ABRE #19;
     #19#0 = #80#2;
     |LEE 020#19=;
     |CIERRA #19;

     nPreTon = 1;
     |HAZ EsVigor;
     |SI FSalida = 0;
          aAlfa = #19#110; |QBF aAlfa;   || Alfanumerico1
          aAlfa = aAlfa > "";
          |SI aAlfa = "S"; nPreTon = 1000; |FINSI;
     |FINSI;

     #80#44 = #80#5 * #19#208; ||Punto Verde

     |HAZ EsAlbadis; ||Para este modulo se factura con las unidades 2
     |SI FSalida = 0; #agifa019#196 = 2; |FINSI;

     |SI #77#58 = "D";
          #80#6    = #80#30 / #77#57 * #77#62;
          #80#32   = #80#6;
          nPPort1 = (#80#42 / #77#57 * #77#62); || sin redondeos tiquet:323/646
          nPPort2 = #80#42;
     |SINO;
          #80#30   = #80#6 / #77#62 * #77#57;
          #80#32   = #80#30;
          nPPort1 = #80#42;
          nPPort2 = (#80#42 / #77#62 * #77#57); || sin redondeo tiquet:323/646
     |FINSI;

     |SI #19#196 = 2;
          #80#7    = #80#36 * #80#6 / nPreTon;
          nImpDiv = (#80#36 * #80#30 / nPreTon) ! nDeci_IVACDiv;
     |SINO;
          #80#7    = #80#5  * #80#6 / nPreTon;
          nImpDiv = (#80#5  * #80#30 / nPreTon) ! nDeci_IVACDiv;
     |FINSI;

     #80#9  = ((#80#7 < #80#8) < #80#26) < #80#45;
     #80#31 = ((nImpDiv < #80#8) < #80#26) < #80#45;

     |SI #19#196 = 2;
          #80#9  = #80#9  + (#80#36 * nPPort1);  || Portes Linea
          #80#31 = #80#31 + (#80#36 * nPPort2);  || Portes Linea
     |SINO;
          #80#9  = #80#9  + (#80#5  * nPPort1);  || Portes Linea
          #80#31 = #80#31 + (#80#5  * nPPort2);  || Portes Linea
     |FINSI;

     |SI #77#58 = "D";     || Si mon. de trabajo es divisa ...
          #80#33 = #80#9;   || Importe visual, en mon. base
     |SINO;               || Si mon. de trabajo es mon. base ...
          #80#33 = #80#31;  || Importe visual, en divisa
     |FINSI;
|FPRC;
