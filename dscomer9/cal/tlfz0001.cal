|FICHEROS;
     tlfw0010;
     agifa501;
     agifa512;
     tlfm0022 #22;
     agifa513 #513;
     agifa509 #509;
     agifa516 #516;
     :/dscarter/def/dscam003 #30;
     :/dscarter/def/dscam004 #40;
     :/dscarter/def/dscam045 #45;
|FIN;

|VARIABLES;
     &enCobroTar = 0;
     &eaFichero = "";
     &efDFech = @;
     &efHFech = @;
     &enDCaja = 0;
     &enHCaja = 0;
     &enCobro = 0;
     aBase = "";
     nEmpCarte = 0;
     aEmp = "";
     nEmpresa = 0;
     &impr_tpv = "";
     &eTienda = 0;
     &eCaja = 0;
     &eFecha = "";
     &Tempo = "";
     informe = "tlfz0001";
     fFecha = @;
     aAlfa = "";
|FIN;

|PROCESO Imprime;
   |PRINT;
|FPRC;

|DEFBUCLE Imprime;
#tlfw0010#1;
;
INICIO;
FINAL;
;
NULL,Imprime;
|FIN;

|PROCESO Tiquets;
   |DDEFECTO #tlfw0010;
   #tlfw0010#0 = "T";
   #tlfw0010#1 = #agifa501#35;
   #tlfw0010#2 = #agifa501#57;
   #tlfw0010#3 = #agifa501#58;
   #tlfw0010#4 = #agifa501#38;
   |GRABA 020#tlfw0010.n;
|FPRC;

|DEFBUCLE Tiquets;
#agifa501#1;
12,14;
"  ", 000001,eCaja,fFecha;
"zz", 999999,eCaja,fFecha;
;
NULL,Tiquets;
|FIN;

|PROCESO Cobros;
   |DDEFECTO #tlfw0010;
   #tlfw0010#0 = "c";
   #tlfw0010#1 = " ";
   #tlfw0010#2 = #agifa513#14;
   #tlfw0010#3 = #agifa513#0;
   #tlfw0010#4 = #agifa513#4;
   #tlfw0010#5 = #agifa513#3;
   |GRABA 020#tlfw0010.n;
|FPRC;

|DEFBUCLE Cobros;
#agifa513#1;
12,5,11;
"  ", 000001,"E",eCaja,fFecha;
"zz", 999999,"E",eCaja,fFecha;
;
NULL,Cobros;
|FIN;

|PROCESO Pagos;
   |DDEFECTO #tlfw0010;
   #tlfw0010#0 = "p";
   #tlfw0010#1 = " ";
   #tlfw0010#2 = #agifa512#12;
   #tlfw0010#3 = #agifa512#0;
   #tlfw0010#4 = #agifa512#4;
   #tlfw0010#5 = #agifa512#3;
   |GRABA 020#tlfw0010.n;
|FPRC;

|DEFBUCLE Pagos;
#agifa512#1;
5,11;
"  ", 000001,eCaja,fFecha;
"zz", 999999,eCaja,fFecha;
;
NULL,Pagos;
|FIN;

|PROCESO Parciales;
     |SI PARAMETRO = "RECALCOBRO";
          enCobro = enCobro + #40#26 + #40#29;
     |SINO;
          |DDEFECTO #tlfw0010;
          #tlfw0010#0 = "c";
          #tlfw0010#1 = " ";
          #tlfw0010#2 = #40#0;
          #tlfw0010#3 = #40#1;
          #tlfw0010#4 = #40#26 + #40#29;
          #tlfw0010#5 = "COBRO " + #40#3 + " DEL RECIBO " + #40#2;
          #tlfw0010#6 = #40#2;
          #tlfw0010#7 = #40#3;
          |GRABA 020#tlfw0010.n;
     |FINSI;
|FPRC;

|DEFBUCLE Parciales;
     #40#7;
     36;
     fFecha, 000000000, eCaja;
     fFecha, 999999999, eCaja;
     ;
     NULL, Parciales;
|FIN;

|PROCESO Parciales2;
     |DDEFECTO #30;
     #30#40 = #40#17;
     |LEE 000#30=;

     |DDEFECTO #tlfw0010;
     #tlfw0010#0 = "c";
     #tlfw0010#1 = " ";
     #tlfw0010#2 = #40#0;
     #tlfw0010#3 = #40#1;
     #tlfw0010#4 = #40#26 + #40#29;
     #tlfw0010#5 = "COBRO " + #40#3 + " DEL RECIBO " + #40#2;
     #tlfw0010#6 = #40#2;
     #tlfw0010#7 = #40#3;
     #tlfw0010#8 = #30#32;
     #tlfw0010#9 = #40#6;
     #tlfw0010#10 = #40#36;
     |GRABA 020#tlfw0010.n;
|FPRC;

|DEFBUCLE Parciales2;
     #40#7;
     36;
     efDFech, 000000000, enDCaja;
     efHFech, 999999999, enHCaja;
     ;
     NULL, Parciales2;
|FIN;

|PROCESO dscam045;
     |SI nEmpCarte ! #45#6;
          nEmpCarte = #45#6;

          aEmp = ("00000" + #45#6) % -105;
          aAlfa = aBase + "dscarter/fich/" + aEmp + "/";
          |PATH_DAT #40#aAlfa#;
          |SI PARAMETRO = "IMPRECOBRO";
               |PATH_DAT #30#aAlfa#;
               |ABRE #30;
               |BUCLE Parciales2;
               |CIERRA #30;
          |SINO;
               |BUCLE Parciales;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dscam045;
     #45#1;
     ;
     nEmpresa, 001;
     nEmpresa, 999;
     ;
     NULL, NULL, NULL, NULL, NULL, dscam045;
     #45#6;
|FIN;

|PROCESO RellTempo;
     |BUCLE Tiquets;
     |BUCLE Cobros;
     |BUCLE Pagos;

     |DFICE aAlfa;
     aAlfa = aAlfa % -205;
     nEmpresa = aAlfa;
     nEmpCarte = 0;

     |BUCLE dscam045;
|FPRC;

|PROCESO RecalCobro;
     nEmpresa = eTienda;
     nEmpCarte = 0;

     |BUCLE dscam045;
|FPRC;

|PROCESO CobroCaja;
     |SI #22#22 = "T";
          #516#0 = #22#23;
          #516#1 = #22#21;
          |LEE 101#516=;
          |SI FSalida ! 0; |GRABA 020#516b; |FINSI;
          #516#2 = #516#2 + #22#8;
          |GRABA 020#516a;
          |LIBERA #516;
          enCobro = enCobro -  #22#8;
          enCobroTar = enCobroTar  + #22#8;
     |FINSI;
|FPRC;

|DEFBUCLE CobroCaja;
     #22#2;
     ;
     eCaja, fFecha;
     eCaja, fFecha;
     ;
     NULL, CobroCaja;
|FIN;

|PROGRAMA;
     |DBASS aBase;
     aAlfa = aBase + "dscarter/fich/";
     |PATH_DAT #45 aAlfa;

     fFecha = eFecha;

     |DFICE aAlfa;
     aAlfa = aAlfa % -205;


     |SI PARAMETRO = "IMPRECOBRO";
          eTienda = aAlfa;
          |NOME_DAT #tlfw0010#eaFichero#;
          |DELINDEX #tlfw0010;
          |ABRE #tlfw0010;
          |HAZ RecalCobro;
          |CIERRA #tlfw0010;
          |ACABA;
     |FINSI;

     |SI PARAMETRO = "RECALCOBRO";
          |HAZ RecalCobro;
          |ABRE #516;
          |BUCLE CobroCaja;
          |CIERRA #516;
          |ACABA;
     |FINSI;

     |DDEFECTO #509;
     |ABRE #509;
     #509#63 = aAlfa;
     #509#0 = eCaja;
     #509#1 = fFecha;
     |LEE 000#509=;
     |CIERRA #509;

     |QBF impr_tpv;
     |SI impr_tpv = "";
          |MENAV "0000No hay impresora...";
     |SINO;
          Impresora = impr_tpv;
          |IMPRE 0;
          |SI FSalida = 0;;
               |INFOR informe;
               |SI FSalida = 0;
                    |HAZ CreaTempo;
                    |NOME_DAT #tlfw0010#Tempo#;
                    |DELINDEX #tlfw0010;

                    |ABRE #tlfw0010;
                    |HAZ RellTempo;
                    |BUCLE Imprime;
                    |PIEINF;
                    |FININF;
                    |CIERRA #tlfw0010;

                    |HAZ BoraTempo;
                    |DELINDEX #tlfw0010;
               |FINSI;
               |FINIMP;
          |FINSI;
     |FINSI;
|FPRO;
