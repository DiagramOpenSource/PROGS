  RIESGOS MALPESA RiesgosMalpe SacaRiesgoMalpe

|FICHEROS;
     malpe090 #0; ||Albaranes
     malpe087 #8; ||Pedido
     dscamrie@ #100;
     dscam038@ #101;
     dscam023@ #102;
     dscam051@;
|FIN;

|VARIABLES;
     nCalc = 0;
     &eaSerie = "";
     &eaExisteCliRie = "";
     &eaRieSuma = "";
     &eaCodCliente = "";
     &eaNomCliente = "";

     &aRPath   = "";
     &aRNome   = "";

     &eaTag    = "";
     &aDef111  = "";
     &aDef222  = "";
     &aDef333  = "";
     &nRieTotal = 0;
     &nRieUtili = 0;
     &aRieBloqu = "";
     &aBloquead = "";
     &nImpo    = 0;

     aDef = "";
     aAlfa = "";
     aTecla    = "";
     aFin      = "";
     aCentro   = "";
     nHandle1  = 0;
     nHandle2  = 0;
     aDat1     = "";
     aDat2     = "";
     nPrime    = 0;

     aAlfa1    = "";
     aParam    = "";
     aDef1     = "";
     aDef2     = "";
     aDef3     = "";
     aDef4     = "";
     aPath     = "";
     dPath     = "";
     aMensa    = "";
     nCartera  = 0;
     swCar     = 0;
     nCart     = 0;

     aSer      = "";
     aCli      = "";
     aNomCli   = "";
     nTotal    = 0;
     nRiesgo   = 0;
     sumalin  = 0;
     aTipodo  = "";
     bAlfa     = "";
|FIN;

|RUTINA AbreRiesgoMalpe;
     nCartera = 0;

     |DBASS aPath;
     aMensa = ""; aDef111 = "";

     aDef111 = aPath + "dscarter/def/" + "dscamrie";
     |CARGA_DEF aDef111, dscamrie@;
     |SI FSalida ! 0;
          nCartera = -1;
          |ACABA;
     |FINSI;

     aDef222 = aPath + "dscarter/def/" + "dscam038";
     |CARGA_DEF aDef222, dscam038@;
     |SI FSalida ! 0;
          nCartera = -1;
          |ACABA;
     |FINSI;

     aDef333 = aPath + "dscarter/def/" + "dscam023";
     |CARGA_DEF aDef333, dscam023@;
     |SI FSalida ! 0;
          nCartera = -1;
          |ACABA;
     |FINSI;

     aAlfa = aPath + "dscarter/fich/";

     |PATH_DAT #101 aAlfa;

     |DBASE aPath;

     aRPath = aPath +"fich/";
     |PATH_DAT #100 aRPath;

     aRNome = Usuario;
     |NOME_DAT #100 aRNome;

|FRUT;

|PROCESO dscarm038Malpe;
     |SI #101#3 > aSer; |O #101#4 < aSer; |ACABA; |FINSI;

     |SI swCar = 0;
          swCar = 1;
          nCart = #101#5;
     |FINSI;

     ||SI nCart ! #101#5;
          |DDEFECTO #100;
          sumalin = sumalin + 1;
          #100#0 = aAlfa;
          #100#1 = sumalin;
          #100#2 = nCart;
          #100#3 = aTipodo;
          #100#4 = aSer
          #100#5 = nRiesgo;
          #100#6 = aCli;
          #100#9 = aNomCli;
          |GRABA 020#100n;
          nCart = #101#5;
     ||FINSI;
|FPRC;

|DEFBUCLE dscarm038Malpe;
     #101#2004;
     ;
     00001,aAlfa,aTipodo,001;
     99999,aAlfa,aTipodo,999;
     ;
     NULL,dscarm038Malpe;
|FIN;

|RUTINA AcumulaRiesgoMalpe;
     |SI nRiesgo = 0; |ACABA; |FINSI;

     |DFICE aAlfa; |QBF aAlfa; aAlfa = aAlfa % -106; aAlfa = aAlfa % 0105;

     |ABRE #100;
     nCart = 0;
     swCar = 0;
     |BUCLE dscarm038Malpe;
/*
     |SI swCar ! 0;
         |DDEFECTO #100;
         sumalin = sumalin + 1;
         #100#0 = aAlfa;
         #100#1 = sumalin;
         #100#2 = nCart;
         #100#3 = aTipodo;
         #100#4 = aSer
         #100#5 = nRiesgo;
         #100#6 = aCli;
         #100#9 = aNomCli;
         |GRABA 020#100n;
     |FINSI;
*/
     |CIERRA #100;
|FRUT;

|RUTINA CierraRiesgoMalpe;

     |SI aDef333 ! ""; |DESCARGA_DEF #dscam023@; |FINSI;
     |SI aDef222 ! ""; |DESCARGA_DEF #dscam038@; |FINSI;
     |SI aDef111 ! ""; |DESCARGA_DEF #dscamrie@; |FINSI;
|FRUT;

|RUTINA EjecutaRiesgoMalpe;
     dPath = ":" + "dscarter/dsriesgo.tab;" + aAlfa;
     |SUB_EJECUTA_NP dPath;
|FRUT;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO RiesgosMalpe;

     nRiesgo = 0;
     aTipodo = "";
     sumalin = 0;
     nCart   = 0;
     swCar   = 0;
     |SI eaTag = "PE";
          aSer = #8#25;
          aCli = #8#4;
          aNomCli = #8#8;
          |SI nImpo = 0;
             nRiesgo = 0 +. #8#12;
          |SINO;
             nRiesgo = 0 +. nImpo;
          |FINSI;
          aTipodo = "P";
          |HAZ AbreRiesgoMalpe;
          |SI nCartera ! 0;   |ACABA;   |FINSI;
          |HAZ AcumulaRiesgoMalpe;
          |HAZ CierraRiesgoMalpe;
          |HAZ EjecutaRiesgoMalpe;
     |FINSI;

     |SI eaTag = "AV";
          aSer = #0#52;
          aCli = #0#3;
          aNomCli = #0#4;
          nTotal = #0#16+#0#17+#0#18+#0#19+#0#20+#0#21+#0#22+#0#23;
          nTotal = nTotal + #0#44+#0#45+#0#46+#0#47+#0#48+#0#49+#0#28;
          nRiesgo = 0 +. nTotal;
          |SI #0#43 = "S"; nRiesgo = (nRiesgo * -1); |FINSI;  || Abono
          aTipodo = "A";
          |HAZ AbreRiesgoMalpe;
          |SI nCartera ! 0;   |ACABA;   |FINSI;
          |HAZ AcumulaRiesgoMalpe;
          |HAZ CierraRiesgoMalpe;
          |HAZ EjecutaRiesgoMalpe;
     |FINSI;
|FPRC;

|PROCESO sacadatosMalpe;
     aAlfa = aPath + "dscarter/fich/" + (("00000" + #dscam038@#5) % -105) + "/";
     |PATH_DAT #dscam051@#aAlfa#; |ABRE #dscam051@;
     |LEE 000#dscam051@.p;
     |SI FSalida ! 0; |DDEFECTO #dscam051@; |FINSI;

     |SI #101#5 ! 0;
          |SI eaTag = ""; |Y #101#2 = "A"; eaRieSuma = "S"; |FINSI;
          |SI eaTag = "PE"; |Y #101#2 = "P"; eaRieSuma = "S"; |FINSI;
          |SI eaTag = "AV"; |Y #101#2 = "A"; eaRieSuma = "S"; |FINSI;
          |SI eaTag = "FD"; |Y #101#2 = "F"; eaRieSuma = "S"; |FINSI;

          bAlfa = #101#5;
          |QBF bAlfa;
          bAlfa = ( "00000" + bAlfa) % -105;
          aAlfa = aPath + "dscarter/fich/" + bAlfa + "/";
          |PATH_DAT #102 aAlfa;

          |ABRE #102;
          #102#0 = aCli;
          |LEE 000#102=;
          |SI FSalida = 0;
               eaExisteCliRie = "S";
               |SI nCart ! #101#5;
                    aAlfa = "|NC"; aAlfa = #dscam051@#aAlfa#; nCalc = aAlfa;
                    |SI nCalc ] 105;
                       |SI #dscam051@#105 = "S";
                          |SI eaSerie ] #dscam038@#3; |Y eaSerie [ #dscam038@#4;
                             nRieTotal = nRieTotal + #102#19;
                             nRieUtili = nRieUtili + #102#20;
                             nCart = #101#5;
                          |FINSI;
                       |SINO;
                          nRieTotal = nRieTotal + #102#19;
                          nRieUtili = nRieUtili + #102#20;
                          nCart = #101#5;
                       |FINSI;
                    |SINO;
                       nRieTotal = nRieTotal + #102#19;
                       nRieUtili = nRieUtili + #102#20;
                       nCart = #101#5;
                    |FINSI;
               |FINSI;
               |SI #102#9 = "S";
                    aRieBloqu = "S";
                    aBloquead = #102#10;
               |FINSI;
          |FINSI;
          |CIERRA #102;
     |FINSI;
     |CIERRA #dscam051@;
|FPRC;

|DEFBUCLE sacadatosMalpe;
     #101#2004;
     ;
     00001,#48#0," ",001;
     99999,#48#0,"z",999;
     ;
     NULL,sacadatosMalpe;
|FIN;

|PROCESO SacaRiesgoMalpe;
     |HAZ AbreRiesgoMalpe;
     |SI nCartera ! 0;   |ACABA;   |FINSI;
     nRieTotal  = 0;
     nRieUtili  = 0;
     aRieBloqu  = "";
     aBloquead  = "";
     swCar      = 0;
     nCart      = 0;
     |SI eaTag = "AV";
          aCli = #0#3;
          aNomCli = #0#4;
     |FINSI;
     |SI eaTag = "PE";
          aCli = #8#4;
          aNomCli = #8#8;
     |FINSI;
     |SI eaTag = "";
        aCli = eaCodCliente;
        aNomCli = eaNomCliente;
     |FINSI;

     |DBASS aPath;
     eaExisteCliRie = "N";


     |DBASS aAlfa; aAlfa = aAlfa + "dscarter/def/dscam051.mas"
     |CARGA_DEF aAlfa, dscam051@;
     |SI FSalida ! 0;
        |MENAV "    No encuentro el def de parametros generales de cartera";
     |SINO;
        |BUCLE sacadatosMalpe;
        |DESCARGA_DEF #dscam051@;
     |FINSI;


     |HAZ CierraRiesgoMalpe;
|FPRC;
