|FICHEROS;
     solm0014 #0;
     solm0002 #2;
     solm0015 #15
     solm0016 #16,MANTE;
     referen@ #100;

     agifa019 #19;
     dsm00020 #20;
     agifa024 #24;
     agifa025 #25;
     agifa027 #27;
     dsm00053 #53;
     agifa065 #65;
     agifa069 #69;
     agifa084 #84;
     agifa220 #220;
     agifa324 #324;
     agifa321 #321;
     agifa142 #142;
|FIN;

|VARIABLES;
     nLinDA = 0;
     nPor = 0;
     nCto = 0;
     aModifica = "";
     aAlfa = "";
     nContFactu = 0;
     nHayFac = 0;
     nPorce = 0;
     nTotaDia = 0;
     nTotaRep = 0;
     nTotaReal = 0;
     nHuerto = 0;
     nReparto = 0;
     nModo = 0;
 {-1}Menu = "";
     Menu1 = "2400";
     Menu2 = "1";
     Menu3 = "";
     Menu4 = "CEGeR";
     Menu5 = "Calcular Reparto";
     Menu6 = "Entrada Reparto";
     Menu7 = "Generar Facturas";
     Menu8 = "Cerrar";
     Menu9 = "Reabrir";
     fDFecha = @;
     fHFecha = @;
     nDias = 0;

     fmes = "";
     mes = 0;
     nImpo = 0;
     nMargen = 0;
     nForma = 0;
     &efFecha = @;
     &eaArticulo = "";
     &enImpVta = 0;
     &enImpMar = 0;
     imneto = 0;
     nDto = 0;
     &enImpCliCom = 0;
     &enImpCliDto = 0;
     &enImpCliMar = 0;
     &enImpCliFac = 0;
     &eaCliente = "";
     &enImpRepComi = 0;
     &enImpRepVta = 0;
     &enImpRepRete = 0;
     &eaRepre = "";
     &eaTag = "";
     retencion = 0;
     nFactu = 0;
     aArti = "";
     nUni = 0;
     nPrecio = 0;
     &enSwMenu = 0;
     &enForma = 1;
     &eaProgVta = "";
     &enCoste = 0;
     &aMoneda = "";
     &aDivisa = "";
     nLinea = 0;
|FIN;

|PROCESO Reparto; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
          nHuerto = #0#0;
          #0#1 = 9999;
          |LEE 000#0];
          |SI FSalida = 0;
               |LEE 000#0a;
          |SINO;
               |LEE 000#0u;
          |FINSI;
          |SI FSalida = 0; |Y #0#0 = nHuerto;
               nReparto = nReparto + 1;
          |SINO;
               nReparto = 1;
          |FINSI;
          |DDEFECTO #0;
          #0#0 = nHuerto;
          #0#1 = nReparto;
     |FINSI;
|FPRC;

|PROCESO Min2;
     #2#0 = #0#0;
     #2#1 = 1;
|FPRC;

|PROCESO Max2;
     #2#0 = #0#0;
     #2#1 = 9999;
|FPRC;

|PROCESO Contrato66; |TIPO 66;
     |ABRE #2;
     #2#0 = #0#0;
     #2#1 = #16#2;
     |LEE 000#2];
     |CONSULTA_F_CLAVE #1#2, Min2, Max2;
     |SI FSalida = 0;
          #16#2 = #2#1; |PINTA #16#2;
     |SINO;
          |ERROR;
     |FINSI;
     |CIERRA #2;
|FPRC;
---------------------------------------------------------------
|PROCESO Min;
     #16#0 = #0#0;
     #16#1 = #0#1;
     #16#2 = 1;
|FPRC;

|PROCESO Max;
     #16#0 = #0#0;
     #16#1 = #0#1;
     #16#2 = 9999;
|FPRC;

|PROCESO EntradaRep;
     |PUSHV 0501 2380;
     |BLANCO 1216 2371;
     |SI #0#12 = "S";
          |ENTLINEAL #1#16, 3, 4, 22, 1, Min, Max;
     |SINO;
          |ENTLINEAL #1#16, 3, 2, 22, 1, Min, Max;
     |FINSI;
     |POPV;
     |PINTA #0#10;
     |PINTA #0#11;
|FPRC;
---------------------------------------------------------------
|PROCESO Cerrar;
     |SI #0#12 = "N";
          #0#12 = "S"; |PINTA #0#12;
          |GRABA 020#0a;
     |SINO;
          |MENAV "0000El reparto ya esta cerrado...";
     |FINSI;
|FPRC;
---------------------------------------------------------------
|PROCESO Reabrir;
     |SI #0#12 = "S";
          #0#12 = "N"; |PINTA #0#12;
          |GRABA 020#0a;
     |SINO;
          |MENAV "0000El reparto no esta cerrado...";
     |FINSI;
|FPRC;
---------------------------------------------------------------
|PROCESO Contratos;
     fDFecha = #2#2;
     fHFecha = #2#3;
     |SI fHFecha = "01.01.0000"; fHFecha = "31.12.9999"; |FINSI;

     |SI fDFecha [ #0#7; |Y fHFecha ] #0#6;
          |SI fDFecha < #0#6; fDFecha = #0#6; |FINSI;
          |SI fHFecha > #0#7; fHFecha = #0#7; |FINSI;
          nDias = fHFecha - fDFecha;
          |SI nDias [ 0; |ACABA; |FINSI; || no deberia ser nunca !!!

          |DDEFECTO #15;
          #15#0 = #0#2;
          #15#1 = #0#0;
          #15#2 = #2#1;
          |LEE 000#15=;
          |SI FSalida = 0; |Y #15#3 ! 0;
               |DDEFECTO #16;
               #16#0 = #0#0;
               #16#1 = #0#1;
               #16#2 = #2#1;
               #16#3 = #15#3;
               #16#4 = nDias;
               |GRABA 020#16n;
               nTotaRep = nTotaRep + #16#3;
               nTotaDia = nTotaDia + #16#4;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE Contratos;
     #2#1;
     ;
     #0#0, 0001;
     #0#0, 9999;
     ;
     NULL, Contratos;
|FIN;

|PROCESO Auxiliar;
/*
     nPorce = ((#16#3 * 100 / nTotaRep) + (#16#4 * 100 / nTotaDia)) / 2;
     nImpo = #0#5 * nPorce / 100;
     #16#6 = nImpo;
     #16#5 = nImpo * 100 / #0#5;
*/
     nDias = #0#7 - #0#6;
     #16#5 = #16#4 * #16#3 / nDias;
     #16#6 = #0#5 * #16#5 / 100;

     |GRABA 020#16a;
     |LIBERA #16;

     #0#10 = #0#10 + #16#6;
     #0#11 = #0#11 + #16#5;
|FPRC;

|DEFBUCLE Auxiliar;
     #16#1;
     ;
     #0#0, #0#1, 0001;
     #0#0, #0#1, 9999;
     be;
     NULL, Auxiliar;
|FIN;

|PROCESO Calcula;
     |SI #0#12 = "S";
          |MENAV "0000El reparto esta cerrado...";
          |ACABA;
     |FINSI;

     |ABRE #16;
     #16#0 = #0#0;
     #16#1 = #0#1;
     #16#2 = 1;
     |LEE 000#16];
     |SI FSalida = 0; |Y #16#0 = #0#0; |Y #16#1 = #0#1;
          |MENAV "0000El reparto ya esta generado...";
     |SINO;
          nTotaDia = 0;
          nTotaRep = 0;
          |ABRE #15;
          |BUCLE Contratos;
          |CIERRA #15;
          #0#10 = 0;
          #0#11 = 0;
          |BUCLE Auxiliar;
          |GRABA 020#0a;
          |PINTA #0#10;
          |PINTA #0#11;
     |FINSI;
     |CIERRA #16;
|FPRC;
---------------------------------------------------------------
|PROCESO CheqAux;
     |SI #16#8 ! 0;
          nHayFac = 1;
     |FINSI;
|FPRC;

|DEFBUCLE CheqAux;
     #16#1;
     ;
     #0#0, #0#1, 0001;
     #0#0, #0#1, 9999;
     be;
     NULL, CheqAux;
|FIN;

|PROCESO BorraAux;
     |BORRA 020#16a;
     |LIBERA #16;
|FPRC;

|DEFBUCLE BorraAux;
     #16#1;
     ;
     #0#0, #0#1, 0001;
     #0#0, #0#1, 9999;
     be;
     NULL, BorraAux;
|FIN;

|PROCESO Tipo2_14; |TIPO 2;
     nModo = (FEntrada / 100) ! 0;
     nForma = 0 +. 1;
     |SI nModo = 2; |O nModo = 3;
          nHayFac = 0;
          |BUCLE CheqAux;
          |SI nHayFac ! 0;
               |SI nForma = -1;
                    |MENAV "0000Facturas realizadas...";
               |FINSI;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;
     |SI nModo = 3;
          |BUCLE BorraAux;
     |FINSI;
|FPRC;

|PROCESO Tipo2_16; |TIPO 2;
     nModo = (FEntrada / 100) ! 0;
     nForma = 0 +. 1;
     |SI nModo = 2; |O nModo = 3;
          |SI #16#8 ! 0;
               |SI nForma = -1;
                    |MENAV "0000Factura realizada. Borre la factura para modificar...";
               |FINSI;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     #0#10 = #0#10 +. #16#6;
     #0#11 = #0#11 +. #16#5;
     |GRABA 020#0a;

     |SI aModifica = "S";
          aModifica = "N";
          |PONCONTROL 23, "SI";
          |PTEC 808;
          |PTEC 809;
     |FINSI;
|FPRC;

|PROCESO Opcion; |TIPO 20;
     |SI FSalida = "OPCION";
          FSalida = "Opciones";
     |SINO;
          |LEE 101#0=;
          |SI FSalida ! 0; |ACABA; |FINSI;
          |PARA; |SI; |HACIENDO;
               |MENU Menu;
               |SI FSalida [ 0; |SAL; |FINSI;
               Menu2 = FSalida;
               |SI FSalida = 1; |HAZ Calcula; |FINSI;
               |SI FSalida = 2; |HAZ EntradaRep; |FINSI;
               |SI FSalida = 3; |HAZ Generar; |FINSI;
               |SI FSalida = 4; |HAZ Cerrar; |FINSI;
               |SI FSalida = 5; |HAZ Reabrir; |FINSI;
          |SIGUE;
          Menu2 = "1";
          |LIBERA #0;
     |FINSI;
|FPRC;
-------------------------------------------------------------------------
|PROCESO DesAmpli;
     nLinDA = nLinDA + 1;
     |DDEFECTO #53;
     #53#0 = "F";
     #53#1 = #69#20;
     #53#2 = #69#0;
     #53#3 = #69#1;
     #53#4 = nLinDA;
     #53#5 = #220#2;
     |GRABA 020#53n;
|FPRC;

|DEFBUCLE DesAmpli;
     #220#1;
     ;
     #69#2, 001;
     #69#2, 999;
     ;
     NULL, DesAmpli;
|FIN;

|PROCESO LinFactu;
     |ABRE #69;
     |ABRE #19;

     |DDEFECTO #19;
     #19#0 = #0#2;
     |LEE 000#19=;

     nPrecio = #16#6;

     nLinea = nLinea + 1;
     |DDEFECTO #69;
     #69#20 = #84#48;
     #69#0 = #84#0;
     #69#1 = nLinea;
     #69#2 = #19#0;
     #69#3 = 1;
     #69#4 = #19#1;
     #69#5 = 1;
     #69#6 = nPrecio;
     #69#26 = #69#6;
     #69#28 = #69#6;
     #69#11 = #19#30;
     #69#13 = #19#2;
     #69#15 = #84#3;
     #69#16 = #84#34;
     #69#17 = #84#35;
     |GRABA 020#69n;

     |CIERRA #19;
     |CIERRA #69;

     nLinDA = 0;
     |ABRE #53;
     |BUCLE DesAmpli;
     |CIERRA #53;
|FPRC;

|PROCESO CabFactu;
     |ABRE #24;
     |ABRE #25;
     |ABRE #324;
     |ABRE #20;

     |DDEFECTO #24;
     #24#0 = #2#4;
     |LEE 000#24=;

     |DDEFECTO #25;
     #25#0 = #24#25;
     |LEE 000#25=;

     nLinea = 0;

     |DDEFECTO #84;
     #84#48 = #0#9;
     enSwMenu = 1; |HAZ ContaFD7;
     #84#1 = #0#8;
     #84#3 = #24#0;
     #84#4 = #24#1;
     #84#5 = #24#37;
     #84#6 = #25#0;
     #84#26 = #25#0;
     #84#7 = #24#38;
     #84#8 = #24#20;
     #84#29 = #24#1;
     #84#30 = #24#8;
     #84#31 = #24#9;
     #84#32 = #24#156;
     #84#33 = #24#10;
     #84#34 = #25#7;
     #84#35 = #24#4;
     #84#36 = #24#47;
     #84#40 = #24#16;
     #84#60 = #24#15;
     #84#64 = #24#183;
     #84#65 = #24#192;

     #84#95 = "REPARTO PERDIDAS";

     #324#0 = #84#65;
     |LEE 000#324=;
     #84#66 = #324#2;

     #84#67 = #24#193;
     #84#68 = #321#9;

     #324#0 = #84#68;
     |LEE 000#324=;
     #84#69 = #324#2;

     #84#78 = #24#202;
     #84#88 = #24#23;
     #84#89 = #24#24;
     #84#90 = #24#25
     #84#91 = 1;         || Dir. Entrega

     #20#0 = #84#78;
     |LEE 000#20=;
     |SI FSalida = 0;
          #84#9 = #20#1;
     |FINSI;

     |GRABA 020#84b;
     nLinea = 0;

     |CIERRA #24;
     |CIERRA #25;
     |CIERRA #324;
     |CIERRA #20;
|FPRC;

|PROCESO ActArti;
     fmes = #84#1 % A402;
     mes = fmes - 1;
     mes = mes * 5;
     mes = mes + 35;
     #19#0 = #69#2;
     |LEE 101#19=;
     |SI FSalida = 0;
          |SI #19#194 = 2;
               nImpo = ((((#69#30 * #69#6) < #69#8) < #69#21) < #84#5) < #84#32;
          |SINO;
               nImpo = ((((#69#5 * #69#6) < #69#8) < #69#21) < #84#5) < #84#32;
          |FINSI;
          |SI #142#115 = "S";
               nImpo = nImpo < #84#7;
          |FINSI;
          nMargen = nImpo - #69#14;
          #19mes = #19mes + (nImpo * nForma);
          #19#95 = #19#95 + (nImpo * nForma);
          mes = mes + 1;
          #19mes = #19mes + (nMargen * nForma);
          #19#96 = #19#96 + (nMargen * nForma);
          |GRABA 020#19a;
     |FINSI;
     |LIBERA #19;

     efFecha = #84#1;
     eaArticulo = #69#2;
     enImpVta = (nImpo * nForma);
     enImpMar = (nMargen * nForma);
     |HAZ AcumulaArt;
|FPRC;

|PROCESO Actualiza;
     nForma = 1;

     |ABRE #24;
     #24#0 = #84#3;
     |LEE 121#24=;
     |SI 0 = FSalida;
          fmes = #84#1 % A402;
          mes = fmes - 1;
          mes = mes * 4;
          mes = mes + 54;
          imneto = #84#15 - #84#25;
          |SI #142#115 = "N";
               nImpo = (imneto * 100) / (100 - #84#7);
               nDto = #84#25 + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
               nDto = #84#25;
          |FINSI;
          #24mes = #24mes +. nImpo; || imneto;
          mes = mes + 1;
          #24mes = #24mes +. nDto;
          mes = mes + 1;
          #24mes = #24mes +. #84#37;
          #24#102 = #24#102 +. nImpo; || imneto;
          #24#103 = #24#103 +. nDto;
          #24#104 = #24#104 +. #84#37;
          mes = FEntrada / 100;
          mes = mes ! 0;
          |SI 1 = mes;
               #24#45 = #84#1;
               #24#46 = imneto;
          |FINSI;
          #24#110 = #24#110 +. imneto;
          imneto = imneto + #84#24;
          |GRABA 020#24a;
          |LIBERA #24;

          enImpCliCom = nImpo * nForma;
          enImpCliDto = nDto * nForma;
          enImpCliMar = #84#37 * nForma;
          enImpCliFac = imneto * nForma;
          eaCliente = #84#3;
          efFecha = #84#1;
          |HAZ AcumulaCli;
     |FINSI;
     |CIERRA #24;

     |ABRE #25;
     #25#0 = #84#6;
     |LEE 121#25=;
     |SI 0 = FSalida;
           imneto = #84#15 - #84#25;
           fmes = #84#1 % A402;
           mes = fmes - 1;
           mes = mes * 2;
           mes = mes + 11;
           #25mes = #25mes +. #84#26;
           retencion = #25mes % #25#39;
           mes = mes + 1;
           #25mes = #25mes +. imneto;
           #25#35 = #25#35 +. #84#26;
           #25#36 = #25#36 +. imneto;
           mes = fmes - 1;
           mes = mes + 40;
           #25mes = retencion;
           retencion = #25#35 % #25#39;
           #25#52 = retencion;
           |GRABA 020#25a;
           |LIBERA #25;

          enImpRepComi = #84#26 * nForma;
          enImpRepVta = imneto * nForma;
          enImpRepRete = retencion * nForma;
          eaRepre = #84#6;
          efFecha = #84#1;
          |HAZ AcumulaRep;
     |FINSI;
     |CIERRA #25;

     |ABRE #19;
     |BUCLELIN 2 ActArti #84;
     |CIERRA #19;
/*
     |SI #142#47 = "S";  ||컴컴컴컴컴 Acumula en riesgos Si Crea Recibo
          eaTag = "FC";  |HAZ Riesgos;
     |FINSI;
*/
|FPRC;

|PROCESO CalcuLin;
     |HAZ TotalLin69;

     |HAZ CalCabAgifa084;

     enForma = 1;
     eaProgVta = "agifa084";
     |HAZ AcumulaFC;
     #69#14 = enCoste;

     |GRABA 020#69a;
     |LIBERA #69;
|FPRC;

|PROCESO GenFactu;
     |SI #16#8 = 0;
          |DDEFECTO #2;
          #2#0 = #0#0;
          #2#1 = #16#2;
          |LEE 020#2=;

          |ABRE #84;
          |HAZ CabFactu;
          |HAZ LinFactu;

          aDivisa = #84#65;
          aMoneda = #84#67;
          |HAZ Divisas084;

          |HAZ LimCabAgifa084;
          |BUCLELIN 0 CalcuLin #84;
          |GRABA 020#84a;
          |HAZ Actualiza;
          |CIERRA #84;
          nContFactu = nContFactu + 1;

          #16#7 = #84#48;
          #16#8 = #84#0;
          |GRABA 020#16a;
     |FINSI;
     |LIBERA #16;
|FPRC;

|DEFBUCLE GenFactu;
     #16#1;
     ;
     #0#0, #0#1, 0001;
     #0#0, #0#1, 9999;
     be;
     NULL, GenFactu;
|FIN;

|PROCESO Generar;
     |SI #0#12 = "S";
          |MENAV "0000El reparto esta cerrado...";
          |ACABA;
     |FINSI;

     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     nContFactu = 0;
     |ABRE #2;
     |BUCLE GenFactu;
     |CIERRA #2;
     |SI nContFactu > 0;
          aAlfa = "0000Generadas " + nContFactu + " facturas...";
          |MENAV aAlfa;
     |FINSI;
|FPRC;
------------------------------------------------------------------------
|PROCESO Recalcula;
     |SI nCto ! #referen@#2;
          |LEE 121#referen@.=;
          |SI Campo = 3; |O Campo = 4;
               nPorce = ((#referen@#3 * 100 / nTotaRep) + (#referen@#4 * 100 / nTotaDia)) / 2;
               nImpo = #0#5 * nPorce / 100;
               #referen@#6 = nImpo;

               nPor = nImpo * 100 / #0#5;
               #referen@#5 = nPor;

               ||#referen@#5 = nImpo * 100 / #0#5; || ESTO FALLA
          |FINSI;
          |GRABA 020#referen@.a;
          |LIBERA #referen@;
     |FINSI;
|FPRC;

|DEFBUCLE Recalcula;
     #referen@#1003;
     ;
     #0#0, #0#1, 0001;
     #0#0, #0#1, 9999;
     ;
     NULL, Recalcula;
|FIN;

|PROCESO SumTota;
     |SI nCto ! #referen@#2;
          nTotaRep = nTotaRep + #referen@#3;
          nTotaDia = nTotaDia + #referen@#4;
          nTotaReal = nTotaReal + #referen@#5;
     |FINSI;
|FPRC;

|DEFBUCLE SumTota;
     #referen@#1003;
     ;
     #0#0, #0#1, 0001;
     #0#0, #0#1, 9999;
     ;
     NULL, SumTota;
|FIN;

|PROCESO SumCabe;
     |SI nCto ! #referen@#2;
          #0#10 = #0#10 + #referen@#6;
          #0#11 = #0#11 + #referen@#5;
     |FINSI;
|FPRC;

|DEFBUCLE SumCabe;
     #referen@#1003;
     ;
     #0#0, #0#1, 0001;
     #0#0, #0#1, 9999;
     ;
     NULL, SumCabe;
|FIN;

|PROCESO ModiCampo; |TIPO 0;
     |SI #16Campo = Contenido; |ACABA; |FINSI;

     |DDEF aAlfa;
     aAlfa = aAlfa + "solm0016";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          nCto = #16#2;
          |SI Campo = 3; |O Campo = 4;
/*
               nTotaRep = #16#3;
               nTotaDia = #16#4;
               nTotaReal = #16#5;
               |BUCLE SumTota;
               |BUCLE Recalcula;
               aModifica = "S";

               nPorce = ((#16#3 * 100 / nTotaRep) + (#16#4 * 100 / nTotaDia)) / 2;
               nImpo = #0#5 * nPorce / 100;
               #16#6 = nImpo;
               #16#5 = nImpo * 100 / #0#5;
*/
               nDias = #0#7 - #0#6;
               #16#5 = #16#4 * #16#3 / nDias;
               #16#6 = #0#5 * #16#5 / 100;
          |SINO;
               |SI Campo = 5;
                    nImpo = #0#5 * #16#5 / 100;
                    #16#6 = nImpo;
               |FINSI;
               |SI Campo = 6;
                    nPor = #16#6 * 100 / #0#5;
                    #16#5 = nPor;
               |FINSI;
          |FINSI;
          |PINTA #16#5;
          |PINTA #16#6;

          #0#10 = 0;
          #0#11 = 0;
          |BUCLE SumCabe;

          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;
