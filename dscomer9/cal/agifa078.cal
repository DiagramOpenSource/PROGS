                    ||******** FACTURAS ABONO COMPRAS *********
|FICHEROS;
     agifa079 #0;
     agifa072 #1;
     agifa077 #2;
     agifa080 #3;
     agifa019 #4;
     agifa112 #6;
     agifa017 #7;
     agifa091 #10;
     dsz99984 #11;
     agifa007 #40;
     agifa321 #35;  || Parametros de Divisas
     agifa323 #36;  || Clientes/Divisas
     agifa322 #37;  || Lineas de Clientes/Divisas
     agifa324 #38;  || Divisas
     agifa325 #31;  || Historico
     agifa142 #142;
     agifa177 #177;
     dsm00279 #279;
     Referen@;
     referen@;
|FIN;

|CAMPOS;
  #3#5 canti;
  #3#9 imptot;
  #3#6 preu;
  #4#9 pcm;
|FIN;

|VARIABLES;
     aTipo = "";
     nSal = 0;
     nDiferencia = 0;
     nSwRavenida = 0;
     aAlbTMaquina = "";
     aFacTMaquina = "";
     nAlbReparto = 0;
     nFacReparto = 0;
     &enModo = 0;
     &eaSerie = "";
     &enCodigo = 0;
     nBtnItemDocFC = -1;
     aNume = "";
     aAlfa = "";
     aSerie = "";
     aProv = "";
     nNume = 0;
     aMensa = "";
     &enTiva         = 0;
     &enIva          = 0;
     &enRec          = 0;
     &eaPrv          = "";

     &enErrCarte     = 0;
     nForma          = 0;
     nSwFlag         = 0;
     nSwErr          = 0;
     aConfi          = "";

     &eaImpreSiNo   = "N";
     &eaSer         = "";
     &eaReimp       = "";
     &eaOrden       = "";
     &enNum         = 0;

     &enErr          = 0;
     nModo           = 0;
     &nDeci_Base     = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBase  = 0;   || Decimales en el Precio en moneda base
     &nDeci_BaseMx   = 0;   || Decimales en Totales de la moneda base
     &nDeci_PreBaseMx= 0;   || Decimales en el Precio en moneda base
     &nDeci_DivF     = 0;   || Decimales en Totales de la divisa
     &nDeci_PreDivF  = 0;   || Decimales en el Precio en divisa
     &nDeci_TotVisF  = 0;   || Decimales en Totales visibles (el de la moneda de trabajo)
     &nDeci_TotNoVisF = 0;   || Decimales en Totales no visibles (el de la otra moneda)
     &nDeci_PreVisF  = 0;   || Decimales en el Precio visual. (lineas)
     &nDeci_ImpVisF  = 0;   || Decimales en el Importe visual. (lineas)
     nfecha    = 0;
                         || activadas y la serie es de divisas
     &decim_divisa = 0;  || Decimales de la divisa
     &precio_divisa = 0; || Decimales del precio en divisa
     &decim_base = 0;    || Decimales de la moneda base
     &precio_base = 0;   || Decimales del precio en moneda base
     div_act = 0;        || Divisa actualizada. Me sirve en un PARA para que
                         || no salga hasta que este actualizada (div_act=1)
     &prov_divisa = "";  || Codigo de Proveedor. Se pasa a PROVEED/DIVISAS
     &divisa = "";       || Codigo de Divisa. Se pasa a ACTUAL. de DIVISAS
     factor = 0;         || factor de diferencia de cambio de albaran /factura
     div    = "";        || Variable de pintado
     sali = 0;           || Para condicio de salida
     camb = 0;           || Var. aux. para guardar el cambio

     nEuro     = 0;
     aEuro     = "";
     nCamImp   = 0;
     nCamFec   = 0;

 primera = 0;
 num = 0;
 i = 0;
 j = 0;
 a = 0;
 saltar = 0;
 voy = 0;
 con = 0;
 retencion = 0;
 mes = 0;
 imneto = 0;
 extras = 0;
 pm0 = 0;
 imneto2 = 0;
 impreso = 0;
fmes = " ";
mensaje1 = "0000El Proveedor del abono NO coincide con el de la factura";
mensaje2 = "0000Este Abono YA ESTA incluido en la factura: %s";
mensaje3 = "0000Este abono NO corresponde a esta factura";
mensaje4 = " ";
mensaje5 = "Procesando Abono :         Linea :     Articulo :";
mensaje10 = "0000No se puede modificar el PROVEEDOR";
mensajei  = "2400NDesea imprimir esta factura? ";
mensaje17="0000NDesea dejar la factura como NO impresa y anular los recibos?  ";
mensabono = "0000El albaran NO es de Abono !!";
&iva1 = 0;
&iva2 = 0;
&iva3 = 0;
&iva4 = 0;
&iva5 = 0;
&re1 = 0;
&re2 = 0;
&re3 = 0;
&re4 = 0;
&re5 = 0;
&fechae = @;
informe1 = "agifa079";
informe2 = "agif1079";
informe = "";
redondeo = 0;
importe = 0;
resto = 0;
sto = 0;
canti2 = 0;
lafecha = @;
yaesta = 0;
mala = 0;
entrada = 0;
modo    = 0;
     &bl  = "                              ";

     nTecla       = 0;
     &eaCodigo     = "";
     &eaTipoCodigo = "PR";
     &eaFuerza     = "";
|FIN;

||INC-LUYE llena_c5;

|PROCESO Entra078; |TIPO 7;
     |HAZ DefSerCom;
     |HAZ ControlUsuFC;
     |SI enErr ! 0; |PTEC 807; |ACABA; |FINSI;
|FPRC;

este calulo se efectua al entra el n de factura y pone un flag a 0
|PROCESO fprevio;|TIPO 0;
     modo = (FEntrada / 100) ! 0;
     |SI modo = 1;
          primera = 0;
     |SINO;
          primera = 1;
     |FINSI;
|FPRC;

|PROCESO llenarec;
     |HAZ leepago;
     |DDEFECTO #11;
     #11#0 = #0#0;
     #11#17 = #0#66;
     |PARA i = 1; |SI i [ #10#3; |HACIENDO i = i + 1;
          nCamImp = i + 32;
          |SI #0nCamImp = 0; |O i > 12; |ACABA; |FINSI;
          |SI i [ 6;
               nCamFec = i + 67;
          |SINO;
               nCamFec = i + 128;
          |FINSI;
          #11#7 = #0#1;
          #11#8 = #0nCamFec;
          #11#9 = #0nCamImp;
          #11#1 = i;
          #11#2 = #0#2;
          #11#3 = #0#3;
          #11#4 = #0#9;
          #11#12 = #0#12;
          #11#18 = #10#69;
          #11#21 = #10#69;
          #11#23 = #10#3;
          #11#24 = #10#0;
          #11#25 = #10#1;

          |ABRE #177;
          #177#0 = #11#18;
          |LEE 000#177=;
          |CIERRA #177;

          #11#15 = #177#3;      ||Cuenta
          ||HAZ CreaRecCompra;
     |SIGUE;
|FPRC;

|PROCESO borrareci;|TIPO 0;
     |HAZ MiraRecCompra;
     |SI enErrCarte ! 0;
          |MENAV "0000Recibos con movimientos, NO SE DARA DE BAJA...";
          nSwErr = 1; |ACABA;
     |FINSI;
     |HAZ BorraRecCompra;

     |PDEFECTO #0, 33, 45;
     |PDEFECTO #0, 68, 74;
|FPRC;

|PROCESO MiraAbono;
     nSwErr = 0;
     |ABRE #1;      ||Linfac
     |ABRE #2;      ||alba
     #1#16 = #0#66; ||serie
     #1#0  = #0#0;
     #1#1  = 1;
     |LEE 001#1];
     |SI FSalida = 0; |Y #1#0 = #0#0; |Y #1#16 = #0#66;
          #2#50 = #1#17; ||serie albaran
          #2#0  = #1#2;
          |LEE 001#2=;
          |SI FSalida = 0;
               |SI #2#42 = "N";
                    |MENAV "0000Esta factura NO es de ABONO, utilize el proceso Facturas";
                    nSwErr = 1;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #1;
     |CIERRA #2;
|FPRC;

|PROCESO baja11; |TIPO 1;
     nSwFlag = 0;
|FPRC;

|PROCESO actufa;|TIPO 2;
     |HAZ ControlUsuFC;
     |SI enErr ! 0; |ERROR; |ACABA; |FINSI;

     con = (FEntrada / 100) ! 0;
     nForma = 0 +. 1;

     |SI con = 1; nSwFlag = 0; |FINSI;
     |SI nSwFlag = 1; |ACABA; |FINSI;

     |SI con = 2; |O con = 3;
          |HAZ MiraAbono;
          |SI nSwErr ! 0;
               nSwFlag = 1;
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     |SI #0#45 = "S";
          |SI con = 2;|O con = 3;
               |SI #0#48 = "S";
                    |AVISO;
                    |CONFI "0000NEsta Factura Esta Contabilizada: Desea Continuar? ";
                    |SI FSalida ! 0;
                         nSwFlag = 1;
                         |ERROR; |ACABA;
                    |FINSI;
               |FINSI;
               |AVISO;
               |CONFI "0000NDesea dejar la factura como NO impresa y anular los recibos?  ";
               |SI FSalida ! 0;
                    nSwFlag = 1;
                    |ERROR; |ACABA;
               |SINO;
                    |HAZ borrareci;
                    |SI nSwErr ! 0;
                         nSwFlag = 1;
                         |ERROR; |ACABA;
                    |FINSI;
                    #0#45 = "N";
                    |PINTA #0#45;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nForma > 0;
         |HAZ CalCabAgifa079;
     |FINSI;

     |SI con = 3;
          |HAZ borrareci;
          |SI nSwErr ! 0;
               |ERROR;
               |ACABA;
          |FINSI;
     |FINSI;
     ||컴컴컴컴컴컴컴컴컴컴컴
     |SI con = 3;
          |HAZ EsAlbero;
          |SI FSalida = 0;
               |HAZ AlbeFacBorra;
          |FINSI;
          |HAZ EsVipei;
          |SI FSalida = 0;
               |HAZ VipeiFacBorra;
          |FINSI;
     |FINSI;
     ||컴컴컴컴컴컴컴컴컴컴컴
|FPRC;


|PROCESO fecha_pact_lin;
|SI #agifa325#4 > #2#60; |Y sali = 0; || Si la fecha en el hist. > fecha pactada ...
  #1#19 = camb;||Significa que me he pasado, el cambio valido es el anterior
  sali = 1; || Para que no vuelva a entrar en la condicion
  |SI camb = 0; || Si vale 0, significa que no hay actualizaciones anteriores, por tanto...
    |MENAV "0000Se utiliza como fecha de pacto la de la primera actualizacion";
    #1#19 = #agifa325#3; || Asigno el cambio de la 1a. actualizacion
  |FINSI;
|FINSI;
camb = #agifa325#3; ||Me guardo el cambio para la siguiente linea
|FPRC;


|DEFBUCLE fecha_pact; || Recorre el Historico de actualizaciones
#agifa325#2;          || 2a. Clave: divisa,fecha,guia
;
#1#18,"00.00.0000",0;
#1#18,"31.12.9999",99999999;
be;
NULL,fecha_pact_lin;
|FIN;


|PROCESO defecfl;|TIPO 0;
     |HAZ controli;
     |SI FSalida ! 0;  |ERROR;  |ACABA;  |FINSI;

     |SI #279#11 = "N";
          |SI #2#1 < "01.07.2010"; |Y #0#1 ] "01.07.2010";
               |MENAV "0000El % de iva no coincide con el de la factura";
               |ERROR; |ACABA;
          |FINSI;
          |SI #2#1 ] "01.07.2010"; |Y #0#1 < "01.07.2010";
               |MENAV "0000El % de iva no coincide con el de la factura";
               |ERROR; |ACABA;
          |FINSI;
     |FINSI;

     #0#75 = #2#56; || Divisa (cabecera)
     #0#77 = #2#58; || Moneda de trabajo (cabecera)
     #0#144 = #2#52; || %Rete
     #1#18 = #2#56; || Divisa (lineas)
     #1#19 = #2#57; || Cambio (lineas;
     |SI #2#59 = "A"; || Si en el alb., el cambio esta pact. al albaran
         |HAZ Param_Divisas3; || Lee Parametros
     |FINSI;

     #1#20 = #2#58; || Moneda de trabajo (lineas)
     |SI #2#59 = "F"; || Si en el alb., el cambio esta pact. a la fecha de la factura
         |HAZ CambioDivisa3; || Coge el valor actual de la divisa
     |FINSI;

     |SI #2#59 = "O"; || Si en el alb. el cambio esta pactado a Otra fecha
         |ABRE #agifa325; || Abre Hist. de actualizaciones
         sali = 0;  || Inicializo
         camb = 0;
         |BUCLE fecha_pact; || Busca en el historico de actualizaciones
         |SI sali = 0;
             |MENAV "0000Se utiliza como fecha de pacto la de la ultima actualizacion";
             #1#19 = camb;
         |FINSI;
         |CIERRA #agifa325;
     |FINSI;

     |HAZ CalLinAgifa079;

     |PINTA #1#27;
     |PINTA #1#28;
     |PINTA #1#30;
     |PINTA #1#31;
     |PINTA #1#32;
|FPRC;

|PROCESO leepago;|TIPO 0;
     |DDEFECTO #10;
     |ABRE #10;
     #10#0 = #0#11;
     |LEE 021#10=;
     |CIERRA #10;
|FPRC;

|PROCESO actufl;|TIPO 2;
     |HAZ EsRavenida;
     nSwRavenida = FSalida;

     #0#80 = #0#80 +. 1;  || Numero de lineas existentes
     |SI #0#80 = 1;       || Si hay solo una linea ...
         #0#75 = #1#18;     || ... cojo la divisa ...
         #0#77 = #1#20;     || ... y la moneda base.
          |SI nSwRavenida = 0;
               |HAZ RavenidaGra79_1;
          |FINSI;
     |FINSI;
     retencion = 0 +. 1;

     |ABRE #2;
     #2#0 = #1#2;
     #2#50 = #1#17;
     |SI 0 > retencion;
         |LEE 121#2=;
     |SINO;
         |LEE 120#2=;
     |FINSI;

     |SI 0 = FSalida;|Y 0 < retencion;
         |HAZ controli;
     |FINSI;

     |SI FSalida = 100;
         |ERROR;
         |ACABA;
     |FINSI;

     |SI 0 = primera;
         primera = 1;
     |FINSI;

     |SI 0 < retencion;
         #2#38 = AS;
         #2#39 = #0#0;
         #2#51 = #0#66;
         #2#77 = #0#1;
     |SINO;
         #2#38 = AN;
         #2#39 = A;
         #2#51 = A;
         #2#77 = "00.00.0000";
     |FINSI;
     #2#37 = 0;

     |ABRE #7;
     |ABRE #4;
     |PINTA 2413,mensaje5;|PINTA 2434,#2#0;
     |BUCLELIN 0kactuar#2;
     |CIERRA #4;
     |CIERRA #7;
     |BLIN 24;

     |GRABA 020#2a;
     |CIERRA #2;

     |SI nSwRavenida = 0;
          |HAZ RavenidaGra79;
     |FINSI;
|FPRC;

|PROCESO kactuar;|TIPO 0;
     |LEE 110#3=;
     |PINTA 2450,#3#1;|PINTA 2465,#3#2;

     #4#0 = #3#2;
     |LEE 121#4=;
     |SI 0 = FSalida;
         imneto = #3#9 < #2#5;
         imneto = imneto < #2#7;
         imneto = imneto < #2#32;
         extras = #1#5 + #1#6;
         pm0 = extras * #3#9;
         pm0 = pm0 / #2#15;
         imneto = imneto + pm0;
         canti2 = canti * retencion;
         imneto2 = imneto * retencion;
         fmes = #0#1 % A402;
         mes = fmes - 1;
         mes = mes * 5;
         mes = mes + 32;
         mes = mes + 1;
         ||#4mes = #4mes  - imneto2;            || pesetas compradas
         ||#4#93 = #4#93 -  imneto2;            || total pesetas
         |GRABA 020#4a;
         |LIBERA #4;
     |FINSI;

     #3#25 = #0#0;
     #3#28 = #0#66;
     |GRABA 020#3a;
     |LIBERA #3;
|FPRC;


|PROCESO controli;|TIPO 0;
     |HAZ EsRavenida;
     |SI FSalida = 0;
          |HAZ Ravenida79;
     |FINSI;

     FSalida = 0;
     |SI #0#80 ! 0;  || Si ya hemos puesto alguna linea ...
          |SI #2#56 ! #0#75; |O #2#58 ! #0#77;  || Si la moneda de trabajo o la divisa no coinciden ...
             |MENAV "0000La moneda de trabajo y la divisa de los albaranes deben coincidir";
             FSalida = 100; || Error
         |FINSI;
          |SI aAlbTMaquina ! aFacTMaquina; |O nAlbReparto ! nFacReparto;
               |MENAV "0000El %Reparto y el Tipo Maquina deben de coincidir";
               FSalida = 100;
          |FINSI;
     |FINSI;

     |SI #2#42 = "S";
         |SI #0#2 ! #2#3;
             |MENAV mensaje1;
             FSalida = 100;
         |SINO;
             |SI #2#38 ! AN;
                 mensaje4 = #2#39 ! mensaje2;
                 |MENAV mensaje4;
                 FSalida = 100;
             |SINO;
                 |SI 0 = primera;
                     i = (FEntrada / 100) ! 0;
                     |SI 1 = i;
                         #0#4 = #2#5;#0#6 = #2#7;#0#5 = #2#32;#0#11 = #2#8;
                         #0#76 = #2#57; || Cambio
                     |FINSI;
                 |FINSI;
                 |SI #0#4 ! #2#5;|O #0#6 ! #2#7;|O #0#5 ! #2#32;|O #0#11 ! #2#8;
                     |MENAV mensaje3;
                     FSalida = 100;
                 |FINSI;
             |FINSI;
         |FINSI;
    |SINO;
         |MENAV mensabono;
         FSalida = 100;
    |FINSI;
|FPRC;

|PROCESO ccffcc;|TIPO 6;
nTecla = FSalida;
con = FEntrada / 100;
con = con ! 0;
|SI con = 2;|Y #0Campo ! Contenido;
  #0Campo = Contenido;
  ||PINTA #0Campo;
  |MENAV mensaje10;
  |ERROR;
|FINSI;
|FPRC;

|CALCULO Salir;|TIPO 30;
     |HAZ EsTagloma;
     |SI FSalida = 0;
          eaSerie = #0#66;
          enCodigo = #0#0;
          |SUB_EJECUTA_NP "tagz0027;FAC";
     |FINSI;
|FCAL;

|PROCESO siimpre1;|TIPO 3;
     |SI #0#45 = AN;
          |HAZ VenciComp;
          |CONFI mensajei;
          |SI 0 = FSalida;
                |HAZ impreal1;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO T78_4; |TIPO 4;
     |SELECT #1#0;
     |LEE 000#0=;
     |SI FSalida ! 0;
          |MENAV "0000Por favor, consulte el registro correcto antes de imprimir.";
          |ACABA;
     |SINO;
          |PINDA #0#0;
          FEntrada = 402;
     |FINSI;
     |HAZ impreal1;
|FPRC;

|PROCESO impreal1;
     |SI #0#45 = "N";
          |||HAZ VenciComp;
          |||HAZ llenarec;
     |FINSI;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1; |O nModo = 2;
          |GRABA 020#0a;
     |FINSI;
     |CIERRAT #0;
     eaSer = #0#66;
     enNum = #0#0;
     eaOrden = "N";
     eaReimp = #0#45;
     |SUB_EJECUTA_NP "agifa056";
     |ABRET #0;
     #0#66 = eaSer;
     #0#0 = enNum;
     |SI nModo = 4;
          |LEE 000#0=;
     |SINO;
          |LEE 101#0=;
     |FINSI;
     |SI eaImpreSiNo = "N"; |Y #0#45 = "N";
          |ABRE #11;
          #11#0 = #0#0;
          #11#17 = #0#66;
          #11#1 = 0;
          |LEE 001#11];
          |PARA; |SI FSalida = 0; |Y #11#0 = #0#0; |Y #11#17 = #0#66; |HACIENDO;
               |BORRA 020#11a;
               |LEE 001#11s;
          |SIGUE;
          |CIERRA #11;
     |FINSI;
|FPRC;

|PROCESO Tipo21_11; |TIPO 11;
     ||컴컴컴컴컴컴컴컴컴컴컴컴
     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbeFacComLin2;
     |FINSI;
     ||컴컴컴컴컴컴컴컴컴컴컴컴
|FPRC;

|PROCESO tipo21_7; |TIPO 7;
     ||컴컴컴컴컴컴컴컴컴컴컴컴
     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbeFacComLin1;
     |FINSI;
     ||컴컴컴컴컴컴컴컴컴컴컴컴
     |ABRE #2;
     #2#50 = #1#17;
     #2#0 = #1#2;
     |LEE 000#2=;
     |SI FSalida ! 0; |DDEFECTO #2; |FINSI;
     |CIERRA #2;
     |ABRE #agifa321;
     |LEE 010#agifa321.p;
     |CIERRA #agifa321;
     |ABRE #agifa007;
     #agifa007#26 = #0#66;
     |LEE 010#agifa007.=; || Leo la serie de la factura
     |CIERRA #agifa007;

     |SI #agifa007#39 = "S"; |Y #agifa321#4 = "S"; ||Si serie es de divisas y pintar = "S";
          ||PINTA 1004, " Su Albaran n:            ";
          |PINTA 1005, "Su Albaran n:";
          |ATRI I; |PINTA 1020, #2#54; |ATRI 0;
          ||div = "       Mon.Tra:    Divisa:      Cambio:         ";
          |||PINTA 1031, div;
          |PINTA 1038, "Mon.Tra:";
          |PINTA 1050, "Divisa:";
          |PINTA 1063, "Cambio:";
          |ATRI I;
          |PINTA 1047, #1#20; || Mon. de trabajo
          |PINTA 1058, #1#18; || Divisa
          |PINTA 1071, #1#19; || Cambio
          |ATRI 0;
          |SI #0#77 = "B";
            div = " (" + #0#75 + ") --->";
          |SINO;
            div = " (" + #0#78 + ") --->";
          |FINSI;
          ||div = div + "                                                                ";
          |PINTA 1104,div;
          |ATRI I;
          || Pinta campos vis.
          |PINTA 1116,#1#33;
          |PINTA 1127,#1#34;
          |PINTA 1137,#1#35;
          |PINTA 1147,#1#36;
          |PINTA 1158,#1#37;
          |PINTA 1168,#1#38;
          |ATRI 0;
     |SINO;
          ||PINTA 1104, " Su Albaran n:            ";
          |PINTA 11045, "Su Albaran n:";
          |ATRI I; |PINTA 1120, #2#54; |ATRI 0;
          |SI #agifa007#39 = "S"; || Si la serie es de divisas
               ||div = "       Mon.Tra:    Divisa:      Cambio:         ";
               ||PINTA 1131, div;
               |PINTA 1038, "Mon.Tra:";
               |PINTA 1050, "Divisa:";
               |PINTA 1063, "Cambio:";
               |ATRI I;
               |PINTA 1147, #1#20; || Moneda de trabajo
               |PINTA 1158, #1#18; || Divisa
               |PINTA 1171, #1#19; || Cambio
               |ATRI 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO LeeFac; |TIPO 13;
     |HAZ LeeMonBase2; || Lee los parametros de la moneda base
     |HAZ Param_Divisas3; || Lee los parametros de la divisa
     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbeFacPinta;
     |FINSI;
     |HAZ EsVipei;
     |SI FSalida = 0;
          |HAZ VipeiPinFac;
     |FINSI;
     |HAZ EsTaller;
     |SI FSalida = 0;
          |ATRI R; |PINTA 2202, "CANON";
          |ATRI I; |PINTA 2208, #0#148;
     |FINSI;
     |HAZ EsRavenida;
     |SI FSalida = 0;
          |HAZ PinRavenida79;
     |FINSI;
|FPRC;

|PROCESO LeeMonBase2; ||Lee los parametros de la moneda base
     |ABRE #agifa321;
     |ABRE #agifa324;
     |LEE 010#agifa321.p;   ||Leo parametros de divisa
     #agifa079#78 = #agifa321#9;  ||Cojo la Moneda Base de parametros
     #agifa324#0 = #agifa321#9;
     |LEE 010#agifa324.=;         ||Leo la ficha de la moneda base en Divisas
     #agifa079#79 = #agifa324#3;  ||Asigno el cambio de la moneda base con el euro
     decim_base = #agifa324#7;    ||Asigno los decimales de la moneda base
     precio_base = #agifa324#9;   ||Asigno los decimales del precio en la mon. base
     |CIERRA #agifa324;
     |CIERRA #agifa321;
|FPRC;

|PROCESO Param_Divisas3; |TIPO 0;
     |ABRE #agifa324;
     #agifa324#0 = #0#75;
     |LEE 001#agifa324.=;   || Leo la divisa
     |CIERRA #agifa324;

     decim_divisa = #agifa324#7;  || Decimales de la divisa
     precio_divisa = #agifa324#9;  || Decimales en el precio de la divisa
     nDeci_DivF = decim_divisa;   || Decimales de la divisa
     nDeci_PreDivF = precio_divisa;  || Decimales en el precio de la divisa
     |SI #0#77 = "B";   ||Si trabajo con la moneda base ...
          nDeci_PreVisF   = precio_divisa;
          nDeci_ImpVisF   = decim_divisa;
          nDeci_Base     = decim_base;
          nDeci_PreBase  = precio_base;
          nDeci_BaseMx   = decim_base;
          nDeci_PreBaseMx= precio_base;
          nDeci_TotVisF   = decim_base;
          nDeci_TotNoVisF = decim_divisa;
     |SINO;     ||Si trabajo con la divisa ...
          nDeci_PreVisF   = precio_base;
          nDeci_ImpVisF   = decim_base;
          |SI #0#76 = 1;
               nDeci_BaseMx    = decim_base;    || sin triangulacion
               nDeci_PreBaseMx = precio_base;
          |SINO;
               nDeci_BaseMx    = #agifa321#10;  || con triangulacion
               nDeci_PreBaseMx = #agifa321#11;
          |FINSI;
          nDeci_Base     = decim_base;
          nDeci_PreBase  = precio_base;
          nDeci_TotVisF   = decim_divisa;
          nDeci_TotNoVisF = decim_base;
     |FINSI;
     |HAZ Deci_IVAC;
|FPRC;

|PROCESO CambioDivisa3; |TIPO 0;
      |SI #agifa112#80 = "S"; || Si el proveedor es de divisa pactada
         |ABRE #agifa323;
         |ABRE #agifa322;
         #agifa322#0 = #agifa079#2;
         #agifa322#2 = #agifa072#18;
         #agifa322#7 = "N";
         |SELECT #2#agifa322;  || Con esta clave ...
         |LEE 011#agifa322.=;  || ... busco periodos no finalizados de esa divisa
         |SI FSalida = 0;  || Si existe un periodo no finalizado
           |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
             #agifa072#18 = #agifa322#2;        || Cargo la divisa ...
             #agifa072#19 = #agifa322#3;        || ...y el cambio
             |LEE 001#agifa322.=;   || Leo las lineas de Proveed/Divisas
             nfecha = #agifa079#1 - #agifa322#6;  || Resto la fecha de fin de periodo a la actual
             |SI nfecha > 0;  || Si la fecha actual supera a la del periodo asignado ...
                |MENAV "0000ATENCION deberia Actualizar primero la divisa en Proveedores/Divisas";
                prov_divisa = #agifa079#2;  || Le envio el cod. de proveedor a "agifa323"
                |SUB_EJECUTA_NP "agifa323.tab";  || Ejecuto Proveedores/Divisas
                |ERROR;
             |SINO;
                div_act = 1;  || Para salir del PARA
             |FINSI;
           |SIGUE;
         |SINO;  || Si no existe un periodo no finalizado para esa divisa
           |MENAV "0000No existe un periodo activo para la divisa en Proveedores / Divisas";
           prov_divisa = #agifa079#2;  || Le paso a "agifa323" el proveedor
           |SUB_EJECUTA_NP "agifa323.tab";  || Ejecuto Proveedores / Divisas
           |ERROR;
           ||#agifa072#18 = #agifa079#78;
           ||#agifa072#19 = #agifa079#79;
         |FINSI;
         |SELECT #1#agifa322;
         |CIERRA #agifa322;
         |CIERRA #agifa323;
      |SINO; || Si el Proveedor no es de Divisa pactada ...
         |ABRE #agifa324; || ...miro directamente en divisas
         #agifa324#0 = #agifa072#18;
         |LEE 001#agifa324.=;
         |SI FSalida = 0; ||Si existe la divisa...
            #agifa072#19 = #agifa324#3; || la recojo
            |SI #agifa324#6 ! -1; || Si los dias de margen de actualizacion no
                                  || son = -1 (indefinidos)
              |PARA div_act = 0; |SI div_act = 0; |HACIENDO;
                 #agifa072#18 = #agifa324#0;        ||Cargo el valor de la divisa
                 #agifa072#19 = #agifa324#3;        ||Cargo el valor del cambio
                 |LEE 001#agifa324.=;  || Leo la divisa
                 nfecha = #agifa079#1 - #agifa324#4;
                 |SI nfecha > #agifa324#6; |Y #agifa324#6 ! -1;  || Si la fecha actual
                    |MENAV "0000ATENCION deberia Actualizar primero la divisa";
                    divisa = #agifa072#18;
                    |SUB_EJECUTA_NP "agifa326.tab";
                    |ERROR;
                 |SINO;
                    div_act = 1;
                 |FINSI;
              |SIGUE;
            |FINSI;
         |FINSI;
         |CIERRA #agifa324;
      |FINSI;
      |HAZ Param_Divisas3;
|FPRC;

|PROCESO PriNumeSer;
     aNume = "0";
     |PARA i = 101; |SI i [ 501; |HACIENDO i = i + 100;
          aAlfa = #0#66 % i;
          aAlfa = "0123456789" - aAlfa;
          |SI FSalida > 0; aNume = #0#66 % i; |SAL; |FINSI;
     |SIGUE;
|FPRC;

|PROCESO ObsProveedor; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |ABRE #142; |LEE 040#142p; |CIERRA #142;

     |SI #0Campo ! Contenido; |O nModo = 1;
          |HAZ EsPalmHotel;
          |SI FSalida = 0;
               |HAZ PriNumeSer;
               aAlfa = "40000" + aNume + #0#2;
               #0#12 = aAlfa; |PINTA #0#12;
          |FINSI;
     |FINSI;

     |SI nModo = 1;
          |ABRE #6;
          #6#0 = #0#2;
          |LEE 000#6=;
          |CIERRA #6;
          #0#3 = #6#1; |PINTA #0#3;
     |FINSI;

     |SI nTecla = 11; |O #142#102 = "S"; |O #142#102 = "X";
          eaCodigo = #0#2;
          eaFuerza = "N";
          |SI nTecla = 11; eaFuerza = "S"; |FINSI;
          |SUB_EJECUTA_NP "dsz99994";
          |SI #142#102 = "N"; |Y nModo ! 2; |ERROR;  |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo078_8; |TIPO 8;
     |ABRE #279; |LEE 000#279p; |CIERRA #279;
     ||컴컴컴컴컴컴컴컴횺odulo 003026
     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbeFacCom8;
     |FINSI;
     ||컴컴컴컴컴컴컴컴컴컴컴
     |HAZ EsTagloma;
     |SI FSalida = 0;
          |CONTROL_SIMPLE 0, "BOTON, ItemDoc", 0570, 0579, BtnItemDocFC;
          nBtnItemDocFC = FSalida;
     |FINSI;
|FPRC;

|PROCESO Tipo078_9; |TIPO 9;
     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbeFacCom9;
     |FINSI;
     |SI nBtnItemDocFC ! -1; |FIN_CONTROL_WINDOWS nBtnItemDocFC; |FINSI;
|FPRC;

|PROCESO Pago78_0; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |HAZ EsAlbero;
     |SI FSalida = 0; |Y nModo = 1;
          |HAZ AlbeFacFec;
          |HAZ AlbeFacPinta;
     |FINSI;
|FPRC;

|PROCESO Nom78_0; |TIPO 0;
     nSal = FSalida;
     enModo = (FEntrada / 100) ! 0;
     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbeFacEntra;
     |FINSI;

     |SI nSal = 0;
          |HAZ EsRavenida;
          |SI FSalida = 0;
               eaSerie = #0#66;
               enCodigo = #0#0;
               |SUB_EJECUTA_NP "ravem006";
               |HAZ PinRavenida79;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO VipeiPinFac;
     |DDEF aAlfa;
     aAlfa = aAlfa + "dsm00277";
     |CARGA_DEF aAlfa, Referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;
     |DDEFECTO #Referen@;
     |ABRE #Referen@;
     #Referen@#0 = #0#66;
     #Referen@#1 = #0#0;
     |LEE 000#Referen@.=;
     |CIERRA #Referen@;
     |PINTA 1002, "Refer.:";
     |ATRI I;
     |PINTA 1010, #Referen@#2;
     |ATRI 0;
     |DESCARGA_DEF #Referen@;
|FPRC;

|PROCESO SuFactura7; |TIPO 7;
     |HAZ EsVipei;
     |SI FSalida = 0;
          |DDEF aAlfa;
          aAlfa = aAlfa + "dsm00277";
          |CARGA_DEF aAlfa, Referen@;
          |SI FSalida ! 0; |ACABA; |FINSI;
          |DDEFECTO #Referen@;
          |ABRE #Referen@;
          #Referen@#0 = #0#66;
          #Referen@#1 = #0#0;
          |LEE 101#Referen@.=;
          |SI FSalida ! 0; |GRABA 020#Referen@.b; |FINSI;
          |ENCAMPO #2#Referen@;
          |SI FSalida = 0; |GRABA 020#Referen@.a; |FINSI;
          |CIERRA #Referen@;
          |DESCARGA_DEF #Referen@;
     |FINSI;
|FPRC;

|PROCESO SuFactura; |TIPO 0;
     |HAZ EsAlbero;
     |SI FSalida = 0;
          |HAZ AlbeFacEntra;
     |FINSI;

     aAlfa = #0#74; |QBF aAlfa;
     |SI aAlfa = ""; |ACABA; |FINSI;

     aAlfa = #0#74;
     aSerie = #0#66;
     aProv = #0#2;
     nNume = #0#0;
     aMensa = "";
     |SALVA_FICHA #0;
     |SELECT #4#0;
     |LEE 000#0];
     |PARA; |SI FSalida = 0; |Y aProv = #0#2; |Y #0#74 = aAlfa; |HACIENDO;
          |SI #0#66 ! aSerie; |O nNume ! #0#0;
               aAlfa = ("000000" + #0#0) % -106;
               aMensa = "0000Codigo existente en Albaran:" + #0#66 + "/" + aAlfa;
               |SAL;
          |FINSI;
          |LEE 000#0s;
     |SIGUE;
     |SELECT #1#0;
     |REPON_FICHA #0;
     |SI aMensa ! "";
          |MENAV aMensa;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO VipeiFacBorra;
     |DDEF aAlfa;
     aAlfa = aAlfa + "dsm00277";
     |CARGA_DEF aAlfa, Referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;
     |ABRE #Referen@;
     #Referen@#0 = #0#66;
     #Referen@#1 = #0#0;
     |LEE 101#Referen@.=;
     |SI FSalida = 0; |BORRA 020#Referen@.a; |FINSI;
     |CIERRA #Referen@;
     |DESCARGA_DEF #Referen@;
|FPRC;

|PROCESO BtnItemDocFC;
     aAlfa = "tagz0025;FC" + #0#66 + #0#0;
     |SUB_EJECUTA_NP aAlfa;
|FPRC;

|PROCESO PinRavenida79;
     |DDEF aAlfa;
     aAlfa = aAlfa + "ravem006";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #0#66;
          #referen@#1 = #0#0;
          |LEE 000#referen@.=;
          |CIERRA #referen@;
          |SI FSalida ! 0; |DDEFECTO #referen@; |FINSI;
          |PINTA 0901, "%Repar.쿟 F.Inicio  F.Final  쿏iferencia";
          |ATRI R;
          |PINTA 0902, "%Repar.쿟 F.Inicio  F.Final  쿏iferencia";
          |ATRI 0;
          |PINTA 1001, "                                      ";
          |PINTA 1101, "쳐컴컴컴좔좔컴컴컴컴컨컴컴컴컴컴좔컴컴컴컴컨";
          |ATRI I;
          |PINTA 1002, #referen@#3;
          |PINTA 1010, #referen@#2;
          |PINTA 1012, #referen@#5;
          |PINTA 1023, #referen@#6;
          |PINTA 1034, #referen@#4;
          |ATRI 0;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO Ravenida79;
     |DDEF aAlfa;
     aAlfa = aAlfa + "ravem004";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #2#50;
          #referen@#1 = #2#0;
          |LEE 000#referen@.=;
          |CIERRA #referen@;
          aAlbTMaquina = #referen@#4;
          nAlbReparto = #referen@#2;
          nDiferencia = #referen@#3
          |DESCARGA_DEF #referen@;
     |FINSI;

     |DDEF aAlfa;
     aAlfa = aAlfa + "ravem006";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #0#66;
          #referen@#1 = #0#0;
          |LEE 000#referen@.=;
          |CIERRA #referen@;
          aFacTMaquina = #referen@#2;
          nFacReparto = #referen@#3;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO RavenidaGra79_1;
     |DDEF aAlfa;
     aAlfa = aAlfa + "ravem006";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #0#66;
          #referen@#1 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida ! 0; |GRABA 020#referen@.b; |FINSI;
          #referen@#2 = aAlbTMaquina;
          #referen@#3 = nAlbReparto;
          #referen@#4 = 0;
          |GRABA 020#referen@.a;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO RavenidaGra79;
     |DDEF aAlfa;
     aAlfa = aAlfa + "ravem006";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = #0#66;
          #referen@#1 = #0#0;
          |LEE 101#referen@.=;
          |SI FSalida ! 0; |GRABA 020#referen@.b; |FINSI;
          #referen@#4 = #referen@#4 + nDiferencia;
          |GRABA 020#referen@.a;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;
