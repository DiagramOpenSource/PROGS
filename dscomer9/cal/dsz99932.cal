|FICHEROS;
     agifa142 #142;
     ||dsz99995
     dsm00246 #40;       ||Control Riesgo Por Usuarios.
     dsm00247 #41;       ||Pantalla Informe Riesgo.
     dsm00248 #43;       ||Auditoria Riesgos
|FIN;

|VARIABLES;
     &eaDesdeLinea = "";
     aMuestra = "";
     aDatoRie = "";
     aAvisaRie = "";
     aTipoRie = "";

     &eaObserv = "";
     &eaMuestra = "";
     &eaDocu = "";
     &enImpoDoc = 0;
     &eaTipo = "";

     &enAudito = 0;
     &enErrRie = 0;

     &nRieTotal = 0;
     &nRieUtili = 0;
     &aRieBloqu = "";
     &aBloquead = "";

     aAlfa  = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aUs = "";
     aFin = "";
     aTecla = "";
|FIN;

|PROCESO AvisaRiesgo0;
     |AVISO;
     |PUSHV 0501 2380;
     |BLANCO 0919 1667;
     |CUADRO 0919 1667;
     |CUADRO 1020 1566;
     |COLOR 7,4; |ATRI 0; |BLANCO 1021 1465; |ATRI 0;
     |COLOR 4,7; |ATRI 0; |PINTA 1230, " RIESGO CLIENTE SUPERADO..."; |ATRI 0;
     |COLOR 15,4; |ATRI 0; |PINTA 1440, "Pulse Fin para continuar."; |ATRI 0;
     aFin = &255 + 816;
     |PARA aTecla = ""; |SI aTecla ! aFin; |HACIENDO;
          |LEETECLA aTecla;
     |SIGUE;
     |POPV;
|FPRC;

|PROCESO LimiteUsuario;
     aUs = Usuario % 0810;
     |ABRE #40;
     #40#0 = eaTipo;     || Tipo
     #40#1 = aUs;
     |LEE 000#40=;
     |SI FSalida ! 0;
          aAlfa = "0000Usuario [" + aUs + "]  no definido en control riesgos.";
          |MENAV aAlfa;
          enErrRie = 1;
     |SINO;
          |DDEFECTO #41;
          #41#0 = nRieTotal;       || Riesgo concedido
          #41#1 = nRieUtili;       || Riesgo Utilizado
          #41#2 = #40#2;
          #41#3 = nRieTotal +  (nRieTotal % #40#2);
          #41#4 = #40#3;
          #41#5 = enImpoDoc;

          #41#7 = "PERMITIDA EN USUARIO";
          |SI #41#5 > #41#4;
               #41#7 = "DENEGADA EN USUARIO";
                enErrRie = 1;
          |SINO;
               |||SI #41#1 > #41#0; Jose Thu Sep 21 11:25:59 CEST 2006
               |SI #41#1 ] #41#0;
                    #41#7 = "DENEGADA EN CARTERA";
                    enErrRie = 1;
               |SINO;
                    #41#7 = "PERMITIDA EN CARTERA";
               |FINSI;
          |FINSI;

          |SI eaMuestra ! "N";
               aMuestra = "S";
               |SI eaDesdeLinea = "S"; |Y enErrRie = 0;
                    aMuestra = "N";
               |FINSI;
          |FINSI;

          |SI aMuestra = "S";
               |PUSHV 0501 2380;
               |SI aDatoRie = "S";
                  |SI eaMuestra = "C";     || desde el agifa024
                      |QBF eaObserv;
                      |SI eaObserv = "";
                         |BLANCO 0913 1362;
                         |CUADRO 0913 1362;
                         |CUADRO 1013 1362;
                         |ATRI I; |PINTA 0918, "CONTROL RIESGO"; |ATRI 0;
                         |PINTA 1118, "Riesgo Concedido.:";
                         |PINTA 1218, "Riesgo Utilizado.:";
                         |PINTA 1138, #41#0;
                         |PINTA 1238, #41#1;
                      |SINO;
                         |BLANCO 0913 1762;
                         |CUADRO 0913 1762;
                         |CUADRO 1013 1762;
                         |ATRI I; |PINTA 0918, "CONTROL RIESGO"; |ATRI 0;
                         |PINTA 1118, "Riesgo Concedido.:";
                         |PINTA 1218, "Riesgo Utilizado.:";
                         |PINTA 1138, #41#0;
                         |PINTA 1238, #41#1;
                         |ATRI I; |PINTA 1318, "Observaciones: "; |ATRI N;
                         aAlfa  = eaObserv; |QBF aAlfa;
                         aAlfa1 = eaObserv % 0147; |QBF aAlfa1; aAlfa = aAlfa - aAlfa1;
                         |SI aAlfa ! "";
                            aAlfa2 = aAlfa1 % -101;
                            |PARA; |SI aAlfa2 ! " "; |Y aAlfa2 ! ",";
                                   |Y  aAlfa2 ! "."; |Y aAlfa2 ! ";"; |Y aAlfa2 ! ":"; |HACIENDO;
                                aAlfa1 = aAlfa1 % -299; aAlfa = aAlfa2 + aAlfa;
                                aAlfa2 = aAlfa1 % -101;
                            |SIGUE;
                            |PINTA 1415, aAlfa1;
                            |PINTA 1515, aAlfa;
                         |SINO;
                            |PINTA 1415, aAlfa1;
                         |FINSI;
                      |FINSI;
                  |SINO;
                      |QBF eaObserv;
                      |SI eaObserv = "";
                         |CAMPO_POSICION #dsm00247#2, 1, 1337;
                         |CAMPO_POSICION #dsm00247#3, 1, 1348;
                         |CAMPO_POSICION #dsm00247#4, 1, 1534;
                         |CAMPO_POSICION #dsm00247#5, 1, 1734;
                         |BLANCO 0913 2162;
                         |PINPA #0#41;
                         |PINDA #0#41;
                      |SINO;
                         |BLANCO 0913 2162;
                         |PINPA #0#41;
                         |BLANCO 1315 1761;
                         |CAMPO_POSICION #dsm00247#2, 1, 1237;
                         |CAMPO_POSICION #dsm00247#3, 1, 1248;
                         |CAMPO_POSICION #dsm00247#4, 1, 1334;
                         |CAMPO_POSICION #dsm00247#5, 1, 1434;
                         |PINTA 1215, "Exceso Permitido.:  %";
                         |PINTA 1315, "Limite Documento.:";
                         |PINTA 1415, "Importe Documento:";
                         |ATRI I; |PINTA 1515, "Observaciones"; |ATRI N;
                         aAlfa  = eaObserv; |QBF aAlfa;
                         aAlfa1 = eaObserv % 0147; |QBF aAlfa1; aAlfa = aAlfa - aAlfa1;
                         |SI aAlfa ! "";
                            aAlfa2 = aAlfa1 % -101;
                            |PARA; |SI aAlfa2 ! " "; |Y aAlfa2 ! ",";
                                   |Y  aAlfa2 ! "."; |Y aAlfa2 ! ";"; |Y aAlfa2 ! ":"; |HACIENDO;
                                aAlfa1 = aAlfa1 % -299; aAlfa = aAlfa2 + aAlfa;
                                aAlfa2 = aAlfa1 % -101;
                            |SIGUE;
                            |PINTA 1615, aAlfa1;
                            |PINTA 1715, aAlfa;
                            |PINDA #0#41;
                         |SINO;
                            |PINTA 1615, aAlfa1;
                            |PINDA #0#41;
                         |FINSI;
                      |FINSI;
                  |FINSI;
               |SINO;
                    |BLANCO 1825 2061;
                    |CUADRO 1825 2061;
                    |PINTA 1927, "OPERACION  : ";
                    |PINTA 1940, #41#7;
               |FINSI;
               |PAUSA;
               |POPV;
          |FINSI;
          |SI enErrRie = 0; enAudito = 1; |FINSI;
     |FINSI;
     |CIERRA #40;
|FPRC;

Variables Llamada: eaDocu, eaTipo, enImpoDoc, eaMuestra
                   nRieTotal, nRieUtili, aRieBloqu, aBloquead

Variables Retorno: enErrRie, enAudito

|PROCESO ControlRiesgo;
     enErrRie = 0;
     enAudito = 1;

     |SI eaTipo = "A";
          aAvisaRie = #142#6;
          aTipoRie = #142#22;
          aDatoRie = #142#233;
     |SINO;
          aAvisaRie = #142#166;
          aTipoRie = #142#167;
          aDatoRie = #142#232;
     |FINSI;
     |SI eaTipo = "C";
          aAvisaRie = #142#251;
          aTipoRie = #142#252;
          aDatoRie = #142#253;
     |FINSI;

     |SI aRieBloqu = "S"; |Y eaDocu = "C";
          |HAZ BloqCart;
          enErrRie = 1;
          |ACABA;
     |FINSI;

     |SI aAvisaRie = "N"; |ACABA; |FINSI;

     |SI eaTipo = "A"; |Y aTipoRie = "B";
        |SI aBloquead = ""; |ACABA; |FINSI;
     |FINSI;

     |SI aTipoRie = "P";
          |HAZ LimiteUsuario;
     |FINSI;

     |SI nRieUtili < nRieTotal; |ACABA; |FINSI;

     |SI eaMuestra = "N"; |ACABA; |FINSI;

     |SI aTipoRie = "N";
          |MENAV "0000Se supera el Riesgo Limite del cliente";
     |FINSI;
     |SI aTipoRie = "S";
          |HAZ AvisaRiesgo0;
     |FINSI;

     |SI nRieTotal ! 0; |Y eaDocu = "C"; |Y enErrRie = 0; |Y aTipoRie ! "P";
          |QBF eaObserv;
          |SI eaObserv = "";
             |PUSHV 0501 2380;
             |BLANCO 0948 1672;
             |CUADRO 1148 1672;
             |CUADRO 0948 1672;
             |ATRI R; |PINTA 1049, "  < CONTROL RIESGOS >  "; |ATRI 0;
             |ATRI I;
             |PINTA 1250, "Concedido:";
             |PINTA 1350, "Total ...:";
             |PINTA 1261, nRieTotal;
             |PINTA 1361, nRieUtili;
             |PAUSA;
             |POPV;
          |SINO;
             |PUSHV 0501 2380;
             |BLANCO 0948 1772;
             |CUADRO 1148 1772;
             |CUADRO 0948 1772;
             |ATRI R; |PINTA 1049, "  < CONTROL RIESGOS >  "; |ATRI 0;
             |ATRI I;
             |PINTA 1250, "Concedido:";
             |PINTA 1350, "Total ...:";
             |PINTA 1261, nRieTotal;
             |PINTA 1361, nRieUtili;
             |PINTA 1450, "Observaciones: ";
             aAlfa  = eaObserv; |QBF aAlfa;
             aAlfa1 = eaObserv % 0121; |QBF aAlfa1; aAlfa = aAlfa - aAlfa1;
             |SI aAlfa ! "";
                aAlfa2 = aAlfa1 % -101;
                |PARA; |SI aAlfa2 ! " "; |Y aAlfa2 ! ",";
                       |Y  aAlfa2 ! "."; |Y aAlfa2 ! ";"; |Y aAlfa2 ! ":"; |HACIENDO;
                   aAlfa1 = aAlfa1 % -299; aAlfa = aAlfa2 + aAlfa;
                   aAlfa2 = aAlfa1 % -101;
                |SIGUE;
                |PINTA 1550, aAlfa1;
                aAlfa1 = aAlfa % 0121; |PINTA 1650, aAlfa1;
             |SINO;
                |PINTA 1550, aAlfa1;
             |FINSI;
             |ATRI 0;
             |PAUSA;
             |POPV;
          |FINSI;
     |FINSI;
     eaDocu = "";
     eaMuestra = "";
|FPRC;
