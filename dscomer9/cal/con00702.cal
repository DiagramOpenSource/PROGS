|FICHEROS;
     con00702 #0;
     con00686 #2;  ||Temporal de aparcadas
     con00625 #1;
     con00626 #3; ||Lineas de O.R.
     con00642 #4; ||lineas de factura
     agifa019 #5;
     con00637 #6; ||facturas
     agifa024 #7;
     con00603 #8; ||Maestro M.Obra
     con00606 #9; ||Maestro Ser. Exteriores
     agifa010 #10;
     agifa059 #11;
     agifa134 #12;
     agifa027 #13;
     agifa091 #14;
     con01625 #18;  ||Texto inicial O.R.
     con00683 #19;  ||Control aplicacion
     con00634 #21;  ||texto explicativo
     con00680 #22;
     agifa007 #23;  ||series

     agifa133 #30;
     agifa091 #31;
     agifa177 #32;
     agis0002 #33;
     dsz99984 #35;
     agifa071 #71;
     con00703 #703;
     con00008 #800;
     con00612 #612;
     con00691 #691;
     con00695 #695; ||Tmp Lin OR Facturadas
     con00696 #696;
     con00644 #644; || Temporal
     agifa142 #142;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     fFecha = @;
     nMargen = 0;
     nImpo = 0;
     nSwTallerSC = 0;
     aTmp644 = "";
     aFinal = "";
     aTmp2 = "";
     aTmp695 = "";
     &Tempo = "";

     nError = 0;
     nEmpresa = 0;
     aAgrupa = "";
     aMatricula = "";
     &eaTag = "";
     aAlfa = "";
     &aDivisa     = "";
     &aMoneda     = "";
     r_alfa = "";
     r_long = "";
     r_num = 0;
     mensaje = "";
     sal = 0;
     sw = 0;
     cliente = "";
     lin = 0;
     tipo_iva = 0;
     lfac = 0;
     numf = 0;
     fmes = "  ";
     mes = 0;
     imneto = 0;
     num = 0;
     importe = 0;
     tipo_imp = 0;
     resto = 0;
     redondeo = 0;
     em = 0;
     fecha_fac = @;
     i = 0;
     j = 0;
     k = 0;
     fechae = @;
     mes_venci = "";
     mes_ven = 0;
     fecha = "         ";
     dia_venci = "";
     any_venci = "";
     fechas = "";
     cafe = "";
     diafe = "";
     dianu = "";
     expor = "";
     dia1 = 0;
     dia2 = 0;
     dia3 = 0;
     nOk = 0;
     nGraba = 0;
     nCampo =0;
     aArti = "";
     nUni = 0;
|FIN;

|VARIABLES;
   &eaProg = "";
   &enAcuenta = 0;

   nVto = 0;
|FIN;

|PROCESO ActuaArti;
     |ABRE #5;
     #5#0 = aArti;
     |LEE 101#5=;
     |SI FSalida = 0;
          #5#24 = fFecha;
          #5#25 = nUni;
          #5#95 = #5#95 + nImpo;
          #5#96 = #5#96 + nMargen;
          aAlfa = fFecha % 402;
          nCampo = ((N\aAlfa) - 1) * 5 + 35;
          #5nCampo = #5nCampo + nImpo;
          nCampo = nCampo + 1;
          #5nCampo = #5nCampo + nMargen;
          |GRABA 020#5a;
     |FINSI;
     |CIERRA #5;
|FPRC;

|PROCESO CreaRecibos;
     |ABRE #agifa133;
     |ABRE #agis0002;
     |ABRE #agifa177;

     |ABRE #agifa091;

     #agifa091#0 = #agifa134#11;
     |LEE 000#agifa091.=;
     |SI FSalida ! 0; |DDEFECTO #agifa091; |FINSI;

     nVto = 0;
     #agifa133#0 = #agifa134#0;
     #agifa133#4 = #agifa134#49;
     #agifa133#1 = 0;
     |LEE 000#agifa133.];
     |PARA ; |SI FSalida = 0; |Y #agifa133#0 = #agifa134#0;|Y #agifa133#4 = #agifa134#49; |HACIENDO;
          nVto = nVto + 1;
          |LEE 000#agifa133.s;
     |SIGUE;

     |HAZ AbreRecVenta;

     #agifa133#0 = #agifa134#0;
     #agifa133#4 = #agifa134#49;
     #agifa133#1 = 0;
     |LEE 000#agifa133.];
     |PARA ; |SI FSalida = 0; |Y #agifa133#0 = #agifa134#0;|Y #agifa133#4 = #agifa134#49; |HACIENDO;
          |SI #agifa133#5 = "S";
               |DDEFECTO #agis0002;
               #agis0002#30 = "A";       || busca como albaran
               #agis0002#20 = #agifa133#6;     || Serie pedido.
               #agis0002#17 = #agifa133#7;     || Numero pedido.
               #agis0002#18 = #agifa133#8;     || Numero recibo.
               |LEE 000#agis0002.=;
               |SI FSalida ! 0;
                    #agis0002#30 = "P";       || busca como pedido
                    |LEE 000#agis0002.=;
               |FINSI;
          |FINSI;
          |DDEFECTO #dsz99984;
          #dsz99984#17 = #agifa134#49;
          #dsz99984#0 = #agifa134#0;
          #dsz99984#1 = #agifa133#1;           || Linea;
          #dsz99984#2 = #agifa134#2;           || cliente
          #dsz99984#3 = #agifa134#3;           || nombre del cliente
          #dsz99984#4 = #agifa134#9;           || Banco
          #dsz99984#5 = "S";                   || domiciliado
          #dsz99984#6 = "N";                   || aceptado
          #dsz99984#7 = #agifa134#1;           || fecha de emision
          #dsz99984#8 = #agifa133#3;           || Fecha de vencimiento
          #dsz99984#9 = #agifa133#2;           || Importe
          |SI #agifa133#5 = "S";
               #dsz99984#10 = #agis0002#10;
               #dsz99984#11 = #agis0002#11;
          |SINO;
               #dsz99984#10 = "N";            || Impreso
               #dsz99984#11 = "N";            || Contabilizado
          |FINSI;
          |SI #agifa142#63 = "S";     ||  COGE LA CTA.CONTABLE DEL TIPO DE RECIBO.
               #agifa177#0 = #agifa091#69;
               |LEE 000#agifa177.=;
               |SI FSalida = 0;
                    #dsz99984#12 = #agifa177#3;     || NUMERO CTA.CONTABLE.
               |SINO;
                    #dsz99984#12 = #agifa134#12;     || NUMERO CTA.CONTABLE.
               |FINSI;
          |SINO;
               #dsz99984#12 = #agifa134#12;     || NUMERO CTA.CONTABLE.
          |FINSI;
          #dsz99984#13 = #agis0002#13;
          #dsz99984#16 = #agis0002#16;
          #dsz99984#22 = "Cobrado";
          #dsz99984#24 = #agifa134#11;          || Forma de Pago
          #dsz99984#25 = #agifa091#1;           || Descripcion de la forma de Pago
          #dsz99984#14 = "N";            || Impagado
          #dsz99984#15 = #agifa024#161;         || A aceptar
          |SI #agifa133#5 = "S";
               #dsz99984#21 = #agis0002#22;         || Tipo de Recibo (entr.a cta.)
          |SINO;
               #dsz99984#21 = #agifa091#69;          || Tipo de Recibo (forma de pago)
          |FINSI;
          #dsz99984#23 = nVto;
          #dsz99984#24 = #agifa091#0;
          #dsz99984#25 = #agifa091#1;
          eaProg = "agifa134";
          |HAZ RecVenta;
          |LEE 000#agifa133.s;
     |SIGUE;
     |HAZ CierraRecVenta;

     #agifa133#0 = #agifa134#0;
     #agifa133#4 = #agifa134#49;
     #agifa133#1 = 0;
     |LEE 101#agifa133.];
     |PARA ; |SI FSalida = 0; |Y #agifa133#0 = #agifa134#0;|Y #agifa133#4 = #agifa134#49; |HACIENDO;
          #dsz99984#17 = #agifa133#4;
          #dsz99984#0 = #agifa133#0;
          #dsz99984#1 = #agifa133#1;
          eaProg = "agifa134";
          |HAZ LeeRecVenta;
          #agifa134#32 = #agifa134#32 + enAcuenta;
          #agifa133#2 = #agifa133#2 - enAcuenta;
          |GRABA 020#agifa133.a;
          |LIBERA #agifa133;
          |LEE 101#agifa133.s;
     |SIGUE;
     |LIBERA #agifa133;

     |CIERRA #agifa091;
     |CIERRA #dsz99984;
     |CIERRA #agifa133;
     |CIERRA #agis0002;
     |CIERRA #agifa177;
|FPRC;


|PROCESO Parrilla;
     |SI #0#36 = "S";
          |C_M #0#12, 1, "N";
          |C_M #0#13, 1, "N";
          |C_M #0#14, 1, "N";
          |C_M #0#15, 1, "N";
          |PARA i = 16; |SI i [ 35; |HACIENDO i = i + 1;
               |C_M #0i, 1, "S";
          |SIGUE;
     |SINO;
          |C_M #0#12, 1, "S";
          |C_M #0#13, 1, "S";
          |C_M #0#14, 1, "S";
          |C_M #0#15, 1, "S";
          |PARA i = 16; |SI i [ 35; |HACIENDO i = i + 1;
               |C_M #0i, 1, "N";
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO suma_imp;
     nOk = 0;
     |SI #0#36 = "N";
          |SI #3#10 ] #0#12; |Y #3#10 [ #0#14;
                    |Y #3#14 ] #0#13; |Y #3#14 [ #0#15;
               nOk = 1;
          |FINSI;
     |SINO;
          |PARA i = 16; |SI i [ 34; |HACIENDO i = i + 2;
               aAlfa = #0i;
               |QBF aAlfa;
               |SI aAlfa ! "";
                    nCampo = i + 1;
                    |SI #3#10 = #0i; |Y #3#14 = #0nCampo;
                         nOk = 1; |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
     |SI nOk = 0; |ACABA; |FINSI;

     #695#0 = #3#0;
     #695#1 = #3#1;
     #695#2 = #3#11;
     |GRABA 040#695n;

     nOk = 0;
     |SI nSwTallerSC = 0;
          |SI #3#14 ! "S"; nOk = 1; |FINSI;
     |SINO;
          |SI #3#14 = "N"; |O #3#14 = "I"; nOk = 1; |FINSI;
     |FINSI;
     |SI nOk = 0; |ACABA; |FINSI;

     |ABRE #8;
     |ABRE #5;
     |ABRE #9;
||     |SI #3#14 = "N";
          #2#5 = #2#5 + #3#8;      ||importe visual
          |SI #3#11]1;|Y #3#11[999; ||mano de obra
               #2#16 = #2#16 + #3#8;
               #8#0 = #3#2;
               |LEE 000#8=;
               |SI FSalida ! 0;|DDEFECTO #8;|FINSI;
               tipo_iva = #8#5;
          |FINSI;
          |SI #3#11]1000;|Y #3#11[1999; ||piezas
               #2#13 = #2#13 + #3#8;
               #5#0 = #3#2;
               |LEE 000#5=;
               |SI FSalida ! 0;|DDEFECTO #5;|FINSI;
               tipo_iva = #5#30;
          |FINSI;
          |SI #3#11]2000;|Y #3#11[2999; ||S.Exteriores
               #2#15 = #2#15 + #3#8;
               #9#0 = #3#2;
               |LEE 000#9=;
               |SI FSalida ! 0;|DDEFECTO #9;|FINSI;
               tipo_iva = #9#4;
          |FINSI;
          |SI #3#11]3000;|Y #3#11[3999; ||Lubricantes
               #2#14 = #2#14 + #3#8;
               #5#0 = #3#2;
               |LEE 000#5=;
               |SI FSalida ! 0;|DDEFECTO #5;|FINSI;
               tipo_iva = #5#30;
          |FINSI;
          ||En funcion del tipo de iva acumular en base 1 o base 2

          |SI #0#4 = #19#11; |O #0#4 = #19#12; |O #0#4 = #19#13;
               |O #0#4 = #19#17; |O #0#4 = #19#18; |O #0#4 = #19#19;
               |O #0#4 = #19#21; |O #0#4 = #19#22; |O #0#4 = #19#23;
               |O #0#4 = #19#24; |O #0#4 = #19#25; |O #0#4 = #19#26;
               |O #0#4 = #19#27; |O #0#4 = #19#28; |O #0#4 = #19#29;
               |O #0#4 = #19#30; |O #0#4 = #19#31; |O #0#4 = #19#32;
               |O #0#4 = #19#33; |O #0#4 = #19#34; |O #0#4 = #19#35;
                    tipo_iva = 0;
          |FINSI;

          enTiva = tipo_iva;
          efFiva = #0#5;
          |HAZ SacaIVA;

          |SI expor = "S";
               #2#7 = #2#7 + #3#8;
          |SINO;
               |SI tipo_iva = 1;
                    #2#8 = #2#8 + #3#8;
                    #2#9 = tipo_iva;
                    #2#10 = enIva;
               |FINSI;
               |SI tipo_iva = 2;
                    #2#17 = #2#17 + #3#8;
                    #2#18 = tipo_iva;
                    #2#19 = enIva;
               |FINSI;
               |SI tipo_iva = 0;
                    #2#7 = #2#7 + #3#8;
               |FINSI;
          |FINSI;
||     |FINSI;
     |SI expor = "N";
          #2#11 = (#2#8 % #2#10);    ||Cuota IVA
          #2#20 = (#2#17 % #2#19);   ||Cuota IVA 2
     |FINSI;

     |SI #1#7 = "VN";|O #1#7 = "VO";
          #2#12 = #2#12 + #3#8;
     |SINO;
          #2#12 = #2#7 + #2#8 + #2#17 + #2#11 + #2#20;
     |FINSI;

     |SI #3#28 = -1;          ||Linea Canon
          #2#23 = #2#23 + #3#8;
     |FINSI;
     |CIERRA #8;
     |CIERRA #5;
     |CIERRA #9;

|FPRC;

|DEFBUCLE suma;
 #3#1;
 36;
 #1#0,#1#1,0001, 0;
 #1#0,#1#1,9999, 0;
 ;
 NULL,suma_imp;
|FIN;

|PROCESO actua_cliente;
     #7#0 = #6#3;
     |LEE 101#7=;
     |SI FSalida = 0;
          fmes = #6#2 % A402;
          mes = ((fmes - 1) * 4) + 54;
          imneto = #6#6 + #6#7 + #6#23 + #6#31 + #6#34 + #6#37;
          #7mes = #7mes + imneto;
          #7#102 = #7#102 + imneto;
          #7#49 = #7#49 + #2#12;   ||riesgo
          #7#45 = #0#5;
          #7#46 = imneto;
          #7#110 = #7#110 + imneto;
          #7#50 = #7#50 - imneto;
          |GRABA 020#7a;
          |LIBERA #7;
     |FINSI;

     enImpCliCom = imneto;
     enImpCliFac = imneto;
     eaCliente = #1#11;
     efFecha = #6#2;
     |HAZ AcumulaCli;
|FPRC;

|PROCESO muestra;
  |DDEFECTO #2;
  |BUCLE suma;

  lin = lin + 1;
  #2#0 = lin;
  #2#1 = #1#0;
  #2#2 = #1#1;
  #2#3 = #1#3;
  #2#4 = #1#2;
  #2#6 = " ";
  |GRABA 010#2n;
|FPRC;

|PROCESO LinOrd;
     |SI #3#36 = 0;
          aFinal = "N";
     |FINSI;
|FPRC;

|DEFBUCLE LinOrd;
     #3#1;
     ;
     #1#0, #1#1, 0001;
     #1#0, #1#1, 9999;
     ;
     NULL, LinOrd;
|FIN;

|PROCESO FinalFac;
     |SI #644#4 ! "A";
          #1#0 = #644#2;
          #1#1 = #644#3;
          |LEE 121#1=;
          |SI FSalida = 0;
               aFinal = "S";
               |BUCLE LinOrd;
               |SI aFinal = "S";
                    #1#16 = 1;
                    #1#17 = #0#5;
                    |GRABA 010#1a;
               |FINSI;
               |LIBERA #1;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE FinalFac;
     #644#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, FinalFac;
|FIN;

|PROCESO fac_standar;
     |HAZ QuitaIVA;
     |HAZ RedondeoTotales;
     |GRABA 000#6a;
     |LIBERA #6;

     aMoneda = "B"
     aDivisa = "EUR";
     |HAZ Divisas134;

     |DDEFECTO #7;
     #7#0 = #6#3;
     |LEE 000#7=;

     |ABRE #12;
     |DDEFECTO #12;
     #12#0 = #6#1;
     #12#1 = #6#2;
     #12#2 = #6#3;
     #12#3 = #agifa024#1;
     #12#10 = #agifa024#30;
     #12#11 = #agifa024#20;
     #12#12 = #agifa024#16;
     #12#14 = #agifa024#22;
     #12#15 = #agifa024#23;
     #12#16 = #agifa024#24;

     #12#18 = #6#6 + #6#7 + #6#23 + #6#31 + #6#34 + #6#37; ||T.Bruto
     #12#65 = #12#18;
     #12#88 = #12#18;

     #12#21 = #6#7; ||Base1
     #12#68 = #6#7;
     #12#91 = #6#7;

     #12#22 = #6#10;||Cuota1
     #12#69 = #6#10;
     #12#92 = #6#10;

     #12#24 = #6#23;||Base2
     #12#71 = #6#23;
     #12#94 = #6#23;

     #12#25 = #6#26; ||Cuota2
     #12#72 = #6#26;
     #12#95 = #6#26;

     #12#27 = #6#31; ||Base3
     #12#74 = #6#31;
     #12#97 = #6#31;

     #12#28 = #6#32; ||Cuota3
     #12#75 = #6#32;
     #12#98 = #6#32;

     #12#33 = #6#34; ||Base4
     #12#79 = #6#34;
     #12#102 = #6#34;

     #12#34 = #6#35; ||Cuota4
     #12#80 = #6#35;
     #12#103 = #6#35;

     #12#36 = #6#37; ||Base5
     #12#82 = #6#37;
     #12#105 = #6#37;

     #12#37 = #6#38; ||Cuota5
     #12#83 = #6#38;
     #12#106 = #6#38;

     #12#29 = #6#26 + #6#10 + #6#32 + #6#35 + #6#38; ||T.Iva
     #12#76 = #12#29;
     #12#99 = #12#29;

     #12#31 = #6#11; ||T.Fac
     #12#78 = #6#11;
     #12#101 = #6#11;

     #12#39 = #6#9;
     #12#41 = #6#25;
     #12#43 = #6#33;
     #12#50 = #6#36;
     #12#52 = #6#39;
     #12#47 = #6#6;
     #12#49 = #6#0;

     #12#58 = "EUR";
     #12#59 = 1;
     #12#60 = "B";
     #12#61 = "EUR";
     #12#62 = 1;
     #12#45 = "S";
     #12#125 = #6#30;
     |GRABA 020#12c;
     |LIBERA #12;
     |HAZ VenciVta; |HAZ CreaRecibos;
     |CIERRA #12;
     eaTag = "FAC";  |HAZ Riesgos;
|FPRC;

|PROCESO Tmp695;
     #3#0 = #695#0;
     #3#1 = #695#1;
     #3#11 = #695#2;
     |LEE 121#3=;
     |SI FSalida = 0;
          #3#35 = #0#4;
          #3#36 = numf;
          #3#37 = #0#5;
          #3#38 = "F";
          |GRABA 020#3a;
          |LIBERA #3;

          #696#0 = #4#0;
          #696#1 = #4#1;
          #696#2 = #4#2;
          #696#3 = #695#0;
          #696#4 = #695#1;
          #696#5 = #695#2;
          #696#6 = #4#8;
          #696#7 = #4#9;
          |GRABA 020#696n;

          aArti = #3#2;
          nUni = #3#4;
          fFecha = #0#5;
          |SI #3#9 = 2; |O #3#9 = 4;
               |SI #3#14 = "G"; |O #3#14 = "S";
                    nMargen = -#3#17;
                    nImpo = 0;
               |SINO;
                    nMargen = #3#8 - #3#17;
                    nImpo = #3#8;
               |FINSI;
               |HAZ ActuaArti;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE Tmp695;
     #695#1;
     ;
     #2#1, #2#2, 0000;
     #2#1, #2#2, 9999;
     ;
     NULL, Tmp695;
|FIN;

|PROCESO PonIVA;
     |PARA enTiva = 1; |SI enTiva [ 5; |HACIENDO enTiva = enTiva + 1;
          efFiva = #10#1;
          |HAZ SacaIVA;
          |SI enTiva = 1; #6#9 = enIva; |FINSI;
          |SI enTiva = 2; #6#25 = enIva; |FINSI;
          |SI enTiva = 3; #6#33 = enIva; |FINSI;
          |SI enTiva = 4; #6#36 = enIva; |FINSI;
          |SI enTiva = 5; #6#39 = enIva; |FINSI;
     |SIGUE;
|FPRC;

|PROCESO QuitaIVA;
     |SI #6#7 = 0; #6#9 = 0; |FINSI;
     |SI #6#23 = 0; #6#25 = 0; |FINSI;
     |SI #6#31 = 0; #6#33 = 0; |FINSI;
     |SI #6#34 = 0; #6#36 = 0; |FINSI;
     |SI #6#37 = 0; #6#39 = 0; |FINSI;
|FPRC;

|PROCESO crea_linfac;
     |SI #644#4 = "A";
          #6#6 = #6#6 + #10#28;      ||Exe
          #6#7 = #6#7 + #10#16;      ||B1
          #6#23 = #6#23 + #10#19;    ||B2
          #6#31 = #6#31 + #10#22;    ||B3
          #6#34 = #6#34 + #10#44;    ||B4
          #6#37 = #6#37 + #10#47;    ||B5
          #6#10 = #6#10 + #10#17 + #10#18;    ||C1
          #6#26 = #6#26 + #10#20 + #10#21;    ||C2
          #6#32 = #6#32 + #10#23 + #10#54;    ||C3
          #6#35 = #6#35 + #10#45 + #10#46;    ||C4
          #6#38 = #6#38 + #10#48 + #10#49;    ||C5
          #6#11 = #6#6 + #6#7 + #6#23 + #6#31 + #6#34 + #6#37; ||T.Fac
          #6#11 = #6#11 + #6#10 + #6#26 + #6#32 + #6#35 + #6#38; ||T.Fac
          #6#30 = #6#30 + #10#96; ||T.Canon
          |HAZ PonIVA;
          |GRABA 020#6a;

          |DDEFECTO #4;
          #4#0 = #6#0;
          #4#1 = #6#1;
          #4#2 = lfac;
          #4#3 = #10#52;
          #4#4 = ("000000" + #10#0) % -106;
          #4#5 = #10#15;
          #4#6 = #10#24;
          #4#7 = #10#67;
          #4#8 = #6#2;
          #4#9 = #10#1;
          #4#10 = "A";
          |GRABA 020#4n;

           |DDEFECTO #11;
           #11#0 = #6#1;
           #11#1 = lfac;
           #11#2 = #10#0;
           #11#14 = #0#4;
           #11#15 = #10#52;
           |GRABA 020#11n;
           lfac = lfac + 1;
     |SINO;
          |SI expor = "N";       ||NO EXPORTACION
           #6#6 = #6#6 + #2#7;   ||acumulo los totales en la cabecera.
           #6#7 = #6#7 + #2#8;
           |SI #2#9 ! 0;
             #6#8 = #2#9;
             #6#9 = #2#10;
           |FINSI;
           #6#10 = #6#10 + #2#11;
           ||#6#11 = #6#11 + #2#12;
           #6#16 = #6#16 + #2#13;
           #6#17 = #6#17 + #2#14;
           #6#18 = #6#18 + #2#15;
           #6#19 = #6#19 + #2#16;
           #6#23 = #6#23 + #2#17;
           |SI #2#18 ! 0;
              #6#24 = #2#18;
              #6#25 = #2#19;
           |FINSI;
           #6#26 = #6#26 + #2#20;
          |SINO;   ||EXPORTACION
           #6#6 = #6#6 + #2#7 + #2#8 + #2#17;
           #6#7 = 0;
           #6#8 = 0;
           #6#10 = 0;
           ||#6#11 = #6#6;
           #6#16 = #6#16 + #2#13;
           #6#17 = #6#17 + #2#14;
           #6#18 = #6#18 + #2#15;
           #6#19 = #6#19 + #2#16;
           #6#23 = 0;
           #6#26 = 0;
          |FINSI;

           #6#11 = #6#6 + #6#7 + #6#23 + #6#10 + #6#26;
           #6#30 = #6#30 + #2#23;   || Canon
           |GRABA 010#6a;
           |SI lfac > 1;
               |SI #6#5 ! #1#3;
                   #6#5 = "";    || Matri
                   #6#28 = "";   || Marca
                   #6#29 = "";   || Modelo
               |FINSI;
           |FINSI;
           ||Creo la linea
           |DDEFECTO #4;
           #4#0 = #6#0;
           #4#1 = #6#1;
           #4#2 = lfac;
           #4#3 = #1#0;
           #4#4 = #1#1;
           #4#5 = #2#5;
           |SI expor = "N";
              #4#6 = #2#11 + #2#20;
           |FINSI;
           #4#7 = #4#5 + #4#6;
           #4#8 = #6#2;
           #4#9 = #2#4;
           |GRABA 010#4n;
           |LIBERA #4;
           ||Creo la linea en la factura standar
           |DDEFECTO #11;
           #11#0 = #6#1;
           #11#1 = lfac;
           lfac = lfac + 1;
           #11#2 = #1#1;
           #11#14 = #0#4;
           #11#15 = #1#0;
           |GRABA 010#11n;
           |LIBERA #11;

           ||Poner en la O.R. el n§ y serie de la factura
           |ABRE #696;
           |BUCLE Tmp695;
           |CIERRA #696;
     |FINSI;
|FPRC;

|PROCESO cabecera;
    ||Creo la cabecera de la factura para cada cliente
    sw =1;
    |ABRE #6;
    |SI #142#137 = "F";
          |ABRE #13;
          #13#0 = "facturao";
          #13#2 = #0#4;
          |LEE 010#13=;
          |SI FSalida ! 0;
             |DDEFECTO #13;
             #13#0 = "facturao";
             #13#2 = #0#4;
             #13#1 = 1;
             |GRABA 010#13c;
          |FINSI;
          numf = #13#1; ||Numero de factura
          #13#1 = #13#1 + 1;
          |GRABA 010#13a;
    |SINO;
          #6#0 = #0#4;
          #6#1 = 999999;
          |LEE 000#6];
          |SI FSalida = 0;
               |LEE 000#6a;
          |SINO;
               |LEE 000#6u;
          |FINSI;
          |SI FSalida = 0; |Y #6#0 = #0#4;
               numf = #6#1 + 1;
          |SINO;
               numf = 1;
          |FINSI;
    |FINSI;
    |DDEFECTO #6;
    #6#0 = #0#4; ||Serie
    #6#1 = numf;
    #6#2 = #0#5; ||Fecha
    |GRABA 020#6b;

    |SI #644#4 = "A";
          #6#3 = #644#0;
          cliente = #644#0;

          |DDEFECTO #7;
          #7#0 = #6#3;
          |LEE 000#7=;

          #6#20 = #7#20;
          #6#21 = #7#29;
          #6#22 = #7#30;
          #6#4 = #7#1;

          #6#5 = #644#1;    || Matri
          |GRABA 121#6a;
    |SINO;
          #6#3 = #1#11;
          cliente = #1#11;

          |DDEFECTO #7;
          #7#0 = #6#3;
          |LEE 000#7=;

          #6#20 = #7#20;
          #6#21 = #7#29;
          #6#22 = #7#30;
          #6#4 = #7#1;

          #6#5 = #1#3;    || Matri
          #6#28 = #1#30;   || Marca
          #6#29 = #1#20;   || Modelo
          |GRABA 121#6a;
    |FINSI;

    |ABRE #4;
    |ABRE #11;
|FPRC;

|PROCESO Recal10;
     |SI expor = "S";
          #71#11 = 0;
          |HAZ TotalLin71;
     |FINSI;
     |HAZ CalCabAgifa010;
     |GRABA 020#71a;

     fFecha = #0#5;
     aArti = #71#2;
     nUni = #71#5;
     nImpo = ((((#71#5 * #71#6) < #71#8) < #71#33) < #10#5) < #10#32;
     |SI #142#115 = "S";
          nImpo = nImpo < #10#7;
     |FINSI;
     |SI #10#57 = "S";
          nImpo = -nImpo;
          nMargen = nImpo + #71#14;
     |SINO;
          nMargen = nImpo - #71#14;
     |FINSI;
     |HAZ ActuaArti;
|FPRC;

|PROCESO busord;
     |SI #644#4 = "A";
          #10#52 = #644#2;
          #10#0 = #644#3;
          |LEE 121#10=;

          #7#0 = #10#3;
          |LEE 000#7=;

          expor = "N";
          |SI #7#28 = "S"; expor = "S"; |FINSI;

          #23#26 = #0#4;
          |LEE 000#23=;
          |SI #23#30 = "S"; expor = "S"; |FINSI;

          aDivisa = #10#68;
          aMoneda = #10#70;
          |HAZ Divisas010;
          |HAZ LimCabAgifa010;
          |BUCLELIN 0Recal10#10;

          aAgrupa = #7#111;
          |SI aAgrupa = "N"; aMatricula = #644#1; |FINSI;
          |SI cliente ! #10#3; |O aMatricula ! #644#1;
               aMatricula = #644#1;
               |SI sw ! 0;
                    |CIERRA #4;
                    |CIERRA #11;
                    |HAZ fac_standar;
                    |HAZ actua_cliente;
               |FINSI;

               expor = "N";
               |SI #7#28 = "S"; expor = "S"; |FINSI;

               #23#26 = #0#4;
               |LEE 000#23=;
               |SI #23#30 = "S"; expor = "S"; |FINSI;

               |HAZ cabecera;
               lfac = 1;
          |FINSI;

          #10#38 = "S";
          #10#53 = #6#0;
          #10#39 = #6#1;
          #10#60 = #6#2;
          |GRABA 020#10a;
          |LIBERA #10;

          |HAZ crea_linfac;
          |LIBERA #1;
     |SINO;
          #1#0 = #644#2;
          #1#1 = #644#3;
          |LEE 121#1=;

          #7#0 = #1#11;
          |LEE 000#7=;

          expor = "N";
          |SI #7#28 = "S"; expor = "S"; |FINSI;

          #23#26 = #0#4;
          |LEE 000#23=;
          |SI #23#30 = "S"; expor = "S"; |FINSI;

          aAgrupa = #7#111;
          |SI aAgrupa = "N"; aMatricula = #1#3; |FINSI;
          |SI cliente ! #1#11; |O aMatricula ! #1#3;
               aMatricula = #1#3;
               |SI sw ! 0;
                    |CIERRA #4;
                    |CIERRA #11;
                    |HAZ fac_standar;
                    |HAZ actua_cliente;
               |FINSI;

               expor = "N";
               |SI #7#28 = "S"; expor = "S"; |FINSI;

               #23#26 = #0#4;
               |LEE 000#23=;
               |SI #23#30 = "S"; expor = "S"; |FINSI;

               |HAZ cabecera;
               lfac = 1;
          |FINSI;
          |HAZ muestra;
          |HAZ crea_linfac;
          |LIBERA #1;
     |FINSI;
|FPRC;

|DEFBUCLE busord;
     #644#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, busord;
|FIN;

|PROCESO CheqSecLin;
     |DDEFECTO #800;
     #800#5 = #3#0;
     #800#6 = #3#9;
     #800#0 = #3#23;
     |LEE 000#800=;

     |SI nEmpresa = -1; nEmpresa = #800#3; |FINSI;

     |SI nEmpresa ! #800#3;
          |ERROR10;
          nError = 1;
          aAlfa = "0000Error seccion linea OR:" + #3#0 + "/" + #3#1 + "/" + #3#11;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|DEFBUCLE CheqSecLin;
     #3#1;
     ;
     #1#0, #1#1, 0001;
     #1#0, #1#1, 9999;
     ;
     NULL, CheqSecLin;
|FIN;

|PROCESO CheqSeccion;
     #703#0 = #1#0;
     #703#1 = #1#1;
     |LEE 000#703=;
     |SI FSalida ! 0; |DDEFECTO #703; |FINSI;

     |SI #1#0 = #0#6; |O #1#0 = #0#7; |O #1#0 = #0#8; |O #1#0 = #0#9;
                      |O #1#1 = #0#10; |O #1#0 = #0#11;
          #7#0 = #1#11;
          |LEE 000#7=;
          aAgrupa = #7#111;

          |SI aAgrupa = "N"; aMatricula = #1#3; |FINSI;
          |SI cliente ! #1#11; |O aMatricula ! #1#3;
               aMatricula = #1#3;
               |DDEFECTO #800;
               #800#5 = #1#0;
               #800#6 = 0;
               #800#0 = #703#2;
               |LEE 000#800=;
               |SI #1#0 = #19#11; |O #1#0 = #19#12; |O #1#0 = #19#13;
                      |O #1#0 = #19#17; |O #1#0 = #19#18; |O #1#0 = #19#19;
                      |O #1#0 = #19#21; |O #1#0 = #19#22; |O #1#0 = #19#23;
                      |O #1#0 = #19#24; |O #1#0 = #19#25; |O #1#0 = #19#26;
                      |O #1#0 = #19#27; |O #1#0 = #19#28; |O #1#0 = #19#29;
                      |O #1#0 = #19#30; |O #1#0 = #19#31; |O #1#0 = #19#32;
                      |O #1#0 = #19#33; |O #1#0 = #19#34; |O #1#0 = #19#35;
                    nEmpresa = #800#3;
               |SINO;
                    nEmpresa = -1;
               |FINSI;
          |FINSI;
          |SI #1#0 = #19#11; |O #1#0 = #19#12; |O #1#0 = #19#13;
                    |O #1#0 = #19#17; |O #1#0 = #19#18; |O #1#0 = #19#19;
                    |O #1#0 = #19#21; |O #1#0 = #19#22; |O #1#0 = #19#23;
                    |O #1#0 = #19#24; |O #1#0 = #19#25; |O #1#0 = #19#26;
                    |O #1#0 = #19#27; |O #1#0 = #19#28; |O #1#0 = #19#29;
                    |O #1#0 = #19#30; |O #1#0 = #19#31; |O #1#0 = #19#32;
                    |O #1#0 = #19#33; |O #1#0 = #19#34; |O #1#0 = #19#35;
               |DDEFECTO #800;
               #800#5 = #1#0;
               #800#6 = 0;
               #800#0 = #703#2;
               |LEE 000#800=;
          |SINO;
               #800#3 = nEmpresa;
          |FINSI;

          |SI nEmpresa ! #800#3;
               aAlfa = "0000Error seccion OR:" + #1#0 + "/" + #1#1;
               |MENAV aAlfa;
               nError = 1;
          |SINO;
               |BUCLE CheqSecLin;
          |FINSI;
     |FINSI;

     |SI nError = 1; |ERROR10; |FINSI;
|FPRC;

|DEFBUCLE CheqSeccion;
     #1#3;
     16;
     #0#0,#0#2,"                              ",999999;
     #0#1,#0#3,"ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ",999999;
     ;
     NULL, NULL, NULL, NULL, NULL, CheqSeccion;
     #1#11, #1#3;
|FIN;

|PROCESO MiraLin;
     nOk = 0;
     |SI #0#36 = "N";
          |SI #3#10 ] #0#12; |Y #3#10 [ #0#14;
                    |Y #3#14 ] #0#13; |Y #3#14 [ #0#15;
               nOk = 1;
          |FINSI;
     |SINO;
          |PARA i = 16; |SI i [ 34; |HACIENDO i = i + 2;
               aAlfa = #0i;
               |QBF aAlfa;
               |SI aAlfa ! "";
                    nCampo = i + 1;
                    |SI #3#10 = #0i; |Y #3#14 = #0nCampo;
                         nOk = 1; |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
     |SI nOk = 0; |ACABA; |FINSI;

     nGraba = 1;
|FPRC;

|DEFBUCLE MiraLin;
     #3#1;
     36;
     #1#0,#1#1,0001, 0;
     #1#0,#1#1,9999, 0;
     ;
     NULL, MiraLin;
|FIN;

|PROCESO OrValidas;
     |SI #1#0 = #0#6; |O #1#0 = #0#7; |O #1#0 = #0#8; |O #1#0 = #0#9;
                      |O #1#1 = #0#10; |O #1#0 = #0#11;
           nGraba = 0;
           |BUCLE MiraLin;
           |SI nGraba = 1;
               #644#0 = #1#11;
               #644#1 = #1#3;
               #644#2 = #1#0;
               #644#3 = #1#1;
               #644#4 = "O";
               |GRABA 020#644n;
           |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE OrValidas;
     #1#3;
     16;
     #0#0,#0#2,"                              ",999999;
     #0#1,#0#3,"ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ",999999;
     ;
     NULL, OrValidas;
|FIN;

|PROCESO AlbValidos;
     |SI #10#52 ! #0#38; |Y #10#52 ! #0#39; |Y #10#52 ! #0#40;
               |Y #10#52 ! #0#41; |Y #10#52 ! #0#42; |Y #10#52 ! #0#43;
          |ACABA;
     |FINSI;

     #612#0 = #10#52;
     #612#1 = #10#0;
     |LEE 000#612=;
     |SI FSalida ! 0; |DDEFECTO #612; |FINSI;
     |SI #612#3 ! "      "; |ACABA; |FINSI;

     #644#0 = #10#3;
     #644#1 = #612#8;
     #644#2 = #10#52;
     #644#3 = #10#0;
     #644#4 = "A";
     |GRABA 020#644n;
|FPRC;

|DEFBUCLE AlbValidos;
     #10#3;
     38;
     #0#0, #0#2, "     ", 000001, "N";
     #0#1, #0#3, "zzzzz", 999999, "N";
     ;
     NULL, AlbValidos;
|FIN;

|PROCESO Alba; |TIPO 0;
     aAlfa = #0#37;
     |C_M #0#38, 1, aAlfa;
     |C_M #0#39, 1, aAlfa;
     |C_M #0#40, 1, aAlfa;
     |C_M #0#41, 1, aAlfa;
     |C_M #0#42, 1, aAlfa;
     |C_M #0#43, 1, aAlfa;
|FPRC;

|PROCESO tipo33;|TIPO 3;
     |HAZ CreaTempo; |NOME_DAT #2#Tempo#; |DELINDEX #2; aTmp2 = Tempo;
     |HAZ CreaTempo; |NOME_DAT #695#Tempo#; |DELINDEX #695; aTmp695 = Tempo;
     |HAZ CreaTempo; |NOME_DAT #644#Tempo#; |DELINDEX #644; aTmp644 = Tempo;
     |ABRE #644;

     |ABRE #2;
     |ABRE #695;
     |ABRE #7;
     |ABRE #23;

     |ABRE #703;
     |ABRE #800;
     |ABRE #19; |LEE 000#19p; |CIERRA #19;
     |BUCLE CheqSeccion;
     |CIERRA #800;
     |CIERRA #703;
     sw = 0;
     |SI nError = 0;
          |BUCLE OrValidas;
          |ABRE #612;
          |SI #0#37 = "S";
               |BUCLE AlbValidos;
          |FINSI;
          |CIERRA #612;
          |ABRE #3;
          |ABRE #1;
          |ABRE #10;
          |BUCLE busord;
          |CIERRA #10;
          |CIERRA #1;
          |CIERRA #3;
     |SINO;
          |MENAV "0000Secciones incluidas con empresas contables distintas. Revise configuración de secciones";
     |FINSI;
     |CIERRA #23;
     |CIERRA #4;
     |CIERRA #11;
     |SI sw ! 0;
          |HAZ fac_standar;
          |HAZ actua_cliente;
          |ABRE #1;
          |BUCLE FinalFac;
          |CIERRA #1;
     |FINSI;
     |CIERRA #6;
     |CIERRA #7;
     |CIERRA #2;
     |CIERRA #695;

     |CIERRA #644;
     Tempo = aTmp644; |HAZ BoraTempo; |DELINDEX #644;
     Tempo = aTmp2; |HAZ BoraTempo; |DELINDEX #2;
     Tempo = aTmp695; |HAZ BoraTempo; |DELINDEX #695;
|FPRC;

|PROGRAMA;
     |HAZ EsTallerSC;
     nSwTallerSC = FSalida;

     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |HAZ TallerDeci;
     |ABRE #19; |LEE 000#19p; |CIERRA #19;
     |CLS;
     |CABEZA "Facturacion O.R. General";
     |PINPA #0#0; |PINDA #0#0;
     |ENDATOS #1#0;
|FPRO;

|PROCESO RedondeoTotales;
     #con00637#6 = #con00637#6 ! #con00691#9;
     #con00637#7 = #con00637#7 ! #con00691#9;
     #con00637#10 = #con00637#10 ! #con00691#9;
     #con00637#23 = #con00637#23 ! #con00691#9;
     #con00637#26 = #con00637#26 ! #con00691#9;
     #con00637#30 = #con00637#30 ! #con00691#9;
     #con00637#31 = #con00637#31 ! #con00691#9;
     #con00637#32 = #con00637#32 ! #con00691#9;
     #con00637#34 = #con00637#34 ! #con00691#9;
     #con00637#37 = #con00637#37 ! #con00691#9;
     #con00637#35 = #con00637#35 ! #con00691#9;
     #con00637#38 = #con00637#38 ! #con00691#9;

     #con00637#11 = #con00637#6 + #con00637#7 + #con00637#23 + #con00637#31 + #con00637#34 + #con00637#37;
     #con00637#11 = #con00637#11 + #con00637#10 + #con00637#26 + #con00637#32 + #con00637#35 + #con00637#38;
     #con00637#11 = #con00637#11 ! #con00691#9;
|FPRC;
