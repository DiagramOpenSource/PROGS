|FICHEROS;
 albap004 #99; || Cabecera revision.
 agifa010 #0;  || Cabecera Albaran.
 agifa071 #3;  || Lineas Albaran.
 agifa019 #2;  || Articulos.
 agifa024 #4;  || Clientes.
 agifa104 #8;  || Adj. Man. Ped.
 agifa038 #13; || Descripcion ampliada.
 agifa048 #15; || Escandallos
 agifa049 #16; || Lineas de escandallo.
 agifa025 #25;
 dsm00003 #39;
 agifa007 #40; || informes;
 agifa142 #42; || Parametros generales.
 agifa027 #43; || Contadores
 agifa324 #50; || Divisas.
 alba0031 #55; || Mantenimiento De Datos PSION.

 agifa091 #100;
 agis0002 #101;

 dscamrec@ #600;
 dsm00289 #289;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     nPuntoVerde = 0;
     aParam    = "";
     aSer      = "";
     nNum      = 0;
     numero    = "";
     aviso     = "";
     ok        = "";
     &impor    = 0;
     &impal    = 0;
     totalba   = 0;
     imneto    = 0;
     tf        = 0;
     mes       = 0;
     con       = 0;
     margen    = 0;
     indtope   = 0;
     ind       = 0;
     control   = 0;
     mensaje01 = "0423Actualizando linea:";
     mensaje10 = "0000Este albaran contiene lineas provenientes de Pedidos";
     mensaje11 = "0000Este albaran contiene lineas provenientes de Depositos";
     mensaje12 = "0000Este albaran esta FACTURADO";
     mensaje12b= "0000Este abono esta FACTURADO";
     mensajeri = "0000Se supera el Riesgo Limite del cliente";
     mensajei  = "2400NDesea imprimir este albaran? ";
     mensaje   = "0000No puede modificar este campo !";
     informe   = "";
     informe1  = "agifa010";        ||albaran no valorado
     informe2  = "agif1010";        ||albaran valorado
     informe3  = "agif2010";        ||albaran abono
     &iva1     = 0;
     &iva2     = 0;
     &iva3     = 0;
     &iva4     = 0;
     &iva5     = 0;
     &re1      = 0;
     &re2      = 0;
     &re3      = 0;
     &re4      = 0;
     &re5      = 0;
     cant      = 0;
     &codigo   = "";
     &descrip  = "";
     &precio   = 0;
     &dto      = 0;
     &dto1     = 0;
     &unid     = 0;
     &imptot   = 0;
     &tiva     = 0;
     &linea    = 0;
     vacio     = "";
     &supedino = "";
     modificado= 0;
     modo      = 0;
     &avisa_st = "S";
     &n_dec = 0;
     &n_pre = 0;
     &ext1 = "";
     &bl  = "                              ";
     tipo = "valbaran";
     &aMoneda = "";
     &aDivisa = "";

     &eaTag  = "";
     &Tempo  = "";
     &nDeci_Div = 0;
     &aCPath  = "";
     &aCNome  = "";
     nNumRec = 0;
     nHandle = 0;
     nFlag   = 0;
     nSwError = 0;
     aAlfa   = "";
     Comodin = "";
     aMensa  = "";
     aPath   = "";
     aDef00  = "";
     aTempo600 = "";
|FIN;

|CALCULO acttl;
     #3#15 = #0#3;
     #3#16 = #0#34;
     #3#17 = #0#35;
     |GRABA 020#3a;
     |LIBERA #3;
|FCAL;

|CALCULO actpf;
     cant = #99#8 < #0#5;
     cant = cant < #0#32;
     cant = cant < #0#7;

     |ABRE #4;
     #4#0 = #99#4;
     |LEE 101#4=;
     |LIBERA #4;
     |SI 0 = FSalida;
         #4#50 = #4#50 + cant;    || es albaran
         #4#45 = #99#3;
         |GRABA 020#4a;
     |FINSI;
     |LIBERA #4;
     |CIERRA #4;

     enImpCliPen = cant;
     eaCliente = #99#4;
     efFecha = #99#3;
     |HAZ AcumulaCli;
|FCAL;

|CALCULO actal;
     |BUCLELIN 0acttl#0;
     |HAZ actpf;
|FCAL;

|PROCESO para_ger;
     |ABRE #42;
     #42#0 = "A";
     |LEE 001#42=;
     |SI FSalida ! 0; |DDEFECTO #42; |FINSI;
     |LIBERA #42;
     |CIERRA #42;
     avisa_st = #42#5;
     n_dec = #42#8;
     n_pre = #42#9;
|FPRC;

|PROCESO RecalCab;
     nPuntoVerde = #3#62;
     |HAZ TotalLin71;    || Recalcula el punto verde!!!
     #3#62 = nPuntoVerde;

     |HAZ CalCabAgifa010;
     |GRABA 020#3a;
     |LIBERA #3;
|FPRC;

|DEFBUCLE RecalCab;
     #3#1;
     ;
     #0#52, #0#0, 001;
     #0#52, #0#0, 999;
     be;
     NULL, RecalCab;
|FIN;

|PROCESO cabalb;
     |ABRE #4;
     #4#0 = #99#4;
     |LEE 000#4=;        || lee el cliente
     |CIERRA #4;

     |ABRE #50;
     #50#0 = #4#192;
     |LEE 000#50=;
     |CIERRA #50;

     |DDEFECTO #0;
     numero = "000000" + #99#1;
     numero = numero % -106;
     #0#0 = numero;       || Numero.
     #0#52 = #99#2;      || Serie.
     |LEE 101#0=;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;

     #0#1 = #99#3;      || Fecha.
     #0#3 = #99#4;      || Cliente.
     #0#4 = #4#2;        || Nombre cliente
     #0#6 = #4#25;      || Representante
     #0#8 = #4#20;       || Forma Pago
     #0#84 = 1;

     |ABRE #39;
     #39#0 = #0#3;
     #39#1 = #0#84;
     |LEE 000#39=;
     |SI FSalida = 0;
          #0#29 = #39#10;
          #0#30 = #39#2;
          #0#31 = #39#3;
          #0#33 = #39#7;
          #0#62 = #39#6;
     |SINO;
          #0#29 = #4#2;
          #0#30 = #4#5;
          #0#31 = #4#6;
          #0#33 = #4#7;
          #0#62 = #4#180;
     |FINSI;
     |CIERRA #39;
 ||    #0#32 = #99#13;     || Dto.Acumulado

     |ABRE #25;
     #25#0 = #0#6;
     |LEE 000#25=;
     |SI FSalida = 0;
          #0#34 = #25#7;
     |FINSI;
     |CIERRA #25;
     #0#35 = #4#4;       || tipo cliente
     #0#36 = #4#47;      || r.e.
     #0#40 = #4#41;      || facturar a fin de mes
     #0#50 = #4#40;      || alb. valorado
     #0#52 = #99#2;      || serie albaran
     #0#61 = #99#7;
     #0#62 = #4#180;
     #0#63 = #4#15;
     #0#68 = aDivisa;
     #0#69 = 1;
     #0#70 = aMoneda;
     #0#73 = aDivisa;
     #0#74 = 1;
     #0#94 = #99#11;     ||punto verde

     |ABRE #3;
     |HAZ AlbaLinAutoAlta;
     |CIERRA #3;

     |HAZ LimCabAgifa010;
     |BUCLE RecalCab;
     |GRABA 020#0a;
     |LIBERA #0;

     |ABRE #43;
     #43#2 = #0#52;
     #43#0 = tipo;
     |LEE 101#43=;
     |SI FSalida ! 0;
         #43#1 = #0#0 + 1;
         |GRABA 040#43n;
     |SINO;
         #43#1 = #0#0 + 1;
         |GRABA 040#43a;
     |FINSI;
     |LIBERA #43;
     |CIERRA #43;

     |HAZ actal;

     eaSerie = #0#52;
     enCodigo = #0#0;
     |HAZ AlbaRecAlb;


     || -------- Generacion Recibos Adelantados -----------
     |ABRE #55;
     |LEE 000#55u;
     |LIBERA #55;
     |CIERRA #55;

     |SI #99#6 ! "N";
        |ABRE #agifa091; |ABRE #agis0002;

        #agifa091#0 = #agifa024#20;
        |LEE 000#agifa091.=;
        |SI FSalida ! 0; |DDEFECTO #agifa091; |FINSI;

        nNumRec = 1; aAlfa = #99#2; |QBF aAlfa; aAlfa = (aAlfa + "     ") % 0105;
        #agis0002#30 = "A";
        numero = "000000" + #99#1; numero = numero % -106;
        #agis0002#20 = aAlfa;
        #agis0002#17 = #99#1;
        #agis0002#18 = 1;
        |LEE 000#agis0002.];
        |PARA; |SI FSalida = 0; |Y #agis0002#20 = aAlfa; |Y #agis0002#30 = "A"; |Y #agis0002#17 = #99#1; |HACIENDO;
           nNumRec = #agis0002#18 + 1;
           |LEE 000#agis0002.s;
        |SIGUE;
        |DDEFECTO #agis0002;
        #agis0002#30 = "A";
        #agis0002#20 = aAlfa;
        #agis0002#17 = numero;
        #agis0002#18 = nNumRec;
        |GRABA 020#agis0002.b;
        #agis0002#0  = numero;
        #agis0002#1  = nNumRec;
        #agis0002#2  = #99#4;
        #agis0002#3  = #4#1;
        #agis0002#4  = #4#29;
        #agis0002#5  = "N";
        #agis0002#6  = "N";
        #agis0002#7  = #99#3;
        #agis0002#8  = #99#3;
        #agis0002#9  = #99#7;
        #agis0002#10 = "N";
        #agis0002#11 = "N";
        #agis0002#12 = #4#16;
        #agis0002#14 = "N";
        #agis0002#15 = "N";
        #agis0002#16 = "01.01.0000";
        #agis0002#19 = #99#2;
        #agis0002#22 = #agifa091#69;
        #agis0002#23 = 0;
        #agis0002#24 = #agifa024#20;
        #agis0002#25 = 0;
        #agis0002#26 = 0;
        #agis0002#27 = 0;
        #agis0002#28 = eaCuenta;
        |GRABA 020#agis0002.a; |LIBERA #agis0002;

        |CIERRA #agifa091; |CIERRA #agis0002;

        |DBASS aAlfa;
        aAlfa = aAlfa + "dscarter/fich/dscam000.dat";
        |XABRE "E", aAlfa, nHandle;
        |SI FSalida = 0;
           |DBASS aPath;
           aPath = aPath + "dscarter/";
           aDef00 = aPath + "def/dscamrec";

           |CARGA_DEF aDef00, dscamrec@;
           |SI FSalida ! 0;
              aMensa = "0000Error al cargar:" + aDef00;
              |MENAV aMensa;
              aDef00 = "";
           |SINO;
              |HAZ CreaTempo; aTempo600 = Tempo;
              |PATH_DAT #600 aPath; |NOME_DAT #600 aTempo600; |DELINDEX #600;
              |ABRE #600;
              aCPath = aPath; aCNome = aTempo600;
           |FINSI;

           |DFICE Comodin;
           Comodin = Comodin % -106;
           Comodin = Comodin % 0105;

           nDeci_Div = 2;

           |DDEFECTO #dscamrec@;
           #600#1  = #agis0002#20;||Serie
           #600#2  = #agis0002#17;||Fact
           #600#3  = #agis0002#18;||N§ Rec
           #600#4  = #agis0002#8; ||F.V
           #600#5  = #agis0002#7; ||F.E
           #600#6  = #agis0002#12;||Cuenta Cli
           #600#7  = #agis0002#3; ||Nom Cli
           #600#8  = #agis0002#4; ||Nom Banco
           #600#9  = #agifa024#32;      ||Entidad
           #600#10 = #agifa024#33;      ||Sucursal
           #600#11 = #agifa024#31;      ||DC
           #600#12 = #agifa024#30;      ||Cuenta
           #600#13 = #agis0002#22;||Tipo Rec
           #600#15 = #agis0002#9; ||Importe
           #600#16 = #agis0002#15;||A aceptar
           #600#17 = #agis0002#6; ||Aceptado
           #600#18 = #agis0002#2; ||Cliente
           #600#21 = #agifa024#3; ||Zona
           #600#22 = 1;           ||Documento
           #600#25 = Comodin;     ||Empresa ges
           #600#27 = "V";         ||Tipo
           #600#28 = "A";         ||Ope
           #600#29 = "EUR";
           #600#30 = "EURO";           ||Nombre
           #600#31 = 1;                ||Cambio Divisa
           #600#32 = 1;                ||Cambio Base
           #600#33 = #agifa024#203;
           #600#34 = 0;
           #600#35 = "A";
           #600#36 = #agis0002#28;
           #600#38 = #agis0002#16;
           #600#39 = #agis0002#10;
           aAlfa = "|NC"; aAlfa = #600#aAlfa#;
           |SI aAlfa > 48;
                #600#48 = #agifa024#215;
                #600#49 = #agifa024#216;
           |FINSI;
           |SI aAlfa > 50;
                #600#50 = #agifa024#217;
                |ABRE #289;
                #289#0 = #agifa024#0;
                |LEE 000#289=;
                |SI FSalida ! 0; |DDEFECTO #289; |FINSI;
                |CIERRA #289;
                #600#51 = #289#1;
           |FINSI;

           |GRABA 020#600n;

           |SUB_EJECUTA_NP ":dscarter/dsrecibo";

           #600#22 = 1;           ||Documento
           |LEE 000#600=;
           |SI FSalida ! 0; |O #600#37 = "ERROR               ";
              nSwError = 1;
              |MENAV "    La entrega tiene movimientos. Proceso abortado";
              |SI aDef00 ! "";
                 |CIERRA #600; |DELINDEX #600; |DESCARGA_DEF #dscamrec@;
              |FINSI;
              |ERROR; |ACABA;
           |FINSI;

           |SI aDef00 ! "";
              |CIERRA #600; |DELINDEX #600; |DESCARGA_DEF #dscamrec@;
           |FINSI;

           eaTag = "RAA"; |HAZ Riesgos;
        |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE leecab;
     #99#1;
     ;
     "A","     ",000000;
     "A","zzzzz",999999;
     be;
     NULL,cabalb;
|FIN;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROGRAMA;
     |HAZ para_ger;

     aMoneda = "B";
     aDivisa = "EUR";
     |HAZ Divisas010;

     modo = 1;
     |ABRE #0;
     |BUCLE leecab;
     |CIERRA #0;
|FPRO;
