|FICHEROS;
     pcegm002 #2;
     pcegm003 #3;
     pcegm004 #4;
     pcegm005 #5;
     pcegw009 #9;
     pcegm042 #42; || Reparaciones
     pcegz055 #55; ||Tmp relacion
     pcegz056 #56; ||Tmp relacion
     agifa071 #71;
     agifa080 #80;
|FIN;

|VARIABLES;
     &Tempo = "";
     &eaFichero = "";
     &enSwAdj = 0;
     &enSwRep = 0;
     &eaArticulo = "";
     &enUnidades = 0;
     &eaCliente = "";
     aCli = "";
     nSwContinua = 0;
     aEmp = "";
     aFich = "";
     aFichero = "";
     aAuto = "";
     nHandle = 0;
     aBase = "";
     aAlfa = "";
     aProg = "";
     aDef = "";
     aMas = "";
     aPrograma = "";
     aParametro = "";
     aCliente = "";
     aAlbaran = "";
     aFactura = "";
     aFecha = "";
     aFicTmp = "";

     &serie = "";
     &numero = 0;
     &reimpr = "";
     &eaTipoImp = "";
     &ser_fac = "";
     &num_fac = 0;
     &reimp = "";
     &eaOrdenado = "";
     &SPedido = "";
     &NPedido = 0;
     &BAdela  = 0;
     &eaSerie = "";
     &enPedido = 0;
     &enLinea = 0;
     &efFecha = @;
     &enAlba = 0;
     &eaImprime = "";
     &enOferta = 0;
     &ser_ped = "";
     &num_ped = 0;
     &eaImpresora = "";
     &enDocu = 0;
     &eaTipo = "";
     aTmp55 = "";
     aTmp56 = "";
     aDir = "";
     aTxt = "";
     nHay = 0;
     nError = 0;
     aDCli = "";
     aHCli = "";
     nDDir = 0;
     nHDir = 0;
     nRese = 0;
     nPendiente = 0;
     nSwRese = 0;
|FIN;

|PROCESO MiraRese;
     nPendiente = #5#5 - #5#43;
     nRese = nPendiente - #5#60;
     |SI nRese ! 0;
          nSwRese = 1;
          aAlfa = "0000Faltan unidades por reservar:"+&13+"Rep:"+#42#0+"/"+(("000000"+#42#1)%-106)+&13+"Ped:"+#2#60+"/"+(("000000"+#2#61)%-106);
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO ReciCalibra;
     nHay = 1;
|FPRC;

|DEFBUCLE ReciCalibra;
     #80#4;
     ;
     "     ", 000001, #3#2;
     "zzzzz", 999999, #3#2;
     ;
     NULL, ReciCalibra;
|FIN;

|PROCESO BusCalibraOfe;
     aAlfa = #3#2;
     aAlfa = aAlfa - "CAL";
     |SI FSalida > 0;
          nHay = 0;
          |BUCLE ReciCalibra;
          |SI nHay = 0;
               aAlfa = "0000No ha llegado el material:"+&13+"Rep:"+#42#0+"/"+(("000000"+#42#1)%-106)+&13+"Ped:"+#2#60+"/"+(("000000"+#2#61)%-106);
               |MENAV aAlfa;
               |ERROR10;
               nError = 1;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE BusCalibraOfe;
     #3#1;
     ;
     #42#15, #42#16, 001;
     #42#15, #42#16, 999;
     ;
     NULL, BusCalibraOfe;
|FIN;

|PROCESO Reparacion;
     #2#48 = #42#15;
     #2#0 = #42#16;
     |LEE 020#2=;
     |SI FSalida = 0;
          nError = 0;
          ||BUCLE BusCalibraOfe;
          |SI nError = 0;
               #4#25 = #2#60;
               #4#0 = #2#61;
               |LEE 020#4=;
               |SI FSalida = 0;
                    nSwRese = 0;
                    |BUCLELIN 2 MiraRese #4;
                    |SI nSwRese = 0;
                         eaSerie = #4#25;
                         enPedido = #4#0;
                         efFecha = #4#66;
                         |SUB_EJECUTA_NP aPrograma;

                         #42#17 = ~;
                         #42#18 = Usuario % 810;
                         #42#19 = aTxt;
                         #42#22 = "C";
                         |GRABA 020#42a;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |LIBERA #42;
|FPRC;

|DEFBUCLE Reparacion;
     #42#2;
     ;
     "F", aDCli, nDDir, "     ", 000001;
     "F", aHCli, nHDir, "zzzzz", 999999;
     be;
     NULL, Reparacion;
|FIN;

|PROCESO CierraRepTodo;
     aCli = aParametro % 106;
     aDir = aParametro % 705;
     aTxt = aParametro % 2560;
     |SI aCli = "000000";
          aDCli = "      ";
          aHCli = "zzzzzz";
     |SINO;
          aDCli = aCli;
          aHCli = aCli;
     |FINSI;
     |SI aDir = 0;
          nDDir = 0;
          nHDir = 9999;
     |SINO;
          nDDir = aDir;
          nHDir = aDir;
     |FINSI;

     |ABRE #2;
     |ABRE #4;
     |BUCLE Reparacion;
     |CIERRA #4;
     |CIERRA #2;
|FPRC;

|PROCESO Ejecuta;
     |DDEF aDef;
     aMas = aDef + (aProg % 108) + ".mas";
     |XABRE "E", aMas, 0;
     |SI FSalida = 0;
          aPrograma = aProg % 108;
          aParametro = aProg - aPrograma;
          |SI aPrograma = "pcegz002"; ||Emision ofertas
               aAlfa = aParametro % 0105; serie = aAlfa;
               aAlfa = aParametro % 0606; numero = aAlfa;
               aAlfa = aParametro % 1201; reimpr = aAlfa;
               aAlfa = aParametro % 1301; eaTipoImp = aAlfa;
               |SUB_EJECUTA_NP aPrograma;
               FSalida = 0; |ACABA;
          |FINSI;
          |SI aPrograma = "pcegz003";
               aAlfa = aParametro % 0105; ser_ped = aAlfa;
               aAlfa = aParametro % 0606; num_ped = aAlfa;
             ||  aAlfa = aParametro % 1201; reimpr = aAlfa;
               aAlfa = aParametro % 1301; eaTipoImp = aAlfa;
               eaImpresora = "CrystalReport";
               |SUB_EJECUTA_NP aPrograma;
               FSalida = 0; |ACABA;
          |FINSI;
          |SI aPrograma = "agifa136";
               aAlfa = aParametro % 0105; ser_fac = aAlfa;
               aAlfa = aParametro % 0606; num_fac = aAlfa;
               aAlfa = aParametro % 1201; reimp = aAlfa;
               aAlfa = aParametro % 1301; eaOrdenado = aAlfa;
               eaImprime = "CrystalReport";
               |SUB_EJECUTA_NP aPrograma;
               FSalida = 0; |ACABA;
          |FINSI;
          |SI aPrograma = "pcegm013"
               aAlfa = aParametro % 0105; SPedido = aAlfa;
               aAlfa = aParametro % 0606; NPedido = aAlfa;
               BAdela = 0;
               |SUB_EJECUTA_NP aPrograma;
               FSalida = 0; |ACABA;
          |FINSI;
          |SI aPrograma = "pcegz016";
               aAlfa = aParametro %  120; eaArticulo = aAlfa;
               aAlfa = aParametro % 2116; enUnidades = aAlfa;
               aAlfa = aParametro % 3705; eaSerie = aAlfa;
               aAlfa = aParametro % 4206; enPedido = aAlfa;
               aAlfa = aParametro % 4803; enLinea = aAlfa;
               |SUB_EJECUTA_NP aPrograma;
               FSalida = 0; |ACABA;
          |FINSI;
          |SI aPrograma = "pcegz018";
               aAlfa = aParametro % 0105; eaSerie = aAlfa;
               aAlfa = aParametro % 0606; enPedido = aAlfa;
               aAlfa = aParametro % 1210; efFecha = aAlfa;
               aAlfa = aParametro % 2203;
               enSwAdj = 0;
               enSwRep = 0;
               |SI aAlfa = "TOD";
                    enSwRep = 1;
                    |HAZ CierraRepTodo;
               |SINO;
                    |SI aAlfa = "ADJ"; enSwAdj = 1; |FINSI;
                    |SI aAlfa = "REP"; enSwRep = 1; |FINSI;
                    |SUB_EJECUTA_NP aPrograma;
               |FINSI;
               FSalida = 0; |ACABA;
          |FINSI;
          |SI aPrograma = "pcegz022";
               aAlfa = aPrograma + ";" + aParametro;
               |SUB_EJECUTA_NP aAlfa;
               FSalida = 0; |ACABA;
          |FINSI;
          |SI aPrograma = "pcegz024"; |O aPrograma = "pcegz026"
               aAlfa = aParametro % 0105; eaSerie = aAlfa;
               aAlfa = aParametro % 0606; enPedido = aAlfa;
               |SUB_EJECUTA_NP aPrograma;
               FSalida = 0; |ACABA;
          |FINSI;
          |SI aPrograma = "pcegz027";
               aAlfa = aParametro % 0105; eaSerie = aAlfa;
               aAlfa = aParametro % 0606; enAlba = aAlfa;
               |SUB_EJECUTA_NP aPrograma;
               FSalida = 0; |ACABA;
          |FINSI;
          |SI aPrograma = "pcegz019";
               aAlfa = aParametro % 0105; eaSerie = aAlfa;
               aAlfa = aParametro % 0606; enDocu = aAlfa;
               eaTipo = "AV";
               |HAZ EsReparacion;
               |SUB_EJECUTA_NP aPrograma;
               FSalida = 0; |ACABA;
          |FINSI;

          aAlfa = aPrograma + ";" + aParametro + aCliente;
          |SUB_EJECUTA_NP aAlfa;
          FSalida = 0;
     |FINSI;
|FPRC;

|PROCESO LeeTxt;
     aAuto = "";
     |XABRE "", aFichero, nHandle;

     |XLEE nHandle, 250, aEmp;
     |XLEE nHandle, 250, aAuto;
     |XLEE nHandle, 250, aProg;
     |XLEE nHandle, 250, aCliente;

     |XCIERRA nHandle;
|FPRC;

|PROCESO CreaTxt;
     |DFICE aFich;
     aEmp = aFich % -205;

     |DBASE aBase;
     aFichero = aBase + "fich/" + (Usuario % 810);

     |XABRE "E", aFichero, 0;
     |SI FSalida = 0;
          |AVISO;
          |MENAV "0000Este proceso solo puede ejecutarse una tarea por usuario";
          aAlfa = "0000NYa existe una tarea con el usuario [" + (Usuario % 810) + "]. ¿Continuar?"
          |CONFI aAlfa;
          nSwContinua = FSalida;
          |SI FSalida ! 0;
               |ACABA;
          |FINSI;
     |FINSI;

     |XABRE "W", aFichero, nHandle;

     |XGRABA nHandle, aEmp;
     |XGRABA nHandle, aAuto;

     |SI eaCliente ! "";
          |XGRABA nHandle, "";     ||programa
          aCli = eaCliente + "0000";
          |XGRABA nHandle, aCli;    ||cliente
          |XGRABA nHandle, "1";    ||pesta¤a
          |XGRABA nHandle, "1";    ||boton
     |FINSI;

     |XCIERRA nHandle;
|FPRC;
----------------------------------------------------------
|PROCESO EsReparacion; ||-----------Comprueba si es de reparacion
     |ABRE #42;
     |SELECT #6#42;
     #42#25 = eaSerie;   || si esta cerrada con facturar '0'
     #42#26 = enDocu;
     |LEE 000#42=;
     |SI FSalida = 0;
          eaTipo = "RE";
          eaSerie = #42#0;
          enDocu = #42#1;
     |FINSI;
     |CIERRA #42;

     |ABRE #71;
     #71#29 = eaSerie;
     #71#0 = enDocu;
     #71#1 = 1;
     |LEE 000#71];
     |SI #71#29 = eaSerie; |Y #71#0 = enDocu;
          |ABRE #4;
          #4#25 = #71#31;
          #4#0 = #71#12;
          |LEE 000#4=;
          |SI FSalida = 0; |Y #4#96 ! 0;
               eaSerie = #4#95;
               enDocu = #4#96;
               eaTipo = "RE";
          |FINSI;
          |CIERRA #4;
     |FINSI;
     |CIERRA #71;
|FPRC;

|PROCESO EjecutaC;
     aProg = aPrograma % 108;
     |SI aProg = "pcegz019";
          aParametro = aPrograma - aProg;
          aAlfa = aParametro % 105; eaSerie = aAlfa;
          aAlfa = aParametro % 606; enDocu = aAlfa;
          eaTipo = "AV";
          |HAZ EsReparacion;
          |SUB_EJECUTA aProg;
     |SINO;
          aParametro = aPrograma - aProg;
          aAlfa = aProg + ";" + aParametro;
          |SUB_EJECUTA aAlfa;
     |FINSI;
|FPRC;

|PROCESO LeeTxtC;
     aAuto = "";
     |XABRE "", aFichero, nHandle;

     |XLEE nHandle, 250, aEmp;
     |XLEE nHandle, 250, aAuto;
     |XLEE nHandle, 250, aPrograma;

     |XCIERRA nHandle;
|FPRC;

|PROCESO CreaTxtC;
     |DFICE aFich;
     aEmp = aFich % -205;

     |DBASE aBase;
     aFichero = aBase + "fich/" + "C" + (Usuario % 810);

     |XABRE "E", aFichero, 0;
     |SI FSalida = 0;
          |AVISO;
          |MENAV "0000Este proceso solo puede ejecutarse una tarea por usuario";
          aAlfa = "0000NYa existe una tarea con el usuario [" + (Usuario % 810) + "]. ¿Continuar?"
          |CONFI aAlfa;
          nSwContinua = FSalida;
          |SI FSalida ! 0;
               |ACABA;
          |FINSI;
     |FINSI;
     |XABRE "W", aFichero, nHandle;
     |XGRABA nHandle, aEmp;
     |XCIERRA nHandle;
|FPRC;

|PROCESO Confirma;
     |HAZ CreaTxtC;
     |SI nSwContinua ! 0; |ACABA; |FINSI;

     |PARA; |SI; |HACIENDO;
          aAlfa = "|:dscomer9/pcegz020 agif0041 " + #48#0;
          |SUB_EJECUTA_NP aAlfa;
          |HAZ LeeTxtC;
          |SI aAuto = ""; |SAL; |FINSI;
          |HAZ EjecutaC;
     |SIGUE;
     |FBORRA aFichero;
|FPRC;
----------------------------------------------------------
|PROCESO CreaTxtR;
     |DFICE aFich;
     aEmp = aFich % -205;

     |DBASE aBase;
     aFichero = aBase + "fich/" + "R" + (Usuario % 810);

     |XABRE "E", aFichero, 0;
     |SI FSalida = 0;
          |AVISO;
          |MENAV "0000Este proceso solo puede ejecutarse una tarea por usuario";
          aAlfa = "0000NYa existe una tarea con el usuario [" + (Usuario % 810) + "]. ¿Continuar?"
          |CONFI aAlfa;
          nSwContinua = FSalida;
          |SI FSalida ! 0;
               |ACABA;
          |FINSI;
     |FINSI;
     |HAZ CreaTempo; |NOME_DAT #55 Tempo; aTmp55 = Tempo; |DELINDEX #55;
     |XABRE "W", aFichero, nHandle;
     |XGRABA nHandle, aEmp;
     |XGRABA nHandle, aTmp55;
     |XCIERRA nHandle;
|FPRC;

|PROCESO Relacion;
     |HAZ CreaTxtR;
     |SI nSwContinua ! 0; |ACABA; |FINSI;

     aAlfa = "|:dscomer9/pcegz055 agif0041 " + #48#0;
     |SUB_EJECUTA_NP aAlfa;

     aAlfa = "pcegz047;" + aTmp55;
     |SUB_EJECUTA_NP aAlfa;

     |FBORRA aFichero;

     Tempo = aTmp55; |HAZ BoraTempo; |DELINDEX #55;
|FPRC;
----------------------------------------------------------
|PROCESO CreaTxtR43;
     |DFICE aFich;
     aEmp = aFich % -205;

     |DBASE aBase;
     aFichero = aBase + "fich/" + "R43" + (Usuario % 810);

     |XABRE "E", aFichero, 0;
     |SI FSalida = 0;
          |AVISO;
          |MENAV "0000Este proceso solo puede ejecutarse una tarea por usuario";
          aAlfa = "0000NYa existe una tarea con el usuario [" + (Usuario % 810) + "]. ¿Continuar?"
          |CONFI aAlfa;
          nSwContinua = FSalida;
          |SI FSalida ! 0;
               |ACABA;
          |FINSI;
     |FINSI;
     |HAZ CreaTempo; |NOME_DAT #56 Tempo; aTmp56 = Tempo; |DELINDEX #56;
     |XABRE "W", aFichero, nHandle;
     |XGRABA nHandle, aEmp;
     |XGRABA nHandle, aTmp56;
     |XCIERRA nHandle;
|FPRC;

|PROCESO Relacion43;
     |HAZ CreaTxtR43;
     |SI nSwContinua ! 0; |ACABA; |FINSI;

     aAlfa = "|:dscomer9/pcegz056 agif0041 " + #48#0;
     |SUB_EJECUTA_NP aAlfa;

     aAlfa = "pcegz050;" + aTmp56;
     |SUB_EJECUTA_NP aAlfa;

     |FBORRA aFichero;

     Tempo = aTmp56; |HAZ BoraTempo; |DELINDEX #56;
|FPRC;
----------------------------------------------------------
|PROCESO EjecutaA;
     aPrograma = aProg % 108;
     aParametro = aProg - aPrograma;
     |SI aPrograma = "pcegz016";
          aAlfa = aParametro %  120; eaArticulo = aAlfa;
          aAlfa = aParametro % 2116; enUnidades = aAlfa;
          aAlfa = aParametro % 3705; eaSerie = aAlfa;
          aAlfa = aParametro % 4206; enPedido = aAlfa;
          aAlfa = aParametro % 4803; enLinea = aAlfa;
          |SUB_EJECUTA_NP aPrograma;
     |FINSI;
     |SI aPrograma = "pcegz008";
          aAlfa = aPrograma + ";" + aParametro;
          |SUB_EJECUTA_NP aAlfa;
     |FINSI;
|FPRC;

|PROCESO LeeTxtA;
     aAuto = "";
     |XABRE "", aFichero, nHandle;

     |XLEE nHandle, 250, aEmp;
     |XLEE nHandle, 250, eaArticulo;
     |XLEE nHandle, 250, aAuto;
     |XLEE nHandle, 250, aAlfa;
     |XLEE nHandle, 250, aProg;
     |XLEE nHandle, 250, aFicTmp;

     |XCIERRA nHandle;
|FPRC;

|PROCESO CreaTxtA;
     |DFICE aFich;
     aEmp = aFich % -205;

     |DBASE aBase;
     aFichero = aBase + "fich/" + "A" + (Usuario % 810);

     |XABRE "E", aFichero, 0;
     |SI FSalida = 0;
          |AVISO;
          |MENAV "0000Este proceso solo puede ejecutarse una tarea por usuario";
          aAlfa = "0000NYa existe una tarea con el usuario [" + (Usuario % 810) + "]. ¿Continuar?"
          |CONFI aAlfa;
          nSwContinua = FSalida;
          |SI FSalida ! 0;
               |ACABA;
          |FINSI;
     |FINSI;
     |XABRE "W", aFichero, nHandle;
     |XGRABA nHandle, aEmp;
     |XGRABA nHandle, eaArticulo;
     |XGRABA nHandle, "";
     |XCIERRA nHandle;
|FPRC;

|PROCESO VerPedido;
     |HAZ CreaTxtA;
     |SI nSwContinua ! 0; |ACABA; |FINSI;

     |PARA; |SI; |HACIENDO;
          aAlfa = "|:dscomer9/pcegz029 agif0041 " + #48#0;
          |SUB_EJECUTA_NP aAlfa;
          |HAZ LeeTxtA;
          |SI aAuto = ""; |SAL; |FINSI;
          |HAZ EjecutaA;
     |SIGUE;
     |FBORRA aFichero;

     |NOME_DAT #9 aFicTmp;
     |ABRE #9;
     |LEE 000#9p;
     |SI FSalida = 0;
          |CONFI "0000SRealizar el servicio de mercancia de los pedidos reservados?";
          |SI FSalida = 0;
               enSwAdj = 1;
               eaFichero = aFicTmp;
               |SUB_EJECUTA_NP "pcegz018";
          |FINSI;
     |FINSI;
     |CIERRA #9;
     |DELINDEX #9; Tempo = aFicTmp; |HAZ BoraTempo;
|FPRC;
----------------------------------------------------------
|PROCESO Accesorio;
     |HAZ CreaTxtA;
     |SI nSwContinua ! 0; |ACABA; |FINSI;

     |PARA; |SI; |HACIENDO;
          aAlfa = "|:dscomer9/pcegz030 agif0041 " + #48#0;
          |SUB_EJECUTA_NP aAlfa;
          |HAZ LeeTxtA;
          |SI aAuto = ""; |SAL; |FINSI;
          |HAZ EjecutaA;
     |SIGUE;
     |FBORRA aFichero;
|FPRC;
----------------------------------------------------------
|PROGRAMA;
     |SI PARAMETRO = "PEDIDO";     || desde agifa019
          |HAZ VerPedido; |ACABA;
     |FINSI;
     |SI PARAMETRO = "ACCESORIO";  || desde agifa019
          |HAZ Accesorio; |ACABA;
     |FINSI;

     ||..............opcion del menu: Confirmacion de envios
     |SI PARAMETRO = "CONFIRMA";
          |HAZ Confirma; |ACABA;
     |FINSI;

     ||..............opcion del menu: Relacion cobros y pedidos
     |SI PARAMETRO = "RELACION";
          |HAZ Relacion; |ACABA;
     |FINSI;
     ||..............opcion del menu: Relacion cobros y pedidos Norma43
     |SI PARAMETRO = "RELACION43";
          |HAZ Relacion43; |ACABA;
     |FINSI;

     ||....................opcion del menu: Ver Datos
     |SI eaCliente ! "";
          aAuto = "1";
     |FINSI;

     |HAZ CreaTxt;
     |SI nSwContinua ! 0; |ACABA; |FINSI;

     |PARA; |SI; |HACIENDO;
          aAlfa = "|:dscomer9/pcegz001 agif0041 " + #48#0;
          |SUB_EJECUTA_NP aAlfa;
          |HAZ LeeTxt;
          |SI aAuto = ""; |SAL; |FINSI;
          |HAZ Ejecuta;
          |SI FSalida ! 0;
               aAlfa = "0000Ejecuta:" + aProg;
               |MENAV aAlfa;
          |FINSI;
     |SIGUE;

     |FBORRA aFichero;
|FPRO;
