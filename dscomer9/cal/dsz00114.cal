|FICHEROS;
     dsz00114 #0;
     agifa084 #84;
     agifa069 #69;
     agifa501 #501;
     agifa502 #502;
     agifa517 #517;
     agifa505 #505;

     agifa024 #3;
     agifa091 #6;
     dsz99984 #11;
     agifa133 #17;
     agifa142 #41;
     agifa177 #99;
|FIN;

|VARIABLES;
     &eaProg = "";
     &enErrCarte = 0;
     &aDivisa = "";
     &aMoneda = "";
     aAlfa = "";
     nLinea = 0;
     almacen = 0;

     nError = 0;
     nVto = 0;
     nRecibo = 0;
     &eaIVAsn = "";|| IVA incluido S/N
|FIN;

|INCLUYE i_varart;

|CAMPOS;
     #517#19 DPRE;
|FIN;

|PROCESO CreaRecibos;
     |DDEFECTO #3;
     |ABRE #3;
     #3#0 = #84#3;
     |LEE 000#3=;
     |CIERRA #3;

     |HAZ VenciDir;

     |ABRE #99;
     |ABRE #17;
     nVto = 0;
     #17#0 = #84#0;
     #17#4 = #84#48;
     #17#1 = 0;
     |LEE 001#17];
     |PARA ; |SI FSalida = 0; |Y #17#0 = #84#0;|Y #17#4 = #84#48; |HACIENDO;
          nVto = nVto + 1;
          |LEE 001#17s;
     |SIGUE;

     |HAZ AbreRecVenta;

     nRecibo = 0;
     #17#0 = #84#0;
     #17#4 = #84#48;
     #17#1 = 0;
     |LEE 001#17];
     |PARA ; |SI FSalida = 0; |Y #17#0 = #84#0;|Y #17#4 = #84#48; |HACIENDO;
          |DDEFECTO #11;
          #11#17 = #84#48;
          #11#0  = #84#0;
          #11#1  = #17#1;           || Linea;
          #11#2  = #84#3;            || cliente
          #11#3  = #84#4;            || nombre del cliente
          #11#4  = #3#29;           || Banco
          #11#5  = "S";             || domiciliado
          #11#6  = "N";             || aceptado
          #11#7  = #84#1;            || fecha de emision
          #11#8  = #17#3;           || Fecha de vencimiento
          #11#9  = #17#2;           || Importe
          #11#10 = "N";            || Impreso
          #11#11 = "N";            || Contabilizado
          #11#12 = #84#40;

          |ABRE #6;
          |DDEFECTO #6;
          #6#0 = #84#8;
          |LEE 000#6=;
          |CIERRA #6;
          |SI #41#63 = "S";
               #99#0 = #6#69;
               |LEE 000#99=;
               |SI FSalida = 0;
                    #11#12 = #99#3;     || NUMERO CTA.CONTABLE.
               |SINO;
                    #11#12 = #84#40;     || NUMERO CTA.CONTABLE.
               |FINSI;
          |SINO;
               #11#12 = #84#40;          || NUMERO CTA.CONTABLE.
          |FINSI;
          #11#13 = "N";            || Cobrado
          #11#14 = "N";            || Impagado
          #11#15 = #3#161;         || A aceptar
          #11#16 = "01.01.0000";   || fecha de cobro
          #11#18 = #84#40;          || Cta
          #11#21 = #6#69;          || Tipo de Recibo (forma de pago)
          nRecibo = nRecibo + 1;
          |SI nRecibo = nVto; |Y #6#70 ! 0;
               #11#21 = #6#73;     || Tipo de Recibo (Fianza retenida)
          |FINSI;
          #11#22 = "Pdte. Cobro";
          #11#23 = nVto;
          #11#24 = #6#0;
          #11#25 = #6#1;

          #11#26 = "";
          #11#27 = "";
          #11#29 = "";
          #11#28 = "";

          eaProg = "agifa084";
          |HAZ RecVenta;
          |LEE 001#17s;
     |SIGUE;
     |CIERRA #17;
     |CIERRA #99;
     enDirEnt = #agifa084#91; |HAZ CierraRecVenta;
|FPRC;

|PROCESO MiraRecibos;
     eaProg = "agifa084";
     |HAZ MiraRecVenta;
     |SI enErrCarte ! 0;
          nError = 1;
     |FINSI;
|FPRC;

|PROCESO CreaLin69;
     #505#0 = #501#12;
     |LEE 000#505=;

     |SI #502#3 ! 0;
          almacen = #502#3;
     |SINO;
          |SI FSalida = 0;
               almacen = #505#87;
          |SINO;
               almacen = 1;
          |FINSI;
     |FINSI;

     nLinea = nLinea + 1;
     |DDEFECTO #69;
     #69#20 = #84#48;        ||Serie
     #69#0 = #84#0;
     #69#1 = nLinea;
     #69#2 = #502#2;                    ||Articulo
     #69#3 = almacen;                  ||almacen
     #69#4 = #502#8;              ||Descripcion
     #69#5 = #502#5;              ||Unidades
     #69#6 = #502#10;             ||Precio
     #69#7 = #69#5 * #69#6;||Importe
     #69#8 = #502#14;             ||Dto
     #69#9 = (#69#5 * #69#6) < #69#8;||Imp.Tot
     #69#11 = #502#13;            ||Tipo de Iva
     #69#13 = #502#11;            ||Familia
     #69#14 = #502#23;            ||Coste
     #69#15 = #84#3;             ||Cliente
     #69#16 = #84#34;            ||Tipo Comision
     #69#17 = #84#35;            ||Tipo Cliente

     #69#26 = #502#10;             ||Precio
     #69#28 = #502#10;             ||Precio
     #69#27 = #69#9;             || importe
     #69#29 = #69#9;             || importe
     |HAZ TotalLin69;
     |GRABA 021#69n;

     |LIBERA #502;
|FPRC;

|DEFBUCLE CreaLin69;
     #502#1;
     ;
     #501#36, #501#0, 001;
     #501#36, #501#0, 999;
     be;
     NULL, CreaLin69;
|FIN;

|PROCESO CreaLin69_0;
     |BUCLE CreaLin69;
     |LIBERA #501;
|FPRC;

|DEFBUCLE CreaLin69_0;
     #501#2;
     ;
     "F", #84#48, #84#0;
     "F", #84#48, #84#0;
     be;
     NULL, CreaLin69_0;
|FIN;

|PROCESO agifa069;
     |HAZ CalCabAgifa084;
|FPRC;

|PROCESO agifa084;
     |SELECT #2#501;
     #501#35 = "F";
     #501#57 = #84#48;
     #501#58 = #84#0;
     |LEE 000#501=;
     |SI FSalida ! 0; |ACABA; |FINSI;   || No es del tpv

     |SI #84#39 = "S"
          aAlfa = "0000Factura:" + #84#48 + "/" + (("000000" + #84#0) % -106) + ", contabilizada.";
          |MENAV aAlfa;
          |ACABA;
     |FINSI;

     |SI #84#10 = "S";
          nError = 0;
          |HAZ MiraRecibos;
          |SI nError = 1;
               aAlfa = "0000Factura:" + #84#48 + "/" + (("000000" + #84#0) % -106) + ", recibos con movimientos";
               |MENAV aAlfa;
               |ACABA;
          |FINSI;
     |FINSI;

     |BUCLELIN 1 NULL #84;

     aDivisa = #84#65;
     aMoneda = #84#67;
     |HAZ Divisas084;

     nLinea = 0;
     |ABRE #505;
     |BUCLE CreaLin69_0;
     |CIERRA #505;


     |HAZ LimCabAgifa084;

     |BUCLELIN 0 agifa069 #84;

     |GRABA 020#84a;
     |LIBERA #84;

     |SI #84#10 = "S";
          |HAZ CreaRecibos;
     |FINSI;
|FPRC;

|DEFBUCLE agifa084;
     #84#1;
     3, 1;
     #0#0, #0#2, #0#4, #0#6;
     #0#1, #0#3, #0#5, #0#7;
     be;
     NULL, agifa084;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #41; |LEE 000#41p; |CIERRA #41;
     |ABRE #517; |LEE 000#517p; |CIERRA #517;

     |ABRET #501;
     |ABRET #69;
     |BUCLE agifa084;
     |CIERRAT #69;
     |CIERRAT #501;
|FPRC;
