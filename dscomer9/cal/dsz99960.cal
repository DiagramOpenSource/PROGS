|FICHEROS;
     tecam004@ #4;
     tecam005@ #5;
     tecam009@ #9;
     tecam010@ #10;
     tecam011@ #11;
     tecam012 #12;
     agifa019 #19;
     agifa104 #104;
     agifa073 #73;

     dsm00053@ #53; || por problemas con MANTE
     agifa065 #65;
     agifa069 #69;
     agifa071 #71;
     agifa084 #84;
     agifa010 #100;
     referen1@ #101;
     referen2@ #102;
|FIN;

|VARIABLES;
     aDef = "";
     nUni = 0;
     nLinDes = 0;
     nDesdeLin = 0;
     &enHandle = -1; ||Solo se usa es este calculo
     &eaLog = "";
     &efFecha = "";
     nPendiente = 0;
     aPed = "";
     fFecha = @;
     fFech1 = @;
     nModo = 0;
     aUsu = "";
     nSw = 0;
     nDto = 0;
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     &dtos_1 = 0;
     &dtos_2 = 0;
     &art_dt = "";
     aMensa = "";
     aLote = "";
     aPalm = "";
     aHora = "";
     nLote = 0;
     nPalm = 0;
     nLin = 0;
     aPedAnt = "";
     fFec = @;
     aMod = "";
|FIN;

|PROCESO IncluLote;
     #5#0 = #4#0;
     #5#1 = 999;
     |LEE 000#5];
     |SI FSalida = 0;
          |LEE 000#5a;
     |SINO;
          |LEE 000#5u;
     |FINSI;
     |SI FSalida = 0; |Y #5#0 = #4#0;
          nLin = #5#1 + 1;
     |SINO;
          nLin = 1;
     |FINSI;

     |DDEFECTO #5;
     #5#0 = #4#0;
     #5#1 = nLin;
     #5#2 = #104#25;
     #5#3 = #104#0;
     #5#4 = #104#4;
     #5#5 = #104#8;
     |GRABA 020#5n;
|FPRC;

|PROCESO CreaLote;
     |HORA aHora;
     aUsu = Usuario % 810;

     |LEE 000#4u;
     |SI FSalida = 0;
          nLote = #4#0 + 1;
     |SINO;
          nLote = 1;
     |FINSI;
     |DDEFECTO #4;
     #4#0 = nLote;
     #4#1 = ~;
     #4#2 = aHora;
     #4#3 = aUsu;
     #4#4 = nPalm;
     #4#7 = aPedAnt;
     |GRABA 020#4n;
     |HAZ IncluLote;
|FPRC;

|PROCESO BuscaLin;
     nLin = nLin + 1;
|FPRC;

|DEFBUCLE BuscaLin;
     #5#1002;
     ;
     #4#0,   1;
     #4#0, 999;
     ;
     NULL, BuscaLin;
|FIN;

|PROCESO BuscaICab;
     nLin = 0;
     |BUCLE BuscaLin;
     nLote = #4#0;
|FPRC;

|DEFBUCLE BuscaUlt;
     #4#2002;
     ;
     "01.01.1900", 000000;
     "01.01.1900", 999999;
     ;
     NULL, BuscaICab;
|FIN;

|PROCESO MirPend;
     nPendiente = #73#5 - #73#43
     |SI nPendiente ! 0; |ERROR10; |FINSI;
|FPRC;

|PROCESO TecaNuevoLote;
     aPedAnt = "N";
     |SELECT #3#5;
     #5#4 = #104#4;
     #5#6 = "E";
     |LEE 000#5=;
     |SI FSalida = 0;    ||Lote pendiente cliente
          |DDEFECTO #4;
          #4#0 = #5#0;
          |LEE 020#4=;
          nPalm = #4#4;
          aPedAnt = "S";
          |HAZ CreaLote;
     |SINO;
          nLote = 1;
          nLin = 0;
          |BUCLE BuscaUlt;

          |DDEFECTO #4;
          #4#0 = nLote;
          |LEE 101#4=;
          |SI FSalida ! 0; |O nLin = 0;
               nLin = 0;
               nPalm = 0;
               |HAZ CreaLote;
          |SINO;
               |SI nLin ] #12#1;
                    nPalm = 0;
                    |HAZ CreaLote;
               |SINO;
                    |HAZ IncluLote;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;
-------------------------------------------------------------
|PROCESO CopiaDesFac;
     |BORRA 020#referen2@.a;
     #53#0 = #referen2@#0;
     #53#1 = #referen2@#1;
     #53#2 = #referen2@#2;
     #53#3 = #69#1;
     #53#4 = nLinDes;
     #53#5 = #referen2@#5;
     |GRABA 020#53n;
     nLinDes = nLinDes + 1;
|FPRC;

|DEFBUCLE CopiaDesFac;
     #referen2@#1005;
     ;
     "F", #referen1@#20, #referen1@#0, #referen1@#1, 0001;
     "F", #referen1@#20, #referen1@#0, #referen1@#1, 9999;
     be;
     NULL, CopiaDesFac;
|FIN;

|PROCESO UltLinDesFac;
     #53#0 = "F";
     #53#1 = #69#20;
     #53#2 = #69#0;
     #53#3 = #69#1;
     #53#4 = 999;
     |LEE 000#53];
     |SI FSalida = 0;
          |LEE 000#53a;
     |SINO;
          |LEE 000#53u;
     |FINSI;
     |SI FSalida = 0; |Y #53#0 = "F"; |Y #53#1 = #69#20;
               |Y #53#2 = #69#0; |Y #53#3 = #69#1;
          nLinDes = #53#4 + 1;
     |SINO;
          nLinDes = 1;
     |FINSI;
|FPRC;

|PROCESO ModHistoFac;
     #65#0 = #referen1@#2;
     #65#1 = #84#1;
     #65#2 = "FC";
     #65#3 = #referen1@#0;
     #65#4 = #referen1@#1;
     #65#11 = #referen1@#20;
     |BORRA 020#65c;
     #65#4 = #69#1;
     |LEE 121#65=;
     |SI FSalida = 0;
          #65#6 = #65#6 + #referen1@#5;
          |GRABA 020#65a;
          |LIBERA #65;
     |FINSI;
|FPRC;

|PROCESO BusLinFac;
     |SI #referen1@#2 = #69#2;
          nUni = nUni + #referen1@#5;
          |HAZ ModHistoFac;
          |HAZ UltLinDesFac;
          |BUCLE CopiaDesFac;

          |BORRA 020#referen1@.a;
     |FINSI;
|FPRC;

|DEFBUCLE BusLinFac;
     #referen1@#1003;
     ;
     #84#48, #84#0, nDesdeLin;
     #84#48, #84#0, 999;
     be;
     NULL, BusLinFac;
|FIN;

|PROCESO OrdLinFac;
     nDesdeLin = #69#1 + 1;
     nUni = 0;
     |BUCLE BusLinFac;
     |SI nUni ! 0;
          #69#5 = #69#5 + nUni;
          |GRABA 020#69a;
     |FINSI;
|FPRC;

|DEFBUCLE OrdLinFac;
     #69#1;
     ;
     #84#48, #84#0, 001;
     #84#48, #84#0, 999;
     be;
     NULL, NULL, NULL, NULL, NULL, OrdLinFac;
     #69#2;
|FIN;
-------------------------------------------------------------
|PROCESO CopiaDesAlb;
     |BORRA 020#referen2@.a;
     #53#0 = #referen2@#0;
     #53#1 = #referen2@#1;
     #53#2 = #referen2@#2;
     #53#3 = #71#1;
     #53#4 = nLinDes;
     #53#5 = #referen2@#5;
     |GRABA 020#53n;
     nLinDes = nLinDes + 1;
|FPRC;

|DEFBUCLE CopiaDesAlb;
     #referen2@#1005;
     ;
     "A", #referen1@#29, #referen1@#0, #referen1@#1, 001;
     "A", #referen1@#29, #referen1@#0, #referen1@#1, 999;
     be;
     NULL, CopiaDesAlb;
|FIN;

|PROCESO UltLinDesAlb;
     #53#0 = "A";
     #53#1 = #71#29;
     #53#2 = #71#0;
     #53#3 = #71#1;
     #53#4 = 999;
     |LEE 000#53];
     |SI FSalida = 0;
          |LEE 000#53a;
     |SINO;
          |LEE 000#53u;
     |FINSI;
     |SI FSalida = 0; |Y #53#0 = "A"; |Y #53#1 = #71#29;
               |Y #53#2 = #71#0; |Y #53#3 = #71#1;
          nLinDes = #53#4 + 1;
     |SINO;
          nLinDes = 1;
     |FINSI;
|FPRC;

|PROCESO ModHistoAlb;
     #65#0 = #referen1@#2;
     #65#1 = #100#1;
     |SI #100#43 = "S";
          #65#2 = "BV";
     |SINO;
          #65#2 = "AV";
     |FINSI;
     #65#3 = #referen1@#0;
     #65#4 = #referen1@#1;
     #65#11 = #referen1@#29;
     |BORRA 020#65c;
     #65#4 = #71#1;
     |LEE 121#65=;
     |SI FSalida = 0;
          #65#6 = #65#6 + #referen1@#5;
          |GRABA 020#65a;
          |LIBERA #65;
     |FINSI;
|FPRC;

|PROCESO BusLinAlb;
     |SI #referen1@#2 = #71#2;
          nUni = nUni + #referen1@#5;
          |HAZ ModHistoAlb;
          |HAZ UltLinDesAlb;
          |BUCLE CopiaDesAlb;

          |BORRA 020#referen1@.a;
     |FINSI;
|FPRC;

|DEFBUCLE BusLinAlb;
     #referen1@#1003;
     ;
     #100#52, #100#0, nDesdeLin;
     #100#52, #100#0, 999;
     be;
     NULL, BusLinAlb;
|FIN;

|PROCESO OrdLinAlb;
     nDesdeLin = #71#1 + 1;
     nUni = 0;
     |BUCLE BusLinAlb;
     |SI nUni ! 0;
          #71#5 = #71#5 + nUni;
          |GRABA 020#71a;
     |FINSI;
     |LIBERA #71;
|FPRC;

|DEFBUCLE OrdLinAlb;
     #71#1;
     ;
     #100#52, #100#0, 001;
     #100#52, #100#0, 999;
     be;
     NULL, NULL, NULL, NULL, NULL, OrdLinAlb;
     #71#2;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴GLOBALES컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO TecaModPedVta;
     nSw = 0;

     |DBASE aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "def/tecam005.mas";
     |CARGA_DEF aAlfa, tecam005@;
     |SI FSalida = 0;
        |DFICE aAlfa; |PATH_DAT #5 aAlfa;

        |ABRE #5; |SELECT #2#5;
        #5#2 = #104#25;
        #5#3 = #104#0;
        #5#0 = 0;
        |LEE 000#5];
        |PARA; |SI FSalida = 0; |Y #5#2 = #104#25; |Y #5#3 = #104#0; |HACIENDO;
             |SI #5#6 = "R";
                |DBASE aAlfa; |QBF aAlfa;
                aAlfa = aAlfa + "def/tecam004.mas";
                |CARGA_DEF aAlfa, tecam004@;
                |SI FSalida = 0;
                   |DFICE aAlfa; |PATH_DAT #4 aAlfa;

                   |ABRE #4;
                   #4#0 = #5#0;
                   |LEE 020#4=;
                   |CIERRA #4;
                   aAlfa = "0000Pedido preparandose " + &13 + "en el lote ["+ #5#0;
                   aAlfa = aAlfa + "]" + &13 + "enviado a PALM [" + #4#4 + "]";
                   |MENAV aAlfa;
                   nSw = 1;
                   |DESCARGA_DEF #4;
                |FINSI;
             |FINSI;
             |LEE 000#5s;
        |SIGUE;
        |CIERRA #5; |DESCARGA_DEF #5;
     |FINSI;
     FSalida = nSw;
|FPRC;

|PROCESO TecaPrvFijo;
     |ABRE #19;
     #19#0 = art_dt;
     |LEE 020#19=;
     |CIERRA #19;

     |DBASE aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "def/tecam009.mas";
     |CARGA_DEF aAlfa, tecam009@;
     |SI FSalida = 0;
        |DFICE aAlfa; |PATH_DAT #9 aAlfa;

        |ABRE #9;
        #9#0 = #19#27;
        |LEE 000#9=;
        |SI FSalida = 0;
             dtos_1 = 0;
             dtos_2 = 0;
        |FINSI;
        |CIERRA #9; |DESCARGA_DEF #9;
     |FINSI;
|FPRC;

|PROCESO TecaCheqFijo;
     nSw = 0;
     |ABRE #19;
     #19#0 = art_dt;
     |LEE 020#19=;
     |CIERRA #19;

     |DBASE aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "def/tecam009.mas";
     |CARGA_DEF aAlfa, tecam009@;
     |SI FSalida = 0;
        |DFICE aAlfa; |PATH_DAT #9 aAlfa;

        |ABRE #9;
        #9#0 = #19#27;
        |LEE 000#9=;
        |SI FSalida = 0;
             nDto = dtos_1 + dtos_2;
             |SI nDto > #9#1;
                  aAlfa = "0000Dto Maximo a aplicar [" + #9#1 + "]";
                  |MENAV aAlfa;
                  nSw = 1;
             |FINSI;
        |FINSI;
        |CIERRA #9; |DESCARGA_DEF #9;
        FSalida = nSw;
     |FINSI;
|FPRC;

|PROCESO TecaModiFac;
     nSw = 0;
     |DBASE aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "def/tecam010.mas";
     |CARGA_DEF aAlfa, tecam010@;
     |SI FSalida = 0;
        |DFICE aAlfa; |PATH_DAT #10 aAlfa;

        |ABRE #10;
        |LEE 000#10p;
        |SI FSalida = 0; |Y efFecha [ #10#1;
           |DBASE aAlfa; |QBF aAlfa;
           aAlfa = aAlfa + "def/tecam011.mas";
           |CARGA_DEF aAlfa, tecam011@;
           |SI FSalida = 0;
              |DFICE aAlfa; |PATH_DAT #11 aAlfa;
              |ABRE #11; |SELECT #2#11;
              aUsu = Usuario % 810;
              #11#1 = aUsu;
              |LEE 000#11=;
              |SI FSalida ! 0;
                 nModo = (FEntrada / 100) ! 0;
                 |SI nModo = 1;
                    |MENAV "0000Alta no permitida...";
                 |SINO;
                    |MENAV "0000Modificacion no permitida...";
                 |FINSI;
                 nSw = 1;
              |FINSI;
              |CIERRA #11; |DESCARGA_DEF #11;
           |FINSI;
        |FINSI;
        |CIERRA #10; |DESCARGA_DEF #10;
     |FINSI;
     FSalida = nSw;
|FPRC;

|PROCESO TecaFecSer;
     |HORA aAlfa;
     aAlfa = aAlfa % 102;
     |SI aAlfa ] 17;                   || ] 17:00
          fFecha = ~;
          fFech1 = fFecha % 1;
          aAlfa = fFech1 % 1101;

          fFecha = fFecha + 1;
          |SI aAlfa = "S";             || = Sabado
               fFecha = fFecha + 1;
          |FINSI;

          #104#62 = fFecha;
          |PINTA #104#1;
     |FINSI;
|FPRC;

|PROCESO TecaImpPed;
     |ABRE #12; |LEE 000#12p; |CIERRA #12;

     aAlfa1 = Impresora; |QBF aAlfa1;   aAlfa1 = aAlfa1 < aAlfa1;
     aAlfa2 = #12#4;     |QBF aAlfa2;   aAlfa2 = aAlfa2 < aAlfa2;
     |SI aAlfa1 ! aAlfa2;     || comprueba que la impresora elegida sea
          |ACABA;             ||/la que se parametriza en el palm
     |FINSI;

     aPed = " [" + #104#25 + "/" + (("000000" + #104#0) % -106) + "] ";

     aAlfa = #104#51; |QBF aAlfa;
     aAlfa = aAlfa > "";
     |SI aAlfa = "RIESGO";
          aMensa = "0000Pedido" + aPed + "con RIESGO marcado..."
          |MENAV aMensa;
          |ACABA;
     |FINSI;

     nPendiente = 0;
     |BUCLELIN 2 MirPend #104;
     |SI nPendiente = 0;
          aMensa = "0000Pedido" + aPed + "ya servido...";
          |MENAV aMensa;
          |ACABA;
     |FINSI;

     |DBASE aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "def/tecam005.mas";
     |CARGA_DEF aAlfa, tecam005@;
     |SI FSalida = 0;
        |DFICE aAlfa; |PATH_DAT #5 aAlfa;

        |ABRET #5;
        |SELECT #2#5;

        |DBASE aAlfa; |QBF aAlfa;
        aAlfa = aAlfa + "def/tecam004.mas";
        |CARGA_DEF aAlfa, tecam004@;
        |SI FSalida = 0;
           |DFICE aAlfa; |PATH_DAT #4 aAlfa;

           |ABRET #4;
           #5#2 = #104#25;
           #5#3 = #104#0;
           #5#0 = 0;
           |LEE 000#5];
           |SI FSalida = 0; |Y #5#2 = #104#25; |Y #5#3 = #104#0;
                |DDEFECTO #4;
                #4#0 = #5#0;
                |LEE 121#4=;
                aLote = ("00000" + #5#0) % -105;
                aPalm = ("00" + #4#4) % -102;
                |SI #5#6 = "P";
                     aMensa = "0000Pedido " + aPed + " actualizado en lote " + aLote;
                     |MENAV aMensa;
                |FINSI;
                |SI #5#6 = "R";
                    aMensa =  "0000Pedido " + aPed + " ya preparado en el lote " + aLote + " - al Palm " + aPalm + ". Se adjudicara manualmente";
                    |MENAV aMensa;
                |FINSI;
                |SI #5#6 = "E";
                     ||aPedAnt = "S";    ESTO
                     ||nPalm = #4#4;     ES
                     ||HAZ CreaLote;     LO ANTERIOR

                     #4#5 = "01.01.1900";          || para reenviarlo
                     #4#6 = "S";                   || pedido anterior SI
                     |GRABA 020#4a;
                     |LIBERA #4;
                     |SUB_EJECUTA "tecaz005;auto";

                     aMensa = "0000Pedido " + aPed + " actualizado en Palm [" + aPalm + "] Lote [" + aLote + "]";
                     |MENAV aMensa;
                |FINSI;
                |LIBERA #4;
           |SINO;
                |HAZ TecaNuevoLote;
           |FINSI;
           |CIERRAT #4;
           |DESCARGA_DEF #4;
        |FINSI;
        |CIERRAT #5;
        |DESCARGA_DEF #5;
     |FINSI;
|FPRC;

|PROCESO TecaCreaLote;
     |DBASE aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "def/tecam005.mas";
     |CARGA_DEF aAlfa, tecam005@;
     |SI FSalida = 0;
        |DFICE aAlfa; |PATH_DAT #5 aAlfa;

        |DBASE aAlfa; |QBF aAlfa;
        aAlfa = aAlfa + "def/tecam004.mas";
        |CARGA_DEF aAlfa, tecam004@;
        |SI FSalida = 0;
           |DFICE aAlfa; |PATH_DAT #4 aAlfa;

           |ABRET #4;
           |ABRET #5;
           |HAZ TecaNuevoLote;
           |CIERRAT #4;
           |DESCARGA_DEF #4;
        |FINSI;
        |CIERRAT #5;
        |DESCARGA_DEF #5;
     |FINSI;
|FPRC;

|PROCESO TecaAbreLog;
     |ACABA;
     || desactivado por R.Priego

     |HORA aHora;
     fFecha = ~;
     |DBASE aAlfa;
     aAlfa = aAlfa + "palm/";
     |MKDIR aAlfa;
     aAlfa = aAlfa + (fFecha % 704) + (fFecha % 402) + (fFecha % 102);
     aAlfa = aAlfa + (aHora % 102) + (aHora % 402) + (aHora % 702);
     aAlfa = aAlfa + ".log";
     |XABRE "A", aAlfa, enHandle;
|FPRC;

|PROCESO TecaCierraLog;
     |ACABA;
     || desactivado por R.Priego

     |SI enHandle ] 0;
          |XCIERRA enHandle;
     |FINSI;
|FPRC;

|PROCESO TecaGrabaLog;
     |ACABA;
     || desactivado por R.Priego

     |SI enHandle ] 0;
          aUsu = Usuario % 810;
          fFec = ~;
          |HORA aHora;
          |MODULO aMod;
          aAlfa = aUsu + "|" + fFec + "|" + aHora + "|" + aMod + "|" + eaLog;
          |XGRABA enHandle, aAlfa;
     |FINSI;
|FPRC;
--------------------------------------------------------------------
|PROCESO TecaAgrupaFac;  || Agrupa lineas por articulo
     |DDEF aAlfa;
     aDef = aAlfa + "agifa069";
     |CARGA_DEF aDef, referen1@;
     |SI FSalida = 0;
          aDef = aAlfa + "dsm00053";
          |CARGA_DEF aDef, referen2@;
          |SI FSalida = 0;
               aDef = aAlfa + "dsm00053";
               |CARGA_DEF aDef, dsm00053@;
               |SI FSalida = 0;
                    |ABRE #53;
                    |ABRE #65;
                    |BUCLE OrdLinFac;
                    |CIERRA #65;
                    |CIERRA #53;
                    |DESCARGA_DEF #dsm00053@;
               |FINSI;
               |DESCARGA_DEF #referen2@;
          |FINSI;
          |DESCARGA_DEF #referen1@;
     |FINSI;
|FPRC;

|PROCESO TecaAgrupaAlb;       || Agrupa lineas por articulo
     |DDEF aAlfa;
     aDef = aAlfa + "agifa071";
     |CARGA_DEF aDef, referen1@;
     |SI FSalida = 0;
          aDef = aAlfa + "dsm00053";
          |CARGA_DEF aDef, referen2@;
          |SI FSalida = 0;
               aDef = aAlfa + "dsm00053";
               |CARGA_DEF aDef, dsm00053@;
               |SI FSalida = 0;
                    |ABRE #53;
                    |ABRE #65;
                    |BUCLE OrdLinAlb;
                    |CIERRA #65;
                    |CIERRA #53;
                    |DESCARGA_DEF #dsm00053@;
               |FINSI;
               |DESCARGA_DEF #referen2@;
          |FINSI;
          |DESCARGA_DEF #referen1@;
     |FINSI;
|FPRC;
