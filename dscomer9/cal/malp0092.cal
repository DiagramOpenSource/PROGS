|FICHEROS;
     malpe005 #1;   || Orden de Carga L
     malpe004 #2;   || Orden Carga (C)
||     malpe136 #3;   || Comisiones
     malpe090 #4;   || Albaranes (C)
     malpe091 #5;   ||           (L)
     agifa024 #6;   || Clientes
     malpe001 #7;   || Obras;
     agifa025 #8;   || Comisionistas;
     agifa019 #9;   || Articulos
     malpe006 #11;  || Trasnportista
     malpe002 #12;  || Vehiculos
     agifa017 #13;  || Stock Almacenes
     dsm00024 #14;  || Stock Lotes
     agifa065 #15;  || Historico
     malpe104 #16;  || Fechas de Servicios
     malpe087 #17;  || Pedidos (C)
     malpe088 #18;  ||         (L)
     malp0004 #19;  || Pantalla Entlineal Carga
     agifa027 #27;
     agifa142 #41;  || Parametros Generales
     agifa007 #50; || fichero de series para ver si es de exportacion
     malpe081 #81;
     malpe083 #83;
     ||malpe085 #85;
     malpe137 #137;
     malpe210 #210;
     malpe211 #211;
|FIN;

|VARIABLES;
     nPortes = 0;
     nEncuentra = 0;
     nPesoMortero = 0;
     nRemanente = 0;
     &eaTag = "";
     &eaTieneComi = "";
     &enComision1 = 0;
     &enComision2 = 0;
     &eaArticulo = "";
     &eaTipoCli = "";
     &efFecha = @;
     &eaRemanente = "";
     &enDto = 0;
     &eaTipoComi = "";

     aAlfa = "";
     nComi1 = 0;
     nComi2 = 0;
     menor = 0;
     pc = 0;
     pcr = 0;
     nPorce1 = 0;
     nPorce2 = 0;
     nImpo = 0;
     nForma = 0;
     nPend = 0;
     cod_pale = "";
     &EURODB = 0;
     &enNumAlb = 0;
     lin = 0;
     &enForma = 0;
     &enUniPedi = 0;
     &enSwMenu = 0;
     &aDivisa = "";
     &aMoneda = "";
     axLote = "";
     axLoteRese = "";
     nServir = 0;
     nUnidades = 0;
|FIN;

|PROCESO ModiStockLote;
     |DDEFECTO #14;
     #14#0 = #18#2;
     #14#1 = #18#3;
     #14#2 = axLote;
     |LEE 101#14=;
     |SI FSalida ! 0; |GRABA 020#14b; |FINSI;
     #14#16 = #14#16 + nServir;
     |GRABA 020#14a;
|FPRC;

|PROCESO ActLote;
     |ABRE #14;
     |ABRE #16;
     #16#0 = #1#32;
     #16#1 = #1#33;
     #16#2 = #1#34;
     #16#3 = #1#35;
     |LEE 101#16=;
     |SI FSalida = 0;
          nUnidades = #1#5;
          nPend = 0;
          |PARA; |SI FSalida = 0; |Y #16#0 = #1#32; |Y #16#1 = #1#33; |Y #16#2 = #1#34;
                    |Y nPend < nUnidades; |HACIENDO;
               nUnidades = nUnidades - #16#5;
               nPend = #16#5 - #16#7;

               axLote = #16#10;
               nServir = -nPend;
               |HAZ ModiStockLote;

               axLote = #1#31;
               nServir = nPend;
               |HAZ ModiStockLote;

               #16#10 = #1#31;
               |GRABA 020#16a;
               |LIBERA #16;
               |LEE 101#16s;
          |SIGUE;
     |FINSI;
     |CIERRA #16;
     |CIERRA #14;
|FPRC;

|PROCESO Leer;
     |ABRE #6;      || Clientes
     #6#0 = #2#3;
     |LEE 000#6=;
     |CIERRA #6;

     |ABRE #7;      || Obras
     #7#0 = #2#3;
     #7#1 = #2#4;
     |LEE 000#7=;
     |CIERRA #7;

     |ABRE #8;      || Representantes
     #8#0 = #6#25;
     |LEE 000#8=;
     |CIERRA #8;

     |ABRE #12;     || Vehiculos
     #12#0 = #2#9;
     |LEE 000#12=;
     |CIERRA #12;
|FPRC;

|PROCESO CreaLinAlb;
     #4#41 = #4#41 + 1;

     #18#28 = #1#32;
     #18#0 = #1#33;
     #18#1 = #1#34;
     |LEE 121#18=;
     |SI FSalida = 0;
          #18#64 = #2#2;
          |GRABA 020#18a;
          |LIBERA #18;
     |FINSI;

     |DDEFECTO #9;       || Articulos
     |ABRE #9;
     #9#0 = #1#2;
     |LEE 101#9=;
     |CIERRA #9;

     |DDEFECTO #5;
     lin = lin + 1;
     #5#0 = #4#0;   || Numero  Albaran
     #5#1 = lin;
     #5#2 = #1#2;   || Codigo
     #5#3 = #1#3;   || Almacen
     #5#4 = #1#4;
     #5#5 = #1#5;   || Unidades
     #5#6 = #1#6;   || Precio
     #5#7 = #1#5 * #1#6;   || Impor
     #5#8 = #1#8;   || %Dto
     #5#10= #1#10;  || %Comi

     ||\\ tipo de iva leer si es exportacion y poner tipo 0
     |ABRE #50;
     #50#26 = #4#52;
     |LEE 000#50=;
     |SI FSalida ! 0 ; |DDEFECTO #50; |FINSI;
     |LIBERA #50;
     |CIERRA #50;

     |SI #50#30 = "S"; |O #6#28 = "S";
          #5#11= 0;  || T.IVA
     |SINO;
          #5#11= #1#14;  || T.IVA
     |FINSI;
     ||\\ ya he leido si es de exportacion

     #5#13= #1#18;
     #5#14= #9#9 * #1#5;   || Coste
     #5#15= #2#3;   || Cliente
     #5#16= #1#17;
     #5#17= #1#19;
     #5#27= #1#27;
     #5#29= #4#52;   || Serie Albaran
     #5#33= #1#29;   || %Dto2
     #5#62= #1#30;   || Palet redondeado al alza
     #5#49= #1#31;   || Lote
     #5#63= #1#0;    || Orden de Carga
     #5#64= #1#1;    || Linea Orden
     #5#65= #1#2;
     #5#66= " ";     || Rotura/Error
     #5#67= #18#58;
     #5#68= #18#59
     #5#69= #18#60;
     #5#70= "";         ||??Lote Reservado
     #5#71= #18#54;
     #5#72= #18#55;
     #5#73= #18#56;

     |ABRE #18;
     #18#28 = #1#32;
     #18#0 = #1#33;
     #18#1 = #1#34;
     |LEE 000#18=;
     |CIERRA #18;

     #5#39= #18#37;
     #5#40= #18#38;
     #5#42 = #18#39;
     #5#12 = #1#33;
     #5#21 = #1#34;
     #5#31 = #1#32;
     #5#41 = #1#38;
     |HAZ Remanente;
     |HAZ TotalLinMp;
     |GRABA 020#5b;
     enForma = 1;
     enUniPedi = #5#5;
     |HAZ AcumulaAVMp;
     |HAZ ActLote;
     |GRABA 021#5a;

     |SI #9#181 = "S";
          nPesoMortero = nPesoMortero + ((-1*#5#5) * #9#102);
     |FINSI;

     |ABRE #83;
     #83#0 = #9#0;
     |LEE 020#83=;
     |CIERRA #83;

     cod_pale = #83#1; |QBF cod_pale;
     |SI cod_pale ! "";
            |HAZ CreaPale;
     |FINSI;
|FPRC;

|PROCESO CreaPale;
     |DDEFECTO #9;       || Articulos
     |ABRE #9;
     #9#0 = cod_pale;
     |LEE 020#9=;
     |CIERRA #9;

     |DDEFECTO #5;
     lin = lin + 1;
     #5#0 = #4#0;   || Numero  Albaran
     #5#1 = lin;
     #5#2 = cod_pale;   || Codigo
     #5#3 = #1#3;   || Almacen
     #5#4 = #9#1;   || Descripcion ARticulo Pale
     #5#5 = (#1#30 + 0.49)! 0;   || Palets redondeado al alza
     |SI #1#37 ! 0 ; #5#5 = #1#37; |FINSI;
     #5#6 = #7#23;   || Precio
     #5#7 = #5#5 * #5#6;   || Impor
     #5#8 = 0;   || %Dto
     #5#9 = #5#7 ;   || Impo Total
     ||#5#10= #1#10;  || %Comi
     #5#10= 0;  || %Comi
     |SI #50#30 = "S";|O #6#28 = "S";
          #5#11= 0;  || T.IVA
     |SINO;
          #5#11= #1#14;  || T.IVA
     |FINSI;
     #5#13= #9#2;   || familia
     #5#14= #9#9 * ((#1#30 + 0.49) ! EURODB);   || Coste
     #5#15= #2#3;   || Cliente
     #5#16= #1#17;
     #5#17= #1#19;
     #5#27= #1#27;
     #5#29= #4#52;   || Serie Albaran
     #5#33= 0;   || %Dto2
     #5#34= 0;   || Palet
     #5#35= "";   || Lote
     #5#36= "";      || Orden de Carga
     #5#37= 0;       || Linea Orden
     #5#38= " ";     || Rotura/Error
     |GRABA 020#5b;
     |HAZ TotalLinMp;
     |HAZ AcumulaAVMp;
     |GRABA 021#5a;
     |LIBERA #5;
|FPRC;

|PROCESO CabAlb;
     |ABRE #41; |LEE 000#41p; |CIERRA #41;

     #4#52 = #2#0;
     enSwMenu = 1;
     |HAZ MalpeAV7;
     enNumAlb = #4#0;
     |HAZ Leer;
     |ABRE #4;
     |ABRE #5;
     |DDEFECTO #4;
     #4#0 = enNumAlb;  || N.Alba
     #4#52 = #2#0;   || Serie Albaran
     |LEE 000#4=;
     |SI FSalida = 0;
          |PARA; |SI FSalida = 0; |HACIENDO enNumAlb = enNumAlb + 1;
               #4#0 = enNumAlb;
               |LEE 000#4=;
          |SIGUE;
          |ABRE #27;
          #27#2 = #2#0;
          #27#0 = "valbaran";
          |LEE 101#27=;
          |SI FSalida = 0;
               #27#1 = enNumAlb;
               |GRABA 020#27a;
          |FINSI;
          |CIERRA #27;
          enNumAlb = #4#0;
     |FINSI;
     ||-----------------Cabecera
     |DDEFECTO #4;
     #4#0 = enNumAlb;  || N.Alba
     #4#1 = #2#2;  || Fecha
     #4#3 = #6#0;   || Cliente
     #4#4 = #6#2;   || Nombre
     #4#5 = #17#5;   || Dto
     #4#6 = #17#7;   || Repre
     #4#7 = #17#6;   || Dto PP
     #4#8 = #17#9;   || FP
     #4#9 = #6#35;   || Agencia
     #4#29 = #17#64;   || Entregar
     #4#30= #17#14;   || Dir Ent
     #4#31= #17#20;   || Pobla
     #4#32= #17#17;   || Dto Acumu
     #4#33= #17#21;   || Provin
     #4#34= #8#7;   || Tipo Comi
     #4#35= #6#4;   || Tipo Cli
     #4#36= #6#47;  || Reg. Equi
     #4#40= #6#41;  || Tipo Factura
     #4#43= "N";   || Abono
     #4#52= #2#0;   || Serie Albaran
     #4#55= #7#16 % 122;   || Obs. 1
     #4#56= #7#16 % 2337;   || Obs. 2
     #4#57= "";   || Obs. 3
     #4#62= #6#180;
     #4#63= #6#15;
     |SI #2#16 = "S";
          #4#64= "P";
     |SINO;
          #4#64 = "D";
     |FINSI;
     #4#68= "EUR";
     #4#69= 1;
     #4#70= "B";
     #4#73= "EUR";
     #4#74= 1;
     #4#88= #6#202;
     #4#91= #6#206;
     #4#84= #7#1;   || Obra
     #4#93= #17#64;   || Entregar_1
     #4#94= #17#65;   || Entregar_2
     #4#95= #17#66;   || Entregar_3
     #4#96= #2#0;   || S. Orden
     #4#97= #2#1;   || N. Orden

     #4#98= #2#9;   || Matricula
     #4#99= #12#6;  || Conductor
     #4#100= #2#10;   || Transportista
     #4#101= #2#11;   || Nombre
     #4#102 = #2#16; ||Tarjeta

     aDivisa = #4#68;
     aMoneda = #4#70;
     |HAZ Divisas010;
|FPRC;

|PROCESO FinAlb;
     |GRABA 021#4b;
     |SI #4#64 ! "D";
          |SI nPesoMortero ! 0; |HAZ CalcuPortesMortero; |FINSI;
     |FINSI;

     aDivisa = #4#68;
     aMoneda = #4#70;
     |HAZ Divisas010;
     |HAZ LinCabMalpe090;
     |BUCLELIN 0 CalCabMalpe090 #4;
     |GRABA 020#4a;
     enForma = 1;
     eaTag = "AV";  |HAZ RiesgosMalpe;
|FPRC;

컴컴컴컴컴컴컴컴컴컴컴컴컴컴
/*
|PROCESO BusComi;
     nComi1 = 0;
     nComi2 = 0;
     aAlfa = #4#1; aAlfa = aAlfa % -104;
     |DDEFECTO #3;
     |ABRE #3;
     #3#0 = #5#16;
     #3#62 = aAlfa;
     #3#63 = #4#103;
     |LEE 000#3=;
     |SI FSalida = 0;
          menor = 100;
          |PARA pc = 1;|SI pc < 40;|HACIENDO pc = pc + 2;
               pcr = pc + 1;
               |SI #3pc = 0;|Y #3pcr = 0;
                    |SAL;
               |SINO;
                    |SI #3pc ] #5#8;|Y #3pc < menor;
                         menor = #3pc;
                         nComi1 = #3pcr;
                         pcr = (pcr / 2) - 1 + 42;
                         nComi2 = #3pcr;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
     |CIERRA #3;
     nRemanente = #3#64;
|FPRC;
*/

|PROCESO Remanente;
     |SI #4#103 = "N";
          #5#74 = "N";
          #5#75  = 0;
          #5#76 = 0;
          |ACABA;
     |FINSI;

     |ABRE #81; |LEE 000#81p; |CIERRA #81;

     efFecha = #4#1;
     eaRemanente = #4#103;
     eaTieneComi = #5#72;
     eaArticulo = #5#2;
     eaTipoCli = #5#17;
     enDto = #5#8;
     eaTipoComi = #5#16;
     |HAZ BusComi;
     nComi1 = enComision1;
     nComi2 = enComision2;

     |DDEFECTO #137;
     |ABRE #137;
     #137#0 = #4#6;
     |LEE 101#137=;
     |SI FSalida ! 0; |GRABA 020#137b; |FINSI;

     nForma = 1;
     nPorce1 = (#5#5 * #5#68) * #5#8 / 100;
     nPorce2 = (#5#5 * #5#68) * nRemanente / 100;
     nImpo = nPorce2 - nPorce1;
     |SI #5#8 = nRemanente;
          #5#74 = "N";
          #5#75 = 0;
          #5#76 = nComi1;
     |FINSI;
     |SI #5#8 < nRemanente;
          #5#74 = "A";
          #5#75 = nImpo;
          #5#76 = nComi1;
          #137#5 = #137#5 + (nImpo * nForma);
     |FINSI;
     |SI #5#8 > nRemanente;
          #5#74 = "C";
          #5#75 = nImpo;
          #5#76 = nComi1;
          #137#4 = #137#4 + (nImpo * nForma);
     |FINSI;
     #137#7 = #137#1 + #137#3 + #137#2 - #137#6;
     #137#8 = #137#1 + #137#5 + #137#4 - #137#6;
     |GRABA 020#137a;
     |CIERRA #137;
|FPRC;

----------------------------
|PROCESO AsigPrePorte;
     #5#69 = nPortes;
     #5#6 = #5#67 + #5#69;
     |HAZ TotalLinMp;
     |GRABA 020#5a;
     |LIBERA #5;
|FPRC;

|DEFBUCLE AsigPrePorte;
     #5#1;
     ;
     #4#52, #4#0, 001;
     #4#52, #4#0, 999;
     be;
     NULL, AsigPrePorte;
|FIN;

|PROCESO TariMortero;
     |SI nPesoMortero ] #211#3; |Y nPesoMortero [ #211#4;
||          |SI #211#6 = "TO";
               nPortes = #211#5;
||          |SINO;
||               nPortes = nPesoMortero * #211#5;
||          |FINSI;

          nEncuentra = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|PROCESO CalcuPortesMortero;
     nEncuentra = 0;
     |ABRE #210;
     #210#0 = #7#22;
     #210#1 = #4#1;
     |LEE 000#210];
     |SI FSalida = 0;
          |SI #210#0 ! #7#22; |O #210#1 ! #4#1;
               |LEE 000#210a;
          |FINSI;
     |SINO;
          |LEE 000#210u;
     |FINSI;
     |SI FSalida = 0; |Y #210#0 = #7#22; |Y #210#1 [ #4#1;
          |BUCLELIN 2 TariMortero #210;
     |FINSI;
     |CIERRA #210;
     |SI nEncuentra ! 0;
          |BUCLE AsigPrePorte;
     |FINSI;
|FPRC;
