          ************* Facturar Albaranes *************
|FICHEROS;
 agifa134 #0;
 agifa059 #1;
 agifa010 #2;
 agifa071 #3;
 agifa019 #4;
 agifa024 #6;
 agifa025 #7;
 malpe057 #8;
 agifa027 #9;
 agifa091 #10;
 agifa133 #17;
 agifa142 #41;
|FIN;

|VARIABLES;
     nNumFec = 0;
     nNumAlb = 0;
     &EURODB        = 0;
     Obra           = 0;
     &ser_alb       = "";
     &num_alb       = "";
     &ser_fac       = "";
     &num_fac       = "";

     vaciof         = " ";
     fecha          = "          ";
     cafe           = "";
     diafe          = "";
     dianu          = "";
     desde          = "      ";
     hasta          = "zzzzzz";
     fmes           = " ";
mensaje5= "Factura:        Procesando Albaran:        Linea:    Articulo:";
     mascara        = "0000000";
     tempo          = " ";
     filtro         = "-106";
     clave          = "vfactura";
     seriefac       = " ";
     dia_venci      = "";
     mes_venci      = "";
     any_venci      = "";
     fechas         = "";

     &sw = 0;

     primera        = 0;
     sw1            = 0;
     em             = 0;
     num2           = 0;
     k              = 0;
     num1           = 0;
     saltar         = 0;
     iva1           = 0;
     iva2           = 0;
     iva3           = 0;
     iva4           = 0;
     iva5           = 0;
     re1            = 0;
     re2            = 0;
     re3            = 0;
     re4            = 0;
     re5            = 0;
     mes            = 0;
     imneto         = 0;
     retencion      = 0;
     margen         = 0;
     linea          = 1;
     solouno        = 0;
     redondeo       = 0;
     importe        = 0;
     importe_n      = 0;
     num            = 0;
     resto          = 0;
     base0          = 0;
     base1          = 0;
     base2          = 0;
     base3          = 0;
     base4          = 0;
     base5          = 0;
     bruto          = 0;
     b0             = 0;
     p0             = 0;
     b1             = 0;
     p1             = 0;
     b2             = 0;
     p2             = 0;
     b3             = 0;
     p3             = 0;
     b4             = 0;
     p4             = 0;
     b5             = 0;
     p5             = 0;
     br             = 0;
     tp             = 0;
     tv             = 0;
     i              = 0;
     a              = 0;
     j              = 0;
     abono          = 0;
     mes_ven        = 0;
     totalb         = 0;
     tipo_imp       = 0;

     fecha_fac      = @;
     fechae         = @;
|FIN;

|CALCULO grupal;|TIPO 0;
|ERROR;
|FCAL;

|CALCULO contfact; |TIPO 0;
|SI #8#11 = "99";
    seriefac = #2#52;
|SINO;
    seriefac = #8#11;
|FINSI;
|ABRE #9;
#9#0 = clave;
#9#2 = seriefac;
|LEE 111#9=;
|SI 0 ! FSalida;
     |DDEFECTO #9;
     #9#0 = clave;
     #9#2 = seriefac;
     |GRABA 020#9b;
|FINSI;
tempo = mascara + #9#1;
#0#0  = tempo % filtro;
#0#49 = seriefac;||serie factura;
#9#1  = #9#1 + 1;
|GRABA 020#9a;
|LIBERA #9;
|CIERRA #9;
|FCAL;


|CALCULO actufa;|TIPO 2;
|| *******  Opciones del recalculo
#0#18 = br;
|SI #0#18 > 0;
     importe_n = 1;
|SINO;
     importe_n = -1;
     #0#18 = -#0#18;
|FINSI;
#0#17 = #0#18 < #0#4;#0#17 = #0#17 < #0#5;#0#17 = #0#17 < #0#6;
#0#17 = #0#18 - #0#17;
#0#18 = #0#18 * importe_n;    #0#17 = #0#17 * importe_n;

|SI b1 > 0;
     importe_n = 1;
|SINO;
     importe_n = -1;
     b1 = -b1;
|FINSI;
#0#21 = b1 < #0#4; #0#21 = #0#21 < #0#5; #0#21 = #0#21 < #0#6;
b1 = b1 * importe_n;     #0#21 = #0#21 * importe_n;

|SI b2 > 0;
     importe_n = 1;
|SINO;
     importe_n = -1;
     b2 = -b2;
|FINSI;
#0#24 = b2 < #0#4; #0#24 = #0#24 < #0#5; #0#24 = #0#24 < #0#6;
b2 = b2 * importe_n;     #0#24 = #0#24 * importe_n;

|SI b3 > 0;
     importe_n = 1;
|SINO;
     importe_n = -1;
     b3 = -b3;
|FINSI;
#0#27 = b3 < #0#4; #0#27 = #0#27 < #0#5; #0#27 = #0#27 < #0#6;
b3 = b3 * importe_n;     #0#27 = #0#27 * importe_n;

|SI b4 > 0;
     importe_n = 1;
|SINO;
     importe_n = -1;
     b4 = -b4;
|FINSI;
#0#33 = b4 < #0#4; #0#33 = #0#33 < #0#5; #0#33 = #0#33 < #0#6;
b4 = b4 * importe_n;     #0#33 = #0#33 * importe_n;

|SI b5 > 0;
     importe_n = 1;
|SINO;
     importe_n = -1;
     b5 = -b5;
|FINSI;
#0#36 = b5 < #0#4; #0#36 = #0#36 < #0#5; #0#36 = #0#36 < #0#6;
b5 = b5 * importe_n;     #0#36 = #0#36 * importe_n;

|SI b0 > 0;
     importe_n = 1;
|SINO;
     importe_n = -1;
     b0 = -b0;
|FINSI;
#0#47 = b0 < #0#4; #0#47 = #0#47 < #0#5; #0#47 = #0#47 < #0#6;
b0 = b0 * importe_n;     #0#47 = #0#47 * importe_n;

#0#19 = tp;
#0#20 = tv;
#0#21 = #0#21 + p1;
#0#24 = #0#24 + p2;
#0#27 = #0#27 + p3;
#0#33 = #0#33 + p4;
#0#36 = #0#36 + p5;
#0#22 = #0#21 % #0#39;
#0#25 = #0#24 % #0#41;
#0#28 = #0#27 % #0#43;
#0#34 = #0#33 % #0#50;
#0#37 = #0#36 % #0#52;
|SI #0#13 = AS;
   #0#23 = #0#21 % #0#40;
   #0#26 = #0#24 % #0#42;
   #0#54 = #0#27 % #0#44;
   #0#35 = #0#33 % #0#51;
   #0#38 = #0#36 % #0#53;
|FINSI;

#0#29 = #0#22 + #0#25 + #0#28 + #0#34 + #0#37;
#0#30 = #0#26 + #0#23 + #0#54 + #0#35 + #0#38;
#0#31 = #0#18 - #0#17;#0#31 = #0#31 + #0#29;#0#31 = #0#31 + #0#30;
#0#31 = #0#31 + #0#19;#0#31 = #0#31 + #0#20;

|SI #10#0 ! #0#11;
   |ABRE #10;
   #10#0 = #0#11;
   |LEE 021#10=;
   |SI 0 ! FSalida;
     |DDEFECTO #10;
   |FINSI;
   |CIERRA #10;
|FINSI;

num = #10#3;
importe = #0#31 - #0#32;
importe = importe ! EURODB;
resto = importe $ num;
importe = importe / num;
redondeo = importe ! EURODB;

|SI redondeo ! importe;    ||trunca importe
  |SI redondeo > importe;
     importe = redondeo - 1;
  |SINO;
     importe = redondeo;
  |FINSI;
|FINSI;
|ABRE #6;
#6#0 = #0#2;
|LIBERA #6;
|LEE 121#6=;
|SI 0 = FSalida;
   fmes = #0#1 % A402;
   mes = fmes - 1;
   mes = mes * 4;
   mes = mes + 54;
   imneto = #0#18 - #0#17;
   #6#50 = #6#50 -. imneto;        || pendiente de facturar
   #6mes = #6mes +. imneto;
   mes = mes + 1;
   #6mes = #6mes +. #0#17;
   mes = mes + 1;
   #6mes = #6mes +. #0#46;
   #6#102 = #6#102 +. imneto;
   #6#103 = #6#103 +. #0#17;
   #6#104 = #6#104 +. #0#46;
   #6#49 = #6#49 +. #0#31 -. #0#32;
   #6#45 = #0#1;
   #6#46 = imneto;
   #6#110 = #6#110 +. imneto;
   |GRABA 020#6a;

     enImpCliPen = -imneto;
     enImpCliCom = imneto;
     enImpCliDto = #0#17;
     enImpCliMar = #0#46;
     enImpCliFac = imneto;
     eaCliente = #0#2;
     efFecha = #0#1;
     |HAZ AcumulaCli;
|FINSI;
|CIERRA #6;

|ABRE #7;
#7#0 = #0#7;
|LIBERA #7;
|LEE 121#7=;
|SI 0 = FSalida;
   imneto = #0#18 - #0#17;
   fmes = #0#1 % A402;
   mes = fmes - 1;
   mes = mes * 2;
   mes = mes + 11;
   #7mes = #7mes +. #0#8;
   retencion = #0#8 % #7#39;
   mes = mes + 1;
   #7mes = #7mes +. imneto;
   #7#35 = #7#35 +. #0#8;
   #7#36 = #7#36 +. imneto;
   mes = fmes - 1;
   mes = mes + 40;
   #7mes = #7mes + retencion;
   #7#52 = #7#52 + retencion;
   #0#55 = #0#55 + retencion;
   |GRABA 020#7a;

     enImpRepComi = #0#8 * nForma;
     enImpRepVta = imneto * nForma;
     enImpRepRete = retencion;
     eaRepre = #0#7;
     efFecha = #0#1;
     |HAZ AcumulaRep;
|FINSI;
|CIERRA #7;
|FCAL;

|CALCULO leepago;|TIPO 0;
||SI #10#0 ! #0#11;
   #10#0 = #0#11;
   |ABRE #10;
   |LEE 021#10=;
   |SI 0 ! FSalida;|DDEFECTO #10;|FINSI;
   |CIERRA #10;
||FINSI;
|FCAL;


|CALCULO calvenci;|TIPO 0;
|HAZ leepago;
num = #10#3;
importe = #0#31 - #0#32;
|SI importe < 0;
     importe = importe * -1;
     tipo_imp = -1;
|SINO;
     tipo_imp = 1;
|FINSI;
importe = importe ! EURODB;
|SI EURODB ! 0; importe = (importe * 100) ! 0; |FINSI;
resto = importe $ num;
importe = importe / num;
redondeo = importe ! 0;

|SI redondeo ! importe;                 || trunca importe;
   |SI redondeo > importe;
      importe = redondeo - 1;
   |SINO;
      importe = redondeo;
   |FINSI;
|FINSI;
|FCAL;



|CALCULO actufl;|TIPO 2;
retencion = 0 +. 1;
   base0 = 0;
   base1 = 0;
   base2 = 0;
   base3 = 0;
   base4 = 0;
   base5 = 0;
   bruto = 0;
   |SI #2#43 = AS;
       abono = -1;
   |SINO;
       abono = 1;
   |FINSI;
  #2#38 = AS;
  #2#39 = #0#0; ||num factura;
  #2#59 = #0#1;
  #2#53 = #0#49;||serie factura;
  #2#37 = 0;
  |ABRE #4;
  |PINTA 2401,mensaje5;
  |PINTA 2409,#0#0;
  |PINTA 2416,#0#49;
  |PINTA 2437,#2#0;
  |PINTA 2443,#2#52;
  |BUCLELIN 0kactuar#2;
  |CIERRA #4;
  |BLIN 24;

     #0#39 = iva1; #0#40 = re1;
     #0#41 = iva2; #0#42 = re2;
     #0#43 = iva3; #0#44 = re3;
     #0#50 = iva4; #0#51 = re4;
     #0#52 = iva5; #0#53 = re5;

  #0#18 = #0#18 +. #2#15;
  #0#19 = #0#19 +. #2#11;
  #0#20 = #0#20 +. #2#13;
  #0#17 = #0#17 +. #2#25;
  #0#8  = #0#8  +. #2#26;
  #0#46 = #0#46 +. #2#37;
  #0#21 = #0#21 +. #2#16;
  #0#22 = #0#22 +. #2#17;
  #0#23 = #0#23 +. #2#18;

  #0#24 = #0#24 +. #2#19;
  #0#25 = #0#25 +. #2#20;
  #0#26 = #0#26 +. #2#21;

  #0#27 = #0#27 +. #2#22;
  #0#28 = #0#28 +. #2#23;
  #0#54 = #0#54 +. #2#54;

  #0#33 = #0#33 +. #2#44;
  #0#34 = #0#34 +. #2#45;
  #0#35 = #0#35 +. #2#46;

  #0#36 = #0#36 +. #2#47;
  #0#37 = #0#37 +. #2#48;
  #0#38 = #0#38 +. #2#49;

  #0#47 = #0#47 +. #2#28;
  #0#32 = #0#32 +. #agifa010#61;

  #0#29 = #0#22 +  #0#25 + #0#28 + #0#34 + #0#37;
  #0#30 = #0#23 +  #0#26 + #0#35 + #0#38 + #0#54;
  #0#17 = #0#17 ! EURODB ;  #0#18 = #0#18 ! EURODB ;  #0#29 = #0#29 ! EURODB;
  #0#19 = #0#19 ! EURODB ;  #0#20 = #0#20 ! EURODB ;  #0#30 = #0#30 ! EURODB;
  #0#31 = #0#18 - #0#17;
  #0#31 = #0#31 + #0#29;
  #0#31 = #0#31 + #0#30;
  #0#31 = #0#31 + #0#19;
  #0#31 = #0#31 + #0#20;
  |HAZ calvenci;
  ||HAZ calvenc2;
  #2#15 = bruto;

  |SI base1 > 0;
     importe_n = 1;
  |SINO;
     importe_n = -1;
     base1 = -base1;
  |FINSI;
  #2#16 = base1 < #2#5; #2#16 = #2#16 < #2#32; #2#16 = #2#16 < #2#7;
  base1 = base1 * importe_n;  #2#16 = #2#16 * importe_n;

  |SI base2 > 0;
     importe_n = 1;
  |SINO;
     importe_n = -1;
     base2 = -base2;
  |FINSI;
  #2#19 = base2 < #2#5; #2#19 = #2#19 < #2#32; #2#19 = #2#19 < #2#7;
  base2 = base2 * importe_n;  #2#19 = #2#19 * importe_n;

  |SI base3 > 0;
     importe_n = 1;
  |SINO;
     importe_n = -1;
     base3 = -base3;
  |FINSI;
  #2#22 = base3 < #2#5; #2#22 = #2#22 < #2#32; #2#22 = #2#22 < #2#7;
  base3 = base3 * importe_n;  #2#22 = #2#22 * importe_n;

  |SI base4 > 0;
     importe_n = 1;
  |SINO;
     importe_n = -1;
     base4 = -base4;
  |FINSI;
  #2#44 = base4 < #2#5; #2#44 = #2#44 < #2#32; #2#44 = #2#44 < #2#7;
  base4 = base4 * importe_n;  #2#44 = #2#44 * importe_n;

  |SI base5 > 0;
     importe_n = 1;
  |SINO;
     importe_n = -1;
     base5 = -base5;
  |FINSI;
  #2#47 = base5 < #2#5; #2#47 = #2#47 < #2#32; #2#47 = #2#47 < #2#7;
  base5 = base5 * importe_n;  #2#47 = #2#47 * importe_n;

  |SI base0 > 0;
     importe_n = 1;
  |SINO;
     importe_n = -1;
     base0 = -base0;
  |FINSI;
  #2#28 = base0 < #2#5; #2#28 = #2#28 < #2#32; #2#28 = #2#28 < #2#7;
  base0 = base0 * importe_n;  #2#28 = #2#28 * importe_n;

     |SI #2#12 = 2;
          p2 = p2 + #2#11;
          #2#19 = #2#19 + #2#11;
     |SINO;
          |SI #2#12 = 1;
               p1 = p1 + #2#11;
               #2#16 = #2#16 + #2#11;
          |SINO;
               |SI #2#12 = 3;
                    p3 = p3 + #2#11;
                    #2#22 = #2#22 + #2#11;
               |SINO;
                    |SI #2#12 = 4;
                         p4 = p4 + #2#11;
                         #2#44 = #2#44 + #2#11;
                    |SINO;
                         |SI #2#12 = 5;
                              p5 = p5 + #2#11;
                              #2#47 = #2#47 + #2#11;
                         |SINO;
                              p0 = p0 + #2#11;
                              #2#28 = #2#28 + #2#11;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #2#14 = 2;
          p2 = p2 + #2#13;
          #2#19 = #2#19 + #2#13;
     |SINO;
          |SI #2#14 = 1;
               p1 = p1 + #2#13;
               #2#16 = #2#16 + #2#13;
          |SINO;
               |SI #2#14 = 3;
                    p3 = p3 + #2#13;
                    #2#22 = #2#22 + #2#13;
               |SINO;
                    |SI #2#14 = 4;
                         p4 = p4 + #2#13;
                         #2#44 = #2#44 + #2#13;
                    |SINO;
                         |SI #2#14 = 5;
                              p5 = p5 + #2#13;
                              #2#47 = #2#47 + #2#13;
                         |SINO;
                              p0 = p0 + #2#13;
                              #2#28 = #2#28 + #2#13;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;


   tp = tp + #2#11;
   tv = tv + #2#13;


   #2#17 = #2#16 % #0#39;
   #2#20 = #2#19 % #0#41;
   #2#23 = #2#22 % #0#43;
   #2#45 = #2#44 % #0#50;
   #2#48 = #2#47 % #0#52;
   |SI #2#36 = AS;
       #2#18 = #2#16 % #0#40;
       #2#21 = #2#19 % #0#42;
       #2#54 = #2#22 % #0#44;
       #2#46 = #2#44 % #0#51;
       #2#49 = #2#47 % #0#53;
   |FINSI;
   #2#24=#2#17+#2#20+#2#23+#2#45+#2#48+#2#18+#2#21+#2#54+#2#46+#2#49;
   #2#25 = #2#15 % #2#5; i = #2#15 - #2#25;i = i % #2#32;
   #2#25 = #2#25 + i;i = #2#15 - #2#25;i = i % #2#7;
   #2#25 = #2#25 + i;

   #1#3 = bruto;
   #1#4 = #2#25;
   #1#5 = #2#11;
   #1#6 = #2#13;
   #1#7 = #2#16;
   #1#8 = #2#19;
   #1#9 = #2#22;
   #1#10 = #2#24;
   #1#16 = #2#44;
   #1#17 = #2#47;
   #1#11 = #2#15 - #2#25;#1#11 = #1#11 + #2#24;
   #1#11 = #1#11 + #2#11;#1#11 = #1#11 + #2#13;
   #1#13 = #1#7 + #1#8 + #1#9 + #1#16 + #1#17;
     |GRABA 021#1a;
   bruto = bruto * abono;
   base1 = base1 * abono;
   base2 = base2 * abono;
   base3 = base3 * abono;
   base4 = base4 * abono;
   base5 = base5 * abono;
   base0 = base0 * abono;
   br = br + bruto;
   b1 = b1 + base1;
   b2 = b2 + base2;
   b3 = b3 + base3;
   b0 = b0 + base0;
   b4 = b4 + base4;
   b5 = b5 + base5;
  |GRABA 020#2a;
  |LIBERA #2;
|FCAL;

|CALCULO kactuar;
  |LEE 101#3=;
  #3#26 = #0#0;              || numero factura en lineas del albaran
  #3#30 = #0#49;          || serie factura en lineas albaran;
  |GRABA 021#3a;

|| Recalculo *****

#3#9 = #3#9 ! EURODB;
bruto = bruto + #3#9;
|SI #3#11 = 2;
     base2 = base2 + #3#9;
|SINO;
     |SI #3#11 = 1;
          base1 = base1 + #3#9;
     |SINO;
          |SI #3#11 = 3;
               base3 = base3 + #3#9;
          |SINO;
               |SI #3#11 = 4;
                    base4 = base4 + #3#9;
               |SINO;
                    |SI #3#11 = 5;
                         base5 = base5 + #3#9;
                    |SINO;
                         base0 = base0 + #3#9;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FINSI;
|| ********
|PINTA 2451,#3#1;|PINTA 2464,#3#2;
#4#0 = #3#2;
|LEE 111#4=;
|SI 0 = FSalida;
     |SI #3#9 > 0;
          importe_n = 1;
     |SINO;
          importe_n = -1;
          #3#9 = -#3#9;
     |FINSI;
  imneto = #3#9 < #2#5;
  imneto = imneto < #2#32;
  imneto = imneto < #2#7;
  imneto = (imneto * importe_n) ! EURODB;
     #3#9 = #3#9 * importe_n;

  fmes = #0#1 % A402;
  mes = fmes - 1;
  mes = mes * 5;
  mes = mes + 35;
  margen = #3#5 * #4#9;
  margen = imneto - margen;
  imneto = imneto * retencion;
  #4mes = #4mes + imneto;
  mes = mes + 1;
  #2#37 = #2#37 + margen;
  margen = margen * retencion;
  #4mes = #4mes + margen;
  #4#95 = #4#95 + imneto;
  #4#96 = #4#96 + margen;
  #4#24 = #0#1;
  #4#25 = #3#5;
  |GRABA 020#4a;
  |LIBERA #4;

     efFecha = #0#1;
     eaArticulo = #3#2;
     enImpVta = imneto;
     enImpMar = margen;
     |HAZ AcumulaArt;
|FINSI;
|FCAL;





|CALCULO defecfl;|TIPO 0;
#1#2 = #2#0; ||numero albaran;
#1#15= #2#52;||serie albaran;
#1#3 = #2#15 ! EURODB;
#1#4 = #2#25 ! EURODB;
#1#5 = #2#11 ! EURODB;
#1#6 = #2#13 ! EURODB;
#1#7 = #2#16 ! EURODB;
#1#8 = #2#19 ! EURODB;
#1#9 = #2#22 ! EURODB;
#1#10 = #2#24 ! EURODB;
#1#12 = #2#26;
#1#16 = #2#44 ! EURODB;
#1#17 = #2#47 ! EURODB;
#1#13 = #1#7 + #1#8 + #1#9 + #1#16 + #1#17;
#1#13 = #1#13 ! EURODB;
#1#11 = #1#13 + #1#10;
|FCAL;

|CALCULO creacabe;|TIPO 0;
|DDEFECTO #0;
#0#2 = #2#3;
#0#57= #2#62;
|SI #6#0 ! #0#2;
   |ABRE #6;
   #6#0 = #0#2;
   |LEE 020#6=;
   |CIERRA #6;
|FINSI;
|SI #6#43 = AN;
   solouno = 1;
|SINO;
   solouno = 0;
|FINSI;
|DEFECTO #0#6;
|SI #8#8 = "S";
    #0#1 = #2#1;
|SINO;
    #0#1 = #8#7;
|FINSI;

#0#4 = #2#5;#0#6 = #2#7;#0#7 = #2#6;#0#5 = #2#32;#0#11 = #2#8;
#0#14 = #6#22;
#0#15 = #6#23;
#0#16 = #6#24;

|PARA FSalida = 1;|SI 0 ! FSalida;|HACIENDO FSalida = FSalida;
  |HAZ contfact;
  |GRABA 000#0b;
|SIGUE;
linea = 1;
|SI ser_alb ! ""; |O num_alb ! "";
     ser_fac = #0#49;
     num_fac = #0#0;
|FINSI;
br = 0;
b0 = 0;
p0 = 0;
b1 = 0;
p1 = 0;
b2 = 0;
p2 = 0;
b3 = 0;
p3 = 0;
b4 = 0;
p4 = 0;
b5 = 0;
p5 = 0;
tp = 0;
tv = 0;

     enTiva = 1; efFiva = #0#1; |HAZ SacaIVA;
     iva1 = enIva;re1 = enRec;
     enTiva = 2; efFiva = #0#1; |HAZ SacaIVA;
     iva2 = enIva;re2 = enRec;
     enTiva = 3; efFiva = #0#1; |HAZ SacaIVA;
     iva3 = enIva;re3 = enRec;
     enTiva = 4; efFiva = #0#1; |HAZ SacaIVA;
     iva4 = enIva;re4 = enRec;
     enTiva = 5; efFiva = #0#1; |HAZ SacaIVA;
     iva5 = enIva;re5 = enRec;

     #0#39 = iva1; #0#40 = re1;
     #0#41 = iva2; #0#42 = re2;
     #0#43 = iva3; #0#44 = re3;
     #0#50 = iva4; #0#51 = re4;
     #0#52 = iva5; #0#53 = re5;
|FCAL;

|CALCULO finadju;|TIPO 0;
|SI primera = 1;
   |HAZ actufa;
   |SI #8#8 = "S";
       #0#1 = #2#1;
   |SINO;
       #0#1 = #8#7;
   |FINSI;
   |GRABA 020#0a;
   |LIBERA #0;
   |HAZ calvenc2;
|FINSI;
|FCAL;

|CALCULO sirve;|TIPO 0;

|LEE 121#2=;
|SI 0 = FSalida;|Y #2#38 = AN;
   |SI primera = 0;|O #0#4 ! #2#5;|O #0#6 ! #2#7;|O #0#7 ! #2#6;
   |O #0#5 ! #2#32;|O #0#11 ! #2#8;|O #0#2 ! #2#3; |O #2#62 ! Obra;
   |O solouno = 1;
     Obra = #2#62;
     |HAZ finadju;
     |HAZ creacabe;
     primera = 1;
   |FINSI;
   #1#0  = #0#0; ||linea de factura num fac;
   #1#14 = #0#49;||linea de factura serie;
   |PARA FSalida = 1;|SI 0 ! FSalida;|HACIENDO linea = linea + 1;
     #1#1 = linea;
     |GRABA 010#1b;
     |SI 0 = FSalida;
        |HAZ defecfl;
        |HAZ actufl;
        |GRABA 020#1a;
        |LIBERA #1;
        FSalida = 0;
     |FINSI;
   |SIGUE;
|FINSI;
|LIBERA #2;
|FCAL;

|DEFBUCLE agifa4690;
 #2#3;
 38,39,43,51;
 #8#6,#8#0,#8#13,#8#4,#8#9 ,#8#2," ","00.00.0000",AN,desde,AN,AS;
 #8#6,#8#1,#8#14,#8#5,#8#10,#8#3,"¥","31.12.9999",AN,hasta,AN,AS;
 e;
 NULL , NULL , NULL , NULL , finadju , sirve , NULL , NULL;
 #2#3 , #2#5 , #2#6 , #2#7 , #2#8 , #2#32;
|FIN;

|DEFBUCLE lee_alba;
#2#1;
;
ser_alb , num_alb;
ser_alb , num_alb;
be;
NULL , sirve , NULL , finadju;
|FIN;

|PROGRAMA;
      |SI ser_alb = "";|Y num_alb = "";
          |CLS;
          |CABEZA "Facturar Albaranes";
          |PINPA #0#8;
          |PINDA #0#8;
          |ENDATOS #1#8;
       |SINO;
          #8#12="SI";    || Es correcto = "SI"
          FSalida = 0;
      |FINSI;
|SI #8#12 ! "SI"; |O FSalida ! 0;
     |ACABA;
|FINSI;
|DDEFECTO #0;
|DDEFECTO #1;
|DDEFECTO #2;
|DDEFECTO #3;
|DDEFECTO #4;
|DDEFECTO #5;
|DDEFECTO #6;
|DDEFECTO #7;

|ABRE #0;
|ABRE #1;
|SI ser_alb = ""; |Y num_alb = "";
     |BUCLE agifa4690;
|SINO;
     |BUCLE lee_alba;
|FINSI;
|CIERRA #0;
|CIERRA #1;
|SI ser_alb ! ""; |Y num_alb ! "";
     |ABRE #agifa142;
     #agifa142#0 = "A";
     |LEE 001#agifa142.=;
     |SI FSalida ! 0; |DDEFECTO #agifa142; |FINSI;
     |CIERRA #agifa142;
     |SI #agifa142#24 = "S";
          |SI #agifa142#25 = "S";
               |CONFI "2400NDesea Imprimir la Factura : ";
               |SI FSalida ! 0;
                    |ACABA;
               |FINSI;
               |SUB_EJECUTA "agifa136.run";
          |FINSI;
     |FINSI;
|FINSI;
|FPRO;

||aqui;

|PROCESO vencical;
j = #10k / em;
||SI j ! 0;
     fechae = fecha_fac + j;
     |HAZ fijos;
     mes_venci = fechae % 402;
     mes_ven = mes_venci;
     |SI mes_ven = #6#21;
          |HAZ cambia_fecha;
          fecha = fechae;
     |FINSI;
     #17#3 = fecha;
     #17#2 = importe * tipo_imp;
     |SI i = num;
          #17#2 = #17#2 + (resto * tipo_imp);
     |FINSI;
     |SI EURODB ! 0;
          #17#2 = (#17#2 / 100) ! EURODB;
     |FINSI;
|||FINSI;
|FPRC;

|CALCULO cambios;
fecha = fechae;
cafe = fecha;
diafe = fecha % A102;
dianu = diafe;
|FCAL;


|CALCULO fijos;
 |SI #0#14 = 0;          ||#6#22
     |VETE finfijos;
 |FINSI;
 |HAZ cambios;
 |SI dianu > #0#14;
     |VETE  fijos2;
 |FINSI;
|ET fijos1;
 |SI dianu = #0#14;
     |VETE finfijos;
 |FINSI;
 fechae = fechae +1;
 |HAZ cambios;
 |VETE fijos1;
|ET fijos2;
 |SI #0#15 = 0; |O dianu [ #0#14;         ||#6#23
     |VETE fijos1;
 |FINSI;
 |SI dianu > #0#15;
     |VETE fijos3;
 |FINSI;
 |SI dianu = #0#15;
     |VETE finfijos;
 |FINSI;
 fechae = fechae + 1;
 |HAZ cambios;
 |VETE fijos2;
|ET fijos3;
 |SI #0#16 = 0;|O dianu > #0#16; |O dianu [ #0#14; |O dianu [ #0#15;
     |VETE fijos1;
 |FINSI;
 |SI dianu = #0#16;
     |VETE finfijos;
 |FINSI;
 fechae = fechae +1;
 |HAZ cambios;
 |VETE fijos3;
|ET finfijos;
 fecha = fechae;
|FCAL;


|PROCESO LeeAlbFactu;
     #2#52 = #1#15;
     #2#0 = #1#2;
     |LEE 000#2=;
     nNumFec = nNumFec + #2#1;
     nNumAlb = nNumAlb + 1;
|FPRC;

|CALCULO calvenc2;
|HAZ leepago;
num = #10#3;
importe = #0#31 - #0#32;
|SI importe < 0;
     importe = importe * -1;
     tipo_imp = -1;
|SINO;
     tipo_imp = 1;
|FINSI;
importe = importe ! EURODB;
|SI EURODB ! 0; importe = (importe * 100) ! 0; |FINSI;
resto = importe $ num;
importe = importe / num;
redondeo = importe ! 0;
|SI redondeo ! importe;                 || trunca importe
   |SI redondeo > importe;
        importe = redondeo - 1;
   |SINO;
        importe = redondeo;
   |FINSI;
|FINSI;
|ABRE #17;
||****

|SI #10#5 = "N";
    em = 1;
|SINO;
    em = 1000;
|FINSI;

||****
     |SI #10#74 = "F";
          fecha_fac = #0#1;
     |SINO;
          nNumFec = 0;
          nNumAlb = 0;
          |BUCLELIN 2 LeeAlbFactu #0;
          nNumFec = nNumFec / nNumAlb;
          fecha_fac = nNumFec;
          |SI nNumAlb = 0; fecha_fac = #0#1; |FINSI;
     |FINSI;

|PARA i = 1;|SI i [ num; |HACIENDO i = i + 1;
     k = i + 5;
     |DDEFECTO #17;
     #17#0 = #1#0; ||numero factura;
     #17#1 = i;    ||numero linea;
     #17#4 = #1#14;||numero factura;
     |LEE 101#17=;
     |SI FSalida ! 0;
          |GRABA 021#17b;
     |FINSI;
     |HAZ vencical;
     |GRABA 021#17a;
     |LIBERA #17;
     |SI i = 1; |Y #17#3 < #0#1;
          |MENAV "0000Algún vencimiento calculado es anterior a la fecha factura, revise las fechas de factura o albaranes.";
     |FINSI;
|SIGUE;

|CIERRA #17;
|FCAL;


|PROCESO cambia_fecha;
     dia_venci = fechae % 102;
     mes_venci = fechae % 402;
     mes_ven = mes_venci + 1;
     mes_venci = ("00" + mes_ven) % -102;
     any_venci = fechae %704;
     |SI mes_ven > 12;
          mes_venci = "01";
          mes_ven = any_venci + 1;
          any_venci = mes_ven;
     |FINSI;
          fechas = dia_venci + "." + mes_venci + "." + any_venci;
          fechae = fechas;
|FPRC;
