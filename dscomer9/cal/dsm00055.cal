|FICHEROS;
     dsm00054 #54;
     dsm00055 #0;
     agifa019 #1;
     agifa017 #2;
     dsm00024 #3;

     agifa142 #11;
     dsl00001 #6; ||Codigos de barras multiples
     agifa007 #7;
     dsm00068 #68;

     agifa048 #480;      || escandallos, para nEsKit

     dsm00005 #905;
     dsm00010 #910;
     dsm00004 #904;
     dsm00014 #914;
     referen@;

     caenlac@ #700;
     agifa704 #704;
     agifa722 #722;
     agifa029 #29;
     agifa142 #142;
|FIN;

|VARIABLES;
     &enPrime = 0;
     nGuardaAlma = 0;
     &fich_alta = "";
     &Tempo = "";
     nFlag  = 0;
     nTecla = 0;
     nLin = 0;
     nAlmaSal = 1;
     nAlmaEnt = 1;
     nSwBarra = 1;
     &r_arti   = "";
     aAlfa   = "";
     aAlfa1  = "";
     nNume   = 0;
     nSwAct  = 0;
     nModo   = 0;
     nModif  = 0;

     operacion1= "MS";
     operacion2= "ME";
     entrad = 0;
     nEsKit = 0;
     &nDispoKit = 0;

     aDirConta  = "";

     aCmpClv1   = "";
     aCmpClv2   = "";
     aCmpClv3   = "";
|FIN;

|INCLUYE i_varart;
|INCLUYE i_cdbarr;

|PROCESO dsm00068;
     #68#4 = #0#1;
     #68#9 = #0#5;
     |GRABA 020#68a;
|FPRC;

|DEFBUCLE ModiAlmaKit;
     #68#1;
     ;
     #0#28, #0#27, #0#11, 001;
     #0#28, #0#27, #0#11, 999;
     be;
     NULL, dsm00068;
|FIN;

|PROCESO MinAlma55;
     #2#0 = #0#0;
     #2#1 = 1;
|FPRC;

|PROCESO MaxAlma55;
     #2#0 = #0#0;
     #2#1 = 99999;
|FPRC;

|PROCESO Stock; |TIPO 0;
     |SI FSalida = 13; || F5;
          |ABRE #2;
          #2#0 = #0#0;
          #2#1 = #0Campo;
          |LEE 000#2];
          |CONSULTA_F_CLAVE #1#2, MinAlma55, MaxAlma55;
          |SI FSalida = 0;
               #0Campo = #2#1; |PINTA #0Campo;
          |SINO;
               |ERROR; |ACABA;
          |FINSI;
          |CIERRA #2;
     |FINSI;

     nAlmaSal = #0#1;
     nAlmaEnt = #0#5;
     |ABRE #1;
     |ABRE #2;
     |ABRE #3;
     #1#0 = #0#0;
     |LEE 000#1=;
     #0#7 = #1#104;  |PINTA #0#7;
     #0#14 = #1#193; |PINTA #0#14;
     #0#23 = #1#180;

     #2#0 = #0#0;
     #2#1 = #0#1;
     |LEE 000#2=;
     #0#3 = #2#39;  |PINTA #0#3;
     #0#12 = #2#48; |PINTA #0#12;

     #2#1 = #0#5;
     |LEE 000#2=;
     #0#6 = #2#39;  |PINTA #0#6;
     #0#13 = #2#48; |PINTA #0#13;

     |SI #0#23 = "S";
          #3#0 = #0#0;
          #3#1 = #0#1;
          #3#2 = #0#16;
          |LEE 000#3=;
          #0#19 = #3#22; |PINTA #0#19;
          #0#20 = #3#23; |PINTA #0#20;

          #3#1 = #0#5;
          #3#2 = #0#17;
          |LEE 000#3=;
          #0#21 = #3#22; |PINTA #0#21;
          #0#22 = #3#23; |PINTA #0#22;
     |FINSI;

     |CIERRA #1;
     |CIERRA #2;
     |CIERRA #3;

     |SI Campo < 16;
          |HAZ cierre;
     |FINSI;
|FPRC;

|PROCESO BorraCompo;
     |SI nSwAct = 0;
         enForma      = entrad;
         eaTipo       = "T4";
         eaSerie      = #0#28;
         enCodigo     = #0#27;
         enLinea      = #0#11;
         eaArticulo   = #0#0;
         enAlmacen    = #0#1;
         enAlmacenEnt = #0#5;
         enUnidades   = #905#6 * enForma;
         eaComponente = #905#4;
         efFecha      = #0#8;
         enCodHisto   = #0#27;
         |LIBERA #905;
         |SUB_EJECUTA_NP "dsz00002;MEA";
     |SINO;
         |BORRA 020#905a;
         |LIBERA #905;
     |FINSI;
|FPRC;

|DEFBUCLE dsm00005;
     #905#1;
     ;
     "T4", #0#28, #0#27, #0#11, "      ";
     "T4", #0#28, #0#27, #0#11, "zzzzzz";
     be;
     NULL, BorraCompo;
|FIN;

|PROCESO Tipo5; |TIPO 5;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo [ 2; |Y nSwBarra = 1;
          |CONFI "0000NIntroduccion por Codigo de Barras";
          nSwBarra = FSalida;
     |FINSI;
     |HAZ SinBarra;
|FPRC;

|PROCESO Tipo2; |TIPO 2;
     entrad  = 0 +. 1;
     nModo = (FEntrada / 100) ! 0;

     enCodigo = #0#27;
     enForma = 0 +. 1;
     |SI nSwBarra = 0; |Y nModo = 1; |Y enForma = 1; |Y #1#176 = "S";
          |HAZ GrabaElemento;
     |FINSI;
     |BUCLE ModiAlmaKit;
     |HAZ AcumulaME_MS;

     |SI nModo = 3;
         nSwAct  = 0;  |BUCLE dsm00005;
         nSwAct  = 1;  |BUCLE dsm00005;
         |HAZ BorraKit;
     |SINO;
         nSwAct  = 0;  |BUCLE dsm00005;
     |FINSI;
|FPRC;

|PROCESO Tip6; |TIPO 6;
     |ABRE #6;
     |SELECT #2#6;
     #6#3=#0#0;
     |LEE 010#6=;
     |SI FSalida = 0; |Y #0#0 ! #6#1;
         #0#0 = #6#1;
         |ERROR;
         |PINTA #0#0;
     |FINSI;
     |CIERRA #6;
     r_arti = "";
|FPRC;

|PROCESO CogeUni; |TIPO 7;
     |HAZ DobleUniME_MS;
     |C_M #0#4, 1, "S";
     |SI eaSw2Stock = "S"; |O #1#176 = "S";
          |SI nSwBarra ! 0;
               |C_M #0#4, 1, "N";
          |FINSI;
     |FINSI;
     |SI eaSw2Stock = "S";
          |HAZ Stock;
     |FINSI;
|FPRC;

|PROCESO Unid055; |TIPO 0;
     #0#4 = #0#4 ! #11#8;
     |PINTA #0#4;

     |SI eaSw2Stock = "S"; |ACABA; |FINSI;

     |SI nEsKit = 0;
          |HAZ DispoKit;
          |SI nDispoKit ! 0;
               |SI #142#100 ! "N";
                    |MENAV "0000Superado Stock para KIT.";
                    |SI #142#100 = "X"; |ERROR; |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          |ABRE #1;
          #1#0 = #0#0;
          |LEE 000#1=;
          |CIERRA #1;

          |ABRE #2;
          #2#0 = #0#0;
          #2#1 = #0#1;
          |LEE 000#2=;
          |CIERRA #2;

          |SI #1#180 = "N";
               |SI #142#100 ! "N";
                    |SI #2#39 < #0#4;
                         aAlfa = "0000Supera el Stock disponible: " + #2#39;
                         |MENAV aAlfa;
                         |SI #142#100 = "X"; |ERROR; |FINSI;
                    |FINSI;
                    nStock = #2#5 - #0#4;
                    |SI #2#6 > nStock;
                         aAlfa =  "0000Supera el Stock minimo: " + #2#6;
                         |MENAV aAlfa;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CogeValores075;  |TIPO 7;

     |SI #1#176 = "N";  |ACABA;  |FINSI;

     |SI Campo = 4;
         |SI enUnidades ! 0;
             |SI #0#4 ! enUnidades;  Contenido = #0#4;  |FINSI;
             #0#4 = enUnidades;  |PINTA #0#4;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO PideArt075;  |TIPO 7;
     |C_M #0#0, 1, "S";

     |SI #0#0 ! "                    ";
         |ABRE #1;
         #1#0 = #0#0;
         |LEE 000#1=;
         |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;
         |CIERRA #1;
         |SI #1#176 = "S";
             |C_M #0#0, 1, "N";
             |ACABA;
         |FINSI;
     |FINSI;

     |ABRE #910;
     |LEE 040#910p;
     |SI FSalida ! 0;  |DDEFECTO #910;  |FINSI;
     |CIERRA #910;

     |SI #910#2 [ 2;    |ACABA;  |FINSI;

     eAlfa = #0Campo;
     |SUB_EJECUTA_NP "dsz99990";                 || Por Pantalla

     |SI eAlfa = "-1";  |PTEC 807;  |ACABA;  |FINSI;
     |SI eAlfa = "-2";              |ACABA;  |FINSI;

     eaArticulo = eAlfa;      ||  700000-4215

     #0Campo = eAlfa;
     |PINTA #0Campo;
     |PTEC 802;
|FPRC;

|PROCESO Calc6075;  |TIPO 6;
     |C_M #0#4,  1, "S";
     nModo = (FEntrada / 100) ! 0;
     |SI #0Campo ! Contenido; |Y Campo = 0;
          eaArticulo = #0#0;
          |HAZ DefectoMediC;
          #0#24 = enMedida1;
          #0#25 = enMedida2;
          #0#26 = enMedida3;
     |FINSI;
     |SI nSwBarra = 0; |Y nModo = 1;
          eaArti = #0#0;
          |HAZ HallaArti;
          |SI eaArti = ""; |ERROR; |ACABA; |FINSI;
          |SI #1#176 = "S"; |Y eaEleme = "";
               |MENAV "0000Codigo incompleto...";
               |ERROR; |ACABA;
          |FINSI;
          #0#0 = eaArti;
          |ACABA;
     |FINSI;

     enAlta = 1;
     eaArticulo = #0Campo;
     |HAZ LlenaArticulo;
     |SI FSalida = 0;
          #0Campo = eaArticulo;
          |PINTA #0Campo;
     |SINO;
          |ERROR; |ACABA;
     |FINSI;

     |ABRE #910;|LEE 000#910p;|CIERRA #910;
     |SI #910#1 ! "S";
          |C_M #0#4,  1, "S";
     |FINSI;

     |HAZ Tip6;
     |HAZ SacaKit;
|FPRC;

|PROCESO MaxPar1;
     #3#0 = #0#0;
     #3#1 = #0#1;
     #3#2 = "z" * 30;
|FPRC;

|PROCESO MinPar1;
     #3#0 = #0#0;
     #3#1 = 1;
     #3#2 = " " * 30;
|FPRC;

|PROCESO MaxPar2;
     #3#0 = #0#0;
     #3#1 = #0#5;
     #3#2 = "z" * 30;
|FPRC;

|PROCESO MinPar2;
     #3#0 = #0#0;
     #3#1 = #0#5;
     #3#2 = " " * 30;
|FPRC;

|PROCESO Partida; |TIPO 6;
|ACABA; ||*****

     |SI Campo = 16;
          |SI FSalida = 18; ||F10
               |ABRE #3;
               #3#0 = #0#0;
               #3#1 = #0#1;
               #3#2 = #0#16;
               |LEE 000#3];
               |CONSULTA_F_CLAVE #1#3, MinPar1, MaxPar1;
               |SI FSalida = 0;
                    #0#16 = #3#2; |PINTA #0#16;
               |SINO;
                    |ERROR; |ACABA;
               |FINSI;
               |CIERRA #3;
          |FINSI;
          |SI FSalida = 9; ||F2;
               eaArticulo = #0#0;
               enAlmacen = #0#1;
               efFecha = #54#1;
               |HAZ ConsultaPartida;
               |SI eaPartida = "";
                    |ERROR; |ACABA;
               |SINO;
                    #0#16 = eaPartida; |PINTA #0#16;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI Campo = 17;
          |SI FSalida = 18; ||F10
               |ABRE #3;
               #3#0 = #0#0;
               #3#1 = #0#5;
               #3#2 = #0#17;
               |LEE 000#3];
               |CONSULTA_F_CLAVE #1#3, MinPar2, MaxPar2;
               |SI FSalida = 0;
                    #0#17 = #3#2; |PINTA #0#17;
               |SINO;
                    |ERROR; |ACABA;
               |FINSI;
               |CIERRA #3;
          |FINSI;
          |SI FSalida = 9; ||F2;
               nGuardaAlma = enAlmacen;
               eaArticulo = #0#0;
               enAlmacen = #0#5;
               efFecha = #54#1;
               |HAZ ConsultaPartida;
               |SI eaPartida = "";
                    enAlmacen = nGuardaAlma;
                    |ERROR; |ACABA;
               |SINO;
                    #0#16 = eaPartida; |PINTA #0#16;
               |FINSI;
               enAlmacen = nGuardaAlma;
          |FINSI;
     |FINSI;

     |SI #11#122 = "S"; |Y #1#180 = "S";
          aAlfa = #0Campo; |QBF aAlfa;
          aAlfa = (#11#121 * #11#120) + aAlfa;
          nNume = -(#11#120 + 100);
          #0Campo = aAlfa % nNume; |PINTA #0Campo;
     |FINSI;
|FPRC;

|PROCESO Tipo0075;
     nModo = (FEntrada / 100) ! 0;
     |SI nSwBarra ! 0;
          |QBF r_arti;
          |SI r_arti ! "";
               #0#0 = r_arti;
               |PINTA #0#0;
          |FINSI;
     |FINSI;
     aAlfa = "0410Descripcion: " + #0#2;
     |MENSA aAlfa;
/*****
     |SI #1#180 = "N";
          |C_M #0#16, 1, "N";
          |C_M #0#17, 1, "N";
          |MODO_RELACION #0, 1, "dsm00024", "N", "N";
     |SINO;
          |C_M #0#16, 1, "S";
          |C_M #0#17, 1, "S";
          |MODO_RELACION #0, 1, "dsm00024", "S", "S";
     |FINSI;
****/
     eaArticulo = #dsm00055#0;
     |HAZ EsKit;
     nEsKit = FSalida;

     |HAZ Tipo55_13;
|FPRC;

|PROCESO Tipo11075;  |TIPO 11;
     nTecla = FSalida;
     |SI nTecla = 7;  |Y #1#176 = "S";
         |MENAV "      Imposible abortar;  Termine de introducir la linea y efectue una Baja.";
         |ERROR;
     |FINSI;
     |SI nTecla = 13;
          |HAZ VerDobleUniME_MS;
          |HAZ VerKit;
          |ERROR;
     |FINSI;
     |SI nTecla = 25; || Ctrl-F7
          |HAZ CreaTempo;
          eaFichero = Tempo;
          |SUB_EJECUTA_NP "psion066";
          |HAZ BoraTempo;
          |SI enError = 0; |HAZ ImportaPDA55; |FINSI;
          |ERROR; |ACABA;
     |FINSI;
|FPRC;

|PROCESO PideVerti;
     nModo = (FEntrada / 100) ! 0;
     |SI nSwBarra = 0; |Y nModo = 1; |ACABA; |FINSI;

     |ABRE #1;
     #1#0 = #0#0;
     |LEE 000#1=;
     |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;
     |CIERRA #1;

     |SI #1#176 = "S";
         eaTipo       = "T4";
         eaSerie      = #0#28;
         enCodigo     = #0#27;
         enLinea      = #0#11;
         eaArticulo   = #0#0;
         enAlmacen    = #0#1;
         enAlmacenEnt = #0#5;
         enTarifa     = 1;
         enUnidades   = #0#4;
         efFecha      = #0#8;
         |SUB_EJECUTA_NP "dsz00002";

         #0#4 = enUnidades;  |PINTA #0#4;

         |C_M #0#4,  1, "N";

     |FINSI;
|FPRC;

|PROCESO ClaveBaja;
     #0#11 = 1;
|FPRC;

|PROCESO ClaveAlta;
     #0#11 = 99;
|FPRC;

|PROCESO cierre;
     |SI Campo = 1;
          efFec = #0#8;
          enAlma = #0#1;
          |HAZ MiraHisL;
          |SI enErrHis = 0; |HAZ MiraStockIni; |FINSI;
          |SI enErrHis ! 0;
               |ERROR;
               |ACABA;
          |FINSI;
     |FINSI;
     |SI Campo = 5;
          efFec = #0#8;
          enAlma = #0#5;
          |HAZ MiraHisL;
          |SI enErrHis ! 0;
               |ERROR;
               |ACABA;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaElemento;
     |ABRE #914;
     #914#0 = eaEleme;
     |LEE 000#914=;
     |CIERRA #914;

     |ABRE #905;
     |DDEFECTO #905;
     #905#0 = "T4";
     #905#1 = #0#28;
     #905#2 = #0#27;
     #905#3 = #0#11;
     #905#4 = eaEleme;
     #905#5 = #914#1;
     #905#6 = #0#4;
     |GRABA 020#905n;
|FPRC;

|PROCESO DefectoAlm; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
          #0#1 = nAlmaSal;
          #0#5 = nAlmaEnt;
          |PINTA #0#1;
          |PINTA #0#5;
     |FINSI;
|FPRC;

|PROCESO ImportaPDA55;
     |DDEF aAlfa; aAlfa = aAlfa + "dsm00055";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;
     |ABRE #referen@;
     #referen@#28 = #54#2;
     #referen@#27 = #54#0;
     #referen@#11 = 99999;
     |LEE 000#referen@.];
     |SI FSalida = 0;
          |LEE 000#referen@.a;
     |SINO;
          |LEE 000#referen@.u;
     |FINSI;
     |SI FSalida = 0; |Y #referen@#28 = #54#2; |Y #referen@#27 = #54#0;
          nLin = #referen@#11 + 1;
     |SINO;
          nLin = 1;
     |FINSI;
     |CIERRA #referen@;
     |DESCARGA_DEF #referen@;

     |DDEF aAlfa; aAlfa = aAlfa + "psion067";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0; |ACABA; |FINSI;
     |NOME_DAT #referen@#eaFichero#;
     |ABRE #referen@;
     |LEE 000#referen@.p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          #0#28 = #54#2;
          #0#27 = #54#0;
          #0#11 = nLin;
          |GRABA 020#0b;
          #0#0 = #referen@#0; ||Arti
          #0#2 = #referen@#1; ||Des
          #0#1 = #referen@#7; ||AlmaSal
          #0#5 = #referen@#8; ||AlmaEnt
          #0#4 = #referen@#3; ||Uni
          #0#16 = #referen@#9; ||Parti
          #0#17 = #referen@#9; ||Parti
          FEntrada = 100;     ||simula alta
          |HAZ Tipo2;
          |GRABA 020#0a;
          |LIBERA #0;
          nLin = nLin + 1;
          |LEE 000#referen@.s;
     |SIGUE;
     |CIERRA #referen@;
     |DELINDEX #referen@;
     |DESCARGA_DEF #referen@;
     |PONCONTROL 23, "SI"
     |PTEC 809;
     |PTEC 808;
|FPRC;

|PROCESO DefAlmaSal; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
          |ABRE #7;
          #7#26 = #0#28;
          |LEE 020#7=;
          |CIERRA #7;
          |SI enPrime = 0;
               enPrime = 1;
               #0#1 = #7#29;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Alma55_66; |TIPO 66;
     |ABRE #29;
     #29#0 = #0Campo;
     |LEE 000#29];
     |CONSULTA_CLAVE #1#29;
     |SI FSalida = 0;
          #0Campo = #29#0;
          |PINTA #0Campo;
     |SINO;
          |ERROR;
     |FINSI;
     |CIERRA #29;
|FPRC;

|PROCESO Tipo55_13; |TIPO 13;
     |ABRE #1;
     #1#0 = #0#0;
     |LEE 000#1=;
     |CIERRA #1;

     |PINTA 2216, #19#1;
|FPRC;
