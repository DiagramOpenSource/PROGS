           CreaAlbaran y CreaFactura

|FICHEROS;
     tagm0030 #0;
     tagm0031 #1;
     tagm0032 #2,MANTE;
     tagmpara #3;
     agifa007 #7;
     agifa010 #10;
     agifa017 #17;
     agifa019 #19;
     dsm00020 #20;
     agifa024 #24;
     agifa025 #25;
     tagm0051 #51; || Asistente Impresion
     agifa069 #69;
     agifa084 #84;
     agifa071 #71;
     agifa142 #142;
     dsm00238 #238;
     agifa321 #321;
     agifa324 #324;
     tagm0021 #21;
     tagm0080 #80;

     tagm0031@;
     tagm0032@;
|FINSI;

|INCLUYE i_varart;

|VARIABLES;
     &fec_alb  = @;
     &abo_alb  = "";
     aPath = "";
     &enTotal = 0;
     &enDesdeLin = 0;
     &enDesde = 0;
     &eaSerAlb = "";
     &enNumAlb = 0;
     &eaSerBlc = "";
     &enNumBlc = 0;
     &eaTag = "";
     nSwVar = 0;
     nAlma = 0;
     aArti = "";
     nUniVario1 = 0;
     nUniVario2 = 0;
     nSwCalTota = 0;
     aPertura = "";
     nTipo = 0;
     aTipoGalce = "";
     aGalce = "";
     aHerraje = "";
     aMBlock = "";
     aMCris = "";
     aPuerta = "";
     nMedi1 = 0;
     nMedi2 = 0;
     nMedi3 = 0;
     aEsPuerta = "";
     nAge = 0;
     nFactu = 0;
     nUniFacGalce = 0;
     nUniFacPue1 = 0;
     nUniFacPue2 = 0;
     nUniFacPica = 0;
     nUniFacPer1 = 0;
     nUniFacPer2 = 0;
     nUniFacCerra = 0;
     nUniFacBisa = 0;
     nUniFacPasa = 0;
     nUniFacMbloc = 0;
     nUniFacCris = 0;
     nDto = 0;
     nDto2 = 0;
     nTotal = 0;
     &aMoneda = "";
     &aDivisa = "";
     nLinAsistente = 0;
     importe = 0;
     cant = 0;
     retencion = 0;
     modo = 0;
     imneto = 0;
     nMargen = 0;
     nForma = 0;
     fmes = "";
     mes = 0;
     nImpo = 0;
     &serie = "";
     &numero = 0;
     &abono = "";
     &ser_alb = "";
     &num_alb = 0;
     &enSwMenu = 0;
     aAlfa = "";
     aSerie = "";
     nError = 0;
     aArt = "";
     aDes = "";
     nUni1 = 0;
     nUni2 = 0;
     nMed1 = 0;
     nMed2 = 0;
     nMed3 = 0;
     nPre = 0;
     aEsMoldura = "";
     nLin = 0;
     aDesBlock = "";
     aBlock = "";
     aTipoHerraje = "";
     nPrecio = 0;
     aLon = "";
|FIN;

|PROCESO AcumulaAlb;
     |SI #84#15 ] 0;
          importe = 1;
     |SINO;
          importe = -1;
          #84#15 = -#84#15;
     |FINSI;
     cant = #84#15 < #84#5;
     cant = cant < #84#32;
     cant = cant < #84#7;
     cant = cant * importe;
     #84#15 = #84#15 * importe;
     |ABRE #24;
     #24#0 = #84#3;
     |LEE 121#24=;
     |SI FSalida = 0;
        |SI #84#43 = AN;
           #24#50 = #24#50 +. cant;    || es albaran
        |SINO;
           #24#50 = #24#50 -. cant;    || es abono
        |FINSI;
        |GRABA 020#24a;
        |LIBERA #24;
     |FINSI;
     |CIERRA #24;

     |SI #84#43 = "N";
          enImpCliPen = cant * nForma;
     |SINO;
          enImpCliPen =  -cant * nForma;
     |FINSI;
     eaCliente = #84#3;
     efFecha = #84#1;
     |HAZ AcumulaCli;

     eaTag = "AV";  |HAZ Riesgos;
|FPRC;

|PROCESO ActArti;
     fmes = #84#1 % A402;
     mes = fmes - 1;
     mes = mes * 5;
     mes = mes + 35;
     #19#0 = #69#2;
     |LEE 101#19=;
     |SI FSalida = 0;
          |SI #19#194 = 2;
               nImpo = ((((#69#30 * #69#6) < #69#8) < #69#21) < #84#5) < #84#32;
          |SINO;
               nImpo = ((((#69#5 * #69#6) < #69#8) < #69#21) < #84#5) < #84#32;
          |FINSI;
          |SI #142#115 = "S";
               nImpo = nImpo < #84#7;
          |FINSI;
          nMargen = nImpo - #69#14;
          #19mes = #19mes + (nImpo * nForma);
          #19#95 = #19#95 + (nImpo * nForma);
          mes = mes + 1;
          #19mes = #19mes + (nMargen * nForma);
          #19#96 = #19#96 + (nMargen * nForma);
          |GRABA 020#19a;
     |FINSI;
     |LIBERA #19;

     efFecha = #84#1;
     eaArticulo = #69#2;
     enImpVta = (nImpo * nForma);
     enImpMar = (nMargen * nForma);
     |HAZ AcumulaArt;
|FPRC;

|PROCESO AcumulaFac;
     nForma = 0 +. 1;
     modo = (FEntrada / 100) ! 0;

     |ABRE #24;
     #24#0 = #84#3;
     |LEE 121#24=;
     |SI 0 = FSalida;
          fmes = #84#1 % A402;
          mes = fmes - 1;
          mes = mes * 4;
          mes = mes + 54;
          imneto = #84#15 - #84#25;
          |SI #142#115 = "N";
               nImpo = (imneto * 100) / (100 - #84#7);
               nDto = #84#25 + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
               nDto = #84#25;
          |FINSI;
          #24mes = #24mes +. nImpo; || imneto;
          mes = mes + 1;
          #24mes = #24mes +. nDto;  || #84#25;
          mes = mes + 1;
          #24mes = #24mes +. #84#37;
          #24#102 = #24#102 +. nImpo; || imneto;
          #24#103 = #24#103 +. nDto;  || #84#25;
          #24#104 = #24#104 +. #84#37;
          mes = FEntrada / 100;
          mes = mes ! 0;
          |SI 1 = mes;
               #24#45 = #84#1;
               #24#46 = imneto;
          |FINSI;
          #24#110 = #24#110 +. imneto;
          imneto = imneto + #84#24;
          |GRABA 020#24a;
          |LIBERA #24;

          enImpCliCom = nImpo * nForma;
          enImpCliDto = nDto * nForma;
          enImpCliMar = #84#37 * nForma;
          enImpCliFac = imneto * nForma;
          eaCliente = #84#3;
          efFecha = #84#1;
          |HAZ AcumulaCli;
     |FINSI;
     |CIERRA #24;

     |ABRE #25;
     #25#0 = #84#6;
     |LEE 121#25=;
     |SI 0 = FSalida;
           imneto = #84#15 - #84#25;
           fmes = #84#1 % A402;
           mes = fmes - 1;
           mes = mes * 2;
           mes = mes + 11;
           #25mes = #25mes +. #84#26;
           retencion = #25mes % #25#39;
           mes = mes + 1;
           #25mes = #25mes +. imneto;
           #25#35 = #25#35 +. #84#26;
           #25#36 = #25#36 +. imneto;
           mes = fmes - 1;
           mes = mes + 40;
           #25mes = retencion;
           retencion = #25#35 % #25#39;
           #25#52 = retencion;
           |GRABA 020#25a;
           |LIBERA #25;

          enImpRepComi = #84#26 * nForma;
          enImpRepVta = imneto * nForma;
          enImpRepRete = retencion * nForma;
          eaRepre = #84#6;
          efFecha = #84#1;
          |HAZ AcumulaRep;
     |FINSI;
     |CIERRA #25;
     ||***************** CALCULO DEL RIESGO;
     |ABRE #19;
     |BUCLELIN 2 ActArti #84;
     |CIERRA #19;
     |SI #142#47 = "S";  ||컴컴컴컴컴 Acumula en riesgos Si Crea Recibo
          eaTag = "FC";  |HAZ Riesgos;
     |FINSI;
|FPRC;

컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO CorrigeStock;
     |ABRE #19;
     |ABRE #17;
     #19#0 = aArt;
     |LEE 121#19=;
     |SI FSalida = 0;
          #17#0 = aArt;
          #17#1 = 1;
          |LEE 121#17=;
          |SI FSalida = 0;
||               #19#6 = #19#6 + nUni1;
||               #19#185 = #19#185 + nUni2;
               #19#104 = #19#104 + nUni1;
               #19#193 = #19#193 + nUni2;

               #19#15 = #19#15 - nUni1;
               #19#182 = #19#182 - nUni2;
               #19#12 = #19#12 - nUni1;

||               #17#5 = #17#5 + nUni1;
||               #17#47 = #17#47 + nUni2;
               #17#39 = #17#39 + nUni1;
               #17#48 = #17#48 + nUni2;

               #17#42 = #17#42 - nUni1;
               #17#44 = #17#44 - nUni2;
               #17#8 = #17#8 - nUni1;

               |HAZ ValoraStock;
               |GRABA 020#17a;
               |GRABA 020#19a;
          |FINSI;
     |FINSI;
     |CIERRA #17;
     |CIERRA #19;
|FPRC;

|PROCESO CreaCabFac;
     #84#48 = aSerie;
     enSwMenu = 1;
     |HAZ ContaFD7;
     |GRABA 020#84b;

     #0#25 = #84#48; |PINTA #0#25;
     #0#26 = #84#0; |PINTA #0#26;

     |ABRE #25;
     #25#0 = #0#4;
     |LEE 000#25=;
     |CIERRA #25;

     |ABRE #20;
     #20#0 = nAge;
     |LEE 000#20=;
     |CIERRA #20;

     #84#1 = ~;
     #84#3 = #0#3;
     #84#4 = #0#6;
     #84#6 = #0#4;
     #84#8 = #0#5;
     #84#9 = #20#1;
     #84#29 = #0#6;
     #84#30 = #0#18;
     #84#31 = #0#19;
     #84#33 = #0#20;
     #84#34 = #24#4;
     #84#36 = #24#47;
     #84#40 = #24#16;
     #84#60 = #0#34;
     #84#64 = (("00" + #0#21) % -102) + (("000" + #0#22) % -103)
     #84#65 = #24#192;
     #324#0 = #84#65;
     |LEE 000#324=;
     #84#66 = #324#2;
     #84#67 = #24#193;
     #84#68 = #321#9;
     #324#0 = #84#68;
     |LEE 000#324=;
     #84#69 = #324#2;
     #84#78 = nAge;
     #84#87 = #0#10;
     aMoneda = #84#67;
     aDivisa = #84#65;
     |HAZ Divisas084;
     |HAZ LimCabAgifa084;

     eaAlfa = #84#48;
     |HAZ TagloDefFP;
     |SI eaAlfa ! ""; #84#8 = eaAlfa; |FINSI;
     |SI eaQuitaDto = "S";
          #84#5 = 0;
          #84#32 = 0;
          #84#7 = 0;
     |FINSI;
|FPRC;


|PROCESO CreaLinFac;
     |QBF aArt;
     |SI aArt = ""; |ACABA; |FINSI;

     |ABRE #19;
     #19#0 = aArt;
     |LEE 000#19=;
     |CIERRA #19;

     nLin = nLin + 1;
     |DDEFECTO #69;
     #69#20 = #84#48;
     #69#0 = #84#0;
     #69#1 = nLin;
     #69#2 = aArt;
     #69#3 = 1;
     #69#4 = aDes;
     #69#5 = nUni1;
     #69#6 = nPre;
     #69#8 = nDto;
     #69#21 = nDto2;
     |SI #7#30 = "S";
          #69#11 = 0;
     |SINO;
          #69#11 = #19#30;
     |FINSI;
     #69#13 = "FMB";
     #69#14 = #69#5 * #19#9;
     #69#15 = #10#3;
     #69#17 = #24#4;
     #69#30 = nUni2;
     #69#33 = nMed1;
     #69#34 = nMed2;
     #69#35 = nMed3;

     |HAZ TotalLin69;
     |HAZ CalCabAgifa084;
     enForma = 1;
     |HAZ AcumulaFC;
     aArti = #69#2;
     nAlma = #69#3;
     nUniVario1 = #69#5;
     nUniVario2 = #69#30;
     |HAZ AcumuVarios;
     |SI nSwVar = 1; #69#43=9;|FINSI; ||Marca campo interno con 9
     |GRABA 020#69n;
|FPRC;

|PROCESO CreaCabAlb;
     #10#52 = aSerie;
     enSwMenu = 1;
     |HAZ ContaAV7;
     |GRABA 020#10b;

     #0#25 = #10#52; |PINTA #0#25;
     #0#26 = #10#0; |PINTA #0#26;

     |ABRE #25;
     #25#0 = #0#4;
     |LEE 000#25=;
     |CIERRA #25;

     |ABRE #20;
     #20#0 = nAge;
     |LEE 000#20=;
     |CIERRA #20;

     #10#1 = ~;
     #10#3 = #0#3;
     #10#4 = #0#6;
     #10#6 = #0#4;
     #10#8 = #0#5;
     #10#9 = #20#1;
     #10#29 = #0#6;
     #10#30 = #0#18;
     #10#31 = #0#19;
     #10#33 = #0#20;
     #10#36 = #24#47;
     #10#40 = #24#41;
     #10#62 = (("00" + #0#21) % -102) + (("000" + #0#22) % -103)
     #10#63 = #0#34;
     #10#68 = #24#192;
     #324#0 = #10#68;
     |LEE 000#324=;
     #10#69 = #324#2;
     #10#70 = #24#193;
     #10#73 = #321#9;
     #324#0 = #10#73;
     |LEE 000#324=;
     #10#74 = #324#2;
     #10#83 = #0#10;
     #10#88 = #20#0;
     aMoneda = #10#70;
     aDivisa = #10#68;
     |HAZ Divisas010;
     |HAZ LimCabAgifa010;

     eaAlfa = #84#52;
     |HAZ TagloDefFP;
     |SI eaAlfa ! ""; #84#8 = eaAlfa; |FINSI;
     |SI eaQuitaDto = "S";
          #84#5 = 0;
          #84#32 = 0;
          #84#7 = 0;
     |FINSI;
|FPRC;

|PROCESO CreaLinAlb;
     |QBF aArt;
     |SI aArt = ""; |ACABA; |FINSI;

     |ABRE #19;
     #19#0 = aArt;
     |LEE 000#19=;
     |CIERRA #19;

     nLin = nLin + 1;
     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = nLin;
     #71#2 = aArt;
     #71#3 = 1;
     #71#4 = aDes;
     #71#5 = nUni1;
     #71#6 = nPre;
     #71#8 = nDto;
     #71#33 = nDto2;
     |SI #7#30 = "S";
          #71#11 = 0;
     |SINO;
          #71#11 = #19#30;
     |FINSI;
     #71#13 = "FMB";
     #71#14 = #71#5 * #19#9;
     #71#15 = #10#3;
     #71#17 = #24#4;
     #71#48 = nUni2;
     #71#51 = nMed1;
     #71#52 = nMed2;
     #71#53 = nMed3;
     |HAZ TotalLin71;
     |SI nSwCalTota = 0;
          |HAZ CalCabAgifa010;
          enForma = 1;
          |HAZ AcumulaAV;
          aArti = #71#2;
          nUniVario1 = #71#5;
          nUniVario2 = #71#48;
          |HAZ AcumuVarios;
          |SI nSwVar = 1; #71#61=9;|FINSI; || Marca Campo interno con 9
          |GRABA 020#71n;
     |FINSI;
|FPRC;

|PROCESO CreaLineas;
     |SI nSwCalTota ! 0; ||Se usa el albaran para calcular
          |SI nSwCalTota = 1;
               nDto = 0;      ||sin dto
               nDto2 = 0;
          |FINSI;
          |HAZ CreaLinAlb;
          |SI aArt ! "";
               enBruto = enBruto + #71#9;

               eaCli = #0#3; enTiva = #71#11; efFiva = #0#2; |HAZ IVACli;
               enTotal = enBruto + (enBruto % enIva);
               |SI #24#47 = "S";
                    enTotal = enTotal + (enBruto % enRec);
               |FINSI;
          |FINSI;
     |SINO;
          |SI #0#24 = "A";
               |HAZ CreaLinAlb;
          |SINO;
               |HAZ CreaLinFac;
          |FINSI;
          |HAZ CorrigeStock;
     |FINSI;
|FPRC;

|PROCESO Asistente;
     aAlfa = #0#0; |QBF aAlfa;
     |SI aAlfa = "";
          aBlock = "00";
     |SINO;
          aBlock = #0#0 % 102;
     |FINSI;
     aAlfa = ("000000" + #1#1) % -106;
     aBlock = aBlock + aAlfa;
     aAlfa = #1#38 % -105;
     aBlock = aBlock + aAlfa;
     aTipoHerraje = "";
     |ABRE #19;
     |SI #1#23 > 0;
          #19#0 = #1#24;
          |LEE 000#19=;
          |SI FSalida = 0; aTipoHerraje = #19#113; |FINSI;
     |FINSI;
     |SI aTipoHerraje = ""; |Y #1#26 > 0;
          #19#0 = #1#27;
          |LEE 000#19=;
          |SI FSalida = 0; aTipoHerraje = #19#113; |FINSI;
     |FINSI;
     |SI aTipoHerraje = ""; |Y #1#29 > 0;
          #19#0 = #1#30;
          |LEE 000#19=;
          |SI FSalida = 0; aTipoHerraje = #19#113; |FINSI;
     |FINSI;
     |SI aTipoHerraje = ""; |Y #1#32 > 0;
          #19#0 = #1#33;
          |LEE 000#19=;
          |SI FSalida = 0; aTipoHerraje = #19#113; |FINSI;
     |FINSI;
     |SI aTipoHerraje = ""; |Y #1#35 > 0;
          #19#0 = #1#36;
          |LEE 000#19=;
          |SI FSalida = 0; aTipoHerraje = #19#113; |FINSI;
     |FINSI;
     |CIERRA #19;

     |SI #1#12 = "P"; aEsPuerta = "S"; |SINO; aEsPuerta = "N"; |FINSI;
     ||------------
     nTipo = 0;
     nMedi1 = 0;
     nMedi2 = 0;
     nMedi3 = 0;
     aTipoGalce = #1#6; |QBF aTipoGalce;
     aGalce = #1#7; |QBF aGalce;
     aHerraje = #1#24 + #1#27 + #1#30 + #1#33 + #1#36; |QBF aHerraje;
     aMBlock = #1#43; |QBF aMBlock;
     aMCris = #1#52; |QBF aMCris;
     aPuerta = #1#17; |QBF aPuerta;
     aPertura = "";
     |SI #1#5 = "S";
          |SI aTipoGalce = ""; |Y #1#41 = 0; |Y aGalce  = ""; |Y aHerraje = "";
                    |Y aMBlock = ""; |Y aPuerta ! ""; |Y aMCris ! "";
               nTipo = 1;
          |FINSI;
          aAlfa = aGalce + aHerraje; |QBF aAlfa;
          |SI aTipoGalce ! ""; |Y #1#41 ! 0; |Y aAlfa ! ""; |Y aPuerta ! "";
                    |Y aMBlock ! ""; |Y aMCris = "";
               nTipo = 2;
               |SI #1#22 = "I";
                    aPertura = " Izquierda";
               |SINO;
                    aPertura = " Derecha";
               |FINSI;
          |FINSI;
          |SI aTipoGalce ! ""; |Y #1#41 ! 0; |Y aAlfa ! ""; |Y aPuerta ! "";
                    |Y aMBlock ! ""; |Y aMCris ! "";
               nTipo = 3;
               |SI #1#22 = "I";
                    aPertura = " Izquierda";
               |SINO;
                    aPertura = " Derecha";
               |FINSI;
          |FINSI;

          |SI nTipo = 1;
               aBlock = #1#17;
               aDesBlock = "CRIS " + #1#18;
               nMedi1 = #1#20;
               nMedi2 = #1#19;
               nMedi3 = #1#21;
          |FINSI;
          |SI nTipo = 2; |O nTipo = 0;
               aAlfa = #1#14 + "x" + #1#13 + " ";
               aAlfa = aAlfa + #1#9 + "x" + #1#10;
               aDesBlock = "BLOCK " + #1#18; |QBF aDesBlock;
               aDesBlock = aDesBlock + " " + aAlfa;
          |FINSI;
          |SI nTipo = 3;
               aAlfa = #1#14 + "x" + #1#13 + " ";
               aAlfa = aAlfa + #1#9 + "x" + #1#10;
               aDesBlock = "BLOCK CRIS " + #1#18; |QBF aDesBlock;
               aDesBlock = aDesBlock + " " + aAlfa;
          |FINSI;
     |SINO;
          |SI aMBlock ! ""; |Y aMCris = "";
               nTipo = 1;
               |SI #1#22 = "I";
                    aPertura = " Izquierda";
               |SINO;
                    aPertura = " Derecha";
               |FINSI;
          |FINSI;
          |SI aMBlock ! ""; |Y aMCris ! "";
               nTipo = 2;
               |SI #1#22 = "I";
                    aPertura = " Izquierda";
               |SINO;
                    aPertura = " Derecha";
               |FINSI;
          |FINSI;

          |SI nTipo = 1; |O nTipo = 0;
               aAlfa = #1#14 + "x" + #1#13 + " ";
               aAlfa = aAlfa + #1#9 + "x" + #1#10;
               aDesBlock = "BLOCK DOBLE " + #1#18; |QBF aDesBlock;
               aDesBlock = aDesBlock + " " + aAlfa;
          |FINSI;
          |SI nTipo = 2;
               aAlfa = #1#14 + "x" + #1#13 + " ";
               aAlfa = aAlfa + #1#9 + "x" + #1#10;
               aDesBlock = "BLOCK CRIS DOBLE " + #1#18; |QBF aDesBlock;
               aDesBlock = aDesBlock + " " + aAlfa;
          |FINSI;
     |FINSI;
     |QBF aDesBlock;
     aDesBlock = aDesBlock + aPertura;
     ||------------
     nPrecio = (#1#58*nUniFacGalce) + #1#59 + #1#88;
     nPrecio = nPrecio + (#1#60*nUniFacPica);
     nPrecio = nPrecio + (#1#61*nUniFacPer1) + (#1#92*nUniFacPer2);
     nPrecio = nPrecio + (#1#62*nUniFacCerra);
     nPrecio = nPrecio + (#1#63*nUniFacBisa);
     nPrecio = nPrecio + (#1#64*nUniFacPasa);
     nPrecio = nPrecio + (#1#45*nUniFacMbloc);
     nPrecio = nPrecio + (#1#54*nUniFacCris);

     aAlfa = #1#43 + #1#52; |QBF aAlfa;
     |QBT aAlfa;
     |SI aAlfa = "";
          aBlock = #1#17;
          aDesBlock = #1#18;
     |FINSI;

     nLinAsistente = nLinAsistente + 1;
     |DDEFECTO #51;
     #51#14 = #0#24;
     #51#0 = #0#25;
     #51#1 = #0#26;
     #51#2 = nLinAsistente;
     |LEE 101#51=;
     |SI FSalida ! 0; |GRABA 020#51b; |FINSI;

     |SI aEsMoldura = "N";
          #51#3 = aBlock;
          #51#4 = aDesBlock;
          #51#5 = #1#3;
          #51#6 = nMedi1;
          #51#7 = nMedi2;
          #51#8 = nMedi3;
          #51#9 = nPrecio;
          #51#10 = #0#7;
          #51#16 = #0#30;
          nTotal = #51#5 * #51#9;;
          nTotal = nTotal - (nTotal * #51#10 / 100)
          nTotal = nTotal - (nTotal * #51#16 / 100)
          #51#11 = nTotal;
          #51#12 = #1#0;
          #51#13 = #1#1;
          #51#15 = aEsPuerta;
          |GRABA 020#51a;
          |LIBERA #51;

          aLon = aDesBlock % A0;
          |PARA; |SI aLon > 70; |HACIENDO;
               aDesBlock = aDesBlock % 71;
               nLinAsistente = nLinAsistente + 1;
               |PDEFECTO #51, 3, 12;
               #51#2 = nLinAsistente;
               #51#4 = aDesBlock;
               |GRABA 020#51n;
               aLon = aDesBlock % A0;
          |SIGUE;
     |SINO;
          #51#3 = #2#3;
          #51#4 = #2#4;
          #51#5 = #2#5;
          #51#6 = #2#7;
          #51#7 = #2#8;
          #51#8 = #2#9;
          #51#9 = #2#12;
          #51#10 = #0#7;
          #51#16 = #0#30;
          |SI nFactu = 1;
               nTotal = #2#5 * #51#9;
          |SINO;
               nTotal = #2#6 * #51#9;
          |FINSI;
          nTotal = nTotal - (nTotal * #51#10 / 100)
          nTotal = nTotal - (nTotal * #51#16 / 100)
          #51#11 = nTotal;
          #51#12 = #1#0;
          #51#13 = #1#1;
          #51#15 = "N";
          |GRABA 020#51a;
          |LIBERA #51;
     |FINSI;
|FPRC;

|PROCESO LasMedidas;
     nFactu = 1;         ||Por defecto se factura con la unidad 1
     nUni2 = 0;
     nMed1 = 0;
     nMed2 = 0;
     nMed3 = 0;
     |ABRE #19;
     #19#0 = aArt;
     |LEE 000#19=;
     |CIERRA #19;
     |SI #19#179 = "S";
          nMed1 = #19#189;
          nMed2 = #19#190;
          nMed3 = #19#191;
          |SI #19#188 = 0; nUni2 = nUni1; |FINSI;
          |SI #19#188 = 1; nUni2 = nUni1 * nMed1; |FINSI;
          |SI #19#188 = 2; nUni2 = nUni1 * nMed1 * nMed2; |FINSI;
          |SI #19#188 = 3; nUni2 = nUni1 * nMed1 * nMed2 * nMed3; |FINSI;
          |ABRE #238;
          #238#0 = #19#201;
          |LEE 000#238=;
          |CIERRA #238;
          nFactu = #238#6;
     |FINSI;
|FPRC;

|PROCESO LinBlock;
     aEsMoldura = "N";

     aArt = #1#7;
     aDes = #1#8;
     nPre = #1#58;
     nUni1 = #1#3 * #1#40;
     nDto = #0#7;
     nDto2 = #0#30;
     |HAZ LasMedidas;
     |SI nFactu = 1; nUniFacGalce = nUni1/#1#3; |SINO; nUniFacGalce = nUni2/#1#3; |FINSI;
     |HAZ CreaLineas; ||Galce

     aArt = #1#17;
     aDes = #1#18;
     nPre = #1#59;
     nUni1 = #1#3;
     nDto = #0#7;
     nDto2 = #0#30;
     |HAZ LasMedidas;
     nMed1 = #1#20;
     nMed2 = #1#19;
     nMed3 = #1#21;
     |SI #19#188 = 0; nUni2 = nUni1; |FINSI;
     |SI #19#188 = 1; nUni2 = nUni1 * nMed1; |FINSI;
     |SI #19#188 = 2; nUni2 = nUni1 * nMed1 * nMed2; |FINSI;
     |SI #19#188 = 3; nUni2 = nUni1 * nMed1 * nMed2 * nMed3; |FINSI;
     |SI nFactu = 1; nUniFacPue1 = nUni1/#1#3; |SINO; nUniFacPue1 = nUni2/#1#3; |FINSI;
     |HAZ CreaLineas; ||Puerta

     aArt = #1#81;
     aDes = #1#82;
     nPre = #1#88;
     nUni1 = #1#3;
     nDto = #0#7;
     nDto2 = #0#30;
     |HAZ LasMedidas;
     nMed1 = #1#86;
     nMed2 = #1#85;
     nMed3 = #1#87;
     |SI #19#188 = 0; nUni2 = nUni1; |FINSI;
     |SI #19#188 = 1; nUni2 = nUni1 * nMed1; |FINSI;
     |SI #19#188 = 2; nUni2 = nUni1 * nMed1 * nMed2; |FINSI;
     |SI #19#188 = 3; nUni2 = nUni1 * nMed1 * nMed2 * nMed3; |FINSI;
     |SI nFactu = 1; nUniFacPue2 = nUni1/#1#3; |SINO; nUniFacPue2 = nUni2/#1#3; |FINSI;
     |HAZ CreaLineas; ||Puerta2

     aArt = #1#24;
     aDes = #1#25;
     nPre = #1#60;
     nUni1 = #1#3 * #1#23;
     nDto = #0#7;
     nDto2 = #0#30;
     |HAZ LasMedidas;
     |SI nFactu = 1; nUniFacPica = nUni1/#1#3; |SINO; nUniFacPica = nUni2/#1#3; |FINSI;
     |HAZ CreaLineas; ||Picaporte

     aArt = #1#27;
     aDes = #1#28;
     nPre = #1#61;
     nUni1 = #1#3 * #1#26;
     nDto = #0#7;
     nDto2 = #0#30;
     |HAZ LasMedidas;
     |SI nFactu = 1; nUniFacPer1 = nUni1/#1#3; |SINO; nUniFacPer1 = nUni2/#1#3; |FINSI;
     |HAZ CreaLineas; ||Pernio1

     aArt = #1#90;
     aDes = #1#91;
     nPre = #1#92;
     nUni1 = #1#3 * #1#89;
     nDto = #0#7;
     nDto2 = #0#30;
     |HAZ LasMedidas;
     |SI nFactu = 1; nUniFacPer2 = nUni1/#1#3; |SINO; nUniFacPer2 = nUni2/#1#3; |FINSI;
     |HAZ CreaLineas; ||Pernio2

     aArt = #1#30;
     aDes = #1#31;
     nPre = #1#62;
     nUni1 = #1#3 * #1#29;
     nDto = #0#7;
     nDto2 = #0#30;
     |HAZ LasMedidas;
     |SI nFactu = 1; nUniFacCerra = nUni1/#1#3; |SINO; nUniFacCerra = nUni2/#1#3; |FINSI;
     |HAZ CreaLineas; ||Cerradura

     aArt = #1#33;
     aDes = #1#34;
     nPre = #1#63;
     nUni1 = #1#3 * #1#32;
     nDto = #0#7;
     nDto2 = #0#30;
     |HAZ LasMedidas;
     |SI nFactu = 1; nUniFacBisa = nUni1/#1#3; |SINO; nUniFacBisa = nUni2/#1#3; |FINSI;
     |HAZ CreaLineas; ||Bisagra

     aArt = #1#36;
     aDes = #1#37;
     nPre = #1#64;
     nUni1 = #1#3 * #1#35;
     nDto = #0#7;
     nDto2 = #0#30;
     |HAZ LasMedidas;
     |SI nFactu = 1; nUniFacPasa = nUni1/#1#3; |SINO; nUniFacPasa = nUni2/#1#3; |FINSI;
     |HAZ CreaLineas; ||Pasador

     aArt = #1#43;
     aDes = #1#44;
     nPre = #1#45;
     nUni1 = #1#3;
     nDto = #0#7;
     nDto2 = #0#30;
     |HAZ LasMedidas;
     |SI nFactu = 1; nUniFacMbloc = nUni1/#1#3; |SINO; nUniFacMbloc = nUni2/#1#3; |FINSI;
     |HAZ CreaLineas; ||M.Block

     aArt = #1#52;
     aDes = #1#53;
     nPre = #1#54;
     nUni1 = #1#3;
     nDto = #0#7;
     nDto2 = #0#30;
     |HAZ LasMedidas;
     |SI #1#5 = "D";
          nUni1 = nUni1 * 2; nUni2 = nUni2 * 2;
     |FINSI;
     |SI nFactu = 1; nUniFacCris = nUni1/#1#3; |SINO; nUniFacCris = nUni2/#1#3; |FINSI;
     |HAZ CreaLineas; ||M.Cris

     |SI nSwCalTota = 0;
          |HAZ Asistente;
     |FINSI;
|FPRC;

|PROCESO MolduraBlq;
     aEsMoldura = "S";
     aArt = #2#3;
     |HAZ LasMedidas;
     aDes = #2#4;
     nUni1 = #2#5;
     nUni2 = #2#6;
     nMed1 = #2#7;
     nMed2 = #2#8;
     nMed3 = #2#9;
     nPre = #2#12;
     |HAZ CreaLineas;
     |SI nSwCalTota = 0;
          |HAZ Asistente;
     |FINSI;
|FPRC;

|DEFBUCLE MolduraBlq;
     #2#1;
     ;
     #0#0, #0#1, 001;
     #0#0, #0#1, 999;
     ;
     NULL, MolduraBlq;
|FIN;

|PROCESO PideSerie;
     |PUSHV 0501 2480;
     |ABRE #7;
     |PINTA 2420 , aAlfa;
   |ET OtraSerie;
     E_sup = 5;
     E_inf = "";
     aSerie = 2435 ? 1;
     #7#26 = aSerie;
     |SI FSalida = 6;
          |LEE 000#7=;
          |CONSULTA_CLAVE #1#7;
          |SI FSalida = 0; aSerie = #7#26; |FINSI;
          |VETE OtraSerie;
     |FINSI;
     |SI FSalida = 1; |O FSalida = 7;
          nError = 1;
     |SINO;
          |LEE 000#7=;
          |SI FSalida ! 0;
               |MENAV "0000No existe serie...";
               |VETE OtraSerie;
          |FINSI;
     |FINSI;
     |CIERRA #7;
     |POPV;
|FPRC;

|PROCESO PideAgencia;
     |PUSHV 0501 2480;
     |ABRE #20;
     |PINTA 2420 , aAlfa;
   |ET OtraAgencia;
     E_sup = 99;
     E_inf = 0;
     nAge = 2436 ? 1;
     #20#0 = nAge;
     |SI FSalida = 6;
          |LEE 000#20=;
          |CONSULTA_CLAVE #1#20;
          |SI FSalida = 0; nAge = #20#0; |FINSI;
          |VETE OtraAgencia;
     |FINSI;
     |SI FSalida = 1; |O FSalida = 7;
          nError = 1;
     |SINO;
          |LEE 000#20=;
          |SI FSalida ! 0;
               |MENAV "0000No existe agencia..";
               |VETE OtraAgencia;
          |FINSI;
     |FINSI;
     |CIERRA #20;
     |POPV;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO CreaFactura;
     |ABRE #24;
     #24#0 = #0#3;
     |LEE 000#24=;
     |CIERRA #24;
     nLinAsistente = 0;
     nLin = 0;
     nError = 0;

     aAlfa = "Serie Factura:      ";
     aSerie = #3#6;
     |HAZ PideSerie;
     |SI nError ! 0; |ACABA; |FINSI;

     aAlfa = "Agencia Factura:    ";
     nAge = #24#202;
     |HAZ PideAgencia;
     |SI nError ! 0; |ACABA; |FINSI;

     #0#24 = "F"; |PINTA #0#24;
     |ABRE #84;
     |ABRE #69;
     |ABRE #324;
     |ABRE #51;
     |HAZ CreaCabFac;
     |BUCLELIN 2LinBlock#0;
     |BUCLE MolduraBlq;
     |GRABA 020#84a;
     |CIERRA #51;
     |CIERRA #324;
     |CIERRA #69;
     |CIERRA #84;

     |GRABA 020#0a;

     |HAZ AcumulaFac;

     |CONFI "0000NImprimir Factura?";
     |SI FSalida = 0;
          serie = #0#25;
          numero = #0#26;
          |SUB_EJECUTA_NP "agifa086";
     |FINSI;
|FPRC;

|PROCESO CreaAlbaran;
     |ABRE #24;
     #24#0 = #0#3;
     |LEE 000#24=;
     |CIERRA #24;
     nLinAsistente = 0;
     nLin = 0;
     nError = 0;

     aAlfa = "Serie Albaran:       ";
     aSerie = #3#2;
     |HAZ PideSerie;
     |SI nError ! 0; |ACABA; |FINSI;

     aAlfa = "Agencia Albaran:     ";
     nAge = #24#202;
     |HAZ PideAgencia;
     |SI nError ! 0; |ACABA; |FINSI;

     #0#24 = "A"; |PINTA #0#24;
     |ABRE #10;
     |ABRE #71;
     |ABRE #324;
     |ABRE #51;
     |HAZ CreaCabAlb;
     |BUCLELIN 2LinBlock#0;
     |BUCLE MolduraBlq;
     |GRABA 020#10a;
     |CIERRA #51;
     |CIERRA #324;
     |CIERRA #71;
     |CIERRA #10;

     |GRABA 020#0a;

     |HAZ AcumulaAlb;

     eaSerAlb = #0#25;
     enNumAlb = #0#26;
     eaSerBlc = #0#0;
     enNumBlc = #0#1;
     |SUB_EJECUTA_NP "tagz0027;ADB";

     |CONFI "0000NImprimir Albaran?";
     |SI FSalida = 0;
          abono = "N";
          ser_alb = #0#25;
          num_alb = #0#26;
          |SUB_EJECUTA_NP "agifa014";
     |FINSI;
     |HAZ ModiFabri;

     |CONFI "2400NDesea Facturar este Albaran : ";
     |SI FSalida = 0;
          ser_alb = #10#52;
          num_alb = #10#0;
          fec_alb = #10#1;
          abo_alb = #10#43;

          |SUB_EJECUTA_NP "agifa057;tagm0030";       ||Facturar Albaranes
     |FINSI;
|FPRC;

|PROCESO CalTotal;
     |ABRE #24;
     #24#0 = #0#3;
     |LEE 000#24=;
     |CIERRA #24;

     aMoneda = #24#193;
     aDivisa = #24#192;
     |HAZ Divisas010;

     nSwCalTota = 1;
     enBruto = 0;
     |BUCLELIN 2LinBlock#0;
     |BUCLE MolduraBlq;
     nSwCalTota = 0;
|FPRC

|PROCESO RefMoldura;
     |SI enDesdeLin = #tagm0032@#2; |Y enDesde = 2;
          |ACABA;
     |FINSI;

     |SALVA_DATOS #tagm0032@;
     |REPON_DATOS #2;
     |HAZ MolduraBlq;
|FPRC;

|DEFBUCLE RefMoldura;
     #tagm0032@#1003;
     ;
     #0#0, #0#1, 001;
     #0#0, #0#1, 999;
     ;
     NULL, RefMoldura;
|FIN;

|PROCESO RefLinea;
     |SI enDesdeLin = #tagm0031@#2; |Y enDesde = 1;
          |ACABA;
     |FINSI;

     |SALVA_DATOS #tagm0031@;
     |REPON_DATOS #1;
     |HAZ LinBlock;
|FPRC;

|DEFBUCLE RefLinea;
     #tagm0031@#1003;
     ;
     #0#0, #0#1, 001;
     #0#0, #0#1, 999;
     ;
     NULL, RefLinea;
|FIN;

|PROCESO CalTotalIVA;
     |ABRE #24;
     #24#0 = #0#3;
     |LEE 000#24=;
     |CIERRA #24;

     aMoneda = #24#193;
     aDivisa = #24#192;
     |HAZ Divisas010;

     |SALVA_DATOS #1;
     |SALVA_DATOS #2;
     |DDEF aPath;
     aAlfa = aPath + "tagm0031"; |CARGA_DEF aAlfa, tagm0031@;
     aAlfa = aPath + "tagm0032"; |CARGA_DEF aAlfa, tagm0032@;

     nSwCalTota = 2;
     enBruto = 0;
     enTotal = 0;
     |SI enDesde = 1;
          |HAZ LinBlock;
     |FINSI;
     |SI enDesde = 2;
          |HAZ MolduraBlq;
     |FINSI;
     |BUCLE RefLinea;
     |BUCLE RefMoldura;
     nSwCalTota = 0;

     |DESCARGA_DEF #tagm0032@;
     |DESCARGA_DEF #tagm0031@;
     |REPON_DATOS #2;
     |REPON_DATOS #1;
|FPRC

|PROCESO AcumuVarios;
     nSwVar = 0;
     |ABRE #21;
     |SELECT #2#21;
     #21#0 = #0#3;
     #21#2 = aArti;
     |LEE 101#21=;
     |SI FSalida = 0;
          #21#12 = #21#12 - nUniVario1;
          |GRABA 020#21a;
          nSwVar = 1;
     |FINSI;
     |CIERRA #21;

     |SI nSwVar = 1;     || Corrige stock varios
          |ABRE #17;
          |ABRE #19;
          #19#0 = aArti;
          |LEE 101#19=;
          |SI FSalida = 0;
               #19#15 = #19#15 + nUniVario1;
               #19#182 = #19#182 + nUniVario2;
               #19#12 = #19#12 + nUniVario1;
               #19#104 = #19#104 - nUniVario1;
               #19#193 = #19#193 - nUniVario2;
               #17#0 = aArti;
               #17#1 = nAlma;
               |LEE 101#17=;
               |SI FSalida = 0;
                    #17#42 = #17#42 + nUniVario1;
                    #17#44 = #17#44 + nUniVario2;
                    #17#8 = #19#8 + nUniVario1;
                    |GRABA 020#17a;
               |FINSI;
               |HAZ ValoraStock;
               |GRABA 020#19a;
          |FINSI;
          |CIERRA #19;
          |CIERRA #17;
     |FINSI;
|FPRC;

|PROCESO ModiFabri;
     |ABRE #80;
     #80#0 = #0#0;
     #80#1 = #0#1;
     |LEE 101#80=;
     |SI FSalida = 0;
          |SI #80#4 = "S"; |Y #80#14 = "X"; |O #80#14 = "P";
               #80#14 = "A";
          |FINSI;
          |SI #80#5 = "S"; |Y #80#15 = "X"; |O #80#15 = "P";
               #80#15 = "A";
          |FINSI;
          |GRABA 020#80a;
     |FINSI;
     |CIERRA #80;
|FPRC;
