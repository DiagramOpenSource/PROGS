     Exporta Fab

|FICHEROS;
     ortsz012 #12,MANTE;
     ortsm016 #16;
     ortsm017 #17;
     ortsm018 #18;
     agifa019 #19;
     ortsm023 #23;
     ortsm024 #24;
|FIN;

|VARIABLES;
     aExt = "";
     nUni = 0;
     &enError = 0;
     &eaRuta = "";
     {1}aLocal = "";
     aXls = "";
     aAlfa = "";
     aBase = "";
     aOrigen = "";
     aDestino = "";
     nReg = 0;
     aFin = "";
     aSepara = ";"
     nHandle = 0;
     aOrg = "";
|FIN;

|PROCESO Graba;
     |QBF aAlfa;
     |SI nReg ! 0; aAlfa = aSepara + aAlfa; |FINSI;
     |XGRABA nHandle, aAlfa;
     nReg = nReg + 1;
|FPRC;

|PROCESO ExportaFabLinCSV;
     nReg = 0;
     aAlfa = #24#9; |HAZ Graba;
     |SI #24#14 = 0;
          aAlfa = "TABTX" + #24#8; |HAZ Graba;
     |SINO;
          aAlfa = "TAB" + (("00"+#24#14)%-102) + #24#8; |HAZ Graba;
     |FINSI;
     aAlfa = #24#11; |HAZ Graba;
     aAlfa = #24#12; |HAZ Graba;
     aAlfa = #24#8; |HAZ Graba;
     aAlfa = #24#14; |HAZ Graba;
     aAlfa = #24#15; |HAZ Graba;
     aAlfa = #24#16; |HAZ Graba;
     aAlfa = #24#17; |HAZ Graba;
     aAlfa = #24#18; |HAZ Graba;
     aAlfa = #24#19; |HAZ Graba;
     |SI #17#8 = "S";
          aAlfa = #18#6; |HAZ Graba;
     |SINO;
          aAlfa = #17#11; |HAZ Graba;
     |FINSI;
     |SI #24#6 = 0;
          aAlfa =  ""; |HAZ Graba;
     |SINO;
          aAlfa = #24#6 + " de " + #17#7; |HAZ Graba;
     |FINSI;
     aAlfa = #16#2; |HAZ Graba;
     aAlfa = #16#4; |HAZ Graba;
     aAlfa = #17#5; |HAZ Graba;
     aAlfa = #24#7; |HAZ Graba;
     aAlfa = #19#2; |HAZ Graba;
     aAlfa = #19#3; |HAZ Graba;
     aAlfa = #24#20; |HAZ Graba;

     #19#0 = #16#2;
     |LEE 000#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;

     aAlfa = #19#127; |HAZ Graba;
     aAlfa = #24#13; |HAZ Graba;

     aAlfa = #24#0; |HAZ Graba;
     aAlfa = #24#1; |HAZ Graba;
     aAlfa = #24#2; |HAZ Graba;
     aAlfa = #24#3; |HAZ Graba;
     aAlfa = #24#4; |HAZ Graba;
     aAlfa = #24#5; |HAZ Graba;
     aAlfa = #24#6; |HAZ Graba;
     |XGRABA nHandle, aFin;
|FPRC;

|PROCESO ExportaFabLin;
     #16#28 = #24#2;
     #16#0 = #24#3;
     #16#1 = #24#4;
     |LEE 020#16=;
     |SI FSalida ! 0; |DDEFECTO #16; |FINSI;

     #17#0 = #24#2;
     #17#1 = #24#3;
     #17#2 = #24#4;
     #17#3 = #24#5;
     |LEE 020#17=;
     |SI FSalida ! 0; |DDEFECTO #17; |FINSI;

     #18#0 = #24#2;
     #18#1 = #24#3;
     #18#2 = #24#4;
     #18#3 = #24#5;
     #18#4 = #24#6;
     |LEE 000#18=;
     |SI FSalida ! 0; |DDEFECTO #18; |FINSI;

     #19#0 = #17#4;
     |LEE 020#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;

     |SI #12#2 = "C"; |HAZ ExportaFabLinCSV; |ACABA; |FINSI;

     nReg = nReg + 1;
     aAlfa = "A" + nReg + "," + #24#9; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |SI #24#14 = 0;
          aAlfa = "TABTX" + #24#8;
     |SINO;
          aAlfa = "TAB" + (("00"+#24#14)%-102) + #24#8;
     |FINSI;
     aAlfa = "B" + nReg + "," + aAlfa; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "C" + nReg + "," + #24#11; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "D" + nReg + "," + #24#12; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "E" + nReg + "," + #24#8; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "F" + nReg + "," + #24#14; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "G" + nReg + "," + #24#15; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "H" + nReg + "," + #24#16; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "I" + nReg + "," + #24#17; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "J" + nReg + "," + #24#18; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "K" + nReg + "," + #24#19; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     |SI #17#8 = "S";
          aAlfa = "L" + nReg + "," + #18#6; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |SINO;
          aAlfa = "L" + nReg + "," + #17#11; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;
     |SI #24#6 = 0;
          aAlfa = "M" + nReg + "," + ""; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |SINO;
          aAlfa = #24#6 + " de " + #17#7;
          aAlfa = "M" + nReg + "," + aAlfa; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;
     aAlfa = "N" + nReg + "," + #16#2; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "O" + nReg + "," + #16#4; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "P" + nReg + "," + #17#5; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "Q" + nReg + "," + #24#7; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "R" + nReg + "," + #19#2; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "S" + nReg + "," + #19#3; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "T" + nReg + "," + #24#20; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     #19#0 = #16#2;
     |LEE 000#19=;
     |SI FSalida ! 0; |DDEFECTO #19; |FINSI;

     aAlfa = "U" + nReg + "," + #19#127; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "V" + nReg + "," + #24#13; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "W" + nReg + "," + #24#0; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "X" + nReg + "," + #24#1; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "Y" + nReg + "," + #24#2; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "Z" + nReg + "," + #24#3; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "AA" + nReg + "," + #24#4; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "AB" + nReg + "," + #24#5; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     aAlfa = "AC" + nReg + "," + #24#6; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
|FPRC;

|DEFBUCLE ExportaFabLin;
     #24#1;
     ;
     #23#3, #23#0, 0000;
     #23#3, #23#0, 9999;
     ;
     NULL, ExportaFabLin;
|FIN;

|PROCESO Fichero12; |TIPO 0;
     |SI FSalida = 13;
          |HAZ DsSelect;
          |SI enError = 0;
               #12Campo = eaRuta; |PINTA #12Campo;
          |FINSI;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO ExportaFab;
     aFin = &13 + &10;
     |ABRE #12;
     |LEE 101#12=;
     |SI FSalida ! 0; |GRABA 020#12b; |FINSI;
     |PINPA #0#12;
     |PINDA #0#12;
     |ENDATOS #1#12;
     |SI FSalida = 0;
          |GRABA 020#12a;
          |SI #12#2 = "X";
               |DBASE aBase;
               aOrigen = aBase + "001655/ortsfab.xls";

               |ESPECIFICA "RBASS", aLocal;
               aBase = aLocal;
               aDestino = aBase + "tmp/";  |MKDIR aDestino;
               aDestino = aDestino + "ortsfab.xls";
               aXls = aDestino;

               |ENVIA_FICHERO aOrigen, aDestino;

               aDestino = #12#1; |QBF aDestino;
               aAlfa = aDestino % -104;
               |SI aAlfa ! ".xls"; aDestino = aDestino  + ".xls"; |FINSI;


               |CARGADLL "agixl97.dll";
               |SI FSalida < 0;
                   |MENAV "0000No se puede usar agixl97.dll";
               |SINO;
                    |ALFACALLDLL "agixl97.dll", "carga_book", aXls;
                    |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "Hoja1";

                    nReg = 1;
                    |ABRE #16;
                    |ABRE #17;
                    |ABRE #18;
                    |ABRE #19;
                    |BUCLE ExportaFabLin;
                    |CIERRA #19;
                    |CIERRA #18;
                    |CIERRA #17;
                    |CIERRA #16;

                    |ALFACALLDLL "agixl97.dll", "fichero_destino", aDestino;
                    |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
                    |DESCARGADLL "agixl97.dll";
               |FINSI;
               |RFBORRA aXls;
          |SINO;
               |DFICE aAlfa;
               aOrg = aAlfa + Usuario;
               |XABRE "WB", aOrg, nHandle;
               |SI FSalida ] 0;
                    aAlfa = "Optimizador"+aSepara+"Material"+aSepara+"Largo"+aSepara+"Ancho"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    aAlfa = "Color Pieza"+aSepara+"Tablero"+aSepara+"Cantidad"+aSepara+"Medidas"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    aAlfa = "Chapado Exterior"+aSepara+"Observaciones"+aSepara+"Obs1"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    aAlfa = "Tirador"+aSepara+"Numerador"+aSepara+"Artículo"+aSepara+"Desc_Art"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    aAlfa = "Descripción"+aSepara+"Cod.Componente"+aSepara+"Familia"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    aAlfa = "Subfamilia"+aSepara+"Grupo"+aSepara+"Orden"+aSepara+"Serie Lote"+aSepara+"Lote"+aSepara+"Linea Lote"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    aAlfa = "Serie"+aSepara+"Pedido"+aSepara+"Línea Pedido"+aSepara+"Línea Componente"+aSepara+"Línea Unidades"+aSepara;
                    |XGRABA nHandle, aAlfa;
                    |XGRABA nHandle, aFin;
                    |ABRE #16;
                    |ABRE #17;
                    |ABRE #18;
                    |ABRE #19;
                    |BUCLE ExportaFabLin;
                    |CIERRA #19;
                    |CIERRA #18;
                    |CIERRA #17;
                    |CIERRA #16;
                    |XCIERRA nHandle;
                    aAlfa = #12#1; |QBF aAlfa;
                    aExt = aAlfa % -104; aExt = aExt < "";
                    |SI aExt ! ".csv";
                         aAlfa = aAlfa + ".csv";
                    |FINSI;

                    |ENVIA_FICHERO aOrg, aAlfa;
                    |SI FSalida ! 0;
                         |MENAV "0000Error al enviar fichero al servidor...";
                    |FINSI;
                    |FBORRA aOrg;
               |SINO;
                    |MENAV "0000Error al abrir fichero...";
               |FINSI;
          |FINSI;
          |LIBERA #12;
     |FINSI;
     |CIERRA #12;
|FPRC;
