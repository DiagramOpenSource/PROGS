|FICHEROS;
     agifa501 #0;        ||Entrada tiquets (C)
     agifa502 #1;        ||Entrada tiquets (L)
     agifa019 #2;        ||Articulos
     agifa017 #3;        ||Almacenes
     agifa505 #4;        ||Parametros Caja
     agifa027 #5;        ||Contadores
     agifa510 #7;        ||Horario
     agifa509 #8;        ||Resumen Diario Caja
     agifa084 #12;       ||Factura Contado
     agifa069 #13;       ||Factura Contado Lineas
     agifa024 #14;       ||Clientes
     agifa010 #16;       ||Alb.C
     agifa071 #17;       || '' L
     agifa065 #18;       ||Historico.
     agifa515 #19;       ||Tarjetas
     agifa516 #20;       ||Diario Tarjetas
     tpv00013 #27;       ||Cargos Habi (C)
     tpv00014 #28;       ||Cargos Habi (L)
     agifa517 #30;       ||Parametros T.P.V
     agifa007 #43;       ||Series
     agifa508 #51;       ||Documentos Borrados

     iber0041 #41;       ||Terminales cabs.
     iber0076 #76;       ||Recetas
     iber0079 #79;       ||Reservas
     iber0087 #87;       ||C.Barras

     ib__arti #100;
     ib__kits #101;
     ib__ticd #102;
     ib__tick #103;
     ibxxtpas #104;
     ib__rese ;
     ibxxlpas #106;

     iber0016 #116;      ||Centros
     iber0017 #117;
     iber0020 #120;
     agifa142 #142;      ||Parametros Generales
     iber0065 #165;
     iber0069 #169;      ||Secciones Centro
     iber0070 #170;      ||Subfamilias Centro/PuntoVenta/Seccion
     tabusagr #900;      ||habitaciones Hotel
     dsm00018 #918;
     dsm00051 #951;
     dsm00047 #947;
     dsm00048 #948;

     ibxxtarj;
     ibxxbloq;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     {-1}pvisual = "";        || parametros de "ESPECIFICA"
     {-1}xvisual = "";        || parametros de "ESPECIFICA"
     dll         = "x.dll";   || nombre de la dll (dsbocata1.dll)
     mostrar     = "0";       || oculta basico 0-si, 1-no
     &EURODB     = 0;
||컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴||
     &aTipoTarjeta = ""; ||donde viene el texto (nombre de tarjeta) elegido (o blanco si ninguno)
     &aDtoCliente = 0;             ||Dto de cliente (no se usa....)
     &aIVAinc      = "";
     &nIVAporV     = 0;
     &nTarjetaEuros = 0;           || Importe Tarjeta
     &nTarjetaPtas = 0;
     &nChequeEuros = 0;            || Importe Cheque
     &nChequePtas = 0;
     &nDeudaEuros = 0;             || Importe Deuda
     &nDeudaPtas = 0;
     &aNoImprimir  = "";           || Si es 'S' no Imprime el Tiquet
     &nEntregaPtas = 0;            || total cobrado PESETAS
     &nEntregaEuros = 0;           || total cobrado EUROS
     &nTotalEuros = 0;             || total ticket calculado EUROS
     &nTotalPtas = 0;              || total ticket calculado PESETAS

     &aNomArticulo  = "";
     &nPuntoDeVenta = 0;
     &aFormaPago = "";
     &aNomCliente = "";
     &nContadorTicket = 0;         || numero de ticket real (agifa501)
     &nElTicket = 0;               || numero de ticket temporal (ib__tick)
     &aCliente = "";               || codigo de cliente
     &aArticulo = "";              || codigo de articulo
     &nPrecio = 0;                 || precio en EUROS
     &nPrecioPtas = 0;             || precio en PESETAS
     &nImporteConPesetas = 0;      || mostrar columna pesetas 1-si 0-no
     &nLinTicket = 0;              ||Numero Linea Ticket
     &enPreTPV      = 0;           || PRECIO TPV
     &aIPCocina     = "";

     &aFacturar = ""; ||  = S  hay que hacer factura  ! S no
          || Si hay codigo de cliente usar los datos de su ficha
     &aFNomCliente = "";
     &aFNifCliente = "";
     &aFDirCliente = "";
     &aFPobCliente = "";
          || Para el  articulo varios
     &aArtVarios = "";
          ||Para el articulo mensajes
     &aArtMensajes = "";
          ||Para saber si los articulos por defecto en la mesa son por mesa o comensal
     &nModoArtDefMesa = 0;  || 0 comensal 1 mesa
          ||Numero de comensales al cobrar ... para rellenar dato en fichero.
     &aElPlato = "";       ||Para impresion Plato
     &aSala = "";
     &aMesa = "";
     &aTexto = "";
     &aElEvento = "";
     &nElTicketLin = 0;
     &aEsHotel = "";     || poner a 'S' para boton habitacion
     &aHabitacion = "";  || al cobrar 'S' cargo habitacion
     &aBuenTicket = "";  || poner a 'N' (al salir de CalculaTicket)
                         || continua en la pantalla de cobro
     &aEsGratis   = "";  || 'S' invitacion
     &nNumRoom    = 0;   || Numero habitacion Hotel
     &aSeccion    = "";  ||  Si vacia imprime Todas, sino la que traiga
     &nComensales  = 0;
     &aFamilia     = "";
     &eaTipoTactil = ""; || Para las DLL
     &aUnidEsp = "";
     &nErrorRecupera = 1;
     &aTieneCaja2   = "";          || para que aparezca el boton S/N
     &aCaja2   = "";               || cuando se pulsa el boton S/N
     &nIVAporA    = 0;
     &nPuntoBloqueo = 0; || de 0 a n puntos de venta (el cero lo usare como semaforo global)
||컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴||
     &eaIvaIber = "";
     &enHayCentralCob = 0;
     &enValMone = 0;
     &eaTag = "";
     &enMesa      = 0;
     &eaNomDll    = "";
     &aTipoTactil = "";
     &eaCentro     = "";

     &forma    = "";
     &impr_tpv = "";
     &impr_dis = "";
     &abre_dis  = "";
     &cier_dis  = "";
     &mens_dis  = "";

     &ferr_tarjeta  = "";      || Fichero de Error -> 'error'
     &oper_tarjeta  = "";      || Operacion
     &bat_tarjeta   = "";      || Fcihero Cobro
     &empresa       = 0;
     &acaja         = 0;
     &afecha        = "";
||컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴||
     &uni_dt = 0;
     &fed_dt = @;   || Fecha....
     &art_dt = "";  || Articulo.
     &cli_dt = "";  || Cliente..
     &fam_dt = "";  || Familia.
     &iva_dt = 0;   || Tipo Iva.
     &dtos_2 = 0;   || Descuento 2.
     &dto_pt = 0;   || Descuento Ptas.
     &dtos_1 = 0;   || Descuento 1.
     &pvp_ve = 0;   || Precio Venta.
     &gru_dt = "";  || Grupo Cliente.
     &tarifa = 0;   || Tarifa Cliente.
     &presel = 0;   || tarifa Seleccion
     &dtosel = 0;   || dto    Seleccion
     &aParam        = "";
     &enMensaje     = 0;
     &enPromoTPV1   = 0;
     &eaIVAsn   = "";|| IVA incluido S/N
     &enPromoTPV2   = 0;


     &Tempo         = "";
     &enANULA       = 0;
     enReEmi        = 0;
     &enHora        = "";
||컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴||
     &eaLogCaj = "";
     &xhotel   = "";
     &xhabita  = "";
     &xnombre  = "";
     &xhuespe  = "";
     emp       = "";
     apli      = "";
     alf1      = "";
     minu_ant  = 0;
     path      = "";
     ficHotel  = "";
     lincre    = 0;
 {-1}vPopup    = "";
     vPopup1   = "1024";
     vPopup2   = "2164";
     vPopup3   = "0000";
     vPopup4   = "PEDIR";
||컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴||
     nCodTarjeta = 0;
     rec       = 0;
     nTotal    = 0;
     nBase     = 0;
     nIva      = 0;
     nRec      = 0;
     nSwSeccion= 0;
     nEfectivo = 0;
     aInforme  = "";
     aInfTiq   = "";
     aInfAlb   = "";
     aInfFac   = "";
     aReceta   = "";
     aNom      = "";
     aOpeHis   = "";
     &aSesion  = "";
     aTipo     = "";
     nCentro   = 0;
     aTempo0   = "";
     aTempo1   = "";
     aTempo12  = "";
     aTempo13  = "";
     aTempo16  = "";
     aTempo17  = "";
     nSwSimula = 0;
     nNume     = 0;
     aAlfa     = "";
     nMes      = 0;
     aMes      = "";
     nNeto     = 0;
     periodo   = 0;
     nImpo     = 0;
     mes       = 0;
     fmes      = "";
     nMargen   = 0;
     i         = 0;
     j         = 0;
     aHora     = "";
     iva       = 0;
     aSer      = "";
     conta_reg = 0;
     claveconta= "";
     nForma    = 0;
     nDto      = 0;
     puente_a  = "";
     puente_n  = 0;
     puente_s  = 0;
     aArti     = "";
     nAlma     = 0;
     nUni      = 0;
     aAlfa1    = "";

     texto     = "";
     impo_dis  = 0;
     alfa      = "";
     nume1     = 0;
     beta      = 0;
     longi     = "";
     form0     = "";
     text0     = "";
     pos0      = 0;
     lon0      = 0;
     long      = 0;
     bet0      = 0;
     cam0      = 0;
     nSwPieInf = 0;
     nSwCocina = 0;
     nPtaAnt   = 0;
     nEuroAnt  = 0;
     nUniSum   = 0;
     nCampo    = 0;
     aArtiAnt  = "";
 {20}aGuarda   = "";
     aDSeccion = "";
     aHSeccion = "";
     aDImpre   = "";
     aHImpre   = "";
     aDPlato1  = "";
     aHPlato1  = "";
     aDPlato2  = "";
     aHPlato2  = "";
     nNuevoTicket = 0;
     aSecAnt   = "";
     nPlato    = 0;
     &nDPunto   = 0;
     &nHPunto   = 0;
     aBarra    = "";
     aUnid     = "";
     aPrec     = "";
     aMone     = "";
     aPos      = "";
     aLon      = "";
     nSwDesBarra = 0;
     nPrecio1  = 0;
     nPrecioPtas1 = 0;
     nDeci     = 0;
     nPrimeLin = 0;
     fGuarda   = @;
     nSinIva   = 0;
     nGuarda   = 0;
     nDeu      = 0;
     Cam2      = "";
     Cam8      = "";
     Cam9      = "";
     Cam17     = "";
     nLinAgr   = 0;
     nUniAgr   = 0;
     nPreHist  = 0;
     nBase0    = 0;
     nTotal0   = 0;
     &nDeci_PreBase = 0;
     &nDeci_Base = 0;
     &nDeci_IVA = 0;
     &aMoneda = "";
     &aDivisa = "";
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO ini_display;
     texto = abre_dis + mens_dis + cier_dis;
     |SI mens_dis ! ""; |Y impr_dis ! "";
          Impresora = impr_dis;
          |IMPRE -1;
          |IMPRIMESIN texto;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO total_display;
     |SI impr_dis ! "";
          texto = " " * #4#67;
          texto = texto + impo_dis;
          alfa = "-"  + forma;
          texto = texto % alfa;
          nume1 = forma; nume1 = nume1 - 7;
          alfa = nume1;  alfa = "-" + alfa;
          texto = texto % alfa;
          texto = "TOTAL: " + texto;
          texto = abre_dis + texto + cier_dis;
          Impresora = impr_dis;
          |IMPRE -1;
          |IMPRIMESIN texto;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO cobro_display;
     |SI impr_dis ! ""; |Y #4#68 > 1; || Si tiene mas de 1 linea
          beta = #4#67/#4#68;
          longi = "00" + beta;
          form0 = "1" + (longi % -102);
          texto = " " * beta;
          texto = texto + #0#9;
          alfa = "-"  + form0;
          texto = texto % alfa;
          nume1 = form0; nume1 = nume1 - 7;
          alfa = nume1;  alfa = "-" + alfa;
          texto = texto % alfa;
          text0 = "TOTAL: " + texto;
          texto = " " * beta;
          texto = texto + #0#11;
          alfa = "-"  + form0;
          texto = texto % alfa;
          nume1 = form0; nume1 = nume1 - 8;
          alfa = nume1;  alfa = "-" + alfa;
          texto = texto % alfa;
          text0 = text0 + "CAMBIO: " + texto;
          texto = abre_dis + text0 + cier_dis;
          Impresora = impr_dis;
          |IMPRE -1;
          |IMPRIMESIN texto;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO lin_display;
     |SI impr_dis ! "";
          |ABRE #103;
          #103#0 = nElTicket;
          #103#1 = nLinTicket;
          |LEE 000#103=;
          |SI FSalida ! 0; |DDEFECTO #103; |FINSI;
          |CIERRA #103;

          texto = "";
          |PARA beta = 69; |SI beta [ 81; |HACIENDO beta = beta + 3;
               |SI #4beta = 0; |SAL; |FINSI;
               pos0 = beta + 1; lon0 = beta + 2;
               longi = texto % A0; long = longi;
               bet0 = #4pos0 - long - 1;
               alfa = " " * bet0;
               texto = texto + alfa;
               alfa = " " * #4#67;
               |SI #4beta = 1; cam0 = 2; |FINSI;     || Cod
               |SI #4beta = 2; cam0 = 7; |FINSI;     || Uni
               |SI #4beta = 3; cam0 = 12;|FINSI;     || Des
               |SI #4beta = 4; cam0 = 8; |FINSI;     || Pre
               |SI #4beta = 5; cam0 = 8; |FINSI;     || Imp Linea
               |SI #4beta = 6;
                    bet0 = nTotalPtas;
                    alfa = bet0 + alfa;              || Imp parcial
               |SINO;
                    |SI #4beta = 4;
                         alfa = (#1cam0/#1#7) + alfa;
                    |SINO;
                         alfa = #1cam0 + alfa;
                    |FINSI;
               |FINSI;
               longi = "00" + #4lon0;
               form0 = "1" + (longi % -102);
               alfa = alfa % form0;
               texto = texto + alfa;
          |SIGUE;
          |QBF texto;
          alfa = "." * #4#67;
          texto = texto + alfa;
          texto = texto % forma;
          texto = abre_dis + texto + cier_dis;
          Impresora = impr_dis;
          |IMPRE -1;
          |IMPRIMESIN texto;
          |FINIMP;
     |FINSI;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO ActuaCliente;
     |DDEFECTO #14;
     |ABRE #14;
     #14#0 = #0#1;
     |LEE 141#14=;
     |SI FSalida ! 0; |GRABA 040#14b; |FINSI;

     |SI #0#3 > 0; nNume = 1; |SINO; nNume = -1; |FINSI;
     #0#3 = #0#3 * nNume;
     nDto = (((#0#3 < #0#17) < #0#19) < #0#18) * nNume;
     #0#3 = #0#3 * nNume;

     nDto = #0#3 - nDto;   || Total Dto Cabecera
     nNeto = #0#3 - nDto;

     |SI #0#35 = "A";
          #14#50 = #14#50 + (nNeto * nForma);
          enImpCliPen = #14#50;
     |SINO;
          |SI #142#115 = "N";
               nImpo = (nNeto * 100) / (100 - #0#18);
               nDto = nDto + (nNeto - nImpo);
          |SINO;
               nImpo = nNeto;
          |FINSI;
          aMes = #0#14 % A402;
          nMes = ((aMes - 1) * 4) + 54;
          #14nMes = #14nMes + (nImpo * nForma);

          nMes = nMes + 1;
          #14nMes = #14nMes + (nDto * nForma);

          nMes = nMes + 1;
          #14nMes = #14nMes + (#0#8 * nForma);

          #14#102 = #14#102 + (nImpo * nForma);
          #14#103 = #14#103 + (nDto * nForma);
          #14#104 = #14#104 + (#0#8 * nForma);
          #14#45 = #0#14;
          #14#46 = nNeto;
          #14#110 = #14#110 + (nNeto * nForma);

          enImpCliCom = nImpo * nForma;
          enImpCliDto = nDto * nForma;
          enImpCliFac = nNeto * nForma;
          enImpCliMar = #0#8 * nForma;
     |FINSI;
     eaCliente = #0#1;
     efFecha = #0#14;
     |HAZ AcumulaCli;

     |GRABA 040#14a;
     |CIERRA #14;
|FPRC;

|PROCESO horario;
     periodo = 0;
     |PARA i = 1; |SI i [ 19; |HACIENDO i = i + 2;
          j = i + 1;
          periodo = periodo + 1;
          |SI puente_n ] #7#i#; |Y puente_n [ #7#j#;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO CargoHabi;
     |SI #0#59 = 0; |ACABA; |FINSI;    || -> No hay Cargo habi
     |ABRE #27;
     |ABRE #28;
     |SI nForma = 1;
          |DDEFECTO #27;
          #27#1 = xhotel;
          #27#0 = xhabita;
          |LEE 000#27=;
          |SI FSalida ! 0;
               #27#1 = xhotel;
               #27#0 = xhabita;
               |GRABA 040#27b;
          |FINSI;
          #28#15 = #27#1;
          #28#0  = #27#0;
          #28#1  = 999;
          |LEE 000#28];
          |SI FSalida = 0;
               |LEE 000#28a;
          |SINO;
               |LEE 000#28u;
          |FINSI;
          |SI FSalida = 0; |Y #28#15 = #27#1; |Y #28#0 = #27#0;
               lincre = #28#1 + 1;
          |SINO;
               lincre = 1;
          |FINSI;
          |DDEFECTO #28;
          #28#15 = #27#1;
          #28#0  = #27#0;
          #28#1  = lincre;

          alfa = (Usuario % 810);

          #28#2  = #0#37;  || Documento.
          #28#3  = #0#14;  || Fecha.
          #28#4  = #0#12;  || Caja.
          #28#5  = #0#59;  || Importe.
          #28#6  = xhuespe; || Cod.Huesp.
          #28#7  = xnombre; || Nom.Huesp.
          #28#8  = "X";     || Tipo Cargo.
          #28#9  = "REST";  || Concepto.
          #28#10 = 1;       || Unidades.
          #28#11 = alfa;    || Usuario.
          #28#12 = "";      || Servicio.
          #28#13 = 0;       || Tipo Iva.         (no hace falta)
          #28#14 = "S";     || Iva Incluido. S/N (tampoco)
          |GRABA 040#28n;
     |SINO;
          #27#1 = #0#60;
          #27#0 = #0#61;
          |LEE 040#27=;
          |SI FSalida = 0;
               #28#15 = #27#1;
               #28#0  = #27#0;
               #28#1  = 0;
               |LEE 101#28];
               |PARA; |SI FSalida = 0; |Y #27#1 = #28#15; |Y #27#0 = #28#0; |HACIENDO;
                    |SI #28#2 = #0#37; |Y #28#4 = #0#12;
                         |BORRA 041#28a;
                         |SAL;
                    |FINSI;
                    |LIBERA #28;
                    |LEE 101#28s;
               |SIGUE;
          |FINSI;
     |FINSI;
     |CIERRA #27;
     |CIERRA #28;
|FPRC;

|PROCESO ActuaResumen;
     |ABRE #7;          ||Horario
     #7#0 = #4#18;
     |LEE 000#7=;
     |CIERRA #7;

     |ABRE #8;
     |DDEFECTO #8;
     #8#63 = empresa;
     #8#0 = acaja;
     #8#1 = afecha;
     |LEE 141#8=;
     |SI FSalida ! 0; |GRABA 040#8b; |FINSI;
     |SI #0#31 ! "V";
          |SI #0#31 = "R";  ||Rotura=Basura
               #8#67 = #8#67 + (#0#9 * nForma);
          |SINO;
               |SI #0#31 = "A";
                    #8#68 = #8#68 + (#0#63 * nForma);  || Invitacion
               |SINO;
                    |SI #0#35 ! "A";
                         #8#24 = #8#24 + (#0#9 * nForma);   ||Venta con imp.
                         #8#25 = #8#25 + (#0#4 * nForma);   ||Total iva
                         #8#26 = #8#26 + (nForma *(#0#22+#0#25+#0#47+#0#50+#0#53));
                         #8#27 = #8#24 - #8#25 - #8#26;
                         #8#28 = #8#28 + (#0#28 * nForma);  ||Total dto
                         #8#29 = #8#29 + (#0#3 * nForma);   ||Total bruto
                    |FINSI;
                    |SI #0#35 = "A";
          ||             #8#58 = #8#58 + #0#9 * nForma;
                         #8#8 = #8#8 + nForma;
                         #8#17 = #8#17 + (#0#9 * nForma);
                    |SINO;
                         |SI #0#35 = "F";
                              #8#7 = #8#7 + nForma;
                              #8#16 = #8#16 + (#0#9 * nForma);
                         |SINO;
                              #8#6 = #8#6 + nForma;
                              #8#15 = #8#15 + (#0#9 * nForma);
                         |FINSI;
                    |FINSI;
                    puente_a = (#0#34 % 102) + (#0#34 % 402);
                    puente_n = puente_a;
                    |HAZ horario;
                    puente_n = periodo + 29;
                    #8#puente_n# = #8#puente_n# + nForma;
                    puente_n = puente_n + 10;
                    #8#puente_n# = #8#puente_n# + (#0#9*nForma);
                    |SI #4#163 = "S"; |O #0#9 > 0;
                         #8#52 = #8#52 + (#0#38 * nForma);       ||Efectivo
                         #8#55 = #8#55 + ((#0#38 + #0#40 + #0#39)*nForma);
                    |FINSI;
                    #8#53 = #8#53 + (#0#40 * nForma);            ||Tarjeta
                    #8#54 = #8#54 + (#0#39 * nForma);            ||Cheque
                    #8#58 = #8#58 + (#0#41 * nForma);            ||Pendiente de credito
                    #8#57 = #8#57 + (#0#15 * nForma);            ||Restos no cobrados
               |FINSI;
          |FINSI;
     |SINO;
          #8#84 = #8#84 + (#0#66 * nForma);  ||Vales
     |FINSI;

     |GRABA 040#8a;
     |CIERRA #8;

     |HAZ ControlCaja;
|FPRC;

|PROCESO ActuaTarjeta;
     |SI #0#40 = 0; |ACABA; |FINSI;
     |ABRE #19;
     |ABRE #20;

     |DDEFECTO #19;
     #19#0 = #0#46;
     |LEE 141#19=;
     |SI FSalida ! 0; |GRABA 040#19b; |FINSI;
     #19#2 = #19#2 + (#0#40 * nForma);    ||Total Ptas cargadas
     #19#3 = #0#14;            ||Fecha Ult. Oper.
     #19#4 = #0#40;            ||Ptas Cargadas
     |GRABA 040#19a;

     |DDEFECTO #20;
     #20#0 = #0#46;
     #20#1 = #0#14;
     |LEE 141#20=;
     |SI FSalida ! 0; |GRABA 040#20b; |FINSI;
     #20#2 = #20#2 + (#0#40 * nForma);  ||Total Ptas cargadas
     |GRABA 040#20a;

     |CIERRA #19;
     |CIERRA #20;
|FPRC;

|PROCESO ActuaStock;
     |ABRE #2; |DDEFECTO #2;
     |ABRE #3; |DDEFECTO #3;
     #2#0 = aArti;
     |LEE 141#2=;
     |SI FSalida ! 0; |GRABA 040#2b; |FINSI;
     #3#0 = aArti;
     #3#1 = nAlma;
     |LEE 141#3=;
     |SI FSalida ! 0; |GRABA 040#3b; |FINSI;

     #2#6 = #2#6 - (nUni * nForma);
     #2#104 = #2#104 - (nUni * nForma);
     #3#5 = #3#5 - (nUni * nForma);
     #3#39 = #3#39 - (nUni * nForma);
     |HAZ ValoraStock;

     #2#24   = #0#14;
     #2#25   = nUni;
     aAlfa = #0#14 % 402;
     nNume = aAlfa;
     nNume = ((nNume - 1) * 5) + 34;

     #2nNume = #2nNume + (nUni * nForma);
     #2#94   = #2#94   + (nUni * nForma);
     nNume    = aAlfa;
     nNume    = ((nNume - 1) * 2) + 11;
     #3nNume = #3nNume + (nUni * nForma);
     #3#35   = #3#35   + (nUni * nForma);

     |GRABA 040#2a;
     |GRABA 040#3a;
     |CIERRA #2;
     |CIERRA #3;

     enUniVta = nUni * nForma;
     enUniSal = nUni * nForma;
     efFecha = #0#14;
     eaArticulo = aArti;
     enAlmacen = nAlma;
     |HAZ AcumulaArt;
     |HAZ AcumulaAlm;
     ||컴컴컴컴컴컴컴컴컴컴횴istorico
     |ABRE #18;
     |DDEFECTO #18;
     #18#0 = #2#0;
     #18#1 = #0#14;
     #18#2 = aOpeHis;
     #18#3 = #0#58;
     #18#4 = #1#1;
     #18#11 = #0#57;
     |LEE 101#18=;
     |SI nForma < 1;
          |SI FSalida = 0;
               |BORRA 020#18a;
          |FINSI;
     |SINO;
          |SI FSalida ! 0; |GRABA 020#18b; |FINSI;
          #18#5 = #3#1;
          #18#6 = -(nUni * nForma);
          #18#7 = #2#6;
          #18#8 = #2#9;
          #18#9 = nPreHist; ||#1#6;
          #18#10 = #0#1;
          #18#12 = 0;    || DESCUENTOS
          #18#13 = 0;
          #18#14 = ((((#18#9 < #18#12) < #18#13) < #0#17) < #0#19);
          |SI #142#115 = "S";
               #18#14 = #18#14 < #0#18;
          |FINSI;
          |GRABA 020#18a;
     |FINSI;
     |CIERRA #18;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO LeeIVA;
     |SI #iber0016#28 = 0;
          enTiva = #agifa019#30;
     |SINO;
          enTiva = #iber0016#28;
     |FINSI;
     efFiva = afecha;
     |HAZ SacaIVA;
     |SI eaDiva ! "";
          enIva = enIva;
          enRec = enRec;
     |SINO;
          enIva = 0;
          enRec = 0;
     |FINSI;
|FPRC;

|PROCESO actua_cabe;
     #0#3 = #0#3 +. #1#21;                         ||Total bruto
     nRec = 0;
     |SI aIVAinc = "N";
          nNeto = (((#1#21 < #0#17) < #0#19) < #0#18) ! EURODB;
          nIva = (nNeto % enIva) ! EURODB;
          nRec = (nNeto % rec) ! EURODB;
          #0#28 = #0#28 +. (#1#21 - nNeto);        ||Total descuentos
          #0#9 = #0#9 +. (nNeto + nIva + nRec);    ||Total
     |SINO;
          nNeto = (((#1#7 < #0#17) < #0#19) < #0#18) ! EURODB;
          nBase = (nNeto / (1 + ((enIva + rec) / 100) )) ! EURODB;
          |SI rec = 0;
               nIva = (nNeto - nBase) ! EURODB;
          |SINO;
               nIva = (nBase % enIva) ! EURODB;
               nRec = nNeto - nBase - nIva;
          |FINSI;
          #0#28 = #0#28 +. (#1#21 - nBase);        ||Total descuentos
          #0#9 = #0#9 +. (nBase + nIva + nRec);    ||Total
          nNeto = nBase;
     |FINSI;

     |SI #1#13 = 0;
          #0#30 = #0#30 +. nNeto;
     |FINSI;
     |SI #1#13 = 1;
           #0#20 = #0#20 +. nNeto;
           #0#21 = #0#21 +. nIva;
           #0#22 = #0#22 +. nRec;
     |FINSI;
     |SI #1#13 = 2;
          #0#23 = #0#23 +. nNeto;
          #0#24 = #0#24 +. nIva;
          #0#25 = #0#25 +. nRec;
     |FINSI;
     |SI #1#13 = 3;
          #0#26 = #0#26 +. nNeto;
          #0#27 = #0#27 +. nIva;
          #0#47 = #0#47 +. nRec;
     |FINSI;
     |SI #1#13 = 4;
          #0#48 = #0#48 +. nNeto;
          #0#49 = #0#49 +. nIva;
          #0#50 = #0#50 +. nRec;
     |FINSI;
     |SI #1#13 = 5;
          #0#51 = #0#51 +. nNeto;
          #0#52 = #0#52 +. nIva;
          #0#53 = #0#53 +. nRec;
     |FINSI;
     #0#4=#0#21+#0#22+#0#24+#0#25+#0#27+#0#47+#0#49+#0#50+#0#52+#0#53;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴CONTADOR컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO SiguienteFac;
     aSer = #0#57;
     #12#48 = aSer;
     #12#0 = 999999;
     |LEE 000#12];
     |SI FSalida = 0;
          |LEE 000#12a;
     |SINO;
          |LEE 000#12u;
     |FINSI;
     |SI FSalida = 0; |Y #12#48 = aSer;
          conta_reg = #12#0 + 1;
     |SINO;
          conta_reg = 1;
     |FINSI;
     |DDEFECTO #12;
     #12#48 = aSer;
     #12#0 = conta_reg;
|FPRC;

|PROCESO SiguienteAlb;
     aSer = #0#57;
     #16#52 = aSer;
     #16#0 = 999999;
     |LEE 000#16];
     |SI FSalida = 0;
          |LEE 000#16a;
     |SINO;
          |LEE 000#16u;
     |FINSI;
     |SI FSalida = 0; |Y #16#52 = aSer;
          conta_reg = #16#0 + 1;
     |SINO;
          conta_reg = 1;
     |FINSI;
     |DDEFECTO #16;
     #16#52 = aSer;
     #16#0 = conta_reg;
|FPRC;

|PROCESO SiguienteTiq;
     |SALVA_FICHA #0;
     |SELECT #2#0;
     aSer = #0#57;
     #0#35 = "T";
     #0#58 = 999999;
     |LEE 000#0];
     |SI FSalida = 0;
          |LEE 000#0a;
     |SINO;
          |LEE 000#0u;
     |FINSI;
     |SI FSalida = 0; |Y #0#57 = aSer; |Y #0#35 = "T";
          conta_reg = #0#58 + 1;
     |SINO;
          conta_reg = 1;
     |FINSI;
     |SELECT #1#0;
     |REPON_FICHA #0;
|FPRC;

|PROCESO contique;
     conta_reg = 0;
     |ABRE #51;
     |DDEFECTO #51;
     #51#0 = claveconta;
     claveconta = #51#0;        ||para que lo rellene de blancos
     #51#1 = #0#57;
     |LEE 141#51];
     |PARA; |SI FSalida = 0; |Y #51#0 = claveconta; |Y #51#1 = #0#57; |HACIENDO;
          claveconta = #51#0;
          |SI #51#3 = #0#14;
               conta_reg = #51#2;
               |BORRA 040#51a;
               |SAL;
          |FINSI;
          |LIBERA #51;
          |LEE 141#51s;
     |SIGUE;
     |CIERRA #51;

     |SI conta_reg = 0;
          |ABRE #5;
          #5#0 = claveconta;
          #5#2 = #0#57;
          |LEE 141#5=;
          |SI FSalida ! 0;
               #5#1 = 1;
               |GRABA 040#5b;
          |FINSI;
          conta_reg = #5#1;
          #5#1 = #5#1 + 1;
          |GRABA 040#5a;
          |CIERRA #5;
     |FINSI;
|FPRC;

|PROCESO Contador;
     |SI aFormaPago = "B";
          conta_reg = 0;
          |ACABA;
     |FINSI;
     |SI aTipo = "A";
          |SI #142#137 = "F";
               |PARA FSalida = 0; |SI FSalida = 0; |HACIENDO;
                    |DDEFECTO #16;
                    claveconta = "valbaran";
                    |HAZ contique;
                    #16#52 = #0#57;
                    #16#0 = conta_reg;
                    |LEE 000#16=;
               |SIGUE;
               |DDEFECTO #16;
               #16#52 = #0#57;
               #16#0 = conta_reg;
          |SINO;
               |HAZ SiguienteAlb;
          |FINSI;
     |FINSI;
     |SI aTipo = "T";
          |SI #142#137 = "F";
               claveconta = "vtiquet";
               |HAZ contique;
          |SINO;
               |HAZ SiguienteTiq;
          |FINSI;
     |FINSI;
     |SI aTipo = "F";
          |SI #142#137 = "F";
               |SI #142#26 = "S";
                    claveconta = "vfactura";
               |SINO;
                    claveconta = "vfactuco";
               |FINSI;
               |HAZ contique;
               |DDEFECTO #12;
               #12#48 = #0#57;
               #12#0 = conta_reg;
          |SINO;
               |HAZ SiguienteFac;
          |FINSI;
     |FINSI;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO CabFactu;
     aDivisa = eaMoneda;
     aMoneda = "B";
     |HAZ Divisas084;

     aAlfa = aFNomCliente + aFNifCliente + aFDirCliente + aFPobCliente;
     |QBT aAlfa;
     |SI aAlfa ! "";
          #12#4 =  aFNomCliente;
          #12#60 = aFNifCliente;
          #12#30 = aFDirCliente;
          #12#31 = aFPobCliente;
     |SINO;
          #12#4 = #14#1;              ||Nombre
          #12#60 = #14#15;             ||Cif
          #12#30 = #14#8;             ||Dir Entrega
          #12#31 = #14#9;             ||Pob Entrega
     |FINSI;

     #12#40 = #14#16;
     #12#61 = "N";
     #12#62 = "00.00.0000";

     #12#1 = #0#14;                   ||Fecha
     #12#3 = #0#1;                    ||Cliente
     #12#5 = #0#17;                   ||Dto
     aAlfa1 = #4#111;    |QBF aAlfa1;
     |SI aAlfa1 ! "";
          #12#6 = #4#111;            || representante fijo
     |SINO;
          #12#6 = #0#33;             || cajero como representante
     |FINSI;
     #12#7 = #0#18;             ||Dto pp
     #12#8 = #14#20;            ||Forma de Pago
     #12#9 = #14#35;            ||Agencia Transportes
     #12#15 = #0#3;             ||Total bruto
     #12#36 = #0#29;            ||Regimen equivalencia || *(3)

     #12#29 = #14#2;             ||Entregar a
     #12#32 = #0#19;             ||Dto Acumulado
     #12#33 = #14#10;             ||Prov Entrega
     #12#34 = #14#7;             ||Tipo Comision
     #12#35 = #14#4;             ||Tipo Cliente

     #12#28 = #0#30;            ||Base Exenta

     #12#16 = #0#20;            ||Base Iva 1
     #12#17 = #0#21;            ||Cuota Iva 1
     #12#18 = #0#22;            ||Cuota Rec Iva 1

     #12#19 = #0#23;            ||Base Iva 2
     #12#20 = #0#24;            ||Cuota Iva 2
     #12#21 = #0#25;            ||Cuota Rec Iva 2

     #12#22 = #0#26;            ||Base Iva 3
     #12#23 = #0#27;            || Cuota I.Va. 3
     #12#49 = #0#47;

     #12#42 = #0#48;            ||Base iva 4
     #12#43 = #0#49;            ||Cuota iva 4
     #12#44 = #0#50;            ||Cuota Rec iva 4

     #12#45 = #0#51;            ||Base iva 5
     #12#46 = #0#52;            ||Cuota iva 5
     #12#47 = #0#53;            ||Cuota Reciva 5

     #12#24 = #0#4;             ||Total iva
     #12#25 = nDto;             ||Total descuento
     #12#41 = #0#9;             ||Total factura
  ||   #12#63 =                   ||a Cuenta

     j = 49;
     |PARA i = 1; |SI i [ 5; |HACIENDO i = i + 1;
          #1#13 = i;
          eaCli = #0#1; enTiva = i; efFiva = #0#14; |HAZ IVACli;
          j = j + 1; #12#j# = enIva;
          j = j + 1; #12#j# = enRec;
     |SIGUE;

     #12#67 = "B";        ||Moneda de trabajo
     #12#65 = eaMoneda;   ||Divisa
     #12#68 = eaMoneda;   ||Moneda Base
     #12#66 = enValMone;  ||Cambio moneda base a euros
     #12#69 = enValMone;  ||Cambio moneda base a euros
     #12#70 = #0#3;    ||Bruto en Divisa
     #12#71 = #0#9;    ||Total Albaran en Divisa
     #12#72 = #0#3;    ||Bruto (vis)
     #12#73 = #0#9;    ||Total (vis)
     #12#74 = #0#3;    ||Bruto (no vis)
     #12#75 = #0#9;    ||Total (no vis)
     #12#87 = "N:" + #0#0;
     |GRABA 000#12n;
     |SI nSwSimula = 0;
          |SI #142#47 = "S";  ||컴컴컴컴컴컴 Acumula en Riesgo Si Crea Recibos = "S"
               eaTag = "FC";  |HAZ Riesgos;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GraFactuKit;
     #948#0 = #13#20;
     #948#1 = #13#0;
     #948#2 = #13#1;
     #948#6 = #951#6;

     #948#3 = #951#3;
     #948#4 = #951#4;
     #948#5 = #951#5;
     #948#7 = #951#7;
     #948#8 = #951#8;
     |GRABA 040#948n;
|FPRC;

|DEFBUCLE GraFactuKit;
     #951#1;
     ;
     #1#20, #1#0, #1#1, 001;
     #1#20, #1#0, #1#1, 999;
     ;
     NULL, GraFactuKit;
|FIN;

|PROCESO LinFactu;
     aDivisa = #12#65;
     aMoneda = #12#67;
     |HAZ Divisas084;
     |DDEFECTO #13;
     #13#20 = #0#57;        ||Serie
     #13#0 = #0#58;
     #13#1 = #1#1;
     #13#2 = #1#2;              ||Articulo
     #13#3 = #1#3;              ||almacen
     #13#4 = #1#8;              ||Descripcion
     #13#5 = #1#5;              ||Unidades
     #13#6 = #1#10;             ||Precio
     #13#8 = #1#14;             ||Dto
     |SI #2#194 = 2;
          #13#7 = #1#29 * #13#6;||Importe
          #13#9 = (#1#29 * #13#6) < #13#8;||Imp.Tot
     |SINO;
          #13#7 = #1#5 * #13#6;||Importe
          #13#9 = (#1#5 * #13#6) < #13#8;||Imp.Tot
     |FINSI;
     #13#11 = #1#13;            ||Tipo de Iva
     #13#13 = #1#11;            ||Familia
     #13#14 = #1#23;            ||Coste
     #13#15 = #0#1;             ||Cliente
     #13#16 = #12#34;           ||Tipo Comision
     #13#17 = #12#35;           ||Tipo Cliente
     #13#30 = #1#29;            ||Uni2
     #13#31 = #1#30;            ||Partida
     #13#32 = #1#31;            ||Merma
     |GRABA 000#13n;

     |SI nSwSimula = 0;
          |ABRE #948;
          |BUCLE GraFactuKit;
          |CIERRA #948;
     |FINSI;
     |HAZ Divisa;
|FPRC;

|PROCESO CabAlba;
     #16#1 = #0#14;             ||Fecha
     #16#3 = #14#0;             ||Cliente
     #16#4 = #14#1;             ||Nombre
     #16#5 = #0#17;             ||Dto
     aAlfa = #4#111; |QBF aAlfa;
     |SI aAlfa ! "";
         #16#6 = #4#111;            || representante fijo
     |SINO;
         #16#6 = #0#33;             || cajero como representante
     |FINSI;
     #16#7 = #0#18;              ||Dto pp
     #16#8 = #14#20;             ||Forma de Pago
     #16#9 = #14#35;             ||Agencia Transportes
     #16#15 = #0#3;             ||Total bruto
     #16#16 = #0#20;            ||Base Iva 1
     #16#36 = #0#29;            || Recargo de Equivalencia || *(3)
     #16#40 = #14#41;
     #16#50 = #14#40;           ||Albaran valorado S/N;

     eaCli = #0#1; efFiva = #0#14;
     enTiva = 1; |HAZ  IVACli;
     #16#17 = #16#16 % enIva;   || Cuota I.Va. 1
     |SI #16#36 = "S";
          #16#18 = #16#16 % enRec;   || Cuota Rec I.Va. 1
     |FINSI;
     #16#19 = #0#23;            ||Base Iva 2

     enTiva = 2; |HAZ  IVACli;
     #16#20 = #16#19 % enIva;   || Cuota I.Va. 2
     |SI #16#36 = "S";
          #16#21 = #16#19 % enRec;   || Cuota Rec I.Va. 2
     |FINSI;
     #16#22 = #0#26;            ||Base Iva 3

     enTiva = 3; |HAZ  IVACli;
     #16#23 = #16#22 % enIva;   || Cuota I.Va. 3
     |SI #16#36 = "S";
         #16#54 = #16#22 % enRec;   ||Cuota Rec Iva 3
     |FINSI;
     #16#25 = nDto;            ||Total descuento
     #16#28 = #0#30;            ||Base Exenta
     #16#29 = #14#2;             ||Entregar a
     #16#30 = #14#5;             ||Dir Entrega
     #16#31 = #14#6;             ||Pob Entrega
     #16#32 = #0#19;            ||Dto Acumulado
     #16#33 = #14#7;             ||Prov Entrega
     #16#35 = #14#4;             ||Tipo Cliente
     #16#63 = #14#15;             ||DNI;
     #16#44 = #0#48;            ||Base iva 4

     enTiva = 4; |HAZ  IVACli;
     #16#45 = #16#44 % enIva;   || Cuota I.Va. 4
     |SI #16#36 = "S";
         #16#46 = #16#44 % enRec;   || Cuota Rec I.Va. 4
     |FINSI;
     #16#47 = #0#51;            ||Base iva 5

     enTiva = 5; |HAZ  IVACli;
     #16#48 = #16#47 % enIva;   || Cuota I.Va. 5
     |SI #16#36 = "S";
         #16#49 = #16#47 % enRec;   || Cuota Rec I.Va. 5
     |FINSI;
     || *(3) Total ivas. Cogido a pelo de agifa010
     #16#24=#16#17+#16#20+#16#23+#16#18+#16#21+#16#45+#16#46+#16#48+#16#49+#16#54;
     #16#61 = 0;

     #16#68= eaMoneda;   ||Divisa
     #16#69= enValMone;  ||Cambio divisa a euros
     #16#70="B";         ||Moneda de trabajo
     #16#71="A";         ||Cambio en albaran
     #16#73= eaMoneda;   ||Moneda Base
     #16#74= enValMone;  ||Cambio moneda base a euros
     #16#75=#0#3; ||Bruto en Divisa
     #16#76=#0#9; ||Total Albaran en Divisa
     #16#77=#0#3; ||Bruto (vis)
     #16#78=#0#9; || Total (vis)
     #16#79=#0#3;  ||Bruto (no vis)
     #16#80=#0#9; ||Total (no vis)
     #16#83 = "N:" + #0#0;
     |GRABA 040#16n;
|FPRC;

|PROCESO GraAlbaKit;
     #947#0 = #17#29;
     #947#1 = #17#0;
     #947#2 = #17#1;
     #947#6 = #951#6;

     #947#3 = #951#3;
     #947#4 = #951#4;
     #947#5 = #951#5;
     #947#7 = #951#7;
     #947#8 = #951#8;
     |GRABA 040#947n;
|FPRC;

|DEFBUCLE GraAlbaKit;
     #951#1;
     ;
     #1#20, #1#0, #1#1, 001;
     #1#20, #1#0, #1#1, 999;
     ;
     NULL, GraAlbaKit;
|FIN;

|PROCESO xLinAlba;
     |DDEFECTO #17;
     #17#29 = #0#57;            ||Serie
     #17#0 = #0#58;
     #17#1 = #1#1;
     #17#2 = #1#2;              ||Articulo
     #17#3 = #1#3;           ||almacen
     #17#4 = #1#8;              ||Descripcion
     #17#5 = #1#5;              ||Unidades
     #17#6 = #1#10;             ||Precio
     #17#8 = #1#14;             ||Dto
     |SI #2#194 = 2;
          #17#7 = #1#29 * #17#6;     ||Importe
          #17#9 = (#1#29 * #17#6) < #17#8;||Imp.Tot
     |SINO;
          #17#7 = #1#5 * #17#6;     ||Importe
          #17#9 = (#1#5 * #17#6) < #17#8;||Imp.Tot
     |FINSI;
     #17#11 = #1#13;            ||Tipo de Iva
     #17#13 = #1#11;            ||Familia
     #17#14 = #1#23;            ||Coste
     #17#15 = #0#1;             ||Cliente
     #17#16 = #16#34;           ||Tipo Comision
     #17#17 = #16#35;           ||Tipo Cliente
     #17#48 = #1#29;            ||Uni2
     #17#49 = #1#30;            ||Partida
     #17#50 = #1#31;            ||Merma
     |GRABA 040#17n;

     |SI nSwSimula = 0;
          |ABRE #947;
          |BUCLE GraAlbaKit;
          |CIERRA #947;
     |FINSI;
|FPRC;

|PROCESO Graba501_502;
     |HAZ LeeIVA;

     |SI nPrimeLin = 0;
          nPrimeLin = #ib__tick#1;
          |DDEFECTO #agifa501;
          #0#0 = nNuevoTicket;
          #0#36 = aSesion;
          #0#35 = aTipo;
          |SI aTieneCaja2 = "S";|Y aCaja2 = "S";  || caja bar "la otra"
               |SI aTipo = "F";
                    aSer = #agifa505#104;
               |SINO;
                    |SI aTipo = "A";
                         aSer = #agifa505#103;
                    |SINO;
                         aSer = #agifa505#89;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI aTipo = "F";
                    aSer = #agifa505#107;
               |SINO;
                    |SI aTipo = "A";
                         aSer = #agifa505#106;
                    |SINO;
                         aSer = #agifa505#105;
                    |FINSI;
               |FINSI;
          |FINSI;

          #0#57 = aSer;
          |SI nSwSimula = 0;
               |HAZ Contador;
               #0#58 = conta_reg;
          |SINO;
               #0#57 = aSer;
               #0#58 = #0#0;
               #12#48 = #0#57;
               #12#0 = #0#0;
               #16#52 = #0#57;
               #16#0 = #0#0;
          |FINSI;
          #0#1 = #agifa024#0;
          #0#2 = "N";
          #0#5 = "";
          #0#7 = #agifa024#15;
          #0#12 = acaja;
          #0#14 = afecha;
          #0#17 = #ib__tick#17;
          #0#31 = aFormaPago;
          #0#32 = nAlma;
          #0#33 = #ib__tick#4;
          #0#34 = aHora;
          #0#37 = #ib__tick#16; ||Tarjeta
          #0#46 = nCodTarjeta;
          #0#55 = nComensales;
          #0#56 = #ib__tick#6;  || Mesa
          #0#75 = #ib__tick#10; || Sala
          |SI nImporteConPesetas = 1;
               nEfectivo = nTotalPtas - nTarjetaPtas - nChequePtas - nDeudaPtas;

               #agifa501#40 = nTarjetaPtas; || Cob. Tarjeta
               #agifa501#39 = nChequePtas;  || Cob. Cheque
               #agifa501#41 = nDeudaPtas;   || Pend. Credito
               #agifa501#10 = nEntregaPtas;
               #agifa501#11 = nEntregaPtas - nTotalPtas;     ||Cambio
               #agifa501#38 = nEfectivo;    |||nTotalPtas;   || Efectivo
               |SI aFormaPago = "B";
                    #agifa501#62 = nTotalPtas;
                    #0#31 = "R";
               |FINSI;
          |SINO;
               nEfectivo = nTotalEuros - nTarjetaEuros - nChequeEuros - nDeudaEuros;

               #agifa501#40 = nTarjetaEuros; || Cob. Tarjeta
               #agifa501#39 = nChequeEuros;  || Cob. Cheque
               #agifa501#41 = nDeudaEuros;   || Pend. Credito
               #agifa501#10 = nEntregaEuros;
               #agifa501#11 = nEntregaEuros - nTotalEuros; ||Cambio
               #agifa501#38 = nEfectivo; || nTotalEuros;   || Efectivo
               |SI aFormaPago = "B";
                    #agifa501#62 = nTotalEuros;
                    #0#31 = "R";
               |FINSI;
          |FINSI;

          |SI #agifa501#11 < 0; #agifa501#11 = 0; |FINSI;

          |SI #0#35 = "A"; |O nSwSimula = 1; |O aEsGratis = "S";
                    |O aHabitacion = "S"; |O aFormaPago = "B";
               #agifa501#10 = 0;  ||Entrega
               #agifa501#11 = 0;  ||Cambio
               #agifa501#38 = 0;  ||Efec
               #agifa501#39 = 0;  ||Cheque
               #agifa501#40 = 0;  ||Tarj
               #agifa501#41 = 0;  ||Pend.Credito
               #agifa501#59 = 0;  ||Cargo Habi
               #agifa501#63 = 0;  ||Invitacion  (lo cargo abajo)
          |FINSI;
          #agifa501#60 = xhotel;  || Hotel si es con cargo a  la  Habitacion.
          #agifa501#61 = xhabita; || Habit '' ''  ''  ''   '' ''   ''  ''
          |GRABA 040#agifa501.b;
     |FINSI;

     |DDEFECTO #agifa502;
     #1#20 = #0#36;
     #1#0 = #0#0;
     #1#1 = #ib__tick#1;
     #1#2 = #agifa019#0;    ||Articulo
     #1#3 = nAlma;
     #1#4 = #0#1;           ||Cliente
     #1#5 = #ib__tick#7;                   ||Unid.

     rec = enRec;
     |SI #0#29 ! "S"; rec = 0; |FINSI;

     |SI aIVAinc = "S";
          |SI nImporteConPesetas = 1;  || mostrar columna pesetas 1-si 0-no
               #1#6 = #ib__tick#8;     ||PVP con IVA Ptas
          |SINO;
               #1#6 = #ib__tick#9;     ||PVP con IVA Euro
          |FINSI;
          nTotal0 = ((#1#6 * #1#5) < #1#14);
          nBase0 = (nTotal0 / (1 + ((enIva + rec) / 100) ));
          nTotal = ((#1#6 * #1#5) < #1#14)!nDeci_Base; ||EURODB;
          nBase = (nTotal / (1 + ((enIva + rec) / 100) ))!nDeci_Base; || EURODB;
          nIva = nTotal - nBase;
          #1#10 = (nBase0 / #1#5) ! nDeci_PreBase;
          #1#7 = nTotal;
          #1#21 = nBase;
          #1#19 = nIva;
     |SINO;
          |SI nImporteConPesetas = 1;   || mostrar columna pesetas 1-si 0-no
               #1#10 = #ib__tick#8;     ||PVP con IVA Ptas
          |SINO;
               #1#10 = #ib__tick#9;     ||PVP con IVA Euro
          |FINSI;
          #1#21 = ((#1#10 * #1#5) < #1#14) ! EURODB;
          #1#7 = (#1#21 + ((#1#21 * (enIva + rec) / 100))) ! EURODB;
          #1#19 = #1#7 - #1#21;
          #1#6 = #1#10 + (#1#10 * (enIva + rec) / 100);
     |FINSI;
     #1#8 = #agifa019#1;
     #1#9 = #0#14;
     #1#11 = #agifa019#2;
     #1#12 = #agifa019#3;
     #1#13 = enTiva;
     #1#15 = #0#12;
     #1#16 = aHora;
     #1#17 = #0#33;
     #1#18 = #0#35;
     #1#22 = #agifa019#128;
     #1#23 = #1#5 * #agifa019#9;

     #1#12 = #ib__tick#11;       || Plato/SubFam
     aAlfa = #ib__tick#12;
     |QBF aAlfa;
     |SI aAlfa ! "";
          #1#8 = aAlfa;          || Descripcion
     |FINSI;

     |GRABA 040#agifa502.b;
     |SI FSalida = 0;
          |HAZ actua_cabe;

          |SI aEsGratis = "S";
               #0#63 = #0#9;          ||Invitacion
          |FINSI;
          |SI aHabitacion = "S";      ||Cargo Hotel
               #0#59 = #0#9;
          |FINSI;
          |GRABA 040#agifa501.a;
          |LIBERA #agifa501;

          |SI #0#35 = "A"; |HAZ xLinAlba; |FINSI;
          |SI #0#35 = "F"; |HAZ LinFactu; |FINSI;
          |SI nSwSimula = 0;
               aArti = #agifa502#2;
               nAlma = #agifa502#3;
               nUni =  #agifa502#5;
               nPreHist = #agifa502#6;
               |HAZ ActuaStock;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO HallaAlmacen;
     |ABRE #120;
     |SI eaTipoTactil = "C";
          |SELECT #3#120;
          #120#0 = eaCentro;
          #120#2 = #agifa019#0;
     |SINO;
          |SELECT #1#120;
          #120#0 = eaCentro;
          #120#1 = nPuntoDeVenta;
          #120#2 = #agifa019#0;
     |FINSI;
     |LEE 000#120=;
     |CIERRA #120;
     nAlma = #120#4;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO ib__ticd;
     #agifa019#0 = #ib__ticd#3;
     |LEE 000#agifa019.=;
     |SI FSalida ! 0; |DDEFECTO #agifa019; |FINSI;

     |HAZ HallaAlmacen;

     |DDEFECTO #dsm00051;
     #dsm00051#0 = aSesion;
     #dsm00051#1 = nNuevoTicket;
     #dsm00051#2 = #ib__ticd#4;
     #dsm00051#6 = #ib__ticd#1;
     |LEE 141#dsm00051.=;
     |SI FSalida ! 0; |GRABA 040#dsm00051.b; |FINSI;
     #dsm00051#3 = #ib__ticd#3;    || Arti
     #dsm00051#4 = nAlma;
     #dsm00051#5 = #dsm00051#5 + 1;|| Uni
     #dsm00051#8 = #agifa019#9;    || PCM
     |GRABA 040#dsm00051.a;

     aArti = #dsm00051#3;
     nAlma = #dsm00051#4;
     nUni = #dsm00051#5;
     nPreHist = 0;
     |HAZ ActuaStock;
     ||컴컴컴컴컴컴컴컴컴
     nPrimeLin = nPrimeLin + 1;
     #1#1 = nPrimeLin;
     #1#2 = #2#0;
     #1#3 = nAlma;
     #1#6 = 0;
     #1#7 = 0;
     #1#8 = #2#1;
     #1#10 = 0;
     #1#11 = #2#2;
     #1#12 = #2#3;
     #1#13 = 0;
     #1#14 = 0;
     #1#19 = 0;
     #1#21 = 0;
     #1#22 = #2#128;
     #1#23 = 0;
     #1#24 = 1;                ||MARCA DESGLOSE
     #1#26 = 0;
     |GRABA 040#1n;
     |BORRA 040#ib__ticd.a;
|FPRC;

|DEFBUCLE ib__ticd;
     #ib__ticd#1;
     ;
     nElTicket, 0001, 0001;
     nElTicket, 9999, 9999;
     be;
     NULL, ib__ticd;
|FIN;

|PROCESO ib__tick;
     aAlfa = #ib__tick#2; |QBT aAlfa;
     |SI aAlfa = ""; |Y #ib__tick#8 = 0; |Y #ib__tick#9 = 0;
          |SI nSwSimula = 0;
               |BORRA 040#ib__tick.a;
          |FINSI;
          |ACABA;   || SIN PRECIO y SIN ARTICULO (= mensaje cocina)
     |FINSI;
     |SI #ib__tick#18 = "S";
          |SI nSwSimula = 0;
               |BORRA 040#ib__tick.a;
          |FINSI;
          |ACABA;   || MENU = S
     |FINSI;

     |SI nLinAgr = 0;
          Cam2 = #ib__tick#2;
          Cam8 = #ib__tick#8;
          Cam9 = #ib__tick#9;
          Cam17 = #ib__tick#17;
          nLinAgr = #ib__tick#1;
          nUniAgr = 0;
     |FINSI;

     |SI #ib__tick#2 ! Cam2; |O #ib__tick#8 ! Cam8;
               |O #ib__tick#9 ! Cam9; |O #ib__tick#17 ! Cam17;

          |SALVA_FICHA #ib__tick;
          #ib__tick#1 = nLinAgr;
          |LEE 000#ib__tick.=;
          #ib__tick#7 = nUniAgr;

          |ABRE #agifa019;
          |DDEFECTO #agifa019;
          #agifa019#0 = #ib__tick#2;
          |LEE 000#agifa019.=;
          |CIERRA #agifa019;

          |HAZ HallaAlmacen;
          |HAZ Graba501_502;

          |REPON_FICHA #ib__tick;
          Cam2 = #ib__tick#2;
          Cam8 = #ib__tick#8;
          Cam9 = #ib__tick#9;
          Cam17 = #ib__tick#17;
          nLinAgr = #ib__tick#1;
          nUniAgr = #ib__tick#7;
     |SINO;
          nUniAgr = nUniAgr + #ib__tick#7;
     |FINSI;
|FPRC;

|DEFBUCLE ib__tick;
     #ib__tick#1;
     ;
     nElTicket, 0001;
     nElTicket, 9999;
     be;
     NULL, NULL, NULL, NULL, NULL, ib__tick;
     #ib__tick#2, #ib__tick#8, #ib__tick#9, #ib__tick#17;
|FIN;

|PROCESO Resto_tick;
     |ABRE #ib__tick;
     #ib__tick#0 = nElTicket;
     #ib__tick#1 = nLinAgr;
     |LEE 000#ib__tick.=;

     #ib__tick#7 = nUniAgr;

     |ABRE #agifa019;
     |DDEFECTO #agifa019;
     #agifa019#0 = #ib__tick#2;
     |LEE 000#agifa019.=;
     |CIERRA #agifa019;

     |HAZ HallaAlmacen;
     |HAZ Graba501_502;

     |CIERRA #ib__tick;
|FPRC;

|PROCESO ib__tickBorra;
     |BORRA 040#ib__tick.a;
|FPRC;

|DEFBUCLE ib__tickBorra;
     #ib__tick#1;
     ;
     nElTicket, 0001;
     nElTicket, 9999;
     be;
     NULL, ib__tickBorra;
|FIN;

|DEFBUCLE SimulaImpre;
     #ib__tick#1;
     ;
     nElTicket, 0001;
     nElTicket, 9999;
     be;
     NULL, ib__tick;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴 Impresion 컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO imprelin;
     |SI #agifa502#24 = 0;    ||MARCA DESGLOSE
          |PRINT;
     |FINSI;
|FPRC;

|PROCESO lee_serie;
     |DDEFECTO #43;
     |ABRE #43;
     #43#26 = #0#57;
     |LEE 000#43=;
     |CIERRA #43;

     aInfTiq = #43#21; |QBF aInfTiq;
     aInfAlb = #43#4;  |QBF aInfAlb;
     aInfFac = #43#11; |QBF aInfFac;
     |SI eaTipoTactil = "A";       || el informe de la alacena es el tiquet
          aInfTiq = #43#21 % -107; || pero la primera letra es una 'a'
          aInfTiq = "a" + aInfTiq; |QBF aInfTiq;
     |FINSI;
|FPRC;

|DEFBUCLE imprelin;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, imprelin;
|FIN;

|PROCESO ImpresionTicket;
     |SI nSwSimula = 0;
          eaLogCaj = "TIQUET";
          |HAZ LogCajon;
          |HAZ AbreCajon;
     |FINSI;
     |HAZ lee_serie;

     aAlfa = (#0#34 % 102) + (#0#34 % 402);
     fGuarda = #0#14;
     |SI  aAlfa ] #4#155; |Y aAlfa [ #4#156;
          #0#14 = #0#14 + 1;
     |FINSI;
     Impresora = impr_tpv;
     |IMPRE -1;
     |SI FSalida = 0;
          |INFOR aInfTiq;
          |SI FSalida = 0;
               |BUCLE imprelin;
               |||BUCLELIN 2imprelin #0;
               |PIEINF;
               |FININF;
          |FINSI;
          |FINIMP;
     |FINSI;
     #0#13 = "S";
     #0#16 = #0#16 + 1;
     #0#14 = fGuarda;
|FPRC;

|PROCESO &Defecto; || El informe Estandar 'agifa010' tiene esta llamada
|FPRC;

|PROCESO impreAlb;
     |HAZ ParcheImpAlb;
     |PRINT;
|FPRC;

|DEFBUCLE impreAlb;
     #17#1;
     ;
     #16#52, #16#0, 001;
     #16#52, #16#0, 999;
     ;
     NULL, impreAlb;
|FIN;

|PROCESO ImpresionAlba;
     |HAZ lee_serie;
     |ABRE #16;
     #16#52 = #0#57;
     #16#0 = #0#58;
     |LEE 141#16=;
     |SI FSalida = 0;
          Impresora = impr_tpv;
          |IMPRE -1;
          |SI FSalida = 0;
               |INFOR aInfAlb;
               |SI FSalida = 0;
                    |BUCLE impreAlb;
                    |PIEINF;
                    |FININF;
               |FINSI;
               |FINIMP;
          |FINSI;
          #16#90 = "S";
          |GRABA 020#16a;
     |FINSI;
     |CIERRA #16;
|FPRC;

|PROCESO ImpresionFactu;
     |SI nSwSimula = 0;
          eaLogCaj = "FACTURA";
          |HAZ LogCajon;
          |HAZ AbreCajon;
     |FINSI;
     |HAZ lee_serie;

     |PARA i = 0; |SI i [ #41#19; |HACIENDO i = i + 1;
          |ABRE #12;
          #12#48 = #0#57;
          #12#0 = #0#58;
          |LEE 141#12=;
          |SI FSalida = 0;
               aAlfa = (#0#34 % 102) + (#0#34 % 402);
               fGuarda = #12#1;
               |SI  aAlfa ] #4#155; |Y aAlfa [ #4#156;
                    #12#1 = #12#1 + 1;
               |FINSI;
               Impresora = impr_tpv;
               |IMPRE -1;
               |SI FSalida = 0;
                    |INFOR aInfFac;
                    |SI FSalida = 0;
                      ||   |HAZ ImpreFac;
                         |BUCLELIN 2imprelin #12;
                         |PIEINF;
                         |FININF;
                    |FINSI;
                    |FINIMP;
               |FINSI;
               #12#1 = fGuarda;
               #12#10 = "S";
               |GRABA 020#12a;
          |FINSI;
          |CIERRA #12;
          |SI nSwSimula = 1; |SAL; |FINSI;
     |SIGUE;
|FPRC;
||컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO RecuDesglo;
     aArti = #dsm00051#3;
     nAlma = #dsm00051#4;
     nUni = #dsm00051#5;
     nPreHist = 0;
     |HAZ ActuaStock;

     #ib__ticd#0 = #951#1; ||Num
     #ib__ticd#4 = #951#2; ||Lin Tiq
     #ib__ticd#1 = #951#6; ||Lin
     #ib__ticd#2 = #1#2;   ||Art
     #ib__ticd#3 = #951#3; ||ArtDes
     |GRABA 040#ib__ticd.n;
     |BORRA 040#951a;
     aAlfa = "S";
|FPRC;

|DEFBUCLE RecuDesglo;
     #951#1;
     ;
     #1#20, #1#0, #1#1, 001;
     #1#20, #1#0, #1#1, 999;
     be;
     NULL, RecuDesglo;
|FIN;

|PROCESO LinRecupera;
     aAlfa = "N";
     |BUCLE RecuDesglo;
     aArti = #agifa502#2;
     nAlma = #agifa502#3;
     nUni =  #agifa502#5;
     nPreHist = #agifa502#6;
     nForma = -1;

     |HAZ ActuaStock;

     enTiva = #1#13;
     efFiva = afecha;
     |HAZ SacaIVA;

     |SI #agifa502#24 = 1;    || MARCA DESGLOSE
          |BORRA 020#1a;
          |ACABA;
     |FINSI;

     #ib__tick#0 = #1#0;   || Num
     #ib__tick#1 = #1#1;   || Lin
     #ib__tick#2 = #1#2;   || Art
     #ib__tick#3 = aAlfa;  || Config.
     #ib__tick#4 = #0#33;  || Cama
     #ib__tick#5 = #0#1;   || Clie
     #ib__tick#6 = #0#56;  || Mesa
     #ib__tick#7 = #1#5;   || Uni
     |SI nImporteConPesetas = 1;       || mostrar columna pesetas 1-si 0-no
          |SI aIVAinc = "S";
               #ib__tick#8 = #1#6;          || Pta
               #ib__tick#9 = #1#6 / 166.386;|| Eur
          |SINO;
               #ib__tick#8 = #1#10;          || Pta
               #ib__tick#9 = #1#10 / 166.386;|| Eur
          |FINSI;
     |SINO;
          |SI aIVAinc = "S";
               #ib__tick#9 = #1#6;          || Pta
               #ib__tick#8 = #1#6 * 166.386;|| Eur
          |SINO;
               #ib__tick#9 = #1#10;          || Pta
               #ib__tick#8 = #1#10 * 166.386;|| Eur
          |FINSI;
     |FINSI;
     #ib__tick#10 = #0#75; ||Sala
     #ib__tick#11 = #1#12; ||Plato
     #ib__tick#12 = #1#8;  ||Descrip
     #ib__tick#17 = #0#17;  ||Dto
     #ib__tick#19 = enIva;
     |GRABA 040#ib__tick.n;
     |BORRA 040#1a;
|FPRC;

|PROCESO Configurable;
     #agifa019#0 = #ib__ticd#3;
     |LEE 000#agifa019.=;
     |SI FSalida ! 0; |DDEFECTO #agifa019; |FINSI;

     enPreTPV = enPreTPV + #agifa019#18;
|FPRC;

|DEFBUCLE Configurable;
     #ib__ticd#1;
     ;
     nContadorTicket, nLinTicket, 0001;
     nContadorTicket, nLinTicket, 9999;
     ;
     NULL, Configurable;
|FIN;
||컴컴컴컴컴컴컴컴컴컴 llamadas de la dll 컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO DesglosaBarra;
     |SI #87#2 = "B";
          aPos = ("00" + #87#3) % -102;
          aLon = ("00" + #87#4) % -102;
          aAlfa = aPos + aLon;
          aBarra = aArticulo % aAlfa;

          |SELECT #4#2;
          #2#128 = aBarra;
          |LEE 000#2=;
          |SI FSalida ! 0; |ACABA; |FINSI;
     |SINO;
          aPos = ("00" + #87#5) % -102;
          aLon = ("00" + #87#6) % -102;
          aAlfa = aPos + aLon;
          aArti = aArticulo % aAlfa;

          |SELECT #1#2;
          #2#0 = aArti;
          |LEE 000#2=;
          |SI FSalida ! 0; |ACABA; |FINSI;
     |FINSI;

     aPos = ("00" + #87#7) % -102;
     nNume = #87#8 + #87#13;
     aLon = ("00" + nNume) % -102;
     aAlfa = aPos + aLon;
     aPrec = aArticulo % aAlfa;
     |SI #87#13 > 0;
          aAlfa = "1" + ("0" * #87#13); nDeci = aAlfa;
          nNume = aPrec;
          nNume = nNume / nDeci;
          aPrec = nNume;
     |FINSI;

     aPos = ("00" + #87#9) % -102;
     nNume = #87#10 + #87#14;
     aLon = ("00" + nNume) % -102;
     aAlfa = aPos + aLon;
     aUnid = aArticulo % aAlfa;
     |SI #87#14 > 0;
          aAlfa = "1" + ("0" * #87#14); nDeci = aAlfa;
          nNume = aUnid;
          nNume = nNume / nDeci;
          aUnid = nNume;
     |FINSI;

     nNume = aUnid;      || si las unidades vienen con cero
     |SI nNume = 0;      ||/se pone un 1
          aUnid = "1";
     |FINSI;

     aPos = ("00" + #87#11) % -102;
     aLon = ("00" + #87#12) % -102;
     aAlfa = aPos + aLon;
     aMone = aArticulo % aAlfa;

     nSwDesBarra = 1;

     aArticulo = #2#0;
|FPRC;

|PROCESO &CambioCliente;
     || pos eso, se llama cuando cambia el cliente
     ||
     || Esta variablea demomento no se usa
     aDtoCliente = 0;
|FPRC;

|PROCESO &SacaElPrecio;
     |PULSATECLA;

     |HAZ DameCliente;
     nSwDesBarra = 0;

     aNomArticulo = "";
     |DDEFECTO #agifa019;
     |ABRE #agifa019;
     |SELECT #4#2;
     #2#128 = aArticulo;
     |LEE 000#2=;
     |SI FSalida = 0;
          aArticulo = #2#0;
     |SINO;
          aAlfa = aArticulo % 101;
          |ABRE #87;
          #87#0 = aAlfa;
          |LEE 000#87=;
          |SI FSalida = 0;
               |HAZ DesglosaBarra;
          |FINSI;
          |CIERRA #87;
     |FINSI;
     |CIERRA #agifa019;

     |ABRE #agifa019;
     |SELECT #1#19;
     #agifa019#0 = aArticulo;
     |LEE 000#agifa019.=;
     |SI FSalida = 0;
          aNomArticulo = #agifa019#110; |QBF aNomArticulo;
          |SI aNomArticulo = ""; aNomArticulo = #agifa019#1; |FINSI;
          fed_dt = afecha;       || Fecha....
          art_dt = #agifa019#0;  || Articulo.
          cli_dt = aCliente;     || Cliente..
          fam_dt = #agifa019#2;  || Familia.
          |SI #iber0016#28 = 0;
               iva_dt = #agifa019#30;
          |SINO;
               iva_dt = #iber0016#28;
          |FINSI;
          iva_dt = #agifa019#30; || Tipo Iva.
          dtos_2 = 0;            || Descuento 2.
          dto_pt = 0;            || Descuento Ptas.
          dtos_1 = 0;            || Descuento 1.
          pvp_ve = 0;            || Precio Venta.
          |SI #117#4 ! 0;
               tarifa = #117#4;
          |SINO;
               tarifa = #agifa024#39;
          |FINSI;
          gru_dt = #14#158;      || Grupo Cliente.
          presel = 0;            || Precio seleccion.
          dtosel = 0;            || Dto      '' ''
          uni_dt = 1;
          enMensaje = 0;
          aParam = "";
          |SI #2#176 = "S";  enMensaje   = 1; |FINSI;
          |SI #4#146 = "S";  enPromoTPV1 = 1; |FINSI;
          |SI #4#147 = "S";  enPromoTPV2 = 1; |FINSI;
          enDirEnt = 0;
          |HAZ calcdtos;
     |SINO;
          enPreTPV = 0;
     |FINSI;

     |HAZ LeeIVA;

     nIVAporA = enIva;

     |SI eaTipoTactil = "A"; |O eaTipoTactil = "C";
          nDPunto = 01;
          nHPunto = 99;
     |SINO;
          nDPunto = nPuntoDeVenta;
          nHPunto = nPuntoDeVenta;
     |FINSI;
     |HAZ BuscaPrecio;

     |SI eaIVAsn = "N";
          |SI aIVAinc = "S";
               enPreTPV = enPreTPV > enIva;
          |FINSI;
     |SINO;
          |SI aIVAinc = "N";
               enPreTPV = enPreTPV /(1+(enIva/100));
          |FINSI;
     |FINSI;
     enPreTPV = enPreTPV ! EURODB;

     |ABRE #100;
     #100#0 = #agifa019#2;
     #100#1 = #agifa019#0;
     |LEE 000#100=;
     |SI FSalida = 0; |Y #100#3 = "S"; || Configurable
          |BUCLE Configurable;
     |FINSI;
     |CIERRA #100;
     |CIERRA #agifa019;


     ||Controlar si Ptas o Euros, para mandarlo tal como esta (Ptas.)
     ||o al reves en el caso de que estemos trabajando en EUROS.
     ||Falta los parametros Divisas.

     |HAZ Divisa;
     |SI nImporteConPesetas ! 0;      || mostrar columna pesetas 1-si 0-no
          nPrecioPtas = enPreTPV;
          nPrecio = nPrecioPtas / 166.386;
     |SINO;
          nPrecio = enPreTPV;
          nPrecioPtas = nPrecio * 166.386;
     |FINSI;

     |SI nSwDesBarra = 1;
          |SI #87#7 ! 0;|Y #87#15 = "P";   || Precio Total
               nNume = aPrec;
               |SI aMone = 0;                     || pesetas
                    nPrecioPtas1 = nNume;
                    nPrecio1 = nPrecioPtas1 / 166.386;
               |SINO;                             || euros
                    nPrecio1 = nNume;
                    nPrecioPtas1 = nPrecio1 * 166.386;
               |FINSI;
               nNume = nPrecio1 / nPrecio;
               aUnidEsp = nNume;
          |FINSI;
          |SI #87#9 ! 0;|Y #87#15 = "U";   || unidades/peso
               aUnidEsp = aUnid;
          |FINSI;
     |FINSI;

     |ABRE #170;
     |DDEFECTO #170;
     #170#0 = nCentro;
     #170#1 = #agifa019#3;
     #170#2 = nPuntoDeVenta;
     |LEE 000#170=;
     |CIERRA #170;

     aFamilia = #agifa019#2; |QBF aFamilia;  || Carga Variable para DLL
     aSeccion = #170#3;      |QBF aSeccion;
|FPRC;

|PROCESO &LiberaTarj;
     |ACABA;

     #ibxxtarj#0 = "";
     #ibxxtarj#1 = 0;
     |LEE 000#ibxxtarj.=;
     |LIBERA #ibxxtarj;
|FPRC;

|PROCESO BloqueaTarj;
     |ACABA;

     #ibxxtarj#0 = "";
     #ibxxtarj#1 = 0;              || se utiliza para bloquear el acceso
     |LEE 141#ibxxtarj.=;          ||/al ibxxtarj
     |SI FSalida ! 0;
          |GRABA 040#ibxxtarj.b;   || se libera en LiberaTarj
     |FINSI;
|FPRC;

|PROCESO CodigoTarjeta;
     nCodTarjeta = 0;
     |QBF aTipoTarjeta;
     |SI aTipoTarjeta ! "";
          |ABRE #19; |SELECT #2#19;
          #19#1 = aTipoTarjeta;
          |LEE 000#19=;
          |SI FSalida = 0;
               nCodTarjeta = #19#0;
          |FINSI;
          |CIERRA #19;
     |FINSI;
|FPRC;

|PROCESO &CalculaTicket;
     |PULSATECLA;
     |SI eaNomDll ! "dsrestau1.dll";
          nComensales = 0;
     |FINSI;

     |HAZ BloqueaTarj;

     |HAZ CodigoTarjeta;

     nNuevoTicket = nElTicket;
     |SI eaTipoTactil = "A";|Y nSwSimula = 0;
          |HAZ PasaBascula;
          |ACABA;
     |FINSI;

     |SI nSwSimula = 0;
          |ABRE #0;
          #0#0 = nElTicket;
          #0#36 = aSesion;
          aSesion = #0#36;    ||Formateo
          |LEE 000#0=;
          |SI FSalida = 0;    || Si existe lo renumero !!!
               |LEE 000#0];
               |SI FSalida = 0;
                    |LEE 000#0a;
               |SINO;
                    |LEE 000#0u;
               |FINSI;
               |SI FSalida = 0; |Y #0#36 = aSesion;
                    nNuevoTicket = #0#0 + 1;
               |SINO;
                    nNuevoTicket = 1;
               |FINSI;
          |FINSI;
          |CIERRA #0;
     |FINSI;

     |SI aHabitacion = "S";
          |HAZ Habitacion;
          |SI xhabita = 0;
               aBuenTicket = "N";
               |ACABA;
          |FINSI;
     |SINO;
          xhabita = 0;
          xhotel = 0;
     |FINSI;

     nForma = 1;

     aTipo = "T";
     aOpeHis = "TI";
     |SI aTipoTactil = "R";  ||Restaurante siempre Factura/Albaran
          aTipo = "F";
          aOpeHis = "FC";
          |SI aFacturar = "A";
               aTipo = "A";
               aOpeHis = "AV";
          |FINSI;
     |SINO;
          |SI aFacturar = "S";  || Factura
               aTipo = "F";
               aOpeHis = "FC";
          |FINSI;
     |FINSI;

     |SI aFormaPago = "X";         || Pendiene CESC !!!!!!!
          aFormaPago = "E";
     |FINSI;

     |SI aEsGratis = "S";
          aFormaPago = "A";   || Invitacion
     |FINSI;

     |HAZ DameCliente;
     |HORA  aHora;
     |ABRE #0;
     |ABRE #1;
     |ABRE #16;
     |ABRE #17;
     |ABRE #12;
     |ABRE #13;

     nPrimeLin = 0;
     nLinAgr = 0;
     |BUCLE ib__tick;
     |SI nLinAgr ! 0;
          |HAZ Resto_tick;
     |FINSI;
     |SI nSwSimula = 0;
          |BUCLE ib__tickBorra;
     |FINSI;

     |SI nSwSimula = 0;
          |SI nDeudaPtas > 0; |O nDeudaEuros > 0;
               |HAZ CreaDeuda;
          |FINSI;
          |ABRE #dsm00051;
          |ABRE #agifa019;
          |BUCLE ib__ticd;
          |CIERRA #agifa019;
          |CIERRA #dsm00051;
     |FINSI;
     |SI aTipo = "A"; |HAZ CabAlba; |FINSI;
     |SI aTipo = "F"; |HAZ CabFactu; |FINSI;
     |SI aNoImprimir ! "S"; |Y aFormaPago ! "B"; |Y aEsGratis ! "S";
               |Y aHabitacion ! "S";
          |SI aTipo = "A";
               |HAZ ImpresionAlba;
          |FINSI;
          |SI aTipo = "F";
               |HAZ ImpresionFactu;
          |FINSI;
          |SI aTipo = "T";
               |HAZ ImpresionTicket;
          |FINSI;
     |SINO;
          |SI aFormaPago ! "B"; |Y aEsGratis ! "S"; |Y aHabitacion ! "S";
                    |Y nSwSimula = 0;
               eaLogCaj = "USUARIO";
               |HAZ LogCajon;
               |HAZ AbreCajon;
          |FINSI;
     |FINSI;
     |GRABA 040#0a;
     |CIERRA #0;
     |CIERRA #1;
     |CIERRA #16;
     |CIERRA #17;
     |CIERRA #12;
     |CIERRA #13;

     |SI aHabitacion = "S";
          |HAZ ActuaCliente;
          |HAZ CargoHabi;
     |SINO;
          |SI nSwSimula = 0; |Y aFormaPago ! "B"; |Y aEsGratis ! "S";
               |HAZ ActuaCliente;
               |SI #0#35 = "T"; |O #0#35 = "F"; |O #0#35 = "A";
                    |HAZ ActuaResumen;
                    |HAZ ActuaTarjeta;
               |FINSI;
               |HAZ cobro_display;
          |FINSI;
          |SI aEsGratis = "S";
               |HAZ ActuaResumen;
          |FINSI;
          |SI aFormaPago = "B";
               |HAZ ActuaResumen;
          |FINSI;
     |FINSI;
     ||컴컴컴컴컴컴컴컴컴 Se quedan cargadas en las Dll's
     aFormaPago = "E";
     aEsGratis = "N";
     aNoImprimir = "N";
|FPRC;

|DEFBUCLE LinRecupera;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     be;
     NULL, LinRecupera;
|FIN;

|PROCESO &RecuperaTicket;
     |SUB_EJECUTA_NP "dsfa0006"; || Parametros: aSesion y nElTicket

     nForma = -1;
     |ABRE #0;
     #0#0 = nElTicket;
     #0#36 = aSesion;
     |LEE 141#0=;
     |SI FSalida = 0; |Y afecha = #0#14;
          aOpeHis = "TI";
          |SI #0#35 = "A"; aOpeHis = "AV"; |FINSI;
          |SI #0#35 = "F"; aOpeHis = "FC"; |FINSI;

          nComensales = #0#55;
          nErrorRecupera = 0;
          |ABRE #ib__ticd;
          |ABRE #ib__tick;
          |||BUCLELIN 0LinRecupera#0;
          |BUCLE LinRecupera;
          |CIERRA #ib__tick;
          |CIERRA #ib__ticd;
          |SI #0#35 ! "B";
               |SI #agifa501#41 ! 0;   || Pend. Credito
                    |HAZ BorraCredi;
               |FINSI;
               |SI #0#59 ! 0;
                    |HAZ CargoHabi;
               |FINSI;
               |HAZ ActuaCliente;
               |SI #0#35 = "T"; |O #0#35 = "F"; |O #0#35 = "A";
                    |HAZ ActuaResumen;
                    |HAZ ActuaTarjeta;
               |FINSI;
               claveconta = "vtiquet";
               |SI #0#35 = "A";
                    claveconta = "valbaran";
                    |ABRE #16;
                    #16#52 = #0#57;
                    #16#0 = #0#58;
                    |LEE 141#16=;
                    |SI FSalida = 0;
                         |BUCLELIN 1 NULL #16;
                         |BORRA 040#16a;
                    |FINSI;
                    |CIERRA #16;
               |FINSI;
               |SI #0#35 = "F";
                    |SI #142#26 = "S";
                         claveconta = "vfactura";
                    |SINO;
                         claveconta = "vfactuco";
                    |FINSI;
                    |ABRE #12;
                    #12#48 = #0#57;
                    #12#0 = #0#58;
                    |LEE 141#12=;
                    |SI FSalida = 0;
                         |BUCLELIN 1 NULL #12;
                         |BORRA 040#12a;
                    |FINSI;
                    |CIERRA #12;
               |FINSI;
               |ABRE #51;         || Doc. Borrados
               #51#0 = claveconta;
               #51#1 = #0#57;
               #51#2 = #0#58;
               #51#3 = afecha;
               |GRABA 040#51n;
               |CIERRA #51;
          |FINSI;
          |BORRA 040#0a;
     |SINO;
          nErrorRecupera = 1;
     |FINSI;
     |CIERRA #0
|FPRC;

|PROCESO &ImprimeTicket;
     |PULSATECLA;
     |HAZ CreaTempo; aTempo0 = Tempo; |NOME_DAT #0 aTempo0; |DELINDEX #0;
     |HAZ CreaTempo; aTempo1 = Tempo; |NOME_DAT #1 aTempo1; |DELINDEX #1;
     |HAZ CreaTempo; aTempo12 = Tempo; |NOME_DAT #12 aTempo12; |DELINDEX #12;
     |HAZ CreaTempo; aTempo13 = Tempo; |NOME_DAT #13 aTempo13; |DELINDEX #13;
     |HAZ CreaTempo; aTempo16 = Tempo; |NOME_DAT #16 aTempo16; |DELINDEX #16;
     |HAZ CreaTempo; aTempo17 = Tempo; |NOME_DAT #17 aTempo17; |DELINDEX #17;
     nSwSimula = 1;
     |HAZ CalculaTicket;
     nSwSimula = 0;

     |DELINDEX #0; Tempo = aTempo0; |HAZ BoraTempo;
     |DELINDEX #1; Tempo = aTempo1; |HAZ BoraTempo;
     |DELINDEX #12; Tempo = aTempo12; |HAZ BoraTempo;
     |DELINDEX #13; Tempo = aTempo13; |HAZ BoraTempo;
     |DELINDEX #16; Tempo = aTempo16; |HAZ BoraTempo;
     |DELINDEX #17; Tempo = aTempo17; |HAZ BoraTempo;

     |NOME_DAT #0 "agifa501";
     |NOME_DAT #1 "agifa502";
     |NOME_DAT #12 "agifa084";
     |NOME_DAT #13 "agifa069";
     |NOME_DAT #16 "agifa010";
     |NOME_DAT #17 "agifa071";
|FPRC;

|PROCESO &DameCliente;
     |PULSATECLA;
     aAlfa = aCliente;
     |QBF aAlfa;
     |SI aAlfa = "";
          aCliente = #4#36;
     |FINSI;
||     nNume = aCliente;
||     aCliente = ("000000" + nNume) % -106;

     |DDEFECTO #14;
     |ABRE #14;
     #14#0 = aCliente;
     |LEE 000#14=;
     |CIERRA #14;
     aNomCliente = #14#1;
|FPRC;

|PROCESO &BorraElKit;
     |PULSATECLA;
     |ABRE #102;
     #102#0 = nElTicket;
     #102#4 = nLinTicket;
     #102#1 = 0;
     |LEE 141#102];
     |PARA; |SI FSalida = 0; |Y #102#0 = nElTicket; |Y #102#4 = nLinTicket; |HACIENDO;
          |BORRA 040#102a;
          |LEE 141#102s;
     |SIGUE;
     |CIERRA #102;
|FPRC;

|PROCESO &BorraTicket;
     |PULSATECLA;
     |ABRE #103;
     #103#0 = nElTicket;
     #103#1 = 0;
     |LEE 141#103];
     |PARA; |SI FSalida = 0; |Y #103#0 = nElTicket; |HACIENDO;
          |BORRA 040#103a;
          |LEE 141#103s;
     |SIGUE;
     |CIERRA #103;

     |ABRE #102;
     #102#0 = nElTicket;
     #102#4 = 0;
     #102#1 = 0;
     |LEE 141#102];
     |PARA; |SI FSalida = 0; |Y #102#0 = nElTicket; |HACIENDO;
          |BORRA 040#102a;
          |LEE 141#102s;
     |SIGUE;
     |CIERRA #102;
|FPRC;

|PROCESO &BorraTPAS;
     |PULSATECLA;
     |ABRE #106;
     |ABRE #104;
     #104#0 = nElTicket;
     #104#1 = 1;
     |LEE 141#104];
     |PARA; |SI FSalida = 0; |Y #104#0 = nElTicket; |HACIENDO;
          #106#0 = #104#0;
          #106#4 = #104#1;
          #106#1 = 1;
          |LEE 141#106];
          |PARA; |SI FSalida = 0; |Y #106#0 = #104#0; |Y #106#4 = #104#1;|HACIENDO;
               |BORRA 040#106a;
               |LEE 101#106s;
          |SIGUE;
          |BORRA 040#104a;
          |LEE 101#104s;
     |SIGUE;
     |CIERRA #106;
     |CIERRA #104;
|FPRC;


|PROCESO NotaReceta;
     |PRINT;
|FPRC;

|DEFBUCLE NotaReceta;
     #918#1;
     ;
     aReceta, "IB", 1;
     aReceta, "IB", 999;
     ;
     NULL, NotaReceta;
|FIN;

|PROCESO &ImprimeReceta;
     |PULSATECLA;
     aAlfa = #41#11; |QBF aAlfa;
     |SI aAlfa = ""; |ACABA; |FINSI;

     |ABRE #76;
     |SELECT #2#76;
     #2#76 = aArticulo;
     |LEE 000#76=;
     |SI FSalida = 0;
          aReceta = ("000000" + #76#0) % -106;
          Impresora = #41#11; |QBF Impresora;
          |IMPRE -1;
          |SI FSalida = 0;
               aInforme = #41#12; |QBF aInforme;
               |INFOR aInforme;
               |SI FSalida = 0;
                    |BUCLE NotaReceta;
                    |PIEINF;
                    |FININF;
               |FINSI;
               |FINIMP;
          |FINSI;
     |FINSI;
     |CIERRA #76;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO HallaMesa;
     |ABRE #103;
     #103#0 = nElTicket;
     #103#1 = 1;
     |LEE 000#103];
     |SI FSalida = 0; |Y #103#0 = nElTicket;
          enMesa = #103#6;
     |SINO;
          enMesa = 0;
     |SINO;
     |FINSI;
     |CIERRA #103;
|FPRC;

|PROCESO FinSeccion;
     |SI aSecAnt ! "";
          aSecAnt = "";
          |PIEINF;
          |FININF;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO Secciones;
     #169#0 = nCentro;
     #169#1 = #103#14;
     |LEE 000#169=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |SI #169#3 = "N"; |ACABA; |FINSI;

     aAlfa = #169#4; |QBF aAlfa;
     |SI aAlfa = ""; |ACABA; |FINSI;

     |SI aSecAnt ! #103#14;
          |HAZ FinSeccion;
          Impresora = #169#4; |QBF Impresora;
          |IMPRE -1;
          |SI FSalida ! 0; |ACABA; |FINSI;
          |INFOR aInforme;
          |SI FSalida ! 0;
               |FINIMP;
               |ACABA;
          |FINSI;
          aSecAnt = #103#14;
     |FINSI;
     |PRINT;
|FPRC;

|DEFBUCLE Secciones;
     #103#1;
     13, 14;
     nElTicket, 001, aDImpre, aDSeccion;
     nElTicket, 999, aHImpre, aHSeccion;
     ;
     NULL, NULL, NULL, NULL, NULL, Secciones;
     #103#14, #103#1;
|FIN;

|PROCESO NotasSecciones;
     |PULSATECLA;
     aSecAnt = "";
     aInforme = #41#15; |QBF aInforme;
     |ABRE #169;
     |BUCLE Secciones;
     |HAZ FinSeccion;
     |CIERRA #169;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO ImpreSala;
     nSwPieInf = 1;
     |PRINT;
|FPRC;

|DEFBUCLE ImpreSala;
     #103#1;
     ;
     nElTicket, 001;
     nElTicket, 999;
     ;
     NULL, ImpreSala;
|FIN;

|PROCESO NotasSala;
     Impresora = #41#17; |QBF Impresora;
     |SI Impresora = ""; |ACABA; |FINSI;

     |IMPRE -1;
     |SI FSalida = 0;
          aInforme = #41#18; |QBF aInforme;
          |INFOR aInforme;
          |SI FSalida = 0;
               nSwPieInf = 0;
               |BUCLE ImpreSala;
               |SI nSwPieInf ! 0;
                    |PIEINF;
               |FINSI;
               |FININF;
          |FINSI;
          |FINIMP;
     |FINSI;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO Cocina;
     nSwPieInf = 1;
     |PRINT;
|FPRC;

|DEFBUCLE Cocina;
     #103#1;
     11;
     nElTicket, 001, aDPlato2;
     nElTicket, 999, aHPlato2;
     ;
     NULL, Cocina;
|FIN;

|DEFBUCLE BAnulaCocina;
     #103#1;
     13;
     nElTicket, 001, "X";
     nElTicket, 999, "X";
     ;
     NULL, Cocina;
|FIN;

|PROCESO AnulaNotasCocina;
     Impresora = #41#13; |QBF Impresora;
     |SI Impresora = ""; |ACABA; |FINSI;
     |IMPRE -1;
     |SI FSalida = 0;
          aInforme = #41#14; |QBF aInforme;
          |INFOR aInforme;
          |SI FSalida = 0;
               nSwPieInf = 0;
               aDPlato2 = "1";
               aHPlato2 = "z";
               |BUCLE BAnulaCocina;
               |SI nSwPieInf ! 0;
                    |PIEINF;
               |FINSI;
               |FININF;
          |FINSI;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO CompruebaCocina;
     nSwCocina = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE CompruebaCocina;
     #103#1;
     11, 13;
     nElTicket, 001, aDPlato1, "N";
     nElTicket, 999, aHPlato1, "N";
     ;
     NULL, CompruebaCocina;
|FIN;

|PROCESO NotasCocina;
     Impresora = #41#13; |QBF Impresora;
     |SI Impresora = ""; |ACABA; |FINSI;

     |SI aTipoTactil = "T";
          aDPlato1 = " ";
          aHPlato1 = "z";
          aDPlato2 = " ";
          aHPlato2 = "z";
     |SINO;
          aDPlato1 = #116#19;
          aHPlato1 = #116#20;
          aDPlato2 = #116#17;
          aHPlato2 = #116#18;
     |FINSI;

     nSwCocina = 0;
     |BUCLE CompruebaCocina;
     |SI nSwCocina = 0; |ACABA; |FINSI;

     |IMPRE -1;
     |SI FSalida = 0;
          aInforme = #41#14; |QBF aInforme;
          |INFOR aInforme;
          |SI FSalida = 0;
               nSwPieInf = 0;
               |BUCLE Cocina;
               |SI nSwPieInf ! 0;
                    |PIEINF;
               |FINSI;
               |FININF;
          |FINSI;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO &SeccionCocina;  ||  aSeccion ->  SI vacia Todas, sino la que traiga
     |PULSATECLA;
     |HAZ HallaMesa;
     aDImpre = "N";
     aHImpre = "N";
     aAlfa = aSeccion; |QBF aAlfa;
     |SI aAlfa = "";
          aDSeccion = "    ";
          aHSeccion = "zzzz";
     |SINO;
          aDSeccion = aSeccion;
          aHSeccion = aSeccion;
     |FINSI;
     |HAZ NotasSecciones;
|FPRC;

|PROCESO &ReSeCocina;  ||  aSeccion ->  SI vacia Todas, sino la que traiga
     |PULSATECLA;
     |HAZ HallaMesa;
     enReEmi = 1;
     aDImpre = "N";
     aHImpre = "N";
     aAlfa = aSeccion; |QBF aAlfa;
     |SI aAlfa = "";
          aDSeccion = "    ";
          aHSeccion = "zzzz";
     |SINO;
          aDSeccion = aSeccion;
          aHSeccion = aSeccion;
     |FINSI;
     |HAZ NotasSecciones;
     enReEmi = 0;
|FPRC;

|| Variables que envia la dll (para el informe)
|| aMesa, aSala, aTexto
|PROCESO &ImprimeCocina;
     |PULSATECLA;
     Impresora = #41#13; |QBF Impresora;
     |IMPRE -1;
     |SI FSalida = 0;
          aInforme = #41#21; |QBF aInforme;
          |INFOR aInforme;
          |SI FSalida = 0;
               |PRINT;
               |PIEINF;
               |FININF;
          |FINSI;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO &anulaCocina;
     |PULSATECLA;
     |HAZ HallaMesa;
     enANULA = 1;        || PARA EL INFORME
     aDImpre = "X";
     aHImpre = "X";
     aDSeccion = "    ";
     aHSeccion = "zzzz";
     |HAZ NotasSecciones;
     |HAZ AnulaNotasCocina;
     enANULA = 0;
|FPRC;

|PROCESO PonPlatoTro;
     #100#1 = #103#2;
     |LEE 000#100=;

     nPlato = #100#5;

     #103#5 = nPlato;       || Le pongo el plato
     |GRABA 020#103a;
     |LIBERA #103;
|FPRC;

|DEFBUCLE PonPlatoTro;
     #103#1;
     ;
     nElTicket, 001;
     nElTicket, 999;
     be;
     NULL, PonPlatoTro;
|FIN;

|PROCESO &TicketCocina;
     |HAZ HallaMesa;
     |PULSATECLA;
     |SI aTipoTactil = "T"; || Bar/Troje
          |ABRE #100;
          |SELECT #2#100;
          |BUCLE PonPlatoTro;
          |CIERRA #100;
     |FINSI;
     |HAZ NotasCocina;
     |HAZ NotasSala;
|FPRC;

|PROCESO &ReITicket;
     |PULSATECLA;
     enReEmi = 1;
     |HAZ NotasCocina;
     enReEmi = 0;
|FPRC;

/*                 VARIABLES PROCESO EVENTO
     &aSala = ""
     &aMesa = ""
     &aElEvento = ""

     ** las siguientes dependen del evento
     &nComensales = 0;
     aArticulo
     nElTicket
     nElTicketLin

     Tipos de evento:
     "S" selecciona la mesa (es la que tiene corriente en pantalla)
     "O" ocupar mesa
     "R" reservar (te indico que he puesto una R en la mesa) (en todos los de reservar el   nElTicket es el numero de reserva)
     "T" tomar nota (si aArticulo ! "" ha seleccionado el articulo, si nElTicketLin ! 0 ha seleccionado (o incluido) la linea del tickect)
     "M" modificar nota ( igual "T")
     "C" Cobrar (abre la pantala cobro)
     "N" Cancela cobro
     "L" limpia mesa
     "A" anula mesa (si estaba "R" la reserva vuelve al estado pendiente)
     "X" cancelar accion (en el caso de cobro se envia "N" y "X" dos eventos)

     "B" Borrado de reserva: (nElTicket es el numero de reserva) este evento corresponde a ocupar una mesa reservada ... primero "O" y si validan despues "B"
*/
|PROCESO &Evento;
     |PULSATECLA;
     nLinTicket = nElTicketLin;
     |SI aElEvento = "T";          || Tomar Nota
          |SI aArticulo = ""; |O nLinTicket ! 0;
               |SI nLinTicket ! 0;
                    |HAZ lin_display;
               |FINSI;
          |SINO;
               |HAZ ini_display;
          |FINSI;
     |FINSI;
     |SI aElEvento = "C";          || Cobrar
          impo_dis = nTotalPtas;
          |HAZ total_display;
     |FINSI;
     |SI aElEvento = "B";          || Borrado Reserva
          |ABRE #ib__rese;
          #ib__rese#0 = nElTicket;
          |BORRA 040#ib__rese.c;
          |CIERRA #ib__rese;

          |ABRE #79; |SELECT #2#79;
          #79#14 = nElTicket;
          |LEE 141#79=;
          |SI FSalida = 0;
               #79#13 = "E";
               |GRABA 020#79a;
          |FINSI;
          |CIERRA #79;
     |FINSI;
|FPRC;

|PROCESO &Hora;     ||Para llamarlo de los informes
     |HORA enHora;
|FPRC;

|PROCESO &AbrirCajon;
     eaLogCaj = "USUARIO";
     |HAZ LogCajon;
     |HAZ AbreCajon;
|FPRC;

|PROCESO &BloqueoDll;
     #ibxxbloq#0 = nPuntoBloqueo;
     |LEE 141#ibxxbloq.=;
     |SI FSalida = 111;
          |GRABA 040#ibxxbloq.b;
     |FINSI;
     |SI FSalida ! 0;
          nPuntoBloqueo = -1;
     |FINSI;
|FPRC;

|PROCESO &LiberaDll;
   |LIBERA #ibxxbloq;
|FPRC;

|PROCESO GrabaUltConta;
     nGuarda = nContadorTicket;
     |ABRE #5;
     #5#2 = aSesion;
     #5#0 = "vtiquet";
     |LEE 101#5=;
     |SI FSalida = 0;
          nContadorTicket = #5#1;
     |SINO;
          |GRABA 020#5b;
          nContadorTicket = 1;
     |FINSI;
     |SI nGuarda > nContadorTicket;
          nContadorTicket = nGuarda;
          #5#1 = nContadorTicket;
          |GRABA 020#5a;
     |FINSI;
     |CIERRA #5;
|FPRC;

|PROCESO &ContadorTicket;
||||     |SI enHayCentralCob = 0; |ACABA; |FINSI;
     |ABRE #5;
     #5#2 = aSesion;
     #5#0 = "vtiquet";
     |LEE 101#5=;
     |SI FSalida = 0;
          nContadorTicket = #5#1 + 1;
     |SINO;
          |GRABA 020#5b;
          nContadorTicket = 1;
     |FINSI;
     #5#1 = nContadorTicket;
     |GRABA 020#5a;
     |CIERRA #5;
|FPRC;

|PROCESO &MiraReservas;
     |HAZ CargaReserva;
|FPRC;

||컴컴컴컴컴훜lamadas de iber0200컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO Especifica;
     aAlfa1 = "0000Cargando [" + dll + "]";
     |MENSA aAlfa1;

     Ipvisual = dll<-;   || se carga en IniciaTactil

     |ESPECIFICA "INTERFACE_VISUAL",pvisual;
     |SI FSalida ! 0;
          aAlfa1 = "0000FSalida [" + FSalida + "]";
          |MENAV aAlfa1;
     |FINSI;
|FPRC;

|PROCESO IniciaTactil;
     dll = eaNomDll;

     nCentro = eaCentro;
||   aSesion = eaCentro + (("00" + nPuntoDeVenta) %  -102);

     |ABRE #agifa505;
     #agifa505#0 = acaja;
     |LEE 000#agifa505.=;
     |CIERRA #agifa505;

     enTiva = #agifa505#128;
     efFiva = afecha;
     |HAZ SacaIVA;

     aSesion = #agifa505#112;

     aIVAinc = #agifa505#109;  || Para Todos
     aIVAinc =  eaIvaIber;     ||Para iber
     nIVAporV= enIva;

     |ABRE #agifa517;
     |LEE 000#agifa517.p;
     |CIERRA #agifa517;

     |ABRE #agifa142;
     |LEE 000#agifa142.p;
     |CIERRA #agifa142;

     |ABRE #iber0016;
     #iber0016#0 = nCentro;
     |LEE 000#iber0016.=
     |CIERRA #iber0016;

     |ABRE #117;
     #117#0 = nCentro;
     |LEE 000#117=;
     |CIERRA #117;

     |ABRE #41;
     #41#0 = nCentro;
     #41#1 = nPuntoDeVenta;
     |LEE 000#41=;
     |CIERRA #41;

     |ABRE #0;
     #0#36 = aSesion; aSesion = #0#36;  || Formatea
     #0#0 = 999999;
     |LEE 000#0];
     |SI FSalida = 0;
          |LEE 000#0a;
     |SINO;
          |LEE 000#0u;
     |FINSI;
     |SI FSalida = 0; |Y #0#36 = aSesion;
          nContadorTicket = #0#0 + 1;
     |SINO;
          nContadorTicket = 1;
     |FINSI;
     |CIERRA #0;
     |HAZ GrabaUltConta;

     |HAZ DameCliente;

     aAlfa = #4#100; |QBF aAlfa;
     |SI aAlfa ! "";
          aEsHotel = "S";
          ficHotel = "H" + Usuario; |QBF ficHotel;
          |HAZ PathHotel;
          |HAZ CargaHabi;
     |FINSI;
|FPRC;

|PROCESO PathHotel;
     alfa = #4#100; |QBF alfa;
     emp = alfa % -202;
     alf1 = alfa % -109;
     alfa = alfa - alf1;
     alf1 = "";
     apli = "";
     |PARA i = -101; |SI i ] -10000; |HACIENDO i = i - 100;
          alf1 = alfa % i;
          |SI alf1 = "\"; |O alf1 = "/"; |SAL; |FINSI;
          apli = alf1 + apli;
     |SIGUE;
|FPRC;

|PROCESO CargaHabi;
     |SI #4#101 = 0; |ACABA; |FINSI;
     |HORA alfa;
     alf1 = alfa % 102;
     beta = alf1 * 60;
     alf1 = alfa % 402;
     beta = beta + alf1;

     bet0 = beta - minu_ant;
     |SI minu_ant = 0; |O bet0 < 0; |O bet0 ] #4#101;
          |PUSHV 0501 2380;
          |COLOR 0, 0; |ATRI 0;
          |BLANCO 1128 1560;
          |COLOR 14, 0; |ATRI 0;
          |CUADRO 1128 1560;
          |COLOR 14, 0; |ATRI P;
          |PINTA 1332, "ACTUALIZANDO HABITACIONES";
          |ATRI 0;
          |DFICE path; |QBF path;
          minu_ant = beta;
          alfa = ":" + apli + "/tabusagr taempre " + emp;
          alfa = alfa + &59 + path + ficHotel;
          |SUB_EJECUTA_NP alfa;
          |POPV;
     |FINSI;
|FPRC;

|PROCESO Habitacion;
     |DFICE path; |QBF path;
     alfa = ":" + apli + "/tabusagr taempre " + emp;
     alfa = alfa + &59 + path + ficHotel;
     |SUB_EJECUTA_NP alfa;

     |NOME_DAT #900 ficHotel;
     |PATH_DAT #900 path;

     |ABRE #900;
     |SELECT #3#900;
     |DDEFECTO #900;
     #900#2 = nNumRoom;
     |LEE 000#900];
     |SI FSalida = 0; |Y #900#2 = nNumRoom;
          xhabita = #900#2;
          xhotel = #900#9;
          xnombre = #900#1;
          xhuespe = #900#0;
     |SINO;
          xhabita = 0;
          xhotel = 0;
     |FINSI;

     |CIERRA #900;
     |DELINDEX #900;
|FPRC;

/*                DE MOMENTO ESTO NO VALE
|PROCESO Habitacion;
     |PUSHV 0501 2380;

     IvPopup = vPopup1<-;
     vPopup1 = "1024";
     vPopup2 = "1969";
     vPopup3 = "0001";
     vPopup4 = "PEDIR";
     |ESPECIFICA "POPUPMODE",vPopup;

     |SI #4#101 = 0;
          alfa  = ":" + apli + "/tabusagr taempre " + emp;
     |SINO;
          alfa = "tabusagr" + &59 + ficHotel;
     |FINSI;
     |SUB_EJECUTA_NP alfa;

     IvPopup = vPopup1<-;
     |ESPECIFICA "FIN_POPUPMODE",vPopup;

     |POPV;
|FPRC;
*/
