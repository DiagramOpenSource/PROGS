|FICHEROS;
     albw0043 #0,MANTE;  ||Aux. Validar Mezclad

     albm0031 #100;      ||Introd.Mezcladas CAB
     albm0032 #132;      ||Introd.Mezcladas LIN
     albm0029 #129;      ||Formulas Cabs.

     albz0026 #600;      ||Este Def
     albm0061 #61;       ||Mezclad.PorConfirmar
     albw0040 #40;       ||Rel. PreMezcla/Orden
     albm0060 #60;       ||Rel. Orden/Mezclada
     albm0030 #30;       ||Formulas Lins.

     agifa029 #29;       ||Datos Almacenes
|FIN;

|VARIABLES;
     nVentana = 0;

     &enMezcladaOk = 0;
     &enNuevaMez = 0;

     nCalc = 0;
     aPartida = "";
     aMezclada = "";
     nSalida = 0;
     &eaDescrip = "";
     &efFecha = @;
     &eaFormula = "";
     &eaDesFor = "";
     &enLinea = 0;
     &eaDesLin = "";
     &enCuarto = 0;
     &eaDesCua = "";
     &enTrabaj = 0;
     &eaDesTra = "";
     &enAlmacen = 0;
     &eaDesAlm = "";
     &enKgRea = 0;

     &enClave61 = 0;

     aMensaje = "";
     nDocum = 0;
|FIN;

|PROCESO albw0040;
     |DDEFECTO #albm0060;
     #albm0060#2 = #albw0040#2;         ||Serie Orden
     #albm0060#0 = #albw0040#1;         ||Orden
     #albm0060#3 = "";                  ||Serie Mezclada (VACIO)
     #albm0060#1 = #albm0031#0;         ||Numero Mezclada
     |LEE 101#albm0060.=;
     |SI FSalida ! 0;
          |GRABA 020#albm0060.n;
     |FINSI;
     |LIBERA #albm0060;
     |BORRA 020#albw0040.a;
|FPRC;

|DEFBUCLE albw0040;
 #albw0040#1;
 ;
 enClave61, "     ", 000000;
 enClave61, "zzzzz", 999999;
 be;
 NULL, albw0040;
|FIN;

|PROCESO albm0030;
     |DDEFECTO #albm0032;
     #albm0032#0 = #albm0031#0;
     #albm0032#1 = #albm0030#1;
     |LEE 101#albm0032.=;
     |SI FSalida ! 0; |GRABA 020#albm0032.b; |FINSI;

     #albm0032#2 = #albm0030#2;
     #albm0032#3 = #albm0030#3;
     #albm0032#4 = #albm0031#11;  ||Se supone que sera Almacen 1.
     |DDEFECTO #agifa029;
     #agifa029#0 = #albm0032#4;
     |LEE 000#agifa029.=;
     #albm0032#5 = #agifa029#1;    ||Descripcion Almacen

     |DDEFECTO #albm0029;
     #albm0029#0 = #albm0030#0;
     |LEE 000#albm0029.=;

     nCalc = ((#albm0030#4 * #albm0031#13) / #albm0029#2) ! 2;
     #albm0032#7 = nCalc;

     |GRABA 020#albm0032.a;
     |LIBERA #albm0032;
|FPRC;

|DEFBUCLE albm0030;
 #albm0030#1;
 ;
 #albm0031#3, 01;
 #albm0031#3, 99;
 ;
 NULL, albm0030;
|FIN;

|PROCESO albm0032_borra;
     |BORRA 020#albm0032.a;
|FPRC;

|DEFBUCLE albm0032_borra;
 #albm0032#1;
 ;
 #albm0031#0, 01;
 #albm0031#0, 99;
 be;
 NULL, albm0032_borra;
|FIN;


|PROGRAMA;
     |VENTANA 0501, 1299, -1, -1, "";
     nVentana = FSalida;

     |ABRE #agifa029;
     |ABRE #albm0029;
     |ABRE #albm0060;

     ||Primero averiguo el numero de Mezclada
     ||Luego relleno los campos que me interesa
     ||Y ya se termina de rellenar.

     |ABRE #albm0031;
     |HAZ NumeroMezclada;

     |ABRE #albw0043;
     |LEE 000#albw0043.p;
     |DDEFECTO #albw0043;
     #albw0043#5 = nDocum;
     |PINPA #0#albw0043;
     |PINDA #0#albw0043;
     aMezclada = ("000000" + nDocum) % -106;
     |PINTA 0632, eaDescrip;
     |ENDATOS #1#albw0043;
     |SI FSalida = 0; |O FSalida = 1;
          |DDEFECTO #albm0031;
          #albm0031#0 = #albw0043#5;
          |LEE 101#albm0031.=;
          nSalida = FSalida;

          |SI nSalida = 0;
               aMensaje = "0000No existe la mezclada: " + #albw0043#5;
               |QBF aMensaje;
               |MENAV aMensaje;
               |LIBERA #albm0031;
               |CIERRA #albm0031;
               |CIERRA #albm0060;
               |CIERRA #albm0029;
               |CIERRA #agifa029;
               |ACABA;
          |FINSI;

          #albm0031#1 = eaDescrip;
          #albm0031#2 = efFecha;
          #albm0031#3 = eaFormula;
          #albm0031#4 = eaDesFor;
          #albm0031#5 = enLinea;
          #albm0031#6 = eaDesLin;
          #albm0031#7 = #albw0043#1;
          #albm0031#8 = #albw0043#2;
          #albm0031#9 = #albw0043#3;
          #albm0031#10 = #albw0043#4;
          #albm0031#11 = enAlmacen;
          #albm0031#12 = eaDesAlm ;
          #albm0031#13 = enKgRea;

          #albm0031#16 = "N";
          #albm0031#19 = "N";
          aPartida = "M" + #albm0031#0;
          #albm0031#20 = aPartida;

          |GRABA 020#albm0031.n;
          |BUCLE albw0040;

          ||TODO CCC.
          ||Falta crear las lineas de la mezclada.  albm0032.
          ||a partir de la formula y de los kilos. (albm0030)
          |BUCLE albm0032_borra;
          |ABRE #albm0032;
          |BUCLE albm0030;
          |CIERRA #albm0032;

     ||TODO CCC
          ||Borrar la linea del albm0061.
          |ABRE #albm0061;
          #albm0061#24 = enClave61;
          |LEE 101#albm0061.=;
          |SI FSalida = 0;
               |BORRA 020#albm0061.a;
               |LIBERA #albm0061;
          |FINSI;
          |CIERRA #albm0061;

          enMezcladaOk = 1;
          enNuevaMez = #albm0031#0;
     |FINSI;
     |CIERRA #albw0043;

     |LIBERA #albm0031;

     |CIERRA #albm0031;
     |CIERRA #albm0060;
     |CIERRA #albm0029;
     |CIERRA #agifa029;

     |FINVENTANA nVentana;
|FPRO;

|PROCESO NumeroMezclada;
     |LEE 000#albm0031.u;
     nDocum = #albm0031#0 + 1;
|FPRC;

|PROCESO Tipo80; |TIPO 80;
     FSalida = 2899;
|FPRC;

|PROCESO Tipo12; |TIPO 12;

|FPRC;

|PROCESO CtrlMezclada; |TIPO 0;
     #albm0031#0 = #albw0043#5;
     |LEE 000#albm0031.=;
     |SI FSalida = 0;
          aMensaje = "0000Error. Esta Mezclada YA existe";
          |MENAV aMensaje;
          |ERROR;
     |FINSI;
|FPRC;
