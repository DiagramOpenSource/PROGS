|FICHEROS;
     ortsz015 #0;
     ortsm007 #7;
     agifa010 #10;
     ortsm015 #15;
     ortsm016 #16;
     ortsm017 #17;
     ortsm018 #18;
     ortsm019 #19;
     ortsm020 #20;
     ortsm029 #29;
     ortsm030 #30;
     ortsm031 #31;
     ortsm034 #34;
     ortsm035 #35;
     ortsm036 #36;
     agifa048 #480;
     agifa049 #49;
     agifa065 #65;
     agifa017 #117;
     agifa019 #119;
     ortsm035@;
|FIN;

|VARIABLES;
     nCoste = 0;
     &Tempo = "";
     aAlfa = "";
     aTmp35 = "";
     aCombi = "";
     nForma = 0;
     nNume = 0;
     nUnidades = 0;
     aArt = "";
     aDes = "";
     nUni = 0;
     aArt1 = "";
     aDes1 = "";
     nUni1 = 0;
     aArt2 = "";
     aDes2 = "";
     nUni2 = 0;
     aTira = "";
|FIN;

|CAMPOS;
     #119#15  art_pser;  #117#42  alm_pser;
     #119#182 art_pser2; #117#44  alm_pser2;
     #119#16  art_prec;  #117#43  alm_prec;
     #119#183 art_prec2; #117#45  alm_prec2;
     #119#17  art_pval;  #117#4   alm_pval;
     #119#11  art_nece;  #117#50  alm_nece;
     #119#12  art_rese;  #117#8   alm_rese;
     #119#14  art_depo;  #117#10  alm_depo;
     #119#184 art_depo2; #117#46  alm_depo2;
     #119#13  art_fabr;  #117#9   alm_fabr;
     #119#10  art_vsto;  #117#3   alm_vsto;
     #119#7   art_mini;  #117#6   alm_mini;
     #119#8   art_maxi;  #117#7   alm_maxi;
     #119#6   art_tota;  #117#5   alm_tota;
     #119#185 art_tota2; #117#47  alm_tota2;
     #119#104 art_disp;  #117#39  alm_disp;
     #119#193 art_disp2; #117#48 alm_disp2;
     #119#9   art_pcm;   #117#69 alm_pcm;
|FIN;

|PROCESO SumaCoste;
     #16#62 = #16#62 + #31#7;
|FPRC;

|DEFBUCLE SumaCoste;
     #31#1;
     ;
     #16#28, #16#0, #16#1, "                    ";
     #16#28, #16#0, #16#1, "zzzzzzzzzzzzzzzzzzzz";
     ;
     NULL, SumaCoste;
|FIN;

|PROCESO Acumula;
     |DDEFECTO  #119;
     #119#0 = #31#3;
     |LEE 101#119=;
     |SI FSalida ! 0; |GRABA 020#119b; |FINSI;

     |DDEFECTO #117;
     #117#0 = #31#3;
     #117#1 = #16#3;
     |LEE 101#117=;
     |SI FSalida ! 0; |GRABA 020#117b; |FINSI;

     nUnidades = #31#5 * nForma;

     art_disp = art_disp - nUnidades;
     art_tota = art_tota - nUnidades;
     alm_disp = alm_disp - nUnidades;
     alm_tota = alm_tota - nUnidades;
     |HAZ ValoraStock;

     aAlfa = #15#1 % 402;
     nNume = aAlfa;
     nNume = ((nNume - 1) * 5) + 34;

     #119nNume = #119nNume + nUnidades;
     #119#94   = #119#94   + nUnidades;
     nNume    = aAlfa;
     nNume    = ((nNume - 1) * 2) + 11;
     #117nNume = #17nNume + nUnidades;
     #117#35   = #117#35   + nUnidades;

     |GRABA 020#119a;
     |GRABA 020#117a;
     |LIBERA #119;
     |LIBERA #117;

     |DDEFECTO #65;
     #65#0 = #31#3;
     #65#1 = #15#1;
     #65#2 = "CM";
     #65#3 = #16#0;
     #65#4 = #16#1;
     #65#11 = #16#28;
     |LEE 101#65=;
     |SI nForma = 1;
          |SI FSalida ! 0; |GRABA 020#65b; |FINSI;
          #65#5 = #16#3;
          #65#6 = -#31#5;
          #65#7 = #119#6;
          #65#8 = #119#9;
          #65#9 = 0;
          #65#10 = #15#4;
          |GRABA 020#65a;
     |SINO;
          |SI FSalida = 0; |BORRA 020#65a; |FINSI;
     |FINSI;
     |LIBERA #65;
|FPRC;

|DEFBUCLE Acumula;
     #31#1;
     ;
     #16#28, #16#0, #16#1, "                    ";
     #16#28, #16#0, #16#1, "zzzzzzzzzzzzzzzzzzzz";
     be;
     NULL, Acumula;
|FIN;

|PROCESO GraConsumo;
     aAlfa = aArt;
     |QBF aAlfa;
     |SI aAlfa = ""; |ACABA; |FINSI;

|SI aAlfa = "COLATERM2";
     aAlfa = "0000" + #17#4 + " COLATERM2: " + nUni;
     ||MENAV aAlfa;
|FINSI;
|SI aAlfa = "TABL190BL";
     aAlfa = "0000" + #17#4 + " TABL190BL: " + nUni;
     ||MENAV aAlfa;
|FINSI;
aAlfa = aAlfa % 103;
|SI aAlfa = "TIR";
     aAlfa = "0000" + #17#4 + " TIR: " + nUni;
     ||MENAV aAlfa;
|FINSI;

     #119#0 = aArt;
     |LEE 000#119=;
     |SI FSalida ! 0; |DDEFECTO #119; |FINSI;

     |DDEFECTO #31;
     #31#0 = #16#28;
     #31#1 = #16#0;
     #31#2 = #16#1;
     #31#3 = aArt;
     |LEE 101#31=;
     |SI FSalida ! 0; |GRABA 020#31b; |FINSI;
     #31#4 = aDes;
     #31#5 = #31#5 + nUni
     #31#6 = #119#9;
     #31#7 = #31#5 * #31#6;
     |GRABA 020#31a;
     |LIBERA #31;

     #17#25 = #17#25 + (#119#9 * nUni);
|FPRC;

|PROCESO CombiUni1;
     #34#0 = #49#2;
     #34#1 = #18#5;
     |LEE 000#34=;
     |SI FSalida = 0;
          #119#0 = #34#3;
          |LEE 000#119=;
          |SI #119#2 = #36#16;     ||Familia canteado
                nUni = #49#12 * #16#5;
          |SINO;
               nUni = (#17#16 / #36#8 * #36#9) * (#17#17 / #36#8 * #36#9 * #16#5);
          |FINSI;
          aArt = #34#3;
          aDes = #34#4;
          |HAZ GraConsumo;
     |SINO;
          aArt = #49#2;
          aDes = #17#5;
          nUni = #49#12 * #16#5;
          |HAZ GraConsumo;
     |FINSI;
|FPRC;

|DEFBUCLE CombiUni1;
     #18#1;
     ;
     #17#0, #17#1, #17#2, #17#3, 001;
     #17#0, #17#1, #17#2, #17#3, 999;
     ;
     NULL, CombiUni1;
|FIN;

|PROCESO CombiUniTirador;
     aTira = #18#6; |QBF aTira;
     |SI aTira ! "";
          #7#0 = #18#6;
          |LEE 000#7=;
          |SI FSalida = 0;
               aArt = #7#2;
               aDes = #7#3;
               nUni = #16#5;
               |HAZ GraConsumo;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE CombiUniTirador;
     #18#1;
     ;
     #17#0, #17#1, #17#2, #17#3, 001;
     #17#0, #17#1, #17#2, #17#3, 999;
     ;
     NULL, CombiUniTirador;
|FIN;

|PROCESO LinEscandallo;
     |SI #17#8 = "S"; |Y #17#7 > 1;    || Desglose unidades
          |BUCLE CombiUni1;
     |SINO;
          #34#0 = #49#2;
          #34#1 = #17#6;
          |LEE 000#34=;
          |SI FSalida = 0;
               #119#0 = #34#3;
               |LEE 000#119=;
               |SI #119#2 = #36#16;     ||Familia canteado
                     nUni = #49#12 * #17#7 * #16#5;
               |SINO;
                    nUni = (#17#16 / #36#8 * #36#9) * (#17#17 / #36#8 * #36#9);
                    nUni = nUni * #17#7 * #16#5; || Por Unidades Combinable * Por Unidades Venta Pedido
               |FINSI;
               aArt = #34#3;
               aDes = #34#4;
               |HAZ GraConsumo;
          |SINO;
               aArt = #49#2;
               aDes = #17#5;
               nUni = #49#12 * #17#7 * #16#5;
               |HAZ GraConsumo;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE LinEscandallo;
     #49#1;
     10;
     #17#4, 001, 1;
     #17#4, 999, 1;
     ;
     NULL, LinEscandallo;
|FIN;

|PROCESO CombiUniCanteado1;
     #34#0 = #30#12;
     #34#1 = #18#5;
     |LEE 000#34=;
     |SI FSalida = 0;
          aArt = #34#3;
          aDes = #34#4;
          nUni = (#30#9 / #36#8 * #36#9) * (#30#10 / #36#8 * #36#9) * #16#5;
          |HAZ GraConsumo;
     |FINSI;
|FPRC;

|DEFBUCLE CombiUniCanteado1;
     #18#1;
     ;
     #17#0, #17#1, #17#2, #17#3, 001;
     #17#0, #17#1, #17#2, #17#3, 999;
     ;
     NULL, CombiUniCanteado1;
|FIN;

|PROCESO CompoCanteado1;
     #34#0 = #30#12;
     #34#1 = #17#6;
     |LEE 000#34=;
     |SI FSalida = 0;
          |SI #17#8 = "S"; |Y #17#7 > 1;    || Desglose unidades
               |BUCLE CombiUniCanteado1;
          |SINO;
               aArt = #34#3;
               aDes = #34#4;
               nUni = (#30#9 / #36#8 * #36#9) * (#30#10 / #36#8 * #36#9) * #17#7 * #16#5;
               |HAZ GraConsumo;
          |FINSI;
     |SINO;
          aArt = #30#12;
          aDes = #30#8;
          nUni = (#30#9 / #36#8 * #36#9) * (#30#10 / #36#8 * #36#9) * #17#7 * #16#5;
          |HAZ GraConsumo;
     |FINSI;
|FPRC;

|DEFBUCLE CompoCanteado1;
     #30#1;
     ;
     #17#0, #17#1, #17#2, #17#3, 0, " ", 00;
     #17#0, #17#1, #17#2, #17#3, 9, "z", 99;
     ;
     NULL, CompoCanteado1;
|FIN;

|PROCESO CompoHerrajes1;
     #119#0 = #29#4;
     |LEE 000#119=;
     |SI FSalida ! 0; |DDEFECTO #119; |FINSI;

     |SI #119#2 = #36#15; |ACABA; |FINSI;

     aArt = #29#4;
     aDes = #29#5;
     |SI #29#7 = 0;
          nUni = #29#6 / #17#7 * #16#5;
     |SINO;
          nUni = #29#6 * (#29#7 / #36#8 * #36#9) * #17#7 * #16#5;
     |FINSI;
     |HAZ GraConsumo;
|FPRC;

|DEFBUCLE CompoHerrajes1;
     #29#1;
     8;
     #17#0, #17#1, #17#2, #17#3, "                    ", "N";
     #17#0, #17#1, #17#2, #17#3, "zzzzzzzzzzzzzzzzzzzz", "N";
     ;
     NULL, CompoHerrajes1;
|FIN;

|PROCESO ortsm017;
     #17#25 = 0;

     |BUCLE LinEscandallo;

     |SI #17#8 = "S"; |Y #17#7 > 1;    || Desglose unidades
          |BUCLE CombiUniTirador;
     |SINO;
          aTira = #17#11 ;|QBF aTira;
          |SI aTira ! "";
               #7#0 = #17#11;
               |LEE 000#7=;
               |SI FSalida = 0;
                    aArt = #7#2;
                    aDes = #7#3;
                    nUni = #16#5;
                    |HAZ GraConsumo;
               |FINSI;
          |FINSI;
     |FINSI;

     |BUCLE CompoHerrajes1;
     |BUCLE CompoCanteado1;
     |GRABA 020#17a;
|FPRC;

|DEFBUCLE ortsm017;
     #17#1;
     ;
     #16#28, #16#0, #16#1, 000;
     #16#28, #16#0, #16#1, 999;
     be;
     NULL, ortsm017;
|FIN;

|PROCESO LinEscan2; || por si acaso metro otro nivel
     #49#0 = aArt2;
     #49#1 = 1;
     |LEE 000#49];
     |SI FSalida = 0; |Y #49#0 = aArt2;
          |PARA; |SI FSalida = 0; |Y #49#0 = aArt2; |HACIENDO;
               aAlfa = #49#2; |QBF aAlfa;
               |SI #49#10 = 1; |Y aAlfa ! "";
                    #119#0 = #49#2;
                    |LEE 000#119=;
                    |SI FSalida ! 0; |DDEFECTO #119; |FINSI;
                    |SI #119#2 ! #36#15;
                         aArt = #49#2;
                         aDes = #49#3;
                         nUni = #49#12 * nUni2;
                         |HAZ GraConsumo;
                    |FINSI;
               |FINSI;
               |LEE 000#49s;
          |SIGUE;
     |SINO;
          #119#0 = aArt2;
          |LEE 000#119=;
          |SI FSalida ! 0; |DDEFECTO #119; |FINSI;
          |SI #119#2 ! #36#15;
               aArt = aArt2;
               aDes = aDes2;
               nUni = nUni2;
               |HAZ GraConsumo;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO LinEscan1;
     #49#0 = aArt1;
     #49#1 = 1;
     |LEE 000#49];
     |SI FSalida = 0; |Y #49#0 = aArt1;
          |PARA; |SI FSalida = 0; |Y #49#0 = aArt1; |HACIENDO;
               aAlfa = #49#2; |QBF aAlfa;
               |SI #49#10 = 1; |Y aAlfa ! "";
                    #119#0 = #49#2;
                    |LEE 000#119=;
                    |SI FSalida ! 0; |DDEFECTO #119; |FINSI;
                    |SI #119#2 ! #36#15;
                         |SALVA_FICHA #49;

                         aArt2 = #49#2;
                         aDes2 = #49#3;
                         nUni2 = #49#12 * nUni1;
                         |HAZ LinEscan2;

                         |REPON_FICHA #49;
                    |FINSI;
               |FINSI;
               |LEE 000#49s;
          |SIGUE;
     |SINO;
          #119#0 = aArt1;
          |LEE 000#119=;
          |SI FSalida ! 0; |DDEFECTO #119; |FINSI;
          |SI #119#2 ! #36#15;
               aArt = aArt1;
               aDes = aDes1;
               nUni = nUni1;
               |HAZ GraConsumo;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Actualiza;
     #15#25 = #ortsm035@#5;
     #15#0 = #ortsm035@#6;
     |LEE 000#15=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     #16#28 = #ortsm035@#5;
     #16#0 = #ortsm035@#6;
     #16#1 = #ortsm035@#7;
     |LEE 101#16=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     #35#0 = #ortsm035@#0;
     #35#1 = #ortsm035@#1;
     #35#2 = #ortsm035@#2;
     |LEE 121#35=;
     |SI FSalida = 0; |Y #35#9 = "N";
          |DDEFECTO #31;
          #31#0 = #35#5;
          #31#1 = #35#6;
          #31#2 = #35#7;
          #31#3 = "";
          |LEE 101#31];
          |SI FSalida = 0; |Y #31#0 = #35#5; |Y #31#1 = #35#6; |Y #31#2 = #35#7;
               FSalida = 0;
          |SINO;
               #19#0 = #16#2;
               |LEE 000#19=;
               |SI FSalida ! 0; |DDEFECTO #19; |FINSI;
               |SI #19#2 = "S";    ||Tratamiento imos = S
                    |HAZ CalConsumoLin;
               |SINO;              ||Tratamiento imos = N
                    |ABRE #480;

                    |BUCLE ortsm017;

                    #480#0 = #16#2;
                    |LEE 000#480=;
                    |SI FSalida = 0;
                         |SI #19#1 = "N";
                              aTira = #16#60 ;|QBF aTira;
                              |SI aTira ! "";
                                   #7#0 = #16#60;
                                   |LEE 000#7=;
                                   |SI FSalida = 0;
                                        aArt = #7#2;
                                        aDes = #7#3;
                                        nUni = #16#5;
                                        |HAZ GraConsumo;
                                    |FINSI;
                              |FINSI;
                         |FINSI;

                         |ABRE #49;
                         #49#0 = #480#0;
                         #49#1 = 1;
                         |LEE 000#49];
                         |PARA; |SI FSalida = 0; |Y #49#0 = #480#0; |HACIENDO;
                              aAlfa = #49#2; |QBF aAlfa;
                              |SI #49#10 = 1; |Y aAlfa ! "";
                                   #20#0 = #49#0;
                                   #20#1 = #49#1;
                                   |LEE 000#20=;
                                   |SI FSalida = 0; |Y #20#2 = "N";
                                        |SALVA_FICHA #49;

                                        aArt1 = #49#2;
                                        aDes1 = #49#3;
                                        nUni1 = #49#12 * #16#5;
                                        |HAZ LinEscan1;

                                        |REPON_FICHA #49;
                                   |FINSI;
                              |FINSI;
                              |LEE 000#49s;
                         |SIGUE;
                         |CIERRA #49;
                    |SINO;
                         aArt = #16#2;
                         aDes = #16#4;
                         nUni = #16#5;
                         |HAZ GraConsumo;
                    |FINSI;
                    |CIERRA #480;
               |FINSI;
          |FINSI;
          |SI #35#8 = "A"; nForma = 1; |FINSI;
          |SI #35#8 = "B"; nForma = -1; |FINSI;
          |SI #35#8 = "M"; nForma = -1; |BUCLE Acumula; nForma = 1; |FINSI;
          |BUCLE Acumula;
          #35#9 = "S";
          |GRABA 020#35a;
          |LIBERA #35;
     |FINSI;

     #16#62 = 0;
     |BUCLE SumaCoste;
     |GRABA 020#16a;
     |LIBERA #16;
|FPRC;

|DEFBUCLE Actualiza;
     #ortsm035@#2003;
     ;
     " ", "01.01.0000", "        ";
     "z", "31.12.9999", "zzzzzzzz";
     ;
     NULL, Actualiza;
|FIN;

|PROCESO ortsm035;
     |SALVA_DATOS #35;
     |REPON_DATOS #ortsm035@;
     |GRABA 020#ortsm035@.n;
|FPRC;

|DEFBUCLE ortsm035;
     #35#2;
     ;
     "N", "01.01.0000", "        ";
     "N", "31.12.9999", "zzzzzzzz";
     ;
     NULL, ortsm035;
|FIN;

|PROCESO T3; |TIPO 3;
     |SI #0#0 ! "SI"; |ACABA; |FINSI;

     |ABRE #36; |LEE 000#36p; |CIERRA #36;

     |DDEF aAlfa;
     aAlfa = aAlfa + "ortsm035";
     |CARGA_DEF aAlfa, ortsm035@;
     |SI FSalida = 0;
          |HAZ CreaTempo; |NOME_DAT #ortsm035@#Tempo#; aTmp35 = Tempo;
          |DELINDEX  #ortsm035@;
          |ABRE #ortsm035@;

          || Cargo un temporal ya que se despirula el puntero
          || al grabar el campo 'Actualizado' que pertenece a la clave
          |BUCLE ortsm035;

          |ABRE #7;
          |ABRE #10;
          |ABRE #15;
          |ABRE #16;
          |ABRE #19;
          |ABRE #20;
          |ABRET #31;
          |ABRE #34;
          |ABRE #35;
          |ABRE #65;
          |ABRE #117;
          |ABRE #119;
          |BUCLE Actualiza;
          |CIERRA #119;
          |CIERRA #117;
          |CIERRA #65;
          |CIERRA #35;
          |CIERRA #34;
          |CIERRAT #31;
          |CIERRA #20;
          |CIERRA #19;
          |CIERRA #16;
          |CIERRA #15;
          |CIERRA #10;
          |CIERRA #7;

          |CIERRA #ortsm035@;
          Tempo = aTmp35; |HAZ BoraTempo;
          |DELINDEX #ortsm035@;
          |DESCARGA_DEF #ortsm035@;
     |FINSI;
|FPRC;

|| Para pruebas se desasigna el albaran
|| se borra el ortsm035 y el ortsm031 y se vuelve a asignar el albaran

|PROGRAMA;
     |SI PARAMETRO = "menu";
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
     |SINO;
          #0#0 = "SI";
          |HAZ T3;
     |FINSI;
|FPRO;
