|FICHEROS;
     agifa010 #10;
     agifa024 #24;
     agifa059 #59;
     agifa073 #73;
     agifa071 #71;
     agifa072 #72;
     agifa077 #77;
     agifa079 #79;
     agifa084 #84;
     agifa091 #91;
     agifa104 #104;
     agifa112 #112;
     agifa133 #133;
     agifa134 #134;
     dsm00045 #45,MANTE;
     dsm00130@ #130;     ||como referencia por problemas con el MANTE
     referen@;
     refere1@;
     refere2@;
|FIN;

|VARIABLES;
     aM1 = "";
     aM2 = "";
     nDia = 0;
     nMes = 0;
     nHay = 0;
     nSwOrts = 0;
     &eaEstanTodosCobrados = "";
     nImpoOrg = 0;
     nTotalAlb = 0;
     nTotalCob = 0;
     aSer = "";
     nNum = 0;
     nEmp = 0;
     aBass = "";
     nImp = 0;
     &enVtoDir = 0;
     nIniVto = 0;
     fUltDiaMes = @;
     f = @;
     aMes1 = "";
     nDiasMes = 0;

     nNumFec = 0;
     nNumAlb = 0;
     nNumActa = 0;
     nSali = 0;
     nNume = 0;
     &nDeci_BaseMx = 0;
     &eaVigorFecVto = "";
     nImpoRete = 0;
     fFechaRete = @;
     nAcuenta = 0;
     nImpoCadaUno = 0;
     nFaltaVen = 0;

     &efJesFecVto = @;
     &enFecVto      = 0;
     nMesNoPago     = 0;
     &nDeci_Base    = 0;
     &eaProg        = "";
     nSwMarhu       = 0;
     i              = 0;
     nDesde         = 0;
     nDesdeImp      = 0;
     nImpo          = 0;
     nDiaPago       = 0;
     nDias          = 0;
     nCamFPago      = 0;
     nAbono         = 0;
     nVtos          = 0;
     nResto         = 0;
     nMult          = 0;
     nEuro          = 0;
     nEntero        = 0;
     nTota          = 0;
     nImpMax        = 0;
     nDia1          = 0;
     nDia2          = 0;
     nDia3          = 0;
     nImpVto        = 0;
     nCamFec        = 0;
     nCamImp        = 0;
     aEuro          = "";
     aDia           = "";
     aMes           = "";
     aAlfa          = "";
     bAlfa          = "";
     aPago          = "";
     fFecha         = @;
     fFecha1        = @;
     fFechaFac      = @;
     fFecVto        = @;
     fAntes = @;
     aCli = "";
     aDFecha = "";
     aHFecha = "";
     fDFecha = @;
     fHFecha = @;
     aAno = "";
     aDef = "";
     nEsVta = 0;
     nMesPago = 0;
     nMesAnt = 0;
|FIN;

|PROCESO dsm00130;
     aAno = fFecVto; aAno = aAno % -104;
     aDFecha = (("00" + #130#2) % -102) +"."+(("00" + #130#3) % -102) +"."+aAno;
     aHFecha = (("00" + #130#4) % -102) +"."+(("00" + #130#5) % -102) +"."+aAno;
     fDFecha = aDFecha;
     fHFecha = aHFecha;
     |SI fFecVto ] fDFecha; |Y fFecVto [ fHFecha;
          fFecha = fHFecha + 1;
          |HAZ DiasFijos;
          fFecVto = fFecha;
     |FINSI;
|FPRC;

|DEFBUCLE dsm00130;
     #130#1002;
     ;
     aCli, 01;
     aCli, 99;
     ;
     NULL, dsm00130;
|FIN;

|PROCESO Cambios;
     fFecha1 = fFecha;
     aDia = fFecha1 % 102;
     aMes = fFecha1 % 402;
     nDiaPago = aDia;
     nMesPago = aMes;
|FPRC;

|PROCESO DiasFijos;
     |SI nDia1 = 0;
          |VETE FinFijos;
     |FINSI;
     |HAZ Cambios;
     |SI nDiaPago > nDia1;
          |VETE  Fijos2;
     |FINSI;

  |ET Fijos1;
     |SI nDiaPago = nDia1;
          |VETE FinFijos;
     |FINSI;

     |HAZ Cambios;
     fAntes = fFecha;
     nMesAnt = nMesPago;

     fFecha = fFecha + 1;
     |HAZ Cambios;

     || SI el dia fijo=30 y el vto es en Febrero y la fp a 30 dias
     nNume = nDias $ 30;
     |SI nDia1 = 30; |Y nMesAnt = 2; |Y nMesPago = 3; |Y nNume = 0;
          fFecha = fAntes;
          |VETE FinFijos;
     |FINSI;

     |VETE Fijos1;

  |ET Fijos2;
     |SI nDia2 = 0; |O nDiaPago [ nDia1;
          |VETE Fijos1;
     |FINSI;
     |SI nDiaPago > nDia2;
          |VETE Fijos3;
     |FINSI;
     |SI nDiaPago = nDia2;
          |VETE FinFijos;
     |FINSI;

     |HAZ Cambios;
     fAntes = fFecha;
     nMesAnt = nMesPago;

     fFecha = fFecha + 1;
     |HAZ Cambios;

     || SI el dia fijo=30 y el vto es en Febrero y la fp a 30 dias
     nNume = nDias $ 30;
     |SI nDia2 = 30; |Y nMesAnt = 2; |Y nMesPago = 3; |Y nNume = 0;
          fFecha = fAntes;
          |VETE FinFijos;
     |FINSI;

     |VETE Fijos2;

  |ET Fijos3;
     |SI nDia3 = 0;|O nDiaPago > nDia3; |O nDiaPago [ nDia1; |O nDiaPago [ nDia2;
          |VETE Fijos1;
     |FINSI;
     |SI nDiaPago = nDia3;
         |VETE FinFijos;
     |FINSI;

     |HAZ Cambios;
     fAntes = fFecha;
     nMesAnt = nMesPago;

     fFecha = fFecha + 1;
     |HAZ Cambios;

     || SI el dia fijo=30 y el vto es en Febrero y la fp a 30 dias
     nNume = nDias $ 30;
     |SI nDia3 = 30; |Y nMesAnt = 2; |Y nMesPago = 3; |Y nNume = 0;
          fFecha = fAntes;
          |VETE FinFijos;
     |FINSI;

     |VETE Fijos3;

  |ET FinFijos;
     fFecha1 = fFecha;
|FPRC;

|RUTINA Febrero;
     |SI i = 1;
          fFecha = fFechaFac;
          |HAZ Cambios;
          nMesAnt = nMesPago;
          fAntes = fFecha;
     |FINSI;
     fFecha = fFechaFac + nDias;
     |HAZ Cambios;
     |SI nMesPago = 3; |Y nMesAnt = 1;
          fFecha = fAntes;
          |PARA; |SI; |HACIENDO;
               fAntes = fFecha;
               fFecha = fFecha + 1;
               |HAZ Cambios;
               |SI nMesPago = 3; fFecha = fAntes; |SAL; |FINSI;
          |SIGUE;
     |FINSI;
     nMesAnt = nMesPago;
     fAntes = fFecha;
|FRUT;

|PROCESO dsm00130_Orts;
     aAlfa = fFecha1 % 102; nDia = aAlfa;
     aAlfa = fFecha1 % 402; nMes = aAlfa;
     |SI nMes ] #130#3; |Y nMes [ #130#5;
          |SI nDia ] #130#2; |Y nDia [ #130#4;
               nHay = 1; |ERROR;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsm00130_Orts;
     #130#1002;
     ;
     aCli, 01;
     aCli, 99;
     ;
     NULL, dsm00130_Orts;
|FIN;

|| ** N O T A **
|| Si se cambia este calculo, cambiar el del agifa186 en agif2186.cal

|PROCESO Vencimientos;
     |DDEF aAlfa; aAlfa = aAlfa + "dsm00130";
     |CARGA_DEF aAlfa, dsm00130@;

     |HAZ EsOrts; nSwOrts = FSalida;

     nDias = #91nCamFPago / nMult;
     |SI nDias ! 0; |O nDia1 ! 0; |O nDia2 ! 0; |O nDia3 ! 0;
/*
lo quito por el Subtiquet nro. 00331.0002 Cliente: 003068

          nNume = nDias $ 30;
          |SI nDia1 = 0; |Y nNume = 0;
               ||Si no hay dias de pago y los vto son a 30 dias
               ||y el vto es el supuesto 29, 30 de febrero se pasa al 28
               |HAZ Febrero;
          |SINO;
*/
               fFecha = fFechaFac + nDias;
||          |FINSI;

/* Quitado Tiquet: 1980/1183
          |HAZ EsInforpor;
          |SI FSalida = 0;
               |HAZ FijosInforpor;
          |SINO;
*/
               |HAZ DiasFijos;     ||Estandar
          ||FINSI;

          aMes = fFecha % 402;
          |SI aMes = nMesNoPago;          ||Si es mes de no pago...
               fFecha = fFecha + .001;
               fFechaFac = fFechaFac + .001;
               fFecha1 = fFecha;
          |FINSI;

          |PARA; |SI nSwOrts = 0; |HACIENDO;
               nHay = 0;
               |BUCLE dsm00130_Orts;
               |SI nHay = 0; |SAL; |FINSI;
               fFecha = fFecha + .001;
               fFechaFac = fFechaFac + .001;
               fFecha1 = fFecha;
          |SIGUE;

          fFecVto = fFecha1;
          nImpVto = nImpo * nAbono;
          |SI i = nVtos;
               nImpVto = nImpVto + (nResto * nAbono);
          |FINSI;
     |SINO;
          aMes = fFechaFac % 402;
          |SI aMes = nMesNoPago;          ||Si es mes de no pago...
               fFechaFac = fFechaFac + .001;
          |FINSI;
          fFecVto = fFechaFac;
          nImpVto = nImpo * nAbono;
     |FINSI;
     nImpVto = nImpVto / nEuro;

     |SI nSwOrts ! 0;    || la estandar
          |SI nEsVta = 1;
               |BUCLE dsm00130;
          |FINSI;
     |FINSI;

     |DESCARGA_DEF #dsm00130@;

     |SI #91#75 = "S";
          fFechaFac = fFecVto;
     |FINSI;
|FPRC;

|PROCESO ModiFPPediLin;
     #73#26 = #134#11;
     |GRABA 020#73a;
|FPRC;

|PROCESO ModiFPPediCab;
     #104#9 = #134#11;
     |GRABA 020#104a;
|FPRC;

|DEFBUCLE ModiFPPedi0;
     #104#1;
     ;
     #71#31, #71#12;
     #71#31, #71#12;
     be;
     NULL, ModiFPPediCab, ModiFPPediLin;
|FIN;

|PROCESO ModiFPPedi;
     |BUCLE ModiFPPedi0;
|FPRC;

|PROCESO ModiFPago;
     #10#52 = #59#15;
     #10#0 = #59#2;
     |LEE 121#10=;
     |SI FSalida = 0;
          #10#8 = #134#11;
          |ABRE #71;
          #71#29 = #10#52;
          #71#0 = #10#0
          #71#1 = 1;
          |LEE 101#71];
          |PARA; |SI FSalida = 0; |Y #71#29 = #10#52; |Y #71#0 = #10#0; |HACIENDO;
               |HAZ ModiFPPedi;
               |LEE 101#71s;
          |SIGUE;
          |LIBERA #71;
          |CIERRA #71;
          |GRABA 020#10a;
     |FINSI;
     |LIBERA #10;
|FPRC;

|PROCESO FPagoImpo;
     |SI #134#31 > nDesdeImp; |Y #134#31 [ #45#4;
          #134#11 = #45#2;
          |SALVA_FICHA #10;
          #59#14 = #134#49;
          #59#0 = #134#0;
          #59#1 = 1;
          |LEE 000#59];
          |PARA; |SI FSalida = 0; |Y #59#14 = #134#49; |Y #59#0 = #134#0; |HACIENDO;
               |HAZ ModiFPago;
               |LEE 000#59s;
          |SIGUE;
          |REPON_FICHA #10;
     |FINSI;
     nDesdeImp = #45#4;
|FPRC;

|DEFBUCLE FPagoImpo;
     #45#1;
     ;
     #134#2, 01;
     #134#2, 99;
     ;
     NULL, NULL, NULL, NULL, NULL, FPagoImpo;
     #45#4;
|FIN;

|PROCESO LeePago;
     |ABRE #91;
     |DDEFECTO #91;
     #91#0 = aPago;
     |LEE 020#91=;
     |CIERRA #91;
|FPRC;

|PROCESO Marhuenda;       || Modulo Marhuenda '002380'
     |HAZ EsMarhuenda;
     nSwMarhu = FSalida;

     nImpMax = 20000;         || Importe Maximo
     |SI #134#58 = "EUR";
          nImpMax = nImpMax / 166.386;
     |FINSI;
     aAlfa = #91#1; |QBT aAlfa; aAlfa = aAlfa > "";
     bAlfa = #91#1;
     bAlfa = bAlfa > " ";
     bAlfa = bAlfa - "PAGARE"; |QBT bAlfa;
     |SI nSwMarhu = 0; |Y aAlfa = bAlfa;
          nTota = #134#31;
          |SI nTota < nImpMax;
               #134#11 = "01";
               aPago = #134#11;
               |HAZ LeePago;       || FP. fija a '01'
               nVtos = 1;
          |SINO;
               nVtos = #91#3;
               nTota = nTota / nVtos;
               |PARA; |SI nTota < nImpMax; |Y nVtos > 0; |HACIENDO;
                    nVtos = nVtos - 1;
                    nTota = #134#31;
                    nTota = nTota / nVtos;
               |SIGUE;
               |SI nVtos < 1; nVtos = 1; |FINSI;
          |FINSI;
     |FINSI;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ PROCESOS EXTERNOS ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
 Facturas Venta
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO BorraVenciVta;
     |ABRE #133;
     #133#4 = #134#49;
     #133#0 = #134#0;
     #133#1 = 0;
     |LEE 101#133];
     |PARA; |SI FSalida = 0; |Y #133#0 = #134#0; |Y #133#4 = #134#49; |HACIENDO;
          |BORRA 021#133a;
          |LEE 101#133s;
     |SIGUE;
     |CIERRA #133;
|FPRC;

|PROCESO LeeAlbFactuV;
     #referen@#52 = #59#15;
     #referen@#0 = #59#2;
     |LEE 000#referen@.=;
     nNumFec = nNumFec + #referen@#1;
     nNumAlb = nNumAlb + 1;
|FPRC;

|PROCESO VenciVta;
     nEsVta = 1;
     eaProg = "agifa134";
     |HAZ BorraRecVenta;
     |HAZ BorraVenciVta;
     nDia1 = #134#14;
     nDia2 = #134#15;
     nDia3 = #134#16;
     nDesdeImp = -999999999;
     |HAZ EsTagloma;
     |SI FSalida = 0;
          |HAZ TagloFPagoSerie;
          |SI FSalida = 0;
               #134#11 = aAlfa;
          |SINO;
               |BUCLE FPagoImpo;
          |FINSI;
     |SINO;
          ||...la estandar
          |BUCLE FPagoImpo;
     |FINSI;
     aPago = #134#11;
     |HAZ LeePago;

     |SI #91#74 = "F";
          fFechaFac = #134#1;
     |SINO;
          nNumFec = 0;
          nNumAlb = 0;

/*
          |ABRE #10;
          |BUCLELIN 2 LeeAlbFactuV #134;
          ||CIERRA #10; no lo cierro, hay procesos que fallan

          Lo cambio por un carga_def, tarea T14725
*/
          |DDEF aAlfa;
          aAlfa = aAlfa + "agifa010";
          |CARGA_DEF aAlfa, referen@;
          |SI FSalida = 0;
               |ABRE #referen@;
               |BUCLELIN 2 LeeAlbFactuV #134;
               |CIERRA #referen@;
               |DESCARGA_DEF #referen@;
          |FINSI;
          /*--*/

          nNumFec = nNumFec / nNumAlb;
          fFechaFac = nNumFec;
          |SI nNumAlb = 0; fFechaFac = #134#1; |FINSI;
     |FINSI;
     aCli = #134#2;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |HAZ EsAlbero;
     |SI FSalida = 0;
          enFecVto = fFechaFac;
          |HAZ AlbeFecVto;
          fFechaFac = enFecVto;
     |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |HAZ EsVigor;
     |SI FSalida = 0; |Y eaVigorFecVto ! "";
          fFechaFac = eaVigorFecVto;
     |FINSI;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ

     |HAZ EsInforAlba;
     |SI FSalida = 0;
        nAcuenta = 0;
        |SI #134#32 ! 0;
           nAcuenta = #134#32;
           nImpo = (#134#31 - #134#32) ! nDeci_Base;
        |SINO;
           nImpo = #134#31 ! nDeci_Base;
        |FINSI;
     |SINO;
        nAcuenta = 0;
        |SI #134#32 ! 0;
             |SI #134#31 ] 0; || Si no es abono
                |SI #134#31 ] #134#32;
                   nAcuenta = #134#32;
                   nImpo = (#134#31 - #134#32) ! nDeci_Base;
                   #134#32 = 0;
                |SINO;
                   nImpo = #134#31 ! nDeci_Base;
                |FINSI;
             |SINO;    || ..... si es abono
                |SI #134#31 [ #134#32;
                   nAcuenta = #134#32;
                   nImpo = (#134#31 - #134#32) ! nDeci_Base;
                   #134#32 = 0;
                |SINO;
                   nImpo = #134#31 ! nDeci_Base;
                |FINSI;
             |FINSI;
        |SINO;
           nImpo = #134#31 ! nDeci_Base;
        |FINSI;
     |FINSI;

     nMesNoPago = #24#21;
     nVtos = #91#3;
     |HAZ Marhuenda;
     |SI #91#5 = "N";
          nMult = 1;
     |SINO;
          nMult = 1000;
     |FINSI;

     |SI nImpo < 0;
          nAbono = -1;
     |SINO;
          nAbono = 1;
     |FINSI;
     nImpo = nImpo * nAbono;

     |SI #91#70 ! 0;
          |SI #91#71 = "B";
               nImpoRete = (#134#47 + #134#21 + #134#24 + #134#27 + #134#33 + #134#36) % #91#70;
          |SINO;
               nImpoRete = #134#31 % #91#70;
          |FINSI;
          nImpoRete = nImpoRete * nAbono;
          nImpo = nImpo - nImpoRete;
          fFechaRete = fFechaFac + #91#72;
     |FINSI;
     nImpoOrg = nImpo;

     |HAZ RestaImpDespreciado;

     aEuro = "0" * nDeci_Base;
     aEuro = "1" + aEuro;
     nEuro = aEuro;
     nImpo = nImpo * nEuro;
     nImpo = nImpo ! 0;       ||* Tiquet:3200/216...

     nResto = nImpo $ nVtos;
     nImpo = nImpo / nVtos;
     nEntero = nImpo ! 0;
     |SI nEntero ! nImpo;     ||* ...sino esta comparacion falla
          |SI nEntero > nImpo;
               nImpo = nEntero - 1;
          |SINO;
               nImpo = nEntero;
          |FINSI;
     |FINSI;

     |ABRE #133;

     || Cuando hay desprecios en el gesineed y una factura engloba
     || mas de un albaran, puede haber diferencias ente el total factura
     || y la suna de las entregas+desprecio (total albaran).
     || la variable 'eaEstanTodosCobrados' es = S si todo esta cobrado
     |SI eaEstanTodosCobrados = "S";
          nAcuenta = nTotalCob;
          nImpo = 0;
     |FINSI;

     |SI nAcuenta ! 0;
          nDesde = 1;
          |DDEFECTO #133;
          #133#4 = #134#49; ||serie
          #133#0 = #134#0;  ||numero factura;
          #133#1 = 1;       ||numero linea;
          #133#2 = nAcuenta; ||Importe
          #133#3 = #134#1;  ||Fecha vto.
          |GRABA 020#133n;

          nImpoCadaUno = 0;
          nFaltaVen = 0;
     |SINO;
         nDesde = 0;
     |FINSI;


     |SI nAcuenta ! 0; || Si tiene acta ya ha creado un recibo
                      || si el importe restante es 0 no debe de crear mas
          nNumActa = nImpo ! nDeci_BaseMx;

     |SINO;
          nNumActa = 1;  || No tiene acta, debe de crear lo/s recibo/s
     |FINSI;

     |PARA i = 1; |SI i [ nVtos; |Y nNumActa > 0; |HACIENDO i = i + 1;
          |DDEFECTO #133;
          #133#4 = #134#49; ||serie
          #133#0 = #134#0;  ||numero factura;
          #133#1 = i + nDesde;       ||numero linea;
          |LEE 101#133=;
          |SI FSalida ! 0; |GRABA 021#133b; |FINSI;

          nCamFPago = i + 5;
          |HAZ Vencimientos;
          #133#2 = nImpVto;
          #133#3 = fFecVto;
          |GRABA 021#133a;
          |LIBERA #133;
          |SI i = 1; |Y #133#3 < #134#1;
               |MENAV "0000Algún vencimiento calculado es anterior a la fecha factura, revise las fechas de factura o albaranes.";
          |FINSI;
     |SIGUE;
     |SI #91#70 ! 0;
          |DDEFECTO #133;
          #133#4 = #134#49; ||serie
          #133#0 = #134#0;  ||numero factura;
          #133#1 = i + nDesde;       ||numero linea;
          |LEE 101#133=;
          |SI FSalida ! 0; |GRABA 021#133b; |FINSI;
          #133#2 = nImpoRete;
          #133#3 = fFechaRete;
          |GRABA 021#133a;
          |LIBERA #133;
     |FINSI;
     |CIERRA #133;

     |SI nAcuenta ! 0;
          #134#32 = nAcuenta;
     |FINSI;
|FPRC;

|PROCESO VtoFijo;
     |DDEFECTO #133;
     #133#4 = #134#49; ||serie
     #133#0 = #134#0;  ||numero factura;
     #133#1 = i + nDesde;       ||numero linea;
     |LEE 101#133=;
     |SI FSalida ! 0; |GRABA 021#133b; |FINSI;
     #133#2 = nImpo;
     #133#3 = efJesFecVto;
     |GRABA 021#133a;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
 Facturas Directas
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO BorraVenciDir;
     |ABRE #133;
     #133#4 = #84#48;
     #133#0 = #84#0;
     #133#1 = 0;
     |LEE 101#133];
     |PARA; |SI FSalida = 0; |Y #133#0 = #84#0; |Y #133#4 = #84#48; |HACIENDO;
          |BORRA 021#133a;
          |LEE 101#133s;
     |SIGUE;
     |CIERRA #133;
|FPRC;

|PROCESO VenciDir;
     nEsVta = 1;
     eaProg = "agifa084";
     |SI enVtoDir = 0;
          nIniVto = 1;
          |HAZ BorraRecVenta;
          |HAZ BorraVenciDir;
     |SINO;                ||si > 0 ya se ha creado algun recibo (seri0005)
          nIniVto = enVtoDir + 1;
     |FINSI;
     nDia1 = #84#88;
     nDia2 = #84#89;
     nDia3 = #84#90;
     aCli = #84#3;
     fFechaFac = #84#1;
     nImpo = (#84#41 - #84#63) ! nDeci_Base;
     nMesNoPago = #24#21;
     aPago = #84#8;
     |HAZ LeePago;
     nVtos = #91#3;

     |SI #91#5 = "N";
          nMult = 1;
     |SINO;
          nMult = 1000;
     |FINSI;

     |SI nImpo < 0;
          nAbono = -1;
     |SINO;
          nAbono = 1;
     |FINSI;
     nImpo = nImpo * nAbono;
     |SI #91#70 ! 0;
          |SI #91#71 = "B";
               nImpoRete = (#84#28 + #84#16 + #84#19 + #84#22 + #84#42 + #84#45) % #91#70;
          |SINO;
               ||nImpoRete = #134#31 % #91#70;
               nImpoRete = #84#41 % #91#70;
          |FINSI;
          nImpoRete = nImpoRete * nAbono;
          nImpo = nImpo - nImpoRete;
          fFechaRete = fFechaFac + #91#72;
     |FINSI;

     aEuro = "0" * nDeci_Base;
     aEuro = "1" + aEuro;
     nEuro = aEuro;
     nImpo = nImpo * nEuro;

     nImpo = nImpo ! 0;       ||* Tiquet:3200/216

     nResto = nImpo $ nVtos;
     nImpo = nImpo / nVtos;
     nEntero = nImpo ! 0;
     |SI nEntero ! nImpo;     ||* ...sino esta comparacion falla
          |SI nEntero > nImpo;
               nImpo = nEntero - 1;
          |SINO;
               nImpo = nEntero;
          |FINSI;
     |FINSI;

     nVtos = nVtos + enVtoDir;
     |ABRE #133;
     |PARA i = nIniVto; |SI i [ nVtos; |HACIENDO i = i + 1;
          |DDEFECTO #133;
          #133#4 = #84#48; ||serie
          #133#0 = #84#0;  ||numero factura;
          #133#1 = i;      ||numero linea;
          |LEE 101#133=;
          |SI FSalida ! 0; |GRABA 021#133b; |FINSI;

          nCamFPago = i + 5 - enVtoDir;
          |HAZ Vencimientos;
          #133#2 = nImpVto;
          #133#3 = fFecVto;

          |GRABA 021#133a;
          |LIBERA #133;
     |SIGUE;
     enVtoDir = 0;

     |SI #91#70 ! 0;
          |DDEFECTO #133;
          #133#4 = #84#48; ||serie
          #133#0 = #84#0;  ||numero factura;
          #133#1 = i;      ||numero linea;
          |LEE 101#133=;
          |SI FSalida ! 0; |GRABA 021#133b; |FINSI;
          |HAZ Vencimientos;
          #133#2 = nImpoRete;
          #133#3 = fFechaRete;
          |GRABA 021#133a;
          |LIBERA #133;
     |FINSI;
     |CIERRA #133;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
 Facturas Compra
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO LeeAlbFactuC;
     #77#52 = #72#15;
     #77#0 = #72#2;
     |LEE 000#77=;
     nNumFec = nNumFec + #77#1;
     nNumAlb = nNumAlb + 1;
|FPRC;

|PROCESO VenciComp;
     nEsVta = 0;
     |HAZ BorraRecCompra;
     nDia1 = #79#14;
     nDia2 = #79#15;
     nDia3 = #79#16;

     aPago = #79#11;
     |HAZ LeePago;

     |SI #91#74 = "F";
          fFechaFac = #79#1;
     |SINO;
          nNumFec = 0;
          nNumAlb = 0;
          |ABRE #77;
          |BUCLELIN 2 LeeAlbFactuC #79;
          ||CIERRA #77; no lo cierro, hay procesos que fallan
          nNumFec = nNumFec / nNumAlb;
          fFechaFac = nNumFec;
          |SI nNumAlb = 0; fFechaFac = #79#1; |FINSI;
     |FINSI;
     nImpo = (#79#31 - #79#32) ! nDeci_Base;
     nMesNoPago = #112#18;
     |SI nImpo < 0;
          nAbono = -1;
     |SINO;
          nAbono = 1;
     |FINSI;
     |SI #91#70 ! 0;
          |SI #91#71 = "B";
               #79#146 = (#79#47 + #79#21 + #79#24 + #79#27 + #79#49 + #79#52) % #91#70;
          |SINO;
               #79#146 = #79#31 % #91#70;
          |FINSI;
          nImpo = nImpo - #79#146;
          #79#147 = fFechaFac + #91#72;
     |FINSI;
     nVtos = #91#3;
     |SI nVtos > 12; nVtos = 12; |FINSI;

     |SI #91#5 = "N";
          nMult = 1;
     |SINO;
          nMult = 1000;
     |FINSI;

     nImpo = nImpo * nAbono;

     aEuro = "0" * nDeci_Base;
     aEuro = "1" + aEuro;
     nEuro = aEuro;
     nImpo = nImpo * nEuro;
     nImpo = nImpo ! 0;       ||* Tiquet:3200/216

     nResto = nImpo $ nVtos;
     nImpo = nImpo / nVtos;
     nEntero = nImpo ! 0;
     |SI nEntero ! nImpo;     ||* ...sino esta comparacion falla
          |SI nEntero > nImpo;
               nImpo = nEntero - 1;
          |SINO;
               nImpo = nEntero;
          |FINSI;
     |FINSI;

     |PARA i = 1; |SI i [ 12; |HACIENDO i = i + 1;
          nCamImp = i + 32;
          |SI i [ 6;
               nCamFec = i + 67;
          |SINO;
               nCamFec = i + 122;
          |FINSI;
          #79nCamImp = 0;
          #79nCamFec = "01.01.0000";
     |SIGUE;

     |PARA i = 1; |SI i [ nVtos; |HACIENDO i = i + 1;
          nCamFPago = i + 5;
          |HAZ Vencimientos;
          nCamImp = i + 32;
          |SI i [ 6;
               nCamFec = i + 67;
          |SINO;
               nCamFec = i + 122;
          |FINSI;
          #79nCamImp = nImpVto;
          #79nCamFec = fFecVto;
          |SI i = 1; |Y fFecVto < #79#1;
               |MENAV "0000Algún vencimiento calculado es anterior a la fecha factura, revise las fechas de factura o albaranes.";
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO TagloFPagoSerie;
     nSali = 1;
     |DDEF aAlfa;
     aAlfa = aAlfa + "tagm0059";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida ! 0;
          |MENAV "0000Error al carga 'tagm0059'";
     |SINO;
          |ABRE #referen@;
          #referen@#0 = #134#49;
          |LEE 000#referen@.=;
          |SI FSalida = 0;
               nSali = 0;
               aAlfa = #referen@#1;
          |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
     FSalida = nSali;
|FPRC;

|PROCESO DesgloFec;
     aDia = f % 102;
     aMes = f % 402;
     aAno = f % 704;
     nDiaPago = aDia;
     nMesPago = aMes;
|FPRC;

|PROCESO UlDiaMes;
     aAlfa = "01." + aMes + "." + aAno;
     aMes1 = aMes;
     nDiasMes = 0;
     |PARA f = aAlfa; |SI; |HACIENDO f = f + 1;
          |HAZ DesgloFec;
          |SI aMes1 ! aMes; |SAL; |FINSI;
          fUltDiaMes = f;
          nDiasMes = nDiasMes + 1;
     |SIGUE;
|FPRC;

/*
  Si el vto es el 30 febrero, 31 abril ... (dias imposibles)
  se pasa al 1 marzo (2 si bisiesto), 1 mayo...
*/
|PROCESO FijosInforpor;
     f = fFecha; |HAZ DesgloFec;
     |HAZ UlDiaMes;

     |SI nDia1 ! 0; |Y nDia1 > nDiasMes;
          nDias = nDia1 - nDiasMes;
          fFecha1 = fUltDiaMes + nDias;
     |SINO;
          |SI nDia2 ! 0; |Y nDia2 > nDiasMes;
               nDias = nDia2 - nDiasMes;
               fFecha1 = fUltDiaMes + nDias;
          |SINO;
               |SI nDia3 ! 0; |Y nDia3 > nDiasMes;
                    nDias = nDia3 - nDiasMes;
                    fFecha1 = fUltDiaMes + nDias;
               |SINO;
                    |HAZ DiasFijos;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ReciEntrega1;
     |SI eaEstanTodosCobrados = ""; eaEstanTodosCobrados = "S"; |FINSI;
     nTotalAlb = nTotalAlb - #refere1@#68 - #refere1@#64;
     nTotalCob = nTotalCob + #refere1@#68 + #refere1@#64;

     nImpo = nImpo - #refere1@#68;
     nAcuenta = nAcuenta + #refere1@#68;
|FPRC;

|| Modificado bucle parqa a¤adir el tipo documento a cta ="A"
|| ya que puede haber facturas y albaranes con la misma numeracion
|DEFBUCLE ReciEntrega1;
     #refere1@#12006;
     46, 69;
     aSer, nNum, 001, "01.01.0000", "            ", "      ", nEmp, "A";
     aSer, nNum, 999, "31.12.9999", "zzzzzzzzzzzz", "zzzzzz", nEmp, "A";
     ;
     NULL, ReciEntrega1;
|FIN;

|PROCESO CtrRecibosLin1;
     |SI #134#49 ] #referen@#4; |Y #134#49 [ #referen@#5;
          aAlfa = aBass + "dscarter/def/dscam003";
          |CARGA_DEF aAlfa, refere1@;
          |SI FSalida = 0;
               aAlfa = aBass + "dscarter/fich/" + (("00000" + #referen@#6)%-105) + "/";
               |PATH_DAT #refere1@#aAlfa#;

               |SELECT #5#refere2@;
               #refere2@#53 = #134#49;
               #refere2@#39 = #134#0;
               #refere2@#52 = "";
               #refere2@#0 = 0;
               |LEE 000#refere2@.];
               |PARA; |SI FSalida = 0; |Y #refere2@#53 = #134#49; |Y #refere2@#39 = #134#0; |HACIENDO;
                    aSer = #refere2@#52;
                    nNum = #refere2@#0;

                    nTotalAlb = #refere2@#67;
                    |BUCLE ReciEntrega1;
                    nTotalAlb = nTotalAlb ! 2;
                    |SI nTotalAlb ! 0;
                         eaEstanTodosCobrados = "N";
                    |FINSI;


                    |LEE 000#refere2@.s;
               |SIGUE;
               |SELECT #1#refere2@;

               |DESCARGA_DEF #refere1@;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE CtrRecibosLin1;
     #referen@#1002;
     2;
     nEmp, 001, "V";
     nEmp, 999, "V";
     ;
     NULL, CtrRecibosLin1;
|FIN;

|| Importe despreciado de la entrega a cuenta del albaran
|| cuando se realiza el cobro desde el gesineed
|PROCESO RestaImpDespreciado;
     |HAZ EsJamaica;
     |SI FSalida = 0; |ACABA; |FINSI;

     eaEstanTodosCobrados = "";
     nTotalCob = 0;
     |DBASS aBass;
     aAlfa = aBass + "dscarter/def/dscam045";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          || usa referencia porque se pierde el puntero
          aAlfa = aBass + "dscomer9/def/agifa010";
          |CARGA_DEF aAlfa, refere2@;
          |SI FSalida = 0;
               |ABRE #refere2@;

               |DFICE aAlfa; aAlfa = aAlfa % -205; nEmp = aAlfa;
               aAlfa = aBass + "dscarter/fich/";
               |PATH_DAT #referen@#aAlfa#;
               |BUCLE CtrRecibosLin1;

               |CIERRA #refere2@;

               |DESCARGA_DEF #refere2@;
          |FINSI;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;
