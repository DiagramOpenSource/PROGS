|FICHEROS;
     diaz0005 #0;
     diam0003 #3;
     diam0005 #5;
     agifa073 #73;
     agifa104 #104;
     dsparm01@ #100;
     dstelm02@ #200;
     dsparm05@ #500;
     agifa142;
|FIN;

|VARIABLES;
     aDat      = "";
     aDef1     = "";
     aDef2     = "";
     aDef3     = "";
     aBase     = "";
     nHay      = 0;
     fFecha    = @;
     nNume     = 0;
     aAlfa     = "";
     aIP       = "";
     aServidor = "";
     aFrom     = "";
     aTo       = "";
     aSubject  = "";
     aMensaje  = "";
     aDjunto   = "Sin_asunto";
     aNume     = "";
     aSerAnt   = "";
     nNumAnt   = 0;
     aToPrepe  = "";
     aFichero  = "";
|FIN;

|PROCESO CorreoLista;
     fFecha = ~;
     aTo = aToPrepe;
     aSubject = fFecha + ": Relacion Pedidos Vencidos con visados/tiquets abiertos.";
     aMensaje = "Abre el fichero adjunto";
     aDjunto  = aFichero;
     aServidor = #100#7;
     aIP = #100#8;
     |QBF aIP;
     |QBF aServidor;

     |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
|FPRC;

|PROCESO diam0005;

     |SI #5#2 = #5#3;    |ACABA;   |FINSI;   || al responsable ya se lo ha enviado antes

     |SI #5#9 = 0;       |ACABA;   |FINSI;   || solo con tiquets asignados

     #200#5 = #104#4;
     #200#0 = #5#9;
     |LEE 000#200=;
     |SI #200#7 = "A";
          #500#0 = #5#3;
          |LEE 000#500=;
          aTo = #500#3; |QBF aTo;
          |SI aTo = "";
               aTo = #500#4;
          |SINO;
               aAlfa = #500#4; |QBF aAlfa;
               |SI aAlfa ! "";
                    aTo = aTo + ";" + #500#4;
               |FINSI;
          |FINSI;
          |QBF aTo;

          aNume = ("000000" + #diam0003#1) % -106;
          aSubject = "Pedido vencido con VISADO abierto: " + #diam0003#0 + "/" + aNume + " (" + #diam0003#7 + ")[" + #200#5 + "." + #200#0 + "] " + #agifa104#8;
          aMensaje = aSubject;
          aServidor = #100#7;
          aIP = #100#8;
          |QBF aIP;
          |QBF aServidor;
          |SI #diaz0005#1 = "N";
               |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
          |FINSI;

          |PRINT;
          nHay = 1;

     |FINSI;
|FPRC;

|DEFBUCLE diam0005;
     #5#1;
     ;
     #3#0, #3#1, #3#2, 0000;
     #3#0, #3#1, #3#2, 9999;
     ;
     NULL, diam0005;
|FIN;

|PROCESO diam0003;
     |DDEFECTO #agifa104;
     #agifa104#25 = #diam0003#0;
     #agifa104#0 = #diam0003#1;
     |LEE 000#agifa104.=;

     |DDEFECTO #diam0005;

     #500#0 = #3#2;
     |LEE 000#500=;
     aTo = #500#3; |QBF aTo;
     |SI aTo = "";
          aTo = #500#4;
     |SINO;
          aAlfa = #500#4; |QBF aAlfa;
          |SI aAlfa ! "";
               aTo = aTo + ";" + #500#4;
          |FINSI;
     |FINSI;
     |QBF aTo;

     aNume = ("000000" + #diam0003#1) % -106;
     aSubject = "Pedido vencido con VISADO abierto: " + #diam0003#0 + "/" + aNume + " (" + #diam0003#7 + ") " + #agifa104#8;
     aMensaje = aSubject;
     aServidor = #100#7;
     aIP = #100#8;
     |QBF aIP;
     |QBF aServidor;
     |SI #diaz0005#1 = "N";
          |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
     |FINSI;

     |PRINT;
     nHay = 1;

     |BUCLE diam0005;    || a los tecnicos
|FPRC;

|DEFBUCLE diam0003;
     #3#1;
     4, 6, 7;
     "      ", 000000, 0000, "S", "A", "01.01.0000";
     "zzzzzz", 999999, 9999, "S", "A",       fFecha;
     ;
     NULL, diam0003;
|FIN;

/*
|PROCESO diam0003;
     |DDEFECTO #diam0005;

     #500#0 = #3#2;
     |LEE 000#500=;
     aTo = #500#3; |QBF aTo;
     |SI aTo = "";
          aTo = #500#4;
     |SINO;
          aAlfa = #500#4; |QBF aAlfa;
          |SI aAlfa ! "";
               aTo = aTo + ";" + #500#4;
          |FINSI;
     |FINSI;
     |QBF aTo;

     aNume = ("000000" + #73#0) % -106;
     aSubject = "Pedido vencido con VISADO abierto: " + #73#28 + "/" + aNume + " " + #agifa104#8;
     aMensaje = aSubject;
     aServidor = #100#7;
     aIP = #100#8;
     |QBF aIP;
     |QBF aServidor;
     |SI #diaz0005#1 = "N";
          |DSCORREO_ENVIA aIP, aServidor, aFrom, aTo, aSubject, aMensaje, aDjunto;
     |FINSI;

     |PRINT;
     nHay = 1;

     |BUCLE diam0005;    || a los tecnicos
|FPRC;

|DEFBUCLE diam0003;
     #3#1;
     4, 6;
     #73#28, #73#0, 0000, "S", "A";
     #73#28, #73#0, 9999, "S", "A";
     ;
     NULL, diam0003;
|FIN;

|PROCESO agifa073;
     |SI aSerAnt ! #73#28;|O nNumAnt ! #73#0;

          |DDEFECTO #agifa104;
          #agifa104#25 = #agifa073#28;
          #agifa104#0 = #agifa073#0;
          |LEE 000#agifa104.=;

          |BUCLE diam0003;         || a los responsables

          aSerAnt = #73#28;
          nNumAnt = #73#0;
     |FINSI;
|FPRC;

|DEFBUCLE agifa073;
     #73#1;
     13;
     "      ", 000000,   1, "01.01.0000";
     "zzzzzz", 999999, 999,       fFecha;
     ;
     NULL, agifa073;
|FIN;
*/

|PROCESO Inicio;
     |DBASS aBase;  |QBF aBase;
     aBase     = aBase + "dspartes/correos";  |MKDIR aFichero;
     aFichero  = aBase + "/" + Usuario + ".txt";
     |FBORRA aFichero;

     Impresora = aFichero;
     |IMPRE -77;
     |SI FSalida = 0;
          |INFOR "diaz0005";
          |SI FSalida ! 0;
               |FINIMP;
          |SINO;
               ||BUCLE agifa073;
               |BUCLE diam0003;
               |PIEINF;
               |FININF;
          |FINSI;
          |FINIMP;
     |FINSI;
     |SI nHay ! 0; |HAZ CorreoLista; |FINSI;

     |FBORRA aFichero;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     |SI #0#0 ! "SI"; |ACABA; |FINSI;

     |CARGA_DEF aDef1, dsparm05@;
     |SI FSalida = 0;
          |CARGA_DEF aDef2, dsparm01@;
          |SI FSalida = 0;
               |CARGA_DEF aDef3, dstelm02@;
               |SI FSalida = 0;
                    |PATH_DAT #500 aDat;
                    |PATH_DAT #100 aDat;
                    |PATH_DAT #200 aDat;
                    |ABRE #100;
                    |LEE 000#100p; || para no concurrir en "/tmp/fichero.txt"
                    |SI FSalida = 0;
                         fFecha = ~;
                         nNume = fFecha;
                         nNume = nNume - #100#13;
                         fFecha = nNume;
                         |ABRE #73;
                         |ABRE #104;
                         |ABRE #200;
                         |ABRE #500;
                         #500#0 = #100#12;
                         |LEE 000#500=;

                         aFrom = #500#3; |QBF aFrom;

                         aToPrepe = #500#3; |QBF aToPrepe;
                         |SI aToPrepe = "";
                              aToPrepe = #500#4;
                         |SINO;
                              aAlfa = #500#4; |QBF aAlfa;
                              |SI aAlfa ! "";
                                   aToPrepe = aToPrepe + ";" + #500#4;
                              |FINSI;
                         |FINSI;
                         |QBF aToPrepe;

                         |HAZ Inicio;

                         |CIERRA #73;
                         |CIERRA #104;
                         |CIERRA #200;
                         |CIERRA #500;
                    |FINSI;
                    |CIERRA #100;
                    |DESCARGA_DEF #dstelm02@;
               |SINO;
                    aDef3 = "0000Error al cargar:" + aDef3;
                    |MENAV aDef3;
               |FINSI;
               |DESCARGA_DEF #dsparm01@;
          |SINO;
               aDef2 = "0000Error al cargar:" + aDef2;
               |MENAV aDef2;
          |FINSI;
          |DESCARGA_DEF #dsparm05@;
     |SINO;
          aDef1 = "0000Error al cargar:" + aDef1;
          |MENAV aDef1;
     |FINSI;
|FPRC;

|PROGRAMA;
     |DBASS aBase; |QBF aBase;

     aDef1 = aBase + "dspartes/def/dsparm05";
     aDef2 = aBase + "dspartes/def/dsparm01";
     aDef3 = aBase + "dspartes/def/dstelm02";
     aDat  = aBase + "dspartes/fich/";

     |SI PARAMETRO = "";
          |MANTE #0;
     |SINO;
          #0#0 = "SI";
          |HAZ Tipo3;
     |FINSI;
|FPRO;
