|FICHEROS;
     agifa079 #0;
     agifa007 #2;
     tmp00078 #79,MANTE;
     agifa142 #142;

     agifa704 #704;
     agifa722 #722;
     dsm00279 #279;

     Referen@ #2000;
|FIN;

|VARIABLES;
     &nDeci_TotVisF = 0;
     &enSwLiquid    = 0;
     &enSwEmpCerrada = 0;

     serie     = "";
     numero    = 0;
     i         = 0;
     nModo     = 0;
     &enSwModi = 0;
     nSwCompru = 0;
     nBases    = 0;
     nCuota    = 0;
     nReca     = 0;
     nNume     = 0;

     fFechaBloq = @;
     aAlfa      = "";
     aAlfa2     = "";
     aAlfa3     = "";

     nDiario    = 0;
     fFecha     = @;
     nDocum     = 0;

     &enLiq              = 0;
     &enCer              = 0;
     &enOk               = 0;
     &eaSer              = "";
     &enFac              = 0;
     &eaAny              = "";
     &eaTip              = "";
|FIN;

|PROCESO CompruImporte;
     nBases = (#79#47 + #79#108 + #79#111 + #79#114 + #79#119 + #79#122) ! nDeci_TotVisF;
     nCuota = (#79#109 + #79#112 + #79#115 + #79#120 + #79#123) ! nDeci_TotVisF;
     nReca =  (#79#110 + #79#113 + #79#125 + #79#121 + #79#124) ! nDeci_TotVisF;

             || Bruto +  Portes +  Varios - Dto
     nNume = (#79#105 + #79#106 + #79#107 - #79#104) ! nDeci_TotVisF;
     |SI #agifa142#177 = "S";
          nNume = (nNume + #79#145) ! nDeci_TotVisF;
     |FINSI;

     |SI nNume ! nBases;
          nSwCompru = 1;
          |MENAV "0000 Total bases incorrecto";
     |FINSI;
     |SI nCuota ! #79#116;
          nSwCompru = 1;
          |MENAV "0000 Total Cuota Iva incorrecto";
     |FINSI;
     |SI nReca ! #79#117;
          nSwCompru = 1;
          |MENAV "0000 Total Recargo incorrecto";
     |FINSI;

             || Bruto +  Portes +  Varios - Dto    + Cuota   + Recar - Reten
     nNume = (#79#105 + #79#106 + #79#107 - #79#104 + nCuota + nReca - #79#126) ! nDeci_TotVisF;
     |SI #agifa142#177 = "S";
          nNume = (nNume + #79#145) ! nDeci_TotVisF;
     |FINSI;
     |SI nNume ! #79#118;
          nSwCompru = 1;
          |MENAV "0000 Total Factura incorrecto";
     |FINSI;

     |SI nSwCompru ! 0;
          |CONFI "0000NEs correcto";
          nSwCompru = FSalida;
     |FINSI;
|FPRC;

|PROCESO CambioImportes0;
     |SI #0#77 = "B"; || Si la moneda de trabajo es la moneda base ...
          #0#17 = #0#104;
          #0#18 = #0#105;
          #0#19 = #0#106;
          #0#20 = #0#107;
          #0#21 = #0#108;
          #0#22 = #0#109;
          #0#23 = #0#100;
          #0#24 = #0#111;
          #0#25 = #0#112;
          #0#26 = #0#113;
          #0#27 = #0#114;
          #0#28 = #0#115;
          #0#29 = #0#116;
          #0#30 = #0#117;
          #0#31 = #0#118;
          #0#49 = #0#119;
          #0#50 = #0#120;
          #0#51 = #0#121;
          #0#52 = #0#122;
          #0#53 = #0#123;
          #0#54 = #0#124;
          #0#55 = #0#125;
          #0#67 = #0#126;

          #0#81 = #0#104 * #0#76 / #0#79;
          #0#82 = #0#105 * #0#76 / #0#79;
          #0#83 = #0#106 * #0#76 / #0#79;
          #0#84 = #0#107 * #0#76 / #0#79;
          #0#85 = #0#108 * #0#76 / #0#79;
          #0#86 = #0##109 * #0#76 / #0#79;
          #0#87 = #0#110 * #0#76 / #0#79;
          #0#88 = #0#111 * #0#76 / #0#79;
          #0#89 = #0#112 * #0#76 / #0#79;
          #0#90 = #0#113 * #0#76 / #0#79;
          #0#91 = #0#114 * #0#76 / #0#79;
          #0#92 = #0#115 * #0#76 / #0#79;
          #0#93 = #0#116 * #0#76 / #0#79;
          #0#94 = #0#117 * #0#76 / #0#79;
          #0#95 = #0#118 * #0#76 / #0#79;
          #0#96 = #0#119 * #0#76 / #0#79;
          #0#97 = #0#120 * #0#76 / #0#79;
          #0#98 = #0#121 * #0#76 / #0#79;
          #0#99 = #0#122 * #0#76 / #0#79;
          #0#100 = #0#123 * #0#76 / #0#79;
          #0#101 = #0#124 * #0#76 / #0#79;
          #0#102 = #0#125 * #0#76 / #0#79;
          #0#103 = #0#126 * #0#76 / #0#79;
     |SINO;
          #0#81 = #0#104;
          #0#82 = #0#105;
          #0#83 = #0#106;
          #0#84 = #0#107;
          #0#85 = #0#108;
          #0#86 = #0##109;
          #0#87 = #0#110;
          #0#88 = #0#111;
          #0#89 = #0#112;
          #0#90 = #0#113;
          #0#91 = #0#114;
          #0#92 = #0#115;
          #0#93 = #0#116;
          #0#94 = #0#117;
          #0#95 = #0#118;
          #0#96 = #0#119;
          #0#97 = #0#120;
          #0#98 = #0#121;
          #0#99 = #0#122;
          #0#100 = #0#123;
          #0#101 = #0#124;
          #0#102 = #0#125;
          #0#103 = #0#126;

          #0#17 = #0#104 / #0#76 * #0#79;
          #0#18 = #0#105 / #0#76 * #0#79;
          #0#19 = #0#106 / #0#76 * #0#79;
          #0#20 = #0#107 / #0#76 * #0#79;
          #0#21 = #0#108 / #0#76 * #0#79;
          #0#22 = #0#109 / #0#76 * #0#79;
          #0#23 = #0#100 / #0#76 * #0#79;
          #0#24 = #0#111 / #0#76 * #0#79;
          #0#25 = #0#112 / #0#76 * #0#79;
          #0#26 = #0#113 / #0#76 * #0#79;
          #0#27 = #0#114 / #0#76 * #0#79;
          #0#28 = #0#115 / #0#76 * #0#79;
          #0#29 = #0#116 / #0#76 * #0#79;
          #0#30 = #0#117 / #0#76 * #0#79;
          #0#31 = #0#118 / #0#76 * #0#79;
          #0#49 = #0#119 / #0#76 * #0#79;
          #0#50 = #0#120 / #0#76 * #0#79;
          #0#51 = #0#121 / #0#76 * #0#79;
          #0#52 = #0#122 / #0#76 * #0#79;
          #0#53 = #0#123 / #0#76 * #0#79;
          #0#54 = #0#124 / #0#76 * #0#79;
          #0#55 = #0#125 / #0#76 * #0#79;
          #0#67 = #0#126 / #0#76 * #0#79;
     |FINSI;
|FPRC;

|PROCESO CambioImportes;
     enSwModi = 0;
     |PARA i = 104; |SI i [ 126; |HACIENDO i = i + 1;
          |SI #0i ! #79i;
               enSwModi = 1;
          |FINSI;
     |SIGUE;
     |SI #0#145 ! #79#145;
          enSwModi = 1;
     |FINSI;

     |SI enSwModi = 1;             ||Solo si modifica
         |HAZ CambioImportes0;
     |FINSI;
|FPRC;

|PROCESO FinModi; |TIPO 12;
     |HAZ CompruImporte;
     |SI nSwCompru = 0;
          enSwModi = 0;
          |PARA i = 104; |SI i [ 126; |HACIENDO i = i + 1;
               |SI #0i ! #79i;
                    enSwModi = 1;
               |FINSI;
               #0i = #79i;
          |SIGUE;
          |SI #0#145 ! #79#145;
               enSwModi = 1;
               #0#145 = #79#145;
          |FINSI;

          |SI enSwModi = 1;             ||Solo si modifica
               |HAZ CambioImportes0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ModiImportes;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     |SI #142#7 = "S";
          |PARA i = 0; |SI i [ 128; |HACIENDO i = i + 1;
               #79i = #0i;
          |SIGUE;
          #79#145 = #0#145;
     |FINSI;
     |PINPA #0#79;
     |PINDA #0#79;
     |PARA nSwCompru = 1; |SI nSwCompru ! 0; |HACIENDO;
          nSwCompru = 0;
          |ENDATOS #1#79;
     |SIGUE;
|FPRC;

|PROCESO ModiCampos; |TIPO 7;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     nModo = (FEntrada / 100) ! 0;

     |SI #142#7 = "S"; |Y nModo = 2;
          |PARA i = 104; |SI i [ 126; |HACIENDO i = i + 1;
               |C_M #0i, 1, "S";
               #79i = #0i;    || Cargo el Temporal para despues comparar
          |SIGUE;
          |C_M #0#79, 1, "S";
          #79#145 = #0#145;
     |SINO;
          |PARA i = 104; |SI i [ 126; |HACIENDO i = i + 1;
               |C_M #0i, 1, "N";
          |SIGUE;
          |C_M #0#79, 1, "N";
          #79#145 = #0#145;
     |FINSI;
|FPRC;

|PROCESO MiraSiLiquidada;
   |ABRE #dsm00279;
   |LEE 000#dsm00279.p;
   |SI FSalida ! 0; |DDEFECTO #dsm00279; |FINSI;
   |CIERRA #dsm00279;

   || Integracion Contagen y Dscomer9

   |HAZ CargaContagen;
   |SI enOk = 1;
       eaSer = #agifa079#66;
       enFac = #agifa079#0;
       eaAny = #agifa079#1 % -102;
       eaTip = "S";
       |HAZ MiraLiquidada;

       enSwLiquid     = enLiq;
       enSwEmpCerrada = enCer;
   |FINSI;

   |SI enSwLiquid ! 0;
       |ACABA;
   |FINSI;

   || Se busca la factura por el caenlace

   enSwLiquid = 0; enSwEmpCerrada = 0;

   |ABRE #agifa722; |DDEFECTO #agifa722;
   #agifa722#0 = "FC";
   #agifa722#1 = #agifa079#66;
   #agifa722#2 = #agifa079#0;
   #agifa722#11 = 1;
   |LEE 000#agifa722.];
   aAlfa2 = #agifa722#1;  |QBF aAlfa2;
   aAlfa3 = #agifa079#66; |QBF aAlfa3;
   |PARA; |SI FSalida = 0; |Y #agifa722#0 = "FC"; |Y aAlfa2 = aAlfa3; |Y #agifa722#2 = #agifa079#0; |HACIENDO;
      |ABRE #agifa704;
      #agifa704#0 = #agifa722#10;
      |LEE 000#agifa704.=;
      |SI FSalida ! 0; |DDEFECTO #agifa704; |FINSI;
      |CIERRA #agifa704;
      aAlfa = #agifa704#6; |QBF aAlfa;
      aAlfa = aAlfa - "contagen";
      |SI FSalida ! 0;
         |SI #dsm00279#22 = "S";
            aAlfa = #agifa704#6; |QBF aAlfa;
            aAlfa = aAlfa + "def/camaniva.mas";
            |CARGA_DEF aAlfa, Referen@;
            |SI FSalida = 0;
               aAlfa = #agifa704#6; |QBF aAlfa;
               aAlfa = aAlfa + "fich/" + (("00000" + #agifa722#8) % -105) + #agifa722#9 + "/";
               |PATH_DAT #Referen@#aAlfa#;
               |ABRE #Referen@;
               |SELECT #2#Referen@;
               #Referen@#7 = #agifa722#4; nDiario = #Referen@#7;
               #Referen@#8 = #agifa722#5; fFecha  = #Referen@#8;
               #Referen@#9 = #agifa722#6; nDocum  = #Referen@#9;
               |LEE 000#Referen@.];
               |PARA; |SI FSalida = 0; |Y #Referen@#7 = nDiario; |Y #Referen@#8 = fFecha;
                       |Y #Referen@#9 = nDocum; |HACIENDO;
                  |SI #agifa079#66 = #Referen@#2; |Y #agifa079#0 = #Referen@#3;
                     |SAL;
                  |FINSI;
                  |LEE 000#Referen@.s;
               |SIGUE;
               |SI FSalida = 0; |Y #Referen@#7 = nDiario; |Y #Referen@#8 = fFecha;
                  |Y #Referen@#9 = nDocum; |Y #agifa079#66 = #Referen@#2;
                  |Y #agifa079#0 = #Referen@#3;
                  |SI #Referen@#40 ! 0; enSwLiquid = 1; |SAL; |FINSI;
               |FINSI;
               |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
            |FINSI;
         |FINSI;
         aAlfa = #agifa704#6; |QBF aAlfa;
         aAlfa = aAlfa + "def/camaasic.mas";
         |CARGA_DEF aAlfa, Referen@;
         |SI FSalida = 0;
            aAlfa = #agifa704#6; |QBF aAlfa;
            aAlfa = aAlfa + "fich/" + (("00000" + #agifa722#8) % -105) + #agifa722#9 + "/";
            |PATH_DAT #Referen@#aAlfa#;
            |ABRE #Referen@;
            #Referen@#0 = 99;
            #Referen@#1 = "01.01.0000";
            #Referen@#2 = 0;
            |LEE 000#Referen@.];
            |SI FSalida = 0; |Y #Referen@#0 = 99;
               enSwEmpCerrada = 1;
            |FINSI;
            |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
         |FINSI;
      |FINSI;
      |LEE 000#agifa722.s;
      aAlfa2 = #agifa722#1;  |QBF aAlfa2;
      aAlfa3 = #agifa079#66; |QBF aAlfa3;
   |SIGUE;
|FPRC;
