|FICHEROS;
     legiz007 #0;        || Lineas Adjudicacion
     legiz006 #1;        || Cabecera Adjudicacion
     legim003 #2;
     legim004 #3;
     agifa019 #4;        || Articulos
     agifa017 #5;        || Almacen
     agifa024 #6;        || Clientes
     legiz008 #8,MANTE;  || Tmp Adj
     agifa112 #9;        || Proveedores
     legim017 #17;
     agifa007 #21;       || Series.
     dsm00053 #53;
     agifa065 #65;
     agifa321;       || DIV - Parametros
     agifa324;       || DIVISAS
     agifa142 #42;
     dsm00246 #40;       ||Control Riesgo Por Usuarios.
     dsm00247 #41;       ||Pantalla Informe Riesgo.
     dsm00248 #43;
     agifa219 #219;
     agifa220 #220;
     dsm00279 #279;
|FIN;

|INCLUYE i_varart;

|VARIABLES;
     &Tempo = "";
     &eaTag = "";
     nTecla = 0;
     aConte = "";
     nError = 0;
     nModo = 0;
     aAlfa = "";
     nLin = 0;
     aDSer = "";
     aHSer = "";
     nMarca = 0;
     nForma = 0;
     nImpo = 0;

     fiac = "  ";
     guarda = "  ";
     relleno = "                                       ";
     aponer = "  ";
     &ac_divisa = "";
     nPreDtoAnt = 0;
     titdiv = 0;
     pintado = 0;
|FIN;

|PROCESO Llena211; |TIPO 6;
     nTecla = FSalida;

     |C_M #0Campo, 0, aAlfa;
     |SI aAlfa = "N"; |ACABA; |FINSI;

     |ABRE #4;
     #4#0 = #0#2;
     |LEE 000#4=;
     |SI FSalida ! 0;
          eaArticulo = #0#2;
          |SUB_EJECUTA_NP "dsz99912;ARTI";
          |SI enSalida ! 0; |ERROR; |ACABA; |FINSI;
     |FINSI;
     |CIERRA #4;

     eaArticulo = #0Campo;
     |HAZ LlenaArticulo;
     |SI FSalida = 0;
          #0Campo = eaArticulo;
          |PINTA #0Campo;
     |SINO;
          |ERROR; |ACABA;
     |FINSI;
     FSalida = nTecla;
|FPRC;

|PROCESO PideArt211;  |TIPO 7;
|FPRC;

|PROCESO Arti0_211; |TIPO 0;
|FPRC;

|PROCESO IVA211_66; |TIPO 66;
     enTiva = #0Campo;
     efFiva = #1#1;
     |HAZ ConsuIVA;
     |SI eaDiva = "";
          |ERROR;
     |SINO;
          #0Campo = enTiva; |PINTA #0Campo;
     |FINSI;
|FPRC;

|PROCESO IVA211_0; |TIPO 0;
     |C_M #0Campo, 0, aAlfa;
     |SI aAlfa = "N"; |ACABA; |FINSI;

     enTiva = #0Campo;
     efFiva = #1#1;
     |HAZ SacaIVA;
     |SI eaDiva = "";
          |MENAV "0000No existe tipo iva para esta fecha...";
          |ERROR; |ACABA;
     |FINSI;
|FPRC;

|PROCESO Lin211; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
          |C_M #0#31, 1, "S";
          |C_M #0#12, 1, "S";
          |C_M #0#2, 1, "N";
          |C_M #0#11, 1, "N";
          |C_M #0#4, 1, "N";
          |C_M #0#5, 1, "N";
          |C_M #0#6, 1, "N";
          |C_M #0#8, 1, "N";
          |C_M #0#33, 1, "N";
     |SINO;
          |C_M #0#31, 1, "N";
          |C_M #0#12, 1, "N";
          |C_M #0#2, 1, "N";
          |C_M #0#11, 1, "S";
          |C_M #0#4, 1, "S";
          |C_M #0#5, 1, "S";
          |C_M #0#6, 1, "S";
          |C_M #0#8, 1, "S";
          |C_M #0#33, 1, "S";
     |FINSI;
|FPRC;

|PROCESO poncontrol;
     fiac = Control % A109;
     fiac = fiac + relleno;
     guarda = fiac % A109;
     fiac = Control % A1001;
     Control = Control + fiac;
     Control = Control + relleno;
     Control = Control % A120;
     Control = Control + aponer;
|FPRC;

|PROCESO UltLin;
     #0#29 = #1#52;
     #0#0 = #1#0;
     #0#1 = 999;
     |LEE 000#0];
     |SI FSalida = 0;
          |LEE 000#0a;
     |SINO;
          |LEE 000#0u;
     |FINSI;
     |SI FSalida = 0; |Y #0#29 = #1#52; |Y #0#0 = #1#0;
          nLin = #0#1;
     |SINO;
          nLin = 0;
     |FINSI;
|FPRC;

|PROCESO CopiaParteDA;
     #53#0 = "A";
     #53#1 = #0#29;
     #53#2 = #0#0;
     #53#3 = #0#1;
     #53#4 = #17#4;
     #53#5 = #17#5;
     |GRABA 020#53n;
|FPRC;

|DEFBUCLE CopiaParteDA;
     #17#1;
     ;
     "P", #3#0, #3#1, #3#2, 0001;
     "P", #3#0, #3#1, #3#2, 9999;
     ;
     NULL, CopiaParteDA;
|FIN;

|PROCESO BorraDA;
     |BORRA 020#53a;
|FPRC;

|DEFBUCLE BorraDA;
     #53#1;
     ;
     "A", #0#29, #0#0, #0#1, 0001;
     "A", #0#29, #0#0, #0#1, 9999;
     ;
     NULL, BorraDA;
|FIN;

|PROCESO Adjudica;
     |ABRE #4;
     #4#0 = #3#3;
     |LEE 000#4=;
     |SI FSalida ! 0; |DDEFECTO #4; |FINSI;
     |CIERRA #4;

     nLin = nLin + #42#236;
     |DDEFECTO #0;
     #0#29 = #1#52;
     #0#0 = #1#0;
     #0#1 = nLin;

     #0#1 = nLin;
     #0#2 = #3#3;
     #0#3 = 1;
     #0#4 = #3#4;
     #0#5 = #3#7;
     #0#6 = #3#8;
     #0#8 = #3#10;
     #0#11 = #4#30;
     #0#12 = #3#1;
     #0#13 = #3#5;
     #0#15 = #1#3;
     #0#16 = #1#34;
     #0#15 = #1#35;
     #0#21 = #3#2;
     #0#23 = #3#7;
     #0#31 = #3#0;
     #0#33 = #3#11;
     #0#36 = #0#6;
     #0#38 = #0#6;
     |HAZ TotalLin71;
     |GRABA 020#0n;
     |CIERRA #4;

     |BUCLE BorraDA;
     |ABRE #53;
     |BUCLE CopiaParteDA;
     |CIERRA #53;

     |HAZ Tipo2Lin;

/*
     |HAZ CalCabAgifa010;
     enForma = 1;
     |HAZ AcumulaAV;


     eaTag = "AV";  |HAZ Riesgos;
*/
|FPRC;

|PROCESO Adj; |TIPO 6;
     |C_M #0#12, 0, aAlfa;
     |SI FSalida = 2; |O FSalida = 3; |O aAlfa = "N"; |ACABA; |FINSI;
     |SI #0#12 = 0;
          |C_M #0#31, 1, "N";
          |C_M #0#12, 1, "N";
          |C_M #0#2, 1, "S";
          |C_M #0#11, 1, "S";
          |C_M #0#4, 1, "S";
          |C_M #0#5, 1, "S";
          |C_M #0#6, 1, "S";
          |C_M #0#8, 1, "S";
          |C_M #0#33, 1, "S";
          |ACABA;
     |FINSI;

     |SI FSalida = 10;
          |HAZ PartePdte;
          |ACABA;
     |FINSI;

     nError = 0;
     |ABRE #2;
     #2#0 = #0#31;
     #2#1 = #0#12;
     |LEE 101#2=;
     |SI FSalida ! 0;
          |MENAV "0000No existe parte...";
          nError = 1;
     |SINO;
          |SI #2#15 = "S";
               |MENAV "0000El parte ya esta adjudicado...";
               nError = 1;
          |FINSI;
          |SI #2#2 ! #1#3; |Y nError = 0;
               aAlfa = "0000El cliente del parte:" + #2#2 + " no se corresponde con el albaran:" + #1#3;
               |MENAV aAlfa;
               nError = 1;
          |FINSI;
          |SI #2#13 ! #1#5; |Y nError = 0;
               aAlfa = "0000El representante del parte:" + #2#13 + " no se corresponde con el albaran:" + #1#5;
               |MENAV aAlfa;
               |CONFI "0000NContinuar con la adjudicacion S/N";
               nError = FSalida;
          |FINSI;
     |FINSI;
     |SI nError = 0;
          aponer = Asino; |HAZ poncontrol;
          |HAZ UltLin;
          |BUCLELIN 2 Adjudica #2;
          aponer = Anosi; |HAZ poncontrol;
          |PTEC 816;
          |PTEC 812;

          #2#15 = "S";
          #2#17 = #0#29;
          #2#18 = #0#0;
          |GRABA 020#2a;
     |SINO;
          |ERROR;
     |FINSI;
     |CIERRA #2;
|FPRC;

|PROCESO Total; |TIPO 0;
     |HAZ TotalLin71;
     |PINTA #0#9;
|FPRC;

|PROCESO AdjTmp;
     |SI #8#5 = "*";
          #2#0 = #8#0;
          #2#1 = #8#1;
          |LEE 121#2=;
          |SI FSalida = 0;
               |BUCLELIN 2 Adjudica #2;
               #2#15 = "S";
               #2#17 = #0#29;
               #2#18 = #0#0;
               |GRABA 020#2a;
               |LIBERA #2;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE AdjTmp;
     #8#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, AdjTmp;
|FIN;

|PROCESO BusParPdte;
     #8#0 = #2#0;
     #8#1 = #2#1;
     #8#2 = #2#7;
     #8#3 = #2#13;
     #8#4 = #2#14;
     #8#5 = "";
     |GRABA 020#8n;
|FPRC;

|DEFBUCLE BusParPdte;
     #2#4;
     0, 15;
     #1#3, "01.01.0000", aDSer, "N";
     #1#3, "31.12.9999", aHSer, "N";
     ;
     NULL, BusParPdte;
|FIN;

|PROCESO Min8;
     #8#0 = "     ";
     #8#1 = 000000;
|FPRC;

|PROCESO Max8;
     #8#0 = "zzzzz";
     #8#1 = 999999;
|FPRC;

|PROCESO Marca; |TIPO 0;
     |SI FSalida = 0;
          |SI #8#5 = "*";
               #8#5 = "";
               nMarca = nMarca - 1;
          |SINO;
               #8#5 = "*";
               nMarca = nMarca + 1;
          |FINSI;
          |GRABA 020#8a;
          |PINTA #8#5;
     |FINSI;
|FPRC;

|PROCESO PartePdte; |TIPO 6;
     |SI FSalida = 1;         || Pulsa ESC
          |ERROR; |PTEC 807;
     |FINSI;
     |SI FSalida = 10;
          |HAZ CreaTempo;
          |NOME_DAT #8 Tempo; |DELINDEX #8; |ABRE #8;
          |SI Campo = 31;
               aDSer = "     ";
               aHSer = "zzzzz";
          |SINO;
               aDSer = #0#31;
               aHSer = #0#31;
          |FINSI;
          |BUCLE BusParPdte;
          |LEE 000#8p;
          |SI FSalida = 0;
               |PUSHV 0501 2380;
               nMarca = 0;
               |PINPA #0#8;
               |ENTLINEAL #1#8, 1, 4, 22, 0, Min8, Max8;
               |SI nMarca > 0;
                    aponer = Asino; |HAZ poncontrol;
                    |HAZ UltLin;
                    |ABRE #2;
                    |BUCLE AdjTmp;
                    |CIERRA #2;
                    aponer = Anosi; |HAZ poncontrol;
                    |ERROR;
                    |PTEC 816;
                    |PTEC 812;
                    |PTEC 807;
               |SINO;
                    |ERROR;
               |FINSI;
               |POPV;
          |SINO;
               |MENAV "0000No hay partes pendientes...";
               |ERROR;
          |FINSI;
          |CIERRA #8; |DELINDEX #8; |HAZ BoraTempo;
     |FINSI;
|FPRC;

|PROCESO PinTota; |TIPO 13;
     |ABRE #agifa321;
     |LEE 001#agifa321.p;
     |SI #1#70 = "D";
          |SI ac_divisa = "S"; |Y #agifa321#3= "S";
               |PINTA 1149,#1#79;
               |PINTA 1168,"        ";
               |PINTA 1168,#1#80;
          |FINSI;
          |CIERRA #agifa321;
          |PINTA 1355,#1#75;
          |PINTA 1368,#1#76;
     |SINO;
          |SI ac_divisa = "S"; |Y #agifa321#3= "S";
               |PINTA 1149,#1#75;
               |PINTA 1168,"        ";
               |PINTA 1168,#1#76;
          |FINSI;
          |CIERRA #agifa321;
          |PINTA 1355,#1#15;
          |PINTA 1368,#1#67;
     |FINSI;
|FPRC;

|PROCESO LinDiv7;  |TIPO 7;
     |ABRE #42; |LEE 000#43p; |CIERRA #42;

     |ABRE #279; |LEE 000#279p; |CIERRA #279;
     nPreDtoAnt = 0;

     nModo = (FEntrada / 100) ! 0;

     |HAZ PintaMedidaV;

     |ABRE #agifa321;
     |LEE 001#agifa321.p;  || Leo parametros de divisa
     |CIERRA #agifa321;

     |SI ac_divisa ! "S";
          |ATRI R;
          |PINTA 1447, "Precio";
          |PINTA 1470, "I.Total";
          |ATRI r;
     |SINO;
          |SI pintado = 0; || Si divisas estan activadas y no he pintado ...
               |SI #1#70 = "D";   || Si la moneda de trabajo es la divisa la pinto en
                    |ATRI R;         || el encabezado del precio y el importe
                    titdiv = "Precio" + "(" + #1#68 + ")";
                    |PINTA 1444,titdiv;
                    titdiv = "I.Tot." + "(" + #1#68 + ")";
                    |PINTA 1468,titdiv;
                    |ATRI r;
               |SINO;
                    |ATRI R;
                    |PINTA 1447, "Precio";
                    |PINTA 1470, "I.Total";
                    |ATRI r;
               |FINSI;
               |SI #agifa321#3 = "S";  || Si la visualizacion esta activada ...
                    ||mensa = "Precio:            Imp.:              T.Bruto:             T.ALB:            ";
                    ||PINTA 1102,mensa;  || ... pinto la linea de visualizacion
                    |PINTA 1102, "Precio:";
                    |PINTA 1121, "Imp.:";
                    |PINTA 1140, "T.Bruto:";
                    |PINTA 1161, "T.ALB:";
                    |PINTA #0#38; || Pinto precio visual
                    |PINTA #0#39; || Pinto importe visual
                    |SI #1#70 = "D"; || Si la moneda de trabajo es la divisa
                         |PINTA 1149,#1#79;
                         |PINTA 1168,#1#80;
                    |SINO;
                         |PINTA 1149,#1#75;
                         |PINTA 1168,#1#76;
                    |FINSI;
                    pintado = 1;  || Ya hemos pintado
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nModo = 1;
          #0#1 = #0#1 + #agifa142#236 - 1;
     |FINSI;
|FPRC;

|PROCESO LlenaDA;
     #53#0 = "A";
     #53#1 = #0#29;
     #53#2 = #0#0;
     #53#3 = #0#1;
     #53#4 = #220#1;
     #53#5 = #220#2;
     |GRABA 020#53n;
|FPRC;

|PROCESO Min53;
     #53#0 = "A";
     #53#1 = #0#29;
     #53#2 = #0#0;
     #53#3 = #0#1;
     #53#4 = 001;
|FPRC;

|PROCESO Max53;
     #53#0 = "A";
     #53#1 = #0#29;
     #53#2 = #0#0;
     #53#3 = #0#1;
     #53#4 = 9999;
|FPRC;

|PROCESO Tipo2Lin; |TIPO 2;
     nForma = 0 +. 1;
     nModo = (FEntrada / 100) ! 0;

     #1#41 = #1#41 + nForma;
     #0#23 = #3#7;
     #0#24 = 0;

     enForma = nForma;
     |HAZ AcumulaAV;
     |HAZ CalCabAgifa010_2;

     eaTag = "AV";  |HAZ Riesgos;

     |SI nModo = 1; |Y #0#12 = 0;
          |ABRE #219;
          #219#0 = #0#3;
          |LEE 000#219=;
          |SI FSalida = 0; |Y #219#2 = "S";
               |BUCLE BorraDA;
               |ABRE #53;
               |BUCLELIN 2 LlenaDA #219;
               |CIERRA #53;
          |FINSI;
          |CIERRA #219;
     |FINSI;
     |SI nForma = 1;
          |SI nModo = 2; |O #0#12 = 0;
               |PUSHV 0501 2380;
               |ENTLINEAL #1#53, 5, 2, 22, 1, Min53, Max53;
               |POPV;
          |FINSI;
     |FINSI;
     |SI nModo = 3;
          |ABRE #2;
          #2#0 = #0#31;
          #2#1 = #0#12;
          |LEE 101#2=;
          |SI FSalida = 0;
               #2#15 = "N";
               #2#17 = "";
               #2#18 = 0;
               |GRABA 020#2a;
          |FINSI;
          |CIERRA #2;
          |BUCLE BorraDA;
     |SINO;
          |SI #0#12 = 0; |C_M #0#2, 1, "S"; |FINSI;
          |HAZ PinTota;
     |FINSI;
|FPRC;

|PROCESO T11; |TIPO 11;
     |SI FSalida = 16;
          |PUSHV 0501 2380;
          |ENTLINEAL #1#53, 5, 4, 22, 1, Min53, Max53;
          |POPV;
     |FINSI;
|FPRC;
