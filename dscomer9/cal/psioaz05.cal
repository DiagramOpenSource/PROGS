|FICHEROS;
     psioaz05 #0;
     agifa010 #10;
     agifa024;
     agifa084 #84;
     agis0002;
     psioa033;

     psioaw01;
     psioaw02;

     dscam003@ #3;
     dscam044@;
     dscam045@;
|FIN;

|VARIABLES;
     aFicTmp    = "";
     aEmp       = "";
     aAlfa      = "";
     aBase      = "";

     nEmpresa   = 0;
     nPaso      = 0;

     &nSw       = 0;
     &nEntrega  = 0;
     &acliente  = "";
     &swImpTot  = 0;
     &aCliAnt   = "";
     &nPenTot   = 0;
     &EURODB    = 0;
|FIN;

|PROCESO agis0002G;
     #psioaw02#0  = #psioaw01#3;
     #psioaw02#1  = #psioaw01#4;
     #psioaw02#2  = #psioaw01#5;
     #psioaw02#3  = #agis0002#18;
     #psioaw02#4  = #agis0002#22;
     #psioaw02#5  = #agis0002#31;
     #psioaw02#6  = #agis0002#28;
     #psioaw02#7  = #agis0002#7;
     #psioaw02#8  = #agis0002#8;
     #psioaw02#9  = #agis0002#16;
     #psioaw02#10 = #agis0002#9;
     #psioaw02#11 = #agis0002#13;
     #psioaw02#12 = #agis0002#11;

     |GRABA 020#psioaw02.n;
     |LIBERA #psioaw02;
|FPRC;

|DEFBUCLE agis0002G;
     #agis0002#1;
     ;
     "A", #agifa010#52, #agifa010#0, 001;
     "A", #agifa010#52, #agifa010#0, 999;
     ;
     NULL, agis0002G;
|FIN;

|PROCESO agis0002S;
     nEntrega = nEntrega + #agis0002#9;
|FPRC;

|DEFBUCLE agis0002S;
     #agis0002#1;
     ;
     "A", #agifa010#52, #agifa010#0, 001;
     "A", #agifa010#52, #agifa010#0, 999;
     ;
     NULL, agis0002S;
|FIN;

|PROCESO agifa010;
     |DDEFECTO #agifa024;
     #agifa024#0 = #agifa010#3;
     |LEE 000#agifa024.=;

     nEntrega = 0;
     |BUCLE agis0002S;

     nEntrega = nEntrega ! EURODB;

     nPenTot  = #agifa010#78 - nEntrega;

     |SI nPenTot = 0;  |ACABA;  |FINSI;

     #psioaw01#0  = #psioa033#0;
     #psioaw01#1  = #agifa024#0;
     #psioaw01#2  = #agifa010#1;
     #psioaw01#3  = "A";
     #psioaw01#4  = #agifa010#52;
     #psioaw01#5  = #agifa010#0;
     #psioaw01#6  = #agifa024#2; ||nombre comercial

     |SI #psioaz05#9 = "F";
         #psioaw01#6 = #agifa024#1; ||nombre fiscal
     |FINSI;

     #psioaw01#7  = #agifa010#6;
     #psioaw01#8  = #agifa010#78;
     #psioaw01#9  = nEntrega;
     #psioaw01#12 = nPenTot;

     |GRABA 020#psioaw01.n;
     |LIBERA #psioaw01;

     |SI #psioaz05#8 = "S";
         |BUCLE agis0002G;
     |FINSI;
|FPRC;

|DEFBUCLE agifa010;
     #agifa010#3;
     6, 84;
     #psioa033#1, #psioaz05#6, "     ", 000001, #psioaz05#4, #psioa033#2;
     #psioa033#1, #psioaz05#7, "zzzzz", 999999, #psioaz05#5, #psioa033#2;
     ;
     NULL, agifa010;
|FIN;

|PROCESO Dscam003;
     |SI #dscam003@#14 ! "C";  |Y  #dscam003@#14 ! "P";
               |Y #dscam003@#14 ! "L";
          |ACABA;
     |FINSI;

     |SI nPaso = 0;
         nEntrega = nEntrega + #dscam003@#23;
     |FINSI;

     |SI nPaso = 1;
         #psioaw02#0  = #psioaw01#3;
         #psioaw02#1  = #psioaw01#4;
         #psioaw02#2  = #psioaw01#5;
         #psioaw02#3  = #dscam003@#2;
         #psioaw02#4  = #dscam003@#12;
         #psioaw02#5  = #dscam003@#85;
         #psioaw02#6  = #dscam003@#5;
         #psioaw02#7  = #dscam003@#4;
         #psioaw02#8  = #dscam003@#3;
         #psioaw02#10 = #dscam003@#23;
         #psioaw02#11 = "N";
         |SI #dscam003@#26 > "01.01.0000";
               #psioaw02#9  = #dscam003@#26;
               #psioaw02#11 = "S";
         |FINSI;
         #psioaw02#12 = "N";

         |GRABA 020#psioaw02.n;
         |LIBERA #psioaw02;
     |FINSI;
|FPRC;

|DEFBUCLE Dscam003;
     #dscam003@#12006;
     69, 46;
     #agifa084#48, #agifa084#0, 01, "01.01.0000", "            ", "      ", " ", nEmpresa;
     #agifa084#48, #agifa084#0, 99, "31.12.9999", "zzzzzzzzzzzz", "zzzzzz", " ", nEmpresa;
     be;
     NULL, Dscam003;
|FIN;

|PROCESO Dscam045;
     |SI #agifa084#48 ] #dscam045@#4; |Y #agifa084#48 [ #dscam045@#5;
         aEmp = ("00000" + #dscam045@#6) % -105;
         aAlfa = aBase + "dscarter/fich/" + aEmp + "/";
          |PATH_DAT #dscam003@#aAlfa#;
          #dscam044@#0 = #dscam045@#0;
          |LEE 000#dscam044@.=;
          |SI FSalida = 0;
              |BUCLE Dscam003;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE Dscam045;
     #dscam045@#1002;
     2;
     nEmpresa, 001, "V";
     nEmpresa, 999, "V";
     ;
     NULL, Dscam045;
|FIN;

|PROCESO LeeCartera;
     |DBASS aBase;
     aAlfa = aBase + "dscarter/def/dscam045";
     |CARGA_DEF aAlfa, dscam045@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aAlfa = aBase + "dscarter/def/dscam044";
     |CARGA_DEF aAlfa, dscam044@;
     |SI FSalida ! 0;
         |DESCARGA_DEF #dscam045@;
         |ACABA;
     |FINSI;

     aAlfa = aBase + "dscarter/def/dscam003";
     |CARGA_DEF aAlfa, dscam003@;
     |SI FSalida ! 0;
         |DESCARGA_DEF #dscam044@;
         |DESCARGA_DEF #dscam045@;
         |ACABA;
     |FINSI;

     aAlfa = aBase + "dscarter/fich/";
     |PATH_DAT #dscam044@#aAlfa#;
     |PATH_DAT #dscam045@#aAlfa#;

     |DFICE aAlfa;
     aAlfa = aAlfa % -205; nEmpresa = aAlfa;

     |ABRE #dscam044@;
     |BUCLE Dscam045;
     |CIERRA #dscam044@;

     |DESCARGA_DEF #dscam003@;
     |DESCARGA_DEF #dscam044@;
     |DESCARGA_DEF #dscam045@;
|FPRC;

|PROCESO agifa084;
     |DDEFECTO #agifa024;
     #agifa024#0 = #agifa084#3;
     |LEE 000#agifa024.=;

     nEntrega = 0;
     nPaso    = 0;
     |HAZ LeeCartera;

     nEntrega = nEntrega ! EURODB;

     nPenTot  = #agifa084#73 - nEntrega;

     |SI nPenTot = 0;  |ACABA;  |FINSI;

     #psioaw01#0  = #psioa033#0;
     #psioaw01#1  = #agifa024#0;
     #psioaw01#2  = #agifa084#1;
     #psioaw01#3  = "F";
     #psioaw01#4  = #agifa084#48;
     #psioaw01#5  = #agifa084#0;
     #psioaw01#6  = #agifa024#2; ||nombre comercial

     |SI #psioaz05#9 = "F";
         #psioaw01#6 = #agifa024#1; ||nombre fiscal
     |FINSI;

     #psioaw01#7  = #agifa084#6;
     #psioaw01#8  = #agifa084#73;
     #psioaw01#9  = nEntrega;
     #psioaw01#12 = nPenTot;

     |GRABA 020#psioaw01.n;
     |LIBERA #psioaw01;

     |SI #psioaz05#8 = "S";
         nPaso = 1;
         |HAZ LeeCartera;
     |FINSI;
|FPRC;

|DEFBUCLE agifa084;
     #agifa084#3;
     6, 91;
     #psioa033#1, #psioaz05#6, "     ", 000001, #psioaz05#4, #psioa033#2;
     #psioa033#1, #psioaz05#7, "zzzzz", 999999, #psioaz05#5, #psioa033#2;
     ;
     NULL, agifa084;
|FIN;

|PROCESO psioa033;
     |BUCLE agifa010;
     |BUCLE agifa084;
|FPRC;

|DEFBUCLE psioa033;
     #psioa033#1;
     ;
     #psioaz05#2, #psioaz05#0, 0001;
     #psioaz05#3, #psioaz05#1, 9999;
     ;
     NULL, psioa033;
|FIN;

|PROCESO psioaw02;
     nSw = 3; |PRINT;
|FPRC;

|DEFBUCLE psioaw02;
     #psioaw02#1;
     ;
     #psioaw01#3, #psioaw01#4, #psioaw01#5, 001;
     #psioaw01#3, #psioaw01#4, #psioaw01#5, 999;
     ;
     NULL, psioaw02;
|FIN;

|PROCESO psioaw01;
     |SI aCliAnt ! #psioaw01#1; |Y aCliAnt ! "";
          nSw = 4; |PRINT;
     |FINSI;

     aCliAnt = #psioaw01#1;
     nSw = 1; |PRINT;

     |SI #psioaz05#8 = "S";
         #psioaw02#0  = #psioaw01#3;
         #psioaw02#1  = #psioaw01#4;
         #psioaw02#2  = #psioaw01#5;
         #psioaw02#3  = 1;
         |LEE 000#psioaw02.];
         |SI FSalida = 0;  |Y #psioaw02#0  = #psioaw01#3;
                           |Y #psioaw02#1  = #psioaw01#4;
                           |Y #psioaw02#2  = #psioaw01#5;
             nSw = 2; |PRINT;

             |BUCLE psioaw02;

             nSw = 5; |PRINT;
         |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE psioaw01;
     #psioaw01#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, psioaw01;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |IMPRE 0;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |INFOR "psioaz05";
     |SI FSalida ! 0;
         |FINIMP;
         |ACABA;
     |FINSI;

     aFicTmp = "psioaw01" + Usuario;  |NOME_DAT #psioaw01#aFicTmp#;
     aFicTmp = "psioaw02" + Usuario;  |NOME_DAT #psioaw02#aFicTmp#;

     |ABRE #psioaw01;  |CIERRA #psioaw01;  |DELINDEX #psioaw01;
     |ABRE #psioaw02;  |CIERRA #psioaw02;  |DELINDEX #psioaw02;

     |ABRET #psioaw01;
     |ABRET #psioaw02;

     |ABRE #agifa024;
     |BUCLE psioa033;
     |CIERRA #agifa024;

     |LEE 000#psioaw01.p;
     |SI FSalida = 0;
         |BUCLE psioaw01;

         nSw = 4; |PRINT;
         |PIEINF;
     |FINSI;

     |FININF;
     |FINIMP;

     |CIERRAT #psioaw01;
     |CIERRAT #psioaw02;

     |DELINDEX #psioaw01;
     |DELINDEX #psioaw02;
|FPRC;

|PROGRAMA;
/*
     |ABRE #0;
     |LEE 101#0=;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;
*/
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
/*
     |SI FSalida = 0; |GRABA 020#0a; |FINSI;
     |CIERRA #0;
*/
|FPRO;
