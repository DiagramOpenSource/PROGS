|FICHEROS;
     albad009 #0;
     agifa112 #1;   ||Proveedores;
     agifa019 #2;   ||Articulos;
     agifa077 #3;   ||Cabecera Albaranes Compras;
     agifa080 #4;   ||Lineas Albaranes Compras;
     agifa091 #91;  ||Formas Pago;
     agifa024 #24;
|FIN;

|VARIABLES;
nCampo = 0;
aAlfa = "";
horas     = "";
fecha     = "";
fecha1    = "";
fiche     = "";
handle    = 0;
empresa   = "";
contenido = "";
elefe     = "";

numlin    = 0;
numensa   = 0;
numseg    = 0;
numreg    = 0;
numalb    = 0;

fecprecom = "";
unid      = 0;

articulo  = "";
swlin     = 0;

campo     = "";
mascara   = "00000000000";
para1     = 0;

alb_inf   = 0;
alb_sup   = 0;
pro_inf   = "";
pro_sup   = "";
fec_inf   = @;
fec_sup   = @;
ser_inf = "";
ser_sup = "";
|FIN;

|CALCULO parri;
     |PARA para1 = 18; |SI para1 [ 23; |HACIENDO para1 = para1 + 1;
           #0para1 = "";
           |PINTA #0para1;
           |C_M #0para1,1,"N";
     |SIGUE;
     |PARA para1 = 30; |SI para1 [ 49; |HACIENDO para1 = para1 + 1;
           #0para1 = "";
           |PINTA #0para1;
           |C_M #0para1,1,"N";
     |SIGUE;
     |PARA para1 = 50; |SI para1 [ 71; |HACIENDO para1 = para1 + 1;
           #0para1 = "";
           |PINTA #0para1;
           |C_M #0para1,1,"N";
     |SIGUE;

     |SI #0#16 = "L";|O #0#16 = "l";
         #0#50 = "";
         #0#51 = "zzzzz";
         #0#18 = 0;
         #0#19 = 999999;
         #0#20 = "";
         #0#21 = "zzzzzz";
         #0#22 = ~;
         #0#23 = ~;
         |PARA para1 = 18; |SI para1 [ 23; |HACIENDO para1 = para1 + 1;
              |C_M #0para1,1,"S";
              |PINTA #0para1;
         |SIGUE;
         |C_M #0#50, 1, "S";
         |C_M #0#51, 1, "S";
     |FINSI;
     |SI #0#16 = "P";|O #0#16 = "p";
         |PARA para1 = 30; |SI para1 [ 49; |HACIENDO para1 = para1 + 1;
              |C_M #0para1,1,"S";
              |PINTA #0para1;
         |SIGUE;
         |PARA para1 = 52; |SI para1 [ 71; |HACIENDO para1 = para1 + 1;
              |C_M #0para1,1,"S";
              |PINTA #0para1;
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO lee_linalblinfam;
     |SI #0#17 = "E";    ||Solo negativos
          |SI #4#5 > 0;
               |ACABA;
          |FINSI;
     |FINSI;
     |SI #0#17 = "D";    ||Solo positivos
          |SI #4#5 < 0;
               |ACABA;
          |FINSI;
     |FINSI;


articulo = #4#2;
|HAZ lee_art;
|SI #2#0 ] #0#5;|Y #2#0 [ #0#6;
    |SI #2#125 ] #0#13;|Y #2#125 [ #0#14;
        |SI #2#2 ] #0#7;|Y #2#2 [ #0#8;
            |SI #2#3 ] #0#9;|Y #2#3 [ #0#10;
                |SI #2#126 ] #0#11;|Y #2#126 [ #0#12;
                    swlin = 1;
                |FINSI;
            |FINSI;
        |FINSI;
    |FINSI;
|FINSI;
|FCAL;

|CALCULO lee_linalb;                ||Lineas de Albaranes Compras;
     |SI #0#17 = "E";    ||Solo negativos
          |SI #4#5 > 0;
               |ACABA;
          |FINSI;
     |FINSI;
     |SI #0#17 = "D";    ||Solo positivos
          |SI #4#5 < 0;
               |ACABA;
          |FINSI;
     |FINSI;

articulo = #4#2;
|HAZ lee_art;
|SI #2#0 ] #0#5;|Y #2#0 [ #0#6;
    |SI #2#125 ] #0#13;|Y #2#125 [ #0#14;
        |SI #2#2 ] #0#7;|Y #2#2 [ #0#8;
            |SI #2#3 ] #0#9;|Y #2#3 [ #0#10;
                |SI #2#126 ] #0#11;|Y #2#126 [ #0#12;
                     numlin = numlin + 1;
                     aAlfa = #agifa019#128;
                     |QBT aAlfa; aAlfa = aAlfa + "                     ";
                     aAlfa = aAlfa % 113;

                    contenido = "LIN+" + numlin + "++" + aAlfa + ":EN'" + elefe;
                    |XGRABA handle, contenido;

                     numseg = numseg + 1;

                     unid = #4#5 * #2#4;
                     |SI unid < 0;
                         unid = unid * -1;
                     |FINSI;
                     contenido = "QTY+12:" + unid + "'" + elefe;
                     |XGRABA handle, contenido;
                     numseg = numseg + 1;

                     unid = #4#5;
                     |SI unid < 0;
                         unid = unid * -1;
                     |FINSI;
                     contenido = "PAC+" + unid + "++CT::9'" + elefe;
                     |XGRABA handle, contenido;
                     numseg = numseg + 1;

                     unid = #2#4;
                     |SI unid < 0;
                         unid = unid * -1;
                     |FINSI;
                     contenido = "QTY+59:" + unid + "'" + elefe;
                     |XGRABA handle, contenido;
                     numseg = numseg + 1;

                     contenido = "DTM+36:" + "99991231" + ":102'" + elefe;
                     |XGRABA handle, contenido;
                     numseg = numseg + 1;
                |FINSI;
            |FINSI;
        |FINSI;
    |FINSI;
|FINSI;
|FCAL;

|CALCULO pasa_albarancom;
     |SI #3#8 = "SC";
          |ACABA;
     |FINSI;

    |HAZ lee_provee;
    swlin = 0;
    |BUCLELIN 0lee_linalblinfam#3;
    |SI swlin = 1;
        numreg = numreg + 1;
        numalb = numalb + 1;
        |HAZ lee_provee;
        |HAZ lee_formapago;
        fecprecom = #3#1 % 0704;
        fecprecom = fecprecom + #3#1 % 0402;
        fecprecom = fecprecom + #3#1 % 0102;
        campo = mascara + numreg;
        |QBT campo;
        campo = campo % -105;
        contenido = "UNH+" + campo + "+DESADV:D:96A:UN:EAN005'" + elefe;
        |XGRABA handle, contenido;
        numseg = numseg + 1;
        numensa = numensa + 1;

        campo = mascara + #3#0;
        |QBT campo;
        campo = campo % -107;
        |SI #3#53 ! "";|Y #3#53 ! "          ";
            campo = #3#53;
            |QBT campo;
        |FINSI;
        contenido = "BGM+351+" + campo + "+9'" + elefe;
        |XGRABA handle, contenido;
        numseg = numseg + 1;

        contenido = "PFT+" + #0#17 + "'" + elefe;
        |XGRABA handle, contenido;
        numseg = numseg + 1;

        contenido = "DTM+137:" + fecprecom + ":102'" + elefe;
        |XGRABA handle, contenido;
        numseg = numseg + 1;

        contenido = "RFF+DQ:" + campo + "'" + elefe;
        |XGRABA handle, contenido;
        numseg = numseg + 1;

        campo = #agifa077#52;
        contenido = "RFF+CR:" + campo + "'" + elefe;
        |XGRABA handle, contenido;
        numseg = numseg + 1;

        |DDEFECTO #agifa024;
        #agifa024#0 = #agifa077#51;
        |LEE 000#agifa024.=;

        campo = #agifa024#163;
        |QBT campo; campo = campo + "                      ";
        campo = campo % 113;
        contenido =  "NAD+BY+" + campo + "::9'" + elefe;
        |XGRABA handle, contenido;
        numseg = numseg + 1;

        contenido = "NAD+DP+" + campo + "::9'" + elefe;
        |XGRABA handle, contenido;
        numseg = numseg + 1;

        contenido = "NAD+SH+" + #0#0 + "::9'" + elefe;
        |XGRABA handle, contenido;
        numseg = numseg + 1;

        contenido = "TDT+12+++" + "8400000001151" + "'" + elefe;
        |XGRABA handle, contenido;
        numseg = numseg + 1;

        contenido = "CPS+1'" + elefe;
        |XGRABA handle, contenido;
        numseg = numseg + 1;


        numlin = 0;
        |BUCLELIN 0lee_linalb#3;

        contenido = "CNT+2:" + numlin + "'" + elefe;
        |XGRABA handle, contenido;
        numseg = numseg + 1;

        campo = mascara + numreg;
        |QBT campo;
        campo = campo % -105;
        contenido = "UNT+" + numseg + "+" + campo + "'" + elefe;
        |XGRABA handle, contenido;
        numseg = 0;

    |FINSI;
|FCAL;

|DEFBUCLE albarancom;
#3#1;
3,1;
ser_inf, alb_inf , pro_inf , fec_inf;
ser_sup, alb_sup , pro_sup , fec_sup;
be;
NULL,pasa_albarancom;
|FIN;

|CALCULO alba0010;
|SI #0#3 = "SI";|O #0#3 = "si";
     |ABRE #24;
    || -------------- Graba la Cabecera del Fichero ----------
    numseg = 0;
    elefe = &010;                 || Cr
    empresa = #0#25;
    |QBF empresa;
    fiche = empresa + #0#24;
    |QBF fiche;

    |XABRE "CWB", fiche, handle;
    |SI FSalida ] 0;
        fecha = #0#26 % 704;
        fecha1 = fecha;
        fecha = #0#26 % 402;
        fecha1 = fecha1 + fecha;
        fecha = #0#26 % 102;
        fecha1 = fecha1 + fecha;
        campo = mascara + #0#2;
        |QBT campo;
        campo = campo % -106;

        contenido = "UNB+UNOA:3+" + #0#0 + ":14+" + #0#1 + ":14+" + fecha1 + ":" + #0#27 + #0#28 + "+" + campo + "'" + elefe;
        |XGRABA handle, contenido;
        numseg = numseg + 1;

        |SI #0#16 = "L";|O #0#16 = "l";
            alb_inf = #0#18;
            alb_sup = #0#19;
            pro_inf = #0#20;
            pro_sup = #0#21;
            fec_inf = #0#22;
            fec_sup = #0#23;
            ser_inf = #0#50;
            ser_sup = #0#51;
            |BUCLE albarancom;
        |FINSI;

        |SI #0#16 = "P";|O #0#16 = "p";
            |PARA para1 = 30; |SI para1 [ 49; |HACIENDO para1 = para1 + 1;
                  nCampo = para1 - 30 + 52;
                  |SI #0para1 ! 0;
                      alb_inf = #0para1;
                      alb_sup = #0para1;
                      pro_inf = "";
                      pro_sup = "zzzzzz";
                      fec_inf = "01.01.0001";
                      fec_sup = "31.12.9999";
                      ser_inf = #0nCampo;
                      ser_sup = #0nCampo;
                      |BUCLE albarancom;
                  |FINSI;
            |SIGUE;
        |FINSI;

        campo = mascara + #0#2;
        |QBT campo;
        campo = campo % -106;
        contenido = "UNZ+" + numensa + "+" + campo + "'" + elefe;
        |XGRABA handle, contenido;

        |XCIERRA handle;
    |FINSI;
    |CIERRA #24;
|FINSI;
|FCAL;

|CALCULO lee_formapago;
|ABRE #91;
#91#0 = #3#8;
|LEE 000#91=;
|LIBERA #91;
|CIERRA #91;
|FCAL;

|CALCULO lee_provee;
|ABRE #1;
#1#0 = #3#3;
|LEE 000#1=;
|LIBERA #1;
|CIERRA #1;
|FCAL;

|CALCULO lee_art;
|ABRE #2;
#2#0 = articulo;
|LEE 000#2=;
|LIBERA #2;
|CIERRA #2;
|FCAL;

|PROGRAMA;
     |ABRE #0;
     |CLS;
     |CABEZA "Intercambio Distribuidor1";
     |PINPA #0#0;
     |LEE 101#0p;
     |SI FSalida = 0;
          |PINDA #0#0;
     |SINO;
          |DDEFECTO #0;
          |GRABA 021#0b;
          |PINDA #0#0;
     |FINSI;
     #0#22 = ~;
     |PINTA #0#22;
     #0#23 = ~;
     |PINTA #0#23;
     #0#26 = ~;
     |PINTA #0#26;
     |HORA horas;
     #0#27 = horas % 102;
     |PINTA #0#27;
     #0#28 = horas % 402;
     |PINTA #0#28;
     |ENDATOS #2#0;
     |HAZ alba0010;
     |SI #0#3 = "SI";|O #0#3 = "si";
         #0#2  = #0#2 + 1;
         #0#3  = "NO";
         #0#22 = ~;
         #0#23 = ~;
         #0#26 = ~;
         #0#27 = horas % 102;
         #0#28 = horas % 402;
         |PARA para1 = 30; |SI para1 [ 49; |HACIENDO para1 = para1 + 1;
               #0para1 = "";
         |SIGUE;
         |PARA para1 = 52; |SI para1 [ 71; |HACIENDO para1 = para1 + 1;
               #0para1 = "";
         |SIGUE;
         |GRABA 000#0a;
     |FINSI;
     |LIBERA #0;
     |CIERRA #0;
|FPRO;
