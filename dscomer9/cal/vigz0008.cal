piens034

|FICHEROS;
 vigz0008 #0;
 vigw0004 #1;
 agifa010 #2;
 agifa071 #3;
 agifa024 #4;
 agifa019 #5;
 vigw0005 #6;
 vigm0043 #43;
 agifa007;
|FIN;

|VARIABLES;
 aTmp1 = "";
 aTmp6 = "";
 &Tempo = "";
 primerazona = 0;
 primer = 0;
 base = 0;
 cte = "";
 &tipo =0;
 dto1 = 0;
 dto2 = 0;
 dto3 = 0;
 fecha = @~;
 a¤o = "";
 zona = "";
 aSerie = "";
|FIN;

|PROCESO EsInterno;
     |ABRE #agifa007;
     #agifa007#26 = aSerie;
     |LEE 000#agifa007.=;
     |CIERRA #agifa007;

     |SI #agifa007#37 = "S";
          FSalida = 0;
     |SINO;
          FSalida = 1;
     |FINSI;
|FPRC;

|PROCESO linalba;
|ABRE #1;
|ABRE #6;
#6#0 = #2#3;
|LEE 010#6=;
|SI FSalida ! 0;
  |DDEFECTO #6;
  #6#0 = #2#3;
  |GRABA 010#6b;
  |LIBERA #6;
|FINSI;
#6#1 = #6#1 + #3#5;
|GRABA 010#6a;
|LIBERA #6;
|CIERRA #6;
|ABRE #4;
#4#0 = #3#15;
|LEE 010#4=;
|SI FSalida ! 0;
  |DDEFECTO #4;
|FINSI;
|LIBERA #4;
|CIERRA #4;
#1#0 = #2#3;
#1#1 = #3#2;
#1#12 = #4#3;
|LEE 010#1=;
|SI FSalida ! 0;
   |DDEFECTO #1;
   #1#0 = #2#3;
   #1#1 = #3#2;
   #1#12 = #4#3;
   |GRABA 010#1b;
   |LIBERA #1;
|FINSI;
|SI #2#1 ] #0#0;
 #1#0 = #2#3;
 #1#1 = #3#2;
 #1#12 = #4#3;
 |LEE 010#1=;
 |SI FSalida ! 0;
   |DDEFECTO #1;
   #1#0 = #2#3;
   #1#1 = #3#2;
   #1#12 = #4#3;
   |GRABA 010#1b;
   |LIBERA #1;
 |FINSI;
 |ABRE #5;
 #5#0 = #3#2;
 |LEE 010#5=;
 |SI FSalida  ! 0;|DDEFECTO #5;|FINSI;
 |CIERRA #5;
 |LIBERA #5;
 #1#2 = #1#2 + #3#5;
 #1#3 = #1#3 + #3#5;
 || #1#6 = #1#6 + (#3#5*#5#9);  || #3#14 antes estaba costo de linea
 #1#6 = #1#6 + #3#14;
 #1#11 = #1#11 + #3#9;
 |ABRE #4;
 #4#0  = #3#15;
 |LEE 010#4=;
 |SI FSalida ! 0;|DDEFECTO #4;|FINSI;
 |CIERRA #4;
 |LIBERA #4;
 |SI #4#39 = 1;
   #1#7 = #1#7 + (#3#5 * #5#18); || UNID. ALBAR. POR PRECIO TARIFA
 |FINSI;
 |SI #4#39 = 2;
   #1#7 = #1#7 + (#3#5 * #5#19);
 |FINSI;
 |SI #4#39 = 3;
   #1#7 = #1#7 + (#3#5 * #5#20);
 |FINSI;                         || Hasta aqui

 dto1 = #3#9 % #2#5;
 dto2 = (#3#9-dto1) % #2#7;
 dto3 = (#3#9-dto1-dto2) % #2#32;
 |GRABA 010#1a;
 |LIBERA #1;
|FINSI;
|CIERRA #1;
|FPRC;

|PROCESO albaran;
     aSerie = #agifa010#52;
     |HAZ EsInterno;
     |SI FSalida ! 0;
          |BUCLELIN 0linalba#2;
     |FINSI;
|FPRC;


|DEFBUCLE albaranes;
#2#7;
;
fecha,"     ", 000001;
#0#1, "zzzzz", 999999;
be;
NULL,albaran;
|FIN;

|PROCESO repaso1;
 |SI #1#0 ! cte;
   |SI primer = 0;
     primer = 1;
   |SINO;
     tipo = 3;
     |PRINT;
   |FINSI;
   |SI zona ! #1#12;
     |SI primerazona = 0;
       zona = #1#12;
       tipo = 4;
       |PRINT;
       primerazona = 1;
    |SINO;
       |PIEINF;
       zona = #1#12;
       tipo = 4;
       |PRINT;
    |FINSI;
   |FINSI;
   tipo = 1;
   |PRINT;
   cte = #1#0;
 |FINSI;
 |ABRE #4;#4#0 = #1#0;|LEE 010#4=;|LIBERA #4;
 |ABRE #5;#5#0 = #1#1;|LEE 010#5=;|LIBERA #5;
 tipo = 2;
 #1#4 = #1#11 - #1#6;
 #1#5 = (#1#4*100)/#1#6;
 #1#8 = (#1#4+#1#6)/#1#3; || 11/04/1997
 #1#9 = ((#1#4+#1#6)-#1#7)/#1#3;
 #1#10 = #1#4 / #1#3;
 |GRABA 010#1a;
 |PRINT;
 |CIERRA #4;
 |CIERRA #5;
|FPRC;

|DEFBUCLE repaso;
#1#1;
;
INICIO;
FINAL;
be;
NULL,repaso1;
|FIN;

|PROCESO HistoTras;
     aSerie = #43#0;
     |HAZ EsInterno;
     |SI FSalida = 0; |ACABA; |FINSI;

     |ABRE #1;
     |ABRE #6;
     #6#0 = #43#17;
     |LEE 010#6=;
     |SI FSalida ! 0; |GRABA 010#6b; |FINSI;

     #6#1 = #6#1 + #43#13;
     |GRABA 010#6a;
     |LIBERA #6;
     |CIERRA #6;

     |ABRE #4;
     #4#0 = #43#8;
     |LEE 000#4=;
     |SI FSalida ! 0; |DDEFECTO #4;|FINSI;
     |CIERRA #4;

     |DDEFECTO #1;
     #1#0 = #43#8;
     #1#1 = #43#12;
     #1#12 = #43#9;
     |LEE 010#1=;
     |SI FSalida ! 0; |GRABA 010#1b; |FINSI;

     |SI #43#6 ] #0#0;
          |DDEFECTO #1;
          #1#0 = #43#8;
          #1#1 = #43#12;
          #1#12 = #43#9;
          |LEE 010#1=;
          |SI FSalida ! 0; |GRABA 010#1b; |FINSI;

          |ABRE #5;
          #5#0 = #43#12;
          |LEE 000#5=;
          |SI FSalida  ! 0;|DDEFECTO #5;|FINSI;
          |CIERRA #5;

          #1#2 = #1#2 + #43#13;
          #1#3 = #1#3 + #43#13;
          #1#6 = #1#6 + #43#16;
          #1#11 = #1#11 + #43#15;

          |ABRE #4;
          #4#0 = #43#8;
          |LEE 000#4=;
          |SI FSalida ! 0;|DDEFECTO #4;|FINSI;
          |CIERRA #4;

          |SI #4#39 = 1;
               #1#7 = #1#7 + (#43#13 * #5#18); || UNID. ALBAR. POR PRECIO TARIFA
          |FINSI;
          |SI #4#39 = 2;
               #1#7 = #1#7 + (#43#13 * #5#19);
          |FINSI;
          |SI #4#39 = 3;
               #1#7 = #1#7 + (#43#13 * #5#20);
          |FINSI;                         || Hasta aqui

          dto1 = #43#15 % #43#18;
          dto2 = (#43#15-dto1) % #43#19;
          dto3 = (#43#15-dto1-dto2) % #43#20;
          |GRABA 010#1a;
          |LIBERA #1;
     |FINSI;
     |CIERRA #1;
|FPRC;

|DEFBUCLE HistoTras;
     #43#3;
     ;
     fecha;
     #0#1;
     ;
     NULL, HistoTras;
|FIN;

|PROGRAMA;
     |CLS;
     |HAZ CreaTempo; |NOME_DAT #1 Tempo; aTmp1 = Tempo;
     |DELINDEX #1;
     |HAZ CreaTempo; |NOME_DAT #6 Tempo; aTmp6 = Tempo;
     |DELINDEX #6;

     |PINPA #0#0;
     |DDEFECTO #0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
       a¤o = #0#0;
       a¤o = a¤o % -104;
       a¤o = "01.01."+a¤o;
       fecha = a¤o;
       |BUCLE albaranes;
       |BUCLE HistoTras;
       |IMPRE 0;
       |SI FSalida = 0;
         |INFOR "vigz0008";
         |SI FSalida = 0;
           |BUCLE repaso;
           tipo = 3;
           |PRINT;
         |FINSI;
         |PIEINF;
         |FININF;
       |FINSI;
       |FINIMP;
     |FINSI;
     Tempo = aTmp1; |HAZ BoraTempo; |DELINDEX #1;
     Tempo = aTmp6; |HAZ BoraTempo; |DELINDEX #6;
|FPRO;
