|FICHEROS;
     agifa007 #7;
     agifa010 #10;
     agifa024 #24;
     agifa071 #71;
     agifa142 #142;
     agifa143 #143;   ||  Temporal pase Facturas Proforma.
     agifa146 #146;
     agifa147 #147;
     agifa166 #166;   ||  Pantalla de pase.
|FIN;

|VARIABLES;
     &enSwMenu = 0;
     &enForma = 0;
     &enImpCliPen = 0;
     &eaCliente = "";
     &efFecha = @;
     &eaTag = "";
     aFichero = "";
     aAlfa = "";
     i = 0;
     importe = 0;
     cant = 0;
|FIN;

|PROCESO Lineas;
     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = #147#1;
     |PARA i = 2; |SI i [17; |HACIENDO i = i + 1;
          #71i = #147i;
     |SIGUE;
     #71#33 = #147#21;
     #71#34 = #147#22;
     #71#35 = #147#23;
     #71#36 = #147#24;
     #71#48 = #147#28;
     #71#49 = #147#29;
     #71#50 = #147#30;
     #71#51 = #147#31;
     #71#52 = #147#32;
     #71#53 = #147#33;
     |GRABA 020#71n;
     enForma = 1;
     |HAZ AcumulaAV;
|FPRC;

|PROCESO Cabecera;
     |DDEFECTO #24;
     |ABRE #24;
     #24#0 = #146#3;
     |LEE 000#24=;
     |CIERRA #24;

     |DDEFECTO #7;
     |ABRE #7;
     #7#26 = #146#48;
     |LEE 000#7=;
     |CIERRA #7;

     |PARA i = 1; |SI i [ 37; |HACIENDO i = i + 1;
          #10i = #146i;
     |SIGUE;
     #10#1 = #143#5;
     #10#40 = #24#41;
     #10#50 = #24#40;
     #10#51 = #7#28;
     #10#62 = #146#81;
     #10#63 = #146#86;
     #10#68 = #146#65;
     #10#69 = #146#66;
     #10#70 = #146#67;
     #10#73 = #146#68;
     #10#74 = #146#69;
     #10#84 = #146#80;
     #10#88 = #146#78;
     aAlfa = "PROFORMA:" + #146#48 + "/" + (("000000" + #146#0) % -106);
     #10#97 = aAlfa;
|FPRC;

|PROCESO Actualiza;
     |SI #10#15 ] 0;
          importe = 1;
     |SINO;
          importe = -1;
          #10#15 = -#10#15;
     |FINSI;
     cant = #10#15 < #10#5;
     cant = cant < #10#32;
     cant = cant < #10#7;
     cant = cant * importe;
     |ABRE #24;
     #24#0 = #10#3;
     |LEE 101#24=;
     |SI FSalida = 0;
        |SI #10#43 = AN;
           #24#50 = #24#50 + cant;    || es albaran
        |SINO;
           #24#50 = #24#50 - cant;    || es abono
        |FINSI;
        |GRABA 020#24a;
        |LIBERA #24;
     |FINSI;
     |CIERRA #24;

     |SI #10#43 = "N";
          enImpCliPen = cant;
     |SINO;
          enImpCliPen =  -cant;
     |FINSI;
     eaCliente = #10#3;
     efFecha = #10#1;
     |HAZ AcumulaCli;

     eaTag = "AV";  |HAZ Riesgos;
|FPRC;

|PROCESO RecalLin;
     |HAZ TotalLin71;
     |HAZ CalCabAgifa010_2;
     |GRABA 020#71a;
|FPRC;

|PROCESO Temporal;
     |DDEFECTO #166;
     #166#0 = #143#2;
     #166#1 = #143#3;
     |PINDA #0#166;

     #146#48 = #143#2;
     #146#0 = #143#3;
     |LEE 121#146=;
     |SI FSalida = 0;
          #10#52 = #143#7;
          enSwMenu = 1;
          |HAZ ContaAV7;
          |GRABA 000#10b;
          |SI FSalida = 0;
               #166#2 = #10#52;
               #166#3 = #10#0;
               |PINDA #0#166;
               |HAZ Cabecera;
               |BUCLELIN 0 Lineas #146;

               |HAZ LimCabAgifa010;
               |BUCLELIN 0 RecalLin #10;
               |GRABA 020#10a;
               |LIBERA #10;

               |HAZ Actualiza;

               #146#60 = #10#52;  ||  Serie.
               #146#61 = ("000000" + #10#0) % -106;   ||  Factura.
               #146#62 = "A";    ||  Tipo de documento asignado
               |GRABA 020#146a;
          |SINO;
               aAlfa = "0000ERROR. Albaran existente:" + #10#52 + "/" + (("000000" + #10#0)%-106);
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
     |LIBERA #146;
|FPRC;

|DEFBUCLE Temporal;
     #143#1;
     8;
     001, "*";
     999, "*";
     ;
     NULL, Temporal;
|FIN;

|PROGRAMA;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     aFichero = PARAMETRO; |QBF aFichero;
     |NOME_DAT #143 aFichero;

     |PINPA #0#166;
     |PINTA 1446,"Albaranes";

     |ABRE #146;
     |ABRET #10;
     |ABRET #71;
     |BUCLE Temporal;
     |CIERRAT #10;
     |CIERRAT #71;
     |CIERRA #146;

     |DELINDEX #143;
|FPRO;
