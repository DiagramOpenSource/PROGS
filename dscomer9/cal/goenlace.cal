|FICHEROS;
     goenlace #0;
     gotrarec;
     gotrarel;
     labtraba@ #100;
     || aomcentr@ #101;
     aontraem@ #101;

     gotrabaj #200;
     gotrabal #201;
|FIN;

|VARIABLES;
     aAlfa = "";
     aAlfa0 = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aBase = "";
     aPathFich = "";
     aPathDef = "";
     nCodGestion = 0;

     nNume = 0;
     nNume1 = 0;
     nNume2 = 0;
     nEdad = 0;
     fFecha = @;
     nContador = 0;
     nTrabAnt = 0;
     nLimite = 0;
     nCuantos = 0;
     nSalto = 0;
     nCodigo = 0;
     FEstado = 0;
     aFechaIni = "";
     aFechaFin = "";
     nUltimo = 0;
     swActualizado = 0;
     aDesde = "";
     aHasta = "";
|FIN;

|PROCESO gotrarel;
     #gotrarel#0 = nCodGestion;
     #gotrarel#4 = #100#36;
     |LEE 000#gotrarel.=;
     FEstado = FSalida;

     #gotrarel#0 = nCodGestion;
     #gotrarel#1 = #100#0;
     #gotrarel#2 = #100#1;
     #gotrarel#3 = #100#45;
     #gotrarel#4 = #100#36;
     #gotrarel#5 = #100#37;

     |SI FEstado = 0;
          || existe, actualizo
          |GRABA 020#gotrarel.a;
     |SINO;
          |GRABA 020#gotrarel.n;
     |FINSI;
     |LIBERA #gotrarel;
|FPRC;

|PROCESO gotrarec;
     #gotrarec#0 = nCodGestion;
     |LEE 000#gotrarec.=;
     |SI FSalida = 0;
          || existe, perfecto
          aFechaIni = #100#36;
          |HAZ gotrarel;
     |SINO;
          #gotrarec#0 = nCodGestion;
          #gotrarec#1 = #100#7;
          #gotrarec#4 = #100#2;
          |GRABA 020#gotrarec.n;
          |LIBERA #gotrarec;
          |HAZ gotrarel;
     |FINSI;
|FPRC;

/*
|PROCESO BuscaGotrabal;
     aFechaIni = #gotrabal#2;
     |SI aFechaIni = #100#36;
          |SI aFechaFin ! "";
               #gotrabal#3 = aFechaFin;
          |FINSI;
          #gotrabal#4 = #100#1;         || trabajador
          #gotrabal#5 = #100#0;         || empresa
          |GRABA 020#gotrabal.a;
          |LIBERA #gotrabal;
          swActualizado = 1;
     |FINSI;
     nUltimo = #gotrabal#1;
|FPRC;

|DEFBUCLE BuscaGotrabal;
     #gotrabal#1;
     ;
     nCodGestion, 0001;
     nCodGestion, 9999;
     be;
     NULL, BuscaGotrabal;
|FIN;

|PROCESO gotrabal;
     aFechaFin = #100#37;
     |QBF aFechaFin;
     nUltimo = 0;
     swActualizado = 0;
     |BUCLE BuscaGotrabal;
     |SI swActualizado = 0;
          || no esta en las lineas, hay que crearlo
          #gotrabal#0 = nCodGestion;         || trabajador
          #gotrabal#1 = nUltimo + 1;
          #gotrabal#2 = #100#36;
          #gotrabal#3 = #100#37;
          #gotrabal#4 = #100#1;         || trabajador
          #gotrabal#5 = #100#0;         || empresa
          |GRABA 020#gotrabal.n;
          |LIBERA #gotrabal;
     |FINSI;
|FPRC;
*/

|PROCESO CreaGotrabaj;
     #200#0 = nCodGestion;         || codigo trabajador
     |LEE 000#200=;
     FEstado = FSalida;

     #200#1 = #100#2;              || nombre trabajador
     #200#2 = #100#87;             || codigo convenio
     #200#3 = #100#17;             || codigo categoria
     #200#4 = #100#3;              || domicilio
     #200#5 = #100#4;              || numero
     #200#6 = #100#5;              || piso
     #200#7 = #100#6;              || localidad
     #200#8 = #100#8;              || C.P. Provincia
     #200#9 = #100#9;              || C.P. Poblacion
     #200#10 = #100#76;            || nacido en
     #200#11 = #100#11;            || fecha nacimiento
     #200#12 = #100#7;             || N.I.F.
     #200#13 = #100#75;            || NAFSS
     #200#14 = #100#19;            || profesion
     #200#15 = #100#238;           || puesto
     #200#16 = #100#244;           || telefono 1
     #200#17 = "";                      || telefono 2
     #200#18 = "";                      || telefono 3
     #200#19 = "";                      || movil
     #200#20 = #100#36;            || fecha inicio contrato
     aAlfa = #100#37;
     |QBF aAlfa;
     |SI aAlfa = ""; |O aAlfa = "..........";
          aAlfa = "";
     |FINSI;
     #200#21 = aAlfa;                   || fecha fin contrato
     #200#22 = #100#234;           || horas jornada (horas t.p.)
     #200#23 = #100#98;            || salario pactado (ajustes)
     #200#24 = #100#25;            || descripcion convenio
     #200#25 = #100#18;            || descripcion categoria
     aAlfa1 = #100#11; aAlfa1 = aAlfa1 % -104; nNume1 = aAlfa1; || Anyo Nacimiento
     fFecha = ~; aAlfa2 = fFecha; aAlfa2 = aAlfa2 % -104; nNume2 = aAlfa2; || Anyo Actual
     nEdad = nNume2 - nNume1;
     aAlfa1 = #100#11; aAlfa1 = aAlfa1 % 402; nNume1 = aAlfa1; || Mes Nacimiento
     fFecha = ~; aAlfa2 = fFecha; aAlfa2 = aAlfa2 % 402; nNume2 = aAlfa2; || Mes Actual
     nNume = nNume2 - nNume1;
     |SI nNume2 < nNume1;
          nEdad = nEdad - 1;
     |FINSI;
     #200#26 = nEdad;                        || edad
     #200#27 = "";                           || e-mail

     |SI FEstado ! 0;
          |GRABA 000#200n;
     |SINO;
          |SI #0#3 = "S";
               |GRABA 000#200a;
          |FINSI;
     |FINSI;

     #201#0 = #200#0;              || codigo trabajador
     || #201#1 = 1;                   || numero de linea
     #201#1 = #100#45;                   || numero de linea
     |LEE 000#201=;
     FEstado = FSalida;

     #201#2 = #100#36;             || Fecha Inicio
     #201#3 = #100#37;             || Fecha Fin
     #201#4 = #100#1;              || codigo trabajador aginom
     #201#5 = #100#0;              || codigo empresa aginom
     |GRABA 000#201n;
     |LIBERA #201;

     |SI FEstado ! 0;
          |GRABA 000#201n;
     |SINO;
          |SI #0#3 = "S";
               |GRABA 000#201a;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CreaCodigo;
/*
     || este es el proceso que genera el codigo por NIF, busca para el salto
     || de la empresa y hasta el siguiente salta que encuentre el ultimo codigo
     || de trabajador disponible, y ese es el que asigna, lo quieto porque
     || ACISA ya no lo usa y a visever tampoco le hara falta, usaran el salto
     || a pelo y los trabajadores no se agruparan por NIF, simplemente al
     || codigo del trabajador se le suma el salto de la empresa y listo
     || aunque esto esta preparado y deberia funcionar, esta hecho aunque de
     || momento no se usara 10.04.2006

     |SELECT #1#101;
     #101#0 = #100#0;    || empresa
     |LEE 000#101=;
     nSalto = #101#2;
     |SELECT #2#101;
     #101#2 = nSalto;
     |LEE 000#101.=;
     |LEE 000#101.s;

     |SI FSalida = 0;
          nLimite = #101#2;
     |SINO;
          nLimite = 99999;
     |FINSI;

     #gotrabaj#0 = nLimite;
     |LEE 000#gotrabaj.];
     |SI FSalida = 0;
          |SI nLimite = #gotrabaj#0;
               |LEE 000#gotrabaj.a;
               |SI FSalida = 0;
                    |SI #gotrabaj#0 ] nSalto;
                         nCodigo = #gotrabaj#0 + 1;
                    |SINO;
                         nCodigo = nSalto;
                    |FINSI;
               |SINO;
                    nCodigo = nSalto;
               |FINSI;
          |SINO;
               |SI #gotrabaj#0 ] nSalto;
                    nCodigo = #gotrabaj#0 + 1;
               |SINO;
                    nCodigo = nSalto;
               |FINSI;
          |FINSI;
     |SINO;
          nCodigo = nSalto;
     |FINSI;
*/

     #101#0 = #100#0;    || empresa
     |LEE 000#101=;
     nSalto = #101#2;

     nCodigo = #100#1 + nSalto;
     nCodGestion = nCodigo;
|FPRC;

|PROCESO BuscaGotrabaj;
     nCuantos = nCuantos + 1;
     nCodGestion = #gotrabaj#0;
|FPRC;

|DEFBUCLE BuscaGotrabaj;
     #gotrabaj#3;
     ;
     #100#7, 00001;
     #100#7, 99999;
     ;
     NULL, BuscaGotrabaj;
|FIN;

|PROCESO gotrabaj;
     nCodGestion = 0;
     nCuantos = 0;

/*
     |BUCLE BuscaGotrabaj;

     || lo mismo, de momento no se va a usar 10.04.2006 migue
     |SI nCuantos = 0;
          |HAZ CreaCodigo;
          nCodGestion = nCodigo;
          |HAZ CreaGotrabaj;
     |SINO;
          |SI nCuantos = 1;
               || es lo ideal
          |SINO;
               || cogere el ultimo que me encuentre
               aAlfa1 = #100#0; aAlfa1 = "00000" + aAlfa1; aAlfa1 = aAlfa1 % -105;
               aAlfa2 = #100#1; aAlfa2 = "00000" + aAlfa2; aAlfa2 = aAlfa2 % -105;
               aAlfa3 = nCodGestion; aAlfa3 = "00000" + aAlfa3; aAlfa3 = aAlfa3 % -105;
               aAlfa = "    ATENCION: Trabajador de Nomina " + aAlfa1 + "." + aAlfa2;
               aAlfa = aAlfa + " con Codigo Duplicado en Gestion.";
               |MENAV aAlfa;
               aAlfa = "    Se usara el ultimo encontrado. Codigo Gestion: " + aAlfa3;
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
*/

     |HAZ CreaCodigo;
     |HAZ CreaGotrabaj;

/*
     || De aqui ya salgo con un codigo de Gestion: el nCodGestion
     || tambien con el gotrarec grabado, ahora voy a intentar actualizar
     || las lineas, busco por fecha de contrato

     ||HAZ gotrabal;
*/
|FPRC;

|PROCESO labtraba;
     |HAZ gotrabaj;

     |HAZ gotrarec;
|FPRC;

|DEFBUCLE labtraba;
     #labtraba@#1002;
     44;
     #0#0, #0#4, aDesde;
     #0#1, #0#5, aHasta;
     be;
     NULL, labtraba;
|FIN;

/*

|| el bucle deberia ser por aqui si se hiciera agrupando por NIF, pero se hara
|| un codigo de trabajador en construccion por cada codigo en nomina

|DEFBUCLE labtraba;
     #labtraba@#2001;
     0;
     "            ", #0#0;
     "zzzzzzzzzzzz", #0#1;
     be;
     NULL, labtraba;
|FIN;
*/

/*
|DEFBUCLE zonas;
     #101#1001;
     ;
     INICIO;
     FINAL;
     ;
     NULL, zonas;
|FIN;

|PROCESO LasZonas;
     |BUCLE zonas;
|FPRC;
*/

|PROCESO Tipo3; |TIPO 3;
     |DBASS aBase;
     |QBF aBase;

     aPathFich = aBase + "aginom/fich/"
     aPathDef = aBase + "aginom/def/";

     aAlfa = aPathDef + "labtraba.mas";
     |CARGA_DEF aAlfa, labtraba@;
     |PATH_DAT #100 aPathFich;

     aAlfa = aPathDef + "aontraem.mas";
     |CARGA_DEF aAlfa, aontraem@;
     |PATH_DAT #101 aPathFich;
/*
     aAlfa = aPathDef + "aomcentr.mas";
     |CARGA_DEF aAlfa, aomcentr@;
     |PATH_DAT #101 aPathFich;
*/
     |ABRE #gotrabaj;
     |ABRE #gotrabal;
     |ABRE #gotrarec;
     |ABRE #gotrarel;
     |ABRE #aontraem@;

     ||HAZ LasZonas;     || para intentar hacer algo que actualice el contador
                         || de las zonas, pero de momento lo dejo y no lo hago

     |SI #0#2 = "A";
          aDesde = "A";
          aHasta = "A";
     |SINO;
          aDesde = "A";
          aHasta = "B";
     |FINSI;

     |BUCLE labtraba;

/*
     |BUCLE labtraba2;
     |SI #0#3 = "S";
          |HAZ AltaGotrabal;
     |FINSI;
*/

     |CIERRA #aontraem@;
     |CIERRA #gotrarec;
     |CIERRA #gotrarel;
     |CIERRA #gotrabaj;
     |CIERRA #gotrabal;

     |DESCARGA_DEF #aontraem@;
     |DESCARGA_DEF #labtraba@;
|FPRC;
