|FICHEROS;
     con00637 #0;
     con00625 #1;
     con01625 #85;
     agifa024 #30;
     con00626 #10;
     con00642 #50;
     con00634 #60;
     con00683 #83;
     con00680 #90;
     con00684 #92;
     agifa059 #55;
     con01637 #20;
     con00690 #21;
     con00691 #691;
     con00696 #696;
     con00614 #614;
     con00633 #633;
     agifa010 #100;
     ||agifa071 #71;
     Ref0001@;
     Ref0002@ #2000;
|FIN;

|VARIABLES;
     &eaDefEmpSerieFe = "";
     &eaMatriculaFE = "";
     &eaModuloFE = ""
     nHayConfEmp = 0;
     nEmpresa = 0;
     aBorra = "";


     &enTotaSin = 0;
     aTmp614 = "";
     &eaTParte = "";
     &eaSelFactuE = "";
     ||FE
     &eaDefAAPPFe = "";
     nSwHayPDF = 0;
     &eaFacturaPDFFe = "";
     aFicheroPDF = "";
     nHandlePDF = 0;
     {3}aPuntero = "";
     aRDirBass    = "";
     nSwGenerarPDF = 0;
     aAlfa = "";
     nSalida = 0;
     &eaAplicacion = "";
     &eaDefFE = "";
     &eaEmpresaFE = "";
     &eaSerieFE = "";
     &eaNumeroFE = "";
     &eaDefLinFe = "";
     &eaDefEmpFe = "";
     &eaDefCliFe = "";
     &eaDefIvaFe = "";
     &eaCodCliFe = "";
     &eaDefAlbFe = "";

     nSwUnaFactura = 0; || Nos indica si es una unica factura o varias (se archivan independientes una a una)
     &eaArCodCli = "";  || Codigo Cliente
     &eaArNomCli = "";  || Nombre Cliente
     &eaArCodCif = "";  || Cif
     &eaArNomCif = "";  || Nombre Cif
     &eaArCodTra = "";  || Codigo Trabajador
     &eaArNomTra = "";  || Nombre Trabajador
     &eaArCamPDF = "";  || Camino al PDF a archivar
     &eaArTipoDoc = ""; || Tipo documento.  FD, FV, etc ...
     &eaArSerDoc = "";  || Serie Docuemnto.
     &enArNumDoc = 0;   || Numero Documento
     &eaArFecDoc = "";  || Fecha Documento.

     &eaSwEnvioCorreo = "";  ||Indica si se enivia por correo al emitir la minuta
     &eaDirDesFE = "";  || Direccion destino para envio por correo
     &eaFirmarFE = "";  || Indica si tenemos que firmar o no el documento
     aOrig = "";
     aDest = "";
     aImpresora = "";
     aAuxCrys = "";
     nHandle = 0;

     nOpcion = 0;
     nArchi = 0;
     nSwFirma = 0;
     &eaArGrpMin = "";  || Grupo archivo en caso de archivar desde minutacion
     &eaArSbGMin = "";  || Subgrupo archivo en caso de archivar desde minutacion
     &eaArTipMin = "";  || Tipo archivo en caso de archivar desde minutacion
     {-1}aMenu  = "";
         aMenu1 = "2400";
         aMenu2 = "1";
         aMenu3 = "";
         aMenu4 = "APSC";
         aMenu5 = "Archivar";
         aMenu6 = "Papel";
         aMenu7 = "S/Conf.Cli.";
         aMenu8 = "Cancelar";


     &enSwFactu = 0;
     &enTxtGaran = 0;
     &enTxtInter = 0;
     &enTxtNorma = 0;
     &enTxtSinca = 0;

     &eaSerie = "";
     &eaNumero = "";
     &Tempo = "";
     &sw_inf = 0;
     nCont = 0;
     informe = "conf0625";
|FIN;

|PROCESO con00614;
     sw_inf = 4;
     |PRINT;
|FPRC;

|DEFBUCLE con00614;
     #614#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, con00614;
|FIN;

|PROCESO imp_fra_l1;
     aAlfa = "_" + #10#10;
     aAlfa = eaTParte - aAlfa;
     |SI eaTParte ! "TodoS"; |Y FSalida = 0;
          |ACABA;
     |FINSI;

     #633#0 = #10#10;
     |LEE 000#633=;
     |SI FSalida = 0; |Y #633#3 = "S";
          |DDEFECTO #614;
          #614#0 = #633#0;
          |LEE 101#614=;
          |SI FSalida ! 0; |GRABA 020#614b; |FINSI;
          #614#1 = #633#1;
          #614#2 = #633#2;
          #614#3 = #614#3 + #10#8;
          |GRABA 020#614a;
          |LIBERA #614;
          |ACABA;
     |FINSI;

     #696#0 = #50#0;
     #696#1 = #50#1;
     #696#2 = #50#2;
     #696#5 = 1;
     |LEE 000#696]; || Anteriormente no existia el fichero
     |SI FSalida = 0; |Y #696#0 = #50#0; |Y #696#1 = #50#1; |Y #696#2 = #50#2;
          #696#0 = #50#0;
          #696#1 = #50#1;
          #696#2 = #50#2;
          #696#5 = #10#11;
          |LEE 000#696=;
          |SI FSalida ! 0; |ACABA; |FINSI;
     |FINSI;

     |ABRE #90;
     #90#0 = #10#21;
     |LEE 000#90=;
     |SI FSalida ! 0 ; |DDEFECTO #90; |FINSI;
     |CIERRA #90;

     |DDEFECTO #92;
     #92#0 = #90#4;
     #92#1 = #10#14;
     #92#3 = #10#5;
     #92#5 = #10#6;
     |LEE 001#92=;
     |SI FSalida ! 0 ; |GRABA 021#92b; |FINSI;
     #92#2 = #92#2 + #10#4;
     #92#4 = #92#4 + #10#8;
     |GRABA 001#92a;
     |LIBERA #92;
     |SI #10#14 = "S";
          enTotaSin = enTotaSin + #10#18;
     |FINSI;
|FPRC;

|PROCESO imp_fra_l2;
     aAlfa = "_" + #10#10;
     aAlfa = eaTParte - aAlfa;
     |SI eaTParte ! "TodoS"; |Y FSalida = 0;
          |ACABA;
     |FINSI;

     #633#0 = #10#10;
     |LEE 000#633=;
     |SI FSalida = 0; |Y #633#3 = "S";
          |DDEFECTO #614;
          #614#0 = #633#0;
          |LEE 101#614=;
          |SI FSalida ! 0; |GRABA 020#614b; |FINSI;
          #614#1 = #633#1;
          #614#2 = #633#2;
          #614#3 = #614#3 + #10#8;
          |GRABA 020#614a;
          |LIBERA #614;
          |ACABA;
     |FINSI;

     #696#0 = #50#0;
     #696#1 = #50#1;
     #696#2 = #50#2;
     #696#5 = 1;
     |LEE 000#696]; || Anteriormente no existia el fichero
     |SI FSalida = 0; |Y #696#0 = #50#0; |Y #696#1 = #50#1; |Y #696#2 = #50#2;
          #696#0 = #50#0;
          #696#1 = #50#1;
          #696#2 = #50#2;
          #696#5 = #10#11;
          |LEE 000#696=;
          |SI FSalida ! 0; |ACABA; |FINSI;
     |FINSI;
     |SI #10#14 = "S";
          enTotaSin = enTotaSin + #10#18;
     |FINSI;

     |PRINT;
|FPRC;

|DEFBUCLE imp_fra_lin1;
     #10#1;
     ;
     #50#3 , #50#4 , 0001;
     #50#3 , #50#4 , 0999;
     ;
     NULL , imp_fra_l1;
|FIN;

|DEFBUCLE imp_fra_lin2;
     #10#1;
     ;
     #50#3 , #50#4 , 0001;
     #50#3 , #50#4 , 0999;
     ;
     NULL , imp_fra_l2;
|FIN;

|DEFBUCLE imp_fra_lin3;
     #10#1;
     ;
     #50#3 , #50#4 , 1000;
     #50#3 , #50#4 , 9999;
     ;
     NULL , imp_fra_l2;
|FIN;

|PROCESO imp_texto_expli;
     |SI #60#4 = "G"; |Y enTxtGaran = 0; |ACABA; |FINSI;
     |SI #60#4 = "I"; |Y enTxtInter = 0; |ACABA; |FINSI;
     |SI #60#4 = "N"; |Y enTxtNorma = 0; |ACABA; |FINSI;
     |SI #60#4 = "S"; |Y enTxtSinca = 0; |ACABA; |FINSI;

     |PRINT;
|FPRC;

|DEFBUCLE lee_texto_expli;
     #60#1;
     ;
     #50#3 , #50#4 , 001;
     #50#3 , #50#4 , 999;
     ;
     NULL , imp_texto_expli;
|FIN;


|PROCESO imp_fra_res;
     |PRINT;
|FPRC;

|DEFBUCLE imp_fra_resu;
     #92#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL , imp_fra_res;
|FIN;

|PROCESO imp_or;
     enTotaSin = 0;
     |ABRE #1;
     #1#0 = #50#3;
     #1#1 = #50#4;
     |LEE 001#1=;
     |SI FSalida ! 0 ; |DDEFECTO #1; |FINSI;
     |LIBERA #1;
     |CIERRA #1;
     sw_inf = 8;
     |PRINT; || la primera linea de cada or, para sacar el n§ de or.
     |SI #1#18 ! "R";
          |HAZ CreaTempo; aTmp614 = Tempo; |NOME_DAT #614 aTmp614; |DELINDEX #614;
          |ABRET #614;
          |ABRE #633;
          |SI #83#9 = "I";
               sw_inf = 0; |BUCLE imp_fra_lin3;
          |FINSI;
          |SI #83#1 = "S";
               |HAZ CreaTempo; |NOME_DAT #92 Tempo; |DELINDEX #92;
               |ABRE #92;
               |BUCLE imp_fra_lin1;
               |CIERRA #92;
               sw_inf = 2;
               |BUCLE imp_fra_resu;
               |HAZ BoraTempo; |DELINDEX #92;
          |SINO;
               sw_inf = 0;
               |BUCLE imp_fra_lin2;
          |FINSI;
          |SI #83#9 = "S";
               sw_inf = 0; |BUCLE imp_fra_lin3;
          |FINSI;
          |BUCLE con00614;
          |CIERRA #633;
          |CIERRAT #614;
          Tempo = aTmp614; |HAZ BoraTempo; |DELINDEX #614;
     |FINSI;
     sw_inf = 3;
     |BUCLE lee_texto_expli;
     sw_inf = 0;
|FPRC;

|DEFBUCLE lee_lin_fra;
     #50#1;
     10;
     #0#0 , #0#1 , 01, "O";
     #0#0 , #0#1 , 99, "O";
     ;
     NULL , imp_or;
|FIN;

|PROCESO ImpAlb;
     sw_inf = 10;
     |PRINT;
|FPRC;

|PROCESO LinFraAlb;
     #100#52 = #50#3;
     #100#0 = #50#4;
     |LEE 000#100=;
     |SI FSalida = 0;
          sw_inf = 9; |PRINT;
          |BUCLELIN 2ImpAlb#100;
     |FINSI;
|FPRC;

|DEFBUCLE LinFraAlb;
     #50#1;
     10;
     #0#0 , #0#1 , 01, "A";
     #0#0 , #0#1 , 99, "A";
     ;
     NULL , LinFraAlb;
|FIN;

|PROCESO imprime;
     ||ARA

     |SI nArchi = 1;
            |SI nOpcion = 1;
                 |HAZ FirmaFactura;
                 |HAZ EmulaImpresa;
                 |ACABA;
            |FINSI;

            |SI nOpcion = 3;
                 |ABRE #30;
                 #30#0 = #con00637#3;
                 |LEE 000#30=;
                 |SI FSalida ! 0;
                      |DDEFECTO #30;
                 |FINSI;
                 |CIERRA #30;

                 |SI #30#212 = "S";
                      |HAZ FirmaFactura;
                      |HAZ EmulaImpresa;
                      |ACABA;
                 |FINSI;
            |FINSI;
     |FINSI;

     |HAZ Imprime;
|FPRC;

|PROCESO Imprime;
     #21#0 = #0#0;
     |LEE 010#21=;
     |SI FSalida = 0;
          informe = #21#2;    |QBF informe;
     |SINO;
          informe = "conf0625";
     |FINSI;
     |LIBERA #21;
     |INFOR informe;
     |SI FSalida = 0;
          #0#12 = "S";
          |GRABA 010#0a;
          |ABRE #83;
          |DDEFECTO #83;
          |LEE 000#83];
          |SI FSalida ! 0 ; |DDEFECTO #83; |FINSI;
          |LIBERA #83;
          |CIERRA #83;
          |ABRE #85;
          |ABRE #30;
          |ABRE #696;
          |ABRE #100;
          #85#0 = #0#14;
          #85#1 = #0#15;
          |LEE 001#85=;
          #30#0 = #0#3;
          |LEE 001#30=;
          |SI #30#44 = 0; #30#44 = 1; |FINSI;
          |PARA nCont = 1; |SI nCont [ #30#44; |HACIENDO nCont = nCont + 1;
               |BUCLE lee_lin_fra;
               |BUCLE LinFraAlb;
               |PIEINF;
          |SIGUE;
          |CIERRA #100;
          |CIERRA #696;
          |CIERRA #30;
          |CIERRA #85;
     |FINSI;
     |FININF;
|FPRC;

|DEFBUCLE lee_fras_nimp;
     #0#1;
     2,12;
     #20#0 , #20#2 , #20#4 , "N";
     #20#1 , #20#3 , #20#5 , "N";
     ;
     NULL , imprime;
|FIN;


|DEFBUCLE lee_fras;
     #0#1;
     2;
     #20#0 , #20#2 , #20#4 ;
     #20#1 , #20#3 , #20#5 ;
     ;
     NULL , imprime;
|FIN;

|PROCESO tipo3; |TIPO 3;
     |HAZ TallerDeci;
     |SI #20#6 = "S";
          enSwFactu = 2;
          |HAZ SelecTexto;

          |SI nArchi = 1;
               |HAZ LeeSelImpFactuE;
               aMenu2 = eaSelFactuE;

               nOpcion = 0;
               |MENU aMenu;
               |SI FSalida < 1; |O FSalida > 3; |ACABA; |FINSI;
               nOpcion = FSalida;

               eaSelFactuE = nOpcion;
               |HAZ GrabaSelImpFactuE;
          |FINSI;

          |SI nArchi = 1; |Y nOpcion = 1;
               nSalida = 0;
          |SINO;
               |IMPRE 0;
               nSalida = FSalida;
          |FINSI;
          |SI nSalida = 0;
               |ABRE #21;
               |SI #20#7 = "S";
                    |BUCLE lee_fras;
               |SINO;
                    |BUCLE lee_fras_nimp;   ||solo las no impresas
               |FINSI;
               |CIERRA #21;
               |SI nArchi = 1; |Y nOpcion = 1;
                    ||No pide impresora. SOLO ARCHIVO
               |SINO;
                    |FINIMP;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO FirmaFactura;
     |SI nSwGenerarPDF = 1;
          |ESPECIFICA "RBASS", aPuntero; aRDirBass = aPuntero; |QBF aRDirBass;
          aFicheroPDF = aRDirBass + "crystal/facturae" + Usuario;
          |QBF aFicheroPDF;
          aFicheroPDF = aFicheroPDF + ".pdf";

          aBorra = aFicheroPDF;
          |RFBORRA aBorra;

          aAlfa = "CrystalReport;" + aFicheroPDF;
          Impresora = aAlfa;
          |IMPRE -1;
          |SI FSalida = 0;
               |ABRE #21;
               |HAZ Imprime;
               |CIERRA #21;

               |XABRE "CE", aFicheroPDF, nHandlePDF;
               |SI FSalida < 0;
                    nSwHayPDF = 0;
               |SINO;
                    nSwHayPDF = 1;
               |FINSI;
               |FINIMP;
          |FINSI;
     |FINSI;
     ||ARA
     eaArCodCli = #con00637#3;  || Codigo Cliente

     |ABRE #30;
     #30#0 = #con00637#3;
     |LEE 000#30=;
     |SI FSalida ! 0;
          |DDEFECTO #30;
     |FINSI;
     |CIERRA #30;

     eaArNomCli = #30#1;  || Nombre Cliente
     eaArCodCif = #30#15;  || Cif
     eaArNomCif = #30#1;  || Nombre Cif

     eaArTipoDoc = "OR";
     eaArSerDoc = #con00637#0;
     enArNumDoc = #con00637#1;
     eaArFecDoc = #con00637#2;

     eaDirDesFE = #30#197;
     eaFirmarFE = #30#212;
     eaSwEnvioCorreo = #30#213;
     eaAplicacion = "dscomer9";
     eaDefFE = "con00637";
     eaEmpresaFE = ("00000" + #48#0) % -105;
     eaSerieFE = #con00637#0;
     eaNumeroFE = #con00637#1;
     eaDefLinFe = "con00696";
     eaDefEmpFe = "agifa280";
     eaDefCliFe = "agifa024";
     eaDefIvaFe = "agifa066";
     eaCodCliFe = #con00637#3;
     eaDefAlbFe = "con00626";
     eaDefAAPPFe = "agifa281";

     |HAZ EsTallerSC;
     |SI FSalida = 0;
          eaModuloFE = "tallerSC";
          eaMatriculaFE = #con00637#5;
          |QBF eaMatriculaFE;
     |FINSI;
     eaDefEmpSerieFe = "agifa284";

     |SI nSwHayPDF = 1;
          eaFacturaPDFFe = aFicheroPDF;
     |FINSI;

     |SUB_EJECUTA ":dsarchi/dsarz011.tab";
|FPRC;

|PROCESO EmulaImpresa;
     #0#12 = "S";
     |GRABA 010#0a;
|FPRC;

|PROGRAMA;
     ||FE
     nArchi = 0;
     nSwFirma = 0;

     |HAZ EsArchi;
     |SI FSalida = 0;
        |DBASS aAlfa; |QBF aAlfa;
        aAlfa = aAlfa + "dsarchi/def/dsarm001.mas";
        |CARGA_DEF aAlfa, Ref0001@;
        |SI FSalida = 0;
           ||Configuracion de Factura_E por empresa
           nHayConfEmp = 0;
           |DBASS aAlfa; |QBF aAlfa;
           aAlfa = aAlfa + "dsarchi/def/dsarm057.mas";
           |CARGA_DEF aAlfa, Ref0002@;
           |SI FSalida = 0;
                |DBASS aAlfa; |QBF aAlfa;
                aAlfa = aAlfa + "dsarchi/fich/"; |PATH_DAT #2000 aAlfa;
                nEmpresa = #48#0;
                |ABRE #Ref0002@;
                #Ref0002@#0 = nEmpresa;
                |LEE 000#Ref0002@.=;
                |SI FSalida = 0;
                     nHayConfEmp = 1;
                     |SI #Ref0002@#6 = "S";
                         nSwGenerarPDF = 1;
                     |SINO;
                         nSwGenerarPDF = 0;
                     |FINSI;
                |FINSI;
                |CIERRA #Ref0002@; |DESCARGA_DEF #Ref0002@;
           |FINSI;


           |DBASS aAlfa; |QBF aAlfa;
           aAlfa = aAlfa + "dsarchi/fich/"; |PATH_DAT #Ref0001@#aAlfa#;
           |ABRE #Ref0001@;
           |DDEFECTO #Ref0001@;
           |LEE 000#Ref0001@.p;
           |SI FSalida ! 0; |DDEFECTO #Ref0001@; |FINSI;

           |SI #Ref0001@#31 = "S";
              nArchi = 1;
              eaArGrpMin = #Ref0001@#34;
              eaArSbGMin = #Ref0001@#35;
              eaArTipMin = #Ref0001@#36;
              |SI #Ref0001@#32 = "S";
                   nSwFirma = 1;
              |FINSI;
           |SINO;
              eaArGrpMin = "";
              eaArSbGMin = "";
              eaArTipMin = "";
           |FINSI;
           |SI nHayConfEmp = 0;
                |SI #Ref0001@#164 = "S";
                    nSwGenerarPDF = 1;
                |SINO;
                    nSwGenerarPDF = 0;
                |FINSI;
           |FINSI;

           |CIERRA #Ref0001@; |DESCARGA_DEF #Ref0001@;
        |FINSI;
     |FINSI;

     |SI eaSerie = "";
          |MANTE #20;
     |SINO;
          |ABRE #0;
          #0#0 = eaSerie;
          #0#1 = eaNumero;
          |LEE 121#0=;
          |SI FSalida = 0;
               enSwFactu = 1;
               |HAZ SelecTexto;

               |SI nArchi = 1;
                    |HAZ LeeSelImpFactuE;
                    aMenu2 = eaSelFactuE;

                    nOpcion = 0;
                    |MENU aMenu;
                    |SI FSalida < 1; |O FSalida > 3; |ACABA; |FINSI;
                    nOpcion = FSalida;

                    eaSelFactuE = nOpcion;
                    |HAZ GrabaSelImpFactuE;

                    |SI nOpcion = 3;
                         |ABRE #30;
                         #30#0 = #con00637#3;
                         |LEE 000#30=;
                         |SI FSalida ! 0;
                              |DDEFECTO #30;
                         |FINSI;
                         |SI #30#212 = "S";
                              nOpcion = 1;
                         |SINO;
                              nOpcion = 2;
                         |FINSI;
                         ||ARA55
                         |CIERRA #30;
                    |FINSI;
               |FINSI;

               |SI nArchi = 1; |Y nOpcion = 1;
                    |HAZ FirmaFactura;
                    |HAZ EmulaImpresa;
                    |ACABA;
               |FINSI;

               |IMPRE 0;
               |SI FSalida = 0;
                    |ABRE #21;
                    |HAZ imprime;
                    |CIERRA #21;
                    |FINIMP;
               |FINSI;
          |FINSI;
          |CIERRA #0;
     |FINSI;
|FPRO;
