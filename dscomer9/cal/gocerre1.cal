          CreaFactura, BorraFactura

|FICHEROS;
     gocerrec #1,MANTE;
     gocerrel #2,MANTE;
     agifa019 #19;
     agifa024 #24;
     agifa025 #25;
     agifa066 #66;
     agifa069 #69;
     agifa084 #84;
     agifa091 #91;
     agifa142 #142;
     agifa321 #321;
     agifa324 #324;
|FIN;

|VARIABLES;
     aAlfa = "";
     &serie = "";
     &numero = 0;
     &enErrCarte = 0;
     &enError = 0;
     &enCoste = 0;
     &enForma = 0;
     &enImpCliCom = 0;
     &enImpCliDto = 0;
     &enImpCliFac = 0;
     &enImpCliMar = 0;
     &eaCliente = "";
     &eaArticulo = "";
     &efFecha = @;
     &enImpRepComi = 0;
     &enImpRepVta = 0;
     &enImpRepRete = 0;
     &eaRepre = "";
     &enImpVta = 0;
     &enImpMar = 0;
     &eaProg = "";

     retencion = 0;
     imneto = 0;
     fmes = "";
     mes = 0;
     nImpo = 0;
     nDto = 0;
     nMargen = 0;
     nForma = 0;
|FIN;

|PROCESO ActArti;
     |ABRE #19;
     fmes = #84#1 % A402;
     mes = fmes - 1;
     mes = mes * 5;
     mes = mes + 35;
     #19#0 = #69#2;
     |LEE 121#19=;
     |SI FSalida = 0;
          |SI #19#194 = 2;
               nImpo = ((((#69#30 * #69#6) < #69#8) < #69#21) < #84#5) < #84#32;
          |SINO;
               nImpo = ((((#69#5 * #69#6) < #69#8) < #69#21) < #84#5) < #84#32;
          |FINSI;

          |SI #142#115 = "S";
               nImpo = nImpo < #84#7;
          |FINSI;

          nMargen = nImpo - #69#14;
          #19mes = #19mes + (nImpo * nForma);
          #19#95 = #19#95 + (nImpo * nForma);
          mes = mes + 1;
          #19mes = #19mes + (nMargen * nForma);
          #19#96 = #19#96 + (nMargen * nForma);
          |GRABA 020#19a;

          efFecha = #84#1;
          eaArticulo = #69#2;
          enImpVta = (nImpo * nForma);
          enImpMar = (nMargen * nForma);
          |HAZ AcumulaArt;
     |FINSI;
     |CIERRA #19;
|FPRC;

|PROCESO ActCliente;
     |ABRE #24;
     #24#0 = #84#3;
     |LEE 121#24=;
     |SI FSalida = 0;
          fmes = #84#1 % A402;
          mes = fmes - 1;
          mes = mes * 4;
          mes = mes + 54;
          imneto = #84#15 - #84#25;

          |SI #142#115 = "N";
               nImpo = (imneto * 100) / (100 - #84#7);
               nDto = #84#25 + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
               nDto = #84#25;
          |FINSI;
          #24mes = #24mes + (nImpo * nForma);
          mes = mes + 1;
          #24mes = #24mes + (nDto * nForma);
          mes = mes + 1;
          #24mes = #24mes + (#84#37 * nForma);
          #24#102 = #24#102 + (nImpo * nForma);
          #24#103 = #24#103 + (nDto * nForma);
          #24#104 = #24#104 + (#84#37 * nForma);
          #24#45 = #84#1;
          #24#46 = imneto;
          #24#110 = #24#110 + (imneto * nForma);
          imneto = imneto + #84#24;
          |GRABA 020#24a;

          enImpCliCom = nImpo * nForma;
          enImpCliDto = nDto * nForma;
          enImpCliFac = imneto * nForma;
          enImpCliMar = #84#37 * nForma;
          eaCliente = #84#3;
          efFecha = #84#1;
          |HAZ AcumulaCli;
     |FINSI;
     |CIERRA #24;

     |ABRE #25;
     #25#0 = #84#6;
     |LEE 121#25=;
     |SI FSalida = 0;
          imneto = #84#15 - #84#25;
          fmes = #84#1 % A402;
          mes = fmes - 1;
          mes = mes * 2;
          mes = mes + 11;
          #25mes = #25mes + (#84#26 * nForma);
          retencion = #25mes % #25#39;
          mes = mes + 1;
          #25mes = #25mes + (imneto * nForma);
          #25#35 = #25#35 + (#84#26 * nForma);
          #25#36 = #25#36 + (imneto * nForma);
          mes = fmes - 1;
          mes = mes + 40;
          #25mes = retencion;
          retencion = #25#35 % #25#39;
          #25#52 = retencion;
          |GRABA 020#25a;

          enImpRepComi = #84#26;
          enImpRepVta = imneto;
          enImpRepRete = retencion;
          eaRepre = #84#6;
          efFecha = #84#1;
          |HAZ AcumulaRep;
     |FINSI;
     |CIERRA #25;
|FPRC;

|PROCESO gocerrel;
     |ABRE #19;
     #19#0 = #2#4;
     |LEE 020#19=;
     |CIERRA #19;

     |DDEFECTO #69;
     #69#20 = #84#48;
     #69#0 = #84#0;
     #69#1 = #2#3;
     #69#2 = #2#4;
     #69#3 = 1;
     #69#4 = #2#5;
     #69#5 = #2#6;
     #69#6 = #2#7
     #69#7 = #69#5 * #69#6;
     #69#8 = #2#8;
     #69#11 = #1#10;
     #69#13 = #19#2;
     #69#15 = #84#3;
     #69#16 = #84#34;
     #69#17 = #84#35;
     #69#26 = #69#6;

     |HAZ TotalLin69;
     enForma = 1;
     |HAZ AcumulaFC;
     #69#14 = enCoste;
     imneto = ((((#69#9  < #84#5) < #84#32) < #84#7));
     #84#37 = #84#37 + (imneto - enCoste);
     |HAZ CalCabAgifa084;
     |GRABA 020#69n;

     nForma = 1;
     |HAZ ActArti;
|FPRC;

|DEFBUCLE gocerrel;
     #2#1;
     ;
     #1#0, #1#1, #1#2, 001;
     #1#0, #1#1, #1#2, 999;
     ;
     NULL, gocerrel;
|FIN;

|PROCESO CreaFactura;
     |ABRE #321; |LEE 000#321p; |CIERRA #321;

     |ABRE #24;
     #24#0 = #1#9;
     |LEE 020#24=;
     |CIERRA #24;

     |ABRE #66;
     #66#0 = #1#10;
     |LEE 000#66=;
     |CIERRA #66;

     |ABRE #91;
     #91#0 = #1#11;
     |LEE 000#91=;
     |CIERRA #91;

     |ABRE #25;
     #25#0 = #1#12;
     |LEE 000#25=;
     |CIERRA #25;

     #84#1 = #1#13;
     #84#3 = #1#9;
     #84#4 = #24#1;
     #84#5 = #24#37;
     #84#6 = #1#12;
     #84#7 = #24#38;
     #84#8 = #1#11;
     #84#9 = #24#35;
     #84#29 = #24#1;
     #84#30 = #24#8;
     #84#31 = #24#9;
     #84#32 = #24#156;
     #84#33 = #24#10;
     #84#34 = #25#7;
     #84#35 = #24#4;
     #84#36 = #24#47;
     #84#40 = #24#16;
     #84#60 = #24#15;
     #84#64 = #24#183;
     #84#65 = #24#192;

     |DDEFECTO #324;
     #324#0 = #84#65;
     |LEE 000#324=;

     #84#66 = #324#2;
     #84#67 = #24#193;
     #84#68 = #321#9;

     |DDEFECTO #324;
     #324#0 = #84#65;
     |LEE 000#324=;

     #84#69 = #324#2;
     #84#78 = #24#202;
     aAlfa = #1#3 + "/" + #1#4;
     #84#87 = aAlfa;
     #84#88 = #24#22;
     #84#89 = #24#23;
     #84#90 = #24#24;

     |ABRE #69;
     |ABRE #324;
     |BUCLE gocerrel;
     |CIERRA #324;
     |CIERRA #69;

     |GRABA 020#84a;
     |LIBERA #84;

     nForma = 1;
     |HAZ ActCliente;
     |SI #142#47 = "S";
          |HAZ VenciDir;
     |FINSI;

     |CONFI "0000N¿Imprimir factura ?";
     |SI FSalida = 0;
          serie = #84#48;
          numero = #84#0;
          |SUB_EJECUTA_NP "agifa086";
     |FINSI;
|FPRCO;

|PROCESO BorraLin;
     enForma = -1;
     |HAZ AcumulaFC;
     |BORRA 020#69a;
|FPRC;

|PROCESO BorraFactura;
     |ABRE #84;
     #84#48 = #1#14;
     #84#0 = #1#15;
     |LEE 121#84=;
     |SI FSalida = 0;
          |SI #84#39 = "S";
               |CONFI "0000NFactura contabilizada: Desea continuar";
               |SI FSalida ! 0;
                    enError = 1; |ACABA;
               |FINSI;
          |FINSI;
          |SI #142#47 = "S"; |Y #84#10 = "S";
               |CONFI "0000NDesea dejar la factura como NO impresa y anular los recibos";
               |SI FSalida ! 0;
                    enError = 1; |ACABA;
               |FINSI;
               eaProg = "agifa084"; |PULSATECLA;
               |HAZ MiraRecVenta;
               |SI enErrCarte ! 0;
                    |MENAV "0000Recibos con movimientos: NO SE DARA DE BAJA";
                    enError = 1; |ACABA;
               |FINSI;
               eaProg = "agifa084";
               |HAZ BorraRecVenta;
          |FINSI;
          |HAZ BorraVenciDir;

          nForma = -1;
          |HAZ ActCliente;

          |BUCLELIN 0 BorraLin #84;
          |BORRA 020#84a;
     |FINSI;
     |CIERRA #84;
|FPRC;
