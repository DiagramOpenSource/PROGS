|FICHEROS;
     agifa109 #0;
     agifa048 #1;
     agifa049 #2;
     agifa019 #3;
     agifa142 #4;
     agifa046 #46;
     agifa017 #17;
     agifa324 #324;
     agifa321 #321;
     referen@;
     dsm00241 #241;
     dsm00238 #238;
|FIN;

|VARIABLES;
     &enCosteOrts = 0;
     nSwRodacal = 0;
     nSwOrts = 0;
     nUni = 0;
     nFactor = 0;
     aAlfa1 = "";
     aAlfa2 = "";
     nTotal = 0;
     aDef = "";
     &nDeci_EsCab   = 0;
     &nDeci_EsLin   = 0;

     &aModulo       = "agifa109";
     &aEscanOri     = "";
     &aEscanFin     = "";

     aEscanNuevo    = "";
     aTmp           = "";

     {100}PnImporte = 0;
     {100}PnImpor_1 = 0;
     {100}PnImpor_2 = 0;
     {100}PnImpor_3 = 0;
     {100}PnImpor_4 = 0;

     nEscanLin      = 0;
     nContador      = 0;
     nPasada        = 0;
     nImporte       = 0;
     nImpor_1       = 0;
     nImpor_2       = 0;
     nImpor_3       = 0;
     nImpor_4       = 0;
     coste          = 0;
|FIN;

|CAMPOS;
     #3#17  art_pval;  #17#4   alm_pval;
     #3#10  art_vsto;  #17#3   alm_vsto;
     #3#6   art_tota;  #17#5   alm_tota;
     #3#9   art_pcm;
|FIN;

|INCLUYE escand_i;

|PROCESO MiraInc; |TIPO 0;
     |HAZ LeeParam;
     |SI #4#60 ! 1; |Y #0#1 = "S";
          |MENAV "0000La Empresa NO esta configurada para incrementos sobre el PCM";
          #0#1 = "N";
          |PINTA #0#1;
     |FINSI;
|FPRC;

|PROCESO LeeParam;
     |ABRE #4;
     |LEE 001#4=;
     |CIERRA #4;
|FPRC;

|PROCESO tipo3; |TIPO 3;
     |HAZ EsRodacal; nSwRodacal = FSalida;
     |HAZ EsOrts; nSwOrts = FSalida;

     |HAZ Decimal;
     |SI #0#3 = "SI";
          |DDEF aDef;
          aDef = aDef + "agifa048";
          |CARGA_DEF aDef, referen@;
          |SI FSalida ! 0;
               |MENAV "0000Error al cargar def...";
               |ACABA;
          |FINSI;
          |ABRE #referen@;

          aEscanOri = #0#5;
          aEscanFin = #0#6;

          |SI #0#0 = "S";
               |ATRI P;
               |MENSA "0000Comprobando Escandallos";
               |ATRI p;
               |SUB_EJECUTA_NP "agifa042.tab";
          |SINO;
               nError = 0;
          |FINSI;
          |SI nError = 0;
               |HAZ LeeParam;
               |ABRE #1;
               |ABRE #2;
               |ABRE #3;

               |ATRI P;
               |MENSA "0000Actualizando Precios de Coste";
               |ATRI p;
               nContador = 0;

               |PINTA 1932 , "            ";
               IPnImporte = PnImporte1<-;
               IPnImpor_1 = PnImpor_11<-;
               IPnImpor_2 = PnImpor_21<-;
               IPnImpor_3 = PnImpor_31<-;
               IPnImpor_4 = PnImpor_41<-;

               |HAZ Pasada;

               |CIERRA #1;
               |CIERRA #2;
               |CIERRA #3;
          |FINSI;

          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO PcmVenta;
     #3#0 = #1#0;
     |LEE 121#3=;
     |SI FSalida = 0;
          #3#9 = #1#9;
          art_vsto = art_tota - art_pval;
          |SI art_vsto > 0;
               art_vsto = art_vsto * art_pcm;
          |SINO;
               art_vsto = 0;
          |FINSI;
          |SI #0#1 = "S";
               |HAZ CalPre109;
          |FINSI;
          |GRABA 020#3a;
          |LIBERA #3;
          |ABRE #17;
          #17#0 = #3#0;
          #17#1 = 0;
          |LEE 101#17];
          |PARA; |SI FSalida = 0; |Y #17#0 = #3#0; |HACIENDO;
               alm_vsto = alm_tota - alm_pval;
               |SI alm_vsto > 0;
                    alm_vsto = alm_vsto * art_pcm;
               |SINO;
                    alm_vsto = 0;
               |FINSI;
               #17#50 = #17#42 + #17#6 - #17#43 - #17#39; || necesidades
               #17#50 = #17#50 - #17#4 - #17#9 - #17#8;
               |GRABA 020#17a;
               |LIBERA #17;
               |LEE 101#17s;
          |SIGUE;
          |CIERRA #17;
     |FINSI;
|FPRC;

|PROCESO Pasada;
     #1#0 = #0#5;
     |LEE 000#1];
     |PARA; |SI FSalida = 0; |Y #1#0 [ #0#6; |HACIENDO ;
          aEscanOri = #1#0; |QBF aEscanOri; || no  quitar el QBF !!!

          |SI nSwOrts = 0;
               |HAZ BorHerrajeCanteado;
          |FINSI;

          nError = 0;
          |HAZ InicioEscan;
          #1#0 = aEscanOri;
          |LEE 101#1=;
          |SI FSalida = 0;
               enCosteOrts = 0;
               |SI nSwOrts = 0;
                     |HAZ GraHerrajeCanteado;
                     |HAZ GraPesoArti;
               |FINSI;
               #1#8 = nImpor_1;
               #1#2 = nImpor_2;
               #1#3 = nImpor_3;
               #1#4 = nImpor_4 + enCosteOrts;
               coste = #1#2 + #1#3 + #1#4;
               #1#5  = coste ;
               coste = coste + #1#8;
               coste = coste > #1#7;
               #1#11 = coste;
               #1#11 = #1#11 > #1#34;
               #1#9 = #1#11 / #1#12;
               |SI nSwRodacal = 0;
                    #1#9 = #1#11 * #1#12;
               |FINSI;

               |GRABA 021#1a;
               |SI #1#15 = "S";
                    |HAZ PcmVenta;
               |FINSI;
          |FINSI;
          |LIBERA #1;
          nImporte = 0;
          nImpor_1 = 0;
          nImpor_2 = 0;
          nImpor_3 = 0;
          nImpor_4 = 0;
          |LEE 000#1=;
          |LEE 000#1s;
     |SIGUE;
|FPRC;

|PROCESO Decimal;
     |ABRE #46; |LEE 000#46p; |CIERRA #46;
     nDeci_EsCab = #46#15;
     nDeci_EsLin = #46#16;
|FPRC;

|PROCESO EscanLinea;
     |HAZ Decimal;

     nContador = nContador + 1;
     |PINTA 1932 , nContador;

          ||Si el articulo es de los que hay que cambiar
          |LEE 101#2=;
          |SI FSalida = 0;
               |DDEFECTO #3;
               #3#0 = #2#2;
               |LEE 001#3=;
               |SI FSalida = 0;
                    |SI #0#4 = 1; |Y #3#9 ! 0;
                         #2#5 = #3#9;                  ||PCM Linea Escan
                         |HAZ SacaFactor;
                         #2#15 = #2#5 / nFactor;
                    |FINSI;
                    |SI #0#4 = 2; |Y #3#28 ! 0;
                         #referen@#0 = #2#2;
                         |LEE 000#referen@.=;
                         |SI FSalida = 0;
                              #2#5 = #3#9;             ||PCM Linea Escan
                         |SINO;
                              #2#5 = #3#28;            || Ult Compra
                         |FINSI;
                         |HAZ SacaFactor;
                         #2#15 = #2#5 / nFactor;
                    |FINSI;
                    |SI #0#4 = 3; |Y #3#133 ! 0;
                         #2#5 = #3#133;                || Ult Compra Dto
                         |HAZ SacaFactor;
                         #2#15 = #2#5 / nFactor;
                    |FINSI;
               |FINSI;

               |SI #3#179 = "S";   ||Doble stock
                    |ABRE #238;
                    #238#0 = #3#201;
                    |LEE 000#238=;
                    |SI FSalida = 0; |Y #238#6 = 2;    || Factura uni2
                         nUni = #2#17;
                    |FINSI;
                    |CIERRA #238;
               |SINO;
                    nUni = #2#4;
               |FINSI;

               |SI #2#16 = "D";
                    nTotal = (nUni * #2#5) > #2#13;
               |SINO;
                    nTotal = (nUni * #2#5) / ((100 - #2#13) / 100);
               |FINSI;
               #2#6 = nTotal;
               |GRABA 021#2a;
          |FINSI;
          |LIBERA #2;
          |SI #2#10 = 1; nImpor_1 = nImpor_1 + #2#6; |FINSI;
          |SI #2#10 = 2; nImpor_2 = nImpor_2 + #2#6; |FINSI;
          |SI #2#10 = 3; nImpor_3 = nImpor_3 + #2#6; |FINSI;
          |SI #2#10 = 4; nImpor_4 = nImpor_4 + #2#6; |FINSI;
          nImporte = nImporte + #2#6;
|FPRC;

|PROCESO EntrarPuntero;
     #0#2 = #2#0;
     |PINTA #0#2;
     PnImporte = nImporte;
     IPnImporte = IPnImporte + 1;
     PnImpor_1 = nImpor_1;
     IPnImpor_1 = IPnImpor_1 + 1;
     PnImpor_2 = nImpor_2;
     IPnImpor_2 = IPnImpor_2 + 1;
     PnImpor_3 = nImpor_3;
     IPnImpor_3 = IPnImpor_3 + 1;
     PnImpor_4 = nImpor_4;
     IPnImpor_4 = IPnImpor_4 + 1;

     nImporte = 0;
     nImpor_1 = 0;
     nImpor_2 = 0;
     nImpor_3 = 0;
     nImpor_4 = 0;
|FPRC;

|PROCESO SacarPuntero;
     IPnImporte = IPnImporte - 1;
     IPnImpor_1 = IPnImpor_1 - 1;
     IPnImpor_2 = IPnImpor_2 - 1;
     IPnImpor_3 = IPnImpor_3 - 1;
     IPnImpor_4 = IPnImpor_4 - 1;
     #2#0 = aEscan;
     #2#1 = nLinea;
     |LEE 101#2=;
     |SI FSalida = 0;
          #2#5 = nImporte;

          |SALVA_FICHA #3;
          #3#0 = aEscan;
          |LEE 000#3=;
          |HAZ SacaFactor;
          #2#15 = #2#5 / nFactor;
          |REPON_FICHA #3;


     ||     #2#6 = #2#4 * nImporte;
          |SI #2#16 = "D";
               nTotal = (#2#4 * #2#5) > #2#13;
          |SINO;
               nTotal = (#2#4 * #2#5) / ((100 - #2#13) / 100);
          |FINSI;
          #2#6 = nTotal;
          |GRABA 021#2a;
     |FINSI;
     |LIBERA #2;
     #1#0 = #2#2;
     |LEE 101#1=;
     |SI FSalida = 0;
         #1#8 = nImpor_1;
         #1#2 = nImpor_2;
         #1#3 = nImpor_3;
         #1#4 = nImpor_4;
         coste = #1#2 + #1#3 + #1#4;
         #1#5  = coste ;
         coste = coste + #1#8;
         coste = coste > #1#7;
     ||    #1#9  = coste;
         #1#11 = coste;
         #1#11 = #1#11 > #1#34;
         #1#9 = #1#11 / #1#12;
         |SI nSwRodacal = 0;
               #1#9 = #1#11 * #1#12;
         |FINSI;
         |GRABA 021#1a;
      |FINSI;
      |LIBERA #1;
     nImpor_1 = PnImpor_1;
     nImpor_2 = PnImpor_2;
     nImpor_3 = PnImpor_3;
     nImpor_4 = PnImpor_4;
     nImporte =  #2#6 + PnImporte;
     |SI #2#10 = 1; nImpor_1 = nImpor_1 + #2#6; |FINSI;
     |SI #2#10 = 2; nImpor_2 = nImpor_2 + #2#6; |FINSI;
     |SI #2#10 = 3; nImpor_3 = nImpor_3 + #2#6; |FINSI;
     |SI #2#10 = 4; nImpor_4 = nImpor_4 + #2#6; |FINSI;
|FPRC;

|PROCESO SacaFactor;
     |SI #3#204 = "S";
          |DDEFECTO #241;
          |ABRE #241; |SELECT #2#241;
          #241#0 = #3#5;
          #241#2 = #2#14;
          |LEE 000#241=;
          |CIERRA #241;
          |SI #241#6 = "D";
               nFactor = 1 / #241#5;
          |SINO;
               nFactor = 1 * #241#5;
          |FINSI;
     |SINO;
          nFactor = 1;
     |FINSI;
|FPRC;
