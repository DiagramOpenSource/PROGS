|FICHEROS;
     ialbm004 #0;
     ialbm005 #1;
     dsm00003 #3,MANTE;
     ialbm006 #6;
     agifa007 #7;
     agifa010 #10;
     agifa019 #19;
     agifa024 #24;
     agifa025 #25;
     agifa071 #71;
     agifa142 #142;
     agifa321 #321;
     agifa324 #324;
|FIN;

|VARIABLES;
     nTota = 0;
     nNume = 0;
     nSw = 0;
     &aDivisa = "";
     &aMoneda = "";
     nForma = 0;
     nError = 0;
     nModo = 0;
     nLin = 0;
     nModoCab = 0;
     importe = 0;
     cant = 0;
     &eaTag = "";
     nCopiaAnt = 0;
     nUni = 0;
     nPrecio = 0;

     &uni_dt = 0;   || Unidades
     &fed_dt = @;   || Fecha....
     &art_dt = "";  || Articulo.
     &cli_dt = "";  || Cliente..
     &fam_dt = "";  || Familia.
     &iva_dt = 0;   || Tipo Iva.
     &dtos_2 = 0;   || Descuento 2.
     &dto_pt = 0;   || Descuento Ptas.
     &dtos_1 = 0;   || Descuento 1.
     &pvp_ve = 0;   || Precio Venta.
     &tarifa = 0;   || Tarifa Cliente.
     &quedto = 0;   || 1=cli./art, 2=cli./familia, 3=cli./subfam.
     &gru_dt = "";  || Grupo Cliente.
     &nPromo = 0;
     &enDescuento1 = 0;
     &enDescuento2 = 0;
     &eaTComision  = "";
     &enComision   = 0;
     &enMensaje = 0;
     ||&eaSerie = "";
     ||&eaArticulo = "";
     ||&eaRepre = "";
     ||&enDirEnt = 0;
     ||&enAlmacen = 0;
|FIN;

|INCLUYE i_varart;

|PROCESO DtoComi;
     fed_dt = #10#1;   || Fecha....
     art_dt = #71#2;   || Articulo.
     cli_dt = #71#15;  || Cliente..
     fam_dt = #71#13;  || Familia.
     iva_dt = #71#11;  || Tipo Iva.
     dtos_2 = 0;      || Descuento 2.
     dto_pt = 0;      || Descuento Ptas.
     dtos_1 = 0;      || Descuento 1.
     pvp_ve = 0;      || Precio Venta.
     tarifa = #24#39;  || Tarifa Cliente....
     gru_dt = #24#158; || Grupo Cliente.
     nPromo = #10#89;
     |SI #71#35 ! 0;
          uni_dt = #71#35;
     |SINO;
          uni_dt = #71#5;
     |FINSI;
     enMensaje = 0;
     eaSerie = #71#29;
     enDirEnt = #10#84;
     enAlmacen = #71#3;

     |HAZ calcdtos;              || Calculo Dtos.....
||     #71#6   = pvp_ve - dto_pt;   || Precio Venta. sin iva.
     #71#8   = dtos_1;            || 1¦ Dto.
     #71#33  = dtos_2;            || 2§ Dto.

     enDescuento1 = #71#8;
     enDescuento2 = #71#33;
     eaTComision  = #71#16;
     eaCliente    = #10#3;
     eaArticulo   = #71#2;
     eaRepre      = #10#6;
     efFecha      = #10#1;
     enDirEnt = #10#84;
     enAlmacen = #71#3;
     |SI #71#35 ! 0;
          uni_dt = #71#35;
     |SINO;
          uni_dt = #71#5;
     |FINSI;
     |HAZ Comisiones;

     #71#8 = enDescuento1;
     #71#10 = enComision;
||     #71#6 = pvp_ve - dto_pt;   || Precio Venta. sin iva.

     #71#36 = #71#6 / #10#74 * #10#69;
|FPRC;


|PROCESO actpf;
     nForma = enForma;
     |SI #10#15 ] 0;
          importe = 1;
     |SINO;
          importe = -1;
          #10#15 = -#10#15;
     |FINSI;
     cant = #10#15 < #10#5;
     cant = cant < #10#32;
     cant = cant < #10#7;
     cant = cant * importe;
     #10#15 = #10#15 * importe;
     |ABRE #24;
     #24#0 = #10#3;
     |LEE 121#24=;
     |SI FSalida = 0;
        |SI #10#43 = AN;
           #24#50 = #24#50 + (cant * enForma);    || es albaran
        |SINO;
           #24#50 = #24#50 - (cant * enForma);    || es abono
        |FINSI;
        |GRABA 020#24a;
        |LIBERA #24;
     |FINSI;
     |CIERRA #24;

     |SI #10#43 = "N";
          enImpCliPen = cant * nForma;
     |SINO;
          enImpCliPen =  -cant * nForma;
     |FINSI;
     eaCliente = #10#3;
     efFecha = #10#1;
     |HAZ AcumulaCli;

     eaTag = "AV";  |HAZ Riesgos;
|FPRC;

|PROCESO CreaCab;
     |ABRE #24;
     #24#0 = #0#0;
     |LEE 000#24=;
     |CIERRA #24;
     |ABRE #25;
     #25#0 = #1#7;
     |LEE 000#25=;
     |CIERRA #25;
     |ABRE #3;
     #3#0 = #24#0;
     #3#1 = #0#16;
     |LEE 000#3=;
     |CIERRA #3;
     |ABRE #7;
     #7#26 = #10#52;
     |LEE 000#7=;
     |CIERRA #7;

     #10#1 = #1#8;
     #10#3 = #24#0;
     #10#4 = #24#2;
||     #10#5 = #24#37;
||     #10#7 = #24#38;
||     #10#32 = #24#156;
     #10#6 = #25#0;
     #10#8 = #24#20;

     #10#29 = #3#10;
     #10#30 = #3#2;
     #10#31 = #3#3;
     #10#33 = #3#7;
     #10#62 = #3#6;

     #10#34 = #25#7;
     #10#35 = #24#4;
     #10#36 = #24#47;
     #10#40 = #24#41;
     #10#50 = #24#40;
     #10#51 = "S";
     #10#63 = #24#15;

     #10#68 = #24#192;
     |ABRE #324;
     |DDEFECTO #324;
     #324#0 = #10#68;
     |LEE 000#324=;
     #10#69 = #324#2;
     #10#70 = #24#193;
     #10#73 = #321#9;
     |DDEFECTO #324;
     #324#0 = #10#73;
     |LEE 000#324=;
     #10#74 = #324#2;
     |CIERRA #324;
     #10#84 = #0#16;
|FPRC;

|PROCESO CreaLin;
     |ABRE #19;
     |SI nSw = 1; |Y nLin = 2;
          #19#0 = "F";
     |SINO;
          #19#0 = #0#2;
     |FINSI;
     |LEE 000#19=;
     |CIERRA #19;

     enForma = 1;

     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = nLin;
     #71#2 = #19#0;
     #71#3 = 1;

     |SI nSw = 1;
          |SI nLin = 1;
               nPrecio = 0;
               #71#4 = #19#1;
               #71#5 = nUni / 1000;
          |SINO;
               nPrecio = #0#17;
               #71#4 = #0#19;
               #71#5 = #0#18 / 1000;
          |FINSI;
     |SINO;
         enTiva = #19#30; efFiva = #10#1;
         |HAZ SacaIVA;
         #71#5 = nUni / 1000;

         nTota = nUni / 1000 * #0#14;
         nTota = nTota + (nTota * enIva / 100);
         nPrecio = (nTota / (1 + (enIva/100))) / #71#5;

         ||nPrecio = (#1#10 / (1 + (enIva/100))) / #71#5;

         #71#4 = #19#1;
     |FINSI;
     #71#6 = nPrecio;

     #71#11 = #19#30;
     #71#13 = #19#2;
     #71#15 = #10#3;
     #71#16 = #10#34;
     #71#17 = #10#35;
     #71#36 = #71#6;
     #71#38 = #71#6;
     #71#49 = #0#1;

     |HAZ AcumulaAV;
     #71#14 = enCoste;

     |HAZ DtoComi;

     |HAZ TotalLin71;
     |GRABA 020#71n;
|FPRC;

|PROCESO SacaUni;
     |SALVA_FICHA #1;
     #1#0 = #0#0;
     #1#1 = #0#1;
     #1#2 = #0#2;
     #1#3 = 999;
     |LEE 000#1];
     |SI FSalida = 0;
          |LEE 000#1a;
     |SINO;
          |LEE 000#1u;
     |FINSI;
     |SI FSalida = 0; |Y #0#0 = #1#0; |Y #0#1 = #1#1; |Y #0#2 = #1#2;
          nCopiaAnt = #1#4;
     |SINO;
          nCopiaAnt = 0;
     |FINSI;
     |REPON_FICHA #1;
     nUni = #1#4 - nCopiaAnt;
|FPRC;

|PROCESO CreaAlba;
     |HAZ SacaUni;
     nError = 0;
     |DDEFECTO #10;
     |ABRE #10;
     #10#52 = #1#5;
     #10#0 = #1#6;
     |GRABA 000#10b;
     |SI FSalida = 0;
          |ABRE #142; |LEE 000#142p; |CIERRA #142;
          |ABRE #321; |LEE 000#321p; |CIERRA #321;
          |ABRE #71;
          |HAZ CreaCab;
          aDivisa = #10#68;
          aMoneda = #10#70;
          |HAZ Divisas010;
          |HAZ LimCabAgifa010;
          nLin = 1;
          |SI nUni < #0#18; |Y nUni > 0;
               nSw = 1;
               |HAZ CreaLin;
               nLin = 2;
               |HAZ CreaLin;
          |SINO;
               nSw = 0;
               |HAZ CreaLin;
          |FINSI;
          |HAZ CalCabAgifa010;
          |GRABA 020#10a;
          |CIERRA #71;
          |HAZ actpf;
     |SINO;
          |MENAV "0000Error al crear el albaran...";
          nError = 1;
     |FINSI;
     |CIERRA #10;
|FPRC;

|PROCESO BorraLin;
     |HAZ AcumulaAV;
     |BORRA 020#71a;
|FPRC;

|PROCESO BorrAlba;
     nError = 0;
     |ABRE #10;
     #10#52 = #1#5;
     #10#0 = #1#6;
     |LEE 121#10=;
     |SI FSalida = 0;
          |SI #10#18 = "S";
               nError = 1;
               |MENAV "0000Albaran facturado...";
          |SINO;
               enForma = -1;
               |BUCLELIN 0 BorraLin #10;
               |HAZ actpf;
               |BORRA 020#10a;
          |FINSI;
     |FINSI;
     |CIERRA #10;
|FPRC;

|PROCESO MiraBorra;
     |ABRE #10;
     #10#52 = #1#5;
     #10#0 = #1#6;
     |LEE 121#10=;
     |SI FSalida = 0;
          |SI #10#18 = "S";
               nError = 1;
               |MENAV "0000Existen albaranes facturados...";
               |ERROR10;
          |FINSI;
     |FINSI;
     |CIERRA #10;
|FPRC;

|PROCESO NoEsc; |TIPO 0;
     |SI FSalida = 1;
          |AVISO;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO DefeLin; |TIPO 0;
     |ABRE #6; |LEE 000#6p; |CIERRA #6;
     #1#5 = #6#1; |PINTA #1#5;
|FPRC;

|PROCESO Conta; |TIPO 7;
     |ABRE #10;
     #10#52 = #1#5;
     |HAZ ContaAV7;
     #1#6 = #10#0; |PINTA #1#6;
     |CIERRA #10;
|FPRC;

|PROCESO Alta; |TIPO 0;
     nModoCab = (FEntrada / 100) ! 0;
|FPRC;

|PROCESO ActualizaCab; |TIPO 2;
     nModoCab = (FEntrada / 100) ! 0;
     |SI nModoCab = 3;
/*
          |CONFI "0000NLos Albaranes asociados se borraran. ¿Desea continuar?";
          |SI FSalida = 0;
               nError = 0;
               |BUCLELIN 2 MiraBorra #0;
               |SI nError = 0;
                    |BUCLELIN 2 BorrAlba #0;
               |FINSI;
          |SINO;
               |ERROR;
          |FINSI;
*/
     |FINSI;
|FPRC;

|PROCESO ActualizaLin; |TIPO 2;
     nForma = 0 +. 1;
     nModo = (FEntrada / 100) ! 0;

     |SI nModoCab = 3; |ACABA; |FINSI;

     |SI nModo = 1;
          |HAZ CreaAlba;
          #1#9 = #10#78; |PINTA #1#9;
          |SI nSw = 1; #1#10 = #1#9; |PINTA #1#10; |FINSI;
          |SI nError ! 0; |ERROR; |ACABA; |FINSI;
     |FINSI;

     |SI nModo = 2;
          |SI nForma = -1;
               |MENAV "0000No se puede modificar, borre la linea...";
          |FINSI;
          |ERROR; |ACABA;
     |FINSI;
     |SI nModo = 3;
          |CONFI "0000NSe borrara el albaran asociado. ¿Desea continuar?";
          |SI FSalida ! 0; |ERROR; |ACABA; |FINSI;
          |HAZ BorrAlba;
          |SI nError ! 0; |ERROR; |ACABA; |FINSI;
     |FINSI;
     |HAZ UltLectura;
|FPRC;

|PROCESO UltLectura;
     nLin = #1#3;
     |SALVA_FICHA #1;
     #1#3 = 999;
     |LEE 000#1];
     |SI FSalida = 0;
          |LEE 000#1a;
     |SINO;
          |LEE 000#1u;
     |FINSI;
     |SI nModo = 3; |Y nLin = #1#3; |LEE 000#1a; |FINSI;
     |SI FSalida ! 0; |O #0#0 ! #1#0; |O #0#1 ! #1#1; |O #0#2 ! #1#2;
          |DDEFECTO #1;
     |FINSI;
     |SI nModo = 1; |Y nLin ] #1#3;
          nCopiaAnt = #1#4;
          |REPON_FICHA #1;
          #0#9 = #1#8; ||PINTA #0#9;
          #0#10 = #1#5; ||PINTA #0#10;
          #0#11 = #1#6; ||PINTA #0#11;
          #0#12 = #1#7; ||PINTA #0#12;
          #0#5 =  #1#4; ||PINTA #0#5;
          #0#6 = #1#4 - nCopiaAnt; ||PINTA #0#6;
     |SINO;
          #0#9 = #1#8; ||PINTA #0#9;
          #0#10 = #1#5; ||PINTA #0#10;
          #0#11 = #1#6; ||PINTA #0#11;
          #0#12 = #1#7; ||PINTA #0#12;
          #0#5 =  #1#4; ||PINTA #0#5;
          #0#6 = #1#4;
          |LEE 000#1a;
          |SI nModo = 3; |Y nLin = #1#3; |LEE 000#1a; |FINSI;
          |SI FSalida = 0; |Y #0#0 = #1#0; |Y #0#1 = #1#1; |Y #0#2 = #1#2;
               nCopiaAnt = #1#4;
          |SINO;
               nCopiaAnt = 0;
          |FINSI;
          #0#6 = #0#6 - nCopiaAnt;  ||PINTA #0#6;
          |REPON_FICHA #1;
     |FINSI;
|FPRC;

|PROCESO ChequeaCopia; |TIPO 0;
     |SALVA_FICHA #1;
     #1#0 = #0#0;
     #1#1 = #0#1;
     #1#2 = #0#2;
     #1#3 = 999;
     |LEE 000#1];
     |SI FSalida = 0;
          |LEE 000#1a;
     |SINO;
          |LEE 000#1u;
     |FINSI;
     |SI FSalida = 0; |Y #0#0 = #1#0; |Y #0#1 = #1#1; |Y #0#2 = #1#2;
          nCopiaAnt = #1#4;
     |SINO;
          nCopiaAnt = 0;
     |FINSI;
     |REPON_FICHA #1;
     |SI #1#4 < nCopiaAnt;
          |AVISO;
          |CONFI "0000NLa lectura es inferior a la anterior. ¿Continuar?";
          |SI FSalida ! 0; |ERROR; |FINSI;
     |FINSI;
|FPRC;

|PROCESO Dir0; |TIPO 0;
     |ABRE #3;
     #3#0 = #0#0;
     #3#1 = #0#16;
     |LEE 000#3=;
     |SI FSalida ! 0;
          |MENAV "0000No existe la direccion de entrega para este cliente...";
          |ERROR;
     |SINO;
          |HAZ PintaDir;
     |FINSI;
     |CIERRA #3;
|FPRC;

|PROCESO Min;
     #3#0 = #0#0;
     #3#1 = 1;
|FPRC;

|PROCESO Max;
     #3#0 = #0#0;
     #3#1 = 9999;
|FPRC;

|PROCESO Dir66; |TIPO 66;
     |ABRE #3;
     #3#0 = #0#0;
     #3#1 = #0#16;
     |LEE 000#3];
     |CONSULTA_F_CLAVE #1#3, Min, Max;
     |SI FSalida = 0;
          #0#16 = #3#1; |PINTA #0#16;
     |SINO;
          |ERROR;
     |FINSI;
     |CIERRA #3;
|FPRC;

|PROCESO Tipo13; |TIPO 13;
     |ATRI I;
     |HAZ PintaDir;
     |ATRI 0;
|FPRC;

|PROCESO PintaDir;
     |DDEFECTO #3;
     |ABRE #3;
     #3#0 = #0#0;
     #3#1 = #0#16;
     |LEE 000#3=;
     |CIERRA #3;

     |PINTA 1615, #3#2;
     |PINTA 1715, #3#3;
     |PINTA 1815, #3#7;

     |PINTA 1655, #3#13;
     |PINTA 1755, #3#21;
|FPRC;

|PROCESO DefFac; |TIPO 7;
     |HAZ SacaUni;
     |SI nUni < #0#18; |Y nUni > 0;
          |C_M #1#10, 1, "N";
          |ACABA;
     |SINO;
          |C_M #1#10, 1, "S";
     |FINSI;
     |ABRE #19;
     #19#0 = #0#2;
     |LEE 000#19=;
     |CIERRA #19;
     enTiva = #19#30; efFiva = #1#8;
     |HAZ SacaIVA;

     #1#10 = nUni / 1000 * #0#14;
     #1#10 = #1#10 + (#1#10 * enIva / 100);
|FPRC;
