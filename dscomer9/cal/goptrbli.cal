|FICHEROS;
     goptrbli #6;
     gopre001 #7;
     gomantl1 #8;
     gopartia #9;
     agifa027 #27;
     refere1@ #100; ||gopartli
     refere2@ #101; ||goptrbli
     refere3@ #102; ||gopartll
|FIN;

|VARIABLES;
     aTipo = "";
     &enRecalcular = 0;
     aDef = "";
     aSerPar = "";
     nNumPar = 0;
     aAlfa = "";
     nLin = 0;
     i = 0;
     aSerPre = "";
     nNumPre = 0;
     nLinPar = 0;
     &eaSerie = "";
     &enNumero = 0;
     &efFecha = @;
     &enLinea = 0;
|FIN;

|PROCESO Cambia_9;
     nLinPar = nLinPar + 1;
     |BORRA 020#9a;
     #9#0 = #8#3;
     #9#1 = #8#4;
     #9#4 = aSerPar;
     #6#5 = nNumPar;
     #9#6 = nLin;
     #9#7 = nLinPar;
     |GRABA 020#9n;
|FPRC;

|DEFBUCLE Cambia_9;
     #9#1;
     ;
     "T", #6#23, #6#24, #6#3, 001;
     "T", #6#23, #6#24, #6#3, 999;
     be;
     NULL, Cambia_9;
|FIN;

|PROCESO Cambia101;
     nLin = nLin + 1;
     |PARA i = 0; |SI i [ 27; |HACIENDO i = i + 1;
          #101i = #6i;
     |SIGUE;
     #101#3 = nLin;
     #101#20 = #8#3;
     #101#21 = #8#4;
     #101#23 = aSerPar;
     #101#24 = nNumPar;
     |GRABA 020#101n;

     |ABRE #9;
     #9#34 = "T";
     #9#4 = #101#23;
     #9#5 = #101#24;
     #9#6 = nLin;
     #9#7 = 999;
     |LEE 101#9];
     |SI FSalida = 0;
          |LEE 000#9a;
     |SINO;
          |LEE 000#9u;
     |FINSI;
     |SI FSalida = 0; |Y #9#34 = "T"; |Y #9#4 = #101#23; |Y #9#5 = #101#24;
               |Y #9#6 = nLin;
          nLinPar = #9#8 + 1;
     |SINO;
          nLinPar = 1;
     |FINSI;
     |CIERRA #9;
     |BUCLE Cambia_9;

     #101#20 = #6#20;
     #101#21 = #6#21;
     #101#2 = #6#2;
     #101#3 = #6#3;
     |BORRA 020#101c;
|FPRC;

|PROCESO ContaParte;
     |ABRE #27;
     #27#0 = "partetrab";
     #27#2 = #6#0;
     |LEE 101#27=;
     |SI FSalida = 0;
          #27#1 = #27#1 + 1;
          |GRABA 020#27a;
          |LIBERA #27;
     |SINO;
          #27#1 = 1;
          |GRABA 020#27n;
     |FINSI;
     |CIERRA #27;
     aSerPar = #27#2;
     nNumPar = #27#1;
|FPRC;

|PROCESO Cambia_102;
     |SELECT #2#102;
     #102#0 = #6#0;
     #102#1 = #6#1;
     #102#4 = #8#3;
     #102#5 = #8#4;
     |LEE 000#102=;
     |SI FSalida ! 0;
          |SELECT #1#102;
          #102#0 = #6#0;
          #102#1 = #6#1;
          #102#2 = 9999;
          |LEE 000#102=;
          |SI FSalida = 0;
               |LEE 000#102a;
          |SINO;
               |LEE 000#102u;
          |FINSI;
          |SI FSalida = 0; |Y #102#0 = #6#0; |Y #102#1 = #6#1;
               nLin = #102#2 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |DDEFECTO #102;
          #102#0 = #6#0;
          #102#1 = #6#1;
          #102#2 = nLin;
          #102#3 = #7#4;
          #102#4 = #7#0;
          #102#5 = #7#1;
          #102#14 = #7#18;
          |GRABA 020#102n;
     |FINSI;
|FPRC;

|PROCESO Cambia;
     #101#20 = #6#20;
     #101#21 = #6#21;
     #101#2 = #6#2;
     #101#3 = #6#3;
     |LEE 000#101=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aAlfa = "0000NCambiar: " + #6#20 + "/" + (("000000"+#6#21)%-106) + &13;
     aAlfa = aAlfa + "Por: " + #8#3 + "/" + (("000000"+#8#4)%-106);
     |CONFI aAlfa;
     |SI FSalida ! 0; |ACABA; |FINSI;
     enRecalcular = 1;

     |ABRE #7;
     #7#0 = #8#3;
     #7#1 = #8#4;
     |LEE 020#7=;
     |CIERRA #7;

     aSerPre = #6#20;
     nNumPre = #6#21;

     |HAZ Cambia_102;

     |SELECT #2#100;
     #100#0 = #8#3;
     #100#1 = #8#4;
     #100#3 = #6#2;
     |LEE 000#100=;
     |SI FSalida  = 0;
          aSerPar = #100#4;
          nNumPar = #100#5;
     |SINO;
          |HAZ ContaParte;
          |SELECT #1#100;
          #100#0 = #8#3;
          #100#1 = #8#4;
          #100#2 = 999;
          |LEE 000#100];
          |SI FSalida = 0;
               |LEE 000#100a;
          |SINO;
               |LEE 000#100u;
          |FINSI;
          |SI FSalida = 0; |Y #100#0 = #8#3; |Y #100#1 = #8#4;
               nLin = #100#2 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |DDEFECTO #100;
          #100#0 = #8#3;
          #100#1 = #8#4;
          #100#2 = nLin;
          #100#3 = #6#2;
          #100#4 = aSerPar;
          #100#5 = nNumPar;
          #100#14 = #6#0;
          #100#15 = #6#1;
          #100#16 = #7#18;
          #100#6 = #6#8;
          #100#7 = #6#9;
          #100#8 = #6#10;
          #100#9 = #6#17;
          #100#10 = #6#16;
          #100#11 = #6#19;
          #100#12 = #6#18;
          #100#13 = #100#6 + #100#7 + #100#8;
          |GRABA 020#100n;
     |FINSI;

     #101#20 = #8#3;
     #101#21 = #8#4;
     #101#2 = #6#2;
     #101#3 = 9999;
     |LEE 000#101];
     |SI FSalida = 0;
          |LEE 000#101a;
     |SINO;
          |LEE 000#101u;
     |FINSI;
     |SI FSalida = 0; |Y #101#20 = #8#3; |Y #101#21 = #8#4; |Y #101#2 = #6#2;
          nLin = 0;
     |SINO;
          nLin = #101#3;
     |FINSI;
     |HAZ Cambia101;
|FPRC;

|PROCESO Min_8;
     #8#0 = #6#0;
     #8#1 = #6#1;
     #8#2 = 1;
|FPRC;

|PROCESO Max_8;
     #8#0 = #6#0;
     #8#1 = #6#1;
     #8#2 = 999;
|FPRC;

|PROCESO MensaLin; |TIPO 7;
|FPRC;

|PROCESO Observ; |TIPO 11;
     |SI FSalida = 11;   || F3
          eaSerie = #goptrbli#20;
          enNumero = #goptrbli#21;
          efFecha = #goptrbli#2;
          enLinea = #goptrbli#3;
          |SUB_EJECUTA_NP "goptrcom";
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO CamPreTra; |TIPO 11;
     |SI FSalida = 13; ||F5;       ||No esta puesto en la ayuda
          |HAZ ConsultaDetalle;
          |ERROR;
     |FINSI;
     |SI FSalida = 10;
          |DDEF aDef;
          aAlfa = aDef + "gopartli";
          |CARGA_DEF aAlfa, refere1@;
          aAlfa = aDef + "goptrbli";
          |CARGA_DEF aAlfa, refere2@;
          aAlfa = aDef + "gopartll";
          |CARGA_DEF aAlfa, refere3@;

          |ABRE #8;
          #8#0 = #6#0;
          #8#1 = #6#1;
          |LEE 000#8];
          |CONSULTA_F_CLAVE #1#8, Min_8, Max_8;
          |SI FSalida ! 0;
               |ERROR;
          |SINO;
               |SI #6#20 ! #8#3; |O #6#21 ! #8#4;
                    |ABRE #7;
                    #7#0 = #8#3;
                    #7#1 = #8#4;
                    |LEE 020#7=;
                    aTipo = #7#18;
                    #7#0 = #6#20;
                    #7#1 = #6#21;
                    |LEE 020#7=;
                    |CIERRA #7;
                    |SI aTipo ! #7#18;
                         |MENAV "0000El presupuesto es de diferente tipo al actual...";
                         |ERROR;
                    |SINO;
                         |ABRE #100;
                         |ABRE #101;
                         |ABRE #102;
                         |HAZ Cambia;
                         |CIERRA #100;
                         |CIERRA #101;
                         |CIERRA #102;
                         |ERROR;
                         |PTEC 808;
                         |PONCONTROL 23, "SI";
                    |FINSI;
               |SINO;
                    |ERROR;
               |FINSI;
          |FINSI;
          |CIERRA #8;
          |DESCARGA_DEF #refere3@;
          |DESCARGA_DEF #refere2@;
          |DESCARGA_DEF #refere1@;
     |FINSI;
|FPRC;
