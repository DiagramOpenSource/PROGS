|| -------- Listado Beneficios/Margen Totales (Albaranes) ----------

|FICHEROS;
     albad017 #0;
     agifa010 #1;
     agifa071 #2;
     albad005 #3; ||Rappels
     albad022 #4; ||Tmp
     agifa024 #5;
     albad023 #6; ||Tmp
     agifa019 #7;
     agifa084 #21;
     agifa069 #22;
     albad003 #30;
|FIN;

|VARIABLES;
     &EURODB = 0;
     dtolin = 0;
     dtolin1 = 0;
     aAlfa = "";
     &Tempo = "";
     aTmp4 = "";
     aTmp6 = "";
     nUniPromo = 0;
     nUniBase = 0;
     nImpDto = 0;
     informe  = "albad017"; ||"alba0001";
     informe2 = "albadt17"; ||"albat001";
     resto = 0;
     unip = 0;
     rapp1 = 0;
     rapp2 = 0;
     rapp3 = 0;
     rapp33 = 0;
     pbon = 0;
     dpp = 0;
     vcaj = 0;
     &t1 = 0;
     &t2 = 0;
     &t3 = 0;
     &t4 = 0;
     &t5 = 0;
     &t6 = 0;
     &t7 = 0;
     &t10 = 0;
     &t11 = 0;
     &t12 = 0;
     &t13 = 0;
     &t14 = 0;
     &t15 = 0;
     &t16 = 0;
     &t17 = 0;
     &t18 = 0;
     &t19 = 0;
     &t20 = 0;
     &t21 = 0;
     obseq = 0;
     a = -1;
     sw = 0;
     codigo = "";
     precio = 0;
     implin = 0;
     imprap = 0;
|FIN;

|CALCULO tiplis;|TIPO 0;
|PINTA 1069 , "        ";
|PINTA 1169 , "        ";
#0#7 = "  ";
|PINTA #0#7;
#0#8 = "YZ";
|PINTA #0#8;
|PINTA 1069 , informe;
|PINTA 1169 , informe2;
|FCAL;

|CALCULO linpro;
     |SI #2#63 = -1; || Linea de promocion
          |ACABA;
     |FINSI;

     |DDEFECTO #30;
     |ABRE #30;
     #30#0 = #1#52;
     #30#1 = #1#0;
     |LEE 000#30=;       ||Auxiliar
     |CIERRA #30;

     nUniPromo = #2#66;
     nUniBase = #2#5;
     nImpDto = #2#64;

     |ABRE #7;
     #7#0 = #2#2;
     |LEE 111#7=;
     |SI #7#125 ] #0#15;|Y #7#125 [ #0#16;
          |DDEFECTO #4;
          #4#0 = #1#3;
          #4#1 = #2#2;
          |LEE 101#4=;
          |SI FSalida ! 0; |GRABA 021#4b; |FINSI;

          |SI #30#2 = "N";    || Obsequio
               #4#12 = #7#18;
               #4#13 = #7#28;
               #4#2 = #4#2 + (nUniBase + nUniPromo);      || Cantidad total incluido promociones
               precio = #2#6;
               implin = (nUniBase + nUniPromo) * precio;
               #4#4 = #4#4 + implin;       || Importe total no incluido bonificaciones
               #4#14 = #4#2 * #4#13;
               #4#15 = #4#4 - #4#14;

               pbon = nImpDto * #2#5;
               #4#5 = #4#5 + pbon;         || Pesetas Bonificacion
               dtolin = #2#7 < #2#8;
               dtolin1 = dtolin < #2#33;
               dtolin = #2#7 - dtolin1;
               dtolin = dtolin ! EURODB;
               #4#5 = #4#5 + dtolin;       || Pesetas Bonificacion + Descuento Lineal

               dpp = #2#7 % #1#7;
               aAlfa = #7#125; |QBF aAlfa;
               |SI aAlfa = "E ";
                    dpp = 0;
               |FINSI;
               #4#6 = #4#6 + dpp;          || Dto P.P.
               vcaj = nUniPromo * precio;
               #4#7 = #4#7 + vcaj;         || Valor Cajas Promocion a precio sin bonificaciones
               #4#9 = #4#9 + nUniBase;        || Unidades Base
               imprap = nUniBase * precio;
               #4#10 = #4#10 + imprap;     || Importe Para Rappels

               ||   -------- Rappels Entregados ------------
               |SI #1#52 ] "Z    ";|Y #1#52 [ "ZZ   ";
                    #4#11 = #4#11 + #2#9;
               |FINSI;

               ||   -------- Rappels ------------
               |SI #1#52 < "Z    ";|O #1#52 > "ZZ   ";
                    #3#0 = #1#3;
                    #3#1 = #2#2;
                    |LEE 000#3=;
                    |SI FSalida = 0;
                         rapp1 = #4#10 % #3#2;
                         rapp2 = #4#9 * #3#3;
                         unip = #4#9 / #3#4;
                         resto = #4#9 $ #3#4;
                         resto = resto / #3#4;
                         unip = unip - resto;
                         rapp33 = unip * #3#5;
                         rapp3 = rapp33 * precio;
                         #4#3 = rapp1 + rapp2 + rapp3; ||Rappels
                    |FINSI;
               |FINSI;
          |SINO;         || Obsequios = "S"
               obseq =  #2#9 * a;           || Obsequios no acumulando lo demas
               #4#8 = #4#8 + obseq;
          |FINSI;
          #4#16 = #4#3 + #4#5 + #4#6 + #4#7 + #4#8;
          #4#17 = #4#15 - #4#16;
          #4#18 = #4#17 / #4#4;
          #4#18 = #4#18 * 100;
          #4#20 = (#4#4 - #4#16) / #4#2;
          #4#21 = #4#17 / #4#2;
          |GRABA 020#4a;
          |LIBERA #4;

          imprap = 0;
          implin = 0;
          unip = 0;
          resto = 0;
          rapp1 = 0;
          rapp2 = 0;
          rapp33 = 0;
          rapp3 = 0;
          pbon = 0;
          dpp = 0;
          vcaj = 0;
          obseq = 0;
          precio = 0;
     |FINSI;
     |CIERRA #7;
|FCAL;

|CALCULO proceso;        ||Todos Los Albaranes Seleccionados
     #5#0 = #1#3;
     |LEE 000#5=;
     |SI FSalida = 0;
       |SI #5#158 ] #0#2;|Y #5#158 [ #0#3;
         |SI #5#3 ] #0#17;|Y #5#3 [ #0#18;
           |BUCLELIN 2linpro#1;
         |FINSI;
       |FINSI;
     |FINSI;
|FCAL;

|DEFBUCLE listresu1;
     #1#3;
     ;
     #0#0 , #0#4 , #0#7 , #0#9;
     #0#1 , #0#5 , #0#8 , #0#10;
     be;
     NULL,proceso;
|FIN;

|CALCULO totales;
#6#0 = #4#1;
|LEE 101#6=;
|SI FSalida ! 0;
  |GRABA 021#6c;
  |LIBERA #6;
|FINSI;
  #6#0 = #4#1;
  #6#1 = #6#1 + #4#2;
  #6#2 = #6#2 + #4#3;
  #6#3 = #6#3 + #4#4;
  #6#4 = #6#4 + #4#5;
  #6#5 = #6#5 + #4#6;
  #6#6 = #6#6 + #4#7;
  #6#7 = #6#7 + #4#8;
  #6#8 = #6#8 + #4#9;
  #6#9 = #6#9 + #4#10;
  #6#10 = #6#10 + #4#11;
  #6#11 = #4#12;
  #6#12 = #6#12 + #4#13;
  #6#13 = #6#13 + #4#14;
  #6#14 = #6#14 + #4#15;
  #6#15 = #6#15 + #4#16;
  #6#16 = #6#16 + #4#17;
  #6#19 = #6#19 + #4#20;
  #6#20 = #6#20 + #4#21;
  #6#17 = #6#16 / #6#3;
  #6#17 = #6#17 * 100;
|GRABA 021#6a;
|LIBERA #6;

#6#1 = 0;
#6#2 = 0;
#6#3 = 0;
#6#4 = 0;
#6#5 = 0;
#6#6 = 0;
#6#7 = 0;
#6#8 = 0;
#6#9 = 0;
#6#10 = 0;
#6#11 = 0;
#6#12 = 0;
#6#13 = 0;
#6#14 = 0;
#6#15 = 0;
#6#16 = 0;
#6#17 = 0;
#6#18 = 0;
#6#19 = 0;
#6#20 = 0;
|FCAL;

|DEFBUCLE total;
#4#1;
;
INICIO;
FINAL;
be;
NULL , totales;
|FIN;

|CALCULO imprime1t;|TIPO 0;
|PRINT;
t1 = t1 + #6#1;
t2 = t2 + #6#2;
t3 = t3 + #6#3;
t4 = t4 + #6#4;
t5 = t5 + #6#5;
t6 = t6 + #6#6;
t7 = t7 + #6#7;
t10 = t10 + #6#10;
t11 = t11 + #6#11;
t12 = t12 + #6#12;
t13 = t13 + #6#13;
t14 = t14 + #6#14;
t15 = t15 + #6#15;
t16 = t16 + #6#16;
t17 = t17 + #6#17;
t18 = t18 + #6#18;
t19 = t19 + #6#19;
t20 = t20 + #6#20;
|FCAL;

|DEFBUCLE imprimet;
#6#1;
;
"                    ";
"zzzzzzzzzzzzzzzzzzzz";
be;
NULL,imprime1t;
|FIN;

|CALCULO imprime1;|TIPO 0;
|SI sw = 0;
  sw = 1;
  codigo = #4#0;
|FINSI;
|SI codigo ! #4#0;
  codigo = #4#0;
  |PIEINF;
  t1 = 0;
  t2 = 0;
  t3 = 0;
  t4 = 0;
  t5 = 0;
  t6 = 0;
  t7 = 0;
  t10 = 0;
  t11 = 0;
  t12 = 0;
  t13 = 0;
  t14 = 0;
  t15 = 0;
  t16 = 0;
  t17 = 0;
  t18 = 0;
  t19 = 0;
  t20 = 0;
  t21 = 0;
  |INFOR informe;
|FINSI;
|PRINT;
t1 = t1 + #4#2;
t2 = t2 + #4#3;
t3 = t3 + #4#4;
t4 = t4 + #4#5;
t5 = t5 + #4#6;
t6 = t6 + #4#7;
t7 = t7 + #4#8;
t10 = t10 + #4#11;
t12 = t12 + #4#12;
t13 = t13 + #4#13;
t14 = t14 + #4#14;
t15 = t15 + #4#15;
t16 = t16 + #4#16;
t17 = t17 + #4#17;
t18 = t18 + #4#18;
t19 = t19 + #4#19;
t20 = t20 + #4#20;
t21 = t21 + #4#21;
|FCAL;

|DEFBUCLE imprime;
#4#1;
;
#0#0 , "                    ";
#0#1 , "zzzzzzzzzzzzzzzzzzzz";
be;
NULL,imprime1;
|FIN;

|PROCESO listresu;|TIPO 3;
     |HAZ CreaTempo; aTmp4 = Tempo;
     |HAZ CreaTempo; aTmp6 = Tempo;
     |NOME_DAT #4 aTmp4; |DELINDEX #4;
     |NOME_DAT #6 aTmp6; |DELINDEX #6;

     |ABRE #1;
     |ABRE #2;
     |ABRE #3;
     |ABRE #4;
     |ABRE #5;
     |ABRE #6;
     |ABRE #21;
     |ABRE #22;
     |BUCLE listresu1;
     |BUCLE total;
     |IMPRE 1;
     |SI #0#14 = "T";
         |INFOR informe2;
     |SINO;
         |INFOR informe;
     |FINSI;
     |SI #0#14 = "D";
       |BUCLE imprime;
     |SINO;
       |BUCLE imprimet;
     |FINSI;
     |PIEINF;
     |FININF;
     |FINIMP;

     |CIERRA #1;
     |CIERRA #2;
     |CIERRA #3;
     |CIERRA #4;
     |CIERRA #5;
     |CIERRA #6;
     |CIERRA #21;
     |CIERRA #22;

     Tempo = aTmp4; |HAZ BoraTempo; |DELINDEX #4;
     Tempo = aTmp6; |HAZ BoraTempo; |DELINDEX #6;
|FPRC;
