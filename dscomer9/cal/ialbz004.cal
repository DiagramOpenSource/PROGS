|FICHEROS;
     ialbz004 #0;
     ialbm011 #1;
     ialbm012 #2;
     ialbm013 #3;
     agifa010 #10;
     dsz99984 #11;
     agifa024 #24;
     agifa066 #66; ||*
     agifa071 #71;
     agifa059 #59;
     agifa091 #91;
     agifa133 #133;
     agifa134 #134;
     agifa142 #142;
     agifa177 #177;
     agifa321 #321;
     agifa324 #324;

     dscam045@ #200;
     dscam003@ #201;
     dscam004@ #202;
     dscamrie@ #100;
     dscam038@ #101;
     dscam023@ #102;
|FIN;

|VARIABLES;
     &enTiva = 0;
     &efFiva = @;
     &eaDiva = "";
     &enIva = 0;
     &enRec = 0;
     &eaTag = "";
     &aSer = "";
     &aCli = "";
     &aNomCli = "";
     &nImpo = 0;
     &eaProg = "";
     aCuenta = "";
     nVto = 0;
     nRecibo = 0;
     &EURODB = 0;
     fechas = "";
     importe = 0;
     tipo_imp = 0;
     i = 0;
     resto = 0;
     fechae = @;
     j = 0;
     fecha_fac = @;
     mes_venci = "";
     dia_venci = "";
     any_venci = "";
     mes_ven = 0;
     totalb = 0;
     sw1 = 0;
     &sw = 0;
     em = 0;
     num2 = 0;
     vaciof = " ";
     fecha  = "          ";
     cafe = "";
     diafe = "";
     dianu = "";
     k = 0;
     primera = 0;
     num = 0;
     num1 = 0;
     saltar = 0;
     retencion = 0;
     voy = 0;
     con = 0;
     mes = 0;
     imneto = 0;
     margen = 0;
     indtope = 0;
     ind = 0;
     impreso = 0;
     redondeo = 0;
     fmes = " ";

     nNume1 = 0;
     nNume2 = 0;
     nLinea = 0;
     aCp1 = "";
     aCp2 = "";
     nIva = 0;
     nBase = 0;
     nCuota = 0;
     nError = 0;
     nTiva = 0;

     nImpCobro = 0;
     aRuta = "";
     nBoton = 0;
     aTmp = "";
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aCar = "";
     aFin = "";
     nCar = 0;
     aRetorno = "";
     aFic = "";
     nHandle = 0;

     aNum = "";
     aFec = "";
     aNif = "";
     aRazon = "";
     aNom = "";
     aDomi = "";
     aCP = "";
     aPobla = "";
     aProvi = "";
     aFP = "";
     aTlf = "";
     aB1 = "";
     aIva1 = "";
     aB2 = "";
     aIva2 = "";
     aB3 = "";
     aIva3 = "";
     aTota = "";
     aCobra = "";
     aCuota1 = "";
     aCuota2 = "";
     aCuota3 = "";
     nCobro = 0;
     nAbo = 0;
     nNume = 0;
|FIN;

|PROCESO cambia_fecha;
     dia_venci = fechae % 102;
     mes_venci = fechae % 402;
     mes_ven = mes_venci + 1;
     mes_venci = ("00" + mes_ven) % -102;
     any_venci = fechae %704;
     |SI mes_ven > 12;
          mes_venci = "01";
          mes_ven = any_venci + 1;
          any_venci = mes_ven;
     |FINSI;
          fechas = dia_venci + "." + mes_venci + "." + any_venci;
          fechae = fechas;
|FPRC;

|CALCULO cambios;
fecha = fechae;
cafe = fecha;
diafe = fecha % A102;
dianu = diafe;
|FCAL;

|CALCULO fijos;
 |SI #134#14 = 0;          ||#6#22
     |VETE finfijos;
 |FINSI;
 |HAZ cambios;
 |SI dianu > #134#14;
     |VETE  fijos2;
 |FINSI;
|ET fijos1;
 |SI dianu = #134#14;
     |VETE finfijos;
 |FINSI;
 fechae = fechae +1;
 |HAZ cambios;
 |VETE fijos1;
|ET fijos2;
 |SI #134#15 = 0; |O dianu [ #134#14;         ||#6#23
     |VETE fijos1;
 |FINSI;
 |SI dianu > #134#15;
     |VETE fijos3;
 |FINSI;
 |SI dianu = #134#15;
     |VETE finfijos;
 |FINSI;
 fechae = fechae + 1;
 |HAZ cambios;
 |VETE fijos2;
|ET fijos3;
 |SI #134#16 = 0;|O dianu > #134#16; |O dianu [ #134#14; |O dianu [ #134#15;
     |VETE fijos1;
 |FINSI;
 |SI dianu = #134#16;
     |VETE finfijos;
 |FINSI;
 fechae = fechae +1;
 |HAZ cambios;
 |VETE fijos3;
|ET finfijos;
 fecha = fechae;
|FCAL;

|PROCESO vencical;
j = #91k / em;
|SI j ! 0; |O #134#14 ! 0; |O #134#15 ! 0; |O #134#16 ! 0;
     fechae = fecha_fac + j;
     |HAZ fijos;
     mes_venci = fechae % 402;
     mes_ven = mes_venci;
     |SI mes_ven = #24#21;          ||Si es mes de no pago...
          |HAZ cambia_fecha;       ||Cambio la fecha
          fecha = fechae;
     |FINSI;
     #133#3 = fecha;
     #133#2 = importe * tipo_imp;
     |SI i = num; #133#2 = #133#2 + (resto * tipo_imp); |FINSI;
|SINO;
     #133#2 = importe * tipo_imp;
     #133#3 = #134#1;
|FINSI;
|SI EURODB = 2; #133#2 = #133#2 / 100; |FINSI;
|FPRC;

|PROCESO Cobro;     ||psion014
     |DBASS aAlfa; aAlfa = aAlfa + "dscarter/def/dscam045.mas";
     |CARGA_DEF aAlfa, dscam045@;
     |SI FSalida = 0;
        |DBASS aAlfa; aAlfa = aAlfa + "dscarter/fich/"; |PATH_DAT #200 aAlfa;
        |ABRE #dscam045@;
        |DBASS aAlfa; aAlfa = aAlfa + "dscarter/def/dscam003.mas";
        |CARGA_DEF aAlfa, dscam003@;
        |SI FSalida = 0;
           |DBASS aAlfa; aAlfa = aAlfa + "dscarter/def/dscam004.mas";
           |CARGA_DEF aAlfa, dscam004@;
           |SI FSalida = 0;
              aAlfa = "";
              #dscam045@#0 = #48#0;
              #dscam045@#1 = 1;
              |LEE 000#dscam045@.];
              |PARA; |SI FSalida = 0; |Y #dscam045@#0 = #48#0; |HACIENDO;
                 |SI #dscam045@#4 [ #134#49; |Y #dscam045@#5 ] #134#49;
                    |DBASS aAlfa; aAlfa = aAlfa + "dscarter/fich/" + (("00000" + #dscam045@#6) % -105) + "/";
                    |SAL;
                 |FINSI;
              |SIGUE;
              |SI aAlfa ! "";
                 |PATH_DAT #201 aAlfa; |PATH_DAT #202 aAlfa;
                 |ABRE #dscam003@;   |ABRE #dscam004@;
                 |SELECT #12#dscam003@;
                 |DDEFECTO #dscam003@;
                 #dscam003@#0 = #133#4;
                 #dscam003@#1 = #133#0;
                 #dscam003@#2 = #133#1;
                 |LEE 101#dscam003@.];
                 |SI FSalida = 0; |Y #dscam003@#0 = #133#4; |Y #dscam003@#1 = #133#0;
                         |Y #dscam003@#2 = #133#1;
                    nLinea = 1;
                    #dscam004@#17 = #dscam003@#40;
                    #dscam004@#3  = 1;
                    |LEE 000#dscam004@.];
                    |PARA; |SI FSalida = 0; |Y #dscam004@#17 = #dscam003@#40; |HACIENDO;
                       nLinea = #dscam004@#3 + 1;
                       |LEE 000#dscam004@.s;
                    |SIGUE;
                    |DDEFECTO #dscam004@;
                    #dscam004@#17 = #dscam003@#40;
                    #dscam004@#3  = nLinea;
                    |GRABA 020#dscam004@.b;
                    #dscam004@#0 = #dscam003@#0;
                    #dscam004@#1 = #dscam003@#1;
                    #dscam004@#2 = #dscam003@#2;
                    #dscam004@#4 = #0#2;
                    #dscam004@#5 = "COB";
                    #dscam004@#6 = #134#1;
                    #dscam004@#7 = #dscam003@#23;
                    #dscam004@#8 = nCobro;
                    #dscam004@#25 = #dscam003@#61;
                    #dscam004@#26 = nCobro * #dscam003@#59;
                    #dscam004@#33 = 1;
                    |GRABA 020#dscam004@.a; |LIBERA #dscam004@;

                    #dscam003@#23 = #dscam003@#23 + nCobro;
                    #dscam003@#61 = #dscam003@#61 + (nCobro * #dscam003@#59);
                    #dscam003@#31 = #dscam003@#31 - nCobro;
                    #dscam003@#65 = #dscam003@#65 - (nCobro * #dscam003@#59);
                    #dscam003@#26 = ~;
                    |SI #dscam003@#31 = 0;
                       #dscam003@#14 = "L";
                       #dscam003@#15 = "Recibo Liquidado";
                    |SINO;
                       |SI #dscam003@#23 ! 0;
                          #dscam003@#14 = "C";
                          #dscam003@#15 = "Cobrado parcialmente";
                       |FINSI;
                    |FINSI;
                    #dscam003@#12 = #91#69; || Tipo Recibo
                    #dscam003@#99 = #134#1; || F.Emision
                    |GRABA 020#dscam003@.a; |LIBERA #dscam003@;
                 |FINSI;

                 aSer = #dscam003@#0;
                 aCli = #dscam003@#32;
                 aNomCli = #dscam003@#6;
                 nImpo = -nCobro;
                 eaTag   = "CB"; |HAZ Riesgos;
                 |CIERRA #dscam003@; |CIERRA #dscam004@;
              |FINSI;
              |DESCARGA_DEF #dscam004@;
           |FINSI;
           |DESCARGA_DEF #dscam003@;
        |FINSI;
        |CIERRA #dscam045@; |DESCARGA_DEF #dscam045@;
     |FINSI;
|FPRC;

|PROCESO Recibo;
     #91#0 = #134#11;
     |LEE 000#91=;
     num = #91#3;
||     importe = (#134#31 - #134#32 ) ! EURODB;
     importe = #134#31 ! EURODB;

     |SI importe < 0; |Y #134#31 > 0;
||          |ACABA;   || no puede ser negativo
     |FINSI;

     |SI importe < 0;
          tipo_imp = -1;
          importe = -importe;
     |SINO;
          tipo_imp = 1;
     |FINSI;
     |SI EURODB = 2; importe = (importe * 100) ! 0; |FINSI;
     resto = importe $ num;
     importe = importe / num;
     redondeo = importe ! 0;
     |SI redondeo ! importe;                 || trunca importe
          |SI redondeo > importe;
               importe = redondeo - 1;
          |SINO;
               importe = redondeo;
          |FINSI;
     |FINSI;

     |SI #91#5 = "N";
         em = 1;
     |SINO;
         em = 1000;
     |FINSI;

     nVto = 0;
     fecha_fac = #134#1;
     |PARA i = 1;|SI i [ num; |HACIENDO i = i + 1;
          k = i + 5;
          |DDEFECTO #133;
          #133#4 = #134#49; ||serie;
          #133#0 = #134#0;||numero factura;
          #133#1 = i;   ||numero linea;
          |LEE 101#133=;
          |SI FSalida ! 0;
               |GRABA 021#133b;
          |FINSI;
          |HAZ vencical;
          nVto = nVto + 1;
          |GRABA 021#133a;
          |LIBERA #133;
     |SIGUE;

     nRecibo = 1;
     |ABRE #177;
     |HAZ AbreRecVenta;
     #133#4 = #134#49;
     #133#0 = #134#0;
     #133#1 = 0;
     |LEE 000#133];
     |PARA; |SI FSalida = 0; |Y #133#4 = #134#49; |Y #133#0 = #134#0; |HACIENDO;
          |DDEFECTO #11;
          #11#17 = #134#49;
          #11#0 = #134#0;
          #11#1 = #133#1;           || Linea;
          #11#2 = #134#2;            || cliente
          #11#3 = #134#3;            || nombre del cliente
          #11#4 = #134#9;            || Banco
          #11#5 = "S";             || domiciliado
          #11#6 = "N";             || aceptado
          #11#7 = #134#1;            || fecha de emision
          #11#8 = #133#3;           || Fecha de vencimiento
          #11#9 = #133#2;           || Importe
          #11#10 = "N";            || Impreso
          #11#11 = "N";            || Contabilizado
          |SI #142#63 = "S";     ||  COGE LA CTA.CONTABLE DEL TIPO DE RECIBO.
               #177#0 = #91#69;
               |LEE 000#177=;
               |SI FSalida = 0;
                    #11#12 = #177#3;     || NUMERO CTA.CONTABLE.
               |SINO;
                    #11#12 = #134#12;     || NUMERO CTA.CONTABLE.
               |FINSI;
          |SINO;
               #11#12 = #134#12;     || NUMERO CTA.CONTABLE.
          |FINSI;
          #11#22 = "Cobrado";
          #11#24 = #134#11;          || Forma de Pago
          #11#25 = #91#1;           || Descripcion de la forma de Pago
          #11#14 = "N";            || Impagado
          #11#15 = #24#161;         || A aceptar
          #11#21 = #91#69;          || Tipo de Recibo (forma de pago)
          |SI nRecibo = nVto; |Y #91#70 ! 0;
               #11#21 = #91#73;          || Tipo de Recibo (Fianza Retenida)
          |FINSI;
          #11#23 = nVto;
          #11#24 = #91#0;
          #11#25 = #91#1;
          eaProg = "agifa134";
          |HAZ RecVenta;
          |LEE 000#133s;
          nRecibo = nRecibo + 1;
     |SIGUE;
     |HAZ CierraRecVenta;
     |CIERRA #177;

     |SI #134#32 < 0;
          nAbo = -1;
     |SINO;
          nAbo = 1;
     |FINSI;

     nImpCobro = #134#32 * nAbo;
     #133#4 = #134#49;
     #133#0 = #134#0;
     #133#1 = 0;
     |LEE 000#133];
     |PARA; |SI FSalida = 0; |Y #133#4 = #134#49; |Y #133#0 = #134#0; |HACIENDO;
          nNume = #133#2 * nAbo;
          |SI nImpCobro > 0;
               |SI nImpCobro > nNume;
                    nCobro = nNume;
                    nImpCobro = nImpCobro - nCobro;
               |SINO;
                    nCobro = nImpCobro;
                    nImpCobro = 0;
               |FINSI;
               nCobro = nCobro * nAbo;
               |HAZ Cobro;
          |FINSI;
          |LEE 000#133s;
     |SIGUE;
|FPRC;

|PROCESO Factura;
     |DDEFECTO #134;
     #134#49 = aSer;
     #134#0 = aNum;
     #134#1 = #10#1;
     #134#2 = #10#3;
     #134#3 = #10#4;
     #134#7 = #10#6;
     #134#9 = #24#29;
     #134#10 = #24#30;
     #134#11 = #10#8;
     #134#12 = #24#16;
     #134#14 = #24#22;
     #134#15 = #24#23;
     #134#16 = #24#24;
     #134#18 = #10#15;
     #134#21 = #10#16;
     #134#22 = #10#17;
     #134#24 = #10#19;
     #134#25 = #10#20;
     #134#27 = #10#22;
     #134#28 = #10#23;
     #134#29 = #10#24;
     #134#33 = #10#44;
     #134#34 = #10#45;
     #134#36 = #10#47;
     #134#37 = #10#48;
     #134#45 = "S";

     enTiva = 1; efFiva = #134#1; |HAZ SacaIVA;
     #134#39 = enIva;
     #134#40 = enRec;
     enTiva = 2; efFiva = #134#1; |HAZ SacaIVA;
     #134#41 = enIva;
     #134#42 = enRec;
     enTiva = 3; efFiva = #134#1; |HAZ SacaIVA;
     #134#43 = enIva;
     #134#44 = enRec;
     enTiva = 4; efFiva = #134#1; |HAZ SacaIVA;
     #134#50 = enIva;
     #134#51 = enRec;
     enTiva = 5; efFiva = #134#1; |HAZ SacaIVA;
     #134#52 = enIva;
     #134#53 = enRec;

     #134#31 = #134#18 - #134#17;
     #134#31 = #134#31 + #134#29;
     #134#31 = #134#31 + #134#30;
     #134#31 = #134#31 + #134#19;
     #134#31 = #134#31 + #134#20;

     #134#32 = aCobra;   || Pasa lo cobrado a entrega a cta

     #134#58 = #10#68;
     #134#59 = #10#69;
     #134#60 = #10#70;
     #134#61 = #10#73;
     #134#62 = #10#74;
     |GRABA 020#134b;

     |DDEFECTO #59;
     #59#14 = aSer;
     #59#0 = aNum;
     #59#1 = 1;
     #59#2 = aNum;
     #59#3 = #10#15;
     #59#7 = #10#16;
     #59#8 = #10#19;
     #59#9 = #10#22;
     #59#10 = #10#24;
     #59#11 = #10#15 + #10#24;
     #59#13 = #10#15;
     #59#15 = #10#52;
     #59#18 = #10#68;
     #59#19 = #10#69;
     #59#20 = #10#70;
     |GRABA 020#59n;
     |HAZ CalCabAgifa134;

     #134#32 = aCobra;   || Al calcular se pone a o el a cuenta
     aCobra = "";        || lo pongo a 0 para que no cree cobros
     |GRABA 020#134a;
     |LIBERA #134;
|FPRC;

|PROCESO Linea;
     nLinea = nLinea + 1;
     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = nLinea;
     #71#2 = "TELEFONO";
     #71#3 = 1;
     #71#4 = "Facturaci¢n telefonia";
     #71#5 = 1;
     #71#6 = nBase;
     #71#9 = nBase;
     #71#11 = nTiva;
     #71#15 = #10#3;
     #71#16 = #10#34;
     #71#17 = #10#35;
     |HAZ TotalLin71;
     |GRABA 020#71n;
|FPRC;

|PROCESO AcuCab;
     |SI nTiva = 0;
          #10#28 = nBase;
     |FINSI;
     |SI nTiva = 1;
          #10#16 = nBase;
          #10#17 = nCuota;
     |FINSI;
     |SI nTiva = 2;
          #10#19 = nBase;
          #10#20 = nCuota;
     |FINSI;
     |SI nTiva = 3;
          #10#22 = nBase;
          #10#23 = nCuota;
     |FINSI;
     |SI nTiva = 4;
          #10#44 = nBase;
          #10#45 = nCuota;
     |FINSI;
     |SI nTiva = 5;
          #10#47 = nBase;
          #10#48 = nCuota;
     |FINSI;

     #10#24 = #10#17 + #10#20 + #10#23 + #10#45 + #10#48;
     #10#15 = #10#28 + #10#16 + #10#19 + #10#22 + #10#44 + #10#47;
|FPRC;

|PROCESO BuscaIVA;
     |ABRE #66;
     nError = 1;
     |LEE 000#66p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          |SI nIva = #66#2;
               nError = 0;
               nTiva = #66#0;
               |SAL;
          |FINSI;
          |LEE 000#66s;
     |SIGUE;
     |CIERRA #66;
|FPRC;

|PROCESO BuscaCli;
     aCli = "";
     |LEE 000#24p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          aAlfa = #24#15; |QBF aAlfa;
          |QBF aNif;
          |SI aAlfa = aNif;
               aCli = #24#0; |SAL;
          |FINSI;
          |LEE 000#24s;
     |SIGUE;
     |SI aCli = "";
          |LEE 101#3=;
          |SI FSalida ! 0; |GRABA 020#3b; |FINSI;
          |PARA; |SI; |HACIENDO;
               aCli = ("000000" + #3#1) % -106;
               #24#0 = aCli;
               |LEE 000#24=;
               #3#1 = #3#1 + 1;
               |SI FSalida ! 0; |SAL; |FINSI;
          |SIGUE;
          |GRABA 020#3a;
          |LIBERA #3;
          |DDEFECTO #24;
          #24#0 = aCli;
          #24#15 = aNif;
          #24#1 = aRazon;
          #24#2 = aNom;

          #24#5 = aDomi;
          #24#11 = aDomi;
          #24#8 = aDomi;

          #24#6 = aPobla;
          #24#9 = aPobla;
          #24#12 = aPobla;

          #24#7 = aProvi;
          #24#13 = aProvi;
          #24#10 = aProvi;

          #24#20 = aFP;

          aCuenta = "43" + #24#0;

          #24#16 = aCuenta;


          #24#17 = aTlf;
          aCp1 = aCP % 102; aCp2 = aCP % 303;
          #24#178 = aCp1;
          #24#179 = aCp1;
          #24#180 = aCP;
          #24#184 = aCp1;
          #24#185 = aCp2;
          #24#186 = aCP;
          #24#181 = aCp1;
          #24#182 = aCp2;
          #24#183 = aCP;
          |GRABA 020#24n;
     |FINSI;
|FPRC;

|PROCESO Albaran;
     |QBF aNum;
     |SI aNum = ""; |ACABA; |FINSI;

     #134#49 = aSer;
     #134#0 = aNum;
     |LEE 000#134=;
     |SI FSalida = 0;
          aAlfa = "0000Ya existe la factura:" + aSer + "/" + aNum;
          |MENAV aAlfa; |ACABA;
     |FINSI;

     |DDEFECTO #10;
     #10#52 = aSer;
     #10#0 = aNum;
     |LEE 000#10=;
     |SI FSalida = 0;
          aAlfa = "0000Ya existe el albaran:" + aSer + "/" + aNum;
          |MENAV aAlfa; |ACABA;
     |FINSI;

     #1#1 = aFP;
     |LEE 000#1=;
     |SI FSalida ! 0;
          aAlfa = "0000No existe F.Pago '" + aFP + "'. No se importa:" + aSer + "/" + aNum;
          |MENAV aAlfa; |ACABA;
     |FINSI;
     aFP = #1#2;

     nIva = aIva1;
     |HAZ BuscaIVA;
     |SI nError ! 0; |Y aB1 ! 0;
          aAlfa = "0000No existe IVA '" + nIva + "'. No se importa:" + aSer + "/" + aNum;
          |MENAV aAlfa; |ACABA;
     |FINSI;
     nIva = aIva2;
     |HAZ BuscaIVA;
     |SI nError ! 0; |Y aB2 ! 0;
          aAlfa = "0000No existe IVA '" + nIva + "'. No se importa:" + aSer + "/" + aNum;
          |MENAV aAlfa; |ACABA;
     |FINSI;
     nIva = aIva3;
     |HAZ BuscaIVA;
     |SI nError ! 0; |Y aB3 ! 0;
          aAlfa = "0000No existe IVA '" + nIva + "'. No se importa:" + aSer + "/" + aNum;
          |MENAV aAlfa; |ACABA;
     |FINSI;

     |GRABA 020#10b;

     aFec = (aFec % 102) + "." + (aFec % 402) + "." + (aFec % 704);

     |DDEFECTO #24;

     #2#1 = aCli;
     |LEE 000#2=;
     |SI FSalida = 0;
          aCli = #2#2;

          #10#1 = aFec;
          #10#3 = aCli;
          #10#63 = aNif;
          #10#4 = aRazon;
          #10#29 = aRazon;
          aCp1 = aCP % 102; aCp2 = aCP % 303;
          #10#64 = aCp1;
          #10#65 = aCp2;
          #10#30 = aDomi;
          #10#31 = aPobla;
          #10#33 = aProvi;
          #10#8 = aFP;
          #10#66 = aTlf;

          #24#0 = aCli;
          |LEE 000#24=;
     |SINO;
          |HAZ BuscaCli;
          #24#0 = aCli;
          |LEE 020#24=;

          #10#1 = aFec;
          #10#3 = #24#0;
          #10#63 = #24#15;
          #10#4 = #24#1;
          #10#29 = #10#4;
          #10#64 = #24#181;
          #10#65 = #24#182;
          #10#30 = #24#5;
          #10#31 = #24#9;
          #10#33 = #24#10;
          #10#8 = aFP;
          #10#66 = #24#17;
     |FINSI;
     #10#61 = aCobra;

     nLinea = 0;
     |SI aB1 ! 0;
          nIva = aIva1; |HAZ BuscaIVA;
          nBase = aB1; nCuota = aCuota1;
          |HAZ AcuCab;
          |HAZ Linea;
     |FINSI;
     |SI aB2 ! 0;
          nIva = aIva2; |HAZ BuscaIVA;
          nBase = aB2; nCuota = aCuota2;
          |HAZ AcuCab;
          |HAZ Linea;
     |FINSI;
     |SI aB3 ! 0;
          nIva = aIva3; |HAZ BuscaIVA;
          nBase = aB3; nCuota = aCuota3;
          |HAZ AcuCab;
          |HAZ Linea;
     |FINSI;
     #10#10 = "S";
     #10#38 = "S";
     #10#39 = aNum;
     #10#53 = aSer;
     #10#67 = "S";
     #10#68 = #24#192;

     |ABRE #324;
     #324#0 = #10#68;
     |LEE 000#324=;
     #10#69 = #324#2;

     #10#70 = #24#193;
     #10#73 = #321#9;

     #324#0 = #10#73;
     |LEE 000#324=;
     #10#74 = #324#2;
     |CIERRA #324;

     |HAZ LimCabAgifa010;
     |BUCLELIN 2 CalCabAgifa010 #10;

     |GRABA 020#10a;
     |LIBERA #10;

     |HAZ Factura;

     |ABRE #133;
     |ABRE #134;
    ||ABRE #174;
    ||ABRE #114;
     |ABRE #91;
     |HAZ Recibo;
     |CIERRA #91;
    ||CIERRA #114;
    ||CIERRA #174;
     |CIERRA #134;
     |CIERRA #133;

     #24#0 = #10#3;
     |LEE 101#24=;
     |SI FSalida = 0;
          nNume1 = aTota;
          nNume2 = aCobra;
          #24#49 = #24#49 + (nNume1 - nNume2); ||Riesgo
          #24#110 = #24#110 + nNume1;
          #24#46 = nNume1;
          #24#45 = #10#1;

          aAlfa = #10#1 % 402;
          nNume2 = aAlfa;
          nNume2 = (nNume2 - 1) * 4 + 54;
          #24nNume2 = #24nNume2 + nNume1;
          #24#102 = #24#102 + nNume1;

          |GRABA 020#24a;
          |LIBERA #24;
     |FINSI;

|FPRC;

|PROCESO Registro;
     |SI aAlfa1 = ""; |O aAlfa2 = "";
          |ACABA;
     |FINSI;
     aSer = aAlfa1 %     102;
     aNum = aAlfa1 %     306; |QBF aNum; aNum = ("000000" + aNum) % -106;
     aFec = aAlfa1 %     910;
     aCli = aAlfa1 %    1906;
     aNif = aAlfa1 %    2515;
     aRazon = aAlfa1 %  4030; || Razon social
     aNom = aAlfa1 %    7030; || Nombre Comercial
     aDomi = aAlfa1 %  10028;
     aCP = aAlfa1 %    12805;
     aPobla = aAlfa1 % 13328;
     aProvi = aAlfa1 % 16115;
     aFP = aAlfa1 %    17602;
     aTlf = aAlfa1 %   17815;

     aB1 = aAlfa2 %      110;
     aIva1 = aAlfa2 %   1105;
     aCuota1 = aAlfa2 % 1610;
     aB2 = aAlfa2 %     2610;
     aIva2 = aAlfa2 %   3605;
     aCuota2 = aAlfa2 % 4110;
     aB3 = aAlfa2 %     5110;
     aIva3 = aAlfa2 %   6105;
     aCuota3 = aAlfa2 % 6610;
     aTota = aAlfa2 %   7610;
     aCobra = aAlfa2 %  8610;

     |ABRE #1; |SELECT #2#1;
     |ABRE #2; |SELECT #2#2;
     |ABRE #3;
     |ABRE #10;
     |ABRE #71;
     |ABRE #24;
     |ABRE #134;
     |ABRE #59;
     |HAZ Albaran;
     |CIERRA #59;
     |CIERRA #134;
     |CIERRA #24;
     |CIERRA #71;
     |CIERRA #10;
     |CIERRA #3;
     |CIERRA #2;
     |CIERRA #1;
|FPRC;

|PROCESO Caracter;
     |SI aCar = aFin;
          |HAZ Registro;
          nCar = 0;
          aAlfa1 = "";
          aAlfa2 = "";
     |SINO;
          |SI aCar ! aRetorno;
               |SI nCar [ 191;
                    aAlfa1 = aAlfa1 + aCar;
               |SINO;
                    aAlfa2 = aAlfa2 + aCar;
               |FINSI;
               nCar = nCar + 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;
     aRetorno = &13;
     aFin = &10;
     aFic = #0#1; |QBF aFic;
     |XABRE "BC", aFic, nHandle;
     |SI FSalida ] 0;
          |XLEE nHandle, 250, aTmp;
          |PARA; |SI FSalida > 0; |HACIENDO;
               |PARA; |SI aTmp ! ""; |HACIENDO;
                    aCar = aTmp % 101;
                    |SI aTmp = aCar;
                         aTmp = ""; ||con un caracter falla: "aTmp = aTmp % 2"
                    |SINO;
                         aTmp = aTmp % 2;
                    |FINSI;
                    |HAZ Caracter;
               |SIGUE;
               |XLEE nHandle, 250, aTmp;
          |SIGUE;
          |XCIERRA nHandle;
          |SI aAlfa2 ! ""; |HAZ Registro; |FINSI;
     |SINO;
          |MENAV "0000Error al abrir el fichero...";
     |FINSI;
|FPRC;

|PROCESO Boton;
     |PTEC 824;
|FPRC;

|PROCESO Browser;
     |SI FSalida ! 10; |ACABA; |FINSI;

     aRuta = #0#1;  |QBF aRuta;
     aRuta = "F" + aRuta;

     |BROWSE aRuta;

     aRuta = aRuta % 2;
     |SI aRuta = "F"; aRuta = ""; |FINSI;

     #0#1 = aRuta;
     |PINTA #0#1;
     |QBF aRuta;
     |SI aRuta = ""; |ERROR; |FINSI;

     |HAZ Pone;
|FPRC;

|PROCESO Quita; |TIPO 0;
     |ESTADO_CONTROL nBoton, "DISABLE";
|FPRC;

|PROCESO Pone; |TIPO 7;
     |ESTADO_CONTROL nBoton, "ENABLE";
|FPRC;

|PROGRAMA;
     |ABRE #321; |LEE 000#321p; |CIERRA #321;

     |CONTROL_SIMPLE 0, "BOTON,  Fichero ", 1015, 1023, Boton;
     nBoton = FSalida;

     |ABRE #0;
     |LEE 101#0=;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;
     |CLS;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |GRABA 020#0a;
     |FINSI;
     |CIERRA #0;

     |FIN_CONTROL_WINDOWS nBoton;
     |PULSATECLA;
|FPRO;
