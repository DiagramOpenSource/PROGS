|FICHEROS;
     agifm001 #1;
     agifa104 #104;
     agifa019 #19;
     agifa024 #24;
     agifa073 #73;
     agifa142;

     agit0000;

     dsm00087@;
     ortsm016@;
     ortsm008@;
     dsm00087@;
     referen@ #200;
|FIN;

|VARIABLES;
     &enEstaDentro = 0; || sirve para evitar reentradas
     i = 0;
     aPath = "";
     aAlfa = "";
     nTipo = 0;
     aSer = "";
     aNum = "";
     aTipo = "";
     nContaLog = 0;
     aUsu = "";
     aDocu = "";
     nReg = 0;
     nDistribuidor = 0;
     nPdt1         = 0;
     nPdt2         = 0;
|FIN;

|PROCESO EsIber__21; ||Igual que EsIber21
     |DBASE aPath;
     aPath = aPath + "/bin/iber0001.tab";
     |XABRE "E", aPath, 0;
|FPRC;

|PROCESO Es_Orts;   || Igual que EsOrts
     |DBASE aPath;
     aPath = aPath + "/def/ortsm001.mas";
     |XABRE "E", aPath, 0;
     |SI FSalida = 0;
          |HAZ EsIber__21;
          |SI FSalida = 0;
              FSalida = 1;
          |SINO;
              FSalida = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Es_Fergalsan;       || 005033
     |DBASE aPath;
     aPath = aPath + "def/fergam01.mas";
     |XABRE "E", aPath, 0;
     |SI FSalida ] 0;
          |HAZ EsIber__21;
          |SI FSalida ] 0;
               FSalida = 1;
          |SINO;
               FSalida = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO agifa073_agit;
     nPdt1 = #agifa073#5  - #agifa073#43;
     nPdt2 = #agifa073#44 - #agifa073#49;

     |SI #agifa019#79 = "N"; |O #agifa142#117 = "N";    || sin doble
          |SI nPdt1 ! 0;
              #agit0000#3 = "N";
          |FINSI;
     |SINO;
          |SI #agifa142#224 = "B";
               |SI nPdt1 ! 0; |O nPdt2 ! 0;
                   #agit0000#3 = "N";
               |FINSI;
          |SINO;
               |SI nPdt1 ! 0; |Y nPdt2 ! 0;
                   #agit0000#3 = "N";
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #agit0000#3 = "N";
         |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE agifa073_agit;
     #agifa073#1;
     ;
     #agifa104#25, #agifa104#0, 001;
     #agifa104#25, #agifa104#0, 999;
     ;
     NULL, agifa073_agit;
|FINSI;

|PROCESO CtrlPedPdte;
     #agit0000#0 = #agifa104#25;
     #agit0000#1 = #agifa104#0;
     |LEE 101#agit0000.=;
     |SI FSalida ! 0;
         |DDEFECTO #agit0000;
         #agit0000#0 = #agifa104#25;
         #agit0000#1 = #agifa104#0;
         |GRABA 020#agit0000.b;
     |FINSI;

     #agit0000#2 = #agifa104#4;
     #agit0000#3 = "S";

     |BUCLE agifa073_agit;

     |GRABA 020#agit0000.a;
     |LIBERA #agit0000;
     |CIERRA #agit0000;
|FPRC;

|PROCESO &T104_15; |TIPO 15;
     |HAZ Es_Fergalsan;
     |SI FSalida = 0;
         |ABRE #agifa142;
         |LEE 000#agifa142.p;
         |SI FSalida ! 0;  |DDEFECTO #agifa142;  |FINSI;
         |CIERRA #agifa142;

         |ABRE #agit0000;
         |ABRE #agifa019;
         |HAZ CtrlPedPdte;
         |CIERRA #agifa019;
         |CIERRA #agit0000;
     |FINSI;

     |SI enEstaDentro = 1; |ACABA; |FINSI;
     enEstaDentro = 1;

     nTipo = 15; |HAZ Log104;

     enEstaDentro = 0;
|FPRC;

|PROCESO &T104_16; |TIPO 16;
     |HAZ Es_Fergalsan;
     |SI FSalida = 0;
         |ABRE #agifa142;
         |LEE 000#agifa142.p;
         |SI FSalida ! 0;  |DDEFECTO #agifa142;  |FINSI;
         |CIERRA #agifa142;

         |ABRE #agit0000;
         |ABRE #agifa019;
         |HAZ CtrlPedPdte;
         |CIERRA #agifa019;
         |CIERRA #agit0000;
     |FINSI;

     |SI enEstaDentro = 1; |ACABA; |FINSI;
     enEstaDentro = 1;

     nTipo = 16; |HAZ Log104;

     aTipo = "M";
     aDocu = "agifa104";
     |HAZ CongeCopiaPed;

     enEstaDentro = 0;
|FPRC;

|PROCESO &T104_17; |TIPO 17;
     |HAZ Es_Fergalsan;
     |SI FSalida = 0;
         |ABRE #agit0000;
         #agit0000#0 = #agifa104#25;
         #agit0000#1 = #agifa104#0;
         |LEE 101#agit0000.=;
         |SI FSalida = 0;
             |BORRA 020#agit0000.a;
             |LIBERA #agit0000;
         |FINSI;
         |CIERRA #agit0000;
     |FINSI;

     |SI enEstaDentro = 1; |ACABA; |FINSI;
     enEstaDentro = 1;

     nTipo = 17; |HAZ Log104;

     enEstaDentro = 0;
|FPRC;

|PROCESO &T73_15; |TIPO 15;
     |SI enEstaDentro = 1; |ACABA; |FINSI;
     enEstaDentro = 1;

     |HAZ Es_Orts;
     |SI FSalida = 0;
          |HAZ OrtsLinAlbGra;
     |FINSI;

     aTipo = "A";
     aDocu = "agifa073";
     |HAZ CongeCopiaPed;

     enEstaDentro = 0;
|FPRC;

|PROCESO &T73_16; |TIPO 16;
     |SI enEstaDentro = 1; |ACABA; |FINSI;
     enEstaDentro = 1;

     |HAZ Es_Orts;
     |SI FSalida = 0;
          |HAZ OrtsLinAlbMod;
     |FINSI;

     aTipo = "M";
     aDocu = "agifa073";
     |HAZ CongeCopiaPed;

     enEstaDentro = 0;
|FPRC;

|PROCESO &T73_17; |TIPO 17;
     |SI enEstaDentro = 1; |ACABA; |FINSI;
     enEstaDentro = 1;

     |HAZ Es_Orts;
     |SI FSalida = 0;
          |HAZ OrtsLinAlbBor;
     |FINSI;

     aTipo = "B";
     aDocu = "agifa073";
     |HAZ CongeCopiaPed;

     enEstaDentro = 0;
|FPRC;

|PROCESO OrtsLinAlbGra;
     |DDEF aPath;
     aPath = aPath + "ortsm016.mas";
     |CARGA_DEF aPath, ortsm016@;
     |SI FSalida = 0;
          |ABRE #ortsm016@;
          #ortsm016@#28 = #73#28;
          #ortsm016@#0 = #73#0;
          #ortsm016@#1 = #73#1;
          |GRABA 000#ortsm016@.n;
          |CIERRA #ortsm016@;
          |DESCARGA_DEF #ortsm016@;
     |SINO;
          |MENAV  "0000Error al cargar 'ortsm016'";
     |FINSI;
|FPRC;

|PROCESO OrtsLinAlbMod;
     |DDEF aPath;
     aPath = aPath + "ortsm016.mas";
     |CARGA_DEF aPath, ortsm016@;
     |SI FSalida = 0;
          |DDEF aPath;
          aPath = aPath + "ortsm008.mas";
          |CARGA_DEF aPath, ortsm008@;
          |SI FSalida = 0;
               |DDEFECTO #ortsm008@;
               |ABRE #ortsm008@;
               #ortsm008@#0 = #73#28;
               #ortsm008@#1 = #73#0;
               #ortsm008@#2 = #73#1;
               |LEE 000#ortsm008@.=;
               |GRABA 000#ortsm008@.a;
               |CIERRA #ortsm008@;

               |ABRE #ortsm016@;
               #ortsm016@#28 = #73#28;
               #ortsm016@#0 = #73#0;
               #ortsm016@#1 = #73#1;
               |LEE 101#ortsm016@.=;
               |SI FSalida ! 0; |GRABA 020#ortsm016@.b; |FINSI;
               |PARA i = 0; |SI i [ 58; |HACIENDO i = i + 1;
                    #ortsm016@#i# = #73i;
               |SIGUE;
               #ortsm016@#59 = #ortsm008@#3;
               #ortsm016@#60 = #ortsm008@#4;
               |GRABA 020#ortsm016@.a;
               |CIERRA #ortsm016@;
               |DESCARGA_DEF #ortsm008@;
          |FINSI;
          |DESCARGA_DEF #ortsm016@;
     |SINO;
          |MENAV  "0000Error al cargar 'ortsm016'";
     |FINSI;
|FPRC;

|PROCESO OrtsLinAlbBor;
     |DDEF aPath;
     aPath = aPath + "ortsm016.mas";
     |CARGA_DEF aPath, ortsm016@;
     |SI FSalida = 0;
          |ABRE #ortsm016@;
          #ortsm016@#28 = #73#28;
          #ortsm016@#0 = #73#0;
          #ortsm016@#1 = #73#1;
          |BORRA 000#ortsm016@.c;
          |CIERRA #ortsm016@;
          |DESCARGA_DEF #ortsm016@;
     |SINO;
          |MENAV  "0000Error al cargar 'ortsm016'";
     |FINSI;
|FPRC;

|PROCESO Log104;
     |DDEF aAlfa;
     aAlfa = aAlfa + "dsm00087";
     |CARGA_DEF aAlfa, dsm00087@;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aSer = #104#25;
     aNum = ("000000" + #104#0) % -106;
     aTipo = "PV";

     |ABRE #dsm00087@;
     |DDEFECTO #dsm00087@;
     |SELECT #2#dsm00087@;
     #dsm00087@#1 = aSer;
     #dsm00087@#2 = aNum;
     #dsm00087@#3 = aTipo;
     |LEE 101#dsm00087@.=;
     |SI FSalida ! 0;
          |SELECT #1#dsm00087@;
          |LEE 000#dsm00087@.u;
          |SI FSalida = 0;
               nContaLog = #dsm00087@#0 + 1;
          |SINO;
               nContaLog = 1;
          |FINSI;
          |DDEFECTO #dsm00087@;
          #dsm00087@#0 = nContaLog;
          #dsm00087@#1 = aSer;
          #dsm00087@#2 = aNum;
          #dsm00087@#3 = aTipo;
          |GRABA 020#dsm00087@.b;
     |FINSI;
     |SI FSalida = 0;
          |HORA aAlfa;
          aUsu = Usuario % 810;
          |SI nTipo = 15;
               #dsm00087@#4 = aUsu;
               #dsm00087@#5 = ~;
               #dsm00087@#6 = aAlfa;
               #dsm00087@#7 = "";
               #dsm00087@#8 = "01.01.0000";
               #dsm00087@#9 = ""
               #dsm00087@#10 = "";
               #dsm00087@#11 = "01.01.0000";
               #dsm00087@#12 = ""
          |FINSI;
          |SI nTipo = 16;
               #dsm00087@#7 = aUsu;
               #dsm00087@#8 = ~;
               #dsm00087@#9 = aAlfa;
          |FINSI;
          |SI nTipo = 17;
               #dsm00087@#10 = aUsu;
               #dsm00087@#11 = ~;
               #dsm00087@#12 = aAlfa;
          |FINSI;
          |GRABA 020#dsm00087@.a;
     |FINSI;
     |CIERRA #dsm00087@;
     |DESCARGA_DEF #dsm00087@;
|FPRC;

|PROCESO cong0002Ped;
     |SI #referen@#42 = 0; ||Ya tiene albaran
          aAlfa = #24#166; aAlfa = aAlfa > ""; |QBT aAlfa;
          #referen@#2 = aAlfa;
          |SI #referen@#2 = "SI";
               #referen@#1 = #24#168;
          |SINO;
               #referen@#1 = #104#4;
          |FINSI;
          #referen@#4 = #104#1;
          #referen@#5 = #104#2;
          #referen@#9 = #24#2;
          #referen@#10 = #24#1;
          #referen@#11 = #24#15;
          #referen@#12 = #24#8;
          #referen@#13 = #24#9;
          #referen@#14 = #24#10;
          #referen@#15 = #24#183;
          #referen@#16 = #24#17;
          #referen@#17 = #24#18;
          #referen@#18 = #1#1;
          #referen@#19 = #24#159;
          aAlfa = ("000000" + #104#0) % -106;
          #referen@#20 = aAlfa;
          #referen@#32 = #104#15;
          |GRABA 020#referen@.a;
     |FINSI;
|FPRC;

|DEFBUCLE cong0002Ped;
     #referen@#2003;
     ;
     #104#25, #104#0, 001;
     #104#25, #104#0, 999;
     be;
     NULL, cong0002Ped;
|FIN;

|PROCESO CongeUltRegPed;
     |SELECT #1#referen@;
     |LEE 000#referen@.u;
     |SI FSalida = 0;
          nReg = #referen@#47 + 1;
     |SINO;
          nReg = 1;
     |FINSI;
     |SELECT #2#referen@;
|FPRC;

|PROCESO CongeCopiaPed;
     |DDEF aPath;
     aAlfa = aPath + "cong0001.mas";
     |XABRE "E", aAlfa, 0;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |SI aDocu = "agifa104";
          |ABRE #24;
          #24#0 = #104#4;
          |LEE 000#24=;
          |SI FSalida ! 0; |DDEFECTO #24; |FINSI;
          |CIERRA #24;
     |SINO;
          |ABRE #24;
          #24#0 = #73#20;
          |LEE 000#24=;
          |SI FSalida ! 0; |DDEFECTO #24; |FINSI;
          |CIERRA #24;
     |FINSI;
     |SI #24#111 = "N"; |ACABA; |FINSI;

     nDistribuidor = -1;
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@; |LEE 000#referen@.p; |CIERRA #referen@;
          |SI aDocu = "agifa104";
               nDistribuidor = #referen@#1;
          |SINO;
               |PARA i = 2; |SI i [ 11; |HACIENDO i = i + 1;
                    |SI #73#18 = #referen@#i#;
                         nDistribuidor = #referen@#1; |SAL;
                    |FINSI;
               |SIGUE;
          |FINSI;
          |DESCARGA_DEF #referen@;
     |FINSI;
     |SI nDistribuidor ] 0;
          aAlfa = aPath + "cong0002";
          |CARGA_DEF aAlfa, referen@;
          |SI FSalida = 0;
               |SI aDocu = "agifa104";
                    |ABRE #1;
                    #1#0 = #24#3;
                    |LEE 000#1=;
                    |SI FSalida ! 0; |DDEFECTO #1; |FINSI;
                    |CIERRA #1;
                    |BUCLE cong0002Ped;
               |FINSI;
               |SI aDocu = "agifa073";
                    |ABRE #19;
                    #19#0 = #73#2;
                    |LEE 000#19=;
                    |SI FSalida ! 0; |DDEFECTO #19; |FINSI;
                    |CIERRA #19;

                    |ABRE #referen@; |SELECT #2#referen@;
                    #referen@#38 = #73#28;
                    #referen@#39 = #73#0;
                    #referen@#40 = #73#1;
                    |LEE 101#referen@.=;
                    |SI aTipo = "B";
                         |SI FSalida = 0;
                              #referen@#24 = 0;
                              #referen@#26 = "N";
                              #referen@#28 = 0;
                              #referen@#29 = 0;
                              |GRABA 020#referen@.a;
                         |FINSI;
                    |SINO;
                         |SI FSalida ! 0;
                              |HAZ CongeUltRegPed;
                              |DDEFECTO #referen@;
                              #referen@#47 = nReg;
                              #referen@#38 = #73#28;
                              #referen@#39 = #73#0;
                              #referen@#40 = #73#1;
                              |GRABA 020#referen@.b;
                         |FINSI;
                         |SI #referen@#42 = 0; ||Ya tiene albaran
                              #referen@#0 = nDistribuidor;
                              #referen@#22 = #19#134;
                              #referen@#23 = "S";
                              #referen@#24 = #73#5;
                              #referen@#25 = #19#5;
                              |SI #73#6 = 0;
                                   #referen@#26 = "S";
                              |SINO;
                                   #referen@#26 = "N";
                              |FINSI;
                              #referen@#27 = #73#45;
                              #referen@#28 = #73#7;
                              #referen@#29 = #73#9;
                              #referen@#30 = "EUR";
                              #referen@#31 = #19#112;
                              |GRABA 020#referen@.a;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |CIERRA #referen@;
               |DESCARGA_DEF #referen@;
          |FINSI;
     |FINSI;
|FPRC;
