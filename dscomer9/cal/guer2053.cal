     || Actualizar

|FICHEROS;
     guerm053 #0;
     guerm054 #1;
     gotrabaj #2;
     gopartia #3;
     goptrbli #4;
     gopartli #5;
     gotipoho #6;
     gopartca #7;
     guerm017 #17;
     guerm018 #18;
     dsw00080 #80; ||Tmp para recalcular
|FIN;

|VARIABLES;
     &Tempo = "";
     nImpAntes = 0;
     aAlfa = "";
     aDFecha = "";
     aHFecha = "";
     i = 0;
     fFecha = @;
     aMes = "";
|FIN;

|PROCESO goptrbli;
     #2#0 = #4#4;
     |LEE 000#2=;
     |SI #2#128 = "N"; |ACABA; |FINSI; ||computa Dietas

     #1#0 = #0#0;
     #1#1 = #0#1;
     #1#2 = #4#4;
     |LEE 000#1=;
     |SI FSalida = 0;
          #6#0 = #4#26;
          |LEE 000#6=;
          |SI FSalida = 0; |Y #6#12 = "S";
               #3#41 = #1#11;
               #3#49 = #1#11;
               #3#12 = #1#11;
               #3#23 = #1#11;
               #3#50 = 0
               #3#51 = 0;
               #3#52 = 0;
               #3#42 = 0;
               #3#43 = 0;
               #3#44 = 0;
               |HAZ CalcuGopartia;
               |GRABA 020#3a;
               |LIBERA #3;

               nImpAntes = #4#17;

               #4#13 = #1#11;
               #4#17 =  #4#11 * #4#13;
               |GRABA 020#4a;

               |SELECT #2#5;
               #5#0 = #4#20;
               #5#1 = #4#21;
               #5#3 = #4#2;
               |LEE 121#5=;
               |SI FSalida = 0;
                    #5#9 = #5#9 + #4#17 - nImpAntes;
                    |GRABA 020#5a;
                    |LIBERA #5;
               |FINSI;
               || Tmp
               #80#0 = #3#2;
               #80#1 = #3#3;
               |LEE 000#80=;
               |SI FSalida ! 0; |GRABA 020#80n; |FINSI;
          |FINSI;
     |FINSI;
     |LIBERA #4;
|FPRC;

|PROCESO Partes;
     #6#0 = #18#9;
     |LEE 000#6=;
     |SI FSalida = 0; |Y #6#12 = "S"; |Y #18#26 = "T";
          #18#21 = #1#11;
          #18#16 = #1#11;
          |SI #18#20 = 0;
               #18#7 = (#18#5 * #18#16);
          |SINO;
               #18#7 = (#18#20 * #18#21);
          |FINSI;
          |GRABA 020#18a;

          #3#34 = #18#26;
          #3#4 = #18#27;
          #3#5 = #18#28;
          #3#6 = 1;
          #3#7 = 1;
          |LEE 101#3=;
          |SI FSalida = 0;
               #3#41 = #1#11;
               #3#49 = #1#11;
               #3#12 = #1#11;
               #3#23 = #1#11;
               #3#50 = 0
               #3#51 = 0;
               #3#52 = 0;
               #3#42 = 0;
               #3#43 = 0;
               #3#44 = 0;
               |HAZ CalcuGopartia;
               |GRABA 020#3a;
               |LIBERA #3;
          |FINSI;
     |FINSI;
     |LIBERA #18;
     |SI #18#30 ! -1;
          #17#6 = #17#6 + #18#5;
          #17#7 = #17#7 + #18#7;
          #17#13 = #17#13 + #18#20;
     |FINSI;
|FPRC;

|PROCESO CabParte;
     #17#13 = 0;
     #17#6 = 0;
     #17#7 = 0;
|FPRC;

|PROCESO FinParte;
     |GRABA 020#17a;
     |LIBERA #17;
|FPRC;

|DEFBUCLE Partes;
     #17#2;
     ;
     aDFecha, #1#2;
     aHFecha, #1#2;
     be;
     NULL, CabParte, Partes, FinParte;
|FIN;

|PROCESO PartesTraba;
     |BUCLE Partes;
|FPRC;

|PROCESO RecalParte;
     #7#0 = #80#0;
     #7#1 = #80#1;
     |LEE 101#7=;
     |SI FSalida = 0;
          |HAZ RecalParte0;
          |GRABA 020#7a;
          |LIBERA #7;
     |FINSI;
|FPRC;

|DEFBUCLE RecalParte;
     #80#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, RecalParte;
|FIN;

|PROCESO Partida;
     #2#0 = #4#4;
     |LEE 000#2=;
     |SI #2#128 = "N"; |ACABA; |FINSI; ||computa Dietas

     #1#0 = #0#0;
     #1#1 = #0#1;
     #1#2 = #4#4;
     |LEE 000#1=;
     |SI FSalida = 0;
          #6#0 = #4#26;
          |LEE 000#6=;
          |SI FSalida = 0; |Y #6#12 = "S";
               #3#41 = #1#11;
               #3#49 = #1#11;
               #3#12 = #1#11;
               #3#23 = #1#11;
               #3#50 = 0
               #3#51 = 0;
               #3#52 = 0;
               #3#42 = 0;
               #3#43 = 0;
               #3#44 = 0;
               |HAZ CalcuGopartia;
               |GRABA 020#3a;
               |LIBERA #3;

               nImpAntes = #4#17;

               #4#13 = #1#11;
               #4#17 =  #4#11 * #4#13;
               |GRABA 020#4a;

               #5#9 = #5#9 + #4#17 - nImpAntes;
               |GRABA 020#5a;
               |LIBERA #5;

               || Tmp
               #80#0 = #3#2;
               #80#1 = #3#3;
               |LEE 000#80=;
               |SI FSalida ! 0; |GRABA 020#80n; |FINSI;
          |FINSI;
     |FINSI;
     |LIBERA #4;
|FPRC;

|DEFBUCLE Partida;
     #3#1;
     ;
     "T", #4#23, #4#24, #4#3, 001;
     "T", #4#23, #4#24, #4#3, 999;
     be;
     NULL, Partida;
|FIN;

|PROCESO PartesTraba0;
     |BUCLE Partida;
|FPRC;

|DEFBUCLE PartesTraba0;
     #4#1;
     ;
     #5#0, #5#1, #5#3, 0001;
     #5#0, #5#1, #5#3, 9999;
     be;
     NULL, PartesTraba0;
|FIN;

|PROCESO Partes0;
     |BUCLE PartesTraba0;
|FPRC;

|DEFBUCLE Partes0;
     #5#2;
     ;
     "     ", 000001, aDFecha;
     "zzzzz", 999999, aHFecha;
     be;
     NULL, Partes0;
|FIN;

|PROCESO Actualizar;
     |HAZ CreaTempo; |NOME_DAT #80#Tempo#; |DELINDEX #80;

     aAlfa = ("0000" + #0#0) % -104;
     aDFecha = ("00" + #0#1) % -102;
     aDFecha = "01." + aDFecha + "." + aAlfa;
     |PARA fFecha = aDFecha; |SI; |HACIENDO fFecha = fFecha + 1;
          aMes = fFecha % 402;
          |SI aMes ! #0#1; |SAL; |FINSI;
          aHFecha = fFecha;
     |SIGUE;

     |ABRE #6;
     |ABRE #2;
     |ABRE #1;
     |ABRE #80;

     |BUCLE Partes0;

     |CIERRA #80;
     |CIERRA #1;
     |ABRE #3;
     |BUCLELIN 2PartesTraba#0;
     |CIERRA #3;
     |CIERRA #2;
     |CIERRA #6;

     |ABRE #7;
     |BUCLE RecalParte;
     |CIERRA #7;

     |HAZ BoraTempo; |DELINDEX #80;
|FPRC;
