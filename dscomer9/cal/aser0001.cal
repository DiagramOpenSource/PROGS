|FICHEROS;
     aser0001 #0;
     aser0002 #2,MANTE;
     agifa010 #10;
     agifa019 #19;
     dsm00020 #20;
     agifa023 #23;
     agifa024 #24,MANTE;
     dsm00003,MANTE;
     agifa027 #27;
     agifa071 #71;
     agifa142 #142;
     agifa321 #321;
     agifa324 #324;
|FIN;

|VARIABLES;
     &aDivisa = "";
     &aMoneda = "";
     &eaTag = "";
     &ser_alb = "";
     &num_alb = 0;
     &abono = "";
     &enSwMenu = 0;
     &enDesdeX = 0;
     &enSwSimula = 0;
 {-1}aMenu          = "";
     aMenu1         = "2400";
     aMenu2         = "1";
     aMenu3         = " Contador: ";
     aMenu4         = "AM";
     aMenu5         = " Automatico ";
     aMenu6         = " Manual ";
     aClave         = "";
     aSerie         = "";
     aAlfa          = "";
     nConta         = 0;
     nNume          = 0;
     nModo          = 0;
     nSalMenu       = 0;
     aArticulo = "";
     aDesArti = "";
     nLin = 0;
     nPrecio = 0;
     nForma = 0;
     nDto = 0;
     nCampo = 0;
     nTiva = 0;
     nCanti = 0;
     nCuotaCoReem = 0;
     nCuotaReex = 0;
     nCuotaSeguro = 0;
|FIN;

|INCLUYE i_varart;

|PROCESO ContaFic;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |SI enSwMenu = 0;
          |SI enDesdeX = 1;
               aMenu1 = "2700";
          |FINSI;
          |MENU aMenu
          nSalMenu = FSalida;
          |SI nSalMenu ! 1; |ACABA; |FINSI;
     |FINSI;

     |SI #142#137 = "F";
          |ABRE #27;
          #27#2 = aSerie;
          #27#0 = aClave;
          |LEE  101#27=;
          |SI FSalida ! 0;
               #27#1 = 1;
               |GRABA 020#27b;
          |FINSI;
          nConta = #27#1;
          |SI enSwSimula = 0;       ||Lo usa la adj. de facturas ventas
               #27#1 = #27#1 + 1;
               |GRABA 020#27a;
          |FINSI;
          |CIERRA #27;
     |FINSI;
|FPRC;

|PROCESO AserAV7; |TIPO 7;
     |SI enSwMenu = 0;
          nModo = (FEntrada/100) !  0;
          |SI nModo ! 1; |ACABA; |FINSI;
     |FINSI;
     eaSwClaveRepre = "";||Inicializa Sw Clave Representante ver 'dsz99995'

     nConta = 1;
     aSerie = #0#0;
     #0#1 = 999999;
     |LEE 000#0];
     |SI FSalida = 0;
          |LEE 000#0a;
     |SINO;
          |LEE 000#0u;
     |FINSI;
     |SI FSalida  = 0; |Y #0#0 = aSerie;
          nConta = #0#1 + 1;
     |FINSI;

     aClave = "valbaran";
     |HAZ ContaFic;

     |DDEFECTO #0;
     #0#0 = aSerie;
     |SI enSwMenu = 0;
          |SI nSalMenu = 1;
               #0#1 = nConta;
               |PTEC 802;
          |SINO;
               #0#1 = 1;
          |FINSI;
     |SINO;
          #0#1 = nConta;
     |FINSI;
     enSwMenu = 0;
|FPRC;

|PROCESO CompruConta;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo ! 1; |ACABA; |FINSI;

     |SI #142#137 = "F"; |ACABA; |FINSI;

     |SI #142#136 ! "S";
          aAlfa = ("000000" + nConta ) % -106;
          |SI #142#136 = "N";
               |SI nNume > nConta;
                    aAlfa = "0000Numero incorrecto. No puede ser mayor de " + aAlfa;
                    |MENAV aAlfa;
                    |ERROR;
               |FINSI;
          |SINO;
               |SI nNume > nConta;
                    aAlfa = "0000Numero superior a " + aAlfa;
                    |MENAV aAlfa;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO AserAV0; |TIPO 0;
     nNume = #0#0;
     |HAZ CompruConta;
|FPRC;

|PROCESO DefeRemitente;
     |SI #0#8 = "P";
          #0#9 = #24#0;
          #0#10 = #24#1;
          #0#11 = #24#5;
          aAlfa = ((("00" + #24#178) % -102) + (("000" + #24#178) % -103));
          #0#12 = aAlfa;
          #0#13 = #24#9;
     |SINO;
          #0#9 = #2#0;
          #0#10 = #2#1;
          #0#11 = #2#2;
          #0#12 = #2#3;
          #0#13 = #2#4;
     |FINSI;
     |PINTA #0#9;
     |PINTA #0#10;
     |PINTA #0#11;
     |PINTA #0#12;
     |PINTA #0#13;
     #0#46 = #24#167;
     #0#48 = #24#168;
     #0#47 = #24#169;
     #0#49 = #24#170;
|FPRC;

|PROCESO Remitente0; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |SI #0Campo ! Contenido; |O nModo = 1;
          |SI #0#8 = "P";
               |ABRE #24;
               #24#0 = #0#9;
               |LEE 000#24=;
               |SI FSalida = 0;
                    |HAZ DefeRemitente;
               |SINO;
                    |CONFI "0000SConfirma alta (S/N)...:";
                    |SI FSalida = 0;
                         |PUSHV 0501 2380;
                         |PINPA #0#24;
                         |PINDA #0#24;
                         |ENDATOS #1#24;
                         |POPV;
                         |SI FSalida = 0;
                              |HAZ DefeRemitente;
                              |GRABA 020#24n;
                         |FINSI;
                    |FINSI;
                    |ERROR;
               |FINSI;
               |CIERRA #24;
          |SINO;
               |ABRE #2;
               #2#0 = #0#9;
               |LEE 000#2=;
               |SI FSalida = 0;
                    |HAZ DefeRemitente;
               |SINO;
                    |CONFI "0000SConfirma alta (S/N)...:";
                    |SI FSalida = 0;
                         |PUSHV 0501 2380;
                         |PINPA #0#2;
                         |PINDA #0#2;
                         |ENDATOS #1#2;
                         |POPV;
                         |SI FSalida = 0;
                              |HAZ DefeRemitente;
                              |GRABA 020#2n;
                         |FINSI;
                    |FINSI;
                    |ERROR;
               |FINSI;
               |CIERRA #2;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Remitente66; |TIPO 66;
     |SI #0#8 = "P";
          |ABRE #24;
          #24#0 = #0#9;
          |LEE 000#24=;
          |CONSULTA_CLAVE #1#24;
          |SI FSalida = 0;
               |HAZ DefeRemitente;
          |SINO;
               |ERROR;
          |FINSI;
          |CIERRA #24;
     |SINO;
          |ABRE #2;
          #2#0 = #0#9;
          |LEE 000#2=;
          |CONSULTA_CLAVE #1#2;
          |SI FSalida = 0;
               |HAZ DefeRemitente;
          |SINO;
               |ERROR;
          |FINSI;
          |CIERRA #2;
     |FINSI;
|FPRC;

|PROCESO DefeConsignatario;
     |SI #0#8 = "D";
          #0#14 = #24#0;
          #0#15 = #24#1;
          #0#16 = #24#5;
          aAlfa = ((("00" + #24#178) % -102) + (("000" + #24#178) % -103));
          #0#17 = aAlfa;
          #0#18 = #24#9;
          #0#19 = #24#17;
          #0#20 = #24#36;
     |SINO;
          #0#14 = #2#0;
          #0#15 = #2#1;
          #0#16 = #2#2;
          #0#17 = #2#3;
          #0#18 = #2#4;
          #0#19 = #2#5;
          #0#20 = #2#6;
     |FINSI;
     |PINTA #0#14;
     |PINTA #0#15;
     |PINTA #0#16;
     |PINTA #0#17;
     |PINTA #0#18;
     |PINTA #0#19;
     |PINTA #0#20;
|FPRC;

|PROCESO Consignatario0; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     |SI #0Campo ! Contenido;
          |SI #0#8 = "D";
               |ABRE #24;
               #24#0 = #0#14;
               |LEE 000#24=;
               |SI FSalida = 0;
                    |HAZ DefeConsignatario;
               |SINO;
                    |CONFI "0000SConfirma alta (S/N)...:";
                    |SI FSalida = 0;
                         |PUSHV 0501 2380;
                         |PINPA #0#24;
                         |PINDA #0#24;
                         |ENDATOS #1#24;
                         |POPV;
                         |SI FSalida = 0;
                              |HAZ DefeConsignatario;
                              |GRABA 020#24n;
                         |FINSI;
                    |FINSI;
                    |ERROR;
               |FINSI;
               |CIERRA #24;
          |SINO;
               |ABRE #2;
               #2#0 = #0#14;
               |LEE 000#2=;
               |SI FSalida = 0;
                    |HAZ DefeConsignatario;
               |SINO;
                    |CONFI "0000SConfirma alta (S/N)...:";
                    |SI FSalida = 0;
                         |PUSHV 0501 2380;
                         |PINPA #0#2;
                         |PINDA #0#2;
                         |ENDATOS #1#2;
                         |POPV;
                         |SI FSalida = 0;
                              |HAZ DefeConsignatario;
                              |GRABA 020#2n;
                         |FINSI;
                    |FINSI;
                    |ERROR;
               |FINSI;
               |CIERRA #2;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Consignatario66; |TIPO 66;
     |SI #0#8 = "D";
          |ABRE #24;
          #24#0 = #0#14;
          |LEE 000#24=;
          |CONSULTA_CLAVE #1#24;
          |SI FSalida = 0;
               |HAZ DefeConsignatario;
          |SINO;
               |ERROR;
          |FINSI;
          |CIERRA #24;
     |SINO;
          |ABRE #2;
          #2#0 = #0#14;
          |LEE 000#2=;
          |CONSULTA_CLAVE #1#2;
          |SI FSalida = 0;
               |HAZ DefeConsignatario;
          |SINO;
               |ERROR;
          |FINSI;
          |CIERRA #2;
     |FINSI;
|FPRC;

|PROCESO SiNo; |TIPO 0;
     aAlfa = #0Campo;
     nCampo = Campo + 1;
     |C_M #0nCampo, 1, aAlfa;
     |SI aAlfa = "N"; #0nCampo = 0; |PINTA #0nCampo; |FINSI;
|FPRC;

|PROCESO Total; |TIPO 0;
     nModo = (FEntrada / 100) ! 0;
     enTiva = #0#37;
     efFiva = #0#2;
     |HAZ SacaIVA;


     |DDEFECTO #19;
     |ABRE #19;
     #19#0 = #0#25;
     |LEE 000#19=;
     |CIERRA #19;

     |SI Campo = 34; ||*Como el defecto es N falla en alta
                     || porque no ha cambiao de valor
               |O Campo = 28; |O Campo = 31; |O Campo = 33;
                    || y lo mismo con los que calculan con el 34

          |SI #0Campo = Contenido; |Y nModo ! 1; |ACABA; |FINSI;
     |SINO;
          |SI Campo ! 37;
          |SI #0Campo = Contenido; |ACABA; |FINSI;
          |FINSI;
     |FINSI;

     nCampo = Campo;
     |SI nCampo = 45; |O nCampo = 5; |O Campo = 27;
          #0#28 = (#0#45 * #0#5) < #0#27;
          |SI #0#28 < #19#114;
               #0#28 = #19#114;    || Minimo portes
          |FINSI;
          nCampo = 28;
     |FINSI;

     |SI nCampo = 30;
          |SI #0#30 = 0;
               #0#31 = 0;
          |SINO;
               #0#31 = #0#30 * #0#46;
               |SI #0#31 < #0#48;
                    #0#31 = #0#48;
               |FINSI;
          |FINSI;
          nCampo = 31;
     |FINSI;

     |SI nModo = 1; ||*Por los mismo que antes
          |SI nCampo = 28; |O nCampo = 31; |O nCampo = 33;
               |SI #0#34 = "N";
                    #0#35 = 0;
               |SINO;
                    #0#35 = (#0#28 + #0#31 + #0#33) * #0#47;
                    |SI #0#35 < #0#49;
                         #0#35 = #0#49;
                    |FINSI;
               |FINSI;
               nCampo = 35;
          |FINSI;
     |FINSI;

     |SI nCampo = 34;
          |SI #0#34 = "N";
               #0#35 = 0;
          |SINO;
               #0#35 = (#0#28 + #0#31 + #0#33) * #0#47;
               |SI #0#35 < #0#49;
                    #0#35 = #0#49;
               |FINSI;
          |FINSI;
          nCampo = 35;
     |FINSI;
     |SI nCampo = 28; |O nCampo = 31; |O nCampo = 33; |O nCampo = 35;
               |O nCampo = 37;
          #0#36 = #0#28 + #0#31 + #0#33 + #0#35; ||Base
          #0#38 = #0#28 * enIva / 100; ||IVA
          |HAZ Cuotas;
          #0#38 = #0#38 + nCuotaCoReem + nCuotaReex + nCuotaSeguro;
          #0#39 = #0#28 + #0#31 + #0#33 + #0#35 + #0#38;
          #0#40 = #0#36 + #0#38 + #0#30;
     |FINSI;
     |SI Campo = 38;
          #0#39 = #0#28 + #0#31 + #0#33 + #0#35 + #0#38
          #0#40 = #0#36 + #0#38 + #0#30;
     |FINSI;
     |SI Campo = 36; Campo = 38; |O Campo = 30;
          #0#40 = #0#36 + #0#38 + #0#30;
     |FINSI;
     |PINTA #0#28;
     |PINTA #0#31;
     |PINTA #0#35;
     |PINTA #0#36;
     |PINTA #0#38;
     |PINTA #0#39;
     |PINTA #0#40;
|FPRC;

|PROCESO Cuotas;
     |ABRE #19;
     |DDEFECTO #19;
     #19#0 = "COM.REEMBOLSO";
     |LEE 000#19=;

     enTiva = #19#30;
     efFiva = #0#2;
     |HAZ SacaIVA;

     nCuotaCoReem = (#0#31 * enIva / 100) ! 2;

     |DDEFECTO #19;
     #19#0 = "REEXPEDICION";
     |LEE 000#19=;

     enTiva = #19#30;
     efFiva = #0#2;
     |HAZ SacaIVA;

     nCuotaReex = (#0#33 * enIva / 100) ! 2;

     |DDEFECTO #19;
     #19#0 = "SEGURO";
     |LEE 000#19=;
     enTiva = #19#30;
     efFiva = #0#2;
     |HAZ SacaIVA;

     nCuotaSeguro = (#0#35 * enIva / 100) ! 2;

     |CIERRA #19;
|FPRC;

|PROCESO Tipo4; |TIPO 4;
     ser_alb = #0#0;
     num_alb = #0#1;
     abono = "N";
     |CIERRAT #0;
     |SUB_EJECUTA_NP "agifa014";
     |ABRET #0;
     |LEE 101#0=;
     |PINTA #0#44;
|FPRC;

|PROCESO AcuCliente;
     nCanti = #10#15 < #10#5;
     nCanti = nCanti < #10#32;
     nCanti = nCanti < #10#7;

     |LEE 101#24=;
     |SI FSalida = 0;
          #24#50 = #24#50 + (nCanti * nForma);
          |GRABA 020#24a;
          |LIBERA #24;
     |FINSI;

     enImpCliPen = nCanti * nForma;
     eaCliente = #10#3;
     efFecha = #10#1;
     |HAZ AcumulaCli;
     eaTag = "AV";  |HAZ Riesgos;
|FPRC;

|PROCESO BorraLinAlb;
     enForma = -1;
     |HAZ AcumulaAV;
     |BORRA 020#71a;
|FPRC;

|PROCESO CreaCabAlb
     |DDEFECTO #24;
     |SI #0#8 = "P";
          #24#0 = #0#9;
     |SINO;
          #24#0 = #0#14;
     |FINSI;
     |LEE 000#24=;

     |DDEFECTO #10;
     #10#52 = #0#0;
     #10#0 = #0#1;
     #10#1 = #0#2;
     #10#83 = #0#3;
     #10#2 = #0#4;
     #10#64 = #0#8;
     |SI #0#8 = "P";
          #10#3 = #0#9;
          #10#4 = #0#10;
     |SINO;
          #10#3 = #0#14;
          #10#4 = #0#15;
     |FINSI;
     #10#6 = #24#25;
     #10#8 = #24#20;
     #10#40 = #24#41;
     #10#50 = #24#40;

     #10#29 = #0#15;
     #10#30 = #0#16;
     #10#62 = #0#17;
     #10#31 = #0#18;
     #10#36 = #24#47;
     #10#55 = #0#21;
     #10#56 = #0#22;
     #10#20 = #0#38; #10#24 = #0#38;
     #10#67 = #0#40;
     #10#57 = #0#41;
     #10#88 = #0#42;
     #10#9 = #0#43;
     |ABRE #20; #20#0 = #0#42; |LEE 000#20=; |CIERRA #20;
     #10#88 = #20#0;
     #10#9 = #20#1;
     #10#90 = #0#44;

     |ABRE #321; |LEE 000#321p; |CIERRA #321;
     |ABRE #324;
     #10#68 = #24#192; || Divisa
     #324#0 = #10#68;
     |LEE 000#324=;
     #10#69 = #324#2; || Cambio
     #10#70 = "B";    || Trabajo
     #10#73 = #321#9; || Moneda Base
     #324#0 = #10#73;
     |LEE 000#324=;
     #10#74 = #324#2; || Cambio a Eur
     |CIERRA #324;

     aMoneda = #10#70;
     aDivisa = #10#68;
     |HAZ Divisas010;

     |HAZ LimCabAgifa010;
|FPRC;

|PROCESO CreaLinAlb;
     |DDEFECTO #19;
     |ABRE #19;
     #19#0 = aArticulo;
     |LEE 000#19=;
     |CIERRA #19;
     |SI aDesArti = ""; aDesArti = #19#1; |FINSI;
     |SI nTiva = -1; nTiva = #19#30; |FINSI;

     nLin = nLin + 1;
     |DDEFECTO #71;
     #71#29 = #10#52;
     #71#0 = #10#0;
     #71#1 = nLin;
     #71#2 = #19#0;
     #71#3 = 1;
     #71#4 = aDesArti;
     #71#5 = 1;
     #71#8 = nDto;
     #71#6 = nPrecio;
     #71#36 = nPrecio;
     #71#11 = nTiva;
     #71#13 = #19#2;
     #71#14 = #19#9 * #71#5;
     #71#15 = #24#0;
     #71#17 = #24#4;
     |HAZ TotalLin71;
     |HAZ CalCabAgifa010;
     |GRABA 020#71n;
     enForma = 1;
     |HAZ AcumulaAV;
|FPRC;

|PROCESO Albaran;
     |ABRE #24;
     |HAZ CreaCabAlb;
     nLin = 0;
     |ABRE #71;
     aArticulo = #0#25;
     aDesArti = #0#26;
     nPrecio = #0#28;
     nDto = #0#27;
     nTiva = #0#37;
     |HAZ CreaLinAlb;
     |SI #0#29 = "S";
          aArticulo = "REEMBOLSO";
          aDesArti = "";
          nPrecio = #0#30;
          nDto = 0;
          nTiva = 0;
          |HAZ CreaLinAlb;
     |FINSI;
     |SI #0#31 ! 0;
          aArticulo = "COM.REEMBOLSO";
          aDesArti = "";
          nPrecio = #0#31;
          nDto = 0;
          nTiva = -1;
          |HAZ CreaLinAlb;
     |FINSI;
     |SI #0#32 = "S";
          aArticulo = "REEXPEDICION";
          aDesArti = "";
          nPrecio = #0#33;
          nDto = 0;
          nTiva = -1;
          |HAZ CreaLinAlb;
     |FINSI;
     |SI #0#34 = "S";
          aArticulo = "SEGURO";
          aDesArti = "";
          nPrecio = #0#35;
          nDto = 0;
          nTiva = -1;
          |HAZ CreaLinAlb;
     |FINSI;
     |CIERRA #71;
     enForma = 1;
     |HAZ AcuCliente;
     |CIERRA #24;
|FPRC;

|PROCESO Tipo2; |TIPO 2;
     nForma = 0 +. 1;
     |ABRE #10;
     #10#52 = #0#0;
     #10#0 = #0#1;
     |LEE 101#10=;
     |SI nForma = 1;
          |SI FSalida = 0;
               |LIBERA #10;
               |MENAV "0000ERROR, existe el albaran en el mantenimiento estandar";
               |CONFI "0000NContinuar borrando Albaran estandar:";
               |SI FSalida = 0;
                    |LEE 101#10=;
                    |BUCLELIN 1NULL#10;
               |SINO;
                    |ERROR; |ACABA;
               |FINSI;
          |SINO;
                |GRABA 020#10b;
          |FINSI;
          |HAZ Albaran;
          |GRABA 020#10a;
          |LIBERA #10;
          |SI #0#44 = "N";
               |CONFI "0000NImprimir Albaran";
               |SI FSalida = 0;
                    |HAZ Tipo4;
                    |LEE 000#10=;
                    #0#44 = #10#90;
                    |PINTA #0#44;
               |FINSI;
          |FINSI;
     |SINO;
          |SI FSalida = 0;
               |SI #10#38 = "S";
                    |MENAV "0000Este albaran esta FACTURADO";
                    |ERROR;
               |SINO;
                    |BUCLELIN 0BorraLinAlb#10;
                    |BORRA 020#10a;
                    nForma = -1;
                    |HAZ AcuCliente;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #10;
|FPRC;

|PROCESO PrecioPortes; |TIPO 0;
     |SI #0Campo ! Contenido;
          |ABRE #19;
          #19#0 = #0#25;
          |LEE 000#19=;
          |CIERRA #19;
          #0#45 = #19#18;

          |ABRE #23;
          #23#0 = #0#9;
          #23#1 = #0#24;
          |LEE 000#23=;
          |SI FSalida = 0;
               |SI #0#23 ] #23#28; |Y #0#23 [ #23#29;
                    #0#45 = #23#2;
               |FINSI;
          |FINSI;
          |CIERRA #23;

          Campo = 45; |HAZ Total;
     |FINSI;
|FPRC;

|PROCESO IVA001_66; |TIPO 66;
     enTiva = #0Campo;
     efFiva = #0#2;
     |HAZ ConsuIVA;
     |SI eaDiva = "";
          |ERROR;
     |SINO;
          #0Campo = enTiva; |PINTA #0Campo;
     |FINSI;
|FPRC;

|PROCESO IVA001_0; |TIPO 0;
     enTiva = #0Campo;
     efFiva = #0#2;
     |HAZ SacaIVA;
     |SI eaDiva = "";
          |MENAV "0000No existe tipo iva para esta fecha...";
          |ERROR; |ACABA;
     |SINO;
          |HAZ Total;
     |FINSI;
|FPRC;
