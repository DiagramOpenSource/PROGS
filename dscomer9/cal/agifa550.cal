|FICHEROS;
     agifa550 #0;

     expor024@ #1;        ||Cliente a importar
     agifa024 #11;

     expor019@ #2;        ||Articulo a importar
     agifa019 #12;

     expor112@ #3;        ||Proveedor a importar
     agifa112 #13;

     expor025@ #4;        ||Comisionista a importar
     agifa025 #14;

     expor010@ #5;        ||Fichero de Albaranes
     agifa010 #15;
     expor071@ #6;        ||Fichero de lineas de albaran
     agifa071 #16;

     expor084@ #9;        ||Factura contado
     agifa084 #19;
     expor069@ #10;       ||Linea factura contado
     agifa069 #20;

     expor501@ #21;       ||Tiquets
     agifa501 #31;
     expor502@ #22;       ||Linea Tiquets
     agifa502 #32;

     expor513@ #23;       ||Cobros
     agifa513 #33;

     expor512@ #24;       ||Pagos
     agifa512 #34;

     expor509@ #25;        ||resumen de caja
     agifa509 #35;

     expor001@ #26;       ||Cod.Barras
     dsl00001 #36;

     expor065@ #38;
     agifa065 #18;     || Historico

     agifa556 #50;     || Fichero DESGLOSE
     agifa557 #51;     || Fichero CONTROL CAMINO EXPORT/IMPORT
     testigo  #61;     || testigo, y control de empresas

     agifa142 #142;
     dsm00033 #100;

     dsm00005 #905;
     expord05@ #805;

     dsm00006 #906;
     expord06@ #806;

     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄMarhuenda
     marhu334@ #334;
     expor334@ #434;
     marhu335@ #335;
     expor335@ #435;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     dsm00004 #904;

     dsw00011 #999; || Usado de temporal para el directorio
|FIN;

|VARIABLES;
     nLinV = 0;
     &eaNomDef = "";
     &enCamposDef = 0;
     &Tempo         = "";
     aTempo999      = "";
     nCampos        = 0;
     aCompleto      = "";
     nSwMarhu       = 0;
     nSal           = 0;
     nHandle        = 0;
     aExt           = "";
     nLon           = 0;
     aGz            = "";
     aOrg           = "";
     fAfecha        = @;
     fDfecha        = @;
     ffecha         = @;
     nTienda        = 0;
     nSwPasa        = 0;
     iva            = 0;
     puente_s       = 0;
     puente_n       = 0;
     nSwDesglose    = 0;
     nSwHayDesglose = 0;
     nTotalB        = 0;
     nTotalN        = 0;
     nTotal         = 0;
     nAcumula       = 0;

     aParam    = "";
     beta      = 0;
     nImpo     = 0;
     nDto      = 0;
     imneto    = 0;
     nMargen   = 0;
     nHay      = 0;

     n024 = 0; n019 = 0; n112 = 0; n025 = 0; n010 = 0; n071 = 0; n565 = 0;
     n084 = 0; n069 = 0; n501 = 0; n502 = 0; n513 = 0; n512 = 0; n509 = 0;
     n001 = 0; n905 = 0; n906 = 0;
     nLinea = 0;
     ddx = "";
     fich = "";
     org = "";
     num = 0;
     bufer = 0;
     err = 0;
     fdes = "";
     des = "";
     fdef = "";
     def = "";
     exp = 0;

     i = 0;
     mensaje1= "0000ATENCION No puedo abrir fichero de control EXPORT/IMPORT";
     mensaje2 = "0000ATENCION Debe informar del CONTROL CAMINO EXPORT/IMPORT";
     mensaje = "";
     path = "";
     mensa = "";
     mes = 0;
     fmes = "  ";
     blanco = "                         ";
     blanco1 = "                    ";
     baseimp = 0;
     margen = 0;
     empresa = "";
     camino = "";
     pintar = "";
     hora  = "";
     horat = "";
     importa = 0;
     fechaimp = @;
     abo = 0;

     nUltima = 0;
     aAlfa     = "";
     aAlf1     = "";
     aFic      = "";
     aFic1     = "";
     fFecha    = @;
     aEmp      = "";
     nLin      = 0;
     aHora     = "";
     nTCobro   = 0;
     nAcumu    = 0;
     nTotOrg   = 0;
     a39 = 0; b39 = 0;
     a40 = 0; b40 = 0;
     a41 = 0; b41 = 0;
     a62 = 0; b62 = 0;
     a63 = 0; b63 = 0;
     a64 = 0; b64 = 0;
     a38 = 0; b38 = 0;
     aArti = "";
     nAlma = 0;
     aEleme = "";
     aDes = "";
     nUni = 0;

     swErr    = 0;
     aMensa   = "";
     aPath    = "";
     aDef     = "";
     aDef1    = "";
     aDef2    = "";
     aDef3    = "";
     aDef4    = "";
     aDef5    = "";
     aDef6    = "";
     aDef7    = "";
     aDef8    = "";
     aDef9    = "";
     aDef10   = "";
     aDef11   = "";
     aDef12   = "";
     aDef13   = "";
     aDef14   = "";
     aDef15   = "";
     aDef16   = "";
     aDef17   = "";
     aDef18   = "";
     aDef19   = "";
|FIN;

|INCLUYE i_varart;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO marhu335;
     aAlfa = "|NC";
     aAlfa = #435#aAlfa#;
     nCampos = aAlfa; nCampos = nCampos - 1;
     |PARA i = 0; |SI i [ nCampos; |HACIENDO i = i + 1;
          #335i = #435i;
     |SIGUE;
     |LEE 101#335=;
     |PARA i = 0; |SI i [ nCampos; |HACIENDO i = i + 1;
          #335i = #435i;
     |SIGUE;
     |SI FSalida = 0;
          |GRABA 020#335a;
          |LIBERA #335;
     |SINO;
          |GRABA 020#335n;
     |FINSI;
     |SI #335#7 ! 0;
          aCompleto = "P";
     |FINSI;
|FPRC;

|DEFBUCLE marhu335;
     #435#1003;
     ;
     #434#0, #434#1, 001;
     #434#0, #434#1, 999;
     ;
     NULL, marhu335;
|FIN;

|PROCESO marhu334;
     aCompleto = "N";
     |BUCLE marhu335;
     aAlfa = "|NC";
     aAlfa = #434#aAlfa#;
     nCampos = aAlfa; nCampos = nCampos - 1;
     |PARA i = 0; |SI i [ nCampos; |HACIENDO i = i + 1;
          #334i = #434i;
     |SIGUE;
     |LEE 101#334=;
     #334#3 = "N";
     #334#4 = "01.01.0000";
     #334#5 = aCompleto;
     #334#6 = fFecha;
     |SI FSalida = 0;
          |GRABA 020#334a;
          |LIBERA #334;
     |SINO;
          #334#8 = "01.01.0000";
          |GRABA 020#334n;
     |FINSI;
|FPRC;

|DEFBUCLE marhu334;
     #434#1002;
     ;
     00001, 000001;
     99999, 999999;
     be;
     NULL, marhu334;
|FIN;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
||============================= COD BARRAS ================================
|PROCESO CodBarra;
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #26#1;
     |DDEFECTO #36;
     |SELECT #2#36;
     #36#3 = #26#3;
     |LEE 000#36=;
     |SI FSalida ! 0;
          |SELECT #1#36;
          |LEE 000#36u;
          |SI FSalida = 0;
               nUltima = #36#0 + 1;
          |SINO;
               nUltima = 1;
          |FINSI;
          |PARA i = 1; |SI i [ n001; |HACIENDO i = i + 1;
              #36i = #26i;
          |SIGUE;
          #36#0 = nUltima;
          #36#4 = "S";
          #36#5 = ~;
          |GRABA 020#36n;
     |FINSI;
|FPRC;

||============================= CLIENTES ==================================

|PROCESO miracli;
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #1#0;
     |DDEFECTO #11;
     #11#0 = #1#0;         ||igualo el fichero de clientes
     |LEE 101#11=;       ||Miro si ya existe el cliente
     |SI FSalida ! 0;    ||Si no existe lo grabo como corriente
          |GRABA 021#11b;
     |FINSI;
     |PARA i = 1; |SI i [ 44; |HACIENDO i = i + 1;
           #11i = #1i;
     |SIGUE;
     #11#47 = #1#47;          ||Regimen equivalencia
     #11#52 = #1#52;          ||Capacidad estimada de compra
     #11#53 = #1#53;          ||Observaciones1
     |PARA i = 156; |SI i [ n024; |HACIENDO i = i + 1;
          #11i = #1i;
     |SIGUE;
     #11#175 = "N";             ||Exportado
     #11#176 = "00.00.0000";    ||Fecha Exportcion
     |GRABA 021#11a;
     |LIBERA #11;
|FPRC;

||============================= ARTICULOS =================================

|PROCESO miraarti;
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #2#0;
     |DDEFECTO #12;
     #12#0 = #2#0;    ||igualo el fichero de articulos
     |LEE 101#12=;  ||Miro si ya existe el articulo
     |SI FSalida ! 0; ||Si el articulo no existe
          |GRABA 021#12b;
     |FINSI;
     |PARA i = 1; |SI i [ 5; |HACIENDO i = i + 1;
          #12i = #2i;
     |SIGUE;
     #12#9=#2#9;    ||P.C.M
     |PARA i = 18; |SI i [ 23; |HACIENDO i = i + 1;
          #12i = #2i;
     |SIGUE;
     #12#30 = #2#30;  ||Tipo de iva
     #12#31 = #2#31;  ||%comision
     #12#102 = #2#102;     ||Peso por caja
     #12#103 = #2#103;     ||%royalti

     |PARA i = 105; |SI i [ 128; |HACIENDO i = i + 1;
          #12i = #2i;
     |SIGUE;

     |PARA i = 133; |SI i [ n019; |HACIENDO i = i + 1;
          #12i = #2i;
     |SIGUE;

     #12#130 = #2#130;     ||Iva 1
     #12#131 = #2#131;     ||Iva 2
     #12#132 = #2#132;     ||Iva 3
     #12#123 = "N";
     #12#124 = "00.00.0000";
     |GRABA 021#12a;
     |LIBERA #12;
|FPRC;

||============================= PROVEEDORES ===============================

|PROCESO miraprove;
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #3#0;
     |DDEFECTO #13;
     #13#0 = #3#0;    ||igualo el fichero de proveedores
     |LEE 101#13=;  ||Miro si ya existe el proveedor
     |SI FSalida ! 0; ||Si el Proveedor ya existe
          |GRABA 021#13b;
     |FINSI;
     |PARA i = 1; |SI i [ 26; |HACIENDO i = i + 1;
          #13i = #3i;
     |SIGUE;
     #13#41 = #3#41;  ||Dto acumulado
     #13#42 = #3#42;  ||Codigo de grupo
     |PARA i = 57; |SI i [ n112; |HACIENDO i = i + 1;
          #13i = #3i;
     |SIGUE;
     #13#71 = "N";
     #13#72 = "00.00.0000";
     |GRABA 021#13a;
     |LIBERA #13;
|FPRC;

||============================= COMISIONISTAS =============================

|PROCESO miracomis;
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #4#0;
     |DDEFECTO #14;
     #14#0 = #4#0;    ||igualo el fichero de comision
     |LEE 101#14=;  ||Miro si ya existe la comision
     |SI FSalida ! 0; ||Si el comision existe
          |GRABA 021#14b;
     |FINSI;
     |PARA i = 1; |SI i [ 10; |HACIENDO i = i + 1;
          #14i = #4i;
     |SIGUE;
     #14#39 = #4#39;  ||%IRPF
     #14#54 = "N";
     #14#55 = "00.00.0000";
     |PARA i = 56; |SI i [ n025; |HACIENDO i = i + 1;
          #14i = #4i;
     |SIGUE;
     |GRABA 021#14a;
     |LIBERA #14;
|FPRC;

||============================= HISTORICO =================================
|PROCESO HistoEleme;
     |PARA i = 0; |SI i [ n906; |HACIENDO i = i + 1;
          #906i = #806i;
     |SIGUE;
     |GRABA 000#906n;
|FPRC;

|DEFBUCLE HistoEleme;
     #806#1008;
     ;
     #38#0, #38#5, #38#1, #38#2, #38#11, #38#3, #38#4, "      ";
     #38#0, #38#5, #38#1, #38#2, #38#11, #38#3, #38#4, "zzzzzz";
     ;
     NULL, HistoEleme;
|FIN;

|PROCESO mirahis;
     |PINTA 2163 , blanco1;
     |PINTA 2163 , #38#0;
     |DDEFECTO #18;
     |PARA i = 0; |SI i [ n565; |HACIENDO i = i + 1;
          #18i = #38i;
     |SIGUE;
     #18#15 = "S";
     #18#16 = ~;
     |GRABA 000#18n;          || lo duplicados los ignora
     |BUCLE HistoEleme;
|FPRC;

||=============================== ALBARANES ===============================
|PROCESO AlbaEleme;
     |PARA i = 0; |SI i [ n905; |HACIENDO i = i + 1;
          #905i = #805i;
     |SIGUE;
     |GRABA 000#905n;
     aEleme = #905#4;
     aDes = #905#5;
     nUni = #905#6;
     |HAZ EL5elemento;
|FPRC;

|DEFBUCLE AlbaEleme;
     #805#1005;
     ;
     "AV", #5#52, #5#0, nLinV, "      ";
     "AV", #5#52, #5#0, nLinV, "zzzzzz";
     ;
     NULL, AlbaEleme;
|FIN;

|PROCESO miralin;        |Lineas de albaran
     |DDEFECTO #16;
     |PARA i = 0; |SI i [ n071; |HACIENDO i = i + 1;
          #16i = #6i;
     |SIGUE;
     |GRABA 021#16c;
     |LIBERA #16;

     enSwHisto = #0#18;
     enForma = 1;
     eaTipo550 = "AV";
     |HAZ AcumulaAV;
     aArti = #16#2;
     nAlma = #16#3;
     nLinV = #16#1;
     |BUCLE AlbaEleme;
|FPRC;

|DEFBUCLE miralin;
     #6#1003;
     ;
     #5#52, #5#0, 001;
     #5#52, #5#0, 999;
     ;
     NULL, miralin;
|FIN;

|PROCESO miraalba;       ||Cabeceras de albaran
     |PINTA 2163 , blanco1;
     pintar = #5#44 + " / " + #5#0;
     |PINTA 2163 , pintar;
     |DDEFECTO #15;
     #15#52 = #5#52;
     #15#0 = #5#0;
     |LEE 000#15=;
     |SI FSalida=0;
          mensa ="0000El albaran numero : "+#5#52 + "/" + #5#0+"  YA EXISTE";
          |MENAV mensa;
          |ACABA;
     |FINSI;
     |PARA i = 0; |SI i [ n010; |HACIENDO i = i + 1;
          #15i = #5i;
     |SIGUE;
     |GRABA 021#15c;     ||Grabo el albaran

     ||Aqui Actualizo el cliente del albaran

     #11#0=#15#3;
     |LEE 101#11=;
     |SI FSalida = 0; |Y #0#16 = "S";
          |SI #5#43 = "N"; ||Si no es abono
               #11#50=#11#50+#15#16+#15#19+#15#22+#15#28; ||Pendiente facturar
               enImpCliPen=#11#50+#15#16+#15#19+#15#22+#15#28; ||Pendiente facturar
          |SINO;
               #11#50=#11#50-#15#16-#15#19-#15#22-#15#28; ||Pendiente facturar
               enImpCliPen=#11#50-#15#16-#15#19-#15#22-#15#28; ||Pendiente facturar
          |FINSI;
          eaCliente = #15#3;
          efFecha = #15#1;
          |HAZ AcumulaCli;

          |GRABA 021#11a;
          |LIBERA #11;
     |FINSI;
     |BUCLE miralin;         ||Graba las lineas albaran
|FPRC;

||=============================== FACTURAS ================================
|PROCESO FacEleme;
     |PARA i = 0; |SI i [ n905; |HACIENDO i = i + 1;
          #905i = #805i;
     |SIGUE;
     |GRABA 000#905n;
     aEleme = #905#4;
     aDes = #905#5;
     nUni = #905#6;
     |HAZ EL5elemento;
|FPRC;

|DEFBUCLE FacEleme;
     #805#1005;
     ;
     "FC", #9#48, #9#0, nLinV, "      ";
     "FC", #9#48, #9#0, nLinV, "zzzzzz";
     ;
     NULL, FacEleme;
|FIN;

|PROCESO miralinfac;        |Lineas de factura
     |DDEFECTO #20;
     |PARA i = 0; |SI i [ n069; |HACIENDO i = i + 1;
        #20i = #10i;
     |SIGUE;
     |GRABA 021#20c;      || Grabo linea de factura contado nueva
     |LIBERA #20;

     enSwHisto = #0#18;
     enForma = 1;
     eaTipo550 = "FC";
     |HAZ AcumulaFC;
     aArti = #20#2;
     nAlma = #20#3;
     nLinV = #20#1;
     |BUCLE FacEleme;
|FPRC;

|DEFBUCLE miralinfac;
     #10#1003;
     ;
     #9#48, #9#0, 001;
     #9#48, #9#0, 999;
     ;
     NULL, miralinfac;
|FIN;

|PROCESO mirafact;       ||Cabeceras de factura
     |PINTA 2163 , blanco1;
     pintar = #9#48 + " / " + #9#0;
     |PINTA 2163 , pintar;
     |DDEFECTO #19;
     #19#48 = #9#48;
     #19#0 = #9#0;
     |LEE 000#19=;
     |SI FSalida=0;
          mensa ="0000La Factura numero : "+#9#48 + "/" +#9#0+"  YA EXISTE";
          |MENAV mensa;
          |ACABA;
     |FINSI;
     |PARA i = 0; |SI i [ n084; |HACIENDO i = i + 1;
        #19i = #9i;
     |SIGUE;

     || Empiezo a actualizar lo que depende directamente de la cabecera

     |DDEFECTO #11;
     #11#0 = #9#3;               || Busco en el fichero de clientes
     |LEE 111#11=;
     |SI FSalida ! 0; |Y #0#16 = "S";
          |GRABA 021#11b;
     |FINSI;
     baseimp= #9#16+#9#19+#9#22+#9#28;|| Me servira para varias actualizaciones
     baseimp = baseimp+#9#42+#9#45;  || (Suma de las bases imponibles)
     #11#45 = #9#1;                  || Fecha ultima compra
     #11#46 = #11#46 + baseimp;      || Importe ultima compra
     #11#102 = #11#102 + baseimp;    || Total compras año
 ||    #11#110 = #11#110 + #9#41;      || Total facturado   (Total factura)
     #11#110 = #11#110 + (#9#15 - #9#25);      || Total facturado   (Total factura)
     fmes = #9#1 % A402; mes = fmes - 1; mes = mes * 4; mes = mes + 54;
     #11mes = #11mes + baseimp;      || Compras en el mes de la venta
     mes = mes + 2;
     #11mes = #11mes + #9#37;        || Margen en el mes en concreto
     #11#104 = #11#104 + #9#37;      || Total margen

     |SI #0#16 = "S";
          |GRABA 021#11a;
          |LIBERA #11;
     |FINSI;

     |SI #0#16 = "S";
          enImpCliCom = baseimp;
          enImpCliDto = 0;
          enImpCliMar = #9#37;
          enImpCliFac = (#9#15 - #9#25);
          eaCliente = #0#2;
          efFecha = #0#1;
          |HAZ AcumulaCli;
     |FINSI;

       || Ahora me voy a cada una de las lineas de la factura en concreto
     |GRABA 021#19c;
     |BUCLE miralinfac;
|FPRC;

||============================== TIQUETS ==================================
|PROCESO EL5elemento;
     #12#0 = aArti;
     |LEE 000#12=;
     |SI #12#176 = "S";
          |ABRE #904;
          |DDEFECTO #904;
          #904#0 = aArti;
          #904#1 = nAlma;
          #904#2 = aEleme;
          |LEE 101#904=;
          |SI FSalida ! 0; |GRABA 020#904b; |FINSI;
          #904#3 = aDes;
          #904#12 = #904#12 - nUni;
          #904#13 = #904#13 - nUni;
          |GRABA 020#904a;
          |CIERRA #904;
     |FINSI;
|FPRC;

|PROCESO ActLinTPV;
     enSwHisto = #0#18;
     enForma = 1;
     eaTipo550 = "TI";
     |HAZ AcumulaTPVR;
     aArti = #22#2;
     nAlma = #22#3;
     aEleme = #22#27;
     aDes = #22#28;
     nUni = #22#5;
     |HAZ EL5elemento;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄHisto Color
     |SI #12#176 = "S";
          |ABRE #906;
          #906#0 = #22#2;
          #906#1 = #22#3;
          #906#2 = #21#14;
          #906#3 = "TI";
          #906#4 = #21#57;
          #906#5 = #21#58;
          #906#6 = #22#1;
          #906#7 = #22#27;
          #906#8 = #22#28;
          #906#9 = -#22#5;
          #906#10 = #22#10;
          |GRABA 000#906n;
          |CIERRA #906;
     |FINSI;
     ||------------------------Articulo (importes)
     fmes = #31#14 % A402;
     mes = ((fmes - 1) * 5) + 35;
     #12#0 = #32#2;
     |LEE 101#12=;
     |SI FSalida = 0;
          |SI #2#194 = 2;
               nImpo = ((((#32#29 * #32#10) < #32#14) < #31#17) < #31#19);
          |SINO;
               nImpo = ((((#32#5 * #32#10) < #32#14) < #31#17) < #31#19);
          |FINSI;
          |SI #142#115 = "S";
               nImpo = nImpo < #31#18;
          |FINSI;
          nMargen = nImpo - #32#23;
          #12mes = #12mes + nImpo;
          #12#95 = #12#95 + nImpo;
          mes = mes + 1;
          #12mes = #12mes + nMargen;
          #12#96 = #12#96 + nMargen;
          |GRABA 020#12a;
          |LIBERA #12;

          efFecha = #31#14;
          eaArticulo = #32#2;
          enImpVta = nImpo;
          enImpMar = nMargen;
          |HAZ AcumulaArt;
     |FINSI;
|FPRC;

|PROCESO expor502;        ||Lineas de tiquets
     |DDEFECTO #32;
     |PARA i = 0; |SI i [ n502; |HACIENDO i = i + 1;
          #32i=#22i;
     |SIGUE;
     #32#9 = #21#14;

     |GRABA 021#32c;
     |LIBERA #32;

     |HAZ ActLinTPV;

|FPRC;

|DEFBUCLE expor502;
     #22#1003;
     ;
     #21#36, #21#0, 001;
     #21#36, #21#0, 999;
     ;
     NULL, expor502;
|FIN;

|PROCESO ActCabTPV;
     |SI #31#3 > 0; beta = 1; |SINO; beta = -1; |FINSI;
     #31#3 = #31#3 * beta;
     nDto = (((#31#3 < #31#17) < #31#19) < #31#18) * beta;
     #31#3 = #31#3 * beta;
     nDto = #31#3 - nDto;   || Total Dto Cabecera
     ||-------------------- Cliente
     |DDEFECTO #11;
     #11#0 = #31#1;
     |LEE 101#11=;
     |SI FSalida ! 0; |GRABA 020#11b; |FINSI;
     fmes = #31#14 % A402;
     mes = ((fmes - 1) * 4) + 54;
     imneto = #31#3 - nDto;
     |SI #31#35 = "A";
          #11#50 = #11#50 +. imneto;
          enImpCliPen = imneto;
     |SINO;
          |SI #142#115 = "N";
               nImpo = (imneto * 100) / (100 - #31#18);
               nDto = nDto + (imneto - nImpo);
          |SINO;
               nImpo = imneto;
          |FINSI;
          #11mes = #11mes +. nImpo;
          mes = mes + 1;
          #11mes = #11mes +. nDto;
          mes = mes + 1;
          #11mes = #11mes +. #31#8;
          #11#102 = #11#102 +. nImpo;
          #11#103 = #11#103 +. nDto;
          #11#104 = #11#104 +. #31#8;
          beta = (FEntrada / 100) ! 0;
          |SI beta = 1;
               #11#45 = #31#14;
          |FINSI;
          #11#46 = #11#46 + imneto;
          #11#110 = #11#110 +. imneto;

          enImpCliCom = nImpo;
          enImpCliDto = nDto;
          enImpCliMar = #31#8;
          enImpCliFac = imneto;
     |FINSI;
     eaCliente = #31#1;
     efFecha = #31#14;
     |HAZ AcumulaCli;

     |GRABA 020#11a;
     |LIBERA #11;
|FPRC;

|PROCESO DesgExpor502;
     |DDEFECTO #32;
     |PARA i = 0; |SI i [ n502; |HACIENDO i = i + 1;
          #32i=#22i;
     |SIGUE;
     #32#9 = #21#14;

     |HAZ ActLinTPV;

     |SI nTotal ] nTotalB;
          nSwHayDesglose = 1;
          nTotalN = nTotalN - #22#7;
          #32#20 = #50#3;             || Cambia a Sesion Desglose
     |FINSI;
     nTotal = nTotal + #22#7;

     |GRABA 021#32n;
     |LIBERA #32;
|FPRC;

|DEFBUCLE DesgExpor502;
     #22#1003;
     ;
     #21#36, #21#0, 001;
     #21#36, #21#0, 999;
     ;
     NULL, DesgExpor502;
|FIN;

|PROCESO AceraCab;
     #31#3 = 0;
     #31#4 = 0;
     #31#9 = 0;
     |PARA i = 20; |SI i [ 28; |HACIENDO i = i + 1;
          #31i = 0;
     |SIGUE;
     #31#30 = 0;
     |PARA i = 47; |SI i [ 53; |HACIENDO i = i + 1;
          #31i = 0;
     |SIGUE;

     |SI #31#36 = #50#3; |Y #31#57 = #50#4; || DESGLOSE
          #31#8 = 0;   ||Margen
          #31#10 = 0;  ||Entrega
          #31#11 = 0;  ||Cambio
          #31#15 = 0;  ||Resto
          #31#38 = 0;  ||Efe
          #31#39 = 0;  ||Cheque
          #31#40 = 0;  ||Tarjeta
          #31#41 = 0;  ||Credi
          #31#54 = 0;  ||Acuenta
          #31#62 = 0;  ||Rotura
          #31#63 = 0;  ||Invita
          #31#64 = 0;  ||Invita
     |FINSI;
|FPRC;

|PROCESO acum_iva;
     iva = 0;
     |SI #32#13 = 0;
          #31#30 = #31#30 +. puente_n;||Exenta
     |FINSI;
     |SI #32#13 = 1;
           #31#20 = #31#20 +. puente_n;
           #31#21 = #31#21 +. ((puente_n % enIva)!0);
           iva = puente_n % enIva;
           |SI #31#29 = "S";            ||Tiene recargo
                #31#22 = #31#22 +. ((puente_n % enRec)!0);
                iva = iva + ((puente_n % enRec)!0);
           |FINSI;
     |FINSI;
     |SI #32#13 = 2;
          #31#23 = #31#23 +. puente_n;    || Base imponible s/decimales
          #31#24 = #31#24 +. ((puente_n % enIva)!0);
          iva = puente_n % enIva;
          |SI #31#29 = "S";            ||Tiene recargo
               #31#25 = #31#25 +. ((puente_s % enRec)!0);
               iva = iva + ((puente_n % enRec)!0);
          |FINSI;
     |FINSI;
     |SI #32#13 = 3;
          #31#26 = #31#26 +. puente_n;
          #31#27 = #31#27 +. ((puente_n % enIva)!0);
          iva = puente_n % enIva;
          |SI #31#29 = "S";            ||Tiene recargo
               #31#47 = #31#47 +. ((puente_n % enRec)!0);
               iva = iva + ((puente_n % enRec)!0);
          |FINSI;
     |FINSI;
     |SI #32#13 = 4;
          #31#48 = #31#48 +. puente_n;
          #31#49 = #31#49 +. ((puente_s % enIva)!0);
          iva = puente_s % enIva;
          |SI #31#29 = "S";            ||Tiene recargo
               #31#50 = #31#50 +. ((puente_s % enRec)!0);
               iva = iva + ((puente_s % enRec)!0);
          |FINSI;
     |FINSI;
     |SI #32#13 = 5;
          #31#51 = #31#51 +. puente_n;
          #31#52 = #31#52 +. ((puente_s % enIva)!0);
          iva = puente_s % enIva;
          |SI #31#29 = "S";            ||Tiene recargo
               #31#53 = #31#53 +. ((puente_s % enRec)!0);
               iva = iva + ((puente_s % enRec)!0);
          |FINSI;
     |FINSI;
     #31#4=#31#21+#31#22+#31#24+#31#25+#31#27+#31#47+#31#49+#31#50+#31#52+#31#53;
|FPRC;

|PROCESO CabDesglose;
     #31#3 = #31#3 +. #32#21;        ||Total bruto
     puente_n = ((#32#21 < #31#17) < #31#19) < #31#18;
     puente_s = (((#32#10 * #32#5) < #31#17) < #31#19) < #31#18;

     puente_s = puente_s ! 2;
     puente_n = puente_n ! 2;

     #31#28 = #31#28 +. (#32#21 - puente_n);   ||Total descuentos

     eaCli = #31#1;
     enTiva = #32#13;
     efFiva = #31#14;
     |HAZ IVACli;


     |HAZ acum_iva;

     #31#9 = #31#9 +. (puente_n + iva);
|FPRC;

|PROCESO DesCobro;
     a38 = 0; b38 = 0;
     a39 = 0; b39 = 0;
     a40 = 0; b40 = 0;
     a41 = 0; b41 = 0;
     a62 = 0; b62 = 0;
     a63 = 0; b63 = 0;
     a64 = 0; b64 = 0;
     nTCobro = #21#38 + #21#39 + #21#40 + #21#41 + #21#62 + #21#63 + #21#64;
     |SI nTCobro > #31#9;
          |SI #21#38 ! 0; a38 = #31#9; b38 = nTCobro - a38; |FINSI;
          |SI #21#39 ! 0; a39 = #31#9; b39 = nTCobro - a39; |FINSI;
          |SI #21#40 ! 0; a40 = #31#9; b40 = nTCobro - a40; |FINSI;
          |SI #21#41 ! 0; a41 = #31#9; b41 = nTCobro - a41; |FINSI;
          |SI #21#62 ! 0; a62 = #31#9; b62 = nTCobro - a62; |FINSI;
          |SI #21#63 ! 0; a63 = #31#9; b63 = nTCobro - a63; |FINSI;
          |SI #21#64 ! 0; a64 = #31#9; b64 = nTCobro - a64; |FINSI;

     |SINO;
          a38 = #21#38; b38 = 0;
          a39 = #21#39; b39 = 0;
          a40 = #21#40; b40 = 0;
          a41 = #21#41; b41 = 0;
          a62 = #21#62; b62 = 0;
          a63 = #21#63; b63 = 0;
          a64 = #21#64; b64 = 0;
     |FINSI;
|FPRC;

|PROCESO MiraNegativo;
     |SI #22#7 < 0;
          nSwDesglose = 0;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE MiraNegativo;
     #22#1003;
     ;
     #21#36, #21#0, 001;
     #21#36, #21#0, 999;
     ;
     NULL, MiraNegativo;
|FIN;

|DEFBUCLE CabDesglose;
     #agifa502#1;
     ;
     #agifa501#36, #agifa501#0, 001;
     #agifa501#36, #agifa501#0, 999;
     ;
     NULL, CabDesglose;
|FIN;

|PROCESO expor501;
     |PINTA 2163 , blanco1;
     pintar = #21#36 + " / " + #21#0;
     |PINTA 2163 , pintar;

    |DDEFECTO #31;
     #31#36 = #21#36;
     #31#0 = #21#0;
     |LEE 000#31=;
     |SI FSalida = 0;
          mensa ="0000El Tiquet numero : "+#21#36 + "/" +#21#0+"  YA EXISTE";
          |MENAV mensa;
          |ACABA;
     |FINSI;

     nSwDesglose = 0;
     |SI #50#2 = "S"; |Y #21#9 > 0; |Y #21#2 ! "S";      || Desglose
          |SI #50#10 ! "C"; |O #50#11 = #21#1;
               nSwDesglose = 1;
               |SI #50#6 = #21#31; |O #50#7 = #21#31; |O #50#8 = #21#31;
                    |O #50#9 = #21#31; |O #50#12 = #21#31; |O #50#13 = #21#31;
                         |O #50#14 = #21#31; |O #50#15 = #21#31;
                    nSwDesglose = 0;       || F.P excluida
               |FINSI;
               |SI nSwDesglose = 1;
                    nTCobro = 0;
                    |SI #21#38 ! 0; nTCobro = nTCobro + 1; |FINSI;
                    |SI #21#39 ! 0; nTCobro = nTCobro + 1; |FINSI;
                    |SI #21#40 ! 0; nTCobro = nTCobro + 1; |FINSI;
                    |SI #21#41 ! 0; nTCobro = nTCobro + 1; |FINSI;
                    |SI #21#62 ! 0; nTCobro = nTCobro + 1; |FINSI;
                    |SI #21#63 ! 0; nTCobro = nTCobro + 1; |FINSI;
                    |SI #21#64 ! 0; nTCobro = nTCobro + 1; |FINSI;
                    |SI nTCobro ! 1;
                         nSwDesglose = 0;  || Solo los de un tipo de cobro
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nSwDesglose = 1;
          |BUCLE MiraNegativo;
     |FINSI;

     |SI nSwPasa = 0;   || La primera vuelta son los que no desglosa
          |SI nSwDesglose = 1; |ACABA; |FINSI;
          nAcumula = nAcumula + (#21#9 * #50#5 / 100);
     |FINSI;

     |SI nSwDesglose = 0;
          |PARA i = 0; |SI i [ n501; |HACIENDO i = i + 1;
                #31i = #21i;
          |SIGUE;
          #31#6 = "N";     ||contabilizado
          #31#13 = "S";    ||impreso
          |GRABA 021#31b;
          |HAZ ActCabTPV;
          |BUCLE expor502;
     |SINO;
          nTotOrg = #21#9;
          nTotalN = #21#9 * #50#5 / 100;
          nTotalB = #21#9 - nTotalN - nAcumula;
          nTotal = 0;
          nSwHayDesglose = 0;
          |BUCLE DesgExpor502;
          nAcumula = nAcumula + nTotalN;

          |PARA i = 0; |SI i [ n501; |HACIENDO i = i + 1;
               #31i = #21i;
          |SIGUE;
          #31#6 = "N";     ||contabilizado
          #31#13 = "S";    ||impreso
          |GRABA 021#31b;
          |HAZ ActCabTPV;
          |SI nSwHayDesglose = 1;
               |HAZ AceraCab;
               |BUCLE CabDesglose;
               |||BUCLELIN 2 CabDesglose #31;
               #31#5 = #50#3;  || Sesion Desglose
               |HAZ DesCobro;
               #31#39 = a39; #31#40 = a40; #31#41 = a41; #31#62 = a62;
               #31#63 = a63; #31#64 = a64; #31#38 = a38;
               |GRABA 020#31a;
               |LIBERA #31;

               #31#36 = #50#3;
               #31#57 = #50#4;
               #31#5 = "";
               |GRABA 020#31b;
               |HAZ AceraCab;
               |BUCLE CabDesglose;
               |||BUCLELIN 2 CabDesglose #31;
               #31#39 = b39; #31#40 = b40; #31#41 = b41; #31#62 = b62;
               #31#63 = b63; #31#64 = b64; #31#38 = b38;
               |GRABA 020#31a;
          |FINSI;
     |FINSI;
     |LIBERA #31;
     |LIBERA #11;
     |SI nSwPasa = 0;
          |BORRA 020#21a;
     |FINSI;
|FPRC;

|| **********************
||============================= COBROS ====================================

|PROCESO miracobro;
     |PINTA 2163 , blanco1;
     pintar = #23#14 + " / " + #23#0;
     |PINTA 2163 , pintar;
     |DDEFECTO #33;
     |PARA i = 0; |SI i [ n513; |HACIENDO i = i + 1;
          #33i = #23i;
     |SIGUE;
     #33#15 = "N";       ||Cotabilizado
     |GRABA 001#33n;
     |SI FSalida ! 0;
          mensaje="0000El Cobro numero "+#23#14+"  -  "+#23#0+"  Ya existe, y no se grabara";
          |MENAV mensaje;
     |FINSI;
|FPRC;

|PROCESO mirapago;
     |DDEFECTO #34;
     |PINTA 2163 , blanco1;
     pintar = #24#12 + " / " + #24#0;
     |PINTA 2163 , pintar;
     |PARA i = 0; |SI i [ n512; |HACIENDO i = i + 1;
          #34i = #24i;
     |SIGUE;
     #34#13 = "N";       ||Contabilizado
     |GRABA 001#34n;
     |SI FSalida ! 0;
          |SI #24#16 ! " "; ||Entrega a Cuenta
               |LEE 101#34=;
               |SI FSalida = 0;
                    |PARA i = 0; |SI i [ n512; |HACIENDO i = i + 1;
                         #34i = #24i;
                    |SIGUE;
                    #34#13 = "N";       ||Contabilizado
                    |GRABA 001#34a;
                    |LIBERA #34;
               |FINSI;
          |SINO;
               mensaje="0000El pago numero "+#24#12+"  -  "+#24#0+" Ya existe, y no se grabara";
               |MENAV mensaje;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO pasar509;
     |DDEFECTO #35;
     |PARA i = 0; |SI i [ n509; |HACIENDO i = i + 1;
          #35i = #25i;
     |SIGUE;
     #35#60 = "S";
     #35#61 = fechaimp;
     |GRABA 001#35n;
     |LIBERA #35;
|FPRC;

********************
|DEFBUCLE 0;        ||CLientes #1
#1#1001;
;
"      ";
"zzzzzz";
e;
NULL,miracli;
|FIN;

|DEFBUCLE 1;        ||Articulos #2
#2#1001;
;
"                    ";
"zzzzzzzzzzzzzzzzzzzz";
e;
NULL,miraarti;
|FIN;

|DEFBUCLE 2;        ||Proveedor #3
#3#1001;
;
"      ";
"zzzzzz";
e;
NULL,miraprove;
|FIN;

|DEFBUCLE 3;        ||Comisionista #4
#4#1001;
;
"  ";
"zz";
e;
NULL,miracomis;
|FIN;

|DEFBUCLE 4;        ||Albaranes #5
#5#1002;
;
"     " ,       0;
"zzzzz" ,  999999;
e;
NULL,miraalba;
|FIN;

|DEFBUCLE 5;            ||Facturas de contado #9 (importar)
#9#1002;
;
"     " ,       0;
"zzzzz" ,  999999;
e;
NULL,mirafact;
|FIN;

|DEFBUCLE expor501;            ||Tiquet #21 (importar)
     #21#1002;
     ;
     #50#16,       0;
     #50#16,  999999;
     e;
     NULL, expor501;
|FIN;

|DEFBUCLE expor501F;            ||Tiquet #21 (Desglose)
     #21#3005;
     36;
     ffecha, "      ", " ", "     ", "      ", #50#16;
     ffecha, "zzzzzz", "z", "zzzzz", "zzzzzz", #50#16;
     e;
     NULL, expor501;
|FIN;

|DEFBUCLE 7;        ||Historico
#38#1006;
;
"                    ","01.01.1900","  ",000000,00000,"     ";
"zzzzzzzzzzzzzzzzzzzz","31.12.9999","zz",999999,99999,"zzzzz";
e;
NULL,mirahis;
|FIN;

|DEFBUCLE CodBarra;
     #26#1001;
     ;
     0;
     9999999;
     e;
     NULL, CodBarra;
|FIN;

|DEFBUCLE pasares;
#25#1003;
;
0     ,  0 , "00.00.0000";
99999 , 99 , "31.12.9999";
e;
NULL , pasar509;
|FIN;

|PROCESO clien;     ||Clientes
     |PINTA 2124,blanco;
     |PINTA 2124,"Clientes";
     |PATH_DAT #1 path;    || Marco camino clientes exportacion
     |ABRE #1;      |CIERRA #1;
     |ABRE #11;
     |BUCLE 0;
     |LIBERA #11;
     |CIERRA #11;
importa = 1;
|FPRC;

|PROCESO arti;      ||Articulo
     |PINTA 2124,blanco;
     |PINTA 2124,"Articulos";
     |PATH_DAT #2 path;    || Marco camino articulos exportacion
     |ABRE #2;      |CIERRA #2;
     |ABRE #12;
     |BUCLE 1;
     |LIBERA #12;
     |CIERRA #12;
importa = 1;
|FPRC;

|PROCESO prove;     ||Proveedores
     |PINTA 2124,blanco;
     |PINTA 2124,"Proveedores";
     |PATH_DAT #3 path;    || Marco camino proveedores exportacion
     |ABRE #3;      |CIERRA #3;
     |ABRE #13;
     |BUCLE 2;
     |LIBERA #13;
     |CIERRA #13;
importa = 1;
|FPRC;

|PROCESO comis;     ||Comisionistas
     |PINTA 2124,blanco;
     |PINTA 2124,"Comisionistas";
     |PATH_DAT #4 path;    || Marco camino comisionistas exportacion
     |ABRE #4;      |CIERRA #4;
     |ABRE #14;
     |BUCLE 3;
     |LIBERA #14;
     |CIERRA #14;
importa = 1;
|FPRC;

|PROCESO histo;     ||Historico
     |PINTA 2124,blanco;
     |PINTA 2124,"Historico";
     |PATH_DAT #38 path;    || Marco camino clientes exportacion
     |PATH_DAT #806 path;
     |ABRE #906;
     |ABRE #18;
     |BUCLE 7;
     |CIERRA #18;
     |CIERRA #906;
     importa = 1;
|FPRC;

|PROCESO alba; ||albaranes
     |PINTA 2124,blanco;
     |PINTA 2124,"Albaranes";
     |PATH_DAT #5 path;      || Marco camino del fichero de albaranes a importar
     |PATH_DAT #6 path;      || Marco camino del fichero de albaranes Lin. a importar
     |PATH_DAT #805 path;
     |ABRE #5;      |CIERRA #5;     || Abro fichero de albaranes a importar
     |ABRE #6;      |CIERRA #6;     || Abro fichero de lin albaranes a importar
     |ABRE #15;     ||ALbaranes
     |ABRE #16;     ||Lineas de albaran
     |ABRE #905;
     |BUCLE 4;
     |CIERRA #905;
     |CIERRA #15;
     |CIERRA #16;
importa = 1;
|FPRC;

|PROCESO cont; ||Facturas de contado
     |PINTA 2124,blanco;
     |PINTA 2124,"Facturas ";
     |PATH_DAT #9 path;      || Marco camino del fichero de facturas a importar
     |PATH_DAT #10 path;      || Marco camino del fichero de facturas Lin. a importar
     |PATH_DAT #805 path;
     |ABRE #9;      |CIERRA #9;   || Abro fichero de facturas a importar
     |ABRE #10;     |CIERRA #10;  || Abro fichero de lin facturas a importar
     |ABRE #19;     ||Facturas contado
     |ABRE #20;     ||Lineas de factura contado
     |ABRE #905;
     |BUCLE 5;
     |CIERRA #905;
     |CIERRA #15;
     |CIERRA #16;
importa = 1;
|FPRC;

|PROCESO tique;     ||Tiquets
     |PINTA 2124,blanco;
     |PINTA 2124,"Tiquets  ";
     |PATH_DAT #21 path;      || Marco camino del fichero de tiquets a importar
     |PATH_DAT #22 path;      || Marco camino del fichero de tiquets Lin. a importar
     |ABRE #21;     |CIERRA #21;      || Abro fichero de tiquets a importar
     |ABRE #22;     |CIERRA #22;      || Abro fichero de lin tiquets a importar
     |ABRE #31;
     |ABRE #32;

     |ABRE #21;
     |SELECT #3#21;
     |LEE 000#21p; fDfecha = #21#14;
     |LEE 000#21u; fAfecha = #21#14;
     |CIERRA #21;

     |SALVA_FICHA #50;
     FSalida = 0;
     |PARA; |SI nTienda = #50#0; |Y FSalida = 0; |HACIENDO;
          |SI #50#2 = "S";       || Desglose de Tiquets
               |PARA ffecha = fDfecha; |SI ffecha [ fAfecha; |HACIENDO ffecha=ffecha+1;
                    nAcumula = 0;
                    nSwPasa = 0;
                    |BUCLE expor501F;
                    nSwPasa = 1;
                    |BUCLE expor501F;
               |SIGUE;
          |SINO;
               nSwPasa = 1;
               |BUCLE expor501;
          |FINSI;
          |LEE 000#50s;
     |SIGUE;
     |REPON_FICHA #50;

     |CIERRA #32;
     |CIERRA #31;
importa = 1;
|FPRC;

|PROCESO cobro;     ||Cobros
     |PINTA 2124,blanco;
     |PINTA 2124,"Cobros";
     |PATH_DAT #23 path;    || Marco camino cobros exportacion
     |ABRE #23;
     |ABRE #33;
     |LEE 001#23p;
     |PARA ; |SI FSalida = 0; |HACIENDO;
          |HAZ miracobro;
          |LEE 001#23s;
     |SIGUE;
     |CIERRA #33;
     |CIERRA #23;
importa = 1;
|FPRC;

|PROCESO pagos;     ||Pagos
     |PINTA 2124,blanco;
     |PINTA 2124,"Pagos";
     |PATH_DAT #24 path;    || Marco camino Pagos exportacion
     |ABRE #24;
     |ABRE #34;
     |LEE 001#24p;
     |PARA ;|SI FSalida = 0; |HACIENDO;
          |HAZ mirapago;
          |LEE 001#24s;
     |SIGUE;
     |CIERRA #34;
     |CIERRA #24;
importa = 1;
|FPRC;

|PROCESO Barra;
     |PINTA 2124,blanco;
     |PINTA 2124,"Cod.Barras";
     |PATH_DAT #26 path;    || Marco camino comisionistas exportacion
     |ABRE #26;      |CIERRA #26;
     |ABRE #36;
     |BUCLE CodBarra;
     |LIBERA #36;
     |CIERRA #36;
importa = 1;
|FPRC;

|PROCESO testig;
     |SI importa = 1;    ||Es se¤al de que ha podido  importar datos
          |PATH_DAT #61 path;
          |ABRE #61;
          |LEE 101#61=;
          #61#4 = "S";
          fechaimp = ~;
          #61#5 = fechaimp;
          horat = aHora % 102 + aHora % 402;
          #61#6 = horat;
          |GRABA 001#61a;
          |LIBERA #61;
          |CIERRA #61;
     |FINSI;
|FPRC;

|PROCESO cierre;
     |PATH_DAT #25 path;
     |ABRE #25;     |CIERRA #25;
     |ABRE #35;
     |BUCLE pasares;
     |CIERRA #35;
|FPRC;
=======================================================================
|PROCESO Importa;
     importa = 0;
     |SI #0#6 = "S";     |HAZ clien;    |FINSI;
     |SI #0#7 = "S";     |HAZ arti;     |FINSI;
     |SI #0#8 = "S";     |HAZ prove;    |FINSI;
     |SI #0#9 = "S";     |HAZ comis;    |FINSI;
     |SI #0#22 = "S";     |HAZ histo;    |FINSI;
     |ABRE #11;      ||Abro clientes
     |ABRET #12;     ||Articulos
     |ABRET #18;     ||Historico
     |SI #0#10 = "S";    |HAZ alba;     |FINSI;
     |SI #0#11 = "S";    |HAZ cont;     |FINSI;

     |SI #0#12 = "S";    |HAZ tique;    |FINSI;
     |CIERRA #11;
     |CIERRAT #12;
     |CIERRAT #18;
     |SI #0#13 = "S";    |HAZ cobro;    |FINSI;
     |SI #0#14 = "S";    |HAZ pagos;    |FINSI;
     |SI #0#23 = "S";    |HAZ Barra;    |FINSI;
     |SI nSwMarhu = 1;
          |PINTA 2124,blanco;
          |PINTA 2124,"Pedidos Reposicion";
          |PATH_DAT #434 path;
          |PATH_DAT #435 path;
          |ABRE #334;
          |ABRE #335;
          |BUCLE marhu334;
          |CIERRA #334;
          |CIERRA #335;
          importa = 1;
     |FINSI;
     |SI importa = 1;    |HAZ testig;   |FINSI;
     |HAZ cierre;
|FPRC;

|PROCESO Importacion;
     |PATH_DAT #61 path;
     |ABRE #61;
     |LEE 001#61p;
     |SI FSalida ! 0;
          mensaje = "0000No encuentro testigo para tienda: " + #51#0;
          |MENAV mensaje;
          |CIERRA #61;
          |ACABA;
     |FINSI;
     |SI #61#0 = #50#0;
          |PINTA 1535 , #61#1;
          |SI #61#4 = "S";
               |AVISO;
               |PINTA 1635 , #61#5;
               hora = #61#6;
               horat = hora % 102 + ":" + hora % 302;
               |PINTA 1735 , horat;
               hora = "";
               horat =  "";
               |CONFI "2400N!!ATENCION!! Esta Empresa ya ha sido importada, Repetir Importacion :";
               |SI FSalida ! 0; |ACABA;  |FINSI;
          |FINSI;
          |HAZ Importa;
          |HAZ ActHisto;
          nHay = 1;
     |SINO;
          mensaje = "0000Esta empresa " + #50#0 + " No se corresponde con la empresa de importacion:" + #61#0;
          |MENAV mensaje;
     |FINSI;
     |CIERRA #61;
|FPRC;
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
|PROCESO BorraExpor;
     aFic1 = path;
     |_PDIR aFic1;
     |PARA; |SI FSalida = 0; |HACIENDO;
          aAlfa = aFic1 % -103;
          |SI aAlfa = "ddx"; |O aAlfa = "ixx"; |O aAlfa = "dat";
               aAlfa = aFic1 % -0805;
               |SI aAlfa = "expor"; |FBORRA aFic1; |FINSI;
               aAlfa = aFic1 % -0507;
               |SI aAlfa = "testigo"; |FBORRA aFic1; |FINSI;
          |FINSI;
          |_SDIR aFic1;
     |SIGUE;
|FPRC;

|PROCESO DesComprime;
     ||---------Chequeo del fichero (debe se todo con numeros)
     ||         DETAR se cuelga si el fichero no es un tar
     err = 0;
     |QBF aFic;
     aAlfa = aFic % -115;
     |PARA i = 101; |SI i [ 1500; |HACIENDO i = i + 100;
          aAlf1 = (aAlfa % i);
          |SI aAlf1 < "0"; |O aAlf1 > "9";
               |SI i = 1201; |Y aAlf1 = ".";
               |SINO;
                    err = 1;
                    |SAL;
               |FINSI;
          |FINSI;
     |SIGUE;
     ||----------
     |SI err = 0;
          aAlfa = aFic % A0;
          nLon = aAlfa;
          nLon = nLon + 100 - 4;
          aOrg = aFic % nLon;
          aExt = aFic % -104;
          aGz  = aOrg + ".gz";

          |RENOMBRA_FICHERO aFic, aGz;
          |DESCOMPRIME aGz;
          |RENOMBRA_FICHERO aOrg, aFic;

          |XABRE "B", aFic, nHandle;
          |XLEE nHandle, 1, aAlfa;
          nHay = FSalida;
          |XCIERRA nHandle;

          |SI nHay > 0;
               |DETAR aFic, path;
               nSal = FSalida;
               |FBORRA aFic;
               |RENOMBRA_FICHERO aGz, aFic;
          |FINSI;

          |SI nSal = 0;
               err = 0;
          |SINO;
               err = 1;
               aAlfa = "0000Error en... [" + aFic + "]";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ActHisto;
     |ABRE #100;
     |SELECT #1#100;
     #100#0 = "I";
     #100#1 = fFecha;
     #100#2 = 999;
     |LEE 000#100];
     |SI FSalida = 0;
          |LEE 000#100a;
     |SINO;
          |LEE 000#100u;
     |FINSI;
     |SI FSalida = 0; |Y #100#0 = "I"; |Y #100#1 = fFecha;
          nLin = #100#2 + 1;
     |SINO;
          nLin = 1;
     |FINSI;

     |DDEFECTO #100;
     #100#0 = "I";
     #100#1 = fFecha;
     #100#2 = nLin;
     #100#3 = aHora;
     #100#4 = Usuario % 810;
     #100#5 = aFic % -115;
     |GRABA 020#100n;
     |CIERRA #100;
|FPRC;

|PROCESO BuscaFichero;
     |HAZ BorraExpor;
     err = 1;
     |ABRE #100;
     aFic = path;
     |_PDIR aFic;
     |PARA; |SI FSalida = 0; |HACIENDO;
          aEmp = aFic % -505;
          |SI aEmp = #50#0;
               aAlfa = aFic % -115;
               |SELECT #2#100;
               #100#0 = "I";
               #100#5 = aAlfa;
               |LEE 000#100=;
               |SI FSalida ! 0;
                    #999#4 = aAlfa;
                    aAlfa = (aAlfa % 0502) + (aAlfa % 0302) + (aAlfa % 0102) + (aAlfa % -109);
                    #999#1 = aAlfa;
                    |GRABA 020#999n;
               |FINSI;
          |FINSI;
          |_SDIR aFic;
     |SIGUE;
     |CIERRA #100;
     ||ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     |LEE 000#999p;
     |PARA; |SI FSalida = 0; |HACIENDO;
          aFic = path + #999#4;
          |HAZ DesComprime;
          |SI err = 0;
               |HAZ Importacion;
          |FINSI;
          |LEE 000#999s;
     |SIGUE;
|FPRC;

|PROCESO agifa556;
     |SI nTienda ! #50#0;
          nTienda = #50#0;
          |SALVA_FICHA #50;
          |DDEFECTO #51;
          #51#0 = #50#0;
          |LEE 000#51=;
          path = #51#1; |QBF path;
          |SI path ! "";
               |DELINDEX #999;
               |ABRE #999;
               |HAZ BuscaFichero;
               |CIERRA #999;
          |FINSI;
          |REPON_FICHA #50;
     |FINSI;
|FPRC;

|DEFBUCLE agifa556;
     #50#1;
     ;
     #0#20,"     ";
     #0#21,"zzzzz";
     ;
     NULL, agifa556;
|FIN;

|PROCESO inicio;|TIPO 3;
     |SI #0#15 ! "SI"; |ACABA;  |FINSI;
     |ABRE #142; |LEE 000#142p; |CIERRA #142;

     |HAZ BusCampos;
     |SI err ! 0;
          |MENAV "0000Proceso Anulado...";
          |ACABA;
     |FINSI;

     |HAZ CargaDef;
     |SI swErr ! 0;
          aMensa = "0000Error al cargar:" + aDef;
          |MENAV aMensa;
          |HAZ DesCargaDef;
          |ACABA;
     |FINSI;

     |SI #0#24 = "S";
          |CONFI "0000SRecibir datos desde TPV ahora: ";
          |SI FSalida = 0;
               |MENAV "0000Atencion!! Debe estar conectado a internet";
               |SUB_EJECUTA "dsm00208.tab";
          |FINSI;
     |FINSI;

     |ABRE #51;
     |BUCLE agifa556;
     |CIERRA #51;

     |HAZ DesCargaDef;

     |SI nHay ! 0;
          |CONFI "    NRecalcular stocks a continuacion (S/N): ";
          |SI FSalida=0;
               |SUB_EJECUTA_NP "agifa068.tab";
          |FINSI;
     |FINSI;

|FPRC;
=======================================================================
|PROCESO BusCampos;
     |DFICE org; |QBF org;
     |DBASE des; |QBF des;
     |DDEF  def; |QBF def;
     eaNomDef = "agifa024"; |HAZ CamposDef; n024 = enCamposDef;
     eaNomDef = "agifa019"; |HAZ CamposDef; n019 = enCamposDef;
     eaNomDef = "agifa112"; |HAZ CamposDef; n112 = enCamposDef;
     eaNomDef = "agifa025"; |HAZ CamposDef; n025 = enCamposDef;
     eaNomDef = "agifa010"; |HAZ CamposDef; n010 = enCamposDef;
     eaNomDef = "agifa071"; |HAZ CamposDef; n071 = enCamposDef;
     eaNomDef = "agifa084"; |HAZ CamposDef; n084 = enCamposDef;
     eaNomDef = "agifa069"; |HAZ CamposDef; n069 = enCamposDef;
     eaNomDef = "agifa501"; |HAZ CamposDef; n501 = enCamposDef;
     eaNomDef = "agifa502"; |HAZ CamposDef; n502 = enCamposDef;
     eaNomDef = "agifa513"; |HAZ CamposDef; n513 = enCamposDef;
     eaNomDef = "agifa512"; |HAZ CamposDef; n512 = enCamposDef;
     eaNomDef = "agifa509"; |HAZ CamposDef; n509 = enCamposDef;
     eaNomDef = "agifa065"; |HAZ CamposDef; n565 = enCamposDef;
     eaNomDef = "dsl00001"; |HAZ CamposDef; n001 = enCamposDef;
     eaNomDef = "dsm00005"; |HAZ CamposDef; n905 = enCamposDef;
     eaNomDef = "dsm00006"; |HAZ CamposDef; n906 = enCamposDef;
|FPRC;

|PROCESO Marhuenda;
     aAlfa = ""; |DBIN aAlfa;
     aAlfa = aAlfa + "marhu334.tab";
     |XABRE "E", aAlfa, 0;
     |SI FSalida = 0
          |DBASE aPath;
          aAlfa = aPath + "def/marhu334";
          |CARGA_DEF aAlfa, marhu334@;
          |SI FSalida = 0;
               aAlfa = aPath + "def/marhu335";
               |CARGA_DEF aAlfa, marhu335@;
               |SI FSalida = 0;
                    nSwMarhu = 1;
               |SINO;
                    aAlfa = "0000Error al cargar " + aAlfa;
                    |MENAV aAlfa;
               |FINSI;
          |SINO;
               aAlfa = "0000Error al cargar " + aAlfa;
               |MENAV aAlfa;
          |FINSI;

     |FINSI;
|FPRC;

|PROGRAMA;
     |HAZ Marhuenda;

     |HAZ CreaTempo; aTempo999 = Tempo;
     |NOME_DAT #999 aTempo999; |DELINDEX #999;

     aParam = PARAMETRO; |QBF aParam;
     fFecha = ~;
     |HORA aHora;
     |SI aParam = "";
          |MANTE #0;
     |SINO;
          ||------------- El Parametro trae el nombre del fichero
          aAlfa = aParam % 705;         ||la empresa
          |ABRE #50;
          |ABRE #51;
          #50#0 = aAlfa;
          #50#16 = "";
          |LEE 020#50];
          |SI FSalida = 0;
               nTienda = #50#0;
               #51#0 = nTienda;
               |LEE 000#51=;
               |SI FSalida = 0;
                    path = #51#1; |QBF path;
                    |SI path ! "";
                         |HAZ BorraExpor;
                         |ABRE #142; |LEE 000#142p; |CIERRA #142;
                         |HAZ BusCampos;
                         |SI err ! 0;
                              |MENAV "0000Proceso Anulado...";
                              |CIERRA #50;
                              |CIERRA #51;
                              |DELINDEX #999; Tempo = aTempo999; |HAZ BoraTempo;
                              |ACABA;
                         |FINSI;
                         |HAZ CargaDef;
                         |SI swErr ! 0;
                              aMensa = "0000Error al cargar:" + aDef;
                              |MENAV aMensa;
                              |CIERRA #50;
                              |CIERRA #51;
                              |HAZ DesCargaDef;
                              |DELINDEX #999; Tempo = aTempo999; |HAZ BoraTempo;
                              |ACABA;
                         |FINSI;
                         aFic = path + aParam;
                         |HAZ DesComprime;
                         |SI err = 0;
                              |HAZ Importacion;
                         |FINSI;
                         |HAZ DesCargaDef;
                    |FINSI;
               |FINSI;
          |FINSI;
          |CIERRA #50;
          |CIERRA #51;
     |FINSI;

     |DELINDEX #999; Tempo = aTempo999; |HAZ BoraTempo;
     |SI nSwMarhu = 1;
          |DESCARGA_DEF #marhu334@;
          |DESCARGA_DEF #marhu335@;
     |FINSI;
|FPRO;

|PROCESO CargaDef;
     |DBASE aPath;

     aDef1 = aPath + "def/" + "agifa024";
     aDef  = aDef1;
     |CARGA_DEF aDef, expor024@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef1 = "";
          |ACABA;
     |FINSI;
     aDef2 = aPath + "def/" + "agifa019";
     aDef  = aDef2;
     |CARGA_DEF aDef, expor019@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef2 = "";
          |ACABA;
     |FINSI;
     aDef3 = aPath + "def/" + "agifa112";
     aDef  = aDef3;
     |CARGA_DEF aDef, expor112@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef3 = "";
          |ACABA;
     |FINSI;
     aDef4 = aPath + "def/" + "agifa025";
     aDef  = aDef4;
     |CARGA_DEF aDef, expor025@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef4 = "";
          |ACABA;
     |FINSI;
     aDef5 = aPath + "def/" + "agifa065";
     aDef  = aDef5;
     |CARGA_DEF aDef, expor065@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef5 = "";
          |ACABA;
     |FINSI;
     aDef6 = aPath + "def/" + "dsl00001";
     aDef  = aDef6;
     |CARGA_DEF aDef, expor001@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef6 = "";
          |ACABA;
     |FINSI;
     aDef7 = aPath + "def/" + "agifa010";
     aDef  = aDef7;
     |CARGA_DEF aDef, expor010@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef7 = "";
          |ACABA;
     |FINSI;
     aDef8 = aPath + "def/" + "dsm00006";
     aDef  = aDef8;
     |CARGA_DEF aDef, expord06@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef8 = "";
          |ACABA;
     |FINSI;
     aDef9 = aPath + "def/" + "agifa071";
     aDef  = aDef9;
     |CARGA_DEF aDef, expor071@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef9 = "";
          |ACABA;
     |FINSI;
     aDef10 = aPath + "def/" + "agifa084";
     aDef  = aDef10;
     |CARGA_DEF aDef, expor084@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef10 = "";
          |ACABA;
     |FINSI;
     aDef11 = aPath + "def/" + "agifa069";
     aDef  = aDef11;
     |CARGA_DEF aDef, expor069@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef11 = "";
          |ACABA;
     |FINSI;
     aDef12 = aPath + "def/" + "agifa501";
     aDef  = aDef12;
     |CARGA_DEF aDef, expor501@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef12 = "";
          |ACABA;
     |FINSI;
     aDef13 = aPath + "def/" + "agifa502";
     aDef  = aDef13;
     |CARGA_DEF aDef, expor502@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef13 = "";
          |ACABA;
     |FINSI;
     aDef14 = aPath + "def/" + "agifa513";
     aDef  = aDef14;
     |CARGA_DEF aDef, expor513@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef14 = "";
          |ACABA;
     |FINSI;
     aDef15 = aPath + "def/" + "agifa512";
     aDef  = aDef15;
     |CARGA_DEF aDef, expor512@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef15 = "";
          |ACABA;
     |FINSI;
     aDef16 = aPath + "def/" + "agifa509";
     aDef  = aDef16;
     |CARGA_DEF aDef, expor509@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef16 = "";
          |ACABA;
     |FINSI;
     aDef17 = aPath + "def/" + "dsm00005";
     aDef  = aDef17;
     |CARGA_DEF aDef, expord05@;
     |SI FSalida ! 0;
          swErr = 1;
          aDef17 = "";
          |ACABA;
     |FINSI;
     |SI nSwMarhu = 1;
          aDef18 = aPath + "def/" + "marhu334";
          aDef  = aDef18;
          |CARGA_DEF aDef, expor334@;
          |SI FSalida ! 0;
               swErr = 1;
               aDef18 = "";
               |ACABA;
          |FINSI;
          aDef19 = aPath + "def/" + "marhu335";
          aDef  = aDef19;
          |CARGA_DEF aDef, expor335@;
          |SI FSalida ! 0;
               swErr = 1;
               aDef19 = "";
               |ACABA;
          |FINSI;
     |FINSI;
     |HAZ NomeDat;
|FPRC;

|PROCESO DesCargaDef;
     |SI nSwMarhu = 1;
          |SI aDef19 ! ""; |DESCARGA_DEF #expor335@; |FINSI;
          |SI aDef18 ! ""; |DESCARGA_DEF #expor334@; |FINSI;
     |FINSI;
     |SI aDef17 ! ""; |DESCARGA_DEF #expord05@; |FINSI;
     |SI aDef16 ! ""; |DESCARGA_DEF #expor509@; |FINSI;
     |SI aDef15 ! ""; |DESCARGA_DEF #expor512@; |FINSI;
     |SI aDef14 ! ""; |DESCARGA_DEF #expor513@; |FINSI;
     |SI aDef13 ! ""; |DESCARGA_DEF #expor502@; |FINSI;
     |SI aDef12 ! ""; |DESCARGA_DEF #expor501@; |FINSI;
     |SI aDef11 ! ""; |DESCARGA_DEF #expor069@; |FINSI;
     |SI aDef10 ! ""; |DESCARGA_DEF #expor084@; |FINSI;
     |SI aDef9  ! ""; |DESCARGA_DEF #expor071@; |FINSI;
     |SI aDef8  ! ""; |DESCARGA_DEF #expord06@; |FINSI;
     |SI aDef7  ! ""; |DESCARGA_DEF #expor010@; |FINSI;
     |SI aDef6  ! ""; |DESCARGA_DEF #expor001@; |FINSI;
     |SI aDef5  ! ""; |DESCARGA_DEF #expor065@; |FINSI;
     |SI aDef4  ! ""; |DESCARGA_DEF #expor025@; |FINSI;
     |SI aDef3  ! ""; |DESCARGA_DEF #expor112@; |FINSI;
     |SI aDef2  ! ""; |DESCARGA_DEF #expor019@; |FINSI;
     |SI aDef1  ! ""; |DESCARGA_DEF #expor024@; |FINSI;
|FPRC;

|PROCESO NomeDat;
     |SI nSwMarhu = 1;
          |NOME_DAT #435 "expor335";     ||   19
          |NOME_DAT #434 "expor334";     ||   18
     |FINSI;
     |NOME_DAT #805 "expord05";     ||   17
     |NOME_DAT #25  "expor509";     ||   16
     |NOME_DAT #24  "expor512";     ||   15
     |NOME_DAT #23  "expor513";     ||   14
     |NOME_DAT #22  "expor502";     ||   13
     |NOME_DAT #21  "expor501";     ||   12
     |NOME_DAT #10  "expor069";     ||   11
     |NOME_DAT #9   "expor084";     ||   10
     |NOME_DAT #6   "expor071";     ||   9
     |NOME_DAT #806 "expord06";     ||   8
     |NOME_DAT #5   "expor010";     ||   7
     |NOME_DAT #26  "expor001";     ||   6
     |NOME_DAT #38  "expor065";     ||   5
     |NOME_DAT #4   "expor025";     ||   4
     |NOME_DAT #3   "expor112";     ||   3
     |NOME_DAT #2   "expor019";     ||   2
     |NOME_DAT #1   "expor024";     ||   1
|FPRC;
