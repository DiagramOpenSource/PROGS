
   NOTA: EL CALCULO ES COMUN PARA LOS DEF'S  obras011 y obras008



|FICHEROS;
     canempre@ #1;      || empresas contables
     calibros@ #2;      || libros IVA
     cacuenta@ #4;      || plan contable
     caconasi@ #5;      || contador de documentos
     caenlace@ #6;      || puente enlace

     obraz002 #0;   ||Tmp enlace
     obras008 #8;
     obras009 #9;
     agifa024 #24;
     obras037 #37;  ||Parametros
     obras035 #35,MANTE;  ||Hipoteca C
     obras036 #36;  ||         L
     agifa084 #84;  ||Factura
|FIN;

|VARIABLES;
     &enSwConta = 0;
     &PRMNT_enVer   = 0;
     nErr = 0;
     aDef1 = "";
     aDef2 = "";
     aDef3 = "";
     aDef4 = "";
     aDef5 = "";
     aDef6 = "";
     aAlfa = "";
     aNom = "";
     aPath = "";
     fFecha = @;

     aPathConta1 = "";
     aPathConta2 = "";
     &fich_alta = "";

     aAlfa1 = "";
     nNume1 = 0;
     nEjercicio = 0;
     aDescrip = "";
     nBase = 0;
     nCuota = 0;
     nDocumento = 0;
     nNivel = 0;
     aCuenta = "";
     nDocuAnt = 0;
     nApu = 0;
|FIN;

|PROCESO obras009;
     nApu = nApu + 1;
     #0#0 = #37#5; ||Diario
     #0#1 = #9#7;  ||Fecha
     #0#2 = 1;     ||Doc
     #0#3 = nApu;  ||Apunte

     #0#4 = #8#22; ||Cuenta
     #0#5 = "D";   ||Signo
     #0#6 = #37#6; ||Concepto
     #0#7 = #9#6;  ||Descripcion
     #0#8 = #9#9;  ||Importe
     |GRABA 020#0n;

     nApu = nApu + 1;
     #0#3 = nApu;
     #0#4 = #24#16;
     #0#5 = "H";
     |GRABA 020#0n;

     #9#11 = "S";
     |GRABA 020#9a;
     |LIBERA #9;
|FPRC;

|DEFBUCLE obras009;
     #9#1;
     11, 10;
     #8#0, #8#1, #8#2, #8#3, 000, "N", 0;
     #8#0, #8#1, #8#2, #8#3, 999, "N", 0;
     be;
     NULL, obras009;
|FIN;

|PROCESO EnCobros;
     |BUCLE obras009;
|FPRC;

|PROCESO EnTotaHipo;
     |ABRE #35;
     #35#0 = #8#0;
     #35#1 = #8#1;
     #35#2 = #8#2;
     #35#3 = #8#3;
     |LEE 101#35=;
     |SI FSalida = 0; |Y #35#7 = "N";
          aAlfa = "Hipoteca " + (("000" + #8#0) % -103);
          aAlfa = aAlfa + (("000" + #8#1) % -103);
          aAlfa = aAlfa + (("000" + #8#2) % -103);
          aAlfa = aAlfa + (("000" + #8#3) % -103);
          fFecha = ~;
          |SI #8#19 = "S";
               |ABRE #84;
               #84#48 = #8#20;
               #84#0 = #8#21;
               |LEE 000#84=;
               |SI FSalida = 0;
                    fFecha = #84#1;
               |FINSI;
               |CIERRA #84;
          |FINSI;
          nApu = nApu + 1;
          #0#0 = #37#5; ||Diario
          #0#1 = fFecha;||Fecha
          #0#2 = 1;     ||Doc
          #0#3 = nApu;  ||Apunte

          #0#4 = #35#5; ||Cuenta
          #0#5 = "D";   ||Signo
          #0#6 = #37#6; ||Concepto
          #0#7 = aAlfa; ||Descripcion
          #0#8 = #35#4;  ||Importe
          |GRABA 020#0n;

          nApu = nApu + 1;
          #0#3 = nApu;
          #0#4 = #24#16;
          #0#5 = "H";
          |GRABA 020#0n;

          #35#7 = "S";
          |GRABA 020#35a;
     |FINSI;
     |CIERRA #35;
|FPRC;

|PROCESO obras036;
     aAlfa = "Dispuesto " + (("000" + #8#0) % -103);
     aAlfa = aAlfa + (("000" + #8#1) % -103);
     aAlfa = aAlfa + (("000" + #8#2) % -103);
     aAlfa = aAlfa + (("000" + #8#3) % -103);

     nApu = nApu + 1;
     #0#0 = #37#5; ||Diario
     #0#1 = #36#7;  ||Fecha
     #0#2 = 1;      ||Doc
     #0#3 = nApu;   ||Apunte

     #0#4 = #36#6; ||Cuenta
     #0#5 = "D";   ||Signo
     #0#6 = #37#6; ||Concepto
     #0#7 = aAlfa; ||Descripcion
     #0#8 = #36#5; ||Importe
     |GRABA 020#0n;

     nApu = nApu + 1;
     #0#3 = nApu;
     #0#4 = #35#5;
     #0#5 = "H";
     |GRABA 020#0n;

     #36#8 = "S";
     |GRABA 020#36a;
|FPRC;

|DEFBUCLE obras036;
     #36#1;
     8;
     #8#0, #8#1, #8#2, #8#3, 000, "N";
     #8#0, #8#1, #8#2, #8#3, 111, "N";
     be;
     NULL, obras036;
|FIN;

|PROCESO EnLinHipo;
     |ABRE #35;
     #35#0 = #8#0;
     #35#1 = #8#1;
     #35#2 = #8#2;
     #35#3 = #8#3;
     |LEE 000#35=;
     |SI FSalida = 0;
          |BUCLE obras036;
     |FINSI;
     |CIERRA #35;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO SacaNivel;
     nNivel = 0;
     |QBF aCuenta; aAlfa1 = aCuenta % 0; nNume1 = aAlfa1;
     |SI #canempre@#14 = nNume1; nNivel = 1; |FINSI;
     |SI #canempre@#15 = nNume1; nNivel = 2; |FINSI;
     |SI #canempre@#16 = nNume1; nNivel = 3; |FINSI;
     |SI #canempre@#17 = nNume1; nNivel = 4; |FINSI;
     |SI #canempre@#18 = nNume1; nNivel = 5; |FINSI;
     |SI #canempre@#19 = nNume1; nNivel = 6; |FINSI;
|FPRC;

|PROCESO Contador;
     |ABRE #caconasi@;
     |LEE 101#caconasi@.p;
     |SI FSalida ! 0;
          |DDEFECTO #caconasi@;
          |GRABA 020#caconasi@.b;
     |FINSI;

     #caconasi@#1 = #caconasi@#1 + 1;

     |GRABA 020#caconasi@.a;
     |LIBERA #caconasi@;
     |CIERRA #caconasi@;
|FPRC;

|PROCESO obraz002;
     |SI nDocuAnt ! #obraz002#2;
          |HAZ Contador;
          nDocuAnt = #obraz002#2;
     |FINSI;

     #caenlace@#0 = #obraz002#0;         || diario
     #caenlace@#1 = #obraz002#1;         || fecha
     #caenlace@#2 = #caconasi@#1;         || documento
     #caenlace@#3 = #obraz002#3;         || apunte
     #caenlace@#4 = #obraz002#4;         || cuenta
     aCuenta = #caenlace@#4; |HAZ SacaNivel;
     #caenlace@#5 = nNivel;
     #caenlace@#6 = #obraz002#6;         || cod.concepto
     #caenlace@#7 = #obraz002#7;         || descripcion
     #caenlace@#8 = #obraz002#5;         || signo
     #caenlace@#9 = #obraz002#8;         || importe
     #caenlace@#37 = #37#2;        || empresa
     #caenlace@#38 = #37#3;        || periodo
|| ------------------------------ MODIFICACIONES JOAN ---------------
     #caenlace@#10 = "R";
     #caenlace@#11 = "";        ||Cuenta Cliente
     #caenlace@#12 = #37#3;     ||periodo
     #caenlace@#13 = #37#4;     ||Libro IVA
     |SI #obraz002#3 = 1; #caenlace@#26 = "F" ; |FINSI; || Tipo Acumulador = " "
     |SI #obraz002#3 = 2; #caenlace@#26 = "B" ; |FINSI; || Tipo Acumulador = "B"
     |SI #obraz002#3 = 3; #caenlace@#26 = "I" ; |FINSI; || Tipo Acumulador = "I"

     |SI #obraz002#3 = 1; || Numero de Acumulador
          #caenlace@#27 = 1;
     |SINO;
          #caenlace@#27 = 1;
     |FINSI;

  ||   #caenlace@#29 = "" || Fecha; *********************

     |GRABA 020#caenlace@.n;
|FPRC;

|DEFBUCLE obraz002;
     #0#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, obraz002;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO CargaDef;
     nErr = 0;
     aPath = #37#1; |QBF aPath;
     aDef1 = aPath + "/def/caenlace"; |CARGA_DEF aDef1, caenlace@;
     |SI FSalida ! 0; aDef1 = ""; nErr = 1; |FINSI;

     aDef2 = aPath + "/def/caconasi"; |CARGA_DEF aDef2, caconasi@;
     |SI FSalida ! 0; aDef2 = ""; nErr = 1; |FINSI;

     aDef3 = aPath + "/def/cacuenta"; |CARGA_DEF aDef3, cacuenta@;
     |SI FSalida ! 0; aDef3 = ""; nErr = 1; |FINSI;

     aDef5 = aPath + "/def/calibros"; |CARGA_DEF aDef5, calibros@;
     |SI FSalida ! 0; aDef5 = ""; nErr = 1; |FINSI;

     aDef6 = aPath + "/def/canempre"; |CARGA_DEF aDef6, canempre@;
     |SI FSalida ! 0; aDef6 = ""; nErr = 1; |FINSI;
|FPRC;

|PROCESO DescargaDef;
     |SI aDef6 ! ""; |DESCARGA_DEF #canempre@; |FINSI;
     |SI aDef5 ! ""; |DESCARGA_DEF #calibros@; |FINSI;
     |SI aDef3 ! ""; |DESCARGA_DEF #cacuenta@; |FINSI;
     |SI aDef2 ! ""; |DESCARGA_DEF #caconasi@; |FINSI;
     |SI aDef1 ! ""; |DESCARGA_DEF #caenlace@; |FINSI;
|FPRC;

|PROCESO Path;
     aPath = #37#1; |QBF aPath;
     aPathConta1 = aPath + "/fich/";
     aAlfa = #37#2;

     aAlfa = ("00000" + aAlfa) % -105;
     aPathConta2 = aPathConta1 + aAlfa + #37#3 + "/";

     |PATH_DAT #canempre@#aPathConta1#;
     |PATH_DAT #calibros@#aPathConta2#;
     |PATH_DAT #cacuenta@#aPathConta2#;
     |PATH_DAT #caconasi@#aPathConta2#;
     |PATH_DAT #caenlace@#aPathConta2#;
|FPRC;

|PROCESO Contabiliza;
     |ABRE #37; |LEE 000#37p; |CIERRA #37;
     |HAZ CargaDef;
     |SI nErr = 0;
          |HAZ Path;
          |ABRE #canempre@;
          #canempre@#2 = #37#2;
          #canempre@#3 = #37#3;
          |LEE 000#canempre@.=;
          |SI FSalida ! 0;
               |MENAV "0000No existe empresa contable...";
          |SINO;
               nEjercicio = #canempre@#26;
               |SI nEjercicio < 80;
                    nEjercicio = nEjercicio + 2000;
               |SINO;
                    nEjercicio = nEjercicio + 1900;
               |FINSI;

               aAlfa = Usuario; |QBF aAlfa;
               |NOME_DAT #0 aAlfa;
               |DELINDEX #0;
               nApu = 0;
               nDocuAnt = 0;
               |ABRE #0;
               |SI enSwConta = 1; |HAZ EnCobros; |FINSI;
               |SI enSwConta = 2; |HAZ EnTotaHipo; |FINSI;
               |SI enSwConta = 3; |HAZ EnLinHipo; |FINSI;
               |CIERRA #0;

               |ABRE #caenlace@;
               |BUCLE obraz002;
               |CIERRA #caenlace@;
               |DELINDEX #0;
               |SI nApu ! 0;
                    |HAZ CogeVersion;
                    fich_alta = aPathConta2;
                    ||aAlfa = ":agicont/dsapunte.tab;" + aPathConta2;
                    aAlfa = ":contagen/dsapunte.tab;" + aPathConta2;
                    |SUB_EJECUTA_NP aAlfa;
                    |MENAV "0000Enlace efectuado...";
               |FINSI;
               |DELINDEX #caenlace@;
          |FINSI;
          |CIERRA #canempre@;
     |SINO;
          aAlfa = "0000Error en path '" + aPath + "'";
          |MENAV aAlfa;
     |FINSI;
     |HAZ DescargaDef;
|FPRC;
