|FICHEROS;
     dszrec01;
     agifa134;
     agifa059;
     agifa010;
     agifa071 #71;
     agifa007;
     agifa142;
     agifa019;
     agifa024;
     agifa025;
     referen@;
     agis0002 #2;

     agifa680;
     Refere1@;
     Refere2@;
|FIN;

|VARIABLES;
     aPath = "";
     nImpComi = 0;
     nSwBolilla = 0;
     nImpoDto = 0;
     nImpoDtoD = 0;
     nBrutoMoneda1 = 0;
     nBrutoMoneda2 = 0;
     nImporDescue1 = 0;
     nImporDescue2 = 0;
     nImporDescue3 = 0;
     nImporMoneda1 = 0;
     nImporMoneda2 = 0;
     nDescuMoneda1 = 0;
     nDescuMoneda2 = 0;

     aDef = "";
     nPVerde = 0;
     nTotPVerde = 0;
    &enAlberoAdj = 0;
    &nDeci_IVA   = 0;
    &nDeci_IVADiv= 0;
    &nDeci_PreDiv= 0;
    &nDeci_PreDivF=0;
    &nDeci_BaseMx = 0;
     nError      = 0;
     nDtoDiv     = 0;
     nTotaRete   = 0;
     nTotaReteD  = 0;
     nMult       = 0;
     nImpDiv     = 0;

     nImpEntregas = 0;
     aTipo        = "";
     aSerie       = "";
     nDocum       = 0;
     nLineaAlb    = 0;
     nSwPasa      = 0;

     nIva1       = 0;
     nIva2       = 0;
     nIva3       = 0;
     nIva4       = 0;
     nIva5       = 0;
     nRe1        = 0;
     nRe2        = 0;
     nRe3        = 0;
     nRe4        = 0;
     nRe5        = 0;
     nBruto      = 0;
     nBase0      = 0;
     nBase1      = 0;
     nBase2      = 0;
     nBase3      = 0;
     nBase4      = 0;
     nBase5      = 0;
     nBrutoD     = 0;
     nBase1D     = 0;
     nBase0D     = 0;
     nBase2D     = 0;
     nBase3D     = 0;
     nBase4D     = 0;
     nBase5D     = 0;
     nP0         = 0;
     nP1         = 0;
     nP2         = 0;
     nP3         = 0;
     nP4         = 0;
     nP5         = 0;
     nP0D        = 0;
     nP1D        = 0;
     nP2D        = 0;
     nP3D        = 0;
     nP4D        = 0;
     nP5D        = 0;
     nTP         = 0;
     nTPD        = 0;
     nTV         = 0;
     nTVD        = 0;
     nBr         = 0;
     nB1         = 0;
     nB2         = 0;
     nB3         = 0;
     nB4         = 0;
     nB5         = 0;
     nB0         = 0;
     nBrD        = 0;
     nB1D        = 0;
     nB2D        = 0;
     nB3D        = 0;
     nB4D        = 0;
     nB5D        = 0;
     nB0D        = 0;
     nAbono      = 0;
     nCampo      = 0;

     aSiNi       = "";
     aAlfa1      = "";
     aAlfa2      = "";
     aAlfa3      = "";

     &nDeci_DivF = 0;
     &nDeci_Div  = 0;

     &eaCli        = "";
     &enTiva       = 0;
     &enIva        = 0;
     &enRec        = 0;
     &efFiva = @;
     aAlfa = "";
     nPreTon = 0;
     nSwAlba = 0;
     nSwBsegui = 0;
     nCalc     = 0;
     nCalc1    = 0;
|FIN;

|PROCESO SumVerdeBaseF; ||Modulo
     |HAZ EsAlbadis; nSwAlba = FSalida;
     |HAZ EsBsegui; nSwBsegui = FSalida;
     |HAZ EsBolillas; nSwBolilla = FSalida;

     |SI nSwAlba ! 0; |Y nSwBsegui ! 0; |Y nSwBolilla ! 0;
               |Y #agifa142#177 ! "S";
          |ACABA;
     |FINSI;

     nPVerde = #agifa071#62;
     nTotPVerde = nTotPVerde + nPVerde;
     |SI enTiva = 0;
          nBase0 = nBase0 +. nPVerde;
          nBase0D = nBase0D +. nPVerde;
     |FINSI;

     |SI enTiva = 1;
          nBase1 = nBase1 +. nPVerde;
          nBase1D  = nBase1D  +. nPVerde;
     |FINSI;

     |SI enTiva = 2;
          nBase2 = nBase2 +. nPVerde;
          nBase2D = nBase2D  +. nPVerde;
     |FINSI;

     |SI enTiva = 3;
          nBase3 = nBase3 +. nPVerde;
          nBase3D = nBase3D  +. nPVerde;
     |FINSI;

     |SI enTiva = 4;
          nBase4 = nBase4 +. nPVerde;
          nBase4D = nBase4D +. nPVerde;
     |FINSI;

     |SI enTiva = 5;
          nBase5 = nBase5 +. nPVerde;
          nBase5D = nBase5D +. nPVerde;
     |FINSI;
|FPRC;

|PROCESO CargaLineasFac;
     #agifa059#3  = #agifa010#15 * nAbono;         ||bruto linea
     #agifa059#4  = #agifa010#25 * nAbono;         ||Total dtos linea
     #agifa059#5  = #agifa010#11 * nAbono;         ||total portes linea
     #agifa059#6  = #agifa010#13 * nAbono;         ||total varios linea
     #agifa059#7  = #agifa010#16 * nAbono;         ||Base 1 linea
     #agifa059#8  = #agifa010#19 * nAbono;         ||Base 2 linea
     #agifa059#9  = #agifa010#22 * nAbono;         ||Base 3 linea
     #agifa059#10 = #agifa010#24 * nAbono;         ||Total linea iva
     #agifa059#16 = #agifa010#44 * nAbono;         ||Base 4 linea
     #agifa059#17 = #agifa010#47 * nAbono;         ||Base 5 linea
     #agifa059#12 = #agifa010#26 * nAbono;

     #agifa059#13 = #agifa059#7 + #agifa059#8 + #agifa059#9 + #agifa059#16 + #agifa059#17;
       ||*#agifa059#11 = #agifa059#3 + #agifa059#10 - #agifa059#4 + #agifa059#5 + #agifa059#6;
     #agifa059#11 = #agifa010#67 * nAbono;

    ||Calculo los campos en divisa

     #agifa059#21 = #agifa010#75 * nAbono;         || Bruto linea
     #agifa059#22 = #dszrec01#17 * nAbono;         || Total dtos linea
     #agifa059#23 = #agifa010#81 * nAbono;         || Total portes linea
     #agifa059#24 = #dszrec01#1  * nAbono;
     #agifa059#24 = #agifa059#24 + (#dszrec01#4   * nAbono);
     #agifa059#24 = #agifa059#24 + (#dszrec01#7   * nAbono);
     #agifa059#24 = #agifa059#24 + (#dszrec01#10  * nAbono);
     #agifa059#24 = #agifa059#24 + (#dszrec01#13  * nAbono);
     #agifa059#25 = #dszrec01#16 * nAbono;         || Total IVA
     #agifa059#26 = #agifa010#76 * nAbono;         || Total Albaran

     |SI #agifa059#20 = "B"; ||Si la moneda de trabajo es la moneda base ...
                      || Asigno los campos en mon. base a los campos visual.
         #agifa059#27 = #agifa059#3;
         #agifa059#28 = #agifa059#4;
         #agifa059#29 = #agifa059#5;
         #agifa059#30 = #agifa059#13;
         #agifa059#31 = #agifa059#10;
         #agifa059#32 = #agifa059#11;
         #agifa059#33 = #agifa059#21;
         #agifa059#34 = #agifa059#22;
         #agifa059#35 = #agifa059#23;
         #agifa059#36 = #agifa059#24;
         #agifa059#37 = #agifa059#25;
         #agifa059#38 = #agifa059#26;
     |SINO;  || Si la moneda de trabajo es la divisa ...
             || Asigno los campos de divisa a los campos visual.
         #agifa059#27 = #agifa059#21;
         #agifa059#28 = #agifa059#22;
         #agifa059#29 = #agifa059#23;
         #agifa059#30 = #agifa059#24;
         #agifa059#31 = #agifa059#25;
         #agifa059#32 = #agifa059#26;
         #agifa059#33 = #agifa059#3;
         #agifa059#34 = #agifa059#4;
         #agifa059#35 = #agifa059#5;
         #agifa059#36 = #agifa059#13;
         #agifa059#37 = #agifa059#10;
         #agifa059#38 = #agifa059#11;
     |FINSI;
|FPRC;

|PROCESO CalLinAgifa134;
     nDeci_Div  = nDeci_DivF;
     |HAZ LimCabAgifa010;
     |BUCLELIN 2 CalCabAgifa010 #agifa010;

     |SI #agifa010#43 = "S";
         nAbono = -1;
     |SINO;
         nAbono = 1;
     |FINSI;

     |HAZ CargaLineasFac;
|FPRC;

|PROCESO SacaIvaAgifa134;
     nIva1 = 0;
     nIva2 = 0;
     nIva3 = 0;
     nIva4 = 0;
     nIva5 = 0;
     nRe1  = 0;
     nRe2  = 0;
     nRe3  = 0;
     nRe4  = 0;
     nRe5  = 0;

     |SI #agifa142#78 = "S";
          |ABRE #agifa007;
          #agifa007#26 = #agifa134#49;  ||SERIE.
          |LEE 020#agifa007.=;
          |SI FSalida ! 0;  |DDEFECTO #agifa007;  |FINSI;
          |CIERRA #agifa007;

          |SI #agifa007#30 = "S";
              nIva1 = 0;
              nIva2 = 0;
              nIva3 = 0;
              nIva4 = 0;
              nIva5 = 0;
              nRe1  = 0;
              nRe2  = 0;
              nRe3  = 0;
              nRe4  = 0;
              nRe5  = 0;
              |ACABA;
          |FINSI;
     |FINSI;

     |ABRE #agifa007;
     #agifa007#26 = #agifa134#49;  ||SERIE.
     |LEE 000#agifa007.=;
     |SI FSalida ! 0; |DDEFECTO #agifa007; |FINSI;
     aSiNi = #agifa007#30;
     |SI #agifa007#30 ! "S";
         eaCli  = #agifa134#2;
         efFiva = #agifa134#1;
         enTiva = 1; |HAZ IVACli; nIva1 = enIva;  nRe1 = enRec;
         enTiva = 2; |HAZ IVACli; nIva2 = enIva;  nRe2 = enRec;
         enTiva = 3; |HAZ IVACli; nIva3 = enIva;  nRe3 = enRec;
         enTiva = 4; |HAZ IVACli; nIva4 = enIva;  nRe4 = enRec;
         enTiva = 5; |HAZ IVACli; nIva5 = enIva;  nRe5 = enRec;
     |FINSI;
     |CIERRA #agifa007;
|FPRC;

|PROCESO TotalLinAlb;
     nDeci_PreDiv = nDeci_PreDivF;
     |ABRE #agifa019;
     #agifa019#0 = #agifa071#2;
     |LEE 020#agifa019.=;
     |CIERRA #agifa019;

     nPreTon = 1;
     |HAZ EsVigor;
     |SI FSalida = 0;
          aAlfa = #agifa019#110; |QBF aAlfa;   || Alfanumerico1
          aAlfa = aAlfa > "";
          |SI aAlfa = "S"; nPreTon = 1000; |FINSI;
     |FINSI;

     |SI #agifa010#70 = "D";
          #agifa071#6  = #agifa071#36 / #agifa010#69 * #agifa010#74;
          #agifa071#38 = #agifa071#6;
     |SINO;
          #agifa071#36 = #agifa071#6 / #agifa010#74 * #agifa010#69;
          #agifa071#38 = #agifa071#36;
     |FINSI;

     |SI #agifa019#194 = 2;
         #agifa071#7    = #agifa071#48 * #agifa071#6 / nPreTon;
         nImpDiv = (#agifa071#48 * #agifa071#36 / nPreTon) ! nDeci_IVADiv;
     |SINO;
          #agifa071#7    = #agifa071#5 * #agifa071#6 / nPreTon;
          nImpDiv = (#agifa071#5 * #agifa071#36 / nPreTon) ! nDeci_IVADiv;
     |FINSI;

     || nMult corrige el error del redondeo para negativos
     |SI #agifa071#7 < 0; nMult = -1; |SINO; nMult = 1; |FINSI;

     #agifa071#7 = #agifa071#7 * nMult;
     nImpDiv = nImpDiv * nMult;

     |HAZ EsMalpesa;
     |SI FSalida = 0;
         #agifa071#9  = #agifa071#7;
         #agifa071#37 = nImpDiv;
     |SINO;
         #agifa071#9  = (((#agifa071#7 < #agifa071#8) < #agifa071#33));
         #agifa071#37 = (((nImpDiv < #agifa071#8) < #agifa071#33));
     |FINSI;
     #agifa071#7  = #agifa071#7 * nMult;
     #agifa071#9  = #agifa071#9 * nMult;
     #agifa071#37 = #agifa071#37 * nMult;

     |SI #agifa010#70 = "D";
          #agifa071#39 = #agifa071#9;
     |SINO;
          #agifa071#39 = #agifa071#37;
     |FINSI;
     |GRABA 020#agifa071.a;
     |LIBERA #agifa071;
|FPRC;

|PROCESO LineasAlbaran;
     |HAZ TotalLinAlb;

     |HAZ CalCabAgifa010;

     nBruto  = nBruto  + #agifa071#9;
     nBrutoD = nBrutoD + #agifa071#37;

     nBrutoMoneda1 = #agifa071#9;
     nImporDescue1 = (nBrutoMoneda1 % #agifa134#4) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda1 % #agifa134#5) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda1 % #agifa134#6) ! nDeci_IVA;
     nBrutoMoneda1 = nBrutoMoneda1 - nImporDescue3;
     nDescuMoneda1 = nImporDescue1 + nImporDescue2 + nImporDescue3;
     nImpoDto = nImpoDto + nDescuMoneda1;

     nBrutoMoneda2 = #agifa071#37;
     nImporDescue1 = (nBrutoMoneda2 % #agifa134#4) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue1;
     nImporDescue2 = (nBrutoMoneda2 % #agifa134#5) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue2;
     nImporDescue3 = (nBrutoMoneda2 % #agifa134#6) ! nDeci_IVA;
     nBrutoMoneda2 = nBrutoMoneda2 - nImporDescue3;
     nDescuMoneda2 = nImporDescue1 + nImporDescue2 + nImporDescue3;
     nImpoDtoD = nImpoDtoD + nDescuMoneda2;

     |SI aSiNi = "S"; #agifa071#11 = 0; |FINSI; ||Exportacion

     |SI #agifa071#11 = 0;
          ||nBase0  = nBase0  + #agifa071#9;
          ||nBase0D = nBase0D + #agifa071#37;
          nBase0  = nBase0  + nBrutoMoneda1;
          nBase0D = nBase0D + nBrutoMoneda2;
     |FINSI;
     |SI #agifa071#11 = 1;
          ||nBase1  = nBase1  + #agifa071#9;
          ||nBase1D = nBase1D + #agifa071#37;
          nBase1  = nBase1  + nBrutoMoneda1;
          nBase1D = nBase1D + nBrutoMoneda2;
     |FINSI;
     |SI #agifa071#11 = 2;
         ||nBase2  = nBase2  + #agifa071#9;
         ||nBase2D = nBase2D + #agifa071#37;
          nBase2  = nBase2  + nBrutoMoneda1;
          nBase2D = nBase2D + nBrutoMoneda2;
     |FINSI;
     |SI #agifa071#11 = 3;
         ||nBase3  = nBase3  + #agifa071#9;
         ||nBase3D = nBase3D + #agifa071#37;
          nBase3  = nBase3  + nBrutoMoneda1;
          nBase3D = nBase3D + nBrutoMoneda2;
     |FINSI;
     |SI #agifa071#11 = 4;
          ||nBase4  = nBase4  + #agifa071#9;
          ||nBase4D = nBase4D + #agifa071#37;
          nBase4  = nBase4  + nBrutoMoneda1;
          nBase4D = nBase4D + nBrutoMoneda2;
     |FINSI;
     |SI #agifa071#11 = 5;
        || nBase5  = nBase5  + #agifa071#9;
        || nBase5D = nBase5D + #agifa071#37;
          nBase5  = nBase5  + nBrutoMoneda1;
          nBase5D = nBase5D + nBrutoMoneda2;
     |FINSI;

     |HAZ SumVerdeBaseF;
|FPRC;

|DEFBUCLE agifa071;
     #agifa071#1;
     ;
     #agifa010#52, #agifa010#0, 001;
     #agifa010#52, #agifa010#0, 999;
     be;
     NULL, LineasAlbaran;
|FIN;

|PROCESO LineasFacturas;
     ||Cuando lo llama el 'albz0017', es un albaran excluido
     |SI enAlberoAdj = 1; |Y #agifa059#39 = 69;
          |ACABA;
     |FINSI;

     #agifa010#52 = #agifa059#15; ||serie albaran
     #agifa010#0  = #agifa059#2;
     |LEE 000#agifa010.=;
     |SI FSalida ! 0;
          aAlfa1 = "    Albaran [" + #agifa010#52 + "." + #agifa010#0 + "] inaccesible o inexistente ...";
          |MENAV aAlfa1;
          |ACABA;
     |FINSI;

     |SI #agifa010#43 = "S";
         nAbono = -1;
     |SINO;
         nAbono = 1;
     |FINSI;

     nBruto  = 0;
     nBase0  = 0;
     nBase1  = 0;
     nBase2  = 0;
     nBase3  = 0;
     nBase4  = 0;
     nBase5  = 0;
     nBrutoD = 0;
     nBase1D = 0;
     nBase0D = 0;
     nBase2D = 0;
     nBase3D = 0;
     nBase4D = 0;
     nBase5D = 0;
     nDtoDiv = 0;
     nDtoDiv = 0;
     nDtoDiv = 0;

     |HAZ LimCabAgifa010;
     |BUCLE agifa071;

     || Retencion igual que en compras
     nTotaRete = nTotaRete +. (#dszrec01#19 * nAbono);
     nTotaReteD = nTotaReteD +. (#dszrec01#20 * nAbono);
/*
     |SI #agifa010#24 ! 0;
         |SI #agifa024#207 = "B";
               |SI #agifa010#75 > 0; nError = 1; |SINO; nError = -1; |FINSI;
               nDtoDiv = (#agifa010#75 < #agifa010#5) ! nDeci_IVADiv;
               nDtoDiv = (nDtoDiv < #agifa010#32) ! nDeci_IVADiv;
               nDtoDiv = (nDtoDiv < #agifa010#7) ! nDeci_IVADiv;

               nDtoDiv = nDtoDiv * nError;
               nDtoDiv = (#agifa010#75 * nError) - nDtoDiv;

               nTotaRete = nTotaRete + #agifa010#15 - #agifa010#25;
               nTotaReteD = nTotaReteD + #agifa010#75 - nDtoDiv;
         |SINO;
               nTotaRete = nTotaRete + #agifa010#67;
               nTotaReteD = nTotaReteD +  #agifa010#76;
         |FINSI;
     |FINSI;
*/
     |SI #agifa010#12 = 0;
         nP0  = nP0  + #agifa010#11;
         nP0D = nP0D + #agifa010#81;
     |FINSI;

     |SI #agifa010#12 = 1;
         nP1  = nP1  + #agifa010#11;
         nP1D = nP1D + #agifa010#81;
     |FINSI;

     |SI #agifa010#12 = 2;
         nP2  = nP2  + #agifa010#11;
         nP2D = nP2D + #agifa010#81;
     |FINSI;

     |SI #agifa010#12 = 3;
         nP3  = nP3  + #agifa010#11;
         nP3D = nP3D + #agifa010#81;
     |FINSI;

     |SI #agifa010#12 = 4;
         nP4  = nP4  + #agifa010#11;
         nP4D = nP4D + #agifa010#81;
     |FINSI;

     |SI #agifa010#12 = 5;
         nP5  = nP5  + #agifa010#11;
         nP5D = nP5D + #agifa010#81;
     |FINSI;

     nTP  = nTP  + #agifa010#11;
     nTPD = nTPD + #agifa010#81;

     |SI #agifa010#14 = 0;
         nP0  = nP0  + #agifa010#13;
         nP0D = nP0D + #agifa010#82;
     |FINSI;

     |SI #agifa010#14 = 1;
         nP1  = nP1  + #agifa010#13;
         nP1D = nP1D + #agifa010#82;
     |FINSI;

     |SI #agifa010#14 = 2;
         nP2  = nP2  + #agifa010#13;
         nP2D = nP2D + #agifa010#82;
     |FINSI;

     |SI #agifa010#14 = 3;
         nP3  = nP3  + #agifa010#13;
         nP3D = nP3D + #agifa010#82;
     |FINSI;

     |SI #agifa010#14 = 4;
         nP4  = nP4  + #agifa010#13;
         nP4D = nP4D + #agifa010#82;
     |FINSI;

     |SI #agifa010#14 = 5;
         nP5  = nP5  + #agifa010#13;
         nP5D = nP5D + #agifa010#82;
     |FINSI;

     nTV  = nTV + #agifa010#13;
     nTVD = nTVD + #agifa010#82;

     |HAZ CargaLineasFac;

     |GRABA 020#agifa059.a;
     nImpEntregas = 0;

     |HAZ SumaEntregas;
     #agifa134#32 = #agifa134#32 + nImpEntregas; ||Entregas a cuenta
     #agifa134#46 = #agifa134#46 + #agifa010#37; ||Margen
     #agifa134#8 = #agifa134#8 + (#agifa010#26 * nAbono);
     #agifa134#110 = #agifa134#110 + ((#agifa010#26 / #agifa010#74 * #agifa010#69) * nAbono);

     |HAZ EsOrts;
     |SI FSalida = 0;
          |HAZ OrtsComiFacTota;
     |FINSI;

     nBruto = nBruto * nAbono;
     nBase1 = nBase1 * nAbono;
     nBase2 = nBase2 * nAbono;
     nBase3 = nBase3 * nAbono;
     nBase4 = nBase4 * nAbono;
     nBase5 = nBase5 * nAbono;
     nBase0 = nBase0 * nAbono;

     nBrutoD = nBrutoD * nAbono;
     nBase1D = nBase1D * nAbono;
     nBase2D = nBase2D * nAbono;
     nBase3D = nBase3D * nAbono;
     nBase4D = nBase4D * nAbono;
     nBase5D = nBase5D * nAbono;
     nBase0D = nBase0D * nAbono;

     nBr = nBr + nBruto;
     nB1 = nB1 + nBase1;
     nB2 = nB2 + nBase2;
     nB3 = nB3 + nBase3;
     nB4 = nB4 + nBase4;
     nB5 = nB5 + nBase5;
     nB0 = nB0 + nBase0;

     nBrD = nBrD + nBrutoD;
     nB1D = nB1D + nBase1D;
     nB2D = nB2D + nBase2D;
     nB3D = nB3D + nBase3D;
     nB4D = nB4D + nBase4D;
     nB5D = nB5D + nBase5D;
     nB0D = nB0D + nBase0D;

     #agifa134#18 = nBr;
/*
     #agifa134#17 = #agifa134#18 < #agifa134#4;
     #agifa134#17 = #agifa134#17 < #agifa134#5;
     #agifa134#17 = #agifa134#17 < #agifa134#6;
     #agifa134#17 = #agifa134#18 - #agifa134#17;

     #agifa134#47 = nB0 < #agifa134#4;
     #agifa134#47 = #agifa134#47 < #agifa134#5;
     #agifa134#47 = #agifa134#47 < #agifa134#6;

     #agifa134#21 = nB1 < #agifa134#4;
     #agifa134#21 = #agifa134#21 < #agifa134#5;
     #agifa134#21 = #agifa134#21 < #agifa134#6;

     #agifa134#24 = nB2 < #agifa134#4;
     #agifa134#24 = #agifa134#24 < #agifa134#5;
     #agifa134#24 = #agifa134#24 < #agifa134#6;

     #agifa134#27 = nB3 < #agifa134#4;
     #agifa134#27 = #agifa134#27 < #agifa134#5;
     #agifa134#27 = #agifa134#27 < #agifa134#6;

     #agifa134#33 = nB4 < #agifa134#4;
     #agifa134#33 = #agifa134#33 < #agifa134#5;
     #agifa134#33 = #agifa134#33 < #agifa134#6;

     #agifa134#36 = nB5 < #agifa134#4;
     #agifa134#36 = #agifa134#36 < #agifa134#5;
     #agifa134#36 = #agifa134#36 < #agifa134#6;
*/
     nImpoDto = nImpoDto * nAbono;
     nImpoDtoD = nImpoDtoD * nAbono;

     #agifa134#17 = nImpoDto;
     #agifa134#47 = nB0;
     #agifa134#21 = nB1;
     #agifa134#24 = nB2;
     #agifa134#27 = nB3;
     #agifa134#33 = nB4;
     #agifa134#36 = nB5;

     #agifa134#19 = nTP;
     #agifa134#20 = nTV;
     #agifa134#21 = #agifa134#21 + nP1;
     #agifa134#24 = #agifa134#24 + nP2;
     #agifa134#27 = #agifa134#27 + nP3;
     #agifa134#33 = #agifa134#33 + nP4;
     #agifa134#36 = #agifa134#36 + nP5;
     #agifa134#22 = #agifa134#21 % nIva1;
     #agifa134#25 = #agifa134#24 % nIva2;
     #agifa134#28 = #agifa134#27 % nIva3;
     #agifa134#34 = #agifa134#33 % nIva4;
     #agifa134#37 = #agifa134#36 % nIva5;
     |SI #agifa134#13 = "S";
          #agifa134#23 = #agifa134#21 % nRe1;
          #agifa134#26 = #agifa134#24 % nRe2;
          #agifa134#54 = #agifa134#27 % nRe3;
          #agifa134#35 = #agifa134#33 % nRe4;
          #agifa134#38 = #agifa134#36 % nRe5;
     |FINSI;
     #agifa134#29 = #agifa134#22 + #agifa134#25 + #agifa134#28 + #agifa134#34 + #agifa134#37;
     #agifa134#30 = #agifa134#26 + #agifa134#23 + #agifa134#54 + #agifa134#35 + #agifa134#38;
     #agifa134#31 = #agifa134#18 - #agifa134#17+ #agifa134#29+ #agifa134#30+ #agifa134#19+ #agifa134#20;
     #agifa134#31 = #agifa134#31 + nTotPVerde; ||modulo
     |SI #agifa142#86 ! "S";
        |SI #agifa134#32 = 0; |Y #agifa010#61 ! 0;
          #agifa134#32 = #agifa134#32 + #agifa010#61;     || A cuenta
        |FINSI;
     |FINSI;
     #agifa134#119 = nTotaRete % #agifa134#122;
     #agifa134#31 = #agifa134#31 - #agifa134#119;
     || Acumulo los valores en divisa

     #agifa134#65 = nBrD;
     #agifa134#66 = nTPD;
     #agifa134#67 = nTVD;
/*
     #agifa134#64 = #agifa134#65 < #agifa134#4;
     #agifa134#64 = #agifa134#64 < #agifa134#5;
     #agifa134#64 = #agifa134#64 < #agifa134#6;
     #agifa134#64 = #agifa134#65 - #agifa134#64;

     #agifa134#68 = nB1D < #agifa134#4;
     #agifa134#68 = #agifa134#68 < #agifa134#5;
     #agifa134#68 = #agifa134#68 < #agifa134#6;

     #agifa134#71 = nB2D < #agifa134#4;
     #agifa134#71 = #agifa134#71 < #agifa134#5;
     #agifa134#71 = #agifa134#71 < #agifa134#6;

     #agifa134#74 = nB3D < #agifa134#4;
     #agifa134#74 = #agifa134#74 < #agifa134#5;
     #agifa134#74 = #agifa134#74 < #agifa134#6;

     #agifa134#79 = nB4D < #agifa134#4;
     #agifa134#79 = #agifa134#79 < #agifa134#5;
     #agifa134#79 = #agifa134#79 < #agifa134#6;

     #agifa134#82 = nB5D < #agifa134#4;
     #agifa134#82 = #agifa134#82 < #agifa134#5;
     #agifa134#82 = #agifa134#82 < #agifa134#6;
*/
     #agifa134#64 = nImpoDtoD;
     #agifa134#68 = nB1D;
     #agifa134#71 = nB2D;
     #agifa134#74 = nB3D;
     #agifa134#79 = nB4D;
     #agifa134#82 = nB5D;

     #agifa134#68 = #agifa134#68 + nP1D;
     #agifa134#71 = #agifa134#71 + nP2D;
     #agifa134#74 = #agifa134#74 + nP3D;
     #agifa134#79 = #agifa134#79 + nP4D;
     #agifa134#82 = #agifa134#82 + nP5D;

     #agifa134#69 = #agifa134#68 % nIva1;
     #agifa134#72 = #agifa134#71 % nIva2;
     #agifa134#75 = #agifa134#74 % nIva3;
     #agifa134#80 = #agifa134#79 % nIva4;
     #agifa134#83 = #agifa134#82 % nIva5;
     |SI #agifa134#13 = "S";
          #agifa134#70 = #agifa134#68 % nRe1;
          #agifa134#73 = #agifa134#71 % nRe2;
          #agifa134#85 = #agifa134#74 % nRe3;
          #agifa134#81 = #agifa134#79 % nRe4;
          #agifa134#84 = #agifa134#82 % nRe5;
     |FINSI;
     #agifa134#76 = #agifa134#69 + #agifa134#72 + #agifa134#75 + #agifa134#80 + #agifa134#83;
     #agifa134#77 = #agifa134#70 + #agifa134#73 + #agifa134#85 + #agifa134#81 + #agifa134#84;

     #agifa134#120 = nTotaRete % #agifa134#122;
     #agifa134#78 = #agifa134#65 - #agifa134#64+ #agifa134#76+ #agifa134#77+#agifa134#66+ #agifa134#67;
     #agifa134#78 = #agifa134#78 - #agifa134#120;
     #agifa134#78 = #agifa134#78 + nTotPVerde; ||modulo

     #agifa134#55 = #agifa134#8 % #agifa025#39;
     #agifa134#86 = #agifa134#110 % #agifa025#39;
     #agifa134#123 = #agifa134#123 + #agifa010#94; ||P.Verde
     #agifa134#125 = #agifa134#125 + #agifa010#96; ||Canon

     |SI #agifa134#60 = "B"; || Si la moneda de trabajo es la moneda base ...
          #agifa134#87 = #agifa134#17;
          #agifa134#88 = #agifa134#18;
          #agifa134#89 = #agifa134#19;
          #agifa134#90 = #agifa134#20;
          #agifa134#91 = #agifa134#21;
          #agifa134#92 = #agifa134#22;
          #agifa134#93 = #agifa134#23;
          #agifa134#94 = #agifa134#24;
          #agifa134#95 = #agifa134#25;
          #agifa134#96 = #agifa134#26;
          #agifa134#97 = #agifa134#27;
          #agifa134#98 = #agifa134#28;
          #agifa134#99 = #agifa134#29;
          #agifa134#100 = #agifa134#30;
          #agifa134#101 = #agifa134#31;
          #agifa134#102 = #agifa134#33;
          #agifa134#103 = #agifa134#34;
          #agifa134#104 = #agifa134#35;
          #agifa134#105 = #agifa134#36;
          #agifa134#106 = #agifa134#37;
          #agifa134#107 = #agifa134#38;
          #agifa134#108 = #agifa134#54;
          #agifa134#109 = #agifa134#55;
          #agifa134#111 = #agifa134#8;
          #agifa134#121 = #agifa134#119;
     |SINO; || Si la moneda de trabajo es la divisa ...
          #agifa134#87 = #agifa134#64;
          #agifa134#88 = #agifa134#65;
          #agifa134#89 = #agifa134#66;
          #agifa134#90 = #agifa134#67;
          #agifa134#91 = #agifa134#68;
          #agifa134#92 = #agifa134#69;
          #agifa134#93 = #agifa134#70;
          #agifa134#94 = #agifa134#71;
          #agifa134#95 = #agifa134#72;
          #agifa134#96 = #agifa134#73;
          #agifa134#97 = #agifa134#74;
          #agifa134#98 = #agifa134#75;
          #agifa134#99 = #agifa134#76;
          #agifa134#100 = #agifa134#77;
          #agifa134#101 = #agifa134#78;
          #agifa134#102 = #agifa134#79;
          #agifa134#103 = #agifa134#80;
          #agifa134#104 = #agifa134#81;
          #agifa134#105 = #agifa134#82;
          #agifa134#106 = #agifa134#83;
          #agifa134#107 = #agifa134#84;
          #agifa134#108 = #agifa134#85;
          #agifa134#109 = #agifa134#86;
          #agifa134#111 = #agifa134#110;
          #agifa134#121 = #agifa134#120;
     |FINSI;
|FPRC;

|DEFBUCLE agifa059;
     #agifa059#1;
     ;
     #agifa134#49, #agifa134#0, 001;
     #agifa134#49, #agifa134#0, 999;
     be;
     NULL, LineasFacturas;
|FIN;

|PROCESO GrabaIvaAgifa134;
     #agifa134#39 = nIva1;  #agifa134#40 = nRe1;
     #agifa134#41 = nIva2;  #agifa134#42 = nRe2;
     #agifa134#43 = nIva3;  #agifa134#44 = nRe3;
     #agifa134#50 = nIva4;  #agifa134#51 = nRe4;
     #agifa134#52 = nIva5;  #agifa134#53 = nRe5;
|FPRC;

|PROCESO CalCabAgifa134; || Llamando este se recalculan las lineas
     |ABRE #agifa142; |LEE 000#agifa142.p; |CIERRA #agifa142;
     |ABRE #agifa025;
     #agifa025#0 = #agifa134#7;
     |LEE 000#agifa025.=;
     |CIERRA #agifa025;
     nTotPVerde = 0;
     nImpoDto = 0;
     nImpoDtoD = 0;
     nBruto  = 0;
     nBase0  = 0;
     nBase1  = 0;
     nBase2  = 0;
     nBase3  = 0;
     nBase4  = 0;
     nBase5  = 0;
     nBrutoD = 0;
     nBase1D = 0;
     nBase0D = 0;
     nBase2D = 0;
     nBase3D = 0;
     nBase4D = 0;
     nBase5D = 0;
     nP0     = 0;
     nP1     = 0;
     nP2     = 0;
     nP3     = 0;
     nP4     = 0;
     nP5     = 0;
     nP0D    = 0;
     nP1D    = 0;
     nP2D    = 0;
     nP3D    = 0;
     nP4D    = 0;
     nP5D    = 0;
     nTP     = 0;
     nTPD    = 0;
     nTV     = 0;
     nTVD    = 0;
     nBr     = 0;
     nB1     = 0;
     nB2     = 0;
     nB3     = 0;
     nB4     = 0;
     nB5     = 0;
     nB0     = 0;
     nBrD    = 0;
     nB1D    = 0;
     nB2D    = 0;
     nB3D    = 0;
     nB4D    = 0;
     nB5D    = 0;
     nB0D    = 0;
     nTotaRete = 0;
     nTotaReteD = 0;

     nDeci_Div  = nDeci_DivF;

     #agifa134#8 = 0;
     |PARA nCampo = 17; |SI nCampo [ 32; |HACIENDO nCampo = nCampo + 1;
           #agifa134#nCampo# = 0;
     |SIGUE;
     |PARA nCampo = 33; |SI nCampo [ 38; |HACIENDO nCampo = nCampo + 1;
          #agifa134#nCampo# = 0;
     |SIGUE;

     #agifa134#46 = 0;
     #agifa134#47 = 0;
     #agifa134#54 = 0;
     #agifa134#55 = 0;
     #agifa134#119 = 0;
     #agifa134#120 = 0;
     #agifa134#121 = 0;
     #agifa134#123 = 0;
     #agifa134#125 = 0;
     |PARA nCampo = 64; |SI nCampo [ 111; |HACIENDO nCampo = nCampo + 1;
           #agifa134#nCampo# = 0;
     |SIGUE;

     |HAZ EsOrts;
     |SI FSalida = 0;
          |HAZ OrtsComiFacCero;
     |FINSI;

     |HAZ SacaIvaAgifa134;

     aAlfa = "68" + Usuario; |QBF aAlfa;
     |NOME_DAT #agifa680#aAlfa#;
     |DELINDEX #agifa680; |ABRE #agifa680;

     |ABRE #agifa010;
     |BUCLE agifa059;
     |CIERRA #agifa010;

     |CIERRA #agifa680; |DELINDEX #agifa680;

     |HAZ GrabaIvaAgifa134;
|FPRC;

|PROCESO Entregas;
   |SI aTipo = "P";
      #agifa680#0 = #agifa071#31;
      #agifa680#1 = #agifa071#12;
      #agifa680#3 = #agis0002#18;
      |LEE 000#agifa680.=;
      |SI FSalida = 0; |ACABA; |FINSI;

      |DDEFECTO #agifa680;
      #agifa680#0 = #agifa071#31;
      #agifa680#1 = #agifa071#12;
      #agifa680#2 = #agis0002#9;
      #agifa680#3 = #agis0002#18;
      |GRABA 020#agifa680.n;

      |SI #agis0002#35 > 0;
         || Compruebo la integridad del dato
         |DDEF aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + "agifa134.mas";
         |CARGA_DEF aAlfa, Refere1@;
         |SI FSalida = 0;
            |DFICE aAlfa; |QBF aAlfa; |PATH_DAT #Refere1@#aAlfa#;
            |ABRE #Refere1@;
            #Refere1@#49 = #agis0002#34;
            #Refere1@#0  = #agis0002#35;
            |LEE 000#Refere1@.=;
            |SI FSalida ! 0;
               aAlfa = "    La entrega de pedido " + #agis0002#20 + "/" + (("000000" + #agis0002#17) % -106);
               aAlfa = aAlfa + (("000" + #agis0002#18) % -103);
               aAlfa = aAlfa + " esta vinculada a una factura inexistente [" + #agis0002#34 + "/" + (("000000" + #agis0002#35) % -106);
               aAlfa = aAlfa + "]. Compruebe la integridad.";
               |MENAV aAlfa;
            |FINSI;
            |CIERRA #Refere1@; |DESCARGA_DEF #Refere1@;
         |FINSI;

         |SI #agis0002#34 ! #agifa071#30; |O #agis0002#35 ! #agifa071#26; |ACABA; |FINSI;
      |SINO;
         #agis0002#34 = #agifa071#30;
         #agis0002#35 = #agifa071#26;
         |GRABA 020#agis0002.a;
      |FINSI;
   |FINSI;
   nImpEntregas = nImpEntregas + #agis0002#9;
|FPRC;

|DEFBUCLE Entregas;
#agis0002#1;
;
aTipo, aSerie, nDocum, 01;
aTipo, aSerie, nDocum, 99;
be;
NULL,Entregas;
|FIN;

/*   Thu Dec  7 17:53:43 CET 2006

|PROCESO Pedidos;
   nSwPasa = 1; nLineaAlb = #agifa071#1;

   aTipo = "P"; aSerie = #agifa071#31; nDocum = #agifa071#12;
   |BUCLE Entregas;
|FPRC;

|DEFBUCLE Pedidos;
#agifa071#1;
;
#agifa059#14, #agifa059#2, 001;
#agifa059#14, #agifa059#2, 999;
;
NULL, Pedidos;
|FIN;
*/

|PROCESO Pedidos;
   |SI aSerie ! #agifa071#31; |O nDocum  ! #agifa071#12;
      aTipo = "P"; aSerie = #agifa071#31; nDocum = #agifa071#12;
      |SI nDocum ! 0;
          |BUCLE Entregas;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Pedidos;
     #agifa071#1;
     ;
     #agifa059#15, #agifa059#2, 001;
     #agifa059#15, #agifa059#2, 999;
     ;
     NULL, NULL, NULL, NULL, NULL, Pedidos;
     #agifa071#31, #agifa071#12;
|FIN;

|PROCESO SumaEntregas;
   aTipo = "A"; aSerie = #agifa059#15; nDocum = #agifa059#2;
   |BUCLE Entregas;

   aSerie = ""; nDocum = 0; |BUCLE Pedidos;
|FPRC;

|PROCESO OrtsComiFacTota;
     |SALVA_DATOS #agifa025;
     nImpComi = 0;
     |DDEF aPath;
     aAlfa = aPath + "ortsm021";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #referen@;
          #referen@#0 = "A";
          #referen@#1 = #agifa010#52;
          #referen@#2 = #agifa010#0;
          |LEE 000#referen@.=;
          |SI FSalida = 0;
               nImpComi = #referen@#6;
          |FINSI;
          |ABRE #agifa025;
          #agifa025#0 = #referen@#4;
          |LEE 000#agifa025.=;
          |CIERRA #agifa025;
          |DDEFECTO #referen@;
          #referen@#0 = "F";
          #referen@#1 = #agifa134#49;
          #referen@#2 = #agifa134#0;
          |LEE 000#referen@.=;
          |SI FSalida ! 0; |GRABA 020#referen@.b; |FINSI;
          #referen@#6 = (#referen@#6 + (nImpComi * nAbono)) ! nDeci_BaseMx;
          #referen@#7 = (#referen@#7 + ((nImpComi / #agifa010#74 * #agifa010#69) * nAbono)) ! nDeci_DivF;
          #referen@#9 = (#referen@#6 % #agifa025#39) ! nDeci_BaseMx;
          #referen@#10 = (#referen@#7 % #agifa025#39) ! nDeci_DivF;
          |SI #agifa134#60 = "B";
               #referen@#8 = #referen@#6;
               #referen@#11 = #referen@#9;
          |SINO;
               #referen@#8 = #referen@#7;
               #referen@#11 = #referen@#10;
          |FINSI;
          |GRABA 020#referen@.a;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |SINO;
          |MENAV "0000Error al cargar 'ortsm021'...";
     |FINSI;
     |REPON_DATOS #agifa025;
|FPRC;

|PROCESO OrtsComiFacCero;
     aAlfa = aPath + "ortsm021";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |DDEFECTO #referen@;
          |ABRE #referen@;
          #referen@#0 = "F";
          #referen@#1 = #agifa134#49;
          #referen@#2 = #agifa134#0;
          |LEE 000#referen@.=;
          |SI FSalida ! 0; |GRABA 020#referen@.b; |FINSI;
          #referen@#6 = 0;
          #referen@#7 = 0;
          #referen@#8 = 0;
          #referen@#9 = 0;
          #referen@#10 = 0;
          #referen@#11 = 0;
          |GRABA 020#referen@.a;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |SINO;
          |MENAV "0000Error al cargar 'ortsm021'...";
     |FINSI;
|FPRC;
