Copiado del: guery013.cal [002743]

|FICHEROS;
     guerz085       #00;
     con00601       #01;      || maestro de vehiculos
     gopartia       #6;
     guerm017       #10;      || construcc - partes/cab
     guerm018       #11;      || construcc - partes/lin
     guerm019       #19;
     con00625       #20;      || taller9 - repara/cab
     con00626       #21;      || taller9 - repara/lin
     guerm030       #30;
     agifa077       #77;
     agifa080       #80;
     guerm061       #61;
     guerw056       #100;     || TMP
|FIN;

|VARIABLES;
     nImpo = 0;
     aElemento = "";
     naux      = 0;
     aAlfa     = "";
     aAlfa1    = "";

     swNew     = 0;

     alimb     = "";
     alimZ     = "";

     al1_8     = "";
     al2_8     = "";

     swImp     = 0;
|FIN;

|PROCESO Tipo66; |TIPO 66;
     |ABRE #48;
     #48#0 = #0Campo;
     |CONSULTA_CLAVE #1#48;
     |SI FSalida = 0;
          #0Campo = #48#0;
     |SINO;
          |ERROR;
     |FINSI;
     |CIERRA #48;
|FPRC;

|PROCESO Ini; |TIPO 7;
     |DFICE aAlfa; |QBT aAlfa;
     |DFICB aAlfa1; |QBT aAlfa1;
     aAlfa = aAlfa - aAlfa1;
     aAlfa = aAlfa - "/";

     #00#00 = aAlfa; |PINTA #00#00;
     #00#02 = aAlfa; |PINTA #00#02;
|FPRC;

|| Pintamos la empresa que indica el campo.
|PROCESO DescEmp;
     |ABRE     #48;
     |DDEFECTO #48;
     #48#00 = #00#Campo#;
     |LEE 040#48.=;
     |SI FSalida ! 0;
          |MENAV "0000Empresa NO definida";
          |CIERRA #48;
          |ERROR;
          |ACABA;
     |FINSI;

     naux = Campo; naux = naux + 1;
     #00#naux# = #48#01;
     |PINTA #00#naux#;
     |CIERRA   #48;
|FPRC;

|PROCESO Gopartia;
     #19#0 = #6#8;
     |LEE 000#19=;
     |SI FSalida = 0;
          |SI #19#0 ] #0#4; |Y #19#0 [ #0#5;
               |DDEFECTO #100;
               #100#0 = #19#0;
               |LEE 101#100=;
               |SI FSalida ! 0; |GRABA 020#100b; |FINSI;
               #100#5 = #100#5 + #6#25; || Imputacion
               |GRABA 020#100a;
               |LIBERA #100;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE Gopartia;
     #6#3;
     28;
     #0#8, #0#9, "     ", 000001, "                    ", "                    ", #0#6;
     #0#8, #0#9, "zzzzz", 999999, "zzzzzzzzzzzzzzzzzzzz", "zzzzzzzzzzzzzzzzzzzz", #0#7;
     ;
     NULL, Gopartia;
|FIN;

|PROCESO Albaranes;
     |SI #80#2 = #61#1;
          nImpo = ((#80#9 < #77#5) < #77#32) < #77#7;
          #100#4 = #100#4 + nImpo; ||Consumo
     |FINSI;
|FPRC;

|PROCESO CabAlb;
     #30#0 = #77#50;
     #30#1 = #77#0;
     |LEE 000#30=;
     |SI FSalida = 0; |ERROR; |FINSI;
|FPRC;

|DEFBUCLE Albaranes;
     #77#3;
     ;
     "     ", #61#3, "     ", 000001;
     "zzzzz", #61#4, "zzzzz", 999999;
     ;
     NULL, CabAlb, Albaranes;
|FIN;

|PROCESO Consumo;
     #61#0 = #19#0;
     |LEE 000#61=;
     |SI FSalida = 0;
          |DDEFECTO #100;
          #100#0 = #19#0;
          |LEE 101#100=;
          |SI FSalida ! 0; |GRABA 020#100b; |FINSI;
          |BUCLE Albaranes;
          |GRABA 020#100a;
          |LIBERA #100;
     |FINSI;
|FPRC;

|DEFBUCLE Consumo;
     #19#1;
     ;
     #0#4;
     #0#5;
     ;
     NULL, Consumo;
|FIN;

|PROCESO CreaTMP_VentasL;
     swNew = 1
     |DDEFECTO #100;
     #100#00 = #11#00;  || la matricula
     |LEE 040#100.=;
     |SI FSalida = 0; swNew = 0; |FINSI;

     #100#00 = #11#00;
     #100#02 = #100#02 +  #11#7; ||( (#11#20+#11#05)*#11#06 );   ||Vta
     |SI swNew = 1;
          |GRABA 040#100.n;
     |SINO;
          |GRABA 040#100.a;
     |FINSI;
|FPRC;

|DEFBUCLE _CreaTMP_Ventas;
  #10#1;
  ;
  #00#04, #00#06, 0001;
  #00#05, #00#07, 0001;
  e;
  NULL, NULL, CreaTMP_VentasL;
|FIN;

|PROCESO CreaTMP_CosteLin;
     swNew = 1
     |DDEFECTO #100;
     #100#00 = #20#03;  || la matricula
     |LEE 040#100.=;
     |SI FSalida = 0; swNew = 0; |FINSI;

     #100#00 = #20#03;
     #100#03 = #100#03 + #21#08;   || Coste

     |SI swNew = 1;
          |GRABA 040#100.n;
     |SINO;
          |GRABA 040#100.a;
     |FINSI;
|FPRC;

|DEFBUCLE _CreaTMP_CosteLin;
  #con00626#1;
  ;
  #20#00, #20#01, 0001;
  #20#00, #20#01, 9999;
  e;
  NULL, CreaTMP_CosteLin;
|FIN;

|PROCESO CreaTMP_Coste;
     |BUCLE _CreaTMP_CosteLin;
|FPRC;

|DEFBUCLE _CreaTMP_Coste;
  #con00625#2;
  ;
  #00#04, #00#06, alimb;
  #00#05, #00#07, alimZ;
  e;
  NULL, CreaTMP_Coste;
|FIN;

|PROCESO ImprimeTMP;
     swImp = 1;
     |PRINT;
|FPRC;

|DEFBUCLE _ImprimeTMP;
  #100#1;
  ;
  INICIO;
  FINAL;
  ;
  NULL, ImprimeTMP;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     aAlfa = Usuario;
     |NOME_DAT #100#aAlfa#;
     |DELINDEX #100;

     || para no tener problemas con los defbucles.
     alimb = " " * 60;
     alimZ = "z" * 60;

     |IMPRE 0;
     |SI FSalida ! 0;  |ACABA;  |FINSI;
     |INFOR "guerz085";
     |SI FSalida ! 0;  |FINIMP;  |ACABA;  |FINSI;

     || path de datos de ventas / construccion (empresa)
     |DFICB aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + #00#00 + "/";
     |PATH_DAT #10 aAlfa;
     |PATH_DAT #11 aAlfa;

     || path de datos de taller (empresa)
     |DFICB aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + #00#02 + "/";
     |PATH_DAT #01 aAlfa;
     |PATH_DAT #20 aAlfa;
     |PATH_DAT #21 aAlfa;
     |PATH_DAT #77 aAlfa;
     |PATH_DAT #80 aAlfa;
     |PATH_DAT #61 aAlfa;

     |ABRE   #100;
     |ABRE   #61;
     |BUCLE _CreaTMP_Ventas;
     |BUCLE _CreaTMP_Coste;
     |ABRE #30;
     |BUCLE Consumo;
     |CIERRA #30;
     |ABRE #19;
     |BUCLE Gopartia;
     |CIERRA #19;

     |CIERRA #61;
     |CIERRA #100;

     swImp = 0;
     |BUCLE _ImprimeTMP;
     |SI swImp = 1; |PIEINF; |FINSI;

     |FININF;
     |FINIMP;

     |DELINDEX #100;
|FPRC;

|PROGRAMA;
     |CLS;
     |ABRE #0;
     |LEE 101#0=;
     |SI FSalida ! 0; |GRABA 020#0b; |FINSI;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |GRABA 020#0a;
     |CIERRA #0;
|FPRO;
