|FICHEROS;
     dsmox003;
     dsmox004;
     dsmox005;
     dsmox006;
     dsmox007;

     dsmom108;
|FIN;

|VARIABLES;
     nBtnEnv             = 0;
     nBtnCer             = 0;
     nBtnCan             = 0;
     nBtnPre             = 0;
     nHand1              = 0;
     nHand2              = 0;
     nCampo              = 0;
     nCar                = 0;
     nPos                = 0;
     nCmp                = 0;
     nPan                = 0;
     nEnvio              = 0;
     nIde                = 0;
     nRango              = 0;
     nOk                 = 0;
     nCon                = 0;
     nPausa              = 0;
     nNum                = 0;
     nLin                = 0;
     nGrid               = 0;
     nCodErr             = 0;
     nRegMal             = 0;
     nTrz                = 0;
     nLon                = 0;
     nNoPara             = 0;

     aAlfa               = "";
     aAlf1               = "";
     aAlf2               = "";
     aAlf3               = "";
     aDIR                = "";
     aAbre               = "";
     aFicPortal          = "";
     aFicRespHtm         = "";
     aFicRespTxt         = "";
     aName               = "";
     aOrigen             = "";
     aDestino            = "";
     aVal                = "";
     aF2                 = "";
     aCan                = "";
     aTecla              = "";
     aFic                = "";
     aPathPlugins        = "";
     aDocRemoto          = "";
     aDocServidor        = "";
     aIPRemoto           = "";
     aFicCert            = "";
     aEjec               = "";
     aLon                = "";
     aDato               = "";
     aReg                = "";
     aLetra              = "";
     aSep                = "";
     aPathExe            = "";
     aPath               = "";
     aVar                = "";
     aCmp                = "";
     aUrl                = "";
     aRz                 = "";
     aOri                = "";
     aDes                = "";
     aParam1             = "";
     aParam2             = "";
     aRetu               = "";
     aEsc1               = "";
     aEsc2               = "";
     aRojo               = "0,0,0;255,80,80";
     aVerde              = "0,185,0;255,255,255";

     {1}aContiene        = "";
     {99}aValor          = "";
     {10}aPopup          = "";

     &eaUnidad           = "";
     &eaPathEmision      = "";
     &eaPathInternet     = "";
     &eaPathPreDecla     = "";
     &eaPathLanza        = "";
     &eaPathPdf          = "";
     &eaPathErr          = "";
     &eaPathExplorador   = "";
     &eaNIFCerti         = "";
     &eaNomCerti         = "";
     &eaFicheroPlano     = "";
     &eaFOrigen          = "";
     &eaFDestino         = "";
     &eaDSMAC            = "";
     &eaUnidadBasico     = "";
     &enErrorPortal      = 0;
     &eaAlfa             = "";
     &eaNIF              = "";
     &eaJUS              = "";
     &eaCSV              = "";
     &eaEXP              = "";
     &eaNom              = "";
     &enEmp              = 0;
     &enEje              = 0;
     &enPer              = 0;
     &enMod              = 0;
     &enCom              = 0;
|FIN;

|PROCESO GrabaX5;
     |SELECT #1#dsmox005;
     #dsmox005#0 = enEmp;
     #dsmox005#1 = 999;
     |LEE 000#dsmox005.];
     |SI FSalida = 0;
         |LEE 000#dsmox005.a;
     |SINO;
         |LEE 000#dsmox005.u;
     |FINSI;

     nLin = 10;
     |SI FSalida = 0;  |Y  #dsmox005#0 = enEmp;
         nLin = #dsmox005#1 + 10;
     |FINSI;

     |DDEFECTO  #dsmox005;

     #dsmox005#0 = enEmp;
     #dsmox005#1 = nLin;
     #dsmox005#2 = aCmp;
     #dsmox005#3 = aVar;

     |GRABA 020#dsmox005.n;
     |LIBERA #dsmox005;

     |SI nCodErr > 0;
         |SI aCmp = "MENSAJE";
             #dsmox007#0 = enEmp;
             #dsmox007#1 = enEje;
             #dsmox007#2 = enPer;
             |LEE 101#dsmox007.=;
             |SI FSalida = 0;
                 #dsmox007#5 = "Con errores";
                 #dsmox007#7 = aRojo;
                 |GRABA 020#dsmox007.a;
                 |LIBERA #dsmox007;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaX6;
     #dsmox006#0 = enEmp;
     #dsmox006#1 = nIde;

     aAlfa = aAlf1 % 203;   #dsmox006#2 = aAlfa;
     aAlfa = aAlf1 % 504;   #dsmox006#3 = aAlfa;
     aAlfa = aAlf1 % 504;   #dsmox006#4 = eaNom;
     aAlfa = aAlf1 % 1809;  #dsmox006#5 = aAlfa;
     aAlfa = aAlf1 % 3640;  #dsmox006#6 = aAlfa;
     aAlfa = aAlf3 % 4;     #dsmox006#7 = aAlfa;

     |GRABA 020#dsmox006.n;
     |LIBERA #dsmox006;

     aAlf1 = "";
     aAlf2 = "";
     aAlf3 = "";
|FPRC;

|PROCESO LeeX5;
     aVar = "";

     |SELECT #2#dsmox005;
     #dsmox005#0 = enEmp;
     #dsmox005#2 = aCmp;
     |LEE 000#dsmox005.=;
     |SI FSalida = 0;
         aVar = #dsmox005#3;
     |FINSI;
     |SELECT #1#dsmox005;

     |QBF aVar;
|FPRC;

|PROCESO GrabaVar;
     aAlf1 = "";
     aAlf2 = "";
     |SI aAlfa  = "MODELO";
         aCmp   = "Modelo";  |HAZ LeeX5;

         aAlf1  =  "MODELO";
         aAlf2  =  aVar;
         enMod  = aVar;
     |FINSI;

     |SI aAlfa = "EJERCICIO";
         aCmp   = "Ejercicio";  |HAZ LeeX5;

         aAlf1  = "EJERCICIO";
         aAlf2  =  aVar;
     |FINSI;

     |SI aAlfa = "PERIODO";
         aCmp   = "Periodo";  |HAZ LeeX5;

         aAlf1  = "PERIODO";
         aAlf2  =  aVar;
     |FINSI;

     |SI aAlfa = "NDC";
         aCmp   = "NDC";  |HAZ LeeX5;

         aAlf1  = "NDC";
         aAlf2  =  aVar;
     |FINSI;

     |SI aAlfa = "IDIOMA";
         aAlf1 = "IDIOMA";
         aAlf2 = "ES";
     |FINSI;

     |SI aAlfa = "NUMBLOQUES";
         aCmp = "Total registros";  |HAZ LeeX5;

         aAlf1 = "NUMBLOQUES";
         aAlf2 = "1";
     |FINSI;

     |SI aAlfa = "CODIFICACION";
         aAlf1 = "CODIFICACION";
         aAlf2 = "UTF-8";
     |FINSI;

     |SI aAlfa = "IDENVIO";
         aCmp = "IDENVIO";  |HAZ LeeX5;

         aAlf1 = "IDENVIO";
         aAlf2 = aVar;
     |FINSI;

     |SI aAlfa = "NUMBLOQUE";
         aAlf1 = "NUMBLOQUE";
         aAlf2 = "1";
     |FINSI;

     |SI aAlfa = "FIRNIF";
         aAlf1 = "FIRNIF";
         aAlf2 = #dsmox004#8;  |QBF aAlf2;
     |FINSI;

     |SI aAlfa = "FIRNOMBRE";
         aAlf1 = "FIRNOMBRE";
         aAlf2 = #dsmox004#9;  |QBF aAlf2;
     |FINSI;

     |SI aAlfa = "FIR ";
         aAlf1 = "FIR";
         aAlf2 = "FirmaBasica";
     |FINSI;

     |SI aAlfa = "EXPEDIENTE";
         aCmp   = "EXPEDIENTE";  |HAZ LeeX5;

         aAlf1  = "EXPEDIENTE";
         aAlf2  =  aVar;
     |FINSI;

     eaAlfa = aAlf2;  |HAZ PonRarosUTF8;

     aAlfa = aAlf1 + " = " + eaAlfa + &13 + &10;
     |XGRABA nHand1, aAlfa;
|FPRC;

|PROCESO GrabaAlf;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHand1, aAlfa;
|FPRC;

|PROCESO Tip1;
     nLon = 250;
     |SI enMod = 182;
         nLon = 125;
     |FINSI;

     eaJUS = "";
     aAbre = eaPathEmision + eaFicheroPlano;
     |XABRE "UB", aAbre, nHand2;
     |SI FSalida ] 0;
         |XLEE nHand2, nLon, aAlfa;
         |SI FSalida ] 0;
             eaAlfa = aAlfa;  |HAZ PonRarosUTF8;
             |XGRABA nHand1, eaAlfa;

             eaJUS = aAlfa % 10813;
         |FINSI;

         |XLEE nHand2, nLon, aAlfa;
         |SI FSalida ] 0;
             eaAlfa = aAlfa;  |HAZ PonRarosUTF8;
             |XGRABA nHand1, eaAlfa;
         |FINSI;
     |FINSI;
     |XCIERRA nHand2;

     aAlfa = &13 + &10;
     |XGRABA nHand1, aAlfa;
|FPRC;

|PROCESO Tip2;
     aAbre = eaPathEmision + eaFicheroPlano;
     |XABRE "UB", aAbre, nHand2;
     |SI FSalida < 0;
         |ACABA;
     |FINSI;

     nLon = 250;
     |SI enMod = 182;
         nLon = 125;
     |FINSI;

     |XLEE nHand2, nLon, aAlfa;
     |XLEE nHand2, nLon, aAlfa;

     |PARA;  |SI;  |HACIENDO;
          |XLEE nHand2, nLon, aAlfa;
          |SI FSalida [ 0;  |SAL;  |FINSI;

          eaAlfa = aAlfa;  |HAZ PonRarosUTF8;
          |XGRABA nHand1, eaAlfa;

          |XLEE nHand2, nLon, aAlfa;
          |SI FSalida [ 0;  |SAL;  |FINSI;

          eaAlfa = aAlfa;  |HAZ PonRarosUTF8;
          |XGRABA nHand1, eaAlfa;

          aAlfa = &13 + &10;
          |XGRABA nHand1, aAlfa;
     |SIGUE;

     |XCIERRA nHand2;
|FPRC;

|PROCESO InicializarEnvio;
     nOk = 0;

     aUrl = "https://www1.agenciatributaria.gob.es/wlpl/OVPT-NTGV/InicializarEnvio";
     |SI aDIR = "PRODUCCION";
         aUrl = "https://www7.aeat.es/wlpl/OVPT-NTGV/InicializarEnvio";
     |FINSI;

     aAlfa = eaPathLanza + "guion.txt";    |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "resp.txt";     |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "ejecuta.bat";  |RFBORRA aAlfa;

     aAbre = eaPathLanza + "guion.txt";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = "[url]";         |HAZ GrabaAlf;
     aAlfa = aUrl;            |HAZ GrabaAlf;
     aAlfa = "[cabecera]";    |HAZ GrabaAlf;
     aAlfa = "MODELO";        |HAZ GrabaVar;
     aAlfa = "EJERCICIO";     |HAZ GrabaVar;
     aAlfa = "PERIODO";       |HAZ GrabaVar;
     aAlfa = "NDC";           |HAZ GrabaVar;
     aAlfa = "IDIOMA";        |HAZ GrabaVar;
     aAlfa = "NUMBLOQUES";    |HAZ GrabaVar;
     aAlfa = "CODIFICACION";  |HAZ GrabaVar;

     aAlfa = "[body]";        |HAZ GrabaAlf;
                              |HAZ Tip1;

     aAlfa = "[respuesta]";   |HAZ GrabaAlf;
     aAlfa = "IDENVIO";       |HAZ GrabaAlf;
     aAlfa = "ESTADO";        |HAZ GrabaAlf;
     aAlfa = "SIGBLOQUE";     |HAZ GrabaAlf;
     aAlfa = "CODIGO";        |HAZ GrabaAlf;
     aAlfa = "MENSAJE";       |HAZ GrabaAlf;

     |XCIERRA nHand1;

     aAbre = eaPathLanza + "ejecuta.bat";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = aPathExe + "dsenviohacienda.exe ";           |XGRABA nHand1, aAlfa;
     aAlfa = "ds123456 0 ";                               |XGRABA nHand1, aAlfa;
     aAlfa = eaPathLanza + "guion.txt ";                  |XGRABA nHand1, aAlfa;
     aAlfa = eaPathLanza + "resp.txt ";                   |XGRABA nHand1, aAlfa;
     aAlfa = "NO ";                                       |XGRABA nHand1, aAlfa;
     aAlfa =  #dsmox004#10;   |QBF aAlfa;                 |XGRABA nHand1, aAlfa;

     |XCIERRA nHand1;

     aEjec   = aPathExe + "dsmini ";
     aEjec   = aEjec + eaPathLanza + "ejecuta.bat";
     |RSYSTEM aEjec;

     nCon  = 0;
     aAbre = eaPathLanza + "resp.txt";
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aAbre, 0;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             nCon = nCon + 1;
             |SI nCon > 120;
                 |SAL;
             |FINSI;

             |SLEEP 1;
             |PULSATECLA;
     |SIGUE;

     aAbre = eaPathLanza + "resp.txt";
     |XABRE "EC", aAbre, 0;
     |SI FSalida < 0;
         aCmp = "MENSAJE";
         aVar = "Sin respuesta. Revise la instalaci¢n y validez del certificado digital";
         |HAZ GrabaX5;

         |SI nNoPara = 0;
             |MENAV "0000Sin respuesta. Revise la instalaci¢n y validez del certificado digital";
         |FINSI;

         |ACABA;
     |FINSI;

     aAbre = eaPathLanza + "resp.txt";
     |XABRE "UC", aAbre, nHand1;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     nIde = 0;
     |PARA; |SI; |HACIENDO;
          |XLEE nHand1, 250, aDato;
          |SI FSalida < 0;  |SAL;  |FINSI;

          aVar = aDato - "IDENVIO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "IDENVIO";
              |HAZ GrabaX5;
              nIde = 1;
          |FINSI;

          aVar = aDato - "ESTADO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "ESTADO";
              |HAZ GrabaX5;
          |FINSI;

          aVar = aDato - "SIGBLOQUE =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "SIGBLOQUE";
              |HAZ GrabaX5;
          |FINSI;

          aVar = aDato - "CODIGO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "CODIGO";
              |HAZ GrabaX5;

              nCodErr = aVar;
          |FINSI;

          aVar = aDato - "MENSAJE =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "MENSAJE";
              |HAZ GrabaX5;
          |FINSI;
     |SIGUE;
     |XCIERRA nHand1;

     |SI nIde = 0;
         |SI nNoPara = 0;
             |MENAV "0000Proceso cancelado o error de env¡o.";
         |SINO;
              aVar = "Proceso cancelado o error de env¡o.";
              aCmp = "MENSAJE";
              |HAZ GrabaX5;
         |FINSI;

         |ACABA;
     |FINSI;

     |SI nCodErr > 0;
         |SI nNoPara = 0;
             |MENAV "0000Hay errores. Consulte el mensaje de error.";
         |FINSI;

         |ACABA;
     |FINSI;

     nOk = 1;
|FPRC;

|PROCESO EnviarDatos;
     nOk     = 0;
     nRegMal = 0;

     aUrl = "https://www1.agenciatributaria.gob.es/wlpl/OVPT-NTGV/EnviarDatos";
     |SI aDIR = "PRODUCCION";
         aUrl = "https://www7.aeat.es/wlpl/OVPT-NTGV/EnviarDatos";
     |FINSI;

     aAlfa = eaPathLanza + "guion.txt";    |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "resp.txt";     |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "ejecuta.bat";  |RFBORRA aAlfa;

     aAbre = eaPathLanza + "guion.txt";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = "[url]";         |HAZ GrabaAlf;
     aAlfa = aUrl;            |HAZ GrabaAlf;
     aAlfa = "[cabecera]";    |HAZ GrabaAlf;
     aAlfa = "IDENVIO";       |HAZ GrabaVar;
     aAlfa = "NUMBLOQUE";     |HAZ GrabaVar;
     aAlfa = "CODIFICACION";  |HAZ GrabaVar;

     aAlfa = "[body]";        |HAZ GrabaAlf;
                              |HAZ Tip2;

     aAlfa = "[respuesta]";   |HAZ GrabaAlf;
     aAlfa = "IDENVIO";       |HAZ GrabaAlf;
     aAlfa = "ESTADO";        |HAZ GrabaAlf;
     aAlfa = "SIGBLOQUE";     |HAZ GrabaAlf;
     aAlfa = "CODIGO";        |HAZ GrabaAlf;
     aAlfa = "MENSAJE";       |HAZ GrabaAlf;
     aAlfa = "TOTALT2OK";     |HAZ GrabaAlf;
     aAlfa = "TOTALT2KO";     |HAZ GrabaAlf;
     aAlfa = "BLOQUET2OK";    |HAZ GrabaAlf;
     aAlfa = "BLOQUET2KO";    |HAZ GrabaAlf;

     |XCIERRA nHand1;

     aAbre = eaPathLanza + "ejecuta.bat";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = aPathExe + "dsenviohacienda.exe ";           |XGRABA nHand1, aAlfa;
     aAlfa = "ds123456 0 ";                               |XGRABA nHand1, aAlfa;
     aAlfa = eaPathLanza + "guion.txt ";                  |XGRABA nHand1, aAlfa;
     aAlfa = eaPathLanza + "resp.txt ";                   |XGRABA nHand1, aAlfa;
     aAlfa = "NO ";                                       |XGRABA nHand1, aAlfa;
     aAlfa =  #dsmox004#10;   |QBF aAlfa;                 |XGRABA nHand1, aAlfa;

     |XCIERRA nHand1;

     aEjec   = aPathExe + "dsmini ";
     aEjec   = aEjec + eaPathLanza + "ejecuta.bat";
     |RSYSTEM aEjec;

     nCon  = 0;
     aAbre = eaPathLanza + "resp.txt";
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aAbre, 0;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             nCon = nCon + 1;
             |SI nCon > 120;
                 |SAL;
             |FINSI;

             |SLEEP 1;
             |PULSATECLA;
     |SIGUE;

     aAbre = eaPathLanza + "resp.txt";
     |XABRE "EC", aAbre, 0;
     |SI FSalida < 0;
         aCmp = "MENSAJE";
         aVar = "Sin respuesta. Revise la instalaci¢n y validez del certificado digital";
         |HAZ GrabaX5;

         |SI nNoPara = 0;
             |MENAV "0000Sin respuesta. Revise la instalaci¢n y validez del certificado digital";
         |FINSI;

         |ACABA;
     |FINSI;

     aAbre = eaPathLanza + "resp.txt";
     |XABRE "UC", aAbre, nHand1;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     nIde    = 0;
     nRegMal = 0;
     |PARA; |SI; |HACIENDO;
          |XLEE nHand1, 250, aDato;
          |SI FSalida < 0;  |SAL;  |FINSI;

          aVar = aDato - "IDENVIO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "IDENVIO";
              |HAZ GrabaX5;
          |FINSI;

          aVar = aDato - "ESTADO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "ESTADO";
              |HAZ GrabaX5;
          |FINSI;

          aVar = aDato - "SIGBLOQUE =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "SIGBLOQUE";
              |HAZ GrabaX5;
          |FINSI;

          aVar = aDato - "CODIGO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "CODIGO";
              |HAZ GrabaX5;

              nCodErr = aVar;
          |FINSI;

          aVar = aDato - "MENSAJE =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "MENSAJE";
              |HAZ GrabaX5;
          |FINSI;

          aVar = aDato - "TOTALT2OK =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "Total Registros validados";
              |HAZ GrabaX5;
          |FINSI;

          aVar = aDato - "TOTALT2KO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "Total registros con errores";
              |HAZ GrabaX5;

              nRegMal = aVar;
          |FINSI;

          aVar = aDato - "BLOQUET2OK =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "TOTAL BLOQUES VALIDADOS";
              |HAZ GrabaX5;
          |FINSI;

          aVar = aDato - "BLOQUET2KO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "TOTAL BLOQUES ERRONEOS";
              |HAZ GrabaX5;
          |FINSI;
     |SIGUE;
     |XCIERRA nHand1;

     |SI nCodErr > 0;
         |SI nNoPara = 0;
             |MENAV "0000Hay errores. Consulte el mensaje de error.";
         |SINO;
             aCmp = "MENSAJE";
             aVar = "Hay errores. Consulte el mensaje de error.";
             |HAZ GrabaX5;
         |FINSI;

         |ACABA;
     |FINSI;

     |SI nRegMal > 0;
         |SI nNoPara = 0;
             |MENAV "0000Hay registros con errores, arr‚glelos y vuelva a emitir.";
         |FINSI;

         |ACABA;
     |FINSI;

     nOk = 1;
|FPRC;

|PROCESO RecuperarErrores;
     nOk = 0;

     aUrl = "https://www1.agenciatributaria.gob.es/wlpl/OVPT-NTGV/RecuperarErrores";
     |SI aDIR = "PRODUCCION";
         aUrl = "https://www7.aeat.es/wlpl/OVPT-NTGV/RecuperarErrores";
     |FINSI;

     aAlfa = eaPathLanza + "guion.txt";         |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "resp.txt";          |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "findsabre.txt";     |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "ejecuta.bat";       |RFBORRA aAlfa;

     aAbre = eaPathLanza + "guion.txt";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = "[url]";         |HAZ GrabaAlf;
     aAlfa = aUrl;            |HAZ GrabaAlf;
     aAlfa = "[cabecera]";    |HAZ GrabaAlf;
     aAlfa = "IDENVIO";       |HAZ GrabaVar;
     aAlfa = "CODIFICACION";  |HAZ GrabaVar;

     aAlfa = "[respuesta]";   |HAZ GrabaAlf;
     aAlfa = "IDENVIO";       |HAZ GrabaAlf;
     aAlfa = "ESTADO";        |HAZ GrabaAlf;
     aAlfa = "CODIGO";        |HAZ GrabaAlf;
     aAlfa = "MENSAJE";       |HAZ GrabaAlf;

     |XCIERRA nHand1;

     aAbre = eaPathLanza + "ejecuta.bat";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = aPathExe + "dsenviohacienda.exe ";           |XGRABA nHand1, aAlfa;
     aAlfa = "ds123456 0 ";                               |XGRABA nHand1, aAlfa;
     aAlfa = eaPathLanza + "guion.txt ";                  |XGRABA nHand1, aAlfa;
     aAlfa = eaPathLanza + "resp.txt ";                   |XGRABA nHand1, aAlfa;
     aAlfa = "NO ";                                       |XGRABA nHand1, aAlfa;
     aAlfa =  #dsmox004#10;   |QBF aAlfa;                 |XGRABA nHand1, aAlfa;

     |XCIERRA nHand1;

     aEjec   = aPathExe + "dsmini ";
     aEjec   = aEjec + eaPathLanza + "ejecuta.bat";
     |RSYSTEM aEjec;

     nCon  = 0;
     aAbre = eaPathLanza + "resp.txt";
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aAbre, 0;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             nCon = nCon + 1;
             |SI nCon > 120;
                 |SAL;
             |FINSI;

             |SLEEP 1;
             |PULSATECLA;
     |SIGUE;

     aAbre = eaPathLanza + "resp.txt";
     |XABRE "EC", aAbre, 0;
     |SI FSalida < 0;
         aCmp = "MENSAJE";
         aVar = "Sin respuesta. Revise la instalaci¢n y validez del certificado digital";
         |HAZ GrabaX5;

         |SI nNoPara = 0;
             |MENAV "0000Sin respuesta. Revise la instalaci¢n y validez del certificado digital";
         |FINSI;

         |ACABA;
     |FINSI;

     aAbre = eaPathLanza + "resp.txt";
     |XABRE "UC", aAbre, nHand1;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     nIde    = 0;
     nRegMal = 0;
     |PARA; |SI; |HACIENDO;
          |XLEE nHand1, 250, aDato;
          |SI FSalida < 0;  |SAL;  |FINSI;

          aVar = aDato - "IDENVIO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "IDENVIO";
              |HAZ GrabaX5;
          |FINSI;

          aVar = aDato - "ESTADO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "ESTADO";
              |HAZ GrabaX5;
          |FINSI;

          aVar = aDato - "CODIGO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "CODIGO";
              |HAZ GrabaX5;

              nCodErr = aVar;
          |FINSI;

          aVar = aDato - "MENSAJE =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "MENSAJE";
              |HAZ GrabaX5;
          |FINSI;
     |SIGUE;
     |XCIERRA nHand1;

     aCmp = "MENSAJE";
     aVar = "Hay registros con errores, arr‚glelos y vuelva a emitir.";
     |HAZ GrabaX5;
|FPRC;

|PROCESO PresentarEnvio;
     nOk = 0;

     aUrl = "https://www1.agenciatributaria.gob.es/wlpl/OVPT-NTGV/PresentarEnvio";
     |SI aDIR = "PRODUCCION";
         aUrl = "https://www7.aeat.es/wlpl/OVPT-NTGV/PresentarEnvio";
     |FINSI;

     aAlfa = eaPathLanza + "guion.txt";         |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "resp.txt";          |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "ejecuta.bat";       |RFBORRA aAlfa;

     aAbre = eaPathLanza + "guion.txt";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = "[url]";         |HAZ GrabaAlf;
     aAlfa = aUrl;            |HAZ GrabaAlf;
     aAlfa = "[cabecera]";    |HAZ GrabaAlf;
     aAlfa = "IDENVIO";       |HAZ GrabaVar;
     aAlfa = "FIRNIF";        |HAZ GrabaVar;
     aAlfa = "FIRNOMBRE";     |HAZ GrabaVar;
     aAlfa = "FIR ";          |HAZ GrabaVar;

     aAlfa = "[respuesta]";     |HAZ GrabaAlf;
     aAlfa = "IDENVIO";         |HAZ GrabaAlf;
     aAlfa = "ESTADO";          |HAZ GrabaAlf;
     aAlfa = "NUMEROREGISTROS"; |HAZ GrabaAlf;
     aAlfa = "CSV";             |HAZ GrabaAlf;
     aAlfa = "EXPEDIENTE";      |HAZ GrabaAlf;
     aAlfa = "CODIGO";          |HAZ GrabaAlf;
     aAlfa = "MENSAJE";         |HAZ GrabaAlf;

     |XCIERRA nHand1;

     aAbre = eaPathLanza + "ejecuta.bat";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = aPathExe + "dsenviohacienda.exe ";           |XGRABA nHand1, aAlfa;
     aAlfa = "ds123456 0 ";                               |XGRABA nHand1, aAlfa;
     aAlfa = eaPathLanza + "guion.txt ";                  |XGRABA nHand1, aAlfa;
     aAlfa = eaPathLanza + "resp.txt ";                   |XGRABA nHand1, aAlfa;
     aAlfa = "NO ";                                       |XGRABA nHand1, aAlfa;
     aAlfa =  #dsmox004#10;   |QBF aAlfa;                 |XGRABA nHand1, aAlfa;

     |XCIERRA nHand1;

     aEjec   = aPathExe + "dsmini ";
     aEjec   = aEjec + eaPathLanza + "ejecuta.bat";
     |RSYSTEM aEjec;

     nCon  = 0;
     aAbre = eaPathLanza + "resp.txt";
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aAbre, 0;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             nCon = nCon + 1;
             |SI nCon > 120;
                 |SAL;
             |FINSI;

             |SLEEP 1;
             |PULSATECLA;
     |SIGUE;

     aAbre = eaPathLanza + "resp.txt";
     |XABRE "EC", aAbre, 0;
     |SI FSalida < 0;
         aCmp = "MENSAJE";
         aVar = "Sin respuesta. Revise la instalaci¢n y validez del certificado digital";
         |HAZ GrabaX5;

         |SI nNoPara = 0;
             |MENAV "0000Sin respuesta. Revise la instalaci¢n y validez del certificado digital";
         |FINSI;

         |ACABA;
     |FINSI;

     aAbre = eaPathLanza + "resp.txt";
     |XABRE "UC", aAbre, nHand1;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     nIde    = 0;
     nRegMal = 0;
     |PARA; |SI; |HACIENDO;
          |XLEE nHand1, 250, aDato;
          |SI FSalida < 0;  |SAL;  |FINSI;

          aVar = aDato - "IDENVIO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "IDENVIO";
              |HAZ GrabaX5;
          |FINSI;

          aVar = aDato - "ESTADO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "ESTADO";
              |HAZ GrabaX5;
          |FINSI;

          aVar = aDato - "NUMEROREGISTROS =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "NUMEROREGISTROS";
              |HAZ GrabaX5;
          |FINSI;

          aVar = aDato - "CSV =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "CSV";
              |HAZ GrabaX5;

              eaCSV = aVar;  |QBF eaCSV;
          |FINSI;

          aVar = aDato - "EXPEDIENTE =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "EXPEDIENTE";
              |HAZ GrabaX5;

              eaEXP = aVar;  |QBF eaEXP;
          |FINSI;

          aVar = aDato - "CODIGO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "CODIGO";
              |HAZ GrabaX5;

              nCodErr = aVar;
          |FINSI;

          aVar = aDato - "MENSAJE =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "MENSAJE";
              |HAZ GrabaX5;
          |FINSI;
     |SIGUE;
     |XCIERRA nHand1;

     nOk = 0;
     |SI eaCSV ! "";
         |HAZ GrabaImpresoDirecto;

         #dsmox007#0 = enEmp;
         #dsmox007#1 = enEje;
         #dsmox007#2 = enPer;
         |LEE 101#dsmox007.=;
         |SI FSalida = 0;
             #dsmox007#5 = "Presentado";
             #dsmox007#7 = aVerde;
             |GRABA 020#dsmox007.a;
             |LIBERA #dsmox007;
         |FINSI;

         nOk   = 1;
     |SINO;
         |SI nNoPara = 0;
             |MENAV "0000Hay errores. Consulte el mensaje de error.";
         |SINO;
             aCmp = "MENSAJE";
             aVar = "Hay errores. Consulte el mensaje de error.";
             |HAZ GrabaX5;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Parada;
     |SI nNoPara = 1;
         |ACABA;
     |FINSI;

     aRetu  = &255 + "802";
     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     |PARA; |SI;  |HACIENDO;
          FSalida = "::{{001}}Salir," + nGrid;
          |LEETECLA aTecla;

          |SI aTecla = aRetu; |SAL;  |FINSI;
          |SI aTecla = aEsc1; |SAL;  |FINSI;
          |SI aTecla = aEsc2; |SAL;  |FINSI;
     |SIGUE;
|FPRC;

|PROCESO VerTXT;
     aAbre = eaPathLanza + "errores.txt";
     |XABRE "EC", aAbre, 0;
     |SI FSalida < 0;
         |ACABA;
     |FINSI;

     aAbre = eaPathLanza + "ejecuta.bat";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = aPathExe + "dsabreextension ";
     aAlfa = aAlfa + eaPathLanza + "errores.txt ";
     aAlfa = aAlfa + eaPathLanza + "findsabre.txt ";
     |XGRABA nHand1, aAlfa;

     |XCIERRA nHand1;

     aEjec = aPathExe + "dsmini " + aAbre;
     |RSYSTEM aEjec;

     aAbre = eaPathLanza + "findsabre.txt";
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aAbre, 0;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             |SLEEP 1;
             |PULSATECLA;
     |SIGUE;

     aAlfa = eaPathLanza + "ejecuta.bat";       |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "findsabre.txt";     |RFBORRA aAlfa;

     |FOCOTECLADO nGrid;
|FPRC;

|PROCESO LeeX6;
     aAbre = eaPathLanza + "errores.txt";
     |XABRE "C", aAbre, nHand1;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     nIde    = 0;
     nTrz    = 0;
     |PARA; |SI; |HACIENDO;
          |XLEE nHand1, 250, aDato;
          |SI FSalida < 0;  |SAL;  |FINSI;

          |SI nIde = 0;
              aRz = aDato % 117;
          |FINSI;

          aAlfa = aDato % 117;
          |SI aAlfa = aRz;
              |SI nIde ! 0;
                  |HAZ GrabaX6;
                  nTrz = 0;
              |FINSI;

              nIde = nIde + 1;
          |FINSI;

          nTrz = nTrz + 1;

          |SI nTrz = 1;  aAlf1 = aDato;  |FINSI;
          |SI nTrz = 2;  aAlf2 = aDato;  |FINSI;
          |SI nTrz = 3;  aAlf3 = aDato;  |FINSI;
     |SIGUE;
     |XCIERRA nHand1;

     |HAZ GrabaX6;
|FPRC;

|PROCESO VerDAT;
     |LEE 000#dsmox006.p;
     |SI FSalida ! 0;
         |HAZ LeeX6;
     |FINSI;

     |LEE 000#dsmox006.p;
     |SI FSalida = 0;
         |CONSULTA_CLAVE #1#dsmox006;
     |FINSI;

     |FOCOTECLADO nGrid;
|FPRC;

|PROCESO VerPDF;
     |SUB_EJECUTA "dsmoy998;PRES";

     |FOCOTECLADO nGrid;
|FPRC;

|PROCESO GuardaPDF;
     |SUB_EJECUTA "dsmoy998;SALVA";

     aCmp = "MENSAJE";
     aVar = "El PDF se encuentra en: " + eaPathPdf;
     |HAZ GrabaX5;

     |REFRESCACONTROL nGrid;
     |FOCOTECLADO nGrid;
|FPRC;

|PROCESO GuardaError;
     aAbre = eaPathLanza + "errores.txt";
     |XABRE "EC", aAbre, nHand1;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |HAZ LeeX6;

     aOri = eaPathLanza + "errores.txt";
     aDes = eaPathErr   + (("00000" + enEmp) % -105) + ".txt";
     |RCOPIA_FICHERO aOri, aDes;

     #dsmox007#0 = enEmp;
     #dsmox007#1 = enEje;
     #dsmox007#2 = enPer;
     |LEE 101#dsmox007.=;
     |SI FSalida = 0;
         #dsmox007#5 = "Con errores";
         #dsmox007#7 = aRojo;
         |GRABA 020#dsmox007.a;
         |LIBERA #dsmox007;
     |FINSI;
|FPRC;

|PROCESO AltaDeclaracion;
     |HAZ InicializarEnvio;
     |REFRESCACONTROL nGrid;
     |PTEC 802;  |PAUSA;

     |SI nOk = 0;
         |HAZ Parada;
         |ACABA;
     |FINSI;

     |HAZ EnviarDatos;
     |REFRESCACONTROL nGrid;
     |PTEC 802;  |PAUSA;

     |SI nRegMal = 0;  |Y nOk = 0;
         |HAZ Parada;
         |ACABA;
     |FINSI;

     |SI nRegMal > 0;
         |HAZ RecuperarErrores;

         |REFRESCACONTROL nGrid;
         |PTEC 802;  |PAUSA;

         |SI nNoPara = 0;
             |CONTROL_SIMPLE nPan, "BOTON,{{197}}Ver errores TXT", 3302, 3418, VerTXT;
             |CONTROL_SIMPLE nPan, "BOTON,{{197}}Ver errores GRID", 3320, 3436, VerDAT;

             |HAZ Parada;
         |FINSI;

         |SI nNoPara = 1;
             |HAZ GuardaError;
         |FINSI;

         |ACABA;
     |FINSI;

     |HAZ PresentarEnvio;

     |SI nOk = 1;
         aCmp = "MENSAJE";
         aVar = "Documento Presentado";
         |HAZ GrabaX5;
     |FINSI;

     |REFRESCACONTROL nGrid;
     |PTEC 802;  |PAUSA;

     |SI nOk = 1;
         |SI nNoPara = 1;
             |HAZ GuardaPDF;

             |ACABA;
         |FINSI;

         |MENAV "0000Documento presentado. Si quiere ver el documento pulse en Visualizar PDF";

         |CONTROL_SIMPLE nPan, "BOTON,{{197}}Visualizar PDF", 3302, 3418, VerPDF;

         |HAZ GuardaPDF;
     |FINSI;

     |HAZ Parada;
|FPRC;

|PROCESO BajaDeclaracion;
     nOk = 0;

     aUrl = "https://www1.agenciatributaria.gob.es/wlpl/OVPT-NTGV/BajaDeclaracion";
     |SI aDIR = "PRODUCCION";
         aUrl = "https://www7.aeat.es/wlpl/OVPT-NTGV/BajaDeclaracion";
     |FINSI;

     aAlfa = eaPathLanza + "guion.txt";         |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "resp.txt";          |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "ejecuta.bat";       |RFBORRA aAlfa;

     aAbre = eaPathLanza + "guion.txt";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = "[url]";         |HAZ GrabaAlf;
     aAlfa = aUrl;            |HAZ GrabaAlf;
     aAlfa = "[cabecera]";    |HAZ GrabaAlf;
     aAlfa = "FIRNIF";        |HAZ GrabaVar;
     aAlfa = "FIRNOMBRE";     |HAZ GrabaVar;
     aAlfa = "FIR ";          |HAZ GrabaVar;
     aAlfa = "MODELO";        |HAZ GrabaVar;
     aAlfa = "EJERCICIO";     |HAZ GrabaVar;
     aAlfa = "PERIODO";       |HAZ GrabaVar;
     aAlfa = "NDC";           |HAZ GrabaVar;
     aAlfa = "EXPEDIENTE";    |HAZ GrabaVar;

     aAlfa = "[respuesta]";     |HAZ GrabaAlf;
     aAlfa = "EXPEDIENTE";      |HAZ GrabaAlf;
     aAlfa = "CODIGO";          |HAZ GrabaAlf;
     aAlfa = "MENSAJE";         |HAZ GrabaAlf;

     |XCIERRA nHand1;

     aAbre = eaPathLanza + "ejecuta.bat";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = aPathExe + "dsenviohacienda.exe ";           |XGRABA nHand1, aAlfa;
     aAlfa = "ds123456 0 ";                               |XGRABA nHand1, aAlfa;
     aAlfa = eaPathLanza + "guion.txt ";                  |XGRABA nHand1, aAlfa;
     aAlfa = eaPathLanza + "resp.txt ";                   |XGRABA nHand1, aAlfa;
     aAlfa = "NO ";                                       |XGRABA nHand1, aAlfa;
     aAlfa =  #dsmox004#10;   |QBF aAlfa;                 |XGRABA nHand1, aAlfa;

     |XCIERRA nHand1;

     aEjec   = aPathExe + "dsmini ";
     aEjec   = aEjec + eaPathLanza + "ejecuta.bat";
     |RSYSTEM aEjec;

     nCon  = 0;
     aAbre = eaPathLanza + "resp.txt";
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aAbre, 0;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             nCon = nCon + 1;
             |SI nCon > 120;
                 |SAL;
             |FINSI;

             |SLEEP 1;
             |PULSATECLA;
     |SIGUE;

     aAbre = eaPathLanza + "resp.txt";
     |XABRE "EC", aAbre, 0;
     |SI FSalida < 0;
         aCmp = "MENSAJE";
         aVar = "Sin respuesta. Revise la instalaci¢n y validez del certificado digital";
         |HAZ GrabaX5;

         |MENAV "0000Sin respuesta. Revise la instalaci¢n y validez del certificado digital";

         |ACABA;
     |FINSI;

     aAbre = eaPathLanza + "resp.txt";
     |XABRE "UC", aAbre, nHand1;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     nIde    = 0;
     |PARA; |SI; |HACIENDO;
          |XLEE nHand1, 250, aDato;
          |SI FSalida < 0;  |SAL;  |FINSI;

          aVar = aDato - "EXPEDIENTE =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "EXPEDIENTE";
              |HAZ GrabaX5;

              eaEXP = aVar;  |QBF eaEXP;
          |FINSI;

          aVar = aDato - "CODIGO =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "CODIGO";
              |HAZ GrabaX5;

              nIde    = aVar;
          |FINSI;

          aVar = aDato - "MENSAJE =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "MENSAJE";
              |HAZ GrabaX5;
          |FINSI;
     |SIGUE;
     |XCIERRA nHand1;

     |REFRESCACONTROL nGrid;
     |PTEC 802;  |PAUSA;

     |SI nIde ! 0;
         |MENAV "0000No se ha podido dar de baja la declaraci¢n. Consulte el error";
     |SINO;
         ||HAZ DesGrabaImpresoDirecto;
     |FINSI;

     |HAZ Parada;
|FPRC;

|PROCESO Enviar;
     |FIN_CONTROL_WINDOWS nBtnCer;
     |FIN_CONTROL_WINDOWS nBtnCan;
     |FIN_CONTROL_WINDOWS nBtnEnv;
     |FIN_CONTROL_WINDOWS nBtnPre;

     |SI aParam1 ! "B";
         |HAZ AltaDeclaracion;

         aFic = eaPathEmision + Usuario + ".ok";
         |XABRE "WB", aFic, nHand1;

         aAlfa = "OK"
         |XGRABA nHand1, aAlfa;

         |XCIERRA nHand1;
     |FINSI;

     |SI aParam1 = "B";
         |HAZ BajaDeclaracion;
     |FINSI;
|FPRC;

|PROCESO BtnEnv;
     nEnvio = 1;

     |PTEC 806;
|FPRC;

|PROCESO Cancelar;
     |PTEC 807;
|FPRC;

|PROCESO T0C1;  |TIPO 0;
     |SI #dsmox004#1 = "N";
         |ACABA;
     |FINSI;

     |SI #dsmox004#8 = "         ";
         |MENAV "0000Seleccione un presentador.";
         #dsmox004#1 = "N";
         |PINTA #dsmox004#1;
         |ACABA;
     |SINO;
         |ESTADO_CONTROL nBtnPre, "ENABLE";
     |FINSI;
|FPRC;

|PROCESO Certificados;
     |CONSULTA_CLAVE #2#dsmox003;
     |SI FSalida = 0;
         #dsmox004#8  = #dsmox003#1;  |PINTA #dsmox004#8;
         #dsmox004#9  = #dsmox003#2;  |PINTA #dsmox004#9;
         #dsmox004#10 = #dsmox003#3;
     |FINSI;

     |SI #dsmox004#8 ! "         ";
         |ESTADO_CONTROL nBtnPre, "ENABLE";
     |FINSI;
|FPRC;

|PROCESO Predeterminar;
     aPopup1  = nBtnPre;  || Si fuera -1 en la posicion
     aPopup2  = 2;
     aPopup3  = "Grabar predeterminado";
     aPopup4  = "Quitar predeterminado";

     IaPopup  = aPopup1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;
     |SI FSalida = 1;  |O FSalida = 2;
         |SI FSalida = 1;  aAlfa = #dsmox004#8;  |FINSI;
         |SI FSalida = 2;  aAlfa = "";  |FINSI;

         |ABRE #dsmom108;
         #dsmom108#0 = eaDSMAC;
         |LEE 101#dsmom108.=;
         |SI FSalida ! 0;
             |DDEFECTO #dsmom108;
             #dsmom108#0 = eaDSMAC;
             |GRABA 020#dsmom108.b;
         |FINSI;

         #dsmom108#4 = aAlfa;
         |GRABA 020#dsmom108.a;
         |LIBERA #dsmom108;
         |CIERRA #dsmom108;
     |FINSI;
|FPRC;

|PROCESO Baj5;
     #dsmox005#0 = enEmp;
     #dsmox005#1 = 0;
|FPRC;

|PROCESO Alt5;
     #dsmox005#0 = enEmp;
     #dsmox005#1 = 999;
|FPRC;

|PROGRAMA;
     aCmp = "Total registros";  |HAZ LeeX5;
     nNum = aVar;
     |SI nNum > 40000;
         |SI nNoPara = 1;
             |MENAV "0000Mas de 40.000 registros. Declarelos por la p gina de la AEAT";
         |FINSI;
         |ACABA;
     |FINSI;

     |DBASE aPath;  |QBT aPath;
     aAbre = aPath + "webdirecta.txt";
     |XABRE "E", aAbre, 0;
     |SI FSalida ] 0;
         |XABRE "", aAbre, nHand1;
         |XLEE nHand1, 250, aDIR;
         |XCIERRA nHand1;
         |QBF aDIR;
         |SI aDIR = "";
             |SI nNoPara = 1;
                 |MENAV "0000Configuraci¢n incorrecta de la WEB directa.";
             |FINSI;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI nNoPara = 0;
         |SI aParam2 = "1";
             nNoPara = 1;
         |FINSI;

         |PINPA #0#dsmox004;  nPan = FSalida;
         |PINDA #0#dsmox004;

         |CONTROL_SIMPLE nPan, "LABEL,{{15}}Conforme ", 3102, 3113, NULL;

         aAlfa = "LABEL,{{7}}(Para finalizar el proceso marque la casilla ";
         aAlfa = aAlfa + &34 + "Conforme"  + &34 + "y pulse en " + &34 + "Presentar" + &34 + ")";
         |CONTROL_SIMPLE nPan, aAlfa, 3120, 3198, NULL;

         |CONTROL_SIMPLE nPan, "BOTON,{{197}}", 0921, 0922, Certificados;
         nBtnCer = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{207}}Cancelar", 3488, 3598, Cancelar;
         nBtnCan = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{197}}Firmar y enviar", 3470, 3585, BtnEnv;
         nBtnEnv = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{197}}Predeterminar presentador", 3502, 3525, Predeterminar;
         nBtnPre = FSalida;

         |SI aDIR = "PRODUCCION";
             |MENAV "0000Se env¡a al servidor de pruebas";
             |CONTROL_SIMPLE nPan, "LABEL,{{16}}Env¡o servidor de pruebas", 0578, 0598, NULL;
         |FINSI;

         |SI #dsmox004#8 = "         ";
             |ESTADO_CONTROL nBtnPre, "DISABLE";
         |FINSI;

         nRango = 4 + 8 + 16 + 32;
         |LINEAL_SIMPLE #1#dsmox005, nRango, 1202, 2998, Baj5, Alt5, NULL;
         nGrid = FSalida;

         nEnvio = 0;
         |PARA; |SI;  |HACIENDO;
             |SI #dsmox004#1 = "S";
                 |ESTADO_CONTROL nBtnEnv, "ENABLE";
             |SINO;
                 |ESTADO_CONTROL nBtnEnv, "DISABLE";
             |FINSI;

             |PINTA #dsmox004#1;

             |ENCAMPO #1#dsmox004;
             |SI nEnvio  = 1;  |HAZ Enviar;   |SAL;  |FINSI;
             |SI FSalida = 7;
                 |SI nNoPara = 1;
                     nNoPara = 0;
                 |FINSI;
                 |SAL;
             |FINSI;
         |SIGUE;

         |ACABA;
     |FINSI;

     |SI nNoPara = 1;
         |C_V #dsmox004#1, 1, "N";

         |PINPA #0#dsmox004;  nPan = FSalida;
         |PINDA #0#dsmox004;

         nRango = 4 + 8 + 16 + 32;
         |LINEAL_SIMPLE #1#dsmox005, nRango, 1202, 2998, Baj5, Alt5, NULL;
         nGrid = FSalida;

         |HAZ Enviar;
     |FINSI;
|FPRO;

|PROCESO TraeExes;
     |HAZ LeeUnidadBasico;

     aPathExe = eaUnidadBasico + "\MODELOS";  |RMKDIR aPathExe;
     aPathExe = aPathExe + "\DSMAC";          |RMKDIR aPathExe;
     aPathExe = aPathExe + "\";

     |DBASE aPathPlugins;  |QBT aPathPlugins;
     aPathPlugins = aPathPlugins + "plugins";
     |MKDIR aPathPlugins;
     aOrigen  = aPathPlugins + "/ds_listacerti.exe";
     aDestino = aPathExe + "ds_listacerti.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aOrigen  = aPathPlugins + "/dsmini.exe";
     aDestino = aPathExe + "dsmini.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aOrigen  = aPathPlugins + "/dsenviohacienda.exe";
     aDestino = aPathExe + "dsenviohacienda.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aOrigen  = aPathPlugins + "/dsabreextension.exe";
     aDestino = aPathExe + "dsabreextension.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aOrigen  = aPathPlugins + "/ds_eje_php.exe";
     aDestino = aPathExe + "ds_eje_php.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Datos;
     aValor1 = "";
     aValor2 = "";

     nCampo  = 1;
     IaValor = aValor1<-;
     aLon    = aDato % 0;
     aReg    = "";
     aSep    = ";";
     |PARA nCar = 1; |SI nCar [ aLon; |HACIENDO nCar = nCar + 1;
          nPos   = (nCar * 100) + 1;
          aLetra = aDato % nPos;
          |SI aLetra = aSep;
              aValor  = aReg;
              aReg    = "";
              nCampo  = nCampo + 1;
              IaValor = IaValor + 1;
          |SINO;
               aReg = aReg + aLetra;
          |FINSI;

          |SI nCampo > 90; |SAL; |FINSI;     || Por si.... :)
     |SIGUE;

     aValor = aReg;
|FPRC;

|PROCESO ListaCertificados;
     |HAZ TraeExes;

     aFicCert = eaPathLanza + "certifi.csv";

     aAbre = eaPathLanza + "ejecuta.bat";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = aPathExe + "ds_listacerti ds123456 " + aFicCert;
     |XGRABA nHand1, aAlfa;

     |XCIERRA nHand1;

     aEjec = aPathExe + "dsmini " + aAbre;
     |RSYSTEM aEjec;

     nCon  = 0;
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aFicCert, 0;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             |SLEEP 1;
             |PULSATECLA;

             nCon = nCon + 1;
             |SI nCon > 60;  |SAL;  |FINSI;
     |SIGUE;

     aAbre = aFicCert;
     |XABRE "UC", aAbre, nHand1;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     nIde = 0;
     |PARA; |SI; |HACIENDO;
          |XLEE nHand1, 250, aDato;
          |SI FSalida < 0;  |SAL;  |FINSI;

          |HAZ Datos;

          nIde = nIde + 1;

          #dsmox003#0 = nIde;
          #dsmox003#1 = aValor1;
          #dsmox003#2 = aValor2;
          #dsmox003#3 = aValor3;
          |GRABA 020#dsmox003.n;
          |LIBERA #dsmox003;
     |SIGUE;
     |XCIERRA nHand1;

     aAbre = eaPathLanza + "ejecuta.bat";  |RFBORRA aAbre;
     aAbre = aFicCert;                     |RFBORRA aAbre;
|FPRC;

|PROCESO T80;  |TIPO 80;
     aAlfa = PARAMETRO % 105;
     enEmp = aAlfa;

     aFic = "dsmox004" + Usuario;
     |NOME_DAT #dsmox004#aFic#;    |ABRET #dsmox004;

     aFic = "dsmox003" + Usuario;  |NOME_DAT #dsmox003#aFic#;
     aFic = "dsmox005" + Usuario;  |NOME_DAT #dsmox005#aFic#;
     aFic = "dsmox006" + Usuario;  |NOME_DAT #dsmox006#aFic#;
     aFic = "dsmox007" + Usuario;  |NOME_DAT #dsmox007#aFic#;

     |ABRE #dsmox003;  |CIERRA #dsmox003;  |DELINDEX #dsmox003;

     aParam1 = PARAMETRO % 601;  || 0-Emision unica  1-Masivo  B-Baja
     aParam2 = PARAMETRO % 701;  || 0-Parada         1-Sin parar

     |SI aParam1 = "0";  |O aParam2 = "0";
         |ABRE #dsmox006;  |CIERRA #dsmox006;  |DELINDEX #dsmox006;
         |ABRE #dsmox007;  |CIERRA #dsmox007;  |DELINDEX #dsmox007;
     |FINSI;

     |ABRET #dsmox003;
     |ABRET #dsmox005;
     |ABRET #dsmox006;
     |ABRET #dsmox007;

     |LEE 000#dsmox004.p;

     nNoPara = 1;
     |LEE 000#dsmox007.p;
     |SI FSalida ! 0;
         nNoPara = 0;
     |FINSI;

     eaPathEmision    = #dsmox004#2;  |QBF eaPathEmision;
     eaPathInternet   = #dsmox004#3;  |QBF eaPathInternet;
     eaPathPreDecla   = #dsmox004#4;  |QBF eaPathPreDecla;
     eaPathLanza      = #dsmox004#5;  |QBF eaPathLanza;
     eaPathExplorador = #dsmox004#6;  |QBF eaPathExplorador;
     eaFicheroPlano   = #dsmox004#7;  |QBF eaFicheroPlano;

     aFic = eaPathEmision + Usuario + ".ok";
     |FBORRA aFic;

     |HAZ ListaCertificados;

     |HAZ CogeMac;

     |ABRE #dsmom108;
     #dsmom108#0 = eaDSMAC;
     |LEE 000#dsmom108.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom108;  |FINSI;
     |CIERRA #dsmom108;

     aCmp = "NDC";  |HAZ LeeX5;
     |SI aVar ! "";
         #dsmox003#1 = aVar;
     |FINSI;

     |SI #dsmom108#4 ! "         ";
         #dsmox003#1 = #dsmom108#4;
     |FINSI;

     |SELECT #2#dsmox003;
     |LEE 000#dsmox003.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmox003;
     |FINSI;
     |SELECT #1#dsmox003;

     #dsmox004#8  = #dsmox003#1;
     #dsmox004#9  = #dsmox003#2;
     #dsmox004#10 = #dsmox003#3;

     aCmp  = "Complemento";  |HAZ LeeX5;
     enCom = aVar;

     aCmp  = "Ejercicio";  |HAZ LeeX5;
     enEje = aVar;

     aCmp  = "Periodo";  |HAZ LeeX5;
     enPer = aVar;

     |SI aVar = "0A";  enPer = 99;  |FINSI;
     |SI aVar = "1T";  enPer =  3;  |FINSI;
     |SI aVar = "2T";  enPer =  6;  |FINSI;
     |SI aVar = "3T";  enPer =  9;  |FINSI;
     |SI aVar = "4T";  enPer = 12;  |FINSI;

     aCmp  = "Nombre contribuyente";  |HAZ LeeX5;
     eaNom = aVar;

     aCmp  = "Modelo";  |HAZ LeeX5;
     enMod = aVar;

     #dsmox007#0 = enEmp;
     #dsmox007#1 = enEje;
     #dsmox007#2 = enPer;
     #dsmox007#3 = enMod;
     #dsmox007#4 = enCom;
     #dsmox007#5 = "";
     #dsmox007#6 = eaNom;
     #dsmox007#7 = "";
     |GRABA 000#dsmox007.n;
     |LIBERA #dsmox007;

     |HAZ LeeUnidad;
     eaPathPdf = eaUnidad + "\AEAT\PDF";        |RMKDIR eaPathPdf;
     eaPathPdf = eaPathPdf + "\" + enMod;       |RMKDIR eaPathPdf;
     eaPathPdf = eaPathPdf + "\" + enEje;       |RMKDIR eaPathPdf;

     |SI enPer ! 99;
         eaPathPdf = eaPathPdf + "\" + (("00" + enPer) % -102);
         |RMKDIR eaPathPdf;
     |FINSI;
     eaPathPdf = eaPathPdf + "\";

     eaPathErr = eaUnidad + "\AEAT\ERRORES";    |RMKDIR eaPathErr;
     eaPathErr = eaPathErr + "\" + enMod;       |RMKDIR eaPathErr;
     eaPathErr = eaPathErr + "\" + enEje;       |RMKDIR eaPathErr;

     |SI enPer ! 99;
         eaPathErr = eaPathErr + "\" + (("00" + enPer) % -102) + "\";
         |RMKDIR eaPathErr;
     |FINSI;
     eaPathErr = eaPathErr + "\";

     FSalida = 3599;
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #dsmox003;  |DELINDEX #dsmox003;
     |CIERRAT #dsmox004;  |DELINDEX #dsmox004;
     |CIERRAT #dsmox005;
     |CIERRAT #dsmox006;
     |CIERRAT #dsmox007;

     |SI nNoPara = 0;
         |DELINDEX #dsmox005;
         |DELINDEX #dsmox006;
         |DELINDEX #dsmox007;
     |FINSI;
|FPRC;
