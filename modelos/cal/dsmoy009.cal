|FICHEROS;
   dsmoy009 #0;

   :/basica/def/agicen14 #114;
   :/basica/def/agifigen #118;
   :/basica/def/agim0019 #119;
   :/basica/def/agitab99 #99;

   :/contagen/def/canempre #300;
   :/contagen/def/caivaasi #301;
   :/contagen/def/camaniva #304;
   :/contagen/def/caivalin #305;
   :/contagen/def/caconimp #306;  || configuracion impresiones

   dsmom030 #30;
   dsmow030 #900;          ||Def de impresion
   dsmow031 #901;

   dsmow157 #957;
   dsmow049 #998,MANTE;
   dsmow043 #999,MANTE;

   &regisnif@ #709;
|FIN;

|VARIABLES;
   informe     = "";
   aInfoRes    = "";
   nInkey      = 0;
   aFichero    = "";
   nCampo      = 0;
   nDEmpresa   = 0;
   nHEmpresa   = 0;
   nDActividad = 0;
   nHActividad = 0;
   nLaEmpresa  = 0;
   nGTempo     = 0;
   nSPin1      = 0;
   aPath       = "";
   nEjercicio  = 0;
   aHora       = "";
   aAlfa0      = "";
   aAlfa1      = "";
   aAlfa2      = "";
   aAlfa3      = "";
   nPara1      = 0;
   nPara2      = 0;
   nPara3      = 0;
   nNume1      = 0;
   nNume2      = 0;
   nNume3      = 0;
   nNume4      = 0;
   nNume5      = 0;
   nNume6      = 0;
   fFecha      = @;
   aDTipo      = "";
   aHTipo      = "";
   SwHayDatos  = 0;

   fDFecha     = @;
   fHFecha     = @;
   nDLiqui     = 0;
   nHLiqui     = 0;
   fLaFecha    = @;

   nElDepar    = 0;
   nEstado     = 0;
   aParam       = "";
   Comodin      = "";
   Comodin1     = "";
   aAlfa        = "";
   Handle       = 0;
   Numeracion   = 0;

   nSigFactu    = 0;
   aClave       = "";
   aNomModelo   = "";
   nOperacion   = 0;
   nOpMdep      = 0;
   nAlSi        = 0;
   nAlNo        = 0;
   nAlConcepto  = 0;

   {-1}aMenu           = "";
       aMenu1          = "2400";
       aMenu2          = "1";
       aMenu3          = "Archivo documental activado. Elija opci¢n: ";
       aMenu4          = "IAB";
       aMenu5          = "Imprimir";
       aMenu6          = "Archivar";
       aMenu7          = "Ambos";
       nOpcion         = 0;
       nSegurOp        = 0;

   &enErrorDSArchi     = 0;
   &eaVengoDe          = "";
   &enArchi            = 0;
   &eaInforme          = "";
   &enEjercicio        = 0;
   &eaNifEmp           = "";
   &enCodTrab          = 0;
   &eaNombreTra        = "";
   &eaNifTra           = "";
   &eaObservacion1     = "";
   &eaObservacion2     = "";
   &eaObservacion3     = "";
   &enM2               = 0;

   &eSwReten    = 0;
   &entrada     = 1;
   &eaTexPie    = "";
   &enPorCsv    = 0;
   &eaPathDoc   = "";
   &eaNomProg   = "";
   &aTipoIVA    = "";
   &eaTipo      = "DE COMPRA";
   &eaTipoRS    = "SOPORTADO";
   &nFactura    = 0;
   &nPagina     = 0;
   &nPagDup     = 0;
   &nSwPagDup   = 0;
   &SwPrim      = 0;
   &SwLinea     = 0;
   &nLBase      = 0;
   &nLTipoI     = 0;
   &nLCuoI      = 0;
   &nLCuoIN     = 0;
   &nLTipoR     = 0;
   &nLCuoR      = 0;
   &nLCuoRN     = 0;
   &nLBasP      = 0;
   &nLTipP      = 0;
   &nLCuoP      = 0;
   &enTBase     = 0;
   &enTCuoI     = 0;
   &enTCuoIN    = 0;
   &enTCuoR     = 0;
   &enTCuoRN    = 0;
   &enTCuoP     = 0;
   &enTTotal    = 0;
   &efFechaEmi  = @;
   &referencia  = "";

   &eaImpresora = "";
   &eaPortada   = "";
   &eaHora      = "";
   &eSwAgrupa   = 0;
   &enBasImp    = 0;
   &eaNomImp    = "";

   &enCab       = 0;
   &eaNomFic    = "";
   &eaAbre      = "";
|FIN;

|INCLUYE i_variar;
|INCLUYE i_varcon;
|INCLUYE i_varlib;
|INCLUYE i_caliva;
|INCLUYE dslegv_i;

|| //////////////////// Calculos de Pantalla \\\\\\\\\\\\\\\\\\\\\\\\\\
|CALCULO Eano; |TIPO 7;
 |SI nEstado ! 0;
     fLaFecha = ~;
     aAlfa1 = fLaFecha; aAlfa1 = aAlfa1 % -104;
     #dsmoy009#1  = aAlfa1; |PINTA #dsmoy009#1;
 |FINSI;
 #dsmoy009#52 = "LIBRO REGISTRO DE FACTURAS RECIBIDAS";
 |SI nSigFactu = 1;
     #dsmoy009#52 = "LIBRO REGISTRO DE FACTURAS RECTIFICATIVAS RECIBIDAS ";
     |ATRI R; |PINTA 0531,"Emision Libro Reg.Fras Rectificativas Recibidas"; |ATRI 0;
 |FINSI;
 |SI aNomModelo ! "";
     #dsmoy009#52 = aNomModelo;
 |FINSI;
 |PINTA #dsmoy009#52;
|FCAL;

|CALCULO losDefectos; |TIPO 0;
 aAlfa1 = #dsmoy009#1;
 aAlfa2 = #dsmoy009#41; aAlfa2 = aAlfa2 % -104;
 |SI aAlfa1 ! aAlfa2; |O nEstado ! 0;
     aAlfa2 = "31.12." + aAlfa1; #dsmoy009#42 = aAlfa2; |PINTA #dsmoy009#42;
 |FINSI;
 |SI enSwSelFc = 1; aAlfa2 = aAlfa1; |FINSI;
 |SI aAlfa1 ! aAlfa2; |O nEstado ! 0;
     aAlfa2 = "01.01." + aAlfa1; #dsmoy009#41 = aAlfa2; |PINTA #dsmoy009#41;
 |FINSI;
|FCAL;

|CALCULO Tipo7;  |TIPO 7;
     |SI enEmpresa ! 0;
         #dsmoy009#2  = enEmpresa;  |PINTA #dsmoy009#2;
         #dsmoy009#3  = enEmpresa;  |PINTA #dsmoy009#3;

         |C_M #dsmoy009#2, 1, "N";
         |C_M #dsmoy009#3, 1, "N";
     |FINSI;
|FCAL;

|CALCULO Parrilla; |TIPO 0;
     |SI #dsmoy009#2 = 0;
         #dsmoy009#2 = 0;  |PINTA #dsmoy009#2;
         #dsmoy009#3 = 0;  |PINTA #dsmoy009#3;  |C_M #dsmoy009#3, 1, "N";
         |PARA nCampo = 4;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #dsmoy009#nCampo#, 1, "S";
         |SIGUE;
     |SINO;
         |SI enEmpresa = 0;
             |C_M #dsmoy009#2, 1, "S";
             |C_M #dsmoy009#3, 1, "S";
         |FINSI;

         |PARA nCampo = 4;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #dsmoy009#nCampo#, 1, "N";
               #dsmoy009#nCampo# = 0;  |PINTA #dsmoy009#nCampo#;
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO NoMasEmpresas; |TIPO 0;
     |SI #dsmoy009#Campo# = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               #dsmoy009#nCampo# = 0;  |C_M #dsmoy009#nCampo#, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #dsmoy009#nCampo#, 1, "S";
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO YaSeCual; |TIPO 7;
 |SI enEmpresa ! 0;
     #dsmoy009#54 = "S";
     #dsmoy009#24 = "S"; |PINTA #dsmoy009#24;
     #dsmoy009#25 = 00;  |PINTA #dsmoy009#25;
     #dsmoy009#26 = 99;  |PINTA #dsmoy009#26;
     |C_M #dsmoy009#24, 1, "N";
     |C_M #dsmoy009#25, 1, "N";
     |C_M #dsmoy009#26, 1, "N";
     |C_M #dsmoy009#54, 1, "N";
 |FINSI;
|FCAL;

|CALCULO SelTipo0; |TIPO 0;
 |SI #dsmoy009#54 = "N";
     #dsmoy009#25 = 0;   |PINTA #dsmoy009#25;  |C_M #dsmoy009#25, 1, "N";
     #dsmoy009#26 = 99;  |PINTA #dsmoy009#26;  |C_M #dsmoy009#26, 1, "N";
     |PARA nCampo = 27;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           |C_M #dsmoy009#nCampo#, 1, "S";
     |SIGUE;
 |SINO;
     |SI enEmpresa = 0;
         |C_M #dsmoy009#25, 1, "S";
         |C_M #dsmoy009#26, 1, "S";
     |FINSI;
     |PARA nCampo = 27;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           |C_M #dsmoy009#nCampo#, 1, "N";
           #dsmoy009#nCampo# = 0;  |PINTA #dsmoy009#nCampo#;
     |SIGUE;
 |FINSI;
|FCAL;

|CALCULO SelTipo1;
 |SI #dsmoy009#Campo# = 0;
     |PARA nCampo = Campo + 1;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           #dsmoy009#nCampo# = 0;  |C_M #dsmoy009#nCampo#, 1, "N";
     |SIGUE;
 |SINO;
     |PARA nCampo = Campo + 1;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           |C_M #dsmoy009#nCampo#, 1, "S";
     |SIGUE;
 |FINSI;
|FCAL;

|CALCULO Cuadro; |TIPO 7;
   |PUSHV  0712 1770;
   |CUADRO 0712 1770;
   |ATRI R;
   |PINTA 0713, " ------------ FORMATO LIBRO FACTURAS ------------------- ";
   |PINTA 0813, " ( 1) Descr. Fra., Nombre y NIF, una linea s/recargo     ";
   |PINTA 0913, " ( 2) Descr. Fra., Nombre y NIF, varias lineas s/recargo ";
   |PINTA 1013, " ( 3) Descr. Fra., Nombre y NIF, una linea               ";
   |PINTA 1113, " ( 4) Descr. Fra., Nombre y NIF, varias lineas           ";
   |PINTA 1213, " ( 5) Nombre y NIF, varias lineas                        ";
   |PINTA 1313, " ( 6) Nombre y NIF, varias lineas con rayas              ";
   |PINTA 1413, " ( 7) Formato Oficial en Crystal Reports                 ";
   |PINTA 1513, " ( 8) Formato Oficial Crystal Reports agrupando Periodos ";
   |PINTA 1613, " ( 9) Formato Oficial en Excel                           ";
   |ATRI r;
|FCAL;

|CALCULO SalCuadro; |TIPO 0;
   |POPV;
   |C_M #dsmoy009#37, 1, "S";
   |C_M #dsmoy009#38, 1, "S";
   |C_M #dsmoy009#44, 1, "S";
   |C_M #dsmoy009#53, 1, "S";
   |C_M #dsmoy009#55, 1, "S";
   aAlfa = #dsmoy009#55;
   |C_M #dsmoy009#56, 1, aAlfa;
   |C_M #dsmoy009#57, 1, aAlfa;

   |SI #dsmoy009#43 = 6; |O #dsmoy009#43 = 7; |O #dsmoy009#43 = 8;
       #dsmoy009#53 = "N"; |C_M #dsmoy009#53,1,"N"; |PINTA #dsmoy009#53;
       |SI #dsmoy009#43 = 7; |O #dsmoy009#43 = 8;
           |C_M #dsmoy009#55, 1, "N"; #dsmoy009#55 = "N"; |PINTA #dsmoy009#55;
           |C_M #dsmoy009#56, 1, "N"; #dsmoy009#56 = 01;  |PINTA #dsmoy009#56;
           |C_M #dsmoy009#57, 1, "N"; #dsmoy009#57 = 99;  |PINTA #dsmoy009#57;
       |FINSI;
   |FINSI;
   |SI #dsmoy009#43 ! 7; |Y #dsmoy009#43 ! 8;
       #dsmoy009#59 = "N"; |PINTA #dsmoy009#59;
       |C_M #dsmoy009#59, 1, "N";
   |SINO;
       |C_M #dsmoy009#59, 1, "S";
   |FINSI;
   |SI #dsmoy009#43 = 3;
       |PINTA 2054, "Hora Informe.:   :  Ä";
       |C_V #dsmoy009#60,1,"S"; |C_M #dsmoy009#60,1,"S";
       |C_V #dsmoy009#61,1,"S"; |C_M #dsmoy009#61,1,"S";
       |HAZ  PonHora;
   |SINO;
       |PINTA 2054, "ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ";
       |C_V #dsmoy009#60,1,"N"; |C_M #dsmoy009#60,1,"N";
       |C_V #dsmoy009#61,1,"N"; |C_M #dsmoy009#61,1,"N";
   |FINSI;

   |SI #dsmoy009#43 = 9;
       |C_M #dsmoy009#37, 1, "N";
       |C_M #dsmoy009#38, 1, "N";
       #dsmoy009#37 = "N"; |PINTA #dsmoy009#37;
       #dsmoy009#38 = 0;   |PINTA #dsmoy009#38;
   |FINSI;
|FCAL;

|PROCESO PonHora; |TIPO 7;
     |C_M #dsmoy009#60, 0 , aAlfa1;
     |SI aHora = ""; |O aAlfa1 = "N";
         |HORA aHora;
         aAlfa = aHora % 102;  #dsmoy009#60 = aAlfa;
         aAlfa = aHora % 402;  #dsmoy009#61 = aAlfa;
     |FINSI;
     |PINTA #dsmoy009#60;
     |PINTA #dsmoy009#61;
|FPRC;

|CALCULO fecha; |TIPO 0;
 |C_M #dsmoy009#Campo#,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 aAlfa1 = #dsmoy009#1;
 aAlfa2 = "01.01." + aAlfa1;
 aAlfa3 = "31.12." + aAlfa1;
 |SI enSwSelFc = 1; aAlfa2 = "01.01.2000"; |FINSI;
 |SI #dsmoy009#Campo# < aAlfa2; |O #dsmoy009#Campo# > aAlfa3;
     |MENAV "    Error. Fecha Incorrecta ";
     |ERROR;
 |SINO;
     |SI Campo = 42; |Y #dsmoy009#41 > #dsmoy009#42;
         |MENAV "    Error. Fecha Incorrecta ";
         |ERROR;
     |FINSI;
 |FINSI;
|FCAL;

|CALCULO DesdePeriodo; |TIPO 0;

  |SI #dsmoy009#Campo# > 12; |Y #dsmoy009#Campo# ! 99;
      |ERROR;
      |ACABA;
  |FINSI;

  |SI #dsmoy009#62 = 99;
      aAlfa1 = "N";
      aAlfa2 = "S";
      #dsmoy009#63 = 99; |PINTA #dsmoy009#63;
  |SINO;
      aAlfa1 = #dsmoy009#1;
      |SI enSwSelFc = 0;
          aAlfa2 = "01.01." + aAlfa1;
      |SINO;
          aAlfa2 = "01.01.2000";
      |FINSI;
      #dsmoy009#41 = aAlfa2; |PINTA #dsmoy009#41;
      aAlfa3 = "31.12." + aAlfa1; #dsmoy009#42 = aAlfa3; |PINTA #dsmoy009#42;

      aAlfa1 = "S";
      aAlfa2 = "N";
      |SI #dsmoy009#63 = 99;
          #dsmoy009#63 = 12; |PINTA #dsmoy009#63;
      |FINSI;
  |FINSI;
  |C_M #dsmoy009#63,1,aAlfa1;
  |C_M #dsmoy009#41,1,aAlfa2;
  |C_M #dsmoy009#42,1,aAlfa2;
|FCAL;

|CALCULO HastaPeriodo; |TIPO 0;
  |C_M #dsmoy009#63, 0, aAlfa1;
  |SI aAlfa1 = "N"; |ACABA; |FINSI;

  |SI #dsmoy009#Campo# > 12;
      |ERROR;
      |ACABA;
  |FINSI;

  |SI #dsmoy009#62 > #dsmoy009#63;
      |ERROR;
  |FINSI;
|FCAL;

|CALCULO QueCalculo; |TIPO 0;
 |C_M #dsmoy009#51,1,"S";
 |SI #dsmoy009#Campo# = "N";
     |C_M #dsmoy009#51,1,"N";
     #dsmoy009#51 = 0; |PINTA #dsmoy009#51;
 |SINO;
     |C_M #dsmoy009#51,1,"S";
     #dsmoy009#51 = 1; |PINTA #dsmoy009#51;
 |FINSI;
|FCAL;

|CALCULO SelAct; |TIPO 0;
 aAlfa1 = #dsmoy009#Campo#;
 |C_M #dsmoy009#56,1, aAlfa1;
 |C_M #dsmoy009#57,1, aAlfa1;
|FCAL;

|| **********************************************************************************
|| **********************************************************************************
|| ....................... Situa la Empresa Contable
|PROCESO LEmpresaConta;

 enEmpresa  = #canempre#2;
 enPerConta = #canempre#3;;   || Periodo Contable

 |SI #dsmoy009#24 = "N"; |Y #canempre#21 = "I"; |ACABA; |FINSI;

|| ... Seleccion de Tipo de Empresa
  |ABRE #agifigen;
  #agifigen#0 = enEmpresa;
  |LEE 041#agifigen.=;
  |SI FSalida ! 0;
      |DDEFECTO #agifigen;
  |FINSI;
  |CIERRA #agifigen;
  nSPin1 = #agifigen#87;

  enSwSelEmp = 1;
  |SI #dsmoy009#54 = "S";
      |SI nSPin1 ] #dsmoy009#25; |Y nSPin1 [ #dsmoy009#26;
          enSwSelEmp = 0;
      |FINSI;
  |SINO;
      |SI nSPin1 = #dsmoy009#27;
          enSwSelEmp = 0;
      |SINO;
          |PARA nCampo = 27;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
                |SI nSPin1 = #dsmoy009#nCampo#; |Y nSPin1 ! 0;
                    enSwSelEmp = 0;
                   |SAL;
                |FINSI;
          |SIGUE;
      |FINSI;
  |FINSI;
  |SI enSwSelEmp = 1; |ACABA; |FINSI;
|| ------------------------------------------------------------------------
   aAlfa1 = enEmpresa;  aAlfa1 = ("00000" + aAlfa1) % -105;
   aAlfa2 = enPerConta; aAlfa2 = ("0" + aAlfa2) % -101;
   aPathConta  = aPath + "contagen/fich/" + aAlfa1 + aAlfa2 + "/";

   nGTempo = nGTempo + 1;
   #999#0 = nGTempo;       || Guia
   #999#1 = enEmpresa;     || Empresa
   #999#2 = enPerConta;    || Periodo Contable
   #999#3 = enEjer;        || A¤o
   #999#4 = #canempre#11;  || Desde Mes
   #999#5 = #canempre#13;  || N§ Digitos
   #999#6 = #canempre#14;  || Digitos Nivel 1
   #999#7 = #canempre#15;  || Digitos Nivel 2
   #999#8 = #canempre#16;  || Digitos Nivel 3
   #999#9 = #canempre#17;  || Digitos Nivel 4
   #999#10 = #canempre#18; || Digitos Nivel 5
   #999#11 = #canempre#19; || Digitos Nivel 6
   eaEstadoEmp = "S"; |SI #canempre#21 = "I"; eaEstadoEmp = "N"; |FINSI;
   #999#12 = eaEstadoEmp;  || Estado
   #999#13 = #canempre#28; || Moneda
   #999#14 = #canempre#1;  || Nombre Empresa
   #999#15 = aPathConta;   || Path
   #999#16 = #dsmoy009#48;        || Emitir
   |GRABA 020#999n;

   |SI #dsmoy009#50 = "S";
       nDActividad = 0;
       nHActividad = 0;
       |SI #dsmoy009#55 = "S"; |Y enPorCsv = 0;
           nDActividad = #dsmoy009#56;
           nHActividad = #dsmoy009#57;
       |FINSI;
       |PARA nPara2 = nDActividad; |SI nPara2 [ nHActividad; |HACIENDO nPara2 = nPara2 + 1;
             #998#0  = enEmpresa;
             #998#11 = #dsmoy009#49;
             #998#41 = nPara2;
             |LEE 101#998=;
             |SI FSalida = 0;
                 enActividad = nPara2;
                 |HAZ  LeeDatosActividad;
                 |SI swNoExis = 0;
                     #998#2 = "S";
                     |SI #dsmoy009#51 ! 0; #998#1 = #dsmoy009#51; |FINSI;
                     #998#42 = 1;
                     |GRABA 020#998a;
                 |SINO;
                     |BORRA 020#998a;
                 |FINSI;
             |FINSI;
       |SIGUE;
   |FINSI;
|FPRC;

|DEFBUCLE canempre;
 #300#4;
 ;
 nDEmpresa, nEjercicio;
 nHEmpresa, nEjercicio;
 ;
 NULL, LEmpresaConta;
|FIN;
||///////////////////////////////////////////////////////////////////
|CALCULO Datos7; |TIPO 7;
 |MENSA "    <F2> Modificar Datos de Acumulados Emision, <F3> Cambiar Emitir Libro S/N";
|FCAL;

|PROCESO ModiAcumulados;
     enEmpresa = #999#1;
     |HAZ  LeeDatosActividad;
     |SI swNoExis = 0;
         #998#0  = #999#1;       || Empresa
         #998#11 = #dsmoy009#49; || Modelo
         #998#41 = enActividad;  || Actividad
         |LEE 000#998=;
         |SI FSalida ! 0;
             |DDEFECTO #998;
             #998#0  = #999#1;
             #998#11 = #dsmoy009#49;
             #998#41 = enActividad;
             #998#2  = #dsmoy009#50;
             |SI #dsmoy009#51 ! 0; #998#1 = #dsmoy009#51; |FINSI;
             #998#42 = 1;
             |GRABA 020#998b;
         |SINO;
             |SI #998#42 = 0; #998#42 = #998#10; |FINSI;
             |SI #998#42 = 0; #998#42 = 1; |FINSI;
         |FINSI;

         |C_V #998#41,1,"N";

         |PUSHV 0506 2375;

         |PINPA #0#998;
         |PINTA 0625, #999#14;

         |SI enActividad ! 0;
             |PINTA 0707, "³                                                              ³";
             |ATRI I; |PINTA 0709, "ACTIVIDAD .:"; |ATRI 0;
             |C_V #998#41,1,"S";
             |PINTA 0725, #114#4;
         |FINSI;

         |SI #dsmoy009#43 ] 7;
             |PINTA 0841, "                            ";
             |PINTA 1141, "                            ";
             |C_V #998#3,  1, "N"; #998#3  = "*";
             |C_V #998#4,  1, "N"; #998#4  = 0;
             |C_V #998#10, 1, "N"; #998#10 = 1;
         |FINSI;

         |PINDA #0#998;
         |ENDATOS #1#998;
         |SI FSalida = 0;
             |GRABA 020#998a;
             |LIBERA #998;
         |FINSI;
         |POPV;
     |FINSI;
|FPRC;

|CALCULO DatosManip; |TIPO 11;
   nInkey = FSalida;
   |BLIN 04;

   |SI nInkey = 10; |Y #999#16 = "S";
       |SI #dsmoy009#55 = "N"; |O enPorCsv = 1;
           enActividad = 00;
           |HAZ ModiAcumulados;
        |SINO;
           |PARA nPara2 = #dsmoy009#56; |SI nPara2 [ #dsmoy009#57; |HACIENDO nPara2 = nPara2 + 1;
              ||   |MENAV "    NO SE PUEDE MODIFICAR. SELECCION POR ACTIVIDADES";
              enActividad = nPara2;
              |HAZ ModiAcumulados;
           |SIGUE;
        |FINSI;
   |FINSI;

   |SI nInkey = 11;
       |SI #999#16 = "S";
           #999#16 = "N";
       |SINO;
           #999#16 = "S";
       |FINSI;
       |GRABA 020#999a;
   |FINSI;
|FCAL;

|RUTINA inferior;
   #999#0 = 00001;
|FRUT;

|RUTINA superior;
   #999#0 = 99999;
|FRUT;

||///////////////////////////////////////////////////////////////////
|CALCULO Tipo3;  |TIPO 3;

|| ... Solo archivamos si es el Libro 902 y el Hasta Periodo es ! 00.
    enArchi = 0;
    |SI aParam = ""; |Y #dsmoy009#49 = "902";
      |Y #dsmoy009#43 ] 7; |Y #dsmoy009#43 [ 8; |Y #dsmoy009#63 ! 0;
          eaVengoDe = "dsmoy009";
          |HAZ MiraSiArchiva;
    |FINSI;

    nOpcion = 1;
    |SI enArchi = 1;
        |MENU aMenu;
        nOpcion = FSalida;
        |SI nOpcion < 0;
            |ACABA;
        |FINSI;
    |FINSI;

    efFechaEmi  = #dsmoy009#45;
    #dsmoy009#0  = "S";      ||Soportado
    |SI nSigFactu = 1; #dsmoy009#0 = "s"; |FINSI;

    #dsmoy009#49 = enModelo; ||Libro Oficial
    referencia = #dsmoy009#58;

    enEjer = #dsmoy009#1;
    aAlfa1 = enEjer; |QBF aAlfa1;
    aAlfa1 = aAlfa1 % -102;
    nEjercicio = aAlfa1;
    |DBASS aPath; |QBT aPath;

    aFichero = ("3d" + Usuario) % 108;
    |NOME_DAT #957 aFichero;

    aFichero = ("2w" + Usuario) % 108;
    |NOME_DAT #901 aFichero;

    aFichero = ("5w" + Usuario) % 108;
    |NOME_DAT #999 aFichero;
    |DELINDEX #999;
    eaFEmpresa = aFichero;

    enPorCsv = 0;
    |SI #dsmoy009#43 = 9;
        enPorCsv = 1;
    |FINSI;

    |ABRE #998;
    |ABRE #999;
    nGTempo = 0;   ||Busco Empresas Contables
    |SI #dsmoy009#2 ! 0;
        nDEmpresa = #dsmoy009#2;
        nHEmpresa = #dsmoy009#3;
        |BUCLE canempre;
    |SINO;
        |PARA nPara3 = 4;  |SI nPara3 [ 23;  |HACIENDO nPara3 = nPara3 + 1;
              nDEmpresa = #dsmoy009#nPara3#;
              nHEmpresa = #dsmoy009#nPara3#;
              |BUCLE canempre;
        |SIGUE;
    |FINSI;
    |CIERRA #998;
    |CIERRA #999;

    |SI nGTempo = 0;    || No existe ninguna empresa
        |SI aParam = "";
            |MENAV "    Error. No existe ninguna Empresa Contable dentro de la Seleccion ";
        |FINSI;
        |DELINDEX #999;
        |ACABA;
    |FINSI;

    |SI aParam = "";
        |PUSHV 0509 2375;
        |ABRE #998;
        |ENTLINEAL #1#999, -1, 5, 22, 1, inferior, superior;
        |CIERRA #998;
        |POPV;
    |FINSI;

    aDTipo = "R"; aHTipo = "S";
    |SI enSwSelCp = 0;
        aDTipo = #dsmoy009#0; aDTipo = aDTipo > " ";
        aHTipo = #dsmoy009#0; aHTipo = aHTipo > " ";
    |FINSI;


    nSegurOp = nOpcion;
    |SI nSegurOp = 1; |HAZ Imprimir; |FINSI;
    |SI nSegurOp = 2; |HAZ Archivar; |FINSI;
    |SI nSegurOp = 3; |HAZ Imprimir; |FINSI;
    |SI nSegurOp = 3; |HAZ Archivar; |FINSI;

    |DELINDEX #957;
    |DELINDEX #901;
    |DELINDEX #999;
|FCAL;

|| *************************************************************************
|PROCESO CargaVar;
     NumMes = #dsmoy009#63;
     eaObservacion1 = "";
     eaObservacion2 = "LIQUIDADAS";
     |SI #dsmoy009#63 = 99;
         eaObservacion2 = "";
         aAlfa1 = #dsmoy009#42;
         aAlfa1 = aAlfa1 % 402;
         NumMes   = aAlfa1;
     |FINSI;
     |SI #dsmoy009#62 = 0; eaObservacion2 = ""; |FINSI;
     |HAZ NombreMes;
     eaObservacion1 = "Facturas recibidas al mes " + NombreMes;
     eaObservacion1 = eaObservacion1 > " ";

     eaNombreEmp = #dsmow030#2;
     eaNifEmp    = #dsmow030#1;
     enEjercicio = #dsmow030#12;
     enM2        = NumMes;
|FPRC;
|| *************************************************************************
|PROCESO LasReten;
 |SI enActividad ! 0;
     nElDepar = #304#10;
     |SI nElDepar = 0;
         nElDepar = 1;
     |FINSI;
     |SI enActividad ! nElDepar; |ACABA; |FINSI;
 |FINSI;
 |SI #camaniva#20 ! 0;
     eSwReten = 1;
     |ERROR10;
 |FINSI;
|FPRC;

|DEFBUCLE LasReten;
 #camaniva#1;
 36;
 #dsmoy009#39,0000000001, aDTipo;
 #dsmoy009#40,9999999999, aHTipo;
 ;
 NULL,LasReten;
|FIN;

|| *************************************************************************
|PROCESO Auxiliar57;

 |SI nOperacion = 0;
     nCampo = nCampo + 1;
 |FINSI;

 |SI nOperacion = 1;
     nLBase  = #957#1;
     nLTipoI = #957#2;
     nLCuoI  = #957#3;
     nLTipoR = #957#4;
     nLCuoR  = #957#5;
     nLCuoIN = #957#6;
     nLCuoRN = #957#7;
     |SI nLCuoI = 0; |Y nLCuoIN = 0; nLTipoI = 0; |FINSI;
     |SI nLCuoR = 0; |Y nLCuoRN = 0; nLTipoR = 0; |FINSI;
     |SI nLBase ! 0; |O nLCuoI ! 0; |O nLCuoR ! 0; |O nLCuoIN ! 0; |O nLCuoRN ! 0;
         |SI enPorCsv = 0;
             |PRINT;
         |SINO;
             |HAZ GrabaCsv_IVA;
         |FINSI;
         SwLinea = 1;
     |FINSI;
 |FINSI;
|FPRC;

|DEFBUCLE Auxiliar57;
  #957#1;
  ;
  nPara1,  000,  000;
  nPara1, 1000, 1000;
  ;
  NULL, Auxiliar57;
|FIN;

|PROCESO VariasLineas;
 SwLinea = 0;
 nLBasP = #900#66;
 nLTipP = #900#67;
 nLCuoP = #900#68;
 |PARA nPara1 = 23; |SI nPara1 [ 27; |HACIENDO nPara1 = nPara1 + 1;
       nCampo = 0;
       nOperacion = 0; |BUCLE Auxiliar57;
       |SI nCampo [ 1;
           nLBase = #900nPara1;
           nNume1 = nPara1 +  6; nLTipoI = #900nNume1;
           nNume2 = nPara1 + 11; nLCuoI  = #900nNume2;
           nNume3 = nPara1 + 17; nLTipoR = #900nNume3;
           nNume4 = nPara1 + 22; nLCuoR  = #900nNume4;
           nNume5 = nPara1 + 29; nLCuoIN = #900nNume5;
           nNume6 = nPara1 + 35; nLCuoRN = #900nNume6;
           |SI nLCuoI = 0; |Y nLCuoIN = 0; nLTipoI = 0; |FINSI;
           |SI nLCuoR = 0; |Y nLCuoRN = 0; nLTipoR = 0; |FINSI;
           |SI nLBase ! 0; |O nLCuoI ! 0; |O nLCuoR ! 0; |O nLCuoIN ! 0; |O nLCuoRN ! 0;
               |SI enPorCsv = 0;
                   |PRINT;
               |SINO;
                   |HAZ GrabaCsv_IVA;
               |FINSI;
               SwLinea = 1;
           |FINSI;
       |SINO;
           nOperacion = 1; |BUCLE Auxiliar57;
       |FINSI;
 |SIGUE;
 |SI SwLinea = 0;
     |SI enPorCsv = 0;
         |PRINT;
     |SINO;
         |HAZ GrabaCsv_IVA;
     |FINSI;
 |FINSI;
|FPRC;

|PROCESO LinLibro0;

  aAlfa1 = #caivalin#30; |QBF aAlfa1; |SI aAlfa1 = ""; #caivalin#30 = #camaniva#10; |FINSI;
  |SI enActividad ! 0;      ||quiere separar por actividades
      |SI aMulDep = "S";
          nElDepar = #caivalin#30;
          |SI nElDepar = 0;  nElDepar = 1;  |FINSI;
          |SI enActividad ! nElDepar; nAlNo = 1; |ACABA; |FINSI;
      |FINSI;
  |FINSI;

  |SI enPorCsv = 1; |Y #dsmoy009#55 = "S";
      |SI aMulDep = "S";
          nElDepar = #caivalin#30;
          |SI nElDepar = 0;  nElDepar = 1; |FINSI;
          |SI nElDepar [ #dsmoy009#56; |O nElDepar ] #dsmoy009#57; nAlNo = 1; |ACABA; |FINSI;
      |FINSI;
  |FINSI;

  nAlSi = 1;
  |SI nOpMdep = 0;  |ACABA;  |FINSI;  || Solo comprueba que exista

  enConcepto = #caivalin#3;
  |SI enSwSelCp = 1;
      |HAZ CtrlConcepto;
      |SI enSwConcep = 1;
          |ACABA;
      |FINSI;
  |FINSI;

  nAlConcepto = 1;
  |SI nOpMdep = 2;  |ACABA;  |FINSI;  || Solo comprueba que exista

 #caivalin#6  = (#caivalin#6  / enConversor) ! EURODBMOD;
 #caivalin#8  = (#caivalin#8  / enConversor) ! EURODBMOD;
 #caivalin#10 = (#caivalin#10 / enConversor) ! EURODBMOD;
 #caivalin#20 = (#caivalin#20 / enConversor) ! EURODBMOD;
 #caivalin#22 = (#caivalin#22 / enConversor) ! EURODBMOD;

 nCampo = -1;
 |SI #caivalin#7 = 0;               ||  0%
     #900#27 = #900#27 + #caivalin#6;
     #900#28 = #900#28 + #caivalin#6;
 |SINO;
     #900#28 = #900#28 + #caivalin#6;
     |SI #caivalin#5 = "S";
          #900#39 = #900#39 + #caivalin#8;
          |SI #caivalin#7 = 4;         ||  4%
              #900#23 = #900#23 + #caivalin#6;
              #900#29= #caivalin#7;
              #900#34 = #900#34 + #caivalin#8;
              nCampo = 23;
          |SINO;
              |SI #caivalin#7 = 7; |O #caivalin#7 = 8; |O #caivalin#7 = 10;  ||  7% y 8% 10%
                  #900#24 = #900#24 + #caivalin#6;
                  #900#30 = #caivalin#7;
                  #900#35 = #900#35 + #caivalin#8;
                  nCampo = 24;
              |SINO;
                  |SI #caivalin#7 = 16;  |O #caivalin#7 = 18;  |O #caivalin#7 = 21;    || 16% 18 % 21%
                      #900#25 = #900#25 + #caivalin#6;
                      #900#31 = #caivalin#7;
                      #900#36 = #900#36 + #caivalin#8;
                      nCampo = 25;
                  |SINO;
                      #900#26 = #900#26 + #caivalin#6;   || ??%
                      #900#32 = #caivalin#7;
                      #900#37 = #900#37 + #caivalin#8;
                      nCampo = 26;
                  |FINSI;
              |FINSI;
          |FINSI;
      |SINO;                                    ||NO DEDUCIBLE
          #900#57 = #900#57 + #caivalin#8;
          |SI #caivalin#7 = 4;         ||  4%
              #900#23 = #900#23 + #caivalin#6;
              #900#29 = #caivalin#7;
              #900#52 = #900#52 + #caivalin#8;
              nCampo = 23;

          |SINO;
              |SI #caivalin#7 = 7; |O #caivalin#7 = 8; |O #caivalin#7 = 10;       ||  7% 8% 10%
                  #900#24 = #900#24 + #caivalin#6;
                  #900#30 = #caivalin#7;
                  #900#53 = #900#53 + #caivalin#8;
                  nCampo = 24;
              |SINO;
                  |SI #caivalin#7 = 16; |O #caivalin#7 = 18; |O #caivalin#7 = 21;   || 16% 18% 21%
                      #900#25 = #900#25 + #caivalin#6;
                      #900#31 = #caivalin#7;
                      #900#54 = #900#54 + #caivalin#8;
                      nCampo = 25;
                  |SINO;
                      #900#26 = #900#26 + #caivalin#6;   || ??%
                      #900#32 = #caivalin#7;
                      #900#55 = #900#55 + #caivalin#8;
                      nCampo = 26;
                  |FINSI;
              |FINSI;
          |FINSI;
     |FINSI;
  |FINSI;

  |SI #caivalin#9 ! 0; |Y #caivalin#5 = "S";
      #900#50 = #900#50 + #caivalin#10;
      |SI #caivalin#9 = 0.5;        || 0.5%
          #900#40 = #caivalin#9;
          #900#45 = #900#45 + #caivalin#10;
      |SINO;
          |SI #caivalin#9 = 1; |O #caivalin#9 = 1.40;   || 1%
              #900#41 = #caivalin#9;
              #900#46 = #900#46 + #caivalin#10;
         |SINO;
              |SI #caivalin#9 = 4; |O #caivalin#9 = 5.20; || 4
                  #900#42 = #caivalin#9;
                  #900#47 = #900#47 + #caivalin#10;
             |SINO;
                 #900#43 = #caivalin#9;
                 #900#48 = #900#48 + #caivalin#10; || %
             |FINSI;
         |FINSI;
     |FINSI;
 |FINSI;

 |SI #caivalin#9 ! 0; |Y #caivalin#5 = "N";
     #900#63 = #900#63 + #caivalin#10;
     |SI #caivalin#9 = 0.5;        || 0.5%
         #900#40 = #caivalin#9;
         #900#58 = #900#58 + #caivalin#10;
     |SINO;
         |SI #caivalin#9 = 1; |O #caivalin#9 = 1.40;   || 1.5%
             #900#41 = #caivalin#9;
             #900#59 = #900#59 + #caivalin#10;
         |SINO;
             |SI #caivalin#9 = 4; |O #caivalin#9 = 5.20; || 1%
                 #900#42 = #caivalin#9;
                 #900#60 = #900#60 + #caivalin#10;
             |SINO;
                 #900#43 = #caivalin#9;
                 #900#61 = #900#61 + #caivalin#10; || %
             |FINSI;
         |FINSI;
     |FINSI;
 |FINSI;

 |SI #dsmoy009#53 = "S";
     #900#51 = #900#51 + #caivalin#6 + #caivalin#8 + #caivalin#10 - #caivalin#22;
 |SINO;
     #900#51 = #900#51 + #caivalin#6 + #caivalin#8 + #caivalin#10;
 |FINSI;

 #900#66 = #900#66 + #caivalin#20;
 #900#67 = #caivalin#21;
 #900#68 = #900#68 + #caivalin#22;

|| ... Graba Detalle %
 |SI #dsmoy009#43 ! 1; |Y #dsmoy009#43 ! 3;
     |SI nCampo ! -1;
         |ABRE #957;
         #957#0 = nCampo;
         #957#2 = #caivalin#7;
         #957#4 = #caivalin#9;
         |LEE 041#957=;
         |SI FSalida ! 0;
             |DDEFECTO #957;
             #957#0 = nCampo;
             #957#2 = #caivalin#7;
             #957#4 = #caivalin#9;
             |GRABA 020#957c;
         |FINSI;
         #957#1  = #957#1 + #caivalin#6;
         #957#2  = #caivalin#7;
         #957#4  = #caivalin#9;
         |SI #caivalin#5 = "S";
             #957#3  = #957#3 + #caivalin#8;
             #957#5  = #957#5 + #caivalin#10;
         |SINO;
             #957#6  = #957#6 + #caivalin#8;
             #957#7  = #957#7 + #caivalin#10;
         |FINSI;
         |GRABA 020#957a;
         |CIERRA #957;
     |FINSI;
 |FINSI;

|| ... Graba Resumen 1 por Conceptos
 #901#0 = #caivalin#3;
 #901#5 = "";
 |LEE 101#901=;
 |SI FSalida ! 0;
     |DDEFECTO #901;
     #901#0 = #caivalin#3;
     #901#5 = "";
     |GRABA 020#901b;
 |FINSI;
 #901#1 = #901#1 + #caivalin#6;
 #901#2 = #901#2 + #caivalin#8;
 #901#3 = #901#3 + #caivalin#10;
 #901#4 = #901#4 + (#caivalin#6 + #caivalin#8 + #caivalin#10);
 |GRABA 020#901a;
 |LIBERA #901;

|| ... Graba Resumen 2 por % de IVA
 |SI #dsmoy009#38 ] 2; |HAZ sLiqIVA; |FINSI;

|FPRC;

|DEFBUCLE LinLibro;
 #caivalin#1;
 ;
 #camaniva#0,#camaniva#1,001;
 #camaniva#0,#camaniva#1,999;
 ;
 NULL, LinLibro0;
|FIN;

|PROCESO Facturas;
   |SI enPorCsv = 1; |Y #dsmoy009#55 = "S";
       |SI aMulDep ! "S";
           nElDepar = #304#10;
           |SI nElDepar = 0;  nElDepar = 1;  |FINSI;
           |SI nElDepar [ #dsmoy009#56; |O nElDepar ] #dsmoy009#57; |ACABA; |FINSI;
       |SINO;
           nOpMdep = 0;
           nAlSi   = 0;
           nAlNo   = 0;
           |BUCLE LinLibro;
           |SI nAlSi = 0; |ACABA; |FINSI;
       |FINSI;
   |FINSI;

   |SI enActividad ! 0;      ||quiere separar por actividades
       |SI aMulDep ! "S";
           nElDepar = #304#10;
           |SI nElDepar = 0;
               nElDepar = 1;
           |FINSI;
           |SI enActividad ! nElDepar; |ACABA; |FINSI;
       |SINO;
            nOpMdep = 0;
            nAlSi   = 0;
            nAlNo   = 0;
            |BUCLE LinLibro;
            |SI nAlSi = 0; |ACABA; |FINSI;
       |FINSI;
   |FINSI;

|| ................ Comprueba que los conceptos de facturas son buenos
   |SI enSwSelCp = 1;
        nOpMdep     = 2;
        nAlConcepto = 0;
        |BUCLE LinLibro;
        |SI nAlConcepto = 0; |ACABA; |FINSI;
   |FINSI;

   nOpMdep = 1;
   |PDEFECTO #900, 16, 64;
   #900#66 = 0; #900#67 = 0; #900#68 = 0;
   |SI enActividad = 0; |Y #dsmoy009#43 ] 7;
       #900#69 = #304#10;
   |FINSI;
   #900#79 = "01.01.0000";
   #900#81 = "01.01.0000";
   #900#82 = "";
   #900#83 = 0;
   #900#84 = 0;
   #900#65 = "";
   #900#87 = 0;
   #900#88 = 0;
   |DELINDEX #957;

   |SI nSigFactu = 1;
       |SI #camaniva#21 ] 0;
           |ACABA;
       |FINSI;
   |FINSI;

   aAlfa1 = #998#3; |QBF aAlfa1;
   |SI aAlfa1 = "*"; |O #dsmoy009#43 ] 7;
       #900#16 = #camaniva#2;
   |SINO;
       #900#16 = #998#3;
   |FINSI;
   |SI #998#4 = 0; |O #dsmoy009#43 ] 7;
       #900#17    = #camaniva#3;
   |SINO;
       #900#17    = nFactura;
   |FINSI;
   |SI nFactura = 0; nFactura = 1; |FINSI;
   #900#84 = #998#42;    ||  nFactura  ||Contador de facturas.
   #998#42 = #998#42 + 1;

   fLaFecha = #camaniva#4; |SI #dsmoy009#44 = 2; fLaFecha = #camaniva#8; |FINSI;
   aAlfa1   = fLaFecha; aAlfa1   = aAlfa1 % 105;
   #900#18  = aAlfa1;
   #900#79  = fLaFecha;
   |SI #camaniva#41 > "01.01.0000";
       #900#81  = #camaniva#41;
       aAlfa1   = #900#81; aAlfa1   = aAlfa1 % 105;
       #900#82  = aAlfa1;
   |FINSI;

   #900#19  = #camaniva#12;
   #900#20  = #camaniva#13;
   #900#21  = #camaniva#14;
   eaCodNif = #camaniva#14;  ||El Dni
   |HAZ LeeNifs;
   |SI #709#12 ! "ES "; #900#65 =  #709#12; |FINSI;

   #900#22  = #camaniva#28;
   |SI #dsmoy009#58 = "S";
       #900#22 = #camaniva#22;
   |FINSI;

   #900#87 = #camaniva#5;
   #900#88 = #camaniva#40;

   |BUCLE LinLibro;

   |SI #dsmoy009#62 = 99;   ||Seleccion por fechas
       |SI fLaFecha ] #dsmoy009#41;
           |HAZ VariablesSuma;
           |SI #dsmoy009#43 = 2; |O #dsmoy009#43 ] 4;
               |HAZ VariasLineas;
           |SINO;
               |PRINT;
           |FINSI;
           SwHayDatos = 1;
           SwPrim     = 1;
       |FINSI;
   |SINO;
       |SI #900#88 ] #dsmoy009#62;   || Seleccion por Periodo
           |HAZ VariablesSuma;
           |SI #dsmoy009#43 = 2; |O #dsmoy009#43 ] 4;
               |HAZ VariasLineas;
           |SINO;
               |PRINT;
           |FINSI;
           SwHayDatos = 1;
           SwPrim     = 1;
       |FINSI;
   |FINSI;

   nFactura = nFactura + 1;

|| .... Suma Parciales
   #998#12 = #998#12 + #900#23;  ||base imponible
   #998#13 = #998#13 + #900#24;
   #998#14 = #998#14 + #900#25;
   #998#15 = #998#15 + #900#26;
   #998#16 = #998#16 + #900#27;
   #998#5  = #998#5  + #900#28;

   #998#17 = #998#17 + #900#34;  ||IVA
   #998#18 = #998#18 + #900#35;
   #998#19 = #998#19 + #900#36;
   #998#20 = #998#20 + #900#37;
   #998#21 = #998#21 + #900#38;
   #998#6  = #998#6  + #900#39;

   #998#22 = #998#22 + #900#45;  ||Recargo
   #998#23 = #998#23 + #900#46;
   #998#24 = #998#24 + #900#47;
   #998#25 = #998#25 + #900#48;
   #998#26 = #998#26 + #900#49;
   #998#7  = #998#7  + #900#50;

   #998#39 = #998#39 + #900#66;   || Retencion
   #998#40 = #998#40 + #900#68;

   #998#8  = #998#8  + #900#51;

   #998#29 = #998#29 + #900#52;  ||IVA No deducibles
   #998#30 = #998#30 + #900#53;
   #998#31 = #998#31 + #900#54;
   #998#32 = #998#32 + #900#55;
   #998#33 = #998#33 + #900#56;
   #998#27 = #998#27 + #900#57;

   #998#34 = #998#34 + #900#58;  ||Recargo No Deducibles
   #998#35 = #998#35 + #900#59;
   #998#36 = #998#36 + #900#60;
   #998#37 = #998#37 + #900#61;
   #998#38 = #998#38 + #900#62;
   #998#28 = #998#28 + #900#63;
|FPRC;

|DEFBUCLE Facturas1;
 #camaniva#5;
 36,40;
 fDFecha, #dsmoy009#39, 0000000001, aDTipo, nDLiqui;
 fHFecha, #dsmoy009#40, 9999999999, aHTipo, nHLiqui;
 ;
 NULL, Facturas;
|FIN;

|DEFBUCLE Facturas2;
 #camaniva#1;
 8,36,40;
 #dsmoy009#39,0000000001, fDFecha, aDTipo, nDLiqui;
 #dsmoy009#40,9999999999, fHFecha, aHTipo, nHLiqui;
 ;
 NULL,NULL,NULL,NULL,NULL,Facturas;
 #camaniva#8, #camaniva#0, #camaniva#1;
|FIN;

|DEFBUCLE Facturas3;
 #camaniva#3;
 4,36,40;
 #dsmoy009#39,"     ", 000001, fDFecha, aDTipo, nDLiqui;
 #dsmoy009#40,"zzzzz", 999999, fHFecha, aHTipo, nHLiqui;
 ;
 NULL, Facturas;
|FIN;

|DEFBUCLE Facturas1_P;
 #camaniva#5;
 36,40;
 fDFecha, #dsmoy009#39, 0000000001, aDTipo, nDLiqui;
 fHFecha, #dsmoy009#40, 9999999999, aHTipo, nHLiqui;
 ;
 NULL, NULL, NULL, NULL, NULL, Facturas;
 #camaniva#40, #camaniva#4, #camaniva#0, #camaniva#1;
|FIN;

|DEFBUCLE Facturas2_P;
 #camaniva#1;
 8,36,40;
 #dsmoy009#39,0000000001, fDFecha, aDTipo, nDLiqui;
 #dsmoy009#40,9999999999, fHFecha, aHTipo, nHLiqui;
 ;
 NULL,NULL,NULL,NULL,NULL,Facturas;
 #camaniva#40,#camaniva#8, #camaniva#0, #camaniva#1;
|FIN;

|DEFBUCLE Facturas3_P;
 #camaniva#3;
 4,36,40;
 #dsmoy009#39, "     ", 000001, fDFecha, aDTipo, nDLiqui;
 #dsmoy009#40, "zzzzz", 999999, fHFecha, aHTipo, nHLiqui;
 ;
 NULL,NULL,NULL,NULL,NULL,Facturas;
 #camaniva#40, #camaniva#0, #camaniva#2, #camaniva#3;
|FIN;

|PROCESO VariablesSuma;

   eaTexPie = "Subtotal acumulado anterior";
   enTBase  = #dsmow049#5;
   enTCuoI  = #dsmow049#6;
   enTCuoIN = #dsmow049#27;
   enTCuoR  = #dsmow049#7;
   enTCuoRN = #dsmow049#28;
   enTCuoP  = #dsmow049#40;
   enTTotal = #dsmow049#8;
|FPRC;

|PROCESO FinDocCsv;
   eaTexPie = "Total Libro";
   enTBase  = #dsmow049#5;
   enTCuoI  = #dsmow049#6;
   enTCuoIN = #dsmow049#27;
   enTCuoR  = #dsmow049#7;
   enTCuoRN = #dsmow049#28;
   enTCuoP  = #dsmow049#40;
   enTTotal = #dsmow049#8;

   |SI SwHayDatos = 1;
       |HAZ GrabaCsv_IVAPie;
   |FINSI;
   |HAZ PresentaDocCsv;
|FPRC;

|PROCESO Emision;
   enSwPartido = 0;
   enEmpresa  = #999#1;
   enPerConta = #999#2;
   eaLaMonEmp = #999#13;
   |HAZ EnConversor;
   enEjer     = #999#3;   || A¤o
   dig1       = #999#4;   || Desde Mes
   dig3       = #999#5;   || N§ Digitos
   dig4       = #999#6;   || Digitos Nivel 1
   dig5       = #999#7;   || Digitos Nivel 2
   dig6       = #999#8;   || Digitos Nivel 3
   dig7       = #999#9;   || Digitos Nivel 4
   dig8       = #999#10;  || Digitos Nivel 5
   dig9       = #999#11;  || Digitos Nivel 6
   eaEstadoEmp = #999#12; || Estado
   eaNombreEmp = #999#14; || Nombre Empresa

   |SI #999#4 ! 1;
        enSwOpPar   = 0;
        |HAZ SituaEmpresa;
        enPerConta = enPeriodoPar;
        #999#15 = aPathConta;
   |FINSI;

   aPathConta  = #999#15; |QBF aPathConta; || Path
   || Recoger informacion sobre los niveles ...
   |SI dig3 = 1; MaximoDigitos = dig4; |FINSI;
   |SI dig3 = 2; MaximoDigitos = dig5; |FINSI;
   |SI dig3 = 3; MaximoDigitos = dig6; |FINSI;
   |SI dig3 = 4; MaximoDigitos = dig7; |FINSI;
   |SI dig3 = 5; MaximoDigitos = dig8; |FINSI;
   |SI dig3 = 6; MaximoDigitos = dig9; |FINSI;

   eaTituloL = #dsmoy009#52; ||Titulo del Libro

   |SI enPorCsv = 0;
       eaPortada = "N";
       aAlfa0 = Impresora % 113;
       |SI #dsmoy009#37 = "S"; |O aAlfa0 = "CrystalReport";
           eaImpresora = Impresora;
           |SI aAlfa0 = "CrystalReport"; eaImpresora = aAlfa0; |FINSI;
           |SUB_EJECUTA_NP ":basica/agiy0016";
           eaImpresora = "";
           |SI aAlfa0 = "CrystalReport"; |HAZ PortadaCrystal; |FINSI;
           eaPortada = #dsmoy009#37;
       |FINSI;
   |FINSI;

   |PATH_DAT #301 aPathConta;
   |PATH_DAT #304 aPathConta;
   |PATH_DAT #305 aPathConta;
   |PATH_DAT #306 aPathConta;
   |ABRE #caivaasi;
   |DDEFECTO #caivaasi;
   |LEE 000#caivaasi.p;
   |CIERRA #caivaasi;
   aMulDep = #caivaasi#132;

   |DDEFECTO #306;  ||Configuracion de Informes
   |ABRE #306;
   #306#0 = 1;
   |LEE 000#306=;
   |CIERRA #306;

   eaHora = (("00" + #dsmoy009#60) % -102) + ":" + (("00" + #dsmoy009#61) % -102):
   eaHora = "Hora: " + eaHora;
   |SI aParam ! ""; #306#4 = "N"; #306#18 = "N"; |FINSI;
   |SI #306#18 = "N"; eaHora = ""; |FINSI;

   enResumen = 0;
   nDActividad = 0;
   nHActividad = 0;
   |SI #dsmoy009#55 = "S"; |Y enPorCsv = 0;
       nDActividad = #dsmoy009#56;
       nHActividad = #dsmoy009#57;
   |FINSI;

   |PARA enActividad = nDActividad; |SI enActividad [ nHActividad; |HACIENDO enActividad = enActividad + 1;

         |HAZ LeeDatosEmpresa;
         |SI  swNoExis = 0;       ||SI existe esta Actividad.
             #998#0  = enEmpresa;
             #998#11 = #dsmoy009#49;
             #998#41 = enActividad;
             |LEE 101#998=;
             |SI FSalida ! 0;
                 |DDEFECTO #998;
                 #998#0  = enEmpresa;
                 #998#11 = #dsmoy009#49;
                 #998#41 = enActividad;
                 #998#2  = #dsmoy009#50;
                 |SI #dsmoy009#51 ! 0; |Y #998#2 = "S"; #998#1 = #dsmoy009#51; |FINSI;
                 #998#42  = 1;
                 |GRABA 020#998b;
             |FINSI;

             eSwReten = 0;
             |SI #dsmoy009#53 = "S";  |BUCLE LasReten; |FINSI;

             |SI #dsmoy009#43 = 1; informe = "dsmoya09"; |FINSI;
             |SI #dsmoy009#43 = 2; informe = "dsmoyb09"; |FINSI;
             |SI #dsmoy009#43 = 3; informe = "dsmoyc09"; |FINSI;
             |SI #dsmoy009#43 = 4; informe = "dsmoyd09"; |FINSI;
             |SI #dsmoy009#43 = 5; informe = "dsmoye09"; |FINSI;
             |SI #dsmoy009#43 = 6; informe = "dsmoyf09"; |FINSI;
             |SI eSwReten = 1; |Y #dsmoy009#43 ! 6;
                 aAlfa1  = informe % 603;
                 informe = "dsmor" + aAlfa1;
             |FINSI;
             |SI #306#4 = "N"; |Y #dsmoy009#43 ! 6;
                 aAlfa1  = informe % 306;
                 informe = "dr" + aAlfa1;
             |FINSI;
             |SI #dsmoy009#43 = 7; |O #dsmoy009#43 = 8;
                |SI #dsmoy009#59 = "N";
                   informe = "ccmoy8y9";
                |SINO;
                   informe = "ccmap8y9";
                |FINSI;
             |FINSI;

             eSwAgrupa = 0;
             |SI #dsmoy009#43 = 8; eSwAgrupa = 1; |FINSI;

             |SI nOpcion = 1;
                 |SI enPorCsv = 0;
                     |INFOR informe;
                     |SI FSalida ! 0;  |ACABA;  |FINSI;
                 |SINO;
                     |HAZ PorCsv_2;
                 |FINSI;
             |FINSI;
             |SI nOpcion = 2;
                 eaInforme = informe;
                 |HAZ IMPREArchi;
             |FINSI;

             SwHayDatos = 0;
             SwPrim     = 0;
             eaTexPie   = "";
             enTBase    = 0;
             enTCuoI    = 0;
             enTCuoR    = 0;
             enTCuoP    = 0;
             enTTotal   = 0;

             fDFecha = #dsmoy009#41;
             fHFecha = #dsmoy009#42;
             nDLiqui = #dsmoy009#62;
             nHLiqui = #dsmoy009#63;
             |SI #dsmoy009#62 = 99;
                 nDLiqui = 0;
                 nHLiqui = 99;
             |FINSI;

             |SI #998#2 = "S";
                 #998#5 = 0;  #998#6 = 0;
                 #998#7 = 0;  #998#8 = 0;
                 |PDEFECTO #998, 12, 41;
                 fDFecha  = "01.01.1900";
                 |SI #dsmoy009#62 ! 99; |Y #dsmoy009#62 ! 0;
                     nDLiqui  = 01;
                 |FINSI;
                 nFactura = #998#4;
                 #998#10  = #998#4;
                 |SI #998#10 = 0; #998#10 = 1; |FINSI;
                 #998#42  = 1;
             |SINO;
                 nFactura = #998#10;
                 |SI #998#42 = 0; #998#42 = #998#10; |FINSI;
                 |SI #998#42 = 0; #998#42 = 1;       |FINSI;
             |FINSI;
             nPagina = #998#1;
             nPagDup = nPagina -1;
             nSwPagDup = 0;

             |ABRE #901;

             |SI #dsmoy009#44 = 1;
                 |SI eSwAgrupa = 0; |BUCLE Facturas1;   |FINSI;
                 |SI eSwAgrupa = 1;
                                      || ... primero sumo anterior
                     |SI #dsmoy009#62 = 99;  || ... Seleccion por Fechas
                         nNume1  = #dsmoy009#41; nNume1 = nNume1 - 1;
                         fHFecha = nNume1;
                         |BUCLE Facturas1_P;
                     |SINO;
                         |SI #dsmoy009#62 > 1;
                             nHLiqui = #dsmoy009#62 - 1;
                             |BUCLE Facturas1_P;
                         |FINSI;
                     |FINSI;

                     fDFecha = #dsmoy009#41;
                     fHFecha = #dsmoy009#42;
                     nDLiqui = #dsmoy009#62;
                     nHLiqui = #dsmoy009#63;
                     |SI #dsmoy009#62 = 99;
                         nDLiqui = 0;
                         nHLiqui = 99;
                     |FINSI;
                     |BUCLE Facturas1_P;
                 |FINSI;
             |FINSI;

             |SI #dsmoy009#44 = 2;
                 |SI eSwAgrupa = 0; |BUCLE Facturas2;   |FINSI;
                 |SI eSwAgrupa = 1;

                     |SI #dsmoy009#62 = 99;  || ... Seleccion por Fechas
                         nNume1  = #dsmoy009#41; nNume1 = nNume1 - 1;
                         fHFecha = nNume1;
                         |BUCLE Facturas2_P;
                     |SINO;
                         |SI #dsmoy009#62 > 1;
                             nHLiqui = #dsmoy009#62 - 1;
                             |BUCLE Facturas2_P;
                         |FINSI;
                     |FINSI;
                     fDFecha = #dsmoy009#41;
                     fHFecha = #dsmoy009#42;
                     nDLiqui = #dsmoy009#62;
                     nHLiqui = #dsmoy009#63;
                     |SI #dsmoy009#62 = 99;
                         nDLiqui = 0;
                         nHLiqui = 99;
                     |FINSI;

                     |BUCLE Facturas2_P;
                 |FINSI;
             |FINSI;

             |SI #dsmoy009#44 = 3;
                                  || ... primero sumo anterior
                 |SI #dsmoy009#62 = 99;  || ... Seleccion por Fechas
                     nNume1  = #dsmoy009#41; nNume1 = nNume1 - 1;
                     fHFecha = nNume1;
                     |SI eSwAgrupa = 0; |BUCLE Facturas3;   |FINSI;
                     |SI eSwAgrupa = 1; |BUCLE Facturas3_P; |FINSI;
                 |SINO;
                     |SI #dsmoy009#62 > 1;
                         nHLiqui = #dsmoy009#62 - 1;
                         |SI eSwAgrupa = 0; |BUCLE Facturas3;   |FINSI;
                         |SI eSwAgrupa = 1; |BUCLE Facturas3_P; |FINSI;
                     |FINSI;
                 |FINSI;

                 fDFecha = #dsmoy009#41;
                 fHFecha = #dsmoy009#42;
                 nDLiqui = #dsmoy009#62;
                 nHLiqui = #dsmoy009#63;
                 |SI #dsmoy009#62 = 99;
                     nDLiqui = 0;
                     nHLiqui = 99;
                 |FINSI;
                 |SI eSwAgrupa = 0; |BUCLE Facturas3;   |FINSI;
                 |SI eSwAgrupa = 1; |BUCLE Facturas3_P; |FINSI;
             |FINSI;

             |CIERRA #901;

             |SI SwHayDatos = 1;
                 |SI #dsmoy009#43 ! 7; |Y #dsmoy009#43 ! 8; |Y nOpcion = 1;
                     |SI enPorCsv = 0;
                         |PIEINF;
                         |FININF;
                     |SINO;
                         |HAZ FinDocCsv;
                     |FINSI;
                 |FINSI;
                 |SI nOpcion = 2; |O nSegurOp ! 3;
                     #998#1  = nPagina + 1;
                     #998#2  = "N";
                     #998#3  = "";
                     #998#10 = nFactura;
                     |GRABA 020#998a;
                 |FINSI;

                 |SI #dsmoy009#38 = 3; |O #dsmoy009#38 = 1; |HAZ Resumen1; |FINSI;
                 |SI #dsmoy009#38 = 3; |O #dsmoy009#38 = 2; |HAZ Resumen2; |FINSI;

                 |SI #dsmoy009#43 = 7; |O #dsmoy009#43 = 8;
                     |PIEINF;
                     |FININF;
                     |SI nOpcion = 2;
                        |FINIMP;
                        |SI enErrorDSArchi = 0;
                            |HAZ CargaVar;
                            |HAZ Archivando;
                        |FINSI;
                     |FINSI;
                 |FINSI;
             |SINO;
                 |SI enPorCsv = 0;
                     |FININF;
                     |SI nOpcion = 2;  |FINIMP; |FINSI;
                 |SINO;
                     |HAZ FinDocCsv;
                 |FINSI;
             |FINSI;
             |LIBERA #998;
        |FINSI;
   |SIGUE;

   |SI nOpcion = 2;  Impresora = "CrystalReports"; |FINSI;

   |SI enSwPartido = 1;
       enSwOpPar   = 1;
       |HAZ FinalPartido;
   |FINSI;
|FPRC;

|DEFBUCLE dsmow043;
   #dsmow043#1;
   16;
   000001, "S";
   999999, "S";
   ;
   NULL, Emision;
|FIN;

|PROCESO Imprimir;
    nOpcion = 1;
    |HAZ LeeUnidadBasico;

    |SI enPorCsv = 0;
        |SI aParam ! "";
            |SI eaFormato ! "S";
                Impresora = eaNomImp + "?" + eaUnidadBTmp + "\tmp1,,,?Facturas emitidas";
            |SINO;
                Impresora = eaNomImp + ";" + eaUnidadBTmp + "\FacRecib.pdf";
            |FINSI;
        |SINO;
            |SI #dsmoy009#43 ! 4; |Y #dsmoy009#43 ! 7; |Y #dsmoy009#43 ! 8;
               |MENAV "0000 Recuerde seleccionar el papel de la impresora en Horizontal";
            |FINSI;
        |FINSI;

        |SI aParam ! ""; |Y enBasImp ! 0;
            |IMPRE -1;
        |SINO;
            |SI #dsmoy009#43 = 7; |O #dsmoy009#43 = 8;
                |SI aParam = "";
                    Impresora = "CrystalReports";
                |FINSI;
                |IMPRE -1;
            |SINO;
                |IMPRE 0;
            |FINSI;
        |FINSI;
        |SI FSalida ! 0;  |ACABA;  |FINSI;
    |SINO;
        Impresora = "";
        |HAZ PorCsv_1;
    |FINSI;

    |ABRE #998;
    |BUCLE dsmow043;
    |CIERRA #998;
    |SI enPorCsv = 0;
        |FINIMP;
    |FINSI;
|FPRC;

|PROCESO Archivar;
    nOpcion   = 2;
    Impresora = "CrystalReports";
    |ABRE #998;
    |BUCLE dsmow043;
    |CIERRA #998;
|FPRC;

|PROCESO LeeDatosEmpresa;
  |DELINDEX #901;

  |DDEFECTO #900;
  eaInac = #dsmoy009#24;
  eaTituloL = #dsmoy009#52;
  efDFecha  = #dsmoy009#41;
  efHFecha  = #dsmoy009#42;
  aAlfa1    = #dsmoy009#1;
  aAlfa1    = "01.01." + aAlfa1; fFecha    = aAlfa1;
  |SI efDFecha < fFecha; efDFecha = fFecha; |FINSI;
  |HAZ DatosEmpr_w30;
  |SI aParam = "LEGALIA";
      |SI #900#13 < #900#9;  |Y #900#9  > "01.01.0000"; #900#13 = #900#9;  |FINSI;
      |SI #900#14 > #900#10; |Y #900#10 > "01.01.0000"; #900#14 = #900#10; |FINSI;
  |FINSI;
|FPRC;

|PROCESO LeeDatosActividad;
   swNoExis = 0;
   |SI enActividad ! 0;
       swNoExis = 1;
       |ABRE #114;
       #114#0 = enEmpresa;
       #114#1 = enActividad;
       |LEE 041#114=;
       |SI FSalida = 0;  swNoExis = 0; |FINSI;
       |CIERRA #114;
   |FINSI;
|FPRC;

|PROCESO dsmow031;
 #30#0 = #901#0;
 |LEE 001#30=;
 |SI FSalida ! 0;
     |DDEFECTO #30;
 |FINSI;
 |PRINT;
|FPRC;

|DEFBUCLE dsmow031;
 #901#1;
 ;
 " ", 001;
 " ", 999;
 ;
 NULL, dsmow031;
|FIN;

|PROCESO Resumen1;
   |SI #dsmoy009#43 ! 7; |Y #dsmoy009#43 ! 8;
      enResumen = 0;
   |SINO;
      enResumen = 1;
   |FINSI;

   |SI enResumen = 0;
      aInfoRes = "dsmoyr08";

      |INFOR aInfoRes;
      |SI FSalida ! 0;  |ACABA;  |FINSI;
   |FINSI;

   |ABRE #30;
   |BUCLE dsmow031;
   |CIERRA #30;

   |SI enResumen = 0;
      |PIEINF; |FININF;
   |FINSI;

   enResumen = 0;
|FPRC;

|PROCESO Resumen2;
   |SI #dsmoy009#43 ! 7; |Y #dsmoy009#43 ! 8;
      enResumen = 0;
   |SINO;
      enResumen = 2;
   |FINSI;
   |HAZ iLiqIVA;
   |HAZ BAcum;
   enResumen = 0;
|FPRC;

|PROGRAMA;

  aParam = PARAMETRO; |QBF aParam;

  aClave    = "S";
  nSigFactu = 0;

  |DDEFECTO #dsmoy009;
  |SI aParam = "rec";
      aParam    = "";
      nSigFactu = 1;
      aClave    = "s";
      #dsmoy009#49     = 922;
  |FINSI;

  enModelo = #dsmoy009#49;
  |ABRE #99;
  |DDEFECTO #99;
  #99#0 = enModelo;
  |LEE 041#99=;
  aNomModelo = #99#1; |QBF aNomModelo;
  |CIERRA #99;

  |ABRE #dsmoy009;
  #dsmoy009#0 = aClave;
  |LEE 101#dsmoy009.=;
  |SI FSalida ! 0;
      |DDEFECTO #dsmoy009;
      #dsmoy009#0  = aClave;
      #dsmoy009#49 = enModelo;
      |GRABA 020#dsmoy009.b;
      nEstado = 1;
  |FINSI;
  #dsmoy009#45 = ~;

  |HAZ LeeCtrlLibro;

  eaNomProg = "dsmoy009";
  aTipoIVA  = #dsmoy009#0;
  eaTipo    = "DE COMPRA";
  eaTipoRS  = "SOPORTADO";

  |SI aParam = "";
      |CLS;
      |PINPA #0#dsmoy009;
      |PINDA #0#dsmoy009;
      |HAZ SalCuadro;

      |ENDATOS #1#dsmoy009;
      |SI FSalida = 0;
          |GRABA 020#dsmoy009.a;
      |FINSI;
      |LIBERA #dsmoy009;
      |CIERRA #dsmoy009;
  |SINO;
      || ... Legalia
      |LIBERA #dsmoy009;
      |CIERRA #dsmoy009;

      #dsmoy009#1 = enEjercicio;
      #dsmoy009#2 = eaLegEmp;
      #dsmoy009#3 = eaLegEmp;

      |PDEFECTO #0,4,41;
      #dsmoy009#37 = "N";  || sin caratula
      #dsmoy009#38 = 2;    || Con resumen de tipos %
      aAlfa1 = #dsmoy009#1;
      aAlfa1 = #dsmoy009#1;
      |SI enSwSelFc = 0;
          aAlfa2 = "01.01." + aAlfa1; #dsmoy009#41 = aAlfa2;
      |SINO;
          aAlfa2 = "01.01.2000"; #dsmoy009#41 = aAlfa2;
      |FINSI;
      aAlfa2 = "31.12." + aAlfa1; #dsmoy009#42 = aAlfa2;
      #dsmoy009#62  = 99;
      #dsmoy009#63  = 99;
      |SI eaFormato = "S";
          #dsmoy009#43 = 7;
          #dsmoy009#44 = 3;
      |SINO;
          |SI #dsmoy009#43 ] 7;
              #dsmoy009#43 = 4;
          |FINSI;
      |FINSI;
      |SI enOrdSop ! 0; #dsmoy009#44 = enOrdSop; |FINSI;

      #dsmoy009#45 = efFecLeg;
      #dsmoy009#46 = "S";
      #dsmoy009#48 = "S";
      #dsmoy009#49 = 902;
      #dsmoy009#50 = "S";
      #dsmoy009#51 = 1;
      #dsmoy009#54 = "S";
      #dsmoy009#55 = "N";   ||sin actividad tique 4008 _ 335
      #dsmoy009#56 = 01;
      #dsmoy009#57 = 99;
      |HAZ Tipo3;

      |DBASS Comodin1; |QBF Comodin1;
      Comodin1 = Comodin1 + "contagen/PresLibr/" + eaLegEmp + eaLegPer + "/";
      |SI eaFormato ! "S";
          Comodin1 = Comodin1 + "FAC_RECI*.xls";
      |SINO;
          Comodin1 = Comodin1 + "FAC_RECI*.pdf";
      |FINSI;

      Numeracion = enNumeLeg;
      |_PDIR Comodin1;
      |PARA; |SI FSalida = 0; |HACIENDO;
              Comodin = Comodin1 % -107; Comodin = Comodin % 0103;
              Numeracion = Comodin; Numeracion = Numeracion + 1;
              |_SDIR Comodin1;
      |SIGUE;

      |SI eaFormato ! "S";
          Comodin = eaUnidadBTmp + "/tmp1.xls";
      |SINO;
          Comodin = eaUnidadBTmp + "/FacRecib.pdf";
      |FINSI;

      |XABRE "C", Comodin, Handle;
      |SI FSalida ] 0;
          |XCIERRA Handle;
          |DBASS Comodin1; |QBF Comodin1;
          Comodin1 = Comodin1 + "contagen/PresLibr/";
          |MKDIR Comodin1;
          Comodin1 = Comodin1 + eaLegEmp + eaLegPer + "/";
          |MKDIR Comodin1;
          |SI eaFormato ! "S";
              Comodin1 = Comodin1 + "FAC_RECI_" + (("000" + Numeracion) % -103) + ".xls";
              aNomFLeg = "FAC_RECI_" + (("000" + Numeracion) % -103) + ".xls";
          |SINO;
              Comodin1 = Comodin1 + "FAC_RECI_" + (("000" + Numeracion) % -103) + ".pdf";
              aNomFLeg = "FAC_RECI_" + (("000" + Numeracion) % -103) + ".pdf";
          |FINSI;

          aAlfa = "";
          |IP_REMOTO aAlfa; |QBF aAlfa;
          |SI aAlfa ! "";
              |RECIBE_FICHERO Comodin, Comodin1;
          |SINO;
              |COPIA_FICHERO Comodin, Comodin1;
          |FINSI;
          nTipoL   = 11;
          nNumer   = Numeracion;
          efFecha1 = efDFecha;
          efFecha2 = efHFecha;
          enRegisLeg = 0;
          |HAZ eGrabaHistLegal;

          FSalida = 1;
          |PARA; |SI FSalida ! 0; |HACIENDO;
                 |RFBORRA Comodin;
                 |SI FSalida ! 0;
                     |SI eaFormato ! "S";
                         |MENAV "    Termine la tarea de Excel que tiene activa";
                     |SINO;
                          |MENAV "    Termine la tarea de PDF que tiene activa";
                     |FINSI;
                 |FINSI;
          |SIGUE;
      |FINSI;
  |FINSI;
|FPRO;
