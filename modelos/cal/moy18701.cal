|FICHEROS;
     dsmoy000;
     dsmom004;

     dsm187ca #187;
     dsm187li #188;

     dsmow014 #999;

     t1818701;
     t1818702;

     &regisnif@ #709;
     &clientes@ #715;
|FIN;

|VARIABLES;
     nHay     = 0;
|FIN;

|INCLUYE i_varemi;

|PROCESO Registro187_1_2018;
     enCodCli = #187#0;
     |HAZ LeePersona;

     |DDEFECTO #t1818701;

     #t1818701#3  = #187#1;

     |SI enSwDeDonde = 1;
         eaVarDni = #715#3;  |HAZ CalculameDNI;
         #t1818701#4   = eaVarDni;

         eaAlfa   = #715#1;  |HAZ QuitaRaros;
         #t1818701#5   = eaAlfa;

         eaAlfa   = #715#1;  enLinea = 2;  |HAZ LeeTelefono;  |QBF eaAlfa;
         |SI eaAlfa = "";
             eaAlfa   = #715#1;  enLinea = 1;  |HAZ LeeTelefono;
         |FINSI;
         |HAZ QuitaRarosTfno;
         #t1818701#7   = eaAlfa;

         eaAlfa   = #715#53;  |HAZ QuitaRaros;
         #t1818701#8   = eaAlfa;
     |SINO;
         aAlfa = #715#96; |QBF aAlfa; |SI aAlfa = ""; #715#96 = #715#2; |FINSI;
         eaVarDni = #715#13;  |HAZ CalculameDNI;
         #t1818701#4   = eaVarDni;

         eaAlfa   = #715#1;   |HAZ QuitaRaros;
         #t1818701#5   = eaAlfa;

         eaAlfa   = #715#14;  |HAZ QuitaRarosTfno;
         #t1818701#7   = eaAlfa;

         eaAlfa   = #715#96;  |HAZ QuitaRaros;
         #t1818701#8   = eaAlfa;
     |FINSI;

     #t1818701#6  = "T";

     #t1818701#9 = "1870000000000";

     |SI enDirecta = 1;
         |HAZ CalcJustificante;
         #t1818701#9 = eaJusti;
     |FINSI;

     |SI #dsmom004#24 = "C";  #t1818701#10  = "C";  |FINSI;

     |SI #dsmom004#24 = "S";
         #t1818701#11 = "S";
         #t1818701#12 = #dsmom004#21;
     |FINSI;

     nNume   = #187#6;
     #t1818701#13 = ("000000000" + nNume) % -109;

     enNume  = #187#7;  |HAZ Conver15;
     #t1818701#14 = eaAlfa;

     enNume  = #187#8;  |HAZ Conver15;
     #t1818701#15 = eaAlfa;

     enNume  = #187#9;  |HAZ Conver15;
     #t1818701#16 = eaAlfa;

     #t1818701#19 = &13 + &10;

     nHCampo = 19;

     aAlfa = "";
     |PARA nCampo = 1;  |SI nCampo [ nHCampo;  |HACIENDO nCampo = nCampo + 1;
           aAlfa = #t1818701#nCampo#;
           |XGRABA nHandle2, aAlfa;
     |SIGUE;
|FPRC;

|PROCESO Registro187_2_2018;
         |DDEFECTO #t1818702;

         #t1818702#3  = #187#1;
         #t1818702#4  = #t1818701#3;

         eaVarDni = #188#7;  |HAZ CalculameDNI;
         |SI #188#8 = "N";
             #t1818702#5 = eaVarDni;
         |SINO;
             #t1818702#6 = eaVarDni;
         |FINSI;

         eaAlfa  = #188#9;  |HAZ QuitaRaros;  #t1818702#7  = eaAlfa;
         eaAlfa  = (("00" + #188#10) % -102) + #188#24;
         #t1818702#8  = eaAlfa;
         #t1818702#9  = #188#11;
         #t1818702#10 = #188#12;

         eaAlfa  = #188#14;  |HAZ QuitaRaros;
         |SI #188#13 = "1";
             #t1818702#11 = eaAlfa;
         |SINO;
             #t1818702#12 = eaAlfa;
         |FINSI;

         #t1818702#13 = #188#15;
         |SI #188#16 > "01.01.0000";
             eaAlfa  = (#188#16 % -104);
             eaAlfa  = eaAlfa + (#188#16 % 402);
             eaAlfa  = eaAlfa + (#188#16 % 102);  #t1818702#14 = eaAlfa;
         |FINSI;
         nNume   = #188#17 * 1000000;                #t1818702#15 = ("0000000000000000" + nNume) % -116;
         enNume  = #188#18;  |HAZ Conver13;          #t1818702#16 = eaAlfa;

         #t1818702#17 = #188#19;
         #t1818702#18 = #188#27;
         |SI #188#28 > "01.01.0000";
             eaAlfa  = (#188#28 % -104);
             eaAlfa  = eaAlfa + (#188#28 % 402);
             eaAlfa  = eaAlfa + (#188#28 % 102);  #t1818702#19 = eaAlfa;
         |FINSI;

         enNume  = #188#20;  |HAZ Conver13Signo;  #t1818702#21 = eaSigno + (eaAlfa % -113);
         nNume   = #188#21 * 100;                 #t1818702#22 = ("0000" + nNume) % -104;
         enNume  = #188#22;  |HAZ Conver13;       #t1818702#23 = eaAlfa;

         #t1818702#24 = #188#25;

         enNume  = #188#29;  |HAZ Conver13;       #t1818702#25 = eaAlfa;
         enNume  = #188#30;  |HAZ Conver13;       #t1818702#26 = eaAlfa;
         enNume  = #188#31;  |HAZ Conver13;       #t1818702#27 = eaAlfa;
         enNume  = #188#26;  |HAZ Conver13;       #t1818702#28 = eaAlfa;

         #t1818702#31 = &13 + &10;

         nHCampo = 31;
         aAlfa = "";
         |PARA nCampo = 1;  |SI nCampo [ nHCampo;  |HACIENDO nCampo = nCampo + 1;
               aAlfa = #t1818702#nCampo#;
               |XGRABA nHandle2, aAlfa;
         |SIGUE;
|FPRC;

|DEFBUCLE dsm187li_2018;
     #188#1;
     ;
     #187#0, #187#1, #187#2, #187#3, #187#4, #187#5,     0;
     #187#0, #187#1, #187#2, #187#3, #187#4, #187#5, 99999;
     ;
     NULL, Registro187_2_2018;
|FIN;

|PROCESO QueHacemos187_2018;
     #dsmom004#0  = #999#0;
     #dsmom004#1  = #999#1;
     #dsmom004#2  = #999#2;
     #dsmom004#3  = #999#5;
     #dsmom004#4  = #999#7;
     |LEE 040#dsmom004.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     #187#0  = #999#0;
     #187#1  = #999#1;
     #187#2  = #999#2;
     #187#3  = #999#5;
     #187#4  = #999#7;
     #187#5  = 0;
     |LEE 040#187=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     eaFicheroPlano = "187" + (("00000" + #999#0) % -105) + ".txt";
     eaFicheroImpre = "187" + (("00000" + #999#0) % -105) + ".imp";
     eaFicheroSalid = "187" + (("00000" + #999#0) % -105) + ".sal";
     eaFicheroError = "err" + (("00000" + #999#0) % -105) + ".txt";

     aAbre = eaPathEmision + eaFicheroPlano;
     |XABRE "BW", aAbre, nHandle2;

     |HAZ Registro187_1_2018;

     |BUCLE dsm187li_2018;

     |XCIERRA nHandle2;

     enEmpresa    = #dsmow014#0;
     enComple     = #dsmow014#7;
     eaNomEmpresa = #dsmow014#3;

     eaX002_10    = #t1818701#4;
     eaX002_11    = #t1818701#5;
     eaX002_12    = #dsmoy000#0;
     eaX002_13    = #dsmoy000#6;
     eaX002_14    = 99;

     |SI #t1818701#10 ! " ";
         eaX002_15 = #t1818701#10;
     |FINSI;

     |SI #t1818701#11 ! " ";
         eaX002_15 = #t1818701#11;
         eaX002_16 = #t1818701#12;
     |FINSI;

     eaX002_20 = #dsm187ca#6;
     eaX002_27 = #t1818701#13;
     eaX002_28 = #dsm187ca#7;

     eaX002_22 = #dsm187ca#9;
     eaX002_30 = #dsm187ca#9;

     eaX002_29 = #dsm187ca#8;
     eaX002_21 = #dsm187ca#8;

     |SI #dsm187ca#8 = 0;
         eaX002_21 = #dsm187ca#7;
     |FINSI;

     |HAZ PresentaPortal;

     nHay = 1;
|FPRC;

|DEFBUCLE dsmow014C187_2018;
     #999#1;
     6;
     00000, 0000, 00, "S";
     99999, 9999, 99, "S";
     ;
     NULL, QueHacemos187_2018;
|FIN;

|DEFBUCLE dsmow014N187_2018;
     #999#2;
     6;
     "                                        ", "S";
     "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz", "S";
     ;
     NULL, QueHacemos187_2018;
|FIN;

|PROCESO Ejer2018;
     nTecla = 1;
     |HAZ BtnAnuales2015;

     nHay = 0;

     |ABRE #dsmom004;
     |ABRE #187;
     |SI #dsmoy000#8 = "C";
         |BUCLE dsmow014C187_2018;
     |SINO;
         |BUCLE dsmow014N187_2018;
     |FINSI;
     |CIERRA #dsmom004;
     |CIERRA #187;
     |SI nHay = 0;  |ACABA;  |FINSI;

     |SI eaOpcion = "3";
         |SI enPresentar = 0;
             aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
             |MENAV aAlfa;
         |FINSI;
     |FINSI;

     |SI enDirecta = 1;  |Y enMsv = 1;  |Y enParar = 0;
         |SUB_EJECUTA "|dsmox007";
     |FINSI;
|FPRC;
