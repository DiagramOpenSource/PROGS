|FICHEROS;
   dsmoy096;

   dsmom041;
   dsmom042;
   dsmom049;

   :/basica/def/agicen14;
   :/basica/def/agicen30;
   :/basica/def/agifigen;
   :/basica/def/agim0019;

   :/contagen/def/canempre;
   :/contagen/def/caivaasi;
   :/contagen/def/camaasic;
   :/contagen/def/camaasil;
   :/contagen/def/camaniva;
   :/contagen/def/caivalin;
   :/contagen/def/camacc01;
   :/contagen/def/camacc02;
   :/contagen/def/camacc03;
   :/contagen/def/cacuenta;
   :/contagen/def/calicont;

   dsmom030;
   dsmow030 #900;          ||Def de impresion

   dsmow054;
   dsmow157;
   dsmow043,MANTE;
   dsmow049;

   dsmow175;
   dsmow176;
   dsmow177;

   dsmom060;
   dsmom061;
   dsmom162;

   &regisnif@ #709;
|FIN;

|VARIABLES;
   aParam       = "";
   informe      = "";
   aInfoRes     = "";
   nInkey       = 0;
   aFichero     = "";
   nCampo       = 0;
   nDEmpresa    = 0;
   nHEmpresa    = 0;
   nDActividad  = 0;
   nHActividad  = 0;
   nLaEmpresa   = 0;
   nGTempo      = 0;
   nSPin1       = 0;
   aPath        = "";
   nEjercicio   = 0;
   nSw          = 0;
   aAlfa        = "";
   aAlfa1       = "";
   aAlfa2       = "";
   aAlfa3       = "";
   nPara1       = 0;
   nPara2       = 0;
   nPara3       = 0;
   nNume1       = 0;
   nNume2       = 0;
   nNume3       = 0;
   nNume4       = 0;
   nNume5       = 0;
   nNume6       = 0;
   fFecha       = @;
   nClave       = 0;
   nQuants      = 0;

   aDTipo       = "";
   aHTipo       = "";
   SwHayDatos   = 0;
   ffecha1      = @;
   fDFecha      = @;
   fHFecha      = @;
   nDLiqui      = 0;
   nHLiqui      = 0;
   fLaFecha     = @;
   nElDepar     = 0;
   nEstado      = 0;
   nOperacion   = 0;
   nOpMdep      = 0;
   nAlSi        = 0;
   nAlNo        = 0;
   nAlConcepto  = 0;
   aClave       = "";
   aPeriodo     = "";
   aTipoFra     = "";
   nOper        = 0;
   aClaveOpe    = "";
   fFechaPago   = @;
   nImporPago   = 0;
   aMedioPago   = "";
   aDesPago     = "";
   nLibros      = 0;
   nAbreLibro   = 0;

   nLinea       = 0;
   nLongitud    = 0;
   nLongPart    = 0;
   nImporte     = 0;
   aCta         = "";
   aDCta        = "";
   aHCta        = "";
   nSwCol       = 0;
   aSigno       = "";
   aSignoE      = "";
   aCondicion   = "";
   aNomCta      = "";
   aDesCon      = "";
   aCIF         = "";
   nSwSiHay     = 0;
   nAsto0       = 0;
   fAsto1       = @;
   nAsto2       = 0;
   aAsto12      = "";
   nAsto13      = 0;
   nAsto14      = 0;
   aAsto15      = "";
   aAsto26      = "";
   aAsto19      = "";
   nLibro       = 0;
   nRegistro    = 0;
   nFormato     = 0;

   nOk          = 0;
   aTAmor       = "";
   nTCAmor      = 0;
   nAcumI       = 0;
   nAcumR       = 0;
   nAcumA       = 0;
   nValorRes    = 0;
   nDatos49     = 0;
   nAcumI1      = 0;
   nAcumR1      = 0;
   nAcumA1      = 0;
   nValorRes1   = 0;
   nAcumI2      = 0;
   nAcumR2      = 0;
   nAcumA2      = 0;
   nValorRes2   = 0;
   nAcumI3      = 0;
   nAcumR3      = 0;
   nAcumA3      = 0;
   nValorRes3   = 0;
   nAcumI4      = 0;
   nAcumR4      = 0;
   nAcumA4      = 0;
   nValorRes4   = 0;
   nT           = 0;
   nT1          = 0;
   nT2          = 0;
   nT3          = 0;
   nT4          = 0;
   nEjerBaja    = 0;
   nMesBaja     = 0;
   nPrint       = 0;
   nPrintBaja   = 0;
   nMes         = 0;

   &enSwCaja    = 0;
   &enError     = 0;
   &eaAlfa      = "";
   &efFechaEmi  = @;
   &nLBase      = 0;
   &nLTipoI     = 0;
   &nLCuoI      = 0;
   &nLCuoIN     = 0;
   &nLTipoR     = 0;
   &nLCuoR      = 0;
   &nLCuoRN     = 0;
   &nLBasP      = 0;
   &nLTipP      = 0;
   &nLCuoP      = 0;
   &SwLinea     = 0;
   &aTipoIVA    = "";
   &aTipo       = "";
   &aTipoRS     = "";
   &nFactura    = 0;
   &nConta      = 0;
   &enPorCsv    = 0;
   &wTodoExcel  = 0;
   &eaExcel97   = "";
   &eaPathLocal = "";
   &eaNomFic    = "";
   &enCab       = 0;
   &eaAbre      = "";

   &entrada     = 1;
|FIN;

|INCLUYE i_variar;
|INCLUYE i_varcon;
|INCLUYE i_varlib;

|| //////////////////// Calculos de Pantalla \\\\\\\\\\\\\\\\\\\\\\\\\\
|CALCULO Eano; |TIPO 7;
 |SI nEstado ! 0;
     fLaFecha = ~;
     aAlfa1 = fLaFecha; aAlfa1 = aAlfa1 % -104;
     #dsmoy096#1  = aAlfa1; |PINTA #dsmoy096#1;
 |FINSI;
|FCAL;

|CALCULO losDefectos; |TIPO 0;
 aAlfa1 = #dsmoy096#1;
 aAlfa2 = #dsmoy096#40;
 aAlfa2 = aAlfa2 % -104;
 |SI aAlfa1 ! aAlfa2; |O nEstado ! 0;
     aAlfa2 = "31.12." + aAlfa1; #dsmoy096#41 = aAlfa2; |PINTA #dsmoy096#41;
 |FINSI;
 |SI enSwSelFc = 1; aAlfa2 = aAlfa1; |FINSI;
 |SI aAlfa1 ! aAlfa2; |O nEstado ! 0;
     aAlfa2 = "01.01." + aAlfa1; #dsmoy096#40 = aAlfa2; |PINTA #dsmoy096#40;
 |FINSI;
|FCAL;

|CALCULO Tipo7;  |TIPO 7;
     |SI enEmpresa ! 0;
         #dsmoy096#2  = enEmpresa;  |PINTA #dsmoy096#2;
         #dsmoy096#3  = enEmpresa;  |PINTA #dsmoy096#3;

         |C_M #dsmoy096#2, 1, "N";
         |C_M #dsmoy096#3, 1, "N";
     |FINSI;
|FCAL;

|CALCULO Parrilla; |TIPO 0;
     |SI #dsmoy096#2 = 0;
         #dsmoy096#2 = 0;  |PINTA #dsmoy096#2;
         #dsmoy096#3 = 0;  |PINTA #dsmoy096#3;  |C_M #dsmoy096#3, 1, "N";
         |PARA nCampo = 4;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #dsmoy096#nCampo#, 1, "S";
         |SIGUE;
     |SINO;
         |SI enEmpresa = 0;
             |C_M #dsmoy096#2, 1, "S";
             |C_M #dsmoy096#3, 1, "S";
         |FINSI;

         |PARA nCampo = 4;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #dsmoy096#nCampo#, 1, "N";
               #dsmoy096#nCampo# = 0;  |PINTA #dsmoy096#nCampo#;
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO NoMasEmpresas; |TIPO 0;
     |SI #dsmoy096#Campo# = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               #dsmoy096#nCampo# = 0;  |C_M #dsmoy096#nCampo#, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #dsmoy096#nCampo#, 1, "S";
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO YaSeCual; |TIPO 7;
 |SI enEmpresa ! 0;
     #dsmoy096#24 = "S"; |PINTA #dsmoy096#24;
     #dsmoy096#42 = "S";
     #dsmoy096#25 = 00;  |PINTA #dsmoy096#25;
     #dsmoy096#26 = 99;  |PINTA #dsmoy096#26;
     |C_M #dsmoy096#24, 1, "N";
     |C_M #dsmoy096#25, 1, "N";
     |C_M #dsmoy096#26, 1, "N";
     |C_M #dsmoy096#42, 1, "N";
 |FINSI;
|FCAL;

|CALCULO SelTipo0; |TIPO 0;
 |SI #dsmoy096#42 = "N";
     #dsmoy096#25 = 0;   |PINTA #dsmoy096#25;  |C_M #dsmoy096#25, 1, "N";
     #dsmoy096#26 = 99;  |PINTA #dsmoy096#26;  |C_M #dsmoy096#26, 1, "N";
     |PARA nCampo = 27;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           |C_M #dsmoy096#nCampo#, 1, "S";
     |SIGUE;
 |SINO;
     |SI enEmpresa = 0;
         |C_M #dsmoy096#25, 1, "S";
         |C_M #dsmoy096#26, 1, "S";
     |FINSI;
     |PARA nCampo = 27;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           |C_M #dsmoy096#nCampo#, 1, "N";
           #dsmoy096#nCampo# = 0;  |PINTA #dsmoy096#nCampo#;
     |SIGUE;
 |FINSI;
|FCAL;

|CALCULO SelTipo1;
 |SI #dsmoy096#Campo# = 0;
     |PARA nCampo = Campo + 1;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           #dsmoy096#nCampo# = 0;  |C_M #dsmoy096#nCampo#, 1, "N";
     |SIGUE;
 |SINO;
     |PARA nCampo = Campo + 1;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           |C_M #dsmoy096#nCampo#, 1, "S";
     |SIGUE;
 |FINSI;
|FCAL;

|CALCULO Tipo7C39; |TIPO 7;
  aAlfa = "S";
  |SI #dsmoy096#37 ! 3; |O #dsmoy096#38 = 1;
      aAlfa = "N";
      #dsmoy096#39 = "N";
      |PINTA #dsmoy096#39;
  |FINSI;
  |C_M #dsmoy096#39,1,aAlfa;
|FCAL;

|CALCULO fecha; |TIPO 0;
 |C_M #dsmoy096#Campo#,0,aAlfa1;
 |SI aAlfa1 = "N"; |ACABA; |FINSI;

 aAlfa1 = #dsmoy096#1;
 aAlfa2 = "01.01." + aAlfa1;
 aAlfa3 = "31.12." + aAlfa1;
 |SI enSwSelFc = 1; aAlfa2 = "01.01.2000"; |FINSI;
 |SI #dsmoy096#Campo# < aAlfa2; |O #dsmoy096#Campo# > aAlfa3;
     |MENAV "    Error. Fecha Incorrecta ";
     |ERROR;
 |SINO;
     |SI Campo = 41; |Y #dsmoy096#40 > #dsmoy096#41;
         |MENAV "    Error. Fecha Incorrecta ";
         |ERROR;
     |FINSI;
 |FINSI;
|FCAL;

|CALCULO SelAct; |TIPO 0;
 aAlfa1 = #dsmoy096#Campo#;
 |C_M #dsmoy096#46,1, aAlfa1;
 |C_M #dsmoy096#47,1, aAlfa1;
|FCAL;

|| **********************************************************************************
|| **********************************************************************************
|| ....................... Situa la Empresa Contable
|PROCESO LEmpresaConta;

 enEmpresa  = #canempre#2;
 enPerConta = #canempre#3;;   || Periodo Contable

 |SI #dsmoy096#24 = "N"; |Y #canempre#21 = "I"; |ACABA; |FINSI;

|| ... Seleccion de Tipo de Empresa
  |ABRE #agifigen;
  #agifigen#0 = enEmpresa;
  |LEE 041#agifigen.=;
  |SI FSalida ! 0;
      |DDEFECTO #agifigen;
  |FINSI;
  |CIERRA #agifigen;
  nSPin1 = #agifigen#87;

  enSwSelEmp = 1;
  |SI #dsmoy096#42 = "S";
      |SI nSPin1 ] #dsmoy096#25; |Y nSPin1 [ #dsmoy096#26;
          enSwSelEmp = 0;
      |FINSI;
  |SINO;
      |SI nSPin1 = #dsmoy096#27;
          enSwSelEmp = 0;
      |SINO;
          |PARA nCampo = 28;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
                |SI nSPin1 = #dsmoy096#nCampo#; |Y nSPin1 ! 0;
                    enSwSelEmp = 0;
                    |SAL;
                |FINSI;
          |SIGUE;
      |FINSI;
  |FINSI;
  |SI enSwSelEmp = 1; |ACABA; |FINSI;
|| ------------------------------------------------------------------------
   aAlfa1 = enEmpresa;  aAlfa1 = ("00000" + aAlfa1) % -105;
   aAlfa2 = enPerConta; aAlfa2 = ("0" + aAlfa2) % -101;
   aPathConta = aPath + "contagen/fich/" + aAlfa1 + aAlfa2 + "/";

   nGTempo = nGTempo + 1;
   #dsmow043#0 = nGTempo;       || Guia
   #dsmow043#1 = enEmpresa;     || Empresa
   #dsmow043#2 = enPerConta;    || Periodo Contable
   #dsmow043#3 = enEjer;        || A¤o
   #dsmow043#4 = #canempre#11;  || Desde Mes
   #dsmow043#5 = #canempre#13;  || N§ Digitos
   #dsmow043#6 = #canempre#14;  || Digitos Nivel 1
   #dsmow043#7 = #canempre#15;  || Digitos Nivel 2
   #dsmow043#8 = #canempre#16;  || Digitos Nivel 3
   #dsmow043#9 = #canempre#17;  || Digitos Nivel 4
   #dsmow043#10 = #canempre#18; || Digitos Nivel 5
   #dsmow043#11 = #canempre#19; || Digitos Nivel 6
   eaEstadoEmp = "S"; |SI #canempre#21 = "I"; eaEstadoEmp = "N"; |FINSI;
   #dsmow043#12 = eaEstadoEmp;  || Estado
   #dsmow043#13 = #canempre#28; || Moneda
   #dsmow043#14 = #canempre#1;  || Nombre Empresa
   #dsmow043#15 = aPathConta;   || Path
   #dsmow043#16 = #dsmoy096#44; || Emitir
   |GRABA 020#dsmow043.n;
|FPRC;

|DEFBUCLE canempre;
   #canempre#4;
   ;
   nDEmpresa, nEjercicio;
   nHEmpresa, nEjercicio;
   ;
   NULL, LEmpresaConta;
|FIN;

||///////////////////////////////////////////////////////////////////
|CALCULO Datos7; |TIPO 7;
     |MENSA "    <F3> Cambiar Emitir Libro S/N";
     |ATRI R; |PINTA 1169, "Imp"; |ATRI 0;
|FCAL;

|CALCULO DatosManip; |TIPO 11;
   nInkey = FSalida;
   |BLIN 04;

   |SI nInkey = 11;
       |SI #dsmow043#16 = "S";
           #dsmow043#16 = "N";
       |SINO;
           #dsmow043#16 = "S";
       |FINSI;
       |GRABA 020#dsmow043.a;
   |FINSI;
|FCAL;

||///////////////// Datos
|PROCESO CalTipoNif;
   aAlfa1     = #709#12; aAlfa2 = "  ";
   |SI aAlfa1 = "   "; aAlfa1 = "ES "; |FINSI;
   |SI aAlfa1 ! "ES ";
       aAlfa = aAlfa1; |QBF aAlfa;
       |SI aAlfa = "GR";  aAlfa  = "EL";  |FINSI;
                          aAlfa2 = "06";
       |SI aAlfa = "DE";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "AT";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "BE";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "BG";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "CY";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "DK";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "SI";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "EE";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "FI";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "FR";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "EL";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "GB";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "NL";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "HU";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "IT";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "IE";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "LV";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "LT";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "LU";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "MT";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "PL";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "PT";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "CZ";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "SK";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "RO";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "SE";  aAlfa2 = "02";  |FINSI;
       |SI aAlfa = "HR";  aAlfa2 = "02";  |FINSI;
   |FINSI;
   aAlfa = aAlfa1 + aAlfa2;
|FPRC;
||///////////////////////////////////////////////////////////////////
|| ... Imprimir los Libros
|PROCESO ImprimeLinea;
    |SI enPorCsv = 1;
         |HAZ GrabaCsv;
    |SINO;
         |HAZ GrabaExcel;
    |FINSI;
    SwLinea = 1;
|FPRC;

|DEFBUCLE dsmow177;
   #dsmow177#2;
   ;
   "01.01.0000", 00000001;
   "31.12.2099", 99999999;
   ;
   NULL, ImprimeLinea;
|FIN;

|DEFBUCLE dsmow176;
   #dsmow176#2;
   ;
   "01.01.0000", 00000001;
   "31.12.2099", 99999999;
   ;
   NULL, ImprimeLinea;
|FIN;

|DEFBUCLE dsmow175;
   #dsmow175#2;
   ;
   "01.01.0000", 00000001;
   "31.12.2099", 99999999;
   ;
   NULL, ImprimeLinea;
|FIN;

|PROCESO FinalLibro;
/*
|SI aTipoIVA = "G"; |O aTipoIVA = "S";
    |ABRE #dsmow176;
    |CONSULTA_CLAVE #1#dsmow176;
    |CIERRA #dsmow176;
|FINSI;
|SI aTipoIVA = "I"; |O aTipoIVA = "R";
    |ABRE #dsmow175;
    |CONSULTA_CLAVE #1#dsmow175;
    |CIERRA #dsmow175;
|FINSI;
|SI aTipoIVA = "X"; |O aTipoIVA = "B";
    |ABRE #dsmow177;
    |CONSULTA_CLAVE #1#dsmow177;
    |CIERRA #dsmow177;
|FINSI;
*/

    enError = 0;
    |SI enPorCsv = 1;
        |HAZ PorCsv_2;
    |SINO;
        |SI nAbreLibro = 0;
            |HAZ PorExcel_20;
            |SI enError ! 0; |ACABA; |FINSI;
        |FINSI;
        |HAZ PorExcel_2;
    |FINSI;
    nAbreLibro = 1;

    |SI enError =  0;
        |SI aTipoIVA = "G"; |O aTipoIVA = "S"; |BUCLE dsmow176; |FINSI;
        |SI aTipoIVA = "I"; |O aTipoIVA = "R"; |BUCLE dsmow175; |FINSI;
        |SI aTipoIVA = "X"; |O aTipoIVA = "B"; |BUCLE dsmow177; |FINSI;

        |SI enPorCsv = 1;
            |HAZ PresentaDocCsv;
            nLibros = nLibros + 1;
            nAbreLibro = 0;
        |FINSI;
    |FINSI;
|FPRC;

|PROCESO AbreLibro;
    aAlfa = "";
    eaNomFic = enEjer;
    eaNomFic = eaNomFic + #dsmow030#1; |QBF eaNomFic;
    |SI enPorCsv = 1;   || nombre en csv
        |SI aTipoIVA = "I";  aAlfa = "I";  |FINSI;
        |SI aTipoIVA = "G";  aAlfa = "G";  |FINSI;
        |SI aTipoIVA = "B";  aAlfa = "B";  |FINSI;
        |SI aTipoIVA = "R";  aAlfa = "E";  |FINSI;
        |SI aTipoIVA = "S";  aAlfa = "R";  |FINSI;
        |SI aTipoIVA = "X";  aAlfa = "S";  |FINSI;
    |FINSI;
    |SI enPorCsv = 2;   || nombre en excel
        |SI aTipoIVA = "I"; |O aTipoIVA = "G"; |O aTipoIVA = "B";  aAlfa = "C";  |FINSI;
        |SI aTipoIVA = "R"; |O aTipoIVA = "S"; |O aTipoIVA = "X";  aAlfa = "D";  |FINSI;
        |SI wTodoExcel = 1;
            aAlfa = "T";
        |FINSI;
    |FINSI;
    eaNomFic = eaNomFic + aAlfa; |QBF eaNomFic;

    eaAlfa = eaNombreEmp; |HAZ QuitaRarosNom;
    eaNomFic = eaNomFic + eaAlfa; |QBF eaNomFic;
|FPRC;

|PROCESO NombreHoja;
    |SI wTodoExcel = 0;
        |SI aTipoIVA = "R"; aTipo = "EXPEDIDAS";        |FINSI;
        |SI aTipoIVA = "S"; aTipo = "RECIBIDAS";        |FINSI;
        |SI aTipoIVA = "X"; aTipo = "BIENES-INVERSION"; |FINSI;

        |SI aTipoIVA = "I"; aTipo = "INGRESOS";         |FINSI;
        |SI aTipoIVA = "G"; aTipo = "GASTOS";           |FINSI;
        |SI aTipoIVA = "B"; aTipo = "BIENES-INVERSION"; |FINSI;
    |SINO;
        |SI aTipoIVA = "R"; |O aTipoIVA = "I"; aTipo = "EXPEDIDAS_INGRESOS"; |FINSI;
        |SI aTipoIVA = "S"; |O aTipoIVA = "G"; aTipo = "RECIBIDAS_GASTOS";   |FINSI;
        |SI aTipoIVA = "X"; |O aTipoIVA = "B"; aTipo = "BIENES-INVERSION";   |FINSI;
    |FINSI;
|FPRC;

|| *************************************************************************
|PROCESO NuevoCalFraRep;
/*
  ||aqui
   |SI #caivaasi#xxx = "S";
   |FINSI;
*/
|FPRC;

|| *************************************************************************
|PROCESO DatosFacturas;
   nOpMdep = 1;
   |PDEFECTO #900, 16, 64;
   #900#66 = 0; #900#67 = 0; #900#68 = 0;

   |SI enActividad = 0;
       enActividad = #camaniva#10;
       |HAZ LeeDatosActividad;
       enActividad = 0;
   |FINSI;

   #900#79 = "01.01.0000";
   #900#81 = "01.01.0000";
   #900#82 = "";
   #900#83 = 0;
   #900#84 = 0;
   #900#65 = "";
   |DELINDEX #dsmow157;

   #900#16 = #camaniva#2;
   #900#17 = #camaniva#3;
   |SI nFactura = 0; nFactura = 1; |FINSI;

   fLaFecha = #camaniva#4;
   aAlfa1   = fLaFecha; aAlfa1   = aAlfa1 % 105;
   #900#18  = aAlfa1;
   #900#19  = #camaniva#12;
   #900#20  = #camaniva#13;
   #900#21  = #camaniva#14;
   eaCodNif = #camaniva#14;  ||El Dni
   |HAZ LeeNifs;
   |HAZ CalTipoNif;
   #900#65 = aAlfa;

   #900#22 = #camaniva#22;

   #900#79  = fLaFecha;
   |SI #camaniva#41 > "01.01.0000";
       #900#81  = #camaniva#41;
       aAlfa1   = #900#81; aAlfa1   = aAlfa1 % 105;
       #900#82  = aAlfa1;
   |FINSI;

   #900#87 = #camaniva#5;
   #900#88 = #camaniva#40;
   |SI #900#88 ! 0;  #900#87 = #900#88; |FINSI;
   aPeriodo = "1T";
   |SI #900#87 > 3; |Y #900#87 [ 6; aPeriodo = "2T"; |FINSI;
   |SI #900#87 > 6; |Y #900#87 [ 9; aPeriodo = "3T"; |FINSI;
   |SI #900#87 > 9;                 aPeriodo = "4T"; |FINSI;

   |SI #camaniva#36 ! "N";
       aTipoFra = "F1";
       aAlfa = #camaniva#14; |QBF aAlfa;
       |SI aAlfa = ""; aTipoFra = "F2"; |FINSI;
       |SI #camaniva#38 > 1;   aTipoFra = "F4"; |FINSI;
       |SI #camaniva#42 = "D"; aTipoFra = "R0"; |FINSI;

       |ABRE #dsmom030;
       #dsmom030#0 = #camaniva#27;
       |LEE 041#dsmom030.=;
       |CIERRA #dsmom030;

       |SI aTipoIVA = "S"; |O aTipoIVA = "G";
           |SI #dsmom030#28 = 3; aTipoFra = "F5"; |FINSI;
           |SI #dsmom030#28 = 7; aTipoFra = "F6"; |FINSI;
       |FINSI;
   |FINSI;

   aClaveOpe = "";
   |SI #camaniva#36 ! "N";
       enSwCaja = 0
       |SI #camaniva#42 = "Z"; |O #camaniva#42 = "1"; |O #camaniva#42 = "2";
            |O #camaniva#42 = "3"; |O #camaniva#42 = "4"; |O #camaniva#42 = "5";
            |O #camaniva#42 = "6"; |O #camaniva#42 = "7"; |O #camaniva#42 = "8";
                enSwCaja = 1;
                aClaveOpe = "07";
       |FINSI;
       |SI enSwCaja = 1;
           |DDEFECTO #camacc01;
           #camacc01#17 = 0;
           #camacc01#0  = #camaniva#0;
           #camacc01#1  = #camaniva#1;
           |LEE 040#camacc01.=;
           |SI FSalida ! 0;  enSwCaja = 0; aClaveOpe = ""; |FINSI;
       |FINSI;
       |SI enSwCaja = 0;
           |SI #dsmom030#28 = 7; aClaveOpe = "02"; |FINSI;
       |FINSI;
  |FINSI;
|FPRC;

/*
|PROCESO ParaNif;
   eaCodNif = aCIF;
   |HAZ LeeNifs;
   |HAZ CalTipoNif;
   #900#65 = aAlfa;
|FPRC;
*/

|| ... Graba el Auxiliar
|PROCESO Cabw176;   || Soportado
        |DDEFECTO #dsmow176;
        #dsmow176#0  = nClave;
        #dsmow176#1  = enEjer;
        #dsmow176#2  = aPeriodo;
        #dsmow176#3  = aTipoFra;
        #dsmow176#30 = ""; |SI #900#77 > 0; #dsmow176#30 = #900#77; |FINSI;
        #dsmow176#31 = ""; |SI #900#71 > 0; #dsmow176#31 = #900#71; |FINSI;

        #dsmow176#6  = #900#79;
        #dsmow176#7  = #900#81;
        #dsmow176#8  = #900#22;
        #dsmow176#9  = "";
        aAlfa = #900#16; |QBF aAlfa;
        |SI aAlfa ! ""; aAlfa = aAlfa + "/"; |FINSI;
        aAlfa = aAlfa + #900#17;
        #dsmow176#10 = aAlfa;
        |SI #camaniva#38 > 1;
            nNume1 = #900#17 + (#camaniva#38) - 1;
            aAlfa  = nNume1;
            #dsmow176#11  = aAlfa;
        |FINSI;
        #dsmow176#12 = (#900#65 % 402);
        #dsmow176#13 = (#900#65 % 103);
        #dsmow176#14 = #900#21;
        #dsmow176#15 = #900#20;

        #dsmow176#16 = aClaveOpe;
|FPRC;

|PROCESO Cabw175;  || Repercutido
        |DDEFECTO #dsmow175;
        #dsmow175#0  = nClave;
        #dsmow175#1  = enEjer;
        #dsmow175#2  = aPeriodo;
        #dsmow175#3  = aTipoFra;
        #dsmow175#29 = ""; |SI #900#77 > 0; #dsmow175#29 = #900#77; |FINSI;
        #dsmow175#30 = ""; |SI #900#71 > 0; #dsmow175#30 = #900#71; |FINSI;

        #dsmow175#6  = #900#79;
        #dsmow175#7  = #900#81;
        #dsmow175#8  = #900#16;
        #dsmow175#9  = #900#17;
        |SI #camaniva#38 > 1;
            nNume1 = #900#17 + (#camaniva#38) - 1;
            aAlfa  = nNume1;
            #dsmow175#10  = aAlfa;
        |FINSI;
        |HAZ NuevoCalFraRep;

        #dsmow175#11  = (#900#65 % 402);
        #dsmow175#12  = (#900#65 % 103);
        #dsmow175#13  = #900#21;
        #dsmow175#14  = #900#20;

        #dsmow175#16 = aClaveOpe;
|FPRC;

|PROCESO Graba_Req_RECC;
    nClave = nClave + 1;

    |SI aTipoIVA = "S"; |O aTipoIVA = "G";

        |SI aTipoIVA = "S"; |HAZ Cabw176;  |FINSI;
        |SI aTipoIVA = "G"; |HAZ Cabw176G; |FINSI;
        #dsmow176#24 = fFechaPago;
        #dsmow176#25 = nImporPago;
        #dsmow176#26 = aMedioPago;
        #dsmow176#27 = aDesPago;

        |GRABA 020#dsmow176.n;
    |FINSI;

    |SI aTipoIVA = "R"; |O aTipoIVA = "I";

        |SI aTipoIVA = "R"; |HAZ Cabw175;   |FINSI;
        |SI aTipoIVA = "I"; |HAZ Cabw175I;  |FINSI;
        #dsmow175#23 = fFechaPago;
        #dsmow175#24 = nImporPago;
        #dsmow175#25 = aMedioPago;
        #dsmow175#26 = aDesPago;

        |GRABA 020#dsmow175.n;
    |FINSI;
|FPRC;

|PROCESO Graba_Req;

    nClave = nClave + 1;
    |SI aTipoIVA = "S";

        |HAZ Cabw176;
        #dsmow176#17 = nLBase + nLCuoI + nLCuoIN;
        #dsmow176#18 = nLBase;
        #dsmow176#19 = nLTipoI;
        #dsmow176#20 = nLCuoI + nLCuoIN;
        #dsmow176#21 = nLCuoI;
        #dsmow176#22 = nLTipoR;
        #dsmow176#23 = nLCuoR;

        |GRABA 020#dsmow176.n;
    |FINSI;

    |SI aTipoIVA = "R";

        |HAZ Cabw175;
        #dsmow175#17 = nLBase + nLCuoI + nLCuoR;
        #dsmow175#18 = nLBase;
        #dsmow175#19 = nLTipoI;
        #dsmow175#20 = nLCuoI;
        #dsmow175#21 = nLTipoR;
        #dsmow175#22 = nLCuoR;

        |GRABA 020#dsmow175.n;
    |FINSI;
|FPRC;

|| **********************************************************************
|PROCESO camacc02;
    fFechaPago = #camacc02#4;
    nImporPago = #camacc02#10;
    aAlfa = #camacc02#15 - "DEVENGO";
    |SI FSalida ! 0;
        aMedioPago = "03";
    |SINO;
        |SI #camacc02#14 = "T"; aMedioPago = "01"; |FINSI;
        |SI #camacc02#14 = "C"; aMedioPago = "02"; |FINSI;
        |SI #camacc02#14 = "O"; aMedioPago = "04"; |FINSI;
    |FINSI;
    aDesPago = #camacc02#15;

    |HAZ Graba_Req_RECC;
|FPRC;

|DEFBUCLE camacc02;
    #camacc02#1;
    ;
    0000, #camaniva#0, #camaniva#1, 01;
    0000, #camaniva#0, #camaniva#1, 99;
    e;
    NULL, camacc02;
|FIN;

|| **************************************

|PROCESO Auxiliar57;

 |SI nOperacion = 0;
     nCampo = nCampo + 1;
 |FINSI;

 |SI nOperacion = 1;
     nLBase  = #dsmow157#1;
     nLTipoI = #dsmow157#2;
     nLCuoI  = #dsmow157#3;
     nLTipoR = #dsmow157#4;
     nLCuoR  = #dsmow157#5;
     nLCuoIN = #dsmow157#6;
     nLCuoRN = #dsmow157#7;
     |SI nLCuoI = 0; |Y nLCuoIN = 0; nLTipoI = 0; |FINSI;
     |SI nLCuoR = 0; |Y nLCuoRN = 0; nLTipoR = 0; |FINSI;
     |SI nLBase ! 0; |O nLCuoI ! 0; |O nLCuoR ! 0; |O nLCuoIN ! 0; |O nLCuoRN ! 0;
         |HAZ Graba_Req;
         SwLinea = SwLinea + 1;
     |FINSI;
 |FINSI;
|FPRC;

|DEFBUCLE Auxiliar57;
  #dsmow157#1;
  ;
  nPara1,  000,  000;
  nPara1, 1000, 1000;
  ;
  NULL, Auxiliar57;
|FIN;

|PROCESO VariasLineas;

 SwLinea = 0;
 nLBasP = #900#66;
 nLTipP = #900#67;
 nLCuoP = #900#68;
 |PARA nPara1 = 23; |SI nPara1 [ 27; |HACIENDO nPara1 = nPara1 + 1;
       nCampo = 0;
       nOperacion = 0; |BUCLE Auxiliar57;
       |SI nCampo [ 1;
           nLBase = #900nPara1;
           nNume1 = nPara1 +  6; nLTipoI = #900nNume1;
           nNume2 = nPara1 + 11; nLCuoI  = #900nNume2;
           nNume3 = nPara1 + 17; nLTipoR = #900nNume3;
           nNume4 = nPara1 + 22; nLCuoR  = #900nNume4;
           nNume5 = nPara1 + 29; nLCuoIN = #900nNume5;
           nNume6 = nPara1 + 35; nLCuoRN = #900nNume6;
           |SI nLCuoI = 0; nLTipoI = 0; |FINSI;
           |SI nLCuoR = 0; nLTipoR = 0; |FINSI;

           |SI nLBase ! 0; |O nLCuoI ! 0; |O nLCuoR ! 0;  |O nLCuoIN ! 0; |O nLCuoRN ! 0;
               |HAZ Graba_Req;
               SwLinea = SwLinea + 1;
           |FINSI;
       |SINO;
           nOperacion = 1; |BUCLE Auxiliar57;
       |FINSI;
 |SIGUE;

 |SI SwLinea = 0;
     |HAZ Graba_Req;
     SwLinea = 1;
 |FINSI;

 |SI enSwCaja = 1;
    |BUCLE camacc02;
 |FINSI;

|FPRC;

|PROCESO LinLibro0;

  aAlfa1 = #caivalin#30; |QBF aAlfa1; |SI aAlfa1 = ""; #caivalin#30 = #camaniva#10; |FINSI;
  |SI enActividad ! 0;      ||quiere separar por actividades
      |SI aMulDep = "S";
          nElDepar = #caivalin#30;
          |SI nElDepar = 0;  nElDepar = 1; |FINSI;
          |SI enActividad ! nElDepar; nAlNo = 1; |ACABA; |FINSI;
       |FINSI;
  |FINSI;

  |SI aMulDep = "S";
      nElDepar = #caivalin#30;
      |SI nElDepar = 0;  nElDepar = 1; |FINSI;
      |SI nElDepar < #dsmoy096#46; |O nElDepar > #dsmoy096#47; nAlNo = 1; |ACABA; |FINSI;
  |FINSI;

  nAlSi = 1;
  |SI nOpMdep = 0;  |ACABA;  |FINSI;  || Solo comprueba que exista

  enConcepto = #caivalin#3;
  |SI enSwSelCp = 1;
      |HAZ CtrlConcepto;
      |SI enSwConcep = 1;
          |ACABA;
      |FINSI;
  |FINSI;

  nAlConcepto = 1;
  |SI nOpMdep = 2;  |ACABA;  |FINSI;  || Solo comprueba que exista

  #caivalin#6  = (#caivalin#6  / enConversor) ! EURODBMOD;
  #caivalin#8  = (#caivalin#8  / enConversor) ! EURODBMOD;
  #caivalin#10 = (#caivalin#10 / enConversor) ! EURODBMOD;
  #caivalin#20 = (#caivalin#20 / enConversor) ! EURODBMOD;
  #caivalin#22 = (#caivalin#22 / enConversor) ! EURODBMOD;

  |SI aTipoIVA = "R";
      |HAZ SumaRepercutido;
  |SINO;
      |HAZ SumaSoportado;
  |FINSI;
|FPRC;

|PROCESO SumaRepercutido;
 nCampo = -1;
 |SI #caivalin#7 = 0;               ||  0%
     #900#27 = #900#27 + #caivalin#6;
     #900#28 = #900#28 + #caivalin#6;
 |SINO;
     #900#28 = #900#28 + #caivalin#6;
     #900#39 = #900#39 + #caivalin#8;
     |SI #caivalin#7 = 4;         ||  4%
         #900#23 = #900#23 + #caivalin#6;
         #900#29 = #caivalin#7;
         #900#34 = #900#34 + #caivalin#8;
         nCampo = 23;
     |SINO;
         |SI #caivalin#7 = 7; |O #caivalin#7 = 8; |O #caivalin#7 = 10;  ||  7% 8% 10%
             #900#24 = #900#24 + #caivalin#6;
             #900#30 = #caivalin#7;
             #900#35 = #900#35 + #caivalin#8;
             nCampo = 24;
         |SINO;
             |SI #caivalin#7 = 16;  |O #caivalin#7 = 18; |O #caivalin#7 = 21;   || 16% 18%
                 #900#25 = #900#25 + #caivalin#6;
                 #900#31 = #caivalin#7;
                 #900#36 = #900#36 + #caivalin#8;
                 nCampo = 25;
             |SINO;
                 #900#26 = #900#26 + #caivalin#6;   || ??%
                 #900#32 = #caivalin#7;
                 #900#37 = #900#37 + #caivalin#8;
                 nCampo = 26;
             |FINSI;
         |FINSI;
     |FINSI;
  |FINSI;

 |SI #caivalin#9 ! 0;
     #900#50 = #900#50 + #caivalin#10;
     |SI #caivalin#9 = 0.50;
         #900#40 = #caivalin#9;
         #900#45 = #900#45 + #caivalin#10;
     |SINO;
         |SI #caivalin#9 = 1; |O #caivalin#9 = 1.40;   || 1
             #900#41 = #caivalin#9;
             #900#46 = #900#46 + #caivalin#10;
         |SINO;
             |SI #caivalin#9 = 4; |O #caivalin#9 = 5.20; || 4%
                 #900#42 = #caivalin#9;
                 #900#47 = #900#47 + #caivalin#10;
             |SINO;
                 #900#43 = #caivalin#9;
                 #900#48 = #900#48 + #caivalin#10; || %
             |FINSI;
         |FINSI;
     |FINSI;
 |FINSI;

 #900#51 = #900#51 + #caivalin#6 + #caivalin#8 + #caivalin#10;

 #900#66 = #900#66 + #caivalin#20;
 #900#67 = #caivalin#21;
 #900#68 = #900#68 + #caivalin#22;

|| ... Graba Detalle %
     |SI nCampo ! -1;
         |ABRE #dsmow157;
         #dsmow157#0 = nCampo;
         #dsmow157#2 = #caivalin#7;
         #dsmow157#4 = #caivalin#9;
         |LEE 041#dsmow157.=;
         |SI FSalida ! 0;
             |DDEFECTO #dsmow157;
             #dsmow157#0 = nCampo;
             #dsmow157#2 = #caivalin#7;
             #dsmow157#4 = #caivalin#9;
             |GRABA 020#dsmow157.c;
         |FINSI;
         #dsmow157#1  = #dsmow157#1 + #caivalin#6;
         #dsmow157#2  = #caivalin#7;
         #dsmow157#3  = #dsmow157#3 + #caivalin#8;
         #dsmow157#4  = #caivalin#9;
         #dsmow157#5  = #dsmow157#5 + #caivalin#10;
         |GRABA 020#dsmow157.a;
         |CIERRA #dsmow157;
     |FINSI;
|FPRC;

|PROCESO SumaSoportado;
 nCampo = -1;
 |SI #caivalin#7 = 0;               ||  0%
     #900#27 = #900#27 + #caivalin#6;
     #900#28 = #900#28 + #caivalin#6;
 |SINO;
     #900#28 = #900#28 + #caivalin#6;
     |SI #caivalin#5 = "S";
          #900#39 = #900#39 + #caivalin#8;
          |SI #caivalin#7 = 4;         ||  4%
              #900#23 = #900#23 + #caivalin#6;
              #900#29= #caivalin#7;
              #900#34 = #900#34 + #caivalin#8;
              nCampo = 23;
          |SINO;
              |SI #caivalin#7 = 7; |O #caivalin#7 = 8; |O #caivalin#7 = 10;  ||  7% y 8% 10%
                  #900#24 = #900#24 + #caivalin#6;
                  #900#30 = #caivalin#7;
                  #900#35 = #900#35 + #caivalin#8;
                  nCampo = 24;
              |SINO;
                  |SI #caivalin#7 = 16;  |O #caivalin#7 = 18;  |O #caivalin#7 = 21;    || 16% 18 % 21%
                      #900#25 = #900#25 + #caivalin#6;
                      #900#31 = #caivalin#7;
                      #900#36 = #900#36 + #caivalin#8;
                      nCampo = 25;
                  |SINO;
                      #900#26 = #900#26 + #caivalin#6;   || ??%
                      #900#32 = #caivalin#7;
                      #900#37 = #900#37 + #caivalin#8;
                      nCampo = 26;
                  |FINSI;
              |FINSI;
          |FINSI;
      |SINO;                                    ||NO DEDUCIBLE
          #900#57 = #900#57 + #caivalin#8;
          |SI #caivalin#7 = 4;         ||  4%
              #900#23 = #900#23 + #caivalin#6;
              #900#29 = #caivalin#7;
              #900#52 = #900#52 + #caivalin#8;
              nCampo = 23;

          |SINO;
              |SI #caivalin#7 = 7; |O #caivalin#7 = 8; |O #caivalin#7 = 10;       ||  7% 8% 10%
                  #900#24 = #900#24 + #caivalin#6;
                  #900#30 = #caivalin#7;
                  #900#53 = #900#53 + #caivalin#8;
                  nCampo = 24;
              |SINO;
                  |SI #caivalin#7 = 16; |O #caivalin#7 = 18; |O #caivalin#7 = 21;   || 16% 18% 21%
                      #900#25 = #900#25 + #caivalin#6;
                      #900#31 = #caivalin#7;
                      #900#54 = #900#54 + #caivalin#8;
                      nCampo = 25;
                  |SINO;
                      #900#26 = #900#26 + #caivalin#6;   || ??%
                      #900#32 = #caivalin#7;
                      #900#55 = #900#55 + #caivalin#8;
                      nCampo = 26;
                  |FINSI;
              |FINSI;
          |FINSI;
     |FINSI;
  |FINSI;

  |SI #caivalin#9 ! 0; |Y #caivalin#5 = "S";
      #900#50 = #900#50 + #caivalin#10;
      |SI #caivalin#9 = 0.5;        || 0.5%
          #900#40 = #caivalin#9;
          #900#45 = #900#45 + #caivalin#10;
      |SINO;
          |SI #caivalin#9 = 1; |O #caivalin#9 = 1.40;   || 1%
              #900#41 = #caivalin#9;
              #900#46 = #900#46 + #caivalin#10;
         |SINO;
              |SI #caivalin#9 = 4; |O #caivalin#9 = 5.20; || 4
                  #900#42 = #caivalin#9;
                  #900#47 = #900#47 + #caivalin#10;
             |SINO;
                 #900#43 = #caivalin#9;
                 #900#48 = #900#48 + #caivalin#10; || %
             |FINSI;
         |FINSI;
     |FINSI;
 |FINSI;

 |SI #caivalin#9 ! 0; |Y #caivalin#5 = "N";
     #900#63 = #900#63 + #caivalin#10;
     |SI #caivalin#9 = 0.5;        || 0.5%
         #900#40 = #caivalin#9;
         #900#58 = #900#58 + #caivalin#10;
     |SINO;
         |SI #caivalin#9 = 1; |O #caivalin#9 = 1.40;   || 1.5%
             #900#41 = #caivalin#9;
             #900#59 = #900#59 + #caivalin#10;
         |SINO;
             |SI #caivalin#9 = 4; |O #caivalin#9 = 5.20; || 1%
                 #900#42 = #caivalin#9;
                 #900#60 = #900#60 + #caivalin#10;
             |SINO;
                 #900#43 = #caivalin#9;
                 #900#61 = #900#61 + #caivalin#10; || %
             |FINSI;
         |FINSI;
     |FINSI;
 |FINSI;

 #900#51 = #900#51 + #caivalin#6 + #caivalin#8 + #caivalin#10;

 #900#66 = #900#66 + #caivalin#20;
 #900#67 = #caivalin#21;
 #900#68 = #900#68 + #caivalin#22;

|| ... Graba Detalle %
     |SI nCampo ! -1;
         |ABRE #dsmow157;
         #dsmow157#0 = nCampo;
         #dsmow157#2 = #caivalin#7;
         #dsmow157#4 = #caivalin#9;
         |LEE 041#dsmow157.=;
         |SI FSalida ! 0;
             |DDEFECTO #dsmow157;
             #dsmow157#0 = nCampo;
             #dsmow157#2 = #caivalin#7;
             #dsmow157#4 = #caivalin#9;
             |GRABA 020#dsmow157.c;
         |FINSI;
         #dsmow157#1  = #dsmow157#1 + #caivalin#6;
         #dsmow157#2  = #caivalin#7;
         #dsmow157#4  = #caivalin#9;
         |SI #caivalin#5 = "S";
             #dsmow157#3  = #dsmow157#3 + #caivalin#8;
             #dsmow157#5  = #dsmow157#5 + #caivalin#10;
         |SINO;
             #dsmow157#6  = #dsmow157#6 + #caivalin#8;
             #dsmow157#7  = #dsmow157#7 + #caivalin#10;
         |FINSI;
         |GRABA 020#dsmow157.a;
         |CIERRA #dsmow157;
     |FINSI;
|FPRC;

|DEFBUCLE LinLibro;
 #caivalin#1;
 ;
 #camaniva#0,#camaniva#1,001;
 #camaniva#0,#camaniva#1,999;
 ;
 NULL, LinLibro0;
|FIN;

|PROCESO Facturas;
   |SI aMulDep ! "S";
       nElDepar = #camaniva#10;
       |SI nElDepar = 0;  nElDepar = 1;  |FINSI;
       |SI nElDepar < #dsmoy096#46; |O nElDepar > #dsmoy096#47; |ACABA; |FINSI;
   |SINO;
        nOpMdep = 0;
        nAlSi   = 0;
        nAlNo   = 0;
        |BUCLE LinLibro;
        |SI nAlSi = 0; |ACABA; |FINSI;
   |FINSI;

|| ................ Comprueba que los conceptos de facturas son buenos
   |SI enSwSelCp = 1;
        nOpMdep     = 2;
        nAlConcepto = 0;
        |BUCLE LinLibro;
        |SI nAlConcepto = 0; |ACABA; |FINSI;
   |FINSI;

   |HAZ DatosFacturas;

   |BUCLE LinLibro;

   |SI fLaFecha ] #dsmoy096#40;
       |HAZ VariasLineas;
       SwHayDatos = 1;
   |FINSI;

   nFactura = nFactura + 1;
|FPRC;

|DEFBUCLE Facturas3;
   #camaniva#3;
   4,36;
   01, "     ", 000001, fDFecha, aDTipo;
   99, "zzzzz", 999999, fHFecha, aHTipo;
   ;
   NULL, Facturas;
|FIN;

|PROCESO LibroIVA;
    aDTipo = "R"; aHTipo = "S";
    |SI enSwSelCp = 0;
        aDTipo = aTipoIVA; aDTipo = aDTipo > " ";
        aHTipo = aTipoIVA; aHTipo = aHTipo > " ";
    |FINSI;

    |SI nAbreLibro = 0;
        |HAZ AbreLibro;
    |FINSI;

    |HAZ NombreHoja;
    SwHayDatos = 0;

    || ... Creo auxiliar.
    |DELINDEX #dsmow175;
    |DELINDEX #dsmow176;

    |SI aTipoIVA = "R";
        enModelo = 901;
    |SINO;
        enModelo = 902;
    |FINSI;
    |HAZ LeeCtrlLibro;

    |ABRE #dsmow175;
    |ABRE #dsmow176;
    |ABRE #camacc01;
    nFactura = 0;
    fDFecha  = #dsmoy096#40;
    fHFecha  = #dsmoy096#41;
    |BUCLE Facturas3;
    |CIERRA #camacc01;

    enError = 0;

    |CIERRA #dsmow176;
    |CIERRA #dsmow175;

    |SI SwHayDatos = 1;
        |HAZ FinalLibro;
    |FINSI;
|FPRC;

|| *************************************************************************
|PROCESO Cabw176G;   || Gastos
        |DDEFECTO #dsmow176;
        #dsmow176#0  = nClave;
        #dsmow176#1  = enEjer;
        #dsmow176#2  = aPeriodo;
        #dsmow176#3  = aTipoFra;

        #dsmow176#30 = ""; |SI #900#77 > 0; #dsmow176#30 = #900#77; |FINSI;
        #dsmow176#31 = ""; |SI #900#71 > 0; #dsmow176#31 = #900#71; |FINSI;

        #dsmow176#4  = #dsmow054#23;
        #dsmow176#5  = #dsmow054#9;

        #dsmow176#6  = #900#79;
        |SI nSwSiHay = 1;
            |SI aAsto12 = "R"; |O aAsto12 = "S";
                #dsmow176#7  = #900#81;
                #dsmow176#8  = #900#22;
                #dsmow176#9  = "";
                aAlfa = #900#16; |QBF aAlfa;
                |SI aAlfa ! ""; aAlfa = aAlfa + "/"; |FINSI;
                aAlfa = aAlfa + #900#17;
                #dsmow176#10 = aAlfa;
                |SI #camaniva#38 > 1;
                    nNume1 = #900#17 + (#camaniva#38) - 1;
                    aAlfa  = nNume1;
                    #dsmow176#11  = aAlfa;
                |FINSI;
            |SINO;
                aAlfa = ("00" + nAsto0) % -102;
                aAlfa = aAlfa + ("000000" + nAsto2) % -106;
                aAlfa = aAlfa + ("0000" + #dsmow054#21) % -104;
                #dsmow176#10 = aAlfa;
            |FINSI;

            #dsmow176#12 = (#900#65 % 402);
            #dsmow176#13 = (#900#65 % 103);
            #dsmow176#14 = #900#21;
            #dsmow176#15 = #900#20;
        |SINO;
            aAlfa = ("00" + nAsto0) % -102;
            aAlfa = aAlfa + ("000000" + nAsto2) % -106;
            aAlfa = aAlfa + ("0000" + #dsmow054#21) % -104;
            #dsmow176#10 = aAlfa;
            #dsmow176#12 = (#900#65 % 402);
            #dsmow176#13 = (#900#65 % 103);
            #dsmow176#14 = #dsmow054#5;
            #dsmow176#15 = #dsmow054#4;
        |FINSI;
        #dsmow176#16 = aClaveOpe;
|FPRC;

|PROCESO Cabw175I;  || Ingresos
        |DDEFECTO #dsmow175;
        #dsmow175#0  = nClave;
        #dsmow175#1  = enEjer;
        #dsmow175#2  = aPeriodo;
        #dsmow175#3  = aTipoFra;

        #dsmow175#29 = ""; |SI #900#77 > 0; #dsmow175#29 = #900#77; |FINSI;
        #dsmow175#30 = ""; |SI #900#71 > 0; #dsmow175#30 = #900#71; |FINSI;

        #dsmow175#4  = #dsmow054#23;
        #dsmow175#5  = #dsmow054#9;

        #dsmow175#6  = #900#79;
        |SI nSwSiHay = 1;
            |SI aAsto12 = "R"; |O aAsto12 = "S";
                #dsmow175#7  = #900#81;
                #dsmow175#8  = #900#16;
                #dsmow175#9  = #900#17;
                |SI #camaniva#38 > 1;
                    nNume1 = #900#17 + (#camaniva#38) - 1;
                    aAlfa  = nNume1;
                    #dsmow175#10  = aAlfa;
                |FINSI;
                |HAZ NuevoCalFraRep;
            |FINSI;

            #dsmow175#11  = (#900#65 % 402);
            #dsmow175#12  = (#900#65 % 103);
            #dsmow175#13  = #900#21;
            #dsmow175#14  = #900#20;
        |SINO;
            #dsmow175#11  = (#900#65 % 402);
            #dsmow175#12  = (#900#65 % 103);
            #dsmow175#13  = #dsmow054#5;
            #dsmow175#14  = #dsmow054#4;
        |FINSI;
        #dsmow175#16 = aClaveOpe;

|FPRC;

|PROCESO Graba_InGasto;

   enActividad = #dsmow054#30;
   |HAZ LeeDatosActividad;

   nLBase   = #dsmow054#10;
   nLTipoI  = #dsmow054#16;
   nLCuoI   = #dsmow054#11;
   nLCuoIN  = #dsmow054#14;
   nLTipoR  = #dsmow054#17;
   nLCuoR   = #dsmow054#12 + #dsmow054#15;
   |SI nSw = 1; |Y aAsto12 = "N";
       #dsmow054#18 = 0;
       #dsmow054#13 = 0;
   |FINSI;

||   |SI aAsto12 = "N"; aTipoFra = "SF"; |FINSI;

   nClave = nClave + 1;
   |SI aTipoIVA = "G";

        |HAZ Cabw176G;
        #dsmow176#17 = #dsmow054#22;
        #dsmow176#18 = nLBase;
        #dsmow176#19 = nLTipoI;
        #dsmow176#20 = nLCuoI + nLCuoIN;
        #dsmow176#21 = nLCuoI;
        #dsmow176#22 = nLTipoR;
        #dsmow176#23 = nLCuoR;
        #dsmow176#28 = #dsmow054#18;
        #dsmow176#29 = #dsmow054#13;
        |GRABA 020#dsmow176.n;
    |FINSI;

    |SI aTipoIVA = "I";

        |HAZ Cabw175I;
        #dsmow175#17 = #dsmow054#22;
        #dsmow175#18 = nLBase;
        #dsmow175#19 = nLTipoI;
        #dsmow175#20 = nLCuoI;
        #dsmow175#21 = nLTipoR;
        #dsmow175#22 = nLCuoR;
        #dsmow175#27 = #dsmow054#18;
        #dsmow175#28 = #dsmow054#13;

        |GRABA 020#dsmow175.n;
    |FINSI;
    nSw = 1;
|FPRC;

|DEFBUCLE LeeAuxi54;
 #dsmow054#1;
 ;
 fAsto1, nConta, 00;
 fAsto1, nConta, 99;
 ;
 NULL, Graba_InGasto;
|FIN;

|PROCESO GrabaLosBuenos;
  nSw     = 0
  |CIERRA #dsmow054;
  |BUCLE LeeAuxi54;
  |ABRE  #dsmow054;

  |SI enSwCaja = 1; |Y wTodoExcel = 1;
     |BUCLE camacc02;
  |FINSI;
|FPRC;

|| /////////////////////////////////////////////////////////////////
|PROCESO Lee60;
 |DDEFECTO #dsmom060;
 #dsmom060#6 = enPlan60;
 #dsmom060#0 = "N";
 #dsmom060#1 = aTipoIVA;
 #dsmom060#2 = nSwCol;
 |LEE 001#dsmom060.=;
 |SI FSalida = 0;
     aAlfa1 = #dsmom060#4; |QBF aAlfa1;
     |SI aAlfa1 = "";
         #dsmom060#4 = #dsmom060#3;
     |FINSI;
 |FINSI;
|FPRC;

|PROCESO BuscoLaLinea;
     nSuma = 0;
     |SI #camaasil#12 ! "N";
         |SI #camaasil#20 ! 0;
             |SI #camaasil#20 = #caivalin#2; nSuma = 1; |FINSI;
         |SINO;
             |SI #camaasil#4 = #caivalin#12; nSuma = 1; |FINSI;
         |FINSI;

         |SI #camaasil#19 = "I";
             |SI nSuma = 1; #dsmow054#22 = nImporte; |FINSI;
             nSuma = 0;
         |FINSI;

         |SI nSuma = 1;
             #dsmow054#10 = #dsmow054#10 + #caivalin#6;
             |SI #caivalin#5 = "S"; |O #camaasil#12 = "I";
                 #dsmow054#11 = #dsmow054#11 + #caivalin#8;
                 #dsmow054#12 = #dsmow054#12 + #caivalin#10;
             |SINO;
                 #dsmow054#14 = #dsmow054#14 + #caivalin#8;
                 #dsmow054#15 = #dsmow054#15 + #caivalin#10;
             |FINSI;
             #dsmow054#16 = #caivalin#7;
             #dsmow054#17 = #caivalin#9;

             #dsmow054#13 = #dsmow054#13 + #caivalin#22;
             #dsmow054#18 = #caivalin#21;
             #dsmow054#22 = #dsmow054#22 + #caivalin#6 + #caivalin#8  + #caivalin#10;; || 70000_10539 - #caivalin#22;
         |FINSI;
     |SINO;
          #dsmow054#13 = #dsmow054#13 + #caivalin#22;
          #dsmow054#18 = #caivalin#21;
          #dsmow054#22 = nImporte;
     |FINSI;
|FPRC;

|DEFBUCLE BuscoLaLinea;
   #caivalin#1;
   ;
   nLibro, nRegistro, 01;
   nLibro, nRegistro, 99;
   e;
   NULL, BuscoLaLinea;
|FIN;

|PROCESO BuscoFra;
   aNomCta = #camaniva#13;
   aDesCon = #camaniva#28;
   aCIF    = #camaniva#14;
   nSwSiHay = 1;
   |HAZ DatosFacturas;
   nLibro    = #camaniva#0;
   nRegistro = #camaniva#1;
   |SI #camaniva#36 = "N";
       nQuants = nQuants + 1;
   |FINSI;
|FPRC;

|DEFBUCLE BuscoFra;
   #camaniva#3;
   7,8,9;
   #camaasil#13, #camaasil#15, #camaasil#14, #camaasil#0, #camaasil#1, #camaasil#2;
   #camaasil#13, #camaasil#15, #camaasil#14, #camaasil#0, #camaasil#1, #camaasil#2;
   e;
   NULL, BuscoFra;
|FIN;

|PROCESO LeeCta;
   aClaveOpe = "";
   aNomCta   = "";
   aDesCon   = "";
   aCIF      = "";
   nSwSiHay  = 0;
   nQuants   = 0;

   enSwCaja  = 0
   aTipoFra  = "SF";
   aPeriodo  = "1T";
   aAlfa = #camaasil#1; aAlfa = aAlfa % 402; nNume1 = aAlfa;
   |SI nNume1 > 3; |Y nNume1 [ 6; aPeriodo = "2T"; |FINSI;
   |SI nNume1 > 6; |Y nNume1 [ 9; aPeriodo = "3T"; |FINSI;
   |SI nNume1 > 9;                aPeriodo = "4T"; |FINSI;

   |PDEFECTO #900, 16, 72;
   #900#51 = nImporte;
   #900#79 = #camaasil#1;
   #900#77 = #camaasil#1;
   #900#81 = "01.01.0000";
   #900#82 = "";
   #900#83 = 0;
   #900#84 = 0;
   #900#65 = "";
   |BUCLE BuscoFra;
   |SI nSwSiHay = 0; |O nQuants > 1;
       aCta = "";
       |ABRE #calicont;
       #calicont#0 = #camaasil#0;
       #calicont#1 = #camaasil#1;
       #calicont#2 = #camaasil#2;
       #calicont#3 = #camaasil#3;
       |LEE 001#calicont.=;
       |SI FSalida = 0;
           aCta = #calicont#4;
       |SINO;
           |ABRE #camaasic;
           #camaasic#0 = #camaasil#0;
           #camaasic#1 = #camaasil#1;
           #camaasic#2 = #camaasil#2;
           |LEE 001#camaasic.=;
           |SI FSalida = 0;
               |SI #camaasil#8 = "D"; aCta = #camaasic#10; |FINSI;
               |SI #camaasil#8 = "H"; aCta = #camaasic#8;  |FINSI;
           |FINSI;
           |CIERRA #camaasic;
       |FINSI;
       |CIERRA #calicont;
       |QBF aCta;
       |SI aCta = ""; aCta = #camaasil#4; |FINSI;

       |ABRE #cacuenta;
       #cacuenta#0  = aCta;
       |LEE 001#cacuenta.=;
       |SI FSalida = 0;
           aNomCta = #cacuenta#2;
       |FINSI;
       |CIERRA #cacuenta;
   |FINSI;
   aDesCon = #camaasil#7;

   |SI wTodoExcel = 0;
       aClaveOpe = "";
   |FINSI;
|FPRC;

|PROCESO Graba_w54;

   |SI nConta = 0;
       nAsto0  = #camaasil#0;
       fAsto1  = #camaasil#1;
       nAsto2  = #camaasil#2;
       aAsto12 = #camaasil#12;
       nAsto13 = #camaasil#13;
       nAsto14 = #camaasil#14;
       aAsto15 = #camaasil#15;
       aAsto26 = #camaasil#26;
       nConta  = 1;
   |FINSI;

   |SI nAsto0 ! #camaasil#0; |O fAsto1 ! #camaasil#1; |O nAsto2 ! #camaasil#2;
      |O aAsto12 ! #camaasil#12; |O nAsto13 ! #camaasil#13; |O nAsto14 ! #camaasil#14;
        |O aAsto15 ! #camaasil#15;

        |HAZ GrabaLosBuenos;
        nConta    = nConta + 1;
        nLibro    = 0;
        nRegistro = 0;
        nLinea    = 0;
   |FINSI;

   nLinea = nLinea + 1;
   #dsmow054#0  = #camaasil#1;
   #dsmow054#1  = nConta;
   #dsmow054#25 = nLinea;
   |LEE 041#dsmow054.=;
   |SI FSalida ! 0;

       |DDEFECTO #dsmow054;
       #dsmow054#0  = #camaasil#1;
       #dsmow054#1  = nConta;
       #dsmow054#25 = nLinea;

      aAlfa1 = #dsmow054#0;
      #dsmow054#2 = aAlfa1 % 105;

      |HAZ LeeCta;
      #dsmow054#4 = aNomCta;
      #dsmow054#5 = aCIF;
      #dsmow054#6 = aDesCon;
      #dsmow054#7 = #camaasil#4;
      |GRABA 020#dsmow054.c;
  |FINSI;

  #dsmow054#21 = #camaasil#3;
  #dsmow054#22 = nImporte;
  #dsmow054#8  = nSwCol;                      ||para ampliar
  #dsmow054#9  = #dsmow054#9 + nImporte;
  |SI nSwSiHay = 1;
      #dsmow054#22 = 0;
      |BUCLE BuscoLaLinea;
  |FINSI;

  #dsmow054#23 = #dsmom060#7;
  #dsmow054#24 = #dsmom060#3;
  #dsmow054#26 = #camaasil#26;
  #dsmow054#27 = #camaasil#13;
  |SI #camaasil#12 ! "N";
      #dsmow054#28 = #camaasil#15;
      #dsmow054#29 = #camaasil#14;
  |FINSI;
  #dsmow054#30 = #camaasil#21;

  |GRABA 020#dsmow054.a;

  nAsto0  = #camaasil#0;
  fAsto1  = #camaasil#1;
  nAsto2  = #camaasil#2;
  aAsto12 = #camaasil#12;
  nAsto13 = #camaasil#13;
  nAsto14 = #camaasil#14;
  aAsto15 = #camaasil#15;
  aAsto26 = #camaasil#26;
|FPRC;

|PROCESO MiraSiSuma;
  enClAgrupa = 0;
  #dsmom060#6 = #dsmom061#6;
  #dsmom060#0 = #dsmom061#0;
  #dsmom060#1 = #dsmom061#1;
  #dsmom060#2 = #dsmom061#2;
  |LEE 041#dsmom060.=;
  |SI FSalida = 0;
      eaClave60 = #dsmom060#7;
      eaTip60   = #dsmom060#1;
      |HAZ eClaveAgrupa;
   |FINSI;
|FPRC;

|PROCESO dsmom061_0;

 |HAZ MiraSiSuma;
 |SI enClAgrupa = 1; |ACABA; |FINSI;

 aAlfa3 = #dsmom061#4 % 101;
 aSignoE = "+"; |SI aAlfa3 = "7"; aSignoE = "-"; |FINSI;

 aAlfa1 = #dsmom061#4; |QBF aAlfa1;
 |SI aCta = aAlfa1; |Y aSignoE ! #dsmom061#5; |ACABA; |FINSI;

 aAlfa2 = aAlfa1 % 0; nNume1 = aAlfa2;
 aAlfa2 = (aAlfa1 + "zzzzzzzzzzzz") % nLongPart;
 aAlfa2 = (aAlfa2 + "            ") % 112;

 |SI aAlfa1 [ aHCta; |Y aAlfa2 ] aHCta;
     |SI nLongitud = 0; |O nLongitud [ nNume1;

         nSwCol     = #dsmom061#2;
         aSigno     = #dsmom061#5;
         aCondicion = #dsmom061#7;
         nLongitud  = nNume1;
     |FINSI;
 |FINSI;
|FPRC;

|DEFBUCLE dsmom061;
 #dsmom061#1;
 4;
 enPlan60, "N", aTipoIVA, 00, 001, aDCta;
 enPlan60, "N", aTipoIVA, 99, 999, aHCta;
 ;
 NULL, dsmom061_0;
|FIN;

|PROCESO Camaasil_0;

 #camaasil#9 = (#camaasil#9  / enConversor) ! EURODBMOD;

 nElDepar = #camaasil#21;
 |SI nElDepar = 0;  nElDepar = 1;  |FINSI;
 |SI nElDepar < #dsmoy096#46; |O nElDepar > #dsmoy096#47; |ACABA; |FINSI;

 enActividad = #camaasil#21;
 |HAZ LeeDatosActividad;

 |SI enSwSelCp = 1;
     enConcepto = #camaasil#6;

     |HAZ CtrlConcepto;
     |SI enSwConcep = 1;
         |ACABA;
     |FINSI;
 |FINSI;

 aCta = #camaasil#4; |QBF aCta;
 nLongitud = 0;
 nSwCol    = 0;
 aDCta     = aCta % 102;
 aHCta     = (aCta + "            ") % 112;
 |BUCLE dsmom061;
 |SI nSwCol ! 0;
     nImporte = #camaasil#9;
     |SI #camaasil#8 = "D"; |Y aSigno = "-"; nImporte = - nImporte; |FINSI;
     |SI #camaasil#8 = "H"; |Y aSigno = "+"; nImporte = - nImporte; |FINSI;
     |SI aCondicion = "P"; |Y nImporte < 0; nImporte = 0;|FINSI;
     |SI aCondicion = "N"; |Y nImporte > 0; nImporte = 0;|FINSI;
     |SI nImporte ! 0;
         |HAZ Lee60;
         |HAZ Graba_w54;
         SwHayDatos = 1;
     |FINSI;
 |FINSI;
|FPRC;

|DEFBUCLE Camaasil;
 #camaasil#1;
 ;
 01, fDFecha, 000001, 0001;
 98, fHFecha, 999999, 9999;
 e;
 NULL, Camaasil_0;
|FIN;

|PROCESO LibroIRPF;

    |SI nAbreLibro = 0;
        |HAZ AbreLibro;
    |FINSI;

    |HAZ NombreHoja;

    || ... Creo auxiliar.
    |DELINDEX #dsmow054;
    |DELINDEX #dsmow175;
    |DELINDEX #dsmow176;

    |SI aTipoIVA = "I";
        enModelo = 910;
    |SINO;
        enModelo = 911;
    |FINSI;
    |HAZ LeeCtrlLibro;

    SwHayDatos = 0;
    nLibro     = 0;
    nRegistro  = 0;
    nLinea     = 0;
    |ABRE #dsmow175;
    |ABRE #dsmow176;
    |ABRE #dsmom060;
    |ABRE #dsmow054;
    |ABRE #camacc01;
    nConta   = 0;
    nFactura = 0;
    fDFecha  = #dsmoy096#40;
    fHFecha  = #dsmoy096#41;
    |BUCLE Camaasil;
    |SI SwHayDatos = 1;
       |HAZ GrabaLosBuenos;
    |FINSI;
    |CIERRA #camacc01;
    |CIERRA #dsmow054;
    |CIERRA #dsmom060;
    |CIERRA #dsmow176;
    |CIERRA #dsmow175;

    |SI SwHayDatos = 1;
        |HAZ FinalLibro;
    |FINSI;
|FPRC;

|| *************************************************************************
|PROCESO Graba_w177;

     aPeriodo = nT + "T";

     nClave = nClave + 1;
     |DDEFECTO #dsmow177;
     #dsmow177#0  = nClave;
     #dsmow177#1  = enEjer;
     #dsmow177#2  = aPeriodo;
     #dsmow177#3  = #dsmom041#55;
     #dsmow177#36 = ""; |SI #900#77 > 0; #dsmow177#36 = #900#77; |FINSI;
     #dsmow177#37 = ""; |SI #900#71 > 0; #dsmow177#37 = #900#71; |FINSI;

     |SI aTipoIVA = "B";
         #dsmow177#4  = #dsmom041#56;
         #dsmow177#5  = #dsmom041#4;
     |FINSI;
     #dsmow177#6  = #dsmom041#9;

     |SI aTipoIVA = "B";
         #dsmow177#7  = nImporte;
         #dsmow177#8  = nImporte;
         #dsmow177#9  = aTAmor;
         #dsmow177#10 = nTCAmor;
         #dsmow177#11 = nAcumI;
         #dsmow177#12 = nAcumR;
         #dsmow177#13 = nAcumA;
         #dsmow177#14 = nValorRes;
     |FINSI;

     #dsmow177#15 = #dsmom041#27;
     #dsmow177#16 = #dsmom041#49;
     #dsmow177#17 = "";

     |SI aTipoIVA = "B";
         aAlfa = #dsmom041#61; |QBF aAlfa;
         |SI aAlfa ! ""; aAlfa = aAlfa + "/"; |FINSI;
         aAlfa = aAlfa + #dsmom041#62;
         #dsmow177#18 = aAlfa;
         #dsmow177#19 = "";
     |FINSI;

     eaCodNif = #dsmom041#47;
     |HAZ LeeNifs;
     |HAZ CalTipoNif;
     #dsmow177#20 = (aAlfa % 402);
     #dsmow177#21 = (aAlfa % 103);
     #dsmow177#22 = #dsmom041#47;  || El DNI
     #dsmow177#23 = #dsmom041#8;   || Proveedor

     |SI aTipoIVA = "X"; |O wTodoExcel = 1;
         |SI nT = 4;
             #dsmow177#24 = nLBase;
             #dsmow177#25 = nLTipoI;
             #dsmow177#26 = nLTipoR;
             #dsmow177#27 = nLCuoI;
             |SI nDatos49 = 1;
                 #dsmow177#28 = #dsmom049#9;
                 #dsmow177#29 = nLCuoR;
                 #dsmow177#30 = #dsmom049#10;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI nPrint = 1;
         |SI #dsmom041#26 > "01.01.0000"; |Y #dsmom041#26 [ fHFecha;
             #dsmow177#31 = #dsmom041#26;
             |SI aTipoIVA = "B";
                  #dsmow177#32 = ("00" + #dsmom041#58) % -102;
             |FINSI;
             |SI #dsmom041#58 = 2;   || Venta
                 #dsmow177#33 = #dsmom041#65;
                 #dsmow177#34 = #dsmom041#66;
             |FINSI;
         |FINSI;
     |FINSI;

     |GRABA 020#dsmow177.n;
     SwHayDatos = 1;
|FPRC;

|PROCESO LeeDsmom042;

   |SI #dsmom042#9 < fDFecha;
       nAcumI = (nAcumI + #dsmom042#7) ! 2;
   |FINSI;

   |SI #dsmom042#9 ] fDFecha;
       aAlfa = #dsmom042#9; aAlfa = aAlfa % 0402; nMes = aAlfa;
       |SI nMes [ 3;              nAcumR1 = (nAcumR1 + #dsmom042#7) ! 2; nT1 = 1; |FINSI;
       |SI nMes > 3; |Y nMes [ 6; nAcumR2 = (nAcumR2 + #dsmom042#7) ! 2; nT2 = 1; |FINSI;
       |SI nMes > 6; |Y nMes [ 9; nAcumR3 = (nAcumR3 + #dsmom042#7) ! 2; nT3 = 1; |FINSI;
       |SI nMes > 9;              nAcumR4 = (nAcumR4 + #dsmom042#7) ! 2; nT4 = 1; |FINSI;
       nAcumR = (nAcumR + #dsmom042#7) ! 2;
       nOk = 1;
   |FINSI;

   nAcumA = (nAcumA + #dsmom042#7) ! 2;
|FPRC;

|DEFBUCLE LeeDsmom042;
   #dsmom042#1;
   9,6;
   #dsmom041#0, #dsmom041#2, #dsmom041#3, 001, fFecha,  "A";
   #dsmom041#0, #dsmom041#2, #dsmom041#3, 999, fHFecha, "A";
   e;
   NULL, LeeDsmom042;
|FIN;

|PROCESO Amort041;
   nOk = 0;
   |SI #dsmom041#25 = "N";          nOk = 1; |FINSI;
   |SI #dsmom041#27 > fHFecha; nOk = 1; |FINSI;

   |SI #dsmom041#9  [ "01.01.0000"; nOk = 1; |FINSI;
   |SI aTipoIVA = "X";
       |SI #dsmom041#55 ] 30;  nOk = 1; |FINSI;
       |SI #dsmom041#41 ! "S"; nOk = 1; |FINSI;
   |FINSI;
   |SI #dsmom041#1 < #dsmoy096#46; |O #dsmom041#1 > #dsmoy096#47; nOk = 1; |FINSI;

   |SI nOk = 1; |ACABA; |FINSI;

   enActividad = #dsmom041#1;
   |HAZ LeeDatosActividad;
   enActividad = 0;

   nEjerBaja = 0;
   nMesBaja  = 0;
   |SI #dsmom041#26 > "01.01.0000";
       aAlfa = #dsmom041#26; aAlfa = aAlfa % -104; nEjerBaja = aAlfa;
       aAlfa = #dsmom041#26; aAlfa = aAlfa % 0402; nMes = aAlfa;
       |SI nMes [ 3;              nMesBaja = 1; |FINSI;
       |SI nMes > 3; |Y nMes [ 6; nMesBaja = 2; |FINSI;
       |SI nMes > 6; |Y nMes [ 9; nMesBaja = 3; |FINSI;
       |SI nMes > 9;              nMesBaja = 4; |FINSI;
       |SI nEjerBaja ! enEjer; nMesBaja = 4; |FINSI;
       |SI aTipoIVA = "X";     nMesBaja = 4; |FINSI;
   |FINSI;

   nImporte = #dsmom041#10;
   aTAmor   = ("00" + #dsmom041#57) % -102;
   nTCAmor  = #dsmom041#14;

   nOk = 0; nT1 = 0; nT2 = 0; nT3 = 0; nT4 = 0;
   nAcumI   = 0;  nAcumR   = 0;  nAcumA   = 0;
   nAcumI1  = 0;  nAcumR1  = 0;  nAcumA1  = 0;
   nAcumI2  = 0;  nAcumR2  = 0;  nAcumA2  = 0;
   nAcumI3  = 0;  nAcumR3  = 0;  nAcumA3  = 0;
   nAcumI4  = 0;  nAcumR4  = 0;  nAcumA4  = 0;
   |BUCLE LeeDsmom042;
   nAcumI1 = nAcumI;            nAcumA1 = nAcumI1 + nAcumR1; nValorRes1 = (nImporte - nAcumA1) ! 2;
   nAcumI2 = nAcumI1 + nAcumR1; nAcumA2 = nAcumI2 + nAcumR2; nValorRes2 = (nImporte - nAcumA2) ! 2;
   nAcumI3 = nAcumI2 + nAcumR2; nAcumA3 = nAcumI3 + nAcumR3; nValorRes3 = (nImporte - nAcumA3) ! 2;
   nAcumI4 = nAcumI3 + nAcumR3; nAcumA4 = nAcumI4 + nAcumR4; nValorRes4 = (nImporte - nAcumA4) ! 2;
   nValorRes  = (nImporte - nAcumA) ! 2;

   nLBase    = #dsmom041#10;
   nLTipoI   = #dsmom041#46;
   nLTipoR   = #dsmom041#42;
   nLCuoI    = #dsmom041#43;
   nLCuoR    = 0;

   nDatos49 = 0;
   |SI #dsmom041#41 = "S";
       |ABRE #dsmom049;
       |SELECT #2#dsmom049;
       #dsmom049#0 = #dsmom041#0;
       #dsmom049#2 = #dsmom041#2;
       #dsmom049#3 = #dsmom041#3;
       #dsmom049#5 = enEjer;
       #dsmom049#11 = "R";
       |LEE 041#dsmom049.=;
       |SI FSalida = 0;
           nDatos49 = 1;
           nLCuoR   = (#dsmom041#10 % #dsmom041#46) % #dsmom049#9;
       |FINSI;
       |SELECT #1#dsmom049;
       |CIERRA #dsmom049;
   |FINSI;

   |SI wTodoExcel = 0;
       |SI aTipoIVA = "X"; |Y nDatos49 = 0;                   |ACABA; |FINSI;
       |SI aTipoIVA = "B"; |Y nOk = 0; |Y nEjerBaja ! enEjer; |ACABA; |FINSI;
   |SINO;
       |SI nDatos49 = 0; |Y nOk = 0; |Y nEjerBaja ! enEjer;   |ACABA; |FINSI;
   |FINSI;

   |SI nEjerBaja > enEjer;
       nEjerBaja = 0;
       nMesBaja  = 0;
   |FINSI;

   nPrintBaja = 0;
   |SI aTipoIVA = "B";
       |SI nT1 = 1;
           nT  = 1;
           nAcumI = nAcumI1; nAcumR    = nAcumR1;
           nAcumA = nAcumA1; nValorRes = nValorRes1;
           |SI nMesBaja = 1; nPrintBaja = 1; nPrint = 1; |FINSI;
           |HAZ Graba_w177;
           nPrint = 0;
       |FINSI;
       |SI nT2 = 1;
           nT  = 2;
           nAcumI = nAcumI2; nAcumR    = nAcumR2;
           nAcumA = nAcumA2; nValorRes = nValorRes2;
           |SI nMesBaja = 2; nPrintBaja = 1; nPrint = 1; |FINSI;
           |HAZ Graba_w177;
           nPrint = 0;
       |FINSI;
       |SI nT3 = 1;
           nT  = 3;
           nAcumI = nAcumI3; nAcumR    = nAcumR3;
           nAcumA = nAcumA3; nValorRes = nValorRes3;
           |SI nMesBaja = 3; nPrintBaja = 1; nPrint = 1; |FINSI;
           |HAZ Graba_w177;
           nPrint = 0;
       |FINSI;
   |FINSI;

   nT  = 4;
   nAcumI = nAcumI4; nAcumR    = nAcumR4;
   nAcumA = nAcumA4; nValorRes = nValorRes4;
   |SI nMesBaja ! 0; |Y nPrintBaja = 0; nPrint = 1; |FINSI;

   |SI aTipoIVA = "X";
       |HAZ Graba_w177;
   |FINSI;
   |SI aTipoIVA = "B";
       |SI nT4 = 1; |O nPrint = 1;
           |HAZ Graba_w177;
       |SINO;
           |SI wTodoExcel = 1; |Y nDatos49 = 1;
               |HAZ Graba_w177;
           |FINSI;
       |FINSI;
   |FINSI;

|FPRC;

|DEFBUCLE Amort041;
   #dsmom041#1;
   ;
   enEmpresa, "        ", 00;
   enEmpresa, "zzzzzzzz", 99;
   e;
   NULL, Amort041;
|FIN;

|PROCESO Bienesinv;

    |SI nAbreLibro = 0;
        |HAZ AbreLibro;
    |FINSI;

    nClave   = 0;
    enModelo = 903;
    |HAZ NombreHoja;
    SwHayDatos = 0;

    || ... Creo auxiliar.
    |DELINDEX #dsmow177;

    |ABRE #dsmow177;
    fFecha   = "01.01.0000";
    fDFecha  = #dsmoy096#40;
    fHFecha  = #dsmoy096#41;
    |BUCLE Amort041;
    |CIERRA #dsmow177;

    enError = 0;

    |SI SwHayDatos = 1;
        |HAZ FinalLibro;
    |FINSI;
|FPRC;

|| *************************************************************************
|| ///////////////////////////////////////////////////////////////////
|PROCESO Emision;
   |SI nOper = 1;
       nGTempo = nGTempo + 1;
       |ACABA;
   |FINSI;

   enSwPartido = 0;
   enEmpresa  = #dsmow043#1;
   enPerConta = #dsmow043#2;
   eaLaMonEmp = #dsmow043#13;
   |HAZ EnConversor;
   enEjer      = #dsmow043#3;   || A¤o
   dig1        = #dsmow043#4;   || Desde Mes
   dig3        = #dsmow043#5;   || N§ Digitos
   dig4        = #dsmow043#6;   || Digitos Nivel 1
   dig5        = #dsmow043#7;   || Digitos Nivel 2
   dig6        = #dsmow043#8;   || Digitos Nivel 3
   dig7        = #dsmow043#9;   || Digitos Nivel 4
   dig8        = #dsmow043#10;  || Digitos Nivel 5
   dig9        = #dsmow043#11;  || Digitos Nivel 6
   eaEstadoEmp = #dsmow043#12; || Estado
   eaNombreEmp = #dsmow043#14; || Nombre Empresa

   |SI #dsmow043#4 ! 1;
       enSwOpPar  = 0;
       |HAZ SituaEmpresa;
       enPerConta = enPeriodoPar;
       #dsmow043#15 = aPathConta;
   |FINSI;

   aPathConta  = #dsmow043#15; |QBF aPathConta; || Path
   || Recoger informacion sobre los niveles ...
   |SI dig3 = 1; MaximoDigitos = dig4; |FINSI;
   |SI dig3 = 2; MaximoDigitos = dig5; |FINSI;
   |SI dig3 = 3; MaximoDigitos = dig6; |FINSI;
   |SI dig3 = 4; MaximoDigitos = dig7; |FINSI;
   |SI dig3 = 5; MaximoDigitos = dig8; |FINSI;
   |SI dig3 = 6; MaximoDigitos = dig9; |FINSI;

   nLongPart = 100 + MaximoDigitos;
   |PATH_DAT #caivaasi#aPathConta#;
   |PATH_DAT #camaasic#aPathConta#;
   |PATH_DAT #camaasil#aPathConta#;
   |PATH_DAT #camaniva#aPathConta#;
   |PATH_DAT #caivalin#aPathConta#;
   |PATH_DAT #camacc01#aPathConta#;
   |PATH_DAT #camacc02#aPathConta#;
   |PATH_DAT #camacc03#aPathConta#;
   |PATH_DAT #cacuenta#aPathConta#;
   |PATH_DAT #calicont#aPathConta#;

   |ABRE #caivaasi;
   |DDEFECTO #caivaasi;
   |LEE 000#caivaasi.p;
   |CIERRA #caivaasi;
   aMulDep = #caivaasi#132;

   nClave      = 0;
   nDActividad = 0;
   nHActividad = 0;

   |HAZ LeeDatosEmpresa;
   |SI swNoExis = 0;       ||SI existe esta Actividad.

       nAbreLibro = 0;
       fDFecha = #dsmoy096#40;
       fHFecha = #dsmoy096#41;

       |SI wTodoExcel = 0;
           |SI #dsmoy096#37 ! 2;   ||Libros de IVA
               aTipoIVA = "R"; |HAZ LibroIVA;
               |SI enError = 0;
                   aTipoIVA = "S"; |HAZ LibroIVA;
                   |SI enError = 0; aTipoIVA = "X"; |HAZ Bienesinv; |FINSI;
               |FINSI;
               |SI enError ! 0;  |VETE FinEmpresa; |FINSI;
               |SI enPorCsv  = 2;
                   |HAZ PresentaDocExcel;
                   nLibros = nLibros + 1;
               |FINSI;
               nAbreLibro = 0;
           |FINSI;

           |SI #dsmoy096#37 ! 1;   ||Libros de I.R.P.F.
               aTipoIVA = "I"; |HAZ LibroIRPF;
               |SI enError = 0;
                   aTipoIVA = "G"; |HAZ LibroIRPF;
                   |SI enError = 0; aTipoIVA = "B"; |HAZ Bienesinv; |FINSI;
               |FINSI;
               |SI enError ! 0;  |VETE FinEmpresa; |FINSI;
               |SI enPorCsv  = 2;
                   |HAZ PresentaDocExcel;
                   nLibros = nLibros + 1;
               |FINSI;
               nAbreLibro = 0;
           |FINSI;
       |FINSI;

       |SI wTodoExcel = 1;
           aTipoIVA = "I"; |HAZ LibroIRPF;
           |SI enError = 0;
               aTipoIVA = "G"; |HAZ LibroIRPF;
               |SI enError = 0; aTipoIVA = "B"; |HAZ Bienesinv; |FINSI;
           |FINSI;
           |HAZ PresentaDocExcel;
           nLibros = nLibros + 1;
           nAbreLibro = 0;
       |FINSI;
   |FINSI;

   |SI enSwPartido = 1;
       enSwOpPar   = 1;
       |HAZ FinalPartido;
   |FINSI;

   |DELINDEX #dsmow176;
   |DELINDEX #dsmow175;

|ET FinEmpresa;
   |SI enError ! 0;
       |MENAV "0000Existe un error en los libros";
       |ERROR10;
   |FINSI;
|FPRC;

|DEFBUCLE dsmow043;
   #dsmow043#1;
   16;
   000001, "S";
   999999, "S";
   ;
   NULL, Emision;
|FIN;

|PROCESO Imprimir;

   aFichero = ("9s" + Usuario) % 108;
   |NOME_DAT #dsmow176#aFichero#;
   |DELINDEX #dsmow176;

   aFichero = ("9r" + Usuario) % 108;
   |NOME_DAT #dsmow175#aFichero#;
   |DELINDEX #dsmow175;


   aFichero = ("9i" + Usuario) % 108;
   |NOME_DAT #dsmow177#aFichero#;
   |DELINDEX #dsmow177;

   |HAZ LeeUnidadBasico;

   |SI #dsmoy096#38 = 1;
       enPorCsv = 1;
       |HAZ PorCsv_1;
   |SINO;
       enPorCsv = 2;
       eaExcel97 = "xls";
       |SI #dsmoy096#38 = 3;
           eaExcel97 = "xlsx";
           #dsmoy096#38 = 2;
       |FINSI;

       |HAZ PorExcel_1;
       |SI enError = 1; |ACABA; |FINSI;
   |FINSI;

   nLibros = 0;
   nOper = 0; |BUCLE dsmow043;

   |SI nLibros ! 0;
       aAlfa = "Los libros generados estan: ";
       |SI nLibros = 1; aAlfa = "El libro generado esta: "; |FINSI;
       aAlfa = "0000" + aAlfa + eaPathLocal + " de su PC";
       |MENAV aAlfa;
   |FINSI;
|FPRC;

|PROCESO LeeDatosEmpresa;

  |DDEFECTO #dsmow030;
  eaInac = #dsmoy096#24;
  efDFecha  = #dsmoy096#40;
  efHFecha  = #dsmoy096#41;
  aAlfa1    = #dsmoy096#1;
  aAlfa1    = "01.01." + aAlfa1; fFecha = aAlfa1;
  |SI efDFecha < fFecha; efDFecha = fFecha; |FINSI;
  |HAZ DatosEmpr_w30;
|FPRC;

|PROCESO LeeDatosActividad;
   |SI enActividad ! 0;
       |ABRE #agicen14;
       #agicen14#0 = enEmpresa;
       #agicen14#1 = enActividad;
       |LEE 041#agicen14.=;
       |SI FSalida = 0;
           #900#69 = #agicen14#0;
           #900#70 = #agicen14#2;
           #900#71 = 0;
           #900#77 = 0;
           |SI #agicen14#3 ! 9999; #900#71 = #agicen14#3; |FINSI;
           |SI #agicen14#16 = 1;   #900#77 = 1; |FINSI;
           |SI #agicen14#16 = 2;   #900#77 = 3; |FINSI;
           |SI #agicen14#16 = 3;   #900#77 = 2; |FINSI;
           |SI #agicen14#16 = 4;   #900#77 = 5; |FINSI;
           |SI #agicen14#16 = 5;   #900#77 = 4; |FINSI;
       |FINSI;
       |CIERRA #agicen14;
       |ABRE #agicen30;
       #agicen30#0 = enEmpresa;
       #agicen30#1 = enActividad;
       #agicen30#2 = enEjer;
       |LEE 041#agicen30.=;
       |SI FSalida = 0;
           #900#70 = #agicen30#3;
           #900#71 = 0;
           #900#77 = 0;
           |SI #agicen30#4 ! 9999; #900#71 = #agicen30#4; |FINSI;
           |SI #agicen30#12 = 1;   #900#77 = 1; |FINSI;
           |SI #agicen30#12 = 2;   #900#77 = 3; |FINSI;
           |SI #agicen30#12 = 3;   #900#77 = 2; |FINSI;
           |SI #agicen30#12 = 4;   #900#77 = 5; |FINSI;
           |SI #agicen30#12 = 5;   #900#77 = 4; |FINSI;
       |FINSI;
       |CIERRA #agicen30;
   |FINSI;
|FPRC;

|RUTINA inferior;
   #dsmow043#0 = 00001;
|FRUT;

|RUTINA superior;
   #dsmow043#0 = 99999;
|FRUT;

||///////////////////////////////////////////////////////////////////
|CALCULO Tipo3;  |TIPO 3;

    efFechaEmi   = #dsmoy096#43;
    wTodoExcel  = 0;
    |SI #dsmoy096#39 = "S"; wTodoExcel = 1; |FINSI;

    enEjer = #dsmoy096#1;
    |HAZ Verm060Plan;
    |SI enPlan60 = 0; |ACABA; |FINSI;

    |ABRE #dsmom162;
    |DDEFECTO #dsmom162;
    #dsmom162#0 = enPlan60;
    |LEE 041#dsmom162.=;
    |CIERRA #dsmom162;

    aAlfa1 = enEjer; |QBF aAlfa1;
    aAlfa1 = aAlfa1 % -102;
    nEjercicio = aAlfa1;
    |DBASS aPath; |QBT aPath;

    aFichero = ("2d" + Usuario) % 108;
    |NOME_DAT #dsmow157#aFichero#;
    aFichero = ("2c" + Usuario) % 108;
    |NOME_DAT #dsmow054#aFichero#;

    aFichero = ("4w" + Usuario) % 108;
    |NOME_DAT #dsmow043#aFichero#;
    |DELINDEX #dsmow043;
    eaFEmpresa = aFichero;

    |ABRE #dsmow043;
    nGTempo = 0;   ||Busco Empresas Contables
    |SI #dsmoy096#2 ! 0;
        nDEmpresa = #dsmoy096#2;
        nHEmpresa = #dsmoy096#3;
        |BUCLE canempre;
    |SINO;
        |PARA nPara3 = 4;  |SI nPara3 [ 23;  |HACIENDO nPara3 = nPara3 + 1;
              |SI #dsmoy096#nPara3# ! 0;
                  nDEmpresa = #dsmoy096#nPara3#;
                  nHEmpresa = #dsmoy096#nPara3#;
                  |BUCLE canempre;
              |FINSI;
        |SIGUE;
    |FINSI;
    |CIERRA #dsmow043;

    |SI nGTempo = 0;    || No existe ninguna empresa
        |SI aParam = "";
            |MENAV "    Error. No existe ninguna Empresa Contable dentro de la Seleccion ";
        |FINSI;
        |DELINDEX #dsmow043;
        |ACABA;
    |FINSI;

    |C_V #dsmow043#12,1,"N"; |C_P #dsmow043#16,1,1270;

    |PUSHV 0509 2375;
    |ENTLINEAL #1#dsmow043, -1, 5, 22, 1, inferior, superior;
    |POPV;

    nFormato = #dsmoy096#38;
    nGTempo = 0;
    nOper = 1; |BUCLE dsmow043;
    |SI nGTempo ! 0;
        |HAZ Imprimir;
    |FINSI;
    |DELINDEX #dsmow157;
    |DELINDEX #dsmow054;
    |DELINDEX #dsmow043;
    #dsmoy096#38 = nFormato;
|FCAL;

|PROGRAMA;
  eaPlanilla = "dsmom060";  |HAZ PlanDePlanillas;

  aParam = PARAMETRO; |QBF aParam;
  |SI aParam = ""; aParam = "R"; |FINSI;

  |DDEFECTO #dsmoy096;
  aClave    = aParam;

  |ABRE #dsmoy096;
  #dsmoy096#0 = aClave;
  |LEE 101#dsmoy096.=;
  |SI FSalida ! 0;
      |DDEFECTO #dsmoy096;
      #dsmoy096#0  = aClave;
      |GRABA 020#dsmoy096.b;
      nEstado = 1;
  |FINSI;
  #dsmoy096#43 = ~;

  |CLS;
  |PINPA #0#dsmoy096;
  |PINDA #0#dsmoy096;

  |ENDATOS #1#dsmoy096;
  |SI FSalida = 0;
      #dsmoy096#0 = aClave;
      |GRABA 020#dsmoy096.a;
  |FINSI;
  |LIBERA #dsmoy096;
  |CIERRA #dsmoy096;
|FPRO;

|PROCESO BorroVariables;
    aPeriodo  = "";
    aTipoFra  = "";
    aClaveOpe = "";
    fFechaPago = "01.01.0000";
    nImporPago = 0;
    aMedioPago = "";
    aDesPago   = "";
    nLBase     = 0;
    nLTipoI    = 0;
    nLCuoI     = 0;
    nLTipoR    = 0;
    nLCuoR     = 0;
    nLBasP     = 0;
    nLTipP     = 0;
    nLCuoP     = 0;
|FPRC;
