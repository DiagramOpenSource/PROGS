|FICHEROS;
   dsm210ca;
   dsm210ln,MANTE;  || *
   dsm210in;
   dsm210ni;
   dsm210tr;
   dsm210fp;
   dsm210dp;
   dsm210dv;
   dsm210t1;

   dsm211ca;
   dsm211la;
   dsm211tr;

   dsminmex;

   dsm210hi;
   dsm210h1;
   dsm210h2;
   dsm210h3;
   dsm210h4;

   dsm211hi;
   dsm211h1;
   dsm211h2;

   dsm213hi;
   dsm213h1;
   dsm213h2;

   dsm213ca;
   dsm213in;
   dsm213so;

   dsmow310,MANTE;
   dsmow311;
   dsmow321;
   dsmow316;
   dsmow317;
   dsmow319;
   dsmow331;
   dsmow332,MANTE;  ||*
   dsmow353,MANTE;
   dsmow354;

   t1821001;
   t1821002;

   repobla@;
   rmunici@;
   Referen@;
   Refere1@;

   &reprovi@;
   &rpaises@;
   &haciend@;
|FIN;

|VARIABLES;
   &eaOrigen         = "";
   &eaDestino        = "";
   &eaForzExplorador = "";
   &eaPathExplorador = "";
   &eaDSMAC          = "";
   &Cmp              = 0;
   &eaUnidadBase     = "";
   &eaIP             = "";
   &eaNombreContr    = "";
   &enPant           = 0;
   &enSwTrata        = 0;
   &enCambiaMoneda   = 0;

   nSwDatos  = 0;
   nLong     = 0;
   Long      = 0;
   LongDec   = 0;
   nNegativo = 0;
   TipoDato  = "";

   Vacio1    = "";
   Vacio2    = "";
   Calc1     = 0;
   Calc2     = 0;
   aLong     = "";
   nModo     = 0;
   nCont1    = 0;
   nContEmis = 0;
   nContSoc  = 0;
   nContInm  = 0;
   nContCmp  = 0;
   nCalcCmp  = 0;
   nSwFiltraBarra = 0;

   aSwPresent = "";
   fDFecha  = @;
   fHFecha  = @;
   fFecha   = @;

   aDNif    = "";
   aHNif    = "";
   nDInm    = 0;
   nHInm    = 0;
   nLinNif  = 0;

   nSwCambia = 0;

   aCRLF    = "";
   aFichero = "";
   nHandle  = 0;
   nHandlePortal = 0;
   nSwModelo = 0;
   nSwHay   = 0;

   aCadena     = "";
   aSwPeriodo  = "";
   aDirBase    = "";
   aDirDest    = "";
   aComp       = "";
   nCompl      = 0;

   nCampo1  = 0;
   nCampo2  = 0;
   nCalc    = 0;
   nCont    = 0;
   nPos1    = 0;
   nPos2    = 0;
   nRango   = 0;
   FEstado  = 0;

   aNifRep  = "";

   nDirEjer = 0;

   nGridSel = 0;
   nGrid1   = 0;
   nGridEmi = 0;

   aTitul   = "";
   nFactor  = 0;

   nIdSalir = 0;

   nSwCliente = 0;
   nVentEsp   = 0;
   nVent0     = 0;
   nPant1     = 0;

   aCompl   = "";

   aWebTIA  = "";
   aWebEJF  = "";
   aWebNDC  = "";
   aWebING  = "";

   aSwError = "";
   nSwError = 0;

   nCalc1   = 0;
   nCalc2   = 0;
   nCalcLiq = 0;

   aNifPres = "";
   aNomPres = "";

   aAlfa    = "";
   aAlfa1   = "";
   aAlfa2   = "";
   aAlfa3   = "";
   aAlfa4   = "";
   aAlfa5   = "";
   || NO METER VARIABLES ENTRE ESTE BLOQUE
{-1}aVent      = "";
    aVent1     = 0;
    aVent2     = 0;
    aVent3     = 0;
    aVent4     = 0;
    aVent5     = "";
   || NO METER VARIABLES ENTRE ESTE BLOQUE
   aEsc1   = "";
   aEsc2   = "";
   aEsc3   = "";
   aRetu   = "";
   aTecla  = "";

   nBotonExpl  = 0;
   nBotonSelec = 0;
   nBotonEmi   = 0;
   nBotonSalir = 0;
   nBotonMarca = 0;
   nBotonDesmarca = 0;

   aMarca  = "";
   nSwSel  = 0;
   nSwMensaje = 0;

   aColorSel = "255,255,200;0,170,0      ";
   nGridCont = 0;

   nVentSel = 0;
   nPantSel = 0;
   nLabel   = -1;
   nLabel1  = -1;

   &eaPathLanza  = "";
   aPathLocal    = "";
   aPathPdf      = "";
   aAbre         = "";
   aOrigen       = "";
   aDestino      = "";
   aDocServidor  = "";
   aDocRemoto    = "";
   aIPRemoto     = "";

   &eaVarDni = "";
   &eaAlfa   = "";
   &enNume   = 0;
   &nEj210tr = 0;
   &nTr210tr = 0;
   &nTg210tr = 0;
   &fFecha1  = @;
   &enModelo = 0;
   nAlguno   = 0;

   &enPresentar     = 0;
   &eaPathInternet  = "";
   &eaPathAEAT      = "";

     {1}aContiene   = "";

|FIN;

|INCLUYE i_pat210;



/***************************************************************************
*********             PROCESOS ESPECIFICOS DE LA EMISION           *********
****************************************************************************/

|PROCESO VuelcaFichero;
   aCRLF = &13 + &10;
   |XABRE "B", aFichero, nHandle;
   |SI FSalida ] 0;
      FSalida = 1;
      |PARA; |SI FSalida > 0; |HACIENDO;
         |XLEE nHandle, 250, aAlfa1;
         aAlfa1 = aAlfa1 - aCRLF;
         |XGRABA nHandlePortal, aAlfa1;
      |SIGUE;
      |XCIERRA nHandle;
   |FINSI;
|FPRC;

|PROCESO BotonOk1;
   |PTEC 801;
|FPRC;

|PROCESO GrabaHTML;
     |XGRABA nHandlePortal, aAlfa;
|FPRC;

|PROCESO CreaPortal;
    aAlfa = aFichero;
    |XABRE "B", aAlfa, nHandle;
    |SI FSalida ] 0;
       |XLEE nHandle, 250, aAlfa;
       |SI nSwModelo = 210;
          aWebTIA = aAlfa % 1001;
          aWebEJF = aAlfa % 15404;
          aWebNDC = aAlfa % 1109;
       |FINSI;
       |SI nSwModelo = 211;
          aWebTIA = "I";
          aWebEJF = aAlfa % 1804;
          aWebNDC = aAlfa % 2209;
       |FINSI;
       |SI nSwModelo = 213;
          aWebTIA = aAlfa % 1001;
          aWebEJF = aAlfa % 14504;
          aWebNDC = aAlfa % 1109;
       |FINSI;
       |XLEE nHandle, 250, aAlfa;
       |XLEE nHandle, 250, aAlfa;
       |XLEE nHandle, 250, aAlfa;
       |SI nSwModelo = 213;
          aWebING = aAlfa % 17417; nCalc = aWebING; nCalc = nCalc / 100; aWebING = nCalc;
       |FINSI;
       |XLEE nHandle, 250, aAlfa;
       |XLEE nHandle, 250, aAlfa;
       |XLEE nHandle, 250, aAlfa;
       |XLEE nHandle, 250, aAlfa;
       |SI nSwModelo = 210;
          aWebING = aAlfa % 11617; nCalc = aWebING; nCalc = nCalc / 100; aWebING = nCalc;
       |FINSI;
       |SI nSwModelo = 211;
          aWebING = aAlfa % 3917; nCalc = aWebING; nCalc = nCalc / 100; aWebING = nCalc;
       |FINSI;
       |XCIERRA nHandle;
    |FINSI;

    |DBASE aAlfa; |QBF aAlfa;
    aAlfa = aAlfa + "tmp/"; |MKDIR aAlfa;
    aAlfa = aAlfa + Usuario + "/"; |MKDIR aAlfa;
    aAlfa = aAlfa + "portal" + nSwModelo + ".html";
    |XABRE "WB", aAlfa, nHandlePortal;
    |SI FSalida = 0;
       aAlfa = "<!DOCTYPE HTML PUBLIC " + &34 + "-//W3C//DTD HTML 4.01 Transitional//EN" + &34; |HAZ GrabaHTML;
       aAlfa = &34 + "http://www.w3.org/TR/html4/loose.dtd" + &34 + ">"; |HAZ GrabaHTML;
       aAlfa = "<html>";  |HAZ GrabaHTML;
       aAlfa = "<head>";  |HAZ GrabaHTML;
       aAlfa = "<title>Documento sin t&iacute;tulo</title>"; |HAZ GrabaHTML;
       aAlfa = "<meta http-equiv=" + &34 + "Content-Type" + &34 + " content=" + &34 + "text/html; charset=iso-8859-1" + &34 + ">"; |HAZ GrabaHTML;
       aAlfa = "</head>"; |HAZ GrabaHTML;
       aAlfa = "";        |HAZ GrabaHTML;
       aAlfa = "<script language=" + &34 + "javascript" + &34 + ">"; |HAZ GrabaHTML;
       aAlfa = "     function carga()"; |HAZ GrabaHTML;
       aAlfa = "     {";  |HAZ GrabaHTML;
       aAlfa = "          document.form1.submit();"; |HAZ GrabaHTML;
       aAlfa = "     }";  |HAZ GrabaHTML;
       aAlfa = "</script>"; |HAZ GrabaHTML;
       aAlfa = "";        |HAZ GrabaHTML;
       aAlfa = "<body onload=" + &34 + "javascript:carga();" + &34 + ">"; |HAZ GrabaHTML;
       aAlfa = "<form method=" + &34 + "POST" + &34 + " action=" + &34 + "https://www2.agenciatributaria.gob.es/es13/l/zi21zilk0021" + &34 + " name=" + &34 + "form1" + &34 + " id=" + &34 + "form1" + &34 + ">"; |HAZ GrabaHTML;
       |SI nSwModelo = 210; aAlfa = "IE12100B"; |FINSI;
       |SI nSwModelo = 211; aAlfa = "IE1211BO"; |FINSI;
       |SI nSwModelo = 213; aAlfa = "IE12130B"; |FINSI;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "HID" + &34 + " value=" + &34 + aAlfa + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "TIA" + &34 + " value=" + &34 + aWebTIA + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "NDC" + &34 + " value=" + &34 + aWebNDC + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "NRC" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "ING" + &34 + " value=" + &34 + aWebING + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "NRR" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "ICO" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "NR1" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IN1" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "NR2" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IN2" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "NR3" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IN3" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "NR4" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IN4" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "NR5" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IN5" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "NR6" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IN6" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "NR7" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IN7" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "CMN" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "LOT" + &34 + " value=" + &34 + "0" + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "IDI" + &34 + " value=" + &34 + "ES" + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "LEV" + &34 + " value=" + &34 + "000000000000" + &34 + " />"; |HAZ GrabaHTML;
       |SI nSwModelo = 210;
          aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "F01" + &34 + " value=" + &34; |HAZ GrabaHTML;
          aAlfa = "<T2100" + aWebEJF + "0A0000><AUX>"; |HAZ GrabaHTML;
          aAlfa = " " * 150; |HAZ GrabaHTML;
          aAlfa = " " * 150; |HAZ GrabaHTML;
          aAlfa = "</AUX><VECTOR>001002FIN"; |HAZ GrabaHTML;
          aAlfa = " " * 191; |HAZ GrabaHTML;
          aAlfa = " " * 100; |HAZ GrabaHTML;
          aAlfa = "</VECTOR>"; |HAZ GrabaHTML;
          |HAZ VuelcaFichero;
          aAlfa = "</T2100" + aWebEJF + "0A0000>"; |HAZ GrabaHTML;
          aAlfa = &34 + " />"; |HAZ GrabaHTML;
       |FINSI;

       |SI nSwModelo = 211;
          aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "F01" + &34 + " value=" + &34; |HAZ GrabaHTML;
          aAlfa = "<T2110" + aWebEJF + "0A0000><AUX>"; |HAZ GrabaHTML;
          aAlfa = " " * 150; |HAZ GrabaHTML;
          aAlfa = " " * 150; |HAZ GrabaHTML;
          aAlfa = "</AUX><VECTOR>010"; |HAZ GrabaHTML;

          aAlfa = "";
          nCalc = #dsm211ca#54;
          |SI nCalc > 1;
             nCalc = ((nCalc / 3) + .49) ! 0;
             aAlfa = "020" * nCalc;
          |FINSI;
          aCadena = aAlfa; aAlfa = "";
          nCalc = #dsm211ca#55;
          |SI nCalc > 1;
             nCalc = ((nCalc / 5) + .49) ! 0;
             aAlfa = "030" * nCalc;
          |FINSI;
          aCadena = aCadena + aAlfa + "FIN";
          aAlfa = aCadena % 0; nCalc = aAlfa; nCalc = 297 - nCalc;
          aAlfa = aCadena;
          |HAZ GrabaHTML;

          |PARA; |SI nCalc > 100; |HACIENDO nCalc = nCalc - 100;
             aAlfa = " " * 100; |HAZ GrabaHTML;
          |SIGUE;
          aAlfa = " " * nCalc; |HAZ GrabaHTML;
          aAlfa = "</VECTOR>"; |HAZ GrabaHTML;
          |HAZ VuelcaFichero;
          aAlfa = "</T2110" + aWebEJF + "0A0000>"; |HAZ GrabaHTML;
          aAlfa = &34 + " />"; |HAZ GrabaHTML;
       |FINSI;

       |SI nSwModelo = 213;
          aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "F01" + &34 + " value=" + &34; |HAZ GrabaHTML;
          aAlfa = "<T2130" + aWebEJF + "0A0000><AUX>"; |HAZ GrabaHTML;
          aAlfa = " " * 150; |HAZ GrabaHTML;
          aAlfa = " " * 150; |HAZ GrabaHTML;
          aAlfa = "</AUX><VECTOR>001"; |HAZ GrabaHTML;

          aAlfa = "";
          nCalc = #dsm213ca#20;
          |SI nCalc ] 1;
             nCalc = ((nCalc / 3) + .49) ! 0;
             aAlfa = "002" * nCalc;
          |FINSI;
          aCadena = aAlfa; aAlfa = "";
          nCalc = #dsm213ca#21;
          |SI nCalc ] 1;
             nCalc = ((nCalc / 3) + .49) ! 0;
             aAlfa = "003" * nCalc;
          |FINSI;
          aCadena = aCadena + aAlfa + "FIN";
          aAlfa = aCadena % 0; nCalc = aAlfa; nCalc = 297 - nCalc;
          aCadena = aAlfa;
          |HAZ GrabaHTML;

          |PARA; |SI nCalc > 100; |HACIENDO nCalc = nCalc - 100;
             aAlfa = " " * 100; |HAZ GrabaHTML;
          |SIGUE;
          aAlfa = " " * nCalc; |HAZ GrabaHTML;
          aAlfa = "</VECTOR>"; |HAZ GrabaHTML;
          |HAZ VuelcaFichero;
          aAlfa = "</T2130" + aWebEJF + "0A0000>"; |HAZ GrabaHTML;
          aAlfa = &34 + " />"; |HAZ GrabaHTML;
       |FINSI;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "PUN" + &34 + " value=" + &34 + "00000000" + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "TXT" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       |SI nSwModelo = 210;
          aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "FD1" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
          aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "FD2" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       |FINSI;
       |SI nSwModelo = 211; |O nSwModelo = 213;
          aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "FIR" + &34 + " value=" + &34 + &34 + " />"; |HAZ GrabaHTML;
       |FINSI;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "FIN" + &34 + " value=" + &34 + "F" + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "EJF" + &34 + " value=" + &34 + aWebEJF + &34 + " />"; |HAZ GrabaHTML;
       aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "MOD" + &34 + " value=" + &34 + nSwModelo + &34 + " />"; |HAZ GrabaHTML;
       |SI nSwModelo = 210;
          aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "PRG" + &34 + " value=" + &34 + "EWLINKOT" + &34 + " />"; |HAZ GrabaHTML;
       |FINSI;
       |SI nSwModelo = 211;
          aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "PRG" + &34 + " value=" + &34 + "EWLINKPH" + &34 + " />"; |HAZ GrabaHTML;
       |FINSI;
       |SI nSwModelo = 213;
          aAlfa = "     <input type=" + &34 + "hidden" + &34 + " name=" + &34 + "PRG" + &34 + " value=" + &34 + "EWLINKTJ" + &34 + " />"; |HAZ GrabaHTML;
       |FINSI;
       aAlfa = "</form></body></html>"; |HAZ GrabaHTML;
       |XCIERRA nHandlePortal;
    |FINSI;
|FPRC;

|PROCESO LanzaPortal;
   |SI nSwModelo = "211"; aSwPeriodo = "0A"; |FINSI;
   |SI nSwModelo = "213"; aSwPeriodo = "0A"; |FINSI;

   |SI eaIP ! "";
      aAlfa = eaUnidadBase + "/modelos/"; |RMKDIR aAlfa;
      aAlfa = aAlfa + "internet/"; |RMKDIR aAlfa;
      aAlfa = aAlfa + nSwModelo + "/"; |RMKDIR aAlfa;
      aAlfa = aAlfa + aWebEJF + "/"; |RMKDIR aAlfa;
      aAlfa = aAlfa + aSwPeriodo + "/"; |RMKDIR aAlfa;

      aAlfa = eaUnidadBase + "/modelos"; |RMKDIR aAlfa;
      aAlfa = aAlfa + "/" + nSwModelo; |RMKDIR aAlfa;
      aAlfa = aAlfa + "/tmp"; |RMKDIR aAlfa;
      aAlfa = aAlfa + "/" + Usuario; |RMKDIR aAlfa;
   |SINO;
      aAlfa = eaUnidadBase + "/modelos/"; |MKDIR aAlfa;
      aAlfa = aAlfa + "internet/"; |MKDIR aAlfa;
      aAlfa = aAlfa + nSwModelo + "/"; |MKDIR aAlfa;
      aAlfa = aAlfa + aWebEJF + "/"; |MKDIR aAlfa;
      aAlfa = aAlfa + aSwPeriodo + "/"; |MKDIR aAlfa;

      aAlfa = eaUnidadBase + "/modelos"; |MKDIR aAlfa;
      aAlfa = aAlfa + "/" + nSwModelo; |MKDIR aAlfa;
      aAlfa = aAlfa + "/tmp"; |MKDIR aAlfa;
      aAlfa = aAlfa + "/" + Usuario; |MKDIR aAlfa;
   |FINSI;

   |DBASE eaOrigen; |QBF eaOrigen;
   eaOrigen = eaOrigen + "tmp/" + Usuario + "/portal" + nSwModelo + ".html";
   eaDestino = eaUnidadBase + "/modelos/" + nSwModelo + "/tmp/" + Usuario + "/portal" + nSwModelo + ".html";
   |HAZ EnviaFicheroMD5;

   |DBASE eaOrigen; |QBF eaOrigen;
   eaOrigen = eaOrigen + "plugins/dsaeatresp.exe";
   eaDestino = eaUnidadBase + "/modelos/" + nSwModelo + "/tmp/" + Usuario + "/"; aDirDest = eaDestino;
   eaDestino = eaDestino + "dsaeatresp.exe";
   |HAZ EnviaFicheroMD5;

   aAlfa1 = aDirDest + "error" + nSwModelo + ".html";
   aAlfa = eaDestino + " " + aDirDest + "portal" + nSwModelo + ".html" + " " + aAlfa1;
   aAlfa = "cmd " + &34 + "/c START /WAIT " + aAlfa + &34;
   |RSYSTEM aAlfa;

   aSwError = aAlfa1; nSwError = 0;
   |XABRE "C", aAlfa1, nHandle;
   |SI FSalida = 0;
      |PARA; |SI; |HACIENDO;
         |XLEE nHandle,  250, aAlfa;
         |SI FSalida < 0; |SAL; |FINSI;

         aAlfa1 = aAlfa < "";  |QBF aAlfa1;
         aAlfa2 = aAlfa1 - "<title>";
         |SI FSalida ! 0;
            aAlfa2 = aAlfa1 - "error";
            |SI FSalida ! 0; nSwError = 1; |SAL;  |FINSI;

            aAlfa2 = aAlfa1 - "errónea";
            |SI FSalida ! 0; nSwError = 1; |SAL;  |FINSI;
         |FINSI;
      |SIGUE;
      |XCIERRA nHandle;
   |FINSI;

   |SI nSwError = 1;
      |SI aTitul = "";
         aAlfa = "    SSe han encontrado errores. " + &191 + " Desea verlos ?";
      |FINSI;
      |SI aTitul = "T";
         aAlfa = "    SSe han encontrado errores en la emision del TITULAR. " + &191 + " Desea verlos ?";
      |FINSI;
      |SI aTitul = "C";
         aAlfa = "    SSe han encontrado errores en la emision del CONYUGE. " + &191 + " Desea verlos ?";
      |FINSI;
      |CONFI aAlfa;
      |SI FSalida = 0;
         eaForzExplorador = "N"; eaPathExplorador = "";
         |HAZ Explorador;
         aAlfa = eaPathExplorador + " " + aSwError;
         aAlfa = aAlfa - "/";
         |PARA; |SI FSalida ! 0; |HACIENDO;
            nCalc = ((FSalida / 100) ! 0) + 99; aAlfa1 = aAlfa % nCalc;
            nCalc = FSalida + 98;               aAlfa2 = aAlfa % nCalc;
            aAlfa = aAlfa1 + "\" + aAlfa2;
            aAlfa = aAlfa - "/";
         |SIGUE;
         aAlfa = "cmd " + &34 + "/c START /WAIT " + aAlfa + &34;
         |RSYSTEM aAlfa;
      |FINSI;
   |FINSI;
   |RFBORRA aSwError;
|FPRC;

|PROCESO PreguntaEmite;
     enPresentar = 0;
     |SI aSwPresent = "T";
         |CONFI "0000SPresentamos la declaracion en el momento de crearlas";
         |SI FSalida = 0;
             enPresentar = 1;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO EmiteModelo;

   |SI aSwPresent = "P";
       enPresentar = 1;
   |FINSI;

   eaOrigen = aFichero;
   aAlfa3 = ""; aAlfa1 = aFichero;
   aAlfa2 = aAlfa1 % -101;
   |PARA; |SI aAlfa1 ! ""; |Y aAlfa2 ! "\"; |Y aAlfa2 ! "/"; |HACIENDO;
          aAlfa3 = aAlfa2 + aAlfa3;
          aAlfa1 = aAlfa1 % -299; aAlfa2 = aAlfa1 % -101;
   |SIGUE;
   aAlfa5 = nDirEjer; |QBF aAlfa5; aAlfa5 = (("00000" + aAlfa5) % -104);

   eaPathInternet = eaUnidadBase   + "/AEAT";          |RMKDIR eaPathInternet;
   eaPathInternet = eaPathInternet + "/INTERNET";      |RMKDIR eaPathInternet;
   eaPathInternet = eaPathInternet + "/" + nSwModelo;  |RMKDIR eaPathInternet;
   eaPathInternet = eaPathInternet + "/" + aAlfa5;     |RMKDIR eaPathInternet;
   |SI aSwPeriodo ! "";
       eaPathInternet = eaPathInternet + "/" + aSwPeriodo; |RMKDIR eaPathInternet;
   |FINSI;

   eaPathAEAT     = eaUnidadBase   + "/AEAT";
   eaPathAEAT     = eaPathAEAT     + "/" + nSwModelo;  |RMKDIR eaPathAEAT;
   eaPathAEAT     = eaPathAEAT     + "/" + aAlfa5;     |RMKDIR eaPathAEAT;
   |SI aSwPeriodo ! "";
       eaPathAEAT     = eaPathAEAT     + "/" + aSwPeriodo; |RMKDIR eaPathAEAT;
   |FINSI;

   eaPathInternet = eaPathInternet + "/";
   eaPathAEAT     = eaPathAEAT + "/";

   aAlfa = eaPathAEAT + "*.bat";
   |R_PDIR aAlfa;
   |PARA;  |SI FSalida = 0;  |HACIENDO;
        |RFBORRA aAlfa;

        |R_SDIR aAlfa;
   |SIGUE;

    aAlfa = eaPathAEAT + "*.exe";
    |R_PDIR aAlfa;
    |PARA;  |SI FSalida = 0;  |HACIENDO;
         |RFBORRA aAlfa;

         |R_SDIR aAlfa;
    |SIGUE;

    |SI enPresentar = 0;
        eaDestino = eaPathInternet + aAlfa3;
    |SINO;
        eaDestino = eaPathAEAT + aAlfa3;
    |FINSI;
    |SI eaIP ! "";
        |HAZ EnviaFicheroMD5;
    |SINO;
        |COPIA_FICHERO eaOrigen, eaDestino;
    |FINSI;
|FPRC;

|PROCESO Formateo;
   |QBF aAlfa;
   |SI TipoDato = "F";
      aAlfa = aAlfa - "."; aAlfa = aAlfa - ".";
      |QBF aAlfa;
      |SI aAlfa = "";         aAlfa = "0" * 8; |FINSI;
      |SI aAlfa = "01010000"; aAlfa = "0" * 8; |FINSI;
      |ACABA;
   |FINSI;
   |SI TipoDato = "N";
      Vacio1 = "0" * Long;
      Vacio2 = "0" * LongDec;
      aAlfa = aAlfa - "-";
      |SI FSalida ! 0;
         nNegativo = 1;
      |SINO;
         nNegativo = 0;
      |FINSI;
   |SINO;
      Vacio1 = " " * Long;
   |FINSI;

   aAlfa2 = "";
   eaAlfa = aAlfa;
   |SI TipoDato = "A"; |O TipoDato = "An";
       |HAZ QuitaRaros;
       aAlfa = eaAlfa;
   |FINSI;

   |SI TipoDato ! "N";
      Calc1 = 100 + Long; aAlfa = (aAlfa + Vacio1) % Calc1;
   |SINO;
      |SI LongDec = 0;
         Calc1 = 0 - (100 + Long);
         aAlfa = (Vacio1 + aAlfa) % Calc1;
      |SINO;
         aAlfa = aAlfa - ".";
         |SI FSalida = 0;
            Calc1 = 0 - (100 + Long);
            aAlfa = (Vacio1 + aAlfa) % Calc1;
            aAlfa1 = "0" * LongDec;
         |SINO;
            Calc1 = (((FSalida / 100) ! 0) - 1) + 100;
            Calc2 = (((FSalida / 100) ! 0) * 100) + 99;
            aAlfa1 = aAlfa % Calc2;
            aAlfa = aAlfa % Calc1;
            Calc1 = 0 - (100 + Long);
            aAlfa = (Vacio1 + aAlfa)  % Calc1;
            Calc1 = 100 + LongDec;
            aAlfa1 = (aAlfa1 + Vacio2) % Calc1;
         |FINSI;
         aAlfa = aAlfa + aAlfa1;
      |FINSI;
      |SI nNegativo = 1;
         Calc1 = 0 - (100 + (Long + LongDec)); Calc1 = Calc1 + 1;
         aAlfa = aAlfa % Calc1;
         aAlfa = "N" + aAlfa;
      |FINSI;
   |FINSI;

   Calc1 = aAlfa;
   |SI nSwDatos = 0; |Y Calc1 ! 0; nSwDatos = 1; |FINSI;
|FPRC;

/***************************************************************************
*********           FIN PROCESOS ESPECIFICOS DE LA EMISION         *********
****************************************************************************/

/***************************************************************************
*********                   EMISION MODELO 210                     *********
****************************************************************************/

|PROCESO EmiteLin;
   |SI #dsmow310#5 = "S";
      nContEmis = 0;
   |SINO;
      nContEmis = nContEmis + 1;
   |FINSI;

   nCalc  = (#dsm210ln#7 % #dsm210ln#35) ! 2;
   nCalc1 = (#dsm210ln#7 % #dsm210ln#38) ! 2;

   |SI nCalc < 0; nCalc = 0; |FINSI;
   nCalcLiq = nCalc - #dsm210ln#27;
   |SI nCalc1 < nCalcLiq; |Y nCalc1 > 0;
       nCalc2 = nCalcLiq - nCalc1;
   |SINO;
       nCalc2 = 0;
   |FINSI;
   nCalcLiq = nCalcLiq - nCalc2;
   nCalcLiq = nCalcLiq - #dsm210ln#28 + #dsm210ln#31;

   #dsmow311#0 = #dsm210ca#0;
   #dsmow311#1 = #dsm210ca#1;
   #dsmow311#2 = #dsm210ln#5;
   #dsmow311#3 = aDNif;
   #dsmow311#4 = nDInm;
   #dsmow311#52 = nContEmis;
   |SI nCalcLiq ] 0; #dsmow311#5 = "P"; |SINO; #dsmow311#5 = "N"; |FINSI;
   |LEE 000#dsmow311.=;
   |SI FSalida ! 0;
      |DDEFECTO #dsmow311;
      #dsmow311#0 = #dsm210ca#0;
      #dsmow311#1 = #dsm210ca#1;
      #dsmow311#2 = #dsm210ln#5;
      #dsmow311#3 = aDNif;
      #dsmow311#4 = nDInm;
      |SI nCalcLiq ] 0; #dsmow311#5 = "P"; |SINO; #dsmow311#5 = "N"; |FINSI;
      #dsmow311#52 = nContEmis;
      #dsmow311#54 = #dsm210dp#65;
      #dsmow311#55 = nLinNif;
      |GRABA 020#dsmow311.c;
   |SINO;
      #dsmow311#14 = "S";
   |FINSI;

   |SI #dsm210tr#2 = "S";
      #dsmow311#49 = #dsm210in#9;
      #dsmow311#50 = #dsm210in#10;
      #dsmow311#51 = #dsm210in#11;
   |SINO;
      #dsmow311#49 = #dsm210ni#2;
      #dsmow311#50 = #dsm210ni#4;
      #dsmow311#51 = #dsm210ni#3;
   |FINSI;

   |SI #dsm210ca#3 = "S"; #dsmow311#30 = "X"; |SINO; #dsmow311#30 = " "; |FINSI;
   |SI #dsm210ca#4 = "S"; #dsmow311#31 = "X"; |SINO; #dsmow311#31 = " "; |FINSI;
   #dsmow311#32 = #dsm210ln#35;
   #dsmow311#34 = #dsm210ln#27;
   #dsmow311#36 = #dsm210ln#38;
   #dsmow311#40 = #dsm210ln#28;
   #dsmow311#41 = #dsm210ln#31;
   |SI #dsm210ln#29 = "S"; #dsmow311#43 = "X"; |SINO; #dsmow311#43 = " "; |FINSI;
   #dsmow311#44 = #dsm210ln#30;
   #dsmow311#45 = #dsmow310#8;
   #dsmow311#46 = #dsmow310#9;
   #dsmow311#47 = #dsmow310#10;
   #dsmow311#48 = #dsmow310#11;
   |SI #dsmow311#52 ! 0; #dsmow311#53 = #dsm210ln#4; |FINSI;

   |SI #dsm210tr#4 = "I";
      #dsmow311#6 = #dsmow311#6 + #dsm210ln#7;
      #dsmow311#13 = #dsm210ln#32;
      #dsmow311#14 = #dsm210ln#33;

      #dsmow311#33 = #dsmow311#6 % #dsmow311#32;
      #dsmow311#37 = 0;
   |FINSI;

   |SI #dsm210tr#4 = "R";
      #dsmow311#7  = #dsmow311#7  + #dsm210ln#8;
      #dsmow311#8  = #dsmow311#8  + #dsm210ln#9;
      #dsmow311#9  = #dsmow311#9  + #dsm210ln#10;
      #dsmow311#10 = #dsmow311#10 + #dsm210ln#7;
      #dsmow311#13 = #dsm210ln#32;
      #dsmow311#14 = #dsm210ln#33;

      #dsmow311#33 = #dsmow311#10 % #dsmow311#32;
      #dsmow311#37 = #dsmow311#10 % #dsmow311#36;
   |FINSI;

   |SI #dsm210tr#4 = "G";
      #dsmow311#11 = #dsmow311#11 + #dsm210ln#7;
      #dsmow311#13 = #dsm210ln#32;
      #dsmow311#14 = #dsm210ln#33;

      #dsmow311#33 = #dsmow311#11 % #dsmow311#32;
      #dsmow311#37 = 0;
   |FINSI;

   |SI #dsm210tr#4 = "H";
      #dsmow311#12 = #dsm210ln#11;
      #dsmow311#13 = #dsm210ln#12;
      #dsmow311#14 = #dsm210ln#13;
      #dsmow311#15 = #dsm210ln#14;
      #dsmow311#16 = #dsm210ln#15;
      #dsmow311#17 = #dsm210ln#16;
      #dsmow311#18 = #dsm210ln#17;
      #dsmow311#19 = #dsm210ln#18;
      #dsmow311#20 = #dsm210ln#19;
      #dsmow311#21 = #dsm210ln#20;
      #dsmow311#22 = #dsm210ln#21;
      #dsmow311#23 = #dsm210ln#22;
      #dsmow311#24 = #dsm210ln#23;
      #dsmow311#25 = #dsm210ln#7;
      #dsmow311#26 = #dsm210ln#24;
      #dsmow311#27 = #dsm210ln#25;
      #dsmow311#28 = #dsm210ln#26;
      #dsmow311#29 = "N";

      #dsmow311#33 = #dsmow311#25 % #dsmow311#32;
      #dsmow311#37 = 0;
   |FINSI;

   #dsmow311#33 = #dsmow311#33 ! 2;

   |SI #dsmow311#33 < 0; #dsmow311#33 = 0; |FINSI;
   #dsmow311#35 = #dsmow311#33 - #dsmow311#34;
   |SI #dsmow311#37 < #dsmow311#35; |Y #dsmow311#37 > 0;
      #dsmow311#38 = #dsmow311#35 - #dsmow311#37;
   |SINO;
      #dsmow311#38 = 0;
   |FINSI;
   #dsmow311#39 = #dsmow311#35 - #dsmow311#38;
   #dsmow311#42 = #dsmow311#39 - #dsmow311#40 + #dsmow311#41;

   |GRABA 020#dsmow311.a;

   |ABRE #dsm210fp;
   #dsm210fp#0 = #dsmow311#0;
   #dsm210fp#1 = #dsmow311#1;
   #dsm210fp#2 = #dsmow311#3;
   #dsm210fp#3 = #dsmow311#4;
   #dsm210fp#4 = #dsmow311#2;
   |SI #dsmow311#42 ] 0; #dsm210fp#37 = "P"; |SINO; #dsm210fp#37 = "N"; |FINSI;
   |LEE 000#dsm210fp.=;
   |SI FSalida ! 0; |DDEFECTO #dsm210fp; |FINSI;
   |CIERRA #dsm210fp;

   #dsmow321#10 = #dsmow311#0;
   #dsmow321#0 = #dsmow311#1;
   #dsmow321#6 = #dsmow311#2;
   #dsmow321#5 = #dsmow311#3;
   #dsmow321#4 = #dsmow311#4;
   #dsmow321#7 = #dsmow311#5;
   #dsmow321#1 = #dsmow311#52;
   |LEE 000#dsmow321.=;
   |SI FSalida ! 0;
      |DDEFECTO #dsmow321;
      #dsmow321#0 = #dsmow311#1;
      #dsmow321#2 = #dsm210ca#2;
      |SI #dsmow311#5 = "P";
         aAlfa = "Dec.Positiva";
      |SINO;
         aAlfa = "Dec.Negativa";
      |FINSI;
      aAlfa = aAlfa + " Div [" + #dsmow311#2 + "]";
      aAlfa1 = #dsmow311#3; |QBF aAlfa1;
      |SI aAlfa1 ! "";
         aAlfa = aAlfa + " Nif [" + #dsmow311#3 + "]"; |QBF aAlfa;
      |FINSI;
      |SI #dsmow311#4 ! 0;
         aAlfa = aAlfa + " Inmueble [" + #dsmow311#4 + "]"; |QBF aAlfa;
      |FINSI;

      #dsmow321#3 = aAlfa;
      #dsmow321#6 = #dsmow311#2;
      #dsmow321#5 = #dsmow311#3;
      #dsmow321#4 = #dsmow311#4;
      #dsmow321#7 = #dsmow311#5;
      #dsmow321#1 = #dsmow311#52;
      #dsmow321#10 = #dsmow311#0;
      |GRABA 020#dsmow321.c;
   |FINSI;
   #dsmow321#8 = #dsmow311#42;
   |GRABA 020#dsmow321.a;

   nSwHay = 1;
|FPRC;

|DEFBUCLE EmiteLin;
   #dsm210ln#1;
   ;
   #dsm210ca#0, #dsm210ca#1, aDNif, nDInm, fDFecha, 000;
   #dsm210ca#0, #dsm210ca#1, aHNif, nHInm, fHFecha, 999;
   ;
   NULL, EmiteLin;
|FIN;

|PROCESO EmiteInm;
   aDNif = " " * 15;    aHNif = " " * 15;
   nDInm = #dsm210in#2; nHInm = #dsm210in#2;
   nLinNif = 0;
   nContEmis = 0;
   |BUCLE EmiteLin;
|FPRC;

|DEFBUCLE EmiteInm;
  #dsm210in#1;
  ;
  #dsm210ca#0, #dsm210ca#1, 000;
  #dsm210ca#0, #dsm210ca#1, 999;
  ;
  NULL, EmiteInm;
|FIN;

|PROCESO EmiteNif;
   nDInm = 00;          nHInm = 00;
   aDNif = #dsm210ni#2; aHNif = #dsm210ni#2;
   nLinNif = nLinNif + 1;
   nContEmis = 0;
   |BUCLE EmiteLin;
|FPRC;

|DEFBUCLE EmiteNif;
 #dsm210ni#1;
 ;
 #dsm210ca#0, #dsm210ca#1, "               ";
 #dsm210ca#0, #dsm210ca#1, "zzzzzzzzzzzzzzz";
 ;
 NULL, EmiteNif;
|FIN;

|PROCESO EmiteTR;

   #dsm210tr#0 = #dsm210ca#1;
   #dsm210tr#6 = nEj210tr;
   |LEE 000#dsm210tr.=;
   |SI FSalida ! 0; |DDEFECTO #dsm210tr; |FINSI;

   |SI #dsm210tr#2 = "S";
       |BUCLE EmiteInm;
   |SINO;
      |SI #dsm210tr#3 = "S";
          nLinNif = 0; |BUCLE EmiteNif;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE EmiteTR;
  #dsm210ca#1;
  ;
  #dsm210dp#0, 00;
  #dsm210dp#0, 99;
  ;
  NULL, EmiteTR;
|FIN;

|PROCESO Masivo210;
   #dsmow354#0 = #dsm210dp#0;
   |LEE 000#dsmow354.=;
   |SI FSalida ! 0;
      nSwHay = 0; |BUCLE EmiteTR;

      |SI nSwHay > 0;
         |DDEFECTO #dsmow354;
         #dsmow354#0 = #dsm210dp#0;
         #dsmow354#1 = #dsm210dp#1;
         #dsmow354#2 = #dsm210dp#2;
         |GRABA 020#dsmow354.c
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Masivo210;
#dsm210dp#1;
;
#dsmow353#1;
#dsmow353#2;
;
NULL, Masivo210;
|FIN;

|PROCESO EmiteTRMasivo;
   |SI #dsmow353#0 = "S";
      |PARA nCont = 3; |SI nCont [ 22; |HACIENDO nCont = nCont + 1;
         #dsm210dp#0 = #dsmow353#nCont#;
         |LEE 000#dsm210dp.=;
         |SI FSalida = 0;
            #dsmow354#0 = #dsm210dp#0;
            |LEE 000#dsmow354.=;
            |SI FSalida ! 0;
               nSwHay = 0; |BUCLE EmiteTR;

               |SI nSwHay > 0;
                  |DDEFECTO #dsmow354;
                  #dsmow354#0 = #dsm210dp#0;
                  #dsmow354#1 = #dsm210dp#1;
                  #dsmow354#2 = #dsm210dp#2;
                  |GRABA 020#dsmow354.c
               |FINSI;
            |FINSI;
         |FINSI;
      |SIGUE;
   |SINO;
      |BUCLE Masivo210;
   |FINSI;
|FPRC;

|PROCESO Pagina1_2018;
      |DDEFECTO #t1821001;

      |SI aTitul ! "C";
          nCampo1 = 5;
          nCampo2 = 6;
      |SINO;
          nCampo1 = 38;
          nCampo2 = 39;
      |FINSI;

      |SI #dsmow311#42 > 0;
          aAlfa = "I";
          |SI #dsm210fp#nCampo2# = "E"; #dsm210fp#nCampo1# = " "; |FINSI;
          |SI #dsm210fp#nCampo1# = "X";
              aAlfa = "T";
          |SINO;
              |SI #dsm210fp#nCampo2# = "E"; aAlfa = "I"; |FINSI;
              |SI #dsm210fp#nCampo2# = "A"; aAlfa = "I"; |FINSI;
              |SI #dsm210fp#nCampo2# = "D"; aAlfa = "U"; |FINSI;
          |FINSI;
      |FINSI;

      |SI #dsmow311#42 = 0; aAlfa = "N"; |FINSI;
      |SI #dsmow311#42 < 0;
          |SI #dsm210fp#8 = "S";
              aAlfa = "R";
          |SINO;
              |SI #dsm210fp#nCampo1# = "E";
                   aAlfa = "D";
              |SINO;
                   aAlfa = "X";
              |FINSI;
         |FINSI;
      |FINSI;
      #t1821001#6 = aAlfa;

      |SI aTitul = "C";
          nCampo1 = 65;
          nCampo2 = 64;
      |SINO;
          nCampo1 = 2;
          nCampo2 = 1;
      |FINSI;

      |SI #dsmow310#4 ! "S";
          eaVarDni = #dsmow310#2;
          aNomPres = #dsmow310#3;
      |SINO;
          eaVarDni = #dsm210dp#nCampo1#;
          aNomPres = #dsm210dp#nCampo2#;
      |FINSI;

      |HAZ CalculameDNI;                 #t1821001#7 = eaVarDni;
      eaAlfa =aNomPres; |HAZ QuitaRaros; #t1821001#8 = eaAlfa;

      |SI #dsmow310#4 = "S"; #t1821001#9  = "X"; |FINSI;
      |SI #dsmow310#4 = "R"; #t1821001#10 = "X"; |FINSI;
      |SI #dsmow310#4 = "P"; #t1821001#11 = "X"; |FINSI;
      |SI #dsmow310#4 = "D"; #t1821001#12 = "X"; |FINSI;
      |SI #dsmow310#4 = "G"; #t1821001#13 = "X"; |FINSI;
      |SI #dsmow310#4 = "T"; #t1821001#14 = "X"; |FINSI;

      |SI #dsmow311#52 = 0;  #t1821001#15 = "X"; |FINSI; || Agrupacion

      aAlfa = #dsmow310#0 + "T";|SI aAlfa = "0T"; aAlfa = "0A"; |FINSI;
      #t1821001#16 = aAlfa;

      #t1821001#17 = #dsmow310#12; || Ejercicio de devengo

      |SI #dsmow311#52 ! 0; |Y #dsmow311#53 > "01.01.0000";
          aAlfa = #dsmow311#53;
          aAlfa = (aAlfa % 0102) + (aAlfa % 0402) + (aAlfa % 0704);
          #t1821001#18 = aAlfa;
      |FINSI;

      aAlfa = ("00"  + #dsmow311#1) % -102; #t1821001#19 = aAlfa;
      aAlfa = ("000" + #dsmow311#2) % -103; #t1821001#20 = aAlfa;

      eaVarDni = #dsm210dp#nCampo1#;
      |HAZ CalculameDNI;                            #t1821001#21 = eaVarDni;
                                                    #t1821001#22 = #dsm210dp#3;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#23 = eaAlfa;

      |SI aTitul = "C";
          nCampo1 = 100;
          nCampo2 = 67;
      |SINO;
          nCampo1 = 61;
          nCampo2 = 4;
      |FINSI;

      eaAlfa =  #dsm210dp#nCampo1#; |HAZ QuitaRaros; #t1821001#24 = eaAlfa;
      |SI #dsm210dp#nCampo2# > "01.01.0000";
          aAlfa = #dsm210dp#nCampo2#;
          aAlfa = (aAlfa % 0102) + (aAlfa % 0402) + (aAlfa % 0704);
          #t1821001#25 = aAlfa;
      |FINSI;

      nCampo2 = nCampo2 + 1;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#26 = eaAlfa;

      nCampo2 = nCampo2 + 1;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#27 = eaAlfa;

      nCampo2 = nCampo2 + 1;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#28 = eaAlfa;

      |SI aTitul = "C";
          nCampo2 = 90;
      |SINO;
          nCampo2 = 27;
      |FINSI;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#29 = eaAlfa;

      nCampo2 = nCampo2 + 1;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#30 = eaAlfa;

      nCampo2 = nCampo2 + 1;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#31 = eaAlfa;

      nCampo2 = nCampo2 + 1;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#32 = eaAlfa;

      nCampo2 = nCampo2 + 1;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#33 = eaAlfa;

      nCampo2 = nCampo2 + 1;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#34 = eaAlfa;

      nCampo2 = nCampo2 + 1;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#35 = eaAlfa;

      nCampo2 = nCampo2 + 1;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#36 = eaAlfa;
      nCampo2 = nCampo2 + 1;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#37 = eaAlfa;
      nCampo2 = nCampo2 + 1;
      eaAlfa = #dsm210dp#nCampo2#; |HAZ QuitaRaros; #t1821001#38 = eaAlfa;

      eaVarDni = #dsm210dp#37;
      |HAZ CalculameDNI;                      #t1821001#39 = eaVarDni;
      |QBF eaVarDni;
      |SI eaVarDni ! "";
                                                    #t1821001#40 = #dsm210dp#38;
          eaAlfa = #dsm210dp#39; |HAZ QuitaRaros;   #t1821001#41 = eaAlfa;
                                                    #t1821001#42 = #dsm210dp#40;
          eaAlfa = #dsm210dp#41; |HAZ QuitaRaros;   #t1821001#43 = eaAlfa;
          eaAlfa = #dsm210dp#42; |HAZ QuitaRaros;   #t1821001#44 = eaAlfa;
          eaAlfa = #dsm210dp#43; |HAZ QuitaRaros;   #t1821001#45 = eaAlfa;
          aAlfa  = ("00000" + #dsm210dp#44) % -105; #t1821001#46 = aAlfa;
          eaAlfa = #dsm210dp#45; |HAZ QuitaRaros;   #t1821001#47 = eaAlfa;
          eaAlfa = #dsm210dp#46; |HAZ QuitaRaros;   #t1821001#48 = eaAlfa;
          eaAlfa = #dsm210dp#47; |HAZ QuitaRaros;   #t1821001#49 = eaAlfa;
          eaAlfa = #dsm210dp#48; |HAZ QuitaRaros;   #t1821001#50 = eaAlfa;
          eaAlfa = #dsm210dp#49; |HAZ QuitaRaros;   #t1821001#51 = eaAlfa;
          eaAlfa = #dsm210dp#50; |HAZ QuitaRaros;   #t1821001#52 = eaAlfa;
          eaAlfa = #dsm210dp#51; |HAZ QuitaRaros;   #t1821001#53 = eaAlfa;
          eaAlfa = #dsm210dp#52; |HAZ QuitaRaros;   #t1821001#54 = eaAlfa;

          aAlfa = (("00" + #dsm210dp#53) % -102) + (("000" + #dsm210dp#54) % -103);
                                                    #t1821001#55 = aAlfa;
          aAlfa  = ("00000" + #dsm210dp#56) % -105; #t1821001#57 = aAlfa;
          aAlfa  = ("00"    + #dsm210dp#53) % -102; #t1821001#58 = aAlfa;

          eaAlfa = #dsm210dp#58; |HAZ QuitaRaros;   #t1821001#59 = eaAlfa;
          eaAlfa = #dsm210dp#59; |HAZ QuitaRaros;   #t1821001#60 = eaAlfa;
          eaAlfa = #dsm210dp#60; |HAZ QuitaRaros;   #t1821001#61 = eaAlfa;
      |FINSI;

      eaAlfa = #dsmow311#49; |HAZ QuitaRaros;   #t1821001#62 = eaAlfa;
                                                #t1821001#63 = #dsmow311#51;

      eaAlfa = #dsmow311#50; |HAZ QuitaRaros;   #t1821001#64 = eaAlfa;

      eaAlfa = #dsminmex#3;  |HAZ QuitaRaros;   #t1821001#65 = eaAlfa;
      eaAlfa = #dsminmex#4;  |HAZ QuitaRaros;   #t1821001#66 = eaAlfa;
      eaAlfa = #dsminmex#5;  |HAZ QuitaRaros;   #t1821001#67 = eaAlfa;
      aAlfa  = ("00000" + #dsminmex#6) % -105;  #t1821001#68 = aAlfa;
      eaAlfa = #dsminmex#7;  |HAZ QuitaRaros;   #t1821001#69 = eaAlfa;
      eaAlfa = #dsminmex#8;  |HAZ QuitaRaros;   #t1821001#70 = eaAlfa;
      eaAlfa = #dsminmex#9;  |HAZ QuitaRaros;   #t1821001#71 = eaAlfa;
      eaAlfa = #dsminmex#10; |HAZ QuitaRaros;   #t1821001#72 = eaAlfa;
      eaAlfa = #dsminmex#11; |HAZ QuitaRaros;   #t1821001#73 = eaAlfa;
      eaAlfa = #dsminmex#12; |HAZ QuitaRaros;   #t1821001#74 = eaAlfa;

      eaAlfa = #dsminmex#13; |HAZ QuitaRaros;   #t1821001#75 = eaAlfa;
      eaAlfa = #dsminmex#14; |HAZ QuitaRaros;   #t1821001#76 = eaAlfa;

      aAlfa =  (("00" + #dsminmex#15) % -102) + (("000" + #dsminmex#16) % -103);
                                                #t1821001#77 = aAlfa;
      aAlfa  = ("00000" + #dsminmex#23) % -105; #t1821001#79 = aAlfa;
      aAlfa  = ("00"    + #dsminmex#15) % -102; #t1821001#80 = aAlfa;
      eaAlfa = #dsminmex#2;  |HAZ QuitaRaros;   #t1821001#81 = eaAlfa;

      enNume = (#dsmow311#6 * nFactor) ! 2;  |HAZ Conver17;     #t1821001#82 = eaAlfa;
      enNume = (#dsmow311#7 * nFactor) ! 2;  |HAZ Conver17;     #t1821001#83 = eaAlfa;
      enNume = (#dsmow311#8 * nFactor) ! 2;  |HAZ Conver17;     #t1821001#84 = eaAlfa;
      enNume = (#dsmow311#9 * nFactor) ! 2;  |HAZ Conver17;     #t1821001#85 = eaAlfa;
      enNume = (#dsmow311#10 * nFactor) ! 2; |HAZ Conver17;     #t1821001#86 = eaAlfa;

      |SI aTitul = "C"; |Y #dsmow311#13 = 0; |Y #dsmow311#14 = 100;
          || campos en blanco
      |SINO;
          #t1821001#87 = #dsmow311#12;
          |SI #dsmow311#12 ! " ";
              enNume = #dsmow311#13 * 100; #t1821001#88 = ("00000" + enNume) % -105;
              enNume = #dsmow311#14 * 100; #t1821001#89 = ("00000" + enNume) % -105;
          |FINSI;
      |FINSI;

      |SI aTitul = "C"; |Y #dsmow311#13 = 0; |Y #dsmow311#14 = 100;
          || campos en blanco
      |SINO;
          eaVarDni = #dsmow311#15; |HAZ CalculameDNI; #t1821001#90 = eaVarDni;
          eaAlfa   = #dsmow311#16; |HAZ QuitaRaros;   #t1821001#91 = eaAlfa;
      |FINSI;

      enNume = (#dsmow311#17 * nFactor) ! 2;  |HAZ Conver17;    #t1821001#92  = eaAlfa;
      enNume = (#dsmow311#19 * nFactor) ! 2;  |HAZ Conver17;    #t1821001#93  = eaAlfa;
      enNume = (#dsmow311#21 * nFactor) ! 2;  |HAZ Conver17;    #t1821001#94  = eaAlfa;
      enNume = (#dsmow311#23 * nFactor) ! 2;  |HAZ Conver17;    #t1821001#95  = eaAlfa;
      enNume = (#dsmow311#18 * nFactor) ! 2;  |HAZ Conver17;    #t1821001#96  = eaAlfa;
      enNume = (#dsmow311#20 * nFactor) ! 2;  |HAZ Conver17;    #t1821001#97  = eaAlfa;
      enNume = (#dsmow311#22 * nFactor) ! 2;  |HAZ Conver17;    #t1821001#98  = eaAlfa;
      enNume = (#dsmow311#24 * nFactor) ! 2;  |HAZ Conver17;    #t1821001#99  = eaAlfa;
      enNume = (#dsmow311#25 * nFactor) ! 2;  |HAZ Conver17;    #t1821001#100 = eaAlfa;

      |SI #dsmow311#26 > "01.01.0000";
          aAlfa = #dsmow311#26;
          aAlfa = (aAlfa % 102) + (aAlfa % 402) + (aAlfa % 704);
          #t1821001#101 = aAlfa;
      |FINSI;
      |SI #dsmow311#27 > "01.01.0000";
          aAlfa = #dsmow311#27;
          aAlfa = (aAlfa % 102) + (aAlfa % 402) + (aAlfa % 704);
          #t1821001#102 = aAlfa;
      |FINSI;

      eaAlfa = #dsmow311#28; |HAZ QuitaRaros;   #t1821001#103 = eaAlfa;
      enNume = (#dsmow311#11 * nFactor) ! 2; |HAZ Conver17;     #t1821001#104 = eaAlfa;
                                                #t1821001#105 = #dsmow311#30;
                                                #t1821001#106 = #dsmow311#31;

      enNume = #dsmow311#32 * 100;              #t1821001#107 = ("00000" + enNume) % -105;
      enNume = (#dsmow311#33 * nFactor) ! 2; |HAZ Conver17;    #t1821001#108 = eaAlfa;
      enNume = (#dsmow311#34 * nFactor) ! 2; |HAZ Conver17;    #t1821001#109 = eaAlfa;
      enNume = (#dsmow311#35 * nFactor) ! 2; |HAZ Conver17;    #t1821001#110 = eaAlfa;

      enNume = #dsmow311#36 * 100;              #t1821001#111 = ("00000" + enNume) % -105;
      enNume = (#dsmow311#37 * nFactor) ! 2; |HAZ Conver17;    #t1821001#112 = eaAlfa;
      enNume = (#dsmow311#38 * nFactor) ! 2; |HAZ Conver17;    #t1821001#113 = eaAlfa;
      enNume = (#dsmow311#39 * nFactor) ! 2; |HAZ Conver17;    #t1821001#114 = eaAlfa;
      enNume = (#dsmow311#40 * nFactor) ! 2; |HAZ Conver17;    #t1821001#115 = eaAlfa;
      enNume = (#dsmow311#41 * nFactor) ! 2; |HAZ Conver17;    #t1821001#116 = eaAlfa;
      enNume = (#dsmow311#42 * nFactor) ! 2; |HAZ Conver17;    #t1821001#117 = eaAlfa;

                                                #t1821001#118 = #dsmow311#43;
      eaAlfa = #dsmow311#44; |HAZ QuitaRaros;   #t1821001#119 = eaAlfa;
      eaAlfa = #dsmow311#45; |HAZ QuitaRaros;   #t1821001#120 = eaAlfa;

      aAlfa = #dsmow311#46; |QBF aAlfa;
      |SI aAlfa ! "";
          eaAlfa = #dsmow311#46; |HAZ QuitaRarosTfno; #t1821001#121 = eaAlfa;
      |FINSI;
      aAlfa = #dsmow311#47; |QBF aAlfa;
      |SI aAlfa ! "";
           eaAlfa = #dsmow311#47; |HAZ QuitaRarosTfno; #t1821001#122 = eaAlfa;
      |FINSI;
      eaAlfa = #dsmow311#48; |HAZ QuitaRaros;     #t1821001#123 = eaAlfa;

      #t1821001#129 = &13 + &10;

     |SI #dsmow311#1 = 36;
         aAlfa = #t1821001#28;
         |PDEFECTO #t1821001, 21, 39;
         #t1821001#16 = "0A";
         #t1821001#23 = "PROCEDIMIENTO ARTICULO 18 ORDEN EHA/3316/2010";
         #t1821001#28 = aAlfa;
     |FINSI;

     |PARA nCampo1 = 1;  |SI nCampo1 [ 128;  |HACIENDO nCampo1 = nCampo1 + 1;
           aAlfa = #t1821001#nCampo1#;
           |XGRABA nHandle, aAlfa;
     |SIGUE;
|FPRC;

|PROCESO Pagina2_2018;

      |DDEFECTO #t1821002;

      |SI aTitul ! "C";
          nCampo1 = 5;
          nCampo2 = 6;
      |SINO;
          nCampo1 = 38;
          nCampo2 = 39;
      |FINSI;

      aCadena = "0";
      |SI #dsmow311#42 > 0;
          |SI #dsm210fp#nCampo2# = "E"; #dsm210fp#nCampo1# = " "; |FINSI;

          |SI #dsm210fp#nCampo1# = "X";
              aCadena = "4";
          |SINO;
              |SI #dsm210fp#nCampo2# = "E"; aCadena = "1"; |FINSI;
              |SI #dsm210fp#nCampo2# = "A"; aCadena = "2"; |FINSI;
              |SI #dsm210fp#nCampo2# = "D"; aCadena = "3"; |FINSI;
          |FINSI;
      |FINSI;
      #t1821002#6 = aCadena;

      nCampo1 = nCampo1 + 12;
      nCampo2 = nCampo2 + 12;

      eaAlfa = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#8 = eaAlfa;
      eaAlfa = #dsm210fp#nCampo2#; |HAZ QuitaRaros; #t1821002#9 = eaAlfa;

      aCadena = "";
      nCampo1 = nCampo1 - 6;
      aAlfa = #dsm210fp#nCampo1#; |QBF aAlfa;
      |SI aAlfa ! "";
          aCadena = #dsm210fp#nCampo1#;           nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#;
      |SINO;
          nCampo1 = nCampo1 + 8;
          aCadena = #dsm210fp#nCampo1#;           nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#;
      |FINSI;
      #t1821002#10 = aCadena;

      |SI aTitul ! "C";
          nCampo1 = 28;
      |SINO;
          nCampo1 = 61;
      |FINSI;

      eaAlfa = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#11 = eaAlfa;
      nCampo1 = nCampo1 + 1;
      eaAlfa = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#12 = eaAlfa;
      nCampo1 = nCampo1 + 1;
      eaAlfa = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#13 = eaAlfa;

      nCampo1 = nCampo1 + 1;
      eaAlfa = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#15 = eaAlfa;

      nCampo1 = nCampo1 + 1;
      eaAlfa = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#17 = eaAlfa;

      nCampo1 = nCampo1 + 1;
      eaAlfa = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#19 = eaAlfa;

      nCampo1 = nCampo1 + 1;
      eaAlfa = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#21 = eaAlfa;

      aCadena = " ";
      |SI aTitul ! "C";
          |SI #dsm210fp#8  = "S"; aCadena = "X"; |FINSI;
      |SINO;
          |SI #dsm210fp#41 = "S"; aCadena = "X"; |FINSI;
      |FINSI;
      #t1821002#22 = aCadena;

      |SI aTitul ! "C";
          nCampo1 = 9;
          nCampo2 = 10;
      |SINO;
          nCampo1 = 42;
          nCampo2 = 43;
      |FINSI;
      eaAlfa = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#24 = eaAlfa;
      eaAlfa = #dsm210fp#nCampo2#; |HAZ QuitaRaros; #t1821002#25 = eaAlfa;

      aCadena = "";
      nCampo1 = nCampo1 + 2;
      aAlfa = #dsm210fp#nCampo1#; |QBF aAlfa;
      |SI aAlfa ! "";
          aCadena = #dsm210fp#nCampo1#;           nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#;
          nCampo1 = nCampo1 + 11;
      |SINO;
          nCampo1 = nCampo1 + 8;
          aCadena = #dsm210fp#nCampo1#;           nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#; nCampo1 = nCampo1 + 1;
          aCadena = aCadena + #dsm210fp#nCampo1#;
      |FINSI;
      #t1821002#26 = aCadena;

      nCampo1 = nCampo1 + 1;
      eaAlfa  = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#27 = eaAlfa;
      nCampo1 = nCampo1 + 1;
      eaAlfa  = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#28 = eaAlfa;
      nCampo1 = nCampo1 + 1;
      eaAlfa  = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#29 = eaAlfa;

      nCampo1 = nCampo1 + 1;
      eaAlfa  = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#31 = eaAlfa;

      nCampo1 = nCampo1 + 1;
      eaAlfa  = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#33 = eaAlfa;

      nCampo1 = nCampo1 + 1;
      eaAlfa  = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#35 = eaAlfa;

      nCampo1 = nCampo1 + 1;
      eaAlfa  = #dsm210fp#nCampo1#; |HAZ QuitaRaros; #t1821002#37 = eaAlfa;

      aCadena = " ";
      |SI #dsmow311#42 > 0;
          |PDEFECTO #t1821002, 22, 38;
      |FINSI;
      |SI #dsmow311#42 < 0;
          |PDEFECTO #t1821002,  8, 22;
      |FINSI;
      |SI #dsmow311#42 = 0;
          aCadena = "X";
          |PDEFECTO #t1821002,  8, 38;
      |FINSI;

      #t1821002#38 = aCadena;

      #t1821002#43 = &13 + &10;

     |PARA nCampo1 = 1;  |SI nCampo1 [ 42;  |HACIENDO nCampo1 = nCampo1 + 1;
           aAlfa = #t1821002#nCampo1#;
           |XGRABA nHandle, aAlfa;
     |SIGUE;
|FPRC;

|PROCESO Pagina1_2017;
      aAlfa = "<T21001> "; |XGRABA nHandle, aAlfa;
      |SI #dsmow311#42 > 0;
         |SI aTitul ! "C";
            aAlfa = "I";
            |SI #dsm210fp#6 = "E"; #dsm210fp#5 = " "; |FINSI;
            |SI #dsm210fp#5 = "X";
               aAlfa = "T";
            |SINO;
               |SI #dsm210fp#6 = "E"; aAlfa = "I"; |FINSI;
               |SI #dsm210fp#6 = "A"; aAlfa = "I"; |FINSI;
               |SI #dsm210fp#6 = "D"; aAlfa = "U"; |FINSI;
            |FINSI;
         |SINO;
            aAlfa = "I";
            |SI #dsm210fp#39 = "E"; #dsm210fp#38 = " "; |FINSI;
            |SI #dsm210fp#38 = "X";
               aAlfa = "T";
            |SINO;
               |SI #dsm210fp#39 = "E"; aAlfa = "I"; |FINSI;
               |SI #dsm210fp#39 = "A"; aAlfa = "I"; |FINSI;
               |SI #dsm210fp#39 = "D"; aAlfa = "U"; |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
      |SI #dsmow311#42 = 0; aAlfa = "N"; |FINSI;
      |SI #dsmow311#42 < 0;
         |SI #dsm210fp#8 = "S";
            aAlfa = "R";
         |SINO;
            |SI aTitul ! "C";
               |SI #dsm210fp#5 = "E";
                  aAlfa = "D";
               |SINO;
                  aAlfa = "X";
               |FINSI;
            |SINO;
               |SI #dsm210fp#38 = "E";
                  aAlfa = "D";
               |SINO;
                  aAlfa = "X";
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
      |XGRABA nHandle, aAlfa;

      |SI #dsmow310#4 ! "S";
         aNifPres = #dsmow310#2; |QBF aNifPres;
         aNomPres = #dsmow310#3;
      |SINO;
         |SI aTitul = "C"; aAlfa = #dsm210dp#65; |SINO; aAlfa = #dsm210dp#2; |FINSI;
         aNifPres = aAlfa; |QBF aNifPres;
         |SI aTitul = "C"; aAlfa = #dsm210dp#64; |SINO; aAlfa = #dsm210dp#1; |FINSI;
         aNomPres = aAlfa;
      |FINSI;

      |QBF aNomPres; aNomPres = (aNomPres + (" " * 100)) %0199;
      aNomPres = aNomPres + " ";

      aNifPres = aNifPres - ".";
      |PARA; |SI FSalida ! 0; |HACIENDO;
         aNifPres = aNifPres - ".";
      |SIGUE;
      aNifPres = aNifPres - "-";
      |PARA; |SI FSalida ! 0; |HACIENDO;
         aNifPres = aNifPres - "-";
      |SIGUE;

      LongDec = 0; aAlfa = aNifPres + "         ";
      aAlfa = aAlfa % 0109; |XGRABA nHandle, aAlfa;
      aAlfa = aNomPres; aAlfa = aAlfa % 0150;
      TipoDato = "A"; Long = 50;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      aAlfa = aNomPres; aAlfa = aAlfa % -150;
      TipoDato = "A"; Long = 50;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      aAlfa = " " * 25; |XGRABA nHandle, aAlfa;

      |SI #dsmow310#4 = "S"; aAlfa = "X     "; |FINSI;
      |SI #dsmow310#4 = "R"; aAlfa = " X    "; |FINSI;
      |SI #dsmow310#4 = "P"; aAlfa = "  X   "; |FINSI;
      |SI #dsmow310#4 = "D"; aAlfa = "   X  "; |FINSI;
      |SI #dsmow310#4 = "G"; aAlfa = "    X "; |FINSI;
      |SI #dsmow310#4 = "T"; aAlfa = "     X"; |FINSI;

      |XGRABA nHandle, aAlfa;
      || Agrupacion
      |SI #dsmow311#52 = 0; aAlfa = "X"; |SINO; aAlfa = " "; |FINSI; |XGRABA nHandle, aAlfa;
      aAlfa = #dsmow310#0 + "T";
      |SI aAlfa = "0T"; aAlfa = "0A"; |FINSI;
      |XGRABA nHandle, aAlfa;

      || Ejercicio de devengo
|| Modificacion por tique 5428 _ 52
      aAlfa = #dsmow310#12;
      |XGRABA nHandle, aAlfa;

      |SI #dsmow311#52 ! 0;
         aAlfa = #dsmow311#53; |QBF aAlfa;
         |SI aAlfa > "01.01.0000";
            aAlfa = (aAlfa % 0102) + (aAlfa % 0402) + (aAlfa % 0704);
          |SINO;
            aAlfa = "00000000";
         |FINSI;
      |SINO;
         aAlfa = "00000000";
      |FINSI;
      |XGRABA nHandle, aAlfa;

      aAlfa = ("00" + #dsmow311#1) % -102;  |XGRABA nHandle, aAlfa;
      aAlfa = ("000" + #dsmow311#2) % -103; |XGRABA nHandle, aAlfa;

      aCadena = ""; LongDec = 0;
      |SI aTitul = "C"; aAlfa = #dsm210dp#65; |SINO; aAlfa = #dsm210dp#2; |FINSI;
      TipoDato = "A"; Long = 9;                         |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + #dsm210dp#3;
      |SI aTitul = "C"; aAlfa = #dsm210dp#64; |SINO; aAlfa = #dsm210dp#1; |FINSI;
      TipoDato = "A"; Long = 90;                        |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 35);
      |SI aTitul = "C"; aAlfa = #dsm210dp#100; |SINO; aAlfa = #dsm210dp#61; |FINSI;
      TipoDato = "A"; Long = 15;                        |HAZ Formateo; aCadena = aCadena + aAlfa;
      |SI aTitul = "C"; aAlfa = #dsm210dp#67; |SINO; aAlfa = #dsm210dp#4; |FINSI;
      |QBF aAlfa;
      aCadena = aCadena + (aAlfa % 0102) + (aAlfa % 0402) + (aAlfa % 0704);
      |XGRABA nHandle, aCadena; aCadena = "";

      |SI aTitul = "C"; aAlfa = #dsm210dp#68; |SINO; aAlfa = #dsm210dp#5; |FINSI;
      TipoDato = "A"; Long = 30;                       |HAZ Formateo; aCadena = aCadena + aAlfa;
      |SI aTitul = "C"; aAlfa = #dsm210dp#69; |SINO; aAlfa = #dsm210dp#6; |FINSI;
      TipoDato = "A"; Long = 2;                        |HAZ Formateo; aCadena = aCadena + aAlfa;
      |SI aTitul = "C"; aAlfa = #dsm210dp#70; |SINO; aAlfa = #dsm210dp#7; |FINSI;
      TipoDato = "A"; Long = 2;                        |HAZ Formateo; aCadena = aCadena + aAlfa;

      |SI aTitul = "C"; aAlfa = #dsm210dp#90; |SINO; aAlfa = #dsm210dp#27; |FINSI;
      TipoDato = "A"; Long = 50;                         |HAZ Formateo; aCadena = aCadena + aAlfa;
      |SI aTitul = "C"; aAlfa = #dsm210dp#91; |SINO; aAlfa = #dsm210dp#28; |FINSI;
      TipoDato = "A"; Long = 40;                        |HAZ Formateo; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      |SI aTitul = "C"; aAlfa = #dsm210dp#92; |SINO; aAlfa = #dsm210dp#29; |FINSI;
      TipoDato = "A"; Long = 30;                        |HAZ Formateo; aCadena = aCadena + aAlfa;
      |SI aTitul = "C"; aAlfa = #dsm210dp#93; |SINO; aAlfa = #dsm210dp#30; |FINSI;
      TipoDato = "A"; Long = 90;                        |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 10);
      |SI aTitul = "C"; aAlfa = #dsm210dp#94; |SINO; aAlfa = #dsm210dp#31; |FINSI;
      TipoDato = "A"; Long = 10;                        |HAZ Formateo; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      |SI aTitul = "C"; aAlfa = #dsm210dp#95; |SINO; aAlfa = #dsm210dp#32; |FINSI;
      TipoDato = "A"; Long = 30;                        |HAZ Formateo; aCadena = aCadena + aAlfa;
      |SI aTitul = "C"; aAlfa = #dsm210dp#96; |SINO; aAlfa = #dsm210dp#33; |FINSI;
      TipoDato = "A"; Long = 2;                         |HAZ Formateo; aCadena = aCadena + aAlfa;
      |SI aTitul = "C";
         aCadena = aCadena + #dsm210dp#97 + #dsm210dp#98 + #dsm210dp#99;
      |SINO;
         aCadena = aCadena + #dsm210dp#34 + #dsm210dp#35 + #dsm210dp#36;
      |FINSI;
      |XGRABA nHandle, aCadena; aCadena = "";

      || Representante

      aAlfa = #dsm210dp#37;
      aAlfa = aAlfa - ".";
      |PARA; |SI FSalida ! 0; |HACIENDO;
         aAlfa = aAlfa - ".";
      |SIGUE;
      aAlfa = aAlfa - "-";
      |PARA; |SI FSalida ! 0; |HACIENDO;
         aAlfa = aAlfa - "-";
      |SIGUE;

      aNifRep = aAlfa; |QBF aNifRep;
      aAlfa = aAlfa % 0109; aCadena = aCadena + aAlfa;
      |SI aNifRep ! "";
         aCadena = aCadena + #dsm210dp#38;
      |SINO;
         aCadena = aCadena + " ";
      |FINSI;

      TipoDato = "A"; Long = 90;  aAlfa = #dsm210dp#39; |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 35);
      |SI aNifRep ! "";
         aCadena = aCadena + #dsm210dp#40;
      |SINO;
         aCadena = aCadena + " ";
      |FINSI;
      |XGRABA nHandle, aCadena; aCadena = "";

      TipoDato = "A"; Long = 5;  aAlfa = #dsm210dp#41; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 50; aAlfa = #dsm210dp#42; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 3;  aAlfa = #dsm210dp#43; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 5;  aAlfa = #dsm210dp#44; |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + #dsm210dp#45 + #dsm210dp#46 + #dsm210dp#47;
      aCadena = aCadena + #dsm210dp#48 + #dsm210dp#49 + #dsm210dp#50;
      TipoDato = "A"; Long = 40;  aAlfa = #dsm210dp#51; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 30;  aAlfa = #dsm210dp#52; |HAZ Formateo; aCadena = aCadena + aAlfa;
      aAlfa = (("00" + #dsm210dp#53) % -102) + (("000" + #dsm210dp#54) % -103);
      TipoDato = "N"; Long = 5;   aAlfa = aAlfa;        |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 30;  aAlfa = #dsm210dp#55; |HAZ Formateo;
      aCadena = aCadena + aAlfa;

      TipoDato = "N"; Long = 5;   aAlfa = #dsm210dp#56; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 2;   aAlfa = #dsm210dp#53; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 9;   aAlfa = #dsm210dp#58; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 9;   aAlfa = #dsm210dp#59; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 9;   aAlfa = #dsm210dp#60; |HAZ Formateo; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      TipoDato = "A"; Long = 9;   aAlfa = #dsmow311#49;   |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + #dsmow311#51;
      TipoDato = "A"; Long = 90;   aAlfa = #dsmow311#50;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 35);
      |XGRABA nHandle, aCadena; aCadena = "";

      TipoDato = "A"; Long = 5;   aAlfa = #dsminmex#3;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 50;  aAlfa = #dsminmex#4;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + #dsminmex#5;
      TipoDato = "N"; Long = 5;   aAlfa = #dsminmex#6;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + #dsminmex#7 + #dsminmex#8 + #dsminmex#9 + #dsminmex#10 + #dsminmex#11 + #dsminmex#12;
      TipoDato = "A"; Long = 40;  aAlfa = #dsminmex#13;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 30;  aAlfa = #dsminmex#14;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      aAlfa = #dsminmex#15; |QBF aAlfa; aAlfa = (("00" + aAlfa) % -102); aCadena = aCadena + aAlfa;
      aAlfa = #dsminmex#16; |QBF aAlfa; aAlfa = (("000" + aAlfa) % -103); aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 30;  aAlfa = #dsminmex#17;  |HAZ Formateo;
      aCadena = aCadena + aAlfa;

      TipoDato = "N"; Long = 5;   aAlfa = #dsminmex#23;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aAlfa = #dsminmex#15; |QBF aAlfa; aAlfa = (("00" + aAlfa) % -102); aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 20;  aAlfa = #dsminmex#2;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      LongDec = 2;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#6  * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#7  * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#8  * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#9  * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#10 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;

      TipoDato = "N"; Long = 3;
      |SI aTitul = "C"; |Y #dsmow311#13 = 0; |Y #dsmow311#14 = 100;
         aCadena = aCadena + " ";
         aAlfa = "0"; |HAZ Formateo; aCadena = aCadena + aAlfa;
         aAlfa = "0"; |HAZ Formateo; aCadena = aCadena + aAlfa;
      |SINO;
         aCadena = aCadena + #dsmow311#12;
         |SI #dsmow311#12 = " "; aAlfa = "0"; |SINO; aAlfa = #dsmow311#13; |FINSI;
         |HAZ Formateo; aCadena = aCadena + aAlfa;
         |SI #dsmow311#12 = " "; aAlfa = "0"; |SINO; aAlfa = #dsmow311#14; |FINSI;
         |HAZ Formateo; aCadena = aCadena + aAlfa;
      |FINSI;

      LongDec = 0;
      |SI aTitul = "C"; |Y #dsmow311#13 = 0; |Y #dsmow311#14 = 100;
         TipoDato = "A"; Long = 9;    aAlfa = "";           |HAZ Formateo; aCadena = aCadena + aAlfa;
         TipoDato = "A"; Long = 40;   aAlfa = "";           |HAZ Formateo; aCadena = aCadena + aAlfa;
      |SINO;
         TipoDato = "A"; Long = 9;    aAlfa = #dsmow311#15; |HAZ Formateo; aCadena = aCadena + aAlfa;
         TipoDato = "A"; Long = 40;   aAlfa = #dsmow311#16; |HAZ Formateo; aCadena = aCadena + aAlfa;
      |FINSI;
      |XGRABA nHandle, aCadena; aCadena = "";

      LongDec = 2;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#17 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#19 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#21 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#23 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#18 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#20 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#22 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#24 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#25 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      aAlfa = #dsmow311#26; |QBF aAlfa;
      aAlfa = (aAlfa % 0102) + (aAlfa % 0402) + (aAlfa % 0704);
      |SI aAlfa = "01010000"; aAlfa = "00000000"; |FINSI; aCadena = aCadena + aAlfa;
      aAlfa = #dsmow311#27; |QBF aAlfa;
      aAlfa = (aAlfa % 0102) + (aAlfa % 0402) + (aAlfa % 0704);
      |SI aAlfa = "01010000"; aAlfa = "00000000"; |FINSI; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      LongDec = 0;
      TipoDato = "A"; Long = 13;   aAlfa = #dsmow311#28; |HAZ Formateo; aCadena = aCadena + aAlfa;
      LongDec = 2;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#11 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      LongDec = 0;
      aCadena = aCadena + #dsmow311#30 + #dsmow311#31;
      LongDec = 2;
      TipoDato = "N"; Long = 3;    aAlfa = #dsmow311#32; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#33 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#34 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#35 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      TipoDato = "N"; Long = 3;    aAlfa = #dsmow311#36; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#37 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#38 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#39 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#40 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#41 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; nCalc = (#dsmow311#42 * nFactor) ! 2; aAlfa = nCalc; |HAZ Formateo; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      aCadena = aCadena + #dsmow311#43 + #dsmow311#44;
      TipoDato = "A"; Long = 70;   aAlfa = #dsmow311#45; |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 30);
      |XGRABA nHandle, aCadena; aCadena = "";

      LongDec = 0;
      TipoDato = "N"; Long = 15;   aAlfa = #dsmow311#46; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15;   aAlfa = #dsmow311#47; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 70;   aAlfa = #dsmow311#48; |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 43);
      |XGRABA nHandle, aCadena; aCadena = "";

      aCadena = " " * 200;    |XGRABA nHandle, aCadena;
      aCadena = " " * 200;    |XGRABA nHandle, aCadena;
      aCadena = " " * 152;    |XGRABA nHandle, aCadena;
      aCadena = "</T21001>" + &13 + &10;
      |XGRABA nHandle, aCadena;
|FPRC;

|PROCESO Pagina2_2017;

      LongDec = 0;
      aCadena = "<T21002> ";  |XGRABA nHandle, aCadena;
      aCadena = "0";
      |SI aTitul ! "C";
          |SI #dsmow311#42 > 0;
              |SI #dsm210fp#6 = "E"; #dsm210fp#5 = " "; |FINSI;
              |SI #dsm210fp#5 = "X";
                  aCadena = "4";
              |SINO;
                  |SI #dsm210fp#6 = "E"; aCadena = "1"; |FINSI;
                  |SI #dsm210fp#6 = "A"; aCadena = "2"; |FINSI;
                  |SI #dsm210fp#6 = "D"; aCadena = "3"; |FINSI;
              |FINSI;
          |SINO;
              aCadena = "0";
          |FINSI;

          |SI #dsm210fp#11 = "    ";
               aCadena = aCadena + "ES00";
          |SINO;
               aAlfa = #dsm210fp#11; aAlfa = aAlfa % 0102;
               |SI aAlfa = "  ";
                   TipoDato = "N"; Long = 4; |HAZ Formateo; aCadena = aCadena + aAlfa;
               |SINO;
                   aCadena = aCadena + aAlfa;
                   aAlfa = #dsm210fp#11; aAlfa = aAlfa % -102;
                   TipoDato = "N"; Long = 2; |HAZ Formateo; aCadena = aCadena + aAlfa;
               |FINSI;
          |FINSI;
          TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#12; |HAZ Formateo; aCadena = aCadena + aAlfa;
          TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#13; |HAZ Formateo; aCadena = aCadena + aAlfa;
          TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#14; |HAZ Formateo; aCadena = aCadena + aAlfa;
          TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#15; |HAZ Formateo; aCadena = aCadena + aAlfa;
          TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#16; |HAZ Formateo; aCadena = aCadena + aAlfa;
          aCadena = aCadena + (" " * 24);

          |XGRABA nHandle, aCadena;

          aCadena = "";
          TipoDato = "A"; Long = 15;   aAlfa = #dsm210fp#17; |HAZ Formateo; aCadena = aCadena + aAlfa;
          TipoDato = "A"; Long = 90;   aAlfa = #dsm210fp#18; |HAZ Formateo; aCadena = aCadena + aAlfa;
          aCadena = aCadena + (" " * 35);

          |PARA nCont = 19; |SI nCont [ 27; |HACIENDO nCont = nCont + 1;
                aCadena = aCadena + #dsm210fp#nCont#;
          |SIGUE;
          |XGRABA nHandle, aCadena; aCadena = "";

          aCadena = aCadena + #dsm210fp#28 + #dsm210fp#29;
          TipoDato = "A"; Long = 34; aAlfa = #dsm210fp#30; |HAZ Formateo; aCadena = aCadena + aAlfa;
          aCadena = aCadena + (" " * 16); |XGRABA nHandle, aCadena; aCadena = "";

          TipoDato = "A"; Long = 70;   aAlfa = #dsm210fp#31; |HAZ Formateo; aCadena = aAlfa;
          aCadena = aCadena + (" " * 55); |XGRABA nHandle, aCadena; aCadena = "";

          TipoDato = "A"; Long = 35;   aAlfa = #dsm210fp#32; |HAZ Formateo; aCadena = aAlfa;
          aCadena = aCadena + (" " * 65); |XGRABA nHandle, aCadena; aCadena = "";

          TipoDato = "A"; Long = 30;   aAlfa = #dsm210fp#33; |HAZ Formateo; aCadena = aAlfa;
          TipoDato = "A"; Long = 30;   aAlfa = #rpaises@#1;  |HAZ Formateo; aCadena = aCadena + aAlfa;
          aCadena = aCadena + #dsm210fp#34;

          |SI #dsm210fp#8 = "S"; aCadena = aCadena + "X"; |SINO; aCadena = aCadena + " "; |FINSI;
          aCadena = aCadena + #dsm210fp#9;
          TipoDato = "A"; Long = 90;   aAlfa = #dsm210fp#10;  |HAZ Formateo; aCadena = aCadena + aAlfa;
          aCadena = aCadena + (" " * 35);
          |XGRABA nHandle, aCadena; aCadena = "";

          |SI #dsm210fp#11 = "    ";
              aCadena = aCadena + "ES00";
          |SINO;
              aAlfa = #dsm210fp#11; aAlfa = aAlfa % 0102;
              |SI aAlfa = "  ";
                  TipoDato = "N"; Long = 4; |HAZ Formateo; aCadena = aCadena + aAlfa;
              |SINO;
                  aCadena = aCadena + aAlfa;
                  aAlfa = #dsm210fp#11; aAlfa = aAlfa % -102;
                  TipoDato = "N"; Long = 2; |HAZ Formateo; aCadena = aCadena + aAlfa;
              |FINSI;
          |FINSI;
          TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#12; |HAZ Formateo; aCadena = aCadena + aAlfa;
          TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#13; |HAZ Formateo; aCadena = aCadena + aAlfa;
          TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#14; |HAZ Formateo; aCadena = aCadena + aAlfa;
          TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#15; |HAZ Formateo; aCadena = aCadena + aAlfa;
          TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#16; |HAZ Formateo; aCadena = aCadena + aAlfa;
          TipoDato = "A"; Long = 15;   aAlfa = #dsm210fp#17; |HAZ Formateo; aCadena = aCadena + aAlfa;
          TipoDato = "A"; Long = 90;   aAlfa = #dsm210fp#18; |HAZ Formateo; aCadena = aCadena + aAlfa;
          aCadena = aCadena + (" " * 35);
          |PARA nCont = 19; |SI nCont [ 27; |HACIENDO nCont = nCont + 1;
                aCadena = aCadena + #dsm210fp#nCont#;
          |SIGUE;
          |XGRABA nHandle, aCadena; aCadena = "";

          aCadena = aCadena + #dsm210fp#28 + #dsm210fp#29;
          TipoDato = "A"; Long = 34; aAlfa = #dsm210fp#30; |HAZ Formateo; aCadena = aCadena + aAlfa;
          aCadena = aCadena + (" " * 16); |XGRABA nHandle, aCadena; aCadena = "";

          TipoDato = "A"; Long = 70;   aAlfa = #dsm210fp#31; |HAZ Formateo; aCadena = aAlfa;
          aCadena = aCadena + (" " * 55); |XGRABA nHandle, aCadena; aCadena = "";

          TipoDato = "A"; Long = 35;   aAlfa = #dsm210fp#32; |HAZ Formateo; aCadena = aCadena + aAlfa;
          aCadena = aCadena + (" " * 65); |XGRABA nHandle, aCadena; aCadena = "";

          TipoDato = "A"; Long = 30;   aAlfa = #dsm210fp#33; |HAZ Formateo; aCadena = aAlfa;
          TipoDato = "A"; Long = 30;   aAlfa = #rpaises@#1;  |HAZ Formateo; aCadena = aCadena + aAlfa;
          aCadena = aCadena + #dsm210fp#34;
          |XGRABA nHandle, aCadena;
          aCadena = "";
      |SINO;
           |SI #dsmow311#42 > 0;
               |SI #dsm210fp#39 = "E"; #dsm210fp#38 = " "; |FINSI;
               |SI #dsm210fp#38 = "X";
                   aCadena = "4";
               |SINO;
                   |SI #dsm210fp#39 = "E"; aCadena = "1"; |FINSI;
                   |SI #dsm210fp#39 = "A"; aCadena = "2"; |FINSI;
                   |SI #dsm210fp#39 = "D"; aCadena = "3"; |FINSI;
               |FINSI;
           |SINO;
               aCadena = "0";
           |FINSI;
           |SI #dsm210fp#44 = "    ";
               aCadena = aCadena + "ES00";
           |SINO;
              aAlfa = #dsm210fp#44; aAlfa = aAlfa % 0102;
              |SI aAlfa = "  ";
                  TipoDato = "N"; Long = 4; |HAZ Formateo; aCadena = aCadena + aAlfa;
              |SINO;
                  aCadena = aCadena + aAlfa;
                  aAlfa = #dsm210fp#44; aAlfa = aAlfa % -102;
                  TipoDato = "N"; Long = 2; |HAZ Formateo; aCadena = aCadena + aAlfa;
              |FINSI;
           |FINSI;
           TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#45; |HAZ Formateo; aCadena = aCadena + aAlfa;
           TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#46; |HAZ Formateo; aCadena = aCadena + aAlfa;
           TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#47; |HAZ Formateo; aCadena = aCadena + aAlfa;
           TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#48; |HAZ Formateo; aCadena = aCadena + aAlfa;
           TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#49; |HAZ Formateo; aCadena = aCadena + aAlfa;
           aCadena = aCadena + (" " * 24);
           |XGRABA nHandle, aCadena;

           aCadena = "";
           TipoDato = "A"; Long = 15;   aAlfa = #dsm210fp#50; |HAZ Formateo; aCadena = aCadena + aAlfa;
           TipoDato = "A"; Long = 90;   aAlfa = #dsm210fp#51; |HAZ Formateo; aCadena = aCadena + aAlfa;
           aCadena = aCadena + (" " * 35);
           |PARA nCont = 52; |SI nCont [ 60; |HACIENDO nCont = nCont + 1;
                aCadena = aCadena + #dsm210fp#nCont#;
           |SIGUE;
           |XGRABA nHandle, aCadena; aCadena = "";

           aCadena = aCadena + #dsm210fp#61 + #dsm210fp#62;
           TipoDato = "A"; Long = 34; aAlfa = #dsm210fp#63; |HAZ Formateo; aCadena = aCadena + aAlfa;
           aCadena = aCadena + (" " * 16); |XGRABA nHandle, aCadena; aCadena = "";

           TipoDato = "A"; Long = 70;   aAlfa = #dsm210fp#64; |HAZ Formateo; aCadena = aAlfa;
           aCadena = aCadena + (" " * 55); |XGRABA nHandle, aCadena; aCadena = "";

           TipoDato = "A"; Long = 35;   aAlfa = #dsm210fp#65; |HAZ Formateo; aCadena = aCadena + aAlfa;
           aCadena = aCadena + (" " * 65); |XGRABA nHandle, aCadena; aCadena = "";

           TipoDato = "A"; Long = 30;   aAlfa = #dsm210fp#66; |HAZ Formateo; aCadena = aAlfa;
           TipoDato = "A"; Long = 30;   aAlfa = #rpaises@#1;  |HAZ Formateo; aCadena = aCadena + aAlfa;
           aCadena = aCadena + #dsm210fp#34;

           |SI #dsm210fp#41 = "S"; aCadena = aCadena + "X"; |SINO; aCadena = aCadena + " "; |FINSI;
           aCadena = aCadena + #dsm210fp#42;
           TipoDato = "A"; Long = 90;   aAlfa = #dsm210fp#43;  |HAZ Formateo; aCadena = aCadena + aAlfa;
           aCadena = aCadena + (" " * 35);
           |XGRABA nHandle, aCadena; aCadena = "";

           |SI #dsm210fp#44 = "    ";
               aCadena = aCadena + "ES00";
           |SINO;
               aAlfa = #dsm210fp#44; aAlfa = aAlfa % 0102;
               |SI aAlfa = "  ";
                   TipoDato = "N"; Long = 4; |HAZ Formateo; aCadena = aCadena + aAlfa;
               |SINO;
                   aCadena = aCadena + aAlfa;
                   aAlfa = #dsm210fp#44; aAlfa = aAlfa % -102;
                   TipoDato = "N"; Long = 2; |HAZ Formateo; aCadena = aCadena + aAlfa;
               |FINSI;
            |FINSI;
            TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#45; |HAZ Formateo; aCadena = aCadena + aAlfa;
            TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#46; |HAZ Formateo; aCadena = aCadena + aAlfa;
            TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#47; |HAZ Formateo; aCadena = aCadena + aAlfa;
            TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#48; |HAZ Formateo; aCadena = aCadena + aAlfa;
            TipoDato = "N"; Long = 4;   aAlfa = #dsm210fp#49; |HAZ Formateo; aCadena = aCadena + aAlfa;
            TipoDato = "A"; Long = 15;   aAlfa = #dsm210fp#50; |HAZ Formateo; aCadena = aCadena + aAlfa;
            TipoDato = "A"; Long = 90;   aAlfa = #dsm210fp#51; |HAZ Formateo; aCadena = aCadena + aAlfa;
            aCadena = aCadena + (" " * 35);
            |PARA nCont = 52; |SI nCont [ 60; |HACIENDO nCont = nCont + 1;
                  aCadena = aCadena + #dsm210fp#nCont#;
            |SIGUE;
            |XGRABA nHandle, aCadena; aCadena = "";

            aCadena = aCadena + #dsm210fp#61 + #dsm210fp#62;
            TipoDato = "A"; Long = 34; aAlfa = #dsm210fp#63; |HAZ Formateo; aCadena = aCadena + aAlfa;
            aCadena = aCadena + (" " * 16); |XGRABA nHandle, aCadena; aCadena = "";

            TipoDato = "A"; Long = 70;   aAlfa = #dsm210fp#64; |HAZ Formateo; aCadena = aAlfa;
            aCadena = aCadena + (" " * 55); |XGRABA nHandle, aCadena; aCadena = "";

            TipoDato = "A"; Long = 35;   aAlfa = #dsm210fp#65; |HAZ Formateo; aCadena = aCadena + aAlfa;
            aCadena = aCadena + (" " * 65); |XGRABA nHandle, aCadena; aCadena = "";

            TipoDato = "A"; Long = 30;   aAlfa = #dsm210fp#66; |HAZ Formateo; aCadena = aAlfa;
            TipoDato = "A"; Long = 30;   aAlfa = #rpaises@#1;  |HAZ Formateo; aCadena = aCadena + aAlfa;
            aCadena = aCadena + #dsm210fp#67;
            |XGRABA nHandle, aCadena; aCadena = "";
      |FINSI;

      |SI #dsmow311#42 = 0; aCadena = aCadena + "X"; |SINO; aCadena = aCadena + " "; |FINSI;
      aCadena = aCadena + "ES8790000001200270002107ESPBESMMXXX"; |XGRABA nHandle, aCadena;
      aCadena = " " * 72;    |XGRABA nHandle, aCadena;
      aCadena = "</T21002>" + &13 + &10;
      |XGRABA nHandle, aCadena;
|FPRC;

|PROCESO GrabaFichero210;
   |DBASE aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "tmp/"; |MKDIR aAlfa;
   aDirBase = aAlfa + Usuario + "/"; |MKDIR aDirBase;

   |SI aTitul = "";
      aAlfa = aDirBase + "*";
      |_PDIR aAlfa;
      |PARA; |SI FSalida = 0; |HACIENDO;
             |FBORRA aAlfa;
             |_SDIR aAlfa;
      |SIGUE;
   |FINSI;

   |SI aTitul = "C";
       aAlfa = #dsmow311#54;
   |SINO;
       aAlfa = #dsmow311#3;
   |FINSI;
   |QBF aAlfa;

   |SI aAlfa ! "";
      #dsm210ni#0 = #dsmow311#0;
      #dsm210ni#1 = #dsmow311#1;
      #dsm210ni#2 = aAlfa;
      |LEE 000#dsm210ni.=;
      |SI FSalida ! 0; |DDEFECTO #dsm210ni; |FINSI;
   |FINSI;

   |SI #dsmow311#4 ! 0;
      #dsminmex#0 = #dsmow311#0;
      #dsminmex#1 = #dsmow311#4;
      |LEE 000#dsminmex.=;
      |SI FSalida ! 0; |DDEFECTO #dsminmex; |FINSI;
   |SINO;
      |DDEFECTO #dsminmex;
   |FINSI;

   |ABRE #dsm210fp;
   #dsm210fp#0 = #dsmow311#0;
   #dsm210fp#1 = #dsmow311#1;
   #dsm210fp#2 = #dsmow311#3;
   #dsm210fp#3 = #dsmow311#4;
   #dsm210fp#4 = #dsmow311#2;
   |SI #dsmow311#42 ] 0;
       #dsm210fp#37 = "P";
   |SINO;
       #dsm210fp#37 = "N";
   |FINSI;
   |LEE 000#dsm210fp.=;
   |SI FSalida ! 0; |DDEFECTO #dsm210fp; |FINSI;
   |CIERRA #dsm210fp;

   |SI aTitul ! "C";
      |SI #dsm210fp#5 = "X"; |Y #dsmow310#14 = "P";
          #dsm210fp#36 = "T";
      |FINSI;

      #rpaises@#0 = #dsm210fp#34;
      |LEE 000#rpaises@.=;
      |SI FSalida ! 0; |DDEFECTO #rpaises@; |FINSI;
   |SINO;
      |SI #dsm210fp#38 = "X"; |Y #dsmow310#14 = "P";
         #dsm210fp#69 = "T";
      |FINSI;

      #rpaises@#0 = #dsm210fp#67;
      |LEE 000#rpaises@.=;
      |SI FSalida ! 0; |DDEFECTO #rpaises@; |FINSI;
   |FINSI;

   aAlfa = aDirBase + (("00000" + #dsmow311#0) % -105);
   aAlfa = aAlfa + (("00" + #dsmow311#1) % -102);
   |SI #dsmow311#55 ! 0;
       aAlfa = aAlfa + (("000" + #dsmow311#55) % -103);
   |SINO;
       aAlfa = aAlfa + (("000" + #dsmow311#4) % -103);
   |FINSI;
   aAlfa = aAlfa + (("000" + #dsmow311#2) % -103);
   aAlfa = aAlfa + (("00" + #dsmow321#1) % -102);
   aAlfa = aAlfa + aTitul + ".txt";

   enSwTrata      = 0;
   enCambiaMoneda = 1;
   |XABRE "WB", aAlfa, nHandle; aFichero = aAlfa;
   |SI FSalida = 0;
       |SI #dsmow310#12 ] 2018;
           |HAZ Pagina1_2018;
           |HAZ Pagina2_2018;
       |SINO;
           |HAZ Pagina1_2017;
           |HAZ Pagina2_2017;
       |FINSI;
       |XCIERRA nHandle;
   |FINSI;
|FPRC;


|PROCESO PasaLinHist210;
   |DDEFECTO #dsm210h3;
   #dsm210h3#0  = #dsm210hi#0;
   #dsm210h3#1  = #dsm210hi#1;
   #dsm210h3#2  = #dsm210hi#2;
   #dsm210h3#3  = #dsm210hi#3;
   #dsm210h3#4  = #dsm210hi#4;
   |PARA nCont = 5; |SI nCont [ 36; |HACIENDO nCont = nCont + 1;
      nCalc = nCont - 3;
      #dsm210h3#nCont#  = #dsm210ln#nCalc#;
   |SIGUE;
   #dsm210h3#38  = #dsm210ln#34;
   #dsm210h3#39  = #dsm210ln#35;
   #dsm210h3#40  = #dsm210ln#36;
   #dsm210h3#41  = #dsm210ln#37;
   #dsm210h3#42  = #dsm210ln#38;
   #dsm210h3#43  = #dsm210ln#39;
   |GRABA 020#dsm210h3.n;

   |BORRA 020#dsm210ln.a; |LIBERA #dsm210ln;
|FPRC;

|DEFBUCLE PasaLinHist210;
#dsm210ln#1;
;
#dsm210ca#0, #dsm210ca#1, #dsmow321#5, #dsmow321#4, "01.01.0000", #dsmow321#6;
#dsm210ca#0, #dsm210ca#1, #dsmow321#5, #dsmow321#4, "31.12.9999", #dsmow321#6;
be;
NULL, PasaLinHist210;
|FIN;

|PROCESO GrabaHistorico210;
   |SI #dsmow321#9 ! "S"; |ACABA; |FINSI;

   nCompl = 0;
   |SELECT #2#dsm210hi;
   #dsm210hi#0 = #dsm210dp#0;
   #dsm210hi#1 = #dsmow310#12;
   #dsm210hi#2 = #dsmow310#0;
   #dsm210hi#4 = #dsmow321#0;
   #dsm210hi#3 = 0;
   |LEE 000#dsm210hi.];
   |PARA; |SI FSalida = 0; |Y #dsm210hi#0 = #dsm210dp#0; |Y #dsm210hi#1 = #dsmow310#12;
            |Y #dsm210hi#2 = #dsmow310#0; |HACIENDO;
      |SI #dsm210hi#4 = #dsmow321#0;
          nCompl = #dsm210hi#3 + 1;
      |FINSI;
      |LEE 000#dsm210hi.s;
   |SIGUE;
   |SELECT #1#dsm210hi;

   #dsm210ca#0 = #dsm210dp#0;
   #dsm210ca#1 = #dsmow321#0;
   |LEE 000#dsm210ca.=;
   |SI FSalida ! 0; |ACABA; |FINSI;

   |DDEFECTO #dsm210hi;
   #dsm210hi#0 = #dsm210dp#0;
   #dsm210hi#1 = #dsmow310#12;
   #dsm210hi#2 = #dsmow310#0;
   #dsm210hi#3 = nCompl;
   #dsm210hi#4 = #dsm210ca#1;
   #dsm210hi#5 = #dsm210ca#2;
   #dsm210hi#6 = #dsm210ca#3;
   #dsm210hi#7 = #dsm210ca#4;
   #dsm210hi#8 = #dsm210ca#5;
   #dsm210hi#9 = #dsm210ca#7;
   #dsm210hi#10 = #dsmow310#5;
   #dsm210hi#11 = #dsmow310#6;
   #dsm210hi#12 = #dsmow310#1;
   #dsm210hi#13 = #dsmow310#15;
   #dsm210hi#14 = #dsmow310#2;
   #dsm210hi#15 = #dsmow310#3;
   #dsm210hi#16 = #dsmow310#4;
   #dsm210hi#17 = #dsmow310#8;
   #dsm210hi#18 = #dsmow310#9;
   #dsm210hi#19 = #dsmow310#10;
   #dsm210hi#20 = #dsmow310#11;
   #dsm210hi#21 = #dsmow310#14;
   |GRABA 020#dsm210hi.c;

   #dsm210ni#0 = #dsm210dp#0;
   #dsm210ni#1 = #dsmow321#0;
   #dsm210ni#2 = #dsmow321#5;
   |LEE 000#dsm210ni.=;
   |SI FSalida = 0;
      |DDEFECTO #dsm210h2;
      #dsm210h2#0  = #dsm210hi#0;
      #dsm210h2#1  = #dsm210hi#1;
      #dsm210h2#2  = #dsm210hi#2;
      #dsm210h2#3  = #dsm210hi#3;
      #dsm210h2#4  = #dsm210hi#4;
      #dsm210h2#5  = #dsm210ni#2;
      #dsm210h2#6  = #dsm210ni#3;
      #dsm210h2#7  = #dsm210ni#4;
      |GRABA 020#dsm210h2.n;

      |BORRA 020#dsm210ni.a; |LIBERA #dsm210ni;
   |FINSI;

   #dsm210in#0 = #dsm210dp#0;
   #dsm210in#1 = #dsmow321#0;
   #dsm210in#2 = #dsmow321#4;
   |LEE 000#dsm210in.=;
   |SI FSalida = 0;
      |DDEFECTO #dsm210h1;
      #dsm210h1#0  = #dsm210hi#0;
      #dsm210h1#1  = #dsm210hi#1;
      #dsm210h1#2  = #dsm210hi#2;
      #dsm210h1#3  = #dsm210hi#3;
      #dsm210h1#4  = #dsm210hi#4;
      #dsm210h1#5  = #dsm210in#2;
      #dsm210h1#6  = #dsm210in#3;
      #dsm210h1#7  = #dsm210in#4;
      #dsm210h1#8  = #dsm210in#5;
      #dsm210h1#9  = #dsm210in#6;
      #dsm210h1#10 = #dsm210in#7;
      #dsm210h1#11 = #dsm210in#8;
      #dsm210h1#12 = #dsm210in#9;
      #dsm210h1#13 = #dsm210in#10;
      #dsm210h1#14 = #dsm210in#11;
      |GRABA 020#dsm210h1.n;

      |BORRA 020#dsm210in.a; |LIBERA #dsm210in;
   |FINSI;

   |BUCLE PasaLinHist210;

   |ABRE #dsm210fp;
   #dsm210fp#0 = #dsm210dp#0;
   #dsm210fp#1 = #dsmow321#0;
   #dsm210fp#2 = #dsmow321#5;
   #dsm210fp#3 = #dsmow321#4;
   #dsm210fp#4 = #dsmow321#6;
   #dsm210fp#37 = #dsmow321#7;
   |LEE 000#dsm210fp.=;
   |SI FSalida = 0;
      |DDEFECTO #dsm210h4;
      #dsm210h4#0  = #dsm210hi#0;
      #dsm210h4#1  = #dsm210hi#1;
      #dsm210h4#2  = #dsm210hi#2;
      #dsm210h4#3  = #dsm210hi#3;
      #dsm210h4#4  = #dsm210hi#4;
      |PARA nCont = 4; |SI nCont [ 40; |HACIENDO nCont = nCont + 1;
         nCalc = nCont - 3;
         #dsm210h4#nCont#  = #dsm210fp#nCalc#;
      |SIGUE;
      |GRABA 020#dsm210h4.n;

      |BORRA 020#dsm210fp.a;
      |LIBERA #dsm210fp;
   |FINSI;
   |CIERRA #dsm210fp;
|FPRC;

|PROCESO Presenta210;

     eaPathLanza = eaPathAEAT;
     |HAZ TraeSoloWait;

     eaForzExplorador = "N";
     |HAZ Explorador;

     aAbre = eaPathLanza + "210" + Usuario + ".bat";
     |XABRE "WBC", aAbre, nHandlePortal;

     aAlfa = eaPathLanza + "wait ";
     |XGRABA nHandlePortal, aAlfa;

     aAlfa = eaPathExplorador + " " + &34;
     |XGRABA nHandlePortal, aAlfa;

     |SI aSwPresent = "T";

         |SI #dsmow310#12 < 2018;
             aAlfa = "https://www2.agenciatributaria.gob.es/es13/h/servurls.html?WEB=INTERNET&PRG=210&EJE=0000&URL=PIR&EXT=?";
             |XGRABA nHandlePortal, aAlfa;
         |FINSI;

         |SI #dsmow310#12 = 2018; |O #dsmow310#12 = 2019;
             aAlfa = "https://www1.agenciatributaria.gob.es/es13/h/servurls.html";
             |XGRABA nHandlePortal, aAlfa;

             aAlfa = "?WEB=INTERNET&PRG=210";
             |XGRABA nHandlePortal, aAlfa;

             aAlfa = "&EJE=0001";
             |XGRABA nHandlePortal, aAlfa;

             aAlfa = "&URL=PIR";
             |XGRABA nHandlePortal, aAlfa;
        |FINSI;

         |SI #dsmow310#12 ] 2020;
             aAlfa = "https://www1.agenciatributaria.gob.es/wlpl/OV17-M210/index.zul";
             |XGRABA nHandlePortal, aAlfa;
        |FINSI;

     |SINO;

         |SI #dsmow310#12 ] 2018;
             aAlfa = "https://www2.agenciatributaria.gob.es/wlpl/OV17-M210/index.zul";
         |SINO;
             aAlfa = "https://www2.agenciatributaria.gob.es/es13/h/servurls.html?WEB=INTERNET&PRG=210&EJE=0000&URL=BOR&EXT=?";
         |FINSI;
         |XGRABA nHandlePortal, aAlfa;
     |FINSI;
     |XCIERRA nHandlePortal;

     |RSYSTEM aAbre;

     aAlfa = eaPathExplorador > "";
     aAlfa = aAlfa - "CHROME.EXE";
     |SI FSalida ! 0;  |SLEEP 30;  |FINSI;

|FPRC;

|PROCESO Emite210;
   |HAZ PonVentEspera;
   enModelo    = 210;
   #dsm210tr#0 = #dsmow321#0;
   #dsm210tr#6 = nEj210tr;
   |LEE 000#dsm210tr.=;
   |SI FSalida ! 0; |DDEFECTO #dsm210tr; |FINSI;

   |ABRE #dsm210ni; |ABRE #dsm210in;
   |ABRE #dsminmex; |ABRE #dsm210fp;
   |ABRE #dsmow311;

   #dsmow311#0 = #dsm210dp#0;
   #dsmow311#1 = #dsmow321#0;
   #dsmow311#2 = #dsmow321#6;
   #dsmow311#3 = #dsmow321#5;
   #dsmow311#4 = #dsmow321#4;
   #dsmow311#5 = #dsmow321#7;
   #dsmow311#52 = #dsmow321#1;
   |LEE 000#dsmow311.=;
   |SI FSalida = 0;
      nDirEjer = #dsmow310#12;
      |SI #dsmow311#12 ! " ";
         |SI #dsmow311#12 = "C"; |Y #dsmow311#14 = 100;
            aTitul   = "C"; nFactor = 1; |HAZ GrabaFichero210;
         |SINO;
            aTitul   = ""; nFactor = 1; |HAZ GrabaFichero210;
         |FINSI;

         aSwPresent  = #dsmow310#14; nSwCliente = #dsm210dp#0;
         aSwPeriodo = #dsmow310#0; |QBF aSwPeriodo;
         aSwPeriodo = ("00" + aSwPeriodo) % -102;
         |SI aSwPeriodo = "00"; aSwPeriodo = "0A"; |FINSI;
         |HAZ PreguntaEmite;
         |HAZ EmiteModelo;
      |SINO;
         |SI #dsmow311#13 = 0; |Y #dsmow311#14 = 0;
            aTitul   = ""; nFactor = 1; |HAZ GrabaFichero210;

            aSwPresent  = #dsmow310#14; nSwCliente = #dsm210dp#0;
            aSwPeriodo = #dsmow310#0; |QBF aSwPeriodo;
            aSwPeriodo = ("00" + aSwPeriodo) % -102;
            |SI aSwPeriodo = "00"; aSwPeriodo = "0A"; |FINSI;
            |HAZ PreguntaEmite;
            |HAZ EmiteModelo;
         |SINO;
            |DBASE aAlfa; |QBF aAlfa;
            aAlfa = aAlfa + "tmp/"; |MKDIR aAlfa;
            aDirBase = aAlfa + Usuario + "/"; |MKDIR aDirBase;
            aAlfa = aDirBase + "*";
            |_PDIR aAlfa;
            |PARA; |SI FSalida = 0; |HACIENDO;
               |FBORRA aAlfa; |_SDIR aAlfa;
            |SIGUE;

            |SI #dsmow311#13 ! 0;
               aTitul   = "T"; nFactor = #dsmow311#13 / 100; |HAZ GrabaFichero210;
               aSwPresent  = #dsmow310#14; nSwCliente = #dsm210dp#0;
               aSwPeriodo = #dsmow310#0; |QBF aSwPeriodo;
               aSwPeriodo = ("00" + aSwPeriodo) % -102;
               |SI aSwPeriodo = "00"; aSwPeriodo = "0A"; |FINSI;
               |HAZ PreguntaEmite;
               |HAZ EmiteModelo;
            |FINSI;

            |SI #dsmow311#14 ! 0;
               aTitul   = "C"; nFactor = #dsmow311#14 / 100; |HAZ GrabaFichero210;
               aSwPresent  = #dsmow310#14; nSwCliente = #dsm210dp#0;
               aSwPeriodo = #dsmow310#0; |QBF aSwPeriodo;
               aSwPeriodo = ("00" + aSwPeriodo) % -102;
               |SI aSwPeriodo = "00"; aSwPeriodo = "0A"; |FINSI;
               |HAZ PreguntaEmite;
               |HAZ EmiteModelo;
            |FINSI;
         |FINSI;
      |FINSI;
      |SI aSwPresent = "T";
          |SI enPresentar = 0;
              aAlfa = "    Los ficheros generados estan: " + eaPathInternet + " de su PC";
              || aAlfa = "    Ficheros depositados en el directorio " + eaUnidadBase + "/AEAT/INTERNET/210/";
              |MENAV aAlfa;
              nSwMensaje = 1;
          |SINO;
              |HAZ Presenta210;
          |FINSI;
      |FINSI;
      |SI aSwPresent = "P";
          |HAZ Presenta210;
      |FINSI;
   |FINSI;
   |CIERRA #dsm210ni;
   |CIERRA #dsm210in;
   |CIERRA #dsminmex;
   |CIERRA #dsm210fp;

   |SI nSwError = 0;
      #dsmow321#9 = "S";
      |GRABA 020#dsmow321.a;
      nAlguno = 1;
   |FINSI;

   |HAZ QuitaVentEspera;
|FPRC;

|PROCESO EvtoGridSel210;
   |SI FSalida = 1; |O FSalida = 2;
      |LEE 000#dsmow321.=;
   |FINSI;
|FPRC;

|PROCESO PonVentEspera;
   |VENTANA 1410, 1690, -1, 17, ""; nVentEsp = FSalida;
   aVent1 = -1;
   aVent2 = -1;
   aVent3 = 0;
   aVent4 = nVentEsp;
   aVent5 = "MODAL";
   |ESPECIFICA "ESTADO_VENTANA", aVent;

   |CONTROL_SIMPLE 0, "LABEL,{{5}}Emitiendo, espere por favor", 1412, 1688, NULL;
   |PTEC 802; |PAUSA;
|FPRC;

|PROCESO QuitaVentEspera;
   aVent4 = nVentEsp;
   aVent5 = "MODELESS";
   |ESPECIFICA "ESTADO_VENTANA", aVent;
   |FINVENTANA nVentEsp;
|FPRC;

|PROCESO SelecExpl;
   eaForzExplorador = "S"; eaPathExplorador = "";
   |HAZ Explorador;
|FPRC;

|DEFBUCLE PasaAlHistorico210;
   #dsmow321#1;
   ;
   INICIO;
   FINAL;
   ;
   NULL, GrabaHistorico210;
|FIN;

|PROCESO BorraCabeceras;
   #dsm210ca#0 = #dsm210dp#0;
   #dsm210ca#1 = #dsmow321#0;
   |LEE 101#dsm210ca.=;
   |SI FSalida ! 0; |ACABA; |FINSI;

   #dsm210ni#0 = #dsm210dp#0;
   #dsm210ni#1 = #dsmow321#0;
   #dsm210ni#2 = "";
   |LEE 000#dsm210ni.];
   |SI FSalida ! 0; |O #dsm210ni#0 ! #dsm210dp#0; |O #dsm210ni#1 ! #dsmow321#0;
      #dsm210in#0 = #dsm210dp#0;
      #dsm210in#1 = #dsmow321#0;
      #dsm210in#2 = 0;
      |LEE 000#dsm210in.];
      |SI FSalida ! 0; |O #dsm210in#0 ! #dsm210dp#0; |O #dsm210in#1 ! #dsmow321#0;
         |BORRA 020#dsm210ca.a;
      |FINSI;
   |FINSI;
   |LIBERA #dsm210ca;
|FPRC;

|DEFBUCLE BorraCabeceras;
#dsmow321#1;
;
INICIO;
FINAL;
;
NULL, BorraCabeceras;
|FIN;

|PROCESO BotonEmite210;
   |HAZ PonVentEspera;
   nSwMensaje = 0; |HAZ Emite210;
   |HAZ QuitaVentEspera;
|FPRC;

|PROCESO EmisionIndividual;
   nAlguno = 0;

   |VENTANA 1011, 2089, -1, 17, "Emision modelo 210"; nVent0 = FSalida;
   aVent1 = -1;
   aVent2 = -1;
   aVent3 = 0;
   aVent4 = nVent0;
   aVent5 = "MODAL";
   |ESPECIFICA "ESTADO_VENTANA", aVent;

   |PINPA #0#dsmow317; nPant1 = FSalida;
   |PINDA #0#dsmow317;

   nPos1 = 1648; nPos2 = 1661;
   |CONTROL_SIMPLE nPant1, "BOTON,{{205}}&Emitir modelo", nPos1, nPos2, Emite210;
   nBotonEmi = FSalida;

   nPos1 = 1663; nPos2 = 1678;
   |CONTROL_SIMPLE nPant1, "BOTON,{{1}}Sa&Lir", nPos1, nPos2, BotonOk1;
   nBotonSalir = FSalida;

   nRango = 4 + 8 + 16 + 32;
   nPos1 = 0602; nPos2 = 1578;
   |LINEAL_SIMPLE #1#dsmow321, nRango, nPos1, nPos2, NULL, NULL, EvtoGridSel210;
   nGridSel = FSalida;
   |PULSATECLA;

   |PAUSA;

   |DESTRUYECONTROL nGridSel;
   |FIN_CONTROL_WINDOWS nBotonEmi;

   |SI nAlguno ! 0;
      |ABRE #dsm210hi; |ABRE #dsm210h1; |ABRE #dsm210h2;
      |ABRE #dsm210h3; |ABRE #dsm210h4; |ABRE #dsm210ca;
      |ABRE #dsm210ni; |ABRE #dsm210in; |ABRE #dsm210fp;
      |BUCLE PasaAlHistorico210;
      |BUCLE BorraCabeceras;
      |CIERRA #dsm210ni; |CIERRA #dsm210in; |CIERRA #dsm210fp;
      |CIERRA #dsm210h4; |CIERRA #dsm210h3; |CIERRA #dsm210ca;
      |CIERRA #dsm210h2; |CIERRA #dsm210h1; |CIERRA #dsm210hi;
   |FINSI;

   aVent4 = nVent0;
   aVent5 = "MODELESS";
   |ESPECIFICA "ESTADO_VENTANA", aVent;
   |FINVENTANA nVent0;
|FPRC;

|PROCESO MarcaTR;
   #dsmow321#11 = aMarca;
   |GRABA 020#dsmow321.a;
   |SI aMarca = "";
      nSwSel = nSwSel - 1;
   |SINO;
      nSwSel = nSwSel + 1;
   |FINSI;
|FPRC;

|DEFBUCLE MarcaTR;
#dsmow321#2;
;
#dsmow354#0, 00, 000, "               ", 000, " ", 00;
#dsmow354#0, 99, 999, "zzzzzzzzzzzzzzz", 999, "z", 99;
;
NULL, MarcaTR;
|FIN;

|PROCESO EvtoGridCont;
   |SI FSalida = 1; |O FSalida = 2;
      |LEE 000#dsmow354.c;

      |REFRESCACONTROL nGridSel;
   |FINSI;
   |SI FSalida = 4;
      |SI #dsmow354#3 = aColorSel;
         #dsmow354#3 = "";
      |SINO;
         #dsmow354#3 = aColorSel;
      |FINSI;
      |GRABA 020#dsmow354.a;

      |SALVA_FICHA #dsmow321;
      aMarca = #dsmow354#3; |QBF aMarca; |BUCLE MarcaTR;
      |REPON_FICHA #dsmow321;

      |REFRESCACONTROL nGridCont;
      |REFRESCACONTROL nGridSel;
   |FINSI;
|FPRC;

|PROCESO EvtoGridRent;
   |SI FSalida = 1; |O FSalida = 2;
      |LEE 000#dsmow321.c;
   |FINSI;
   |SI FSalida = 4;
      |SI #dsmow321#11 = aColorSel;
         #dsmow321#11 = "";
         nSwSel = nSwSel - 1;
         |GRABA 020#dsmow321.a;

         nSwCambia = 1;
         |SALVA_FICHA #dsmow321;
         |SELECT #2#dsmow321;
         #dsmow321#10 = #dsmow354#0;
         |LEE 000#dsmow321.];
         |PARA; |SI FSalida = 0; |Y #dsmow321#10 = #dsmow354#0; |HACIENDO;
            |SI #dsmow321#11 ! "                         "; nSwCambia = 0; |SAL; |FINSI;
            |LEE 000#dsmow321.s;
         |SIGUE;

         |SI nSwCambia = 1;
            #dsmow354#3 = "";
            |GRABA 020#dsmow354.a;

            |REFRESCACONTROL nGridCont;
         |FINSI;
         |SELECT #1#dsmow321;
         |REPON_FICHA #dsmow321;
      |SINO;
         #dsmow321#11 = aColorSel;
         nSwSel = nSwSel + 1;
         |GRABA 020#dsmow321.a;

         aAlfa = #dsmow354#3; |QBF aAlfa;
         |SI aAlfa = "";
            #dsmow354#3 = aColorSel;
            |GRABA 020#dsmow354.a;

            |REFRESCACONTROL nGridCont;
         |FINSI;
      |FINSI;

      |REFRESCACONTROL nGridSel;
   |FINSI;
|FPRC;

|PROCESO InfMasivoW321;
   #dsmow321#10 = #dsmow354#0;
   #dsmow321#0  = 00;
   #dsmow321#6  = 000;
   #dsmow321#5  = "               ";
   #dsmow321#4  = 000;
   #dsmow321#7  = " ";
   #dsmow321#1  = 00;
|FPRC;

|PROCESO SupMasivoW321;
   #dsmow321#10 = #dsmow354#0;
   #dsmow321#0  = 99;
   #dsmow321#6  = 999;
   #dsmow321#5  = "zzzzzzzzzzzzzzz";
   #dsmow321#4  = 999;
   #dsmow321#7  = "z";
   #dsmow321#1  = 99;
|FPRC;

|PROCESO Emite210Masivo;
   |SI #dsmow321#11 = "                         "; |ACABA; |FINSI;

   #dsm210dp#0 = #dsmow321#10;
   |LEE 000#dsm210dp.=;
   |SI FSalida ! 0; |DDEFECTO #dsm210dp; |FINSI;

   |HAZ Emite210;

   |SI nSwError = 0;
      |ABRE #dsm210hi; |ABRE #dsm210h1; |ABRE #dsm210h2;
      |ABRE #dsm210h3; |ABRE #dsm210h4; |ABRE #dsm210ca;
      |ABRE #dsm210ni; |ABRE #dsm210in; |ABRE #dsm210fp;
      |HAZ GrabaHistorico210;
      |HAZ BorraCabeceras;
      |CIERRA #dsm210ni; |CIERRA #dsm210in; |CIERRA #dsm210fp;
      |CIERRA #dsm210h4; |CIERRA #dsm210h3; |CIERRA #dsm210ca;
      |CIERRA #dsm210h2; |CIERRA #dsm210h1; |CIERRA #dsm210hi;
   |FINSI;
|FPRC;

|DEFBUCLE Emite210Masivo;
#dsmow321#1;
;
INICIO;
FINAL;
;
NULL, Emite210Masivo;
|FIN;

|PROCESO Contr;
   #dsmow354#3 = aMarca;
   |GRABA 020#dsmow354.a;

   |BUCLE MarcaTR;
|FPRC;

|DEFBUCLE Contr;
#dsmow354#1;
;
INICIO;
FINAL;
;
NULL, Contr;
|FIN;

|PROCESO BotonMarca;
   nSwSel = 0;
   aMarca = aColorSel; |BUCLE Contr;

   |REFRESCACONTROL nGridSel; |REFRESCACONTROL nGridCont;
|FPRC;

|PROCESO BotonDesmarca;
   aMarca = ""; |BUCLE Contr;
   nSwSel = 0;

   |REFRESCACONTROL nGridSel; |REFRESCACONTROL nGridCont;
|FPRC;

|PROCESO EmisionMasiva;
   |VENTANA 0702, 2397, -1, 17, "Emision masiva modelo 210"; nVent0 = FSalida;
   aVent1 = -1;
   aVent2 = -1;
   aVent3 = 0;
   aVent4 = nVent0;
   aVent5 = "MODAL";
   |ESPECIFICA "ESTADO_VENTANA", aVent;

   |PINPA #0#dsmow317; nPant1 = FSalida;
   |PINDA #0#dsmow317;

   nPos1 = 0502; nPos2 = 0596;
   |CONTROL_SIMPLE nPant1, "LABEL,{{6}}Doble click para seleccionar", nPos1, nPos2, NULL;
   nLabel1 = FSalida;

   nPos1 = 2283; nPos2 = 2296;
   |CONTROL_SIMPLE nPant1, "BOTON,{{1}}Sa&Lir", nPos1, nPos2, BotonOk1;
   nBotonSalir = FSalida;

   nPos1 = 2202; nPos2 = 2217;
   |CONTROL_SIMPLE nPant1, "BOTON,{{197}}&Marcar Todos", nPos1, nPos2, BotonMarca;
   nBotonMarca = FSalida;

   nPos1 = 2219; nPos2 = 2234;
   |CONTROL_SIMPLE nPant1, "BOTON,{{197}}&Desmarcar Todos", nPos1, nPos2, BotonDesmarca;
   nBotonDesmarca = FSalida;

   nRango = 4 + 8 + 16 + 32;
   nPos1 = 0602; nPos2 = 1296;
   |LINEAL_SIMPLE #1#dsmow354, nRango, nPos1, nPos2, NULL, NULL, EvtoGridCont;
   nGridCont = FSalida;

   nPos1 = 1402; nPos2 = 2096;
   |LINEAL_SIMPLE #2#dsmow321, nRango, nPos1, nPos2, InfMasivoW321, SupMasivoW321, EvtoGridRent;
   nGridSel = FSalida;
   |PULSATECLA;

   aEsc1  = &255 + "806";
   aEsc2  = &255 + "807";
   aEsc3  = &255 + "801";
   aRetu  = &255 + "802";
   |PARA; |SI;  |HACIENDO;
      FSalida = "::{{001}}Salir," + nGridSel;
      |LEETECLA aTecla;
      |SI aTecla = aEsc1; |SAL; |FINSI;
      |SI aTecla = aEsc2; |SAL; |FINSI;
      |SI aTecla = aEsc3; |SAL; |FINSI;
      |SI aTecla = aRetu; |SAL; |FINSI;
   |SIGUE;

   |SI nSwSel > 0;
      aAlfa = "    " + &191 + " Emitir declaraciones seleccionadas ?";
      |CONFI aAlfa;
      |SI FSalida = 0;
         nSwMensaje = 0;
         |HAZ PonVentEspera;
         |BUCLE Emite210Masivo;
         |HAZ QuitaVentEspera;
      |FINSI;
   |FINSI;

   |ABRE #dsm210hi; |ABRE #dsm210h1; |ABRE #dsm210h2;
   |ABRE #dsm210h3; |ABRE #dsm210h4; |ABRE #dsm210ca;
   |ABRE #dsm210ni; |ABRE #dsm210in; |ABRE #dsm210fp;
   |BUCLE PasaAlHistorico210;
   |BUCLE BorraCabeceras;
   |CIERRA #dsm210ni; |CIERRA #dsm210in; |CIERRA #dsm210fp;
   |CIERRA #dsm210h4; |CIERRA #dsm210h3; |CIERRA #dsm210ca;
   |CIERRA #dsm210h2; |CIERRA #dsm210h1; |CIERRA #dsm210hi;

   |DESTRUYECONTROL nGridCont; |DESTRUYECONTROL nGridSel;

   |FIN_CONTROL_WINDOWS nBotonSalir; |FIN_CONTROL_WINDOWS nLabel1;
   |FIN_CONTROL_WINDOWS nBotonMarca; |FIN_CONTROL_WINDOWS nBotonDesmarca;

   aVent4 = nVent0;
   aVent5 = "MODELESS";
   |ESPECIFICA "ESTADO_VENTANA", aVent;
   |FINVENTANA nVent0;
|FPRC;

|PROCESO BorroCarpeta;

   aAlfa5 = nDirEjer; |QBF aAlfa5; aAlfa5 = (("00000" + aAlfa5) % -104);
   eaPathAEAT     = eaUnidadBase   + "/AEAT";
   eaPathAEAT     = eaPathAEAT     + "/" + nSwModelo;  |RMKDIR eaPathAEAT;
   eaPathAEAT     = eaPathAEAT     + "/" + aAlfa5;     |RMKDIR eaPathAEAT;
   |SI aSwPeriodo ! "";
       eaPathAEAT     = eaPathAEAT     + "/" + aSwPeriodo; |RMKDIR eaPathAEAT;
   |FINSI;
   eaPathAEAT     = eaPathAEAT + "/";

    aAlfa = eaPathAEAT + "*.txt";
    |R_PDIR aAlfa;
    |PARA;  |SI FSalida = 0;  |HACIENDO;
         |RFBORRA aAlfa;

         |R_SDIR aAlfa;
    |SIGUE;
|FPRC;

|PROCESO Emision210;
   Cmp = 3;
   nSwModelo = 210;
   aAlfa = "tr" + Usuario; |NOME_DAT #dsmow311#aAlfa#;
   |DELINDEX #dsmow311;
   |ABRE #dsmow311;
   |ABRE #dsmow310;

   aAlfa = ""; |IP_REMOTO aAlfa;
   #dsmow310#13 = aAlfa;
   |LEE 000#dsmow310.=;
   |SI FSalida ! 0;
      |DDEFECTO #dsmow310;
      #dsmow310#13 = aAlfa;
      |GRABA 020#dsmow310.c;
   |FINSI;

   |VENTANA 0910, 2489, -1, 17, "Emision modelo 210"; nVent0 = FSalida;
   aVent1 = -1;
   aVent2 = -1;
   aVent3 = 0;
   aVent4 = nVent0;
   aVent5 = "MODAL";

   |ESPECIFICA "ESTADO_VENTANA", aVent;

   #dsmow310#4 = "S";

   |PINPA #0#dsmow310; nPant1 = FSalida; enPant = nPant1;
   |PINDA #0#dsmow310;

   nPos1 = 1146; nPos2 = 1161;
   |CONTROL_SIMPLE nPant1, "BOTON,{{197}}&Explorador", nPos1, nPos2, SelecExpl;
   nBotonExpl = FSalida;

   nPos1 = 1446; nPos2 = 1461;
   |CONTROL_SIMPLE nPant1, "BOTON,{{197}}&Seleccion", nPos1, nPos2, SelecContr;
   nBotonSelec = FSalida;
   |HAZ IndivMasiv;

   fDFecha = ~; aAlfa = fDFecha; |QBF aAlfa;
   aAlfa = aAlfa % -104; #dsmow310#7 = aAlfa;
   |SI #dsmow310#12 = 0;
       #dsmow310#12 = #dsmow310#7;
       |PINTA #dsmow310#12;
   |FINSI;

   |ENDATOS #1#dsmow310;
   |SI FSalida = 0;
      |FIN_CONTROL_WINDOWS nBotonExpl;

      aSwPeriodo = #dsmow310#0; |QBF aSwPeriodo;
      aSwPeriodo = ("00" + aSwPeriodo) % -102;
      |SI aSwPeriodo = "00"; aSwPeriodo = "0A"; |FINSI;
      nDirEjer = #dsmow310#12;
      |HAZ BorroCarpeta;

      aVent4 = nVent0;
      aVent5 = "MODELESS";
      |ESPECIFICA "ESTADO_VENTANA", aVent;

      |FINVENTANA nVent0;

      |GRABA 020#dsmow310.a;

      aAlfa = "t2" + Usuario; |NOME_DAT #dsmow321#aAlfa#;
      |DELINDEX #dsmow321; |ABRE #dsmow321;

      |SI #dsmow310#5 = "S";
         aAlfa1 = "01.01." + #dsmow310#12; aAlfa2 = "31.12." + #dsmow310#12;
         |SI #dsmow310#0 = 1; aAlfa1 = "01.01." + #dsmow310#12; aAlfa2 = "31.03." + #dsmow310#12; |FINSI;
         |SI #dsmow310#0 = 2; aAlfa1 = "01.04." + #dsmow310#12; aAlfa2 = "30.06." + #dsmow310#12; |FINSI;
         |SI #dsmow310#0 = 3; aAlfa1 = "01.07." + #dsmow310#12; aAlfa2 = "30.09." + #dsmow310#12; |FINSI;
         |SI #dsmow310#0 = 4; aAlfa1 = "01.10." + #dsmow310#12; aAlfa2 = "31.12." + #dsmow310#12; |FINSI;
         fDFecha = aAlfa1; fHFecha = aAlfa2;
      |SINO;
         fDFecha = #dsmow310#1; fHFecha = #dsmow310#15;
      |FINSI;

      |SI #dsmow310#16 = "I";
          |BUCLE EmiteTR;
          |HAZ EmisionIndividual;
      |SINO;
          |SALVA_FICHA #dsm210dp;
          nSwSel = 0;
          aAlfa = "tt" + Usuario; |NOME_DAT #dsmow354#aAlfa#;
          |DELINDEX #dsmow354; |ABRE #dsmow354;
          |HAZ EmiteTRMasivo;
          |HAZ EmisionMasiva;
          |CIERRA #dsmow354; |DELINDEX #dsmow354;
          |REPON_FICHA #dsm210dp;
      |FINSI;
   |SINO;
      aVent4 = nVent0;
      aVent5 = "MODELESS";
      |ESPECIFICA "ESTADO_VENTANA", aVent;

      |FINVENTANA nVent0;
   |FINSI;

   |CIERRA #dsmow310;
   |CIERRA #dsmow311;
   |DELINDEX #dsmow311;
|FPRC;

/***************************************************************************
*********                 FIN EMISION MODELO 210                   *********
***************************************************************************/

/***************************************************************************
*********                   EMISION MODELO 211                     *********
****************************************************************************/

|PROCESO GrabaFichero211;

   |DBASE aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "tmp/"; |MKDIR aAlfa;
   aDirBase = aAlfa + Usuario + "/"; |MKDIR aDirBase;

   aAlfa = aDirBase + "211" + (("00000" + #dsm211ca#0) % -105) + (("000" + #dsm211ca#1) % -103) + ".txt";
   |XABRE "WB", aAlfa, nHandle; aFichero = aAlfa;
   |SI FSalida = 0;
      aAlfa = "<T211010> I0A"; |XGRABA nHandle, aAlfa;
      aAlfa = #dsm211ca#3; |QBF aAlfa;
      aAlfa = (aAlfa % 0102) + (aAlfa % 0402) + (aAlfa % 0704); |XGRABA nHandle, aAlfa;

      #dsm211la#0 = #dsm211ca#0;
      #dsm211la#1 = #dsm211ca#1;
      #dsm211la#2 = #dsm211ca#4;
      |LEE 000#dsm211la.=;
      |SI FSalida ! 0; |DDEFECTO #dsm211la; |FINSI;

      aAlfa = #dsm211ca#4;
      aAlfa = aAlfa - ".";
      |PARA; |SI FSalida ! 0; |HACIENDO; aAlfa = aAlfa - "."; |SIGUE;
      aAlfa = aAlfa - "-";
      |PARA; |SI FSalida ! 0; |HACIENDO; aAlfa = aAlfa - "-"; |SIGUE;

      aCadena = ""; LongDec = 0;
      TipoDato = "A"; Long = 9;                        |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 90; aAlfa = #dsm211ca#5;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 35);
      aCadena = aCadena + #dsm211ca#6;
      TipoDato = "N"; Long = 3;  aAlfa = #dsm211ca#54; |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 15; aAlfa = #dsm211la#5;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 5;  aAlfa = #dsm211la#8;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      TipoDato = "A"; Long = 50;  aAlfa = #dsm211la#9;   |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 3;   aAlfa = #dsm211la#10;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 5;   aAlfa = #dsm211la#11;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + #dsm211la#12 + #dsm211la#13 + #dsm211la#14;
      aCadena = aCadena + #dsm211la#15 + #dsm211la#16 + #dsm211la#17;
      TipoDato = "A"; Long = 40;  aAlfa = #dsm211la#18;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 30);
      aCadena = aCadena + (("00" + #dsm211la#20) % -102) + (("000" + #dsm211la#21) % -103);
      TipoDato = "A"; Long = 30;  aAlfa = #dsm211la#22;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 5;   aAlfa = #dsm211la#37;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (("00" + #dsm211la#20) % -102);
      TipoDato = "N"; Long = 9;   aAlfa = #dsm211la#24;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 9;   aAlfa = #dsm211la#25;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 9;   aAlfa = #dsm211la#26;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      TipoDato = "A"; Long = 50;  aAlfa = #dsm211la#27;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 40;  aAlfa = #dsm211la#28;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 30;  aAlfa = #dsm211la#29;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 90;  aAlfa = #dsm211la#30;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 10);
      |XGRABA nHandle, aCadena; aCadena = "";

      TipoDato = "A"; Long = 10;  aAlfa = #dsm211la#31;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 30;  aAlfa = #dsm211la#32;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + #dsm211la#33;
      TipoDato = "A"; Long = 15;  aAlfa = #dsm211la#34;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 15;  aAlfa = #dsm211la#35;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 15;  aAlfa = #dsm211la#36;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      TipoDato = "A"; Long = 9;   aAlfa = #dsm211ca#23;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      |QBF aAlfa;
      |SI aAlfa ! "";
         aCadena = aCadena + #dsm211ca#24;
      |SINO;
         aCadena = aCadena + " ";
      |FINSI;
      TipoDato = "A"; Long = 90;  aAlfa = #dsm211ca#25;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 35);
      TipoDato = "A"; Long = 5;   aAlfa = #dsm211ca#26;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 50;  aAlfa = #dsm211ca#27;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 3;   aAlfa = #dsm211ca#28;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 5;   aAlfa = #dsm211ca#29;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 3;   aAlfa = #dsm211ca#30;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      aCadena = aCadena + #dsm211ca#31 + #dsm211ca#32 + #dsm211ca#33;
      aCadena = aCadena + #dsm211ca#34 + #dsm211ca#35;
      TipoDato = "A"; Long = 40;  aAlfa = #dsm211ca#36;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 30);
      TipoDato = "N"; Long = 5;   aAlfa = #dsm211ca#38;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 30;  aAlfa = #dsm211ca#39;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 5;   aAlfa = #dsm211ca#68;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (("00" + #dsm211ca#40) % -102);
      TipoDato = "N"; Long = 9;   aAlfa = #dsm211ca#41;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 9;   aAlfa = #dsm211ca#42;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 9;   aAlfa = #dsm211ca#43;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      #dsm211tr#0 = #dsm211ca#0;
      #dsm211tr#1 = #dsm211ca#1;
      #dsm211tr#2 = #dsm211ca#57;
      |LEE 000#dsm211tr.=;
      |SI FSalida ! 0; |DDEFECTO #dsm211tr; |FINSI;

      TipoDato = "A"; Long = 9;  aAlfa = #dsm211ca#57;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + #dsm211ca#59;
      TipoDato = "A"; Long = 90; aAlfa = #dsm211ca#58;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 35);
      TipoDato = "N"; Long = 3;  aAlfa = #dsm211ca#55;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 15; aAlfa = #dsm211tr#5;   |HAZ Formateo; aCadena = aCadena + aAlfa;

      |SI #dsm211tr#8 > "01.01.0000";
          aAlfa = #dsm211tr#8; |QBF aAlfa;
          aAlfa = (aAlfa % 0102) + (aAlfa % 0402) + (aAlfa % 0704);
      |SINO;
          aAlfa = "00000000";
      |FINSI;
      aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena;

      aCadena = "";
      TipoDato = "A"; Long = 30; aAlfa = #dsm211tr#9;   |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + #dsm211tr#10 + #dsm211tr#11;
      TipoDato = "A"; Long = 50; aAlfa = #dsm211tr#12;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 40; aAlfa = #dsm211tr#13;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 30; aAlfa = #dsm211tr#14;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + #dsm211tr#15;
      TipoDato = "A"; Long = 30; aAlfa = #dsm211tr#16;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + #dsm211tr#17;
      |XGRABA nHandle, aCadena; aCadena = "";

      TipoDato = "A"; Long = 5;  aAlfa = #dsm211ca#8;   |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 50; aAlfa = #dsm211ca#9;   |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 3;  aAlfa = #dsm211ca#10;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 5;  aAlfa = #dsm211ca#11;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 3;  aAlfa = #dsm211ca#12;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + #dsm211ca#13 + #dsm211ca#14 + #dsm211ca#15;
      aCadena = aCadena + #dsm211ca#16 + #dsm211ca#17;
      TipoDato = "A"; Long = 40; aAlfa = #dsm211ca#18;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 30);
      aCadena = aCadena + (("00" + #dsm211ca#20) % -102) + (("000" + #dsm211ca#21) % -103);
      TipoDato = "A"; Long = 30; aAlfa = #dsm211ca#22;   |HAZ Formateo; aCadena = aCadena + aAlfa;
      || aCadena = aCadena + (("00" + #dsm211ca#20) % -102) + (("000" + #dsm211ca#21) % -103); || Codigo INE
      TipoDato = "N"; Long = 5;   aAlfa = #dsminmex#23;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (("00" + #dsm211ca#20) % -102);
      |XGRABA nHandle, aCadena; aCadena = "";

      TipoDato = "A"; Long = 20; aAlfa = #dsm211ca#56;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + #dsm211ca#44;
      TipoDato = "A"; Long = 90; aAlfa = #dsm211ca#45;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + (" " * 10);
      TipoDato = "N"; Long = 5;  aAlfa = #dsm211ca#46;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      LongDec = 2;
      TipoDato = "N"; Long = 15; aAlfa = #dsm211ca#47;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 3;  aAlfa = #dsm211ca#48;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; aAlfa = #dsm211ca#49;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; aAlfa = #dsm211ca#50;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "N"; Long = 15; aAlfa = #dsm211ca#51;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      |SI #dsm211ca#52 = "S"; aAlfa = "X"; |SINO; aAlfa = " "; |FINSI;
      aCadena = aCadena + aAlfa;
      LongDec = 0;
      TipoDato = "N"; Long = 13; aAlfa = #dsm211ca#53;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aAlfa = "0";
      |SI #dsm211ca#61 = "E"; aAlfa = 1; |FINSI;
      |SI #dsm211ca#61 = "A"; aAlfa = 2; |FINSI;
      aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena; aCadena = "";

      TipoDato = "A";
      aAlfa = #dsm211ca#62; |QBF aAlfa; aAlfa = aAlfa % 0102;
      Long = 2; |HAZ Formateo; aCadena = aCadena + aAlfa;

      TipoDato = "N";
      aAlfa = #dsm211ca#62; |QBF aAlfa; aAlfa = aAlfa % 0302;
      Long = 2; |HAZ Formateo; aCadena = aCadena + aAlfa;

      Long = 4; aAlfa = #dsm211ca#63;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      Long = 4; aAlfa = #dsm211ca#64;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      Long = 4; aAlfa = #dsm211ca#65;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      Long = 4; aAlfa = #dsm211ca#66;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      Long = 4; aAlfa = #dsm211ca#67;  |HAZ Formateo; aCadena = aCadena + aAlfa;

      TipoDato = "A"; Long = 90; aAlfa = #dsmow319#1;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      aCadena = aCadena + "          ";
      TipoDato = "A"; Long = 15; aAlfa = #dsmow319#2;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 15; aAlfa = #dsmow319#3;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      TipoDato = "A"; Long = 50; aAlfa = #dsmow319#4;  |HAZ Formateo; aCadena = aCadena + aAlfa;
      |XGRABA nHandle, aCadena;

      aAlfa = " " * 200; |XGRABA nHandle, aAlfa;
      aAlfa = " " * 166; |XGRABA nHandle, aAlfa;

      aAlfa = "</T211010>" + &13 + &10;
      |XGRABA nHandle, aAlfa;

      |SI #dsm211ca#54 ] 1;
         aComp = " ";
         #dsm211la#0 = #dsm211ca#0;
         #dsm211la#1 = #dsm211ca#1;
         #dsm211la#2 = "";
         |LEE 000#dsm211la.];
         |PARA; |SI FSalida = 0; |Y #dsm211la#0 = #dsm211ca#0; |Y #dsm211la#1 = #dsm211ca#1; |HACIENDO;
            aAlfa = "<T211020>" + aComp; |XGRABA nHandle, aAlfa; aComp = "C";
            FSalida = 0;
            |PARA nCont = 1; |SI nCont [ 3; |HACIENDO nCont = nCont + 1;
               |SI FSalida ! 0; |O #dsm211la#0 ! #dsm211ca#0; |O #dsm211la#1 ! #dsm211ca#1;
                  |DDEFECTO #dsm211la;
               |FINSI;
               aAlfa = #dsm211la#2;
               aAlfa = aAlfa - ".";
               |PARA; |SI FSalida ! 0; |HACIENDO; aAlfa = aAlfa - "."; |SIGUE;
               aAlfa = aAlfa - "-";
               |PARA; |SI FSalida ! 0; |HACIENDO; aAlfa = aAlfa - "-"; |SIGUE;
               TipoDato = "A"; Long = 9; LongDec = 0;
               |HAZ Formateo; aCadena = aAlfa; || Nif
               aCadena = aCadena + #dsm211la#4;
               Long = 90; aAlfa = #dsm211la#3;  |HAZ Formateo; aCadena = aCadena + aAlfa;
               aCadena = aCadena + (" " * 35);
               Long = 15; aAlfa = #dsm211la#5;  |HAZ Formateo; aCadena = aCadena + aAlfa;
               aCadena = aCadena + #dsm211la#6;
               TipoDato = "N"; LongDec = 2;
               Long = 3;  aAlfa = #dsm211la#7;  |HAZ Formateo; aCadena = aCadena + aAlfa;
               TipoDato = "A"; LongDec = 0;
               Long = 5;  aAlfa = #dsm211la#8;  |HAZ Formateo; aCadena = aCadena + aAlfa;
               |XGRABA nHandle, aCadena; aCadena = "";
               Long = 50; aAlfa = #dsm211la#9;  |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 3;  aAlfa = #dsm211la#10; |HAZ Formateo; aCadena = aCadena + aAlfa;
               TipoDato = "N";
               Long = 5;  aAlfa = #dsm211la#11; |HAZ Formateo; aCadena = aCadena + aAlfa;
               TipoDato = "A";
               Long = 3;  aAlfa = #dsm211la#12; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 3;  aAlfa = #dsm211la#13; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 3;  aAlfa = #dsm211la#14; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 3;  aAlfa = #dsm211la#15; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 3;  aAlfa = #dsm211la#16; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 3;  aAlfa = #dsm211la#17; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 40; aAlfa = #dsm211la#18; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 30; aAlfa = #dsm211la#19; |HAZ Formateo; aCadena = aCadena + aAlfa;
               aCadena = aCadena + (("00" + #dsm211la#20) % -102) + (("000" + #dsm211la#21) % -103);
               |XGRABA nHandle, aCadena; aCadena = "";

               Long = 30; aAlfa = #dsm211la#22; |HAZ Formateo; aCadena = aCadena + aAlfa;
               TipoDato = "N"; Long = 5;  aAlfa = #dsm211la#37; |HAZ Formateo; aCadena = aCadena + aAlfa;
               aCadena = aCadena + (("00" + #dsm211la#20) % -102);
               Long = 9;  aAlfa = #dsm211la#24; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 9;  aAlfa = #dsm211la#25; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 9;  aAlfa = #dsm211la#26; |HAZ Formateo; aCadena = aCadena + aAlfa;
               TipoDato = "A";
               Long = 50; aAlfa = #dsm211la#27; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 40; aAlfa = #dsm211la#28; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 30; aAlfa = #dsm211la#29; |HAZ Formateo; aCadena = aCadena + aAlfa;
               |XGRABA nHandle, aCadena; aCadena = "";

               Long = 90; aAlfa = #dsm211la#30; |HAZ Formateo; aCadena = aCadena + aAlfa;
               aCadena = aCadena + (" " * 10);
               Long = 10; aAlfa = #dsm211la#31; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 30; aAlfa = #dsm211la#32; |HAZ Formateo; aCadena = aCadena + aAlfa;
               aCadena = aCadena + #dsm211la#33;
               Long = 15; aAlfa = #dsm211la#34; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 15; aAlfa = #dsm211la#35; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 15; aAlfa = #dsm211la#36; |HAZ Formateo; aCadena = aCadena + aAlfa;
               |XGRABA nHandle, aCadena; aCadena = "";

               |LEE 000#dsm211la.s;
               FEstado = FSalida;
            |SIGUE;
            aCadena = " " * 131; |XGRABA nHandle, aCadena; aCadena = "";
            aAlfa = "</T211020>" + &13 + &10;
            |XGRABA nHandle, aAlfa;
            FSalida = FEstado;
         |SIGUE;
      |FINSI;

      |SI #dsm211ca#55 ] 1;
         aComp = " ";
         #dsm211tr#0 = #dsm211ca#0;
         #dsm211tr#1 = #dsm211ca#1;
         #dsm211tr#2 = "";
         |LEE 000#dsm211tr.];
         |PARA; |SI FSalida = 0; |Y #dsm211tr#0 = #dsm211ca#0; |Y #dsm211tr#1 = #dsm211ca#1; |HACIENDO;
            aAlfa = "<T211030>" + aComp; |XGRABA nHandle, aAlfa; aComp = "C";
            FSalida = 0;
            |PARA nCont = 1; |SI nCont [ 5; |HACIENDO nCont = nCont + 1;
               |SI FSalida ! 0; |O #dsm211tr#0 ! #dsm211ca#0; |O #dsm211tr#1 ! #dsm211ca#1;
                  |DDEFECTO #dsm211tr;
               |FINSI;
               aAlfa = #dsm211tr#2;
               aAlfa = aAlfa - ".";
               |PARA; |SI FSalida ! 0; |HACIENDO; aAlfa = aAlfa - "."; |SIGUE;
               aAlfa = aAlfa - "-";
               |PARA; |SI FSalida ! 0; |HACIENDO; aAlfa = aAlfa - "-"; |SIGUE;
               TipoDato = "A"; Long = 9; LongDec = 0;
               |HAZ Formateo; aCadena = aAlfa; || Nif
               |QBF aAlfa;
               |SI aAlfa ! "";
                  aCadena = aCadena + #dsm211tr#4;
               |SINO;
                  aCadena = aCadena + " ";
               |FINSI;
               Long = 90; aAlfa = #dsm211tr#3;  |HAZ Formateo; aCadena = aCadena + aAlfa;
               aCadena = aCadena + (" " * 35) + #dsm211tr#6;
               TipoDato = "N"; LongDec = 2;
               Long = 3;  aAlfa = #dsm211tr#7;  |HAZ Formateo; aCadena = aCadena + aAlfa;
               TipoDato = "A"; LongDec = 0;

               Long = 15; aAlfa = #dsm211tr#5;  |HAZ Formateo; aCadena = aCadena + aAlfa;

               aAlfa = "00000000";
               |SI #dsm211tr#8 > "01.01.0000";
                   aAlfa = #dsm211tr#8; |QBF aAlfa;
                   aAlfa = (aAlfa % 0102) + (aAlfa % 0402) + (aAlfa % 0704);
               |FINSI;
               aCadena = aCadena + aAlfa;
               |XGRABA nHandle, aCadena;
               aCadena = "";

               Long = 30; aAlfa = #dsm211tr#9;  |HAZ Formateo; aCadena = aCadena + aAlfa;
               aCadena = aCadena + #dsm211tr#10 + #dsm211tr#11;
               Long = 50; aAlfa = #dsm211tr#12; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 40; aAlfa = #dsm211tr#13; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 30; aAlfa = #dsm211tr#14; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 10; aAlfa = #dsm211tr#15; |HAZ Formateo; aCadena = aCadena + aAlfa;
               Long = 30; aAlfa = #dsm211tr#16; |HAZ Formateo; aCadena = aCadena + aAlfa;
               aCadena = aCadena + #dsm211tr#17;
               |XGRABA nHandle, aCadena; aCadena = "";

               |LEE 000#dsm211tr.s;
               FEstado = FSalida;
            |SIGUE;
            aCadena = " " * 180; |XGRABA nHandle, aCadena; aCadena = "";
            aAlfa = "</T211030>" + &13 + &10;
            |XGRABA nHandle, aAlfa;
            FSalida = FEstado;
         |SIGUE;
      |FINSI;
      |XCIERRA nHandle;
   |FINSI;
|FPRC;

|PROCESO PasaTrmHist211;
   |DDEFECTO #dsm211h2;
   #dsm211h2#0  = #dsm211hi#0;
   #dsm211h2#1  = #dsm211hi#1;
   #dsm211h2#2  = #dsm211hi#2;
   #dsm211h2#3  = #dsm211hi#3;
   |PARA nContCmp = 2; |SI nContCmp [ 17; |HACIENDO nContCmp = nContCmp + 1;
      nCalcCmp = nContCmp + 2;
      #dsm211h2#nCalcCmp#  = #dsm211tr#nContCmp#;
   |SIGUE;
   |GRABA 020#dsm211h2.n;

   |BORRA 020#dsm211tr.a; |LIBERA #dsm211tr;
|FPRC;

|DEFBUCLE PasaTrmHist211;
#dsm211tr#1;
;
#dsm211ca#0, #dsm211ca#1, "               ";
#dsm211ca#0, #dsm211ca#1, "zzzzzzzzzzzzzzz";
be;
NULL, PasaTrmHist211;
|FIN;

|PROCESO PasaAdqHist211;
   |DDEFECTO #dsm211h1;
   #dsm211h1#0  = #dsm211hi#0;
   #dsm211h1#1  = #dsm211hi#1;
   #dsm211h1#2  = #dsm211hi#2;
   #dsm211h1#3  = #dsm211hi#3;
   |PARA nContCmp = 2; |SI nContCmp [ 37; |HACIENDO nContCmp = nContCmp + 1;
      nCalcCmp = nContCmp + 2;
      #dsm211h1#nCalcCmp#  = #dsm211la#nContCmp#;
   |SIGUE;
   |GRABA 020#dsm211h1.n;

   |BORRA 020#dsm211la.a; |LIBERA #dsm211la;
|FPRC;

|DEFBUCLE PasaAdqHist211;
#dsm211la#1;
;
#dsm211ca#0, #dsm211ca#1, "               ";
#dsm211ca#0, #dsm211ca#1, "zzzzzzzzzzzzzzz";
be;
NULL, PasaAdqHist211;
|FIN;

|PROCESO GrabaHistorico211;
   nCompl = 0;
   |SELECT #2#dsm211hi;
   #dsm211hi#0 = #dsm210dp#0;
   #dsm211hi#1 = #dsmow319#6;
   #dsm211hi#2 = 0;
   #dsm211hi#3 = #dsmow316#0;
   |LEE 000#dsm211hi.];
   |PARA; |SI FSalida = 0; |Y #dsm211hi#0 = #dsm210dp#0; |Y #dsm211hi#1 = #dsmow319#6;
          |Y #dsm211hi#3 = #dsmow316#0; |HACIENDO;
      nCompl = #dsm211hi#2 + 1;
      |LEE 000#dsm211hi.s;
   |SIGUE;
   |SELECT #1#dsm211hi;

   #dsm211ca#0 = #dsm210dp#0;
   #dsm211ca#1 = #dsmow316#0;
   |LEE 000#dsm211ca.=;
   |SI FSalida ! 0; |ACABA; |FINSI;

   |DDEFECTO #dsm211hi;
   #dsm211hi#0 = #dsm210dp#0;
   #dsm211hi#1 = #dsmow319#6;
   #dsm211hi#2 = nCompl;
   |PARA nContCmp = 1; |SI nContCmp [ 68; |HACIENDO nContCmp = nContCmp + 1;
      nCalcCmp = nContCmp + 2;
      #dsm211hi#nCalcCmp# = #dsm211ca#nContCmp#;
   |SIGUE;
   |GRABA 020#dsm211hi.c;

   |BUCLE PasaAdqHist211;
   |BUCLE PasaTrmHist211;

   |BORRA 020#dsm211ca.a; |LIBERA #dsm211ca;
|FPRC;

|PROCESO Presenta211;

     eaPathLanza = eaPathAEAT;
     |HAZ TraeSoloWait;

     eaForzExplorador = "N";
     |HAZ Explorador;

     aAbre = eaPathLanza + "211" + Usuario + ".bat";
     |XABRE "WBC", aAbre, nHandlePortal;

     aAlfa = eaPathLanza + "wait ";
     |XGRABA nHandlePortal, aAlfa;

     aAlfa = eaPathExplorador + " " + &34;
     |XGRABA nHandlePortal, aAlfa;

     |SI #dsmow310#12 [ 2018;
         aAlfa = "https://www1.agenciatributaria.gob.es/es13/h/servurls.html";
         |XGRABA nHandlePortal, aAlfa;

         aAlfa = "?WEB=INTERNET&PRG=" + nSwModelo;
         |XGRABA nHandlePortal, aAlfa;

         aAlfa = "&EJE=0000";
         |XGRABA nHandlePortal, aAlfa;

         aAlfa = "&URL=PIR";
         |XGRABA nHandlePortal, aAlfa;
     |FINSI;

     |SI #dsmow310#12 ] 2019;
         aAlfa = "https://www1.agenciatributaria.gob.es/wlpl/OV16-M211/index.zul";
         |XGRABA nHandlePortal, aAlfa;
     |FINSI;

     |XCIERRA nHandlePortal;

     |RSYSTEM aAbre;

     aAlfa = eaPathExplorador > "";
     aAlfa = aAlfa - "CHROME.EXE";
     |SI FSalida ! 0;  |SLEEP 30;  |FINSI;

|FPRC;

|PROCESO Emite211;
   |HAZ PonVentEspera;
   enModelo    = 211;
   #dsm211ca#0 = #dsm210dp#0;
   #dsm211ca#1 = #dsmow316#0;
   |LEE 000#dsm211ca.=;
   |SI FSalida ! 0; |HAZ QuitaVentEspera; |ACABA; |FINSI;

   |ABRE #dsminmex;
   #dsminmex#0 = #dsm210dp#0;
   #dsminmex#1 = #dsmow316#0;
   |LEE 000#dsminmex.=;
   |SI FSalida ! 0; |HAZ QuitaVentEspera; |ACABA; |FINSI;
   |CIERRA #dsminmex;

   aSwPeriodo = "A0";
   nDirEjer = #dsmow319#6;
   |HAZ GrabaFichero211;

   aTitul = "";
   |HAZ PreguntaEmite;
   |HAZ EmiteModelo;

   |SI enPresentar = 1;
       |HAZ Presenta211;
   |SINO;
     ||  aAlfa = "    Ficheros depositados en el directorio " + eaUnidadBase + "/AEAT/INTERNET/211/";
       aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
       |MENAV aAlfa;
   |FINSI;

   |SI nSwError = 0;
       |ABRE #dsm211hi;
       |ABRE #dsm211h1;
       |ABRE #dsm211h2;
       |ABRE #dsm211ca;
       |HAZ GrabaHistorico211;
       |CIERRA #dsm211ca;
       |CIERRA #dsm211h2;
       |CIERRA #dsm211h1;
       |CIERRA #dsm211hi;
   |FINSI;

   |HAZ QuitaVentEspera;
|FPRC;

|PROCESO RecogeInm;
   |DDEFECTO #dsmow316;
   #dsmow316#0 = #dsm211ca#1;
   #dsmow316#1 = #dsm211ca#2;
   #dsmow316#2 = #dsm211ca#56;
   |GRABA 020#dsmow316.n;
|FPRC;

|DEFBUCLE RecogeInm;
#dsm211ca#1;
;
#dsm210dp#0, 000;
#dsm210dp#0, 999;
;
NULL, RecogeInm;
|FIN;

|PROCESO EvtoGridSel;
   |SI FSalida = 1; |O FSalida = 2;
      |LEE 000#dsmow316.=;
   |FINSI;
|FPRC;

|PROCESO Emision211;
   |ESTADO_CONTROL nIdSalir, "DISABLE";

   |ABRE #dsm211ca; |ABRE #dsm211la; |ABRE #dsm211tr;
   |ABRE #dsmow319;
   aAlfa = ""; |IP_REMOTO aAlfa;
   #dsmow319#0 = aAlfa;
   |LEE 000#dsmow319.=;
   |SI FSalida ! 0;
      |DDEFECTO #dsmow319;
      #dsmow319#0 = aAlfa;
      |GRABA 020#dsmow319.c;
   |FINSI;

   nSwModelo = 211;

   aAlfa = "11" + Usuario; |NOME_DAT #dsmow316#aAlfa#;
   |DELINDEX #dsmow316; |ABRE #dsmow316;
   |BUCLE RecogeInm;

   |VENTANA 1011, 1789, -1, 17, "Emision modelo 211"; nVent0 = FSalida;
   aVent1 = -1;
   aVent2 = -1;
   aVent3 = 0;
   aVent4 = nVent0;
   aVent5 = "MODAL";
   |ESPECIFICA "ESTADO_VENTANA", aVent;

   |PINPA #0#dsmow319; nPant1 = FSalida;
   |PINDA #0#dsmow319;

   #dsmow319#5 = "T";

   |ENDATOS #1#dsmow319;
   |SI FSalida ! 0;
      aVent4 = nVent0;
      aVent5 = "MODELESS";
      |ESPECIFICA "ESTADO_VENTANA", aVent;
      |FINVENTANA nVent0;

      |ACABA;
   |SINO;
      |GRABA 020#dsmow319.a;

      aSwPeriodo = "A0"
      nDirEjer   = #dsmow319#6;
      |HAZ BorroCarpeta;

      aVent4 = nVent0;
      aVent5 = "MODELESS";
      |ESPECIFICA "ESTADO_VENTANA", aVent;
      |FINVENTANA nVent0;
   |FINSI;

   aSwPresent  = #dsmow319#5;

   |VENTANA 1011, 2089, -1, 17, "Emision modelo 211"; nVent0 = FSalida;
   aVent1 = -1;
   aVent2 = -1;
   aVent3 = 0;
   aVent4 = nVent0;
   aVent5 = "MODAL";
   |ESPECIFICA "ESTADO_VENTANA", aVent;

   |PINPA #0#dsmow317; nPant1 = FSalida;
   |PINDA #0#dsmow317;

   nPos1 = 1648; nPos2 = 1661;
   |CONTROL_SIMPLE nPant1, "BOTON,{{205}}&Emitir modelo", nPos1, nPos2, Emite211;
   nBotonEmi = FSalida;

   nPos1 = 1663; nPos2 = 1678;
   |CONTROL_SIMPLE nPant1, "BOTON,{{1}}Sa&Lir", nPos1, nPos2, BotonOk1;
   nBotonSalir = FSalida;

   nRango = 4 + 8 + 16 + 32;
   nPos1 = 0602; nPos2 = 1578;
   |LINEAL_SIMPLE #1#dsmow316, nRango, nPos1, nPos2, NULL, NULL, EvtoGridSel;
   nGrid1 = FSalida;
   |PULSATECLA;

   |PAUSA;

   |DESTRUYECONTROL nGrid1;
   |FIN_CONTROL_WINDOWS nBotonEmi;

   aVent4 = nVent0;
   aVent5 = "MODELESS";
   |ESPECIFICA "ESTADO_VENTANA", aVent;
   |FINVENTANA nVent0;

   |CIERRA #dsmow316; |DELINDEX #dsmow316;
   |CIERRA #dsmow319;
   |CIERRA #dsm211ca; |CIERRA #dsm211la; |CIERRA #dsm211tr;

   |ESTADO_CONTROL nIdSalir, "ENABLE";
|FPRC;

/***************************************************************************
*********                 FIN EMISION MODELO 211                   *********
****************************************************************************/

/***************************************************************************
*********                   EMISION MODELO 213                     *********
****************************************************************************/

|PROCESO PasaInmHist213;
   |DDEFECTO #dsm213h2;
   #dsm213h2#0 = #dsm213hi#0;
   #dsm213h2#1 = #dsm213hi#1;
   #dsm213h2#2 = #dsm213hi#2;
   #dsm213h2#3 = #dsm213hi#3;
   #dsm213h2#4 = #dsm213hi#4;
   |PARA nCont = 5; |SI nCont [ 24; |HACIENDO nCont = nCont + 1;
      nCalc = nCont - 3;
      #dsm213h2#nCont# = #dsm213in#nCalc#;
   |SIGUE;
   |GRABA 020#dsm213h2.n;

   |BORRA 020#dsm213in.a;
|FPRC;

|DEFBUCLE PasaInmHist213;
#dsm213in#1;
;
#dsm213ca#0, #dsm213ca#1, 001;
#dsm213ca#0, #dsm213ca#1, 999;
;
NULL, PasaInmHist213;
|FIN;

|PROCESO PasaSocHist213;
   |DDEFECTO #dsm213h1;
   #dsm213h1#0 = #dsm213hi#0;
   #dsm213h1#1 = #dsm213hi#1;
   #dsm213h1#2 = #dsm213hi#2;
   #dsm213h1#3 = #dsm213hi#3;
   #dsm213h1#4 = #dsm213hi#4;
   |PARA nCont = 5; |SI nCont [ 39; |HACIENDO nCont = nCont + 1;
      nCalc = nCont - 3;
      #dsm213h1#nCont# = #dsm213so#nCalc#;
   |SIGUE;
   |GRABA 020#dsm213h1.n;

   |BORRA 020#dsm213so.a;
|FPRC;

|DEFBUCLE PasaSocHist213;
#dsm213so#1;
;
#dsm213ca#0, #dsm213ca#1, "               ";
#dsm213ca#0, #dsm213ca#1, "zzzzzzzzzzzzzzz";
;
NULL, PasaSocHist213;
|FIN;

|PROCESO GrabaHistorico213;
   nCompl = 0;
   #dsm213hi#0 = #dsm213ca#0;
   #dsm213hi#1 = #dsmow331#9;
   #dsm213hi#2 = 0;
   #dsm213hi#3 = #dsm213ca#1;
   #dsm213hi#4 = 0;
   |LEE 000#dsm213hi.];
   |PARA; |SI FSalida = 0; |HACIENDO;
      nCompl = #dsm213hi#4 + 1;
      |LEE 000#dsm213hi.s;
   |SIGUE;

   |DDEFECTO #dsm213hi;
   #dsm213hi#0 = #dsm213ca#0;
   #dsm213hi#1 = #dsmow331#9;
   #dsm213hi#2 = 0;
   #dsm213hi#3 = #dsm213ca#1;
   #dsm213hi#4 = nCompl;
   |PARA nCont = 5; |SI nCont [ 22; |HACIENDO nCont = nCont + 1;
      nCalc = nCont - 3;
      #dsm213hi#nCont# = #dsm213ca#nCalc#;
   |SIGUE;
   #dsm213hi#23 = #dsmow331#8;
   #dsm213hi#24 = #dsmow331#7;
   #dsm213hi#25 = #dsm213ca#20;
   #dsm213hi#26 = #dsm213ca#21;
   #dsm213hi#27 = #dsmow331#8;
   #dsm213hi#28 = #dsmow331#5;
   |GRABA 020#dsm213hi.c;

   |BUCLE PasaSocHist213;
   |BUCLE PasaInmHist213;

   |BORRA 020#dsm213ca.a;
|FPRC;

|PROCESO Pagina1;
   aAlfa = "<T21301> "; |XGRABA nHandle, aAlfa;
   aAlfa = #dsmow332#3; |XGRABA nHandle, aAlfa;
   TipoDato = "A"; LongDec = 0;
   aAlfa = #dsm210dp#2; |QBF aAlfa;
   FSalida = 1; |PARA; |SI FSalida ! 0; |HACIENDO; aAlfa = aAlfa - "."; |SIGUE;
   FSalida = 1; |PARA; |SI FSalida ! 0; |HACIENDO; aAlfa = aAlfa - "-"; |SIGUE;
   TipoDato = "A";
   Long = 9;                        |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 90; aAlfa = #dsm210dp#1;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 35; aAlfa = "";           |HAZ Formateo; |XGRABA nHandle, aAlfa;
   TipoDato = "N";
   Long = 4;  aAlfa = #dsmow331#9;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
   aAlfa = "0A";                    |XGRABA nHandle, aAlfa;
   TipoDato = "A";
   Long = 15; aAlfa = #dsm210dp#61; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 2;  aAlfa = #dsm210dp#33; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 20; aAlfa = #dsm210dp#62; |HAZ Formateo; |XGRABA nHandle, aAlfa;

   aAlfa = #dsm210dp#8; |QBF aAlfa; |SI aAlfa ! ""; aAlfa = aAlfa + " "; |FINSI;
   aAlfa1 = #dsm210dp#9;  |QBF aAlfa1; |SI aAlfa1 ! ""; aAlfa = aAlfa + ", " + aAlfa1; |FINSI;
   aAlfa1 = #dsm210dp#11; |QBF aAlfa1; |SI aAlfa1 ! ""; aAlfa = aAlfa + ", " + aAlfa1; |FINSI;
   aAlfa1 = #dsm210dp#15; |QBF aAlfa1; |SI aAlfa1 ! ""; aAlfa = aAlfa + ", " + aAlfa1; |FINSI;
   aAlfa1 = #dsm210dp#16; |QBF aAlfa1; |SI aAlfa1 ! ""; aAlfa = aAlfa + ", " + aAlfa1; |FINSI;
   aAlfa = aAlfa + #dsm210dp#17; |QBF aAlfa;
   Long = 50;                        |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 40;  aAlfa = #dsm210dp#18; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 30;  aAlfa = #dsm210dp#19; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 90;  aAlfa = #dsm210dp#30; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 10;  aAlfa = "";           |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 10;  aAlfa = #dsm210dp#31; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 30;  aAlfa = #dsm210dp#32; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 2;   aAlfa = #dsm210dp#33; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 15;  aAlfa = #dsm210dp#34; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 15;  aAlfa = #dsm210dp#35; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 15;  aAlfa = #dsm210dp#36; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   aAlfa = #dsm210dp#37; |QBF aAlfa;
   FSalida = 1; |PARA; |SI FSalida ! 0; |HACIENDO; aAlfa = aAlfa - "."; |SIGUE;
   FSalida = 1; |PARA; |SI FSalida ! 0; |HACIENDO; aAlfa = aAlfa - "-"; |SIGUE;
   Long = 9;                         |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 1;  aAlfa = #dsm210dp#38;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 90; aAlfa = #dsm210dp#39;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 35; aAlfa = "";            |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 1;  aAlfa = "X";           |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 5;  aAlfa = #dsm210dp#41;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 50; aAlfa = #dsm210dp#42;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 3;  aAlfa = #dsm210dp#43;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
   TipoDato = "N";
   Long = 5;  aAlfa = #dsm210dp#44;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
   TipoDato = "A";
   Long = 3;  aAlfa = #dsm210dp#45; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 3;  aAlfa = #dsm210dp#46; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 3;  aAlfa = #dsm210dp#47; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 3;  aAlfa = #dsm210dp#48; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 3;  aAlfa = #dsm210dp#49; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 3;  aAlfa = #dsm210dp#50; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 40; aAlfa = #dsm210dp#51; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 30; aAlfa = #dsm210dp#52; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   TipoDato = "N";
   nCalc = (#dsm210dp#53 * 1000) + #dsm210dp#54; aAlfa = nCalc;
   Long = 5;                        |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 5;  aAlfa = #dsm210dp#56; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 2;  aAlfa = #dsm210dp#53; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   TipoDato = "A";
   Long = 9;  aAlfa = #dsm210dp#58; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 9;  aAlfa = #dsm210dp#59; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 9;  aAlfa = #dsm210dp#60; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   |SI #dsm213ca#4 ! 1; |Y #dsm213ca#4 ! 2; |O #dsm213ca#4 ! 3; |Y #dsm213ca#4 ! 4;
      aAlfa = "        "; |XGRABA nHandle, aAlfa;
   |SINO;
      |SI #dsm213ca#4 = 1; aAlfa = "X       "; |XGRABA nHandle, aAlfa; |FINSI;
      |SI #dsm213ca#4 = 2; aAlfa = " X" + #dsm213ca#5 + "  "; |XGRABA nHandle, aAlfa; |FINSI;
      |SI #dsm213ca#4 = 3; aAlfa = "      X "; |XGRABA nHandle, aAlfa; |FINSI;
      |SI #dsm213ca#4 = 4; aAlfa = "       X"; |XGRABA nHandle, aAlfa; |FINSI;
   |FINSI;
   TipoDato = "N"; LongDec = 2;
   Long = 15;  aAlfa = #dsm213ca#6;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 3;   aAlfa = #dsm213ca#7;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 15;  aAlfa = #dsm213ca#8;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 3;   aAlfa = #dsm213ca#9;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 15;  aAlfa = #dsm213ca#10; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 15;  aAlfa = #dsm213ca#11; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 15;  aAlfa = #dsm213ca#12; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 15;  aAlfa = #dsm213ca#13; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   |SI #dsm213ca#14 = "E"; aAlfa = "1"; |FINSI;
   |SI #dsm213ca#14 = "A"; aAlfa = "2"; |FINSI;
   |XGRABA nHandle, aAlfa;
   TipoDato = "A";
   Long = 4;   aAlfa = #dsm213ca#15;
   |SI aAlfa = "ES  "; |O aAlfa = "    "; aAlfa = "ES00"; |FINSI;
   |HAZ Formateo; |XGRABA nHandle, aAlfa;
   TipoDato = "N"; LongDec = 0;
   Long = 4;   aAlfa = #dsm213ca#16; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 4;   aAlfa = #dsm213ca#17; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 2;   aAlfa = #dsm213ca#18; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 10;  aAlfa = #dsm213ca#19; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   TipoDato = "A";
   |SI #dsm213ca#13 [ 0; aAlfa = "X"; |SINO; aAlfa = " "; |FINSI;
   |XGRABA nHandle, aAlfa;
   |SI #dsmow331#6 = "S";
      aAlfa = "X" + #dsmow331#7;
   |SINO;
      aAlfa = " " * 14;
   |FINSI;
   |XGRABA nHandle, aAlfa; || Declaracion complementaria
   aAlfa = " " * 16; |XGRABA nHandle, aAlfa;
   Long = 70;   aAlfa = #dsmow331#1; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   aAlfa = " " * 30; |XGRABA nHandle, aAlfa;
   Long = 15;   aAlfa = #dsmow331#2; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 15;   aAlfa = #dsmow331#3; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   Long = 70;   aAlfa = #dsmow331#4; |HAZ Formateo; |XGRABA nHandle, aAlfa;
   aAlfa = " " * 30;  |XGRABA nHandle, aAlfa;
   aAlfa = " " * 13;  |XGRABA nHandle, aAlfa;
   aAlfa = " " * 152; |XGRABA nHandle, aAlfa;
   aAlfa = "</T21301>" + &13 + &10;
   |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO Pagina3;
   nContSoc = 0; aCompl = " ";

   #dsm213so#0 = #dsm213ca#0;
   #dsm213so#1 = #dsm213ca#1;
   #dsm213so#2 = "";
   |LEE 000#dsm213so.];
   |PARA; |SI FSalida = 0; |Y #dsm213so#0 = #dsm213ca#0; |Y #dsm213so#1 = #dsm213ca#1; |HACIENDO;
      nContSoc = nContSoc + 1;

      |SI nContSoc = 1;
         aAlfa = "<T21303>"; |XGRABA nHandle, aAlfa;
         aAlfa = aCompl;     |XGRABA nHandle, aAlfa;
      |FINSI;

      TipoDato = "A"; LongDec = 0;
      aAlfa = #dsm213so#2; |QBF aAlfa;
      FSalida = 1; |PARA; |SI FSalida ! 0; |HACIENDO; aAlfa = aAlfa - "."; |SIGUE;
      FSalida = 1; |PARA; |SI FSalida ! 0; |HACIENDO; aAlfa = aAlfa - "-"; |SIGUE;
      Long = 9;                         |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 50; aAlfa = #dsm213so#3;   |HAZ Formateo; |XGRABA nHandle, aAlfa;
      aAlfa = " " * 75;                                 |XGRABA nHandle, aAlfa;
      Long = 20; aAlfa = #dsm213so#32;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      TipoDato = "N"; LongDec = 2;
      Long = 3;  aAlfa = #dsm213so#5;   |HAZ Formateo; |XGRABA nHandle, aAlfa;
      TipoDato = "A"; LongDec = 0;
      Long = 15; aAlfa = #dsm213so#4;   |HAZ Formateo; |XGRABA nHandle, aAlfa;
      TipoDato = "N";

      |SI #dsm213so#33 > "01.01.0000";
          aAlfa = #dsm213so#33; |QBF aAlfa;
          aAlfa = (aAlfa % 0102) + (aAlfa % 0402) + (aAlfa % 0704);
      |SINO;
          aAlfa = "00000000";
      |FINSI;
      Long = 8;                         |HAZ Formateo; |XGRABA nHandle, aAlfa;

      TipoDato = "A";
      Long = 30; aAlfa = #dsm213so#34;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 2;  aAlfa = #dsm213so#35;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 2;  aAlfa = #dsm213so#36;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 5;  aAlfa = #dsm213so#6;   |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 50; aAlfa = #dsm213so#7;   |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 3;  aAlfa = #dsm213so#8;   |HAZ Formateo; |XGRABA nHandle, aAlfa;
      TipoDato = "N";
      Long = 5;  aAlfa = #dsm213so#9;   |HAZ Formateo; |XGRABA nHandle, aAlfa;
      TipoDato = "A";
      Long = 3;  aAlfa = #dsm213so#10;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 3;  aAlfa = #dsm213so#11;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 3;  aAlfa = #dsm213so#12;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 3;  aAlfa = #dsm213so#13;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 3;  aAlfa = #dsm213so#14;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 3;  aAlfa = #dsm213so#15;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 40; aAlfa = #dsm213so#16;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 30; aAlfa = #dsm213so#17;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      TipoDato = "N";
      nCalc = (#dsm213so#18 * 1000) + #dsm213so#19;
      Long = 5;  aAlfa = nCalc;         |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 5;  aAlfa = #dsm213so#30;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 2;  aAlfa = #dsm213so#18;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      TipoDato = "A";
      Long = 50; aAlfa = #dsm213so#22;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 40; aAlfa = #dsm213so#23;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 30; aAlfa = #dsm213so#24;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 10; aAlfa = #dsm213so#26;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 30; aAlfa = #dsm213so#27;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 2;  aAlfa = #dsm213so#28;  |HAZ Formateo; |XGRABA nHandle, aAlfa;

      |SI nContSoc = 3;
         aAlfa = " " * 59; |XGRABA nHandle, aAlfa;
         aAlfa = "</T21303>" + &13 + &10;
         |XGRABA nHandle, aAlfa;
         nContSoc = 0; aCompl = "C";
      |FINSI;
      |LEE 000#dsm213so.s;
   |SIGUE;

   |SI nContSoc < 3; |Y nContSoc ! 0;
      |PARA; |SI nContSoc < 3; |HACIENDO nContSoc = nContSoc + 1;
         TipoDato = "A"; LongDec = 0;
         Long = 90; aAlfa = ""; |HAZ Formateo; |XGRABA nHandle, aAlfa;
         Long = 64; aAlfa = ""; |HAZ Formateo; |XGRABA nHandle, aAlfa;
         TipoDato = "N";
         Long = 5;  aAlfa = 0;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
         TipoDato = "A";
         Long = 15; aAlfa = ""; |HAZ Formateo; |XGRABA nHandle, aAlfa;
         TipoDato = "N";
         Long = 8;  aAlfa = 0;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
         TipoDato = "A";
         Long = 92; aAlfa = ""; |HAZ Formateo; |XGRABA nHandle, aAlfa;
         TipoDato = "N";
         Long = 5;  aAlfa = 0;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
         TipoDato = "A";
         Long = 88; aAlfa = ""; |HAZ Formateo; |XGRABA nHandle, aAlfa;
         TipoDato = "N";
         Long = 12; aAlfa = 0;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
         TipoDato = "A";
         Long = 90; aAlfa = ""; |HAZ Formateo; |XGRABA nHandle, aAlfa;
         Long = 72; aAlfa = ""; |HAZ Formateo; |XGRABA nHandle, aAlfa;
      |SIGUE;
      aAlfa = " " * 59; |XGRABA nHandle, aAlfa;
      aAlfa = "</T21303>" + &13 + &10;
      |XGRABA nHandle, aAlfa;
   |FINSI;
|FPRC;

|PROCESO Pagina2;
   nContInm = 0; aCompl = " ";

   #dsm213in#0 = #dsm213ca#0;
   #dsm213in#1 = #dsm213ca#1;
   #dsm213in#2 = 1;
   |LEE 000#dsm213in.];
   |PARA; |SI FSalida = 0; |Y #dsm213in#0 = #dsm213ca#0; |Y #dsm213in#1 = #dsm213ca#1; |HACIENDO;
      nContInm = nContInm + 1;

      |SI nContInm = 1;
         aAlfa = "<T21302>"; |XGRABA nHandle, aAlfa;
         aAlfa = aCompl;     |XGRABA nHandle, aAlfa;
      |FINSI;

      TipoDato = "A"; LongDec = 0;
      Long = 5;  aAlfa = #dsm213in#4;   |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 50; aAlfa = #dsm213in#5;   |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 3;  aAlfa = #dsm213in#6;   |HAZ Formateo; |XGRABA nHandle, aAlfa;
      TipoDato = "N";
      Long = 5;  aAlfa = #dsm213in#7;   |HAZ Formateo; |XGRABA nHandle, aAlfa;
      TipoDato = "A";
      Long = 3;  aAlfa = #dsm213in#8;   |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 3;  aAlfa = #dsm213in#9;   |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 3;  aAlfa = #dsm213in#10;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 3;  aAlfa = #dsm213in#11;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 3;  aAlfa = #dsm213in#12;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 3;  aAlfa = #dsm213in#13;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 40; aAlfa = #dsm213in#14;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 30; aAlfa = #dsm213in#15;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      TipoDato = "N";
      Long = 5;  aAlfa = #dsm213in#16;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      Long = 5;  aAlfa = #dsm213in#21;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      aAlfa = #dsm213in#16; |QBF aAlfa;  aAlfa = (("00000" + aAlfa) % -105); aAlfa = aAlfa % 0102;
      Long = 2;                         |HAZ Formateo; |XGRABA nHandle, aAlfa;
      TipoDato = "A";
      Long = 20; aAlfa = #dsm213in#17;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      TipoDato = "N"; LongDec = 2;
      Long = 15; aAlfa = #dsm213in#18;  |HAZ Formateo; |XGRABA nHandle, aAlfa;

      |SI nContInm = 7;
         aAlfa = " " * 82; |XGRABA nHandle, aAlfa;
         aAlfa = "</T21302>" + &13 + &10;
         |XGRABA nHandle, aAlfa;
         nContInm = 0; aCompl = "C";
      |FINSI;
      |LEE 000#dsm213in.s;
   |SIGUE;

   |SI nContInm < 7; |Y nContInm ! 0;
      |PARA; |SI nContInm < 7; |HACIENDO nContInm = nContInm + 1;
         TipoDato = "A"; LongDec = 0;
         Long = 58; aAlfa = ""; |HAZ Formateo; |XGRABA nHandle, aAlfa;
         TipoDato = "N";
         Long = 5;  aAlfa = 0;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
         TipoDato = "A";
         Long = 88; aAlfa = ""; |HAZ Formateo; |XGRABA nHandle, aAlfa;
         TipoDato = "N";
         Long = 12; aAlfa = 0;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
         TipoDato = "A";
         Long = 20; aAlfa = ""; |HAZ Formateo; |XGRABA nHandle, aAlfa;
         TipoDato = "N";
         Long = 17; aAlfa = 0;  |HAZ Formateo; |XGRABA nHandle, aAlfa;
      |SIGUE;
      aAlfa = " " * 82; |XGRABA nHandle, aAlfa;
      aAlfa = "</T21302>" + &13 + &10;
      |XGRABA nHandle, aAlfa;
   |FINSI;
|FPRC;

|PROCESO GrabaFichero213;
   #dsm213ca#0 = #dsm210dp#0;
   #dsm213ca#1 = #dsmow332#0;
   |LEE 000#dsm213ca.=;
   |SI FSalida ! 0; |DDEFECTO #dsm213ca; |FINSI;

   |DBASE aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "tmp/"; |MKDIR aAlfa;
   aDirBase = aAlfa + Usuario + "/"; |MKDIR aDirBase;
   aAlfa = aDirBase + "*";
   |_PDIR aAlfa;
   |PARA; |SI FSalida = 0; |HACIENDO;
      |FBORRA aAlfa; |_SDIR aAlfa;
   |SIGUE;

   aAlfa = aDirBase + "213_" + (("00000" + #dsm210dp#0) % -105) + "_" + (("00000" + #dsmow332#0) % -102) + ".txt";
   |XABRE "WB", aAlfa, nHandle; aFichero = aAlfa;
   |SI FSalida = 0;

      |HAZ Pagina1;
      |HAZ Pagina2;
      |HAZ Pagina3;

      |XCIERRA nHandle;
   |FINSI;
|FPRC;

|PROCESO Presenta213;
     eaPathLanza = eaPathAEAT;
     |HAZ TraeSoloWait;

     eaForzExplorador = "N";
     |HAZ Explorador;

     aAbre = eaPathLanza + "213" + Usuario + ".bat";
     |XABRE "WBC", aAbre, nHandlePortal;

     aAlfa = eaPathLanza + "wait ";
     |XGRABA nHandlePortal, aAlfa;

     aAlfa = eaPathExplorador + " " + &34;
     |XGRABA nHandlePortal, aAlfa;

     |SI #dsmow310#12 [ 2018;
         aAlfa = "https://www1.agenciatributaria.gob.es/es13/h/servurls.html";
         |XGRABA nHandlePortal, aAlfa;

         aAlfa = "?WEB=INTERNET&PRG=" + nSwModelo;
         |XGRABA nHandlePortal, aAlfa;

         aAlfa = "&EJE=0000";
         |XGRABA nHandlePortal, aAlfa;

         aAlfa = "&URL=PIR";
         |XGRABA nHandlePortal, aAlfa;
     |FINSI;

     |SI #dsmow310#12 ] 2019;
         aAlfa = "https://www1.agenciatributaria.gob.es/wlpl/OV16-M213/index.zul";
         |XGRABA nHandlePortal, aAlfa;
     |FINSI;

     |XCIERRA nHandlePortal;

     |RSYSTEM aAbre;

     aAlfa = eaPathExplorador > "";
     aAlfa = aAlfa - "CHROME.EXE";
     |SI FSalida ! 0;  |SLEEP 30;  |FINSI;

|FPRC;

|PROCESO Emitir213;
   |HAZ PonVentEspera;
   enModelo    = 213;
   #dsm213ca#0 = #dsm210dp#0;
   #dsm213ca#1 = #dsmow332#0;
   |LEE 000#dsm213ca.=;
   |SI FSalida ! 0; |HAZ QuitaVentEspera; |ACABA; |FINSI;

   |HAZ GrabaFichero213;

   nDirEjer = #dsmow331#9;
   nSwModelo = 213;
   aSwPresent  = #dsmow331#5;
   nSwCliente = #dsm210dp#0;
   aSwPeriodo = "0A";

   |HAZ PreguntaEmite;
   |HAZ EmiteModelo;

   |SI enPresentar = 1;
       |HAZ Presenta213;
   |SINO;
     ||  aAlfa = "    Ficheros depositados en el directorio " + eaUnidadBase + "/AEAT/INTERNET/211/";
       aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
       |MENAV aAlfa;
   |FINSI;

   |SI nSwError = 0;
      |ABRE #dsm213hi; |ABRE #dsm213h1; |ABRE #dsm213h2;
      |HAZ GrabaHistorico213;
      |CIERRA #dsm213hi; |CIERRA #dsm213h1; |CIERRA #dsm213h2;
   |FINSI;

   |HAZ QuitaVentEspera;
|FPRC;

|PROCESO RellenaTempo;
   |DDEF aAlfa; |QBF aAlfa;
   aAlfa1 = aAlfa + "dsm210ca.mas";
   |CARGA_DEF aAlfa1, Referen@;
   |SI FSalida = 0;
      aAlfa1 = aAlfa + "dsm210in.mas";
      |CARGA_DEF aAlfa1, Refere1@;
      |SI FSalida = 0;
      |SINO;
         |DESCARGA_DEF #Referen@;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO BotonValida;
   |PTEC 801;
|FPRC;

|PROCESO RecogeAdms;
   |DDEFECTO #dsmow332;

   #dsmow332#0 = #dsm213ca#1;
   #dsmow332#1 = #dsm213ca#2;
   #dsmow332#2 = #dsm213ca#3;
   |SI #dsm213ca#13 > 0;
      #dsmow332#3 = "I";
   |SINO;
      #dsmow332#3 = "N";
   |FINSI;
   |GRABA 020#dsmow332.n;
|FPRC;

|DEFBUCLE RecogeAdms;
#dsm213ca#1;
;
#dsm210dp#0, 00000;
#dsm210dp#0, 99999;
;
NULL, RecogeAdms;
|FIN;

|PROCESO EvtoGridSel213;
   |SI FSalida = 1; |O FSalida = 2;
      |LEE 000#dsmow332.=;
   |FINSI;
|FPRC;

|PROCESO Emision213;
   |ESTADO_CONTROL nIdSalir, "DISABLE";

   |ABRE #dsm213ca; |ABRE #dsm213in; |ABRE #dsm213so;
   |ABRE #dsmow331;
   aAlfa = ""; |IP_REMOTO aAlfa;
   #dsmow331#0 = aAlfa;
   |LEE 000#dsmow331.=;
   |SI FSalida ! 0;
      |DDEFECTO #dsmow331;
      #dsmow331#0 = aAlfa;
      |GRABA 020#dsmow331.c;
   |FINSI;

   nSwModelo = 213;

   aAlfa = "13" + Usuario; |NOME_DAT #dsmow332#aAlfa#;
   |DELINDEX #dsmow332; |ABRE #dsmow332;
   |BUCLE RecogeAdms;

   |VENTANA 1011, 1889, -1, 17, "Emision modelo 213"; nVent0 = FSalida;
   aVent1 = -1;
   aVent2 = -1;
   aVent3 = 0;
   aVent4 = nVent0;
   aVent5 = "MODAL";
   |ESPECIFICA "ESTADO_VENTANA", aVent;

   #dsmow331#5 = "T";

   |PINPA #0#dsmow331; nPant1 = FSalida;
   |PINDA #0#dsmow331;

   |ENDATOS #1#dsmow331;
   |SI FSalida ! 0;
      aVent4 = nVent0;
      aVent5 = "MODELESS";
      |ESPECIFICA "ESTADO_VENTANA", aVent;
      |FINVENTANA nVent0;

      |ACABA;
   |SINO;
      |GRABA 020#dsmow331.a;

      nDirEjer   = #dsmow331#9;
      nSwModelo  = 213;
      aSwPresent = #dsmow331#5;
      aSwPeriodo = "0A";
      |HAZ BorroCarpeta;

      aVent4 = nVent0;
      aVent5 = "MODELESS";
      |ESPECIFICA "ESTADO_VENTANA", aVent;
      |FINVENTANA nVent0;
   |FINSI;

   aSwPresent  = #dsmow331#5;

   |VENTANA 1011, 2089, -1, 17, "Emision modelo 213"; nVent0 = FSalida;
   aVent1 = -1;
   aVent2 = -1;
   aVent3 = 0;
   aVent4 = nVent0;
   aVent5 = "MODAL";
   |ESPECIFICA "ESTADO_VENTANA", aVent;

   |PINPA #0#dsmow317; nPant1 = FSalida;
   |PINDA #0#dsmow317;

   nPos1 = 1648; nPos2 = 1661;
   |CONTROL_SIMPLE nPant1, "BOTON,{{205}}&Emitir modelo", nPos1, nPos2, Emitir213;
   nBotonEmi = FSalida;

   nPos1 = 1663; nPos2 = 1678;
   |CONTROL_SIMPLE nPant1, "BOTON,{{1}}Sa&Lir", nPos1, nPos2, BotonValida;
   nBotonSalir = FSalida;

   nRango = 4 + 8 + 16 + 32;
   nPos1 = 0602; nPos2 = 1578;
   |LINEAL_SIMPLE #1#dsmow332, nRango, nPos1, nPos2, NULL, NULL, EvtoGridSel213;
   nGridEmi = FSalida;
   |PULSATECLA;

   |PAUSA;

   |DESTRUYECONTROL nGridEmi;
   |FIN_CONTROL_WINDOWS nBotonEmi;

   aVent4 = nVent0;
   aVent5 = "MODELESS";
   |ESPECIFICA "ESTADO_VENTANA", aVent;
   |FINVENTANA nVent0;

   |CIERRA #dsmow332; |DELINDEX #dsmow332;
   |CIERRA #dsmow331;
   |CIERRA #dsm213ca; |CIERRA #dsm213in; |CIERRA #dsm213so;

   |ESTADO_CONTROL nIdSalir, "ENABLE";
|FPRC;

|PROCESO SelecContr;
   |VENTANA 1124, 1966, -1, 17, "Seleccion de contribuyentes"; nVentSel = FSalida;
   aVent1 = -1;
   aVent2 = -1;
   aVent3 = 0;
   aVent4 = nVentSel;
   aVent5 = "MODAL";
   |ESPECIFICA "ESTADO_VENTANA", aVent;

   |PINPA #0#dsmow353; nPantSel = FSalida;
   |PINDA #0#dsmow353;

   |ENDATOS #1#dsmow353;
   |SI FSalida ! 0; |DDEFECTO #dsmow353; |FINSI;

   aVent4 = nVentSel;
   aVent5 = "MODELESS";
   |ESPECIFICA "ESTADO_VENTANA", aVent;
   |FINVENTANA nVentSel;
|FPRC;

|PROCESO IndivMasiv;
   |SI nLabel ] 0; |FIN_CONTROL_WINDOWS nLabel; |FINSI;
   |SI #dsmow310#16 = "I";
      |ESTADO_CONTROL nBotonSelec, "DISABLE";
      aAlfa = "LABEL,{{6}}" + #dsm210dp#1; |QBF aAlfa;
   |SINO;
      |ESTADO_CONTROL nBotonSelec, "ENABLE";
      aAlfa = "LABEL,{{6}}Selecci¢n de contribuyentes";
   |FINSI;
   |CONTROL_SIMPLE enPant, aAlfa, 0530, 0578, NULL;
   nLabel = FSalida;
|FPRC;

|PROCESO CalAnyTr;
    |SI fFecha1 [ "01.01.1000"; fFecha1 = ~; |FINSI;
    aAlfa = fFecha1;
    aAlfa = aAlfa % -104;
    nEj210tr = aAlfa;
    |SI nEj210tr < 2014; nEj210tr = 2014; |FINSI;

    #dsm210tr#0 = nTr210tr;
    #dsm210tr#6 = nEj210tr;
    |LEE 000#dsm210tr.=;
    |SI FSalida ! 0; |DDEFECTO #dsm210tr; |FINSI;

    eaPaisCCE = #dsm210dp#7; |HAZ PaisCCE_210;
    |SI eSwPaisCCE = 1;
        nTg210tr = #dsm210tr#5;   || pais de la CE
    |SINO;
        nTg210tr = #dsm210tr#7;   || otros paises
    |FINSI;
|FPRC;
