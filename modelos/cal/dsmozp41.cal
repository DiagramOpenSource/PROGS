|FICHEROS;
     dsmozp41 #0;

     dsmom080 #80;
     dsmom081 #81;
     dsmom085 #85;
     dsmom086 #86;

     dsmom107 #107;

     dsmom041 #41;
     dsmom042 #42;
     dsmom049 #49;

     dsmow041 #998,MANTE;
     dsmow111 #997,MANTE;

     dsmom030 #30;

     :/basica/def/agifigen #1000;
     :/basica/def/agicen14 #1014;
|FIN;

|VARIABLES;
    aParam      = "";
    &enEmpAmor  = 0;
    &enEjeAmor  = 0;
    &enDActAmor = 0;
    &enHActAmor = 0;
    &enModoAmor = 0;
    &enImpRegul = 0;
    fecsys      = @;
    fecalf      = "";
    aAlfa1      = "";
    aAlfa2      = "";
    nNume1      = 0;
    nNume2      = 0;
    nPara1      = 0;
    aFichero    = "";

    nDEmpresa   = 0;
    nHEmpresa   = 0;
    nDActividad = 0;
    nHActividad = 0;
    nCampo      = 0;
    nGTempo     = 0;

    &nCamSel = 24;
    &nCamTip = 37;

    nLinea   = 0;
    aTipo    = "";
    nImport1 = 0;
    nImporte = 0;
    nProm49  = 0;
    fFecha   = @;

    fDFecha  = @;
    fHFecha  = @;
    nGraba   = 0;
    nEstado  = 0;
    nAnyC    = 0;
    nAnyV    = 0;
    nAlgun   = 0;
    nInkey   = 0;
    nSwOp    = 0;
    nSwLinea = 0;

    nConcepto = 0;
    aConcepto = "";
    nEjer     = 0;
|FIN;

|INCLUYE i_variar;
|INCLUYE i_varcon;
|INCLUYE i_numamo;
|INCLUYE i_selcon;

|| //////////////////// Calculos de Pantalla \\\\\\\\\\\\\\\\\\\\\\\\\\
|CALCULO Antes; |TIPO 7;
     fecsys = ~;
     aAlfa1 = fecsys % -104;
     #0#2 = aAlfa1;
     |PINTA #0#2;
|FCAL;

|CALCULO Tipo7_7;  |TIPO 7;
     |SI enEmpresa ! 0;
         #0#8 = enEmpresa; |PINTA #0#8;
         #0#9 = enEmpresa; |PINTA #0#9;

         |C_M #0#8, 1, "N";
         |C_M #0#9, 1, "N";
     |FINSI;
|FCAL;

|CALCULO Parrilla;
     |SI #0#8 = 0;
         #0#8 = 0;  |PINTA #0#8;
         #0#9 = 0;  |PINTA #0#9;  |C_M #0#9, 1, "N";
         |PARA nCampo = 10;  |SI nCampo [ 21;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |SINO;
         |SI enEmpresa = 0;
             |C_M #0#8, 1, "S";
             |C_M #0#9, 1, "S";
         |FINSI;

         |PARA nCampo = 10;  |SI nCampo [ 21;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "N";
               #0nCampo = 0;  |PINTA #0nCampo;
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO NoMasEmpresas;
     |SI #0Campo = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 21;  |HACIENDO nCampo = nCampo + 1;
               #0nCampo = 0;  |C_M #0nCampo, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 21;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO numamo; |TIPO 0;
    x_alfa1 = #0Campo;
    |HAZ x_punto;
    #0Campo = x_alfa1;
    |PINTA #0Campo;
|FCAL;

|CALCULO ElPtec; |TIPO 7;
 |PTEC 816;
|FCAL;

|| ............................................................
|PROCESO RegulVenta;
         nNume1 = #41#45 + 1;
         nNume2 = nNume2 - #0#2 + 1; || A¤o final - actual mas 1
         nImport1 = (#41#43 / nNume1) * nNume2;  ||IVA sop. que me queda

         nImporte = #41#52 -  nImport1;
         |SI nImporte > 0; nImporte = 0; |FINSI;
         nLinea = 0;
         fFecha = #41#26;
         aTipo    = "R";
         nConcepto = 1;
         aConcepto = "Regularizacion por Venta ";
         |HAZ Actu49;
         nGraba = 1;
         nImporte = #49#10;
|FPRC;

|PROCESO RegulAnyo;
         nNume1 = #41#42 - nProm49;
         |SI nNume1 ] -10; |Y nNume1 [ 10;   || Diferencia de mas de 10 puntos
              nImporte = 0;
         |SINO;
              nImport1 = (#41#10 % #41#46) % nProm49;
              nImporte = nImport1 - #41#43;
         |FINSI;
         nNume1   = #41#45 + 1;
         nImporte = (nImporte / nNume1);
         nLinea = 0;
         fFecha = fHFecha;
         aTipo    = "R";
         nConcepto = #0#5;
         aConcepto = #0#6;
         |HAZ Actu49;
         nGraba = 1;
         nImporte = #49#10;
|FPRC;

|PROCESO RegulCompra;
         #41#42 = nProm49;
         #41#43 = ( (#41#10 % #41#46) ) % #41#42;
         nLinea = 1;
         fFecha = #41#27;
         nImporte = 0;
         aTipo    = "C";
         |HAZ Actu49;
         |GRABA 020#41a;
         nGraba = 1;
|FPRC;

|PROCESO LeoCalculo_p41
 #0#38 = #0#38 + #49#10;
|FPRC;

|DEFBUCLE LeoCalculo_p41
 #49#1;
 5;
 #41#0, #41#2, #41#3, 01, #0#2;
 #41#0, #41#2, #41#3, 99, #0#2;
 ;
 NULL, LeoCalculo_p41
|FIN;

|PROCESO dsmom041;

   |SI #41#1 < nDActividad; |O #41#1 > nHActividad;  |ACABA; |FINSI;

   |SI nSwOp = 1;
       |BUCLE LeoCalculo_p41;
       |ACABA;
   |FINSI;

   nProm49 = 100;
   |SI enSwProrr ! 2;
        |SI #0#2 [ 2010;
            |ABRE #81;
            #81#0 = enEmpresa;
            #81#1 = #0#2;
            #81#2 = #41#1;
            |LEE 001#81=;
            |SI FSalida = 0;
                nProm49 = #81#6;
            |SINO;
               |ABRE #80;
               #80#0 = enEmpresa;
               #80#1 = #0#2;
               |LEE 001#80=;
               |SI FSalida = 0;
                   nProm49 = #80#5;
               |FINSI;
               |CIERRA #80;
           |FINSI;
           |CIERRA #81;
       |SINO;
            |ABRE #86;
            #86#0 = enEmpresa;
            #86#1 = #0#2;
            #86#2 = #41#1;
            |LEE 001#86=;
            |SI FSalida = 0;
                nProm49 = #86#6;
            |SINO;
               |ABRE #85;
               #85#0 = enEmpresa;
               #85#1 = #0#2;
               |LEE 001#85=;
               |SI FSalida = 0;
                   nProm49 = #85#5;
               |FINSI;
               |CIERRA #85;
           |FINSI;
           |CIERRA #86;
       |FINSI;
   |FINSI;

   |SI #41#27 ] fHFecha; |ACABA; |FINSI;
   |SI #41#26 > "01.01.0000"; |Y #41#26 [ fDFecha; |ACABA; |FINSI;

   nGraba   = 0;
   nImporte = 0;
   aAlfa1   = #41#27;
   aAlfa1   = aAlfa1 % -104; nAnyC  = aAlfa1;

   nAnyV  = 0;
   |SI #41#26 > "01.01.0000";
       aAlfa1 = #41#26;
       aAlfa1 = aAlfa1 % -104; nAnyV  = aAlfa1;
   |FINSI;

   |SI #41#27 ] fDFecha; |Y #41#27 [ fHFecha;   ||A¤o de la Compra
       |SI enModoAmor = 0;
           |HAZ RegulCompra;
       |FINSI;
       |SI nAnyV ! 0;
           nNume1 = nAnyC + 1;
           nNume2 = nAnyC + #41#45;
           |HAZ RegulVenta;
       |FINSI;
       nGraba = 1;
   |SINO;
       nNume1 = nAnyC + 1;
       nNume2 = nAnyC + #41#45;

       |SI nAnyV = 0;    || No hay venta del Elemento
           |SI #0#2 ] nNume1; |Y #0#2 [ nNume2;
               |HAZ RegulAnyo;
           |FINSI;
       |SINO;
           |SI nAnyV = #0#2;    ||estamos en el a¤o de la venta
               |SI #0#2 ] nNume1; |Y #0#2 [ nNume2;
                    |HAZ RegulAnyo;
               |FINSI;
           |FINSI;
       |FINSI;
   |FINSI;

   |SI nGraba = 0;   |ACABA; |FINSI;
   |SI nImporte = 0; |ACABA; |FINSI;

   nAlgun = 1;
   #997#0 = #41#0;   || Empresa
   #997#1 = #41#2;   || Elemento
   #997#2 = #41#3;   || numero
   |LEE 101#997=;
   |SI FSalida ! 0;
       |DDEFECTO #997;
       #997#0 = #41#0;   || Empresa
       #997#1 = #41#2;   || Elemento
       #997#2 = #41#3;   || numero
       |GRABA 020#997b;
   |FINSI;

   #997#3 = #41#4;    || descripcion
   |SI nAnyV ! 0; #997#4 = nAnyV; |FINSI;
   #997#5 = nAnyC;
   #997#6 = #41#27;
   #997#7 = #41#10;
   #997#9 = #41#52;
   #997#13 = #41#1;
   #997#14 = #41#33;
   #997#16 = #41#41;
   #997#17 = #41#42;
   #997#18 = #41#43;
   #997#19 = #41#44;
   #997#20 = #41#45;
   #997#21 = #41#46;
   #997#22 = #0#2;
   #997#23 = fHFecha;
   #997#24 = nProm49;
   #997#25 = nImporte;
   #997#26 = #49#6;
   #997#27 = #49#7;
   #997#28 = #49#4;
   |GRABA 020#997a;
   |LIBERA #997;
|FPRC;

|DEFBUCLE dsmom041;
   #41#1;
   41;
   enEmpresa,#0#0,#0#3, "S";
   enEmpresa,#0#1,#0#4, "S";
   e;
   NULL, dsmom041;
|FIN;

|PROCESO GrabaAuxiliar;

  enEmpresa = #agifigen#0;
  eaEstadoEmp = "S";
  |SI #agifigen#94 > "01.01.0000";
      eaEstadoEmp = "N";
      |SI #0#24 = "N"; |ACABA; |FINSI;
  |FINSI;

|| ... Seleccion de Tipo de Empresa
   nSPin1 = #agifigen#87;
   enSwSelEmp = 1;
   |SI #0#37 = "S";
       |SI nSPin1 ] #0#25; |Y nSPin1 [ #0#26;
           enSwSelEmp = 0;
       |FINSI;
   |SINO;
       |SI nSPin1 = #0#27;
           enSwSelEmp = 0;
       |SINO;
           |PARA nCampo = 28;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
                  |SI nSPin1 = #0nCampo; |Y nSPin1 ! 0;
                       enSwSelEmp = 0;
                       |SAL;
                  |FINSI;
            |SIGUE;
       |FINSI;
    |FINSI;
    |SI enSwSelEmp = 1; |ACABA; |FINSI;

    |HAZ LeeCtrlProrr;

    nSwOp = 0;
    |ABRE #49;
    nAlgun = 0;
    |BUCLE dsmom041;
    |SI nAlgun = 1;
        #998#0 = enEmpresa;
        |LEE 101#998=;
        |SI FSalida ! 0;
            #998#0 = enEmpresa;
            #998#1 = #1000#1;
            |GRABA 020#998b;
        |FINSI;
        |LIBERA #998;
        nGTempo = 1;
    |FINSI;
    |CIERRA #49;
|FPRC;

|DEFBUCLE agifigen;
    #1000#1;
    ;
    nDEmpresa;
    nHEmpresa;
    ;
    NULL, GrabaAuxiliar;
|FIN;

|PROCESO ClaveBaja997;
 #997#0 = enEmpresa;
 #997#1 = "        ";
 #997#2 = 00;
|FPRC;

|PROCESO ClaveAlta997;
 #997#0 = enEmpresa;
 #997#1 = "zzzzzzzz";
 #997#2 = 99;
|FPRC;

|| ========================================================================
|PROCESO dsmow111;
 |PRINT;
 nSwLinea = 1;
 #0#38 = #0#38 + #997#25;
|FPRC;

|DEFBUCLE dsmow111;
 #997#1;
 ;
 #998#0, "        ", 00;
 #998#0, "zzzzzzzz", 99;
 ;
 NULL, dsmow111;
|FIN;


|PROCESO ParaListar;
 |IMPRE 0;
 |SI FSalida ! 0; |ACABA; |FINSI;
 |INFOR "dsmow111";
 |SI FSalida ! 0;
     |MENAV "    Error no existe Informe";
     |FINIMP;
     |ACABA;
 |FINSI;

 nSwLinea = 0;
 #0#38 = 0;
 |BUCLE dsmow111;
 |SI nSwLinea = 1;
     |PIEINF;
 |FINSI;
 |FININF;
 |FINIMP;
|FPRC;


|CALCULO LeelaEmpresa; |TIPO 0;
   enEmpresa = #998#0;
|FCAL;

|PROCESO Tipo1; |TIPO 1;
|FPRC;

|PROCESO Tipo7;  |TIPO 7;
     |MENSA "    <F2> Entrar en Elementos Amortizables, <F3> Informe Regularizacion";

     |PINTA  #998#1;
     enModo    = 7;
     enEmpresa = #998#0;
    |ABRE #997;
    #997#0 = enEmpresa;
    #997#1 = "        ";
    #997#2 = 00;
    |LEE 001#997];
    |SI FSalida ! 0; |O #997#0 ! enEmpresa;
        |DDEFECTO #997;
    |FINSI;
    |CIERRA #997;
    |PINDA #0#997;

    |ENTLINEAL #1#997, -3, 7, 22, 0, ClaveBaja997, ClaveAlta997;
|FPRC;

|PROCESO Tipo11;  |TIPO 11;
   nInkey = FSalida;
   |SI nInkey =  10;
         enModo   = 2;
         enEmpresa = #998#0;
         |ENTLINEAL #1#997, -3, 4, 22, 0, ClaveBaja997, ClaveAlta997;
   |FINSI;
   |SI nInkey =  11;
       |HAZ ParaListar;
   |FINSI;
|FPRC;

||************************************************************************
|PROCESO Tipo11w111;  |TIPO 11;
   nInkey = FSalida;
   |SI nInkey = 10;
       |LEE 141#997=;

      |ENCAMPO #25#997;

      |GRABA 000#997a;
      |LIBERA #997;

      |HAZ Actualiza49;
  |FINSI;

|FPRC;

||************************************************************************
|PROCESO LeoParaCompra;
 #49#7 = #42#12;
 #49#8 = #42#10;
|FPRC;

|DEFBUCLE LeoParaCompra;
 #42#1;
 6;
 #49#0, #49#2, #49#3, 001, "C";
 #49#0, #49#2, #49#3, 999, "C";
 e;
 NULL, LeoParaCompra;
|FIN;


|PROCESO Actu49;

    |DDEFECTO #49;
    #49#0 = #41#0;
    #49#2 = #41#2;
    #49#3 = #41#3;

|SI nLinea = 0;
    |SELECT #2#49;
    #49#5  = #0#2;
    #49#11 = aTipo;
    |LEE 001#49=;
    |SI FSalida = 0;
        nLinea = #49#4;
        |SELECT #1#49;
    |SINO;
        |SELECT #1#49;
        #49#0 = #41#0;
        #49#2 = #41#2;
        #49#3 = #41#3;
        #49#4 = 999;
        |LEE 001#49];
        |SI FSalida = 0;
            |LEE 001#49a;
        |SINO;
            |LEE 001#49u;
        |FINSI;
        nLinea = 2;
        |SI #49#0 = #41#0; |Y #49#2 = #41#2; |Y #49#3 = #41#3;
            nLinea = #49#4 + 1;
        |FINSI;
    |FINSI;
|FINSI;

    |DDEFECTO #49;
    #49#0 = #41#0;
    #49#2 = #41#2;
    #49#3 = #41#3;
    #49#4 = nLinea;
    |LEE 101#49=;
    nEstado = FSalida;

    #49#0  = #41#0;
    #49#1  = #41#1;
    #49#2  = #41#2;
    #49#3  = #41#3;
    #49#4  = nLinea;
    #49#5  = #0#2;
    #49#6  = fFecha;
    |SI nEstado ! 0;
        |SI nLinea = 1;
            #49#7 = 1;
            #49#8 = "Compra del Elemento";
            |BUCLE LeoParaCompra;
        |SINO;
            #49#7 = nConcepto;
            #49#8 = aConcepto;
        |FINSI;
    |FINSI;
    |SI nEstado ! 0; |O enModoAmor = 0;
        #49#9  = nProm49;
        #49#10 = nImporte; |SI enModoAmor = 1; #49#10 = 0; |FINSI;
        #49#11 = aTipo;
    |FINSI;
    |SI nEstado = 0; |Y enModoAmor = 0; |GRABA 020#49a; |FINSI;
    |SI nEstado ! 0; |GRABA 020#49b; |FINSI;
    |LIBERA #49;
|FPRC;

|| ========================================================================
|PROCESO Actualiza49;
    |ABRE #49;
    #49#0 = #997#0;
    #49#2 = #997#1;
    #49#3 = #997#2;
    #49#4 = #997#28;
    |LEE 101#49=;
    |SI FSalida = 0;
        #49#10 = #997#25;
        |GRABA 020#49a;
    |FINSI;
    |LIBERA #49;
    |CIERRA #49;
|FPRC;
|| ========================================================================
|PROCESO ClaveBaja998;
 #998#0 = 00001;
|FPRC;

|PROCESO ClaveAlta998;
 #998#0 = 99999;
|FPRC;

|PROCESO Tipo3;  |TIPO 3;

    nDActividad = #0#22;
    nHActividad = #0#23;
    aAlfa1  = #0#2; |QBF aAlfa1;
    aAlfa2  = "01.01." + aAlfa1; fDFecha = aAlfa2;
    aAlfa2  = "31.12." + aAlfa1; fHFecha = aAlfa2;

    aFichero = ("3w" + Usuario) % 108;
    |NOME_DAT #997 aFichero;
    |ABRE #997;  |CIERRA #997;  |DELINDEX #997;

    aFichero = ("4w" + Usuario) % 108;
    |NOME_DAT #998 aFichero;
    |ABRE #998;  |CIERRA #998;  |DELINDEX #998;

    |ABRE #998;
    |ABRE #997;
    nGTempo = 0;   ||Busco Empresas Contables
    |SI #0#8 ! 0;
        nDEmpresa = #0#8;
        nHEmpresa = #0#9;
        |BUCLE agifigen;
    |SINO;
        |PARA nPara1 = 10;;  |SI nPara1 [ 21;  |HACIENDO nPara1 = nPara1 + 1;
              |SI #0nPara1 ! 0;
                  nDEmpresa = #0nPara1;
                  nHEmpresa = #0nPara1;
                  |BUCLE agifigen;
              |FINSI;
        |SIGUE;
     |FINSI;
     |CIERRA #998;
     |CIERRA #997;

     |SI nGTempo = 0;    || No existe ninguna empresa
         |SI aParam = "";
            aAlfa1 = "    No existen Elementos a regularizar dentro de la Seleccion ";
            |MENAV aAlfa1;
         |FINSI;
     |SINO;
          |SI aParam = "";
              |C_P #998#0,1,602; |C_P #998#1,1,0714;
              |PINPA #0#997;
              |ENTLINEAL #1#998, -1, 4, 22, 0, ClaveBaja998, ClaveAlta998;
          |FINSI;
          |SI enEmpAmor ! 0;
              nSwOp = 1;
              #0#38 = 0;
              |BUCLE dsmom041;
          |FINSI;
     |FINSI;

     |DELINDEX #997;
     |DELINDEX #998;
|FPRC;

|PROGRAMA;
     aParam = PARAMETRO; |QBF aParam;
     nEjer = enEjer;
     |SI aParam = ""; |Y enEmpAmor = 0;
         |ABRE #107;
         |DDEFECTO #107;
         |LEE 040#107p;
         |CIERRA #107;
     |FINSI;

     |SI enEmpAmor ! 0;
         |DDEFECTO #0;
         #0#2  = enEjeAmor;
         #0#8  = enEmpAmor;
         #0#9  = enEmpAmor;
         #0#22 = enDActAmor;
         #0#23 = enHActAmor;
         |HAZ Tipo3;
         enImpRegul = #0#38;
    |SINO;
         enModoAmor = 0;
         |MANTE #0;
    |FINSI;
    enEjer = nEjer;
|FPRO;
