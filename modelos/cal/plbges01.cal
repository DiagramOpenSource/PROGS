|FICHEROS;
  dsmom002 #2;
  dsmom004 #4;
  dsmom008 #8;
  dsmocivp #165;

  dsmom107 #107;

  dsmom027 #27;
  dsmom028 #28;
  dsmom029 #29;
  dsmom047 #47;

  dsmom080 #80;
  dsmom081 #81;
  dsmom082 #82;
  dsmom083 #83;
  dsmom084 #84;

  dsmom085 #85;
  dsmom086 #86;
  dsmom087 #87;

  dsmom109 #109;

  program@ #777;

  :/basica/def/agicen14 #114;
|FIN;

|VARIABLES;
 aAlfa1      = "";
 aDef        = "";
 aPathModelo = "";
 aAlfa       = "";
 nDep        = 0;
 nCalcul  = 0;
 nCanti10 = 0;
 nCanti12 = 0;
 nCanti13 = 0;
 nCanti15 = 0;
 nCanti16 = 0;
 nCanti18 = 0;
 nCanti19 = 0;
 nCanti21 = 0;
 nDigo    = 0;
 nNume1   = 0;
 nSwEx82  = 0;
 nUltimo  = 0;
 nSw      = 0;

 &enActPro = 0;
 &enProAct = 0;
 &enProCom = 0;

 nPeriodo = 0;
 nModelo  = 0;
 nComplem = 0;
 nSwOp    = 0;
 nHay12   = 0;
 nAny     = 0;

 nCampo15 = 0;
 aCampo16 = "";
 aCampo17 = "";
 nEstado  = 0;
 nEjer    = 0;
|FIN;

|INCLUYE i_variar;
|INCLUYE i_varcon;

|| ... ... ... ... ... ... ... ... ... Prorrata
|PROCESO Ctr109_2014;
     nSw = 0;
     |ABRE #109;
     #109#0 = nEjer;
     |LEE 141#109=;
     nEstado = FSalida;
     |SI FSalida ! 0; |O #109#57 = " "; nSw = 1; |FINSI;

     |SI #109#73 = 0; |Y #109#0 = 2015; nSw = 1; |FINSI;

     |SI nSw = 1;
         |DDEFECTO #109;
         #109#0  = nEjer;
         #109#26 = "V.OP. Regimen general ..........";
         #109#27 = "V.OP. Entregas intracomunitarias";
         #109#28 = "V.OP. Exportaciones ............";
         #109#29 = "V.OP. Otras operaciones exenta .";
         #109#30 = "V.OP. Reg.esp. bienes usados, ..";
         #109#31 = "V.OP. Operaciones exentas sin ..";
         #109#32 = "V.OP. Regimen especial de recal.";
         #109#51 = "V.OP. Regimen especial de Agenci";
         #109#52 = "V.OP. Entregas de bienes de in.";

         #109#57 = "+"; #109#58 = "+";
         #109#59 = "+"; #109#60 = "+";
         #109#61 = "+"; #109#67 = "+";
         #109#68 = "-";

         #109#62 = "+"; #109#63 = "+";

         #109#43 = 3; #109#44 = 4;  #109#69  = "+";
         #109#73 = 3; #109#74 = 16; #109#109 = "+";
         #109#75 = 3; #109#76 = 17; #109#110 = "+";
         #109#53 = "V.OP. Op.no sujeta por regla l";
         #109#97 = "V.OP. Entregas intracomunitari";
         #109#98 = "V.OP. Operaciones criterio de ";

         |SI nEstado ! 0; |GRABA 040#109n; |FINSI;
         |SI nEstado = 0; |GRABA 040#109a; |FINSI;
     |FINSI;
     |CIERRA #109;
|FPRC;

|PROCESO Lee_109;
 eaDesg109   = #109#36;
 eaPanPro    = #109#37;
 enSwPorCom  = 0; |SI #109#1  = "S"; enSwPorCom = 1; |FINSI;
 enAdTodas   = 0; |SI #109#38 ! "S"; enAdTodas = 1; |FINSI;
|FPRC;

|DEFBUCLE Lee_109;
 #109#1;
 ;
 0001;
 enEjer;
 ;
 NULL, Lee_109;
|FIN;

|PROCESO LeeCtrlProrr;
     |ABRE #107;
     |DDEFECTO #107;
     |LEE 040#107p;
     |CIERRA #107;

     enSwProrr = 0; || con prorrata
     |SI #107#9 = "N";
         enSwProrr = 2; || No hay Prorratas;
         eaProrrat = "N";
         nProrrata = 100;
     |SINO;
         |SI #107#10 = "S";  enSwProrr = 1; |FINSI; || Pregunto 15.10.2004
     |FINSI;

     enEjerPro   = 2005;  || Fijo antes utiliza calculos anteriores
     enSwPorCom  = 0;
     |SI #107#12 = "S"; enSwPorCom = 1; |FINSI;

     nEjer = 2014; |HAZ Ctr109_2014;
     nEjer = 2015; |HAZ Ctr109_2014;

     eaDesg109 = "N";
     eaPanPro  = "N";
     |BUCLE Lee_109;

     |SI enEmpresa ! 0; |Y enEjer ! 0;
        |ABRE #84;
        #84#0 = enEmpresa;
        #84#1 = enEjer;
        |LEE 000#84=;
        |SI FSalida = 0;
            |SI #84#6 = "N"; enSwProrr = 2; |FINSI;
        |FINSI;
        |CIERRA #84;
    |FINSI;
|FPRC;

|| ... Proceso de prorrata antes del 2005

|PROCESO Grabarm029_Act;
 |ABRE #29;
 #29#0 = enEmpresa;
 #29#1 = enEjer;
 #29#2 = enPeriodo;
 #29#9 = nDep;
 |LEE 101#29=;
 |SI FSalida ! 0;
      |DDEFECTO #29;
      #29#0 = enEmpresa;
      #29#1 = enEjer;
      #29#2 = enPeriodo;
      |SI enPeriodo = 1;   #29#7 = "ENERO     ";  |FINSI;
      |SI enPeriodo = 2;   #29#7 = "FEBRERO   ";  |FINSI;
      |SI enPeriodo = 3;   #29#7 = "MARZO     ";  |FINSI;
      |SI enPeriodo = 4;   #29#7 = "ABRIL     ";  |FINSI;
      |SI enPeriodo = 5;   #29#7 = "MAYO      ";  |FINSI;
      |SI enPeriodo = 6;   #29#7 = "JUNIO     ";  |FINSI;
      |SI enPeriodo = 7;   #29#7 = "JULIO     ";  |FINSI;
      |SI enPeriodo = 8;   #29#7 = "AGOSTO    ";  |FINSI;
      |SI enPeriodo = 9;   #29#7 = "SEPTIEMBRE";  |FINSI;
      |SI enPeriodo = 10;  #29#7 = "OCTUBRE   ";  |FINSI;
      |SI enPeriodo = 11;  #29#7 = "NOVIEMBRE ";  |FINSI;
      |SI enPeriodo = 12;  #29#7 = "DICIEMBRE ";  |FINSI;
      |SI enPeriodo = 99;  #29#7 = "ANUAL     ";  |FINSI;
      #29#9 = nDep;
      |GRABA 020#29b;
 |FINSI;

 #29#3 = #29#3 + enImpIvaSop;
 #29#4 = nProrrata;
 #29#5 = #29#5 + enIvaSopDed;
 #29#6 = #29#3 - #29#5;
 #29#8 = #29#8 + enImpIvaSub;
 |SI #29#6 = 0;
     |SI #29#3 ! 0; |Y #29#5 ! 0;
         #29#4 = 100;
     |FINSI;
 |FINSI;
 |SI #29#4 = 0;   #29#4 = 100; |FINSI;
 |SI #29#4 > 100; #29#4 = 100; |FINSI;
 |GRABA 020#29a;
 |LIBERA #29;
 |CIERRA #29;
|FPRC;

|PROCESO Grabarm029;
 |SI eaProrrat = "N"; |ACABA; |FINSI;
 |SI enActividad ! 0;
     nDep = enActividad;
     |HAZ Grabarm029_Act;
 |FINSI;
 nDep = 0;
 |HAZ Grabarm029_Act;
|FPRC;

|| **************** Baja Prorrata
|PROCESO eLeeActm083;

  #81#12 = #81#12 + #83#9;
  |SI #83#3 ! 12; |O #83#1 ] 2009;
      #81#11 = #81#11 + #83#4;
      #81#13 = #81#13 + #83#6;

      #81#16 = #81#16 + #83#10;
      #81#17 = #81#17 + #83#11;
      #81#18 = #81#18 + #83#12;
      #81#19 = #81#19 + #83#13;
      #81#20 = #81#20 + #83#14;
      #81#21 = #81#21 + #83#15;
      #81#22 = #81#22 + #83#16;
      #81#37 = #81#37 + #83#55;

      #81#23 = #81#23 + #83#17;
      #81#24 = #81#24 + #83#18;
      #81#25 = #81#25 + #83#19;
      #81#26 = #81#26 + #83#20;
      #81#27 = #81#27 + #83#21;
      #81#28 = #81#28 + #83#22;
      #81#29 = #81#29 + #83#23;
      #81#38 = #81#38 + #83#56;
  |SINO;
      #81#11 = #83#4;
      #81#13 = #83#6;

      #81#16 = #83#10;
      #81#17 = #83#11;
      #81#18 = #83#12;
      #81#19 = #83#13;
      #81#20 = #83#14;
      #81#21 = #83#15;
      #81#22 = #83#16;
      #81#37 = #83#55;

      #81#23 = #83#17;
      #81#24 = #83#18;
      #81#25 = #83#19;
      #81#26 = #83#20;
      #81#27 = #83#21;
      #81#28 = #83#22;
      #81#29 = #83#23;
      #81#38 = #83#56;
  |FINSI;

  #81#14 = #81#11 - #81#13;

  #81#30 = #81#16 - #81#23;
  #81#31 = #81#17 - #81#24;
  #81#32 = #81#18 - #81#25;
  #81#33 = #81#19 - #81#26;
  #81#34 = #81#20 - #81#27;
  #81#35 = #81#21 - #81#28;
  #81#36 = #81#22 - #81#29;
  #81#39 = #81#37 - #81#38;

  nUltimo = #83#3;
|FPRC;

|DEFBUCLE eLeeActm083;
 #83#1;
 ;
 #81#0, #81#1, #81#2, 01;
 #81#0, #81#1, #81#2, 12;
 ;
 NULL, eLeeActm083;
|FIN;

|PROCESO eActm081;

 #81#11 = 0; #81#12 = 0;
 #81#13 = 0; #81#14 = 0;
 |PDEFECTO #81,16,40;
 #81#42 = 0; #81#43 = 0;

 nUltimo = 0;
 |BUCLE eLeeActm083;
 |SI nUltimo = 12;
     #81#42 = (#81#11 % #81#6) ! 2;
     #81#43 = #81#42 - #81#13;
     #81#14 = #81#14 - #81#43;
 |SINO;
     #81#42 = #81#13;
     #81#43 = 0;
 |FINSI;
 #80#44 = #80#44 + #81#42;
 #80#45 = #80#45 + #81#43;

 |GRABA 020#81a;
 |LIBERA #81;
|FPRC;

|DEFBUCLE eActm081;
 #81#1;
 ;
 enEmpresa, enEjer, 00;
 enEmpresa, enEjer, 99;
 be;
 NULL, eActm081;
|FIN;

|PROCESO eActPer082;

  #80#11 = #80#11 + #82#8;

  |SI #82#2 ! 12; |O #82#1 ] 2009;
      #80#10 = #80#10 + #82#3;

      #80#17 = #80#17 + #82#9;
      #80#18 = #80#18 + #82#10;
      #80#19 = #80#19 + #82#11;
      #80#20 = #80#20 + #82#12;
      #80#21 = #80#21 + #82#13;
      #80#22 = #80#22 + #82#14;
      #80#23 = #80#23 + #82#15;
      #80#40 = #80#40 + #82#55;

  |SINO;
      #80#10 = #82#3;

      #80#17 = #82#9;
      #80#18 = #82#10;
      #80#19 = #82#11;
      #80#20 = #82#12;
      #80#21 = #82#13;
      #80#22 = #82#14;
      #80#23 = #82#15;
      #80#40 = #82#55;

  |FINSI;

  #80#12 = #80#12 + #82#39;

  #80#24 = #80#24 + #82#40;
  #80#25 = #80#25 + #82#41;
  #80#26 = #80#26 + #82#42;
  #80#27 = #80#27 + #82#43;
  #80#28 = #80#28 + #82#44;
  #80#29 = #80#29 + #82#45;
  #80#30 = #80#30 + #82#46;
  #80#41 = #80#41 + #82#59;

  #80#13 = #80#10 - #80#12;

  #80#33 = #80#17 - #80#24;
  #80#34 = #80#18 - #80#25;
  #80#35 = #80#19 - #80#26;
  #80#36 = #80#20 - #80#27;
  #80#37 = #80#21 - #80#28;
  #80#38 = #80#22 - #80#29;
  #80#39 = #80#23 - #80#30;
  #80#42 = #80#40 - #80#41;

  nUltimo = #82#2;
|FPRC;

|DEFBUCLE eActPer082;
 #82#1;
 ;
 enEmpresa, enEjer, 01;
 enEmpresa, enEjer, 12;
 e;
 NULL, eActPer082;
|FIN;

|PROCESO eActm080;
 #80#44 = 0; #80#45 = 0;
 |BUCLE eActm081;

 #80#10 = 0; #80#11 = 0;
 #80#12 = 0; #80#13 = 0;
 |PDEFECTO #80,17,31;
 |PDEFECTO #80,33,43;

 nUltimo = 0;
 |BUCLE eActPer082;
 |SI nUltimo ! 12;
     #80#44 = #80#12;
     #80#45 = 0;
 |SINO;
     #80#13 = #80#13 - #80#45;
 |FINSI;

 |GRABA 020#80a;
|FPRC;

|PROCESO eBorram083;
     |BORRA 020#83a;
     |LIBERA #83;
|FPRC;

|DEFBUCLE eBorram083;
     #83#1;
     ;
     enEmpresa, enEjer, 00, #82#2;
     enEmpresa, enEjer, 99, #82#2;
     be;
     NULL, eBorram083;
|FIN;

|PROCESO eBajaProrrata;

  |SI enEjer [ 2010;
      |ABRE #80;
      #80#0 = enEmpresa;
      #80#1 = enEjer;
      |LEE 141#80=;
      |SI FSalida = 0;
          |ABRE #82;
          #82#0 = #80#0;
          #82#1 = #80#1;
          #82#2 = enPeriodo;
          |LEE 141#82=;
          |SI FSalida = 0;
              |BORRA 020#82a;
              |BUCLE eBorram083;
              |HAZ eActm080;
          |FINSI;
          |LIBERA #82;
          |CIERRA #82;
      |FINSI;
      |LIBERA #80;
      |CIERRA #80;
  |SINO;
      |SI enEjer ] 2011; |Y enPeriodo = 12; |Y enTipoEntrada = 3;
          |ABRE #85;
          #85#0 = enEmpresa;
          #85#1 = enEjer;
          |LEE 040#85=;
          |SI FSalida = 0;
              |CIERRA #85;
              |SUB_EJECUTA_NP "dsmozp04";
          |SINO;
              |CIERRA #85;
          |FINSI;
      |FINSI;
  |FINSI;
|FPRC;

|| ***********************************************************
|| ... Datos del 2011
|PROCESO LecturaAnter85;
   nAny = #85#1 - 1;
   |SI nAny [ 2010;
       |ABRE #80;
       #80#0 = enEmpresa;
       #80#1 = nAny;
       |LEE 041#80=;
       |SI FSalida = 0; |Y #80#4 ! "N";
           #85#2 = #80#4;
           #85#3 = #80#5;
           #85#15 = #80#16;
           #85#16 = #80#32;
       |FINSI;
       |CIERRA #80;
   |SINO;
       #85#0 = enEmpresa;
       #85#1 = nAny;
       |LEE 041#85=;
       |SI FSalida = 0;
           #85#0 = enEmpresa;
           #85#1 = enEjer;
           #85#2 = #85#4;
           #85#3 = #85#5;
           |PDEFECTO #85, 4, 15;
           #85#16 = #85#17;
           #85#17 = 100;
       |FINSI;
   |FINSI;
|FPRC;

|PROCESO LecturaAnter86;
   nAny = #86#1 - 1;
   |SI nAny [ 2010;
       |ABRE #81;
       #81#0 = #86#0;
       #81#1 = nAny;
       #81#2 = #86#2;
       |LEE 041#81=;
       |SI FSalida = 0;
           #86#5  = #81#6;
           #86#16 = #81#40;
           |SI #86#16 = "P"; #86#17 = "PRINCIPAL"; |FINSI;
           |SI #86#16 = "C"; #86#17 = "COMPLEMENTARIA"; |FINSI;
           |SI #86#16 = "O"; #86#17 = "OTRA"; |FINSI;
       |FINSI;
       |CIERRA #81;
   |SINO;
       |SALVA_FICHA #86;
       #86#1 = nAny;
       |LEE 041#86=;
       |SI FSalida = 0;
           nNume1   = #86#6;
           nCampo15 = #86#15;
           aCampo16 = #86#16;
           aCampo17 = #86#17;
           |REPON_FICHA #86;
           #86#5  = nNume1;
           #86#15 = nCampo15;
           #86#16 = aCampo16;
           #86#17 = aCampo17;
       |SINO;
           |REPON_FICHA #86;
       |FINSI;
   |FINSI;
|FPRC;

|PROCESO Datos86;
      |SI #86#2 ! 0; |Y #86#2 ! 99;
          |ABRE #114;
          |DDEFECTO #114;
          #114#0 = #86#0;
          #114#1 = #86#2;
          |LEE 041#114=;
          |CIERRA #114;
          #86#3 = #114#4;
          #86#4 = #114#20;
          #86#5 = #85#16; |SI #85#2 = "E"; #86#5 = 100; |FINSI;
          #86#6 = #85#17; |SI #85#3 = "E"; #86#6 = 100; |FINSI;

          |HAZ LecturaAnter86;
      |SINO;
          |SI #86#2 = 99;
              #86#3  = "REGISTRO DE REGULARIZACION";
              #86#4  = "";
              #86#16 = "X";
              #86#17 = "COMUN";
              #86#5  = 100;
              #86#6  = 100;
          |SINO;
              #86#3 = "IVA SOPORTADO OPERACIONES COMUNES (DESDE CONTABILIDAD)";
              #86#4  = "";
              #86#16 = "X";
              #86#17 = "COMUN";
              #86#5 = #85#16;
              #86#6 = #85#17;
          |FINSI;
       |FINSI;
|FPRC;

|PROCESO eNuevoPro;

  |SI enSwProrr ! 2;
      |ABRE #85;
      |DDEFECTO #85;
      #85#0 = enEmpresa;
      #85#1 = enEjer;
      |LEE 041#85=;
      |SI FSalida ! 0;
          |DDEFECTO #85;
          #85#0 = enEmpresa;
          #85#1 = enEjer;
          |HAZ LecturaAnter85;
          |GRABA 020#85n;
      |FINSI;
      |CIERRA #85;

      |ABRE #86;
      |DDEFECTO #86;
      #86#0 = enEmpresa;
      #86#1 = enEjer;
      #86#2 = enActividad;
      |LEE 001#86=;
      |SI FSalida ! 0;
          |DDEFECTO #86;
          #86#0 = enEmpresa;
          #86#1 = enEjer;
          #86#2 = enActividad;
          |HAZ Datos86;
          |GRABA 020#86n;
      |FINSI;
      |CIERRA #86;

      enProAct = #86#5; enProCom = #85#16;
      |SI enPeriodo = 12;
          enProAct = #86#6; enProCom = #85#17;
      |FINSI;
 |FINSI;
|FPRC;

|PROCESO Dsmom087;

  #86#0 = #87#0;
  #86#1 = #87#1;
  #86#2 = #87#5;  ||Actividad
  |LEE 141#86=;
  |SI FSalida ! 0;
      |DDEFECTO #86;
      #86#0 = #87#0;
      #86#1 = #87#1;
      #86#2 = #87#5;  ||Actividad

      |HAZ Datos86;
      |GRABA 020#86b;
  |FINSI;

  #86#10 = #86#10 + #87#12;
  #86#11 = #86#11 + #87#13;
  #86#12 = #86#12 + #87#13;
  #86#14 = #86#10 - #86#12;
  #86#13 = 0;

  |SI #87#2 = 12;
      nHay12 = 1;
      #86#11 = (#86#10 % #86#6) ! 2;
      #86#13 = #86#11 - #86#12;
      #86#14 = #86#10 - #86#11;
  |FINSI;

  |GRABA 020#86a;
  |LIBERA #86;

  |SI #87#37 ! 0; |O #87#38 ! 0;
      #86#0 = #87#0;
      #86#1 = #87#1;
      #86#2 = 00;     ||Actividad  comun
      |LEE 141#86=;
      |SI FSalida ! 0;
          |DDEFECTO #86;
          #86#0 = #87#0;
          #86#1 = #87#1;
          #86#2 = 00;

          |HAZ Datos86;
          |GRABA 020#86b;
      |FINSI;
      #86#10 = #86#10 + #87#37;
      #86#11 = #86#11 + #87#38;
      #86#12 = #86#12 + #87#38;
      #86#14 = #86#10 - #86#12;
      #86#13 = 0;
      |SI #87#2 = 12;
          nHay12 = 1;
          #86#11 = (#86#10 % #86#6) ! 2;
          #86#13 = #86#11 - #86#12;
          #86#14 = #86#10 - #86#11;
      |FINSI;

      |GRABA 020#86a;
      |LIBERA #86;
  |FINSI;
|FPRC;

|DEFBUCLE Dsmom087;
   #87#1;
   ;
   #85#0, #85#1, nPeriodo, nModelo, nComplem, 00, 0, 00;
   #85#0, #85#1, nPeriodo, nModelo, nComplem, 99, 9, 99;
   e;
   NULL, Dsmom087;
|FIN;

|PROCESO MiroModelo_85;
        nComplem = -1;
        #87#0 = #85#0;
        #87#1 = #85#1;
        #87#2 = nPeriodo;
        #87#3 = nModelo;
        #87#4 = 99;
        #87#5 = 0;
        #87#6 = 0;
        #87#7 = 0;
        |LEE 040#87];
        |SI FSalida = 0;
            |LEE 040#87a;
        |SINO;
            |LEE 040#87u;
        |FINSI;
        |SI FSalida = 0; |Y #87#0 = #85#0; |Y #87#1 = #85#1;
            |Y #87#2 = nPeriodo; |Y #87#3 = nModelo;
               nComplem = #87#4;
        |FINSI;
        |SI nComplem ! -1;
            |CIERRA #87;
            |BUCLE Dsmom087;
            |ABRE #87;
        |FINSI;
|FPRC;

|PROCESO Actuam086;
   |SI nSwOp = 0;
       |PDEFECTO #86, 10, 15;
       |GRABA 020#86a;
   |SINO;
      |SI nHay12 = 1;
          #86#11 = (#86#10 % #86#6) ! 2;
          #86#13 = #86#11 - #86#12;
          #86#14 = #86#10 - #86#11;
          |GRABA 020#86a;
       |FINSI;
       #85#9  = #85#9  + #86#10;
       #85#10 = #85#10 + #86#11;
       #85#11 = #85#11 + #86#12;
       #85#12 = #85#12 + #86#13;
       #85#13 = #85#9 - #85#10;
   |FINSI;
   |LIBERA #86;
|FPRC;

|DEFBUCLE Actuam086;
   #86#1;
   ;
   enEmpresa, enEjer, 00;
   enEmpresa, enEjer, 99;
   be;
   NULL, Actuam086;
|FIN;

|PROCESO Actualizam085;

    |ABRE #85;
    #85#0 = enEmpresa;
    #85#1 = enEjer;
    |LEE 141#85=;
    |SI FSalida ! 0;
        |DDEFECTO #85;
        #85#0 = enEmpresa;
        #85#1 = enEjer;
        |GRABA 020#85b;
    |FINSI;
    nSwOp = 0; |BUCLE Actuam086;

    nHay12 = 0;
    |ABRE #86;
    |ABRE #87;
    |PARA nPeriodo = 1; |SI nPeriodo [ 12; |HACIENDO nPeriodo = nPeriodo + 1;
          nModelo = 303; |HAZ MiroModelo_85;
          nModelo = 322; |HAZ MiroModelo_85;
          nModelo = 370; |HAZ MiroModelo_85;
    |SIGUE;
    |CIERRA #87;
    |CIERRA #86;

    |PDEFECTO #85, 9, 14;
    nSwOp = 1; |BUCLE Actuam086;

    |GRABA 020#85a;
    |LIBERA #85;
    |CIERRA #85;
|FPRC;

|| ***********************************************************
|PROCESO LeeAnterior;
         |ABRE #27;
         #27#0 = enEmpresa;
         #27#1 = enEjer;
         |LEE 101#27=;
         |SI FSalida ! 0;
             |DDEFECTO #27;
             #27#0 = enEmpresa;
             #27#1 = enEjer;
             |GRABA 020#27b;
         |FINSI;
         |CIERRA #27;
         eaProrrat = "G";
         nProrrata = #27#2;
         |SI enPeriodo = 12; |O enPeriodo = 99; nProrrata = #27#3; |FINSI;
|FPRC;

|PROCESO epLeeEl80;

 |SI enEjer [ 2010;
    |ABRE #80;
    #80#0 = enEmpresa;
    #80#1 = enEjer;
    |LEE 040#80=;
    |SI FSalida ! 0;
        |DDEFECTO #80;
        #80#2 = "N"; #80#3 = 100;
        #80#4 = "N"; #80#5 = 100;
    |FINSI;
    |SI enPeriodo ! 12;
        eaProrrat = #80#2;
        nProrrata = #80#3; |SI eaProrrat = "E"; nProrrata = #80#31; |FINSI;
    |SINO;
        eaProrrat = #80#4;
        nProrrata = #80#5; |SI eaProrrat = "E"; nProrrata = #80#32; |FINSI;
    |FINSI;
    |CIERRA #80;
 |SINO;

    |ABRE #85;
    #85#0 = enEmpresa;
    #85#1 = enEjer;
    |LEE 040#85=;
    |SI FSalida ! 0;
        |DDEFECTO #85;
        #85#2 = "N";
        #85#4 = "N";
    |FINSI;
    |SI enPeriodo ! 12;
        eaProrrat = #85#2;
        nProrrata = #85#3; |SI eaProrrat = "E"; nProrrata = #85#16; |FINSI;
    |SINO;
        eaProrrat = #85#4;
        nProrrata = #85#5; |SI eaProrrat = "E"; nProrrata = #85#17; |FINSI;
    |FINSI;
    |CIERRA #85;
 |FINSI;
|FPRC;

|PROCESO Pongo0;
   enImpProrrata = 0; enImpProrrat1 = 0; enImpProrrat2 = 0;
   enImpProrrat3 = 0; enImpProrrat4 = 0; enImpProrrat5 = 0;
   enImpProrrat6 = 0; enImpProrrat7 = 0; enImpProrrat8 = 0;
   enImpProrrat36 = 0;
|FPRC;


|PROCESO epLeeEl82;
   nSwEx82 = 0;
   |HAZ Pongo0;

   |SI enEjer [ 2010;
       |ABRE #82;
       |DDEFECTO #82;
       #82#0 = enEmpresa;
       #82#1 = enEjer;
       #82#2 = enPeriodo;
       |LEE 001#82=;
       |SI FSalida ! 0;
           nSwEx82 = 1;
       |SINO;
           |SI enPeriodo ! 12; |O #82#1 ] 2009;
               |SI #82#30 = "S";
                   enImpProrrata = #82#6;
                   enImpProrrat1 = #82#23; enImpProrrat2 = #82#24;
                   enImpProrrat3 = #82#25; enImpProrrat4 = #82#26;
                   enImpProrrat5 = #82#27; enImpProrrat6 = #82#28;
                   enImpProrrat7 = #82#29; enImpProrrat8 = #82#57;
               |FINSI;
           |SINO;
               |SI #82#30 = "S";  || (Iva Total - Iva deducido) + (Iva Acum. - iva total hasta ultim.)
                   enImpProrrata = #82#3  - #82#5  + #82#31 - #82#47;
                   enImpProrrat1 = #82#9  - #82#16 + #82#32 - #82#48;
                   enImpProrrat2 = #82#10 - #82#17 + #82#33 - #82#49;
                   enImpProrrat3 = #82#11 - #82#18 + #82#34 - #82#50;
                   enImpProrrat4 = #82#12 - #82#19 + #82#35 - #82#51;
                   enImpProrrat5 = #82#13 - #82#20 + #82#36 - #82#52;
                   enImpProrrat6 = #82#14 - #82#21 + #82#37 - #82#53;
                   enImpProrrat7 = #82#15 - #82#22 + #82#38 - #82#54;
                   enImpProrrat8 = #82#55 - #82#56 + #82#58 - #82#60;
              |SINO;
                   enImpProrrata = #82#31 - #82#47;  ||sumar lo que no hemos dejado por ahi
                   enImpProrrat1 = #82#32 - #82#48;
                   enImpProrrat2 = #82#33 - #82#49;
                   enImpProrrat3 = #82#34 - #82#50;
                   enImpProrrat4 = #82#35 - #82#51;
                   enImpProrrat5 = #82#36 - #82#52;
                   enImpProrrat6 = #82#37 - #82#53;
                   enImpProrrat7 = #82#38 - #82#54;
                   enImpProrrat8 = #82#58 - #82#60;
              |FINSI;
          |FINSI;
      |FINSI;
      |CIERRA #82;
   |SINO;
      ||   |BUCLE LeeDsmom087;
   |FINSI;

   |SI enPeriodo = 12; |Y enEjer ] 2009;
       |SI enEjer [ 2010;
           |ABRE #80;
           |DDEFECTO #80;
           #80#0 = enEmpresa;
           #80#1 = enEjer;
           |LEE 040#80=;
           enImpProrrat36 = #80#45;
           |CIERRA #80;
       |SINO;
           enImpProrrat36 = #85#12;
       |FINSI;
   |FINSI;
|FPRC;

|PROCESO eLeeLaProrrata;  || IMPORTE DE PRORRATA

     |HAZ Pongo0;

     |SI enSwProrr = 2;
         eaProrrat = "N";
         nProrrata = 100;
         |ACABA;
     |FINSI;

     |SI enEjer < enEjerPro;

         |HAZ LeeAnterior;

     |SINO;

         |HAZ epLeeEl80;

         |SI eaProrrat ! "N";  || no procede prorrata

             |SI enEjer > 2010;
                 |HAZ Actualizam085;
             |FINSI;

             |HAZ epLeeEl82;

             |SI enEjer [ 2010;
                 |SI nSwEx82 = 1; |O #82#61 = "S"; |O #82#2 = 12;
                     |SI enTipoEntrada ! 3; |Y enTipoEntrada ! 97; |Y enTipoEntrada ! 99; |Y enEjer [ 2010;
                         enSinPantalla = 1;
                         |SUB_EJECUTA_NP "dsmozp81";
                         enSinPantalla = 0;
                         |HAZ epLeeEl82;
                     |FINSI;
                 |FINSI;
                 |SI nSwEx82 = 0;
                      nProrrata = #82#4;
                      |SI #82#30 = "N";  nProrrata = 100;  |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI nProrrata < 0;    nProrrata = 100;  |FINSI;
     |SI nProrrata > 100;  nProrrata = 100;  |FINSI;

|FPRC;

|PROCESO eLeeLaPro390;  || IMPORTE DE PRORRATA para 390

     |HAZ Pongo0;

     |SI enSwProrr = 2;
         eaProrrat = "G";
         nProrrata = 100;
         |ACABA;
     |FINSI;

     |SI enEjer < enEjerPro;
         |HAZ LeeAnterior;
     |SINO;
         |HAZ epLeeEl80;
         |SI eaProrrat ! "N";
             |HAZ epLeeEl82;
         |FINSI;
     |FINSI;
     |SI nProrrata < 0;    nProrrata = 100;  |FINSI;
     |SI nProrrata > 100;  nProrrata = 100;  |FINSI;
|FPRC;

|| .............. Proceso para Avisos en Pantalla dsmom004

|PROCESO eLaProrrata;   ||Prorrata aplicada

     |HAZ LeeCtrlProrr;
     |SI enSwProrr = 2; |ACABA; |FINSI;

     enSwSeguir   = 0;

     |SI enEjer < enEjerPro;   ||Calculo de siempre

         |HAZ LeeAnterior;
         eaProrrat = "G";
         nProrrata = #27#2; |SI enPeriodo = 12; nProrrata = #27#3; |FINSI;
         |SI enSwProrr = 1; |Y nProrrata ! 100;
             aAlfa1 = nProrrata;
             aAlfa1 ="    SEmpresa con Prorrata de IVA = " + aAlfa1 + "%.  Aplicar S/N";
             |CONFI aAlfa1;
             |SI FSalida ! 0;
                 nProrrata = 100;
              ||   |CONFI "    NRegularizar prorrata aplicada anteriormente";
              ||   |SI FSalida = 0;
              ||        enSwSeguir = 2;
              ||    |FINSI;
             |FINSI;
         |FINSI;

         |SI enPeriodo ! 12;
             |ABRE #27;
             #27#0 = enEmpresa;
             #27#1 = enEjer;
             |LEE 101#27=;
             |SI FSalida ! 0;
                 |DDEFECTO #27;
                 #27#0 = enEmpresa;
                 #27#1 = enEjer;
                 |GRABA 020#27b;
             |FINSI;
             #27#42 = #27#2;
             #27#2  = nProrrata;
             |GRABA 020#27a;
             |CIERRA #27;
         |FINSI;

    |SINO;

         nCalcul = 0;
         |SI enPeriodo = 12;
             |SI enEjer [ 2010;   || a partir del 2010 el calculo se hace
                                  || desde los datos informados en el modelo
                 enSinPantalla = 3;
                 |SI eaPanPro = "N"; enSinPantalla = 2; |FINSI;
                 |SUB_EJECUTA_NP "dsmozp80";
                 enSinPantalla = 0;
             |FINSI;
         |FINSI;

         |HAZ epLeeEl80;

         |SI eaProrrat ! "N";
             |HAZ epLeeEl82;
             nDigo = 0;
             |SI eaProrrat = "E"; nDigo = 1; |FINSI;
             |SI eaProrrat = "G"; |Y nProrrata ! 100; nDigo = 1; |FINSI;
             |SI eaProrrat = "E"; |Y nProrrata = 100; nDigo = 0; |FINSI;
             |SI nDigo = 1;
                 aAlfa1 = nProrrata;
                 |SI eaProrrat = "G";
                     aAlfa1 = "Empresa de Prorrata General con " + aAlfa1 + " de deduccion";
                 |SINO;
                     aAlfa1 = "Empresa de Prorrata Especial, con " + aAlfa1 + "% de deduccion por actividad";
                 |FINSI;
                 aAlfa1 = "0000S" + aAlfa1 + ". Continuar S/N";
                 |CONFI aAlfa1;
                 |SI FSalida ! 0;
                     enSwSeguir = 1;
                     |MENAV "    No siga con el Proceso y Consulte El Calculo de Prorrata";
                 |FINSI;
             |FINSI;
         |FINSI;
    |FINSI;
|FPRC;

|PROCESO eLaPrescripcion;  || la prescripcion y la regularizacion manual
     enSwSeguir = 0;
     |ABRE #28;
     #28#0 = enEmpresa;
     #28#1 = enEjer;
     #28#2 = enPeriodo;
     #28#3 = enModelo;
     #28#4 = enComplem;
     #28#5 = 0;
     |LEE 040#28=;
     |SI FSalida ! 0;  |DDEFECTO #28;  |FINSI;
     |CIERRA #28;

     |SI #28#7 ! "N";  |Y #28#6 ! 0;
          aAlfa1 = #28#6;
          aAlfa1 = "Esta Empresa tiene Prescripcion de IVA, Importe " + aAlfa1;
          aAlfa1 = "0000S" + aAlfa1 + ". Continuar S/N";
          |CONFI aAlfa1;
          |SI FSalida ! 0;
              enSwSeguir = 1;
              |MENAV "    No siga con el Proceso  y  Consulte El Calculo de Prescripcion";
              |ACABA;
          |FINSI;
     |FINSI;

     enSwSeguir = 0;
     |ABRE #47;
     #47#0 = enEmpresa;
     #47#1 = enEjer;
     #47#2 = enPeriodo;
     #47#3 = enModelo;
     #47#4 = enComplem;
     #47#5 = 0;
     |LEE 040#47=;
     |SI FSalida ! 0;  |DDEFECTO #47;  |FINSI;
     |CIERRA #47;

     |SI #47#6 = 0; |Y #47#7 = 0; |Y #47#8 = 0; |Y #47#9 = 0; |Y #47#10 = 0;
         |Y #47#11 = 0; |Y #47#12 = 0; |Y #47#13 = 0;
         |ACABA;
     |FINSI;

     aAlfa1 = #47#14;
     aAlfa1 = "Esta Empresa tiene Regularizacion Manual de IVA, Importe " + aAlfa1;
     aAlfa1 = "0000S" + aAlfa1 + ". Continuar S/N";
     |CONFI aAlfa1;
     |SI FSalida ! 0;
         enSwSeguir = 1;
         |MENAV "    No siga con el Proceso  y  Consulte la Regularizacion Manual ";
     |FINSI;
|FPRC;

|| =========================================================================
|| ..................... Procesos hasta 2004
|PROCESO eLaProrrFin;

     |HAZ LeeCtrlProrr;
     |SI enSwProrr ! 1; |ACABA; |FINSI;
     |SI enEjer ] enEjerPro; |ACABA; |FINSI;

     |ABRE #27;
     #27#0 = enEmpresa;
     #27#1 = enEjer;
     |LEE 101#27=;
     |SI FSalida = 0;
         #27#2 = #27#42;
         |GRABA 020#27a;
     |FINSI;
     |LIBERA #27;
     |CIERRA #27;
|FPRC;

|PROCESO eVeoPrAplicada;

  |SI enEjer < enEjerPro;

      enNPro2   = 100;

      eaNomDef  = "";

      |SI enModelo = 300; eaNomDef = "dsmod300"; |FINSI;
      |SI enModelo ] 310; |Y enModelo [ 319; enModelo = 310; eaNomDef = "dsmod310"; |FINSI;
      |SI enModelo = 320; eaNomDef = "dsmod320"; |FINSI;
      |SI enModelo = 330; eaNomDef = "dsmod330"; |FINSI;
      |SI enModelo = 332; eaNomDef = "dsmod332"; |FINSI;
      |SI enModelo = 370; eaNomDef = "dsmod370"; |FINSI;
      |SI eaNomDef = ""; |ACABA; |FINSI;

      |DBASE aPathModelo;  |QBT aPathModelo;
      aDef = aPathModelo + "def/" + eaNomDef + ".mas";
      |CARGA_DEF aDef, program@;
      |SI FSalida ! 0;
          aAlfa = "     Error en cargar el Def " + eaNomDef;
          |MENAV aAlfa;
          |ACABA;
      |FINSI;

      |ABRE #777;
      #777#0 = enEmpresa;
      #777#1 = enEjer;
      #777#2 = enPerPro;
      #777#3 = enModelo;
      #777#4 = enComplem;
      #777#5 = 00;
      |LEE 000#777=;
      |SI FSalida ! 0;
          |CIERRA #777;
          |DESCARGA_DEF #program@;
          |ACABA;
      |FINSI;

      |SI enModelo = 300;   enNPro2  = #777#66; |FINSI;
      |SI enModelo = 320;   enNPro2  = #777#68; |FINSI;
      |SI enModelo = 330;   |O enModelo = 332;  enNPro2  = #777#70; |FINSI;
      |SI enModelo = 370;   |O enModelo = 371;  enNPro2  = #777#87; |FINSI;

      |CIERRA #777;
      |DESCARGA_DEF #program@;

      |SI enNPro2 [ 0;   enNPro2 = 100; |FINSI;
      |SI enNPro2 > 100; enNPro2 = 100; |FINSI;
      |SI enNPro1 [ 0; |O enNPro1 > 100; enNPro1 = 100; |FINSI;
  |FINSI;
|FPRC;

|PROCESO ChequeaSituaPro;
     enSwSeguir = 1;
|FPRC;

|DEFBUCLE dsmom008Pro;
     #8#1;
     13;
     #4#0, #4#1, #4#2, #4#3, #4#4, 00, "S";
     #4#0, #4#1, #4#2, #4#3, #4#4, 99, "S";
     ;
     NULL, ChequeaSituaPro;
|FIN;

|PROCESO ChequeaProrrata;   ||vale

     |HAZ LeeCtrlProrr;
     |SI enSwProrr = 2; |ACABA; |FINSI;

     enSwSeguir = 0;
     |SI #4#2 = 12; |O #4#1 ] enEjerPro; |ACABA; |FINSI;

     |BUCLE dsmom008Pro;
     |SI enSwSeguir = 1;
         |CONFI "    NCalculado por regularizacion de Prorratas. Continuar S/N";
         |SI FSalida = 0;
             |CONFI "    NEsta Seguro S/N";
             |SI FSalida = 0;
                 enSwSeguir = 0;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO SumaRestoPr;
  nCanti10 = #165#10 + nCanti10; nCanti12 = #165#12 + nCanti12;
  nCanti13 = #165#13 + nCanti13; nCanti15 = #165#15 + nCanti15;
  nCanti16 = #165#16 + nCanti16; nCanti18 = #165#18 + nCanti18;
  nCanti19 = #165#19 + nCanti19; nCanti21 = #165#21 + nCanti21;
|FPRC;

|DEFBUCLE SumaRestoPr;
 #165#1;
 ;
 enEmpresa, enEjer, enPeriodo, enModelo, enComplem, enActividad, 2, 01;
 enEmpresa, enEjer, enPeriodo, enModelo, enComplem, enActividad, 2, 09;
 ;
 NULL, SumaRestoPr;
|FIN;

|PROCESO GraboRestoPror;

      |SI enEjer ] enEjerPro; |ACABA; |FINSI;

      |DDEFECTO #8;
      |ABRE #8;
      #8#0 = enEmpresa;
      #8#1 = enEjer;
      #8#2 = enPeriodo;
      #8#3 = enModelo;
      #8#4 = enComplem;
      #8#5 = enActividad;
      |LEE 101#8=;
      |SI FSalida = 0;
          #8#13 = "S";
          |GRABA 020#8a;
      |FINSI;
      |LIBERA #8;
      |CIERRA #8;

       nCanti10 = 0; nCanti12 = 0;
       nCanti13 = 0; nCanti15 = 0;
       nCanti16 = 0; nCanti18 = 0;
       nCanti19 = 0; nCanti21 = 0;
       |BUCLE SumaRestoPr;

       |ABRE #165;
       #165#0 = enEmpresa;
       #165#1 = enEjer;
       #165#2 = enPeriodo;
       #165#3 = enModelo;
       #165#4 = enComplem;
       #165#5 = enActividad;
       #165#6 = 2;
       #165#7 = 10;
       |ABRE #165;
       |LEE 101#165=;
       |SI FSalida ! 0;
          |DDEFECTO #165;
          #165#0 = enEmpresa;
          #165#1 = enEjer;
          #165#2 = enPeriodo;
          #165#3 = enModelo;
          #165#4 = enComplem;
          #165#5 = enActividad;
          #165#6 = 2;
          #165#7 = 10;
          |GRABA 020#165b;
       |FINSI;

       #165#10 = nCanti10; #165#12 = nCanti12;
       #165#13 = nCanti13; #165#15 = nCanti15;
       #165#16 = nCanti16; #165#18 = nCanti18;
       #165#19 = nCanti19; #165#21 = nCanti21;

       #165#8 = #165#10 + #165#13 + #165#16 + #165#19;
       #165#9 = #165#12 + #165#15 + #165#18 + #165#21;

       |GRABA 020#165a;
       |LIBERA #165;

       |ABRE #165;
       #165#0 = enEmpresa;
       #165#1 = enEjer;
       #165#2 = enPeriodo;
       #165#3 = enModelo;
       #165#4 = enComplem;
       #165#5 = enActividad;
       #165#6 = 2;
       #165#7 = 12;
       |ABRE #165;
       |LEE 101#165=;
       |SI FSalida ! 0;
          |DDEFECTO #165;
          #165#0 = enEmpresa;
          #165#1 = enEjer;
          #165#2 = enPeriodo;
          #165#3 = enModelo;
          #165#4 = enComplem;
          #165#5 = enActividad;
          #165#6 = 2;
          #165#7 = 12;
          |GRABA 020#165b;
       |FINSI;

       #165#10 = nCanti10; #165#12 = nCanti12;
       #165#13 = nCanti13; #165#15 = nCanti15;
       #165#16 = nCanti16; #165#18 = nCanti18;
       #165#19 = nCanti19; #165#21 = nCanti21;

       #165#8 = #165#10 + #165#13 + #165#16 + #165#19;
       #165#9 = #165#12 + #165#15 + #165#18 + #165#21;

       |GRABA 020#165a;
       |LIBERA #165;

       |CIERRA #165;
|FPRC;
||===========================================================================

||... Para lee el iva comun

|PROCESO eLeeElModelo;
 |SI #2#8 > "01.01.0000";
     |SI #2#8 > efFecFin;  |ACABA;  |FINSI;
 |FINSI;
 |SI #2#9 > "01.01.0000";
     |SI #2#9 < efFecIni;  |ACABA;  |FINSI;
 |FINSI;
 |SI #2#2 = 300; |O #2#2 = 320; |O #2#2 = 330; |O #2#2 = 332;
    |O #2#2 = 310; |O #2#2 = 311; |O #2#2 = 370; |O #2#2 = 303;
      |O #2#2 = 322;
       enSwTipoAct = 1;
       |ERROR10;
 |FINSI;
|FPRC;

|DEFBUCLE eLeeElModelo;
  #2#1;
  ;
  enEmpresa, enActividad, 300;
  enEmpresa, enActividad, 371;
  ;
  NULL, eLeeElModelo;
|FIN;

|PROCESO eTipoEmpModelo;
  enSwTipoAct = 0;
  |BUCLE eLeeElModelo;
|FPRC;

|PROCESO MiraElM86;
    |ABRE #86;
    #86#0 = enEmpresa;
    #86#1 = enEjer;
    #86#2 = #114#1;
    |LEE 041#86=;
    |SI FSalida = 0;
        |SI #86#16 = "P";
            enActPrinci = #114#1;
        |FINSI;
    |FINSI;
    |CIERRA #86;
|FPRC;

|PROCESO eTipoEmpresa;
  enSwTipoAct = 0;
  enActividad = #114#1;
  |BUCLE eLeeElModelo;
  |SI enSwTipoAct = 1;
      |SI enActPrinci = 0; enActPrinci = #114#1; |FINSI;
      |HAZ MiraElM86;
  |SINO;
      enIvaComun = 1;
  |FINSI;
|FPRC;

|DEFBUCLE Leeagicen14;
 #114#1;
 ;
 enEmpresa, 01;
 enEmpresa, 99;
 e;
 NULL, eTipoEmpresa;
|FIN;

|PROCESO eLaActivPrin;
  enIvaComun  = 0;
  enActPrinci = 0;
  |BUCLE Leeagicen14;
|FPRC;
