|FICHEROS;
     dsmoy000;
     dsmom004;
     dsmom107;

     dsmod131;

     dsmow014;
     t1513101;

     &clientes@;
     &datosper@;
|FIN;

|VARIABLES;
     nImporte = 0;
|FIN;

|INCLUYE i_varemi;

|PROCESO PresentaModelo_02;
     |SI eaOpcion = "1";
         eaNIF = #t1513101#7;
         |HAZ PortalPDFPeriodicos;

         |HAZ GrabaImpreso;
     |FINSI;

     |SI eaOpcion = "3";
         eaFOrigen  = eaPathEmision  + eaFicheroPlano;
         eaFDestino = eaPathInternet + eaFicheroPlano;
         |HAZ CopiaFichero;

         |HAZ GrabaImpreso;
     |FINSI;

     |SI eaOpcion = "6";
         eaX002_10    = #t1513101#7;
         eaX002_11    = #t1513101#8;
         eaX002_12    = #t1513101#2;
         eaX002_13    = #t1513101#10;
         eaX002_14    = #t1513101#11;

         |SI #dsmod131#4 > 0;
             eaX002_15 = "C";
             eaX002_16 = #t1513101#49;
         |FINSI;

         eaX002_17 = #dsmod131#33;
         eaX002_18 = #t1513101#6;
         eaX002_19 = #t1513101#47;
         eaX002_48 = eaNomEnt;

         |HAZ PresentaPortal;
     |FINSI;
|FPRC;

|PROCESO AbrePagina;
     eaPathAEAT = eaUnidadBasico + "\AEAT";        |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\" + #dsmoy000#0;  |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\" + #dsmoy000#6;  |RMKDIR eaPathAEAT;
     |SI #dsmoy000#4 ! 99;
         eaPathAEAT = eaPathAEAT + "\" + (("00" + #dsmoy000#4) % -102);  |RMKDIR eaPathAEAT;
     |FINSI;
     eaPathAEAT = eaPathAEAT + "\";

     eaFOrigen  = eaPathEmision  + eaFicheroPlano;
     eaFDestino = eaPathAEAT + eaFicheroPlano;
     |HAZ CopiaFichero;

     aAlfa       = eaPathLanza;
     eaPathLanza = eaPathAEAT;
     |HAZ TraeSoloWait;
     eaPathLanza = aAlfa;

     eaForzExplorador = "N";
     |HAZ Explorador;

     aAbre = eaPathAEAT + "imp" + Usuario + ".bat";
     |XABRE "WBC", aAbre, enHandlePortal;

     eaAlfa = eaPathAEAT + "wait ";
     |HAZ GrabaPortalSin;

     eaAlfa = eaPathExplorador + " " + &34;
     |HAZ GrabaPortalSin;

     eaAlfa = "https://www1.agenciatributaria.gob.es/es13/h/ie51150a.html";
     |HAZ GrabaPortalSin;

     |XCIERRA enHandlePortal;

     |RSYSTEM aAbre;

     aAlfa = eaPathExplorador > "";
     aAlfa = aAlfa - "CHROME.EXE";
     |SI FSalida ! 0;  |SLEEP 30;  |FINSI;

     aAlfa = eaPathAEAT + aFichero;
     |RFBORRA aAlfa;
     |RFBORRA aAbre;
|FPRC;

|PROCESO TDeclaracion2015;
     enModelo = 131;  enForzar = 1;  |HAZ CogeDatosBancos;

     |SI #dsmod131#33 > 0;
                                 #t1513101#6 = "I";
         |SI eaFormaPago = "3";  #t1513101#6 = "U";  |FINSI;
         |SI eaFormaPago = "6";  #t1513101#6 = "G";  |FINSI;

         #t1513101#47 = eaIBAN;
     |SINO;
         #t1513101#6 = "N";
         |SI #dsmod131#33 ! 0;
             |SI #dsmod131#2 ! 12;  #t1513101#6 = "B";  |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO PersonaFis2015;
     aAlfa = eaVarDni % 101;
     |SI aAlfa = "0"; |O aAlfa = "1"; |O aAlfa = "2"; |O aAlfa = "3";
      |O aAlfa = "4"; |O aAlfa = "5"; |O aAlfa = "6"; |O aAlfa = "7";
      |O aAlfa = "8"; |O aAlfa = "9"; |O aAlfa = "X"; |O aAlfa = "Y";
      |O aAlfa = "Z";
         eaAlfa = #clientes@#1;     |HAZ BuscaNombre;
         eaAlfa = eaAlfa1;    |HAZ QuitaRaros;     #t1513101#8   = eaAlfa;
         eaAlfa = eaAlfa2;    |HAZ QuitaRaros;     #t1513101#9   = (eaAlfa % 115);
      |SINO;
         eaAlfa   = #clientes@#1;    |HAZ QuitaRaros;    #t1513101#8   = eaAlfa;
                                                         #t1513101#9   = " ";
      |FINSI;
|FPRC;

|PROCESO Carga131_2015;
     enCodCli = #dsmod131#0;
     |HAZ LeePersona;

     |DDEFECTO #t1513101;

     |SI enSwDeDonde = 1;
         eaVarDni = #clientes@#3;  |HAZ CalculameDNI;   #t1513101#7  = eaVarDni;

         aAlfa1   = #datosper@#2;  |QBT aAlfa1;
         |SI aAlfa1 ! "";
             eaAlfa = #datosper@#2;  |HAZ QuitaRaros;  aAlfa1 = eaAlfa;  |QBF aAlfa1;
             eaAlfa = #datosper@#3;  |HAZ QuitaRaros;  aAlfa2 = eaAlfa;  |QBF aAlfa2;
             #t1513101#8 = aAlfa1 + " " + aAlfa2;

             eaAlfa = #datosper@#4;  |HAZ QuitaRaros;
             #t1513101#9 = (eaAlfa % 115);
         |SINO;
             |HAZ PersonaFis2015;
         |FINSI;
     |SINO;
         eaVarDni = #clientes@#13;  |HAZ CalculameDNI;   #t1513101#7   = eaVarDni;
         |HAZ PersonaFis2015;
     |FINSI;

     #t1513101#10  = #dsmod131#1;

     |SI #dsmod131#2 = 3;   #t1513101#11 = "1T";  |FINSI;
     |SI #dsmod131#2 = 6;   #t1513101#11 = "2T";  |FINSI;
     |SI #dsmod131#2 = 9;   #t1513101#11 = "3T";  |FINSI;
     |SI #dsmod131#2 = 12;  #t1513101#11 = "4T";  |FINSI;

     #dsmod131#43 = 0;
     #t1513101#12 = #dsmod131#6;
     |SI #dsmod131#9 ! 0;
         enNume  = #dsmod131#7;   |HAZ Conver17;  #t1513101#13 = eaAlfa;
         nNume   = #dsmod131#8  * 100; aAlfa = ("00000" + nNume) % -105;
         #t1513101#14 = aAlfa;
         enNume  = #dsmod131#9;   |HAZ Conver17;  #t1513101#15 = eaAlfa;
         #dsmod131#43 = #dsmod131#43 + #dsmod131#7;
     |FINSI;

     #t1513101#16 = #dsmod131#10;
     |SI #dsmod131#13 ! 0;
         enNume  = #dsmod131#11;  |HAZ Conver17;  #t1513101#17 = eaAlfa;
         nNume   = #dsmod131#12  * 100; aAlfa = ("00000" + nNume) % -105;
         #t1513101#18 = aAlfa;
         enNume  = #dsmod131#13;  |HAZ Conver17;  #t1513101#19 = eaAlfa;
         #dsmod131#43 = #dsmod131#43 + #dsmod131#11;
     |FINSI;

     #t1513101#20 = #dsmod131#14;
     |SI #dsmod131#17 ! 0;
         enNume  = #dsmod131#15;  |HAZ Conver17;  #t1513101#21 = eaAlfa;
         nNume   = #dsmod131#16  * 100; aAlfa = ("00000" + nNume) % -105;
         #t1513101#22 = aAlfa;
         enNume  = #dsmod131#17;  |HAZ Conver17;  #t1513101#23 = eaAlfa;
         #dsmod131#43 = #dsmod131#43 + #dsmod131#15;
     |FINSI;

     #t1513101#24 = #dsmod131#18;
     |SI #dsmod131#21 ! 0;
         enNume  = #dsmod131#19;  |HAZ Conver17;  #t1513101#25 = eaAlfa;
         nNume   = #dsmod131#20  * 100; aAlfa = ("00000" + nNume) % -105;
         #t1513101#26 = aAlfa;
         enNume  = #dsmod131#21;  |HAZ Conver17;  #t1513101#27 = eaAlfa;
         #dsmod131#43 = #dsmod131#43 + #dsmod131#19;
     |FINSI;

     #t1513101#28 = #dsmod131#22;
     |SI #dsmod131#25 ! 0;
         enNume  = #dsmod131#23;  |HAZ Conver17;  #t1513101#29 = eaAlfa;
         nNume   = #dsmod131#24  * 100; aAlfa = ("00000" + nNume) % -105;
         #t1513101#30 = aAlfa;
         enNume  = #dsmod131#25;  |HAZ Conver17;  #t1513101#31 = eaAlfa;
         #dsmod131#43 = #dsmod131#43 + #dsmod131#23;
     |FINSI;
||      #dsmod131#43 = #dsmod131#7  + #dsmod131#11 + #dsmod131#15 + #dsmod131#19 + #dsmod131#23;

     enNume = #dsmod131#43;  |HAZ Conver17;  #t1513101#32 = eaAlfa;
     enNume = #dsmod131#26;  |HAZ Conver17;  #t1513101#33 = eaAlfa;
     enNume = #dsmod131#34;  |HAZ Conver17;  #t1513101#34 = eaAlfa;
     enNume = #dsmod131#35;  |HAZ Conver17;  #t1513101#35 = eaAlfa;
     enNume = #dsmod131#29;  |HAZ Conver17;  #t1513101#36 = eaAlfa;
     enNume = #dsmod131#30;  |HAZ Conver17;  #t1513101#37 = eaAlfa;
     enNume = #dsmod131#36;  |HAZ Conver17;  #t1513101#38 = eaAlfa;
     enNume = #dsmod131#37;  |HAZ Conver17;  #t1513101#39 = eaAlfa;
     enNume = #dsmod131#42;  |HAZ Conver17;  #t1513101#40 = eaAlfa;  ||campo minoracion

     enNume = #dsmod131#38;  |HAZ Conver17;  #t1513101#41 = eaAlfa;
     enNume = #dsmod131#39;  |HAZ Conver17;  #t1513101#42 = eaAlfa;
     enNume = #dsmod131#44;  |HAZ Conver17;  #t1513101#43 = eaAlfa;
     enNume = #dsmod131#40;  |HAZ Conver17;  #t1513101#44 = eaAlfa;
     enNume = #dsmod131#41;  |HAZ Conver17;  #t1513101#45 = eaAlfa;
     enNume = #dsmod131#33;  |HAZ Conver17;  #t1513101#46 = eaAlfa;

     |HAZ TDeclaracion2015;

     |SI #dsmod131#4 > 0;
         #t1513101#48 = "X";
         #t1513101#49 = #dsmom004#21;
     |FINSI;

     #t1513101#53 = &13 + &10;

     aAlfa = "<T1310" + #t1513101#10 + #t1513101#11 + "0000>";  |XGRABA nHandle2, aAlfa;
     aAlfa = "<AUX>";                                           |XGRABA nHandle2, aAlfa;
     aAlfa = " " * 70;                                          |XGRABA nHandle2, aAlfa;
     aAlfa = eaVersMod;                                         |XGRABA nHandle2, aAlfa;
     aAlfa = " " * 4;                                           |XGRABA nHandle2, aAlfa;
     aAlfa = eaNIFDs;                                           |XGRABA nHandle2, aAlfa;
     aAlfa = " " * 213;                                         |XGRABA nHandle2, aAlfa;
     aAlfa = "</AUX>";                                          |XGRABA nHandle2, aAlfa;

     |PARA nCampo = 1;  |SI nCampo [ 52;  |HACIENDO nCampo = nCampo + 1;
           aAlfa = #t1513101#nCampo#;
           |XGRABA nHandle2, aAlfa;
     |SIGUE;

     aAlfa = "</T1310" + #t1513101#10 + #t1513101#11 + "0000>";  |XGRABA nHandle2, aAlfa;
|FPRC;

|PROCESO dsmow014_2015;
     |ABRE #dsmom004;
     #dsmom004#0  = #dsmow014#0;
     #dsmom004#1  = #dsmow014#1;
     #dsmom004#2  = #dsmow014#2;
     #dsmom004#3  = #dsmow014#5;
     #dsmom004#4  = #dsmow014#7;
     |LEE 040#dsmom004.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;
     |CIERRA #dsmom004;

     |ABRE #dsmod131;
     #dsmod131#0 = #dsmom004#0;
     #dsmod131#1 = #dsmom004#1;
     #dsmod131#2 = #dsmom004#2;
     #dsmod131#3 = #dsmom004#3;
     #dsmod131#4 = #dsmom004#4;
     #dsmod131#5 = 0;
     |LEE 040#dsmod131.=;
     |SI FSalida ! 0;  |CIERRA #dsmod131;  |ACABA;  |FINSI;
     |CIERRA #dsmod131;

     eaFicheroPlano = "131" + (("00000" + #dsmow014#0) % -105) + ".txt";
     eaFicheroImpre = "131" + (("00000" + #dsmow014#0) % -105) + ".pdf";
     eaFicheroError = "err" + (("00000" + #dsmow014#0) % -105) + ".txt";

     aAlfa = eaPathLanza + eaFicheroPlano;  |RFBORRA aAlfa;
     aAlfa = eaPathLanza + eaFicheroImpre;  |RFBORRA aAlfa;
     aAlfa = eaPathLanza + eaFicheroError;  |RFBORRA aAlfa;

     aAbre = eaPathEmision + eaFicheroPlano;
     |XABRE "BW", aAbre, nHandle2;

     |HAZ Carga131_2015;

     |XCIERRA nHandle2;

     enEmpresa    = #dsmow014#0;
     enComple     = #dsmow014#7;
     eaNomEmpresa = #dsmow014#3;

     |HAZ PresentaModelo_02;
|FPRC;

|DEFBUCLE dsmow014C_2015;
     #dsmow014#1;
     6;
     00000, 0000, 00, "S";
     99999, 9999, 99, "S";
     ;
     NULL, dsmow014_2015;
|FIN;

|DEFBUCLE dsmow014N_2015;
     #dsmow014#2;
     6;
     "                                        ", "S";
     "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz", "S";
     ;
     NULL, dsmow014_2015;
|FIN;

|PROCESO Bloque2015;
     |SI #dsmoy000#6 [ 2018;
         |HAZ BtnPeriodicas2015;
     |FINSI;

     |SI #dsmoy000#6 ] 2019;
         |HAZ BtnPeriodicas2019;
     |FINSI;
     nTecla = enTecla;

     |SI nTecla = 0;  |ACABA;  |FINSI;

     |SI eaOpcion = "1";
         |MENAV "0000La opcion de validacion no esta activada por hacienda.";
         |ACABA;
     |FINSI;

     nSwLee = 0;
     |SI #dsmoy000#8 = "C";
         |BUCLE dsmow014C_2015;
     |SINO;
         |BUCLE dsmow014N_2015;
     |FINSI;

     |SI eaOpcion = "1";
         |HAZ SacaErrorPtl;
     |FINSI;

     |SI eaOpcion = "3";
         aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
         |MENAV aAlfa;

         |SI #dsmoy000#6 [ 2018;
             |CONFI "0000SQuiere cargar la pagina de hacienda del modelo";
             |SI FSalida = 0;
                 |HAZ AbrePagina;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI enDirecta = 1;  |Y enMsv = 1;  |Y enParar = 0;
         |SUB_EJECUTA "|dsmox007";
     |FINSI;
|FPRC;

|PROCESO moy13102;
     |ABRE #dsmom107;
     |LEE 040#dsmom107.p;
     |SI FSalida ! 0;
         |CIERRA #dsmom107;
         |SUB_EJECUTA_NP "dsmom107";
         |ABRE #dsmom107;
     |FINSI;

     |LEE 040#dsmom107.p;
     |SI FSalida ! 0;  |DDEFECTO #dsmom107;  |FINSI;
     |CIERRA #dsmom107;

     enCambiaMoneda = 1;
     enSwTrata      = 0;

     |HAZ Bloque2015;
|FPRC;
