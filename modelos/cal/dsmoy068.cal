|FICHEROS;
     dsmoy068;

     dsmow168;      || Temporal recogida de datos
     dsmod110;      || Mantenimiento impresion modelo 110
     dsmom026;      || grupos de empresas

     dsmoc111;      || registros 110
     dsm11101;      || registros 110 2016

     :/laboral/def/nomhicca;
     :/laboral/def/nomhiatr;
     :/laboral/def/labempre;
     :/laboral/def/labtraba;
     :/laboral/def/nomcontr;

     :/integral/def/dsam0000;
|FIN;

|VARIABLES;
   nDEmpresa = 0;
   nHEmpresa = 0;

   nDPeriodo = 0;
   nHPeriodo = 0;
   nDAnyo = 0;
   nHAnyo = 0;

   nCalc = 0;
   nAnyo = 0;

   aAlfa = "";
     nMes    = 0;
     nEjer   = 0;
     nTipoRel   = 0;
     nTrimestre = 0;
     swSigue = 0;
     nAnt00 = 0;
     nAnt01 = 0;
     nAnt02 = 0;
     nAnt03 = 0;
     nAnt04 = 0;
     nAnt05 = 0;
     nAnt07 = 0;
     nAnt08 = 0;
     nAnt10 = 0;
     nAnt11 = 0;
     nMadre = 0;
     nDesdeMes = 0;
     nHastaMes = 0;
     nBisiesto = 0;
     nNume = 0;
     nAny = 0;
     nAnyAnterior = 0;
     nTopemes = 0;
     FEstado = 0;
     aNif = "";
     nDesdeEmp = 0;
     nHastaEmp = 0;
     nDesdePer = 0;
     nHastaPer = 0;
     swBorrado = 0;
     swHayNomina = 0;
     swHayAtrasos = 0;
     nEmp = 0;
     nTra = 0;
     aAlfa1 = "";
     aAlfa2 = "";
     nTrab = 0;
     nTotal = 0;
     aAntNif = "";
     nDModelo = 0;
     nHModelo = 0;
     &eaTitulo = "";
   aPathLaboral = "";
   aBase        = "";
   nHandle      = 0;
|FIN;

|PROCESO Seleccion;
     |SI #dsmoy068#0 = "S";
          |C_M #dsmoy068#1, 1, "N"; |C_M #dsmoy068#2, 1, "N";
          |PARA nCalc = 3; |SI nCalc [ 22; |HACIENDO nCalc = nCalc + 1;
               |C_M #dsmoy068#nCalc#, 1, "S";
          |SIGUE;
          #dsmoy068#1 = 00000;
          |PINTA #dsmoy068#1;
          #dsmoy068#2 = 00000;
          |PINTA #dsmoy068#2;
     |SINO;
          |C_M #dsmoy068#1, 1, "S"; |C_M #dsmoy068#2, 1, "S";
          |PARA nCalc = 3; |SI nCalc [ 22; |HACIENDO nCalc = nCalc + 1;
               |C_M #dsmoy068#nCalc#, 1, "N";
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO Imprime;
     |PRINT;
|FPRC;

|DEFBUCLE Imprime;
     #dsmow168#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Imprime;
|FIN;

|PROCESO BuscaAtrasos;
     |ABRE #nomhiatr;
     #nomhiatr#0 = #labtraba#0;
     #nomhiatr#1 = #nomhicca#66 + 2000;
     #nomhiatr#2 = #nomhicca#3;
     #nomhiatr#3 = nEjer;
     |LEE 000#nomhiatr.=;
     |SI FSalida = 0;
          |SI #nomhiatr#4 = nMes;
               swHayAtrasos = 1;
          |FINSI;
     |FINSI;
     |CIERRA #nomhiatr;
     || FINSI;
|FPRC;

|DEFBUCLE BuscaAtrasos;
     #nomhicca#1;
     ;
     #labtraba#0, #labtraba#1, nAnyAnterior, 01, 5;
     #labtraba#0, #labtraba#1, nAny, 12, 20;
     ;
     NULL, BuscaAtrasos;
|FIN;

|PROCESO AtrasosTrab;
     |SI nTipoRel = #labtraba#111;
         |BUCLE BuscaAtrasos;
     |FINSI;
|FPRC;

|DEFBUCLE AtrasosTrab;
     #labtraba#5;
     ;
     nEmp, aNif;
     nEmp, aNif;
     ;
     NULL, AtrasosTrab;
|FIN;

|PROCESO dsmow168;
     |SI #dsmow168#3 = nTipoRel; |Y #dsmow168#4 = #labtraba#111;
          |BORRA 020#dsmow168.a;
          |LIBERA #dsmow168;
          swBorrado = 1;
     |FINSI;
|FPRC;

|DEFBUCLE dsmow168;
     #dsmow168#1;
     ;
     #labtraba#0, #labtraba#7, 00001, nEjer, nMes, 0, 0;
     #labtraba#0, #labtraba#7, 99999, nEjer, nMes, 3, 3;
     ;
     NULL, dsmow168;
|FIN;

|PROCESO BuscaOtro;
     |BUCLE dsmow168;
|FPRC;

|PROCESO GrabaTmp;
     swBorrado = 0;
     |HAZ BuscaOtro;
     |SI swBorrado = 1;
          || este trabajador tampoco debe salir obviamente, ver explicacion
          || del dsmow168
          |ACABA;
     |FINSI;

     |DDEFECTO #dsmow168;
     #dsmow168#1 = #labtraba#0;         || Empresa
     #dsmow168#0 = #labtraba#7;         || NIF
     #dsmow168#2 = #labtraba#1;         || Trabajador
     #dsmow168#8 = nEjer;               || A¤o
     #dsmow168#7 = nMes;                || Mes

     #dsmow168#3 = #labtraba#111;       || Sit. Laboral. labtraba
     #dsmow168#4 = nTipoRel;            || Sit. Laboral. 110

     |LEE 101#dsmow168.=;
     FEstado = FSalida;

     #labempre#0 = #labtraba#0;
     |LEE 000#labempre.=;

     #dsmow168#5 = #labempre#2;
     #dsmow168#6 = #labtraba#2;
     #dsmow168#7 = nMes;
     #dsmow168#8 = nEjer;

     |SI FEstado = 0;
          |GRABA 020#dsmow168.a;
     |SINO;
          |GRABA 020#dsmow168.n;
     |FINSI;

     |LIBERA #dsmow168;
|FPRC;

|PROCESO labtraba;
     swHayNomina  = 0;
     #nomhicca#0  = #labtraba#0;
     #nomhicca#1  = #labtraba#1;
     #nomhicca#66 = nEjer - 2000;
     #nomhicca#2  = nMes;
     #nomhicca#3  = 0;
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          swHayNomina = 1;
     |FINSI;

     swHayAtrasos = 0;
     nTra         = #labtraba#1;
     aNif         = #labtraba#7;

     |SALVA_FICHA #labtraba;
     |BUCLE AtrasosTrab;
     |REPON_FICHA #labtraba;

     |HAZ AtrasosTrab;

     |SI swHayNomina = 1;
          || tengo importes en el 110 y en el historico
          || compruebo la relacion laboral del 110 y de la ficha del trab.
          |SI nTipoRel ! #labtraba#111;
               |SI swHayAtrasos = 1;
                    || si el tipo de relacion es distinta pero existen
                    || nominas de atrasos es perfectamente posible que
                    || se deba a que los atrasos que se graban en el 110
                    || provienen de un trabajador que estuvo de alta con
                    || otro tipo de relacion en otro trimestre y se declaran
                    || en el mes que estoy buscando el modelo

                    || en este caso entiendo que no debo sacar el trabajador
                    || en el listado por ser normal el tipo de relacion
                    || laboral, tiquet 02884.02020

               |SINO;
                    || en caso de que no haya atrasos si que lo sacare

                    |HAZ GrabaTmp;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE labtraba;
     #labtraba#5;        || empresa, nif
     ;
     nEmp, aNif;
     nEmp, aNif;
     ;
     NULL, labtraba;
|FIN;

|PROCESO Mensaje;
     #labempre#0 = nEmp;
     |LEE 000#labempre.=;

     |ATRI R;
     |BLANCO 19182362;
     ||            2         3         4         5         6
     ||            01234567890123456789012345678901234567890
     |PINTA 2020, "        - Procesando informe -           ";
     aAlfa1 = #labempre#0; |QBF aAlfa1;
     aAlfa2 = #labempre#2;
     aAlfa1 = ("00000" + aAlfa1) % -105;
     aAlfa2 = aAlfa2 % 130;
     aAlfa = aAlfa1 + " - " + aAlfa2;
     |PINTA 2120, aAlfa;
     aAlfa1 = nTrab;
     aAlfa2 = nTotal;
     aAlfa = "    Trabajador/Per¡odo " + aAlfa1 + " de " + aAlfa2;
     |PINTA 2220, aAlfa;
     |ATRI 0;
|FPRC;

|PROCESO dsmoc111;
     |SI #dsmoc111#6 ! aAntNif;
          nTrab = nTrab + 1;
     |FINSI;

     aAntNif      = #dsmoc111#6;
     aNif         = #dsmoc111#6;
     nEmp         = #dsmoc111#0;
     nAny         = #dsmoc111#1 - 2000;
     nTipoRel     = #dsmoc111#11;
     nEjer        = #dsmoc111#1;
     nMes         = #dsmoc111#8;
     nAnyAnterior = nAny - 1;

     |HAZ Mensaje;

     |SI #dsmoc111#9 = "L";   || clave perceptora "L" no (tienen el tipo de
          |ACABA;             || relacion laboral a cero)
     |FINSI;

     |BUCLE labtraba;
|FPRC;

|DEFBUCLE dsmoc111;
     #dsmoc111#1;
     ;
     nDesdeEmp, #dsmoy068#25, 00, 110, 00, 01, "            ", 0000, #dsmoy068#27, " ", "  ", 0;
     nHastaEmp, #dsmoy068#25, 99, 110, 98, 98, "zzzzzzzzzzzz", 0000, #dsmoy068#28, "z", "zz", 4;
     ;
     NULL, dsmoc111;
|FIN;

|PROCESO dsmoc111_cuenta;
     |SI #dsmoc111#6 ! aAntNif;
          nTotal = nTotal + 1;
     |FINSI;
     aAntNif = #dsmoc111#6;
|FPRC;

|DEFBUCLE dsmoc111_cuenta;
     #dsmoc111#1;
     ;
     nDesdeEmp, #dsmoy068#25, 00, 110, 00, 01, "            ", 0000, #dsmoy068#27, " ", "  ", 0;
     nHastaEmp, #dsmoy068#25, 99, 110, 98, 98, "zzzzzzzzzzzz", 0000, #dsmoy068#28, "z", "zz", 4;
     ;
     NULL, dsmoc111_cuenta;
|FIN;

|PROCESO Version2015;
     |SI #dsmoy068#0 = "N";
         nDesdeEmp = #dsmoy068#1;
         nHastaEmp = #dsmoy068#2;

         |BUCLE dsmoc111_cuenta;
         |BUCLE dsmoc111;
     |SINO;
         |PARA nCalc = 3; |SI nCalc [ 22; |HACIENDO nCalc = nCalc + 1;
               nDesdeEmp = #dsmoy068#nCalc#;
               nHastaEmp = #dsmoy068#nCalc#;

               |BUCLE dsmoc111_cuenta;
         |SIGUE;

         |PARA nCalc = 3; |SI nCalc [ 22; |HACIENDO nCalc = nCalc + 1;
               nDesdeEmp = #dsmoy068#nCalc#;
               nHastaEmp = #dsmoy068#nCalc#;

               |BUCLE dsmoc111;
         |SIGUE;
     |FINSI;

     eaTitulo = "modelo 110/111";
     nDModelo = 111; nHModelo = 111;
     |SI #dsmoy068#25 < 2011;
         nDModelo = 110;
         nHModelo = 110;
     |FINSI;

     |SI nDModelo = nHModelo;
         |SI nDModelo = 111; eaTitulo = "modelo 111"; |FINSI;
         |SI nDModelo = 110; eaTitulo = "modelo 110"; |FINSI;
     |FINSI;
|FPRC;

|PROCESO dsm11101;
     |SI #dsm11101#6 ! aAntNif;
          nTrab = nTrab + 1;
     |FINSI;

     aAntNif      = #dsm11101#6;
     aNif         = #dsm11101#6;
     nEmp         = #dsm11101#0;
     nAny         = #dsm11101#1 - 2000;
     nTipoRel     = #dsm11101#11;
     nEjer        = #dsm11101#1;
     nMes         = #dsm11101#8;
     nAnyAnterior = nAny - 1;

     |HAZ Mensaje;

     |SI #dsm11101#9 = "L";   || clave perceptora "L" no (tienen el tipo de
          |ACABA;             || relacion laboral a cero)
     |FINSI;

     |BUCLE labtraba;
|FPRC;

|DEFBUCLE dsm11101;
     #dsm11101#1;
     ;
     nDesdeEmp, #dsmoy068#25, 00, 110, 00, 01, "            ", 0000, #dsmoy068#27, " ", "  ", 0;
     nHastaEmp, #dsmoy068#25, 99, 110, 98, 98, "zzzzzzzzzzzz", 0000, #dsmoy068#28, "z", "zz", 4;
     ;
     NULL, dsm11101;
|FIN;

|PROCESO dsm11101_cuenta;
     |SI #dsm11101#6 ! aAntNif;
          nTotal = nTotal + 1;
     |FINSI;
     aAntNif = #dsm11101#6;
|FPRC;

|DEFBUCLE dsm11101_cuenta;
     #dsm11101#1;
     ;
     nDesdeEmp, #dsmoy068#25, 00, 110, 00, 01, "            ", 0000, #dsmoy068#27, " ", "  ", 0;
     nHastaEmp, #dsmoy068#25, 99, 110, 98, 98, "zzzzzzzzzzzz", 0000, #dsmoy068#28, "z", "zz", 4;
     ;
     NULL, dsm11101_cuenta;
|FIN;

|PROCESO Version2016;
     |SI #dsmoy068#0 = "N";
         nDesdeEmp = #dsmoy068#1;
         nHastaEmp = #dsmoy068#2;

         |BUCLE dsm11101_cuenta;
         |BUCLE dsm11101;
     |SINO;
         |PARA nCalc = 3; |SI nCalc [ 22; |HACIENDO nCalc = nCalc + 1;
               nDesdeEmp = #dsmoy068#nCalc#;
               nHastaEmp = #dsmoy068#nCalc#;

               |BUCLE dsm11101_cuenta;
         |SIGUE;

         |PARA nCalc = 3; |SI nCalc [ 22; |HACIENDO nCalc = nCalc + 1;
               nDesdeEmp = #dsmoy068#nCalc#;
               nHastaEmp = #dsmoy068#nCalc#;

               |BUCLE dsm11101;
         |SIGUE;
     |FINSI;

     eaTitulo = "modelo 110/111";
     nDModelo = 111;
     nHModelo = 111;
     eaTitulo = "modelo 111";
|FPRC;

|PROCESO Emision;
     |SI #dsmoy068#25 [ 2015;
         |HAZ Version2015;
     |FINSI;

     |SI #dsmoy068#25 ] 2016;
         |HAZ Version2016;
     |FINSI;

     |LEE 000#dsmow168.p;
     |SI FSalida ! 0;
         |MENAV "    Seleccion vacia";
         |ACABA;
     |FINSI;

     Impresora = "CrystalReport";
     |IMPRE -1;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |INFOR "dsmoy068";
     |SI FSalida ! 0;  |FINIMP;  |ACABA;  |FINSI;

     |BUCLE Imprime;
     |PIEINF;
     |FININF;
     |FINIMP;
|FPRC;

|PROGRAMA;
     |CLS;
     |PINPA #0#dsmoy068;

     aPathLaboral = "";
     |DBASS aBase;   |QBF aBase;
     aAlfa1 = aBase + "laboral/def/labempre.mas";
     |XABRE "E", aAlfa1, nHandle;
     |SI FSalida ] 0;
         aPathLaboral = aBase + "laboral/fich/";
     |SINO;
          |MENAV "    No esta instalada la Aplicacion de Laboral. Proceso interumpido";
          |ACABA;
     |FINSI;

     |ABRE #dsmoy068;
     |DDEFECTO #dsmoy068;
     |LEE 000#dsmoy068.p;
     |SI FSalida = 0;  |BORRA 020#dsmoy068.a;  |FINSI;

     |PINDA #0#dsmoy068;

     aAlfa = "tmp" + Usuario;
     |NOME_DAT #dsmow168#aAlfa#;
     |DELINDEX #dsmow168;
     |ABRE #dsmow168;

     aAlfa = aPathLaboral;
     |PATH_DAT #nomhiatr#aAlfa#;
     |PATH_DAT #nomhicca#aAlfa#;
     |PATH_DAT #labempre#aAlfa#;
     |ABRE #nomhiatr;
     |ABRE #nomhicca;
     |ABRE #labempre;

     |DBASS aAlfa;
     |QBF aAlfa;
     aAlfa = aAlfa + "integral/fich/";
     |PATH_DAT #dsam0000#aAlfa#;
     |ABRE #dsam0000;

     |ENDATOS #1#dsmoy068;
     |SI FSalida = 0;
         |HAZ Emision;
     |FINSI;

     |CIERRA #dsam0000;
     |CIERRA #nomhicca;
     |CIERRA #nomhiatr;
     |CIERRA #labempre;
     |CIERRA #dsmow168;
     |DELINDEX #dsmow168;

     |GRABA 000#dsmoy068.n;
     |CIERRA #dsmoy068;
|FPRO;
