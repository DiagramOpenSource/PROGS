|FICHEROS;
     dsmozpas #0;
     dsmom004 #4;
     dsmom008 #8;
     dsm180li #2;
     dsmoc115 #115;

     dsmom030 #30;

     :/contagen/def/canempre #101;
     :/contagen/def/camaniva #102;
     :/contagen/def/caivalin #103;
     :/contagen/def/caivaasi #104;
     :/basica/def/agicen17   #117;

     ds180li@   #900;
     &regisnif@ #709;
     dsmow013   #999;
|FIN;

|VARIABLES;
     nSwHay       = 0;
     nSumaBaseDin = 0;
     nSumaBaseEsp = 0;
     nSumaReteDin = 0;
     nSumaReteEsp = 0;

     Periodo      = 0;
     nDComplem    = 0;
     nHComplem    = 0;

     nNumero      = 0;
     nPaseInm     = 0;
     nRegistro    = 0;
     nTipo        = 0;
     nSwPorSub    = 0;
     nDevengo     = 0;
     aReferencia  = "";

     nImporteBaseI=0;
     nPorcentaje  = 0;
     nImporteRetencion = 0;
     aEspecie="";
     &eaCodSubdep = "";
     nCodSubdep = 0;

     aBase  = "";
     aMas   = "";
     aAlfa1 = "";
     aAlfa2 = "";
     nActividad = 0;
|FIN;

|INCLUYE i_variar;

|| ////////////////////////////////////////////////
|PROCESO PonNuevosCampos;
       #2#30 = #115#43;
       #2#29 = #115#42;
       #2#16 = #115#29;
       #2#17 = #115#30;
       #2#18 = #115#31;
       #2#19 = #115#32;
       #2#20 = #115#33;
       #2#21 = #115#34;
       #2#22 = #115#35;
       #2#23 = #115#36;
       #2#24 = #115#37;
       #2#25 = #115#38;
       #2#26 = #115#39;
       #2#27 = #115#40;
       #2#28 = #115#41;
|FPRC;

|PROCESO IgualaCampos;
       #2#30 = #117#1;
       #2#29 = #117#2;
       #2#16 = #117#3;
       #2#17 = #117#6;
       #2#18 = #117#7;
       #2#19 = #117#8;
       #2#20 = #117#9;
       #2#21 = #117#10;
       #2#22 = #117#11;
       #2#23 = #117#12;
       #2#24 = #117#13;
       #2#25 = #117#14;
       #2#26 = #117#15;
       #2#27 = #117#17;
       #2#28 = #117#18;
|FPRC;

|PROCESO PonDatos;
     |ABRE #117;
     |DDEFECTO #117;
     #117#0 = #2#0;
     #117#1 = #2#30;
     #117#2 = #2#29;
     |LEE 040#117=;
     |SI FSalida = 0;
         |HAZ IgualaCampos;
     |FINSI;
     |CIERRA #117;
|FPRC;

|PROCESO Encuentra;
   |SI nSwPorSub = 1;
       |SI #900#29 = nCodSubdep; |Y #900#30 = nActividad;
           nRegistro = #900#15;
           nNumero   = 1;
       |FINSI;
   |SINO;
       |SI #900#16 = aReferencia; |Y #900#30 = nActividad;
           nRegistro = #900#15;
           nNumero   = 1;
       |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE PorDepSub;
   #ds180li@#1010;
   ;
   enEmpresa, enEjer, 99, 180, enComplem, 00, eaCodNif, nTipo, nDevengo, 01;
   enEmpresa, enEjer, 99, 180, enComplem, 99, eaCodNif, nTipo, nDevengo, 99;
   e;
   NULL, Encuentra;
|FIN;

|PROCESO BuscaRegistro;

     nNumero   = 0;
     nRegistro = 1;
     |BUCLE PorDepSub;

     |SI nNumero = 0;
         |ABRE #900;
         #900#0 = enEmpresa;
         #900#1 = enEjer;
         #900#2 = 99;
         #900#3 = 180;
         #900#4 = enComplem;
         #900#5 = 0;
         #900#6 = eaCodNif;
         #900#7 = nTipo;
         #900#8 = nDevengo;
         #900#15 = 99;
         |LEE 041#900];
         |SI FSalida = 0;
             |LEE 041#900a;
         |SINO;
             |LEE 041#900u;
         |FINSI;
         |SI FSalida = 0; |Y #900#0 = enEmpresa; |Y #900#1 = enEjer; |Y #900#2 = 99;
             |Y #900#3 = 180; |Y #900#4 = enComplem; |Y  #900#5 = 0;
                aAlfa1 = #900#6;   |QBF aAlfa1;
                aAlfa2 = eaCodNif; |QBF aAlfa2;
                |SI aAlfa1 = aAlfa2; |Y #900#7 = nTipo; |Y #900#8 = nDevengo;
                    nNumero = #900#15;
                |FINSI;
         |FINSI;
         nRegistro = nNumero + 1;
         |CIERRA #900;
    |FINSI;
|FPRC;

|| ////////////////////////////////////////////////

|PROCESO LeeLinea180;
     #30#0=#103#18;
     |LEE 000#30=;
     |SI FSalida!0; |ACABA; |FINSI;

     |SI #30#5  ! "S";  |ACABA;  |FINSI;
     |SI #30#38 ! 180;  |ACABA;  |FINSI;

     |DDEFECTO #102;
     #102#0 = #103#0;
     #102#1 = #103#1;
     |LEE 041#102=;

     eaCodNif = #102#14;
     |HAZ LeeNifs;

     nRegistro = 1;
     nSwPorSub = 1;
     |SI aMulDep = "S";
         nActividad = #103#30;
         eaCodSubdep = #103#31;
     |SINO;
         nActividad = #102#10;
         eaCodSubdep = #102#11;
     |FINSI;
     nCodSubdep = eaCodSubdep;

     nImporteBaseI     = (#103#20 / enConversor) ! EURODBMOD;
     nPorcentaje       = #103#21;
     nImporteRetencion = (#103#22 / enConversor) ! EURODBMOD;
     aEspecie          = #103#26;

     |SI nImporteBaseI ! 0; |O nImporteRetencion ! 0;

        nTipo = 1;
        |SI aEspecie = "S";  nTipo = 2; |FINSI;
        |HAZ BuscaRegistro;

        |DDEFECTO #2;
        #2#0 = enEmpresa;
        #2#1 = enEjer;
        #2#2 = 99;
        #2#3 = 180;
        #2#4 = enComplem;
        #2#5 = 0;
        #2#6 = eaCodNif;
        #2#7 = nTipo;
        #2#8 = 0;
        #2#15 = nRegistro;
        |LEE 101#2=;
        |SI FSalida ! 0;
            |DDEFECTO #2;
            #2#0 = enEmpresa;
            #2#1 = enEjer;
            #2#2 = 99;
            #2#3 = 180;
            #2#4 = enComplem;
            #2#5 = 0;
            #2#6 = eaCodNif;
            #2#7 = nTipo;
            #2#8 = 0;
            #2#15 = nRegistro;
            #2#29 = nCodSubdep;
            #2#30 = nActividad;
            |HAZ PonDatos;
            |GRABA 020#2b;
        |FINSI;

        #2#10 = #102#13;
        #2#14 = #709#4;

        #2#11 = #2#11 + nImporteBaseI;
        #2#13 = #2#13 + nImporteRetencion;
        #2#12 = (#2#13 * 100) / #2#11;

        |GRABA 020#2a;
        nSwHay = 1;
  |FINSI;
|FPRC;

|DEFBUCLE caivalin180;
     #103#1;
     18;
     01, 0000000001, 01, 001;
     99, 9999999999, 99, 999;
     ;
     NULL, LeeLinea180;
|FIN;

|PROCESO PaseConta_2014;

     enSwOpPar   = 0;
     |HAZ SituaEmpresa;
     |SI enSwPartido = 0;
         |ABRE #101;
         |SELECT #4#101;
         #101#2  = #999#0;
         #101#26 = 14;
         |LEE 040#101=;
         |SI FSalida ! 0;  |CIERRA #101;  |ACABA;   |FINSI;
         |CIERRA #101;

         |DBASS aPathConta;   |QBT aPathConta;
         aPathConta = aPathConta + "contagen/fich/" + (("00000" + #101#2) % -105) + #101#3 + "/";

         enEmpresa  = #101#2;
         enPerConta = #101#3;
         eaLaMonEmp = #101#28;
      |SINO;
          enPerConta = enPeriodoPar;
          eaLaMonEmp = "E";
      |FINSI;
      |HAZ EnConversor;

      |PATH_DAT #102 aPathConta;
      |PATH_DAT #103 aPathConta;
      |PATH_DAT #104 aPathConta;

      |ABRE #104;
      |LEE 040#104p;
      |SI FSalida ! 0;  |DDEFECTO #104;  |FINSI;
      aMulDep = #104#132;
      |CIERRA #104;

      |ABRE #2;
      |ABRE #30;
      |ABRE #102;
      |BUCLE caivalin180;
      |CIERRA #102;
      |CIERRA #30;
      |CIERRA #2;

      |SI enSwPartido = 1;
          enSwOpPar   = 2;
          |HAZ FinalPartido;
      |FINSI;
|FPRC;

|| /////////////////////////////////////////////////////
|PROCESO GrabaPerceptor180;
     |SI #115#6 = "PASEANTERIOR";  |ACABA;  |FINSI;

     nSumaBaseDin = (#115#8  + #115#14 + #115#20) ! 2;
     nSumaBaseEsp = (#115#11 + #115#17 + #115#23) ! 2;
     nSumaReteDin = (#115#10 + #115#16 + #115#22) ! 2;
     nSumaReteEsp = (#115#13 + #115#19 + #115#25) ! 2;

     eaCodNif = #115#6;
     |HAZ LeeNifs;

     nActividad  = #115#43;
     aReferencia = #115#29;
     nDevengo    = #115#7;

     |SI nSumaBaseDin ! 0;  |O nSumaReteDin ! 0;
         nRegistro = 1;
         |SI enEjer > 2014;
             nTipo = 1;
             |HAZ BuscaRegistro;
         |FINSI;

         #2#0 = #115#0;
         #2#1 = #115#1;
         #2#2 = 99;
         #2#3 = 180;
         #2#4 = enComplem;
         #2#5 = 0;
         #2#6 = #115#6;
         #2#7 = 1;
         #2#8 = #115#7;
         #2#15 = nRegistro;
         |LEE 101#2=;
         |SI FSalida ! 0;
             |DDEFECTO #2;
             #2#0  = #115#0;
             #2#1  = #115#1;
             #2#2  = 99;
             #2#3  = 180;
             #2#4  = enComplem;
             #2#5  = 0;
             #2#6  = #115#6;
             #2#7  = 1;
             #2#8  = #115#7;
             #2#14 = #709#4;
             #2#15 = nRegistro;
             |GRABA 020#2b;
         |FINSI;
         #2#10 = #115#26;
         #2#11 = #2#11 + nSumaBaseDin;
         #2#13 = #2#13 + nSumaReteDin;
         #2#12 = (#2#13 * 100) / #2#11;

         |SI enEjer > 2014;
             |HAZ PonNuevosCampos;
         |FINSI;
         |GRABA 020#2a;
         |LIBERA #2;
         nSwHay = 1;
     |FINSI;

     |SI nSumaBaseEsp ! 0;  |O nSumaReteEsp ! 0;
         nRegistro = 1;
         |SI enEjer > 2014;
             nTipo = 2;
             |HAZ BuscaRegistro;
         |FINSI;

         #2#0 = #115#0;
         #2#1 = #115#1;
         #2#2 = 99;
         #2#3 = 180;
         #2#4 = enComplem;
         #2#5 = 0;
         #2#6 = #115#6;
         #2#7 = 2;
         #2#8 = #115#7;
         #2#15 = nRegistro;
         |LEE 101#2=;
         |SI FSalida ! 0;
             |DDEFECTO #2;
             #2#0  = #115#0;
             #2#1  = #115#1;
             #2#2  = 99;
             #2#3  = 180;
             #2#4  = enComplem;
             #2#5  = 0;
             #2#6  = #115#6;
             #2#7  = 2;
             #2#8  = #115#7;
             #2#14 = #709#4;
             #2#15 = nRegistro;
             |GRABA 020#2b;
         |FINSI;
         #2#10 = #115#26;
         #2#11 = #2#11 + nSumaBaseEsp;
         #2#13 = #2#13 + nSumaReteEsp;
         #2#12 = (#2#13 * 100) / #2#11;

         |SI enEjer > 2014;
             |HAZ PonNuevosCampos;
         |FINSI;
         |GRABA 020#2a;
         |LIBERA #2;
         nSwHay = 1;
     |FINSI;
|FPRC;

|DEFBUCLE dsmoc115;
     #115#1;
     ;
     #999#0, #999#2, Periodo, 115, nDComplem, 01, "            ", 0000, 01;
     #999#0, #999#2, Periodo, 115, nHComplem, 99, "zzzzzzzzzzzz", 9999, 99;
     ;
     NULL, GrabaPerceptor180;
|FIN;

|PROCESO Pase180;

     |ABRE #4;
     #4#0 = #999#0;
     #4#1 = #999#2;
     #4#2 = #999#3;
     #4#3 = #999#7;
     #4#4 = #999#9;
     |LEE 040#4=;
     |SI FSalida ! 0;  |CIERRA #4; |ACABA;   |FINSI;
     |CIERRA #4;

     enEmpresa     = #999#0;
     enEjer        = #999#2;
     enPeriodo     = #999#3;
     enModelo      = #999#7;
     enComplem     = #4#4;
     enActividad   = 0;
     enTipoEntrada = 3;
     enMensa       = 1;
     |SUB_EJECUTA_NP "dsm180ca";

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/dsm180li.mas";
     |CARGA_DEF aMas, ds180li@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     nPaseInm = 0;
     |SI enEjer = 2014;
         |ABRE #117;
         #117#0 = enEmpresa;
         #117#1 = 01;
         #117#2 = 00;
         |LEE 040#117];
         |SI FSalida = 0;  |Y #117#0 = enEmpresa;
              nPaseInm = 1;
         |FINSI;
         |CIERRA #117;

         |SI nPaseInm = 1;
             |CONFI "0000NRecoger los importes y datos de los inmuebles de la Contabilidad";
             |SI FSalida ! 0; nPaseInm = 0; |FINSI;
         |FINSI;
     |FINSI;

     |SI nPaseInm = 0;
         nSwPorSub = 0;
         |PARA Periodo = 1;  |SI Periodo [ 12;  |HACIENDO Periodo = Periodo + 1;
               nDComplem = -1;
               |ABRE #115;
               |DDEFECTO #115;
               #115#0 = #999#0;
               #115#1 = #999#2;
               #115#2 = Periodo
               #115#3 = 115;
               #115#4 = 99;
               |LEE 040#115];
               |SI FSalida = 0;
                   |LEE 040#115a;
               |SINO;
                   |LEE 040#115u;
               |FINSI;
               |SI FSalida = 0; |Y #115#0 = #999#0; |Y #115#1 = #999#2;
                        |Y #115#2 = Periodo; |Y #115#3 = 115;
                            nDComplem = #115#4;
                            nHComplem = #115#4;
               |FINSI;
               |CIERRA #115;
               |SI nDComplem ] 0;
                   |ABRE #2;
                   |BUCLE dsmoc115;
                   |CIERRA #2;
               |FINSI;
         |SIGUE;
     |SINO;
         |HAZ PaseConta_2014;
     |FINSI;
     |DESCARGA_DEF #ds180li@;

     |SI nSwHay = 0;
         |MENAV "      Seleccion Vacia";
         |CONFI "0000NDesea Crear el Modelo sin Actividad ";
         |SI FSalida ! 0;  |ACABA;  |FINSI;
     |FINSI;

     enEmpresa     = #999#0;
     enEjer        = #999#2;
     enPeriodo     = #999#3;
     enModelo      = #999#7;
     enComplem     = #4#4;
     enActividad   = 0;
     enTipoEntrada = 98;
     enMensa       = 1;
     |SUB_EJECUTA_NP "dsm180ca";

     |ABRE #4;
     #4#0 = #999#0;
     #4#1 = #999#2;
     #4#2 = #999#3;
     #4#3 = #999#7;
     #4#4 = #999#9;
     |LEE 101#4=;
     |SI FSalida = 0;
         #4#7  = "X";
         #4#8  = ~;
         #4#15 = 0;
         #4#17 = "COMPLETADO";

         |GRABA 020#4a;
         |LIBERA #4;
     |FINSI;
     |CIERRA #4;
|FPRC;
