|FICHEROS;
     dsm32201;
     dsm30301;
     dsm32204;
     dsm32205;
     dsmoc322;

     dsmom004;
     dsmom006;
     dsmom008;
     dsmom028;
     dsmom047;
     dsmom085;
     dsmom086;
     dsmom087;
     dsmom103;

     :basica/agicen14;
     :basica/agicen30;

     dsmow214;
     dsmow225;
     dsmow228;

     dsmow215;
     dsmow216;
     dsmow217;
     dsmow218;

     dsmow226,MANTE;
     dsmow221,MANTE;
     dsmow222,MANTE;
     dsmow223,MANTE;

     dsm32201@;
     espejo@;
     &clientes@;
|FIN;

|VARIABLES;
     aEsc                = "";
     aRetu               = "";
     aTecla              = "";
     aEsc1               = "";
     aEsc2               = "";
     aAlfa               = "";
     aAlfa1              = "";
     aOrigen             = "";
     aDestino            = "";
     aDocServidor        = "";
     aDocRemoto          = "";
     aIPRemoto           = "";
     aEjecuta            = "";
     aBase               = "";
     aRutaOrigen         = "";
     aRutaDestino        = "";
     aFicheroTar         = "";
     aFicheroTxt         = "";
     aFicheroTgz         = "";
     aAbre               = "";
     aBuscar             = "";
     aRefresca           = "";
     aMas                = "";
     aGuardo9            = "";
     aGuardo11           = "";
     aGuardo12           = "";
     aGuardo13           = "";
     aGuardo130          = "";
     aGuardo131          = "";
     aGuardo132          = "";
     aGuardo144          = "";
     nGuardo76           = 0;
     nGuardo77           = 0;

     nVentana            = 0;
     nVentTrab           = -1;
     nRango              = 0;
     nModo               = 0;
     nHandle             = 0;
     nHandleTgz          = 0;
     nLinea              = 0;
     nPanta303           = 0;
     nPanta214           = -1;
     nPanta217           = -1;
     nPanta213           = -1;
     nPanta225           = -1;
     nPanta228           = -1;
     nPanta226           = -1;
     nPanta221           = -1;
     nPanta222           = -1;
     nPanta223           = -1;
     nPintaSalir         = 0;
     nEjerAnt            = 0;
     nAnyo               = 0;
     nPer                = 0;
     nPro                = 0;
     nContador           = 0;
     nIVA1               = 0;
     nIVA2               = 0;
     nIVA3               = 0;
     nIVA4               = 0;
     nIVA5               = 0;
     nIVA6               = 0;
     nIVA7               = 0;
     nIVA8               = 0;
     nIVA9               = 0;
     nLSimpl             = 0;
     nLRGral             = 0;
     nLRGral99           = 0;
     nBaseMas            = 0;
     nCuotaMas           = 0;
     nCampo1             = 0;
     nCampo2             = 0;
     nCampo3             = 0;
     nCampo11            = 0;
     nCampo22            = 0;
     nCampo33            = 0;
     nUltEpi             = 0;
     nDesde              = 0;
     nHasta              = 0;
     nSwAcum             = 0;
     nIVA                = 0;
     nTotal              = 0;
     nTotal303           = 0;
     nNegativo           = 0;
     nNegativoC          = 0;
     nNegativoD          = 0;
     nHComple            = 0;
     nCampo              = 0;
     nFactor             = 0;
     nNume               = 0;
     nNume1              = 0;
     nNume2              = 0;
     nNume3              = 0;
     nRes                = 0;
     nUni1               = 0;
     nUni2               = 0;
     nUni3               = 0;
     nUni4               = 0;
     nUni5               = 0;
     nUni6               = 0;
     nUni7               = 0;
     nUni8               = 0;
     nUni9               = 0;

     nBtn10              = 0;
     nBtn11              = 0;
     nBtn12              = 0;
     nBtn13              = 0;
     nBtn131             = 0;
     nBtn132             = 0;
     nBtn144             = 0;
     nBtnVal             = 0;
     nBtnCan             = 0;
     nBtnVal213          = 0;
     nBtnCan213          = 0;
     nBtnMod213          = 0;
     nBtnMod226          = 0;
     nBtnMod221          = 0;
     nBtnMod222          = 0;
     nBtnMod223          = 0;

     nTree               = -1;
     nGrid02             = -1;
     nGrid03             = -1;
     nGrid04             = -1;
     nIdSalir            = -1;
     nDCampo             = 0;
     nHCampo             = 0;
     nModAnter           = 0;
     nPeriodoMin         = 0;

     nEstado             = 0;
     nOpera              = 0;
     nSw                 = 0;
     nOk                 = 0;
     aCNAE               = "";
     nQuants             = 0;
     nPrim               = 0;
     nDepar              = 0;
     nTpComun            = 0;
     nPeriodo            = 0;
     nSector             = 0;
     nM                  = 0;
     nTp100a             = 0;

     {2}nNivel           = 0;

     {-1}aVent           = "";
         aVent1          = 0;
         aVent2          = 0;
         aVent3          = 0;
         aVent4          = 0;
         aVent5          = "";

     {-1}sTree           = 0;
         sT_nID          = 0;
         sT_nOper        = 0;
         sT_aData        = "";

     nImporte1           = 0;
     nImporte2           = 0;

     &eaUnidadBasico     = "";
     &eMensa             = 0;
     &enNoMod390         = 0;

     fFecha              = @;
     &eaCifDom           = "";
     &eaNumero           = "";
     &eaDominante        = "";
|FIN;

|INCLUYE i_variar;

|| ..........Todo Lineal de Prorratas y grupos

|PROCESO grupos123;
     |SI #dsmoc322#7 = 0; |O #dsmoc322#7 = 12; |ACABA; |FINSI;

     nSector = 1;
     nTp100a  = 100;
     #dsmom086#0 = #dsmoc322#0;
     #dsmom086#1 = #dsmoc322#1;
     #dsmom086#2 = #dsmoc322#5;  ||Actividad
     |LEE 041#dsmom086.=;
     |SI FSalida = 0;
         nSector = #dsmom086#15;
         nTp100a = #dsmom086#6;
     |FINSI;
     |SI nSector > 2; nSector = 2; |FINSI;

     #dsmom087#0 = #dsmoc322#0;
     #dsmom087#1 = #dsmoc322#1;
     #dsmom087#2 = #dsmoc322#2;
     #dsmom087#3 = #dsmoc322#3;
     #dsmom087#4 = #dsmoc322#4;
     #dsmom087#5 = #dsmoc322#5;
     #dsmom087#6 = #dsmoc322#6;
     #dsmom087#7 = #dsmoc322#7;
     |LEE 041#dsmom087.=;
     |SI FSalida = 0;
         #dsmoc322#13 = (#dsmom087#12 % nTp100a) ! 2 + (#dsmom087#37 % nTpComun) ! 2;  ||la actividad
     |FINSI;

     |SI #dsmoc322#12 ! 0;  |O #dsmoc322#13 ! 0;
         nQuants = 1;
         #dsm32205#0 = #dsm32201#0;
         #dsm32205#1 = #dsm32201#1;
         #dsm32205#2 = #dsm32201#3;
         #dsm32205#3 = #dsm32201#4;
         #dsm32205#4 = nSector;
         |LEE 101#dsm32205.=;
         |SI FSalida ! 0;
             |DDEFECTO #dsm32205;
             #dsm32205#0 = #dsm32201#0;
             #dsm32205#1 = #dsm32201#1;
             #dsm32205#2 = #dsm32201#3;
             #dsm32205#3 = #dsm32201#4;
             #dsm32205#4 = nSector;
             |GRABA 020#dsm32205.b;
         |FINSI;
         nCampo1 = 0;
         |SI #dsmoc322#7 = 1;  nCampo1 =  5; |FINSI;
         |SI #dsmoc322#7 = 14; nCampo1 =  5; |FINSI;
         |SI #dsmoc322#7 = 2;  nCampo1 =  7; |FINSI;
         |SI #dsmoc322#7 = 15; nCampo1 =  7; |FINSI;
         |SI #dsmoc322#7 = 3;  nCampo1 =  9; |FINSI;
         |SI #dsmoc322#7 = 4;  nCampo1 = 11; |FINSI;
         |SI #dsmoc322#7 = 5;  nCampo1 = 13; |FINSI;
         |SI #dsmoc322#7 = 13; nCampo1 = 13; |FINSI;
         |SI #dsmoc322#7 = 6;  nCampo1 = 15; |FINSI;
         |SI #dsmoc322#7 = 7;  nCampo1 = 17; |FINSI;
         |SI #dsmoc322#7 = 8;  nCampo1 = 19; |FINSI;
         |SI #dsmoc322#7 = 17; nCampo1 = 19; |FINSI;
         |SI #dsmoc322#7 = 16; nCampo1 = 19; |FINSI;
         |SI #dsmoc322#7 = 9;  nCampo1 = -1; nCampo2 = 21; |FINSI;

         |SI nCampo1 ! 0;
             |SI nCampo1 ! -1;
                 nCampo2 = nCampo1 + 1;
                 #dsm32205#nCampo1# = #dsm32205#nCampo1# + #dsmoc322#12;
             |FINSI;
             #dsm32205#nCampo2# = #dsm32205#nCampo2# + #dsmoc322#13;
         |FINSI;

         #dsm32205#22 = #dsm32205#6  + #dsm32205#8  + #dsm32205#10 + #dsm32205#12 + #dsm32205#14 + #dsm32205#16;
         #dsm32205#22 = #dsm32205#22 + #dsm32205#18 + #dsm32205#20 + #dsm32205#21;

         |GRABA 020#dsm32205.a;
         |LIBERA #dsm32205;
     |FINSI;
     |LIBERA #dsmoc322;
|FPRC;

|DEFBUCLE dsmoc322_grupo;
     #dsmoc322#1;
     ;
     #dsmom004#0, #dsmom004#1, #dsmom004#2, #dsmom004#3, #dsmom004#4, 01, 2,  0;
     #dsmom004#0, #dsmom004#1, #dsmom004#2, #dsmom004#3, #dsmom004#4, 98, 2, 99;
     be;
     NULL, grupos123;
|FIN;

|PROCESO PaseGrupos123;
     nQuants = 0;

     |ABRE #dsm32205;
     |ABRE #dsmom086;
     |ABRE #dsmom087;
     |ABRE #dsmom004;
     |PARA nPeriodo = 1; |SI nPeriodo [ 12;  |HACIENDO nPeriodo = nPeriodo + 1;
           #dsmom004#0   = #dsm32201#0;
           #dsmom004#1   = #dsm32201#1;
           #dsmom004#2   = nPeriodo;
           #dsmom004#3   = #dsm32201#3;
           #dsmom004#4   = 99;
           |LEE 000#dsmom004.];
           |SI FSalida = 0;
               |LEE 000#dsmom004.a;
           |SINO;
               |LEE 000#dsmom004.u;
           |FINSI;

           |SI FSalida = 0;  |Y #dsmom004#0 = #dsm32201#0;      |Y #dsmom004#1 = #dsm32201#1;
                             |Y #dsmom004#2   = nPeriodo;  |Y #dsmom004#3 = #dsm32201#3;
                   nM = 322;
                   |BUCLE dsmoc322_grupo;
           |FINSI;
     |SIGUE;

     |CIERRA #dsmom004;
     |CIERRA #dsmom087;
     |CIERRA #dsmom086;
     |CIERRA #dsm32205;
|FPRC;

|PROCESO Leem086;
       nDepar = #dsmom086#2;

|| ... |SI enAdTodas = 1; |Y #dsmom086#6 = 100; |ACABA; |FINSI; esto solo 390

       nLinea = nLinea + 1;
       |DDEFECTO #dsm32204;
       #dsm32204#0 = enEmpresa;
       #dsm32204#1 = enEjer;
       #dsm32204#2 = #dsm32201#3;
       #dsm32204#3 = #dsm32201#4;
       #dsm32204#4 = nDepar;
       |LEE 101#dsm32204.=;
       |SI FSalida ! 0;
           |SELECT #1#dsm32204;
           |DDEFECTO #dsm32204;
           #dsm32204#0 = enEmpresa;
           #dsm32204#1 = enEjer;
           #dsm32204#2 = #dsm32201#3;
           #dsm32204#3 = #dsm32201#4;
           #dsm32204#4 = nDepar;
           #dsm32204#5 = #dsmom086#3;
           #dsm32204#6 = #dsmom086#4;
           #dsm32204#11 = nLinea;
           |GRABA 020#dsm32204.b;
       |FINSI;
       |SI aCNAE = ""; |Y #dsmom086#4 ! "     ";
           aCNAE = #dsmom086#4;
       |FINSI;
       |SI aCNAE ! ""; |Y #dsmom086#4 = "     ";
           #dsmom086#4 = aCNAE;
       |FINSI;

       #dsm32204#7  = #dsmom086#9;  || Totales
       #dsm32204#8  = #dsmom086#7;  || Con derecho a deducir
       #dsm32204#9  = #dsmom085#4;  || tipo prorrata
       #dsm32204#10 = #dsmom086#6;  || % prorrata

       |SI #dsm32204#10 = 100; |Y #dsm32204#9 = "G";
           #dsm32204#7  = 0;  || Totales
           #dsm32204#8  = 0;  || Con derecho a deducir
       |FINSI;

       |GRABA 020#dsm32204.a;
       |LIBERA #dsm32204;

       nQuants = nQuants + 1;

       |SI nPrim = 0; nPrim = #dsmom086#2; |FINSI;
|FPRC;

|DEFBUCLE Leem086;
   #dsmom086#1;
   ;
   #dsmom085#0, #dsmom085#1, 01;
   #dsmom085#0, #dsmom085#1, 98;
   e;
   NULL, Leem086;
|FINSI;

|PROCESO CreaLinProrrata;
   aCNAE = "";
   |ABRE #dsmom085;
   #dsmom085#0 = enEmpresa;
   #dsmom085#1 = enEjer;
   |LEE 040#dsmom085.=;
   |SI FSalida ! 0;
       |CIERRA #dsmom085;
       |ACABA;
   |FINSI;
   |CIERRA #dsmom085;
   |SI #dsmom085#4 = "N"; |ACABA; |FINSI;

   nTpComun = #dsmom085#17;
   nQuants = 0;
   nPrim   = 0;
   |ABRE #dsm32204;
   |BUCLE Leem086;
   |CIERRA #dsm32204;

   |SI #dsmom085#4 = "G"; |Y #dsmom085#5 = 100;
       |ACABA;
   |FINSI;

   |SI nQuants ! 0;
       |HAZ PaseGrupos123;
   |FINSI;
|FPRC;

|PROCESO EjerAnt;
      nEjerAnt = nEjerAnt + #dsmom103#5;
|FPRC;

|DEFBUCLE dsmom103;
     #dsmom103#1;
     ;
     enModelo, enEmpresa, 00, nAnyo, nPer;
     enModelo, enEmpresa, 99, nAnyo, nPer;
     ;
     NULL, EjerAnt;
|FIN;

|PROCESO LeeComplem30301;
     nEjerAnt = #dsm30301#89;
|FPRC;

|DEFBUCLE LeeCompl30301;
     #dsm30301#1;
     ;
     enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 00, 00;
     enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 99, 00;
     ;
     NULL, LeeComplem30301;
|FIN;

|PROCESO RecogeAnter;
     nPeriodoMin = 1;

     |ABRE #dsmom004;
     #dsmom004#0 = enEmpresa;
     #dsmom004#1 = enEjer;
     #dsmom004#2 = enPeriodo;
     #dsmom004#3 = enModelo;
     #dsmom004#4 = enComplem;
     |LEE 040#dsmom004.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom004;  |FINSI;

     |SI #dsmom004#22 = "M";
         nPeriodoMin = 1;
     |SINO;
         nPeriodoMin = 3;
     |FINSI;

     |SI enPeriodo = nPeriodoMin;
         nAnyo     = enEjer - 1;
         nPer      = 12;
     |SINO;
         nAnyo     = enEjer;
         nPer      = enPeriodo - nPeriodoMin;
     |FINSI;

     #dsm32201#0 = enEmpresa;
     #dsm32201#1 = nAnyo;
     #dsm32201#2 = nPer;
     #dsm32201#3 = 322;
     #dsm32201#4 = 0;
     #dsm32201#5 = 0;
     |LEE 040#dsm32201.=;
     |SI FSalida = 0;
         aGuardo9   = #dsm32201#9;
         aGuardo130 = #dsm32201#130;
         aGuardo144 = #dsm32201#144;
     |FINSI;

     nModAnter   = 0;
     #dsmom004#0 = enEmpresa;
     #dsmom004#1 = nAnyo;
     #dsmom004#2 = nPer;
     #dsmom004#3 = 303;
     #dsmom004#4 = 0;
     |LEE 040#dsmom004.=;
     |SI FSalida = 0;  nModAnter = #dsmom004#3;  |FINSI;

     nEjerAnt = 0;
     |SI nModAnter = 303;
         |BUCLE LeeCompl30301;
     |FINSI;

     |SI nEjerAnt = 0;
         |BUCLE dsmom103;
     |FINSI;

     |ABRE #dsmom047;
     #dsmom047#0 = enEmpresa;
     #dsmom047#1 = enEjer;
     #dsmom047#2 = enPeriodo;
     #dsmom047#3 = enModelo;
     #dsmom047#4 = enComplem;
     #dsmom047#5 = 0;
     |LEE 040#dsmom047.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom047;  |FINSI;
     |CIERRA #dsmom047;

     |ABRE #dsmom028;
     #dsmom028#0 = enEmpresa;
     #dsmom028#1 = enEjer;
     #dsmom028#2 = enPeriodo;
     #dsmom028#3 = enModelo;
     #dsmom028#4 = enComplem;
     #dsmom028#5 = 0;
     |LEE 040#dsmom028.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom028;  |FINSI;
     |CIERRA #dsmom028;

     |SI #dsmom028#7 = "N";  #dsmom028#6 = 0; |FINSI;

     nEjerAnt = nEjerAnt - #dsmom028#6;
     |SI nEjerAnt < 0;  nEjerAnt = 0;  |FINSI;
|FPRC;

|PROCESO GrabaPrescripcion;

     |ABRE #dsmom028;
     |DDEFECTO #dsmom028;
     #dsmom028#0 = enEmpresa;
     #dsmom028#1 = enEjer;
     #dsmom028#2 = enPeriodo;
     #dsmom028#3 = enModelo;
     #dsmom028#4 = enComplem;
     #dsmom028#5 = 0;
     |LEE 040#dsmom028.=;
     |SI FSalida ! 0; |O #dsmom028#7 ! "S";
         |CIERRA #dsmom028;
         |ACABA;
     |FINSI;

     nEjerAnt = nEjerAnt + #dsmom028#6;

     nImporte1 = #dsm32201#79 + #dsm32201#80 + #dsm32201#82;

     |SI nImporte1 ] 0;
         nImporte2 = nImporte1 - #dsmom028#8;
         |SI nImporte2 ] 0;
             #dsmom028#6 = 0;
         |SINO;
             #dsmom028#6 = - nImporte2;
         |FINSI;
     |SINO;
        #dsmom028#6 = #dsmom028#8;
     |FINSI;

     nEjerAnt = nEjerAnt - #dsmom028#6;

     |GRABA 020#dsmom028.a;
     |LIBERA #dsmom028;
     |CIERRA #dsmom028;
|FPRC;

|PROCESO AcumPorIVA;
     |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
           nCampo11 = nCampo33 - 2;
           nCampo22 = nCampo33 - 1;
           |SI #dsm32201#nCampo22# = nIVA;
               #dsm32201#nCampo11# = #dsm32201#nCampo11# + #dsmoc322#nCampo1#;
               #dsm32201#nCampo33# = #dsm32201#nCampo33# + #dsmoc322#nCampo3#;
               nSwAcum = 1;

               |SI nIVA ! #dsmoc322#nCampo2#;
                   |SI nCampo22 = 15;  nIVA1  = 1;  |FINSI;
                   |SI nCampo22 = 18;  nIVA2  = 1;  |FINSI;
                   |SI nCampo22 = 21;  nIVA3  = 1;  |FINSI;
                   |SI nCampo22 = 26;  nIVA4  = 1;  |FINSI;
                   |SI nCampo22 = 29;  nIVA5  = 1;  |FINSI;
                   |SI nCampo22 = 32;  nIVA6  = 1;  |FINSI;
                   |SI nCampo22 = 41;  nIVA7  = 1;  |FINSI;
                   |SI nCampo22 = 44;  nIVA8  = 1;  |FINSI;
                   |SI nCampo22 = 47;  nIVA9  = 1;  |FINSI;
               |FINSI;
               |SAL;
            |FINSI;
     |SIGUE;

     |SI nSwAcum = 0;
         |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
               nCampo11 = nCampo33 - 2;
               nCampo22 = nCampo33 - 1;
               |SI #dsm32201#nCampo22# = 0;
                   #dsm32201#nCampo11# = #dsmoc322#nCampo1#;
                   #dsm32201#nCampo22# = nIVA;
                   #dsm32201#nCampo33# = #dsmoc322#nCampo3#;
                   nSwAcum = 1;

                   |SI nIVA ! #dsmoc322#nCampo2#;
                       |SI nCampo22 = 15;  nIVA1  = 1;  |FINSI;
                       |SI nCampo22 = 18;  nIVA2  = 1;  |FINSI;
                       |SI nCampo22 = 21;  nIVA3  = 1;  |FINSI;
                       |SI nCampo22 = 26;  nIVA4  = 1;  |FINSI;
                       |SI nCampo22 = 29;  nIVA5  = 1;  |FINSI;
                       |SI nCampo22 = 32;  nIVA6  = 1;  |FINSI;
                       |SI nCampo22 = 41;  nIVA7  = 1;  |FINSI;
                       |SI nCampo22 = 44;  nIVA8  = 1;  |FINSI;
                       |SI nCampo22 = 47;  nIVA9  = 1;  |FINSI;
                   |FINSI;
                   |SAL;
               |FINSI;
         |SIGUE;
     |FINSI;

     |SI nSwAcum = 0;
         nCampo11     = nHasta - 2;
         nCampo22     = nHasta - 1;
         nCampo33     = nHasta;

         #dsm32201#nCampo11# = #dsm32201#nCampo11# + #dsmoc322#nCampo1#;
         #dsm32201#nCampo22# = -1;
         #dsm32201#nCampo33# = #dsm32201#nCampo33# + #dsmoc322#nCampo3#;
     |FINSI;
|FPRC;

|PROCESO GrabaDevengado;
     |SI #dsmoc322#nCampo3# = 0;  |ACABA;  |FINSI;
     nSwAcum       = 0;

     nIVA     = #dsmoc322#nCampo2#;

     |SI nIVA = 18; |O nIVA = 16; nIVA = 21;  |FINSI;
     |SI nIVA = 8;  |O nIVA = 7;  nIVA = 10;  |FINSI;

     |SI nDesde = 33;
         |SI nIVA = 4; nIVA = 5.20;  |FINSI;
         |SI nIVA = 1; nIVA = 1.40;  |FINSI;
     |FINSI;

     |SI nDesde ! nHasta;
         |HAZ AcumPorIVA;
     |SINO;
         nCampo11 = nHasta - 1;
         nCampo33 = nHasta;

         #dsm32201#nCampo11# = #dsm32201#nCampo11# + #dsmoc322#nCampo1#;
         #dsm32201#nCampo33# = #dsm32201#nCampo33# + #dsmoc322#nCampo3#;
     |FINSI;
|FPRC;

|PROCESO GrabaDeducible;
     |SI enSwProrr ! 2;
         |ABRE #dsmom087;
         #dsmom087#0 = #dsmoc322#0;
         #dsmom087#1 = #dsmoc322#1;
         #dsmom087#2 = #dsmoc322#2;
         #dsmom087#3 = #dsmoc322#3;
         #dsmom087#4 = #dsmoc322#4;
         #dsmom087#5 = #dsmoc322#5;
         #dsmom087#6 = #dsmoc322#6;
         #dsmom087#7 = #dsmoc322#7;
         |LEE 001#dsmom087.=;
         |SI FSalida = 0;
             #dsmoc322#16 = #dsmom087#17 + #dsmom087#41;
             #dsmoc322#19 = #dsmom087#20 + #dsmom087#43;
             #dsmoc322#22 = #dsmom087#23 + #dsmom087#45;
             #dsmoc322#25 = #dsmom087#26 + #dsmom087#47;
             #dsmoc322#28 = #dsmom087#29 + #dsmom087#49;
             #dsmoc322#31 = #dsmom087#32 + #dsmom087#51;
             #dsmoc322#34 = #dsmom087#35 + #dsmom087#53;
        |FINSI;
        |LIBERA #dsmom087;
        |CIERRA #dsmom087;
     |FINSI;

     |SI nHasta ! -1;
         nHasta = nDesde + 1;
         #dsm32201#nDesde# = #dsm32201#nDesde# + (#dsmoc322#14 + #dsmoc322#17 + #dsmoc322#20 + #dsmoc322#23 + #dsmoc322#26 + #dsmoc322#29 + #dsmoc322#32);
         #dsm32201#nHasta# = #dsm32201#nHasta# + (#dsmoc322#16 + #dsmoc322#19 + #dsmoc322#22 + #dsmoc322#25 + #dsmoc322#28 + #dsmoc322#31 + #dsmoc322#34);
     |SINO;
         #dsm32201#nDesde# = #dsm32201#nDesde# + ((#dsmoc322#16 + #dsmoc322#19 + #dsmoc322#22 + #dsmoc322#25 + #dsmoc322#28 + #dsmoc322#31 + #dsmoc322#34) % nProrrata) + nCuotaMas;
     |FINSI;
|FPRC;

|PROCESO GrabaParte1;
     |SI #dsmoc322#5 ! 99;
         nLRGral  = nLRGral + 1;
     |SINO;
         nLRGral99 = 1;
     |FINSI;

     enExistencia = 1;
     nDesde       = 0;
     nHasta       = 0;

     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 14;  nDesde = 16;  nHasta = 22;  |FINSI;
     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 17;  nDesde = 24;  nHasta = 24;  |FINSI;

     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 [ 3;   nDesde = 27;  nHasta = 33;  |FINSI;

     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 5;   nDesde = 35;  nHasta = 35;  |FINSI;
     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 15;  nDesde = 35;  nHasta = 35;  |FINSI;
     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 6;   nDesde = 37;  nHasta = 37;  |FINSI;

     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 7;   nDesde = 39;  nHasta = 39;  |FINSI;
     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 8;   nDesde = 39;  nHasta = 39;  |FINSI;
     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 18;  nDesde = 39;  nHasta = 39;  |FINSI;
     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 19;  nDesde = 39;  nHasta = 39;  |FINSI;

     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 10;  nDesde = 42;  nHasta = 48;  |FINSI;

     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 11;  nDesde = 50;  nHasta = 50;  |FINSI;
     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 12;  nDesde = 50;  nHasta = 50;  |FINSI;
     |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 20;  nDesde = 50;  nHasta = 50;  |FINSI;

     |SI nDesde ! 0;
         |PARA nCampo1 = 14;  |SI nCampo1 [ 32;  |HACIENDO nCampo1 = nCampo1 + 3;
               nCampo2 = nCampo1 + 1;
               nCampo3 = nCampo1 + 2;
               |SI #dsmoc322#nCampo1# ! 0;  |O #dsmoc322#nCampo2# ! 0;  |O #dsmoc322#nCampo3# ! 0;
                   |HAZ GrabaDevengado;
               |FINSI;
         |SIGUE;

         |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 15;
             |PARA nCampo1 = 35;  |SI nCampo1 [ 53;  |HACIENDO nCampo1 = nCampo1 + 3;
                   nCampo2 = nCampo1 + 1;
                   nCampo3 = nCampo1 + 2;
                   |SI #dsmoc322#nCampo1# ! 0;  |O #dsmoc322#nCampo2# ! 0;  |O #dsmoc322#nCampo3# ! 0;
                       |HAZ GrabaDevengado;
                   |FINSI;
             |SIGUE;
         |FINSI;

         |SI #dsmoc322#6 = 1;  |Y #dsmoc322#7 = 6;
             |PARA nCampo1 = 35;  |SI nCampo1 [ 53;  |HACIENDO nCampo1 = nCampo1 + 3;
                   nCampo2 = nCampo1 + 1;
                   nCampo3 = nCampo1 + 2;
                   |SI #dsmoc322#nCampo1# ! 0;  |O #dsmoc322#nCampo2# ! 0;  |O #dsmoc322#nCampo3# ! 0;
                       |HAZ GrabaDevengado;
                   |FINSI;
             |SIGUE;
         |FINSI;
     |FINSI;

     |PARA nCampo1 = 17;  |SI nCampo1 [ 23;  |HACIENDO nCampo1 = nCampo1 + 3;
           |SI #dsm32201#nCampo1# = -1;  #dsm32201#nCampo1# = 0;  |FINSI;
     |SIGUE;

     |PARA nCampo1 = 32;  |SI nCampo1 [ 38;  |HACIENDO nCampo1 = nCampo1 + 3;
           |SI #dsm32201#nCampo1# = -1;  #dsm32201#nCampo1# = 0;  |FINSI;
     |SIGUE;

     nDesde = 0;
     nHasta = 0;

     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 14;  nDesde = 52;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 15;  nDesde = 54;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 16;  nDesde = 56;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 1;   nDesde = 58;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 2;   nDesde = 60;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 3;   nDesde = 62;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 4;   nDesde = 64;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 5;   nDesde = 66;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 13;  nDesde = 66;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 6;   nDesde = 68;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 8;   nDesde = 70;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 17;  nDesde = 70;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 7;   nDesde = 72;  nHasta = -1;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 9;   nDesde = 73;  nHasta = -1;  |FINSI;
     |SI #dsmoc322#6 = 2;  |Y #dsmoc322#7 = 10;  nDesde = 74;  nHasta = -1;  |FINSI;

     |SI nDesde ! 0;
         |HAZ GrabaDeducible;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 9;
         #dsm32201#86 = #dsm32201#86 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 16;
         #dsm32201#86 = #dsm32201#86 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 10;
         #dsm32201#87 = #dsm32201#87 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 4;
         #dsm32201#88 = #dsm32201#88 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 5;  |Y #dsmoc322#7 = 1;
         #dsm32201#78 = #dsm32201#78 + #dsmoc322#12;
         nContador = nContador + 1;
     |FINSI;

     |SI #dsmoc322#6 = 5;  |Y #dsmoc322#7 = 2;
         #dsm32201#82 = #dsm32201#82 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 4;  |Y #dsmoc322#7 = 18;
         #dsm32201#89 = #dsm32201#89 + #dsmoc322#12;
         #dsm32201#90 = #dsm32201#90 + #dsmoc322#13;
     |FINSI;
|FPRC;

|PROCESO dsmoc322;
     enImpIvaSop = 0;
     enImpIvaSub = 0;
     enIvaSopDed = 0;
     nBaseMas    = 0;
     nCuotaMas   = 0;

     |SI #dsmoc322#6 = 2;
         |SI #dsmoc322#7 ! 5; |Y #dsmoc322#7 ! 6;
             |SI #dsmoc322#7 ! 10; |Y #dsmoc322#7 ! 11; |Y #dsmoc322#7 ! 12;
                 enIvaSopDed = (#dsmoc322#16 + #dsmoc322#19 + #dsmoc322#22 + #dsmoc322#25 + #dsmoc322#28 + #dsmoc322#31 + #dsmoc322#34) % nProrrata + nCuotaMas;
             |FINSI;
         |FINSI;

         |SI #dsmoc322#7 = 10;
             enImpIvaSop = #dsmoc322#13 + nCuotaMas;
         |FINSI;

         |SI #dsmoc322#7 = 11;
             enImpIvaSub = #dsmoc322#13;
             enIvaSopDed = - (#dsmoc322#16 + #dsmoc322#19 + #dsmoc322#22 + #dsmoc322#25 + #dsmoc322#28 + #dsmoc322#31 + #dsmoc322#34);
         |FINSI;

         |SI #dsmoc322#7 = 12; |ACABA; |FINSI;
     |FINSI;

     |SI #dsmoc322#12 = 0;  |Y #dsmoc322#13 = 0;  |ACABA;  |FINSI;

     |SI #dsmoc322#6 = 5;  |Y #dsmoc322#7 = 6;
         nEjerAnt = #dsmoc322#12;
     |FINSI;

     |HAZ GrabaParte1;

     |LIBERA #dsmoc322;
|FPRC;

|DEFBUCLE dsmoc322;
     #dsmoc322#1;
     ;
     enEmpresa, enEjer, enPeriodo, enModelo, enComplem, 01, 0,  0;
     enEmpresa, enEjer, enPeriodo, enModelo, enComplem, 99, 9, 99;
     be;
     NULL, dsmoc322;
|FIN;

|PROCESO dsmoc322Oper;

     #espejo@#0 = #dsmoc322#0;
     #espejo@#1 = #dsmoc322#1;
     #espejo@#2 = #dsmoc322#2;
     #espejo@#3 = #dsmoc322#3;
     #espejo@#4 = #dsmoc322#4 + 1;
     #espejo@#5 = #dsmoc322#5;
     #espejo@#6 = #dsmoc322#6;
     #espejo@#7 = #dsmoc322#7;
     |LEE 041#espejo@.=;
     |SI FSalida = 0; |ACABA; |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 1;
         #dsm32201#121 = #dsm32201#121 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 17;
         #dsm32201#122 = #dsm32201#122 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 9;
         #dsm32201#137 = #dsm32201#137 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 16;
         #dsm32201#137 = #dsm32201#137 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 10;
         #dsm32201#138 = #dsm32201#138 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 11;
         #dsm32201#138 = #dsm32201#138 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 12;
         #dsm32201#124 = #dsm32201#124 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 4;
         #dsm32201#125 = #dsm32201#125 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 7;
         #dsm32201#126 = #dsm32201#126 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 2;
         #dsm32201#127 = #dsm32201#127 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 3;
         #dsm32201#139 = #dsm32201#139 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 8;
         #dsm32201#140 = #dsm32201#140 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 5;
         #dsm32201#141 = #dsm32201#141 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 6;
         #dsm32201#142 = #dsm32201#142 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 13;
         #dsm32201#128 = #dsm32201#128 + #dsmoc322#12;
     |FINSI;

     |SI #dsmoc322#6 = 3;  |Y #dsmoc322#7 = 14;
         #dsm32201#143 = #dsm32201#143 + #dsmoc322#12;
     |FINSI;
|FPRC;

|DEFBUCLE dsmoc322Oper;
     #dsmoc322#1;
     ;
     enEmpresa, enEjer, 01, enModelo, 00, 01, 3,  0;
     enEmpresa, enEjer, 12, enModelo, 99, 99, 4, 99;
     ;
     NULL, dsmoc322Oper;
|FIN;

|PROCESO dsm32201Otros;
     #dsm32201#84  = #dsm32201#84 + #dsm32201@#85;
|FPRC;

|DEFBUCLE dsm32201Otros;
     #dsm32201@#1006;
     ;
     #dsm32201#0, #dsm32201#1, #dsm32201#2, #dsm32201#3,        0, #dsm32201#5;
     #dsm32201#0, #dsm32201#1, #dsm32201#2, #dsm32201#3, nHComple, #dsm32201#5;
     ;
     NULL, dsm32201Otros;
|FIN;

|PROCESO CapturaOtros322;
     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/dsm32201.mas";
     |CARGA_DEF aMas, dsm32201@;

     nHComple     = #dsm32201#4 - 1;
     |BUCLE dsm32201Otros;

     |DESCARGA_DEF #dsm32201@;
|FPRC;

|PROCESO Totales;
     |SI nIVA1 = 1;  #dsm32201#15 = (#dsm32201#16 / #dsm32201#14) * 100;   |FINSI;
     |SI nIVA2 = 1;  #dsm32201#18 = (#dsm32201#19 / #dsm32201#17) * 100;   |FINSI;
     |SI nIVA3 = 1;  #dsm32201#21 = (#dsm32201#22 / #dsm32201#20) * 100;   |FINSI;
     |SI nIVA4 = 1;  #dsm32201#26 = (#dsm32201#27 / #dsm32201#25) * 100;   |FINSI;
     |SI nIVA5 = 1;  #dsm32201#29 = (#dsm32201#30 / #dsm32201#28) * 100;   |FINSI;
     |SI nIVA6 = 1;  #dsm32201#32 = (#dsm32201#33 / #dsm32201#31) * 100;   |FINSI;
     |SI nIVA7 = 1;  #dsm32201#41 = (#dsm32201#42 / #dsm32201#40) * 100;   |FINSI;
     |SI nIVA8 = 1;  #dsm32201#44 = (#dsm32201#45 / #dsm32201#43) * 100;   |FINSI;
     |SI nIVA9 = 1;  #dsm32201#47 = (#dsm32201#48 / #dsm32201#46) * 100;   |FINSI;

     #dsm32201#91 = nPro;
     #dsm32201#92 = eaProrrat;

     #dsm32201#51 = #dsm32201#16 + #dsm32201#19 + #dsm32201#22 + #dsm32201#24;
     #dsm32201#51 = #dsm32201#51 + #dsm32201#27 + #dsm32201#30 + #dsm32201#33;
     #dsm32201#51 = #dsm32201#51 + #dsm32201#35 + #dsm32201#37 + #dsm32201#39;
     #dsm32201#51 = #dsm32201#51 + #dsm32201#42 + #dsm32201#45 + #dsm32201#48;
     #dsm32201#51 = #dsm32201#51 + #dsm32201#50;

     |SI enPeriodo = 12;
         #dsm32201#74 = #dsm32201#74 + enImpProrrat36;
     |FINSI;

     #dsm32201#75 = #dsm32201#53 + #dsm32201#55 + #dsm32201#57 + #dsm32201#59;
     #dsm32201#75 = #dsm32201#75 + #dsm32201#61 + #dsm32201#63 + #dsm32201#65;
     #dsm32201#75 = #dsm32201#75 + #dsm32201#67 + #dsm32201#69 + #dsm32201#71;
     #dsm32201#75 = #dsm32201#75 + #dsm32201#72 + #dsm32201#73 + #dsm32201#74;

     #dsm32201#77 = #dsm32201#51 - #dsm32201#75 + #dsm32201#76;
     #dsm32201#78 = #dsm32201#78 / nContador;

     |SI nContador = 0;
         #dsm32201#78 = 100;
     |FINSI;

     #dsm32201#84 = 0;
     |SI #dsm32201#4 > 0;
         |HAZ CapturaOtros322;
     |FINSI;

     #dsm32201#79 = #dsm32201#77 % #dsm32201#78;
     #dsm32201#81 = nEjerAnt;
     #dsm32201#83 = #dsm32201#79 + #dsm32201#80 - #dsm32201#81 + #dsm32201#82;
     #dsm32201#85 = #dsm32201#83 - #dsm32201#84;

     |SI #dsm32201#89 ! 0;  |O #dsm32201#90 ! 0;
         #dsm32201#11 = "S";
     |FINSI;
|FPRC;

|PROCESO PonActividades;
     aAlfa = #agicen14#5 % -104;
     |SI aAlfa ! "0000";
         aAlfa = "31.12." + #dsm32201#1;
         |SI #agicen14#5 > aAlfa;
             |ACABA;
         |FINSI;
     |FINSI;

     aAlfa = #agicen14#6 % -104;
     |SI aAlfa ! "0000";
         aAlfa = "01.01." + #dsm32201#1;
         |SI #agicen14#6 < aAlfa;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI #agicen14#7 = 1;   |ACABA;  |FINSI;
     |SI #agicen14#7 = 3;   |ACABA;  |FINSI;
     |SI #agicen14#7 = 9;   |ACABA;  |FINSI;

     |PARA nCampo = 96;  |SI nCampo [ 116;  |HACIENDO nCampo = nCampo + 4;
           nCampo1 = nCampo + 1;
           nCampo2 = nCampo + 2;
           nCampo3 = nCampo + 3;
           |SI #dsm32201#nCampo#  = 0;
               #dsm32201#nCampo#  = #agicen14#1;
               #dsm32201#nCampo1# = #agicen14#3;
               #dsm32201#nCampo2# = #agicen14#4;


               |SI #agicen14#16 = 1;  |O #agicen14#16 = 2;
                   #dsm32201#nCampo3# = 1;
               |FINSI;

               |SI #agicen14#16 = 4;  |O #agicen14#16 = 5;
                   #dsm32201#nCampo3# = 2;
               |FINSI;

               |SI #agicen14#16 = 3;
                   #dsm32201#nCampo3# = 1;
               |FINSI;

               |SI #agicen14#16 = 6;
                   #dsm32201#nCampo3# = 6;
               |FINSI;

               |SI #agicen14#3 = "8612"; |O #agicen14#3 = "8611";
                   #dsm32201#nCampo3# = 3;
               |FINSI;

               |SI #agicen14#3 = "9999";  |Y #agicen14#16 = 3;
                   #dsm32201#nCampo3# = 4;
               |FINSI;

               |SI #agicen14#3 = "9999";  |Y #agicen14#16 = 6;
                   #dsm32201#nCampo3# = 6;
               |FINSI;

               |SI #dsm32201#nCampo3# = 0;  |O #dsm32201#nCampo3# = 4;
                |O #dsm32201#nCampo3# = 5;  |O #dsm32201#nCampo3# = 6;
                   #dsm32201#nCampo1# = "";
               |FINSI;

               |SI #dsm32201#nCampo1# = "9999";
                   #dsm32201#nCampo1# = "";
               |FINSI;

               |SAL;
           |FINSI;
     |SIGUE;
|FPRC;

|PROCESO dsmom008;
     #agicen14#0 = #dsmom008#0;
     #agicen14#1 = #dsmom008#5;
     |LEE 000#agicen14.=;
     |SI FSalida ! 0;
         |DDEFECTO #agicen14;
          #agicen14#0 = #dsmom008#0;
          #agicen14#1 = #dsmom008#5;
     |FINSI;

     |HAZ PorHistorico;

     |SI #agicen14#7 = 11;  |O #agicen14#7 = 13;
         #dsm32201#10 = "S";
     |FINSI;

     |SI enNoMod390 = 1;
         |HAZ PonActividades;
     |FINSI;
|FPRC;

|DEFBUCLE dsmom008;
     #dsmom008#1;
     ;
     enEmpresa, enEjer, enPeriodo, enModelo, enComplem, 01;
     enEmpresa, enEjer, enPeriodo, enModelo, enComplem, 95;
     ;
     NULL, dsmom008;
|FIN;

|PROCESO GrabaModelo;

     |HAZ eLeeLaProrrata;
     nPro = nProrrata;
     nProrrata = 100;
     |ABRE #dsmom006;
     |DDEFECTO #dsmom006;
     #dsmom006#0 = enEmpresa;
     #dsmom006#1 = enModelo;
     |LEE 041#dsmom006.=;
     |CIERRA #dsmom006;

     #dsm32201#0 = enEmpresa;
     #dsm32201#1 = enEjer;
     #dsm32201#2 = enPeriodo;
     #dsm32201#3 = enModelo;
     #dsm32201#4 = enComplem;
     #dsm32201#5 = 0;
     |LEE 101#dsm32201.=;
     |SI FSalida ! 0;
         |HAZ RecogeAnter;

         |DDEFECTO #dsm32201;
         #dsm32201#0  = enEmpresa;
         #dsm32201#1  = enEjer;
         #dsm32201#2  = enPeriodo;
         #dsm32201#3  = enModelo;
         #dsm32201#4  = enComplem;
         #dsm32201#5  = 0;

         #dsm32201#9  = aGuardo9;
         #dsm32201#11 = aGuardo11;
         #dsm32201#12 = aGuardo12;
         #dsm32201#13 = aGuardo13;
         #dsm32201#81 = nEjerAnt;
         #dsm32201#76 = nGuardo76;
         #dsm32201#80 = nGuardo77;
         #dsm32201#130 = aGuardo130;
         #dsm32201#131 = aGuardo131;
         #dsm32201#132 = aGuardo132;
         #dsm32201#144 = aGuardo144;

         #dsm32201#6  = #dsmom006#15;

         eaNumero     = #dsmom006#15;
         |HAZ eVerREGE;
         #dsmom006#14 = eaDominante;
         #dsmom006#16 = eaCifDom;

                                  #dsm32201#7 = "2";
         |SI #dsmom006#14 = "D";  #dsm32201#7 = "1";  |FINSI;

         #dsm32201#8 = #dsmom006#16;

         |GRABA 020#dsm32201.b;
     |FINSI;

     nEjerAnt  = #dsm32201#81;
     nContador = 0;
     nIVA1     = 0;
     nIVA2     = 0;
     nIVA3     = 0;
     nIVA4     = 0;
     nIVA5     = 0;
     nIVA6     = 0;
     nIVA7     = 0;
     nIVA8     = 0;
     nIVA9     = 0;

     nLRGral      = 0;
     nLRGral99    = 0;
     enExistencia = 0;
     nContador    = 0;
     |BUCLE dsmoc322;

     |SI enNoMod390 = 1;
         |DBASE aBase;  |QBF aBase;
         aMas = aBase + "def/dsmoc322.mas";
         |CARGA_DEF aMas, espejo@;
         |ABRE #espejo@;
         |BUCLE dsmoc322Oper;
         |CIERRA #espejo@;
         |DESCARGA_DEF #espejo@;
     |FINSI;

     |SI enExistencia = 0;
         |BORRA 020#dsm32201.a;
         |LIBERA #dsm32201;
         |ACABA;
     |FINSI;

     |HAZ Totales;

     |ABRE #agicen14;
     |ABRE #agicen30;
     |BUCLE dsmom008;
     |CIERRA #agicen30;
     |CIERRA #agicen14;

     |SI enNoMod390 = 1;
         #dsm32201#129 = #dsm32201#121 + #dsm32201#122 + #dsm32201#123;
         #dsm32201#129 = #dsm32201#129 + #dsm32201#124 + #dsm32201#125;
         #dsm32201#129 = #dsm32201#129 + #dsm32201#126 + #dsm32201#127;
         #dsm32201#129 = #dsm32201#129 - #dsm32201#128;

         #dsm32201#129 = #dsm32201#129 + #dsm32201#137 + #dsm32201#138;
         #dsm32201#129 = #dsm32201#129 + #dsm32201#139 + #dsm32201#140;
         #dsm32201#129 = #dsm32201#129 + #dsm32201#141 + #dsm32201#142;
         #dsm32201#129 = #dsm32201#129 - #dsm32201#143;

         |SI enSwProrr ! 2;
             |HAZ CreaLinProrrata;
         |FINSI;
     |FINSI;

     #dsm32201#130 = "N";
     |SI #dsm32201#2 = 12;
         #dsm32201#130 = "S";
         |SI #dsm32201#129 = 0;
             #dsm32201#130 = "N";
         |FINSI;
         #dsm32201#144 = "S";
     |FINSI;
     |SI #dsm32201#2 ! 12;
         #dsm32201#130 = "N";
         #dsm32201#144 = " ";
     |FINSI;

     |GRABA 020#dsm32201.a;
     |LIBERA #dsm32201;

     enExistencia = 1;
|FPRC;

|PROCESO CreaVentana;
     |VENTANA 1402, 3798, nPanta303, -1, "";
     nVentTrab = FSalida;
|FPRC;

|PROCESO Btn10;
     |SI #dsm32201#9 = "S";
         #dsm32201#9 = "N";
         #dsmow214#3 = "N";
         #dsmow225#3 = "N";
         #dsmow228#3 = "N";
     |SINO;
         #dsm32201#9 = "S";
         #dsmow214#3 = "S";
         #dsmow225#3 = "S";
         #dsmow228#3 = "S";

         |SI #dsm32201#131 = "S";
             #dsm32201#131 = "N";
             #dsmow225#9   = "N";
             #dsmow228#9   = "N";
             |SI nSw = 1; |PINTA #dsmow225#9; |FINSI;
             |SI nSw = 2; |PINTA #dsmow228#9; |FINSI;
         |FINSI;
     |FINSI;

     |SI nSw = 0;  |PINTA #dsmow214#3; |FINSI;
     |SI nSw = 1;  |PINTA #dsmow225#3; |FINSI;
     |SI nSw = 2;  |PINTA #dsmow228#3; |FINSI;
|FPRC;

|PROCESO Btn11;
     |SI #dsm32201#12 = "S";
         #dsm32201#12 = "N";
         #dsmow214#6  = "N";
         #dsmow225#6  = "N";
         #dsmow228#6  = "N";
     |SINO;
         #dsm32201#12 = "S";
         #dsmow214#6  = "S";
         #dsmow225#6  = "S";
         #dsmow228#6  = "S";
     |FINSI;

     |SI nSw = 0;  |PINTA #dsmow214#6; |FINSI;
     |SI nSw = 1;  |PINTA #dsmow225#6; |FINSI;
     |SI nSw = 2;  |PINTA #dsmow228#6; |FINSI;
|FPRC;

|PROCESO Btn12;
     |SI #dsm32201#13 = "S";
         #dsm32201#13 = "N";
         #dsmow214#7  = "N";
         #dsmow225#7  = "N";
         #dsmow228#7  = "N";
     |SINO;
         #dsm32201#13 = "S";
         #dsmow214#7  = "S";
         #dsmow225#7  = "S";
         #dsmow228#7  = "S";
     |FINSI;

     |SI nSw = 0; |PINTA #dsmow214#7; |FINSI;
     |SI nSw = 1; |PINTA #dsmow225#7; |FINSI;
     |SI nSw = 2; |PINTA #dsmow228#7; |FINSI;
|FPRC;

|PROCESO Btn131;
     |SI #dsm32201#131 = "S";
         #dsm32201#131 = "N";
         #dsmow214#9  = "N";
         #dsmow225#9  = "N";
         #dsmow228#9  = "N";
     |SINO;
         #dsm32201#131 = "S";
         #dsmow214#9  = "S";
         #dsmow225#9  = "S";
         #dsmow228#9  = "S";

         |SI #dsm32201#9 = "S";
             #dsm32201#9 = "N";
             #dsmow225#3 = "N";
             #dsmow228#3 = "N";
             |SI nSw = 1; |PINTA #dsmow225#3; |FINSI;
             |SI nSw = 2; |PINTA #dsmow228#3; |FINSI;
         |FINSI;
     |FINSI;

     |SI nSw = 0;  |PINTA #dsmow214#9;  |FINSI;
     |SI nSw = 1;  |PINTA #dsmow225#9;  |FINSI;
     |SI nSw = 2;  |PINTA #dsmow228#9;  |FINSI;
|FPRC;

|PROCESO Btn132;
     |SI #dsm32201#132 = "S";
         #dsm32201#132 = "N";
         #dsmow214#10  = "N";
         #dsmow225#10  = "N";
         #dsmow228#10  = "N";
     |SINO;
         #dsm32201#132 = "S";
         #dsmow214#10  = "S";
         #dsmow225#10  = "S";
         #dsmow228#10  = "S";
     |FINSI;

     |SI nSw = 0;  |PINTA #dsmow214#10;  |FINSI;
     |SI nSw = 1;  |PINTA #dsmow225#10;  |FINSI;
     |SI nSw = 2;  |PINTA #dsmow228#10;  |FINSI;
|FPRC;

|PROCESO Btn144;
     |SI #dsm32201#144 = "S";
         #dsm32201#144 = "N";
         #dsmow228#11  = "N";
     |SINO;
         #dsm32201#144 = "S";
         #dsmow228#11  = "S";
     |FINSI;

     |PINTA #dsmow228#11;
|FPRC;

|PROCESO Punto01_w214;
     |HAZ CreaVentana;

     #dsmow214#0  = #dsm32201#6;
     #dsmow214#1  = #dsm32201#7;
     #dsmow214#2  = #dsm32201#8;
     #dsmow214#3  = #dsm32201#9;
     #dsmow214#4  = #dsm32201#10;
     #dsmow214#5  = #dsm32201#11;
     #dsmow214#6  = #dsm32201#12;
     #dsmow214#7  = #dsm32201#13;
     #dsmow214#8  = #dsm32201#130;
     #dsmow214#9  = #dsm32201#131;
     #dsmow214#10 = #dsm32201#132;

     |PINPA #0#dsmow214;   nPanta214 = FSalida;
     |PINDA #0#dsmow214;

     |CONTROL_SIMPLE nPanta214, "BOTON,{{197}}", 1104, 1105, Btn10; nBtn10 = FSalida;

     |SI #dsm32201#2 = 12;
         |CONTROL_SIMPLE nPanta214, "BOTON,{{197}}", 1404, 1405, Btn11; nBtn11  = FSalida;
         |CONTROL_SIMPLE nPanta214, "BOTON,{{197}}", 1504, 1505, Btn12; nBtn12  = FSalida;
     |FINSI;

     |PTEC 802;  |PAUSA;

     |FOCOTECLADO nTree;
|FPRC;

|PROCESO Punto01_w225;
     |HAZ CreaVentana;

     nOk = 0;
     #dsmow225#0  = #dsm32201#6;
     #dsmow225#1  = #dsm32201#7;
     #dsmow225#2  = #dsm32201#8;
     #dsmow225#3  = #dsm32201#9;
     #dsmow225#4  = #dsm32201#10;
     #dsmow225#5  = #dsm32201#11;
     #dsmow225#6  = #dsm32201#12;
     #dsmow225#7  = #dsm32201#13;
     #dsmow225#8  = #dsm32201#130;
     #dsmow225#9  = #dsm32201#131;
     #dsmow225#10 = #dsm32201#132;

     |SI #dsmow225#4 = "S"; nOk = 1; |FINSI;
     |SI #dsmow225#5 = "S"; nOk = 1; |FINSI;
     |SI #dsmow225#6 = "S"; nOk = 1; |FINSI;
     |SI #dsmow225#7 = "S"; nOk = 1; |FINSI;
     |SI #dsmow225#8 = "S"; nOk = 1; |FINSI;

     |SI #dsmow225#9  = " "; #dsmow225#9 = "N"; |FINSI;

     |PINPA #0#dsmow225;   nPanta225 = FSalida;
     |PINDA #0#dsmow225;

     |CONTROL_SIMPLE nPanta225, "BOTON,{{197}}", 1104, 1105, Btn10; nBtn10 = FSalida;

     |SI #dsm32201#2 = 12;
         |CONTROL_SIMPLE nPanta225, "BOTON,{{197}}", 1404, 1405, Btn11; nBtn11  = FSalida;
         |CONTROL_SIMPLE nPanta225, "BOTON,{{197}}", 1504, 1505, Btn12; nBtn12  = FSalida;
     |FINSI;

     |SI nOk = 0;
         |CONTROL_SIMPLE nPanta225, "BOTON,{{197}}", 2304, 2305, Btn131; nBtn131 = FSalida;
     |FINSI;

     |PTEC 802;  |PAUSA;

     |FOCOTECLADO nTree;
|FPRC;

|PROCESO Punto01_w228;
     |HAZ CreaVentana;

     nOk = 0;
     #dsmow228#0  = #dsm32201#6;
     #dsmow228#1  = #dsm32201#7;
     #dsmow228#2  = #dsm32201#8;
     #dsmow228#3  = #dsm32201#9;
     #dsmow228#4  = #dsm32201#10;
     #dsmow228#5  = #dsm32201#11;
     #dsmow228#6  = #dsm32201#12;
     #dsmow228#7  = #dsm32201#13;
     #dsmow228#8  = #dsm32201#130;
     #dsmow228#9  = #dsm32201#131;
     #dsmow228#10 = #dsm32201#132;
     #dsmow228#11 = #dsm32201#144;

     |SI #dsmow228#4 = "S"; nOk = 1; |FINSI;
     |SI #dsmow228#5 = "S"; nOk = 1; |FINSI;
     |SI #dsmow228#6 = "S"; nOk = 1; |FINSI;
     |SI #dsmow228#7 = "S"; nOk = 1; |FINSI;
     |SI #dsmow228#8 = "S"; nOk = 1; |FINSI;

     |SI #dsmow228#9   = " ";
         #dsmow228#9   = "N";
         #dsm32201#131 = "N";
     |FINSI;
     |SI #dsmow228#11  = " ";
         #dsmow228#11  = "S";
         #dsm32201#144 = "S";
     |FINSI;

     |PINPA #0#dsmow228;   nPanta228 = FSalida;
     |PINDA #0#dsmow228;

     |CONTROL_SIMPLE nPanta228, "BOTON,{{197}}", 1104, 1105, Btn10; nBtn10 = FSalida;

     |SI #dsm32201#2 = 12;
         |CONTROL_SIMPLE nPanta228, "BOTON,{{197}}", 1404, 1405, Btn11;  nBtn11  = FSalida;
         |CONTROL_SIMPLE nPanta228, "BOTON,{{197}}", 1504, 1505, Btn12;  nBtn12  = FSalida;
     |FINSI;

     |SI nOk = 0;
         |CONTROL_SIMPLE nPanta228, "BOTON,{{197}}", 2304, 2305, Btn131; nBtn131 = FSalida;
     |FINSI;

     |PTEC 802;  |PAUSA;

     |FOCOTECLADO nTree;
|FPRC;

|PROCESO Punto01;
     nSw = 0;
     |SI #dsm32201#1 = 2018; |Y #dsm32201#2 ] 2;  nSw = 1; |FINSI;
     |SI #dsm32201#1 = 2018; |Y #dsm32201#2 = 12; nSw = 2; |FINSI;
     |SI #dsm32201#1 > 2018;                      nSw = 2; |FINSI;

     |SI nSw = 0;  |HAZ Punto01_w214;  |FINSI;
     |SI nSw = 1;  |HAZ Punto01_w225;  |FINSI;
     |SI nSw = 2;  |HAZ Punto01_w228;  |FINSI;
|FPRC;

|PROCESO Punto02;
     |HAZ CreaVentana;

     |PARA nDCampo = 0;  |SI nDCampo [ 37;  |HACIENDO nDCampo = nDCampo + 1;
           nHCampo = nDCampo + 14;
           #dsmow215#nDCampo# = #dsm32201#nHCampo#;
     |SIGUE;

     |PINPA #0#dsmow215;
     |PINDA #0#dsmow215;

     |PTEC 802;  |PAUSA;

     |FOCOTECLADO nTree;
|FPRC;

|PROCESO Punto03;
     |HAZ CreaVentana;

     |PARA nDCampo = 0;  |SI nDCampo [ 23;  |HACIENDO nDCampo = nDCampo + 1;
           nHCampo = nDCampo + 52;
           #dsmow216#nDCampo# = #dsm32201#nHCampo#;
     |SIGUE;

     |PINPA #0#dsmow216;
     |PINDA #0#dsmow216;

     |PTEC 802;  |PAUSA;

     |FOCOTECLADO nTree;
|FPRC;

|PROCESO Btn217_0;
     |C_M #dsmow217#0, 1, "S";

     |ENCAMPO #0#dsmow217;

     #dsm32201#76 = #dsmow217#0;

     nEjerAnt  = #dsm32201#81;
     |HAZ Totales;

     |PARA nDCampo = 0;  |SI nDCampo [ 9;  |HACIENDO nDCampo = nDCampo + 1;
           nHCampo = nDCampo + 76;
           #dsmow217#nDCampo# = #dsm32201#nHCampo#;
     |SIGUE;

     |C_M #dsmow217#0, 1, "N";

     |PINDA #0#dsmow217;
|FPRC;

|PROCESO Btn217_4;
     |C_M #dsmow217#4, 1, "S";

     |ENCAMPO #4#dsmow217;

     #dsm32201#80 = #dsmow217#4;

     nEjerAnt  = #dsm32201#81;
     |HAZ Totales;

     |PARA nDCampo = 0;  |SI nDCampo [ 9;  |HACIENDO nDCampo = nDCampo + 1;
           nHCampo = nDCampo + 76;
           #dsmow217#nDCampo# = #dsm32201#nHCampo#;
     |SIGUE;

     |C_M #dsmow217#4, 1, "N";

     |PINDA #0#dsmow217;
|FPRC;

|PROCESO Punto04;   ||resultados
     |HAZ CreaVentana;

     |PARA nDCampo = 0;  |SI nDCampo [ 9;  |HACIENDO nDCampo = nDCampo + 1;
           nHCampo = nDCampo + 76;
           #dsmow217#nDCampo# = #dsm32201#nHCampo#;
     |SIGUE;

     |PINPA #0#dsmow217;  nPanta217 = FSalida;
     |PINDA #0#dsmow217;

     |CONTROL_SIMPLE nPanta217, "BOTON,{{197}}", 0780, 0782, Btn217_0;
     |CONTROL_SIMPLE nPanta217, "BOTON,{{197}}", 1080, 1082, Btn217_4;

     |PTEC 802;  |PAUSA;

     |FOCOTECLADO nTree;
|FPRC;

|PROCESO Punto05;
     |HAZ CreaVentana;

     |PARA nDCampo = 0;  |SI nDCampo [ 4;  |HACIENDO nDCampo = nDCampo + 1;
           nHCampo = nDCampo + 86;
           #dsmow218#nDCampo# = #dsm32201#nHCampo#;
     |SIGUE;

     |PINPA #0#dsmow218;
     |PINDA #0#dsmow218;

     |PTEC 802;  |PAUSA;

     |FOCOTECLADO nTree;
|FPRC;

|PROCESO Cancelar;
     |PTEC 807;
|FPRC;

|PROCESO Validar;
     |PTEC 806;
|FPRC;

|PROCESO Modw226;
     nIdSalir = 0;
     InNivel   = nNivel1<-;
     nNivel1   = 0;
     |ESPECIFICA "IDBOTONTECLA", nNivel;

     nIdSalir = nNivel2;
     |ESTADO_CONTROL nIdSalir, "HIDE";

     |ESTADO_CONTROL nTree,      "DISABLE";
     |ESTADO_CONTROL nBtnMod226, "DISABLE";

     |CONTROL_SIMPLE nPanta226, "BOTON,{{206}}Validar", 3072, 3084,  Validar;
     nBtnVal = FSalida;

     |CONTROL_SIMPLE nPanta226, "BOTON,{{207}}Cancelar", 3086, 3098, Cancelar;
     nBtnCan = FSalida;

     |ENDATOS #1#dsmow226;
     |SI FSalida = 0;
         |PARA nDCampo = 0;  |SI nDCampo [ 24;  |HACIENDO nDCampo = nDCampo + 1;
               nHCampo = nDCampo + 96;
               #dsm32201#nHCampo# = #dsmow226#nDCampo#;
         |SIGUE;
     |FINSI;
     #dsm32201#133 = #dsmow226#25;
     #dsm32201#134 = #dsmow226#26;
     #dsm32201#135 = #dsmow226#27;
     #dsm32201#136 = #dsmow226#28;
     #dsm32201#145 = #dsmow226#29;

     |ESTADO_CONTROL nTree,      "ENABLE";
     |ESTADO_CONTROL nIdSalir,   "SHOW";
     |ESTADO_CONTROL nBtnMod226, "ENABLE";

     |FIN_CONTROL_WINDOWS nBtnVal;
     |FIN_CONTROL_WINDOWS nBtnCan;
|FPRC;

|PROCESO Punto09;
     |HAZ CreaVentana;

     |PARA nDCampo = 0;  |SI nDCampo [ 24;  |HACIENDO nDCampo = nDCampo + 1;
           nHCampo = nDCampo + 96;
           #dsmow226#nDCampo# = #dsm32201#nHCampo#;
     |SIGUE;

     #dsmow226#25 = #dsm32201#133;
     #dsmow226#26 = #dsm32201#134;
     #dsmow226#27 = #dsm32201#135;
     #dsmow226#28 = #dsm32201#136;
     #dsmow226#29 = #dsm32201#145;

     |PINPA #0#dsmow226; nPanta226 = FSalida;
     |PINDA #0#dsmow226;

     |CONTROL_SIMPLE nPanta226, "BOTON,{{197}}Modificar", 3002, 3013, Modw226;
     nBtnMod226 = FSalida;

     |PTEC 802;  |PAUSA;

     |FOCOTECLADO nTree;
|FPRC;

|PROCESO Modw221;
     nIdSalir = 0;
     InNivel   = nNivel1<-;
     nNivel1   = 0;
     |ESPECIFICA "IDBOTONTECLA", nNivel;

     nIdSalir = nNivel2;
     |ESTADO_CONTROL nIdSalir, "HIDE";

     |ESTADO_CONTROL nTree,      "DISABLE";
     |ESTADO_CONTROL nBtnMod221, "DISABLE";

     |CONTROL_SIMPLE nPanta221, "BOTON,{{206}}Validar", 3072, 3084,  Validar;
     nBtnVal = FSalida;

     |CONTROL_SIMPLE nPanta221, "BOTON,{{207}}Cancelar", 3086, 3098, Cancelar;
     nBtnCan = FSalida;

     |ENDATOS #1#dsmow221;
     |SI FSalida = 0;
         |PARA nDCampo = 0;  |SI nDCampo [ 15;  |HACIENDO nDCampo = nDCampo + 1;
               |SI nDCampo [ 8; nHCampo = nDCampo + 121; |FINSI;
               |SI nDCampo > 8; nHCampo = nDCampo + 128; |FINSI;
               #dsm32201#nHCampo# = #dsmow221#nDCampo#;
         |SIGUE;
         |SI #dsm32201#1 ] 2018; |Y #dsm32201#2 = 12;
             #dsm32201#130 = "N";
             |SI #dsm32201#129 ! 0;
                 #dsm32201#130 = "S";
             |FINSI;
         |FINSI;
     |FINSI;

     |ESTADO_CONTROL nTree,      "ENABLE";
     |ESTADO_CONTROL nIdSalir,   "SHOW";
     |ESTADO_CONTROL nBtnMod221, "ENABLE";

     |FIN_CONTROL_WINDOWS nBtnVal;
     |FIN_CONTROL_WINDOWS nBtnCan;
|FPRC;

|PROCESO Punto10;
     |HAZ CreaVentana;

     #dsmow221#0  = #dsm32201#121;
     #dsmow221#1  = #dsm32201#122;
     #dsmow221#2  = #dsm32201#123;
     #dsmow221#3  = #dsm32201#124;
     #dsmow221#4  = #dsm32201#125;
     #dsmow221#5  = #dsm32201#126;
     #dsmow221#6  = #dsm32201#127;
     #dsmow221#7  = #dsm32201#128;
     #dsmow221#8  = #dsm32201#129;
     #dsmow221#9  = #dsm32201#137;
     #dsmow221#10 = #dsm32201#138;
     #dsmow221#11 = #dsm32201#139;
     #dsmow221#12 = #dsm32201#140;
     #dsmow221#13 = #dsm32201#141;
     #dsmow221#14 = #dsm32201#142;
     #dsmow221#15 = #dsm32201#143;

     |PINPA #0#dsmow221; nPanta221 = FSalida;
     |PINDA #0#dsmow221;

     |CONTROL_SIMPLE nPanta221, "BOTON,{{197}}Modificar", 3002, 3013, Modw221;
     nBtnMod221 = FSalida;

     |PTEC 802;  |PAUSA;

     |FOCOTECLADO nTree;

|FPRC;

|PROCESO Modw222;
     |LEE 101#dsm32204.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     nIdSalir  = 0;
     InNivel   = nNivel1<-;
     nNivel1   = 0;
     |ESPECIFICA "IDBOTONTECLA", nNivel;

     nIdSalir = nNivel2;
     |ESTADO_CONTROL nIdSalir,   "HIDE";
     |ESTADO_CONTROL nTree,      "DISABLE";
     |ESTADO_CONTROL nBtnMod222, "DISABLE";

     |CONTROL_SIMPLE nPanta222, "BOTON,{{206}}Validar", 3072, 3084,  Validar;
     nBtnVal = FSalida;

     |CONTROL_SIMPLE nPanta222, "BOTON,{{207}}Cancelar", 3086, 3098, Cancelar;
     nBtnCan = FSalida;

     |ENDATOS #1#dsmow222;
     |SI FSalida = 0;
         #dsm32204#4  = #dsmow222#0;
         #dsm32204#5  = #dsmow222#1;
         #dsm32204#6  = #dsmow222#2;
         #dsm32204#7  = #dsmow222#3;
         #dsm32204#8  = #dsmow222#4;
         #dsm32204#9  = #dsmow222#5;
         #dsm32204#10 = #dsmow222#6;

         |GRABA 020#dsm32204.a;
     |FINSI;
     |LIBERA #dsm32204;

     |FIN_CONTROL_WINDOWS nBtnVal;
     |FIN_CONTROL_WINDOWS nBtnCan;

     |ESTADO_CONTROL nIdSalir,   "SHOW";
     |ESTADO_CONTROL nTree,      "ENABLE";
     |ESTADO_CONTROL nBtnMod222, "ENABLE";

     |REFRESCACONTROL nGrid04;
     |FOCOTECLADO nGrid04;
|FPRC;

|PROCESO Evt04;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#dsm32204.=;

         #dsmow222#0  = #dsm32204#4;   |PINTA #dsmow222#0;
         #dsmow222#1  = #dsm32204#5;   |PINTA #dsmow222#1;
         #dsmow222#2  = #dsm32204#6;   |PINTA #dsmow222#2;
         #dsmow222#3  = #dsm32204#7;   |PINTA #dsmow222#3;
         #dsmow222#4  = #dsm32204#8;   |PINTA #dsmow222#4;
         #dsmow222#5  = #dsm32204#9;   |PINTA #dsmow222#5;
         #dsmow222#6  = #dsm32204#10;  |PINTA #dsmow222#6;

         |ESTADO_CONTROL nBtnMod222, "ENABLE";
     |FINSI;
|FPRC;

|PROCESO Baja04;
     #dsm32204#0 = enEmpresa;
     #dsm32204#1 = enEjer;
     #dsm32204#2 = enModelo;
     #dsm32204#3 = enComplem;
     #dsm32204#4 = 01;
|FPRC;

|PROCESO Alta04;
     #dsm32204#0 = enEmpresa;
     #dsm32204#1 = enEjer;
     #dsm32204#2 = enModelo;
     #dsm32204#3 = enComplem;
     #dsm32204#4 = 99;
|FPRC;

|PROCESO Punto11;
     |HAZ CreaVentana;

     |PINPA #0#dsmow222; nPanta222 = FSalida;

     |PTEC 802;  |PAUSA;

     |DDEFECTO #dsmow222;
     |PINDA #0#dsmow222;

     |CONTROL_SIMPLE nPanta222, "BOTON,{{197}}Modificar", 1786, 1798, Modw222;
     nBtnMod222 = FSalida;

     |ESTADO_CONTROL nBtnMod222, "DISABLE";

     nRango = 2 + 4 + 8 + 32 + 128;

     |LINEAL_SIMPLE #1#dsm32204, nRango, 0502, 1698, Baja04, Alta04, Evt04;
     nGrid04 = FSalida;

     |PTEC 802;  |PAUSA;

     |FOCOTECLADO nTree;
|FPRC;

|PROCESO Iguala223;
    |DDEFECTO #dsm32205;
    #dsm32205#0 = #dsm32201#0;
    #dsm32205#1 = #dsm32201#1;
    #dsm32205#2 = #dsm32201#3;
    #dsm32205#3 = #dsm32201#4;
    #dsm32205#4 = nLinea;
    |LEE 141#dsm32205.=;
    nEstado = FSalida;

    nNume1 = 1; |SI #dsm32205#4 = 2; nNume1 = 20; |FINSI;
    nNume2 = nNume1 + 17;
    nNume3 = 5;
    |PARA nDCampo = nNume1;  |SI nDCampo [ nNume2;  |HACIENDO nDCampo = nDCampo + 1;
          |SI nOpera = 1; #dsm32205#nNume3# = #dsmow223#nDCampo#; |FINSI;
          |SI nOpera = 4; #dsmow223#nDCampo# = #dsm32205#nNume3#; |FINSI;
          nNume3 = nNume3 + 1;
    |SIGUE;
    |SI nOpera = 1;
        |SI nEstado = 0; |GRABA 020#dsm32205.a; |FINSI;
        |SI nEstado ! 0; |GRABA 020#dsm32205.n; |FINSI;
    |FINSI;

    |LIBERA #dsm32205;
|FPRC;

|PROCESO Modw223;
     nIdSalir = 0;
     InNivel   = nNivel1<-;
     nNivel1   = 0;
     |ESPECIFICA "IDBOTONTECLA", nNivel;

     nIdSalir = nNivel2;
     |ESTADO_CONTROL nIdSalir, "HIDE";

     |ESTADO_CONTROL nTree,      "DISABLE";
     |ESTADO_CONTROL nBtnMod223, "DISABLE";

     |CONTROL_SIMPLE nPanta223, "BOTON,{{206}}Validar", 3072, 3084,  Validar;
     nBtnVal = FSalida;

     |CONTROL_SIMPLE nPanta223, "BOTON,{{207}}Cancelar", 3086, 3098, Cancelar;
     nBtnCan = FSalida;

     |ENDATOS #1#dsmow223;
     |SI FSalida = 0;
         |ABRE #dsm32205;
         nOpera = 1;
         nLinea = 1; |HAZ Iguala223;
         nLinea = 2; |HAZ Iguala223;
         |CIERRA #dsm32205;
     |FINSI;

     |ESTADO_CONTROL nTree,      "ENABLE";
     |ESTADO_CONTROL nIdSalir,   "SHOW";
     |ESTADO_CONTROL nBtnMod223, "ENABLE";

     |FIN_CONTROL_WINDOWS nBtnVal;
     |FIN_CONTROL_WINDOWS nBtnCan;
|FPRC;

|PROCESO Punto12;
     |HAZ CreaVentana;

     |DDEFECTO #dsmow223;
     |ABRE #dsm32205;
     nOpera = 4;
     nLinea = 1; |HAZ Iguala223;
     nLinea = 2; |HAZ Iguala223;
     |CIERRA #dsm32205;

     |PINPA #0#dsmow223; nPanta223 = FSalida;
     |PINDA #0#dsmow223;

     |CONTROL_SIMPLE nPanta223, "BOTON,{{197}}Modificar", 3002, 3013, Modw223;
     nBtnMod223 = FSalida;

     |PTEC 802;  |PAUSA;

     |FOCOTECLADO nTree;
|FPRC;
|| aqui

|PROCESO EventoTree;
     |SI nPintaSalir = 0;  |ACABA;  |FINSI;
     |SI FEntrada ! 0;     |ACABA;  |FINSI;

     aAlfa = Contenido % -102;  |QBT aAlfa;

     |SI nGrid02 ! -1;
         |DESTRUYECONTROL nGrid02;
         nGrid02 = -1;
     |FINSI;

     |SI nGrid03 ! -1;
         |DESTRUYECONTROL nGrid03;
         nGrid03 = -1;
     |FINSI;

     |SI nVentTrab ! -1;
         |FINVENTANA nVentTrab;
         nVentTrab = -1;
     |FINSI;

     |SI aAlfa = "01";  |HAZ Punto01; |FINSI;
     |SI aAlfa = "02";  |HAZ Punto02; |FINSI;
     |SI aAlfa = "03";  |HAZ Punto03; |FINSI;
     |SI aAlfa = "04";  |HAZ Punto04; |FINSI;
     |SI aAlfa = "05";  |HAZ Punto05; |FINSI;
     |SI aAlfa = "09";  |HAZ Punto09; |FINSI;
     |SI aAlfa = "10";  |HAZ Punto10; |FINSI;
     |SI aAlfa = "11";  |HAZ Punto11; |FINSI;
     |SI aAlfa = "12";  |HAZ Punto12; |FINSI;
|FPRC;

|PROCESO TraeTxtComprimido;
     aAlfa = aRutaOrigen + aFicheroTar + " " + aFicheroTxt;
     |ATAR aAlfa, aRutaOrigen;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaOrigen + aFicheroTar;
          |XABRE "E", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     aAlfa = aRutaOrigen + aFicheroTar;
     |COMPRIME aAlfa;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaOrigen + aFicheroTgz;
          |XABRE "E", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     aAlfa = aRutaOrigen + aFicheroTxt;  |FBORRA aAlfa;
     aAlfa = aRutaOrigen + aFicheroTar;  |FBORRA aAlfa;

     aOrigen  = aRutaOrigen  + aFicheroTgz;
     aDestino = aRutaDestino + aFicheroTgz;

     |RFBORRA aDestino;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |SI aIPRemoto ! "";
         |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaDestino + aFicheroTgz;
          |XABRE "EC", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     Pos   = -1;
     aAlfa = aRutaDestino + aFicheroTgz;
     |RDESCOMPRIME aAlfa;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaDestino + aFicheroTar;
          |XABRE "EC", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     |RDETAR aAlfa, aRutaDestino;

     |PARA;  |SI;  |HACIENDO;
          aAbre = aRutaDestino + aFicheroTxt;
          |XABRE "EC", aAbre, nHandleTgz;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |PULSATECLA;
     |SIGUE;

     aAlfa = aRutaOrigen  + aFicheroTgz;  |FBORRA aAlfa;
     aAlfa = aRutaDestino + aFicheroTgz;  |RFBORRA aAlfa;
     aAlfa = aRutaDestino + aFicheroTar;  |RFBORRA aAlfa;
|FPRC;

|PROCESO CargaArbol;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO MontaArbol;
     |PTEC 802;  |PAUSA;

     |HAZ LeeUnidadBasico;

     |DBASE aBase;  |QBF aBase;
     aRutaOrigen  = aBase + "tmp";   |MKDIR aRutaOrigen;
     aRutaOrigen  = aRutaOrigen + "/";
     aRutaDestino = eaUnidadBasico + "\modelos";    |RMKDIR aRutaDestino;
     aRutaDestino = aRutaDestino + "\tmp";  |RMKDIR aRutaDestino;
     aRutaDestino = aRutaDestino + "\";

     aFicheroTxt  = "dsm3220101" + Usuario + ".txt";
     aFicheroTgz  = "dsm3220101" + Usuario + ".tgz";
     aFicheroTar  = "dsm3220101" + Usuario + ".tar";

     aAbre = aRutaOrigen + aFicheroTxt;

     sT_nID   = nTree;
     sT_nOper = 0;

     |XABRE "WB", aAbre, nHandle;

     nLinea  = 0;

     nLinea  = nLinea + 1;
     aAlfa   = nLinea + ":Identificacin {{01}}";
     |HAZ CargaArbol;

     nLinea  = nLinea + 1;
     aAlfa   = nLinea + ":Liquidacin (IVA Devengado) {{02}}";
     |HAZ CargaArbol;

     nLinea  = nLinea + 1;
     aAlfa   = nLinea + ":Liquidacin (IVA Deducible) {{03}}";
     |HAZ CargaArbol;

     nLinea  = nLinea + 1;
     aAlfa   = nLinea + ":Resultados {{04}}";
     |HAZ CargaArbol;

     nLinea  = nLinea + 1;
     aAlfa   = nLinea + ":Informacin adicional {{05}}";
     |HAZ CargaArbol;

     |SI enNoMod390 = 1;
         nLinea  = nLinea + 1;
         aAlfa   = nLinea + ":Exclusivamente a cumplimentar en el ultimo periodo de liquidacin";
         |HAZ CargaArbol;

         aAlfa   = nLinea + ",1:Actividades a las que se refiere la declaracin {{09}}";
         |HAZ CargaArbol;

         aAlfa   = nLinea + ",2:Operaciones realizadas en el ejercicio {{10}}";
         |HAZ CargaArbol;

         aAlfa   = nLinea + ",3:Prorrata {{11}}";
         |HAZ CargaArbol;

         aAlfa   = nLinea + ",4:Actividades con regmenes de deduccin diferenciados {{12}}";
         |HAZ CargaArbol;
     |FINSI;

     |XCIERRA nHandle;

     |HAZ TraeTxtComprimido;
     aAlfa = aRutaDestino + aFicheroTxt;

     aAlfa = "TREECTRL,Apartados {{" + aAlfa + "}}";
     |CONTROL_SIMPLE nPanta303, aAlfa, 0602, 1398, EventoTree;
     nTree = FSalida;

     aFicheroTxt   = "dsm3220101" + Usuario + ".txt";
     aAlfa         = aRutaDestino + aFicheroTxt;
     |RFBORRA aAlfa;

     sT_nID   = nTree;
     sT_nOper = 2;
     sT_aData = "1:";
     |ESPECIFICA "COMMANDCONTROL", sTree;

     sT_nID   = nTree;
     sT_nOper = 2;
     sT_aData = "0:";
     |ESPECIFICA "COMMANDCONTROL", sTree;
|FPRC;

|PROCESO MontaApartados;
     #dsm32201#0 = enEmpresa;
     #dsm32201#1 = enEjer;
     #dsm32201#2 = enPeriodo;
     #dsm32201#3 = enModelo;
     #dsm32201#4 = enComplem;
     #dsm32201#5 = enActividad;
     |LEE 101#dsm32201.=;
     |SI FSalida ! 0;
         |MENAV "0000No existe registro.";
         |ACABA;
     |FINSI;

     #dsm32201#130 = "N";
     |SI #dsm32201#2 = 12;
         #dsm32201#130 = "S";
         |SI #dsm32201#129 = 0;
             #dsm32201#130 = "N";
         |FINSI;
     |FINSI;
     |SI #dsm32201#2 ! 12;
         #dsm32201#144 = " ";
     |FINSI;

     |VENTANA 0501, 3899, -1, 0,  "";
     nVentana = FSalida;

     |PINPA #0#dsm32201;  nPanta303 = FSalida;

     enCodCli = enEmpresa;
     |HAZ LeePersona;

     aAlfa = "LABEL,{{15}}Modelo 322 (" + (("00000" + enEmpresa) % -105) + " " + #clientes@#2;  |QBF aAlfa;
     aAlfa = aAlfa + ")";
     |CONTROL_SIMPLE nPanta303, aAlfa, 0502, 0598, NULL;

     nPintaSalir = 0;
     |HAZ MontaArbol;

     aEsc1      = &255 + "806";
     aEsc2      = &255 + "807";
     aRetu      = &255 + "802";
     |PARA; |SI;  |HACIENDO;
         nPintaSalir = 1;
         FSalida = "::{{001}}Salir," + nTree;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
         |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;

     |GRABA 020#dsm32201.a;
     |LIBERA #dsm32201;

     |ABRE #dsmom004;
     #dsmom004#0 = enEmpresa;
     #dsmom004#1 = enEjer;
     #dsmom004#2 = enPeriodo;
     #dsmom004#3 = enModelo;
     #dsmom004#4 = enComplem;
     |LEE 1010#dsmom004.=;
     |SI FSalida = 0;
         #dsmom004#15 = #dsm32201#88;
         |GRABA 020#dsmom004.a;
         |LIBERA #dsmom004;
     |FINSI;
     |CIERRA #dsmom004;

     |PULSATECLA;

     |FINVENTANA nVentana;
|FPRC;


|PROCESO dsm32204B;
     |BORRA 020#dsm32204.a;
     |LIBERA #dsm32204;
|FPRC;

|DEFBUCLE dsm32204B;
     #dsm32204#1;
     ;
     #dsm32201#0,#dsm32201#1,#dsm32201#3,#dsm32201#4,01;
     #dsm32201#0,#dsm32201#1,#dsm32201#3,#dsm32201#4,99;
     be;
     NULL, dsm32204B;
|FIN;

|PROCESO dsm32205B;
     |BORRA 020#dsm32205.a;
     |LIBERA #dsm32205;
|FPRC;

|DEFBUCLE dsm32205B;
     #dsm32205#1;
     ;
     #dsm32201#0,#dsm32201#1,#dsm32201#3,#dsm32201#4,1;
     #dsm32201#0,#dsm32201#1,#dsm32201#3,#dsm32201#4,9;
     be;
     NULL, dsm32205B;
|FIN;

|PROGRAMA;
     eaNomDef  = "dsm32201";

|| \\\\\\ Consulta del Modelo ////////

     |SI enTipoEntrada = 4;              || Consulta del Modelo
         |HAZ MontaApartados;
     |FINSI;

|| \\\\\\ Grabacion del modelo

     |SI enTipoEntrada = 98;
         aGuardo9   = "N";
         aGuardo11  = "N";
         aGuardo12  = "N";
         aGuardo13  = "N";
         aGuardo130 = " ";
         aGuardo131  = " ";
         aGuardo132  = " ";
         aGuardo144  = " ";

         nGuardo76 = 0;
         nGuardo77 = 0;

         #dsm32201#0 = enEmpresa;
         #dsm32201#1 = enEjer;
         #dsm32201#2 = enPeriodo;
         #dsm32201#3 = enModelo;
         #dsm32201#4 = enComplem;
         #dsm32201#5 = 0;
         |LEE 101#dsm32201.=;
         |SI FSalida = 0;
             aGuardo9   = #dsm32201#9;
             aGuardo11  = #dsm32201#11;
             aGuardo12  = #dsm32201#12;
             aGuardo13  = #dsm32201#13;
             nGuardo76  = #dsm32201#76;
             nGuardo77  = #dsm32201#80;
             aGuardo130 = #dsm32201#130;
             aGuardo131 = #dsm32201#131;
             aGuardo132 = #dsm32201#132;
             aGuardo144 = #dsm32201#144;

             |SI nGuardo77 < 0; nGuardo77 = 0; |FINSI;
             |BORRA 020#dsm32201.a;
             |LIBERA #dsm32201;

             |SI #dsm32201#2 = 12;
                 |BUCLE dsm32204B;
                 |BUCLE dsm32205B;
             |FINSI;
         |FINSI;

         |HAZ GrabaModelo;
     |FINSI;

|| \\\\\\ Comprobacion Existencia del Modelo

     |SI enTipoEntrada = 99;              || Existencia del Modelo ????
         #dsm32201#0 = enEmpresa;
         #dsm32201#1 = enEjer;
         #dsm32201#2 = enPeriodo;
         #dsm32201#3 = enModelo;
         #dsm32201#4 = enComplem;
         #dsm32201#5 = enActividad;
         |LEE 040#dsm32201.=;
         |SI FSalida ! 0;  enExistencia = 1;  |DDEFECTO #dsm32201; |FINSI;

         |SI enActividad = 0;  enResultado = #dsm32201#88;  |FINSI;
     |FINSI;
|FPRO;

|PROCESO PorHistorico;
     fFecha = ~; aAlfa = fFecha;
     aAlfa  = aAlfa % 104;
     |SI aAlfa ! enEjer;
         #agicen30#0 = #agicen14#0;
         #agicen30#1 = #agicen14#1;
         #agicen30#2 = enEjer;
         |LEE 000#agicen30.=;
         |SI FSalida = 0;
             #agicen14#2 = #agicen30#3;
             #agicen14#3 = #agicen30#4;
             #agicen14#4 = #agicen30#5;
             #agicen14#7 = #agicen30#6;
             #agicen14#8 = #agicen30#7;
             #agicen14#9 = #agicen30#8;
             #agicen14#10 = #agicen30#9;
             #agicen14#11 = #agicen30#10;
             #agicen14#16 = #agicen30#12;
             #agicen14#17 = #agicen30#13;
             #agicen14#18 = #agicen30#14;
             #agicen14#19 = #agicen30#15;
             #agicen14#15 = #agicen30#16;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo80Fm32201;  |TIPO 80;
     aAlfa = PARAMETRO % 105;  enEmpresa     = aAlfa;
     aAlfa = PARAMETRO % 604;  enEjer        = aAlfa;
     aAlfa = PARAMETRO % 1002; enPeriodo     = aAlfa;
     aAlfa = PARAMETRO % 1203; enModelo      = aAlfa;
     aAlfa = PARAMETRO % 1502; enComplem     = aAlfa;
     aAlfa = PARAMETRO % 1702; enActividad   = aAlfa;
     aAlfa = PARAMETRO % 1902; enTipoEntrada = aAlfa;
     aAlfa = PARAMETRO % 2101; enExistencia  = aAlfa;

     enNoMod390 = 0;
     |SI enPeriodo = 12;
         enNoMod390 = 1;
     |FINSI;

     |ABRET #dsm32201;
     |ABRET #dsm32204;
|FPRC;

|PROCESO Tipo90Fm32201;  |TIPO 90;
     |SI nGrid02 ! -1;
         |DESTRUYECONTROL nGrid02;
         nGrid02 = -1;
     |FINSI;

     |SI nGrid03 ! -1;
         |DESTRUYECONTROL nGrid03;
         nGrid03 = -1;
     |FINSI;

     |SI nVentTrab ! -1;
         |FINVENTANA nVentTrab;
         nVentTrab = -1;
     |FINSI;

     |CIERRAT #dsm32204;
     |CIERRAT #dsm32201;

     |HAZ FinalizaEnX;
|FPRC;
