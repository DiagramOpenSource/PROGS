||Programa de Ejemplo de excel y correo dsarchi/dpnty001

|FICHEROS;
    dsmow030;
|FIN;

|VARIABLES;
     aBase               = "";
     nPausa              = 0;
     aAlfa               = "";
     aEjecuta            = "";
     nLinea              = 0;

     &eaPathDoc          = "";
     &eaPathLocal        = "";
     &eaAbre             = "";
     &enHandle           = 0;
     &enCab              = 0;
     &eaNomFic           = "";
     &eaNomProg          = "";
     &eaAlfa             = "";
     &eaTCampo           = "";
     &eaUnidadBasico     = "";
     &eaOrigen           = "";
     &eaDestino          = "";
     &aTipoIVA           = "";

     &aTipo              = "";
     &aTipoRS            = "";
     &efFechaEmi         = @;
     &nFactura           = 0;
     &nPagina            = 0;
     &SwPrim             = 0;
     &SwLinea            = 0;
     &nLBase             = 0;
     &nLTipoI            = 0;
     &nLCuoI             = 0;
     &nLCuoIN            = 0;
     &nLTipoR            = 0;
     &nLCuoR             = 0;
     &nLCuoRN            = 0;
     &nLBasP             = 0;
     &nLTipP             = 0;
     &nLCuoP             = 0;
     &eSwReten           = 0;
     &referencia         = "";
     &eaTituloL          = "";
     &eaTexPie           = "";
     &enTBase            = 0;
     &enTCuoI            = 0;
     &enTCuoIN           = 0;
     &enTCuoR            = 0;
     &enTCuoRN           = 0;
     &enTCuoP            = 0;
     &enTTotal           = 0;
|FIN;
|| *********************************************************************

|PROCESO GrabaCsv_CabIVA;
    eaAlfa = "C¢digo: " + ("00000" + #dsmow030#0) % -105; |HAZ GrDatoCsv;
    eaAlfa = &13 + &10;
    |XGRABA enHandle, eaAlfa;

    eaAlfa = "C.I.F.: " + #dsmow030#1;                    |HAZ GrDatoCsv;
    eaAlfa = &13 + &10;
    |XGRABA enHandle, eaAlfa;

    eaAlfa = "Empresa: " + #dsmow030#2;                   |HAZ GrDatoCsv;
    eaAlfa = &13 + &10;
    |XGRABA enHandle, eaAlfa;

    eaAlfa = "Ejercicio: " + #dsmow030#12;                |HAZ GrDatoCsv;
    eaAlfa = &13 + &10;
    |XGRABA enHandle, eaAlfa;

    eaAlfa = &13 + &10;
    |XGRABA enHandle, eaAlfa;

    eaAlfa = eaTituloL;              |HAZ GrDatoCsv;
    eaAlfa = &13 + &10;
    |XGRABA enHandle, eaAlfa;

    eaAlfa = &13 + &10;
    |XGRABA enHandle, eaAlfa;

    eaAlfa = "Orden";                |HAZ GrDatoCsv;  || a
    eaAlfa = "L¡nea";                |HAZ GrDatoCsv;  || b
    eaAlfa = "Serie";                |HAZ GrDatoCsv;  || c
    eaAlfa = "Factura";              |HAZ GrDatoCsv;  || d
    eaAlfa = "Fecha";                |HAZ GrDatoCsv;  || e
    eaAlfa = "Periodo";              |HAZ GrDatoCsv;  || f
    eaAlfa = "Fecha Operaci¢n";      |HAZ GrDatoCsv;  || g
    eaAlfa = "N§Factura/Referencia"; |HAZ GrDatoCsv;  || h

    eaAlfa = "Cliente";
    |SI aTipoIVA = "S";  eaAlfa = "Proveedor";  |FINSI;
                                     |HAZ GrDatoCsv;  || i
    eaAlfa = "Pa¡s";                 |HAZ GrDatoCsv;  || j
    eaAlfa = "CIF";                  |HAZ GrDatoCsv;  || k

    eaAlfa = "Base";                 |HAZ GrDatoCsv;  || l
    eaAlfa = "Tipo";                 |HAZ GrDatoCsv;  || m
    eaAlfa = "Cuota";
    |SI aTipoIVA = "S"; eaAlfa = "Cuota Deducible"; |FINSI;
                                     |HAZ GrDatoCsv;  || n
    |SI aTipoIVA = "S";
        eaAlfa = "Cuota NO Deducible"; |HAZ GrDatoCsv;  || o
    |FINSI;

    eaAlfa = "Tipo RE";              |HAZ GrDatoCsv;  || o/p
    eaAlfa = "Cuota RE";
    |SI aTipoIVA = "S"; eaAlfa = "Cuota RE Deducible"; |FINSI;
                                     |HAZ GrDatoCsv;  || p/q
    |SI aTipoIVA = "S";
        eaAlfa = "Cuota RE NO Deducible"; |HAZ GrDatoCsv;  || r
    |FINSI;

    |SI eSwReten = 1;
        eaAlfa = "IRPF";             |HAZ GrDatoCsv;  || r/q
    |FINSI;
    eaAlfa = "TOTAL";                |HAZ GrDatoCsv;  || s/r/q

    eaAlfa = &13 + &10;
    |XGRABA enHandle, eaAlfa;
    enCab = 1;
|FPRC;

|PROCESO GrabaCsv_IVA;

    |SI enCab = 0;
        |HAZ GrabaCsv_CabIVA;
    |FINSI;

    |SI SwPrim = 0; |HAZ GrabaCsv_IVAPie; |FINSI;

    |SI SwLinea = 0;
        nLinea = 0;
    |FINSI;

    nLinea = nLinea + 1;
    eaAlfa = #dsmow030#84;                |HAZ GrDatoCsv; || a
    eaAlfa = nLinea;                      |HAZ GrDatoCsv; || b

    eaAlfa = #dsmow030#16;                |HAZ GrDatoCsv; || c
    eaAlfa = #dsmow030#17;                |HAZ GrDatoCsv; || d
    eaAlfa = #dsmow030#79; eaTCampo = "F";|HAZ GrDatoCsv; || e
    eaAlfa = #dsmow030#88;                |HAZ GrDatoCsv; || f

    eaAlfa = " "; eaTCampo = "F";
    |SI #dsmow030#81 > "01.01.1900"; eaAlfa = #dsmow030#81; |FINSI;
                                          |HAZ GrDatoCsv; || g
    eaAlfa = #dsmow030#22;                |HAZ GrDatoCsv; || h

    eaAlfa = #dsmow030#20;                |HAZ GrDatoCsv; || i
    eaAlfa = #dsmow030#65 % 103;          |HAZ GrDatoCsv; || j
    eaAlfa = #dsmow030#21;                |HAZ GrDatoCsv; || k

    eaAlfa = nLBase;  eaTCampo = "N";     |HAZ GrDatoCsv; || l
    eaAlfa = nLTipoI; eaTCampo = "N";     |HAZ GrDatoCsv; || m
    eaAlfa = nLCuoI;  eaTCampo = "N";     |HAZ GrDatoCsv; || n
    |SI aTipoIVA = "S";
        eaAlfa = nLCuoIN; eaTCampo = "N"; |HAZ GrDatoCsv; || o
    |FINSI;
    eaAlfa = nLTipoR; eaTCampo = "N";     |HAZ GrDatoCsv; || o/p
    eaAlfa = nLCuoR;  eaTCampo = "N";     |HAZ GrDatoCsv; || p/q
    |SI aTipoIVA = "S";
        eaAlfa = nLCuoRN; eaTCampo = "N"; |HAZ GrDatoCsv; || q
    |FINSI;

    |SI SwLinea = 0;
        |SI eSwReten = 1;
            eaAlfa = nLCuoP; eaTCampo = "N";   |HAZ GrDatoCsv; || r/q
        |FINSI;
        eaAlfa = #dsmow030#51; eaTCampo = "N"; |HAZ GrDatoCsv; || s/r/q
    |FINSI;

    eaAlfa = &13 + &10;
    |XGRABA enHandle, eaAlfa;
|FPRC;

|PROCESO GrabaCsv_IVAPie;

    |SI SwPrim ! 0;
        |SI enCab = 0;
            |HAZ GrabaCsv_CabIVA;
        |FINSI;

        eaAlfa = &13 + &10;
        |XGRABA enHandle, eaAlfa;
    |FINSI;

    |SI SwPrim = 0;
        |SI enTBase = 0; |Y enTCuoI = 0; |Y enTCuoIN = 0; |Y enTCuoR = 0;
             |Y enTCuoRN = 0; |Y enTCuoP = 0; |Y enTTotal = 0;
            |ACABA;
        |FINSI;
    |FINSI;

    eaAlfa = " ";                          |HAZ GrDatoCsv; || a
    eaAlfa = " ";                          |HAZ GrDatoCsv; || b
    eaAlfa = " ";                          |HAZ GrDatoCsv; || c
    eaAlfa = " ";                          |HAZ GrDatoCsv; || d
    eaAlfa = " ";                          |HAZ GrDatoCsv; || e
    eaAlfa = " ";                          |HAZ GrDatoCsv; || f
    eaAlfa = " ";                          |HAZ GrDatoCsv; || g
    eaAlfa = " ";                          |HAZ GrDatoCsv; || h
    eaAlfa = eaTexPie;                     |HAZ GrDatoCsv; || i
    eaAlfa = " ";                          |HAZ GrDatoCsv; || j
    eaAlfa = " ";                          |HAZ GrDatoCsv; || k

    eaAlfa = enTBase; eaTCampo = "N";      |HAZ GrDatoCsv; || l
    eaAlfa = " ";                          |HAZ GrDatoCsv; || m
    eaAlfa = enTCuoI; eaTCampo = "N";      |HAZ GrDatoCsv; || n
    |SI aTipoIVA = "S";
        eaAlfa = enTCuoIN; eaTCampo = "N"; |HAZ GrDatoCsv; || o
    |FINSI;
    eaAlfa = " ";                          |HAZ GrDatoCsv; || o/p
    eaAlfa = enTCuoR; eaTCampo = "N";      |HAZ GrDatoCsv; || p/q
    |SI aTipoIVA = "S";
        eaAlfa = enTCuoRN; eaTCampo = "N"; |HAZ GrDatoCsv; || r
    |FINSI;

    |SI eSwReten = 1;
        eaAlfa = enTCuoP; eaTCampo = "N";  |HAZ GrDatoCsv; || r/q
    |FINSI;
    eaAlfa = enTTotal; eaTCampo = "N";     |HAZ GrDatoCsv; || s/r/q

    eaAlfa = &13 + &10;
    |XGRABA enHandle, eaAlfa;
|FPRC;

|PROCESO GrDatoCsv;
     |QBF eaAlfa;
     |HAZ QuitaRarosCsv;

     eaAlfa = eaAlfa + ";";
     |XGRABA enHandle, eaAlfa;

     eaTCampo = "";
|FPRC;

|PROCESO PresentaDocCsv;
     |XCIERRA enHandle;

     |SI enCab = 0;
         |FBORRA eaAbre;
     |FINSI;

     |XABRE "E", eaAbre, 0;
     |SI FSalida < 0;
||         |MENAV "0000Selecci¢n vac¡a";
         |ACABA;
     |FINSI;

     |HAZ LeeUnidadBasico;
     eaPathLocal = eaUnidadBasico + "\DOCUMENTOS";          |RMKDIR eaPathLocal;
     eaPathLocal = eaUnidadBasico + "\DOCUMENTOS\TMP";      |RMKDIR eaPathLocal;
     eaPathLocal = eaUnidadBasico + "\DOCUMENTOS\TMP/";

     |DBASE aBase;
     eaOrigen  = aBase + "plugins/dsabreextension.exe";
     eaDestino = eaPathLocal + "dsabreextension.exe";
     |HAZ EnviaFicheroConMD5;

     |XABRE "EC", eaDestino, 0;
     |SI FSalida < 0;
         |ACABA;
     |FINSI;

     eaOrigen  = eaPathDoc + eaNomFic;
     eaDestino = eaPathLocal + eaNomFic;
     |HAZ EnviaFicheroConMD5;

     aEjecuta = "START " + eaPathLocal + "dsabreextension ";
     aEjecuta = aEjecuta + eaDestino;
     aEjecuta = aEjecuta + " " + eaPathLocal + "fin" + Usuario + ".txt";

     aAlfa    = eaPathLocal + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;

     |RSYSTEM aEjecuta;
     aAlfa    = eaPathLocal + "fin" + Usuario + ".txt";
     |PARA;  |SI;  |HACIENDO;
             |XABRE "EC", aAlfa, enHandle;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             |PARA nPausa = 1; |SI nPausa < 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;
             |PULSATECLA;
     |SIGUE;
     |PULSATECLA;

     aAlfa    = eaPathLocal + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;

     aAlfa    = eaPathLocal + eaNomFic;
     |RFBORRA aAlfa;
|FPRC;

|PROCESO PorCsv_2;
     enCab    = 0;
     eaNomFic = eaNomProg + Usuario + ".csv";
     eaAbre   = eaPathDoc + eaNomFic;
     |XABRE "WB", eaAbre, enHandle;
|FPRC;

|PROCESO PorCsv_1;
     |DBASE aBase;
     eaPathDoc = aBase + "tmp";             |MKDIR eaPathDoc;
     eaPathDoc = aBase + "tmp/" + Usuario;  |MKDIR eaPathDoc;
     eaPathDoc = aBase + "tmp/" + Usuario + "/";
|FPRC;
