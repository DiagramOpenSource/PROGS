|FICHEROS;
     dsmom003;
     dsmom004;
     dsmod309;

     :integral/dsam0000;
     :integral/dsam0009;
     :basica/agitab99;
     :dsarchi/prtlm001;
|FIN;

|VARIABLES;
     nDia                = 0;
     nMes                = 0;
     nAny                = 0;

     aAlfa               = "";
     aDia                = "";
     aHora               = "";
     aConf               = "";

     fFec                = @;
     fFecDia             = @;

     &enCodCli           = 0;
     &enModelo           = 0;
     &enForzar           = 0;
     &eaFormaPago        = "";
     &eaIBAN             = "";
|FIN;

|PROCESO LeeModelo;
     #agitab99#0 = enModelo;
     |LEE 000#agitab99.=;
     |SI FSalida ! 0;  |DDEFECTO #agitab99;  |FINSI;
|FPRC;

|PROCESO CalculaVto;
     |SI #dsmom004#2 = 99;
         nDia = 31;
         nMes = 1;
         nAny = #dsmom004#1 + 1;

         |SI #dsmom004#3 = 390;  nDia = 30;  |FINSI;
     |SINO;
         nDia = 20;
         nMes = #dsmom004#2 + 1;
         nAny = #dsmom004#1;
         |SI nMes = 13;
             nMes = 1;
             nAny = #dsmom004#1 + 1;
         |FINSI;

         |SI #dsmom004#3 = 303;
             |SI #dsmom004#22 = "M";
                 nDia = 30;
             |FINSI;
         |FINSI;

         |SI #dsmom004#2 = 12;
             |SI #dsmom004#3 = 130;  nDia = 30;  |FINSI;
             |SI #dsmom004#3 = 131;  nDia = 30;  |FINSI;
             |SI #dsmom004#3 = 303;  nDia = 30;  |FINSI;
             |SI #dsmom004#3 = 349;  nDia = 30;  |FINSI;
         |FINSI;
     |FINSI;

     |SI nMes = 2;
         |SI nDia > 28;
             nDia = 28;
         |FINSI;
     |FINSI;

     aAlfa = (("00" + nDia) % -102) + "." + (("00" + nMes) % -102) + "." + nAny;
     fFec  = aAlfa;

     fFecDia = fFec % 1;
     aDia    = (fFecDia % 1109) > " ";   |QBF aDia;

     |SI aDia = "SABADO";
         fFec = fFec + 2;
     |FINSI;

     |SI aDia = "DOMINGO";
         fFec = fFec + 1;
     |FINSI;

     #prtlm001#9  = fFec;
|FPRC;

|PROCESO dsmom004;
     enModelo = #dsmom004#3;
     |HAZ LeeModelo;

     #dsmom003#0 = #dsmom004#0;
     #dsmom003#1 = #dsmom004#1;
     #dsmom003#2 = #dsmom004#2;
     |LEE 000#dsmom003.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom003;  |FINSI;

     #dsam0000#0 = #dsmom004#0;
     |LEE 000#dsam0000.=;
     |SI FSalida ! 0;  |DDEFECTO #dsam0000;  |FINSI;

     |DDEFECTO #prtlm001;

     #prtlm001#0  = #dsmom004#0;
     #prtlm001#1  = #dsmom004#1;
     #prtlm001#2  = #dsmom004#2;
     #prtlm001#3  = #dsmom004#3;
     #prtlm001#4  = ("00" + #dsmom004#4) % -102;
     #prtlm001#5  = #dsam0000#1;
     #prtlm001#6  = #agitab99#1;
     #prtlm001#7  = #dsmom003#3;

     |SI #dsmom004#7  = "X";  #prtlm001#8 = "E";  |FINSI;
     |SI #dsmom004#9  = "P";  #prtlm001#8 = "P";  |FINSI;
     |SI #dsmom004#13 = "X";  #prtlm001#8 = "A";  |FINSI;

     |HAZ CalculaVto;

     #prtlm001#10 = #dsmom004#15;

     enCodCli = #dsmom004#0;
     |HAZ LeePersona;

     enForzar = 1;
     |HAZ CogeDatosBancos;

     #prtlm001#11 = eaFormaPago;
     #prtlm001#12 = eaIBAN;
     #prtlm001#13 = #dsam0000#18;
     #prtlm001#14 = #dsam0000#72;
     #prtlm001#15 = #dsam0000#52;
     #prtlm001#16 = "";
     #prtlm001#17 = ~;

     |HORA aHora;  #prtlm001#18 = aHora;

     #prtlm001#19 = "FISCAL";

     |GRABA 020#prtlm001.n;
     |LIBERA #prtlm001;

     |GRABA 020#dsmom004.a;
     |LIBERA #dsmom004;
|FPRC;

|DEFBUCLE dsmom004;
     #dsmom004#1;
     ;
     00000, 2018, 00, 000, 00;
     99999, 9999, 99, 999, 99;
     be;
     NULL, dsmom004;
|FIN;

|PROCESO PonPer;
     |SI #prtlm001#2 = 1;   #prtlm001#7 = "ENERO     ";  |FINSI;
     |SI #prtlm001#2 = 2;   #prtlm001#7 = "FEBRERO   ";  |FINSI;
     |SI #prtlm001#2 = 3;   #prtlm001#7 = "MARZO     ";  |FINSI;
     |SI #prtlm001#2 = 4;   #prtlm001#7 = "ABRIL     ";  |FINSI;
     |SI #prtlm001#2 = 5;   #prtlm001#7 = "MAYO      ";  |FINSI;
     |SI #prtlm001#2 = 6;   #prtlm001#7 = "JUNIO     ";  |FINSI;
     |SI #prtlm001#2 = 7;   #prtlm001#7 = "JULIO     ";  |FINSI;
     |SI #prtlm001#2 = 8;   #prtlm001#7 = "AGOSTO    ";  |FINSI;
     |SI #prtlm001#2 = 9;   #prtlm001#7 = "SEPTIEMBRE";  |FINSI;
     |SI #prtlm001#2 = 10;  #prtlm001#7 = "OCTUBRE   ";  |FINSI;
     |SI #prtlm001#2 = 11;  #prtlm001#7 = "NOVIEMBRE ";  |FINSI;
     |SI #prtlm001#2 = 12;  #prtlm001#7 = "DICIEMBRE ";  |FINSI;
     |SI #prtlm001#2 = 99;  #prtlm001#7 = "ANUAL     ";  |FINSI;
|FPRC;

|PROCESO CalculaVto309;
     |SI #dsmod309#3 = 99;  |O #dsmod309#3 = 12;
         nDia = 30;
         nMes = 1;
         nAny = #dsmod309#2 + 1;
     |SINO;
         nDia = 20;
         nMes = #dsmod309#3 + 1;
         nAny = #dsmod309#2;
         |SI nMes = 13;
             nMes = 1;
             nAny = #dsmod309#2 + 1;
         |FINSI;
     |FINSI;

     |SI nMes = 2;
         |SI nDia > 28;
             nDia = 28;
         |FINSI;
     |FINSI;

     aAlfa = (("00" + nDia) % -102) + "." + (("00" + nMes) % -102) + "." + nAny;
     fFec  = aAlfa;

     fFecDia = fFec % 1;
     aDia    = (fFecDia % 1109) > " ";   |QBF aDia;

     |SI aDia = "SABADO";
         fFec = fFec + 2;
     |FINSI;

     |SI aDia = "DOMINGO";
         fFec = fFec + 1;
     |FINSI;

     #prtlm001#9  = fFec;
|FPRC;

|PROCESO dsmod309;
     #dsam0000#0 = #dsmod309#0;
     |LEE 000#dsam0000.=;
     |SI FSalida ! 0;  |DDEFECTO #dsam0000;  |FINSI;

     |DDEFECTO #prtlm001;

     #prtlm001#0  = #dsmod309#0;
     #prtlm001#1  = #dsmod309#2;
     #prtlm001#2  = #dsmod309#3;
     #prtlm001#3  = 309;
     aAlfa        = (("00" + #dsmod309#1) % -102) + " ";
     aAlfa        = aAlfa + (("00" + #dsmod309#4) % -102) + " ";
     aAlfa        = aAlfa + (("00" + #dsmod309#5) % -102);
     #prtlm001#4  = aAlfa;
     #prtlm001#5  = #dsmod309#7;
     #prtlm001#6  = #agitab99#1;

     |HAZ PonPer;

     |SI #dsmod309#9  = "X";  #prtlm001#8 = "E";  |FINSI;
     |SI #dsmod309#9  = "P";  #prtlm001#8 = "P";  |FINSI;
     |SI #dsmod309#16 = "X";  #prtlm001#8 = "A";  |FINSI;

     |HAZ CalculaVto309

     #prtlm001#10 = #dsmod309#18;

     enCodCli = #dsmod309#0;
     |HAZ LeePersona;

     enForzar = 1;
     |HAZ CogeDatosBancos;

     #prtlm001#11 = eaFormaPago;
     #prtlm001#12 = eaIBAN;
     #prtlm001#13 = #dsam0000#18;
     #prtlm001#14 = #dsam0000#72;
     #prtlm001#15 = #dsam0000#52;
     #prtlm001#16 = "";
     #prtlm001#17 = ~;

     |HORA aHora;  #prtlm001#18 = aHora;

     #prtlm001#19 = "FISCAL";

     |GRABA 020#prtlm001.n;
     |LIBERA #prtlm001;
|FPRC;

|DEFBUCLE dsmod309;
     #dsmod309#1;
     ;
     00000, 00, 2018, 00, 00, 00;
     99999, 99, 9999, 99, 99, 99;
     be;
     NULL, dsmod309;
|FIN;

|PROGRAMA;
     |BUCLE dsmom004;

     enModelo = 309;
     |HAZ LeeModelo;
     |BUCLE dsmod309;
|FPRO;

|PROCESO T80;  |TIPO 80;
     |ABRET #dsmom003;
     |ABRET #prtlm001;
     |ABRET #dsam0000;
     |ABRET #agitab99;
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #dsmom003;
     |CIERRAT #prtlm001;
     |CIERRAT #dsam0000;
     |CIERRAT #agitab99;
|FPRC;
