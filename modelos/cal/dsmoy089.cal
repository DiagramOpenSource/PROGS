|FICHEROS;
     dsmoy089;

     dsmom023;
     dsmom024;
     dsmom028;

     :/basica/def/agitab99 #99;
     :/basica/def/agicen14 #114;
     :/basica/def/agifigen #118;
     :/basica/def/agim0019 #119;

     dsmow029;
     program@ #777;

     dsm30301;
     dsm32201;
     dsmom004;
     dsmom04@;
|FIN;

|VARIABLES;
     nSwDevuelto = 0;
     nPendiente = 0;
     aTPer     = "";
     nPerP     = 0;
     nAnyP     = 0;
     informe   = "dsmoy089";
     nEstado   = 0;
     nCampo    = 0;
     nDEmpresa = 0;
     nHEmpresa = 0;
     nPeriodo  = 0;
     nEjer     = 0;
     aAlfa     = "";
     aAlfa1    = "";
     aAlfa2    = "";
     aAlfa3    = "";
     aPath     = "";
     nNume1    = 0;
     nNume2    = 0;
     nNume3    = 0;
     nPin1       = 0;
     aPin1       = "";
     efPn10      = @;
     efPn11      = @;
     swExiste    = 0;
     &enSwLinea  = 0;
     nLaEmpresa  = 0;
     nElModelo   = 0;
     nMod2009    = 0;
     nElAny      = 0;
     swPrEmpresa = 0;
     swPrModelo  = 0;
     swPrAny     = 0;
     swAlgun     = 0;
     swBo        = 0;
     &eaLit1     = "";
     &eaLit2     = "";

     nACompensar = 0;
     nCompensar  = 0;
     aPathModelo = "";
     aDef        = "";
     aFichero    = "";
     fLaFecha    = @;
     &eaRaya     = "";
     nSwEste     = 0;
     nDMod       = 0;
     nHMod       = 0;
     aParametro  = "";
     nParam      = 0;
     nResta      = 0;
     aResta      = "";
     nEstePer    = 0;
     nImpReal    = 0;
     nCas21      = 0;
     nCas27      = 0;
     nCas31      = 0;
     nCas34      = 0;
     nIngresar   = 0;
     nDevolver   = 0;
     nMes        = 0;
     nAny        = 0;
     nHastaAny   = 0;
     nDesdePer   = 0;
     nHastaPer   = 0;
     aPeriodico  = "";
     nOk         = 0;
     nPara1      = 0;

     &eaTex      = "";
     &enImpAcum  = 0;
     &enImporte  = 0;
     &enImport1  = 0;
     &enTrim     = 0;
     &enAny      = 0;
|FIN;

|INCLUYE i_variar;

|| /////////////////////// PROCESOS ENTRADA POR PANTALLA \\\\\\\\\\\\\\\\\\\\
|CALCULO Eano; |TIPO 7;
     fLaFecha = ~;
     aAlfa1 = fLaFecha; aAlfa1 = aAlfa1 % -104;
     #dsmoy089#15 = aAlfa1;
     |PINTA #dsmoy089#15;
|FCAL;

|CALCULO Periodo; |TIPO 0;
     nCampo = Campo + 1;
     #dsmoy089#nCampo# = "          ";
     |SI #dsmoy089#Campo# = 1;   #dsmoy089#nCampo# = "ENERO     ";  |FINSI;
     |SI #dsmoy089#Campo# = 2;   #dsmoy089#nCampo# = "FEBRERO   ";  |FINSI;
     |SI #dsmoy089#Campo# = 3;   #dsmoy089#nCampo# = "MARZO     ";  |FINSI;
     |SI #dsmoy089#Campo# = 4;   #dsmoy089#nCampo# = "ABRIL     ";  |FINSI;
     |SI #dsmoy089#Campo# = 5;   #dsmoy089#nCampo# = "MAYO      ";  |FINSI;
     |SI #dsmoy089#Campo# = 6;   #dsmoy089#nCampo# = "JUNIO     ";  |FINSI;
     |SI #dsmoy089#Campo# = 7;   #dsmoy089#nCampo# = "JULIO     ";  |FINSI;
     |SI #dsmoy089#Campo# = 8;   #dsmoy089#nCampo# = "AGOSTO    ";  |FINSI;
     |SI #dsmoy089#Campo# = 9;   #dsmoy089#nCampo# = "SEPTIEMBRE";  |FINSI;
     |SI #dsmoy089#Campo# = 10;  #dsmoy089#nCampo# = "OCTUBRE   ";  |FINSI;
     |SI #dsmoy089#Campo# = 11;  #dsmoy089#nCampo# = "NOVIEMBRE ";  |FINSI;
     |SI #dsmoy089#Campo# = 12;  #dsmoy089#nCampo# = "DICIEMBRE ";  |FINSI;
     |PINTA #dsmoy089#nCampo#;
|FCAL;

|PROCESO Tipo7;  |TIPO 7;
     |SI enEmpresa ! 0;
         #dsmoy089#0 = enEmpresa;  |PINTA #dsmoy089#0;
         #dsmoy089#1 = enEmpresa;  |PINTA #dsmoy089#1;

         |C_M #dsmoy089#0, 1, "N";
         |C_M #dsmoy089#1, 1, "N";
     |FINSI;
|FPRC;

|PROCESO Parrilla;
     |SI #dsmoy089#0 = 0;
         #dsmoy089#0 = 0;  |PINTA #dsmoy089#0;
         #dsmoy089#1 = 0;  |PINTA #dsmoy089#1;  |C_M #dsmoy089#1, 1, "N";
         |PARA nCampo = 2;  |SI nCampo [ 13;  |HACIENDO nCampo = nCampo + 1;
               |C_M #dsmoy089#nCampo#, 1, "S";
         |SIGUE;
     |SINO;
         |SI enEmpresa = 0;
             |C_M #dsmoy089#0, 1, "S";
             |C_M #dsmoy089#1, 1, "S";
         |FINSI;

         |PARA nCampo = 2;  |SI nCampo [ 13;  |HACIENDO nCampo = nCampo + 1;
               |C_M #dsmoy089#nCampo#, 1, "N";
               #dsmoy089#nCampo# = 0;  |PINTA #dsmoy089#nCampo#;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO NoMasEmpresas;
     |SI #dsmoy089#Campo# = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 13;  |HACIENDO nCampo = nCampo + 1;
               #dsmoy089#nCampo# = 0;  |C_M #dsmoy089#nCampo#, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 13;  |HACIENDO nCampo = nCampo + 1;
               |C_M #dsmoy089#nCampo#, 1, "S";
         |SIGUE;
     |FINSI;
|FPRC;

|| ************************************************************************
|PROCESO LeePrescrito;
     aResta = "X";
     nResta = 0;
     |ABRE #dsmom028;
     #dsmom028#0 = #dsmow029#0;   || Empresa
     #dsmom028#1 = #dsmow029#2;   || A¤o
     #dsmom028#2 = #dsmow029#3;   || Periodo
     #dsmom028#3 = nMod2009;      || Modelo
     #dsmom028#4 = #dsmom024#4;
     #dsmom028#5 = 0;
     |LEE 040#dsmom028.=;
     |SI FSalida = 0;
         aResta = #dsmom028#7;
         |SI #dsmom028#7 ! "N";
             nResta = #dsmom028#6;
         |FINSI;
     |FINSI;
     |CIERRA #dsmom028;
|FPRC;

|PROCESO CampoCompensado;
       #777#12 = #dsmow029#3;
       |SI #dsmow029#29 = "T";
           |SI #dsmow029#3 [ 12; #777#12 = 4; |FINSI;
           |SI #dsmow029#3 [  9; #777#12 = 3; |FINSI;
           |SI #dsmow029#3 [  6; #777#12 = 2; |FINSI;
           |SI #dsmow029#3 [  3; #777#12 = 1; |FINSI;
       |FINSI;
       #777#13 = #dsmow029#2;
       #777#31 = #dsmow029#29;
|FPRC;
|| *************************************************************************

|PROCESO Auxiliar0N;

 |SI #777#2 = #dsmow029#2; |Y #777#3 ] #dsmow029#3;
     |ERROR10;
     |ACABA;
 |FINSI;

 |SI #777#9 = 0;
     |ACABA;                         || Ya esta compensado
 |FINSI;

 nSwEste = 0;
 nMes    = #777#10;
 nAny    = #777#11;
 |SI #777#29 = "M"; |Y #dsmow029#29 = "T";
     |SI nMes ! 3; |Y nMes ! 6; |Y nMes ! 9; |Y nMes ! 12;
         |SI nMes = 1; |O nMes = 4; |O nMes = 7; |O nMes = 10;
             nMes = nMes - 1;
         |SINO;
             nMes = nMes - 2;
         |FINSI;
         |SI nMes = 0;
             nMes = 12;
             nAny = nAny - 1;
        |FINSI;
    |FINSI;
 |FINSI;

 |SI nAny < #dsmow029#2;
     aTPer   = #777#29;
     nAnyP   = #777#2;
     nPerP   = #777#3;
     #dsmow029#25 = #777#9;  || .. Importe prescrito
     #777#9  = 0;
 |SINO;
     |SI nAny = #dsmow029#2;
         nNume1 = nMes;
         |SI #777#29 = "T";
             |SI #777#10 = 4; nNume1 = 12; |FINSI;
             |SI #777#10 = 3; nNume1 =  9; |FINSI;
             |SI #777#10 = 2; nNume1 =  6; |FINSI;
             |SI #777#10 = 1; nNume1 =  3; |FINSI;
         |FINSI;
         |SI #dsmow029#3 > nNume1;
             aTPer   = #777#29;
             nAnyP   = #777#2;
             nPerP   = #777#3;
             #dsmow029#25 = #777#9;  || .. Importe prescrito
             #777#9  = 0;
         |SINO;
             |SI #dsmow029#3 = nNume1;
                  aTPer   = #777#29;
                  nAnyP   = #777#2;
                  nPerP   = #777#3;
                  nSwEste = 1;
                  #dsmow029#25 = #777#9;  || .. Importe prescrito
             |FINSI;
         |FINSI;
     |FINSI;
 |FINSI;

 |SI nSwDevuelto = 1;
     #777#8 = #777#8 + #777#9;            || Compensado
     #777#9 = 0;

     |HAZ CampoCompensado;
 |SINO;
     |SI #777#9 ! 0; |Y nACompensar ! 0;
          nNume1 = #777#9 - nACompensar;
          |SI nNume1 [ 0;
              nACompensar = nACompensar - #777#9;  || Pendiente Compensar
              #777#8 = #777#8 + #777#9;            || Compensado
              #777#9 = 0;

              |HAZ CampoCompensado;
          |SINO;
              #777#8 = #777#8 + nACompensar;     || Compensado
              |HAZ CampoCompensado;
              #777#9 = #777#9 - nACompensar;   || Pendiente Compensar
              nACompensar = 0;
          |FINSI;
      |FINSI;
  |FINSI;

  |SI nSwEste = 1;
      #dsmow029#28 = #777#9;  || .. Importe prescrito calculado

      |SI #dsmow029#25 = 0;
          nAnyP   = 0;
          nPerP   = 0;
          aTPer   = "";
      |FINSI;
      #777#9  = 0;
  |FINSI;

  |GRABA 020#777a;
  |LIBERA #777;

|FPRC;

|DEFBUCLE AuxiliarN;
  #777#1004;
  ;
  #dsmow029#0, #dsmow029#1,        0000, 00;
  #dsmow029#0, #dsmow029#1, #dsmow029#2, 99;
  e;
  NULL, Auxiliar0N;
|FIN;

|PROCESO LoAntiguo;
  nPendiente = - #dsmow029#24;
  nPendiente = nPendiente - #dsmow029#23;
  |SI nPendiente [ 0; |ACABA; |FINSI;

  #dsmow029#0 = #dsmom024#0;      || Empresa
  #dsmow029#1 = nMod2009;   || Modelo
  #dsmow029#2 = #dsmom024#1;
  #dsmow029#3 = #dsmom024#2 - 3;
  |SI #dsmow029#3 = 0;
      #dsmow029#3 = 12;
      #dsmow029#2 = #dsmow029#2  - 1;
  |FINSI;

  |LEE 101#dsmow029.=;
  |SI FSalida ! 0;
       |DDEFECTO #dsmow029;
       #dsmow029#0 = #dsmom024#0;      || Empresa
       #dsmow029#1 = nMod2009;         || Modelo
       #dsmow029#2 = #dsmom024#1;      || A¤o
       #dsmow029#3 = #dsmom024#2 - 3;  || Periodo
       |SI #dsmow029#3 = 0;
           #dsmow029#3 = 12;
           #dsmow029#2 = #dsmow029#2  - 1;
       |FINSI;
       |GRABA 020#dsmow029.b;
  |FINSI;

  #dsmow029#7  = nPendiente;
  #dsmow029#19 = 0;  || iva devengado
  #dsmow029#20 = 0;  || iva deducible
  #dsmow029#21 = - nPendiente;
  #dsmow029#22 = 0;
  #dsmow029#23 = nPendiente;
  #dsmow029#24 = - nPendiente;
  #dsmow029#9  = #dsmow029#23;  ||Pendiente de Compensar

      nNume1 = #dsmow029#2 + 4; aAlfa1 = nNume1;
      nNume1 = #dsmow029#2 + 5; aAlfa2 = nNume1;
      |SI #dsmow029#3 [ 12; #dsmow029#10 = 4; aAlfa3 = "30.01." + aAlfa2; |FINSI;
      |SI #dsmow029#3 [  9; #dsmow029#10 = 3; aAlfa3 = "20.10." + aAlfa1; |FINSI;
      |SI #dsmow029#3 [  6; #dsmow029#10 = 2; aAlfa3 = "20.07." + aAlfa1; |FINSI;
      |SI #dsmow029#3 [  3; #dsmow029#10 = 1; aAlfa3 = "20.04." + aAlfa1; |FINSI;
      #dsmow029#11  = #dsmow029#2 + 4;   || Sumar 4 al a¤o
      #dsmow029#17  = aAlfa3;       || Fecha

  #dsmow029#25 = 0;
  #dsmow029#18 = "P";
  |GRABA 020#dsmow029.a;
  |LIBERA #dsmow029;
  swAlgun = 1;
|FPRC;

|PROCESO Leem024;

 #dsmom004#0 = #dsmom024#0;
 #dsmom004#1 = #dsmom024#1;
 #dsmom004#2 = #dsmom024#2;
 #dsmom004#3 = #dsmom024#3;
 #dsmom004#4 = #dsmom024#4 + 1;
 |LEE 040#dsmom004.=;
 |SI FSalida = 0; |ACABA; |FINSI;

 |DDEFECTO #dsmom004;
 #dsmom004#0 = #dsmom024#0;
 #dsmom004#1 = #dsmom024#1;
 #dsmom004#2 = #dsmom024#2;
 #dsmom004#3 = #dsmom024#3;
 #dsmom004#4 = #dsmom024#4;
 |LEE 040#dsmom004.=;
 |SI FSalida ! 0;
     #dsmom004#0 = #dsmom024#0;
     #dsmom004#1 = #dsmom024#1;
     #dsmom004#2 = #dsmom024#2;
     #dsmom004#3 = #dsmom024#3;
     #dsmom004#4 = #dsmom024#4;
     #dsmom004#22 = aPeriodico;
 |FINSI;

 |SI #dsmom024#1 = nHastaAny; |Y #dsmom024#2 > nHastaPer;
     |ERROR10;
     |ACABA;
 |FINSI;

 #dsmow029#0 = #dsmom024#0;     || Empresa
 #dsmow029#1 = nMod2009;        || Modelo
 #dsmow029#2 = #dsmom024#1;     || A¤o

 #dsmow029#3 = #dsmom024#2;     || Periodo

 |LEE 101#dsmow029.=;
 |SI FSalida ! 0;
     |DDEFECTO #dsmow029;
     #dsmow029#0 = #dsmom024#0;     || Empresa
     #dsmow029#1 = nMod2009;        || Modelo
     #dsmow029#2 = #dsmom024#1;     || A¤o
     #dsmow029#3 = #dsmom024#2;     || Periodo
     |HAZ LeePrescrito;
     #dsmow029#26 = nResta;
     #dsmow029#27 = aResta;
     #dsmow029#29 = #dsmom004#22;
     |GRABA 020#dsmow029.b;
 |FINSI;

  nSwDevuelto = 0;
  #dsmow029#5 = #dsmom024#9;    || a ingresar
  #dsmow029#6 = #dsmom024#10;   || a devolver
  #dsmow029#7 = #dsmom024#11;   || a compensar

  #dsmow029#19 = #dsmom024#14;  || iva devengado
  #dsmow029#20 = #dsmom024#15;  || iva deducible
  #dsmow029#21 = #dsmom024#13;  || diferencia
  #dsmow029#22 = #dsmom024#16 + #dsmow029#26;  || Cuotas a compensar de Ejercicios Anteriores
  |SI #dsmow029#22 ! 0;             || si no tengo suficiente no compenso todo
      |SI #dsmow029#21 < 0;
          #dsmow029#22 = 0;
      |SINO;
          |SI #dsmow029#22 > #dsmow029#21;
              #dsmow029#22 = #dsmow029#21;
          |FINSI;
      |FINSI;
  |FINSI;

  #dsmow029#23 = 0;
  |SI #dsmow029#7 ! 0; |Y #dsmow029#21 < 0;
      #dsmow029#23 = - #dsmow029#21;
      |SI #dsmow029#7 < #dsmow029#23;
          #dsmow029#23 = #dsmow029#7;
      |FINSI;
  |FINSI;
  #dsmow029#24 = #dsmom024#17;

  #dsmow029#9 = #dsmow029#23;  ||Pendiente de Compensar
  |SI #dsmow029#9 ! 0;
      nNume1 = #dsmom024#1 + 4; aAlfa1 = nNume1;
      nNume1 = #dsmom024#1 + 5; aAlfa2 = nNume1;
      |SI #dsmow029#29 = "T";
          |SI #dsmom024#2 [ 12; #dsmow029#10 = 4; aAlfa3 = "30.01." + aAlfa2; |FINSI;
          |SI #dsmom024#2 [  9; #dsmow029#10 = 3; aAlfa3 = "20.10." + aAlfa1; |FINSI;
          |SI #dsmom024#2 [  6; #dsmow029#10 = 2; aAlfa3 = "20.07." + aAlfa1; |FINSI;
          |SI #dsmom024#2 [  3; #dsmow029#10 = 1; aAlfa3 = "20.04." + aAlfa1; |FINSI;
      |SINO;
          #dsmow029#10 = #dsmom024#2;
          |SI #dsmom024#2 = 12; aAlfa3 = "30.01." + aAlfa2; |FINSI;
          |SI #dsmom024#2 ! 12;
              nNume2 = #dsmom024#2 + 1;
              aAlfa3 = ("00" + nNume2) % -102;
              aAlfa3 = "20." + aAlfa3 + "." + aAlfa1;
          |FINSI;
      |FINSI;
      #dsmow029#11  = #dsmom024#1 + 4;   || Sumar 4 al a¤o
      #dsmow029#17  = aAlfa3;      || Fecha
  |FINSI;

  nACompensar = 0;
  |SI #dsmow029#21 > 0;
      nACompensar = #dsmow029#21;
  |FINSI;
  |SI #dsmow029#6 ! 0;
      nACompensar = nACompensar + #dsmow029#6;
      nSwDevuelto = 1;
  |FINSI;

  aTPer = "";
  nPerP = 0;
  nAnyP = 0;
  #dsmow029#14 = 0;
  #dsmow029#15 = 0;
  #dsmow029#25 = 0;
  |BUCLE AuxiliarN;
  |SI #dsmow029#25 ! 0; |O #dsmow029#26 ! 0; |O #dsmow029#28 ! 0;
      |SI aTPer = "T";
         |SI nPerP [ 12; nNume1 = 4; |FINSI;
         |SI nPerP [  9; nNume1 = 3; |FINSI;
         |SI nPerP [  6; nNume1 = 2; |FINSI;
         |SI nPerP [  3; nNume1 = 1; |FINSI;
      |SINO;
         nNume1 = nPerP;
      |FINSI;
      #dsmow029#14 = nNume1;
      #dsmow029#15 = nAnyP;
      #dsmow029#30 = aTPer;
  |FINSI;

  #dsmow029#18 = "";
  |GRABA 020#dsmow029.a;
  |LIBERA #dsmow029;

  |SI swPrAny = 0; |Y #dsmow029#24 < 0;  ||Compensar anterior
      |HAZ LoAntiguo;
  |FINSI;

  swPrAny = 1;
  swAlgun = 1;
|FPRC;

|DEFBUCLE Leem024;
 #dsmom024#1;
 ;
 #dsmom023#0, #dsmom023#1, nDesdePer, #dsmom023#2, 00;
 #dsmom023#0, #dsmom023#1,        99, #dsmom023#2, 99;
 e;
 NULL, Leem024;
|FIN;
||/////////////////////////////////////////////////////////////

|PROCESO CreaAuxiliar0;

 nMod2009 = #dsmom023#2;
 |SI #dsmoy089#15 ] 2009;
     |SI #dsmom023#2 = 300; |O #dsmom023#2 = 320;
          |O #dsmom023#2 = 330; |O #dsmom023#2 = 332;
         nMod2009 = 303;
     |FINSI;
 |FINSI;

 |SI swPrEmpresa = 0; |O nLaEmpresa ! #dsmom023#0;
     swPrEmpresa = 1;
     nLaEmpresa  = #dsmom023#0;
     swPrModelo  = 0;
     swPrAny     = 0;
     nEstePer    = 0;
 |FINSI;

    |SI swPrModelo = 0; |O nElModelo ! nMod2009;

        swPrModelo = 1;
        nElModelo  = nMod2009;
        swPrAny    = 0;
        nEstePer   = 0;
    |FINSI;

    nElAny = #dsmom023#1;   ||A¤o
    |BUCLE Leem024;
|FPRC;

|DEFBUCLE CreaAuxiliar;
    #dsmom023#2;
    ;
    nDEmpresa, nDMod, #dsmoy089#14;   ||Empresa Modelo A¤o
    nHEmpresa, nHMod, nHastaAny;
    e;
    NULL, CreaAuxiliar0;
|FIN;

|| \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
|PROCESO EstePeriodo;

 |SI #dsmom04@#3 ! 303; |Y #dsmom04@#3 ! 322; |ACABA; |FINSI;

 |DDEFECTO #dsmom004;
 #dsmom004#0 = #dsmom04@#0;
 #dsmom004#1 = #dsmom04@#1;
 #dsmom004#2 = #dsmom04@#2;
 #dsmom004#3 = #dsmom04@#3;
 #dsmom004#4 = #dsmom04@#4 + 1;
 |LEE 040#dsmom004.=;
 |SI FSalida = 0; |ACABA; |FINSI;

 nImpReal  = 0;
 nCas21    = 0;
 nCas27    = 0;
 nCas31    = 0;
 nCas34    = 0;
 nIngresar = 0;
 nDevolver = 0;
 nCompensar= 0;

 |SI #dsmom04@#3 = 322;
     |DDEFECTO #dsm32201;
     #dsm32201#0 = #dsmom04@#0;
     #dsm32201#1 = #dsmom04@#1;
     #dsm32201#2 = #dsmom04@#2;
     #dsm32201#3 = #dsmom04@#3;
     #dsm32201#4 = #dsmom04@#4;
     #dsm32201#5 = 00;
     |LEE 040#dsm32201.=;
     |SI FSalida = 0;
         nImpReal  = #dsm32201#81;
         nCas21    = #dsm32201#42 + #dsm32201#54;
         nCas27    = #dsm32201#60 + #dsm32201#72;
         nCas31    = #dsm32201#84;
         nCas34    = #dsm32201#88;
         nIngresar = #dsm32201#91;
         nDevolver = #dsm32201#90;
         nCompensar= #dsm32201#89;
     |FINSI;
 |SINO;
     |DDEFECTO #dsm30301;
     #dsm30301#0 = #dsmom04@#0;
     #dsm30301#1 = #dsmom04@#1;
     #dsm30301#2 = #dsmom04@#2;
     #dsm30301#3 = #dsmom04@#3;
     #dsm30301#4 = #dsmom04@#4;
     #dsm30301#5 = 00;
     |LEE 040#dsm30301.=;
     |SI FSalida = 0;
         nImpReal  = #dsm30301#81;
         nCas21    = #dsm30301#42 + #dsm30301#54;
         nCas27    = #dsm30301#60 + #dsm30301#72;
         nCas31    = #dsm30301#84;
         nCas34    = #dsm30301#88;
         nIngresar = #dsm30301#91;
         nDevolver = #dsm30301#90;
         nCompensar= #dsm30301#89;
     |FINSI;
 |FINSI;

 |DDEFECTO #dsmom023;
 #dsmom023#0 = #dsmom04@#0;
 #dsmom023#1 = #dsmom04@#1;
 #dsmom023#2 = #dsmom04@#3;

 |DDEFECTO #dsmom024;
 #dsmom024#0 = #dsmom023#0;
 #dsmom024#1 = #dsmom023#1;
 #dsmom024#2 = #dsmom04@#2;
 #dsmom024#3 = #dsmom023#2;

  #dsmom024#9  = nIngresar;
  #dsmom024#10 = nDevolver;
  #dsmom024#11 = nCompensar;
  #dsmom024#13 = nImpReal;
  #dsmom024#14 = nCas21;
  #dsmom024#15 = nCas27;
  #dsmom024#16 = nCas31;
  #dsmom024#17 = nCas34;

  |HAZ Leem024;
|FPRC;

|DEFBUCLE EstePeriodo;
   #dsmom04@#1005;
   ;
   #agifigen#0, #dsmoy089#15, nDesdePer, nMod2009, 00;
   #agifigen#0, #dsmoy089#15, nHastaPer, nMod2009, 99;
   e;
   NULL, EstePeriodo;
|FIN;

|PROCESO SensePlaning;
   |PARA nPara1 = nDesdePer; |SI nPara1 [ nHastaPer; |HACIENDO nPara1 = nPara1 + 1;
         nOk = 1;
         |SI aPeriodico = "T";
             |SI nPara1 ! 3; |Y nPara1 = 6;
                |Y nPara1 ! 9; |Y nPara1 = 12;
                   nOk = 0;
             |FINSI;
         |FINSI;
         |SI nOk = 1;
             #dsmom04@#0 = #agifigen#0;
             #dsmom04@#1 = #dsmoy089#15;
             #dsmom04@#2 = nPara1;
             #dsmom04@#3 = nMod2009;
             #dsmom04@#4 = 0;
             #dsmom04@#22 = aPeriodico;
             |HAZ EstePeriodo;
         |FINSI;
   |SIGUE;
|FPRC;

|PROCESO VeoPeriodicidad;
   aPeriodico = #dsmom04@#22;
   |SI #dsmom04@#1 = #dsmoy089#15;
       |SI #dsmom04@#2 ] nDesdePer; |Y #dsmom04@#2 [ nHastaPer;
           nOk = 1;
       |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE VeoPeriodicidad;
   #dsmom04@#1005;
   ;
   #agifigen#0, nElAny,       01, nMod2009, 00;
   #agifigen#0, #dsmoy089#15, 99, nMod2009, 99;
   e;
   NULL, VeoPeriodicidad;
|FIN;

|PROCESO EstasEmpresas;

   aPeriodico  = "X";
   nOk      = 0;
   nElAny   = #dsmoy089#15 - 4;
   nMod2009 = 303;
   |BUCLE VeoPeriodicidad;
   |SI aPeriodico ! "X";
       |SI nOk = 1;
           |BUCLE EstePeriodo;
       |SINO;
           |HAZ SensePlaning;
       |FINSI;
   |FINSI;
   aPeriodico  = "X";
   nOk     = 0;
   nElAny  = #dsmoy089#15 - 4;
   nMod2009 = 322;
   |BUCLE VeoPeriodicidad;
   |SI aPeriodico ! "X";
       |SI nOk = 1;
           |BUCLE EstePeriodo;
       |SINO;
           |HAZ SensePlaning;
       |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE EstasEmpresas;
   #agifigen#1;
   ;
   nDEmpresa;
   nHEmpresa;
   e;
   NULL, EstasEmpresas;
|FIN;

|| *********************************************************************
|| **********PROCESO PARA IMPRIMIR AUXILIAR ****************************
|| *********************************************************************
|PROCESO LeeLaEmpresa;
  |PDEFECTO #dsmoy089, 16,27;
  #dsmoy089#16 = nLaEmpresa;

  swAlgun    = 0;
  swPrModelo = 0;
  swPrAny    = 0;
  nPin1 = 0;
  aPin1 = "";
  efPn10 = "01.01.0000";
  efPn11 = "01.01.0000";

  || Lee Actividad
    |ABRE #agicen14;
    #agicen14#0 = #dsmoy089#16; || Empresa
    #agicen14#1 = 00;
    |LEE 041#agicen14.];
    |SI FSalida = 0; |Y #agicen14#0 = #dsmoy089#16;
        #dsmoy089#21 = #agicen14#9;
        #dsmoy089#22 = #agicen14#10;
        #dsmoy089#23 = #agicen14#7;
        #dsmoy089#24 = #agicen14#8;
        efPn10 = #agicen14#5;
        efPn11 = #agicen14#6;
    |FINSI;
    |CIERRA #agicen14;

 || Lee Ficha Sociedades
    swExiste = 0;
    |ABRE #agim0019;
    #agim0019#0 = #dsmoy089#16; || Empresa
    #agim0019#1 = 99;
    |LEE 041#agim0019.];
    |SI FSalida = 0;
       |LEE 041#agim0019.a;
    |SINO;
       |LEE 041#agim0019.u;
    |FINSI;
    |SI FSalida = 0; |Y #agim0019#0 = #dsmoy089#16;
        swExiste = 1;
    |FINSI;
    |SI swExiste = 1;
        efPn10 = #agim0019#7;      || Fecha Activa
        efPn11 = #agim0019#55;     || Fecha Inactiva
        nPin1 = #agim0019#4;
        aPin1 = #agim0019#5;
    |FINSI;
    |CIERRA #agim0019;

    |ABRE #agifigen;
    #agifigen#0 = #dsmoy089#16; || Empresa
    |LEE 041#agifigen.=;
    |SI FSalida = 0;
        efPn10  = #agifigen#93;
        efPn11  = #agifigen#94;
        nPin1   = #agifigen#87;
        aPin1   = #agifigen#88;
        #dsmoy089#17 = #agifigen#13;  || Nif
        #dsmoy089#18 = #agifigen#1;   || Nombre
    |FINSI;
    |CIERRA #agifigen;
    |SI efPn10 [ "01.01.1900"; efPn10 = ""; |FINSI;
    |SI efPn11 [ "01.01.1900"; efPn11 = ""; |FINSI;
    #dsmoy089#19 = nPin1;
    #dsmoy089#20 = aPin1;
    #dsmoy089#25 = efPn10;
    #dsmoy089#26 = efPn11;
|FPRC;

|PROCESO LeeElModelo;
|FPRC;

|PROCESO TotalModelo;
 |PIEINF;
 swAlgun = 0;
 swPrAny = 0;
|FPRC;

|PROCESO dsmow0290;
 eaTex = "";
 |SI swPrEmpresa = 0;
     swPrEmpresa = 1;
     nLaEmpresa = #dsmow029#0;
     |HAZ LeeLaEmpresa;
 |FINSI;

 |SI nLaEmpresa ! #dsmow029#0;
     |SI swAlgun = 1;
         |HAZ TotalModelo;
     |FINSI;
     nLaEmpresa = #dsmow029#0;
     |HAZ LeeLaEmpresa;
 |FINSI;

 |SI swPrModelo = 0;
     swPrModelo = 1;
     nElModelo = #dsmow029#1;
     |HAZ LeeElModelo;
 |FINSI;

 |SI nElModelo ! #dsmow029#1;
     |HAZ TotalModelo;
     nElModelo = #dsmow029#1;
     |HAZ LeeElModelo;
 |FINSI;

 |SI swPrAny = 0;
     nElAny  = #dsmow029#2;
     swPrAny = 1;
 |FINSI;

 |SI nElAny ! #dsmow029#2;
     enSwLinea = 1;
     nElAny = #dsmow029#2;
 |FINSI;

 |SI #dsmow029#29 = "T";
     |SI #dsmow029#3 = 3;  eaLit1 = "1§Trimestre"; |FINSI;
     |SI #dsmow029#3 = 6;  eaLit1 = "2§Trimestre"; |FINSI;
     |SI #dsmow029#3 = 9;  eaLit1 = "3§Trimestre"; |FINSI;
     |SI #dsmow029#3 = 12; eaLit1 = "4§Trimestre"; |FINSI;
 |SINO;
     |SI #dsmow029#3 = 1;  eaLit1 = "Enero"; |FINSI;
     |SI #dsmow029#3 = 2;  eaLit1 = "Febrero"; |FINSI;
     |SI #dsmow029#3 = 3;  eaLit1 = "Marzo"; |FINSI;
     |SI #dsmow029#3 = 4;  eaLit1 = "Abril     "; |FINSI;
     |SI #dsmow029#3 = 5;  eaLit1 = "Mayo      "; |FINSI;
     |SI #dsmow029#3 = 6;  eaLit1 = "Junio     "; |FINSI;
     |SI #dsmow029#3 = 7;  eaLit1 = "Julio     "; |FINSI;
     |SI #dsmow029#3 = 8;  eaLit1 = "Agosto    "; |FINSI;
     |SI #dsmow029#3 = 9;  eaLit1 = "Septiembre"; |FINSI;
     |SI #dsmow029#3 = 10; eaLit1 = "Octubre   "; |FINSI;
     |SI #dsmow029#3 = 11; eaLit1 = "Noviembre "; |FINSI;
     |SI #dsmow029#3 = 12; eaLit1 = "Diciembre "; |FINSI;
 |FINSI;

 |SI #dsmow029#25 ! 0; |O #dsmow029#26 ! 0; |O #dsmow029#28 ! 0;
     |SI #dsmow029#27 = "S"; eaTex = "Automatico"; |FINSI;
     |SI #dsmow029#27 = "N"; eaTex = "No aplica "; |FINSI;
     |SI #dsmow029#27 = "M"; eaTex = "Manual    "; |FINSI;
     |SI #dsmow029#27 = "X"; eaTex = "Sin (F5)  "; #dsmow029#26 = #dsmow029#28; |FINSI;
 |FINSI;


 |SI #dsmow029#6 ! 0; |O #dsmow029#7 ! 0; |O #dsmow029#8 ! 0; |O #dsmow029#16 ! 0;
    |O #dsmow029#25 ! 0; |O #dsmow029#26 ! 0; |O #dsmow029#28 ! 0;

     |PRINT;
     enSwLinea = 0;
     swAlgun   = 1;
 |FINSI;
|FPRC;

|PROCESO dsmow0291;
  |SI swAlgun = 1;
      |HAZ TotalModelo;
  |FINSI;
  swAlgun = 0;
|FPRC;

|DEFBUCLE dsmow029;
 #dsmow029#1;
 ;
 00000, 000, #dsmoy089#15, #dsmoy089#28;
 99999, 999, #dsmoy089#15, #dsmoy089#30;
 ;
 NULL, dsmow0290, NULL, NULL, dsmow0291;
|FIN;

|PROCESO Imprimir;
         |IMPRE 0;
         |SI FSalida ! 0; |ACABA; |FINSI;

         |INFOR informe;
         |SI FSalida ! 0; |FINIMP; |ACABA; |FINSI;

         swAlgun     = 0;
         swPrEmpresa = 0;
         swPrModelo  = 0;
         swPrAny     = 0;
         enSwLinea   = 0;

         |BUCLE dsmow029;

         |FININF;
         |FINIMP;
|FPRC;

|| ***********************************************************************
|| ///////////////////////////////////////////////////////////////

|PROCESO ITipo3;  |TIPO 3;

 nDMod = 300;
 nHMod = 370;
 eaRaya = &179;
 aPeriodico = "T";

 |DBASE aPathModelo;  |QBT aPathModelo;
 aDef = aPathModelo + "def/dsmow029.mas";
 |CARGA_DEF aDef, program@;
 |SI FSalida ! 0;
     aAlfa = "     Error en cargar el Def dsmow029";
     |MENAV aAlfa;
     |ACABA;
 |FINSI;

 |DBASE aPathModelo;  |QBT aPathModelo;
 aDef = aPathModelo + "def/dsmom004.mas";
 |CARGA_DEF aDef, dsmom04@;
 |SI FSalida ! 0;
     aAlfa = "     Error en cargar el Def dsmom004";
     |MENAV aAlfa;
     |DESCARGA_DEF #777;
     |ACABA;
 |FINSI;

 aFichero = ("07" + Usuario) % 108;
 |NOME_DAT #dsmow029#aFichero#;
 |DELINDEX #dsmow029;

 |NOME_DAT #777 aFichero;

 swAlgun     = 0;
 swPrEmpresa = 0;
 swPrModelo  = 0;

 #dsmoy089#14 = 1990;
 nHastaAny    = #dsmoy089#15;
 nDesdePer    = 1;
 nHastaPer    = #dsmoy089#28 - 1;
 |SI nHastaPer = 0;
     nHastaPer = 12;
     nHastaAny = nHastaAny - 1;
 |FINSI;

 |ABRE #dsmom004;
 |ABRE #dsmow029;
 |SI #dsmoy089#0 ! 0;
     nDEmpresa = #dsmoy089#0;
     nHEmpresa = #dsmoy089#1;
     |BUCLE CreaAuxiliar;
 |SINO;
     |PARA nCampo = 2;  |SI nCampo [ 13;  |HACIENDO nCampo = nCampo + 1;
           nDEmpresa = #dsmoy089#nCampo#;
           nHEmpresa = #dsmoy089#nCampo#;
           |BUCLE CreaAuxiliar;         || CreaAuxiliar Valor
     |SIGUE;
 |FINSI;

 #dsmoy089#14 = #dsmoy089#15;
 nHastaAny    = #dsmoy089#15;
 nDesdePer    = #dsmoy089#28;
 nHastaPer    = #dsmoy089#30;

 |ABRE #dsm30301;
 |ABRE #dsm32201;
 |SI #dsmoy089#0 ! 0;
     nDEmpresa = #dsmoy089#0;
     nHEmpresa = #dsmoy089#1;
     |BUCLE EstasEmpresas;
 |SINO;
     |PARA nCampo = 2;  |SI nCampo [ 13;  |HACIENDO nCampo = nCampo + 1;
           nDEmpresa = #dsmoy089#nCampo#;
           nHEmpresa = #dsmoy089#nCampo#;
           |BUCLE EstasEmpresas;
     |SIGUE;
 |FINSI;

 |CIERRA #dsm32201;
 |CIERRA #dsm30301;
 |CIERRA #dsmow029;
 |CIERRA #dsmom004;

 |SI swAlgun = 1;
    |HAZ Imprimir;
 |SINO;
    |MENAV "    Seleccion vacia ... ";
 |FINSI;

 |DESCARGA_DEF #dsmom04@;
 |DESCARGA_DEF #777;
 |DELINDEX #dsmow029;
|FPRC;
