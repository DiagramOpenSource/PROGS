|FICHEROS;
   dsmoy077 #0;

   dsmom004 #4;
   dsmom095 #95;

   dsmoc349 #349;
   dsmod349 #350;

   :/basica/def/agifigen #118;
|FIN;

|VARIABLES;
   informe     = "dsmoy077";
   nDEmpresa   = 0;
   nHEmpresa   = 0;
   nCampo      = 0;
   nCampo1     = 0;
   nCampo2     = 0;
   nCampo3     = 0;
   fFecha      = @;
   nAnyo       = 0;
   nMes        = 0;
   aAlfa       = "";
   nNume1      = 0;
   nNume2      = 0;
   nNume3      = 0;
   nPara1      = 0;
   nSw         = 0;
   nPer        = 0;
   nSwHay      = 0;
   nPrint      = 0;
   nEjer       = 0;
   nPeriodo    = 0;
   nPerLeer    = 0;
   nComplem    = 0;
   nModelo     = 0;
   nDPer349    = 0;
   nDPeriodo   = 0;
   nHPeriodo   = 0;
   aPeriodo    = "";

   aTipo1      = "";
   aTipo2      = "";
   &nSwLinea   = 0;
|FIN;

|INCLUYE i_variar;
|INCLUYE i_varcon;
|INCLUYE i_varlib;

|| //////////////////// Calculos de Pantalla \\\\\\\\\\\\\\\\\\\\\\\\\\
|CALCULO Eano; |TIPO 7;
     fFecha = ~;
     aAlfa  = fFecha % 402;   nMes  = aAlfa;
     aAlfa  = fFecha % -104;  nAnyo = aAlfa;

     |SI nMes [ 3;
         #0#26 = 12;
         #0#1 = nAnyo - 1;
         |HAZ Periodo;
         |PINTA #0#1;
         |PINTA #0#26;
         |ACABA;
     |FINSI;

     |SI nMes [ 6;
         #0#26 = 3;
         #0#1 = nAnyo;
         |HAZ Periodo;
         |PINTA #0#1;
         |PINTA #0#26;
         |ACABA;
     |FINSI;

     |SI nMes [ 9;
         #0#26 = 6;
         #0#1 = nAnyo;
         |HAZ Periodo;
         |PINTA #0#1;
         |PINTA #0#26;
         |ACABA;
     |FINSI;

     |SI nMes [ 12;
         #0#26 = 9;
         #0#1 = nAnyo;
         |HAZ Periodo;
         |PINTA #0#1;
         |PINTA #0#26;
         |ACABA;
    |FINSI;
|FCAL;

|PROCESO Periodo;
     #0#27 = "          ";
  ||   |SI #0#26 = 1;   #0#27 = "ENERO     ";  |FINSI;
  ||   |SI #0#26 = 2;   #0#27 = "FEBRERO   ";  |FINSI;
  ||   |SI #0#26 = 4;   #0#27 = "ABRIL     ";  |FINSI;
  ||   |SI #0#26 = 5;   #0#27 = "MAYO      ";  |FINSI;
  ||   |SI #0#26 = 7;   #0#27 = "JULIO     ";  |FINSI;
  ||   |SI #0#26 = 8;   #0#27 = "AGOSTO    ";  |FINSI;
  ||   |SI #0#26 = 10;  #0#27 = "OCTUBRE   ";  |FINSI;
  ||   |SI #0#26 = 11;  #0#27 = "NOVIEMBRE ";  |FINSI;
  ||   |SI #0#26 = 99;  #0#27 = "ANUAL     ";  |FINSI;

     |SI #0#26 = 3;   #0#27 = "MARZO     ";  |FINSI;
     |SI #0#26 = 6;   #0#27 = "JUNIO     ";  |FINSI;
     |SI #0#26 = 9;   #0#27 = "SEPTIEMBRE";  |FINSI;
     |SI #0#26 = 12;  #0#27 = "DICIEMBRE ";  |FINSI;

     |SI #0#27 = "          ";
         |MENAV "     Periodo Incorrecto. Solo Trimestres";
         |ERROR;
     |FINSI;

     |PINTA #0#27;
|FPRC;

|CALCULO Tipo7;  |TIPO 7;
     |SI enEmpresa ! 0;
         #0#2  = enEmpresa;  |PINTA #0#2;
         #0#3  = enEmpresa;  |PINTA #0#3;

         |C_M #0#2, 1, "N";
         |C_M #0#3, 1, "N";
     |FINSI;
|FCAL;

|CALCULO Parrilla; |TIPO 0;
     |SI #0#2 = 0;
         #0#2 = 0;  |PINTA #0#2;
         #0#3 = 0;  |PINTA #0#3;  |C_M #0#3, 1, "N";
         |PARA nCampo = 4;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |SINO;
         |SI enEmpresa = 0;
             |C_M #0#2, 1, "S";
             |C_M #0#3, 1, "S";
         |FINSI;

         |PARA nCampo = 4;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "N";
               #0nCampo = 0;  |PINTA #0nCampo;
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO NoMasEmpresas; |TIPO 0;
     |SI #0Campo = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               #0nCampo = 0;  |C_M #0nCampo, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |FINSI;
|FCAL;

|| *************************************************************************
|| /////////////////
|PROCESO ElPeriodo;
     nComplem = -1;
     aPeriodo = "";

     #4#0  = enEmpresa;
     #4#1  = nEjer;
     #4#2  = nPeriodo;
     #4#3  = nModelo;
     #4#4  = 99;
     |LEE 040#4];
     |SI FSalida = 0;
         |LEE 040#4a;
     |SINO;
         |LEE 040#4u;
     |FINSI;
     |SI FSalida = 0; |Y #4#0 = enEmpresa; |Y #4#1 = nEjer;
          |Y #4#2 = nPeriodo; |Y #4#3 = nModelo;
             nComplem = #4#4;
     |FINSI;

     |SI nComplem ! -1;
         |SI #4#22 = "M";
             aPeriodo  = "MENSUAL   ";
         |FINSI;
         |SI #4#22 = "T";
             aPeriodo  = "TRIMESTRAL";
         |FINSI;

         |SI nPeriodo = 1;   nDPeriodo = 1;  nHPeriodo = 3;  |FINSI;
         |SI nPeriodo = 2;   nDPeriodo = 1;  nHPeriodo = 3;  |FINSI;
         |SI nPeriodo = 3;   nDPeriodo = 1;  nHPeriodo = 3;  |FINSI;
         |SI nPeriodo = 4;   nDPeriodo = 4;  nHPeriodo = 6;  |FINSI;
         |SI nPeriodo = 5;   nDPeriodo = 4;  nHPeriodo = 6;  |FINSI;
         |SI nPeriodo = 6;   nDPeriodo = 4;  nHPeriodo = 6;  |FINSI;
         |SI nPeriodo = 7;   nDPeriodo = 7;  nHPeriodo = 9;  |FINSI;
         |SI nPeriodo = 8;   nDPeriodo = 7;  nHPeriodo = 9;  |FINSI;
         |SI nPeriodo = 9;   nDPeriodo = 7;  nHPeriodo = 9;  |FINSI;
         |SI nPeriodo = 10;  nDPeriodo = 10; nHPeriodo = 12; |FINSI;
         |SI nPeriodo = 11;  nDPeriodo = 10; nHPeriodo = 12; |FINSI;
         |SI nPeriodo = 12;  nDPeriodo = 10; nHPeriodo = 12; |FINSI;
     |FINSI;
|FPRC;

|| ****************************************************
|PROCESO LeeModelo;
     aTipo1 = #349#6 % 101;
     aTipo2 = #349#6 % -101;

     |SI aTipo1 = "E"; |O aTipo1 = "S";
         nSw = 0;
         |SI aTipo2 = "R";   || comprobar periodo rectificado

             |SI #349#26 > 10;
                 |SI #349#26 ] 11; |Y #349#26 [ 13; nPer =  3; |FINSI;
                 |SI #349#26 ] 14; |Y #349#26 [ 16; nPer =  6; |FINSI;
                 |SI #349#26 ] 17; |Y #349#26 [ 19; nPer =  9; |FINSI;
                 |SI #349#26 ] 20; |Y #349#26 [ 22; nPer = 12; |FINSI;
             |SINO;
                 |SI #349#26 = 1; nPer =  3; |FINSI;
                 |SI #349#26 = 2; nPer =  6; |FINSI;
                 |SI #349#26 = 3; nPer =  9; |FINSI;
                 |SI #349#26 = 4; nPer = 12; |FINSI;
             |FINSI;

             nSw = 1;
             |SI #349#25 = 0;       || no esta informado el ejercicio
                 nSw = 0;
             |SINO;
                 |SI #349#26 = 0;   || no esta informado el periodo
                     |SI #0#31 = #349#25; |O #0#34 = #349#25;
                       |O #0#37 = #349#25; |O #0#40 = #349#25;
                          nSw = 0;
                     |FINSI;
                 |SINO;
                     |SI #0#31 = #349#25; |Y #0#32 = nPer; nSw = 0; |FINSI;
                     |SI #0#34 = #349#25; |Y #0#35 = nPer; nSw = 0; |FINSI;
                     |SI #0#37 = #349#25; |Y #0#38 = nPer; nSw = 0; |FINSI;
                     |SI #0#40 = #349#25; |Y #0#41 = nPer; nSw = 0; |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;

         |SI nSw = 0;
             |SI aTipo2 = " "; #0#70 = #0#70 + #349#22;             |FINSI;
             |SI aTipo2 = "R"; #0#71 = #0#71 + (#349#22 - #349#27); |FINSI;
             nSwHay   = 1;
         |FINSI;

    |FINSI;
|FPRC;

|DEFBUCLE LeeModelo;
   #349#1;
   ;
   #4#0, #4#1, nDPer349, #4#3, #4#4, 01, "  ", 0000, 00, "            ";
   #4#0, #4#1, #4#2,     #4#3, #4#4, 98, "zz", 9999, 99, "zzzzzzzzzzzz";
   e;
   NULL, LeeModelo;
|FIN;

|PROCESO LeeModelos_M;
  nComplem = #4#4;
  |SI #4#4 > 0; |Y #4#24 = "S";
      #0#70 = 0;
      #0#71 = 0;             || vuelve a acumular
  |FINSI;
  |SI #4#22 = "M"; nDPer349 = #4#2;     |FINSI;
  |SI #4#22 = "T"; nDPer349 = #4#2 - 2; |FINSI;
  |BUCLE LeeModelo;
|FPRC;

|DEFBUCLE LeeModelos_M;
  #4#1;
  ;
  enEmpresa, nEjer, nPerLeer, nModelo, 00;
  enEmpresa, nEjer, nPerLeer, nModelo, 99;
  e;
  NULL, LeeModelos_M;
|FIN;

|PROCESO LeeModelos_M004;
  |PARA nPerLeer = nDPeriodo; |SI nPerLeer [ nHPeriodo; |HACIENDO nPerLeer = nPerLeer + 1;

        #0#70 = 0;
        #0#71 = 0;
        |BUCLE LeeModelos_M;

        nNume2 = nNume1 + 1;
        nNume3 = nNume1 + 2;
        #0nNume1 = #0nNume1 + #0#70;
        #0nNume2 = #0nNume2 + #0#71;
        #0nNume3 = #0nNume1 + #0nNume2;
  |SIGUE;
|FPRC;

|| *************************************************************************
|PROCESO LEmpresa;

  enEmpresa  = #agifigen#0;

  |PDEFECTO #0,43,68;
  #0#43 = enEmpresa;
  #0#44 = #agifigen#13;
  #0#45 = #agifigen#1;
|| ------------------------------------------------------------------------
  || Lee Periodicidad Modelo 349

   nSwHay   = 0;

   nNume1   = 46;   ||Acumulado del trimestre
   nEjer    = #0#1;
   nPeriodo = #0#26;
   |HAZ ElPeriodo;
   |SI nComplem = -1; |ACABA; |FINSI; || no existe

   #0#62 = aPeriodo;
   |HAZ LeeModelos_M004;   || suma totales

   nCampo2 = 64;
   |PARA nCampo = 31; |SI nCampo [ 40; |HACIENDO nCampo = nCampo + 3;

         nCampo1  = nCampo + 1;
         nEjer    = #0nCampo;
         nPeriodo = #0nCampo1;
         nNume1   = nNume1 + 3;
         |HAZ ElPeriodo;
         |SI nComplem ! -1;
             #0nCampo2 = aPeriodo;
             |HAZ LeeModelos_M004;   || suma totales
         |FINSI;
         nCampo2 = nCampo2 + 1;
   |SIGUE;

   #0#61 = #0#48 + #0#51 + #0#54 + #0#57 + #0#60;
   #0#63 = "TRIMESTRAL"; |SI #0#61 ] #0#30; #0#63 = "MENSUAL   "; |FINSI;

   |SI nSwHay = 1;
       nSw = 0;
       |SI #0#24 = "T"; nSw = 1; |FINSI;
       |SI #0#24 = "O"; |Y #0#61 ] #0#30; nSw = 1; |FINSI;
       |SI #0#24 = "D"; |Y #0#62 ! #0#63; nSw = 1; |FINSI;
       |SI nSw = 1;
           nSwLinea = 0;
           |SI #0#61 ] #0#30; #0#68 = #0#68 + 1; |FINSI;
           |SI #0#62 ! #0#63; #0#69 = #0#69 + 1; nSwLinea = 1; |FINSI;
           |PRINT;
           nPrint = 1;
       |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE agifigen;
   #agifigen#1;
   ;
   nDEmpresa;
   nHEmpresa;
   e;
   NULL, LEmpresa;
|FIN;

|DEFBUCLE agifigen_2;
   #agifigen#2;
   0;
   "                                        ", nDEmpresa;
   "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz", nHEmpresa;
   e;
   NULL, LEmpresa;
|FIN;

|DEFBUCLE agifigen_3;
   #agifigen#4;
   0;
   "            ", nDEmpresa;
   "zzzzzzzzzzzz", nHEmpresa;
   e;
   NULL, LEmpresa;
|FIN;

|PROCESO NomPeriodo;
     aPeriodo = "          ";
     |SI nPeriodo = 1;   aPeriodo = "     ENERO";  |FINSI;
     |SI nPeriodo = 2;   aPeriodo = "   FEBRERO";  |FINSI;
     |SI nPeriodo = 3;   aPeriodo = "1er.TRIMESTRE"; |FINSI;
     |SI nPeriodo = 4;   aPeriodo = "     ABRIL";  |FINSI;
     |SI nPeriodo = 5;   aPeriodo = "      MAYO";  |FINSI;
     |SI nPeriodo = 6;   aPeriodo = " 2o.TRIMESTRE"; |FINSI;
     |SI nPeriodo = 7;   aPeriodo = "     JULIO";  |FINSI;
     |SI nPeriodo = 8;   aPeriodo = "    AGOSTO";  |FINSI;
     |SI nPeriodo = 9;   aPeriodo = "3er.TRIMESTRE"; |FINSI;
     |SI nPeriodo = 10;  aPeriodo = "   OCTUBRE";  |FINSI;
     |SI nPeriodo = 11;  aPeriodo = " NOVIEMBRE";  |FINSI;
     |SI nPeriodo = 12;  aPeriodo = " 4o.TRIMESTRE"; |FINSI;
|FPRC;

|PROCESO CalPeriodos;
   |PDEFECTO #0,31,72;

   |PARA nCampo = 31; |SI nCampo [ 40; |HACIENDO nCampo = nCampo + 3;
         nCampo1 = nCampo + 1;
         nCampo2 = nCampo + 2;

         nPeriodo = nPeriodo - 3;
         |SI nPeriodo [ 0;
             nPeriodo = 12;
             nEjer    = nEjer - 1;
         |FINSI;
         #0nCampo  = nEjer;
         #0nCampo1 = nPeriodo;
         |HAZ NomPeriodo;
         #0nCampo2 = aPeriodo;
   |SIGUE;
|FPRC;
|| \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
|CALCULO Tipo3;  |TIPO 3;

    nModelo  = #0#28;
    nEjer    = #0#1;
    nPeriodo = #0#26;
    aAlfa = #0#27; |QBF aAlfa;
    #0#27 = ("          " + aAlfa) % -110;
    |HAZ CalPeriodos;

    |MENAV "0000 Recuerde seleccionar el papel de la impresora en Horizontal";
    |IMPRE 0;
    |SI FSalida ! 0;
        |MENAV "    Proceso Interrumpido";
        |ACABA;
    |FINSI;

    |INFOR informe;
    |SI FSalida ! 0;
        |MENAV "    Error en el Informe";
        |ACABA;
    |FINSI;

    nPrint = 0;
    |ABRE #4;
    |ABRE #95;
    |SI #0#2 ! 0;
        nDEmpresa = #0#2;
        nHEmpresa = #0#3;
        |SI #0#29 = 1; |BUCLE agifigen;   |FINSI;
        |SI #0#29 = 2; |BUCLE agifigen_2; |FINSI;
        |SI #0#29 = 3; |BUCLE agifigen_3; |FINSI;
    |SINO;
        |PARA nPara1 = 4;  |SI nPara1 [ 23;  |HACIENDO nPara1 = nPara1 + 1;
              |SI #0nPara1 ! 0;
                  nDEmpresa = #0nPara1;
                  nHEmpresa = #0nPara1;
                  |SI #0#29 = 1; |BUCLE agifigen;   |FINSI;
                  |SI #0#29 = 2; |BUCLE agifigen_2; |FINSI;
                  |SI #0#29 = 3; |BUCLE agifigen_3; |FINSI;
              |FINSI;
        |SIGUE;
    |FINSI;
    |CIERRA #95;
    |CIERRA #4;

    |SI nPrint = 0;
        |MENAV "     Seleccion Vacia.";
    |SINO;
        |PIEINF;
    |FINSI;
    |FININF;
    |FINIMP;
|FCAL;
