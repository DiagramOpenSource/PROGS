|FICHEROS;
     dsmoy000 #0;
     dsmom002 #2;
     dsmom004 #4;
     dsmom107 #107;
     dsmow600 #600;
     dsmow601 #601,MANTE;

     dsmow541;
     dsmoc115 #116;
     dsmod115 #115;
     dsmow014 #999;

     &clientes@;
     &datosper@;
|FIN;

|VARIABLES;
     fFecIni = @;
     fFecFin = @;
     nSw     = 0;

     &enBase1  = 0;
     &enBase2  = 0;
     &enReten1 = 0;
     &enReten2 = 0;
|FIN;

|INCLUYE i_varemi;

|PROCESO CargaImprime115;
     aAlfa = "del err" + (("00000" + #999#0) % -105) + ".TXT" + &13 + &10;
     |XGRABA nHandle1, aAlfa;

     aAlfa = "wait mipf32 ";
     aAlfa = aAlfa + "/E:115" + (("00000" + #999#0) % -105) + ".TXT ";
     aAlfa = aAlfa + "/R:err" + (("00000" + #999#0) % -105) + ".TXT ";
     |SI eaImpresora ! "";
         aAlfa = aAlfa + "/I:" + &34 + eaImpresora + &34;
     |FINSI;
     aAlfa = aAlfa + " /C:" + #601#0;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle1, aAlfa;
|FPRC;

|PROCESO TDeclaracion115;
     |SI #115#10 > 0;
          enNume = #115#10;  |HAZ Conver13;  #dsmow541#37 = eaAlfa;

          enModelo = 115;  enForzar = 0;  |HAZ CogeDatosBancos;

          |SI eaFormaPago = "1";  #dsmow541#35 = "X";  |FINSI;
          |SI eaFormaPago ! "1";  #dsmow541#36 = "X";  |FINSI;

          #dsmow541#38 = eaEntidad;
          #dsmow541#39 = eaOficina;
          #dsmow541#40 = eaDC;
          #dsmow541#41 = eaCuenta;
     |SINO;
          enNume  = 0;  |HAZ Conver13;  #dsmow541#37 = eaAlfa;
     |FINSI;

     #dsmow541#4 = "";
     |SI nTecla = 3;
         |SI #115#10 > 0;
                                                     #dsmow541#4 = "I";
             |SI eaFormaPago = "3";                  #dsmow541#4 = "U";  |FINSI;
             |SI eaFormaPago = "4";  |Y #0#6 < 2013; #dsmow541#4 = "A";  |FINSI;
             |SI eaFormaPago = "5";  |Y #0#6 < 2013; #dsmow541#4 = "E";  |FINSI;
             |SI eaFormaPago = "6";                  #dsmow541#4 = "G";  |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Leedsmoc115;
 enBase1  = #116#8  + #116#14 + #116#20;
 enReten1 = #116#10 + #116#16 + #116#22;
 enBase2  = #116#11 + #116#17 + #116#23;
 enReten2 = #116#13 + #116#19 + #116#25;
 |PRINT;
 nSw = 1;
|FPRC;

|DEFBUCLE Leedsmoc115;
 #116#1;
 ;
 #115#0, #115#1, #115#2, #115#3, #115#4, 00, "            ", 0000, 01;
 #115#0, #115#1, #115#2, #115#3, #115#4, 99, "zzzzzzzzzzzz", 9999, 99;
 ;
 NULL, Leedsmoc115;
|FIN;

|PROCESO RelacionLinea;
  |FININF;
  |INFOR "m115co03";
  |SI FSalida = 0;
      nSw = 0;
      |BUCLE Leedsmoc115;
      |SI nSw = 1;  |PIEINF;  |FINSI;
      |FININF;
  |FINSI;
  |INFOR "m115co02";
|FPRC;

|PROCESO Carga115_2002;
     enCambiaMoneda = 1;

     |SI nTecla = 1;
         aAbre = eaPathEmision + "115" + (("00000" + #999#0) % -105) + ".TXT";
         |XABRE "BW", aAbre, nHandle2;
     |FINSI;

     |SI nTecla = 3;
         aAbre = eaPathEmision + "115" + (("00000" + #999#0) % -105) + ".TXT";
         |XABRE "BW", aAbre, nHandle2;
     |FINSI;

     |ABRE #115;
     #115#0 = #4#0;
     #115#1 = #4#1;
     #115#2 = #4#2;
     #115#3 = #4#3;
     #115#4 = #4#4;
     #115#5 = 0;
     |LEE 040#115=;
     |SI FSalida ! 0;  |CIERRA #115;  |ACABA;  |FINSI;
     |CIERRA #115;

     enCodCli = #115#0;
     |HAZ LeePersona;

     |DDEFECTO #dsmow541;

     #dsmow541#1  = "115";
     #dsmow541#2  = "01";
     #dsmow541#3  = "";

     |SI enSwDeDonde = 1;
         #dsmow541#5   = (("00" + #clientes@#15) % -102) + (("000" + #clientes@#16) % -103);
         eaVarDni = #clientes@#3;  |HAZ CalculameDNI;   #dsmow541#6   = eaVarDni;
         eaAlfa   = #clientes@#57;  |HAZ QuitaRaros;    #dsmow541#7   = eaAlfa;

         aAlfa1   = #datosper@#2;  |QBT aAlfa1;
         |SI aAlfa1 ! "";
             eaAlfa = #datosper@#2;  |HAZ QuitaRaros;  aAlfa1 = eaAlfa;
             eaAlfa = #datosper@#3;  |HAZ QuitaRaros;  aAlfa2 = eaAlfa;
             #dsmow541#8 = aAlfa1 + " " + aAlfa2;
             eaAlfa = #datosper@#4;  |HAZ QuitaRaros;  #dsmow541#9 = eaAlfa;
         |SINO;
             eaAlfa = #clientes@#1;  |HAZ QuitaRaros;  #dsmow541#8  = eaAlfa;
             #dsmow541#9  = ".";
         |FINSI;
         #dsmow541#10 = #clientes@#29;
         eaAlfa  = #clientes@#30;  |HAZ QuitaRaros;  #dsmow541#11 = eaAlfa;
         #dsmow541#12 = #clientes@#31 % 104;
         #dsmow541#13 = #clientes@#32;
         #dsmow541#14 = #clientes@#33;
         #dsmow541#15 = #clientes@#34;
         eaAlfa  = #clientes@#54;  |HAZ QuitaRarosTfno;   #dsmow541#16 = eaAlfa;
         eaAlfa  = #clientes@#37;  |HAZ QuitaRaros;       #dsmow541#17 = eaAlfa;
         eaAlfa  = #clientes@#38;  |HAZ QuitaRaros;       #dsmow541#18 = eaAlfa;
         #dsmow541#19 = (("00" + #clientes@#35) % -102) + (("000" + #clientes@#36) % -103);
         eaAlfa  = #clientes@#53;  |HAZ QuitaRaros;       #dsmow541#29 = eaAlfa;
         eaAlfa  = #clientes@#55;  |QBF eaAlfa;
         |SI eaAlfa ! "";
             eaAlfa  = #clientes@#55; |HAZ QuitaRarosTfno; #dsmow541#30 = eaAlfa;
         |SINO;
             #dsmow541#30 = #dsmow541#16;
         |FINSI;

         eaDeleg = #clientes@#17;
         eaAdmin = #clientes@#18;
     |SINO;
         aAlfa = #clientes@#96; |QBF aAlfa; |SI aAlfa = ""; #clientes@#96 = #clientes@#1; |FINSI;
         #dsmow541#5   = (("00" + #clientes@#63) % -102) + (("000" + #clientes@#64) % -103);
         eaVarDni = #clientes@#13;  |HAZ CalculameDNI;   #dsmow541#6   = eaVarDni;
         eaAlfa   = #clientes@#1;  |HAZ QuitaRaros;      #dsmow541#8   = eaAlfa;
         #dsmow541#9   = ".";
         #dsmow541#10  = #clientes@#3;
         eaAlfa   = #clientes@#4;  |HAZ QuitaRaros;      #dsmow541#11  = eaAlfa;
         #dsmow541#12 = #clientes@#5 % 104;
         #dsmow541#13 = #clientes@#6;
         #dsmow541#14 = #clientes@#7;
         #dsmow541#15 = #clientes@#8;
         eaAlfa  = #clientes@#14;  |HAZ QuitaRarosTfno; #dsmow541#16 = eaAlfa;
         eaAlfa  = #clientes@#11;  |HAZ QuitaRaros;     #dsmow541#17 = eaAlfa;
         eaAlfa  = #clientes@#12;  |HAZ QuitaRaros;     #dsmow541#18 = eaAlfa;
         #dsmow541#19 = (("00" + #clientes@#9) % -102) + (("000" + #clientes@#10) % -103);
         eaAlfa  = #clientes@#96;  |HAZ QuitaRaros;     #dsmow541#29 = eaAlfa;
         eaAlfa  = #clientes@#61;  |QBF eaAlfa;
         |SI eaAlfa ! "";
             eaAlfa  = #clientes@#61; |HAZ QuitaRarosTfno; #dsmow541#30 = eaAlfa;
         |SINO;
             #dsmow541#30 = #dsmow541#16;
         |FINSI;
         eaDeleg = #clientes@#91;
         eaAdmin = #clientes@#92;
     |FINSI;

     #dsmow541#20  = #115#1;

     |SI aPeriodo = "T";
         |SI #115#2 = 3;   #dsmow541#21 = "1T";  |FINSI;
         |SI #115#2 = 6;   #dsmow541#21 = "2T";  |FINSI;
         |SI #115#2 = 9;   #dsmow541#21 = "3T";  |FINSI;
         |SI #115#2 = 12;  #dsmow541#21 = "4T";  |FINSI;
     |SINO;
         #dsmow541#21 = ("00" + #115#2) % -102;
     |FINSI;

     #dsmow541#22 = ("000000" + #115#6) % -106;
     enNume  = #115#7;  |HAZ Conver13;  #dsmow541#23 = eaAlfa;
     enNume  = #115#8;  |HAZ Conver13;  #dsmow541#24 = eaAlfa;
     enNume  = #115#9;  |HAZ Conver13;  #dsmow541#25 = eaAlfa;
     enNume  = #115#10;
     |SI enNume < 0;  enNume = 0;  |FINSI;
                        |HAZ Conver13;  #dsmow541#26 = eaAlfa;

     |HAZ TDeclaracion115;

     |SI #115#4 > 0;
         #dsmow541#27 = #4#20;
         #dsmow541#28 = #4#21;
     |FINSI;

     eaAlfa  = #0#7;  |HAZ FechaBonito;
     #dsmow541#42 = eaDiaB;
     #dsmow541#43 = eaMesB;
     #dsmow541#44 = eaAnyoB;
     #dsmow541#45 = &13 + &10;

     |SI nTecla = 1;
         #dsmow541#4  = "";
         #dsmow541#7  = "";
         #dsmow541#27 = "";
         #dsmow541#29 = "";
         #dsmow541#30 = "";
         #dsmow541#31 = "";
         nTCampo = 45;
     |FINSI;

     |SI nTecla = 3;
         #dsmow541#2  = "";
         #dsmow541#3  = "";
         #dsmow541#5  = "";
         #dsmow541#8  = "";
         #dsmow541#9  = "";
         #dsmow541#10 = "";
         #dsmow541#11 = "";
         #dsmow541#12 = "";
         #dsmow541#13 = "";
         #dsmow541#14 = "";
         #dsmow541#15 = "";
         #dsmow541#16 = "";
         #dsmow541#17 = "";
         #dsmow541#18 = "";
         #dsmow541#19 = "";
         #dsmow541#42 = "";
         #dsmow541#43 = "";
         #dsmow541#44 = "";
         #dsmow541#45 = "";
         nTCampo = 44;
     |FINSI;

     |SI nTecla = 1;  |O nTecla = 3;
         aAlfa = "";
         |PARA nCampo = 1;  |SI nCampo [ nTCampo;  |HACIENDO nCampo = nCampo + 1;
               aAlfa = #dsmow541#nCampo#;
               |XGRABA nHandle2, aAlfa;
         |SIGUE;
         |XCIERRA nHandle2;

         |SI nTecla = 1;
             eaFOrigen  = eaPathEmision + "115" + (("00000" + #999#0) % -105) + ".TXT";
             eaFDestino = eaPathLanza + "115" + (("00000" + #999#0) % -105) + ".TXT";
             |HAZ CopiaFichero;

             |FBORRA eaFOrigen;

             |HAZ CargaImprime115;
         |FINSI;

         |SI nTecla = 3;
             eaFOrigen  = eaPathEmision + "115" + (("00000" + #999#0) % -105) + ".TXT";
             eaFDestino = eaPathInternet + "115" + (("00000" + #999#0) % -105) + ".TXT";
             |HAZ CopiaFichero;

             |FBORRA eaFOrigen;

             |HAZ GrabaImpreso;
         |FINSI;
     |SINO;
         |PRINT;
         |PIEINF;
         |SI #0#6 ] 2009;
             |HAZ RelacionLinea;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Periodicidad;
     |SI #2#8 > "01.01.0000";
         |SI #2#8 > fFecFin;  |ACABA;  |FINSI;
     |FINSI;
     |SI #2#9 > "01.01.0000";
         |SI #2#9 < fFecIni;  |ACABA;  |FINSI;
     |FINSI;

     aAlfa = #2#7 % 101;
     |SI aAlfa ! #4#22; |Y #4#22 ! " ";
         |SI #4#22 = "T"; #2#7 = "TRIMESTRAL"; |FINSI;
         |SI #4#22 = "M"; #2#7 = "MENSUAL   "; |FINSI;
         |SI #4#22 = "A"; #2#7 = "ANUAL     "; |FINSI;
     |FINSI;

     |SI #2#7 = "TRIMESTRAL";
         aPeriodo = "T";
     |SINO;
         aPeriodo = "M";
     |FINSI;
|FPRC;

|DEFBUCLE dsmom002;
     #2#1;
     ;
     #4#0, 01, 115;
     #4#0, 98, 115;
     ;
     NULL, Periodicidad;
|FIN;

|PROCESO QueHacemos115;
     |ABRE #4;
     #4#0  = #999#0;
     #4#1  = #999#1;
     #4#2  = #999#2;
     #4#3  = #999#5;
     #4#4  = #999#7;
     |LEE 040#4=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;
     |CIERRA #4;

     aPeriodo = "T";
     |BUCLE dsmom002;

     |SI #999#5 = 115;
         |HAZ Carga115_2002;
     |FINSI;
|FPRC;

|DEFBUCLE dsmow014C115;
     #999#1;
     6;
     00000, 0000, 00, "S";
     99999, 9999, 99, "S";
     ;
     NULL, QueHacemos115;
|FIN;

|DEFBUCLE dsmow014N115;
     #999#2;
     6;
     "                                        ", "S";
     "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz", "S";
     ;
     NULL, QueHacemos115;
|FIN;

|PROCESO AbreImprime115;
     aAbre = eaPathLanza + "imprime.bat";
     |XABRE "CBW", aAbre, nHandle1;

     aAlfa = "CD " + eaPathLanza + &13 + &10;    |XGRABA nHandle1, aAlfa;

     aAlfa    = #0#6;
     aAlfa    = aAlfa % -102;
     aVersion = "";

     |SI #0#6 ] 2008;
         aVersion = "01";
         |SI #0#6 = 2008;
             |SI #0#4 ] 4;
                 aVersion = "02";
             |FINSI;
         |FINSI;
     |FINSI;

     aAlfa1 = "DEL ERRORES.RST" + &13 + &10;      |XGRABA nHandle1, aAlfa1;

     |SI aVersion = "";
         aAlfa = "ZLS" + aAlfa + "MPF.EXE /T:" + eaPathLanza + &13 + &10;
     |SINO;
         aAlfa = "Z" + aAlfa + aVersion + "MPF.EXE /T:" + eaPathLanza + &13 + &10;
     |FINSI;

     |XGRABA nHandle1, aAlfa;
|FPRC;

|PROCESO EmiteEsto115_2002;
     aAlfa = "DEL *.wmf" + &13 + &10;             |XGRABA nHandle1, aAlfa;
     aAlfa = "DEL *.tab"  + &13 + &10;            |XGRABA nHandle1, aAlfa;
     aAlfa = "DEL *.dll"  + &13 + &10;            |XGRABA nHandle1, aAlfa;
     aAlfa = "DEL errorm~1.txt" + &13 + &10;      |XGRABA nHandle1, aAlfa;
     aAlfa = "DEL errormipf.txt"  + &13 + &10;    |XGRABA nHandle1, aAlfa;
     aAlfa = "DEL errmipf.txt"  + &13 + &10;      |XGRABA nHandle1, aAlfa;
     aAlfa = "DEL mipf32.exe"  + &13 + &10;       |XGRABA nHandle1, aAlfa;
     aAlfa = "DEL wait.exe"  + &13 + &10;         |XGRABA nHandle1, aAlfa;
     |XCIERRA nHandle1;

     |HAZ Copiampf;

     aAlfa = eaPathLanza + "IMPRIME";
     |RSYSTEM aAlfa;

     eaFichError = "err";
     eaFichDatos = #0#0;
     eaFichAuxil = "";

     |HAZ BuscaErroresL;
|FPRC;

|PROCESO Boton1151;
     |PTEC 824;
|FPRC;

|PROCESO Boton1152;
     |PTEC 825;
|FPRC;

|PROCESO Boton1153;
     |PTEC 826;
|FPRC;

|PROCESO Boton1154;
     |PTEC 827;
|FPRC;

|PROCESO Boton1155;
     |PTEC 806;
|FPRC;

|PROCESO Botones115;
     |BLANCO 0501 2380;

     |CONTROL_SIMPLE 0, "LBOTON, <F2> Emision Papel Oficial Laser          ", 0513, 0754, Boton1151;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F3> Emision Papel Oficial Continuo       ", 0913, 1154, Boton1152;
     nBoton2 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F4> Presentacion Telematica              ", 1313, 1554, Boton1153;
     nBoton3 = FSalida;

     |CONTROL_SIMPLE 0, "LBOTON, <F5> Informe de Comprobacion              ", 1713, 1954, Boton1154;
     nBoton4 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,ESC Cancelar", 2365, 2378, Boton1155;
     nBoton5 = FSalida;

     aF2 = &255 + "824";
     aF3 = &255 + "825";
     aF4 = &255 + "826";
     aF5 = &255 + "827";
     aF6 = &255 + "806";
     |PARA; |SI;  |HACIENDO;
         |LEETECLA aTecla;
         |SI aTecla = aF2;  nTecla = 1;   |SAL;  |FINSI;
         |SI aTecla = aF3;  nTecla = 2;   |SAL;  |FINSI;
         |SI aTecla = aF4;  nTecla = 3;   |SAL;  |FINSI;
         |SI aTecla = aF5;  nTecla = 4;   |SAL;  |FINSI;
         |SI aTecla = aF6;  nTecla = 0;   |SAL;  |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton4;
     |FIN_CONTROL_WINDOWS nBoton5;

     |PULSATECLA;
|FPRC;

|PROCESO Bloque2012;
     |SI eaParametro ! "115C";
         |HAZ Botones115;
     |SINO;
         nTecla = 4;
     |FINSI;

     |SI nTecla = 0;  enInfComp = 1;  |ACABA;  |FINSI;
     |SI nTecla = 4;  enInfComp = 1;  |FINSI;

     |SI nTecla = 1;
         |HAZ CompruebaEjecutable;
         |SI enError = 1;  |ACABA;  |FINSI;

          |PARA;  |SI;  |HACIENDO;
               #601#0 = #107#5;
               #601#1 = #107#7;

               |C_M #601#0, 1, "S";
               |C_M #601#1, 1, "S";
               |SI #107#6 = "N";  |C_M #601#0, 1, "N";  |FINSI;
               |SI #107#8 = "N";  |C_M #601#1, 1, "N";  |FINSI;

               nPedirPanta = 0;
               |SI #107#6 = "N";  |Y #107#8 = "N";  |Y #107#7 = "N";
                   nPedirPanta = 1;
               |FINSI;

               FSalida = 0;
               |SI nPedirPanta = 0;
                   |PINPA #0#601;
                   |PINDA #0#601;
                   |ENDATOS #1#601;
               |FINSI;

               |SI FSalida = 0;
                   |HAZ AbreImprime115;
                   |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI nTecla = 2;
         |MENAV "     Opcion no instalada";
         |ACABA;
     |FINSI;

     |SI nTecla = 4;
         |IMPRE 0;
         |SI FSalida ! 0;  |ACABA;  |FINSI;

         |INFOR "m115co02";

         |SI FSalida ! 0;  |FINIMP;  |ACABA;  |FINSI;
     |FINSI;

     nSwLee = 0;
     |SI #0#8 = "C";
         |BUCLE dsmow014C115;
     |SINO;
         |BUCLE dsmow014N115;
     |FINSI;

     |SI nTecla = 1;
         |HAZ EmiteEsto115_2002;
     |FINSI;

     |SI nTecla = 3;
         aAlfa =  "      Los ficheros generados estan en: " + eaPathInternet + " de su PC";
         |MENAV aAlfa;
     |FINSI;

     |SI nTecla = 4;
         |FININF;
         |FINIMP;
     |FINSI;
|FPRC;

|| --------------------------------------------------------------------------

|PROCESO Carga115_2013;

     enCodCli = #115#0;
     |HAZ LeePersona;

     |DDEFECTO #dsmow541;

     #dsmow541#1  = "115";
     #dsmow541#2  = "01";
     #dsmow541#3  = "";

     |SI enSwDeDonde = 1;
         #dsmow541#5   = (("00" + #clientes@#15) % -102) + (("000" + #clientes@#16) % -103);
         eaVarDni = #clientes@#3;  |HAZ CalculameDNI;   #dsmow541#6   = eaVarDni;
         eaAlfa   = #clientes@#57;  |HAZ QuitaRaros;    #dsmow541#7   = eaAlfa;

         aAlfa1   = #datosper@#2;  |QBT aAlfa1;
         |SI aAlfa1 ! "";
             eaAlfa = #datosper@#2;  |HAZ QuitaRaros;  aAlfa1 = eaAlfa;
             eaAlfa = #datosper@#3;  |HAZ QuitaRaros;  aAlfa2 = eaAlfa;
             #dsmow541#8 = aAlfa1 + " " + aAlfa2;
             eaAlfa = #datosper@#4;  |HAZ QuitaRaros;  #dsmow541#9 = eaAlfa;
         |SINO;
             eaAlfa = #clientes@#1;  |HAZ QuitaRaros;  #dsmow541#8  = eaAlfa;
             #dsmow541#9  = ".";
         |FINSI;
         #dsmow541#10 = #clientes@#29;
         eaAlfa  = #clientes@#30;  |HAZ QuitaRaros;  #dsmow541#11 = eaAlfa;
         #dsmow541#12 = #clientes@#31 % 104;
         #dsmow541#13 = #clientes@#32;
         #dsmow541#14 = #clientes@#33;
         #dsmow541#15 = #clientes@#34;
         eaAlfa  = #clientes@#54;  |HAZ QuitaRarosTfno;   #dsmow541#16 = eaAlfa;
         eaAlfa  = #clientes@#37;  |HAZ QuitaRaros;       #dsmow541#17 = eaAlfa;
         eaAlfa  = #clientes@#38;  |HAZ QuitaRaros;       #dsmow541#18 = eaAlfa;
         #dsmow541#19 = (("00" + #clientes@#35) % -102) + (("000" + #clientes@#36) % -103);
         eaAlfa  = #clientes@#53;  |HAZ QuitaRaros;       #dsmow541#29 = eaAlfa;
         eaAlfa  = #clientes@#55;  |QBF eaAlfa;
         |SI eaAlfa ! "";
             eaAlfa  = #clientes@#55; |HAZ QuitaRarosTfno; #dsmow541#30 = eaAlfa;
         |SINO;
             #dsmow541#30 = #dsmow541#16;
         |FINSI;

         eaDeleg = #clientes@#17;
         eaAdmin = #clientes@#18;
     |SINO;
         aAlfa = #clientes@#96; |QBF aAlfa; |SI aAlfa = ""; #clientes@#96 = #clientes@#1; |FINSI;
         #dsmow541#5   = (("00" + #clientes@#63) % -102) + (("000" + #clientes@#64) % -103);
         eaVarDni = #clientes@#13;  |HAZ CalculameDNI;   #dsmow541#6   = eaVarDni;
         eaAlfa   = #clientes@#1;  |HAZ QuitaRaros;      #dsmow541#8   = eaAlfa;
         #dsmow541#9   = ".";
         #dsmow541#10  = #clientes@#3;
         eaAlfa   = #clientes@#4;  |HAZ QuitaRaros;      #dsmow541#11  = eaAlfa;
         #dsmow541#12 = #clientes@#5 % 104;
         #dsmow541#13 = #clientes@#6;
         #dsmow541#14 = #clientes@#7;
         #dsmow541#15 = #clientes@#8;
         eaAlfa  = #clientes@#14;  |HAZ QuitaRarosTfno; #dsmow541#16 = eaAlfa;
         eaAlfa  = #clientes@#11;  |HAZ QuitaRaros;     #dsmow541#17 = eaAlfa;
         eaAlfa  = #clientes@#12;  |HAZ QuitaRaros;     #dsmow541#18 = eaAlfa;
         #dsmow541#19 = (("00" + #clientes@#9) % -102) + (("000" + #clientes@#10) % -103);
         eaAlfa  = #clientes@#96;  |HAZ QuitaRaros;     #dsmow541#29 = eaAlfa;
         eaAlfa  = #clientes@#61;  |QBF eaAlfa;
         |SI eaAlfa ! "";
             eaAlfa  = #clientes@#61; |HAZ QuitaRarosTfno; #dsmow541#30 = eaAlfa;
         |SINO;
             #dsmow541#30 = #dsmow541#16;
         |FINSI;
         eaDeleg = #clientes@#91;
         eaAdmin = #clientes@#92;
     |FINSI;

     #dsmow541#20  = #115#1;

     |SI aPeriodo = "T";
         |SI #115#2 = 3;   #dsmow541#21 = "1T";  |FINSI;
         |SI #115#2 = 6;   #dsmow541#21 = "2T";  |FINSI;
         |SI #115#2 = 9;   #dsmow541#21 = "3T";  |FINSI;
         |SI #115#2 = 12;  #dsmow541#21 = "4T";  |FINSI;
     |SINO;
         #dsmow541#21 = ("00" + #115#2) % -102;
     |FINSI;

     #dsmow541#22 = ("000000" + #115#6) % -106;
     enNume  = #115#7;  |HAZ Conver13;  #dsmow541#23 = eaAlfa;
     enNume  = #115#8;  |HAZ Conver13;  #dsmow541#24 = eaAlfa;
     enNume  = #115#9;  |HAZ Conver13;  #dsmow541#25 = eaAlfa;
     enNume  = #115#10;
     |SI enNume < 0;  enNume = 0;  |FINSI;
                        |HAZ Conver13;  #dsmow541#26 = eaAlfa;

     |HAZ TDeclaracion115;

     |SI #115#4 > 0;
         #dsmow541#27 = #4#20;
         #dsmow541#28 = #4#21;
     |FINSI;

     eaAlfa  = #0#7;  |HAZ FechaBonito;
     #dsmow541#42 = eaDiaB;
     #dsmow541#43 = eaMesB;
     #dsmow541#44 = eaAnyoB;
     #dsmow541#45 = &13 + &10;

     |SI nTecla = 1;
         #dsmow541#4  = "";
         #dsmow541#7  = "";
         #dsmow541#27 = "";
         #dsmow541#29 = "";
         #dsmow541#30 = "";
         #dsmow541#31 = "";
         nTCampo = 45;
     |FINSI;

     |SI nTecla = 3;
         #dsmow541#2  = "";
         #dsmow541#3  = "";
         #dsmow541#5  = "";
         #dsmow541#8  = "";
         #dsmow541#9  = "";
         #dsmow541#10 = "";
         #dsmow541#11 = "";
         #dsmow541#12 = "";
         #dsmow541#13 = "";
         #dsmow541#14 = "";
         #dsmow541#15 = "";
         #dsmow541#16 = "";
         #dsmow541#17 = "";
         #dsmow541#18 = "";
         #dsmow541#19 = "";
         #dsmow541#42 = "";
         #dsmow541#43 = "";
         #dsmow541#44 = "";
         #dsmow541#45 = "";
         nTCampo = 44;
     |FINSI;

     aAlfa = "";
     |PARA nCampo = 1;  |SI nCampo [ nTCampo;  |HACIENDO nCampo = nCampo + 1;
           aAlfa = #dsmow541#nCampo#;
           |XGRABA nHandle2, aAlfa;
     |SIGUE;
|FPRC;

|PROCESO dsmow014M115_2013;
     |ABRE #4;
     #4#0  = #999#0;
     #4#1  = #999#1;
     #4#2  = #999#2;
     #4#3  = #999#5;
     #4#4  = #999#7;
     |LEE 040#4=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;
     |CIERRA #4;

     |ABRE #115;
     #115#0 = #4#0;
     #115#1 = #4#1;
     #115#2 = #4#2;
     #115#3 = #4#3;
     #115#4 = #4#4;
     #115#5 = 0;
     |LEE 040#115=;
     |SI FSalida ! 0;  |CIERRA #115;  |ACABA;  |FINSI;
     |CIERRA #115;

     aPeriodo = "T";
     |BUCLE dsmom002;

     eaFicheroPlano = "115" + (("00000" + #999#0) % -105) + ".txt";
     eaFicheroImpre = "115" + (("00000" + #999#0) % -105) + ".pdf";
     eaFicheroError = "err" + (("00000" + #999#0) % -105) + ".txt";

     aAlfa = eaPathLanza + eaFicheroPlano;  |RFBORRA aAlfa;
     aAlfa = eaPathLanza + eaFicheroImpre;  |RFBORRA aAlfa;
     aAlfa = eaPathLanza + eaFicheroError;  |RFBORRA aAlfa;

     aAbre = eaPathEmision + eaFicheroPlano;
     |XABRE "BW", aAbre, nHandle2;

     |HAZ Carga115_2013;

     |XCIERRA nHandle2;

     enEmpresa    = #999#0;
     eaNomEmpresa = #999#3;

     |SI enTecla = 3;
         eaFOrigen  = eaPathEmision  + eaFicheroPlano;
         eaFDestino = eaPathInternet + eaFicheroPlano;
         |HAZ CopiaFichero;

         |HAZ GrabaImpreso;
         |ACABA;
     |FINSI;

     |HAZ PresentaMPF;
|FPRC;

|DEFBUCLE dsmow014C115_2013;
     #999#1;
     6;
     00000, 0000, 00, "S";
     99999, 9999, 99, "S";
     ;
     NULL, dsmow014M115_2013;
|FIN;

|DEFBUCLE dsmow014N115_2013;
     #999#2;
     6;
     "                                        ", "S";
     "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz", "S";
     ;
     NULL, dsmow014M115_2013;
|FIN;

|PROCESO Bloque2013;
     |HAZ BotonesMPF;
     nTecla = enTecla;

     |SI nTecla = 0;  |ACABA;  |FINSI;

     nSwLee = 0;
     |SI #0#8 = "C";
         |BUCLE dsmow014C115_2013;
     |SINO;
         |BUCLE dsmow014N115_2013;
     |FINSI;

     |HAZ SacaErrorPtl;

     |SI eaOpcion = "3";
         |SI enPresentar = 0;
             aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
             |MENAV aAlfa;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO moy11501;
     |ABRE #107;
     |LEE 040#107p;
     |SI FSalida ! 0;
         |CIERRA #107;
         |SUB_EJECUTA_NP "dsmom107";
         |ABRE #107;
     |FINSI;

     |LEE 040#107p;
     |SI FSalida ! 0;  |DDEFECTO #107;  |FINSI;
     |CIERRA #107;

     |ABRE #0;
     |LEE 000#0p;
     |CIERRA #0;

     aAlfa1 = #0#6;
     aAlfa1 = "01.01." + aAlfa1; fFecIni = aAlfa1;
     aAlfa1 = #0#6;
     aAlfa1 = "31.12." + aAlfa1; fFecFin = aAlfa1;

     enCambiaMoneda = 1;
     enSwTrata      = 0;

     |SI #0#6 [ 2012; |O eaParametro = "115C";
         |HAZ Bloque2012;
         |ACABA;
     |FINSI;

     |SI #0#6 [ 2014;
         |HAZ Bloque2013;
         |ACABA;
     |FINSI;
|FPRC;
