|FICHEROS;
     dsmoy065 #0;

     dsmow630 #10;  || Temporal recogida de datos
     dsmod110 #11;  || Mantenimiento impresion modelo 110
     dsmom026;      || grupos de empresas

     :/laboral/def/nomhicca  #200;
     :/laboral/def/nomhiatr  #201;
     :/laboral/def/labempre  #202;

     :/integral/def/dsam0000 #300;
|FIN;

|VARIABLES;
   nDEmpresa = 0;
   nHEmpresa = 0;

   nDModelo  = 0;
   nHModelo  = 0;
   nDPeriodo = 0;
   nHPeriodo = 0;
   nDAnyo = 0;
   nHAnyo = 0;

   nCalc = 0;
   nAnyo = 0;

   aAlfa = "";
     nTrimestre = 0;
     swSigue = 0;
     nAnt00 = 0;
     nAnt01 = 0;
     nAnt02 = 0;
     nAnt03 = 0;
     nAnt04 = 0;
     nAnt05 = 0;
     nAnt07 = 0;
     nAnt08 = 0;
     nAnt10 = 0;
     nAnt11 = 0;
     nMadre = 0;
     &eaTitulo = "";
|FIN;

|PROCESO Seleccion;
   |SI #dsmoy065#0 = "S";
      |C_M #dsmoy065#1, 1, "N"; |C_M #dsmoy065#2, 1, "N";
      |PARA nCalc = 3; |SI nCalc [ 22; |HACIENDO nCalc = nCalc + 1;
         |C_M #dsmoy065#nCalc#, 1, "S";
      |SIGUE;
   |SINO;
      |C_M #dsmoy065#1, 1, "S"; |C_M #dsmoy065#2, 1, "S";
      |PARA nCalc = 3; |SI nCalc [ 22; |HACIENDO nCalc = nCalc + 1;
         |C_M #dsmoy065#nCalc#, 1, "N";
      |SIGUE;
   |FINSI;
|FPRC;

|PROCESO BuscaGrupo;
     |SI #nomhicca#0 ! #dsmom026#0;
          nMadre = #dsmom026#0;    || la empresa pertenece a un grupo y ella no es
                                   || la madre, no tiene que salir, se siente
     |FINSI;
|FPRC;

|DEFBUCLE BuscaGrupo;
     #dsmom026#2;
     ;
     #nomhicca#0, 00001;
     #nomhicca#0, 99999;
     ;
     NULL, BuscaGrupo;
|FIN;

|PROCESO Historico;
     nMadre = 0;
     |BUCLE BuscaGrupo;

     nAnyo = #nomhicca#66 + 2000;

     |SI #nomhicca#3 ] 5;
          |DDEFECTO #nomhiatr;
          #nomhiatr#0 = #nomhicca#0;
          |LEE 000#nomhiatr.];
          |PARA; |SI FSalida = 0; |Y #nomhiatr#0 = #nomhicca#0; |HACIENDO;
               |SI #nomhiatr#2 = #nomhicca#3;
               ||Y #nomhiatr#3 = #nomhicca#66;
               |Y #nomhiatr#3 = nAnyo;
                    nAnyo = #nomhiatr#1; |SAL;
               |FINSI;
               |LEE 000#nomhiatr.s;
          |SIGUE;
     |FINSI;

     |SI #nomhicca#3 ] 5;
          swSigue = 0;

          |SI #nomhiatr#4 = 0;  #nomhiatr#4 = #nomhicca#2; |FINSI;

          |SI #nomhiatr#4 ] 1;  |Y #nomhiatr#4 [ 3;  nTrimestre = 1; |FINSI;
          |SI #nomhiatr#4 ] 4;  |Y #nomhiatr#4 [ 6;  nTrimestre = 2; |FINSI;
          |SI #nomhiatr#4 ] 7;  |Y #nomhiatr#4 [ 9;  nTrimestre = 3; |FINSI;
          |SI #nomhiatr#4 ] 10; |Y #nomhiatr#4 [ 12; nTrimestre = 4; |FINSI;

          |SI #dsmoy065#23 [ nTrimestre; |Y nTrimestre [ #dsmoy065#24;
               swSigue = 1;
          |FINSI;

          |SI swSigue = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     |DDEFECTO #dsmow630;
     |SI nMadre ! 0;
          #dsmow630#0 = nMadre;
     |SINO;
          #dsmow630#0 = #nomhicca#0;
     |FINSI;

     |SI #nomhicca#3 ] 5;
          #dsmow630#1 = nTrimestre;
     |SINO;
          |SI #nomhicca#2 ] 1;  |Y #nomhicca#2 [ 3;  #dsmow630#1 = 1; |FINSI;
          |SI #nomhicca#2 ] 4;  |Y #nomhicca#2 [ 6;  #dsmow630#1 = 2; |FINSI;
          |SI #nomhicca#2 ] 7;  |Y #nomhicca#2 [ 9;  #dsmow630#1 = 3; |FINSI;
          |SI #nomhicca#2 ] 10; |Y #nomhicca#2 [ 12; #dsmow630#1 = 4; |FINSI;
     |FINSI;

   #dsmow630#2 = nAnyo;
   |LEE 000#dsmow630.=;
   |SI FSalida ! 0;
      #labempre#0 = #nomhicca#0;
      |LEE 000#labempre.=;
      |SI FSalida ! 0; |DDEFECTO #labempre; |FINSI;

      |DDEFECTO #dsmow630;
     |SI nMadre ! 0;
          #dsmow630#0 = nMadre;
     |SINO;
          #dsmow630#0 = #nomhicca#0;
     |FINSI;
     |SI #nomhicca#3 ] 5;
          #dsmow630#1 = nTrimestre;
     |SINO;
          |SI #nomhicca#2 ] 1;  |Y #nomhicca#2 [ 3;  #dsmow630#1 = 1; |FINSI;
          |SI #nomhicca#2 ] 4;  |Y #nomhicca#2 [ 6;  #dsmow630#1 = 2; |FINSI;
          |SI #nomhicca#2 ] 7;  |Y #nomhicca#2 [ 9;  #dsmow630#1 = 3; |FINSI;
          |SI #nomhicca#2 ] 10; |Y #nomhicca#2 [ 12; #dsmow630#1 = 4; |FINSI;
     |FINSI;

      #dsmow630#2 = nAnyo;
      #dsmow630#19 = #labempre#2;
      |GRABA 020#dsmow630.c;
   |FINSI;

   #dsmow630#3  = #dsmow630#3  + #nomhicca#14;
   #dsmow630#4  = #dsmow630#4  + #nomhicca#15;
   #dsmow630#5  = #dsmow630#5  + #nomhicca#108;
   #dsmow630#6  = #dsmow630#6  + #nomhicca#110;
   #dsmow630#7  = #dsmow630#7  + #nomhicca#109;
   #dsmow630#8  = #dsmow630#8  + #nomhicca#111;
   #dsmow630#9  = #dsmow630#9  + #nomhicca#16;
   #dsmow630#10 = #dsmow630#10 + #nomhicca#17;

   #dsmow630#15 = (#dsmow630#3 + #dsmow630#9) - #dsmow630#11;
   #dsmow630#16 = (#dsmow630#4 + #dsmow630#10) - #dsmow630#12;
   #dsmow630#17 = (#dsmow630#5 + #dsmow630#7) - #dsmow630#13;
   #dsmow630#18 = (#dsmow630#6 + #dsmow630#8) - #dsmow630#14;
   |GRABA 020#dsmow630.a;
|FPRC;

|DEFBUCLE Historico;
#nomhicca#1;
;
nDEmpresa, 00001, nDAnyo, nDPeriodo, 0;
nHEmpresa, 99999, nHAnyo, nHPeriodo, 2;
;
NULL, Historico;
|FIN;

|DEFBUCLE Atrasos_Historico;
#nomhicca#1;
;
nDEmpresa, 00001, nDAnyo, 01, 5;
nHEmpresa, 99999, nHAnyo, 12, 20;
;
NULL, Historico;
|FIN;

|PROCESO BorraComp;
     |SI nAnt00 = #dsmod110#0;
     |Y nAnt01 = #dsmod110#1;
     |Y nAnt02 = #dsmod110#2;
     |Y nAnt03 = #dsmod110#3;
     |Y nAnt05 = #dsmod110#5;
          #dsmow630#11 = #dsmow630#11 - nAnt07;
          #dsmow630#12 = #dsmow630#12 - nAnt08;
          #dsmow630#13 = #dsmow630#13 - nAnt10;
          #dsmow630#14 = #dsmow630#14 - nAnt11;

          #dsmow630#15 = (#dsmow630#3 + #dsmow630#9) + #dsmow630#11;
          #dsmow630#16 = (#dsmow630#4 + #dsmow630#10) + #dsmow630#12;
          #dsmow630#17 = (#dsmow630#5 + #dsmow630#7) + #dsmow630#13;
          #dsmow630#18 = (#dsmow630#6 + #dsmow630#8) + #dsmow630#14;
     |FINSI;
|FPRC;

|PROCESO Modelo110;
   #dsmow630#0 = #dsmod110#0;
   |SI #dsmod110#2 ] 1;  |Y #dsmod110#2 [ 3;  #dsmow630#1 = 1; |FINSI;
   |SI #dsmod110#2 ] 4;  |Y #dsmod110#2 [ 6;  #dsmow630#1 = 2; |FINSI;
   |SI #dsmod110#2 ] 7;  |Y #dsmod110#2 [ 9;  #dsmow630#1 = 3; |FINSI;
   |SI #dsmod110#2 ] 10; |Y #dsmod110#2 [ 12; #dsmow630#1 = 4; |FINSI;
   #dsmow630#2 = #dsmod110#1;
   |LEE 000#dsmow630.=;
   |SI FSalida ! 0;
      #dsam0000#0 = #dsmod110#0;
      |LEE 000#dsam0000.=;
      |SI FSalida ! 0; |DDEFECTO #dsam0000; |FINSI;

      |DDEFECTO #dsmow630;
      #dsmow630#0 = #dsmod110#0;
      |SI #dsmod110#2 ] 1;  |Y #dsmod110#2 [ 3;  #dsmow630#1 = 1; |FINSI;
      |SI #dsmod110#2 ] 4;  |Y #dsmod110#2 [ 6;  #dsmow630#1 = 2; |FINSI;
      |SI #dsmod110#2 ] 7;  |Y #dsmod110#2 [ 9;  #dsmow630#1 = 3; |FINSI;
      |SI #dsmod110#2 ] 10; |Y #dsmod110#2 [ 12; #dsmow630#1 = 4; |FINSI;
      #dsmow630#2 = #dsmod110#1;
      #dsmow630#19 = #dsam0000#1;
      |GRABA 020#dsmow630.c;
   |FINSI;

     |HAZ BorraComp;

     nAnt00 = #dsmod110#0;
     nAnt01 = #dsmod110#1;
     nAnt02 = #dsmod110#2;
     nAnt03 = #dsmod110#3;
     nAnt04 = #dsmod110#4;
     nAnt05 = #dsmod110#5;

     nAnt07 = #dsmod110#7;
     nAnt08 = #dsmod110#8;
     nAnt10 = #dsmod110#10;
     nAnt11 = #dsmod110#11;

     #dsmow630#11 = #dsmow630#11 + #dsmod110#7;
     #dsmow630#12 = #dsmow630#12 + #dsmod110#8;
     #dsmow630#13 = #dsmow630#13 + #dsmod110#10;
     #dsmow630#14 = #dsmow630#14 + #dsmod110#11;

     #dsmow630#15 = (#dsmow630#3 + #dsmow630#9) - #dsmow630#11;
     #dsmow630#16 = (#dsmow630#4 + #dsmow630#10) - #dsmow630#12;
     #dsmow630#17 = (#dsmow630#5 + #dsmow630#7) - #dsmow630#13;
     #dsmow630#18 = (#dsmow630#6 + #dsmow630#8) - #dsmow630#14;

     |GRABA 020#dsmow630.a;
|FPRC;

|DEFBUCLE Modelo110;
#dsmod110#1;
;
nDEmpresa, #dsmoy065#25, nDPeriodo, 110, 00, 00;
nHEmpresa, #dsmoy065#26, nHPeriodo, 110, 99, 99;
;
NULL, Modelo110;
|FIN;

|RUTINA inf;
   #dsmow630#0 = 00000;
   #dsmow630#1 = 01;
   #dsmow630#2 = 1900;
|FRUT;

|RUTINA sup;
   #dsmow630#0 = 99999;
   #dsmow630#1 = 12;
   #dsmow630#2 = 2999;
|FRUT;

|PROCESO Imprime;
   |SI #dsmoy065#27 = "T";
      |PRINT;
   |SINO;
      |SI #dsmow630#15 ! 0; |O #dsmow630#16 ! 0;
       |O #dsmow630#17 ! 0; |O #dsmow630#18 ! 0;
         |PRINT;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Imprime;
#dsmow630#1;
;
INICIO;
FINAL;
;
NULL, Imprime;
|FIN;

|PROGRAMA;
   |CLS;
   |CABEZA "Informe comprobacion historico nominas modelo 110/111";
   |PINPA #0#0; |PINDA #0#0;

   aAlfa = "tmp" + Usuario; |NOME_DAT #dsmow630#aAlfa#;
   |DELINDEX #dsmow630; |ABRE #dsmow630;

   |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "laboral/fich/";
   |PATH_DAT #nomhiatr#aAlfa#; |PATH_DAT #nomhicca#aAlfa#;
   |PATH_DAT #labempre#aAlfa#;
   |ABRE #nomhiatr; |ABRE #labempre;

   |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "integral/fich/";
   |PATH_DAT #dsam0000#aAlfa#;
   |ABRE #dsam0000;

   |ENDATOS #1#0;
   |SI FSalida = 0;
      |SI #dsmoy065#23 = 1; nDPeriodo = 1;  |FINSI;
      |SI #dsmoy065#23 = 2; nDPeriodo = 4;  |FINSI;
      |SI #dsmoy065#23 = 3; nDPeriodo = 7;  |FINSI;
      |SI #dsmoy065#23 = 4; nDPeriodo = 10; |FINSI;
      |SI #dsmoy065#24 = 1; nHPeriodo = 3;  |FINSI;
      |SI #dsmoy065#24 = 2; nHPeriodo = 6;  |FINSI;
      |SI #dsmoy065#24 = 3; nHPeriodo = 9;  |FINSI;
      |SI #dsmoy065#24 = 4; nHPeriodo = 12; |FINSI;
      aAlfa = #dsmoy065#25; |QBF aAlfa;
      aAlfa = aAlfa % -102;
      nDAnyo = aAlfa;
      aAlfa = #dsmoy065#26; |QBF aAlfa;
      aAlfa = aAlfa % -102;
      nHAnyo = aAlfa;

      eaTitulo = "Informe Comprobacion Historico de Nominas y Modelo 110/111";
      nDModelo = 111; nHModelo = 111;
      |SI #0#25 < 2011; nDModelo = 110; |FINSI;
      |SI #0#26 < 2011; nHModelo = 110; |FINSI;
      |SI nDModelo = nHModelo;
          |SI nDModelo = 111; eaTitulo = "Informe Comprobacion Historico de Nominas y Modelo 111"; |FINSI;
          |SI nDModelo = 110; eaTitulo = "Informe Comprobacion Historico de Nominas y Modelo 110"; |FINSI;
      |FINSI;

      |SI #dsmoy065#0 = "N";
         nDEmpresa = #dsmoy065#1; nHEmpresa = #dsmoy065#2;
         |BUCLE Modelo110;
         |BUCLE Historico;
         |BUCLE Atrasos_Historico;
      |SINO;
         |PARA nCalc = 3; |SI nCalc [ 22; |HACIENDO nCalc = nCalc + 1;
            nDEmpresa = #dsmoy065#nCalc#; nHEmpresa = #dsmoy065#nCalc#;
            |BUCLE Modelo110;
            |BUCLE Historico;
            |BUCLE Atrasos_Historico;
         |SIGUE;
      |FINSI;
      |LEE 000#dsmow630.p;
      |SI FSalida = 0;
         Impresora = "CrystalReport";
         |IMPRE -1;
         |SI FSalida = 0;
            |INFOR "dsmoy065";
            |SI FSalida = 0;
               |BUCLE Imprime;
               |PIEINF; |FININF;
            |FINSI;
            |FINIMP;
         |FINSI;
      |SINO;
         |MENAV "    Seleccion vacia";
      |FINSI;
   |FINSI;

   |CIERRA #dsam0000;
   |CIERRA #nomhiatr; |CIERRA #labempre;
   |CIERRA #dsmow630; |DELINDEX #dsmow630;
|FPRO;
