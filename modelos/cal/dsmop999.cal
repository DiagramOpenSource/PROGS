|FICHEROS;
     dsmozpas;

     dsmom002;
     dsmom003;
     dsmom004;
     dsmom005;
     dsmom006;
     dsmom107;
     dsmom111;

     dsmow013;
     dsmow151;

     :/basica/def/agitab99;
     :/contagen/def/canempre;
     :/contagen/def/camaasil;
     :/contagen/def/cacuenta;
|FIN;

|VARIABLES;
     nPrimero       = 0;
     nNuevo         = 0;
     nFalta         = 0;
     nExiste        = 0;
     nSim006        = 0;
     nSaldo         = 0;
     nActividad     = 0;
     nModelo        = 0;
     nDepar         = 0;
     nSumaCtas      = 0;
     nSw            = 0;

     aAlfa          = "";
     aAlfa1         = "";
     aFichero       = "";
     aCuenta        = "";
     aDCuenta       = "";
     aHCuenta       = "";

     fFecha1        = @;
     fFecha2        = @;

     &enEmpresaA    = 0;
     &enAnyo        = 0;
     &swerror       = 0;
     &efFechaIni    = @;
     &efFechaFin    = @;
     &eaTex1        = "";
     &eaTex2        = "";
|FIN;

|INCLUYE i_variar;

|PROCESO VerCheqPase;
     enSwCheqPase = 0;

     |ABRE #dsmom107;
     |DDEFECTO #dsmom107;
     |LEE 041#dsmom107.=;
     |CIERRA #dsmom107;
     |SI #dsmom107#31 ! "S"; |ACABA; |FINSI;

     nModelo = enModelo;
     |SI enModelo = 370; nModelo = enModelo1; |FINSI;

     |ABRE #dsmom111;
     #dsmom111#0 = nModelo;
     #dsmom111#1 = 001;
     |LEE 041#dsmom111.];
     |SI FSalida = 0; |Y #dsmom111#0 = nModelo;
         enSwCheqPase = 1;
     |FINSI;
     |CIERRA #dsmom111;

     |SI enModelo = 310; |O enModelo = 370;
         |SI enPeriodo ! 12; enSwCheqPase = 0; |FINSI;
     |FINSI;

     |SI enSwCheqPase = 1;
         enFichW151 = 0;
         aFichero   = ("qp" + Usuario) % 108;
         |NOME_DAT #dsmow151#aFichero#;
         |DELINDEX #dsmow151;
     |FINSI;

     aAlfa      = #dsmozpas#3;
     aAlfa      = "01.01." + aAlfa;
     efFechaIni = aAlfa;

     aAlfa      = #dsmozpas#3;
     |SI #dsmozpas#1 = 1;  aAlfa1 = "31.01."; |FINSI;
     |SI #dsmozpas#1 = 2;
         aAlfa1 = "28.02.";
         |SI #dsmozpas#3 = 2008; |O #dsmozpas#3 = 2012; |O #dsmozpas#3 = 2016;
            |O #dsmozpas#3 = 2020; |O #dsmozpas#3 = 2024; |O #dsmozpas#3 = 2028;
               aAlfa1 = "29.02.";
         |FINSI;
     |FINSI;
     |SI #dsmozpas#1 = 3;  aAlfa1 = "31.03."; |FINSI;
     |SI #dsmozpas#1 = 4;  aAlfa1 = "30.04."; |FINSI;
     |SI #dsmozpas#1 = 5;  aAlfa1 = "31.05."; |FINSI;
     |SI #dsmozpas#1 = 6;  aAlfa1 = "30.06."; |FINSI;
     |SI #dsmozpas#1 = 7;  aAlfa1 = "31.07."; |FINSI;
     |SI #dsmozpas#1 = 8;  aAlfa1 = "31.08."; |FINSI;
     |SI #dsmozpas#1 = 9;  aAlfa1 = "30.09."; |FINSI;
     |SI #dsmozpas#1 = 10; aAlfa1 = "31.10."; |FINSI;
     |SI #dsmozpas#1 = 11; aAlfa1 = "30.11."; |FINSI;
     |SI #dsmozpas#1 = 12; aAlfa1 = "31.12."; |FINSI;
     aAlfa = aAlfa1 + aAlfa;
     efFechaFin = aAlfa;
|FPRC;

|| ----------------------------------------------------------------------
|PROCESO CalCuentas;
    nSaldo = #cacuenta#11;
    |SI enPeriodo ] 1;  nSaldo = nSaldo + #cacuenta#14; |FINSI;
    |SI enPeriodo ] 2;  nSaldo = nSaldo + #cacuenta#17; |FINSI;
    |SI enPeriodo ] 3;  nSaldo = nSaldo + #cacuenta#20; |FINSI;
    |SI enPeriodo ] 4;  nSaldo = nSaldo + #cacuenta#23; |FINSI;
    |SI enPeriodo ] 5;  nSaldo = nSaldo + #cacuenta#26; |FINSI;
    |SI enPeriodo ] 6;  nSaldo = nSaldo + #cacuenta#29; |FINSI;
    |SI enPeriodo ] 7;  nSaldo = nSaldo + #cacuenta#32; |FINSI;
    |SI enPeriodo ] 8;  nSaldo = nSaldo + #cacuenta#35; |FINSI;
    |SI enPeriodo ] 9;  nSaldo = nSaldo + #cacuenta#38; |FINSI;
    |SI enPeriodo ] 10; nSaldo = nSaldo + #cacuenta#41; |FINSI;
    |SI enPeriodo ] 11; nSaldo = nSaldo + #cacuenta#44; |FINSI;
    |SI enPeriodo ] 12; nSaldo = nSaldo + #cacuenta#47; |FINSI;

    nSumaCtas = nSumaCtas + ((nSaldo / enConversor) ! EURODBMOD);
|FPRC;

|DEFBUCLE LeeCuentas;
    #cacuenta#1;
    3;
    aDCuenta, "S";
    aHCuenta, "S";
    e;
    NULL, CalCuentas;
|FIN;

|PROCESO CalCtas;
    nDepar = #camaasil#21;
    |SI nDepar = 0;  nDepar = 1;   |FINSI;
    |SI nDepar ! nActividad; |Y nActividad ! 0; |ACABA; |FINSI;

    |SI #camaasil#8 = "D";
        nSumaCtas = nSumaCtas + ((#camaasil#9 / enConversor) ! EURODBMOD);
    |SINO;
        nSumaCtas = nSumaCtas - ((#camaasil#9 / enConversor) ! EURODBMOD);
    |FINSI;
|FPRC;

|DEFBUCLE LeeApuntes;
    #camaasil#3;
    0;
    aDCuenta, efFechaIni, 000001, 0001, 00;
    aHCuenta, efFechaFin, 999999, 9999, 98;
    e;
    NULL, CalCtas;
|FIN;

|PROCESO LeoDsmom111;

|| .... Primera Columna
   aCuenta   = #dsmom111#2;
   aDCuenta  = aCuenta;
   aHCuenta  = aCuenta;

   aAlfa     = #dsmom111#2; |QBF aAlfa;
   |SI aAlfa ! "";
       aAlfa1    = aAlfa % -101;
       |SI aAlfa1 = "*";
           aCuenta   = aAlfa - "*";
           aDCuenta = (aCuenta + "            ") % 112;
           aHCuenta = (aCuenta + "zzzzzzzzzzzz") % 112;
       |FINSI;

       nSumaCtas = 0;
       |SI nActividad ! 0; |BUCLE LeeApuntes; |FINSI;
       |SI nActividad = 0; |BUCLE LeeCuentas; |FINSI;

       |SI #dsmom111#4 = "-";
            enSaldo1Ch = enSaldo1Ch - nSumaCtas;
       |SINO;
            enSaldo1Ch = enSaldo1Ch + nSumaCtas;
       |FINSI;
       nSw = 1;  || existen movimientos
  |FINSI;

|| .... Segunda Columna
   aCuenta   = #dsmom111#5;
   aDCuenta  = aCuenta;
   aHCuenta  = aCuenta;

   aAlfa     = #dsmom111#5; |QBF aAlfa;
   |SI aAlfa ! "";

       aAlfa1    = aAlfa % -101;
       |SI aAlfa1 = "*";
           aCuenta   = aAlfa - "*";
           aDCuenta = (aCuenta + "            ") % 112;
           aHCuenta = (aCuenta + "zzzzzzzzzzzz") % 112;
       |FINSI;

       nSumaCtas = 0;
       |SI nActividad ! 0; |BUCLE LeeApuntes; |FINSI;
       |SI nActividad = 0; |BUCLE LeeCuentas; |FINSI;

       |SI #dsmom111#7 = "-";
           enSaldo2Ch = enSaldo2Ch - nSumaCtas;
       |SINO;
           enSaldo2Ch = enSaldo2Ch + nSumaCtas;
       |FINSI;
       nSw = 1;  || existen movimientos
  |FINSI;
|FPRC;

|DEFBUCLE LeoDsmom111;
    #dsmom111#1;
    ;
    nModelo,01;
    nModelo,99;
    e;
    NULL, LeoDsmom111;
|FIN;

|PROCESO BuscarSaldos;
      enSwOpPar = 0;
      |HAZ SituaEmpresa;
      |SI swerror = 1; |ACABA; |FINSI;
      |SI enSwPartido = 0;
          enPerConta = #canempre#3;
          eaLaMonEmp = #canempre#28;
      |SINO;
          enPerConta = enPeriodoPar;
          eaLaMonEmp = "E";
      |FINSI;
      |HAZ EnConversor;

      nModelo = enModelo;
      |SI enModelo = 370; nModelo = enModelo1; |FINSI;

      nActividad    = enActividad;
      |SI enModelo = 111; |O enModelo = 110;
          |O enModelo = 115; |O enModelo = 123; |O enModelo = 216;
          nActividad = 0;
      |FINSI;

      |PATH_DAT #camaasil#aPathConta#;
      |PATH_DAT #cacuenta#aPathConta#;

      enOperaCh  = 2; ||grabar saldo de cuentas
      nSw        = 0;
      enSaldo1Ch = 0;
      enSaldo2Ch = 0;
      |BUCLE LeoDsmom111;
      |SI nSw = 1;
          |HAZ GrabaAux151;
      |FINSI;

      |SI enSwPartido = 1;
          enSwOpPar   = 2;
          |HAZ FinalPartido;
      |FINSI;
|FPRC;

|PROCESO GrabaAux151;
      |ABRE #dsmow151;
      #dsmow151#0 = enEmpresa;
      #dsmow151#1 = enEjer;
      #dsmow151#2 = enPeriodo;
      #dsmow151#3 = enModelo;
      #dsmow151#4 = enComplem;
      #dsmow151#5 = enActividad;
      |LEE 141#dsmow151.=;
      |SI FSalida ! 0;
          |DDEFECTO #dsmow151;
          #dsmow151#0 = enEmpresa;
          #dsmow151#1 = enEjer;
          #dsmow151#2 = enPeriodo;
          #dsmow151#3 = enModelo;
          #dsmow151#4 = enComplem;
          #dsmow151#5 = enActividad;
          #dsmow151#6 = eaNombreAct;
          #dsmow151#7 = eaNombreEmp;
          #dsmow151#8 = eaNomPer;

          |SI enModelo = 300; |O enModelo = 303; |O enModelo = 370; |O enModelo = 371;
              #dsmow151#9 = 2;
          |FINSI;
          |SI enModelo = 370; |Y enModelo1 = 310;
              #dsmow151#9 = 1;
          |FINSI;
          |GRABA 020#dsmow151.b;
      |FINSI;

      |SI enOperaCh = 1;
          #dsmow151#10 = #dsmow151#10 + enSaldo1Ch;
          #dsmow151#11 = #dsmow151#11 + enSaldo2Ch;
          #dsmow151#14 = "X";
      |FINSI;
      |SI enOperaCh = 2;
          #dsmow151#12 = #dsmow151#12 + enSaldo1Ch;
          #dsmow151#13 = #dsmow151#13 + enSaldo2Ch;
          #dsmow151#15 = "X";
      |FINSI;

      |GRABA 020#dsmow151.a;
      |LIBERA #dsmow151;
      |CIERRA #dsmow151;
|FPRC;

|PROCESO SacaMenChequeo;
      nSw = 0;
      |SI #dsmow151#14 ! "X";
          nSw = 1;
          #dsmow151#16 = "NO EXISTE EL MODELO ";
      |SINO;
          |SI #dsmow151#15 ! "X";
              #dsmow151#16 = "NO EXISTEN DATOS CONTABLES";
              |SI #dsmow151#3 ! 110; |Y #dsmow151#3 ! 111; |Y #dsmow151#3 ! 216;
                  nSw = 2;
                  enFichW151 = 1;
                  #dsmow151#17 = "S";
              |FINSI;
          |SINO;
               |SI #dsmow151#10 ! #dsmow151#12;
                   nSw = 3;
                   #dsmow151#16 = "NO COINCIDEN: EL RESULTADO DEL MODELO Y EL SALDO CONTABLES";
                   |SI #dsmow151#9 = 2; #dsmow151#16 = "NO COINCIDEN: EL RESULTADO DEL MODELO Y LOS SALDOS CONTABLES"; |FINSI;
                   enFichW151 = 1;
                   #dsmow151#17 = "S";
               |FINSI;

               |SI #dsmow151#9 = 2;
                   |SI #dsmow151#11 ! #dsmow151#13;
                       nSw = 3;
                       #dsmow151#16 = "NO COINCIDEN: EL RESULTADO DEL MODELO Y LOS SALDOS CONTABLES";
                       enFichW151 = 1;
                       #dsmow151#17 = "S";
                   |FINSI;
               |FINSI;
          |FINSI;
      |FINSI;

      |SI nSw ! 0;
          |SI enMasivo = 0; |Y  nSw ] 2;
              |PUSHV 05012380;
              |BLIN 4;
              |PINPA #0#dsmow151;
              |SI #dsmow151#9 = 2;
                  |C_V #dsmow151#11,1,"S"; |C_V #dsmow151#13,1,"S";
                  |ATRI R; |PINTA 1327, "Cuota a Deducir";
                           |PINTA 1344, "Cuota Devengada"; |ATRI 0;
              |FINSI;
              |PINDA #0#dsmow151;
              |PAUSA;
              |POPV;
          |FINSI;
      |FINSI;
|FPRC;

|PROCESO VerChequeoDatos;
          |ABRE #dsmow151;
          |DDEFECTO #dsmow151;
          #dsmow151#0 = enEmpresa;
          #dsmow151#1 = enEjer;
          #dsmow151#2 = enPeriodo;
          #dsmow151#3 = enModelo;
          #dsmow151#4 = enComplem;
          #dsmow151#5 = enActividad;
          |LEE 141#dsmow151.=;
          |SI FSalida ! 0;
              |CIERRA #dsmow151;
              |ACABA;
          |FINSI;
          |HAZ SacaMenChequeo;
          |GRABA 020#dsmow151.a;
          |CIERRA #dsmow151;
|FPRC;

|PROCESO ImprimeChequeo;
   |PRINT;
   nSw = 1;
|FPRC;

|DEFBUCLE LeeDsmow151;
   #dsmow151#1;
   17;
   00001, enEjer, enPeriodo, enModelo, 00, 00,"S";
   99999, enEjer, enPeriodo, enModelo, 99, 99,"S";
   ;
   NULL, ImprimeChequeo;
|FIN;

|PROCESO eListaW151;
  |SI enFichW151 = 1;
      |CONFI "    SHay errores en el Chequeo de Saldos Contables. Imprimir relacion";
      |SI FSalida = 0;
          eaTex1 = "Total a Pagar"; eaTex2 = "";
          |SI enModelo = 300; |O enModelo = 303; |O enModelo = 370;
              eaTex1 = "Total Cuota a Deducir";
              eaTex2 = "Total Cuota Devengada";
          |FINSI;
          |SI enModelo = 310; |O enModelo1 = 310;
              eaTex1 = "Total Cuota a Deducir";
          |FINSI;

          aFichero = ("qp" + Usuario) % 108;
          |NOME_DAT #dsmow151#aFichero#;

          |IMPRE 0;
          |SI FSalida ! 0; |ACABA; |FINSI;

          |INFOR "dsmow151";
          |SI FSalida = 0;
              nSw    = 0;
              |BUCLE LeeDsmow151;
              |SI nSw = 1; |PIEINF; |FINSI;
              |FININF;
          |FINSI;

          |FINIMP;
      |FINSI;
   |FINSI;
   |DELINDEX #dsmow151;
|FPRC;

|PROCESO ChequeoAnual;
     |HAZ LeeCtrlLibro; |SI enSwAuAnual = 0; |ACABA; |FINSI;

     nPrimero = #dsmow013#10;
     |SI nPrimero = 300; |O nPrimero = 310; nNuevo = 390; |FINSI;
     |SI nPrimero = 110;  nNuevo = 190; |FINSI;
     |SI nPrimero = 115;  nNuevo = 180; |FINSI;
     |SI nPrimero = 123;  nNuevo = 193; |FINSI;
     |SI nPrimero = 216;  nNuevo = 296; |FINSI;

     nFalta = 0;
     |ABRE #dsmom002;
     |DDEFECTO #dsmom002;
     #dsmom002#0 = #dsmow013#0;
     #dsmom002#1 = #dsmow013#1;
     #dsmom002#2 = nNuevo;
     |LEE 001#dsmom002.=;
     |SI FSalida ! 0; nFalta = 1; |FINSI;
     |CIERRA #dsmom002;

     nExiste = 0;
     |ABRE #dsmom004;
     #dsmom004#0 = #dsmow013#0;
     #dsmom004#1 = #dsmow013#2;
     #dsmom004#2 = 99;
     #dsmom004#3 = nNuevo;
     #dsmom004#4 = 00;
     |LEE 040#dsmom004.=;
     |SI FSalida = 0;
         |LIBERA #dsmom004;
         |CIERRA #dsmom004;
         nExiste = 1;
         |SI nFalta = 0; |ACABA; |FINSI;       || si que existe sale
     |FINSI;

     |SI enMasivo = 1;
         aAlfa  = ("00000" + #dsmow013#0) % -105;
         aAlfa  = aAlfa + " " + eaNombreEmp; |QBF aAlfa;
         aAlfa1 = "    S"+ aAlfa + ". No configurado Planing " + nNuevo + ", Desea Configurarlo: ";
     |SINO;
         aAlfa1 = "    SNo configurado Planing del Modelo " + nNuevo + ", Desea Configurarlo : ";
     |FINSI;

     |SI nExiste = 0;
         |CONFI aAlfa1;
         |SI FSalida ! 0; |CIERRA #dsmom004; |ACABA; |FINSI;

         |DDEFECTO #dsmom004;
     |FINSI;

     nSim006 = 0;
     |ABRE #dsmom006;
     #dsmom006#0 = #dsmow013#0;
     #dsmom006#1 = nNuevo;
     |LEE 040#dsmom006.=;
     |SI FSalida = 0;
         nSim006 = 1;
         #dsmom004#5  = #dsmom006#9;
         #dsmom004#16 = #dsmom006#12;
     |SINO;
         |ABRE #dsmom005;
         #dsmom005#0 = nNuevo;
         |LEE 040#dsmom005.=;
         |SI FSalida ! 0;  |DDEFECTO #dsmom005;  |FINSI;
         #dsmom004#5  = #dsmom005#8;
         #dsmom004#16 = #dsmom005#11;
         |CIERRA #dsmom005;
     |FINSI;
     |CIERRA #dsmom006;

     |SI nExiste = 0;
         #dsmom004#0 = #dsmow013#0;
         #dsmom004#1 = #dsmow013#2;
         #dsmom004#2 = 99;
         #dsmom004#3 = nNuevo;
         #dsmom004#4 = 00;
         |GRABA 020#dsmom004.n;
         |LIBERA #dsmom004;
         |CIERRA #dsmom004;
     |FINSI;

     |ABRE #dsmom003;
     #dsmom003#0 = #dsmom004#0;
     #dsmom003#1 = #dsmom004#1;
     #dsmom003#2 = #dsmom004#2;
     |LEE 101#dsmom003.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmom003;
         #dsmom003#0 = #dsmom004#0;
         #dsmom003#1 = #dsmom004#1;
         #dsmom003#2 = #dsmom004#2;
         #dsmom003#3 = "ANUAL     ";
         |GRABA 020#dsmom003.n;
     |FINSI;
     |LIBERA #dsmom003;
     |CIERRA #dsmom003;

     |ABRE #dsmom002;
     |DDEFECTO #dsmom002;
     #dsmom002#0 = #dsmow013#0;
     #dsmom002#1 = #dsmow013#1;
     #dsmom002#2 = nPrimero;
     |LEE 000#dsmom002.=;
     fFecha1 = #dsmom002#8;
     fFecha2 = #dsmom002#9;

     #dsmom002#0 = #dsmow013#0;
     #dsmom002#1 = #dsmow013#1;
     #dsmom002#2 = nNuevo;
     |LEE 001#dsmom002.=;
     |SI FSalida ! 0;
         #dsmom002#0  = #dsmow013#0;
         #dsmom002#1  = #dsmow013#1;
         #dsmom002#2  = nNuevo;
         #dsmom002#10 = 1;
         |GRABA 020#dsmom002.b;
     |FINSI;
     |SI nSim006 = 1;
         #dsmom002#3 = #dsmom006#2;
         #dsmom002#4 = #dsmom006#3;
         #dsmom002#5 = #dsmom006#4;
     |SINO;
         #dsmom002#3 = #dsmom005#1;
         #dsmom002#4 = #dsmom005#2;
         #dsmom002#5 = #dsmom005#3;
     |FINSI;
     #dsmom002#7 = "ANUAL     ";
     #dsmom002#6 = eaNombreAct;
     #dsmom002#8 = fFecha1;
     #dsmom002#9 = fFecha2;
     |GRABA 020#dsmom002.a;
     |LIBERA #dsmom002;
     |CIERRA #dsmom002;

     enEmpresaA = #dsmow013#0;
     enAnyo     = #dsmow013#2;
     |SUB_EJECUTA "dsmoz001";
|FPRC;

|PROCESO eOrganizaMod111;
     |ABRE #agitab99;
     #agitab99#0 = 110;
     |LEE 040#agitab99.=;
     |SI FSalida ! 0;  |DDEFECTO #agitab99;  |FINSI;
     |CIERRA #agitab99;

     |ABRE #dsmom006;
     #dsmom006#0 = enEmpresa;
     #dsmom006#1 = 110;
     |LEE 041#dsmom006.=;
     |SI FSalida = 0;
         |SI #dsmom006#13 ! " "; |Y #dsmom006#13 ! "X";
             #agitab99#8 = #dsmom006#13;  ||Pase Modelo 110 particular de esta Empresa
         |FINSI;
     |FINSI;
     |CIERRA #dsmom006;
     eaTPase110 = #agitab99#8;
|FPRC;
