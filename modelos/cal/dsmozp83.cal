|FICHEROS;
     dsmozp83 #0;

     dsmom080 #80;
     dsmom081 #81;
     dsmom082 #82;
     dsmom083 #83;

     :/basica/def/agifigen #118;
     :/basica/def/agicen14 #114;

     dsmod300 #300;
     dsmod303 #303;
     dsmod320 #320;
     dsmod330 #330;
     dsmod332 #332;
     dsmod370 #370;
     dsm30301;
|FIN;

|VARIABLES;
     nDEmpresa = 0;
     nHEmpresa = 0;
     aDNom     = "";
     aHNom     = "";
     nEjer          = 0;
     nDPeriodo      = 0;
     nHPeriodo      = 0;
     nCampo         = 0;

     fFecIni     = @;
     fFecFin     = @;
     nSwAlgun    = 0;
     nSwPrint    = 0;
     aAlfa       = "";
     aAlfa1      = "";
     aAlfa2      = "";
     aAlfa3      = "";
     aAlfa4      = "";
     fLaFecha    = @;
     &enImp1     = 0;
     &enImp2     = 0;
     &enImp3     = 0;
     &enImp4     = 0;
     &enImp5     = 0;
     &enImp6     = 0;
     &enImp7     = 0;
     &aEmpresa   = "";
     &eaNom      = "";
     &eaNif      = "";
     &nSwFich    = 0;
     aParam      = "";
     informe     = "dsmozp83";
     nSwSal      = 0;

     aPr     = "";
     nPr     = 0;
    nSwExi   = 0;
    nHay     = 0;
    nHay81   = 0;
    nSwComunero = 0;
    nNumAct     = 0;
    &aError     = "";
    nSwOp83     = 0;
    nNumeP      = 0;
|FIN;

|INCLUYE i_variar;

|| /////////////////////// PROCESOS ENTRADA POR PANTALLA \\\\\\\\\\\\\\\\\\\\
|CALCULO Eano; |TIPO 7;
 fLaFecha = ~;
 aAlfa1 = fLaFecha; aAlfa1 = aAlfa1 % -104;
 #0#3 = aAlfa1;
 |SI #0#3 > 2010; #0#3 = 2010; |FINSI;
 |PINTA #0#3;
|FCAL;

|PROCESO Periodo;
     #0#2 = "          ";
     |SI #0#1 = 1;   #0#2 = "ENERO     ";  |FINSI;
     |SI #0#1 = 2;   #0#2 = "FEBRERO   ";  |FINSI;
     |SI #0#1 = 3;   #0#2 = "MARZO     ";  |FINSI;
     |SI #0#1 = 4;   #0#2 = "ABRIL     ";  |FINSI;
     |SI #0#1 = 5;   #0#2 = "MAYO      ";  |FINSI;
     |SI #0#1 = 6;   #0#2 = "JUNIO     ";  |FINSI;
     |SI #0#1 = 7;   #0#2 = "JULIO     ";  |FINSI;
     |SI #0#1 = 8;   #0#2 = "AGOSTO    ";  |FINSI;
     |SI #0#1 = 9;   #0#2 = "SEPTIEMBRE";  |FINSI;
     |SI #0#1 = 10;  #0#2 = "OCTUBRE   ";  |FINSI;
     |SI #0#1 = 11;  #0#2 = "NOVIEMBRE ";  |FINSI;
     |SI #0#1 = 12;  #0#2 = "DICIEMBRE ";  |FINSI;
     |SI #0#1 = 99;  #0#2 = "EJERCICIO ";  |FINSI;

     |SI #0#2 = "          ";
         |MENAV "     Periodo Incorrecto.";
         |ERROR;
     |FINSI;
     |PINTA #0#2;
|FPRC;

|PROCESO Parrilla;
|FPRC;

|| /////////////////////// PROCESOS DE TRABAJO \\\\\\\\\\\\\\\\\\\\
|| **************************************************************************

|PROCESO dsm30301;
     nSwExi = 1;
     enImp5 = enImp5 + #dsm30301#60;
     aPr    = #dsm30301#93;
     nPr    = #dsm30301#92;
     |SI aPr = "E"; |Y nPr = 0;
         #dsm30301#92 = nNumeP;
         |GRABA 020#dsm30301.a;
     |FINSI;
     |LIBERA #dsm30301;
|FPRC;

|DEFBUCLE dsm30301;
     #dsm30301#1;
     ;
     enEmpresa, enEjer, #82#2, 000, 00, 00;
     enEmpresa, enEjer, #82#2, 999, 99, 99;
     be;
     NULL, dsm30301;
|FIN;

|PROCESO Leed370;
   nSwExi = 1;
   enImp5 = enImp5 + #370#55;
   aPr    = #370#88;
   nPr    = #370#87;
   |SI aPr = "E"; |Y nPr = 0;
       #370#87 = nNumeP;
       |GRABA 020#370a;
   |FINSI;
   |LIBERA #370;
|FPRC;

|DEFBUCLE Leed370;
 #370#1;
 ;
 enEmpresa, enEjer, #82#2, 000, 00, 00;
 enEmpresa, enEjer, #82#2, 999, 99, 99;
 be;
 NULL, Leed370;
|FIN;

|PROCESO Leed332;
   nSwExi = 1;
   enImp5 = enImp5 + #332#55;
   aPr    = #332#71;
   nPr    = #332#70;
   |SI aPr = "E"; |Y nPr = 0;
       #332#70 = nNumeP;
       |GRABA 020#332a;
   |FINSI;
   |LIBERA #332;
|FPRC;

|DEFBUCLE Leed332;
 #332#1;
 ;
 enEmpresa, enEjer, #82#2, 000, 00, 00;
 enEmpresa, enEjer, #82#2, 999, 99, 99;
 be;
 NULL, Leed332;
|FIN;

|PROCESO Leed330;
   nSwExi = 1;
   enImp5 = enImp5 + #330#55;
   aPr    = #330#71;
   nPr    = #330#70;
   |SI aPr = "E"; |Y nPr = 0;
       #330#70 = nNumeP;
       |GRABA 020#330a;
   |FINSI;
   |LIBERA #330;
|FPRC;

|DEFBUCLE Leed330;
 #330#1;
 ;
 enEmpresa, enEjer, #82#2, 000, 00, 00;
 enEmpresa, enEjer, #82#2, 999, 99, 99;
 be;
 NULL, Leed330;
|FIN;

|PROCESO Leed320;
   nSwExi = 1;
   enImp5 = enImp5 + #320#55;
   aPr    = #320#69;
   nPr    = #320#68;
   |SI aPr = "E"; |Y nPr = 0;
       #320#68 = nNumeP;
       |GRABA 020#320a;
   |FINSI;
   |LIBERA #320;
|FPRC;

|DEFBUCLE Leed320;
 #320#1;
 ;
 enEmpresa, enEjer, #82#2, 000, 00, 00;
 enEmpresa, enEjer, #82#2, 999, 99, 99;
 be;
 NULL, Leed320;
|FIN;

|PROCESO Leed300;
   nSwExi = 1;
   enImp5 = enImp5 + #300#55;
   aPr    = #300#67;
   nPr    = #300#66;
   |SI aPr = "E"; |Y nPr = 0;
       #300#66 = nNumeP;
       |GRABA 020#300a;
   |FINSI;
   |LIBERA #300;
|FPRC;

|DEFBUCLE Leed300;
 #300#1;
 ;
 enEmpresa, enEjer, #82#2, 000, 00, 00;
 enEmpresa, enEjer, #82#2, 999, 99, 99;
 be;
 NULL, Leed300;
|FIN;


|PROCESO Leed303;
   nSwExi = 1;
   enImp5 = enImp5 + #303#49;
   aPr    = #303#65;
   nPr    = #303#64;
   |SI aPr = "E"; |Y nPr = 0;
       #303#64 = nNumeP;
       |GRABA 020#303a;
   |FINSI;
   |LIBERA #303;
|FPRC;

|DEFBUCLE Leed303;
 #303#1;
 ;
 enEmpresa, enEjer, #82#2, 000, 00, 00;
 enEmpresa, enEjer, #82#2, 999, 99, 99;
 be;
 NULL, Leed303;
|FIN;

|| .... .... ... .. .. ACTUALIZA FICHERO CORRECTO
|PROCESO LeeActPerio;

  #81#12 = #81#12 + #83#9; || Iva subvenciones

  #83#31 = #0#13;

  #83#32 = #0#6;
  #83#33 = #0#7;
  #83#34 = #0#8;
  #83#35 = #0#9;
  #83#36 = #0#10;
  #83#37 = #0#11;
  #83#38 = #0#12;
  #83#58 = #0#14; || simp

  |SI #83#3 ! 12;
      #81#11 = #81#11 + #83#4;
      #81#13 = #81#13 + #83#6;

      #81#16 = #81#16 + #83#10;
      #81#17 = #81#17 + #83#11;
      #81#18 = #81#18 + #83#12;
      #81#19 = #81#19 + #83#13;
      #81#20 = #81#20 + #83#14;
      #81#21 = #81#21 + #83#15;
      #81#22 = #81#22 + #83#16;
      #81#37 = #81#37 + #83#55;

      #81#23 = #81#23 + #83#17;
      #81#24 = #81#24 + #83#18;
      #81#25 = #81#25 + #83#19;
      #81#26 = #81#26 + #83#20;
      #81#27 = #81#27 + #83#21;
      #81#28 = #81#28 + #83#22;
      #81#29 = #81#29 + #83#23;
      #81#38 = #81#38 + #83#56;

  |SINO;

      #83#47 = #81#11;
      #83#48 = #81#16;
      #83#49 = #81#17;
      #83#50 = #81#18;
      #83#51 = #81#19;
      #83#52 = #81#20;
      #83#53 = #81#21;
      #83#54 = #81#22;
      #83#60 = #81#37;

      #81#11 = #83#4;
      #81#13 = #83#6;

      #81#16 = #83#10;
      #81#17 = #83#11;
      #81#18 = #83#12;
      #81#19 = #83#13;
      #81#20 = #83#14;
      #81#21 = #83#15;
      #81#22 = #83#16;
      #81#37 = #83#55;

      #81#23 = #83#17;
      #81#24 = #83#18;
      #81#25 = #83#19;
      #81#26 = #83#20;
      #81#27 = #83#21;
      #81#28 = #83#22;
      #81#29 = #83#23;
      #81#38 = #83#56;
  |FINSI;

  #81#14 = #81#11 - #81#13;

  #81#30 = #81#16 - #81#23;
  #81#31 = #81#17 - #81#24;
  #81#32 = #81#18 - #81#25;
  #81#33 = #81#19 - #81#26;
  #81#34 = #81#20 - #81#27;
  #81#35 = #81#21 - #81#28;
  #81#36 = #81#22 - #81#29;
  #81#39 = #81#37 - #81#38;

  #0#13 = #0#13 + #83#39;

  #0#6 = #0#6 + #83#40;
  #0#7 = #0#7 + #83#41;
  #0#8 = #0#8 + #83#42;
  #0#9 = #0#9 + #83#43;
  #0#10 = #0#10 + #83#44;
  #0#11 = #0#11 + #83#45;
  #0#12 = #0#12 + #83#46;
  #0#14 = #0#14 + #83#59;

  |GRABA 020#83a;
  |LIBERA #83;
  nHay = 1;
|FPRC;

|DEFBUCLE LeeActPerio;
 #83#1;
 ;
 #81#0, #81#1, #81#2, 01;
 #81#0, #81#1, #81#2, 12;
 ;
 NULL, LeeActPerio;
|FIN;

|PROCESO ActActividad;

 |SI #0#17 = "S";
     #81#6 = 100;
 |FINSI;


 |PDEFECTO #0,6,15;
 #81#11 = 0; #81#12 = 0;
 #81#13 = 0; #81#14 = 0;
 |PDEFECTO #81,16,40;

 nHay = 0;
 |BUCLE LeeActPerio;

 |SI nHay = 0;
     |BORRA 020#81a;
 |SINO;
     |GRABA 020#81a;
     nHay81 = 1;
 |FINSI;
 |LIBERA #81;
|FPRC;

|DEFBUCLE ActActividad;
 #81#1;
 ;
 enEmpresa, enEjer, 01;
 enEmpresa, enEjer, 99;
 ;
 NULL, ActActividad;
|FIN;

|PROCESO ActPeriodos;

  #80#11 = #80#11 + #82#8;

  #82#31 = #0#13;

  #82#32 = #0#6;
  #82#33 = #0#7;
  #82#34 = #0#8;
  #82#35 = #0#9;
  #82#36 = #0#10;
  #82#37 = #0#11;
  #82#38 = #0#12;
  #82#58 = #0#14;

  |SI #82#2 ! 12;
      #80#10 = #80#10 + #82#3;

      #80#17 = #80#17 + #82#9;
      #80#18 = #80#18 + #82#10;
      #80#19 = #80#19 + #82#11;
      #80#20 = #80#20 + #82#12;
      #80#21 = #80#21 + #82#13;
      #80#22 = #80#22 + #82#14;
      #80#23 = #80#23 + #82#15;
      #80#40 = #80#40 + #82#55;

  |SINO;
      #82#47 = #80#10;
      #82#48 = #80#17;
      #82#49 = #80#18;
      #82#50 = #80#19;
      #82#51 = #80#20;
      #82#52 = #80#21;
      #82#53 = #80#22;
      #82#54 = #80#23;
      #82#60 = #80#40;

      #80#10 = #82#3;

      #80#17 = #82#9;
      #80#18 = #82#10;
      #80#19 = #82#11;
      #80#20 = #82#12;
      #80#21 = #82#13;
      #80#22 = #82#14;
      #80#23 = #82#15;
      #80#40 = #82#55;

  |FINSI;

  #80#12 = #80#12 + #82#39;

  #80#24 = #80#24 + #82#40;
  #80#25 = #80#25 + #82#41;
  #80#26 = #80#26 + #82#42;
  #80#27 = #80#27 + #82#43;
  #80#28 = #80#28 + #82#44;
  #80#29 = #80#29 + #82#45;
  #80#30 = #80#30 + #82#46;
  #80#41 = #80#41 + #82#59;

  #80#13 = #80#10 - #80#12;

  #80#33 = #80#17 - #80#24;
  #80#34 = #80#18 - #80#25;
  #80#35 = #80#19 - #80#26;
  #80#36 = #80#20 - #80#27;
  #80#37 = #80#21 - #80#28;
  #80#38 = #80#22 - #80#29;
  #80#39 = #80#23 - #80#30;
  #80#42 = #80#40 - #80#41;

  #0#13 = #0#13 + #82#39;

  #0#6 = #0#6 + #82#40;
  #0#7 = #0#7 + #82#41;
  #0#8 = #0#8 + #82#42;
  #0#9 = #0#9 + #82#43;
  #0#10 = #0#10 + #82#44;
  #0#11 = #0#11 + #82#45;
  #0#12 = #0#12 + #82#46;
  #0#14 = #0#14 + #82#59;

  |GRABA 020#82a;
  |LIBERA #82;
|FPRC;

|DEFBUCLE ActPeriodos;
 #82#1;
 ;
 enEmpresa, enEjer, 01;
 enEmpresa, enEjer, 12;
 be;
 NULL, ActPeriodos;
|FIN;


|PROCESO Actualiza80;

 |SI #0#17 = "S";
     #80#4  = "G";
     #80#5  = 100;
 |FINSI;
 |SI #80#2 = "G"; #80#31 = #80#3; |FINSI;
 |SI #80#4 = "G"; #80#32 = #80#5; |FINSI;

 nHay81 = 0;
 |BUCLE ActActividad;

 #80#10 = 0; #80#11 = 0;
 #80#12 = 0; #80#13 = 0;
 |PDEFECTO #80,17,31;
 |PDEFECTO #80,33,43;

 |PDEFECTO #0,6,15;
 |BUCLE ActPeriodos;

 |SI nHay81 = 0;
    |BORRA 020#80a;
 |SINO;
    |GRABA 020#80a;
 |FINSI;
 |LIBERA #80;

|FPRC;
|| ************************************************************************
|| -----------------------------------------------
|PROCESO PrimerFiltro;  || Mas de una Actividad
 |SI #114#5 > "01.01.0000";
     |SI #114#5 > fFecFin;  |ACABA;  |FINSI;
 |FINSI;
 |SI #114#6 > "01.01.0000";
     |SI #114#6 < fFecIni;  |ACABA; |FINSI; || Baja
 |FINSI;

 |SI #114#14 = "S";
     nSwComunero = 1;
 |SINO;
     nNumAct = nNumAct + 1;
 |FINSI;    || dia 08.06.2005 comunero
|FPRC;

|DEFBUCLE LeeActividades;
 #114#1;
 ;
 enEmpresa, 01;
 enEmpresa, 99;
 ;
 NULL, PrimerFiltro;
|FIN;
|| -----------------------------------------------

|PROCESO Leem083;
    |SI nSwOp83 = 1;
        |BORRA 020#83a;
        |LIBERA #83;
        |ACABA;
    |FINSI;

    |SI nSwOp83 = 2;
        |SI #83#2 = 99;
            |SI nNumAct = 1;
                |BORRA 020#83a;
                |LIBERA #83;
            |FINSI;
            |ACABA;
        |FINSI;
        |ABRE #114;
        #114#0 = enEmpresa;
        #114#1 = #83#2;
        |LEE 001#114=;
        |SI FSalida = 0;
            |SI #114#14 = "S";
                |BORRA 020#83a;
                |LIBERA #83;
            |FINSI;
        |FINSI;
    |FINSI;
|FPRC;

|DEFBUCLE Leem083;
     #83#1;
     ;
     enEmpresa, enEjer, 01, #82#2;
     enEmpresa, enEjer, 99, #82#2;
     be;
     NULL, Leem083;
|FIN;


|PROCESO LPeriodos;

     enImp5 = 0;
     aPr    = "";
     nPr    = 0;
     nSwExi = 0;
     |SI #82#4 ! 0; nNumeP = #82#4; |FINSI;

     |SI #0#3 [ 2008;
         |BUCLE Leed300;
         |SI nSwExi = 0; |BUCLE Leed320; |FINSI;
         |SI nSwExi = 0; |BUCLE Leed330; |FINSI;
         |SI nSwExi = 0; |BUCLE Leed332; |FINSI;
         |SI nSwExi = 0; |BUCLE Leed370; |FINSI;
     |FINSI;

     |SI #0#3 ] 2009;  |Y #0#3 [ 2013;
         |BUCLE Leed303;
         |SI nSwExi = 0; |BUCLE Leed370; |FINSI;
     |FINSI;

     |SI #0#3 ] 2014;
         |BUCLE dsm30301;
     |FINSI;

     |SI nSwExi = 0; |O aPr = "N";
        |SI #0#16 = "S"; |O nSwExi = 1;
            |BORRA 020#82a;
            nSwOp83 = 1;
            |BUCLE Leem083;
        |FINSI;
        |SI nSwExi = 0;
            aError = "Periodos sin Modelo";
        |SINO;
            aError = "No aplica Prorrata ";
        |FINSI;
        nSwPrint = 1;
        |ACABA;
     |FINSI;

     |SI nSwComunero = 1; |Y #0#18 = "S";
         nSwOp83 = 2;
         |BUCLE Leem083;
         nSwPrint = 1;
         aError = "Comunidad de Bienes";
     |FINSI;
|FPRC;

|DEFBUCLE LosPeriodos;
 #82#1;
 ;
 #80#0, #80#1, nDPeriodo;
 #80#0, #80#1, nHPeriodo;
 be;
 NULL, LPeriodos;
|FIN;


|PROCESO Leem080;   ||Prorrata Nueva

    |DDEFECTO #80;
    #80#0 = enEmpresa;
    #80#1 = enEjer;
    |LEE 001#80=;
    |SI FSalida ! 0; |ACABA; |FINSI;

    nNumeP = #80#31
    |BUCLE LosPeriodos;

    |HAZ Actualiza80;
|FPRC;


|PROCESO LEmpresa;
  enEmpresa = #118#0;
  aEmpresa = #118#0; |QBF aEmpresa;
  aEmpresa = ("00000" + aEmpresa) % -105;
  eaNom    = #118#1;
  eaNif    = #118#13;

  aError   = "";
  nSwPrint = 0;
  enImp1   = 0;   || iva soportado deducible
  enImp2   = 0;   || iva deducido
  enImp3   = 0;   || diferencia
  enImp4   = 0;   || subvenciones
  enImp5   = 0;   || modelo

  nSwComunero = 0;
  |BUCLE LeeActividades;

  |HAZ Leem080;

  |SI nSwPrint = 1;
      |SI #0#15 = "S"; |PRINT; |FINSI;
      nSwAlgun = 1;
  |FINSI;
|FPRC;

|DEFBUCLE agifigen;
 #118#1;
 ;
 nDEmpresa;
 nHEmpresa;
 e;
 NULL, LEmpresa;
|FIN;

|PROCESO Tipo3;  |TIPO 3;
     aAlfa1 = #0#3;
     aAlfa1 = "01.01." + aAlfa1; fFecIni = aAlfa1;
     aAlfa1 = #0#3;
     aAlfa1 = "31.12." + aAlfa1; fFecFin = aAlfa1;

     aDNom = " " * 40;
     aHNom = "z" * 40;
     nDPeriodo = 01;
     nHPeriodo = 12;
     |SI #0#1 ! 99;
         nDPeriodo = #0#1;
         nHPeriodo = #0#1;
     |FINSI;
     enEjer = #0#3;

|SI #0#15 = "S";
     |IMPRE 0;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |INFOR informe;
     |SI FSalida ! 0;  |FINIMP;  |ACABA;  |FINSI;
|FINSI;

     nDEmpresa = #0#4;
     nHEmpresa = #0#5;
     |ABRE #80;
     |BUCLE agifigen;
     |CIERRA #80;

     |SI #0#15 = "S";
         |SI nSwAlgun = 1;
            |PIEINF;
         |FINSI;
         |FININF;
         |FINIMP;
    |FINSI;
|FPRC;
|| ************************************************************

|PROGRAMA;
  aParam = PARAMETRO; |QBF aParam;

  |SI aParam = "";
      |MANTE #0;
  |SINO;
      |DDEFECTO #0;
      #0#1 = enPeriodo;
      #0#3 = enEjer;
      #0#15 = "N";
      |HAZ Tipo3;
  |FINSI;
|FPRO;
