|FICHEROS;
   dsmoy600 #0;
   dsm60001 #1;
   dsm60002 #2;
   dsm60006 #3;
   dsm60003 #5;
   dsmow132 #6;

   reprovi@ #100;
   repobla@ #101;
|FIN;

|VARIABLES;
   &enSwBlanco = 0; &MesPresent = ""; MesAlfa = ""; Tipo = ""; Comodin = "";
   nCont = 0; nCont1 = 0; nCont2 = 0;
   DEmpre = 0; HEmpre = 0; Mes = 0; Lineas = 0;
   Primero = 0;

   aFichero = ""; aVariable = "";

     &enCodProv = 0;
     &enCodPobl = 0;
     &eaNomProv = "";
     &eaNomPobl = "";
     &enSwDeDonde = 0;

   nPob  = 0;
   nTipo = 0;
   nNumCmp = 0;
   nCalc = 0;

   nSP = 0;
   nTR = 0;
   nLinea = 0;
   nContCampo = 0;

   aBase  = "";
   nCanal = 0;

   aAlfa = "";
   aAlfa1 = "";
|FIN;

|PROCESO EmiteAnexo2;
   |SI Primero = 1;
      Primero = 0;
   |SINO;
      |PRINT;  nCont2 = nCont2 + 1;
   |FINSI;
|FPRC;

|DEFBUCLE EmiteAnexo2;
#dsm60003#1;
;
#dsm60001#0,#dsm60001#57,001;
#dsm60001#0,#dsm60001#57,999;
;
NULL,EmiteAnexo2;
|FIN;

|PROCESO EmiteAnexo1;
   |PRINT;
|FPRC;

|DEFBUCLE EmiteAnexo1;
#dsmow132#1;
;
INICIO;
FINAL;
;
NULL,EmiteAnexo1;
|FIN;

|PROCESO RellenaSPTR;
   |SI #dsm60002#2 = "S";
      |SI nSP = 1; nSP = 0; |ACABA; |FINSI;
   |FINSI;

   |SI #dsm60002#2 = "T";
      |SI nTR = 1; nTR = 0; |ACABA; |FINSI;
   |FINSI;

   |SI #dsm60002#2 = "S";
      |LEE 000#dsmow132.u;
      |SI FSalida ! 0;
         |DDEFECTO #dsmow132;
         #dsmow132#0 = 1;
         |GRABA 020#dsmow132.c;
      |SINO;
         |PARA; |SI FSalida = 0; |Y #dsmow132#1 = 0; |Y #dsmow132#16 = 0; |Y #dsmow132#31 = 0; |Y #dsmow132#46 = 0; |HACIENDO;
            |LEE 000#dsmow132.a;
         |SIGUE;
      |FINSI;
      nContCampo = 0;
      |SI #dsmow132#46 = 0; nContCampo = 46; |FINSI;
      |SI #dsmow132#31 = 0; nContCampo = 31; |FINSI;
      |SI #dsmow132#16 = 0; nContCampo = 16; |FINSI;
      |SI #dsmow132#1  = 0; nContCampo = 1;  |FINSI;
      |SI nContCampo = 0;
         nLinea = #dsmow132#0 + 1;
         |DDEFECTO #dsmow132;
         #dsmow132#0 = nLinea;
         |GRABA 020#dsmow132.c;
         nContCampo = 1;
      |FINSI;
      #dsmow132#nContCampo# = #dsm60002#3; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#1; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#4; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#5; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#6; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#7; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = "";          nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#12; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#13; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#14; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#15; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#16; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#10; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#11; nContCampo = nContCampo + 1;
      aAlfa = (("00" + #dsm60002#8) % -102) + (("000" + #dsm60002#9) % -103);
      #dsmow132#nContCampo# = aAlfa;
      |GRABA 020#dsmow132.a;
   |FINSI;
   |SI #dsm60002#2 = "T";
      |LEE 000#dsmow132.u;
      |SI FSalida ! 0;
         |DDEFECTO #dsmow132;
         #dsmow132#0 = 1;
         |GRABA 020#dsmow132.c;
      |SINO;
         |PARA; |SI FSalida = 0; |Y #dsmow132#61 = 0; |Y #dsmow132#76 = 0; |Y #dsmow132#91 = 0; |Y #dsmow132#106 = 0; |HACIENDO;
            |LEE 000#dsmow132.a;
         |SIGUE;
      |FINSI;
      nContCampo = 0;
      |SI #dsmow132#106 = 0; nContCampo = 106; |FINSI;
      |SI #dsmow132#91  = 0; nContCampo = 91;  |FINSI;
      |SI #dsmow132#76  = 0; nContCampo = 76;  |FINSI;
      |SI #dsmow132#61  = 0; nContCampo = 61;  |FINSI;
      |SI nContCampo = 0;
         nLinea = #dsmow132#0 + 1;
         |DDEFECTO #dsmow132;
         #dsmow132#0 = nLinea;
         |GRABA 020#dsmow132.c;
         nContCampo = 61;
      |FINSI;

      #dsmow132#nContCampo# = #dsm60002#3; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#1; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#4; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#5; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#6; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#7; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = "";          nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#12; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#13; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#14; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#15; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#16; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#10; nContCampo = nContCampo + 1;
      #dsmow132#nContCampo# = #dsm60002#11; nContCampo = nContCampo + 1;
      aAlfa = (("00" + #dsm60002#8) % -102) + (("000" + #dsm60002#9) % -103);
      #dsmow132#nContCampo# = aAlfa;
      |GRABA 020#dsmow132.a;
   |FINSI;
|FPRC;

|DEFBUCLE RellenaSPTR;
#dsm60002#1;
;
#dsm60001#0,#dsm60001#57,"            "," ";
#dsm60001#0,#dsm60001#57,"zzzzzzzzzzzz","z";
;
NULL,RellenaSPTR;
|FIN;

|PROCESO LeePoblacion;
   |DBASS aBase;   |QBT aBase;
   aAlfa = aBase + "integral/def/dsam0000.mas";
   |XABRE "E", aAlfa, nCanal;
   |SI FSalida ] 0;
      aAlfa = aBase + "integral/def/dsam0100.mas"; nPob = 1;
   |SINO;
      aAlfa = aBase + "basica/def/agiprovi.mas";   nPob = 2;
   |FINSI;

   |CARGA_DEF aAlfa, reprovi@;
   |SI nPob = 1;
      aAlfa = aBase + "integral/fich/"; |PATH_DAT #reprovi@#aAlfa#;
   |SINO;
      aAlfa = aBase + "basica/fich/"; |PATH_DAT #reprovi@#aAlfa#;
   |FINSI;
   |ABRE #reprovi@;
   |SI nTipo = 0;
      #reprovi@#0 = enCodProv;
      |LEE 000#reprovi@.=;
      |SI FSalida = 0;
         eaNomProv = #reprovi@#1;
      |SINO;
         |MENAV "    Provincia inexistente";
         |ERROR;
      |FINSI;
   |FINSI;
   |CIERRA #reprovi@; |DESCARGA_DEF #reprovi@;

   |DBASS aBase;   |QBT aBase;
   aAlfa = aBase + "integral/def/dsam0000.mas";
   |XABRE "E", aAlfa, nCanal;
   |SI FSalida ] 0;
      aAlfa = aBase + "integral/def/dsam0101.mas"; nPob = 1;
   |SINO;
      aAlfa = aBase + "basica/def/agipobla.mas";   nPob = 2;
   |FINSI;

   |CARGA_DEF aAlfa, repobla@;
   |SI nPob = 1;
      aAlfa = aBase + "integral/fich/"; |PATH_DAT #repobla@#aAlfa#;
   |SINO;
      aAlfa = aBase + "basica/fich/"; |PATH_DAT #repobla@#aAlfa#;
   |FINSI;
   |ABRE #repobla@;
   |SI nTipo = 0;
      #repobla@#0 = enCodPobl;
      |LEE 000#repobla@.=;
      |SI FSalida = 0;
         eaNomPobl = #repobla@#1;
      |SINO;
         |MENAV "    Poblacion inexistente";
         |ERROR;
      |FINSI;
   |FINSI;
   |CIERRA #repobla@; |DESCARGA_DEF #repobla@;
|FPRC;

|PROCESO Emision;
   Comodin = #dsmoy600#33; |QBF Comodin;
   Comodin = Comodin % 0402; Mes = Comodin; |HAZ MesAlfa;
   MesPresent = MesAlfa;

   |INFOR "dsm60001";
   |SI FSalida < 0; |ERROR10; |FINSI;

/*
   enCodProv = #1000#20;
   enCodPobl = #1000#21;
   |HAZ LeePoblacion;
*/

   |PRINT;
   |PIEINF; |FININF;

   |DELINDEX #dsmow132; |ABRE #dsmow132;
   nTR = 1; nSP = 1;
   |BUCLE RellenaSPTR;
   |CIERRA #dsmow132;

   |INFOR "dsm60002";
   |SI FSalida < 0; |ERROR10; |FINSI;

   |BUCLE EmiteAnexo1;
   |PIEINF; |FININF;

   |INFOR "dsm60003";
   Primero = 1; nCont2 = 0; |BUCLE EmiteAnexo2;
   |PIEINF; |FININF;

   #dsmoy600#35 = #dsmoy600#35 + 1;
   |GRABA 020#dsmoy600.a;
|FPRC;

|PROCESO Selec;
   |SI #dsmoy600#0 = "S";
      #dsmoy600#1 = 00001; |PINTA #dsmoy600#1;
      #dsmoy600#2 = 99999; |PINTA #dsmoy600#2;
      |C_M #dsmoy600#1,1,"S";
      |C_M #dsmoy600#2,1,"S";
      |PARA nCont = 3; |SI nCont [ 32; |HACIENDO nCont = nCont + 1;
         #dsmoy600#nCont# = 0; |PINTA #dsmoy600#nCont#;
         |C_M #dsmoy600#nCont#,1,"N";
      |SIGUE;
   |SINO;
      #dsmoy600#1 = 0; |PINTA #dsmoy600#1;
      #dsmoy600#2 = 0; |PINTA #dsmoy600#2;
      |C_M #dsmoy600#1,1,"N";
      |C_M #dsmoy600#2,1,"N";
      |PARA nCont = 3; |SI nCont [ 32; |HACIENDO nCont = nCont + 1;
         |C_M #dsmoy600#nCont#,1,"S";
      |SIGUE;
   |FINSI;
|FPRC;

|PROCESO MesAlfa;
   |SI Mes = 1;  MesAlfa = "Enero     "; |FINSI;
   |SI Mes = 2;  MesAlfa = "Febrero   "; |FINSI;
   |SI Mes = 3;  MesAlfa = "Marzo     "; |FINSI;
   |SI Mes = 4;  MesAlfa = "Abril     "; |FINSI;
   |SI Mes = 5;  MesAlfa = "Mayo      "; |FINSI;
   |SI Mes = 6;  MesAlfa = "Junio     "; |FINSI;
   |SI Mes = 7;  MesAlfa = "Julio     "; |FINSI;
   |SI Mes = 8;  MesAlfa = "Agosto    "; |FINSI;
   |SI Mes = 9;  MesAlfa = "Septiembre"; |FINSI;
   |SI Mes = 10; MesAlfa = "Octubre   "; |FINSI;
   |SI Mes = 11; MesAlfa = "Noviembre "; |FINSI;
   |SI Mes = 12; MesAlfa = "Diciembre "; |FINSI;
|FPRC;

|DEFBUCLE Emision;
#dsm60001#1;
;
DEmpre,nNumCmp;
HEmpre,nNumCmp;
be;
NULL,Emision;
|FIN;

|PROCESO PreparaInformes;
     |DBASS aBase;   |QBT aBase;
     aBase = aBase + "integral/def/dsam0000.mas";
     |XABRE "E", aBase, nCanal;
     |SI FSalida ] 0;
         enSwDeDonde = 1;
     |SINO;
         enSwDeDonde = 0;
     |FINSI;

     |DBASS aBase;   |QBT aBase;

     aFichero = aBase + "modelos/def/hacienda.ref";
     |XABRE "W", aFichero, nCanal;
     |SI enSwDeDonde = 1;
         aVariable = ":/integral/def/dsam0102" + &13 + &10;
     |SINO;
         aVariable = ":/basica/def/agihacie" + &13 + &10;
     |FINSI;
     |XGRABA nCanal, aVariable;
     |XCIERRA nCanal;

     aFichero = aBase + "modelos/def/poblacion.ref";
     |XABRE "W", aFichero, nCanal;
     |SI enSwDeDonde = 1;
         aVariable = ":/integral/def/dsam0101" + &13 + &10;
     |SINO;
         aVariable = ":/basica/def/agipobla" + &13 + &10;
     |FINSI;
     |XGRABA nCanal, aVariable;
     |XCIERRA nCanal;
|FPRC;

|PROGRAMA;
   |HAZ PreparaInformes;

   |ABRE #dsmoy600;
   |LEE 000#dsmoy600.p;
   |SI FSalida ! 0;
      |DDEFECTO #dsmoy600;
      |GRABA 020#dsmoy600.c;
   |FINSI;

   |SI PARAMETRO = "";
      |CLS;
      |CABEZA "Emision modelo 600";
      |PINPA #0#0; |PINDA #0#0;
      |ENDATOS #1#0;
      |SI FSalida = 0;
         nNumCmp = #dsmoy600#37;
         |IMPRE 0;
         |SI FSalida < 0; |ACABA; |FINSI;
         |SI #dsmoy600#0 = "S";
            DEmpre = #dsmoy600#1; HEmpre = #dsmoy600#2;
            |BUCLE Emision;
         |SINO;
            |PARA nCont = 3; |SI nCont [ 32; |HACIENDO nCont = nCont + 1;
               DEmpre = #dsmoy600#nCont#; HEmpre = #dsmoy600#nCont#;
               |BUCLE Emision;
            |SIGUE;
         |FINSI;
         |FINIMP;
      |FINSI;
   |SINO;
      aAlfa = PARAMETRO; |QBF aAlfa;
      aAlfa = aAlfa - ",";
      |SI FSalida ! 0;
         nCalc = 99 + ((FSalida / 100) ! 0);
         aAlfa1 = aAlfa % nCalc; DEmpre = aAlfa1; HEmpre = aAlfa1;
         nCalc = 98 + FSalida;
         aAlfa1 = aAlfa % nCalc; nNumCmp = aAlfa1;
         |IMPRE 0;
         |SI FSalida < 0; |ACABA; |FINSI;
         |BUCLE Emision;
         |FINIMP;
      |SINO;
      |FINSI;
   |FINSI;
   |CIERRA #dsmoy600;
|FPRO;
