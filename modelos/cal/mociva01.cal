|FICHEROS;
     dsmociva;
     dsmom004;
     dsmom008;
     dsmom027;
     dsmom028;
     dsmom029;
     dsmom047;
     dsmom087;
     dsmom103;

     dsmod300;
     dsmod303;
     dsmod310;
     dsmod320;
     dsmod330;
     dsmod332;
     dsmod370;
     dsm30301;

     dsmocivp;

     dsmodiva@;
|FIN;

|VARIABLES;
     nPer1   = 0;
     nPer2   = 0;
     swerror = 0;
     fDFecha = @;
     fHFecha = @;
     nCampo68      = 0;
     nCampo        = 0;
     nCampo1       = 0;
     nCampo2       = 0;
     nCampo3       = 0;
     nCampo11      = 0;
     nCampo22      = 0;
     nCampo33      = 0;
     nValor1       = 0;
     nValor2       = 0;
     nGrupo        = 0;
     nSubGrupo     = 0;
     nPeriodoMin   = 0;
     nEjerAnt      = 0;
     nSwAcum       = 0;
     nDesde        = 0;
     nHasta        = 0;
     nContador     = 0;
     nResult       = 0;
     nSwGraba      = 0;
     nAnyo         = 0;
     nPer          = 0;
     nTipo         = 0;
     nPeriodo      = 0;
     nDepar        = 0;
     nEjer         = 0;
     nModBucle     = 0;
     nPorCalculado = 0;
     nPon          = 0;
     nEl62         = 0;
     nHComple      = 0;
     nModAnter     = 0;
     nTotal303     = 0;
     nDPer349      = 0;
     nHPer349      = 0;
     nNegativo     = 0;
     nNegativoC    = 0;
     nNegativoD    = 0;
     nIVA          = 0;
     nCuotasAnterior = 0;
     nIVA7           = 0;
     nIVA10          = 0;
     nIVA13          = 0;
     nIVA16          = 0;
     nIVA19          = 0;
     nIVA22          = 0;
     nIVA25          = 0;
     nIVA28          = 0;
     nIVA31          = 0;
     nSubeIVA        = 0;

     aAlfa           = "";
     aAlfa1          = "";
     aTecla          = "";
     aBase           = "";
     aMas            = "";
     aDesConexion349 = "";
     aParametro      = "";

     &EURODB     = 0;
     &enPregunta = 0;

    nSwOpe29     = 0;
    aPerNom      = "";
    nCuotaMas    = 0;
    nBaseMas     = 0;
    nDPer        = 0;
    nHPer        = 0;

    nNume1 = 0;
    nNume2 = 0;
    swpase = 0;
    nPro   = 0;
    nAlgun = 0;
    nInkey = 0;
    nEntro = 0;

    &enEmpAmor  = 0;
    &enEjeAmor  = 0;
    &enDActAmor = 0;
    &enHActAmor = 0;
    &enImpRegul = 0;
    &enModoAmor = 0;

    aModo       = "";
    &enProAct   = 0;
    &enProCom   = 0;
    nComun      = 0;
    nSwHay      = 0;
    nEjerCarga  = 0;
    &eMensa     = 0;
    nSuma       = 0;
    nDImporte   = 0;
    nHImporte   = 0;
|FIN;

|INCLUYE i_variar;

|| ///////////////// Procesos Grabacion de Modelos \\\\\\\\\\\\\\\\\\\\

|PROCESO EjerAnt;
      nEjerAnt = nEjerAnt + #dsmom103#5;
|FPRC;

|DEFBUCLE dsmom103;
     #dsmom103#1;
     ;
     enModelo, enEmpresa, 00, nAnyo, nPer;
     enModelo, enEmpresa, 99, nAnyo, nPer;
     ;
     NULL, EjerAnt;
|FIN;

|| ... Modificacion del a compensar anterior, si tiene complementarias
|PROCESO LeeComplem;
  |SI nModAnter = 332; nEjerAnt = #dsmod332#67; |FINSI;
  |SI nModAnter = 330; nEjerAnt = #dsmod330#67; |FINSI;
  |SI nModAnter = 320; nEjerAnt = #dsmod320#65; |FINSI;
  |SI nModAnter = 300; nEjerAnt = #dsmod300#63; |FINSI;
  |SI nModAnter = 303; nEjerAnt = #dsmod303#61; |FINSI;
  |SI nModAnter = 310; nEjerAnt = #dsmod310#38; |FINSI;
  |SI nModAnter = 370; nEjerAnt = #dsmod370#84; |FINSI;
|FPRC;

|DEFBUCLE LeeCompl332;
  #dsmod332#1;
  ;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 00, 00;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 99, 00;
  ;
  NULL, LeeComplem;
|FIN;

|DEFBUCLE LeeCompl330;
  #dsmod330#1;
  ;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 00, 00;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 99, 00;
  ;
  NULL, LeeComplem;
|FIN;

|DEFBUCLE LeeCompl320;
  #dsmod320#1;
  ;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 00, 00;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 99, 00;
  ;
  NULL, LeeComplem;
|FIN;

|DEFBUCLE LeeCompl300;
  #dsmod300#1;
  ;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 00, 00;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 99, 00;
  ;
  NULL, LeeComplem;
|FIN;

|DEFBUCLE LeeCompl303;
  #dsmod303#1;
  ;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 00, 00;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 99, 00;
  ;
  NULL, LeeComplem;
|FIN;

|DEFBUCLE LeeCompl310;
  #dsmod310#1;
  ;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 00, 00;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 99, 00;
  ;
  NULL, LeeComplem;
|FIN;

|DEFBUCLE LeeCompl370;
  #dsmod370#1;
  ;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 00, 00;
  enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 99, 00;
  ;
  NULL, LeeComplem;
|FIN;

|PROCESO Recoge2013;
     nPeriodoMin = 1;
     |SI enModelo = 300; nPeriodoMin = 3;  |FINSI;

     |SI enModelo = 303;
         |ABRE #dsmom004;
         #dsmom004#0 = enEmpresa;
         #dsmom004#1 = enEjer;
         #dsmom004#2 = enPeriodo;
         #dsmom004#3 = enModelo;
         #dsmom004#4 = enComplem;
         |LEE 040#dsmom004.=;
         |SI FSalida ! 0;  |DDEFECTO #dsmom004;  |FINSI;

         |SI #dsmom004#22 = "M";
             nPeriodoMin = 1;
         |SINO;
             nPeriodoMin = 3;
         |FINSI;
         |CIERRA #dsmom004;
     |FINSI;

     |ABRE #dsmom004;
     #dsmom004#0 = enEmpresa;
     #dsmom004#3 = nModAnter;
     #dsmom004#4 = enComplem;
     |SI enPeriodo = nPeriodoMin;
         nAnyo     = enEjer - 1;
         nPer      = 12;
         nModAnter = 0;
     |SINO;
         nAnyo     = enEjer;
         nPer      = enPeriodo - nPeriodoMin;
         nModAnter = enModelo;
     |FINSI;

     |SI nModAnter = 0;
         #dsmom004#0 = enEmpresa;
         #dsmom004#1 = nAnyo;
         #dsmom004#2 = nPer;
         #dsmom004#3 = 303;
         #dsmom004#4 = 0;
         |LEE 040#dsmom004.=;
         |SI FSalida = 0;  nModAnter = #dsmom004#3;  |FINSI;
     |FINSI;

     |SI nModAnter = 0;
         #dsmom004#0 = enEmpresa;
         #dsmom004#1 = nAnyo;
         #dsmom004#2 = nPer;
         #dsmom004#3 = 300;
         #dsmom004#4 = 0;
         |LEE 040#dsmom004.=;
         |SI FSalida = 0;  nModAnter = #dsmom004#3;  |FINSI;
     |FINSI;

     |SI nModAnter = 0;
         #dsmom004#0 = enEmpresa;
         #dsmom004#1 = nAnyo;
         #dsmom004#2 = nPer;
         #dsmom004#3 = 320;
         #dsmom004#4 = 0;
         |LEE 040#dsmom004.=;
         |SI FSalida = 0;  nModAnter = #dsmom004#3;  |FINSI;
     |FINSI;

     |SI nModAnter = 0;
         #dsmom004#0 = enEmpresa;
         #dsmom004#1 = nAnyo;
         #dsmom004#2 = nPer;
         #dsmom004#3 = 332;
         #dsmom004#4 = 0;
         |LEE 040#dsmom004.=;
         |SI FSalida = 0;  nModAnter = #dsmom004#3;  |FINSI;
     |FINSI;

     |SI nModAnter = 0;
         #dsmom004#0 = enEmpresa;
         #dsmom004#1 = nAnyo;
         #dsmom004#2 = nPer;
         #dsmom004#3 = 330;
         #dsmom004#4 = 0;
         |LEE 040#dsmom004.=;
         |SI FSalida = 0;  nModAnter = #dsmom004#3;  |FINSI;
     |FINSI;

     |SI nModAnter = 0;
         #dsmom004#0 = enEmpresa;
         #dsmom004#1 = nAnyo;
         #dsmom004#2 = nPer;
         #dsmom004#3 = 310;
         #dsmom004#4 = 0;
         |LEE 040#dsmom004.=;
         |SI FSalida = 0;  nModAnter = #dsmom004#3;  |FINSI;
     |FINSI;

     |SI nModAnter = 0;
         #dsmom004#0 = enEmpresa;
         #dsmom004#1 = nAnyo;
         #dsmom004#2 = nPer;
         #dsmom004#3 = 370;
         #dsmom004#4 = 0;
         |LEE 040#dsmom004.=;
         |SI FSalida = 0;  nModAnter = #dsmom004#3;  |FINSI;
     |FINSI;

     #dsmom004#0 = enEmpresa;
     #dsmom004#1 = nAnyo;
     #dsmom004#2 = nPer;
     #dsmom004#3 = nModAnter;
     #dsmom004#4 = 0;
     |LEE 040#dsmom004.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmom004;
         #dsmom004#0 = enEmpresa;
         #dsmom004#1 = nAnyo;
         #dsmom004#2 = nPer;
         #dsmom004#3 = nModAnter;
     |FINSI;
     |CIERRA #dsmom004;

     nEjerAnt = 0;
     |SI nModAnter = 300;
         |CIERRA #dsmod300;
         |BUCLE LeeCompl300;
         |ABRE #dsmod300;
     |FINSI;

     |SI nModAnter = 303;
         |CIERRA #dsmod303;
         |BUCLE LeeCompl303;
         |ABRE #dsmod303;
     |FINSI;

     |SI nModAnter = 320;
         |CIERRA #dsmod320;
         |BUCLE LeeCompl320;
         |ABRE #dsmod320;
     |FINSI;

     |SI nModAnter = 330;
         |CIERRA #dsmod330;
         |BUCLE LeeCompl330;
         |ABRE #dsmod330;
     |FINSI;

     |SI nModAnter = 332;
         |CIERRA #dsmod332;
         |BUCLE LeeCompl332;
         |ABRE #dsmod332;
     |FINSI;

     |SI nModAnter = 310;
         |BUCLE LeeCompl310;
     |FINSI;

     |SI nModAnter = 370;
         |BUCLE LeeCompl370;
     |FINSI;

     |SI nEjerAnt = 0;
         |BUCLE dsmom103;
     |FINSI;

     |ABRE #dsmom047;
     #dsmom047#0 = enEmpresa;
     #dsmom047#1 = enEjer;
     #dsmom047#2 = enPeriodo;
     #dsmom047#3 = enModelo;
     #dsmom047#4 = enComplem;
     #dsmom047#5 = 0;
     |LEE 040#dsmom047.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom047;  |FINSI;
     |CIERRA #dsmom047;

     |ABRE #dsmom028;
     #dsmom028#0 = enEmpresa;
     #dsmom028#1 = enEjer;
     #dsmom028#2 = enPeriodo;
     #dsmom028#3 = enModelo;
     #dsmom028#4 = enComplem;
     #dsmom028#5 = 0;
     |LEE 040#dsmom028.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom028;  |FINSI;
     |CIERRA #dsmom028;

     |SI #dsmom028#7 = "N";  |ACABA;  |FINSI;

     nEjerAnt = nEjerAnt - #dsmom028#6;
     |SI nEjerAnt < 0;  nEjerAnt = 0;  |FINSI;
|FPRC;

|PROCESO LeeComplem30301;
     nEjerAnt = #dsm30301#89;
|FPRC;

|DEFBUCLE LeeCompl30301;
     #dsm30301#1;
     ;
     enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 00, 00;
     enEmpresa, #dsmom004#1, #dsmom004#2, nModAnter, 99, 00;
     ;
     NULL, LeeComplem30301;
|FIN;

|PROCESO Recoge2014;
     nPeriodoMin = 1;

     |ABRE #dsmom004;
     #dsmom004#0 = enEmpresa;
     #dsmom004#1 = enEjer;
     #dsmom004#2 = enPeriodo;
     #dsmom004#3 = enModelo;
     #dsmom004#4 = enComplem;
     |LEE 040#dsmom004.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom004;  |FINSI;

     |SI #dsmom004#22 = "M";
         nPeriodoMin = 1;
     |SINO;
         nPeriodoMin = 3;
     |FINSI;
     |CIERRA #dsmom004;

     |SI enPeriodo = nPeriodoMin;
         nAnyo     = enEjer - 1;
         nPer      = 12;
     |SINO;
         nAnyo     = enEjer;
         nPer      = enPeriodo - nPeriodoMin;
     |FINSI;

     nModAnter   = 0;

     |ABRE #dsmom004;
     #dsmom004#0 = enEmpresa;
     #dsmom004#1 = nAnyo;
     #dsmom004#2 = nPer;
     #dsmom004#3 = 303;
     #dsmom004#4 = 0;
     |LEE 040#dsmom004.=;
     |SI FSalida = 0;  nModAnter = #dsmom004#3;  |FINSI;

     |SI nModAnter = 0;
         #dsmom004#0 = enEmpresa;
         #dsmom004#1 = nAnyo;
         #dsmom004#2 = nPer;
         #dsmom004#3 = 310;
         #dsmom004#4 = 0;
         |LEE 040#dsmom004.=;
         |SI FSalida = 0;  nModAnter = #dsmom004#3;  |FINSI;
     |FINSI;

     |SI nModAnter = 0;
         #dsmom004#0 = enEmpresa;
         #dsmom004#1 = nAnyo;
         #dsmom004#2 = nPer;
         #dsmom004#3 = 370;
         #dsmom004#4 = 0;
         |LEE 040#dsmom004.=;
         |SI FSalida = 0;  nModAnter = #dsmom004#3;  |FINSI;
     |FINSI;

     #dsmom004#0 = enEmpresa;
     #dsmom004#1 = nAnyo;
     #dsmom004#2 = nPer;
     #dsmom004#3 = nModAnter;
     #dsmom004#4 = 0;
     |LEE 040#dsmom004.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmom004;
         #dsmom004#0 = enEmpresa;
         #dsmom004#1 = nAnyo;
         #dsmom004#2 = nPer;
         #dsmom004#3 = nModAnter;
     |FINSI;
     |CIERRA #dsmom004;

     nEjerAnt = 0;
     |SI nModAnter = 303;
         |SI #dsmom004#1 [ 2013;
             |BUCLE LeeCompl303;
         |FINSI;

         |SI #dsmom004#1 ] 2014;
             |BUCLE LeeCompl30301;
         |FINSI;
     |FINSI;

     |SI nModAnter = 370;
         |BUCLE LeeCompl370;
     |FINSI;

     |SI nEjerAnt = 0;
         |BUCLE dsmom103;
     |FINSI;

     |ABRE #dsmom047;
     #dsmom047#0 = enEmpresa;
     #dsmom047#1 = enEjer;
     #dsmom047#2 = enPeriodo;
     #dsmom047#3 = enModelo;
     #dsmom047#4 = enComplem;
     #dsmom047#5 = 0;
     |LEE 040#dsmom047.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom047;  |FINSI;
     |CIERRA #dsmom047;

     |ABRE #dsmom028;
     #dsmom028#0 = enEmpresa;
     #dsmom028#1 = enEjer;
     #dsmom028#2 = enPeriodo;
     #dsmom028#3 = enModelo;
     #dsmom028#4 = enComplem;
     #dsmom028#5 = 0;
     |LEE 040#dsmom028.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom028;  |FINSI;
     |CIERRA #dsmom028;

     |SI #dsmom028#7 = "N";  |ACABA;  |FINSI;

     nEjerAnt = nEjerAnt - #dsmom028#6;
     |SI nEjerAnt < 0;  nEjerAnt = 0;  |FINSI;
|FPRC;

|PROCESO RecogeAnter;
     |SI enEjer [ 2013;  |HAZ Recoge2013;  |FINSI;
     |SI enEjer ] 2014;  |HAZ Recoge2014;  |FINSI;
|FPRC;

|| ///////// Modelo 300 \\\\\\\\\\\\

|PROCESO GrabaDevengado300;
     |SI #dsmociva#nCampo3# = 0;  |ACABA;  |FINSI;
     nSwAcum       = 0;

     |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
           nCampo11 = nCampo33 - 2;
           nCampo22 = nCampo33 - 1;
           |SI #dsmod300#nCampo22# = #dsmociva#nCampo2#;
               #dsmod300#nCampo11# = #dsmod300#nCampo11# + #dsmociva#nCampo1#;
               #dsmod300#nCampo33# = #dsmod300#nCampo33# + #dsmociva#nCampo3#;
               nSwAcum = 1;
               |SAL;
            |FINSI;
     |SIGUE;

     |SI nSwAcum = 0;
         |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
               nCampo11 = nCampo33 - 2;
               nCampo22 = nCampo33 - 1;
               |SI #dsmod300#nCampo22# = 0;
                   #dsmod300#nCampo11# = #dsmociva#nCampo1#;
                   #dsmod300#nCampo22# = #dsmociva#nCampo2#;
                   #dsmod300#nCampo33# = #dsmociva#nCampo3#;
                   nSwAcum = 1;
                   |SAL;
               |FINSI;
         |SIGUE;
     |FINSI;

     |SI nSwAcum = 0;
         nCampo11     = nHasta - 2;
         nCampo22     = nHasta - 1;
         nCampo33     = nHasta;

         #dsmod300#nCampo11# = #dsmod300#nCampo11# + #dsmociva#nCampo1#;
         #dsmod300#nCampo22# = -1;
         #dsmod300#nCampo33# = #dsmod300#nCampo33# + #dsmociva#nCampo3#;
     |FINSI;
|FPRC;

|PROCESO GrabaDeducible300;
     |SI nDesde = 34; |Y nHasta = -2;   ||inversion
         nHasta = nDesde + 1;
         #dsmod300#nDesde# = #dsmod300#nDesde# - (#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32);
         #dsmod300#nHasta# = #dsmod300#nHasta# - (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34);
         |ACABA;
     |FINSI;

     |SI nHasta ! -1;
         nHasta = nDesde + 1;
     |FINSI;

     |SI nDesde ! 46;  |Y nDesde ! 48;
         |SI nHasta ! -1;
             #dsmod300#nDesde# = #dsmod300#nDesde# + ((#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32) % nProrrata) + nBaseMas;
             #dsmod300#nHasta# = #dsmod300#nHasta# + ((#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34) % nProrrata) + nCuotaMas;
         |SINO;
             #dsmod300#nDesde# = #dsmod300#nDesde# + ((#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34) % nProrrata) + nCuotaMas;
         |FINSI;
     |SINO;
         #dsmod300#nDesde# = #dsmod300#nDesde# + (#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32);
         #dsmod300#nHasta# = #dsmod300#nHasta# + (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34);
     |FINSI;
|FPRC;

|PROCESO Graba300;
     nDesde = 0;
     nHasta = 0;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 [ 4;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 6;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 7;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 8;   nDesde =  8;  nHasta = 14;  |FINSI;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 5;   nDesde = 26;  nHasta = 32;  |FINSI;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 10;  nDesde = 17;  nHasta = 23;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 11;  nDesde = 17;  nHasta = 23;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 12;  nDesde = 17;  nHasta = 23;  |FINSI;

     |SI nDesde ! 0;
         |PARA nCampo1 = 14;  |SI nCampo1 [ 23;  |HACIENDO nCampo1 = nCampo1 + 3;
               nCampo2 = nCampo1 + 1;
               nCampo3 = nCampo1 + 2;
               |SI #dsmociva#nCampo1# ! 0;  |O #dsmociva#nCampo2# ! 0;  |O #dsmociva#nCampo3# ! 0;
                   |HAZ GrabaDevengado300;
               |FINSI;
         |SIGUE;
     |FINSI;

     |PARA nCampo1 = 7;  |SI nCampo1 [ 31;  |HACIENDO nCampo1 = nCampo1 + 3;
           |SI #dsmod300#nCampo1# = -1;  #dsmod300#nCampo1# = 0;  |FINSI;
     |SIGUE;

     nDesde = 0;
     nHasta = 0;

     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 1;   nDesde = 34;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 2;   nDesde = 36;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 3;   nDesde = 40;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 4;   nDesde = 42;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 5;   nDesde = 46;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 6;   nDesde = 48;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 7;   nDesde = 52;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 9;   nDesde = 54;  nHasta = -1;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 11;  nDesde = 34;  nHasta = -2;  |FINSI;

     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 10;
         |SI #dsmociva#1 ] 2008;
             nDesde = 68;  nHasta = -1;
         |FINSI;
     |FINSI;

     |SI nDesde ! 0;
         |HAZ GrabaDeducible300;
     |FINSI;

     |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 9;
         #dsmod300#60 = #dsmod300#60 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 5;  |Y #dsmociva#7 = 1;
         #dsmod300#57   = #dsmod300#57 + #dsmociva#12;
         nContador = nContador + 1;
     |FINSI;

     |SI #dsmociva#6 = 5;  |Y #dsmociva#7 = 2;
         #dsmod300#61   = #dsmod300#61 + #dsmociva#12;
     |FINSI;
|FPRC;

|| ///////// Modelo 303 \\\\\\\\\\\\

|PROCESO GrabaDevengado303;
     |SI #dsmociva#nCampo3# = 0;  |ACABA;  |FINSI;
     nSwAcum       = 0;

     nIVA = #dsmociva#nCampo2#;

     |SI nSubeIVA = 1;
         |SI nIVA = 16;  nIVA = 18;  |FINSI;
         |SI nIVA = 7;   nIVA = 8;   |FINSI;
     |FINSI;
     |SI nSubeIVA = 2;
         |SI nIVA = 18; |O nIVA = 16; nIVA = 21;  |FINSI;
         |SI nIVA = 8;  |O nIVA = 7;  nIVA = 10;  |FINSI;
     |FINSI;
     |SI nSubeIVA = 2;
         |SI nDesde = 17;
             |SI nIVA = 4; nIVA = 5.20;  |FINSI;
             |SI nIVA = 1; nIVA = 1.40;  |FINSI;
         |FINSI;
     |FINSI;

     |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
           nCampo11 = nCampo33 - 2;
           nCampo22 = nCampo33 - 1;
           |SI #dsmod303#nCampo22# = nIVA;
               #dsmod303#nCampo11# = #dsmod303#nCampo11# + #dsmociva#nCampo1#;
               #dsmod303#nCampo33# = #dsmod303#nCampo33# + #dsmociva#nCampo3#;
               nSwAcum = 1;

               |SI nIVA ! #dsmociva#nCampo2#;
                   |SI nCampo22 = 7;   nIVA7  = 1;  |FINSI;
                   |SI nCampo22 = 10;  nIVA10 = 1;  |FINSI;
                   |SI nCampo22 = 13;  nIVA13 = 1;  |FINSI;
                   |SI nCampo22 = 16;  nIVA16 = 1;  |FINSI;
                   |SI nCampo22 = 19;  nIVA19 = 1;  |FINSI;
                   |SI nCampo22 = 22;  nIVA22 = 1;  |FINSI;
                   |SI nCampo22 = 25;  nIVA25 = 1;  |FINSI;
                   |SI nCampo22 = 28;  nIVA28 = 1;  |FINSI;
                   |SI nCampo22 = 31;  nIVA31 = 1;  |FINSI;
               |FINSI;
               |SAL;
            |FINSI;
     |SIGUE;

     |SI nSwAcum = 0;
         |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
               nCampo11 = nCampo33 - 2;
               nCampo22 = nCampo33 - 1;
               |SI #dsmod303#nCampo22# = 0;
                   #dsmod303#nCampo11# = #dsmociva#nCampo1#;
                   #dsmod303#nCampo22# = nIVA;
                   #dsmod303#nCampo33# = #dsmociva#nCampo3#;
                   nSwAcum = 1;
                   |SI nIVA ! #dsmociva#nCampo2#;
                       |SI nCampo22 = 7;   nIVA7  = 1;  |FINSI;
                       |SI nCampo22 = 10;  nIVA10 = 1;  |FINSI;
                       |SI nCampo22 = 13;  nIVA13 = 1;  |FINSI;
                       |SI nCampo22 = 16;  nIVA16 = 1;  |FINSI;
                       |SI nCampo22 = 19;  nIVA19 = 1;  |FINSI;
                       |SI nCampo22 = 22;  nIVA22 = 1;  |FINSI;
                       |SI nCampo22 = 25;  nIVA25 = 1;  |FINSI;
                       |SI nCampo22 = 28;  nIVA28 = 1;  |FINSI;
                       |SI nCampo22 = 31;  nIVA31 = 1;  |FINSI;
                   |FINSI;
                   |SAL;
               |FINSI;
         |SIGUE;
     |FINSI;

     |SI nSwAcum = 0;
         nCampo11     = nHasta - 2;
         nCampo22     = nHasta - 1;
         nCampo33     = nHasta;

         #dsmod303#nCampo11# = #dsmod303#nCampo11# + #dsmociva#nCampo1#;
         #dsmod303#nCampo22# = -1;
         #dsmod303#nCampo33# = #dsmod303#nCampo33# + #dsmociva#nCampo3#;
     |FINSI;
|FPRC;

|PROCESO GrabaDeducible303;
     |SI enEjer > 2010; |Y enSwProrr ! 2;
         |ABRE #dsmom087;
         #dsmom087#0 = #dsmociva#0;
         #dsmom087#1 = #dsmociva#1;
         #dsmom087#2 = #dsmociva#2;
         #dsmom087#3 = #dsmociva#3;
         #dsmom087#4 = #dsmociva#4;
         #dsmom087#5 = #dsmociva#5;
         #dsmom087#6 = #dsmociva#6;
         #dsmom087#7 = #dsmociva#7;
         |LEE 000#dsmom087.=;
         |SI FSalida = 0;
             #dsmociva#16 = #dsmom087#17 + #dsmom087#41;
             #dsmociva#19 = #dsmom087#20 + #dsmom087#43;
             #dsmociva#22 = #dsmom087#23 + #dsmom087#45;
             #dsmociva#25 = #dsmom087#26 + #dsmom087#47;
             #dsmociva#28 = #dsmom087#29 + #dsmom087#49;
             #dsmociva#31 = #dsmom087#32 + #dsmom087#51;
             #dsmociva#34 = #dsmom087#35 + #dsmom087#53;
        |FINSI;
        |CIERRA #dsmom087;
     |FINSI;

     |SI nDesde = 34; |Y nHasta = -2;   ||inversion
         nHasta = nDesde + 1;
         #dsmod303#nDesde# = #dsmod303#nDesde# - (#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32);
         #dsmod303#nHasta# = #dsmod303#nHasta# - (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34);
         |ACABA;
     |FINSI;

     |SI nHasta ! -1;
         nHasta = nDesde + 1;
     |FINSI;

     |SI nDesde ! 42;  |Y nDesde ! 44;
         |SI nHasta ! -1;
             #dsmod303#nDesde# = #dsmod303#nDesde# + ((#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32) % nProrrata) + nBaseMas;
             #dsmod303#nHasta# = #dsmod303#nHasta# + ((#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34) % nProrrata) + nCuotaMas;
         |SINO;
             #dsmod303#nDesde# = #dsmod303#nDesde# + ((#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34) % nProrrata) + nCuotaMas;
         |FINSI;
     |SINO;
         #dsmod303#nDesde# = #dsmod303#nDesde# + (#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32);
         #dsmod303#nHasta# = #dsmod303#nHasta# + (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34);
     |FINSI;
|FPRC;

|PROCESO Graba303;
     nDesde   = 0;
     nHasta   = 0;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 [ 4;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 6;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 7;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 8;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 14;  nDesde =  8;  nHasta = 14;  |FINSI;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 5;   nDesde = 26;  nHasta = 32;  |FINSI;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 10;  nDesde = 17;  nHasta = 23;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 11;  nDesde = 17;  nHasta = 23;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 12;  nDesde = 17;  nHasta = 23;  |FINSI;

     |SI nDesde ! 0;
         |PARA nCampo1 = 14;  |SI nCampo1 [ 32;  |HACIENDO nCampo1 = nCampo1 + 3;
               nCampo2 = nCampo1 + 1;
               nCampo3 = nCampo1 + 2;
               |SI #dsmociva#nCampo1# ! 0;  |O #dsmociva#nCampo2# ! 0;  |O #dsmociva#nCampo3# ! 0;
                   |HAZ GrabaDevengado303;
               |FINSI;
         |SIGUE;

         |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 6;
             |PARA nCampo1 = 35;  |SI nCampo1 [ 53;  |HACIENDO nCampo1 = nCampo1 + 3;
                   nCampo2 = nCampo1 + 1;
                   nCampo3 = nCampo1 + 2;
                   |SI #dsmociva#nCampo1# ! 0;  |O #dsmociva#nCampo2# ! 0;  |O #dsmociva#nCampo3# ! 0;
                       |HAZ GrabaDevengado303;
                   |FINSI;
             |SIGUE;
         |FINSI;
     |FINSI;

     |PARA nCampo1 = 7;  |SI nCampo1 [ 31;  |HACIENDO nCampo1 = nCampo1 + 3;
           |SI #dsmod303#nCampo1# = -1;  #dsmod303#nCampo1# = 0;  |FINSI;
     |SIGUE;

     nDesde = 0;
     nHasta = 0;

     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 1;   nDesde = 34;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 2;   nDesde = 36;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 3;   nDesde = 38;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 4;   nDesde = 40;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 5;   nDesde = 42;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 6;   nDesde = 44;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 7;   nDesde = 46;  nHasta = -1;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 9;   nDesde = 47;  nHasta = -1;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 11;  nDesde = 34;  nHasta = -2;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 10;  nDesde = 48;  nHasta = -1;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 13;  nDesde = 34;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 14;  nDesde = 34;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 15;  nDesde = 36;  |FINSI;

     |SI nDesde ! 0;
         |HAZ GrabaDeducible303;
     |FINSI;

     |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 9;
         #dsmod303#54 = #dsmod303#54 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 5;  |Y #dsmociva#7 = 1;
         #dsmod303#51   = #dsmod303#51 + #dsmociva#12;
         nContador = nContador + 1;
     |FINSI;

     |SI #dsmociva#6 = 5;  |Y #dsmociva#7 = 2;
         #dsmod303#57 = #dsmod303#57 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 10;
         #dsmod303#55 = #dsmod303#55 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#1 [ 2009;
         |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 11;
             #dsmod303#56 = #dsmod303#56 + #dsmociva#12;
         |FINSI;
     |SINO;
         |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 4;  || Tique 3923_ 242
             #dsmod303#56 = #dsmod303#56 + #dsmociva#12;
         |FINSI;
     |FINSI;
|FPRC;

|| ///////// Modelo 320 \\\\\\\\\\\\

|PROCESO GrabaDevengado320;
     |SI #dsmociva#nCampo3# = 0;  |ACABA;  |FINSI;
     nSwAcum       = 0;

     |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
           nCampo11 = nCampo33 - 2;
           nCampo22 = nCampo33 - 1;
           |SI #dsmod320#nCampo22# = #dsmociva#nCampo2#;
               #dsmod320#nCampo11# = #dsmod320#nCampo11# + #dsmociva#nCampo1#;
               #dsmod320#nCampo33# = #dsmod320#nCampo33# + #dsmociva#nCampo3#;
               nSwAcum = 1;
               |SAL;
            |FINSI;
     |SIGUE;

     |SI nSwAcum = 0;
         |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
               nCampo11 = nCampo33 - 2;
               nCampo22 = nCampo33 - 1;
               |SI #dsmod320#nCampo22# = 0;
                   #dsmod320#nCampo11# = #dsmociva#nCampo1#;
                   #dsmod320#nCampo22# = #dsmociva#nCampo2#;
                   #dsmod320#nCampo33# = #dsmociva#nCampo3#;
                   nSwAcum = 1;
                   |SAL;
               |FINSI;
         |SIGUE;
     |FINSI;

     |SI nSwAcum = 0;
         nCampo11     = nHasta - 2;
         nCampo22     = nHasta - 1;
         nCampo33     = nHasta;

         #dsmod320#nCampo11# = #dsmod320#nCampo11# + #dsmociva#nCampo1#;
         #dsmod320#nCampo22# = -1;
         #dsmod320#nCampo33# = #dsmod320#nCampo33# + #dsmociva#nCampo3#;
     |FINSI;
|FPRC;

|PROCESO GrabaDeducible320;
     |SI nDesde = 34; |Y nHasta = -2;   ||inversion
         nHasta = nDesde + 1;
         #dsmod320#nDesde# = #dsmod320#nDesde# - (#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32);
         #dsmod320#nHasta# = #dsmod320#nHasta# - (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34);
         |ACABA;
     |FINSI;

     |SI nHasta ! -1;
         nHasta = nDesde + 1;
     |FINSI;

     |SI nDesde ! 46;  |Y nDesde ! 48;
         |SI nHasta ! -1;
             #dsmod320#nDesde# = #dsmod320#nDesde# + ((#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32) % nProrrata) + nBaseMas;
             #dsmod320#nHasta# = #dsmod320#nHasta# + ((#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34) % nProrrata) + nCuotaMas;
         |SINO;
             #dsmod320#nDesde# = #dsmod320#nDesde# + ((#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34) % nProrrata) + nCuotaMas;
         |FINSI;
     |SINO;
         #dsmod320#nDesde# = #dsmod320#nDesde# + (#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32);
         #dsmod320#nHasta# = #dsmod320#nHasta# + (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34);
     |FINSI;
|FPRC;

|PROCESO Graba320;
     nDesde = 0;
     nHasta = 0;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 [ 4;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 6;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 7;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 8;   nDesde =  8;  nHasta = 14;  |FINSI;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 5;   nDesde = 26;  nHasta = 32;  |FINSI;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 10;  nDesde = 17;  nHasta = 23;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 11;  nDesde = 17;  nHasta = 23;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 12;  nDesde = 17;  nHasta = 23;  |FINSI;

     |SI nDesde ! 0;
         |PARA nCampo1 = 14;  |SI nCampo1 [ 23;  |HACIENDO nCampo1 = nCampo1 + 3;
               nCampo2 = nCampo1 + 1;
               nCampo3 = nCampo1 + 2;
               |SI #dsmociva#nCampo1# ! 0;  |O #dsmociva#nCampo2# ! 0;  |O #dsmociva#nCampo3# ! 0;
                   |HAZ GrabaDevengado320;
               |FINSI;
         |SIGUE;
     |FINSI;

     |PARA nCampo1 = 7;  |SI nCampo1 [ 31;  |HACIENDO nCampo1 = nCampo1 + 3;
           |SI #dsmod320#nCampo1# = -1;  #dsmod320#nCampo1# = 0;  |FINSI;
     |SIGUE;

     nDesde = 0;
     nHasta = 0;

     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 1;   nDesde = 34;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 2;   nDesde = 36;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 3;   nDesde = 40;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 4;   nDesde = 42;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 5;   nDesde = 46;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 6;   nDesde = 48;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 7;   nDesde = 52;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 9;   nDesde = 54;  nHasta = -1;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 11;  nDesde = 34;  nHasta = -2;  |FINSI;

     |SI nDesde ! 0;
         |HAZ GrabaDeducible320;
     |FINSI;

     |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 9;
         #dsmod320#60 = #dsmod320#60 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 10;
         #dsmod320#61 = #dsmod320#61 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 11;
         #dsmod320#62 = #dsmod320#62 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 5;  |Y #dsmociva#7 = 1;
         #dsmod320#57   = #dsmod320#57 + #dsmociva#12;
         nContador = nContador + 1;
     |FINSI;

     |SI #dsmociva#6 = 5;  |Y #dsmociva#7 = 2;
         #dsmod320#63   = #dsmod320#63 + #dsmociva#12;
     |FINSI;
|FPRC;

|| ///////// Modelo 330 \\\\\\\\\\\\

|PROCESO GrabaDevengado330;
     |SI #dsmociva#nCampo3# = 0;  |ACABA;  |FINSI;
     nSwAcum       = 0;

     |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
           nCampo11 = nCampo33 - 2;
           nCampo22 = nCampo33 - 1;
           |SI #dsmod330#nCampo22# = #dsmociva#nCampo2#;
               #dsmod330#nCampo11# = #dsmod330#nCampo11# + #dsmociva#nCampo1#;
               #dsmod330#nCampo33# = #dsmod330#nCampo33# + #dsmociva#nCampo3#;
               nSwAcum = 1;
               |SAL;
            |FINSI;
     |SIGUE;

     |SI nSwAcum = 0;
         |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
               nCampo11 = nCampo33 - 2;
               nCampo22 = nCampo33 - 1;
               |SI #dsmod330#nCampo22# = 0;
                   #dsmod330#nCampo11# = #dsmociva#nCampo1#;
                   #dsmod330#nCampo22# = #dsmociva#nCampo2#;
                   #dsmod330#nCampo33# = #dsmociva#nCampo3#;
                   nSwAcum = 1;
                   |SAL;
               |FINSI;
         |SIGUE;
     |FINSI;

     |SI nSwAcum = 0;
         nCampo11     = nHasta - 2;
         nCampo22     = nHasta - 1;
         nCampo33     = nHasta;

         #dsmod330#nCampo11# = #dsmod330#nCampo11# + #dsmociva#nCampo1#;
         #dsmod330#nCampo22# = -1;
         #dsmod330#nCampo33# = #dsmod330#nCampo33# + #dsmociva#nCampo3#;
     |FINSI;
|FPRC;

|PROCESO GrabaDeducible330;
     |SI nDesde = 34; |Y nHasta = -2;   ||inversion
         nHasta = nDesde + 1;
         #dsmod330#nDesde# = #dsmod330#nDesde# - (#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32);
         #dsmod330#nHasta# = #dsmod330#nHasta# - (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34);
         |ACABA;
     |FINSI;

     |SI nHasta ! -1;
         nHasta = nDesde + 1;
     |FINSI;

     |SI nDesde ! 46;  |Y nDesde ! 48;
         |SI nHasta ! -1;
             #dsmod330#nDesde# = #dsmod330#nDesde# + ((#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32) % nProrrata) + nBaseMas;
             #dsmod330#nHasta# = #dsmod330#nHasta# + ((#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34) % nProrrata) + nCuotaMas;
         |SINO;
             #dsmod330#nDesde# = #dsmod330#nDesde# + ((#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34) % nProrrata) + nCuotaMas;
         |FINSI;
     |SINO;
         #dsmod330#nDesde# = #dsmod330#nDesde# + (#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32);
         #dsmod330#nHasta# = #dsmod330#nHasta# + (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34);
     |FINSI;
|FPRC;

|PROCESO Graba330;
     nDesde = 0;
     nHasta = 0;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 [ 4;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 6;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 7;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 8;   nDesde =  8;  nHasta = 14;  |FINSI;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 5;   nDesde = 26;  nHasta = 32;  |FINSI;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 10;  nDesde = 17;  nHasta = 23;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 11;  nDesde = 17;  nHasta = 23;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 12;  nDesde = 17;  nHasta = 23;  |FINSI;

     |SI nDesde ! 0;
         |PARA nCampo1 = 14;  |SI nCampo1 [ 23;  |HACIENDO nCampo1 = nCampo1 + 3;
               nCampo2 = nCampo1 + 1;
               nCampo3 = nCampo1 + 2;
               |SI #dsmociva#nCampo1# ! 0;  |O #dsmociva#nCampo2# ! 0;  |O #dsmociva#nCampo3# ! 0;
                   |HAZ GrabaDevengado330;
               |FINSI;
         |SIGUE;
     |FINSI;

     |PARA nCampo1 = 7;  |SI nCampo1 [ 31;  |HACIENDO nCampo1 = nCampo1 + 3;
           |SI #dsmod330#nCampo1# = -1;  #dsmod330#nCampo1# = 0;  |FINSI;
     |SIGUE;

     nDesde = 0;
     nHasta = 0;

     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 1;   nDesde = 34;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 2;   nDesde = 36;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 3;   nDesde = 40;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 4;   nDesde = 42;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 5;   nDesde = 46;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 6;   nDesde = 48;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 7;   nDesde = 52;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 9;   nDesde = 54;  nHasta = -1;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 11;  nDesde = 34;  nHasta = -2;  |FINSI;

     |SI nDesde ! 0;
         |HAZ GrabaDeducible330;
     |FINSI;

     |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 9;
         #dsmod330#60 = #dsmod330#60 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 10;
         #dsmod330#61 = #dsmod330#61 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 11;
         #dsmod330#62 = #dsmod330#62 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 4;  |Y #dsmociva#7 = 6;
         #dsmod330#62 = #dsmod330#62 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 4;  |Y #dsmociva#7 = 5;
         #dsmod330#63 = #dsmod330#63 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 5;  |Y #dsmociva#7 = 1;
         #dsmod330#57   = #dsmod330#57 + #dsmociva#12;
         nContador = nContador + 1;
     |FINSI;

     |SI #dsmociva#6 = 5;  |Y #dsmociva#7 = 2;
         #dsmod330#65   = #dsmod330#65 + #dsmociva#12;
     |FINSI;
|FPRC;

|| ///////// Modelo 332 \\\\\\\\\\\\

|PROCESO GrabaDevengado332;
     |SI #dsmociva#nCampo3# = 0;  |ACABA;  |FINSI;
     nSwAcum       = 0;

     |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
           nCampo11 = nCampo33 - 2;
           nCampo22 = nCampo33 - 1;
           |SI #dsmod332#nCampo22# = #dsmociva#nCampo2#;
               #dsmod332#nCampo11# = #dsmod332#nCampo11# + #dsmociva#nCampo1#;
               #dsmod332#nCampo33# = #dsmod332#nCampo33# + #dsmociva#nCampo3#;
               nSwAcum = 1;
               |SAL;
            |FINSI;
     |SIGUE;

     |SI nSwAcum = 0;
         |PARA nCampo33 = nDesde;  |SI nCampo33 [ nHasta;  |HACIENDO nCampo33 = nCampo33 + 3;
               nCampo11 = nCampo33 - 2;
               nCampo22 = nCampo33 - 1;
               |SI #dsmod332#nCampo22# = 0;
                   #dsmod332#nCampo11# = #dsmociva#nCampo1#;
                   #dsmod332#nCampo22# = #dsmociva#nCampo2#;
                   #dsmod332#nCampo33# = #dsmociva#nCampo3#;
                   nSwAcum = 1;
                   |SAL;
               |FINSI;
         |SIGUE;
     |FINSI;

     |SI nSwAcum = 0;
         nCampo11     = nHasta - 2;
         nCampo22     = nHasta - 1;
         nCampo33     = nHasta;

         #dsmod332#nCampo11# = #dsmod332#nCampo11# + #dsmociva#nCampo1#;
         #dsmod332#nCampo22# = -1;
         #dsmod332#nCampo33# = #dsmod332#nCampo33# + #dsmociva#nCampo3#;
     |FINSI;
|FPRC;

|PROCESO GrabaDeducible332;
     |SI nDesde = 34; |Y nHasta = -2;   ||inversion
         nHasta = nDesde + 1;
         #dsmod332#nDesde# = #dsmod332#nDesde# - (#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32);
         #dsmod332#nHasta# = #dsmod332#nHasta# - (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34);
         |ACABA;
     |FINSI;

     |SI nHasta ! -1;
         nHasta = nDesde + 1;
     |FINSI;

     |SI nDesde ! 46;  |Y nDesde ! 48;
         |SI nHasta ! -1;
             #dsmod332#nDesde# = #dsmod332#nDesde# + ((#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32) % nProrrata) + nBaseMas;
             #dsmod332#nHasta# = #dsmod332#nHasta# + ((#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34) % nProrrata) + nCuotaMas;
         |SINO;
             #dsmod332#nDesde# = #dsmod332#nDesde# + ((#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34) % nProrrata) + nCuotaMas;
         |FINSI;
     |SINO;
         #dsmod332#nDesde# = #dsmod332#nDesde# + (#dsmociva#14 + #dsmociva#17 + #dsmociva#20 + #dsmociva#23 + #dsmociva#26 + #dsmociva#29 + #dsmociva#32);
         #dsmod332#nHasta# = #dsmod332#nHasta# + (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34);
     |FINSI;
|FPRC;

|PROCESO Graba332;
     nDesde = 0;
     nHasta = 0;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 [ 4;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 6;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 7;   nDesde =  8;  nHasta = 14;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 8;   nDesde =  8;  nHasta = 14;  |FINSI;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 5;   nDesde = 26;  nHasta = 32;  |FINSI;

     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 10;  nDesde = 17;  nHasta = 23;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 11;  nDesde = 17;  nHasta = 23;  |FINSI;
     |SI #dsmociva#6 = 1;  |Y #dsmociva#7 = 12;  nDesde = 17;  nHasta = 23;  |FINSI;

     |SI nDesde ! 0;
         |PARA nCampo1 = 14;  |SI nCampo1 [ 23;  |HACIENDO nCampo1 = nCampo1 + 3;
               nCampo2 = nCampo1 + 1;
               nCampo3 = nCampo1 + 2;
               |SI #dsmociva#nCampo1# ! 0;  |O #dsmociva#nCampo2# ! 0;  |O #dsmociva#nCampo3# ! 0;
                   |HAZ GrabaDevengado332;
               |FINSI;
         |SIGUE;
     |FINSI;

     |PARA nCampo1 = 7;  |SI nCampo1 [ 31;  |HACIENDO nCampo1 = nCampo1 + 3;
           |SI #dsmod332#nCampo1# = -1;  #dsmod332#nCampo1# = 0;  |FINSI;
     |SIGUE;

     nDesde = 0;
     nHasta = 0;

     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 1;   nDesde = 34;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 2;   nDesde = 36;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 3;   nDesde = 40;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 4;   nDesde = 42;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 5;   nDesde = 46;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 6;   nDesde = 48;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 7;   nDesde = 52;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 9;   nDesde = 54;  nHasta = -1;  |FINSI;
     |SI #dsmociva#6 = 2;  |Y #dsmociva#7 = 11;  nDesde = 34;  nHasta = -2;  |FINSI;

     |SI nDesde ! 0;
         |HAZ GrabaDeducible332;
     |FINSI;

     |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 9;
         #dsmod332#60 = #dsmod332#60 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 10;
         #dsmod332#61 = #dsmod332#61 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 3;  |Y #dsmociva#7 = 11;
         #dsmod332#62 = #dsmod332#62 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 4;  |Y #dsmociva#7 = 6;
         #dsmod332#62 = #dsmod332#62 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 4;  |Y #dsmociva#7 = 5;
         #dsmod332#63 = #dsmod332#63 + #dsmociva#12;
     |FINSI;

     |SI #dsmociva#6 = 5;  |Y #dsmociva#7 = 1;
         #dsmod332#57   = #dsmod332#57 + #dsmociva#12;
         nContador = nContador + 1;
     |FINSI;

     |SI #dsmociva#6 = 5;  |Y #dsmociva#7 = 2;
         #dsmod332#65   = #dsmod332#65 + #dsmociva#12;
     |FINSI;
|FPRC;

|PROCESO LeeRestoPror;
     |ABRE #dsmocivp;
     #dsmocivp#0 = #dsmociva#0;
     #dsmocivp#1 = #dsmociva#1;
     #dsmocivp#2 = #dsmociva#2;
     #dsmocivp#3 = #dsmociva#3;
     #dsmocivp#4 = #dsmociva#4;
     #dsmocivp#5 = #dsmociva#5;
     #dsmocivp#6 = #dsmociva#6;
     #dsmocivp#7 = #dsmociva#7;
     |LEE 001#dsmocivp.=;
     |SI FSalida = 0;
         nBaseMas  = #dsmocivp#10 + #dsmocivp#13 + #dsmocivp#16 + #dsmocivp#19;
         nCuotaMas = #dsmocivp#12 + #dsmocivp#15 + #dsmocivp#18 + #dsmocivp#21;
     |FINSI;
     |CIERRA #dsmocivp;
|FPRC;

|PROCESO GrabaModelo;
     |SI #dsmociva#6 = 5;  |Y #dsmociva#7 = 6;  |Y #dsmociva#12 ! 0;
         nEjerAnt = #dsmociva#12;
     |FINSI;

     enImpIvaSop = 0;
     enImpIvaSub = 0;
     enIvaSopDed = 0;

     nBaseMas  = 0;
     nCuotaMas = 0;

     |SI #dsmociva#6 = 2;
         |SI #dsmociva#7 ! 5; |Y #dsmociva#7 ! 6;
             |HAZ LeeRestoPror;

             |SI #dsmociva#1 [ 2007;
                 |SI #dsmociva#7 ! 10; |Y #dsmociva#7 ! 11; |Y #dsmociva#7 ! 12;
                     enIvaSopDed = (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34) % nProrrata + nCuotaMas;
                 |FINSI;

                 |SI #dsmociva#7 = 10;
                    enImpIvaSop = #dsmociva#13 + nCuotaMas;
                 |FINSI;

                 |SI #dsmociva#7 = 11;
                     enImpIvaSub = #dsmociva#13;
                     enIvaSopDed = - (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34);
                 |FINSI;
             |FINSI;

             |SI #dsmociva#1 ] 2008;
                 |SI #dsmociva#7 ! 11; |Y #dsmociva#7 ! 12;
                     enIvaSopDed = (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34) % nProrrata + nCuotaMas;
                     enImpIvaSop = #dsmociva#13 + nCuotaMas;
                 |FINSI;

                 |SI #dsmociva#7 = 11;
                     enImpIvaSub = #dsmociva#13;
                     enIvaSopDed = - (#dsmociva#16 + #dsmociva#19 + #dsmociva#22 + #dsmociva#25 + #dsmociva#28 + #dsmociva#31 + #dsmociva#34);
                 |FINSI;
             |FINSI;
         |FINSI;

         |SI #dsmociva#7 = 12; |ACABA; |FINSI;
     |FINSI;

     |SI #dsmociva#12 = 0;  |Y #dsmociva#13 = 0;  |Y nCuotaMas = 0; |ACABA;  |FINSI;

     |SI enModelo = 300;   |HAZ Graba300;   |FINSI;
     |SI enModelo = 303;   |HAZ Graba303;   |FINSI;
     |SI enModelo = 320;   |HAZ Graba320;   |FINSI;
     |SI enModelo = 330;   |HAZ Graba330;   |FINSI;
     |SI enModelo = 332;   |HAZ Graba332;   |FINSI;

     nSwGraba = 1;
     |SI enImpIvaSop ! 0; |O enImpIvaSub ! 0; |O enIvaSopDed ! 0; |O swpase = 0;
         |SI enEjer < enEjerPro; |HAZ Grabarm029; |FINSI;
         swpase = 1;
     |FINSI;
|FPRC;

|DEFBUCLE dsmociva;
     #dsmociva#1;
     ;
     enEmpresa, enEjer, enPeriodo, enModelo, enComplem, 01, 0,  0;
     enEmpresa, enEjer, enPeriodo, enModelo, enComplem, 99, 9, 99;
     be;
     NULL, GrabaModelo;
|FIN;

|PROCESO dsmod300Otros;
     #dsmod300#70 = #dsmod300#70 + #dsmodiva@#65;
|FPRC;

|DEFBUCLE dsmod300Otros;
     #dsmodiva@#1006;
     ;
     #dsmod300#0, #dsmod300#1, #dsmod300#2, #dsmod300#3,        0, #dsmod300#5;
     #dsmod300#0, #dsmod300#1, #dsmod300#2, #dsmod300#3, nHComple, #dsmod300#5;
     ;
     NULL, dsmod300Otros;
|FIN;

|PROCESO CapturaOtros300;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/dsmod300.mas";
     |CARGA_DEF aMas, dsmodiva@;

     nHComple = #dsmod300#4 - 1;
     #dsmod300#70  = 0;

     |BUCLE dsmod300Otros;

     |DESCARGA_DEF #dsmodiva@;
|FPRC;

|PROCESO Totales300;
     #dsmod300#67 = eaProrrat;
     #dsmod300#66 = nPro;

     #dsmod300#33 = #dsmod300#8  + #dsmod300#11 + #dsmod300#14 + #dsmod300#17 + #dsmod300#20 + #dsmod300#23 + #dsmod300#26 + #dsmod300#29 + #dsmod300#32;

|| aplicar nueva Prorrata
     |SI enEjer ] enEjerPro;
          |SI eaDesg109 = "N";
              #dsmod300#35 = #dsmod300#35 - enImpProrrata;
          |SINO;
              #dsmod300#35 = #dsmod300#35 - enImpProrrat1;
              #dsmod300#37 = #dsmod300#37 - enImpProrrat2;
              #dsmod300#41 = #dsmod300#41 - enImpProrrat3;
              #dsmod300#43 = #dsmod300#43 - enImpProrrat4;
              #dsmod300#47 = #dsmod300#47 - enImpProrrat5;
              #dsmod300#49 = #dsmod300#49 - enImpProrrat6;
              #dsmod300#53 = #dsmod300#53 - enImpProrrat7;
          |FINSI;
     |FINSI;
|| ....
|| Regularizacion Manual
     #dsmod300#35 = #dsmod300#35 - #dsmom047#6;
     #dsmod300#37 = #dsmod300#37 - #dsmom047#7;
     #dsmod300#41 = #dsmod300#41 - #dsmom047#8;
     #dsmod300#43 = #dsmod300#43 - #dsmom047#9;
     #dsmod300#47 = #dsmod300#47 - #dsmom047#10;
     #dsmod300#49 = #dsmod300#49 - #dsmom047#11;
     #dsmod300#53 = #dsmod300#53 - #dsmom047#12;
|| ....

     #dsmod300#38 = #dsmod300#34 + #dsmod300#36;
     #dsmod300#39 = #dsmod300#35 + #dsmod300#37;
     #dsmod300#44 = #dsmod300#40 + #dsmod300#42;
     #dsmod300#45 = #dsmod300#41 + #dsmod300#43;
     #dsmod300#50 = #dsmod300#46 + #dsmod300#48;
     #dsmod300#51 = #dsmod300#47 + #dsmod300#49;
     #dsmod300#55 = #dsmod300#39 + #dsmod300#45 + #dsmod300#51 + #dsmod300#53 + #dsmod300#54 + #dsmod300#68;

     #dsmod300#57 = #dsmod300#57 / nContador;
     #dsmod300#56 = #dsmod300#33 - #dsmod300#55;
     #dsmod300#58 = #dsmod300#56 % #dsmod300#57;
     #dsmod300#62 = #dsmod300#58 - #dsmod300#59 + #dsmod300#61;

     |SI #dsmod300#1 ] 2008;
         #dsmod300#69 = #dsmod300#58 - #dsmod300#59 + #dsmod300#61;

         |SI #dsmod300#4 > 0;
             |HAZ CapturaOtros300;
             nEl62 = #dsmod300#69 - #dsmod300#70;
             |SI nEl62 < 0; |Y eMensa = 0;
                 |MENAV "    RECUERDE. Si el resultado NO es a INGRESAR, NO procede declaracion complementaria";
             |FINSI;
         |FINSI;

         #dsmod300#62 = #dsmod300#69 - #dsmod300#70;
     |FINSI;

     |SI #dsmod300#62 > 0;
         #dsmod300#65 = #dsmod300#62;
         #dsmod300#63 = 0;
         #dsmod300#64 = 0;
     |SINO;
         |SI #dsmod300#2 = 12;
             |HAZ UltimoPeriodo;
             |SI eaUltimoPer = "COMPENSAR";
                 #dsmod300#63 = -#dsmod300#62;
                 #dsmod300#64 = 0;
                 #dsmod300#65 = 0;
             |SINO;
                 #dsmod300#64 = -#dsmod300#62;
                 #dsmod300#63 = 0;
                 #dsmod300#65 = 0;
             |FINSI;
         |SINO;
             #dsmod300#63 = -#dsmod300#62;
             #dsmod300#64 = 0;
             #dsmod300#65 = 0;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Modelo300;
     |ABRE #dsmod300;

     #dsmod300#0 = enEmpresa;
     #dsmod300#1 = enEjer;
     #dsmod300#2 = enPeriodo;
     #dsmod300#3 = enModelo;
     #dsmod300#4 = enComplem;
     #dsmod300#5 = 0;
     |LEE 101#dsmod300.=;
     |SI FSalida ! 0;
         |HAZ RecogeAnter;
         |DDEFECTO #dsmod300;
         #dsmod300#0 = enEmpresa;
         #dsmod300#1 = enEjer;
         #dsmod300#2 = enPeriodo;
         #dsmod300#3 = enModelo;
         #dsmod300#4 = enComplem;
         #dsmod300#5 = 0;

         #dsmod300#59 = nEjerAnt;
         #dsmod300#57 = 0;
         |GRABA 020#dsmod300.b;
     |FINSI;

     nEjerAnt  = #dsmod300#59;
     nContador = 0;
     nSwGraba  = 0;

     |BUCLE dsmociva;

     |SI nSwGraba = 1;
         #dsmod300#59 = nEjerAnt;
         |HAZ Totales300;
         enIvaSopDed = #dsmod300#55;
         |GRABA 020#dsmod300.a;
     |SINO;
         #dsmod300#55 = 0;
         |BORRA 020#dsmod300.a;
     |FINSI;

     |LIBERA #dsmod300;
     |CIERRA #dsmod300;
|FPRC;

|| __________________________________________________________________________

|PROCESO dsmod303Otros;

||     #dsmod303#59    = #dsmodiva@#63;
     #dsmod303#59    = #dsmod303#59 + #dsmodiva@#63;
     nTotal303  = #dsmodiva@#58;

     nNegativoC = #dsmodiva@#61;
     nNegativoD = #dsmodiva@#62;

||     nNegativoC = nNegativoC + #dsmodiva@#61;
||     nNegativoD = nNegativoD + #dsmodiva@#62;
|FPRC;

|DEFBUCLE dsmod303Otros;
     #dsmodiva@#1006;
     ;
     #dsmod303#0, #dsmod303#1, #dsmod303#2, #dsmod303#3,        0, #dsmod303#5;
     #dsmod303#0, #dsmod303#1, #dsmod303#2, #dsmod303#3, nHComple, #dsmod303#5;
     ;
     NULL, dsmod303Otros;
|FIN;

|PROCESO CapturaOtros303;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/dsmod303.mas";
     |CARGA_DEF aMas, dsmodiva@;

     nHComple = #dsmod303#4 - 1;
     #dsmod303#59    = 0;
     nTotal303  = 0;
     nNegativoD = 0;
     nNegativoC = 0;

     |BUCLE dsmod303Otros;

     |SI nNegativoC ! 0;  |O nNegativoD ! 0;
         nNegativo  = (nNegativoC + nNegativoD) * -1;

         |SI nNegativoC ! 0;
             |SI eMensa = 0;
                 |MENAV "0000Declaracion anterior a compensar. ";
                 |CONFI "0000NHa compensado el importe en una declaracion posterior";
             |SINO;
                 FSalida = -1;
             |FINSI;
         |SINO;
             |SI eMensa = 0;
                 |MENAV "0000Declaracion anterior a devolver.";
                 |CONFI "0000NHa recibido la devolucion";
             |SINO;
                  FSalida = -1;
             |FINSI;
         |FINSI;

         |SI FSalida = 0;
            #dsmod303#59 = #dsmod303#59 + nNegativo;
         |FINSI;
     |FINSI;

     |DESCARGA_DEF #dsmodiva@;
|FPRC;

|PROCESO Totales303;
     #dsmod303#65 = eaProrrat;
     #dsmod303#64 = nPro;

     #dsmod303#33 = #dsmod303#8  + #dsmod303#11 + #dsmod303#14 + #dsmod303#17 + #dsmod303#20 + #dsmod303#23
     #dsmod303#33 = #dsmod303#33 + #dsmod303#26 + #dsmod303#29 + #dsmod303#32;

|| aplicar nueva Prorrata
     |SI enEjer ] enEjerPro;
          |SI eaDesg109 = "N";
              #dsmod303#35 = #dsmod303#35 - enImpProrrata;
          |SINO;
              #dsmod303#35 = #dsmod303#35 - enImpProrrat1;
              #dsmod303#37 = #dsmod303#37 - enImpProrrat2;
              #dsmod303#39 = #dsmod303#39 - enImpProrrat3;
              #dsmod303#41 = #dsmod303#41 - enImpProrrat4;
              #dsmod303#43 = #dsmod303#43 - enImpProrrat5;
              #dsmod303#45 = #dsmod303#45 - enImpProrrat6;
              #dsmod303#46 = #dsmod303#46 - enImpProrrat7;
          |FINSI;
          |SI enEjer ] 2009; |Y enPeriodo = 12;
              #dsmod303#48 = #dsmod303#48 + enImpProrrat36;
          |FINSI;
     |FINSI;

|| ....
|| Regularizacion Manual
     #dsmod303#35 = #dsmod303#35 - #dsmom047#6;
     #dsmod303#37 = #dsmod303#37 - #dsmom047#7;
     #dsmod303#39 = #dsmod303#39 - #dsmom047#8;
     #dsmod303#41 = #dsmod303#41 - #dsmom047#9;
     #dsmod303#43 = #dsmod303#43 - #dsmom047#10;
     #dsmod303#45 = #dsmod303#45 - #dsmom047#11;
     #dsmod303#46 = #dsmod303#46 - #dsmom047#12;
|| ....

     #dsmod303#49 = #dsmod303#35 + #dsmod303#37 + #dsmod303#39 + #dsmod303#41 + #dsmod303#43 + #dsmod303#45;
     #dsmod303#49 = #dsmod303#49 + #dsmod303#46 + #dsmod303#47 + #dsmod303#48;

     #dsmod303#50 = #dsmod303#33 - #dsmod303#49;
     #dsmod303#51 = #dsmod303#51 / nContador;
     #dsmod303#52 = #dsmod303#50 % #dsmod303#51;

     #dsmod303#58 = #dsmod303#52 - #dsmod303#53 + #dsmod303#57;

     |SI #dsmod303#4 > 0;
         |HAZ CapturaOtros303;
         nEl62 = #dsmod303#58; || - #dsmod303#59;

         |SI nEl62 < nTotal303; |Y eMensa = 0;
             |MENAV "0000RECUERDE. Si el resultado es inferior a la declaracion anterior, NO procede complementaria";
         |FINSI;
     |FINSI;

     #dsmod303#60 = #dsmod303#58 - #dsmod303#59;

     |SI #dsmod303#60 > 0;
         #dsmod303#63 = #dsmod303#60;
         #dsmod303#61 = 0;
         #dsmod303#62 = 0;
     |SINO;
         |ABRE #dsmom004;
         #dsmom004#0 = enEmpresa;
         #dsmom004#1 = enEjer;
         #dsmom004#2 = enPeriodo;
         #dsmom004#3 = enModelo;
         #dsmom004#4 = enComplem;
         |LEE 040#dsmom004.=;
         |SI FSalida ! 0;  |DDEFECTO #dsmom004;  |FINSI;
         |CIERRA #dsmom004;

         |SI #dsmom004#23 = "S";
              |HAZ UltimoPeriodo;
              |SI eaUltimoPer = "COMPENSAR";
                  #dsmod303#61 = -#dsmod303#60;
                  #dsmod303#62 = 0;
                  #dsmod303#63 = 0;
              |SINO;
                  #dsmod303#62 = -#dsmod303#60;
                  #dsmod303#61 = 0;
                  #dsmod303#63 = 0;
              |FINSI;
         |FINSI;

         |SI #dsmom004#23 = "N";
             |SI #dsmod303#2 = 12;
                 |HAZ UltimoPeriodo;
                 |SI eaUltimoPer = "COMPENSAR";
                      #dsmod303#61 = -#dsmod303#60;
                      #dsmod303#62 = 0;
                      #dsmod303#63 = 0;
                 |SINO;
                      #dsmod303#62 = -#dsmod303#60;
                      #dsmod303#61 = 0;
                      #dsmod303#63 = 0;
                 |FINSI;
             |SINO;
                 #dsmod303#61 = -#dsmod303#60;
                 #dsmod303#62 = 0;
                 #dsmod303#63 = 0;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Modelo303;
     |ABRE #dsmod303;

     #dsmod303#0 = enEmpresa;
     #dsmod303#1 = enEjer;
     #dsmod303#2 = enPeriodo;
     #dsmod303#3 = enModelo;
     #dsmod303#4 = enComplem;
     #dsmod303#5 = 0;
     |LEE 101#dsmod303.=;
     |SI FSalida ! 0;
         |HAZ RecogeAnter;
         |DDEFECTO #dsmod303;
         #dsmod303#0 = enEmpresa;
         #dsmod303#1 = enEjer;
         #dsmod303#2 = enPeriodo;
         #dsmod303#3 = enModelo;
         #dsmod303#4 = enComplem;
         #dsmod303#5 = 0;

         #dsmod303#53 = nEjerAnt;
         #dsmod303#51 = 0;
         |GRABA 020#dsmod303.b;
     |FINSI;

     nEjerAnt  = #dsmod303#53;
     nContador = 0;
     nSwGraba  = 0;
     nIVA7     = 0;
     nIVA10    = 0;
     nIVA13    = 0;
     nIVA16    = 0;
     nIVA19    = 0;
     nIVA22    = 0;
     nIVA25    = 0;
     nIVA28    = 0;
     nIVA31    = 0;
     nSubeIVA  = 0;

     |SI #dsmod303#1 = 2010; |Y #dsmod303#2 ] 7;
         nSubeIVA = 1;
     |FINSI;

     |SI #dsmod303#1 ] 2011;
         nSubeIVA = 1;
     |FINSI;

     |SI #dsmod303#1 = 2012; |Y #dsmod303#2 ] 9;
         nSubeIVA = 2;
     |FINSI;

     |SI #dsmod303#1 ] 2013;
         nSubeIVA = 2;
     |FINSI;

     |BUCLE dsmociva;

     |SI nSwGraba = 1;
         |SI nIVA7  = 1;
             nNume1  = #dsmod303#7;
             #dsmod303#7  = (#dsmod303#8  / #dsmod303#6)  * 100;
             |SI #dsmod303#7 [ 0; #dsmod303#7 = nNume1; |FINSI;
         |FINSI;

         |SI nIVA10 = 1;
             nNume1  = #dsmod303#10;
             #dsmod303#10 = (#dsmod303#11 / #dsmod303#9)  * 100;
             |SI #dsmod303#10 [ 0; #dsmod303#10 = nNume1; |FINSI;
         |FINSI;

         |SI nIVA13 = 1;
             nNume1  = #dsmod303#13;
             #dsmod303#13 = (#dsmod303#14 / #dsmod303#12) * 100;
             |SI #dsmod303#13 [ 0; #dsmod303#13 = nNume1; |FINSI;
         |FINSI;

         |SI nIVA16 = 1;
             nNume1  = #dsmod303#16;
             #dsmod303#16 = (#dsmod303#17 / #dsmod303#15) * 100;
             |SI #dsmod303#16 [ 0; #dsmod303#16 = nNume1; |FINSI;
         |FINSI;

         |SI nIVA19 = 1;
             nNume1  = #dsmod303#19;
             #dsmod303#19 = (#dsmod303#20 / #dsmod303#18) * 100;
             |SI #dsmod303#19 [ 0; #dsmod303#19 = nNume1; |FINSI;
         |FINSI;

         |SI nIVA22 = 1;
             nNume1  = #dsmod303#22;
             #dsmod303#22 = (#dsmod303#23 / #dsmod303#21) * 100;
             |SI #dsmod303#22 [ 0; #dsmod303#22 = nNume1; |FINSI;
         |FINSI;

         |SI nIVA25 = 1;
             nNume1  = #dsmod303#25;
             #dsmod303#25 = (#dsmod303#26 / #dsmod303#24) * 100;
             |SI #dsmod303#25 [ 0; #dsmod303#25 = nNume1; |FINSI;
         |FINSI;

         |SI nIVA28 = 1;
             nNume1  = #dsmod303#28;
             #dsmod303#28 = (#dsmod303#29 / #dsmod303#27) * 100;
             |SI #dsmod303#28 [ 0; #dsmod303#28 = nNume1; |FINSI;
         |FINSI;

         |SI nIVA31 = 1;
             nNume1  = #dsmod303#31;
             #dsmod303#31 = (#dsmod303#32 / #dsmod303#20) * 100;
             |SI #dsmod303#31 [ 0; #dsmod303#31 = nNume1; |FINSI;
         |FINSI;

         #dsmod303#53 = nEjerAnt;
         |HAZ Totales303;
         enIvaSopDed = #dsmod303#49;
         |GRABA 020#dsmod303.a;
     |SINO;
         #dsmod303#49 = 0;
         |BORRA 020#dsmod303.a;
     |FINSI;

     |LIBERA #dsmod303;
     |CIERRA #dsmod303;
|FPRC;

|| __________________________________________________________________________

|PROCESO Totales320;
     #dsmod320#68 = nPro;
     #dsmod320#69 = eaProrrat;

     #dsmod320#33 = #dsmod320#8  + #dsmod320#11 + #dsmod320#14 + #dsmod320#17 + #dsmod320#20 + #dsmod320#23 + #dsmod320#26 + #dsmod320#29 + #dsmod320#32;

     |SI enEjer ] enEjerPro;
          |SI eaDesg109 = "N";
              #dsmod320#35 = #dsmod320#35 - enImpProrrata;
          |SINO;
              #dsmod320#35 = #dsmod320#35 - enImpProrrat1;
              #dsmod320#37 = #dsmod320#37 - enImpProrrat2;
              #dsmod320#41 = #dsmod320#41 - enImpProrrat3;
              #dsmod320#43 = #dsmod320#43 - enImpProrrat4;
              #dsmod320#47 = #dsmod320#47 - enImpProrrat5;
              #dsmod320#49 = #dsmod320#49 - enImpProrrat6;
              #dsmod320#53 = #dsmod320#53 - enImpProrrat7;
          |FINSI;
     |FINSI;

|| Regularizacion Manual
     #dsmod320#35 = #dsmod320#35 - #dsmom047#6;
     #dsmod320#37 = #dsmod320#37 - #dsmom047#7;
     #dsmod320#41 = #dsmod320#41 - #dsmom047#8;
     #dsmod320#43 = #dsmod320#43 - #dsmom047#9;
     #dsmod320#47 = #dsmod320#47 - #dsmom047#10;
     #dsmod320#49 = #dsmod320#49 - #dsmom047#11;
     #dsmod320#53 = #dsmod320#53 - #dsmom047#12;
|| ....
     #dsmod320#38 = #dsmod320#34 + #dsmod320#36;
     #dsmod320#39 = #dsmod320#35 + #dsmod320#37;
     #dsmod320#44 = #dsmod320#40 + #dsmod320#42;
     #dsmod320#45 = #dsmod320#41 + #dsmod320#43;
     #dsmod320#50 = #dsmod320#46 + #dsmod320#48;
     #dsmod320#51 = #dsmod320#47 + #dsmod320#49;
     #dsmod320#55 = #dsmod320#39 + #dsmod320#45 + #dsmod320#51 + #dsmod320#53 + #dsmod320#54;

     #dsmod320#56 = #dsmod320#33 - #dsmod320#55;
     #dsmod320#57 = #dsmod320#57 / nContador;
     #dsmod320#58 = #dsmod320#56 % #dsmod320#57;
     #dsmod320#64 = #dsmod320#58 - #dsmod320#59 + #dsmod320#63;

     |SI #dsmod320#64 > 0;
         #dsmod320#67 = #dsmod320#64;
         #dsmod320#65 = 0;
         #dsmod320#66 = 0;
     |SINO;
         |SI #dsmod320#2 = 12;
             |HAZ UltimoPeriodo;
             |SI eaUltimoPer = "COMPENSAR";
                 #dsmod320#65 = -#dsmod320#64;
                 #dsmod320#66 = 0;
                 #dsmod320#67 = 0;
             |SINO;
                 #dsmod320#66 = -#dsmod320#64;
                 #dsmod320#65 = 0;
                 #dsmod320#67 = 0;
             |FINSI;
         |SINO;
             #dsmod320#65 = -#dsmod320#64;
             #dsmod320#66 = 0;
             #dsmod320#67 = 0;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Modelo320;
     |ABRE #dsmod320;

     #dsmod320#0 = enEmpresa;
     #dsmod320#1 = enEjer;
     #dsmod320#2 = enPeriodo;
     #dsmod320#3 = enModelo;
     #dsmod320#4 = enComplem;
     #dsmod320#5 = 0;
     |LEE 101#dsmod320.=;
     |SI FSalida ! 0;
         |HAZ RecogeAnter;

         |DDEFECTO #dsmod320;
         #dsmod320#0 = enEmpresa;
         #dsmod320#1 = enEjer;
         #dsmod320#2 = enPeriodo;
         #dsmod320#3 = enModelo;
         #dsmod320#4 = enComplem;
         #dsmod320#5 = 0;

         #dsmod320#57 = 0;
         #dsmod320#59 = nEjerAnt;

         |GRABA 020#dsmod320.b;
     |FINSI;

     nEjerAnt  = #dsmod320#59;
     nContador = 0;
     nSwGraba  = 0;
     |BUCLE dsmociva;

     |SI nSwGraba = 1;
         #dsmod320#59 = nEjerAnt;
         |HAZ Totales320;
         enIvaSopDed = #dsmod320#55;
         |GRABA 020#dsmod320.a;
     |SINO;
         |BORRA 020#dsmod320.a;
     |FINSI;

     |LIBERA #dsmod320;
     |CIERRA #dsmod320;
|FPRC;

|| __________________________________________________________________________

|PROCESO Totales330;
     #dsmod330#70 = nPro;
     #dsmod330#71 = eaProrrat;

     #dsmod330#33 = #dsmod330#8  + #dsmod330#11 + #dsmod330#14 + #dsmod330#17 + #dsmod330#20 + #dsmod330#23 + #dsmod330#26 + #dsmod330#29 + #dsmod330#32;

|| aplicar nueva Prorrata
     |SI enEjer ] enEjerPro;
          |SI eaDesg109 = "N";
              #dsmod330#35 = #dsmod330#35 - enImpProrrata;
          |SINO;
              #dsmod330#35 = #dsmod330#35 - enImpProrrat1;
              #dsmod330#37 = #dsmod330#37 - enImpProrrat2;
              #dsmod330#41 = #dsmod330#41 - enImpProrrat3;
              #dsmod330#43 = #dsmod330#43 - enImpProrrat4;
              #dsmod330#47 = #dsmod330#47 - enImpProrrat5;
              #dsmod330#49 = #dsmod330#49 - enImpProrrat6;
              #dsmod330#53 = #dsmod330#53 - enImpProrrat7;
          |FINSI;
     |FINSI;
|| ....
|| Regularizacion Manual
     #dsmod330#35 = #dsmod330#35 - #dsmom047#6;
     #dsmod330#37 = #dsmod330#37 - #dsmom047#7;
     #dsmod330#41 = #dsmod330#41 - #dsmom047#8;
     #dsmod330#43 = #dsmod330#43 - #dsmom047#9;
     #dsmod330#47 = #dsmod330#47 - #dsmom047#10;
     #dsmod330#49 = #dsmod330#49 - #dsmom047#11;
     #dsmod330#53 = #dsmod330#53 - #dsmom047#12;
|| ....

     #dsmod330#38 = #dsmod330#34 + #dsmod330#36;
     #dsmod330#39 = #dsmod330#35 + #dsmod330#37;
     #dsmod330#44 = #dsmod330#40 + #dsmod330#42;
     #dsmod330#45 = #dsmod330#41 + #dsmod330#43;
     #dsmod330#50 = #dsmod330#46 + #dsmod330#48;
     #dsmod330#51 = #dsmod330#47 + #dsmod330#49;
     #dsmod330#55 = #dsmod330#39 + #dsmod330#45 + #dsmod330#51 + #dsmod330#53 + #dsmod330#54;

     #dsmod330#56 = #dsmod330#33 - #dsmod330#55;
     #dsmod330#57 = #dsmod330#57 / nContador;
     #dsmod330#58 = #dsmod330#56 % #dsmod330#57;
     #dsmod330#66 = #dsmod330#58 - #dsmod330#59 + #dsmod330#65;

     |SI #dsmod330#66 > 0;
         #dsmod330#69 = #dsmod330#66;
         #dsmod330#64 = 0;
         #dsmod330#67 = 0;
         #dsmod330#68 = 0;
     |SINO;
         |SI #dsmod330#2 = 12;
             nResult = -#dsmod330#66;
             #dsmod330#64 = (#dsmod330#60 + #dsmod330#61 + #dsmod330#62 + #dsmod330#63) % 16;

             |HAZ UltimoPeriodo;
             |SI eaUltimoPer = "COMPENSAR";
                 #dsmod330#67 = -#dsmod330#66;
                 #dsmod330#68 = 0;
                 #dsmod330#69 = 0;
             |SINO;
                 #dsmod330#68 = -#dsmod330#66;
                 #dsmod330#67 = 0;
                 #dsmod330#69 = 0;
             |FINSI;

             |ACABA;
         |FINSI;

         nResult = -#dsmod330#66;
         #dsmod330#64 = (#dsmod330#60 + #dsmod330#61 + #dsmod330#62 + #dsmod330#63) % 16;
         |SI #dsmod330#64 < 0;         #dsmod330#64 = 0;         |FINSI;
         |SI #dsmod330#68 = 0;         #dsmod330#68 =  #dsmod330#64;  |FINSI;
         |SI #dsmod330#68 > #dsmod330#64;   #dsmod330#68 =  #dsmod330#64;  |FINSI;
         |SI #dsmod330#68 > nResult;   #dsmod330#68 =  nResult;  |FINSI;

         #dsmod330#67 = nResult - #dsmod330#68;

         |SI #dsmod330#64 = 0;  |ACABA;  |FINSI;

         |SI enPregunta = 1;
             #dsmod330#68 = enDevolver;
             #dsmod330#67 = nResult - #dsmod330#68;
             |ACABA;
         |FINSI;

         |PUSHV 0501 2380;
         |CUADRO 1220 1752;
         |BLANCO 1321 1651;

         |ATRI S;
         |PINTA 1321, "Resultado ........: ";
         |PINTA 1421, "Maximo a Devolver : ";
         |PINTA 1521, "A Devolver .......: ";
         |PINTA 1621, "A Compensar ......: ";
         |ATRI s;

         |PINTA 1341, #dsmod330#66;
         |PINTA 1441, #dsmod330#64;
         |PINTA 1541, #dsmod330#68;
         |PINTA 1641, #dsmod330#67;

         E_inf = "0.?EURO";
         E_sup = "99999999999";

         nCampo68 = #dsmod330#68;

         |ET Campo68_330;
             nCampo68 = 1541 ? 1;
             |SI nCampo68 > #dsmod330#64;
                 |MENAV "     Maximo a Devolver superado.";
                 nCampo68 = #dsmod330#64;
                 |VETE Campo68_330;
             |FINSI;

         #dsmod330#68 = nCampo68;
         #dsmod330#67 = nResult - #dsmod330#68;
         |PINTA 1641, #dsmod330#67;

         |POPV;
     |FINSI;
|FPRC;

|PROCESO Modelo330;
     |ABRE #dsmod330;

     #dsmod330#0 = enEmpresa;
     #dsmod330#1 = enEjer;
     #dsmod330#2 = enPeriodo;
     #dsmod330#3 = enModelo;
     #dsmod330#4 = enComplem;
     #dsmod330#5 = 0;
     |LEE 101#dsmod330.=;
     |SI FSalida ! 0;
         |HAZ RecogeAnter;

         |DDEFECTO #dsmod330;
         #dsmod330#0 = enEmpresa;
         #dsmod330#1 = enEjer;
         #dsmod330#2 = enPeriodo;
         #dsmod330#3 = enModelo;
         #dsmod330#4 = enComplem;
         #dsmod330#5 = 0;

         #dsmod330#57 = 0;
         #dsmod330#59 = nEjerAnt;

         |GRABA 020#dsmod330.b;
     |FINSI;

     nEjerAnt  = #dsmod330#59;
     nContador = 0;
     nSwGraba  = 0;
     |BUCLE dsmociva;

     |SI nSwGraba = 1;
         #dsmod330#59 = nEjerAnt;
         |HAZ Totales330;
         enIvaSopDed = #dsmod330#55;
         |GRABA 020#dsmod330.a;
     |SINO;
         |BORRA 020#dsmod330.a;
     |FINSI;
     |LIBERA #dsmod330;
     |CIERRA #dsmod330;
|FPRC;

|| __________________________________________________________________________

|PROCESO Totales332;
     #dsmod332#70 = nPro;
     #dsmod332#71 = eaProrrat;

     #dsmod332#33 = #dsmod332#8  + #dsmod332#11 + #dsmod332#14 + #dsmod332#17 + #dsmod332#20 + #dsmod332#23 + #dsmod332#26 + #dsmod332#29 + #dsmod332#32;

|| aplicar nueva Prorrata
     |SI enEjer ] enEjerPro;
          |SI eaDesg109 = "N";
              #dsmod332#35 = #dsmod332#35 - enImpProrrata;
          |SINO;
              #dsmod332#35 = #dsmod332#35 - enImpProrrat1;
              #dsmod332#37 = #dsmod332#37 - enImpProrrat2;
              #dsmod332#41 = #dsmod332#41 - enImpProrrat3;
              #dsmod332#43 = #dsmod332#43 - enImpProrrat4;
              #dsmod332#47 = #dsmod332#47 - enImpProrrat5;
              #dsmod332#49 = #dsmod332#49 - enImpProrrat6;
              #dsmod332#53 = #dsmod332#53 - enImpProrrat7;
          |FINSI;
     |FINSI;
|| ...
|| Regularizacion Manual
     #dsmod332#35 = #dsmod332#35 - #dsmom047#6;
     #dsmod332#37 = #dsmod332#37 - #dsmom047#7;
     #dsmod332#41 = #dsmod332#41 - #dsmom047#8;
     #dsmod332#43 = #dsmod332#43 - #dsmom047#9;
     #dsmod332#47 = #dsmod332#47 - #dsmom047#10;
     #dsmod332#49 = #dsmod332#49 - #dsmom047#11;
     #dsmod332#53 = #dsmod332#53 - #dsmom047#12;
|| ....
     #dsmod332#38 = #dsmod332#34 + #dsmod332#36;
     #dsmod332#39 = #dsmod332#35 + #dsmod332#37;
     #dsmod332#44 = #dsmod332#40 + #dsmod332#42;
     #dsmod332#45 = #dsmod332#41 + #dsmod332#43;
     #dsmod332#50 = #dsmod332#46 + #dsmod332#48;
     #dsmod332#51 = #dsmod332#47 + #dsmod332#49;
     #dsmod332#55 = #dsmod332#39 + #dsmod332#45 + #dsmod332#51 + #dsmod332#53 + #dsmod332#54;

     #dsmod332#56 = #dsmod332#33 - #dsmod332#55;
     #dsmod332#57 = #dsmod332#57 / nContador;
     #dsmod332#58 = #dsmod332#56 % #dsmod332#57;
     #dsmod332#66 = #dsmod332#58 - #dsmod332#59 + #dsmod332#65;

     |SI #dsmod332#66 > 0;
         #dsmod332#69 = #dsmod332#66;
         #dsmod332#64 = 0;
         #dsmod332#67 = 0;
         #dsmod332#68 = 0;
     |SINO;
         |SI #dsmod332#2 = 12;
             nResult = -#dsmod332#66;
             #dsmod332#64 = (#dsmod332#60 + #dsmod332#61 + #dsmod332#62 + #dsmod332#63) % 16;

             |HAZ UltimoPeriodo;
             |SI eaUltimoPer = "COMPENSAR";
                 #dsmod332#67 = -#dsmod332#66;
                 #dsmod332#68 = 0;
                 #dsmod332#69 = 0;
             |SINO;
                 #dsmod332#68 = -#dsmod332#66;
                 #dsmod332#67 = 0;
                 #dsmod332#69 = 0;
             |FINSI;

             |ACABA;
         |FINSI;

         nResult = -#dsmod332#66;
         #dsmod332#64 = (#dsmod332#60 + #dsmod332#61 + #dsmod332#62 + #dsmod332#63) % 16;
         |SI #dsmod332#64 < 0;         #dsmod332#64 = 0;         |FINSI;
         |SI #dsmod332#68 = 0;         #dsmod332#68 =  #dsmod332#64;  |FINSI;
         |SI #dsmod332#68 > #dsmod332#64;   #dsmod332#68 =  #dsmod332#64;  |FINSI;
         |SI #dsmod332#68 > nResult;   #dsmod332#68 =  nResult;  |FINSI;

         #dsmod332#67 = nResult - #dsmod332#68;

         |SI #dsmod332#64 = 0;  |ACABA;  |FINSI;

         |SI enPregunta = 1;
             #dsmod332#68 = enDevolver;
             #dsmod332#67 = nResult - #dsmod330#68;
             |ACABA;
         |FINSI;

         |PUSHV 0501 2380;
         |CUADRO 1220 1752;
         |BLANCO 1321 1651;

         |ATRI S;
         |PINTA 1321, "Resultado ........: ";
         |PINTA 1421, "Maximo a Devolver : ";
         |PINTA 1521, "A Devolver .......: ";
         |PINTA 1621, "A Compensar ......: ";
         |ATRI s;

         |PINTA 1341, #dsmod332#66;
         |PINTA 1441, #dsmod332#64;
         |PINTA 1541, #dsmod332#68;
         |PINTA 1641, #dsmod332#67;

         E_inf = "0.?EURO";
         E_sup = "99999999999";

         nCampo68 = #dsmod332#68;

         |ET Campo68_332;
             nCampo68 = 1541 ? 1;
             |SI nCampo68 > #dsmod332#64;
                 |MENAV "     Maximo a Devolver superado.";
                 nCampo68 = #dsmod332#64;
                 |VETE Campo68_332;
             |FINSI;

         #dsmod332#68 = nCampo68;
         #dsmod332#67 = nResult - #dsmod332#68;
         |PINTA 1641, #dsmod332#67;

         |POPV;
     |FINSI;
|FPRC;

|PROCESO Modelo332;
     |ABRE #dsmod332;

     #dsmod332#0 = enEmpresa;
     #dsmod332#1 = enEjer;
     #dsmod332#2 = enPeriodo;
     #dsmod332#3 = enModelo;
     #dsmod332#4 = enComplem;
     #dsmod332#5 = 0;
     |LEE 101#dsmod332.=;
     |SI FSalida ! 0;
         |HAZ RecogeAnter;

         |DDEFECTO #dsmod332;
         #dsmod332#0 = enEmpresa;
         #dsmod332#1 = enEjer;
         #dsmod332#2 = enPeriodo;
         #dsmod332#3 = enModelo;
         #dsmod332#4 = enComplem;
         #dsmod332#5 = 0;

         #dsmod332#57 = 0;
         #dsmod332#59 = nEjerAnt;

         |GRABA 020#dsmod332.b;
     |FINSI;

     nEjerAnt  = #dsmod332#59;
     nContador = 0;
     nSwGraba  = 0;
     |BUCLE dsmociva;

     |SI nSwGraba = 1;
         #dsmod332#59 = nEjerAnt;
         |HAZ Totales332;
         enIvaSopDed = #dsmod332#55;
         |GRABA 020#dsmod332.a;
     |SINO;
         |BORRA 020#dsmod332.a;
     |FINSI;
     |LIBERA #dsmod332;
     |CIERRA #dsmod332;
|FPRC;

|PROCESO aPerNom;
     |SI enPeriodo = 1;   aPerNom = "ENERO     ";  |FINSI;
     |SI enPeriodo = 2;   aPerNom = "FEBRERO   ";  |FINSI;
     |SI enPeriodo = 3;   aPerNom = "MARZO     ";  |FINSI;
     |SI enPeriodo = 4;   aPerNom = "ABRIL     ";  |FINSI;
     |SI enPeriodo = 5;   aPerNom = "MAYO      ";  |FINSI;
     |SI enPeriodo = 6;   aPerNom = "JUNIO     ";  |FINSI;
     |SI enPeriodo = 7;   aPerNom = "JULIO     ";  |FINSI;
     |SI enPeriodo = 8;   aPerNom = "AGOSTO    ";  |FINSI;
     |SI enPeriodo = 9;   aPerNom = "SEPTIEMBRE";  |FINSI;
     |SI enPeriodo = 10;  aPerNom = "OCTUBRE   ";  |FINSI;
     |SI enPeriodo = 11;  aPerNom = "NOVIEMBRE ";  |FINSI;
     |SI enPeriodo = 12;  aPerNom = "DICIEMBRE ";  |FINSI;
     |SI enPeriodo = 99;  aPerNom = "ANUAL     ";  |FINSI;
|FPRC;

|PROCESO dsmom029;
     |SI nSwOpe29 = 0;
         |SI #dsmom029#9 = 0;
             #dsmom027#39 = #dsmom027#39 + #dsmom029#3;
             #dsmom027#40 = #dsmom027#40 + #dsmom029#5;
             #dsmom027#44 = #dsmom027#44 + #dsmom029#8;
         |FINSI;
     |SINO;
         |BORRA 020#dsmom029.a;
     |FINSI;
     |LIBERA #dsmom029;
|FPRC;

|DEFBUCLE dsmom029;
     #dsmom029#1;
     ;
     enEmpresa, enEjer, nDPer, 00;
     enEmpresa, enEjer, nHPer, 00;
     be;
     NULL, dsmom029;
|FIN;

|PROCESO DeclaradoProrrata30301;
     #dsmom027#23 = #dsmom027#23 + #dsm30301#44;
     #dsmom027#24 = #dsmom027#24 + #dsm30301#46;
     #dsmom027#25 = #dsmom027#25 + #dsm30301#48;
     #dsmom027#26 = #dsmom027#26 + #dsm30301#50;
     #dsmom027#27 = #dsmom027#27 + #dsm30301#52;
     #dsmom027#28 = #dsmom027#28 + #dsm30301#54;
     #dsmom027#29 = #dsmom027#29 + #dsm30301#57;
|FPRC;

|DEFBUCLE dsm30301;
     #dsm30301;
     ;
     enEmpresa, enEjer,  1, 303, 00, 00;
     enEmpresa, enEjer, 12, 303, 99, 99;
     ;
     NULL, DeclaradoProrrata30301;
|FIN;

|PROCESO DeclaradoProrrata300;
     #dsmom027#23 = #dsmom027#23 + #dsmod300#35;
     #dsmom027#24 = #dsmom027#24 + #dsmod300#37;
     #dsmom027#25 = #dsmom027#25 + #dsmod300#41;
     #dsmom027#26 = #dsmom027#26 + #dsmod300#43;
     #dsmom027#27 = #dsmom027#27 + #dsmod300#47;
     #dsmom027#28 = #dsmom027#28 + #dsmod300#49;
     #dsmom027#29 = #dsmom027#29 + #dsmod300#53;
|FPRC;

|DEFBUCLE dsmod300;
     #dsmod300#1;
     ;
     enEmpresa, enEjer,  1, 300, 00, 00;
     enEmpresa, enEjer, 12, 300, 99, 99;
     ;
     NULL, DeclaradoProrrata300;
|FIN;

|PROCESO DeclaradoProrrata303;
     #dsmom027#23 = #dsmom027#23 + #dsmod303#35;
     #dsmom027#24 = #dsmom027#24 + #dsmod303#37;
     #dsmom027#25 = #dsmom027#25 + #dsmod303#39;
     #dsmom027#26 = #dsmom027#26 + #dsmod303#41;
     #dsmom027#27 = #dsmom027#27 + #dsmod303#43;
     #dsmom027#28 = #dsmom027#28 + #dsmod303#45;
     #dsmom027#29 = #dsmom027#29 + #dsmod303#46;
|FPRC;

|DEFBUCLE dsmod303;
     #dsmod303#1;
     ;
     enEmpresa, enEjer,  1, 303, 00, 00;
     enEmpresa, enEjer, 12, 303, 99, 99;
     ;
     NULL, DeclaradoProrrata303;
|FIN;

|PROCESO DeclaradoProrrata370;
     #dsmom027#23 = #dsmom027#23 + #dsmod370#35;
     #dsmom027#24 = #dsmom027#24 + #dsmod370#37;
     #dsmom027#25 = #dsmom027#25 + #dsmod370#41;
     #dsmom027#26 = #dsmom027#26 + #dsmod370#43;
     #dsmom027#27 = #dsmom027#27 + #dsmod370#47;
     #dsmom027#28 = #dsmom027#28 + #dsmod370#49;
     #dsmom027#29 = #dsmom027#29 + #dsmod370#53;
|FPRC;

|DEFBUCLE dsmod370;
     #dsmod370#1;
     ;
     enEmpresa, enEjer,  1, 370, 00, 00;
     enEmpresa, enEjer, 12, 370, 99, 99;
     ;
     NULL, DeclaradoProrrata370;
|FIN;

|PROCESO DeclaradoProrrata320;
     #dsmom027#23 = #dsmom027#23 + #dsmod320#35;
     #dsmom027#24 = #dsmom027#24 + #dsmod320#37;
     #dsmom027#25 = #dsmom027#25 + #dsmod320#41;
     #dsmom027#26 = #dsmom027#26 + #dsmod320#43;
     #dsmom027#27 = #dsmom027#27 + #dsmod320#47;
     #dsmom027#28 = #dsmom027#28 + #dsmod320#49;
     #dsmom027#29 = #dsmom027#29 + #dsmod320#53;
|FPRC;

|DEFBUCLE dsmod320;
     #dsmod320#1;
     ;
     enEmpresa, enEjer,  1, 320, 00, 00;
     enEmpresa, enEjer, 12, 320, 99, 99;
     ;
     NULL, DeclaradoProrrata370;
|FIN;

|PROCESO DeclaradoProrrata330;
     #dsmom027#23 = #dsmom027#23 + #dsmod330#35;
     #dsmom027#24 = #dsmom027#24 + #dsmod330#37;
     #dsmom027#25 = #dsmom027#25 + #dsmod330#41;
     #dsmom027#26 = #dsmom027#26 + #dsmod330#43;
     #dsmom027#27 = #dsmom027#27 + #dsmod330#47;
     #dsmom027#28 = #dsmom027#28 + #dsmod330#49;
     #dsmom027#29 = #dsmom027#29 + #dsmod330#53;
|FPRC;

|DEFBUCLE dsmod330;
     #dsmod330#1;
     ;
     enEmpresa, enEjer,  1, 330, 00, 00;
     enEmpresa, enEjer, 12, 330, 99, 99;
     ;
     NULL, DeclaradoProrrata330;
|FIN;

|PROCESO DeclaradoProrrata332;
     #dsmom027#23 = #dsmom027#23 + #dsmod332#35;
     #dsmom027#24 = #dsmom027#24 + #dsmod332#37;
     #dsmom027#25 = #dsmom027#25 + #dsmod332#41;
     #dsmom027#26 = #dsmom027#26 + #dsmod332#43;
     #dsmom027#27 = #dsmom027#27 + #dsmod332#47;
     #dsmom027#28 = #dsmom027#28 + #dsmod332#49;
     #dsmom027#29 = #dsmom027#29 + #dsmod332#53;
|FPRC;

|DEFBUCLE dsmod332;
     #dsmod332#1;
     ;
     enEmpresa, enEjer,  1, 330, 00, 00;
     enEmpresa, enEjer, 12, 330, 99, 99;
     ;
     NULL, DeclaradoProrrata332;
|FIN;

|PROCESO TotalProrrata;
     #dsmom027#6  = #dsmom027#4 + #dsmom027#5;
     nNume1 = ((#dsmom027#4 / #dsmom027#6) * 100) ! 2;
     nNume2 = nNume1 ! 0;
     |SI nNume2 < nNume1;
         nNume2 = nNume1 ! 0 + 1;
     |FINSI;
     #dsmom027#3  = nNume2;
     |SI #dsmom027#3 > 100; #dsmom027#3 = 100; |FINSI;

     #dsmom027#15 = #dsmom027#7  % #dsmom027#2;
     #dsmom027#16 = #dsmom027#8  % #dsmom027#2;
     #dsmom027#17 = #dsmom027#9  % #dsmom027#2;
     #dsmom027#18 = #dsmom027#10 % #dsmom027#2;
     #dsmom027#19 = #dsmom027#11 % #dsmom027#2;
     #dsmom027#20 = #dsmom027#12 % #dsmom027#2;
     #dsmom027#21 = #dsmom027#13 % #dsmom027#2;

     nDPer = 1;
     nHPer = 12;
     nSwOpe29 = 0;

     |SI enEjer [ 2013;
         |BUCLE dsmod300;
         |BUCLE dsmod303;
         |BUCLE dsmod370;
         |BUCLE dsmod320;
         |BUCLE dsmod330;
         |BUCLE dsmod332;
     |FINSI;

     |SI enEjer ] 2014;
         |BUCLE dsm30301;
     |FINSI;

     |BUCLE dsmom029;

     #dsmom027#31 = #dsmom027#15 - #dsmom027#23;
     #dsmom027#32 = #dsmom027#16 - #dsmom027#24;
     #dsmom027#33 = #dsmom027#17 - #dsmom027#25;
     #dsmom027#34 = #dsmom027#18 - #dsmom027#26;
     #dsmom027#35 = #dsmom027#19 - #dsmom027#27;
     #dsmom027#36 = #dsmom027#20 - #dsmom027#28;
     #dsmom027#37 = #dsmom027#21 - #dsmom027#29;

     #dsmom027#14 = #dsmom027#7  + #dsmom027#8  + #dsmom027#9  + #dsmom027#10 + #dsmom027#11 + #dsmom027#12 + #dsmom027#13;
     #dsmom027#22 = #dsmom027#15 + #dsmom027#16 + #dsmom027#17 + #dsmom027#18 + #dsmom027#19 + #dsmom027#20 + #dsmom027#21;
     #dsmom027#30 = #dsmom027#23 + #dsmom027#24 + #dsmom027#25 + #dsmom027#26 + #dsmom027#27 + #dsmom027#28 + #dsmom027#29;
     #dsmom027#38 = #dsmom027#31 + #dsmom027#32 + #dsmom027#33 + #dsmom027#34 + #dsmom027#35 + #dsmom027#36 + #dsmom027#37;

     #dsmom027#41 = #dsmom027#39 - #dsmom027#40;
|FPRC;

|PROCESO GrabaMenor2014;
     |SI enModelo ! 370;
         |HAZ eLeeLaProrrata;
         nPro = nProrrata;
         |SI enEjer ] enEjerPro; nProrrata = 100; |FINSI;
     |FINSI;

     |SI enModelo = 300;
         |ABRE #dsmod300;
         #dsmod300#0 = enEmpresa;
         #dsmod300#1 = enEjer;
         #dsmod300#2 = enPeriodo;
         #dsmod300#3 = enModelo;
         #dsmod300#4 = enComplem;
         #dsmod300#5 = 0;
         |LEE 101#dsmod300.=;
         |SI FSalida = 0;
             |BORRA 020#dsmod300.a;
         |FINSI;
         |LIBERA #dsmod300;
         |CIERRA #dsmod300;
     |FINSI;

     |SI enModelo = 303;
         |ABRE #dsmod303;
         #dsmod303#0 = enEmpresa;
         #dsmod303#1 = enEjer;
         #dsmod303#2 = enPeriodo;
         #dsmod303#3 = enModelo;
         #dsmod303#4 = enComplem;
         #dsmod303#5 = 0;
         |LEE 101#dsmod303.=;
         |SI FSalida = 0;
             |BORRA 020#dsmod303.a;
         |FINSI;
         |LIBERA #dsmod303;
         |CIERRA #dsmod303;
     |FINSI;

     |SI enModelo = 320;
         |ABRE #dsmod320;
         #dsmod320#0 = enEmpresa;
         #dsmod320#1 = enEjer;
         #dsmod320#2 = enPeriodo;
         #dsmod320#3 = enModelo;
         #dsmod320#4 = enComplem;
         #dsmod320#5 = 0;
         |LEE 101#dsmod320.=;
         |SI FSalida = 0;
             |BORRA 020#dsmod320.a;
         |FINSI;
         |LIBERA #dsmod320;
         |CIERRA #dsmod320;
     |FINSI;

     |SI enModelo = 330;
         |ABRE #dsmod330;
         #dsmod330#0 = enEmpresa;
         #dsmod330#1 = enEjer;
         #dsmod330#2 = enPeriodo;
         #dsmod330#3 = enModelo;
         #dsmod330#4 = enComplem;
         #dsmod330#5 = 0;
         |LEE 101#dsmod330.=;
         |SI FSalida = 0;
             |BORRA 020#dsmod330.a;
         |FINSI;
         |LIBERA #dsmod330;
         |CIERRA #dsmod330;
     |FINSI;

     |SI enModelo = 332;
         |ABRE #dsmod332;
         #dsmod332#0 = enEmpresa;
         #dsmod332#1 = enEjer;
         #dsmod332#2 = enPeriodo;
         #dsmod332#3 = enModelo;
         #dsmod332#4 = enComplem;
         #dsmod332#5 = 0;
         |LEE 101#dsmod332.=;
         |SI FSalida = 0;
             |BORRA 020#dsmod332.a;
         |FINSI;
         |LIBERA #dsmod332;
         |CIERRA #dsmod332;
     |FINSI;

     |SI enModelo = 370;
         |ABRE #dsmod370;
         #dsmod370#0 = enEmpresa;
         #dsmod370#1 = enEjer;
         #dsmod370#2 = enPeriodo;
         #dsmod370#3 = enModelo;
         #dsmod370#4 = enComplem;
         #dsmod370#5 = 0;
         |LEE 101#dsmod370.=;
         |SI FSalida = 0;
             |BORRA 020#dsmod370.a;
         |FINSI;
         |LIBERA #dsmod370;
         |CIERRA #dsmod370;
     |FINSI;

     |ABRE #dsmom008;
     #dsmom008#0 = enEmpresa;
     #dsmom008#1 = enEjer;
     #dsmom008#2 = enPeriodo;
     #dsmom008#3 = enModelo;
     #dsmom008#4 = enComplem;
     #dsmom008#5 = 0;
     |LEE 101#dsmom008.=;
     |SI FSalida = 0;
         #dsmom008#11 = "SIN DATOS ";
         |GRABA 020#dsmom008.a;
     |FINSI;
     |LIBERA #dsmom008;
     |CIERRA #dsmom008;

     |SI enEjer < enEjerPro;   || de antes
         nDPer = enPeriodo;
         nHPer = enPeriodo;
         nSwOpe29 = 1;
         |BUCLE dsmom029;
     |FINSI;

     nSwGraba = 0;

     eaProrr29     = eaProrrat;
     enImpIvaSop   = 0;
     enIvaSopDed   = 0;
     enImpIvaSub   = 0;
     |SI enModelo = 300;  |HAZ Modelo300;  |FINSI;
     |SI enModelo = 303;  |HAZ Modelo303;  |FINSI;
     |SI enModelo = 320;  |HAZ Modelo320;  |FINSI;
     |SI enModelo = 330;  |HAZ Modelo330;  |FINSI;
     |SI enModelo = 332;  |HAZ Modelo332;  |FINSI;
     |SI enModelo = 370;
         nTipo         = enTipoEntrada;
         enTipoEntrada = 98;
         |SUB_EJECUTA_NP "dsmod370";
         enTipoEntrada = nTipo;
         nSwGraba      = enExistencia;
     |FINSI;

     |SI nSwGraba = 1;
         |ABRE #dsmom008;
         #dsmom008#0 = enEmpresa;
         #dsmom008#1 = enEjer;
         #dsmom008#2 = enPeriodo;
         #dsmom008#3 = enModelo;
         #dsmom008#4 = enComplem;
         #dsmom008#5 = 0;
         |LEE 101#dsmom008.=;
         |SI FSalida = 0;
             #dsmom008#11 = "EXISTENTE";
             |GRABA 020#dsmom008.a;
         |FINSI;
         |LIBERA #dsmom008;
         |CIERRA #dsmom008;
     |FINSI;

     |SI enEjer ] enEjerPro;  || Calculo Nuevo de Prorrata
         |ACABA;
     |FINSI;

     |ABRE #dsmom027;
     #dsmom027#0 = enEmpresa;
     #dsmom027#1 = enEjer;
     |LEE 101#dsmom027.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmom027;
         #dsmom027#0 = enEmpresa;
         #dsmom027#1 = enEjer;
         |GRABA 020#dsmom027.b;
     |FINSI;

     |PDEFECTO #dsmom027, 15, 41;
     |HAZ TotalProrrata;

     |GRABA 020#dsmom027.a;
     |LIBERA #dsmom027;

     nPorCalculado = #dsmom027#3;

     |SI enPeriodo = 12; |Y enSwProrr < 2;
         #dsmom027#0 = enEmpresa;
         #dsmom027#1 = enEjer + 1;
         |LEE 101#dsmom027.=;
         |SI FSalida ! 0;
             |DDEFECTO #dsmom027;
             #dsmom027#0 = enEmpresa;
             #dsmom027#1 = enEjer + 1;
             |GRABA 020#dsmom027.b;
         |FINSI;

         |SI #dsmom027#2 ! nPorCalculado;
             |SI enPregunta = 0;
                 aAlfa = "0000 El Porcentaje de Prorrata para el Ejercicio que viene ha sido Actualizado.";
                 aAlfa = aAlfa + " Empresa " + (("00000" + #dsmom027#0) % -105) + " / " + #dsmom027#1;
                 |MENAV aAlfa;
             |FINSI;
             #dsmom027#2 = nPorCalculado;
         |FINSI;
         |GRABA 020#dsmom027.a;
         |LIBERA #dsmom027;

         #dsmom027#0 = enEmpresa;
         #dsmom027#1 = enEjer;
         |LEE 101#dsmom027.=;
     |FINSI;

     |CIERRA #dsmom027;
|FPRC;

|PROCESO GrabaMayor2014;
     |ABRE #dsmom008;
     #dsmom008#0 = enEmpresa;
     #dsmom008#1 = enEjer;
     #dsmom008#2 = enPeriodo;
     #dsmom008#3 = enModelo;
     #dsmom008#4 = enComplem;
     #dsmom008#5 = 0;
     |LEE 101#dsmom008.=;
     |SI FSalida = 0;
         #dsmom008#11 = "SIN DATOS ";
         |GRABA 020#dsmom008.a;
     |FINSI;
     |LIBERA #dsmom008;
     |CIERRA #dsmom008;

     nSwGraba = 0;

     eaProrr29     = eaProrrat;
     enImpIvaSop   = 0;
     enIvaSopDed   = 0;
     enImpIvaSub   = 0;
     nTipo         = enTipoEntrada;
     enTipoEntrada = 98;

     aParametro = ("00000" + enEmpresa) % -105;
     aParametro = aParametro + ("0000" + enEjer) % -104;
     aParametro = aParametro + ("00" + enPeriodo) % -102;
     aParametro = aParametro + ("000" + enModelo) % -103;
     aParametro = aParametro + ("00" + enComplem) % -102;
     aParametro = aParametro + ("00" + enActividad) % -102;
     aParametro = aParametro + ("00" + enTipoEntrada) % -102;
     aParametro = aParametro + ("0" + enExistencia) % -101;

     |SI enDesdeX = 1;
         aAlfa = "|dsm30301;" + aParametro;
     |FINSI;

     |SI enDesdeX = 0;
         aAlfa = "dsm30301;" + aParametro;
     |FINSI;

     |SUB_EJECUTA_NP aAlfa;
     enTipoEntrada = nTipo;
     nSwGraba      = enExistencia;

     |SI nSwGraba = 1;
         |ABRE #dsmom008;
         #dsmom008#0 = enEmpresa;
         #dsmom008#1 = enEjer;
         #dsmom008#2 = enPeriodo;
         #dsmom008#3 = enModelo;
         #dsmom008#4 = enComplem;
         #dsmom008#5 = 0;
         |LEE 101#dsmom008.=;
         |SI FSalida = 0;
             #dsmom008#11 = "EXISTENTE";
             |GRABA 020#dsmom008.a;
         |FINSI;
         |LIBERA #dsmom008;
         |CIERRA #dsmom008;
     |FINSI;
|FPRC;

|PROCESO Registro0;

     |SI enEjer [ 2013;
         |HAZ GrabaMenor2014;
     |FINSI;

     |SI enEjer ] 2014;
         |HAZ GrabaMayor2014;
     |FINSI;
|FPRC;
