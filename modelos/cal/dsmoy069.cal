|FICHEROS;
   dsmoy069 #0;

   dsmom004 #4;
   dsmom095 #95;

   dsmom030 #30;
   dsmom069;

   dsmoc349 #349;
   dsmod349 #350;

   :/basica/def/agicen14 #114;
   :/basica/def/agifigen #118;

   dsmow030 #900;
   :/contagen/def/canempre #101;
   :/contagen/def/camaniva #102;
   :/contagen/def/caivalin #103;
   :/contagen/def/caivaasi #104;
   :/contagen/def/caivam03 #105;

   dsmow122 #998;
   dsmow124 #999;
|FIN;

|VARIABLES;
   informe     = "";
   nCampo      = 0;
   nDEmpresa   = 0;
   nHEmpresa   = 0;
   fFecha      = @;
   nAnyo       = 0;
   nMes        = 0;

   aAlfa  = "";
   aAlfa1 = "";
   aAlfa2 = "";
   aAlfa3 = "";
   nPara1 = 0;
   nPara2 = 0;
   nNume1 = 0;
   nNume2 = 0;
   nNume3 = 0;
   nNume4 = 0;

   nSPin1      = 0;
   nSwHay      = 0;
   nPrint      = 0;
   aPath       = "";
   aPathModelo = "";
   nSwPrint    = 0;
   aFichero    = "";

   nEjercicio    = 0;
   nEjer         = 0;
   nActividad    = 0;
   aActividad    = "";
   nPeriodo      = 0;
   nComplem      = 0;
   nModelo       = 0;
   nDepar        = 0;
   nMesCont      = 0;
   nSwOp         = 0;
   nDPeriodo     = 0;
   nHPeriodo     = 0;
   nDepartamento = 0;

   nSwPasa       = 0;
   nCompensado   = 0;
   nGrupo        = 0;
   nSubGrupo     = 0;

   nCampo1       = 0;
   nCampo2       = 0;
   nCampo3       = 0;
   nCampo11      = 0;
   nCampo22      = 0;
   nCampo33      = 0;
   nPorce        = 0;
   nBaseImpo     = 0;
   nCuota        = 0;
   nSwConta      = 0;
   nSwEsta       = 0;
   nEsRecti      = 0;

   aNombre       = "";
   aEspecial     = "";
   aTriangul     = "";

   nPer          = 0;
   aNif          = "";
   nEjerRec      = 0;
   nPerRec       = 0;
   nGraba        = 0;

   &aTipo        = "";
   &nSwLinea     = 0;
   &nSwLinD      = 0;
   &nSwRecti     = 0;
   &eaDesTipo    = "";

|FIN;

|INCLUYE i_variar;
|INCLUYE i_varcon;
|INCLUYE i_varlib;

|| //////////////////// Calculos de Pantalla \\\\\\\\\\\\\\\\\\\\\\\\\\
|CALCULO Eano; |TIPO 7;
  fFecha = ~;
  aAlfa  = fFecha % 402;   nMes  = aAlfa;
  aAlfa  = fFecha % -104;  nAnyo = aAlfa;
|FCAL;

|PROCESO Periodo;
     #0#58 = "          ";
     |SI #0#57 = 1;   #0#58 = "ENERO     ";  |FINSI;
     |SI #0#57 = 2;   #0#58 = "FEBRERO   ";  |FINSI;
     |SI #0#57 = 3;   #0#58 = "MARZO     ";  |FINSI;
     |SI #0#57 = 4;   #0#58 = "ABRIL     ";  |FINSI;
     |SI #0#57 = 5;   #0#58 = "MAYO      ";  |FINSI;
     |SI #0#57 = 6;   #0#58 = "JUNIO     ";  |FINSI;
     |SI #0#57 = 7;   #0#58 = "JULIO     ";  |FINSI;
     |SI #0#57 = 8;   #0#58 = "AGOSTO    ";  |FINSI;
     |SI #0#57 = 9;   #0#58 = "SEPTIEMBRE";  |FINSI;
     |SI #0#57 = 10;  #0#58 = "OCTUBRE   ";  |FINSI;
     |SI #0#57 = 11;  #0#58 = "NOVIEMBRE ";  |FINSI;
     |SI #0#57 = 12;  #0#58 = "DICIEMBRE ";  |FINSI;
     |SI #0#57 = 99;  #0#58 = "ANUAL     ";  |FINSI;

     |SI #0#58 = "          ";
         |MENAV "     Periodo Incorrecto.";
         |ERROR;
     |FINSI;

     |PINTA #0#58;
|FPRC;

|CALCULO Tipo7;  |TIPO 7;
     |SI enEmpresa ! 0;
         #0#2  = enEmpresa;  |PINTA #0#2;
         #0#3  = enEmpresa;  |PINTA #0#3;

         |C_M #0#2, 1, "N";
         |C_M #0#3, 1, "N";
     |FINSI;
|FCAL;

|CALCULO Parrilla; |TIPO 0;
     |SI #0#2 = 0;
         #0#2 = 0;  |PINTA #0#2;
         #0#3 = 0;  |PINTA #0#3;  |C_M #0#3, 1, "N";
         |PARA nCampo = 4;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |SINO;
         |SI enEmpresa = 0;
             |C_M #0#2, 1, "S";
             |C_M #0#3, 1, "S";
         |FINSI;

         |PARA nCampo = 4;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "N";
               #0nCampo = 0;  |PINTA #0nCampo;
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO NoMasEmpresas; |TIPO 0;
     |SI #0Campo = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               #0nCampo = 0;  |C_M #0nCampo, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |FINSI;
|FCAL;

|CALCULO YaSeCual; |TIPO 7;
 |SI enEmpresa ! 0;
     #0#41 = "S"; |PINTA #0#41;
     #0#24 = "S"; |PINTA #0#24;
     #0#25 = 00;  |PINTA #0#25;
     #0#26 = 99;  |PINTA #0#26;
     |C_M #0#24, 1, "N";
     |C_M #0#25, 1, "N";
     |C_M #0#26, 1, "N";
     |C_M #0#41, 1, "N";
 |FINSI;
|FCAL;

|CALCULO SelTipo0; |TIPO 0;
 |SI #0#41 = "N";
     #0#25 = 0;  |PINTA #0#25;  |C_M #0#25, 1, "N";
     #0#26 = 99; |PINTA #0#26;  |C_M #0#26, 1, "N";
     |PARA nCampo = 27;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           |C_M #0nCampo, 1, "S";
     |SIGUE;
 |SINO;
     |SI enEmpresa = 0;
         |C_M #0#25, 1, "S";
         |C_M #0#26, 1, "S";
     |FINSI;
     |PARA nCampo = 27;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           |C_M #0nCampo, 1, "N";
           #0nCampo = 0;  |PINTA #0nCampo;
     |SIGUE;
 |FINSI;
|FCAL;

|CALCULO SelTipo1;
 |SI #0Campo = 0;
     |PARA nCampo = Campo + 1;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           #0nCampo = 0;  |C_M #0nCampo, 1, "N";
     |SIGUE;
 |SINO;
     |PARA nCampo = Campo + 1;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           |C_M #0nCampo, 1, "S";
     |SIGUE;
 |FINSI;
|FCAL;

|PROCESO DesdeDni;
     |SI #0#42 = "            ";
         #0#43 = "zzzzzzzzzzzz";  |C_M #0#43,1,"N"; |PINTA #0#43;
         |PARA nCampo = 44;  |SI nCampo [ 51;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |SINO;
         |C_M #0#43,1,"S";
         |PARA nCampo = 44;  |SI nCampo [ 51;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "N";
               #0nCampo = ""; |PINTA #0nCampo;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO NoMasDni;
     |SI #0Campo = "            ";
         |PARA nCampo = Campo + 1;  |SI nCampo [ 51;  |HACIENDO nCampo = nCampo + 1;
               #0nCampo = "";  |C_M #0nCampo, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 51;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |FINSI;
|FPRC;

|| *************************************************************************
|PROCESO PreparaConta;
   nSwConta  = 0; ||compruebo si tiene contabilidad

   enSwOpPar  = 0;
   |HAZ SituaEmpresa;
   |SI enSwPartido = 0;
       |ABRE #101;
       |SELECT #4#101;
       |DDEFECTO #101;
       #101#2  = enEmpresa;
       #101#26 = nEjercicio;
       |LEE 001#canempre.=;
       |SI FSalida = 0;
           enPerConta = #101#3;   || Periodo Contable
           aAlfa1 = enEmpresa;  aAlfa1 = ("00000" + aAlfa1) % -105;
           aAlfa2 = enPerConta; aAlfa2 = ("0" + aAlfa2) % -101;
           aPathConta  = aPath + "contagen/fich/" + aAlfa1 + aAlfa2 + "/";
           nSwConta = 1;
           eaLaMonEmp = #101#28;
       |FINSI;
       |SELECT #1#101;
       |CIERRA #101;
   |SINO;
        enPerConta = enPeriodoPar;
        eaLaMonEmp = "E";
        nSwConta   = 1;
   |FINSI;
   |SI nSwConta = 0; |ACABA; |FINSI;    || no tiene contabilidad

   |HAZ EnConversor;
   |PATH_DAT #102 aPathConta;
   |PATH_DAT #103 aPathConta;
   |PATH_DAT #104 aPathConta;
   |PATH_DAT #105 aPathConta;

   |ABRE #104;
   |DDEFECTO #104;
   |LEE 000#104p;
   |CIERRA #104;
   aMulDep = #104#132;
|FPRC;

|PROCESO CierraConta;
     |SI enSwPartido = 1;
         enSwOpPar   = 2;
         |HAZ FinalPartido;
     |FINSI;
|FPRC;

|| /////////////////
|PROCESO ElPeriodo;
     #4#0  = enEmpresa;
     #4#1  = nEjer;
     #4#2  = nPeriodo;
     #4#3  = nModelo;
     #4#4  = 99;
     |LEE 040#4];
     |SI FSalida = 0;
         |LEE 040#4a;
     |SINO;
         |LEE 040#4u;
     |FINSI;
     |SI FSalida = 0; |Y #4#0 = enEmpresa; |Y #4#1 = nEjer;
          |Y #4#2 = nPeriodo; |Y #4#3 = nModelo;
             nComplem = #4#4;
     |FINSI;

     |SI nComplem ! -1;
         nDPeriodo = nPeriodo;
         nHPeriodo = nPeriodo;

         |SI #4#22 = "M";
             nDPeriodo = nPeriodo;
             nHPeriodo = nPeriodo;

             |SI #4#1 ] 2010;
                 |ABRE #95;
                 #95#0 = #4#0;
                 #95#1 = #4#1;
                 |LEE 000#95=;
                 |SI FSalida ! 0;  |DDEFECTO #95;  |FINSI;
                 |CIERRA #95;

                 |SI nPeriodo = 2; |Y #95#27 = "S";  nDPeriodo = 1;  |FINSI;
                 |SI nPeriodo = 5; |Y #95#28 = "S";  nDPeriodo = 4;  |FINSI;
                 |SI nPeriodo = 8; |Y #95#29 = "S";  nDPeriodo = 7;  |FINSI;
                 |SI nPeriodo = 11;|Y #95#30 = "S";  nDPeriodo = 10; |FINSI;
             |FINSI;
         |FINSI;

         |SI #4#22 = "T";
             |SI nPeriodo = 1;   nDPeriodo = 1;  nHPeriodo = 3;  |FINSI;
             |SI nPeriodo = 2;   nDPeriodo = 1;  nHPeriodo = 3;  |FINSI;
             |SI nPeriodo = 3;   nDPeriodo = 1;  nHPeriodo = 3;  |FINSI;
             |SI nPeriodo = 4;   nDPeriodo = 4;  nHPeriodo = 6;  |FINSI;
             |SI nPeriodo = 5;   nDPeriodo = 4;  nHPeriodo = 6;  |FINSI;
             |SI nPeriodo = 6;   nDPeriodo = 4;  nHPeriodo = 6;  |FINSI;
             |SI nPeriodo = 7;   nDPeriodo = 7;  nHPeriodo = 9;  |FINSI;
             |SI nPeriodo = 8;   nDPeriodo = 7;  nHPeriodo = 9;  |FINSI;
             |SI nPeriodo = 9;   nDPeriodo = 7;  nHPeriodo = 9;  |FINSI;
             |SI nPeriodo = 10;  nDPeriodo = 10; nHPeriodo = 12; |FINSI;
             |SI nPeriodo = 11;  nDPeriodo = 10; nHPeriodo = 12; |FINSI;
             |SI nPeriodo = 12;  nDPeriodo = 10; nHPeriodo = 12; |FINSI;
         |FINSI;

         aAlfa1 = nEjer;
         aAlfa2 = nDPeriodo; aAlfa2 = ("00" + aAlfa2) % -102;
         aAlfa3 = "01." + aAlfa2 + "." + aAlfa1; efDFecha = aAlfa3;

         aAlfa2 = nHPeriodo; aAlfa2 = ("00" + aAlfa2) % -102;
         aAlfa3 = "31.";
         |SI nHPeriodo = 4; |O nHPeriodo = 6; |O nHPeriodo = 9; |O nHPeriodo = 11;
             aAlfa3 = "30.";
         |FINSI;
         |SI nHPeriodo = 2;
             aAlfa3 = "28.";
             nNume1 = nEjer / 4; nNume2 = (nEjer / 4) ! 0;
             |SI nNume1 = nNume2; aAlfa3 = "29."; |FINSI;
         |FINSI;
         aAlfa3 = aAlfa3 + aAlfa2 + "." + aAlfa1; efHFecha = aAlfa3;

     |FINSI;
|FPRC;

|| ****************************************************
|PROCESO GrabaAuxCab;
   #998#0 = enEmpresa;
   #998#1 = nEjer;
   #998#2 = nPer;
   #998#3 = nModelo;
   #998#4 = nComplem;
   #998#5 = nDepar;
   #998#6 = aTipo;
   #998#7 = aNif;
   #998#8 = nEjerRec;
   #998#9 = nPerRec;
   |LEE 041#998=;
   |SI FSalida ! 0;
       |DDEFECTO #998;
       #998#0 = enEmpresa;
       #998#1 = nEjer;
       #998#2 = nPer;
       #998#3 = nModelo;
       #998#4 = nComplem;
       #998#5 = nDepar;
       #998#6 = aTipo;
       #998#7 = aNif;
       #998#8 = nEjerRec;
       #998#9 = nPerRec;
       #998#20 = aNombre;
       |GRABA 020#998c;
   |FINSI;

   |SI nSwOp = 0;
       #998#10 = #998#10 + #349#22;  || Base modelo
       #998#11 = #998#11 + (#349#12 + #349#15 + #349#18 + #349#21 + #349#30 + #349#33 + #349#36);

       #998#12 = #998#12 + #349#27;  || Base modelo
       #998#13 = #998#13 + (#349#39 + #349#42 + #349#45 + #349#48 + #349#51 + #349#54 + #349#57);
   |SINO;

       |SI nSwOp = 1;
           #998#14 = #998#14 + nBaseImpo;
           #998#15 = #998#15 + nCuota;
       |FINSI;
       |SI nSwOp = 2;
           #998#16 = #998#16 + #105#6;
           #998#17 = #998#17 + (#105#11 + #105#14 + #105#17 + #105#20 + #105#23 + #105#26 + #105#29);
       |FINSI;

       |SI aTipo = "AR"; |O aTipo = "ER"; |O aTipo = "IR";
            |O aTipo = "SR"; |O aTipo = "MR"; |O aTipo = "HR";
               #998#18 = #998#16 + #998#14;
               #998#19 = #998#17 + #998#15;
       |FINSI;
   |FINSI;
   |GRABA 020#998a;
|FPRC;

|| ******************
|PROCESO HazSeleccion;
   aAlfa1 = aTipo % 201;
   |SI aEspecial ! ""; aTipo = aEspecial + aAlfa1; |FINSI;

   nGraba = 0;
   aAlfa1 = aTipo % 101;
   |SI #0#53 = "N";
       |SI aAlfa1 = "E"; |O aAlfa1 = "M"; |O aAlfa1 = "H"; |O aAlfa1 = "T";
           |ACABA;
       |FINSI;
   |FINSI;
   |SI #0#54 = "N"; |Y aAlfa1 = "A"; |ACABA; |FINSI;
   |SI #0#55 = "N"; |Y aAlfa1 = "S"; |ACABA; |FINSI;
   |SI #0#56 = "N"; |Y aAlfa1 = "I"; |ACABA; |FINSI;

   |SI #0#52 ! "T";
       aAlfa1 = aTipo % 201;
       |SI aAlfa1 = "R"; |Y #0#52 = "N"; |ACABA; |FINSI;
       |SI aAlfa1 ! "R"; |Y #0#52 = "S"; |ACABA; |FINSI;
   |FINSI;

   |SI #0#42 ! "            ";
       |SI #0#42 [ aNif; |Y #0#43 ] aNif; nGraba = 1; |FINSI;
   |SINO;
       |PARA nPara2 = 44; |SI nPara2 [ 51; |HACIENDO nPara2 = nPara2 + 1;
             |SI #0nPara2 = aNif;
                 nGraba = 1;
                 |SAL;
             |FINSI;
       |SIGUE;
   |FINSI;
|FPRC;
|| ******************
|PROCESO LeeModelo;
     aTipo = #349#6;
     aNif  = #349#7;
     |HAZ HazSeleccion;
     |SI nGraba = 1;
         nSwHay   = 1;
         nPer     = #349#2;
         nDepar   = #349#5;
         aTipo    = #349#6;
         aNif     = #349#7;
         nEjerRec = #349#25; || Ejercicio Declarado;
         nPerRec  = #349#26;
         nSwOp    = 0;
         aNombre  = #349#9;
         |HAZ GrabaAuxCab;
    |FINSI;
|FPRC;

|DEFBUCLE LeeModelo;
   #349#1;
   ;
   enEmpresa, nEjer, nDPeriodo, nModelo, nComplem, 01, "  ", 0000, 00, "            ";
   enEmpresa, nEjer, nHPeriodo, nModelo, nComplem, 98, "zz", 9999, 99, "zzzzzzzzzzzz";
   e;
   NULL, LeeModelo;
|FIN;

|| =========================
|PROCESO Graba349Rec;
     aNif = #102#14;
     |HAZ HazSeleccion;
     |SI nGraba ! 1; |ACABA; |FINSI;

     #999#0  = enEmpresa;
     #999#1  = nEjer;
     #999#2  = nMesCont;
     #999#3  = nModelo;
     #999#4  = nComplem;
     #999#5  = nDepar;
     #999#6  = aTipo;
     #999#7  = #102#14;
     #999#8  = #105#5; || Ejercicio Declarado;
     #999#9  = #105#4;
     #999#10 = #102#0;
     #999#11 = #102#1;
     |LEE 101#999=;
     |SI FSalida ! 0;
         |DDEFECTO #999;
         #999#0  = enEmpresa;
         #999#1  = nEjer;
         #999#2  = nMesCont;
         #999#3  = nModelo;
         #999#4  = nComplem;
         #999#5  = nDepar;
         #999#6  = aTipo;
         #999#7  = #102#14;
         #999#8  = #105#5; || Ejercicio Declarado;
         #999#9  = #105#4;
         #999#10 = #102#0;
         #999#11 = #102#1;
         #999#12 = #102#2;
         #999#13 = #102#3;
         #999#14 = #102#4;
         #999#15 = #102#5;
         #999#38 = #102#27;
         #999#39 = #102#28;
         #999#40 = #102#22;
         |GRABA 020#999b;
     |FINSI;

     |SI #999#6 = "AR"; |O #999#6 = "IR";
         nSwEsta = 0;
         |PARA nCampo2 = 9;  |SI nCampo2 [ 29;  |HACIENDO nCampo2 = nCampo2 + 1;
               nCampo1 = nCampo2 + 32;
               #999nCampo1 = #105nCampo2;
         |SIGUE;
         #999#62 = #105#6;
     |SINO;
         #999#62 = #105#6;
     |FINSI;

     |GRABA 020#999a;
     |LIBERA #999;

     nSwHay   = 1;
     nPer     = nMesCont;
     aNif     = #102#14;
     nEjerRec = #105#5; || Ejercicio Declarado;
     nPerRec  = #105#4;
     nSwOp    = 2;
     aNombre  = #102#13;
     |HAZ GrabaAuxCab;
|FPRC;

|PROCESO Graba349;
     aNif = #102#14;
     |HAZ HazSeleccion;
     |SI nGraba ! 1; |ACABA; |FINSI;

     #999#0  = enEmpresa;
     #999#1  = nEjer;
     #999#2  = nMesCont;
     #999#3  = nModelo;
     #999#4  = nComplem;
     #999#5  = nDepar;
     #999#6  = aTipo;
     #999#7  = #102#14;
     #999#8  = 0;
     #999#9  = 0;
     |SI aTipo = "ER"; |O aTipo = "AR";  |O aTipo = "SR";  |O aTipo = "IR";
         |SI #105#5 ! 0;
             #999#8 = #105#5; || Ejercicio Declarado;
             #999#9 = #105#4;
         |FINSI;
     |FINSI;
     #999#10 = #102#0;
     #999#11 = #102#1;
     |LEE 101#999=;
     |SI FSalida ! 0;
         |DDEFECTO #999;
         #999#0  = enEmpresa;
         #999#1  = nEjer;
         #999#2  = nMesCont;
         #999#3  = nModelo;
         #999#4  = nComplem;
         #999#5  = nDepar;
         #999#6  = aTipo;
         #999#7  = #102#14;
         #999#8  = 0;
         #999#9  = 0;
         |SI aTipo = "ER"; |O aTipo = "AR";  |O aTipo = "SR";  |O aTipo = "IR";
             |SI #105#5 ! 0;
                 #999#8 = #105#5; || Ejercicio Declarado;
                 #999#9 = #105#4;
             |FINSI;
         |FINSI;
         #999#10 = #102#0;
         #999#11 = #102#1;
         #999#12 = #102#2;
         #999#13 = #102#3;
         #999#14 = #102#4;
         #999#15 = #102#5;
         #999#38 = #102#27;
         #999#39 = #102#28;
         #999#40 = #102#22;
         |GRABA 020#999b;
     |FINSI;

     |SI #999#6 = "A ";  |O #999#6 = "I ";
      |O #999#6 = "AR";  |O #999#6 = "IR";
         nSwEsta = 0;
         |PARA nCampo2 = 17;  |SI nCampo2 [ 35;  |HACIENDO nCampo2 = nCampo2 + 3;
               nCampo1 = nCampo2 - 1;
               nCampo3 = nCampo2 + 1;
               |SI #999nCampo2 = nPorce;
                   #999nCampo1 = #999nCampo1 + nBaseImpo;
                   #999nCampo2 = nPorce;
                   #999nCampo3 = #999nCampo3 + nCuota;
                   nSwEsta = 1;
                   |SAL;
               |FINSI;
         |SIGUE;

         |SI nSwEsta = 0;
             |PARA nCampo2 = 17;  |SI nCampo2 [ 35;  |HACIENDO nCampo2 = nCampo2 + 3;
                   nCampo1 = nCampo2 - 1;
                   nCampo3 = nCampo2 + 1;
                   |SI #999nCampo2 = 0; |Y #999nCampo1 = 0;  |Y #999nCampo3 = 0;
                       #999nCampo1 = #999nCampo1 + nBaseImpo;
                       #999nCampo2 = nPorce;
                       #999nCampo3 = #999nCampo3 + nCuota;
                       nSwEsta = 1;
                       |SAL;
                   |FINSI;
              |SIGUE;
         |FINSI;

         |SI nSwEsta = 0;
             #999#34 = #999#34 + nBaseImpo;
             #999#35 = 0;
             #999#36 = #999#36 + nCuota;
         |FINSI;

         #999#37 = #999#16 + #999#19 + #999#22 + #999#25 + #999#28 + #999#31 + #999#34;
     |SINO;
         #999#37 = #999#37 + nBaseImpo;
     |FINSI;

     |GRABA 020#999a;
     |LIBERA #999;

     nSwHay   = 1;
     nPer     = nMesCont;
     aNif     = #102#14;
     nEjerRec = #999#8; || Ejercicio Declarado;
     nPerRec  = #999#9;
     nSwOp    = 1;
     aNombre  = #102#13;
     |HAZ GrabaAuxCab;
|FPRC;

|| ////////////////////////////////////////////////////////////////
|PROCESO LeeConcepto349;
 aEspecial = "";
 aTriangul = "";
 #dsmom069#0 = #dsmom030#0;
 |LEE 041#dsmom069.=;
 |SI FSalida = 0;
     |SI #dsmom069#2 = "A"; #dsmom030#26 =  5; |FINSI;
     |SI #dsmom069#2 = "I"; #dsmom030#26 =  6; |FINSI;
     |SI #dsmom069#2 = "E"; #dsmom030#34 =  9; |FINSI;
     |SI #dsmom069#2 = "S"; #dsmom030#34 = 16; |FINSI;
     |SI #dsmom069#2 = "M"; #dsmom030#34 =  9; aEspecial = "M"; |FINSI;
     |SI #dsmom069#2 = "H"; #dsmom030#34 =  9; aEspecial = "H"; |FINSI;
     |SI #dsmom069#2 = "T"; #dsmom030#34 =  9; aEspecial = "T"; aTriangul = "X"; |FINSI;
     || aTriangul    = #dsmom069#3;

     #dsmom030#72 = #dsmom069#4;

     |SI #0#1 < 2018;
         |SI aEspecial = "T"; aEspecial = "E"; aTriangul = "X"; |FINSI;
     |FINSI;
 |FINSI;
|FPRC;

|PROCESO PonCasilla349;
     nDepartamento = nDepar;
     |SI #103#29 = "S"; |Y nDepar ! enActPrinci;
         enActividad = nDepar;
         |HAZ eTipoEmpModelo;
         |SI enSwTipoAct ! 1;
             nDepar = enActPrinci;
         |FINSI;
         nDepartamento = nDepar;
     |FINSI;

     |SI #103#5 = "N";  |ACABA;  |FINSI;

     || Clave A

     |SI nEsRecti = 0;
         aTipo = "";
     |FINSI;

     |SI nGrupo = 1;  |Y nSubGrupo = 5;
         |SI nPorce = 0;  |Y nCuota = 0;  |ACABA;  |FINSI;

         |SI nEsRecti = 0;  aTipo = "A";  |FINSI;
         |HAZ Graba349;
     |FINSI;

     |SI nGrupo = 8;  |Y nSubGrupo = 2;
         |SI nPorce = 0;  |Y nCuota = 0;  |ACABA;  |FINSI;

         |SI nEsRecti = 0;  aTipo = "A";  |FINSI;
         |HAZ Graba349;
     |FINSI;

     || Clave I

     |SI nGrupo = 1;  |Y nSubGrupo = 6;
         |SI nPorce = 0;  |Y nCuota = 0;  |ACABA;  |FINSI;

         |SI #30#72 = "N";  |ACABA;  |FINSI;

         |SI nEsRecti = 0;  aTipo = "I";  |FINSI;
         |HAZ Graba349;
     |FINSI;

     |SI nGrupo = 8;  |Y nSubGrupo = 3;
         |SI nPorce = 0;  |Y nCuota = 0;  |ACABA;  |FINSI;

         |SI #30#72 = "N";  |ACABA;  |FINSI;

         |SI nEsRecti = 0;  aTipo = "I";  |FINSI;
         |HAZ Graba349;
     |FINSI;

     || Clave E

     |SI nGrupo = 3;  |Y nSubGrupo = 9;

         |SI nEsRecti = 0;  aTipo = "E";  |FINSI;
         |HAZ Graba349;
     |FINSI;

     || Clave S

     |SI nGrupo = 3;  |Y nSubGrupo = 4;

         |SI nEsRecti = 0;  aTipo = "S";  |FINSI;
         |HAZ Graba349;
     |FINSI;
|FPRC;

|PROCESO Grupo1_349;
     nBaseImpo = (#103#6 / enConversor) ! EURODBMOD;
     nPorce    = #103#7;
     nCuota    = (#103#8 / enConversor) ! EURODBMOD;
     nGrupo    = 1;
     nSubGrupo = #30#26;
     |HAZ PonCasilla349;
|FPRC;

|PROCESO Grupo2_349;
     nBaseImpo = (#103#6 / enConversor) ! EURODBMOD;
     nPorce    = #103#7;
     nCuota    = (#103#8 / enConversor) ! EURODBMOD;
     nGrupo    = 2;
     nSubGrupo = #30#28;
     |HAZ PonCasilla349;
|FPRC;

|PROCESO Grupo3_349;
     nBaseImpo = (#103#6 / enConversor) ! EURODBMOD;
     nPorce    = #103#7;
     nCuota    = (#103#8 / enConversor) ! EURODBMOD;
     nGrupo    = 8;
     nSubGrupo = #30#30;
     |HAZ PonCasilla349;
|FPRC;

|PROCESO Grupo4_349;
     nBaseImpo = (#103#6 / enConversor) ! EURODBMOD;
     nPorce    = #103#7;
     nCuota    = (#103#8 / enConversor) ! EURODBMOD;
     nGrupo    = 9;
     nSubGrupo = #30#32;
     |HAZ PonCasilla349;
|FPRC;

|PROCESO Grupo5_349;
     nBaseImpo = (#103#6 / enConversor) ! EURODBMOD;
     nPorce    = #103#7;
     nCuota    = (#103#8 / enConversor) ! EURODBMOD;
     nGrupo    = 3;
     nSubGrupo = #30#34;
     |HAZ PonCasilla349;
|FPRC;

|PROCESO Grupo6_349;
     nBaseImpo = (#103#6 / enConversor) ! EURODBMOD;
     nPorce    = #103#7;
     nCuota    = (#103#8 / enConversor) ! EURODBMOD;
     nGrupo    = 4;
     nSubGrupo = #30#36;
     |HAZ PonCasilla349;
|FPRC;

|PROCESO LeeLinea349;
     aAlfa1 = #103#30; |QBF aAlfa1; |SI aAlfa1 = ""; #103#30 = #102#10; |FINSI;
     |SI aMulDep = "S";
         nDepar = #103#30;
         |SI nDepar = 0;  nDepar = 1;   |FINSI;

         nDepartamento = nDepar;
     |FINSI;

     nSwPasa = 0;
     #30#0 = #103#3;
     |LEE 040#30=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;
     |SI #30#4 = "N";  |ACABA;  |FINSI;

     |HAZ LeeConcepto349;

     |SI #30#26 ! 0; nSwPasa = 1;  |HAZ Grupo1_349;  |FINSI;
     |SI #30#28 ! 0; nSwPasa = 1;  |HAZ Grupo2_349;  |FINSI;
     |SI #30#30 ! 0; nSwPasa = 1;  |HAZ Grupo3_349;  |FINSI;
     |SI #30#32 ! 0; nSwPasa = 1;  |HAZ Grupo4_349;  |FINSI;
     |SI #30#34 ! 0; nSwPasa = 1;  |HAZ Grupo5_349;  |FINSI;
     |SI #30#36 ! 0; nSwPasa = 1;  |HAZ Grupo6_349;  |FINSI;
|FPRC;

|DEFBUCLE caivalin;
     #103#1;
     ;
     #102#0, #102#1, 01;
     #102#0, #102#1, 99;
     ;
     NULL, LeeLinea349;
|FIN;

|PROCESO LeeCabecera349;
     nDepar = #102#10;
     |SI aMulDep ! "S";
         |SI nDepar = 0;  nDepar = 1;   |FINSI;
     |FINSI;

     |DDEFECTO #105;
     #105#0 = #102#0;
     #105#1 = #102#1;
     |LEE 040#105=;
     |SI FSalida ! 0;  |DDEFECTO #105;  |FINSI;

     nEsRecti = 0;
     nMesCont = #102#5;
     aTipo    = "";

     |SI #105#6 ! 0;   |Y #105#8 = 0;
         #30#0 = #102#29;
         |LEE 040#30=;
         |SI FSalida ! 0;  |ACABA;  |FINSI;

         |SI #30#26 = 5;  aTipo = "AR";  |FINSI;
         |SI #30#26 = 6;  aTipo = "IR";  |FINSI;
         |SI #30#30 = 2;  aTipo = "AR";  |FINSI;
         |SI #30#30 = 3;  aTipo = "IR";  |FINSI;
         |SI #30#34 = 9;  aTipo = "ER";  |FINSI;
         |SI #30#34 = 4;  aTipo = "SR";  |FINSI;

         |HAZ LeeConcepto349;
         |SI aEspecial ! ""; aTipo = aEspecial + "R"; |FINSI;
         aEspecial = "";

         |SI aTipo ! "";
             nEsRecti = 1;
             |HAZ Graba349Rec;
         |FINSI;
     |FINSI;

     nDepartamento = nDepar;

     |BUCLE caivalin;
|FPRC;

|DEFBUCLE camaniva;
     #102#1;
     5;
     00, 0000000000, nDPeriodo;
     99, 9999999999, nHPeriodo;
     ;
     NULL, LeeCabecera349;
|FIN;
|| \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

|PROCESO LeoLasFacturas;
  |SI nSwLinD < 4; nSwLinD = 3; |FINSI;
  |PRINT; nPrint = 1;
  nSwLinea = 1;
  nSwLinD  = 4;
  #0#61 = #0#61 + 1;
  #0#62 = #0#62 + #999#37;
  #0#63 = #0#63 + #999#62;
  |SI nSwRecti = 1
      #0#64 = #0#64 + (#999#62 + #999#37);
  |FINSI;
|FPRC;

|DEFBUCLE LeoLasFacturas;
  #999#1;
  ;
  #998#0, #998#1, #998#2, #998#3, #998#4, #998#5, #998#6, #998#7, #998#8, #998#9, 00, 0000000001;
  #998#0, #998#1, #998#2, #998#3, #998#4, #998#5, #998#6, #998#7, #998#8, #998#9, 99, 9999999999;
  ;
  NULL, LeoLasFacturas;
|FIN;

|PROCESO LeoLinea349;
  #349#0 = #998#0;
  #349#1 = #998#1;
  #349#2 = #998#2;
  #349#3 = #998#3;
  #349#4 = #998#4;
  #349#5 = #998#5;
  #349#6 = #998#6;
  #349#7 = #998#7;
  #349#25 = #998#8;
  #349#26 = #998#9;
  |LEE 001#349=;
  |SI FSalida ! 0;
      |DDEFECTO #349;
      nSwLinD = 1;
  |SINO;
      nSwLinD = 2;
  |FINSI;
  |PRINT; nPrint = 1;
  nSwLinea = 1;
|FPRC;

|PROCESO EmpiezaNif;
  nSwLinea = 0;
  aNif = #998#7;
|FPRC;

|PROCESO EmpiezaTipo;
  nSwLinea = 0;
  aTipo = #998#6;
|FPRC;

|PROCESO TerminaNif;
  nSwLinea = 2;
  |SI #0#60 = "N";
      |PRINT; nPrint = 1;
  |FINSI;
|FPRC;

|PROCESO TerminaTipo;
  nSwLinea = 2;
  |PRINT; nPrint = 1;
|FPRC;

|PROCESO Imprimir;

  |SI #0#60 = "N";
      |SI aNif ! #998#7; |O nSwPrint = 0;
          |SI nSwPrint = 1; |HAZ TerminaNif; |FINSI;
          |HAZ EmpiezaNif;
      |FINSI;
  |SINO;
      |SI aTipo ! #998#6; |O nSwPrint = 0;
          |SI nSwPrint = 1; |HAZ TerminaTipo; |FINSI;
          |HAZ EmpiezaTipo;
      |FINSI;
  |FINSI;

  eaDesTipo = "Entrega";
  |SI #998#6 = "A "; eaDesTipo = "Adquisicion";     |FINSI;
  |SI #998#6 = "S "; eaDesTipo = "Prest.servicios"; |FINSI;
  |SI #998#6 = "I "; eaDesTipo = "Adqui.servicios"; |FINSI;
  nSwRecti = 0; aAlfa2 = #998#6 % 201;
  |SI aAlfa2 = "R";
      nSwRecti = 1;
                         eaDesTipo = "Rect. Entrega  ";
      |SI #998#6 = "AR"; eaDesTipo = "Rect. Adquisic."; |FINSI;
      |SI #998#6 = "SR"; eaDesTipo = "Rect. Pres.Ser."; |FINSI;
      |SI #998#6 = "IR"; eaDesTipo = "Rect. Adqu.Ser."; |FINSI;
  |FINSI;

  #0#61 = 0;
  #0#62 = 0;
  #0#63 = 0;
  #0#64 = 0;
  |SI #0#39 = "N";
      |PRINT; nPrint = 1;
  |SINO;
      |HAZ LeoLinea349;
      |BUCLE LeoLasFacturas;
      |SI nSwLinD = 4;
          nSwLinD = -1; |PRINT;
      |FINSI;
  |FINSI;

  aTipo = #998#6;
  aNif  = #998#7;
  nSwPrint = 1;
  nSwLinea = 1;
|FPRC;

|DEFBUCLE Impr_porTipo;
  #998#3;
  ;
  enActividad, "  ", nDPeriodo, 0000, 00;
  enActividad, "zz", nHPeriodo, 9999, 99;
  ;
  NULL, Imprimir;
|FIN;

|DEFBUCLE Impr_porNif;
  #998#2;
  ;
  enActividad, "            ", "  ", nDPeriodo, 0000, 00;
  enActividad, "zzzzzzzzzzzz", "zz", nHPeriodo, 9999, 99;
  ;
  NULL, Imprimir;
|FIN;

|PROCESO PorActividad;
  |SI #114#5 > "01.01.0000";
      |SI #114#5 > efHFecha;  |ACABA;  |FINSI;
  |FINSI;
  |SI #114#6 > "01.01.0000";
      |SI #114#6 < efDFecha;  |ACABA; |FINSI; || Baja
  |FINSI;

  nActividad = #114#1;
  aActividad = nActividad;
  aActividad = ("00" + aActividad) % -102;
  enActividad = #114#1;
  enEjer      = #0#1;
  |HAZ DatosEmpr_w30;

  nSwPrint = 0;
  |ABRE #349;
  |SI #0#60 = "N";
      |BUCLE Impr_porNif;
      |SI nSwPrint = 1;
          |HAZ TerminaNif;
      |FINSI;
  |SINO;
      |BUCLE Impr_porTipo;
      |SI nSwPrint = 1;
          |HAZ TerminaTipo;
      |FINSI;
  |FINSI;
  |CIERRA #349;
  |SI nSwPrint = 1;
      |PIEINF;
  |FINSI;
|FPRC;

|DEFBUCLE PorActividad;
  #114#1;
  ;
  enEmpresa, #0#37;
  enEmpresa, #0#38;
  e;
  NULL, PorActividad;
|FIN;

|PROCESO LEmpresa;

 enEmpresa  = #agifigen#0;
 nComplem   = -1;
 enEjer     = #0#1;

 |DDEFECTO #900;
 #900#0 = enEmpresa;
 #900#2 = #agifigen#1;
 #900#11 = "ACTIVA";
 |SI #agifigen#94 > "01.01.0000";
     #900#11 = "INACTIVA";
     |SI #0#24 = "N"; |ACABA; |FINSI;
 |FINSI;

|| ... Seleccion de Tipo de Empresa
  nSPin1 = #agifigen#87;
  enSwSelEmp = 1;
  |SI #0#41 = "S";
      |SI nSPin1 ] #0#25; |Y nSPin1 [ #0#26;
          enSwSelEmp = 0;
      |FINSI;
  |SINO;
      |SI nSPin1 = #0#27;
          enSwSelEmp = 0;
      |SINO;
          |PARA nCampo = 28;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
                |SI nSPin1 = #0nCampo; |Y nSPin1 ! 0;
                    enSwSelEmp = 0;
                    |SAL;
                |FINSI;
          |SIGUE;
      |FINSI;
  |FINSI;
  |SI enSwSelEmp = 1; |ACABA; |FINSI;

|| ------------------------------------------------------------------------
  || Lee Periodicidad Modelo 349
   |HAZ ElPeriodo;
   |SI nComplem = -1; |ACABA; |FINSI;
|| ------------------------------------------------------------------------

  || ... Primero comprueba que tiene Contabilidad
   |HAZ PreparaConta;
   |SI nSwConta = 0; |ACABA; |FINSI;
|| ------------------------------------------------------------------------

   |HAZ eLaActivPrin;

   |DELINDEX #998;
   |DELINDEX #999;
   nSwHay   = 0;

 || ... ... ... Paso las facturas
   |ABRE #998;
   |ABRE #999;
   |ABRE #30;
   |ABRE #dsmom069;
   |ABRE #105;
   |ABRE #114;
   |BUCLE camaniva;
   |CIERRA #114;
   |CIERRA #105;
   |CIERRA #dsmom069;
   |CIERRA #30;
   |CIERRA #999;
   |HAZ CierraConta;

   |BUCLE LeeModelo;
   |CIERRA #998;

   |SI nSwHay = 1;
       |BUCLE PorActividad;
   |FINSI;
|FPRC;

|DEFBUCLE agifigen;
  #agifigen#1;
  ;
  nDEmpresa;
  nHEmpresa;
  e;
  NULL, LEmpresa;
|FIN;

|| \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
|CALCULO Tipo3;  |TIPO 3;

    eaInac = #0#24;
    |DBASS aPath; |QBT aPath;

    nEjer    = #0#1;
    nPeriodo = #0#57;
    nModelo  = #0#59;
    aAlfa2 = nEjer;
    aAlfa1 = aAlfa2 % -102; nEjercicio = aAlfa1; ||ejercicio contable
    eaTituloL = #0#40; ||Titulo del Libro

    nPrint = 0;
    |IMPRE 0;
    |SI FSalida ! 0; |ACABA; |FINSI;

    informe = "dsmoy069";
    |SI #0#39 = "S";
        informe = "dsmoya69";
        |SI #0#60 = "O"; informe = "dsmoyb69"; |FINSI;
    |FINSI;

    |INFOR informe;
    |SI FSalida ! 0; |ACABA; |FINSI;

    aFichero = "8v" + Usuario;  |NOME_DAT #998 aFichero;
    aFichero = "9v" + Usuario;  |NOME_DAT #999 aFichero;

    |ABRE #4;
    |ABRE #95;
    |SI #0#2 ! 0;
        nDEmpresa = #0#2;
        nHEmpresa = #0#3;
        |BUCLE agifigen;
    |SINO;
        |PARA nPara1 = 4;  |SI nPara1 [ 23;  |HACIENDO nPara1 = nPara1 + 1;
              |SI #0nPara1 ! 0;
                  nDEmpresa = #0nPara1;
                  nHEmpresa = #0nPara1;
                  |BUCLE agifigen;
              |FINSI;
        |SIGUE;
    |FINSI;
    |CIERRA #95;
    |CIERRA #4;

    |SI nPrint = 0;
        |MENAV "     Seleccion Vacia.";
    |FINSI;
    |FININF;
    |FINIMP;

    |DELINDEX #998;
    |DELINDEX #999;
|FCAL;

|PROGRAMA;
     |CLS;
     |CABEZA "Inf.Chequeo Modelo 349";

     |ABRE #0;
     |LEE 001#0p;
     |SI FSalida ! 0;
         |DDEFECTO #0;
         fFecha = ~;
         aAlfa1 = fFecha; aAlfa1 = aAlfa1 % -104;
         #0#1 = aAlfa1;

         |GRABA 020#0c;
     |FINSI;
     |PINPA #0#0;
     |PINDA #0#0;

     |ENDATOS #1#0;

     |GRABA 020#0a;
     |CIERRA #0;
|FPRO;
