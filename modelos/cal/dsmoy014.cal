|FICHEROS;
     dsmoy014 #0;

     dsmom001 #1;
     :/integral/def/dsam0000 #2;   ||Clientes
     dsmom004 #4;

     dsmoc130 #230;
     dsmoc131 #231;
     dsmod130 #430;
     dsmod131 #431;

    :/basica/def/agicen14 #114;
    :/basica/def/agifigen #118;
    :/basica/def/agim0019 #119;

     dsmow032 #900;          ||Def de impresion
     dsmow037 #901;          ||Comuneros auxiliar
     dsmow108 #902;          ||Retenciones contables
     dsmow014 #999;

     dsmom022 #922;
    :/contagen/def/camaasil #801;

     dsmoc13@  #998;
|FIN;

|VARIABLES;
     aFichero   = "";
     nCampo     = 0;
     nDEmpresa  = 0;
     nHEmpresa  = 0;
     nLaEmpresa  = 0;
     nGTempo     = 0;
     nEstado     = 0;

     nSPin1      = 0;

     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     nPara1 = 0;
     nPara2 = 0;
     nNume1 = 0;
     nNume2 = 0;
     nNume3 = 0;
     nNume4 = 0;
     &nParcial = 0;
     &nActi    = 0;
     &nTotal   = 0;

     SwHayDatos = 0;
     SwHayComun = 0;

     fFecha  = @;

     &enSwNo   = 0;
     &SwLinea  = 0;
     &aTp0     = "%";
     &aTp1     = "Pagos a Cta.";
     &aTp2     = "Retenciones ";
     &nTp3     = 0;
     &enFrase  = 0;
     &eaActi   = "";

     nImport1  = 0;
     nImport2  = 0;
     nImport3  = 0;
     nImp1    = 0;
     nImp2    = 0;
     nImp3    = 0;

     nSwCom   = 0;
     nNumEmp  = 0;
     nDActEmp  = 0;
     nHActEmp  = 0;

     nCtRetencion = 0;
     nDepar       = 0;
     nSumaCtas    = 0;
     fFechaIni    = @;
     fFechaFin    = @;
     aUno         = "";
     aDos         = "";
     nTrim        = 0;
     fecha1       = @;
     fecha2       = @;
     fecha3       = @;
     fecha4       = @;
     &enEjerR     = 0;
     &enCodRen    = 0;
     &eaCodRen    = "";
     nPer         = 0;
     nComplem     = 0;
     aMas         = "";
     aBase        = "";
     aDef         = "";
|FIN;

|INCLUYE i_variar;
|INCLUYE i_varcon;
|INCLUYE i_varlib;

|| //////////////////// Calculos de Pantalla \\\\\\\\\\\\\\\\\\\\\\\\\\
|PROCESO losDefectos; |TIPO 7;
 fFecha = ~; aAlfa1 = fFecha;
 aAlfa1 = aAlfa1 % -104;
 #0#1 = aAlfa1; |PINTA #0#1;
|FPRC;

|PROCESO Tipo7;  |TIPO 7;
     |SI enEmpresa ! 0;
         #0#2  = enEmpresa;  |PINTA #0#2;
         #0#3  = enEmpresa;  |PINTA #0#3;

         |C_M #0#2, 1, "N";
         |C_M #0#3, 1, "N";
     |FINSI;
|FPRC;

|PROCESO Parrilla; |TIPO 0;
     |SI #0#2 = 0;
         #0#2 = 0;  |PINTA #0#2;
         #0#3 = 0;  |PINTA #0#3;  |C_M #0#3, 1, "N";
         |PARA nCampo = 4;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |SINO;
         |SI enEmpresa = 0;
             |C_M #0#2, 1, "S";
             |C_M #0#3, 1, "S";
         |FINSI;

         |PARA nCampo = 4;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "N";
               #0nCampo = 0;  |PINTA #0nCampo;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO NoMasEmpresas; |TIPO 0;
     |SI #0Campo = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               #0nCampo = 0;  |C_M #0nCampo, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 23;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO YaSeCual; |TIPO 7;
 |SI enEmpresa ! 0;
     #0#46 = "S"; |PINTA #0#46;
     #0#24 = "S"; |PINTA #0#24;
     #0#25 = 00;  |PINTA #0#25;
     #0#26 = 99;  |PINTA #0#26;
     |C_M #0#24, 1, "N";
     |C_M #0#25, 1, "N";
     |C_M #0#26, 1, "N";
     |C_M #0#46, 1, "N";
 |FINSI;
|FPRC;

|PROCESO SelTipo0; |TIPO 0;
 |SI #0#46 = "N";
     #0#25 = 0;  |PINTA #0#25;  |C_M #0#25, 1, "N";
     #0#26 = 99;  |PINTA #0#26;  |C_M #0#26, 1, "N";
     |PARA nCampo = 27;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           |C_M #0nCampo, 1, "S";
     |SIGUE;
 |SINO;
     |SI enEmpresa = 0;
         |C_M #0#25, 1, "S";
         |C_M #0#26, 1, "S";
     |FINSI;
     |PARA nCampo = 27;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           |C_M #0nCampo, 1, "N";
           #0nCampo = 0;  |PINTA #0nCampo;
     |SIGUE;
 |FINSI;
|FPRC;

|PROCESO SelTipo1;
 |SI #0Campo = 0;
     |PARA nCampo = Campo + 1;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           #0nCampo = 0;  |C_M #0nCampo, 1, "N";
     |SIGUE;
 |SINO;
     |PARA nCampo = Campo + 1;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
           |C_M #0nCampo, 1, "S";
     |SIGUE;
 |FINSI;
|FPRC;

|| **********************************************************************************
|PROCESO ImpCuentas;
   |SI nActi    = -1;
       nActi    = #902#1;
       nParcial = 0;
       eaActi   = nActi;
       eaActi   = ("00" + eaActi) % -102;
   |FINSI;
   |SI nActi ! #902#1;
       nNume4   = SwLinea;
       SwLinea  = 6; |PRINT;
       nParcial = 0;
       SwLinea  = nNume4;
       nActi    = #902#1;
       eaActi   = nActi;
       eaActi   = ("00" + eaActi) % -102;
   |FINSI;

   |PRINT;
   SwLinea = 4;
   nParcial = nParcial + #902#9;
   nTotal   = nTotal   + #902#9;
|FPRC;

|DEFBUCLE ImpCuentas;
 #902#1;
 ;
 enEmpresa, 00, enEjer, "            ";
 enEmpresa, 99, enEjer, "zzzzzzzzzzzz";
 ;
 NULL, ImpCuentas;
|FIN;

|PROCESO ImpCtasRet;
   SwLinea  = 3;
   nActi    = -1;
   nParcial = 0;
   nTotal   = 0;
   |BUCLE ImpCuentas;
   |SI nActi ! -1;
       SwLinea = 6; |PRINT;
       SwLinea = 5; |PRINT;
   |FINSI;
|FPRC;
|| **********************************************************************************
|PROCESO ImpComuneros;
   |PRINT;
   SwLinea = 2;
|FPRC;

|DEFBUCLE ImpComuneros;
 #901#1;
 ;
 00001;
 99999;
 ;
 NULL, ImpComuneros;
|FIN;
|| **********************************************************************************

|PROCESO LaSuma2;
  #900#29 = 0;
  |SI #900#25 > 0; #900#29 = #900#29 + #900#25; |FINSI;
  |SI #900#26 > 0; #900#29 = #900#29 + #900#26; |FINSI;
  |SI #900#27 > 0; #900#29 = #900#29 + #900#27; |FINSI;
  |SI #900#28 > 0; #900#29 = #900#29 + #900#28; |FINSI;
|FPRC;

|PROCESO LaSuma;
 |SI enPeriodo = 3;   aAlfa1 = "01.01." + enEjer;  |FINSI;
 |SI enPeriodo = 6;   aAlfa1 = "01.04." + enEjer;  |FINSI;
 |SI enPeriodo = 9;   aAlfa1 = "01.07." + enEjer;  |FINSI;
 |SI enPeriodo = 12;  aAlfa1 = "01.10." + enEjer;  |FINSI;
 fFecha = aAlfa1;

 |SI enPeriodo [ 3;                   nNume1 = 25; nNume2 = 30; |FINSI;
 |SI enPeriodo > 3; |Y enPeriodo [ 6; nNume1 = 26; nNume2 = 31; |FINSI;
 |SI enPeriodo > 6; |Y enPeriodo [ 9; nNume1 = 27; nNume2 = 32; |FINSI;
 |SI enPeriodo > 9;                   nNume1 = 28; nNume2 = 33; |FINSI;

 #900nNume1 = #900nNume1 + nImp1;
 #900nNume2 = #900nNume2 + nImp2;
 #900#34    = #900nNume2;

 SwHayDatos = 1;
|FPRC;

|| ///////////////////////////////////////////////////////////////////////

|PROCESO LSComunero;
     |SI #0#1 = 2008;
         enFrase = 1;
     |FINSI;

     nEstado = 0;
     #901#0 = #1#3;
     |LEE 001#901=;
     |SI FSalida ! 0;
         nEstado = 1;
         |DDEFECTO #901;
         #901#0 = #1#3;

         |ABRE #2;
         #2#0 = #1#3;
         |LEE 040#2=;
         |SI FSalida ! 0;  |DDEFECTO #2;  |FINSI;
         |CIERRA #2;

         #901#1 = #1#5;   || Nombre
         #901#2 = #2#3;   || NIF

         |ABRE #114;
         #114#0 = #2#0; || Empresa
         #114#1 = #1#4;
         |LEE 041#114=;
         |SI FSalida = 0;
             enCodRen = #114#18;  ||Codigo en Renta
             |SI enEjerR ! 0; |HAZ CodigoRen; |FINSI;
             #901#14 = enCodRen;  ||Codigo en Renta
         |FINSI;
         |CIERRA #114;
     |FINSI;

     #901#3 = #1#7;   || % Participacion

     nImport1 = nImp1;
     nImport2 = nImp2;
     nImport3 = nImp1;

     |SI enPeriodo [ 3;                   nNume1 = 4; nNume2 = 9;  nNume3 = 15; |FINSI;
     |SI enPeriodo > 3; |Y enPeriodo [ 6; nNume1 = 5; nNume2 = 10; nNume3 = 16; |FINSI;
     |SI enPeriodo > 6; |Y enPeriodo [ 9; nNume1 = 6; nNume2 = 11; nNume3 = 17; |FINSI;
     |SI enPeriodo > 9;                   nNume1 = 7; nNume2 = 12; nNume3 = 18; |FINSI;

     #901nNume1 = #901nNume1 + nImport1;
     #901nNume2 = #901nNume2 + nImport2;
     #901#8     = #901#8  + nImport1;
     #901#13    = nImport2;

     #901nNume3 = #901nNume3 + nImport3;
     #901#19    = #901#19  + nImport3;

     |SI nEstado = 0; |GRABA 020#901a; |FINSI;
     |SI nEstado ! 0; |GRABA 020#901n; |FINSI;
     SwHayComun = 1;
|FPRC;

|| ****************************************************
|| ///////////////////////////////////////////////////////////
|| ... los def de impresion  d130 y d131
|PROCESO modelo431_0;
     enPeriodo = #431#2;
     nImp1     = #431#33 + #431#41;
     nImp2     = #431#27 + #431#31;

     |SI nSwCom = 0;
         |HAZ LaSuma;
     |SINO;
         |HAZ LSComunero;
     |FINSI;
|FPRC;

|DEFBUCLE modelo431;
     #431#1;
     ;
     nNumEmp, #999#1, nPer, 000, nComplem, 00;
     nNumEmp, #999#1, nPer, 999, nComplem, 99;
     ;
     NULL, modelo431_0;
|FIN;

|PROCESO modelo430_0;
     enPeriodo = #430#2;

     |SI #430#1 [ 2007;
         nImp1     = #430#17;
     |SINO;
         |SI #430#1 = 2008;  |Y #430#2 = 3;
             nImp1 = #430#17;
         |SINO;
             nImp1 = #430#23 + #430#18;  || aunque sea complementaria
         |FINSI;
     |FINSI;

     nImp2     = #430#11 + #430#15;

     |SI nSwCom = 0;
        |HAZ LaSuma;
     |SINO;
        |HAZ LSComunero;
     |FINSI;
|FPRC;

|DEFBUCLE modelo430;
     #430#1;
     ;
     nNumEmp, #999#1, nPer, 000, nComplem, 00;
     nNumEmp, #999#1, nPer, 999, nComplem, 99;
     ;
     NULL, modelo430_0;
|FIN;

|PROCESO ModeloImp;

     |ABRE #4;
     |PARA nPer = 3; |SI nPer [ 12;|HACIENDO nPer = nPer + 3;
           nComplem = -1;
           #4#0 = nNumEmp;
           #4#1 = enEjer;
           #4#2 = nPer;
           #4#3 = enModelo;
           #4#4 = 99;
           |LEE 040#4];
           |SI FSalida = 0;
               |LEE 040#4a;
           |SINO;
               |LEE 040#4u;
           |FINSI;
           |SI FSalida = 0; |Y #4#0 = nNumEmp;
               |Y #4#1 = enEjer; |Y #4#2 = nPer; |Y #4#3 = enModelo;
                  nComplem = #4#4;
           |FINSI;
           |SI nComplem ! -1;
               |SI enModelo = 130;  |BUCLE modelo430;  |FINSI;
               |SI enModelo = 131;  |BUCLE modelo431;  |FINSI;
           |FINSI;
     |SIGUE;
     |CIERRA #4;
|FPRC;

|| -------------------------------------------------
|PROCESO modelo131_0;
     #998#0 = #231#0;
     #998#1 = #231#1;
     #998#2 = #231#2;
     #998#3 = #231#3;
     #998#4 = #231#4 + 1;
     #998#5 = #231#5;
     |LEE 041#998=;
     |SI FSalida = 0;
         |ACABA;
     |FINSI;

     enPeriodo = #231#2;
     nImp1     = #231#11 + #231#14;
     nImp2     = #231#12 + #231#15;

     |HAZ LaSuma;
|FPRC;

|DEFBUCLE modelo131;
     #231#1;
     ;
     nNumEmp, #999#1, nPer, 000, nComplem, nDActEmp;
     nNumEmp, #999#1, nPer, 999, nComplem, nHActEmp;
     ;
     NULL, modelo131_0;
|FIN;

|PROCESO modelo130_0;
     #998#0 = #230#0;
     #998#1 = #230#1;
     #998#2 = #230#2;
     #998#3 = #230#3;
     #998#4 = #230#4 + 1;
     #998#5 = #230#5;
     |LEE 041#998=;
     |SI FSalida = 0;
         |ACABA;
     |FINSI;

     enPeriodo = #230#2;
     nImp1     = #230#33;
     nImp2     = #230#31;

     |HAZ LaSuma;
|FPRC;

|DEFBUCLE modelo130;
     #230#1;
     ;
     nNumEmp, #999#1, 00, enModelo, 00, nDActEmp;
     nNumEmp, #999#1, 99, enModelo, 99, nHActEmp;
     ;
     NULL, modelo130_0;
|FIN;

|| ***********************************************

|PROCESO RelComuneros0;
     |SI #1#8 > "01.01.0000";
         |SI #1#8 > efHFecha; |ACABA;  |FINSI;
     |FINSI;
     |SI #1#9 > "01.01.0000";
         |SI #1#9 < efDFecha;  |ACABA;  |FINSI;
     |FINSI;

     nSwCom   = 1;
     nNumEmp  = #1#3;
     nDActEmp = 00;
     nHActEmp = 99;

     |HAZ ModeloImp;
|FPRC;

|DEFBUCLE RelComumeros;
     #1#1;
     ;
     #999#0, 01, 0001;
     #999#0, 99, 9999;
      e;
     NULL, RelComuneros0;
|FIN;

|PROCESO LosComuneros;
        |SI enModelo = 130; aDef = "dsmoc130.mas"; |FINSI;
        |SI enModelo = 131; aDef = "dsmoc131.mas"; |FINSI;

        |DBASE aBase;  |QBF aBase;
        aMas = aBase + "def/" + aDef;
        |CARGA_DEF aMas, dsmoc13@;
        |SI FSalida ! 0;
            |MENAV "    Error al Cargar el Def " + aDef;
            |ACABA;
         |FINSI;

         nSwCom   = 0;
         nNumEmp  = #999#0;
         nDActEmp = 00;
         nHActEmp = 99;

         |ABRE #998;             || sumo el de trabajo para la Comunidad
         |SI enModelo = 130;
            |BUCLE modelo130;
         |SINO;
            |BUCLE modelo131;
         |FINSI;
         |CIERRA #998;

         |ABRE #901;
         nSwCom  = 1;
         |BUCLE RelComumeros;
         |CIERRA #901;

         |DESCARGA_DEF #dsmoc13@;
|FPRC;

|| -------------------------------------------------------------------------

|| ///////////////////////////////////////////////////////////
|PROCESO Busco131;
     enModelo = 131;
     |DELINDEX #901;
     SwHayDatos = 0;
     SwHayComun = 0;
     |PDEFECTO #900, 25, 50;

     |SI aCoBien = "N";
         nNumEmp  = #999#0;
         nSwCom   = 0;
         nDActEmp = 1;
         nHActEmp = 99;

         |HAZ ModeloImp;
     |SINO;

         |HAZ LosComuneros;

     |FINSI;

     |SI SwHayDatos = 1;
         |HAZ LaSuma2;
         |SI #900#25 ! 0; |O #900#26 ! 0; |O #900#27 ! 0; |O #900#28 ! 0;
             |O #900#30 ! 0; |O #900#31 ! 0; |O #900#32 ! 0; |O #900#33 ! 0;
                SwLinea = 0;
                nTp3    = 131;
                aAlfa1  = #900#50; |QBF aAlfa1;
                aAlfa1 = aAlfa1 + " " + nTp3 + " -";
                #900#50 = aAlfa1;
                |PRINT;
                |SI swerror = 0;
                    |HAZ ImpCtasRet;
                |FINSI;
                SwLinea = 1;
                |SI SwHayComun ! 0;  |BUCLE ImpComuneros;  |FINSI;
                |PIEINF;
         |FINSI;
     |FINSI;
|FPRC;

|| -------------------------------------------------------------------------

|PROCESO Busco130;

     enModelo = 130;
     |DELINDEX #901;
     SwHayDatos = 0;
     SwHayComun = 0;
     enFrase    = 0;
     |PDEFECTO #900, 25, 50;

     |SI aCoBien = "N";
         nNumEmp = #999#0;
         nSwCom  = 0;
         nDActEmp = 1;
         nHActEmp = 99;

         |HAZ ModeloImp;

     |SINO;
         |HAZ LosComuneros;
     |FINSI;

     |SI SwHayDatos = 1;
         |HAZ LaSuma2;
         |SI #900#25 ! 0; |O #900#26 ! 0; |O #900#27 ! 0; |O #900#28 ! 0;
             |O #900#30 ! 0; |O #900#31 ! 0; |O #900#32 ! 0; |O #900#33 ! 0;
                SwLinea = 0;
                nTp3    = 130;
                aAlfa1  = #900#50; |QBF aAlfa1;
                aAlfa1 = aAlfa1 + " " + nTp3 + " -";
                #900#50 = aAlfa1;
                |PRINT;
                |SI swerror = 0;
                    |HAZ ImpCtasRet;
                |FINSI;
                SwLinea = 1;
                |SI SwHayComun ! 0;  |BUCLE ImpComuneros;  |FINSI;
                |PIEINF;
         |FINSI;
     |FINSI;

|FPRC;

|PROCESO LeeDatosEmpresa;
    eaInac    = #0#24;
    eaTituloL = #0#45; ||Titulo del Libro
    |HAZ DatosEmpr_w32Con;
|FPRC;

|PROCESO Imprime;
  enEmpresa = #999#0;

  |HAZ LeeDatosEmpresa;

  |SI aCoBien = "S"; |Y #0#47 = "N";
      |ACABA;
  |FINSI;

  |HAZ BuscoRetencion;

  |SI  swNoExis = 0;
       |HAZ Busco130;
       |HAZ Busco131;
  |FINSI;
|FPRC;

|DEFBUCLE dsmow014M;
     #999#1;
     ;
     00000, 0000, 00;
     99999, 9999, 99;
     ;
     NULL, Imprime;
|FIN;

|PROCESO Imprimir;
     aAlfa2 = #0#1;
     aAlfa1 = "01.01." + aAlfa2;
     aAlfa2 = "31.12." + aAlfa2;
     efDFecha  = aAlfa1;     efHFecha  = aAlfa2;

     |IMPRE 0;
     |SI FSalida ! 0;  |ACABA;  |FINSI;
     |INFOR "dsmoy014";
     |SI FSalida ! 0;  |FINIMP; |ACABA;  |FINSI;

     |BUCLE dsmow014M;

     |FININF;
     |FINIMP;
|FPRC;

|| /////////////////////////////////////////////////////////////////////
|PROCESO GrabaTempo;
    enEmpresa  = #4#0;

   || ... Seleccion de Tipo de Empresa

     #agifigen#0 = enEmpresa;
     |LEE 041#agifigen.=;
     |SI FSalida ! 0;
         |DDEFECTO #agifigen;
     |FINSI;

     nSPin1 = #agifigen#87;

     eaEstadoEmp = "S";
     |SI #agifigen#94 > "01.01.0000";
         eaEstadoEmp = "N";
         |SI #0#24 = "N"; |ACABA; |FINSI;
     |FINSI;

     enSwSelEmp = 1;
     |SI #0#46 = "S";
         |SI nSPin1 ] #0#25; |Y nSPin1 [ #0#26;
             enSwSelEmp = 0;
         |FINSI;
     |SINO;
         |SI nSPin1 = #0#27;
             enSwSelEmp = 0;
         |SINO;
             |PARA nCampo = 28;  |SI nCampo [ 36;  |HACIENDO nCampo = nCampo + 1;
                   |SI nSPin1 = #0nCampo; |Y nSPin1 ! 0;
                       enSwSelEmp = 0;
                       |SAL;
                   |FINSI;
             |SIGUE;
         |FINSI;
     |FINSI;

     |SI enSwSelEmp = 1; |ACABA; |FINSI;

   || ------------------------------------------------------------------------

     #999#0  = enEmpresa;
     #999#1  = #4#1;
     #999#2  = 99;   ||  uno solo por empresa #4#2;
     |LEE 001#999=;
     |SI FSalida ! 0;
         |DDEFECTO #999;
         #999#0  = #4#0;
         #999#1  = #4#1;
         #999#2  = 99; || uno solo por empresa  #4#2;
         #999#5  = #4#3;
         #999#6  = eaEstadoEmp;
         #999#7  = #4#4;
         |GRABA 020#999n;
         nGTempo = 1;
     |FINSI;
|FPRC;

|DEFBUCLE dsmom004;
     #4#1;
     ;
     nDEmpresa, #0#1, 00, 130, 00;
     nHEmpresa, #0#1, 99, 131, 99;
     ;
     NULL, GrabaTempo;
|FIN;

|PROCESO Tipo3;  |TIPO 3;

    enEjer  = #0#1;
    enEjerR = #0#1;
    enSwNo  = 0;
    aFichero = ("w14" + Usuario) % 108;
    |NOME_DAT #999 aFichero;
    |ABRE #999;  |CIERRA #999;  |DELINDEX #999;

    aFichero = ("w37" + Usuario) % 108;
    |NOME_DAT #901 aFichero;
    |ABRE #901;  |CIERRA #901;  |DELINDEX #901;

    aFichero = ("8w" + Usuario) % 108;
    |NOME_DAT #902 aFichero;
    |ABRE #902;  |CIERRA #902;  |DELINDEX #902;

    |ABRE #999;
    |ABRE #agifigen;
    nGTempo = 0;   ||Busco Empresas Contables
    |SI #0#2 ! 0;
        nDEmpresa = #0#2;
        nHEmpresa = #0#3;
        |BUCLE dsmom004;
    |SINO;
        |PARA nPara1 = 4;  |SI nPara1 [ 23;  |HACIENDO nPara1 = nPara1 + 1;
              |SI #0nPara1 ! 0;
                  nDEmpresa = #0nPara1;
                  nHEmpresa = #0nPara1;
                  |BUCLE dsmom004;
              |FINSI;
        |SIGUE;
    |FINSI;
    |CIERRA #agifigen;
    |CIERRA #999;

    |SI nGTempo = 0;    || No existe ninguna empresa
        |MENAV "    Error. No existe ninguna Empresa dentro de la Seleccion ";
    |SINO;
        |HAZ Imprimir;
    |FINSI;

    |DELINDEX #901;
    |DELINDEX #999;
    |DELINDEX #902;
|FPRC;


|PROCESO CalCtas;

 |SI #801#0 = 0; |ACABA; |FINSI;

 nDepar = #801#21;
 |SI nDepar = 0;  nDepar = 1;   |FINSI;

 nTrim = 1;
 |SI #801#1 > fecha1; nTrim = 2; |FINSI;
 |SI #801#1 > fecha2; nTrim = 3; |FINSI;
 |SI #801#1 > fecha3; nTrim = 4; |FINSI;

 |SI #801#8 = "H"; #801#9 = 0; |FINSI;
 nSumaCtas = (#801#9 / enConversor) ! EURODBMOD;

 #902#0 = enEmpresa;
 #902#1 = nDepar;
 #902#2 = enEjer;
 #902#3 = #922#0;
 |LEE 101#902=;
 |SI FSalida ! 0;
     |DDEFECTO #902;
     #902#0 = enEmpresa;
     #902#1 = nDepar;
     #902#2 = enEjer;
     #902#3 = #922#0;
     #902#4 = #922#1;
     |GRABA 020#902b;
 |FINSI;

 |SI #922#3 = "-"; nSumaCtas = - nSumaCtas;  |FINSI;
 |SI nTrim = 1; #902#5 = #902#5 + nSumaCtas; |FINSI;
 |SI nTrim = 2; #902#6 = #902#6 + nSumaCtas; |FINSI;
 |SI nTrim = 3; #902#7 = #902#7 + nSumaCtas; |FINSI;
 |SI nTrim = 4; #902#8 = #902#8 + nNume2; |FINSI;
 #902#9 = #902#9 + nSumaCtas;
 |GRABA 020#902a;
 |LIBERA #902;
|FPRC;

|DEFBUCLE LeeApuntes;
  #801#3;
  0;
  aUno, fFechaIni, 000001, 0001, 01;
  aDos, fFechaFin, 999999, 9999, 98;
  e;
  NULL, CalCtas;
|FIN;

|PROCESO DatosContables;
     nSumaCtas = 0;
     aUno = #922#0;
     aDos = #922#0;
     |BUCLE LeeApuntes;
|FPRC;

|DEFBUCLE dsmom022;
     #922#1;
     ;
     "            ";
     "zzzzzzzzzzzz";
     ;
     NULL, DatosContables;
|FIN;

|PROCESO BuscoRetencion;
  swerror    =  0;
  enPerConta = -1;      || No sabemos el Periodo Contable
  enSwSinMen = 1;
  |HAZ SituaContagen;
  |SI swerror = 1;
      || ... |MENAV "    Error. No existen Datos Contables de esta Empresa ";
      |ACABA;
  |FINSI;
  |HAZ EnConversor;

  nCtRetencion = 0;
  aAlfa1 = enEjer;
  aAlfa2 = "01.01." + aAlfa1; fFechaIni = aAlfa2;
  aAlfa3 = "31.12." + aAlfa1; fFechaFin = aAlfa3;
  aAlfa2 = "31.03." + aAlfa1; fecha1     = aAlfa2;
  aAlfa2 = "30.06." + aAlfa1; fecha2     = aAlfa2;
  aAlfa2 = "30.09." + aAlfa1; fecha3     = aAlfa2;

  |PATH_DAT #801 aPathConta;
  |ABRE #902;
  |BUCLE dsmom022;
  |CIERRA #902;
|FPRC;


/*
|| Calculo anterior
|PROCESO modelo131_0;
     #998#0 = #231#0;
     #998#1 = #231#1;
     #998#2 = #231#2;
     #998#3 = #231#3;
     #998#4 = #231#4 + 1;
     #998#5 = #231#5;
     |LEE 041#998=;
     |SI FSalida = 0;
         |ACABA;
     |FINSI;

     enPeriodo = #231#2;
     nImp1     = #231#11 + #231#14;    ||  #231#33;
     nImp2     = #231#12 + #231#15;    ||  #231#27 + #231#31;

|| ... ModeloImpComumero
     |DDEFECTO #431;
     #431#0 = #231#0;
     #431#1 = #231#1;
     #431#2 = #231#2;
     #431#3 = #231#3;
     #431#4 = #231#4;
     #431#5 = 00;
     |LEE 040#431=;
     nImp3 = #431#33 + #431#41;

     |HAZ LaSuma;
     |SI nSwCom = 1;
         |HAZ LSComunero;
     |FINSI;
|FPRC;

|DEFBUCLE modelo131;
     #231#1;
     ;
     nNumEmp, #999#1, nPer, 000, nComplem, nDActEmp;
     nNumEmp, #999#1, nPer, 999, nComplem, nHActEmp;
     ;
     NULL, modelo131_0;
|FIN;

|PROCESO modelo130_0;
     #998#0 = #230#0;
     #998#1 = #230#1;
     #998#2 = #230#2;
     #998#3 = #230#3;
     #998#4 = #230#4 + 1;
     #998#5 = #230#5;
     |LEE 041#998=;
     |SI FSalida = 0;
         |ACABA;
     |FINSI;

     enPeriodo = #230#2;
     nImp1     = #230#33;   || #230#17; del d130
     nImp2     = #230#31;   || #230#11 + #230#15;

|| ... ModeloImpComumero
     |DDEFECTO #430;
     #430#0 = #230#0;
     #430#1 = #230#1;
     #430#2 = #230#2;
     #430#3 = #230#3;
     #430#4 = #230#4;
     #430#5 = 00;
     |LEE 040#430=;
     nImp3 = #430#23 + #430#18;

     |HAZ LaSuma;
     |SI nSwCom = 1;
         |HAZ LSComunero;
     |FINSI;
|FPRC;

|DEFBUCLE modelo130;
     #230#1;
     ;
     nNumEmp, #999#1, 00, 000, 00, nDActEmp;
     nNumEmp, #999#1, 99, 999, 99, nHActEmp;
     ;
     NULL, modelo130_0;
|FIN;

|PROCESO RelComuneros0;
     |SI #1#8 > "01.01.0000";
         |SI #1#8 > efHFecha; |ACABA;  |FINSI;
     |FINSI;
     |SI #1#9 > "01.01.0000";
         |SI #1#9 < efDFecha;  |ACABA;  |FINSI;
     |FINSI;

     nSwCom   = 1;
     nNumEmp  = #1#3;
     nDActEmp = #1#4;
     nHActEmp = #1#4;

     |ABRE #998;
     |SI enModelo = 130;
         |ABRE #430;
         |BUCLE modelo130;
         |CIERRA #430;
     |SINO;
         |ABRE #431;
         |BUCLE modelo131;
         |CIERRA #431;
     |FINSI;
     |CIERRA #998;
|FPRC;

|DEFBUCLE RelComumeros;
     #1#1;
     ;
     #999#0, 01, 0001;
     #999#0, 99, 9999;
      e;
     NULL, RelComuneros0;
|FIN;

|PROCESO LosComuneros;
        |SI enModelo = 130; aDef = "dsmoc130.mas"; |FINSI;
        |SI enModelo = 131; aDef = "dsmoc131.mas"; |FINSI;

        |DBASE aBase;  |QBF aBase;
        aMas = aBase + "def/" + aDef;
        |CARGA_DEF aMas, dsmoc13@;
        |SI FSalida ! 0;
            |MENAV "    Error al Cargar el Def " + aDef;
            |ACABA;
         |FINSI;

         |ABRE #901;
         nSwCom  = 1;
         |BUCLE RelComumeros;
         |CIERRA #901;

         |DESCARGA_DEF #dsmoc13@;
|FPRC;
*/
