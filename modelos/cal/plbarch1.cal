|FICHEROS;
     Ref0001@;
     dsarm004@;
     dsarm005@;
|FIN;

|VARIABLES;
     nNume               = 0;
     nHandle             = 0;
     nCampo              = 0;
     nCampoFecha         = 0;
     nDesdeCampo         = 0;
     nHastaCampo         = 0;

     aUbicacion          = "";
     aDocumento          = "";
     aPathDatos          = "";
     aPathDestino        = "";
     aBass               = "";
     aDef                = "";
     aAlfa               = "";
     aAlfa1              = "";
     aAlfa2              = "";
     aAlfa3              = "";
     aImpresora          = "";
     aDescCampoFecha     = "";
     aFecha              = "";
     aHora               = "";
     aMensaje            = "";
     aIPRemoto           = "";

     fFecha              = @;

     {1}aContiene        = "";
     {1}aPuntero         = "";

     &enSwDesde9         = 0;              ||Sirve para indicar si lanzamos el proceso desde 9 o desde X.
     &enGrupoTres        = 0;
     &enSubGTres         = 0;
     &enTipoTres         = 0;
     &enArchi            = 0;
     &eaInforme          = "";
     &enMeteGrupoSubTipo = 0;
     &enSwCDefOk         = 0;
     &eaDocumentoArchi   = "";
     &eaNomDocArchi      = "";
     &enSwExisteDoc      = 0;
     &enNumCampoArchi    = 0;
     &eaValorArchi       = "";
     &enNumeroRegistro   = 0;
     &enSwUbicacionDoc   = "";
     &enEmpresa          = 0;
     &enEjercicio        = 0;
     &eaNombreEmp        = "";
     &eaNifEmp           = "";
     &enCodTrab          = 0;
     &eaNombreTra        = "";
     &eaNifTra           = "";
     &eaOrig             = "";
     &eaDest             = "";

     &enM1               = 0;
     &enM2               = 0;
     &eaSwEnvioCorreo    = "";
     &eaVengoDe          = "";
     &eaObservacion1     = "";
     &eaObservacion2     = "";
     &eaObservacion3     = "";
     &enEmp              = 0;
     &enMes              = 0;
     &enAny              = 0;
     &enDesdeMes         = 0;
     &enHastaMes         = 0;
     &nEnvio             = 1;
     &nMes               = 0;
     &aMes               = "";
     &enErrorDSArchi     = 0;
     &nDesdeMes          = 0;
     &nHastaMes          = 0;
     &enNoArchives       = 0;
     &enSwErrorRecDoc    = 0;
     &enEmpGAD           = 0;
     &enTipGAD           = 0;
     &enMesGAD           = 0;
     &enAnyGAD           = 0;
     &enModGAD           = 0;
     &enImpGAD           = 0;
     &enExiGAD           = 0;
     &eaFicGAD           = "";
     &enSwContab         = 0;
     &eaCodNif           = "";
     &eaNomNif           = "";
     &enModelo           = 0;
     &eaModelo           = "";
|FIN;

|PROCESO MesLetraP;
     |SI nMes = 01; aMes = "ENERO";           |FINSI;
     |SI nMes = 02; aMes = "FEBRERO";         |FINSI;
     |SI nMes = 03; aMes = "MARZO";           |FINSI;
     |SI nMes = 04; aMes = "ABRIL";           |FINSI;
     |SI nMes = 05; aMes = "MAYO";            |FINSI;
     |SI nMes = 06; aMes = "JUNIO";           |FINSI;
     |SI nMes = 07; aMes = "JULIO";           |FINSI;
     |SI nMes = 08; aMes = "AGOSTO";          |FINSI;
     |SI nMes = 09; aMes = "SEPTIEMBRE";      |FINSI;
     |SI nMes = 10; aMes = "OCTUBRE";         |FINSI;
     |SI nMes = 11; aMes = "NOVIEMBRE";       |FINSI;
     |SI nMes = 12; aMes = "DICIEMBRE";       |FINSI;
     |SI nMes = 99; aMes = "ANUAL";           |FINSI;
|FPRC;

|PROCESO MeteGrupoSubTipo;
     enNumCampoArchi = 1;          ||Grupo
     eaValorArchi = enGrupoTres;
     |HAZ MeteCampoDSArchi;

     enNumCampoArchi = 2;          ||SubGrupo
     eaValorArchi = enSubGTres;
     |HAZ MeteCampoDSArchi;

     enNumCampoArchi = 3;          ||Tipo
     eaValorArchi = enTipoTres;
     |HAZ MeteCampoDSArchi;
|FPRC;

|PROCESO EnviaDocs;
     enSwCDefOk = 0;
     enNumeroRegistro = 0;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
          enSwUbicacionDoc = "S";  || lo guardo en el servidor
     |SINO;
          enSwUbicacionDoc = "C";  || lo guardo en local
     |FINSI;

     |HAZ IniEnvioDocDSArchi;

     |SI enSwCDefOk = 0;
          |ACABA;
     |FINSI;

     ||****************ESTO PARA CADA DOCUMENTO *****************************

     ||Enviamos el Documento que queremos Archivar

     eaDocumentoArchi = eaDest;
     enSwExisteDoc = 0;
     |HAZ ExisteDocFisico;
     |SI enSwExisteDoc = 0;
          aMensaje = "0000Error: No encuentro o no puedo leer el documento: " + eaDocumentoArchi;
          |MENAV aMensaje;
     |SINO;
          eaNomDocArchi = "tm" + Usuario + ".pdf";
          |HAZ DocFisicoDSArchi;

          |SI enMeteGrupoSubTipo = 1;
               |HAZ MeteGrupoSubTipo;
          |FINSI;

          ||Enviamos el valor del registro a guardar.  (TODOS LOS CAMPOS QUE QUERAMOS)
          fFecha = ~;
          aFecha = fFecha;

          eaSwEnvioCorreo = "N";

          enNumCampoArchi = 4;          || Fecha Creacion
          eaValorArchi    = aFecha;
          |HAZ MeteCampoDSArchi;

          |HORA aHora;  |QBF aHora;
          aHora = aHora % 105;

          enNumCampoArchi = 5;          ||Hora Creacion
          eaValorArchi    = aHora;
          |HAZ MeteCampoDSArchi;

          aAlfa = Usuario % 810;   |QBF aAlfa;
          enNumCampoArchi = 6;          ||Usuario
          eaValorArchi    = aAlfa;
          |HAZ MeteCampoDSArchi;

          aAlfa = eaObservacion1; |QBF aAlfa;
          enNumCampoArchi = 11;          ||Observaciones 1
          eaValorArchi    = aAlfa;
          |HAZ MeteCampoDSArchi;

          aAlfa = eaObservacion2; |QBF aAlfa;
          enNumCampoArchi = 12;          ||Observaciones 2
          eaValorArchi    = aAlfa;
          |HAZ MeteCampoDSArchi;

          aAlfa = eaObservacion3; |QBF aAlfa;
          enNumCampoArchi = 13;          ||Observaciones 3
          eaValorArchi    = aAlfa;
          |HAZ MeteCampoDSArchi;

          ||Rellenamos el resto de campos del Registro de Documentos
          ||(dsarm005) del dsarchi.

          eaValorArchi    = enEmpresa;  || Codigo Cliente
          enNumCampoArchi = 8;
          |HAZ MeteCampoDSArchi;

          eaValorArchi    = eaNombreEmp;  || Nombre Cliente
          enNumCampoArchi = 14;
          |HAZ MeteCampoDSArchi;

          eaValorArchi    = eaNifEmp;    || Cif
          enNumCampoArchi = 10;
          |HAZ MeteCampoDSArchi;

          eaCodNif = eaNifEmp;
          |HAZ LeeNifs;
          eaValorArchi = eaNomNif;
          enNumCampoArchi = 38;
          |HAZ MeteCampoDSArchi;

          nNume           = enEjercicio;             || ejercicio
          eaValorArchi    = nNume;
          enNumCampoArchi = 17;
          |HAZ MeteCampoDSArchi;

          eaValorArchi    = enM2;           || mes
          enNumCampoArchi = 18;
          |HAZ MeteCampoDSArchi;

          |SI eaVengoDe = "dsmoy008";
              aAlfa1 = "901";
              aAlfa2 = "01";
              aAlfa3 = "LIBRO DE FACTURAS EMITIDAS";
          |FINSI;

          |SI eaVengoDe = "dsmoy009";
              aAlfa1 = "902";
              aAlfa2 = "01";
              aAlfa3 = "LIBRO DE FACTURAS RECIBIDAS";
          |FINSI;

          |SI eaVengoDe = "dsmoyi18";
              aAlfa1 = "910";
              aAlfa2 = "01";
              aAlfa3 = "LIBRO DE VENTAS E INGRESOS";
          |FINSI;

          |SI eaVengoDe = "dsmoyg18";
              aAlfa1 = "911";
              aAlfa2 = "01";
              aAlfa3 = "LIBRO DE COMPRAS Y GASTOS";
          |FINSI;

          |SI eaVengoDe = "dsmoy020";
              |SI eaInforme = "dsmor120";
                  aAlfa1 = "952";
                  aAlfa2 = "03";
                  aAlfa3 = "CERTIFICADO MODELO 190 (TRABAJADORES)";
              |FINSI;

              |SI eaInforme = "dsmor121";
                  aAlfa1 = "952";
                  aAlfa2 = "04";
                  aAlfa3 = "CERTIFICADO MODELO 190 (ACT.ECONOMICAS)";
              |FINSI;

              |SI eaInforme = "dsmor122"; |O eaInforme = "dsmor125";
                  aAlfa1 = "952";
                  aAlfa2 = "05";
                  aAlfa3 = "CERTIFICADO MODELO 190 (PREMIOS)";
              |FINSI;

              |SI eaInforme = "dsmor123";
                  aAlfa1 = "952";
                  aAlfa2 = "06";
                  aAlfa3 = "CERTIFICADO MODELO 190 (DERECHOS IMAGEN)";
              |FINSI;

              |SI eaInforme = "dsmor124";
                  aAlfa1 = "952";
                  aAlfa2 = "07";
                  aAlfa3 = "CERTIFICADO MODELO 190 (APRO.FORESTALES)";
              |FINSI;
          |FINSI;

          |SI eaVengoDe = "dsmoy021";
              aAlfa1 = "952";
              aAlfa2 = "01";
              aAlfa3 = "CERTIFICADO MODELO 180";
          |FINSI;

          |SI eaVengoDe = "dsmoy027";
              aAlfa1 = "952";
              aAlfa2 = "08";
              aAlfa3 = "CERTIFICADO MODELO 193";
          |FINSI;

          |SI eaVengoDe = "dsmoy056";
              aAlfa1 = "952";
              aAlfa2 = "02";
              aAlfa3 = "CERTIFICADO MODELO 184";
          |FINSI;

          |SI eaVengoDe = "dsmoy073";
              aAlfa1 = enModelo;
              aAlfa2 = "99";
              aAlfa3 = eaModelo;
          |FINSI;

          eaValorArchi    = aAlfa1;
          enNumCampoArchi = 19;
          |HAZ MeteCampoDSArchi;

          eaValorArchi    = aAlfa2;
          enNumCampoArchi = 20;
          |HAZ MeteCampoDSArchi;

          eaValorArchi    = aAlfa3;
          enNumCampoArchi = 21;
          |HAZ MeteCampoDSArchi;

          nMes         = enM2;
          |HAZ MesLetraP;
          eaValorArchi = aMes;         || descripcion periodo (mes)
          enNumCampoArchi = 22;
          |HAZ MeteCampoDSArchi;

          eaValorArchi    = enCodTrab;
          enNumCampoArchi = 15;
          |HAZ MeteCampoDSArchi;

          eaValorArchi    = eaNombreTra;
          enNumCampoArchi = 16;
          |HAZ MeteCampoDSArchi;

          eaValorArchi    = eaNifTra;
          enNumCampoArchi = 95;
          |HAZ MeteCampoDSArchi;
     |FINSI;

     |HAZ FinEnvioDocDSArchi;
|FPRC;

|PROCESO Archivando;
     || archivo
     || primero ya ha tenido que haber creado el rpt y el PDF claro, a partir
     || del rpt despues lo mando al dsarchi

     enSwDesde9         = 1;
     enMeteGrupoSubTipo = 0;
     |HAZ CtrlPedirGrupoDsArchi;

     |SI enNoArchives = 1;
          |ACABA;
     |FINSI;

     |DFICE eaDest; |QBF eaDest;
     eaDest = eaDest + "tm" + Usuario + ".pdf";

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
          |FBORRA eaDest;
          |RECIBE_FICHERO eaOrig, eaDest;
     |SINO;
          |RFBORRA eaDest;
          |COPIA_FICHERO eaOrig, eaDest;
     |FINSI;

     |SI FSalida ! 0;
          || no ha sido capaz de traerse el fichero del servidor
          aAlfa = "    ATENCION: no se ha podido grabar el fichero ";
          aAlfa = aAlfa + eaOrig;
          aAlfa = aAlfa + " en el servidor para su archivado.";
          |MENAV aAlfa;
          aAlfa = "    El proceso se interrumpirá.";
          |MENAV aAlfa;

          enErrorDSArchi = 2;

          |SI eaVengoDe ! "dsmoy056";
              |RFBORRA eaOrig;
          |FINSI;

          |XCIERRA nHandle;
          |ACABA;
     |FINSI;

     |SI eaVengoDe ! "dsmoy056";
         |RFBORRA eaOrig;
     |FINSI;

     |XCIERRA nHandle;

     |HAZ EnviaDocs;
|FPRC;

|PROCESO IMPREArchi;
     |SI enErrorDSArchi = 1;
          || con que la primera vez no encuentre el cuadre ya tenemos
          || bastante para no continuar con esto

          |ACABA;
     |FINSI;

     enErrorDSArchi = 0;

     |DDEF aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + eaInforme + ".rpt";
     |XABRE "E", aAlfa, nHandle;
     |SI FSalida ] 0;
          |ESPECIFICA "RBASS", aPuntero;
          eaOrig = aPuntero; |QBF eaOrig;
          eaOrig = eaOrig + "crystal/";
          eaOrig = eaOrig + "aa" + Usuario + ".pdf";
          |RFBORRA eaOrig;

          aImpresora = "CrystalReport;" + eaOrig;
          Impresora = aImpresora;
          |IMPRE -1;
          |SI FSalida = 0;
               |INFOR eaInforme;
          |SINO;
               aAlfa = "    No se encuentra el cuadre " + aAlfa + ". El documento no se archivará";
               |MENAV aAlfa;
               enErrorDSArchi = 1;
          |FINSI;
     |SINO;
          aAlfa = "    No se encuentra el cuadre " + aAlfa + ". El documento no se archivará";
          enErrorDSArchi = 1;
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO MiraSiArchiva;
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
          enSwUbicacionDoc = "S";  || lo guardo en el servidor
     |SINO;
          enSwUbicacionDoc = "C";  || lo guardo en local
     |FINSI;

     enArchi = 0;
     |DBASS aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "dsarchi/def/dsarm001.mas";

     |SI enSwUbicacionDoc = "S";
          |XABRE "E", aAlfa, nHandle;
     |SINO;
          |XABRE "CE", aAlfa, nHandle;
     |FINSI;
     |SI FSalida ] 0;
          |CARGA_DEF aAlfa, Ref0001@;
          |SI FSalida = 0;
               |DBASS aAlfa; |QBF aAlfa;
               aAlfa = aAlfa + "dsarchi/fich/"; |PATH_DAT #Ref0001@#aAlfa#;
               |ABRE #Ref0001@;
               |DDEFECTO #Ref0001@;
               |LEE 000#Ref0001@.p;
               |SI FSalida ! 0; |DDEFECTO #Ref0001@; |FINSI;

               || compruebo si tengo activada la emision de contabilidad
               || al DSArchi

               |SI #Ref0001@#225 = "S";
                    enArchi = 1;
               |SINO;
                    enArchi = 2;
               |FINSI;

               |SI eaVengoDe ! "";
                    |HAZ TipoModelo;
                    |HAZ CompruebaModelo;
               |FINSI;

               |SI enNoArchives = 1;
                    enArchi = 2;
               |FINSI;

               enSwContab = 1;
               |SI eaVengoDe = "dsmoy056";
                  |O eaVengoDe = "dsmoy020";
                  |O eaVengoDe = "dsmoy021";
                  |O eaVengoDe = "dsmoy027";
                   enSwContab = 2;
               |FINSI;

               |SI eaVengoDe = "dsmoy073";
                   enSwContab = 0;
               |FINSI;

               |CIERRA #Ref0001@; |DESCARGA_DEF #Ref0001@;
          |FINSI;
     |FINSI;
     |XCIERRA nHandle
|FPRC;
