|FICHEROS;
     dsmod309;

     t1830901;

     &clientes@ #715;
     &datosper@ #718;
     &regisnif@ #709;
|FIN;

|VARIABLES;
     nHandle     = 0;
     &fFechaEmi  = @;
     &eaCamp9_11 = "";
     &efCamp9_12 = @;
     &eaCamp9_73 = "";
|FIN;

|INCLUYE i_varemi;

|PROCESO PideFecha;
     |PUSHV 0501 2380;

     |BLANCO 1023 2380;
     |CUADRO 1023 2380;

     E_inf   = "";
     E_sup   = "10";

     |PINTA 1525, "Introduzca la Fecha de Emision del Modelo";
     fFechaEmi = ~;
     fFechaEmi = 1745 ? 1;
     |POPV;
|FPRC;

|| ///////////////////////////////////////////////////////////////////////
|PROCESO PersonaFis2018;
     aAlfa = eaVarDni % 101;
     |SI aAlfa = "0"; |O aAlfa = "1"; |O aAlfa = "2"; |O aAlfa = "3";
      |O aAlfa = "4"; |O aAlfa = "5"; |O aAlfa = "6"; |O aAlfa = "7";
      |O aAlfa = "8"; |O aAlfa = "9"; |O aAlfa = "X"; |O aAlfa = "Y";
      |O aAlfa = "Z";
         eaAlfa = #715#1;     |HAZ BuscaNombre;
         eaAlfa = eaAlfa1;    |HAZ QuitaRaros;     #t1830901#8   = eaAlfa;
         eaAlfa = eaAlfa2;    |HAZ QuitaRaros;     #t1830901#9   = eaAlfa;
      |SINO;
         eaAlfa   = #clientes@#1;    |HAZ QuitaRaros;    #t1830901#8   = eaAlfa;
                                                         #t1830901#9   = " ";
      |FINSI;
|FPRC;

|PROCESO AbrePagina02;
     eaPathAEAT = eaUnidadBasico + "\AEAT";        |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\309";             |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\" + #dsmod309#2;       |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\" + (("00" + #dsmod309#3) % -102);  |RMKDIR eaPathAEAT;
     eaPathAEAT = eaPathAEAT + "\";

     eaFOrigen  = eaPathEmision  + eaFicheroPlano;
     eaFDestino = eaPathAEAT + eaFicheroPlano;
     |HAZ CopiaFichero;

     aAlfa       = eaPathLanza;
     eaPathLanza = eaPathAEAT;
     |HAZ TraeSoloWait;
     eaPathLanza = aAlfa;

     eaForzExplorador = "N";
     |HAZ Explorador;

     aAbre = eaPathAEAT + "imp" + Usuario + ".bat";
     |XABRE "WBC", aAbre, enHandlePortal;

     eaAlfa = eaPathAEAT + "wait ";
     |HAZ GrabaPortalSin;

     eaAlfa = eaPathExplorador + " " + &34;
     |HAZ GrabaPortalSin;

     |SI eaOpcion = "1";
         eaAlfa = "https://www2.agenciatributaria.gob.es/wlpl/OV16-M309/index.zul";
     |SINO;
         eaAlfa = "https://www1.agenciatributaria.gob.es/wlpl/OV16-M309/index.zul";
     |FINSI;
     |HAZ GrabaPortalSin;

     eaAlfa = "";
     |HAZ GrabaPortal;

     |XCIERRA enHandlePortal;

     |RSYSTEM aAbre;

     aAlfa = eaPathExplorador > "";
     aAlfa = aAlfa - "CHROME.EXE";
     |SI FSalida ! 0;  |SLEEP 1;  |FINSI;

     aAlfa = eaPathAEAT + aFichero;
     |RFBORRA aAlfa;
     |RFBORRA aAbre;
|FPRC;

|PROCESO Carga309_2018;
     |DDEFECTO #t1830901;

     enCodCli = #dsmod309#0;
     |HAZ LeePersona;

     #t1830901#6 = "I";

     enCalcCif = 0;

     |SI enSwDeDonde = 1;
         eaVarDni = #715#3;  |HAZ CalculameDNI;   #t1830901#7  = eaVarDni;

         aAlfa1   = #datosper@#2;  |QBT aAlfa1;
         |SI aAlfa1 ! "";
             eaAlfa = #datosper@#2;  |HAZ QuitaRaros;  aAlfa1 = eaAlfa;  |QBF aAlfa1;
             eaAlfa = #datosper@#3;  |HAZ QuitaRaros;  aAlfa2 = eaAlfa;  |QBF aAlfa2;
             #t1830901#8 = aAlfa1 + " " + aAlfa2;

             eaAlfa = #datosper@#4;  |HAZ QuitaRaros;
             #t1830901#9 = eaAlfa;
         |SINO;
             |HAZ PersonaFis2018;
         |FINSI;
     |SINO;
         eaVarDni = #715#13;  |HAZ CalculameDNI;   #t1830901#7   = eaVarDni;
         |HAZ PersonaFis2018;
     |FINSI;

     #t1830901#10   = #dsmod309#2;

     |SI #dsmod309#3 = 3;   #t1830901#11 = "1T";  |FINSI;
     |SI #dsmod309#3 = 6;   #t1830901#11 = "2T";  |FINSI;
     |SI #dsmod309#3 = 9;   #t1830901#11 = "3T";  |FINSI;
     |SI #dsmod309#3 = 12;  #t1830901#11 = "4T";  |FINSI;
     |SI #dsmod309#3 = 99;  #t1830901#11 = "OA";  |FINSI;

     |SI #dsmod309#29 = "X";
         eaVarDni = #dsmod309#19;   |HAZ CalculameDNI;   #t1830901#12  = eaVarDni;
         eaAlfa   = #dsmod309#20;   |HAZ QuitaRaros;     #t1830901#13  = eaAlfa;
         eaAlfa   = #dsmod309#137;  |HAZ QuitaRaros;     #t1830901#14  = eaAlfa;
         eaAlfa   = #dsmod309#21;   |HAZ QuitaRaros;     #t1830901#15  = eaAlfa;
     |FINSI;

     |SI #dsmod309#22 = "X"; #t1830901#16 = "1"; |FINSI;
     |SI #dsmod309#23 = "X"; #t1830901#16 = "2"; |FINSI;
     |SI #dsmod309#24 = "X"; #t1830901#16 = "3"; |FINSI;
     |SI #dsmod309#25 = "X"; #t1830901#16 = "4"; |FINSI;
     |SI #dsmod309#26 = "X"; #t1830901#16 = "5"; |FINSI;
     |SI #dsmod309#27 = "X"; #t1830901#16 = "6"; |FINSI;

     |SI #dsmod309#28 = "X"; #t1830901#17 = "1"; |FINSI;
     |SI #dsmod309#29 = "X"; #t1830901#17 = "2"; |FINSI;
     |SI #dsmod309#30 = "X"; #t1830901#17 = "3"; |FINSI;
     |SI #dsmod309#31 = "X"; #t1830901#17 = "4"; |FINSI;
     |SI #dsmod309#32 = "X"; #t1830901#17 = "5"; |FINSI;
     |SI #dsmod309#33 = "X"; #t1830901#17 = "6"; |FINSI;

     eaAlfa   = #dsmod309#34;   |HAZ QuitaRaros;                    #t1830901#18 = eaAlfa;
     eaAlfa   = #dsmod309#35;   |HAZ QuitaRaros;                    #t1830901#19 = eaAlfa;
     eaAlfa   = #dsmod309#36;   |HAZ QuitaRaros;                    #t1830901#20 = eaAlfa;
     eaAlfa   = #dsmod309#37;   |HAZ QuitaRaros;                    #t1830901#21 = eaAlfa;
     eaAlfa   = #dsmod309#38;   |HAZ QuitaRaros;                    #t1830901#22 = eaAlfa;

     eaAlfa   = #dsmod309#39;   |HAZ QuitaRaros;                    #t1830901#23 = eaAlfa;
     eaAlfa   = #dsmod309#40;   |HAZ QuitaRaros;                    #t1830901#24 = eaAlfa;
     eaAlfa   = #dsmod309#41;   |HAZ QuitaRaros;                    #t1830901#25 = eaAlfa;

     aAlfa = #dsmod309#42; |QBF aAlfa;
     |SI #dsmod309#138 = 0; |Y aAlfa ! ""; #dsmod309#138 = #dsmod309#42; |FINSI;
     nNume    = (#dsmod309#138 * 100) ! 0;   eaAlfa = ("00000" + nNume) % -105;  #t1830901#26 = eaAlfa;

     eaAlfa   = #dsmod309#43;   |HAZ QuitaRaros;                    #t1830901#27 = eaAlfa;
     eaAlfa   = #dsmod309#44;   |HAZ QuitaRaros;                    #t1830901#28 = eaAlfa;
     eaAlfa   = #dsmod309#45;   |HAZ QuitaRaros;                    #t1830901#29 = eaAlfa;
     |SI #dsmod309#46 ! 0;
         #t1830901#30 = #dsmod309#46;
     |FINSI;

     nNume    = #dsmod309#47;   eaAlfa = ("000000000000" + nNume) % -110;  #t1830901#31 = eaAlfa;

     enNume   = #dsmod309#48;  |HAZ Conver17;  #t1830901#32 = eaAlfa;
     enNume   = #dsmod309#49 * 100;            #t1830901#33 = ("00000" + enNume) % -105;
     enNume   = #dsmod309#50;  |HAZ Conver17;  #t1830901#34 = eaAlfa;
     enNume   = #dsmod309#51;  |HAZ Conver17;  #t1830901#35 = eaAlfa;
     enNume   = #dsmod309#52 * 100;            #t1830901#36 = ("00000" + enNume) % -105;
     enNume   = #dsmod309#53;  |HAZ Conver17;  #t1830901#37 = eaAlfa;
     enNume   = #dsmod309#54;  |HAZ Conver17;  #t1830901#38 = eaAlfa;
     enNume   = #dsmod309#55 * 100;            #t1830901#39 = ("00000" + enNume) % -105;
     enNume   = #dsmod309#56;  |HAZ Conver17;  #t1830901#40 = eaAlfa;
     enNume   = #dsmod309#57;  |HAZ Conver17;  #t1830901#41 = eaAlfa;
     enNume   = #dsmod309#58 * 100;            #t1830901#42 = ("00000" + enNume) % -105;
     enNume   = #dsmod309#59;  |HAZ Conver17;  #t1830901#43 = eaAlfa;
     enNume   = #dsmod309#60;  |HAZ Conver17;  #t1830901#44 = eaAlfa;
     enNume   = #dsmod309#61 * 100;            #t1830901#45 = ("00000" + enNume) % -105;
     enNume   = #dsmod309#62;  |HAZ Conver17;  #t1830901#46 = eaAlfa;
     enNume   = #dsmod309#63;  |HAZ Conver17;  #t1830901#47 = eaAlfa;
     enNume   = #dsmod309#64 * 100;            #t1830901#48 = ("00000" + enNume) % -105;
     enNume   = #dsmod309#65;  |HAZ Conver17;  #t1830901#49 = eaAlfa;
     enNume   = #dsmod309#66;  |HAZ Conver17;  #t1830901#50 = eaAlfa;
     enNume   = #dsmod309#67 * 100;            #t1830901#51 = ("00000" + enNume) % -105;
     enNume   = #dsmod309#68;  |HAZ Conver17;  #t1830901#52 = eaAlfa;
     enNume   = #dsmod309#69;  |HAZ Conver17;  #t1830901#53 = eaAlfa;
     enNume   = #dsmod309#70;  |HAZ Conver17;  #t1830901#54 = eaAlfa;
     enNume   = #dsmod309#71;  |HAZ Conver17;  #t1830901#55 = eaAlfa;

     |SI #dsmod309#4 > 0;
         #t1830901#56 = "X";
         #t1830901#57 = #dsmod309#72;
     |FINSI;

     enModelo = 309;  enForzar = 1;  |HAZ CogeDatosBancos;
     |SI eaOpcion = "1";
         #t1830901#58 = eaIBAN;
     |FINSI;

     eaAlfa   = #dsmod309#139;  |HAZ QuitaRaros;   #t1830901#59 = eaAlfa;
     eaVarDni = #dsmod309#140;  |HAZ CalculameDNI; #t1830901#60 = eaVarDni;
     eaAlfa   = #dsmod309#141;  |HAZ QuitaRaros;   #t1830901#61 = eaAlfa;
     eaAlfa   = #dsmod309#142;  |HAZ QuitaRaros;   #t1830901#62 = eaAlfa;

     #t1830901#67 = &13 + &10;

     aAlfa = "<T3090" + #t1830901#10 + #t1830901#11 + "0000>";  |XGRABA nHandle, aAlfa;
     aAlfa = "<AUX>";                                           |XGRABA nHandle2, aAlfa;
     aAlfa = " " * 70;                                          |XGRABA nHandle2, aAlfa;
     aAlfa = eaVersMod;                                         |XGRABA nHandle2, aAlfa;
     aAlfa = " " * 4;                                           |XGRABA nHandle2, aAlfa;
     aAlfa = eaNIFDs;                                           |XGRABA nHandle2, aAlfa;
     aAlfa = " " * 213;                                         |XGRABA nHandle2, aAlfa;
     aAlfa = "</AUX>";                                          |XGRABA nHandle2, aAlfa;

     |PARA nCampo = 1;  |SI nCampo [ 66;  |HACIENDO nCampo = nCampo + 1;
           aAlfa = #t1830901#nCampo#;
           |XGRABA nHandle, aAlfa;
     |SIGUE;

     aAlfa = "</T3090" + #t1830901#10 + #t1830901#11 + "0000>";  |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO Bloque2018;
     |HAZ PideFecha;

     |HAZ LeeUnidad;
     eaPathLanza = eaUnidadBasico + "\MODELOS";                      |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\309";                             |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + #dsmod309#2;                       |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\" + (("00" + #dsmod309#3) % -102);     |RMKDIR eaPathLanza;
     eaPathLanza = eaPathLanza + "\";

     |DBASE eaPathEmision;
     eaPathEmision = eaPathEmision + "emisiones";                    |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision +  "/309";                        |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + #dsmod309#2;                   |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/" + (("00" + #dsmod309#3) % -102); |MKDIR eaPathEmision;
     eaPathEmision = eaPathEmision + "/";

     eaPathInternet = eaUnidad + "/AEAT";                             |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/INTERNET";                   |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet +  "/309";                       |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + #dsmod309#2;                  |RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/" + (("00" + #dsmod309#3) % -102);|RMKDIR eaPathInternet;
     eaPathInternet = eaPathInternet + "/";

     eaFicheroPlano = "309" + (("00000" + #dsmod309#0) % -105) + ".txt";
     eaFicheroImpre = "309" + (("00000" + #dsmod309#0) % -105) + ".pdf";
     eaFicheroError = "err" + (("00000" + #dsmod309#0) % -105) + ".txt";

     |SI eaOpcion = "6";
         enDirecta = 1;
         |HAZ PermisoPortal;
         |SI enPortal = 0;
             enDirecta = 0;
             |ACABA;
         |FINSI;
     |FINSI;

     aAlfa = eaPathLanza + eaFicheroPlano;  |RFBORRA aAlfa;
     aAlfa = eaPathLanza + eaFicheroImpre;  |RFBORRA aAlfa;
     aAlfa = eaPathLanza + eaFicheroError;  |RFBORRA aAlfa;

     aAbre = eaPathEmision + eaFicheroPlano;
     |XABRE "BW", aAbre, nHandle;

     enCambiaMoneda = 1;
     |HAZ Carga309_2018;

     |XCIERRA nHandle;

     |SI eaOpcion = "1";
         |HAZ AbrePagina02;
     |FINSI;

     enEmpresa    = #dsmod309#0;
     enComple     = #dsmod309#4;
     eaNomEmpresa = #dsmod309#7;

     |SI eaOpcion = "3";
         eaFOrigen  = eaPathEmision  + eaFicheroPlano;
         eaFDestino = eaPathInternet + eaFicheroPlano;
         |HAZ CopiaFichero;

         aAlfa =  "      Los ficheros generados estan en: " + eaPathInternet + " de su PC";
         |MENAV aAlfa;
         |SI #dsmod309#2 [ 2018;
             |CONFI "0000SQuiere cargar la pagina de hacienda del modelo";
             |SI FSalida = 0;
                 |HAZ AbrePagina02;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI eaOpcion = "6";
         eaX002_10    = #t1830901#7;
         eaX002_11    = #t1830901#8;
         eaX002_12    = #t1830901#2;
         eaX002_13    = #t1830901#10;
         eaX002_14    = #t1830901#11;

         |SI #dsmod309#4 > 0;
             eaX002_15 = "C";
             eaX002_16 = #t1830901#57;
         |FINSI;

         eaX002_17 = #dsmod309#18;
         eaX002_18 = #t1830901#6;
         eaX002_19 = #t1830901#58;
         eaX002_48 = eaNomEnt;

         enParar = 1;
         |SI enDirecta = 1;  |Y enMsv = 1;
             |CONFI "0000SSolicitar confirmacion de cada empresa";
             |SI FSalida ! 0;
                 enParar = 0;
             |FINSI;
         |FINSI;

         |HAZ PresentaPortal;
     |FINSI;

     |SI enDirecta = 0;
         eaCamp9_11 = "X";
         efCamp9_12 = fFechaEmi;
         eaCamp9_73 = "";
     |FINSI;

     |SI enDirecta = 1;  |Y enMsv = 1;  |Y enParar = 0;
         |SUB_EJECUTA "|dsmox007";
     |FINSI;
|FPRC;
