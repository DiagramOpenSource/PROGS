|FICHEROS;
     dsmoy000 #0;
     dsmom004 #4;
     dsmom107 #107;

     dsm187ca #187;
     dsm187li #188;

     dsmow014 #999;

     dsmow598 #598;
     dsmow599 #599;
     dsmow610 #610;

     &regisnif@ #709;
     &clientes@ #715;
|FIN;

|VARIABLES;
     nHay     = 0;
|FIN;

|INCLUYE i_varemi;

|PROCESO Registro187_1;
     enCodCli = #187#0;
     |HAZ LeePersona;

     |DDEFECTO #598;

     #598#0  = "1";

     #598#1  = "187";

     #598#2  = #187#1;

     |SI enSwDeDonde = 1;
         eaVarDni = #715#3;  |HAZ CalculameDNI;
         #598#3   = eaVarDni;

         eaAlfa   = #715#1;  |HAZ QuitaRaros;
         #598#4   = eaAlfa;

         eaAlfa   = #715#1;  enLinea = 2;  |HAZ LeeTelefono;  |QBF eaAlfa;
         |SI eaAlfa = "";
             eaAlfa   = #715#1;  enLinea = 1;  |HAZ LeeTelefono;
         |FINSI;
         |HAZ QuitaRarosTfno;
         #598#6   = eaAlfa;

         eaAlfa   = #715#53;  |HAZ QuitaRaros;
         #598#7   = eaAlfa;
     |SINO;
         aAlfa = #715#96; |QBF aAlfa; |SI aAlfa = ""; #715#96 = #715#2; |FINSI;
         eaVarDni = #715#13;  |HAZ CalculameDNI;
         #598#3   = eaVarDni;

         eaAlfa   = #715#1;   |HAZ QuitaRaros;
         #598#4   = eaAlfa;

         eaAlfa   = #715#14;  |HAZ QuitaRarosTfno;
         #598#6   = eaAlfa;

         eaAlfa   = #715#96;  |HAZ QuitaRaros;
         #598#7   = eaAlfa;
     |FINSI;

     #598#5  = "T";

     #598#8 = "1870000000000";

     |SI enDirecta = 1;
         |HAZ CalcJustificante;
         #dsmow598#8 = eaJusti;
     |FINSI;

     |SI #dsmom004#24 = "C";  #598#9  = "C";  |FINSI;

     |SI #dsmom004#24 = "S";
         #598#10 = "S";
         #598#11 = #dsmom004#21;
     |FINSI;

     nNume   = #187#6;
     #598#12 = ("000000000" + nNume) % -109;

     enNume  = #187#7;  |HAZ Conver15;
     #598#13 = eaAlfa;

     enNume  = #187#8;  |HAZ Conver15;
     #598#14 = eaAlfa;

     enNume  = #187#9;  |HAZ Conver15;
     #598#15 = eaAlfa;

     #598#17 = &13 + &10;

     nHCampo = 17;
     |SI #dsmoy000#6 ] 2017;
         nHCampo = 16;
     |FINSI;

     aAlfa = "";
     |PARA nCampo = 0;  |SI nCampo [ nHCampo;  |HACIENDO nCampo = nCampo + 1;
           aAlfa = #598nCampo;
           |XGRABA nHandle2, aAlfa;
           |SI nCampo = 16; |Y #dsmoy000#6 ] 2014;
               aAlfa = " " * 250;
               |XGRABA nHandle2, aAlfa;
           |FINSI;
     |SIGUE;

|FPRC;

|PROCESO Registro187_2_2013;
         |DDEFECTO #599;

         #599#0  = "2";
         #599#1  = "187";
         #599#2  = #187#1;
         #599#3  = #598#3;

         eaVarDni = #188#7;  |HAZ CalculameDNI;
         |SI #188#8 = "N";
             #599#4 = eaVarDni;
         |SINO;
             #599#5 = eaVarDni;
         |FINSI;

         eaAlfa  = #188#9;  |HAZ QuitaRaros;         #599#6  = eaAlfa;
                                                     || Tique 3923_256
                                                     eaAlfa  = (("00" + #188#10) % -102) + #188#24;
                                                     #599#7  = eaAlfa;
                                                     #599#8  = #188#11;
                                                     #599#9  = #188#12;
                                                     #599#10 = #188#13;
         eaAlfa  = #188#14;  |HAZ QuitaRaros;        #599#11 = eaAlfa;
                                                     #599#12 = #188#15;
         eaAlfa  = (#188#16 % -104);
         eaAlfa  = eaAlfa + (#188#16 % 402);
         eaAlfa  = eaAlfa + (#188#16 % 102);         #599#13 = eaAlfa;
         nNume   = #188#17 * 1000000;                #599#14 = ("0000000000000000" + nNume) % -116;
         enNume  = #188#18;  |HAZ Conver13;          #599#15 = eaAlfa;
                                                     #599#16 = #188#19;
         enNume  = #188#23;  |HAZ Conver13Signo;     #599#17 = eaSigno + (eaAlfa % -113);
         enNume  = #188#20;  |HAZ Conver13Signo;     #599#18 = eaSigno + (eaAlfa % -113);
         nNume   = #188#21 * 100;                    #599#19 = ("0000" + nNume) % -104;
         enNume  = #188#22;  |HAZ Conver13;          #599#20 = eaAlfa;
         #599#22 = &13 + &10;

         aAlfa = "";
         |PARA nCampo = 0;  |SI nCampo [ 22;  |HACIENDO nCampo = nCampo + 1;
               aAlfa = #599nCampo;
               |XGRABA nHandle2, aAlfa;
         |SIGUE;
|FPRC;

|PROCESO Registro187_2_2014;
         |DDEFECTO #610;

         #610#0  = "2";
         #610#1  = "187";
         #610#2  = #187#1;
         #610#3  = #598#3;

         eaVarDni = #188#7;  |HAZ CalculameDNI;
         |SI #188#8 = "N";
             #610#4 = eaVarDni;
         |SINO;
             #610#5 = eaVarDni;
         |FINSI;

         eaAlfa  = #188#9;  |HAZ QuitaRaros;         #610#6  = eaAlfa;
                                                     eaAlfa  = (("00" + #188#10) % -102) + #188#24;
                                                     #610#7  = eaAlfa;
                                                     #610#8  = #188#11;
                                                     #610#9  = #188#12;

         eaAlfa  = #188#14;  |HAZ QuitaRaros;
         |SI #188#13 = "1";
             #610#10 = eaAlfa;
         |SINO;
             #610#11 = eaAlfa;
         |FINSI;

                                                     #610#12 = #188#15;
         eaAlfa  = (#188#16 % -104);
         eaAlfa  = eaAlfa + (#188#16 % 402);
         eaAlfa  = eaAlfa + (#188#16 % 102);         #610#13 = eaAlfa;
         nNume   = #188#17 * 1000000;                #610#14 = ("0000000000000000" + nNume) % -116;
         enNume  = #188#18;  |HAZ Conver13;          #610#15 = eaAlfa;
                                                     #610#16 = #188#19;

||aqui
         enNume  = #188#23;  |HAZ Conver13Signo;     #610#17 = eaSigno + (eaAlfa % -113);
         |SI #dsmoy000#6 ] 2015;
             #610#17 = "";
         |FINSI;

         enNume  = #188#20;  |HAZ Conver13Signo;     #610#18 = eaSigno + (eaAlfa % -113);
         nNume   = #188#21 * 100;                    #610#19 = ("0000" + nNume) % -104;
         enNume  = #188#22;  |HAZ Conver13;          #610#20 = eaAlfa;
                                                     #610#21 = #188#25;

         #610#24 = &13 + &10;

         nHCampo = 24;
         |SI #dsmoy000#6 ] 2017;
             nHCampo = 23;
         |FINSI;

         aAlfa = "";
         |PARA nCampo = 0;  |SI nCampo [ nHCampo;  |HACIENDO nCampo = nCampo + 1;
               aAlfa = #610nCampo;
               |XGRABA nHandle2, aAlfa;
         |SIGUE;
|FPRC;

|PROCESO Registro187_2;
     |SI #dsmoy000#6 < 2014;
         |HAZ Registro187_2_2013;
     |SINO;
         |HAZ Registro187_2_2014;
     |FINSI;
|FPRC;

|DEFBUCLE dsm187li;
     #188#1;
     ;
     #187#0, #187#1, #187#2, #187#3, #187#4, #187#5,     0;
     #187#0, #187#1, #187#2, #187#3, #187#4, #187#5, 99999;
     ;
     NULL, Registro187_2;
|FIN;

|PROCESO Lee1871;        || Creacion de Ficheros
     #dsmom004#0  = #999#0;
     #dsmom004#1  = #999#1;
     #dsmom004#2  = #999#2;
     #dsmom004#3  = #999#5;
     #dsmom004#4  = #999#7;
     |LEE 040#dsmom004.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     #187#0  = #999#0;
     #187#1  = #999#1;
     #187#2  = #999#2;
     #187#3  = #999#5;
     #187#4  = #999#7;
     #187#5  = 0;
     |LEE 040#187=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     eaFicheroPlano = "187" + (("00000" + #999#0) % -105) + ".txt";
     eaFicheroImpre = "187" + (("00000" + #999#0) % -105) + ".imp";
     eaFicheroSalid = "187" + (("00000" + #999#0) % -105) + ".sal";
     eaFicheroError = "err" + (("00000" + #999#0) % -105) + ".txt";

     aAbre = eaPathEmision + eaFicheroPlano;
     |XABRE "BW", aAbre, nHandle2;
     |HAZ Registro187_1;

     |BUCLE dsm187li;

     |XCIERRA nHandle2;

     |SI #dsmoy000#6 [ 2012;
         eaFOrigen  = eaPathEmision  + "187" + (("00000" + #999#0) % -105) + ".TXT";
         eaFDestino = eaPathInternet + "187" + (("00000" + #999#0) % -105) + ".TXT";

         |HAZ CopiaFichero;
         |FBORRA eaFOrigen;

         |HAZ GrabaImpreso;

         |ACABA;
     |FINSI;

     enEmpresa    = #999#0;
     eaNomEmpresa = #999#3;

     eaX002_10    = #dsmow598#3;
     eaX002_11    = #dsmow598#4;
     eaX002_12    = #dsmoy000#0;
     eaX002_13    = #dsmoy000#6;
     eaX002_14    = 99;

     |SI #dsmow598#9 ! " ";
         eaX002_15 = #dsmow598#9;
     |FINSI;

     |SI #dsmow598#10 ! " ";
         eaX002_15 = #dsmow598#10;
         eaX002_16 = #dsmow598#11;
     |FINSI;

     eaX002_27 = #dsmow598#12;
     eaX002_20 = #dsm187ca#6;
     eaX002_28 = #dsm187ca#7;
     eaX002_29 = #dsm187ca#8;

     eaX002_21 = #dsm187ca#8;
     |SI #dsm187ca#8 = 0;
         eaX002_21 = #dsm187ca#7;
     |FINSI;

     eaX002_22 = #dsm187ca#9;
     eaX002_30 = #dsm187ca#9;

     |HAZ PresentaPortal;

     nHay = 1;
|FPRC;

|PROCESO QueHacemos187;
     |HAZ Lee1871;          || Creacion de los Ficheros Planos.
|FPRC;

|DEFBUCLE dsmow014C187;
     #999#1;
     6;
     00000, 0000, 00, "S";
     99999, 9999, 99, "S";
     ;
     NULL, QueHacemos187;
|FIN;

|DEFBUCLE dsmow014N187;
     #999#2;
     6;
     "                                        ", "S";
     "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz", "S";
     ;
     NULL, QueHacemos187;
|FIN;

|PROCESO Proceso187;
     |ABRE #4;
     |ABRE #187;
     |SI #0#8 = "C";
         |BUCLE dsmow014C187;
     |SINO;
         |BUCLE dsmow014N187;
     |FINSI;
     |CIERRA #4;
     |CIERRA #187;
|FPRC;

|PROCESO Boton1871;
     |PTEC 824;
|FPRC;

|PROCESO Boton1872;
     |PTEC 806;
|FPRC;

|PROCESO Botones187;
     |BLANCO 0501 2380;

     |CONTROL_SIMPLE 0, "LBOTON, <F2> Generacion Fichero para Internet", 0513, 0754, Boton1871;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,ESC Cancelar", 2165, 2178, Boton1872;
     nBoton2 = FSalida;

     aF2 = &255 + "824";
     aF7 = &255 + "806";

     |PARA; |SI;  |HACIENDO;
         |LEETECLA aTecla;
         |SI aTecla = aF2;  nTecla = 1;   |SAL;  |FINSI;
         |SI aTecla = aF7;  nTecla = 0;   |SAL;  |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;

     |PULSATECLA;
|FPRC;

|PROCESO Ejer2012;
     |HAZ Botones187;

     nHay = 0;
     |HAZ Proceso187;
     |SI nHay = 0;  |ACABA;  |FINSI;

     aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
     |MENAV aAlfa;
|FPRC;

|PROCESO Ejer2013;
     nTecla = 1;
     |HAZ BtnAnuales2012;
     |SI eaOpcion = "1";  |O eaOpcion = "2";
         |MENAV "0000Opcion no activada para este modelo.";
         |ACABA;
     |FINSI;

     nHay = 0;
     |HAZ Proceso187;
     |SI nHay = 0;  |ACABA;  |FINSI;

     |HAZ SacaErrorPtl;

     |SI eaOpcion = "3";
         |SI enPresentar = 0;
             aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
             |MENAV aAlfa;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Ejer2015;
     nTecla = 1;
     |HAZ BtnAnuales2015;

     nHay = 0;
     |HAZ Proceso187;
     |SI nHay = 0;  |ACABA;  |FINSI;

     |SI eaOpcion = "3";
         |SI enPresentar = 0;
             aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
             |MENAV aAlfa;
         |FINSI;
     |FINSI;
|FPRC;

|PROGRAMA;
     aFichero = ("000" + Usuario) % 108;
     |NOME_DAT #0 aFichero;

     aFichero = ("imp" + Usuario) % 108;
     |NOME_DAT #999 aFichero;

     |ABRE #0;
     |LEE 000#0p;
     |CIERRA #0;

     |ABRE #107;
     |LEE 040#107p;
     |SI FSalida ! 0;
         |CIERRA #107;
         |SUB_EJECUTA_NP "dsmom107";
         |ABRE #107;
     |FINSI;

     |LEE 040#107p;
     |SI FSalida ! 0;  |DDEFECTO #107;  |FINSI;
     |CIERRA #107;

     enCambiaMoneda = 1;
     enSwTrata      = 0;
     nTecla         = 0;

     |SI eaParametro ! "187C";
         |SI #dsmoy000#6 [ 2012;  |HAZ Ejer2012;  |FINSI;
         |SI #dsmoy000#6 = 2013;  |HAZ Ejer2013;  |FINSI;
         |SI #dsmoy000#6 = 2014;  |HAZ Ejer2013;  |FINSI;
         |SI #dsmoy000#6 ] 2015;  |Y #dsmoy000#6 [ 2015;  |HAZ Ejer2015;  |FINSI;
         |SI #dsmoy000#6 ] 2018;  |HAZ Ejer2018;  |FINSI;
     |FINSI;

     |SI nTecla = 0;  enInfComp = 1;  |ACABA;  |FINSI;
|FPRO;
