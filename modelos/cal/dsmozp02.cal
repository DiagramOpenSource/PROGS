|FICHEROS;
     dsmozp02 #0;

     dsmom002 #2;
     dsmom004 #4;
     dsmom008 #8;

     dsmom030 #30;

     dsmom084 #84;
     dsmom085 #85;
     dsmom086 #86;
     dsmom087 #87;

     dsmom107 #107;
     dsmom109 #109;
     dsmociv@ #300;

     dsmow082 #982,MANTE;
     dsmow083 #983,MANTE;
     dsmow128 #928;

     :/contagen/def/canempre #101;
     :/contagen/def/camaniva #102;
     :/contagen/def/caivalin #103;
     :/contagen/def/caivaasi #104;

     :/basica/def/agifigen #1000;
     :/basica/def/agicen14 #1014;
     :/basica/def/agicen22 #1022;
|FIN;

|VARIABLES;

     &eaPathBasica = "";
     aBase       = "";
     aPathModelo = "";
     aDef        = "";
     &aFichw82   = "";
     &aFichw28   = "";

     aFichero    = "";
     aAlfa       = "";
     aAlfa1      = "";
     aAlfa2      = "";
     aAlfa3      = "";
     nNume1      = 0;
     nNume2      = 0;
     nNume3      = 0;
     nPara1      = 0;
     nPara2      = 0;
     fFecha      = @;

     nModp80       = 0;
     nCampo        = 0;
     nDEmpresa     = 0;
     nHEmpresa     = 0;
     enGraba       = 0;
     nBaseImpo     = 0;
     nCuota        = 0;
     nDPeriodo     = 0;
     nHPeriodo     = 0;
     nEjerC        = 0;

     nSwConPro   = 0;
     fFecIni     = @;
     fFecFin     = @;

     nSwPrimAct  = 0;
     nSwRegEsp   = 0;
     nSwSubv     = 0;
     nSwContab   = 0;
     nSwExentas  = 0;
     &nSwVarios  = 0;
     nSw         = 0;
     &nRegIVA    = 0;
     &nRegIVAp   = 0;
     nReg109     = 0;
     nNumAct     = 0;
     aDDepar     = "";
     aHDepar     = "";

     nDep        = 0;
     nDepar      = 0;
     nVentaCon   = 0;
     nVentaSin   = 0;
     nVentaSub   = 0;
     nVentaSuI   = 0;
     nVentaNue   = 0;
     nIvaSub     = 0;
     nSwOpm81    = 0;
     nSwOpe82    = 0;
     &nSwOpe83   = 0;
     nImporteMas = 0;

     nSwCon = 0;
     nSwSin = 0;

     nActSuma    = 0;
     aTipo       = "";
     aLit        = "";
     nActivMas   = 0;

     &aCNAE      = "";
     &aTipoPr    = "";
     &nTp100     = 0;
     &nAny       = 0;

     nIvaComun = 0;
      nSwBorro = 0;
     nReg99    = 0;

     nProrr     = 0;
     nProrr1     = 0;
     aProrr      = "";
     nSwExis     = 0;
     &aParam     = "";
     &nRepaso    = 0;
     &nSwOp87    = 0;
     nSwOp       = 0;
     nEstado84   = 0;
     nEstado85   = 0;
     nEstado86   = 0;
     &nCalculado = 0;
     &nExiste    = 0;
     &nImpreso   = 0;
     &nDDepar    = 0;
     &nHDepar    = 0;
     nModelo     = 0;

     nComplem    = 0;
     nPeriodo    = 0;
     nEmpresa    = 0;
     nEjer       = 0;
     nActividad  = 0;

     &enSector   = 0;
     &nConSec    = 0;
     &nTpPri     = 0;
     &nTpComun   = 0;
     nSwCom      = 0;
     nHay        = 0;
     &nSwCalculo = 0;
     nPror       = 0;
     nDigo       = 0;
     aMensa      = "";
|FIN;

|INCLUYE i_variar;

|| /////////////////////// PROCESOS ENTRADA POR PANTALLA \\\\\\\\\\\\\\\\\\\\

|PROCESO Ejercicio;  |TIPO 7;
     fFecha = ~;
     aAlfa  = fFecha % -104;
     #0#0   = aAlfa;
     |SI #0#0 [ 2010; #0#0 = 2011; |FINSI;
     |PINTA #0#0;
|FPRC;

|PROCESO Parrilla;
     |SI #0#1 = 0;
         #0#1 = 0;  |PINTA #0#1;
         #0#2 = 0;  |PINTA #0#2;  |C_M #0#2, 1, "N";
         |PARA nCampo = 3;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |SINO;
         |SI enEmpresa = 0;
             |C_M #0#1, 1, "S";
             |C_M #0#2, 1, "S";
         |FINSI;

         |PARA nCampo = 3;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "N";
               #0nCampo = 0;  |PINTA #0nCampo;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO NoMasEmpresas;
     |SI #0Campo = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
               #0nCampo = 0;  |C_M #0nCampo, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |FINSI;
|FPRC;

|| ////////////////////////////////////////////////////////// CALCULOS
|PROCESO BorraPror87;
  nRepaso = 1;
  |SI nSwOp87 = 0;

      |BORRA 020#87a;

  |SINO;

      #87#11 = #86#5; |SI #87#2 = 12; #87#11 = #86#6; |FINSI;

      |SI #87#40 ! 0; |O #87#42 ! 0; |O #87#44 ! 0;
         |O #87#46 ! 0; |O #87#48 ! 0; |O #87#50 ! 0; |O #87#52 ! 0;

            #87#36 = #85#16; |SI #87#2 = 12; #87#36 = #85#17; |FINSI;

            #87#41 = (#87#40 % #87#36) ! 2;
            #87#43 = (#87#42 % #87#36) ! 2;
            #87#45 = (#87#44 % #87#36) ! 2;
            #87#47 = (#87#46 % #87#36) ! 2;
            #87#49 = (#87#48 % #87#36) ! 2;
            #87#51 = (#87#50 % #87#36) ! 2;
            #87#53 = (#87#52 % #87#36) ! 2;

            #87#37 = #87#40 + #87#42 + #87#44 + #87#46 + #87#48 + #87#50 + #87#52;
            #87#38 = #87#41 + #87#43 + #87#45 + #87#47 + #87#49 + #87#51 + #87#53;
            #87#39 = #87#37 - #87#38;
      |SINO;
            |PDEFECTO #87, 36,54;
      |FINSI;

      #87#17 = (#87#16 % #87#11) ! 2;
      #87#20 = (#87#19 % #87#11) ! 2;
      #87#23 = (#87#22 % #87#11) ! 2;
      #87#26 = (#87#25 % #87#11) ! 2;
      #87#29 = (#87#28 % #87#11) ! 2;
      #87#32 = (#87#31 % #87#11) ! 2;
      #87#35 = (#87#34 % #87#11) ! 2;

      #87#12 = #87#16 + #87#19 + #87#22 + #87#25 + #87#28 + #87#31 + #87#34;
      #87#13 = #87#17 + #87#20 + #87#23 + #87#26 + #87#29 + #87#32 + #87#35;
      #87#14 = #87#12 - #87#13;

      #87#8  = #87#12 + #87#37;
      #87#9  = #87#13 + #87#38;
      #87#10 = #87#8  - #87#9;
      |GRABA 020#87a;
  |FINSI;
  |LIBERA #87;
|FPRC;

|DEFBUCLE BorraPror87;
   #87#1;
   ;
   enEmpresa, enEjer, 00, 000, 00, nDDepar, 0, 00;
   enEmpresa, enEjer, 99, 999, 99, nHDepar, 9, 99;
   be;
   NULL, BorraPror87;
|FIN;

|PROCESO BorraPror86;
   |BORRA 020#86a;
   |LIBERA #86;
|FPRC;

|DEFBUCLE BorraPror86;
   #86#1;
   ;
   enEmpresa, enEjer, 00;
   enEmpresa, enEjer, 99;
   be;
   NULL, BorraPror86;
|FIN;

|PROCESO BorraProrrata;
   #85#0 = enEmpresa;
   #85#1 = enEjer;
   |LEE 001#85=;
   |SI FSalida = 0;
       |BORRA 020#85a;
   |FINSI;
   |LIBERA #85;

   |BUCLE BorraPror86;
   nSwOp87 = 0;
   nDDepar = 00;
   nHDepar = 99;
   |BUCLE BorraPror87;
|FPRC;


|| ================================ Proceso Principal
|| \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
|PROCESO dsmociva;

  |SI #300#6 = 1; |O #300#6 = 3;
     nSwCon = 0;
     nSwSin = 0;
     |SI #300#6 = #109#6;  |Y #300#7 = #109#7;   nSwCon = 1; nNume1 = 57;  |FINSI;
     |SI #300#6 = #109#8;  |Y #300#7 = #109#9;   nSwCon = 1; nNume1 = 58;  |FINSI;
     |SI #300#6 = #109#10; |Y #300#7 = #109#11;  nSwCon = 1; nNume1 = 59;  |FINSI;
     |SI #300#6 = #109#12; |Y #300#7 = #109#13;  nSwCon = 1; nNume1 = 60;  |FINSI;
     |SI #300#6 = #109#14; |Y #300#7 = #109#15;  nSwCon = 1; nNume1 = 61;  |FINSI;
     |SI #300#6 = #109#39; |Y #300#7 = #109#40;  nSwCon = 1; nNume1 = 67;  |FINSI;
     |SI #300#6 = #109#41; |Y #300#7 = #109#42;  nSwCon = 1; nNume1 = 68;  |FINSI;
     |SI #300#6 = #109#43; |Y #300#7 = #109#44;  nSwCon = 1; nNume1 = 69;  |FINSI;
     |SI #300#6 = #109#73; |Y #300#7 = #109#74;  nSwCon = 1; nNume1 = 109; |FINSI;
     |SI #300#6 = #109#75; |Y #300#7 = #109#76;  nSwCon = 1; nNume1 = 110; |FINSI;
     |SI #300#6 = #109#77; |Y #300#7 = #109#78;  nSwCon = 1; nNume1 = 111; |FINSI;
     |SI #300#6 = #109#79; |Y #300#7 = #109#80;  nSwCon = 1; nNume1 = 112; |FINSI;
     |SI #300#6 = #109#81; |Y #300#7 = #109#82;  nSwCon = 1; nNume1 = 113; |FINSI;
     |SI #300#6 = #109#83; |Y #300#7 = #109#84;  nSwCon = 1; nNume1 = 114; |FINSI;

     |SI #300#6 = #109#16; |Y #300#7 = #109#17;  nSwSin = 1; nNume2 = 62;  |FINSI;
     |SI #300#6 = #109#18; |Y #300#7 = #109#19;  nSwSin = 1; nNume2 = 63;  |FINSI;
     |SI #300#6 = #109#20; |Y #300#7 = #109#21;  nSwSin = 1; nNume2 = 64;  |FINSI;
     |SI #300#6 = #109#22; |Y #300#7 = #109#23;  nSwSin = 1; nNume2 = 65;  |FINSI;
     |SI #300#6 = #109#24; |Y #300#7 = #109#25;  nSwSin = 1; nNume2 = 66;  |FINSI;
     |SI #300#6 = #109#45; |Y #300#7 = #109#46;  nSwSin = 1; nNume2 = 70;  |FINSI;
     |SI #300#6 = #109#47; |Y #300#7 = #109#48;  nSwSin = 1; nNume2 = 71;  |FINSI;
     |SI #300#6 = #109#49; |Y #300#7 = #109#50;  nSwSin = 1; nNume2 = 72;  |FINSI;
     |SI #300#6 = #109#85; |Y #300#7 = #109#86;  nSwSin = 1; nNume2 = 115; |FINSI;
     |SI #300#6 = #109#87; |Y #300#7 = #109#88;  nSwSin = 1; nNume2 = 116; |FINSI;
     |SI #300#6 = #109#89; |Y #300#7 = #109#90;  nSwSin = 1; nNume2 = 117; |FINSI;
     |SI #300#6 = #109#91; |Y #300#7 = #109#92;  nSwSin = 1; nNume2 = 118; |FINSI;
     |SI #300#6 = #109#93; |Y #300#7 = #109#94;  nSwSin = 1; nNume2 = 119; |FINSI;
     |SI #300#6 = #109#95; |Y #300#7 = #109#96;  nSwSin = 1; nNume2 = 120; |FINSI;

     |SI nSwCon = 1;
         nNume3 = 1; |SI #109nNume1 = "-"; nNume3 = -1; |FINSI;
         |SI #300#6 = 1;
             |SI #300#15 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#14); |FINSI;
             |SI #300#18 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#17); |FINSI;
             |SI #300#21 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#20); |FINSI;
             |SI #300#24 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#23); |FINSI;
             |SI #300#27 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#26); |FINSI;
             |SI #300#30 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#29); |FINSI;
             |SI #300#33 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#32); |FINSI;
         |SINO;
             nVentaCon = nVentaCon + (nNume3 * #300#12);
         |FINSI;
     |FINSI;
     |SI nSwSin = 1;
         nNume3 = 1; |SI #109nNume2 = "-"; nNume3 = -1; |FINSI;
         |SI #300#6 = 1;
             |SI #300#15 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#14); |FINSI;
             |SI #300#18 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#17); |FINSI;
             |SI #300#21 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#20); |FINSI;
             |SI #300#24 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#23); |FINSI;
             |SI #300#27 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#26); |FINSI;
             |SI #300#30 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#29); |FINSI;
             |SI #300#33 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#32); |FINSI;
         |SINO;
             nVentaSin = nVentaSin + (nNume3 * #300#12);
         |FINSI;
     |FINSI;

     nExiste = 1;
   |FINSI;
|FPRC;

|DEFBUCLE dsmociva;
    #300#1008;
    ;
    enEmpresa, enEjer, nPeriodo, nModelo, nComplem, nDepar, 1, 00;
    enEmpresa, enEjer, nPeriodo, nModelo, nComplem, nDepar, 3, 99;
    ;
    NULL, dsmociva;
|FIN;

|PROCESO CargaModelo;
    aDef = "dsmociva";
    |SI nModelo = 322;
        aDef = "dsmoc322";
    |FINSI;

    |DBASE aBase;  |QBF aBase;
    aDef = aBase + "def/" + aDef;
    |CARGA_DEF aDef, dsmociv@;
|FPRC;

|PROCESO MiroMod_zp02;
        nComplem = -1;
        #4#0 = enEmpresa;
        #4#1 = enEjer;
        #4#2 = nPeriodo;
        #4#3 = nModelo;
        #4#4 = 99;
        |LEE 040#4];
        |SI FSalida = 0;
            |LEE 040#4a;
        |SINO;
            |LEE 040#4u;
        |FINSI;
        |SI FSalida = 0; |Y #4#0 = enEmpresa; |Y #4#1 = enEjer;
            |Y #4#2 = nPeriodo; |Y #4#3 = nModelo;
               nComplem = #4#4;
        |FINSI;
        |SI nComplem ! -1;
            |HAZ CargaModelo;
            |BUCLE dsmociva;
            |DESCARGA_DEF #dsmociv@;
            |SI nExiste = 0;
                #8#0 = enEmpresa;
                #8#1 = enEjer;
                #8#2 = nPeriodo;
                #8#3 = nModelo;
                #8#4 = nComplem;
                #8#5 = nDepar;
                |LEE 041#8=;
                |SI FSalida = 0;
                    nExiste = 1;
                |FINSI;
            |FINSI;
       |FINSI;
|FPRC;

|PROCESO CalculoPorIVA;
  |ABRE #4;
  |ABRE #8;
  |PARA nPeriodo = 1; |SI nPeriodo [ 12; |HACIENDO nPeriodo = nPeriodo + 1;
        nModelo = 303; |HAZ MiroMod_zp02;
        nModelo = 322; |HAZ MiroMod_zp02;
        nModelo = 370; |HAZ MiroMod_zp02;
  |SIGUE;
  |CIERRA #8;
  |CIERRA #4;
|FPRC;

|| ////////////////////////////////////////////////////////// CALCULOS
|| ................DATOS DESDE CONTABILIDAD ................................
|PROCESO Grupo1;
    nSwSubv = 0;
    |SI #30#0 ] 800; |Y #30#0 [ 899; nSwSubv = 1; |FINSI;

    nBaseImpo = (#103#6 / enConversor) ! EURODBMOD;
    nCuota    = (#103#8 / enConversor) ! EURODBMOD;

    |SI #30#73 = "S";
        |SI #30#26 = 2; |O #30#26 = 3;
            nVentaCon = nVentaCon + nBaseImpo;
        |SINO;
            |SI nSwSubv = 0;
                |SI nCuota ! 0;  nVentaCon = nVentaCon + nBaseImpo;  |FINSI;
                |SI nCuota = 0;  nVentaSin = nVentaSin + nBaseImpo;  |FINSI;
            |SINO;
                nVentaSub = nVentaSub + nBaseImpo;  || concepto 804
            |FINSI;
        |FINSI;
    |FINSI;

|| ... aqui, puede ser 73 = "s" y 74 = "s", pero no es muy correcto

    |SI #30#74 = "S"; |Y nSwSubv = 1;  ||concepto 806 y 807
         nVentaSuI = nVentaSuI + nBaseImpo;
         nCuota  = (nBaseImpo % #30#75) ! EURODBMOD;
         nIvaSub = nIvaSub + nCuota;
    |FINSI;

    |SI #30#73 = "U"; |Y nSwSubv = 1;  || CONCEPTO NUEVO 808
        nVentaNue = nVentaNue + nBaseImpo;
    |FINSI;
|FPRC;

|PROCESO Grupo3;
    nBaseImpo = (#103#6 / enConversor) ! EURODBMOD;
    nCuota    = (#103#8 / enConversor) ! EURODBMOD;

    |SI #30#73 = "S";
        |SI nCuota ! 0;  nVentaCon = nVentaCon + nBaseImpo;  |FINSI;
        |SI nCuota = 0;  nVentaSin = nVentaSin + nBaseImpo;  |FINSI;
    |FINSI;
|FPRC;

|PROCESO Grupo4;
    nBaseImpo = (#103#6 / enConversor) ! EURODBMOD;
    nCuota    = (#103#8 / enConversor) ! EURODBMOD;
    |SI #30#34 = 12; |O #30#34 = 8;
        nCuota = 0;
    |FINSI;

    |SI #30#73 = "S";
        |SI nCuota ! 0;  nVentaCon = nVentaCon + nBaseImpo;  |FINSI;
        |SI nCuota = 0;  nVentaSin = nVentaSin + nBaseImpo;  |FINSI;
    |FINSI;
|FPRC;

|PROCESO LeeLinea;
     aAlfa1 = #103#30; |QBF aAlfa1; |SI aAlfa1 = ""; #103#30 = #102#10; |FINSI;
     |SI aMulDep = "S";
         nDep = #103#30;
         |SI nDep = 0; nDep = 1; |FINSI;
         |SI nDepar ! nDep; |ACABA; |FINSI;
     |FINSI;

     #30#0 = #103#3;
     |LEE 040#30=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |SI #30#4 = "N";  |ACABA;  |FINSI;

     |SI #30#0 ] 800; |Y #30#0 [ 899;
         |HAZ Grupo1;
         |ACABA;
     |FINSI;
     |SI #30#26 ! 0;   |HAZ Grupo1; |FINSI;   || regimen general
     |SI #30#30 ! 0;   |HAZ Grupo3; |FINSI;   || regimen simplificado
     |SI #30#26 = 0; |Y #30#30 = 0;
         |SI #30#34 = 12; |O #30#34 = 8;
             |HAZ Grupo4;
         |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE caivalin;
     #103#1;
     ;
     #102#0, #102#1, 01;
     #102#0, #102#1, 99;
     ;
     NULL, LeeLinea;
|FIN;

|PROCESO LeeCabecera;    ||solo aquellas actividades sin modelo

     |SI aMulDep ! "S";
         nDep = #102#10;
         |SI nDep = 0; nDep = 1; |FINSI;
         |SI nDepar ! nDep; |ACABA; |FINSI;
     |FINSI;

     |BUCLE caivalin;
     nExiste = 1;
|FPRC;

|DEFBUCLE camaniva;
     #102#1;
     5,36,10;
     00, 0000000000, nDPeriodo, "R", aDDepar;
     99, 9999999999, nHPeriodo, "S", aHDepar;
     e;
     NULL, LeeCabecera;
|FIN;

|PROCESO FicherosConta;
     |SI nSwPrimAct = 1;
         |SI enSwPartido = 1;
             |VETE Seguir;
         |FINSI;
     |FINSI;

     nSwContab = 0;
     enSwOpPar = 0;
     |HAZ SituaEmpresa;
     |SI enSwPartido = 0;
         |ABRE #101;
         |SELECT #4#101;
         #101#2  = enEmpresa;
         #101#26 = nEjerC;
         |LEE 040#101=;
         |SI FSalida ! 0;  |CIERRA #101;  |ACABA;   |FINSI;
         |SELECT #1#101;
         |CIERRA #101;

         |DBASS aPathConta;   |QBT aPathConta;
         aPathConta = aPathConta + "contagen/fich/" + (("00000" + #101#2) % -105) + #101#3 + "/";

         enEmpresa  = #101#2;
         enPerConta = #101#3;
         eaLaMonEmp = #101#28;
     |SINO;
         enPerConta = enPeriodoPar;
         eaLaMonEmp = "E";
     |FINSI;
     |HAZ EnConversor;

|ET Seguir;
     |PATH_DAT #102 aPathConta;
     |PATH_DAT #103 aPathConta;
     |PATH_DAT #104 aPathConta;

     |ABRE #104;
     |LEE 040#104p;
     |SI FSalida ! 0;  |DDEFECTO #104;  |FINSI;
     aMulDep = #104#132;
     |CIERRA #104;
     aDDepar = "  ";
     aHDepar = "99";
     |SI aMulDep = "N"; |Y nDepar ! 1;
         aDDepar = nDepar;
         aDDepar = ("00" + aDDepar) % -102;
         aHDepar = aDDepar;
     |FINSI;

     |SI #104#46 = "T"; |Y  #0#0 [ 2009;
         nDPeriodo = 1;  nHPeriodo = 4;
     |SINO;
         nDPeriodo = 1;  nHPeriodo = 12;
     |FINSI;
     nSwContab = 1;
     #982#20 = enPerConta;
     nSwPrimAct = 1;
|FPRC;
|| ////////////////////////////////////////////

|| ............................... Datos por actividad
|PROCESO LeeElAux83;

  nDepar = #983#2;

  |SI nSwOpe83 = 0;   || = Calcular las Cuotas por Actividad

      |SI nDepar = 0; |ACABA; |FINSI;

      nExiste   = 0;
      nVentaCon = 0;
      nVentaSin = 0;
      nVentaSub = 0;
      |HAZ CalculoPorIVA;
      |SI nExiste = 0; |Y nDepar ! 99;
          |HAZ FicherosConta
          |SI nSwContab = 1;
              |ABRE #30;
              |BUCLE camaniva;
              |CIERRA #30;
          |FINSI;
      |FINSI;

      #983#6  = nVentaCon;
      #983#7  = nVentaSin;
      #983#32 = nVentaSub;
      #983#8  = #983#6  + #983#7;
      #983#33 = nExiste;
      |GRABA 020#983a;

      |SI nDepar ! 99;   || ¨tenemos en cuenta la 99?
          #982#5  = #982#5  + nVentaCon;
          #982#6  = #982#6  + nVentaSin;
          #982#13 = #982#13 + nVentaSub;
          #982#7  = #982#5  + #982#6;
          nNumAct = nNumAct + 1;
      |FINSI;
      enActividad = nDepar;
      |HAZ Actualiza86;
  |FINSI;
|FPRC;

|DEFBUCLE LeeElAux83;
  #983#1;
  ;
  #0#0, enEmpresa, 00;
  #0#0, enEmpresa, 99;
  ;
  NULL, LeeElAux83;
|FIN;

|PROCESO GraboDatos;
    enEmpresa = #982#1;

    |SI nSwOpe82 = 0;   || Calculo de Los Importes de Ventas por actividad

        nSwPrimAct  = 0;
        enSwPartido = 0;
        #982#20     = -1;  || sin contabilidad
        nNumAct     = 0;
        nIvaComun   = 0;
        nSwOpe83    = 0;
        |BUCLE LeeElAux83;

        #982#17 = nNumAct;
        |GRABA 020#982a;
        |LIBERA #982;

        |SI enSwPartido = 1;
            enSwOpPar   = 2;
            |HAZ FinalPartido;
        |FINSI;

        |HAZ Actualiza85;

        |ACABA;
    |FINSI;

    |SI nSwOpe82 = 1;
         |HAZ CalculoPrin;
    |FINSI;

    |SI nSwOpe82 = 2;    ||grabo datos en pantalla para consultar y modificar
        nSwCalculo = 0;
        |HAZ CalculoTodoF10;
    |FINSI;

|FPRC;

|DEFBUCLE dsmow082;
    #982#1;
    ;
    #0#0, 00001;
    #0#0, 99999;
    ;
    NULL, GraboDatos;
|FIN;

|| ========================================================================
|| ................. Grabo registro por Empresa
|PROCESO dsmom004;
  nCalculado = 1;
  |SI #4#7 = "X";  nExiste  = 1; |FINSI;
  |SI #4#9 = "X";  nImpreso = 1; |FINSI;
|FPRC;

|DEFBUCLE dsmom004;
 #4#1;
 ;
 enEmpresa, enEjer, 12, nModelo, 00;
 enEmpresa, enEjer, 12, nModelo, 99;
 ;
 NULL, dsmom004;
|FIN;

|PROCESO GraboAx82;
    nCalculado = 0;
    nImpreso   = 0;
    nExiste    = 0;
    nModelo = 303; |BUCLE dsmom004;
    nModelo = 322; |BUCLE dsmom004;
    nModelo = 370; |BUCLE dsmom004;

    |DDEFECTO #982;
    #982#0  = #0#0;
    #982#1  = enEmpresa;
    #982#2  = #1000#1;
    #982#3  = #85#4;  || aProrr;
    #982#4  = #85#5;  || nProrr;
    #982#8  = "S";
    #982#14 = "N";
    #982#15 = #1000#13;
    #982#17 = nNumAct;
    #982#18  = #85#17; || nProrr;
    #982#19  = #85#17; || nProrr;
    |SI nExiste  = 1; #982#29 = "X"; |FINSI;
    |SI nImpreso = 1; #982#30 = "X"; |FINSI;

    #982#31 = " ";
    |SI nEstado84 = 0; |Y #84#6 = "S";
        #982#31 = "X";
    |FINSI;
    #982#32 = #85#14;

    #982#25 = #982#3;   || el original
    #982#28 = #982#4;   || el original

    |SI aParam = "F10";
        #982#5 = #85#6;
        #982#6 = #85#7;
        #982#7 = #85#8;
    |FINSI;

    |GRABA 000#982n;
    enGraba = 1;

    #86#0 = enEmpresa;
    #86#1 = enEjer;
    #86#2 = 99;
    |LEE 001#86=;
    |SI FSalida = 0;
        nDepar = 99;
        |HAZ GraboAux83;
    |FINSI;
    #86#0 = enEmpresa;
    #86#1 = enEjer;
    #86#2 = 00;
    |LEE 001#86=;
    |SI FSalida = 0; |O nIvaComun = 1;
        nDepar = 00;
        |HAZ GraboAux83;
    |FINSI;

|FPRC;

|| .................. Grabo Registro por Empresa-Actividad

|PROCESO GraboAux83;
     |SI nDepar = 99; #1014#4  = "REGISTRO DE REGULARIZACION"; #1014#20 = ""; |FINSI;
     |SI nDepar = 00; #1014#4  = "IVA SOPORTADO OPERACIONES COMUNES (DESDE CONTABILIDAD)"; #1014#20 = ""; |FINSI;

     |DDEFECTO #86;
     #86#0 = enEmpresa;
     #86#1 = enEjer;
     #86#2 = nDepar;
     |LEE 101#86=;
     |SI FSalida = 0;
         nProrr = #86#6;
     |SINO;
         |DDEFECTO #86;
         #86#0 = enEmpresa;
         #86#1 = enEjer;
         #86#2 = nDepar;
         #86#3 = #1014#4;
         #86#4 = #1014#20;
         #86#5 = 100;
         nProrr = 100;
         |SI #85#4 = "G"; nProrr = #85#5;  |FINSI;
         |SI #86#2 = 99;  nProrr = 100;    |FINSI;
         |SI #86#2 = 0;   nProrr = #85#17; |FINSI;
         #86#6 = nProrr;
         |GRABA 020#86b;
     |FINSI;

     |LIBERA #86;

     |DDEFECTO #983;
     #983#0 = enEjer;
     #983#1 = enEmpresa;
     #983#2 = nDepar;
     |LEE 001#983=;
     |SI FSalida ! 0;
        |DDEFECTO #983;
        #983#0  = enEjer;
        #983#1  = enEmpresa;
        #983#2  = nDepar;
        #983#3  = #86#3;
        #983#4  = #86#4;  || cnae
        #983#13 = #86#4;  || cnae
        #983#5  = nProrr;
        #983#6  = #86#7;
        #983#7  = #86#8;
        #983#8  = #86#9;
        #983#9  = nProrr;
        #983#10 = #86#16;
        #983#11 = #86#17; |SI nDepar = 99; #983#11 = "REGULARIZACION"; |FINSI;
        #983#12 = nDepar;
        #983#14 = #1014#7;
        #983#16 = "Z";
        #983#19 = #1000#87;
        #983#20 = #1000#88;
        #983#21 = #1014#9;
        #983#22 = #1014#10;
        #983#23 = #1014#16;
        #983#24 = #1014#17;
        |SI #1014#5 > "01.01.0000"; #983#25 = #1014#5; |FINSI;
        |SI #1014#6 > "01.01.0000"; #983#26 = #1014#6; |FINSI;
        #983#27 = #1014#8;
        #983#30 = #1014#15;
        #983#31 = #1014#3;
        #983#34 = #86#15; |SI #983#2 = 99; #983#34 = 99; |FINSI;
                          |SI #983#2 = 0;  #983#34 = 0;  |FINSI;

        #983#35 = #983#34;
        #983#36 = #983#10;
        #983#37 = #983#11;
        #983#38 = #983#5;

        |SI aParam = "F10";
            #983#6  = #86#7;
            #983#7  = #86#8;
            #983#8  = #86#9;
            #983#15 = #86#18;
        |FINSI;

        |GRABA 020#983c;
    |FINSI;
    nProrr = nProrr1;
|FPRC;


|PROCESO PrimerFiltro;  || Mas de una Actividad
 |SI nSwOp = 0;

     |SI #1014#5 > "01.01.0000";
         |SI #1014#5 > fFecFin;  |ACABA;  |FINSI;
     |FINSI;
     |SI #1014#6 > "01.01.0000";
         |SI #1014#6 < fFecIni;  |ACABA; |FINSI; || Baja
     |FINSI;
     |SI #1014#14 = "S"; |ACABA; |FINSI;  || dia 08.06.2005 comunero

     nDepar = #1014#1;
     |HAZ GraboAux83;
 |FINSI;
 nNumAct = nNumAct + 1;
|FPRC;

|DEFBUCLE LeeActividades;
  #1014#1;
  ;
  enEmpresa, 01;
  enEmpresa, 99;
  ;
  NULL, PrimerFiltro;
|FIN;

|PROCESO MiraSiD;
 |SI #2#8 > "01.01.0000";
     |SI #2#8 > fFecFin;  |ACABA;  |FINSI;
 |FINSI;
 |SI #2#9 > "01.01.0000";
     |SI #2#9 < fFecIni;  |ACABA;  |FINSI;
 |FINSI;

 |SI #2#2 = 303; |O #2#2 = 370; |O #2#2 = 322;
     nSwConPro = 0;
     |ERROR10;
 |FINSI;
|FPRC;

|DEFBUCLE MiraSiDIVA;
    #2#1;
    ;
    enEmpresa, 01, 303;
    enEmpresa, 99, 370;
    ;
    NULL, MiraSiD;
|FIN;

|PROCESO MirarFiltros;

     nRepaso   = 0;
     enEmpresa = #1000#0;

     nSwConPro = -1;
     |BUCLE MiraSiDIVA;  || Comprobar que hace algun modelo 303
     |SI nSwConPro = -1; |ACABA; |FINSI;

     |DDEFECTO #84;      || Empresas sin prorrata
     #84#0 = enEmpresa;
     #84#1 = enEjer;
     |LEE 141#84=;
     nEstado84 = FSalida;

     #85#0 = enEmpresa;
     #85#1 = enEjer;
     |LEE 101#85=;
     nEstado85 = FSalida;
     |SI nEstado84 = 0; |Y #84#6 = "N";
         |HAZ BorraProrrata;
         |SI nRepaso = 1;
             |HAZ CambiarDatos;
         |FINSI;
         |ACABA;
     |FINSI;

     |SI nEstado85 ! 0; |Y aParam ! "F10";
         |DDEFECTO #85;
         #85#0 = enEmpresa;
         #85#1 = enEjer;
         |GRABA 020#85b;
         nEstado85 = FSalida;
     |FINSI;

     aProrr  = #85#4;    ||Prorrata definitiva calculada con anterioridad
     nProrr  = #85#5;
     nProrr1 = #85#17;

     |SI nEstado85 = 0;
         nNumAct = 0;

         |ABRE #86;
         |ABRE #983;
         |BUCLE LeeActividades;   || Graba Actividades

         |HAZ GraboAx82;
         |CIERRA #983;
         |CIERRA #86;

         |GRABA 020#85a;
         |LIBERA #85;
     |FINSI;
|FPRC;

|DEFBUCLE agifigen;
     #1000#1;
     ;
     nDEmpresa;
     nHEmpresa;
     ;
     NULL, MirarFiltros;
|FIN;

|| ========================================================================
|PROCESO Sup180;
 #982#0 = #0#0;
 #982#1 = 0;
|FPRC;

|PROCESO Inf180;
 #982#0 = #0#0;
 #982#1 = 99999;
|FPRC;

|PROCESO Tipo3;  |TIPO 3;

    aAlfa  = #0#0;
    aAlfa  = aAlfa % -102;
    nEjerC = aAlfa;
    enEjer  = #0#0;

    |HAZ LeeCtrlProrr;
    nAny   = #0#0;
    aAlfa1 = nAny;
    aAlfa1 = "01.01." + aAlfa1; fFecIni = aAlfa1;
    aAlfa1 = #0#0;
    aAlfa1 = "31.12." + aAlfa1; fFecFin = aAlfa1;

    |ABRE #84;
    |ABRE #85;
    |ABRE #982;
    |SI #0#1 ! 0;
        nDEmpresa = #0#1;
        nHEmpresa = #0#2;
        |BUCLE agifigen;
    |SINO;
        |PARA nCampo = 3;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
              nDEmpresa = #0nCampo;
              nHEmpresa = #0nCampo;
              |BUCLE agifigen;
        |SIGUE;
    |FINSI;
    |CIERRA #982;
    |CIERRA #85;
    |CIERRA #84;

    |SI enGraba = 1;

        |SI aParam ! "F10";
            |ABRE #85;
            |ABRE #86;

            nSwOpe82 = 0;
            |BUCLE dsmow082;  ||totales de ventas

            nSwOpe82 = 1;
            |BUCLE dsmow082;  ||Por actividades
            |CIERRA #86;
            |CIERRA #85;
        |SINO;
            nSwOpe82 = 2;
            |BUCLE dsmow082;  ||Por actividades
        |FINSI;

        |SI enSinPantalla = 4; |Y aParam ! "F10";
            |SI nEmpresa ! 0;
                |HAZ ElAviso;
            |FINSI;
        |FINSI;

        |SI enSinPantalla = 0;
            aParam = "";
            |PINPA #0#982;
            |BLIN 4;
            |C_V #982#32,1,"S";
            |ATRI R; |PINTA 0621, "Definitiva "; |ATRI 0;
            |ATRI R; |PINTA 0946, "Datos Ingresos Ejercicio Actual "; |ATRI 0;
            |ENTLINEAL #1#982, -2, 4, 22, 0, Sup180, Inf180;
        |FINSI;

     |SINO;

         |SI enSinPantalla = 0;
             |MENAV "     Seleccion Vacia.";
         |FINSI;

     |FINSI;
|FPRC;


|PROGRAMA;
     nEmpresa   = enEmpresa;
     nEjer      = enEjer;
     nActividad = enActividad;

     aParam = PARAMETRO;
     |SI aParam = "";
         |ABRE #107;
         |DDEFECTO #107;
         |LEE 040#107p;
         |CIERRA #107;
         |SI #107#9 = "N";
             |MENAV "    En Control de Aplicacion indicado que no Calcula Prorrata";
             |ACABA;
             || .. acaba cuando no hay prorrata
         |FINSI;
     |FINSI;

     |DBASS aBase;  |QBF aBase;
     aAlfa = aBase + "basica/fich/";
     |PATH_DAT #1022 aAlfa;

     aFichw82 = ("82w" + Usuario) % 108;
     |NOME_DAT #982 aFichw82;
     aFichero = ("83w" + Usuario) % 108;
     |NOME_DAT #983 aFichero;

     aFichw28 = ("28w" + Usuario) % 108;
     |NOME_DAT #928 aFichw28;

     |DELINDEX #982;
     |DELINDEX #983;
     |DELINDEX #928;

     |SI enEmpresa ! 0;
         |DDEFECTO #0;
         #0#0 = enEjer;
         #0#1 = enEmpresa;
         #0#2 = enEmpresa;
         |HAZ Tipo3;
    |SINO;
         |MANTE #0;
    |FINSI;

    |DELINDEX #982;
    |DELINDEX #983;

    enEmpresa   = nEmpresa;
    enEjer      = nEjer;
    enActividad = nActividad;
|FPRO;

|| ************************************************************************
|PROCESO ElAviso;
    |ABRE #85;
    #85#0 = nEmpresa;
    #85#1 = nEjer;
    |LEE 040#85=;
    |SI FSalida = 0;
        nPror = #85#5; |SI #85#4 = "E"; nPror = #85#17; |FINSI;
        nDigo = 0;
        |SI #85#4 = "E"; nDigo = 1; |FINSI;
        |SI #85#4 = "G"; |Y nPror ! 100; nDigo = 1; |FINSI;
        |SI #85#4 = "E"; |Y nPror = 100; nDigo = 0; |FINSI;
        |SI nDigo = 1;
            aAlfa1 = nPror;
            |SI #85#4 = "G";
                 aAlfa1 = "Prorrata General con " + aAlfa1 + " de deduccion";
            |SINO;
                 aAlfa1 = "Prorrata Especial, con " + aAlfa1 + "% de ded.por actividad";
            |FINSI;
            |SI #85#14 = "M";
                aAlfa1 = "0000S" + aAlfa1 + ". Calculo MANUAL, es conveniente consultar Calculos";
            |SINO;
                aAlfa1 = "0000N" + aAlfa1 + ". Consultar Calculos";
            |FINSI;
            |CONFI aAlfa1;
            |SI FSalida = 0; enSinPantalla = 0; |FINSI;
        |FINSI;
    |FINSI;
    |CIERRA #85;
|FPRC;
