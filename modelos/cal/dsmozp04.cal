|FICHEROS;
     dsmozp04 #0;

     dsmom002 #2;
     dsmom004 #4;
     dsmom008 #8;

     dsmom030 #30;

     dsmom085 #85;
     dsmom086 #86;
     dsmom087 #87;

     dsmom107 #107;
     dsmom109 #109;
     dsmociv@ #300;

     :/contagen/def/canempre #101;
     :/contagen/def/camaniva #102;
     :/contagen/def/caivalin #103;
     :/contagen/def/caivaasi #104;
|FIN;

|VARIABLES;
     nAny        = 0;
     aAlfa       = "";
     aAlfa1      = "";
     aAlfa2      = "";
     aAlfa3      = "";
     nNume1      = 0;
     nNume2      = 0;
     nNume3      = 0;
     nPara1      = 0;
     nPara2      = 0;
     fFecha      = @;

     nCampo        = 0;
     nDEmpresa     = 0;
     nHEmpresa     = 0;

     nBaseImpo     = 0;
     nCuota        = 0;
     nDPeriodo     = 0;
     nHPeriodo     = 0;
     nEjerC        = 0;

     fFecIni     = @;
     fFecFin     = @;

     nSwPrimAct  = 0;
     nSwSubv     = 0;
     nSwContab   = 0;
     nSw         = 0;
     nNumAct     = 0;
     nDepar      = 0;
     nVentaCon   = 0;
     nVentaSin   = 0;
     nVentaSub   = 0;
     nVentaSuI   = 0;
     nVentaNue   = 0;
     nIvaSub     = 0;
     aDDepar     = "";
     aHDepar     = "";
     nSwOpe83    = 0;

     nSwCon = 0;
     nSwSin = 0;

     &aParam     = "";
     &nExiste    = 0;
     &nImpreso   = 0;
     nModelo     = 0;

     nComplem    = 0;
     nPeriodo    = 0;
     nEmpresa    = 0;
     nEjer       = 0;
     nActividad  = 0;

     aDef        = "";
     aBase       = "";
|FIN;

|INCLUYE i_variar;

|| /////////////////////// PROCESOS ENTRADA POR PANTALLA \\\\\\\\\\\\\\\\\\\\

|PROCESO Ejercicio;  |TIPO 7;
     fFecha = ~;
     aAlfa  = fFecha % -104;
     #0#0   = aAlfa;
     |SI #0#0 [ 2010; #0#0 = 2011; |FINSI;
     |PINTA #0#0;
|FPRC;

|PROCESO Parrilla;
     |SI #0#1 = 0;
         #0#1 = 0;  |PINTA #0#1;
         #0#2 = 0;  |PINTA #0#2;  |C_M #0#2, 1, "N";
         |PARA nCampo = 3;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |SINO;
         |SI enEmpresa = 0;
             |C_M #0#1, 1, "S";
             |C_M #0#2, 1, "S";
         |FINSI;

         |PARA nCampo = 3;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "N";
               #0nCampo = 0;  |PINTA #0nCampo;
         |SIGUE;
     |FINSI;
|FPRC;

|PROCESO NoMasEmpresas;
     |SI #0Campo = 0;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
               #0nCampo = 0;  |C_M #0nCampo, 1, "N";
         |SIGUE;
     |SINO;
         |PARA nCampo = Campo + 1;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
               |C_M #0nCampo, 1, "S";
         |SIGUE;
     |FINSI;
|FPRC;

|| ////////////////////////////////////////////////////////// CALCULOS
|| ================================ Proceso Principal
|| \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
|PROCESO dsmociva;
  |SI #300#6 = 1; |O #300#6 = 3;
     nSwCon = 0;
     nSwSin = 0;
     |SI #300#6 = #109#6;  |Y #300#7 = #109#7;   nSwCon = 1; nNume1 = 57;  |FINSI;
     |SI #300#6 = #109#8;  |Y #300#7 = #109#9;   nSwCon = 1; nNume1 = 58;  |FINSI;
     |SI #300#6 = #109#10; |Y #300#7 = #109#11;  nSwCon = 1; nNume1 = 59;  |FINSI;
     |SI #300#6 = #109#12; |Y #300#7 = #109#13;  nSwCon = 1; nNume1 = 60;  |FINSI;
     |SI #300#6 = #109#14; |Y #300#7 = #109#15;  nSwCon = 1; nNume1 = 61;  |FINSI;
     |SI #300#6 = #109#39; |Y #300#7 = #109#40;  nSwCon = 1; nNume1 = 67;  |FINSI;
     |SI #300#6 = #109#41; |Y #300#7 = #109#42;  nSwCon = 1; nNume1 = 68;  |FINSI;
     |SI #300#6 = #109#43; |Y #300#7 = #109#44;  nSwCon = 1; nNume1 = 69;  |FINSI;
     |SI #300#6 = #109#73; |Y #300#7 = #109#74;  nSwCon = 1; nNume1 = 109; |FINSI;
     |SI #300#6 = #109#75; |Y #300#7 = #109#76;  nSwCon = 1; nNume1 = 110; |FINSI;
     |SI #300#6 = #109#77; |Y #300#7 = #109#78;  nSwCon = 1; nNume1 = 111; |FINSI;
     |SI #300#6 = #109#79; |Y #300#7 = #109#80;  nSwCon = 1; nNume1 = 112; |FINSI;
     |SI #300#6 = #109#81; |Y #300#7 = #109#82;  nSwCon = 1; nNume1 = 113; |FINSI;
     |SI #300#6 = #109#83; |Y #300#7 = #109#84;  nSwCon = 1; nNume1 = 114; |FINSI;

     |SI #300#6 = #109#16; |Y #300#7 = #109#17;  nSwSin = 1; nNume2 = 62;  |FINSI;
     |SI #300#6 = #109#18; |Y #300#7 = #109#19;  nSwSin = 1; nNume2 = 63;  |FINSI;
     |SI #300#6 = #109#20; |Y #300#7 = #109#21;  nSwSin = 1; nNume2 = 64;  |FINSI;
     |SI #300#6 = #109#22; |Y #300#7 = #109#23;  nSwSin = 1; nNume2 = 65;  |FINSI;
     |SI #300#6 = #109#24; |Y #300#7 = #109#25;  nSwSin = 1; nNume2 = 66;  |FINSI;
     |SI #300#6 = #109#45; |Y #300#7 = #109#46;  nSwSin = 1; nNume2 = 70;  |FINSI;
     |SI #300#6 = #109#47; |Y #300#7 = #109#48;  nSwSin = 1; nNume2 = 71;  |FINSI;
     |SI #300#6 = #109#49; |Y #300#7 = #109#50;  nSwSin = 1; nNume2 = 72;  |FINSI;
     |SI #300#6 = #109#85; |Y #300#7 = #109#86;  nSwSin = 1; nNume2 = 115; |FINSI;
     |SI #300#6 = #109#87; |Y #300#7 = #109#88;  nSwSin = 1; nNume2 = 116; |FINSI;
     |SI #300#6 = #109#89; |Y #300#7 = #109#90;  nSwSin = 1; nNume2 = 117; |FINSI;
     |SI #300#6 = #109#91; |Y #300#7 = #109#92;  nSwSin = 1; nNume2 = 118; |FINSI;
     |SI #300#6 = #109#93; |Y #300#7 = #109#94;  nSwSin = 1; nNume2 = 119; |FINSI;
     |SI #300#6 = #109#95; |Y #300#7 = #109#96;  nSwSin = 1; nNume2 = 120; |FINSI;

     |SI nSwCon = 1;
         nNume3 = 1; |SI #109nNume1 = "-"; nNume3 = -1; |FINSI;
         |SI #300#6 = 1;
             |SI #300#15 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#14); |FINSI;
             |SI #300#18 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#17); |FINSI;
             |SI #300#21 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#20); |FINSI;
             |SI #300#24 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#23); |FINSI;
             |SI #300#27 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#26); |FINSI;
             |SI #300#30 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#29); |FINSI;
             |SI #300#33 ! 0;  nVentaCon = nVentaCon + (nNume3 * #300#32); |FINSI;
         |SINO;
             nVentaCon = nVentaCon + (nNume3 * #300#12);
         |FINSI;
     |FINSI;
     |SI nSwSin = 1;
         nNume3 = 1; |SI #109nNume2 = "-"; nNume3 = -1; |FINSI;
         |SI #300#6 = 1;
             |SI #300#15 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#14); |FINSI;
             |SI #300#18 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#17); |FINSI;
             |SI #300#21 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#20); |FINSI;
             |SI #300#24 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#23); |FINSI;
             |SI #300#27 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#26); |FINSI;
             |SI #300#30 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#29); |FINSI;
             |SI #300#33 = 0;  nVentaSin = nVentaSin + (nNume3 * #300#32); |FINSI;
         |SINO;
             nVentaSin = nVentaSin + (nNume3 * #300#12);
         |FINSI;
     |FINSI;

     nExiste = 1;
   |FINSI;
|FPRC;

|DEFBUCLE dsmociva;
    #300#1008;
    ;
    enEmpresa, #0#0, nPeriodo, nModelo, nComplem, nActividad, 1, 00;
    enEmpresa, #0#0, nPeriodo, nModelo, nComplem, nActividad, 3, 99;
    ;
    NULL, dsmociva;
|FIN;

|PROCESO CargaModelo;
    aDef = "dsmociva";
    |SI nModelo = 322;
        aDef = "dsmoc322";
    |FINSI;

    |DBASE aBase;  |QBF aBase;
    aDef = aBase + "def/" + aDef;
    |CARGA_DEF aDef, dsmociv@;
|FPRC;

|PROCESO MiroMod_zp02;
        nComplem = -1;
        #4#0 = enEmpresa;
        #4#1 = #0#0;
        #4#2 = nPeriodo;
        #4#3 = nModelo;
        #4#4 = 99;
        |LEE 040#4];
        |SI FSalida = 0;
            |LEE 040#4a;
        |SINO;
            |LEE 040#4u;
        |FINSI;
        |SI FSalida = 0; |Y #4#0 = enEmpresa; |Y #4#1 = #0#0;
            |Y #4#2 = nPeriodo; |Y #4#3 = nModelo;
               nComplem = #4#4;
        |FINSI;
        |SI nComplem ! -1;
            |HAZ CargaModelo;
            |BUCLE dsmociva;
            |DESCARGA_DEF #dsmociv@;
       |FINSI;
|FPRC;

|PROCESO CalculoPorIVA;
  |ABRE #4;
  |PARA nPeriodo = 1; |SI nPeriodo [ 12; |HACIENDO nPeriodo = nPeriodo + 1;
        nModelo = 303; |HAZ MiroMod_zp02;
        nModelo = 322; |HAZ MiroMod_zp02;
        nModelo = 370; |HAZ MiroMod_zp02;
  |SIGUE;
  |CIERRA #4;
|FPRC;

|| ////////////////////////////////////////////////////////// CALCULOS

|| ............................... Datos por actividad
|PROCESO LeeEl86;
      nActividad = #86#2;

      |SI nSwOpe83 = 0;
          nExiste   = 0;
          nVentaCon = 0;
          nVentaSin = 0;
          nVentaSub = 0;
          |HAZ CalculoPorIVA;
          |SI nExiste = 0; |Y nActividad ! 99;
              nVentaCon = #86#7;
              nVentaSin = #86#8;
              || ... Por ahora no es necesario ver otra vez contabilidad
              ||          |HAZ FicherosConta
              ||          |SI nSwContab = 1;
              ||              |ABRE #30;
              ||              |BUCLE camaniva;
              ||              |CIERRA #30;
              ||          |FINSI;
              || ... ...
          |FINSI;

          #86#7  = nVentaCon;
          #86#8  = nVentaSin;
          #86#9  = #86#7  + #86#8;
          |GRABA 020#86a;

          |SI nActividad ! 99;   || ¨tenemos en cuenta la 99?
              #85#6  = #85#6  + nVentaCon;
              #85#7  = #85#7  + nVentaSin;
              #85#8  = #85#6  + #85#7;
              nNumAct = nNumAct + 1;
          |FINSI;
     |FINSI;

     |SI nSwOpe83 = 1;
         |SI nActividad = 00; |O nActividad = 99; |ACABA; |FINSI;

         #86#18 = ((#86#9 * 100) / #85#8 ) ! 2;
         |GRABA 020#86a;
     |FINSI;

     |LIBERA #86;
|FPRC;

|DEFBUCLE LeeEl86;
  #86#1;
  ;
  #85#0, #85#1, 01;
  #85#0, #85#1, 99;
  be;
  NULL, LeeEl86;
|FIN;

|PROCESO GraboDatos;
    enEmpresa = #85#0;

    #85#6 = 0;
    #85#7 = 0;
    #85#8 = 0;

    nSwPrimAct  = 0;
    enSwPartido = 0;
    enPerConta  = -1;  || sin contabilidad
    nNumAct     = 0;
    nSwOpe83    = 0;
    |BUCLE LeeEl86;

    nSwOpe83  = 1;
    |BUCLE LeeEl86;

    #85#15 = nNumAct;
    |GRABA 020#85a;
    |LIBERA #85;
|FPRC;

|DEFBUCLE dsmom085;
   #85#1;
   ;
   nDEmpresa, #0#0;
   nHEmpresa, #0#0;
   ;
   NULL, GraboDatos;
|FIN;

|| ========================================================================

|PROCESO Tipo3;  |TIPO 3;
    aAlfa  = #0#0;
    aAlfa  = aAlfa % -102;
    nEjerC = aAlfa;
    enEjer = #0#0;

    |HAZ LeeCtrlProrr;
    nAny   = #0#0;
    aAlfa1 = nAny;
    aAlfa1 = "01.01." + aAlfa1; fFecIni = aAlfa1;
    aAlfa1 = #0#0;
    aAlfa1 = "31.12." + aAlfa1; fFecFin = aAlfa1;

    |SI #0#1 ! 0;
        nDEmpresa = #0#1;
        nHEmpresa = #0#2;
        |BUCLE dsmom085;
    |SINO;
        |PARA nCampo = 3;  |SI nCampo [ 14;  |HACIENDO nCampo = nCampo + 1;
              nDEmpresa = #0nCampo;
              nHEmpresa = #0nCampo;
              |BUCLE dsmom085;
        |SIGUE;
    |FINSI;
|FPRC;

|PROGRAMA;
     nEmpresa = enEmpresa;
     nEjer    = enEjer;

     aParam = PARAMETRO;
     |SI enEmpresa ! 0;
         |DDEFECTO #0;
         #0#0 = enEjer;
         #0#1 = enEmpresa;
         #0#2 = enEmpresa;
         |HAZ Tipo3;
    |SINO;
         |MANTE #0;
    |FINSI;

    enEmpresa = nEmpresa;
    enEjer    = nEjer;
|FPRO;
