|FICHEROS;
     dsmox003;
     dsmox002;
     dsmox005;
     dsmox006;
     dsmox007;

     dsmom108;
|FIN;

|VARIABLES;
     n1Vent              = 0;
     nBtnEnv             = 0;
     nBtnCer             = 0;
     nBtnCan             = 0;
     nBtnPre             = 0;
     nHand1              = 0;
     nHand2              = 0;
     nCampo              = 0;
     nCar                = 0;
     nPos                = 0;
     nCmp                = 0;
     nPan                = 0;
     nEnvio              = 0;
     nIde                = 0;
     nRango              = 0;
     nOk                 = 0;
     nCon                = 0;
     nPausa              = 0;
     nNum                = 0;
     nLin                = 0;
     nGrid               = 0;
     nCodErr             = 0;
     nCodX6              = 0;
     nTrz                = 0;
     nLon                = 0;
     nNoPara             = 0;

     aAlfa               = "";
     aAlf1               = "";
     aAlf2               = "";
     aAlf3               = "";
     aDIR                = "";
     aAbre               = "";
     aFicPortal          = "";
     aFicRespHtm         = "";
     aFicRespTxt         = "";
     aName               = "";
     aOrigen             = "";
     aDestino            = "";
     aVal                = "";
     aF2                 = "";
     aCan                = "";
     aTecla              = "";
     aFic                = "";
     aPathPlugins        = "";
     aDocRemoto          = "";
     aDocServidor        = "";
     aIPRemoto           = "";
     aFicCert            = "";
     aEjec               = "";
     aLon                = "";
     aDato               = "";
     aReg                = "";
     aLetra              = "";
     aSep                = "";
     aPathExe            = "";
     aPath               = "";
     aVar                = "";
     aCmp                = "";
     aUrl                = "";
     aRz                 = "";
     aOri                = "";
     aDes                = "";
     aParam1             = "";
     aParam2             = "";
     aRetu               = "";
     aEsc1               = "";
     aEsc2               = "";
     aRojo               = "0,0,0;255,80,80";
     aVerde              = "0,185,0;255,255,255";

     {1}aContiene        = "";
     {99}aValor          = "";
     {10}aPopup          = "";

     {-1}aVent           = "";
         aVent1          = 0;
         aVent2          = 0;
         aVent3          = 0;
         aVent4          = 0;
         aVent5          = "";

     &eaUnidad           = "";
     &eaPathEmision      = "";
     &eaPathInternet     = "";
     &eaPathPreDecla     = "";
     &eaPathLanza        = "";
     &eaPathPdf          = "";
     &eaPathErr          = "";
     &eaPathExplorador   = "";
     &eaNIFCerti         = "";
     &eaNomCerti         = "";
     &eaFicheroPlano     = "";
     &eaFOrigen          = "";
     &eaFDestino         = "";
     &eaDSMAC            = "";
     &eaUnidadBasico     = "";
     &enErrorPortal      = 0;
     &eaAlfa             = "";
     &eaNIF              = "";
     &eaJUS              = "";
     &eaCSV              = "";
     &eaEXP              = "";
     &eaNDC              = "";
     &eaNom              = "";
     &enEmp              = 0;
     &enEje              = 0;
     &enPer              = 0;
     &enMod              = 0;
     &enCom              = 0;
|FIN;

|PROCESO GrabaX6;
     nCodX6 = nCodX6 + 1;

     #dsmox006#0 = enEmp;
     #dsmox006#1 = nCodX6;
     #dsmox006#2 = enMod;
     #dsmox006#3 = enEje;
     #dsmox006#4 = eaNom;
     #dsmox006#5 = eaNDC;
     #dsmox006#6 = eaNom;
     #dsmox006#7 = aVar;

     |GRABA 020#dsmox006.n;
     |LIBERA #dsmox006;
|FPRC;

|PROCESO GrabaX5;
     |QBF aVar;
     |SI aVar = "";
         |ACABA;
     |FINSI;

     |SELECT #1#dsmox005;
     #dsmox005#0 = enEmp;
     #dsmox005#1 = 999;
     |LEE 000#dsmox005.];
     |SI FSalida = 0;
         |LEE 000#dsmox005.a;
     |SINO;
         |LEE 000#dsmox005.u;
     |FINSI;

     nLin = 10;
     |SI FSalida = 0;  |Y  #dsmox005#0 = enEmp;
         nLin = #dsmox005#1 + 10;
     |FINSI;

     |DDEFECTO  #dsmox005;

     #dsmox005#0 = enEmp;
     #dsmox005#1 = nLin;
     #dsmox005#2 = aCmp;
     #dsmox005#3 = aVar;

     |GRABA 020#dsmox005.n;
     |LIBERA #dsmox005;

     |SI nCodErr > 0;
         #dsmox007#0 = enEmp;
         #dsmox007#1 = enEje;
         #dsmox007#2 = enPer;
         |LEE 101#dsmox007.=;
         |SI FSalida = 0;
             #dsmox007#5 = "Con errores";
             #dsmox007#7 = aRojo;
             |GRABA 020#dsmox007.a;
             |LIBERA #dsmox007;
         |FINSI;

         |HAZ GrabaX6;
     |FINSI;

     nCodErr = 0;
|FPRC;

|PROCESO LeeX5;
     aVar = "";
     aCmp = "";

     |SELECT #1#dsmox005;
     #dsmox005#0 = enEmp;
     #dsmox005#1 = nCmp;
     |LEE 000#dsmox005.=;
     |SI FSalida = 0;
         aCmp = #dsmox005#2;  |QBF aCmp;
         aVar = #dsmox005#3;  |QBF aVar;
     |FINSI;
|FPRC;

|PROCESO GrabaVar;
     |SI aAlfa = "F01";
         eaAlfa = "F01=";
         |XGRABA nHand1, eaAlfa;

         aAbre = eaPathEmision + eaFicheroPlano;
         |XABRE "UB", aAbre, nHand2;
         |PARA;  |SI; |HACIENDO;
              |XLEE nHand2, 250, aAlfa;
              |SI FSalida [ 0;  |SAL;  |FINSI;

              eaAlfa = aAlfa;  |HAZ PonRarosUTF8;
              |XGRABA nHand1, eaAlfa;
         |SIGUE;
         |XCIERRA nHand2;

         eaAlfa = &13 + &10;
         |XGRABA nHand1, eaAlfa;

         |ACABA;
     |FINSI;

     aAlf1 = "";
     aAlf2 = "";

     |SI aAlfa = "FIRNIF";
         aAlf1 = "FIRNIF";
         aAlf2 = #dsmox002#8;  |QBF aAlf2;
     |FINSI;

     |SI aAlfa = "FIRNOMBRE";
         aAlf1 = "FIRNOMBRE";
         aAlf2 = #dsmox002#9;  |QBF aAlf2;
     |FINSI;

     |SI aAlfa = "FIR";
         aAlf1 = "FIR";
         aAlf2 = "FirmaBasica";
     |FINSI;

     |SI aAlfa = "IDI";
         aAlf1 = "IDI";
         aAlf2 = "ES";
     |FINSI;

     |SI aAlfa = "NRC";
         nCmp  = 22;  |HAZ LeeX5;
         aAlf1 = "NRC";
         aAlf2 = aVar;
     |FINSI;

     eaAlfa = aAlf2;  |HAZ PonRarosUTF8;

     aAlfa = aAlf1 + "=" + eaAlfa + &13 + &10;
     |XGRABA nHand1, aAlfa;
|FPRC;

|PROCESO GrabaAlf;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHand1, aAlfa;
|FPRC;

|PROCESO Mod1;
     aAlfa = "FIRNIF";        |HAZ GrabaVar;
     aAlfa = "FIRNOMBRE";     |HAZ GrabaVar;
     aAlfa = "FIR";           |HAZ GrabaVar;
     aAlfa = "NRC";           |HAZ GrabaVar;
     aAlfa = "IDI";           |HAZ GrabaVar;
     aAlfa = "F01";           |HAZ GrabaVar;
|FPRC;

|PROCESO Mod2;
     aAlfa = "FIRNIF";        |HAZ GrabaVar;
     aAlfa = "FIRNOMBRE";     |HAZ GrabaVar;
     aAlfa = "FIR";           |HAZ GrabaVar;
     aAlfa = "IDI";           |HAZ GrabaVar;
     aAlfa = "F01";           |HAZ GrabaVar;
     aAlfa = "NRC";           |HAZ GrabaVar;
|FPRC;

|PROCESO Mod3;
     aAlfa = "FIRNIF";        |HAZ GrabaVar;
     aAlfa = "FIRNOMBRE";     |HAZ GrabaVar;
     aAlfa = "NRC";           |HAZ GrabaVar;
     aAlfa = "IDI";           |HAZ GrabaVar;
     aAlfa = "F01";           |HAZ GrabaVar;
     aAlfa = "FIR";           |HAZ GrabaVar;
|FPRC;

|PROCESO Mod4;
     aAlfa = "FIRNIF";        |HAZ GrabaVar;
     aAlfa = "FIRNOMBRE";     |HAZ GrabaVar;
     aAlfa = "FIR";           |HAZ GrabaVar;
     aAlfa = "IDI";           |HAZ GrabaVar;
     aAlfa = "NRC";           |HAZ GrabaVar;
     aAlfa = "F01";           |HAZ GrabaVar;
|FPRC;

|PROCESO Mod5;
     aAlfa = "FIRNIF";        |HAZ GrabaVar;
     aAlfa = "FIRNOMBRE";     |HAZ GrabaVar;
     aAlfa = "FIR";           |HAZ GrabaVar;
     aAlfa = "IDI";           |HAZ GrabaVar;
     aAlfa = "F01";           |HAZ GrabaVar;
|FPRC;

|PROCESO Mod6;
     aAlfa = "FIRNIF";        |HAZ GrabaVar;
     aAlfa = "FIRNOMBRE";     |HAZ GrabaVar;
     aAlfa = "IDI";           |HAZ GrabaVar;
     aAlfa = "F01";           |HAZ GrabaVar;
     aAlfa = "FIR";           |HAZ GrabaVar;
|FPRC;

|PROCESO CargaCabecera;
     |SI enMod = 111;  |HAZ Mod1;  |FINSI;
     |SI enMod = 115;  |HAZ Mod1;  |FINSI;
     |SI enMod = 123;  |HAZ Mod1;  |FINSI;
     |SI enMod = 130;  |HAZ Mod2;  |FINSI;
     |SI enMod = 131;  |HAZ Mod3;  |FINSI;
     |SI enMod = 216;  |HAZ Mod3;  |FINSI;
     |SI enMod = 303;  |HAZ Mod3;  |FINSI;
     |SI enMod = 309;  |HAZ Mod4;  |FINSI;
     |SI enMod = 322;  |HAZ Mod5;  |FINSI;
     |SI enMod = 353;  |HAZ Mod1;  |FINSI;
     |SI enMod = 390;  |HAZ Mod5;  |FINSI;
|FPRC;

|PROCESO PresentarEnvio;
     nOk = 0;

     aUrl = "https://www1.agenciatributaria.gob.es/wlpl/PFTW-PICW/PresBasica";
     |SI aDIR = "PRODUCCION";
         aUrl = "https://www7.aeat.es/wlpl/PFTW-PICW/PresBasica";
     |FINSI;

     aAlfa = eaPathLanza + "guion.txt";         |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "resp.txt";          |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "ejecuta.bat";       |RFBORRA aAlfa;

     aAbre = eaPathLanza + "guion.txt";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = "[url]";         |HAZ GrabaAlf;
     aAlfa = aUrl;            |HAZ GrabaAlf;
     aAlfa = "[cabecera]";    |HAZ GrabaAlf;

     |HAZ CargaCabecera;

     aAlfa = "[respuesta]";     |HAZ GrabaAlf;
     aAlfa = "MOD";             |HAZ GrabaAlf;
     aAlfa = "EJF";             |HAZ GrabaAlf;
     aAlfa = "PER";             |HAZ GrabaAlf;
     aAlfa = "CSV";             |HAZ GrabaAlf;
     aAlfa = "JUS";             |HAZ GrabaAlf;
     aAlfa = "REG";             |HAZ GrabaAlf;
     aAlfa = "Err[0]";          |HAZ GrabaAlf;
     aAlfa = "Err[1]";          |HAZ GrabaAlf;
     aAlfa = "Err[2]";          |HAZ GrabaAlf;
     aAlfa = "Err[3]";          |HAZ GrabaAlf;
     aAlfa = "Err[4]";          |HAZ GrabaAlf;
     aAlfa = "Err[5]";          |HAZ GrabaAlf;
     aAlfa = "Err[6]";          |HAZ GrabaAlf;
     aAlfa = "Err[7]";          |HAZ GrabaAlf;
     aAlfa = "Err[8]";          |HAZ GrabaAlf;
     aAlfa = "Err[9]";          |HAZ GrabaAlf;

     |XCIERRA nHand1;

     aAbre = eaPathLanza + "ejecuta.bat";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = aPathExe + "dsenviodirecto.exe ";            |XGRABA nHand1, aAlfa;
     aAlfa = "ds123456 0 ";                               |XGRABA nHand1, aAlfa;
     aAlfa = eaPathLanza + "guion.txt ";                  |XGRABA nHand1, aAlfa;
     aAlfa = eaPathLanza + "resp.txt ";                   |XGRABA nHand1, aAlfa;
     aAlfa = "NO ";                                       |XGRABA nHand1, aAlfa;
     aAlfa =  #dsmox002#10;   |QBF aAlfa;                 |XGRABA nHand1, aAlfa;

     |XCIERRA nHand1;

     aEjec   = aPathExe + "dsmini ";
     aEjec   = aEjec + eaPathLanza + "ejecuta.bat";
     |RSYSTEM aEjec;

     nCon  = 0;
     aAbre = eaPathLanza + "resp.txt";
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aAbre, 0;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             nCon = nCon + 1;
             |SI nCon > 120;
                 |SAL;
             |FINSI;

             |SLEEP 1;
             |PULSATECLA;
     |SIGUE;

     aAbre = eaPathLanza + "resp.txt";
     |XABRE "EC", aAbre, 0;
     |SI FSalida < 0;
         aCmp = "MENSAJE";
         aVar = "Sin respuesta. Revise la instalaci¢n y validez del certificado digital";

         nCodErr = 1;
         |HAZ GrabaX5;
         nCodErr = 0;

         |SI nNoPara = 0;
             |MENAV "0000Sin respuesta. Revise la instalaci¢n y validez del certificado digital";
         |FINSI;

         |ACABA;
     |FINSI;

     aAbre = eaPathLanza + "resp.txt";
     |XABRE "UC", aAbre, nHand1;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     nIde    = 0;
     |PARA; |SI; |HACIENDO;
          |XLEE nHand1, 250, aDato;
          |SI FSalida < 0;  |SAL;  |FINSI;

          aVar = aDato - "CSV =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "CSV";
              |HAZ GrabaX5;

              eaCSV = aVar;  |QBF eaCSV;
          |FINSI;

          aVar = aDato - "JUS =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "JUSTIFICANTE";
              |HAZ GrabaX5;

              eaJUS = aVar;  |QBF eaJUS;
          |FINSI;

          aVar = aDato - "REG =";
          |SI FSalida ! 0;
              aVar = aVar % 2;
              aCmp = "EXPEDIENTE";
              |HAZ GrabaX5;

              eaEXP = aVar;  |QBF eaEXP;
          |FINSI;

          |PARA nCmp = 0;  |SI nCmp [ 9;  |HACIENDO nCmp = nCmp + 1;
                aAlfa = "Err[" + nCmp + "] =";
                aVar  = aDato - aAlfa;
                |SI FSalida ! 0;
                    aVar = aVar % 2;
                    aCmp = "MENSAJE ";

                    nCodErr = 1;
                    |HAZ GrabaX5;
                    nCodErr = 0;
                |FINSI;
          |SIGUE;
     |SIGUE;
     |XCIERRA nHand1;

     nOk = 0;
     |SI eaCSV ! "";
         |SI enMod = 111;  enMod = 110;  |FINSI;
         |HAZ GrabaImpresoDirecto;
         |SI enMod = 110;  enMod = 111;  |FINSI;

         #dsmox007#0 = enEmp;
         #dsmox007#1 = enEje;
         #dsmox007#2 = enPer;
         |LEE 101#dsmox007.=;
         |SI FSalida = 0;
             #dsmox007#5 = "Presentado";
             #dsmox007#7 = aVerde;
             |GRABA 020#dsmox007.a;
             |LIBERA #dsmox007;
         |FINSI;

         nOk   = 1;
     |SINO;
         |SI nNoPara = 0;
             |MENAV "0000Hay errores. Consulte el mensaje de error.";
         |SINO;
             aCmp = "MENSAJE";
             aVar = "Hay errores. Consulte el mensaje de error.";
             |HAZ GrabaX5;
        |FINSI;

        |HAZ GuardaError;
     |FINSI;
|FPRC;

|PROCESO Parada;
     |SI nNoPara = 1;
         |ACABA;
     |FINSI;

     aRetu  = &255 + "802";
     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     |PARA; |SI;  |HACIENDO;
          FSalida = "::{{001}}Salir," + nGrid;
          |LEETECLA aTecla;

          |SI aTecla = aRetu; |SAL;  |FINSI;
          |SI aTecla = aEsc1; |SAL;  |FINSI;
          |SI aTecla = aEsc2; |SAL;  |FINSI;
     |SIGUE;
|FPRC;

|PROCESO VerTXT;
     aAbre = eaPathLanza + "errores.txt";
     |XABRE "EC", aAbre, 0;
     |SI FSalida < 0;
         |ACABA;
     |FINSI;

     aAbre = eaPathLanza + "ejecuta.bat";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = aPathExe + "dsabreextension ";
     aAlfa = aAlfa + eaPathLanza + "errores.txt ";
     aAlfa = aAlfa + eaPathLanza + "findsabre.txt ";
     |XGRABA nHand1, aAlfa;

     |XCIERRA nHand1;

     aEjec = aPathExe + "dsmini " + aAbre;
     |RSYSTEM aEjec;

     aAbre = eaPathLanza + "findsabre.txt";
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aAbre, 0;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             |SLEEP 1;
             |PULSATECLA;
     |SIGUE;

     aAlfa = eaPathLanza + "ejecuta.bat";       |RFBORRA aAlfa;
     aAlfa = eaPathLanza + "findsabre.txt";     |RFBORRA aAlfa;

     |FOCOTECLADO nGrid;
|FPRC;

|PROCESO VerDAT;
     |LEE 000#dsmox006.p;
     |SI FSalida = 0;
         |CONSULTA_CLAVE #1#dsmox006;
     |FINSI;

     |FOCOTECLADO nGrid;
|FPRC;

|PROCESO VerPDF;
     |SUB_EJECUTA "dsmoy998;PRES";

     |FOCOTECLADO nGrid;
|FPRC;

|PROCESO GuardaPDF;
     |SUB_EJECUTA "dsmoy998;SALVA";

     aCmp = "MENSAJE";
     aVar = "El PDF se encuentra en: " + eaPathPdf;
     |HAZ GrabaX5;

     |REFRESCACONTROL nGrid;
     |FOCOTECLADO nGrid;
|FPRC;

|PROCESO GuardaError;
     aAbre = eaPathLanza + "resp.txt";
     |XABRE "EC", aAbre, nHand1;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aOri = eaPathLanza + "resp.txt";
     aDes = eaPathErr   + (("00000" + enEmp) % -105) + ".txt";
     |RCOPIA_FICHERO aOri, aDes;

     #dsmox007#0 = enEmp;
     #dsmox007#1 = enEje;
     #dsmox007#2 = enPer;
     |LEE 101#dsmox007.=;
     |SI FSalida = 0;
         #dsmox007#5 = "Con errores";
         #dsmox007#7 = aRojo;
         |GRABA 020#dsmox007.a;
         |LIBERA #dsmox007;
     |FINSI;
|FPRC;

|PROCESO AltaDeclaracion;
     |HAZ PresentarEnvio;

     |SI nOk = 1;
         aCmp = "MENSAJE";
         aVar = "Documento Presentado";
         |HAZ GrabaX5;
     |FINSI;

     |REFRESCACONTROL nGrid;
     |PTEC 802;  |PAUSA;

     |SI nOk = 1;
         |SI nNoPara = 1;
             |HAZ GuardaPDF;

             |ACABA;
         |FINSI;

         |MENAV "0000Documento presentado. Si quiere ver el documento pulse en Visualizar PDF";

         |CONTROL_SIMPLE nPan, "BOTON,{{197}}Visualizar PDF", 3302, 3418, VerPDF;

         |HAZ GuardaPDF;
     |FINSI;

     |HAZ Parada;
|FPRC;

|PROCESO Enviar;
     |FIN_CONTROL_WINDOWS nBtnCer;
     |FIN_CONTROL_WINDOWS nBtnCan;
     |FIN_CONTROL_WINDOWS nBtnEnv;
     |FIN_CONTROL_WINDOWS nBtnPre;

     |HAZ AltaDeclaracion;

     aFic = eaPathEmision + Usuario + ".ok";
     |XABRE "WB", aFic, nHand1;

     aAlfa = "OK"
     |XGRABA nHand1, aAlfa;

     |XCIERRA nHand1;
|FPRC;

|PROCESO BtnEnv;
     nEnvio = 1;

     |PTEC 806;
|FPRC;

|PROCESO Cancelar;
     |PTEC 807;
|FPRC;

|PROCESO T0C1;  |TIPO 0;
     |SI #dsmox002#1 = "N";
         |ACABA;
     |FINSI;

     nCmp = 22;  |HAZ LeeX5;
     |SI aCmp ! "";  |Y aVar = "";
         |MENAV "0000NRC sin contenido. Pulse doble click en el registro del NRC para introducirlo.";
         #dsmox002#1 = "N";
         |PINTA #dsmox002#1;
         |ACABA;
     |FINSI;

     |SI #dsmox002#8 = "         ";
         |MENAV "0000Seleccione un presentador.";
         #dsmox002#1 = "N";
         |PINTA #dsmox002#1;
         |ACABA;
     |SINO;
         |ESTADO_CONTROL nBtnPre, "ENABLE";
     |FINSI;
|FPRC;

|PROCESO Certificados;
     |CONSULTA_CLAVE #2#dsmox003;
     |SI FSalida = 0;
         #dsmox002#8  = #dsmox003#1;  |PINTA #dsmox002#8;
         #dsmox002#9  = #dsmox003#2;  |PINTA #dsmox002#9;
         #dsmox002#10 = #dsmox003#3;
     |FINSI;

     |SI #dsmox002#8 ! "         ";
         |ESTADO_CONTROL nBtnPre, "ENABLE";
     |FINSI;
|FPRC;

|PROCESO Predeterminar;
     aPopup1  = nBtnPre;  || Si fuera -1 en la posicion
     aPopup2  = 2;
     aPopup3  = "Grabar predeterminado";
     aPopup4  = "Quitar predeterminado";

     IaPopup  = aPopup1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;
     |SI FSalida = 1;  |O FSalida = 2;
         |SI FSalida = 1;  aAlfa = #dsmox002#8;  |FINSI;
         |SI FSalida = 2;  aAlfa = "";  |FINSI;

         |ABRE #dsmom108;
         #dsmom108#0 = eaDSMAC;
         |LEE 101#dsmom108.=;
         |SI FSalida ! 0;
             |DDEFECTO #dsmom108;
             #dsmom108#0 = eaDSMAC;
             |GRABA 020#dsmom108.b;
         |FINSI;

         #dsmom108#4 = aAlfa;
         |GRABA 020#dsmom108.a;
         |LIBERA #dsmom108;
         |CIERRA #dsmom108;
     |FINSI;
|FPRC;

|PROCESO Baj5;
     #dsmox005#0 = enEmp;
     #dsmox005#1 = 0;
|FPRC;

|PROCESO Alt5;
     #dsmox005#0 = enEmp;
     #dsmox005#1 = 999;
|FPRC;

|PROCESO PideNRC;
     |VENTANA 0501, 0725, -1, 16, "Introduzca el NRC";
     n1Vent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     E_inf = "";
     E_sup = "22";

     nCmp = 22;  |HAZ LeeX5;

     |PARA;  |SI;  |HACIENDO;
          aVar  = 0602 ? 1;  |QBF aVar;

          |SI aVar ! "";  |SAL;  |FINSI;

          |MENAV "0000Campo obligatorio precisa contenido";
     |SIGUE;

     #dsmox005#0 = enEmp;
     #dsmox005#1 = 22;
     |LEE 000#dsmox005.=;
     |SI FSalida = 0;
        #dsmox005#3 = aVar;

        |GRABA 020#dsmox005.a;
        |LIBERA #dsmox005;
     |FINSI;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = n1Vent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA n1Vent;
     |PULSATECLA;

     |REFRESCACONTROL nGrid;
|FPRC;

|PROCESO Evt5;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#dsmox005.=;
     |FINSI;

     |SI FSalida ! 4;       |ACABA;  |FINSI;
     |SI #dsmox005#1 ! 22;  |ACABA;  |FINSI;

     |HAZ PideNRC;
|FPRC;

|PROGRAMA;
     |DBASE aPath;  |QBT aPath;
     aAbre = aPath + "webdirecta.txt";
     |XABRE "E", aAbre, 0;
     |SI FSalida ] 0;
         |XABRE "", aAbre, nHand1;
         |XLEE nHand1, 250, aDIR;
         |XCIERRA nHand1;
         |QBF aDIR;
         |SI aDIR = "";
             |SI nNoPara = 1;
                 |MENAV "0000Configuraci¢n incorrecta de la WEB directa.";
             |FINSI;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI nNoPara = 0;
         |SI aParam2 = "1";
             nNoPara = 1;
         |FINSI;

         |PINPA #0#dsmox002;  nPan = FSalida;
         |PINDA #0#dsmox002;

         |CONTROL_SIMPLE nPan, "LABEL,{{15}}Conforme ", 3102, 3113, NULL;

         aAlfa = "LABEL,{{7}}(Para finalizar el proceso marque la casilla ";
         aAlfa = aAlfa + &34 + "Conforme"  + &34 + "y pulse en " + &34 + "Presentar" + &34 + ")";
         |CONTROL_SIMPLE nPan, aAlfa, 3120, 3198, NULL;

         |CONTROL_SIMPLE nPan, "BOTON,{{197}}", 0921, 0922, Certificados;
         nBtnCer = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{207}}Cancelar", 3488, 3598, Cancelar;
         nBtnCan = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{197}}Firmar y enviar", 3470, 3585, BtnEnv;
         nBtnEnv = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{197}}Predeterminar presentador", 3502, 3525, Predeterminar;
         nBtnPre = FSalida;

         |SI aDIR = "PRODUCCION";
             |MENAV "0000Se env¡a al servidor de pruebas";
             |CONTROL_SIMPLE nPan, "LABEL,{{16}}Env¡o servidor de pruebas", 0578, 0598, NULL;
         |FINSI;

         |SI #dsmox002#8 = "         ";
             |ESTADO_CONTROL nBtnPre, "DISABLE";
         |FINSI;

         nRango = 4 + 8 + 16 + 32;
         |LINEAL_SIMPLE #1#dsmox005, nRango, 1202, 2998, Baj5, Alt5, Evt5;
         nGrid = FSalida;

         nEnvio = 0;
         |PARA; |SI;  |HACIENDO;
             |SI #dsmox002#1 = "S";
                 |ESTADO_CONTROL nBtnEnv, "ENABLE";
             |SINO;
                 |ESTADO_CONTROL nBtnEnv, "DISABLE";
             |FINSI;

             |PINTA #dsmox002#1;

             |ENCAMPO #1#dsmox002;
             |SI nEnvio  = 1;  |HAZ Enviar;   |SAL;  |FINSI;
             |SI FSalida = 7;
                 |SI nNoPara = 1;
                     nNoPara = 0;
                 |FINSI;
                 |SAL;
             |FINSI;
         |SIGUE;

         |ACABA;
     |FINSI;

     |SI nNoPara = 1;
         |C_V #dsmox002#1, 1, "N";

         |PINPA #0#dsmox002;  nPan = FSalida;
         |PINDA #0#dsmox002;

         nRango = 4 + 8 + 16 + 32;
         |LINEAL_SIMPLE #1#dsmox005, nRango, 1202, 2998, Baj5, Alt5, Evt5;
         nGrid = FSalida;

         |HAZ Enviar;
     |FINSI;
|FPRO;

|PROCESO TraeExes;
     |HAZ LeeUnidadBasico;

     aPathExe = eaUnidadBasico + "\MODELOS";  |RMKDIR aPathExe;
     aPathExe = aPathExe + "\DSMAC";          |RMKDIR aPathExe;
     aPathExe = aPathExe + "\";

     |DBASE aPathPlugins;  |QBT aPathPlugins;
     aPathPlugins = aPathPlugins + "plugins";
     |MKDIR aPathPlugins;
     aOrigen  = aPathPlugins + "/ds_listacerti.exe";
     aDestino = aPathExe + "ds_listacerti.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aOrigen  = aPathPlugins + "/dsmini.exe";
     aDestino = aPathExe + "dsmini.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aOrigen  = aPathPlugins + "/dsenviodirecto.exe";
     aDestino = aPathExe + "dsenviodirecto.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aOrigen  = aPathPlugins + "/dsabreextension.exe";
     aDestino = aPathExe + "dsabreextension.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aOrigen  = aPathPlugins + "/ds_eje_php.exe";
     aDestino = aPathExe + "ds_eje_php.exe";

     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Datos;
     aValor1 = "";
     aValor2 = "";

     nCampo  = 1;
     IaValor = aValor1<-;
     aLon    = aDato % 0;
     aReg    = "";
     aSep    = ";";
     |PARA nCar = 1; |SI nCar [ aLon; |HACIENDO nCar = nCar + 1;
          nPos   = (nCar * 100) + 1;
          aLetra = aDato % nPos;
          |SI aLetra = aSep;
              aValor  = aReg;
              aReg    = "";
              nCampo  = nCampo + 1;
              IaValor = IaValor + 1;
          |SINO;
               aReg = aReg + aLetra;
          |FINSI;

          |SI nCampo > 90; |SAL; |FINSI;     || Por si.... :)
     |SIGUE;

     aValor = aReg;
|FPRC;

|PROCESO ListaCertificados;
     |HAZ TraeExes;

     aFicCert = eaPathLanza + "certifi.csv";

     aAbre = eaPathLanza + "ejecuta.bat";
     |XABRE "WBC", aAbre, nHand1;

     aAlfa = aPathExe + "ds_listacerti ds123456 " + aFicCert;
     |XGRABA nHand1, aAlfa;

     |XCIERRA nHand1;

     aEjec = aPathExe + "dsmini " + aAbre;
     |RSYSTEM aEjec;

     nCon  = 0;
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa [ 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aFicCert, 0;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             |SLEEP 1;
             |PULSATECLA;

             nCon = nCon + 1;
             |SI nCon > 60;  |SAL;  |FINSI;
     |SIGUE;

     aAbre = aFicCert;
     |XABRE "UC", aAbre, nHand1;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     nIde = 0;
     |PARA; |SI; |HACIENDO;
          |XLEE nHand1, 250, aDato;
          |SI FSalida < 0;  |SAL;  |FINSI;

          |HAZ Datos;

          nIde = nIde + 1;

          #dsmox003#0 = nIde;
          #dsmox003#1 = aValor1;
          #dsmox003#2 = aValor2;
          #dsmox003#3 = aValor3;
          |GRABA 020#dsmox003.n;
          |LIBERA #dsmox003;
     |SIGUE;
     |XCIERRA nHand1;

     aAbre = eaPathLanza + "ejecuta.bat";  |RFBORRA aAbre;
     aAbre = aFicCert;                     |RFBORRA aAbre;
|FPRC;

|PROCESO T80;  |TIPO 80;
     aAlfa  = PARAMETRO % 105;
     enEmp  = aAlfa;
     nCodX6 = 0;

     aFic = "dsmox002" + Usuario;
     |NOME_DAT #dsmox002#aFic#;    |ABRET #dsmox002;

     aFic = "dsmox003" + Usuario;  |NOME_DAT #dsmox003#aFic#;
     aFic = "dsmox005" + Usuario;  |NOME_DAT #dsmox005#aFic#;
     aFic = "dsmox006" + Usuario;  |NOME_DAT #dsmox006#aFic#;
     aFic = "dsmox007" + Usuario;  |NOME_DAT #dsmox007#aFic#;

     |ABRE #dsmox003;  |CIERRA #dsmox003;  |DELINDEX #dsmox003;

     aParam1 = PARAMETRO % 601;  || 0-Emision unica  1-Masivo
     aParam2 = PARAMETRO % 701;  || 0-Parada         1-Sin parar

     |SI aParam1 = "0";  |O aParam2 = "0";
         |ABRE #dsmox006;  |CIERRA #dsmox006;  |DELINDEX #dsmox006;
         |ABRE #dsmox007;  |CIERRA #dsmox007;  |DELINDEX #dsmox007;
     |FINSI;

     |ABRET #dsmox003;
     |ABRET #dsmox005;
     |ABRET #dsmox006;
     |ABRET #dsmox007;

     |LEE 000#dsmox002.p;

     nNoPara = 1;
     |LEE 000#dsmox007.p;
     |SI FSalida ! 0;
         nNoPara = 0;
     |FINSI;

     eaPathEmision    = #dsmox002#2;  |QBF eaPathEmision;
     eaPathInternet   = #dsmox002#3;  |QBF eaPathInternet;
     eaPathPreDecla   = #dsmox002#4;  |QBF eaPathPreDecla;
     eaPathLanza      = #dsmox002#5;  |QBF eaPathLanza;
     eaPathExplorador = #dsmox002#6;  |QBF eaPathExplorador;
     eaFicheroPlano   = #dsmox002#7;  |QBF eaFicheroPlano;

     aFic = eaPathEmision + Usuario + ".ok";
     |FBORRA aFic;

     |HAZ ListaCertificados;

     |HAZ CogeMac;

     |ABRE #dsmom108;
     #dsmom108#0 = eaDSMAC;
     |LEE 000#dsmom108.=;
     |SI FSalida ! 0;  |DDEFECTO #dsmom108;  |FINSI;
     |CIERRA #dsmom108;

     nCmp = 10;  |HAZ LeeX5;
     |SI aVar ! "";
         #dsmox003#1 = aVar;
     |FINSI;

     |SI #dsmom108#4 ! "         ";
         #dsmox003#1 = #dsmom108#4;
     |FINSI;

     |SELECT #2#dsmox003;
     |LEE 000#dsmox003.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmox003;
     |FINSI;
     |SELECT #1#dsmox003;

     #dsmox002#8  = #dsmox003#1;
     #dsmox002#9  = #dsmox003#2;
     #dsmox002#10 = #dsmox003#3;

     nCmp  = 15;  |HAZ LeeX5;
     enCom = aVar;

     nCmp  = 13;  |HAZ LeeX5;
     enEje = aVar;

     nCmp  = 14;  |HAZ LeeX5;
     enPer = aVar;

     |SI aVar = "0A";  enPer = 99;  |FINSI;
     |SI aVar = "1T";  enPer =  3;  |FINSI;
     |SI aVar = "2T";  enPer =  6;  |FINSI;
     |SI aVar = "3T";  enPer =  9;  |FINSI;
     |SI aVar = "4T";  enPer = 12;  |FINSI;

     nCmp  = 10;  |HAZ LeeX5;
     eaNDC = aVar;

     nCmp  = 11;  |HAZ LeeX5;
     eaNom = aVar;

     nCmp  = 12;  |HAZ LeeX5;
     enMod = aVar;

     #dsmox007#0 = enEmp;
     #dsmox007#1 = enEje;
     #dsmox007#2 = enPer;
     #dsmox007#3 = enMod;
     #dsmox007#4 = enCom;
     #dsmox007#5 = "";
     #dsmox007#6 = eaNom;
     #dsmox007#7 = "";
     |GRABA 000#dsmox007.n;
     |LIBERA #dsmox007;

     |HAZ LeeUnidad;
     eaPathPdf = eaUnidad + "\AEAT\PDF";        |RMKDIR eaPathPdf;
     eaPathPdf = eaPathPdf + "\" + enMod;       |RMKDIR eaPathPdf;
     eaPathPdf = eaPathPdf + "\" + enEje;       |RMKDIR eaPathPdf;

     |SI enPer ! 99;
         eaPathPdf = eaPathPdf + "\" + (("00" + enPer) % -102);
         |RMKDIR eaPathPdf;
     |FINSI;
     eaPathPdf = eaPathPdf + "\";

     eaPathErr = eaUnidad + "\AEAT\ERRORES";    |RMKDIR eaPathErr;
     eaPathErr = eaPathErr + "\" + enMod;       |RMKDIR eaPathErr;
     eaPathErr = eaPathErr + "\" + enEje;       |RMKDIR eaPathErr;

     |SI enPer ! 99;
         eaPathErr = eaPathErr + "\" + (("00" + enPer) % -102) + "\";
         |RMKDIR eaPathErr;
     |FINSI;
     eaPathErr = eaPathErr + "\";

     FSalida = 3599;
|FPRC;

|PROCESO T90;  |TIPO 90;
     |CIERRAT #dsmox002;  |DELINDEX #dsmox002;
     |CIERRAT #dsmox003;  |DELINDEX #dsmox003;
     |CIERRAT #dsmox005;
     |CIERRAT #dsmox006;
     |CIERRAT #dsmox007;

     |SI nNoPara = 0;
         |DELINDEX #dsmox005;
         |DELINDEX #dsmox006;
         |DELINDEX #dsmox007;
     |FINSI;
|FPRC;
