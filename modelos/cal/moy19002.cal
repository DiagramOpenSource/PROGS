|FICHEROS;
     dsmoy000;
     dsmom002;
     dsmom004;
     dsmom025;

     dsm190ca #190;
     dsm19001;

     dsmow014;
     dsmow616;
     dsmow617;

     &clientes@;
|FIN;

|VARIABLES;
     nOk            = 0;
     nSwCara        = 0;
     aImprime       = "";
     aNombre        = "";
     aPathAfegir    = "";
     aIPRemoto      = "";
     aBue           = "";
     aExtra         = "";

     &enTipoEntrada = 0;
|FIN;

|INCLUYE i_varemi;

|PROCESO CogeNumJusti2017;
     eaJusti = "";

     |SI enDirecta = 1;
         |HAZ CalcJustificante;
         |ACABA;
     |FINSI;

     |SI #dsm190ca#11 = "N";
         eaJusti = "1900000000000";
         |ACABA;
     |FINSI;

     |HAZ CalcJustificante;
|FPRC;

|PROCESO Regis1_2017;
     enCodCli = #dsm190ca#0;
     |HAZ LeePersona;

     |DDEFECTO #dsmow616;

     #dsmow616#0  = "1";

     #dsmow616#1  = "190";

     #dsmow616#2  = #dsm190ca#1;

     |SI enSwDeDonde = 1;
         eaVarDni = #clientes@#3;  |HAZ CalculameDNI;
         #dsmow616#3   = eaVarDni;

         eaAlfa   = #clientes@#1;  |HAZ QuitaRaros;
         #dsmow616#4   = eaAlfa;

         eaAlfa   = #clientes@#1;  enLinea = 2;  |HAZ LeeTelefono;  |QBF eaAlfa;
         |SI eaAlfa = "";
             eaAlfa   = #clientes@#1;  enLinea = 1;  |HAZ LeeTelefono;
         |FINSI;
         |HAZ QuitaRarosTfno;
         #dsmow616#6   = eaAlfa;

         eaAlfa   = #clientes@#53;  |HAZ QuitaRaros;
         #dsmow616#7   = eaAlfa;

         eaAlfa   = #clientes@#1;  enLinea = 1;  |HAZ LeeMail;  |QBF eaAlfa;
         #dsmow616#16 = eaAlfa;

         eaDeleg     = #clientes@#17;
         eaAdmin     = #clientes@#18;
         eaProvincia = #clientes@#38;
     |SINO;
         aAlfa = #clientes@#96; |QBF aAlfa; |SI aAlfa = ""; #clientes@#96 = #clientes@#2; |FINSI;
         eaVarDni = #clientes@#13;  |HAZ CalculameDNI;
         #dsmow616#3   = eaVarDni;

         eaAlfa   = #clientes@#1;   |HAZ QuitaRaros;
         #dsmow616#4   = eaAlfa;

         eaAlfa   = #clientes@#14;  |HAZ QuitaRarosTfno;
         #dsmow616#6   = eaAlfa;

         eaAlfa   = #clientes@#96;   |HAZ QuitaRaros;   || Persona de Contacto
         #dsmow616#7   = eaAlfa;

         eaDeleg     = #clientes@#91;
         eaAdmin     = #clientes@#92;
         eaProvincia = #clientes@#12;
     |FINSI;

     #dsmow616#5  = "T";

     |HAZ CogeNumJusti2017;
     #dsmow616#8  = eaJusti;

     nNume   = #dsm190ca#6;
     #dsmow616#12 = ("000000000" + nNume) % -109;

     enNume  = #dsm190ca#7;  |HAZ Conver15Signo;
     #dsmow616#13 = eaSigno;
     #dsmow616#14 = eaAlfa;

     enNume  = #dsm190ca#8;  |HAZ Conver15Signo;
     #dsmow616#15 = eaAlfa;

     |SI #dsm190ca#10 = "C";
         #dsmow616#9  = "C";
         #dsmow616#11 = #dsm190ca#9;
     |FINSI;

     |SI #dsm190ca#10 = "S";
         #dsmow616#10 = "S";
         #dsmow616#11 = #dsm190ca#9;
     |FINSI;

     #dsmow616#19 = &13 + &10;

     nHCampo = 19;
     |SI eaOpcion ! "3";
         nHCampo = 18;
     |FINSI;

     aAlfa = "";
     |PARA nCampo = 0;  |SI nCampo [ nHCampo;  |HACIENDO nCampo = nCampo + 1;
           aAlfa = #dsmow616#nCampo#;
           |XGRABA nHandle2, aAlfa;
     |SIGUE;
     nTRegistro = nTRegistro + 1;
|FPRC;

|PROCESO Regis2_2017;
     enCodCli = #dsm190ca#0;
     |HAZ LeePersona;

     |DDEFECTO #dsmow617;

     #dsmow617#0  = "2";

     #dsmow617#1  = "190";

     #dsmow617#2  = #dsm190ca#1;

     |SI enSwDeDonde = 1;
         eaVarDni = #clientes@#3;  |HAZ CalculameDNI;
         #dsmow617#3   = eaVarDni;
     |SINO;
         eaVarDni = #clientes@#13;  |HAZ CalculameDNI;
         #dsmow617#3   = eaVarDni;
     |FINSI;

     |ABRE #dsmom025;
     #dsmom025#0 = #dsm19001#6;
     |LEE 040#dsmom025.=;
     |SI FSalida = 0;
         #dsmow617#4 = #dsmom025#2;
     |SINO;
         aAlfa    = #dsm19001#6;  |QBF aAlfa;
         aLong    = aAlfa % 0;
         nLong    = aLong;
         aExtra   = aAlfa % 101;

         |SI nLong > 9;  |Y aExtra = "X";
             aAlfa = (aAlfa % 101) + (aAlfa % 308);
             |SI #dsm19001#11 = "N"; |O #dsm19001#1 ] 2018;
                 #dsmow617#4 = aAlfa;
             |SINO;
                 #dsmow617#5 = aAlfa;
             |FINSI;
         |SINO;
             eaVarDni = #dsm19001#6;  |HAZ CalculameDNI;
             |SI #dsm19001#11 = "N"; |O #dsm19001#1 ] 2018;
                 #dsmow617#4 = eaVarDni;
             |SINO;
                 #dsmow617#5 = eaVarDni;
             |FINSI;
         |FINSI;
     |FINSI;
     |CIERRA #dsmom025;

     |SI #dsm19001#1 ] 2018;
         aAlfa    = #dsm19001#70;  |QBF aAlfa;
         aLong    = aAlfa % 0;
         nLong    = aLong;
         aExtra   = aAlfa % 101;

         |SI nLong > 9;  |Y aExtra = "X";
             aAlfa = (aAlfa % 101) + (aAlfa % 308);
             #dsmow617#5 = aAlfa;
         |SINO;
             eaVarDni = #dsm19001#70;  |HAZ CalculameDNI;
             #dsmow617#5 = eaVarDni;
         |FINSI;
    |FINSI;

     eaAlfa = #dsm19001#12;  |HAZ QuitaRaros;
     #dsmow617#6 = eaAlfa;

     #dsmow617#7 = ("00" + #dsm19001#13) % -102;
     #dsmow617#8 = #dsm19001#8;

     |SI #dsm19001#8 = "K";
         |SI #dsm19001#9 = "  ";
             #dsm19001#9 = "01";
         |FINSI;
     |FINSI;

     |SI #dsm19001#8 = "N";
         #dsm19001#8 = "K";
         #dsm19001#9 = "02";
     |FINSI;

     |SI #dsm19001#8 = "I";
         |SI #dsm19001#9 = "  ";
             #dsm19001#9 = "02";
         |FINSI;
     |FINSI;

     |SI #dsm19001#1 < 2019;   ||Tique 593_1269
         nOk = 0;
         |SI #dsm19001#8 = "A"; nOk = 1; |FINSI;
         |SI #dsm19001#8 = "B"; |Y #dsm19001#9 = "01"; nOk = 2; |FINSI;
         |SI nOk = 0;
            #dsm19001#16 = #dsm19001#16 + #dsm19001#65; #dsm19001#65 = 0;
            #dsm19001#17 = #dsm19001#17 + #dsm19001#66; #dsm19001#66 = 0;
         |FINSI;
         |SI nOk ! 1;
            #dsm19001#18 = #dsm19001#18 + #dsm19001#67; #dsm19001#67 = 0;
            #dsm19001#19 = #dsm19001#19 + #dsm19001#68; #dsm19001#68 = 0;
            #dsm19001#20 = #dsm19001#20 + #dsm19001#69; #dsm19001#69 = 0;
         |FINSI;
     |FINSI;

     aAlfa  = #dsm19001#9;  |QBF aAlfa;
     #dsmow617#9 = ("00" + aAlfa) % -102;

     enNume  = #dsm19001#16;  |HAZ Conver13Signo;
     #dsmow617#10 = eaSigno;
     #dsmow617#11 = eaAlfa;

     enNume  = #dsm19001#17;  |HAZ Conver13Signo;
     #dsmow617#12 = eaAlfa;

     enNume  = #dsm19001#18;  |HAZ Conver13Signo;
     #dsmow617#13 = eaSigno;
     #dsmow617#14 = eaAlfa;

     enNume  = #dsm19001#19;  |HAZ Conver13Signo;
     #dsmow617#15 = eaAlfa;

     enNume  = #dsm19001#20;  |HAZ Conver13Signo;
     #dsmow617#16 = eaAlfa;

     #dsmow617#17 = ("0000" + #dsm19001#7) % -104;

     #dsmow617#18 = #dsm19001#15;

     #dsmow617#19 = ("0000" + #dsm19001#14) % -104;

     #dsmow617#20 = #dsm19001#26;

     eaVarDni = #dsm19001#27;  |HAZ CalculameDNI;
     #dsmow617#21  = eaVarDni;

     #dsmow617#22 = #dsm19001#25;

     #dsmow617#23 = #dsm19001#10;

     #dsmow617#24 = " ";
     #dsmow617#25 = "0";

     |SI #dsm19001#40 = "S";  #dsmow617#25 = "1";  |FINSI;

     enNume  = #dsm19001#21;  |HAZ Conver13;
     #dsmow617#26 = eaAlfa;

     enNume  = #dsm19001#22;  |HAZ Conver13;
     #dsmow617#27 = eaAlfa;

     enNume  = #dsm19001#23;  |HAZ Conver13;
     #dsmow617#28 = eaAlfa;

     enNume  = #dsm19001#24;  |HAZ Conver13;
     #dsmow617#29 = eaAlfa;

     #dsmow617#30 = ("0"  + #dsm19001#41) % -101;
     #dsmow617#31 = ("0"  + #dsm19001#42) % -101;
     #dsmow617#32 = ("00" + #dsm19001#43) % -102;
     #dsmow617#33 = ("00" + #dsm19001#44) % -102;
     #dsmow617#34 = ("00" + #dsm19001#45) % -102;
     #dsmow617#35 = ("00" + #dsm19001#46) % -102;
     #dsmow617#36 = ("00" + #dsm19001#47) % -102;
     #dsmow617#37 = ("00" + #dsm19001#48) % -102;
     #dsmow617#38 = ("00" + #dsm19001#49) % -102;
     #dsmow617#39 = ("00" + #dsm19001#50) % -102;

     #dsmow617#40 = ("0"  + #dsm19001#51) % -101;
     #dsmow617#41 = ("0"  + #dsm19001#52) % -101;
     #dsmow617#42 = ("0"  + #dsm19001#53) % -101;
     #dsmow617#43 = ("0"  + #dsm19001#54) % -101;
     #dsmow617#44 = ("0"  + #dsm19001#55) % -101;
     #dsmow617#45 = ("0"  + #dsm19001#56) % -101;
     #dsmow617#46 = ("0"  + #dsm19001#57) % -101;
     #dsmow617#47 = ("0"  + #dsm19001#58) % -101;
     #dsmow617#48 = ("0"  + #dsm19001#59) % -101;
     #dsmow617#49 = ("0"  + #dsm19001#60) % -101;
     #dsmow617#50 = #dsm19001#61;
     #dsmow617#51 = #dsm19001#62;
     #dsmow617#52 = #dsm19001#63;
     #dsmow617#53 = #dsm19001#64;

     enNume  = #dsm19001#65;  |HAZ Conver13Signo;
     #dsmow617#54 = eaSigno;
     #dsmow617#55 = eaAlfa;

     enNume  = #dsm19001#66;  |HAZ Conver13Signo;
     #dsmow617#56 = eaAlfa;

     enNume  = #dsm19001#67;  |HAZ Conver13Signo;
     #dsmow617#57 = eaSigno;
     #dsmow617#58 = eaAlfa;

     enNume  = #dsm19001#68;  |HAZ Conver13Signo;
     #dsmow617#59 = eaAlfa;

     enNume  = #dsm19001#69;  |HAZ Conver13Signo;
     #dsmow617#60 = eaAlfa;

     #dsmow617#62 = &13 + &10;

     |SI #dsmow617#8 ! "A";  |Y #dsmow617#8 ! "B";  |Y #dsmow617#8 ! "C"; |Y #dsmow617#8 ! "E";
         #dsmow617#19 = "0000";
         #dsmow617#20 = "0";
         #dsmow617#21 = "         ";
         #dsmow617#22 = "0";
         #dsmow617#23 = "0";
         #dsmow617#24 = " ";
         #dsmow617#25 = "0";
         #dsmow617#26 = "0000000000000";
         #dsmow617#27 = "0000000000000";
         #dsmow617#28 = "0000000000000";
         #dsmow617#29 = "0000000000000";
         #dsmow617#30 = "0";
         #dsmow617#31 = "0";
         #dsmow617#32 = "00";
         #dsmow617#33 = "00";
         #dsmow617#34 = "00";
         #dsmow617#35 = "00";
         #dsmow617#36 = "00";
         #dsmow617#37 = "00";
         #dsmow617#38 = "00";
         #dsmow617#39 = "00";
         #dsmow617#40 = "0";
         #dsmow617#41 = "0";
         #dsmow617#42 = "0";
         #dsmow617#43 = "0";
         #dsmow617#44 = "0";
         #dsmow617#45 = "0";
         #dsmow617#46 = "0";
         #dsmow617#47 = "0";
         #dsmow617#48 = "0";
         #dsmow617#49 = "0";
         #dsmow617#50 = "0";
         #dsmow617#51 = "0";
         #dsmow617#52 = "0";
         #dsmow617#53 = "0";
     |FINSI;

     nHCampo = 62;
     |SI eaOpcion ! "3";
         nHCampo = 61;
     |FINSI;

     |SI nTecla ! 5;
         aAlfa = "";
         |PARA nCampo = 0;  |SI nCampo [ nHCampo;  |HACIENDO nCampo = nCampo + 1;
               aAlfa = #dsmow617#nCampo#;
               |XGRABA nHandle2, aAlfa;
         |SIGUE;
         nTRegistro = nTRegistro + 1;
     |SINO;
         |PRINT;
     |FINSI;
|FPRC;

|DEFBUCLE dsm19001_2017;
     #dsm19001#1;
     ;
     #190#0,#190#1,#190#2,#190#3,#190#4,#190#5,"            ",0000," ","  ",0;
     #190#0,#190#1,#190#2,#190#3,#190#4,#190#5,"zzzzzzzzzzzz",9999,"z","zz",4;
     ;
     NULL, Regis2_2017;
|FIN;

|PROCESO dsmow014_2017;
     #dsm190ca#0  = #dsmow014#0;
     #dsm190ca#1  = #dsmow014#1;
     #dsm190ca#2  = #dsmow014#2;
     #dsm190ca#3  = #dsmow014#5;
     #dsm190ca#4  = #dsmow014#7;
     #dsm190ca#5  = 0;
     |LEE 040#dsm190ca.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     #dsmom002#0 = #dsm190ca#0;
     #dsmom002#1 = 1;
     #dsmom002#2 = 110;
     |LEE 040#dsmom002.];
     |SI FSalida ! 0;  |O  #dsmom002#0 ! #dsm190ca#0;  |O  #dsmom002#2 ! 110;
         |DDEFECTO #dsmom002;
     |FINSI;

     #dsmom004#0  = #dsmow014#0;
     #dsmom004#1  = #dsmow014#1;
     #dsmom004#2  = #dsmow014#2;
     #dsmom004#3  = #dsmow014#5;
     #dsmom004#4  = #dsmow014#7;
     |LEE 040#dsmom004.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     eaFicheroPlano = "190" + (("00000" + #dsmow014#0) % -105) + ".txt";
     eaFicheroImpre = "190" + (("00000" + #dsmow014#0) % -105) + ".imp";
     eaFicheroSalid = "190" + (("00000" + #dsmow014#0) % -105) + ".sal";
     eaFicheroError = "err" + (("00000" + #dsmow014#0) % -105) + ".txt";

     aAbre = eaPathEmision + eaFicheroPlano;
     |XABRE "BW", aAbre, nHandle2;

     |HAZ Regis1_2017;

     enSinActividad = 1;
     |BUCLE dsm19001_2017;

     |XCIERRA nHandle2;

     enEmpresa    = #dsmow014#0;
     enComple     = #dsmow014#7;
     eaNomEmpresa = #dsmow014#3;

     eaX002_10    = #dsmow616#3;
     eaX002_11    = #dsmow616#4;
     eaX002_12    = #dsmoy000#0;
     eaX002_13    = #dsmoy000#6;
     eaX002_14    = 99;

     |SI #dsmow616#9 ! " ";
         eaX002_15 = #dsmow616#9;
     |FINSI;

     |SI #dsmow616#10 ! " ";
         eaX002_15 = #dsmow616#10;
         eaX002_16 = #dsmow616#11;
     |FINSI;

     eaX002_20 = #dsmow616#12;
     eaX002_21 = #dsm190ca#7;
     eaX002_22 = #dsm190ca#8;

     |HAZ PresentaPortal;
|FPRC;

|DEFBUCLE dsmow014C1_2017;
     #dsmow014#1;
     6;
     00000, 0000, 00, "S";
     99999, 9999, 99, "S";
     ;
     NULL, dsmow014_2017;
|FIN;

|DEFBUCLE dsmow014C2_2017;
     #dsmow014#2;
     6;
     "                                        ", "S";
     "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz", "S";
     ;
     NULL, dsmow014_2017;
|FIN;

|PROCESO Bloque2017;
     |HAZ BtnAnuales2015;

     |SI eaOpcion = "0";
         enInfComp = 1;
         |ACABA;
     |FINSI;

     |ABRE #dsm190ca;
     |ABRE #dsmom002;
     |ABRE #dsmom004;
     |SI #dsmoy000#8 = "C";
         |BUCLE dsmow014C1_2017;
     |SINO;
         |BUCLE dsmow014C2_2017;
     |FINSI;
     |CIERRA #dsm190ca;
     |CIERRA #dsmom002;
     |CIERRA #dsmom004;

     |SI eaOpcion = "3";
         |SI enPresentar = 0;
             aAlfa =  "      Los ficheros generados estan: " + eaPathInternet + " de su PC";
             |MENAV aAlfa;
         |FINSI;
     |FINSI;

     |SI enDirecta = 1;  |Y enMsv = 1;  |Y enParar = 0;
         |SUB_EJECUTA "|dsmox007";
     |FINSI;
|FPRC;
