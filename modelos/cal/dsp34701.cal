|FICHEROS;
     dsmozpas;
     dsmom004;
     dsmom030;
     dsmo2347;
     dsmo3347;
     dsmo4347;
     dsmom107;

     dsmom072 #72;

     :/contagen/def/canempre;
     :/contagen/def/camaniva;
     :/contagen/def/caivalin;
     :/contagen/def/caivaasi;
     :/contagen/def/camaasil;
     :/contagen/def/caclipro;
     :/contagen/def/camanefe;
     :/contagen/def/camacc01;
     :/contagen/def/camacc02;

     :/basica/def/agicen17;
     :/basica/def/agicen14;

     dsmow113;
     dsmow013 #999;

     dsmom72@;
     espejo@ #997;
     &regisnif@;
|FIN;

|VARIABLES;
     aAlfa1         = "";
     aAlfa2         = "";
     aAlfa          = "";
     aPathModelo    = "";
     aDef           = "";
     aTipo          = "";
     aClave         = "";
     aFichero       = "";

     nEjerCob       = 0;
     nHEjer         = 0;
     nEjer          = 0;
     nEjerAnterior  = 0;
     nPerCaja       = 0;
     nDPeriodo      = 0;
     nHPeriodo      = 0;
     nCampo1        = 0;
     nCampo11       = 0;
     nCampo2        = 0;
     nCampo22       = 0;
     nCampo3        = 0;
     nCampo33       = 0;
     nCampo4        = 0;
     nCampo5        = 0;
     nSwEsta        = 0;
     nGrupo         = 0;
     nSubGrupo      = 0;
     nDepar         = 0;
     nSubde         = 0;
     nBaseImpo      = 0;
     nPorce         = 0;
     nCuota         = 0;
     nPeriodo       = 0;
     nModelo        = 0;
     nLinea         = 0;

     aDepar     = "";
     aSubde     = "";
     aSeg       = "";
     aRend      = "";
     aOp1       = "";
     aOp2       = "";
     aOp3       = "";
     nOpera     = 0;
     nImporte   = 0;
     nSwExis    = 0;
     aCampo10   = "";
     aCampo11   = "";

     fDFecha    = @;
     fHFecha    = @;
     nAlgun     = 0;
     nBaseCaja  = 0;
     nCuotaCaja = 0;
     nSwHay     = 0;
     &eSwDniH   = 0;
|FIN;

|INCLUYE i_variar;


|PROCESO SituaFicheros;
     |CIERRA #camaniva;
     enEmpresa   = #dsmow013#0;
     |DBASS aPathConta;   |QBT aPathConta;
     aPathConta = aPathConta + "contagen/fich/" + (("00000" + enEmpresa) % -105) + #camacc01#18 + "/";
     |PATH_DAT #camaniva#aPathConta#;
|FPRC;

|PROCESO MiroExiste;
     nSwExis = 1;
     aCampo10 = #espejo@#10;
     aCampo11 = #espejo@#11;
|FPRC;

|DEFBUCLE MiroExiste;
    #espejo@#1013;
    ;
    enEmpresa,nEjerAnterior,99,347,00,00,#dsmow113#1,#dsmow113#0,"N","N","N","N","S";
    enEmpresa,nEjerAnterior,99,347,99,00,#dsmow113#1,#dsmow113#0,"N","N","N","N","S";
    ;
    NULL, MiroExiste;
|FIN;

|PROCESO MiroDsmow113;
     nSwExis  = 0;
     aCampo10 = "";
     aCampo11 = "";
     #dsmo2347#0  = #dsmom004#0;
     #dsmo2347#1  = #dsmom004#1;
     #dsmo2347#2  = #dsmom004#2;
     #dsmo2347#3  = #dsmom004#3;
     #dsmo2347#4  = #dsmom004#4;
     #dsmo2347#5  = 0;
     #dsmo2347#6  = #dsmow113#1;
     #dsmo2347#7  = #dsmow113#0;
     #dsmo2347#8  = "N";
     #dsmo2347#9  = "N";
     #dsmo2347#25 = "N";
     #dsmo2347#26 = "N";
     #dsmo2347#27 = "S";
     |LEE 101#dsmo2347.=;
     |SI FSalida ! 0;
         |BUCLE MiroExiste;
         |SI nSwExis = 1;
             |DDEFECTO #dsmo2347;
             #dsmo2347#0  = #dsmom004#0;
             #dsmo2347#1  = #dsmom004#1;
             #dsmo2347#2  = #dsmom004#2;
             #dsmo2347#3  = #dsmom004#3;
             #dsmo2347#4  = #dsmom004#4;
             #dsmo2347#5  = 0;
             #dsmo2347#6  = #dsmow113#1;
             #dsmo2347#7  = #dsmow113#0;
             #dsmo2347#8  = "N";
             #dsmo2347#9  = "N";
             #dsmo2347#25 = "N";
             #dsmo2347#26 = "N";
             #dsmo2347#27 = "S";
             #dsmo2347#10 = aCampo10;
             #dsmo2347#11 = aCampo11;

             |GRABA 020#dsmo2347.b;
        |FINSI;
     |SINO;
        nSwExis = 1;
     |FINSI;
     |SI nSwExis = 1;
         #dsmo2347#30 = #dsmo2347#30 + #dsmow113#2;
         |GRABA 020#dsmo2347.a;
     |FINSI;
     |LIBERA #dsmo2347;
|FPRC;

|DEFBUCLE MiroDsmow113;
    #dsmow113#1;
    ;
    "            ", " ", " ", " ", " ", " ", " ", 00, 00;
    "zzzzzzzzzzzz", "z", "z", "z", "z", "z", "z", 99, 99;
    ;
    NULL, MiroDsmow113;
|FIN;

|PROCESO ActW113;
     aTipo = "A"; |SI #camaniva#36 = "R"; aTipo = "B"; |FINSI;

     |DDEFECTO #dsmow113;
     #dsmow113#0 = #camaniva#14;
     #dsmow113#1 = aTipo;
     #dsmow113#6 = "N";
     #dsmow113#7 = "N";
     #dsmow113#20 = 01;
     #dsmow113#21 = 1;
     #dsmow113#22 = "N";
     #dsmow113#23 = "N";
     #dsmow113#24 = "S";
     |LEE 101#dsmow113.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmow113;
         #dsmow113#0 = #camaniva#14;
         #dsmow113#1 = aTipo;
         #dsmow113#6 = "N";
         #dsmow113#7 = "N";
         #dsmow113#20 = 01;
         #dsmow113#21 = 1;
         #dsmow113#22 = "N";
         #dsmow113#23 = "N";
         #dsmow113#24 = "S";
         |GRABA 020#dsmow113.b;
     |FINSI;

     #dsmow113#2 = #dsmow113#2 + (nBaseCaja + nCuotaCaja) ! 2;

     |GRABA 020#dsmow113.a;
     |LIBERA #dsmow113;
     nAlgun = 1;
|FPRC;

|PROCESO camacc02Anterior;
    |SI #camacc02#4 ] fDFecha; |Y #camacc02#4 [ fHFecha;
        nBaseCaja  = (nBaseCaja  + #camacc02#11) ! EURODBMOD;
        nCuotaCaja = (nCuotaCaja + #camacc02#12) ! EURODBMOD;
    |FINSI;
    |LIBERA #camacc02;
|FPRC;

|DEFBUCLE camacc02Anterior;
     #camacc02#1;
     ;
     #camacc01#17, #camaniva#0, #camaniva#1, 01;
     #camacc01#17, #camaniva#0, #camaniva#1, 99;
     e;
     NULL, camacc02Anterior;
|FIN;

|PROCESO camacc01;
     |SI nOpera = 0;
         nAlgun = 1;
         |ERROR10;
     |FINSI;

     |SI nOpera = 1;
         |SI nPerCaja ! #camacc01#18;
             |HAZ SituaFicheros;
         |FINSI;
         nPerCaja = #camacc01#18;
         |ABRE #camaniva;
         #camaniva#0 = #camacc01#0;
         #camaniva#1 = #camacc01#1;
         |LEE 041#camaniva.=;
         |SI FSalida = 0;
             nBaseCaja  = 0;
             nCuotaCaja = 0;
             |BUCLE camacc02Anterior;
             |SI nBaseCaja ! 0; |O nCuotaCaja ! 0;
                 |HAZ ActW113;
             |FINSI;
         |FINSI;
         |CIERRA #camaniva;
     |FINSI;
|FPRC;

|DEFBUCLE camacc01;
     #camacc01#2;
     ;
     0, nEjerAnterior, 01, 00000000001;
     9, nEjerAnterior, 99, 99999999999;
     e;
     NULL, camacc01;
|FIN;

|PROCESO CriterioCaja;
     nAlgun   = 0;
     nOpera   = 1;
     nPerCaja = -1;
     |ABRE #dsmow113;
     |BUCLE camacc01;
     |CIERRA #dsmow113;
     |SI nAlgun = 1;
         |DBASE aDef;  |QBF aDef;
         aDef = aDef + "def/dsmo2347.mas";
         |CARGA_DEF aDef, espejo@;
         |SI FSalida = 0;
             |ABRE #dsmo2347;
             |ABRE #espejo@;
             |BUCLE MiroDsmow113;
             |CIERRA #dsmo2347;
             |CIERRA #espejo@;
             |DESCARGA_DEF #espejo@;
        |FINSI;
     |FINSI;
|FPRC;

|PROCESO LosCobros347;
    nBaseCaja  = (nBaseCaja  + #camacc02#11) ! EURODBMOD;
    nCuotaCaja = (nCuotaCaja + #camacc02#12) ! EURODBMOD;
    |LIBERA #camacc02;
|FPRC;

|DEFBUCLE LosCobros347;
     #camacc02#1;
     ;
     0000, #camaniva#0, #camaniva#1, 01;
     0000, #camaniva#0, #camaniva#1, 99;
     e;
     NULL, LosCobros347;
|FIN;

|PROCESO PerCaptura;
    nPeriodo = 0;
    |SI #agicen14#15 = "MODULOS   ";
        nPeriodo = #camaniva#5;      || en de la Factura
    |SINO;
        |SI #dsmom107#27 = "F"
            nPeriodo = #camaniva#5;
        |SINO;
            |SI #camaniva#40 ! 0;
                nPeriodo = #camaniva#40;
            |SINO;
                nPeriodo = #camaniva#5;
            |FINSI;
        |FINSI;
     |FINSI;
     |SI nPeriodo = 0;
         aAlfa1 = #camaniva#4;
         aAlfa1 = aAlfa1 % 0402;
         nPeriodo = aAlfa1;
     |FINSI;
|FPRC;

|PROCESO BuscaCobro_1;
    #dsmo2347#13 = #dsmo2347#13 + #dsmow113#2;
|FPRC;

|DEFBUCLE BuscaCobro_1;
   #dsmow113#1;
   ;
   #dsmo2347#7, aClave, #dsmo2347#25, #dsmo2347#26, #dsmo2347#8, #dsmo2347#9, #dsmo2347#27, 00, 00;
   #dsmo2347#7, aClave, #dsmo2347#25, #dsmo2347#26, #dsmo2347#8, #dsmo2347#9, #dsmo2347#27, 99, 99;
   ;
   NULL, BuscaCobro_1;
|FIN;

|PROCESO GrabaNormal;
     #dsmo2347#0  = #dsmom004#0;
     #dsmo2347#1  = #dsmom004#1;
     #dsmo2347#2  = #dsmom004#2;
     #dsmo2347#3  = #dsmom004#3;
     #dsmo2347#4  = #dsmom004#4;
     #dsmo2347#5  = 0;
     #dsmo2347#6  = aClave;
     #dsmo2347#7  = #camaniva#14;
     #dsmo2347#8  = "N";
     |SI #dsmom030#50 = "X"; |Y aOp1 ! "S"; #dsmo2347#8 = "S";  |FINSI;
     #dsmo2347#9  = "N";
     #dsmo2347#25 = aOp1;
     #dsmo2347#26 = aOp2;
     #dsmo2347#27 = aOp3;
     |LEE 101#dsmo2347.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmo2347;
         #dsmo2347#0  = #dsmom004#0;
         #dsmo2347#1  = #dsmom004#1;
         #dsmo2347#2  = #dsmom004#2;
         #dsmo2347#3  = #dsmom004#3;
         #dsmo2347#4  = #dsmom004#4;
         #dsmo2347#5  = 0;
         #dsmo2347#6  = aClave;
         #dsmo2347#7  = #camaniva#14;
         #dsmo2347#8  = "N";
         |SI #dsmom030#50 = "X";  |Y aOp1 ! "S"; #dsmo2347#8 = "S";  |FINSI;
         #dsmo2347#9  = "N";
         #dsmo2347#25 = aOp1;
         #dsmo2347#26 = aOp2;
         #dsmo2347#27 = aOp3;
         #dsmo2347#10 = "N";

         eaCodNif = #dsmo2347#7;   |HAZ LeeNifs;
         #dsmo2347#11 = #regisnif@#1;

         #dsmo2347#13 = 0;
         |BUCLE BuscaCobro_1;
         |SI #dsmo2347#13 [ 6000;
             #dsmo2347#13 = 0;
         |FINSI;
         |SI enEjer ] 2012; |Y aClave ! "B";
             #dsmo2347#13 = 0;            || solo pasamos cobros
         |FINSI;

         |GRABA 020#dsmo2347.b;
     |FINSI;

     nCampo4 = 12;
     nCampo5 = 14;
     |SI enEjer > 2010; |Y #dsmo2347#27 = "N"; |Y eSwDniH = 0;
         |HAZ PerCaptura;
         |SI nPeriodo [ 3;                  nCampo4 = 16; nCampo5 = 20; |FINSI;
         |SI nPeriodo > 3; |Y nPeriodo [ 6; nCampo4 = 17; nCampo5 = 21; |FINSI;
         |SI nPeriodo > 6; |Y nPeriodo [ 9; nCampo4 = 18; nCampo5 = 22; |FINSI;
         |SI nPeriodo > 9;                  nCampo4 = 19; nCampo5 = 23; |FINSI;
     |FINSI;

     |SI #dsmo2347#25 = "S";
         #dsmo2347#nCampo4# = #dsmo2347#nCampo4# + (#caivalin#6 / enConversor) ! EURODBMOD;
     |SINO;
         #dsmo2347#nCampo4# = #dsmo2347#nCampo4# + ((((#caivalin#6 + #caivalin#8 + #caivalin#10) / enConversor)) ! EURODBMOD);
     |FINSI;

     |SI #dsmo2347#6 = "A";  |O #dsmo2347#6 = "B";
         |SI #dsmom030#91 = "X"
             #dsmo2347#nCampo5# = #dsmo2347#nCampo5# + ((((#caivalin#6 + #caivalin#8 + #caivalin#10) / enConversor)) ! EURODBMOD);
         |FINSI;
     |FINSI;

     |SI enEjer > 2010;
          |SI #dsmo2347#27 = "N";
              |SI eSwDniH = 0;
                  #dsmo2347#12 = #dsmo2347#16 + #dsmo2347#17 + #dsmo2347#18 + #dsmo2347#19;
              |FINSI;
          |SINO;
              #dsmo2347#28 = #dsmo2347#28 + (nBaseCaja + nCuotaCaja);
          |FINSI;

          |SI eSwDniH = 0;
              #dsmo2347#14 = #dsmo2347#20 + #dsmo2347#21 + #dsmo2347#22 + #dsmo2347#23;
          |FINSI;
     |FINSI;

     |GRABA 020#dsmo2347.a;
     |LIBERA #dsmo2347;
|FPRC;

|PROCESO GrabaArrendador;

     nSubde = aSubde;
     |SI nSubde = 0;
         |MENAV "    Error. Hay Fras. de Arrendamiento sin Indicar el Subdepartamento";
         aAlfa1 = enEmpresa; aAlfa1 = ("00000" + aAlfa1) % -105;
         aAlfa  = "    No pasaran al 347. Revisa los datos Contables de la Empresa " + aAlfa1;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |ABRE #agicen17;
     #agicen17#0 = #dsmom004#0;
     #agicen17#1 = aDepar;
     #agicen17#2 = aSubde;
     |LEE 040#agicen17.=;
     |SI FSalida ! 0;  |DDEFECTO #agicen17;  |FINSI;
     |CIERRA #agicen17;

     #dsmo3347#0  = #dsmom004#0;
     #dsmo3347#1  = #dsmom004#1;
     #dsmo3347#2  = #dsmom004#2;
     #dsmo3347#3  = #dsmom004#3;
     #dsmo3347#4  = #dsmom004#4;
     #dsmo3347#5  = aDepar;
     #dsmo3347#6  = aSubde;
     #dsmo3347#7  = #camaniva#14;
     |LEE 101#dsmo3347.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmo3347;
         #dsmo3347#0  = #dsmom004#0;
         #dsmo3347#1  = #dsmom004#1;
         #dsmo3347#2  = #dsmom004#2;
         #dsmo3347#3  = #dsmom004#3;
         #dsmo3347#4  = #dsmom004#4;
         #dsmo3347#5  = aDepar;
         #dsmo3347#6  = aSubde;
         #dsmo3347#7  = #camaniva#14;
         #dsmo3347#9  = #agicen17#3;
         #dsmo3347#17 = aOp3;
         eaCodNif = #dsmo3347#7;  |HAZ LeeNifs;

         #dsmo3347#8  = #regisnif@#1;

         |GRABA 020#dsmo3347.b;
     |FINSI;

     nCampo4 = 10;
     |SI enEjer > 2010; |Y eSwDniH = 0;
         |HAZ PerCaptura;
         |SI nPeriodo [ 3;                  nCampo4 = 13; |FINSI;
         |SI nPeriodo > 3; |Y nPeriodo [ 6; nCampo4 = 14; |FINSI;
         |SI nPeriodo > 6; |Y nPeriodo [ 9; nCampo4 = 15; |FINSI;
         |SI nPeriodo > 9;                  nCampo4 = 16; |FINSI;
     |FINSI;

     #dsmo3347#nCampo4# = #dsmo3347#nCampo4# + ((((#caivalin#6 + #caivalin#8 + #caivalin#10) / enConversor)) ! EURODBMOD);
     |SI enEjer > 2010; |Y eSwDniH = 0;
         #dsmo3347#10 = #dsmo3347#13 + #dsmo3347#14 + #dsmo3347#15 + #dsmo3347#16;
     |FINSI;
     |SI #dsmo3347#17 = "S";
         #dsmo3347#18 = #dsmo3347#18 + (nBaseCaja + nCuotaCaja);
     |FINSI;

     |ABRE #dsmow113;
     #dsmow113#0 = #dsmo3347#7;
     #dsmow113#1 = "B";
     #dsmow113#6 = "N";
     #dsmow113#7 = "S";
     #dsmow113#20 = aDepar;
     #dsmow113#21 = aSubde;
     #dsmow113#22 = "N";
     #dsmow113#23 = "N";
     #dsmow113#24 = aOp3;
     |LEE 000#dsmow113.=;
     |SI FSalida = 0;   ||  |Y #dsmow113#2 > 6000;
         #dsmo3347#12 = #dsmow113#2;
     |FINSI;
     |CIERRA #dsmow113;

     |GRABA 020#dsmo3347.a;
     |LIBERA #dsmo3347;
|FPRC;

|PROCESO LeoActi;
     |DDEFECTO #agicen14;
     #agicen14#0 = enEmpresa;
     #agicen14#1 = aDepar;
     |SI #agicen14#1 = 0;  #agicen14#1 = 1;   |FINSI;
     |LEE 041#agicen14.=;
|FPRC;

|PROCESO LeeLinea347;
     #dsmom030#0 = #caivalin#3;
     |LEE 040#dsmom030.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;
     |SI #dsmom030#51 = "X"; |ACABA;  |FINSI;

     aClave = "";
     |SI #dsmom030#44 = "X";  aClave = "A";  |FINSI;
     |SI #dsmom030#45 = "X";  aClave = "B";  |FINSI;
     |SI #dsmom030#46 = "X";  aClave = "C";  |FINSI;
     |SI #dsmom030#47 = "X";  aClave = "D";  |FINSI;
     |SI #dsmom030#48 = "X";  aClave = "E";  |FINSI;
     |SI #dsmom030#76 = "X";  aClave = "F";  |FINSI;
     |SI #dsmom030#77 = "X";  aClave = "G";  |FINSI;
     |SI #dsmom030#49 = "X";  aClave = "X";  |FINSI;

     |SI aClave = "";  |ACABA;  |FINSI;

     #camaniva#0  = #caivalin#0;
     #camaniva#1  = #caivalin#1;
     |LEE 040#camaniva.=;
     |SI FSalida ! 0;  |DDEFECTO #camaniva;  |FINSI;

     aAlfa1 = #caivalin#30; |QBF aAlfa1;
     |SI aAlfa1 = "";
         #caivalin#30 = #camaniva#10;
         aAlfa1 = #caivalin#31; |QBF aAlfa1;
         |SI aAlfa1 = ""; #caivalin#31 = #camaniva#11; |FINSI;
     |FINSI;

     aOp1 = "N";
     aOp2 = "N";
     aOp3 = "N";
     |SI #camaniva#4 ] "01.01.2014";
         |SI #camaniva#42 = "Z"; |O #camaniva#42 = "1"; |O #camaniva#42 = "2";
             |O #camaniva#42 = "3"; |O #camaniva#42 = "4"; |O #camaniva#42 = "5";
               |O #camaniva#42 = "6"; |O #camaniva#42 = "7"; |O #camaniva#42 = "8";
                   aOp3 = "S";
         |FINSI;
     |FINSI;
     |SI aClave = "A"; |Y #dsmom030#26 = 6; |Y #dsmom030#28 [ 2; |Y #dsmom030#28 ! 0;
         aOp1 = "S";
         aOp3 = "N";
     |FINSI;
     |SI aClave = "A"; |Y #dsmom030#26 = 0; |Y #dsmom030#30 = 3;
         aOp1 = "S";
         aOp3 = "N";
     |FINSI;

     aDepar = #camaniva#10;
     aSubde = #camaniva#11;
     |SI aMulDep = "S";
         aDepar = #caivalin#30;
         aSubde = #caivalin#31;
     |FINSI;

     |HAZ LeoActi;

     nBaseCaja  = 0;
     nCuotaCaja = 0;
     |SI aOp3 = "S";    || suma el importe de lo cobrado
         |BUCLE LosCobros347;
     |FINSI;

     |SI aClave ! "X";
         |HAZ GrabaNormal;
     |SINO;
         |HAZ GrabaArrendador;
     |FINSI;
|FPRC;

|DEFBUCLE caivalin347;
     #caivalin#1;
     ;
     00, 0000000000, 01;
     99, 9999999999, 99;
     ;
     NULL, LeeLinea347;
|FIN;

|PROCESO camaasil;
     #dsmom030#0 = #camaasil#6;
     |LEE 000#dsmom030.=;
     |SI FSalida ! 0;   |ACABA;  |FINSI;
     |SI #dsmom030#7  ! "S";  |ACABA;  |FINSI;
     |SI #dsmom030#51 = "X";  |ACABA;  |FINSI;

     aTipo = "";

     #caclipro#23 = "C";
     #caclipro#10 = #camaasil#4;
     |LEE 000#caclipro.=;
     |SI FSalida = 0;
         aTipo = "B";
     |SINO;
         #caclipro#23 = "P";
         #caclipro#10 = #camaasil#4;
         |LEE 000#caclipro.=;
         |SI FSalida = 0;
             aTipo = "A";
         |FINSI;
     |FINSI;

     |SI aTipo = "";  |ACABA;  |FINSI;
     |SI aTipo = "A"; |Y enEjer ] 2017;  || ya no los paso
         |ACABA;   || Pasamos pagos al aux. pero no al modelo
     |FINSI;

     nSwExis  = 0;
     aDepar   = #camaasil#21;
     aSubde   = #camaasil#28;
     aSeg     = "N";
     aRend    = "N";
     aOp1     = "N";
     aOp2     = "N";
     aOp3     = "N";     || poner campos en contagen
     nEjerCob = enEjer;
     #camanefe#0 = #camaasil#0;
     #camanefe#1 = #camaasil#1;
     #camanefe#2 = #camaasil#2;
     #camanefe#3 = #camaasil#3;
     |LEE 041#camanefe.=;
     |SI FSalida = 0;
         nEjerCob = #camanefe#4;
         aSeg     = #camanefe#7;
         aRend    = #camanefe#8;
         nSwExis  = 1;
     |FINSI;
     |SI nSwExis = 0; |O nEjerCob = 0;
         |SI #camaasil#28 ! "   ";
             |HAZ LeoActi;
             |SI #agicen14#9 ! 6; |Y #agicen14#9 ! 7; |Y #agicen14#9 ! 11;
                 |Y #agicen14#9 ! 12; |Y #agicen14#9 ! 16; |Y #agicen14#9 ! 17;
                 aRend = "S";
             |FINSI;
         |FINSI;
     |FINSI;
     |SI nEjerCob < 2008;   nEjerCob = enEjer; |FINSI;
     |SI nEjerCob > enEjer; nEjerCob = enEjer; |FINSI;

     nCampo4 =  2;
     nCampo5 = -1;
     |SI nEjerCob ! enEjer;
         nCampo4 = 4;
         nCampo5 = enEjer - nEjerCob; |SI nCampo5 > 12; nCampo5 = 12; |FINSI;
         nCampo5 = 7 + nCampo5;
     |FINSI;

     #dsmow113#0 = #caclipro#9;
     #dsmow113#1 = aTipo;
     #dsmow113#6 = aSeg;
     #dsmow113#7 = aRend;
     #dsmow113#20 = aDepar;
     #dsmow113#21 = aSubde;
     #dsmow113#22 = aOp1;
     #dsmow113#23 = aOp2;
     #dsmow113#24 = aOp3;
     |LEE 101#dsmow113.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsmow113;
         #dsmow113#0 = #caclipro#9;
         #dsmow113#1 = aTipo;
         #dsmow113#6 = aSeg;
         #dsmow113#7 = aRend;
         #dsmow113#20 = aDepar;
         #dsmow113#21 = aSubde;
         #dsmow113#22 = aOp1;
         #dsmow113#23 = aOp2;
         #dsmow113#24 = aOp3;
         |GRABA 020#dsmow113.b;
     |FINSI;

     |SI #dsmow113#1 = "B";
         |SI #camaasil#8 = "D";
             #dsmow113#nCampo4# = #dsmow113#nCampo4# - #camaasil#9;
             |SI nCampo5 ! -1; #dsmow113#nCampo5# = #dsmow113#nCampo5# - #camaasil#9; |FINSI;
         |SINO;
             #dsmow113#nCampo4# = #dsmow113#nCampo4# + #camaasil#9;
             |SI nCampo5 ! -1; #dsmow113#nCampo5# = #dsmow113#nCampo5# + #camaasil#9; |FINSI;
         |FINSI;
     |FINSI;

     |SI #dsmow113#1 = "A";
         |SI #camaasil#8 = "D";
             #dsmow113#nCampo4# = #dsmow113#nCampo4# + #camaasil#9;
             |SI nCampo5 ! -1; #dsmow113#nCampo5# = #dsmow113#nCampo5# + #camaasil#9; |FINSI;
         |SINO;
             #dsmow113#nCampo4# = #dsmow113#nCampo4# - #camaasil#9;
             |SI nCampo5 ! -1; #dsmow113#nCampo5# = #dsmow113#nCampo5# - #camaasil#9; |FINSI;
         |FINSI;
     |FINSI;

     |GRABA 020#dsmow113.a;
     |LIBERA #dsmow113;
|FPRC;

|DEFBUCLE camaasil;
     #camaasil#1;
     ;
     01, "01.01.0000", 000001, 0001;
     98, "31.12.9999", 999999, 9999;
     ;
     NULL, camaasil;
|FIN;

|| .... Proceso especial para pasas los cobros
|PROCESO AltaEspecial;
      |SI enEjer ] 2012; |Y #dsmom072#2 ! "B";
          |ACABA;     ||solo paso cobros
      |FINSI;

      #dsmo2347#0  = #dsmom004#0;
      #dsmo2347#1  = #dsmom004#1;
      #dsmo2347#2  = #dsmom004#2;
      #dsmo2347#3  = #dsmom004#3;
      #dsmo2347#4  = #dsmom004#4;
      #dsmo2347#5  = 0;
      #dsmo2347#6  = #dsmom072#2;
      #dsmo2347#7  = #dsmom072#3;
      #dsmo2347#8  = #dsmom072#4;
      #dsmo2347#9  = #dsmom072#5;
      #dsmo2347#25 = #dsmom072#8;
      #dsmo2347#26 = #dsmom072#9;
      #dsmo2347#27 = #dsmom072#10;
      |LEE 101#dsmo2347.=;
      |SI FSalida ! 0;
          |DDEFECTO #dsmo2347;
          #dsmo2347#0  = #dsmom004#0;
          #dsmo2347#1  = #dsmom004#1;
          #dsmo2347#2  = #dsmom004#2;
          #dsmo2347#3  = #dsmom004#3;
          #dsmo2347#4  = #dsmom004#4;
          #dsmo2347#5  = 0;
          #dsmo2347#6  = #dsmom072#2;
          #dsmo2347#7  = #dsmom072#3;
          #dsmo2347#8  = #dsmom072#4;
          #dsmo2347#9  = #dsmom072#5;
          #dsmo2347#25 = #dsmom072#8;
          #dsmo2347#26 = #dsmom072#9;
          #dsmo2347#27 = #dsmom072#10;
          #dsmo2347#10 = "N";

          eaCodNif = #dsmo2347#7;   |HAZ LeeNifs;
          #dsmo2347#11 = #regisnif@#1;

          |GRABA 020#dsmo2347.b;
      |FINSI;

      #dsmo2347#15 = #dsmo2347#15 + nImporte;

      |GRABA 020#dsmo2347.a;
      |LIBERA #dsmo2347;

      #dsmo4347#0 = #dsmo2347#0;
      #dsmo4347#1 = #dsmo2347#1;
      #dsmo4347#2 = #dsmo2347#2;
      #dsmo4347#3 = #dsmo2347#3;
      #dsmo4347#4 = #dsmo2347#4;
      #dsmo4347#5 = #dsmo2347#5;
      #dsmo4347#6 = #dsmo2347#6;
      #dsmo4347#7 = #dsmo2347#7;
      #dsmo4347#8 = #dsmo2347#8;
      #dsmo4347#9 = #dsmo2347#9;
      #dsmo4347#10 = #dsmom072#6;
      #dsmo4347#12 = #dsmom072#8;
      #dsmo4347#13 = #dsmom072#9;
      #dsmo4347#14 = #dsmom072#10;
      |LEE 141#dsmo4347.=;
      |SI FSalida ! 0;
          |DDEFECTO #dsmo4347;
          #dsmo4347#0 = #dsmo2347#0;
          #dsmo4347#1 = #dsmo2347#1;
          #dsmo4347#2 = #dsmo2347#2;
          #dsmo4347#3 = #dsmo2347#3;
          #dsmo4347#4 = #dsmo2347#4;
          #dsmo4347#5 = #dsmo2347#5;
          #dsmo4347#6 = #dsmo2347#6;
          #dsmo4347#7 = #dsmo2347#7;
          #dsmo4347#8 = #dsmo2347#8;
          #dsmo4347#9 = #dsmo2347#9;
          #dsmo4347#10 = #dsmom072#6;
          #dsmo4347#12 = #dsmom072#8;
          #dsmo4347#13 = #dsmom072#9;
          #dsmo4347#14 = #dsmom072#10;
          |GRABA 020#dsmo4347.b;
      |FINSI;
      #dsmo4347#11 = #dsmo4347#11 + nImporte;
      |GRABA 020#dsmo4347.a;
      |LIBERA #dsmo4347;
|FPRC;

|PROCESO GrabaDsmom072;
    #dsmom072#0 = enEmpresa;
    #dsmom072#1 = enEjer;
    #dsmom072#2 = #dsmow113#1;   || Clave A/B
    #dsmom072#3 = #dsmow113#0;   || Nif
    #dsmom072#4 = #dsmow113#6;   || Seguro
    #dsmom072#5 = #dsmow113#7;   || Arrendamiento
    #dsmom072#6 = nEjerCob;
    #dsmom072#8 = #dsmow113#22;
    #dsmom072#9 = #dsmow113#23;
    #dsmom072#10= #dsmow113#24;
    |LEE 101#dsmom072.=;
    |SI FSalida ! 0;
        |DDEFECTO #dsmom072;
        #dsmom072#0 = enEmpresa;
        #dsmom072#1 = enEjer;
        #dsmom072#2 = #dsmow113#1;   || Clave A/B
        #dsmom072#3 = #dsmow113#0;   || Nif
        #dsmom072#4 = #dsmow113#6;   || Seguro
        #dsmom072#5 = #dsmow113#7;   || Arrendamiento
        #dsmom072#6 = nEjerCob;
        #dsmom072#8 = #dsmow113#22;
        #dsmom072#9 = #dsmow113#23;
        #dsmom072#10= #dsmow113#24;
        |GRABA 020#dsmom072.b;
    |FINSI;
    #dsmom072#7 = #dsmom072#7 + nImporte;
    |GRABA 020#dsmom072.a;
    |LIBERA #dsmom072;
|FPRC;

|PROCESO LeeDsmow113;
    nEjerCob = enEjer;
    |SI #dsmow113#2 ! 0;
        nImporte = #dsmow113#2;
        |HAZ GrabaDsmom072;
    |FINSI;
    |PARA nCampo4 = 8; |SI nCampo4 [ 19; |HACIENDO nCampo4 = nCampo4 + 1;
          nEjerCob = nEjerCob - 1;
          |SI #dsmow113#nCampo4# ! 0;
              nImporte = #dsmow113#nCampo4#;
              |HAZ GrabaDsmom072;
          |FINSI;
    |SIGUE;
|FPRC;

|DEFBUCLE LeeDsmow113;
    #dsmow113#1;
    ;
    "            ", " ", " ", " ", " ", " ", " ", 00, 00;
    "zzzzzzzzzzzz", "z", "z", "z", "z", "z", "z", 99, 99;
    ;
    NULL, LeeDsmow113;
|FIN;

|PROCESO BuscaAcumulado;
    nImporte = nImporte + #dsmom72@#7;
|FPRC;

|DEFBUCLE BuscaAcumulado;
    #dsmom72@#1010;
    ;
    #72#0, 2008,   #72#2, #72#3, #72#8, #72#9, #72#4, #72#5, #72#10, #72#6;
    #72#0, nHEjer, #72#2, #72#3, #72#8, #72#9, #72#4, #72#5, #72#10, #72#6;
    e;
    NULL, BuscaAcumulado;
|FIN;

|PROCESO LeeDsmom072;
    |SI nOpera = 0;
        |BORRA 020#dsmom072.a;
    |FINSI;

    |SI nOpera = 1;
        |SI #dsmom072#6 ! enEjer;
            nHEjer   = enEjer - 1;
            nImporte = #dsmom072#7;
            |BUCLE BuscaAcumulado;
            |SI nImporte > 6000;
                |HAZ AltaEspecial;
            |FINSI;
        |FINSI;
    |FINSI;
    |LIBERA #dsmom072;
|FPRC;

|DEFBUCLE LeeDsmom072;
    #dsmom072#1;
    ;
    enEmpresa, enEjer, " ", "            ", " ", " ", " ", " ", " ", 2008;
    enEmpresa, enEjer, "z", "zzzzzzzzzzzz", "z", "z", "z", "z", "z", enEjer;
    be;
    NULL, LeeDsmom072;
|FIN;
|| ////////////////////////////////////////////////////////////////////

|PROCESO Leedsmo2347;
   nSwHay = 1;
   |ERROR10;
|FPRC;

|DEFBUCLE Leedsmo3347;
   #dsmo3347#1;
   ;
   #999#0,#999#2,#999#3,#999#7,enComplem,00,01;
   #999#0,#999#2,#999#3,#999#7,enComplem,99,99;
   e;
   NULL, Leedsmo2347;
|FIN;

|DEFBUCLE Leedsmo2347;
   #dsmo2347#1;
   ;
   #999#0,#999#2,#999#3,#999#7,enComplem,00," ","            ","N","N","N","N","N";
   #999#0,#999#2,#999#3,#999#7,enComplem,00,"z","zzzzzzzzzzzz","S","S","S","S","S";
   e;
   NULL, Leedsmo2347;
|FIN;
|| ////////////////////////////////////////////////////////////////////

|PROCESO Pase347;
     eSwDniH = 0; aAlfa = eaCliNif % 101;
     |SI aAlfa = "H"; eSwDniH = 1; |FINSI;

     |SI #dsmow013#2 = 2011;
         |ABRE #dsmom072;
         |LEE 040#dsmom072.p;
         |SI FSalida ! 0;
             |CIERRA #dsmom072;
             |SUB_EJECUTA "dsmoz068;pase";
         |SINO;
             |CIERRA #dsmom072;
         |FINSI;
     |FINSI;

     |ABRE #dsmom107;
     |DDEFECTO #dsmom107;
     |LEE 001#dsmom107.p;
     |CIERRA #dsmom107;

     aAlfa = "01.01." + #dsmow013#2; fDFecha = aAlfa;
     aAlfa = "31.12." + #dsmow013#2; fHFecha = aAlfa;
     enEmpresa   = #dsmow013#0;
     enEjer      = #dsmow013#2;
     enSwOpPar   = 0;
     |HAZ SituaEmpresa;
     |SI enSwPartido = 0;
         aAlfa = #dsmow013#2;
         aAlfa = aAlfa % -102;
         nEjer = aAlfa;

         |ABRE #canempre;
         |SELECT #4#canempre;
         #canempre#2  = #dsmow013#0;
         #canempre#26 = nEjer;
         |LEE 040#canempre.=;
         |SI FSalida ! 0;  |CIERRA #canempre;  |ACABA;   |FINSI;
         |CIERRA #canempre;

         |DBASS aPathConta;   |QBT aPathConta;
         aPathConta = aPathConta + "contagen/fich/" + (("00000" + #canempre#2) % -105) + #canempre#3 + "/";

         enEmpresa  = #canempre#2;
         enPerConta = #canempre#3;
         eaLaMonEmp = #canempre#28;
     |SINO;
         enPerConta = enPeriodoPar;
         eaLaMonEmp = "E";
     |FINSI;
     |HAZ EnConversor;

     |ABRE #dsmom004;
     #dsmom004#0 = #dsmow013#0;
     #dsmom004#1 = #dsmow013#2;
     #dsmom004#2 = #dsmow013#3;
     #dsmom004#3 = #dsmow013#7;
     #dsmom004#4 = #dsmow013#9;
     |LEE 040#dsmom004.=;
     |SI FSalida ! 0;  |CIERRA #dsmom004; |ACABA;   |FINSI;
     |CIERRA #dsmom004;

     enEmpresa     = #dsmow013#0;
     enEjer        = #dsmow013#2;
     enPeriodo     = #dsmow013#3;
     enModelo      = #dsmow013#7;
     enComplem     = #dsmom004#4;
     enActividad   = 0;
     enTipoEntrada = 3;
     enMensa       = 1;
     |SUB_EJECUTA_NP "dsmo1347";

     |PATH_DAT #camaniva#aPathConta#;
     |PATH_DAT #caivalin#aPathConta#;
     |PATH_DAT #caivaasi#aPathConta#;
     |PATH_DAT #camaasil#aPathConta#;
     |PATH_DAT #caclipro#aPathConta#;
     |PATH_DAT #camanefe#aPathConta#;
     |PATH_DAT #camacc01#aPathConta#;
     |PATH_DAT #camacc02#aPathConta#;

     |ABRE #caivaasi;
     |DDEFECTO #caivaasi;
     |LEE 000#caivaasi.p;
     |CIERRA #caivaasi;
     aMulDep = #caivaasi#132;

     aFichero = ("47" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #dsmow113#aFichero#;
     |DELINDEX #dsmow113;

     |ABRE #agicen14;
     |ABRE #dsmom030;
     |ABRE #caclipro;
     |ABRE #camanefe;
     |ABRE #dsmow113;
     |BUCLE camaasil;
     |CIERRA #camanefe;
     |CIERRA #caclipro;
     |CIERRA #dsmow113;

     |ABRE #camaniva;
     |ABRE #dsmo2347;
     |ABRE #dsmo3347;
     |BUCLE caivalin347;
     |CIERRA #dsmom030;
     |CIERRA #dsmo3347;
     |CIERRA #dsmo2347;
     |CIERRA #camaniva;
     |CIERRA #agicen14;

     |SI enEjer > 2010;

         |DBASE aDef;  |QBF aDef;
         aDef = aDef + "def/dsmom072.mas";
         |CARGA_DEF aDef, dsmom72@;
         |SI FSalida = 0;
             nOpera = 0; |BUCLE LeeDsmom072;

             |ABRE #dsmo2347;
             |ABRE #dsmo4347;
             |ABRE #dsmom072;
             |BUCLE LeeDsmow113;
             |CIERRA #dsmom072;
             nOpera = 1; |BUCLE LeeDsmom072;
             |CIERRA #dsmo4347;
             |CIERRA #dsmo2347;
             |DESCARGA_DEF #dsmom72@;
          |FINSI;

     |FINSI;

     |DELINDEX #dsmow113;

     |SI enSwPartido = 1;
         enSwOpPar   = 2;
         |HAZ FinalPartido;
     |FINSI;

    |SI enEjer > 2017;
         nAlgun = 0;
         nEjerAnterior = enEjer - 1;
         nOpera = 0; |BUCLE camacc01;
         |SI nAlgun = 1;
             nSwHay = 0;
             |BUCLE Leedsmo2347;
             |SI nSwHay = 0; |BUCLE Leedsmo3347; |FINSI;
             |SI nSwHay = 1;
                 enEmpresa     = #dsmow013#0;
                 enEjer        = #dsmow013#2;
                 enPeriodo     = #dsmow013#3;
                 enModelo      = #dsmow013#7;
                 enComplem     = #dsmom004#4;
                 enActividad   = 0;
                 enTipoEntrada = 98;
                 enMensa       = 1;
                 |SUB_EJECUTA_NP "dsmo1347";
              |FINSI;
              |HAZ CriterioCaja;
         |FINSI;
     |FINSI;

     nSwHay = 0;
     |BUCLE Leedsmo2347;
     |SI nSwHay = 0; |BUCLE Leedsmo3347; |FINSI;
     |SI nSwHay = 0;
         |SI enMasivo = 0;
             |MENAV "      Seleccion Vacia";
         |FINSI;
         |ACABA;
     |FINSI;

     enEmpresa     = #dsmow013#0;
     enEjer        = #dsmow013#2;
     enPeriodo     = #dsmow013#3;
     enModelo      = #dsmow013#7;
     enComplem     = #dsmom004#4;
     enActividad   = 0;
     enTipoEntrada = 98;
     enMensa       = 1;
     |SUB_EJECUTA_NP "dsmo1347";

     |ABRE #dsmom004;
     #dsmom004#0 = #dsmow013#0;
     #dsmom004#1 = #dsmow013#2;
     #dsmom004#2 = #dsmow013#3;
     #dsmom004#3 = #dsmow013#7;
     #dsmom004#4 = #dsmow013#9;
     |LEE 101#dsmom004.=;
     |SI FSalida = 0;
         #dsmom004#7  = "X";
         #dsmom004#8  = ~;
         #dsmom004#15 = 0;
         #dsmom004#17 = "COMPLETADO";

         |GRABA 020#dsmom004.a;
         |LIBERA #dsmom004;
     |FINSI;
     |CIERRA #dsmom004;
|FPRC;
