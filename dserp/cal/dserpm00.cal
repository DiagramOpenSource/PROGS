|FICHEROS;
     :dserp/dserpm00    #0;
     :dserp/dserpm01    #1;
     :dserp/dserpm02    #2;
     :dserp/dserpm04    #4;
     :dserp/dserpm05    #5;
     :dserp/dserpm06    #6;
     :dserp/dserpm07    #7,MANTE;
     :dserp/dserpm16    #16;

     defcons1@ #997;
     defconsu@ #998;
     definvoc@ #999;
|FIN;

|VARIABLES;
&eaParam = "";
     &enSwVengoERP = 0;

     aAplica = "";
     nSwArchi = 0;
     aPath = "";
     aAux = "";
     aNumEmp = "";
     nNumEmp = 0;

     &enAplicacion = 0;
     {-1}aMenu  = "";
         aMenu1 = "2400";
         aMenu2 = "1";
         aMenu3 = "Elija: ";
         aMenu4 = "CODS";
         aMenu5 = " Consulta ";
         aMenu6 = " Observaciones ";
         aMenu7 = "   Documentos  ";
         aMenu8 = "     Salir     ";

       &enERP = 0;
       &enOpcion = 0;

       aQueQuiero  = "";
       aNomDef     = "";
       aPathFic    = "";

       aDefConsu   = "";
       aDefCons1   = "";

       aComienzo   = "";
       aBase       = "";
       aDefEje     = "";
       aDef        = "";
       aMas        = "";
       aAlfa       = "";
       aAlfa1      = "";
       aAlfa2      = "";
       aAbre       = "";
       aDestino    = "";
       aFiltro     = "";
       aDirFiltros = "";
       aDirFiltros2= "";
       aPathDef1   = "";
       aPathDef    = "";
       aPathBin    = "";
       aPathPan    = "";
       aFilSinExt  = "";
       aCar1       = "";
       aCar2       = "";
       aCar3       = "";
       aCar4       = "";
       aCar5       = "";
       aCar6       = "";
       aCar24      = "";
       aCar25      = "";
       aCar26      = "";
       aCaracter   = "";
       aCadena     = "";
       aVarC1      = "";
       aVarC2      = "";
       aVarC3      = "";
       aVarC4      = "";
       aVarC5      = "";
       aVarE1      = "";
       aVarE2      = "";
       aVarE3      = "";
       aVarE4      = "";
       aVarE5      = "";
       aPathDat    = "";
       aPathDatO   = "";
       aPathDatB   = "";
       aLong       = "";
       aTitulo     = "";
       aTituloPopup= "";
       aParametro  = "";
       aDefParam   = "";
       aEmpresa    = "";
       aNombreDef  = "";

       nNivel      = 0;
       nNumRels    = 0;
       nCont       = 0;
       nCont1      = 0;
       nCalc       = 0;
       nCalc1      = 0;
       nCalc2      = 0;
       nSwHay      = 0;
       nAplicacion = 0;
       nHandle     = 0;
       nHandle2    = 0;
       nOpcion     = 0;
       nPos        = 0;
       nCampo      = 0;
       nLong       = 0;
       nContador   = 0;
       nRango      = 0;
       nVentana    = 0;
       nRelaciones = 0;
       nSkip       = 0;
       nFich       = 0;
       nEncontrado = 0;
       nCampos     = 0;
       nCar1       = 0;
       nCar2       = 0;
       nNumeDef     = 0;
       aNombDef     = "";
       nSwNombres  = 0;
       nSwBloq = 1;

     {4}aBuscador  = "";
     {4}aVentana   = "";
     {1}aPrograma  = "";
     {3}nCampoGrid = 0;
     {100}aPopup   = "";
     {100}aOpcion  = "";
     {100}FichRel  = "";

       &nDeci_DDEFECTO = 0;
|FIN;

|PROCESO Tipo12m07;  |TIPO 12;
|FPRC;

|PROCESO dserpm04;
     #1#0 = #4#0;
     |LEE 000#1=;
     |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;

     aDef = aBase + #1#1;           |QBF aDef;
     aDef = aDef + "/def/" + #4#1;  |QBF aDef;

     |SI aDef = aBuscador3;
         aMas        = #4#1;
         nAplicacion = #4#0;
         nSwHay = 1;
         |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE dserpm04;
     #4#1;
     ;
     01, "        ";
     99, "zzzzzzzz";
     ;
     NULL, dserpm04;
|FIN;

|PROCESO dserpm05;
     nContador = nContador + 1;

     aAlfa     = #5#3;  |QBF aAlfa;
     aPopup    = aAlfa;

     aAlfa     = #5#2;   |QBF aAlfa;
     aAlfa     = aAlfa + ".flt";
     aOpcion   = aAlfa;

     IaPopup   = IaPopup  + 1;
     IaOpcion  = IaOpcion + 1;
|FPRC;

|DEFBUCLE dserpm05;
     #5#2;
     ;
     nAplicacion, aMas, 001, "        ";
     nAplicacion, aMas, 999, "zzzzzzzz";
     ;
     NULL, dserpm05;
|FIN;

|RUTINA Meteselo;

     |XABRE "AB", aDirFiltros, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aDirFiltros2 = aDirFiltros + ".tmp";

     |FBORRA aDirFiltros2;

     || Hey!!! los filtros pueden ser muy largos ... incluso los simples!!!
     |XABRE "WB", aDirFiltros2, nHandle2;
     |SI FSalida < 0; |XCIERRA nHandle; |ACABA;  |FINSI;

     |XLEE nHandle, 1, aCaracter;

     nCar1 = 0;
     nCar2 = 0;
     aNomDef  = "";

     |SI aCaracter = aCar26;
         |XGRABA nHandle2, aCaracter;
         |PARA;  |SI  FSalida > 0;  |HACIENDO;
             |XLEE nHandle, 1, aCaracter;
             |SI FSalida [ 0;FSalida = -1;|SAL;  |FINSI;
             |SI aCaracter = aCar1;
                 |XGRABA nHandle2, aCaracter;
                 nCar1 = nCar1 + 1;
                 |SI nCar1 = nCampos; || Debemos estar al final del fichero
                    aCaracter = "000";
                    |XGRABA nHandle2, aCaracter;
                    aCaracter = ("000"+ #6#3 ) % -103;
                    |XGRABA nHandle2, aCaracter;
                    aAlfa = "N1" + aCar2 + aCar2;
                    |XGRABA nHandle2, aAlfa;
                    nCampo = #6#5;
                    aAlfa = #999nCampo;
                    |XGRABA nHandle2, aAlfa;
                    |XGRABA nHandle2, aCar1;
                    |SAL;
                 |FINSI;
             |SINO;
                 |SI aCaracter = aCar2;
                      |XGRABA nHandle2, aCaracter;
                      nCar2 = nCar2 + 1;
                  |SINO;
                      |SI nCar2 = 1;
                         aNombreDef = aNombreDef + aCaracter;
                      |FINSI;
                      |SI aCaracter = aCar24;
                           |XGRABA nHandle2, aCaracter;
                           |XLEE nHandle, 3, aCaracter; || Numero de campos
                           nCampos = aCaracter;
                           aCaracter = ("000"+(N\ nCampos + 1)) % -103; || sumamos uno y formateamos
                           |XGRABA nHandle2, aCaracter;
                      |SINO;
                           |SI aCaracter = aCar25;
                               aAlfa = aNombreDef + "[-1]"; || No lo podemos vincular a la presentacion del editor de filtros
                               |XGRABA nHandle2, aAlfa;
                               |XGRABA nHandle2, aCar2;
                               |XGRABA nHandle2, aCaracter;
                           |SINO;
                               |XGRABA nHandle2, aCaracter;
                           |FINSI;
                     |FINSI;
                  |FINSI;
             |FINSI;
         |SIGUE;
     |FINSI;

     |XCIERRA nHandle;
     |XCIERRA nHandle2;
|FRUT;

|RUTINA GrabaCampo;
    || Grabamos tal y como lo hace el basico actualmente ... seamos gentiles y evitemos problemas.
    aAlfa = aVarC2 % 105;
    |XGRABA nHandle2, aAlfa;
    |XGRABA nHandle2, aVarC1;
    aAlfa = aVarC2 % 699; || uhmmm 99 ...
    |XGRABA nHandle2, aAlfa;
|FRUT;

|RUTINA ProcesaCampo;
     aVarC1     = ""; || Guardaremos los flags aqui,
                      ||   tecnicamente podrian estar en cualquier parte antes de aCar1
                      ||   aunque el basico a dia de hoy los grabe siempre despues del campo
                      ||   el visualizable y el tipo de operacion.
     aVarC2     = ""; || Guardaremos el resto de informacion.
     nSkip      = 1;  || Flag de que se ha acabado o no
     |XLEE nHandle, 1, aCaracter;
     |PARA;  |SI  FSalida > 0;  |HACIENDO;
          |SI aCaracter = aCar1;
              nSkip = 0;
              |SAL;
          |FINSI;
          |SI aCaracter > aCar2;|Y aCaracter < aCar24;
             aVarC1 = aVarC1 + aCaracter;
          |SINO;
             aVarC2 = aVarC2 + aCaracter;
          |FINSI;
          |XLEE nHandle, 1, aCaracter;
     |SIGUE;
     || aVarC2 ya es la informacion del campo en formato fijo, sin flags
     nCampo = (A\aVarC2 % 103);
     ||SI nCampo = #6#3; || Bingo
     |SI nCampo = #16#4; || Bingo
         nEncontrado = 1;
         || Hay que reformatearlo, no queremos condiciones etc, solo comparacion a valor,
         || a este campo el resto hay que borrarlo!!! Se debe tener claro por parte del usuario
         || Los flags sin embargo los conservaremos todos
         aVarC2 = (aVarC2 % 104) + "1" + aCar2 + aCar2; || Limite inferior y superior vacios
         ||nCampo = #6#5;
         nCampo = #16#6;
         aAlfa = #999nCampo;
         aVarC2 = aVarC2 + aAlfa;
         |HAZ GrabaCampo;
         |SI nSkip = 0; || Ok el resto no nos interesa asi que vamos a pasarlo aqui aligerando
              |XGRABA nHandle2, aCaracter;
           |XLEE nHandle, 1, aCaracter;
           |PARA;  |SI  FSalida > 0;  |HACIENDO;
                   |XGRABA nHandle2, aCaracter;
                   |XLEE nHandle, 1, aCaracter;
              |SIGUE;
              nSkip = 1;
         |FINSI;
     |SINO;
         |HAZ GrabaCampo; || No lo tocamos
     |FINSI;
|FRUT;


|RUTINA Cambialo;
     |PARA nCont1 = 0; |SI nCont1 < 100; |HACIENDO nCont1 = nCont1 + 1;
        IFichRel = FichRel1<-; IFichRel = IFichRel + nCont1;
        FichRel = "";
     |SIGUE;

     nEncontrado = 0;
     |XABRE "AB", aDirFiltros, nHandle;
     |SI FSalida < 0;  FSalida = -1;|ACABA;  |FINSI;

     aDirFiltros2 = aDirFiltros + ".tmp";
     |FBORRA aDirFiltros2;

     |XABRE "WB", aDirFiltros2, nHandle2;
     |SI FSalida < 0; |XCIERRA nHandle; FSalida = -2;|ACABA;  |FINSI;

     |XLEE nHandle, 1, aCaracter;
     |SI aCaracter = aCar26;
         |XGRABA nHandle2, aCaracter;

         |XLEE nHandle, 3, aCaracter;
         |XGRABA nHandle2, aCaracter;

         nNumeDef = aCaracter; aNombDef = ""; nSwNombres = 1; nSwBloq = 0;
         |XLEE nHandle, 1, aCaracter;
         |PARA;  |SI  FSalida > 0;  |HACIENDO;
             ||XGRABA nHandle2, aCaracter;

             |SI nSwBloq = 2;
                |SI aCaracter < "0"; |O aCaracter > "9"; nSwBloq = 0; |FINSI;
             |FINSI;
             |SI nSwBloq = 1;
                |SI aCaracter = aCar2; nSwBloq = 2; |FINSI;
             |FINSI;

             |SI nSwBloq = 0;
                |SI nSwNombres ] 1;
                   |SI aCaracter ! aCar2; |Y aCaracter ! aCar24;
                      aNombDef = aNombDef + aCaracter;
                   |SINO;
                      nCalc = nSwNombres - 1;
                      IFichRel = FichRel1<-; IFichRel = IFichRel + nCalc;
                      FichRel = aNombDef; aAlfa = aNombDef; aNombDef = ""; nSwBloq = 1;
                      nSwNombres = nSwNombres + 1;
                      |SI aCaracter = aCar24;
                         nSwNombres = 0; nSwBloq = 0;
                         |XGRABA nHandle2, aCaracter;
                      |SINO;
                         aAlfa1 = aAlfa - "dserp";
                         |SI FSalida ! 0;
                            nCalc1 = ((FSalida / 100) ! 0) + 99;
                            nCalc2 = FSalida + 94;
                            aAlfa = (aAlfa1 % nCalc1) + #2#4 + (aAlfa1 % nCalc2); |QBT aAlfa;
                         |FINSI;
                         aAlfa = aAlfa + aCaracter;
                         |XGRABA nHandle2, aAlfa;
                      |FINSI;
                   |FINSI;
                |SINO;
                   |XGRABA nHandle2, aCaracter;
                |FINSI;
             |SINO;
                |XGRABA nHandle2, aCaracter;
             |FINSI;

             |SI aCaracter = aCar1; |O aCaracter = aCar25;
                 |XLEE nHandle, 3, aCaracter; || fichero
                 |XGRABA nHandle2, aCaracter;
                 nFich = aCaracter;
/*
                 |SI nFich = 0;    || Solo funciona con el fichero principal PEPE
                     |HAZ ProcesaCampo; || Lo hacemos en el mismo orden que el basico por si acaso
                     |SI nSkip = 1;
                         |SAL; || La rutina devuelve que hemos acabado
                     |FINSI;
                 |SINO;
                     |XLEE nHandle, 1, aCaracter;
                 |FINSI;
*/
                 IFichRel = FichRel1<-; IFichRel = IFichRel + nFich;
                 aAlfa = #16#3; |QBF aAlfa;
                 aAlfa = FichRel - aAlfa;
                 |SI FSalida ! 0;
                     |HAZ ProcesaCampo; || Lo hacemos en el mismo orden que el basico por si acaso
                     |SI nSkip = 1;
                         |SAL; || La rutina devuelve que hemos acabado
                     |FINSI;
                 |SINO;
                     |XLEE nHandle, 1, aCaracter;
                 |FINSI;
             |SINO;
                 |XLEE nHandle, 1, aCaracter;
             |FINSI;
         |SIGUE;
     |SINO;
         |XCIERRA nHandle;
         |XCIERRA nHandle2;
         FSalida = "ANTIGUO"; || Pues eso es antiguo ... que lo manipule la rutina antigua
         |ACABA;
     |FINSI;

     |XCIERRA nHandle;
     |XCIERRA nHandle2;
     FSalida = 0;
|FRUT;

|PROCESO dserpm06;
     aCar1      = &1;
     aCar2      = &2;
     aCar3      = &3;
     aCar4      = &4;
     aCar5      = &5;
     aCar6      = &6;
     aCar24     = &24;
     aCar25     = &25;
     aCar26     = &26;

     |HAZ Cambialo;
     |SI FSalida ! "ANTIGUO";
        |SI nEncontrado = 0;
           |HAZ Meteselo;
        |FINSI;
        |FBORRA aDirFiltros;
        |RENOMBRA_FICHERO aDirFiltros2,aDirFiltros;
        |ACABA;
     |FINSI;
     || ************* Sigue el proceso antiguo solo se ejecutara en caso de formato antiguo


     nCampoGrid1 = defconsu@;
     nCampoGrid2 = #6#3;
     nCampoGrid3 = -1;
     |ESPECIFICA "CAMPOGRID", nCampoGrid;
     |SI FSalida < 0;
         |MENAV "0000 No puedo localizar el Campo en el Grid.";
         |ACABA;
     |FINSI;

     nPos       = 0;
     aVarC1     = "";
     aVarC2     = "";
     aVarC3     = "";
     aVarC4     = "";
     aVarC5     = "";
     aVarE1     = "";
     aVarE2     = "";
     aVarE3     = "";
     aVarE4     = "";
     aVarE5     = "";
     aCadena    = "";

     nFich = 0;
     nSkip = 0;
     nRelaciones = 0;

     nEncontrado = 0;

     |XABRE "AB", aDirFiltros, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aDirFiltros2 = aDirFiltros + ".tmp";

     || Hey!!! los filtros pueden ser muy largos ... incluso los simples!!!
     |XABRE "WB", aDirFiltros2, nHandle2;
     |SI FSalida < 0; |XCIERRA nHandle; |ACABA;  |FINSI;

     |XLEE nHandle, 1, aCaracter;

     |SI aCaracter = aCar26
         |XGRABA nHandle2, aCaracter;
         || Atencion!! Es formato con relaciones!!
         nRelaciones = 1;
         || *********************************************************************************
         || Como no se necesitan ahora las relaciones en esto las ignoramos
         || lo unico que hay que saber de momento es que el fichero 0 siempre es el principal
         || *********************************************************************************
         |PARA;  |SI  FSalida > 0;  |HACIENDO;
              |XLEE nHandle, 1, aCaracter;
              |SI FSalida [ 0;FSalida = -1;|SAL;  |FINSI;
              |XGRABA nHandle2, aCaracter;
              |SI aCaracter = aCar25;
                  |XLEE nHandle, 3, aCaracter; || Saltamos numero de fichero
                  nFich = aCaracter; || Si hay error ... volvera a dar en la lectura chequeada
                  |XGRABA nHandle2, aCaracter;
                  |SAL;
              |FINSI;
         |SIGUE;
     |SINO;
         nSkip = 1;
         nEncontrado = 1; || para el formato antiguo siempre ha de haber el campo
     |FINSI;

     |PARA;  |SI  FSalida ] 0;  |HACIENDO;
             |SI nSkip > 0;
                  nSkip = nSkip - 1;
             |SINO;
                  |XLEE nHandle, 1, aCaracter;
                  |SI FSalida [ 0;         |SAL;  |FINSI;
             |FINSI;

             |SI aCaracter ! aCar3;  |Y aCaracter ! aCar4;
              |Y aCaracter ! aCar5;  |Y aCaracter ! aCar6;
                 |SI aCaracter = aCar1;
                     nCampo = aVarC1;
                     |SI nRelaciones = 1;
                         |SI nFich = 0;|Y #6#3 = nCampo;
                             nCampo = #6#5;
                             aVarC5 = #999nCampo;
                             aAlfa1 = aVarC3 % 101;
                             aAlfa2 = aVarC3 % 201;
                             |SI aAlfa1 = "4";
                                 aVarC3 = "1" + aAlfa2;
                             |FINSI;
                             nEncontrado = 1;
                         |FINSI;
                     |SINO;
                         || Aqui pasamos de añadir el campo, el antiguo filtro lo metia todo
                         |SI nCampoGrid3 = nCampo;
                             nCampo = #6#5;
                             aVarC5 = #999nCampo;
                             aAlfa1 = aVarC3 % 101;
                             aAlfa2 = aVarC3 % 201;
                             |SI aAlfa1 = "4";
                                 aVarC3 = "1" + aAlfa2;
                             |FINSI;
                         |FINSI;
                     |FINSI;

                     aAlfa1 = aVarC3 % 101;
                     aAlfa2 = aVarC3 % 201;
                     |SI aAlfa1 = "0";
                         aVarC3 = "4" + aAlfa2;
                     |FINSI;

                     aAlfa   = aVarE1 + aVarE2 + aVarE3 + aVarE4 + aVarE5;
                     aAlfa   = aAlfa + aVarC1 + aVarC2 + aVarC3 + aVarC4 + aVarC5 + aCaracter;
                     aCadena = aCadena + aAlfa;
                     |XGRABA nHandle2, aCadena; || Si, el resto es igual ...

                     aCadena    = "";
                     aVarC1     = "";
                     aVarC2     = "";
                     aVarC3     = "";
                     aVarC4     = "";
                     aVarC5     = "";
                     aVarE1     = "";
                     aVarE2     = "";
                     aVarE3     = "";
                     aVarE4     = "";
                     aVarE5     = "";
                     nPos       = 0;
                     |SI nRelaciones = 1;
                         |XLEE nHandle, 3, aCaracter; || Saltamos numero de fichero
                         nFich = aCaracter;
                         |XGRABA nHandle2, aCaracter;
                     |FINSI;
                 |SINO;
                     |SI nPos [ 2;
                         aVarC1    = aVarC1 + aCaracter;
                         nPos      = nPos + 1;
                         aCaracter = "";
                     |FINSI;

                     |SI nPos = 3;  |Y aCaracter ! "";
                         aVarC2    = aVarC2 + aCaracter;
                         nPos      = nPos + 1;
                         aCaracter = "";
                     |FINSI;

                     |SI nPos ] 4;
                          |SI nPos = 4; |Y aCaracter ! "";
                              aVarC3 = aVarC3 + aCaracter;
                              |SI aCaracter = aCar2;  nPos = nPos + 1;  |FINSI;
                              aCaracter = "";
                          |FINSI;

                          |SI nPos = 5; |Y aCaracter ! "";
                              aVarC4 = aVarC4 + aCaracter;
                              |SI aCaracter = aCar2;  nPos = nPos + 1;  |FINSI;
                              aCaracter = "";
                          |FINSI;

                          |SI nPos = 6; |Y aCaracter ! "";
                              aVarC5 = aVarC5 + aCaracter;
                              |SI aCaracter = aCar2;  nPos = nPos + 1;  |FINSI;
                              aCaracter = "";
                          |FINSI;
                     |FINSI;
                 |FINSI;
             |SINO;
                |SI aVarE1 = "";
                    aVarE1 = aCaracter;
                |SINO;
                    |SI aVarE2 = "";
                        aVarE2 = aCaracter;
                    |SINO;
                        |SI aVarE3 = "";
                            aVarE3 = aCaracter;
                        |SINO;
                            |SI aVarE4 = "";
                                aVarE4 = aCaracter;
                            |SINO;
                                |SI aVarE5 = "";
                                    aVarE5 = aCaracter;
                                |FINSI;
                            |FINSI;
                        |FINSI;
                    |FINSI;
                |FINSI;
             |FINSI;
     |SIGUE;
     |XCIERRA nHandle;
     |XCIERRA nHandle2;
     |SI nEncontrado = 0;
         |HAZ Meteselo;
     |FINSI;
     |FBORRA aDirFiltros;
     |RENOMBRA_FICHERO aDirFiltros2,aDirFiltros;
|FPRC;

|DEFBUCLE dserpm06;
     #6#1;
     ;
     nAplicacion, aMas, aFilSinExt, 000;
     nAplicacion, aMas, aFilSinExt, 999;
     ;
     NULL, dserpm06;
|FIN;

|DEFBUCLE dserpm16;
     #16#1;
     ;
     nAplicacion, aMas, aFilSinExt, "        ", 000;
     nAplicacion, aMas, aFilSinExt, "zzzzzzzz", 999;
     ;
     NULL, dserpm06;
|FIN;

|PROCESO GrabaEnFiltro;
     |DBASE aBase;   |QBF aBase;
     aDirFiltros = aBase + "filtros/" + (("00" + nAplicacion) % -102) + "/" + aFiltro;
     aFilSinExt  = aFiltro - ".flt";

     ||BUCLE dserpm06;
     |BUCLE dserpm16;
|FPRC;

|PROCESO ConsulEmpresa;
     |DBASS aBase;   |QBF aBase;
     aPathDef = aBase + #2#4;  |QBF aPathDef;
     aPathDef = aPathDef + "/def/" + #1#3;  |QBF aPathDef; aDefConsu = aPathDef;
     |CARGA_DEF aPathDef, defconsu@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el fichero " + aPathDef;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     aLong = "|C000LONGITUD";
     aLong = #998#aLong#;
     nLong = aLong;
     nPos  = -(100 + nLong);

     aPathDatB = aBase + #2#4;  |QBF aPathDatB;
     aPathDatB = aPathDatB + "/fich/";
     aTitulo   = "";
     |PATH_DAT #998 aPathDatB;
     |ABRE #998;
     |CONSULTA_CLAVE #1#998;
     |SI FSalida = 0;
         |SI #1#3 ! "canempre";  |Y #1#3 ! "canempr1";
             #7#2    = ((("0" * nLong) + #998#0) % nPos);
         |SINO;
             #7#2 = ("00000" + #998#2) % -105;
             #7#3 = #998#3;
         |FINSI;
         aTitulo = #998#1;
     |FINSI;
     |CIERRA #998;

     |DESCARGA_DEF #defconsu@;

     aAlfa = #1#2;   |QBF aAlfa;
     |SI #1#3 ! "canempre";  |Y #1#3 ! "canempr1";
         aAlfa = aAlfa + " EMPRESA " + #7#2 + " " + aTitulo;
     |SINO;
         aAlfa = aAlfa + " EMPRESA " + #7#2 + " PERIODO " + #7#3 + " " + aTitulo;
     |FINSI;
     #7#4  = aAlfa;
|FPRC;

|PROCESO DeOtraAplicacion;
     |ABRE #1;
     #1#0 = #2#3;
     |LEE 040#1=;
     |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;
     |CIERRA #1;

     |SI #1#3 = "        ";
         aPathDatO = aBase + #2#4;  |QBF aPathDatO;
         aPathDatO = aPathDatO + "/fich/";
     |SINO;
         |ABRE #7;
         #7#0 = Usuario % 810;
         #7#1 = #2#3;
         |LEE 101#7=;
         |SI FSalida ! 0;
             |DDEFECTO #7;
             #7#0 = Usuario % 810;
             #7#1 = #2#3;
             |HAZ ConsulEmpresa;
             |GRABA 020#7b;
         |FINSI;

         |PUSHV 0501 2380;
         |PARA;  |SI;  |HACIENDO;
              #7#5  = "N";

              |PINPA #0#7;
              |PINDA #0#7;
              |ENDATOS #1#7;
              |SI FSalida = 0;
                  |SI #7#5 = "S";
                      |HAZ ConsulEmpresa;
                  |SINO;
                      |SAL;
                  |FINSI;
              |FINSI;
         |SIGUE;
         |POPV;

         |GRABA 020#7a;
         |LIBERA #7;
         |CIERRA #7;

         aAlfa1    = #7#2;   |QBF aAlfa1;
         aAlfa2    = #7#3;   |QBF aAlfa2;
         aPathDatO = aBase + #2#4;  |QBF aPathDatO;
         aPathDatO = aPathDatO + "/fich/" + aAlfa1 + aAlfa2 + "/";
     |FINSI;
|FPRC;

|PROCESO Evento;
     |SI FSalida = 1;
         |LEE 040#998=;
         |ACABA;
     |FINSI;

     |SI FSalida = 4;
        aVentana1 = "0";        || Posicion Inicial
        aVentana2 = "0";        || Posicion Final
        aVentana3 = "1";        ||
        aVentana4 = aTituloPopup;  || Titulo
        || aVentana4 = aPopup;     || Titulo -> mal, aPopup tambien se usa luego en el menu de consulta observaciones ... y vuelve aqui!
        |ESPECIFICA "POPUPMODE", aVentana;

        |SI #2#8 ! #2#6; |Y #2#8 ! "        ";
           |DBASS aPathDef1; |QBF aPathDef1;
           aPathDef1 = aPathDef1 + #2#4;  |QBF aPathDef1;
           aPathDef1 = aPathDef1 + "/def/" + #2#8;  |QBF aPathDef1; aDefCons1 = aPathDef1;
           |CARGA_DEF aPathDef1, defcons1@;
           |SI FSalida = 0;
              |DBASS aAlfa; |QBF aAlfa;
              aAlfa = aAlfa + #2#4; |QBF aAlfa;
              aAlfa = aAlfa + "/fich/";
              |SI #1#3 ! "        ";
                 aAlfa = aAlfa + aEmpresa + "/";
              |FINSI;
              |PATH_DAT #997 aAlfa;
              |PATH_PAN #997 aPathPan;

              |ABRE #defcons1@;
              aAlfa = "|NR"; aAlfa = #defconsu@#aAlfa#;
              nNumRels = aAlfa; nNumRels = nNumRels - 1;
              |PARA nCont = 0; |SI nCont [ nNumRels; |HACIENDO nCont = nCont + 1;
                 aAlfa = "|R" + (("000" + nCont) % -103); aAlfa = #defconsu@#aAlfa#;
                 aAlfa = aAlfa - "|";
                 |SI FSalida ! 0;
                    nCalc = ((FSalida / 100) ! 0) + 99;
                    aAlfa = aAlfa % nCalc;
                    |SI aAlfa = #2#8;
                       |SAL;
                    |FINSI;
                 |FINSI;
              |SIGUE;
              |SI aAlfa = #2#8;
                 aAlfa1 = "|K000"; aAlfa1 = #defcons1@#aAlfa1#; aAlfa1 = aAlfa1 % 0499;
                 aAlfa  = "|R" + (("000" + nCont) % -103); aAlfa = #defconsu@#aAlfa#;
                 aAlfa  = aAlfa - "|";
                 |SI FSalida ! 0;
                    nCalc = (((FSalida / 100) ! 0) * 100) + 99;
                    aAlfa = aAlfa % nCalc; aAlfa = aAlfa % 0499;
                    |PARA; |SI aAlfa ! ""; |HACIENDO;
                        aAlfa2 = aAlfa % 0103;  nCalc  = aAlfa2; nCalc = nCalc - 1;
                        aAlfa2 = aAlfa1 % 0103; nCalc1 = aAlfa2;
                        aAlfa = aAlfa % 0499; aAlfa1 = aAlfa1 % 0499;
                        #defcons1@#nCalc1# = #defconsu@#nCalc#;
                    |SIGUE;
                    |LEE 000#defcons1@.=;
                    |PINPA #0#defcons1@; |PINDA #0#defcons1@;
                    |PINDA #0#defconsu@;
                 |FINSI;
              |FINSI;
           |FINSI;
        |SINO;
||           |PINPA #0#defconsu@; |PINDA #0#defconsu@;

             |DBASS aPathDef1; |QBF aPathDef1;
             aPathDef1 = aPathDef1 + #2#4;  |QBF aPathDef1;
             aPathDef1 = aPathDef1 + "/def/" + #2#6;  |QBF aPathDef1; aDefCons1 = aPathDef1;
             |CARGA_DEF aPathDef1, defcons1@;
             |SI FSalida = 0;
                 |DBASS aAlfa; |QBF aAlfa;
                 aAlfa = aAlfa + #2#4; |QBF aAlfa;
                 aAlfa = aAlfa + "/fich/";
                 |SI #1#3 ! "        ";
                     aAlfa = aAlfa + aEmpresa + "/";
                 |FINSI;
                 |PATH_DAT #997 aAlfa;

                 |ABRE #defcons1@;
                 aAlfa = "|NR"; aAlfa = #defconsu@#aAlfa#;
                 nNumRels = aAlfa; nNumRels = nNumRels - 1;
                 |PARA nCont = 0; |SI nCont [ nNumRels; |HACIENDO nCont = nCont + 1;
                    aAlfa = "|R" + (("000" + nCont) % -103); aAlfa = #defconsu@#aAlfa#;
                    aAlfa = aAlfa - "|";
                    |SI FSalida ! 0;
                       nCalc = ((FSalida / 100) ! 0) + 99;
                       aAlfa = aAlfa % nCalc;
                       |SI aAlfa = #2#8;
                          |SAL;
                       |FINSI;
                    |FINSI;
                 |SIGUE;
                 |SI aAlfa = #2#8;
                    aAlfa1 = "|K000"; aAlfa1 = #defcons1@#aAlfa1#; aAlfa1 = aAlfa1 % 0499;
                    aAlfa  = "|R" + (("000" + nCont) % -103); aAlfa = #defconsu@#aAlfa#;
                    aAlfa  = aAlfa - "|";
                    |SI FSalida ! 0;
                       nCalc = (((FSalida / 100) ! 0) * 100) + 99;
                       aAlfa = aAlfa % nCalc; aAlfa = aAlfa % 0499;
                       |PARA; |SI aAlfa ! ""; |HACIENDO;
                           aAlfa2 = aAlfa % 0103;  nCalc  = aAlfa2; nCalc = nCalc - 1;
                           aAlfa2 = aAlfa1 % 0103; nCalc1 = aAlfa2;
                           aAlfa = aAlfa % 0499; aAlfa1 = aAlfa1 % 0499;
                           #defcons1@#nCalc1# = #defconsu@#nCalc#;
                       |SIGUE;
                       |LEE 000#defcons1@.=;
                    |FINSI;
                 |FINSI;

/*
                 ||DEBUG;
                 aAlfa1 = "|K000"; aAlfa1 = #defcons1@#aAlfa1#; aAlfa1 = aAlfa1 % 0499;
                 aAlfa  = "|R" + (("000" + nCont) % -103); aAlfa = #defconsu@#aAlfa#;
                 aAlfa  = aAlfa - "|";
                 |SI FSalida ! 0;
                     nCalc = (((FSalida / 100) ! 0) * 100) + 99;
                     aAlfa = aAlfa % nCalc; aAlfa = aAlfa % 0499;
                     |PARA; |SI aAlfa ! ""; |HACIENDO;
                           aAlfa2 = aAlfa % 0103;  nCalc  = aAlfa2; nCalc = nCalc - 1;
                           aAlfa2 = aAlfa1 % 0103; nCalc1 = aAlfa2;
                           aAlfa = aAlfa % 0499; aAlfa1 = aAlfa1 % 0499;
                           #defcons1@#nCalc1# = #defconsu@#nCalc#;
                     |SIGUE;
                     |LEE 000#defcons1@.=;
                 |FINSI;
*/
           |FINSI;
        |FINSI;

        aDefEje = #2#8; |QBF aDefEje;
        |SI aDefEje = ""; aDefEje = #2#6; |FINSI;

        |DBASS aBase;                          |QBF aBase;
        aPathBin = aBase + #2#4;                  |QBF aPathDef;
        aPathBin = aPathBin + "/bin/" + aDefEje;  |QBF aPathBin;
        aPathBin = aPathBin + ".tab";             |QBF aPathBin;

        |PARA; |SI; |HACIENDO;
           |PULSATECLA;
           |HAZ MenuNuevo;

/*
           |MENU aMenu;
           nOpcion = FSalida;
*/
           |SI nOpcion < 1; |O nOpcion > 4; |VETE Salir; |FINSI;

           |SI nOpcion = 1;
              |PUSHV 0501 2380;
              |XABRE "E", aPathBin, nHandle;
              |SI FSalida ] 0;
                  |SI #1#3 = "        ";
                      aPrograma1 = ":" + #2#4;                  |QBF aPrograma1;
                      aPrograma1 = aPrograma1 + "/" + aDefEje;  |QBF aPrograma1;
                  |SINO;
                      aPrograma1 = ":" + #2#4;                  |QBF aPrograma1;
                      aPrograma1 = aPrograma1 + "/" + aDefEje;  |QBF aPrograma1;
                      aPrograma1 = aPrograma1 + " " + #1#3;     |QBF aPrograma1;
                      aPrograma1 = aPrograma1 + " " + aEmpresa; |QBF aPrograma1;
                  |FINSI;
                  |ESPECIFICA "CONSULTAFICHAERP", aPrograma;
              |SINO;
                  |MENAV "0000 No existe pantalla de estos datos.";
              |FINSI;
              |CLS;
              |POPV;
           |FINSI;
           |SI nOpcion = 2; |O nOpcion = 3;
              aAplica = #2#4;
              |QBF aAplica;


              aQueQuiero = "|DEF";
              aPathDef = #defconsu@#aQueQuiero#;
              |PARA; |SI; |HACIENDO;
                 aAlfa = aPathDef % -101;
                 |SI aAlfa = "/";
                    |SAL;
                 |SINO;
                    aNomDef = aAlfa + aNomDef;
                    aPathDef = aPathDef % -0299;
                 |FINSI;
              |SIGUE;
              |QBF aNomDef;
              aNomDef = (aNomDef + "        ") % 108;

              aQueQuiero = "|FICHERO";
              aPathFic = #defconsu@#aQueQuiero#;
              |QBF aPathFic;
              aPathFic = aPathFic - aNomDef;
              |QBF aPathFic;

              aNumEmp = "";
              aAux = aPathFic % -0299;
              |PARA; |SI; |HACIENDO;
                 aAlfa = aAux % -101;
                 |SI aAlfa = "/";
                    |SAL;
                 |SINO;
                    aNumEmp = aAlfa + aNumEmp;
                    aAux = aAux % -0299;
                 |FINSI;
              |SIGUE;

              nNumEmp = aNumEmp;
              aEmpresa = ("00000" + nNumEmp) % -105;

              enOpcion = nOpcion - 1;
              aAlfa = "|K000"; aAlfa = #defconsu@#aAlfa#;
              aAlfa = aAlfa % 0499;
              aAlfa2 = "";
              |PARA; |SI aAlfa ! ""; |HACIENDO;
                 aAlfa1 = aAlfa % 0103; aAlfa = aAlfa % 0499;
                 nCalc = aAlfa1;
                 aAlfa2 = aAlfa2 + #defconsu@#nCalc#;
              |SIGUE;

              |QBF aAlfa2;
              aAlfa2 = aAlfa2 + (" " * 100);
              aAlfa2 = aAlfa2 % 0199;
              aAlfa2 = aAlfa2 + " ";

              aAlfa2 = "dserpm08.tab;" + aAplica + aEmpresa + aNomDef + aAlfa2 + aPathDef + "@" + aPathFic;

              enSwVengoERP = 1;
              |SUB_EJECUTA_NP aAlfa2;
              enSwVengoERP = 0;
           |FINSI;
           |SI nOpcion = 4; |SAL; |FINSI;
        |SIGUE;
|ET Salir;
        |ESPECIFICA "FIN_POPUPMODE", aVentana;
        |SI #2#8 ! #2#6; |Y #2#8 ! "        ";
           |CIERRA #defcons1@; |DESCARGA_DEF #defcons1@;
        |FINSI;
     |FINSI;
|FPRC;

|PROCESO SacaFiltro;
     |ABRE #2;
     #2#0 = nAplicacion;
     #2#1 = aFiltro - ".flt";
     |LEE 040#2=;
     |SI FSalida ! 0;  |CIERRA #2;  |ACABA;  |FINSI;
     |CIERRA #2;

     |DBASS aBase;   |QBF aBase;

     |SI #2#0 = #2#3;
         aPathDatB = aPathDat;
     |SINO;
         |HAZ DeOtraAplicacion;
         aPathDatB = aPathDatO;
     |FINSI;

     aPathPan = aBase + #2#4;  |QBF aPathPan;
     aPathPan = aPathPan + "/pan/";

     aPathDef = aBase + #2#4;  |QBF aPathDef;
     aPathDef = aPathDef + "/def/" + #2#6;  |QBF aPathDef; aDefConsu = aPathDef;
     |CARGA_DEF aPathDef, defconsu@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el fichero " + aPathDef;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |PATH_PAN #998 aPathPan;
     |PATH_DAT #998 aPathDatB;

     |DBASS aAlfa;   |QBF aAlfa;
     aAlfa = aAlfa + #2#4;  |QBF aAlfa;
     aAlfa = aAlfa + "/fich/";
     aEmpresa  = aPathDatB - aAlfa;
     aEmpresa  = aEmpresa - "/";

     |HAZ GrabaEnFiltro;

     aAlfa = "{F:" + aDirFiltros + "}";
     |ABRE #998;
     nRango         = 2;
     FSalida        = aAlfa;
     nDeci_DDEFECTO = 2;

     aTituloPopup = aPopup; || esta correctamente cargado porque el ultimo menu es el de acceso inicial

     |LINEAL_SIMPLE #1#998, nRango, 0, 0, NULL, NULL, Evento;
     |CIERRA #998;

     |DESCARGA_DEF #defconsu@;
|FPRC;

|PROCESO MenuPopup;
     || aPopup1 = "0";   Posicion del Raton
     || aPopup1 = "-1";  Posicion del Cursor
     || aPopup1 = "-2";  Posicion del ultimo click boton izdo
     || Con el &002 hace un separador.
     || Con el &003 disabla la lineal
     || aPopup4 = &002 o aPopup4 = &003

     aPopup1 = "-2";  || Si fuera -1 en la posicion

     IaPopup  = aPopup3  <-;
     IaOpcion = aOpcion1 <-;
     |BUCLE dserpm05;
     aPopup2 = nContador;

     |SI nContador = 0; |ACABA;  |FINSI;

     IaPopup  = aPopup1  <-;
     IaOpcion = aOpcion1 <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;
     |SI FSalida ! 0;
         IaPopup  = aPopup3  <-;
         IaOpcion = aOpcion1 <-;

         nOpcion  = FSalida - 1;
         IaPopup  = IaPopup  + nOpcion;
         IaOpcion = IaOpcion + nOpcion;
         aFiltro  = aOpcion;  |QBT aFiltro;
         |HAZ SacaFiltro;
     |FINSI;
|FPRC;

|PROCESO EsArchi;
     |DBASS aPath; |QBF aPath;
     aPath = aPath + "dsarchi/def/dsarm001.mas";
     |XABRE "E", aPath, 0;
     |SI FSalida = 0;
          nSwArchi = 1;
     |FINSI;
|FPRC;

|PROGRAMA;
     nSwArchi = 0;
     |HAZ EsArchi;

     enERP = 1;
     aParametro = PARAMETRO;
     aDefParam  = aParametro % -510;

     aBuscador1 = "";
     aBuscador2 = "";
     aBuscador3 = "";
     aBuscador4 = "";

     |ESPECIFICA "X_INFO_ERP", aBuscador;
     nNivel = aBuscador1; nNivel = nNivel - 2;

     |SI aBuscador2 ! aDefParam;  |Y aDefParam ! "";
         aAlfa = aBuscador3 - aBuscador2;
         aBuscador2 = aDefParam;
         aBuscador3 = aAlfa + aDefParam;
     |FINSI;

     |DBASS aBase;  |QBF aBase;

     nSwHay = 0;
     |ABRE #1;
     |BUCLE dserpm04;
     |CIERRA #1;
     |SI nSwHay = 0;
         |MENAV "0000 Programa no configurado en el ERP.";
         |ACABA;
     |FINSI;
     enAplicacion = nAplicacion;

     |CARGA_DEF aDef, definvoc@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

||     aBuscador1 = "0";           || Nivel 0 (el primero);
     aBuscador1 = nNivel;        || Nivel 0 (el primero);
     aBuscador2 = aMas;          || El Def
     aBuscador3 = aDef;          || el def del nivel 0 ...deben ser iguales en estructura
     |ESPECIFICA "X_DATOS_ERP", aBuscador;
     |SI FSalida ! 0;
         |MENAV "0000 Algo ha ido mal ...";
         |ACABA;
     |FINSI;

     aAlfa = aBuscador4; |QBF aAlfa;
     |PARA; |SI; |HACIENDO;
        aAlfa1 = aAlfa % -101;
        |SI aAlfa1 = "/";
           |SAL;
        |SINO;
           aPathDat = aAlfa1 + aPathDat;
           aAlfa = aAlfa % -299;
        |FINSI;
     |SIGUE;
     aPathDat = aAlfa;
     ||aPathDat = aBuscador4 - aBuscador2;

     |HAZ MenuPopup;

     |DESCARGA_DEF #definvoc@;
     enERP = 0;
|FPRO;


|PROCESO MenuNuevo;
     || aPopup1 = "0";   Posicion del Raton
     || aPopup1 = "-1";  Posicion del Cursor
     || aPopup1 = "-2";  Posicion del ultimo click boton izdo
     || ... aPopup1 = "-6";  Esquina ventana 9
     || Con el &002 hace un separador.
     || Con el &003 disabla la lineal
     || aPopup4 = &002 o aPopup4 = &003

     aPopup1 = "-6";  || Si fuera -1 en la posicion
     |SI nSwArchi = 0;
          aPopup2 = 4;
          aPopup3 = " Consulta      ";
          aPopup4 = " Observaciones ";
          aPopup5 = " Documentos    ";
          aPopup6 = " Salir         ";
     |SINO;
          aPopup2 = 5;
          aPopup3 = " Consulta          ";
          aPopup4 = " Observaciones     ";
          aPopup5 = " Documentos        ";
          aPopup6 = " Archivo Documental";
          aPopup7 = " Salir             ";
     |FINSI;

     IaPopup  = aPopup1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;
     nOpcion  = FSalida;
|FPRC;
