|FICHEROS;
     dsarm001;
     dsarm002;
     dsarm003;
     dsarm004;
     dsarm005;

     dpntm000;
     dpntm001;
     dpntm002;
     dpntm003;
     dpntm004;

     dsarw010;
     dsarw053;
     dpntw008;
     dpntw009;
     dsarw120;

     dsarm005@;
|FIN;

|VARIABLES;
     aGrupoAux = "";
     aSubAux = "";
     aTipoAux = "";

     nSwSMTPServPropio = 0;
     aVarSMTP          = "";
     aVarUsuario       = "";
     aVarPassword      = "";
     aAlfa2            = "";
     aPathTmp          = "";
     aMensaje          = "";
     aFicTmp           = "";
     aDef              = "";

     nVentz1         = 0;
     nNotificacion   = 0;
     nDESPANET       = 0;
     nHandle         = 0;
     nHandle1        = 0;
     nHandle2        = 0;
     nRegilla        = 0;
     nLLave          = 0;
     nLong           = 0;
     nPosi           = 0;
     nPos            = 0;
     nDsCorreo       = 0;
     nContaPush      = 0;
     nSesion         = 0;
     nConta          = 0;

     aTipo           = "";
     aAlfa           = "";
     aUsuario        = "";
     aBasePla        = "";
     aDocRemoto      = "";
     aDocServidor    = "";
     aIPRemoto       = "";
     aAbreTxt        = "";
     aAbre           = "";
     aFotoOrigen     = "";
     aFotoDestino    = "";
     aNLogo          = "";
     aDirLocal       = "";
     aBase           = "";
     aExt            = "";
     aFicheroAdjunto = "";
     aBaseMensaje    = "";
     aEmpresa        = "";
     aLong           = "";
     aFrase          = "";
     aDirec          = "";
     aCarac          = "";
     aConten         = "";
     aCarac10        = "";
     aAlfa1          = "";
     aTo             = "";
     aPara           = "";
     aAsunto         = "";
     aNombre         = "";
     aEjecuta        = "";
     aAbreHTMO       = "";
     aAbreHTMD       = "";
     aAbreTXT        = "";
     aAbreTXTO       = "";
     aAbreTXTD       = "";
     aAbreFIN        = "";
     aIP             = "";
     aSalida         = "";
     aFrom           = "";
     aAutenti        = "";
     aAdjunto        = "";
     aFic            = "";

     {1}aContiene    = "";

     {-1}aVent       = "";
         aVent1      = 0;
         aVent2      = 0;
         aVent3      = 0;
         aVent4      = 0;
         aVent5      = "";

     &eaAlfa         = "";
     &eaOrigen       = "";
     &eaDestino      = "";
     &eaFicheroTra   = "";
     &eaFicheroPlaGz = "";
     &eaFicheroPlaMl = "";
     &eaDirPlantilla = "";
     &eaDirSerPlaMl  = "";
     &eaDirSerPlan   = "";
     &eaDirTrabajo   = "";
     &eaDirTrabServi = "";
     &eaRutaOrigen   = "";
     &eaRutaDestino  = "";
     &eaFicheroTxt   = "";
     &eaFicheroTgz   = "";
     &eaFicheroTar   = "";
     &enHandleTxt    = 0;
     &eaAsigna       = "";
     &eaUnidadBasico = "";
     &eaPrograma     = "";
     &enAprobacion   = 0;
     &enSwNomina     = 0;
     &eaParamT       = "";
     &eaParamU       = "";
     &eaParamA       = "";
     &eaParamD       = "";
     &eaParamM       = "";
     &enErrorPy      = 0;
     &eaMensaPy      = "";
     &enSwDesde9     = 0;
     &enCalcDESPANET = 0;
|FIN;

|| -----------------------------------------------------------------------

|PROCESO dsarm005NotiTodo;
     |SI #dsarm005#94 ! "S";
         |SI #dsarm005#94 ! aTipo;  |ACABA;  |FINSI;
     |FINSI;

     aAlfa = "N";

     #dpntm001#0 = #dsarm005#8;
     |LEE 000#dpntm001.=;
     |SI FSalida = 0;
         #dsarm004#0 = #dsarm005#1;
         #dsarm004#1 = #dsarm005#2;
         #dsarm004#2 = #dsarm005#3;
         |LEE 000#dsarm004.=;
         |SI FSalida = 0;  |Y #dsarm004#76 = "S";
             #dpntm002#0 = #dpntm001#0;
             #dpntm002#1 = #dsarm004#0;
             #dpntm002#2 = #dsarm004#1;
             #dpntm002#3 = #dsarm004#2;
             |LEE 000#dpntm002.=;
             |SI FSalida ! 0;
                 aAlfa = "S";
             |FINSI;
         |FINSI;
     |FINSI;

     |SI aAlfa = #dsarm005#94;
         |ACABA;
     |FINSI;

     |SI aAlfa = "S";
         #dpntm001#0 = #dsarm005#8;
         |LEE 101#dpntm001.=;
         |SI FSalida = 0;
             #dpntm001#11 = "S";
             |GRABA 020#dpntm001.a;
             |LIBERA #dpntm001;
         |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm005NotiTodo;
     #dsarm005#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsarm005NotiTodo;
|FIN;

|| -----------------------------------------------------------------------

|PROCESO dsarm005Noti;
     aAlfa = "N";

     #dsarm004#0 = #dsarm005#1;
     #dsarm004#1 = #dsarm005#2;
     #dsarm004#2 = #dsarm005#3;
     |LEE 000#dsarm004.=;
     |SI FSalida = 0;  |Y #dsarm004#76 = "S";
         #dpntm002#0 = #dpntm001#0;
         #dpntm002#1 = #dsarm004#0;
         #dpntm002#2 = #dsarm004#1;
         #dpntm002#3 = #dsarm004#2;
         |LEE 000#dpntm002.=;
         |SI FSalida ! 0;
             aAlfa = "S";
         |FINSI;
     |FINSI;

     |SI aAlfa = #dsarm005#94;
         |ACABA;
     |FINSI;

     |SI aAlfa = "S";
         nNotificacion = 1;
         |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm005Noti;
     #dsarm005#7;
     ;
     aTipo, #dpntm001#0, "01.01.0000", 000000001;
     aTipo, #dpntm001#0, "31.12.9999", 999999999;
     be;
     NULL, dsarm005Noti;
|FIN;

|PROCESO dpntm001Noti;
     nNotificacion = 0;
     #dpntm001#11  = "N";
     |BUCLE dsarm005Noti;
     |SI nNotificacion = 1;
         #dpntm001#11 = "S";
     |FINSI;
     |GRABA 020#dpntm001.a;
     |LIBERA #dpntm001;
|FPRC;

|DEFBUCLE dpntm001Noti;
     #dpntm001#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, dpntm001Noti;
|FINSI;

|| -----------------------------------------------------------------------

|PROCESO CreaCabecera;
     eaAlfa = "#1 -F Arial -S 8 -A 100 -B 0 ";  |XGRABA nHandle, eaAlfa;
     eaAlfa = "#2 -F Arial -S 8 -A 100 -B 0 ";  |XGRABA nHandle, eaAlfa;
     eaAlfa = "#3 -F Arial -S 8 -A 100 -B 0 ";  |XGRABA nHandle, eaAlfa;
     eaAlfa = "#4 -F Arial -S 8 -A 100 -B 0 ";  |XGRABA nHandle, eaAlfa;
     eaAlfa = "#5 -F Arial -S 8 -A 100 -B 0";   |XGRABA nHandle, eaAlfa;
     eaAlfa = &13 + & 10;                       |XGRABA nHandle, eaAlfa;

     eaAlfa = "#1 -F Arial -S 8 -B 0 ";         |XGRABA nHandle, eaAlfa;
     eaAlfa = "#2 -F Arial -S 8 -B 0 ";         |XGRABA nHandle, eaAlfa;
     eaAlfa = "#3 -F Arial -S 8 -B 0 ";         |XGRABA nHandle, eaAlfa;
     eaAlfa = "#4 -F Arial -S 8 -B 0 ";         |XGRABA nHandle, eaAlfa;
     eaAlfa = "#5 -F Arial -S 8 -B 0";          |XGRABA nHandle, eaAlfa;
     eaAlfa = &13 + & 10;                       |XGRABA nHandle, eaAlfa;

     eaAlfa = "DOCUMENTO" + &009;               |XGRABA nHandle, eaAlfa;
     eaAlfa = "GRUPO" + &009;                   |XGRABA nHandle, eaAlfa;
     eaAlfa = "SUBGRUPO" + &009;                |XGRABA nHandle, eaAlfa;
     eaAlfa = "TIPO" + &009;                    |XGRABA nHandle, eaAlfa;
     eaAlfa = "NOMBRE DOCUMENTO";               |XGRABA nHandle, eaAlfa;
     eaAlfa = &13 + & 10;                       |XGRABA nHandle, eaAlfa;
|FPRC;

|PROCESO dsarm005Adj;
     aAlfa = "N";

     #dsarm004#0 = #dsarm005#1;
     #dsarm004#1 = #dsarm005#2;
     #dsarm004#2 = #dsarm005#3;
     |LEE 000#dsarm004.=;
     |SI FSalida = 0;
         |SI #dsarm004#76 = "S";
             #dpntm002#0 = #dpntm001#0;
             #dpntm002#1 = #dsarm004#0;
             #dpntm002#2 = #dsarm004#1;
             #dpntm002#3 = #dsarm004#2;
             |LEE 000#dpntm002.=;
             |SI FSalida ! 0;
                 aAlfa = "S";
             |FINSI;
         |SINO;
             aAlfa = "S";
         |FINSI;
     |FINSI;

     |SI aAlfa = #dsarm005#94;
         |ACABA;
     |FINSI;

     |SI aAlfa = "S";
         #dsarm002#0   = #dsarm005#1;
         |LEE 000#dsarm002.=;

         #dsarm003#0   = #dsarm005#1;
         #dsarm003#1   = #dsarm005#2;
         |LEE 000#dsarm003.=;

         eaAlfa = ("000000000" + #dsarm005#0) % -109;
         eaAlfa = eaAlfa + &009;          |XGRABA nHandle, eaAlfa;

         aGrupoAux = "";
         aSubAux = "";
         aTipoAux = "";

         |SI nDESPANET = 0;
              |DDEFECTO #dpntm003;
              #dpntm003#0 = #dsarm005#8;
              #dpntm003#1 = #dsarm005#1;
              #dpntm003#2 = #dsarm005#2;
              #dpntm003#3 = #dsarm005#3;
              |LEE 000#dpntm003.=;
              |SI FSalida = 0;
                    aGrupoAux = #dpntm003#7;
                    |QBF aGrupoAux;
                    aSubAux = #dpntm003#8;
                    |QBF aSubAux;
                    aTipoAux = #dpntm003#9;
                    |QBF aTipoAux;
              |FINSI;
         |FINSI;

         |SI aGrupoAux = "";
              aGrupoAux = #dsarm002#5;
              |QBF aGrupoAux;
              |SI aGrupoAux = "";
                   aGrupoAux = #dsarm002#1;
              |FINSI;
         |FINSI;

         |SI aSubAux = "";
              aSubAux = #dsarm003#6;
              |QBF aSubAux;
              |SI aSubAux = "";
                   aSubAux = #dsarm003#2;
              |FINSI;
         |FINSI;

         |SI aTipoAux = "";
              aTipoAux = #dsarm004#93;
              |QBF aTipoAux;
              |SI aTipoAux = "";
                   aTipoAux = #dsarm004#3;
              |FINSI;
         |FINSI;

         eaAlfa = (("000" + #dsarm002#0) % -103) + " - " + aGrupoAux;    |QBF eaAlfa;  |HAZ QuitaRarosCorreo;
         eaAlfa = eaAlfa + &009;          |XGRABA nHandle, eaAlfa;

         eaAlfa = (("000" + #dsarm003#1) % -103) + " - " + aSubAux;    |QBF eaAlfa;  |HAZ QuitaRarosCorreo;
         eaAlfa = eaAlfa + &009;          |XGRABA nHandle, eaAlfa;

         eaAlfa = (("000" + #dsarm004#2) % -103) + " - " + aTipoAux;    |QBF eaAlfa;  |HAZ QuitaRarosCorreo;
         eaAlfa = eaAlfa + &009;          |XGRABA nHandle, eaAlfa;

         eaAlfa = #dsarm005#9;                   |XGRABA nHandle, eaAlfa;

         eaAlfa = &13 + & 10;             |XGRABA nHandle, eaAlfa;
     |FINSI;

     #dsarm005@#0 = #dsarm005#0;
     |LEE 101#dsarm005@.=;
     |SI FSalida = 0;
         #dsarm005@#94 = aAlfa;
         |GRABA 020#dsarm005@.a;
         |LIBERA #dsarm005@;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm005Adj;
     #dsarm005#7;
     ;
     aTipo, #dpntm001#0, "01.01.0000", 000000001;
     aTipo, #dpntm001#0, "31.12.9999", 999999999;
     ;
     NULL, dsarm005Adj;
|FIN;

|PROCESO GrabaCuerpo;
     |HAZ QuitaRarosCorreo;

     |SI nDsCorreo = 0;
         |SI eaAlfa = "";
             eaAlfa = "<br>";
         |SINO;
             eaAlfa = eaAlfa + "<br>" + &13 + &10;
         |FINSI;
     |SINO;
         eaAlfa = eaAlfa + &13 + &10;
     |FINSI;

     |XGRABA nHandle, eaAlfa;
|FPRC;

|PROCESO TrataAdjunto;
     aFicheroAdjunto = "";

     eaDestino  = eaDirTrabajo + "adjunto.pdf";
     eaOrigen   = aBaseMensaje + "adjunto.pdf";
     |HAZ RecibeFichero;

     aFicheroAdjunto = eaOrigen;

     aAlfa = eaDirTrabajo + "adjunto.pdf";
     |RFBORRA aAlfa;
|FPRC;

|PROCESO PonDirecciones;
     aLong  = aTo % 0;
     nLong  = aLong;
     aFrase = "";
     aDirec = "";
     |PARA nPosi = 1;  |SI nPosi [ nLong;  |HACIENDO nPosi = nPosi + 1;
           nPos   = (nPosi * 100) + 1;
           aCarac = aTo % nPos;

           |SI aCarac = ";";  |O aCarac = ",";
               aFrase = aFrase + "--to=" + &34 + aDirec + &34 + " ";
               aDirec = "";
           |SINO;
               aDirec = aDirec + aCarac;
           |FINSI;
     |SIGUE;

     |SI aDirec ! "";
         aFrase = aFrase + "--to=" + &34 + aDirec + &34;
     |FINSI;

     aConten = aFrase + " \" + &10;
|FPRC;

|PROCESO EjecutaShellCorreo;
     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     |HAZ ParametrosSMTPCLI;

     enAprobacion = 0;
     eaPrograma = "SMTPSERVPROPIO";
     |HAZ DSARCHI_INI;
     nSwSMTPServPropio = enAprobacion;

     aEmpresa = #dpntm001#1;

     aAbreHTMO = aBaseMensaje + "despabox.htm";
     aAbreHTMD = aBaseMensaje + aEmpresa + ".htm";  |QBT aAbreHTMD;
     |FBORRA aAbreHTMD;

     |XABRE "WB", aAbreHTMD, nHandle1;
     |XABRE "AB", aAbreHTMO, nHandle2;

     nRegilla = 0;
     nLLave   = 0;
     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            |SI aAlfa = "#";
                nRegilla = nRegilla + 1;
            |FINSI;

            |SI nRegilla = 2;  |SAL;  |FINSI;

            |SI nLLave = 0;  |Y aAlfa ! "{";  |Y nRegilla = 0;
                |XGRABA nHandle1, aAlfa;
            |FINSI;

            |SI aAlfa = "}";
                aConten  = aConten + aAlfa;

                |SI aConten = "{LOGO}";
                    ||Por el tema del "cid:" Para la imagen embebida
                    ||aAlfa = &34 + aNLogo + &34;
                    aAlfa = aNLogo;
                |FINSI;

                |XGRABA nHandle1, aAlfa;

                nLLave   = 0;
                aConten  = "";
            |SINO;
                |SI aAlfa = "{";  |O nLLave = 1;
                    aConten  = aConten + aAlfa;
                    nLLave = 1;
                |FINSI;
            |FINSI;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;
     |XCIERRA nHandle1;

     |AFEGIR_FICHERO aAbreTXT, aAbreHTMD;

     |XABRE "AB", aAbreHTMD, nHandle1;

     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            |XGRABA nHandle1, aAlfa;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;
     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     aAbreTXTO = aBaseMensaje + "dscorreo.sh";
     aAbreTXTD = aBaseMensaje + aEmpresa + ".sh";  |QBT aAbreTXTD;
     aAbreFIN  = aBaseMensaje + aEmpresa + ".txt"; |QBT aAbreFIN;
     |FBORRA aAbreTXTD;
     |FBORRA aAbreFIN;

     |XABRE "WB", aAbreTXTD, nHandle1;
     |XABRE "AB", aAbreTXTO, nHandle2;

     aCarac10 = &10;
     aConten = "";
     aVarSMTP = #dsarw010#19;     |QBF aVarSMTP;
     aVarUsuario = #dsarw010#21;  |QBF aVarUsuario;
     aVarPassword = #dsarw010#22; |QBF aVarPassword;

     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            aConten = aConten + aAlfa;

            |SI aAlfa = aCarac10;
                aAlfa1 = aConten - "/usr/bin/smtp-cli";
                |SI FSalida ! 0;
                     ||SMTPSERVPROPIO
                     |SI nSwSMTPServPropio = 1;
                         |SI aVarSMTP ! ""; |Y aVarUsuario ! ""; |Y aVarPassword ! "";
                              aAlfa2 = aAlfa1 - "--host=asmtp.diagram.es --user=control.smtp@diagram.es --pass=elpollogalactico \";
                              |SI FSalida ! 0;
                                   aAlfa1 = " --host=" + aVarSMTP + " --user=" + aVarUsuario + " --pass=" + aVarPassword + " \" + &10;
                              |FINSI;
                         |FINSI;
                     |FINSI;

                     aConten = aBaseMensaje + "smtp-cli" + aAlfa1;
                |FINSI;

                aAlfa1 = aConten - "DE=$1";
                |SI FSalida ! 0;
                    aConten = "DE=" + &34 + aPara + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "$PARA";
                |SI FSalida ! 0;
                    |HAZ PonDirecciones;
                |FINSI;

                aAlfa1 = aConten - "ASUNTO=$3";
                |SI FSalida ! 0;
                    aConten = "ASUNTO=" + &34 + aAsunto + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICHTM=$4";
                |SI FSalida ! 0;
                    aConten = "FICHTM=" + &34 + aAbreHTMD + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICAT1=$5";
                |SI FSalida ! 0;
                    aConten = "FICAT1=" + &34 + aFotoOrigen + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICFIN=$6";
                |SI FSalida ! 0;
                    aConten = "FICFIN=" + &34 + aAbreFIN + &34 + &10;  |QBT aConten;
                |FINSI;

                aAlfa1 = aConten - "$ADJUNTO";
                |SI FSalida ! 0;
                    aConten = "";
                    |SI aFicheroAdjunto ! "";
                        aConten = "--attach " + aFicheroAdjunto + " \" + &10;
                    |FINSI;
                |FINSI;

                |XGRABA nHandle1, aConten;

                aConten = "";
            |FINSI;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;

     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     aEjecuta = "/bin/sh " + aAbreTXTD;

     |SYSTEM aEjecuta;

     nConta = 0;
     |PARA;  |SI;  |HACIENDO;
          |XABRE "E", aAbreFIN, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;
          |SI nConta > 30;  |SAL;  |FINSI;

          |SLEEP 1;
          |PULSATECLA;

          nConta = nConta + 1;
     |SIGUE;

     |XABRE "E", aAbreFIN, nHandle;
     |SI FSalida < 0;
         |MENAV "0000Hay problemas al enviar el correo, p¢ngase en contacto con su distribuidor";
     |FINSI;

     |FBORRA aAbreTXT;
     |FBORRA aAbreTXTD;
     |FBORRA aAbreHTMD;
     |FBORRA aAbreFIN;
|FPRC;

|PROCESO DsCorreo;
     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     aIP      = #dsarw010#18;  |QBF aIP;
     aSalida  = #dsarw010#19;  |QBF aSalida;

     aFrom    = aPara;   |QBF aFrom;
     eaAlfa   = #dsarw010#3;   |HAZ QuitaRarosCorreo;
     aMensaje = "$$$$" + aAbreTXT;

     |SI #dsarw010#20 = "N";
          aAutenti = aFrom;
     |SINO;
          aAutenti = #dsarw010#22;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + #dsarw010#21;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + aFrom;
     |FINSI;

     |SI #dsarw010#23 = "S";
          aAutenti = "!" + aAutenti;
     |FINSI;

     |DSCORREO_ENVIA aIP, aSalida, aAutenti, aTo, aAsunto, aMensaje, aFicheroAdjunto;
     |SI FSalida < 0;
         |MENAV "0000 Ha habido un error durante el envio.";
     |FINSI;
|FPRC;

|PROCESO CorreoNotifi01;
     eaPrograma   = "DSCORREO";
     |HAZ DSARCHI_INI;
     nDsCorreo = enAprobacion;

     aBaseMensaje = aBasePla + "dscorreo/";

     aAbreTXT  = aBaseMensaje + "adjunto.txt";
     |XABRE "WB", aAbreTXT, nHandle;

     eaAlfa = aNombre + ", comunicaci¢n de documentos nuevos DESPABOX";
     |HAZ QuitaRarosCorreo;
     aAsunto  = eaAlfa;        |QBF aAsunto;

     eaAlfa = aNombre + ", le comunica:";
     |HAZ GrabaCuerpo;

     eaAlfa = "";  |HAZ GrabaCuerpo;

     eaAlfa = "Se han creado nuevos documentos en la aplicaci¢n DESPABOX,";
     |HAZ GrabaCuerpo;

     eaAlfa = " que se relacionan en el documento adjunto de ‚ste correo,"
     |HAZ GrabaCuerpo;

     eaAlfa = " y que podr  consultar en www.despabox.es";
     |HAZ GrabaCuerpo;

     eaAlfa = "";  |HAZ GrabaCuerpo;

     eaAlfa = "Para cualquier aclaraci¢n o duda, por favor, contacte con nosotros.";
     |HAZ GrabaCuerpo;

     |XCIERRA nHandle;

     aAlfa = aBaseMensaje + "adjunto.pdf";
     |HAZ TrataAdjunto;

     |SI nDsCorreo = 0;
         |HAZ EjecutaShellCorreo;
     |SINO;
         |HAZ DsCorreo;
     |FINSI;

     |SI aFicheroAdjunto ! "";
         |FBORRA aFicheroAdjunto;
     |FINSI;

     |FBORRA aAbreTXT;
|FPRC;

|PROCESO dsarw120Adj;
     #dsarm005#0 = #dsarw120#1;
     |LEE 000#dsarm005.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |HAZ dsarm005Adj;
|FPRC;

|DEFBUCLE dsarw120Adj;
     #dsarw120#1;
     ;
     #dpntm001#0, 000000001;
     #dpntm001#0, 999999999;
     ;
     NULL, dsarw120Adj;
|FIN;

|PROCESO dpntm001Word;
     |SI nDESPANET = 0;
         aNombre  = #dpntm000#1;
         aTo      = #dpntm001#9;
         aPara    = #dpntm000#2;
     |SINO;
         aNombre  = #dpntm001#2;
         aTo      = #dpntm000#2;
         aPara    = #dpntm001#9;
     |FINSI;
     |QBF aNombre;
     |QBF aTo;

     |SI aTo   = "";   |ACABA;  |FINSI;
     |SI aPara = "";   |ACABA;  |FINSI;

     |DBASE aBasePla;  |QBF aBasePla;

     aAlfa          = eaUnidadBasico + "\DOCUMENTOS";                 |RMKDIR aAlfa;
     aAlfa          = eaUnidadBasico + "\DOCUMENTOS\DSARCHI";         |RMKDIR aAlfa;
     aAlfa          = eaUnidadBasico + "\DOCUMENTOS\DSARCHI\CORREO";  |RMKDIR aAlfa;

     eaDirSerPlan   = aBasePla + "dscorreo/";
     eaDirPlantilla = eaUnidadBasico + "\DOCUMENTOS\DSARCHI\CORREO\";
     eaDirTrabajo   = eaUnidadBasico + "\DOCUMENTOS\DSARCHI\CORREO\";
     eaDirTrabServi = aBasePla  + "tmp";                     |MKDIR eaDirTrabServi;
     eaDirTrabServi = aBasePla  + "tmp/" + Usuario;         |MKDIR eaDirTrabServi;
     eaDirTrabServi = aBasePla  + "tmp/" + Usuario + "/";
     eaFicheroTxt   = "notifi01.txt";
     eaFicheroTra   = "notifi01.doc";

     eaOrigen       = eaDirSerPlan + "notifi01.xgz";
     eaDestino      = eaDirTrabajo + "notifi01.xgz";

     aContiene1     = eaDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = eaOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

         |SI aIPRemoto ! "";
             |ENVIA_FICHERO eaOrigen, eaDestino;
         |SINO;
             |COPIA_FICHERO eaOrigen, eaDestino;
         |FINSI;
     |FINSI;

     eaOrigen     = eaDirTrabajo + "notifi01.xgz";
     eaDestino    = eaDirTrabajo + "notifi01.tgz";
     |RCOPIA_FICHERO eaOrigen, eaDestino;

     eaFicheroTgz   = "notifi01.tgz";
     eaFicheroTar   = "notifi01.tar";
     eaFicheroPlaMl = "notifi01.doc";
     eaFicheroPlaGz = "";
     |HAZ DescomprimeFichero;

     aAlfa = eaDirTrabajo + "notifi01.doc";
     |XABRE "EC", aAlfa, nHandle;
     |SI FSalida < 0;
         |ACABA;
     |FINSI;

     |DDEF aDef;
     aDef = aDef + "dsarm005.mas";
     |CARGA_DEF aDef, dsarm005@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aAbreTxt = eaDirTrabajo + "tablanotifi01.txt";
     |XABRE "EC", aAbreTxt, nHandle;
     |SI FSalida ] 0;
         |RFBORRA aAbreTxt;
     |FINSI;

     aAbreTxt = eaDirTrabServi + "tablanotifi01.txt";
     |XABRE "WB", aAbreTxt, nHandle;

     |HAZ CreaCabecera;

     |ABRE #dpntm003;
     |ABRE #dsarm005@;
     |SI nSesion = 0;
         |BUCLE dsarm005Adj;
     |SINO;
         |BUCLE dsarw120Adj;
     |FINSI;
     |CIERRA #dpntm003;

     |CIERRA #dsarm005@;
     |DESCARGA_DEF #dsarm005@;

     |XCIERRA nHandle;

     eaOrigen  = eaDirTrabServi + "tablanotifi01.txt";
     eaDestino = eaDirTrabajo   + "tablanotifi01.txt";
     |HAZ EnviaFicheroSinMD5;

     |FBORRA eaOrigen;

     aAbre = eaDirTrabServi + eaFicheroTxt;
     |XABRE "WB", aAbre, enHandleTxt;

     aAlfa = "[FICHERO]#" + eaDirTrabajo + eaFicheroTra + "#" + eaDirTrabajo + "adjunto.doc" + &13 + &10;
     |XGRABA enHandleTxt, aAlfa;

     aAlfa = "[LIMPIA FINAL]" + &13 + &10;
     |XGRABA enHandleTxt, aAlfa;

     aAlfa = "I" + &13 + &10;
     |XGRABA enHandleTxt, aAlfa;

     aAlfa = "<<LOGO>>" + &13 + &10;
     |XGRABA enHandleTxt, aAlfa;

     aAlfa = aFotoDestino + &13 + &10;
     |XGRABA enHandleTxt, aAlfa;

     eaAlfa   = aNombre;   |HAZ QuitaRarosCorreo;
     eaAsigna = "V#NOMBRE#";  |HAZ AsignaWord;

     eaAlfa = "D" + &13 + &10;
     |XGRABA enHandleTxt, eaAlfa;

     eaAlfa = "<<TABLA>>" + &13 + &10;
     |XGRABA enHandleTxt, eaAlfa;

     eaAlfa = eaDestino + &13 + &10;
     |XGRABA enHandleTxt, eaAlfa;

     eaAlfa = "[IMPRESORA]#I#2#DsPdf#2" + &13 + &10;
     |XGRABA enHandleTxt, eaAlfa;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;

     |XCIERRA enHandleTxt;

     eaOrigen  = eaDirTrabServi + eaFicheroTxt;
     eaDestino = eaDirTrabajo   + eaFicheroTxt;
     |HAZ EnviaFicheroSinMD5;

     |FBORRA eaOrigen;

     eaDirSerPlan   = aBasePla + "dlls/";
     |HAZ AbreWordExterno;

     eaDestino = eaDirTrabajo + eaFicheroTra;
     |RFBORRA eaDestino;

     eaDestino = eaDirTrabajo + "adjunto.doc";
     |RFBORRA eaDestino;

     eaDestino = eaDirTrabajo + "tablanotifi01.txt";
     |RFBORRA eaDestino;

     aAlfa = eaDirTrabServi + "adjunto.pdf";
     |FBORRA aAlfa;

     |HAZ CorreoNotifi01;
|FPRC;

|DEFBUCLE dpntm001Word;
     #dpntm001#2;
     ;
     "S", 00001;
     "S", 99999;
     ;
     NULL, dpntm001Word;
|FINSI;

|| -----------------------------------------------------------------------

|PROCESO dsarm005Push;
     aAlfa = "N";

     #dsarm004#0 = #dsarm005#1;
     #dsarm004#1 = #dsarm005#2;
     #dsarm004#2 = #dsarm005#3;
     |LEE 000#dsarm004.=;
     |SI FSalida = 0;  |Y #dsarm004#76 = "S";
         #dpntm002#0 = #dpntm001#0;
         #dpntm002#1 = #dsarm004#0;
         #dpntm002#2 = #dsarm004#1;
         #dpntm002#3 = #dsarm004#2;
         |LEE 000#dpntm002.=;
         |SI FSalida ! 0;
             aAlfa = "S";
         |FINSI;
     |FINSI;

     |SI aAlfa = #dsarm005#94;
         |ACABA;
     |FINSI;

     |SI aAlfa ! "S";
         |ACABA;
     |FINSI;

     #dpntw008#0 = #dpntm001#1;   || Usuario
     |LEE 101#dpntw008.=;
     |SI FSalida ! 0;
         |DDEFECTO #dpntw008;
         #dpntw008#0 = #dpntm001#1;   || Usuario
         #dpntw008#1 = #dpntm000#1;                || Nombre despacho
         #dpntw008#2 = "documentos";               || Tipo notificacion
         aAlfa       = #dpntw008#0;  |QBF aAlfa;
         #dpntw008#3 = aPathTmp + aAlfa + ".txt";  || Lista de documentos
         |GRABA 020#dpntw008.n;
     |FINSI;
     |LIBERA #dpntw008;

     #dpntw009#0 = #dpntm001#1;   || Usuario
     #dpntw009#1 = #dsarm005#0;   || Numero de documento
     |GRABA 020#dpntw009.n;
     |LIBERA #dpntw009;

     #dpntm003#0 = #dsarm005#8;
     #dpntm003#1 = #dsarm005#1;
     #dpntm003#2 = #dsarm005#2;
     #dpntm003#3 = #dsarm005#3;
     |LEE 000#dpntm003.=;
     |SI FSalida = 0;
         |SI #dpntm003#12 ! "S";  |ACABA;  |FINSI;
     |SINO;
         |SI #dsarm004#96 ! "S";  |ACABA;  |FINSI;
     |FINSI;

     #dpntm004#0 = #dsarm005#8;
     #dpntm004#1 = #dsarm005#95;
     |LEE 000#dpntm004.=;
     |SI FSalida ! 0;                  |ACABA;  |FINSI;

     |SI #dpntm004#6 ! "S";  |Y #dpntm004#7 [ "01.01.0000";
          |ACABA;
     |FINSI;

     #dpntw008#0 = #dpntm004#8;   || Usuario
     |LEE 101#dpntw008.=;
     |SI FSalida ! 0;
         |DDEFECTO #dpntw008;
         #dpntw008#0 = #dpntm004#8;   || Usuario
         #dpntw008#1 = #dpntm004#3;                || Nombre trabajador
         #dpntw008#2 = "documentos";               || Tipo notificacion
         aAlfa       = #dpntw008#0;  |QBF aAlfa;
         #dpntw008#3 = aPathTmp + aAlfa + ".txt";  || Lista de documentos
         |GRABA 020#dpntw008.n;
     |FINSI;
     |LIBERA #dpntw008;

     #dpntw009#0 = #dpntm004#8;   || Usuario
     #dpntw009#1 = #dsarm005#0;   || Numero de documento
     |GRABA 020#dpntw009.n;
     |LIBERA #dpntw009;
|FPRC;

|DEFBUCLE dsarm005Push;
     #dsarm005#7;
     ;
     aTipo, #dpntm001#0, "01.01.0000", 000000001;
     aTipo, #dpntm001#0, "31.12.9999", 999999999;
     ;
     NULL, dsarm005Push;
|FIN;

|PROCESO dpntm001Push;
     eaParamT = "documentos";
     eaParamM = "";

     |BUCLE dsarm005Push;
|FPRC;

|DEFBUCLE dpntm001Push;
     #dpntm001#2;
     ;
     "S", 00001;
     "S", 99999;
     ;
     NULL, dpntm001Push;
|FINSI;

|PROCESO dpntw009;
     aAlfa = #dpntw009#1 + " ";
     |XGRABA nHandle, aAlfa;
|FPRC;

|DEFBUCLE dpntw009;
     #dpntw009#1;
     ;
     #dpntw008#0, 000000001;
     #dpntw008#0, 999999999;
     ;
     NULL, dpntw009;
|FIN;

|PROCESO dpntw008;
     eaParamD = #dpntw008#3;  |QBF eaParamD;

     |XABRE "WB", eaParamD, nHandle;
     |BUCLE dpntw009;
     |XCIERRA nHandle;

     eaParamU = #dpntw008#0;   |QBF eaParamU;
     eaParamA = #dpntw008#1;   |QBF eaParamA;
     eaParamT = #dpntw008#2;   |QBF eaParamT;
     eaParamM = "";

     |HAZ LanzaPush;

     |LEE 000#dpntm000.p;
     |SI FSalida = 0;
         #dpntm000#6 = eaMensaPy;

         |GRABA 020#dpntm000.a;
         |LIBERA #dpntm000;
     |FINSI;
|FPRC;

|DEFBUCLE dpntw008;
     #dpntw008#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dpntw008
|FIN;

|PROCESO Push;
     |HAZ VersionPython;
     |SI enErrorPy ! 0;  |ACABA;  |FINSI;

     |DBASE aBase;
     aPathTmp = aBase + "tmp";               |MKDIR aPathTmp;
     aPathTmp = aPathTmp + "/" + Usuario;    |MKDIR aPathTmp;
     aPathTmp = aPathTmp + "/";

     aFicTmp = "dpntw008" + Usuario;  |NOME_DAT #dpntw008#aFicTmp#;
     aFicTmp = "dpntw009" + Usuario;  |NOME_DAT #dpntw009#aFicTmp#;

     |ABRE #dpntw008;  |CIERRA #dpntw008;  |DELINDEX #dpntw008;
     |ABRE #dpntw009;  |CIERRA #dpntw009;  |DELINDEX #dpntw009;

     |ABRE #dpntm000;
     |ABRE #dpntm002;
     |ABRE #dpntm003;
     |ABRE #dpntm004;
     |ABRE #dsarm002;
     |ABRE #dsarm003;
     |ABRE #dsarm004;
     |ABRE #dpntw008;
     |ABRE #dpntw009;
     |BUCLE dpntm001Push;
     |CIERRA #dpntm000;
     |CIERRA #dpntm002;
     |CIERRA #dpntm003;
     |CIERRA #dpntm004;
     |CIERRA #dsarm002;
     |CIERRA #dsarm003;
     |CIERRA #dsarm004;
     |CIERRA #dpntw008;
     |CIERRA #dpntw009;

     |BUCLE dpntw008;

     |DELINDEX #dpntw008;
     |DELINDEX #dpntw009;
|FPRC;

|PROCESO TraeLogo;
     |DBASE aBase;  |QBF aBase;

     aFotoOrigen = aBase + "logos/logodespanet.jpg";
     aExt        = ".jpg";
     aNLogo      = "logodespanet.jpg";
     |XABRE "E", aFotoOrigen, nHandle;
     |SI FSalida < 0;
         aFotoOrigen = aBase + "logos/logodespanet.bmp";
         aExt        = ".bmp";
         aNLogo      = "logodespanet.bmp";
         |XABRE "E", aFotoOrigen, nHandle;
         |SI FSalida < 0;
             aFotoOrigen = aBase + "logos/insertarlogo.jpg";
             aExt        = ".jpg";
             aNLogo      = "insertarlogo.jpg";
             |XABRE "E", aFotoOrigen, nHandle;
             |SI FSalida < 0;
                 |ACABA;
             |FINSI;
         |FINSI;
     |FINSI;

     aDirLocal    = eaUnidadBasico + "\DOCUMENTOS";                     |RMKDIR aDirLocal;
     aDirLocal    = eaUnidadBasico + "\DOCUMENTOS\DSARCHI";             |RMKDIR aDirLocal;
     aDirLocal    = eaUnidadBasico + "\DOCUMENTOS\DSARCHI\LOGOS";       |RMKDIR aDirLocal;
     aFotoDestino = aDirLocal + "/logodespanet" + aExt;

     aContiene1 = aFotoDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aFotoOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aFotoOrigen, aFotoDestino;
         |SINO;
             |COPIA_FICHERO aFotoOrigen, aFotoDestino;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Notificaciones;
     |ABRE #dpntm002;
     |ABRE #dsarm004;
     |SI PARAMETRO = "";
         |ABRE #dpntm001;
         |BUCLE dsarm005NotiTodo;
         |CIERRA  #dpntm001;
     |SINO;
         |BUCLE dpntm001Noti;
     |FINSI;
     |CIERRA #dsarm004;
     |CIERRA #dpntm002;

     |ABRE #dpntm001;
     |SELECT #2#dpntm001;
     |LEE 000#dpntm001.p;
     |SI FSalida ! 0;
         |CIERRA #dpntm001;
         |ACABA;
     |FINSI;
     |CIERRA #dpntm001;

     |SI #dpntm001#11 ! "S";
         |CIERRA #dpntm001;
         |ACABA;
     |FINSI;

     |SI nDESPANET = 0;
         |HAZ Push;

         |SI enSwDesde9 = 1;  |ACABA;  |FINSI;

         |SI #dpntm000#3 = "N";  |ACABA;  |FINSI;

         |SI #dpntm000#3 = "P";
             |MENAV "0000Hay notificaciones para enviar a los Usuarios DESPABOX";

             |CONFI "0000SQuiere enviar las notificaciones";
             |SI FSalida ! 0;  |ACABA;  |FINSI;
         |FINSI;
     |SINO;
         |SI enSwDesde9 = 1;  |ACABA;  |FINSI;

         |SI #dpntm000#4 = "P";
             aAlfa = "0000Hay notificaciones para enviar a " + #dpntm000#1;  |QBF aAlfa;
             |MENAV aAlfa;

             |CONFI "0000SQuiere enviar las notificaciones";
             |SI FSalida ! 0;  |ACABA;  |FINSI;
         |FINSI;
     |FINSI;

     |SUB_EJECUTA "dsarz015";

     |HAZ TraeLogo;

     |ABRE #dpntm002;
     |ABRE #dsarm002;
     |ABRE #dsarm003;
     |ABRE #dsarm004;
     |BUCLE dpntm001Word;
     |CIERRA #dpntm002;
     |CIERRA #dsarm002;
     |CIERRA #dsarm003;
     |CIERRA #dsarm004;
|FPRC;

||**************************************************************************

|PROCESO dsarm005Todo;
     |SI #dsarm005#94 ! "S";
         |SI #dsarm005#94 ! aTipo;  |ACABA;  |FINSI;
     |FINSI;

     aAlfa = "N";

     #dpntm001#0 = #dsarm005#8;
     |LEE 000#dpntm001.=;
     |SI FSalida = 0;
         #dsarm004#0 = #dsarm005#1;
         #dsarm004#1 = #dsarm005#2;
         #dsarm004#2 = #dsarm005#3;
         |LEE 000#dsarm004.=;
         |SI FSalida = 0;  |Y #dsarm004#76 = "S";
             #dpntm002#0 = #dpntm001#0;
             #dpntm002#1 = #dsarm004#0;
             #dpntm002#2 = #dsarm004#1;
             #dpntm002#3 = #dsarm004#2;
             |LEE 000#dpntm002.=;
             |SI FSalida ! 0;
                 aAlfa = "S";
             |FINSI;
         |FINSI;
     |FINSI;

     |SI aAlfa = #dsarm005#94;
         |ACABA;
     |FINSI;

     #dsarm005#94 = aAlfa;

     |GRABA 020#dsarm005.a;
     |LIBERA #dsarm005;
|FPRC;

|DEFBUCLE dsarm005Todo;
     #dsarm005#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, dsarm005Todo;
|FIN;

|| -----------------------------------------------------------------------

|PROCESO dsarm005Cli;
     aAlfa = "N";

     #dsarm004#0 = #dsarm005#1;
     #dsarm004#1 = #dsarm005#2;
     #dsarm004#2 = #dsarm005#3;
     |LEE 000#dsarm004.=;
     |SI FSalida = 0;  |Y #dsarm004#76 = "S";
         #dpntm002#0 = #dpntm001#0;
         #dpntm002#1 = #dsarm004#0;
         #dpntm002#2 = #dsarm004#1;
         #dpntm002#3 = #dsarm004#2;
         |LEE 000#dpntm002.=;
         |SI FSalida ! 0;
             aAlfa = "S";
         |FINSI;
     |FINSI;

     |SI aAlfa = #dsarm005#94;
         |ACABA;
     |FINSI;

     #dsarm005@#0 = #dsarm005#0;
     |LEE 101#dsarm005@.=;
     |SI FSalida = 0;
         #dsarm005@#94 = aAlfa;
         |GRABA 020#dsarm005@.a;
         |LIBERA #dsarm005@;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm005Cli;
     #dsarm005#7;
     ;
     aTipo, #dpntm001#0, "01.01.0000", 000000001;
     aTipo, #dpntm001#0, "31.12.9999", 999999999;
     be;
     NULL, dsarm005Cli;
|FIN;

|PROCESO dpntm001Cli;
     |DDEF aDef;
     aDef = aDef + "dsarm005.mas";
     |CARGA_DEF aDef, dsarm005@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |ABRE #dsarm005@;

     |BUCLE dsarm005Cli;

     |CIERRA #dsarm005@;
     |DESCARGA_DEF #dsarm005@;
|FPRC;

|DEFBUCLE dpntm001Cli;
     #dpntm001#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dpntm001Cli;
|FINSI;

|| **************************************************************************

|PROCESO dpntm001R;
     #dpntm001#11 = "N";
     |GRABA 020#dpntm001.a;
     |LIBERA #dpntm001;
|FPRC;

|DEFBUCLE dpntm001R;
     #dpntm001#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dpntm001R;
|FINSI;

|PROCESO Todo;
     |HAZ Notificaciones;

     |ABRE #dpntm001;
     |ABRE #dpntm002;
     |ABRE #dsarm004;
     |BUCLE dsarm005Todo;
     |CIERRA #dsarm004;
     |CIERRA #dpntm001;
     |CIERRA  #dpntm002;

     |BUCLE dpntm001R;
|FPRC;

|PROCESO dsarw120Cheq;
     #dpntm001#0 = #dsarw120#0;
     |LEE 000#dpntm001.=;
     |SI FSalida ! 0;
         |BORRA 020#dsarw120.a;
         |LIBERA #dsarw120;
         |ACABA;
     |FINSI;

     #dsarm005#0 = #dsarw120#1;
     |LEE 000#dsarm005.=;
     |SI FSalida ! 0;
         |BORRA 020#dsarw120.a;
         |LIBERA #dsarw120;
         |ACABA;
     |FINSI;

     aAlfa = "N";

     #dsarm004#0 = #dsarm005#1;
     #dsarm004#1 = #dsarm005#2;
     #dsarm004#2 = #dsarm005#3;
     |LEE 000#dsarm004.=;
     |SI FSalida = 0;  |Y #dsarm004#76 = "S";
         #dpntm002#0 = #dpntm001#0;
         #dpntm002#1 = #dsarm004#0;
         #dpntm002#2 = #dsarm004#1;
         #dpntm002#3 = #dsarm004#2;
         |LEE 000#dpntm002.=;
         |SI FSalida ! 0;
             aAlfa = "S";
         |FINSI;
     |FINSI;

     |SI aAlfa = #dsarm005#94;
         |BORRA 020#dsarw120.a;
         |LIBERA #dsarw120;
         |ACABA;
     |FINSI;
|FPRC;

|DEFBUCLE dsarw120Cheq;
     #dsarw120#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, dsarw120Cheq;
|FIN;

|PROCESO dsarw120Push;
     #dsarm005#0 = #dsarw120#1;
     |LEE 000#dsarm005.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     eaParamT = "documentos";
     eaParamM = "";

     |HAZ dsarm005Push;
|FPRC;

|DEFBUCLE dsarw120Push;
     #dsarw120#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsarw120Push;
|FIN;

|PROCESO PushSesion;
     |HAZ VersionPython;
     |SI enErrorPy ! 0;  |ACABA;  |FINSI;

     |DBASE aBase;
     aPathTmp = aBase + "tmp";               |MKDIR aPathTmp;
     aPathTmp = aPathTmp + "/" + Usuario;    |MKDIR aPathTmp;
     aPathTmp = aPathTmp + "/";

     aFicTmp = "dpntw008" + Usuario;  |NOME_DAT #dpntw008#aFicTmp#;
     aFicTmp = "dpntw009" + Usuario;  |NOME_DAT #dpntw009#aFicTmp#;

     |ABRE #dpntw008;  |CIERRA #dpntw008;  |DELINDEX #dpntw008;
     |ABRE #dpntw009;  |CIERRA #dpntw009;  |DELINDEX #dpntw009;

     |ABRE #dpntm000;
     |ABRE #dpntm002;
     |ABRE #dpntm003;
     |ABRE #dpntm004;
     |ABRE #dsarm002;
     |ABRE #dsarm003;
     |ABRE #dsarm004;
     |ABRE #dsarm005;
     |ABRE #dpntw008;
     |ABRE #dpntw009;

     |BUCLE dsarw120Push;

     |CIERRA #dpntm000;
     |CIERRA #dpntm002;
     |CIERRA #dpntm003;
     |CIERRA #dpntm004;
     |CIERRA #dsarm002;
     |CIERRA #dsarm003;
     |CIERRA #dsarm004;
     |CIERRA #dsarm005;
     |CIERRA #dpntw008;
     |CIERRA #dpntw009;

     |BUCLE dpntw008;

     |DELINDEX #dpntw008;
     |DELINDEX #dpntw009;
|FPRC;

|PROCESO dpntm001Sesion;
     #dsarw120#0 = #dpntm001#0;
     #dsarw120#1 = 1;
     |LEE 000#dsarw120.];
     |SI FSalida ! 0;  |O #dsarw120#0 ! #dpntm001#0;
         |ACABA;
     |FINSI;

     |HAZ dpntm001Word;
|FPRC;

|DEFBUCLE dpntm001Sesion;
     #dpntm001#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dpntm001Sesion;
|FINSI;

|PROCESO LaSesion;
     |ABRE #dpntm001;
     |ABRE #dpntm002;
     |ABRE #dsarm004;
     |ABRE #dsarm005;
     |BUCLE dsarw120Cheq;
     |CIERRA #dsarm005;
     |CIERRA #dsarm004;
     |CIERRA #dpntm002;
     |CIERRA #dpntm001;

     |LEE 000#dsarw120.p;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     |SI nDESPANET = 0;
         |HAZ PushSesion;

         |SI enSwDesde9 = 1;
             |ACABA;
         |FINSI;

         |SI #dpntm000#3 = "N";
             |ACABA;
         |FINSI;

         |SI #dpntm000#3 = "P";
             |MENAV "0000Hay notificaciones para enviar a los Usuarios DESPABOX";

             |CONFI "0000SQuiere enviar las notificaciones";
             |SI FSalida ! 0;  |ACABA;  |FINSI;
         |FINSI;
     |SINO;
         |SI enSwDesde9 = 1;  |ACABA;  |FINSI;

         |SI #dpntm000#4 = "P";
             aAlfa = "0000Hay notificaciones para enviar a " + #dpntm000#1;  |QBF aAlfa;
             |MENAV aAlfa;

             |CONFI "0000SQuiere enviar las notificaciones";
             |SI FSalida ! 0;  |ACABA;  |FINSI;
         |FINSI;
     |FINSI;

     |SUB_EJECUTA "dsarz015";

     |HAZ TraeLogo;

     |ABRE #dpntm002;
     |ABRE #dsarm002;
     |ABRE #dsarm003;
     |ABRE #dsarm004;
     |ABRE #dsarm005;
     |BUCLE dpntm001Sesion;
     |CIERRA #dpntm002;
     |CIERRA #dsarm002;
     |CIERRA #dsarm003;
     |CIERRA #dsarm004;
     |CIERRA #dsarm005;
|FPRC;

|PROCESO dsarw120Marca;
     #dsarm005#0 = #dsarw120#1;
     |LEE 101#dsarm005.=;
     |SI FSalida ! 0;
         |ACABA;
     |FINSI;

     aAlfa = "N";

     #dsarm004#0 = #dsarm005#1;
     #dsarm004#1 = #dsarm005#2;
     #dsarm004#2 = #dsarm005#3;
     |LEE 000#dsarm004.=;
     |SI FSalida = 0;  |Y #dsarm004#76 = "S";
         #dpntm002#0 = #dpntm001#0;
         #dpntm002#1 = #dsarm004#0;
         #dpntm002#2 = #dsarm004#1;
         #dpntm002#3 = #dsarm004#2;
         |LEE 000#dpntm002.=;
         |SI FSalida ! 0;
             aAlfa = "S";
         |FINSI;
     |FINSI;

     #dsarm005#94 = aAlfa;

     |GRABA 020#dsarm005.a;
     |LIBERA #dsarm005;
|FPRC;

|DEFBUCLE dsarw120Marca;
     #dsarw120#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsarw120Marca;
|FIN;

|PROGRAMA;
     enCalcDESPANET = 1;

     |HAZ LeeUnidadBasico;

     |ABRE #dsarm001;
     |LEE 000#dsarm001.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarm001;  |FINSI;
     |CIERRA #dsarm001;

     |SI #dsarm001#122 = "N";  |ACABA;  |FINSI;

     aTipo     = "N";
     nDESPANET = 0;

     |ABRE #dpntm001;
     aUsuario = Usuario % 810;
     #dpntm001#0   = aUsuario;
     |LEE 000#dpntm001.=;
     |SI FSalida = 0;
         nDESPANET = 1;
         aTipo     = "C";
     |FINSI;
     |CIERRA #dpntm001;

     |ABRE #dpntm000;
     |LEE 000#dpntm000.p;
     |SI FSalida ! 0;  |DDEFECTO #dpntm000;  |FINSI;
     |CIERRA #dpntm000;

     |SI nDESPANET ! 0;
         |SI #dpntm000#4 = "N";  |ACABA;  |FINSI;
     |FINSI;

     |SI enSwDesde9 = 0;
          |VENTANA 0501, 1071, -1, 16, "Reconstruyendo base de datos para DESPABOX y enviando NOTIFICACIONES";
          nVentz1  = FSalida;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentz1;
          aVent5 = "MODAL";
          |ESPECIFICA "ESTADO_VENTANA", aVent;
     |SINO;
          |SI enSwNomina = 0;
               |PUSHV 0501 2380;
               |PINPA #0#dsarw053;
               |PINDA #0#dsarw053;
          |FINSI;
     |FINSI;

     |PTEC 802;
     |PAUSA;

     |SI enSwDesde9 = 0;
          |CONTROL_SIMPLE 0, "LABEL,{{9}}Reconstruyendo base de datos para DESPABOX y enviando NOTIFICACIONES", 0602, 0970, NULL;
     |FINSI;

     nSesion = 0;
     |SI PARAMETRO = "";  |O aTipo = "C";
         |HAZ Todo;
     |SINO;
         nSesion = 1;
         aFic    = "dsarw120" + Usuario;
         |NOME_DAT #dsarw120#aFic#;

         |ABRET #dsarw120;
         |HAZ LaSesion;
         |CIERRAT #dsarw120;

         |ABRE #dpntm002;
         |ABRE #dsarm004;
         |ABRE #dsarm005;
         |BUCLE dsarw120Marca;
         |CIERRA #dsarm005;
         |CIERRA #dsarm004;
         |CIERRA #dpntm002;

         |DELINDEX #dsarw120;
     |FINSI;

     |SI enSwDesde9 = 0;
          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentz1;
          aVent5 = "MODELESS";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |FINVENTANA nVentz1;
     |SINO;
          |POPV;
     |FINSI;
|FPRO;
