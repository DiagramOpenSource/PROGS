||MiraSiFechaRegistro  TODO

|FICHEROS;
     flowz001 #0;

     dsarm001 #1;
     dsarm002 #2;
     dsarm003 #3;
     dsarm004 #4;
     dsarm005 #5;

     flowm001 #601;
     flowm002 #602;
     flowm003 #603;
     flowm004 #604;
     flowm005 #605;
     flowm006 #606;
     flowm007 #607;
     flowm010 #610;
     flowm014 #614;
     flowm015 #615;      ||Depositos por cliente
     flowm020;

     floww003 #803;
     dsarw008 #908;

     floww004 #804;

     floww007 #807,MANTE;      ||Aux. Pedir Fec.Cadu.

     dsarz010 #10;       ||Permisos Usuarios
     dsarm030 #30;
     dsarm031 #31;
     dsarm029 #29;       ||Plantillas AutoRelle
     dsarw058 #958;

     referen@ #905;      ||Carga_def resultados

     dsarm034;           ||Resultado dsEscan
     dsarm035 #35;       ||VAR. Resul. dsEscan
|FIN;

|VARIABLES;
     ||BANDEJADSESCANMANUAL
     aVacio25 = "";
     aZeta25 = "";
     &efFechaBandeja = @;
     &eaHoraBandeja = "";
     &eaNombreBandeja = "";
     nSwCreaBanDSEscanManual = 0;
     nSwEstaBandeja = 0;

     &enPosicionateCampo = 0;

     nMarcas = 0;
     nMarcasAprop = 0;
     nDocMarcado = 0;
     nDocMarcadoAprop = 0;
     aDef = "";

     nGrupoBef = 0;
     nSubGrupoBef = 0;
     nTipoBef = 0;
     nSituBef = 0;

     aMarca = "";
     aEstoyUsu = "";
     nEstoyGru = 0;
     nEstoySGr = 0;
     nEstoyTip = 0;
     nEstoySit = 0;
     nEstoyDoc = 0;
     nSwEstoyMarca = 0;

     ||Autoplantilla
     aValor = "";
     aAux2 = "";
     nSwLogError = 0;
     nRegDocu = 0;
     aUbicacion = "";
     aFicheroTif = "";
     aMete31 = "";
     aAux = "";
     nVentz1 = 0;
     nPos1 = 0;
     nPos2 = 0;
     nContDos = 0;
     nContReal = 0;
     nCampo1 = 0;

     ||Variables externas para MiraSiFechaRegistro
     &enGrupoFR = 0;
     &enSubGrupoFR = 0;
     &enTipoFR = 0;
     &enSitFR = 0;
     &enSwFR = 0;
     &efFechaFR = @;
     &enNumDocFR = 0;

     ||Fecha Caducidad
     aCadManual = "";
     nSubGrupoOri = 0;
     nGrupoOri = 0;
     fFechaCaducidad = @;
     fSistema = @;
     nSistema = 0;
     nSwFechaRegistro = 0;
     fFechaRegistro = @;
     nTipoOri = 0;
     nSituOri = 0;
     aTipoCad = "";
     nNumCad = 0;
     nVentFC = 0;
     aFechaCad = "";
     fFechaCad = @;

     aBorraCache = "";

     &enNumRegistro = 0;
     &enSwCamposObligados = 0;
     &eaPermisoModTipo = "S";
     &enGrupoCO = 0;
     &enSubGrupoCO = 0;
     &enTipoCO = 0;
     &enSituCO = 0;
     &enNumDocCO = 0;
     &enModoModiw006 = 0;
     &eaTextoCO = "";
     &enNumLibreCO = 0;
     &enPosicionCO = 0;

     &enSwIOCorrecta = 0;
     &enSwDocModificado = 0;
     nSwModoConsulta = 0;

     &enPassword = 0;
     &enNumRegFlow = 0;
     &enSituFlow = 0;
     &eaDesSituFlow = "";

     aFicAux = "";
     nSwVerDocPDF = 0;
     nHandleX = 0;
     aAuxPath = "";

     aUrl = "";
     aClave = "";
     aAuxNom = "";
     nCampo = 0;

     nPanta = 0;
     aTextoAnotacion = "";
     nSwHayFlow = 0;
     aDocHis = "";
     nSitu = 0;
     aOriHis = "";
     aDesHis = "";
     nSalidaHis = 0;

     nGrupoAra = 0;
     nSubGrupoAra = 0;
     nTipoAra = 0;


     ||ESTO YA NO SE USA
     aGuarda10 = "";          ||Sirven para guardar los nuevos campos al cambiar de situacion
     aGuarda11 = "";
     aGuarda12 = "";
     aGuarda13 = "";
     aGuarda14 = "";
     aGuarda15 = "";
     aGuarda16 = "";
     aGuarda17 = "";
     aGuarda18 = "";

     nSwObligatorios = 0;
     &enMueveDoc = 0;
     aFechaSis = "";
     aAAAAMM = "";

     nBotonQ1 = 0;
     nBotonQ2 = 0;
     nBotonQ3 = 0;
     nBotonQ4 = 0;
     nPantaMover = 0;
     &enGrupo        = 0;
     &enSubGrupo     = 0;
     &enTipo         = 0;
     nGrupoAnt = 0;
     nSubGruAnt = 0;
     nTipoAnt = 0;

     &enGrupoPV = 0;
     &enSubGrupoPV = 0;
     &enTipoPV = 0;

     nSwSeleMover = 0;
     nDocumento = 0;
     aUsu15 = "";

     nSwDeposito = 0;         ||Nos indica si las ramas del arbol son DEPOSITO o NO (SITUACIONES)

     aPrefijo = "";

     nBoton1          = -1;
     nBoton2          = -1;
     nBoton3          = -1;
     nBoton3Cero      = -1;
     nBoton4          = -1;
     nBoton5          = -1;
     nBoton6          = -1;
     nBoton7          = -1;
     nBoton8          = -1;
     nBoton9          = -1;
     nBoton10         = -1;
     nBtnUsu          = -1;
     nBtnAdm          = -1;

     nVentm5          = -1;
     nTree            = -1;
     nGrid605         = -1;
     nGrid615         = -1;
     nGrid614         = -1;

     nGrupo           = 0;
     nSubGrupo        = 0;
     nTipo            = 0;
     nLong            = 0;
     nCargar          = 0;
     nConta           = 0;
     nContaAnt        = 0;
     nHandle          = 0;
     nRango           = 0;
     nFichero         = 0;
     nBotonLabel      = 0;
     nCarpeta1        = 0;
     nCarpeta2        = 0;
     nCarpeta3        = 0;
     nCarpeta4        = 0;
     nCarpeta5        = 0;
     nCarpeta6        = 0;
     nContador        = 0;
     nOpcion          = 0;
     nPosi            = 0;
     nPos             = 0;
     nBotonFoto       = 0;
     nVentana         = 0;
     nVent            = 0;
     nSituacion       = 0;
     nDSitua          = 0;
     nHSitua          = 0;
     nMes             = 0;
     nDia             = 0;
     nDia1            = 0;
     nDia2            = 0;
     nHora            = 0;
     nMinuto          = 0;
     nHora1           = 0;
     nHora2           = 0;
     nDocu            = 0;
     nLinea           = 0;
     nPanta803        = 0;
     nResponde        = 0;
     nPasada          = 0;
     nUsuarios        = 0;
     nPausa           = 0;
     nLabelAnota      = -1;

     aHora            = "";
     aGuarda          = "";
     aUsuario         = "";
     aEsc1            = "";
     aEsc2            = "";
     aRetu            = "";
     aTecla           = "";
     aAlfa            = "";
     aFichero         = "";
     aParametro       = "";
     aAbre            = "";
     aOrigen          = "";
     aDestino         = "";
     aIPRemoto        = "";
     aBase            = "";
     aMas             = "";
     aBusca           = "";
     aRefresca        = "";
     aTexto           = "";
     aLong            = "";
     aCarac           = "";
     aDirLocal        = "";
     aExt             = "";
     aFotoOrigen      = "";
     aFotoDestino     = "";
     aFoto            = "";
     aDocRemoto       = "";
     aDocServidor     = "";
     aQueQuiero       = "";
     aDTipo           = "";
     aHTipo           = "";
     aDUsu            = "";
     aHUsu            = "";
     aPathBase        = "";
     aPathRemoto      = "";
     aMensaje         = "";
     aEjecuta         = "";
     aTipoTree        = "";

     fFechaHoy        = @;

     {-1}sTree        = 0;
     sT_nID           = 0;
     sT_nOper         = 0;
     sT_aData         = "";

     {1}aContiene     = "";

     {-1}aVent        = "";
         aVent1       = 0;
         aVent2       = 0;
         aVent3       = 0;
         aVent4       = 0;
         aVent5       = "";

     &eaRutaOrigen    = "";
     &eaRutaDestino   = "";
     &eaFicheroTxt    = "";
     &eaFicheroTgz    = "";
     &eaFicheroTar    = "";
     &eaUnidad        = "";
     &eaUnidadBasico  = "";
     &eaOrigen        = "";
     &eaDestino       = "";
     &enDocumento     = 0;
     &enAlfa          = 0;
     &eaPrograma      = "";
     &enAprobacion    = 0;
|FIN;

|PROCESO Tipo12_w007; |TIPO 12;
|FPRC;

|PROCESO flowm007T;
     nConta = nConta + 1;
|FPRC;

|DEFBUCLE flowm007T;
     #607#1;
     ;
     nDocumento, 001;
     nDocumento, 999;
     ;
     NULL, flowm007T;
|FIN;

|PROCESO PintaAnotaciones
     |SI nConta = 0;
          |SI nBoton3 = -1;
               aTextoAnotacion = "BOTON,{{137}}Anotaciones (" + nConta + ")";
               |CONTROL_SIMPLE nPanta, aTextoAnotacion, 1762, 1877, Boton3;
               nBoton3 = FSalida;
          |FINSI;

          |SI nBoton3Cero = -1;
               aTextoAnotacion = "BOTON,{{137}}Anotaciones (0)";
               |CONTROL_SIMPLE nPanta, aTextoAnotacion, 1762, 1877, Boton3;
               nBoton3Cero = FSalida;
          |FINSI;

          |ESTADO_CONTROL nBoton3, "HIDE";
          |ESTADO_CONTROL nBoton3Cero, "SHOW";

          nContaAnt = nConta;
     |SINO;
          |SI nBoton3Cero = -1;
               aTextoAnotacion = "BOTON,{{137}}Anotaciones (0)";
               |CONTROL_SIMPLE nPanta, aTextoAnotacion, 1762, 1877, Boton3;
               nBoton3Cero = FSalida;
          |FINSI;
          |ESTADO_CONTROL nBoton3Cero, "HIDE";

          |SI nContaAnt ! nConta;
               |SI nBoton3 ! -1;
                    |FIN_CONTROL_WINDOWS nBoton3;
                    nBoton3 = -1;
               |FINSI;
               aTextoAnotacion = "BOTON,{{137}}Anotaciones (" + nConta + ")";
               |CONTROL_SIMPLE nPanta, aTextoAnotacion, 1762, 1877, Boton3;
               nBoton3 = FSalida;

               |ESTADO_CONTROL nBoton3, "SHOW";
          |FINSI;
          nContaAnt = nConta;
     |FINSI;
|FPRC;


|PROCESO AnotacionACero;
     nConta = 0;
     |HAZ PintaAnotaciones;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

/*
     |SI nLabelAnota ! -1;
         |FIN_CONTROL_WINDOWS nLabelAnota;
         nLabelAnota = -1;
         |PULSATECLA;
     |FINSI;

     nConta = 0;

     aAlfa = "LABEL,{{16}} (" + nConta + ")";
     |CONTROL_SIMPLE nPanta, aAlfa, 1578, 1581, NULL;
     nLabelAnota = FSalida;

     |PULSATECLA;
*/
|FPRC;


|PROCESO ActualizaAnotacion;
     nConta = 0;
     |SI nSwDeposito = 0;
          nDocumento = #605#5;
     |SINO;
          nDocumento = #615#5;
     |FINSI;
     |BUCLE flowm007T;
     |HAZ PintaAnotaciones;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;


/*
     |SI nLabelAnota ! -1;
         |FIN_CONTROL_WINDOWS nLabelAnota;
         nLabelAnota = -1;
         |PULSATECLA;
     |FINSI;

     nConta = 0;
     |SI nSwDeposito = 0;
          nDocumento = #605#5;
     |SINO;
          nDocumento = #615#5;
     |FINSI;
     |BUCLE flowm007T;

     aAlfa = "LABEL,{{16}} (" + nConta + ")";
     |CONTROL_SIMPLE nPanta, aAlfa, 1578, 1581, NULL;
     nLabelAnota = FSalida;

     |PULSATECLA;
*/
|FPRC;

|PROCESO Baja605;
     #605#0  = aUsuario;
     #605#1  = nGrupo;
     #605#2  = nSubGrupo;
     #605#3  = nTipo;
     #605#4  = nDSitua;
     #605#5  = 000000001;
|FPRC;

|PROCESO Alta605;
     #605#0  = aUsuario;
     #605#1  = nGrupo;
     #605#2  = nSubGrupo;
     #605#3  = nTipo;
     #605#4  = nHSitua;
     #605#5  = 999999999;
|FPRC;

|PROCESO Baja605_3;
     #605#21 = aUsuario;
     #605#1  = nGrupo;
     #605#2  = nSubGrupo;
     #605#3  = nTipo;
     #605#4  = nDSitua;
     #605#5  = 000000001;
|FPRC;

|PROCESO Alta605_3;
     #605#21 = aUsuario;
     #605#1  = nGrupo;
     #605#2  = nSubGrupo;
     #605#3  = nTipo;
     #605#4  = nHSitua;
     #605#5  = 999999999;
|FPRC;

|PROCESO Baja615;
     #615#0  = aUsuario;
     #615#1  = nGrupo;
     #615#2  = nSubGrupo;
     #615#3  = nTipo;
     #615#4  = 000;
     #615#5  = 000000001;
|FPRC;

|PROCESO Alta615;
     #615#0  = aUsuario;
     #615#1  = nGrupo;
     #615#2  = nSubGrupo;
     #615#3  = nTipo;
     #615#4  = 000;
     #615#5  = 999999999;
|FPRC;

|PROCESO Baja615_3;
     #615#19 = aUsuario;
     #615#1  = nGrupo;
     #615#2  = nSubGrupo;
     #615#3  = nTipo;
     #615#4  = 000;
     #615#5  = 000000001;
|FPRC;

|PROCESO Alta615_3;
     #615#19 = aUsuario;
     #615#1  = nGrupo;
     #615#2  = nSubGrupo;
     #615#3  = nTipo;
     #615#4  = 000;
     #615#5  = 999999999;
|FPRC;

|PROCESO Evento605;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#605=;

         |ESTADO_CONTROL nBoton2, "ENABLE";
         |ESTADO_CONTROL nBoton3, "ENABLE";
         |ESTADO_CONTROL nBoton3Cero, "ENABLE";

         |SI #605#8 = "C";
             |ESTADO_CONTROL nBoton4, "ENABLE";
         |SINO;
             |ESTADO_CONTROL nBoton4, "DISABLE";
         |FINSI;

         |ESTADO_CONTROL nBoton5, "ENABLE";
         |ESTADO_CONTROL nBoton6, "ENABLE";
         |ESTADO_CONTROL nBoton7, "ENABLE";
         |ESTADO_CONTROL nBoton10, "ENABLE";

         |ESTADO_CONTROL nBoton8, "DISABLE";

         |HAZ ActualizaAnotacion;
     |FINSI;

     |SI FSalida = 4;
         |LEE 101#605=;
         |SI FSalida = 0;
               |ABRE #flowm002;
               |DDEFECTO #flowm002;
               #flowm002#0 = #605#1;
               #flowm002#1 = #605#2;
               #flowm002#2 = #605#3;
               #flowm002#3 = #605#4;
               |LEE 000#flowm002.=;
               |SI FSalida = 0; |Y #flowm002#19 = "S";
                    aMarca = #605#20;
                    |QBF aMarca;
                    |SI aMarca = "";
                         #605#20 = "*";
                    |SINO;
                         #605#20 = "";
                    |FINSI;
                    |PINTA #605#20;
                    |GRABA 020#605.a;

                    |REFRESCACONTROL nGrid605;
               |SINO;
                    |SI FSalida = 0;
                         aMensaje = "0000Esta situaci¢n NO permite la selecci¢n multiple";
                         |MENAV aMensaje;
                    |FINSI;
               |FINSI;
               |LIBERA #605;
               |CIERRA #flowm002;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Evento615;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#615=;

         ||TODO CCC
         |ESTADO_CONTROL nBoton2, "ENABLE";
         |ESTADO_CONTROL nBoton3, "ENABLE";
         |ESTADO_CONTROL nBoton3Cero, "ENABLE";
         |ESTADO_CONTROL nBoton6, "ENABLE";
         |ESTADO_CONTROL nBoton8, "ENABLE";
         |ESTADO_CONTROL nBoton7, "ENABLE";
         |ESTADO_CONTROL nBoton10, "ENABLE";

         |ESTADO_CONTROL nBoton4, "DISABLE";
         |ESTADO_CONTROL nBoton5, "DISABLE";

         |HAZ ActualizaAnotacion;
     |FINSI;
|FPRC;

|PROCESO flowm005_limpia;
     #flowm005#20 = "";
     |GRABA 020#flowm005.a;
|FPRC;

|DEFBUCLE flowm005_limpia;
 #flowm005#1;
 ;
 aUsuario, nGrupoBef, nSubGrupoBef, nTipoBef, nSituBef, 000000001;
 aUsuario, nGrupoBef, nSubGrupoBef, nTipoBef, nSituBef, 999999999;
 be;
 NULL, flowm005_limpia;
|FIN;

|PROCESO LimpiaMarcas;
     |SI nGrupoBef = 0; |Y nSubGrupoBef = 0; |Y nTipoBef = 0; |Y nSituBef = 0;
          |ACABA;
     |FINSI;

     |ABRE #flowm002;
     |DDEFECTO #flowm002;
     #flowm002#0 = nGrupoBef;
     #flowm002#1 = nSubGrupoBef;
     #flowm002#2 = nTipoBef;
     #flowm002#3 = nSituBef;
     |LEE 000#flowm002.=;
     |SI FSalida = 0; |Y #flowm002#19 = "S";
          aMensaje = "0000Limpia" + nGrupoBef + "." + nSubGrupoBef + "." + nTipoBef + ".Sit: " + nSituBef;
          |QBF aMensaje;
          ||MENAV aMensaje;

          |BUCLE flowm005_limpia;
     |FINSI;
     |CIERRA #flowm002;
|FPRC;

|PROCESO EventoTree;
     |SI FEntrada ! 0;  |ACABA;  |FINSI;

     aAlfa        = Contenido;  |QBF aAlfa;
     aTexto       = "";
     aLong        = aAlfa % 0;
     nLong        = aLong;
     nCargar      = 0;
     |PARA nPosi  = 1;  |SI nPosi [ nLong;  |HACIENDO nPosi = nPosi + 1;
           nPos = (nPosi * 100) + 1;
           aCarac = aAlfa % nPos;
           |SI nCargar = 1;
               aTexto = aTexto + aCarac;
           |FINSI;

           |SI aCarac = ":";  nCargar = 1; |FINSI;
     |SIGUE;

     |SI aTexto = "";
         aAlfa = aTexto % 103;   nGrupo     = aAlfa;
         aAlfa = aTexto % 403;   nSubGrupo  = aAlfa;
         aAlfa = aTexto % 703;   nTipo      = aAlfa;
         aAlfa = aTexto % 1003;  nSituacion = aAlfa;

         |HAZ AnotacionACero;

         |HAZ LimpiaMarcas;
         nGrupoBef = nGrupo;
         nSubGrupoBef = nSubGrupo;
         nTipoBef = nTipo;
         nSituBef = nSituacion;

         |REFRESCACONTROL nGrid605;

         |PULSATECLA;

         |ESTADO_CONTROL nBoton2, "DISABLE";
         |ESTADO_CONTROL nBoton3, "DISABLE";
         |ESTADO_CONTROL nBoton3Cero, "DISABLE";
         |ESTADO_CONTROL nBoton4, "DISABLE";
         |ESTADO_CONTROL nBoton5, "DISABLE";
         |ESTADO_CONTROL nBoton6, "DISABLE";
         |ESTADO_CONTROL nBoton7, "DISABLE";
         |ESTADO_CONTROL nBoton8, "DISABLE";
         |ESTADO_CONTROL nBoton10, "DISABLE";

         |ACABA;
     |FINSI;

     aGuarda = aTexto;

     aAlfa = aTexto % 103;
     nSwDeposito = 0;
     |SI aAlfa = "DEP";
          nSwDeposito = 1;
          aTexto = aTexto - "DEP";
          aAlfa = aTexto % 103;
     |FINSI;
     nGrupo     = aAlfa;
     aAlfa = aTexto % 403;   nSubGrupo  = aAlfa;
     aAlfa = aTexto % 703;   nTipo      = aAlfa;
     aAlfa = aTexto % 1003;  nSituacion = aAlfa;

     |SI nSwDeposito = 0;
          |HAZ LimpiaMarcas;
          nGrupoBef = nGrupo;
          nSubGrupoBef = nSubGrupo;
          nTipoBef = nTipo;
          nSituBef = nSituacion;

          nDSitua = nSituacion;
          nHSitua = nSituacion;
          |SI nSituacion = 0;
              nDSitua = 1;
              nHSitua = 999;
          |FINSI;

          |SI aTipoTree = "USU";
              |SELECT #1#605;
              #605#0  = aUsuario;
              #605#1  = nGrupo;
              #605#2  = nSubGrupo;
              #605#3  = nTipo;
              #605#4  = nDSitua;
              #605#5  = 000000001;
              |LEE 000#605];
          |FINSI;

          |SI aTipoTree = "ADM";
              |SELECT #3#605;
              #605#21 = aUsuario;
              #605#1  = nGrupo;
              #605#2  = nSubGrupo;
              #605#3  = nTipo;
              #605#4  = nDSitua;
              #605#5  = 000000001;
              |LEE 000#605];
          |FINSI;

          |SI nGrid605 = -1;
              nRango     = 4 + 8 + 16 + 32 + 128;
              |SI aTipoTree = "USU";
                  |LINEAL_SIMPLE #1#605, nRango, 2202, 3198, Baja605, Alta605, Evento605;
              |FINSI;

              |SI aTipoTree = "ADM";
                  |LINEAL_SIMPLE #3#605, nRango, 2202, 3198, Baja605_3, Alta605_3, Evento605;
              |FINSI;

              nGrid605 = FSalida;
          |FINSI;

          |ESTADO_CONTROL nGrid615, "HIDE";
          |ESTADO_CONTROL nGrid605, "SHOW";

          |ESTADO_CONTROL nBoton2, "DISABLE";
          |ESTADO_CONTROL nBoton3, "DISABLE";
          |ESTADO_CONTROL nBoton3Cero, "DISABLE";
          |ESTADO_CONTROL nBoton4, "DISABLE";
          |ESTADO_CONTROL nBoton5, "DISABLE";
          |ESTADO_CONTROL nBoton6, "DISABLE";
          |ESTADO_CONTROL nBoton7, "DISABLE";
          |ESTADO_CONTROL nBoton8, "DISABLE";
          |ESTADO_CONTROL nBoton10, "DISABLE";

          |HAZ AnotacionACero;
          |ESTADO_CONTROL nBoton3Cero, "DISABLE";
          |REFRESCACONTROL nGrid605;

          |PULSATECLA;
     |SINO;
          |HAZ LimpiaMarcas;
          nGrupoBef = 0;
          nSubGrupoBef = 0;
          nTipoBef = 0;
          nSituBef = 0;

          |SI aTipoTree = "USU";
               |SELECT #1#615;
               #615#0  = aUsuario;
               #615#1  = nGrupo;
               #615#2  = nSubGrupo;
               #615#3  = nTipo;
               #615#4  = 000;
               #615#5  = 000000001;
               |LEE 000#615];
          |FINSI;

          |SI aTipoTree = "ADM";
               |SELECT #3#615;
               #615#19 = aUsuario;
               #615#1  = nGrupo;
               #615#2  = nSubGrupo;
               #615#3  = nTipo;
               #615#4  = 000;
               #615#5  = 000000001;
               |LEE 000#615];
          |FINSI;

          |SI nGrid615 = -1;
              nRango     = 4 + 8 + 16 + 32 + 128;

              |SI aTipoTree = "USU";
                  |LINEAL_SIMPLE #1#615, nRango, 2202, 3198, Baja615, Alta615, Evento615;
              |FINSI;

              |SI aTipoTree = "ADM";
                  |LINEAL_SIMPLE #3#615, nRango, 2202, 3198, Baja615_3, Alta615_3, Evento615;
              |FINSI;

              nGrid615 = FSalida;
          |FINSI;

          |ESTADO_CONTROL nGrid605, "HIDE";
          |ESTADO_CONTROL nGrid615, "SHOW";

          |ESTADO_CONTROL nBoton2, "DISABLE";
          |ESTADO_CONTROL nBoton3, "DISABLE";
          |ESTADO_CONTROL nBoton3Cero, "DISABLE";
          |ESTADO_CONTROL nBoton4, "DISABLE";
          |ESTADO_CONTROL nBoton5, "DISABLE";
          |ESTADO_CONTROL nBoton6, "DISABLE";
          |ESTADO_CONTROL nBoton7, "DISABLE";
          |ESTADO_CONTROL nBoton8, "DISABLE";
          |ESTADO_CONTROL nBoton10, "DISABLE";

          |HAZ AnotacionACero;
          |ESTADO_CONTROL nBoton3Cero, "DISABLE";
          |REFRESCACONTROL nGrid615;

          |PULSATECLA;
     |FINSI;
|FPRC;

|PROCESO CargaArbol;
     |QBF aAlfa;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO flowm005T;
     nConta = nConta + 1;
|FPRC;

|DEFBUCLE flowm005T;
     #605#1;
     ;
     #604#4, #604#0, #604#1, #604#2, 001, 000000001;
     #604#4, #604#0, #604#1, #604#2, 999, 999999999;
     ;
     NULL, flowm005T;
|FIN;

|PROCESO flowm005S;
     nConta = nConta + 1;

     #602#0 = #605#1;
     #602#1 = #605#2;
     #602#2 = #605#3;
     #602#3 = #605#4;
     |LEE 000#602=;
     |SI FSalida ! 0;  |DDEFECTO #602;  |FINSI;

     |HORA aHora;

     nDia1  = #605#6;
     nDia2  = fFechaHoy;

     aAlfa  = (#605#7 % 102);  nHora   = aAlfa;
     aAlfa  = (#605#7 % 402);  nMinuto = aAlfa;
     nHora1 = (nHora * 60) + nMinuto;

     aAlfa  = (aHora % 102);  nHora   = aAlfa;
     aAlfa  = (aHora % 402);  nMinuto = aAlfa;
     nHora2 = (nHora * 60) + nMinuto;

     #605#9  = "0,0,0;0,255,0";

     |SI #605#8  = "C";
         #605#9  = "0,0,0;255,255,0";
     |FINSI;


     aFechaCad = #605#19;
     |QBF aFechaCad;
     |SI aFechaCad ! "01.01.0000";
          fFechaCad = #605#19;

          |SI fFechaCad [ fFechaHoy;
               #605#9  = "0,0,0;255,0,0";
          |FINSI;
     |SINO;
          |SI #602#10 = "H";
              nHora = (nHora2 - nHora1) / 60;

              nDia = nDia2 - nDia1;
              |SI nDia ! 0;
                  |SI nDia = 1;
                      |SI nHora > 0;
                          nHora = 999;
                      |FINSI;
                  |SINO;
                      nHora = 999;
                  |FINSI;
              |FINSI;

              |SI nHora < 0;
                  nHora = -nHora;
                  nHora = nHora + 12;
              |FINSI;

              |SI nHora > #602#11;
                  #605#9  = "0,0,0;255,0,0";
              |FINSI;
          |FINSI;

          |SI #602#10 = "D";
              nDia = nDia2 - nDia1;

              |SI nDia ] #602#11;
                  #605#9  = "0,0,0;255,0,0";
              |FINSI;
          |FINSI;

          |SI #602#10 = "M";
              nMes = ((nDia2 - nDia1) / 30) ! 0;

              |SI nMes ] #602#11;
                  #605#9  = "0,0,0;255,0,0";
              |FINSI;
          |FINSI;
     |FINSI;

     |GRABA 020#605a;
     |LIBERA #605;
|FPRC;

|DEFBUCLE flowm005S;
     #605#1;
     ;
     #604#4, #604#0, #604#1, #604#2, #604#3, 000000001;
     #604#4, #604#0, #604#1, #604#2, #604#3, 999999999;
     be;
     NULL, flowm005S;
|FIN;

|PROCESO flowm004_2;
     #2#0 = #604#0;
     |LEE 000#2=;
     |SI FSalida ! 0;  |DDEFECTO  #2;  |FINSI;

     |SI #1#8 = "S";
         #3#0 = #604#0;
         #3#1 = #604#1;
         |LEE 000#3=;
         |SI FSalida ! 0;  |DDEFECTO  #3;  |FINSI;

         #4#0 = #604#0;
         #4#1 = #604#1;
         #4#2 = #604#2;
         |LEE 000#4=;
         |SI FSalida ! 0;  |DDEFECTO  #4;  |FINSI;
     |FINSI;

     |SI nGrupo ! #604#0;  |O nSubGrupo ! #604#1;  |O nTipo ! #604#2;
         nCarpeta1 = nCarpeta1 + 1;
         nCarpeta2 = 0;
         nConta    = 0;

         |BUCLE flowm005T;

         |SI #1#8 = "S";
             aAlfa = "(" + nConta  + ") ";
             aAlfa = aAlfa + #2#1;  |QBF aAlfa;
             aAlfa = aAlfa + " / " + #3#2;  |QBF aAlfa;
             aAlfa = aAlfa + " / " + #4#3;  |QBF aAlfa;
             aAlfa = aPrefijo + nCarpeta1 + ":" + aAlfa;  |QBF aAlfa;
             aAlfa = aAlfa + "{{" + (("000" + #2#0) % -103);
             aAlfa = aAlfa + (("000" + #3#1) % -103);
             aAlfa = aAlfa + (("000" + #4#2) % -103) + "}}";
         |SINO;
             aAlfa = "(" + nConta  + ") ";
             aAlfa = aAlfa + #2#1;  |QBF aAlfa;
             aAlfa = aPrefijo + nCarpeta1 + ":" + aAlfa;  |QBF aAlfa;
             aAlfa = aAlfa + "{{" + (("000" + #2#0) % -103) + "001001}}";
         |FINSI;

         |HAZ CargaArbol;
     |FINSI;

     #602#0 = #604#0;
     #602#1 = #604#1;
     #602#2 = #604#2;
     #602#3 = #604#3;
     |LEE 000#602=;
     |SI FSalida ! 0;  |DDEFECTO #602;  |FINSI;

     nCarpeta2 = nCarpeta2 + 1;
     nConta    = 0;
     |BUCLE flowm005S;
     aAlfa  = "(" + nConta  + ") ";
     aAlfa  = aAlfa + " " + (("000" + #602#3) % -103) + " - " + #602#4;  |QBF aAlfa;
     aAlfa  = aPrefijo + nCarpeta1 + "," + nCarpeta2 + ":" + aAlfa;  |QBF aAlfa;

     |SI #1#8 = "S";
         aAlfa = aAlfa + "{{" + (("000" + #2#0) % -103);
         aAlfa = aAlfa + (("000" + #3#1) % -103);
         aAlfa = aAlfa + (("000" + #4#2) % -103);
         aAlfa = aAlfa + (("000" + #602#3) % -103) + "}}";
     |SINO;
         aAlfa = aAlfa + "{{" + (("000" + #2#0) % -103) + "001001";
         aAlfa = aAlfa + (("000" + #602#3) % -103) + "}}";
     |FINSI;

     |HAZ CargaArbol;

     nGrupo    = #604#0;
     nSubGrupo = #604#1;
     nTipo     = #604#2;
|FPRC;

|DEFBUCLE flowm004_2;
     #604#2;
     ;
     aUsuario, 000, 000, 000, 000;
     aUsuario, 999, 999, 999, 999;
     ;
     NULL, flowm004_2;
|FIN;

|PROCESO dsarm005_conta;
     nConta = nConta + 1;

     |DDEFECTO #flowm015;
     #flowm015#0 = aUsuario;
     #flowm015#1 = nGrupo;
     #flowm015#2 = nSubGrupo;
     #flowm015#3 = nTipo;
     #flowm015#4 = 000;
     #flowm015#5 = #dsarm005#0;
     |LEE 101#flowm015.=;
     |SI FSalida ! 0; |GRABA 020#flowm015.b; |FINSI;
     #flowm015#6 = #dsarm005#4;
     #flowm015#7 = #dsarm005#5;
     #flowm015#10 = #dsarm005#6;
     #flowm015#11 = #dsarm005#10;
     #flowm015#12 = #dsarm005#38;
     #flowm015#13 = #dsarm005#23;
     #flowm015#14 = #dsarm005#24;
     #flowm015#15 = #dsarm005#25;
     #flowm015#16 = #dsarm005#26;
     #flowm015#17 = #dsarm005#27;
     #flowm015#18 = #dsarm005#28;
     |GRABA 020#flowm015.a;
     |LIBERA #flowm015;
|FPRC;

|DEFBUCLE dsarm005_conta;
 #dsarm005#2;
 ;
 nGrupo, nSubGrupo, nTipo, 000000001;
 nGrupo, nSubGrupo, nTipo, 999999999;
 ;
 NULL, dsarm005_conta;
|FIN;

|PROCESO flowm015_borra;
     |BORRA 020#flowm015.a;
|FPRC;

|DEFBUCLE flowm015_borra;
 #flowm015#1;
 ;
 aUsuario, nGrupo, nSubGrupo, nTipo, 000, 000000001;
 aUsuario, nGrupo, nSubGrupo, nTipo, 000, 999999999;
 be;
 NULL, flowm015_borra;
|FIN;

|PROCESO NumDocEnCarpeta;
     |BUCLE flowm015_borra;
     |BUCLE dsarm005_conta;
|FPRC;

|PROCESO flowm014_2;
     #2#0 = #614#0;
     |LEE 000#2=;
     |SI FSalida ! 0;  |DDEFECTO  #2;  |FINSI;

     |SI #1#8 = "S";
         #3#0 = #614#0;
         #3#1 = #614#1;
         |LEE 000#3=;
         |SI FSalida ! 0;  |DDEFECTO  #3;  |FINSI;

         #4#0 = #614#0;
         #4#1 = #614#1;
         #4#2 = #614#2;
         |LEE 000#4=;
         |SI FSalida ! 0;  |DDEFECTO  #4;  |FINSI;
     |FINSI;

     |SI nGrupo ! #614#0;  |O nSubGrupo ! #614#1;  |O nTipo ! #614#2;
         nGrupo    = #614#0;
         nSubGrupo = #614#1;
         nTipo     = #614#2;

         nCarpeta1 = nCarpeta1 + 1;
         nCarpeta2 = 0;
         nConta    = 0;

         |HAZ NumDocEnCarpeta;

         |SI #1#8 = "S";
             aAlfa = "(" + nConta  + ") ";
             aAlfa = aAlfa + #2#1;  |QBF aAlfa;
             aAlfa = aAlfa + " / " + #3#2;  |QBF aAlfa;
             aAlfa = aAlfa + " / " + #4#3;  |QBF aAlfa;
             aAlfa = aPrefijo + nCarpeta1 + ":" + aAlfa;  |QBF aAlfa;
             aAlfa = aAlfa + "{{DEP" + (("000" + #2#0) % -103);
             aAlfa = aAlfa + (("000" + #3#1) % -103);
             aAlfa = aAlfa + (("000" + #4#2) % -103) + "}}";
         |SINO;
             aAlfa = "(" + nConta  + ") ";
             aAlfa = aAlfa + #2#1;  |QBF aAlfa;
             aAlfa = aPrefijo + nCarpeta1 + ":" + aAlfa;  |QBF aAlfa;
             aAlfa = aAlfa + "{{DEP" + (("000" + #2#0) % -103) + "001001}}";
         |FINSI;

         |HAZ CargaArbol;
     |FINSI;

     nGrupo    = #614#0;
     nSubGrupo = #614#1;
     nTipo     = #614#2;
|FPRC;

|DEFBUCLE flowm014_2;
     #614#2;
     ;
     aUsuario, 000, 000, 000, 000;
     aUsuario, 999, 999, 999, 999;
     ;
     NULL, flowm014_2;
|FIN;

|PROCESO RefrescaUsu;
     |CONTROL_SIMPLE 0, "LABEL,{{9}}Procesando trabajo ...", 1315, 1680, NULL;
     nBotonLabel = FSalida;

     |SI nTree ! -1;
         |DESTRUYECONTROL nTree;      nTree    = -1;
         |DESTRUYECONTROL nGrid605;   nGrid605 = -1;
         |DESTRUYECONTROL nGrid615;   nGrid615 = -1;

         |ESTADO_CONTROL nBoton1, "HIDE";
         |ESTADO_CONTROL nBoton2, "HIDE";
         |SI nConta = 0;
              |ESTADO_CONTROL nBoton3Cero, "HIDE";
         |SINO;
              |ESTADO_CONTROL nBoton3, "HIDE";
         |FINSI;
         |ESTADO_CONTROL nBoton4, "HIDE";
         |ESTADO_CONTROL nBoton5, "HIDE";
         |ESTADO_CONTROL nBoton6, "HIDE";
         |ESTADO_CONTROL nBoton7, "HIDE";
         |ESTADO_CONTROL nBoton8, "HIDE";
         |ESTADO_CONTROL nBoton10, "HIDE";
     |FINSI;

     |DBASE aBase;  |QBF aBase;
     aAlfa = aBase + "tmp";          |MKDIR aAlfa;

     eaRutaOrigen  = aBase + "tmp/";
     |SI #1#7 = "N";
          |HAZ DimeUnidad;
          eaRutaDestino = eaUnidad + ":\documentos\dsarchi\";
     |SINO;
          |HAZ LeeUnidadBasico;
          eaRutaDestino = eaUnidadBasico + "\documentos\dsarchi\";
     |FINSI;

     eaFicheroTxt  = "flowz00101" + Usuario + ".txt";
     eaFicheroTgz  = "flowz00101" + Usuario + ".tgz";
     eaFicheroTar  = "flowz00101" + Usuario + ".tar";

     eaFicheroTxt  = "flowz00101" + Usuario + ".txt";
     aAlfa         = eaRutaDestino + eaFicheroTxt;
     |RFBORRA aAlfa;

     nCarpeta1 = 0;
     nCarpeta2 = 0;

     aAbre = eaRutaOrigen + eaFicheroTxt;

     sT_nID   = nTree;
     sT_nOper = 0;

     |XABRE "WB", aAbre, nHandle;

     nGrupo    = 0;
     nSubGrupo = 0;
     nTipo     = 0;

     |ABRE #2;
     |ABRE #3;
     |ABRE #4;
     |ABRE #602;
     ||Aqui se crea la estructura del grid.

     aAlfa = "1:Dep¢sitos {{DEP}}";
     |HAZ CargaArbol;
     aPrefijo = "1,";
     |BUCLE flowm014_2;

     nCarpeta1 = 0;
     nCarpeta2 = 0;
     aAlfa = "2:Situaciones";
     |HAZ CargaArbol;
     aPrefijo = "2,";
     |BUCLE flowm004_2;

     |CIERRA #2;
     |CIERRA #3;
     |CIERRA #4;
     |CIERRA #602;

     |XCIERRA nHandle;

     |HAZ TraeTxtComprimido;

     |FIN_CONTROL_WINDOWS nBotonLabel;

     eaFicheroTxt  = "flowz00101" + Usuario + ".txt";
     aAlfa         = eaRutaDestino + eaFicheroTxt;

     aUsuario = Usuario % 810;
     aAlfa = "TREECTRL," + aUsuario + "{{" + aAlfa + "}}";

     |CONTROL_SIMPLE nPanta, aAlfa, 1102, 2060, EventoTree;
     nTree = FSalida;

     sT_aData = "1:";

     |SI aGuarda ! "";
         sT_nID   = nTree;
         sT_nOper = 3;
         sT_aData = "[" + aGuarda;
         |ESPECIFICA "COMMANDCONTROL", sTree;
         sT_aData = ":" + FSalida;
     |FINSI;

     sT_nID   = nTree;
     sT_nOper = 2;
     |ESPECIFICA "COMMANDCONTROL", sTree;

     |PULSATECLA;

     |FOCOTECLADO nTree;

     |SI nBoton1 ! -1;
         |ESTADO_CONTROL nBoton1, "SHOW";
         |ESTADO_CONTROL nBoton2, "SHOW";
         |SI nConta = 0;
              |ESTADO_CONTROL nBoton3Cero, "SHOW";
         |SINO;
              |ESTADO_CONTROL nBoton3, "SHOW";
         |FINSI;
         |ESTADO_CONTROL nBoton4, "SHOW";
         |ESTADO_CONTROL nBoton5, "SHOW";
         |ESTADO_CONTROL nBoton6, "SHOW";
         |ESTADO_CONTROL nBoton7, "SHOW";
         |ESTADO_CONTROL nBoton8, "SHOW";
         |ESTADO_CONTROL nBoton10, "SHOW";
     |FINSI;
|FPRC;

|PROCESO flowm015_4;
     #flowm020#0 = #615#0;
     |LEE 000#flowm020.=;
     |SI FSalida ! 0;  |DDEFECTO #flowm020;  |FINSI;

     aAlfa = #flowm020#3;  |QBF aAlfa;
     |SI aAlfa ! aUsuario;  |ACABA;  |FINSI;

     |SI fFechaHoy < #flowm020#1;  |O  fFechaHoy > #flowm020#2;
         |ACABA;
     |FINSI;

     #615#19 = #flowm020#3;
     |GRABA 020#615a;
     |LIBERA #615;
|FPRC;

|DEFBUCLE flowm015_4;
     #615#4;
     ;
     #614#0, #614#1, #614#2, 0, 000000000, "          ";
     #614#0, #614#1, #614#2, 0, 999999999, "zzzzzzzzzz";
     be;
     NULL, flowm015_4;
|FIN;

|PROCESO flowm014_1;
     #flowm020#0 = #614#4;
     |LEE 000#flowm020.=;
     |SI FSalida ! 0;  |DDEFECTO #flowm020;  |FINSI;

     aAlfa = #flowm020#3;  |QBF aAlfa;
     |SI aAlfa ! aUsuario;  |ACABA;  |FINSI;

     |SI fFechaHoy < #flowm020#1;  |O  fFechaHoy > #flowm020#2;
         |ACABA;
     |FINSI;

     |SI nGrupo = #614#0;  |Y nSubGrupo = #614#1;  |Y nTipo = #614#2;
      |Y nSituacion = #614#3;
         |ACABA;
     |FINSI;

     #2#0 = #614#0;
     |LEE 000#2=;
     |SI FSalida ! 0;  |DDEFECTO  #2;  |FINSI;

     |SI #1#8 = "S";
         #3#0 = #614#0;
         #3#1 = #614#1;
         |LEE 000#3=;
         |SI FSalida ! 0;  |DDEFECTO  #3;  |FINSI;

         #4#0 = #614#0;
         #4#1 = #614#1;
         #4#2 = #614#2;
         |LEE 000#4=;
         |SI FSalida ! 0;  |DDEFECTO  #4;  |FINSI;
     |FINSI;

     |SI nGrupo ! #614#0;  |O nSubGrupo ! #614#1;  |O nTipo ! #614#2;
         nGrupo    = #614#0;
         nSubGrupo = #614#1;
         nTipo     = #614#2;

         nCarpeta1 = nCarpeta1 + 1;
         nCarpeta2 = 0;
         nConta    = 0;

         |HAZ NumDocEnCarpeta;

         |SI #1#8 = "S";
             aAlfa = "(" + nConta  + ") ";
             aAlfa = aAlfa + #2#1;  |QBF aAlfa;
             aAlfa = aAlfa + " / " + #3#2;  |QBF aAlfa;
             aAlfa = aAlfa + " / " + #4#3;  |QBF aAlfa;
             aAlfa = aPrefijo + nCarpeta1 + ":" + aAlfa;  |QBF aAlfa;
             aAlfa = aAlfa + "{{DEP" + (("000" + #2#0) % -103);
             aAlfa = aAlfa + (("000" + #3#1) % -103);
             aAlfa = aAlfa + (("000" + #4#2) % -103) + "}}";
         |SINO;
             aAlfa = "(" + nConta  + ") ";
             aAlfa = aAlfa + #2#1;  |QBF aAlfa;
             aAlfa = aPrefijo + nCarpeta1 + ":" + aAlfa;  |QBF aAlfa;
             aAlfa = aAlfa + "{{DEP" + (("000" + #2#0) % -103) + "001001}}";
         |FINSI;

         |HAZ CargaArbol;
     |FINSI;

     |BUCLE flowm015_4;

     nGrupo     = #614#0;
     nSubGrupo  = #614#1;
     nTipo      = #614#2;
     nSituacion = #614#3;
|FPRC;

|DEFBUCLE flowm014_1;
     #614#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, flowm014_1;
|FIN;

|PROCESO flowm005_4;
     #flowm020#0 = #605#0;
     |LEE 000#flowm020.=;
     |SI FSalida ! 0;  |DDEFECTO #flowm020;  |FINSI;

     aAlfa = #flowm020#3;  |QBF aAlfa;
     |SI aAlfa ! aUsuario;  |ACABA;  |FINSI;

     |SI fFechaHoy < #flowm020#1;  |O  fFechaHoy > #flowm020#2;
         |ACABA;
     |FINSI;

     #605#21 = #flowm020#3;
     |GRABA 020#605a;
     |LIBERA #605;
|FPRC;

|DEFBUCLE flowm005_4;
     #605#4;
     ;
     #604#0, #604#1, #604#2, #604#3, 000000000, "";
     #604#0, #604#1, #604#2, #604#3, 999999999, "zzzzzzzzzz";
     be;
     NULL, flowm005_4;
|FIN;

|PROCESO flowm004_1;
     #flowm020#0 = #604#4;
     |LEE 000#flowm020.=;
     |SI FSalida ! 0;  |DDEFECTO #flowm020;  |FINSI;

     aAlfa = #flowm020#3;  |QBF aAlfa;
     |SI aAlfa ! aUsuario;  |ACABA;  |FINSI;

     |SI fFechaHoy < #flowm020#1;  |O  fFechaHoy > #flowm020#2;
         |ACABA;
     |FINSI;

     |SI nGrupo = #604#0;  |Y nSubGrupo = #604#1;  |Y nTipo = #604#2;
      |Y nSituacion = #604#3;
         |ACABA;
     |FINSI;

     #2#0 = #604#0;
     |LEE 000#2=;
     |SI FSalida ! 0;  |DDEFECTO  #2;  |FINSI;

     |SI #1#8 = "S";
         #3#0 = #604#0;
         #3#1 = #604#1;
         |LEE 000#3=;
         |SI FSalida ! 0;  |DDEFECTO  #3;  |FINSI;

         #4#0 = #604#0;
         #4#1 = #604#1;
         #4#2 = #604#2;
         |LEE 000#4=;
         |SI FSalida ! 0;  |DDEFECTO  #4;  |FINSI;
     |FINSI;

     |SI nGrupo ! #604#0;  |O nSubGrupo ! #604#1;  |O nTipo ! #604#2;
         nCarpeta1 = nCarpeta1 + 1;
         nCarpeta2 = 0;
         nConta    = 0;

         |BUCLE flowm005T;

         |SI #1#8 = "S";
             aAlfa = "(" + nConta  + ") ";
             aAlfa = aAlfa + #2#1;  |QBF aAlfa;
             aAlfa = aAlfa + " / " + #3#2;  |QBF aAlfa;
             aAlfa = aAlfa + " / " + #4#3;  |QBF aAlfa;
             aAlfa = aPrefijo + nCarpeta1 + ":" + aAlfa;  |QBF aAlfa;
             aAlfa = aAlfa + "{{" + (("000" + #2#0) % -103);
             aAlfa = aAlfa + (("000" + #3#1) % -103);
             aAlfa = aAlfa + (("000" + #4#2) % -103) + "}}";
         |SINO;
             aAlfa = "(" + nConta  + ") ";
             aAlfa = aAlfa + #2#1;  |QBF aAlfa;
             aAlfa = aPrefijo + nCarpeta1 + ":" + aAlfa;  |QBF aAlfa;
             aAlfa = aAlfa + "{{" + (("000" + #2#0) % -103) + "001001}}";
         |FINSI;

         |HAZ CargaArbol;
     |FINSI;

     #602#0 = #604#0;
     #602#1 = #604#1;
     #602#2 = #604#2;
     #602#3 = #604#3;
     |LEE 000#602=;
     |SI FSalida ! 0;  |DDEFECTO #602;  |FINSI;

     nCarpeta2 = nCarpeta2 + 1;
     nConta    = 0;
     |BUCLE flowm005S;
     aAlfa  = "(" + nConta  + ") ";
     aAlfa  = aAlfa + " " + (("000" + #602#3) % -103) + " - " + #602#4;  |QBF aAlfa;
     aAlfa  = aPrefijo + nCarpeta1 + "," + nCarpeta2 + ":" + aAlfa;  |QBF aAlfa;

     |SI #1#8 = "S";
         aAlfa = aAlfa + "{{" + (("000" + #2#0) % -103);
         aAlfa = aAlfa + (("000" + #3#1) % -103);
         aAlfa = aAlfa + (("000" + #4#2) % -103);
         aAlfa = aAlfa + (("000" + #602#3) % -103) + "}}";
     |SINO;
         aAlfa = aAlfa + "{{" + (("000" + #2#0) % -103) + "001001";
         aAlfa = aAlfa + (("000" + #602#3) % -103) + "}}";
     |FINSI;

     |HAZ CargaArbol;

     |BUCLE flowm005_4;

     nGrupo     = #604#0;
     nSubGrupo  = #604#1;
     nTipo      = #604#2;
     nSituacion = #604#3;
|FPRC;

|DEFBUCLE flowm004_1;
     #604#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, flowm004_1;
|FIN;

|PROCESO flowm005_3;
     #605#21 = "";
     |GRABA 020#605a;
     |LIBERA #605;
|FPRC;

|DEFBUCLE flowm005_3;
     #605#3;
     ;
     aUsuario, 000, 000, 000, 000, 000000000;
     aUsuario, 999, 999, 999, 999, 999999999;
     be;
     NULL, flowm005_3;
|FIN;

|PROCESO flowm015_3;
     #615#19 = "";
     |GRABA 020#615a;
     |LIBERA #615;
|FPRC;

|DEFBUCLE flowm015_3;
     #615#3;
     ;
     aUsuario, 000, 000, 000, 000, 000000000;
     aUsuario, 999, 999, 999, 999, 999999999;
     be;
     NULL, flowm015_3;
|FIN;

|PROCESO RefrescaAdm;
     |CONTROL_SIMPLE 0, "LABEL,{{9}}Procesando trabajo ...", 1315, 1680, NULL;
     nBotonLabel = FSalida;

     |SI nTree ! -1;
         |DESTRUYECONTROL nTree;      nTree    = -1;
         |DESTRUYECONTROL nGrid605;   nGrid605 = -1;
         |DESTRUYECONTROL nGrid615;   nGrid615 = -1;

         |ESTADO_CONTROL nBoton1, "HIDE";
         |ESTADO_CONTROL nBoton2, "HIDE";
         |SI nConta = 0;
              |ESTADO_CONTROL nBoton3Cero, "HIDE";
         |SINO;
              |ESTADO_CONTROL nBoton3, "HIDE";
         |FINSI;
         |ESTADO_CONTROL nBoton4, "HIDE";
         |ESTADO_CONTROL nBoton5, "HIDE";
         |ESTADO_CONTROL nBoton6, "HIDE";
         |ESTADO_CONTROL nBoton7, "HIDE";
         |ESTADO_CONTROL nBoton8, "HIDE";
         |ESTADO_CONTROL nBoton10, "HIDE";
     |FINSI;

     |DBASE aBase;  |QBF aBase;
     aAlfa = aBase + "tmp";          |MKDIR aAlfa;

     eaRutaOrigen  = aBase + "tmp/";
     |SI #1#7 = "N";
          |HAZ DimeUnidad;
          eaRutaDestino = eaUnidad + ":\documentos\dsarchi\";
     |SINO;
          |HAZ LeeUnidadBasico;
          eaRutaDestino = eaUnidadBasico + "\documentos\dsarchi\";
     |FINSI;

     eaFicheroTxt  = "flowz00101" + Usuario + ".txt";
     eaFicheroTgz  = "flowz00101" + Usuario + ".tgz";
     eaFicheroTar  = "flowz00101" + Usuario + ".tar";

     eaFicheroTxt  = "flowz00101" + Usuario + ".txt";
     aAlfa         = eaRutaDestino + eaFicheroTxt;
     |RFBORRA aAlfa;

     nCarpeta1 = 0;
     nCarpeta2 = 0;

     aAbre = eaRutaOrigen + eaFicheroTxt;

     sT_nID   = nTree;
     sT_nOper = 0;

     |XABRE "WB", aAbre, nHandle;

     nGrupo     = 0;
     nSubGrupo  = 0;
     nTipo      = 0;
     nSituacion = 0;

     |ABRE #2;
     |ABRE #3;
     |ABRE #4;
     |ABRE #602;

     |BUCLE flowm015_3;
     |BUCLE flowm005_3;

     aAlfa = "1:Dep¢sitos {{DEP}}";
     |HAZ CargaArbol;
     aPrefijo = "1,";
     |ABRE #flowm020;
     |BUCLE flowm014_1;

     nCarpeta1 = 0;
     nCarpeta2 = 0;
     aAlfa = "2:Situaciones";
     |HAZ CargaArbol;
     aPrefijo = "2,";
     |BUCLE flowm004_1;
     |CIERRA #flowm020;

     |CIERRA #2;
     |CIERRA #3;
     |CIERRA #4;
     |CIERRA #602;

     |XCIERRA nHandle;

     |HAZ TraeTxtComprimido;

     |FIN_CONTROL_WINDOWS nBotonLabel;

     eaFicheroTxt  = "flowz00101" + Usuario + ".txt";
     aAlfa         = eaRutaDestino + eaFicheroTxt;

     aAlfa = "TREECTRL,Administrador {{" + aAlfa + "}}";

     |CONTROL_SIMPLE nPanta, aAlfa, 1102, 2060, EventoTree;
     nTree = FSalida;

     sT_aData = "1:";

     |SI aGuarda ! "";
         sT_nID   = nTree;
         sT_nOper = 3;
         sT_aData = "[" + aGuarda;
         |ESPECIFICA "COMMANDCONTROL", sTree;
         sT_aData = ":" + FSalida;
     |FINSI;

     sT_nID   = nTree;
     sT_nOper = 2;
     |ESPECIFICA "COMMANDCONTROL", sTree;

     |PULSATECLA;

     |FOCOTECLADO nTree;

     |SI nBoton1 ! -1;
         |ESTADO_CONTROL nBoton1, "SHOW";
         |ESTADO_CONTROL nBoton2, "SHOW";
         |SI nConta = 0;
              |ESTADO_CONTROL nBoton3Cero, "SHOW";
         |SINO;
              |ESTADO_CONTROL nBoton3, "SHOW";
         |FINSI;
         |ESTADO_CONTROL nBoton4, "SHOW";
         |ESTADO_CONTROL nBoton5, "SHOW";
         |ESTADO_CONTROL nBoton6, "SHOW";
         |ESTADO_CONTROL nBoton7, "SHOW";
         |ESTADO_CONTROL nBoton8, "SHOW";
         |ESTADO_CONTROL nBoton10, "SHOW";
     |FINSI;
|FPRC;

|PROCESO Refresca;
     |SI aTipoTree = "USU";  |HAZ RefrescaUsu;  |FINSI;
     |SI aTipoTree = "ADM";  |HAZ RefrescaAdm;  |FINSI;
|FPRC;

|PROCESO Boton2;
     |SI #dsarz010#7 = "N";
          aMensaje = "0000No tiene permisos para ejecutar este boton";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     |SI nSwDeposito = 0;
          |LEE 000#605=;
     |SINO;
          |LEE 000#615=;
     |FINSI;
     |SI FSalida ! 0;
         |HAZ Refresca;
         |ACABA;
     |FINSI;

     |SI nSwDeposito = 0;
          enDocumento = #605#5;
     |SINO;
          enDocumento = #615#5;
     |FINSI;

     |VENTANA 0501, 2999, -1, 16, "Datos Documentos";
     nVentm5 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentm5;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |SUB_EJECUTA_NP "dsarw006";

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentm5;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentm5;
|FPRC;

|PROCESO Boton3;
     |SI nSwDeposito = 0;
          |LEE 000#605=;
     |SINO;
          |LEE 000#615=;
     |FINSI;
     |SI FSalida ! 0;
         |HAZ Refresca;
         |ACABA;
     |FINSI;

     |SI nSwDeposito = 0;
          enDocumento = #605#5;
     |SINO;
          enDocumento = #615#5;
     |FINSI;
     |SUB_EJECUTA_NP "flowz002";

     |HAZ ActualizaAnotacion;
|FPRC;

|PROCESO flowm005B;
     |BORRA 020#605a;
     |LIBERA #605;
|FPRC;

|DEFBUCLE flowm005B;
     #605#1;
     8;
     "          ", nGrupo, nSubGrupo, nTipo, nSituacion, nDocu, aDTipo;
     "zzzzzzzzzz", nGrupo, nSubGrupo, nTipo, nSituacion, nDocu, aHTipo;
     be;
     NULL, flowm005B;
|FIN;

|PROCESO ApropiaUnDoc;
     #606#0 = #605#5;
     #606#1 = 99999;
     |LEE 000#606];
     |SI FSalida = 0;
         |LEE 000#606a;
     |SINO;
         |LEE 000#606u;
     |FINSI;

     nLinea = 1;
     |SI FSalida = 0;  |Y #606#0 = #605#5;
         nLinea = #606#1;
     |FINSI;

     #606#0 = #605#5;
     #606#1 = nLinea;
     |LEE 101#606=;
     |SI FSalida = 0;
         #606#5 = aUsuario;
         |GRABA 020#606a;
         |LIBERA #606;
     |FINSI;

     |HORA aHora;

     |DDEFECTO #606;
     #606#0 = #605#5;
     #606#1 = nLinea + 1;
     #606#2 = #605#4;
     #606#3 = fFechaHoy;
     #606#4 = aHora;
     #606#5 = aUsuario;
     #606#6 = "SITUACION NUEVA";

     enNumRegFlow = #flowm006#0;
     enSituFlow = #flowm006#2;
     |HAZ DimeDesFlow;
     #flowm006#7 = eaDesSituFlow;

     |GRABA 020#606n;
     |LIBERA #606;

     #605#6 = fFechaHoy;
     #605#7 = aHora;
     #605#8 = "E";
     #605#9 = "0,0,0;0,255,0";
     |GRABA 020#605a;
     |LIBERA #605;

     nGrupo     = #605#1;
     nSubGrupo  = #605#2;
     nTipo      = #605#3;
     nSituacion = #605#4;
     nDocu      = #605#5;
     aDTipo     = "C";
     aHTipo     = "C";
     |BUCLE flowm005B;
|FPRC;
|PROCESO flowm005_apropia;
     |DDEFECTO #flowm005;
     #flowm005#0 = #referen@#0;
     #flowm005#1 = #referen@#1;
     #flowm005#2 = #referen@#2;
     #flowm005#3 = #referen@#3;
     #flowm005#4 = #referen@#4;
     #flowm005#5 = #referen@#5;
     |LEE 000#flowm005.=;

     |SI #flowm005#20 = "*";
          |SI #flowm005#8 = "C";
               |LEE 101#flowm005.=;
               |SI FSalida = 0;
                    |HAZ ApropiaUnDoc;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE flowm005_apropia;
 #referen@#1006;
 ;
 aEstoyUsu, nEstoyGru, nEstoySGr, nEstoyTip, nEstoySit, 000000001;
 aEstoyUsu, nEstoyGru, nEstoySGr, nEstoyTip, nEstoySit, 999999999;
 ;
 NULL, flowm005_apropia;
|FIN;

|PROCESO Boton4;
     |SELECT #1#605;
     |LEE 000#605=;
     |SI FSalida ! 0;
         |SI aTipoTree = "ADM";  |SELECT #3#605;  |FINSI;
         |HAZ Refresca;
         |ACABA;
     |FINSI;

     aEstoyUsu = #605#0;
     nEstoyGru = #605#1;
     nEstoySGr = #605#2;
     nEstoyTip = #605#3;
     nEstoySit = #605#4;
     nEstoyDoc = #605#5;

     |SI #605#20 = "*"; |Y #605#8 = "C";
          nSwEstoyMarca = 1;
     |SINO;
          nSwEstoyMarca = 0;
     |FINSI;

     nMarcas = 0;
     nMarcasAprop = 0;
     |HAZ DimeSiMarcados;

     |SI nMarcasAprop = 0;
          aAlfa = "0000NSeguro que quiere apropiarse el documento " + nEstoyDoc;
     |SINO;
          |SI nMarcasAprop = 1;
                nMarcasAprop = 0;
                |SI nSwEstoyMarca = 1;       ||Esto lo hago para distinguir si estoy en el documento marcado
                                             ||o no lo estoy, pero solo hay uno marcado.
                     aAlfa = "0000NSeguro que quiere apropiarse el documento " + nEstoyDoc;
                |SINO;
                     nEstoyDoc = nDocMarcadoAprop;
                     aAlfa = "0000NSeguro que quiere apropiarse el documento " + nDocMarcado;
                |FINSI;
          |SINO;
                aAlfa = "0000NSeguro que quiere apropiarse " + nMarcasAprop + " documentos de los " + nMarcas + " seleccionados";
          |FINSI;
     |FINSI;
     |CONFI aAlfa;
     |SI FSalida ! 0;
         |SI aTipoTree = "ADM";  |SELECT #3#605;  |FINSI;

         |ACABA;
     |FINSI;

     |SI nMarcasAprop = 0;
          #605#0 = aEstoyUsu;
          #605#1 = nEstoyGru;
          #605#2 = nEstoySGr;
          #605#3 = nEstoyTip;
          #605#4 = nEstoySit;
          #605#5 = nEstoyDoc;
          |LEE 101#605=;

          |HAZ ApropiaUnDoc;
     |SINO;
          |DBASE aBase;
          |QBF aBase;
          aDef = aBase + "/def/flowm005";
          |CARGA_DEF aDef, referen@;
          |SI FSalida ! 0;
               aMensaje = "0000Problemas CARGADEF" + aDef;
               |MENAV aMensaje;
               nResponde = 0;
               |ERROR;
               |ACABA;
          |FINSI;
          ||TODO CCC.  Tengo que usar un cargadef para leer el flowm005
          ||pq. dentro tengo otro bucle. :(
          |BUCLE flowm005_apropia;

          |DESCARGA_DEF #referen@;
     |FINSI;

     |SI aTipoTree = "ADM";  |SELECT #3#605;  |FINSI;
     |HAZ Refresca;
|FPRC;

|PROCESO Baja603;
     #603#0 = #602#0;
     #603#1 = #602#1;
     #603#2 = #602#2;
     #603#3 = #602#3;
     #603#4 = 001;
|FPRC;

|PROCESO Alta603;
     #603#0 = #602#0;
     #603#1 = #602#1;
     #603#2 = #602#2;
     #603#3 = #602#3;
     #603#4 = 999;
|FPRC;

|PROCESO Baja604;
     #604#0 = #602#0;
     #604#1 = #602#1;
     #604#2 = #602#2;
     #604#3 = #602#3;
     #604#4 = "";
|FPRC;

|PROCESO Alta604;
     #604#0 = #602#0;
     #604#1 = #602#1;
     #604#2 = #602#2;
     #604#3 = #602#3;
     #604#4 = "zzzzzzzzzz";
|FPRC;

|PROCESO Evento603;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#603=;
     |FINSI;

     |SI FSalida = 4;
         aAlfa = "0000SHa contestado: " + #603#5;  |QBF aAlfa;
         |CONFI aAlfa;
         |SI FSalida = 0;
             |SI nMarcas = 0;
                  enSwCamposObligados = 0;
                  eaPermisoModTipo = "S";
                  enGrupoCO = #603#0;
                  enSubGrupoCO = #603#1;
                  enTipoCO = #603#2;
                  enSituCO = #603#6;
                  enNumDocCO = #605#5;
                  eaTextoCO = "";
                  enNumLibreCO = 0;
                  enPosicionCO = 0;
                  |HAZ MiraCamposObliWF;
                  |SI enSwCamposObligados = 1;
                       |SI #dsarz010#12 = "N";
                            aMensaje = "0000Existen campos obligatorios para la nueva situaci¢n. Pero Vd. no tiene permiso para modificar el documento";
                            |MENAV aMensaje;
                            aMensaje = "0000Obligatorios: " + eaTextoCO;
                            |MENAV aMensaje;
                       |SINO;
                            |SI eaPermisoModTipo = "N";
                                  aMensaje = "0000Existen campos obligatorios para la nueva situaci¢n. Pero el Tipo Documento no permite su modificaci¢n";
                                  |MENAV aMensaje;
                                  aMensaje = "0000Obligatorios: " + eaTextoCO;
                                  |MENAV aMensaje;
                            |SINO;
                                  |SI eaPermisoModTipo = "P";
                                       |HAZ PidePassword;
                                       |SI enPassword = 1;  |ACABA;  |FINSI;
                                  |FINSI;

                                  aMensaje = "0000Introduzca campos obligatorios: " + eaTextoCO;
                                  ||aMensaje = aMensaje + " Num.Campo: " + enPosicionCO;
                                  |MENAV aMensaje;

                                  enDocumento = #605#5;

                                  |VENTANA 0501, 2999, -1, 16, "Datos Documentos";
                                  nVentm5 = FSalida;

                                  aVent1 = -1;
                                  aVent2 = -1;
                                  aVent3 = 0;
                                  aVent4 = nVentm5;
                                  aVent5 = "MODAL";
                                  |ESPECIFICA "ESTADO_VENTANA", aVent;

                                  enModoModiw006 = 1;
                                  enPosicionateCampo = enNumLibreCO;
                                  |SUB_EJECUTA_NP "dsarw006";
                                  enPosicionateCampo = 0;
                                  enModoModiw006 = 0;

                                  aVent1 = -1;
                                  aVent2 = -1;
                                  aVent3 = 0;
                                  aVent4 = nVentm5;
                                  aVent5 = "MODELESS";
                                  |ESPECIFICA "ESTADO_VENTANA", aVent;

                                  |FINVENTANA nVentm5;

                                  aVent1 = -1;
                                  aVent2 = -1;
                                  aVent3 = 0;
                                  aVent4 = nVent;
                                  aVent5 = "MODAL";
                                  |ESPECIFICA "ESTADO_VENTANA", aVent;

                                  enSwCamposObligados = 0;
                                  eaPermisoModTipo = "S";
                                  enGrupoCO = #603#0;
                                  enSubGrupoCO = #603#1;
                                  enTipoCO = #603#2;
                                  enSituCO = #603#6;
                                  enNumDocCO = #605#5;
                                  eaTextoCO = "";
                                  |HAZ MiraCamposObliWF;
                                  |SI enSwCamposObligados = 1;
                                       aMensaje = "0000Proceso cancelado. Existen campos obligatorios vacios.";
                                       |MENAV aMensaje;
                                       aMensaje = "0000Obligatorios: " + eaTextoCO;
                                       |MENAV aMensaje;
                                  |SINO;
                                       nResponde = #603#4;
                                       |PTEC 806;
                                  |FINSI;
                            |FINSI;
                       |FINSI;
                  |SINO;
                       nResponde = #603#4;
                       |PTEC 806;
                  |FINSI;
             |SINO;
                   nResponde = #603#4;
                   |PTEC 806;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO flowm004R;
     |SI nPasada = 0;
         nUsuarios  = nUsuarios + 1;
         |ACABA;
     |FINSI;

     |DDEFECTO #605;

     #605#0  = #604#4;
     #605#1  = #604#0;
     #605#2  = #604#1;
     #605#3  = #604#2;
     #605#4  = #604#3;
     #605#5  = nDocu;
     #605#6  = fFechaHoy;
     #605#7  = aHora;
     #605#8  = "E";
     #605#9  = "0,0,0;0,255,0";

     #605#10 = aGuarda10;

/*
     #605#11 = aGuarda11;
     #605#12 = aGuarda12;
     #605#13 = aGuarda13;
     #605#14 = aGuarda14;
     #605#15 = aGuarda15;
     #605#16 = aGuarda16;
     #605#17 = aGuarda17;
     #605#18 = aGuarda18;
*/

     ||Creo que es mejor recalcular estos campos.

     |ABRE #dsarm005;
     #dsarm005#0 = #605#5;
     |LEE 101#dsarm005.=;
     |SI FSalida = 0;
          #flowm005#10  = #dsarm005#6;
          #flowm005#11  = #dsarm005#10;
          #flowm005#12  = #dsarm005#38;
          #flowm005#13  = #dsarm005#23;
          #flowm005#14  = #dsarm005#24;
          #flowm005#15  = #dsarm005#25;
          #flowm005#16  = #dsarm005#26;
          #flowm005#17  = #dsarm005#27;
          #flowm005#18  = #dsarm005#28;
     |FINSI;
     |CIERRA #dsarm005;

     |SI nUsuarios > 1;
         #605#8  = "C";
         #605#9  = "0,0,0;255,255,0";
     |FINSI;

     #605#19 = fFechaCaducidad;

     |GRABA 020#605n;
     |LIBERA #605;
|FPRC;

|DEFBUCLE flowm004R;
     #604#1;
     ;
     #602#0, #602#1, #602#2, #603#6, aDUsu;
     #602#0, #602#1, #602#2, #603#6, aHUsu;
     ;
     NULL, flowm004R;
|FIN;

|PROCESO CalculaFecha;
     nGrupoOri = #602#0;
     nSubGrupoOri = #602#1;
     nTipoOri = #602#2;
     nSituOri = #602#3;
     #602#3 = #603#6;
     |LEE 000#602.=;
     aTipoCad = #602#10;
     nNumCad = #602#11;

     |DDEFECTO #602;
     #602#0 = nGrupoOri;
     #602#1 = nSubGrupoOri;
     #602#2 = nTipoOri;
     #602#3 = nSituOri;
     |LEE 000#602.=;

     |SI aTipoCad = "H";
          fFechaCaducidad = ~;
     |FINSI;

     |SI #602#10 = "D";
          fSistema = ~;
          nSistema = fSistema;
          nSistema = nSistema + nNumCad;
          fFechaCaducidad = nSistema;
     |FINSI;

     |SI #602#10 = "M";
          fSistema = ~;
          nSistema = fSistema;
          nSistema = nSistema + (nNumCad * 30);
          fFechaCaducidad = nSistema;
     |FINSI;
|FPRC;

|PROCESO flowm005_resuelve;
     |DDEFECTO #flowm005;
     #flowm005#0 = #referen@#0;
     #flowm005#1 = #referen@#1;
     #flowm005#2 = #referen@#2;
     #flowm005#3 = #referen@#3;
     #flowm005#4 = #referen@#4;
     #flowm005#5 = #referen@#5;
     |LEE 000#flowm005.=;

     |SI #flowm005#20 = "*";
          #606#0 = #605#5;
          #606#1 = 99999;
          |LEE 000#606];
          |SI FSalida = 0;
              |LEE 000#606a;
          |SINO;
              |LEE 000#606u;
          |FINSI;

          nLinea = 1;
          |SI FSalida = 0;  |Y #606#0 = #605#5;
              nLinea = #606#1;
          |FINSI;

          #606#0 = #605#5;
          #606#1 = nLinea;
          |LEE 101#606=;
          |SI FSalida = 0;
              #606#5 = aUsuario;
              |GRABA 020#606a;
              |LIBERA #606;
          |FINSI;

          |HORA aHora;

          |DDEFECTO #606;
          #606#0 = #605#5;
          #606#1 = nLinea + 1;
          #606#2 = #603#6;
          #606#3 = fFechaHoy;
          #606#4 = aHora;
          #606#5 = aUsuario;
          #606#6 = "SITUACION NUEVA";

          enNumRegFlow = #flowm006#0;
          enSituFlow = #flowm006#2;
          |HAZ DimeDesFlow;
          #flowm006#7 = eaDesSituFlow;

          |GRABA 020#606n;
          |LIBERA #606;

          nGrupo     = #605#1;
          nSubGrupo  = #605#2;
          nTipo      = #605#3;
          nSituacion = #605#4;
          nDocu      = #605#5;
          aDTipo     = " ";
          aHTipo     = "z";
          |BUCLE flowm005B;

          nUsuarios = 0;
          nPasada   = 0;  |BUCLE flowm004R;
          nPasada   = 1;  |BUCLE flowm004R;
     |FINSI;
|FPRC;

|DEFBUCLE flowm005_resuelve;
 #referen@#1006;
 ;
 aEstoyUsu, nEstoyGru, nEstoySGr, nEstoyTip, nEstoySit, 000000001;
 aEstoyUsu, nEstoyGru, nEstoySGr, nEstoyTip, nEstoySit, 999999999;
 ;
 NULL, flowm005_resuelve;
|FIN;


|PROCESO ResuelveMarcados;
     ||ARA23
     #603#0 = #602#0;
     #603#1 = #602#1;
     #603#2 = #602#2;
     #603#3 = #602#3;
     #603#4 = nResponde;
     |LEE 000#603=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     ||Situacion destino SIN campos obligatorios
     enSwCamposObligados = 0;
     enGrupoCO = #603#0;
     enSubGrupoCO = #603#1;
     enTipoCO = #603#2;
     enSituCO = #603#6;
     |HAZ MiraCamposObliWFSitu;
     |SI enSwCamposObligados = 1;
          aMensaje = "0000No es posible utilizar la seleccion multiple. Campos obligatorios situaci¢n destino";
          |MENAV aMensaje;
          nResponde = 0;
          |ACABA;
     |FINSI;

     ||Situacion destino SIN caducidad MANUAL
     aCadManual = #603#9;
     |QBF aCadManual;
     |SI aCadManual = "S";
          aMensaje = "0000No es posible utilizar la seleccion multiple. Caducidad manual en situaci¢n destino";
          |MENAV aMensaje;
          nResponde = 0;
          |ACABA;
     |FINSI;

     aDUsu      = "";
     aHUsu      = "zzzzzzzzzz";
     |SI #603#8 = "S";
         |MENAV "0000A continuaci¢n elija un usuario para la situaci¢n destino";

         |ABRE #604;
         |PARA;  |SI;  |HACIENDO;
              |CONSULTA_F_CLAVE #1#604, Baja604, Alta604;
              |SI FSalida = 0;
                 aDUsu = #604#4;
                 aHUsu = #604#4;
                 |SAL;
              |FINSI;
         |SIGUE;
         |CIERRA #604;
     |FINSI;

     |DBASE aBase;
     |QBF aBase;
     aDef = aBase + "/def/flowm005";
     |CARGA_DEF aDef, referen@;
     |SI FSalida ! 0;
          aMensaje = "0000Problemas CARGADEF" + aDef;
          |MENAV aMensaje;
          nResponde = 0;
          |ERROR;
          |ACABA;
     |FINSI;
     ||TODO CCC.  Tengo que usar un cargadef para leer el flowm005
     ||pq. dentro tengo otro bucle. :(
     |BUCLE flowm005_resuelve;

     |DESCARGA_DEF #referen@;

     ||ARA23.    Bucle con los marcados y los proceso.
|FPRC;

|PROCESO Resuelve;
     #603#0 = #602#0;
     #603#1 = #602#1;
     #603#2 = #602#2;
     #603#3 = #602#3;
     #603#4 = nResponde;
     |LEE 000#603=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     nSwFechaRegistro = 0;
     fFechaRegistro = "01.01.0000";
     fFechaCaducidad = "01.01.0000";

     enGrupoFR = #603#0;
     enSubGrupoFR = #603#1;
     enTipoFR = #603#2;
     enSitFR = #603#6;
     enSwFR = 0;
     efFechaFR = "01.01.0000";
     enNumDocFR = #605#5;
     |HAZ MiraSiFechaRegistro;          ||Nos dice si debe obtener la fecha
                                        ||de algun campo del registro
                                        ||y en tal caso obtiene dicha fecha

     |SI enSwFR = 1;
          nSwFechaRegistro = 1;
          fFechaRegistro = efFechaFR;
     |FINSI;

     |SI nSwFechaRegistro = 1;
          |SI fFechaRegistro ! "01.01.0000";
               fFechaCaducidad = fFechaRegistro;
          |FINSI;
     |FINSI;

     aCadManual = #603#9;
     |QBF aCadManual;
     |SI aCadManual = "S";
          |SI nSwFechaRegistro = 1;
               |SI fFechaRegistro ! "01.01.0000";
                    fFechaCaducidad = fFechaRegistro;
               |SINO;
                    |HAZ CalculaFecha;
               |FINSI;
          |SINO;
               |HAZ CalculaFecha;
          |FINSI;

          aAlfa = "Indicar Fecha Caducidad";
          |VENTANA 1630, 2070, -1, 16, aAlfa;
          nVentFC = FSalida;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentFC;
          aVent5 = "MODAL";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |PINPA #0#floww007;
          #floww007#0 = fFechaCaducidad;
          |PINDA #0#floww007;

          |ENDATOS #1#floww007;
          |SI FSalida = 0;
               fFechaCaducidad = #floww007#0;
          |SINO;
               fFechaCaducidad = "01.01.0000";
          |FINSI;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentFC;
          aVent5 = "MODELESS";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |FINVENTANA nVentFC;
     |FINSI;

     |LEE 101#605=;

     #606#0 = #605#5;
     #606#1 = 99999;
     |LEE 000#606];
     |SI FSalida = 0;
         |LEE 000#606a;
     |SINO;
         |LEE 000#606u;
     |FINSI;

     nLinea = 1;
     |SI FSalida = 0;  |Y #606#0 = #605#5;
         nLinea = #606#1;
     |FINSI;

     #606#0 = #605#5;
     #606#1 = nLinea;
     |LEE 101#606=;
     |SI FSalida = 0;
         #606#5 = aUsuario;
         |GRABA 020#606a;
         |LIBERA #606;
     |FINSI;

     |HORA aHora;

     |DDEFECTO #606;
     #606#0 = #605#5;
     #606#1 = nLinea + 1;
     #606#2 = #603#6;
     #606#3 = fFechaHoy;
     #606#4 = aHora;
     #606#5 = aUsuario;
     #606#6 = "SITUACION NUEVA";

     enNumRegFlow = #flowm006#0;
     enSituFlow = #flowm006#2;
     |HAZ DimeDesFlow;
     #flowm006#7 = eaDesSituFlow;

     |GRABA 020#606n;
     |LIBERA #606;

     nGrupo     = #605#1;
     nSubGrupo  = #605#2;
     nTipo      = #605#3;
     nSituacion = #605#4;
     nDocu      = #605#5;
     aDTipo     = " ";
     aHTipo     = "z";
     |BUCLE flowm005B;

     aDUsu      = "";
     aHUsu      = "zzzzzzzzzz";

     |SI #603#8 = "S";
         |MENAV "0000A continuaci¢n elija un usuario para la situaci¢n destino";

         |ABRE #604;
         |PARA;  |SI;  |HACIENDO;
              |CONSULTA_F_CLAVE #1#604, Baja604, Alta604;
              |SI FSalida = 0;
                 aDUsu = #604#4;
                 aHUsu = #604#4;
                 |SAL;
              |FINSI;
         |SIGUE;
         |CIERRA #604;
     |FINSI;

     nUsuarios = 0;
     nPasada   = 0;  |BUCLE flowm004R;
     nPasada   = 1;  |BUCLE flowm004R;
|FPRC;

|PROCESO flowm005_cuenta;
     |SI #flowm005#20 = "*";
          nDocMarcado = #flowm005#5;
          nMarcas = nMarcas + 1;
          |SI #flowm005#8 = "C";
               nDocMarcadoAprop = #flowm005#5;
               nMarcasAprop = nMarcasAprop + 1;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE flowm005_cuenta;
 #flowm005#1;
 ;
 aEstoyUsu, nEstoyGru, nEstoySGr, nEstoyTip, nEstoySit, 000000001;
 aEstoyUsu, nEstoyGru, nEstoySGr, nEstoyTip, nEstoySit, 999999999;
 ;
 NULL, flowm005_cuenta;
|FIN;

|PROCESO DimeSiMarcados;
     |ABRE #flowm002;
     |DDEFECTO #flowm002;
     #flowm002#0 = nEstoyGru;
     #flowm002#1 = nEstoySGr;
     #flowm002#2 = nEstoyTip;
     #flowm002#3 = nEstoySit;
     |LEE 000#flowm002.=;
     |SI FSalida = 0; |Y #flowm002#19 = "S";
          |BUCLE flowm005_cuenta;
     |FINSI;
     |CIERRA #flowm002;
|FPRC;

|PROCESO Boton5;
     |SELECT #1#605;
     |LEE 000#605=;
     |SI FSalida ! 0;
         |SI aTipoTree = "ADM";  |SELECT #3#605;  |FINSI;
         |HAZ Refresca;
         |ACABA;
     |FINSI;

     aEstoyUsu = #605#0;
     nEstoyGru = #605#1;
     nEstoySGr = #605#2;
     nEstoyTip = #605#3;
     nEstoySit = #605#4;
     nEstoyDoc = #605#5;

     |SI #605#20 = "*";
          nSwEstoyMarca = 1;
     |SINO;
          nSwEstoyMarca = 0;
     |FINSI;

     nMarcas = 0;
     nMarcasAprop = 0;
     |HAZ DimeSiMarcados;

     |SI nMarcas = 0;
          aAlfa = "0000NSeguro que quiere resolver el documento " + nEstoyDoc;
     |SINO;
          |SI nMarcas = 1;
                nMarcas = 0;
                |SI nSwEstoyMarca = 1;       ||Esto lo hago para distinguir si estoy en el documento marcado
                                             ||o no lo estoy, pero solo hay uno marcado.
                     aAlfa = "0000NSeguro que quiere resolver el documento " + nEstoyDoc;
                |SINO;
                     nEstoyDoc = nDocMarcado;
                     aAlfa = "0000NSeguro que quiere resolver el documento " + nDocMarcado;
                |FINSI;
          |SINO;
                aAlfa = "0000NSeguro que quiere resolver los " + nMarcas + " documentos seleccionados";
          |FINSI;
     |FINSI;
     |CONFI aAlfa;
     |SI FSalida ! 0;
         |SI aTipoTree = "ADM";  |SELECT #3#605;  |FINSI;
         |ACABA;
     |FINSI;

     |SI nMarcas = 0;
          #605#0 = aEstoyUsu;
          #605#1 = nEstoyGru;
          #605#2 = nEstoySGr;
          #605#3 = nEstoyTip;
          #605#4 = nEstoySit;
          #605#5 = nEstoyDoc;
          |LEE 000#605=;

          ||ESTO YA NO SE USA
          aGuarda10 = #605#10;
          aGuarda11 = #605#11;
          aGuarda12 = #605#12;
          aGuarda13 = #605#13;
          aGuarda14 = #605#14;
          aGuarda15 = #605#15;
          aGuarda16 = #605#16;
          aGuarda17 = #605#17;
          aGuarda18 = #605#18;
          aAlfa = "Resolver el documento " + #605#5;
     |SINO;
          aAlfa = "Resolver " + nMarcas + " documentos seleccionados ";
     |FINSI;

     |VENTANA 0501, 2999, -1, 16, aAlfa;
     nVent = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |ABRE #602;
     |SI nMarcas = 0;
          #602#0 = #605#1;
          #602#1 = #605#2;
          #602#2 = #605#3;
          #602#3 = #605#4;
     |SINO;
          #602#0 = nEstoyGru;
          #602#1 = nEstoySGr;
          #602#2 = nEstoyTip;
          #602#3 = nEstoySit;
     |FINSI;
     |LEE 000#602=;
     |SI FSalida ! 0;  |DDEFECTO #602;  |FINSI;
     |CIERRA #602;

     #803#0  = #602#5;
     #803#1  = #602#6;
     #803#2  = #602#7;
     #803#3  = #602#8;
     #803#4  = #602#9;
     #803#5  = #602#12;
     #803#6  = #602#13;
     #803#7  = #602#14;
     #803#8  = #602#15;
     #803#9  = #602#16;

     nResponde = 0;
     |PINPA #0#803;   nPanta803 = FSalida;
     |PINDA #0#803;

     nRango = 4 + 8 + 16;

     |ABRE #603;
     |LINEAL_SIMPLE #1#603, nRango, 2326, 2998, Baja603, Alta603, Evento603;

     |SI nResponde ! 0;
          |SI nMarcas = 0;
               |HAZ Resuelve;
          |SINO;
               |HAZ ResuelveMarcados;
          |FINSI;
     |FINSI;
     |CIERRA #603;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVent;

     |SI aTipoTree = "ADM";  |SELECT #3#605;  |FINSI;

     |SI nResponde ! 0;
         |HAZ Refresca;
     |FINSI;
|FPRC;

|PROCESO PresentaDocumento;
     |XABRE "EC", eaDestino, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     ||Historico
     |HORA aHora;
     aUsuario = Usuario % 810;
     |ABRE #flowm006;
     #flowm006#0  = #dsarm005#0;
     #flowm006#1  = 99999;
     |LEE 000#flowm006.];
     |SI FSalida = 0;
          |LEE 000#flowm006.a;
     |SINO;
          |LEE 000#flowm006.u;
     |FINSI;
     |SI FSalida = 0; |Y #flowm006#0  = #dsarm005#0;
          nLinea = #flowm006#1 + 1;
          nSitu = #flowm006#2;
     |SINO;
          nSitu = 0;
          nLinea = 1;
     |FINSI;
     |DDEFECTO #flowm006;
     #flowm006#0  = #dsarm005#0;
     #flowm006#1  = nLinea;
     |LEE 101#flowm006.=;
     |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
     #flowm006#2  = nSitu;
     #flowm006#3  = ~;
     #flowm006#4  = aHora;
     #flowm006#5  = aUsuario;
     aDocHis = ("000000000" + #dsarm005#0) % -109;
     #flowm006#6  = "VISUALIZADO DOCUMENTO: " + aDocHis;

     enNumRegFlow = #flowm006#0;
     enSituFlow = #flowm006#2;
     |HAZ DimeDesFlow;
     #flowm006#7 = eaDesSituFlow;

     |GRABA 020#flowm006.a;
     |LIBERA #flowm006;
     |CIERRA #flowm006;

     aEjecuta = "START " + eaUnidad + ":\DOCUMENTOS\DSARCHI\dsabreextension ";
     aEjecuta = aEjecuta + eaDestino;
     aEjecuta = aEjecuta + " " + eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";

     aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;

     |RSYSTEM aEjecuta;

     |SI nSwModoConsulta = 0;
          ||TODO CCC. No tiene que parar. estamos en modo consulta.
          aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
          |PARA;  |SI;  |HACIENDO;
                  |XABRE "EC", aAlfa, nHandle;
                  |SI FSalida ] 0;
                      |SAL;
                  |FINSI;

                  |PARA nPausa = 1; |SI nPausa < 10000; |HACIENDO nPausa = nPausa + 1;
                  |SIGUE;
                  |PULSATECLA;
          |SIGUE;
          |PULSATECLA;

          aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
          |RFBORRA aAlfa;
     |FINSI;
|FPRC;

|PROCESO Boton6;
     |SI #dsarz010#7 = "N";
          aMensaje = "0000No tiene permisos para ejecutar este boton";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     nSwModoConsulta = 1;
     |HAZ Nucleo6;
|FPRC;

|PROCESO Nucleo6;
     |HAZ CtrlCache;

     |ABRE #5;
     |SELECT #1#5;
     |SI nSwDeposito = 0;
          #5#0 = #605#5;
     |SINO;
          #5#0 = #615#5;
     |FINSI;
     |LEE 000#5=;
     |SI FSalida ! 0;  |DDEFECTO #5;  |FINSI;
     |CIERRA #5;

     |SI #1#7 = "N";
          |HAZ DimeUnidad;
     |SINO;
          eaUnidad = eaUnidadBasico % 101;
     |FINSI;

     |DBASE aPathBase;
     |QBF aPathBase;

     aAuxNom = #dsarm005#9;
     |QBF aAuxNom;
     |SI aAuxNom = "-DOCUMENTOWEB-";
          eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "dsabreweb.exe";
          eaOrigen = aPathBase + "dlls/dsabreweb.exe";
          |HAZ EnviaFicheroConMD5;

          aUrl = #dsarm001#162;
          |QBF aUrl;
          |SI aUrl = "";
               aMensaje = "0000Url para llamadas Asterisk NO definido. Proceso cancelado.";
               |MENAV aMensaje;
               |ACABA;
          |FINSI;
          aClave = #dsarm005#23;
          aClave = aClave - "CLAVE: ";
          |QBF aClave;

          aEjecuta = "START " + eaUnidad + ":\DOCUMENTOS\DSARCHI\dsabreweb.exe " + aUrl + aClave;
          |RSYSTEM aEjecuta;

          |ACABA;
     |FINSI;

     eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "dsabreextension.exe";
     eaOrigen = aPathBase + "dlls/dsabreextension.exe";
     |HAZ EnviaFicheroConMD5;

     aFichero = #5#7;   |QBF aFichero;

     aFicAux = #dsarm005#96;
     |QBF aFicAux;
     |SI aFicAux ! "";
          nSwVerDocPDF = 1;
     |SINO;
          nSwVerDocPDF = 0;
     |FINSI;

     |SI nSwVerDocPDF = 1;
         aAuxPath = aFichero;

         aFichero = aFichero + aFicAux;
         ||Voy a verificar si existe o no el fichero.
         |SI #1#7 = "N";
               |XABRE "E", aFichero, nHandleX;
               |SI FSalida < 0;
                    nSwVerDocPDF = 0;
                    aFichero = aFichero + #5#9;
               |FINSI;
         |SINO;
               |XABRE "CE", aFichero, nHandleX;
               |SI FSalida < 0;
                    nSwVerDocPDF = 0;
                    aFichero = aFichero + #5#9;
               |FINSI;
         |FINSI;
     |SINO;
         aFichero = aFichero + #5#9;
     |FINSI;
     |QBF aFichero;

     aPathRemoto = eaUnidad + ":\DOCUMENTOS\";
     |RMKDIR aPathRemoto;
     aPathRemoto = aPathRemoto + "DSARCHI\";
     |RMKDIR aPathRemoto;

     eaOrigen  = aFichero;
     |SI nSwVerDocPDF = 1;
          eaDestino = aPathRemoto + aFicAux;
     |SINO;
          eaDestino = aPathRemoto + #5#9;
     |FINSI;
     |QBF eaDestino;

     aIPRemoto   = "";
     |IP_REMOTO aIPRemoto;

     |SI #1#7 = "N";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO eaOrigen, eaDestino;
         |SINO;
             |COPIA_FICHERO eaOrigen, eaDestino;
         |FINSI;
     |SINO;
         |RCOPIA_FICHERO eaOrigen, eaDestino;
     |FINSI;


     |SI aIPRemoto = "";
         |XABRE "E", eaDestino, nHandle;
     |SINO;
         |XABRE "EC", eaDestino, nHandle;
     |FINSI;

     |SI FSalida < 0;
         aMensaje = "0000No puedo localizar el documento. Debe haber sido borrado o movido de carpeta";
         |MENAV aMensaje;
         |ACABA;
     |FINSI;

     aBorraCache = eaDestino;
     |QBF aBorraCache;

     |VENTANA 0501, 3299, -1, 16, "Visualizando Documento";
     nVent  = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |PINPA #0#908;
     |PINDA #0#908;

     |HAZ PresentaDocumento;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVent;
|FPRC;

|PROCESO Boton10;        ||Modificar documento
     |SI #dsarz010#12 = "N";
          aMensaje = "0000No tiene permisos para ejecutar este boton";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     |ABRE #5;
     |SELECT #1#5;
     |SI nSwDeposito = 0;
          #5#0 = #605#5;
     |SINO;
          #5#0 = #615#5;
     |FINSI;
     |LEE 000#5=;
     |SI FSalida ! 0;  |DDEFECTO #5;  |FINSI;
     |CIERRA #5;

     |ABRE #2;
     |DDEFECTO #2;
     #2#0 = #5#1;
     |LEE 000#2=;
     |CIERRA #2;

     |ABRE #3;
     |DDEFECTO #3;
     #3#0 = #5#1;
     #3#1 = #5#2;
     |LEE 000#3=;
     |CIERRA #3;

     |ABRE #4;
     |DDEFECTO #4;
     #4#0 = #5#1;
     #4#1 = #5#2;
     #4#2 = #5#3;
     |LEE 000#4=;
     |CIERRA #4;

     |SI #4#34 = "N";
          aMensaje = "0000El Grupo/Subgrupo/Tipo no permite modificar el registro";
          |MENAV aMensaje;
          |ACABA;
     |SINO;
          |SI #4#34 = "P";
               enPassword = 0;
               |HAZ PidePassword;
               |SI enPassword = 1;
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     nSwModoConsulta = 0;
     |HAZ Nucleo6;
     |SI nSwModoConsulta = 0;
          ||Solo se actualiza en modo modificacion.
          enSwIOCorrecta = 0;
          enSwDocModificado = 0;
          |HAZ RecibeConMD5;
          |SI enSwDocModificado = 1;
               ||Historico
               |HORA aHora;
               aUsuario = Usuario % 810;
               |ABRE #flowm006;
               #flowm006#0  = #dsarm005#0;
               #flowm006#1  = 99999;
               |LEE 000#flowm006.];
               |SI FSalida = 0;
                    |LEE 000#flowm006.a;
               |SINO;
                    |LEE 000#flowm006.u;
               |FINSI;
               |SI FSalida = 0; |Y #flowm006#0  = #dsarm005#0;
                    nLinea = #flowm006#1 + 1;
               |SINO;
                    nLinea = 1;
               |FINSI;
               |DDEFECTO #flowm006;
               #flowm006#0  = #dsarm005#0;
               #flowm006#1  = nLinea;
               |LEE 101#flowm006.=;
               |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
               #flowm006#3  = ~;
               #flowm006#4  = aHora;
               #flowm006#5  = aUsuario;
               |SI enSwIOCorrecta = 0;
                    #flowm006#6  = "MODIFICACION DOCUMENTO [ERROR]";
               |SINO;
                    #flowm006#6  = "MODIFICACION DOCUMENTO [CORRECTO]";
               |FINSI;

               enNumRegFlow = #flowm006#0;
               enSituFlow = #flowm006#2;
               |HAZ DimeDesFlow;
               #flowm006#7 = eaDesSituFlow;

               |GRABA 020#flowm006.a;
               |LIBERA #flowm006;
               |CIERRA #flowm006;
          |FINSI;
          |SI enSwIOCorrecta = 0;
               |MENAV "0000 Ha habido un error al transferir el documento al servidor. Revise Permisos y espacio disponible.";
               |ACABA;
          |FINSI;

          aIPRemoto = "";
          |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

          |SI #1#7 = "N";  |Y aIPRemoto ! "";
              |XABRE "E", eaOrigen, nHandle;
          |SINO;
              |XABRE "EC", eaOrigen, nHandle;
          |FINSI;

          |SI FSalida < 0;
              |MENAV "0000 Ha habido un error al transferir el documento al servidor. Intentelo de nuevo";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Boton7;
     |SI nSwDeposito = 0;
          |LEE 000#605=;
     |SINO;
          |LEE 000#615=;
     |FINSI;
     |SI FSalida ! 0;
         |HAZ Refresca;
         |ACABA;
     |FINSI;

     |SI nSwDeposito = 0;
          enDocumento = #605#5;
     |SINO;
          enDocumento = #615#5;
     |FINSI;
     |SUB_EJECUTA_NP "flowm006";
|FPRC;

|PROCESO Baja614;
     #614#4 = aUsuario;
     #614#0 = 001;
     #614#1 = 001;
     #614#2 = 001;
     #614#3 = 001;
|FPRC;

|PROCESO Alta614;
     #614#4 = aUsuario;
     #614#0 = 999;
     #614#1 = 999;
     #614#2 = 999;
     #614#3 = 001;
|FPRC;

|PROCESO ActualizaDestino;
     #floww004#7 = #flowm014#0;
     #floww004#8 = #flowm014#1;
     #floww004#9 = #flowm014#2;

     |ABRE #2;
     #2#0 = #floww004#7;
     |LEE 000#2=;
     |SI FSalida ! 0;  |DDEFECTO  #2;  |FINSI;
     #floww004#10 = #2#1;

     |SI #1#8 = "S";
          |ABRE #3;
          |ABRE #4;
          #3#0 = #floww004#7;
          #3#1 = #floww004#8;
          |LEE 000#3=;
          |SI FSalida ! 0;  |DDEFECTO  #3;  |FINSI;
          #floww004#11 = #3#2;

          #4#0 = #floww004#7;
          #4#1 = #floww004#8;
          #4#2 = #floww004#9;
          |LEE 000#4=;
          |SI FSalida ! 0;  |DDEFECTO  #4;  |FINSI;
          #floww004#12 = #4#3;
          |CIERRA #3;
          |CIERRA #4;
     |FINSI;

     |PINTA #floww004#7;
     |PINTA #floww004#8;
     |PINTA #floww004#9;
     |PINTA #floww004#10;
     |PINTA #floww004#11;
     |PINTA #floww004#12;
|FPRC;

|PROCESO Evento614;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#614=;
         |SI FSalida = 0;
              |HAZ ActualizaDestino;
         |FINSI;
     |FINSI;

     |SI FSalida = 4;
          enGrupoPV = #614#0;
          enSubGrupoPV = #614#1;
          enTipoPV = #614#2;
          |SI enGrupoPV = #floww004#1; |Y enSubGrupoPV = #floww004#2; |Y enTipoPV = #floww004#3;
               aMensaje = "0000Para mover el documento, seleccione Destino distinto al Origen.";
               |MENAV aMensaje;
               |ACABA;
          |FINSI;

          nSwSeleMover = 1;
          |PTEC 806;
     |FINSI;
|FPRC;

|PROCESO dsarm034_esta;
     nSwEstaBandeja = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE dsarm034_esta;
 #dsarm034#2;
 ;
 enDocumento;
 enDocumento;
 ;
 NULL, dsarm034_esta;
|FIN;

|PROCESO MiraSiObligatorios;
     |ABRE #4;
     |DDEFECTO #4;
     #4#0 = enGrupoPV;
     #4#1 = enSubGrupoPV;
     #4#2 = enTipoPV;
     |LEE 000#4.=;

     ||ARA1
     ||Tengo que controlar si me tocar meter el documento en la bandeja DsEscan
     ||de forma manual.

     nSwCreaBanDSEscanManual = 0;
     |SI #4#87 = "S";
          nSwEstaBandeja = 0;
          |BUCLE dsarm034_esta;
          |SI nSwEstaBandeja = 0;
               efFechaBandeja = "01.01.0000";
               eaHoraBandeja = "";
               eaNombreBandeja = "";

               aAlfa = "dsarz013;BANDEJADSESCANMANUAL";
               |SUB_EJECUTA aAlfa;

               |SI eaHoraBandeja ! "";
                    nSwCreaBanDSEscanManual = 1;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #4#20 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#21 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#22 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#23 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#24 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#55 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#56 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#57 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#58 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#59 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#60 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#61 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#62 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#63 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#64 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#65 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#66 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#67 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#68 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#69 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#70 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#71 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#72 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#73 = "S"; nSwObligatorios = 1; |FINSI;
     |SI #4#74 = "S"; nSwObligatorios = 1; |FINSI;
     |CIERRA #4;
|FPRC;

|PROCESO flowm005;
     |BORRA 020#flowm005.a;
     #flowm005#1 = nGrupo;
     #flowm005#2 = nSubGrupo;
     #flowm005#3 = nTipo;
     #flowm005#4 = 001;
     |GRABA 040#flowm005.n;
     |LIBERA #flowm005;

     nSwHayFlow = 1;
|FPRC;

|DEFBUCLE flowm005;
 #flowm005#2;
 ;
 #dsarm005#0, "          ", nGrupoAnt, nSubGruAnt, nTipoAnt, 000;
 #dsarm005#0, "zzzzzzzzzz", nGrupoAnt, nSubGruAnt, nTipoAnt, 999;
 be;
 NULL, flowm005;
|FIN;


|PROCESO flowm004_z001;
     |SI nPasada = 0;
         nUsuarios  = nUsuarios + 1;
         |ACABA;
     |FINSI;

     |DDEFECTO #flowm005;
     #flowm005#0  = #flowm004#4;
     #flowm005#1  = #flowm004#0;
     #flowm005#2  = #flowm004#1;
     #flowm005#3  = #flowm004#2;
     #flowm005#4  = #flowm004#3;
     #flowm005#5  = #dsarm005#0;
     |LEE 101#flowm005.=;
     |SI FSalida ! 0; |GRABA 020#flowm005.b; |FINSI;

     #flowm005#6  = #dsarm005#4;
     #flowm005#7  = aHora;
     #flowm005#8  = "E";
     #flowm005#9  = "0,0,0;0,255,0";
     #flowm005#10  = #dsarm005#6;
     #flowm005#11  = #dsarm005#10;
     #flowm005#12  = #dsarm005#38;
     #flowm005#13  = #dsarm005#23;
     #flowm005#14  = #dsarm005#24;
     #flowm005#15  = #dsarm005#25;
     #flowm005#16  = #dsarm005#26;
     #flowm005#17  = #dsarm005#27;
     #flowm005#18  = #dsarm005#28;

     |SI nUsuarios > 1;
         #flowm005#8  = "C";
         #flowm005#9  = "0,0,0;255,255,0";
     |FINSI;

     |GRABA 020#flowm005.a;
     |LIBERA #flowm005;
|FPRC;

|DEFBUCLE flowm004_z001;
     #flowm004#1;
     ;
     #flowm002#0, #flowm002#1, #flowm002#2, #flowm002#3, "          ";
     #flowm002#0, #flowm002#1, #flowm002#2, #flowm002#3, "zzzzzzzzzz";
     ;
     NULL, flowm004_z001;
|FIN;


|PROCESO ActualizaWorkflow;
     nSwHayFlow = 0;
     |BUCLE flowm005;

||Ahora, siempre se realiza el control del workflow. Tiquet. 4182.56
||y tiquet 70000.6282
||   |SI nSwHayFlow = 0;
          ||Miro si ahora debe entrar en el workflow. (Ver tipo 15 del PLB).

          |ABRE #flowm001;
          #flowm001#0 = nGrupo;
          #flowm001#1 = nSubGrupo;
          #flowm001#2 = nTipo;
          |LEE 000#flowm001.=;
          |SI FSalida ! 0;
              |CIERRA #flowm001;
              |ACABA;
          |FINSI;
          |CIERRA #flowm001;

          |ABRE #flowm002;
          #flowm002#0 = #flowm001#0;
          #flowm002#1 = #flowm001#1;
          #flowm002#2 = #flowm001#2;
          #flowm002#3 = 1;
          |LEE 000#flowm002.];
          |SI FSalida ! 0;  |O #flowm002#0 ! #flowm001#0;  |O #flowm002#1 ! #flowm001#1;
                            |O #flowm002#2 ! #flowm001#2;
              |CIERRA #flowm002;
              |ACABA;
          |FINSI;
          |CIERRA #flowm002;

          ||Historico
          |HORA aHora;
          aUsuario = Usuario % 810;
          |ABRE #flowm006;
          #flowm006#0  = #dsarm005#0;
          #flowm006#1  = 99999;
          |LEE 000#flowm006.];
          |SI FSalida = 0;
               |LEE 000#flowm006.a;
          |SINO;
               |LEE 000#flowm006.u;
          |FINSI;
          |SI FSalida = 0; |Y #flowm006#0  = #dsarm005#0;
               nLinea = #flowm006#1 + 1;
               nSitu = #flowm006#2;
          |SINO;
               nSitu = 1;
               nLinea = 1;
          |FINSI;
          |SI nSitu = 0; nSitu = 1; |FINSI;

          |DDEFECTO #flowm006;
          #flowm006#0  = #dsarm005#0;
          #flowm006#1  = nLinea;
          |LEE 101#flowm006.=;
          |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
          #flowm006#2  = nSitu;
          #flowm006#3  = ~;
          #flowm006#4  = aHora;
          #flowm006#5  = aUsuario;
          #flowm006#6 = "ENTRADA WORKFLOW";

          enNumRegFlow = #flowm006#0;
          enSituFlow = #flowm006#2;
          |HAZ DimeDesFlow;
          #flowm006#7 = eaDesSituFlow;

          |GRABA 020#flowm006.a;
          |LIBERA #flowm006;
          |CIERRA #flowm006;

          nUsuarios = 0;

          |ABRE #flowm005;
          nPasada = 0;  |BUCLE flowm004_z001;
          nPasada = 1;  |BUCLE flowm004_z001;
          |CIERRA #flowm005;
||     |FINSI;
|FPRC;


|PROCESO dsarm030_borra;
     |BORRA 020#dsarm030.a;
|FPRC;

|PROCESO Baja30;
     #dsarm030#0 = nRegDocu;
     #dsarm030#1 = 1;
|FPRC;

|PROCESO Alta30;
     #dsarm030#0 = nRegDocu;
     #dsarm030#1 = 99999;
|FPRC;

|PROCESO Evento30;
|FPRC;

|DEFBUCLE dsarm030_borra;
 #dsarm030#1;
 ;
 nRegDocu,     0;
 nRegDocu, 99999;
 be;
 NULL, dsarm030_borra;
|FIN;

|PROCESO dsarm031_borra;
     |BORRA 020#dsarm031.a;
|FPRC;

|DEFBUCLE dsarm031_borra;
 #dsarm031#1;
 ;
 nRegDocu, 000;
 nRegDocu, 999;
 be;
 NULL, dsarm031_borra;
|FIN;

|PROCESO dsarm031_mete;
     nCampo = #dsarm031#1;
     aValor = #dsarm031#2;

     |SI nCampo ] 23; |Y nCampo [ 37;
          aAux2 = #5#nCampo#;
          |QBF aAux2;
          |SI aAux2 ! "";
               aAux2 = aAux2 + " " + aValor;
               |QBF aAux2;
               #5#nCampo# = aAux2;
          |SINO;
               #5#nCampo# = aValor;
          |FINSI;
     |SINO;
          |SI nCampo ] 60; |Y nCampo [ 64;
               aAux2 = #5#nCampo#;
               |QBF aAux2;
               |SI aAux2 ! "";
                    aAux2 = aAux2 + " " + aValor;
                    |QBF aAux2;
                    #5#nCampo# = aAux2;
               |SINO;
                    #5#nCampo# = aValor;
               |FINSI;
          |SINO;
               #5#nCampo# = aValor;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm031_mete;
 #dsarm031#1;
 ;
 nRegDocu, 001;
 nRegDocu, 999;
 ;
 NULL, dsarm031_mete;
|FIN;

|PROCESO PonEtiquetas;
     nContDos = nContDos + 1;
     aAux = #4#nCampo#;
     |QBF aAux;
     |SI aAux ! "";
          nContReal = nContReal + 1;

          |SI nContReal < 16;
               nCampo1 = 22 + nContReal;
          |SINO;
               nCampo1 = 44 + nContReal;
          |FINSI;

          aTexto = aAux;
          |QBF aTexto;
          aTexto = aTexto + ": ";
          #5#nCampo1# = aTexto;
     |FINSI;
|FPRC;

|PROCESO dsarm035_borra;
     |BORRA 020#dsarm035.a;
|FPRC;

|DEFBUCLE dsarm035_borra;
 #dsarm035#1;
 ;
 efFechaBandeja, eaHoraBandeja, eaNombreBandeja, aVacio25;
 efFechaBandeja, eaHoraBandeja, eaNombreBandeja, aZeta25;
 be;
 NULL, dsarm035_borra;
|FIN;

|PROCESO dsarm034_borra;
     |BORRA 020#dsarm034.a;
     |BUCLE dsarm035_borra;
|FPRC;

|DEFBUCLE dsarm034_borra;
 #dsarm034#1;
 ;
 efFechaBandeja, eaHoraBandeja, eaNombreBandeja;
 efFechaBandeja, eaHoraBandeja, eaNombreBandeja;
 be;
 NULL, dsarm034_borra;
|FIN;

|PROCESO MoverDocumento;
     nSwObligatorios = 0;
     |HAZ MiraSiObligatorios;
     |SI nSwObligatorios = 1;
          |VENTANA 0501, 2999, -1, 16, "Datos Documentos";
          nVentm5 = FSalida;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentm5;
          aVent5 = "MODAL";
          |ESPECIFICA "ESTADO_VENTANA", aVent;
          |PULSATECLA;

          |PTEC 802;  |PAUSA;

          enMueveDoc = 1;
          |SUB_EJECUTA_NP "dsarw006";
          enMueveDoc = 0;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentm5;
          aVent5 = "MODELESS";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |FINVENTANA nVentm5;
     |FINSI;

     |SI enGrupoPV = 0; |Y enSubGrupoPV = 0; |Y enTipoPV = 0;
          |SI nSwCreaBanDSEscanManual = 1;
               ||TODO CCC
               ||Tengo que borrar el dsarm034 y dsarm035. se ha anulado el
               ||proceso de mover el documento
               |SI eaHoraBandeja ! "";
                    |BUCLE dsarm034_borra;
               |FINSI;
          |FINSI;

          nSwSeleMover = 0;
          |ACABA;
          ||NADA PROCESO Cancelado.
     |SINO;
          |ABRE #5;
          #5#0 = enDocumento;
          |LEE 101#5=;
          |SI FSalida = 0;
               nGrupoAnt = #5#1;
               nSubGruAnt = #5#2;
               nTipoAnt = #5#3;

               nGrupo = enGrupoPV;
               nSubGrupo = enSubGrupoPV;
               nTipo = enTipoPV;
               |SI nGrupoAnt ! nGrupo; |O nSubGruAnt ! nSubGrupo; |O nTipoAnt ! nTipo;
                    ||Tengo que mover el documento a la nueva ubicacion.
                    ||TODO CCC
                    aFichero = #5#7;
                    |QBF aFichero;
                    aFichero = aFichero + #5#9;
                    |QBF aFichero;
                    aOrigen  = aFichero;

                    aDestino = #1#1;
                    |QBF aDestino;
                    |ABRE #2;
                    |DDEFECTO #2;
                    #2#0 = nGrupo;
                    |LEE 000#2.=;
                    |SI FSalida = 0;
                         aDestino = aDestino + "/" + #2#2;
                         |QBF aDestino;
                         |SI #1#7 = "N";
                              |MKDIR aDestino;
                         |SINO;
                              |RMKDIR aDestino;
                         |FINSI;
                         |SI #1#8 = "N"; ||NO Usan Grupo, Subgrupo y Tipo
                              |ABRE #4;
                              |DDEFECTO #4;
                              #4#0 = nGrupo;
                              #4#1 = 1;
                              #4#2 = 1;
                              |LEE 000#4.=;
                              |SI FSalida = 0;
                                   |SI #4#75 = "S";
                                        aFechaSis = #5#4;
                                        aAAAAMM = (aFechaSis % -104) + (aFechaSis % 402);
                                        aDestino = aDestino + "/" + aAAAAMM;
                                        |SI #1#7 = "N";
                                             |MKDIR aDestino;
                                        |SINO;
                                             |RMKDIR aDestino;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                              |CIERRA #4;
                         |FINSI;
                    |FINSI;
                    |CIERRA #2;

                    |SI #1#8 = "S"; ||Usan Grupo, Subgrupo y Tipo
                         |ABRE #3;
                         |DDEFECTO #3;
                         #3#0 = nGrupo;
                         #3#1 = nSubGrupo;
                         |LEE 000#3.=;
                         |SI FSalida = 0;
                              aDestino = aDestino + "/" + #3#3;
                              |QBF aDestino;
                              |SI #1#7 = "N";
                                   |MKDIR aDestino;
                              |SINO;
                                   |RMKDIR aDestino;
                              |FINSI;
                         |FINSI;
                         |CIERRA #3;
                         |ABRE #4;
                         |DDEFECTO #4;
                         #4#0 = nGrupo;
                         #4#1 = nSubGrupo;
                         #4#2 = nTipo;
                         |LEE 000#4.=;
                         |SI FSalida = 0;
                              aDestino = aDestino + "/" + #4#4;
                              |QBF aDestino;
                              |SI #1#7 = "N";
                                   |MKDIR aDestino;
                              |SINO;
                                   |RMKDIR aDestino;
                              |FINSI;
                         |FINSI;
                         |CIERRA #4;
                         |SI #4#75 = "S";
                              aFechaSis = #5#4;
                              aAAAAMM = (aFechaSis % -104) + (aFechaSis % 402);
                              aDestino = aDestino + "/" + aAAAAMM;
                              |SI #1#7 = "N";
                                   |MKDIR aDestino;
                              |SINO;
                                   |RMKDIR aDestino;
                              |FINSI;
                         |FINSI;
                    |FINSI;

                    aDestino = aDestino + "/";
                    #5#7 = aDestino;

                    aDestino = aDestino + #5#9;
                    |QBF aDestino;

                    |SI #1#7 = "N";
                         |RENOMBRA_FICHERO aOrigen, aDestino;
                    |SINO;
                         |RRENOMBRA_FICHERO aOrigen, aDestino;
                    |FINSI;
                    nSalidaHis = FSalida;
               |FINSI;

               ||Historico
               |HORA aHora;
               aUsuario = Usuario % 810;
               |ABRE #flowm006;
               #flowm006#0  = #dsarm005#0;
               #flowm006#1  = 99999;
               |LEE 000#flowm006.];
               |SI FSalida = 0;
                    |LEE 000#flowm006.a;
               |SINO;
                    |LEE 000#flowm006.u;
               |FINSI;
               |SI FSalida = 0; |Y #flowm006#0  = #dsarm005#0;
                    nLinea = #flowm006#1 + 1;
                    nSitu = #flowm006#2;
               |SINO;
                    nSitu = 1;
                    nLinea = 1;
               |FINSI;
               |DDEFECTO #flowm006;
               #flowm006#0  = #dsarm005#0;
               #flowm006#1  = nLinea;
               |LEE 101#flowm006.=;
               |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
               #flowm006#2  = nSitu;
               #flowm006#3  = ~;
               #flowm006#4  = aHora;
               #flowm006#5  = aUsuario;
               aOriHis = (("000" + nGrupoAnt) % -103) + "/" + (("000" + nSubGruAnt) % -103) + "/" + (("000" + nTipoAnt) % -103)
               aDesHis = (("000" + nGrupo) % -103) + "/" + (("000" + nSubGrupo) % -103) + "/" + (("000" + nTipo) % -103)

               #flowm006#6  = "MOVIDO DE " + aOriHis + " A " + aDesHis + ".[" + nSalidaHis + "]";

               enNumRegFlow = #flowm006#0;
               enSituFlow = #flowm006#2;
               |HAZ DimeDesFlow;
               #flowm006#7 = eaDesSituFlow;

               |GRABA 020#flowm006.a;
               |LIBERA #flowm006;
               |CIERRA #flowm006;

               #5#1 = nGrupo;
               #5#2 = nSubGrupo;
               #5#3 = nTipo;


/*
               ||NO, esto ya lo controlo en el dsarw006
               |SI nSwObligatorios = 0;
                    ||Tengo que borrar los campos referencia.
                    ||si tiene campos obligatorios, YA lo he borrado previamente
                    ||en otro proceso anterior
                    #5#23 = "";
                    #5#24 = "";
                    #5#25 = "";
                    #5#26 = "";
                    #5#27 = "";
                    #5#28 = "";
                    #5#29 = "";
                    #5#30 = "";
                    #5#31 = "";
                    #5#32 = "";
                    #5#33 = "";
                    #5#34 = "";
                    #5#35 = "";
                    #5#36 = "";
                    #5#37 = "";
                    #5#60 = "";
                    #5#61 = "";
                    #5#62 = "";
                    #5#63 = "";
                    #5#64 = "";
               |FINSI;
*/

               |GRABA 020#5.a;
               |LIBERA #5;
               |CIERRA #5;

               |SI #dsarm004#78 ! 0;         ||Plantillas Auto-Relleno
                    |ABRE #dsarm029;
                    |DDEFECTO #dsarm029;
                    #dsarm029#0 = #dsarm004#78;
                    |LEE 000#dsarm029.=;
                    nSwLogError = #dsarm029#84;
                    |CIERRA #dsarm029;

                    nRegDocu = #5#0;
                    |BUCLE dsarm030_borra;
                    |BUCLE dsarm031_borra;

                    aUbicacion = #5#7;
                    aFicheroTif = #5#9;

                    |ABRE #dsarm031;
                    aMete31 = "";
                    aMete31 = (("000" + nGrupo) % -103) + " " + (("000" + nSubGrupo) % -103) + " " + (("000" + nTipo) % -103);
                    aMete31 = aMete31 + " " + aUbicacion + "|" + aFicheroTif;
                    #dsarm031#0 = nRegDocu;
                    #dsarm031#1 = 0;
                    |LEE 101#dsarm031.=;
                    |SI FSalida ! 0;
                         #dsarm031#2 = aMete31;
                         |GRABA 020#dsarm031.n;
                    |FINSI;
                    |LIBERA #dsarm031;
                    |CIERRA #dsarm031;

                    aAlfa = "dsarz013;" + #5#0;
                    |SUB_EJECUTA aAlfa;

                    |ABRE #dsarm030;
                    |DDEFECTO #dsarm030;
                    #dsarm030#0 = nRegDocu;
                    #dsarm030#1 = 0;
                    |LEE 000#dsarm030.=;
                    |SI FSalida = 0;
                         aAux = #dsarm030#2;
                         |QBF aAux;
                    |SINO;
                         |SI nSwLogError = 1;
                              aMensaje = "0000Error plantillas Auto-Relleno.";
                              |MENAV aMensaje;
                         |FINSI;
                         aAux = "ERROR";
                    |FINSI;
                    |SI aAux = "ERROR";
                         |SI nSwLogError = 1;
                              |VENTANA 0501, 2999, -1, 16, "Visualizando LOG Plantilla Auto-Relleno";
                              nVentz1  = FSalida;

                              aVent1 = -1;
                              aVent2 = -1;
                              aVent3 = 0;
                              aVent4 = nVentz1;
                              aVent5 = "MODAL";
                              |ESPECIFICA "ESTADO_VENTANA", aVent;

                              |PINPA #0#958;
                              |PINDA #0#958;
                              |PTEC 802;
                              |PAUSA;

                              nRango = 2 + 4 + 8 + 16;
                              nPos1 = 0602;
                              nPos2 = 2998;
                              |LINEAL_SIMPLE #1#dsarm030, nRango, nPos1, nPos2, Baja30, Alta30, Evento30;

                              aVent1 = -1;
                              aVent2 = -1;
                              aVent3 = 0;
                              aVent4 = nVentz1;
                              aVent5 = "MODELESS";
                              |ESPECIFICA "ESTADO_VENTANA", aVent;

                              |FINVENTANA nVentz1;

                              ||Mostramos GRID de LOG.
                              ||ARA77. Con Ventana y MODAL.
                         |FINSI;
                    |SINO;
                         |ABRE #dsarm005;
                         #dsarm005#0 = nRegDocu;
                         |LEE 101#dsarm005.=;
                         |SI FSalida = 0;
                               #5#23 = "";
                               #5#24 = "";
                               #5#25 = "";
                               #5#26 = "";
                               #5#27 = "";
                               #5#28 = "";
                               #5#29 = "";
                               #5#30 = "";
                               #5#31 = "";
                               #5#32 = "";
                               #5#33 = "";
                               #5#34 = "";
                               #5#35 = "";
                               #5#36 = "";
                               #5#37 = "";
                               #5#60 = "";
                               #5#61 = "";
                               #5#62 = "";
                               #5#63 = "";
                               #5#64 = "";

                               nContReal = 0;
                               nContDos = 0;
                               |PARA nCampo = 5;  |SI nCampo [ 9;  |HACIENDO nCampo = nCampo + 1;
                                    |HAZ PonEtiquetas;
                               |SIGUE;
                               |PARA nCampo = 27;  |SI nCampo [ 31;  |HACIENDO nCampo = nCampo + 1;
                                    |HAZ PonEtiquetas;
                               |SIGUE;
                               |PARA nCampo = 10;  |SI nCampo [ 19;  |HACIENDO nCampo = nCampo + 1;
                                    |HAZ PonEtiquetas;
                               |SIGUE;

                               |BUCLE dsarm031_mete;
                               |GRABA 020#dsarm005.a;
                               |LIBERA #dsarm005;
                         |FINSI;
                         |CIERRA #dsarm005;
                    |FINSI;
                    |CIERRA #dsarm030;
               |SINO;
                    |SI #dsarm004#81 = "S";
                         enNumRegistro = #5#0;
                         aAlfa = "dsarz013;" + #5#0;
                         |SUB_EJECUTA aAlfa;
                    |FINSI;
               |FINSI;

               aAlfa = "dsarz030;" + #5#0;
               |SUB_EJECUTA aAlfa;

               |HAZ ActualizaWorkflow;
          |FINSI;
          ||Mueve documento.
     |FINSI;
|FPRC;

|PROCESO Boton9;
     FSalida = 4;
     |HAZ Evento614;
|FPRC;

|PROCESO Boton8;
     |SI #dsarz010#3 = "N";
          aMensaje = "0000No tiene permisos para ejecutar este boton";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     ||Mover. Solo Depositos
     |LEE 000#615=;
     |SI FSalida = 0;
          aUsu15 = #flowm015#0;
          |QBF aUsu15;
          |SI aUsuario = aUsu15;
               |ABRE #5;
               #5#0 = #615#5;
               |LEE 000#5=;
               |SI FSalida = 0;
                    aAuxNom = #5#9;
                    |QBF aAuxNom;
                    |SI aAuxNom = "-DOCUMENTOWEB-";
                         aMensaje = "0000No es posible mover documentos:llamadas Asterisk";
                         |MENAV aMensaje;
                         |ACABA;
                    |FINSI;
               |FINSI;
               |CIERRA #5;

||**************************************************************************
          ||PRIMERO OBTENGO, EL DESTINO DONDE MOVEREMOS EL DOCUMENTO.  INI
||**************************************************************************
               |VENTANA 0501, 2799, -1, 16, "Mover Documentos";
               nVentm5 = FSalida;

               aVent1 = -1;
               aVent2 = -1;
               aVent3 = 0;
               aVent4 = nVentm5;
               aVent5 = "MODAL";
               |ESPECIFICA "ESTADO_VENTANA", aVent;

               enDocumento = #flowm015#5;
               nGrupoAra = #flowm015#1;
               nSubGrupoAra = #flowm015#2;
               nTipoAra = #flowm015#3;

               enGrupoPV = 0;
               enSubGrupoPV = 0;
               enTipoPV = 0;

               enMueveDoc = 1;

               |SUB_EJECUTA "dsarz003";

               enMueveDoc = 0;

               aVent1 = -1;
               aVent2 = -1;
               aVent3 = 0;
               aVent4 = nVentm5;
               aVent5 = "MODELESS";
               |ESPECIFICA "ESTADO_VENTANA", aVent;

               |FINVENTANA nVentm5;

               |SI enGrupoPV = 0; |Y enSubGrupoPV = 0; |Y enTipoPV = 0;
                    |ACABA;
               |FINSI;
||**************************************************************************
          ||PRIMERO OBTENGO, EL DESTINO DONDE MOVEREMOS EL DOCUMENTO.  FIN
||**************************************************************************

               |SI enGrupoPV = nGrupoAra; |Y enSubGrupoPV = nSubGrupoAra; |Y enTipoPV = nTipoAra;
                    aMensaje = "0000Ha selecciondo la misma ubicacion Destino que la ubicacion Origen";
                    |MENAV aMensaje;
                    |ACABA;
               |SINO;
                    nSwSeleMover = 1;
               |FINSI;
               |SI nSwSeleMover = 1;
                    enDocumento = #flowm015#5;
                    |HAZ MoverDocumento;
                    ||Okie .. Mover.
               |FINSI;
               |SI nSwSeleMover = 1;
                    |HAZ Refresca;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Boton8_old;
     ||ESTO YA NO SE USA.

     ||Mover. Solo Depositos
     |LEE 000#615=;
     |SI FSalida = 0;
          aUsu15 = #flowm015#0;
          |QBF aUsu15;
          |SI aUsuario = aUsu15;
               |VENTANA 0701, 3299, -1, 16, "Mover Documentos";
               nVentm5 = FSalida;

               aVent1 = -1;
               aVent2 = -1;
               aVent3 = 0;
               aVent4 = nVentm5;
               aVent5 = "MODAL";
               |ESPECIFICA "ESTADO_VENTANA", aVent;

               ||Primero preguntaremos el destino.

               ||Una vez con el destino, subejecutamos el proceso de mover

               ||Actualizamos el workflow (Refrescar), si todo correcto.

               |PINPA #0#floww004;
               nPantaMover = FSalida;

               |CONTROL_SIMPLE nPantaMover, "BOTON,{{193}}Mover", 2985, 3095, Boton9;
               nBoton9 = FSalida;

               #floww004#0 = #flowm015#5;
               #floww004#1 = #flowm015#1;
               #floww004#2 = #flowm015#2;
               #floww004#3 = #flowm015#3;

               |ABRE #2;
               #2#0 = #floww004#1;
               |LEE 000#2=;
               |SI FSalida ! 0;  |DDEFECTO  #2;  |FINSI;
               #floww004#4 = #2#1;

               |SI #1#8 = "S";
                    |ABRE #3;
                    |ABRE #4;
                    #3#0 = #floww004#1;
                    #3#1 = #floww004#2;
                    |LEE 000#3=;
                    |SI FSalida ! 0;  |DDEFECTO  #3;  |FINSI;
                    #floww004#5 = #3#2;

                    #4#0 = #floww004#1;
                    #4#1 = #floww004#2;
                    #4#2 = #floww004#3;
                    |LEE 000#4=;
                    |SI FSalida ! 0;  |DDEFECTO  #4;  |FINSI;
                    #floww004#6 = #4#3;
                    |CIERRA #3;
                    |CIERRA #4;
               |SINO;
                    ||LABEL
                    |CONTROL_SIMPLE nPantaMover, "LABEL,{{0}}         ", 1103, 1114, NULL;
                    nBotonQ1 = FSalida;
                    |CONTROL_SIMPLE nPantaMover, "LABEL,{{0}}         ", 1203, 1214, NULL;
                    nBotonQ2 = FSalida;

                    |C_V #floww004#2, 1, "N";
                    |C_V #floww004#3, 1, "N";
                    |C_V #floww004#5, 1, "N";
                    |C_V #floww004#6, 1, "N";

                    |CONTROL_SIMPLE nPantaMover, "LABEL,{{0}}         ", 3003, 3014, NULL;
                    nBotonQ3 = FSalida;
                    |CONTROL_SIMPLE nPantaMover, "LABEL,{{0}}         ", 3103, 3114, NULL;
                    nBotonQ4 = FSalida;

                    |C_V #floww004#8, 1, "N";
                    |C_V #floww004#9, 1, "N";
                    |C_V #floww004#11, 1, "N";
                    |C_V #floww004#12, 1, "N";
               |FINSI;

               |PINDA #0#floww004;

               nRango     = 4 + 8 + 16 + 32 + 128;

               |LINEAL_SIMPLE #2#614, nRango, 1403, 2898, Baja614, Alta614, Evento614;
               nGrid614 = FSalida;

               nSwSeleMover = 0;
               aEsc1  = &255 + "806";
               aEsc2  = &255 + "807";
               aRetu  = &255 + "802";
               |PARA; |SI;  |HACIENDO;
                   FSalida = "::Cancelar";
                   |LEETECLA aTecla;
                   |SI aTecla = aEsc1; |SAL;  |FINSI;
                   |SI aTecla = aEsc2; |SAL;  |FINSI;
                   |SI aTecla = aRetu; |SAL;  |FINSI;
               |SIGUE;

               |SI #1#8 ! "S";
                    |FIN_CONTROL_WINDOWS nBotonQ1;
                    |FIN_CONTROL_WINDOWS nBotonQ2;
                    |FIN_CONTROL_WINDOWS nBotonQ3;
                    |FIN_CONTROL_WINDOWS nBotonQ4;
               |FINSI;

               |FIN_CONTROL_WINDOWS nBoton9;

               |SI nSwSeleMover = 1;
                    enDocumento = #floww004#0;
                    |HAZ MoverDocumento;
                    ||Okie .. Mover.
               |FINSI;

               |DESTRUYECONTROL nGrid614;

               aVent1 = -1;
               aVent2 = -1;
               aVent3 = 0;
               aVent4 = nVentm5;
               aVent5 = "MODELESS";
               |ESPECIFICA "ESTADO_VENTANA", aVent;

               |FINVENTANA nVentm5;
               |SI nSwSeleMover = 1;
                    |HAZ Refresca;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO PonFoto;
     |DBASE aBase;  |QBF aBase;

     aFotoOrigen = aBase + "logos/logods.jpg";
     aExt        = ".jpg";
     |HAZ LeeUnidadBasico;

     aDirLocal    = eaUnidadBasico + "\DOCUMENTOS";                     |RMKDIR aDirLocal;
     aDirLocal    = eaUnidadBasico + "\DOCUMENTOS\DSARCHI";             |RMKDIR aDirLocal;
     aDirLocal    = eaUnidadBasico + "\DOCUMENTOS\DSARCHI\LOGOS";       |RMKDIR aDirLocal;
     aFotoDestino = aDirLocal + "/logods" + aExt;

     aContiene1 = aFotoDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     aContiene1 = aFotoOrigen;
     |ESPECIFICA "MD5", aContiene;
     aDocServidor = FSalida;  |QBF aDocServidor;

     |SI aDocRemoto ! aDocServidor;  |O aDocRemoto = "";
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aFotoOrigen, aFotoDestino;
         |SINO;
             |COPIA_FICHERO aFotoOrigen, aFotoDestino;
         |FINSI;
     |FINSI;

     aFoto = "IMAGEN,"  + aFotoDestino;
     |CONTROL_SIMPLE nPanta, aFoto, 0501, 0928, NULL;
     nBotonFoto = FSalida;
|FPRC;

|PROCESO Tipo80;  |TIPO 80;
     FSalida = 3299;
|FPRC;

|PROCESO CtrlCache;
     ||Ahora controlamos si borramos o no la cache.
     |SI #dsarm001#181 = "S";
          |QBF aBorraCache;
          |SI aBorraCache ! "";
               |RFBORRA aBorraCache;
               aBorraCache = "";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BtnUsu;
     aTipoTree = "USU";

     |ESTADO_CONTROL nBtnUsu,  "DISABLE";
     |ESTADO_CONTROL nBtnAdm,  "ENABLE";

     |HAZ Refresca;
|FPRC;

|PROCESO BtnAdm;
     aTipoTree = "ADM";

     |ESTADO_CONTROL nBtnUsu,  "ENABLE";
     |ESTADO_CONTROL nBtnAdm,  "DISABLE";

     |HAZ Refresca;
|FPRC;

|PROGRAMA;
     aVacio25 = (" " * 25);
     aZeta25 = ("z" * 25);

     eaPrograma   = "WORKFLOW";
     |HAZ DSARCHI_INI;
     |SI enAprobacion = 0;
         |MENAV "0000No tiene instalado el m¢dulo WORKFLOW.";
         |ACABA;
     |FINSI;

     |ABRE #1;
     |LEE 000#1p;
     |SI FSalida ! 0;  |DDEFECTO #1;  |FINSI;
     |CIERRA #1;

     fFechaHoy = ~;

     |ABRE #dsarz010;
     aUsuario = Usuario % 810;
     |DDEFECTO #dsarz010;
     #dsarz010#0 = aUsuario;
     |LEE 000#dsarz010.=;
     |SI FSalida ! 0;
          |PARA nCampo = 3;  |SI nCampo [ 52;  |HACIENDO nCampo = nCampo + 1;
               #dsarz010#nCampo# = "S";
          |SIGUE;
     |FINSI;
     |CIERRA #dsarz010;

     |CLS;

     |PINPA #0#flowz001;
     nPanta = FSalida;

     aUsuario = Usuario % 810;

     |HAZ PonFoto;

     aAlfa = "LABEL,{{14}} Bandeja Workflow";
     |CONTROL_SIMPLE nPanta, aAlfa, 0630, 0798, NULL;

     |ABRET #605;
     |ABRET #606;
     |ABRET #614;
     |ABRET #615;

     aTipoTree = "USU";
     |HAZ Refresca;

     |SI nGrid605 = -1;
         nRango     = 4 + 8 + 16 + 32 + 128;
         |LINEAL_SIMPLE #1#605, nRango, 2202, 3198, Baja605, Alta605, Evento605;
         nGrid605 = FSalida;
     |FINSI;

     |CONTROL_SIMPLE nPanta, "BOTON,{{197}}Refrescar", 1048, 1060, Refresca;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,{{197}}Pantalla de datos", 1162, 1277, Boton2;
     nBoton2 = FSalida;

     |SI nBoton3 = -1;
          |CONTROL_SIMPLE nPanta, "BOTON,{{137}}Anotaciones (0)", 1762, 1877, Boton3;
          nBoton3 = FSalida;
     |FINSI;
     |SI nBoton3Cero = -1;
          aTextoAnotacion = "BOTON,{{137}}Anotaciones (0)";
          |CONTROL_SIMPLE nPanta, aTextoAnotacion, 1762, 1877, Boton3;
          nBoton3Cero = FSalida;
     |FINSI;

     |CONTROL_SIMPLE nPanta, "BOTON,{{197}}Visualizar documento", 1362, 1477, Boton6;
     nBoton6 = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,{{197}}Modificar documento", 1562, 1677, Boton10;
     nBoton10 = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,{{197}}Hist¢rico", 1962, 2077, Boton7;
     nBoton7 = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,{{206}}Apropiar", 1183, 1298, Boton4;
     nBoton4 = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,{{206}}Resolver", 1383, 1498, Boton5;
     nBoton5 = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,{{193}}Mover", 1983, 2098, Boton8;
     nBoton8 = FSalida;

     aAlfa = "BOTON,{{197}}" + aUsuario;
     |CONTROL_SIMPLE nPanta, aAlfa, 1002, 1014, BtnUsu;
     nBtnUsu = FSalida;

     aAlfa = "BOTON,{{197}}Administrador";
     |CONTROL_SIMPLE nPanta, aAlfa, 1016, 1030, BtnAdm;
     nBtnAdm = FSalida;

     |ESTADO_CONTROL nBoton2, "DISABLE";
     |ESTADO_CONTROL nBoton3, "DISABLE";
     |ESTADO_CONTROL nBoton3Cero, "DISABLE";
     |ESTADO_CONTROL nBoton4, "DISABLE";
     |ESTADO_CONTROL nBoton5, "DISABLE";
     |ESTADO_CONTROL nBoton6, "DISABLE";
     |ESTADO_CONTROL nBoton7, "DISABLE";
     |ESTADO_CONTROL nBoton8, "DISABLE";
     |ESTADO_CONTROL nBoton10, "DISABLE";
     |ESTADO_CONTROL nBtnUsu,  "DISABLE";

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::Salir," + nTree;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
         |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;

     |HAZ LimpiaMarcas;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton3Cero;
     |FIN_CONTROL_WINDOWS nBoton4;
     |FIN_CONTROL_WINDOWS nBoton5;
     |FIN_CONTROL_WINDOWS nBoton6;
     |FIN_CONTROL_WINDOWS nBoton7;
     |FIN_CONTROL_WINDOWS nBoton8;
     |FIN_CONTROL_WINDOWS nBoton10;

     |DESTRUYECONTROL nTree;
     |DESTRUYECONTROL nGrid605;

     |PULSATECLA;

     |CIERRAT #614;
     |CIERRAT #615;
     |CIERRAT #605;
     |CIERRAT #606;

     eaFicheroTxt  = "flowz00101" + Usuario + ".txt";
     aAlfa         = eaRutaDestino + eaFicheroTxt;
     |RFBORRA aAlfa;

     |BUCLE flowm015_3;
     |BUCLE flowm005_3;

     |HAZ CtrlCache;

     |DBASE aAlfa;   |QBF aAlfa;
     aAlfa = aAlfa + "ocr/";
     aAlfa = aAlfa + "Envio" + Usuario + ".txt";
     |XABRE "E", aAlfa, 0;
     |SI FSalida ] 0;
         |SUB_EJECUTA "dsarw010;ENVIAAVISODIAGRAM";
     |FINSI;
|FPRO;
