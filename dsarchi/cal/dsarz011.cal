||Facturacion Electronica.
||ATENCION ... MAXIMO 8000 LINEAS, esta BASTANTE CERCA. YA ME HA JODIDO UNA VEZ
||AHORA SEGUNDA LIMPIEZA, LO HE BAJADO A 7588, pero maximo CUIDADO CON ESTO
||Formato Facturae
||La parte de la lectura segun clave principal ---> Ver. DSERP/dserpm12
||dsarw026 #26;         ||Aux. Tag Pendientes
||Lo utilizo para 2 cosas, primero para meter los TAG RAMA INICIO
||y luego para mantener un temporal de los TAG RAMA INICIO PENDIENTES DE TAG FINAL

||IMPORTANTE. ORDENACION DE LAS ETIQUETAS.
||Se basa en el campo Orden Campos. #dsarm011#3
||nContador, lo utilizo para ordenar los campos en el XML.

||Por defecto los campos de cabecera tendran nContador = 0.     OK
||Para los %Iva CABECERA tendre que pillar por ejemplo los 300x          OK
||Para los suplidos, pillar la 3002, y Tipo Iva suplidos 10
||Para las retenciones IRPF, pillar 3100
||A partir del InvoiceTotals nContador 5000                     OK
||Las lineas de la factura 7000 + Numero de Linea               OK
||A partir de PaymentDetails nContador = 9000                   OK

||<?xml-stylesheet type="text/xsl" href="dsfacturae300.xsl"?>

||ProcesOs Mete????.  MeteLin; MeteCab;
||Nucleo de la creacion del XML. ||NUCLEO

||Cosas a tener en cuenta.
||Suplidos, los considero que son Tipo de Iva = 10.
||Retencion, los considero que son tipo de Impuesto = 12
||La forma de pago > 16 o a cero, tb. la pongo como Forma de Pago 16.

||En salvidal, necesito que antes de meter los datos de la cabecera,
||calculo el valor de nIvaUnico y nREUnico.

||En carrillo, necesito controlar, si falta a¤adir, en la cabecera
||un total de algun IVA a cero, puesto que aparecen en las lineas
||eso ivas a cero, pero tb. tienen que estar en la cabecera.
||Tb. habra que ponerlo en DSCOMER8 y DSCOMER9.
||nSwFaltaCabIvax y nTotalIvax

||Una vez pasada la primera parte, "xml" --> se convierte en "dsarchi".

||En PostProceso, tb. hago el control de las entregas a cta.
||Debe de restar de 4 registros.
||Tb.Este PostProceso, Realiza calculos varios, como el total antes de impuestos
||quitando del bruto el total impuestos.
||Tb. se utiliza para quitar el descuento de las lineas. (en la parte del iva)
||En ds-suite calcula: TotalGrossAmount y TotalGrossAmountBeforeTaxes

|FICHEROS;
   dsarm005 #10;
   dsarm001 #11;
   dsarm002 #2;
   dsarm003 #3;
   dsarm004 #4;
   dsarw010 #510;

   dsarm100 #100;        ||Contador Reg.Doc.
   dsarm066;
   dsarm067;
   dsarw025 #25;         ||Aux. Temporal XML
   dsarw026 #26;         ||Aux. Tag Pendientes    SIRVE PARA CERRAR TAG RAMAS
   dsarm011 #511;        ||Formato XML Facturae
   dsarm012 #12;         ||Equiv. Facturae CAB
   dsarm013 #13;         ||Equiv. Facturae LIN
   dsarm014 #114;        ||Campos Fijos XML FaE
   dsarm015 #15;         ||Campos Obligatorios
   dsarm016 #116;        ||Campos Fijos XML FaE

   referen@ #1000;
   otrodef@ #1001;
   &masdef@  #1002;       ||Sirve para la carga de def auxiliares. Empresa, Clientes, IVAs
   auxdef@  #1003;       ||Otro def auxiliar, cargado con CARGA_DEF
   cuatro@  #1004;       ||Otro def auiliar.
   cinco@   #1005;       ||Otro def mas.
   dsarw028 #128;
   flowm006  #506;
   dsarm057 #57;       ||Conf. FacturaE p/Emp
   dsarw093 #993;
   dsarm038 #538;
|FIN;

|VARIABLES;
     nEmpFE = 0;
     aDestinoDSA = "";
     aPDFenDSA = "";
|FIN;

|INCLUYE i_varfac;

|PROCESO SacaMensaje;
     |PUSHV 0501 2380;
     |PINPA #0#dsarw093;
     |DDEFECTO #dsarw093;

     #dsarw093#0 = aTexto1;
     #dsarw093#1 = aTexto2;
     #dsarw093#2 = aTexto3;
     #dsarw093#3 = aTexto4;
     |PINDA #0#dsarw093;

     |PAUSA;
     |POPV;

     fFecha  = ~;

     |ABRE #dsarm066;
     #dsarm066#0 = fFecha;
     #dsarm066#1 = Usuario % 810;
     |LEE 101#dsarm066.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsarm066;
         #dsarm066#0 = fFecha;
         #dsarm066#1 = Usuario % 810;
         |GRABA 020#dsarm066.n;
         |LIBERA #dsarm066;
     |FINSI;
     |CIERRA #dsarm066;

     |ABRE #dsarm067;
     #dsarm067#0 = #dsarm066#0;
     #dsarm067#1 = #dsarm066#1;
     #dsarm067#2 = 99999;
     |LEE 000#dsarm067.];
     |SI FSalida = 0;
         |LEE 000#dsarm067.a;
     |SINO;
         |LEE 000#dsarm067.u;
     |FINSI;

     nLinea = 1;
     |SI FSalida = 0;  |Y #dsarm067#0 = #dsarm066#0;
                       |Y #dsarm067#1 = #dsarm066#1;
         nLinea = #dsarm067#2 + 1;
     |FINSI;

     |DDEFECTO #dsarm067;
     #dsarm067#0 = #dsarm066#0;
     #dsarm067#1 = #dsarm066#1;
     #dsarm067#2 = nLinea;
     #dsarm067#3 = aTexto1;
     #dsarm067#4 = aTexto2;
     #dsarm067#5 = aTexto3;
     |GRABA 020#dsarm067.n;
     |LIBERA #dsarm067;
     |CIERRA #dsarm067;

     aTexto1 = "";
     aTexto2 = "";
     aTexto3 = "";
     aTexto4 = "";
|FPRC;

|PROCESO Pon4y5;
     |DDEFECTO #dsarm011;
     #dsarm011#0 = aAuxVer;
     #dsarm011#1 = aAuxEsq;
     |LEE 000#dsarm011.=;
     #dsarw025#4 = #dsarm011#2;
     #dsarw025#5 = #dsarm011#3;
     |GRABA 020#dsarw025.a;
     |LIBERA #dsarw025;
|FPRC;

|PROCESO Pon4y5_w025;
     |DDEFECTO #dsarm011;
     #dsarm011#0 = #dsarw025#0;
     #dsarm011#1 = #dsarw025#1;
     |LEE 000#dsarm011.=;
     #dsarw025#4 = #dsarm011#2;
     #dsarw025#5 = #dsarm011#3;
     |GRABA 020#dsarw025.a;
     |LIBERA #dsarw025;
|FPRC;

|PROCESO dsarw028;
     |SI #dsarw028#4 = "N";
          |QBF aObligatorios;
          |SI aObligatorios = "";
               aObligatorios = "Falta Campo: " + #dsarw028#2;
          |SINO;
               aObligatorios = aObligatorios + " " + #dsarw028#2;
          |FINSI;
          |QBF aObligatorios;
          nSwXMLCorrecta = 0;
          |ERROR10;           ||Solo sacara el primer campo obligatorio que falte
     |FINSI;
|FPRC;

|DEFBUCLE dsarw028;
 #dsarw028#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, dsarw028;
|FIN;

|PROCESO CreaNuevo;
     |SELECT #2#10;
     #dsarm005#1 = eaArGrpMin;
     #dsarm005#2 = eaArSbGMin;
     #dsarm005#3 = eaArTipMin;
     #dsarm005#0 = 999999999;
     |LEE 000#10];
     |SI FSalida = 0;
         |LEE 000#10a;
     |SINO;
         |LEE 000#10u;
     |FINSI;

     nDocuCarpeta = 1;
     |SI FSalida = 0;  |Y  #dsarm005#1 = eaArGrpMin;
                       |Y  #dsarm005#2 = eaArSbGMin;
                       |Y  #dsarm005#3 = eaArTipMin;
         nDocuCarpeta =  #dsarm005#47 + 1;
     |FINSI;

     |SELECT #1#dsarm005;
     |LEE 000#dsarm005.u;
     |SI FSalida = 0;
        nNumDocum = #dsarm005#0 + 1;
     |SINO;
        nNumDocum = 1;
     |FINSI;

     |ABRE #dsarm100;
     |DDEFECTO #dsarm100;
     |LEE 000#dsarm100.p;
     |SI FSalida = 0;
          nUltimoDoc = #dsarm100#1 + 1;
     |SINO;
          nUltimoDoc = 1;
     |FINSI;
     |SI nUltimoDoc > nNumDocum;
          nNumDocum = nUltimoDoc;
     |FINSI;
     #dsarm100#0 = "1";
     |LEE 101#dsarm100.=;
     |SI FSalida ! 0; |GRABA 020#dsarm100.b; |FINSI;
     #dsarm100#1 = nNumDocum;
     |GRABA 020#dsarm100.a;
     |LIBERA #dsarm100;
     |CIERRA #dsarm100;

     |DDEFECTO #dsarm005;
     |SELECT #1#dsarm005;
     #dsarm005#0 = nNumDocum;
     |LEE 101#dsarm005.=;
     |SI FSalida = 0;
          |LIBERA #dsarm005;
          nNumDocum = nNumDocum + 1;
          |DDEFECTO #dsarm005;
          #dsarm005#0 = nNumDocum;
          |LEE 101#dsarm005.=;
          |SI FSalida = 0;
               nSwErrorXML = 1;         ||Como si fuera un errorXML, para que se salga
               |ACABA;
          |SINO;
               |GRABA 020#dsarm005.b;
          |FINSI;
     |SINO;
          |GRABA 020#dsarm005.b;
     |FINSI;

     #dsarm005#1 = eaArGrpMin;
     #dsarm005#2 = eaArSbGMin;
     #dsarm005#3 = eaArTipMin;
     #dsarm005#4 = ~;
     |HORA aAlfa; |QBF aAlfa; aAlfa = aAlfa % 0105;
     #dsarm005#5 = aAlfa;
     aAlfa = Usuario % 0810;
     #dsarm005#6 = aAlfa;

     nCalc = enArNumDoc;

     |SI nCalc ! 0;
        |ABRE #dsarm002;
        #dsarm002#0 = eaArGrpMin;
        |LEE 101#dsarm002.=;
        |SI FSalida ! 0;
            |DDEFECTO #dsarm002;
            #dsarm002#0 = eaArGrpMin;
            |GRABA 020#dsarm002.b;
        |FINSI;

        #dsarm002#3 = #dsarm002#3 + 1;
        |GRABA 020#dsarm002.a;
        |LIBERA #dsarm002;
        |CIERRA #dsarm002;

        |ABRE #dsarm003;
        #dsarm003#0 = eaArGrpMin;
        #dsarm003#1 = eaArSbGMin;
        |LEE 000#dsarm003.=;
        |SI FSalida ! 0;
            |DDEFECTO #dsarm003;
            #dsarm003#0 = eaArGrpMin;
            #dsarm003#1 = eaArSbGMin;
            |GRABA 020#dsarm003.b;
        |FINSI;

        #dsarm003#4 = #dsarm003#4 + 1;
        |GRABA 020#dsarm003.a;
        |LIBERA #dsarm003;
        |CIERRA #dsarm003;

        |ABRE #dsarm004;
        #dsarm004#0 = eaArGrpMin;
        #dsarm004#1 = eaArSbGMin;
        #dsarm004#2 = eaArTipMin;
        |LEE 000#dsarm004.=;
        |SI FSalida ! 0;
            #dsarm004#0 = eaArGrpMin;
            #dsarm004#1 = eaArSbGMin;
            #dsarm004#2 = eaArTipMin;
            |GRABA 020#dsarm004.b;
            |DDEFECTO #dsarm004;
        |FINSI;
        #dsarm004#25 = #dsarm004#25 + 1;
        |GRABA 020#dsarm004.a;
        |LIBERA #dsarm004;
        |CIERRA #dsarm004;

        aCaminoXML = #11#1;  |QBF aCaminoXML;
        aUltLetra = aCaminoXML % -101;
        |SI aUltLetra ! "/";
             aCaminoXML = aCaminoXML + "/";
        |FINSI;

        |SI #11#8 = "N";
            aAlfa1 = #dsarm002#2; |QBF aAlfa1;
            aCaminoXML = aCaminoXML + aAlfa1;
            |SI aAlfa1 ! ""; aCaminoXML = aCaminoXML + "/"; |FINSI;

            |SI #11#7 = "N";
                |MKDIR aCaminoXML;
            |SINO;
                |RMKDIR aCaminoXML;
            |FINSI;

            |SI #4#75 = "S";
                 fFechaSis = ~;
                 aFechaSis = fFechaSis;
                 aAAAAMM = (aFechaSis % -104) + (aFechaSis % 402);
                 aCaminoXML = aCaminoXML + aAAAAMM + "/";
                 |SI #11#7 = "N";
                      |MKDIR aCaminoXML;
                 |SINO;
                      |RMKDIR aCaminoXML;
                 |FINSI;
            |FINSI;
        |SINO;
            aAlfa1 = #dsarm002#2; |QBF aAlfa1;
            aCaminoXML = aCaminoXML + aAlfa1;
            |SI aAlfa1 ! ""; aCaminoXML = aCaminoXML + "/"; |FINSI;

            |SI #11#7 = "N";
                |MKDIR aCaminoXML;
            |SINO;
                |RMKDIR aCaminoXML;
            |FINSI;

            aAlfa1 = #dsarm003#3; |QBF aAlfa1;
            aCaminoXML = aCaminoXML + aAlfa1;
            |SI aAlfa1 ! ""; aCaminoXML = aCaminoXML + "/"; |FINSI;

            |SI #11#7 = "N";
                |MKDIR aCaminoXML;
            |SINO;
                |RMKDIR aCaminoXML;
            |FINSI;

            aAlfa1 = #dsarm004#4; |QBF aAlfa1;
            aCaminoXML = aCaminoXML + aAlfa1;
            |SI aAlfa1 ! ""; aCaminoXML = aCaminoXML + "/"; |FINSI;

            |SI #11#7 = "N";
                |MKDIR aCaminoXML;
            |SINO;
                |RMKDIR aCaminoXML;
            |FINSI;
            |SI #4#75 = "S";
                 fFechaSis = ~;
                 aFechaSis = fFechaSis;
                 aAAAAMM = (aFechaSis % -104) + (aFechaSis % 402);
                 aCaminoXML = aCaminoXML + aAAAAMM + "/";
                 |SI #11#7 = "N";
                      |MKDIR aCaminoXML;
                 |SINO;
                      |RMKDIR aCaminoXML;
                 |FINSI;
            |FINSI;
       |FINSI;
       |SI eaAplicacion = "compaq"; |Y nSwCompaqSoloPDF = 1;
           ||No hace la XML
           |HAZ SustitutoRestoPDF;
       |SINO;
           |SI nSwSoloPDF = 1;
                ||No hace la XML
                |HAZ SustitutoRestoPDF;
           |SINO;
                |HAZ RestoXML;
           |FINSI;
       |FINSI;
     |FINSI;
|FPRC;

|PROCESO SustitutoRestoPDF;
        aNombreXML = nNumDocum; |QBF aNombreXML;
        aNombreXML = (("000000000") + aNombreXML) % -109;
        aNombreSinExt = aNombreXML;

       ||Historico
       |HORA aHora;
       aUsuario = Usuario % 810;
       |ABRE #flowm006;
       #flowm006#0  = #dsarm005#0;
       #flowm006#1  = 99999;
       |LEE 000#flowm006.];
       |SI FSalida = 0;
            |LEE 000#flowm006.a;
       |SINO;
            |LEE 000#flowm006.u;
       |FINSI;
       |SI FSalida = 0; |Y #flowm006#0  = #dsarm005#0;
            nLinea = #flowm006#1 + 1;
            nSitu = #flowm006#2;
       |SINO;
            nSitu = 0;
            nLinea = 1;
       |FINSI;
       |DDEFECTO #flowm006;
       #flowm006#0  = #dsarm005#0;
       #flowm006#1  = nLinea;
       |LEE 101#flowm006.=;
       |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
       #flowm006#2  = nSitu;
       #flowm006#3  = ~;
       #flowm006#4  = aHora;
       #flowm006#5  = aUsuario;
       #flowm006#6  = "ALTA";

       enNumRegFlow = #flowm006#0;
       enSituFlow = #flowm006#2;
       |HAZ DimeDesFlow;
       #flowm006#7 = eaDesSituFlow;

       |GRABA 020#flowm006.a;
       |LIBERA #flowm006;
       |CIERRA #flowm006;

     #dsarm005#8 = eaCodCliFe;
     #dsarm005#10 = eaArCodCif;
     #dsarm005#14 = eaArNomCli;
     #dsarm005#38 = eaArNomCli;

     #dsarm005#84 = eaArTipoDoc;
     #dsarm005#85 = eaArSerDoc;
     #dsarm005#86 = enArNumDoc;
     #dsarm005#87 = eaArFecDoc;
     #dsarm005#88 = eaEmpresaFE;
     |SI nSwTipoArchi = 4;
          #dsarm005#39 = eaArSerDoc;
          #dsarm005#40 = enArNumDoc;
          #dsarm005#66 = eaArFecMin;
     |FINSI;

     #dsarm005#44 = ((#2#3  / #2#4)  + 0.48) ! 0;
     #dsarm005#45 = ((#3#4  / #3#5)  + 0.48) ! 0;
     #dsarm005#46 = ((#4#25 / #4#26) + 0.48) ! 0;
     |SI nDocuCarpeta ! 0;
          #dsarm005#47 = nDocuCarpeta;
     |FINSI;

     |SI #dsarm005#44 = 0;  #dsarm005#44 = 1;  |FINSI;
     |SI #dsarm005#45 = 0;  #dsarm005#45 = 1;  |FINSI;
     |SI #dsarm005#46 = 0;  #dsarm005#46 = 1;  |FINSI;

     #dsarm005#89 = "N";      ||Facturae
     #dsarm005#91 = "PDF";
|FPRC;

|PROCESO RestoXML;
        aNombreXML = nNumDocum; |QBF aNombreXML;
        aNombreXML = (("000000000") + aNombreXML) % -109;
        aNombreSinExt = aNombreXML;
        aNombreXML = aNombreXML + ".xml";
        aAlfa = aCaminoXML + aNombreXML;
        |HAZ CreaXML;

        eaArCamXML = aBaseTempo + aNombreXML;
        |SI nSwXMLCorrecta = 0;
             nSwErrorXML = 1;
             |SI enSwLogXMLMete = 1;
                  eaTextoLog = "Error: Error al crear Facturae.XML " + eaArCamXML;
                  |HAZ MeteLogXML;
             |SINO;
                  aTexto1 = "Error al Crear XML ";
                  aTexto2 = eaArCamXML;
                  |HAZ SacaMensaje;
             |FINSI;
             |ACABA;
        |FINSI;

        |BUCLE dsarw028;
        |SI nSwXMLCorrecta = 0;
             nSwErrorXML = 1;
             |SI enSwLogXMLMete = 1;
                  eaTextoLog = "Error: Factura INCOMPLETA. " + aObligatorios;
                  |HAZ MeteLogXML;
             |SINO;
                  aTexto1 = "FACTURA INCOMPLETA. ";
                  aTexto2 = "0000Factura " + eaSerieFE;  |QBF aTexto2;
                  aTexto2 = aTexto2 + "/" + eaNumeroFE;
                  aTexto3 = aObligatorios;
                  |HAZ SacaMensaje;
             |FINSI;

             |ACABA;
        |FINSI;

        |SI #11#43 = "S";
            aCarpetaDestino = #11#44;
            |QBF aCarpetaDestino;
            |SI aCarpetaDestino ! "";
                 aLetra = aCarpetaDestino % -101;
                 |SI aLetra ! "/";
                    aCarpetaDestino = aCarpetaDestino + "/";
                 |FINSI;

                 |MKDIR aCarpetaDestino;
                 aDestino = aCarpetaDestino + aNombreXML;
                 |COPIA_FICHERO eaArCamXML, aDestino;
            |FINSI;
        |FINSI;

        aAlfa = aCaminoXML + aNombreXML;
        |SI #11#7 = "N";
            |COPIA_FICHERO eaArCamXML, aAlfa;
            nSalidaHis = FSalida;
        |SINO;
            |HAZ DimeUnidad;
            aPathRemoto = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aPathRemoto;
            aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aPathRemoto;
            aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + aNombreXML;

            aBorraCache = aPathRemoto; |QBF aBorraCache;

            |SI aIPRemoto ! "";
                |ENVIA_FICHERO eaArCamXML, aPathRemoto;
                nSalidaHis = FSalida;
            |SINO;
                |COPIA_FICHERO eaArCamXML, aPathRemoto;
                nSalidaHis = FSalida;
            |FINSI;

            |RCOPIA_FICHERO aPathRemoto, aAlfa;

            |RFBORRA aPathRemoto;
       |FINSI;


       ||Historico
       |HORA aHora;
       aUsuario = Usuario % 810;
       |ABRE #flowm006;
       #flowm006#0  = #dsarm005#0;
       #flowm006#1  = 99999;
       |LEE 000#flowm006.];
       |SI FSalida = 0;
            |LEE 000#flowm006.a;
       |SINO;
            |LEE 000#flowm006.u;
       |FINSI;
       |SI FSalida = 0; |Y #flowm006#0  = #dsarm005#0;
            nLinea = #flowm006#1 + 1;
            nSitu = #flowm006#2;
       |SINO;
            nSitu = 0;
            nLinea = 1;
       |FINSI;
       |DDEFECTO #flowm006;
       #flowm006#0  = #dsarm005#0;
       #flowm006#1  = nLinea;
       |LEE 101#flowm006.=;
       |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
       #flowm006#2  = nSitu;
       #flowm006#3  = ~;
       #flowm006#4  = aHora;
       #flowm006#5  = aUsuario;
       #flowm006#6  = "RESULTADO ALTA [" + nSalidaHis + "]";

       enNumRegFlow = #flowm006#0;
       enSituFlow = #flowm006#2;
       |HAZ DimeDesFlow;
       #flowm006#7 = eaDesSituFlow;

       |GRABA 020#flowm006.a;
       |LIBERA #flowm006;
       |CIERRA #flowm006;

       |SI #11#7 = "N";
           |XABRE "E", aAlfa, nHandle;
       |SINO;
           |XABRE "EC", aAlfa, nHandle;
       |FINSI;

       |SI FSalida < 0;
           nSwErrorXML = 1;
           |SI enSwLogXMLMete = 1;
                eaTextoLog = "Error: Problemas al archivar el documento: ";
                |HAZ MeteLogXML;
                eaTextoLog = "       Origen  : " + eaArCamXML;
                |HAZ MeteLogXML;
                eaTextoLog = "       Destino : " + aAlfa;
                |HAZ MeteLogXML;
           |SINO;
               aTexto1 = "Problemas al archivar el documento";
               aTexto2 = "Origen : " + eaArCamXML;
               aTexto3 = "Destino: " + aAlfa;
               |HAZ SacaMensaje;
           |FINSI;
       |SINO;
           |FBORRA eaArCamXML;
       |FINSI;

     #dsarm005#8 = eaCodCliFe;
     #dsarm005#10 = eaArCodCif;
     #dsarm005#14 = eaArNomCli;
     #dsarm005#38 = eaArNomCli;
     |SI nSwTipoArchi = 2;
          #dsarm005#84 = eaArTipoDoc;
          #dsarm005#85 = eaArSerDoc;
          #dsarm005#86 = enArNumDoc;
          #dsarm005#87 = eaArFecDoc;
          #dsarm005#88 = eaEmpresaFE;
     |FINSI;
     |SI nSwTipoArchi = 3;
          #dsarm005#84 = eaArTipoDoc;
          #dsarm005#85 = eaArSerDoc;
          #dsarm005#86 = enArNumDoc;
          #dsarm005#87 = eaArFecDoc;
          #dsarm005#88 = eaEmpresaFE;
     |FINSI;
     |SI nSwTipoArchi = 4;
          #dsarm005#39 = eaArSerDoc;
          #dsarm005#40 = enArNumDoc;
          #dsarm005#66 = eaArFecMin;

          #dsarm005#84 = eaArTipoDoc;
          #dsarm005#85 = eaArSerDoc;
          #dsarm005#86 = enArNumDoc;
          #dsarm005#87 = eaArFecDoc;
          #dsarm005#88 = eaEmpresaFE;
     |FINSI;
/*
     |SI nSwTipoArchi = 5; |O nSwTipoArchi = 6; |O nSwTipoArchi = 7; |O nSwTipoArchi = 8;
      |O nSwTipoArchi = 9; |O nSwTipoArchi = 10; |O nSwTipoArchi = 11;
*/

     |SI nSwTipoArchi ] 5;
          #dsarm005#84 = eaArTipoDoc;
          #dsarm005#85 = eaArSerDoc;
          #dsarm005#86 = enArNumDoc;
          #dsarm005#87 = eaArFecDoc;
          #dsarm005#88 = eaEmpresaFE;
     |FINSI;

     #dsarm005#44 = ((#2#3  / #2#4)  + 0.48) ! 0;
     #dsarm005#45 = ((#3#4  / #3#5)  + 0.48) ! 0;
     #dsarm005#46 = ((#4#25 / #4#26) + 0.48) ! 0;
     |SI nDocuCarpeta ! 0;
          #dsarm005#47 = nDocuCarpeta;
     |FINSI;

     |SI #dsarm005#44 = 0;  #dsarm005#44 = 1;  |FINSI;
     |SI #dsarm005#45 = 0;  #dsarm005#45 = 1;  |FINSI;
     |SI #dsarm005#46 = 0;  #dsarm005#46 = 1;  |FINSI;

     #dsarm005#88 = eaEmpresaFE;
     #dsarm005#89 = "S";      ||Facturae
     #dsarm005#91 = aVersionXML;
|FPRC;

|PROCESO Existente;
   |SI PRMNT_nOpc ! 3; |Y PRMNT_nOpc ! 4;

     |SI eaAplicacion ! "gesracor";
          |SI eaAplicacion ! "xml";
              |SI #11#193 = "S";
                   FSalida = 0;
                   aCrea3 = "Doc. " + #dsarm005#0 + " existe.Ubicacion?: ";

                   |MENU aCrea;
                   |SI FSalida < 1; |O FSalida > 4;
                       ||Para que cancele el proceso.
                        nSwErrorXML = 1;
                       |ACABA;
                    |FINSI;
               |SINO;
                    FSalida = 4;
               |FINSI;
               PRMNT_nOpc = FSalida;
           |SINO;
               ||Siempre creamos un nuevo documento.
               PRMNT_nOpc = 1;
           |FINSI;
     |SINO;
          FSalida = 0;
          aPopup1 = "-1";  || Si fuera -1 en la posicion

          aPopup2  = 2;
          aPopup3  = "(N) Ubicacion Nueva";
          aPopup4  = "(A) Ubicacion Actual";

          IaPopup  = aPopup1  <-;
          |ESPECIFICA "TRACKPOPUP", aPopup;
          |SI FSalida ! 0;
              IaPopup  = aPopup3  <-;
              IaPopup  = IaPopup + (FSalida - 1);

              aAlfa = aPopup % 201;
              |SI aAlfa = "A";
                   FSalida = 2;
              |SINO;
                   FSalida = 1;
              |FINSI;
          |FINSI;
          PRMNT_nOpc = FSalida;

          |SI PRMNT_nOpc = 0;
               |MENAV "0000FacturaE. Proceso cancelado.";

               nSwErrorXML = 1;
          |FINSI;
     |FINSI;
   |FINSI;

   |SI PRMNT_nOpc = 1; |O PRMNT_nOpc = 3;
      |LIBERA #dsarm005;
      |HAZ CreaNuevo;
      |SI nSwErrorXML = 1;
          |BORRA 020#dsarm005.a;
          |LIBERA #dsarm005;
          |ACABA;
      |FINSI;
   |FINSI;

   |SI PRMNT_nOpc = 2; |O PRMNT_nOpc = 4;
      aAlfa = #dsarm005#7;         |QBF aAlfa;
      aAlfa = aAlfa + #dsarm005#9; |QBF aAlfa;

      eaArCamXML = aAlfa;

      |SI #11#7 ! "N";
          |SI #dsarm001#7 = "N";
               |HAZ DimeUnidad;
               aPathRemoto = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aPathRemoto;
               aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aPathRemoto;
               aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + #dsarm005#9;  |QBF aPathRemoto;
          |SINO;
               aPathRemoto = eaUnidadBasico + "\DOCUMENTOS";              |RMKDIR aPathRemoto;
               aPathRemoto = eaUnidadBasico + "\DOCUMENTOS\DSARCHI";      |RMKDIR aPathRemoto;
               aPathRemoto = eaUnidadBasico + "\DOCUMENTOS\DSARCHI\" + #dsarm005#9;  |QBF aPathRemoto;
          |FINSI;

          aBorraCache = aPathRemoto;
          |QBF aBorraCache;

          |SI aIPRemoto ! "";
              |ENVIA_FICHERO eaArCamXML, aPathRemoto;
          |SINO;
              |COPIA_FICHERO eaArCamXML, aPathRemoto;
          |FINSI;
          nSalidaHis = FSalida;

          ||Historico
          |HORA aHora;
          aUsuario = Usuario % 810;
          |ABRE #flowm006;
          #flowm006#0  = #dsarm005#0;
          #flowm006#1  = 99999;
          |LEE 000#flowm006.];
          |SI FSalida = 0;
               |LEE 000#flowm006.a;
          |SINO;
               |LEE 000#flowm006.u;
          |FINSI;
          |SI FSalida = 0; |Y #flowm006#0  = #dsarm005#0;
               nLinea = #flowm006#1 + 1;
               nSitu = #flowm006#2;
          |SINO;
               nSitu = 1;
               nLinea = 1;
          |FINSI;
          |DDEFECTO #flowm006;
          #flowm006#0  = #dsarm005#0;
          #flowm006#1  = nLinea;
          |LEE 101#flowm006.=;
          |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
          #flowm006#2  = nSitu;
          #flowm006#3  = ~;
          #flowm006#4  = aHora;
          #flowm006#5  = aUsuario;
          #flowm006#6  = "RESULTADO ALTA [" + nSalidaHis + "]";

          enNumRegFlow = #flowm006#0;
          enSituFlow = #flowm006#2;
          |HAZ DimeDesFlow;
          #flowm006#7 = eaDesSituFlow;

          |GRABA 020#flowm006.a;
          |LIBERA #flowm006;
          |CIERRA #flowm006;

          |RCOPIA_FICHERO aPathRemoto, aAlfa;

          |RFBORRA aPathRemoto;
     |FINSI;

     |SI #11#7 = "N";
         |XABRE "E", aAlfa, nHandle;
     |SINO;
         |XABRE "EC", aAlfa, nHandle;
     |FINSI;

     |SI FSalida ] 0;
         |FBORRA eaArCamXML;
     |FINSI;

     aCaminoXML = #dsarm005#7;
     |QBF aCaminoXML;
     aNombreXML = #dsarm005#9;
     |QBF aNombreXML;
     #dsarm005#41 = ~;
     |HORA aAlfa; |QBF aAlfa; aAlfa = aAlfa % 0105;
     #dsarm005#42 = aAlfa;
     aAlfa = Usuario; |QBF aAlfa; aAlfa = aAlfa % 0810;
     #dsarm005#43 = aAlfa;

     |SI eaAplicacion = "compaq"; |Y nSwCompaqSoloPDF = 1;
          ||No hace la XML
          |HAZ SustitutoRestoPDF;
     |SINO;
          |SI nSwSoloPDF = 1;
               ||No hace la XML
               |HAZ SustitutoRestoPDF;
          |SINO;
               |HAZ RestoXML;
          |FINSI;
     |FINSI;

   |FINSI;
|FPRC;

|PROCESO VerificaDireCorreo;
     aUno = "";
     aDos = "";
     nArrobas = 0;
     aLong = aEmail % A0;
     nLong = aLong;
     |PARA nCampo = 1; |SI nCampo [ nLong; |HACIENDO nCampo = nCampo + 1;
          nSaca = (100 * nCampo) + 1;
          aSaca = nSaca;
          aLetra = aEmail % aSaca;

          nSwLetra = 1;
          |HAZ VerificaLetra;
          |SI nSwLetra = 0;
               nSwEmailValido = 0;
               |SAL;
          |FINSI;
          |SI aLetra = "@";
               nArrobas = nArrobas + 1;
          |FINSI;

          |SI nArrobas > 1;
               nSwEmailValido = 0;
               |SAL;
          |FINSI;

          |SI nArrobas = 0;
               aUno = aUno + aLetra;
          |SINO;
               |SI aLetra ! "@";
                    aDos = aDos + aLetra;
               |FINSI;
          |FINSI;
     |SIGUE;
     |SI nArrobas = 0;
          nSwEmailValido = 0;
     |FINSI;
     |QBF aUno;
     |QBF aDos;
     |SI aUno = ""; |O aDos = ""; |O aUno = "."; |O aDos = ".";
      |O aUno = "-"; |O aDos = "-"; |O aUno = "_"; |O aDos = "_";
          nSwEmailValido = 0;
     |FINSI;

     aAux = aDos - ".";
     |SI aAux = aDos;
          nSwEmailValido = 0;
     |FINSI;
|FPRC;

|PROCESO VerificaLetra;
     |SI aLetra = "."; |O aLetra = "-"; |O aLetra = "_"; |O aLetra = "@";
          nSwLetra = 1;
     |SINO;
          |SI aLetra ] "a"; |Y aLetra [ "z";
               nSwLetra = 1;
          |SINO;
               |SI aLetra ] "A"; |Y aLetra [ "Z";
                    nSwLetra = 1;
               |SINO;
                    |SI aLetra ] "0"; |Y aLetra [ "9";
                         nSwLetra = 1;
                    |SINO;
                         nSwLetra = 0;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Ubicacion;
     nSwErrorXML = 0;

     #dsarm005#0 = nNumDocum;
     |LEE 101#dsarm005.=;
     |SI FSalida ! 0;  |O nNumDocum = 0;
         |HAZ CreaNuevo;
         |SI eaAplicacion = "compaq"; |Y nSwCompaqSoloPDF = 1;
              ||Ahora se bloquea desde CreaNuevo
              ||GRABA 020#dsarm005.b;
         |SINO;
              |SI nSwSoloPDF = 1;
                   ||Ahora se bloquea desde CreaNuevo
                   ||GRABA 020#dsarm005.b;
              |SINO;
                   |SI nSwErrorXML = 1;
                         |BORRA 020#dsarm005.a;
                         |LIBERA #dsarm005;
                   |SINO;
                         ||Ahora se bloquea desde CreaNuevo
                         ||GRABA 020#dsarm005.b;
                   |FINSI;
              |FINSI;
         |FINSI;
     |SINO;
         |HAZ Existente;
     |FINSI;

     |SI nSwErrorXML = 0;
           |SI eaAplicacion = "compaq"; |Y nSwCompaqSoloPDF = 1;
               ||Falta cargar las variables para poder copiar el pdf a donde corresponda
               ||aCaminoXML
               ||aNombreSinExt
               aNombreXML = nNumDocum; |QBF aNombreXML;
               aNombreXML = (("000000000") + aNombreXML) % -109;
               aNombreSinExt = aNombreXML;
               aNombreXML = aNombreSinExt + ".pdf";
           |SINO;
                |SI nSwSoloPDF = 1;
                     ||Falta cargar las variables para poder copiar el pdf a donde corresponda
                     ||aCaminoXML
                     ||aNombreSinExt
                     aNombreXML = nNumDocum; |QBF aNombreXML;
                     aNombreXML = (("000000000") + aNombreXML) % -109;
                     aNombreSinExt = aNombreXML;
                     aNombreXML = aNombreSinExt + ".pdf";
                |SINO;
                     |SI #dsarm001#43 = "S";
                          |SI aCarpetaDestino ! ""; |Y aCarpetaDestino ! "/";
                              aTexto1 = "Factura XML almacenada SIN FIRMAR en";
                              aTexto2 = aCarpetaDestino;
                              |HAZ SacaMensaje;
                          |FINSI;
                       ||No tiene que firmar la factura.
                     |SINO;
                          |SI eaFirmarFE = "S";
                               aOrigenFE = aCaminoXML + aNombreXML;
                               |HAZ DimeUnidad;
                               aDestinoFE = eaUnidad + ":\DOCUMENTOS\";              |RMKDIR aDestinoFE;
                               aDestinoFE = eaUnidad + ":\DOCUMENTOS\DSARCHI\";      |RMKDIR aDestinoFE;
                               aDestinoFE = aDestinoFE + aNombreXML;

                               aBorraCache = aDestinoFE;
                               |QBF aBorraCache;

                               |SI #11#7 = "S";
                                   |RCOPIA_FICHERO aOrigenFE, aDestinoFE;
                               |SINO;
                                   |SI aIPRemoto ! "";
                                       |ENVIA_FICHERO aOrigenFE, aDestinoFE;
                                   |SINO;
                                       |COPIA_FICHERO aOrigenFE, aDestinoFE;
                                   |FINSI;
                              |FINSI;

                              eaFEHtmlAux = "";
                              |HAZ LaFirma;
                              |SI nSwFirmaOK = 1;
                                  #dsarm005#90 = "S";

                                  |HAZ DimeUnidad;
                                  aNombreXML = aNombreSinExt + ".xsig";
                                  aOrigenFE = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + aNombreXML;
                                  aDestinoFE = aCaminoXML + aNombreXML;

                                  |SI #11#7 = "S";
                                      |RCOPIA_FICHERO aOrigenFE, aDestinoFE;
                                  |SINO;
                                      |SI aIPRemoto ! "";
                                          |RECIBE_FICHERO aOrigenFE, aDestinoFE;
                                      |SINO;
                                          |COPIA_FICHERO aOrigenFE, aDestinoFE;
                                      |FINSI;
                                 |FINSI;
                                nSalidaHis = FSalida;

                                ||Historico
                                |HORA aHora;
                                aUsuario = Usuario % 810;
                                |ABRE #flowm006;
                                #flowm006#0  = #dsarm005#0;
                                #flowm006#1  = 99999;
                                |LEE 000#flowm006.];
                                |SI FSalida = 0;
                                     |LEE 000#flowm006.a;
                                |SINO;
                                     |LEE 000#flowm006.u;
                                |FINSI;
                                |SI FSalida = 0; |Y #flowm006#0  = #dsarm005#0;
                                     nLinea = #flowm006#1 + 1;
                                     nSitu = #flowm006#2;
                                |SINO;
                                     nSitu = 1;
                                     nLinea = 1;
                                |FINSI;
                                |DDEFECTO #flowm006;
                                #flowm006#0  = #dsarm005#0;
                                #flowm006#1  = nLinea;
                                |LEE 101#flowm006.=;
                                |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
                                #flowm006#2  = nSitu;
                                #flowm006#3  = ~;
                                #flowm006#4  = aHora;
                                #flowm006#5  = aUsuario;
                                #flowm006#6  = "RESULTADO ALTA [" + nSalidaHis + "]";

                                enNumRegFlow = #flowm006#0;
                                enSituFlow = #flowm006#2;
                                |HAZ DimeDesFlow;
                                #flowm006#7 = eaDesSituFlow;

                                |GRABA 020#flowm006.a;
                                |LIBERA #flowm006;
                                |CIERRA #flowm006;

                              |FINSI;
                              |SI eaFEHtmlAux ! ""; |Y nSwSoloPDF = 0;
                                  aOrigenFE = eaFEHtmlAux;
                                  aDestinoFE = aCaminoXML + aNombreSinExt + ".html";

                                  |SI #11#7 = "S";
                                      |RCOPIA_FICHERO aOrigenFE, aDestinoFE;
                                  |SINO;
                                      |SI aIPRemoto ! "";
                                          |RECIBE_FICHERO aOrigenFE, aDestinoFE;
                                      |SINO;
                                          |COPIA_FICHERO aOrigenFE, aDestinoFE;
                                      |FINSI;
                                 |FINSI;
                                 #dsarm005#92 = aNombreSinExt + ".html";
                              |FINSI;
                          |FINSI;
                     |FINSI;
                |FINSI;
           |FINSI;
           ||FE2
           aFicheroPDF = eaFacturaPDFFe;
           |QBF aFicheroPDF;
           |SI aFicheroPDF ! "";   ||@PDF
                eaOrigen    = aCaminoXML + aNombreSinExt + ".pdf";
                eaDestino   = aFicheroPDF;
                enSwIOCorrecta = 0;
                |HAZ RecibeConMD5;
                |SI enSwIOCorrecta = 0;
                    aTexto1 = "Ha habido un error al transferir la factura PDF al servidor.";
                    aTexto2 = "Revise Permisos y espacio disponible.";
                    aTexto3 = eaOrigen;
                    aTexto4 = eaDestino;
                    |HAZ SacaMensaje;
                    |ACABA;
                |FINSI;
                |SI eaAplicacion = "compaq"; |Y nSwCompaqSoloPDF = 1;
                     #dsarm005#96 = "";
                |SINO;
                     |SI nSwSoloPDF = 1;
                          #dsarm005#96 = "";
                     |SINO;
                          #dsarm005#96 = aNombreSinExt + ".pdf";
                     |FINSI;
                |FINSI;

                |SI #dsarm001#181 = "S";
                     |RFBORRA aFicheroPDF;
                |SINO;
                     ||Ahora en lugar de borrarlo lo movemos a c:\documentos\dsarchi
                     |HAZ DimeUnidad;
                     aDestinoDSA = eaUnidad + ":\DOCUMENTOS\DSARCHI\";
                     |RMKDIR aDestinoDSA;
                     aPDFenDSA = aDestinoDSA + aNombreSinExt + ".pdf";
                     |RRENOMBRA_FICHERO aFicheroPDF, aPDFenDSA;
                |FINSI;
           |FINSI;

           ||Dejar en Ubicacion predeterminada.

           #dsarm005#77 = #dsarw010#1;
           #dsarm005#78 = eaDirDesFE;

           #dsarm005#7 = aCaminoXML;
           #dsarm005#9 = aNombreXML;

           |GRABA 020#dsarm005.a; |LIBERA #dsarm005;

           |SI enSwLogXMLMete = 1;
                eaTextoLog = "Num. Registro DSARCHI: " + #dsarm005#0;
                |HAZ MeteLogXML;
           |FINSI;

           |SI #dsarm001#43 = "N";
                |SI eaSwEnvioCorreo = "S";
                   ||Verificar si tengo direccion de correo y si esta es correcta.
                   aEmail = eaDirDesFE;
                   |QBF aEmail;
                   |SI aEmail = "";
                        |SI enSwLogXMLMete = 1;
                             eaTextoLog = "Error: No es posible el envio por correo."
                             |HAZ MeteLogXML;
                             eaTextoLog = "       No ha indicado dirección de correo en el cliente.";
                             |HAZ MeteLogXML;
                        |SINO;
                             aNomEmpresa = eaArNomCli % 156;
                             aFactura    = eaSerieFE;  |QBF aFactura;
                             |SI aFactura = "";  aFactura = " ";  |FINSI;
                             aFactura    = aFactura + "/" + eaNumeroFE;  |QBF aFactura;

                             aTexto1 = "No es posible el envio por correo."
                             aTexto2 = " No ha indicado dirección de correo en el cliente.";
                             aTexto3 = "Empresa: " + eaArCodCli + " " + aNomEmpresa;
                             aTexto4 = "Factura: " + aFactura;
                             |HAZ SacaMensaje;
                        |FINSI;
                   |SINO;

                        ||Ahora pueden venir mas de una direccion de correo separadas por ";"
                        aAuxAlfa = aEmail - ";";
                        |SI aAuxAlfa = aEmail;
                             ||Una sola direccion de correo
                             nSwEmailValido = 1;
                             |HAZ VerificaDireCorreo;
                        |SINO;
                             ||Varias direcciones separadas por ";"
                             nSwEmailValido = 1;
                             aDirCompleta = aEmail;
                             |QBF aDirCompleta;

                             aLong  = aDirCompleta % A0;
                             nLongTotal  = aLong;
                             aDirec = "";
                             |PARA nPosi = 1;  |SI nPosi [ nLongTotal;  |HACIENDO nPosi = nPosi + 1;
                                   nPos   = (nPosi * 100) + 1;
                                   aCarac = aDirCompleta % nPos;

                                   |SI aCarac = ";";
                                        aEmail = aDirec;
                                        |HAZ VerificaDireCorreo;
                                        aDirec = "";
                                        |SI nSwEmailValido = 0;
                                             |SAL;
                                        |FINSI;
                                   |SINO;
                                        aDirec = aDirec + aCarac;
                                   |FINSI;
                             |SIGUE;

                             |SI aDirec ! "";
                                  aEmail = aDirec;
                                  |HAZ VerificaDireCorreo;
                             |FINSI;
                             aEmail = aDirCompleta;
                        |FINSI;

                        |SI nSwEmailValido = 1;
                             enDocumento = #dsarm005#0;
                             enErrorCorreo = 1;
                             |SUB_EJECUTA_NP "dsarw010;AUTODESDED9";
                        |SINO;
                             |SI enSwLogXMLMete = 1;
                                  |SI nSwTipoArchi = 2;
                                       aAuxEmail = aEmail % 146;
                                       |QBF aAuxEmail;
                                       aTexto1 = "Error: La cuenta de correo electronico " + aAuxEmail;
                                       |QBF aTexto1;

                                       aNomEmpresa = eaArNomCli;  |QBF aNomEmpresa;
                                       aTexto2 = "de la empresa " + eaArCodCli + ": " + aNomEmpresa + ", no es valida";

                                       aFactura = eaSerieFE;
                                       |QBF aFactura;
                                       |SI aFactura = "";
                                            aFactura = " ";
                                       |FINSI;
                                       aFactura = aFactura + "/" + eaNumeroFE;
                                       |QBF aFactura;
                                       aTexto3 = "Por favor, revise el dato y vuelva a imprimir la factura: " + aFactura;

                                       eaTextoLog = aTexto1;
                                       |HAZ MeteLogXML;
                                       eaTextoLog = aTexto2;
                                       |HAZ MeteLogXML;
                                       eaTextoLog = aTexto3;
                                       |HAZ MeteLogXML;
                                  |SINO;
                                       eaTextoLog = "Error: La dirección de e-mail especificada no es correcta [" + aEmail + "]";
                                       |HAZ MeteLogXML;
                                  |FINSI;
                             |SINO;
                                  aAuxEmail = aEmail % 146;
                                  |QBF aAuxEmail;
                                  aTexto1 = "La cuenta de correo electronico " + aAuxEmail;
                                  |QBF aTexto1;

                                  aNomEmpresa = eaArNomCli;  |QBF aNomEmpresa;
                                  aTexto2 = "de la empresa " + eaArCodCli + ": " + aNomEmpresa + ", no es valida";

                                  aFactura = eaSerieFE;
                                  |QBF aFactura;
                                  |SI aFactura = "";
                                      aFactura = " ";
                                  |FINSI;
                                  aFactura = aFactura + "/" + eaNumeroFE;
                                  |QBF aFactura;
                                  aTexto3 = "Por favor, revise el dato y vuelva a imprimir la factura: " + aFactura;

                                  |HAZ SacaMensaje;
                             |FINSI;
                        |FINSI;
                   |FINSI;
                |FINSI;
           |FINSI;

           ||Tema del OCR.
           enSwDesde9 = 1;
           aAlfa = "dsarz013;" + #dsarm005#0;
           |SUB_EJECUTA aAlfa;
           aAlfa = "dsarz030;" + #dsarm005#0;
           |SUB_EJECUTA aAlfa;
           enSwDesde9 = 0;
     |FINSI;
|FPRC;

|PROCESO TraeLocalExeFirmar;
   |HAZ DimeUnidad;
   eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "firmador.exe";

   |DBASE aBase;
   |QBF aBase;
   aBaseDll = aBase + "dlls/";
   eaOrigen = aBaseDll + "firmador.exe";
   |HAZ EnviaFicheroConMD5;

   eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "dsabreextension.exe";
   eaOrigen = aBaseDll + "dsabreextension.exe";
   |HAZ EnviaFicheroConMD5;

   eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "msvcr100.dll";
   eaOrigen = aBaseDll + "msvcr100.dll";
   |HAZ EnviaFicheroConMD5;
|FPRC;

|PROCESO TraeHojasEstilo;
     |DBASE aPathBase;
     |QBF aPathBase;
     aAuxVersion = #dsarm005#91;
     |QBF aAuxVersion;
     |SI aAuxVersion = "3.1";
          eaOrigen = aPathBase + "plugins/dsfacturae310.css";
     |SINO;
          |SI aAuxVersion = "3.2";
               eaOrigen = aPathBase + "plugins/dsfacturae320.css";
          |SINO;
               eaOrigen = aPathBase + "plugins/dsfacturae300.css";
          |FINSI;
     |FINSI;

     |HAZ DimeUnidad;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aPathRemoto;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aPathRemoto;
     |SI aAuxVersion = "3.1";
          eaDestino = aPathRemoto + "\dsfacturae310.css";
     |SINO;
          |SI aAuxVersion = "3.2";
               eaDestino = aPathRemoto + "\dsfacturae320.css";
          |SINO;
               eaDestino = aPathRemoto + "\dsfacturae300.css";
          |FINSI;
     |FINSI;
     |HAZ EnviaFicheroConMD5;

     nHayEmpXSL = 0;
     nEmpresa = #dsarm005#88;
     enEmpCorreo = nEmpresa;
     aPrefijo = "emp" + nEmpresa;
     |SI nEmpresa ! 0;
          |ABRE #dsarm057;
          |DDEFECTO #dsarm057;
          #dsarm057#0 = nEmpresa;
          |LEE 000#dsarm057.=;
          |SI FSalida = 0;
               nHayEmpXSL = 1;
               |SI #dsarm057#5 = "S";
                    |SI aAuxVersion = "3.1";
                         eaOrigen = aPathBase + "plugins/" + aPrefijo + "dscustom310.xsl";
                    |SINO;
                         |SI aAuxVersion = "3.2";
                              eaOrigen = aPathBase + "plugins/" + aPrefijo + "dscustom320.xsl";
                         |SINO;
                              eaOrigen = aPathBase + "plugins/" + aPrefijo + "dscustom300.xsl";
                         |FINSI;
                    |FINSI;
                    |XABRE "E", eaOrigen, nHandle;
                    |SI FSalida = 0;
                         |SI aAuxVersion = "3.1";
                              aNomFicXSL = aPrefijo + "dscustom310.xsl";
                         |SINO;
                              |SI aAuxVersion = "3.2";
                                   aNomFicXSL = aPrefijo + "dscustom320.xsl";
                              |SINO;
                                   aNomFicXSL = aPrefijo + "dscustom300.xsl";
                              |FINSI;
                         |FINSI;
                    |SINO;
                         |SI aAuxVersion = "3.1";
                              aNomFicXSL = "dsfacturae310.xsl";
                         |SINO;
                              |SI aAuxVersion = "3.2";
                                   aNomFicXSL = "dsfacturae320.xsl";
                              |SINO;
                                   aNomFicXSL = "dsfacturae300.xsl";
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |SINO;
                    |SI aAuxVersion = "3.1";
                         aNomFicXSL = "dsfacturae310.xsl";
                    |SINO;
                         |SI aAuxVersion = "3.2";
                              aNomFicXSL = "dsfacturae320.xsl";
                         |SINO;
                              aNomFicXSL = "dsfacturae300.xsl";
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |CIERRA #dsarm057;
     |FINSI;

     |SI nHayEmpXSL = 0;
          |SI #dsarm001#100 = "S";
               |SI aAuxVersion = "3.1";
                    eaOrigen = aPathBase + "plugins/dscustom310.xsl";
               |SINO;
                    |SI aAuxVersion = "3.2";
                         eaOrigen = aPathBase + "plugins/dscustom320.xsl";
                    |SINO;
                         eaOrigen = aPathBase + "plugins/dscustom300.xsl";
                    |FINSI;
               |FINSI;
               |XABRE "E", eaOrigen, nHandle;
               |SI FSalida = 0;
                    |SI aAuxVersion = "3.1";
                         aNomFicXSL = "dscustom310.xsl";
                    |SINO;
                         |SI aAuxVersion = "3.2";
                              aNomFicXSL = "dscustom320.xsl";
                         |SINO;
                              aNomFicXSL = "dscustom300.xsl";
                         |FINSI;
                    |FINSI;
               |SINO;
                    |SI aAuxVersion = "3.1";
                         aNomFicXSL = "dsfacturae310.xsl";
                    |SINO;
                         |SI aAuxVersion = "3.2";
                              aNomFicXSL = "dsfacturae320.xsl";
                         |SINO;
                              aNomFicXSL = "dsfacturae300.xsl";
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI aAuxVersion = "3.1";
                    aNomFicXSL = "dsfacturae310.xsl";
               |SINO;
                    |SI aAuxVersion = "3.2";
                         aNomFicXSL = "dsfacturae320.xsl";
                    |SINO;
                         aNomFicXSL = "dsfacturae300.xsl";
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     eaOrigen = aPathBase + "plugins/" + aNomFicXSL;

     aPathRemoto = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aPathRemoto;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aPathRemoto;
     |SI aAuxVersion = "3.1";
          eaDestino = aPathRemoto + "\dsfacturae310.xsl";
     |SINO;
          |SI aAuxVersion = "3.2";
               eaDestino = aPathRemoto + "\dsfacturae320.xsl";
          |SINO;
               eaDestino = aPathRemoto + "\dsfacturae300.xsl";
          |FINSI;
     |FINSI;
     |HAZ EnviaFicheroConMD5;
|FPRC;


|PROCESO LaFirma;
   |QBF eaDniFirmador;
   |SI eaDniFirmador = "";
        |SI enSwLogXMLMete = 1;
             eaTextoLog = "Error: No es posible Firmar esta Factura. DNI/CIF emisor vacia";
             |HAZ MeteLogXML;
        |SINO;
             aTexto1 = "No es posible Firmar esta Factura."
             aTexto2 = "DNI/CIF emisor vacia";
             |HAZ SacaMensaje;
        |FINSI;
        |ACABA;
   |FINSI;

   |HAZ TraeLocalExeFirmar;
   |HAZ TraeHojasEstilo;

   |HAZ DimeUnidad;
   enSwHayJava = 0;
   |HAZ VerificaJava;         ||Verifica si tenemos java instalado en la maquina

   |SI enSwHayJava = 0;

        nSwInstalaJava = 1;
        |ESPECIFICA "VERSION_WINDOWS", version;
        aInfo = version1;
        aInfo = aInfo % 104;
        |SI aInfo = "NT 5";             ||XP, No actualizamos la version.
             nSwInstalaJava = 0;
        |FINSI;

        |SI nSwInstalaJava = 1;
             |HAZ DimeUnidad;
             ||eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "jre-6u10-windows-i586-p-s.exe";
             eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "jre-8u31-windows-i586.exe";

             |DBASE aBase;
             |QBF aBase;
             aBaseDll = aBase + "dlls/";
             ||eaOrigen = aBaseDll + "jre-6u10-windows-i586-p-s.exe";
             eaOrigen = aBaseDll + "jre-8u31-windows-i586.exe";
             |HAZ EnviaFicheroConMD5;

             aEjecuta = eaDestino;
             |RSYSTEM aEjecuta;
        |FINSI;
   |FINSI;

   nSwFirmaOK = 0;
   eaErrorFirma = "";
   eaBaseFirmador = aBaseBin;
   |HAZ DimeUnidad;
   eaFEOrigen = eaUnidad + ":\documentos\dsarchi\" + aNombreXML;
   eaFEDestino = eaFEOrigen + ".xsig";

   eaNombreXML = aNombreXML;
   |QBF eaDniFirmador;
   |SI eaDniFirmador ! "";
          |HAZ FirmaDocumentoXML;
          |SI eaErrorFirma ! "";
               |SI enSwLogXMLMete = 1;
                    eaTextoLog = "Error: " + eaErrorFirma;
                    |HAZ MeteLogXML;
                    eaTextoLog = "Error: El documento se quedara sin firmar.";
                    |HAZ MeteLogXML;
               |SINO;
                    aTexto1 = "Error: " + eaErrorFirma;
                    aTexto2 = "El documento se quedara sin firmar.";
                    |HAZ SacaMensaje;
               |FINSI;
          |SINO;
               nSwFirmaOK = 1;

               eaFEDestino = eaUnidad + ":\documentos\dsarchi\" + aNombreXML;
               eaFEOrigen = eaFEDestino + ".xsig";
               |RCOPIA_FICHERO eaFEOrigen, eaFEDestino;

               ||aNombreXML = aNombreXML;
          |FINSI;
   |FINSI;
|FPRC;

|PROCESO MeteLineaSinReturn;
     aLinea = aLinea;
     |XGRABA nHandleXML, aLinea;
|FPRC;

|PROCESO MeteLinea;
     aLinea = aLinea + aReturn;
     |XGRABA nHandleXML, aLinea;
|FPRC;

|PROCESO FinalXML;
     aLinea = "</namespace:Facturae>";
     |HAZ MeteLinea;
|FPRC;

|PROCESO CabeceraXML;
     aAuxVer = aVersionXML;
     |QBF aAuxVer;

     aLinea = "<?xml version=" + &34 + "1.0" + &34 + " encoding=" + &34 + "UTF-8" + &34 + "?>";
     |HAZ MeteLinea;

     aLinea = "<namespace:Facturae";
     |HAZ MeteLinea;

     aAuxVer = aVersionXML;
     |QBF aAuxVer;
     |SI aAuxVer = "3.1";
          aLinea = "xmlns:namespace=" + &34 + "http://www.facturae.es/Facturae/2007/v3.1/Facturae" + &34;
     |SINO;
          |SI aAuxVer = "3.2";
               aLinea = "xmlns:namespace=" + &34 + "http://www.facturae.es/Facturae/2009/v3.2/Facturae" + &34;
          |SINO;
               aLinea = "xmlns:namespace=" + &34 + "http://www.facturae.es/Facturae/2007/v3.0/Facturae" + &34;
          |FINSI;
     |FINSI;
     |HAZ MeteLinea;

     aLinea = "xmlns:namespace2=" + &34 + "http://uri.etsi.org/01903/v1.2.2#" + &34;
     |HAZ MeteLinea;

     aLinea = "xmlns:namespace3=" + &34 + "http://www.w3.org/2000/09/xmldsig#" + &34 + ">";
     |HAZ MeteLinea;
|FPRC;

|PROCESO dsarm013_cab;
     aAuxVer = #dsarm013#4;
     aAuxEsq = #dsarm013#5;
     |HAZ MeteCab;

     aAuxVer = #dsarm013#7;
     aAuxEsq = #dsarm013#8;
     |HAZ MeteCab;

     aAuxVer = #dsarm013#10;
     aAuxEsq = #dsarm013#11;
     |HAZ MeteCab;

     aAuxVer = #dsarm013#13;
     aAuxEsq = #dsarm013#14;
     |HAZ MeteCab;

     aAuxVer = #dsarm013#16;
     aAuxEsq = #dsarm013#17;
     |HAZ MeteCab;

     aAuxVer = #dsarm013#19;
     aAuxEsq = #dsarm013#20;
     |HAZ MeteCab;

     aAuxVer = #dsarm013#22;
     aAuxEsq = #dsarm013#23;
     |HAZ MeteCab;

     aAuxVer = #dsarm013#25;
     aAuxEsq = #dsarm013#26;
     |HAZ MeteCab;
|FPRC;

|PROCESO MeteCab;
     aAuxDatos = aAuxEsq;
     |QBF aAuxDatos;

     |SI aAuxDatos ! "";
          |SI aAuxDatos = "PORTESCAB";
               nCampoDef = #dsarm013#2;
               aAuxAux = #1000#nCampoDef#;
               |QBF aAuxAux;
               |SI aAuxAux ! "";
                    nPortesCab = aAuxAux;
               |FINSI;
               |ACABA;
          |FINSI;
          |SI aAuxDatos = "PORTESIVACAB";
               nCampoDef = #dsarm013#2;
               aAuxAux = #1000#nCampoDef#;
               |QBF aAuxAux;
               |SI aAuxAux ! "";
                    nPortesIvaCab = aAuxAux;
               |FINSI;
               |ACABA;
          |FINSI;
          |SI aAuxDatos = "DTO%CABaLIN";
               nCampoDef = #dsarm013#2;
               aAuxAux = #1000#nCampoDef#;
               |QBF aAuxAux;
               |SI aAuxAux ! "";
                    nDtoPorCabALin = aAuxAux;
               |FINSI;
               |ACABA;
          |FINSI;
          |SI aAuxDatos = "DTOCABaLIN";
               nCampoDef = #dsarm013#2;
               aAuxAux = #1000#nCampoDef#;
               |QBF aAuxAux;
               |SI aAuxAux ! "";
                    nDtoCabALin = aAuxAux;
               |FINSI;
               |ACABA;
          |FINSI;
          |SI aAuxDatos = "3.1.5.1.";        ||TotalGrossAmount
               nCampoDef = #dsarm013#2;
               nImporteBaseCab = #1000#nCampoDef#;
          |FINSI;

          |SI aAuxDatos = "3.1.4.1.4.1.";  ||Importe Retencion.  IRPF
               nCampoDef = #dsarm013#2;
               aAuxAux = #1000#nCampoDef#;
               |QBF aAuxAux;
               nAuxNumero = aAuxAux;
               |SI nAuxNumero ! 0;
                    ||RETENCION IRPF
                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = "3.1.4.1.4.1.";   ||TotalAmount (de TaxesWithheld)
                    #dsarw025#2 = 3100;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    #dsarw025#3 = aAuxAux;

                    |HAZ Pon4y5_w025;

                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = "3.1.4.1.1.";   ||TaxTypeCode (de TaxesWithheld)
                    #dsarw025#2 = 3100;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    #dsarw025#3 = 12;

                    |HAZ Pon4y5_w025;

                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = "3.1.4.1.2.";   ||TaxRate (de TaxesWithheld)
                    #dsarw025#2 = 3100;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    #dsarw025#3 = enPorRetenIRPF;

                    |HAZ Pon4y5_w025;

                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = "3.1.4.1.3.1.";   ||TotalAmount (de TaxesWithheld)
                    #dsarw025#2 = 3100;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    #dsarw025#3 = nImporteBaseCab;

                    |HAZ Pon4y5_w025;

                    nSwHayRetenCab = 1;
               |FINSI;
               |ACABA;
          |FINSI;

          |SI aAuxDatos = "3.1.5.15.";
               nCampoDef = #dsarm013#2;
               aAuxAux = #1000#nCampoDef#;
               |QBF aAuxAux;
               |SI aAuxAux ! "";
                    nImpoACta = aAuxAux;
               |FINSI;
          |FINSI;

          aEtiqIva = aAuxDatos % 103;
          |QBF aEtiqIva;
          |SI aEtiqIva = "IVA"; |Y eaAplicacion = "dsarchi";
               ||TODO CCC
               ||Aqui procesamos los campos de IVA de la cabecera.

               nCampoDef = #dsarm013#2;
               nXMLValor = #1000#nCampoDef#;

               aAuxEtiq = aAuxDatos % 104;
               |SI aAuxEtiq = "IVA%";
                    nXMLIva = nXMLValor;
               |SINO;
                    aAuxEtiq = aAuxDatos % 107;
                    |SI aAuxEtiq = "IVABASE";
                         nXMLBaseIva = nXMLValor;

                         |SI aAuxDatos = "IVABASE0"; |Y nXMLBaseIva ! 0;
                              ||FAlta meter el IVA CERO.
                              ||TODO CCC
                              nXMLTipoIva = 0;
                              nXMLIva = 0;
                              nXMLCuotaIva = 0;

                              ||SON 4 ETIQUETAS. COPIAR DE ABAJO.
                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.3.1.1.";      ||TaxTypeCode
                              #dsarw025#2 = 3000;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nXMLTipoIva;

                              |HAZ Pon4y5_w025;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.3.1.2.";   ||TaxRate
                              #dsarw025#2 = 3000;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nXMLIva;

                              |HAZ Pon4y5_w025;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.3.1.3.1.";      ||TotalAmount
                              #dsarw025#2 = 3000;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nXMLBaseIva;

                              |HAZ Pon4y5_w025;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.3.1.4.1.";      ||TotalAmount
                              #dsarw025#2 = 3000;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nXMLCuotaIva;

                              |HAZ Pon4y5_w025;
                         |FINSI;
                    |SINO;
                         aAuxEtiq = aAuxDatos % 108;
                         |SI aAuxEtiq = "IVACUOTA";
                              nXMLCuotaIva = nXMLValor;

                              |SI nXMLBaseIva ! 0;
                                   ||Meto los IVAS CAB. (Origen XML)
                                   aAuxEtiq = aAuxDatos % 901;
                                   nXMLTipoIva = aAuxEtiq;

                                   ||SON 4 ETIQUETAS.
                                   |DDEFECTO #dsarw025;
                                   #dsarw025#0 = aAuxVer;
                                   #dsarw025#1 = "3.1.3.1.1.";      ||TaxTypeCode
                                   #dsarw025#2 = 3000 + nXMLTipoIva;
                                   |LEE 101#dsarw025.=;
                                   |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                                   #dsarw025#3 = nXMLTipoIva;

                                   |HAZ Pon4y5_w025;

                                   |DDEFECTO #dsarw025;
                                   #dsarw025#0 = aAuxVer;
                                   #dsarw025#1 = "3.1.3.1.2.";   ||TaxRate
                                   #dsarw025#2 = 3000 + nXMLTipoIva;
                                   |LEE 101#dsarw025.=;
                                   |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                                   #dsarw025#3 = nXMLIva;

                                   |HAZ Pon4y5_w025;

                                   |DDEFECTO #dsarw025;
                                   #dsarw025#0 = aAuxVer;
                                   #dsarw025#1 = "3.1.3.1.3.1.";      ||TotalAmount
                                   #dsarw025#2 = 3000 + nXMLTipoIva;
                                   |LEE 101#dsarw025.=;
                                   |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                                   #dsarw025#3 = nXMLBaseIva;

                                   |HAZ Pon4y5_w025;

                                   |DDEFECTO #dsarw025;
                                   #dsarw025#0 = aAuxVer;
                                   #dsarw025#1 = "3.1.3.1.4.1.";      ||TotalAmount
                                   #dsarw025#2 = 3000 + nXMLTipoIva;
                                   |LEE 101#dsarw025.=;
                                   |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                                   #dsarw025#3 = nXMLCuotaIva;

                                   |HAZ Pon4y5_w025;
                              |FINSI;

                              nXMLTipoIva = 0;
                              nXMLIva = 0;
                              nXMLBaseIva = 0;
                              nXMLCuotaIva = 0;
                         |FINSI;
                    |FINSI;
               |FINSI;

               |ACABA;
          |FINSI;
          |SI eaAplicacion = "dsarchi"; |Y aAuxDatos = "2.1.1.3.";
               nCampoDef = #dsarm013#2;
               eaDniFirmador = #1000#nCampoDef#;
               |QBF eaDniFirmador;
          |FINSI;

          nCampoDef = #dsarm013#2;
          aAuxAux = #1000#nCampoDef#;
          |QBF aAuxAux;
          |SI aAuxAux ! "";
               |SI aAuxDatos = "REQESSN";         ||FACTURA CON RECARGO EQUIVALENCIA S/N
                    |SI aAuxAux = "S";
                         nSwEsRecEqui = 1;
                    |SINO;
                         nSwEsRecEqui = 0;
                    |FINSI;
                    |ACABA;
               |FINSI;

               |SI aAuxDatos = "3.1.2.1.";        ||IVA18
                    fFechaFactura = aAuxAux;
               |FINSI;
               |SI aAuxDatos = "1.5.3.1.";        ||TOTALFACTURA
                    nTotalFactura = aAuxAux;
               |FINSI;

               |SI aAuxDatos = "3.1.5.4.";        ||TotalGeneralDiscounts. Total Descuento
                    nImpoDtoCabTotal = aAuxAux;
               |FINSI;

               |SI aAuxDatos = "DTOCAB";
                    nDtoCab = aAuxAux;
                    |ACABA;
               |FINSI;
               |SI aAuxDatos = "DTOCABAC";
                    nDtoCabAC = aAuxAux;
                    |ACABA;
               |FINSI;
               |SI aAuxDatos = "DTOCABPP";
                    nDtoCabPP = aAuxAux;
                    |ACABA;
               |FINSI;
               |SI aAuxDatos = "FORMAPAGO";
                    eaFormaPagoFace = aAuxAux;
                    |ACABA;
               |FINSI;

               |SI eaAplicacion = "edi"; |O eaAplicacion = "dssat";
                    |SI aAuxDatos = "3.1.3.1.2.";
                         nIva1 = 1;
                         nCampoDef = #dsarm013#2;
                         enTipoIvaFe = #1000#nCampoDef#;
                         |ACABA;
                    |FINSI;
                    |SI aAuxDatos = "3.1.3.1.4.1.";
                         |ACABA;
                    |FINSI;
               |FINSI;

               |DDEFECTO #dsarm011;
               #dsarm011#0 = aAuxVer;
               #dsarm011#1 = aAuxEsq;
               |LEE 000#dsarm011.=;
               |SI #dsarm011#3 ] 4020;            ||InvoiceTotals  (3.1.5.)
                    |SI #dsarm011#3 = 4030;
                         nContador = 5000;
                    |SINO;
                         ||TODO CCC.
                         ||Esto es para controlar si hay mas de un descuento en la cabecera
                         nSaltoDtos = -1;
                         |SI nDtoCab ! 0; nSaltoDtos = nSaltoDtos + 1; |FINSI;
                         |SI nDtoCabAC ! 0; nSaltoDtos = nSaltoDtos + 1; |FINSI;
                         |SI nDtoCabPP ! 0; nSaltoDtos = nSaltoDtos + 1; |FINSI;
                         |SI nSaltoDtos = -1;
                              nSaltoDtos = 0;
                         |FINSI;
                         nContador = 5000 + nSaltoDtos;
                    |FINSI;
                    |SI #dsarm011#3 ] 4970;            ||PaymentDetails (3.1.7.)
                         nContador = 9000;
                    |FINSI;
               |SINO;
                    nContador = 0;
                    |SI nREUnico ! 0;
                         |SI #dsarm011#3 = 3900;   ||"3.1.3.1.8.1.";         ||TotalAmount (Rec.Equiva)
                              nContador = 3001;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI #dsarm011#6 = "S";   ||OMITIR SI CERO
                    nNumero3 = #1000#nCampoDef#;
                    |SI nNumero3 = 0;
                         |ACABA;
                    |FINSI;
               |FINSI;

               |SI aAuxDatos = "SUPLIDOS";
                    ||No tiene que meter esa etiqueta, que es ficticia. NO pertenece al esquema
               |SINO;
                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = aAuxEsq;
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    nCampoDef = #dsarm013#2;
                    aAuxDatos = aAuxEsq;
                    |QBF aAuxDatos;

                    aAlfa8 = aAuxDatos % 108;
                    |SI aAlfa8 = "DTOLINEA";
                         nNumero3 = #1000#nCampoDef#;
                         |SI nNumero3 ! 0;
                              nDtoLinea = nNumero3;
                         |FINSI;
                         ||Estoy en la cabecera. Solo necesito pillar el valor del DtoLinea
                         |ACABA;
                    |FINSI;

                    |SI aAuxDatos = "1.5.1.";     || BatchIdentifier. Concantena Serie y Numero de Factura + Num. Reg DsArchi
                         aBatchIdentifier = eaSerieFE; |QBF aBatchIdentifier;
                         nNumRegDSArchi = aNombreSinExt;
                         aBatchIdentifier = aBatchIdentifier + "/" + eaNumeroFE + "/" + nNumRegDSArchi;
                         #dsarw025#3 = aBatchIdentifier;
/*
                         aAlfa3 = #dsarw025#3;
                         |QBF aAlfa3;
                         |SI aAlfa3 = "";
                              nNumRegDSArchi = aNombreSinExt;
                              #dsarw025#3 = #1000#nCampoDef# + "/" + nNumRegDSArchi;
                         |SINO;
                              #dsarw025#3 = #1000#nCampoDef# + "/" + aAlfa3;
                         |FINSI;
*/
                    |SINO;
                         |SI #dsarm011#5 = "+";
                              nNumSuma = #dsarw025#3;
                              nNumSuma = nNumSuma + #1000#nCampoDef#;
                              #dsarw025#3 = nNumSuma;
                         |SINO;
                              ||AQUI ES DONDE SE METE EL VALOR REALMENTE. (por lo general).
                              #dsarw025#3 = #1000#nCampoDef#;
                         |FINSI;
                    |FINSI;
                    |SI aAuxDatos = "3.1.2.1.";   ||IssueDate. Fecha Expedicion.
                         aFechaFactura = #1000#nCampoDef#;
                    |FINSI;
                    |SI eaAplicacion = "edi";
                         aAuxDatos = aAuxEsq;
                         |QBF aAuxDatos;
                         |SI aAuxDatos = "2.2.4.1.4.1.2.";       ||Codigo Postal
                              aCodPostal = (("00" + #1000#9) % -102) + (("000" + #1000#10) % -103);
                              #dsarw025#3 = aCodPostal;
                         |FINSI;
                    |FINSI;
                    #dsarw025#4 = #dsarm011#2;
                    #dsarw025#5 = #dsarm011#3;
                    |GRABA 020#dsarw025.a;
                    |LIBERA #dsarw025;

                    nContaDtos = 0;
                    |SI aAuxDatos = "3.1.5.1.";        ||TotalGrossAmount
                         ||DESCUENTOSCAB
                         ||Metemos los datos de descuentos de la cabecera
                         nBrutoParaDto = #dsarw025#3;

                         |SI nDtoCab ! 0;
                              nContador = 5000;
                              nContaDtos = nContaDtos + 1;

                              aNombreEtiqueta = "";
                              |DDEFECTO #dsarm011;
                              #dsarm011#0 = aAuxVer;
                              #dsarm011#1 = "DTOCAB";
                              |LEE 000#dsarm011.=;
                              |SI FSalida = 0;
                                   aNombreEtiqueta = #dsarm011#2;
                                   |QBF aNombreEtiqueta;
                              |FINSI;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.5.2.1.1.";          ||DiscountReason
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = aNombreEtiqueta;

                              |HAZ Pon4y5_w025;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.5.2.1.2.";          ||DiscountRate
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nDtoCab;

                              |HAZ Pon4y5_w025;

                              nImpoDtoAux = (nBrutoParaDto % nDtoCab) ! 2;
                              nBrutoParaDto = nBrutoParaDto - nImpoDtoAux;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.5.2.1.3.";          ||DiscountAmount
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nImpoDtoAux;

                              |HAZ Pon4y5_w025;
                              ||DESCUENTOSCAB
                         |FINSI;
                         |SI nDtoCabAC ! 0;
                              |SI nContaDtos ! 0;
                                   nContador = 5001;
                              |SINO;
                                   nContador = 5000;
                              |FINSI;
                              nContaDtos = nContaDtos + 1;

                              ||DESCUENTOSCAB
                              aNombreEtiqueta = "";
                              |DDEFECTO #dsarm011;
                              #dsarm011#0 = aAuxVer;
                              #dsarm011#1 = "DTOCABAC";
                              |LEE 000#dsarm011.=;
                              |SI FSalida = 0;
                                   aNombreEtiqueta = #dsarm011#2;
                                   |QBF aNombreEtiqueta;
                              |FINSI;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.5.2.1.1.";          ||DiscountReason
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = aNombreEtiqueta;

                              |HAZ Pon4y5_w025;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.5.2.1.2.";          ||DiscountRate
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nDtoCabAC;

                              |HAZ Pon4y5_w025;

                              nImpoDtoAux = (nBrutoParaDto % nDtoCabAC) ! 2;
                              nBrutoParaDto = nBrutoParaDto - nImpoDtoAux;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.5.2.1.3.";          ||DiscountAmount
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nImpoDtoAux;

                              |HAZ Pon4y5_w025;
                              ||DESCUENTOSCAB
                         |FINSI;

                         |SI nDtoCabPP ! 0;
                              |SI nContaDtos ! 0;
                                   nContador = 5000 + nContaDtos;
                              |SINO;
                                   nContador = 5000;
                              |FINSI;
                              nContaDtos = nContaDtos + 1;

                              ||DESCUENTOSCAB
                              aNombreEtiqueta = "";
                              |DDEFECTO #dsarm011;
                              #dsarm011#0 = aAuxVer;
                              #dsarm011#1 = "DTOCABPP";
                              |LEE 000#dsarm011.=;
                              |SI FSalida = 0;
                                   aNombreEtiqueta = #dsarm011#2;
                                   |QBF aNombreEtiqueta;
                              |FINSI;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.5.2.1.1.";          ||DiscountReason
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = aNombreEtiqueta;

                              |HAZ Pon4y5_w025;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.5.2.1.2.";          ||DiscountRate
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nDtoCabPP;

                              |HAZ Pon4y5_w025;

                              nImpoDtoAux = (nBrutoParaDto % nDtoCabPP) ! 2;
                              nBrutoParaDto = nBrutoParaDto - nImpoDtoAux;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.5.2.1.3.";          ||DiscountAmount
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nImpoDtoAux;

                              |HAZ Pon4y5_w025;
                              ||DESCUENTOSCAB
                         |FINSI;

                    |FINSI;
               |FINSI;

               |SI aAuxDatos = "3.1.3.1.8.1.";         ||TotalAmount (Rec.Equiva)
                    |SI nREUnico ! 0;
                         nValorAux = #dsarw025#3;
                         |SI nValorAux ! 0;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = "3.1.3.1.7.";          ||EquivalenceSurcharge
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nREUnico;

                              |HAZ Pon4y5_w025;
                         |FINSI;
                    |FINSI;
               |FINSI;

               |SI eaAplicacion = "dscomer8"; |O eaAplicacion = "drogas86";
                    |SI aAuxDatos = "3.1.5.7.";
                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = "3.1.5.8.";          ||TotalTaxesWithheld
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = 0;

                         |HAZ Pon4y5_w025;
                    |FINSI;
               |FINSI;

               |SI eaAplicacion = "gesracor"; |Y aAuxDatos = "3.1.3.1.2.";
                    enTipoIvaFe = aAuxAux;

                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = "3.1.3.1.1.";          ||TaxTypeCode
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    #dsarw025#3 = 1;

                    |HAZ Pon4y5_w025;
               |FINSI;

               |SI aAuxDatos = "SUPLIDOS";       ||Tenemos Suplidos
                    nValorSuplido = #1000#nCampoDef#;
                    |SI nValorSuplido ! 0;
                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = "3.1.3.1.1.";          ||TaxTypeCode
                         #dsarw025#2 = 3010;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = 10;

                         |HAZ Pon4y5_w025;

                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = "3.1.3.1.2.";          ||TaxRate
                         #dsarw025#2 = 3010;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = 0;

                         |HAZ Pon4y5_w025;

                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = "3.1.3.1.3.1.";          ||TotalAmount. TaxableBase
                         #dsarw025#2 = 3010;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = nValorSuplido;

                         |HAZ Pon4y5_w025;

                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = "3.1.3.1.4.1.";          ||TotalAmount. TotalAmount
                         #dsarw025#2 = 3010;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = 0;

                         |HAZ Pon4y5_w025;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm013_cab;
 #dsarm013#1;
 ;
 eaAplicacion, eaDefFE,   0;
 eaAplicacion, eaDefFE, 255;
 ;
 NULL, dsarm013_cab;
|FIN;

|PROCESO dsarm013_emp;
     aAuxVer = #dsarm013#4;
     aAuxEsq = #dsarm013#5;
     |HAZ MeteEmp;

     aAuxVer = #dsarm013#7;
     aAuxEsq = #dsarm013#8;
     |HAZ MeteEmp;

     aAuxVer = #dsarm013#10;
     aAuxEsq = #dsarm013#11;
     |HAZ MeteEmp;

     aAuxVer = #dsarm013#13;
     aAuxEsq = #dsarm013#14;
     |HAZ MeteEmp;

     aAuxVer = #dsarm013#16;
     aAuxEsq = #dsarm013#17;
     |HAZ MeteEmp;

     aAuxVer = #dsarm013#19;
     aAuxEsq = #dsarm013#20;
     |HAZ MeteEmp;

     aAuxVer = #dsarm013#22;
     aAuxEsq = #dsarm013#23;
     |HAZ MeteEmp;

     aAuxVer = #dsarm013#25;
     aAuxEsq = #dsarm013#26;
     |HAZ MeteEmp;
|FPRC;

|PROCESO MeteEmp;
     aAuxDatos = aAuxEsq;
     |QBF aAuxDatos;
     |SI aAuxDatos ! "";
          nCampoDef = #dsarm013#2;
          |SI aAuxDatos = "2.1.4.1.4.1.5.";
               aAuxAux = "ESP";
          |SINO;
               aAuxAux = #1002#nCampoDef#;
          |FINSI;
          |QBF aAuxAux;
          |SI aAuxAux ! "";
               |DDEFECTO #dsarm011;
               #dsarm011#0 = aAuxVer;
               #dsarm011#1 = aAuxEsq;
               |LEE 000#dsarm011.=;
               |SI #dsarm011#3 ] 4020;            ||InvoiceTotals  (3.1.5.)
                    nContador = 5000;
                    |SI #dsarm011#3 ] 4970;            ||PaymentDetails (3.1.7.)
                         nContador = 9000;
                    |SINO;
                         nContador = 0;
                    |FINSI;
               |SINO;
                    nContador = 0;
               |FINSI;

               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = nContador;
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               nCampoDef = #dsarm013#2;
               |SI aAuxDatos = "2.1.4.1.4.1.5.";
                    #dsarw025#3 = "ESP";
               |SINO;
                    #dsarw025#3 = #1002#nCampoDef#;
               |FINSI;
               #dsarw025#4 = #dsarm011#2;
               #dsarw025#5 = #dsarm011#3;
               |GRABA 020#dsarw025.a;
               |LIBERA #dsarw025;

               aAuxDatos = aAuxEsq;
               |QBF aAuxDatos;
               |SI aAuxDatos = "2.1.1.3.";
                    eaDniFirmador = #1002#nCampoDef#;
                    |QBF eaDniFirmador;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm013_emp;
 #dsarm013#1;
 ;
 eaAplicacion, eaDefEmpFe,   0;
 eaAplicacion, eaDefEmpFe, 255;
 ;
 NULL, dsarm013_emp;
|FIN;

|PROCESO dsarm013_cli;
     aAuxVer = #dsarm013#4;
     aAuxEsq = #dsarm013#5;
     |HAZ MeteCli;

     aAuxVer = #dsarm013#7;
     aAuxEsq = #dsarm013#8;
     |HAZ MeteCli;

     aAuxVer = #dsarm013#10;
     aAuxEsq = #dsarm013#11;
     |HAZ MeteCli;

     aAuxVer = #dsarm013#13;
     aAuxEsq = #dsarm013#14;
     |HAZ MeteCli;

     aAuxVer = #dsarm013#16;
     aAuxEsq = #dsarm013#17;
     |HAZ MeteCli;

     aAuxVer = #dsarm013#19;
     aAuxEsq = #dsarm013#20;
     |HAZ MeteCli;

     aAuxVer = #dsarm013#22;
     aAuxEsq = #dsarm013#23;
     |HAZ MeteCli;

     aAuxVer = #dsarm013#25;
     aAuxEsq = #dsarm013#26;
     |HAZ MeteCli;
|FPRC;

|PROCESO MeteCli;
     ||Obtengo el numero de Cuenta Cliente. (aCCC)
     |SI eaAplicacion = "facturar";
          nCampoDef = #dsarm013#2;
          |SI nCampoDef = 14;         ||Cuenta Corriente Cli
               ||Tiquet. 2884.1650.  CCC.
               ||aCCC = #1002#nCampoDef#;
               ||Tiquet  2884.1650.47. Los campos 71, 72 y 73 .. NO se usan ..
               ||en su lugar el es campo 13 y 14.

/*
               aCCC = ("0000" + #1002#71) % -104;
               |QBF aCCC;
               aCCC = aCCC + " " + (("0000" + #1002#72) % -104);
               |QBF aCCC;
               aCCC = aCCC + " " + (("00" + #1002#73) % -102);
               |QBF aCCC;
*/
               aCCC = #1002#13 % 110;
               |QBF aCCC;
               aCCC = ("0000000000" + aCCC) % -110;

               aBeta2 = #1002#14 % 110;
               |QBF aBeta2;
               aCCC = aCCC + ("0000000000" + aBeta2) % -110;
               |QBF aCCC;
          |FINSI;
     |FINSI;
     aAuxDatos = aAuxEsq;
     |QBF aAuxDatos;
     |SI aAuxDatos ! "";
          nCampoDef = #dsarm013#2;
          aAuxAux = #1002#nCampoDef#;
          |QBF aAuxAux;
          |SI aAuxAux ! "";
               |DDEFECTO #dsarm011;
               #dsarm011#0 = aAuxVer;
               #dsarm011#1 = aAuxEsq;
               |LEE 000#dsarm011.=;
               |SI #dsarm011#3 ] 4020;            ||InvoiceTotals  (3.1.5.)
                    nContador = 5000;
                    |SI #dsarm011#3 ] 4970;            ||PaymentDetails (3.1.7.)
                         nContador = 9000;
                    |SINO;
                         nContador = 0;
                    |FINSI;
               |SINO;
                    nContador = 0;
               |FINSI;

               |SI eaAplicacion = "facges"; |O eaAplicacion = "facturar";
                    aAuxDatos = aAuxEsq;
                    |QBF aAuxDatos;
                    |SI aAuxDatos = "2.2.4.1.4.1.2.";       ||Codigo Postal
                         aCodPostal = (("00" + #1002#4) % -102) + (("000" + #1002#5) % -103);
                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = aCodPostal;
                         #dsarw025#4 = #dsarm011#2;
                         #dsarw025#5 = #dsarm011#3;
                         |GRABA 020#dsarw025.a;
                         |LIBERA #dsarw025;

                         |ACABA;
                    |FINSI;
               |FINSI;
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = nContador;
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               nCampoDef = #dsarm013#2;
               #dsarw025#3 = #1002#nCampoDef#;
               #dsarw025#4 = #dsarm011#2;
               #dsarw025#5 = #dsarm011#3;
               |GRABA 020#dsarw025.a;
               |LIBERA #dsarw025;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm013_cli;
 #dsarm013#1;
 ;
 eaAplicacion, eaDefCliFe,   0;
 eaAplicacion, eaDefCliFe, 255;
 ;
 NULL, dsarm013_cli;
|FIN;

|PROCESO dsarm013_iva;
     aAuxVer = #dsarm013#4;
     aAuxEsq = #dsarm013#5;
     |HAZ MeteIva;

     aAuxVer = #dsarm013#7;
     aAuxEsq = #dsarm013#8;
     |HAZ MeteIva;

     aAuxVer = #dsarm013#10;
     aAuxEsq = #dsarm013#11;
     |HAZ MeteIva;

     aAuxVer = #dsarm013#13;
     aAuxEsq = #dsarm013#14;
     |HAZ MeteIva;

     aAuxVer = #dsarm013#16;
     aAuxEsq = #dsarm013#17;
     |HAZ MeteIva;

     aAuxVer = #dsarm013#19;
     aAuxEsq = #dsarm013#20;
     |HAZ MeteIva;

     aAuxVer = #dsarm013#22;
     aAuxEsq = #dsarm013#23;
     |HAZ MeteIva;

     aAuxVer = #dsarm013#25;
     aAuxEsq = #dsarm013#26;
     |HAZ MeteIva;
|FPRC;

|PROCESO MeteIva;
     aAuxDatos = aAuxEsq;
     |QBF aAuxDatos;
     |SI aAuxDatos ! "";
          aAlfa3 = aAuxDatos % 103;
          |QBF aAlfa3
          |SI aAlfa3 = "IVA";
               aAlfa3 = aAuxDatos % 107;
               |QBF aAlfa3;
               |SI aAlfa3 = "IVABASE";
                    aAlfa3 = aAuxDatos % -101;
                    nEstoyIva = aAlfa3;

                    nCampoDef = #dsarm013#2;
                    aAuxAux = #1000#nCampoDef#;
                    nValorIva = aAuxAux;

                    |SI nValorIva = 0;

                         |SI eaAplicacion = "salvidal";
                              nTipoIvaToca = nIvaUnico;
                         |SINO;
                              |SI nEstoyIva = 0;
                                   nTipoIvaToca = nIva0;
                                   |SI nSwEsRecEqui = 1;
                                        nTipoReqToca = nReq0;
                                   |FINSI;
                              |FINSI;
                              |SI nEstoyIva = 1;
                                   nTipoIvaToca = nIva1;
                                   |SI nSwEsRecEqui = 1;
                                        nTipoReqToca = nReq1;
                                   |FINSI;
                              |FINSI;
                              |SI nEstoyIva = 2;
                                   nTipoIvaToca = nIva2;
                                   |SI nSwEsRecEqui = 1;
                                        nTipoReqToca = nReq2;
                                   |FINSI;
                              |FINSI;
                              |SI nEstoyIva = 3;
                                   nTipoIvaToca = nIva3;
                                   |SI nSwEsRecEqui = 1;
                                        nTipoReqToca = nReq3;
                                   |FINSI;
                              |FINSI;
                              |SI nEstoyIva = 4;
                                   nTipoIvaToca = nIva4;
                                   |SI nSwEsRecEqui = 1;
                                        nTipoReqToca = nReq4;
                                   |FINSI;
                              |FINSI;
                              |SI nEstoyIva = 5;
                                   nTipoIvaToca = nIva5;
                                   |SI nSwEsRecEqui = 1;
                                        nTipoReqToca = nReq5;
                                   |FINSI;
                              |FINSI;
                         |FINSI;

                         |SI nTipoIvaToca ! 0;
                              ||En este caso, el total IVA es cero
                              ||Pero el %IVA es distinto de cero.
                              ||Lo que implica que cuota IVA es cero.
                              ||NO sacar. TODO CCC
                              |ACABA;
                         |FINSI;
                         |SI eaAplicacion = "dscomer8"; |O eaAplicacion = "dscomer9";
                          |O eaAplicacion = "carrillo"; |O eaAplicacion = "ds-suite";
                          |O eaAplicacion = "compaq"; |O eaAplicacion = "dscepsa";
                          |O eaAplicacion = "drogas86";
                              |ACABA;
                         |FINSI;
                    |FINSI;

||Ahora YA permite IVA a 0%
||                    |SI nValorIva ! 0;
                         nContador = 3000 + nEstoyIva;

                         ||TaxTypeCode
                         aAuxEsq = "3.1.3.1.1.";
                         |DDEFECTO #dsarm011;
                         #dsarm011#0 = aAuxVer;
                         #dsarm011#1 = aAuxEsq;
                         |LEE 000#dsarm011.=;

                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         |SI nEstoyIva = 0;
                              |SI eaAplicacion = "dscomer8"; |O eaAplicacion = "dscomer9"; |O eaAplicacion = "compaq"; |O eaAplicacion = "dscepsa";
                                        |O eaAplicacion = "drogas86";
                                   #dsarw025#3 = 6;
                              |SINO;
                                   #dsarw025#3 = nEstoyIva;
                              |FINSI;
                         |SINO;
                              #dsarw025#3 = nEstoyIva;
                         |FINSI;
                         #dsarw025#4 = #dsarm011#2;
                         #dsarw025#5 = #dsarm011#3;
                         |GRABA 020#dsarw025.a;
                         |LIBERA #dsarw025;

                         ||TaxRate
                         aAuxEsq = "3.1.3.1.2.";
                         |DDEFECTO #dsarm011;
                         #dsarm011#0 = aAuxVer;
                         #dsarm011#1 = aAuxEsq;
                         |LEE 000#dsarm011.=;

                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         |SI nEstoyIva = 0;
                              #dsarw025#3 = nIva0;
                              |SI nSwEsRecEqui = 1;
                                   nTipoReqToca = nReq0;
                              |FINSI;
                         |FINSI;
                         |SI nEstoyIva = 1;
                              #dsarw025#3 = nIva1;
                              |SI nSwEsRecEqui = 1;
                                   nTipoReqToca = nReq1;
                              |FINSI;
                         |FINSI;
                         |SI nEstoyIva = 2;
                              #dsarw025#3 = nIva2;
                              |SI nSwEsRecEqui = 1;
                                   nTipoReqToca = nReq2;
                              |FINSI;
                         |FINSI;
                         |SI nEstoyIva = 3;
                              #dsarw025#3 = nIva3;
                              |SI nSwEsRecEqui = 1;
                                   nTipoReqToca = nReq3;
                              |FINSI;
                         |FINSI;
                         |SI nEstoyIva = 4;
                              #dsarw025#3 = nIva4;
                              |SI nSwEsRecEqui = 1;
                                   nTipoReqToca = nReq4;
                              |FINSI;
                         |FINSI;
                         |SI nEstoyIva = 5;
                              #dsarw025#3 = nIva5;
                              |SI nSwEsRecEqui = 1;
                                   nTipoReqToca = nReq5;
                              |FINSI;
                         |FINSI;
                         |SI eaAplicacion = "marmol";
                              enTipoIvaFe = #dsarw025#3;
                         |FINSI;
                         |SI eaAplicacion = "salvidal";
                              enTipoIvaFe = nIvaUnico;
                              #dsarw025#3 = nIvaUnico;
                         |FINSI;

                         #dsarw025#4 = #dsarm011#2;
                         #dsarw025#5 = #dsarm011#3;
                         |GRABA 020#dsarw025.a;
                         |LIBERA #dsarw025;

                         ||TotalAmount (dentro de TaxableBase)
                         aAuxEsq = "3.1.3.1.3.1.";
                         |DDEFECTO #dsarm011;
                         #dsarm011#0 = aAuxVer;
                         #dsarm011#1 = aAuxEsq;
                         |LEE 000#dsarm011.=;

                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = nValorIva;
                         #dsarw025#4 = #dsarm011#2;
                         #dsarw025#5 = #dsarm011#3;
                         |GRABA 020#dsarw025.a;
                         |LIBERA #dsarw025;

                         |SI nSwEsRecEqui = 1;
                              nBaseIvaReq = nValorIva;
                         |FINSI;

                         |SI eaAplicacion = "dscomer8"; |O eaAplicacion = "dscomer9"; |O eaAplicacion = "compaq"; |O eaAplicacion = "dscepsa";
                                   |O eaAplicacion = "drogas86";
                              |SI nEstoyIva = 0;
                                   ||TotalAmount (dentro de TaxAmount)
                                   aAuxEsq = "3.1.3.1.4.1.";
                                   |DDEFECTO #dsarm011;
                                   #dsarm011#0 = aAuxVer;
                                   #dsarm011#1 = aAuxEsq;
                                   |LEE 000#dsarm011.=;

                                   |DDEFECTO #dsarw025;
                                   #dsarw025#0 = aAuxVer;
                                   #dsarw025#1 = aAuxEsq;
                                   #dsarw025#2 = nContador;
                                   |LEE 101#dsarw025.=;
                                   |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                                   #dsarw025#3 = 0;
                                   #dsarw025#4 = #dsarm011#2;
                                   #dsarw025#5 = #dsarm011#3;
                                   |GRABA 020#dsarw025.a;
                                   |LIBERA #dsarw025;

                                   |SI nSwEsRecEqui = 1;
                                        nBaseIvaReq = 0;
                                   |FINSI;
                              |FINSI;
                         |FINSI;

                         |SI nSwEsRecEqui = 1; |Y nTipoReqToca ! 0;
                              ||3.1.3.1.7.  EquivalenceSurcharge   % Recargo
                              aAuxEsq = "3.1.3.1.7.";
                              |DDEFECTO #dsarm011;
                              #dsarm011#0 = aAuxVer;
                              #dsarm011#1 = aAuxEsq;
                              |LEE 000#dsarm011.=;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nTipoReqToca;
                              #dsarw025#4 = #dsarm011#2;
                              #dsarw025#5 = #dsarm011#3;
                              |GRABA 020#dsarw025.a;
                              |LIBERA #dsarw025;

                              ||3.1  3.1.3.1.8.1.    TotalAmount (EquivalenceSurchargeAmount)
                              aAuxEsq = "3.1.3.1.8.1.";
                              |DDEFECTO #dsarm011;
                              #dsarm011#0 = aAuxVer;
                              #dsarm011#1 = aAuxEsq;
                              |LEE 000#dsarm011.=;

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              nTotalReq = (nBaseIvaReq % nTipoReqToca) ! 2;
                              #dsarw025#3 = nTotalReq;
                              #dsarw025#4 = #dsarm011#2;
                              #dsarw025#5 = #dsarm011#3;
                              |GRABA 020#dsarw025.a;
                              |LIBERA #dsarw025;
                         |FINSI;
||                    |FINSI;
               |FINSI;
               aAlfa3 = aAuxDatos % 108;
               |QBF aAlfa3;
               |SI aAlfa3 = "IVACUOTA";
                    aAlfa3 = aAuxDatos % -101;
                    nEstoyIva = aAlfa3;

                    nCampoDef = #dsarm013#2;
                    aAuxAux = #1000#nCampoDef#;
                    nValorIva = aAuxAux;

                    |SI nValorIva = 0;
                         |SI eaAplicacion = "salvidal";
                              nTipoIvaToca = nIvaUnico;
                         |SINO;
                              |SI nEstoyIva = 0;
                                   nTipoIvaToca = nIva0;
                              |FINSI;
                              |SI nEstoyIva = 1;
                                   nTipoIvaToca = nIva1;
                              |FINSI;
                              |SI nEstoyIva = 2;
                                   nTipoIvaToca = nIva2;
                              |FINSI;
                              |SI nEstoyIva = 3;
                                   nTipoIvaToca = nIva3;
                              |FINSI;
                              |SI nEstoyIva = 4;
                                   nTipoIvaToca = nIva4;
                              |FINSI;
                              |SI nEstoyIva = 5;
                                   nTipoIvaToca = nIva5;
                              |FINSI;
                         |FINSI;

                         |SI nTipoIvaToca ! 0;
                              ||En este caso, el total IVA es cero
                              ||Pero el %IVA es distinto de cero.
                              ||Lo que implica que cuota IVA es cero.
                              ||NO sacar. TODO CCC
                              |ACABA;
                         |FINSI;
                         |SI eaAplicacion = "dscomer8"; |O eaAplicacion = "dscomer9";
                          |O eaAplicacion = "carrillo"; |O eaAplicacion = "ds-suite";
                          |O eaAplicacion = "compaq"; |O eaAplicacion = "dscepsa";
                          |O eaAplicacion = "drogas86";
                              |ACABA;
                         |FINSI;
                    |FINSI;

||Ahora YA permite IVA a 0%
||                    |SI nValorIva ! 0;
                         nContador = 3000 + nEstoyIva;

                         ||TotalAmount (dentro de TaxAmount)
                         aAuxEsq = "3.1.3.1.4.1.";
                         |DDEFECTO #dsarm011;
                         #dsarm011#0 = aAuxVer;
                         #dsarm011#1 = aAuxEsq;
                         |LEE 000#dsarm011.=;

                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = nValorIva;
                         #dsarw025#4 = #dsarm011#2;
                         #dsarw025#5 = #dsarm011#3;
                         |GRABA 020#dsarw025.a;
                         |LIBERA #dsarw025;
||                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm013_iva;
 #dsarm013#1;
 ;
 eaAplicacion, eaDefFE,   0;
 eaAplicacion, eaDefFE, 255;
 ;
 NULL, dsarm013_iva;
|FIN;

|PROCESO dsarm014;
     aAuxDatos = #dsarm014#1;
     |QBF aAuxDatos;
     |SI aAuxDatos ! "";
          |DDEFECTO #dsarm011;
          #dsarm011#0 = #dsarm014#2;
          #dsarm011#1 = #dsarm014#0;
          |LEE 000#dsarm011.=;

          |DDEFECTO #dsarw025;
          #dsarw025#0 = #dsarm014#2;
          #dsarw025#1 = #dsarm014#0;
          #dsarw025#2 = nContador;
          |LEE 101#dsarw025.=;
          |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
          #dsarw025#3 = #dsarm014#1;
          #dsarw025#4 = #dsarm011#2;
          #dsarw025#5 = #dsarm011#3;
          |GRABA 020#dsarw025.a;
          |LIBERA #dsarw025;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm014;
 #dsarm014#1;
 ;
 aVersionXML, aBlanco30;
 aVersionXML, aZeta30;
 ;
 NULL, dsarm014;
|FIN;


|PROCESO dsarm016;
     aAuxDatos = #dsarm016#1;
     |QBF aAuxDatos;
     |SI aAuxDatos ! "";
          |DDEFECTO #dsarm011;
          #dsarm011#0 = #dsarm016#2;
          #dsarm011#1 = #dsarm016#0;
          |LEE 000#dsarm011.=;

          ||Si estamos en una version distinta de la 3.1. Verificamos que no tenga ya el registro, en tal caso. NO lo metemos
          aAuxVer = aVersionXML; |QBF aAuxVer;
          |SI aAuxVer ! "3.1";
               |DDEFECTO #dsarw025;
               #dsarw025#0 = "3.1  ";
               #dsarw025#1 = #dsarm016#0;
               #dsarw025#2 = #dsarm016#5;
               |LEE 000#dsarw025.=;
               |SI FSalida = 0;
                    |ACABA;
               |FINSI;
          |FINSI;

          |DDEFECTO #dsarw025;
          #dsarw025#0 = #dsarm016#2;
          #dsarw025#1 = #dsarm016#0;
          #dsarw025#2 = #dsarm016#5;
          |LEE 101#dsarw025.=;
          |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
          #dsarw025#3 = #dsarm016#1;
          #dsarw025#4 = #dsarm011#2;
          #dsarw025#5 = #dsarm011#3;
          |GRABA 020#dsarw025.a;
          |LIBERA #dsarw025;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm016;
 #dsarm016#1;
 ;
 eaAplicacion, aVersionXML, aBlanco30;
 eaAplicacion, aVersionXML, aZeta30;
 ;
 NULL, dsarm016;
|FIN;

|PROCESO DimePuntos;
     aCadenaPtos = aEsquema;
     |QBF aCadenaPtos;
     aLong = aCadenaPtos % A0;
     nLong = aLong;
     |PARA nCampoVoy = 1; |SI nCampoVoy [ nLong; |HACIENDO nCampoVoy = nCampoVoy + 1;
          nSaca = 100 * nCampoVoy;
          nSaca = nSaca + 1;
          aSaca = nSaca;
          aLetra = aCadenaPtos % aSaca;
          |SI aLetra = ".";
               nPuntos = nPuntos + 1;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Trabajos8;
     aAlfa3 = #1002#2; |QBF aAlfa3;
     ||QuitaRarosXML
     eaAlfa = aAlfa3; |HAZ QuitaRarosXML;  aContenido = eaAlfa; aContenido = aContenido + " ";
     aLinea = aContenido; |HAZ MeteLineaSinReturn; nMeteMultiDetalleOk = 1;
|FPRC;

|PROCESO MultiDetalle;
     aAlfa3 = #1002#4; |QBF aAlfa3;
     ||QuitaRarosXML
     eaAlfa = aAlfa3; |HAZ QuitaRarosXML;  aContenido = eaAlfa; aContenido = aContenido + " ";
     aLinea = aContenido; |HAZ MeteLineaSinReturn; nMeteMultiDetalleOk = 1;
|FPRC;

|PROCESO MultiDetalle_directa;
     aAlfa3 = #1002#6; |QBF aAlfa3;
     ||QuitaRarosXML
     eaAlfa = aAlfa3;     |HAZ QuitaRarosXML;     aContenido = eaAlfa;     aContenido = aContenido + " ";
     aLinea = aContenido;     |HAZ MeteLineaSinReturn;     nMeteMultiDetalleOk = 1;
|FPRC;

|DEFBUCLE MultiDetalle;
 #1002#1004;
 ;
 eaSerieFE, eaNumeroFE, nLinFac, 000;
 eaSerieFE, eaNumeroFE, nLinFac, 999;
 ;
 NULL, MultiDetalle;
|FIN;

|DEFBUCLE MultiDetalle_normal;
 #1002#1004;
 ;
 enTipoFacFe, nCliNormal, nLinFac, 000;
 enTipoFacFe, nCliNormal, nLinFac, 999;
 ;
 NULL, MultiDetalle;
|FIN;

|DEFBUCLE MultiDetalle_directa;
 #1002#1006;
 ;
 enTipoFacFe, eaSerieFE, eaNumeroFE, nCliDirecta, nLinFac, 000;
 enTipoFacFe, eaSerieFE, eaNumeroFE, nCliDirecta, nLinFac, 999;
 ;
 NULL, MultiDetalle_directa;
|FIN;

|DEFBUCLE Trabajos8;
 #1002#1002;
 ;
 nLinFac, 001;
 nLinFac, 999;
 ;
 NULL, Trabajos8;
|FIN;

|PROCESO MeteMultiLin;
     ||TODO CCC
     aNomDef = aPathDef + eaDefMultiLin;
     |CARGA_DEF aNomDef, masdef@;
     |SI FSalida ! 0;
          aMensaje = "0000Problemas CARGA_DEF " + eaDefMultiLin;
          |MENAV aMensaje;
          |ACABA;
     |FINSI;
     |PATH_DAT #1002 aPathDatos;
     nMeteMultiDetalleOk = 0;
     |ABRE #1002;
     |SI eaDefMultiLin = "ashismit";  |BUCLE MultiDetalle;      |FINSI;
     |SI eaDefMultiLin = "agi00003";  |BUCLE Trabajos8;         |FINSI;
     |SI eaDefMultiLin = "aslinmil";  nCliNormal = eaArCodCli;  |BUCLE MultiDetalle_normal; |FINSI;
     |SI eaDefMultiLin = "aslinfdl";  nCliDirecta = eaArCodCli; |BUCLE MultiDetalle_directa; |FINSI;
     |SI nMeteMultiDetalleOk = 0;  aLinea = "."; |HAZ MeteLineaSinReturn;  |FINSI;
     |CIERRA #1002;
     |DESCARGA_DEF #masdef@;
|FPRC;

|PROCESO MeteInfoExtra;
     nAuxInfoExtra = aAuxInfoExtra; |ABRE #dsarm038; |DDEFECTO #dsarm038;
     #dsarm038#0 = nAuxInfoExtra; |LEE 000#dsarm038.=;
     |SI FSalida = 0;
          eaAlfa = #dsarm038#3; |QBF eaAlfa; |SI eaAlfa ! ""; |HAZ QuitaRarosXML; |FINSI;
          aContenido = eaAlfa; aLinea = aContenido; |SI aLinea ! ""; |HAZ MeteLineaSinReturn; |FINSI;
          eaAlfa = #dsarm038#4; |QBF eaAlfa; |SI eaAlfa ! ""; |HAZ QuitaRarosXML; |FINSI;
          aContenido = eaAlfa; aLinea = aContenido; |SI aLinea ! ""; |HAZ MeteLineaSinReturn; |FINSI;
          eaAlfa = #dsarm038#5; |QBF eaAlfa; |SI eaAlfa ! ""; |HAZ QuitaRarosXML; |FINSI;
          aContenido = eaAlfa; aLinea = aContenido; |SI aLinea ! ""; |HAZ MeteLineaSinReturn; |FINSI;
          eaAlfa = #dsarm038#6; |QBF eaAlfa; |SI eaAlfa ! ""; |HAZ QuitaRarosXML; |FINSI;
          aContenido = eaAlfa; aLinea = aContenido; |SI aLinea ! ""; |HAZ MeteLineaSinReturn; |FINSI;
          eaAlfa = #dsarm038#7; |QBF eaAlfa; |SI eaAlfa ! ""; |HAZ QuitaRarosXML; |FINSI;
          aContenido = eaAlfa; aLinea = aContenido; |SI aLinea ! ""; |HAZ MeteLineaSinReturn; |FINSI;
     |FINSI;
|FPRC;

|PROCESO dsarw025;
     ||Gastar aTab

     aTag = #dsarw025#4;
     |QBF aTag;
     |SI aTag ! "";
          nSwCierraTag = 0;
          aEsquema = #dsarw025#1;

          aAlfa3 = aEsquema % 103;
          |SI aAlfa3 = "IVA";
               |ACABA;
          |FINSI;


          ||Arreglo para los IVA, que siempre seran de TaxTypeCode = 1
          aAuxEsquema = #dsarw025#1; |QBF aAuxEsquema;
          |SI aAuxEsquema = "3.1.3.1.1."; |O aAuxEsquema = "3.1.4.1.1."; |O aAuxEsquema = "3.1.6.1.15.1.1.";
               nTaxTypeCode = #dsarw025#3;
               |SI nTaxTypeCode < 7;
                    #dsarw025#3 = 1;         ||IVA: Impuesto sobre el valor anyadido
               |FINSI;
          |FINSI;

          aCadena = aEsquema;
          |QBF aCadena;
          aLong = aCadena % A0;
          nLong = aLong;
          |LEE 000#dsarw026.u;
          |PARA; |SI; |HACIENDO;
               |SI FSalida ! 0;
                    |SAL;
               |SINO;
                    aPatron = #dsarw026#0;
                    |QBF aPatron;
                    aLong = aPatron % A0;
                    nLong2 = aLong;
                    |SI nLong < nLong2;
                         nSwCierraTag = 1;
                    |SINO;
                         nSaca = 100 + nLong2;
                         aSaca = aCadena % nSaca;
                         |QBF aSaca;
                         |SI aSaca ! aPatron;
                              nSwCierraTag = 1;
                         |SINO;
                              |SI aPatron = aCadena;
                                   ||Esto es para el InvoiceLine
                                    nSwCierraTag = 1;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;

               |SI nSwCierraTag = 1;
                    |LEE 101#dsarw026.=;
                    |SI FSalida = 0;
                         aEsquema = #dsarw026#0;
                         nPuntos = 0;
                         |HAZ DimePuntos;
                         aTag = #dsarw026#1;
                         |QBF aTag;

                         aLinea = aTab * nPuntos;

                         aLinea = aLinea + "</" + aTag + ">";
                         |HAZ MeteLinea;

                         |BORRA 020#dsarw026.a;
                         |LIBERA #dsarw026;
                    |SINO;
                         |SAL;
                    |FINSI;

                    |LEE 000#dsarw026.u;
                    nSwCierraTag = 0;
               |SINO;
                    |LEE 000#dsarw026.a;
               |FINSI;
          |SIGUE;
          |SI enMeteAAPP = 1;
               |SI #dsarw025#5 > 2500;
                    enMeteAAPP = 0;
                    enHandleAAPP = nHandleXML;
                    |HAZ MeteDestinoAAPP;
               |FINSI;
          |FINSI;

          aTag = #dsarw025#4;
          |QBF aTag;

          aEsquema = #dsarw025#1;
          nPuntos = 0;
          |HAZ DimePuntos;

          aContenido = #dsarw025#3;
          |QBF aContenido;
          |SI aContenido ! "";
               aAux2 = #dsarw025#1;
               |QBF aAux2;

               nSwMultiLin = 0;
               ||Concepto en varias lineas, en def auxiliar.
               |SI aAux2 = "3.1.6.1.7."; |Y eaDefMultiLin ! "";
                    aAux3 = aContenido - "NUMLINEACONCEPTO ";
                    |SI aAux3 ! aContenido;
                         |QBT aAux3;
                         nLinFac = aAux3;
                         nSwMultiLin = 1;
                    |FINSI;
               |FINSI;

               ||El que manda a la hora de hacer la factura
               ||es la version en los parametros
               ||aVerNorma = #dsarw025#0;
               aVerNorma = aVersionXML;
               aEsqNorma = #dsarw025#1;
               |HAZ NormalizaCampo;

               |SI nSwEstaEsquema = 0;
                    ||No meter en el XML, pertenece a otra version.
                    |ACABA;
               |FINSI;
               ||Ahora el QuitaRarosXML, incluye la parte de conversion a UTF-8
               ||QuitaRarosXML
               eaAlfa = aContenido;
               |HAZ QuitaRarosXML;
               aContenido = eaAlfa;
               aAuxInfoExtra = aContenido - "***DSINFOEXTRA***";
               |SI aAuxInfoExtra ! aContenido;
                    aLinea = aTab * nPuntos; aLinea = aLinea + "<" + aTag + ">"; |HAZ MeteLineaSinReturn;
                    |HAZ MeteInfoExtra;
                    aLinea = "</" + aTag + ">";
                    |HAZ MeteLinea;
               |SINO;
                    |SI nSwMultiLin = 0;
                         aLinea = aTab * nPuntos;
                         aLinea = aLinea + "<" + aTag + ">";
                         aLinea = aLinea + aContenido;
                         aLinea = aLinea + "</" + aTag + ">";
                         |HAZ MeteLinea;
                    |SINO;
                         aLinea = aTab * nPuntos;
                         aLinea = aLinea + "<" + aTag + ">";
                         |HAZ MeteLineaSinReturn;
                         |HAZ MeteMultiLin;
                         aLinea = "</" + aTag + ">";
                         |HAZ MeteLinea;
                    |FINSI;
               |FINSI;

               #dsarw028#0 = aEsqNorma;
               |LEE 101#dsarw028.=;
               |SI FSalida = 0;
                    nTamanyoMinimo = #dsarw028#5;
                    |SI nTamanyoMinimo ! 0;
                         aAlfaTam = aContenido;
                         |QBF aAlfaTam;
                         aLong = aAlfaTam % A0;
                         nLong = aLong;
                         |SI nLong < nTamanyoMinimo;
                              ||No cumple la condicion.
                              |ACABA;
                         |FINSI;
                    |FINSI;

                    aAux = #dsarw028#3;
                    |QBF aAux;
                    |SI aAux = "";
                         #dsarw028#4 = "S";
                         |GRABA 020#dsarw028.a;
                    |SINO;
                         |SI #dsarw028#3 = aVersionXML;
                              #dsarw028#4 = "S";
                              |GRABA 020#dsarw028.a;
                         |FINSI;
                    |FINSI;
                    |LIBERA #dsarw028;
               |FINSI;
          |SINO;
               |DDEFECTO #dsarw026;
               #dsarw026#2 = 0;
               #dsarw026#0 = #dsarw025#1;
               |LEE 101#dsarw026.=;
               |SI FSalida ! 0; |GRABA 020#dsarw026.b; |FINSI;
               #dsarw026#1 = #dsarw025#4;
               #dsarw026#3 = #dsarw025#0;
               #dsarw026#4 = #dsarw025#5;
               |GRABA 020#dsarw026.a;
               |LIBERA #dsarw026;

               aLinea = aTab * nPuntos;
               aLinea = aLinea + "<" + aTag + ">";
               |HAZ MeteLinea;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO NormalizaCampo;
     nSwEstaEsquema = 0;

     |DDEFECTO #dsarm011;
     #dsarm011#0 = aVerNorma;
     #dsarm011#1 = aEsqNorma;
     |LEE 000#dsarm011.=;
     |SI FSalida = 0;
          nSwEstaEsquema = 1;

          aTipoCampo = #dsarm011#4;
          |QBF aTipoCampo;
          |SI aTipoCampo ! "";
               |SI aTipoCampo = "FECHA";
                    aFecha = aContenido;
                    aDia = aFecha % 102;
                    aMes = aFecha % 402;
                    aAnyo = aFecha % -104;
                    aFecha = aAnyo + "-" + aMes + "-" + aDia;
                    aContenido = aFecha;
               |FINSI;
               |SI aTipoCampo = "NUM2D";          ||Decimal, con 2 decimales
                    nDec = 2;
                    |SI eaAplicacion = "dscomer8"; |O eaAplicacion = "dscomer9";
                     |O eaAplicacion = "carrillo"; |O eaAplicacion = "ds-suite";
                     |O eaAplicacion = "compaq"; |O eaAplicacion = "dscepsa";
                     |O eaAplicacion = "drogas86";
                         nAuxNumero = aContenido;
                         nAuxNumero = nAuxNumero ! nDec;
                         aContenido = nAuxNumero;
                    |FINSI;

                    aAlfaEntDecimal = aContenido;
                    |HAZ EnteroDecimal;
                    aContenido = aAlfaEntDecimal;
               |FINSI;
               |SI aTipoCampo = "NUM4D";          ||Decimal, con 4 decimales
                    nDec = 4;
                    |SI eaAplicacion = "dscomer8"; |O eaAplicacion = "dscomer9";
                     |O eaAplicacion = "carrillo"; |O eaAplicacion = "ds-suite";
                     |O eaAplicacion = "compaq"; |O eaAplicacion = "dscepsa";
                     |O eaAplicacion = "drogas86";
                         nAuxNumero = aContenido;
                         nAuxNumero = nAuxNumero ! nDec;
                         aContenido = nAuxNumero;
                    |FINSI;

                    aAlfaEntDecimal = aContenido;
                    |HAZ EnteroDecimal;
                    aContenido = aAlfaEntDecimal;
               |FINSI;
               |SI aTipoCampo = "NUM6D";          ||Decimal, con 6 decimales
                    nDec = 6;
                    |SI eaAplicacion = "dscomer8"; |O eaAplicacion = "dscomer9";
                     |O eaAplicacion = "carrillo"; |O eaAplicacion = "ds-suite";
                     |O eaAplicacion = "compaq"; |O eaAplicacion = "dscepsa";
                     |O eaAplicacion = "drogas86";
                         nAuxNumero = aContenido;
                         nAuxNumero = nAuxNumero ! nDec;
                         aContenido = nAuxNumero;
                    |FINSI;

                    aAlfaEntDecimal = aContenido;
                    |HAZ EnteroDecimal;
                    aContenido = aAlfaEntDecimal;
               |FINSI;
               |SI aTipoCampo = "CERO2";          ||Rellena con ceros por la izq. 2 caracteres
                    aAlfa3 = aContenido;
                    |QBF aAlfa3;
                    aContenido = ("00" + aAlfa3) % -102;
               |FINSI;
               |SI aTipoCampo = "CERO5";          ||Rellena con ceros por la izq. 5 caracteres
                    aAlfa3 = aContenido;
                    |QBF aAlfa3;
                    aContenido = ("00000" + aAlfa3) % -105;
               |FINSI;
               |SI aTipoCampo = "BIC";            ||BICType string : 11
                    aAlfa3 = aContenido;
                    |QBF aAlfa3;
                    aContenido = (aAlfa3 + "XXXXXXXXXXX") % 111;
               |FINSI;

               aBetaAux = aTipoCampo % 103;
               |QBF aBetaAux;
               |SI aBetaAux = "MAX";    ||Alfanumerico de tamamyo maximo
                    aNumCaracteres = aTipoCampo % 4;
                    |QBF aNumCaracteres;
                    nNumCaracteres = aNumCaracteres;
                    aAlfa3 = aContenido;
                    |QBF aAlfa3;
                    aLong = aAlfa3 % A0;
                    nLong = aLong;
                    |SI nLong > nNumCaracteres;
                         nBetaAux = 100 + nNumCaracteres;
                         aAlfa3 = aAlfa3 % nBetaAux;
                         aContenido = aAlfa3;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          nSwEstaEsquema = 0;
     |FINSI;
|FPRC;

|PROCESO EnteroDecimal;
     aAlfa = aAlfaEntDecimal;
     |QBF aAlfa;

     aEntero = "";
     aDecimal = "";
     nSwDecimal = 0;
     aLong = aAlfa % A0;
     nLong = aLong;
     |PARA nNumero = 1; |SI nNumero [ nLong; |HACIENDO nNumero = nNumero + 1;
          nSaca = 100 * nNumero;
          nSaca = nSaca + 1;
          aSaca = nSaca;
          aLetra = aAlfa % aSaca;
          |SI aLetra ! ","; |Y aLetra ! ".";
               |SI nSwDecimal = 0;
                    aEntero = aEntero + aLetra;
               |SINO;
                    aDecimal = aDecimal + aLetra;
               |FINSI;
          |SINO;
               nSwDecimal = 1;
          |FINSI;
     |SIGUE;
     |SI nDec = 0;
          aAlfa = aEntero;
     |SINO;
          |SI nDec = 2;
               aDecimal = (aDecimal + "00") % 102;
               aAlfa = aEntero + "." + aDecimal;
          |FINSI;
          |SI nDec = 4;
               aDecimal = (aDecimal + "0000") % 104;
               aAlfa = aEntero + "." + aDecimal;
          |FINSI;
          |SI nDec = 6;
               aDecimal = (aDecimal + "000000") % 106;
               aAlfa = aEntero + "." + aDecimal;
          |FINSI;
     |FINSI;
     aAlfaEntDecimal = aAlfa;
|FPRC;

|DEFBUCLE dsarw025;
 #dsarw025#2;
 ;
 INICIO;
 FINAL;
 ;
 NULL, dsarw025;
|FIN;

|PROCESO dsarm013_lin;
     |SI eaAplicacion = "facges"; |O eaAplicacion = "facturar"; |O eaAplicacion = "gesracor"; |O eaAplicacion = "ds-suite"; |O eaAplicacion = "dsarchi"; |O eaAplicacion = "dssat";
          nContador = 7000 + #1001#2;
     |SINO;
          nContador = 7000 + #1001#1;
     |FINSI;
     nCampoDef = #dsarm013#2;
     aValorLin = #1001#nCampoDef#;

     aAuxVer = #dsarm013#4;
     aAuxEsq = #dsarm013#5;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#7;
     aAuxEsq = #dsarm013#8;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#10;
     aAuxEsq = #dsarm013#11;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#13;
     aAuxEsq = #dsarm013#14;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#16;
     aAuxEsq = #dsarm013#17;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#19;
     aAuxEsq = #dsarm013#20;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#22;
     aAuxEsq = #dsarm013#23;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#25;
     aAuxEsq = #dsarm013#26;
     |HAZ MeteLin;
|FPRC;

|PROCESO ControlAbonos;
     ||SI son Abonos, hay ciertas cantidades que tienen que ir en NEGATIVO

     aAuxControl = aAuxEsq;
     |QBF aAuxControl;

     ||ABONOS SALVIDAL
     |SI eaAplicacion = "salvidal";
          |SI aSwAbono = "S";
               |SI aAuxControl = "3.1.6.1.8.";           ||Quantity
                    nValorAux = #dsarw025#3;
                    nValorAux = nValorAux * -1;
                    #dsarw025#3 = nValorAux;
               |FINSI;
               |SI aAuxControl = "3.1.6.1.11.";          ||TotalCost
                    nValorAux = #dsarw025#3;
                    nValorAux = nValorAux * -1;
                    #dsarw025#3 = nValorAux;
               |FINSI;
               |SI aAuxControl = "3.1.6.1.14.";          ||GrossAmount
                    nValorAux = #dsarw025#3;
                    nValorAux = nValorAux * -1;
                    #dsarw025#3 = nValorAux;
               |FINSI;
               |SI aAuxControl = "3.1.6.1.15.1.3.1.";    ||TotalAmount
                    nValorAux = #dsarw025#3;
                    nValorAux = nValorAux * -1;
                    #dsarw025#3 = nValorAux;
               |FINSI;
               |SI aAuxControl = "3.1.6.1.15.1.4.1.";    ||TotalAmount
                    nValorAux = #dsarw025#3;
                    nValorAux = nValorAux * -1;
                    #dsarw025#3 = nValorAux;
               |FINSI;
               |SI aAuxControl = "3.1.6.1.15.1.4.1.";    ||TotalAmount
                    nValorAux = #dsarw025#3;
                    nValorAux = nValorAux * -1;
                    #dsarw025#3 = nValorAux;
               |FINSI;
               |SI aAuxControl = "3.1.6.1.15.1.5.";      ||EquivalenceSurcharge
                    nValorAux = #dsarw025#3;
                    nValorAux = nValorAux * -1;
                    #dsarw025#3 = nValorAux;
               |FINSI;
               |SI aAuxControl = "3.1.6.1.15.1.6.1.";    ||TotalAmount
                    nValorAux = #dsarw025#3;
                    nValorAux = nValorAux * -1;
                    #dsarw025#3 = nValorAux;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MeteLin;
     aAuxDatos = aAuxEsq;
     |QBF aAuxDatos;
     |SI aAuxDatos ! "";
          |SI aAuxDatos = "PORTESLIN";
               nPortesLin = aValorLin;
               |ACABA;
          |FINSI;
          |SI aAuxDatos = "PORTESIVALIN";
               nPortesIvaLin = aValorLin;
               |ACABA;
          |FINSI;

          |SI eaAplicacion = "dscomer9"; |Y eaDefFE = "con00637"; |Y eaDefAlbFe = "con00626";
               |SI aAuxDatos = "3.1.6.1.3."; |O aAuxDatos = "3.1.6.1.27.";
                    aNomDef = aPathDef + "agifa019";
                    |CARGA_DEF aNomDef, cuatro@;
                    |SI FSalida ! 0;
                         aMensaje = "0000Problemas CARGA_DEF Articulos [agifa019]";
                         |MENAV aMensaje;
                         |ACABA;
                    |FINSI;
                    |PATH_DAT #1004 aPathDatos;

                    |ABRE #1004;
                    |DDEFECTO #1004;
                    #1004#0 = aValorLin;
                    |LEE 000#1004.=;
                    nTipoIvaArt = #1004#30;
                    |CIERRA #1004;
                    |DESCARGA_DEF #cuatro@;

                    ||CARGA_DEF DEL AGIFA019  .. necesito campo #30.
                    ||Buscar Tipo de IVA. y lo meto en 3.1.6.1.15.1.1.
                    |DDEFECTO #dsarw025;
                    aAuxEsq = "3.1.6.1.15.1.1.";

                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = aAuxEsq;
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    #dsarw025#3 = nTipoIvaArt;
                    |HAZ Pon4y5;

                    |SI aAuxEsq = "3.1.6.1.15.1.1.";        ||TaxTypeCode
                         nPorIva = 0;
                         nIvaEstoy = #dsarw025#3;
                         |SI nIvaEstoy = 0;
                              nPorIva = nIva0;
                         |FINSI;
                         |SI nIvaEstoy = 1;
                              nPorIva = nIva1;
                         |FINSI;
                         |SI nIvaEstoy = 2;
                              nPorIva = nIva2;
                         |FINSI;
                         |SI nIvaEstoy = 3;
                              nPorIva = nIva3;
                         |FINSI;
                         |SI nIvaEstoy = 4;
                              nPorIva = nIva4;
                         |FINSI;
                         |SI nIvaEstoy = 5;
                              nPorIva = nIva5;
                         |FINSI;

                         aAuxEsq = "3.1.6.1.15.1.2.";  ||TaxRate.. %IVA
                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = nPorIva;
                         |HAZ Pon4y5;

                         aAuxEsq = "3.1.6.1.15.1.4.1.";  ||TaxAmount (TotalAmount).. %IVA
                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         |SI nPorIva = 0;
                              #dsarw025#3 = 0;
                         |SINO;
                              ||Campo Importe total en con00626.
                              nCuotaIvaLin = #1002#8 % nPorIva;
                              #dsarw025#3 = nCuotaIvaLin;
                         |FINSI;
                         |HAZ Pon4y5;
                    |FINSI;
                    aAuxEsq = aAuxDatos;
               |FINSI;
               ||Estoy dentro de eaAplicacion = "dscomer9"; |Y eaDefFE = "con00637";
               |SI aAuxDatos = "3.1.6.1.3."; |O aAuxDatos = "3.1.6.1.27.";            ||ReceiverContractReference
                    aAuxDos = aValorLin;
                    |QBF aAuxDos;
                    |SI aAuxDos = "";
                         |DDEFECTO #dsarw025;
                         aAuxEsq = aAuxDatos;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = "_";
                         |HAZ Pon4y5;
                    |FINSI;
               |FINSI;
          |FINSI;

          |SI aAuxDatos = "PEDIDONUM";
               aAuxAux = aValorLin;
               nNumPed = aAuxAux;
               |ACABA;
          |FINSI;
          |SI aAuxDatos = "PEDIDOSER";
               aAuxAux = aValorLin;
               aSerPed = aAuxAux;
               |ACABA;
          |FINSI;

          |SI aAuxDatos = "3.1.6.1.11.";
               nImpDto1CalDto2 = 0;          ||Aqui lo pongo a cero
               nImpBaseCalDto2 = aValorLin;
          |FINSI;

          |SI aAuxDatos = "3.1.6.1.12.1.3.";
               ||ESTO ESTA CALCULADO EN LA APLICACION
          |FINSI;

          |SI aAuxDatos = "3.1.6.1.14.";
               nImpBrutoCalDto2 = aValorLin;
          |FINSI;

          |SI aAuxDatos = "DTODOSLINEA";
               nDifZ = nImpBaseCalDto2 - nImpDto1CalDto2;
               nImpDtoDos = nDifZ - nImpBrutoCalDto2;
               nDtoDos = (((100) * nImpDtoDos) / nImpBaseCalDto2 );

               nValorLin = aValorLin;
               |SI nValorLin = 0;
                    |ACABA;
               |FINSI;

               |DDEFECTO #dsarw025;
               aAuxEsq = "3.1.6.1.12.2."
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = nContador;
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = "";
               #dsarw025#4 = "Discount";
               #dsarw025#5 = 4711;
               |GRABA 020#dsarw025.a;
               |LIBERA #dsarw025;

               |DDEFECTO #dsarw025;
               aAuxEsq = "3.1.6.1.12.2.1."
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = nContador;
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = "Descuento 2";
               #dsarw025#4 = "DiscountReason";
               #dsarw025#5 = 4712;
               |GRABA 020#dsarw025.a;
               |LIBERA #dsarw025;

               |DDEFECTO #dsarw025;
               aAuxEsq = "3.1.6.1.12.2.2."
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = nContador;
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = nDtoDos;
               #dsarw025#4 = "DiscountRate";
               #dsarw025#5 = 4713;
               |GRABA 020#dsarw025.a;
               |LIBERA #dsarw025;

               |DDEFECTO #dsarw025;
               aAuxEsq = "3.1.6.1.12.2.3."
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = nContador;
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = nImpDtoDos;
               #dsarw025#4 = "DiscountAmount";
               #dsarw025#5 = 4714;
               |GRABA 020#dsarw025.a;
               |LIBERA #dsarw025;

               |ACABA;
          |FINSI;

          |SI eaAplicacion = "compaq";
               |SI aAuxDatos = "3.1.6.1.8.";   ||Quantity
                    nUniLineaCal = aValorLin;
               |FINSI;
               |SI aAuxDatos = "3.1.6.1.10.";  ||UnitPriceWithoutTax
                    nImpLineaCal = aValorLin;
               |FINSI;

               |SI aAuxDatos = "3.1.6.1.11.";  ||TotalCost
                    nAuxTotalCost = aValorLin;
                    |SI nAuxTotalCost = 0;
                         ||ATENCION. ||TODO CCC
                         ||Me da error de redondeo, si redondeo a 2 decimales.
                         ||nAuxTotalCost = (nUniLineaCal * nImpLineaCal) ! 2;
                         ||ESTO ES LO CORRECTO. (sin redondeo a 2 decimales)
                         nAuxTotalCost = nUniLineaCal * nImpLineaCal;
                         aValorLin = nAuxTotalCost;
                    |FINSI;
               |FINSI;
          |FINSI;

          |DDEFECTO #dsarm011;
          #dsarm011#0 = aAuxVer;
          #dsarm011#1 = aAuxEsq;
          |LEE 000#dsarm011.=;
          |SI #dsarm011#6 = "S";   ||OMITIR SI CERO, EN LAS LINEAS
               nNumero3 = aValorLin;
               |SI nNumero3 = 0;
                    |ACABA;
               |FINSI;
          |FINSI;

          nCampoDef = #dsarm013#2;
          aAuxAux = aValorLin;
          |QBF aAuxAux;
          |SI aAuxAux ! ""; |O aAuxDatos = "3.1.6.1.7.";
               |SI aAuxDatos = "3.1.6.1.7."; |Y aAuxAux = "";         ||ItemDescription
                    aValorLin = " ";
               |FINSI;

               |SI aAuxDatos = "NUMLINEACONCEPTO"; |Y eaDefMultiLin ! "";
                    |DDEFECTO #dsarw025;
                    aAuxEsq = "3.1.6.1.7.";

                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = aAuxEsq;
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    #dsarw025#3 = "NUMLINEACONCEPTO " + aValorLin;
                    |HAZ Pon4y5;
               |SINO;
                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = aAuxEsq;
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    nCampoDef = #dsarm013#2;
                    aAlfa3 = aAuxEsq;
                    |QBF aAlfa3;
                    |SI aAlfa3 = "3.1.6.1.15.1.1.";        ||TaxTypeCode
                         ||No permito el Tipo IVA O.
                         nIvaEstoy = aValorLin;
                         |SI nIvaEstoy = 0;
                              #dsarw025#3 = 6;
                         |SINO;
                              #dsarw025#3 = aValorLin;
                         |FINSI;
                    |SINO;
                         |SI aAuxDatos = "3.1.6.1.10."; |Y eaAplicacion = "edi";       ||Precio Sin impuesto
                              |SI #1001#26 = "U";
                                   nValorLin = aValorLin;
                                   #dsarw025#3 = nValorLin;
                              |SINO;
                                   nValorLin = aValorLin;
                                   nValorLin = nValorLin / 1000;
                                   #dsarw025#3 = nValorLin;
                              |FINSI;
                         |SINO;
                              |SI aAlfa3 = "3.1.6.1.15.1.3.1.";        ||TotalAmount IVA
                                   nNumeroAux = aValorLin;
                                   /*
                                   |SI nDtoCab ! 0;
                                        nNumeroAux = nNumeroAux < nDtoCab;
                                   |FINSI;
                                   |SI nDtoCabAC ! 0;
                                        nNumeroAux = nNumeroAux < nDtoCabAC;
                                   |FINSI;
                                   |SI nDtoCabPP ! 0;
                                        nNumeroAux = nNumeroAux < nDtoCabPP;
                                   |FINSI;
                                   */
                                   #dsarw025#3 = nNumeroAux;
                              |SINO;
                                   #dsarw025#3 = aValorLin;
                              |FINSI;
                         |FINSI;
                    |FINSI;

                    |SI eaAplicacion = "salvidal";
                         |HAZ ControlAbonos;
                    |FINSI;
                    |HAZ Pon4y5;
               |FINSI;

               ||ARA 42
               |SI eaDefAlbFe ! "";
                    |SI aSerAlb ! ""; |Y nNumAlb ! 0;
                         |QBF aAuxEsq;
                         |SI aAuxEsq = "3.1.6.1.3."; |O aAuxDatos = "3.1.6.1.27.";       ||Codigo Articulo. IssuerContractReference
                              enSwDeliveryEstaAlba = 0; |HAZ DeliveryEstaAlba;
                              |SI enSwDeliveryEstaAlba = 0;
                                   aAuxEsq = "3.1.6.1.6.1.1.";   ||DeliveryNoteNumber Albaran
                                   |DDEFECTO #dsarw025;
                                   #dsarw025#0 = aAuxVer;
                                   #dsarw025#1 = aAuxEsq;
                                   #dsarw025#2 = nContador;
                                   |LEE 101#dsarw025.=;
                                   |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                                   aAlfaAlba = aSerAlb;
                                   |QBF aAlfaAlba;
                                   aAlfaAlba = aAlfaAlba + "/" + nNumAlb;
                                   #dsarw025#3 = aAlfaAlba;
                                   |HAZ Pon4y5;
                              |FINSI;
                         |FINSI;
                    |SINO;
                         |SI nNumAlb ! 0;
                              |QBF aAuxEsq;
                              |SI aAuxEsq = "3.1.6.1.3."; |O aAuxDatos = "3.1.6.1.27.";       ||Codigo Articulo. IssuerContractReference
                                   enSwDeliveryEstaAlba = 0; |HAZ DeliveryEstaAlba;
                                   |SI enSwDeliveryEstaAlba = 0;
                                        aAuxEsq = "3.1.6.1.6.1.1.";   ||DeliveryNoteNumber Albaran
                                        |DDEFECTO #dsarw025;
                                        #dsarw025#0 = aAuxVer;
                                        #dsarw025#1 = aAuxEsq;
                                        #dsarw025#2 = nContador;
                                        |LEE 101#dsarw025.=;
                                        |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                                        #dsarw025#3 = aNumAlb;
                                        |HAZ Pon4y5;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;

               |QBF aAuxEsq;
               |SI aAuxEsq = "3.1.6.1.15.1.3.1.";        ||TotalAmount IVA

                    |SI eaAplicacion = "marmol";
                         |SI eaDefFE = "efactuca"; |O eaDefFE = "facturas";
                              nImpoIvaLin = #1002#nCampoDef#;
                         |SINO;
                              nImpoIvaLin = #1001#nCampoDef#;
                         |FINSI;
                    |SINO;
                         |SI eaAplicacion = "salvidal"; |O eaAplicacion = "carrillo";
                              nImpoIvaLin = #1002#nCampoDef#;
                         |SINO;
                              |SI eaAplicacion = "dscomer8"; |O eaAplicacion = "dscomer9"; |O eaAplicacion = "dscepsa";
                                        |O eaAplicacion = "drogas86";
                                   |SI eaDefFE = "agifa084";
                                        nImpoIvaLin = #1001#nCampoDef#;
                                   |SINO;
                                        nImpoIvaLin = #1002#nCampoDef#;
                                   |FINSI;
                              |SINO;
                                   |SI eaAplicacion = "compaq";
                                        nImpoIvaLin = #1002#nCampoDef#;
                                   |SINO;
                                        nImpoIvaLin = #1001#nCampoDef#;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                         ||DESCUENTOSCAB, pero se aplican al importe de la linea
                         ||ARA45
                         /*
                         |SI nDtoCab ! 0;
                              nImpoIvaLin = nImpoIvaLin < nDtoCab;
                         |FINSI;
                         |SI nDtoCabAC ! 0;
                              nImpoIvaLin = nImpoIvaLin < nDtoCabAC;
                         |FINSI;
                         |SI nDtoCabPP ! 0;
                              nImpoIvaLin = nImpoIvaLin < nDtoCabPP;
                         |FINSI;
                         */
                    |FINSI;
                    |SI nDtoLinea ! 0;
                         |SI eaAplicacion = "edi";
                              nImpoIvaLin = (nImpoIvaLin < nDtoLinea) ! 2;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida = 0;
                                   nContenido = #dsarw025#3;
                                   nContenido = (nContenido < nDtoLinea) ! 2;
                                   #dsarw025#3 = nContenido;
                                   |GRABA 020#dsarw025.a;
                                   |LIBERA #dsarw025;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;

               |SI aAuxEsq = "3.1.6.1.8."; |Y eaAplicacion = "salvidal";       ||Quantity y Salvador Vidal
                    nUnidades = #1002#nCampoDef#;
               |FINSI;

               |SI aAuxEsq = "3.1.6.1.8."; |Y eaAplicacion = "dscomer9"; |Y eaDefFE = "con00637";
                    nCantidadLin = #1002#nCampoDef#;
               |FINSI;

               |SI aAuxEsq = "3.1.6.1.10."; |Y eaAplicacion = "salvidal";       ||Precio Unitario y Salvador Vidal
                    |SI nUnidades > 1;
                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         nValorLin = aValorLin;
                         nValorLin = nValorLin / nUnidades;
                         #dsarw025#3 = nValorLin;

                         |SI eaAplicacion = "salvidal";
                              |HAZ ControlAbonos;
                         |FINSI;
                         |HAZ Pon4y5;
                    |FINSI;
               |FINSI;

               |SI aAuxEsq = "3.1.6.1.15.1.1.";        ||TaxTypeCode
                    nPorIva = 0;
                    nPorReq = 0;
                    nIvaEstoy = aValorLin;
                    |SI nIvaEstoy = 0;
                         nPorIva = nIva0;
                         |SI nSwEsRecEqui = 1;
                              nPorReq = nReq0;
                         |FINSI;
                    |FINSI;
                    |SI nIvaEstoy = 1;
                         nPorIva = nIva1;
                         |SI nSwEsRecEqui = 1;
                              nPorReq = nReq1;
                         |FINSI;
                    |FINSI;
                    |SI nIvaEstoy = 2;
                         nPorIva = nIva2;
                         |SI nSwEsRecEqui = 1;
                              nPorReq = nReq2;
                         |FINSI;
                    |FINSI;
                    |SI nIvaEstoy = 3;
                         nPorIva = nIva3;
                         |SI nSwEsRecEqui = 1;
                              nPorReq = nReq3;
                         |FINSI;
                    |FINSI;
                    |SI nIvaEstoy = 4;
                         nPorIva = nIva4;
                         |SI nSwEsRecEqui = 1;
                              nPorReq = nReq4;
                         |FINSI;
                    |FINSI;
                    |SI nIvaEstoy = 5;
                         nPorIva = nIva5;
                         |SI nSwEsRecEqui = 1;
                              nPorReq = nReq5;
                         |FINSI;
                    |FINSI;

                    aAuxEsq = "3.1.6.1.15.1.2.";  ||TaxRate.. %IVA
                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = aAuxEsq;
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    #dsarw025#3 = nPorIva;

                    |SI eaAplicacion = "salvidal";
                         |HAZ ControlAbonos;
                    |FINSI;
                    |HAZ Pon4y5;

                    aAuxEsq = "3.1.6.1.15.1.4.1.";  ||TaxAmount (TotalAmount).. %IVA
                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = aAuxEsq;
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    |SI nPorIva = 0;
                         #dsarw025#3 = 0;
                    |SINO;
                         nCuotaIvaLin = nImpoIvaLin % nPorIva;
                         #dsarw025#3 = nCuotaIvaLin;
                    |FINSI;
                    |SI eaAplicacion = "salvidal";
                         |HAZ ControlAbonos;
                    |FINSI;
                    |HAZ Pon4y5;

                    |SI nSwEsRecEqui = 1; |Y nPorReq ! 0;
                         ||3.1.6.1.15.1.5.
                         ||3.1.6.1.15.1.6.1.
                         aAuxEsq = "3.1.6.1.15.1.5.";  ||EquivalenceSurcharge   % REC. EQUI.
                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = nPorReq;
                         |HAZ Pon4y5;

                         ||3.1.6.1.15.1.6.1.
                         aAuxEsq = "3.1.6.1.15.1.6.1.";  ||TotalAmount (EquivalenceSurchargeAmount)
                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         nTotalReq = (nImpoIvaLin % nPorReq) ! 2;
                         #dsarw025#3 = nTotalReq;
                         |HAZ Pon4y5;
                    |FINSI;

                    |SI nIvaEstoy = 0;
                         nTotalIva0 = 0;
                         nSwFaltaCabIva0 = 1;
                         nPorIva0 = 0;
                    |FINSI;

                    |SI nIvaEstoy = 1;
                         nTotalIva1 = nTotalIva1 + #dsarw025#3;
                         nSwFaltaCabIva1 = 1;
                         nPorIva1 = nIva1;
                    |FINSI;
                    |SI nIvaEstoy = 2;
                         nTotalIva2 = nTotalIva2 + #dsarw025#3;
                         nSwFaltaCabIva2 = 1;
                         nPorIva2 = nIva2;
                    |FINSI;
                    |SI nIvaEstoy = 3;
                         nTotalIva3 = nTotalIva3 + #dsarw025#3;
                         nSwFaltaCabIva3 = 1;
                         nPorIva3 = nIva3;
                    |FINSI;
                    |SI nIvaEstoy = 4;
                         nTotalIva4 = nTotalIva4 + #dsarw025#3;
                         nSwFaltaCabIva4 = 1;
                         nPorIva4 = nIva4;
                    |FINSI;
                    |SI nIvaEstoy = 5;
                         nTotalIva5 = nTotalIva5 + #dsarw025#3;
                         nSwFaltaCabIva5 = 1;
                         nPorIva5 = nIva5;
                    |FINSI;

                    ||Tb. le meto la fecha, si no la he metido antes.
                    aAuxEsq = "3.1.6.1.18.";  ||TransactionDate
                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = aAuxEsq;
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0;
                         #dsarw025#3 = aFechaFactura;
                         |DDEFECTO #dsarm011;
                         #dsarm011#0 = aAuxVer;
                         #dsarm011#1 = aAuxEsq;
                         |LEE 000#dsarm011.=;
                         #dsarw025#4 = #dsarm011#2;
                         #dsarw025#5 = #dsarm011#3;
                         |GRABA 020#dsarw025.n;
                         |LIBERA #dsarw025;
                    |FINSI;
               |FINSI;

               |SI eaAplicacion = "facges"; |O eaAplicacion = "facturar";
                    |SI aAuxEsq = "3.1.6.1.15.1.3.1.";           ||TotalAmount
                         aTipoLinFacturar = "";
                         |SI eaDefLinFe = "ashismil"; |O eaDefLinFe = "aslinfdi"; |O eaDefLinFe = "aslinmin";
                              aTipoLinFacturar = #1001#10;
                         |FINSI;
                         |SI aTipoLinFacturar = "S";     ||Suplido
                              ||Para Suplidos, ponemos tipo iva = 10
                              aAuxEsq = "3.1.6.1.15.1.1.";  || TaxTypeCode
                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = "10";
                              |HAZ Pon4y5;

                              ||Tb. meto el % IVA
                              aAuxEsq = "3.1.6.1.15.1.2.";  ||TaxRate
                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = 0;
                              |HAZ Pon4y5;

                              ||Cuota de IVA
                              aAuxEsq = "3.1.6.1.15.1.4.1.";  ||TaxAmount (TotalAmount).. %IVA
                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = 0;
                              |HAZ Pon4y5;
                         |SINO;
                              ||Necesito el Tipo de IVA.
                              aAuxEsq = "3.1.6.1.15.1.1.";  || TaxTypeCode
                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = "01";
                              |HAZ Pon4y5;

                              ||Tb. meto el % IVA
                              aAuxEsq = "3.1.6.1.15.1.2.";  ||TaxRate
                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = enTipoIvaFe;
                              |HAZ Pon4y5;

                              ||Cuota de IVA
                              aAuxEsq = "3.1.6.1.15.1.4.1.";  ||TaxAmount (TotalAmount).. %IVA
                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              nPorIva = enTipoIvaFe;
                              |SI nPorIva = 0;
                                   #dsarw025#3 = 0;
                              |SINO;
                                   nCuotaIvaLin = nImpoIvaLin % nPorIva;
                                   #dsarw025#3 = nCuotaIvaLin;
                              |FINSI;
                              |HAZ Pon4y5;

                              |SI nSwHayRetenCab = 1;
                                   ||RETENCION IRPF LINEA

                                   |DDEFECTO #dsarw025;
                                   #dsarw025#0 = aAuxVer;
                                   #dsarw025#1 = "3.1.6.1.14b.1.1.";  ||TaxTypeCode;
                                   #dsarw025#2 = nContador;
                                   |LEE 101#dsarw025.=;
                                   |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                                   #dsarw025#3 = 12;

                                   |HAZ Pon4y5_w025;

                                   |DDEFECTO #dsarw025;
                                   #dsarw025#0 = aAuxVer;
                                   #dsarw025#1 = "3.1.6.1.14b.1.2.";  ||TaxRate;
                                   #dsarw025#2 = nContador;
                                   |LEE 101#dsarw025.=;
                                   |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                                   #dsarw025#3 = enPorRetenIRPF;

                                   |HAZ Pon4y5_w025;

                                   |DDEFECTO #dsarw025;
                                   #dsarw025#0 = aAuxVer;
                                   #dsarw025#1 = "3.1.6.1.14b.1.3.1.";  ||TotalAmount
                                   #dsarw025#2 = nContador;
                                   |LEE 101#dsarw025.=;
                                   |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                                   #dsarw025#3 = nImpoIvaLin;

                                   |HAZ Pon4y5_w025;

                                   |DDEFECTO #dsarw025;
                                   #dsarw025#0 = aAuxVer;
                                   #dsarw025#1 = "3.1.6.1.14b.1.4.1.";  ||TotalAmount
                                   #dsarw025#2 = nContador;
                                   |LEE 101#dsarw025.=;
                                   |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                                   nPorReten = enPorRetenIRPF;
                                   |SI nPorIva = 0;
                                        #dsarw025#3 = 0;
                                   |SINO;
                                        nCuotaReten = nImpoIvaLin % nPorReten;
                                        #dsarw025#3 = nCuotaReten;
                                   |FINSI;
                                   |HAZ Pon4y5_w025;
                              |FINSI;
                         |FINSI;

                         ||Tb. le meto la fecha.
                         aAuxEsq = "3.1.6.1.18.";  ||TransactionDate
                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = aFechaFactura;
                         |HAZ Pon4y5;
                    |FINSI;
               |FINSI;

               |SI eaAplicacion = "marmol"; |O eaAplicacion = "gesracor"; |O eaAplicacion = "salvidal"; |O eaAplicacion = "edi"; |O eaAplicacion = "dssat";
                    |SI aAuxEsq = "3.1.6.1.15.1.3.1.";           ||TotalAmount
                         ||Necesito el Tipo de IVA.
                         aAuxEsq = "3.1.6.1.15.1.1.";  || TaxTypeCode
                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = "01";
                         |HAZ Pon4y5;

                         ||Tb. meto el % IVA
                         aAuxEsq = "3.1.6.1.15.1.2.";  ||TaxRate
                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = enTipoIvaFe;
                         |HAZ Pon4y5;

                         ||Cuota de IVA
                         aAuxEsq = "3.1.6.1.15.1.4.1.";  ||TaxAmount (TotalAmount).. %IVA
                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         nPorIva = enTipoIvaFe;
                         |SI nPorIva = 0;
                              #dsarw025#3 = 0;
                         |SINO;
                              nCuotaIvaLin = nImpoIvaLin % nPorIva;
                              #dsarw025#3 = nCuotaIvaLin;
                         |FINSI;
                         |SI eaAplicacion = "salvidal";
                               |HAZ ControlAbonos;
                         |FINSI;
                         |HAZ Pon4y5;
||ARA. R.E.
                         |SI nREUnico ! 0;

                              ||RECARGO EQUIVALENCIA.
                              aAuxEsq = "3.1.6.1.15.1.5.";  ||EquivalenceSurcharge
                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nREUnico;
                              |HAZ Pon4y5;

                              ||RECARGO EQUIVALENCIA.
                              aAuxEsq = "3.1.6.1.15.1.6.1.";  ||TotalAmount
                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              nCuotaIvaLin = nImpoIvaLin % nREUnico;
                              #dsarw025#3 = nCuotaIvaLin;

                              |SI eaAplicacion = "salvidal";
                                   |HAZ ControlAbonos;
                              |FINSI;
                              |HAZ Pon4y5;
                         |FINSI;

                         ||Tb. le meto la fecha.
                         aAuxEsq = "3.1.6.1.18.";  ||TransactionDate
                         |DDEFECTO #dsarw025;
                         #dsarw025#0 = aAuxVer;
                         #dsarw025#1 = aAuxEsq;
                         #dsarw025#2 = nContador;
                         |LEE 101#dsarw025.=;
                         |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                         #dsarw025#3 = aFechaFactura;
                         |HAZ Pon4y5;

                         |SI eaAplicacion = "gesracor";
                              ||Le tengo que meter cantidad en la linea. Pq. no tiene.
                              aAuxEsq = "3.1.6.1.8.";  ||Quantity

                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = 1;
                              |HAZ Pon4y5;
                         |FINSI;
                    |FINSI;
               |FINSI;

               |SI aAuxEsq = "3.1.6.1.12.1.2.";  ||DiscountRate
                    aAuxEsq = "3.1.6.1.12.1.1.";  ||DiscountReason
                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = aAuxEsq;
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    #dsarw025#3 = "Descuento";
                    |HAZ Pon4y5;

                    nDtoAra = aValorLin;
                    ||Cantidad Descuento Linea
                    aAuxEsq = "3.1.6.1.12.1.3.";  ||DiscountAmount
                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = aAuxEsq;
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;

                    nContenido = nTotalCost;

                    ||Tiquet. 3023.186.  Primero lo paso a 2 decimales.
                    nDec = 2;
                    aAlfaEntDecimal = nContenido;
                    |HAZ EnteroDecimal;
                    nContenido = aAlfaEntDecimal;

                    nContenido = (nContenido % nDtoAra) ! 2;
                    #dsarw025#3 = nContenido;
                    nImpDto1CalDto2 = nContenido;
                    |HAZ Pon4y5;
               |FINSI;

               |SI aAuxEsq = "3.1.6.1.11.";         ||TotalCost
                    nTotalCost = #dsarw025#3;
               |FINSI;

               |SI nDtoLinea ! 0;
                    |SI eaAplicacion = "edi";
                         |SI aAuxEsq = "3.1.6.1.11.";         ||TotalCost
                              nTotalCost = #dsarw025#3;
                              ||Meto todo lo relativo al Descuento

                              aAuxEsq = "3.1.6.1.12.1.1.";  ||DiscountReason
                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = "Descuento";
                              |HAZ Pon4y5;

                              ||Tb. meto el % descuneto
                              aAuxEsq = "3.1.6.1.12.1.2.";  ||DiscountRate
                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              #dsarw025#3 = nDtoLinea;
                              |HAZ Pon4y5;

                              ||Cantidad Descuento Linea
                              aAuxEsq = "3.1.6.1.12.1.3.";  ||DiscountAmount
                              |DDEFECTO #dsarw025;
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                              nContenido = nTotalCost;
                              nContenido = (nContenido % nDtoLinea) ! 2;
                              #dsarw025#3 = nContenido;
                              nImpDto1CalDto2 = nContenido;
                              |HAZ Pon4y5;
                         |FINSI;

                         |SI aAuxEsq = "3.1.6.1.14.";         ||GrossAmount
                              #dsarw025#0 = aAuxVer;
                              #dsarw025#1 = aAuxEsq;
                              #dsarw025#2 = nContador;
                              |LEE 101#dsarw025.=;
                              |SI FSalida = 0;
                                   nContenido = #dsarw025#3;
                                   nContenido = (nContenido < nDtoLinea) ! 2;
                                   #dsarw025#3 = nContenido;
                                   |GRABA 020#dsarw025.a;
                                   |LIBERA #dsarw025;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;

               |SI aAuxEsq = "3.1.6.1.10."; |Y eaAplicacion = "dscomer9"; |Y eaDefFE = "con00637";
                    |DDEFECTO #dsarw025;
                    aAuxEsq = "3.1.6.1.11.";                 ||Total Cost
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = aAuxEsq;
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    nNumAux = #1002#nCampoDef#;
                    nNumAux = nCantidadLin * nNumAux;
                    #dsarw025#3 = nNumAux;
                    |HAZ Pon4y5;
                    nCantidadLin = 0;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm013_lin;
 #dsarm013#1;
 ;
 eaAplicacion, eaDefLinFe,   0;
 eaAplicacion, eaDefLinFe, 255;
 ;
 NULL, dsarm013_lin;
|FIN;

|PROCESO Lineas;
     |BUCLE dsarm013_lin;
|FPRC;

|DEFBUCLE Lineas;
 #1001#1003;
 ;
 eaSerieFE, eaNumeroFE,   1;
 eaSerieFE, eaNumeroFE, 999;
 ;
 NULL, Lineas;
|FIN;

|DEFBUCLE Lineas_aslinmin;
 #1001#1003;
 ;
 enTipoFacFe, eaCodCliFe,   1;
 enTipoFacFe, eaCodCliFe, 999;
 ;
 NULL, Lineas;
|FIN;

|DEFBUCLE Lineas_faclinco;
 #1001#1002;
 ;
 eaNumeroFE,    1;
 eaNumeroFE, 9999;
 ;
 NULL, Lineas;
|FIN;


|DEFBUCLE Lineas_aslinfdi;
 #1001#1005;
 ;
 enTipoFacFe, eaSerieFE, eaNumeroFE, eaCodCliFe,   1;
 enTipoFacFe, eaSerieFE, eaNumeroFE, eaCodCliFe, 999;
 ;
 NULL, Lineas;
|FIN;


|PROCESO MiraSerNumAlb;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          |SI aAuxEsq = "ALBASER";
               aSerAlb = #1001#nCampoDef#;
          |FINSI;
          |SI aAuxEsq = "ALBANUM";
               nNumAlb = #1001#nCampoDef#;
          |FINSI;
          |SI aAuxEsq = "ALBALIN";
               nNumLinAlb = #1001#nCampoDef#;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO dsarm013_DameSerNumAlb;
     nCampoDef = #dsarm013#2;

     aAuxEsq = #dsarm013#5;
     |HAZ MiraSerNumAlb;

     aAuxEsq = #dsarm013#8;
     |HAZ MiraSerNumAlb;

     aAuxEsq = #dsarm013#11;
     |HAZ MiraSerNumAlb;

     aAuxEsq = #dsarm013#14;
     |HAZ MiraSerNumAlb;

     aAuxEsq = #dsarm013#17;
     |HAZ MiraSerNumAlb;

     aAuxEsq = #dsarm013#20;
     |HAZ MiraSerNumAlb;

     aAuxEsq = #dsarm013#23;
     |HAZ MiraSerNumAlb;

     aAuxEsq = #dsarm013#26;
     |HAZ MiraSerNumAlb;
|FPRC;

|DEFBUCLE dsarm013_DameSerNumAlb;
 #dsarm013#1;
 ;
 eaAplicacion, eaDefLinFe,   0;
 eaAplicacion, eaDefLinFe, 255;
 ;
 NULL, dsarm013_DameSerNumAlb;
|FIN;

|PROCESO DameSerNumAlb;
     ||ALBASER
     ||ALBANUM
     |BUCLE dsarm013_DameSerNumAlb;
|FPRC;

|PROCESO PonMatricula;
     aAuxEsq = "3.1.6.1.19.";
     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = eaMatriculaFE;
     |HAZ Pon4y5;
|FPRC;

|PROCESO dsarm013_linalb;
     nContador = 7000 + nLinAux;
     nCampoDef = #dsarm013#2;
     aValorLin = #1002#nCampoDef#;
     |SI eaDefFE = "con00637"; |Y eaAplicacion = "dscomer9"; |Y nCampoDef = 7; |Y eaDefAlbFe = "con00626"; ||Facturas OR. Mod. 001996
          |SI eaMatriculaFE ! ""; |HAZ PonMatricula; |FINSI;
          enImpo = (#1002#4 * #1002#5) % #1002#6; |HAZ Trunca3; aValorLin = enImpo; || DiscountAmount
     |FINSI;
     |SI eaDefFE = "con00637"; |Y eaAplicacion = "dscomer9"; |Y nCampoDef = 1; |Y eaDefAlbFe = "agifa071"; |Y eaMatriculaFE ! "";
          |HAZ PonMatricula;
     |FINSI;
     aAuxVer = #dsarm013#4;
     aAuxEsq = #dsarm013#5;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#7;
     aAuxEsq = #dsarm013#8;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#10;
     aAuxEsq = #dsarm013#11;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#13;
     aAuxEsq = #dsarm013#14;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#16;
     aAuxEsq = #dsarm013#17;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#19;
     aAuxEsq = #dsarm013#20;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#22;
     aAuxEsq = #dsarm013#23;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#25;
     aAuxEsq = #dsarm013#26;
     |HAZ MeteLin;
|FPRC;

|DEFBUCLE dsarm013_linalb;
 #dsarm013#1;
 ;
 eaAplicacion, eaDefAlbFe,   0;
 eaAplicacion, eaDefAlbFe, 255;
 ;
 NULL, dsarm013_linalb;
|FIN;

|PROCESO dsarm013_cabped;
     nCampoDef = #dsarm013#2;
     aValorLin = #1003#nCampoDef#;

     |QBF aValorLin;
     |SI aValorLin = "";
          |ACABA;
     |FINSI;

     aAuxVer = #dsarm013#4;
     aAuxEsq = #dsarm013#5;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#7;
     aAuxEsq = #dsarm013#8;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#10;
     aAuxEsq = #dsarm013#11;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#13;
     aAuxEsq = #dsarm013#14;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#16;
     aAuxEsq = #dsarm013#17;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#19;
     aAuxEsq = #dsarm013#20;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#22;
     aAuxEsq = #dsarm013#23;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#25;
     aAuxEsq = #dsarm013#26;
     |HAZ MeteLin;
|FPRC;

|DEFBUCLE dsarm013_cabped;
 #dsarm013#1;
 ;
 eaAplicacion, aNomCabPed,   0;
 eaAplicacion, aNomCabPed, 255;
 ;
 NULL, dsarm013_cabped;
|FIN;


|PROCESO dsarm013_cabalb;
     nContador = 7000 + nLinAux;
     nCampoDef = #dsarm013#2;
     aValorLin = #1004#nCampoDef#;

     |QBF aValorLin;
     |SI aValorLin = "";
          |ACABA;
     |FINSI;

     aAuxVer = #dsarm013#4;
     aAuxEsq = #dsarm013#5;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#7;
     aAuxEsq = #dsarm013#8;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#10;
     aAuxEsq = #dsarm013#11;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#13;
     aAuxEsq = #dsarm013#14;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#16;
     aAuxEsq = #dsarm013#17;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#19;
     aAuxEsq = #dsarm013#20;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#22;
     aAuxEsq = #dsarm013#23;
     |HAZ MeteLin;

     aAuxVer = #dsarm013#25;
     aAuxEsq = #dsarm013#26;
     |HAZ MeteLin;
|FPRC;

|DEFBUCLE dsarm013_cabalb;
 #dsarm013#1;
 ;
 eaAplicacion, aNomCabAlb,   0;
 eaAplicacion, aNomCabAlb, 255;
 ;
 NULL, dsarm013_cabalb;
|FIN;

|PROCESO LineasAlbaran;
     |SI eaDefFE = "con00637"; |Y eaAplicacion = "dscomer9";  ||Facturas OR. Mod. 001996
          |SI eaModuloFE = "tallerSC";
               nOk = 0; |SI #1002#14 ! "S"; nOk = 1; |FINSI; |SI nOk = 0; |ACABA; |FINSI;
          |SINO;
               nOk = 0; |SI #1002#14 = "N"; |O #1002#14 = "I"; nOk = 1; |FINSI; |SI nOk = 0; |ACABA; |FINSI;
          |FINSI;
     |FINSI;
     aSerPed = ""; nNumPed = 0;
     nLinAux = nLinAux + 1;
     |SI nSwHayCabAlb = 1;
          |DDEFECTO #1004;
          #1004#52 = aSerAlb;
          #1004#0 = nNumAlb;
          |LEE 000#1004.=;
          |SI FSalida = 0;
               |BUCLE dsarm013_cabalb;
          |FINSI;
     |FINSI;
     |BUCLE dsarm013_linalb;

     |SI nSwHayCabPed = 1;
          |DDEFECTO #1003;
          #1003#25 = aSerPed;
          #1003#0 = nNumPed;
          |LEE 000#1003.=;
          |SI FSalida = 0;
               |BUCLE dsarm013_cabped;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE LineasAlbaran;
 #1002#1003;
 ;
 aSerAlb, nNumAlb,   1;
 aSerAlb, nNumAlb, 999;
 ;
 NULL, LineasAlbaran;
|FIN;

|DEFBUCLE LineasAlbaran_alfa;
 #1002#1003;
 ;
 aSerAlb, aNumAlb,   1;
 aSerAlb, aNumAlb, 999;
 ;
 NULL, LineasAlbaran;
|FIN;

|DEFBUCLE LineasAlbaran_alfaNumLin;
 #1002#1003;
 ;
 aSerAlb, aNumAlb, nNumLinAlb;
 aSerAlb, aNumAlb, nNumLinAlb;
 ;
 NULL, LineasAlbaran;
|FIN;


|DEFBUCLE LineasAlbaran_marmol;
 #1002#1002;
 ;
 aNumAlb,    1;
 aNumAlb, 9999;
 ;
 NULL, LineasAlbaran;
|FIN;

|PROCESO DimeSiEsAbono;
     ||Salvidal.     Albaranes = agifa010.
     |SI eaAplicacion = "salvidal";
          aNomDef = aPathDef + "agifa010";
          |CARGA_DEF aNomDef, auxdef@;
          |SI FSalida ! 0;
               aMensaje = "0000Problemas CARGA_DEF agifa010 (Albaranes)";
               |MENAV aMensaje;
               |ACABA;
          |FINSI;
          |PATH_DAT #1003 aPathDatos;

          |ABRE #1003;
          |DDEFECTO #1003;
          #1003#50 = aSerAlb;
          #1003#0 = aNumAlb;
          |LEE 000#1003.=;
          |SI FSalida = 0;
               |SI #1003#43 = "S";
                    aSwAbono = "S";
               |SINO;
                    aSwAbono = "N";
               |FINSI;
          |FINSI;
          |CIERRA #1003;
          |DESCARGA_DEF #auxdef@;
     |FINSI;
|FPRC;

|PROCESO Lineas_ConAlbaran;
     aSerAlb = ""; nNumAlb = 0;
     |HAZ DameSerNumAlb;
     |SI eaAplicacion = "marmol";
          |SI nNumAlb ! 0;
               aNumAlb = ("000000" + nNumAlb) % -106;
               |BUCLE LineasAlbaran_marmol;
          |FINSI;
     |SINO;
          |SI aSerAlb ! ""; |Y nNumAlb ! 0;
               |SI eaAplicacion = "salvidal";
                    aNumAlb = ("000000" + nNumAlb) % -106;

                    aSwAbono = "N";
                    |HAZ DimeSiEsAbono;

                    |BUCLE LineasAlbaran_alfa;
               |SINO;
                    |SI eaAplicacion = "carrillo";
                         aNumAlb = ("000000" + nNumAlb) % -106;
                         |BUCLE LineasAlbaran_alfa;
                    |SINO;
                         |SI eaAplicacion = "dscomer9"; |Y eaDefFE = "con00637";
                              aNumAlb = ("000000" + nNumAlb) % -106;
                              |BUCLE LineasAlbaran_alfaNumLin;
                         |SINO;
                              |SI eaAplicacion = "compaq";
                                   aNumAlb = ("000000" + nNumAlb) % -106;
                                   |BUCLE LineasAlbaran_alfa;
                              |SINO;
                                   |SI eaAplicacion = "dscepsa";
                                        aNumAlb = ("000000" + nNumAlb) % -106;
                                        |BUCLE LineasAlbaran_alfa;
                                   |SINO;
                                        |SI eaAplicacion = "dscomer8"; |Y eaDefMultiLin = "agi00003";
                                             eaSerAlb8 = #1001#15; enNumAlb8 = #1001#2;
                                             eaNumLin8 = #1001#1; enBruto8 = #1001#27;
                                             enBase8 = #1001#30; enIva8 = #1001#31;
                                             efFecha8 = #1000#1;
                                             |HAZ LineasFacturaTrabajo;
                                        |SINO;
                                             |BUCLE LineasAlbaran;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nPortesLin ! 0;
          |HAZ MeteLineaPortes;
     |FINSI;
|FPRC;

|PROCESO MetePortesCab;
     ||Los portes de la cabecera se meten como una linea mas en la factura
     ||por eso voy a subejecutar el proceso MeteLineaPortes. ESTO NO ES CORRECTO
/*
     nPortesLin = nPortesCab;
     nPortesIvaLin = nPortesIvaCab;
     |HAZ MeteLineaPortes;
*/

     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = "3.1.5.3.1.3.";        ||ChangeAmount (en GeneralSurcharges)  (En este caso Portes)
     #dsarw025#2 = 5000;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = nPortesCab;
     |HAZ Pon4y5_w025;

     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = "3.1.5.3.1.1.";        ||Portes
     #dsarw025#2 = 5000;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = "Portes";
     |HAZ Pon4y5_w025;

     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = "3.1.5.5.";        ||TotalGeneralSurcharges
     #dsarw025#2 = 5000;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = nPortesCab;
     |HAZ Pon4y5_w025;
|FPRC;

|PROCESO MeteLineaPortes;
     |ACABA; ||Ahora los portes no son como una linea mas
     ||PORTES (LIN)
     nContador = nContador + 1;

     |DDEFECTO #dsarw025;
     aAuxEsq = "3.1.6.1.7.";
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = "Portes";
     |HAZ Pon4y5;

     |DDEFECTO #dsarw025;
     aAuxEsq = "3.1.6.1.8.";
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = 1;
     |HAZ Pon4y5;

     |DDEFECTO #dsarw025;
     aAuxEsq = "3.1.6.1.10.";
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = nPortesLin;
     |HAZ Pon4y5;

     |DDEFECTO #dsarw025;
     aAuxEsq = "3.1.6.1.11.";
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = nPortesLin;
     |HAZ Pon4y5;

     |DDEFECTO #dsarw025;
     aAuxEsq = "3.1.6.1.14.";
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = nPortesLin;
     |HAZ Pon4y5;

     |DDEFECTO #dsarw025;
     aAuxEsq = "3.1.6.1.15.1.1.";
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = nPortesIvaLin;
     |HAZ Pon4y5;

     nPorIva = 0;
     nPortesLinReq = 0;       ||% Req. Equivalencia
     nIvaEstoy = nPortesIvaLin;
     |SI nIvaEstoy = 0;
          nPorIva = nIva0;
          nPortesLinReq = nReq0;
     |FINSI;
     |SI nIvaEstoy = 1;
          nPorIva = nIva1;
          nPortesLinReq = nReq1;
     |FINSI;
     |SI nIvaEstoy = 2;
          nPorIva = nIva2;
          nPortesLinReq = nReq2;
     |FINSI;
     |SI nIvaEstoy = 3;
          nPorIva = nIva3;
          nPortesLinReq = nReq3;
     |FINSI;
     |SI nIvaEstoy = 4;
          nPorIva = nIva4;
          nPortesLinReq = nReq4;
     |FINSI;
     |SI nIvaEstoy = 5;
          nPorIva = nIva5;
          nPortesLinReq = nReq5;
     |FINSI;

     aAuxEsq = "3.1.6.1.15.1.2.";  ||TaxRate.. %IVA
     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = nPorIva;
     |HAZ Pon4y5;

     aAuxEsq = "3.1.6.1.15.1.3.1.";
     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = nPortesLin;
     |HAZ Pon4y5;

     aAuxEsq = "3.1.6.1.15.1.4.1.";  ||TaxAmount (TotalAmount).. %IVA
     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     |SI nPorIva = 0;
          #dsarw025#3 = 0;
     |SINO;
          nValorAux2 = nPortesLin % nPorIva;
          #dsarw025#3 = nValorAux2;
     |FINSI;
     |HAZ Pon4y5;

     |SI nSwEsRecEqui = 1;
          ||PORTES (LIN)
          ||Si hay recargo de equivalencia, falta un par de lineas. (en la linea de portes)
          aAuxEsq = "3.1.6.1.15.1.5.";
          |DDEFECTO #dsarw025;
          #dsarw025#0 = aAuxVer;
          #dsarw025#1 = aAuxEsq;
          #dsarw025#2 = nContador;
          |LEE 101#dsarw025.=;
          |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
          #dsarw025#3 = nPortesLinReq;
          |HAZ Pon4y5;

          aAuxEsq = "3.1.6.1.15.1.6.1.";
          |DDEFECTO #dsarw025;
          #dsarw025#0 = aAuxVer;
          #dsarw025#1 = aAuxEsq;
          #dsarw025#2 = nContador;
          |LEE 101#dsarw025.=;
          |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
          |SI nPortesLinReq = 0;
               #dsarw025#3 = 0;
          |SINO;
               nValorAux2 = nPortesLin % nPortesLinReq;
               #dsarw025#3 = nValorAux2;
          |FINSI;
          |HAZ Pon4y5;
     |FINSI;

     aAuxEsq = "3.1.6.1.18.";
     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = aFechaFactura;
     |HAZ Pon4y5;
|FPRC;

|DEFBUCLE Lineas_ConAlbaran;
 #1001#1003;
 ;
 eaSerieFE, eaNumeroFE,   1;
 eaSerieFE, eaNumeroFE, 999;
 ;
 NULL, Lineas_ConAlbaran;
|FIN;

|DEFBUCLE Lineas_ConAlbaranOR;
 #1001#1004;
 ;
 eaSerieFE, eaNumeroFE, nLinFacTaller, 0000;
 eaSerieFE, eaNumeroFE, nLinFacTaller, 9999;
 ;
 NULL, Lineas_ConAlbaran;
|FIN;

|PROCESO MeteTagInicio;
     aBusca = "";
     aCadena = aEsquema;
     |QBF aCadena;
     aLong = aCadena % A0;
     nLong = aLong;
     |SI nLong > 2;
          nLong = nLong - 2;
          |PARA nCampoVoy = 1; |SI nCampoVoy [ nLong; |HACIENDO nCampoVoy = nCampoVoy + 1;
               nSaca = 100 * nCampoVoy;
               nSaca = nSaca + 1;
               aSaca = nSaca;
               aLetra = aCadena % aSaca;
               aBusca = aBusca + aLetra;
               |SI aLetra = ".";
                    nSwContinua = 1;
                    |SI aBusca = "3.1.6.";
                         nVecesItems = nVecesItems + 1;
                         |SI nVecesItems > 1;
                              nSwContinua = 0;
                         |FINSI;
                    |FINSI;
                    |SI aBusca = "3.1.";
                         nVecesInvoices = nVecesInvoices + 1;
                         |SI nVecesInvoices > 1;
                              nSwContinua = 0;
                         |FINSI;
                    |FINSI;
                    |SI aBusca = "3.";
                         |SI nVecesItems ] 1; |O nVecesInvoices ] 1;
                              nSwContinua = 0;
                         |FINSI;
                    |FINSI;
                    |SI aBusca = "3.1.3.";
                         nVecesTaxOutputs = nVecesTaxOutputs + 1;
                         |SI nVecesTaxOutputs > 1;
                              nSwContinua = 0;
                         |FINSI;
                    |FINSI;
                    |SI #dsarw025#2 = 5001; |O #dsarw025#2 = 5002;
                         |SI aBusca = "3.1.5.";
                              nSwContinua = 0;
                         |SINO;
                              |SI aBusca = "3.1.5.2.";
                                   nSwContinua = 0;
                              |FINSI;
                         |FINSI;
                    |FINSI;
                    |SI #dsarw025#2 > 9000;       ||Medios de Pago
                         |SI aBusca = "3.1.7."; |Y eaDefFPago = "";
                              nSwContinua = 0;
                         |FINSI;
                    |FINSI;

                    |SI nSwContinua = 1;
                         |DDEFECTO #dsarm011;
                         #dsarm011#0 = #dsarw025#0;
                         #dsarm011#1 = aBusca;
                         |LEE 000#dsarm011.=;
                         |SI FSalida = 0;
                              aAuxAux = #dsarm011#2;
                              |QBF aAuxAux;
                              |SI aAuxAux ! "";
                                   |DDEFECTO #dsarw026;
                                   #dsarw026#2 = #dsarw025#2;
                                   #dsarw026#0 = aBusca;
                                   |LEE 101#dsarw026.=;
                                   |SI FSalida ! 0; |GRABA 020#dsarw026.b; |FINSI;
                                   #dsarw026#1 = #dsarm011#2;
                                   #dsarw026#3 = #dsarw025#0;
                                   #dsarw026#4 = #dsarm011#3;
                                   |GRABA 020#dsarw026.a;
                                   |LIBERA #dsarw026;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO dsarw025_alreves;
     aContenido = #dsarw025#3;
     |QBF aContenido;
     |SI aContenido ! "";
          aEsquema = #dsarw025#1;
          |QBF aEsquema;
          |SI aEsquema ! "";
               |SI aEsquema = "3.1.6.1.2.";
                    ||El 3.1.6.1.2. es opcional, pero si aparece tiene
                    ||mas prioridad, y provoca que salga el Items a mitad
                    ||de las lineas. (El 3.1.6., solo debe salir en la primera linea)
                    |SI #dsarw025#2 = 7001;
                         |HAZ MeteTagInicio;
                    |FINSI;
               |SINO;
                    |HAZ MeteTagInicio;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsarw025_alreves;
 ||ARA38.  Tiquet  700000.6689.   Manda el contador y luego Orden campos
 ||#dsarw025#3;               ||Esto fue un equivoco mio. No es correcto
 #dsarw025#2;
 ;
 INICIO;
 FINAL;
 ;
 NULL, dsarw025_alreves;
|FIN;

|PROCESO dsarw026;
     |DDEFECTO #dsarw025;
     #dsarw025#0 = #dsarw026#3;
     #dsarw025#1 = #dsarw026#0;
     #dsarw025#2 = #dsarw026#2;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0;
          #dsarw025#4 = #dsarw026#1;
          #dsarw025#5 = #dsarw026#4;
          |GRABA 020#dsarw025.n;
          |LIBERA #dsarw025;
     |FINSI;
     |BORRA 020#dsarw026.a;
|FPRC;

|DEFBUCLE dsarw026;
 #dsarw026#1;
 ;
 INICIO;
 FINAL;
 be;
 NULL, dsarw026;
|FIN;

|PROCESO DatosEmisor;  ||Datos Emisor Factura. Lo pillamos de Acceso Empresas
     nSwSigueEmisor = 1;           ||Buscamos datos Emisor en el Principal
     |QBF eaDefEmpSerieFe;
     |SI eaDefEmpSerieFe ! "";
          aNomDef = aPathDef + eaDefEmpSerieFe;
          |CARGA_DEF aNomDef, masdef@;
          |SI FSalida ! 0;
               eaDniFirmador = "";
               aMensaje = "0000Problemas CARGA_DEF " + eaDefEmpSerieFe;
               |MENAV aMensaje;
               |ACABA;
          |FINSI;
          |PATH_DAT #1002 aPathDatosEmp;

          |ABRE #1002;
          |DDEFECTO #1002;
          #1002#0 = eaEmpresaFE;
          #1002#29 = eaSerieFE;
          |LEE 000#1002.=;
          |SI FSalida = 0;
               nSwSigueEmisor = 0;
               |SI eaAplicacion = "dscomer9"; |O eaAplicacion = "dscomer8"; |O eaAplicacion = "dscepsa";
                         |O eaAplicacion = "drogas86";
                    |SI #1002#28 = "S";
                         nPonMedioPago = 1;
                    |SINO;
                         nPonMedioPago = 0;
                    |FINSI;
               |SINO;
                    nPonMedioPago = 0;
               |FINSI;

               |BUCLE dsarm013_emp;
          |FINSI;
          |CIERRA #1002;
          |DESCARGA_DEF #masdef@;
     |FINSI;

     |SI nSwSigueEmisor = 1;
          |QBF eaDefEmpFe;
          |SI eaDefEmpFe ! "";
               aNomDef = aPathDef + eaDefEmpFe;
               |CARGA_DEF aNomDef, masdef@;
               |SI FSalida ! 0;
                    eaDniFirmador = "";
                    aMensaje = "0000Problemas CARGA_DEF " + eaDefEmpFe;
                    |MENAV aMensaje;
                    |ACABA;
               |FINSI;

               nEmpFE = eaEmpresaFE;

               |SI eaAplicacion = "carrillo";
                    || el agifa280 esta dentro de la empresa (fich+empresa)
                    nEmpFE = 0;
                    aAlfa = aPathDatosEmp + eaEmpresaFE + "/";
                    |PATH_DAT #1002 aAlfa;

                    || Leo la serie que tiene la relacion con el agifa280
                    aNomDef = aPathDef + "agifa007";
                    |CARGA_DEF aNomDef, cinco@;
                    |SI FSalida ! 0;
                         aMensaje = "0000Problemas CARGA_DEF agifa007 (Series)";
                         |MENAV aMensaje;
                    |SINO;
                         |PATH_DAT #1005 aAlfa;
                         |ABRE #1005;
                         #1005#26 = eaArSerDoc;
                         |LEE 020#1005=;
                         |SI FSalida ! 0; |DDEFECTO #1005; |FINSI;
                         nEmpFE = #1005#33;
                         |CIERRA #1005;
                         |DESCARGA_DEF #cinco@;
                    |FINSI;
               |SINO;
                    |PATH_DAT #1002 aPathDatosEmp;
               |FINSI;

               |SI eaAplicacion = "gesracor";
                    |ABRE #1002;
                    |DDEFECTO #1002;
                    |LEE 000#1002.p;
                    |SI FSalida = 0;
                         |BUCLE dsarm013_emp;
                    |FINSI;
                    |CIERRA #1002;
                    |DESCARGA_DEF #masdef@;
               |SINO;
                    |ABRE #1002;
                    |DDEFECTO #1002;
                    #1002#0 = nEmpFE;
                    |LEE 000#1002.=;
                    |SI FSalida = 0;
                         |SI eaAplicacion = "dscomer9"; |O eaAplicacion = "dscomer8"; |O eaAplicacion = "dscepsa";
                                   |O eaAplicacion = "drogas86";
                              |SI #1002#28 = "S";
                                   nPonMedioPago = 1;
                              |SINO;
                                   nPonMedioPago = 0;
                              |FINSI;
                         |SINO;
                              nPonMedioPago = 0;
                         |FINSI;

                         |BUCLE dsarm013_emp;
                    |FINSI;
                    |CIERRA #1002;
                    |DESCARGA_DEF #masdef@;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DatosCliente; ||Datos Cliente. Lo pillamos de cliente
     aCCC = "";
     |QBF eaDefCliFe;
     |SI eaDefCliFe ! "";
          aNomDef = aPathDef + eaDefCliFe;
          |CARGA_DEF aNomDef, masdef@;
          |SI FSalida ! 0;
               aMensaje = "0000Problemas CARGA_DEF " + eaDefCliFe;
               |MENAV aMensaje;
               |ACABA;
          |FINSI;
          |PATH_DAT #1002 aPathDatos;

          |ABRE #1002;
          |DDEFECTO #1002;
          #1002#0 = eaCodCliFe;
          |LEE 000#1002.=;
          |SI FSalida = 0;
               |BUCLE dsarm013_cli;
          |FINSI;
          |CIERRA #1002;
          |DESCARGA_DEF #masdef@;
     |FINSI;
|FPRC;

|PROCESO ObtenIvaREUnico;
     |SI eaAplicacion = "salvidal";
          aNomDef = aPathDef + "agifa404";
          |CARGA_DEF aNomDef, masdef@;
          |SI FSalida ! 0;
               aMensaje = "0000Problemas CARGA_DEF agifa404";
               |MENAV aMensaje;
               |ACABA;
          |FINSI;
          |PATH_DAT #1002 aPathDatos;

          |ABRE #1002;
          |DDEFECTO #1002;
          #1002#0 = eaSerieFE;
          |LEE 000#1002.=;
          |SI FSalida = 0;
               nClaseIva = #1002#2;
          |SINO;
               nClaseIva = 1;           ||Por defecto, ClaseIva = 1. (16% y 4%) Ahora 18%
          |FINSI;
          |CIERRA #1002;
          |DESCARGA_DEF #masdef@;

          |QBF eaDefIvaFe;
          |SI eaDefIvaFe ! "";
               aNomDef = aPathDef + eaDefIvaFe;
               |CARGA_DEF aNomDef, masdef@;
               |SI FSalida ! 0;
                    aMensaje = "0000Problemas CARGA_DEF " + eaDefIvaFe;
                    |MENAV aMensaje;
                    |ACABA;
               |FINSI;
               |PATH_DAT #1002 aPathDatos;


               ||IVA18.  Salvidal, no tiene multiple clave en el Mant. de IVAS
               |ABRE #1002;
               |DDEFECTO #1002;
               #1002#0 = nClaseIva;
               |LEE 000#1002.=;
               |SI FSalida = 0;
                    nIvaUnico = #1002#2;
                    nREUnico = #1002#3;
               |FINSI;

               |CIERRA #1002;
               |DESCARGA_DEF #masdef@;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DatosImpuestos; ||Datos Impuestos/IVA. Lo pillamos de la Tabla de IVA.
     ||Salvidal. Para averiguar el IVA/Rec.Equi, utiliza agifa404
     ||Aqui averiguamos que tipo de IVA utiliza.

     |SI eaAplicacion = "salvidal";
          |BUCLE dsarm013_iva;
     |SINO;
          |QBF eaDefIvaFe;
          |SI eaDefIvaFe ! "";
               aNomDef = aPathDef + eaDefIvaFe;
               |CARGA_DEF aNomDef, masdef@;
               |SI FSalida ! 0;
                    aMensaje = "0000Problemas CARGA_DEF " + eaDefIvaFe;
                    |MENAV aMensaje;
                    |ACABA;
               |FINSI;
               |PATH_DAT #1002 aPathDatos;

               ||IVA18
               |SI eaAplicacion = "dscomer8"; |O eaAplicacion = "dscomer9"; |O eaAplicacion = "compaq"; |O eaAplicacion = "dscepsa";
                         |O eaAplicacion = "drogas86";
                    nSacaIva = 0;
                    nSacaReq = 0;
                    nSacaTipo = 0;
                    |HAZ SacaIvaFecha;
                    nIva0 = nSacaIva;
                    nReq0 = nSacaReq;

                    nSacaIva = 0;
                    nSacaReq = 0;
                    nSacaTipo = 1;
                    |HAZ SacaIvaFecha;
                    nIva1 = nSacaIva;
                    nReq1 = nSacaReq;

                    nSacaIva = 0;
                    nSacaReq = 0;
                    nSacaTipo = 2;
                    |HAZ SacaIvaFecha;
                    nIva2 = nSacaIva;
                    nReq2 = nSacaReq;

                    nSacaIva = 0;
                    nSacaReq = 0;
                    nSacaTipo = 3;
                    |HAZ SacaIvaFecha;
                    nIva3 = nSacaIva;
                    nReq3 = nSacaReq;

                    nSacaIva = 0;
                    nSacaReq = 0;
                    nSacaTipo = 4;
                    |HAZ SacaIvaFecha;
                    nIva4 = nSacaIva;
                    nReq4 = nSacaReq;

                    nSacaIva = 0;
                    nSacaReq = 0;
                    nSacaTipo = 5;
                    |HAZ SacaIvaFecha;
                    nIva5 = nSacaIva;
                    nReq5 = nSacaReq;
               |SINO;
                    nIva0 = 0;
                    nIva1 = 0;
                    nIva2 = 0;
                    nIva3 = 0;
                    nIva4 = 0;
                    nIva5 = 0;
                    nReq0 = 0;
                    nReq1 = 0;
                    nReq2 = 0;
                    nReq3 = 0;
                    nReq4 = 0;
                    nReq5 = 0;
                    |ABRE #1002;
                    |DDEFECTO #1002;
                    #1002#0 = 0;
                    |LEE 000#1002.=;
                    |SI FSalida = 0;
                         nIva0 = #1002#2;
                         nReq0 = #1002#3;
                    |FINSI;
                    #1002#0 = 1;
                    |LEE 000#1002.=;
                    |SI FSalida = 0;
                         nIva1 = #1002#2;
                         nReq1 = #1002#3;
                    |FINSI;
                    #1002#0 = 2;
                    |LEE 000#1002.=;
                    |SI FSalida = 0;
                         nIva2 = #1002#2;
                         nReq2 = #1002#3;
                    |FINSI;
                    #1002#0 = 3;
                    |LEE 000#1002.=;
                    |SI FSalida = 0;
                         nIva3 = #1002#2;
                         nReq3 = #1002#3;
                    |FINSI;
                    #1002#0 = 4;
                    |LEE 000#1002.=;
                    |SI FSalida = 0;
                         nIva4 = #1002#2;
                         nReq4 = #1002#3;
                    |FINSI;
                    #1002#0 = 5;
                    |LEE 000#1002.=;
                    |SI FSalida = 0;
                         nIva5 = #1002#2;
                         nReq5 = #1002#3;
                    |FINSI;
                    |CIERRA #1002;
               |FINSI;

               |DESCARGA_DEF #masdef@;

               |BUCLE dsarm013_iva;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO SacaIvaFecha;
     |SI eaAplicacion = "drogas86";
          enTipoIva = nSacaTipo; |HAZ SacaIvaSin; nSacaIva = enIva; nSacaReq = enRec;
          |ACABA;
     |FINSI;

     |SI eaAplicacion = "dscepsa";
          |ABRE #1002;
          |DDEFECTO #1002;
          #1002#0 = nSacaTipo;
          #1002#6 = "01.01.0000";
          |LEE 000#1002];
          |PARA; |SI FSalida = 0; |Y #1002#0 = nSacaTipo; |Y fFechaFactura ] #1002#6; |HACIENDO;
               nSacaIva = #1002#2;
               nSacaReq = #1002#3;
               |LEE 000#1002s;
          |SIGUE;
          |CIERRA #1002;
     |SINO;
          |ABRE #1002;
          |DDEFECTO #1002;
          #1002#0 = nSacaTipo;
          #1002#4 = "01.01.0000";
          |LEE 000#1002];
          |PARA; |SI FSalida = 0; |Y #1002#0 = nSacaTipo; |Y fFechaFactura ] #1002#4; |HACIENDO;
               nSacaIva = #1002#2;
               nSacaReq = #1002#3;
               |LEE 000#1002s;
          |SIGUE;
          |CIERRA #1002;
     |FINSI;
|FPRC;

|PROCESO MeteVenc;
     aAuxDatos = aAuxEsq;
     |QBF aAuxDatos;
     |SI aAuxDatos ! "";
          nCampoDef = #dsarm013#2;
          aAuxAux = #1002#nCampoDef#;
          |QBF aAuxAux;
          |SI aAuxAux ! "";
               |DDEFECTO #dsarm011;
               #dsarm011#0 = aAuxVer;
               #dsarm011#1 = aAuxEsq;
               |LEE 000#dsarm011.=;

               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = nContador;
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               nCampoDef = #dsarm013#2;
               #dsarw025#3 = #1002#nCampoDef#;

               nSwQuitaFechaFP = 0;
               aObsFormaPago = "";

               |SI aAuxDatos = "3.1.7.1.3.";        ||PaymentMeans
                    |SI eaDefFPago ! "";
                         |SI eaAplicacion = "facturar";
                              |DDEFECTO #1003;
                              nAux5 = #dsarw025#3;
                              #1003#0 = nAux5;
                              |LEE 000#1003.=;
                              |SI FSalida = 0;
                                   ||Tiquet 2884 | 1519.
                                   ||aObsFormaPago = (("00" + nAux5) % -102) + " " + #1003#1;
                                   aObsFormaPago = #1003#1;
                                   |QBF aObsFormaPago;
                                   |SI #1003#5 = 0;
                                        nSwQuitaFechaFP = 1;
                                   |FINSI;
                              |FINSI;

                              || Nyapa para evitar problemas, con las formas de pago (la 2 y la 4)
                              || Lo ideal es montar una tabla de equivalencias, pero
                              || no hay tiempo. Hacemos este truco. SOLO PARA app "facturar"
                              nAux5 = #dsarw025#3;
                              |SI nAux5 = 2; |O nAux5 = 4;
                                   #dsarw025#3 = 16;
                              |FINSI;
                         |FINSI;
                    |FINSI;

                    ||No permito la Forma de Pago "00", la cambio por "16"
                    ||ni tampoco formas de pago mayores de 16.
                    nAux5 = #dsarw025#3;
                    |SI nAux5 = 0; |O nAux5 > 16;
                         #dsarw025#3 = 16;
                    |FINSI;
               |FINSI;

               #dsarw025#4 = #dsarm011#2;
               #dsarw025#5 = #dsarm011#3;
               |GRABA 020#dsarw025.a;
               |LIBERA #dsarw025;

               |SI aObsFormaPago ! "";
                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = "3.1.7.1.7.";
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    #dsarw025#3 = aObsFormaPago;
                    |DDEFECTO #dsarm011;
                    #dsarm011#0 = aAuxVer;
                    #dsarm011#1 = "3.1.7.1.7.";
                    |LEE 000#dsarm011.=;
                    #dsarw025#4 = #dsarm011#2;
                    #dsarw025#5 = #dsarm011#3;
                    |GRABA 020#dsarw025.a;
                    |LIBERA #dsarw025;

                    ||Cta. con los ultimos 4 digitos con asteriscos
                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = "3.1.7.1.4.1.";
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
                    |SI aCCC = "";
                         aCCC = "*****";
                    |SINO;
                         aAuxCCC = aCCC;
                         |QBF aAuxCCC;
                         aAuxCCC = aAuxCCC % 116;
                         aAuxCCC = aAuxCCC + "****";
                         aCCC = aAuxCCC;
                    |FINSI;
                    #dsarw025#3 = aCCC;
                    aCCC = "";

                    |DDEFECTO #dsarm011;
                    #dsarm011#0 = aAuxVer;
                    #dsarm011#1 = "3.1.7.1.4.1.";
                    |LEE 000#dsarm011.=;
                    #dsarw025#4 = #dsarm011#2;
                    #dsarw025#5 = #dsarm011#3;
                    |GRABA 020#dsarw025.a;
                    |LIBERA #dsarw025;
               |FINSI;

/*
     ||Por ahora esto NO lo toco

               |SI nSwQuitaFechaFP = 1;      ||Quito Fecha Forma Pago. Datos Cobros
                    |DDEFECTO #dsarw025;
                    #dsarw025#0 = aAuxVer;
                    #dsarw025#1 = "3.1.7.1.1.";
                    #dsarw025#2 = nContador;
                    |LEE 101#dsarw025.=;
                    |SI FSalida = 0;
                         #dsarw025#3 = aFechaFactura;
                         |GRABA 020#dsarw025.a;
                         |LIBERA #dsarw025;
                    |FINSI;
               |FINSI;
*/
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO dsarm013_venc;
     nContador = 9000 + nLinVenc;
     nCampoDef = #dsarm013#2;
     aValorLin = #1002#nCampoDef#;

     aAuxVer = #dsarm013#4;
     aAuxEsq = #dsarm013#5;
     |HAZ MeteVenc;

     aAuxVer = #dsarm013#7;
     aAuxEsq = #dsarm013#8;
     |HAZ MeteVenc;

     aAuxVer = #dsarm013#10;
     aAuxEsq = #dsarm013#11;
     |HAZ MeteVenc;

     aAuxVer = #dsarm013#13;
     aAuxEsq = #dsarm013#14;
     |HAZ MeteVenc;

     aAuxVer = #dsarm013#16;
     aAuxEsq = #dsarm013#17;
     |HAZ MeteVenc;

     aAuxVer = #dsarm013#19;
     aAuxEsq = #dsarm013#20;
     |HAZ MeteVenc;

     aAuxVer = #dsarm013#22;
     aAuxEsq = #dsarm013#23;
     |HAZ MeteVenc;

     aAuxVer = #dsarm013#25;
     aAuxEsq = #dsarm013#26;
     |HAZ MeteVenc;
|FPRC;

|DEFBUCLE dsarm013_venc;
 #dsarm013#1;
 ;
 eaAplicacion, eaDefVencFe,   0;
 eaAplicacion, eaDefVencFe, 255;
 ;
 NULL, dsarm013_venc;
|FIN;

|PROCESO LineasVenc;
     nLinVenc = nLinVenc + 1;
     |BUCLE dsarm013_venc;
|FPRC;

|DEFBUCLE Vencimientos;
 #1002#1002;
 ;
 eaSerieFE, eaNumeroFE;
 eaSerieFE, eaNumeroFE;
 ;
 NULL, LineasVenc;
|FIN;

|PROCESO DatosVencimientos;
     aNomDef = aPathDef + eaDefVencFe;
     |CARGA_DEF aNomDef, masdef@;
     |SI FSalida ! 0;
          aMensaje = "0000Problemas CARGA_DEF " + eaDefVencFe;
          |MENAV aMensaje;
          |ACABA;
     |FINSI;
     |PATH_DAT #1002 aPathDatos;

     |SI eaDefFPago ! "";
          |SI eaAplicacion = "facturar";
               |SI eaDefFPago = "asfpagos";
                    aNomDef = aPathDef + eaDefFPago;
                    |CARGA_DEF aNomDef, auxdef@;
                    |SI FSalida ! 0;
                         aMensaje = "0000Problemas CARGA_DEF " + eaDefFPago;
                         |MENAV aMensaje;
                         |DESCARGA_DEF #masdef@;
                         |ACABA;
                    |FINSI;
                    |PATH_DAT #1003 aPathDatos;
                    |ABRE #1003;
               |SINO;
                    |DBASS aDirBass;   |QBT aDirBass;
                    aDirBass = aDirBass + "integral/";

                    aNomDef = aDirBass + "def/" + eaDefFPago;
                    |CARGA_DEF aNomDef, auxdef@;
                    |SI FSalida ! 0;
                         aMensaje = "0000Problemas CARGA_DEF " + aNomDef;
                         |MENAV aMensaje;
                         |DESCARGA_DEF #masdef@;
                         |ACABA;
                    |FINSI;

                    aPathDatosIntegral = aDirBass + "fich/";
                    |PATH_DAT #1003 aPathDatosIntegral;

                    |ABRE #1003;
                    ||INTEGRAL.
               |FINSI;
          |FINSI;
     |FINSI;

     |ABRE #1002;
     nLinVenc = 0;
     |BUCLE Vencimientos;
     |CIERRA #1002;

     |SI eaDefFPago ! "";
          |SI eaAplicacion = "facturar";
               |CIERRA #1003;
               |DESCARGA_DEF #auxdef@;
          |FINSI;
     |FINSI;

     |DESCARGA_DEF #masdef@;
|FPRC;

|PROCESO dsarw025_imp;
     |PRINT;
     nSwPie = 1;
|FPRC;

|DEFBUCLE dsarw025_imp;
 #dsarw025#2;
 ;
 INICIO;
 FINAL;
 ;
 NULL, dsarw025_imp;
|FIN;

|PROCESO Imprimew025;
     nSwPie = 0;
     |IMPRE 0;
     |SI FSalida = 0;
          aInforme = "dsarz011";
          |INFOR aInforme;
          |SI FSalida = 0;
               |BUCLE dsarw025_imp;
               |SI nSwPie = 1;
                    |PIEINF;
               |FINSI;
               |FININF;
          |SINO;
               aMensaje = "0000Informe " + aInforme + " inaccesible.";
               |MENAV aMensaje;
          |FINSI;
          |FINIMP;
     |SINO;
          |MENAV "0000Proceso cancelado.";
     |FINSI;
|FPRC;

|PROCESO ControlIVASCEROCABEZA;
     |SI eaAplicacion = "dscomer9"; |O eaAplicacion = "dscomer8"; |O eaAplicacion = "carrillo"; |O eaAplicacion = "ds-suite"; |O eaAplicacion = "dscepsa";
               |O eaAplicacion = "drogas86";
          |SI nSwFaltaCabIva0 = 1; |Y nTotalIva0 = 0;

               ||Si ya existe como numero de linea 3000 = (3000 + iva0).
               ||No hace falta meter la linea como 3006.
               aAuxEsq = "3.1.3.1.1.";  ||TaxTypeCode
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3000
               |LEE 000#dsarw025.=;
               |SI FSalida = 0;
                    |ACABA;
               |FINSI;

               ||TODO CCC
               aAuxEsq = "3.1.3.1.1.";  ||TaxTypeCode
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3006;           ||3000 + 6
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               |SI eaAplicacion = "dscomer8"; |O eaAplicacion = "dscomer9"; |O eaAplicacion = "compaq"; |O eaAplicacion = "dscepsa";
                         |O eaAplicacion = "drogas86";
                    #dsarw025#3 = 6;
               |SINO;
                    #dsarw025#3 = 0;
               |FINSI;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.2.";  ||TaxRate
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3006;           ||3000 + 6
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = nPorIva0;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.3.1.";  ||TotalAmount
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3006;           ||3000 + 6
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 0;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.4.1.";  ||TotalAmount
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3006;           ||3000 + 6
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 0;
               |HAZ Pon4y5;
          |FINSI;

          |SI nSwFaltaCabIva1 = 1; |Y nTotalIva1 = 0;
               ||TODO CCC
               aAuxEsq = "3.1.3.1.1.";  ||TaxTypeCode
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3001;           ||3000 + 1
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 01;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.2.";  ||TaxRate
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3001;           ||3000 + 1
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = nPorIva1;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.3.1.";  ||TotalAmount
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3001;           ||3000 + 1
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 0;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.4.1.";  ||TotalAmount
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3001;           ||3000 + 1
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 0;
               |HAZ Pon4y5;
          |FINSI;

          |SI nSwFaltaCabIva2 = 1; |Y nTotalIva2 = 0;
               ||TODO CCC
               aAuxEsq = "3.1.3.1.1.";  ||TaxTypeCode
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3002;           ||3000 + 2
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 02;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.2.";  ||TaxRate
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3002;           ||3000 + 2
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = nPorIva2;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.3.1.";  ||TotalAmount
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3002;           ||3000 + 2
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 0;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.4.1.";  ||TotalAmount
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3002;           ||3000 + 2
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 0;
               |HAZ Pon4y5;
          |FINSI;

          |SI nSwFaltaCabIva3 = 1; |Y nTotalIva3 = 0;
               ||TODO CCC
               aAuxEsq = "3.1.3.1.1.";  ||TaxTypeCode
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3003;           ||3000 + 3
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 03;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.2.";  ||TaxRate
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3003;           ||3000 + 3
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = nPorIva3;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.3.1.";  ||TotalAmount
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3003;           ||3000 + 3
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 0;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.4.1.";  ||TotalAmount
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3003;           ||3000 + 3
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 0;
               |HAZ Pon4y5;
          |FINSI;

          |SI nSwFaltaCabIva4 = 1; |Y nTotalIva4 = 0;
               ||TODO CCC
               aAuxEsq = "3.1.3.1.1.";  ||TaxTypeCode
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3004;           ||3000 + 4
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 04;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.2.";  ||TaxRate
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3004;           ||3000 + 4
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = nPorIva4;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.3.1.";  ||TotalAmount
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3004;           ||3000 + 4
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 0;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.4.1.";  ||TotalAmount
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3004;           ||3000 + 4
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 0;
               |HAZ Pon4y5;
          |FINSI;
          |SI nSwFaltaCabIva5 = 1; |Y nTotalIva5 = 0;
               ||TODO CCC
               aAuxEsq = "3.1.3.1.1.";  ||TaxTypeCode
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3005;           ||3000 + 5
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 05;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.2.";  ||TaxRate
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3005;           ||3000 + 5
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = nPorIva5;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.3.1.";  ||TotalAmount
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3005;           ||3000 + 5
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 0;
               |HAZ Pon4y5;

               aAuxEsq = "3.1.3.1.4.1.";  ||TotalAmount
               |DDEFECTO #dsarw025;
               #dsarw025#0 = aAuxVer;
               #dsarw025#1 = aAuxEsq;
               #dsarw025#2 = 3005;           ||3000 + 5
               |LEE 101#dsarw025.=;
               |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
               #dsarw025#3 = 0;
               |HAZ Pon4y5;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO dsarm013_CabPedHay;
     aAuxEsq = #dsarm013#5;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabPed = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#8;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabPed = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#11;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabPed = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#14;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabPed = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#17;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabPed = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#20;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabPed = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#23;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabPed = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#26;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabPed = 1;
          |ERROR10;
          |ACABA;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm013_CabPedHay;
 #dsarm013#1;
 ;
 eaAplicacion, aNomCabPed,   0;
 eaAplicacion, aNomCabPed, 255;
 ;
 NULL, dsarm013_CabPedHay;
|FIN;

|PROCESO MiraCabPed;
     |BUCLE dsarm013_CabPedHay;
|FPRC;

|PROCESO dsarm013_CabAlbHay;
     aAuxEsq = #dsarm013#5;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabAlb = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#8;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabAlb = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#11;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabAlb = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#14;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabAlb = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#17;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabAlb = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#20;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabAlb = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#23;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabAlb = 1;
          |ERROR10;
          |ACABA;
     |FINSI;

     aAuxEsq = #dsarm013#26;
     |QBF aAuxEsq;
     |SI aAuxEsq ! "";
          nSwHayCabAlb = 1;
          |ERROR10;
          |ACABA;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm013_CabAlbHay;
 #dsarm013#1;
 ;
 eaAplicacion, aNomCabAlb,   0;
 eaAplicacion, aNomCabAlb, 255;
 ;
 NULL, dsarm013_CabAlbHay;
|FIN;

|PROCESO MiraCabAlb;
     |BUCLE dsarm013_CabAlbHay;
|FPRC;

|PROCESO dsarw025_AntesImpuestos;
     nAuxDos = #dsarw025#3;
     nAuxDos = nAuxDos - nImpoDtoCabTotal;
     #dsarw025#3 = nAuxDos;
     |GRABA 020#dsarw025.a;
|FPRC;

|DEFBUCLE dsarw025_AntesImpuestos;
 #dsarw025#1;
 ;
 aAuxVer, aAuxEsq,    0;
 aAuxVer, aAuxEsq, 9999;
 be;
 NULL, dsarw025_AntesImpuestos;
|FIN;

|PROCESO dsarw025_DameValor;
     nDameValor = #dsarw025#3;
|FPRC;

|DEFBUCLE dsarw025_DameValor;
 #dsarw025#1;
 ;
 aAuxVer, aAuxEsq, 5000;
 aAuxVer, aAuxEsq, 5000;
 ;
 NULL, dsarw025_DameValor;
|FIN;

|PROCESO RestaACta;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContadorACta;
     |LEE 101#dsarw025.=;
     |SI FSalida = 0;
          nValorAux3 = #dsarw025#3;
          nValorAux3 = nValorAux3 - nImpoACta;
          #dsarw025#3 = nValorAux3;
          |GRABA 020#dsarw025.a;
          |LIBERA #dsarw025;
     |FINSI;
|FPRC;

|PROCESO PostProceso;
     |SI nImpoACta ! 0;
          aAuxEsq = "1.5.4.1.";
          nContadorACta = 0;
          |HAZ RestaACta;

          aAuxEsq = "1.5.5.1.";
          nContadorACta = 0;
          |HAZ RestaACta;

          aAuxEsq = "3.1.5.14.";
          nContadorACta = 5000;
          |HAZ RestaACta;

          aAuxEsq = "3.1.5.17.";
          nContadorACta = 5000;
          |HAZ RestaACta;

          ||Restar en estos 4:
          ||1.5.4.1.                0
          ||1.5.5.1.                0
          ||3.1.5.14.               5000
          ||3.1.5.17.               5000
     |FINSI;

     |SI nImpoDtoCabTotal ! 0;
          aAuxEsq = "3.1.5.6.";   ||TotalGrossAmountBeforeTaxes
          |BUCLE dsarw025_AntesImpuestos;
     |FINSI;

     |SI eaAplicacion = "ds-suite";
          ||EN DS-SUITE NO TENGO estos 2 valores:
          ||3.1.5.1.  TotalGrossAmount
          ||3.1.5.6.  TotalGrossAmountBeforeTaxes
          ||Tengo que obtenerlos a partir de
          ||3.1.5.7.  TotalTaxOutputs
          ||3.1.5.17. TotalExecutableAmount

          nDameValor = 0;
          aAuxEsq = "3.1.5.7.";   ||TotalTaxOutputs
          |BUCLE dsarw025_DameValor;
          nTotalTax = nDameValor;

          nDameValor = 0;
          aAuxEsq = "3.1.5.17.";   ||TotalExecutableAmount
          |BUCLE dsarw025_DameValor;
          nTotalExeFac = nDameValor;

          nDif = nTotalExeFac - nTotalTax;

          aAuxEsq = "3.1.5.1.";
          |DDEFECTO #dsarm011;
          #dsarm011#0 = aAuxVer;
          #dsarm011#1 = aAuxEsq;
          |LEE 000#dsarm011.=;

          |DDEFECTO #dsarw025;
          #dsarw025#0 = aAuxVer;
          #dsarw025#1 = aAuxEsq;
          #dsarw025#2 = 5000;
          |LEE 101#dsarw025.=;
          |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
          #dsarw025#3 = nDif;
          #dsarw025#4 = #dsarm011#2;
          #dsarw025#5 = #dsarm011#3;
          |GRABA 020#dsarw025.a;
          |LIBERA #dsarw025;

          aAuxEsq = "3.1.5.6.";
          |DDEFECTO #dsarm011;
          #dsarm011#0 = aAuxVer;
          #dsarm011#1 = aAuxEsq;
          |LEE 000#dsarm011.=;

          |DDEFECTO #dsarw025;
          #dsarw025#0 = aAuxVer;
          #dsarw025#1 = aAuxEsq;
          #dsarw025#2 = 5000;
          |LEE 101#dsarw025.=;
          |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
          #dsarw025#3 = nDif;
          #dsarw025#4 = #dsarm011#2;
          #dsarw025#5 = #dsarm011#3;
          |GRABA 020#dsarw025.a;
          |LIBERA #dsarw025;
     |FINSI;
|FPRC;

|PROCESO mediosDePagoNucleo;
     aAuxEsq = "3.1.7.1.1.";
     |DDEFECTO #dsarm011;
     #dsarm011#0 = aAuxVer;
     #dsarm011#1 = aAuxEsq;
     |LEE 000#dsarm011.=;
     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContadorMedioPago;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = fFecha133;
     #dsarw025#4 = #dsarm011#2;
     #dsarw025#5 = #dsarm011#3;
     |GRABA 020#dsarw025.a;
     |LIBERA #dsarw025;

     aAuxEsq = "3.1.7.1.2.";
     |DDEFECTO #dsarm011;
     #dsarm011#0 = aAuxVer;
     #dsarm011#1 = aAuxEsq;
     |LEE 000#dsarm011.=;
     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContadorMedioPago;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = nImporte133;
     #dsarw025#4 = #dsarm011#2;
     #dsarw025#5 = #dsarm011#3;
     |GRABA 020#dsarw025.a;
     |LIBERA #dsarw025;

     aAuxEsq = "3.1.7.1.3.";
     |DDEFECTO #dsarm011;
     #dsarm011#0 = aAuxVer;
     #dsarm011#1 = aAuxEsq;
     |LEE 000#dsarm011.=;
     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContadorMedioPago;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = enTipoPagoFace;
     #dsarw025#4 = #dsarm011#2;
     #dsarw025#5 = #dsarm011#3;
     |GRABA 020#dsarw025.a;
     |LIBERA #dsarw025;

     |SI eaIbanFace ! "";
          |SI enTipoPagoFace = 2;
               aAuxEsq = "3.1.7.1.6.1.";
          |SINO;
               aAuxEsq = "3.1.7.1.4.1.";
          |FINSI;
          |DDEFECTO #dsarm011;
          #dsarm011#0 = aAuxVer;
          #dsarm011#1 = aAuxEsq;
          |LEE 000#dsarm011.=;
          |DDEFECTO #dsarw025;
          #dsarw025#0 = aAuxVer;
          #dsarw025#1 = aAuxEsq;
          #dsarw025#2 = nContadorMedioPago;
          |LEE 101#dsarw025.=;
          |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
          #dsarw025#3 = eaIbanFace;
          #dsarw025#4 = #dsarm011#2;
          #dsarw025#5 = #dsarm011#3;
          |GRABA 020#dsarw025.a;
          |LIBERA #dsarw025;
     |FINSI;

     nContadorMedioPago = nContadorMedioPago + 1;
|FPRC;

|PROCESO mediosDePago;
     nImporte133 = #1002#2; fFecha133 = #1002#3; |HAZ mediosDePagoNucleo;
|FPRC;
|DEFBUCLE mediosDePago;
  #1002#1003;
  ;
  eaSerieFE, eaNumeroFE, 001;
  eaSerieFE, eaNumeroFE, 999;
  ;
  NULL, mediosDePago;
|FIN;

|PROCESO MeteMedioPago;            ||ARA42
     aNomDef = aPathDef + eaDefDatosPagoFe;
     |CARGA_DEF aNomDef, masdef@;
     |SI FSalida ! 0;
          aMensaje = "0000Problemas CARGA_DEF " + eaDefDatosPagoFe;
          |MENAV aMensaje;
          |ACABA;
     |FINSI;
     |PATH_DAT #1002 aPathDatos;
     nContadorMedioPago = 9000;
     |BUCLE mediosDePago;
     |DESCARGA_DEF #masdef@;
     |SI nContadorMedioPago = 9000;  ||No hay encontrado nada en agifa133
          nImporte133 = nTotalFactura; fFecha133 = fFechaFactura; |HAZ mediosDePagoNucleo;
     |FINSI;
|FPRC;

|PROCESO AlbaAlbaOR;
     |SI #1005#10 = "A";
          eaDefAlbFe = "agifa071";
     |SINO;
          eaDefAlbFe = "con00626"; nLinFacTaller = #1005#2;
     |FINSI;
     aNomDef = aPathDef + eaDefAlbFe;
     |CARGA_DEF aNomDef, masdef@;
     |SI FSalida ! 0;
          aMensaje = "0000Problemas CARGA_DEF " + eaDefAlbFe; |MENAV aMensaje; |ACABA;
     |FINSI;
     |PATH_DAT #1002 aPathDatos;
     |SI #1005#10 = "A";
          |ABRE #1002;
          aSerAlb = #1005#3; nNumAlb = #1005#4;
          |BUCLE LineasAlbaran;
          |SI nPortesLin ! 0;
               |HAZ MeteLineaPortes;
          |FINSI;
          |CIERRA #1002;
     |SINO;
          |ABRE #1002; |BUCLE Lineas_ConAlbaranOR; |CIERRA #1002;
     |FINSI;
     |DESCARGA_DEF #masdef@;
|FPRC;

|DEFBUCLE AlbaAlbaOR;
 #1005#1003;
 ;
 eaSerieFE, eaNumeroFE, 01;
 eaSerieFE, eaNumeroFE, 99;
 ;
 NULL, AlbaAlbaOR;
|FIN;

|PROCESO CreaXML;
     nSwXMLCorrecta = 0;

     |DBASE aBaseTempo;
     |QBF aBaseTempo;
     aBaseTempo = aBaseTempo + "tempoxml/";
     |MKDIR aBaseTempo;

     |ABRE #dsarm011;
     |ABRE #dsarm013;

     |HAZ CreaTempo; aTempo25 = Tempo;
     |NOME_DAT #25 aTempo25; |DELINDEX #25;
     |ABRET #25;

     |HAZ CreaTempo; aTempo26 = Tempo;
     |NOME_DAT #26 aTempo26; |DELINDEX #26;
     |ABRET #26;

     |DBASS aBass;
     |QBF aBass;
     |SI eaAplicacion = "salvidal"; aPathAplica = aBass + "salvida4/"; |FINSI;
     |SI eaAplicacion = "carrillo"; aPathAplica = aBass + "gestion/"; |FINSI;
     |SI eaAplicacion = "ds-suite"; aPathAplica = aBass + "ds_suite/"; |FINSI;
     |SI eaAplicacion = "compaq";   aPathAplica = aBass + "compaq4/"; |FINSI;
     |SI eaAplicacion = "xml";      aPathAplica = aBass + "dsarchi/"; |FINSI;
     |SI eaAplicacion = "dscepsa";  aPathAplica = aBass + "dscomer/"; |FINSI;
     |SI eaAplicacion = "dscepsxx"; aPathAplica = aBass + "dscepsax/"; |FINSI;
     |SI eaAplicacion = "drogas86"; aPathAplica = aBass + "dscomer7/"; |FINSI;

     |SI aPathAplica = ""; aPathAplica = aBass + eaAplicacion + "/"; |FINSI;

     aPathDef = aPathAplica + "def/";
     |SI eaEmpresaFE ! "";
          aPathDatos = aPathAplica + "fich/" + eaEmpresaFE + "/";
     |SINO;
          aPathDatos = aPathAplica + "fich/";
     |FINSI;
     aPathDatosEmp = aPathAplica + "fich/";

     eaPathDefAAPP = aPathDef;    eaPathDatosAAPP = aPathDatos;
     eaPathDef8 = aPathDef;       eaPathDatos8 = aPathDatos;

     enMeteAAPP = 0;
     |SI eaDefAAPPFe ! "";
          |HAZ ClienteEsAAPP;
          |SI enMeteAAPP = 1; |Y enFaltanDatosAAPP = 1;
                aObligatorios = eaObligaAAPP;
                nSwErrorXML = 1;
                |SI enSwLogXMLMete = 1;
                     eaTextoLog = "Error: Factura INCOMPLETA. (AA.PP.)" + aObligatorios;
                     |HAZ MeteLogXML;
                |SINO;
                     aTexto1 = "FACTURA INCOMPLETA. (AA.PP.)";
                     aTexto2 = "0000Factura " + eaSerieFE;  |QBF aTexto2;
                     aTexto2 = aTexto2 + "/" + eaNumeroFE;
                     aTexto3 = aObligatorios;
                     |HAZ SacaMensaje;
               |FINSI;
          |FINSI;
     |FINSI;

     aNomDef = aPathDef + eaDefFE;
     |CARGA_DEF aNomDef, referen@;
     |SI FSalida ! 0;
           |SI enSwLogXMLMete = 1;
                eaTextoLog = "Error: Problemas CARGA_DEF " + aNomDef;
                |HAZ MeteLogXML;
           |SINO;
                aMensaje = "0000Problemas CARGA_DEF " + aNomDef;
                |MENAV aMensaje;
           |FINSI;
           nSwXMLCorrecta = 0;
           |ACABA;
     |FINSI;

     |QBF eaDefLinFe;
     |SI eaDefLinFe ! "";
          aNomDef = aPathDef + eaDefLinFe;
          |CARGA_DEF aNomDef, otrodef@;
          |SI FSalida ! 0;
               |SI enSwLogXMLMete = 1;
                    eaTextoLog = "Error: Problemas CARGA_DEF (lineas)" + aNomDef;
                    |HAZ MeteLogXML;
               |SINO;
                    aMensaje = "0000Problemas CARGA_DEF (lineas)" + aNomDef;
                    |MENAV aMensaje;
               |FINSI;
               nSwXMLCorrecta = 0;
               |DESCARGA_DEF #referen@;
               |ACABA;
          |FINSI;
     |FINSI;

     |PATH_DAT #1000 aPathDatos;
     |PATH_DAT #1001 aPathDatos;

     |ABRE #1000;
     |DDEFECTO #1000;
     aAlfa5 = "|K000";
     aClaves = #referen@#aAlfa5#;
     aTCompo = aClaves % 103;
     nTCompo = aTCompo;
     Iclave = clave1<-;
     |PARA nCampo = 1;  |SI nCampo [ 16;  |HACIENDO nCampo = nCampo + 1;
          clave = 0;
          Iclave = Iclave + 1;
     |SIGUE;

     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nPosi = (nCompo * 300) + 103;
          aAlfa1 = aClaves % nPosi;
          clave = aAlfa1;
          Iclave = Iclave + 1;
     |SIGUE;

     nVoy = 1;
     Iclave = clave1<-;
     |PARA nCompo = 1;  |SI nCompo [ nTCompo;  |HACIENDO nCompo = nCompo + 1;
          nNumCam = clave;
          Iclave = Iclave + 1;

          Comodin = ("000" + nNumCam) % -103;
          Comodin = "|C" + Comodin;
          Comodin1 = Comodin + "ILON";
          Comodin1 = #referen@#Comodin1#;
          nTamanyo = Comodin1;
          aTamanyo = ("00" + nTamanyo) % -102;
          nSaca = (nVoy * 100) + aTamanyo;

          |SI eaAplicacion = "facges"; |O eaAplicacion = "facturar";
               |SI eaDefFE = "ascabmin";
                    |SI nCompo = 1;
                         aSaca = enTipoFacFe;
                    |FINSI;
                    |SI nCompo = 2;
                         aSaca = eaCodCliFe;
                    |FINSI;
               |SINO;
                    |SI eaDefFE = "ascabfdi";
                         |SI nCompo = 1;
                              aSaca = enTipoFacFe;
                         |FINSI;
                         |SI nCompo = 2;
                              aSaca = eaSerieFE;
                         |FINSI;
                         |SI nCompo = 3;
                              aSaca = eaNumeroFE;
                         |FINSI;
                         |SI nCompo = 4;
                              aSaca = eaCodCliFe;
                         |FINSI;
                    |SINO;
                         |SI nCompo = 1;
                              aSaca = eaSerieFE;
                         |FINSI;
                         |SI nCompo = 2;
                              aSaca = eaNumeroFE;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI eaAplicacion = "marmol"; |Y eaDefFE = "faconta";
                    |SI nCompo = 1;
                         aSaca = eaNumeroFE;
                    |FINSI;
               |SINO;
                    |SI nCompo = 1;
                         aSaca = eaSerieFE;
                    |FINSI;
                    |SI nCompo = 2;
                         aSaca = eaNumeroFE;
                    |FINSI;
               |FINSI;
          |FINSI;
          #referen@#nNumCam# = aSaca;
          nVoy = nVoy + nTamanyo;
     |SIGUE;
     |LEE 000#1000.=;
     |SI FSalida ! 0;
          aMensaje = "0000Problemas al leer datos de " + eaDefFE + " Emp:" + eaEmpresaFE + " Factura " + eaSerieFE + "/" + eaNumeroFE;
          |MENAV aMensaje;
          nSwXMLCorrecta = 0;
     |SINO;
          aAbreXML = aBaseTempo + aNombreXML;
          |XABRE "BW", aAbreXML, nHandleXML;
          |SI FSalida < 0;
               aMensaje = "0000Error al crear " + aAbreXML;
               |MENAV aMensaje;
                nSwXMLCorrecta = 0;
          |SINO;
               ||NUCLEO
               nContador = 0;

               aBlanco30 = (" " * 30);
               aZeta30 = ("z" * 30);

               |BUCLE dsarm014;
               ||Meto en temporal datos Fijos

               ||Una vez pasada la primera parte, "xml" --> se convierte en "dsarchi".
               |SI eaAplicacion = "xml";
                    eaAplicacion = "dsarchi";
               |FINSI;

               |HAZ ObtenIvaREUnico;

               nPortesCab = 0;
               nPortesIvaCab = 0;
               nSwEsRecEqui = 0;
               |BUCLE dsarm013_cab;
               ||Meto en temporal datos cabecera

               |HAZ DatosEmisor;
               ||Datos Emisor Factura. Lo pillamos de Acceso Empresas

               |HAZ DatosCliente;
               ||Datos Cliente. Lo pillamos de cliente

               |HAZ DatosImpuestos;
               ||Datos Impuestos/IVA. Lo pillamos de la Tabla de IVA.
               |SI eaAplicacion = "facges"; |O eaAplicacion = "facturar"; |O eaAplicacion = "edi"; |O eaAplicacion = "dssat";
                    nIva1 = enTipoIvaFe;
                    |BUCLE dsarm013_iva;
               |FINSI;

               |SI eaDefLinFe ! "";
                    nSwLinYaProcesadas = 0;
                    ||Luego meto en temporal datos de las lineas
                    |SI eaDefFE = "agifa134";
                         |SI eaAplicacion = "dscomer9"; |O eaAplicacion = "dscomer8"; |O eaAplicacion = "dscepsa";
                                   |O eaAplicacion = "drogas86";
                              |QBF eaDefAlbFe;
                              |SI eaDefAlbFe ! "";
                                   nSwLinYaProcesadas = 1;

                                   nSwHayCabPed = 0;
                                   aNomCabPed = "agifa104";
                                   |HAZ MiraCabPed;

                                   nSwHayCabAlb = 0;
                                   aNomCabAlb = "agifa010";
                                   |HAZ MiraCabAlb;

                                   |SI nSwHayCabPed = 1;
                                        aNomDef = aPathDef + aNomCabPed;
                                        |CARGA_DEF aNomDef, auxdef@;
                                        |SI FSalida ! 0;
                                             aMensaje = "0000Problemas CARGA_DEF " + aNomCabPed;
                                             |MENAV aMensaje;
                                             |ACABA;
                                        |FINSI;
                                        |PATH_DAT #1003 aPathDatos;

                                        |ABRE #1003;
                                   |FINSI;

                                   |SI nSwHayCabAlb = 1;
                                        aNomDef = aPathDef + aNomCabAlb;
                                        |CARGA_DEF aNomDef, cuatro@;
                                        |SI FSalida ! 0;
                                             aMensaje = "0000Problemas CARGA_DEF " + aNomCabPed;
                                             |SI nSwHayCabPed = 1;
                                                  |DESCARGA_DEF #auxdef@;
                                             |FINSI;
                                             |MENAV aMensaje;
                                             |ACABA;
                                        |FINSI;
                                        |PATH_DAT #1004 aPathDatos;

                                        |ABRE #1004;
                                   |FINSI;

                                   aNomDef = aPathDef + eaDefAlbFe;
                                   |CARGA_DEF aNomDef, masdef@;
                                   |SI FSalida ! 0;
                                        aMensaje = "0000Problemas CARGA_DEF " + eaDefAlbFe;
                                        |SI nSwHayCabAlb = 1;
                                             |DESCARGA_DEF #cuatro@;
                                        |FINSI;
                                        |SI nSwHayCabPed = 1;
                                             |DESCARGA_DEF #auxdef@;
                                        |FINSI;
                                        |MENAV aMensaje;
                                        |ACABA;
                                   |FINSI;
                                   |PATH_DAT #1002 aPathDatos;

                                   |ABRE #1002;
                                   nLinAux = 0;
                                   |BUCLE Lineas_ConAlbaran;
                                   |CIERRA #1002;

                                   |DESCARGA_DEF #masdef@;
                                   |SI nSwHayCabAlb = 1;
                                        |CIERRA #1004;
                                        |DESCARGA_DEF #cuatro@;
                                        nSwHayCabAlb = 0;
                                   |FINSI;
                                   |SI nSwHayCabPed = 1;
                                        |CIERRA #1003;
                                        |DESCARGA_DEF #auxdef@;
                                        nSwHayCabPed = 0;
                                   |FINSI;
                              |SINO;
                                   ||Si entra aqui es un error de programacion. ||CCC
                                   aMensaje = "0000ERROR. No se ha indicado que fichero son las lineas de los Albaranes";
                                   |MENAV aMensaje;
                              |FINSI;
                         |FINSI;
                    |FINSI;
                    |SI eaAplicacion = "facges"; |O eaAplicacion = "facturar";
                         |SI eaDefFE = "ascabmin";
                              |BUCLE Lineas_aslinmin;
                         |SINO;
                              |SI eaDefFE = "ascabfdi";
                                   |BUCLE Lineas_aslinfdi;
                              |SINO;
                                   |BUCLE Lineas;
                              |FINSI;
                         |FINSI;
                    |SINO;
                         |SI eaAplicacion = "marmol";
                              |SI eaDefFE = "efactuca"; |O eaDefFE = "facturas"
                                   ||Lineas Albaran. MARMOL
                                   |QBF eaDefAlbFe;
                                   |SI eaDefAlbFe ! "";
                                        aNomDef = aPathDef + eaDefAlbFe;
                                        |CARGA_DEF aNomDef, masdef@;
                                        |SI FSalida ! 0;
                                             aMensaje = "0000Problemas CARGA_DEF " + eaDefAlbFe;
                                             |MENAV aMensaje;
                                             |ACABA;
                                        |FINSI;
                                        |PATH_DAT #1002 aPathDatos;

                                        |ABRE #1002;
                                        nLinAux = 0;
                                        |BUCLE Lineas_ConAlbaran;
                                        |CIERRA #1002;

                                        |DESCARGA_DEF #masdef@;
                                   |SINO;
                                        ||Si entra aqui es un error de programacion. ||CCC
                                        aMensaje = "0000ERROR. No se ha indicado que fichero son las lineas de los Albaranes";
                                        |MENAV aMensaje;
                                   |FINSI;
                              |SINO;
                                   |BUCLE Lineas_faclinco;
                              |FINSI;
                         |SINO;
                              |SI eaAplicacion = "salvidal";
                                   |QBF eaDefAlbFe;
                                   |SI eaDefAlbFe ! "";
                                        aNomDef = aPathDef + eaDefAlbFe;
                                        |CARGA_DEF aNomDef, masdef@;
                                        |SI FSalida ! 0;
                                             aMensaje = "0000Problemas CARGA_DEF " + eaDefAlbFe;
                                             |MENAV aMensaje;
                                             |ACABA;
                                        |FINSI;
                                        |PATH_DAT #1002 aPathDatos;

                                        |ABRE #1002;
                                        nLinAux = 0;
                                        |BUCLE Lineas_ConAlbaran;
                                        |CIERRA #1002;

                                        |DESCARGA_DEF #masdef@;
                                   |SINO;
                                        ||Si entra aqui es un error de programacion. ||CCC
                                        aMensaje = "0000ERROR. No se ha indicado que fichero son las lineas de los Albaranes";
                                        |MENAV aMensaje;
                                   |FINSI;
                              |SINO;
                                   |SI eaDefFE = "agifa134"; |Y eaAplicacion = "carrillo";         ||Facturas Venta
                                        |QBF eaDefAlbFe;
                                        |SI eaDefAlbFe ! "";
                                             aNomDef = aPathDef + eaDefAlbFe;
                                             |CARGA_DEF aNomDef, masdef@;
                                             |SI FSalida ! 0;
                                                  aMensaje = "0000Problemas CARGA_DEF " + eaDefAlbFe;
                                                  |MENAV aMensaje;
                                                  |ACABA;
                                             |FINSI;
                                             |PATH_DAT #1002 aPathDatos;

                                             |ABRE #1002;
                                             nLinAux = 0;
                                             |BUCLE Lineas_ConAlbaran;
                                             |CIERRA #1002;

                                             |DESCARGA_DEF #masdef@;
                                        |SINO;
                                             ||Si entra aqui es un error de programacion. ||CCC
                                             aMensaje = "0000ERROR. No se ha indicado que fichero son las lineas de los Albaranes";
                                             |MENAV aMensaje;
                                        |FINSI;
                                   |SINO;
                                        |SI eaDefFE = "con00637"; |Y eaAplicacion = "dscomer9";         ||Facturas OR. Mod. 001996
                                             aNomDef = aPathDef + "con00642";
                                             |CARGA_DEF aNomDef, cinco@;
                                             |SI FSalida ! 0;
                                                  aMensaje = "0000Problemas CARGA_DEF agifa010 (Albaranes)";
                                                  |MENAV aMensaje;
                                                  |ACABA;
                                             |FINSI;
                                             |PATH_DAT #1005 aPathDatos;
                                             nLinAux = 0;
                                             |BUCLE AlbaAlbaOR;
                                             |DESCARGA_DEF #cinco@;
                                        |SINO;
                                             |SI eaDefFE = "agifa134"; |Y eaAplicacion = "compaq";         ||Facturas Venta
                                                  |HAZ LineasCompaq;
                                             |SINO;
                                                  |SI nSwLinYaProcesadas = 0;
                                                       |BUCLE Lineas;
                                                  |FINSI;
                                             |FINSI;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
                    |SI nDtoCabALin ! 0;
                         |HAZ MeteLineaDtoCabecera;
                    |FINSI;
               |FINSI;

               ||Esto se usa en facturar UNICAMENTE.
               |SI eaDefVencFe ! "";
                    |HAZ DatosVencimientos;
                    ||Datos Vencimientos/Forma Pago. Lo pillamos de los recibos
               |FINSI;

               ||Ahora vamos a hacer el equivalente a DatosVencimientos
               ||Pero de forma correcta, por ahora SOLO En dscomer9/8  ||ARA42
               |SI nPonMedioPago = 1;
                    ||aMensaje = "0000Medio de Pago. Factura: " + eaSerieFE + "/" + eaNumeroFE + "->" + eaFormaPagoFace;
                    |||MENAV aMensaje;
                    |HAZ DameTipoPagoIban;
                    |SI enTipoPagoFace ! 0;
                         ||aMensaje = "0000Tipo de Pago: " + enTipoPagoFace + "/" + eaIbanFace;
                         |||MENAV aMensaje;
                         |HAZ MeteMedioPago;
                    |FINSI;
               |FINSI;

               |HAZ ControlIVASCEROCABEZA;

               |SI nPortesCab ! 0;
                    |HAZ MetePortesCab;
               |FINSI;

               ||Este PostProceso, Realiza calculos varios, como el total antes de impuestos
               ||quitando del bruto el total impuestos.
               ||Tb. se utiliza para quitar el descuento de las lineas. (en la parte del iva)
               ||En ds-suite calcula: TotalGrossAmount y TotalGrossAmountBeforeTaxes
               |HAZ PostProceso;

               |BUCLE dsarm016;
               ||Meto en temporal datos Fijos. Por aplicacion
               |HAZ InfoExtraFacturaE;

               ||Recorro el temporal al reves y meto ramas madre
               nVecesItems = 0;
               nVecesInvoices = 0;
               |BUCLE dsarw025_alreves;

               ||Recorro y borro el temporal, para meter TAG Inicio
               |BUCLE dsarw026;

               aMete = aFicXMLIni;
               |QBF aMete;
               aMete = aMete < aMete;
               |SI aMete ! "";
                    |HAZ MeteEnXML;
               |SINO;
                    |HAZ CabeceraXML;
               |FINSI;
               |SI eaAplicacion = "dscepsa";
                    |HAZ MiraSigausDSCEPSA;
               |FINSI;
               |SI enMeteAAPP = 1;
                    |HAZ PonPrefijoPais;
               |FINSI;
               |HAZ DecimalesTotalesLin;
               |SI eaModuloFE = "tallerSC"; |HAZ RecalTotIvaTalleres; |FINSI;
               |SI enSwSuprimirLinCero = 1; |HAZ SuprimirLinCero; |FINSI;
               |SI nSwModoDebug = 1;
                    |HAZ Imprimew025;
               |FINSI;
               |HAZ dsarw025ControlesVarios;
               ||Meto el temporal en el XML.
               |BUCLE dsarw025;

               |HAZ CierraTagsPendientes;

               ||Meto el final del XML.
               aMete = aFicXMLFin;
               |QBF aMete;
               aMete = aMete < aMete;
               |SI aMete ! "";
                    |HAZ MeteEnXML;
               |SINO;
                    |HAZ FinalXML;
               |FINSI;

               |XCIERRA nHandleXML;

               nSwXMLCorrecta = 1;
          |FINSI;
          ||Rellenamos el temporal con datos de Cabecera y linea
          ||Lo recorro al reves para rellenar "ramas"
          ||Creo el .xml real.
     |FINSI;

     |CIERRA #1000;
     |DESCARGA_DEF #otrodef@;
     |DESCARGA_DEF #referen@;

     |CIERRAT #26;
     |DELINDEX #26; Tempo = aTempo26; |HAZ BoraTempo;

     |CIERRAT #25;
     |DELINDEX #25; Tempo = aTempo25; |HAZ BoraTempo;

     |CIERRA #dsarm011;
     |CIERRA #dsarm013;
|FPRC;

|PROCESO MeteLineaDtoCabecera;
     ||DTO CABECERA (Se genera una LINea)
     nContador = nContador + 1;

     |DDEFECTO #dsarw025;
     aAuxEsq = "3.1.6.1.7.";
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     aAuxAlfa = "DESCUENTO DEL " + nDtoPorCabALin + "%";
     #dsarw025#3 = aAuxAlfa;
     |HAZ Pon4y5;

     |DDEFECTO #dsarw025;
     aAuxEsq = "3.1.6.1.8.";
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = 1;
     |HAZ Pon4y5;

     |DDEFECTO #dsarw025;
     aAuxEsq = "3.1.6.1.10.";
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     nAuxNum = nDtoCabALin * -1;
     #dsarw025#3 = nAuxNum;
     |HAZ Pon4y5;

     |DDEFECTO #dsarw025;
     aAuxEsq = "3.1.6.1.11.";
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     nAuxNum = nDtoCabALin * -1;
     #dsarw025#3 = nAuxNum;
     |HAZ Pon4y5;

     |DDEFECTO #dsarw025;
     aAuxEsq = "3.1.6.1.14.";
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     nAuxNum = nDtoCabALin * -1;
     #dsarw025#3 = nAuxNum;
     |HAZ Pon4y5;

     |DDEFECTO #dsarw025;
     aAuxEsq = "3.1.6.1.15.1.1.";
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = "01";
     |HAZ Pon4y5;

     nPorIva = enTipoIvaFe;

     aAuxEsq = "3.1.6.1.15.1.2.";  ||TaxRate.. %IVA
     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = nPorIva;
     |HAZ Pon4y5;

     aAuxEsq = "3.1.6.1.15.1.3.1.";
     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     nAuxNum = nDtoCabALin * -1;
     #dsarw025#3 = nAuxNum;
     |HAZ Pon4y5;

     aAuxEsq = "3.1.6.1.15.1.4.1.";  ||TaxAmount (TotalAmount).. %IVA
     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     |SI nPorIva = 0;
          #dsarw025#3 = 0;
     |SINO;
          nValorAux2 = nDtoCabALin % nPorIva;
          nValorAux2 = nValorAux2 * -1;
          #dsarw025#3 = nValorAux2;
     |FINSI;
     |HAZ Pon4y5;

     aAuxEsq = "3.1.6.1.18.";
     |DDEFECTO #dsarw025;
     #dsarw025#0 = aAuxVer;
     #dsarw025#1 = aAuxEsq;
     #dsarw025#2 = nContador;
     |LEE 101#dsarw025.=;
     |SI FSalida ! 0; |GRABA 020#dsarw025.b; |FINSI;
     #dsarw025#3 = aFechaFactura;
     |HAZ Pon4y5;
|FPRC;

|PROCESO LineasCompaq;
     |QBF eaDefAlbFe;
     |SI eaDefAlbFe ! "";
          nSwHayCabPed = 0;
          aNomCabPed = "agifa104";
          |HAZ MiraCabPed;

          nSwHayCabAlb = 0;
          aNomCabAlb = "agifa010";
          |HAZ MiraCabAlb;

          |SI nSwHayCabPed = 1;
               aNomDef = aPathDef + aNomCabPed;
               |CARGA_DEF aNomDef, auxdef@;
               |SI FSalida ! 0;
                    aMensaje = "0000Problemas CARGA_DEF " + aNomCabPed;
                    |ACABA;
               |FINSI;
               |PATH_DAT #1003 aPathDatos;

               |ABRE #1003;
          |FINSI;

          |SI nSwHayCabAlb = 1;
               aNomDef = aPathDef + aNomCabAlb;
               |CARGA_DEF aNomDef, cuatro@;
               |SI FSalida ! 0;
                    aMensaje = "0000Problemas CARGA_DEF " + aNomCabPed;
                    |SI nSwHayCabPed = 1;
                         |DESCARGA_DEF #auxdef@;
                    |FINSI;
                    |MENAV aMensaje;
                    |ACABA;
               |FINSI;
               |PATH_DAT #1004 aPathDatos;

               |ABRE #1004;
          |FINSI;

          aNomDef = aPathDef + eaDefAlbFe;
          |CARGA_DEF aNomDef, masdef@;
          |SI FSalida ! 0;
               aMensaje = "0000Problemas CARGA_DEF " + eaDefAlbFe;
               |SI nSwHayCabAlb = 1;
                    |DESCARGA_DEF #cuatro@;
               |FINSI;
               |SI nSwHayCabPed = 1;
                    |DESCARGA_DEF #auxdef@;
               |FINSI;
               |MENAV aMensaje;
               |ACABA;
          |FINSI;
          |PATH_DAT #1002 aPathDatos;

          |ABRE #1002;
          nLinAux = 0;
          |BUCLE Lineas_ConAlbaran;
          |CIERRA #1002;

          |DESCARGA_DEF #masdef@;
          |SI nSwHayCabAlb = 1;
               |CIERRA #1004;
               |DESCARGA_DEF #cuatro@;
               nSwHayCabAlb = 0;
          |FINSI;
          |SI nSwHayCabPed = 1;
               |CIERRA #1003;
               |DESCARGA_DEF #auxdef@;
               nSwHayCabPed = 0;
          |FINSI;
     |SINO;
          ||Si entra aqui es un error de programacion. ||CCC
          aMensaje = "0000ERROR. No se ha indicado que fichero son las lineas de los Albaranes";
          |MENAV aMensaje;
     |FINSI;
|FPRC;

|PROCESO MeteEnXML;
     |DBASE aBaseMete;
     |QBF aBaseMete;
     aBaseMete = aBaseMete + "plugins/";
     aMeteCompleto = aBaseMete + aMete;
     |XABRE "BU", aMeteCompleto, nHandleMete;
     |SI FSalida ] 0;
          |PARA; |SI; |HACIENDO;
               |XLEE nHandleMete, 1, aLetra;
               |SI FSalida [ 0;
                    |SAL;
               |FINSI;
               |XGRABA nHandleXML, aLetra;
          |SIGUE;
          |XCIERRA nHandleMete;
     |FINSI;
|FPRC;

|PROCESO CierraTagsPendientes;
     |LEE 000#dsarw026.u;
     |PARA; |SI; |HACIENDO;
          |SI FSalida ! 0;
               |SAL;
          |SINO;
               aPatron = #dsarw026#0;
               |QBF aPatron;
               |SI aPatron ! "";
                    nSwCierraTag = 1;
               |FINSI;
          |FINSI;

          |SI nSwCierraTag = 1;
               |LEE 101#dsarw026.=;
               |SI FSalida = 0;
                    aEsquema = #dsarw026#0;
                    nPuntos = 0;
                    |HAZ DimePuntos;
                    aTag = #dsarw026#1;
                    |QBF aTag;

                    aLinea = aTab * nPuntos;
                    aLinea = aLinea + "</" + aTag + ">";
                    |HAZ MeteLinea;

                    |BORRA 020#dsarw026.a;
                    |LIBERA #dsarw026;
               |SINO;
                    |SAL;
               |FINSI;

               |LEE 000#dsarw026.u;
               nSwCierraTag = 0;
          |SINO;
               |LEE 000#dsarw026.a;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO dsarm015;
     |DDEFECTO #dsarw028;
     #dsarw028#0 = #dsarm015#0;
     |LEE 101#dsarw028.=;
     |SI FSalida ! 0; |GRABA 020#dsarw028.b; |FINSI;
     #dsarw028#1 = #dsarm015#1;
     #dsarw028#2 = #dsarm015#2;
     #dsarw028#3 = #dsarm015#3;
     #dsarw028#5 = #dsarm015#4;
     |GRABA 020#dsarw028.a;
     |LIBERA #dsarw028;
|FPRC;

|DEFBUCLE dsarm015;
 #dsarm015#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, dsarm015;
|FIN;

|PROGRAMA;
     |SUB_EJECUTA_NP "dsarz057";

     |HAZ LeeUnidadBasico;

     ||Miramos si tiene que copiar los patrones.
     aEjecuta = "dsarz014";
     |SUB_EJECUTA_NP aEjecuta;

     enAprobacion = 0;
     eaPrograma   = "WEBSERVICEFACE";
     |HAZ DSARCHI_INI;
     enSwWebServiceFace = enAprobacion;

     aReturn = &13 + &10;
     aTab = &9;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;

     nSwModoDebug = 0;
     aAlfaUsu = Usuario % 810;
     |QBF aAlfaUsu;
     aAlfaUsu = aAlfaUsu > aAlfaUsu;
     |SI aIPRemoto = "192.168.10.47"; |Y aAlfaUsu = "CARLOSC";
     ||SI aIPRemoto = "192.168.7.47"; |Y aAlfaUsu = "CARLOSC";
          nSwModoDebug = 0;
     |FINSI;

     |SI enArNumDoc = 0;
          |SI enSwLogXMLMete = 1;
               ||NADA.
          |SINO;
               aMensaje = "0000No es posible archivar un documento con Numero CERO";
               |MENAV aMensaje;
          |FINSI;

          |ACABA;
     |FINSI;

     nSwTipoArchi = 0;

     |HAZ CreaTempo; aTempo128 = Tempo;
     |NOME_DAT #128 aTempo128; |DELINDEX #128;
     |ABRET #128;

     |BUCLE dsarm015;

     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0; |DDEFECTO #dsarw010; |FINSI;
     |CIERRA #dsarw010;

     |ABRE #dsarm001;
     |LEE 000#dsarm001.p;
     |SI FSalida ! 0; |DDEFECTO #dsarm001; |FINSI;
     |CIERRA #dsarm001;

     aFicXMLIni = #dsarm001#41;
     aFicXMLFin = #dsarm001#42;
     aVersionXML = #dsarm001#40;

     nSwSoloPDF = 0;
     nEmpresa = eaEmpresaFE;
     enEmpCorreo = nEmpresa;
     |SI nEmpresa ! 0;
          |ABRE #dsarm057;
          |DDEFECTO #dsarm057;
          #dsarm057#0 = nEmpresa;
          |LEE 000#dsarm057.=;
          |SI FSalida = 0;
               aFicXMLIni = #dsarm057#3;
               aFicXMLFin = #dsarm057#4;
               aVersionXML = #dsarm057#2;
               |SI #dsarm057#7 = "S"; |Y #dsarm057#6 = "S";
                    |SI eaFacturaPDFFe ! "";
                         nSwSoloPDF = 1;
                    |SINO;
                         |SI enSwLogXMLMete = 1;
                              eaTextoLog = "Error: Problemas al generar fichero PDF.";
                              |HAZ MeteLogXML;
                         |SINO;
                              aTexto1 = "Problemas al generar fichero PDF."
                              aTexto2 = "";
                              |HAZ SacaMensaje;
                         |FINSI;
                         |ACABA;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI #dsarm001#201 = "S"; |Y #dsarm001#164 = "S";
                    |SI eaFacturaPDFFe ! "";
                         nSwSoloPDF = 1;
                    |SINO;
                         |SI enSwLogXMLMete = 1;
                              eaTextoLog = "Error: Problemas al generar fichero PDF.";
                              |HAZ MeteLogXML;
                         |SINO;
                              aTexto1 = "Problemas al generar fichero PDF."
                              aTexto2 = "";
                              |HAZ SacaMensaje;
                         |FINSI;
                         |ACABA;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          |SI #dsarm001#201 = "S"; |Y #dsarm001#164 = "S";
               |SI eaFacturaPDFFe ! "";
                    nSwSoloPDF = 1;
               |SINO;
                    |SI enSwLogXMLMete = 1;
                         eaTextoLog = "Error: Problemas al generar fichero PDF.";
                         |HAZ MeteLogXML;
                    |SINO;
                         aTexto1 = "Problemas al generar fichero PDF."
                         aTexto2 = "";
                         |HAZ SacaMensaje;
                    |FINSI;
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;
     eaAuxVersion = aVersionXML;

     ||Adaptar para Facturas DSCOMER9.
     aAux = eaAplicacion;
     aAux = aAux > aAux;
     |SI aAux = "DSCOMER9"; |O aAux = "DSCOMER8"; |O aAux = "DROGAS86";
          nSwTipoArchi = 2; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "     ") % 105;
     |FINSI;
     |SI aAux = "FACGES";
          nSwTipoArchi = 3; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "     ") % 105;
     |FINSI;
     |SI aAux = "FACTURAR";
          nSwTipoArchi = 4; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "     ") % 105;
     |FINSI;
     |SI aAux = "MARMOL";
          nSwTipoArchi = 5; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "     ") % 105;
     |FINSI;
     |SI aAux = "GESRACOR";
          nSwTipoArchi = 6; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "     ") % 105;
     |FINSI;
     |SI aAux = "SALVIDAL";
          nSwTipoArchi = 7; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + " ") % 101;
     |FINSI;
     |SI aAux = "EDI";
          nSwTipoArchi = 8; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "  ") % 102;
     |FINSI;
     |SI aAux = "CARRILLO";
          nSwTipoArchi = 9; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "  ") % 102;
     |FINSI;
     |SI aAux = "DS-SUITE";
          nSwTipoArchi = 10; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "     ") % 105;
     |FINSI;
     |SI aAux = "COMPAQ";
          nSwTipoArchi = 11; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "  ") % 102;
     |FINSI;
     |SI aAux = "XML";
          nSwTipoArchi = 12; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "     ") % 105;
     |FINSI;
     |SI aAux = "DSSAT";
          nSwTipoArchi = 13; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "  ") % 102;
     |FINSI;
     |SI aAux = "DSCEPSA";
          nSwTipoArchi = 14; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "  ") % 102;
     |FINSI;
     |SI aAux = "DSCEPSAX";
          nSwTipoArchi = 15; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "  ") % 102;
     |FINSI;
     |SI aAux = "DSCEPSXX";
          nSwTipoArchi = 16; aSerie5 = eaArSerDoc; |QBT aSerie5; aSerie5 = (aSerie5 + "  ") % 102;
     |FINSI;
     nEmpresaFE = eaEmpresaFE;
     |SI eaAplicacion = "compaq";
          |SI eaFirmarFE = "N"; |Y eaSwEnvioCorreo = "S";
               nSwCompaqSoloPDF = 1;
          |SINO;
               nSwCompaqSoloPDF = 0;
          |FINSI;
     |FINSI;
     nNumDocum = 0;
     |ABRE #dsarm005;
     |SELECT #15#dsarm005;
     #dsarm005#84 = eaArTipoDoc;
     #dsarm005#85 = eaArSerDoc;
     #dsarm005#86 = enArNumDoc;
     |LEE 000#dsarm005.];
     |PARA; |SI FSalida = 0; |Y #dsarm005#84 = eaArTipoDoc; |Y #dsarm005#85 = aSerie5;
      |Y #dsarm005#86 = enArNumDoc; |HACIENDO;
        |SI #dsarm005#87 = eaArFecDoc; |Y #dsarm005#88 = nEmpresaFE;
           nNumDocum = #dsarm005#0;
        |FINSI;
        |LEE 000#dsarm005.s;
     |SIGUE;

     ||Tiquet. 98.3157
     ||El problema ya hemos visto que es el campo tipo documento AUX que esta grabando FN o FH segun si
     ||se archivan desde la entrada de minutas o desde el historico. En estos casos ambos tipos son
     ||equivalentes y en el chequeo de si ya existe la minuta deberia tomarlos como iguales.

     |SI eaAplicacion = "facturar"; |Y nNumDocum = 0;
          |SI eaArTipoDoc = "FN";
               aTipoDocEquiv = "FH";
          |SINO;
               aTipoDocEquiv = "FN";
          |FINSI;
          #dsarm005#84 = aTipoDocEquiv;
          #dsarm005#85 = eaArSerDoc;
          #dsarm005#86 = enArNumDoc;
          |LEE 000#dsarm005.];
          |PARA; |SI FSalida = 0; |Y #dsarm005#84 = aTipoDocEquiv; |Y #dsarm005#85 = aSerie5;
           |Y #dsarm005#86 = enArNumDoc; |HACIENDO;
             |SI #dsarm005#87 = eaArFecDoc; |Y #dsarm005#88 = nEmpresaFE;
                nNumDocum = #dsarm005#0;
             |FINSI;
             |LEE 000#dsarm005.s;
          |SIGUE;
     |FINSI;

     |SELECT #1#dsarm005; |HAZ Ubicacion; |CIERRA #dsarm005;

     |CIERRAT #128; |DELINDEX #128; Tempo = aTempo128; |HAZ BoraTempo;

     aAux = eaAplicacion;
     aAux = aAux > aAux;
     |SI aAux = "GESRACOR";
          enSwDesde9 = 0;
     |SINO;
          enSwDesde9 = 1;
     |FINSI;

     |SI nSwErrorXML = 0; ||ARA39
          |SI enSwEnviaSOAPFACE = 1;    ||ARA42
               eaNomFacSOAP = #dsarm005#9;  |QBF eaNomFacSOAP;
               aExtension = eaNomFacSOAP % -105;
               |SI aExtension = ".xsig";
                    eaFacturaSOAP = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + eaNomFacSOAP;
                    eaNumDocSOAP = ("000000000" + #dsarm005#0) % -109;  |QBF eaNumDocSOAP;
                    |HAZ EnviaFacturaSOAP;
               |FINSI;
          |FINSI;
          |SUB_EJECUTA "dpntz001;CLI";
     |FINSI;
     enSwDesde9 = 0;

     |SI #dsarm001#181 = "S";
          |QBF aBorraCache;
          |SI aBorraCache ! "";
               |RFBORRA aBorraCache;
               |SI #dsarm005#89 = "S";
                    aExtension = aBorraCache % -104;
                    |SI aExtension = ".xml";
                         aInicioBorra = aBorraCache - aExtension;
                         aBorraCache = aInicioBorra + ".html";
                         |RFBORRA aBorraCache;
                         aBorraCache = aInicioBorra + ".html.txt";
                         |RFBORRA aBorraCache;
                         aBorraCache = aInicioBorra + ".xml.txt";
                         |RFBORRA aBorraCache;
                         aBorraCache = aInicioBorra + ".xsig";
                         |RFBORRA aBorraCache;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |DBASE aAlfa;   |QBF aAlfa;
     aAlfa = aAlfa + "ocr/";
     aAlfa = aAlfa + "Envio" + Usuario + ".txt";
     |XABRE "E", aAlfa, 0;
     |SI FSalida ] 0;
         |SUB_EJECUTA "dsarw010;ENVIAAVISODIAGRAM";
     |FINSI;
|FPRO;
