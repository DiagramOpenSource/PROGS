|FICHEROS;
     dsarz010 #510;
     dsarw022 #922,MANTE;
     dsarw023 #923,MANTE;

     dsarm043 #43;
     dsarm032 #32;            ||Dir.Origen p/Usuario
     dpntm001;
|FIN;

|VARIABLES;
     nSalida = 0;
     aEmail = "";

     ||Control Vistas
     nSubPanta = 0;
     aMensaje = "";

     {2}nNivel = 0;
     nIdSalir = 0;

     aBase         = "";
     aAlfa         = "";
     aAlfa1        = "";
     aAlfa2        = "";
     aReg          = "";
     aEsc1         = "";
     aEsc2         = "";
     aRetu         = "";
     aTecla        = "";
     aUsuario      = "";
     aPassword     = "";
     aBaseSoporte  = "";
     aMas          = "";
     aPath         = "";
     aFichero      = "";

     nBuffer       = 0;
     nNumUsuarios  = 0;
     nRegistro     = 0;
     nPanta0       = 0;
     nRango        = 0;
     nPos1         = 0;
     nPos2         = 0;
     nCampoD       = 0;
     nCampoH       = 0;
     nBoton1_1     = 0;
     nBoton1_2     = 0;
     nBoton1_3     = 0;
     nBoton1_4     = 0;
     nBotonVistas  = 0;
     nDatos        = 0;
     nGrid         = 0;
     nPermiso      = 0;
     nExiste       = 0;
     nHandle       = 0;
     nVent         = 0;

     {-1}aVent        = "";
         aVent1       = 0;
         aVent2       = 0;
         aVent3       = 0;
         aVent4       = 0;
         aVent5       = "";
|FIN;

|PROCESO Tipo12;  |TIPO 12;
|FPRC;

|PROCESO PintaSubPanta;
     |PARA nCampoD = 0;  |SI nCampoD [ 52;  |HACIENDO nCampoD = nCampoD + 1;
           nCampoH = nCampoD + 2;
           #922nCampoD = #510nCampoH;
     |SIGUE;

     |PINDA #0#922;
|FPRC;

|PROCESO ObtenIdSalir;
     InNivel = nNivel1<-;
     nNivel1 = 0;
     |ESPECIFICA "IDBOTONTECLA", nNivel;
     nIdSalir = nNivel2;
|FPRC;



|| ------------------------------------------------------
|| Procesos del Boton 1_1
|| ------------------------------------------------------

|PROCESO Boton1_1;
     nIdSalir = 0;
     |HAZ ObtenIdSalir;
     |ESTADO_CONTROL nIdSalir, "HIDE";

     nDatos   = 1;
     aUsuario = #510#0;

     |ESTADO_CONTROL nBoton1_1, "DISABLE";
     |ESTADO_CONTROL nBoton1_3, "DISABLE";
     |ESTADO_CONTROL nBoton1_4, "DISABLE";
     |ESTADO_CONTROL nBoton1_2, "ENABLE";

     |ENDATOS #1#922;

     nDatos = 0;

     |ESTADO_CONTROL nBoton1_1, "ENABLE";
     |ESTADO_CONTROL nBoton1_3, "ENABLE";
     |ESTADO_CONTROL nBoton1_4, "ENABLE";
     |ESTADO_CONTROL nBoton1_2, "DISABLE";

     #510#0 = aUsuario;
     |LEE 101#510=;
     |SI FSalida = 0;
         |PARA nCampoD = 0;  |SI nCampoD [ 52;  |HACIENDO nCampoD = nCampoD + 1;
               nCampoH = nCampoD + 2;
               #510nCampoH = #922nCampoD;
         |SIGUE;

         |ABRE #dsarm032;
         |DDEFECTO #dsarm032
         #dsarm032#0 = #510#0;
         |LEE 101#dsarm032.=;
         nSalida = FSalida;

         aEmail = #510#51;
         |QBF aEmail;
         |SI aEmail = "";
               ||Lo borro
               |SI nSalida = 0;
                    |BORRA 020#dsarm032.a;
               |FINSI;
         |SINO;
               ||Lo actualizo.
               #dsarm032#1 = #510#53;
               |SI nSalida = 0;
                    |GRABA 020#dsarm032.a;
               |SINO;
                    |GRABA 020#dsarm032.n;
               |FINSI;
         |FINSI;
         |LIBERA #dsarm032;
         |CIERRA #dsarm032;

         |GRABA 020#510a;
         |LIBERA #510;
     |FINSI;

     |ESTADO_CONTROL nIdSalir, "SHOW";
|FPRC;

|| ------------------------------------------------------
|| Procesos del Boton 1_2
|| ------------------------------------------------------

|PROCESO Boton1_2;
     |PTEC 806;
|FPRC;

|| ------------------------------------------------------
|| Procesos del Boton 1_3
|| ------------------------------------------------------

|PROCESO Boton1_3;
     |LEE 101#510=;
     |SI FSalida = 0;
         |PARA nCampoD = 2;  |SI nCampoD [ 52;  |HACIENDO nCampoD = nCampoD + 1;
               #510nCampoD = "N";
         |SIGUE;
         #510#54 = "N";
         |GRABA 020#510a;
         |LIBERA #510;

         |HAZ PintaSubPanta;
     |FINSI;
|FPRC;

|| ------------------------------------------------------
|| Procesos del Boton 1_4
|| ------------------------------------------------------

|PROCESO Boton1_4;
     |LEE 101#510=;
     |SI FSalida = 0;
         |PARA nCampoD = 2;  |SI nCampoD [ 15;  |HACIENDO nCampoD = nCampoD + 1;
               #510nCampoD = "S";
         |SIGUE;
         #510#54 = "S";
         |GRABA 020#510a;
         |LIBERA #510;

         |HAZ PintaSubPanta;
     |FINSI;
|FPRC;

|| ------------------------------------------------------
|| Procesos del Incio del Programa
|| ------------------------------------------------------

|PROCESO Evento510;
     |SI FSalida = 1;  |O FSalida = 2;
         |SI nDatos = 1;
             #510#0 = aUsuario;
             |LEE 000#510=;
             |REFRESCACONTROL nGrid;
             FSalida = "SKIPDEFAULT";
             |ACABA;
         |FINSI;

         |LEE 000#510=;
         |SI FSalida ! 0;  |ACABA;  |FINSI;

         |HAZ PintaSubPanta;
     |FINSI;
|FPRC;

|PROCESO dsarz010B;
     aAlfa1  = #510#0;  |QBF aAlfa1;
     nExiste = 0;
     |PARA nRegistro = 0; |SI nRegistro < nNumUsuarios; |HACIENDO nRegistro = nRegistro + 1;
           |DEL_BUF nBuffer, nRegistro, aAlfa;

           aAlfa2 = aAlfa % 410;  |QBF aAlfa2;
           |SI aAlfa1 = aAlfa2;  nExiste = 1;  |SAL;  |FINSI;
     |SIGUE;

     |SI nExiste = 0;
         #dpntm001#0 = #dsarz010#0;
         |LEE 000#dpntm001.=;
         |SI FSalida = 0;
             nExiste = 1;
         |FINSI;
     |FINSI;

     |SI nExiste = 0;
         |BORRA 020#510a;
     |FINSI;
     |LIBERA #510;
|FPRC;

|DEFBUCLE dsarz010B;
     #510#1;
     ;
     "          ";
     "zzzzzzzzzz";
     be;
     NULL, dsarz010B;
|FIN;

|PROCESO BuscaUsuarios;
     |DIMENSIONA 1000, nBuffer, 0;

     aBase = "";
     |DBASS aBase;  |QBF aBase;
     aAlfa  = aBase + "dev/usr/ds_sys.psw"
     |LEESECUENCIAL aAlfa, nBuffer, nNumUsuarios, 0, 0;
     |PARA nRegistro = 0; |SI nRegistro < nNumUsuarios; |HACIENDO nRegistro = nRegistro + 1;
         |DEL_BUF nBuffer, nRegistro, aAlfa;

         aReg = aAlfa % 410;  #510#0 = aReg;

         |LEE 101#510=;
         |SI FSalida ! 0;
             |DDEFECTO #510;
             #510#0 = aReg;
             |QBF aReg;

             ||POR DEFECTO. TODO PERMITIDO. COMO HASTA AHORA.

             |PARA nCampoD = 2;  |SI nCampoD [ 15;  |HACIENDO nCampoD = nCampoD + 1;
                   #510nCampoD = "S";
             |SIGUE;

             |GRABA 020#510b;
         |FINSI;

         |GRABA 020#510a;
         |LIBERA #510;
    |SIGUE;

    |ABRE #dpntm001;
    |BUCLE dsarz010B;
    |CIERRA #dpntm001;

    |FINDIM nBuffer;
|FPRC;

|PROCESO Tipo80;  |TIPO 80;
     |SI PARAMETRO ! "";
         aFichero = "grupousu";  |NOME_DAT #510 aFichero;
         aFichero = "grupovis";  |NOME_DAT #43 aFichero;
         aFichero = "grupomai";  |NOME_DAT #32 aFichero;
     |FINSI;

     |ABRET #510;

     |SI PARAMETRO ! "";  |ACABA;  |FINSI;

     aUsuario = Usuario % 810;
     |HAZ BuscaUsuarios;

     nPermiso = 0;
/*
     aUsuario = Usuario % 810;
     #510#0 = aUsuario;
     |LEE 000#510=;
     |SI #510#2 = "N";
         || |MENAV "0000 Usted no tiene permiso para entrar en esta opcion";
         || nPermiso = 1;
     |FINSI;
*/

     FSalida = 3099;
|FPRC;

|PROCESO Tipo90;  |TIPO 90;
     |CIERRAT #510;
|FPRC;

|PROCESO PidePassword;
     nPermiso = 0;
     #923#0 = "";

     |PINPA #0#923;
     |PINDA #0#923;
     |ENDATOS #1#923;
     |SI FSalida = 0;
         |SI #923#0 ! "clave     ";
             nPermiso = 1;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO dsarm032;
     #dsarz010#0 = #dsarm032#0;
     |LEE 101#dsarz010.=;
     |SI FSalida = 0;
          #dsarz010#53 = #dsarm032#1;
          |GRABA 020#dsarz010.a;
          |LIBERA #dsarz010;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm032;
 #dsarm032#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, dsarm032;
|FIN;

|PROCESO Baja510;
     #510#0 = PARAMETRO;
|FPRC;

|PROCESO Alta510;
     #510#0 = PARAMETRO;
|FPRC;

|PROGRAMA;
     |SI PARAMETRO = "";
         |SI nPermiso = 1;  |ACABA;  |FINSI;

         |HAZ PidePassword;

         |SI nPermiso = 1;
             |MENAV "0000 Password erroneo.";
             |ACABA;
         |FINSI;
     |FINSI;

     |SI PARAMETRO ! "";
         #510#0 = PARAMETRO;
         |LEE 000#510=;
         |SI FSalida ! 0;
            |DDEFECTO #510;
            #510#0 = PARAMETRO;
            |GRABA 020#510n;
            |LIBERA #510;
         |FINSI;

         |VENTANA 0501, 3099, -1, 16, "Configuraci¢n Permisos Grupos";
         nVent = FSalida;

         aVent1 = -1;
         aVent2 = -1;
         aVent3 = 0;
         aVent4 = nVent;
         aVent5 = "MODAL";
         |ESPECIFICA "ESTADO_VENTANA", aVent;
     |FINSI;

     ||Primero actualizo los datos de direccion origen usando el dsarm032
     ||que es realmente el que manda y controla la direccion origen

     |BUCLE dsarm032;

     |CABEZA "Permisos Usuarios";

     |PINPA #0#510;  nPanta0 = FSalida;

     nRango = 4 + 8 + 16 + 32;
     nPos1  = 0802;
     nPos2  = 2920;

     |LEE 000#510p;

     |SI PARAMETRO = "";
         |LINEAL_SIMPLE #1#510, nRango, nPos1, nPos2, NULL, NULL, Evento510;
     |SINO;
         |LINEAL_SIMPLE #1#510, nRango, nPos1, nPos2, Baja510, Alta510, Evento510;
     |FINSI;

     nGrid = FSalida;

     |SUB_PINPA #0#922, nPanta0;
     nSubPanta = FSalida;

     |HAZ PintaSubPanta;

     |PTEC 802;  |PAUSA;

     |CONTROL_SIMPLE nPanta0, "BOTON,{{193}} Entrar Datos ", 2923, 2938, Boton1_1;
     nBoton1_1 = FSalida;

     |CONTROL_SIMPLE nPanta0, "BOTON,{{197}} Validar Datos ", 2941, 2956, Boton1_2;
     nBoton1_2 = FSalida;

     |CONTROL_SIMPLE nPanta0, "BOTON,{{199}} Quitar TODO", 2959, 2974, Boton1_3;
     nBoton1_3 = FSalida;

     |CONTROL_SIMPLE nPanta0, "BOTON,{{199}} Poner TODO", 2977, 2992, Boton1_4;
     nBoton1_4 = FSalida;

     |CONTROL_SIMPLE nSubPanta, "BOTON,Vistas por  rbol", 2023, 2038, BotonVistas;
     nBotonVistas = FSalida;

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::{{001}}Salir," + nGrid;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
         |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBoton1_1;
     |FIN_CONTROL_WINDOWS nBoton1_2;
     |FIN_CONTROL_WINDOWS nBoton1_3;
     |FIN_CONTROL_WINDOWS nBoton1_4;
     |FIN_CONTROL_WINDOWS nBotonVistas;

     |DESTRUYECONTROL nGrid;

     |SI PARAMETRO ! "";
         aVent1 = -1;
         aVent2 = -1;
         aVent3 = 0;
         aVent4 = nVent;
         aVent5 = "MODELESS";
         |ESPECIFICA "ESTADO_VENTANA", aVent;

         |FINVENTANA nVent;
     |FINSI;

     |PULSATECLA;
|FPRO;
