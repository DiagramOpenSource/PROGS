|FICHEROS;
     dsarz060 #0;        ||Este def

     dsarm001 #1;        ||Parametros

     otrodef@ #999;      ||CargaDef del dserpm09
|FIN;

|VARIABLES;
     &enNumDSerpAV = 0;

     &eaSerieAV = "";
     &enNumeroAV = 0;
     &enEmpresaAV = 0;

     &eaPathFichero = "";

     aModoCS = "";

     nUltimo = 0;
     aUsuario = "";
     nLinea = 0;
     aCien = "";
     nEmpErp = 0;
     aAplicaErp = "";
     aDefErp = "";
     aClaveErp = "";

     aErp = "";
     nSwCargaDef = 0;
     aBass = "";
     aPathErp = "";

     aComodin = "";
     nComodNum = 0;
     aDirDSERP = "";
     aDirDocs = "";
     nNumAnt = 0;
     aExtension = "";
     aSoloNombre = "";
     aFichero = "";
     aNombre = "";
     aLong = "";
     nLong = 0;
     nConta = 0;
     nCampo = 0;
     aValor = "";
     aOrigen = "";
     aDestino = "";
     nHandle = 0;


/*
     nExiste = 0;
     aMensaje = "";
     aRespuesta = "";
     aPath = "";
     aLetra = "";
     aNombre = "";
     aLong = "";
     nLong = 0;
     nConta = 0;
     nCampo = 0;
     aValor = "";
     aTipoDoc = "";
     aSerie = "";
     nNumero = 0;
     aNumero = "";


     nSwEsta = 0;
     aPathYa = "";
*/


|FIN;

|PROCESO CargaDef;
     |DBASS aBass;
     |QBF aBass;
     aErp = aBass + "dserp/def/dserpm09.mas";
     |XABRE "E", aErp, 0;
     |SI FSalida ] 0;
          |CARGA_DEF aErp, otrodef@;
          |SI FSalida = 0;
                 aPathErp = aBass + "dserp/fich/";
                 |PATH_DAT #999 aPathErp;
                 nSwCargaDef = 1;
                 |ABRE #otrodef@;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO SacaNombre;
     aNombre = "";
     aLong = aFichero % A0;
     nLong = aLong;
     |PARA nConta = nLong; |SI nConta ] 1; |HACIENDO nConta = nConta - 1;
          nCampo = (100 * nConta) + 1;
          aValor = aFichero % nCampo;
          |SI aValor ! "/"; |Y aValor ! "\";
               aNombre = aValor + aNombre;
          |SINO;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO ImportaFichero;
     |HAZ SacaNombre;

     aCien = " " * 100;
     nEmpErp = enEmpresaAV;
     aAplicaErp = "dscomer9";
     aDefErp = "agifa010";

     aClaveErp = eaSerieAV + ("000000" + enNumeroAV) % -106;
     |QBF aClaveErp;
     aClaveErp = (aClaveErp + aCien) % 199;
     aClaveErp = aClaveErp + " ";

     |DDEFECTO #otrodef@;
     #otrodef@#7 = aAplicaErp;
     #otrodef@#6 = nEmpErp;
     #otrodef@#0 = aDefErp;
     #otrodef@#1 = aClaveErp;
     #otrodef@#2 = 99;
     |LEE 000#otrodef@.];
     |SI FSalida = 0;
          |LEE 000#otrodef@.a;
     |SINO;
          |LEE 000#otrodef@.u;
     |FINSI;
     |SI FSalida = 0; |Y #otrodef@#7 = aAplicaErp; |Y #otrodef@#6 = nEmpErp;
      |Y #otrodef@#0 = aDefErp; |Y #otrodef@#1 = aClaveErp;
          nLinea = #otrodef@#2 + 1;
          |SI nLinea = 100;
               nLinea = 1;
          |FINSI;
     |SINO;
          nLinea = 1;
     |FINSI;
     |DDEFECTO #otrodef@;
     #otrodef@#7 = aAplicaErp;
     #otrodef@#6 = nEmpErp;
     #otrodef@#0 = aDefErp;
     #otrodef@#1 = aClaveErp;
     #otrodef@#2 = nLinea;
     |LEE 101#otrodef@.=;
     |SI FSalida ! 0; |GRABA 020#otrodef@.b; |FINSI;

     #otrodef@#4 = aUsuario;

     aExtension = aNombre % -103;
     |HAZ NombreFic;
     #otrodef@#3 = aSoloNombre;

     ||Dime Nombre del fichero  OK.

     |GRABA 020#otrodef@.a;
     |LIBERA #otrodef@;

     enNumDSerpAV = nLinea;

     ||Copia el documento a documentos
     aOrigen = aFichero;
     aDestino = aDirDocs + "/" + aSoloNombre;

     |SI aModoCS = "C";
          |RECIBE_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
|FPRC;

|PROCESO NombreFic;
     |DBASS aBass;
     |QBF aBass;
     aDirDSERP = aBass + "dserp/";
     aDirDocs = aDirDSERP + "documentos";
     |MKDIR aDirDocs;

     aDestino = aDirDocs + "/*";
     |_PDIR aDestino;
     nNumAnt = 0;
     |PARA; |SI FSalida = 0; |HACIENDO;
        aComodin  = aDestino % -509;
        nComodNum = aComodin;
        |SI nComodNum > nNumAnt;
            nNumAnt = nComodNum;
        |FINSI;
        |_SDIR aDestino;
     |SIGUE;
     aComodin = aDestino % -101;

     nComodNum = nNumAnt;
     |SI aComodin = "*";
        aDestino = aDirDocs + "/DOCUMENTO000000000." + aExtension;
        aSoloNombre = "DOCUMENTO000000000." + aExtension;
     |SINO;
        nComodNum = nComodNum + 1;
        aDestino  = aDirDocs + "/DOCUMENTO" + (("000000000" + nComodNum) % -109) + "." + aExtension;
        aSoloNombre = "DOCUMENTO" + (("000000000" + nComodNum) % -109) + "." + aExtension;
     |FINSI;
|FPRC;

|PROGRAMA;
     |CLS;

     |SI enEmpresaAV = 0;
          |ACABA;
     |FINSI;

     |ABRE #dsarm001;
     |DDEFECTO #dsarm001;
     |LEE 000#dsarm001.p;
     |CIERRA #dsarm001;

     |SI #dsarm001#7 = "N";
          aModoCS = "S";
     |SINO;
          aModoCS = "C";
     |FINSI;

     |SI aModoCS = "S";
          |XABRE "E", eaPathFichero, nHandle;
     |SINO;
          |XABRE "CE", eaPathFichero, nHandle;
     |FINSI;
     |SI FSalida < 0;
          |ACABA;
     |FINSI;

     aUsuario = Usuario % 810;


     |HAZ CargaDef;

     aFichero = eaPathFichero;
     |HAZ ImportaFichero;

     |SI nSwCargaDef = 1;
          |CIERRA #otrodef@;
          |DESCARGA_DEF #otrodef@;
     |FINSI;
|FPRO;
