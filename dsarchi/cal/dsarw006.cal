|FICHEROS;
     dsarw006;
     dsarw008;

     dsarz010;

     dsarm000;
     dsarm001;
     dsarm002;
     dsarm003;
     dsarm004;
     dsarm005;
     dsarm006;
     dsarm007;
     dsarm017;           ||Faxes Registro NIF
     dsarm029;           ||Plantillas AutoRelle
     dsarm034;           ||Resultado dsEscan
     dsarm035;           ||VAR. Resul. dsEscan
     dsarm036;           ||Control Integridad
     dsarm065;           ||Plantillas RellConta
     dsarm057;           ||Conf. FacturaE p/Emp

     dshim001;

     flowm006;           ||Historico

     :/basica/def/agitab99;
     :/laboral/def/nomw0003;
     :/laboral/def/labcentr;

     dsarm005@;
     referen@;
     otrodef@;
|FIN;

|VARIABLES;
     nLetra = 0;
     aLetra = "";
     aTextoActual = "";
     aAuxActual = "";
     &enEmpADConta = 0;
     &enEjeADConta = 0;
     aBaseConta = "";
     aDirConta = "";
     aDirDatos = "";
     aDef = "";
     nCampoC = 0;
     nCampoE = 0;
     nNumCampo = 0;
     nNumCampos = 0;
     nNumCampo2 = 0;
     aValorConta = "";
     aActual = "";
     aQueQuiero = "";
     aNome = "";

     &enSwPlantillaConta = 0;
     &enLibroConta = 0;
     &enDocumentoConta = 0;

     &enError = 0;
     aPrefijo = "";
     nHayEmpXSL = 0;
     nEmpresa = 0;

     nSwVuelvePedirNif = 0;             ||No he conseguido otra forma de que vaya
     &enPosicionateCampo = 0;           ||al campo libre que es obligatorio introducir

     nPosicion = 0;
     aPosicion = "";
     nTab = 0;

     aValorEntrada = "";
     aAuxQuita = "";

     aLong2 = "";
     nLong2 = 0;
     nConta = 0;

     aValorActual = "";
     aFechadsEscan = "";
     aHoradsEscan = "";
     aNomdsEscan = "";
     nCampoEstoy = 0;
     nCampoReg = 0;
     aNomPi = "";
     aCadena = "";
     nSaltoVoy = 0;

     &enModoSilencio = 0;

     ||LIBRES
     aLibre = "";
     aLibre2 = "";
     aLibre3 = "";
     aLibre4 = "";
     aLibre5 = "";
     aLibre6 = "";
     aLibre7 = "";
     aLibre8 = "";
     aLibre9 = "";
     aLibre10 = "";
     aLibre11 = "";
     aLibre12 = "";
     aLibre13 = "";
     aLibre14 = "";
     aLibre15 = "";
     aLibre16 = "";
     aLibre17 = "";
     aLibre18 = "";
     aLibre19 = "";
     aLibre20 = "";
     nSwBorraEtLibres = 0;

     ||Control de Vinculos Externos.
     &enNumRegVincuExte = 0;
     &enSwVinculosExternos = 0;
     &eaTipoVinculo = "";
     &eaValorVinculo1 = "";
     &eaValorVinculo2 = "";
     &eaValorVinculoAux = "";
     &eaPosicionateVinculo1 = "";
     &eaPosicionateVinculo2 = "";
     &enGrupoVinExte = 0;
     &enSubGrupoVinExte = 0;
     &enTipoVinExte = 0;
     aTipoVinAntes = "";
     aVinculo1Antes = "";
     aVinculo2Antes = "";

     &eaBorraCache = "";
     aBorraCache = "";

     aInicioBorra = "";
     &enModoVincula = 0;
     &enGrupoVincula = 0;
     &enSubGruVincula = 0;
     &enTipoVincula = 0;
     nGrupoReal = 0;
     nSubGruReal = 0;
     nTipoReal = 0;


     nCampoCom = 0;
     aSQL = "";
     aAuxDos = "";
     nCampoDatos = 0;
     aFichSQL = "";
     nSwHay = 0;
     nSwHayRepeSql = 0;
     nDocAhora = 0;

     aLibre1 = "";
     nSwComparaRepe = 0;

     &enNumRegFlow = 0;
     &enSituFlow = 0;
     &eaDesSituFlow = "";

     aParaIni = "";
     aTextoIni = "";
     aCarpetaCaptura = "";
     aPathDSSelect = "";

     &eaCarpetaOrigen = "";

     aFicAux = "";
     nSwVerDocPDF = 0;
     nHandleX = 0;
     aAuxPath = "";

     aUrl = "";
     aClave = "";
     aAuxNom = "";
     nSitu = 0;
     aDocHis = "";
     &enNoClonarFlow = 0;
     nLinea = 0;
     &enSwDocModificado = 0;
     nSwCefax = 0;
     &enModoModiw006 = 0;
     &enSwErrorModiw006 = 0;
     aValor = "";
     aTexto = "";
     aContenido = "";
     nContDos = 0;
     nContReal = 0;
     nPos1 = 0;
     nPos2 = 0;
     nCampo1 = 0;
     nCaracter = 0;
     nHandleEjec = 0;

     aAlfa1 = "";
     nEstoy = 0;
     nVoy = 0;
     nSwYaAvisado = 0;
     nCampoPide = 0;
     aPide = "";

     {20}aCampoObligatorio = "";
     {20}aNomCampo = "";

     aPideA1 = "";
     aPideA2 = "";
     aPideA3 = "";
     aPideA4 = "";
     aPideA5 = "";
     aPideA6 = "";
     aPideA7 = "";
     aPideA8 = "";
     aPideA9 = "";
     aPideA10 = "";
     aPideN1 = "";
     aPideN2 = "";
     aPideN3 = "";
     aPideN4 = "";
     aPideN5 = "";
     aPideF1 = "";
     aPideF2 = "";
     aPideF3 = "";
     aPideF4 = "";
     aPideF5 = "";
     aPos    = "";

     nSalto = 0;
     aBeta = "";
     nBeta = 0;
     aBusco = "";
     nSaca = 0;
     aSaca = "";
     nResto = 0;
     nPosiciona= 0;

     &enGrupoPV = 0;
     &enSubGrupoPV = 0;
     &enTipoPV = 0;
     &enMueveDoc = 0;
     aDestinoPV = "";
     aDestinoReal = "";

     &eaFicheroEscaner = "";

     {5}aPopTria  = "";
     aTria = "";

     nSwModoConsulta = 0;

     nBotonModif = 0;

     aNomFicXSL = "";
     aNomDestino = "";
     aPathDestino = "";
     aExtension = "";

     nSwCopiarOri = 0;
     &enSwIOCorrecta = 0;
     nSwEstaIntegral = 0;
     nSwEstaBasica = 0;
     aPideVolverCapturar = "";

     aProg       = "";
     aRuta       = "";
     aDirLocal = "";
     aPath          = "";
     nError         = 0;
     aLong          = "";
     nLong          = 0;
     nCarac         = 0;
     nPos           = 0;
     aCarac      = "";
     aPrograma = "";

     aAlfaAux = "";
     nSwEstaFax = 0;
     nUltimo = 0;
     aNumFax = "";
     aCif = "";
     aFax2 = "";

     nGrupo = 0;
     nSubGrupo = 0;
     nPausa    = 0;
     nTipo = 0;
     aOrigen = "";
     aDestino = "";

     nSwEsCefaxOculto = 0;
     aPideDocCarpeta = "";
     aUsuario = "";
     &eaNombreXML = "";
     aAuxVersion = "";
     aPathBase = "";
     aNombrePDF = "";
     aCaminoPDF = "";
     aOrigenFE = "";
     aDestinoFE = "";

     &eaDniFirmador = "";

     aParametro = "";
     &eaAlfa = "";
     &eaNomFirmador = "";
     &eaUnidad = "";

     aBorra = "";
     &enSwNuevoMD5 = 0;
     aEjecuta = "";
     &eaErrorFirma = "";
     &eaBaseFirmador = "";
     &eaFEOrigen = "";
     &eaFEDestino = "";

     aGuarda1 = "";
     aGuarda2 = "";
     nSwFirmaOK = 0;
     {1}aLocal = "";
     aBaseLocal = "";
     aBaseBin = "";
     aBaseDll = "";

     nSwFirmado = 0;
     aAux = "";

     nID              = 0;
     nPanta906_0      = 0;
     nVentana         = 0;
     nVentw6          = 0;
     nVentB8          = 0;
     nCampo           = 0;
     nHandle          = 0;
     nBoton1          = 0;
     nBoton2          = 0;
     nBoton3          = 0;
     nBoton4          = 0;
     nBoton5          = 0;
     nBoton6          = 0;
     nBoton7          = 0;
     nBoton8          = 0;
     nBoton9          = 0;
     nMes             = 0;
     nAnyo            = 0;
     nRango           = 0;
     nGrid            = 0;
     nEstado          = 0;
     nEventoFoco      = 0;
     nEndatos         = 0;

     fFecha           = @;

     aTecla           = "";
     aAlfa            = "";
     aFichero         = "";
     aMensaje         = "";
     aPathRemoto      = "";
     aIPRemoto        = "";
     aAbre            = "";
     aSystem          = "";
     aPideCli         = "";
     aPideNif         = "";
     aPideTra         = "";
     aPideMod         = "";
     aPideMin         = "";
     aBass            = "";
     aBase            = "";
     aMas             = "";
     aHora            = "";
     aID              = "";
     aUnidadSistema   = "";

     {-1}aVent      = "";
         aVent1     = 0;
         aVent2     = 0;
         aVent3     = 0;
         aVent4     = 0;
         aVent5     = "";

     &enDocumento     = 0;
     &eaVarDni        = "";
     &enCalcCif       = 0;
     &eaOrigen        = "";
     &eaDestino       = "";
     &enPassword      = 0;
     &eaUnidadBasico = "";
     &eaNomDef       = "";

     aNifTrab = "";

     &eaEj           = "";
     &enIdeCli       = 0;
     &eaNomCli       = "";
     &eaNifCli       = "";
     &eaCodNif       = "";
     &eaNomNif       = "";
|FIN;

|PROCESO T0C78Fw6;  |TIPO 0;
     |C_M #dsarw006#78, 0, aAlfa;
     |SI aAlfa = "N";
         #dsarw006#78 = 0;   |PINTA #dsarw006#78;
         #dsarw006#79 = "";  |PINTA #dsarw006#79;
         |ACABA;
     |FINSI;

     |SI #dsarw006#78 = 0;
         #dsarw006#79 = "Todos";  |PINTA #dsarw006#79;

         |ACABA;
     |FINSI;

     |DBASS aBass;
     aBass = aBass + "laboral/fich/";
     |PATH_DAT #labcentr#aBass#;

     |ABRE #labcentr;
     #labcentr#0 = #dsarw006#8;
     #labcentr#1 = #dsarw006#78;
     |LEE 000#labcentr.=;
     |SI FSalida ! 0;
         |MENAV "0000No existe el centro de trabajo.";
         |ERROR;
     |FINSI;
     |CIERRA #labcentr;

     #dsarw006#79 = #labcentr#2;  |PINTA #dsarw006#79;
|FPRC;

|PROCESO Baj78;
     #labcentr#0 = #dsarw006#8;
     #labcentr#1 = 001;
|FPRC;

|PROCESO Alt78;
     #labcentr#0 = #dsarw006#8;
     #labcentr#1 = 999;
|FPRC;

|PROCESO T66C78Fw6;  |TIPO 66;
     |DBASS aBass;
     aBass = aBass + "laboral/fich/";
     |PATH_DAT #labcentr#aBass#;

     |ABRE #labcentr;
     #labcentr#0 = #dsarw006#8;
     #labcentr#1 = #dsarw006#78;
     |LEE 000#labcentr.];
     |CONSULTA_F_CLAVE #1#labcentr, Baj78, Alt78;
     |SI FSalida = 0;
         #dsarw006#78 = #labcentr#1;  |PINTA #dsarw006#78;
         #dsarw006#79 = #labcentr#2;  |PINTA #dsarw006#79;
     |FINSI;
     |CIERRA #labcentr;
|FPRC;

|PROCESO QuitaHasta2Puntos;
     ||aTextoActual

     aAuxActual = "";
     aLong = aTextoActual % A0;
     nLong = aLong;
     |PARA nLetra = 1; |SI nLetra [ nLong; |HACIENDO nLetra = nLetra + 1;
          nSaca = (100 * nLetra) + 1;
          aSaca = nSaca;
          aLetra = aTextoActual % aSaca;
          |SI aLetra = ":";
               aAuxActual = aAuxActual + aLetra;
               |SAL;
          |SINO;
               aAuxActual = aAuxActual + aLetra;
          |FINSI;
     |SIGUE;
     aTextoActual = aAuxActual;
|FPRC;

|PROCESO PintaNifTrab;
     |QBF aNifTrab;
     |SI aNifTrab ! "";
          #dsarw006#75 = aNifTrab;
          |CAMPO_VISUAL #dsarw006#75, 1, "S";
          |CONTROL_SIMPLE nPanta906_0, "LABEL,{{11}}NIF", 1554, 1560, NULL;
          |PINTA #dsarw006#75;
     |SINO;
          |CAMPO_VISUAL #dsarw006#75, 1, "N";
          |CONTROL_SIMPLE nPanta906_0, "LABEL,{{11}}   ", 1554, 1560, NULL;
     |FINSI;
|FPRC;

|PROCESO Tipo0C8Fw006;  |TIPO 0;
     |C_M #dsarw006#8, 0, aPideCli;
     |SI aPideCli = "N";  |ACABA;  |FINSI;

     enIdeCli = #dsarw006#8;
     |HAZ LeeCliente;

     |SI enIdeCli = -1;
         |MENAV "0000No existe el cliente.";
         |ERROR;
         |ACABA;
     |FINSI;

     #dsarw006#10 = eaNifCli;  |PINTA #dsarw006#10;
     #dsarw006#14 = eaNomCli;  |PINTA #dsarw006#14;

     eaCodNif = #dsarw006#10;
     |HAZ LeeNifs;
     #dsarw006#41 = eaNomNif;  |PINTA #dsarw006#41;
|FPRC;

|PROCESO Tipo0C19Fw006;  |TIPO 0;
     |C_M #dsarw006#78, 1, "N";

     |SI #dsarw006#19 = 0;    |ACABA;  |FINSI;
     |SI #dsarw006#19 = 202;  |ACABA;  |FINSI;
     |SI #dsarw006#19 = 219;  |ACABA;  |FINSI;

     |SI #dsarw006#19 ! 994;
         #dsarw006#78 = 0;
         #dsarw006#79 = "";
     |SINO;
         |C_M #dsarw006#78, 1, "S";
     |FINSI;

     |PINTA #dsarw006#78;
     |PINTA #dsarw006#79;

     |SI #dsarw006#17 ! 0; |Y #dsarw006#18 ! 0;
         |ACABA;
     |FINSI;

     |ABRE #agitab99;
     #agitab99#0 = #dsarw006#19;
     |LEE 040#agitab99.=;
     |SI FSalida ! 0;  |DDEFECTO #agitab99;  |FINSI;
     |CIERRA #agitab99;

     #dsarw006#21 = #agitab99#1;   |PINTA #dsarw006#21;

     |SI #dsarw006#19 = 180;  |O #dsarw006#19 = 190;  |O #dsarw006#19 = 390;  |O #dsarw006#19 = 392;
      |O #dsarw006#19 = 184;  |O #dsarw006#19 = 193;
         #agitab99#4 = "S";
     |FINSI;

     #dsarw006#18 = 0;
     |SI #dsarw006#19 = 180;  #dsarw006#18 = 99;  |FINSI;
     |SI #dsarw006#19 = 184;  #dsarw006#18 = 99;  |FINSI;
     |SI #dsarw006#19 = 190;  #dsarw006#18 = 99;  |FINSI;
     |SI #dsarw006#19 = 193;  #dsarw006#18 = 99;  |FINSI;
     |SI #dsarw006#19 = 390;  #dsarw006#18 = 99;  |FINSI;
     |SI #dsarw006#19 = 392;  #dsarw006#18 = 99;  |FINSI;
     |SI #dsarw006#19 = 347;  #dsarw006#18 = 99;  |FINSI;

     fFecha = ~;
     aAlfa  = fFecha % -104;
     #dsarw006#17   = aAlfa;
     |SI #dsarw006#18 = 99;
         #dsarw006#17   = #dsarw006#17  - 1;
     |FINSI;

     |SI #dsarw006#18 = 99;
         |C_M #dsarw006#18, 1, "N";
         |PINTA #dsarw006#18;
         |HAZ Tipo0C18Fw006;
     |SINO;
         fFecha = ~;
         aAlfa  = fFecha % 402;   nMes  = aAlfa;
         aAlfa  = fFecha % -104;  nAnyo = aAlfa;
         |SI #agitab99#5 = "T";  |O #agitab99#5 = "C";
             |SI nMes [ 3;
                 #dsarw006#18 = 12;
                 #dsarw006#17 = nAnyo - 1;
                 |HAZ Tipo0C18Fw006;
                 |PINTA #dsarw006#18;
                 |PINTA #dsarw006#17;
                 |ACABA;
             |FINSI;

             |SI nMes [ 6;
                 #dsarw006#18 = 3;
                 #dsarw006#17 = nAnyo;
                 |HAZ Tipo0C18Fw006;
                 |PINTA #dsarw006#18;
                 |PINTA #dsarw006#17;
                 |ACABA;
             |FINSI;

             |SI nMes [ 9;
                 #dsarw006#18 = 6;
                 #dsarw006#17 = nAnyo;
                 |HAZ Tipo0C18Fw006;
                 |PINTA #dsarw006#18;
                 |PINTA #dsarw006#17;
                 |ACABA;
             |FINSI;

             |SI nMes [ 12;
                 #dsarw006#18 = 9;
                 #dsarw006#17 = nAnyo;
                 |HAZ Tipo0C18Fw006;
                 |PINTA #dsarw006#18;
                 |PINTA #dsarw006#17;
                 |ACABA;
             |FINSI;
         |FINSI;

         |SI #agitab99#5 = "A";
             #dsarw006#18 = 99;
             #dsarw006#17 = nAnyo - 1;
             |HAZ Tipo0C18Fw006;
             |PINTA #dsarw006#18;
             |PINTA #dsarw006#17;
         |FINSI;

         |SI #agitab99#5 = "M";
             |SI nMes = 1;
                 #dsarw006#18 = 12;
                 #dsarw006#17 = nAnyo - 1;
                 |HAZ Tipo0C18Fw006;
             |SINO;
                 #dsarw006#18 = nMes - 1;
                 #dsarw006#17 = nAnyo;
                 |HAZ Tipo0C18Fw006;
             |FINSI;
             |PINTA #dsarw006#18;
             |PINTA #dsarw006#17;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo0C18Fw006;  |TIPO 0;
     |SI #dsarw006#18 > 12;  |Y #dsarw006#18 < 99;
         |MENAV "0000 Periodo Erroneo.";
         |ERROR;
     |FINSI;

     |ABRE #agitab99;
     #agitab99#0 = #dsarw006#19;
     |LEE 040#agitab99.=;
     |SI FSalida ! 0;  |DDEFECTO #agitab99;  |FINSI;
     |CIERRA #agitab99;

     |SI #dsarw006#18 = 1;   #dsarw006#22 = "ENERO     ";  |FINSI;
     |SI #dsarw006#18 = 2;   #dsarw006#22 = "FEBRERO   ";  |FINSI;
     |SI #dsarw006#18 = 3;   #dsarw006#22 = "MARZO     ";  |FINSI;
     |SI #dsarw006#18 = 4;   #dsarw006#22 = "ABRIL     ";  |FINSI;
     |SI #dsarw006#18 = 5;   #dsarw006#22 = "MAYO      ";  |FINSI;
     |SI #dsarw006#18 = 6;   #dsarw006#22 = "JUNIO     ";  |FINSI;
     |SI #dsarw006#18 = 7;   #dsarw006#22 = "JULIO     ";  |FINSI;
     |SI #dsarw006#18 = 8;   #dsarw006#22 = "AGOSTO    ";  |FINSI;
     |SI #dsarw006#18 = 9;   #dsarw006#22 = "SEPTIEMBRE";  |FINSI;
     |SI #dsarw006#18 = 10;  #dsarw006#22 = "OCTUBRE   ";  |FINSI;
     |SI #dsarw006#18 = 11;  #dsarw006#22 = "NOVIEMBRE ";  |FINSI;
     |SI #dsarw006#18 = 12;  #dsarw006#22 = "DICIEMBRE ";  |FINSI;
     |SI #dsarw006#18 = 99;  #dsarw006#22 = "ANUAL     ";  |FINSI;

     |SI #dsarw006#19 = 202;  |O #dsarw006#19 = 218;
         |SI #dsarw006#18 > 3;
             |MENAV "     Introducir 1, 2 o 3";
             |ERROR;
             |ACABA;
         |FINSI;

         |SI #dsarw006#18 = 1;   #dsarw006#22 = "1 PERIODO ";  |FINSI;
         |SI #dsarw006#18 = 2;   #dsarw006#22 = "2 PERIODO ";  |FINSI;
         |SI #dsarw006#18 = 3;   #dsarw006#22 = "3 PERIODO ";  |FINSI;

         |PINTA #dsarw006#22;

         |ACABA;
     |FINSI;

     |PINTA #dsarw006#22;
     |PINTA #dsarw006#17;

     |SI #dsarw006#19 = 0;  |ACABA;  |FINSI;

     |SI #agitab99#5 = "T";
         |SI #dsarw006#18 ! 3;  |Y #dsarw006#18 ! 6;  |Y #dsarw006#18 ! 9; |Y #dsarw006#18 ! 12;
             |MENAV "     El Modelo lo tiene configurado Trimestral debe ser debe 3, 6, 9 o 12";
             |ERROR;
         |FINSI;
     |FINSI;

     |SI #agitab99#5 = "A";
         |SI #dsarw006#18 ! 99;
             |MENAV "     El Modelo lo tiene configurado Anual debe ser debe 99";
             |ERROR;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Baja303;
     #nomw0003#0 = #dsarw006#8;
     #nomw0003#1 = 1;
|FPRC;

|PROCESO Alta303;
     #nomw0003#0 = #dsarw006#8;
     #nomw0003#1 = 99999;
|FPRC;

|PROCESO Tipo66C15Fw006;  |TIPO 66;
     |ABRE #nomw0003;
     #nomw0003#0 = #dsarw006#8;
     #nomw0003#1 = #dsarw006#15;
     |LEE 000#nomw0003.=;
     |SI FSalida ! 0;  |DDEFECTO #nomw0003;  |FINSI;

     |CONSULTA_F_CLAVE #1#nomw0003, Baja303, Alta303;
     |SI FSalida = 0;
         #dsarw006#15 = #nomw0003#1;  |PINTA #dsarw006#15;
         #dsarw006#16 = #nomw0003#2;  |PINTA #dsarw006#16;
     |FINSI;
     |CIERRA #nomw0003;
|FPRC;

|PROCESO Tipo0C15Fw006;  |TIPO 0;
     aAlfa = Contenido;
     |SI aAlfa = #dsarw006#15; |ACABA; |FINSI;

     |SI #dsarw006#15 = 0;
         #dsarw006#16 = "";  |PINTA #dsarw006#16;
         aNifTrab = "";
         |HAZ PintaNifTrab;
         |ACABA;
     |FINSI;

     |ABRE #nomw0003;
     #nomw0003#0 = #dsarw006#8;
     #nomw0003#1 = #dsarw006#15;
     |LEE 000#nomw0003.=;
     |SI FSalida ! 0;
         |DDEFECTO #nomw0003;
         |MENAV "0000 Trabajador inexistente en este Cliente.";
         |ERROR;
     |FINSI;
     |CIERRA #nomw0003;

     aNifTrab = #nomw0003#7;
     |HAZ PintaNifTrab;

     #dsarw006#16 = #nomw0003#2;  |PINTA #dsarw006#16;
|FPRC;

|PROCESO Tipo6C10Fw006;  |TIPO 6;
     |C_M #dsarw006#10, 0, aPideNif;
     |SI aPideNif = "N";  |ACABA;  |FINSI;

     |HAZ ControlRelaciones;

     eaVarDni   = #dsarw006#Campo#;   |QBF eaVarDni;
     |SI eaVarDni = "";  |ACABA;  |FINSI;

     |SI FSalida = 10;
         eaVarDni   = #dsarw006#Campo#;
         enCalcCif  = 1;
         |HAZ CalculoDNI;
         #dsarw006#Campo# = eaVarDni;
         |PINTA #dsarw006#Campo#;
         |ERROR;
         |ACABA;
     |FINSI;

     eaVarDni  = #dsarw006#Campo#;
     enCalcCif = 0;
     |HAZ CalculoDNI;
     eaVarDni = (eaVarDni + "            ") % 112;
     |SI #dsarw006#Campo# ! eaVarDni;
         |CONFI "0000SEl Nif puede ser Erroneo. Desea Calcularlo.";
         |SI FSalida = 0;
             #dsarw006#Campo# = eaVarDni;  |PINTA #dsarw006#Campo#;
             |ERROR;
         |FINSI;
     |FINSI;

     #dsarw006#41 = eaNomNif; |PINTA #dsarw006#41;
|FPRC;

|PROCESO TraeLocalExeFirmar;
   |ESPECIFICA "RBASS", aLocal;
   aBaseLocal = aLocal;

   aBaseBin = aBaseLocal + "bin/";
   eaDestino = aBaseBin + "aeatfact.dll";

   enSwNuevoMD5 = 0;
   |DBASE aBase;
   |QBF aBase;
   aBaseDll = aBase + "dlls/";
   eaOrigen = aBaseDll + "aeatfact.dll";
   |HAZ EnviaFicheroConMD5;
   |SI enSwNuevoMD5 = 1;
       nError = 1;
       |PARA nCaracter = 67;  |SI nCaracter [ 90;  |HACIENDO nCaracter = nCaracter + 1;
             aUnidadSistema = &nCaracter + ":";
             aAbre   = aUnidadSistema + "\windows\system32\regsvr32.exe";
             |XABRE "EC", aAbre, nHandleEjec;
             |SI FSalida ] 0;  nError = 0;  |SAL;  |FINSI;
       |SIGUE;

       |SI nError = 0;
           aEjecuta = aUnidadSistema + "\windows\system32\regsvr32.exe " + aBaseBin + "aeatfact.dll";
           |RSYSTEM aEjecuta;
       |FINSI;
   |FINSI;

   eaDestino = aBaseBin + "dsaeatfact.exe";
   eaOrigen = aBaseDll + "dsaeatfact.exe";
   |HAZ EnviaFicheroConMD5;

   eaDestino = aBaseBin + "dsabreextension.exe";
   eaOrigen = aBaseDll + "dsabreextension.exe";
   |HAZ EnviaFicheroConMD5;
|FPRC;

|PROCESO TraeHojasEstilo;
     aAuxVersion = #dsarm005#91;
     |QBF aAuxVersion;
     |DBASE aPathBase;
     |QBF aPathBase;

     |SI aAuxVersion = "3.1";
          eaOrigen = aPathBase + "plugins/dsfacturae310.css";
     |SINO;
          |SI aAuxVersion = "3.2";
               eaOrigen = aPathBase + "plugins/dsfacturae320.css";
          |SINO;
               eaOrigen = aPathBase + "plugins/dsfacturae300.css";
          |FINSI;
     |FINSI;

     |HAZ DimeUnidad;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aPathRemoto;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aPathRemoto;
     |SI aAuxVersion = "3.1";
          eaDestino = aPathRemoto + "\dsfacturae310.css";
     |SINO;
          |SI aAuxVersion = "3.2";
               eaDestino = aPathRemoto + "\dsfacturae320.css";
          |SINO;
               eaDestino = aPathRemoto + "\dsfacturae300.css";
          |FINSI;
     |FINSI;
     |HAZ EnviaFicheroConMD5;

     nHayEmpXSL = 0;
     nEmpresa = #dsarm005#88;
     aPrefijo = "emp" + nEmpresa;
     |SI nEmpresa ! 0;
          |ABRE #dsarm057;
          |DDEFECTO #dsarm057;
          #dsarm057#0 = nEmpresa;
          |LEE 000#dsarm057.=;
          |SI FSalida = 0;
               nHayEmpXSL = 1;
               |SI #dsarm057#5 = "S";
                    |SI aAuxVersion = "3.1";
                         eaOrigen = aPathBase + "plugins/" + aPrefijo + "dscustom310.xsl";
                    |SINO;
                         |SI aAuxVersion = "3.2";
                              eaOrigen = aPathBase + "plugins/" + aPrefijo + "dscustom320.xsl";
                         |SINO;
                              eaOrigen = aPathBase + "plugins/" + aPrefijo + "dscustom300.xsl";
                         |FINSI;
                    |FINSI;
                    |XABRE "E", eaOrigen, nHandle;
                    |SI FSalida = 0;
                         |SI aAuxVersion = "3.1";
                              aNomFicXSL = aPrefijo + "dscustom310.xsl";
                         |SINO;
                              |SI aAuxVersion = "3.2";
                                   aNomFicXSL = aPrefijo + "dscustom320.xsl";
                              |SINO;
                                   aNomFicXSL = aPrefijo + "dscustom300.xsl";
                              |FINSI;
                         |FINSI;
                    |SINO;
                         |SI aAuxVersion = "3.1";
                              aNomFicXSL = "dsfacturae310.xsl";
                         |SINO;
                              |SI aAuxVersion = "3.2";
                                   aNomFicXSL = "dsfacturae320.xsl";
                              |SINO;
                                   aNomFicXSL = "dsfacturae300.xsl";
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |SINO;
                    |SI aAuxVersion = "3.1";
                         aNomFicXSL = "dsfacturae310.xsl";
                    |SINO;
                         |SI aAuxVersion = "3.2";
                              aNomFicXSL = "dsfacturae320.xsl";
                         |SINO;
                              aNomFicXSL = "dsfacturae300.xsl";
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |CIERRA #dsarm057;
     |FINSI;

     |SI nHayEmpXSL = 0;
          |SI #dsarm001#100 = "S";
               |SI aAuxVersion = "3.1";
                    eaOrigen = aPathBase + "plugins/dscustom310.xsl";
               |SINO;
                    |SI aAuxVersion = "3.2";
                         eaOrigen = aPathBase + "plugins/dscustom320.xsl";
                    |SINO;
                         eaOrigen = aPathBase + "plugins/dscustom300.xsl";
                    |FINSI;
               |FINSI;
               |XABRE "E", eaOrigen, nHandle;
               |SI FSalida = 0;
                    |SI aAuxVersion = "3.1";
                         aNomFicXSL = "dscustom310.xsl";
                    |SINO;
                         |SI aAuxVersion = "3.2";
                              aNomFicXSL = "dscustom320.xsl";
                         |SINO;
                              aNomFicXSL = "dscustom300.xsl";
                         |FINSI;
                    |FINSI;
               |SINO;
                    |SI aAuxVersion = "3.1";
                         aNomFicXSL = "dsfacturae310.xsl";
                    |SINO;
                         |SI aAuxVersion = "3.2";
                              aNomFicXSL = "dsfacturae320.xsl";
                         |SINO;
                              aNomFicXSL = "dsfacturae300.xsl";
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI aAuxVersion = "3.1";
                    aNomFicXSL = "dsfacturae310.xsl";
               |SINO;
                    |SI aAuxVersion = "3.2";
                         aNomFicXSL = "dsfacturae320.xsl";
                    |SINO;
                         aNomFicXSL = "dsfacturae300.xsl";
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     eaOrigen = aPathBase + "plugins/" + aNomFicXSL;

     aPathRemoto = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aPathRemoto;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aPathRemoto;
     |SI aAuxVersion = "3.1";
          eaDestino = aPathRemoto + "\dsfacturae310.xsl";
     |SINO;
          |SI aAuxVersion = "3.2";
               eaDestino = aPathRemoto + "\dsfacturae320.xsl";
          |SINO;
               eaDestino = aPathRemoto + "\dsfacturae300.xsl";
          |FINSI;
     |FINSI;
     |HAZ EnviaFicheroConMD5;
|FPRC;

|PROCESO TraeFirmadorXML;
     |DBASE aPathBase;
     |QBF aPathBase;
     eaOrigen = aPathBase + "dlls/firmador.exe";

     |HAZ DimeUnidad;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aPathRemoto;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aPathRemoto;
     eaDestino = aPathRemoto + "\firmador.exe";
     |HAZ EnviaFicheroConMD5;


     eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "dsabreextension.exe";
     eaOrigen = aPathBase + "dlls/dsabreextension.exe";
     |HAZ EnviaFicheroConMD5;
|FPRC;

|PROCESO PresentaDocumento;
     |XABRE "EC", eaDestino, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |HORA aHora;
     aUsuario = Usuario % 810;
     |ABRE #flowm006;
     #flowm006#0  = #dsarm005#0;
     #flowm006#1  = 99999;
     |LEE 000#flowm006.];
     |SI FSalida = 0;
          |LEE 000#flowm006.a;
     |SINO;
          |LEE 000#flowm006.u;
     |FINSI;
     |SI FSalida = 0; |Y #flowm006#0  = #dsarm005#0;
          nLinea = #flowm006#1 + 1;
          nSitu = #flowm006#2;
     |SINO;
          nSitu = 0;
          nLinea = 1;
     |FINSI;
     |DDEFECTO #flowm006;
     #flowm006#0  = #dsarm005#0;
     #flowm006#1  = nLinea;
     |LEE 101#flowm006.=;
     |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
     #flowm006#2  = nSitu;
     #flowm006#3  = ~;
     #flowm006#4  = aHora;
     #flowm006#5  = aUsuario;
     aDocHis = ("000000000" + #dsarm005#0) % -109;
     #flowm006#6  = "VISUALIZADO DOCUMENTO: " + aDocHis;

     enNumRegFlow = #flowm006#0;
     enSituFlow = #flowm006#2;
     |HAZ DimeDesFlow;
     #flowm006#7 = eaDesSituFlow;

     |GRABA 020#flowm006.a;
     |LIBERA #flowm006;
     |CIERRA #flowm006;

     aEjecuta = "START " + eaUnidad + ":\DOCUMENTOS\DSARCHI\dsabreextension ";
     aEjecuta = aEjecuta + eaDestino;
     aEjecuta = aEjecuta + " " + eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";

     aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;

     |RSYSTEM aEjecuta;

     |SI nSwModoConsulta = 0;
          aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
          |PARA;  |SI;  |HACIENDO;
                  |XABRE "EC", aAlfa, nHandle;
                  |SI FSalida ] 0;
                      |SAL;
                  |FINSI;

                  |PARA nPausa = 1; |SI nPausa < 10000; |HACIENDO nPausa = nPausa + 1;
                  |SIGUE;
                  |PULSATECLA;
          |SIGUE;
          |PULSATECLA;

          aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
          |RFBORRA aAlfa;
     |FINSI;
|FPRC;

|PROCESO Boton1;
     |SI #dsarm001#7 = "N";
          |HAZ DimeUnidad;
     |SINO;
          eaUnidad = eaUnidadBasico % 101;
     |FINSI;
     |DBASE aPathBase;
     |QBF aPathBase;

     aAuxNom = #dsarm005#9;
     |QBF aAuxNom;
     |SI aAuxNom = "-DOCUMENTOWEB-";
          eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "dsabreweb.exe";
          eaOrigen = aPathBase + "dlls/dsabreweb.exe";
          |HAZ EnviaFicheroConMD5;

          aUrl = #dsarm001#162;
          |QBF aUrl;
          |SI aUrl = "";
               aMensaje = "0000Url para llamadas Asterisk NO definido. Proceso cancelado.";
               |MENAV aMensaje;
               |ACABA;
          |FINSI;

          aClave = #dsarm005#23;
          aClave = aClave - "CLAVE: ";
          |SI FSalida = 0;
               aClave = aClave - ": ";
          |FINSI;
          |QBF aClave;

          aEjecuta = "START " + eaUnidad + ":\DOCUMENTOS\DSARCHI\dsabreweb.exe " + aUrl + aClave;
          |RSYSTEM aEjecuta;

          |ACABA;
     |FINSI;


     eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "dsabreextension.exe";
     eaOrigen = aPathBase + "dlls/dsabreextension.exe";
     |HAZ EnviaFicheroConMD5;

     |SI #dsarm005#89 = "S";
          |HAZ TraeHojasEstilo;
          |HAZ TraeFirmadorXML;
     |SINO;
          nSwFirmado = 0;
          aAux = #dsarw006#9;
          |QBF aAux;
          aAux = aAux % -104;
          |SI aAux = ".fir"; |O aAux = ".FIR";
               nSwFirmado = 1;
          |FINSI;
     |FINSI;

     |SI enMueveDoc = 1; |O enModoVincula = 1;
          aFichero = aDestinoReal;   |QBF aFichero;
     |SINO;
          aFichero = #dsarw006#7;   |QBF aFichero;
     |FINSI;

     aFicAux = #dsarm005#96;
     |QBF aFicAux;
     |SI aFicAux ! "";
          nSwVerDocPDF = 1;
     |SINO;
          nSwVerDocPDF = 0;
     |FINSI;

     |SI nSwVerDocPDF = 1;
         aAuxPath = aFichero;

         aFichero = aFichero + aFicAux;
         |SI #dsarm001#7 = "N";
               |XABRE "E", aFichero, nHandleX;
               |SI FSalida < 0;
                    nSwVerDocPDF = 0;
                    aFichero = aAuxPath + #dsarw006#9;
               |FINSI;
         |SINO;
               |XABRE "CE", aFichero, nHandleX;
               |SI FSalida < 0;
                    nSwVerDocPDF = 0;
                    aFichero = aAuxPath + #dsarw006#9;
               |FINSI;
         |FINSI;
     |SINO;
         aFichero = aFichero + #dsarw006#9;
     |FINSI;
     |QBF aFichero;

     eaOrigen  = aFichero;
     |SI nSwVerDocPDF = 1;
          eaDestino = aPathRemoto + "\" + aFicAux;
     |SINO;
          eaDestino = aPathRemoto + "\" + #dsarw006#9;
     |FINSI;
     |QBF eaDestino;

     aIPRemoto   = "";
     |IP_REMOTO aIPRemoto;

     |SI #dsarm001#7 = "N";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO eaOrigen, eaDestino;
         |SINO;
             |COPIA_FICHERO eaOrigen, eaDestino;
         |FINSI;
     |SINO;
         |SI eaOrigen ! eaDestino;
              |RCOPIA_FICHERO eaOrigen, eaDestino;
         |FINSI;
     |FINSI;

     |SI aIPRemoto = "";
         |XABRE "E", eaDestino, nHandle;
     |SINO;
         |XABRE "EC", eaDestino, nHandle;
     |FINSI;

     |SI FSalida < 0;
         aMensaje = "0000No puedo localizar el documento. Debe haber sido borrado o movido de carpeta";
         |MENAV aMensaje;
         |ACABA;
     |FINSI;

     |SI #dsarm005#89 = "N"; |Y nSwFirmado = 1;
          aGuarda1 = eaOrigen;
          aGuarda2 = eaDestino;

          |HAZ TraeLocalExeFirmar;
          nSwFirmaOK = 0;
          eaErrorFirma = "";
          eaNomFirmador = "";
          eaBaseFirmador = aBaseBin;
          |SI #dsarm001#7 = "N";
               |HAZ DimeUnidad;
               eaFEOrigen = eaUnidad + ":\documentos\dsarchi\" + #dsarw006#9;
          |SINO;
               eaFEOrigen = eaUnidadBasico + "\documentos\dsarchi\" + #dsarw006#9;
          |FINSI;
          |QBF eaFEOrigen;
          aAux = aAux % -104;
          |SI aAux = ".fir";
               eaFEDestino = eaFEOrigen - ".fir";
          |FINSI;
          |SI aAux = ".FIR";
               eaFEDestino = eaFEOrigen - ".FIR";
          |FINSI;
          |HAZ RecuperaDocFirmado;
          |SI eaErrorFirma ! "";
               aMensaje = "0000Documento Firmado." + &13;
               eaAlfa = eaErrorFirma;
               |HAZ QuitaRaros;
               eaErrorFirma = eaAlfa;
               aMensaje = aMensaje + "Error: " + eaErrorFirma;
               |MENAV aMensaje;
               |ACABA;
          |SINO;
               |SI eaNomFirmador ! "";
                    aAux = eaNomFirmador % 4;
                    aMensaje = "0000Documento Firmado." + &13;
                    aMensaje = aMensaje + "Emisor: " + aAux;
                    |MENAV aMensaje;
               |FINSI;
               nSwFirmaOK = 1;
               aGuarda2 = eaFEDestino;
          |FINSI;

          eaOrigen  = aGuarda1;
          eaDestino = aGuarda2;
     |FINSI;

     |SI #dsarm005#89 = "S";
          |SI nSwVerDocPDF = 0;
               aGuarda1 = eaOrigen;
               aGuarda2 = eaDestino;

               eaErrorFirma = "";
               eaFEOrigen = eaUnidad + ":\documentos\dsarchi\" + #dsarw006#9;
               |QBF eaFEOrigen;
               eaFEDestino = eaFEOrigen;
               eaNombreXML = #dsarw006#9;
               |QBF eaNombreXML;
               |HAZ VerificaFirmaXML;
               |SI #dsarm005#90 = "S";
                    |SI eaErrorFirma ! "";
                         aMensaje = "0000Documento Firmado." + &13;
                         eaAlfa = eaErrorFirma;
                         |HAZ QuitaRaros;
                         eaErrorFirma = eaAlfa;
                         aMensaje = aMensaje + "Error: " + eaErrorFirma;
                         |MENAV aMensaje;
                         |ACABA;
                    |SINO;
                         |SI eaNomFirmador ! "";
                              aAux = eaNomFirmador % 6;
                              aMensaje = "0000Documento Firmado." + &13;
                              aMensaje = aMensaje + aAux;
                              |MENAV aMensaje;
                         |FINSI;
                         nSwFirmaOK = 1;
                         aGuarda2 = eaFEDestino;       ||HTML
                    |FINSI;
               |SINO;
                    |SI enModoSilencio = 0;
                         aMensaje = "0000Factura Electronica NO Firmada";
                         |MENAV aMensaje;
                    |FINSI;
                    aGuarda2 = eaFEDestino;       ||HTML
               |FINSI;

               eaOrigen  = aGuarda1;
               eaDestino = aGuarda2;
          |FINSI;
     |FINSI;

     |VENTANA 0501, 2999, -1, 16, "Visualizando Documento";
     nVentw6  = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentw6;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PINPA #0#dsarw008;
     |PINDA #0#dsarw008;
     |PTEC 802;
     |PAUSA;

     |HAZ PresentaDocumento;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentw6;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentw6;

     |SI nSwFirmado = 1; |O #dsarm005#89 = "S"; |O nSwVerDocPDF = 1;
          ||nada
     |SINO;
          |SI nSwModoConsulta = 0;
               ||Solo se actualiza en modo modificacion.
               enSwIOCorrecta = 0;
               enSwDocModificado = 0;
               |HAZ RecibeConMD5;
               |SI enSwDocModificado = 1;
                    ||Historico
                    |HORA aHora;
                    aUsuario = Usuario % 810;
                    |ABRE #flowm006;
                    #flowm006#0  = #dsarm005#0;
                    #flowm006#1  = 99999;
                    |LEE 000#flowm006.];
                    |SI FSalida = 0;
                         |LEE 000#flowm006.a;
                    |SINO;
                         |LEE 000#flowm006.u;
                    |FINSI;
                    |SI FSalida = 0; |Y #flowm006#0  = #dsarm005#0;
                         nLinea = #flowm006#1 + 1;
                    |SINO;
                         nLinea = 1;
                    |FINSI;
                    |DDEFECTO #flowm006;
                    #flowm006#0  = #dsarm005#0;
                    #flowm006#1  = nLinea;
                    |LEE 101#flowm006.=;
                    |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
                    #flowm006#3  = ~;
                    #flowm006#4  = aHora;
                    #flowm006#5  = aUsuario;
                    |SI enSwIOCorrecta = 0;
                         #flowm006#6  = "MODIFICACION DOCUMENTO [ERROR]";
                    |SINO;
                         #flowm006#6  = "MODIFICACION DOCUMENTO [CORRECTO]";
                    |FINSI;

                    enNumRegFlow = #flowm006#0;
                    enSituFlow = #flowm006#2;
                    |HAZ DimeDesFlow;
                    #flowm006#7 = eaDesSituFlow;

                    |GRABA 020#flowm006.a;
                    |LIBERA #flowm006;
                    |CIERRA #flowm006;
               |FINSI;
               |SI enSwIOCorrecta = 0;
                    |MENAV "0000 Ha habido un error al transferir el documento al servidor. Revise Permisos y espacio disponible.";
                    |ACABA;
               |FINSI;

               aIPRemoto = "";
               |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

               |SI #dsarm001#7 = "N";  |Y aIPRemoto ! "";
                   |XABRE "E", eaOrigen, nHandle;
               |SINO;
                   |XABRE "EC", eaOrigen, nHandle;
               |FINSI;

               |SI FSalida < 0;
                   |MENAV "0000 Ha habido un error al transferir el documento al servidor. Intentelo de nuevo";
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Boton7;         ||Volver a Capturar
     |SI #dsarm005#89 = "S";         ||ES FACTURA-E
          aMensaje = "0000Documento procedente de FacturaE. Para volver a capturarlo, vaya a la facturacion del programa desde donde se genero.";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     aTria = "FIN";

     aPopTria1 = "-1";  || Si fuera -1 en la posicion

     aPopTria2  = 2;
     aPopTria3  = "Capturar";
     aPopTria4  = "Escanear";

     IaPopTria  = aPopTria1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopTria;
     |SI FSalida ! 0;
          IaPopTria  = aPopTria3  <-;
          IaPopTria  = IaPopTria + (FSalida - 1);

          aTria = aPopTria % 102;
     |FINSI;

     |SI aTria = "FIN";
          |ACABA;
     |FINSI;


     nSwCopiarOri = 0;
     aMensaje = "0000SDesea guardar el documento actual?";
     |CONFI aMensaje;

     |SI FSalida = 0;
          aMensaje = "0000Por favor, seleccione la carpeta donde copiar documento original";
          |MENAV aMensaje;

          ||Pedimos un browse con el directorio destino documento original
          aPathDestino = "D" + " ";
          |BROWSE aPathDestino;
          aPathDestino = (aPathDestino % 270);
          |QBF aPathDestino;
          |SI aPathDestino ! "";
               aPathDestino = aPathDestino + "/";
               nSwCopiarOri = 1;
          |SINO;
               aMensaje = "0000El documento original se perdera";
               |MENAV aMensaje;
          |FINSI;
     |FINSI;

     |SI aTria = "Es";
          |VENTANA 0501, 2999, -1, 16, aAlfa;
          nVentana = FSalida;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentana;
          aVent5 = "MODAL";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          eaFicheroEscaner = "";
          |SUB_EJECUTA_NP "dsarz001;VOLVERESCANEAR";

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentana;
          aVent5 = "MODELESS";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |FINVENTANA nVentana;

          |PULSATECLA;

          |QBF eaFicheroEscaner;
          |SI eaFicheroEscaner = "";
               aMensaje = "0000Proceso cancelado. No se ha escaneado ningun documento";
               |MENAV aMensaje;
               |ACABA;
          |FINSI;

          aAlfa    = eaFicheroEscaner;
          aFichero = "";
          aLong    = aAlfa % 0;
          nLong    = aLong;
          aRuta    = "";
          |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
                nPos   = (nCarac * 100) + 1;
                aCarac =  aAlfa % nPos;
                |SI aCarac = "/";  |O aCarac = "\";
                    aProg = "";
                |SINO;
                    aProg = aProg + aCarac;
                |FINSI;

                aRuta = aRuta + aCarac;
          |SIGUE;
     |SINO;
          aMensaje = "0000Por favor seleccione el nuevo documento a guardar.";
          |MENAV aMensaje;

          aRuta    = "";

          |HAZ Traete_dsselect;

          |ESPECIFICA "RBASS", aLocal;
          aDirLocal = aLocal;

          |HAZ DimeUnidad;
          aAux = eaUnidad + ":\DOCUMENTOS\DSARCHI\";
          aPrograma = aAux + "dsselect.exe";

          aPathDSSelect = aAux;

          aBorra = aPathDSSelect + "dsselect.txt";
          |RFBORRA aBorra;

          aParaIni = aAux + "dsselect.ini";
          |RFBORRA aParaIni;

          |ABRE #dsarm000;
          #dsarm000#0 = Usuario % 810;
          |LEE 000#dsarm000.=;
          |SI FSalida ! 0;
               |DDEFECTO #dsarm000;
          |FINSI;
          aCarpetaCaptura = #dsarm000#17;
          |QBF aCarpetaCaptura;
          |SI aCarpetaCaptura = "";
               aCarpetaCaptura = eaUnidadBasico;
          |FINSI;
          |CIERRA #dsarm000;

          aTextoIni = &34 + aCarpetaCaptura + &34 + " " + &34 + aBorra + &34;
          |XABRE "CW", aParaIni, nHandle;
          |SI FSalida ] 0;
               |XGRABA nHandle, aTextoIni;
          |FINSI;
          |XCIERRA nHandle;

          aEjecuta = aPrograma;
          |RSYSTEM aEjecuta;

          aAbre = aPathDSSelect + "dsselect.txt";
          |XABRE "CU", aAbre, nHandle;
          |SI FSalida < 0;
               aPath = "";
               nError = 1;
               |ACABA;
          |SINO;
               |XLEE nHandle, 250, aPath;
               |SI FSalida < 0
                    nError = 1;
               |SINO;
                    |QBF aPath;
                    |SI aPath ! "";
                         aAlfa    = aPath;
                         aFichero = "";
                         aLong    = aAlfa % 0;
                         nLong    = aLong;
                         aRuta    = "";
                         |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
                               nPos   = (nCarac * 100) + 1;
                               aCarac =  aAlfa % nPos;
                               |SI aCarac = "/";  |O aCarac = "\";
                                   aProg = "";
                               |SINO;
                                   aProg = aProg + aCarac;
                               |FINSI;

                               aRuta = aRuta + aCarac;
                         |SIGUE;
                    |FINSI;
               |FINSI;
          |FINSI;
          |XCIERRA nHandle;
          aBorra = aPathDSSelect + "dsselect.txt";
          |RFBORRA aBorra;
     |FINSI;

     |SI aRuta ! ""; |Y aProg ! "";
          |SI nSwCopiarOri = 1;
               eaOrigen = #dsarw006#7;
               |QBF eaOrigen;
               eaOrigen = eaOrigen + #dsarw006#9;
               |QBF eaOrigen;

               aNomDestino = #dsarw006#54;
               |QBF aNomDestino;
               |SI aNomDestino = "";
                    aNomDestino = #dsarw006#9;
                    |QBF aNomDestino;
               |FINSI;
               eaDestino = aPathDestino + aNomDestino;

               |SI #dsarm001#7 = "N";
                   aIPRemoto   = "";
                   |IP_REMOTO aIPRemoto;
                   |QBF aIPRemoto;
                   |SI aIPRemoto ! "";
                       |ENVIA_FICHERO eaOrigen, eaDestino;
                   |SINO;
                       |COPIA_FICHERO eaOrigen, eaDestino;
                   |FINSI;
               |SINO;
                   |SI eaOrigen ! eaDestino;
                        |RCOPIA_FICHERO eaOrigen, eaDestino;
                   |FINSI;
               |FINSI;
          |FINSI;

          aExtension = (aRuta % -104) > "";
          aAlfa1 = aExtension % 101;
          |SI aAlfa1 ! ".";
              aExtension = (aRuta % -105) > "";
          |FINSI;

          aNomDestino = ("000000000" + #dsarw006#0) % -109;
          aNomDestino = aNomDestino + aExtension;

          eaOrigen = aRuta;
          eaDestino = #dsarw006#7;
          |QBF eaDestino;
          eaDestino = eaDestino + aNomDestino;
          |QBF eaDestino;

          |IP_REMOTO aIPRemoto;
          |QBF aIPRemoto;

          |SI #dsarm001#7 = "S";
             |SI eaOrigen ! eaDestino;
                  |RCOPIA_FICHERO eaOrigen, eaDestino;
             |FINSI;
          |SINO;
             |SI aIPRemoto ! "";
                 |RECIBE_FICHERO eaOrigen, eaDestino;
             |SINO;
                 |COPIA_FICHERO eaOrigen, eaDestino;
             |FINSI;
          |FINSI;

          |HAZ DimeUnidad;
          aPathRemoto = eaUnidad + ":\DOCUMENTOS";
          |RMKDIR aPathRemoto;
          aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI\";
          |RMKDIR aPathRemoto;
          eaDestino = aPathRemoto + aNomDestino;
          |QBF eaDestino;
          |SI eaOrigen ! eaDestino;
               |RCOPIA_FICHERO eaOrigen, eaDestino;
          |FINSI;

          #dsarw006#9 = aNomDestino;
          |PINTA #dsarw006#9;
          |SI aProg ! "";
               #dsarw006#54 = aProg;
               |PINTA #dsarw006#54;
          |FINSI;
     |SINO;
          aMensaje = "0000Proceso cancelado. No se ha seleccionado Documento";
          |MENAV aMensaje;
     |FINSI;
|FPRC;

|PROCESO Boton5;
     |VENTANA 0501, 2999, -1, 16, "Documentos Asociados";
     nVentw6  = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentw6;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     enNoClonarFlow = 1;
     enDocumento = #dsarw006#0;
     |SUB_EJECUTA_NP "dsarz006";
     enNoClonarFlow = 0;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentw6;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentw6;
|FPRC;


|PROCESO Boton6;         ||Firmar electronicamente.
     aAux = #dsarw006#9;
     |QBF aAux;
     aAux = aAux % -104;
     |SI aAux ! ".fir"; |Y aAux ! ".FIR";
          aMensaje = "0000N¿Esta seguro de firmar electronicamente el documento?";
          |CONFI aMensaje;
          |SI FSalida = 0;
               aMensaje = "0000Proceso de Firma";
               aCaminoPDF = #dsarw006#7;
               |QBF aCaminoPDF;
               aOrigenFE = aCaminoPDF;
               |QBF aOrigenFE;
               aNombrePDF = #dsarw006#9;
               |QBF aNombrePDF;
               aOrigenFE = aOrigenFE + aNombrePDF;
               |QBF aOrigenFE;
               |SI #dsarm001#7 = "N";
                   |HAZ DimeUnidad;
                    aDestinoFE = eaUnidad + ":\DOCUMENTOS\";              |RMKDIR aDestinoFE;
                    aDestinoFE = eaUnidad + ":\DOCUMENTOS\DSARCHI\";      |RMKDIR aDestinoFE;
               |SINO;
                    aDestinoFE = eaUnidadBasico + "\DOCUMENTOS\";              |RMKDIR aDestinoFE;
                    aDestinoFE = eaUnidadBasico + "\DOCUMENTOS\DSARCHI\";      |RMKDIR aDestinoFE;
               |FINSI;
               aDestinoFE = aDestinoFE + aNombrePDF;
               |QBF aDestinoFE;

               aIPRemoto   = "";
               |IP_REMOTO aIPRemoto;

               |SI #dsarm001#7 = "S";
                   |RCOPIA_FICHERO aOrigenFE, aDestinoFE;
               |SINO;
                   |SI aIPRemoto ! "";
                       |ENVIA_FICHERO aOrigenFE, aDestinoFE;
                   |SINO;
                       |COPIA_FICHERO aOrigenFE, aDestinoFE;
                   |FINSI;
               |FINSI;

               |HAZ LaFirma;
               |SI nSwFirmaOK = 1;
                   |SI #dsarm001#7 = "N";
                       |HAZ DimeUnidad;
                       aOrigenFE = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + aNombrePDF;
                   |SINO;
                       aOrigenFE = eaUnidadBasico + "\DOCUMENTOS\DSARCHI\" + aNombrePDF;
                   |FINSI;
                   aDestinoFE = aCaminoPDF + aNombrePDF;

                   |SI #dsarm001#7 = "S";
                      |RCOPIA_FICHERO aOrigenFE, aDestinoFE;
                   |SINO;
                      |SI aIPRemoto ! "";
                          |RECIBE_FICHERO aOrigenFE, aDestinoFE;
                      |SINO;
                          |COPIA_FICHERO aOrigenFE, aDestinoFE;
                      |FINSI;

                      aOrigenFE = aOrigenFE - ".fir";
                  |FINSI;
                  ||Actualiza datos del registro documentos (dsarm005)
                  #dsarw006#9 = aNombrePDF;
                  |PINTA #dsarw006#9;
               |FINSI;
          |FINSI;
     |SINO;
          aMensaje = "0000Documento YA firmado";
          |MENAV aMensaje;
     |FINSI;
|FPRC;


|PROCESO LaFirma;
   |HAZ TraeLocalExeFirmar;

   nSwFirmaOK = 0;
   eaErrorFirma = "";
   eaBaseFirmador = aBaseBin;
   |SI #dsarm001#7 = "N";
        |HAZ DimeUnidad;
        eaFEOrigen = eaUnidad + ":\documentos\dsarchi\" + aNombrePDF;
   |SINO;
        eaFEOrigen = eaUnidadBasico + "\documentos\dsarchi\" + aNombrePDF;
   |FINSI;

   eaFEDestino = eaFEOrigen + ".fir";

   eaDniFirmador = #dsarm001#27;
   |QBF eaDniFirmador;
   |SI eaDniFirmador ! "";
          |HAZ FirmaDocumento;
          |SI eaErrorFirma ! "";
               eaAlfa = eaErrorFirma;
               |HAZ QuitaRaros;
               eaErrorFirma = eaAlfa;
               aMensaje = "0000Error: " + eaErrorFirma;
               |QBF aMensaje;
               aMensaje = aMensaje + &13 + "El documento se quedara sin firmar.";
               |MENAV aMensaje;
          |SINO;
               nSwFirmaOK = 1;
               aNombrePDF = aNombrePDF + ".fir";
          |FINSI;
   |FINSI;
|FPRC;

||ARA99
|PROCESO VerifLibres;
     nContDos = nContDos + 1;
     aAux = #dsarm004#nCampo#;
     |QBF aAux;
     |SI aAux ! "";
          nContReal = nContReal + 1;

          |SI nContDos < 6;
               nCampoCom = nCampo + 30;
          |SINO;
               |SI nContDos < 11;
                    nCampoCom = nCampo + 13;
               |SINO;
                    nCampoCom = nCampo + 35;
               |FINSI;
          |FINSI;

          aAuxDos = #dsarm004#nCampoCom#;
          |SI aAuxDos = "S";
               |SI nContReal < 16;
                    nCampo1 = 22 + nContReal;
               |SINO;
                    nCampo1 = 44 + nContReal;
               |FINSI;

               aTexto = aAux;
               |QBF aTexto;

               |SI aLibre1 = "";
                    aLibre1 = aTexto;
               |SINO;
                    aLibre1 = aLibre1 + " " + aTexto;
               |FINSI;

               aTexto = aTexto + ": ";

               nCampoDatos = 54 + nContDos;
               aTexto = aTexto + #dsarw006#nCampoDatos#;
               |QBF aTexto;

               aSQL  = aSQL + " AND " + nCampo1 + " == " + aTexto;
               |QBF aSQL;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ResultadoSQL;
     |SI #dsarm005@#0 ! nDocAhora;
          nSwHayRepeSql = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE ResultadoSQL;
 #dsarm005@#1001;
 ;
 000000001;
 999999999;
 ;
 NULL, ResultadoSQL;
|FIN;

|PROCESO ComparaCamposRepe;
     nSwHay = 0;

     |PARA nCampo = 35; |SI nCampo [ 54; |HACIENDO nCampo = nCampo + 1;
          aAux = #dsarm004#nCampo#;
          |QBF aAux;
          |SI aAux = "S";
               nSwHay = 1;
               |SAL;
          |FINSI;
     |SIGUE;

     |SI nSwHay = 0;
          aAux = #dsarm004#82; |SI aAux = "S"; nSwHay = 1; |FINSI;
          aAux = #dsarm004#83; |SI aAux = "S"; nSwHay = 1; |FINSI;
          aAux = #dsarm004#84; |SI aAux = "S"; nSwHay = 1; |FINSI;
     |FINSI;

     |SI nSwHay = 0;
          |ACABA;
     |FINSI;

     aFichSQL = ("CC" + Usuario) % 108;

     aSQL  = "SELECT * FROM dsarm005 INTO " + aFichSQL + " WHERE ";

     aSQL  = aSQL + "1 == " + #dsarw006#1;
     aSQL  = aSQL + " AND 2 == " + #dsarw006#2;
     aSQL  = aSQL + " AND 3 == " + #dsarw006#3;


     nContReal = 0;
     nContDos = 0;
     |PARA nCampo = 5;  |SI nCampo [ 9;  |HACIENDO nCampo = nCampo + 1;
          |HAZ VerifLibres;
     |SIGUE;
     |PARA nCampo = 27;  |SI nCampo [ 31;  |HACIENDO nCampo = nCampo + 1;
          |HAZ VerifLibres;
     |SIGUE;
     |PARA nCampo = 10;  |SI nCampo [ 19;  |HACIENDO nCampo = nCampo + 1;
          |HAZ VerifLibres;
     |SIGUE;

     aAux = #dsarm004#82;
     |SI aAux = "S";
          aTexto = "COD.CLIENTE";
          |SI aLibre1 = "";
               aLibre1 = aTexto;
          |SINO;
               aLibre1 = aLibre1 + " " + aTexto;
          |FINSI;

          aSQL  = aSQL + " AND " + 8 + " == " + #dsarw006#8;
          |QBF aSQL;
     |FINSI;

     aAux = #dsarm004#83;
     |SI aAux = "S";
          aTexto = "NIF";
          |SI aLibre1 = "";
               aLibre1 = aTexto;
          |SINO;
               aLibre1 = aLibre1 + " " + aTexto;
          |FINSI;

          aSQL  = aSQL + " AND " + 10 + " == " + #dsarw006#10;
          |QBF aSQL;
     |FINSI;

     aAux = #dsarm004#84;
     |SI aAux = "S";
          aTexto = "COD.TRABAJADOR";
          |SI aLibre1 = "";
               aLibre1 = aTexto;
          |SINO;
               aLibre1 = aLibre1 + " " + aTexto;
          |FINSI;

          aSQL  = aSQL + " AND " + 15 + " == " + #dsarw006#15;
          |QBF aSQL;
     |FINSI;

     aMensaje = "0000SQL:" + aSQL;
     |SQL aSQL;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/dsarm005.mas";
     |CARGA_DEF aMas, dsarm005@;

     |NOME_DAT #dsarm005@#aFichSQL#;
     |ABRE #dsarm005@;
     nSwHayRepeSql = 0;
     |BUCLE ResultadoSQL;
     |SI nSwHayRepeSql = 1;
         nSwComparaRepe = 1;
     |FINSI;
     |CIERRA #dsarm005@;
     |DELINDEX #dsarm005@;
     |DESCARGA_DEF #dsarm005@;
|FPRC;

|PROCESO Tipo12;  |TIPO 12;
     |SI FSalida = 1; |O FSalida = -32001;
          nSwYaAvisado = 0;
          nError = 0;
          |SI aPideCli = "S";
              |SI #dsarw006#8 = 0;
                   |SI nSwYaAvisado = 0;
                         aMensaje = "0000Atenci¢n, campo <Codigo Cliente> obligatorio. Introduzca valor.";
                         |MENAV aMensaje;
                         nSwYaAvisado = 1;
                   |FINSI;
                   nError = 1;
              |FINSI;
          |FINSI;

          |SI aPideNif = "S";
              |SI #dsarw006#10 = "            ";
                   |SI nSwYaAvisado = 0;
                         aMensaje = "0000Atenci¢n, campo <NIF> obligatorio. Introduzca valor.";
                         |MENAV aMensaje;
                         nSwYaAvisado = 1;
                   |FINSI;
                   nError = 1;
              |FINSI;
          |FINSI;

          |SI aPideTra = "S";
              |SI #dsarw006#15 = 0;
                   |SI nSwYaAvisado = 0;
                         aMensaje = "0000Atenci¢n, campo <Trabajador> obligatorio. Introduzca valor.";
                         |MENAV aMensaje;
                         nSwYaAvisado = 1;
                   |FINSI;
                   nError = 1;
              |FINSI;
          |FINSI;

          |SI aPideMod = "S";
              |SI #dsarw006#19 = 0;
                   |SI nSwYaAvisado = 0;
                         aMensaje = "0000Atenci¢n, campo <Modelo> obligatorio. Introduzca valor.";
                         |MENAV aMensaje;
                         nSwYaAvisado = 1;
                   |FINSI;
                   nError = 1;
              |FINSI;
              |SI #dsarw006#17 = 0;
                   |SI nSwYaAvisado = 0;
                         aMensaje = "0000Atenci¢n, campo <Ejercicio> obligatorio. Introduzca valor.";
                         |MENAV aMensaje;
                         nSwYaAvisado = 1;
                   |FINSI;
                   nError = 1;
              |FINSI;
              |SI #dsarw006#18 = 0;
                   |SI nSwYaAvisado = 0;
                         aMensaje = "0000Atenci¢n, campo <Periodo> obligatorio. Introduzca valor.";
                         |MENAV aMensaje;
                         nSwYaAvisado = 1;
                   |FINSI;
                   nError = 1;
              |FINSI;
          |FINSI;

          |PARA nVoy = 1; |SI nVoy [ 20; |HACIENDO nVoy = nVoy + 1;
               nSalto = 54 + nVoy;

               IaCampoObligatorio = aCampoObligatorio1<-;
               IaCampoObligatorio = IaCampoObligatorio + nVoy - 1;
               aPide = aCampoObligatorio;
               |SI aPide = "S";
                    aAux = #dsarw006#nSalto#;
                    |QBF aAux;
                    IaNomCampo = aNomCampo1<-;
                    IaNomCampo = IaNomCampo + nVoy - 1;
                    aAlfa = aNomCampo;
                    aAlfa = aAlfa + ":";
                    aBeta = aAux - aAlfa;
                    |QBF aBeta;
                    |SI nVoy [ 10;
                         |SI aBeta = "";
                              |SI nSwYaAvisado = 0;
                                   aMensaje = "0000Atenci¢n, campo <" + aNomCampo;
                                   |QBF aMensaje;
                                   aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                                   |MENAV aMensaje;
                                   nSwYaAvisado = 1;
                              |FINSI;
                              nError = 1;
                         |FINSI;
                    |SINO;
                         |SI nVoy [ 15;
                              nBeta = aBeta;
                              |SI nBeta = 0;
                                   |SI nSwYaAvisado = 0;
                                        aMensaje = "0000Atenci¢n, campo <" + aNomCampo;
                                        |QBF aMensaje;
                                        aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                                        |MENAV aMensaje;
                                        nSwYaAvisado = 1;
                                   |FINSI;
                                   nError = 1;
                              |FINSI;
                         |SINO;
                              |SI aBeta = "01.01.0000";
                                   |SI nSwYaAvisado = 0;
                                        aMensaje = "0000Atenci¢n, campo <" + aNomCampo;
                                        |QBF aMensaje;
                                        aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                                        |MENAV aMensaje;
                                        nSwYaAvisado = 1;
                                   |FINSI;
                                   nError = 1;
                              |FINSI;
                         |FINSI;
                    |FINSI;

               |FINSI;
          |SIGUE;

          |SI nError = 0;
               ||Se basa en el codigo ComparaCamposRepe del dsarz001
               nDocAhora = #dsarw006#0;
               aLibre1 = "";
               nSwComparaRepe = 0;
               |HAZ ComparaCamposRepe;
               |SI nSwComparaRepe = 1;
                    aLibre1 = aLibre1 % 180;
                    |QBF aLibre1;
                    aMensaje = "0000Atenci¢n: Control campos repetidos [" + aLibre1 + "]";
                    |MENAV aMensaje;
                    nError = 1;
                    nSwYaAvisado = 1;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nError = 1;
          nSwYaAvisado = 0;
          nError = 0;
          |ERROR;
     |FINSI;
|FPRC;


|PROCESO MiraCefaxOculto;
     |SI #dsarw006#1 = #dsarm001#89; |Y #dsarw006#2 = #dsarm001#90; |Y #dsarw006#3 = #dsarm001#91;
          nSwEsCefaxOculto = 1;
     |FINSI;
|FPRC;

|PROCESO dsarm017;
     aFax2 = #dsarm017#2;
     |SI aFax2 = aNumFax;
          nSwEstaFax = 1;
     |FINSI;
     nUltimo = #dsarm017#1;
|FPRC;

|DEFBUCLE dsarm017;
 #dsarm017#1;
 ;
 aCif, 001;
 aCif, 999;
 ;
 NULL, dsarm017;
|FIN;

|PROCESO EstaIntegral;
     |DBASS aBase;
     aMas = aBase + "/integral/def/dsam0000.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida < 0;
          nSwEstaIntegral = 0;
     |SINO;
          nSwEstaIntegral = 1;
     |FINSI;
|FPRC;

|PROCESO EstaBasica;
     |DBASS aBase;
     aMas = aBase + "/basica/def/agifigen.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida < 0;
          nSwEstaBasica = 0;
     |SINO;
          nSwEstaBasica = 1;
     |FINSI;
|FPRC;

|PROCESO BotonModif;
     |SI #dsarm004#34 = "N"; |ACABA; |FINSI;
     |SI #dsarm004#34 = "P";
         |HAZ PidePassword;
         |SI enPassword = 1;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI aPideVolverCapturar = "S";
          |ESTADO_CONTROL nBoton7, "ENABLE";
     |SINO;
          |ESTADO_CONTROL nBoton7, "DISABLE";
     |FINSI;

     |ESTADO_CONTROL nBotonModif, "DISABLE";

     |PTEC 806;

     nSwModoConsulta = 0;
|FPRC;


|PROCESO ControlCefaxOculto;
     nSwEsCefaxOculto = 0;
     |HAZ MiraCefaxOculto;
     |SI nSwEsCefaxOculto = 1;
          aMensaje = "0000NMover a carpeta CEFAX?";
          |CONFI aMensaje;
          |SI FSalida = 0;
                 nGrupo = #dsarm001#67;
                 nSubGrupo = #dsarm001#68;
                 nTipo = #dsarm001#69;

                 aFichero = #dsarw006#7;
                 |QBF aFichero;
                 aFichero = aFichero + #dsarw006#9;
                 |QBF aFichero;
                 aOrigen  = aFichero;

                 aDestino = #dsarm001#1;
                 |QBF aDestino;
                 |ABRE #dsarm002;
                 |DDEFECTO #dsarm002;
                 #dsarm002#0 = nGrupo;
                 |LEE 000#dsarm002.=;
                 |SI FSalida = 0;
                      aDestino = aDestino + "/" + #dsarm002#2;
                      |QBF aDestino;
                      |SI #dsarm001#7 = "N";
                           |MKDIR aDestino;
                      |SINO;
                           |RMKDIR aDestino;
                      |FINSI;
                 |FINSI;
                 |CIERRA #dsarm002;

                 |SI #dsarm001#8 = "S";
                      |ABRE #dsarm003;
                      |DDEFECTO #dsarm003;
                      #dsarm003#0 = nGrupo;
                      #dsarm003#1 = nSubGrupo;
                      |LEE 000#dsarm003.=;
                      |SI FSalida = 0;
                           aDestino = aDestino + "/" + #dsarm003#3;
                           |QBF aDestino;
                           |SI #dsarm001#7 = "N";
                                |MKDIR aDestino;
                           |SINO;
                                |RMKDIR aDestino;
                           |FINSI;
                      |FINSI;
                      |CIERRA #dsarm003;
                      |ABRE #dsarm004;
                      |DDEFECTO #dsarm004;
                      #dsarm004#0 = nGrupo;
                      #dsarm004#1 = nSubGrupo;
                      #dsarm004#2 = nTipo;
                      |LEE 000#dsarm004.=;
                      |SI FSalida = 0;
                           aDestino = aDestino + "/" + #dsarm004#4;
                           |QBF aDestino;
                           |SI #dsarm001#7 = "N";
                                |MKDIR aDestino;
                           |SINO;
                                |RMKDIR aDestino;
                           |FINSI;
                      |FINSI;
                      |CIERRA #dsarm004;
                 |SINO;
                      |ABRE #dsarm004;
                      |DDEFECTO #dsarm004;
                      #dsarm004#0 = nGrupo;
                      #dsarm004#1 = 1;
                      #dsarm004#2 = 1;
                      |LEE 000#dsarm004.=;
                      |CIERRA #dsarm004;
                 |FINSI;

                 aDestino = aDestino + "/";
                 #dsarw006#7 = aDestino;

                 aDestino = aDestino + #dsarw006#9;
                 |QBF aDestino;

                 |SI #dsarm001#7 = "N";
                      |RENOMBRA_FICHERO aOrigen, aDestino;
                 |SINO;
                      |RRENOMBRA_FICHERO aOrigen, aDestino;
                 |FINSI;

                 #dsarw006#1 = nGrupo;
                 #dsarw006#2 = nSubGrupo;
                 #dsarw006#3 = nTipo;

                 aNumFax = #dsarw006#26;
                 |QBF aNumFax;
                 aAlfaAux = #dsarm004#8;
                 |QBF aAlfaAux;
                 aNumFax = aNumFax - aAlfaAux;
                 aAlfaAux = aAlfaAux + ":";
                 aNumFax = aNumFax - aAlfaAux;
                 aNumFax = aNumFax - ":";
                 |QBT aNumFax;
                 aCif = #dsarw006#10;
                 |QBF aCif;
                 |SI aCif ! ""; |Y aNumFax ! "";
                      nSwEstaFax = 0;
                      nUltimo = 0;
                      |BUCLE dsarm017;
                      |SI nSwEstaFax = 0;
                           |ABRE #dsarm017;
                           nUltimo = nUltimo + 1;
                           |DDEFECTO #dsarm017;
                           #dsarm017#0 = aCif;
                           #dsarm017#1 = nUltimo;
                           |LEE 101#dsarm017.=;
                           |SI FSalida ! 0;
                                #dsarm017#2 = aNumFax;
                                |GRABA 020#dsarm017.n;
                                |LIBERA #dsarm017;

                                aMensaje = "0000Se ha vinculado el Num.Fax " + aNumFax + " al NIF/CIF " + aCif;
                                |MENAV aMensaje;
                           |FINSI;
                           |CIERRA #dsarm017;
                      |FINSI;
                 |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO RellenaArray;
     nCampoPide = 55 + nEstoy;
     aPide = #dsarm004#nCampoPide#;
     IaCampoObligatorio = aCampoObligatorio1<-;
     IaCampoObligatorio = IaCampoObligatorio + nVoy;
     aCampoObligatorio = aPide;

     IaNomCampo = aNomCampo1<-;
     IaNomCampo = IaNomCampo + nVoy;
     aNomCampo = aAux;

     nVoy = nVoy + 1;
|FPRC;

|PROCESO GrabaCampos;
     nContDos = nContDos + 1;
     aAux = #dsarm004#nCampo#;
     |QBF aAux;
     |SI aAux ! "";
          nContReal = nContReal + 1;

          |SI nContReal < 16;
               nCampo1 = 22 + nContReal;
          |SINO;
               nCampo1 = 44 + nContReal;
          |FINSI;

          aTexto = aAux;
          |QBF aTexto;
          aTexto = aTexto + ": ";
          nSalto = 54 + nContDos;
          aTexto = aTexto + #dsarw006#nSalto#;

          #dsarm005#nCampo1# = aTexto;
     |FINSI;
|FPRC;

|PROCESO PonerCampos;
     nContReal = nContReal + 1;

     |SI nContReal < 16;
         nCampo1 = 22 + nContReal;
     |SINO;
         nCampo1 = 33 + nContReal;
     |FINSI;

     |C_P #dsarw006#nCampo1#, 1, nPos1;
     |C_V #dsarw006#nCampo1#, 1, "S";
     |C_M #dsarw006#nCampo1#, 1, "N";

     aValor = #dsarw006#nCampo1#;
     aContenido = aValor - aAux - ":" - " ";
     |SI nContDos ] 16;
         |QBF aContenido;
         |SI aContenido = "";
             aContenido = "01.01.0000";
         |FINSI;
     |FINSI;

     #dsarw006#nCampo1# = aAux + ":";

     nCampo1 = 54 + nContDos;
     |C_P #dsarw006#nCampo1#, 1, nPos2;
     |C_V #dsarw006#nCampo1#, 1, "S";
     |C_M #dsarw006#nCampo1#, 1, "S";
     #dsarw006#nCampo1# = aContenido;
|FPRC;

|PROCESO CalculaPanta;
     ||Primero TODOS como NO visualizables y NO modificables.
     |PARA nCampo = 23;  |SI nCampo [ 37;  |HACIENDO nCampo = nCampo + 1;
           |C_V #dsarw006#nCampo#, 1, "N";
           |C_M #dsarw006#nCampo#, 1, "N";
     |SIGUE;
     |PARA nCampo = 49;  |SI nCampo [ 53;  |HACIENDO nCampo = nCampo + 1;
           |C_V #dsarw006#nCampo#, 1, "N";
           |C_M #dsarw006#nCampo#, 1, "N";
     |SIGUE;

     |PARA nCampo = 55;  |SI nCampo [ 74;  |HACIENDO nCampo = nCampo + 1;
           |C_V #dsarw006#nCampo#, 1, "N";
           |C_M #dsarw006#nCampo#, 1, "N";
     |SIGUE;

     nPos1 = 2102;
     nPos2 = 2135;

     nContDos  = 0;
     nContReal = 0;
     |PARA nCampo = 5;  |SI nCampo [ 9;  |HACIENDO nCampo = nCampo + 1;
           nContDos  = nContDos + 1;

           aAux = #dsarm004#nCampo#;
           |QBF aAux;
           |SI aAux ! "";
               nPos1 = nPos1 + 100;
               nPos2 = nPos2 + 100;

               |HAZ PonerCampos;
           |FINSI;
     |SIGUE;

     |PARA nCampo = 27;  |SI nCampo [ 31;  |HACIENDO nCampo = nCampo + 1;
           nContDos  = nContDos + 1;

           aAux = #dsarm004#nCampo#;
           |QBF aAux;
           |SI aAux ! "";
               nPos1 = nPos1 + 100;
               nPos2 = nPos2 + 100;

               |HAZ PonerCampos;
           |FINSI;
     |SIGUE;

     aPos   = nPos1;
     aPos   = ("0000" + aPos) % -0302;
     nLinea = aPos;

     nPosiciona = 0;

     |PARA nCampo = 10;  |SI nCampo [ 19;  |HACIENDO nCampo = nCampo + 1;
           nContDos  = nContDos + 1;

           aAux = #dsarm004#nCampo#;
           |QBF aAux;
           |SI aAux ! "";
               nPosiciona = nPosiciona + 1;

               nResto = nPosiciona $ 2;
               |SI nResto ! 0;
                   nLinea = nLinea + 1;
                   nPos1  = (nLinea * 100) + 2;
                   nPos2  = (nLinea * 100) + 35;
               |SINO;
                   nPos1  = (nLinea * 100) + 52;
                   nPos2  = (nLinea * 100) + 86;
               |FINSI;

               |HAZ PonerCampos;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Boton8;
     |VENTANA 0501, 3299, -1, 16, aAlfa;
     nVentB8 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentB8;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     enDocumento = #dsarw006#0;
     |SI PARAMETRO = "HISTORICO";
         enDocumento = #dshim001#43;
     |FINSI;

     |SUB_EJECUTA_NP "flowm006";

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentB8;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentB8;
|FPRC;

|PROCESO Boton9;
     |VENTANA 0501, 3299, -1, 16, aAlfa;
     nVentB8 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentB8;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     enDocumento = #dsarw006#0;
     |SI PARAMETRO = "HISTORICO";
         enDocumento = #dshim001#43;
     |FINSI;

     |SUB_EJECUTA_NP "flowz002";

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentB8;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentB8;
|FPRC;

|PROCESO ControlBorradoCache;
     |SI #dsarm001#181 = "S";
          |HAZ DimeUnidad;
          aPathRemoto = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aPathRemoto;
          aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aPathRemoto;

          aFicAux = #dsarm005#96;
          |QBF aFicAux;
          |SI aFicAux ! "";
               nSwVerDocPDF = 1;
          |SINO;
               nSwVerDocPDF = 0;
          |FINSI;
          |SI nSwVerDocPDF = 1;
               aBorraCache = aPathRemoto + "\" + aFicAux;
          |SINO;
               aBorraCache = aPathRemoto + "\" + #dsarm005#9;
          |FINSI;
          |QBF aBorraCache;

          |SI aBorraCache ! "";
               |RFBORRA aBorraCache;
               |SI #dsarm005#89 = "S";
                    aExtension = aBorraCache % -104;
                    |SI aExtension = ".xml";
                         aInicioBorra = aBorraCache - aExtension;
                         aBorraCache = aInicioBorra + ".xml.txt";
                         |RFBORRA aBorraCache;
                    |SINO;
                         aInicioBorra = aBorraCache - ".xsig";
                         aBorraCache = aInicioBorra + ".xsig.txt";
                         |RFBORRA aBorraCache;
                    |FINSI;
                    aBorraCache = aInicioBorra + ".html";
                    |RFBORRA aBorraCache;
                    aBorraCache = aInicioBorra + ".html.txt";
                    |RFBORRA aBorraCache;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ControlRelaciones;
     |SI nSwEstaIntegral = 1;
          |SI aPideCli = "S";
               |MODO_RELACION #dsarw006, 0, "dsam0000", "X", "X";
          |FINSI;
          |MODO_RELACION #dsarw006, 0, "dsam0103", "X", "X";
     |SINO;
          |SI nSwEstaBasica = 1;
               |SI aPideCli = "S";
                    |MODO_RELACION #dsarw006, 0, "agifigen", "X", "X";
               |FINSI;
               |MODO_RELACION #dsarw006, 0, "agim0003", "X", "X";
          |FINSI;
     |FINSI;
     |MODO_RELACION #dsarw006, 0, "agitab99", "X", "X";

     |SI nSwEstaIntegral = 1;
          |SI aPideCli = "S";
               |MODO_RELACION #dsarw006, 1, "dsam0000", "N", "S";
          |FINSI;
          |MODO_RELACION #dsarw006, 1, "dsam0103", "S", "S";
     |SINO;
          |SI nSwEstaBasica = 1;
               |SI aPideCli = "S";
                    |MODO_RELACION #dsarw006, 1, "agifigen", "N", "S";
               |FINSI;
               |MODO_RELACION #dsarw006, 1, "agim0003", "S", "S";
          |FINSI;
     |FINSI;
     |MODO_RELACION #dsarw006, 1, "agitab99", "N", "S";

     |SI nSwEstaIntegral = 0;
          |MODO_RELACION #dsarw006, 1, "dsam0000", "N", "N";
          |MODO_RELACION #dsarw006, 1, "dsam0000", "X", "X";
          |MODO_RELACION #dsarw006, 1, "dsam0103", "N", "N";
          |MODO_RELACION #dsarw006, 1, "dsam0103", "X", "X";
          |SI nSwEstaBasica = 0;
             aPideCli = "N";
             aPideNif = "N";
             |MODO_RELACION #dsarw006, 1, "agifigen", "N", "N";
             |MODO_RELACION #dsarw006, 1, "agifigen", "X", "X";
             |MODO_RELACION #dsarw006, 1, "agim0003", "N", "N";
             |MODO_RELACION #dsarw006, 1, "agim0003", "X", "X";
          |FINSI;
     |FINSI;

     |SI aPideNif = "N";
          |MODO_RELACION #dsarw006, 1, ":/integral/def/dsam0103", "N", "N";
          |MODO_RELACION #dsarw006, 1, ":/integral/def/dsam0103", "X", "X";
          |MODO_RELACION #dsarw006, 1, ":/basica/def/agim0003", "N", "N";
          |MODO_RELACION #dsarw006, 1, ":/basica/def/agim0003", "X", "X";
     |FINSI;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;

|PROCESO LimpiaValor;
     ||  En los campos libres le quita la parte de la descripcion del campo
     ||  FECHA FAC: 12.03.2011
     ||  Devuelve  12.03.2011

     aValorEntrada = aValor;

     ||VOY A QUITAR HASTA LOS 2 puntos y el espacio de despues.
     aLong2 = aValor % A0;
     nLong2 = aLong;

     |PARA nConta = 1; |SI nConta [ nLong2; |HACIENDO nConta = nConta + 1;
          nSaca = (100 * nConta) + 2;
          aSaca = nSaca;

          aAux = aValor % aSaca;
          |SI aAux = ": ";
               nSaca = nConta + 2;
               aSaca = nSaca;
               aValor = aValor % aSaca;
               |SAL;
          |FINSI;
     |SIGUE;

     |SI aValor = aValorEntrada;             ||Nos llega esto "Factura:". Devolvemos VACIO
          aAuxQuita = aValorEntrada - ":";
          |SI FSalida ! 0;
               aValor = "";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ControlAutoPlantillaInverso;
     |ABRE #dsarm034;
     |SELECT #2#dsarm034;
     #dsarm034#16 = #dsarm005#0;
     |LEE 000#dsarm034.=;
     |SI FSalida = 0;
          aFechadsEscan = #dsarm034#0;
          aHoradsEscan = #dsarm034#1;
          aNomdsEscan = #dsarm034#2;

          |ABRE #dsarm036;
          |ABRE #dsarm035;
          |ABRE #dsarm004;
          |DDEFECTO #dsarm004;
          #dsarm004#0 = #dsarm005#1;
          #dsarm004#1 = #dsarm005#2;
          #dsarm004#2 = #dsarm005#3;
          |LEE 000#dsarm004.=;
          |SI FSalida = 0;
               |SI #dsarm004#78 ! 0;
                    |ABRE #dsarm029;
                    |DDEFECTO #dsarm029;
                    #dsarm029#0 = #dsarm004#78;
                    |LEE 000#dsarm029.=;
                    |SI FSalida = 0;
                         |PARA nVoy = 1; |SI nVoy [ 20; |HACIENDO nVoy = nVoy + 1;
                              nCampoEstoy = (nVoy * 4) + 2;
                              nCampoReg = #dsarm029#nCampoEstoy#;
                              |SI nCampoReg ! 0;
                                   aValor = #dsarm005#nCampoReg#;
                                   |QBF aValor;
                                   |SI nCampoReg ] 23; |Y nCampoReg [ 37;
                                        |HAZ LimpiaValor;
                                   |FINSI;
                                   |SI nCampoReg ] 60; |Y nCampoReg [ 64;
                                        |HAZ LimpiaValor;
                                   |FINSI;

                                   |SI aValor ! ""; |Y aValor ! "01.01.0000";
                                        nCampoEstoy = nVoy * 4;
                                        aCadena = #dsarm029#nCampoEstoy#;
                                        |QBF aCadena;
                                        aLong = aCadena % A0;
                                        nLong = aLong;
                                        |SI nLong ] 10;          ||Como minimo tendra 10 caracteres
                                             aNomPi = aCadena % 108;
                                             |QBF aNomPi;
                                             |SI aNomPi ! "";
                                                  |DDEFECTO #dsarm036;
                                                  #dsarm036#0 = aNomPi;
                                                  #dsarm036#1 = aCadena;
                                                  |LEE 000#dsarm036.=;
                                                  |SI FSalida = 0;
                                                       |DDEFECTO #dsarm035;
                                                       #dsarm035#0 = aFechadsEscan;
                                                       #dsarm035#1 = aHoradsEscan;
                                                       #dsarm035#2 = aNomdsEscan;
                                                       #dsarm035#3 = #dsarm036#1;
                                                       |LEE 101#dsarm035.=;
                                                       |SI FSalida ! 0;
                                                            |GRABA 020#dsarm035.b;
                                                       |FINSI;

                                                       #dsarm035#10 = #dsarm036#9;
                                                       |GRABA 020#dsarm035.a;
                                                       |LIBERA #dsarm035;
                                                  |FINSI;
                                             |FINSI;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                         |SIGUE;
                    |FINSI;
                    |CIERRA #dsarm029;
               |FINSI;
          |FINSI;
          |CIERRA #dsarm004;
          |CIERRA #dsarm035;
          |CIERRA #dsarm036;
     |FINSI;
     |CIERRA #dsarm034;
|FPRC;

|PROCESO PosicionateCL;
     ||El el numero de campo (tiene que hacer este numero - 1 tabulaciones)
     |SI enModoModiw006 = 1; |Y enPosicionateCampo > 1;
          |PARA nTab = 1; |SI nTab < enPosicionateCampo; |HACIENDO nTab = nTab + 1;
               |PTEC 804;
          |SIGUE;
          |SI nSwVuelvePedirNif = 1;
               aPideNif = "S";
               |C_M #dsarw006#10, 1, "S";
               |PINTA #dsarw006#10;
          |FINSI;
          nSwVuelvePedirNif = 0;
          enPosicionateCampo = 0;
     |FINSI;
|FPRC;

|PROCESO CtrlPosicion; |TIPO 7;
     |HAZ PosicionateCL;
|FPRC;

|PROCESO ModoVincula;
     |SI enModoVincula ! 1;       |ACABA;  |FINSI;
     |SI #dsarm004#88 = 0;        |ACABA;  |FINSI;
     |SI enSwPlantillaConta = 0;  |ACABA;  |FINSI;

     |ABRE #dsarm065;
     |DDEFECTO #dsarm065;
     #dsarm065#0 = #dsarm004#88;
     |LEE 000#dsarm065.=;
     |SI FSalida ! 0;
         |CIERRA #dsarm065;
         |ACABA;
     |FINSI;
     |CIERRA #dsarm065;

     |DBASS aBaseConta;
     |QBF aBaseConta;
     aDirConta = aBaseConta + "contagen/";
     aDirDatos = aDirConta + "fich/" + (("00000" + enEmpADConta) % -105) + (("0" + enEjeADConta) % -101) + "/";

     aDef = aDirConta + "def/camaniva";
     |CARGA_DEF aDef, referen@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |PATH_DAT #referen@#aDirDatos#;
     |ABRE #referen@;
     |DDEFECTO #referen@;
     #referen@#0 = enLibroConta;
     #referen@#1 = enDocumentoConta;
     |LEE 000#referen@.=;
     |SI FSalida ! 0;
         |CIERRA #referen@;
         |DESCARGA_DEF #referen@;
         |ACABA;
     |FINSI;
     |CIERRA #referen@;

     |PARA nCampoC = 2; |SI nCampoC [ 47; |HACIENDO nCampoC = nCampoC + 5;
           nCampoE    = nCampoC + 2;
           nNumCampo  = #dsarm065#nCampoC#;
           nNumCampo2 = #dsarm065#nCampoE#;
           |SI nNumCampo ! -1; |Y nNumCampo2 ! -1;
               |SI nNumCampo = 99;
                   aDef = aDirConta + "def/camanref";
                   |CARGA_DEF aDef, otrodef@;
                   |SI FSalida = 0;
                       |PATH_DAT #otrodef@#aDirDatos#;
                       |ABRE #otrodef@;
                       #otrodef@#0 = #referen@#0;
                       #otrodef@#1 = #referen@#1;
                       |LEE 000#otrodef@.=;
                       |SI FSalida = 0;
                           aValorConta = #otrodef@#2;
                       |SINO;
                           aValorConta = "";
                       |FINSI;
                       |CIERRA #otrodef@;
                       |DESCARGA_DEF #otrodef@;
                   |SINO;
                       aValorConta = "";
                   |FINSI;
               |SINO;
                   aValorConta = #referen@#nNumCampo#;
               |FINSI;

               |QBF aValorConta;
               |SI aValorConta ! "";
                   aActual = #dsarm005#nNumCampo2#;  |QBF aActual;
                   |SI aActual ! "";
                       |SI nNumCampo2 ] 23; |Y nNumCampo2 [ 37;
                           aTextoActual = aActual;
                           |HAZ QuitaHasta2Puntos;
                           aActual = aTextoActual;
                           aActual = aActual + " " + aValorConta;
                           #dsarm005#nNumCampo2# = aActual;
                       |SINO;
                           |SI nNumCampo2 ] 60; |Y nNumCampo2 [ 64;
                               aTextoActual = aActual;
                               |HAZ QuitaHasta2Puntos;
                               aActual = aTextoActual;
                               aActual = aActual + " " + aValorConta;
                               #dsarm005#nNumCampo2# = aActual;
                           |SINO;
                               #dsarm005#nNumCampo2# = aValorConta;
                           |FINSI;
                       |FINSI;
                   |SINO;
                       #dsarm005#nNumCampo2# = aValorConta;
                   |FINSI;
               |FINSI;
           |FINSI;
     |SIGUE;
     |DESCARGA_DEF #referen@;
|FPRC;

|PROGRAMA;
     |HAZ LeeUnidadBasico;

     nSwModoConsulta = 1;

     |ABRE #dsarm001;
     |LEE 000#dsarm001.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarm001;  |FINSI;
     |CIERRA #dsarm001;

     |HAZ EstaIntegral;       ||Nos devuelve si esta integral (1) o no esta (0)
     |HAZ EstaBasica;         ||Nos devuelve si esta basica (1) o no esta (0)

     |ABRE #dsarz010;
     aUsuario = Usuario % 810;
     |DDEFECTO #dsarz010;
     #dsarz010#0 = aUsuario;
     |LEE 000#dsarz010.=;
     |SI FSalida ! 0;
          |PARA nCampo = 3;  |SI nCampo [ 52;  |HACIENDO nCampo = nCampo + 1;
               #dsarz010#nCampo# = "S";
          |SIGUE;
     |FINSI;
     aPideDocCarpeta     = #dsarz010#10;
     aPideVolverCapturar = #dsarz010#11;
     |CIERRA #dsarz010;

     aPathRemoto    = "";
     |HAZ DimeUnidad;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aPathRemoto;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aPathRemoto;

     |HAZ eCambioDeCero;

     |SI PARAMETRO = "HISTORICO";
         aNome = "h" + eaEj + "m01";
         |NOME_DAT #dshim001#aNome#;

         |ABRE #dshim001;
         #dshim001#0 = enDocumento;
         |LEE 000#dshim001.=;
         |SI FSalida ! 0;
             |DDEFECTO #dshim001;
             |CIERRA #dshim001;
             |ACABA;
         |FINSI;
         |CIERRA #dshim001;

         aQueQuiero = "|NC";
         nNumCampos = #dshim001#aQueQuiero#;
         nNumCampos = nNumCampos - 1;

         |PARA nCampo = 0; |SI nCampo [ nNumCampos;  |HACIENDO nCampo = nCampo + 1;
               #dsarm005#nCampo# = #dshim001#nCampo#;
         |SIGUE;
     |SINO;
         |ABRE #dsarm005;
         #dsarm005#0 = enDocumento;
         |LEE 000#dsarm005.=;
         |SI FSalida ! 0;  |CIERRA #dsarm005;  |ACABA;  |FINSI;
     |FINSI;

     enGrupoVinExte    = #dsarm005#1;
     enSubGrupoVinExte = #dsarm005#2;
     enTipoVinExte     = #dsarm005#3;
     |HAZ DimeTipoVinculo;

     |C_M #dsarw006#13, 1, "S";
     |C_V #dsarw006#76, 1, "N";
     |C_V #dsarw006#77, 1, "N";

     |SI enSwVinculosExternos = 1;
          |SI eaTipoVinculo = "TALLER";
               |C_M #dsarw006#13, 1, "N";
          |FINSI;

          |SI eaTipoVinculo = "CLINICA";
               |C_M #dsarw006#13, 1, "N";

               |C_V #dsarw006#76, 1, "S";
               |C_V #dsarw006#77, 1, "S";
          |FINSI;
     |FINSI;

     ||LIBRE
     |ABRE #dsarm004;
     |DDEFECTO #dsarm004;
     #dsarm004#0 = #dsarm005#1;
     #dsarm004#1 = #dsarm005#2;
     #dsarm004#2 = #dsarm005#3;
     |LEE 000#dsarm004.=;
     aLibre = #dsarm004#5;
     aLibre2 = #dsarm004#6;
     aLibre3 = #dsarm004#7;
     aLibre4 = #dsarm004#8;
     aLibre5 = #dsarm004#9;
     aLibre6 = #dsarm004#10;
     aLibre7 = #dsarm004#11;
     aLibre8 = #dsarm004#12;
     aLibre9 = #dsarm004#13;
     aLibre10 = #dsarm004#14;
     aLibre11 = #dsarm004#15;
     aLibre12 = #dsarm004#16;
     aLibre13 = #dsarm004#17;
     aLibre14 = #dsarm004#18;
     aLibre15 = #dsarm004#19;
     aLibre16 = #dsarm004#27;
     aLibre17 = #dsarm004#28;
     aLibre18 = #dsarm004#29;
     aLibre19 = #dsarm004#30;
     aLibre20 = #dsarm004#31;
     |CIERRA #dsarm004;

     nSwBorraEtLibres = 0;
     #dsarw006#0 = #dsarm005#0;
     |SI enMueveDoc = 0;
          #dsarw006#1 = #dsarm005#1;
          #dsarw006#2 = #dsarm005#2;
          #dsarw006#3 = #dsarm005#3;
     |SINO;
          #dsarw006#1 = enGrupoPV;
          #dsarw006#2 = enSubGrupoPV;
          #dsarw006#3 = enTipoPV;

          |ABRE #dsarm004;
          |DDEFECTO #dsarm004;
          #dsarm004#0 = #dsarw006#1;
          #dsarm004#1 = #dsarw006#2;
          #dsarm004#2 = #dsarw006#3;
          |LEE 000#dsarm004.=;

          ||LIBRES
          |SI aLibre ! #dsarm004#5; |O aLibre2 ! #dsarm004#6; |O aLibre3 ! #dsarm004#7;
           |O aLibre4 ! #dsarm004#8; |O aLibre5 ! #dsarm004#9; |O aLibre6 ! #dsarm004#10;
           |O aLibre7 ! #dsarm004#11; |O aLibre8 ! #dsarm004#12; |O aLibre9 ! #dsarm004#13;
           |O aLibre10 ! #dsarm004#14; |O aLibre11 ! #dsarm004#15; |O aLibre12 ! #dsarm004#16;
           |O aLibre13 ! #dsarm004#17; |O aLibre14 ! #dsarm004#18; |O aLibre15 ! #dsarm004#19;
           |O aLibre16 ! #dsarm004#27; |O aLibre17 ! #dsarm004#28; |O aLibre18 ! #dsarm004#29;
           |O aLibre19 ! #dsarm004#30; |O aLibre20 ! #dsarm004#31;
               nSwBorraEtLibres = 1;
          |FINSI;

          |CIERRA #dsarm004;
     |FINSI;

     |SI enModoVincula = 1;
          #dsarw006#1 = enGrupoVincula;
          #dsarw006#2 = enSubGruVincula;
          #dsarw006#3 = enTipoVincula;
     |FINSI;

     |ABRE #dsarm002;
     |DDEFECTO #dsarm002;
     #dsarm002#0 = #dsarw006#1;
     |LEE 000#dsarm002.=;
     |CIERRA #dsarm002;

     |ABRE #dsarm003;
     |DDEFECTO #dsarm003;
     #dsarm003#0 = #dsarw006#1;
     #dsarm003#1 = #dsarw006#2;
     |LEE 000#dsarm003.=;
     |CIERRA #dsarm003;

     |ABRE #dsarm004;
     |DDEFECTO #dsarm004;
     #dsarm004#0 = #dsarw006#1;
     #dsarm004#1 = #dsarw006#2;
     #dsarm004#2 = #dsarw006#3;
     |LEE 000#dsarm004.=;
     |CIERRA #dsarm004;

     nSwCefax = 0;
     |SI #dsarm001#66 = "S";
          |SI #dsarm001#67 = #dsarm004#0; |Y #dsarm001#68 = #dsarm004#1; |Y #dsarm001#69 = #dsarm004#2;
               nSwCefax = 1;
          |FINSI;
          |SI #dsarm001#89 = #dsarm004#0; |Y #dsarm001#90 = #dsarm004#1; |Y #dsarm001#91 = #dsarm004#2;
               nSwCefax = 1;
          |FINSI;
     |FINSI;

     aParametro = PARAMETRO;
     |QBF aParametro;
     |SI aParametro = "VERDOCUMENTO";
          |PARA nCampo = 4;  |SI nCampo [ 37;  |HACIENDO nCampo = nCampo + 1;
                #dsarw006#nCampo# = #dsarm005#nCampo#;
          |SIGUE;

          |HAZ CalculaPanta;

          |HAZ Boton1;

          |HAZ DimeUnidad;
          aPathRemoto = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aPathRemoto;
          aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aPathRemoto;

          aFicAux = #dsarm005#96;
          |QBF aFicAux;
          |SI aFicAux ! "";
               nSwVerDocPDF = 1;
          |SINO;
               nSwVerDocPDF = 0;
          |FINSI;
          |SI nSwVerDocPDF = 1;
               aBorraCache = aPathRemoto + "\" + aFicAux;
          |SINO;
               aBorraCache = aPathRemoto + "\" + #dsarm005#9;
          |FINSI;
          |QBF aBorraCache;

          eaBorraCache = aBorraCache;
          |ACABA;
     |FINSI;

     aPideCli = #dsarm004#20;
     aPideNif = #dsarm004#21
     aPideTra = #dsarm004#22;
     aPideMod = #dsarm004#23;
     aPideMin = #dsarm004#24;

     ||Pongo todo el array a "N".
     IaCampoObligatorio = aCampoObligatorio1<-;
     |PARA nCampo = 1;  |SI nCampo [ 20;  |HACIENDO nCampo = nCampo + 1;
          aCampoObligatorio = "N";
          IaCampoObligatorio = IaCampoObligatorio + 1;
     |SIGUE;

     ||Pongo todo el array de aNomCampo a vacio "".
     IaNomCampo = aNomCampo1<-;
     |PARA nCampo = 1;  |SI nCampo [ 20;  |HACIENDO nCampo = nCampo + 1;
          aNomCampo = "";
          IaNomCampo = IaNomCampo + 1;
     |SIGUE;

     nVoy = 0;
     nEstoy = 0;
     aAux = #dsarm004#5; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#6; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#7; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#8; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#9; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#27; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#28; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#29; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#30; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#31; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#10; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#11; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#12; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#13; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#14; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#15; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#16; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#17; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#18; |QBF aAux;
     |HAZ RellenaArray;

     nEstoy = nEstoy + 1;
     aAux = #dsarm004#19; |QBF aAux;
     |HAZ RellenaArray;

     |HAZ ControlRelaciones;


     aMas = aBase + "/laboral/def/nomw0003.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida < 0;
         aPideTra = "N";
     |FINSI;

     aMas = aBase + "/basica/def/agitab99.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida < 0;
         aPideMod = "N";

         |MODO_RELACION #dsarw006, 1, "agitab99", "N", "N";
         |MODO_RELACION #dsarw006, 1, "agitab99", "X", "X";
     |FINSI;

     aMas = aBase + "/facturar/def/asclient.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida < 0;
         aPideMin = "N";
     |FINSI;

     |SI aPideNif = "N";
          |MODO_RELACION #dsarw006, 1, ":/integral/def/dsam0103", "N", "N";
          |MODO_RELACION #dsarw006, 1, ":/integral/def/dsam0103", "X", "X";
          |MODO_RELACION #dsarw006, 1, ":/basica/def/agim0003", "N", "N";
          |MODO_RELACION #dsarw006, 1, ":/basica/def/agim0003", "X", "X";
     |FINSI;

     |SI #dsarw006#8 = 0;
         #dsarw006#14 = "";
     |FINSI;

     |C_M #dsarw006#8,  1, aPideCli;
     |C_M #dsarw006#10, 1, aPideNif;
     |C_M #dsarw006#15, 1, aPideTra;
     |C_M #dsarw006#19, 1, aPideMod;
     |C_M #dsarw006#42, 1, aPideMin;
     |C_M #dsarw006#43, 1, aPideMin;
     |C_M #dsarw006#47, 1, aPideDocCarpeta;

     |SI enModoModiw006 = 1; |Y enPosicionateCampo > 1;
          |SI aPideNif = "S";
               nSwVuelvePedirNif = 1;
               |C_M #dsarw006#10, 1, "N";
          |FINSI;
     |FINSI;

     |C_M #dsarw006#17, 1, "S";
     |C_M #dsarw006#18, 1, "S";
     |SI aPideTra = "N";  |Y aPideMod = "N";
         |C_M #dsarw006#17, 1, "N";
         |C_M #dsarw006#18, 1, "N";
     |FINSI;

     |C_M #dsarw006#20, 1, "S";
     |SI aPideMod = "N";
         |C_M #dsarw006#20, 1, "N";
     |FINSI;

     |HAZ ModoVincula;

     |PARA nCampo = 0;  |SI nCampo [ 37;  |HACIENDO nCampo = nCampo + 1;
           #dsarw006#nCampo# = #dsarm005#nCampo#;
     |SIGUE;

     |SI enModoVincula = 1;
          aDestinoReal = #dsarw006#7;

          nGrupoReal = #dsarw006#1;
          nSubGruReal = #dsarw006#2;
          nTipoReal = #dsarw006#3;

          #dsarw006#1 = enGrupoVincula;
          #dsarw006#2 = enSubGruVincula;
          #dsarw006#3 = enTipoVincula;

          aDestinoPV = #dsarm001#1;
          |QBF aDestinoPV;
          aDestinoPV = aDestinoPV + "/" + #dsarm002#2;
          |QBF aDestinoPV;
          |SI #dsarm001#8 = "S"; ||Usan Grupo, Subgrupo y Tipo
               aDestinoPV = aDestinoPV + "/" + #dsarm003#3;
               |QBF aDestinoPV;
               aDestinoPV = aDestinoPV + "/" + #dsarm004#4;
               |QBF aDestinoPV;
               aDestinoPV = aDestinoPV + "/";
          |FINSI;

          #dsarw006#7 = aDestinoPV;
     |FINSI;

     |SI enMueveDoc = 1;
          aDestinoReal = #dsarw006#7;

          #dsarw006#1 = enGrupoPV;
          #dsarw006#2 = enSubGrupoPV;
          #dsarw006#3 = enTipoPV;

          aDestinoPV = #dsarm001#1;
          |QBF aDestinoPV;
          aDestinoPV = aDestinoPV + "/" + #dsarm002#2;
          |QBF aDestinoPV;
          |SI #dsarm001#8 = "S"; ||Usan Grupo, Subgrupo y Tipo
               aDestinoPV = aDestinoPV + "/" + #dsarm003#3;
               |QBF aDestinoPV;
               aDestinoPV = aDestinoPV + "/" + #dsarm004#4;
               |QBF aDestinoPV;
               aDestinoPV = aDestinoPV + "/";
          |FINSI;

          #dsarw006#7 = aDestinoPV;
     |FINSI;

     #dsarw006#38 = #dsarm002#1;
     #dsarw006#39 = #dsarm003#2;
     #dsarw006#40 = #dsarm004#3;
     #dsarw006#41 = #dsarm005#38;
     #dsarw006#42 = #dsarm005#39;
     #dsarw006#43 = #dsarm005#40;
     #dsarw006#44 = #dsarm005#44;
     #dsarw006#45 = #dsarm005#45;
     #dsarw006#46 = #dsarm005#46;
     #dsarw006#47 = #dsarm005#47;
     #dsarw006#48 = #dsarm005#48;
     #dsarw006#49 = #dsarm005#60;
     #dsarw006#50 = #dsarm005#61;
     #dsarw006#51 = #dsarm005#62;
     #dsarw006#52 = #dsarm005#63;
     #dsarw006#53 = #dsarm005#64;
     #dsarw006#54 = #dsarm005#93;

     #dsarw006#76 = #dsarm005#97;
     #dsarw006#77 = #dsarm005#98;
     #dsarw006#78 = #dsarm005#99;
     #dsarw006#79 = #dsarm005#100;

     |HAZ CalculaPanta;

     |SI nSwBorraEtLibres = 1;
         #dsarw006#55 = "";
         #dsarw006#56 = "";
         #dsarw006#57 = "";
         #dsarw006#58 = "";
         #dsarw006#59 = "";
         #dsarw006#60 = "";
         #dsarw006#61 = "";
         #dsarw006#62 = "";
         #dsarw006#63 = "";
         #dsarw006#64 = "";
         #dsarw006#65 = "";
         #dsarw006#66 = "";
         #dsarw006#67 = "";
         #dsarw006#68 = "";
         #dsarw006#69 = "";
         #dsarw006#70 = "01.01.0000";
         #dsarw006#71 = "01.01.0000";
         #dsarw006#72 = "01.01.0000";
         #dsarw006#73 = "01.01.0000";
         #dsarw006#74 = "01.01.0000";
     |FINSI;

     |PINPA #0#dsarw006;  nPanta906_0 = FSalida;

     aPos = nPos1;
     aPos = ("0000" + aPos) % -0302;

     nPos1 = aPos;  nPos1 = nPos1 + 2;  nPos1 = (nPos1 * 100) + 77;
     nPos2 = aPos;  nPos2 = nPos2 + 2;  nPos2 = (nPos2 * 100) + 87;
     |SI PARAMETRO ! "HISTORICO";
         |CONTROL_SIMPLE nPanta906_0, "BOTON,{{197}} Modificar ", nPos1, nPos2, BotonModif;
          nBotonModif = FSalida;
     |FINSI;
     |PULSATECLA;

     aNifTrab = #dsarm005#95;
     |HAZ PintaNifTrab;

     |SI #dsarm004#34 = "N";
          |ESTADO_CONTROL nBotonModif, "DISABLE";
     |FINSI;

     |SI enMueveDoc = 1; |O enModoModiw006 = 1;
          |ESTADO_CONTROL nBotonModif, "DISABLE";
     |FINSI;

     |SI #dsarz010#12 = "N";
          |ESTADO_CONTROL nBotonModif, "DISABLE";
     |FINSI;

     |SI #dsarm001#8 = "N";
         |PINTA 0534, "          ";
         |PINTA 0569, "          ";
         |PINTA 1982, "          ";
         |PINTA 2082, "          ";
     |FINSI;

     nPos1 = aPos;  nPos1 = nPos1 + 2;  nPos1 = (nPos1 * 100) + 02;
     nPos2 = aPos;  nPos2 = nPos2 + 2;  nPos2 = (nPos2 * 100) + 14;
     |CONTROL_SIMPLE nPanta906_0, "BOTON,Ver Documento", nPos1, nPos2, Boton1;  ||aqui
     nBoton1 = FSalida;

     nPos1 = aPos;  nPos1 = nPos1 + 2;  nPos1 = (nPos1 * 100) + 15;
     nPos2 = aPos;  nPos2 = nPos2 + 2;  nPos2 = (nPos2 * 100) + 25;
     |CONTROL_SIMPLE nPanta906_0, "BOTON,Asociados", nPos1, nPos2, Boton5;
     nBoton5 = FSalida;

     nPos1 = aPos;  nPos1 = nPos1 + 2;  nPos1 = (nPos1 * 100) + 26;
     nPos2 = aPos;  nPos2 = nPos2 + 2;  nPos2 = (nPos2 * 100) + 38;
     |CONTROL_SIMPLE nPanta906_0, "BOTON,Volver a Capturar", nPos1, nPos2, Boton7;
     nBoton7 = FSalida;

     nPos1 = aPos;  nPos1 = nPos1 + 2;  nPos1 = (nPos1 * 100) + 39;
     nPos2 = aPos;  nPos2 = nPos2 + 2;  nPos2 = (nPos2 * 100) + 49;
     |CONTROL_SIMPLE nPanta906_0, "BOTON,Hist¢rico", nPos1, nPos2, Boton8;
     nBoton8 = FSalida;

     nPos1 = aPos;  nPos1 = nPos1 + 2;  nPos1 = (nPos1 * 100) + 50;
     nPos2 = aPos;  nPos2 = nPos2 + 2;  nPos2 = (nPos2 * 100) + 60;
     |CONTROL_SIMPLE nPanta906_0, "BOTON,Anotaciones", nPos1, nPos2, Boton9;
     nBoton9 = FSalida;

     |SI aPideVolverCapturar = "S";
          |ESTADO_CONTROL nBoton7, "ENABLE";
     |SINO;
          |ESTADO_CONTROL nBoton7, "DISABLE";
     |FINSI;
     |ESTADO_CONTROL nBoton7, "DISABLE";

     |ABRE #dsarm007;
     |SELECT #1#dsarm007;
     #dsarm007#0 = #dsarw006#0;
     #dsarm007#1 = 1;
     |LEE 000#dsarm007.];
     |SI FSalida = 0;  |Y  #dsarm007#0 = #dsarw006#0;
         |ESTADO_CONTROL nBoton5, "ENABLE";
     |SINO;
         |ESTADO_CONTROL nBoton5, "DISABLE";
     |FINSI;
     |CIERRA #dsarm007;

     |SI #dsarm001#8 = "N";
         |C_V #dsarw006#2,  1, "N";
         |C_V #dsarw006#3,  1, "N";
         |C_V #dsarw006#39, 1, "N";
         |C_V #dsarw006#40, 1, "N";
         |C_V #dsarw006#45, 1, "N";
         |C_V #dsarw006#46, 1, "N";
     |FINSI;

     |SI enSwVinculosExternos = 1;
          |SI eaTipoVinculo = "CLINICA";
               |CONTROL_SIMPLE nPanta906_0, "LABEL,{{11}}Historia", 2102, 2109, NULL;
               |CONTROL_SIMPLE nPanta906_0, "LABEL,{{11}}Episodio", 2157, 2165, NULL;
          |FINSI;
     |FINSI;

     nEndatos = 1;

     |PINDA #0#dsarw006;

     |SI #dsarm004#34 = "N";  nEndatos = 0;  |FINSI;

     |SI enMueveDoc = 1; |O enModoModiw006 = 1;
          nSwModoConsulta = 0;
     |SINO;
          FSalida = "::{{001}}Salir";
          |PAUSA;
     |FINSI;

     |SI enModoModiw006 = 1;
          |PTEC 802;
          |PAUSA;
     |FINSI;

     |SI nSwModoConsulta = 0;
         #dsarm005#0 = enDocumento;
         |LEE 101#dsarm005.=;

         nEndatos = 0;
         |SI eaNomDef = "cainliva";
             |SI #dsarm004#88 ! 0;
                 nEndatos = 1;
             |FINSI;
         |FINSI;

          |C_M #dsarw006#11, 1, "S";

          FSalida = 0;
          |SI nEndatos = 0;
              |ENDATOS #2#dsarw006;
          |FINSI;

          |SI FSalida = 0;
              |HAZ ControlCefaxOculto;

              |PARA nCampo = 0;  |SI nCampo [ 37;  |HACIENDO nCampo = nCampo + 1;
                    |SI enMueveDoc = 0;
                         #dsarm005#nCampo#   = #dsarw006#nCampo#;
                    |SINO;
                         |SI nCampo > 4; |Y nCampo ! 7;
                              #dsarm005#nCampo#   = #dsarw006#nCampo#;
                         |FINSI;
                    |FINSI;
              |SIGUE;

              |SI enModoVincula = 1;
                   #dsarm005#1 = nGrupoReal;
                   #dsarm005#2 = nSubGruReal;
                   #dsarm005#3 = nTipoReal;
                   #dsarm005#7 = aDestinoReal;
              |FINSI;

              #dsarm005#38 = #dsarw006#41;
              #dsarm005#41 = ~;
              |HORA aAlfa; |QBF aAlfa; aAlfa = aAlfa % 0105;
              #dsarm005#42 = aAlfa;
              aAlfa = Usuario; |QBF aAlfa; aAlfa = aAlfa % 0810;
              #dsarm005#43 = aAlfa;
              #dsarm005#39 = #dsarw006#42;
              #dsarm005#40 = #dsarw006#43;
              #dsarm005#47 = #dsarw006#47;

              ||TODO CCC. Controlar los CAMPOS OPCIONALES
              #dsarm005#23 = "";
              #dsarm005#24 = "";
              #dsarm005#25 = "";
              #dsarm005#26 = "";
              #dsarm005#27 = "";
              #dsarm005#28 = "";
              #dsarm005#29 = "";
              #dsarm005#30 = "";
              #dsarm005#31 = "";
              #dsarm005#32 = "";
              #dsarm005#33 = "";
              #dsarm005#34 = "";
              #dsarm005#35 = "";
              #dsarm005#36 = "";
              #dsarm005#37 = "";
              #dsarm005#60 = "";
              #dsarm005#61 = "";
              #dsarm005#62 = "";
              #dsarm005#63 = "";
              #dsarm005#64 = "";

              nContReal = 0;
              nContDos = 0;
              |PARA nCampo = 5;  |SI nCampo [ 9;  |HACIENDO nCampo = nCampo + 1;
                   |HAZ GrabaCampos;
              |SIGUE;
              |PARA nCampo = 27;  |SI nCampo [ 31;  |HACIENDO nCampo = nCampo + 1;
                   |HAZ GrabaCampos;
              |SIGUE;

              |PARA nCampo = 10;  |SI nCampo [ 19;  |HACIENDO nCampo = nCampo + 1;
                   |HAZ GrabaCampos;
              |SIGUE;

              #dsarm005#93 = #dsarw006#54;

              enSwErrorModiw006 = 0;

              enNumRegVincuExte = #dsarm005#0;
              |HAZ DimeValoresVinculo;
              |SI enSwVinculosExternos = 1;
                    aTipoVinAntes = eaTipoVinculo;
                    |QBF aTipoVinAntes;
                    aVinculo1Antes = eaValorVinculo1;
                    aVinculo2Antes = eaValorVinculo2;
                    eaPosicionateVinculo1 = eaValorVinculo1;
                    eaPosicionateVinculo2 = eaValorVinculo2;
              |SINO;
                    aTipoVinAntes = "";
                    aVinculo1Antes = "";
                    aVinculo2Antes = "";
                    eaPosicionateVinculo1 = "";
                    eaPosicionateVinculo2 = "";
              |FINSI;

              enGrupoVinExte = #dsarm005#1;
              enSubGrupoVinExte = #dsarm005#2;
              enTipoVinExte = #dsarm005#3;
              enError = 0;
              |HAZ VinculosExternos;
              |SI enSwVinculosExternos = 1;
                    |SI eaTipoVinculo = "CLINICA"; |Y enError = 1;
                         ||Da error o han cancelado el proceso
                    |SINO;
                         |SI eaPosicionateVinculo1 ! eaValorVinculo1; |O eaPosicionateVinculo2 ! eaValorVinculo2;
                              aMensaje = "0000SHa modificado el valor del vinculo externo." + &10 + "Desea Actualizar el registro?";
                              |CONFI aMensaje;
                              |SI FSalida = 0;
                                   enNumRegVincuExte = #dsarm005#0;
                                   |HAZ GrabaVincuExte;

                                   |SI eaTipoVinculo = "TALLER";
                                        #dsarm005#13 = eaValorVinculo2;
                                   |FINSI;
                                   |SI eaTipoVinculo = "CLINICA";
                                        #dsarw006#76 = eaValorVinculo1;
                                        #dsarw006#77 = eaValorVinculo2;
                                        #dsarm005#13 = eaValorVinculoAux;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
              |FINSI;
              #dsarm005#95  = #dsarw006#75;
              #dsarm005#97  = #dsarw006#76;
              #dsarm005#98  = #dsarw006#77;
              #dsarm005#99  = #dsarw006#78;
              #dsarm005#100 = #dsarw006#79;

              |GRABA 020#dsarm005.a;

              |HAZ ControlAutoPlantillaInverso;
          |SINO;
               |SI enMueveDoc = 1;
                    enGrupoPV = 0;
                    enSubGrupoPV = 0;
                    enTipoPV = 0;
               |FINSI;

               enSwErrorModiw006 = 1;
          |FINSI;

          |LIBERA #dsarm005;
          ||Falta actualizar la ficha dsarm005
     |FINSI;

     |CIERRA #dsarm005;

     |FIN_CONTROL_WINDOWS nEventoFoco;
     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton4;
     |FIN_CONTROL_WINDOWS nBoton5;
     |FIN_CONTROL_WINDOWS nBoton6;
     |FIN_CONTROL_WINDOWS nBoton7;
     |FIN_CONTROL_WINDOWS nBotonModif;

     |PULSATECLA;

     |HAZ ControlBorradoCache;
|FPRO;

|PROCESO Tipo80Fw006;  |TIPO 80;
     |ABRET #dsarm006;

     FSalida = 3799;
|FPRC;

|PROCESO Tipo90Fw006;  |TIPO 90;
     |CIERRAT #dsarm006;
|FPRC;
