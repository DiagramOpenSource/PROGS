|FICHEROS;
     dsarm000;
     dsarm001;
     dsarm005;
     dsarm032;
     dsarm061;
     dsarm062;
     dsarm064;
     dsarm066;
     dsarm067;

     flowm006;

     dsarw010;
     dsarw077;
     dsarw088;
     dsarw093;

     dsarw011,MANTE;
     dsarw013;
     dsarw014;
     dsarw019;

     agifm006@;
     agifa133@;
     agifa134@;
     agifa024@;

     referen@;
|FIN;

|VARIABLES;
     aExisteOTP = "";
     aPathDefOTP = "";
     aEmail2 = "";
     aEmail3 = "";

     aMiraCuatro = "";
     aError1 = "";
     aError2 = "";
     aAbreERROR = "";
     aEmail = "";

     aDosLetras = "";
     nHayBarraEne = 0;
     aQuitaEne = "";
     aNuevaAlfa = "";
     aSaca = "";
     aLetra = "";
     nLongMenosUno = 0;

     aAdjuntoMulti = "";
     aCustom = "";
     nHandleC = 0;

     ||Envio usando el cliente windows BLAT
     ||http://www.blat.net/
     nSwBLAT = 0;
     aDirBasico = "";
     &eaUnidadBasico = "";
     &eaOrigen = "";
     &eaDestino = "";
     &enSwNuevoMD5 = 0;
     aBasePlaServ = "";
     aBaseServ = "";
     aBaseBin = "";
     aTextoAdjuntos = "";
     aTxtDirDestino = "";

     aAuxNot = "";
     &eaEscapaAsunto = "";

     nSwSMTPServPropio = 0;
     aVarSMTP = "";
     aVarUsuario = "";
     aVarPassword = "";

     aNomLogo = "";
     &enEmpCorreo = 0;        ||Nos indica en que empresa estamos archivando
     nVoy = 0;

     ||Historico envios
     nUltHis = 0;
     aSwHistoricoEnv = "S";              ||Historico Envio Correos. (NUEVO)
     nUltLin = 0;
     aHoraEnv = "";
     aAuxEstado = "";
     nCliHis = 0;
     nSwContinua = 0;

     aSer       = "";
     aFac       = "";
     aFFa       = "";
     aIFa       = "";
     aFVe       = "";
     aIVe       = "";
     aIBAN      = "";
     aRazonSocial = "";
     nOk        = 0;
     nPosicion  = 0;
     nPos1      = 0;
     nPos2      = 0;
     nPosTrozo1 = 0;
     nPosTrozo2 = 0;
     nBusca     = 0;
     aTrozo1    = "";
     aTrozo2    = "";
     aAlfa3     = "";
     aBusco     = "";
     aBusca     = "";

     ||SELECCION CORREO AVANZADA.  ||ASESORIA LEX.
     &eaNombre188 = "";
     &enCliAutoAvanzado = 0;
     &enCodSelAva = 0;
     &eaGrabaHis = "";
     &eaEmailCliAvanzado = "";

     &eaAsuntoAva = "";
     &eaCuerpo1Ava = "";
     &eaCuerpo2Ava = "";
     &eaCuerpo3Ava = "";
     &eaCuerpo4Ava = "";
     &eaCuerpo5Ava = "";
     &eaCuerpo6Ava = "";
     &eaCuerpo7Ava = "";
     &eaCuerpo8Ava = "";
     &eaCuerpo9Ava = "";
     &eaCuerpo10Ava = "";
     &eaCuerpo11Ava = "";
     &eaCuerpo12Ava = "";
     &eaCuerpo13Ava = "";
     &eaCuerpo14Ava = "";
     &eaCuerpo15Ava = "";
     &eaCuerpo16Ava = "";
     &eaCuerpo17Ava = "";
     &eaCuerpo18Ava = "";
     &eaCuerpo19Ava = "";
     &eaCuerpo20Ava = "";
     &eaCuerpo21Ava = "";
     &eaCuerpo22Ava = "";
     &eaCuerpo23Ava = "";
     &eaCuerpo24Ava = "";
     &eaCuerpo25Ava = "";
     &eaCuerpo26Ava = "";
     &eaCuerpo27Ava = "";
     &eaCuerpo28Ava = "";
     &eaCuerpo29Ava = "";
     &eaCuerpo30Ava = "";
     &eaCuerpo31Ava = "";
     &eaCuerpo32Ava = "";
     &eaCuerpo33Ava = "";
     &eaCuerpo34Ava = "";
     &eaCuerpo35Ava = "";
     &eaCuerpo36Ava = "";
     &eaCuerpo37Ava = "";
     &eaCuerpo38Ava = "";
     &eaCuerpo39Ava = "";
     &eaCuerpo40Ava = "";
     &eaCuerpo41Ava = "";
     &eaCuerpo42Ava = "";
     &eaCuerpo43Ava = "";
     &eaCuerpo44Ava = "";
     &eaCuerpo45Ava = "";
     &eaCuerpo46Ava = "";
     &eaCuerpo47Ava = "";
     &eaCuerpo48Ava = "";
     &eaCuerpo49Ava = "";
     &eaCuerpo50Ava = "";
     &eaCuerpo51Ava = "";
     &eaCuerpo52Ava = "";
     &eaCuerpo53Ava = "";
     &eaCuerpo54Ava = "";
     &eaCuerpo55Ava = "";
     &eaCuerpo56Ava = "";
     &eaCuerpo57Ava = "";
     &eaCuerpo58Ava = "";
     &eaCuerpo59Ava = "";
     &eaCuerpo60Ava = "";
     &eaCuerpo61Ava = "";
     &eaCuerpo62Ava = "";
     &eaCuerpo63Ava = "";
     &eaCuerpo64Ava = "";
     &eaCuerpo65Ava = "";
     &eaCuerpo66Ava = "";
     &eaCuerpo67Ava = "";
     &eaCuerpo68Ava = "";
     &eaCuerpo69Ava = "";
     &eaCuerpo70Ava = "";
     &eaCuerpo71Ava = "";
     &eaCuerpo72Ava = "";
     &eaCuerpo73Ava = "";
     &eaCuerpo74Ava = "";
     &eaCuerpo75Ava = "";
     &eaCuerpo76Ava = "";
     &eaCuerpo77Ava = "";
     &eaCuerpo78Ava = "";
     &eaCuerpo79Ava = "";
     &eaCuerpo80Ava = "";
     &eaCuerpo81Ava = "";
     &eaCuerpo82Ava = "";
     &eaCuerpo83Ava = "";
     &eaCuerpo84Ava = "";
     &eaCuerpo85Ava = "";
     &eaCuerpo86Ava = "";
     &eaCuerpo87Ava = "";
     &eaCuerpo88Ava = "";
     &eaCuerpo89Ava = "";
     &eaCuerpo90Ava = "";
     &eaCuerpo91Ava = "";
     &eaCuerpo92Ava = "";
     &eaCuerpo93Ava = "";
     &eaCuerpo94Ava = "";
     &eaCuerpo95Ava = "";
     &eaCuerpo96Ava = "";
     &eaCuerpo97Ava = "";
     &eaCuerpo98Ava = "";
     &eaCuerpo99Ava = "";

     aUbicacion = "";
     aUsuarioTgz = "";
     aBaseTgz = "";
     nSwHayAdjuntosAva = 0;
     nModoMultiDoc = 0;            ||Indica que no enviamos un documento por correo
                                   ||sino un correo con varios documentos

     aAlfaAux = "";
     aGraba = "";
     nSwEsUTF8 = 0;
     aCodEspecial = "";
     aDos = "";
     aTres = "";
     aAlfaAnt = "";
     nSwCodEspecial = 0;
     aLetra1 = "";
     aLetra2 = "";
     aLetra3 = "";
     nAscii1 = 0;
     nAscii2 = 0;
     nAscii3 = 0;

     aBasePlugins = "";
     aOrigenMd5 = "";
     aDestinoMd5 = "";

     aFicheroWebMail = "";
     aSacaWebMail = "";
     nSwWebMail = 0;
     aAlfaExte = "";
     aExtension = "";
     aLabel = "";

     aBorraCache = "";
     aBorraCache2 = "";
     aBorraCache3 = "";
     aAux3 = "";
     &enNumRegFlow = 0;
     &enSituFlow = 0;
     &eaDesSituFlow = "";

     aFicheroAdjuntoPDF = "";
     aNomAdjuntoPDF = "";
     aPathAdjPDF = "";

     aRespuesta = "";
     aError = "";
     nError = 0;
     aNombreTrae = "";
     nConta = 0;
     aValor = "";
     aFicheroTrae = "";

     aNomEnvia = "";
     aParaEnvio = "";
     aDirBaseLocal = "";
     &eaUnidad = "";
     aCuerpo = "";

     aUsuAuntenti = "";
     aPassAuntenti = "";
     aConfLectura = "";
     aReply = "";

     aEmailCotejo = "";
     aDestinoCorreo = "";
     nLinea = 0;
     nSitu = 0;
     aOriHis = "";
     aDesHis = "";
     nSalidaHis = 0;

     &eaTipoCorreo = "";           ||Sirve para distinguir cuando el correo
                                   ||es de tipo "nominas".
     aDirOrigenUsu = "";
     aUsuEnvio = "";

     aLogoFacturae = "";
     aMD5Ori = "";
     aMD5Des = "";
     aLong = "";
     nLong = 0;
     aFrase = "";
     nPosi = 0;
     aCarac = "";

     aEjecuta        = "";
     aAbreHTMO       = "";
     aAbreHTMD       = "";
     aAbreTXT        = "";
     aAbreTXTO       = "";
     aAbreTXTD       = "";
     aAbreFIN        = "";
     nHandle1        = 0;
     nHandle2        = 0;
     nHandle3        = 0;
     nHandleE        = 0;
     nRegilla        = 0;
     nLLave          = 0;
     aConten = "";
     aNLogo = "";
     aCarac10 = "";
     aFotoOrigen = "";
     aFicheroAdjunto = "";
     aFicheroAdjunto2 = "";
     aFicheroAdjunto3 = "";
     aFicheroAdjunto4 = "";
     aFicheroAdjunto5 = "";

     aBasePla = "";
     aBaseMensaje = "";

     &enAprobacion = 0;
     &eaPrograma = "";
     nGuarda = 0;
     nSwSMTPCLI = 0;
     nSwSMTPCLIAll = 0;                 ||Manda por SMTPCLI los correos normales. (SMTPCLITODOS)
     nSwDsEnviaCorreo = 0;
     &enSwNomina = 0;

     nSwHayAdjuntos = 0;
     aFicAdj1 = "";
     aFicAdj2 = "";
     aFicAdj3 = "";


     nSwTgzOk = 0;
     aNomSin = "";
     aFicTar = "";
     aBorra = "";

     aGuarda = "";
     aNomTgz = "";
     aNomAdjunto2 = "";
     aPathAdj2 = "";
     aDestinoTgz = "";
     aDirectorio = "";
     direc = "";

     aNomDoc = "";
     aNumDoc = "";
     aAutenti = "";
     aAux = "";
     aAux2 = "";
     aParametro = "";
     aHora = "";
     aUsuario = "";
     &eaDirDestino = "";
     nPanta1         = 0;
     nLen            = 0;
     nCampo          = 0;
     nCampo910       = 0;
     nPos            = 0;
     nHastaCampo     = 0;
     nHandle         = 0;
     nBoton1         = 0;
     nBoton2         = 0;
     nBoton3         = 0;
     nBoton4         = 0;
     nCarpeta        = 0;
     nVent1          = 0;
     nVent911        = 0;
     nVent977        = 0;
     nVtnGnrl        = 0;
     nCarac          = 0;
     nGrabaHistorico = 0;
     nCmp            = 0;

     aAlfa           = "";
     aAlfa1          = "";
     aAlfa2          = "";
     aDirec          = "";
     aFrom           = "";
     aTo             = "";
     aAsunto         = "";
     aMensaje        = "";
     aIPRemoto       = "";
     aSalida         = "";
     aAbre           = "";
     aOrigen         = "";
     aDestino        = "";
     aVersion1       = "";
     aVersion2       = "";
     aBase           = "";
     aCadena         = "";
     aLen            = "";
     aCaracter       = "";
     aBaseLocal      = "";
     aDeMail         = "";
     aDocumento      = "";
     aCliente        = "";
     aNomFichero     = "";
     aAdjunto        = "";
     aNomAdjunto     = "";
     aCarajo         = "";
     aIPLocal        = "";
     aQueSistema     = "";
     aIP             = "";
     aSmtp           = "";
     aDe             = "";
     aFichero        = "";
     aID             = "";
     aQueBoton       = "";
     aTexto1         = "";
     aTexto2         = "";
     aTexto3         = "";
     aTexto4         = "";
     aDirLocal       = "";
     aPrograma       = "";
     aPathDSSelect   = "";
     aParaIni        = "";
     aCarpetaCaptura = "";
     aTextoIni       = "";
     aPath           = "";
     aFich           = "";
     aProg           = "";
     aTextoFlow      = "";
     aPathAdjunto    = "";
     aFichAdjunto    = "";
     aCli            = "";
     aBass           = "";
     aMas            = "";
     aFic            = "";

     fFecha          = @;

     nRango          = 0;
     nGrid977        = 0;
     nBotonAceptar   = -1;
     nBotonCancelar  = -1;

     &enDocumento     = 0;
     &enErrorCorreo   = 0;
     &eaAlfa          = "";
     &eaClaveCorreo   = "";
     &eaClaveEntrante = "";

     {-1}aVent        = "";
         aVent1       = 0;
         aVent2       = 0;
         aVent3       = 0;
         aVent4       = 0;
         aVent5       = "";

     {1}aContiene    = "";
     {1}aLocal       = "";

     nMes = 0;
     aMes = "";
     &nDesdeMes = 0;
     &nHastaMes = 0;

     &eaRuta              = "";
     &enError             = 0;
     &eaDoc               = "";
     &efFecha             = @;

     &enEAgr             = 0;
     &enEEmp             = 0;
     &enEAlt             = 0;
     &enEEmpX            = 0;
     &enEAltX            = 0;
     &enEEmpL            = 0;
     &enEAltL            = 0;
     &enEObj             = 0;
     &efEObj             = @;
     &enEDia             = 0;
     &enEMed             = 0;
     &enEPor             = 0;
     &eaECta             = "";
     &eaAplicacion       = "";
     &eaEmpresaFE        = "";
     &eaCodCliFe         = "";
|FIN;

|PROCESO GrabaRegistro;
     |ABRE #dsarm005;
     #dsarm005#0 = enDocumento;
     |LEE 101#dsarm005.=;
     |SI FSalida = 0;
         #dsarm005#77 = aDeMail;
         #dsarm005#78 = aDestinoCorreo;
         #dsarm005#79 = ~;
         |HORA aHora;
         #dsarm005#80 = aHora;
         aUsuario = Usuario % 810;  |QBF aUsuario;
         #dsarm005#81 = aUsuario;
         #dsarm005#82 = "S";
         |GRABA 020#dsarm005.a;
         |LIBERA #dsarm005;
     |FINSI;
     |CIERRA #dsarm005;

     ||Historico

     |HORA aHora;
     aUsuario = Usuario % 810;
     |ABRE #flowm006;
     #flowm006#0  = #dsarm005#0;
     #flowm006#1  = 99999;
     |LEE 000#flowm006.];
     |SI FSalida = 0;
         |LEE 000#flowm006.a;
     |SINO;
         |LEE 000#flowm006.u;
     |FINSI;

     nSitu = 0;
     nLinea = 1;
     |SI FSalida = 0; |Y #flowm006#0  = #dsarm005#0;
         nLinea = #flowm006#1 + 1;
         nSitu = #flowm006#2;
     |FINSI;

     |DDEFECTO #flowm006;
     #flowm006#0  = #dsarm005#0;
     #flowm006#1  = nLinea;
     |LEE 101#flowm006.=;
     |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
     #flowm006#2  = nSitu;
     #flowm006#3  = ~;
     #flowm006#4  = aHora;
     #flowm006#5  = aUsuario;
     #flowm006#6  = aTextoFlow;

     enNumRegFlow = #flowm006#0;
     enSituFlow   = #flowm006#2;
     |HAZ DimeDesFlow;
     #flowm006#7 = eaDesSituFlow;

     |GRABA 020#flowm006.a;
     |LIBERA #flowm006;
     |CIERRA #flowm006;
|FPRC;

|PROCESO SacaMensaje;
     |PUSHV 0501 2380;
     |PINPA #0#dsarw093;
     |DDEFECTO #dsarw093;

     #dsarw093#0 = aTexto1;
     #dsarw093#1 = aTexto2;
     #dsarw093#2 = aTexto3;
     #dsarw093#3 = aTexto4;
     |PINDA #0#dsarw093;

     |PAUSA;
     |POPV;

     fFecha  = ~;

     |ABRE #dsarm066;
     #dsarm066#0 = fFecha;
     #dsarm066#1 = Usuario % 810;
     |LEE 101#dsarm066.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsarm066;
         #dsarm066#0 = fFecha;
         #dsarm066#1 = Usuario % 810;
         |GRABA 020#dsarm066.n;
         |LIBERA #dsarm066;
     |FINSI;
     |CIERRA #dsarm066;

     |ABRE #dsarm067;
     #dsarm067#0 = #dsarm066#0;
     #dsarm067#1 = #dsarm066#1;
     #dsarm067#2 = 99999;
     |LEE 000#dsarm067.];
     |SI FSalida = 0;
         |LEE 000#dsarm067.a;
     |SINO;
         |LEE 000#dsarm067.u;
     |FINSI;

     nLinea = 1;
     |SI FSalida = 0;  |Y #dsarm067#0 = #dsarm066#0;
                       |Y #dsarm067#1 = #dsarm066#1;
         nLinea = #dsarm067#2 + 1;
     |FINSI;

     |DDEFECTO #dsarm067;
     #dsarm067#0 = #dsarm066#0;
     #dsarm067#1 = #dsarm066#1;
     #dsarm067#2 = nLinea;
     #dsarm067#3 = aTexto1;
     #dsarm067#4 = aTexto2;
     #dsarm067#5 = aTexto3;
     |GRABA 020#dsarm067.n;
     |LIBERA #dsarm067;
     |CIERRA #dsarm067;

     aTexto1 = "";
     aTexto2 = "";
     aTexto3 = "";
     aTexto4 = "";
|FPRC;

|PROCESO Tipo0C39_w010;
     |SI aSacaWebMail = "S";
          |SI #dsarw010#39 = "S";
               |C_M #dsarw010#41, 1, "N";
               #dsarw010#41 = ".";
               |PARA nVoy = 42; |SI nVoy [ 139; |HACIENDO nVoy = nVoy + 1;
                    #dsarw010#nVoy# = "";
               |SIGUE;
               |PINTA #dsarw010#41;
          |SINO;
               |C_M #dsarw010#41, 1, "S";
               |PINTA #dsarw010#41;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MeteTextoAdjSMTPCLI;
     nHastaCampo = 0;
     |PARA nCampo = 109;  |SI nCampo ] 11;  |HACIENDO nCampo = nCampo - 1;
           aAlfa = #dsarm064#nCampo#;  |QBF aAlfa;
           |SI aAlfa ! "";
               nHastaCampo = nCampo;
               |SAL;
           |FINSI;
     |SIGUE;



     |SI nHastaCampo = 0;
         aAlfa   = "" + &13 + &10;
         eaAlfa = aAlfa;
         |HAZ GrabaCuerpo;
     |SINO;
          nHayBarraEne = 0;
          |PARA nCampo = 11;  |SI nCampo [ nHastaCampo;  |HACIENDO nCampo = nCampo + 1;
               aAlfa = #dsarm064#nCampo#;  |QBF aAlfa;
               |SI aAlfa ! "";
                    aQuitaEne = aAlfa - "\n";
                    |SI aQuitaEne ! aAlfa;
                         nHayBarraEne = 1;
                         |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;

          |PARA nCampo = 11;  |SI nCampo [ nHastaCampo;  |HACIENDO nCampo = nCampo + 1;
               ||ATENCION. NO PONER EL QUITARAROS, PQ. QUITA LOS ACENTOS
               eaAlfa  = #dsarm064#nCampo#;


               |SI nHayBarraEne = 0;
                    |HAZ GrabaCuerpo;
               |SINO;
                    |HAZ GrabaCuerpoBarraEne;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO Sustituye;
     nPosicion = FSalida;

     aTrozo1    = "";
     aTrozo2    = "";
     aAlfa1     = ("0000" + nPosicion) % -104;
     aAlfa2     = aAlfa1 % 102;
     aAlfa3     = aAlfa1 % 302;
     nPos1      = aAlfa2;
     nPos2      = aAlfa3;
     nPosTrozo1 = 100 + (nPos1 - 1);
     nPosTrozo2 = ((nPos1 + nPos2) * 100) + 80;

     aTrozo2 = aCadena % nPosTrozo2;

     |SI nPosTrozo1 ! 100;
         aTrozo1 = aCadena % nPosTrozo1;
     |FINSI;

     |SI aBusco = "#SERIE#";
         aCadena = aTrozo1 + aSer;
     |FINSI;

     |SI aBusco = "#NUMFAC#";
         aCadena = aTrozo1 + aFac;
     |FINSI;

     |SI aBusco = "#FECHAFAC#";
         aCadena = aTrozo1 + aFFa;
     |FINSI;

     |SI aBusco = "#IMPORTEFAC#";
         aCadena = aTrozo1 + aIFa;
     |FINSI;

     |SI aBusco = "#FECHAVTO#";
         aCadena = aTrozo1 + aFVe;
     |FINSI;

     |SI aBusco = "#IMPORTEVTO#";
         aCadena = aTrozo1 + aIVe;
     |FINSI;

     |SI aBusco = "#IBAN#";
         aCadena = aTrozo1 + aIBAN;
     |FINSI;

     |SI aBusco = "#RAZONSOCIAL#";
         aCadena = aTrozo1 + aRazonSocial;
     |FINSI;

     aCadena = aCadena + aTrozo2;
|FPRC;

|PROCESO PonVariables;
     aCadena = eaAlfa;

     |PARA;  |SI;  |HACIENDO;
          nBusca  = 0;
          aBusco  = "#SERIE#";
          aBusca  = aCadena - aBusco;
          |SI FSalida ! 0;  |HAZ Sustituye;  nBusca = 1;  |FINSI;

          aBusco  = "#NUMFAC#";
          aBusca  = aCadena - aBusco;
          |SI FSalida ! 0;  |HAZ Sustituye;  nBusca = 1;  |FINSI;

          aBusco  = "#FECHAFAC#";
          aBusca  = aCadena - aBusco;
          |SI FSalida ! 0;  |HAZ Sustituye;  nBusca = 1;  |FINSI;

          aBusco  = "#IMPORTEFAC#";
          aBusca  = aCadena - aBusco;
          |SI FSalida ! 0;  |HAZ Sustituye;  nBusca = 1;  |FINSI;

          aBusco  = "#FECHAVTO#";
          aBusca  = aCadena - aBusco;
          |SI FSalida ! 0;  |HAZ Sustituye;  nBusca = 1;  |FINSI;

          aBusco  = "#IMPORTEVTO#";
          aBusca  = aCadena - aBusco;
          |SI FSalida ! 0;  |HAZ Sustituye;  nBusca = 1;  |FINSI;

          aBusco  = "#IBAN#";
          aBusca  = aCadena - aBusco;
          |SI FSalida ! 0;  |HAZ Sustituye;  nBusca = 1;  |FINSI;

          aBusco  = "#RAZONSOCIAL#";
          aBusca  = aCadena - aBusco;
          |SI FSalida ! 0;  |HAZ Sustituye;  nBusca = 1;  |FINSI;

          |SI nBusca = 0;  |SAL;  |FINSI;
     |SIGUE;

     eaAlfa = aCadena;
|FPRC;

|PROCESO GrabaCuerpoBarraEne;
     |HAZ PonVariables;
     |HAZ QuitaRarosCorreo;

     |SI eaAlfa ! "";
          aQuitaEne = eaAlfa - "\n";
          |SI aQuitaEne ! eaAlfa;
               aNuevaAlfa = "";
               aLong = eaAlfa % A0;
               nLong = aLong;
               |PARA nVoy = 1; |SI nVoy < nLong; |HACIENDO nVoy = nVoy + 1;
                    aSaca = nVoy + "02";
                    aDosLetras = eaAlfa % aSaca;
                    |SI aDosLetras = "\n";
                         aNuevaAlfa = aNuevaAlfa + "<br>" + &10;
                         nVoy = nVoy + 1;
                    |SINO;
                         aLetra = aDosLetras % 101;
                         nLongMenosUno = nLong - 1;
                         |SI nVoy = nLongMenosUno;
                              aNuevaAlfa = aNuevaAlfa + aDosLetras;
                         |SINO;
                              aNuevaAlfa = aNuevaAlfa + aLetra;
                         |FINSI;
                    |FINSI;
               |SIGUE;
               eaAlfa = aNuevaAlfa;
          |FINSI;
          |XGRABA nHandle, eaAlfa;
     |FINSI;
|FPRC;

|PROCESO MeteTextoAdjBLAT;
     |SI eaTipoCorreo = "nominas";
          nHastaCampo = 0;
          |PARA nCampo = 109;  |SI nCampo ] 11;  |HACIENDO nCampo = nCampo - 1;
                aAlfa = #dsarm064#nCampo#;  |QBF aAlfa;
                |SI aAlfa ! "";
                    nHastaCampo = nCampo;
                    |SAL;
                |FINSI;
          |SIGUE;

          |SI nHastaCampo = 0;
              aAlfa   = "" + &13 + &10;
              eaAlfa = aAlfa;
              |HAZ GrabaCuerpo;
          |SINO;
              |PARA nCampo = 11;  |SI nCampo [ nHastaCampo;  |HACIENDO nCampo = nCampo + 1;
                    ||ATENCION. NO PONER EL QUITARAROS, PQ. QUITA LOS ACENTOS
                    eaAlfa  = #dsarm064#nCampo#;
                    |HAZ GrabaCuerpo;
              |SIGUE;
          |FINSI;
     |SINO;
          nHastaCampo = 0;
          |PARA nCampo = 109;  |SI nCampo ] 11;  |HACIENDO nCampo = nCampo - 1;
                aAlfa = #dsarm064#nCampo#;  |QBF aAlfa;
                |SI aAlfa ! "";
                    nHastaCampo = nCampo;
                    |SAL;
                |FINSI;
          |SIGUE;

          |SI nHastaCampo = 0;
              aAlfa   = "" + &13 + &10;
              eaAlfa = aAlfa;
              |HAZ GrabaCuerpo;
          |SINO;
              |PARA nCampo = 11;  |SI nCampo [ nHastaCampo;  |HACIENDO nCampo = nCampo + 1;
                    ||ATENCION. NO PONER EL QUITARAROS, PQ. QUITA LOS ACENTOS
                    eaAlfa  = #dsarm064#nCampo#;
                    |HAZ GrabaCuerpo;
              |SIGUE;
          |FINSI;
     |FINSI;
|FPRC;


|PROCESO GrabaCuerpoDos;
     |HAZ PonVariables;
     |HAZ QuitaRarosCorreo;
     |QBF eaAlfa;
     aAlfa  = eaAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO MeteTextoAdj;
     ||ARA55
     ||ATENCION. NO PONER EL QUITARAROS, PQ. QUITA LOS ACENTOS
     ||VOY A VER QUE HACE EL QUITARAROS. CCC. Pongo QuitaRarosCorreo.
     |SI eaTipoCorreo = "nominas";
          nHastaCampo = 0;
          |PARA nCampo = 109;  |SI nCampo ] 11;  |HACIENDO nCampo = nCampo - 1;
                aAlfa = #dsarm064#nCampo#;  |QBF aAlfa;
                |SI aAlfa ! "";
                    nHastaCampo = nCampo;
                    |SAL;
                |FINSI;
          |SIGUE;

          |SI nHastaCampo = 0;
              eaAlfa = "";
              |HAZ GrabaCuerpoDos;
          |SINO;
              |PARA nCampo = 11;  |SI nCampo [ nHastaCampo;  |HACIENDO nCampo = nCampo + 1;
                    ||ATENCION. NO PONER EL QUITARAROS, PQ. QUITA LOS ACENTOS
                    eaAlfa  = #dsarm064#nCampo#;
                    |HAZ GrabaCuerpoDos;
              |SIGUE;
          |FINSI;
     |SINO;
          nHastaCampo = 0;
          |PARA nCampo = 109;  |SI nCampo ] 11;  |HACIENDO nCampo = nCampo - 1;
                aAlfa = #dsarm064#nCampo#;  |QBF aAlfa;
                |SI aAlfa ! "";
                    nHastaCampo = nCampo;
                    |SAL;
                |FINSI;
          |SIGUE;

          |SI nHastaCampo = 0;
              eaAlfa = "";
              |HAZ GrabaCuerpoDos;
          |SINO;
              |PARA nCampo = 11;  |SI nCampo [ nHastaCampo;  |HACIENDO nCampo = nCampo + 1;
                    ||ATENCION. NO PONER EL QUITARAROS, PQ. QUITA LOS ACENTOS
                    eaAlfa  = #dsarm064#nCampo#;
                    |HAZ GrabaCuerpoDos;
              |SIGUE;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CargaTextoSMTPCLI;
     |SI #dsarm064#7 = "S"; |Y eaTipoCorreo = "nominas";
          |HAZ MeteTextoAdjSMTPCLI;
     |SINO;
          |SI #dsarm064#7 = "I";
               |HAZ MeteTextoAdjSMTPCLI;
          |FINSI;
     |FINSI;

     nHastaCampo = 0;
     |PARA nCampo = 139;  |SI nCampo ] 41;  |HACIENDO nCampo = nCampo - 1;
           aAlfa = #dsarw010#nCampo#;  |QBF aAlfa;
           |SI aAlfa ! "";
               nHastaCampo = nCampo;
               |SAL;
           |FINSI;
     |SIGUE;

     |SI nHastaCampo = 0;
         aAlfa   = "" + &13 + &10;
         eaAlfa = aAlfa;
         |HAZ GrabaCuerpo;
     |SINO;
         |PARA nCampo910 = 41;  |SI nCampo910 [ nHastaCampo;  |HACIENDO nCampo910 = nCampo910 + 1;
               ||ATENCION. NO PONER EL QUITARAROS, PQ. QUITA LOS ACENTOS
               eaAlfa  = #dsarw010#nCampo910#;
               |HAZ GrabaCuerpo;
         |SIGUE;
     |FINSI;

     |SI #dsarm005#89 = "S"; |Y #dsarm064#111 = "S";
          ||XML FACTURAE...  AHORA EL .XML y .HTML

          eaAlfa = "Adjunta Factura en formato FacturaE (XML), para su validación fiscal.";
          |HAZ GrabaCuerpo;

          eaAlfa = "";
          |HAZ GrabaCuerpo;

          aAux = #dsarm005#92;
          |QBF aAux;
          |SI aAux ! "";
               eaAlfa = "Además también se incluye la misma factura pero en formato visible a través de su navegador (HTML).";
               |HAZ GrabaCuerpo;

               eaAlfa = "";
               |HAZ GrabaCuerpo;
          |FINSI;

          aAux = #dsarm005#96;
          |QBF aAux;
          |SI aAux ! "";
               eaAlfa = "También se incluye la misma factura pero en formato PDF.";
               |HAZ GrabaCuerpo;

               eaAlfa = "";
               |HAZ GrabaCuerpo;
          |FINSI;

          eaAlfa = "Desde <a href=" + &34 + "http://www.diagram.es" + &34 + ">http://www.diagram.es</a> le ofrecemos estas direcciones de interés relacionadas con la FacturaE:";
          |HAZ GrabaCuerpo;

          eaAlfa = "";
          |HAZ GrabaCuerpo;

          eaAlfa = "Servicio de validación de facturas electrónicas.";
          |HAZ GrabaCuerpo;

          eaAlfa = "<a href=" + &34 + "http://sedeaplicaciones2.minetur.gob.es/FacturaE/" + &34 + ">http://sedeaplicaciones2.minetur.gob.es/FacturaE/</a>";
          |HAZ GrabaCuerpo;

          eaAlfa = "";
          |HAZ GrabaCuerpo;

          eaAlfa = "Página oficial sobre Factura Electrónica.";
          |HAZ GrabaCuerpo;

          eaAlfa = "<a href=" + &34 + "http://www.facturae.es/" + &34 + ">http://www.facturae.es/</a>";
          |HAZ GrabaCuerpo;

          eaAlfa = "";
          |HAZ GrabaCuerpo;

          eaAlfa = "Página oficial Agencia Tributaria.";
          |HAZ GrabaCuerpo;

          eaAlfa = "<a href=" + &34 + "http://www.agenciatributaria.es/AEAT.internet/Inicio_es_ES/"
          |XGRABA nHandle, eaAlfa;

          eaAlfa = "_Segmentos_/Empresas_y_profesionales/Empresas/IVA/Obligaciones_de_facturacion/e_factura/e_factura.shtml" + &34;
          |XGRABA nHandle, eaAlfa;

          eaAlfa = ">http://www.agenciatributaria.es/AEAT.internet/Inicio_es_ES";
          |XGRABA nHandle, eaAlfa;

          eaAlfa = "/_Segmentos_/Empresas_y_profesionales/Empresas/IVA/Obligaciones_de_facturacion/e_factura/e_factura.shtml</a>";
          |HAZ GrabaCuerpo;
     |FINSI;

     |SI #dsarm064#7 = "F";
          |HAZ MeteTextoAdjSMTPCLI;
     |FINSI;
|FPRC;

|PROCESO CargaTextoBLAT;
     |SI #dsarm005#89 = "S";
          |SI #dsarm064#7 = "I";
               |HAZ MeteTextoAdjBLAT;
          |FINSI;
     |SINO;
          |SI #dsarm064#7 = "S"; |Y eaTipoCorreo = "nominas";
               |HAZ MeteTextoAdjBLAT;
          |FINSI;
     |FINSI;

     nHastaCampo = 0;
     |PARA nCampo = 139;  |SI nCampo ] 41;  |HACIENDO nCampo = nCampo - 1;
           aAlfa = #dsarw010#nCampo#;  |QBF aAlfa;
           |SI aAlfa ! "";
               nHastaCampo = nCampo;
               |SAL;
           |FINSI;
     |SIGUE;

     |SI nHastaCampo = 0;
         aAlfa   = "" + &13 + &10;
         eaAlfa = aAlfa;
         |HAZ GrabaCuerpo;
     |SINO;
         |PARA nCampo910 = 41;  |SI nCampo910 [ nHastaCampo;  |HACIENDO nCampo910 = nCampo910 + 1;
               ||ATENCION. NO PONER EL QUITARAROS, PQ. QUITA LOS ACENTOS
               eaAlfa  = #dsarw010#nCampo910#;
               |HAZ GrabaCuerpo;
         |SIGUE;
     |FINSI;

     |SI #dsarm005#89 = "S"; |Y #dsarm064#111 = "S";
          ||XML FACTURAE...  AHORA EL .XML y .HTML

          eaAlfa = "Adjunta Factura en formato FacturaE (XML), para su validación fiscal.";
          |HAZ GrabaCuerpo;

          eaAlfa = "";
          |HAZ GrabaCuerpo;

          aAux = #dsarm005#92;
          |QBF aAux;
          |SI aAux ! "";
               eaAlfa = "Además también se incluye la misma factura pero en formato visible a través de su navegador (HTML).";
               |HAZ GrabaCuerpo;

               eaAlfa = "";
               |HAZ GrabaCuerpo;
          |FINSI;

          aAux = #dsarm005#96;
          |QBF aAux;
          |SI aAux ! "";
               eaAlfa = "También se incluye la misma factura pero en formato PDF.";
               |HAZ GrabaCuerpo;

               eaAlfa = "";
               |HAZ GrabaCuerpo;
          |FINSI;

          eaAlfa = "Desde <a href=" + &34 + "http://www.diagram.es" + &34 + ">http://www.diagram.es</a> le ofrecemos estas direcciones de interés relacionadas con la FacturaE:";
          |HAZ GrabaCuerpo;

          eaAlfa = "";
          |HAZ GrabaCuerpo;

          eaAlfa = "Servicio de validación de facturas electrónicas.";
          |HAZ GrabaCuerpo;

          eaAlfa = "<a href=" + &34 + "http://sedeaplicaciones2.minetur.gob.es/FacturaE/" + &34 + ">http://sedeaplicaciones2.minetur.gob.es/FacturaE/</a>";
          |HAZ GrabaCuerpo;

          eaAlfa = "";
          |HAZ GrabaCuerpo;

          eaAlfa = "Página oficial sobre Factura Electrónica.";
          |HAZ GrabaCuerpo;

          eaAlfa = "<a href=" + &34 + "http://www.facturae.es/" + &34 + ">http://www.facturae.es/</a>";
          |HAZ GrabaCuerpo;

          eaAlfa = "";
          |HAZ GrabaCuerpo;

          eaAlfa = "Página oficial Agencia Tributaria.";
          |HAZ GrabaCuerpo;

          eaAlfa = "<a href=" + &34 + "http://www.agenciatributaria.es/AEAT.internet/Inicio_es_ES/"
          |XGRABA nHandle, eaAlfa;

          eaAlfa = "_Segmentos_/Empresas_y_profesionales/Empresas/IVA/Obligaciones_de_facturacion/e_factura/e_factura.shtml" + &34;
          |XGRABA nHandle, eaAlfa;

          eaAlfa = ">http://www.agenciatributaria.es/AEAT.internet/Inicio_es_ES";
          |XGRABA nHandle, eaAlfa;

          eaAlfa = "/_Segmentos_/Empresas_y_profesionales/Empresas/IVA/Obligaciones_de_facturacion/e_factura/e_factura.shtml</a>";
          |HAZ GrabaCuerpo;
     |FINSI;

     |SI #dsarm005#89 = "S";
          |SI #dsarm064#7 = "F";
               |HAZ MeteTextoAdjBLAT;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CargaTexto;
     aAbre    = aBase + "documentos/correos";  |MKDIR aAbre;
     aAbre    = aAbre + "/adjunto.txt";
     |XABRE "WB", aAbre, nHandle;

     |SI #dsarm005#89 = "S";
          |SI #dsarm064#7 = "I";
               |HAZ MeteTextoAdj;
          |FINSI;
     |SINO;
          |SI eaTipoCorreo = "nominas"; |Y #dsarm064#7 = "S";
               |HAZ MeteTextoAdj;
          |FINSI;
     |FINSI;

     nHastaCampo = 0;
     |PARA nCampo = 139;  |SI nCampo ] 41;  |HACIENDO nCampo = nCampo - 1;
           aAlfa = #dsarw010#nCampo#;  |QBF aAlfa;
           |SI aAlfa ! "";
               nHastaCampo = nCampo;
               |SAL;
           |FINSI;
     |SIGUE;

     |SI nHastaCampo = 0;
         aAlfa   = "" + &13 + &10;
         |XGRABA nHandle, aAlfa;
     |SINO;
         |PARA nCampo910 = 41;  |SI nCampo910 [ nHastaCampo;  |HACIENDO nCampo910 = nCampo910 + 1;
               ||ATENCION. NO PONER EL QUITARAROS, PQ. QUITA LOS ACENTOS
               eaAlfa  = #dsarw010#nCampo910#;
               aAlfa  = eaAlfa + &13 + &10;
               |XGRABA nHandle, aAlfa;
         |SIGUE;
     |FINSI;

     |SI #dsarm005#89 = "S"; |Y #dsarm064#111 = "S";
          ||XML FACTURAE...  NORMALMENTE UN .TGZ con el .XML y .HTML
          ||SI ESTA FIRMADA EL FORMATO SERA .XSIG

          eaAlfa = "Se le adjunta un archivo comprimido que contiene la factura correspondiente";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          eaAlfa = "al asunto en formato FacturaE (XML o XSIG), para su validación fiscal.";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          eaAlfa = "";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          aAux = #dsarm005#92;
          |QBF aAux;
          |SI aAux ! "";
               eaAlfa = "Además también se incluye la misma factura pero en formato visible a";
               aAlfa  = eaAlfa + &13 + &10;
               |XGRABA nHandle, aAlfa;
               eaAlfa = "través de su navegador (HTML).";
               aAlfa  = eaAlfa + &13 + &10;
               |XGRABA nHandle, aAlfa;
               eaAlfa = "";
               aAlfa  = eaAlfa + &13 + &10;
               |XGRABA nHandle, aAlfa;
          |FINSI;

          aAux = #dsarm005#96;
          |QBF aAux;
          |SI aAux ! "";
               eaAlfa = "También se incluye la misma factura pero en formato PDF";
               aAlfa  = eaAlfa + &13 + &10;
               |XGRABA nHandle, aAlfa;
               eaAlfa = "";
               aAlfa  = eaAlfa + &13 + &10;
               |XGRABA nHandle, aAlfa;
          |FINSI;

          eaAlfa = "Desde http://www.diagram.es le ofrecemos estas direcciones de interés";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          eaAlfa = "relacionadas con la FacturaE:";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          eaAlfa = "";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          eaAlfa = "Validación de facturas electrónicas Mityc. Ministerio de Industria,";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          eaAlfa = "Turismo y Comercio.";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          eaAlfa = "http://sedeaplicaciones2.minetur.gob.es/FacturaE/";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          eaAlfa = "";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          eaAlfa = "Página oficial sobre Factura Electrónica.";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          eaAlfa = "http://www.facturae.es/";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          eaAlfa = "";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          eaAlfa = "Página oficial Agencia Tributaria.";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;

          eaAlfa = "http://www.agenciatributaria.es/AEAT.internet/Inicio_es_ES/"
          |XGRABA nHandle, eaAlfa;

          eaAlfa = "_Segmentos_/Empresas_y_profesionales/Empresas/IVA/Obligaciones_de_facturacion/e_factura/e_factura.shtml";
          aAlfa  = eaAlfa + &13 + &10;
          |XGRABA nHandle, aAlfa;
     |FINSI;

     |SI #dsarm005#89 = "S";
          |SI #dsarm064#7 = "F";
               |HAZ MeteTextoAdj;
          |FINSI;
     |FINSI;

     |XCIERRA nHandle;
|FPRC;

|PROCESO CorreoEnUnix;
     aAlfa = #dsarw010#18;  |QBF aAlfa;
     |SI aAlfa ! aIPRemoto;  |ACABA;  |FINSI;

     |ESPECIFICA "RBASS", aLocal;
     aBaseLocal = aLocal;

     aDestino   = aBaseLocal + "bin/dscorreo.exe";
     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aVersion1  = FSalida;  |QBF aVersion1;

     |DBASE aBase;  |QBF aBase;
     aOrigen    = aBase + "dlls/dscorreo.exe";
     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aVersion2  = FSalida;  |QBF aVersion2;

     |SI aVersion1 ! aVersion2;
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aAlfa  = "cmd " + &34 + "/c START /MIN " + aDestino + &34;
     |RSYSTEM aAlfa;

     |MENSA "         ";
     |PULSATECLA;
     |SLEEP 1;
|FPRC;

|PROCESO CorreoEnDos;
     |SI aIPRemoto ! "";  |ACABA;  |FINSI;

     |IP_LOCAL aIPLocal;
     |QBF aIPLocal;

     aAlfa = #dsarw010#18;  |QBF aAlfa;
     |SI aAlfa ! aIPLocal;  |ACABA;  |FINSI;

     |DBASE aBase;  |QBF aBase;
     aOrigen    = aBase + "dlls/dscorreo.exe";

     aAlfa  = "cmd " + &34 + "/c START /MIN " + aOrigen + &34;
     |SYSTEM aAlfa;

     |MENSA "         ";
     |PULSATECLA;
     |SLEEP 1;
|FPRC;

|PROCESO MiraSiCodigoEspecial;
     aCodEspecial = "";
     aLong = aDos % A0;
     nLong = aLong;
     |SI nLong = 2;
          aLetra1 = aDos % 101;
          aLetra2 = aDos % 201;
          nAscii1 = &aLetra1;
          nAscii2 = &aLetra2;

          ||A
          |SI nAscii1 = 195; |Y nAscii2 = 128; aCodEspecial = "&Agrave;"; nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 129; aCodEspecial = "&Aacute;"; nSwCodEspecial = 1; |FINSI;

          ||C trencada
          |SI nAscii1 = 195; |Y nAscii2 = 135; aCodEspecial = "&Ccedil;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 167; aCodEspecial = "&ccedil;";  nSwCodEspecial = 1; |FINSI;

          ||E
          |SI nAscii1 = 195; |Y nAscii2 = 136; aCodEspecial = "&Egrave;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 137; aCodEspecial = "&Eacute;";  nSwCodEspecial = 1; |FINSI;

          ||I
          |SI nAscii1 = 195; |Y nAscii2 = 140; aCodEspecial = "&Igrave;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 141; aCodEspecial = "&Iacute;";  nSwCodEspecial = 1; |FINSI;

          ||¥  Enye
          |SI nAscii1 = 195; |Y nAscii2 = 145; aCodEspecial = "&Ntilde;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 177; aCodEspecial = "&ntilde;";  nSwCodEspecial = 1; |FINSI;

          ||O
          |SI nAscii1 = 195; |Y nAscii2 = 146; aCodEspecial = "&Ograve;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 147; aCodEspecial = "&Oacute;";  nSwCodEspecial = 1; |FINSI;

          ||U
          |SI nAscii1 = 195; |Y nAscii2 = 153; aCodEspecial = "&Ugrave;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 154; aCodEspecial = "&Uacute;";  nSwCodEspecial = 1; |FINSI;

          ||U dieresis
          |SI nAscii1 = 195; |Y nAscii2 = 156; aCodEspecial = "&Uuml;";  nSwCodEspecial = 1; |FINSI;

          ||a
          |SI nAscii1 = 195; |Y nAscii2 = 160; aCodEspecial = "&agrave;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 161; aCodEspecial = "&aacute;";  nSwCodEspecial = 1; |FINSI;

          ||e
          |SI nAscii1 = 195; |Y nAscii2 = 168; aCodEspecial = "&egrave;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 169; aCodEspecial = "&eacute;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 171; aCodEspecial = "&euml;";    nSwCodEspecial = 1; |FINSI;

          ||i
          |SI nAscii1 = 195; |Y nAscii2 = 172; aCodEspecial = "&igrave;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 173; aCodEspecial = "&iacute;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 174; aCodEspecial = "&icirc;";   nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 175; aCodEspecial = "&iuml;";    nSwCodEspecial = 1; |FINSI;

          ||o
          |SI nAscii1 = 195; |Y nAscii2 = 178; aCodEspecial = "&ograve;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 179; aCodEspecial = "&oacute;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 182; aCodEspecial = "&ouml;";    nSwCodEspecial = 1; |FINSI;

          ||u
          |SI nAscii1 = 195; |Y nAscii2 = 185; aCodEspecial = "&ugrave;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 186; aCodEspecial = "&uacute;";  nSwCodEspecial = 1; |FINSI;
          |SI nAscii1 = 195; |Y nAscii2 = 188; aCodEspecial = "&uuml;";    nSwCodEspecial = 1; |FINSI;

          |SI nSwCodEspecial = 0;
               aLong = aTres % A0;
               nLong = aLong;
               |SI nLong = 3;
                    aLetra1 = aTres % 101;
                    aLetra2 = aTres % 201;
                    aLetra3 = aTres % 301;
                    nAscii1 = &aLetra1;
                    nAscii2 = &aLetra2;
                    nAscii3 = &aLetra3;


                    ||ATENCION, si se ponen mas controlar que no se meta se grabe el caracter.
                    ||Lo importante son los 2 primeros, si cambian, se deben controlar

                    ||--
                    |SI nAscii1 = 226; |Y nAscii2 = 128; |Y nAscii3 = 147; aCodEspecial = "&mdash;";    nSwCodEspecial = 1; |FINSI;
                    ||Left single quotation mark
                    |SI nAscii1 = 226; |Y nAscii2 = 128; |Y nAscii3 = 152; aCodEspecial = "&lsquo;";    nSwCodEspecial = 1; |FINSI;
                    ||Right single quotation mark
                    |SI nAscii1 = 226; |Y nAscii2 = 128; |Y nAscii3 = 153; aCodEspecial = "&rsquo;";    nSwCodEspecial = 1; |FINSI;

                    || " y "  (derecha e izquierda)
                    |SI nAscii1 = 226; |Y nAscii2 = 156; |Y nAscii3 = 153; aCodEspecial = "&ldquo;";    nSwCodEspecial = 1; |FINSI;
                    |SI nAscii1 = 226; |Y nAscii2 = 157; |Y nAscii3 = 153; aCodEspecial = "&rdquo;";    nSwCodEspecial = 1; |FINSI;
               |FINSI;
          |FINSI;

     |FINSI;
|FPRC;

|PROCESO NomalizaUTF8;
     ||Tenemos el problema que en el webmail y el outlook,
     ||aunque definamos que el html es UTF-8, no se entera
     ||entonces lo que vamos a hacer es sustituir los caracteres
     ||problematicos, por su equivalente en html
     || la a acentuada por &aacute;  .. etc

     aAbreTXTD = aFicheroWebMail + ".corregido";
     aAbreTXTO = aFicheroWebMail;

     |XABRE "WB", aAbreTXTD, nHandle1;
     |XABRE "AB", aAbreTXTO, nHandle2;

     aCarac10 = &10;

     ||ARA38
     aDos = "";
     aTres = "";
     aAlfaAnt = "";
     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
          |SI nSwEsUTF8 = 1;
               aTres = aDos;
               aDos = aDos % -101;
               aDos = aDos + aAlfa;
               aTres = aTres + aAlfa;
               nSwCodEspecial = 0;
               |HAZ MiraSiCodigoEspecial;
               |SI nSwCodEspecial = 0;
                    aGraba = aAlfaAnt;
                    aAlfaAnt = aAlfa;
               |SINO;
                    aGraba = aCodEspecial;
                    aDos = "";
                    aTres = "";
                    aAlfaAnt = "";
               |FINSI;
               |SI aGraba ! "";
                    nAscii1 = &aGraba;
                    nAscii2 = &aAlfaAnt;
                    |SI nAscii1 ! 226; |Y nAscii2 ! 128;
                         |XGRABA nHandle1, aGraba;
                    |FINSI;
               |FINSI;
               |XLEE nHandle2, 1, aAlfa;
          |SINO;
               aConten = aConten + aAlfa;
               |SI aAlfa = aCarac10;
                    aAlfa1 = aConten < aConten;
                    aAlfa1 = aAlfa1 - "charset=";
                    |SI FSalida ! 0;
                         aAlfa1 = aAlfa1 < aAlfa1;
                         aAlfa1 = aAlfa1 - "utf-8";
                         |SI FSalida ! 0;
                              nSwEsUTF8 = 1;
                         |SINO;
                              |SAL;
                         |FINSI;
                     |FINSI;
                     |XGRABA nHandle1, aConten;
                     aConten = "";
                    ||ARA38
                 |FINSI;
                 |XLEE nHandle2, 1, aAlfa;
            |FINSI;
     |SIGUE;
     aGraba = aAlfaAnt;
     |SI aGraba ! "";
          |XGRABA nHandle1, aGraba;
     |FINSI;

     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     |SI nSwEsUTF8 = 1;
          ||Falta copia uno por el otro.

          |COPIA_FICHERO aAbreTXTD, aAbreTXTO
     |FINSI;
|FPRC;

|PROCESO Ventana913;
     |SI aParametro = "AUTODESDED9";        |ACABA;  |FINSI;
     |SI aParametro = "ENVIAAVISODIAGRAM";  |ACABA;  |FINSI;
     |SI aParametro = "ENVIA_DPNTY001";     |ACABA;  |FINSI;

     |VENTANA 0501, 2799, -1, 1, "";
     nVent1   = FSalida;

     |PINPA #0#dsarw013;
     |PINDA #0#dsarw013;

     |PTEC 802;  |PAUSA;
|FPRC;

|PROCESO FinVentana;
     |SI aParametro = "AUTODESDED9";        |ACABA;  |FINSI;
     |SI aParametro = "ENVIAAVISODIAGRAM";  |ACABA;  |FINSI;
     |SI aParametro = "ENVIA_DPNTY001";      |ACABA;  |FINSI;

     |FINVENTANA nVent1;
|FPRC;

|PROCESO MandaWebMailSMTPCli;
     |HAZ Ventana913;

     |DBASE aBasePla;  |QBF aBasePla;
     aBaseMensaje = aBasePla + "dscorreo/";
     aBasePlugins = aBasePla + "plugins/";

     eaAlfa = #dsarw010#3;
     |QBF eaAlfa;
     |HAZ QuitaRarosCorreo;
     aAsunto  = eaAlfa; |QBF aAsunto;

     aDeMail = #dsarm064#114; |QBF aDeMail;
     |SI aDeMail = "";
         aDeMail = #dsarw010#1; |QBF aDeMail;
     |FINSI;

     |LEE 000#dsarw077.p;
     |SI FSalida = 0;
         aDestinoCorreo = #dsarw077#0;   |QBF aDestinoCorreo;
     |FINSI;

     |SI enDocumento ! 0;
         aFich = #dsarm005#9;
         aPath = #dsarm005#7;
     |SINO;
         aFich = aFichAdjunto;
         aPath = aPathAdjunto;
     |FINSI;

     ||Los adjuntos.
     |DBASE aBase;  |QBF aBase;
     aAlfa     = aFich;   |QBF aAlfa;
     |SI aAlfa = "";
         aMensaje = "0000Nombre documento vacio";
         |MENAV aMensaje;
     |FINSI;

     aFichero = aPath;   |QBF aFichero;
     aFichero = aFichero + aFich;
     |QBF aFichero;

     aDestino = aBase + "dscorreo";     |MKDIR aDestino;
     aDestino = aDestino + "/" + aFich;  |QBF aDestino;
     aOrigen  = aFichero;
     |HAZ CopiaOrigenDestino;
     aFicheroWebMail = aDestino;

     nSwEsUTF8 = 0;
     |HAZ NomalizaUTF8;

     |HAZ EjecutaShellWebMailing;

     |SI enDocumento ! 0;
         aTextoFlow = "ENVIADO [" + nSalidaHis + "] WEBMAILING A " + aDestinoCorreo;
         |HAZ GrabaRegistro;
     |FINSI;

     |HAZ FinVentana;
|FPRC;

|PROCESO dsarw088_HisEnv;
     aAuxEstado = #dsarw088#2;
     |QBF aAuxEstado;
     |SI aAuxEstado ! "PEND."; |ACABA; |FINSI;

     #dsarm005#0 = #dsarw088#1;
     |LEE 000#dsarm005.=;
     |SI FSalida = 0;
          |HAZ MeteHisEnvLin;
     |FINSI;
|FPRC;

|DEFBUCLE dsarw088_HisEnv;
 #dsarw088#1;
 ;
 enCliAutoAvanzado, 000000001;
 enCliAutoAvanzado, 999999999;
 ;
 NULL, dsarw088_HisEnv;
|FIN;

|PROCESO CogeAdjuntos;
     aAlfa     = #dsarm005#9;   |QBF aAlfa;
     |SI aAlfa = "";
         aMensaje = "0000Nombre documento vacio";
         |MENAV aMensaje;
     |FINSI;

     aFichero = #dsarm005#7;   |QBF aFichero;
     aFichero = aFichero + #dsarm005#9;
     |QBF aFichero;

     aDestino = aBase + "dscorreo";     |MKDIR aDestino;
     aDestino = aDestino + "/" + #dsarm005#9;  |QBF aDestino;
     aOrigen  = aFichero;
     |HAZ CopiaOrigenDestino;
     aFicheroAdjunto = aDestino;

     ||ARA66
     aAlfa = #dsarm005#92;   |QBF aAlfa;
     |SI aAlfa ! "";
         aFichero = #dsarm005#7;   |QBF aFichero;
         aFichero = aFichero + #dsarm005#92;
         |QBF aFichero;

         aDestino = aBase + "dscorreo";     |MKDIR aDestino;
         aDestino = aDestino + "/" + #dsarm005#92;  |QBF aDestino;
         aOrigen  = aFichero;
         |HAZ CopiaOrigenDestino;
         aFicheroAdjunto2 = aDestino;
     |FINSI;

     ||ARA66
     aAlfa = #dsarm005#96;   |QBF aAlfa;
     |SI aAlfa ! "";
         aFichero = #dsarm005#7;   |QBF aFichero;
         aFichero = aFichero + #dsarm005#96;
         |QBF aFichero;

         aDestino = aBase + "dscorreo";     |MKDIR aDestino;
         aDestino = aDestino + "/" + #dsarm005#96;  |QBF aDestino;
         aOrigen  = aFichero;
         |HAZ CopiaOrigenDestino;
         aFicheroAdjuntoPDF = aDestino;
     |FINSI;

     ||COPIO LOS ADJUNTOS
     |SI eaTipoCorreo = "nominas";
          aAux = #dsarm064#4;
     |SINO;
          aAux = #dsarm064#4;
     |FINSI;
     |QBF aAux;
     |SI aAux ! "";
          aOrigen = aBase + "adjuntos/" + aAux;
          |QBF aOrigen;
          aDestino = aBase + "dscorreo/" + aAux;

          aContiene1 = aOrigen;
          |ESPECIFICA "MD5", aContiene;
          aMD5Ori = FSalida;

          aContiene1 = aDestino;
          |ESPECIFICA "MD5", aContiene;
          aMD5Des = FSalida;

          |SI aMD5Ori ! aMD5Des;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
          aFicheroAdjunto3 = aDestino;
     |FINSI;

     |SI eaTipoCorreo = "nominas";
          aAux = #dsarm064#5;
     |SINO;
          aAux = #dsarm064#5;
     |FINSI;
     |QBF aAux;
     |SI aAux ! "";
          aOrigen = aBase + "adjuntos/" + aAux;
          |QBF aOrigen;
          aDestino = aBase + "dscorreo/" + aAux;
          aContiene1 = aOrigen;
          |ESPECIFICA "MD5", aContiene;
          aMD5Ori = FSalida;

          aContiene1 = aDestino;
          |ESPECIFICA "MD5", aContiene;
          aMD5Des = FSalida;

          |SI aMD5Ori ! aMD5Des;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
          aFicheroAdjunto4 = aDestino;
     |FINSI;
     |SI eaTipoCorreo = "nominas";
          aAux = #dsarm064#6;
     |SINO;
          aAux = #dsarm064#6;
     |FINSI;
     |QBF aAux;
     |SI aAux ! "";
          aOrigen = aBase + "adjuntos/" + aAux;
          |QBF aOrigen;
          aDestino = aBase + "dscorreo/" + aAux;
          aContiene1 = aOrigen;
          |ESPECIFICA "MD5", aContiene;
          aMD5Ori = FSalida;

          aContiene1 = aDestino;
          |ESPECIFICA "MD5", aContiene;
          aMD5Des = FSalida;

          |SI aMD5Ori ! aMD5Des;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
          aFicheroAdjunto5 = aDestino;
     |FINSI;
|FPRC;

|PROCESO MeteHisEnvLin;
     #dsarm062#0 = #dsarm061#0;
     #dsarm062#1 = 999;
     |LEE 000#dsarm062.];
     |SI FSalida = 0;
          |LEE 000#dsarm062.a;
     |SINO;
          |LEE 000#dsarm062.u;
     |FINSI;
     |SI FSalida = 0; |Y #dsarm062#0 = #dsarm061#0;
          nUltLin = #dsarm062#1 + 1;
     |SINO;
          nUltLin = 1;
     |FINSI;

     |DDEFECTO #dsarm062;
     #dsarm062#0 = #dsarm061#0;
     #dsarm062#1 = nUltLin;
     |LEE 101#dsarm062.=;
     |SI FSalida ! 0; |GRABA 020#dsarm062.b; |FINSI;
     #dsarm062#2 = #dsarm005#0;
     #dsarm062#3 = #dsarm005#8;
     #dsarm062#4 = #dsarm005#14;
     #dsarm062#5 = #dsarm005#15;
     #dsarm062#6 = #dsarm005#16;
     #dsarm062#7 = #dsarm005#19;
     #dsarm062#8 = #dsarm005#17;
     #dsarm062#9 = #dsarm005#18;
     #dsarm062#10 = #dsarm005#20;
     #dsarm062#11 = #dsarm005#21;
     #dsarm062#12 = #dsarm005#22;
     #dsarm062#13 = #dsarm005#39;
     #dsarm062#14 = #dsarm005#40;
     #dsarm062#15 = #dsarm005#1;
     #dsarm062#16 = #dsarm005#2;
     #dsarm062#17 = #dsarm005#3;
     #dsarm062#18 = #dsarm005#9;
     #dsarm062#19 = #dsarm005#93;
     |GRABA 020#dsarm062.a;
     |LIBERA #dsarm062;
|FPRC;

|PROCESO MeteHisEnvCab;
     aEmail = #dsarw077#0;
     |SI #dsarw077#3 = "S";
         |SALVA_DATOS #dsarw077;

         |QBF aDestinoCorreo;
         |SI aDestinoCorreo ! "";
             #dsarw077#0 = aDestinoCorreo;
             |LEE 000#dsarw077.=;
         |SINO;
             |LEE 000#dsarw077.p;
         |FINSI;

         |PARA;  |SI FSalida = 0;  |HACIENDO;
              |SI #dsarw077#3 = "N";
                  aEmail = #dsarw077#0;
                  |SAL;
              |FINSI;

              |LEE 000#dsarw077.s;
         |SIGUE;

         |REPON_DATOS #dsarw077;
         |LEE 000#dsarw077.=;
     |FINSI;

     ||ARA   61 y 62
     |LEE 000#dsarm061.u;
     |SI FSalida = 0;
          nUltHis = #dsarm061#0 + 1;
     |SINO;
          nUltHis = 1;
     |FINSI;
     |DDEFECTO #dsarm061;
     #dsarm061#0 = nUltHis;
     |LEE 101#dsarm061.=;
     |SI FSalida ! 0; |GRABA 020#dsarm061.b; |FINSI;
     #dsarm061#1 = ~;
     |HORA aHoraEnv;
     |QBF aHoraEnv;
     #dsarm061#2 = aHoraEnv;
     #dsarm061#3 = aEmail;
     #dsarm061#4 = Usuario % 810;
     |SI nModoMultiDoc = 1; |Y enCodSelAva ! 0;
          #dsarm061#5 = enCodSelAva;
     |FINSI;
     #dsarm061#6 = nCliHis;
     |GRABA 020#dsarm061.a;
     |LIBERA #dsarm061;
|FPRC;

|PROCESO MeteHisEnv;
     |HAZ MeteHisEnvCab;
     |HAZ MeteHisEnvLin;
|FPRC;

|PROCESO MandaCorreoSMTPCli;
     |SI aParametro ! "AUTODESDED9";
         |HAZ Ventana913;
     |SINO;
          |SI enSwNomina = 0;
               |PINPA #0#dsarw019;
               |PINDA #0#dsarw019;
               |PTEC 802;
               |PAUSA;
          |FINSI;
     |FINSI;

     aFicheroAdjunto = "";
     aFicheroAdjunto2 = "";
     aFicheroAdjunto3 = "";
     aFicheroAdjunto4 = "";
     aFicheroAdjunto5 = "";
     aFicheroAdjuntoPDF = "";

     |DBASE aBasePla;  |QBF aBasePla;
     aBaseMensaje = aBasePla + "dscorreo/";
     aBasePlugins = aBasePla + "plugins/";

     aAbreTXT  = aBaseMensaje + "adjunto.txt";
     |XABRE "WB", aAbreTXT, nHandle;

     eaAlfa = #dsarw010#3;
     |QBF eaAlfa;
     |HAZ QuitaRarosCorreo;
     aAsunto  = eaAlfa; |QBF aAsunto;
     |SI nSwSMTPCLI = 1; |Y #dsarm005#89 = "S"; |Y #dsarw010#23 = "S";
          aNumDoc = ("000000000" + #dsarm005#0) % -109;
          |QBF aNumDoc;
          aAsunto = "Doc.Num.: " + aNumDoc + ". " + aAsunto;
     |FINSI;

     aDeMail = #dsarm064#114; |QBF aDeMail;
     |SI aDeMail = "";
         aDeMail = #dsarw010#1; |QBF aDeMail;
     |FINSI;

     |LEE 000#dsarw077.p;
     |SI FSalida = 0;
         aDestinoCorreo = #dsarw077#0;   |QBF aDestinoCorreo;
     |FINSI;

     |SI aEmailCotejo ! "";
         #dsarw077#0 = aEmailCotejo;
         |LEE 000#dsarw077.=;
         |SI FSalida ! 0;
             #dsarw077#0 = aEmailCotejo;
             #dsarw077#3 = "S";
             |GRABA 020#dsarw077.n;
             |LIBERA #dsarw077;
         |FINSI;
     |FINSI;

     || Tengo que ver si estoy en OTP, y tengo 2 direcciones extras
     || para el envio de las facturasE. (visalm01)
     |HAZ DirEnvioExtrasOTP;

     ||TRAE LOGO.
     aNomLogo = #dsarm064#113;
     |QBF aNomLogo;
     |SI aNomLogo ! "";
         aFotoOrigen = aBasePla + "logos/" + aNomLogo;
         aNLogo = aNomLogo;
         |XABRE "E", aFotoOrigen, nHandle;
         |SI FSalida < 0;
             aFotoOrigen = aBasePla + "logos/insertarlogo.jpg";
             aNLogo      = "insertarlogo.jpg";
             |XABRE "E", aFotoOrigen, nHandle;
             |SI FSalida < 0;
                 |ACABA;
             |FINSI;
         |FINSI;
     |SINO;
          aFotoOrigen = aBasePla + "logos/insertarlogo.jpg";
          aNLogo      = "insertarlogo.jpg";
          |XABRE "E", aFotoOrigen, nHandle;
          |SI FSalida < 0;
               |ACABA;
          |FINSI;
     |FINSI;

     aOrigen = aFotoOrigen;
     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aMD5Ori = FSalida;

     aDestino = aBasePla + "dscorreo/" + aNLogo;
     aContiene1 = aDestino;
     |ESPECIFICA "MD5", aContiene;
     aMD5Des = FSalida;

     |SI aMD5Ori ! aMD5Des;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;
     aLogoFacturae = aDestino;

     |HAZ CargaTextoSMTPCLI;
     |XCIERRA nHandle;

     |DBASE aBase;  |QBF aBase;

     |SI enDocumento ! 0;
         |HAZ CogeAdjuntos;
     |SINO;
          |SI nModoMultiDoc = 1; |Y aParametro = "AUTOMULTIENVIO";
               aFicheroAdjunto = aAdjuntoMulti;
          |SINO;
               aFicheroAdjunto = aPathAdjunto + aFichAdjunto;
          |FINSI;
     |FINSI;

     enErrorCorreo = 0;
     aError1 = "";
     aError2 = "";
     |HAZ EjecutaShellCorreo;

     ||ARA43
     |SI enErrorCorreo = 1;
          |SI aParametro = "";
               aMensaje = "0000Ha habido un error durante el envio. (smtp-cli)" + &13 + aError1;
               |MENAV aMensaje;
          |SINO;
               aTexto1  = "Ha habido un error durante el envio. (smtp-cli)"
               aTexto2  = aError1;
               aTexto3  = aError2;
               aTexto4  = "";
               |HAZ SacaMensaje;
          |FINSI;
     |SINO;
          |SI enDocumento ! 0;
              aTextoFlow = "ENVIADO [" + nSalidaHis + "] CORREO A " + aDestinoCorreo;
              |HAZ GrabaRegistro;

              |SI aSwHistoricoEnv = "S";
                   |ABRE #dsarm005;
                   |SI nModoMultiDoc = 0;
                        #dsarm005#0 = enDocumento;
                        |LEE 000#dsarm005.=;
                        |SI FSalida = 0;
                             nCliHis = #dsarm005#8;
                             |HAZ MeteHisEnv;
                        |FINSI;
                   |SINO;
                        nCliHis = enCliAutoAvanzado;
                        |HAZ MeteHisEnvCab;
                        |BUCLE dsarw088_HisEnv;
                   |FINSI;
                   |CIERRA #dsarm005;
              |FINSI;
          |FINSI;

/*
          enErrorCorreo = 0;
          |SI aParametro = "";
               |MENAV "0000 El correo se ha enviado correctamente.";
          |FINSI;
*/
     |FINSI;

     |HAZ FinVentana;
|FPRC;

|PROCESO MandaCorreoBLAT;
     |SI aParametro ! "AUTODESDED9";
         |HAZ Ventana913;
     |SINO;
          |SI enSwNomina = 0;
               |PINPA #0#dsarw019;
               |PINDA #0#dsarw019;
               |PTEC 802;
               |PAUSA;
          |FINSI;
     |FINSI;

     |HAZ LeeUnidadBasico;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     aFicheroAdjunto = "";
     aFicheroAdjunto2 = "";
     aFicheroAdjunto3 = "";
     aFicheroAdjunto4 = "";
     aFicheroAdjunto5 = "";
     aFicheroAdjuntoPDF = "";


     |DBASE aBasePlaServ;  |QBF aBasePlaServ;

     aBaseBin = eaUnidadBasico + "\ds\bin\";
     aBasePla = eaUnidadBasico + "\ds\dsarchi\";
     aBaseMensaje = aBasePla + "dscorreo\";
     aAbreTXT  = aBaseMensaje + "adjunto.txt";
     |XABRE "CWB", aAbreTXT, nHandle;

     eaAlfa = #dsarw010#3;
     |QBF eaAlfa;
     |HAZ QuitaRarosCorreo;
     aAsunto  = eaAlfa; |QBF aAsunto;
     |SI #dsarw010#23 = "S";
          aNumDoc = ("000000000" + #dsarm005#0) % -109;
          |QBF aNumDoc;
          aAsunto = "Doc.Num.: " + aNumDoc + ". " + aAsunto;
     |FINSI;

     aDeMail = #dsarm064#114; |QBF aDeMail;
     |SI aDeMail = "";
         aDeMail = #dsarw010#1; |QBF aDeMail;
     |FINSI;

     |LEE 000#dsarw077.p;
     |SI FSalida = 0;
         aDestinoCorreo = #dsarw077#0;   |QBF aDestinoCorreo;
     |FINSI;

     |SI aEmailCotejo ! "";
         #dsarw077#0 = aEmailCotejo;
         |LEE 000#dsarw077.=;
         |SI FSalida ! 0;
             #dsarw077#0 = aEmailCotejo;
             #dsarw077#3 = "S";
             |GRABA 020#dsarw077.n;
             |LIBERA #dsarw077;
         |FINSI;
     |FINSI;

     ||TRAE LOGO.
     aNomLogo = #dsarm064#113;
     |QBF aNomLogo;
     |SI aNomLogo ! "";
         aFotoOrigen = aBasePlaServ + "logos/" + aNomLogo;
         aNLogo = aNomLogo;
         |XABRE "E", aFotoOrigen, nHandle;
         |SI FSalida < 0;
             aFotoOrigen = aBasePlaServ + "logos/insertarlogo.jpg";
             aNLogo      = "insertarlogo.jpg";
             |XABRE "E", aFotoOrigen, nHandle;
             |SI FSalida < 0;
                 |ACABA;
             |FINSI;
         |FINSI;
     |SINO;
          aFotoOrigen = aBasePlaServ + "logos/insertarlogo.jpg";
          aNLogo      = "insertarlogo.jpg";
          |XABRE "E", aFotoOrigen, nHandle;
          |SI FSalida < 0;
               |ACABA;
          |FINSI;
     |FINSI;

     aOrigen = aFotoOrigen;
     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aMD5Ori = FSalida;

     aDestino = aBasePla + "dscorreo\" + aNLogo;
     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aMD5Des = FSalida;

     |SI aMD5Ori ! aMD5Des;
          |SI aIPRemoto ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
     |FINSI;
     aLogoFacturae = aDestino;

     |HAZ CargaTextoBLAT;
     |XCIERRA nHandle;

     aBase = aBasePla;
     |DBASE aBaseServ;  |QBF aBaseServ;

     aAlfa     = #dsarm005#9;   |QBF aAlfa;
     |SI aAlfa = "";
          aMensaje = "0000Nombre documento vacio";
          |MENAV aMensaje;
     |FINSI;

     aFichero = #dsarm005#7;   |QBF aFichero;
     aFichero = aFichero + #dsarm005#9;
     |QBF aFichero;

     aDestino = aBase + "dscorreo";     |MKDIR aDestino;
     aDestino = aDestino + "\" + #dsarm005#9;  |QBF aDestino;
     aOrigen  = aFichero;
     |HAZ TraeOrigenDestino;
     aFicheroAdjunto = aDestino;

     ||ARA66
     aAlfa = #dsarm005#92;   |QBF aAlfa;
     |SI aAlfa ! "";
          aFichero = #dsarm005#7;   |QBF aFichero;
          aFichero = aFichero + #dsarm005#92;
          |QBF aFichero;

          aDestino = aBase + "dscorreo";     |MKDIR aDestino;
          aDestino = aDestino + "\" + #dsarm005#92;  |QBF aDestino;
          aOrigen  = aFichero;
          |HAZ TraeOrigenDestino;
          aFicheroAdjunto2 = aDestino;
     |FINSI;

     ||ARA66
     aAlfa = #dsarm005#96;   |QBF aAlfa;
     |SI aAlfa ! "";
          aFichero = #dsarm005#7;   |QBF aFichero;
          aFichero = aFichero + #dsarm005#96;
          |QBF aFichero;

          aDestino = aBase + "dscorreo";     |MKDIR aDestino;
          aDestino = aDestino + "\" + #dsarm005#96;  |QBF aDestino;
          aOrigen  = aFichero;
          |HAZ TraeOrigenDestino;
          aFicheroAdjuntoPDF = aDestino;
     |FINSI;

     aAux = #dsarm064#4;
     |QBF aAux;
     |SI aAux ! "";
          aOrigen = aBaseServ + "adjuntos/" + aAux;
          |QBF aOrigen;

          aDestino = aBase + "dscorreo\" + aAux;
          |QBF aDestino;

          aContiene1 = aOrigen;
          |ESPECIFICA "MD5", aContiene;
          aMD5Ori = FSalida;

          aContiene1 = aDestino;
          |ESPECIFICA "REMOTOMD5", aContiene;
          aMD5Des = FSalida;

          |SI aMD5Ori ! aMD5Des;
               |HAZ TraeOrigenDestino;
          |FINSI;
          aFicheroAdjunto3 = aDestino;
     |FINSI;

     aAux = #dsarm064#5;
     |QBF aAux;
     |SI aAux ! "";
          aOrigen = aBaseServ + "adjuntos/" + aAux;
          |QBF aOrigen;

          aDestino = aBase + "dscorreo\" + aAux;
          |QBF aDestino;

          aContiene1 = aOrigen;
          |ESPECIFICA "MD5", aContiene;
          aMD5Ori = FSalida;

          aContiene1 = aDestino;
          |ESPECIFICA "REMOTOMD5", aContiene;
          aMD5Des = FSalida;

          |SI aMD5Ori ! aMD5Des;
               |HAZ TraeOrigenDestino;
          |FINSI;
          aFicheroAdjunto4 = aDestino;
     |FINSI;

     aAux = #dsarm064#6;
     |QBF aAux;
     |SI aAux ! "";
          aOrigen = aBaseServ + "adjuntos/" + aAux;
          |QBF aOrigen;

          aDestino = aBase + "dscorreo\" + aAux;
          |QBF aDestino;

          aContiene1 = aOrigen;
          |ESPECIFICA "MD5", aContiene;
          aMD5Ori = FSalida;

          aContiene1 = aDestino;
          |ESPECIFICA "REMOTOMD5", aContiene;
          aMD5Des = FSalida;

          |SI aMD5Ori ! aMD5Des;
               |HAZ TraeOrigenDestino;
          |FINSI;
          aFicheroAdjunto5 = aDestino;
     |FINSI;

     |HAZ EjecutaBatCorreo;

     |SI enDocumento ! 0;
         aTextoFlow = "ENVIADO [" + nSalidaHis + "] CORREO A " + aDestinoCorreo;
         |HAZ GrabaRegistro;
     |FINSI;

     |SI aSwHistoricoEnv = "S";
          |ABRE #dsarm005;
          |SI nModoMultiDoc = 0;
               #dsarm005#0 = enDocumento;
               |LEE 000#dsarm005.=;
               |SI FSalida = 0;
                    nCliHis = #dsarm005#8;
                    |HAZ MeteHisEnv;
               |FINSI;
          |SINO;
               nCliHis = enCliAutoAvanzado;
               |HAZ MeteHisEnvCab;
               |BUCLE dsarw088_HisEnv;
          |FINSI;
          |CIERRA #dsarm005;
     |FINSI;

     |HAZ FinVentana;
|FPRC;

|PROCESO TraeOrigenDestino;
     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
     |SI #dsarm001#7 = "N";
          |SI aIPRemoto ! "";
               |ENVIA_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
     |SINO;
          |SI eaOrigen ! eaDestino;
               |RCOPIA_FICHERO aOrigen, aDestino;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CopiaOrigenDestino;
     |SI #dsarm001#7 = "N";
         |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
         |SI aIPRemoto ! "";
             |RECIBE_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaCuerpo;
     |HAZ PonVariables;
     |HAZ QuitaRarosCorreo;

     |SI eaAlfa = "";
         eaAlfa = "<br>";
     |SINO;
         eaAlfa = eaAlfa + "<br>" + &10;
     |FINSI;

     |XGRABA nHandle, eaAlfa;
|FPRC;

|PROCESO dsarw077D;
     aTo    = #dsarw077#0;   |QBF aTo;
     |SI aTo = "";  |ACABA;  |FINSI;

     aLong  = aTo % 0;
     nLong  = aLong;
     aFrase = "";
     aDirec = "";
     |PARA nPosi = 1;  |SI nPosi [ nLong;  |HACIENDO nPosi = nPosi + 1;
           nPos   = (nPosi * 100) + 1;
           aCarac = aTo % nPos;

           |SI aCarac = ";";  |O aCarac = ",";
               |SI #dsarw077#3 = "S";
                    aFrase = aFrase + "--bcc=" + &34 + aDirec + &34 + " ";
               |SINO;
                    aFrase = aFrase + "--to=" + &34 + aDirec + &34 + " ";
               |FINSI;
               aDirec = "";
           |SINO;
               aDirec = aDirec + aCarac;
           |FINSI;
     |SIGUE;

     |SI aDirec ! "";
         |SI #dsarw077#3 = "S";
              aFrase = aFrase + "--bcc=" + &34 + aDirec + &34 + " ";
         |SINO;
              aFrase = aFrase + "--to=" + &34 + aDirec + &34 + " ";
         |FINSI;

         |XGRABA nHandle1, aFrase;
     |FINSI;
|FPRC;

|DEFBUCLE dsarw077D;
     #dsarw077#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsarw077D;
|FIN;

|PROCESO PonDirecciones;
     |BUCLE dsarw077D;

     aConten = " \" + &10;
|FPRC;

|PROCESO dsarw077DBlat;
     aTo    = #dsarw077#0;
     |QBF aTo;
     |SI aTo = "";
          |ACABA;
     |FINSI;

     |SI aTxtDirDestino = "";
          aTxtDirDestino = aTo;
     |SINO;
          aTxtDirDestino = aTxtDirDestino + "," + aTo
     |FINSI;
|FPRC;

|DEFBUCLE dsarw077DBlat;
     #dsarw077#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsarw077DBlat;
|FIN;

|PROCESO PonDireccionesBlat;
     |BUCLE dsarw077DBlat;
|FPRC;


|PROCESO dsarw077D_bcc;
     aTo    = #dsarw077#0;   |QBF aTo;
     |SI aTo = "";  |ACABA;  |FINSI;

     aLong  = aTo % 0;
     nLong  = aLong;
     aFrase = "";
     aDirec = "";
     |PARA nPosi = 1;  |SI nPosi [ nLong;  |HACIENDO nPosi = nPosi + 1;
           nPos   = (nPosi * 100) + 1;
           aCarac = aTo % nPos;

           |SI aCarac = ";";  |O aCarac = ",";
               aFrase = aFrase + "--bcc=" + &34 + aDirec + &34 + " ";
               aDirec = "";
           |SINO;
               aDirec = aDirec + aCarac;
           |FINSI;
     |SIGUE;

     |SI aDirec ! "";
         aFrase = "--bcc=" + &34 + aDirec + &34 + " \" + &10;

         |XGRABA nHandle1, aFrase;
     |FINSI;
|FPRC;

|DEFBUCLE dsarw077D_bcc;
     #dsarw077#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsarw077D_bcc;
|FIN;

|PROCESO PonDireccionesBCC;
     |BUCLE dsarw077D_bcc;
|FPRC;

|PROCESO CopiaConMd5;
     aContiene1 = aOrigenMd5;
     |ESPECIFICA "MD5", aContiene;
     aVersion1  = FSalida;  |QBF aVersion1;

     aContiene1 = aDestinoMd5;
     |ESPECIFICA "MD5", aContiene;
     aVersion2  = FSalida;  |QBF aVersion2;

     |SI aVersion1 ! aVersion2;
          |COPIA_FICHERO aOrigenMd5, aDestinoMd5;
     |FINSI;
|FPRC;

|PROCESO EjecutaShellWebMailing;
     ||ARA

     aUsuario = Usuario;

     aAbreHTMD = aFicheroWebMail;

     aAbreTXTO = aBaseMensaje + "webmailing.sh";
     aAbreTXTD = aBaseMensaje + aUsuario + ".sh";  |QBT aAbreTXTD;
     aAbreFIN  = aBaseMensaje + aUsuario + ".txt"; |QBT aAbreFIN;
     |FBORRA aAbreTXTD;
     |FBORRA aAbreFIN;

     |XABRE "WB", aAbreTXTD, nHandle1;
     |XABRE "AB", aAbreTXTO, nHandle2;

     aCarac10 = &10;
     aConten = "";

     aVarSMTP = #dsarw010#19;
     |QBF aVarSMTP;
     aVarUsuario = #dsarw010#21;
     |QBF aVarUsuario;
     aVarPassword = #dsarw010#22;
     |QBF aVarPassword;

     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            aConten = aConten + aAlfa;

            |SI aAlfa = aCarac10;
                aAlfa1 = aConten - "/usr/bin/smtp-cli";
                |SI FSalida ! 0;
                     ||SMTPSERVPROPIO
                     |SI nSwSMTPServPropio = 1;
                         |SI aVarSMTP ! ""; |Y aVarUsuario ! ""; |Y aVarPassword ! "";
                              aAlfa2 = aAlfa1 - "--host=asmtp.diagram.es --user=control.smtp@diagram.es --pass=elpollogalactico \";
                              |SI FSalida ! 0;
                                   aAlfa1 = " --host=" + aVarSMTP + " --user=" + aVarUsuario + " --pass=" + aVarPassword + " \" + &10;
                              |FINSI;
                         |FINSI;
                     |FINSI;

                     aConten = aBaseMensaje + "smtp-cli" + aAlfa1;
                |FINSI;


                aAlfa1 = aConten - "DE=$1";
                |SI FSalida ! 0;
                    aConten = "DE=" + &34 + aDeMail + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "$PARA";
                |SI FSalida ! 0;
                    aConten = "--to=" + &34 + aDestinoCorreo + &34 + " \" + &10;
                |FINSI;

                aAlfa1 = aConten - "$BCC";
                |SI FSalida ! 0;
                    aConten = "";
                    |HAZ PonDireccionesBCC;
                |FINSI;

                aAlfa1 = aConten - "ASUNTO=$3";
                |SI FSalida ! 0;
                    ||ARA3939
                    ||Escapar aAsunto. ASCII mayores de 128.

                    eaEscapaAsunto = aAsunto;
                    |HAZ EscapaAsunto;
                    aAsunto = eaEscapaAsunto;

                    aConten = "ASUNTO=" + &34 + aAsunto + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICHTM=$4";
                |SI FSalida ! 0;
                    aConten = "FICHTM=" + &34 + aAbreHTMD + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICFIN=$6";
                |SI FSalida ! 0;
                     aConten = "FICFIN=" + &34 + aAbreFIN + &34 + &10;  |QBT aConten;
                     |XGRABA nHandle1, aConten;
                |SINO;
                     |XGRABA nHandle1, aConten;
                |FINSI;
                aConten = "";
            |FINSI;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;

     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     |HAZ ParametrosSMTPCLI;

     ||WEBMAILING
     aOrigenMd5 = aBasePlugins + "smtp-cli";
     aDestinoMd5 = aBaseMensaje + "smtp-cli";
     |HAZ CopiaConMd5;
     aEjecuta = "chmod +x " + aDestinoMd5;
     |SYSTEM aEjecuta;

     aEjecuta = "/bin/sh " + aAbreTXTD;

     ||TODO CCC. DESCOMENTAR ESTE TROZO .. WEBMAILING
     |SYSTEM aEjecuta;

     |PARA;  |SI;  |HACIENDO;
          |XABRE "E", aAbreFIN, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |SLEEP 1;
          |PULSATECLA;
     |SIGUE;

     |FBORRA aAbreTXT;
     |FBORRA aAbreTXTD;
     |FBORRA aAbreHTMD;
     |FBORRA aAbreFIN;
|FPRC;

|PROCESO EjecutaShellCorreo;
     aUsuario = Usuario;

     |SI eaTipoCorreo = "nominas";
          aCustom = aBaseMensaje + "customnom.htm";
          |XABRE "E", aCustom, nHandleC;
          |SI FSalida ] 0;
               aAbreHTMO = aCustom;
          |SINO;
               aAbreHTMO = aBaseMensaje + "nominas.htm";
          |FINSI;
     |SINO;
          |SI #dsarm005#89 = "S";
               aCustom = aBaseMensaje + "customfae.htm";
               |XABRE "E", aCustom, nHandleC;
               |SI FSalida ] 0;
                    aAbreHTMO = aCustom;
               |SINO;
                    aAbreHTMO = aBaseMensaje + "facturae.htm";
               |FINSI;
          |SINO;
               ||Correo estandar.
               aCustom = aBaseMensaje + "customstd.htm";
               |XABRE "E", aCustom, nHandleC;
               |SI FSalida ] 0;
                    aAbreHTMO = aCustom;
               |SINO;
                    aAbreHTMO = aBaseMensaje + "estandar.htm";
               |FINSI;
          |FINSI;
     |FINSI;
     aAbreHTMD = aBaseMensaje + aUsuario + ".htm";  |QBT aAbreHTMD;
     |FBORRA aAbreHTMD;

     |XABRE "WB", aAbreHTMD, nHandle1;
     |XABRE "AB", aAbreHTMO, nHandle2;

     nRegilla = 0;
     nLLave   = 0;
     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            |SI aAlfa = "#";
                nRegilla = nRegilla + 1;
            |FINSI;

            |SI nRegilla = 2;  |SAL;  |FINSI;

            |SI nLLave = 0;  |Y aAlfa ! "{";  |Y nRegilla = 0;
                |XGRABA nHandle1, aAlfa;
            |FINSI;

            |SI aAlfa = "}";
                aConten  = aConten + aAlfa;

                |SI aConten = "{LOGO}";
                    ||Por el tema del "cid:" Para la imagen embebida
                    ||aAlfa = &34 + aNLogo + &34;
                    aAlfa = aNLogo;
                |FINSI;

                |XGRABA nHandle1, aAlfa;

                nLLave   = 0;
                aConten  = "";
            |SINO;
                |SI aAlfa = "{";  |O nLLave = 1;
                    aConten  = aConten + aAlfa;
                    nLLave = 1;
                |FINSI;
            |FINSI;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;
     |XCIERRA nHandle1;

     |AFEGIR_FICHERO aAbreTXT, aAbreHTMD;

     |XABRE "AB", aAbreHTMD, nHandle1;

     nRegilla = 0;
     nLLave   = 0;
     aConten  = "";
     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
          |SI nLLave = 0;  |Y aAlfa ! "{";
              |XGRABA nHandle1, aAlfa;
          |FINSI;

          |SI aAlfa = "}";
              aConten  = aConten + aAlfa;

              |SI aConten = "{LOGO}";
                  ||Por el tema del "cid:" Para la imagen embebida
                  ||aAlfa = &34 + aNLogo + &34;
                  aAlfa = aNLogo;
              |FINSI;

              |XGRABA nHandle1, aAlfa;

              nLLave   = 0;
              aConten  = "";
          |SINO;
              |SI aAlfa = "{";  |O nLLave = 1;
                  aConten  = aConten + aAlfa;
                  nLLave = 1;
              |FINSI;
          |FINSI;

          |XLEE nHandle2, 1, aAlfa;
     |SIGUE;
     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     aAbreTXTO = aBaseMensaje + "dscorreo.sh";
     aAbreTXTD = aBaseMensaje + aUsuario + ".sh";  |QBT aAbreTXTD;
     aAbreFIN  = aBaseMensaje + aUsuario + ".txt"; |QBT aAbreFIN;
     aAbreERROR = aAbreFIN + ".err"; |QBT aAbreERROR;
     |FBORRA aAbreTXTD;
     |FBORRA aAbreFIN;
     |FBORRA aAbreERROR;

     |XABRE "WB", aAbreTXTD, nHandle1;
     |XABRE "AB", aAbreTXTO, nHandle2;

     aCarac10 = &10;
     aConten = "";

     aVarSMTP = #dsarw010#19;
     |QBF aVarSMTP;
     aVarUsuario = #dsarw010#21;
     |QBF aVarUsuario;
     aVarPassword = #dsarw010#22;
     |QBF aVarPassword;

     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            aConten = aConten + aAlfa;

            |SI aAlfa = aCarac10;
                aAlfa1 = aConten - "/usr/bin/smtp-cli";
                |SI FSalida ! 0;
                     ||SMTPSERVPROPIO
                     |SI nSwSMTPServPropio = 1;
                         ||ARA39
                         |SI aVarSMTP ! ""; |Y aVarUsuario ! ""; |Y aVarPassword ! "";
                              aAlfa2 = aAlfa1 - "--host=asmtp.diagram.es --user=control.smtp@diagram.es --pass=elpollogalactico \";
                              |SI FSalida ! 0;
                                   aAlfa1 = " --host=" + aVarSMTP + " --user=" + aVarUsuario + " --pass=" + aVarPassword + " \" + &10;
                              |FINSI;
                         |FINSI;
                     |FINSI;

                     aConten = aBaseMensaje + "smtp-cli" + aAlfa1;
                |FINSI;

                aAlfa1 = aConten - "DE=$1";
                |SI FSalida ! 0;
                    aConten = "DE=" + &34 + aDeMail + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "$PARA";
                |SI FSalida ! 0;
                    |SI nSwSMTPCLI = 1; |Y #dsarm005#89 = "S"; |Y #dsarw010#23 = "S";
                         aAuxNot = "--notifica \" + &10;
                         |XGRABA nHandle1, aAuxNot;
                    |SINO;
                         aConten = "";
                    |FINSI;
                    |HAZ PonDirecciones;
                |FINSI;

                aAlfa1 = aConten - "ASUNTO=$3";
                |SI FSalida ! 0;
                    ||ARA3939
                    ||Escapar aAsunto. ASCII mayores de 128.

                    eaEscapaAsunto = aAsunto;
                    |HAZ EscapaAsunto;
                    aAsunto = eaEscapaAsunto;

                    aConten = "ASUNTO=" + &34 + aAsunto + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICHTM=$4";
                |SI FSalida ! 0;
                    aConten = "FICHTM=" + &34 + aAbreHTMD + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICAT1=$5";
                |SI FSalida ! 0;
                    aConten = "FICAT1=" + &34 + aLogoFacturae + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICFIN=$6";
                |SI FSalida ! 0;
                    aConten = "FICFIN=" + &34 + aAbreFIN + &34 + &10;  |QBT aConten;
                |FINSI;

                aAlfa1 = aConten - "$ADJUNTO";
                |SI FSalida ! 0;
                    aConten = "";
                    |SI aFicheroAdjunto ! "";
                        aConten = "--attach " + aFicheroAdjunto + " \" + &10;
                        |XGRABA nHandle1, aConten;
                    |FINSI;
                    |SI aFicheroAdjunto2 ! "";
                        aConten = "--attach " + aFicheroAdjunto2 + " \" + &10;
                        |XGRABA nHandle1, aConten;
                    |FINSI;
                    |SI aFicheroAdjunto3 ! "";
                        aConten = "--attach " + aFicheroAdjunto3 + " \" + &10;
                        |XGRABA nHandle1, aConten;
                    |FINSI;
                    |SI aFicheroAdjunto4 ! "";
                        aConten = "--attach " + aFicheroAdjunto4 + " \" + &10;
                        |XGRABA nHandle1, aConten;
                    |FINSI;
                    |SI aFicheroAdjunto5 ! "";
                        aConten = "--attach " + aFicheroAdjunto5 + " \" + &10;
                        |XGRABA nHandle1, aConten;
                    |FINSI;
                    |SI aFicheroAdjuntoPDF ! "";
                        aConten = "--attach " + aFicheroAdjuntoPDF + " \" + &10;
                        |XGRABA nHandle1, aConten;
                    |FINSI;
                |SINO;
                     |XGRABA nHandle1, aConten;
                |FINSI;

                aConten = "";
            |FINSI;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;

     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     |HAZ ParametrosSMTPCLI;

     aOrigenMd5 = aBasePlugins + "smtp-cli";
     aDestinoMd5 = aBaseMensaje + "smtp-cli";
     |HAZ CopiaConMd5;
     aEjecuta = "chmod +x " + aDestinoMd5;
     |SYSTEM aEjecuta;


     aEjecuta = "/bin/sh " + aAbreTXTD;
     ||TODO CCC. DESCOMENTAR ESTE TROZO. ENVIO SMTPCLI
     |SYSTEM aEjecuta;

     |PARA;  |SI;  |HACIENDO;
          |XABRE "E", aAbreFIN, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |SLEEP 1;
          |PULSATECLA;
     |SIGUE;

     ||Falta recoger respuesta del .err
     ||ARA43
     aRespuesta = aAbreERROR;
     |XABRE "U", aRespuesta, nHandleE;
     |SI FSalida ] 0;
          |PARA; |SI; |HACIENDO;
               |XLEE nHandleE, 250, aError;
               |SI FSalida < 0;
                    |SAL;
               |FINSI;
               |QBF aError;
               |SI aError ! "";
                    aMiraCuatro = aError % 104;
                    |SI aMiraCuatro ! "!!! ";
                         enErrorCorreo = 1;
                         |SI aError1 = "";
                              aError1 = aError;
                         |SINO;
                              aError2 = aError;
                              |SAL;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
     |XCIERRA nHandleE;

     ||TODO CCC. DESCOMENTAR
     |FBORRA aAbreTXT;
     |FBORRA aAbreTXTD;
     |FBORRA aAbreHTMD;
     |FBORRA aAbreFIN;

     |SI aFicheroAdjunto ! "";
          |FBORRA aFicheroAdjunto;
     |FINSI;
     |SI aFicheroAdjunto2 ! "";
          |FBORRA aFicheroAdjunto2;
     |FINSI;
     ||El resto de adjunto, no los borro pq. lo reutilizare varias veces
|FPRC;

|PROCESO EjecutaBatCorreo;
     ||ARA40

     aUsuario = Usuario;

     |SI eaTipoCorreo = "nominas";
          aCustom = aBaseMensaje + "customnom.htm";
          |XABRE "CE", aCustom, nHandleC;
          |SI FSalida ] 0;
               aAbreHTMO = aCustom;
          |SINO;
               aAbreHTMO = aBaseMensaje + "nominas.htm";
          |FINSI;
     |SINO;
          |SI #dsarm005#89 = "S";
               aCustom = aBaseMensaje + "customfae.htm";
               |XABRE "E", aCustom, nHandleC;
               |SI FSalida ] 0;
                    aAbreHTMO = aCustom;
               |SINO;
                    aAbreHTMO = aBaseMensaje + "facturae.htm";
               |FINSI;
          |SINO;
               ||Correo estandar.
               aCustom = aBaseMensaje + "customstd.htm";
               |XABRE "E", aCustom, nHandleC;
               |SI FSalida ] 0;
                    aAbreHTMO = aCustom;
               |SINO;
                    aAbreHTMO = aBaseMensaje + "estandar.htm";
               |FINSI;
          |FINSI;
     |FINSI;
     aAbreHTMD = aBaseMensaje + aUsuario + ".htm";  |QBT aAbreHTMD;
     |RFBORRA aAbreHTMD;

     |XABRE "CWB", aAbreHTMD, nHandle1;
     |XABRE "CAB", aAbreHTMO, nHandle2;

     nRegilla = 0;
     nLLave   = 0;
     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            |SI aAlfa = "#";
                nRegilla = nRegilla + 1;
            |FINSI;

            |SI nRegilla = 2;  |SAL;  |FINSI;

            |SI nLLave = 0;  |Y aAlfa ! "{";  |Y nRegilla = 0;
                |XGRABA nHandle1, aAlfa;
            |FINSI;

            |SI aAlfa = "}";
                aConten  = aConten + aAlfa;

                |SI aConten = "{LOGO}";
                    ||Por el tema del "cid:" Para la imagen embebida
                    ||aAlfa = &34 + aNLogo + &34;
                    aAlfa = aNLogo;
                |FINSI;

                |XGRABA nHandle1, aAlfa;

                nLLave   = 0;
                aConten  = "";
            |SINO;
                |SI aAlfa = "{";  |O nLLave = 1;
                    aConten  = aConten + aAlfa;
                    nLLave = 1;
                |FINSI;
            |FINSI;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;

     |XABRE "CAB", aAbreTXT, nHandle3;
     |XLEE nHandle3, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            |XGRABA nHandle1, aAlfa;

            |XLEE nHandle3, 1, aAlfa;
     |SIGUE;
     |XCIERRA nHandle3;

     nRegilla = 0;
     nLLave   = 0;
     aConten  = "";
     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
          |SI nLLave = 0;  |Y aAlfa ! "{";
              |XGRABA nHandle1, aAlfa;
          |FINSI;

          |SI aAlfa = "}";
              aConten  = aConten + aAlfa;

              |SI aConten = "{LOGO}";
                  ||Por el tema del "cid:" Para la imagen embebida
                  ||aAlfa = &34 + aNLogo + &34;
                  aAlfa = aNLogo;
              |FINSI;

              |XGRABA nHandle1, aAlfa;

              nLLave   = 0;
              aConten  = "";
          |SINO;
              |SI aAlfa = "{";  |O nLLave = 1;
                  aConten  = aConten + aAlfa;
                  nLLave = 1;
              |FINSI;
          |FINSI;

          |XLEE nHandle2, 1, aAlfa;
     |SIGUE;
     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     aAbreTXTO = aBaseMensaje + "dscorreo.bat";
     aAbreTXTD = aBaseMensaje + aUsuario + ".bat"; |QBT aAbreTXTD;
     aAbreFIN  = aBaseMensaje + aUsuario + ".txt"; |QBT aAbreFIN;
     |RFBORRA aAbreTXTD;
     |RFBORRA aAbreFIN;

     |XABRE "CWB", aAbreTXTD, nHandle1;
     |XABRE "CAB", aAbreTXTO, nHandle2;

     aCarac10 = &10;
     aConten = "";

     aVarSMTP = #dsarw010#19;
     |QBF aVarSMTP;
     aVarUsuario = #dsarw010#21;
     |QBF aVarUsuario;
     aVarPassword = #dsarw010#22;
     |QBF aVarPassword;

     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            aConten = aConten + aAlfa;

            |SI aAlfa = aCarac10;

                aAlfa1 = aConten - "set blat=$1";
                |SI FSalida ! 0;
                    aConten = "set blat=" + aBaseBin + "blat.exe" +  &10;
                |FINSI;

                aAlfa1 = aConten - "set html=$2";
                |SI FSalida ! 0;
                    aConten = "set html=" + aBaseMensaje + aUsuario + ".htm -html" + &10;
                |FINSI;

                aAlfa1 = aConten - "set img=$3";
                |SI FSalida ! 0;
                    |SI aNLogo = "insertarlogo.jpg";
                         aConten = "set img=" + &10;
                    |SINO;
                         aConten = "set img=-embed " + aBaseMensaje + aNLogo + &10;
                    |FINSI;
                |FINSI;

                aAlfa1 = aConten - "set email=$4";
                |SI FSalida ! 0;
                    aTxtDirDestino = "";
                    |HAZ PonDireccionesBlat;

                    |SI aTxtDirDestino = "";
                         aConten = "set email=" + &10;
                    |SINO;
                         aConten = "set email=-to " + aTxtDirDestino + &10;
                    |FINSI;
                |FINSI;

                aAlfa1 = aConten - "set subj=$5";
                |SI FSalida ! 0;
                    eaEscapaAsunto = aAsunto;
                    |HAZ EscapaAsunto;
                    aAsunto = eaEscapaAsunto;

                    aConten = "set subj=-s " + &34 + aAsunto + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "set server=$6";
                |SI FSalida ! 0;
                    aConten = "set server=-server asmtp.diagram.es" + &10;
                |FINSI;

                aAlfa1 = aConten - "set auth=$7";
                |SI FSalida ! 0;
                    aConten = "set auth=-f control.smtp@diagram.es -u control.smtp@diagram.es -pw elpollogalactico" + &10;
                |FINSI;

                aAlfa1 = aConten - "set adj=$8";
                |SI FSalida ! 0;
                    aTextoAdjuntos = "";
                    |SI aFicheroAdjunto ! "";
                         |SI aTextoAdjuntos = "";
                              aTextoAdjuntos = aFicheroAdjunto;
                         |SINO;
                              aTextoAdjuntos = aTextoAdjuntos + "," + aFicheroAdjunto;
                         |FINSI;
                    |FINSI;
                    |SI aFicheroAdjunto2 ! "";
                         |SI aTextoAdjuntos = "";
                              aTextoAdjuntos = aFicheroAdjunto2;
                         |SINO;
                              aTextoAdjuntos = aTextoAdjuntos + "," + aFicheroAdjunto2;
                         |FINSI;
                    |FINSI;
                    |SI aFicheroAdjunto3 ! "";
                         |SI aTextoAdjuntos = "";
                              aTextoAdjuntos = aFicheroAdjunto3;
                         |SINO;
                              aTextoAdjuntos = aTextoAdjuntos + "," + aFicheroAdjunto3;
                         |FINSI;
                    |FINSI;
                    |SI aFicheroAdjunto4 ! "";
                         |SI aTextoAdjuntos = "";
                              aTextoAdjuntos = aFicheroAdjunto4;
                         |SINO;
                              aTextoAdjuntos = aTextoAdjuntos + "," + aFicheroAdjunto4;
                         |FINSI;
                    |FINSI;
                    |SI aFicheroAdjunto5 ! "";
                         |SI aTextoAdjuntos = "";
                              aTextoAdjuntos = aFicheroAdjunto5;
                         |SINO;
                              aTextoAdjuntos = aTextoAdjuntos + "," + aFicheroAdjunto5;
                         |FINSI;
                    |FINSI;
                    |SI aFicheroAdjuntoPDF ! "";
                         |SI aTextoAdjuntos = "";
                              aTextoAdjuntos = aFicheroAdjuntoPDF;
                         |SINO;
                              aTextoAdjuntos = aTextoAdjuntos + "," + aFicheroAdjuntoPDF;
                         |FINSI;
                    |FINSI;

                    |SI aTextoAdjuntos = "";
                         aConten = "set adj=" + &10;
                    |SINO;
                         aConten = "set adj=-attach " + aTextoAdjuntos + &10;
                    |FINSI;
                |FINSI;

                aAlfa1 = aConten - "set final=$9";
                |SI FSalida ! 0;
                    aConten = "set final=" + aAbreFIN + &10;
                |FINSI;

                aAlfa1 = aConten - "set from=$10";
                |SI FSalida ! 0;
                    aConten = "set from=-f " + aDeMail + &10;
                |FINSI;

                aAlfa1 = aConten - "$sentencia$";
                |SI FSalida ! 0;
                     |SI #dsarw010#23 = "S";
                          aConten = "%blat% %html% %img% %subj% %email% %server% %auth% %adj% %from% -d" + &10;
                     |SINO;
                          aConten = "%blat% %html% %img% %subj% %email% %server% %auth% %adj% %from%" + &10;
                     |FINSI;
                     |XGRABA nHandle1, aConten;
                |SINO;
                     |XGRABA nHandle1, aConten;
                |FINSI;

                aConten = "";
            |FINSI;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;

     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     ||TODO CCC. DESCOMENTAR ESTE TROZO. ENVIO BAT
     aEjecuta = aAbreTXTD;

     ||No funciona ninguna de estas.
||     aAlfa  = "cmd " + &34 + "/c START " + aAbreTXTD + &34;
||     aAlfa  = "cmd " + &34 + "/c START /WAIT" + aAbreTXTD + &34;
||     aAlfa  = "cmd " + &34 + "/c START /MIN " + aAbreTXTD + &34;
     |RSYSTEM aEjecuta;

     |PARA;  |SI;  |HACIENDO;
          |XABRE "CE", aAbreFIN, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |SLEEP 1;
          |PULSATECLA;
     |SIGUE;

     ||TODO CCC. DESCOMENTAR
     |RFBORRA aAbreTXT;
     |RFBORRA aAbreTXTD;
     |RFBORRA aAbreHTMD;
     |RFBORRA aAbreFIN;
     |SI aFicheroAdjunto ! "";
          |RFBORRA aFicheroAdjunto;
     |FINSI;
     |SI aFicheroAdjunto2 ! "";
          |RFBORRA aFicheroAdjunto2;
     |FINSI;
     ||El resto de adjunto, no los borro pq. lo reutilizare varias veces
|FPRC;

|PROCESO dsarw077Envia;
     aTo = #dsarw077#0;  |QBF aTo;
     |SI aTo = "";  |ACABA;  |FINSI;
     |DSCORREO_ENVIA aIP, aSalida, aAutenti, aTo, aAsunto, aMensaje, aAdjunto;
     nSalidaHis = FSalida;
     |SI FSalida ] 0;
         nSalidaHis     = FSalida;
         enErrorCorreo  = 0;

         |SI aDestinoCorreo = "";
             aDestinoCorreo = #dsarw077#0;   |QBF aDestinoCorreo;
             |SI aDestinoCorreo =  aEmailCotejo;
                 aDestinoCorreo = "";
             |FINSI;
         |FINSI;

         |SI aSwHistoricoEnv = "S";
              |ABRE #dsarm005;
              |SI nModoMultiDoc = 0;
                   #dsarm005#0 = enDocumento;
                   |LEE 000#dsarm005.=;
                   |SI FSalida = 0;
                        nCliHis = #dsarm005#8;
                        |HAZ MeteHisEnv;
                   |FINSI;
              |SINO;
                   nCliHis = enCliAutoAvanzado;
                   |HAZ MeteHisEnvCab;
                   |BUCLE dsarw088_HisEnv;
              |FINSI;
              |CIERRA #dsarm005;
         |FINSI;
     |FINSI;
|FPRC;



|DEFBUCLE dsarw077Envia;
     #dsarw077#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsarw077Envia;
|FIN;

|PROCESO dsarw088_EnvOk;
     aAuxEstado = #dsarw088#2;
     |QBF aAuxEstado;
     |SI aAuxEstado ! "PEND."; |ACABA; |FINSI;

     #dsarw088#2 = "OK";
     #dsarw088#5 = "";
     |GRABA 020#dsarw088.a;

     ||ARA39.
     ||Ahora Actualizamos el historico.
     |SI #dsarw088#1 ! 0;
         enDocumento = #dsarw088#1;
         aTextoFlow  = "ENVIADO [" + nSalidaHis + "] CORREO A " + aDestinoCorreo;
         |HAZ GrabaRegistro;
     |FINSI;
|FPRC;

|DEFBUCLE dsarw088_EnvOk;
 #dsarw088#1;
 ;
 enCliAutoAvanzado, 000000001;
 enCliAutoAvanzado, 999999999;
 be;
 NULL, dsarw088_EnvOk;
|FIN;

|PROCESO dsarw088_Error;
     aAuxEstado = #dsarw088#2;
     |QBF aAuxEstado;
     |SI aAuxEstado ! "PEND."; |ACABA; |FINSI;

     #dsarw088#2 = "ERROR";
     #dsarw088#5 = "Problemas al realizar el envio del correo";
     |GRABA 020#dsarw088.a;
|FPRC;

|DEFBUCLE dsarw088_Error;
 #dsarw088#1;
 ;
 enCliAutoAvanzado, 000000001;
 enCliAutoAvanzado, 999999999;
 be;
 NULL, dsarw088_Error;
|FIN;

|PROCESO MandaCorreo;
     |SI aParametro ! "AUTODESDED9";
         |HAZ Ventana913;
     |SINO;
          |SI enSwNomina = 0;
               |PINPA #0#dsarw019;
               |PINDA #0#dsarw019;
               |PTEC 802;
               |PAUSA;
          |FINSI;
     |FINSI;

     |SI aQueSistema = "ESDOS";
         |HAZ CorreoEnDos;
         |SI aIPRemoto ! "";
             |HAZ CorreoEnUnix;
         |FINSI;
     |SINO;
          |HAZ CorreoEnUnix;
     |FINSI;

     aIP = #dsarw010#18;  |QBF aIP;

     aFrom    = #dsarm064#114;   |QBF aFrom;
     |SI aFrom = "";
         aFrom    = #dsarw010#1;   |QBF aFrom;
     |FINSI;

     aSalida  = #dsarw010#19;  |QBF aSalida;

     |SI #dsarm005#89 = "N";        ||No es facturaE
         aAlfaAux = #dsarw010#140;
         |QBF aAlfaAux;
         |SI aAlfaAux ! "";       ||Dir. Cotejo
             aEmailCotejo = aAlfaAux;
             |QBF aEmailCotejo;
         |FINSI;
     |FINSI;

     |SI aEmailCotejo ! "";
         #dsarw077#0 = aEmailCotejo;
         |LEE 000#dsarw077.=;
         |SI FSalida ! 0;
             #dsarw077#0 = aEmailCotejo;
             #dsarw077#3 = "S";
             |GRABA 020#dsarw077.n;
             |LIBERA #dsarw077;
         |FINSI;
     |FINSI;

     eaAlfa   = #dsarw010#3;   |HAZ QuitaRarosCorreo;
     aAsunto  = eaAlfa;   |QBF aAsunto;
     aMensaje = "";

     |SI aBase = "";
          |DBASE aBase;
          |QBF aBase;
     |FINSI;
     |HAZ CargaTexto;
     aMensaje = "$$$$" + aAbre;

     aAdjunto = aDocumento;

     |SI #dsarw010#20 = "N";
          aAutenti = aFrom;
     |SINO;
          aAutenti = #dsarw010#22;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + #dsarw010#21;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + aFrom;
     |FINSI;

     |SI #dsarw010#23 = "S";
          aAutenti = "!" + aAutenti;
     |FINSI;

     enErrorCorreo  = 1;
     aDestinoCorreo = "";
     |BUCLE dsarw077Envia;

     |SI enErrorCorreo = 1;
         |SI nModoMultiDoc = 0;
              |MENAV "0000 Ha habido un error durante el envio.";
         |SINO;
              |BUCLE dsarw088_Error;
         |FINSI;
     |SINO;
         |SI enDocumento ! 0;
             |SI nModoMultiDoc = 0;
                  aTextoFlow = "ENVIADO [" + nSalidaHis + "] CORREO A " + aDestinoCorreo;
                  |HAZ GrabaRegistro;
             |SINO;
                  |BUCLE dsarw088_EnvOk;
             |FINSI;
         |SINO;
             nGrabaHistorico = 1;
         |FINSI;

         enErrorCorreo = 0;
         |SI aParametro = "";
              |MENAV "0000 El correo se ha enviado correctamente.";
         |FINSI;
     |FINSI;

     |FBORRA aAbre;

     |SI enDocumento ! 0;
         |FBORRA aDocumento;
     |FINSI;

     |HAZ FinVentana;
|FPRC;

|PROCESO SacaNombre;
     aNombreTrae = "";
     aLong = aFicheroTrae % A0;
     nLong = aLong;
     |PARA nConta = nLong; |SI nConta ] 1; |HACIENDO nConta = nConta - 1;
          nCampo = (100 * nConta) + 1;
          aValor = aFicheroTrae % nCampo;
          |SI aValor ! "/"; |Y aValor ! "\";
               aNombreTrae = aValor + aNombreTrae;
          |SINO;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;


|PROCESO TraeFichero;
     aOrigen = aFicheroTrae;
     |HAZ SacaNombre;
     aDestino = aDirBaseLocal + aNombreTrae;

     aBorra = aDestino;
     |RFBORRA aBorra;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |SI aIPRemoto ! "";
          |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |XABRE "CE", aDestino, nHandleE;
     |SI FSalida ] 0;
          aFicheroTrae = aDestino;
     |FINSI;
|FPRC;

|PROCESO dsarw077E;
     nConta = nConta + 1;

     aTo    = #dsarw077#0;   |QBF aTo;
     |SI aTo = "";  |ACABA;  |FINSI;

     |SI nConta > 1;
         aTo = ";" + aTo;
     |FINSI;

     |XGRABA nHandle, aTo;
|FPRC;

|DEFBUCLE dsarw077E;
     #dsarw077#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsarw077E;
|FIN;

|PROCESO MeteParaEnvio;
     aBorraCache3 = aParaEnvio;
     |XABRE "CWB", aParaEnvio, nHandle;
     |SI FSalida < 0;
          aMensaje = "0000Problemas al crear " + aParaEnvio;
          |MENAV aMensaje;
     |SINO;
          ||1
          |QBF aSalida;
          aAlfa = aSalida + &13 + &10;
          |XGRABA nHandle, aAlfa;

          |QBF aUsuAuntenti;
          aAlfa = aUsuAuntenti + &13 + &10;
          |XGRABA nHandle, aAlfa;

          ||3
          |QBF aPassAuntenti;
          aAlfa = aPassAuntenti + &13 + &10;
          |XGRABA nHandle, aAlfa;

          |QBF aFrom;
          aAlfa = aFrom + &13 + &10;
          |XGRABA nHandle, aAlfa;

          ||5
          nConta = 0;
          |BUCLE dsarw077E;
          aAlfa = &13 + &10;
          |XGRABA nHandle, aAlfa;

          |QBF aReply;
          aAlfa = aReply + &13 + &10;
          |XGRABA nHandle, aAlfa;

          ||7
          |QBF aAsunto;
          aAlfa = aAsunto + &13 + &10;
          |XGRABA nHandle, aAlfa;

          |QBF aCuerpo;
          aFicheroTrae = aCuerpo;
          |HAZ TraeFichero;
          aCuerpo = aFicheroTrae;
          aAlfa = aCuerpo + &13 + &10;
          |XGRABA nHandle, aAlfa;
          aBorraCache2 = aFicheroTrae;

          ||9
          |QBF aConfLectura;
          aAlfa = aConfLectura + &13 + &10;
          |XGRABA nHandle, aAlfa;

          aAlfa = "" + &13 + &10;
          |XGRABA nHandle, aAlfa;

          ||11
          aAlfa = "" + &13 + &10;
          |XGRABA nHandle, aAlfa;

          aAlfa = "" + &13 + &10;
          |XGRABA nHandle, aAlfa;

          ||13
          aAlfa = "" + &13 + &10;
          |XGRABA nHandle, aAlfa;

          aAlfa = "" + &13 + &10;
          |XGRABA nHandle, aAlfa;

          ||15
          |QBF aAdjunto;
          aFicheroTrae = aAdjunto;
          |HAZ TraeFichero;
          aAdjunto = aFicheroTrae;
          aAlfa = aAdjunto + &13 + &10;
          |XGRABA nHandle, aAlfa;

          aBorraCache = aAdjunto;

          |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROCESO DsEnviaCorreo;
     |SI aParametro ! "AUTODESDED9";
         |HAZ Ventana913;
     |SINO;
          |SI enSwNomina = 0;
               |PINPA #0#dsarw019;
               |PINDA #0#dsarw019;
               |PTEC 802;
               |PAUSA;
          |FINSI;
     |FINSI;

     aFrom    = #dsarm064#114;   |QBF aFrom;
     |SI aFrom = "";
         aFrom    = #dsarw010#1;   |QBF aFrom;
     |FINSI;

     aReply  = aFrom;
     aSalida = #dsarw010#19;  |QBF aSalida;

     |LEE 000#dsarw077.p;
     |SI FSalida = 0;
         aDestinoCorreo = #dsarw077#0;   |QBF aDestinoCorreo;
     |FINSI;

     |SI aEmailCotejo ! "";
         #dsarw077#0 = aEmailCotejo;
         |LEE 000#dsarw077.=;
         |SI FSalida ! 0;
             #dsarw077#0 = aEmailCotejo;
             #dsarw077#3 = "S";
             |GRABA 020#dsarw077.n;
             |LIBERA #dsarw077;
         |FINSI;
     |FINSI;

     eaAlfa   = #dsarw010#3;   |HAZ QuitaRarosCorreo;
     aAsunto  = eaAlfa;   |QBF aAsunto;
     aMensaje = "";

     |HAZ CargaTexto;
     aCuerpo = aAbre;
     aAdjunto = aDocumento;

     |SI #dsarw010#20 = "N";
          aUsuAuntenti = "";
          aPassAuntenti = "";
     |SINO;
          aUsuAuntenti = #dsarw010#21;
          aPassAuntenti = #dsarw010#22;
     |FINSI;

     |SI #dsarw010#23 = "S";
          aConfLectura = "S";
     |SINO;
          aConfLectura = "N";
     |FINSI;

     |HAZ Traete_dsenviacorreo;

     ||Cambiar por el dsenviacorreo
     aUsuario = Usuario % 810;
     aNomEnvia = "dsenvia_" + aUsuario;

     |HAZ DimeUnidad;
     aDirBaseLocal = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aDirBaseLocal;
     aDirBaseLocal = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aDirBaseLocal;
     aDirBaseLocal = eaUnidad + ":\DOCUMENTOS\DSARCHI\";

     aBorra = aDirBaseLocal + aNomEnvia + ".err";
     |RFBORRA aBorra;

     aBorra = aDirBaseLocal + aNomEnvia + ".bue";
     |RFBORRA aBorra;

     aBorra = aDirBaseLocal + aNomEnvia + ".txt";
     |RFBORRA aBorra;

     aParaEnvio = aDirBaseLocal + aNomEnvia + ".txt";
     |HAZ MeteParaEnvio;

     aEjecuta = aDirBaseLocal + "dsenviacorreo.exe" + " " + aParaEnvio;
     |RSYSTEM aEjecuta;

     ||Falta recoger respuesta.
     ||ARA99
     aRespuesta = aDirBaseLocal + aNomEnvia + ".err";
     |XABRE "CU", aRespuesta, nHandleE;
     |SI FSalida ] 0;
          |XLEE nHandleE, 250, aError;
          |QBF aError;
          nError = 1;
     |SINO;
          nError = 0;
     |FINSI;
     |XCIERRA nHandleE;

     |SI nError = 1;
         enErrorCorreo = 1;
         aTexto1  = "Ha habido un error durante el envio."
         aTexto2  = aError;
         |HAZ SacaMensaje;
     |SINO;
         |SI enDocumento ! 0;
             aTextoFlow = "ENVIADO [" + nSalidaHis + "] CORREO A " + aDestinoCorreo;
             |HAZ GrabaRegistro;
         |SINO;
             nGrabaHistorico = 1;
         |FINSI;

         enErrorCorreo = 0;
         |SI aParametro = "";
              |MENAV "0000 El correo se ha enviado correctamente.";
         |FINSI;
     |FINSI;

     |FBORRA aAbre;

     |SI enDocumento ! 0;
         |FBORRA aDocumento;
     |FINSI;

     |SI #dsarm001#181 = "S";
          ||Ahora controlamos si borramos o no la cache.
          |QBF aBorraCache;
          |SI aBorraCache ! "";
               |RFBORRA aBorraCache;
          |FINSI;
          |QBF aBorraCache2;
          |SI aBorraCache2 ! "";
               |RFBORRA aBorraCache2;
          |FINSI;
          |QBF aBorraCache3;
          |SI aBorraCache3 ! "";
               |RFBORRA aBorraCache3;
          |FINSI;
     |FINSI;

     |HAZ FinVentana;
|FPRC;

|PROCESO dsarw077Gen;
     nUltHis = 1;
     |LEE 000#dsarm061.u;
     |SI FSalida = 0;
          nUltHis = #dsarm061#0 + 1;
     |FINSI;

     |DDEFECTO #dsarm061;
     #dsarm061#0 = nUltHis;

     |HORA aHoraEnv;  |QBF aHoraEnv;

     #dsarm061#1 = ~;
     #dsarm061#2 = aHoraEnv;
     #dsarm061#3 = #dsarw077#0;
     #dsarm061#4 = Usuario % 810;
     #dsarm061#6 = #dsarw077#1;
     |GRABA 020#dsarm061.n;
     |LIBERA #dsarm061;

     |DDEFECTO #dsarm062;
     #dsarm062#0  = #dsarm061#0;
     #dsarm062#1  = 1;
     #dsarm062#2  = 0;
     #dsarm062#3  = #dsarw077#1;
     #dsarm062#4  = #dsarw077#2;
     #dsarm062#18 = aFichAdjunto;
     #dsarm062#19 = eaRuta;

     |GRABA 020#dsarm062.n;
     |LIBERA #dsarm062;
|FPRC;

|DEFBUCLE dsarw077Gen;
     #dsarw077#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsarw077Gen;
|FIN;

|PROCESO GrabaHistorico;
     |BUCLE dsarw077Gen;

     nUltLin = 0;
|FPRC;

|PROCESO Tipo12;  |TIPO 12;
     |SI FSalida = 7;  |ACABA;  |FINSI;

     |SI aParametro = "DESDEMENU";
          |SI eaRuta = "";
              |MENAV "0000No se ha adjuntado documento alguno. Por favor adjunte un documento.";
              |ERROR;
              |ACABA;
          |FINSI;

         |DBASE aBase;  |QBF aBase;
         aOrigen  = eaRuta;
         aDestino = aBase + "dscorreo";     |MKDIR aDestino;
         aDestino = aDestino + "/" + aProg;  |QBF aDestino;

         |SI #dsarm001#7 = "N";
             |RECIBE_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
         aPathAdjunto = aBase + "dscorreo/";
         aFichAdjunto = aProg;

         aDocumento = aPathAdjunto + aFichAdjunto;
     |FINSI;

     |SI #dsarw010#39 = "S";
          nSwWebMail = 1;
     |SINO;
          nSwWebMail = 0;
     |FINSI;

     aAlfa = #dsarw010#1;  |QBF aAlfa;
     |SI aAlfa = "";
         |MENAV "0000 Introduzca el DE";
         |ERROR;
         |ACABA;
     |FINSI;

     |LEE 000#dsarw077.p;
     aAlfa = #dsarw077#0;  |QBF aAlfa;
     |SI aAlfa = "";
         |MENAV "0000 Introduzca el PARA";
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #dsarw010#3;  |QBF aAlfa;
     |SI aAlfa = "";
         |MENAV "0000 Introduzca el Asunto";
         |ERROR;
         |ACABA;
     |FINSI;

     aAlfa = #dsarw010#41 + #dsarw010#42;  |QBF aAlfa;
     |SI aAlfa = "";
         |MENAV "0000 Introduzca el Cuerpo";
         |ERROR;
         |ACABA;
     |FINSI;

     |CONFI "0000S¿Esta seguro de que quiere mandar el correo.?";
     |SI FSalida = 0;

         |SI aParametro = "DESDEMENU";
             nGrabaHistorico = 0;

             |SI nSwDsEnviaCorreo = 1;
                 |HAZ DsEnviaCorreo;
             |SINO;
                 |HAZ MandaCorreo;
             |FINSI;

             |SI nGrabaHistorico = 1;
                 |HAZ GrabaHistorico;
             |FINSI;

             |ACABA;
         |FINSI;

          |SI nModoMultiDoc = 1;
               ||Luego creo el adjunto.
               nModoMultiDoc = 1;
               |HAZ Adjuntos188;
               |SI nSwHayAdjuntosAva = 0;
                    ||Si no tiene ningun adjunto. NO SE ENVIA EL CORREO.
                    |ACABA;
               |FINSI;

               ||Y por ultimo realizo el envio.
               ||Por ahora SOLO soporta el envio NORMAL.
               ||El SMTPCLI, esta MUY enfocado al envio de facturaE.

               |SI nSwSMTPCLIAll = 1;
                    |DDEFECTO #dsarm064;
                    #dsarm064#0 = 1;
                    #dsarm064#1 = 0;
                    |LEE 000#dsarm064.=;

                    |SI nModoMultiDoc = 1; |Y aParametro = "AUTOMULTIENVIO";
                         |SI aDestino ! "";
                              aAdjuntoMulti = aDestino;
                         |FINSI;
                    |FINSI;

                    |HAZ MandaCorreoSMTPCli;
               |SINO;
                    |HAZ MandaCorreo;
               |FINSI;
          |SINO;
               |SI nSwWebMail = 1;
                    |HAZ MandaWebMailSMTPCli;
               |SINO;
                    |SI nSwSMTPCLI = 1; |Y #dsarm005#89 = "S";
                         |HAZ MandaCorreoSMTPCli;
                    |SINO;
                         |SI nSwSMTPCLI = 1; |Y eaTipoCorreo ! "";
                              |HAZ MandaCorreoSMTPCli;
                         |SINO;
                              |SI nSwSMTPCLIAll = 1;
                                   |HAZ MandaCorreoSMTPCli;
                              |SINO;
                                   |SI nSwBLAT = 1; |Y #dsarm005#89 = "S";
                                        |HAZ MandaCorreoBLAT;
                                   |SINO;
                                        |SI nSwDsEnviaCorreo = 1;
                                             |HAZ DsEnviaCorreo;
                                        |SINO;
                                             |HAZ MandaCorreo;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;


|PROCESO ConfDSCorreo;
     nError = 0;
     aAlfa  = #dsarw010#18;  |QBF aAlfa;
     |SI aAlfa = "";
         nError = 1;
     |FINSI;

     nError = 0;
     aAlfa  = #dsarw010#19;  |QBF aAlfa;
     |SI aAlfa = "";
         nError = 1;
     |FINSI;
|FPRC;

|PROCESO GrabaConf;
     |ABRE #dsarw010;
     aIP   = #dsarw010#18;
     aSmtp = #dsarw010#19;
     aDe   = #dsarw010#1;
     aDirOrigenUsu = #dsarw010#1;
     |QBT aDirOrigenUsu;

     |LEE 101#dsarw010.p;
     |SI FSalida ! 0;
         |DDEFECTO #dsarw010;
         |GRABA 020#dsarw010.b;
     |FINSI;

     |PDEFECTO #dsarw010, 2, 18;

     |ABRE #dsarm032;
     |DDEFECTO #dsarm032;
     aUsuEnvio = Usuario % 810;
     #dsarm032#0 = aUsuEnvio;
     |LEE 101#dsarm032.=;
     |SI FSalida ! 0; |GRABA 020#dsarm032.b; |FINSI;
     #dsarm032#1 = aDirOrigenUsu;
     |GRABA 020#dsarm032.a;
     |LIBERA #dsarm032;
     |CIERRA #dsarm032;

     #dsarw010#18 = aIP;
     #dsarw010#19 = aSmtp;
     |GRABA 020#dsarw010.a;
     |LIBERA #dsarw010;
     |CIERRA #dsarw010;
|FPRC;

|PROCESO Boton1;
     |VENTANA 0501, 2699, -1, 16, "Configuraci¢n DSCORREO";
     nVent911 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent911;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PINPA #0#dsarw011;

     #dsarw011#0 = #dsarw010#18;
     #dsarw011#1 = #dsarw010#19;
     #dsarw011#2 = #dsarw010#1;

     #dsarw011#3 = #dsarw010#20;
     #dsarw011#4 = #dsarw010#21;
     eaClaveCorreo = #dsarw010#22;
     eaClaveEntrante = #dsarw010#26
     #dsarw011#5 = "*********";
     #dsarw011#6 = #dsarw010#23;
     #dsarw011#7 = #dsarw010#24;
     #dsarw011#8 = #dsarw010#25;
     #dsarw011#9 = "*********";

     |SI #dsarw011#6 = "S";
          |C_M #dsarw011#2, 1, "N";
          |PINTA #dsarw011#2;
     |SINO;
          |C_M #dsarw011#2, 1, "S";
          |PINTA #dsarw011#2;
     |FINSI;

     |PINDA #0#dsarw011;
     |ENDATOS #2#dsarw011;
     |SI FSalida = 0;
         #dsarw010#18 = #dsarw011#0;
         #dsarw010#19 = #dsarw011#1;
         ||ARA66. aDirOrigenUsu

         #dsarw010#1  = #dsarw011#2;
         #dsarw010#20 = #dsarw011#3;
         #dsarw010#21 = #dsarw011#4;
         #dsarw010#22 = eaClaveCorreo;
         #dsarw010#23 = #dsarw011#6;
         #dsarw010#24 = #dsarw011#7;
         #dsarw010#25 = #dsarw011#8;
         #dsarw010#26 = eaClaveEntrante;

         |SI #dsarw010#23 = "S";
               |HAZ MeteCrontcom;
         |SINO;
               |HAZ SacaCrontcom;
         |FINSI;
     |FINSI;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent911;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVent911;

     |PINTA #dsarw010#18;
     |PINTA #dsarw010#19;
     |PINTA #dsarw010#1;

     |ESTADO_CONTROL nBoton1, "SHOW";
     |ESTADO_CONTROL nBoton2, "SHOW";
     |ESTADO_CONTROL nBoton3, "SHOW";
|FPRC;

|PROCESO Boton2;
     |PTEC 806;
|FPRC;

|PROCESO Boton3;
     |PTEC 807;
|FPRC;

|PROCESO Boton4;
     |VENTANA 0501, 3399, -1, 16, "Asignaci¢n de direcciones de correos";
     nVent977 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent977;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |SUB_EJECUTA "dsarw077";

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent977;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVent977;

     |REFRESCACONTROL nGrid977;
     |FOCOTECLADO nGrid977;
|FPRC;

|PROCESO BotonPanta1;
     |CONTROL_SIMPLE 0, "BOTON,Configurar DSCORREO", 3002, 3020, Boton1;
     nBoton1 = FSalida;

     ||CONTROL_SIMPLE 0, "BOTON,{{230}}Enviar Correo", 3084, 3098, Boton2;
     |CONTROL_SIMPLE 0, "BOTON,Enviar Correo", 3084, 3098, Boton2;
     nBoton2 = FSalida;

     ||CONTROL_SIMPLE 0, "BOTON,{{207}}Cancelar", 3072, 3082, Boton3;
     |CONTROL_SIMPLE 0, "BOTON,Cancelar", 3072, 3082, Boton3;
     nBoton3 = FSalida;

     |CONTROL_SIMPLE nPanta1, "BOTON,Para", 0802, 0807, Boton4;
     nBoton4 = FSalida;
|FPRC;


|PROCESO BorraDir;          ||Borra todos los archivos de aDirectorio
     direc = ""; |DIRECTORIO direc; |QBF direc;
     |SI aDirectorio ! "/";
          aAlfa1 = direc + "bin/agirm -r " + aDirectorio;
          |SYSTEM aAlfa1;
     |FINSI;
|FPRC;

|PROCESO Tipo7C1;   |TIPO 7;
     |SI nBotonAceptar ! -1;  |ACABA;  |FINSI;

     aQueBoton     = "|X000";
     aID           = #dsarw010#aQueBoton#;
     nBotonAceptar = aID;
     |ESTADO_CONTROL nBotonAceptar, "HIDE";

     aQueBoton      = "|X001";
     aID            = #dsarw010#aQueBoton#;
     nBotonCancelar = aID;
     |ESTADO_CONTROL nBotonCancelar, "HIDE";
|FPRC;

|PROCESO CargaInicial;
     aParametro = PARAMETRO;
     |QBF aParametro;

     aIPLocal = "";
     |IP_LOCAL aIPLocal;    |QBF aIPLocal;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;

     aQueSistema = "";
     |QUE_SISTEMA aQueSistema;  |QBF aQueSistema;

     |CABEZA "Envio de Correo";

     aDirOrigenUsu = "";
     |ABRE #dsarm032;
     |DDEFECTO #dsarm032;
     aUsuEnvio = Usuario % 810;
     #dsarm032#0 = aUsuEnvio;
     |LEE 000#dsarm032.=;
     |SI FSalida = 0;
          aDirOrigenUsu = #dsarm032#1;
          |QBT aDirOrigenUsu;
     |FINSI;
     |CIERRA #dsarm032;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "BLAT";
     |HAZ DSARCHI_INI;
     nSwBLAT = enAprobacion;
     enAprobacion = nGuarda;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "SMTPCLI";
     |HAZ DSARCHI_INI;
     nSwSMTPCLI = enAprobacion;
     enAprobacion = nGuarda;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "SMTPCLITODOS";
     |HAZ DSARCHI_INI;
     nSwSMTPCLIAll = enAprobacion;
     |SI nSwSMTPCLIAll = 1; |Y nSwSMTPCLI = 0;
          nSwSMTPCLI = 1;
     |FINSI;
     enAprobacion = nGuarda;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "SMTPSERVPROPIO";
     |HAZ DSARCHI_INI;
     nSwSMTPServPropio = enAprobacion;
     enAprobacion = nGuarda;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "DSENVIACORREO";
     |HAZ DSARCHI_INI;
     nSwDsEnviaCorreo = enAprobacion;
     enAprobacion = nGuarda;

     |ABRE #dsarm001;
     |LEE 000#dsarm001.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarm001;  |FINSI;
     |CIERRA #dsarm001;

     |ABRE #dsarm005;
     #dsarm005#0 = enDocumento;
     |LEE 000#dsarm005.=;
     |SI FSalida ! 0;  |DDEFECTO #dsarm005;  |FINSI;
     |CIERRA #dsarm005;

     aAlfa     = #dsarm005#9;         |QBF aAlfa;
     |SI aAlfa = "";
         nError = 1;
         |ACABA;
     |FINSI;

     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     |SI aDirOrigenUsu ! "";
          #dsarw010#1 = aDirOrigenUsu;
     |FINSI;

     aEmailCotejo = "";

     |SI nSwBLAT = 1;
          |HAZ InstalaBlat;
     |FINSI;
|FPRC;

|PROCESO MesLetra;
     |SI nMes = 01; aMes = "enero";      |FINSI;
     |SI nMes = 02; aMes = "febrero";    |FINSI;
     |SI nMes = 03; aMes = "marzo";      |FINSI;
     |SI nMes = 04; aMes = "abril";      |FINSI;
     |SI nMes = 05; aMes = "mayo";       |FINSI;
     |SI nMes = 06; aMes = "junio";      |FINSI;
     |SI nMes = 07; aMes = "julio";      |FINSI;
     |SI nMes = 08; aMes = "agosto";     |FINSI;
     |SI nMes = 09; aMes = "septiembre"; |FINSI;
     |SI nMes = 10; aMes = "octubre";    |FINSI;
     |SI nMes = 11; aMes = "noviembre";  |FINSI;
     |SI nMes = 12; aMes = "diciembre";  |FINSI;
|FPRC;

|PROCESO SiParametroEsAuto;
     aAlfa = aDirOrigenUsu;  |QBT aAlfa;
     |SI aAlfa = "";
         aAlfa = #dsarw010#1;   |QBF aAlfa;
     |FINSI;

     |SI aAlfa = "";
         aAlfa = #dsarm005#77;   |QBF aAlfa;
         |SI aAlfa = "";
             nError = 1;  |ACABA;
         |SINO;
             #dsarw010#1 = aAlfa;
         |FINSI;
     |FINSI;

     aAlfa = #dsarm005#78;   |QBF aAlfa;
     |SI aAlfa = "";
         nError = 1;  |ACABA;
     |SINO;
         #dsarw077#0 = aAlfa;
         |GRABA 020#dsarw077.n;
         |LIBERA #dsarw077;
     |FINSI;

     |SI #dsarm005#89 = "S";
         aAlfa = #dsarm064#110;  |QBF aAlfa;
         |SI aAlfa = "";
             aAlfa = "Factura Electronica. " + #dsarm005#85;  |QBF aAlfa;
             aAlfa = aAlfa + "/" + #dsarm005#86;
         |FINSI;
     |SINO;
         aAlfa = #dsarm064#110;
         |SI eaTipoCorreo = "nominas";
               aAlfa = #dsarm064#110;
               |SI #dsarm064#111 = "S";
                    |SI #dsarm005#15 ! 0;
                         nMes = #dsarm005#18
                         |HAZ MesLetra;
                         aAlfa = "N¢mina mes de " + aMes;
                    |FINSI;
                    |SI #dsarm005#15 = 0; |Y nDesdeMes = nHastaMes;
                         || si es envio por centro o empresa y es de un unico mes
                         || tambien
                         nMes = nDesdeMes;
                         |HAZ MesLetra;
                         aAlfa = "N¢mina mes de " + aMes;
                    |FINSI;
              |FINSI;
         |FINSI;
         |QBF aAlfa;
         |SI aAlfa = "";
             aAlfa = "DSARCHI. Correo con documentacion.";
         |FINSI;
     |FINSI;
     #dsarw010#3 = aAlfa;

     |SI #dsarm005#89 = "S"; |O eaTipoCorreo = "nominas";
         |PARA nVoy = 41; |SI nVoy [ 139; |HACIENDO nVoy = nVoy + 1;
              #dsarw010#nVoy# = "";
         |SIGUE;
     |SINO;
          aAlfaAux = #dsarm064#110;
          |QBF aAlfaAux;
          |SI aAlfaAux ! "";       ||Asunto correos FacE
               |SI #dsarm064#7 = "I"; |O #dsarm064#7 = "F";
                    |PARA nVoy = 41; |SI nVoy [ 139; |HACIENDO nVoy = nVoy + 1;
                         #dsarw010#nVoy# = "";
                    |SIGUE;
               |SINO;
                    |HAZ TextoEstandardFactura;
               |FINSI;
          |SINO;
               |HAZ TextoEstandardFactura;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO TextoEstandardFactura;
     aAlfa = "Documento " + #dsarm005#9;  |QBF aAlfa;
     aAlfa = aAlfa + " adjunto.";

||     #dsarw010#4 = aAlfa;
||     #dsarw010#5 = "";
     #dsarw010#41 = aAlfa;
     #dsarw010#42 = "";

     aAux = #dsarm005#9;  |QBF aAux;
     aAux = aAux % -104;
     |SI aAux = ".fir"; |O aAux = ".FIR";
         #dsarw010#43 = "Verificaci¢n de Firma y obtenci¢n del documento original.";
         #dsarw010#44 = "Pagina Oficial de la Agencia Tributaria.";
         #dsarw010#45 = "https://aeat.es/facturac.html";
     |SINO;
         #dsarw010#43 = "";
         #dsarw010#44 = "";
         #dsarw010#45 = "";
     |FINSI;
|FPRC;

|PROCESO SiParametroNoEsAuto;
     |SI #dsarm005#89 = "S";
         aAlfa = #dsarm064#110;   |QBF aAlfa;
         |SI aAlfa = "";
             aAlfa = "Factura Electronica. " + #dsarm005#85;   |QBF aAlfa;
             aAlfa = aAlfa + "/" + #dsarm005#86;
         |FINSI;
     |SINO;
         |SI eaTipoCorreo = "nominas";
               aAlfa = #dsarm064#110;
               aAlfa = #dsarm005#9;
               |SI #dsarm064#111 = "S";
                    |SI #dsarm005#15 ! 0;
                         nMes = #dsarm005#18
                         |HAZ MesLetra;
                         aAlfa = "N¢mina mes " + aMes + ".pdf";
                    |FINSI;
                    |SI #dsarm005#15 = 0; |Y nDesdeMes = nHastaMes;
                         || si es envio por centro o empresa y es de un unico mes
                         || tambien
                         nMes = nDesdeMes;
                         |HAZ MesLetra;
                         aAlfa = "N¢mina mes " + aMes + ".pdf";
                    |FINSI;
               |FINSI;
         |FINSI;
         |QBF aAlfa;
     |FINSI;

     #dsarw010#3 = aAlfa;
     |PINTA #dsarw010#3;
|FPRC;

|PROCESO PonAsunto;
     |SI #dsarw010#23 = "S"; |Y nSwSMTPCLI = 0;
          aAux = #dsarw010#1;  |QBF aAux;
          |SI aAux = "";
              nError   = 1;
              aMensaje = "0000Error: No se ha indicado Direccion Origen";
              |MENAV aMensaje;
              |ACABA;
          |FINSI;

          |C_M #dsarw010#1, 1, "N";
          aNumDoc = ("000000000" + #dsarm005#0) % -109;
          |C_M #dsarw010#3, 1, "N";
          |PINTA #dsarw010#1;

          aAux = #dsarw010#3;   |QBF aAux;
          #dsarw010#3 = "Doc.Num.: " + aNumDoc + ". " + aAux;
          |PINTA #dsarw010#3;
     |SINO;
          |C_M #dsarw010#1, 1, "S";
          |C_M #dsarw010#3, 1, "S";
          |PINTA #dsarw010#1;
          |PINTA #dsarw010#3;
     |FINSI;
|FPRC;

|PROCESO VerConfiguracion;
     |SI nSwSMTPCLI = 1; |Y #dsarm005#89 = "S";
         |ACABA;
     |SINO;
          |SI nSwSMTPCLI = 1; |Y eaTipoCorreo ! "";
              |ACABA;
          |SINO;
               |SI nSwSMTPCLIAll = 1;
                    |ACABA;
               |SINO;
                    |HAZ ConfDSCorreo;
                    |SI nError = 1;
                        |MENAV "0000dsCorreo no configurado.";
                        |ACABA;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO FacturaE;
     |SI #dsarm005#89 = "S";    ||FacturaE
         nSwHayAdjuntos = 0;
         |SI #dsarm064#3 = "S";
             aFicAdj1 = #dsarm064#4;  |QBF aFicAdj1;
             aFicAdj2 = #dsarm064#5;  |QBF aFicAdj2;
             aFicAdj3 = #dsarm064#6;  |QBF aFicAdj3;

             |SI aFicAdj1 ! ""; |O aFicAdj2 ! ""; |O aFicAdj3 ! "";
                 nSwHayAdjuntos = 1;
             |FINSI;
         |FINSI;

         aEmailCotejo = #dsarm064#112;  |QBF aEmailCotejo;
     |SINO;
         |SI eaTipoCorreo = "nominas";
              aEmailCotejo = #dsarm064#112;  |QBF aEmailCotejo;
         |FINSI;

         aGuarda = aDestino;
         nSwHayAdjuntos = 0;
         |SI #dsarm064#3 = "S";
             aFicAdj1 = #dsarm064#4;  |QBF aFicAdj1;
             aFicAdj2 = #dsarm064#5;  |QBF aFicAdj2;
             aFicAdj3 = #dsarm064#6;  |QBF aFicAdj3;

             |SI aFicAdj1 ! ""; |O aFicAdj2 ! ""; |O aFicAdj3 ! "";
                 nSwHayAdjuntos = 1;
             |FINSI;
         |FINSI;
     |FINSI;

     aNomAdjuntoPDF = #dsarm005#96;  |QBF aNomAdjuntoPDF;
     aNomAdjunto2 = #dsarm005#92;    |QBF aNomAdjunto2;

     ||ARA38
     |||SI aAux3 = "PDF"; |Y #dsarm005#89 = "S";
     |SI #dsarm005#89 = "S";
         aGuarda = aDestino;
         nSwTgzOk = 0;
     |FINSI;

     |SI aNomAdjunto2 ! ""; |O nSwHayAdjuntos = 1; |O aNomAdjuntoPDF ! "";
         aGuarda = aDestino;
         nSwTgzOk = 0;

         |XABRE "E", aDestino, nHandle;
         |SI FSalida < 0;  |ACABA;  |FINSI;

         ||PREPARO EL DIRECTORIO DONDE HARE EL TGZ
         |DBASE aBase;  |QBF aBase;
         aDestinoTgz = aBase + "correos";
         |MKDIR aDestinoTgz;
         aNomTgz = "tgz" + Usuario;  |QBF aNomTgz
         aDestinoTgz = aDestinoTgz + "/" + aNomTgz + "/";
         |MKDIR aDestinoTgz;
         aDirectorio = aDestinoTgz;
         |HAZ BorraDir;
         |MKDIR aDestinoTgz;

         |SI aNomAdjunto2 ! "";
             ||COPIO EL DOCUMENTO HTML.
             aPathAdj2 = #dsarm005#7;   |QBF aPathAdj2;
             aPathAdj2 = aPathAdj2 + #dsarm005#92;
             |QBF aPathAdj2;
             aDestino = aDestinoTgz + #dsarm005#92;  |QBF aDestino;
             aOrigen  = aPathAdj2;
             |SI #dsarm001#7 = "N";
                 |COPIA_FICHERO aOrigen, aDestino;
             |SINO;
                 aIPRemoto = "";
                 |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
                 |SI aIPRemoto ! "";
                     |RECIBE_FICHERO aOrigen, aDestino;
                 |SINO;
                     |COPIA_FICHERO aOrigen, aDestino;
                 |FINSI;
             |FINSI;
         |FINSI;

         |SI aNomAdjuntoPDF ! "";
             ||COPIO EL DOCUMENTO PDF.
             aPathAdjPDF = #dsarm005#7;   |QBF aPathAdjPDF;
             aPathAdjPDF = aPathAdjPDF + #dsarm005#96;  |QBF aPathAdjPDF;
             aDestino = aDestinoTgz + #dsarm005#96;     |QBF aDestino;
             aOrigen  = aPathAdjPDF;
             |SI #dsarm001#7 = "N";
                 |COPIA_FICHERO aOrigen, aDestino;
             |SINO;
                 aIPRemoto = "";
                 |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
                 |SI aIPRemoto ! "";
                     |RECIBE_FICHERO aOrigen, aDestino;
                 |SINO;
                     |COPIA_FICHERO aOrigen, aDestino;
                 |FINSI;
             |FINSI;
         |FINSI;

         |SI nSwHayAdjuntos = 1;
             ||COPIO LOS ADJUNTOS
             |DBASE aBase;  |QBF aBase;

             |SI aFicAdj1 ! "";
                 aOrigen = aBase + "adjuntos/" + aFicAdj1;  |QBF aOrigen;
                 aDestino = aDestinoTgz + aFicAdj1;  |QBF aDestino;
                 |COPIA_FICHERO aOrigen, aDestino;
             |FINSI;

             |SI aFicAdj2 ! "";
                 aOrigen = aBase + "adjuntos/" + aFicAdj2;  |QBF aOrigen;
                 aDestino = aDestinoTgz + aFicAdj2;  |QBF aDestino;
                 |COPIA_FICHERO aOrigen, aDestino;
             |FINSI;

             |SI aFicAdj3 ! "";
                 aOrigen = aBase + "adjuntos/" + aFicAdj3;  |QBF aOrigen;
                 aDestino = aDestinoTgz + aFicAdj3;  |QBF aDestino;
                 |COPIA_FICHERO aOrigen, aDestino;
             |FINSI;
         |FINSI;

         ||COPIO EL DOCUMENTO PRINCIPAL.
         |DBASE aBase;  |QBF aBase;
         aDestino = aBase + "correos";      |MKDIR aDestino;
         aOrigen = aDestino + "/" + #dsarm005#9;   |QBF aOrigen;
         aDestino = aDestinoTgz + #dsarm005#9;  |QBF aDestino;
         |COPIA_FICHERO aOrigen, aDestino;

         ||Ahora el ATAR.
         aNomSin = #dsarm005#9;  |QBF aNomSin;
         aAux = aNomSin % -104;
         |SI aAux = ".xml";
              aNomSin = aNomSin - ".xml";
         |SINO;
              aNomSin = aNomSin - ".xsig";
         |FINSI;

         aFicTar = aDestinoTgz + aNomSin + ".tar" + " " + #dsarm005#9;
         |QBF aFicTar;

         |SI aNomAdjunto2 ! "";
             aFicTar = aFicTar + " " + #dsarm005#92;  |QBF aFicTar;
         |FINSI;

         |SI aNomAdjuntoPDF ! "";
             aFicTar = aFicTar + " " + #dsarm005#96;  |QBF aFicTar;
         |FINSI;

         |SI nSwHayAdjuntos = 1;
             |SI aFicAdj1 ! "";
                 aFicTar = aFicTar + " " + aFicAdj1;  |QBF aFicTar;
             |FINSI;

             |SI aFicAdj2 ! "";
                 aFicTar = aFicTar + " " + aFicAdj2;  |QBF aFicTar;
             |FINSI;

             |SI aFicAdj3 ! "";
                 aFicTar = aFicTar + " " + aFicAdj3;   |QBF aFicTar;
             |FINSI;
         |FINSI;

         |ATAR aFicTar, aDestinoTgz;
         |SI FSalida = 0;
             aFicTar = aDestinoTgz + aNomSin + ".tar";
             |COMPRIME aFicTar;
             |SI FSalida = 0;
                 aBorra = aDestinoTgz + aNomSin + ".tar";
                 |FBORRA aBorra;
                 aDestino = aDestinoTgz + aNomSin + ".tgz";
                 nSwTgzOk = 1;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI nSwTgzOk = 0;
         aDestino = aGuarda;
     |FINSI;
|FPRC;

|PROCESO CopiaFicheroAlServidor;
     aFichero  = #dsarm005#7;             |QBF aFichero;
     aFichero  = aFichero + #dsarm005#9;  |QBF aFichero;

     |DBASE aBase;  |QBF aBase;
     aDestino = aBase + "correos";      |MKDIR aDestino;
     |SI eaTipoCorreo = "nominas";
          aAlfa = #dsarm005#9;
          |SI #dsarm005#15 ! 0; |Y #dsarm064#111 = "S";
               nMes = #dsarm005#18
               |HAZ MesLetra;
               aAlfa = "Nómina mes de " + aMes + ".pdf";
          |FINSI;
          |SI #dsarm005#15 = 0; |Y nDesdeMes = nHastaMes;
               || si es envio por centro o empresa y es de un unico mes
               || tambien
               nMes = nDesdeMes;
               |HAZ MesLetra;
               aAlfa = "Nómina mes de " + aMes + ".pdf";
          |FINSI;
     |SINO;
          aAlfa = #dsarm005#9;
     |FINSI;
     aDestino = aDestino + "/" + aAlfa;  |QBF aDestino;
     aOrigen  = aFichero;

     |SI aParametro ! "AUTODESDED9";
          |VENTANA 0501, 2799, -1, 1, "";
          nVent1   = FSalida;

          |PINPA #0#dsarw014;
          |PINDA #0#dsarw014;
          |PTEC 802;
          |PAUSA;
     |SINO;
          |SI enSwNomina = 0;
               |PINPA #0#dsarw019;
               |PINDA #0#dsarw019;
               |PTEC 802;
               |PAUSA;
          |FINSI;
     |FINSI;

     |SI nSwSMTPCLI = 1; |Y #dsarm005#89 = "S";
          ||NADA
     |SINO;
          |SI nSwSMTPCLI = 1; |Y eaTipoCorreo ! "";
               ||NADA
          |SINO;
               |SI nSwSMTPCLIAll = 1;
                    ||NADA
               |SINO;
                    |SI #dsarm001#7 = "N";
                        |COPIA_FICHERO aOrigen, aDestino;
                    |SINO;
                        aIPRemoto = "";
                        |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
                        |SI aIPRemoto ! "";
                            |RECIBE_FICHERO aOrigen, aDestino;
                        |SINO;
                            |COPIA_FICHERO aOrigen, aDestino;
                        |FINSI;
                    |FINSI;

                    |XABRE "E", aDestino, nHandle;
                    |SI FSalida < 0;
                        nError = 1;
                        aMensaje = "0000 Problemas en copiar el documento. " + aDestino;
                        |MENAV aMensaje;
                        |ACABA;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nSwSMTPCLI ! 0;
          |SI #dsarm005#89 = "S"; |O nSwSMTPCLIAll = 1;   ||FacturaE o Todos SMTPCLI
               aEmailCotejo = #dsarm064#112;
               |QBF aEmailCotejo;
          |FINSI;
     |FINSI;

     |SI #dsarm005#89 = "S"; |O eaTipoCorreo = "nominas";
         |HAZ FacturaE;
     |FINSI;
|FPRC;

|PROCESO MiniCargaInicial;
     ||eaNombre188
     ||enCliAutoAvanzado

     aParametro = PARAMETRO;
     |QBF aParametro;

     aIPLocal = "";
     |IP_LOCAL aIPLocal;    |QBF aIPLocal;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;

     aQueSistema = "";
     |QUE_SISTEMA aQueSistema;  |QBF aQueSistema;

     |CABEZA "Envio de Correo";

     aDirOrigenUsu = "";
     |ABRE #dsarm032;
     |DDEFECTO #dsarm032;
     aUsuEnvio = Usuario % 810;
     #dsarm032#0 = aUsuEnvio;
     |LEE 000#dsarm032.=;
     |SI FSalida = 0;
          aDirOrigenUsu = #dsarm032#1;
          |QBT aDirOrigenUsu;
     |FINSI;
     |CIERRA #dsarm032;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "BLAT";
     |HAZ DSARCHI_INI;
     nSwBLAT = enAprobacion;
     enAprobacion = nGuarda;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "SMTPCLI";
     |HAZ DSARCHI_INI;
     nSwSMTPCLI = enAprobacion;
     enAprobacion = nGuarda;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "SMTPCLITODOS";
     |HAZ DSARCHI_INI;
     nSwSMTPCLIAll = enAprobacion;
     |SI nSwSMTPCLIAll = 1; |Y nSwSMTPCLI = 0;
          nSwSMTPCLI = 1;
     |FINSI;
     enAprobacion = nGuarda;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "DSENVIACORREO";
     |HAZ DSARCHI_INI;
     nSwDsEnviaCorreo = enAprobacion;
     enAprobacion = nGuarda;

     |ABRE #dsarm001;
     |LEE 000#dsarm001.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarm001;  |FINSI;
     |CIERRA #dsarm001;

     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     |SI aDirOrigenUsu ! "";
          #dsarw010#1 = aDirOrigenUsu;
     |FINSI;

     aEmailCotejo = "";

     |SI nSwBLAT = 1;
          |HAZ InstalaBlat;
     |FINSI;
|FPRC;

|PROCESO dsarw088;
     |SI #dsarw088#2 ! "PEND."; |ACABA; |FINSI;

     aOrigen  = #dsarw088#3;
     |QBF aOrigen;
     aOrigen = aOrigen + #dsarw088#4;
     |QBF aOrigen;

     |SI #dsarm001#7 = "N";
          |XABRE "E", aOrigen, nHandleE;
     |SINO;
          |XABRE "CE", aOrigen, nHandleE;
     |FINSI;
     |SI FSalida < 0;
          #dsarw088#2 = "ERROR";
          #dsarw088#5 = "Imposible localizar fisicamente el documento";
          |GRABA 020#dsarw088.a;
          |ACABA;
     |FINSI;

     aDestino = aDestinoTgz + #dsarw088#4;  |QBF aDestino;
     |SI #dsarm001#7 = "N";
          |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
          aIPRemoto = "";
          |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
          |SI aIPRemoto ! "";
               |RECIBE_FICHERO aOrigen, aDestino;
          |SINO;
               |COPIA_FICHERO aOrigen, aDestino;
          |FINSI;
     |FINSI;
     nSwHayAdjuntosAva = nSwHayAdjuntosAva + 1;
|FPRC;

|DEFBUCLE dsarw088;
 #dsarw088#1;
 ;
 enCliAutoAvanzado, 000000001;
 enCliAutoAvanzado, 999999999;
 be;
 NULL, dsarw088;
|FIN;

|PROCESO Adjuntos188;
     ||Crea un TGZ con todos los documentos de el cliente en cuestion.

     ||ARA39
     aUbicacion = #dsarm001#1;
     |QBF aUbicacion;

     ||PREPARO EL DIRECTORIO DONDE HARE EL TGZ
     |DBASE aBase;  |QBF aBase;
     aDestinoTgz = aBase + "correos";
     |MKDIR aDestinoTgz;
     aBaseTgz = aDestinoTgz;

     aNomTgz = "tg2" + Usuario;  |QBF aNomTgz
     aDestinoTgz = aDestinoTgz + "/" + aNomTgz + "/";
     |MKDIR aDestinoTgz;
     aDirectorio = aDestinoTgz;
     |HAZ BorraDir;
     |MKDIR aDestinoTgz;

     nSwHayAdjuntosAva = 0;
     |NOME_DAT #dsarw088#eaNombre188#;
     |BUCLE dsarw088;

     |SI nSwHayAdjuntosAva ! 0;
          ||Ahora el ATAR.
          aUsuarioTgz = Usuario;
          aFicTar = aBaseTgz + aUsuarioTgz + ".tar" + " " + "*.*";
          |QBF aFicTar;

          |ATAR aFicTar, aDestinoTgz;
          |SI FSalida = 0;
               aOrigen = aBaseTgz + aUsuarioTgz + ".tar"
               aDestino = aDestinoTgz + "adjunto.tar";
               |RENOMBRA_FICHERO aOrigen, aDestino;
               aFicTar = aDestinoTgz + "adjunto.tar";
               |COMPRIME aFicTar;
               |SI FSalida = 0;
                    aBorra = aDestinoTgz + "adjunto.tar";
                    |FBORRA aBorra;
                    aDestino = aDestinoTgz + "adjunto.tgz";
                    nSwTgzOk = 1;
                    aDocumento = aDestino;
               |SINO;
                    aDocumento = "";
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO InstalaBlat;
     |HAZ LeeUnidadBasico;

     aDirBasico = eaUnidadBasico + "\ds";    |RMKDIR aDirBasico;
     aDirBasico = aDirBasico + "\bin";       |RMKDIR aDirBasico;
     aDirBasico = aDirBasico + "\";

     |DBASE aBase;  |QBF aBase;
     eaOrigen  = aBase + "dlls/blat.tgz";
     eaDestino = aDirBasico + "blat.tgz";

     |HAZ EnviaFicheroConMD5;
     |SI enSwNuevoMD5 = 1;
         aAlfa = aDirBasico + "blat.tgz";
         |RDESCOMPRIME aAlfa;
         aAlfa1 = eaUnidadBasico + "\ds\bin\";
         |RDETAR aAlfa, aAlfa1;

         aAlfa = aDirBasico + "blat.tar";
         |RFBORRA aAlfa;
     |FINSI;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     ||El dscorreo.bat y facturae.htm

     aDirBasico = eaUnidadBasico + "\ds\dsarchi\"; |RMKDIR aDirBasico;
     aDirBasico = aDirBasico + "\dscorreo\";       |RMKDIR aDirBasico;

     |DBASE aBase;  |QBF aBase;
     eaOrigen  = aBase + "dlls/blatconf.tgz";
     eaDestino = aDirBasico + "blatconf.tgz";

     |HAZ EnviaFicheroConMD5;
     |SI enSwNuevoMD5 = 1;
         aAlfa = aDirBasico + "blatconf.tgz";
         |RDESCOMPRIME aAlfa;
         aAlfa1 = aDirBasico;
         |RDETAR aAlfa, aAlfa1;

         aAlfa = aDirBasico + "blatconf.tar";
         |RFBORRA aAlfa;
     |FINSI;
|FPRC;

|PROCESO AutoEnvAvanzado;
     |DDEFECTO #dsarm064;

     aSwHistoricoEnv = eaGrabaHis;

     nModoMultiDoc = 1;
     ||ARA39
     |HAZ MiniCargaInicial;

     #dsarw010#3 = eaAsuntoAva;
     #dsarw010#41 = eaCuerpo1Ava;
     #dsarw010#42 = eaCuerpo2Ava;
     #dsarw010#43 = eaCuerpo3Ava;
     #dsarw010#44 = eaCuerpo4Ava;
     #dsarw010#45 = eaCuerpo5Ava;
     #dsarw010#46 = eaCuerpo6Ava;
     #dsarw010#47 = eaCuerpo7Ava;
     #dsarw010#48 = eaCuerpo8Ava;
     #dsarw010#49 = eaCuerpo9Ava;
     #dsarw010#50 = eaCuerpo10Ava;
     #dsarw010#51 = eaCuerpo11Ava;
     #dsarw010#52 = eaCuerpo12Ava;
     #dsarw010#53 = eaCuerpo13Ava;
     #dsarw010#54 = eaCuerpo14Ava;
     #dsarw010#55 = eaCuerpo15Ava;
     #dsarw010#56 = eaCuerpo16Ava;
     #dsarw010#57 = eaCuerpo17Ava;
     #dsarw010#58 = eaCuerpo18Ava;
     #dsarw010#59 = eaCuerpo19Ava;
     #dsarw010#60 = eaCuerpo20Ava;
     #dsarw010#61 = eaCuerpo21Ava;
     #dsarw010#62 = eaCuerpo22Ava;
     #dsarw010#63 = eaCuerpo23Ava;
     #dsarw010#64 = eaCuerpo24Ava;
     #dsarw010#65 = eaCuerpo25Ava;
     #dsarw010#66 = eaCuerpo26Ava;
     #dsarw010#67 = eaCuerpo27Ava;
     #dsarw010#68 = eaCuerpo28Ava;
     #dsarw010#69 = eaCuerpo29Ava;
     #dsarw010#70 = eaCuerpo30Ava;
     #dsarw010#71 = eaCuerpo31Ava;
     #dsarw010#72 = eaCuerpo32Ava;
     #dsarw010#73 = eaCuerpo33Ava;
     #dsarw010#74 = eaCuerpo34Ava;
     #dsarw010#75 = eaCuerpo35Ava;
     #dsarw010#76 = eaCuerpo36Ava;
     #dsarw010#77 = eaCuerpo37Ava;
     #dsarw010#78 = eaCuerpo38Ava;
     #dsarw010#79 = eaCuerpo39Ava;
     #dsarw010#80 = eaCuerpo40Ava;
     #dsarw010#81 = eaCuerpo41Ava;
     #dsarw010#82 = eaCuerpo42Ava;
     #dsarw010#83 = eaCuerpo43Ava;
     #dsarw010#84 = eaCuerpo44Ava;
     #dsarw010#85 = eaCuerpo45Ava;
     #dsarw010#86 = eaCuerpo46Ava;
     #dsarw010#87 = eaCuerpo47Ava;
     #dsarw010#88 = eaCuerpo48Ava;
     #dsarw010#89 = eaCuerpo49Ava;
     #dsarw010#90 = eaCuerpo50Ava;
     #dsarw010#91 = eaCuerpo51Ava;
     #dsarw010#92 = eaCuerpo52Ava;
     #dsarw010#93 = eaCuerpo53Ava;
     #dsarw010#94 = eaCuerpo54Ava;
     #dsarw010#95 = eaCuerpo55Ava;
     #dsarw010#96 = eaCuerpo56Ava;
     #dsarw010#97 = eaCuerpo57Ava;
     #dsarw010#98 = eaCuerpo58Ava;
     #dsarw010#99 = eaCuerpo59Ava;
     #dsarw010#100 = eaCuerpo60Ava;
     #dsarw010#101 = eaCuerpo61Ava;
     #dsarw010#102 = eaCuerpo62Ava;
     #dsarw010#103 = eaCuerpo63Ava;
     #dsarw010#104 = eaCuerpo64Ava;
     #dsarw010#105 = eaCuerpo65Ava;
     #dsarw010#106 = eaCuerpo66Ava;
     #dsarw010#107 = eaCuerpo67Ava;
     #dsarw010#108 = eaCuerpo68Ava;
     #dsarw010#109 = eaCuerpo69Ava;
     #dsarw010#110 = eaCuerpo70Ava;
     #dsarw010#111 = eaCuerpo71Ava;
     #dsarw010#112 = eaCuerpo72Ava;
     #dsarw010#113 = eaCuerpo73Ava;
     #dsarw010#114 = eaCuerpo74Ava;
     #dsarw010#115 = eaCuerpo75Ava;
     #dsarw010#116 = eaCuerpo76Ava;
     #dsarw010#117 = eaCuerpo77Ava;
     #dsarw010#118 = eaCuerpo78Ava;
     #dsarw010#119 = eaCuerpo79Ava;
     #dsarw010#120 = eaCuerpo80Ava;
     #dsarw010#121 = eaCuerpo81Ava;
     #dsarw010#122 = eaCuerpo82Ava;
     #dsarw010#123 = eaCuerpo83Ava;
     #dsarw010#124 = eaCuerpo84Ava;
     #dsarw010#125 = eaCuerpo85Ava;
     #dsarw010#126 = eaCuerpo86Ava;
     #dsarw010#127 = eaCuerpo87Ava;
     #dsarw010#128 = eaCuerpo88Ava;
     #dsarw010#129 = eaCuerpo89Ava;
     #dsarw010#130 = eaCuerpo90Ava;
     #dsarw010#131 = eaCuerpo91Ava;
     #dsarw010#132 = eaCuerpo92Ava;
     #dsarw010#133 = eaCuerpo93Ava;
     #dsarw010#134 = eaCuerpo94Ava;
     #dsarw010#135 = eaCuerpo95Ava;
     #dsarw010#136 = eaCuerpo96Ava;
     #dsarw010#137 = eaCuerpo97Ava;
     #dsarw010#138 = eaCuerpo98Ava;
     #dsarw010#139 = eaCuerpo99Ava;

     #dsarw077#0 = eaEmailCliAvanzado;
     |LEE 000#dsarw077.=;
     |SI FSalida ! 0;
          #dsarw077#0 = eaEmailCliAvanzado;
          |GRABA 020#dsarw077.n;
          |LIBERA #dsarw077;
     |FINSI;

     |HAZ Adjuntos188;
     |SI nSwHayAdjuntosAva = 0;
          ||Si no tiene ningun adjunto. NO SE ENVIA EL CORREO.
          |ACABA;
     |FINSI;

     ||Por ahora SOLO soporta el envio NORMAL.
     ||El SMTPCLI, esta MUY enfocado al envio de facturaE.
     |HAZ MandaCorreo;
     |ACABA;
|FPRC;

|PROCESO AutoMultiEnvio;
     ||MultiEnvio (AUTOMULTIENVIO)
     nModoMultiDoc = 1;

     ||CargaInicial
     |HAZ MiniCargaInicial;

     ||ARA39
     ||Primero pido los datos que necesito para el correo
     ||como si fuera un correo normal.
     |PINPA #0#dsarw010;  nPanta1 = FSalida;
     |PINDA #0#dsarw010;

     |HAZ BotonPanta1;

     nRango = 4 + 8 + 16 + 32 + 128;
     |LINEAL_SIMPLE #1#dsarw077, nRango, 0810, 1498, NULL, NULL, NULL;
     nGrid977 = FSalida;

     nSwContinua = 0;
     |ENDATOS #1#dsarw010;
     |SI enErrorCorreo = 0;
         |HAZ GrabaConf;
     |FINSI;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton4;
     |PULSATECLA;

     |ACABA;
|FPRC;

|PROCESO EnviaAvisoDiagram;
     |DDEFECTO #dsarm064;

     aSwHistoricoEnv = eaGrabaHis;

     nModoMultiDoc = 1;
     |HAZ MiniCargaInicial;

     #dsarw010#3  = "Envio de documentos al DSESCAN";
     #dsarw010#41 = "Buenas";
     #dsarw010#42 = "";
     #dsarw010#43 = "Se han enviado documentos al DSESCAN, los documentos se relacionan en el ";
     #dsarw010#44 = "documento adjunto. ";
     #dsarw010#45 = "";
     #dsarw010#46 = "Saludos";

     #dsarw077#0  = "davidf@diagram.es;joaquin.molina@diagram.es;manolo@diagram.es";
     |LEE 000#dsarw077.=;
     |SI FSalida ! 0;
         #dsarw077#0  = "davidf@diagram.es;joaquin.molina@diagram.es;manolo@diagram.es";
         |GRABA 020#dsarw077.n;
         |LIBERA #dsarw077;
     |FINSI;

     |DBASE aAlfa;   |QBF aAlfa;
     aAlfa = aAlfa + "ocr/";
     aDocumento = aAlfa + "Envio" + Usuario + ".txt";

     |HAZ MandaCorreo;

     |FBORRA aDocumento;
|FPRC;

|PROCESO EnviaDPNTY001;
     |DDEFECTO #dsarm064;
     |DDEFECTO #dsarw010;

     aSwHistoricoEnv = "N";
     nModoMultiDoc    = 1;

     |HAZ MiniCargaInicial;

/*
     #dsarw010#3  = "Seguimiento Gesti¢n Laboral";

     #dsarw010#41 = "Se adjunta CSV con el detalle y se informa del seguimiento";
     #dsarw010#42 = "para el objetivo estipulado.";
     #dsarw010#43 = "";

     #dsarw010#44 = &9 + "Total de asesorias" + &9 + enEAgr;
     #dsarw010#45 = "";
     #dsarw010#46 = &9 + "Total de empresas ERP" + &9 + enEEmp;
     #dsarw010#47 = &9 + "Total de empresas en portal" + &9 + enEEmpX + &9 + "(faltan" + &9 + enEEmpL + ")";
     #dsarw010#48 = "";
     #dsarw010#49 = &9 + "Total de trabajadores en alta en ERP"  + &9 + enEAlt;
     #dsarw010#50 = &9 + "Total de trabajadores en alta portal"  + &9 + enEAltX + &9 + "(faltan" + &9 + enEAltL + ")";
     #dsarw010#51 = "";
     #dsarw010#52 = &9 + "Objetivo" + &9 + enEObj + " altas.";
     #dsarw010#53 = &9 + "Fecha objetivo" + &9 + efEObj;
     #dsarw010#54 = &9 + "Conseguido al d¡a de hoy el " + &9 + enEPor + "% del objetivo" ;
     #dsarw010#55 = "";
     #dsarw010#56 = &9 + "Dias laborales hasta final objetivo" + &9 + enEDia;
     #dsarw010#57 = &9 + "Media diaria para objetivo" + &9 + enEMed + &9 + "nuevos trabajadores en alta";
*/

     #dsarw010#3  = "Seguimiento Gesti¢n Laboral";

     #dsarw010#41 = "Se adjunta CSV con el detalle.";
     #dsarw010#42 = "";

     #dsarw010#43 = &9 + "Total de asesorias" + &9 + enEAgr;
     #dsarw010#44 = "";
     #dsarw010#45 = &9 + "Total de empresas ERP" + &9 + enEEmp;
     #dsarw010#46 = &9 + "Total de empresas en portal" + &9 + enEEmpX + &9 + "(faltan" + &9 + enEEmpL + ")";
     #dsarw010#47 = "";
     #dsarw010#48 = &9 + "Total de trabajadores en alta en ERP"  + &9 + enEAlt;
     #dsarw010#49 = &9 + "Total de trabajadores en alta portal"  + &9 + enEAltX + &9 + "(faltan" + &9 + enEAltL + ")";

     |PARA nCmp = 41;  |SI nCmp [ 57;  |HACIENDO nCmp = nCmp + 1;
           eaAlfa = #dsarw010#nCmp#;  |HAZ QuitaRaros;
           #dsarw010#nCmp# = eaAlfa;
     |SIGUE;

     #dsarw010#140 = "";
     #dsarw077#0   = eaECta;
     |LEE 000#dsarw077.=;
     |SI FSalida ! 0;
         #dsarw077#0   = eaECta;
         |GRABA 020#dsarw077.n;
         |LIBERA #dsarw077;
     |FINSI;

     aDocumento = eaDoc;

     |HAZ MandaCorreo;

     |FBORRA aDocumento;
|FPRC;

|PROCESO Adjuntar;
     eaRuta  = "";
     |HAZ Traete_dsselect;
     |SI enError = 1;
         |MENAV "0000No puedo instala el dsselect.exe, consulte con su administrador";
     |FINSI;

     |ESPECIFICA "RBASS", aLocal;
     aDirLocal = aLocal;

     |HAZ DimeUnidad;
     aAux      = eaUnidad + ":\DOCUMENTOS\DSARCHI\";
     aPrograma = aAux + "dsselect.exe";

     aPathDSSelect = aAux;

     aBorra = aPathDSSelect + "dsselect.txt";
     |RFBORRA aBorra;

     aParaIni = aAux + "dsselect.ini";
     |RFBORRA aParaIni;

     |ABRE #dsarm000;
     #dsarm000#0 = Usuario % 810;
     |LEE 000#dsarm000.=;
     |SI FSalida ! 0;
          |DDEFECTO #dsarm000;
     |FINSI;

     aCarpetaCaptura = #dsarm000#17;
     |QBF aCarpetaCaptura;
     |SI aCarpetaCaptura = "";
          aCarpetaCaptura = eaUnidadBasico;
     |FINSI;
     |CIERRA #dsarm000;

     aTextoIni = &34 + aCarpetaCaptura + &34 + " " + &34 + aBorra + &34;
     |XABRE "CW", aParaIni, nHandle;
     |SI FSalida ] 0;
          |XGRABA nHandle, aTextoIni;
     |FINSI;
     |XCIERRA nHandle;

     aEjecuta = aPrograma;
     |RSYSTEM aEjecuta;

     aAbre = aPathDSSelect + "dsselect.txt";
     |XABRE "CU", aAbre, nHandle;
     |SI FSalida < 0;
        aPath = "";
        nError = 1;
        |ACABA;
     |FINSI;

     |XLEE nHandle, 250, aPath;
     |SI FSalida < 0
         aPath = "";
         nError = 1;
         |ACABA;
     |FINSI;

     |QBF aPath;
     |SI aPath ! "";
         aAlfa    = aPath;
         aFichero = "";
         aLong    = aAlfa % 0;
         nLong    = aLong;
         eaRuta   = "";
         |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
               nPos   = (nCarac * 100) + 1;
               aCarac =  aAlfa % nPos;
               |SI aCarac = "/";  |O aCarac = "\";
                   aProg = "";
               |SINO;
                   aProg = aProg + aCarac;
               |FINSI;

               eaRuta = eaRuta + aCarac;
         |SIGUE;
     |FINSI;
     |XCIERRA nHandle;

     aBorra = aPathDSSelect + "dsselect.txt";
     |RFBORRA aBorra;

     |SI eaRuta ! ""; |Y aProg ! "";
          aCarpetaCaptura = eaRuta - aProg;
          |QBF aCarpetaCaptura;
          |SI aCarpetaCaptura ! "";
               |ABRE #dsarm000;
               #dsarm000#0 = Usuario % 810;
               |LEE 101#dsarm000.=;
               |SI FSalida ! 0;
                   |DDEFECTO #dsarm000;
                   #dsarm000#0 = Usuario % 810;
                   |GRABA 020#dsarm000.b;
               |FINSI;
               #dsarm000#17 = aCarpetaCaptura;
               |GRABA 000#dsarm000.a;
               |LIBERA #dsarm000;
               |CIERRA #dsarm000;
          |FINSI;
     |SINO;
         eaRuta = "";
         nError = 1;
         |ACABA;
     |FINSI;

|FPRC;

|PROCESO EnvioGeneral;
     aIPLocal = "";
     |IP_LOCAL aIPLocal;    |QBF aIPLocal;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;

     aQueSistema = "";
     |QUE_SISTEMA aQueSistema;  |QBF aQueSistema;

     |CABEZA "Envio de Correo";

     aDirOrigenUsu = "";
     |ABRE #dsarm032;
     |DDEFECTO #dsarm032;
     aUsuEnvio = Usuario % 810;
     #dsarm032#0 = aUsuEnvio;
     |LEE 000#dsarm032.=;
     |SI FSalida = 0;
          aDirOrigenUsu = #dsarm032#1;
          |QBT aDirOrigenUsu;
     |FINSI;
     |CIERRA #dsarm032;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "BLAT";
     |HAZ DSARCHI_INI;
     nSwBLAT = enAprobacion;
     enAprobacion = nGuarda;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "SMTPCLI";
     |HAZ DSARCHI_INI;
     nSwSMTPCLI = enAprobacion;
     enAprobacion = nGuarda;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "SMTPCLITODOS";
     |HAZ DSARCHI_INI;
     nSwSMTPCLIAll = enAprobacion;
     |SI nSwSMTPCLIAll = 1; |Y nSwSMTPCLI = 0;
          nSwSMTPCLI = 1;
     |FINSI;
     enAprobacion = nGuarda;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "SMTPSERVPROPIO";
     |HAZ DSARCHI_INI;
     nSwSMTPServPropio = enAprobacion;
     enAprobacion = nGuarda;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "DSENVIACORREO";
     |HAZ DSARCHI_INI;
     nSwDsEnviaCorreo = enAprobacion;
     enAprobacion = nGuarda;

     |ABRE #dsarm001;
     |LEE 000#dsarm001.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarm001;  |FINSI;
     |CIERRA #dsarm001;

     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     |SI aDirOrigenUsu ! "";
          #dsarw010#1 = aDirOrigenUsu;
     |FINSI;

     aEmailCotejo = "";

     |SI nSwBLAT = 1;
          |HAZ InstalaBlat;
     |FINSI;

     |HAZ PonAsunto;         |SI nError = 1;  |ACABA;  |FINSI;
     |HAZ VerConfiguracion;  |SI nError = 1;  |ACABA;  |FINSI;

     aDocumento = aDestino

     nSwWebMail = 0;
     |QBF eaDirDestino;
     |SI eaDirDestino ! "";
         #dsarw077#0 = eaDirDestino;
         |GRABA 020#dsarw077.n;
         |LIBERA #dsarw077;
     |FINSI;

     aSacaWebMail = "N";
     aAlfaExte = #dsarm005#9;
     |QBF aAlfaExte;
     aAlfaExte = aAlfaExte > aAlfaExte;
     aExtension = aAlfaExte % -104;
     |SI aExtension = ".HTM";
         aSacaWebMail = "S";
     |SINO;
         aExtension = aAlfaExte % -105;
         |SI aExtension = ".HTML";
             aSacaWebMail = "S";
         |FINSI;
     |FINSI;

     |VENTANA 0501, 3099, -1, 16, "Env¡o de correo";
     nVtnGnrl = FSalida;

     |PINPA #0#dsarw010;  nPanta1 = FSalida;
     |PINDA #0#dsarw010;

     |SI aSacaWebMail = "S";
         aLabel = "LABEL,{{11}}Insertar HTML archivado como Cuerpo";
         |CONTROL_SIMPLE nPanta1, aLabel, 3103, 3134, NULL;

         aLabel = "LABEL,{{11}}(Requiere m¢dulo SMTPCLI en servidor)";
         |CONTROL_SIMPLE nPanta1, aLabel, 3140, 3180, NULL;

         |C_V #dsarw010#39, 1, "S";
         |C_M #dsarw010#39, 1, "S";

         |PINTA #dsarw010#39;
     |FINSI;

     |HAZ BotonPanta1;

     |CONTROL_SIMPLE nPanta1, "BOTON,Adjuntar", 3102, 3110, Adjuntar;

     nRango = 4 + 8 + 16 + 32 + 128;
     |LINEAL_SIMPLE #1#dsarw077, nRango, 0810, 1498, NULL, NULL, NULL;
     nGrid977 = FSalida;

     |DDEFECTO #dsarm005;
     #dsarm005#89 = "N";

     |ENDATOS #1#dsarw010;

     |SI enErrorCorreo = 0;
         |HAZ GrabaConf;
     |SINO;
         |SI enDocumento ! 0;  |Y aDocumento ! "";
             |FBORRA aDocumento;
         |FINSI;
     |FINSI;

     |SI aFichAdjunto ! "";
         aAlfa = aPathAdjunto + aFichAdjunto;  |FBORRA aAlfa;
     |FINSI;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton4;
     |PULSATECLA;

     |FINVENTANA nVtnGnrl;

     |CIERRA #dsarm064;

     |CIERRA #dsarm061;
     |CIERRA #dsarm062;
|FPRC;

|PROGRAMA;
     |ABRE #dsarm061;
     |ABRE #dsarm062;

     |ABRE #dsarm064;

     eaRuta     = "";
     aParametro = PARAMETRO;
     |QBF aParametro;

     |SI aParametro = "DESDEMENU";
         |HAZ EnvioGeneral;
         |ACABA;
     |FINSI;

     |SI aParametro = "AUTOENVAVANZADO";
         |HAZ AutoEnvAvanzado;
         |ACABA;
     |FINSI;

     |SI aParametro = "AUTOMULTIENVIO";
         |HAZ AutoMultiEnvio;
         |ACABA;
     |FINSI;

     |SI aParametro = "ENVIAAVISODIAGRAM";
         |HAZ EnviaAvisoDiagram;
         |ACABA;
     |FINSI;

     |SI aParametro = "ENVIA_DPNTY001";
         |HAZ EnviaDPNTY001;
         |ACABA;
     |FINSI;

     nError = 0;
     |HAZ CargaInicial;
     |SI nError = 1;  |ACABA;  |FINSI;

     aAux3 = #dsarm005#91;
     |QBF aAux3;
     |SI aAux3 = "PDF";        ||NO son facturae propiamente dicho
          #dsarm005#89 = "S";         ||pero a efectos practicos, como si lo fueran
     |FINSI;                   ||por ahora se utiliza en facturaE COMPAQ

     ||ARA64
     |SI eaTipoCorreo = "nominas";
          |DDEFECTO #dsarm064;
          #dsarm064#0 = 3;
          #dsarm064#1 = enEmpCorreo;
          |LEE 000#dsarm064.=;
          |SI FSalida ! 0; |Y enEmpCorreo ! 0;
               #dsarm064#0 = 3;
               #dsarm064#1 = 0;
               |LEE 000#dsarm064.=;
          |FINSI;
     |SINO;
          |SI #dsarm005#89 = "S";
               |DDEFECTO #dsarm064;
               #dsarm064#0 = 2;
               #dsarm064#1 = enEmpCorreo;
               |LEE 000#dsarm064.=;
               |SI FSalida ! 0; |Y enEmpCorreo ! 0;
                    #dsarm064#0 = 2;
                    #dsarm064#1 = 0;
                    |LEE 000#dsarm064.=;
               |FINSI;
          |SINO;
               |DDEFECTO #dsarm064;
               #dsarm064#0 = 1;
               #dsarm064#1 = enEmpCorreo;
               |LEE 000#dsarm064.=;
               |SI FSalida ! 0; |Y enEmpCorreo ! 0;
                    #dsarm064#0 = 1;
                    #dsarm064#1 = 0;
                    |LEE 000#dsarm064.=;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI aParametro = "AUTO"; |O aParametro = "AUTODESDED9";
         |HAZ SiParametroEsAuto;
     |SINO;
         |HAZ SiParametroNoEsAuto;
     |FINSI;

     |SI nError = 1;  |ACABA;  |FINSI;

     |HAZ PonAsunto;         |SI nError = 1;  |ACABA;  |FINSI;
     |HAZ VerConfiguracion;  |SI nError = 1;  |ACABA;  |FINSI;
     |HAZ CopiaFicheroAlServidor;
     |HAZ FinVentana;        |SI nError = 1;  |ACABA;  |FINSI;

     aDocumento = aDestino;

     nSwWebMail = 0;
     |SI aParametro = "";
         |QBF eaDirDestino;
         |SI eaDirDestino ! "";
             #dsarw077#0 = eaDirDestino;
             |GRABA 020#dsarw077.n;
             |LIBERA #dsarw077;
         |FINSI;

         aSacaWebMail = "N";
         aAlfaExte = #dsarm005#9;
         |QBF aAlfaExte;
         aAlfaExte = aAlfaExte > aAlfaExte;
         aExtension = aAlfaExte % -104;
         |SI aExtension = ".HTM";
               aSacaWebMail = "S";
         |SINO;
              aExtension = aAlfaExte % -105;
              |SI aExtension = ".HTML";
                    aSacaWebMail = "S";
              |FINSI;
         |FINSI;

         ||ARA66
         |PINPA #0#dsarw010;  nPanta1 = FSalida;
         |PINDA #0#dsarw010;

         |SI aSacaWebMail = "S";
               aLabel = "LABEL,{{11}}Insertar HTML archivado como Cuerpo";
               |CONTROL_SIMPLE nPanta1, aLabel, 3103, 3134, NULL;

               aLabel = "LABEL,{{11}}(Requiere m¢dulo SMTPCLI en servidor)";
               |CONTROL_SIMPLE nPanta1, aLabel, 3140, 3180, NULL;

               |C_V #dsarw010#39, 1, "S";
               |C_M #dsarw010#39, 1, "S";

               |PINTA #dsarw010#39;
         |FINSI;

         |HAZ BotonPanta1;

         nRango = 4 + 8 + 16 + 32 + 128;
         |LINEAL_SIMPLE #1#dsarw077, nRango, 0810, 1498, NULL, NULL, NULL;
         nGrid977 = FSalida;

         |ENDATOS #1#dsarw010;

         |SI enErrorCorreo = 0;
             |HAZ GrabaConf;
         |SINO;
             |SI enDocumento ! 0;  |Y aDocumento ! "";
                 |FBORRA aDocumento;
             |FINSI;
         |FINSI;

         |FIN_CONTROL_WINDOWS nBoton1;
         |FIN_CONTROL_WINDOWS nBoton2;
         |FIN_CONTROL_WINDOWS nBoton3;
         |FIN_CONTROL_WINDOWS nBoton4;
         |PULSATECLA;
     |SINO;
         |SI nSwSMTPCLI = 1; |Y #dsarm005#89 = "S";
             |HAZ MandaCorreoSMTPCli;
         |SINO;
             |SI nSwSMTPCLI = 1; |Y eaTipoCorreo ! "";
                 |HAZ MandaCorreoSMTPCli;
             |SINO;
                 |SI nSwSMTPCLIAll = 1;
                      |HAZ MandaCorreoSMTPCli;
                 |SINO;
                      |SI nSwBLAT = 1; |Y #dsarm005#89 = "S";
                           |HAZ MandaCorreoBLAT;
                      |SINO;
                           |SI nSwDsEnviaCorreo = 1;
                               |HAZ DsEnviaCorreo;
                           |SINO;
                               |HAZ MandaCorreo;
                           |FINSI;
                      |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |CIERRA #dsarm064;

     |CIERRA #dsarm061;
     |CIERRA #dsarm062;
|FPRO;

|PROCESO agifm006;
     #dsarw077#0 = #agifm006@#6;
     |LEE 000#dsarw077.=;
     |SI FSalida ! 0;
         #dsarw077#0 = #agifm006@#6;
         #dsarw077#3 = "N";
         |GRABA 020#dsarw077.n;
         |LIBERA #dsarw077;
     |FINSI;
|FPRC;

|DEFBUCLE agifm006;
     #agifm006@#1002;
     16;
     aCli, 001, "S";
     aCli, 999, "S";
     ;
     NULL, agifm006;
|FIN;

|PROCESO MeteContactos;
     |SI eaEmpresaFE = "";
         |ACABA;
     |FINSI;

     |ABRE #dsarm005;
     #dsarm005#0 = enDocumento;
     |LEE 000#dsarm005.=;
     |SI FSalida ! 0;  |DDEFECTO #dsarm005;  |FINSI;
     |CIERRA #dsarm005;

     |DBASS aBass;

     |SI eaAplicacion = "dscomer9";
         aMas = aBass + "dscomer9/def/agifm006.mas";
         aFic = aBass + "dscomer9/fich/" + eaEmpresaFE + "/";
     |FINSI;

     |SI eaAplicacion = "dscomer8";
         aMas = aBass + "dscomer8/def/agifm006.mas";
         aFic = aBass + "dscomer8/fich/" + eaEmpresaFE + "/";
     |FINSI;

     |CARGA_DEF aMas, agifm006@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |PATH_DAT #agifm006@#aFic#;

     aCli = ("000000" + #dsarm005#8) % -106;
     |BUCLE agifm006;

     |DESCARGA_DEF #agifm006@;
|FPRC;

|PROCESO MeteVariables;
     |SI eaEmpresaFE = "";
         |ACABA;
     |FINSI;

     |ABRE #dsarm005;
     #dsarm005#0 = enDocumento;
     |LEE 000#dsarm005.=;
     |SI FSalida ! 0;  |DDEFECTO #dsarm005;  |FINSI;
     |CIERRA #dsarm005;

     |DBASS aBass;

     aMas = aBass + "dscomer9/def/agifa134.mas";
     aFic = aBass + "dscomer9/fich/" + eaEmpresaFE + "/";

     |CARGA_DEF aMas, agifa134@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aMas = aBass + "dscomer9/def/agifa133.mas";
     |CARGA_DEF aMas, agifa133@;
     |SI FSalida ! 0;
         |DESCARGA_DEF #agifa134@;
         |ACABA;
     |FINSI;

     aMas = aBass + "dscomer9/def/agifa024.mas";
     |CARGA_DEF aMas, agifa024@;
     |SI FSalida ! 0;
         |DESCARGA_DEF #agifa133@;
         |DESCARGA_DEF #agifa134@;
         |ACABA;
     |FINSI;

     |PATH_DAT #agifa134@#aFic#;
     |PATH_DAT #agifa133@#aFic#;
     |PATH_DAT #agifa024@#aFic#;

     |ABRE #agifa134@;
     #agifa134@#49 = #dsarm005#85;
     #agifa134@#0  = #dsarm005#86;
     |LEE 000#agifa134@.=;
     nOk = FSalida;
     |CIERRA #agifa134@;

     |ABRE #agifa133@;
     #agifa133@#4  = #dsarm005#85;
     #agifa133@#0  = #dsarm005#86;
     #agifa133@#1  = 1;
     |LEE 000#agifa133@.];
     |SI FSalida ! 0;  |O #agifa133@#4  ! #dsarm005#85;
                       |O #agifa133@#0  ! #dsarm005#86;
         |DDEFECTO #agifa133@;
     |FINSI;
     |CIERRA #agifa133@;

     |ABRE #agifa024@;
     #agifa024@#0  = #agifa134@#2;
     |LEE 000#agifa024@.=;
     |SI FSalida ! 0;
         |DDEFECTO #agifa024@;
     |FINSI;
     |CIERRA #agifa024@;

     |SI nOk ! 0;
         |DESCARGA_DEF #agifa024@;
         |DESCARGA_DEF #agifa133@;
         |DESCARGA_DEF #agifa134@;
         |ACABA;
     |FINSI;

     aSer  = #agifa134@#49;  |QBF aSer;
     aFac  = #agifa134@#0;

     |SI #agifa134@#1 > "01.01.2000";
         aFFa  = #agifa134@#1;
     |FINSI;

     aRazonSocial = #agifa134@#3;
     |QBF aRazonSocial;

     |SI #agifa134@#101 > 0;
         aIFa  = #agifa134@#101;
     |FINSI;

     |SI #agifa024@#11 ! "  ";
         aIBAN = #agifa024@#215 % 120;
         aIBAN = aIBAN + "****";
     |FINSI;

     |SI #agifa133@#3 > "01.01.2000";
         aFVe = #agifa133@#3;
     |FINSI;

     |SI #agifa133@#2 > 0;
         aIVe = #agifa133@#2;
     |FINSI;

     |DESCARGA_DEF #agifa024@;
     |DESCARGA_DEF #agifa133@;
     |DESCARGA_DEF #agifa134@;
|FPRC;

|PROCESO Tipo80;  |TIPO 80;
     aFichero = ("77" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #dsarw077#aFichero#;
     |ABRE #dsarw077;  |CIERRA #dsarw077;  |DELINDEX #dsarw077;
     |ABRET #dsarw077;

     |SI eaAplicacion = "dscomer9";  |O eaAplicacion = "dscomer8";
         |HAZ MeteContactos;
     |FINSI;

     aSer  = "";
     aFac  = "";
     aFFa  = "";
     aIFa  = "";
     aFVe  = "";
     aIVe  = "";
     aIBAN = "";

     |SI eaAplicacion = "dscomer9";
         |HAZ MeteVariables;
     |FINSI;

     FSalida = 2899;
|FPRC;

|PROCESO Tipo90;  |TIPO 90;
     aFichero = ("77" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #dsarw077#aFichero#;
     |ABRE #dsarw077;  |CIERRA #dsarw077;  |DELINDEX #dsarw077;
|FPRC;

|PROCESO DirEnvioExtrasOTP;
     |ACABA;
     ||POR AHORA NO HACE NADA, HASTA QUE ACLARE COMO BUSCAR LA INFO
     ||DEBUG;

     ||ARA47.  || Miro si esta instalado OTP.  (dspreven)
     || En tal caso miro leo si hay 2 direcciones de email en el visalm01
     || con datos, en tal caso a¤ado esas direcciones al dsarw077

     |DBASS aBass;

     aPathDefOTP = aBass + "dspreven/def/";
     aFic = aBass + "dspreven/fich/" + eaEmpresaFE + "/";
     aExisteOTP = aPathDefOTP + "otpw0001.mas";
     |XABRE "E", aExisteOTP, 0;
     |SI FSalida ] 0;
          aEmail2 = "";
          aEmail3 = "";

          aMas = aPathDefOTP + "visalm01";
          |CARGA_DEF aMas, referen@;
          |SI FSalida ! 0;  |ACABA;  |FINSI;

          |PATH_DAT #referen@#aFic#;

          |ABRE #referen@;
          |DDEFECTO #referen@;
          #referen@#0 = eaCodCliFe;
          |LEE 000#referen@.=;
          |SI FSalida = 0;
               aEmail2 = #referen@#128;
               aEmail3 = #referen@#129;
          |FINSI;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
     |FINSI;

     |SI aEmail2 ! "";
         |DDEFECTO #dsarw077;
         #dsarw077#0 = aEmail2;
         |LEE 000#dsarw077.=;
         |SI FSalida ! 0;
             #dsarw077#0 = aEmail2;
             |GRABA 020#dsarw077.n;
             |LIBERA #dsarw077;
         |FINSI;
     |FINSI;
     |SI aEmail3 ! "";
         |DDEFECTO #dsarw077;
         #dsarw077#0 = aEmail3;
         |LEE 000#dsarw077.=;
         |SI FSalida ! 0;
             #dsarw077#0 = aEmail3;
             |GRABA 020#dsarw077.n;
             |LIBERA #dsarw077;
         |FINSI;
     |FINSI;
|FPRC;
