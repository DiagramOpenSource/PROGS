|FICHEROS;
     dsarw079,MANTE;
     dsarw048,MANTE;

     dsarm001;
     dsarm002;
     dsarm003;
     dsarm004;
     dsarm005;
     dsarm101;

     dsarw010;
     dsarw013;
     dsarm036;

     dsarm100;

     dsarw046;
     dsarw047;

     :integral/dsam0003;
     :basica/agifigen;
     :basica/agicen20;
     :basica/agitab99;
     :modelos/dsmom004;
     :modelos/dsmod309;
     :contasoc/isacceso;
     :contasoc/isom9000;
|FIN;

|INCLUYE z1000var;

|PROCESO ChequeaTxt;
     enChequeo = 0;

     |HAZ MiraSiEs303;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs309;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs310;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs322;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs340;  |SI enChequeo = 1;  |ACABA;  |FINSI;

     |HAZ MiraSiEs130;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs131;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs110;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs115;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs123;  |SI enChequeo = 1;  |ACABA;  |FINSI;

     |HAZ MiraSiEs190;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs180;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs184;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs193;  |SI enChequeo = 1;  |ACABA;  |FINSI;

     |HAZ MiraSiEs390;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs347;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs349;  |SI enChequeo = 1;  |ACABA;  |FINSI;

     |HAZ MiraSiEs100;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs200;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs232;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs714;  |SI enChequeo = 1;  |ACABA;  |FINSI;

     |HAZ MiraSiEs202;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs210;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs211;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs216;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs218;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs296;  |SI enChequeo = 1;  |ACABA;  |FINSI;

     |HAZ MiraSiEs569;  |SI enChequeo = 1;  |ACABA;  |FINSI;

     |HAZ MiraSiEs036;  |SI enChequeo = 1;  |ACABA;  |FINSI;
     |HAZ MiraSiEs037;  |SI enChequeo = 1;  |ACABA;  |FINSI;
|FPRC;

|PROCESO DePDFaTIFUnix;
     |DBASE aBaseUnix;   |QBF aBaseUnix;

     aBaseAux = "";
     aBaseAux = aBaseUnix + "aux/";
     |MKDIR aBaseAux;

     aNomDoc = eaFicRes;  |QBF aNomDoc;
     aNomDoc = aNomDoc < "";

     aPathLog = aBaseAux + "logs/";
     |MKDIR aPathLog;

     aConvierteLog = aPathLog + "convierte" + aNumeroDoc + ".log";
     aConvierteErr = aPathLog + "convierte" + aNumeroDoc + ".err";

     aFicOrigen  = aFichero;
     aFicDestino = aBaseAux + aNomDoc;

     aExtension = aFichero % -104;
     |SI aExtension = ".PDF";
         aDestinoDos = aFichero - ".PDF";
     |SINO;
         aDestinoDos = aFichero - ".pdf";
     |FINSI;

     aDestinoDos    = aDestinoDos + ".tif";
     aFicDestinoTif = aFicDestino - ".pdf";
     aFicDestinoTif = aFicDestinoTif + ".tif";

     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
          |RECIBE_FICHERO aFicOrigen, aFicDestino;
     |SINO;
          |COPIA_FICHERO aFicOrigen, aFicDestino;
     |FINSI;

     ||UNIX
     aAbreShell = aBaseAux + "convierte.sh";
     |XABRE "WB", aAbreShell, nHandle;

     aEjecuta = "PATH=:.:/usr/agibin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin"
     aAlfa = aEjecuta + &10;
     |XGRABA nHandle, aAlfa;

     aEjecuta = "convert -page A4 -density 300x300 -type bilevel -compress lzw ";
     |XGRABA nHandle, aEjecuta;

     aEjecuta = aFicDestino + "[0-1] " + aFicDestinoTif;
     |XGRABA nHandle, aEjecuta;

     aEjecuta = " > " + aConvierteLog + " 2> " + aConvierteErr + &10;
     |XGRABA nHandle, aEjecuta;

     |XCIERRA nHandle;

     aEjecuta = "chmod 755 " + aAbreShell;
     |SYSTEM aEjecuta;

     aEjecuta = aAbreShell;
     |SYSTEM aEjecuta;

     aFicOrigen  = aFicDestinoTif;
     aFicDestino = aDestinoDos;
     |SI aIPRemoto ! "";
          |ENVIA_FICHERO aFicOrigen, aFicDestino;
     |SINO;
          |COPIA_FICHERO aFicOrigen, aFicDestino;
     |FINSI;

     aTipoDoc = "tif";
     aDestino = aDestinoDos;

     aBorra = aBaseAux + aNomDoc;  |FBORRA aBorra;
     aBorra = aAbreShell;          |FBORRA aBorra;
     aBorra = aFicDestinoTif;      |FBORRA aBorra;
     aFicheroTIF = aDestino;
|FPRC;

|PROCESO DePDFaTIF;
     aAlfa = aDirBaseLocal + "imagemagick\convert.exe ";

     aExtension = aFichero % -104;
     |SI aExtension = ".PDF";
         aDestinoDos = aFichero - ".PDF";
     |SINO;
         aDestinoDos = aFichero - ".pdf";
     |FINSI;

     aPathLog = aDirBaseLocal + "logs\";
     |RMKDIR aPathLog;

     aConvierteLog = aPathLog + "convierte" + aNumeroDoc + ".log";
     aConvierteErr = aPathLog + "convierte" + aNumeroDoc + ".err";

     aDestinoDos = aDestinoDos + ".tif";

     aAbreBat = aDirBaseLocal + "convierte.bat";
     |XABRE "WCB", aAbreBat, nHandle;

     aAlfa = "@ECHO OFF" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aLetra = aDirBaseLocal % 101;
     aAlfa = aLetra + ":" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa =  "DEL " + aDestinoDos + ".fin" + " 2> " + aDirBaseLocal + "del.log" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "CD " + aDirBaseLocal + "imagemagick" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "convert.exe" + " -density 300x300 -type bilevel -compress lzw";

     aAlfa =  aAlfa + " " + aFichero + "[0-1] " + aDestinoDos;
     aAlfa = aAlfa + " > " + aConvierteLog + " 2> " + aConvierteErr + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aDestinoFin = aDestinoDos + ".fin";

     aAlfa =  "echo FIN > " + aDestinoFin + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "exit" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;

     aEjecuta  = "cmd " + &34 + "/c START /MIN " + aAbreBat + &34;
     |RSYSTEM aEjecuta;

     nContador = 0;
     |PARA;  |SI;  |HACIENDO;
           |XABRE "EC", aDestinoDos, nHandle;
           |SI FSalida ] 0;  |SAL;  |FINSI;

           |SLEEP 1;

           |SI nContador ] 30;
                |XABRE "EC", aDestinoFin, nHandle;
                |SI FSalida ] 0;
                     |SI enSwModoSilencio = 1;
                          eaErrorDsEscan  = "Error al convertir el PDF a TIF. Revise " + aConvierteErr;
                          nSwHayErrorSil  = 1;
                          |SAL;
                     |SINO;
                          aMensaje = "0000Error al convertir el PDF a TIF. Revise " + aConvierteErr;
                          |MENAV aMensaje;
                          |SAL;
                     |FINSI;
                |FINSI;
           |FINSI;

           nContador = nContador + 1;
           |SI nContador ] 180;  |SAL;  |FINSI;
     |SIGUE;

     |RFBORRA aDestinoFin;
     |RFBORRA aAbreBat;

     aTipoDoc    = "tif";
     aDestino    = aDestinoDos;
     aFicheroTIF = aDestino;
|FPRC;

|PROCESO Identify;
     nErrorIdentify = 0;

     aAlfa = aDirBaseLocal + "imagemagick\identify.exe";
     |XABRE "EC", aAlfa, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aAbreBat = aDirBaseLocal + "identify.bat";
     |XABRE "WCB", aAbreBat, nHandle;

     aLetra = aDirBaseLocal % 101;
     aAlfa = aLetra + ":" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "CD " + aDirBaseLocal + "imagemagick" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aIdentify = aDirBaseLocal + "identify.txt";

     aAlfa = "identify.exe -format " + &34 + " %%[xresolution] %%[yresolution] %%b" + &34;
     aAlfa =  aAlfa + " " + aDestino + " > " + aIdentify + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "exit " + &13 + &10;
     |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;

     aEjecuta  = "cmd " + &34 + "/c START /MIN " + aAbreBat + &34;
     |RSYSTEM aEjecuta;

     nContador = 0;
     |PARA;  |SI;  |HACIENDO;
          |XABRE "EC", aIdentify, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |SLEEP 1;

          nContador = nContador + 1;
          |SI nContador ] 60;  |SAL;  |FINSI;
     |SIGUE;

     |XABRE "CU", aIdentify, nHandle;
     |XLEE nHandle, 250, aLinea;
     |XCIERRA nHandle;

     |QBF aLinea;
     |SI aLinea = "";  |ACABA;  |FINSI;

     |QBF aLinea;
     aLong   = aLinea % A0;
     nLong   = aLong;
     nParam  = 1;
     aParam1 = "";
     aParam2 = "";
     aParam3 = "";
     |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
          nSaca  = (nVoy * 100) + 1;
          aLetra = aLinea % nSaca;
          |SI aLetra = " ";  |Y aParam1 ! "";
              nParam = nParam + 1;
          |FINSI;

          |SI nParam = 1; aParam1 = aParam1 + aLetra;  |FINSI;
          |SI nParam = 2; aParam2 = aParam2 + aLetra;  |FINSI;
          |SI nParam = 3; aParam3 = aParam3 + aLetra;  |FINSI;

          |SI nParam ] 4;  |SAL;  |FINSI;
     |SIGUE;

     nParam1 = aParam1 ! 0;
     nParam2 = aParam2 ! 0;
     nParam3 = aParam3 ! 0;

     |SI nParam1 < #dsarm001#176; |O nParam2 < #dsarm001#177; |O nParam3 > #dsarm001#175;
         nErrorIdentify = 1;
     |FINSI;

     |RFBORRA aIdentify;
|FPRC;

|PROCESO ChequeaTIF;
     |HAZ Identify;

     aDirBaseResOCR = aDirBaseLocal + "ocr\";
     aNomResOCR     = eaFicRes < "";
     aNomResOCR     = aNomResOCR - ".pdf" + ".tif.txt";
     aRespuestaOCR  = aDirBaseResOCR + aNomResOCR;
     |RFBORRA aRespuestaOCR;

     |SI nErrorIdentify = 1;
         |XABRE "ABC", aRespuestaOCR, nHandle;

         aAlfa = "IMAGEN NO VALIDA" + &13 + &10;
         |XGRABA nHandle, aAlfa;

         |SI nParam1 < #dsarm001#176; |O nParam2 < #dsarm001#177;
             eaAlfa = "Resoluci¢n de la imagen: " + nParam1 + " X " + nParam2;
             eaAlfa = eaAlfa + " es inferior a la de los par†metros de la aplicaci¢n: " + #dsarm001#176 + " X " + #dsarm001#177;
             eaAlfa = eaAlfa + &13 + &10;
             |HAZ QuitaRaros;

             |XGRABA nHandle, eaAlfa;
         |FINSI;

         |SI nParam3 > #dsarm001#175;
             eaAlfa = "Tama§o de la imagen: " + nParam3 + " es superior a la de los par†metros de la aplicaci¢n: "  + #dsarm001#175;
             eaAlfa = eaAlfa + &13 + &10;
             |HAZ QuitaRaros;

              |XGRABA nHandle, eaAlfa;
         |FINSI;

         |XCIERRA nHandle;

         |ACABA;
     |FINSI;

     aIPServOCR = #dsarm001#166;   |QBF aIPServOCR;
     nPuerto    = #dsarm001#167;
     |SI nPuerto ! 0;
         aIPServOCR = aIPServOCR + ":" + nPuerto;
     |FINSI;

     aAlfa = aDirBaseLocal + "bin/dsescan_cli.exe " + aFicheroTIF + " " + aIPServOCR + " " + aParamIni;

     |XABRE "CE", aFicheroTIF, nHandleE;
     |SI FSalida < 0;
         |SI enSwModoSilencio = 0;
             aMensaje = "0000No existe la imagen " + aFicheroTIF;
             |MENAV aMensaje;
         |SINO;
             |SI nSwHayErrorSil = 0;
                 eaErrorDsEscan  = "No existe la imagen " + aFicheroTIF;
                 nSwHayErrorSil = 1;
             |FINSI;
         |FINSI;

         aSwLanzaDsEscan = "NO";
     |FINSI;
|FPRC;

|PROCESO LanzaDsEscan;
     |SI aSwLanzaDsEscan = "NO";
         aSwLanzaDsEscan = "";
         |ACABA;
     |FINSI;

     |QBF aIPServOCR;
     |QBF aParamIni;

     |SI aIPServOCR = ""; |O aParamIni = "";
         |SI enSwModoSilencio = 0;
             |SI aIPServOCR = "";
                 aMensaje = "0000Error Direcci¢n del servidor dsEscan vacia";
             |SINO;
                 aMensaje = "0000Error Par†metros dsEscan vacios";
             |FINSI;
             |MENAV aMensaje;
         |SINO;
             |SI nSwHayErrorSil = 0;
                 |SI aIPServOCR = "";
                     eaErrorDsEscan = "Error Direcci¢n del servidor dsEscan vacia";
                 |SINO;
                     eaErrorDsEscan = "Error Par†metros dsEscan vacios";
                 |FINSI;
                 nSwHayErrorSil = 1;
             |FINSI;
         |FINSI;

         |ACABA;
     |FINSI;

     |RSYSTEM aAlfa;

     |PULSATECLA;

     enSwRealizadodsEscan = 1;

     nTimeOut    = 0;
     nSwErrorOCR = 0;
     |PARA;  |SI;  |HACIENDO;
          |XABRE "EC", aRespuestaOCR, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |SLEEP 1;

          nTimeOut = nTimeOut + 1;
          |SI nTimeOut = 5;
              nSwErrorOCR = 1;
              |SAL;
          |FINSI;
     |SIGUE;


     aOrigen  = aRespuestaOCR;
     aDestino = eaRuta + "\" + (aNomResOCR - ".tif.txt") + ".txt";
     |RCOPIA_FICHERO aOrigen, aDestino;

     |HORA aHoraOCR;
     fFechaOCR = ~;
     aHoraOCR  = aHoraOCR % 105;
     aFicOCR   = eaFicRes;
|FPRC;

|PROCESO SacaTabs;
     ||Devuelve en aTabX, el valor del campo separado por tabuladores.

     nContador = 0;
     aTab1     = "";
     aTab2     = "";
     aTab3     = "";
     aTab4     = "";
     aTextAux  = "";
     aLong     = aLineaLog % A0;
     nLong     = aLong;

     |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
          aSaca = nVoy + "01";
          aLetra = aLineaLog % aSaca;
          |SI aLetra = aTab; |O aLetra = a10; |O aLetra = a13;
               nContador = nContador + 1;
               |SI nContador = 1;
                    aTab1 = aTextAux;
               |FINSI;
               |SI nContador = 2;
                    aTab2 = aTextAux;
               |FINSI;
               |SI nContador = 3;
                    aTab3 = aTextAux;
               |FINSI;
               |SI nContador = 4;
                    aTab4 = aTextAux;
               |FINSI;
               aTextAux = "";
          |SINO;
               aTextAux = aTextAux + aLetra;
          |FINSI;
     |SIGUE;

     |SI nContador = 1;
          aTab2 = aTextAux;
     |FINSI;
     |SI nContador = 2;
          aTab3 = aTextAux;
     |FINSI;
     |SI nContador = 3;
          aTab4 = aTextAux;
     |FINSI;

     nContador = 0;
|FPRC;

|PROCESO CargaValores;
     |SI aTab1 = "MD000000_Electronico";  eaElect     = aTab2;  |FINSI;

     |SI aTab1 = "MD000000_Justificante"; eaJusti     = aTab2;  |FINSI;

     |SI aTab1 = "MD000000_Modelo";       enModelo    = aTab2;  |FINSI;

     |SI aTab1 = "MD000000_NIF";          eaDni       = aTab2;  |FINSI;

     |SI aTab1 = "MD000000_Periodo";
         eaPeriodo = "";
         aCadena  = aTab2;
         |HAZ CargaPeriodoCalc;
         |SI eaPeriodo = "";  eaPeriodo = "99";  |FINSI;
     |FINSI;

     |SI aTab1 = "MD000000_Ejercicio";
         eaEjercicio = aTab2 - ".";
     |FINSI;
|FPRC;

|PROCESO TrataRegistro;
     |SI FSalida = 0;  |ACABA;  |FINSI;

     |QBF aLineaLog;

     |SI aLineaLog = "IMAGEN NO VALIDA";
         nParteNVAL     = 1;
         nSwErrorOCRLog = 1;
         aErrorOCR      = "El documento ha sido marcado como no v†lido. Pinche en ";
         aErrorOCR      = aErrorOCR + &34 + "Ver texto dsEscan" + &34 + " para ver el motivo";
         |ACABA;
     |FINSI;

     |SI aLineaLog = " Error no se puede procesar este tipo de fichero.";
         nParteNVAL     = 1;
         nSwErrorOCRLog = 1;
         aErrorOCR      = "El documento ha sido marcado como no v†lido. Pinche en ";
         aErrorOCR      = aErrorOCR + &34 + "Ver texto dsEscan" + &34 + " para ver el motivo";
         |ACABA;
     |FINSI;

     |SI nParteNVAL = 1;
         |ACABA;
     |FINSI;

     aLetraIni = aLineaLog % 101;
     aLetraFin = aLineaLog % -101;
     |SI aLetraIni = "["; |Y aLetraFin = "]";
         aCincoFinal = aLineaLog % -105;
         aNueveFinal = aLineaLog % -109;
         |SI aNueveFinal = "_ocr.txt]";
             nParteOCR = 1;
             nParteVAR = 0;
             nParteLOG = 0;
         |SINO;
             |SI aNueveFinal = "_var.txt]";  |O aCincoFinal = "_var]";
                 nParteOCR = 0;
                 nParteVAR = 1;
                 nParteLOG = 0;
             |SINO;
                 |SI aNueveFinal = "_log.txt]";
                     nParteOCR = 0;
                     nParteVAR = 0;
                     nParteLOG = 1;
                 |FINSI;
             |FINSI;
         |FINSI;
     |SINO;
         |SI aLetraIni = "[";
             aAlfaLog = aLineaLog % 111;
             |SI aAlfaLog = "[PLANTILLA]";
                 |HAZ SacaTabs;

                  aCodPlantilla = aTab2;   |QBF aCodPlantilla;
                  aDesPlantilla = aTab3;   |QBF aDesPlantilla;

                                   nDecimales = aTab4;
                  |SI aTab4 = "";  nDecimales = 2;  |FINSI;
                  |SI nDecimales = 0;
                       nDecimales = 2;
                  |FINSI;
             |FINSI;

             |SI aAlfaLog = "[PROCESOPI]";
                 |HAZ SacaTabs;

                 aProcesoPI = aTab2 % 108;  |QBF aProcesoPI;
             |FINSI;
         |FINSI;

         ||Procesa las lineas, segun el tipo.
         |SI nParteOCR = 1;
             ||Por ahora NADA.
         |FINSI;

         |SI nParteVAR = 1;
             aAlfaLog = aLineaLog % 111;
             |SI aAlfaLog ! "[PLANTILLA]"; |Y aAlfaLog ! "[PROCESOPI]";
                 |HAZ SacaTabs;
                 |SI aTab1 ! ""; |Y aTab2 ! "";
                     |DDEFECTO #dsarm036;
                     #dsarm036#0 = aProcesoPI;
                     #dsarm036#1 = aTab1;
                     |LEE 000#dsarm036.=;
                     |SI FSalida = 0;
                         |HAZ CargaValores;
                     |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;

         |SI nParteLOG = 1;
             aAlfaLog = aLineaLog % 106;
             |SI aAlfaLog = "Error "; |O aAlfaLog = " Error";
                  nSwErrorOCRLog = 1;
                  aErrorOCR = aLineaLog;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO SacaDatosRespuesta;
     aTab           = &9;
     a10            = &10;
     a13            = &13;
     aNueveFinal    = "";
     aCincoFinal    = "";
     nSwErrorOCRLog = 0;
     aErrorOCR      = "";
     aCodPlantilla  = "";
     aDesPlantilla  = "";
     aProcesoPI     = "";
     nParteOCR      = 0;
     nParteVAR      = 0;
     nParteLOG      = 0;
     nParteNVAL     = 0;
     eaEjercicio    = "";
     eaPeriodo      = "";
     eaJusti        = "";
     eaElect        = "";
     eaDni          = "";
     eaDni2         = "";
     eaTributa      = "";
     enModelo       = 0;
     enCompl        = 0;
     eaFecPre       = "";

     |XABRE "CU", aRespuestaOCR, nHandleLog;
     |SI FSalida ] 0;
          |PARA; |SI; |HACIENDO;
               |XLEE nHandleLog, 250, aLineaLog;
               |SI FSalida < 0;  |SAL;  |FINSI;

               |HAZ TrataRegistro;
          |SIGUE;
     |FINSI;

     |XCIERRA nHandleLog;
|FPRC;

|PROCESO dsarm005F;
     aOrigen  = #dsarm005#7;  |QBF aOrigen;
     aOrigen  = aOrigen + #dsarm005#9;  |QBF aOrigen;
     aDestino = aFichero;

     |SI #dsarm001#7 = "N";
         aContiene1 = aDestino;
         |ESPECIFICA "REMOTOMD5", aContiene;
         aDocRemoto = FSalida;  |QBF aDocRemoto;

         aContiene1 = aOrigen;
         |ESPECIFICA "MD5", aContiene;
         aDocServidor = FSalida;  |QBF aDocServidor;

         |SI aDocRemoto = aDocServidor;
             nEsta = 1;
             |ERROR10;
         |FINSI;
     |SINO;
          aContiene1 = aDestino;
          |ESPECIFICA "REMOTOMD5", aContiene;
          aDocRemoto = FSalida;  |QBF aDocRemoto;

          aContiene1 = aOrigen;
          |ESPECIFICA "REMOTOMD5", aContiene;
          aDocServidor = FSalida;  |QBF aDocServidor;

          |SI aDocRemoto = aDocServidor;
              nEsta = 1;
              |ERROR10;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm005F;
     #dsarm005#16;
     ;
     eaFicRes,         1;
     eaFicRes, 999999999;
     ;
     NULL, dsarm005F;
|FIN;

|PROCESO PonColor;
     aColor   = "";
     nEsta    = 0;
     eaFicRes  = #dsarw046#10;  |QBF eaFicRes;
     aFichero = eaRuta + "\" + #dsarw046#10;  |QBF aFichero;

     |SI #dsarw046#11 = "*";
         aColor = eaAzul;
     |FINSI;

     |SI aColor = "";
         |BUCLE dsarm005F;
         |SI nEsta = 1;  aColor = eaVerde;  |FINSI;
     |FINSI;

     |SI aColor = "";
         |SI #dsarw046#4 = 0;  |O #dsarw046#1 = 0;
          |O #dsarw046#2 = 0;  |O #dsarw046#3 = 0;
             aColor = eaRojo;
         |FINSI;
     |FINSI;

     #dsarw046#12 = aColor;
|FPRC;

|PROCESO BuscaCliente;
     |HAZ LeeCliente;
     |SI enIdeCli < 0;  enIdeCli = 0;  |FINSI;

     #dsarw046#1 = enIdeCli;
     #dsarw046#6 = eaNomCli;
|FPRC;

|PROCESO LeeCliDNIz1;
     |QBF eaDni;
     |SI eaDni = "";  |ACABA;  |FINSI;

     |SI enModelo = 100;  |O enModelo = 102;
         |SI enSwEstaIntegral = 1;
             |SELECT #2#dsam0003;
             #dsam0003#1 = eaDni;
             |LEE 000#dsam0003.=;
             |SI FSalida = 0;
                 enIdeCli = #dsam0003#0;
                 |HAZ BuscaCliente;
                 |ACABA;
             |FINSI;

             |SELECT #3#dsam0003;
             #dsam0003#35 = eaDni;
             |LEE 000#dsam0003.=;
             |SI FSalida = 0;
                 enIdeCli = #dsam0003#0;
                 |HAZ BuscaCliente;
                 |ACABA;
             |FINSI;
         |FINSI;
     |FINSI;

     |ABRE #agifigen;
     |SELECT #4#agifigen;
     #agifigen#13 = eaDni;
     |LEE 000#agifigen.=;
     |SI FSalida ! 0;  |DDEFECTO #agifigen;  #agifigen#0 = 0;  |FINSI;
     |CIERRA #agifigen;
     |SELECT #1#agifigen;

     enIdeCli = #agifigen#0;
     |HAZ BuscaCliente;
|FPRC;

|PROCESO LeeClienteRenta;
     nEmpresa = 0;

     |QBF aDni;
     |SI aDni = "";  |ACABA;  |FINSI;

     |ABRE #agifigen;
     |SELECT #4#agifigen;
     #agifigen#13 = aDni;
     |LEE 000#agifigen.=;
     |SI FSalida ! 0;  |DDEFECTO #agifigen;  #agifigen#0 = 0;  |FINSI;
     |CIERRA #agifigen;
     |SELECT #1#agifigen;

     nEmpresa = #agifigen#0;
     |SI nEmpresa ! 0;  |ACABA;  |FINSI;

     |SI enSwEstaIntegral = 1;
         |SELECT #2#dsam0003;
         #dsam0003#1 = aDni;
         |LEE 000#dsam0003.=;
         |SI FSalida = 0;
             nEmpresa = #dsam0003#0;
             |ACABA;
         |FINSI;

         |SELECT #3#dsam0003;
         #dsam0003#35 = aDni;
         |LEE 000#dsam0003.=;
         |SI FSalida = 0;
             nEmpresa = #dsam0003#0;
             |ACABA;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaResultadoOCR;
     |DDEFECTO #dsarw046;

     aAlfa    = eaJusti;   |QBT aAlfa;
     aLong    = aAlfa % 0;
     nLong    = aLong;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos   = (nCarac * 100) + 1;
           aCarac =  aAlfa % nPos;
           |SI aCarac ! "0";  |Y aCarac ! "1";  |Y aCarac ! "2"; |Y aCarac ! "3";
            |Y aCarac ! "4";  |Y aCarac ! "5";  |Y aCarac ! "6"; |Y aCarac ! "7";
            |Y aCarac ! "8";  |Y aCarac ! "9";
               eaJusti = "";
               |SAL;
           |FINSI;
     |SIGUE;

     |QBT eaJusti;
     |QBT eaElect;

     aAlfa = eaElect % 0;
     |SI aAlfa ! "16";  eaElect = "";  |FINSI;

     aAlfa = eaJusti % 0;
     |SI aAlfa ! "13";  eaJusti = "";  |FINSI;

     #dsarw046#0  = nConta;
     |LEE 101#dsarw046.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsarw046;
         #dsarw046#0  = nConta;
         |GRABA 020#dsarw046.b;
     |FINSI;

     #dsarw046#1  = 0;
     #dsarw046#2  = eaEjercicio;
     #dsarw046#3  = eaPeriodo;
     #dsarw046#4  = enModelo;
     #dsarw046#5  = enCompl;
     #dsarw046#7  = eaElect;
     #dsarw046#8  = eaJusti;
     #dsarw046#9  = eaDni;
     #dsarw046#10 = eaFicRes;
     #dsarw046#13 = eaFecPre;  || Solo 036 y 037

     |ABRE #dsam0003;
     |HAZ LeeCliDNIz1;
     |CIERRA #dsam0003;

     |SI #dsarw046#4 = 0;
         #dsarw046#6 = aErrorOCR;
     |SINO;
         |SI #dsarw046#1 = 0;
             #dsarw046#6  = "Empresa sin identificar";
         |FINSI;
     |FINSI;

     |HAZ PonColor;

     |GRABA 020#dsarw046.a;
     |LIBERA #dsarw046;

     |PULSATECLA;
     aContiene1 = aFichero;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     |ABRE #dsarm101;
     |SELECT #2#dsarm101;
     #dsarm101#1 = aDocRemoto;
     |LEE 101#dsarm101.=;
     |SI FSalida = 0;
         #dsarm101#2 = aCodPlantilla;
         |GRABA 020#dsarm101.a;
         |LIBERA #dsarm101;
     |FINSI;
     |CIERRA #dsarm101;
|FPRC;

|PROCESO CorreoEnUnix;
     aAlfa = #dsarw010#18;  |QBF aAlfa;
     |SI aAlfa ! aIPRemoto;  |ACABA;  |FINSI;

     |ESPECIFICA "RBASS", aLocal;
     aBaseLocal = aLocal;

     aDestino   = aBaseLocal + "bin/dscorreo.exe";
     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aVersion1  = FSalida;  |QBF aVersion1;

     |DBASE aBase;  |QBF aBase;
     aOrigen    = aBase + "dlls/dscorreo.exe";
     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aVersion2  = FSalida;  |QBF aVersion2;

     |SI aVersion1 ! aVersion2;
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aAlfa  = "cmd " + &34 + "/c START /MIN " + aDestino + &34;
     |RSYSTEM aAlfa;

     |MENSA "         ";
     |PULSATECLA;
     |SLEEP 1;
|FPRC;

|PROCESO CorreoEnDos;
     |SI aIPRemoto ! "";  |ACABA;  |FINSI;

     |IP_LOCAL aIPLocal;
     |QBF aIPLocal;

     aAlfa = #dsarw010#18;  |QBF aAlfa;
     |SI aAlfa ! aIPLocal;  |ACABA;  |FINSI;

     |DBASE aBase;  |QBF aBase;
     aOrigen    = aBase + "dlls/dscorreo.exe";

     aAlfa  = "cmd " + &34 + "/c START /MIN " + aOrigen + &34;
     |SYSTEM aAlfa;

     |MENSA "         ";
     |PULSATECLA;
     |SLEEP 1;
|FPRC;

|PROCESO CargaTexto;
|FPRC;

|PROCESO DsEnviaCorreo;
     eaAdjuntoPLB   = aDestino;
     aIP            = #dsarw010#19;  |QBF aIP;
     eaServidorSMTP = aIP;
     eaPassPLB      = #dsarw010#22;
     eaUsuarioPLB   = #dsarw010#21;
     eaOrigenPLB    = aFrom;
     eaDirRespoPLB  = eaOrigenPLB;

     aTo            = aEmailDestino;
     |QBF aTo;
     eaDestinoPLB   = aTo;

     |DBASE aBase;  |QBF aBase;
     |HAZ QuitaBarras;

     |SI nAjuste = 0;
         aAsunto  = "MD" + (aAuxExtension - ".") > "";
         eaAlfa   = "Documento dsEscan sin plantilla.";
         eaAlfa   = eaAlfa + " Tipo imagen: " + aAsunto;
         eaAlfa   = eaAlfa + " Cod: " + aIni + aAuxBarra + aNumeroDoc;
     |SINO;
         aAsunto  = aCodPlantilla + "MDAJUSTES" + (aAuxExtension - ".") > "";
         eaAlfa   = "Documento dsEscan para ajustar en DS.";
         eaAlfa   = eaAlfa + " Tipo imagen: " + aAsunto;
         eaAlfa   = eaAlfa + " Cod: " + aIni + aAuxBarra + aNumeroDoc;
     |FINSI;

     aMensaje = "";
     |DBASE aBase;
     |QBF aBase;
     aCuerpo = aBase + "documentos";  |MKDIR aCuerpo;
     aCuerpo = aBase + "documentos/correos";  |MKDIR aCuerpo;
     aCuerpo = aCuerpo + "/cuerpo" + aNumeroDoc + ".txt";
     |XABRE "WB", aCuerpo, nHandleC;
     |SI FSalida ] 0;
          aAlfa = eaAlfa + &13 + &10;
          |XGRABA nHandleC, aAlfa;

          |SI nAjuste = 1;
              aAlfa = "" + &13 + &10;
              |XGRABA nHandleC, aAlfa;

              |PARA nCampo = 3; |SI nCampo [ 22; |HACIENDO nCampo = nCampo + 1;
                    aAlfa = #dsarw079#nCampo#;
                    |QBF aAlfa;
                    aAlfa = aAlfa + &13 + &10;
                    |XGRABA nHandleC, aAlfa;
               |SIGUE;
          |FINSI;

          |XCIERRA nHandleC;

          aMensaje = "$$$$" + aCuerpo;
     |SINO;
          aMensaje = eaAlfa;
          |SI enSwModoSilencio = 1;
               eaErrorDsEscan = "Error al generar " + aCuerpo;
          |SINO;
               aTextoMe = "0000Error al generar " + aCuerpo;
               |MENAV aTextoMe;
          |FINSI;
     |FINSI;

     |SI #dsarw010#23 = "S";
          eaConfLecPLB = "S";
     |SINO;
          eaConfLecPLB = "N";
     |FINSI;
     eaAsuntoPLB = aAsunto;
     eaCuerpoPLB = aCuerpo;

     enSwErrorCorreoPLB = 0;
     |HAZ DSEnviaCorreoPLB;

     |SI enSwErrorCorreoPLB = 1;
          |SI enSwModoSilencio = 1;
               eaErrorDsEscan = "Error al enviar el correo. [dsenviacorreo]";
          |SINO;
               aMensaje = "0000Error al enviar el correo. [dsenviacorreo]";
               |MENAV aMensaje;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MandaCorreo;
     |VENTANA 0501, 2799, -1, 1, "";
     nVent1 = FSalida;

     |PINPA #0#dsarw013;
     |PINDA #0#dsarw013;
     |PTEC 802;
     |PAUSA;

     |IP_REMOTO aIPRemoto;
     |QBF aIPRemoto;

     aAdjunto = aDestino;

     |SI aQueSistema = "ESDOS";
         |HAZ CorreoEnDos;
         |SI aIPRemoto ! "";
             |HAZ CorreoEnUnix;
         |FINSI;
     |SINO;
          |HAZ CorreoEnUnix;
     |FINSI;

     aIP = "";
     aIP = #dsarw010#18;  |QBF aIP;

     aFrom    = #dsarw010#1;   |QBF aFrom;
     aSalida  = #dsarw010#19;  |QBF aSalida;

     aTo      = aEmailDestino;
     |QBF aTo;

     |DBASE aBase;  |QBF aBase;
     |HAZ QuitaBarras;

     |SI nAjuste = 0;
         aAsunto  = "MD" + (aAuxExtension - ".") > "";
         eaAlfa   = "Documento dsEscan sin plantilla.";
         eaAlfa   = eaAlfa + " Tipo imagen: " + aAsunto;
         eaAlfa   = eaAlfa + " Cod: " + aIni + aAuxBarra + aNumeroDoc;
     |SINO;
         aAsunto  = aCodPlantilla + "MDAJUSTES" + (aAuxExtension - ".") > "";
         eaAlfa   = "Documento dsEscan para ajustar en DS.";
         eaAlfa   = eaAlfa + " Tipo imagen: " + aAsunto;
         eaAlfa   = eaAlfa + " Cod: " + aIni + aAuxBarra + aNumeroDoc;
     |FINSI;

     aMensaje = "";

     |DBASE aBase;
     |QBF aBase;
     aCuerpo = aBase + "documentos";  |MKDIR aCuerpo;
     aCuerpo = aBase + "documentos/correos";  |MKDIR aCuerpo;
     aCuerpo = aCuerpo + "/cuerpo" + aNumeroDoc + ".txt";
     |XABRE "WB", aCuerpo, nHandleC;
     |SI FSalida ] 0;
         aAlfa = eaAlfa + &13 + &10;
         |XGRABA nHandleC, aAlfa;

          |SI nAjuste = 1;
              aAlfa = "" + &13 + &10;
              |XGRABA nHandleC, aAlfa;

              |PARA nCampo = 3; |SI nCampo [ 22; |HACIENDO nCampo = nCampo + 1;
                    aAlfa = #dsarw079#nCampo#;
                    |QBF aAlfa;
                    aAlfa = aAlfa + &13 + &10;
                    |XGRABA nHandleC, aAlfa;
               |SIGUE;
          |FINSI;

          |XCIERRA nHandleC;

          aMensaje = "$$$$" + aCuerpo;
     |SINO;
          aMensaje = eaAlfa;
          |SI enSwModoSilencio = 1;
               eaErrorDsEscan = "Error al generar " + aCuerpo;
          |SINO;
               aTextoMe = "0000Error al generar " + aCuerpo;
               |MENAV aTextoMe;
          |FINSI;
     |FINSI;

     |SI #dsarw010#20 = "N";
          aAutenti = aFrom;
     |SINO;
          aAutenti = #dsarw010#22;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + #dsarw010#21;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + aFrom;
     |FINSI;

     |SI #dsarw010#23 = "S";
          aAutenti = "!" + aAutenti;
     |FINSI;

     |DSCORREO_ENVIA aIP, aSalida, aAutenti, aTo, aAsunto, aMensaje, aAdjunto;
     |SI FSalida < 0;
         enErrorCorreo = 1;
         |SI enMensaOCX = 0;
          |SI enSwModoSilencio = 0;
               |MENAV "0000 Ha habido un error durante el envio.";
          |FINSI;
         |FINSI;
     |FINSI;

     |FINVENTANA nVent1;
|FPRC;

|PROCESO QuitaNombre;
     aAuxExtension = "";
     |QBF aAlfa;
     aLong = aAlfa % A0;
     nLong = aLong;
     nPon  = 0;
     |PARA nVoy = nLong; |SI nVoy ] 1; |HACIENDO nVoy = nVoy - 1;
          nSaca  = (nVoy * 100) + 1;
          aLetra = aAlfa % nSaca;
          |SI aLetra = ".";
              |SAL;
          |FINSI;

          aAuxExtension = aAuxExtension + aLetra;
     |SIGUE;

     aLong = aAuxExtension % A0;
     nLong = aLong;
     aAlfa = "";
     |PARA nVoy = nLong; |SI nVoy ] 1; |HACIENDO nVoy = nVoy - 1;
          nSaca  = (nVoy * 100) + 1;
          aLetra = aAuxExtension % nSaca;

          aAlfa = aAlfa + aLetra;
     |SIGUE;

     aAuxExtension = "." + aAlfa > "";
|FPRC;

|PROCESO BorraDir;          ||Borra todos los archivos de aDirectorio
     direc = ""; |DIRECTORIO direc; |QBF direc;
     |SI aDirectorio ! "/";
          aAlfa1 = direc + "bin/agirm -r " + aDirectorio;
          |SYSTEM aAlfa1;
     |FINSI;
|FPRC;

|PROCESO Tgz;
     ||PREPARO EL DIRECTORIO DONDE HARE EL TGZ

     aNomTgz     = "tgz" + Usuario;                     |QBF aNomTgz
     |DBASE aBase;  |QBF aBase;
     aDestinoTgz = aBase + "correos";                   |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/" + aNomTgz;         |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/";

     aDirectorio = aDestinoTgz;
     |HAZ BorraDir;

     aNomTgz     = "tgz" + Usuario;                     |QBF aNomTgz
     |DBASE aBase;  |QBF aBase;
     aDestinoTgz = aBase + "correos";                   |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/" + aNomTgz;         |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/";

     |HAZ QuitaBarras;

     aNomFichero = aIni + aAuxBarra + aNumeroDoc;
     aDestino    = aDestinoTgz + aNomFichero + ".txt";
     aOrigen     = aRespuestaOCR;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
     |SI aIPRemoto ! "";
         |RECIBE_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     aAlfa = aFicheroTIF;  |HAZ QuitaNombre;

     ||COPIO EL DOCUMENTO PRINCIPAL.
     aOrigen  = aFicheroTIF;
     aDestino = aDestinoTgz + aNomFichero + aAuxExtension;  |QBF aDestino;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
     |SI aIPRemoto ! "";
         |RECIBE_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     ||Ahora el ATAR.

     aFicTar = aDestinoTgz + aNomFichero + ".tar" + " " + aNomFichero + ".txt";
     aFicTar = aFicTar + " " + aNomFichero + aAuxExtension;

     |ATAR aFicTar, aDestinoTgz;
     |SI FSalida = 0;
          aFicTar = aDestinoTgz + aNomFichero + ".tar";
          |COMPRIME aFicTar;
          |SI FSalida = 0;
               aBorra = aDestinoTgz + aNomFichero + ".tar";
               |FBORRA aBorra;
               aDestino = aDestinoTgz + aNomFichero + ".tgz";
               nSwTgzOk = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Correo;
     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     aEmailDestino = #dsarm001#169;
     |QBF aEmailDestino;

     aIPLocal = "";
     |IP_LOCAL aIPLocal;    |QBF aIPLocal;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;

     aQueSistema = "";
     |QUE_SISTEMA aQueSistema;  |QBF aQueSistema;

     nGuarda      = enAprobacion;
     enAprobacion = 0;
     eaPrograma   = "SMTPCLI";
     |HAZ DSARCHI_INI;
     nSwSMTPCLI   = enAprobacion;
     enAprobacion = nGuarda;

     nGuarda      = enAprobacion;
     enAprobacion = 0;
     eaPrograma   = "DSENVIACORREO";
     |HAZ DSARCHI_INI;
     nSwDsEnviaCorreo = enAprobacion;
     enAprobacion     = nGuarda;

     |SI nSwSMTPCLI = 1;
          aMensaje = "0000Envio por SMTPCLI no soportado";
          |SI enMensaOCX = 0;
              ||MENAV aMensaje;
          |FINSI;
     |FINSI;

     |HAZ Tgz;

     |SI nSwDsEnviaCorreo = 1;
          |HAZ DsEnviaCorreo;
     |SINO;
          |HAZ MandaCorreo;
     |FINSI;
|FPRC;

|PROCESO EnvioCorreo;
     nSwEnvioCorreo = 0;
     aIntegridadOK = "N";
     |SI nSwErrorOCR = 1;
         |SI enSwModoSilencio = 1;
             |SI nSwHayErrorSil = 0;
                 eaErrorDsEscan = "<dsEscan> No he podido abrir " + aRespuestaOCR;
                 nSwHayErrorSil = 1;
             |FINSI;
         |SINO;
             aMensaje = "0000<dsEscan> No he podido abrir " + aRespuestaOCR;
             |SI enMensaOCX = 0;
                 |MENAV aMensaje;
             |FINSI;
         |FINSI;
     |SINO;
         |SI nSwErrorOCRLog = 1;
             |SI aErrorOCR = " Error no existe plantilla asociada a la imagen";
                 nSwEnvioCorreo = 1;
                 |SI enSwModoSilencio = 1;
                     eaErrorDsEscan = "<dsEscan> No existe plantilla asociada a la imagen";
                 |FINSI;
             |SINO;
                 aMensaje = "0000<dsEscan> " + aErrorOCR;
                 |SI enSwModoSilencio = 1;
                     eaErrorDsEscan = "<dsEscan> " + aErrorOCR;
                 |SINO;
                     |SI enMensaOCX = 0;
                         |MENAV aMensaje;
                     |FINSI;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI nSwEnvioCorreo = 1;
         nAjuste = 0;
         |HAZ Correo;
         nSwEnvioCorreo = 0;
     |FINSI;
|FPRC;

|PROCESO RecogeCodigoDoc;
     |PULSATECLA;
     aContiene1 = aFichero;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aDocRemoto = FSalida;  |QBF aDocRemoto;

     |ABRE #dsarm101;
     |SELECT #2#dsarm101;
     #dsarm101#1 = aDocRemoto;
     |LEE 000#dsarm101.=;
     |SI FSalida ! 0;
         |SELECT #1#dsarm101;
         |LEE 000#dsarm101.u;
         |SI FSalida ! 0;  |DDEFECTO #dsarm101;  |FINSI;

         #dsarm101#0 = #dsarm101#0 + 1;
         #dsarm101#1 = aDocRemoto;
         |GRABA 020#dsarm101.n;
         |LIBERA #dsarm101;
     |FINSI;
     |CIERRA #dsarm101;

     aNumeroDoc     = ("000000000" + #dsarm101#0) % -109;
     aCodPlantilla  = ("000000000000" + #dsarm101#2) % -112;
|FPRC;

|PROCESO EnviaAjuste
     |VENTANA 0501, 3299, -1, 16, "Ajustar plantilla en DS";
     nSubVentz1 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PINPA #0#dsarw079;

     |DDEFECTO #dsarw079;

     |PINDA #0#dsarw079;

     |ENDATOS #1#dsarw079;
     |SI FSalida = 0;
         aFichero = eaRuta + "\" + #dsarw046#10;  |QBF aFichero;
         |HAZ RecogeCodigoDoc;

         eaFicRes        = #dsarw046#10 < "";   |QBF eaFicRes;
         aNomResOCR     = eaFicRes - ".pdf" + ".tif.txt";
         aRespuestaOCR  = aDirBaseResOCR + aNomResOCR;
         aFicheroTIF    = eaRuta + "\" + (eaFicRes - ".pdf" + ".tif");

         nAjuste = 1;
         |HAZ Correo;

         |SI enErrorCorreo = 0;
             |MENAV "0000Correo enviado.";
         |FINSI;
     |FINSI;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nSubVentz1;
|FPRC;

|PROCESO Reintentar;
     |VENTANA 0501, 3299, -1, 16, "Reintentado OCR";
     nSubVentz1 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |CONTROL_SIMPLE 0, "LABEL,{{9}} Leyendo modelo", 0610, 0798, NULL;

     nConta = #dsarw046#0;

     aFichero = eaRuta + "\" + #dsarw046#10;  |QBF aFichero;
     |HAZ RecogeCodigoDoc;

     eaFicRes        = #dsarw046#10 < "";   |QBF eaFicRes;
     aNomResOCR     = eaFicRes - ".pdf" + ".tif.txt";
     aRespuestaOCR  = aDirBaseResOCR + aNomResOCR;
     aFicheroTIF    = eaRuta + "\" + (eaFicRes - ".pdf" + ".tif");

     |ABRE #dsarm036;

     |HAZ ChequeaTIF;
     |HAZ LanzaDsEscan;
     |HAZ SacaDatosRespuesta;
     |HAZ GrabaResultadoOCR;
     |HAZ EnvioCorreo;

     |CIERRA #dsarm036;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nSubVentz1;

     |REFRESCACONTROL nGrid;
|FPRC;

|PROCESO ModoDSESCAN;
     |HAZ RecogeCodigoDoc;

     enAprobacion = 0;
     eaPrograma   = "PDF2TIFUNIX";
     |HAZ DSARCHI_INI;
     nSwPdf2TifUnix = enAprobacion;

     |QUE_SISTEMA aSistema;
     |SI aSistema = "ESDOS";
         aSistema = "ESDOS";
     |SINO;
         aSistema = "ESUNIX";
     |FINSI;

     |SI nSwPdf2TifUnix = 1; |Y aSistema = "ESUNIX";
         aBorraCache = aFichero;
         |QBF aBorraCache;
         |HAZ DePDFaTIFUnix;
     |SINO;
         |HAZ DePDFaTIF;
     |FINSI;

     |ABRE #dsarm036;

     nConta = nConta + 1;

     |HAZ ChequeaTIF;
     |HAZ LanzaDsEscan;
     |HAZ SacaDatosRespuesta;
     |HAZ GrabaResultadoOCR;
     |HAZ EnvioCorreo;

     |CIERRA #dsarm036;
|FPRC;

|PROCESO Evento946;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#dsarw046.=;

         |SI nId9 ! -1;
             |ESTADO_CONTROL nId9, "DISABLE";

             aAlfa = #dsarw046#6;  |QBF aAlfa;
             |SI aAlfa ! " Error no existe plantilla asociada a la imagen";
                 |ESTADO_CONTROL nId9, "ENABLE";
             |FINSI;
         |FINSI;
     |FINSI;

     |SI FSalida = 4;
         |LEE 101#dsarw046.=;
         |SI FSalida ! 0;  |ACABA;  |FINSI;
         |SI #dsarw046#4 = 0;  |O #dsarw046#1 = 0;  |O #dsarw046#2 = 0;  |O #dsarw046#3 = 0;
             |LIBERA #dsarw046;
             |ACABA;
         |FINSI;

         |SI #dsarw046#11 = " ";
             aAlfa = #dsarw046#12;  |QBF aAlfa;
             |SI aAlfa = eaVerde;
                 |CONFI "0000NEste documento ya existe en la gesti¢n documental, quiere registrarlo de nuevo";
                 |SI FSalida ! 0;
                     |ACABA;
                 |FINSI;
             |FINSI;

             #dsarw046#11 = "*";
         |SINO;
             #dsarw046#11 = " ";
         |FINSI;

         |HAZ PonColor;

         |GRABA 020#dsarw046.a;
         |LIBERA #dsarw046;

         |PINTA #dsarw046#11;

         FSalida = "SKIPDEFAULT";
         |REFRESCACONTROL nGrid;
     |FINSI;
|FPRC;

|PROCESO GrabaRenta;
     nConta     = nConta + 1;
     enIdeCli   = nEmpresa;
     |HAZ BuscaCliente;

     #dsarw046#0  = nConta;
     #dsarw046#1  = nEmpresa;
     #dsarw046#2  = eaEjercicio;
     #dsarw046#3  = eaPeriodo;
     #dsarw046#4  = enModelo;
     #dsarw046#5  = enCompl;
     #dsarw046#7  = eaElect;
     #dsarw046#8  = eaJusti;
     #dsarw046#9  = aDni;
     #dsarw046#10 = eaFicRes;
     #dsarw046#13 = eaFecPre;   || Solo 036 y 037

     |SI #dsarw046#4 = 0;
         #dsarw046#6  = "Formato de modelo no reconocido";
     |SINO;
         |SI #dsarw046#1 = 0;
             #dsarw046#6  = "Empresa sin identificar";
         |FINSI;
     |FINSI;

     |HAZ PonColor;

     |GRABA 020#dsarw046.n;
     |LIBERA #dsarw046;
|FPRC;

|PROCESO Graba946_100;
     |ABRE #dsam0003;
     aDni = eaDni;   |HAZ LeeClienteRenta;  nEmpTit = nEmpresa;
     aDni = eaDni2;  |HAZ LeeClienteRenta;  nEmpCon = nEmpresa;
     |CIERRA #dsam0003;

     |SI eaTributa = "I";
         aDni     = eaDni;
         nEmpresa = nEmpTit;
         |SI nEmpresa = 0;
             |SI nEmpCon ! 0;
                 aDni     = eaDni2;
                 nEmpresa = nEmpCon;
             |FINSI;
         |FINSI;
         |HAZ GrabaRenta;
     |FINSI;

     |SI eaTributa = "C";
         |SI nEmpTit ! 0;
             aDni     = eaDni;
             nEmpresa = nEmpTit;
             |HAZ GrabaRenta;
         |FINSI;

         |SI nEmpCon ! 0;  |Y nEmpCon ! nEmpTit;
             aDni     = eaDni2;
             nEmpresa = nEmpCon;
             |HAZ GrabaRenta;
         |FINSI;

         |SI nEmpTit = 0;  |Y nEmpCon = 0;
             aDni     = eaDni;
             nEmpresa = 0
             |HAZ GrabaRenta;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO Graba946;
     |DDEFECTO #dsarw046;

     aAlfa    = eaJusti;   |QBT aAlfa;
     aLong    = aAlfa % 0;
     nLong    = aLong;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos   = (nCarac * 100) + 1;
           aCarac =  aAlfa % nPos;
           |SI aCarac ! "0";  |Y aCarac ! "1";  |Y aCarac ! "2"; |Y aCarac ! "3";
            |Y aCarac ! "4";  |Y aCarac ! "5";  |Y aCarac ! "6"; |Y aCarac ! "7";
            |Y aCarac ! "8";  |Y aCarac ! "9";
               eaJusti = "";
               |SAL;
           |FINSI;
     |SIGUE;

     |QBT eaJusti;
     |QBT eaElect;

     aAlfa = eaElect % 0;
     |SI aAlfa ! "16";  eaElect = "";  |FINSI;

     aAlfa = eaJusti % 0;
     |SI aAlfa ! "13";  eaJusti = "";  |FINSI;

     |SI enModelo = 100;  |Y eaTributa ! "";
         |HAZ Graba946_100;
         |ACABA;
     |FINSI;

     nConta     = nConta + 1;
     #dsarw046#0  = nConta;
     #dsarw046#1  = 0;
     #dsarw046#2  = eaEjercicio;
     #dsarw046#3  = eaPeriodo;
     #dsarw046#4  = enModelo;
     #dsarw046#5  = enCompl;
     #dsarw046#7  = eaElect;
     #dsarw046#8  = eaJusti;
     #dsarw046#9  = eaDni;
     #dsarw046#10 = eaFicRes;
     #dsarw046#13 = eaFecPre;  || Solo 036 y 037

     |ABRE #dsam0003;
     |HAZ LeeCliDNIz1;
     |CIERRA #dsam0003;

     |SI #dsarw046#4 = 0;
         #dsarw046#6  = "Formato de modelo no reconocido";
     |SINO;
         |SI #dsarw046#1 = 0;
             #dsarw046#6  = "Empresa sin identificar";
         |FINSI;
     |FINSI;

     |SI nEsta = 1;
         #dsarw046#12 = eaVerde;
     |FINSI;

     |HAZ PonColor;

     |GRABA 020#dsarw046.n;
     |LIBERA #dsarw046;
|FPRC;

|PROCESO CargaPeriodoCalc;
     aBusco = aCadena - "1T";  |SI FSalida ! 0;  eaPeriodo = "03";  |ACABA;  |FINSI;
     aBusco = aCadena - "2T";  |SI FSalida ! 0;  eaPeriodo = "06";  |ACABA;  |FINSI;
     aBusco = aCadena - "3T";  |SI FSalida ! 0;  eaPeriodo = "09";  |ACABA;  |FINSI;
     aBusco = aCadena - "4T";  |SI FSalida ! 0;  eaPeriodo = "12";  |ACABA;  |FINSI;
     aBusco = aCadena - "01";  |SI FSalida ! 0;  eaPeriodo = "01";  |ACABA;  |FINSI;
     aBusco = aCadena - "02";  |SI FSalida ! 0;  eaPeriodo = "02";  |ACABA;  |FINSI;
     aBusco = aCadena - "03";  |SI FSalida ! 0;  eaPeriodo = "03";  |ACABA;  |FINSI;
     aBusco = aCadena - "04";  |SI FSalida ! 0;  eaPeriodo = "04";  |ACABA;  |FINSI;
     aBusco = aCadena - "05";  |SI FSalida ! 0;  eaPeriodo = "05";  |ACABA;  |FINSI;
     aBusco = aCadena - "06";  |SI FSalida ! 0;  eaPeriodo = "06";  |ACABA;  |FINSI;
     aBusco = aCadena - "07";  |SI FSalida ! 0;  eaPeriodo = "07";  |ACABA;  |FINSI;
     aBusco = aCadena - "08";  |SI FSalida ! 0;  eaPeriodo = "08";  |ACABA;  |FINSI;
     aBusco = aCadena - "09";  |SI FSalida ! 0;  eaPeriodo = "09";  |ACABA;  |FINSI;
     aBusco = aCadena - "10";  |SI FSalida ! 0;  eaPeriodo = "10";  |ACABA;  |FINSI;
     aBusco = aCadena - "11";  |SI FSalida ! 0;  eaPeriodo = "11";  |ACABA;  |FINSI;
     aBusco = aCadena - "12";  |SI FSalida ! 0;  eaPeriodo = "12";  |ACABA;  |FINSI;
|FPRC;

|PROCESO CargaEjercicio;
     |PARA nAnyo = 2007;  |SI nAnyo [ 2100;  |HACIENDO nAnyo = nAnyo + 1;
           aBusco = aCadena - nAnyo;
           |SI FSalida ! 0;
              eaEjercicio = nAnyo;  |SAL;
           |FINSI;
     |SIGUE;
|FPRC;

|PROCESO BuscaJustificante;
     aAlfa    = aCadena;   |QBT aAlfa;
     aLong    = aAlfa % 0;
     nLong    = aLong;
     aNumeros = "";
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos   = (nCarac * 100) + 1;
           aCarac =  aAlfa % nPos;
           |SI aCarac ! "0";  |Y aCarac ! "1";  |Y aCarac ! "2"; |Y aCarac ! "3";
            |Y aCarac ! "4";  |Y aCarac ! "5";  |Y aCarac ! "6"; |Y aCarac ! "7";
            |Y aCarac ! "8";  |Y aCarac ! "9";
               aLong    = aNumeros % 0;
               |SI aLong = 13;  |SAL;  |FINSI;

               aNumeros = "";
           |SINO;
               aNumeros = aNumeros + aCarac;
           |FINSI;
     |SIGUE;

     |SI aNumeros ! "";
         eaJusti = aNumeros;
         nJusti = 0;
     |FINSI;
|FPRC;

|PROCESO BuscaCadena;
     aCadena = aCadena > "";

     |SI nJusti = 1;
         |HAZ BuscaJustificante;
     |FINSI;

     |SI eaJusti = "";
         aBusco = aCadena - "JUSTIFICANTE";
         |SI FSalida ! 0;
             nJusti = 1;
             |HAZ BuscaJustificante;
         |FINSI;
     |FINSI;

     |SI eaEjercicio = "";
         aBusco = aCadena - "EJERCICIO";
         |SI FSalida ! 0;
             |HAZ CargaEjercicio;
         |FINSI;
     |FINSI;

     |SI eaPeriodo ! "";  |ACABA;  |FINSI;

     aBusco = aCadena - "PERÌODO";
     |SI FSalida ! 0;
         |HAZ CargaPeriodoCalc;
         |SI eaPeriodo ! "";  |ACABA;  |FINSI;
     |FINSI;

     aBusco = aCadena - "PERÕODO";
     |SI FSalida ! 0;
         |HAZ CargaPeriodoCalc;
         |SI eaPeriodo ! "";  |ACABA;  |FINSI;
     |FINSI;

     aBusco = aCadena - "PERIODO";
     |SI FSalida ! 0;
         |HAZ CargaPeriodoCalc;
         |SI eaPeriodo ! "";  |ACABA;  |FINSI;
     |FINSI;
|FPRC;


|PROCESO LeeFicheroHTML;
     aAlfa = eaFicRes % 101;
     |SI aAlfa ! "A";  |ACABA;  |FINSI;

     aAlfa   = eaFicRes % 1303;
     enModelo = aAlfa;
     |SI enModelo = 111;  enModelo = 110;  |FINSI;

     |DBASE aPathBase;
     |QBF aPathBase;

     eaDestino = aFichero;
     eaOrigen  = aPathBase + "tmp";         |MKDIR eaOrigen;
     eaOrigen  = eaOrigen + "/" + Usuario;  |MKDIR eaOrigen;
     eaOrigen  = eaOrigen + "/tempo.html";
     |HAZ RecibeEnServidorMD5;

     aAbre = eaOrigen;

     |XABRE "BU", aAbre, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     |SI nLabel2 ! -1;
         |FIN_CONTROL_WINDOWS nLabel2;
     |FINSI;

     aAlfa = "LABEL,{{0}} " + eaFicRes;
     |CONTROL_SIMPLE 0, aAlfa,  1020, 1098, NULL;
     nLabel2 = FSalida;

     aCR               = &10;
     aLF               = &13;
     aCadena           = "";
     eaEjercicio        = "";
     eaPeriodo          = "";
     eaJusti            = "";

     |XLEE nHandle, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            |SI aAlfa = aCR;
                |HAZ BuscaCadena;
                aCadena = "";
                |SI eaEjercicio ! "";  |Y eaPeriodo ! "";  |Y eaJusti ! "";
                     |SAL;
                |FINSI;
            |SINO;
                |SI aAlfa ! aLF;
                    aCadena = aCadena + aAlfa;
                |FINSI;
            |FINSI;
            |XLEE nHandle, 1, aAlfa;
     |SIGUE;
     |XCIERRA nHandle;

     |SI eaPeriodo = "";  eaPeriodo = "99";  |FINSI;

     aAlfa        = eaFicRes > "";
     aAlfa        = aAlfa - ".HTML";

     eaDni        = aAlfa % 309;
     eaElect      = aAlfa % -116;
     eaFecPre     = "";

     |HAZ Graba946;

     aAlfa = aPathBase + "tmp/" + Usuario + "/tempo.html"; |FBORRA aAlfa;
|FPRC;

|PROCESO ConvierteTxt;
     aEjecuta = aDirBaseLocal + "pdftotext/pdftotext.exe -f 1 -l 3 -layout " + aFichero + " " + aAbre + ".txt";
     |RSYSTEM aEjecuta;
|FPRC;

|PROCESO Graba047;
     nConta047      = nConta047 + 1;
     #dsarw047#0    = nConta047;
     #dsarw047#1    = aCadena;
     |GRABA 020#dsarw047.n;
     |LIBERA #dsarw047;
|FPRC;

|PROCESO ModoPDFTOTEXT;
     aAbre  = aAlfa - ".pdf";
     |HAZ ConvierteTxt;

     aAlfa  = aFichero < " ";
     aAbre  = aAlfa - ".pdf" + ".txt";

     |DBASE aPathBase;
     |QBF aPathBase;

     eaDestino = aAbre;
     eaOrigen  = aPathBase + "tmp";         |MKDIR eaOrigen;
     eaOrigen  = eaOrigen + "/" + Usuario;  |MKDIR eaOrigen;
     eaOrigen  = eaOrigen + "/tempo.txt";
     |HAZ RecibeEnServidorMD5;

     aAbre = eaOrigen;
     |XABRE "BU", aAbre, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aDat = ("47" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #dsarw047#aDat#;

     |ABRE #dsarw047;  |CIERRA #dsarw047;  |DELINDEX  #dsarw047;

     eaJusti            = "";
     eaElect            = "";
     aCR                = &10;
     aLF                = &13;
     aCadena            = "";
     eaEjercicio        = "";
     eaPeriodo          = "";
     eaFecPre           = "";
     eaDni              = "";
     eaDni2             = "";
     eaTributa          = "";
     enModelo           = 0;
     enCompl            = 0;
     nConta047          = 0;

     |ABRE #dsarw047;
     |XLEE nHandle, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            |SI aAlfa = aCR;
                |HAZ Graba047;
                aCadena = "";
            |SINO;
                |SI aAlfa ! aLF;
                    |SI aAlfa ! " ";
                        aCadena = aCadena + aAlfa;
                    |FINSI;
                |FINSI;
            |FINSI;
            |XLEE nHandle, 1, aAlfa;
     |SIGUE;
     |XCIERRA nHandle;

     ||      |CONSULTA_CLAVE #dsarm001#dsarw047;  ||aqui

     |HAZ ChequeaTxt;

     |CIERRA #dsarw047;

     |SI eaPeriodo = "";  eaPeriodo = "99";  |FINSI;

     |HAZ Graba946;

     |DELINDEX  #dsarw047;

     aAlfa = aPathBase + "tmp/" + Usuario + "/tempo.txt"; |FBORRA aAlfa;
|FPRC;

|PROCESO LeeFicheroPDF;
     aAbre = aFichero;

     |SI nLabel2 ! -1;
         |FIN_CONTROL_WINDOWS nLabel2;
     |FINSI;

     aAlfa = "LABEL,{{0}} " + eaFicRes;
     |CONTROL_SIMPLE 0, aAlfa,  1020, 1098, NULL;
     nLabel2 = FSalida;

     aAlfa  = aFichero < " ";
     aAbre  = aAlfa - ".pdf" + ".txt";
     |XABRE "EC", aAbre, nHandle;
     |SI FSalida ] 0;
         |RFBORRA aAbre;
     |FINSI;

     |SI #dsarm004#81 = "N";
         |HAZ ModoPDFTOTEXT;
     |FINSI;

     |SI #dsarm004#81 = "S";
         |HAZ ModoDSESCAN;
     |FINSI;
|FPRC;

|PROCESO EstaIntegral;
     enSwEstaIntegral = 0;
     |DBASS aBase;
     aMas = aBase + "/integral/def/dsam0000.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida ] 0;
         enSwEstaIntegral = 1;
     |FINSI;
|FPRC;

|PROCESO EstaBasica;
     enSwEstaBasica = 0;

     |DBASS aBase;
     aMas = aBase + "/basica/def/agifigen.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida ] 0;
         enSwEstaBasica = 1;
     |FINSI;
|FPRC;

|PROCESO dsarw046M;
     |SI aMarca = "*";
         |SI #dsarw046#4 = 0;  |O #dsarw046#1 = 0;  |O #dsarw046#2 = 0;  |O #dsarw046#3 = 0;
             |ACABA;
         |FINSI;
     |FINSI;

     #dsarw046#11 = aMarca;

     |HAZ PonColor;

     |GRABA 020#dsarw046.a;
     |LIBERA #dsarw046;
|FPRC;

|DEFBUCLE dsarw046M;
     #dsarw046#3;
     ;
     nDModelo,       1;
     nHModelo, 9999999;
     be;
     NULL, dsarw046M;
|FIN;

|PROCESO Todo;
     aMarca   = "*";
     nDModelo = 001;
     nHModelo = 999;
     |BUCLE dsarw046M;

     |SELECT #1#dsarw046;
     |REFRESCACONTROL nGrid;
|FPRC;

|PROCESO Ninguno;
     aMarca   = " ";
     nDModelo = 001;
     nHModelo = 999;
     |BUCLE dsarw046M;

     |SELECT #1#dsarw046;
     |REFRESCACONTROL nGrid;
|FPRC;

|PROCESO PorModelo;
     |VENTANA 1240, 1470, -1, 16, "Introduzca el Modelo";
     nSubVentz1 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     E_inf   = 001;
     E_sup   = 999;
     enModelo = 1350 ? -1;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nSubVentz1;

     |SI enModelo = 0;  |ACABA;  |FINSI;

     aMarca   = " ";
     nDModelo = 001;
     nHModelo = 999;
     |BUCLE dsarw046M;

     aMarca   = "*";
     nDModelo = enModelo;
     nHModelo = enModelo;
     |BUCLE dsarw046M;

     |SELECT #1#dsarw046;
     |REFRESCACONTROL nGrid;
|FPRC;

|PROCESO CambiarValores;
     |LEE 101#dsarw046.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |VENTANA 0501, 1775, -1, 16, "Cambiar valores";
     nSubVentz1 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     #dsarw048#0 = #dsarw046#4;
     #dsarw048#1 = #dsarw046#9;
     #dsarw048#2 = #dsarw046#1;
     #dsarw048#3 = #dsarw046#6;
     #dsarw048#4 = #dsarw046#2;
     #dsarw048#5 = #dsarw046#3;
     #dsarw048#6 = #dsarw046#5;
     #dsarw048#7 = #dsarw046#7;
     #dsarw048#8 = #dsarw046#8;

     |PINPA #0#dsarw048;
     |PINDA #0#dsarw048;
     |ENDATOS #1#dsarw048;
     |SI FSalida = 0;
         #dsarw046#4 = #dsarw048#0;
         #dsarw046#9 = #dsarw048#1;
         #dsarw046#1 = #dsarw048#2;
         #dsarw046#6 = #dsarw048#3;
         #dsarw046#2 = #dsarw048#4;
         #dsarw046#3 = #dsarw048#5;
         #dsarw046#5 = #dsarw048#6;
         #dsarw046#7 = #dsarw048#7;
         #dsarw046#8 = #dsarw048#8;

         |HAZ PonColor;

         |GRABA 020#dsarw046.a;
     |FINSI;

     |LIBERA #dsarw046;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nSubVentz1;

     |REFRESCACONTROL nGrid;
     |FOCOTECLADO nGrid;
|FPRC;

|PROCESO EnvioDS;
     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     aPath  = eaRuta + "/";
     aAlfa  = aPath + #dsarw046#10;  |QBF eaOrigen;
     |XABRE  "EC", aAlfa, 0;
     |SI FSalida < 0;
         |MENAV "0000No existe documento.";
         |ACABA;
     |FINSI;

     fFechaSis   = ~;
     |HORA aHora;
     aNomFic  = (fFechaSis % -104) + (fFechaSis % 402) + (fFechaSis % 102);
     aNomFic  = aNomFic + (aHora % 102) + (aHora % 402) + (aHora % 702);

     aFicTar  = aNomFic + ".tar";
     aFicTgz  = aNomFic + ".tgz";

     aAlfa = aPath + aFicTar + " " + #dsarw046#10;  |QBF aAlfa;
     |RATAR aAlfa, aPath;

     aAlfa = aPath + aFicTar;
     |RCOMPRIME aAlfa;

     aAlfa = aPath + aFicTar;
     |RFBORRA aAlfa;

     |PULSATECLA;

     |DBASE aBase;  |QBF aBase;
     |HAZ QuitaBarras;

     aPathSer = aBase + "documentos";                     |MKDIR aPathSer;
     aPathSer = aBase + "documentos/correos";             |MKDIR aPathSer;
     aPathSer = aBase + "documentos/correos/" + Usuario;  |MKDIR aPathSer;
     aPathSer = aBase + "documentos/correos/" + Usuario + "/";

     aOrigen  = aPath + aFicTgz;
     aDestino = aPathSer + aFicTgz;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
     |SI aIPRemoto ! "";
         |RECIBE_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |RFBORRA aOrigen;

     |XABRE  "E", aDestino, 0;
     |SI FSalida < 0;
         |MENAV "0000Problemas en generar fichero para el envio.";
         |ACABA;
     |FINSI;

     |VENTANA 0501, 2799, -1, 1, "";
     nVent1 = FSalida;

     |PINPA #0#dsarw013;
     |PINDA #0#dsarw013;
     |PTEC 802;
     |PAUSA;

     aIni = "";
     |HAZ AveriguaINI;

     |IP_REMOTO aIPRemoto;
     |QBF aIPRemoto;

     aAdjunto = aDestino;

     |SI aQueSistema = "ESDOS";
         |HAZ CorreoEnDos;
         |SI aIPRemoto ! "";
             |HAZ CorreoEnUnix;
         |FINSI;
     |SINO;
          |HAZ CorreoEnUnix;
     |FINSI;

     aIP = "";
     aIP = #dsarw010#18;  |QBF aIP;

     aFrom    = #dsarw010#1;   |QBF aFrom;
     aSalida  = #dsarw010#19;  |QBF aSalida;

||     aTo      = "manolo@diagram.es";
     aTo      = "carlos.clemente@diagram.es";
     aAsunto  = "Documento no reconocido. Revisar";

     aMensaje = "";

     aAbre = aPathSer + aNomFic + ".txt";
     |XABRE "WB", aAbre, nHandleC;
     |SI FSalida ] 0;
         aAlfa = "Codigo INI: " + aIni + aAuxBarra + &13 + &10;
         |XGRABA nHandleC, aAlfa;

         aAlfa = "Usuario: " + (Usuario % 810) + &13 + &10;
         |XGRABA nHandleC, aAlfa;

         aAlfa = "Documento: " + #dsarw046#10 + &13 + &10;
         |XGRABA nHandleC, aAlfa;

         aAlfa = "Fecha: " + fFechaSis + &13 + &10;
         |XGRABA nHandleC, aAlfa;

         aAlfa = "Hora: " + aHora + &13 + &10;
         |XGRABA nHandleC, aAlfa;

         |XCIERRA nHandleC;

          aMensaje = "$$$$" + aAbre;
     |FINSI;

     |SI #dsarw010#20 = "N";
          aAutenti = aFrom;
     |SINO;
          aAutenti = #dsarw010#22;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + #dsarw010#21;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + aFrom;
     |FINSI;

     |SI #dsarw010#23 = "S";
          aAutenti = "!" + aAutenti;
     |FINSI;

     |DSCORREO_ENVIA aIP, aSalida, aAutenti, aTo, aAsunto, aMensaje, aAdjunto;
     nFSalida = FSalida;

     |FINVENTANA nVent1;

     |SI nFSalida < 0;
         |MENAV "0000 Ha habido un error durante el envio. Vuelva a intentarlo mas tarde";
     |SINO;
         aAlfa = "0000El documento " + #dsarw046#10;   |QBF aAlfa;
         aAlfa = aAlfa + " se ha enviado correctamente. Se atender†  lo antes posible. Muchas gracias.";
         |MENAV aAlfa;

         #dsarw046#14 = "S";
         |GRABA 000#dsarw046.a;
     |FINSI;

     aAlfa = aPathSer + aNomFic + ".txt";  |FBORRA aAlfa;
     aAlfa = aPathSer + aNomFic + ".tgz";  |FBORRA aAlfa;
|FPRC;

|PROCESO NoReconocidos;
     nOk = 1;

     |SI #dsarw046#1  = 0;    nOk = 0;  |FINSI;
     |SI #dsarw046#2  = 0;    nOk = 0;  |FINSI;
     |SI #dsarw046#3  = 0;    nOk = 0;  |FINSI;
     |SI #dsarw046#4  = 0;    nOk = 0;  |FINSI;
     |SI #dsarw046#14 = "S";  nOk = 1;  |FINSI;

     |SI nOk = 1;
         |HAZ GestionaNoReconocidos;
         |REFRESCACONTROL nGrid;
         |FOCOTECLADO nGrid;

         |ACABA;
     |FINSI;

     aPopup1 = "-1";  || Si fuera -1 en la posicion
     aPopup2 = "2";
     aPopup3  = "Ir al asistente";
     aPopup4  = "Reportar documento a DS para su revision";

     IaPopup  = aPopup1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;

     |SI FSalida = 1;
         |HAZ GestionaNoReconocidos;
         |REFRESCACONTROL nGrid;
         |FOCOTECLADO nGrid;
     |FINSI;

     |SI FSalida = 2;
         |HAZ EnvioDS;
         |REFRESCACONTROL nGrid;
         |FOCOTECLADO nGrid;
     |FINSI;
|FPRC;

|PROCESO Recomendaciones;
     |VENTANA 0501, 1970, -1, 16, "Recomendaciones";
     nSubVentz1 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     aAlfa = "LABEL,{{0}}1.- Guardar siempre los modelos en carpetas por MODELO - EJERCICIO - PERIODO"
     |CONTROL_SIMPLE 0, aAlfa, 0602, 0670, NULL;

     aAlfa = "LABEL,{{0}}    para una mayor agilizaci¢n del proceso.";
     |CONTROL_SIMPLE 0, aAlfa, 0702, 0770, NULL;

     aAlfa = "LABEL,{{0}}2.- Crear los PDF con la impresora DSPDF para conseguir una impresi¢n estandar";
     |CONTROL_SIMPLE 0, aAlfa, 0902, 0970, NULL;

     aAlfa = "LABEL,{{0}}    y poder leer los datos del PDF como la configuraci¢n de fabricaci¢n, si";
     |CONTROL_SIMPLE 0, aAlfa, 1002, 1070, NULL;

     aAlfa = "LABEL,{{0}}    no tienen instalada la impresora se la podr† instalar desde el men£ de";
     |CONTROL_SIMPLE 0, aAlfa, 1102, 1170, NULL;

     aAlfa = "LABEL,{{0}}    utilidades de esta misma aplicaci¢n.";
     |CONTROL_SIMPLE 0, aAlfa, 1202, 1270, NULL;

     |SI #dsarm004#81 = "N";
         aAlfa = "LABEL,{{0}}3.- Contacte con nuestro departamento de soporte para incluir formatos de ";
         |CONTROL_SIMPLE 0, aAlfa, 1402, 1470, NULL;

         aAlfa = "LABEL,{{0}}    modelos no reconocidos. En cualquier caso podr† rellenar los datos a ";
         |CONTROL_SIMPLE 0, aAlfa, 1502, 1570, NULL;

         aAlfa = "LABEL,{{0}}    travÇs del bot¢n " + &34 + "Cambiar Valores" + &34 + ".";
         |CONTROL_SIMPLE 0, aAlfa, 1602, 1670, NULL;
     |FINSI;

     |SI #dsarm004#81 = "S";
         aAlfa = "LABEL,{{0}}3.- Todos los modelos no reconocidos se env°an autom†ticamente a DS para  ";
         |CONTROL_SIMPLE 0, aAlfa, 1402, 1470, NULL;

         aAlfa = "LABEL,{{0}}    que en un breve per°odo de tiempo el modelo pueda ser reconocido en una";
         |CONTROL_SIMPLE 0, aAlfa, 1502, 1570, NULL;

         aAlfa = "LABEL,{{0}}     pr¢xima captura.  En cualquier caso podr† rellenae los datos a travÇs";
         |CONTROL_SIMPLE 0, aAlfa, 1602, 1670, NULL;

         aAlfa = "LABEL,{{0}}     del bot¢n " + &34 + "Cambiar Valores" + &34 + ".";
         |CONTROL_SIMPLE 0, aAlfa, 1702, 1770, NULL;
     |FINSI;

     |PAUSA;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nSubVentz1;
|FPRC;

|PROCESO Colores;
     |VENTANA 0501, 1270, -1, 16, "Ayuda colores registros";
     nSubVentz1 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     aAlfa = "LABEL,{{15}}Rojo.-   Documentos con datos no reconocidos"
     |CONTROL_SIMPLE 0, aAlfa, 0602, 0670, NULL;

     aAlfa = "LABEL,{{15}}Verde.- Documentos ya existentes en la gesti¢n documental";
     |CONTROL_SIMPLE 0, aAlfa, 0702, 0770, NULL;

     aAlfa = "LABEL,{{15}}Negro.- Documentos preparados para seleccionar"
     |CONTROL_SIMPLE 0, aAlfa, 0802, 0870, NULL;

     aAlfa = "LABEL,{{15}}Azul.-   Documentos seleccionados para archivar"
     |CONTROL_SIMPLE 0, aAlfa, 0902, 0970, NULL;

     |PAUSA;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nSubVentz1;
|FPRC;

|PROCESO LinealSimple;
     nRango = 4 + 8 + 16 + 32;
     |LINEAL_SIMPLE #1#dsarw046, nRango, 0601, 2599, NULL, NULL, Evento946;
     nGrid = FSalida;

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::{{230}}Continuar," + nGrid;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
         |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;
|FPRC;

|PROCESO SacaUbicacion;
     aPath = #dsarm001#1;  |QBF aPath;

     |ABRE #dsarm002;
     |DDEFECTO #dsarm002;
     #dsarm002#0 = enGrupo;
     |LEE 000#dsarm002.=;
     |CIERRA #dsarm002;

     aPath = aPath + "/" + #dsarm002#2;  |QBF aPath;
     |SI #dsarm001#7 = "N";
         |MKDIR aPath;
     |SINO;
         |RMKDIR aPath;
     |FINSI;

     |SI #dsarm001#8 = "N";
         aPath = aPath + "/";
         aUbicacion = aPath;

         |ABRE #dsarm004;
         |DDEFECTO #dsarm004;
         #dsarm004#0 = enGrupo;
         #dsarm004#1 = 1;
         #dsarm004#2 = 1;
         |LEE 000#dsarm004.=;
         |CIERRA #dsarm004;

         |SI #dsarm004#75 = "S";
              fFechaSis = ~;
              aFechaSis = fFechaSis;
              aAAAAMM = (aFechaSis % -104) + (aFechaSis % 402);
              aUbicacion = aUbicacion + aAAAAMM + "/";
              |SI #dsarm001#7 = "N";
                   |MKDIR aUbicacion;
              |SINO;
                   |RMKDIR aUbicacion;
              |FINSI;
         |FINSI;

         |ACABA;
     |FINSI;

     |ABRE #dsarm003;
     |DDEFECTO #dsarm003;
     #dsarm003#0 = enGrupo;
     #dsarm003#1 = enSubGrupo;
     |LEE 000#dsarm003.=;
     |CIERRA #dsarm003;

     aPath = aPath + "/" + #dsarm003#3;  |QBF aPath;
     |SI #dsarm001#7 = "N";
         |MKDIR aPath;
     |SINO;
         |RMKDIR aPath;
     |FINSI;

     |ABRE #dsarm004;
     |DDEFECTO #dsarm004;
     #dsarm004#0 = enGrupo;
     #dsarm004#1 = enSubGrupo;
     #dsarm004#2 = enTipo;
     |LEE 000#dsarm004.=;
     |CIERRA #dsarm004;

     aPath = aPath + "/" + #dsarm004#4;  |QBF aPath;
     |SI #dsarm001#7 = "N";
         |MKDIR aPath;
     |SINO;
         |RMKDIR aPath;
     |FINSI;

     aPath = aPath + "/";
     aUbicacion = aPath;

     |SI #dsarm004#75 = "S";
          fFechaSis = ~;
          aFechaSis = fFechaSis;
          aAAAAMM = (aFechaSis % -104) + (aFechaSis % 402);
          aUbicacion = aUbicacion + aAAAAMM + "/";
          |SI #dsarm001#7 = "N";
               |MKDIR aUbicacion;
          |SINO;
               |RMKDIR aUbicacion;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Graba200;
     |ABRE #isacceso;
     #isacceso#0  = #dsarm005#8;
     #isacceso#1  = #dsarm005#17;
     |LEE 101#isacceso.=;
     |SI FSalida = 0;
         #isacceso#7 = #dsarw046#7;
         |GRABA 020#isacceso.a;
         |LIBERA #isacceso;
     |FINSI;
     |CIERRA #isacceso;
|FPRC;

|PROCESO Graba202;
     |SI #dsarm005#17 < 2010;  |ACABA;  |FINSI;

     |SI #dsarm005#18 = 1;  aAlfa = "1P";  |FINSI;
     |SI #dsarm005#18 = 2;  aAlfa = "2P";  |FINSI;
     |SI #dsarm005#18 = 3;  aAlfa = "3P";  |FINSI;

     |ABRE #isom9000;
     #isom9000#0  = #dsarm005#8;
     #isom9000#1  = #dsarm005#17;
     #isom9000#2  = aAlfa;
     #isom9000#3  = #dsarm005#20;
     |LEE 101#isom9000.=;
     |SI FSalida = 0;
         #isom9000#9 = #dsarw046#7;
         |GRABA 020#isom9000.a;
         |LIBERA #isom9000;
     |FINSI;
     |CIERRA #isom9000;
|FPRC;

|PROCESO dsmod309;
     #dsmod309#16 = "X";
     #dsmod309#17 = ~;
     #dsmod309#73 = #dsarw046#7;
     |GRABA 020#dsmod309.a;
     |LIBERA #dsmod309;
|FPRC;

|DEFBUCLE dsmod309;
     #dsmod309#1;
     ;
     #dsarm005#8, 01, #dsarm005#17, #dsarm005#18, #dsarm005#20, 01;
     #dsarm005#8, 99, #dsarm005#17, #dsarm005#18, #dsarm005#20, 99;
     be;
     NULL, dsmod309;
|FIN;

|PROCESO Graba309;
     |BUCLE dsmod309;
|FPRC;

|PROCESO agicen20;
     #agicen20#6 = #dsarw046#8;
     |GRABA 020#agicen20.a;
     |LIBERA #agicen20;
|FPRC;

|DEFBUCLE agicen20;
     #agicen20#1;
     7;
     #dsarm005#8, 01, #dsarw046#13;
     #dsarm005#8, 99, #dsarw046#13;
     be;
     NULL, agicen20;
|FIN;

|PROCESO Graba036;
     |SI enSwEstaBasica = 0;
         |ACABA;
     |FINSI;

     |DBASS aBase;
     aFic = aBase + "/basica/fich/";
     |PATH_DAT #agicen20#aFic#;

     |BUCLE agicen20;
|FPRC;

|PROCESO GrabaPlaning;
     |ABRE #dsmom004;
     #dsmom004#0  = #dsarm005#8;
     #dsmom004#1  = #dsarm005#17;
     #dsmom004#2  = #dsarm005#18;
     #dsmom004#3  = #dsarm005#19;
     #dsmom004#4  = #dsarm005#20;
     |LEE 101#dsmom004.=;
     |SI FSalida = 0;
         #dsmom004#13 = "X";
         #dsmom004#14 = ~;
         #dsmom004#19 = #dsarw046#7;
         #dsmom004#25 = #dsarw046#8;
         |GRABA 020#dsmom004.a;
         |LIBERA #dsmom004;
     |FINSI;
     |CIERRA #dsmom004;
|FPRC;

|PROCESO dsarw046G;
     nDocu      = 1;
     |ABRE #dsarm005;
     |LEE 000#dsarm005.u;
     |SI FSalida = 0;
          nDocu = #dsarm005#0 + 1;
     |FINSI;

     |ABRE #dsarm100;
     |DDEFECTO #dsarm100;
     |LEE 000#dsarm100.p;
     |SI FSalida = 0;
          nUltimoDoc = #dsarm100#1 + 1;
     |SINO;
          nUltimoDoc = 1;
     |FINSI;
     |SI nUltimoDoc > nDocu;
          nDocu = nUltimoDoc;
     |FINSI;
     #dsarm100#0 = "1";
     |LEE 101#dsarm100.=;
     |SI FSalida ! 0; |GRABA 020#dsarm100.b; |FINSI;
     #dsarm100#1 = nDocu;
     |GRABA 020#dsarm100.a;
     |LIBERA #dsarm100;
     |CIERRA #dsarm100;

     |DDEFECTO #dsarm005;
     #dsarm005#0   = nDocu;
     |GRABA 020#dsarm005.b;

     aAlfa  = #dsarw046#10;  |QBF aAlfa;
     aAlfa  = (aAlfa % -104) > "";
     aAlfa1 = aAlfa % 101;
     |SI aAlfa1 ! ".";
         aAlfa  = #dsarw046#10;  |QBF aAlfa;
         aAlfa  = (aAlfa % -105) > "";
     |FINSI;
     aFicModelo = (("000000000" + nDocu) % -109) + aAlfa;
     |QBT aFicModelo;

     aUbicacion = "";
     |HAZ SacaUbicacion;

     eaDestino      = eaRuta + "/" + #dsarw046#10;  |QBF eaDestino;
     eaOrigen       = aUbicacion + aFicModelo;
     eaDocPC        = eaDestino;
     enSwIOCorrecta = 0;
     |HAZ RecibeConMD5;
     |SI enSwIOCorrecta = 0;
         |MENAV "0000 Ha habido un error al transferir el documento al servidor. Revise Permisos y espacio disponible.";
         |BORRA 020#dsarm005.a;
         |LIBERA #dsarm005;
         |ACABA;
     |FINSI;

     |SI eaSwBorroOrigen = "S";
          aAlfa = eaRuta + "/" + #dsarw046#10;  |QBF aAlfa;
          aAlfa = aAlfa < " ";
          aAlfa = aAlfa - ".pdf" + ".txt";
          |RFBORRA aAlfa;
     |FINSI;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |SI #dsarm001#7 = "N";  |Y aIPRemoto ! "";
         |XABRE "E", eaOrigen, nHandle;
     |SINO;
         |XABRE "EC", eaOrigen, nHandle;
     |FINSI;

     |SI FSalida < 0;
         |MENAV "0000 Ha habido un error al transferir el documento al servidor. Intentelo de nuevo";
         |BORRA 020#dsarm005.a;
         |LIBERA #dsarm005;
         |ACABA;
     |FINSI;

     #dsarm005#1 = enGrupo;
     #dsarm005#2 = enSubGrupo;
     #dsarm005#3 = enTipo;
     #dsarm005#4 = ~;
     |HORA aHora;
     aHora = aHora % 105;
     #dsarm005#5 = aHora;
     aUsuario = Usuario % 810;
     #dsarm005#6  = aUsuario;
     #dsarm005#7  = aUbicacion;
     #dsarm005#9  = aFicModelo;
     #dsarm005#8  = #dsarw046#1;
     #dsarm005#10 = #dsarw046#9;
     #dsarm005#14 = #dsarw046#6;
     #dsarm005#17 = #dsarw046#2;
     #dsarm005#18 = #dsarw046#3;
     #dsarm005#19 = #dsarw046#4;
     #dsarm005#20 = #dsarw046#5;
     #dsarm005#38 = #dsarw046#6;

     |SI #dsarw046#4 ! 202;  |Y #dsarw046#4 ! 218;
         |SI #dsarw046#3 = 1;   #dsarm005#22 = "ENERO     ";  |FINSI;
         |SI #dsarw046#3 = 2;   #dsarm005#22 = "FEBRERO   ";  |FINSI;
         |SI #dsarw046#3 = 3;   #dsarm005#22 = "MARZO     ";  |FINSI;
         |SI #dsarw046#3 = 4;   #dsarm005#22 = "ABRIL     ";  |FINSI;
         |SI #dsarw046#3 = 5;   #dsarm005#22 = "MAYO      ";  |FINSI;
         |SI #dsarw046#3 = 6;   #dsarm005#22 = "JUNIO     ";  |FINSI;
         |SI #dsarw046#3 = 7;   #dsarm005#22 = "JULIO     ";  |FINSI;
         |SI #dsarw046#3 = 8;   #dsarm005#22 = "AGOSTO    ";  |FINSI;
         |SI #dsarw046#3 = 9;   #dsarm005#22 = "SEPTIEMBRE";  |FINSI;
         |SI #dsarw046#3 = 10;  #dsarm005#22 = "OCTUBRE   ";  |FINSI;
         |SI #dsarw046#3 = 11;  #dsarm005#22 = "NOVIEMBRE ";  |FINSI;
         |SI #dsarw046#3 = 12;  #dsarm005#22 = "DICIEMBRE ";  |FINSI;
         |SI #dsarw046#3 = 99;  #dsarm005#22 = "ANUAL     ";  |FINSI;
     |SINO;
         |SI #dsarw046#3 = 1;   #dsarm005#22 = "1 PERIODO ";  |FINSI;
         |SI #dsarw046#3 = 2;   #dsarm005#22 = "2 PERIODO ";  |FINSI;
         |SI #dsarw046#3 = 3;   #dsarm005#22 = "3 PERIODO ";  |FINSI;
     |FINSI;

     |ABRE #agitab99;
     #agitab99#0 = #dsarw046#4;
     |LEE 000#agitab99.=;
     |SI FSalida ! 0;  |DDEFECTO #agitab99;  |FINSI;
     |CIERRA #agitab99;

     #dsarm005#21 = #agitab99#1;

     aAux = #dsarm004#5;   |QBF aAux;  |SI aAux ! "";  #dsarm005#23 = aAux + ":";  |FINSI;
     aAux = #dsarm004#6;   |QBF aAux;  |SI aAux ! "";  #dsarm005#24 = aAux + ":";  |FINSI;
     aAux = #dsarm004#7;   |QBF aAux;  |SI aAux ! "";  #dsarm005#25 = aAux + ":";  |FINSI;
     aAux = #dsarm004#8;   |QBF aAux;  |SI aAux ! "";  #dsarm005#26 = aAux + ":";  |FINSI;
     aAux = #dsarm004#9;   |QBF aAux;  |SI aAux ! "";  #dsarm005#27 = aAux + ":";  |FINSI;
     aAux = #dsarm004#27;  |QBF aAux;  |SI aAux ! "";  #dsarm005#28 = aAux + ":";  |FINSI;
     aAux = #dsarm004#28;  |QBF aAux;  |SI aAux ! "";  #dsarm005#29 = aAux + ":";  |FINSI;
     aAux = #dsarm004#29;  |QBF aAux;  |SI aAux ! "";  #dsarm005#30 = aAux + ":";  |FINSI;
     aAux = #dsarm004#30;  |QBF aAux;  |SI aAux ! "";  #dsarm005#31 = aAux + ":";  |FINSI;
     aAux = #dsarm004#31;  |QBF aAux;  |SI aAux ! "";  #dsarm005#32 = aAux + ":";  |FINSI;
     aAux = #dsarm004#10;  |QBF aAux;  |SI aAux ! "";  #dsarm005#33 = aAux + ":";  |FINSI;
     aAux = #dsarm004#11;  |QBF aAux;  |SI aAux ! "";  #dsarm005#34 = aAux + ":";  |FINSI;
     aAux = #dsarm004#12;  |QBF aAux;  |SI aAux ! "";  #dsarm005#35 = aAux + ":";  |FINSI;
     aAux = #dsarm004#13;  |QBF aAux;  |SI aAux ! "";  #dsarm005#36 = aAux + ":";  |FINSI;
     aAux = #dsarm004#14;  |QBF aAux;  |SI aAux ! "";  #dsarm005#37 = aAux + ":";  |FINSI;
     aAux = #dsarm004#15;  |QBF aAux;  |SI aAux ! "";  #dsarm005#60 = aAux + ":";  |FINSI;
     aAux = #dsarm004#16;  |QBF aAux;  |SI aAux ! "";  #dsarm005#61 = aAux + ":";  |FINSI;
     aAux = #dsarm004#17;  |QBF aAux;  |SI aAux ! "";  #dsarm005#62 = aAux + ":";  |FINSI;
     aAux = #dsarm004#18;  |QBF aAux;  |SI aAux ! "";  #dsarm005#63 = aAux + ":";  |FINSI;
     aAux = #dsarm004#19;  |QBF aAux;  |SI aAux ! "";  #dsarm005#64 = aAux + ":";  |FINSI;

     #dsarm005#93 = #dsarw046#10;

     |SI #dsarm005#19 = 036;  |O #dsarm005#19 = 037;
         aAlfa = #dsarm005#23 - "MOTIVO:";
         |SI FSalida ! 0;
             #dsarm005#23 = "Modelo " + #dsarm005#19;
         |FINSI;

         |SI #dsarw046#13 > "01.01.0000";
             aAlfa = #dsarm005#60 - "FECHA:";
             |SI FSalida ! 0;
                 aAlfa = #dsarm005#60;  |QBF aAlfa;
                 aAlfa = aAlfa + " " + #dsarw046#13;
                 #dsarm005#24 = aAlfa;
                 #dsarm005#60 = "";
             |FINSI;

             #dsarm005#11 = "Fecha presentaci¢n: " + #dsarw046#13;
         |FINSI;
     |FINSI;

     |GRABA 020#dsarm005.a;
     |LIBERA #dsarm005;
     |CIERRA #dsarm005;

     aAlfa = #dsarw046#7;  |QBF aAlfa;

     |SI aAlfa ! "";
         |SI #dsarm005#19 = 036;
             |HAZ Graba036;
         |FINSI;

         |SI #dsarm005#19 = 202;
             |HAZ Graba202;
         |FINSI;

         |SI #dsarm005#19 = 200;
             |HAZ Graba200;
         |FINSI;

         |SI #dsarm005#19 = 309;
             |HAZ Graba309;
         |FINSI;

         |SI #dsarm005#19 ! 036; |Y #dsarm005#19 ! 037;
          |Y #dsarm005#19 ! 200; |Y #dsarm005#19 ! 220;
          |Y #dsarm005#19 ! 309;
             |HAZ GrabaPlaning;
         |FINSI;
     |FINSI;

     aAlfa = "dsarz013;" + #dsarm005#0;
     |SUB_EJECUTA aAlfa;

     aAlfa = "dsarz030;" + #dsarm005#0;
     |SUB_EJECUTA aAlfa;
|FPRC;

|DEFBUCLE dsarw046G;
     #dsarw046#2;
     ;
     "*",       1;
     "*", 9999999;
     be;
     NULL, dsarw046G;
|FIN;

|PROCESO CambiaRaros;
     aAlfa    = eaFicRes;   |QBF aAlfa;
     aLong    = aAlfa % 0;
     nLong    = aLong;
     aCadena  = "";
     nPuntos  = 0;
     |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos   = (nCarac * 100) + 1;
           aCarac =  aAlfa % nPos;
           |SI aCarac = ".";
               nPuntos = nPuntos + 1;
           |FINSI;

           |SI aCarac = " ";
               ||aCarac = "_";
               aCarac = "";
           |FINSI;

           aCadena = aCadena + aCarac;
     |SIGUE;

     |SI nPuntos ] 2;
         aAlfa   = aCadena;
         aCadena = "";
         |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
               nPos   = (nCarac * 100) + 1;
               aCarac =  aAlfa % nPos;

               |SI aCarac = ".";  |Y nPuntos > 1;
                   aCarac  =  "_";
                   nPuntos = nPuntos - 1;
               |FINSI;

               aCadena = aCadena + aCarac;
         |SIGUE;
     |FINSI;

     |SI aCadena ! eaFicRes;
         aOrigen  = aFichero;
         aDestino = eaRuta + "\" + aCadena;
         |RRENOMBRA_FICHERO aOrigen, aDestino;

         eaFicRes  = aCadena;
         aFichero = aDestino;
     |FINSI;
|FPRC;

|PROCESO QuitaBarras;
     aAuxBarra = "";
     |QBF aBase;
     aLong = aBase % A0;
     nLong = aLong;
     |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
          nSaca = (nVoy * 100) + 1;
          aLetra = aBase % nSaca;
          |SI aLetra = "/";  |O aLetra = "\";
               aLetra = "_";
          |FINSI;
          aAuxBarra = aAuxBarra + aLetra;

          |SI aLetra = ":";
              aAuxBarra = "";
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO AveriguaINI;
     aSerie = "";
     |ESPECIFICA "SERIALIZACION", aSerie;
     aIni = FSalida;          ||Antes esto lo devolvia en la variable aSerie
     aIni = aIni % 106;       ||Esto es el numero de ORO. Los 6 primeros digitos
     nIni = aIni;
     aIni = ("000000" + nIni) % -106;

     |DBASE aBase;  |QBF aBase;
     |HAZ QuitaBarras;

     nRegistro = PARAMETRO;
     aParamIni = aIni + aAuxBarra + (("000000000" + nRegistro) % -109);
|FPRC;

|PROCESO DesdeDSPARTES;
     aRespuestaOCR = PARAMETRO - "DSPARTES";  |QBF aRespuestaOCR;
     aRespuestaOCR = "C:\DOCUMENTOS\DSARCHI\OCR\000000\" + aRespuestaOCR;

     |ABRE #dsarm036;
     |HAZ SacaDatosRespuesta;
     |CIERRA #dsarm036;

     |VENTANA 0501, 1775, -1, 16, "Variables dsEscan";
     nSubVentz1 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |DDEFECTO #dsarw048;

     #dsarw048#0 = enModelo;
     #dsarw048#1 = eaDni;
     #dsarw048#4 = eaEjercicio;
     #dsarw048#5 = eaPeriodo;
     #dsarw048#7 = eaElect;
     #dsarw048#8 = eaJusti;

     |PINPA #0#dsarw048;
     |PINDA #0#dsarw048;
     |LEETECLA aTecla;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nSubVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nSubVentz1;
|FPRC;

|PROGRAMA;
     enErrorMod = 0;

     |ABRE #dsarm001;
     |DDEFECTO #dsarm001;
     |LEE 000#dsarm001.p;
     |CIERRA #dsarm001;

     |SI PARAMETRO = "DesdeDSPARTES";
         |HAZ DesdeDSPARTES;
         |ACABA;
     |FINSI;

     |HAZ Traete_pdftotext;
     |SI enError = 1;  |ACABA;  |FINSI;

     aAlfa = "0000A continuaci¢n seleccione el directorio donde se encuentran las HTML y PDF a tratar.";
     |MENAV aAlfa;

     nLabel1 = -1;
     nLabel2 = -1;
     eaRuta  = "D ";
     |BROWSE eaRuta;

     aAlfa  = eaRuta;   |QBF aAlfa;
     eaRuta = "";
     aLong  = aAlfa % 0;
     nLong  = aLong;
     |PARA nCarac = 2;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
           nPos = (nCarac * 100) + 1;
           eaRuta = eaRuta + (aAlfa % nPos);
     |SIGUE;

     |SI eaRuta = "";
         |MENAV "0000No ha seleccionado un directorio.";
         enErrorMod = 1;
         |ACABA;
     |FINSI;

     |HAZ EstaIntegral;
     |HAZ EstaBasica;

     eaVerde   = "0,185,0;255,255,255";
     eaAzul    = "18,28,245;255,255,255";
     eaRojo    = "255,80,80;255,255,255";

     aUbicacion = "";
     |HAZ SacaUbicacion;

     aAlfa = "Capturar modelos (" + #dsarm004#3;  |QBF aAlfa;
     aAlfa = aAlfa + ")";
     |VENTANA 0501, 2999, -1, 16, aAlfa;
     nVentz1  = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;
     |PAUSA;

     |CONTROL_SIMPLE 0, "LABEL,{{9}} Leyendo modelos", 0610, 0798, NULL;
     nLabel1 = FSalida;

     aDat = ("46" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #dsarw046#aDat#;

     |ABRE #dsarw046;  |CIERRA #dsarw046;  |DELINDEX  #dsarw046;

     |ABRE #dsarw046;

     |SI #dsarm001#45 = "N"; |Y #dsarm001#168 = "N";
         #dsarm004#81 = "N";
     |FINSI;

     |SI #dsarm001#168 = "S";
         |DBASE aBase;   |QBF aBase;
         aDirBaseServidor = aBase + "ocr";  |MKDIR aDirBaseServidor;
         aDirBaseServidor = aBase + "ocr/";

         |HAZ Traete_dsescan_cli;
         |SI enError = 1;  |ACABA;  |FINSI;

         |HAZ Traete_imagemagick;
         |SI enError = 1;  |ACABA;  |FINSI;

         aIni = "";
         |HAZ AveriguaINI;
         |SI aIni = ""; |O aIni = "000000";
             #dsarm004#81 = "N";
         |FINSI;
     |FINSI;

     nConta     = 0;

     aFichero   = eaRuta + "\*.html";
     |R_PDIR aFichero;
     |PARA; |SI; |HACIENDO;
         |SI FSalida ! 0; |SAL; |FINSI;

         eaFicRes = (aFichero - eaRuta) > "";
         eaFicRes = eaFicRes % 2;

         |HAZ CambiaRaros;

         |HAZ LeeFicheroHTML;
         |PULSATECLA;

         |R_SDIR aFichero;
     |SIGUE;

     |SI #dsarm001#7 = "N";
          |HAZ DimeUnidad;
     |SINO;
          |HAZ LeeUnidadBasico;

          eaUnidad = eaUnidadBasico % 101;
     |FINSI;

     aDirBaseLocal = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aDirBaseLocal;
     aDirBaseLocal = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aDirBaseLocal;
     aDirBaseLocal = eaUnidad + ":\DOCUMENTOS\DSARCHI\";

     aFicMod = eaRuta + "\*.pdf";
     |R_PDIR aFicMod;
     |PARA; |SI; |HACIENDO;
         |SI FSalida ! 0; |SAL; |FINSI;

         eaFicRes  = (aFicMod - eaRuta) > "";
         eaFicRes  = eaFicRes % 2;
         aFichero = aFicMod;

         |HAZ CambiaRaros;

         |HAZ LeeFicheroPDF;
         |PULSATECLA;

         |R_SDIR aFicMod;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nLabel1;
     |FIN_CONTROL_WINDOWS nLabel2;

     |CONTROL_SIMPLE 0, "LABEL,{{2}}Doble click en la l°nea para MARCAR o DESMARCAR el modelo", 0502, 0598, NULL;
     nId1 = FSalida;

     |SI #dsarm004#81 = "N";
         |CONTROL_SIMPLE 0, "BOTON,{{137}}Marcar todo", 2602, 2715, Todo;
         nId2 = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{193}}Desmarcar todo", 2617, 2732, Ninguno;
         nId3 = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{135}}Marcar por modelo", 2634, 2749, PorModelo;
         nId4 = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{197}}Cambiar valores", 2651, 2761, CambiarValores;
         nId5 = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{197}}Ver modelo", 2663, 2774, VerModelo;
         nId6 = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,Ver documento Txt", 2676, 2786, VerModeloTXT;  ||aqui
         nId7 = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,Gestionar no reconocidos", 2688, 2798, NoReconocidos;
         nId11 = FSalida;
     |FINSI;

     |SI #dsarm004#81 = "S";
         |CONTROL_SIMPLE 0, "BOTON,{{137}}Marcar todo", 2602, 2712, Todo;
         nId2 = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{193}}Desmarcar todo", 2614, 2724, Ninguno;
         nId3 = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{135}}Marcar por modelo", 2626, 2736, PorModelo;
         nId4 = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{197}}Cambiar valores", 2638, 2748, CambiarValores;
         nId5 = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{197}}Ver modelo", 2650, 2760, VerModelo;
         nId6 = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,Ver documento Txt", 2662, 2772, VerModeloTXT;  ||aqui
         nId7 = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,Reintentar OCR", 2674, 2784, Reintentar;
         nId10 = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,Ajustar en DS", 2686, 2796, EnviaAjuste;
         nId9 = FSalida;

         |ESTADO_CONTROL nId9,  "DISABLE";

         aAlfa = "0000Todos los modelos no reconocidos se han enviado autom†ticamente a DS para  ";
         aAlfa = aAlfa + "que en un breve per°odo de tiempo el modelo pueda ser reconocido en una ";
         aAlfa = aAlfa + "pr¢xima captura.";
         |MENAV aAlfa;
     |FINSI;

     |CONTROL_SIMPLE 0, "BOTON,{{197}}Recomendaciones", 2902, 2920, Recomendaciones;
     nId8 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{197}}Ayuda colores registros", 2924, 2944, Colores;


     |PARA;  |SI;  |HACIENDO;
          |HAZ LinealSimple;
          |CONFI "0000SConforme con lo seleccionado";
          |SI FSalida = 0;  |SAL;  |FINSI;
     |SIGUE;

     |SELECT #2#dsarw046;
     |LEE 000#dsarw046.p;
     |SI FSalida ! 0;  |O #dsarw046#11 = " ";
         |MENAV "0000Seleccion vac°a";
         enErrorMod = 1;

         |DESTRUYECONTROL nGrid;
         |CIERRA #dsarw046;
         |DELINDEX #dsarw046;

         aVent1 = -1;
         aVent2 = -1;
         aVent3 = 0;
         aVent4 = nVentz1;
         aVent5 = "MODELESS";
         |ESPECIFICA "ESTADO_VENTANA", aVent;

         |FINVENTANA nVentz1;

         |ACABA;
     |FINSI;

     |DESTRUYECONTROL nGrid;
     |FIN_CONTROL_WINDOWS nId1;
     |FIN_CONTROL_WINDOWS nId2;
     |FIN_CONTROL_WINDOWS nId3;
     |FIN_CONTROL_WINDOWS nId4;
     |FIN_CONTROL_WINDOWS nId5;
     |FIN_CONTROL_WINDOWS nId6;
     |FIN_CONTROL_WINDOWS nId7;  ||aqui
     |FIN_CONTROL_WINDOWS nId8;

     |PTEC 802;
     |PAUSA;

     |CONTROL_SIMPLE 0, "LABEL,{{9}} Grabando modelos", 0610, 0798, NULL;
     nLabel1 = FSalida;

     |HAZ CargaVarBorrado;

     |BUCLE dsarw046G;

     |CIERRA #dsarw046;
     |DELINDEX #dsarw046;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentz1;
|FPRO;

|PROCESO Tipo80;  |TIPO 80;
     |ABRE #agitab99;

     #agitab99#0 = 036;
     |LEE 000#agitab99.=;
     |SI FSalida ! 0;
         |DDEFECTO #agitab99;
         #agitab99#0 = 036;
         #agitab99#1 = "DECLARACION CENSAL";
         #agitab99#2 = "DE ALTA, MODIFICACION Y BAJA EN EL CENSO DE EMPRESARIOS, PROFESIONALES";
         #agitab99#3 = "Y RETENEDORES";
         #agitab99#4 = "S";
         #agitab99#5 = "A";
         #agitab99#6 = "M";
         #agitab99#7 = "N";
         #agitab99#8 = "N";

         |GRABA 020#agitab99.n;
         |LIBERA #agitab99;
     |FINSI;

     #agitab99#0 = 037;
     |LEE 000#agitab99.=;
     |SI FSalida ! 0;
         |DDEFECTO #agitab99;
         #agitab99#0 = 037;
         #agitab99#1 = "DECLARACION CENSAL SIMPLIFICADA";
         #agitab99#2 = "DE ALTA, MODIFICACION Y BAJA EN EL CENSO DE EMPRESARIOS, PROFESIONALES";
         #agitab99#3 = "Y RETENEDORES";
         #agitab99#4 = "S";
         #agitab99#5 = "A";
         #agitab99#6 = "M";
         #agitab99#7 = "N";
         #agitab99#8 = "N";

         |GRABA 020#agitab99.n;
         |LIBERA #agitab99;
     |FINSI;

     |CIERRA #agitab99;

     |ABRET #dsarm004;
|FPRC;

|PROCESO Tipo90;  |TIPO 90;
     |CIERRAT #dsarm004;
|FPRC;
