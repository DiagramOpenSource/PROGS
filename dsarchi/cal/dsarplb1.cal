||PLB. Firma Electronica

||
||Ahora se le pasa un fichero con los parametros a firmar
||Ejemplo. dsaeatfact.ini
||F c:\ds\bin\nuevo.ttt 21630624K c:\ds\bin\uno3.fir
||Metodo antiguo

||Ahora tambien firmaremos usando el firmador de Sisco.  (JAVA).
||FirmaDocumentoXML y VerificaFirmaXML

|VARIABLES;
     aDirLocal = "";
     {1}aLocal = "";
     aPathOriDll = "";
     aPathDesDll = "";
     aNombreDll = "";
     nHandle3 = 0;
     aOrigen = "";
     aFichero = "";

     &eaFEHtmlAux = "";
     aNombreSinXML = "";
     &eaNombreXML = "";
     &enSwHayJava = 0;
     &eaUnidad = "";
     aAbre = "";
     aPathJavaExe = "";

     aAlfa = "";
     nPausa = 0;
     aDestinoTempo = "";
     nHandle2 = 0;
     nHandleIni = 0;
     aLetra = "";
     nLetra = 0;
     nSaltosFuera = 0;

     &eaNomFirmador = "";
     &eaBaseFirmador = "";
     &eaFEOrigen = "";
     &eaFEDestino = "";
     &eaDniFirmador = "";
     &eaErrorFirma = "";

     aBorra = "";
     aLinea = "";
     aEjecuta = "";
     nHandle = 0;
     aAux = "";
     aMensaje = "";
     nCaracter = 0;
     nHandleEjec = 0;

     aUnidadSistema = "";
|FIN;


|PROCESO FirmaDocumento;
     aBorra = eaBaseFirmador + "Error.log";
     |RFBORRA aBorra;

     |RFBORRA eaFEDestino;
     aDestinoTempo = eaFEDestino + "64";
     |RFBORRA aDestinoTempo;

     aBorra = eaBaseFirmador + "dsaeatfact.ini";
     |FBORRA aBorra;

     aEjecuta = eaBaseFirmador + "dsaeatfact.ini";
     |XABRE "CW", aEjecuta, nHandleIni;
     |SI FSalida < 0;
          aMensaje = "0000Error. Problemas al crear " + aEjecuta;
          |MENAV aMensaje;
          |ACABA;
     |SINO;
          aLinea = "F " + eaFEOrigen + " " + eaDniFirmador + " " + aDestinoTempo;
          |XGRABA nHandleIni, aLinea;
          |XCIERRA nHandleIni;
     |FINSI;

     ||aEjecuta = eaBaseFirmador + "dsaeatfact.exe F " + eaFEOrigen + " " + eaDniFirmador + " " + aDestinoTempo;
     ||aEjecuta = eaBaseFirmador + "firma.bat";
     ||aEjecuta = eaBaseFirmador + "dsaeatfact.exe";

     aEjecuta = "START " + eaBaseFirmador + "dsabreextension";
     aEjecuta = aEjecuta + " " + &34 + eaBaseFirmador + "dsaeatfact.exe" + &34;
     aEjecuta = aEjecuta + " " + eaBaseFirmador + "fin" + Usuario + ".txt";

     aAlfa  = eaBaseFirmador + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;

     |RSYSTEM aEjecuta;
     aAlfa  = eaBaseFirmador + "fin" + Usuario + ".txt";
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa < 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aAlfa, nHandle;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;
             |PULSATECLA;
     |SIGUE;

     |RFBORRA aAlfa;

     aBorra = eaBaseFirmador + "Error.log";
     |XABRE "CU", aBorra, nHandle;
     |SI FSalida ] 0;
          |XLEE nHandle, 250, aLinea;
          |SI FSalida ] 0;
               |QBF aLinea;
               eaErrorFirma = aLinea;
          |FINSI;
          |XCIERRA nHandle;
     |SINO;
          ||ARA55
          |HAZ ArreglaFirma;
     |FINSI;

     aBorra = eaBaseFirmador + "dsaeatfact.ini";
     |FBORRA aBorra;
|FPRC;

|PROCESO ArreglaFirma;
     |XABRE "CUB", aDestinoTempo, nHandle;
     |SI FSalida ] 0;
          |XABRE "CWB", eaFEDestino, nHandle2;
          |SI FSalida ] 0;
               |PARA; |SI; |HACIENDO;
                    |XLEE nHandle, 1, aLetra;
                    |SI FSalida [ 0;
                         |SAL;
                    |FINSI;
                    nLetra = &aLetra;
                    |SI nLetra = 13; |O nLetra = 10;
                         nSaltosFuera = nSaltosFuera + 1;
                         |SI nSaltosFuera [ 4;
                              ||Okie. El caracter se salta.
                              ||Solo "saltamos" los 4 primeros &10 y/o &13
                         |SINO;
                              |XGRABA nHandle2, aLetra;
                         |FINSI;
                    |SINO;
                         |XGRABA nHandle2, aLetra;
                    |FINSI;
               |SIGUE;
          |FINSI;
          |XCIERRA nHandle2;
     |FINSI;
     |XCIERRA nHandle;

     aDestinoTempo = eaFEDestino + "64";
     |RFBORRA aDestinoTempo;
|FPRC;


|PROCESO RecuperaDocFirmado;
     aBorra = eaBaseFirmador + "Error.log";
     |RFBORRA aBorra;

     aBorra = eaBaseFirmador + "dsaeatfact.ini";
     |RFBORRA aBorra;


     aEjecuta = eaBaseFirmador + "dsaeatfact.exe V " + eaFEOrigen + " " + eaFEDestino;
     |RSYSTEM aEjecuta;

     aBorra = eaBaseFirmador + "Error.log";
     |XABRE "CU", aBorra, nHandle;
     |SI FSalida ] 0;
          |XLEE nHandle, 250, aLinea;
          |SI FSalida ] 0;
               |QBF aLinea;
               aAux = aLinea % 102;
               |SI aAux = "00";
                    eaNomFirmador = aLinea;
               |SINO;
                    eaErrorFirma = aLinea;
               |FINSI;
          |FINSI;
          |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROCESO VerificaJava;
     |PARA nCaracter = 67;  |SI nCaracter [ 90;  |HACIENDO nCaracter = nCaracter + 1;
           aUnidadSistema = &nCaracter + ":";
           aAbre   = aUnidadSistema + "\Archivos de programa\Java\jre1.8.0_31\bin\java.exe";
           |XABRE "EC", aAbre, nHandleEjec;
           |SI FSalida ] 0;
               aPathJavaExe = aAbre;
               enSwHayJava = 1;
               |SAL;
           |FINSI;

           aAbre   = aUnidadSistema + "\Program Files\Java\jre1.8.0_31\bin\java.exe";
           |XABRE "EC", aAbre, nHandleEjec;
           |SI FSalida ] 0;
               aPathJavaExe = aAbre;
               enSwHayJava = 1;
               |SAL;
           |FINSI;

           aAbre   = aUnidadSistema + "\Program Files (x86)\Java\jre1.8.0_31\bin\java.exe";
           |XABRE "EC", aAbre, nHandleEjec;
           |SI FSalida ] 0;
               aPathJavaExe = aAbre;
               enSwHayJava = 1;
               |SAL;
           |FINSI;


/*
           aAbre   = aUnidadSistema + "\Archivos de programa\Java\jre6\bin\java.exe";
           |XABRE "EC", aAbre, nHandleEjec;
           |SI FSalida ] 0;
               aPathJavaExe = aAbre;
               enSwHayJava = 1;
               |SAL;
           |FINSI;

           aAbre   = aUnidadSistema + "\Program Files\Java\jre6\bin\java.exe";
           |XABRE "EC", aAbre, nHandleEjec;
           |SI FSalida ] 0;
               aPathJavaExe = aAbre;
               enSwHayJava = 1;
               |SAL;
           |FINSI;
*/
     |SIGUE;
|FPRC;

|PROCESO VerificaFirmaXML;
     |HAZ ControlDlls;

     aAux = eaNombreXML % -104;
     |SI aAux = ".xml";
          aNombreSinXML = eaNombreXML - ".xml";
     |SINO;
          aNombreSinXML = eaNombreXML - ".xsig";
     |FINSI;

     eaBaseFirmador = eaUnidad + ":\DOCUMENTOS\DSARCHI\";
     |QBF eaBaseFirmador;

     aBorra = eaBaseFirmador + eaNombreXML + ".txt";
     |RFBORRA aBorra;

     aBorra = eaBaseFirmador + aNombreSinXML + ".html";
     |RFBORRA aBorra;

     aBorra = eaBaseFirmador + aNombreSinXML + ".html.txt";
     |RFBORRA aBorra;

     aBorra = eaBaseFirmador + "firmador.ini";
     |RFBORRA aBorra;

     aAbre = eaBaseFirmador + "firmador.ini";
     |XABRE "CW", aAbre, nHandle2;
     |SI FSalida ] 0;
          aLinea = "VH";
          ||aLinea = "V";
          |XGRABA nHandle2, aLinea;
          aLinea = eaNombreXML;
          |XGRABA nHandle2, aLinea;
     |FINSI;
     |XCIERRA nHandle2;

     aAbre = eaBaseFirmador + "lanzaverifxml.bat";
     |XABRE "CW", aAbre, nHandle2;
     |SI FSalida ] 0;
          aLinea = "@echo off";
          |XGRABA nHandle2, aLinea;
          aLinea = eaUnidad + ":";
          |XGRABA nHandle2, aLinea;
          aLinea = "cd " + eaBaseFirmador;
          |XGRABA nHandle2, aLinea;
          aLinea = eaBaseFirmador + "firmador.exe >> log2.log";
          |XGRABA nHandle2, aLinea;
     |FINSI;
     |XCIERRA nHandle2;

     ||aEjecuta = "cmd " + &34 + "/c start " + eaBaseFirmador + "lanzaverifxml.bat";

     aEjecuta = eaBaseFirmador + "lanzaverifxml.bat";


     |RSYSTEM aEjecuta;

     aAbre = eaBaseFirmador + eaNombreXML + ".txt";
     |XABRE "CU", aAbre, nHandle;
     |SI FSalida ] 0;
          |XLEE nHandle, 250, aLinea;
          |SI FSalida ] 0;
               |QBF aLinea;
               aAux = aLinea % 102;
               |SI aAux = "00";
                    eaNomFirmador = aLinea;
               |SINO;
                    eaErrorFirma = aLinea;
               |FINSI;
          |FINSI;
          |XCIERRA nHandle;

          aAbre = eaBaseFirmador + aNombreSinXML + ".html";
          |XABRE "CE", aAbre, nHandle;
          |SI FSalida > 0;
               eaFEDestino = aAbre;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO FirmaDocumentoXML;
     |HAZ ControlDlls;

     eaErrorFirma = "";
     aNombreSinXML = eaNombreXML - ".xml";

     eaBaseFirmador = eaUnidad + ":\DOCUMENTOS\DSARCHI\";
     |QBF eaBaseFirmador;

     aBorra = eaBaseFirmador + eaNombreXML + ".txt";
     |RFBORRA aBorra;

     aBorra = eaBaseFirmador + aNombreSinXML + ".html";
     |RFBORRA aBorra;

     aAbre = eaBaseFirmador + "firmador.ini";
     |XABRE "CW", aAbre, nHandle2;
     |SI FSalida ] 0;
          aLinea = "FH";
          |XGRABA nHandle2, aLinea;
          aLinea = eaNombreXML;
          |XGRABA nHandle2, aLinea;
          aLinea = aNombreSinXML + ".xsig";
          |XGRABA nHandle2, aLinea;
          aLinea = eaDniFirmador;
          |XGRABA nHandle2, aLinea;
     |FINSI;
     |XCIERRA nHandle2;

     aAbre = eaBaseFirmador + "lanzafirmador.bat";
     |XABRE "CW", aAbre, nHandle2;
     |SI FSalida ] 0;
          aLinea = "@echo off";
          |XGRABA nHandle2, aLinea;
          aLinea = eaUnidad + ":";
          |XGRABA nHandle2, aLinea;
          aLinea = "cd " + eaBaseFirmador;
          |XGRABA nHandle2, aLinea;
          aLinea = eaBaseFirmador + "firmador.exe >> log2.log";
          |XGRABA nHandle2, aLinea;
     |FINSI;
     |XCIERRA nHandle2;

/*
     ||ESTO NO VA, SALE LA VENTANA DE MSDOS, MAS GRANDE DE LO NORMAL

     aEjecuta = "START " + eaBaseFirmador + "dsabreextension";
     aEjecuta = aEjecuta + " " + &34 + eaBaseFirmador + "lanzafirmador.bat" + &34;
     aEjecuta = aEjecuta + " " + eaBaseFirmador + "fin" + Usuario + ".txt";

     aAlfa  = eaBaseFirmador + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;

     |RSYSTEM aEjecuta;
     aAlfa  = eaBaseFirmador + "fin" + Usuario + ".txt";
     |PARA;  |SI;  |HACIENDO;
             |PARA nPausa = 1; |SI nPausa < 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;

             |XABRE "EC", aAlfa, nHandle;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;
             |PULSATECLA;
     |SIGUE;

     |RFBORRA aAlfa;
*/

     aEjecuta = eaBaseFirmador + "lanzafirmador.bat";
||     aEjecuta = "cmd " + &34 + "/c START /MIN " + eaBaseFirmador + "lanzafirmador.bat" + &34;
     |RSYSTEM aEjecuta;

     aAbre = eaBaseFirmador + aNombreSinXML + ".txt";
     |XABRE "CU", aAbre, nHandle;
     |SI FSalida ] 0;
          |XLEE nHandle, 250, aLinea;
          |SI FSalida ] 0;
               |QBF aLinea;
               aAux = aLinea % 102;
               |SI aAux = "00";
                    eaNomFirmador = aLinea;
               |SINO;
                    eaErrorFirma = aLinea;
               |FINSI;
          |FINSI;
          |XCIERRA nHandle;

          aAbre = eaBaseFirmador + aNombreSinXML + ".html";
          |XABRE "CE", aAbre, nHandle;
          |SI FSalida > 0;
               eaFEHtmlAux = aAbre;
          |FINSI;
     |SINO;
          eaErrorFirma = "Error al firmar o proceso de Firma Cancelado";
     |FINSI;
|FPRC;

|PROCESO ControlaDll;
     aFichero = aPathDesDll + aNombreDll;

     |XABRE "CE", aFichero, nHandle3;
     |SI FSalida < 0;
          ||Tengo que copiar el fichero.
          aOrigen = aPathOriDll + aNombreDll;

          |RCOPIA_FICHERO aOrigen, aFichero;
     |FINSI;
|FPRC;

|PROCESO DamePathDlls;
     |ESPECIFICA "RBASS", aLocal;
     aDirLocal = aLocal;

     aPathOriDll = aDirLocal + "bin/";

     aPathDesDll = "c:\windows\system32\";
|FPRC;

|PROCESO ControlDlls;
     aPathOriDll = "";
     aPathDesDll = "";
     |HAZ DamePathDlls;

     aNombreDll = "msvcr71.dll";
     |HAZ ControlaDll;
|FPRC;
