|FICHEROS;
     dsarm001;

     dpntm000;
     dpntm001;
     dpntm002;
     dpntm003;
     dpntm004;
     dpntm005;
     dpntm006;

     dpntw001,MANTE;
     dpntw005,MANTE;
     dsarw010;

     dsarz010;

     :/integral/def/dsam0000;
     :/basica/def/agifigen;
     :/laboral/def/nomw0003;
|FIN;

|VARIABLES;
     aBasePlugins = "";
     aOrigenMd5 = "";
     aDestinoMd5 = "";
     aBasePla = "";
     aVersion1 = "";
     aVersion2 = "";
     {1}aContiene = "";


     aEmail = "";
     aDirecOculta = "";

     nSwSMTPServPropio = 0;
     aVarSMTP = "";
     aVarUsuario = "";
     aVarPassword = "";
     aAlfa2 = "";

     fFecha = @;
     aFecha = "";
     aMensaje = "";

     nVentTrab        = 0;
     nCrea            = 0;
     nHandle          = 0;
     nHandle1         = 0;
     nHandle2         = 0;
     nRegilla         = 0;
     nReg             = 0;
     nLong            = 0;
     nCaracter        = 0;
     nPos             = 0;
     nCamuf           = 0;
     nNum             = 0;
     nCod             = 0;
     nPosi            = 0;
     nGrupo           = 0;
     nDsCorreo        = 0;
     nIde             = 0;
     nPanW5           = 0;

     aNGrupo          = "";
     aAlfa            = "";
     aAlfa1           = "";
     aBase            = "";
     aMas             = "";
     aConten          = "";
     aCarac           = "";
     aCarac10         = "";
     aEjecuta         = "";
     aLong            = "";
     aOperacion       = "";
     aDOperacion      = "";
     aHora            = "";
     aTo              = "";
     aMac             = "";
     aServidor        = "";
     aBaseMensaje     = "";
     aLogo            = "";
     aNLogo           = "";
     aFrom            = "";
     aAsunto          = "";
     aFrase           = "";
     aDirec           = "";
     aNomDes          = "";
     aNomGru          = "";
     aNomEmp          = "";
     aAbreTxt         = "";
     aAbre            = "";
     aAbreCuerpo      = "";
     aAbreHTMO        = "";
     aAbreHTMD        = "";
     aAbreTXT         = "";
     aAbreTXTO        = "";
     aAbreTXTD        = "";
     aAbreFIN         = "";
     aEMail           = "";
     aIP              = "";
     aSalida          = "";
     aAutenti         = "";

     {-1}aVent        = "";
         aVent1       = 0;
         aVent2       = 0;
         aVent3       = 0;
         aVent4       = 0;
         aVent5       = "";

     &enEmpresa       = 0;
     &eaEmpresa       = "";
     &eaZona          = "";
     &eaEMail         = "";
     &eaCIF           = "";
     &enErrorCorreo   = 0;
     &eaFrom          = "";
     &enEsDSARCHI     = 0;
     &eaPass          = "";
     &eaPassEnc       = "";
     &enCargaPerfiles = 0;
     &enCalDESPANET   = 0;
     &enGrid          = 0;
     &enGrid5         = 0;
     &enModo          = 0;
     &eaPrograma      = "";
     &enAprobacion    = 0;
     &enIdeCli        = 0;
     &eaNomCli        = "";
     &eaNifCli        = "";
     &eaMaiCli        = "";
     &eaTelCli        = "";
     &eaIdeNif        = "";
     &eaNomNif        = "";
     &eaModoNet       = "";
     &eaBaseNet       = "";
     &eaFechaNet      = "";
     &eaAccesoNet     = "";
     &eaUsuNet        = "";
     &eaEmpNet        = "";
     &eaTraNet        = "";
     &eaAccNet        = "";
     &eaMaiNet        = "";
     &eaDesNet        = "";
     &eaLabNet        = "";
     &eaAlfa          = "";
     &eaAcceso        = "";
     &eaAdmin         = "";
     &enCreaAcceso    = 0;
|FIN;

|PROCESO PonDirecciones;
     aLong  = aTo % 0;
     nLong  = aLong;
     aFrase = "";
     aDirec = "";
     |PARA nPosi = 1;  |SI nPosi [ nLong;  |HACIENDO nPosi = nPosi + 1;
           nPos   = (nPosi * 100) + 1;
           aCarac = aTo % nPos;

           |SI aCarac = ";";  |O aCarac = ",";
               aFrase = aFrase + "--to=" + &34 + aDirec + &34 + " ";
               aDirec = "";
           |SINO;
               aDirec = aDirec + aCarac;
           |FINSI;
     |SIGUE;

     |SI aDirec ! "";
         aFrase = aFrase + "--to=" + &34 + aDirec + &34;
     |FINSI;

     |SI aDirecOculta ! "";
         aFrase = aFrase + " --bcc=" + &34 + aDirecOculta + &34;
     |FINSI;

     aConten = aFrase + " \" + &10;
|FPRC;

|PROCESO EjecutaShellCorreo;
     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     |HAZ ParametrosSMTPCLI;

     aAbreTXT  = aAbre;
     aAbreHTMO = aBaseMensaje + "dsoporte.htm";
     aAbreHTMD = aBaseMensaje + #dpntw001#1 + ".htm";  |QBT aAbreHTMD;
     |FBORRA aAbreHTMD;

     |XABRE "WB", aAbreHTMD, nHandle1;
     |XABRE "AB", aAbreHTMO, nHandle2;

     nRegilla = 0;
     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            |SI nRegilla = 0;  |Y aAlfa ! "{";
                |XGRABA nHandle1, aAlfa;
            |FINSI;

            |SI aAlfa = "}";
                aConten  = aConten + aAlfa;

                |SI aConten = "{NOMBREDESPA}";
                    |SI aNomGru = "";
                        aAlfa = aNomDes + " le agradece la confianza depositada en nosotros.";
                    |SINO;
                        aAlfa = aNomDes;
                    |FINSI;
                |FINSI;

                |SI aConten = "{NOMBREGRU}";
                    |SI aNomGru = "";
                        aAlfa = "";
                    |SINO;
                        aAlfa = aNomGru + " le agradece la confianza depositada en nosotros.";
                    |FINSI;
                |FINSI;

                |SI aConten = "{NOMEMP}";
                    aAlfa = aNomEmp;
                |FINSI;

                |SI aConten = "{LOGO}";
                    ||Por el tema del "cid:" Para la imagen embebida
                    ||aAlfa = &34 + aNLogo + &34;
                    aAlfa = aNLogo;
                |FINSI;

                |SI aConten = "{EMAIL}";
                    aAlfa = #dpntw001#9;
                |FINSI;

                |SI aConten = "{USUARIO}";
                    aAlfa = #dpntw001#1;
                |FINSI;

                |SI aConten = "{ACCESO}";
                    aAlfa = "http://www.geconet.net/portal/";
                    aAlfa = aAlfa + "crearAcceso.php?claveGeconet=" + eaPassEnc;

                    eaPass = #dpntw001#9;  |HAZ EncriptaMAC;
                    aAlfa  = aAlfa + "&email=" + eaPassEnc;  |QBF aAlfa;
                    eaPass    = "";
                    eaPassEnc = "";
                |FINSI;

                |XGRABA nHandle1, aAlfa;

                nRegilla = 0;
                aConten  = "";
            |SINO;
                |SI aAlfa = "{";  |O nRegilla = 1;
                    aConten  = aConten + aAlfa;
                    nRegilla = 1;
                |FINSI;
            |FINSI;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;
     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     |DBASE aBasePla;  |QBF aBasePla;
     aBasePlugins = aBasePla + "plugins/";

     aOrigenMd5 = aBasePlugins + "smtp-cli";
     aDestinoMd5 = aBaseMensaje + "smtp-cli";
     |HAZ CopiaConMd5;
     aEjecuta = "chmod +x " + aDestinoMd5;
     |SYSTEM aEjecuta;

     aAbreTXTO = aBaseMensaje + "dscorreo.sh";
     aAbreTXTD = aBaseMensaje + #dpntw001#1 + ".sh";  |QBT aAbreTXTD;
     aAbreFIN  = aBaseMensaje + #dpntw001#1 + ".txt"; |QBT aAbreFIN;
     |FBORRA aAbreTXTD;
     |FBORRA aAbreFIN;

     |XABRE "WB", aAbreTXTD, nHandle1;
     |XABRE "AB", aAbreTXTO, nHandle2;

     aCarac10 = &10;
     aConten = "";
     aVarSMTP = #dsarw010#19;
     |QBF aVarSMTP;
     aVarUsuario = #dsarw010#21;
     |QBF aVarUsuario;
     aVarPassword = #dsarw010#22;
     |QBF aVarPassword;

     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            aConten = aConten + aAlfa;

            |SI aAlfa = aCarac10;
                aAlfa1 = aConten - "/usr/bin/smtp-cli";
                |SI FSalida ! 0;
                     ||SMTPSERVPROPIO
                     |SI nSwSMTPServPropio = 1;
                         |SI aVarSMTP ! ""; |Y aVarUsuario ! ""; |Y aVarPassword ! "";
                              aAlfa2 = aAlfa1 - "--host=asmtp.diagram.es --user=control.smtp@diagram.es --pass=elpollogalactico \";
                              |SI FSalida ! 0;
                                   aAlfa1 = " --host=" + aVarSMTP + " --user=" + aVarUsuario + " --pass=" + aVarPassword + " \" + &10;
                              |FINSI;
                         |FINSI;
                     |FINSI;

                     aConten = aBaseMensaje + "smtp-cli" + aAlfa1;
                |FINSI;

                aAlfa1 = aConten - "DE=$1";
                |SI FSalida ! 0;
                    aConten = "DE=" + &34 + aFrom + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "$PARA";
                |SI FSalida ! 0;
                    |HAZ PonDirecciones;
                |FINSI;

                aAlfa1 = aConten - "ASUNTO=$3";
                |SI FSalida ! 0;
                    aConten = "ASUNTO=" + &34 + aAsunto + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICHTM=$4";
                |SI FSalida ! 0;
                    aConten = "FICHTM=" + &34 + aAbreHTMD + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICAT1=$5";
                |SI FSalida ! 0;
                    aConten = "FICAT1=" + &34 + aLogo + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICFIN=$6";
                |SI FSalida ! 0;
                    aConten = "FICFIN=" + &34 + aAbreFIN + &34 + &10;  |QBT aConten;
                |FINSI;

                aAlfa1 = aConten - "$ADJUNTO";
                |SI FSalida ! 0;
                    aConten = "";
                |FINSI;

                |XGRABA nHandle1, aConten;

                aConten = "";
            |FINSI;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;
     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     aEjecuta = "/bin/sh " + aAbreTXTD;

     |SYSTEM aEjecuta;

     |PARA;  |SI;  |HACIENDO;
          |XABRE "E", aAbreFIN, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |SLEEP 1;
          |PULSATECLA;
     |SIGUE;

     |FBORRA aAbreTXTD;
     |FBORRA aAbreHTMD;
     |FBORRA aAbreFIN;
|FPRC;

|PROCESO DsCorreo;
     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     aAbreTXT = aBaseMensaje + "adjunto.txt";
     |XABRE "WB", aAbreTXT, nHandle;

     |SI aNomGru ! "";
        aAlfa = aNomDes + &13 + &10;
        |XGRABA nHandle, aAlfa;

        aAlfa = &13 + &10;
        |XGRABA nHandle, aAlfa;

        aAlfa = aNomGru + " le agradece la confianza depositada en nosotros." + &13 + &10;
        |XGRABA nHandle, aAlfa;
     |SINO;
        aAlfa = aNomDes + " le agradece la confianza depositada en nosotros." + &13 + &10;
        |XGRABA nHandle, aAlfa;
     |FINSI;

     aAlfa = &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "Nos ponemos en contacto con Vd. para comunicarle su usuario";
     aAlfa = aAlfa + "de acceso a nuestra red para la empresa " + aNomEmp;
     aAlfa = aAlfa + ":" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = #dpntw001#9 + &13 + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "Pinche en " + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "http://www.geconet.net/portal/";
     aAlfa = aAlfa + "crearAcceso.php?claveGeconet=" + eaPassEnc;  |QBF aAlfa;

     eaPass = #dpntw001#9;  |HAZ EncriptaMAC;
     aAlfa  = aAlfa + "&email=" + eaPassEnc;  |QBF aAlfa;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;
     aAlfa =  "y siga los pasos para el registro de su usuario. ";
     |XGRABA nHandle, aAlfa;

     eaPass    = "";
     eaPassEnc = "";

     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "Para cualquier aclaración o duda, por favor, contacte con nosotros." + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;

     aAlfa = ("_" * 134) + &13 + &10;   |XGRABA nHandle, aAlfa;

     aAlfa =  "Este correo electrónico y, en su caso, cualquier fichero anexo al mismo, contiene";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "información de carácter confidencial exclusivamente dirigida a su destinatario o";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "destinatarios. Queda prohibida su divulgación, copia o distribución a terceros sin la";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa =  "previa autorización escrita de la empresa. En el caso de haber recibido este correo";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "electrónico por error, se ruega  notifíquese inmediatamente esta circunstancia mediante";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "reenvío a la dirección electrónica del remitente y proceda a su destrucción.";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;
     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;

     aAlfa = "El consumo de papel es perjudicial para el medio ambiente. Por favor téngalo en cuenta";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = "antes de imprimir este mensaje.";
     aAlfa = aAlfa + &10;  |XGRABA nHandle, aAlfa;

     aAlfa = ("_" * 134) + &13 + &10;   |XGRABA nHandle, aAlfa;

     aAlfa = &13 + &10;    |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;

     aIP      = #dsarw010#18;  |QBF aIP;
     aSalida  = #dsarw010#19;  |QBF aSalida;

     aMensaje = "$$$$" + aAbreTXT;

     |SI #dsarw010#20 = "N";
          aAutenti = aFrom;
     |SINO;
          aAutenti = #dsarw010#22;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + #dsarw010#21;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + aFrom;
     |FINSI;

     |SI #dsarw010#23 = "S";
          aAutenti = "!" + aAutenti;
     |FINSI;

     |DSCORREO_ENVIA aIP, aSalida, aAutenti, aTo, aAsunto, aMensaje, aAbreTXT;
     |SI FSalida < 0;
         |MENAV "0000 Ha habido un error durante el envio.";
     |FINSI;
|FPRC;

|PROCESO CorreoDSARCHI;
     |ABRE #dpntm000;
     |LEE 000#dpntm000.p;
     |CIERRA #dpntm000;

     eaAlfa  = #dpntm000#1;  |HAZ QuitaRaros;
     aNomDes = eaAlfa;  |QBF aNomDes;

     eaAlfa  = #dpntw001#16;  |HAZ QuitaRaros;
     aNomGru = eaAlfa;  |QBF aNomGru;

     eaAlfa  = #dpntw001#2;  |HAZ QuitaRaros;
     aNomEmp = eaAlfa;  |QBF aNomEmp;

     aTo = #dpntw001#9;  |QBF aTo;
     |SI aTo = "";  |ACABA;  |FINSI;

     aDirecOculta = #dpntw001#14; |QBF aDirecOculta;

     |VENTANA 1610, 2080, -1, 16, "Enviando correo de activaci¢n";
     nVentTrab = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802; |PAUSA;

     |DBASE aBaseMensaje;  |QBF aBase;

     aNLogo   = "logodespanet.jpg";
     aLogo    = aBaseMensaje + "logos/logodespanet.jpg";
     |XABRE "E", aLogo, nHandle;
     |SI FSalida < 0;
         aNLogo   = "logodespanet.bmp";
         aLogo    = aBaseMensaje + "logos/logodespanet.bmp";
         |XABRE "E", aLogo, nHandle;
         |SI FSalida < 0;
             aNLogo  = "";
             aLogo   = "";
         |FINSI;
     |FINSI;

     aBaseMensaje = aBaseMensaje + "dscorreo/";

     aFrom    = #dpntm000#2;  |QBT aFrom;
     aAsunto  = "Acceso para el uso de las aplicaciones DESPABOX";

     eaPrograma   = "DSCORREO";
     |HAZ DSARCHI_INI;
     nDsCorreo = enAprobacion;

     |SI nDsCorreo = 0;
          enAprobacion = 0;
          eaPrograma = "SMTPSERVPROPIO";
          |HAZ DSARCHI_INI;
          nSwSMTPServPropio = enAprobacion;

          |HAZ EjecutaShellCorreo;
     |SINO;
          |HAZ DsCorreo;
     |FINSI;

     |FBORRA aAbreTXT;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentTrab;
|FPRC;

|PROCESO EncriptaMAC;
     |QBF eaPass;
     aLong   = eaPass % 0;
     nLong   = aLong;
     eaPassEnc = "";
     |PARA nCaracter = 1; |SI nCaracter [ nLong; |HACIENDO nCaracter = nCaracter + 1;
           nPos   = (nCaracter * 100) + 1;
           aAlfa1 = eaPass % nPos;

           nCamuf = &aAlfa1;
           nCamuf = nCamuf * 2;

           nNum      = ((nCamuf - (nCamuf $ 26)) / 26 ) + 65;
           eaPassEnc = eaPassEnc + &nNum;

           nNum      = (nCamuf $ 26) + 65;
           eaPassEnc = eaPassEnc + &nNum;
     |SIGUE;
|FPRC;

|PROCESO CargaMac;
     |ABRE #dpntm000;
     |LEE 000#dpntm000.p;
     |CIERRA #dpntm000;

     aBase = #dpntm000#5;   |QBF aBase;
     |SI aBase = "";
         |DBASS aBase;  |QBF aBase;
     |FINSI;

     aAlfa     = aBase % -201;
     aServidor = aBase % -303;  |QBF aServidor;
     nNum      = aServidor;

     |SI nNum      = 0;   aServidor = "001";  |FINSI;
     |SI aServidor = "";  aServidor = "001";  |FINSI;

     eaPass = aAlfa + "0000" + aServidor + #dpntw001#1;
     |HAZ EncriptaMAC;
|FPRC;

|PROCESO Tipo12;  |TIPO 12;
     |SI FSalida = 7;  |ACABA;  |FINSI;

     |C_M #dpntw001#0, 0, aAlfa;
     |SI aAlfa = "N";  |ACABA;  |FINSI;

     aAlfa = #dpntw001#9;  |QBF aAlfa;
     |SI aAlfa = "";
         |MENAV "0000Por favor introduzca E_MAIL";
         |ERROR;
         |ACABA;
     |FINSI;

     FSalida = 0;
     |CONFI "0000SSon correctos los datos introducidos";
     |SI FSalida ! 0;
         |ERROR;
         |ACABA;
     |FINSI;

     |SI eaAcceso = "PIBOX";
         |ACABA;
     |FINSI;

     |SI #dpntw001#1 = "          ";
         #dpntw001#1 = ("00000" + #dpntw001#0) % -105;
     |FINSI;

     |HAZ CargaMac;

     |CONFI "0000SConforme con el env¡o del acceso";
     |SI FSalida = 0;
         |HAZ CorreoDSARCHI;
         |MENAV "0000Correo acceso enviado.";
     |FINSI;
|FPRC;

|PROCESO T6C15;   |TIPO 6;
     |ABRE #dpntm006;
     |SI #dpntw001#15 = 0;
         #dpntm006#0 = 0;
         |LEE 000#dpntm006.=;
         |SI FSalida ! 0;
             #dpntm006#0 = 0;
             #dpntm006#1 = "";
             |GRABA 020#dpntm006.n;
             |LIBERA #dpntm006;
         |FINSI;
     |FINSI;
     |CIERRA #dpntm006;
|FPRC;

|PROCESO Tipo66C0;   |TIPO 66;
     |DBASS aBase;
     aMas = aBase + "/integral/def/dsam0000.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida ] 0;
          |ABRE #dsam0000;
          |LEE 000#dsam0000.p;
          |CONSULTA_CLAVE #1#dsam0000;
          |SI FSalida = 0;
              #dpntw001#0  = #dsam0000#0;  |PINTA #dpntw001#0;
          |FINSI;
          |CIERRA #dsam0000;
     |SINO;
          |DBASS aBase;
          aMas = aBase + "/basica/def/agifigen.mas";
          |XABRE "E", aMas, nHandle;
          |SI FSalida ] 0;
              |ABRE #agifigen;
              |LEE 000#agifigen.p;
              |CONSULTA_CLAVE #1#agifigen;
              |SI FSalida = 0;
                  #dpntw001#0  = #agifigen#0;  |PINTA #dpntw001#0;
              |FINSI;
              |CIERRA #agifigen;
          |FINSI;
     |FINSI;

     enIdeCli = #dpntw001#0;
     |HAZ LeeCliente;
     |QBF eaMaiCli;

     #dpntw001#2  = eaNomCli;  |PINTA #dpntw001#2;
     #dpntw001#10 = eaNifCli;  |PINTA #dpntw001#10;

     |SI eaMaiCli ! "";
         #dpntw001#9  = eaMaiCli; |PINTA #dpntw001#9;
     |FINSI;
|FPRC;

|PROCESO AltaAdmin;
     enCreaAcceso = 0;

     #dpntm001#0 = #dpntw001#0;
     |LEE 000#dpntm001.=;
     |SI FSalida ! 0;
         enCreaAcceso = 1;
         |ACABA;
     |FINSI;

     |SELECT #2#dpntm005;
     #dpntm005#0 = #dpntw001#0;
     #dpntm005#2 = #dpntw001#9;
     |LEE 000#dpntm005.=;
     |SI FSalida = 0;
         aAlfa = "0000La empresa ya tiene el acceso " + #dpntw001#9;
         |QBF aAlfa;
         |MENAV aAlfa;

         enCreaAcceso = -1;
         |PTEC 807;
         |ACABA;
     |FINSI;

     aAlfa = "0000NLa empresa ya tiene un acceso creado, creamos uno nuevo con " + #dpntw001#9;
     |QBF aAlfa;
     |CONFI aAlfa;
     |SI FSalida ! 0;
         enCreaAcceso = -1;
         |PTEC 807;
         |ACABA;
     |FINSI;
|FPRC;

|PROCESO Tipo0C0;  |TIPO 0;
     enCreaAcceso = 0;

     |C_M #dpntw001#0, 0, aAlfa;
     |SI aAlfa = "N";  |ACABA;  |FINSI;

     |SI eaAdmin = "S";
         |HAZ AltaAdmin;
         |SI enCreaAcceso = -1;
             |SELECT #1#dpntm005;
             |ACABA;
         |FINSI;
     |SINO;
         #dpntm001#0 = #dpntw001#0;
         |LEE 000#dpntm001.=;
         |SI FSalida = 0;
             |MENAV "0000La empresa ya ha sido activada";
             |ERROR;
             |ACABA;
         |FINSI;
     |FINSI;

     |SELECT #1#dpntm005;

     enIdeCli = #dpntw001#0;
     |HAZ LeeCliente;
     |QBF eaMaiCli;

     |C_M #dpntw001#2,  1, "N";
     |C_M #dpntw001#10, 1, "N";

     |SI enIdeCli [ 0;
         |MENAV "0000No existe la empresa.";

         |ERROR;
         |ACABA;
     |FINSI;

     #dpntw001#2  = eaNomCli;  |PINTA #dpntw001#2;
     #dpntw001#10 = eaNifCli;  |PINTA #dpntw001#10;

     |SI eaAdmin ! "S";
         |SI eaMaiCli ! "";
             #dpntw001#9  = eaMaiCli; |PINTA #dpntw001#9;
         |FINSI;
    |SINO;
         |SI enCreaAcceso = 0;
             |PTEC 806;
         |FINSI;
    |FINSI;

     #dpntw001#1 = (("00000") + #dpntw001#0) % -105;
|FPRC;

|PROCESO dpntm002B;
     |BORRA 020#dpntm002.a;
     |LIBERA #dpntm002;
|FPRC;

|DEFBUCLE dpntm002B;
     #dpntm002#1;
     ;
     #dpntm001#0, 000, 000, 000;
     #dpntm001#0, 999, 999, 999;
     be;
     NULL, dpntm002B;
|FIN;

|PROCESO dpntm003B;
     |BORRA 020#dpntm003.a;
     |LIBERA #dpntm003;
|FPRC;

|DEFBUCLE dpntm003B;
     #dpntm003#1;
     ;
     #dpntm001#0, 000, 000, 000;
     #dpntm001#0, 999, 999, 999;
     be;
     NULL, dpntm003B;
|FIN;

|PROCESO dpntm004B;
     #nomw0003#0 = #dpntm004#0;
     #nomw0003#1 = #dpntm004#2;
     |LEE 101#nomw0003.=;
     |SI FSalida = 0;
         #nomw0003#142 = "N";

         |GRABA 020#nomw0003.a;
         |LIBERA #nomw0003;
     |FINSI;

     |BORRA 020#dpntm004.a;
     |LIBERA #dpntm004;
|FPRC;

|DEFBUCLE dpntm004B;
     #dpntm004#1;
     ;
     #dpntm001#0, "            ";
     #dpntm001#0, "zzzzzzzzzzzz";
     be;
     NULL, dpntm004B;
|FIN;

|PROCESO dpntm005B;
     |BORRA 020#dpntm005.a;
     |LIBERA #dpntm005;
|FPRC;

|DEFBUCLE dpntm005B;
     #dpntm005#1;
     ;
     #dpntm001#0, 001;
     #dpntm001#0, 999;
     be;
     NULL, dpntm005B;
|FIN;

|PROCESO GrabaCuerpo;
     aConten = "USUARIO REALIZACION: " + eaUsuNet + &13 + &10;
     |XGRABA nHandle, aConten;

     aConten = "CARPETA: " + eaBaseNet + &13 + &10;
     |XGRABA nHandle, aConten;

     eaAlfa  = #dpntm000#1;  |HAZ QuitaRaros;
     aConten = "DESPACHO: " + eaAlfa + &13 + &10;
     |XGRABA nHandle, aConten;

     aConten = "EMPRESA: " + eaEmpNet + &13 + &10;
     |XGRABA nHandle, aConten;

     |SI eaTraNet ! "";
         aConten = "ACCESO TRABAJADOR: " + eaTraNet + &13 + &10;
         |XGRABA nHandle, aConten;
     |FINSI;

     aConten = "CORREO ACCESO: " + eaAccNet + &13 + &10;
     |XGRABA nHandle, aConten;

     |SI eaDesNet = "S";
         aConten = "USUARIO DESPABOX" + &13 + &10;
         |XGRABA nHandle, aConten;
     |FINSI;

     |SI eaLabNet = "S";
         aConten = "USUARIO LABORBOX" + &13 + &10;
         |XGRABA nHandle, aConten;
     |FINSI;
|FPRC;

|PROCESO NotificaShell;
     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     |HAZ ParametrosSMTPCLI;

     |DBASE aBasePla;  |QBF aBasePla;
     aBasePlugins = aBasePla + "plugins/";

     aOrigenMd5 = aBasePlugins + "smtp-cli";
     aDestinoMd5 = aBaseMensaje + "smtp-cli";
     |HAZ CopiaConMd5;
     aEjecuta = "chmod +x " + aDestinoMd5;
     |SYSTEM aEjecuta;

     aAbreTXTO   = aBaseMensaje + "dsnotifi.sh";
     aAbreTXTD   = aBaseMensaje + "notifica" + eaUsuNet + ".sh";  |QBT aAbreTXTD;
     aAbreFIN    = aBaseMensaje + "notifica" + eaUsuNet + ".txt"; |QBT aAbreFIN;
     aAbreCuerpo = aBaseMensaje + "cuerpo" + eaUsuNet + ".txt";   |QBT aAbreCuerpo;

     |FBORRA aAbreTXTD;
     |FBORRA aAbreFIN;
     |FBORRA aAbreCuerpo;

     |ABRE #dpntm000;
     |LEE 000#dpntm000.p;
     |CIERRA #dpntm000;

     |XABRE "WB", aAbreCuerpo, nHandle;
     |HAZ GrabaCuerpo;
     |XCIERRA nHandle;

     |XABRE "WB", aAbreTXTD, nHandle1;
     |XABRE "AB", aAbreTXTO, nHandle2;

     aCarac10     = &10;
     aConten      = "";
     aVarSMTP     = #dsarw010#19;   |QBF aVarSMTP;
     aVarUsuario  = #dsarw010#21;   |QBF aVarUsuario;
     aVarPassword = #dsarw010#22;   |QBF aVarPassword;

     |XLEE nHandle2, 1, aAlfa;
     |PARA; |SI FSalida > 0; |HACIENDO;
            aConten = aConten + aAlfa;

            |SI aAlfa = aCarac10;
                aAlfa1 = aConten - "/usr/bin/smtp-cli";
                |SI FSalida ! 0;
                     ||SMTPSERVPROPIO
                     |SI nSwSMTPServPropio = 1;
                         |SI aVarSMTP ! ""; |Y aVarUsuario ! ""; |Y aVarPassword ! "";
                              aAlfa2 = aAlfa1 - "--host=asmtp.diagram.es --user=control.smtp@diagram.es --pass=elpollogalactico \";
                              |SI FSalida ! 0;
                                   aAlfa1 = " --host=" + aVarSMTP + " --user=" + aVarUsuario + " --pass=" + aVarPassword + " \" + &10;
                              |FINSI;
                         |FINSI;
                     |FINSI;

                     aConten = aBaseMensaje + "smtp-cli" + aAlfa1;
                |FINSI;

                aAlfa1 = aConten - "DE=$1";
                |SI FSalida ! 0;
                    aConten = "DE=" + &34 + aFrom + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "$PARA";
                |SI FSalida ! 0;
                    |HAZ PonDirecciones;
                |FINSI;

                aAlfa1 = aConten - "ASUNTO=$3";
                |SI FSalida ! 0;
                    aConten = "ASUNTO=" + &34 + aAsunto + &34 + &10;
                |FINSI;

                aAlfa1 = aConten - "FICFIN=$6";
                |SI FSalida ! 0;
                    aConten = "FICFIN=" + &34 + aAbreFIN + &34 + &10;  |QBT aConten;
                |FINSI;

                aAlfa1 = aConten - "CUERPO=$CUERPO";
                |SI FSalida ! 0;
                    aConten = "CUERPO=" + &34 + aAbreCuerpo + &34 + &10;  |QBT aConten;
                |FINSI;

                |XGRABA nHandle1, aConten;

                aConten = "";
            |FINSI;

            |XLEE nHandle2, 1, aAlfa;
     |SIGUE;
     |XCIERRA nHandle1;
     |XCIERRA nHandle2;

     aEjecuta = "/bin/sh " + aAbreTXTD;

     |SYSTEM aEjecuta;

     |PARA;  |SI;  |HACIENDO;
          |XABRE "E", aAbreFIN, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |SLEEP 1;
          |PULSATECLA;
     |SIGUE;

     |FBORRA aAbreTXTD;
     |FBORRA aAbreCuerpo;
     |FBORRA aAbreFIN;
|FPRC;

|PROCESO NotificaDsCorreo;
     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     aAbreTXT = aBaseMensaje + "adjunto.txt";
     |XABRE "WB", aAbreTXT, nHandle;
     |HAZ GrabaCuerpo;
     |XCIERRA nHandle;

     aIP      = #dsarw010#18;  |QBF aIP;
     aSalida  = #dsarw010#19;  |QBF aSalida;

     aMensaje = "$$$$" + aAbreTXT;

     |SI #dsarw010#20 = "N";
          aAutenti = aFrom;
     |SINO;
          aAutenti = #dsarw010#22;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + #dsarw010#21;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + aFrom;
     |FINSI;

     |SI #dsarw010#23 = "S";
          aAutenti = "!" + aAutenti;
     |FINSI;

     |DSCORREO_ENVIA aIP, aSalida, aAutenti, aTo, aAsunto, aMensaje, aAbreTXT;
     |SI FSalida < 0;
         |MENAV "0000 Ha habido un error durante el envio.";
     |FINSI;
|FPRC;

|PROCESO EnviaNotificacion;
     |SI eaAcceso = "PIBOX";
         |ACABA;
     |FINSI;

     |ABRE #dpntm000;
     |LEE 000#dpntm000.p;
     |CIERRA #dpntm000;

     aBase = #dpntm000#5;   |QBF aBase;
     |SI aBase = "";
         |DBASS aBase;  |QBF aBase;
     |FINSI;

     eaBaseNet = aBase;

     ||aTo = "manolo@diagram.es";
     aTo = "alta.despabox@diagram.es";
     |QBF aTo;

     |VENTANA 1610, 2080, -1, 16, "Por favor Espere";
     nVentTrab = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802; |PAUSA;

     |DBASE aBaseMensaje;  |QBF aBase;
     aBaseMensaje = aBaseMensaje + "dscorreo/";
     aFrom   = "no_reply@diagram.es";  |QBF aFrom;
     aAsunto = "DESPABOX: " + eaModoNet + " (" + eaBaseNet + " - " + eaFechaNet + ")";

     eaPrograma   = "DSCORREO";
     |HAZ DSARCHI_INI;
     nDsCorreo = enAprobacion;

     |SI nDsCorreo = 0;
          enAprobacion = 0;
          eaPrograma = "SMTPSERVPROPIO";
          |HAZ DSARCHI_INI;
          nSwSMTPServPropio = enAprobacion;

          |HAZ NotificaShell;
     |SINO;
          |HAZ NotificaDsCorreo;
     |FINSI;

     |FBORRA aAbreTXT;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentTrab;
|FPRC;

|PROCESO Deshabilito;
     |ABRE #dsarz010;
     #dsarz010#0 = #dpntm001#1;
     |LEE 101#dsarz010.=;
     |SI FSalida = 0;
         |BORRA 020#dsarz010.a;
         |LIBERA #dsarz010;
     |FINSI;
     |CIERRA #dsarz010;

     |BUCLE dpntm002B;
     |BUCLE dpntm003B;

     |ABRE #nomw0003;
     |BUCLE dpntm004B;
     |CIERRA #nomw0003;

     |BUCLE dpntm005B;

     |SI eaAcceso = "PIBOX";
         |BORRA 020#dpntm001.a;
         |LIBERA #dpntm001;

         |ACABA;
     |FINSI;

     eaModoNet     = "Deshabilitar empresa";
     eaUsuNet      = Usuario % 810; |QBF eaUsuNet;
     fFecha        = ~;
     aFecha        = fFecha;
     eaFechaNet    = aFecha + " " + aHora;
     eaAccesoNet   = #dpntm001#1; |QBF eaAccesoNet;
     eaEmpNet      = ("00000" + #dpntm001#0) % -105;
     eaEmpNet      = eaEmpNet + " / " + #dpntm001#2;   |QBF eaEmpNet;
     eaEmpNet      = eaEmpNet + " / " + #dpntm001#10;  |QBF eaEmpNet;
     eaAccNet      = #dpntm001#9;                      |QBF eaAccNet;
     eaTraNet      = "";
     eaDesNet      = "";
     eaLabNet      = "";

     |HAZ EnviaNotificacion;

     |BORRA 020#dpntm001.a;
     |LIBERA #dpntm001;
|FPRC;

|PROCESO Deshabilitar;
     aAlfa = "0000NQuiere deshabilitar al usuario de " + eaAcceso;
     |CONFI aAlfa;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |HAZ Deshabilito;

     |REFRESCACONTROL enGrid;
     |FOCOTECLADO enGrid;
|FPRC;

|PROCESO Reenviar;
     |CONFI "0000SQuiere reenviar el correo de activaci¢n";
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |DDEFECTO #dpntw001;
     #dpntw001#0  = #dpntm001#0;
     #dpntw001#1  = #dpntm001#1;
     #dpntw001#2  = #dpntm001#2;
     #dpntw001#3  = #dpntm001#3;
     #dpntw001#4  = #dpntm001#4;
     #dpntw001#5  = #dpntm001#5;
     #dpntw001#6  = #dpntm001#6;
     #dpntw001#7  = #dpntm001#7;
     #dpntw001#8  = #dpntm001#8;
     #dpntw001#9  = #dpntm001#9;
     #dpntw001#10 = #dpntm001#10;
     #dpntw001#11 = #dpntm001#11;
     #dpntw001#12 = #dpntm001#12;
     #dpntw001#14 = #dpntm001#14;
     #dpntw001#15 = #dpntm001#15;
     #dpntw001#16 = #dpntm001#16;

     |SI #dpntw001#1 = "          ";
         #dpntw001#1 = ("00000" + #dpntw001#0) % -105;
     |FINSI;

     |HAZ CargaMac;
     |HAZ CorreoDSARCHI;
     |MENAV "0000Correo acceso reenviado.";
|FPRC;

|PROCESO EnvioCorreoActiva;
     aEmail = #dpntm004#4;
     |QBF aEmail;

     |SI aEmail = "";
          |ACABA;
     |FINSI;

     |DDEFECTO #dpntw001;
     #dpntw001#0  = #dpntm001#0;
     #dpntw001#1  = #dpntm004#8;
     #dpntw001#2  = #dpntm004#3;
     #dpntw001#3  = "";
     #dpntw001#4  = #dpntm001#4;
     #dpntw001#5  = #dpntm001#5;
     #dpntw001#6  = #dpntm001#6;
     #dpntw001#7  = #dpntm001#7;
     #dpntw001#8  = "password";
     #dpntw001#9  = aEmail;
     #dpntw001#10 = #dpntm004#1;
     #dpntw001#11 = "N";
     #dpntw001#12 = "S";
     #dpntw001#14 = #dpntm001#14;
     #dpntw001#15 = #dpntm001#15;
     #dpntw001#16 = #dpntm001#16;

     |SI #dpntw001#1 = "          ";
         #dpntw001#1 = (("00000" + #dpntw001#0) % -105) + (("00000" + #dpntm004#2) % -105);
     |FINSI;

     |HAZ CargaMac;
     |HAZ CorreoDSARCHI;

     |SI #dpntm004#7 = "01.01.0000";
         |HORA aHora;

         eaModoNet     = "Habilitar nuevo acceso trabajador en empresa";
         eaUsuNet      = Usuario % 810; |QBF eaUsuNet;
         fFecha        = ~;
         aFecha        = fFecha;
         eaFechaNet    = aFecha + " " + aHora;
         eaAccesoNet   = #dpntm001#1; |QBF eaAccesoNet;
         eaEmpNet      = ("00000" + #dpntm001#0) % -105;
         eaEmpNet      = eaEmpNet + " / " + #dpntm001#2;   |QBF eaEmpNet;
         eaEmpNet      = eaEmpNet + " / " + #dpntm001#10;  |QBF eaEmpNet;
         eaTraNet      = ("00000" + #dpntm004#2) % -105;
         eaTraNet      = eaTraNet + " / " + #dpntm004#3;   |QBF eaTraNet;
         eaAccNet      = #dpntm004#4;                      |QBF eaAccNet;
         eaDesNet      = "";
         eaLabNet      = "";

         |HAZ EnviaNotificacion;
     |FINSI;
|FPRC;

|PROCESO CopiaConMd5;
     aContiene1 = aOrigenMd5;
     |ESPECIFICA "MD5", aContiene;
     aVersion1  = FSalida;  |QBF aVersion1;

     aContiene1 = aDestinoMd5;
     |ESPECIFICA "MD5", aContiene;
     aVersion2  = FSalida;  |QBF aVersion2;

     |SI aVersion1 ! aVersion2;
          |COPIA_FICHERO aOrigenMd5, aDestinoMd5;
     |FINSI;
|FPRC;

|PROCESO EnviaAcceso;
     aEmail = #dpntm005#2;   |QBF aEmail;

     |SI aEmail = "";  |ACABA;  |FINSI;

     |DDEFECTO #dpntw001;
     #dpntw001#0  = #dpntm001#0;
     #dpntw001#1  = #dpntm001#1;
     #dpntw001#2  = #dpntm001#2;
     #dpntw001#9  = aEmail;
     #dpntw001#10 = #dpntm001#10;
     #dpntw001#11 = "N";
     #dpntw001#12 = "S";
     #dpntw001#14 = #dpntm005#3;
     #dpntw001#15 = #dpntm001#15;
     #dpntw001#16 = #dpntm001#16;

     |HAZ CargaMac;
     |HAZ CorreoDSARCHI;
     |MENAV "0000Correo acceso enviado.";
|FPRC;

|PROCESO NuevoAcceso;
     |VENTANA 0501, 1680, -1, 16, "Nuevo Acceso";
     nVentTrab = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |DDEFECTO #dpntw005;

     enModo = 1;
     |PINPA #0#dpntw005;  nPanW5 = FSalida;

     |SI eaAcceso = "PIBOX";
         |C_V #dpntw005#2, 1, "N";  |C_M #dpntw005#2, 1, "N";
         |C_V #dpntw005#3, 1, "N";  |C_M #dpntw005#3, 1, "N";
         |C_V #dpntw005#4, 1, "N";  |C_M #dpntw005#4, 1, "N";
         |C_V #dpntw005#5, 1, "N";  |C_M #dpntw005#5, 1, "N";

         |CONTROL_SIMPLE nPanW5, "LABEL,{{11}}            ", 0902, 1573, NULL;
     |FINSI;

     |PINDA #0#dpntw005;
     |ENDATOS #2#dpntw005;
     |SI FSalida = 0;
         |CONFI "0000SConforme con el acceso";
         |SI FSalida = 0;
             #dpntm005#0 = #dpntm001#0;
             #dpntm005#1 = 999;
             |LEE 000#dpntm005.];
             |SI FSalida = 0;
                 |LEE 000#dpntm005.a;
             |SINO;
                 |LEE 000#dpntm005.u;
             |FINSI;

             nIde = 1;
             |SI FSalida = 0;  |Y #dpntm005#0 = #dpntm001#0;
                 nIde = #dpntm005#1 + 1;
             |FINSI;

             #dpntm005#0 = #dpntm001#0;
             #dpntm005#1 = nIde;
             #dpntm005#2 = #dpntw005#0;
             #dpntm005#3 = #dpntw005#2;
             #dpntm005#4 = #dpntw005#3;
             #dpntm005#5 = #dpntw005#4;
             #dpntm005#6 = #dpntw005#5;

             |GRABA 020#dpntm005.n;
             |LIBERA #dpntm005;

             |SI eaAcceso ! "PIBOX";
                 |HAZ EnviaAcceso;

                 |HORA aHora;

                 eaModoNet     = "Habilitar nuevo acceso en empresa";
                 eaUsuNet      = Usuario % 810; |QBF eaUsuNet;
                 fFecha        = ~;
                 aFecha        = fFecha;
                 eaFechaNet    = aFecha + " " + aHora;
                 eaAccesoNet   = #dpntm001#1; |QBF eaAccesoNet;
                 eaEmpNet      = ("00000" + #dpntm001#0) % -105;
                 eaEmpNet      = eaEmpNet + " / " + #dpntm001#2;   |QBF eaEmpNet;
                 eaEmpNet      = eaEmpNet + " / " + #dpntm001#10;  |QBF eaEmpNet;
                 eaAccNet      = ("000" + #dpntm005#1) % -103;
                 eaAccNet      = eaAccNet + " / " + #dpntm005#2;   |QBF eaAccNet;
                 eaTraNet      = "";
                 eaDesNet      = #dpntm005#5;
                 eaLabNet      = #dpntm005#6;

                 |HAZ EnviaNotificacion;
             |FINSI;
         |FINSI;
     |FINSI;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentTrab;

     |REFRESCACONTROL enGrid5;
     |FOCOTECLADO enGrid5;
|FPRC;

|PROCESO ModificarDatos;
     |VENTANA 0501, 1680, -1, 16, "Modificar datos";
     nVentTrab = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;  |PAUSA;

     |DDEFECTO #dpntw005;
     #dpntw005#0 = #dpntm005#2;
     #dpntw005#2 = #dpntm005#3;
     #dpntw005#3 = #dpntm005#4;
     #dpntw005#4 = #dpntm005#5;
     #dpntw005#5 = #dpntm005#6;

     enModo = 2;

     |PINPA #0#dpntw005;  nPanW5 = FSalida;

     |SI eaAcceso = "PIBOX";
         |C_V #dpntw005#2, 1, "N";  |C_M #dpntw005#2, 1, "N";
         |C_V #dpntw005#3, 1, "N";  |C_M #dpntw005#3, 1, "N";
         |C_V #dpntw005#4, 1, "N";  |C_M #dpntw005#4, 1, "N";
         |C_V #dpntw005#5, 1, "N";  |C_M #dpntw005#5, 1, "N";

         |CONTROL_SIMPLE nPanW5, "LABEL,{{11}}            ", 0902, 1573, NULL;
     |FINSI;

     |PINDA #0#dpntw005;
     |ENDATOS #2#dpntw005;
     |SI FSalida = 0;
         |LEE 101#dpntm005.=;
         |SI FSalida = 0;
             #dpntm005#2 = #dpntw005#0;
             #dpntm005#3 = #dpntw005#2;
             #dpntm005#4 = #dpntw005#3;
             #dpntm005#5 = #dpntw005#4;
             #dpntm005#6 = #dpntw005#5;
             |GRABA 020#dpntm005.a;
             |LIBERA #dpntm005;

             |SI #dpntm005#1 = 1;
                 #dpntm001#0 = #dpntm005#0;
                 |LEE 101#dpntm001.=;
                 |SI FSalida = 0;
                     #dpntm001#9  = #dpntm005#2;
                     #dpntm001#14 = #dpntm005#3;
                     |GRABA 020#dpntm001.a;
                     |LIBERA #dpntm001;
                 |FINSI;
             |FINSI;

             |SI eaAcceso ! "PIBOX";
                 |CONFI "0000SReenviar acceso";
                 |SI FSalida = 0;
                     |HAZ EnviaAcceso;
                 |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentTrab;

     |REFRESCACONTROL enGrid5;
     |FOCOTECLADO enGrid5;
|FPRC;
