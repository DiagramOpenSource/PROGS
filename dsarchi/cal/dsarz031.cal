|FICHEROS;
     dsarz031 #0;
     dsarm001 #13;  || Param

     dsarw043 #100; || tmp. para comprobar si hay mas en marcha
|FIN;

|VARIABLES;
     &eaFicLogVisor = "";
     &eaPathLogVisor = "";
     &eaNomLogVisor = "";
     &eaDesLogVisor = "";

     aPathLog = "";
     aFicLog = "";
     fFecha = @;
     nHandle2 = 0;
     nSalir = 0;
     nSegu2 = 0;
     nFaltan = 0;
     nSwSal = 0;
     aLaHora = "";
     aTxtLog = "";

     nBucle = 0;
     nBoton = 0;
     nPanta = 0;
     aMensaje = "";
     nErrLog = 0;
     aMenLog = "";
     aCenError = "";
     aHoraUno = "";
     fFechaUno = @;
     nFechaUno = 0;
     aFechaUno = "";
     aHoraDos = "";
     nFechaDos = 0;
     aFechaDos = "";
     FINAL     = "";
     FIN      = "";
     aMensa    = "";
     aparam    = "";
     aFecha    = "";
     aFin      = "";
     aAnt      = "";
     aPath     = "";
     aPathHis  = "";
     aAlfa     = "";
     aHora     = "";
     aTecla    = "";
     aFichero  = "";
     aDes      = "";
     aOri      = "";
     aFic      = "";
     aLon      = "";
     aLetra    = "";
     aCentro   = "";
     aGestor   = "";
     aCab1     = "";
     aCab2     = "";
     aCab3     = "";
     aCab4     = "";
     aLin1     = "";
     aLin2     = "";
     aLin3     = "";
     aBarra    = "";
     i         = 0;
     nBytes    = 0;
     nOrden    = 0;
     nLineas   = 0;
     nPorcien  = 0;
     nEspera   = 0;
     nMinu     = 0;
     nNume     = 0;
     nHora     = 0;
     nSegu     = 0;
     nSegAnt   = 0;
     nConta    = 0;
     nPos      = 0;
     nHandle   = 0;
     nError    = 0;
     nAviso    = 0;
     nCen      = 0;
     nGes      = 0;
     nCab      = 0;
     nLin      = 0;
     nContaCen = 0;
     nContaGes = 0;
     nContaCab = 0;
     nContaLin = 0;
     nEstado   = 0;

     aDSCorreo = "";
     aProxy    = "";
     aDirOri   = "";
     aDirDes   = "";
     aTitulo   = "";
     aTexto    = "";
     aAlfa1    = "";
     aAlfa2    = "";
     aAlfa3    = "";
     aAlfa4    = "";
     nNume1    = 0;
     nNume2    = 0;
     nNume3    = 0;
     nNume4    = 0;

     &enSoyDESPANET = 0;
|FIN;



|PROCESO Tipo80; |TIPO 80;
     FSalida = 2499;
|FPRC;


-------------------------------------------------------------------------
|PROCESO Segundos;
     |HORA aHora;
     aAlfa = aHora % 702;
     nSegu = aAlfa;
     |SI nSegAnt ! nSegu;
          nPorcien = nConta * 100 / nEspera;
          nPorcien = 60 - (nPorcien * 60 / 100);
          aBarra = "Þ" * nPorcien;
          aBarra = aBarra + ( " " * 60);
          aBarra = aBarra % 160;
          |ATRI I; |PINTA 1211, aBarra; |ATRI 0;
          nSegAnt = nSegu;
/*
          |PINTA 1511, "          ";
          |SI nConta > 0;
               |PINTA 1511, nConta;
          |FINSI;
*/

          #0#0 = nConta;
          |PINTA #0#0;
          nConta = nConta - 1;

     |FINSI;
|FPRC;

|PROCESO Boton;
     nSalir = 1;
|FPRC;

|PROGRAMA;
     |HAZ SoyDESPANET;
     |SI enSoyDESPANET = 1;  |ACABA;  |FINSI;

     |DBASE aPathLog;
     |QBF aPathLog;
     aPathLog = aPathLog + "logs/";
     |MKDIR aPathLog;
     aFicLog = aPathLog + "com_auto.log";

     eaPathLogVisor = aPathLog + "logs/";
     eaNomLogVisor = "com_auto.log";
     eaFicLogVisor = aFicLog;
     eaDesLogVisor = "Logs Comunicaciones automaticas. (dsarz031)";
     |HAZ MeteVisorLog;

     |XABRE "A", aFicLog, nHandle2;
     |SI FSalida < 0;
          aMensaje = "0000Problema al abrir " + aFicLog;
          |MENAV aMensaje;
     |FINSI;

     fFecha = ~;
     aFecha = fFecha;
     |HORA aLaHora;
     aTxtLog = aFecha + " " + aLaHora + " " + "Inicio Comunicaciones Automaticas";
     |XGRABA nHandle2, aTxtLog;


     aparam = PARAMETRO; |QBF aparam;
     FINAL = &13 + &10;
     FIN = &13;

     |CLS;
     |CABEZA "Comun.Automatica";
     |ABRE #0;
     |PINPA #0#0;
     nPanta = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,{{001}}Salir", 2484, 2498, Boton;
     nBoton = FSalida;

     |PINDA #0#0;

     |ABRE #100;
     |LEE 140#100p;
     |SI FSalida = 111;            || no existe
          |IP_REMOTO aMenLog;
          #100#0 = aMenLog;
          |GRABA 020#100b;
     |SINO;
          |SI FSalida = 0;         || existe sin bloqueo
               |IP_REMOTO aMenLog;
               #100#0 = aMenLog;
               |GRABA 020#100a;
          |SINO;
               |SI FSalida = 107;       || existe con bloqueo
                    |LEE 000#100p;
                    aMenLog = #100#0;
                    |QBF aMenLog;
                    aMenLog = "    Com.Automatica bloqueada por [" + aMenLog + "]";
                    |MENAV aMenLog;
                    |CIERRA #0;
                    |ACABA;
               |SINO;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI aparam ! "";
          #13#101 = aparam;
     |SINO;
          |ABRE #13; |LEE 000#13p; |CIERRA #13;
     |FINSI;

     nEspera = #13#101 * 60;

     nFaltan = nEspera;

     |PARA; |SI;  |HACIENDO;
         |SI nSalir = 1;
               nSalir = 0;
               nSwSal = 1;
         |FINSI;

         |SI nSwSal = 0;
              |MENSA "2405                     ";
              |HAZ UnSegundo;
              nFaltan = nFaltan - 1;
              #0#1 = nFaltan;
              |PINTA #0#1;
              |SI nFaltan [ 0;
                    #0#1 = nFaltan;
                    |PINTA #0#1;
                    |HAZ UnSegundo;
                    |MENSA "2405Chequeando correo ...";

                    fFecha = ~;
                    aFecha = fFecha;
                    |HORA aLaHora;
                    aTxtLog = aFecha + " " + aLaHora + " " + "Ejecutando Recepcion de Correos";
                    |XGRABA nHandle2, aTxtLog;

                    |SUB_EJECUTA_NP "dsarz009";

                    ||HAZ EL LOG
||                  |HAZ EnviaMonitor;

                    nFaltan = nEspera;
              |FINSI;
         |FINSI;

         |SI nSwSal = 1;
               aMensaje = "0000NDesea Finalizar el Proceso?";
               |CONFI aMensaje;
               |SI FSalida = 0
                    |SAL;
               |FINSI;
               nSwSal = 0;
         |FINSI;

     |SIGUE;

     fFecha = ~;
     aFecha = fFecha;
     |HORA aLaHora;
     aTxtLog = aFecha + " " + aLaHora + " " + "Final Comunicaciones Automaticas";
     |XGRABA nHandle2, aTxtLog;

     |XCIERRA nHandle2;

     |BORRA 020#100a;
     |LIBERA #100;
     |CIERRA #100;
     |CIERRA #0;
|FPRO;

|PROCESO UnSegundo;
     |HORA aHora;
     aAlfa = aHora % 702;
     nSegu = aAlfa;

     |PARA; |SI; |HACIENDO;
          |PULSATECLA;
          |HORA aHora;
          aAlfa = aHora % 702;
          nSegu2 = aAlfa;
          |SI nSegu ! nSegu2;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;


/*

     ||ESTO NO SE USA.
____________________________________/ CORREO MONITOR.EXE
|PROCESO FicheroMonitor;
     aAlfa = "/tmp/monitor.spo";
     |XABRE "W", aAlfa, nHandle;
     |SI FSalida ! 0;
          nErrLog = 0;
          aMenLog = "    No se pudo crear [" + aAlfa + "].";
          |HAZ Log;
     |SINO;
          aAlfa = "<Fichero de uso reservado>";
          |XGRABA nHandle, aAlfa;
          |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROCESO EnviaMonitor;
     || aDSCorreo = Direccion IP de la maquina donde esta el DSCORREO
     || aProxy    = Direccion IP del proxy, si no hay la misma
     || aDirOri   = Direccion e-mail origen
     || aDirDes   = Direccion e-mail destino
     || aTitulo   = Titulo del mensaje
     || aTexto    = Cuerpo del mensaje
     || aFic      = Nombre del fichero

     |SI #13#38 = "N";
          ||No esta activo el envio a esta cuenta
          |ACABA;
     |FINSI;

     |ABRE #12;
     #12#0 = #13#1;
     |LEE 000#12=;
     |SI FSalida ! 0;
          aMenLog = "    Codigo de origen [" + #12#0 + "] no definido ...";
          nErrLog = 1;
          |HAZ Log;
          |CIERRA #12;
          |ACABA;
     |SINO;
          aDirOri = #12#4;    |QBF aDirOri;
     |FINSI;
     |CIERRA #12;

     |ABRE #12;
     #12#0 = #13#29;
     |LEE 000#12=;
     |SI FSalida ! 0;
          aMenLog = "    Codigo de destino [" + #12#0 + "] no definido ...";
          nErrLog = 1;
          |HAZ Log;
          |CIERRA #12;
          |ACABA;
     |SINO;
          aDirDes = #12#4;    |QBF aDirDes;
     |FINSI;
     |CIERRA #12;

     |SI #13#27 = "F";
          aDSCorreo = #13#7;  |QBF aDSCorreo;
     |SINO;
          |SI #13#27 = "L";   |IP_REMOTO aDSCorreo;    |FINSI;
          |SI #13#27 = "S";   |IP_LOCAL aDSCorreo;     |FINSI;
     |FINSI;
     aProxy = #13#12;         |QBF aProxy;
     aTitulo = "DSCorreo Control";
     aTexto = "DSCorreo Control";
     |HAZ FicheroMonitor;
     aFic = "/tmp/monitor.spo";

     |SI aDirDes = "";
          nError = -100;
          |ACABA;
     |FINSI;

     ||ESTO ESTA DESACTIVADO.

     aAlfa = "0000Enviando a MONITOR [" + aDSCorreo + "] ...";
     |MENSA aAlfa;
     |DSCORREO_ENVIA aDSCorreo, aProxy, aDirOri, aDirDes, aTitulo, aTexto, aFic;
     nError = FSalida;
     |BLIN 4;
     |SI nError < 0;
          nErrLog = 0;
          aMenLog = "    Problemas al enviar correo ..." + nError;
          |HAZ Log;
          aMenLog = aDSCorreo+","+aProxy+","+aDirOri+","+aDirDes+","+aTitulo+","+aFic;
          |HAZ Log;
     |FINSI;
     |SI nError ] 0;
          nErrLog = 0;
          aMenLog = "    Correo MON[" + aTitulo + "][" + aDirDes + "] enviado.";
          |HAZ Log;
     |FINSI;
|FPRC;
*/
