||SQL -->  mini_sql.txt

||"GETDATACONTROL" .. para que pille los datos al pulsar el boton

|FICHEROS;
     gestempo #0;

     referen@ #999;
     dsarm001 #1;
     dsarm046 #46;
     dsarm002 #2;
     dsarm003 #3;
     dsarm004 #4;

     dsarcl01 #901;      ||Historiales  CLINICA
     dsarcl02 #902;      ||Episodios    CLINICA

     dsarclw1 #501,MANTE;      ||Busqueda Clinica
     dsarclw2 #502,MANTE;      ||Aux. Existen Doc His
     dsarcl01@ #601;     ||Resultado SQL.  (LINEAL 1)

     dsarm005 #5;

     otrodef@ #55;
     flowm006 #506;
     dsarw008 #908;           ||Pantalla Abriendo documento
|FIN;

|VARIABLES;
     ||Nuevo Buscado de David.
     aNombreB = "";
     aTab = "";
     aReturnUnix = "";
     aApell1 = "";
     aApell2 = "";
     nContador = 0;
     aTextAux = "";
     nVoy = 0;
     aLetra = "";
     nLong = 0;

     aTexto = "";
     nHandlePara = 0;
     nHandleErr = 0;
     nHandleRes = 0;
     aPassword = "";
     aUsuNum = "";
     aNombrePara = "";
     aFicheroPara = "";
     aFicheroErr = "";
     aFicheroRes = "";

     ||Control Historias con Documentos ya introducidos
     &enErrorHisYaIntro = 0;
     &enRegASustituir = 0;
     aEsc1          = "";
     aEsc2          = "";
     aRetu          = "";
     aTecla         = "";
     nBotonHis1 = 0;
     nBotonHis2 = 0;
     nBotonHis3 = 0;
     nGrid55 = 0;
     nModoHis = 0;
     aPathBase = "";
     &eaDestino = "";
     &eaOrigen = "";
     &eaUnidad = "";
     aExtension = "";
     aFichero = "";
     aAlfa1 = "";
     aNomDoc = "";
     aFicheroVer = "";
     aUsuario = "";
     nLinea = 0;
     nSitu = 0;
     aDocHis = "";
     &enNumRegFlow = 0;
     &enSituFlow = 0;
     &eaDesSituFlow = 0;
     aEjecuta = "";
     nPausa = 0;
     nVentz1 = 0;
     aIPRemoto = "";

     nSwHayDocs = 0;
     aVinculo = "";
     aTempo55 = "";
     aLabel = "";
     aDesGST = "";


     aNomFicheroAux = "";
     &enError = 0;
     nModoAsistente = 0;
     &eaAlfa = "";
     aEpisodioUnico = "";
     nNumEpisodios = 0;
     nHistoria601 = 0;
     aHistoriaUnica = "";
     nNumHistorias = 0;

     nEpiAux = 0;

     nDimeHistoria = 0;
     &enSwVinExteEspecial = 0;          ||Vinculo Especial ("E") solo Historias en la Clinica
     &enSwSinVinculos = 0;

     nBotonSinHisEpi = 0;
     nDesdeHis = 0;
     nHastaHis = 0;

     nGrid2 = 0;
     nCamposAux = 0;
     {-1}get = 0;
     get1 = 0;
     get2 = 0;

     nVentTrab = 0;

     aDni = "";
     aSSSS = "";
     aCIP = "";
     aApellido1 = "";
     aApellido2 = "";
     aFecNac = "";
     aHombre = "";
     aMujer = "";
     aTelefono = "";
     aCampoHis = "";
     aCampoEpi = "";
     aCampoNom = "";
     nCampoEpi = 0;
     nCampoHis = 0;

     aAux = "";
     nSwHayCampo = 0;

     nGrid601 = 0;
     nHandle = 0;
     aSQL = "";
     aFichSQL = "";
     aFicheroSql = "";

     nRango = 0;
     nPos1 = 0;
     nPos2 = 0;

     aDef = "";
     aTempo601 = "";

     {-1}aVent       = "";
         aVent1      = 0;
         aVent2      = 0;
         aVent3      = 0;
         aVent4      = 0;
         aVent5      = "";

     nVentana = 0;

     nBotonBus = 0;
     nBotonBorraBus = 0;
     nPanta = 0;

     aNombre = "";
     aLong = "";
     nLong1 = 0;
     aHistoria = "";
     nLong2 = 0;
     nLongTotal = 0;
     nDif = 0;
     nSaca = 0;
     aSaca = "";

     ||Clinica
     nHistoria = 0;

     ||Control de Vinculos Externos.
     &enSwErrorVinExte = 0;
     &enNumRegVincuExte = 0;
     &enSwVinculosExternos = 0;
     &eaTipoVinculo = "";
     &eaValorVinculo1 = "";
     &eaValorVinculo2 = "";
     &eaValorVinculoAux = "";
     &eaPosicionateVinculo1 = "";
     &eaPosicionateVinculo2 = "";
     &enGrupoVinExte = 0;
     &enSubGrupoVinExte = 0;
     &enTipoVinExte = 0;

     aBase = "";
     aPathDef = "";
     aPathDatos = "";
     aNomDef = "";
     nEmpresa = 0;
     aMensaje = "";

     aUsura = "";
     nTempo = 0;
     &Tempo = "";
     aMensa = "";
     aAlfa  = "";
     aHora  = "";
     aProgr = "";
|FIN;

|PROCESO dsarcl02_episodios;
     nNumEpisodios = nNumEpisodios + 1;
     aEpisodioUnico = #dsarcl02#1;
|FPRC;

|DEFBUCLE dsarcl02_episodios;
 #dsarcl02#1;
 ;
 nHistoria601,         0;
 nHistoria601, 999999999;
 ;
 NULL, dsarcl02_episodios;
|FIN;

|PROCESO historias601;
     nNumHistorias = nNumHistorias + 1;
     aHistoriaUnica = #601#0;
|FPRC;

|DEFBUCLE historias601;
 #601#1001;
 ;
       0;
 9999999;
 ;
 NULL, historias601;
|FIN;

|PROCESO Tipo12_w1; |TIPO 12;
     ||Aqui ya no entra.  Lo hacemos desde el programa de David
     ||y luego ejecuto PseudoTipo12

     |SI FSalida = 7;
          |SI nModoAsistente = 1;
               enError = 1;
          |FINSI;
          |ACABA;
     |FINSI;

     |SI enSwVinExteEspecial = 1;
          eaValorVinculo2 = "";
     |FINSI;

     |SI eaValorVinculo1 = "";
          aHistoriaUnica = "";
          nNumHistorias = 0;
          |BUCLE historias601;
          |SI nNumHistorias = 1;
               eaValorVinculo1 = aHistoriaUnica;
               |QBF eaValorVinculo1;
          |FINSI;
     |FINSI;

     |SI eaValorVinculo1 ! ""; |Y enSwVinExteEspecial = 0;
          aEpisodioUnico = "";
          nNumEpisodios = 0;
          nHistoria601 = eaValorVinculo1;
          |BUCLE dsarcl02_episodios;
          |SI nNumEpisodios = 1;
               eaValorVinculo2 = aEpisodioUnico
               |QBF eaValorVinculo2;
          |FINSI;
     |FINSI;

     |SI eaValorVinculoAux = "";
          |SI eaValorVinculo1 ! "";
               |ABRE #dsarcl01;
               |SELECT #1#dsarcl01;
               #dsarcl01#0 = eaValorVinculo1;
               |LEE 000#dsarcl01.=;
               |SI FSalida = 0;
                    aNombre = #dsarcl01#1;
                    |QBF aNombre;
                    aNombre = aNombre + " " + #dsarcl01#2;
                    |QBF aNombre;
                    aNombre = aNombre + " " + #dsarcl01#3;
                    |QBF aNombre;
                    aLong = aNombre % A0;
                    nLong1 = aLong;

                    aHistoria = #dsarcl01#0;
                    |QBF aHistoria;
                    aLong = aHistoria % A0;
                    nLong2 = aLong;

                    nLongTotal = nLong1 + nLong2 + 1;
                    |SI nLongTotal [ 50;
                         eaValorVinculoAux = aNombre + " " + aHistoria;
                         |QBF eaValorVinculoAux;
                    |SINO;
                         nDif = 50 - nLong2;
                         nSaca = 100 + nDif;
                         aSaca = aNombre % aSaca;
                         aNombre = aSaca;
                         eaValorVinculoAux = aNombre + aHistoria;
                         |QBF eaValorVinculoAux;
                    |FINSI;
               |FINSI;
               |CIERRA #dsarcl01;
          |FINSI;
     |FINSI;

     |SI nModoAsistente = 1;
          |SI eaValorVinculo1 = "";
               enError = 1;
               aMensaje = "0000Seleccione primero la historia (Doble Click)";
               |MENAV aMensaje;
               |ERROR;
          |SINO;
               aAux = (eaValorVinculo1 + "                              ") % 130;
               enError = 0;
               |ABRE #dsarm005;
               aNomFicheroAux = ("01" + Usuario + "zzzzzzzz") % 108;
               aSQL = "SELECT * FROM dsarm005 INTO " + aNomFicheroAux + " WHERE 97 = " + "'" + aAux + "'";
               |SQL aSQL;
               |CIERRA #dsarm005;
               ||Creo el temporal del dsarm005 a devolver con los documentos
               ||que sean de la historia seleccionada.
               ||Lo puedo crear con la |SQL .. creo que lento
               ||o con un BUCLE, tb. sera lento.
          |FINSI;
     |SINO;
          |SI eaValorVinculo1 = "";
               |SI eaValorVinculo2 = ""; |Y enSwVinExteEspecial = 0;
                    aMensaje = "0000Seleccione primero la historia y el episodio (Doble Click)";
               |SINO;
                    aMensaje = "0000Seleccione primero la historia (Doble Click)";
               |FINSI;
               |MENAV aMensaje;
               |ERROR;
          |SINO;
               |SI eaValorVinculo2 = ""; |Y enSwVinExteEspecial = 0;
                    aMensaje = "0000Seleccione primero el episodio (Doble Click)";
                    |MENAV aMensaje;
                    |ERROR;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO CreaTempo;
     |MODULO aProgr;
     aUsura = Usuario % 810;
     |ABRE #0;
     |LEE 000#0u;
     |SI FSalida = 0;
          nTempo = #0#0 + 1;
     |SINO;
          nTempo = 1;
     |FINSI;

     |PARA; |SI; |HACIENDO;
          #0#0 = nTempo;
          |LEE 000#0=;
          |SI FSalida ! 0;  |SAL;  |FINSI;

          nTempo = nTempo + 1;

          |SI nTempo > 99999999;  nTempo = 1;  |FINSI;
     |SIGUE;

     |HORA aHora;

     #0#1 = aUsura;
     #0#2 = aProgr;
     #0#3 = ~;
     #0#4 = aHora;
     |GRABA 020#0n;

     |LIBERA #0;
     |CIERRA #0;

     Tempo = ("00000000" + nTempo) % -108;
|FPRC;

|PROCESO BoraTempo;
     |ABRE #0;
     nTempo = Tempo;
     #0#0 = nTempo;
     |BORRA 000#0c;
     |CIERRA #0;
|FPRC;

|PROCESO DimeTipoVinculo;
     enSwVinculosExternos = 0;
     eaTipoVinculo = "";

     |ABRE #dsarm001;
     |DDEFECTO #dsarm001;
     |LEE 000#dsarm001.p;
     |SI FSalida = 0;
          |SI #dsarm001#186 = "S";
               |ABRE #dsarm004;
               |DDEFECTO #dsarm004;
               #dsarm004#0 = enGrupoVinExte;
               #dsarm004#1 = enSubGrupoVinExte;
               #dsarm004#2 = enTipoVinExte;
               |LEE 000#dsarm004.=;
               |CIERRA #dsarm004;

               |SI #dsarm004#86 = "S";
                    enSwVinculosExternos = 1;
                    eaTipoVinculo = "TALLER";
               |FINSI;
          |SINO;
               |SI #dsarm001#194 = "S";
                    |ABRE #dsarm004;
                    |DDEFECTO #dsarm004;
                    #dsarm004#0 = enGrupoVinExte;
                    #dsarm004#1 = enSubGrupoVinExte;
                    #dsarm004#2 = enTipoVinExte;
                    |LEE 000#dsarm004.=;
                    |CIERRA #dsarm004;

                    |SI #dsarm004#86 = "S"; |O #dsarm004#86 = "E";
                         |SI #dsarm004#86 = "E";
                              enSwVinExteEspecial = 1;
                         |SINO;
                              enSwVinExteEspecial = 0;
                         |FINSI;
                         enSwVinculosExternos = 1;
                         eaTipoVinculo = "CLINICA";
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #dsarm001;
|FPRC;

/*
|PROCESO Baja902;
     #902#0 = nHistoria;
     #902#1 = 0;
|FPRC;

|PROCESO Alta902;
     #902#0 = nHistoria;
     #902#1 = 999999999;
|FPRC;
*/

|PROCESO Baja601;
     |SELECT #9#601;
     #601#0 = 9999999;
|FPRC;

|PROCESO Alta601;
     #601#0 = 0;
|FPRC;


|PROCESO Evento601;           ||Historia
     |SI FSalida = 1; |O FSalida = 2;
          |LEE 000#601.=;
          |SI FSalida = 0;
               nDesdeHis = #601#0;
               nHastaHis = #601#0;
               |REFRESCACONTROL nGrid2;
          |FINSI;
     |FINSI;

     |SI FSalida = 4;
          |LEE 000#601.=;
          |SI FSalida = 0;
               aNombre = #601#1;
               |QBF aNombre;
               aNombre = aNombre + " " + #601#2;
               |QBF aNombre;
               aNombre = aNombre + " " + #601#3;
               |QBF aNombre;
               aLong = aNombre % A0;
               nLong1 = aLong;

               aHistoria = #601#0;
               |QBF aHistoria;
               aLong = aHistoria % A0;
               nLong2 = aLong;

               nLongTotal = nLong1 + nLong2 + 1;
               |SI nLongTotal [ 50;
                    eaValorVinculoAux = aNombre + " " + aHistoria;
                    |QBF eaValorVinculoAux;
               |SINO;
                    nDif = 50 - nLong2;
                    nSaca = 100 + nDif;
                    aSaca = aNombre % aSaca;
                    aNombre = aSaca;
                    eaValorVinculoAux = aNombre + aHistoria;
                    |QBF eaValorVinculoAux;
               |FINSI;

               eaValorVinculo1 = #601#0;
               |QBF eaValorVinculo1;

               ||solo Historia o estoy en el asistente de Busqueda.
               |SI enSwVinExteEspecial = 1; |O nModoAsistente = 1;
                    |PTEC 806;
               |SINO;
                    aEpisodioUnico = "";
                    nNumEpisodios = 0;
                    nHistoria601 = #601#0;
                    |BUCLE dsarcl02_episodios;
                    |SI nNumEpisodios = 1;
                         eaValorVinculo2 = aEpisodioUnico
                         |QBF eaValorVinculo2;
                         |PTEC 806;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Baja2PLB;
     |SELECT #3#dsarcl02;

     #dsarcl02#0 = nDesdeHis;
     #dsarcl02#1 = 999999999;
     ||#dsarcl02#2 = "31.12.2099";
|FPRC;

|PROCESO Alta2PLB;
     #dsarcl02#0 = nHastaHis;
     #dsarcl02#1 = 0;
     ||#dsarcl02#2 = "01.01.0000";
|FPRC;

|PROCESO Evento2PLB;               ||EPISODIO.
     |SI FSalida = 1; |O FSalida = 2;
          |LEE 000#dsarcl02.=;
     |FINSI;

     |SI FSalida = 4;
          |LEE 000#dsarcl02.=;
          |SI FSalida = 0; |Y #dsarcl02#0 = nDesdeHis;
               |SI enSwVinExteEspecial = 1;       ||Solo Historia, no episodios
                    aMensaje = "0000El tipo del documento, SOLO permite introducir Historia";
                    |MENAV aMensaje;
               |SINO;
                    eaValorVinculo1 = #dsarcl02#0;
                    |QBF eaValorVinculo1;
                    eaValorVinculo2 = #dsarcl02#1;
                    |QBF eaValorVinculo2;
                    |PTEC 806;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BotonSinHisEpi;
     enSwSinVinculos = 1;
     |PTEC 807;
|FPRC;

|PROCESO VinculosExternos;
     enSwVinculosExternos = 0;
     eaTipoVinculo = "";
     eaValorVinculo1 = "";
     eaValorVinculo2 = "";
     eaValorVinculoAux = "";

     |ABRE #dsarm001;
     |DDEFECTO #dsarm001;
     |LEE 000#dsarm001.p;
     |SI FSalida = 0;
          |SI #dsarm001#186 = "S";
               |ABRE #dsarm004;
               |DDEFECTO #dsarm004;
               #dsarm004#0 = enGrupoVinExte;
               #dsarm004#1 = enSubGrupoVinExte;
               #dsarm004#2 = enTipoVinExte;
               |LEE 000#dsarm004.=;
               |CIERRA #dsarm004;

               |SI #dsarm004#86 = "S";
                    enSwVinculosExternos = 1;
                    eaTipoVinculo = "TALLER";
                    nEmpresa = #dsarm001#187;
                    |SI nEmpresa ! 0;
                         eaValorVinculo1 = ("00000" + nEmpresa) % -105;
                    |SINO;
                         enSwVinculosExternos = 0;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI #dsarm001#194 = "S";
                    |ABRE #dsarm004;
                    |DDEFECTO #dsarm004;
                    #dsarm004#0 = enGrupoVinExte;
                    #dsarm004#1 = enSubGrupoVinExte;
                    #dsarm004#2 = enTipoVinExte;
                    |LEE 000#dsarm004.=;
                    |CIERRA #dsarm004;

                    |SI #dsarm004#86 = "S"; |O #dsarm004#86 = "E";
                         |SI #dsarm004#86 = "E";
                              enSwVinExteEspecial = 1;
                         |SINO;
                              enSwVinExteEspecial = 0;
                         |FINSI;
                         enSwVinculosExternos = 1;
                         eaTipoVinculo = "CLINICA";
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #dsarm001;

     |SI enSwVinculosExternos = 1;
          |SI eaTipoVinculo = "TALLER";
               |DBASS aBase;
               |QBF aBase;

               aPathDef = aBase + "dscomer9/def/";
               aPathDatos = aBase + "dscomer9/fich/" + eaValorVinculo1 + "/";

               aNomDef = aPathDef + "con00601";
               |CARGA_DEF aNomDef, referen@;
               |SI FSalida ! 0;
                    aMensaje = "0000Problemas CARGA_DEF Vehiculos M¢dulo Taller [con00601]";
                    |MENAV aMensaje;
               |ACABA;
               |FINSI;
               |PATH_DAT #999 aPathDatos;

               |ABRE #999;
               |SI eaPosicionateVinculo2 ! "";
                    #999#0 = eaPosicionateVinculo2;
                    |LEE 000#999.=;
                    |SI FSalida ! 0;
                         |LEE 000#999.p;
                    |FINSI;
               |SINO;
                    |LEE 000#999.p;
               |FINSI;

               |CONSULTA_CLAVE #1#999;
               |SI FSalida = 0;
                    eaValorVinculo2 = #999#0;
                    |QBF eaValorVinculo2;
               |SINO;
                    enSwVinculosExternos = 0;
                    eaTipoVinculo = "";
                    eaValorVinculo1 = "";
                    eaValorVinculo2 = "";
               |FINSI;
               |CIERRA #999;
               |DESCARGA_DEF #referen@;
          |FINSI;
          |SI eaTipoVinculo = "CLINICA";
               ||Aqui, mostramos el nuevo buscador.
               |HAZ BusquedaPaciente;
          |FINSI;
     |FINSI;
|FPRC;


|PROCESO BusquedaPaciente;
||PROCESO BusquedaPacienteNew;
     ||ARA39
     aTab = &9;
     aReturnUnix = &10;

     |ABRE #dsarm001;
     |DDEFECTO #dsarm001;
     |LEE 000#dsarm001.p;
     |CIERRA #dsarm001;

     |HAZ DimeUnidad;

     |DBASE aPathBase;
     |QBF aPathBase;

     aUsuNum = Usuario;
     |QBF aUsuNum;
     aNombrePara = "bus" + aUsuNum + ".txt";

     ||Borro el .txt y el .res y el .err

     aFicheroPara = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + aNombrePara;
     |RFBORRA aFicheroPara;

     aFicheroErr = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + aNombrePara + ".err";
     |RFBORRA aFicheroErr;

     aFicheroRes = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + aNombrePara + ".res";
     |RFBORRA aFicheroRes;

     eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\dsclinicabus.exe";
     eaOrigen = aPathBase + "dlls/dsclinicabus.exe";
     |HAZ EnviaFicheroConMD5;

     ||Creo el Fichero con los parametros
     ||Y el aPassword lo cargo.

     |XABRE "CW", aFicheroPara, nHandlePara;
     |SI FSalida < 0;
          aMensaje = "0000Error al crear el fichero " + aFicheroPara;
          |MENAV aMensaje;
          enError = 1;
          |ACABA;
     |FINSI;

     ||Leo y meto los parametros

     aPassword = #dsarm001#196;
     |QBF aPassword;

     ||USUARIO
     aTexto = #dsarm001#195;
     |QBF aTexto;
     |XGRABA nHandlePara, aTexto;

     ||Nombre ODBC (ServidorBBDD)
     aTexto = #dsarm001#197;
     |QBF aTexto;
     |XGRABA nHandlePara, aTexto;

     ||Host BBDD
     aTexto = #dsarm001#202;
     |QBF aTexto;
     |XGRABA nHandlePara, aTexto;

     ||Nombre BBDD
     aTexto = #dsarm001#198;
     |QBF aTexto;
     |XGRABA nHandlePara, aTexto;

     ||Posicionate vinculo1
     aAux = eaPosicionateVinculo1;
     |QBF aAux;
     |SI aAux ! "";
          aTexto = aAux;
     |SINO;
          aTexto = "";
     |FINSI;
     |XGRABA nHandlePara, aTexto;

     ||Posicionate vinculo2
     aAux = eaPosicionateVinculo2;
     |QBF aAux;
     |SI aAux ! "";
          aTexto = aAux;
     |SINO;
          aTexto = "";
     |FINSI;
     |XGRABA nHandlePara, aTexto;

     ||Solo Busco Historias
     |SI enSwVinExteEspecial = 1; |O nModoAsistente = 1;
          aTexto = "H";
     |SINO;
          aTexto = "";
     |FINSI;
     |XGRABA nHandlePara, aTexto;

     |XCIERRA nHandlePara;

     ||Ejecuta el programa de David que devuelve un .txt
     ||con el resultado de la busqueda

     aEjecuta = eaUnidad + ":\DOCUMENTOS\DSARCHI\dsclinicabus.exe";
     aEjecuta = aEjecuta + " " + aFicheroPara + " " + aPassword;

     |RSYSTEM aEjecuta;


     ||Recupero el .err y el .res
     |XABRE "CU", aFicheroErr, nHandleErr;
     |SI FSalida ] 0;
          |XLEE nHandleErr, 250, aTexto;
          |QBF aTexto;
          |SI aTexto = "PROCESO CANCELADO";
               ||EL usuario a cancelado el proceso
          |SINO;
               |SI aTexto = "ERROR AL ABRIR LA BASE DE DATOS.";
                    aMensaje = "0000Problemas con el ODBC [" + #dsarm001#197;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "]";
                    |MENAV aMensaje;
               |SINO;
                    aMensaje = "0000" + aTexto;
                    |MENAV aMensaje;
               |FINSI;
          |FINSI;
          enError = 1;
          |XCIERRA nHandleErr;
     |FINSI;

     |SI enError = 1; |HAZ BorraFicherosTxt; |ACABA; |FINSI;

     |XABRE "CU", aFicheroRes, nHandleRes;
     |SI FSalida ] 0;
          |XLEE nHandleRes, 250, aTexto;
          |QBF aTexto;
          |SI aTexto = "";
               enError = 1;
          |SINO;
               aLong = aTexto % A0
               nLong = aLong;

               eaValorVinculo1 = "";
               eaValorVinculo2 = "";
               eaValorVinculoAux = "";
               aApell1 = "";
               aApell2 = "";
               aNombreB = "";

               nContador = 0;
               aTextAux = "";
               |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
                    aSaca = nVoy + "01";
                    aLetra = aTexto % aSaca;
                    |SI aLetra = aTab; |O aLetra = aReturnUnix;
                         nContador = nContador + 1;
                         |SI nContador = 1;
                              eaValorVinculo1 = aTextAux;
                         |FINSI;
                         |SI nContador = 2;
                              eaValorVinculo2 = aTextAux;
                         |FINSI;
                         |SI nContador = 3;
                              aApell1 = aTextAux;
                         |FINSI;
                         |SI nContador = 4;
                              aApell2 = aTextAux;
                         |FINSI;
                         |SI nContador = 5;
                              aNombreB = aTextAux;
                         |FINSI;
                         aTextAux = "";
                    |SINO;
                         aTextAux = aTextAux + aLetra;
                    |FINSI;
               |SIGUE;
               nContador = nContador + 1;
               |SI nContador = 5;
                    aNombreB = aTextAux;
               |FINSI;

               |SI eaValorVinculo1 = "";
                    enError = 1;
               |FINSI;
          |FINSI;
     |SINO;
          enError = 1;
     |FINSI;
     |XCIERRA nHandleRes;

     |SI enError = 1; |HAZ BorraFicherosTxt; |ACABA; |FINSI;

     ||Segun el resultado. Simulo el Tipo 12.
     ||y devuelvo las variables que correspondan.
     |HAZ BorraFicherosTxt;
     |HAZ PseudoTipo12;
|FPRC;

|PROCESO BorraFicherosTxt;
     |RFBORRA aFicheroPara;
     |RFBORRA aFicheroErr;
     |RFBORRA aFicheroRes;
|FPRC;

|PROCESO PseudoTipo12;
     ||ARA39

     |SI enSwVinExteEspecial = 1;
          eaValorVinculo2 = "";
     |FINSI;
     aNombre = aApell1;
     |QBF aNombre;
     aNombre = aNombre + " " + aApell2;
     |QBF aNombre;
     aNombre = aNombre + " " + aNombreB;
     |QBF aNombre;
     aLong = aNombre % A0;
     nLong1 = aLong;

     aHistoria = eaValorVinculo1;
     |QBF aHistoria;
     aLong = aHistoria % A0;
     nLong2 = aLong;

     nLongTotal = nLong1 + nLong2 + 1;
     |SI nLongTotal [ 50;
          eaValorVinculoAux = aNombre + " " + aHistoria;
          |QBF eaValorVinculoAux;
     |SINO;
          nDif = 50 - nLong2;
          nSaca = 100 + nDif;
          aSaca = aNombre % aSaca;
          aNombre = aSaca;
          eaValorVinculoAux = aNombre + aHistoria;
          |QBF eaValorVinculoAux;
     |FINSI;


     ||ARA1
     |SI nModoAsistente = 1;
          aAux = (eaValorVinculo1 + "                              ") % 130;
          enError = 0;
          |ABRE #dsarm005;
          aNomFicheroAux = ("01" + Usuario + "zzzzzzzz") % 108;
          aSQL = "SELECT * FROM dsarm005 INTO " + aNomFicheroAux + " WHERE 97 == " + "'" + aAux + "'";
          |SQL aSQL;
          |CIERRA #dsarm005;
          ||Creo el temporal del dsarm005 a devolver con los documentos
          ||que sean de la historia seleccionada.
          ||Lo puedo crear con la |SQL .. creo que lento
          ||o con un BUCLE, tb. sera lento.
     |FINSI;
|FPRC;

||ARA39
|PROCESO BusquedaPacienteOld;
||PROCESO BusquedaPaciente;
     |VENTANA 0501, 3299, -1, 16, "Busqueda de paciente. Doble click para seleccionar Historia/Episodio";
     nVentana = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentana;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |DDEFECTO #dsarclw1;
     |PINPA #0#dsarclw1;
     nPanta = FSalida;
     |PINDA #0#dsarclw1;

     |CONTROL_SIMPLE nPanta, "BOTON,{{163}} Busqueda", 0689, 0699, BotonBusqueda;
     nBotonBus = FSalida;

     |CONTROL_SIMPLE nPanta, "BOTON,{{207}} Borrar Busqueda", 0889, 0999, BotonBorraBus;
     nBotonBorraBus = FSalida;

/*
     ||ESTO NO ES NECESARIO. SIEMPRE TENDRA HISTORIA/EPISODIO.
     |CONTROL_SIMPLE nPanta, "BOTON,Sin Historia/Episodio", 3180, 3199, BotonSinHisEpi;
     nBotonSinHisEpi = FSalida;
*/

     |DBASE aBase;
     |QBF aBase;
     aDef = aBase + "def/dsarcl01";
     |CARGA_DEF aDef, dsarcl01@;
     |SI FSalida ! 0;
          aMensaje = "0000Problema carga_def <dsarcl01>";
          |MENAV aMensaje;
          enSwErrorVinExte = 1;

          |FIN_CONTROL_WINDOWS nBotonBus;
          |FIN_CONTROL_WINDOWS nBotonBorraBus;
          |FIN_CONTROL_WINDOWS nBotonSinHisEpi;

          Tempo = aTempo601;
          |HAZ BoraTempo;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentana;
          aVent5 = "MODELESS";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |FINVENTANA nVentana;
          |ACABA;
     |FINSI;

     |ABRET #dsarcl01;
     |ABRET #dsarcl02;

     |HAZ CreaTempo;
     aTempo601 = Tempo;

     aFichSQL = aTempo601;
     |NOME_DAT #601 aTempo601;
     |DELINDEX #601;
     |ABRE #601;

     nRango = 4 + 8 + 16 + 32;
     nPos1 = 1102;
     nPos2 = 2298;
     |LINEAL_SIMPLE #9#601, nRango, nPos1, nPos2, Baja601, Alta601, Evento601;
     nGrid601 = FSalida;

     nRango = 4 + 8 + 16 + 32;
     nPos1 = 2402;
     nPos2 = 3198;
     |LINEAL_SIMPLE #3#dsarcl02, nRango, nPos1, nPos2, Baja2PLB, Alta2PLB, Evento2PLB;
     nGrid2 = FSalida;

     nDesdeHis = 0;
     nHastaHis = 0;
     |REFRESCACONTROL nGrid2;

     ||ARA38
     |SI eaPosicionateVinculo1 ! "";
          |DDEFECTO #dsarcl01;
          |SELECT #1#dsarcl01;
          #dsarcl01#0 = eaPosicionateVinculo1;
          |LEE 000#dsarcl01.=;
          |SI FSalida = 0;
               |SALVA_DATOS #dsarcl01;
               |REPON_DATOS #601;
               |GRABA 020#601.n;
               |LIBERA #601;

               |REFRESCACONTROL nGrid601;
               eaValorVinculo1 = eaPosicionateVinculo1;
               |SI eaPosicionateVinculo2 ! "";
                    eaValorVinculo2 = eaPosicionateVinculo2;
                    nEpiAux = eaValorVinculo2;
                    |DDEFECTO #dsarcl02;
                    #dsarcl02#0 = #dsarcl01#0;
                    #dsarcl02#1 = nEpiAux;
                    |LEE 000#dsarcl02.=;
               |FINSI;
          |FINSI;
     |FINSI;

     |ENDATOS #1#dsarclw1;
     |SI FSalida ! 0;
          |SI enSwSinVinculos = 1;
               enSwVinculosExternos = 0;
               eaTipoVinculo = "";
               eaValorVinculo1 = "";
               eaValorVinculo2 = "";
               enSwSinVinculos = 0;
          |SINO;
               enSwErrorVinExte = 1;
          |FINSI;
     |SINO;
          ||ARA38
     |FINSI;

     |FIN_CONTROL_WINDOWS nBotonBus;
     |FIN_CONTROL_WINDOWS nBotonBorraBus;
     |FIN_CONTROL_WINDOWS nBotonSinHisEpi;

     |CIERRAT #dsarcl02;
     |CIERRAT #dsarcl01;
     |CIERRA #601;

     |DESCARGA_DEF #dsarcl01@;

     |DELINDEX #601;

     Tempo = aTempo601;
     |HAZ BoraTempo;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentana;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentana;
|FPRC;

|PROCESO GrabaVincuExte;
     |ABRE #dsarm046;
     |DDEFECTO #dsarm046;
     #dsarm046#0 = enNumRegVincuExte;
     |LEE 101#dsarm046.=;
     |SI FSalida ! 0; |GRABA 020#dsarm046.b; |FINSI;
     #dsarm046#1 = eaTipoVinculo;
     #dsarm046#2 = eaValorVinculo1;
     #dsarm046#3 = eaValorVinculo2;
     |GRABA 020#dsarm046.a;
     |LIBERA #dsarm046;
     |CIERRA #dsarm046;
|FPRC;

|PROCESO dsarcl02_historia;
     nDimeHistoria = #dsarcl02#0;
     |ERROR10;
|FPRC;

|DEFBUCLE dsarcl02_historia;
 #dsarcl02#2;
 ;
 nCampoEpi, 0;
 nCampoEpi, 9999999;
 ;
 NULL, dsarcl02_historia;
|FIN;

|PROCESO ClinicaBuscaPac;
/*
     |||TODO CCC. Para pruebas. QUITAR
     eaPosicionateVinculo1 = "172112";
     eaPosicionateVinculo2 = "20470126";
     |||TODO CCC. Para pruebas. QUITAR
*/
     eaPosicionateVinculo1 = "";
     eaPosicionateVinculo2 = "";

     nModoAsistente = 1;
     |HAZ BusquedaPaciente;
|FPRC;

|PROCESO BotonBusqueda;
     ||ESTO YA NO SE USA. LA BUSQUEDA ES DESDE EL PROGRAMA DE DAVID.

     aDni = "";
     aSSSS = "";
     aCIP = "";
     aApellido1 = "";
     aApellido2 = "";
     aCampoNom = "";
     aFecNac = "";
     aHombre = "";
     aMujer = "";
     aTelefono = "";
     aCampoHis = "";
     aCampoEpi = "";
     nCampoEpi = 0;
     nCampoHis = 0;

     ||PRIMERO CAPTURAMOS TODOS LOS DATOS.  con el GETDATACONTROL:

     ||Historia
     |REFERENCIA_DEF get1, #dsarclw1;
     get2 = 0;
     Iget = get1<-;
     |ESPECIFICA "GETDATACONTROL", get;
     aAux = FSalida;
     |QBF aAux;
     aCampoHis = aAux;
     nCampoHis = aCampoHis;

     ||Apellido1
     |REFERENCIA_DEF get1, #dsarclw1;
     get2 = 1;
     Iget = get1<-;
     |ESPECIFICA "GETDATACONTROL", get;
     aAux = FSalida;
     |QBF aAux;
     eaAlfa = aAux;
     |HAZ QuitaRaros;
     aAux = eaAlfa;
     aApellido1 = aAux > aAux;

     ||Apellido2
     |REFERENCIA_DEF get1, #dsarclw1;
     get2 = 2;
     Iget = get1<-;
     |ESPECIFICA "GETDATACONTROL", get;
     aAux = FSalida;
     |QBF aAux;
     eaAlfa = aAux;
     |HAZ QuitaRaros;
     aAux = eaAlfa;
     aApellido2 = aAux > aAux;

     ||Nombre
     |REFERENCIA_DEF get1, #dsarclw1;
     get2 = 3;
     Iget = get1<-;
     |ESPECIFICA "GETDATACONTROL", get;
     aAux = FSalida;
     |QBF aAux;
     eaAlfa = aAux;
     |HAZ QuitaRaros;
     aAux = eaAlfa;
     aCampoNom = aAux > aAux;

     ||FechaNacimiento
     |REFERENCIA_DEF get1, #dsarclw1;
     get2 = 5;
     Iget = get1<-;
     |ESPECIFICA "GETDATACONTROL", get;
     aAux = FSalida;
     |QBF aAux;
     aFecNac = aAux;

     ||DNI
     |REFERENCIA_DEF get1, #dsarclw1;
     get2 = 6;
     Iget = get1<-;
     |ESPECIFICA "GETDATACONTROL", get;
     aAux = FSalida;
     |QBF aAux;
     eaAlfa = aAux;
     |HAZ QuitaRaros;
     aAux = eaAlfa;
     aDni = aAux > aAux;

     ||Telefono
     |REFERENCIA_DEF get1, #dsarclw1;
     get2 = 7;
     Iget = get1<-;
     |ESPECIFICA "GETDATACONTROL", get;
     aAux = FSalida;
     |QBF aAux;
     eaAlfa = aAux;
     |HAZ QuitaRaros;
     aAux = eaAlfa;
     aTelefono = aAux > aAux;

     ||Seguridad Social
     |REFERENCIA_DEF get1, #dsarclw1;
     get2 = 8;
     Iget = get1<-;
     |ESPECIFICA "GETDATACONTROL", get;
     aAux = FSalida;
     |QBF aAux;
     eaAlfa = aAux;
     |HAZ QuitaRaros;
     aAux = eaAlfa;
     aSSSS = aAux > aAux;

     ||CIP
     |REFERENCIA_DEF get1, #dsarclw1;
     get2 = 9;
     Iget = get1<-;
     |ESPECIFICA "GETDATACONTROL", get;
     aAux = FSalida;
     |QBF aAux;
     eaAlfa = aAux;
     |HAZ QuitaRaros;
     aAux = eaAlfa;
     aCIP = aAux > aAux;

     ||Episodio
     |REFERENCIA_DEF get1, #dsarclw1;
     get2 = 10;
     Iget = get1<-;
     |ESPECIFICA "GETDATACONTROL", get;
     aAux = FSalida;
     |QBF aAux;
     aCampoEpi = aAux;
     nCampoEpi = aCampoEpi;

     ||Hombre
     |REFERENCIA_DEF get1, #dsarclw1;
     get2 = 11;
     Iget = get1<-;
     |ESPECIFICA "GETDATACONTROL", get;
     aAux = FSalida;
     |QBF aAux;
     aHombre = aAux > aAux;

     ||Mujer
     |REFERENCIA_DEF get1, #dsarclw1;
     get2 = 12;
     Iget = get1<-;
     |ESPECIFICA "GETDATACONTROL", get;
     aAux = FSalida;
     |QBF aAux;
     aMujer = aAux > aAux;

     nCamposAux = 0;
     |SI nCampoHis = 0; |Y nCampoEpi = 0; |Y aDni = ""; |Y aSSSS = ""; |Y aCIP = "";
      |Y aApellido1 = ""; |Y aApellido2 = ""; |Y aCampoNom = ""; |Y aFecNac = "01.01.0000";
      |Y aHombre = "N"; |Y aMujer = "N"; |Y aTelefono = "";
          aMensaje = "0000Introduzca la acotacion para la Busqueda";
          |MENAV aMensaje;
          |ACABA;
     |SINO;
          |SI aApellido1 ! ""; nCamposAux = nCamposAux + 1; |FINSI;
          |SI aApellido2 ! ""; nCamposAux = nCamposAux + 1; |FINSI;
          |SI aCampoNom ! ""; nCamposAux = nCamposAux + 1; |FINSI;
          |SI aFecNac ! "01.01.0000"; nCamposAux = nCamposAux + 1; |FINSI;
          |SI aDni ! ""; nCamposAux = nCamposAux + 1; |FINSI;
          |SI aTelefono ! ""; nCamposAux = nCamposAux + 1; |FINSI;
          |SI aSSSS ! ""; nCamposAux = nCamposAux + 1; |FINSI;
          |SI aCIP ! ""; nCamposAux = nCamposAux + 1; |FINSI;
          |SI aHombre ! "N"; nCamposAux = nCamposAux + 1; |FINSI;
          |SI aMujer ! "N"; nCamposAux = nCamposAux + 1; |FINSI;
     |FINSI;

     |VENTANA 0501, 0550, -1, 16, "Procesando Busqueda, espere por favor...";
     nVentTrab = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802;
     |PAUSA;
     |PULSATECLA;

     ||ARASQL
     |CIERRA #601;
     |DELINDEX #601;

     nDesdeHis = 0;
     nHastaHis = 0;
     |REFRESCACONTROL nGrid2;

     ||TODO CCC. Que hacemos cuando hay un Numero de Episodio.
     ||Consultar con Carlos Frases.
     |SI nCampoEpi ! 0;
          nDimeHistoria = 0;
          |BUCLE dsarcl02_historia;

          |SI nDimeHistoria ! 0;
               nCampoHis = nDimeHistoria;
          |FINSI;
     |FINSI;

     nSwHayCampo = 0;

     |SI nCampoHis ! 0;
          |ABRE #601;
          |DDEFECTO #dsarcl01;
          |SELECT #1#dsarcl01;
          #dsarcl01#0 = nCampoHis;
          |LEE 000#dsarcl01.=;
          |SI FSalida = 0;
               |SALVA_DATOS #dsarcl01;
               |REPON_DATOS #601;
               |GRABA 020#601.n;
               |LIBERA #601;
          |FINSI;
/*
          nSwHayCampo = 1;
          aAlfa = "0 == " + nCampoHis;
          |XGRABA nHandle, aAlfa;
*/
     |SINO;
          |DBASE aBase;
          |QBF aBase;
          aAlfa = aBase + "tmp";  |MKDIR aAlfa;
          aFicheroSql = aAlfa  + "/5ql" + Usuario + ".txt";
          |XABRE "WB", aFicheroSql, nHandle;

          aAlfa = "* FROM dsarcl01 INTO " + aFichSQL + " WHERE ";
          |XGRABA nHandle, aAlfa;

          ||RESTO DE LA BUSQUEDA.
          ||ARA38
          aAux = aApellido1;
          |SI aAux ! "";
               |SI nSwHayCampo = 1;
                    aAlfa = " AND 1 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |SINO;
                    nSwHayCampo = 1;
                    aAlfa = "1 LIKE '" + aAux + "'";
                    ||aAlfa = "1 == '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |FINSI;
          |FINSI;
          aAux = aApellido2;
          |SI aAux ! "";
               |SI nSwHayCampo = 1;
                    aAlfa = " AND 2 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |SINO;
                    nSwHayCampo = 1;
                    aAlfa = "2 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |FINSI;
          |FINSI;
          aAux = aCampoNom;
          |SI aAux ! "";
               |SI nSwHayCampo = 1;
                    aAlfa = " AND 3 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |SINO;
                    nSwHayCampo = 1;
                    aAlfa = "3 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |FINSI;
          |FINSI;

          aAux = aHombre;
          |SI aAux ! "N";
               |SI nSwHayCampo = 1;
                    aAlfa = " AND 4 == 'H'";
                    |XGRABA nHandle, aAlfa;
               |SINO;
                    nSwHayCampo = 1;
                    aAlfa = "4 == 'H'";
                    |XGRABA nHandle, aAlfa;
               |FINSI;
          |SINO;
               aAux = aMujer;
               |SI aAux ! "N";
                    |SI nSwHayCampo = 1;
                         aAlfa = " AND 4 == 'M'";
                         |XGRABA nHandle, aAlfa;
                    |SINO;
                         nSwHayCampo = 1;
                         aAlfa = "4 == 'M'";
                         |XGRABA nHandle, aAlfa;
                    |FINSI;
               |FINSI;
          |FINSI;

          aAux = aFecNac;
          |SI aAux ! "01.01.0000";
               |SI nSwHayCampo = 1;
                    aAlfa = " AND 5 == '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |SINO;
                    nSwHayCampo = 1;
                    aAlfa = "5 == '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |FINSI;
          |FINSI;

          aAux = aDni;
          |SI aAux ! "";
               |SI nSwHayCampo = 1;
                    aAlfa = " AND 6 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |SINO;
                    nSwHayCampo = 1;
                    aAlfa = "6 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |FINSI;
          |FINSI;

          aAux = aTelefono;
          |SI aAux ! "";
               |SI nSwHayCampo = 1;
                    aAlfa = " AND 7 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |SINO;
                    nSwHayCampo = 1;
                    aAlfa = "7 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |FINSI;
          |FINSI;

          aAux = aSSSS;
          |SI aAux ! "";
               |SI nSwHayCampo = 1;
                    aAlfa = " AND 8 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |SINO;
                    nSwHayCampo = 1;
                    aAlfa = "8 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |FINSI;
          |FINSI;

          aAux = aCIP;
          |SI aAux ! "";
               |SI nSwHayCampo = 1;
                    aAlfa = " AND 9 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |SINO;
                    nSwHayCampo = 1;
                    aAlfa = "9 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |FINSI;
          |FINSI;

          aAux = aCIP;
          |SI aAux ! "";
               |SI nSwHayCampo = 1;
                    aAlfa = " AND 9 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |SINO;
                    nSwHayCampo = 1;
                    aAlfa = "9 LIKE '" + aAux + "'";
                    |XGRABA nHandle, aAlfa;
               |FINSI;
          |FINSI;

          |||LEE 000#dsarcl01.p;
          |||LEE 000#dsarcl01.s;
          aSQL = "SELECT @" + aFicheroSql;
          |SQL aSQL;
          |NOME_DAT #601 aFichSQL;
          |ABRE #601;
          |XCIERRA nHandle;
     |FINSI;

     |LEE 000#601.p;
     |SI FSalida ! 0;
          aMensaje = "0000No se ha encontrado ningun registro que cumpla la acotacion";
          |MENAV aMensaje;
     |FINSI;

     |REFRESCACONTROL nGrid601;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentTrab;
     ||ARA
     ||FBORRA aFicheroSql;
|FPRC;

|PROCESO BotonBorraBus;
     eaValorVinculo1 = "";
     eaValorVinculo2 = "";

     |HAZ BorraPantalla;

     |PTEC 802;
     |PULSATECLA;

     |HAZ BorraPantalla;

     |PTEC 808;
     |PULSATECLA;

     |HAZ BorraGrid;
     |PULSATECLA;

     nDesdeHis = 0;
     nHastaHis = 0;
     |REFRESCACONTROL nGrid2;

     |HAZ BorraPantalla;
     |PULSATECLA;
|FPRC;

|PROCESO BorraPantalla;
     #dsarclw1#0 = 0;
     #dsarclw1#1 = "";
     #dsarclw1#2 = "";
     #dsarclw1#3 = "";
     #dsarclw1#5 = "01.01.0000";
     #dsarclw1#6 = "";
     #dsarclw1#7 = "";
     #dsarclw1#8 = "";
     #dsarclw1#9 = "";
     #dsarclw1#10 = "";
     #dsarclw1#11 = "N";
     #dsarclw1#12 = "N";
     |PINTA #dsarclw1#0;
     |PINTA #dsarclw1#1;
     |PINTA #dsarclw1#2;
     |PINTA #dsarclw1#3;
     |PINTA #dsarclw1#5;
     |PINTA #dsarclw1#6;
     |PINTA #dsarclw1#7;
     |PINTA #dsarclw1#8;
     |PINTA #dsarclw1#9;
     |PINTA #dsarclw1#10;
     |PINTA #dsarclw1#11;
     |PINTA #dsarclw1#12;
|FPRC;

|PROCESO BorraGrid;
     |CIERRA #601;
     |DELINDEX #601;
     |ABRE #601;

     |REFRESCACONTROL nGrid601;
|FPRC;

|PROCESO Tipo0C11; |TIPO 0;
     |SI #dsarclw1#11 = "S";
          |SI #dsarclw1#12 = "S";
               #dsarclw1#12 = "N";
               |PINTA #dsarclw1#12;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo0C12; |TIPO 0;
     |SI #dsarclw1#12 = "S";
          |SI #dsarclw1#11 = "S";
               #dsarclw1#11 = "N";
               |PINTA #dsarclw1#11;
          |FINSI;
     |FINSI;
|FPRC;


|PROCESO DimeValoresVinculo;
     |ABRE #dsarm046;
     |DDEFECTO #dsarm046;
     #dsarm046#0 = enNumRegVincuExte;
     |LEE 000#dsarm046.=;
     |SI FSalida = 0;
          eaTipoVinculo = #dsarm046#1;
          eaValorVinculo1 = #dsarm046#2;
          eaValorVinculo2 = #dsarm046#3;
          enSwVinculosExternos = 1;
          |QBF eaTipoVinculo;
          |QBF eaValorVinculo1;
          |QBF eaValorVinculo2;
     |SINO;
          eaTipoVinculo = "";
          eaValorVinculo1 = "";
          eaValorVinculo2 = "";
          enSwVinculosExternos = 0;
     |FINSI;
     |CIERRA #dsarm046;
|FPRC;

|PROCESO dsarm005_hay;
     aVinculo = #dsarm005#97;
     |QBF aVinculo;
     |SI aVinculo = eaValorVinculo1;
          nSwHayDocs = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm005_hay;
 #dsarm005#2;
 ;
 enGrupoVinExte, enSubGrupoVinExte, enTipoVinExte, 000000001;
 enGrupoVinExte, enSubGrupoVinExte, enTipoVinExte, 999999999;
 ;
 NULL, dsarm005_hay;
|FIN;


|PROCESO dsarm005_mete;
     aVinculo = #dsarm005#97;
     |QBF aVinculo;
     |SI aVinculo = eaValorVinculo1;
          nSwHayDocs = nSwHayDocs + 1;
          |SALVA_DATOS #dsarm005;
          |REPON_DATOS #otrodef@;
          |GRABA 020#otrodef@.n;
          |LIBERA #otrodef@;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm005_mete;
 #dsarm005#2;
 ;
 enGrupoVinExte, enSubGrupoVinExte, enTipoVinExte, 000000001;
 enGrupoVinExte, enSubGrupoVinExte, enTipoVinExte, 999999999;
 ;
 NULL, dsarm005_mete;
|FIN;


|PROCESO Tipo12_clw2; |TIPO 12;
/*
     ||Aqui no entra, pq. no es un ENDATOS.
     |SI nModoHis = 1;      ||A¤adir

     |SINO;
          |SI nModoHis = 2;      ||Sustituir
          |SINO;
               aMensaje = "0000NSeguro que desa anular la introduccion del documento?";
               |CONFI aMensaje;
               |SI FSalida = 0;
               |SINO;
                    |ERROR;
               |FINSI;
          |FINSI;
     |FINSI;
*/
|FPRC;

|PROCESO PresentaDocumentoHis;
     aFichero = #55#7;   |QBF aFichero;
     aFichero = aFichero + #55#9;
     |QBF aFichero;

     |HAZ DimeUnidad;

     |DBASE aPathBase;
     |QBF aPathBase;

     eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "dsabreextension.exe";
     eaOrigen = aPathBase + "dlls/dsabreextension.exe";
     |HAZ EnviaFicheroConMD5;

     aExtension = (aFichero % -104) > "";
     aAlfa1 = aExtension % 101;
     |SI aAlfa1 ! ".";
         aExtension = (aFichero % -105) > "";
     |FINSI;

     eaOrigen = aFichero;
     aNomDoc = ("000000000" + #55#0) % -109;
     eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + aNomDoc + aExtension;

     aIPRemoto   = "";
     |IP_REMOTO aIPRemoto;

     |SI #1#7 = "N";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO eaOrigen, eaDestino;
         |SINO;
             |COPIA_FICHERO eaOrigen, eaDestino;
         |FINSI;
     |SINO;
         |SI eaOrigen ! eaDestino;
              |RCOPIA_FICHERO eaOrigen, eaDestino;
         |FINSI;
     |FINSI;

     aFicheroVer = eaDestino;
     |SI aIPRemoto = "";
         |XABRE "E", eaDestino, nHandle;
     |SINO;
         |XABRE "EC", eaDestino, nHandle;
     |FINSI;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     ||Historico
     |HORA aHora;
     aUsuario = Usuario % 810;
     |ABRE #flowm006;
     #flowm006#0  = #55#0;
     #flowm006#1  = 99999;
     |LEE 000#flowm006.];
     |SI FSalida = 0;
          |LEE 000#flowm006.a;
     |SINO;
          |LEE 000#flowm006.u;
     |FINSI;
     |SI FSalida = 0; |Y #flowm006#0  = #55#0;
          nLinea = #flowm006#1 + 1;
          nSitu = #flowm006#2;
     |SINO;
          nSitu = 1;
          nLinea = 1;
     |FINSI;
     |DDEFECTO #flowm006;
     #flowm006#0  = #55#0;
     #flowm006#1  = nLinea;
     |LEE 101#flowm006.=;
     |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
     #flowm006#2  = nSitu;
     #flowm006#3  = ~;
     #flowm006#4  = aHora;
     #flowm006#5  = aUsuario;
     aDocHis = ("000000000" + #55#0) % -109;
     #flowm006#6  = "VISUALIZADO DOCUMENTO: " + aDocHis;

     enNumRegFlow = #flowm006#0;
     enSituFlow = #flowm006#2;
     |HAZ DimeDesFlow;
     #flowm006#7 = eaDesSituFlow;

     |GRABA 020#flowm006.a;
     |LIBERA #flowm006;
     |CIERRA #flowm006;

     aEjecuta = "START " + eaUnidad + ":\DOCUMENTOS\DSARCHI\dsabreextension ";
     aEjecuta = aEjecuta + aFicheroVer;
     aEjecuta = aEjecuta + " " + eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";

     aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;

     |RSYSTEM aEjecuta;
     aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
     |PARA;  |SI;  |HACIENDO;
             |XABRE "EC", aAlfa, nHandle;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             |PARA nPausa = 1; |SI nPausa < 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;
             |PULSATECLA;
     |SIGUE;
     |PULSATECLA;

     aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;
|FPRC;


|PROCESO BotonHis1;
     ||Ver documentos
     |VENTANA 0501, 2999, -1, 16, "Visualizando Documento";
     nVentz1  = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PINPA #0#908;
     |PINDA #0#908;
     |PTEC 802;
     |PAUSA;

     |HAZ PresentaDocumentoHis;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentz1;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentana;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;
|FPRC;

|PROCESO BotonHis2;
     ||A¤adir
     nModoHis = 1;
     |PTEC 806;
|FPRC;

|PROCESO BotonHis3;
     ||Sustituir
     nModoHis = 2;
     |PTEC 806;
|FPRC;

|PROCESO Baja55;
     #55#0 = 000000001;
|FPRC;

|PROCESO Alta55;
     #55#0 = 999999999;
|FPRC;

|PROCESO Evento55;
     |SI FSalida = 1; |O FSalida = 2;
          |LEE 000#55.=;
          |SI FSalida = 0;
               |ESTADO_CONTROL nBotonHis1, "ENABLE";
               |ESTADO_CONTROL nBotonHis3, "ENABLE";
          |SINO;
               |ESTADO_CONTROL nBotonHis1, "DISABLE";
               |ESTADO_CONTROL nBotonHis3, "DISABLE";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ClinicaHisYaIntro;
     nSwHayDocs = 0;
     |BUCLE dsarm005_hay;

     |SI nSwHayDocs = 1;
          |DBASE aBase;
          |QBF aBase;
          aDef = aBase + "def/dsarm005";
          |CARGA_DEF aDef, otrodef@;
          |SI FSalida ! 0;
               aMensaje = "0000Problema carga_def <dsarm005>. Ctrl.HistoriasCli";
               |MENAV aMensaje;
               |ACABA;
          |FINSI;

          |HAZ CreaTempo;
          aTempo55 = Tempo;
          |NOME_DAT #55 aTempo55;
          |DELINDEX #55;

          |ABRE #55;
          ||Creo el temporal y lo relleno.
          nSwHayDocs = 0;
          |BUCLE dsarm005_mete;

          ||AHORA MUESTRO LA NUEVA PANTALLA.
          |ABRE #dsarm001;
          |DDEFECTO #dsarm001;
          |LEE 000#dsarm001.p;
          |CIERRA #dsarm001;
          aDesGST = "";
          |SI #dsarm001#8 = "S";
               |ABRE #dsarm002;
               |DDEFECTO #dsarm002;
               #dsarm002#0 = enGrupoVinExte;
               |LEE 000#dsarm002.=;
               aDesGST = #dsarm002#1;
               |QBF aDesGST;
               |CIERRA #dsarm002;
               |ABRE #dsarm003;
               |DDEFECTO #dsarm003;
               #dsarm003#0 = enGrupoVinExte;
               #dsarm003#1 = enSubGrupoVinExte;
               |LEE 000#dsarm003.=;
               aDesGST = aDesGST + "/" + #dsarm003#2;
               |QBF aDesGST;
               |CIERRA #dsarm002;
          |FINSI;
          |ABRE #dsarm004;
          |DDEFECTO #dsarm004;
          #dsarm004#0 = enGrupoVinExte;
          #dsarm004#1 = enSubGrupoVinExte;
          #dsarm004#2 = enTipoVinExte;
          |LEE 000#dsarm004.=;
          |SI aDesGST = "";
               aDesGST = #dsarm004#3;
          |SINO;
               aDesGST = aDesGST + "/" + #dsarm004#3;
          |FINSI;
          |QBF aDesGST;
          |CIERRA #dsarm004;

          |SI nSwHayDocs = 1;
               aLabel = "Ya existe un documento en " + aDesGST + " para la historia indicada: " + eaValorVinculo1;
          |SINO;
               aLabel = "Ya existen " + nSwHayDocs + " documentos en " + aDesGST + " para la historia indicada: " + eaValorVinculo1;
          |FINSI;

          |VENTANA 0501, 3299, -1, 16, "Tratamiento a realizar con el documento actual";
          nVentana = FSalida;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentana;
          aVent5 = "MODAL";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |DDEFECTO #dsarclw2;
          |PINPA #0#dsarclw2;
          nPanta = FSalida;
          |PINDA #0#dsarclw2;

          aLabel = "LABEL,{{15}}" + aLabel;
          |CONTROL_SIMPLE nPanta, aLabel, 0805, 0994, NULL;

          nRango = 4 + 8 + 16 + 32;
          nPos1 = 1002;
          nPos2 = 2998;
          |LINEAL_SIMPLE #1#55, nRango, nPos1, nPos2, Baja55, Alta55, Evento55;
          nGrid55 = FSalida;

          |CONTROL_SIMPLE nPanta, "BOTON,Ver Documento", 3002, 3014, BotonHis1;
          nBotonHis1 = FSalida;

          |CONTROL_SIMPLE nPanta, "BOTON,A¤adir", 3073, 3085, BotonHis2;
          nBotonHis2 = FSalida;

          |CONTROL_SIMPLE nPanta, "BOTON,Sustituir", 3086, 3098, BotonHis3;
          nBotonHis3 = FSalida;

          aEsc1  = &255 + "806";
          aEsc2  = &255 + "807";
          aRetu  = &255 + "802";
          |PARA; |SI;  |HACIENDO;
              FSalida = "::{{001}}Cancelar," + nGrid55;
              |LEETECLA aTecla;
              |SI aTecla = aEsc2; |O aTecla = aRetu;    ||Ctrl+Q o Cancelar
                   aMensaje = "0000NSeguro que desa anular la introduccion del documento?";
                   |CONFI aMensaje;
                   |SI FSalida = 0;
                        enErrorHisYaIntro = 1;
                        |SAL;
                   |SINO;
                        aTecla = "";
                   |FINSI;
              |FINSI;
              |SI aTecla = aEsc1;
                   |SI nModoHis = 0;
                        aTecla = "";              ||Esc. Aqui, No tiene sentido.
                                                  ||No hace nada.
                   |SINO;
                        |SI nModoHis = 1;         ||Anyadir. Okie. Funciona como siempre
                              enErrorHisYaIntro = 0;
                              enRegASustituir = 0;
                              |SAL;
                        |SINO;
                              |SI nModoHis = 2;
                                   aMensaje = "0000NDesea sustituir el documento fisico del registro [" + #55#0 + "] por el nuevo documento";
                                   |CONFI aMensaje;
                                   |SI FSalida = 0;
                                        enRegASustituir = #55#0;
                                        enErrorHisYaIntro = 0;
                                        |SAL;
                                   |SINO;
                                        aTecla = 0;
                                   |FINSI;
                              |SINO;
                                   aTecla = "";
                              |FINSI;
                        |FINSI;
                   |FINSI;
              |FINSI;
          |SIGUE;

          |FIN_CONTROL_WINDOWS nGrid55;
          |FIN_CONTROL_WINDOWS nBotonHis1;
          |FIN_CONTROL_WINDOWS nBotonHis2;
          |FIN_CONTROL_WINDOWS nBotonHis3;

          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentana;
          aVent5 = "MODELESS";
          |ESPECIFICA "ESTADO_VENTANA", aVent;

          |FINVENTANA nVentana;

          |CIERRA #55;
          |DELINDEX #55;
          Tempo = aTempo55;
          |HAZ BoraTempo;

          |DESCARGA_DEF #otrodef@;
     |FINSI;
|FPRC;
