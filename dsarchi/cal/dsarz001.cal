 ||Ahora gastare mejor convert (imagemagick)

||convert -verbose  -compress JPEG -page A4 000000279.TIF ultim2.pdf
||Tambien convierto a JPG.  O a TIFF individuales

||1 registro por pagina.   +adjoin

||En windows:
||tiff2pdf.exe 000000051.TIF -o estasi.pdf

|FICHEROS;
     dsarm000;
     dsarm001;                ||Parametros
     dsarm002;                ||Grupos Documentos
     dsarm003;                ||SubGrupos Documentos
     dsarm004;                ||Documentos (TIPO)
     dsarm005;                ||Registro Documentos
     dsarm007;                ||Asociacion Documentos
     dsarm021;                ||Aux.Campos Escaner
     dsarm029;                ||Plantillas AutoRelle
     dsarm030;
     dsarm031;
     dsarm065;                ||Plantillas RellConta
     dsarm100;                ||Contador Reg.Doc.

     dpntm001;

     dsarz010;

     dsarw005,MANTE;          ||Pantalla-Escanear
     dsarw007,MANTE;          ||Pantalla-Escanear
     dsarw008;                ||Pantalla Abriendo documento
     dsarw009;                ||Pantalla Escaneando documento
     dsarw041;
     dsarw048;
     dsarw058;
     dsarw112,MANTE;

     flowm006;

     dsarm005@;
     referen@;
     otrodef@;
     otromas@;
|FIN;

|VARIABLES;
     aUsuDebug = "";
     {20}aCampoObligatorio = "";
     {20}aNomCampo = "";
     nCampoPide = 0;
     nEstoy = 0;
     aPide = "";
     aLibre = "";
     nSwNoSigas = 0;
     aLiteral = "";
     aQuita = "";
     nSwHayLibObligados = 0;
     aCampoObli = "";

     nSwFaltaObligatorios = 0;
     nSwVengoDeOCR = 0;
     nSwHayIva = 0;
     nMeteImpoADConta = 0;
     nCampo67 = 0;
     nCampo68 = 0;
     nCampo69 = 0;
     fCampo70 = @;
     nCampo71 = 0;
     nCampo72 = 0;
     nCampo73 = 0;
     aCampo74 = "";

     &enSwEstaAV = 0;
     &eaSerieAV = "";
     &enNumeroAV = 0;
     &enEmpresaAV = 0;
     &enNumDSerpAV = 0;

     ||Archivado automativo.   Importacion ADCONTA. (Se usa en artenvas)
     &eaImpoAutoADConta = "";
     &enImpoEmpContagen = 0;
     &enImpoPercontagen = 0;
     &enNoMoverImpoADConta = 0; ||Indica si se deja en la carpeta importacion auto.
     &enImpoNumDoc = 0;         ||Documento a buscar en contagen
     aDirDatosFich = "";


     &enSwModoClinica = 0;      ||Se llamada desde parametros  CLINICAHHHH_EEEE
                                ||La llamada se hace desde una aplicacion externa
                                ||como GreenCube.
     &enHHHHClinica = 0;
     &enEEEEClinica = 0;
     &eaNomPaciente = "";
     &eaTxtSQL = "";

     aBaseConta = "";
     aDirConta = "";
     aDirDatos = "";
     aDef = "";
     nCampoC = 0;
     nCampoE = 0;
     nNumCampo = 0;
     nNumCampo2 = 0;
     aValorConta = "";
     aActual = "";

     &enSwPlantillaConta = 0;
     &enLibroConta = 0;
     &enDocumentoConta = 0;

     nSwEstoyVolverCapturar = 0;

     &enErrorHisYaIntro = 0;
     &enRegASustituir = 0;
     nVoy = 0;
     nCampo005 = 0;
     aAlfaDif = "";

     aDirSaca = "";
     aCampo = "";
     aNombre = "";

     nUltimoDoc = 0;          ||Contador

     &eaImpoAlbaVta = "";
     ||AutoSeleccionTipoSegunPlantillasAutoRelleno
     &eaAutoSelPlantilla = "";
     &eaUbicacionTempo = "";
     &eaNomFichero = "";
     aLetra = "";
     &enGrupoFiltro = 0;
     &enSubGrupoFiltro = 0;
     &enTipoFiltro = 0;

     ||Modo silencio
     &enSwModoSilencio = 0;
     &eaErrorDsEscan = "";
     &enNumRegDsEscan = 0;

     ||Control de Vinculos Externos.
     &enSwVinExteEspecial = 0;
     &enNumRegVincuExte = 0;
     &enSwVinculosExternos = 0;
     &eaTipoVinculo = "";
     &eaValorVinculo1 = "";
     &eaValorVinculo2 = "";
     &eaValorVinculoAux = "";
     &eaPosicionateVinculo1 = "";
     &eaPosicionateVinculo2 = "";
     &enGrupoVinExte = 0;
     &enSubGrupoVinExte = 0;
     &enTipoVinExte = 0;
     &enSwErrorVinExte = 0;

     aBorraCache = "";

     nContReal = 0;
     nContDos = 0;
     nCampoCom = 0;
     aSQL = "";
     aAuxDos = "";
     aTexto = "";
     nCampoDatos = 0;

     aAux2 = "";
     &enNumRegFlow = 0;
     &enSituFlow = 0;
     &eaDesSituFlow = "";

     nSwLogError = 0;
     aParaIni = "";
     aTextoIni = "";
     aPathDSSelect = "";

     nPrimeraVez = 0;
     aCarpetaCaptura = "";
     &enVoyPorDoc = 0;
     &enNumTotalDocs = 0;

     &enSwRealizadodsEscan = 0;
     &eaCarpetaOrigen = "";
     aSwdsEscan = "";

     &enBotonCancelar = 0;
     aDirBrowse = "";
     aBuscaCarpeta = "";

     &enNumRegistro = 0;
     aDocHis = "";
     &enNoClonarFlow = 0;
     nDocOrigenCopia = 0;
     nSitu = 0;
     &enSwDocModificado = 0;
     &enErrorCaptura = 0;
     &eaDocCaptura = "";
     &enErrorMod   = 0;

     nPant = 0;
     nVent = 0;

     nSwAcabaUnDocumento = 0;

     nRegDocu = 0;
     aMete31 = "";
     aValor = "";

     nSwNumVarios = 0;
     nSwMultiReg = 0;         ||Hay varios registros "REALES". Ya los he almacenado
                              ||no continuo con el proceso.

     aComodin = "";
     aExtenComodin = "";
     nSwEstaElCero = 0;
     aFicheroDestino = "";
     aPos            = "";

     aRutaConvert = "";
     nLong          = 0;
     nCarac         = 0;
     nPos           = 0;
     nDocu          = 0;
     nPanta907      = 0;
     &nPanta905_0    = 0;
     nBoton         = 0;
     nBoton1        = 0;
     nBoton2        = 0;
     nBoton3        = 0;
     nBoton4        = 0;
     nBoton5        = 0;
     nBoton6        = 0;
     nError         = 0;
     nHoja          = 0;
     nNumHoja       = 0;
     nLinea         = 0;
     nHandle        = 0;
     nCampo         = 0;
     nCampo1        = 0;
     nCampoD        = 0;
     nCampoH        = 0;
     nPos1          = 0;
     nPos2          = 0;
     nGraba         = 0;
     nSubVentz1     = 0;
     nVentz1        = 0;
     nID            = 0;
     nCambio        = 0;
     nPausa         = 0;
     nLabel1        = -1;
     nLabel2        = -1;
     nRango          = 0;
     nGrid           = 0;
     nModelo         = 0;
     nDModelo        = 0;
     nHModelo        = 0;
     nAux            = 0;
     nSwYaAvisado    = 0;
     nSwSolo1Doc     = 0;
     nDocNumero      = 0;
     nContaNum       = 0;
     nConta          = 0;
     nConta947       = 0;
     nGrupo          = 0;
     nSubGru         = 0;
     nTipoDoc        = 0;
     nVarios         = 0;
     nLibre1         = 0;
     nLibre2         = 0;
     nSwHay          = 0;
     nSwComparaRepe  = 0;
     nSwFinal        = 0;
     nAnyo           = 0;
     nEndatos        = 0;
     nLetra          = 0;
     nSaca           = 0;
     nResto          = 0;
     nPosiciona      = 0;
     nSalgo          = 0;

     aParametro      = "";
     aOrigen         = "";
     aDestino        = "";
     aExtension      = "";
     aNomDoc         = "";
     aFicheroVer     = "";
     aPideDocCarpeta = "";
     aLibre1         = "";
     aLibre2         = "";
     aValor1         = "";
     aValor2         = "";
     aUsuario        = "";
     aPrograma       = "";
     aDirLocal       = "";
     aBorra          = "";
     aEjecuta        = "";
     aTria           = "";
     aMensaje        = "";
     aFicheroPDF     = "";
     aDirBaseLocal   = "";
     aDocDestino     = "";
     aDocOrigen      = "";
     aSwScanPdf      = "";
     aAAAAMM         = "";
     aFechaSis       = "";
     aAux            = "";
     aVersion1       = "";
     aVersion2   = "";
     aBaseLocal  = "";
     aPara       = "";
     aSalida     = "";
     aAdjunto    = "";
     aCarac      = "";
     aProg       = "";
     aMas        = "";
     aFoto       = "";
     aID         = "";
     aFichSQL    = "";
     aPathBase   = "";
     aPideCli = "";
     aPideNif = "";
     aPideTra = "";
     aPideMod = "";
     aPideMin = "";
     aPideA1 = "";
     aPideA2 = "";
     aPideA3 = "";
     aPideA4 = "";
     aPideA5 = "";
     aPideA6 = "";
     aPideA7 = "";
     aPideA8 = "";
     aPideA9 = "";
     aPideA10 = "";
     aPideN1 = "";
     aPideN2 = "";
     aPideN3 = "";
     aPideN4 = "";
     aPideN5 = "";
     aPideF1 = "";
     aPideF2 = "";
     aPideF3 = "";
     aPideF4 = "";
     aPideF5 = "";
     aHora          = "";
     aUbicacion     = "";
     aPath          = "";
     aLong          = "";
     aAbre          = "";
     aSystem        = "";
     aCadena        = "";
     aEjercicio     = "";
     aPeriodo       = "";
     aFicRes        = "";
     aBusco         = "";
     aDat           = "";
     aEsc1          = "";
     aEsc2          = "";
     aRetu          = "";
     aAlfa          = "";
     aAlfa1         = "";
     aFichero       = "";
     aFicheroP      = "";
     aFicheroT      = "";
     aFicheroTif    = "";
     aTecla         = "";
     aTipoScaneo    = "";
     aTipoScaneoT   = "";
     aPathRemoto    = "";
     aIPRemoto      = "";
     aBase          = "";
     aCR            = "";
     aLF            = "";
     aDni           = "";
     aJusti         = "";
     aMarca         = "";
     aContenido     = "";
     aAuxActual     = "";
     aTextoActual   = "";
     aSaca          = "";

     fFechaSis       = @;

     {1}aContiene    = "";
     {1}aLocal       = "";
     {6}aPopTria     = "";

     {-1}get         = 0;
     get1            = 0;
     get2            = 0;

     {-1}aVent       = "";
         aVent1      = 0;
         aVent2      = 0;
         aVent3      = 0;
         aVent4      = 0;
         aVent5      = "";

     &eaFicheroEscaner = "";
     &enSwIOCorrecta   = 0;
     &eaSwBorroOrigen  = "";
     &enSwADConta      = 0;
     &enEmpADConta     = 0;
     &enEjeADConta     = 0;
     &eaUnidad         = "";
     &enError          = 0;
     &enSeguir         = 0;
     &enGrupo          = 0;
     &enSubGrupo       = 0;
     &enTipo           = 0;
     &enEscaneo        = 0;
     &enDocumento      = 0;
     &enDocuPpal       = 0;
     &eaOrigen         = "";
     &eaDestino        = "";
     &eaConversorPDF   = "";
     &enSwEstaIntegral = 0;
     &enSwEstaBasica   = 0;
     &enDESPANET       = 0;
     &eaUnidadBasico   = "";
     &enPrevisualizar  = 0;
     &enDesdeCapturador = 0;
     &eaUsuArchivado   = "";
     &eaNomDef         = "";
     &eaRuta           = "";
     &eaDocPC          = "";
     &enEmpresa        = 0;
     &eaNif            = "";
     &eaTipo           = "";
|FIN;

|PROCESO Duplicados;
     aAlfa = "dsarm005";
     |NOME_DAT #dsarm005#aAlfa#;

     aFichSQL = ("BB" + Usuario) % 108;

     aAlfa  = "SELECT * FROM dsarm005 INTO " + aFichSQL + " WHERE ";

     aAlfa  = aAlfa + "1 == " + #dsarw005#56;
     aAlfa  = aAlfa + " AND 2 == " + #dsarw005#58;
     aAlfa  = aAlfa + " AND 3 == " + #dsarw005#60;
     aAlfa  = aAlfa + " AND 8 == " + #dsarw005#3;
     aAlfa  = aAlfa + " AND 15 == " + #dsarw005#15;
     aAlfa  = aAlfa + " AND 19 == " + #dsarw005#19;
     aAlfa  = aAlfa + " AND 17 == " + #dsarw005#17;
     aAlfa  = aAlfa + " AND 18 == " + #dsarw005#18;
     aAlfa  = aAlfa + " AND 20 == " + #dsarw005#20;
     aAlfa  = aAlfa + " AND 10 == " + #dsarw005#11;
     aAlfa  = aAlfa + " AND 39 == " + #dsarw005#54;
     aAlfa  = aAlfa + " AND 40 == " + #dsarw005#55;
     aAlfa  = aAlfa + " AND 99 == " + #dsarw005#80;
     |SQL aAlfa;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/dsarm005.mas";
     |CARGA_DEF aMas, dsarm005@;

     |NOME_DAT #dsarm005@#aFichSQL#;
     |ABRE #dsarm005@;
     |LEE 000#dsarm005@.u;
     |SI FSalida = 0;
         |SI #dsarm001#193 = "S";
             |CONFI "0000NEl Documento es £nico y ya existe el documento, reemplazar";
             |SI FSalida ! 0;
                 nGraba = 1;
             |SINO;
                 nCambio = #dsarm005@#0;
             |FINSI;
         |SINO;
             |MENAV "0000El documento es £nico y ya existe el documento, se reemplaza por el anterior";
             nCambio = #dsarm005@#0;
         |FINSI;
     |FINSI;
     |CIERRA #dsarm005@;
     |DELINDEX #dsarm005@;

     |DESCARGA_DEF #dsarm005@;
|FPRC;

|PROCESO VerifLibres;
     nContDos = nContDos + 1;
     aAux = #dsarm004#nCampo#;
     |QBF aAux;
     |SI aAux ! "";
          nContReal = nContReal + 1;

          |SI nContDos < 6;
               nCampoCom = nCampo + 30;
          |SINO;
               |SI nContDos < 11;
                    nCampoCom = nCampo + 13;
               |SINO;
                    nCampoCom = nCampo + 35;
               |FINSI;
          |FINSI;

          aAuxDos = #dsarm004#nCampoCom#;
          |SI aAuxDos = "S";
               |SI nContReal < 16;
                    nCampo1 = 22 + nContReal;
               |SINO;
                    nCampo1 = 44 + nContReal;
               |FINSI;

               aTexto = aAux;
               |QBF aTexto;

               |SI aLibre1 = "";
                    aLibre1 = aTexto;
               |SINO;
                    aLibre1 = aLibre1 + " " + aTexto;
               |FINSI;

               aTexto = aTexto + ": ";

               |SI nContDos < 6;
                    nCampoDatos = nCampo + 18 + nContDos;
               |SINO;
                    |SI nContDos < 11;
                         nCampoDatos = nCampo + 34 + nContDos;
                    |SINO;
                         nCampoDatos = nCampo + 13 + nContDos;
                    |FINSI;
               |FINSI;
               aTexto = aTexto + #dsarw005#nCampoDatos#;
               |QBF aTexto;

               aSQL  = aSQL + " AND " + nCampo1 + " == " + aTexto;
               |QBF aSQL;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ComparaCamposRepe;

     nLibre1 = 0;
     nLibre2 = 0;
     nSwHay = 0;

     |PARA nCampo = 35; |SI nCampo [ 54; |HACIENDO nCampo = nCampo + 1;
          aAux = #dsarm004#nCampo#;
          |QBF aAux;
          |SI aAux = "S";
               nSwHay = 1;
               |SAL;
          |FINSI;
     |SIGUE;

     |SI nSwHay = 0;
          aAux = #dsarm004#82; |SI aAux = "S"; nSwHay = 1; |FINSI;
          aAux = #dsarm004#83; |SI aAux = "S"; nSwHay = 1; |FINSI;
          aAux = #dsarm004#84; |SI aAux = "S"; nSwHay = 1; |FINSI;
     |FINSI;

     |SI nSwHay = 0;
          |ACABA;
     |FINSI;

     ||Hacer la SQL.
     aAlfa = "dsarm005";
     |NOME_DAT #dsarm005#aAlfa#;

     aFichSQL = ("CC" + Usuario) % 108;

     aSQL  = "SELECT * FROM dsarm005 INTO " + aFichSQL + " WHERE ";

     aSQL  = aSQL + "1 == " + #dsarw005#56;
     aSQL  = aSQL + " AND 2 == " + #dsarw005#58;
     aSQL  = aSQL + " AND 3 == " + #dsarw005#60;


     nContReal = 0;
     nContDos = 0;
     |PARA nCampo = 5;  |SI nCampo [ 9;  |HACIENDO nCampo = nCampo + 1;
          |HAZ VerifLibres;
     |SIGUE;
     |PARA nCampo = 27;  |SI nCampo [ 31;  |HACIENDO nCampo = nCampo + 1;
          |HAZ VerifLibres;
     |SIGUE;
     |PARA nCampo = 10;  |SI nCampo [ 19;  |HACIENDO nCampo = nCampo + 1;
          |HAZ VerifLibres;
     |SIGUE;

     aAux = #dsarm004#82;
     |SI aAux = "S";
          aTexto = "COD.CLIENTE";
          |SI aLibre1 = "";
               aLibre1 = aTexto;
          |SINO;
               aLibre1 = aLibre1 + " " + aTexto;
          |FINSI;

          aSQL  = aSQL + " AND " + 8 + " == " + #dsarw005#3;
          |QBF aSQL;
     |FINSI;

     aAux = #dsarm004#83;
     |SI aAux = "S";
          aTexto = "NIF";
          |SI aLibre1 = "";
               aLibre1 = aTexto;
          |SINO;
               aLibre1 = aLibre1 + " " + aTexto;
          |FINSI;

          aSQL  = aSQL + " AND " + 10 + " == " + #dsarw005#11;
          |QBF aSQL;
     |FINSI;

     aAux = #dsarm004#84;
     |SI aAux = "S";
          aTexto = "COD.TRABAJADOR";
          |SI aLibre1 = "";
               aLibre1 = aTexto;
          |SINO;
               aLibre1 = aLibre1 + " " + aTexto;
          |FINSI;

          aSQL  = aSQL + " AND " + 15 + " == " + #dsarw005#15;
          |QBF aSQL;
     |FINSI;

     aMensaje = "0000SQL:" + aSQL;
     ||MENAV aMensaje;
     |SQL aSQL;

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/dsarm005.mas";
     |CARGA_DEF aMas, dsarm005@;

     |NOME_DAT #dsarm005@#aFichSQL#;
     |ABRE #dsarm005@;
     |LEE 000#dsarm005@.u;
     |SI FSalida = 0;
         nSwComparaRepe = 1;
     |FINSI;
     |CIERRA #dsarm005@;
     |DELINDEX #dsarm005@;
     |DESCARGA_DEF #dsarm005@;
|FPRC;

|PROCESO Tipo12w15;  |TIPO 12;
     nGraba = 0;

     |SI FSalida = 7;
         nGraba = 1;
         |ACABA;
     |FINSI;

     nSwYaAvisado = 0;

     nError = 0;
     |SI aPideCli = "S";
         |SI #dsarw005#3 = 0;
              |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <Codigo Cliente> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
              |FINSI;
              nError = 1;
         |FINSI;
     |FINSI;

     |SI aPideNif = "S";
         |SI #dsarw005#11 = "            ";
              |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <NIF> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
              |FINSI;
              nError = 1;
         |FINSI;
     |FINSI;

     |SI aPideTra = "S";
         |SI #dsarw005#15 = 0;
              |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <Trabajador> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
              |FINSI;
              nError = 1;
         |FINSI;
     |FINSI;

     |SI aPideMod = "S";
         |SI #dsarw005#19 = 0;
              |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <Modelo> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
              |FINSI;
              nError = 1;
         |FINSI;
         |SI #dsarw005#17 = 0;
              |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <Ejercicio> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
              |FINSI;
              nError = 1;
         |FINSI;
         |SI #dsarw005#18 = 0;
              |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <Periodo> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
              |FINSI;
              nError = 1;
         |FINSI;
     |FINSI;
     |SI aPideA1 = "S";
          aAux = #dsarw005#24;
          |QBF aAux;
          |SI aAux = "";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#23;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideA2 = "S";
          aAux = #dsarw005#26;
          |QBF aAux;
          |SI aAux = "";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#25;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideA3 = "S";
          aAux = #dsarw005#28;
          |QBF aAux;
          |SI aAux = "";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#27;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideA4 = "S";
          aAux = #dsarw005#30;
          |QBF aAux;
          |SI aAux = "";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#29;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideA5 = "S";
          aAux = #dsarw005#32;
          |QBF aAux;
          |SI aAux = "";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#31;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideA6 = "S";
          aAux = #dsarw005#67;
          |QBF aAux;
          |SI aAux = "";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#66;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideA7 = "S";
          aAux = #dsarw005#69;
          |QBF aAux;
          |SI aAux = "";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#68;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideA8 = "S";
          aAux = #dsarw005#71;
          |QBF aAux;
          |SI aAux = "";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#70;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideA9 = "S";
          aAux = #dsarw005#73;
          |QBF aAux;
          |SI aAux = "";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#72;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideA10 = "S";
          aAux = #dsarw005#75;
          |QBF aAux;
          |SI aAux = "";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#74;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideN1 = "S";
          nAux = #dsarw005#34;
          |SI nAux = 0;
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#33;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideN2 = "S";
          nAux = #dsarw005#36;
          |SI nAux = 0;
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#35;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideN3 = "S";
          nAux = #dsarw005#38;
          |SI nAux = 0;
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#37;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideN4 = "S";
          nAux = #dsarw005#40;
          |SI nAux = 0;
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#39;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideN5 = "S";
          nAux = #dsarw005#42;
          |SI nAux = 0;
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#41;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideF1 = "S";
          aAux = #dsarw005#44;
          |QBF aAux;
          |SI aAux = "01.01.0000";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#43;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideF2 = "S";
          aAux = #dsarw005#46;
          |QBF aAux;
          |SI aAux = "01.01.0000";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#45;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideF3 = "S";
          aAux = #dsarw005#48;
          |QBF aAux;
          |SI aAux = "01.01.0000";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#47;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideF4 = "S";
          aAux = #dsarw005#50;
          |QBF aAux;
          |SI aAux = "01.01.0000";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#49;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;
     |SI aPideF5 = "S";
          aAux = #dsarw005#52;
          |QBF aAux;
          |SI aAux = "01.01.0000";
               |SI nSwYaAvisado = 0;
                    aMensaje = "0000Atenci¢n, campo <" + #dsarw005#51;
                    |QBF aMensaje;
                    aMensaje = aMensaje + "> obligatorio. Introduzca valor.";
                    |MENAV aMensaje;
                    nSwYaAvisado = 1;
               |FINSI;
               nError = 1;
          |FINSI;
     |FINSI;

     |SI nError = 1;
         nSwYaAvisado = 0;
         nGraba = 2;
         |CONFI "0000NHay campos que deben ser informados, desea cancelar el proceso.";
         |SI FSalida = 0;
             nGraba = 1;
         |FINSI;
         |ACABA;
     |FINSI;

     |XABRE "EC", aFichero, nHandle;
     |SI FSalida < 0;
         |MENAV "0000No hay fichero asociado, cancelo el proceso.";
         nGraba = 1;
         |ACABA;
     |FINSI;

     ||IPFACTUR Y FACGES
     |SI #dsarm001#192 = "S";
          |SI #dsarm001#3 = "S"; |Y #dsarm001#4 = #dsarm004#0; |Y #dsarm001#5 = #dsarm004#1; |Y #dsarm001#6 = #dsarm004#2;
               nCambio = 0;
               |HAZ Duplicados;
               |SI nGraba = 1; |ACABA;  |FINSI;
          |FINSI;
          |SI #dsarm001#46 = "S"; |Y #dsarm001#48 = #dsarm004#0; |Y #dsarm001#49 = #dsarm004#1; |Y #dsarm001#50 = #dsarm004#2;
               nCambio = 0;
               |HAZ Duplicados;
               |SI nGraba = 1; |ACABA;  |FINSI;
          |FINSI;
     |FINSI;

     |SI #dsarm001#25 = "S";
          aLibre1 = "";
          aLibre2 = "";
          nSwComparaRepe = 0;
          |HAZ ComparaCamposRepe;
          |SI nSwComparaRepe = 1;
               aLibre1 = aLibre1 % 180;
               |QBF aLibre1;
               aMensaje = "0000Atenci¢n: Control campos repetidos [" + aLibre1 + "]";
               |MENAV aMensaje;
               nError = 1;
               nGraba = 2;
               |ACABA;
          |FINSI;
     |FINSI;

     |CONFI "0000SConforme con lo introducido";
     |SI FSalida ! 0;
         nGraba = 2;
         |CONFI "0000NCancelo el proceso";
         |SI FSalida = 0;
             nGraba = 1;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO EscaneoPlana;

     |RFBORRA aFichero;

                        aTipoScaneo = "[SCANUI]";
     |SI #dsarw005#2 = "N";  aTipoScaneo = "[SCAN]";   |FINSI;

     aSwScanPdf = #dsarw005#77;

     nError = 0;
     |CARGADLL "dstwain.dll";
     |SI FSalida < 0;
         nError = 1;
         |MENAV "     No encuentro el driver : dstwain.dll";
         |ACABA;
     |FINSI;

     nHoja    = 1;
     nSwFinal = 0;
     |PARA; |SI nSwFinal = 0; |HACIENDO;
           nHoja = nHoja + 1;

           aTipoScaneoT = aTipoScaneo;

           |ALFACALLDLL "dstwain.dll","DsTwainEntry", aTipoScaneoT;
           |SI FSalida < 0;
               nError = 1;
               |MENAV "     No encuentro el SCANNER";
               |SAL;
           |FINSI;

           |SI aTipoScaneoT = "OK";
               aAlfa = "[SAVE:" + aFicheroP; |QBF aAlfa;
               aAlfa = aAlfa + "]";
               |ALFACALLDLL "dstwain.dll", "DsTwainEntry", aAlfa;
           |FINSI;

           |SI nHoja [ #dsarw005#1;
               aMensaje = "0000SIntroduzca la hoja numero: " + nHoja + " en el Escaner. Continuar?";
               |CONFI aMensaje;
               |SI FSalida ! 0;
                    nSwFinal = 1;
               |FINSI;
           |SINO;
               aMensaje = "0000NDesea seguir escaneando m s Hojas?";
               |CONFI aMensaje;
               |SI FSalida ! 0;
                    nSwFinal = 1;
               |FINSI;
           |FINSI;
     |SIGUE;

     |DESCARGADLL "dstwain.dll";

     |SI eaTipoVinculo = "CLINICA";
          |SI enSwVinExteEspecial = 1; |Y nSwEstoyVolverCapturar = 0;
               ||Controlamos si para el G/S/T ya existe algun documento
               ||para la historia en cuestion que estamos introduciendo.
               enErrorHisYaIntro = 0;
               |HAZ ClinicaHisYaIntro;
               |SI enErrorHisYaIntro = 1;
                    nError = 1;
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #dsarw005#77 ! "T"; |O #dsarw005#79 = "S";
          |HAZ ConvierteFormatos;
     |SINO;
          ||Plantillas Auto-Relleno
          |SI #dsarm004#78 ! 0;         ||Plantillas Auto-Relleno
               |HAZ GrabaLineaDocumento;
               nSwMultiReg = 1;         ||Ya lo ha almacenado. Tiene que terminar.
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO EscaneoTrasera;
     |RFBORRA aFichero;

                        aTipoScaneo = "[SCANUI]";
     |SI #dsarw005#2 = "N";  aTipoScaneo = "[SCAN]";   |FINSI;

     aSwScanPdf = #dsarw005#77;

     nError = 0;
     |CARGADLL "dstwain.dll";
     |SI FSalida < 0;
         nError = 1;
         |MENAV "     No encuentro el driver : dstwain.dll";
         |ACABA;
     |FINSI;

     aTipoScaneoT = aTipoScaneo;

     aAlfa = "[AUTOSAVE:" + aFicheroT; |QBF aAlfa;
     aAlfa = aAlfa + "]";
     |ALFACALLDLL "dstwain.dll","DsTwainEntry", aAlfa;

     |ALFACALLDLL "dstwain.dll","DsTwainEntry", aTipoScaneoT;
     |SI FSalida < 0;
         nError = 1;
         |MENAV "     No encuentro el SCANNER";
         |ACABA;
     |FINSI;

     |DESCARGADLL "dstwain.dll";

     |SI eaTipoVinculo = "CLINICA";
          |SI enSwVinExteEspecial = 1; |Y nSwEstoyVolverCapturar = 0;
               ||Controlamos si para el G/S/T ya existe algun documento
               ||para la historia en cuestion que estamos introduciendo.
               enErrorHisYaIntro = 0;
               |HAZ ClinicaHisYaIntro;
               |SI enErrorHisYaIntro = 1;
                    nError = 1;
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #dsarw005#77 ! "T"; |O #dsarw005#79 = "S";
          |HAZ ConvierteFormatos;
     |SINO;
          ||Plantillas Auto-Relleno
          |SI #dsarm004#78 ! 0;         ||Plantillas Auto-Relleno
               |HAZ GrabaLineaDocumento;
               nSwMultiReg = 1;         ||Ya lo ha almacenado. Tiene que terminar.
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BorraFicherosFisicos;
     |R_PDIR aBorra;
     |PARA; |SI FSalida = 0; |HACIENDO;
          |RFBORRA aBorra;
          |R_SDIR aBorra;
     |SIGUE;
|FPRC;

|PROCESO RecorreRegistros;
     aFicheroDestino = aDirBaseLocal + aComodin + "*." + aExtenComodin;
     |R_PDIR aFicheroDestino;
     |PARA; |SI FSalida = 0; |HACIENDO;
          aFichero = aFicheroDestino;
          |HAZ GrabaLineaDocumento;
          |R_SDIR aFicheroDestino;
     |SIGUE;
|FPRC;

|PROCESO EstaElCero;
     aBusco = aDirBaseLocal + aComodin + "-0." + aExtenComodin;
     |XABRE "EC", aBusco, nHandle;
     |SI FSalida < 0;
          nSwEstaElCero = 0;
     |SINO;
          nSwEstaElCero = 1;
     |FINSI;
|FPRC;

|PROCESO EscaneoUnRegistroPPagina;
     nSwMultiReg = 0;

     aComodin = "dsmultiplepagina";

     aSwScanPdf = #dsarw005#77;
     |SI aSwScanPdf = "P";
          aExtenComodin = "pdf";
     |SINO;
          |SI aSwScanPdf = "J";
               aExtenComodin = "jpg";
          |SINO;
               aExtenComodin = "tif";
          |FINSI;
     |FINSI;

     aBorra = aDirBaseLocal + aComodin + "*.*";
     |HAZ BorraFicherosFisicos;

     aFicheroDestino = aDirBaseLocal + aComodin + "." + aExtenComodin;

     |SI aSwScanPdf ! "T";
          aEjecuta = aRutaConvert + " +adjoin -compress JPEG -page A4 " + aFichero + " " + aFicheroDestino;
     |SINO;
          aEjecuta = aRutaConvert + " +adjoin " + aFichero + " " + aFicheroDestino;
     |FINSI;

     |RSYSTEM aEjecuta;

     |SLEEP 3;

     nSwEstaElCero = 0;
     |HAZ EstaElCero;

     |SI nSwEstaElCero = 0;
          ||Plantillas Auto-Relleno
          aFichero = aFicheroDestino;
          |SI #dsarm004#78 ! 0;         ||Plantillas Auto-Relleno
               |HAZ GrabaLineaDocumento;
               nSwMultiReg = 1;         ||Ya lo ha almacenado. Tiene que terminar.
          |FINSI;
     |SINO;
          |HAZ RecorreRegistros;
          nSwMultiReg = 1;
     |FINSI;

     ||Ahora Busco el cero, para averiguar si hay mas de un registro.
     ||Carga la variable nSwMultiReg
|FPRC;

|PROCESO ConvierteFormatos;
     ||Antes se usaba el ConvierteaPDF

     |HAZ DimeUnidad;
     aDirBaseLocal = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aDirBaseLocal;
     aDirBaseLocal = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aDirBaseLocal;
     aDirBaseLocal = eaUnidad + ":\DOCUMENTOS\DSARCHI\";
     aRutaConvert = aDirBaseLocal + "imagemagick/convert.exe";

     |SI #dsarw005#79 = "S";
          |HAZ EscaneoUnRegistroPPagina;
     |SINO;
          aEjecuta = aRutaConvert + " -compress JPEG -page A4 " + aFichero + " " + aFicheroPDF;

          ||ESTO NO VA FINO. VA FATAL. HACE COSAS RARAS
          ||aEjecuta = aEjecuta + " > " + aDirBaseLocal + "convert.log 2> " + aDirBaseLocal + "convert.err";

          |RSYSTEM aEjecuta;

          |SLEEP 3;

          |XABRE "EC", aFicheroPDF, nHandle;
          |SI FSalida < 0;
              |MENAV "0000Problemas al convertir el documento a formato PDF";
          |SINO;
               aFichero = aFicheroPDF;
          |FINSI;

          ||Plantillas Auto-Relleno
          |SI #dsarm004#78 ! 0;         ||Plantillas Auto-Relleno
               |HAZ GrabaLineaDocumento;
               nSwMultiReg = 1;         ||Ya lo ha almacenado. Tiene que terminar.
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Escaneo;
     eaCarpetaOrigen = "<ESCANER>";

     |ABRE #dsarm004;
     |DDEFECTO #dsarm004;
     #dsarm004#0 = enGrupo;
     #dsarm004#1 = enSubGrupo;
     #dsarm004#2 = enTipo;
     |LEE 000#dsarm004.=;
     |CIERRA #dsarm004;

     |SI #dsarw005#8 = "P";  |HAZ EscaneoPlana;    |FINSI;
     |SI #dsarw005#8 = "T";  |HAZ EscaneoTrasera;  |FINSI;
|FPRC;

|PROCESO CalculaDocNum;
     ||Recalcula el Numero de documento en la carpeta.

     |DBASE aBase;  |QBF aBase;
     aMas = aBase + "def/dsarm005.mas";
     |CARGA_DEF aMas, referen@;
     |SI FSalida = 0;
          nGrupo = #dsarm005#1;
          nSubGru = #dsarm005#2;
          nTipoDoc = #dsarm005#3;

          |ABRE #referen@;
          |SELECT #2#referen@;
          #referen@#1 = nGrupo;
          #referen@#2 = nSubGru;
          #referen@#3 = nTipoDoc;
          #referen@#0 = 999999999;
          |LEE 000#referen@.];
          |SI FSalida = 0;
               |LEE 000#referen@.a;
          |SINO;
               |LEE 000#referen@.u;
          |FINSI;
          |SI #referen@#0 = #dsarm005#0;       ||Tiquet 2805.2670.
               |LEE 000#referen@.a;
          |FINSI;

          nContaNum = 0;
          |SI FSalida = 0;  |Y #referen@#1 = nGrupo;  |Y #referen@#2 = nSubGru; |Y #referen@#3 = nTipoDoc;
               nContaNum = #referen@#47;
          |FINSI;
          |CIERRA #referen@;

          nDocNumero = nContaNum + 1;
          |DESCARGA_DEF #referen@;
     |FINSI;
|FPRC;

|PROCESO GrabaDocumento;
     |SI enEscaneo = 1;
         ||Si no sabemos lo que es, averiguarlo a traves de la extension
         |SI aSwScanPdf = "N";
              aAlfa  = (aFichero % -104) > "";
              aAlfa1 = aAlfa % 101;
              |SI aAlfa1 ! ".";
                  aAlfa  = (aFichero % -105) > "";
              |FINSI;
              aFicheroTif = (("000000000" + nDocu) % -109) + aAlfa;
         |SINO;
              |SI aSwScanPdf = "P";
                   aFicheroTif = (("000000000" + nDocu) % -109) + ".PDF";
              |SINO;
                   |SI aSwScanPdf = "J";
                        aFicheroTif = (("000000000" + nDocu) % -109) + ".JPG";
                   |SINO;
                        aFicheroTif = (("000000000" + nDocu) % -109) + ".TIF";
                   |FINSI;
              |FINSI;
         |FINSI;
     |SINO;
         aAlfa  = (aFichero % -104) > "";
         aAlfa1 = aAlfa % 101;
         |SI aAlfa1 ! ".";
             aAlfa  = (aFichero % -105) > "";
         |FINSI;

         aFicheroTif = (("000000000" + nDocu) % -109) + aAlfa;
     |FINSI;

     |QBT aFicheroTif;

     aUbicacion = "";
     |HAZ SacaUbicacion;

     |VENTANA 1210, 1490, 1, 17, ""; nVent = FSalida;
     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;
     |PINPA #0#dsarw041; nPant = FSalida;

     aAlfa = "LABEL,{{1}}Procesando Envio Documento. Por Favor Espere";
     nPos1 = 0503; nPos2 = 0580;
     |CONTROL_SIMPLE nPant, aAlfa, nPos1, nPos2, NULL;
     nLabel1 = FSalida; nLabel2 = -1;
     |PTEC 802; |PAUSA; |PULSATECLA;

     eaDestino    = aFichero;
     eaOrigen     = aUbicacion + aFicheroTif;
     enSwIOCorrecta    = 0;
     enSwDocModificado = 0;
     |HAZ RecibeConMD5;

     aVent4 = nVent;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |SI nLabel2 ! -1; |FIN_CONTROL_WINDOWS nLabel2; |FINSI;
     |FIN_CONTROL_WINDOWS nLabel1;
     |FINVENTANA nVent;
     |SI enSwDocModificado = 1;
          ||Historico
          |HORA aHora;
          aUsuario = Usuario % 810;
          |ABRE #flowm006;
          #flowm006#0  = #dsarm005#0;
          #flowm006#1  = 99999;
          |LEE 000#flowm006.];
          |SI FSalida = 0;
               |LEE 000#flowm006.a;
          |SINO;
               |LEE 000#flowm006.u;
          |FINSI;
          |SI FSalida = 0; |Y #flowm006#0  = #dsarm005#0;
               nLinea = #flowm006#1 + 1;
               nSitu = #flowm006#2;
          |SINO;
               nSitu = 0;
               nLinea = 1;
          |FINSI;
          |DDEFECTO #flowm006;
          #flowm006#0  = #dsarm005#0;
          #flowm006#1  = nLinea;
          |LEE 101#flowm006.=;
          |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
          #flowm006#2  = nSitu;
          #flowm006#3  = ~;
          #flowm006#4  = aHora;
          #flowm006#5  = aUsuario;
          |SI enSwIOCorrecta = 0;
               #flowm006#6  = "RESULTADO ALTA [ERROR]";
          |SINO;
               #flowm006#6  = "RESULTADO ALTA [CORRECTO]";
          |FINSI;

          enNumRegFlow = #flowm006#0;
          enSituFlow = #flowm006#2;
          |HAZ DimeDesFlow;
          #flowm006#7 = eaDesSituFlow;

          |GRABA 020#flowm006.a;
          |LIBERA #flowm006;
          |CIERRA #flowm006;
     |FINSI;
     |SI enSwIOCorrecta = 0;
         |MENAV "0000 Ha habido un error al transferir el documento al servidor. Revise Permisos y espacio disponible.";
         |BORRA 020#dsarm005.a;
         |LIBERA #dsarm005;
         |ACABA;
     |FINSI;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |SI #dsarm001#7 = "N";  |Y aIPRemoto ! "";
         |XABRE "E", eaOrigen, nHandle;
     |SINO;
         |XABRE "EC", eaOrigen, nHandle;
     |FINSI;

     |SI FSalida < 0;
         |MENAV "0000 Ha habido un error al transferir el documento al servidor. Intentelo de nuevo";
         |BORRA 020#dsarm005.a;
         |LIBERA #dsarm005;
         |ACABA;
     |FINSI;

     |HORA aHora;
     aHora = aHora % 105;

     #dsarm005#1   = enGrupo;
     #dsarm005#2   = enSubGrupo;
     #dsarm005#3   = enTipo;
     #dsarm005#4   = ~;
     #dsarm005#5   = aHora;
     #dsarm005#6   = Usuario % 810;
     #dsarm005#7   = aUbicacion;
     #dsarm005#8   = #dsarw005#3;
     #dsarm005#9   = aFicheroTif;
     #dsarm005#10  = #dsarw005#11;
     #dsarm005#11  = #dsarw005#12;
     #dsarm005#12  = #dsarw005#13;
     #dsarm005#13  = #dsarw005#14;
     #dsarm005#14  = #dsarw005#9;
     #dsarm005#15  = #dsarw005#15;
     #dsarm005#16  = #dsarw005#16;
     #dsarm005#17  = #dsarw005#17;
     #dsarm005#18  = #dsarw005#18;
     #dsarm005#19  = #dsarw005#19;
     #dsarm005#20  = #dsarw005#20;
     #dsarm005#21  = #dsarw005#21;
     #dsarm005#22  = #dsarw005#22;
     #dsarm005#38  = #dsarw005#53;
     #dsarm005#39  = #dsarw005#54;
     #dsarm005#40  = #dsarw005#55;
     #dsarm005#95  = #dsarw005#78;        || Nif Trabajador
     #dsarm005#99  = #dsarw005#80;        || Centro
     #dsarm005#100 = #dsarw005#81;        || Centro

     |SI aProg ! "";
          #dsarm005#93 = aProg;
          aProg = "";
     |FINSI;

     nCampoH   = 22;
     |PARA nCampoD = 23; |SI nCampoD [ 32;  |HACIENDO nCampoD = nCampoD + 1;
           aAlfa     = #dsarw005#nCampoD#;  |QBF aAlfa;
           nCampoD   = nCampoD + 1;
           |SI aAlfa ! "";
               aAlfa     = aAlfa + ": ";
               aAlfa1    = #dsarw005#nCampoD#;  |QBF aAlfa1;
               |SI aAlfa1 ! "01.01.0000";  |Y aAlfa1 ! "0";
                   aAlfa     = aAlfa + #dsarw005#nCampoD#;  |QBF aAlfa;
               |FINSI;

               nCampoH   = nCampoH + 1;
               |SI nCampoH = 38;  nCampoH = 60;  |FINSI;
               #dsarm005#nCampoH# = aAlfa;
           |FINSI;
     |SIGUE;

     |PARA nCampoD = 66; |SI nCampoD [ 75;  |HACIENDO nCampoD = nCampoD + 1;
           aAlfa     = #dsarw005#nCampoD#;  |QBF aAlfa;
           nCampoD   = nCampoD + 1;
           |SI aAlfa ! "";
               aAlfa     = aAlfa + ": ";
               aAlfa1    = #dsarw005#nCampoD#;  |QBF aAlfa1;
               |SI aAlfa1 ! "01.01.0000";  |Y aAlfa1 ! "0";
                   aAlfa     = aAlfa + #dsarw005#nCampoD#;  |QBF aAlfa;
               |FINSI;

               nCampoH   = nCampoH + 1;
               |SI nCampoH = 38;  nCampoH = 60;  |FINSI;
               #dsarm005#nCampoH# = aAlfa;
           |FINSI;
     |SIGUE;

     |PARA nCampoD = 33; |SI nCampoD [ 51;  |HACIENDO nCampoD = nCampoD + 1;
           aAlfa     = #dsarw005#nCampoD#;  |QBF aAlfa;
           nCampoD   = nCampoD + 1;
           |SI aAlfa ! "";
               aAlfa     = aAlfa + ": ";
               aAlfa1    = #dsarw005#nCampoD#;  |QBF aAlfa1;
               |SI aAlfa1 ! "01.01.0000";  |Y aAlfa1 ! "0";
                   aAlfa     = aAlfa + #dsarw005#nCampoD#;  |QBF aAlfa;
               |FINSI;

               nCampoH   = nCampoH + 1;
               |SI nCampoH = 38;  nCampoH = 60;  |FINSI;
               #dsarm005#nCampoH# = aAlfa;
           |FINSI;
     |SIGUE;

     |SI nCambio ! 0;
          |SI enSwVinculosExternos = 1;
               |SI eaTipoVinculo = "TALLER";
                    #dsarm005#13 = eaValorVinculo2;
               |FINSI;
               |SI eaTipoVinculo = "CLINICA";
                    #dsarm005#97 = eaValorVinculo1;
                    #dsarm005#98 = eaValorVinculo2;
                    #dsarm005#13 = eaValorVinculoAux;
               |FINSI;
          |FINSI;
          |GRABA 020#dsarm005.a;
          |LIBERA #dsarm005;

          |SI enSwVinculosExternos = 1;
               enNumRegVincuExte = #dsarm005#0;
               |HAZ GrabaVincuExte;
          |FINSI;

          enNumRegistro = #dsarm005#0;

          aAlfa = "dsarz013;" + #dsarm005#0;
          |SUB_EJECUTA aAlfa;
          aAlfa = "dsarz030;" + #dsarm005#0;
          |SUB_EJECUTA aAlfa;
          |ACABA;
     |FINSI;

     |ABRE #dsarm002;
     #dsarm002#0 = enGrupo;
     |LEE 101#dsarm002.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsarm002;
         #dsarm002#0 = enGrupo;
         |GRABA 020#dsarm002.b;
     |FINSI;

     #dsarm002#3 = #dsarm002#3 + 1;
     |GRABA 020#dsarm002.a;
     |LIBERA #dsarm002;
     |CIERRA #dsarm002;

     |ABRE #dsarm003;
     #dsarm003#0 = enGrupo;
     #dsarm003#1 = enSubGrupo;
     |LEE 101#dsarm003.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsarm003;
         #dsarm003#0 = enGrupo;
         #dsarm003#1 = enSubGrupo;
         |GRABA 020#dsarm003.b;
     |FINSI;

     #dsarm003#4 = #dsarm003#4 + 1;
     |GRABA 020#dsarm003.a;
     |LIBERA #dsarm003;
     |CIERRA #dsarm003;

     #dsarm004#0 = enGrupo;
     #dsarm004#1 = enSubGrupo;
     #dsarm004#2 = enTipo;
     |LEE 101#dsarm004.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsarm004;
         #dsarm004#0 = enGrupo;
         #dsarm004#1 = enSubGrupo;
         #dsarm004#2 = enTipo;
         |GRABA 020#dsarm004.b;
     |FINSI;
     #dsarm004#25 = #dsarm004#25 + 1;
     |GRABA 020#dsarm004.a;
     |LIBERA #dsarm004;

     #dsarm005#44 = #dsarw005#62;
     #dsarm005#45 = #dsarw005#63;
     #dsarm005#46 = #dsarw005#64;

     nDocNumero = #dsarw005#65;
     |HAZ CalculaDocNum;
     #dsarm005#47 = nDocNumero;

     |SI enSwADConta = 1;
          #dsarm005#67 = enEmpADConta;
          #dsarm005#68 = enEjeADConta;
     |FINSI;

     |SI enDESPANET = 1;  #dsarm005#94 = "C";  |FINSI;

     |SI enEscaneo = 2;
          ||TODO CCC
          ||Historico
          |HORA aHora;
          aUsuario = Usuario % 810;
          |ABRE #flowm006;
          #flowm006#0  = nDocOrigenCopia;
          #flowm006#1  = 99999;
          |LEE 000#flowm006.];
          |SI FSalida = 0;
               |LEE 000#flowm006.a;
          |SINO;
               |LEE 000#flowm006.u;
          |FINSI;
          |SI FSalida = 0; |Y #flowm006#0  = nDocOrigenCopia;
               nLinea = #flowm006#1 + 1;
               nSitu = #flowm006#2;
          |SINO;
               nSitu = 1;
               nLinea = 1;
          |FINSI;
          |DDEFECTO #flowm006;
          #flowm006#0  = nDocOrigenCopia;
          #flowm006#1  = nLinea;
          |LEE 101#flowm006.=;
          |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
          #flowm006#2  = nSitu;
          #flowm006#3  = ~;
          #flowm006#4  = aHora;
          #flowm006#5  = aUsuario;
          #flowm006#6  = "COPIADO AL DOC.: " + (("000000000" + #dsarm005#0) % -109);

          enNumRegFlow = #flowm006#0;
          enSituFlow = #flowm006#2;
          |HAZ DimeDesFlow;
          #flowm006#7 = eaDesSituFlow;

          |GRABA 020#flowm006.a;
          |LIBERA #flowm006;
          |CIERRA #flowm006;
     |FINSI;

     |SI enSwVinculosExternos = 1;
          |SI eaTipoVinculo = "TALLER";
               #dsarm005#13 = eaValorVinculo2;
          |FINSI;
          |SI eaTipoVinculo = "CLINICA";
               #dsarm005#97 = eaValorVinculo1;
               #dsarm005#98 = eaValorVinculo2;
               #dsarm005#13 = eaValorVinculoAux;
          |FINSI;
     |FINSI;

     |GRABA 020#dsarm005.a;
     |LIBERA #dsarm005;

     |SI enSwVinculosExternos = 1;
          enNumRegVincuExte = #dsarm005#0;
          |HAZ GrabaVincuExte;
     |FINSI;

     enNumRegistro = #dsarm005#0;

     |SI nSwVengoDeOCR = 0;
          aAlfa = "dsarz013;" + #dsarm005#0;
          |SUB_EJECUTA aAlfa;
     |FINSI;

     aAlfa = "dsarz030;" + #dsarm005#0;
     |SUB_EJECUTA aAlfa;
|FPRC;

|PROCESO dsarm030_borra;
     |BORRA 020#dsarm030.a;
|FPRC;


|PROCESO Baja30;
     #dsarm030#0 = nRegDocu;
     #dsarm030#1 = 1;
|FPRC;

|PROCESO Alta30;
     #dsarm030#0 = nRegDocu;
     #dsarm030#1 = 99999;
|FPRC;

|PROCESO Evento30;
|FPRC;

|DEFBUCLE dsarm030_borra;
 #dsarm030#1;
 ;
 nRegDocu,     0;
 nRegDocu, 99999;
 be;
 NULL, dsarm030_borra;
|FIN;

|PROCESO dsarm031_borra;
     |BORRA 020#dsarm031.a;
|FPRC;

|DEFBUCLE dsarm031_borra;
 #dsarm031#1;
 ;
 nRegDocu, 000;
 nRegDocu, 999;
 be;
 NULL, dsarm031_borra;
|FIN;

|PROCESO dsarm031_mete;
     nCampo = #dsarm031#1;
     aValor = #dsarm031#2;

     |SI nCampo ] 23; |Y nCampo [ 37;
          aAux2 = #dsarm005#nCampo#;
          |QBF aAux2;
          |SI aAux2 ! "";
               aAux2 = aAux2 + " " + aValor;
               |QBF aAux2;
               #dsarm005#nCampo# = aAux2;
          |SINO;
               #dsarm005#nCampo# = aValor;
          |FINSI;
     |SINO;
          |SI nCampo ] 60; |Y nCampo [ 64;
               aAux2 = #dsarm005#nCampo#;
               |QBF aAux2;
               |SI aAux2 ! "";
                    aAux2 = aAux2 + " " + aValor;
                    |QBF aAux2;
                    #dsarm005#nCampo# = aAux2;
               |SINO;
                    #dsarm005#nCampo# = aValor;
               |FINSI;
          |SINO;
               #dsarm005#nCampo# = aValor;
          |FINSI;
     |FINSI;
     |SI nCampo = 10;
          |ABRE #dpntm001;
          |SELECT #3#dpntm001;
          #dpntm001#10 = aValor;
          |LEE 000#dpntm001.=;
          |SI FSalida = 0;
               #dsarm005#8 = #dpntm001#1;
               #dsarm005#14 = #dpntm001#2;
          |FINSI;
          |CIERRA #dpntm001;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm031_mete;
 #dsarm031#1;
 ;
 nRegDocu, 001;
 nRegDocu, 999;
 ;
 NULL, dsarm031_mete;
|FIN;

|PROCESO PonEtiquetas;
     nContDos = nContDos + 1;
     aAux = #dsarm004#nCampo#;
     |QBF aAux;
     |SI aAux ! "";
          nContReal = nContReal + 1;

          |SI nContReal < 16;
               nCampo1 = 22 + nContReal;
          |SINO;
               nCampo1 = 44 + nContReal;
          |FINSI;

          aTexto = aAux;
          |QBF aTexto;
          aTexto = aTexto + ": ";
          #dsarm005#nCampo1# = aTexto;
     |FINSI;
|FPRC;

|PROCESO QuitaHasta2Puntos;
     ||aTextoActual

     aAuxActual = "";
     aLong = aTextoActual % A0;
     nLong = aLong;
     |PARA nLetra = 1; |SI nLetra [ nLong; |HACIENDO nLetra = nLetra + 1;
          nSaca = (100 * nLetra) + 1;
          aSaca = nSaca;
          aLetra = aTextoActual % aSaca;
          |SI aLetra = ":";
               aAuxActual = aAuxActual + aLetra;
               |SAL;
          |SINO;
               aAuxActual = aAuxActual + aLetra;
          |FINSI;
     |SIGUE;
     aTextoActual = aAuxActual;
|FPRC;

|PROCESO RellenaConta;
     |ABRE #dsarm065;
     |DDEFECTO #dsarm065;
     #dsarm065#0 = #dsarm004#88;
     |LEE 000#dsarm065.=;
     |SI FSalida ! 0;
         |CIERRA #dsarm065;
         |ACABA;
     |FINSI;

     |DBASS aBaseConta;
     |QBF aBaseConta;
     aDirConta = aBaseConta + "contagen/";
     aDirDatos = aDirConta + "fich/" + (("00000" + enEmpADConta) % -105) + (("0" + enEjeADConta) % -101) + "/";

     aDef = aDirConta + "def/camaniva";
     |CARGA_DEF aDef, referen@;
     |SI FSalida ! 0;
         |CIERRA #dsarm065;
         |ACABA;
     |FINSI;

     |PATH_DAT #referen@#aDirDatos#;
     |ABRE #referen@;
     |DDEFECTO #referen@;
     #referen@#0 = enLibroConta;
     #referen@#1 = enDocumentoConta;
     |LEE 000#referen@.=;
     |SI FSalida ! 0;
         |CIERRA #dsarm065;
         |CIERRA #referen@;
         |DESCARGA_DEF #referen@;
         |ACABA;
     |FINSI;

     |PARA nCampoC = 2; |SI nCampoC [ 47; |HACIENDO nCampoC = nCampoC + 5;
           nCampoE = nCampoC + 2;
           nNumCampo  = #dsarm065#nCampoC#;
           nNumCampo2 = #dsarm065#nCampoE#;
           |SI nNumCampo ! -1; |Y nNumCampo2 ! -1;
               |SI nNumCampo = 99;
                   ||Tengo que cargar el camanref
                   ||y leer el valor del mismo.

                   aDef = aDirConta + "def/camanref";
                   |CARGA_DEF aDef, otrodef@;
                   |SI FSalida = 0;
                       |PATH_DAT #otrodef@#aDirDatos#;
                       |ABRE #otrodef@;
                       |DDEFECTO #otrodef@;
                       #otrodef@#0 = #referen@#0;
                       #otrodef@#1 = #referen@#1;
                       |LEE 000#otrodef@.=;
                       |SI FSalida = 0;
                           aValorConta = #otrodef@#2;
                       |SINO;
                           aValorConta = "";
                       |FINSI;
                       |CIERRA #otrodef@;
                       |DESCARGA_DEF #otrodef@;
                   |SINO;
                       aValorConta = "";
                   |FINSI;
               |SINO;
                   aValorConta = #referen@#nNumCampo#;
               |FINSI;

               |QBF aValorConta;
               |SI aValorConta ! "";
                   aActual = #dsarm005#nNumCampo2#;  |QBF aActual;
                   |SI aActual ! "";
                       |SI nNumCampo2 ] 23; |Y nNumCampo2 [ 37;
                           aTextoActual = aActual;
                           |HAZ QuitaHasta2Puntos;
                           aActual = aTextoActual;
                           aActual = aActual + " " + aValorConta;
                           #dsarm005#nNumCampo2# = aActual;
                       |SINO;
                           |SI nNumCampo2 ] 60; |Y nNumCampo2 [ 64;
                               aTextoActual = aActual;
                               |HAZ QuitaHasta2Puntos;
                               aActual = aTextoActual;
                               aActual = aActual + " " + aValorConta;
                               #dsarm005#nNumCampo2# = aActual;
                           |SINO;
                               #dsarm005#nNumCampo2# = aValorConta;
                           |FINSI;
                       |FINSI;
                   |SINO;
                       #dsarm005#nNumCampo2# = aValorConta;
                   |FINSI;
               |FINSI;
           |FINSI;
     |SIGUE;
     |CIERRA #dsarm065;
     |CIERRA #referen@;
     |DESCARGA_DEF #referen@;
|FPRC;

|PROCESO GrabaLineaDocumento;
     |ABRE #dsarm005;
     |SI enRegASustituir = 0;
          nDocu      = 1;
          |LEE 000#dsarm005.u;
          |SI FSalida = 0;
               nDocu = #dsarm005#0 + 1;
          |SINO;
               nDocu = 1;
          |FINSI;

          |ABRE #dsarm100;
          |DDEFECTO #dsarm100;
          |LEE 000#dsarm100.p;
          |SI FSalida = 0;
               nUltimoDoc = #dsarm100#1 + 1;
          |SINO;
               nUltimoDoc = 1;
          |FINSI;
          |SI nUltimoDoc > nDocu;
               nDocu = nUltimoDoc;
          |FINSI;
          #dsarm100#0 = "1";
          |LEE 101#dsarm100.=;
          |SI FSalida ! 0; |GRABA 020#dsarm100.b; |FINSI;
          #dsarm100#1 = nDocu;
          |GRABA 020#dsarm100.a;
          |LIBERA #dsarm100;
          |CIERRA #dsarm100;

          |DDEFECTO #dsarm005;
          #dsarm005#0 = nDocu;
          #dsarm005#1 = enGrupo;
          #dsarm005#2 = enSubGrupo;
          #dsarm005#3 = enTipo;
          #dsarm005#4 = ~;

          |SI #dsarw112#0 ! 0;
              #dsarm005#8  = #dsarw112#0;
              #dsarm005#10 = #dsarw112#2;
              #dsarm005#14 = #dsarw112#1;
          |FINSI;

          |GRABA 020#dsarm005.b;
     |SINO;
          |DDEFECTO #dsarm005;
          nDocu = enRegASustituir;
          #dsarm005#0 = nDocu;
          |LEE 101#dsarm005.=;

          #dsarm005#1 = enGrupo;
          #dsarm005#2 = enSubGrupo;
          #dsarm005#3 = enTipo;
          #dsarm005#4 = ~;
     |FINSI;

     aAlfa = (aFichero % -104) > "";
     aAlfa1 = aAlfa % 101;
     |SI aAlfa1 ! ".";
          aAlfa  = (aFichero % -105) > "";
     |FINSI;
     aFicheroTif = (("000000000" + nDocu) % -109) + aAlfa;
     |QBT aFicheroTif;

     |SI eaAutoSelPlantilla = "S"; |O eaImpoAlbaVta = "S";
          aPath = #dsarm001#1;  |QBF aPath;
          aLetra = aPath % -101;
          |SI aLetra ! "/"; |Y aLetra ! "\";
               aPath = aPath + "/";
          |FINSI;
          aUbicacion = aPath + "tmp/";
          |SI #dsarm001#7 = "N";
              |MKDIR aUbicacion;
          |SINO;
              |RMKDIR aUbicacion;
          |FINSI;
          eaUbicacionTempo = aUbicacion;
          eaNomFichero = aFicheroTif;
     |SINO;
          |SI enRegASustituir = 0;
              |HAZ CalculaDocNum;
              #dsarm005#47 = nDocNumero;
          |FINSI;
          aUbicacion = "";
          |HAZ SacaUbicacion;
     |FINSI;

     aBorraCache = aFichero;
     eaDestino    = aFichero;
     eaOrigen     = aUbicacion + aFicheroTif;
     enSwIOCorrecta = 0;
     |HAZ RecibeConMD5;
     |SI enSwIOCorrecta = 0;
         |SI enSwModoSilencio = 1;
               eaErrorDsEscan = "Ha habido un error al transferir el documento al servidor. Revise Permisos y espacio disponible.";
               enNumRegDsEscan = 0;          ||No se ha creado ningun documento
         |SINO;
               |MENAV "0000 Ha habido un error al transferir el documento al servidor. Revise Permisos y espacio disponible.";
         |FINSI;
         |SI enRegASustituir = 0;
              |BORRA 020#dsarm005.a;
         |FINSI;
         |LIBERA #dsarm005;
         enErrorCaptura = 1;
         |ACABA;
     |FINSI;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

     |SI #dsarm001#7 = "N";  |Y aIPRemoto ! "";
         |XABRE "E", eaOrigen, nHandle;
     |SINO;
         |XABRE "EC", eaOrigen, nHandle;
     |FINSI;

     |SI FSalida < 0;
         |SI enSwModoSilencio = 1;
               eaErrorDsEscan = "Ha habido un error al transferir el documento al servidor.";
               enNumRegDsEscan = 0;          ||No se ha creado ningun documento
         |SINO;
               |MENAV "0000 Ha habido un error al transferir el documento al servidor. Intentelo de nuevo";
         |FINSI;
         |SI enRegASustituir = 0;
              |BORRA 020#dsarm005.a;
         |FINSI;
         |LIBERA #dsarm005;
         enErrorCaptura = 1;
         |ACABA;
     |FINSI;

     |SI eaAutoSelPlantilla = "S"; |O eaImpoAlbaVta = "S";
          enSwEstaAV = 0;

          ||Primero tiene que "escanearlo o similar" para averiguar el G/S/T destino.
          nRegDocu = #dsarm005#0;
          |BUCLE dsarm030_borra;
          |BUCLE dsarm031_borra;

          |ABRE #dsarm031;
          aMete31 = "";
          aMete31 = (("000" + enGrupo) % -103) + " " + (("000" + enSubGrupo) % -103) + " " + (("000" + enTipo) % -103);
          aMete31 = aMete31 + aFichero;
          #dsarm031#0 = nRegDocu;
          #dsarm031#1 = 0;
          |LEE 101#dsarm031.=;
          |SI FSalida ! 0;
               #dsarm031#2 = aMete31;
               |GRABA 020#dsarm031.n;
          |FINSI;
          |LIBERA #dsarm031;
          |CIERRA #dsarm031;

          aAlfa = "dsarz013;" + #dsarm005#0;
          |SUB_EJECUTA aAlfa;

          ||Una vez averiguado, ya funciona como siempre.
          ||Me devuelve las variables:
          ||enGrupo
          ||enSubGrupo
          ||enTipo

          |SI enGrupoFiltro ! 0;
               enGrupo = enGrupoFiltro;
               enSubGrupo = enSubGrupoFiltro;
               enTipo = enTipoFiltro;

               #dsarm005#1 = enGrupo;
               #dsarm005#2 = enSubGrupo;
               #dsarm005#3 = enTipo;
          |FINSI;

          |SI enRegASustituir = 0;
              |HAZ CalculaDocNum;
              #dsarm005#47 = nDocNumero;
          |FINSI;
          aUbicacion = "";
          |HAZ SacaUbicacion;

          aOrigen = eaUbicacionTempo + aFicheroTif + ".txt";
          aDestino = aUbicacion + aFicheroTif + ".txt";
          |SI #dsarm001#7 = "N";
               |RENOMBRA_FICHERO aOrigen, aDestino;
          |SINO;
               |RRENOMBRA_FICHERO aOrigen, aDestino;
          |FINSI;

          aOrigen = eaUbicacionTempo + aFicheroTif;
          aDestino = aUbicacion + aFicheroTif;
          |SI #dsarm001#7 = "N";
               |RENOMBRA_FICHERO aOrigen, aDestino;
          |SINO;
               |RRENOMBRA_FICHERO aOrigen, aDestino;
          |FINSI;

          #dsarm005#1 = enGrupo;
          #dsarm005#2 = enSubGrupo;
          #dsarm005#3 = enTipo;
          #dsarm005#4 = ~;
          |HORA aHora;
          aHora = aHora % 105;
          #dsarm005#5 = aHora;
          aUsuario = Usuario % 810;
          #dsarm005#6 = aUsuario;
          #dsarm005#7 = aUbicacion;
          #dsarm005#9 = aFicheroTif;

          nContReal = 0;
          nContDos = 0;
          |PARA nCampo = 5;  |SI nCampo [ 9;  |HACIENDO nCampo = nCampo + 1;
               |HAZ PonEtiquetas;
          |SIGUE;
          |PARA nCampo = 27;  |SI nCampo [ 31;  |HACIENDO nCampo = nCampo + 1;
               |HAZ PonEtiquetas;
          |SIGUE;
          |PARA nCampo = 10;  |SI nCampo [ 19;  |HACIENDO nCampo = nCampo + 1;
               |HAZ PonEtiquetas;
          |SIGUE;

          |ABRE #dsarm030;
          |DDEFECTO #dsarm030;
          #dsarm030#0 = nRegDocu;
          #dsarm030#1 = 0;
          |LEE 000#dsarm030.=;
          |SI FSalida = 0;
               aAux = #dsarm030#2;
               |QBF aAux;
          |SINO;
               |SI nSwLogError = 1;
                    |SI enSwModoSilencio = 1;
                          eaErrorDsEscan = "Error Auto Seleccion del Tipo.";
                          enNumRegDsEscan = #dsarm005#0;
                    |SINO;
                         aMensaje = "0000Error Auto Seleccion del Tipo.";
                         |MENAV aMensaje;
                    |FINSI;
               |FINSI;
               aAux = "ERROR";
          |FINSI;
          |SI aAux ! "ERROR";
               |BUCLE dsarm031_mete;
          |FINSI;
          |CIERRA #dsarm030;

          ||Si estoy aqui es que vengo de escanear me da igual
          ||si ha dado error o no, ya he escaneado.
          nSwVengoDeOCR = 1;

          ||TODO CCC
          ||Cargo valores de G/S/T
          ||Saco Ubicacion.
          ||Muevo donde corresponda
          ||Resto de campos.

          |SI aProg ! "";
               #dsarm005#93 = aProg;
               aProg = "";
          |FINSI;

          |SI enSwEstaAV = 1;      ||Desde el capturador, hemos capturado
                                   ||un albaran de la dscomer9
                                   ||a traves del OCR, sabemos la serie y el numero

               #dsarm005#84 = "AV";
               #dsarm005#85 = eaSerieAV;
               #dsarm005#86 = enNumeroAV;
               #dsarm005#88 = enEmpresaAV;
               #dsarm005#97 = "dserp:dscomer9." + enNumDSerpAV;
          |FINSI;

          |GRABA 020#dsarm005.a;
          |LIBERA #dsarm005;
          |CIERRA #dsarm005;
     |SINO;
          #dsarm005#1 = enGrupo;
          #dsarm005#2 = enSubGrupo;
          #dsarm005#3 = enTipo;
          #dsarm005#4 = ~;
          |HORA aHora;
          aHora = aHora % 105;
          #dsarm005#5 = aHora;
          aUsuario = Usuario % 810;
          #dsarm005#6 = aUsuario;
          #dsarm005#7 = aUbicacion;
          #dsarm005#9 = aFicheroTif;

          nContReal = 0;
          nContDos = 0;
          |PARA nCampo = 5;  |SI nCampo [ 9;  |HACIENDO nCampo = nCampo + 1;
               |HAZ PonEtiquetas;
          |SIGUE;
          |PARA nCampo = 27;  |SI nCampo [ 31;  |HACIENDO nCampo = nCampo + 1;
               |HAZ PonEtiquetas;
          |SIGUE;
          |PARA nCampo = 10;  |SI nCampo [ 19;  |HACIENDO nCampo = nCampo + 1;
               |HAZ PonEtiquetas;
          |SIGUE;

          |SI enSwADConta = 1;
               #dsarm005#67 = enEmpADConta;
               #dsarm005#68 = enEjeADConta;
          |FINSI;

          |SI enDESPANET = 1;
              aUsuario = Usuario % 810;
              |ABRE #dpntm001;
              #dpntm001#0 = aUsuario;
              |LEE 000#dpntm001.=;
              |CIERRA #dpntm001;

              #dsarm005#8  = #dpntm001#0;
              #dsarm005#10 = #dpntm001#10;
              #dsarm005#14 = #dpntm001#2;
              #dsarm005#94 = "C";
          |FINSI;

          |SI aProg ! "";
               #dsarm005#93 = aProg;
               aProg = "";
          |FINSI;

          |SI #dsarm004#78 ! 0;         ||Plantillas Auto-Relleno
               |ABRE #dsarm029;
               |DDEFECTO #dsarm029;
               #dsarm029#0 = #dsarm004#78;
               |LEE 000#dsarm029.=;
               nSwLogError = #dsarm029#84;
               |CIERRA #dsarm029;

               nRegDocu = #dsarm005#0;
               |BUCLE dsarm030_borra;
               |BUCLE dsarm031_borra;

               |ABRE #dsarm031;
               aMete31 = "";
               aMete31 = (("000" + enGrupo) % -103) + " " + (("000" + enSubGrupo) % -103) + " " + (("000" + enTipo) % -103);
               aMete31 = aMete31 + " " + aUbicacion + "|" + aFicheroTif;
               #dsarm031#0 = nRegDocu;
               #dsarm031#1 = 0;
               |LEE 101#dsarm031.=;
               |SI FSalida ! 0;
                    #dsarm031#2 = aMete31;
                    |GRABA 020#dsarm031.n;
               |FINSI;
               |LIBERA #dsarm031;
               |CIERRA #dsarm031;

               aAlfa = "dsarz013;" + #dsarm005#0;
               |SUB_EJECUTA aAlfa;

               |ABRE #dsarm030;
               |DDEFECTO #dsarm030;
               #dsarm030#0 = nRegDocu;
               #dsarm030#1 = 0;
               |LEE 000#dsarm030.=;
               |SI FSalida = 0;
                    aAux = #dsarm030#2;
                    |QBF aAux;
               |SINO;
                    |SI nSwLogError = 1;
                         |SI enSwModoSilencio = 1;
                               eaErrorDsEscan = "Error plantillas Auto-Relleno";
                               enNumRegDsEscan = #dsarm005#0;
                         |SINO;
                              aMensaje = "0000Error plantillas Auto-Relleno.";
                              |MENAV aMensaje;
                         |FINSI;
                    |FINSI;
                    aAux = "ERROR";
               |FINSI;
               ||Si estoy aqui es que vengo de escanear me da igual
               ||si ha dado error o no, ya he escaneado.
               nSwVengoDeOCR = 1;
               |SI aAux = "ERROR";
                    |SI nSwLogError = 1; |Y enSwModoSilencio = 0;
                         |VENTANA 0501, 2999, -1, 16, "Visualizando LOG Plantilla Auto-Relleno";
                         nVentz1  = FSalida;

                         aVent1 = -1;
                         aVent2 = -1;
                         aVent3 = 0;
                         aVent4 = nVentz1;
                         aVent5 = "MODAL";
                         |ESPECIFICA "ESTADO_VENTANA", aVent;

                         |PINPA #0#dsarw058;
                         |PINDA #0#dsarw058;
                         |PTEC 802;
                         |PAUSA;

                         nRango = 2 + 4 + 8 + 16;
                         nPos1 = 1402;
                         nPos2 = 2498;
                         |LINEAL_SIMPLE #1#dsarm030, nRango, nPos1, nPos2, Baja30, Alta30, Evento30;

                         aVent1 = -1;
                         aVent2 = -1;
                         aVent3 = 0;
                         aVent4 = nVentz1;
                         aVent5 = "MODELESS";
                         |ESPECIFICA "ESTADO_VENTANA", aVent;

                         |FINVENTANA nVentz1;

                         ||Mostramos GRID de LOG.
                    |FINSI;
               |SINO;
                    |BUCLE dsarm031_mete;
               |FINSI;
               |CIERRA #dsarm030;
          |FINSI;

          |SI enSwVinculosExternos = 1;
               |SI eaTipoVinculo = "TALLER";
                    #dsarm005#13 = eaValorVinculo2;
               |FINSI;
               |SI eaTipoVinculo = "CLINICA";
                    #dsarm005#97 = eaValorVinculo1;
                    #dsarm005#98 = eaValorVinculo2;
                    #dsarm005#13 = eaValorVinculoAux;
               |FINSI;
          |FINSI;

          |SI #dsarm004#88 ! 0; |Y enSwPlantillaConta = 1;
              |HAZ RellenaConta;
          |FINSI;

          |SI nMeteImpoADConta = 1;
               #dsarm005#67 = nCampo67;
               #dsarm005#68 = nCampo68;
               #dsarm005#69 = nCampo69;
               #dsarm005#70 = fCampo70;
               #dsarm005#71 = nCampo71;
               #dsarm005#72 = nCampo72;
               #dsarm005#73 = nCampo73;
               #dsarm005#74 = aCampo74;
          |FINSI;

          |GRABA 020#dsarm005.a;
          |LIBERA #dsarm005;
          |CIERRA #dsarm005;

          |SI enSwVinculosExternos = 1;
               enNumRegVincuExte = #dsarm005#0;
               |HAZ GrabaVincuExte;
          |FINSI;

          enErrorCaptura = 0;

          enNumRegistro = #dsarm005#0;

          |SI #dsarm004#78 = 0;         ||Plantillas Auto-Relleno No activa.
               aAlfa = "dsarz013;" + #dsarm005#0;             ||OCR.
               |SUB_EJECUTA aAlfa;
          |FINSI;
     |FINSI;

     aAlfa = "dsarz030;" + #dsarm005#0;
     |SUB_EJECUTA aAlfa;

     |SI #dsarm001#181 = "S";
          ||Ahora controlamos si borramos o no la cache.
          |QBF aBorraCache;
          |SI aBorraCache ! "";
               |RFBORRA aBorraCache;
          |FINSI;
     |FINSI;
     enRegASustituir = 0;
|FPRC;

|PROCESO RecogeUno;
     eaRuta  = "";
     |HAZ Traete_dsselect;
     |SI enError = 1;
         |MENAV "0000No puedo instala el dsselect.exe, consulte con su administrador";
     |FINSI;

     |ESPECIFICA "RBASS", aLocal;
     aDirLocal = aLocal;

     |HAZ DimeUnidad;
     aAux      = eaUnidad + ":\DOCUMENTOS\DSARCHI\";
     aPrograma = aAux + "dsselect.exe";

     aPathDSSelect = aAux;

     aBorra = aPathDSSelect + "dsselect.txt";
     |RFBORRA aBorra;

     aParaIni = aAux + "dsselect.ini";
     |RFBORRA aParaIni;

     |ABRE #dsarm000;
     #dsarm000#0 = Usuario % 810;
     |LEE 000#dsarm000.=;
     |SI FSalida ! 0;
          |DDEFECTO #dsarm000;
     |FINSI;
     aCarpetaCaptura = #dsarm000#17;
     |QBF aCarpetaCaptura;
     |SI aCarpetaCaptura = "";
          aCarpetaCaptura = eaUnidadBasico;
     |FINSI;
     |CIERRA #dsarm000;

     aTextoIni = &34 + aCarpetaCaptura + &34 + " " + &34 + aBorra + &34;
     |XABRE "CW", aParaIni, nHandle;
     |SI FSalida ] 0;
          |XGRABA nHandle, aTextoIni;
     |FINSI;
     |XCIERRA nHandle;

     aEjecuta = aPrograma;
     |RSYSTEM aEjecuta;

     aAbre = aPathDSSelect + "dsselect.txt";
     |XABRE "CU", aAbre, nHandle;
     |SI FSalida < 0;
        aPath = "";
        nError = 1;
        |ACABA;
     |FINSI;

     |XLEE nHandle, 250, aPath;
     |SI FSalida < 0
         aPath = "";
         nError = 1;
         |ACABA;
     |FINSI;

     |HAZ CargaVarBorrado;

     |QBF aPath;
     |SI aPath ! "";
         aAlfa    = aPath;
         aFichero = "";
         aLong    = aAlfa % 0;
         nLong    = aLong;
         eaRuta   = "";
         |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
               nPos   = (nCarac * 100) + 1;
               aCarac =  aAlfa % nPos;
               |SI aCarac = "/";  |O aCarac = "\";
                   aProg = "";
               |SINO;
                   aProg = aProg + aCarac;
               |FINSI;

               eaRuta = eaRuta + aCarac;
         |SIGUE;
     |FINSI;
     |XCIERRA nHandle;

     aBorra = aPathDSSelect + "dsselect.txt";
     |RFBORRA aBorra;

     |SI eaRuta ! ""; |Y aProg ! "";
          aCarpetaCaptura = eaRuta - aProg;
          |QBF aCarpetaCaptura;
          |SI aCarpetaCaptura ! "";
               |ABRE #dsarm000;
               #dsarm000#0 = Usuario % 810;
               |LEE 101#dsarm000.=;
               |SI FSalida ! 0;
                   |DDEFECTO #dsarm000;
                   #dsarm000#0 = Usuario % 810;
                   |GRABA 020#dsarm000.b;
               |FINSI;
               #dsarm000#17 = aCarpetaCaptura;
               |GRABA 000#dsarm000.a;
               |LIBERA #dsarm000;
               |CIERRA #dsarm000;
          |FINSI;

         |HAZ DimeUnidad;
         aAlfa    = eaUnidad + ":\DOCUMENTOS";        |RMKDIR aAlfa;

         aAlfa     = aAlfa + "\DSARCHI";     |RMKDIR aAlfa;
         eaOrigen  = eaRuta;
         eaDestino = aAlfa + "\" + aProg;
         |SI eaOrigen ! eaDestino;
             eaDocPC = eaOrigen;
             |RCOPIA_FICHERO eaOrigen, eaDestino;
         |FINSI;
     |SINO;
         nError = 1;
         |ACABA;
     |FINSI;

     aFichero = eaDestino;

     eaCarpetaOrigen = eaRuta - aProg;

     |SI eaTipoVinculo = "CLINICA";
          |SI enSwVinExteEspecial = 1; |Y nSwEstoyVolverCapturar = 0;
               ||Controlamos si para el G/S/T ya existe algun documento
               ||para la historia en cuestion que estamos introduciendo.
               enErrorHisYaIntro = 0;
               |HAZ ClinicaHisYaIntro;
               |SI enErrorHisYaIntro = 1;
                    nError = 1;
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     nSwAcabaUnDocumento = 0;
     |SI #dsarm004#78 ! 0;
          |HAZ GrabaLineaDocumento;
          nSwAcabaUnDocumento = 1;
     |FINSI;
|FPRC;

|PROCESO DimeTotalDocs;
     |PARA; |SI; |HACIENDO;
          |XLEE nHandle, 250, aPath;
          |SI FSalida < 0;  |SAL;  |FINSI;
          |QBF aPath;

          |HAZ ControlExtensiones;
     |SIGUE;
|FPRC;

|PROCESO ControlExtensiones;
     aExtension = aPath % -104;
     aExtension = aExtension > aExtension;
     |SI aExtension = ".JPG"; |O aExtension = ".BMP"; |O aExtension = ".TIF"; |O aExtension = ".JPE"; |O aExtension = ".PNG";
       |O aExtension = ".PDF";  ||Cuando tratemos PDF
          enNumTotalDocs = enNumTotalDocs + 1;
     |SINO;
          aExtension = aPath % -105;
          aExtension = aExtension > aExtension;
          |SI aExtension = ".JPEG"; |O aExtension = ".TIFF";
               enNumTotalDocs = enNumTotalDocs + 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO RecogeVarios;
     |HAZ Traete_dsselect;
     |SI enError = 1;
         |MENAV "0000No puedo instala el dsselect.exe, consulte con su administrador";
     |FINSI;
     |ESPECIFICA "RBASS", aLocal;
     aDirLocal = aLocal;

     |HAZ DimeUnidad;
     aAux      = eaUnidad + ":\DOCUMENTOS\DSARCHI\";
     aPrograma = aAux + "dsselect.exe";

     aPathDSSelect = aAux;

     aBorra = aPathDSSelect + "dsselect.txt";
     |RFBORRA aBorra;

     aParaIni = aAux + "dsselect.ini";
     |RFBORRA aParaIni;

     |ABRE #dsarm000;
     #dsarm000#0 = Usuario % 810;
     |LEE 000#dsarm000.=;
     |SI FSalida ! 0;
          |DDEFECTO #dsarm000;
     |FINSI;
     aCarpetaCaptura = #dsarm000#17;
     |QBF aCarpetaCaptura;
     |SI aCarpetaCaptura = "";
          aCarpetaCaptura = eaUnidadBasico;
     |FINSI;
     |CIERRA #dsarm000;

     aTextoIni = &34 + aCarpetaCaptura + &34 + " " + &34 + aBorra + &34;
     |XABRE "CW", aParaIni, nHandle;
     |SI FSalida ] 0;
          |XGRABA nHandle, aTextoIni;
     |FINSI;
     |XCIERRA nHandle;

     aEjecuta = aPrograma;
     |RSYSTEM aEjecuta;

     aAbre = aPathDSSelect + "dsselect.txt";

     |XABRE "CU", aAbre, nHandle;
     |SI FSalida < 0;
         aPath = "";
         nError = 1;
         |ACABA;
     |FINSI;

     |SI #dsarm001#168 = "S";      ||Cuento el total documentos dsescaneables
                                   ||solo si tengo activa el dsEscan
          enVoyPorDoc = 0;
          enNumTotalDocs = 0;
          |HAZ DimeTotalDocs;
          |XPOSICION nHandle, 0, 0;
     |FINSI;

     |HAZ CargaVarBorrado;

     nPrimeraVez = 0;
     |PARA; |SI; |HACIENDO;
          |XLEE nHandle, 250, aPath;
          |SI FSalida < 0;  |SAL;  |FINSI;

          |QBF aPath;
          |SI aPath ! "";
              aAlfa    = aPath;
              aFichero = "";
              aLong    = aAlfa % 0;
              nLong    = aLong;
              eaRuta   = "";
              |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
                    nPos   = (nCarac * 100) + 1;
                    aCarac =  aAlfa % nPos;
                    |SI aCarac = "/";  |O aCarac = "\";
                        aProg = "";
                    |SINO;
                        aProg = aProg + aCarac;
                    |FINSI;

                    eaRuta = eaRuta + aCarac;
              |SIGUE;

              |SI eaRuta ! ""; |Y aProg ! "";
                  aCarpetaCaptura = eaRuta - aProg;
                  |QBF aCarpetaCaptura;
                  |SI aCarpetaCaptura ! "";
                        nPrimeraVez = nPrimeraVez + 1;
                        |SI nPrimeraVez = 1;
                             |ABRE #dsarm000;
                             #dsarm000#0 = Usuario % 810;
                             |LEE 101#dsarm000.=;
                             |SI FSalida ! 0; |GRABA 020#dsarm000.b; |FINSI;
                             #dsarm000#17 = aCarpetaCaptura;
                             |GRABA 000#dsarm000.a;
                             |LIBERA #dsarm000;
                             |CIERRA #dsarm000;
                        |FINSI;
                  |FINSI;

                  |HAZ DimeUnidad;
                  aAlfa    = eaUnidad + ":\DOCUMENTOS";        |RMKDIR aAlfa;
                  aAlfa    = aAlfa + "\DSARCHI";     |RMKDIR aAlfa;
                  eaOrigen  = eaRuta;
                  eaDestino = aAlfa + "\" + aProg;

                  |SI eaOrigen ! eaDestino;
                      eaDocPC = eaOrigen;
                      |RCOPIA_FICHERO eaOrigen, eaDestino;
                  |FINSI;
              |SINO;
                  nError = 1;
              |FINSI;

              aFichero = eaDestino;
              |SI nError = 1;
                  aMensaje = "0000Problemas al leer: " + aPath;
                  |MENAV aMensaje;
              |SINO;
                  eaCarpetaOrigen = eaRuta - aProg;

                  |HAZ GrabaLineaDocumento;
                  nSwNumVarios = nSwNumVarios + 1;
              |FINSI;
          |SINO;
              |SAL;
          |FINSI;
     |SIGUE;
     |XCIERRA nHandle;

     aBorra = aPathDSSelect + "dsselect.txt";
     |RFBORRA aBorra;
|FPRC;


|PROCESO RecogeDeCarpeta;
     |SI #dsarm001#168 = "S";      ||Cuento el total documentos dsescaneables
                                   ||solo si tengo activa el dsEscan
          enVoyPorDoc = 0;
          enNumTotalDocs = 0;

          aBuscaCarpeta = aDirBrowse + "\*.*";
          |R_PDIR aBuscaCarpeta;

          |PARA; |SI FSalida = 0; |HACIENDO;
               aPath = aBuscaCarpeta;
               |QBF aPath;
               |SI aPath ! "";
                    |HAZ ControlExtensiones;
               |SINO;
                   |SAL;
               |FINSI;
               |R_SDIR aBuscaCarpeta;
          |SIGUE;
     |FINSI;

     aBuscaCarpeta = aDirBrowse + "\*.*";
     |R_PDIR aBuscaCarpeta;

     |PARA; |SI FSalida = 0; |HACIENDO;
          aPath = aBuscaCarpeta;
          |QBF aPath;
          |SI aPath ! "";
              aAlfa    = aPath;
              aFichero = "";
              aLong    = aAlfa % 0;
              nLong    = aLong;
              eaRuta   = "";
              |PARA nCarac = 1;  |SI nCarac [ nLong;  |HACIENDO nCarac = nCarac + 1;
                    nPos   = (nCarac * 100) + 1;
                    aCarac =  aAlfa % nPos;
                    |SI aCarac = "/";  |O aCarac = "\";
                        aProg = "";
                    |SINO;
                        aProg = aProg + aCarac;
                    |FINSI;

                    eaRuta = eaRuta + aCarac;
              |SIGUE;

              |SI eaRuta ! ""; |Y aProg ! "";
                  |HAZ DimeUnidad;
                  aAlfa    = eaUnidad + ":\DOCUMENTOS";        |RMKDIR aAlfa;
                  aAlfa    = aAlfa + "\DSARCHI";     |RMKDIR aAlfa;
                  eaOrigen = eaRuta;
                  eaDestino = aAlfa + "\" + aProg;
                  |SI eaOrigen ! eaDestino;
                      eaDocPC = eaOrigen;
                      |RCOPIA_FICHERO eaOrigen, eaDestino;
                  |FINSI;
              |SINO;
                  nError = 1;
              |FINSI;

              aFichero = eaDestino;
              |SI nError = 1;
                  aMensaje = "0000Problemas al leer: " + aPath;
                  |MENAV aMensaje;
              |SINO;
                  |HAZ GrabaLineaDocumento;
                  nSwNumVarios = nSwNumVarios + 1;
              |FINSI;
          |SINO;
              |SAL;
          |FINSI;
          |R_SDIR aBuscaCarpeta;
     |SIGUE;
|FPRC;

|PROCESO HayLibresObligatorio;
     |PARA nVoy = 55; |SI nVoy < 74; |HACIENDO nVoy = nVoy + 1;
          aCampoObli = #dsarm004#nVoy#;
          |QBF aCampoObli;
          |SI aCampoObli = "S"; |O aCampoObli = "s";
               nSwHayLibObligados = 1;
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO PideEmpContab;
     |DBASS aBase;
     aMas = aBase + "/integral/def/dsam0000.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida ] 0;
         |MODO_RELACION #dsarw112, 1, "dsam0000", "N", "N";
         |MODO_RELACION #dsarw112, 1, "agifigen", "N", "N";
         |MODO_RELACION #dsarw112, 1, "agifigen", "X", "X";
     |SINO;
         |MODO_RELACION #dsarw112, 1, "agifigen", "N", "N";
         |MODO_RELACION #dsarw112, 1, "dsam0000", "N", "N";
         |MODO_RELACION #dsarw112, 1, "dsam0000", "X", "X";
     |FINSI;

     |VENTANA 0501, 1180, -1, 16, "Empresa contable";
     nVentz1  = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PINPA #0#dsarw112;
     |PINDA #0#dsarw112;
     |ENDATOS #1#dsarw112;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentz1;
|FPRC;

|PROCESO CapturaTipo0;
     nError = 0;
     aTria  = "Un ";
     |SI nSwSolo1Doc = 0;
         |ABRE #dsarm004;
         #dsarm004#0 = enGrupo;
         #dsarm004#1 = enSubGrupo;
         #dsarm004#2 = enTipo;
         |LEE 000#dsarm004.=;
         |SI FSalida ! 0;  |DDEFECTO #dsarm004;  |FINSI;
         |CIERRA #dsarm004;

         nSwHayLibObligados = 0;
         |HAZ HayLibresObligatorio;

         aTria   = "FIN";
         nVarios = 1;
         |SI enDESPANET = 1;
             |SI #dsarm004#21 = "S"; |O #dsarm004#22 = "S";  |O #dsarm004#23 = "S"; |O #dsarm004#24 = "S"; |O nSwHayLibObligados = 1;
                 nVarios = 0;
             |FINSI;
         |SINO;
             |SI #dsarm004#20 = "S"; |O #dsarm004#21 = "S"; |O #dsarm004#22 = "S";
              |O #dsarm004#23 = "S"; |O #dsarm004#24 = "S"; |O nSwHayLibObligados = 1;
                 nVarios = 0;
             |FINSI;
         |FINSI;

         |SI enDESPANET = 1;
             |SI nVarios = 0;
                 aPopTria2  = 1;
                 aPopTria3  = "Un Documento";
             |SINO;
                 aPopTria2  = 3;
                 aPopTria3  = "Un Documento";
                 aPopTria4  = "Varios Documentos";
                 aPopTria5  = "Una Carpeta";
             |FINSI;
         |SINO;
             |SI nVarios = 0;
                 |SI #dsarm004#23 = "N";
                     aPopTria2  = 1;
                     aPopTria3  = "Un Documento";
                 |SINO;
                     aPopTria2  = 2;
                     aPopTria3  = "Un Documento";
                     aPopTria4  = "Capturar modelos";
                 |FINSI;
             |SINO;
                 |SI #dsarm004#23 = "N";
                     aPopTria2  = 3;
                     aPopTria3  = "Un Documento";
                     aPopTria4  = "Varios Documentos";
                     aPopTria5  = "Una Carpeta";
                 |SINO;
                     aPopTria2  = 4;
                     aPopTria3  = "Un Documento";
                     aPopTria4  = "Varios Documentos";
                     aPopTria5  = "Capturar modelos";
                     aPopTria6  = "Una Carpeta";
                 |FINSI;
             |FINSI;
         |FINSI;

         |SI #dsarm004#81 = "S"; |Y #dsarm001#168 = "S";
             aPopTria2  = 1;
             aPopTria3  = "Una Carpeta";
             aPopTria4  = "";
             aPopTria5  = "";
             aPopTria6  = "";
         |FINSI;

         aPopTria1  = "0";
         IaPopTria  = aPopTria1  <-;
         |ESPECIFICA "TRACKPOPUP", aPopTria;
         |SI FSalida ! 0;
             IaPopTria  = aPopTria3  <-;
             IaPopTria  = IaPopTria + (FSalida - 1);

             aTria = aPopTria % 103;
         |FINSI;
     |FINSI;

     |SI enSwModoClinica = 1;
          |SI enHHHHClinica ! 0;
               eaNomPaciente = "";
               eaTxtSQL = "SELECT * FROM historiasdiagram WHERE historias.codhis = " + enHHHHClinica;
               |HAZ EjecutaSQL1;
               |SI eaNomPaciente = "";
                    eaValorVinculoAux = enHHHHClinica;
               |SINO;
                    eaValorVinculoAux = eaNomPaciente;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI aTria = "FIN";
         enBotonCancelar = 1;
         nError = 1;
         |ACABA;
     |FINSI;

     |SI aTria = "Un ";
         |HAZ RecogeUno;
         |SI nError = 1;  |ACABA;  |FINSI;
     |FINSI;

     |SI aTria = "Var";
         nSwNumVarios = 0;
         |ABRE #dsarm004;
         |HAZ RecogeVarios;
         |CIERRA #dsarm004;

         |SI nSwNumVarios ! 0;
              |SI nSwNumVarios = 1;
                    aMensaje = "0000Capturado 1 documento.";
              |SINO;
                    aMensaje = "0000Capturados " + nSwNumVarios + " documentos.";
              |FINSI;
              |MENAV aMensaje;
         |FINSI;

         |SI nError = 1;  |ACABA;  |FINSI;
     |FINSI;

     |SI aTria = "Cap";
         |SUB_EJECUTA "dsarz100";
         |SI enErrorMod = 1;  |ACABA;  |FINSI;
     |FINSI;

     |SI aTria = "Una";       ||Una Carpeta
         ||Captura una carpeta

         |SI #dsarm004#81 = "S";
             |HAZ PideEmpContab;
         |FINSI;

         aAlfa = "DSeleccione la carpeta con los documentos a capturar";
         |BROWSE aAlfa;
         aAlfa = aAlfa % 2;
         |QBF aAlfa;
         |SI aAlfa ! "D";
              |HAZ CargaVarBorrado;

              eaCarpetaOrigen = aAlfa;
              aDirBrowse = aAlfa;
              nSwNumVarios = 0;
              |ABRE #dsarm004;
              |HAZ RecogeDeCarpeta;
              |CIERRA #dsarm004;

              |SI nSwNumVarios ! 0;
                   enEmpresa = #dsarw112#0;
                   eaNif     = #dsarw112#2;
                   eaTipo    = #dsarm004#91;
                   aAlfa = "dsarz013;listado";
                   |SUB_EJECUTA aAlfa;

                   |SI nSwNumVarios = 1;
                         aMensaje = "0000Capturado 1 documento.";
                   |SINO;
                         aMensaje = "0000Capturados " + nSwNumVarios + " documentos.";
                   |FINSI;
                   |MENAV aMensaje;
              |FINSI;
         |SINO;
              nError = 1;
         |FINSI;

         |SI nError = 1;  |ACABA;  |FINSI;
     |FINSI;
|FPRC;

|PROCESO CapturaTipo1;
     |SI enSwModoClinica = 1;
          |SI enHHHHClinica ! 0;
               eaNomPaciente = "";
               eaTxtSQL = "SELECT * FROM historiasdiagram WHERE historias.codhis = " + enHHHHClinica;
               |HAZ EjecutaSQL1;
               |SI eaNomPaciente = "";
                    eaValorVinculoAux = enHHHHClinica;
               |SINO;
                    eaValorVinculoAux = eaNomPaciente;
               |FINSI;
          |FINSI;
     |FINSI;


     nError = 0;

     |PINPA #0#dsarw009;
     |PINDA #0#dsarw009;

     |PTEC 802;
     |PAUSA;

     |REFERENCIA_DEF get1,#dsarw007;
     get2 = 2;
     Iget = get1<-;
     |ESPECIFICA "GETDATACONTROL",get;
     #dsarw007#2 = FSalida;

     #dsarw005#2 = #dsarw007#0;
     #dsarw005#8 = #dsarw007#1;
     #dsarw005#1 = #dsarw007#2;
     #dsarw005#4 = #dsarw007#3;
     #dsarw005#77 = #dsarw007#4;
     #dsarw005#79 = #dsarw007#5;

     |SI #dsarw005#77 = "P";
          aFicheroPDF = aPathRemoto + "\imagen.pdf";
          |RFBORRA aFicheroPDF;
     |FINSI;
     |SI #dsarw005#77 = "J";
          aFicheroPDF = aPathRemoto + "\imagen.jpg";
          |RFBORRA aFicheroPDF;
     |FINSI;

     |SI #dsarw005#77 ! "T"; |O #dsarw005#79 = "S";
          |HAZ Traete_imagemagick;
     |FINSI;

     |SI #dsarw005#8 = "P";
         aMensaje = "0000SIntroduzca la hoja numero: 1 en el Escaner. Continuar escaneando?";
         |CONFI aMensaje;
         |SI FSalida = 0;
             |HAZ Escaneo;
         |SINO;
             |PTEC 806;
             nError = 1;
             |ACABA;
         |FINSI;
     |SINO;
         |HAZ Escaneo;
     |FINSI;
|FPRC;

|PROCESO CapturaTipo2;
     nDocOrigenCopia = enDocumento;

     #dsarm005#0 = enDocumento;
     |LEE 000#dsarm005.=;
     |SI FSalida ! 0;  |DDEFECTO #dsarm005;  |FINSI;

     aFichero = #dsarm005#7;   |QBF aFichero;
     aFichero = aFichero + #dsarm005#9;
     |QBF aFichero;

     eaOrigen  = aFichero;
     eaDestino = aPathRemoto + "\" + #dsarm005#9;
     |QBF eaDestino;

     |SI #dsarm001#7 = "N";
         aIPRemoto   = "";
         |IP_REMOTO aIPRemoto;
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO eaOrigen, eaDestino;
         |SINO;
             |COPIA_FICHERO eaOrigen, eaDestino;
         |FINSI;
     |SINO;
         |SI eaOrigen ! eaDestino;
             eaDocPC = eaOrigen;
             |RCOPIA_FICHERO eaOrigen, eaDestino;
         |FINSI;
     |FINSI;

     |SI FSalida < 0;
         |MENAV "0000No puedo localizar el documento. Debe haber sido borrado o movido de carpeta";
         nError = 1;
         |ACABA;
     |FINSI;

     aFichero = eaDestino;
|FPRC;

|PROCESO Capturar;
     |SI enEscaneo = 1;
         |QBF aFicheroT;
         |SI aFicheroT = "";
               aFicheroT = aFichero;
         |FINSI;
         |HAZ CapturaTipo1;

         |SI nError = 1;  |ACABA;  |FINSI;
     |FINSI;

     |SI enEscaneo = 0;
         |HAZ CapturaTipo0;

         |SI nError = 1;  |ACABA;  |FINSI;
     |FINSI;

     |SI enEscaneo = 2;
         |ABRE #dsarm005;
         |HAZ CapturaTipo2;
         |CIERRA #dsarm005;
         |SI nError = 1;  |ACABA;  |FINSI;
     |FINSI;

     nError = 1;
     |XABRE "EC", aFichero, nHandle;
     |SI FSalida ] 0;
         nError   = 0;
         enSeguir = 1;
     |SINO;
          |SI enEscaneo = 1;
               aFichero = aPathRemoto + "\imagen1.tif"
               |XABRE "EC", aFichero, nHandle;
               |SI FSalida ] 0;
                   nError   = 0;
                   enSeguir = 1;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI enEscaneo = 1;
         |PTEC 806;
     |FINSI;
|FPRC;

|PROCESO PresentaDocumento;
     |HAZ DimeUnidad;

     |DBASE aPathBase;
     |QBF aPathBase;

     eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "dsabreextension.exe";
     eaOrigen = aPathBase + "dlls/dsabreextension.exe";
     |HAZ EnviaFicheroConMD5;

     aExtension = (aFichero % -104) > "";
     aAlfa1 = aExtension % 101;
     |SI aAlfa1 ! ".";
         aExtension = (aFichero % -105) > "";
     |FINSI;

     eaOrigen = aFichero;
     aNomDoc = ("000000000" + #dsarw005#76) % -109;
     eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + aNomDoc + aExtension;
     |SI eaOrigen ! eaDestino;
         |RCOPIA_FICHERO eaOrigen, eaDestino;
     |FINSI;

     aFicheroVer = eaDestino;

     |XABRE "EC", aFicheroVer, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     ||Historico
     |HORA aHora;
     aUsuario = Usuario % 810;
     |ABRE #flowm006;
     #flowm006#0  = #dsarw005#76;
     #flowm006#1  = 99999;
     |LEE 000#flowm006.];
     |SI FSalida = 0;
          |LEE 000#flowm006.a;
     |SINO;
          |LEE 000#flowm006.u;
     |FINSI;
     |SI FSalida = 0; |Y #flowm006#0  = #dsarw005#76;
          nLinea = #flowm006#1 + 1;
          nSitu = #flowm006#2;
     |SINO;
          nSitu = 1;
          nLinea = 1;
     |FINSI;
     |DDEFECTO #flowm006;
     #flowm006#0  = #dsarw005#76;
     #flowm006#1  = nLinea;
     |LEE 101#flowm006.=;
     |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
     #flowm006#2  = nSitu;
     #flowm006#3  = ~;
     #flowm006#4  = aHora;
     #flowm006#5  = aUsuario;
     aDocHis = ("000000000" + #dsarw005#76) % -109;
     #flowm006#6  = "VISUALIZADO DOCUMENTO: " + aDocHis;

     enNumRegFlow = #flowm006#0;
     enSituFlow = #flowm006#2;
     |HAZ DimeDesFlow;
     #flowm006#7 = eaDesSituFlow;

     |GRABA 020#flowm006.a;
     |LIBERA #flowm006;
     |CIERRA #flowm006;

     aEjecuta = "START " + eaUnidad + ":\DOCUMENTOS\DSARCHI\dsabreextension ";
     aEjecuta = aEjecuta + aFicheroVer;
     aEjecuta = aEjecuta + " " + eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";

     aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;

     |RSYSTEM aEjecuta;
     aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
     |PARA;  |SI;  |HACIENDO;
             |XABRE "EC", aAlfa, nHandle;
             |SI FSalida ] 0;
                 |SAL;
             |FINSI;

             |PARA nPausa = 1; |SI nPausa < 10000; |HACIENDO nPausa = nPausa + 1;
             |SIGUE;
             |PULSATECLA;
     |SIGUE;
     |PULSATECLA;

     aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;
|FPRC;

|PROCESO Boton3;
     |VENTANA 0501, 2999, -1, 16, "Visualizando Documento";
     nVentz1  = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PINPA #0#dsarw008;
     |PINDA #0#dsarw008;
     |PTEC 802;
     |PAUSA;

     |HAZ PresentaDocumento;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentz1;
|FPRC;

|PROCESO SacaUbicacion;
     aPath = #dsarm001#1;  |QBF aPath;

     |ABRE #dsarm002;
     |DDEFECTO #dsarm002;
     #dsarm002#0 = enGrupo;
     |LEE 000#dsarm002.=;
     |CIERRA #dsarm002;

     aPath = aPath + "/" + #dsarm002#2;  |QBF aPath;
     |SI #dsarm001#7 = "N";
         |MKDIR aPath;
     |SINO;
         |RMKDIR aPath;
     |FINSI;

     |SI #dsarm001#8 = "N";
         aPath = aPath + "/";
         aUbicacion = aPath;

         |ABRE #dsarm004;
         |DDEFECTO #dsarm004;
         #dsarm004#0 = enGrupo;
         #dsarm004#1 = 1;
         #dsarm004#2 = 1;
         |LEE 000#dsarm004.=;
         |CIERRA #dsarm004;

         |SI #dsarm004#75 = "S";
              fFechaSis = ~;
              aFechaSis = fFechaSis;
              aAAAAMM = (aFechaSis % -104) + (aFechaSis % 402);
              aUbicacion = aUbicacion + aAAAAMM + "/";
              |SI #dsarm001#7 = "N";
                   |MKDIR aUbicacion;
              |SINO;
                   |RMKDIR aUbicacion;
              |FINSI;
         |FINSI;


         |ACABA;
     |FINSI;

     |ABRE #dsarm003;
     |DDEFECTO #dsarm003;
     #dsarm003#0 = enGrupo;
     #dsarm003#1 = enSubGrupo;
     |LEE 000#dsarm003.=;
     |CIERRA #dsarm003;

     aPath = aPath + "/" + #dsarm003#3;  |QBF aPath;
     |SI #dsarm001#7 = "N";
         |MKDIR aPath;
     |SINO;
         |RMKDIR aPath;
     |FINSI;

     |ABRE #dsarm004;
     |DDEFECTO #dsarm004;
     #dsarm004#0 = enGrupo;
     #dsarm004#1 = enSubGrupo;
     #dsarm004#2 = enTipo;
     |LEE 000#dsarm004.=;
     |CIERRA #dsarm004;

     aPath = aPath + "/" + #dsarm004#4;  |QBF aPath;
     |SI #dsarm001#7 = "N";
         |MKDIR aPath;
     |SINO;
         |RMKDIR aPath;
     |FINSI;

     aPath = aPath + "/";
     aUbicacion = aPath;

     |SI #dsarm004#75 = "S";
          fFechaSis = ~;
          aFechaSis = fFechaSis;
          aAAAAMM = (aFechaSis % -104) + (aFechaSis % 402);
          aUbicacion = aUbicacion + aAAAAMM + "/";
          |SI #dsarm001#7 = "N";
               |MKDIR aUbicacion;
          |SINO;
               |RMKDIR aUbicacion;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ActDllTwain;
     |ESPECIFICA "RBASS", aLocal;
     aBaseLocal = aLocal;

     eaDestino   = aBaseLocal + "bin/dstwain.dll";
     aContiene1 = eaDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aVersion1  = FSalida;  |QBF aVersion1;

     |DBASE aBase;  |QBF aBase;
     eaOrigen    = aBase + "dlls/dstwain.dll";
     aContiene1 = eaOrigen;
     |ESPECIFICA "MD5", aContiene;
     aVersion2  = FSalida;  |QBF aVersion2;

     |SI aVersion1 ! aVersion2;
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;

         |SI aIPRemoto ! "";
             |ENVIA_FICHERO eaOrigen, eaDestino;
         |SINO;
             |COPIA_FICHERO eaOrigen, eaDestino;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO CalculaPanta;
     |PARA nCampo = 23;  |SI nCampo [ 52;  |HACIENDO nCampo = nCampo + 1;
           |C_V #dsarw005#nCampo#, 1, "N";
           |C_M #dsarw005#nCampo#, 1, "N";
     |SIGUE;

     |PARA nCampo = 66;  |SI nCampo [ 75;  |HACIENDO nCampo = nCampo + 1;
           |C_V #dsarw005#nCampo#, 1, "N";
           |C_M #dsarw005#nCampo#, 1, "N";
     |SIGUE;

     nCampoH = 4;
     |PARA nCampoD = 23;  |SI nCampoD [ 52;  |HACIENDO nCampoD = nCampoD + 2;
           nCampoH = nCampoH + 1;
           #dsarw005#nCampoD# = #dsarm004#nCampoH#;
     |SIGUE;

     nCampoH = 26;
     |PARA nCampoD = 66;  |SI nCampoD [ 75;  |HACIENDO nCampoD = nCampoD + 2;
           nCampoH = nCampoH + 1;
           #dsarw005#nCampoD# = #dsarm004#nCampoH#;
     |SIGUE;

     nPos1 = 2002;
     nPos2 = 2035;

     |PARA nCampo = 23;  |SI nCampo [ 32;  |HACIENDO nCampo = nCampo + 2;
           aAlfa = #dsarw005#nCampo#;  |QBF aAlfa;
           |SI aAlfa ! "";
               nPos1 = nPos1 + 100;
               nPos2 = nPos2 + 100;

               |C_P #dsarw005#nCampo#, 1, nPos1;
               |C_V #dsarw005#nCampo#, 1, "S";
               |C_M #dsarw005#nCampo#, 1, "N";

               nCampo1 = nCampo + 1;
               |C_P #dsarw005#nCampo1#, 1, nPos2;
               |C_V #dsarw005#nCampo1#, 1, "S";
               |C_M #dsarw005#nCampo1#, 1, "S";
           |FINSI;
     |SIGUE;

     |PARA nCampo = 66;  |SI nCampo [ 75;  |HACIENDO nCampo = nCampo + 2;
           aAlfa = #dsarw005#nCampo#;  |QBF aAlfa;
           |SI aAlfa ! "";
               nPos1 = nPos1 + 100;
               nPos2 = nPos2 + 100;

               |C_P #dsarw005#nCampo#, 1, nPos1;
               |C_V #dsarw005#nCampo#, 1, "S";
               |C_M #dsarw005#nCampo#, 1, "N";

               nCampo1 = nCampo + 1;
               |C_P #dsarw005#nCampo1#, 1, nPos2;
               |C_V #dsarw005#nCampo1#, 1, "S";
               |C_M #dsarw005#nCampo1#, 1, "S";
           |FINSI;
     |SIGUE;

     aPos   = nPos1;
     aPos   = ("0000" + aPos) % -0302;
     nLinea = aPos;

     nPosiciona = 0;
     |PARA nCampo = 33;  |SI nCampo [ 52;  |HACIENDO nCampo = nCampo + 2;
           aAlfa = #dsarw005#nCampo#;  |QBF aAlfa;
           |SI aAlfa ! "";
               nPosiciona = nPosiciona + 1;

               nResto = nPosiciona $ 2;
               |SI nResto ! 0;
                   nLinea = nLinea + 1;
                   nPos1  = (nLinea * 100) + 2;
                   nPos2  = (nLinea * 100) + 35;
               |SINO;
                   nPos1  = (nLinea * 100) + 52;
                   nPos2  = (nLinea * 100) + 86;
               |FINSI;

               |C_P #dsarw005#nCampo#, 1, nPos1;
               |C_V #dsarw005#nCampo#, 1, "S";
               |C_M #dsarw005#nCampo#, 1, "N";

               nCampo1 = nCampo + 1;
               |C_P #dsarw005#nCampo1#, 1, nPos2;
               |C_V #dsarw005#nCampo1#, 1, "S";
               |C_M #dsarw005#nCampo1#, 1, "S";
           |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Tipo80;  |TIPO 80;
     FSalida = 2999;
|FPRC;

|PROCESO BotonEscanear;
     enSeguir = 0;

     #dsarw007#0 = #dsarw005#2;
     #dsarw007#1 = #dsarw005#8;
     #dsarw007#2 = #dsarw005#1;
     #dsarw007#4 = #dsarw005#77;
     #dsarw007#5 = #dsarw005#79;
     aAux = #dsarw005#4;
     |QBF aAux;
     |SI aAux = "N"; |O aAux = "";
          #dsarw007#3 = "N";
          #dsarw007#2 = 1;
          |C_M #dsarw007#2, 1, "N";     |PINTA #dsarw007#2;
          #dsarw007#1 = "T";
     |SINO;
          #dsarw007#3 = "S";
          |C_M #dsarw007#2, 1, "S";     |PINTA #dsarw007#2;
          #dsarw007#1 = "P";
     |FINSI;

     |ABRE #dsarm005;
     |SELECT #1#dsarm005;
     |LEE 000#dsarm005.u;
     |SI FSalida ! 0;  |DDEFECTO #dsarm005;  |FINSI;
     |CIERRA #dsarm005;

     aAlfa =  "Escanear documento   (ultimo n£mero de registro: " + ((("000000000") + #dsarm005#0) % -109) + ")";

     |VENTANA 0501, 2999, -1, 16, aAlfa;
     nVentz1 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PINPA #0#dsarw007;
     nPanta907 = FSalida;

     |PINDA #0#dsarw007;
     |PULSATECLA;

     ||CONTROL_SIMPLE nPanta907, "BOTON,{{205} ESCANEAR", 1660, 1982, Capturar;
     |CONTROL_SIMPLE nPanta907, "BOTON,ESCANEAR", 1660, 1982, Capturar;
     nBoton = FSalida;

     |PTEC 802;
     |PAUSA;
     |PULSATECLA;

     |ENDATOS #2#dsarw007;
     |SI FSalida ! 0;
          aFichero = "";
     |FINSI;

     nError = enError;

     |FIN_CONTROL_WINDOWS nBoton;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentz1;
|FPRC;

|PROCESO Boton1;
     |PTEC 807;
|FPRC;

|PROCESO Boton2;
     |PTEC 806;
|FPRC;

|PROCESO Boton4;
     enGrupo      = #dsarw005#56;
     enSubGrupo   = #dsarw005#58;
     enTipo       = #dsarw005#60;
     enDocumento  = enDocuPpal;

     |VENTANA 0501, 3099, -1, 16, "Asociar Documentos";
     nVentz1 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;


     enNoClonarFlow = 1;
     ||Tiquet 2537 | 430
     |SUB_EJECUTA_NP "dsarz005";
     enNoClonarFlow = 0;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentz1;
|FPRC;

|PROCESO Boton5;
     |VENTANA 0501, 2799, -1, 16, "Documentos Asociados";
     nVentz1 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     enNoClonarFlow = 1;
     enDocumento = enDocuPpal;
     |SUB_EJECUTA "dsarz006";
     enNoClonarFlow = 0;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz1;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentz1;
|FPRC;

|PROCESO Boton6;
     nSwEstoyVolverCapturar = 1;
     |RFBORRA aFichero;
     |PULSATECLA;
     |SI enEscaneo = 1;
          ||HAZ VolveraEscanear;
          |HAZ BotonEscanear;
     |SINO;
         nSwSolo1Doc = 1;
         |HAZ Capturar;
         nSwSolo1Doc = 0;
     |FINSI;
     |PULSATECLA;
     nSwEstoyVolverCapturar = 0;
|FPRC;

|PROCESO dsarm007_1B;
     |BORRA 020#dsarm007.a;
     |LIBERA #dsarm007;
|FPRC;

|DEFBUCLE dsarm007_1B;
     #dsarm007#1;
     ;
     #dsarm005#0, 000000001;
     #dsarm005#0, 999999999;
     be;
     NULL, dsarm007_1B;
|FIN;

|PROCESO dsarm007_2B;
     |BORRA 020#dsarm007.a;
     |LIBERA #dsarm007;
|FPRC;

|DEFBUCLE dsarm007_2B;
     #dsarm007#2;
     ;
     #dsarm005#0, 000000001;
     #dsarm005#0, 999999999;
     be;
     NULL, dsarm007_2B;
|FIN;

|PROCESO VolveraEscanear;

     |CLS;
     |CABEZA "Escanear Documentos";

     |HAZ ActDllTwain;

     |ABRE #dsarm001;
     |DDEFECTO #dsarm001;
     |LEE 000#dsarm001.p;
     |CIERRA #dsarm001;

     |HAZ DimeUnidad;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aPathRemoto;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aPathRemoto;

     aFichero    = aPathRemoto + "\imagen.tif";
     |RFBORRA aFichero;
     aFicheroP   = aPathRemoto + "\imagen.tif";
     aFicheroT   = aPathRemoto + "\imagen.1tif";
     |RFBORRA aFicheroT;

     |ABRE #dsarm021;
     |DDEFECTO #dsarm021;
     |LEE 000#dsarm021.p;
     |CIERRA #dsarm021;

     #dsarw005#2 = #dsarm021#0;
     #dsarw005#8 = #dsarm021#1;
     #dsarw005#1 = #dsarm021#2;
     #dsarw005#4 = #dsarm021#3;
     #dsarw005#77 = #dsarm021#5;
     #dsarw005#79 = #dsarm021#6;

     |SI #dsarw005#77 = "P";
          aFicheroPDF = aPathRemoto + "\imagen.pdf";
          |RFBORRA aFicheroPDF;
     |FINSI;
     |SI #dsarw005#77 = "J";
          aFicheroPDF = aPathRemoto + "\imagen.jpg";
          |RFBORRA aFicheroPDF;
     |FINSI;

     enEscaneo = 1;
     |HAZ BotonEscanear;
     eaFicheroEscaner = aFichero;

     |ABRE #dsarm021;
     |DDEFECTO #dsarm021;
     #dsarm021#4 = "1";
     |LEE 101#dsarm021.=;
     |SI FSalida ! 0; |GRABA 020#dsarm021.b; |FINSI;
     #dsarm021#0 = #dsarw005#2;
     #dsarm021#1 = #dsarw005#8;
     #dsarm021#2 = #dsarw005#1;
     #dsarm021#3 = #dsarw005#4;
     #dsarm021#5 = #dsarw005#77;
     #dsarm021#6 = #dsarw005#79;
     |GRABA 020#dsarm021.a;
     |LIBERA #dsarm021;
     |CIERRA #dsarm021;
|FPRC;

|PROCESO SacaNombre;
     aNombre = "";
     aLong = aDirSaca % A0;
     nLong = aLong;
     |PARA nConta = 1; |SI nConta [ nLong; |HACIENDO nConta = nConta + 1;
          |SI nConta [ 99;
               aCampo = ("00" + nConta) % -102;
               aCampo = "-" + aCampo + "01";
               nCampo = aCampo;
               aValor = aDirSaca % nCampo;
               |SI aValor ! "/"; |Y aValor ! "\";
                    aNombre = aValor + aNombre;
               |SINO;
                    |SAL;
               |FINSI;
          |SINO;
               aNombre = "";
               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO camaniva;
     nSwHayIva = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE camaniva;
 #otromas@#2003;
 ;
 00, "01.01.0000", enImpoNumDoc;
 99, "31.12.2099", enImpoNumDoc;
 ;
 NULL, camaniva;
|FIN;

|PROCESO RellenoDel905;
     ||Finalmente NO lo uso para nada aqui.
     ||HAZ PreparaArray;

     #dsarw005#3  = #dsarm005#8;
     #dsarw005#9  = #dsarm005#14;
     #dsarw005#11 = #dsarm005#10;
     #dsarw005#12 = #dsarm005#11;
     #dsarw005#13 = #dsarm005#12;
     #dsarw005#14 = #dsarm005#13;
     #dsarw005#15 = #dsarm005#15;
     #dsarw005#16 = #dsarm005#16;
     #dsarw005#17 = #dsarm005#17;
     #dsarw005#18 = #dsarm005#18;
     #dsarw005#19 = #dsarm005#19;
     #dsarw005#20 = #dsarm005#20;
     #dsarw005#21 = #dsarm005#21;
     #dsarw005#22 = #dsarm005#22;
     aProg = #dsarm005#93;
     ||TODO CCC

     ||Copiar de como lo hago en el dsarw006. NO ME SIRVE
     nContReal = 0;
     |PARA nVoy = 23; |SI nVoy [ 37; |HACIENDO nVoy = nVoy + 1;
          aLibre = #dsarm005#nVoy#;
          |QBF aLibre;
          |SI aLibre ! "";
               nContReal = nContReal + 1;

               nContDos = 0;
               nSwNoSigas = 0;
               |PARA nEstoy = 5; |SI nEstoy < 9; |HACIENDO nEstoy = nEstoy + 1;
                    aLiteral = #dsarm004#nEstoy#;
                    |QBF aLiteral;
                    |SI aLiteral ! "";
                         nContDos = nContDos + 1;
                    |FINSI;
                    |SI nContReal = nContDos;
                         nSwNoSigas = 1;

                         aQuita = aLiteral + ": ";
                         aValor = aLibre - aQuita;
                         |SI FSalida = 0;
                              aQuita = aLiteral + ":";
                              aValor = aLibre - aQuita;
                         |FINSI;

                         |SI nEstoy = 5; #dsarw005#24 = aValor; |FINSI;
                         |SI nEstoy = 6; #dsarw005#26 = aValor; |FINSI;
                         |SI nEstoy = 7; #dsarw005#28 = aValor; |FINSI;
                         |SI nEstoy = 8; #dsarw005#30 = aValor; |FINSI;
                         |SI nEstoy = 9; #dsarw005#32 = aValor; |FINSI;
                         |SAL;
                    |FINSI;
               |SIGUE;
               |SI nSwNoSigas = 0;
                    |PARA nEstoy = 27; |SI nEstoy < 31; |HACIENDO nEstoy = nEstoy + 1;
                         aLiteral = #dsarm004#nEstoy#;
                         |QBF aLiteral;
                         |SI aLiteral ! "";
                              nContDos = nContDos + 1;
                         |FINSI;
                         |SI nContReal = nContDos;
                              nSwNoSigas = 1;

                              aQuita = aLiteral + ": ";
                              aValor = aLibre - aQuita;
                              |SI FSalida = 0;
                                   aQuita = aLiteral + ":";
                                   aValor = aLibre - aQuita;
                              |FINSI;

                              |SI nEstoy = 27; #dsarw005#66 = aValor; |FINSI;
                              |SI nEstoy = 28; #dsarw005#68 = aValor; |FINSI;
                              |SI nEstoy = 29; #dsarw005#70 = aValor; |FINSI;
                              |SI nEstoy = 30; #dsarw005#72 = aValor; |FINSI;
                              |SI nEstoy = 31; #dsarw005#74 = aValor; |FINSI;
                              |SAL;
                         |FINSI;
                    |SIGUE;
               |FINSI;
     ||ARA41
               |SI nSwNoSigas = 0;
                    |PARA nEstoy = 10; |SI nEstoy < 14; |HACIENDO nEstoy = nEstoy + 1;
                         aLiteral = #dsarm004#nEstoy#;
                         |QBF aLiteral;
                         |SI aLiteral ! "";
                              nContDos = nContDos + 1;
                         |FINSI;
                         |SI nContReal = nContDos;
                              nSwNoSigas = 1;

                              aQuita = aLiteral + ": ";
                              aValor = aLibre - aQuita;
                              |SI FSalida = 0;
                                   aQuita = aLiteral + ":";
                                   aValor = aLibre - aQuita;
                              |FINSI;

                              |SI nEstoy = 10; #dsarw005#34 = aValor; |FINSI;
                              |SI nEstoy = 11; #dsarw005#36 = aValor; |FINSI;
                              |SI nEstoy = 12; #dsarw005#38 = aValor; |FINSI;
                              |SI nEstoy = 13; #dsarw005#40 = aValor; |FINSI;
                              |SI nEstoy = 14; #dsarw005#42 = aValor; |FINSI;
                              |SAL;
                         |FINSI;
                    |SIGUE;
               |FINSI;
               |SI nSwNoSigas = 0;
                    |PARA nEstoy = 15; |SI nEstoy < 19; |HACIENDO nEstoy = nEstoy + 1;
                         aLiteral = #dsarm004#nEstoy#;
                         |QBF aLiteral;
                         |SI aLiteral ! "";
                              nContDos = nContDos + 1;
                         |FINSI;
                         |SI nContReal = nContDos;
                              nSwNoSigas = 1;

                              aQuita = aLiteral + ": ";
                              aValor = aLibre - aQuita;
                              |SI FSalida = 0;
                                   aQuita = aLiteral + ":";
                                   aValor = aLibre - aQuita;
                              |FINSI;

                              |SI nEstoy = 15; #dsarw005#44 = aValor; |FINSI;
                              |SI nEstoy = 16; #dsarw005#46 = aValor; |FINSI;
                              |SI nEstoy = 17; #dsarw005#48 = aValor; |FINSI;
                              |SI nEstoy = 18; #dsarw005#50 = aValor; |FINSI;
                              |SI nEstoy = 19; #dsarw005#52 = aValor; |FINSI;
                              |SAL;
                         |FINSI;
                    |SIGUE;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO FaltanObligatorios;
     ||Devuelve   nSwFaltaObligatorios   0 o 1

     ||ARA41
     nSwFaltaObligatorios = 0;
     |SI aPideCli = "S"; |Y #dsarw005#3 = 0;
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     |SI aPideNif = "S"; |Y #dsarw005#11 = "            ";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     |SI aPideTra = "S"; |Y #dsarw005#15 = 0;
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     |SI aPideMod = "S";
          |SI #dsarw005#19 = 0; |O #dsarw005#17 = 0; |O #dsarw005#18 = 0;
               nSwFaltaObligatorios = 1;
          |FINSI;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#24; |QBF aAux;
     |SI aPideA1 = "S"; |Y aAux = "";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#26; |QBF aAux;
     |SI aPideA2 = "S"; |Y aAux = "";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#28; |QBF aAux;
     |SI aPideA3 = "S"; |Y aAux = "";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#30; |QBF aAux;
     |SI aPideA4 = "S"; |Y aAux = "";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#32; |QBF aAux;
     |SI aPideA5 = "S"; |Y aAux = "";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#67; |QBF aAux;
     |SI aPideA6 = "S"; |Y aAux = "";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#69; |QBF aAux;
     |SI aPideA7 = "S"; |Y aAux = "";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#71; |QBF aAux;
     |SI aPideA8 = "S"; |Y aAux = "";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#73; |QBF aAux;
     |SI aPideA9 = "S"; |Y aAux = "";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#75; |QBF aAux;
     |SI aPideA10 = "S"; |Y aAux = "";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     nAux = #dsarw005#34;
     |SI aPideN1 = "S"; |Y nAux = 0;
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     nAux = #dsarw005#36;
     |SI aPideN2 = "S"; |Y nAux = 0;
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     nAux = #dsarw005#38;
     |SI aPideN3 = "S"; |Y nAux = 0;
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     nAux = #dsarw005#40;
     |SI aPideN4 = "S"; |Y nAux = 0;
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     nAux = #dsarw005#42;
     |SI aPideN5 = "S"; |Y nAux = 0;
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#44; |QBF aAux;
     |SI aPideF1 = "S"; |Y aAux = "01.01.0000";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#46; |QBF aAux;
     |SI aPideF2 = "S"; |Y aAux = "01.01.0000";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#48; |QBF aAux;
     |SI aPideF3 = "S"; |Y aAux = "01.01.0000";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#50; |QBF aAux;
     |SI aPideF4 = "S"; |Y aAux = "01.01.0000";
          nSwFaltaObligatorios = 1;
     |FINSI;

     |SI nSwFaltaObligatorios = 1; |ACABA; |FINSI;
     aAux = #dsarw005#52; |QBF aAux;
     |SI aPideF5 = "S"; |Y aAux = "01.01.0000";
          nSwFaltaObligatorios = 1;
     |FINSI;
|FPRC;

|PROCESO Clinica;
     enGrupoVinExte = enGrupo;
     enSubGrupoVinExte = enSubGrupo;
     enTipoVinExte = enTipo;

     enSwErrorVinExte = 0;
     |SI enSwModoClinica = 1;
          |SI enHHHHClinica ! 0;
               eaValorVinculo1 = enHHHHClinica;
               |SI enEEEEClinica ! 0;
                    eaValorVinculo2 = enEEEEClinica;
               |SINO;
                    eaValorVinculo2 = "";
               |FINSI;

               enSwVinculosExternos = 1;
               eaTipoVinculo = "CLINICA";
          |SINO;
               |HAZ VinculosExternos;
          |FINSI;
     |SINO;
          |HAZ VinculosExternos;
     |FINSI;
|FPRC;

|PROCESO CapturaEsteDoc;
     nMeteImpoADConta = 0;
     |SI aParametro ! "CAPTURAESTEDOC";
         |ACABA;
     |FINSI;

     |SI eaImpoAutoADConta ! "S";
         |ACABA;
     |FINSI;

     |SI enImpoNumDoc = 0;
         aDirSaca = eaDocCaptura;
         |HAZ SacaNombre;

         |SI enSwModoSilencio = 1;
             eaErrorDsEscan = "No es posible archivar con N£mero Documento 0 [" + aNombre + "]";
             enNumRegDsEscan = 0;
         |SINO;
             aMensaje = "0000No es posible archivar con N£mero Documento 0 [" + aNombre + "]";
             |MENAV aMensaje;
         |FINSI;
         enNoMoverImpoADConta = 1;
         |ACABA;
     |FINSI;

     |DBASS aBaseConta;
     |QBF aBaseConta;
     aDirConta = aBaseConta + "contagen/";
     aDirDatosFich = aDirConta + "fich/";
     aDef = aDirConta + "def/canempre";
     |CARGA_DEF aDef, otromas@;
     |SI FSalida ! 0;
         |SI enSwModoSilencio = 1;
             eaErrorDsEscan = "No es posible localizar la aplicacion de Contabilidad: contagen";
             enNumRegDsEscan = 0;
         |SINO;
             |MENAV "0000No es posible localizar la aplicacion de Contabilidad: contagen";
         |FINSI;
         enNoMoverImpoADConta = 1;
         |ACABA;
     |FINSI;

     |PATH_DAT #otromas@#aDirDatosFich#;

     |ABRE #otromas@;
     |DDEFECTO #otromas@;
     #otromas@#2 = enImpoEmpContagen;
     #otromas@#3 = enImpoPercontagen;
     |LEE 000#otromas@.=;
     |SI FSalida ! 0;
         |SI enSwModoSilencio = 1;
             eaErrorDsEscan = "No se encuentra la empresa/periodo en la contabilidad";
             enNumRegDsEscan = 0;
         |SINO;
             aMensaje = "0000No se encuentra la empresa/periodo en la contabilidad";
             |MENAV aMensaje;
         |FINSI;
         enNoMoverImpoADConta = 1;
         |CIERRA #otromas@;

         |DESCARGA_DEF #otromas@;

         |ACABA;
     |FINSI;
     |CIERRA #otromas@;
     |DESCARGA_DEF #otromas@;

     aDirDatos = aDirConta + "fich/" + (("00000" + enImpoEmpContagen) % -105) + (("0" + enImpoPercontagen) % -101) + "/";

     aDef = aDirConta + "def/camaasic";
     |CARGA_DEF aDef, otromas@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |PATH_DAT #otromas@#aDirDatos#;
     |ABRE #otromas@;
     |SELECT #3#otromas@;
     #otromas@#2 = enImpoNumDoc;
     |LEE 000#otromas@.=;
     |SI FSalida = 0;
         nMeteImpoADConta = 1;
         nCampo67 = enImpoEmpContagen;
         nCampo68 = enImpoPercontagen;
         nCampo69 = #otromas@#0;
         fCampo70 = #otromas@#1;
         nCampo71 = enImpoNumDoc;
     |SINO;
         |SI enSwModoSilencio = 1;
             eaErrorDsEscan = "No se encuentra el n£mero de documento " + enImpoNumDoc + ". No se importar ";
             enNumRegDsEscan = 0;
         |SINO;
             aMensaje = "No se encuentra el n£mero de documento " + enImpoNumDoc + ". No se importar ";
             |MENAV aMensaje;
         |FINSI;
         enNoMoverImpoADConta = 1;

         |CIERRA #otromas@;
         |DESCARGA_DEF #otromas@;
         |ACABA;
     |FINSI;
     |CIERRA #otromas@;
     |DESCARGA_DEF #otromas@;

     |SI nMeteImpoADConta = 1;
         aDef = aDirConta + "def/camaniva";
         |CARGA_DEF aDef, otromas@;
         |SI FSalida = 0;
             |PATH_DAT #otromas@#aDirDatos#;
             nSwHayIva = 0;
             |BUCLE camaniva;
             |SI nSwHayIva = 1;
                 nCampo72 = #otromas@#0;
                 nCampo73 = #otromas@#1;
                 aCampo74 = #otromas@#12;
             |FINSI;
             |DESCARGA_DEF #otromas@;

             |SI nSwHayIva = 0;
                 aDef = aDirConta + "def/camaasil";
                 |CARGA_DEF aDef, otromas@;
                 |SI FSalida = 0;
                     |PATH_DAT #otromas@#aDirDatos#;
                     |ABRE #otromas@;
                     #otromas@#0 = nCampo69;
                     #otromas@#1 = fCampo70;
                     #otromas@#2 = enImpoNumDoc;
                     #otromas@#3 = 1;
                     |LEE 000#otromas@.];
                     |SI FSalida = 0;
                         aCampo74 = #otromas@#4;
                     |SINO;
                         aCampo74 = "";
                     |FINSI;
                     |CIERRA #otromas@;
                     |DESCARGA_DEF #otromas@;
                 |FINSI;
             |FINSI;
         |FINSI;
    |FINSI;
|FPRC;

|PROCESO EntraDatos;
     nSalgo = 0;

     |SI aParametro = "CAPTURAESTEDOC";
          ||enErrorCaptura
          ||eaDocCaptura

          |CLS;
          |CABEZA "Captura documento";
          aFichero = eaDocCaptura;
          |ABRE #dsarm004;
          #dsarm004#0 = enGrupo;
          #dsarm004#1 = enSubGrupo;
          #dsarm004#2 = enTipo;
          |LEE 000#dsarm004.=;
          |SI FSalida ! 0;  |DDEFECTO #dsarm004;  |FINSI;
          |CIERRA #dsarm004;

          aDirSaca = eaDocCaptura;
          |HAZ SacaNombre;
          aProg = aNombre;

          ||AutoRelleno CONTAGEN.
          |SI #dsarm004#88 ! 0; |Y enSwPlantillaConta = 1;

               aUsuDebug = Usuario % 810;
               |QBF aUsuDebug;
               |SI aUsuDebug = "GONA"; |O aUsuDebug = "CARLOSC";
                   ||DEBUG;
               |FINSI;

               ||aMensaje = "0000Datos camaniva " + enLibroConta + "/" + enDocumentoConta;
               |||MENAV aMensaje;
               |HAZ GrabaLineaDocumento;

               nSalgo = 1;
               |ACABA;
          |FINSI;

          |SI #dsarm004#78 ! 0;  |O enDesdeCapturador = 1;
               |HAZ GrabaLineaDocumento;
               nSalgo = 1;
               |ACABA;
          |FINSI;
     |SINO;
          |SI enEscaneo = 1;
              |CLS;
              |CABEZA "Escanear Documentos";

              |HAZ ActDllTwain;

              aFichero    = aPathRemoto + "\imagen.tif"
              aFicheroP   = aPathRemoto + "\imagen.tif"
              aFicheroT   = aPathRemoto + "\imagen.1tif"

              |ABRE #dsarm021;
              |DDEFECTO #dsarm021;
              |LEE 000#dsarm021.p;
              |CIERRA #dsarm021;

              #dsarw005#2 = #dsarm021#0;
              #dsarw005#8 = #dsarm021#1;
              #dsarw005#1 = #dsarm021#2;
              #dsarw005#4 = #dsarm021#3;
              #dsarw005#77 = #dsarm021#5;
              #dsarw005#79 = #dsarm021#6;

              |SI #dsarw005#77 = "P";
                    aFicheroPDF = aPathRemoto + "\imagen.pdf";
                    |RFBORRA aFicheroPDF;
              |FINSI;
              |SI #dsarw005#77 = "J";
                    aFicheroPDF = aPathRemoto + "\imagen.jpg";
                    |RFBORRA aFicheroPDF;
              |FINSI;

              |HAZ BotonEscanear;

              |ABRE #dsarm021;
              |DDEFECTO #dsarm021;
              #dsarm021#4 = "1";
              |LEE 101#dsarm021.=;
              |SI FSalida ! 0; |GRABA 020#dsarm021.b; |FINSI;
              #dsarm021#0 = #dsarw005#2;
              #dsarm021#1 = #dsarw005#8;
              #dsarm021#2 = #dsarw005#1;
              #dsarm021#3 = #dsarw005#4;
              #dsarm021#5 = #dsarw005#77;
              #dsarm021#6 = #dsarw005#79;
              |GRABA 020#dsarm021.a;
              |LIBERA #dsarm021;
              |CIERRA #dsarm021;


              |SI nSwMultiReg = 1;
                  nSalgo = 1;
                  |ACABA;
              |FINSI;
          |FINSI;

          |SI enEscaneo = 0;  |O enEscaneo = 2;
              |CLS;
              |CABEZA "Recogida de Documentos";

              |HAZ Capturar;

              |SI aTria = "Var";
                   nSalgo = 1;
                  |ACABA;
              |FINSI;

              |SI aTria = "Una";
                  nSalgo = 1;
                  |ACABA;
              |FINSI;

              |SI nSwAcabaUnDocumento = 1; |Y nSwVengoDeOCR = 0;
                    nSwAcabaUnDocumento = 0;
                    nSalgo = 1;
                    |ACABA;
              |FINSI;
          |FINSI;

          |SI nError = 1;
              |CIERRA #dsarw005;
              |PULSATECLA;

              nSalgo = 1;
              |ACABA;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ElResto;
     nSalgo = 0;

     |ABRE #dsarm004;
     #dsarm004#0 = enGrupo;
     #dsarm004#1 = enSubGrupo;
     #dsarm004#2 = enTipo;
     |LEE 101#dsarm004.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsarm004;
         #dsarm004#0 = enGrupo;
         #dsarm004#1 = enSubGrupo;
         #dsarm004#2 = enTipo;
         |GRABA 020#dsarm004.n;
     |FINSI;
     |LIBERA #dsarm004;

     aPideCli = #dsarm004#20;
     aPideNif = #dsarm004#21;
     aPideTra = #dsarm004#22;
     aPideMod = #dsarm004#23;
     aPideMin = #dsarm004#24;
     aPideA1 = #dsarm004#55;
     aPideA2 = #dsarm004#56;
     aPideA3 = #dsarm004#57;
     aPideA4 = #dsarm004#58;
     aPideA5 = #dsarm004#59;
     aPideA6 = #dsarm004#60;
     aPideA7 = #dsarm004#61;
     aPideA8 = #dsarm004#62;
     aPideA9 = #dsarm004#63;
     aPideA10 = #dsarm004#64;
     aPideN1 = #dsarm004#65;
     aPideN2 = #dsarm004#66;
     aPideN3 = #dsarm004#67;
     aPideN4 = #dsarm004#68;
     aPideN5 = #dsarm004#69;
     aPideF1 = #dsarm004#70;
     aPideF2 = #dsarm004#71;
     aPideF3 = #dsarm004#72;
     aPideF4 = #dsarm004#73;
     aPideF5 = #dsarm004#74;

     |SI nSwVengoDeOCR = 1;
          |HAZ RellenoDel905;
          nSwFaltaObligatorios = 0;
          |HAZ FaltanObligatorios;

          |SI nSwFaltaObligatorios = 0;
              nSalgo = 1;
               |ACABA;
          |FINSI;

          ||ARA41
          enRegASustituir = #dsarm005#0;
     |FINSI;

     |SI enSwEstaIntegral = 1;
          ||Tiquet 4062.30.
          |SI aPideCli = "S";
               |MODO_RELACION #dsarw005, 0, "dsam0000", "X", "X";
          |FINSI;

          |MODO_RELACION #dsarw005, 0, "dsam0103", "X", "X";
          |MODO_RELACION #dsarw048, 0, "dsam0103", "X", "X";
     |SINO;
          |SI enSwEstaBasica = 1;
               |MODO_RELACION #dsarw005, 0, "agitab99", "X", "X";
               |SI aPideCli = "S";
                    |MODO_RELACION #dsarw005, 0, "agifigen", "X", "X";
               |FINSI;
               |MODO_RELACION #dsarw005, 0, "agim0003", "X", "X";

               |MODO_RELACION #dsarw048, 0, "agitab99", "X", "X";
               |MODO_RELACION #dsarw048, 0, "agim0003", "X", "X";
          |FINSI;
     |FINSI;


     |SI enSwEstaIntegral = 1;
          |SI aPideCli = "S";
               |MODO_RELACION #dsarw005, 1, "dsam0000", "N", "S";
          |FINSI;

          |MODO_RELACION #dsarw005, 1, "dsam0103", "N", "S";

          |MODO_RELACION #dsarw048, 1, "dsam0103", "N", "S";
     |SINO;
          |SI enSwEstaBasica = 1;
               |MODO_RELACION #dsarw005, 1, "agitab99", "N", "S";
               |SI aPideCli = "S";
                    |MODO_RELACION #dsarw005, 1, "agifigen", "N", "S";
               |FINSI;
               |MODO_RELACION #dsarw005, 1, "agim0003", "N", "S";

               |MODO_RELACION #dsarw048, 1, "agitab99", "N", "S";
               |MODO_RELACION #dsarw048, 1, "agim0003", "N", "S";
          |FINSI;
     |FINSI;

     |SI enSwEstaIntegral = 0;
         |MODO_RELACION #dsarw005, 1, "dsam0000", "N", "N";

         |MODO_RELACION #dsarw005, 1, "dsam0103", "N", "N";

         |MODO_RELACION #dsarw048, 1, "dsam0103", "N", "N";

         |MODO_RELACION #dsarw005, 1, "dsam0000", "X", "X";

         |MODO_RELACION #dsarw005, 1, "dsam0103", "X", "X";
         |MODO_RELACION #dsarw048, 1, "dsam0103", "X", "X";
         |SI enSwEstaBasica = 0;
              aPideCli = "N";
              aPideNif = "N";
         |FINSI;
     |FINSI;


     |SI enSwEstaBasica = 0;
          |MODO_RELACION #dsarw005, 1, "agifigen", "N", "N";
          |MODO_RELACION #dsarw005, 1, "agifigen", "X", "X";
          |MODO_RELACION #dsarw005, 1, "agim0003", "N", "N";
          |MODO_RELACION #dsarw005, 1, "agim0003", "X", "X";

          |MODO_RELACION #dsarw048, 1, "agim0003", "N", "N";
          |MODO_RELACION #dsarw048, 1, "agim0003", "X", "X";
     |FINSI;

     |DBASS aBase;  |QBF aBase;
     aMas = aBase + "/laboral/def/nomw0003.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida < 0;
         aPideTra = "N";
     |FINSI;

     aMas = aBase + "/basica/def/agitab99.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida < 0;
         aPideMod = "N";

         |MODO_RELACION #dsarw005, 1, "agitab99", "N", "N";
         |MODO_RELACION #dsarw005, 1, "agitab99", "X", "X";

         |MODO_RELACION #dsarw048, 1, "agitab99", "N", "N";
         |MODO_RELACION #dsarw048, 1, "agitab99", "X", "X";
     |FINSI;


     aMas = aBase + "/facturar/def/asclient.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida < 0;
         aPideMin = "N";
     |FINSI;

     |SI nSwVengoDeOCR = 0;
          ||NO PONERLOS A CERO SI VENGO DEL OCR, DE CAPTURAR LOS DATOS.
          #dsarw005#3  = 0;
          #dsarw005#9  = "";
          #dsarw005#11 = "";
          #dsarw005#12 = "";
          #dsarw005#13 = "";
          #dsarw005#14 = "";
          #dsarw005#15 = 0;
          #dsarw005#16 = "";
          #dsarw005#17 = 0;
          #dsarw005#18 = 0;
          #dsarw005#19 = 0;
          #dsarw005#20 = 0;
          #dsarw005#21 = "";
          #dsarw005#22 = "";
          |PDEFECTO #dsarw005, 23, 56;
          |PDEFECTO #dsarw005, 66, 76;
     |FINSI;

     |SI enEscaneo = 2;
         #dsarw005#3  = #dsarm005#8;
         #dsarw005#9  = #dsarm005#14;
         #dsarw005#11 = #dsarm005#10;
         #dsarw005#12 = #dsarm005#11;
         #dsarw005#13 = #dsarm005#12;
         #dsarw005#14 = #dsarm005#13;
         #dsarw005#15 = #dsarm005#15;
         #dsarw005#16 = #dsarm005#16;
         #dsarw005#17 = #dsarm005#17;
         #dsarw005#18 = #dsarm005#18;
         #dsarw005#19 = #dsarm005#19;
         #dsarw005#20 = #dsarm005#20;
         #dsarw005#21 = #dsarm005#21;
         #dsarw005#22 = #dsarm005#22;
     |FINSI;


     |C_M #dsarw005#3,  1, aPideCli;
     |C_M #dsarw005#11, 1, aPideNif;
     |C_M #dsarw005#15, 1, aPideTra;
     |C_M #dsarw005#19, 1, aPideMod;
     |C_M #dsarw005#54, 1, aPideMin;
     |C_M #dsarw005#55, 1, aPideMin;
     |C_M #dsarw005#65, 1, aPideDocCarpeta;

     |C_M #dsarw005#17, 1, "S";
     |C_M #dsarw005#18, 1, "S";
     |SI aPideTra = "N";  |Y aPideMod = "N";
         #dsarw005#17 = 0;  |C_M #dsarw005#17, 1, "N";
         #dsarw005#18 = 0;  |C_M #dsarw005#18, 1, "N";
     |FINSI;

     |C_M #dsarw005#20, 1, "S";
     |SI aPideMod = "N";
         #dsarw005#20 = 0;  |C_M #dsarw005#20, 1, "N";
     |FINSI;

     |SI aPideCli = "S";
          |MODO_RELACION #dsarw005, 1, ":/integral/def/dsam0103", "X", "X";
          |MODO_RELACION #dsarw005, 1, ":/integral/def/dsam0103", "N", "S";
     |SINO;
          |MODO_RELACION #dsarw005, 1, ":/integral/def/dsam0103", "N", "N";
          |MODO_RELACION #dsarw005, 1, ":/integral/def/dsam0103", "X", "X";
     |FINSI;

     |HAZ SacaUbicacion;


     #dsarw005#56 = #dsarm002#0;
     #dsarw005#57 = #dsarm002#1;
     #dsarw005#58 = #dsarm003#1;
     #dsarw005#59 = #dsarm003#2;
     #dsarw005#60 = #dsarm004#2;
     #dsarw005#61 = #dsarm004#3;
     #dsarw005#62 = ((#dsarm002#3  / #dsarm002#4)  + 0.48) ! 0;
     #dsarw005#63 = ((#dsarm003#4  / #dsarm003#5)  + 0.48) ! 0;
     #dsarw005#64 = ((#dsarm004#25 / #dsarm004#26) + 0.48) ! 0;

     |SI #dsarw005#62 = 0;  #dsarw005#62 = 1;  |FINSI;
     |SI #dsarw005#63 = 0;  #dsarw005#63 = 1;  |FINSI;
     |SI #dsarw005#64 = 0;  #dsarw005#64 = 1;  |FINSI;

     |SI enRegASustituir = 0;
          |ABRE #dsarm005;
          |SELECT #2#dsarm005;
          #dsarm005#1 = enGrupo;
          #dsarm005#2 = enSubGrupo;
          #dsarm005#3 = enTipo;
          #dsarm005#0 = 999999999;
          |LEE 000#dsarm005.];
          |SI FSalida = 0;
              |LEE 000#dsarm005.a;
          |SINO;
              |LEE 000#dsarm005.u;
          |FINSI;

          #dsarw005#65 = 1;
          |SI FSalida = 0;  |Y #dsarm005#1 = enGrupo;  |Y #dsarm005#2 = enSubGrupo;
           |Y #dsarm005#3 = enTipo;
              #dsarw005#65 = #dsarm005#47 + 1;
          |FINSI;
          |SELECT #1#dsarm005;
          |CIERRA #dsarm005;
     |FINSI;

     |PTEC 802;
     |PAUSA;
     |PULSATECLA;

     |PINPA #0#dsarw005;  nPanta905_0 = FSalida;  |PULSATECLA;

     |SI #dsarm001#8 = "N";
         |C_V #dsarw005#58, 1, "N";
         |C_V #dsarw005#59, 1, "N";
         |C_V #dsarw005#60, 1, "N";
         |C_V #dsarw005#61, 1, "N";
         |C_V #dsarw005#63, 1, "N";
         |C_V #dsarw005#64, 1, "N";

         |PINTA 0602, "              ";
         |PINTA 0702, "              ";
     |FINSI;

     |PULSATECLA;

     |SI enRegASustituir = 0;
          nDocu      = 1;
          |ABRE #dsarm005;
          |LEE 000#dsarm005.u;
          |SI FSalida = 0;
               nDocu = #dsarm005#0 + 1;
          |FINSI;

          |ABRE #dsarm100;
          |DDEFECTO #dsarm100;
          |LEE 000#dsarm100.p;
          |SI FSalida = 0;
               nUltimoDoc = #dsarm100#1 + 1;
          |SINO;
               nUltimoDoc = 1;
          |FINSI;
          |SI nUltimoDoc > nDocu;
               nDocu = nUltimoDoc;
          |FINSI;
          #dsarm100#0 = "1";
          |LEE 101#dsarm100.=;
          |SI FSalida ! 0; |GRABA 020#dsarm100.b; |FINSI;
          #dsarm100#1 = nDocu;
          |GRABA 020#dsarm100.a;
          |LIBERA #dsarm100;
          |CIERRA #dsarm100;

          |DDEFECTO #dsarm005;
          #dsarm005#0 = nDocu;
          #dsarm005#1 = enGrupo;
          #dsarm005#2 = enSubGrupo;
          #dsarm005#3 = enTipo;
          #dsarm005#4 = ~;
          |GRABA 020#dsarm005.b;
     |SINO;
          |ABRE #dsarm005;
          |DDEFECTO #dsarm005;
          #dsarm005#0 = enRegASustituir;
          |LEE 101#dsarm005.=;
          |SI FSalida ! 0; |GRABA 020#dsarm005.b; |FINSI;

          nDocu = #dsarm005#0;

          |SI nSwVengoDeOCR = 0;

               #dsarw005#3 = #dsarm005#8;
               #dsarw005#11 = #dsarm005#10;
               #dsarw005#12 = #dsarm005#11;
               #dsarw005#13 = #dsarm005#12;
               #dsarw005#14 = #dsarm005#13;
               #dsarw005#9 = #dsarm005#14;
               #dsarw005#15 = #dsarm005#15;
               #dsarw005#16 = #dsarm005#16;
               #dsarw005#17 = #dsarm005#17;
               #dsarw005#18 = #dsarm005#18;
               #dsarw005#19 = #dsarm005#19;
               #dsarw005#20 = #dsarm005#20;
               #dsarw005#21 = #dsarm005#21;
               #dsarw005#22 = #dsarm005#22;
               #dsarw005#53 = #dsarm005#38;
               #dsarw005#54 = #dsarm005#39;
               #dsarw005#55 = #dsarm005#40;
               #dsarw005#78 = #dsarm005#95;
               #dsarw005#80 = #dsarm005#99;
               #dsarw005#81 = #dsarm005#100;

               nCampoH = 4;
               |PARA nCampoD = 23;  |SI nCampoD [ 52;  |HACIENDO nCampoD = nCampoD + 2;
                     nCampoH = nCampoH + 1;
                     #dsarw005#nCampoD# = #dsarm004#nCampoH#;
               |SIGUE;

               nCampoH = 26;
               |PARA nCampoD = 66;  |SI nCampoD [ 75;  |HACIENDO nCampoD = nCampoD + 2;
                     nCampoH = nCampoH + 1;
                     #dsarw005#nCampoD# = #dsarm004#nCampoH#;
               |SIGUE;

               nCampoH = 22;
               nVoy = 0;
               |PARA nCampoD = 23; |SI nCampoD [ 32;  |HACIENDO nCampoD = nCampoD + 1;
                    aAlfa     = #dsarw005#nCampoD#;  |QBF aAlfa;
                    nCampoD   = nCampoD + 1;
                    |SI aAlfa ! "";
                         aAlfa = aAlfa + ": ";
                         nVoy = nVoy + 1;

                         |SI nVoy < 16;
                              nCampo005 = nCampoH + nVoy;
                         |SINO;
                              nCampo005 = nCampoH + 22 + nVoy;    ||22 es la diferencia 60-22-16.
                         |FINSI;
                         aAlfa1 = #dsarm005#nCampo005#;  |QBF aAlfa1;
                         aAlfaDif = aAlfa1 - aAlfa;
                         |SI aAlfaDif ! ""; |Y aAlfaDif ! "01.01.0000"; |Y aAlfaDif ! "0";
                              #dsarw005#nCampoD# = aAlfaDif;
                         |FINSI;
                    |FINSI;
               |SIGUE;

               |PARA nCampoD = 66; |SI nCampoD [ 75;  |HACIENDO nCampoD = nCampoD + 1;
                    aAlfa     = #dsarw005#nCampoD#;  |QBF aAlfa;
                    nCampoD   = nCampoD + 1;
                    |SI aAlfa ! "";
                         aAlfa = aAlfa + ": ";
                         nVoy = nVoy + 1;

                         |SI nVoy < 16;
                              nCampo005 = nCampoH + nVoy;
                         |SINO;
                              nCampo005 = nCampoH + 22 + nVoy;    ||22 es la diferencia 60-22-16.
                         |FINSI;
                         aAlfa1 = #dsarm005#nCampo005#;  |QBF aAlfa1;
                         aAlfaDif = aAlfa1 - aAlfa;
                         |SI aAlfaDif ! ""; |Y aAlfaDif ! "01.01.0000"; |Y aAlfaDif ! "0";
                              #dsarw005#nCampoD# = aAlfaDif;
                         |FINSI;
                    |FINSI;
               |SIGUE;

               |PARA nCampoD = 33; |SI nCampoD [ 51;  |HACIENDO nCampoD = nCampoD + 1;
                    aAlfa     = #dsarw005#nCampoD#;  |QBF aAlfa;
                    nCampoD   = nCampoD + 1;
                    |SI aAlfa ! "";
                         aAlfa = aAlfa + ": ";
                         nVoy = nVoy + 1;

                         |SI nVoy < 16;
                              nCampo005 = nCampoH + nVoy;
                         |SINO;
                              nCampo005 = nCampoH + 22 + nVoy;    ||22 es la diferencia 60-22-16.
                         |FINSI;
                         aAlfa1 = #dsarm005#nCampo005#;  |QBF aAlfa1;
                         aAlfaDif = aAlfa1 - aAlfa;
                         |SI aAlfaDif ! ""; |Y aAlfaDif ! "01.01.0000"; |Y aAlfaDif ! "0";
                              #dsarw005#nCampoD# = aAlfaDif;
                         |FINSI;
                    |FINSI;
               |SIGUE;

               #dsarw005#62 = #dsarm005#44;
               #dsarw005#63 = #dsarm005#45;
               #dsarw005#64 = #dsarm005#46;
               #dsarw005#65 = #dsarm005#47;

          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Pantalla;
     |SI enDESPANET = 1;
         aAlfa  = Usuario % 810;
         #dsarw005#3 = aAlfa;
         |C_M #dsarw005#3, 1, "N";
     |FINSI;

     |PULSATECLA;

     |PINDA #0#dsarw005;

     |PULSATECLA;

     aPos = nPos1;
     aPos = ("0000" + aPos) % -0302;

     nPos1 = aPos;  nPos1 = nPos1 + 2;  nPos1 = (nPos1 * 100) + 89;
     nPos2 = aPos;  nPos2 = nPos2 + 2;  nPos2 = (nPos2 * 100) + 99;
     ||CONTROL_SIMPLE nPanta905_0, "BOTON,{{207}} Cancelar", nPos1, nPos2, Boton1;
     |CONTROL_SIMPLE nPanta905_0, "BOTON,Cancelar", nPos1, nPos2, Boton1;
     nBoton1 = FSalida;

     |PULSATECLA;

     nPos1 = aPos;  nPos1 = nPos1 + 2;  nPos1 = (nPos1 * 100) + 77;
     nPos2 = aPos;  nPos2 = nPos2 + 2;  nPos2 = (nPos2 * 100) + 87;
     ||CONTROL_SIMPLE nPanta905_0, "BOTON,{{206}} Validar ", nPos1, nPos2, Boton2;
     |CONTROL_SIMPLE nPanta905_0, "BOTON,Validar ", nPos1, nPos2, Boton2;
     nBoton2 = FSalida;
     |PULSATECLA;

     nPos1 = aPos;  nPos1 = nPos1 + 2;  nPos1 = (nPos1 * 100) + 42;
     nPos2 = aPos;  nPos2 = nPos2 + 2;  nPos2 = (nPos2 * 100) + 57;
     ||CONTROL_SIMPLE nPanta905_0, "BOTON,{{137}} Ver Documento", nPos1, nPos2, Boton3;
     |CONTROL_SIMPLE nPanta905_0, "BOTON,Ver Documento", nPos1, nPos2, Boton3;
     nBoton3 = FSalida;
     |PULSATECLA;

     nPos1 = aPos;  nPos1 = nPos1 + 2;  nPos1 = (nPos1 * 100) + 59;
     nPos2 = aPos;  nPos2 = nPos2 + 2;  nPos2 = (nPos2 * 100) + 75;
     ||CONTROL_SIMPLE nPanta905_0, "BOTON,{{197}} Volver a capturar", nPos1, nPos2, Boton6;
     |CONTROL_SIMPLE nPanta905_0, "BOTON,Volver a capturar", nPos1, nPos2, Boton6;
     nBoton6 = FSalida;
     |PULSATECLA;

     nPos1 = aPos;  nPos1 = nPos1 + 2;  nPos1 = (nPos1 * 100) + 22;
     nPos2 = aPos;  nPos2 = nPos2 + 2;  nPos2 = (nPos2 * 100) + 40;
     ||CONTROL_SIMPLE nPanta905_0, "BOTON,{{197}} Asociar Documento", nPos1, nPos2, Boton4;
     |CONTROL_SIMPLE nPanta905_0, "BOTON,Asociar Documento", nPos1, nPos2, Boton4;
     nBoton4 = FSalida;
     |PULSATECLA;

     nPos1 = aPos;  nPos1 = nPos1 + 2;  nPos1 = (nPos1 * 100) + 02;
     nPos2 = aPos;  nPos2 = nPos2 + 2;  nPos2 = (nPos2 * 100) + 20;
     ||CONTROL_SIMPLE nPanta905_0, "BOTON,{{204}} Visualizar Asociados", nPos1, nPos2, Boton5;
     |CONTROL_SIMPLE nPanta905_0, "BOTON,Visualizar Asociados", nPos1, nPos2, Boton5;
     nBoton5 = FSalida;
     |PULSATECLA;

     enDocumento = #dsarm005#0;
     enDocuPpal  = #dsarm005#0;

     #dsarw005#76 = nDocu;   |PINTA #dsarw005#76;

     |PTEC 802;
     |PAUSA;

     |PULSATECLA;

     nGraba   = 0;
     nEndatos = 0;
     |SI eaNomDef = "cainliva";
          |SI #dsarm004#88 ! 0;
              nEndatos = 1;
          |FINSI;
     |FINSI;

     |SI nEndatos = 0;
         |PARA;  |SI;  |HACIENDO;
              |ENDATOS #1#dsarw005;
              |SI nGraba ! 2;  |SAL;  |FINSI;
         |SIGUE;
     |FINSI;

     |SI enRegASustituir = 0;
          |SI nCambio ! 0;
              |BORRA 020#dsarm005.a;
              |LIBERA #dsarm005;

              nDocu = nCambio;
              #dsarm005#0  = nCambio;
              |LEE 101#dsarm005.=;
              |SI FSalida = 0;
                  |HAZ GrabaDocumento;
              |FINSI;
          |SINO;
              |SI nGraba = 0;
                  |HAZ GrabaDocumento;
                  enErrorCaptura = 0;
              |SINO;
                  enErrorCaptura = 1;
                  |BORRA 020#dsarm005.a;
                  |LIBERA #dsarm005;

                  |BUCLE dsarm007_1B;
                  |BUCLE dsarm007_2B;
              |FINSI;
          |FINSI;
     |SINO;
          |SI nCambio ! 0;
              |LIBERA #dsarm005;
              nDocu = nCambio;
              #dsarm005#0  = nCambio;
              |LEE 101#dsarm005.=;
              |SI FSalida = 0;
                  |HAZ GrabaDocumento;
              |FINSI;
          |SINO;
              |SI nGraba = 0;
                  |HAZ GrabaDocumento;
                  enErrorCaptura = 0;
              |SINO;
                  enErrorCaptura = 1;
              |FINSI;
          |FINSI;
     |FINSI;

     |CIERRA #dsarm005;
     |CIERRA #dsarm004;
     |CIERRA #dsarw005;

     |SI aParametro ! "CAPTURAESTEDOC";
         aOrigen = aFichero;
         |SI #dsarm001#181 = "N";
              |QBF eaUnidad;
              |SI eaUnidad = "";
                   eaUnidad = "C";
              |FINSI;
              aDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + #dsarm005#9;
              |QBF aDestino;
              |RRENOMBRA_FICHERO aOrigen, aDestino;
         |SINO;
              |RFBORRA aFichero;
         |FINSI;
     |FINSI;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton2;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton4;
     |FIN_CONTROL_WINDOWS nBoton5;
     |FIN_CONTROL_WINDOWS nBoton6;

     |PULSATECLA;
|FPRC;

|PROCESO EstaIntegral;
     enSwEstaIntegral = 0;
     |DBASS aBase;
     aMas = aBase + "/integral/def/dsam0000.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida ] 0;
         enSwEstaIntegral = 1;
     |FINSI;
|FPRC;

|PROCESO EstaBasica;
     enSwEstaBasica = 0;

     |DBASS aBase;
     aMas = aBase + "/basica/def/agifigen.mas";
     |XABRE "E", aMas, nHandle;
     |SI FSalida ] 0;
         enSwEstaBasica = 1;
     |FINSI;
|FPRC;

|PROGRAMA;
     aAlfa = PARAMETRO - "DSPARTES";
     |SI FSalida ! 0;
         |SUB_EJECUTA "dsarz100;DesdeDSPARTES";
         |ACABA;
     |FINSI;

     |HAZ Clinica;
     |SI enSwErrorVinExte = 1;
          |ACABA;
     |FINSI;

     enSwRealizadodsEscan = 0;

     |HAZ LeeUnidadBasico;

     aSwScanPdf = "N";
     aParametro = PARAMETRO;
     |QBF aParametro;
     |SI aParametro = "VOLVERESCANEAR";
          |HAZ VolveraEscanear;
          |ACABA;
     |FINSI;

     |HAZ CapturaEsteDoc;
     |SI enNoMoverImpoADConta = 1;  |ACABA;  |FINSI;

     |PULSATECLA;

     |HAZ EstaIntegral;       ||Nos devuelve si esta integral (1) o no esta (0)
     |HAZ EstaBasica;         ||Nos devuelve si esta basica (1) o no esta (0)

     |ABRE #dsarm001;
     |DDEFECTO #dsarm001;
     |LEE 000#dsarm001.p;
     |CIERRA #dsarm001;

     |ABRE #dsarz010;
     aUsuario = Usuario % 810;
     |DDEFECTO #dsarz010;
     #dsarz010#0 = aUsuario;
     |LEE 000#dsarz010.=;
     |SI FSalida ! 0;
          |PARA nCampo = 3;  |SI nCampo [ 52;  |HACIENDO nCampo = nCampo + 1;
               #dsarz010#nCampo# = "S";
          |SIGUE;
     |FINSI;
     aPideDocCarpeta = #dsarz010#10;
     aSwdsEscan = #dsarz010#13;
     |CIERRA #dsarz010;

     |HAZ DimeUnidad;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aPathRemoto;
     aPathRemoto = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aPathRemoto;

     |HAZ eCambioDeCero;

     |ABRE #dsarw005;
     |DDEFECTO #dsarw005;

     |HAZ EntraDatos;
     |SI nSalgo = 1;  |ACABA;  |FINSI;

     |HAZ ElResto;
     |SI nSalgo = 1;  |ACABA;  |FINSI;

     |HAZ CalculaPanta;

     |HAZ Pantalla;

     enRegASustituir = 0;
|FPRO;
