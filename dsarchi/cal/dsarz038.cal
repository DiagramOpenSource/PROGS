|FICHEROS;
     dsarz038;

     dsarm000;           || Usuarios
     dsarm001;           ||Parametros
     dsarm004;
     dsarm005;
     dsarm006;           ||Entrada/Salidas Doc.
     dsarm007;           ||Entrada/Salidas Doc.
     dsarm029;           ||Plantillas AutoRelle
     dsarm030;
     dsarm031;
     dsarm034;           ||Registro documentos
     dsarm035;           ||VAR. Resul. dsEscan
     dsarm036;           ||Control Integridad
     dsarm037;           ||Memos Ajustar en DS
     dsarm046;
     dsarm054;

     dpntm101;           ||Facturas Recibidas.
     flowm006;

     dsarz041;           ||Vistas Arbol dsEscan
     dsarz010;

     dsarw008;
     dsarw017;
     dsarw018,MANTE;
     dsarw068;           ||Aux.Editar Variables
     dsarw069;
     dsarw079,MANTE;     ||Aux Ajustar en DS
     dsarw010;           ||Configurar DSCORREO
     dsarw013;
     dsarw019;

     gridref@;           ||CargaDef para mostrar los datos en un grid. (Para vista por Arbol).
     registro@;
     canemp1@;
     canemp2@;

     &regisnif@;
|FIN;

|VARIABLES;
     aVarContenido = "";
     nContReal = 0;
     nSwAcaba = 0;
     aTextoLibre = "";

     nLibre = 0;
     nSwHayCambios5 = 0;
     nCampo005 = 0;
     nAuxVoy = 0;
     aBuscaVar = "";
     nSwFormularioOk = 0;
     &enNoTocarEmpPerContagen = 0;
     nSwValidaSinInte = 0;
     aAuxPais = "";
     &enSwReintentarOCR = 0;

     ||dsenviacorreo
     &eaAdjuntoPLB = "";
     &eaServidorSMTP = "";
     &eaUsuarioPLB = "";
     &eaPassPLB = "";
     &eaOrigenPLB = "";
     &eaDestinoPLB = "";
     &eaDirRespoPLB = "";
     &eaAsuntoPLB = "";
     &eaCuerpoPLB = "";
     &eaConfLecPLB = "";
     &enSwErrorCorreoPLB = 0;
     &eaBorraCache1 = "";
     &eaBorraCache2 = "";

     ||Borra los registros en el dpntm101
     aPathDatos101 = "";
     aEmpB = "";
     aBaseB = "";
     aMasB = "";

     {-1}aSerie = "";
     nIni = 0;

     aBorraCache = "";

     ||Ajustar en DS
     nSwSinRestaModal = 0;
     aEmailDestino = "";
     &enAprobacion = 0;
     &enErrorCorreo = 0;
     aIPLocal = "";
     aQueSistema = "";
     nGuarda = 0;
     &eaPrograma = "";
     nSwSMTPCLI = 0;
     nSwDsEnviaCorreo = 0;
     aNomTgz = "";
     aDestinoTgz = "";
     aDirectorio = "";
     aPathAdj2 = "";
     aNomFichero = "";
     aIni = "";
     aAuxBarra = "";
     aAuxExtension = "";
     aFicTar = "";
     aBorra = "";
     nSwTgzOk = 0;
     &enSwDesde9 = 0;
     nVent1 = 0;
     aAdjunto = "";
     aIP = "";
     aFrom = "";
     aSalida = "";
     aTo = "";
     aAsunto = "";
     aAutenti = "";
     aVersion1 = "";
     aVersion2 = "";
     direc = "";
     nVoy = 0;
     nSaca = 0;
     nPon = 0;
     {1}aLocal       = "";
     aBaseLocal = "";
     {1}aContiene     = "";
     aCuerpo = "";
     nHandleC = 0;
     aTextoMe = "";

     nVoyCampo = 0;
     nVent17 = 0;
     nPanta579 = 0;

     &enNumRegFlow = 0;
     &enSituFlow = 0;
     &eaDesSituFlow = "";

     nPendValidar = 0;

     aAuxTabla = "";
     nComas = 0;
     aAux = "";
     aVacio20 = "";
     aZeta20 = "";
     nDNivel1 = 0;
     nHNivel1 = 0;
     nDNivel2 = 0;
     nHNivel2 = 0;
     nDNivel3 = 0;
     nHNivel3 = 0;
     nDNivel4 = 0;
     nHNivel4 = 0;
     nDNivel5 = 0;
     nHNivel5 = 0;

     aFicheroBorra = "";
     nSwCargaDefGrid = 0;
     aNomDef = "";
     nCampoDos = 0;
     aFicGrid = "";

     aNomVariable = "";
     aAuxAlfa = "";
     aProPI = "";
     aProPI2 = "";
     nTipoDoc = 0;
     aTabla = "";
     nCampoTabla = 0;

     aNomVarAra = "";
     aValorAnt = "";
     nSwFormulario = 0;
     aDocHis = "";
     aPais = "";
     nCuenta = 0;
     fFechaAra = @;
     aHoraAra = "";
     aNomAra = "";

     nSwProcesa = 0;
     nValor     = 0;

     nVentwVer = 0;
     &eaDimeActividad = "";
     nSwHayIncidencia = 0;
     aVacio = "";

     fFechaBucle = @;
     aHoraBucle = "";
     aNomBucle = "";

     aAlfaAux = "";

     nProcesados = 0;
     aPathDatos = "";
     nSwDentro = 0;
     nReg = 0;
     aEmpContagen = "";

     &enSwModoIntegridad = 0;
     &enCodPrimeraInc = 0;
     &eaPrimeraInc = "";

     &enPantallaFR000000 = -1;

     aValorAntes = "";
     aValorDespues = "";

     nVentz68 = 0;
     nGrid68 = 0;
     nPanta68 = 0;

     &eaUsuario = "";
     aIncidencia = "";
     nNumVar = 0;
     aVacio25 = "";
     aZeta25 = "";
     aTextoLabel = "";
     &enSwAvisaInte = 0;
     &eaProcesoPIInte = "";
     &enResultadoInte = 0;
     &efFechaInte = @;
     &eaHoraInte = "";
     &eaFicInte = "";
     &enCodIncidencia = 0;
     &eaIncidencia = "";
     &enNumTotalDocs = 0;
     &enVoyPorDoc    = 0;

     aIntegridadOK = 0;
     aIntegridad = "";

     aProcesoPI = "";
     nCodPlantilla = 0;
     aCodPlantilla = "";
     nSwTieneProceso = 0;

     nLinea = 0;
     nSitu = 0;
     aOriHis = "";
     aDesHis = "";
     aUsuario = "";
     aAsociado = "";

     aPathBase = "";
     aAuxNom = "";
     &eaDestino = "";
     &eaOrigen = "";
     nVentw6 = 0;
     &eaUnidad = "";
     aEjecuta = "";
     nPausa = 0;

     nHandle = 0;
     aMensaje = "";
     nCampoD        = 0;
     nCampoH        = 0;
     nCampo         = 0;
     nGrid0         = -1;
     nGridDos       = -1;
     nGrid992       = -1;
     nPanta0        = 0;
     nVentana       = 0;
     nVent992       = 0;
     nVentFecha     = 0;
     nVentz5        = 0;
     nVentTrab      = 0;
     nVent          = -1;
     nRango         = 0;
     nFichero       = 0;
     nBoton1      = 0;
     nBoton2      = 0;
     nBoton3      = -1;
     nBoton4      = 0;
     nBoton6      = 0;
     nBoton7      = 0;
     nBoton8      = 0;
     nBoton9      = 0;
     nBoton10     = 0;
     nBoton11     = 0;
     nBoton12     = 0;
     nBoton13     = 0;
     nBoton14     = 0;
     nBoton17     = 0;
     nBoton16     = -1;

     nBotonArbol     = -1;
     nBotonLineal    = -1;
     nBotonCambia    = -1;
     nBotonActualiza = -1;
     nBotonFecha     = -1;
     nBotonUsu       = 0;

     nBotonTodos = -1;
     nBotonProce = -1;
     nBotonPendi = -1;

     nTree           = -1;
     nSuma1          = -1;
     nSuma2          = -1;
     nSuma3          = -1;
     nSuma4          = -1;
     nSuma5          = -1;

     aTipoArbol     = "";
     aEsc1          = "";
     aEsc2          = "";
     aRetu          = "";
     aTecla         = "";
     aAlfa          = "";
     aAlfa1         = "";
     aAlfa2         = "";
     aAlfa3         = "";
     aAlfa4         = "";
     aAlfa5         = "";
     aAlfa10        = "";
     aFichero       = "";
     aParametro     = "";
     aQueQuiero     = "";
     aEmpConta      = "";

     aOrigen        = "";
     aDestino       = "";
     aIPRemoto      = "";
     aBase          = "";
     aMas           = "";
     aHora          = "";
     aLetra         = "";
     aCifAra        = "";
     aDef           = "";
     aBaseConta     = "";
     aDirDatos      = "";
     aCifContagen   = "";
     aBusca         = "";
     aAuxBusca      = "";
     aBuscaReal     = "";
     nSwBuscaReal   = 0;
     aAbre          = "";
     aRefresca      = "";
     aCarpeta1      = "";
     aCarpeta2      = "";
     aCarpeta3      = "";
     aCarpeta4      = "";
     aCarpeta5      = "";
     aCarpeta6      = "";
     aTexto         = "";
     aLong          = "";
     aCarac         = "";
     aDFecha        = "";
     aHFecha        = "";
     aDTipo         = "";
     aHTipo         = "";
     aTipoFecha     = "";
     aQueUsu        = "";
     aTipoEstado = "";
     aFechaGuarda   = "";
     aLinea35       = "";
     aRespuestaOCR  = "";

     nError         = 0;
     nEstadoGrid    = 0;
     nBotonLabel    = 0;
     nCarpeta1      = 0;
     nCarpeta2      = 0;
     nCarpeta3      = 0;
     nCarpeta4      = 0;
     nCarpeta5      = 0;
     nCarpeta6      = 0;
     nLong          = 0;
     nCargar        = 0;
     nPosi          = 0;
     nPos           = 0;
     nActArbol      = 0;
     nNume          = 0;
     nPasada        = 0;
     nChequeaPro    = 0;
     nRegPrimerIVA  = 0;
     nSituacion     = 0;
     nQueSituacion  = 0;

     fFecha           = @;
     fFecha1          = @;
     fFecha2          = @;

     {-1}sTree        = 0;
     sT_nID           = 0;
     sT_nOper         = 0;
     sT_aData         = "";

     {200}aPopup      = "";
     {200}aOpcion     = "";
     nOpcion = 0;
     &enBusqueda = 0;
     nContador = 0;

     {-1}aVent      = "";
         aVent1     = 0;
         aVent2     = 0;
         aVent3     = 0;
         aVent4     = 0;
         aVent5     = "";

     &enModo        = 0;
     &eaClave       = "";
     &enPassword    = 0;
     &enDocumento   = 0;
     &enDocuPpal    = 0;
     &eaFichero     = "";
     &enError       = 0;
     &enGrupo       = 0;
     &enSubGrupo    = 0;
     &enTipo        = 0;
     &enNumCampos   = 0;
     &efFechaOCR    = @;
     &eaHoraOCR     = "";
     &eaCarpetaOrigen = "";
     &eaRutaOrigen    = "";
     &eaRutaDestino   = "";
     &eaUnidadBasico  = "";
     &eaFicheroTxt    = "";
     &eaFicheroTgz    = "";
     &eaFicheroTar    = "";
     &eaAlfa          = "";
     &enRecupera      = 0;
     &enMensaOCX      = 0;
     &enNIF           = 0;
     &eaCodNif        = "";
     &eaValor         = "";
     &eaVar           = "";
     &enBotonProv     = -1;
     &enModoFormulario = 0;
     &enSituacion      = 0;
     &enSwNomina       = 0;
     &eaQueProcesoPI   = "";
|FIN;

|PROCESO BajaClave555;
     #gridref@#0 = nDNivel1;
     #gridref@#1 = nDNivel2;
     #gridref@#2 = nDNivel3;
     #gridref@#3 = nDNivel4;
     #gridref@#4 = nDNivel5;
     #gridref@#8 = "01.01.0000";
     #gridref@#9 = "     ";
     #gridref@#10 = aVacio20;
|FPRC;

|PROCESO AltaClave555;
     #gridref@#0 = nHNivel1;
     #gridref@#1 = nHNivel2;
     #gridref@#2 = nHNivel3;
     #gridref@#3 = nHNivel4;
     #gridref@#4 = nHNivel5;
     #gridref@#8 = "31.12.2099";
     #gridref@#9 = "zzzzz";
     #gridref@#10 = aZeta20;
|FPRC;

|PROCESO BajaClave1;
     #dsarm034#0  = aDFecha;
     #dsarm034#1  = "00:00";
     #dsarm034#2  = "                    ";
|FPRC;

|PROCESO AltaClave1;
     #dsarm034#0  = aHFecha;
     #dsarm034#1  = "99:99";
     #dsarm034#2  = "zzzzzzzzzzzzzzzzzzzz";
|FPRC;

|PROCESO BajaClave4;
     #dsarm034#17 = "FR000000";
     #dsarm034#6  = aQueUsu;
     #dsarm034#0  = aDFecha;
     #dsarm034#1  = "00:00";
     #dsarm034#2  = "                    ";
|FPRC;

|PROCESO AltaClave4;
     #dsarm034#17 = "FR000000";
     #dsarm034#6  = aQueUsu;
     #dsarm034#0  = aHFecha;
     #dsarm034#1  = "99:99";
     #dsarm034#2  = "zzzzzzzzzzzzzzzzzzzz";
|FPRC;

|PROCESO BajaClave5;
     #dsarm034#17 = "FR000000";
     #dsarm034#0  = aDFecha;
     #dsarm034#1  = "00:00";
     #dsarm034#2  = "                    ";
     #dsarm034#10 = aDTipo;
|FPRC;

|PROCESO AltaClave5;
     #dsarm034#17 = "FR000000";
     #dsarm034#0  = aHFecha;
     #dsarm034#1  = "99:99";
     #dsarm034#2  = "zzzzzzzzzzzzzzzzzzzz";
     #dsarm034#10 = aHTipo;
|FPRC;

|PROCESO BajaClave6;
     #dsarm034#6  = aQueUsu;
     #dsarm034#0  = aDFecha;
     #dsarm034#1  = "00:00";
     #dsarm034#2  = "                    ";
     #dsarm034#10 = aDTipo;
|FPRC;

|PROCESO AltaClave6;
     #dsarm034#6  = aQueUsu;
     #dsarm034#0  = aHFecha;
     #dsarm034#1  = "99:99";
     #dsarm034#2  = "zzzzzzzzzzzzzzzzzzzz";
     #dsarm034#10 = aHTipo;
|FPRC;

|PROCESO Situacion;
     aAlfa = #dsarm034#15;
     |QBF aAlfa;
     enSituacion = 0;
     |SI aAlfa = "110,110,110;255,255,255";    || Gris
         enSituacion = 1;
     |FINSI;

     |SI aAlfa = "192,192,192;255,255,255";    || Otro Gris
         enSituacion = 1;
     |FINSI;

     |SI #dsarm034#7 = 0;  |Y #dsarm034#9 ! "I";
         enSituacion = 1;
     |FINSI;

     |SI enSituacion = 0;
         ||Tiquet. 577.987
         |SI #dsarm034#9 = "I";                             || Rosa. Documento NO valido
             |ESTADO_CONTROL nBoton3, "HIDE";
             |ESTADO_CONTROL nBoton16, "SHOW";
         |SINO;
             |ESTADO_CONTROL nBoton16, "HIDE";
             |ESTADO_CONTROL nBoton3, "SHOW";
         |FINSI;
     |FINSI;

     |SI enSituacion = 1;
         |ESTADO_CONTROL nBoton3, "HIDE";
         |ESTADO_CONTROL nBoton16, "SHOW";
     |FINSI;
|FPRC;

|PROCESO EventoGrid0;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#dsarm034.=;
         |SI FSalida ! 0;
             aTextoLabel = "                                                                    ";
             aTextoLabel = "LABEL,{{002}}" + aTextoLabel;
             |CONTROL_SIMPLE nPanta0,  aTextoLabel, 3002, 3088, NULL;

             |ESTADO_CONTROL nBoton1, "DISABLE";
             |ESTADO_CONTROL nBoton3, "DISABLE";
             |ESTADO_CONTROL nBoton6, "DISABLE";
             |ESTADO_CONTROL nBoton11, "DISABLE";
             |ESTADO_CONTROL nBoton13, "DISABLE";
             |ESTADO_CONTROL nBoton14, "DISABLE";
             |ESTADO_CONTROL nBoton4, "DISABLE";
             |ESTADO_CONTROL nBoton12, "DISABLE";
             |ACABA;
         |FINSI;

         |HAZ EnciendeBotones;
     |FINSI;

     |SI FSalida = 4;
     |FINSI;
|FPRC;

|PROCESO EventoGridDos;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#gridref@.=;
         |SI FSalida ! 0;
             aTextoLabel = "                                                                    ";
             aTextoLabel = "LABEL,{{002}}" + aTextoLabel;
             |CONTROL_SIMPLE nPanta0,  aTextoLabel, 3002, 3088, NULL;

             |ESTADO_CONTROL nBoton1, "DISABLE";
             |ESTADO_CONTROL nBoton3, "DISABLE";
             |ESTADO_CONTROL nBoton6, "DISABLE";
             |ESTADO_CONTROL nBoton11, "DISABLE";
             |ESTADO_CONTROL nBoton13, "DISABLE";
             |ESTADO_CONTROL nBoton14, "DISABLE";
             |ESTADO_CONTROL nBoton4, "DISABLE";
             |ESTADO_CONTROL nBoton12, "DISABLE";

             |ACABA;
         |FINSI;

         |SI aQueUsu = "";
             |SELECT #1#dsarm034;
             #dsarm034#0 = #gridref@#8;
             #dsarm034#1 = #gridref@#9;
             #dsarm034#2 = #gridref@#10;
             |LEE 000#dsarm034.=;
         |FINSI;

         |SI aQueUsu ! "";
             |SELECT #4#dsarm034;
             #dsarm034#17 = "FR000000";
             #dsarm034#6  = aQueUsu;
             #dsarm034#0  = #gridref@#8;
             #dsarm034#1  = #gridref@#9;
             #dsarm034#2  = #gridref@#10;
             |LEE 000#dsarm034.=;
         |FINSI;

         |SI FSalida = 0;
             |HAZ EnciendeBotones;
         |SINO;
             aTextoLabel = "                                                                    ";
             aTextoLabel = "LABEL,{{002}}" + aTextoLabel;
             |CONTROL_SIMPLE nPanta0,  aTextoLabel, 3002, 3088, NULL;

             |ESTADO_CONTROL nBoton1, "DISABLE";
             |ESTADO_CONTROL nBoton3, "DISABLE";
             |ESTADO_CONTROL nBoton6, "DISABLE";
             |ESTADO_CONTROL nBoton11, "DISABLE";
             |ESTADO_CONTROL nBoton13, "DISABLE";
             |ESTADO_CONTROL nBoton14, "DISABLE";
             |ESTADO_CONTROL nBoton4, "DISABLE";
             |ESTADO_CONTROL nBoton12, "DISABLE";
         |FINSI;
     |FINSI;

     |SI FSalida = 4;
     |FINSI;
|FPRC;

|PROCESO LinealSinLimite;
     nRango = 2 + 4 + 8 + 16 + 32 + 128;

     |SI nGrid0 ! -1;
         |DESTRUYECONTROL nGrid0;
         nGrid0 = -1;
     |FINSI;

     |LINEAL_SIMPLE #5#dsarm034, nRango, 0602, 2998, BajaClave5, AltaClave5, EventoGrid0;
     nGrid0 = FSalida;
|FPRC;

|PROCESO LinealPorUsuario;
     nRango = 2 + 4 + 8 + 16 + 32 + 128;

     |SI nGrid0 ! -1;
         |DESTRUYECONTROL nGrid0;
         nGrid0 = -1;
     |FINSI;

     |LINEAL_SIMPLE #6#dsarm034, nRango, 0602, 2998, BajaClave6, AltaClave6, EventoGrid0;
     nGrid0 = FSalida;
|FPRC;

|PROCESO dsarm036_vacioz038;
     |SI #dsarm036#2 = "S";
          |DDEFECTO #dsarm035;
          #dsarm035#0 = #dsarm034#0;
          #dsarm035#1 = #dsarm034#1;
          #dsarm035#2 = #dsarm034#2;
          #dsarm035#3 = #dsarm036#1;
          |LEE 101#dsarm035.=;
          |SI FSalida ! 0;
               nSwHayIncidencia = 1;
               enCodIncidencia = 1;
               eaIncidencia = "Variable vacia [" + #dsarm036#1;
               |QBF eaIncidencia;
               eaIncidencia = eaIncidencia + "]";
               |SI enSwAvisaInte = 1;
                    |ERROR10;
               |FINSI;
          |SINO;
               aVacio = #dsarm035#4;
               |QBF aVacio;
               |SI aVacio = "";
                    nSwHayIncidencia = 1;
                    enCodIncidencia = 1;
                    eaIncidencia = "Variable vacia [" + #dsarm036#1;
                    |QBF eaIncidencia;
                    eaIncidencia = eaIncidencia + "]";
                    #dsarm035#5 = 2;
                    #dsarm035#7 = enCodIncidencia;
                    #dsarm035#6 = eaIncidencia;
                    #dsarm035#8 = "255,0,0;255,255,255";
                    |GRABA 020#dsarm035.a;
                    |SI enSwAvisaInte = 1;
                         |LIBERA #dsarm035;
                         |ERROR10;
                    |FINSI;
               |FINSI;
               |LIBERA #dsarm035;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm036_vacioz038;
 #dsarm036#1;
 ;
 aProcesoPI, aVacio25;
 aProcesoPI, aZeta25;
 ;
 NULL, dsarm036_vacioz038;
|FIN;

|PROCESO dsarm035_incidencia;
     nNumVar = nNumVar + 1;

     |SI #dsarm035#7 ! 0;
          aIncidencia = #dsarm035#6;
          |QBF aIncidencia;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm035_incidencia;
 #dsarm035#1;
 ;
 #dsarm034#0, #dsarm034#1, #dsarm034#2, aVacio25;
 #dsarm034#0, #dsarm034#1, #dsarm034#2, aZeta25;
 be;
 NULL, dsarm035_incidencia;
|FIN;

|PROCESO EnciendeBotones;
     |HAZ Situacion;

     nPendValidar = 0;

     |SI #dsarm034#9 = "I";
          aTextoLabel = "Documento no v lido. Pinche en texto dsEscan para ver motivos     ";
     |SINO;
          |SI #dsarm034#7 = 0;
              aTextoLabel = "Documento a la espera de plantilla. Pendiente de reintentar        ";
          |SINO;
              |SI #dsarm034#22 = "S";
                   aTextoLabel = "Documento contabilizado                                                ";
              |SINO;
                   |SI #dsarm034#10 = "S";
                       aTextoLabel = "Documento validado. Pendiente de contabilizar                       ";
                   |SINO;
                       |SI #dsarm034#9 = "S";
                           aTextoLabel = "Integridad OK. Pendiente de validar                                 ";
                           nPendValidar = 1;
                       |FINSI;
                       |SI #dsarm034#9 = "N";
                           aIncidencia = "";
                           nNumVar = 0;
                           ||TODO CCC.
                           ||Falta controlar las variables vacias.
                           nSwHayIncidencia = 0;
                           aProcesoPI = #dsarm034#17;
                           |QBF aProcesoPI;
                           |SI aProcesoPI = "";
                               aTextoLabel = "No existe proceso asignado al documento                             ";
                           |SINO;
                               |BUCLE dsarm036_vacioz038;
                               |SI nSwHayIncidencia = 1;
                                   aTextoLabel = "Variables obligatorias vacias                                       ";
                              |SINO;
                                   |BUCLE dsarm035_incidencia;
                                   |SI aIncidencia = "";
                                       |SI nNumVar = 0;
                                           aTextoLabel = "No existen variables en el documento                                          ";
                                       |SINO;
                                           aTextoLabel = "Integridad OK. Pendiente de validar                                 ";
                                           nPendValidar = 1;
                                       |FINSI;
                                   |SINO;
                                       aTextoLabel = (aIncidencia + "                                                                    ") % 170;
                                   |FINSI;
                               |FINSI;
                           |FINSI;
                       |FINSI;
                   |FINSI;
              |FINSI;
         |FINSI;
     |FINSI;

     aTextoLabel = "LABEL,{{002}}" + aTextoLabel;
     |CONTROL_SIMPLE nPanta0,  aTextoLabel, 3002, 3088, NULL;

     |ESTADO_CONTROL nBoton1, "ENABLE";
     |ESTADO_CONTROL nBoton6, "ENABLE";
     |ESTADO_CONTROL nBoton11, "ENABLE";
     |ESTADO_CONTROL nBoton14, "ENABLE";
     |ESTADO_CONTROL nBoton13, "DISABLE";
     |ESTADO_CONTROL nBoton4, "DISABLE";
     |ESTADO_CONTROL nBoton12, "DISABLE";

     |SI nPendValidar = 1;
          |ESTADO_CONTROL nBoton4, "ENABLE";
     |SINO;
          |SI #dsarm001#199 = "S";      ||Validar sin integridad.

               |SI enSituacion = 0;
                    |SI #dsarm034#10 = "S"; |Y #dsarm034#22 = "N";
                         |ESTADO_CONTROL nBoton4, "DISABLE";
                    |SINO;
                         |SI #dsarm034#10 = "N";
                              |ESTADO_CONTROL nBoton4, "ENABLE";
                         |SINO;
                              |SI #dsarm034#22 = "N";
                                   |ESTADO_CONTROL nBoton4, "ENABLE";
                              |SINO;
                                   |ESTADO_CONTROL nBoton4, "DISABLE";
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #dsarm034#9 = "S";
         |SI #dsarm034#10 = "N";
             |SI #dsarm034#18 ! 0;
                 |ESTADO_CONTROL nBoton13, "ENABLE";
             |FINSI;
         |FINSI;
     |FINSI;

     |SI #dsarm034#10 = "N";
         |ESTADO_CONTROL nBoton3, "ENABLE";
     |SINO;
          |SI #dsarm034#22 = "N";
               |ESTADO_CONTROL nBoton3, "ENABLE";
          |SINO;
               |ESTADO_CONTROL nBoton3, "DISABLE";
          |FINSI;
     |FINSI;

     |SI #dsarm034#9 = "I";
         |ESTADO_CONTROL nBoton3, "DISABLE";
     |SINO;
          |SI #dsarm034#7 = 0;
               |ESTADO_CONTROL nBoton12, "ENABLE";
          |FINSI;
     |FINSI;

     |SI #dsarm034#9 = "N"; |Y #dsarm034#10 = "N";  |Y #dsarm034#7 ! 0;
         |ESTADO_CONTROL nBoton12, "ENABLE";
     |FINSI;
|FPRC;

|PROCESO SacaNiveles;
     nComas = 0;
     aAux = "";

     aLong = aTexto % A0;
     nLong = aLong;
     |PARA nPosi  = 1;  |SI nPosi [ nLong;  |HACIENDO nPosi = nPosi + 1;
          nPos = (nPosi * 100) + 1;
          aCarac = aTexto % nPos;
          |SI aCarac = ",";
               nComas = nComas + 1;

               |SI nComas = 1;
                    nDNivel1 = aAux;
                    nHNivel1 = aAux;
               |SINO;
                    |SI nComas = 2;
                         nDNivel2 = aAux;
                         nHNivel2 = aAux;
                    |SINO;
                         |SI nComas = 3;
                              nDNivel3 = aAux;
                              nHNivel3 = aAux;
                         |SINO;
                              |SI nComas = 4;
                                   nDNivel4 = aAux;
                                   nHNivel4 = aAux;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
               aAux = "";
          |SINO;
               aAux = aAux + aCarac
          |FINSI;
     |SIGUE;

     |SI aAux ! "";
          |SI nComas = 0;
               nDNivel1 = aAux;
               nHNivel1 = aAux;
          |SINO;
               |SI nComas = 1;
                    nDNivel2 = aAux;
                    nHNivel2 = aAux;
               |SINO;
                    |SI nComas = 2;
                         nDNivel3 = aAux;
                         nHNivel3 = aAux;
                    |SINO;
                         |SI nComas = 3;
                              nDNivel4 = aAux;
                              nHNivel4 = aAux;
                         |SINO;
                              nDNivel5 = aAux;
                              nHNivel5 = aAux;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO EventoTree;
     |SI FEntrada = 0;
         aAlfa        = Contenido;  |QBF aAlfa;
         aTexto       = "";
         aLong        = aAlfa % 0;
         nLong        = aLong;
         nCargar      = 0;
         |PARA nPosi  = 1;  |SI nPosi [ nLong;  |HACIENDO nPosi = nPosi + 1;
               nPos = (nPosi * 100) + 1;
               aCarac = aAlfa % nPos;

               |SI nCargar = 1;
                   aTexto = aTexto + aCarac;
               |FINSI;

               |SI aCarac = ":";  nCargar = 1; |FINSI;
         |SIGUE;

         |SI aTexto = "";
             |ESTADO_CONTROL nBoton1,  "DISABLE";
             |ESTADO_CONTROL nBoton3,  "DISABLE";
             |ESTADO_CONTROL nBoton6,  "DISABLE";
             |ESTADO_CONTROL nBoton11, "DISABLE";
             |ESTADO_CONTROL nBoton13, "DISABLE";
             |ESTADO_CONTROL nBoton14, "DISABLE";
             |ESTADO_CONTROL nBoton4, "DISABLE";
             |ESTADO_CONTROL nBoton12, "DISABLE";

             nDNivel1 = 0;
             nHNivel1 = 9999;
             nDNivel2 = 0;
             nHNivel2 = 9999;
             nDNivel3 = 0;
             nHNivel3 = 9999;
             nDNivel4 = 0;
             nHNivel4 = 9999;
             nDNivel5 = 0;
             nHNivel5 = 9999;
             |REFRESCACONTROL nGridDos;

             |ACABA;
         |SINO;
             aMensaje = "0000Estoy en la rama " + aTexto;
             ||MENAV aMensaje;
             nDNivel1 = 0;
             nHNivel1 = 9999;
             nDNivel2 = 0;
             nHNivel2 = 9999;
             nDNivel3 = 0;
             nHNivel3 = 9999;
             nDNivel4 = 0;
             nHNivel4 = 9999;
             nDNivel5 = 0;
             nHNivel5 = 9999;

             ||Saco de aTexto los niveles
             |HAZ SacaNiveles;
             |REFRESCACONTROL nGridDos;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaTempoz38;
     |SELECT #1#dsarw017;
     #dsarw017#0 = #dsarm034#16;
     |LEE 101#dsarw017.=;
     |SI FSalida ! 0; |GRABA 020#dsarw017.b; |FINSI;

     #dsarw017#1 = aAlfa1 > "";
     #dsarw017#2 = aAlfa2 > "";
     #dsarw017#3 = aAlfa3 > "";
     #dsarw017#4 = aAlfa4 > "";
     #dsarw017#5 = aAlfa5 > "";
     #dsarw017#6 = "";
     #dsarw017#7 = "";
     #dsarw017#8 = "";
     #dsarw017#9 = "";
     #dsarw017#10 = aAlfa10;
     #dsarw017#11 = #dsarm034#0;
     #dsarw017#12 = #dsarm034#1;
     #dsarw017#13 = #dsarm034#2;

     |GRABA 020#dsarw017.a;
     |LIBERA #dsarw017;
|FPRC;

|PROCESO LeeConta;
     #canemp1@#2 = #dsarm034#18;
     #canemp1@#3 = #dsarm034#19;
     |LEE 000#canemp1@.=;
     |SI FSalida ! 0;  |DDEFECTO #canemp1@;  |FINSI;

     aAlfa = #canemp1@#1;  |QBF aAlfa;
     |SI aAlfa = "";
         aAlfa = "Cliente desconocido";
         |SI #dsarm034#18 ! 0;  |Y #dsarm034#19 = 0;
             #canemp1@#2 = #dsarm034#18;
             #canemp1@#3 = #dsarm034#19;
             |LEE 000#canemp1@.];
             |SI FSalida = 0;  |Y #canemp1@#2 = #dsarm034#18;
                 aAlfa = #canemp1@#1;  |QBF aAlfa;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO TraeValorz38;
     ||ARA55

     |QBF aTabla;
     |SI aTabla = "*custom*";
          aAuxAlfa = "";
          |SI nCampo = 1;     ||Estado Documento
               aAlfa  = #dsarm034#15;  |QBF aAlfa;

               |SI aAlfa = "110,110,110;255,255,255";    || Gris
                   aAuxAlfa = "1.- Pendientes de plantillas";
               |FINSI;

               |SI aAlfa = "192,192,192;255,255,255";    || Otro Gris
                   aAuxAlfa = "1.- Pendientes de plantillas";
               |FINSI;

               |SI #dsarm034#7 = 0;  |Y #dsarm034#9 ! "I";
                   aAuxAlfa = "1.- Pendientes de plantillas";
               |FINSI;

               |SI #dsarm034#9 = "N"; |Y #dsarm034#10 = "N";  |Y #dsarm034#7 ! 0;
                   aAuxAlfa = "2.- Pendientes de integridad";
               |FINSI;

               |SI #dsarm034#9 = "S"; |Y #dsarm034#10 = "N";
                   aAuxAlfa = "3.- Pendientes de validar";
               |FINSI;

               |SI #dsarm034#9 = "S"; |Y #dsarm034#10 = "S";  |Y #dsarm034#22 = "N";
                   aAuxAlfa = "4.- Pendientes de Contabilizar";
               |FINSI;

               |SI #dsarm034#22 = "S";
                   aAuxAlfa = "5.- Contabilizados";
               |FINSI;

               |SI #dsarm034#9 = "I";
                   aAuxAlfa = "6.- No validos";
               |FINSI;
          |FINSI;

          |SI nCampo = 2;     ||Emp.Periodo Contable
              |HAZ LeeConta;

               aAuxAlfa  = aAlfa + " (" + (("000000" + #dsarm034#18) % -106) + "." + #dsarm034#19 + ")";
          |FINSI;

          |SI nCampo = 3;     ||Plantilla OCR
               aAuxAlfa  = #dsarm034#8;  |QBF aAuxAlfa;
               aAuxAlfa  = aAuxAlfa + " (" + (("000000000000" + #dsarm034#7) % -112) + ")";
          |FINSI;

          aAlfa = aAuxAlfa;
     |SINO;
          |SI aTabla = "dsarm034";
               |SI nCampoTabla = 14;
                    aAlfa = (("000000000" + #dsarm034#14) % -109);
                    |ACABA;
               |FINSI;
               |SI nCampoTabla = 16;
                    aAlfa = (("000000000" + #dsarm034#16) % -109);
                    |ACABA;
               |FINSI;
               aAlfa = #dsarm034#nCampoTabla#;
          |SINO;
               aNomVariable = "";
               ||Tengo que buscar el dato en dsarm036, para saber que variable contiene los datos.
               |ABRE #dsarm036;
               |SELECT #3#dsarm036;
               #dsarm036#10 = aTabla;
               #dsarm036#11 = nCampoTabla;
               |LEE 000#dsarm036.=;
               |SI FSalida = 0;
                    aNomVariable = #dsarm036#1;
                    |QBF aNomVariable;
               |FINSI;
               |CIERRA #dsarm036;

               |SI aNomVariable ! "";
                    |DDEFECTO #dsarm035;
                    #dsarm035#0 = #dsarm034#0;
                    #dsarm035#1 = #dsarm034#1;
                    #dsarm035#2 = #dsarm034#2;
                    #dsarm035#3 = aNomVariable;
                    |LEE 000#dsarm035.=;
                    |SI FSalida = 0;
                         aAlfa = #dsarm035#4;
                         |QBF aAlfa;
                    |SINO;
                         aAlfa = "Sin Contenido";
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO dsarm034Vistas;
     aProPI = #dsarz041#29; |QBF aProPI;

     aProPI2 = #dsarm034#17; |QBF aProPI2;
     |SI aProPI2 ! aProPI;
          ||ARA38
          |SI aProPI2 ! "";
               |ACABA;
          |FINSI;
     |FINSI;

     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aAlfa4 = "";
     aAlfa5 = "";
     aAlfa10 = "";       ||Para obtener los datos de empresa+periodo. (+ nombre)

     nTipoDoc = #dsarz041#28;

     aAuxAlfa = "";
     #canemp1@#2 = #dsarm034#18;
     #canemp1@#3 = #dsarm034#19;
     |LEE 000#canemp1@.=;
     |SI FSalida ! 0;  |DDEFECTO #canemp1@;  |FINSI;

     aAlfa = #canemp1@#1;  |QBF aAlfa;
     |SI aAlfa = "";  aAlfa = "Cliente desconocido";  |FINSI;
     aAuxAlfa  = aAlfa + " (" + (("000000" + #dsarm034#18) % -106) + "." + #dsarm034#19 + ")";
     aAlfa10 = aAuxAlfa;

     |SI #dsarz041#1 = "1";
         nCampo = #dsarz041#2;
         aTabla = #dsarz041#31;
         nCampoTabla = #dsarz041#32;
         |HAZ TraeValorz38;
         aAlfa1 = aAlfa;
         |HAZ GrabaTempoz38;
     |FINSI;

     |SI #dsarz041#1 = "2";
         nCampo = #dsarz041#2;
         aTabla = #dsarz041#31;
         nCampoTabla = #dsarz041#32;
         |HAZ TraeValorz38;
         aAlfa1 = aAlfa;

         nCampo = #dsarz041#4;
         aTabla = #dsarz041#33;
         nCampoTabla = #dsarz041#34;
         |HAZ TraeValorz38;
         aAlfa2 = aAlfa;

         |HAZ GrabaTempoz38;
     |FINSI;

     |SI #dsarz041#1 = "3";
         nCampo = #dsarz041#2;
         aTabla = #dsarz041#31;
         nCampoTabla = #dsarz041#32;
         |HAZ TraeValorz38;
         aAlfa1 = aAlfa;

         nCampo = #dsarz041#4;
         aTabla = #dsarz041#33;
         nCampoTabla = #dsarz041#34;
         |HAZ TraeValorz38;
         aAlfa2 = aAlfa;

         nCampo = #dsarz041#6;
         aTabla = #dsarz041#35;
         nCampoTabla = #dsarz041#36;
         |HAZ TraeValorz38;
         aAlfa3 = aAlfa;

         |HAZ GrabaTempoz38;
     |FINSI;

     |SI #dsarz041#1 = "4";
         nCampo = #dsarz041#2;
         aTabla = #dsarz041#31;
         nCampoTabla = #dsarz041#32;
         |HAZ TraeValorz38;
         aAlfa1 = aAlfa;

         nCampo = #dsarz041#4;
         aTabla = #dsarz041#33;
         nCampoTabla = #dsarz041#34;
         |HAZ TraeValorz38;
         aAlfa2 = aAlfa;

         nCampo = #dsarz041#6;
         aTabla = #dsarz041#35;
         nCampoTabla = #dsarz041#36;
         |HAZ TraeValorz38;
         aAlfa3 = aAlfa;

         nCampo = #dsarz041#8;
         aTabla = #dsarz041#37;
         nCampoTabla = #dsarz041#38;
         |HAZ TraeValorz38;
         aAlfa4 = aAlfa;

         |HAZ GrabaTempoz38;
     |FINSI;

     |SI #dsarz041#1 = "5";
         nCampo = #dsarz041#2;
         aTabla = #dsarz041#31;
         nCampoTabla = #dsarz041#32;
         |HAZ TraeValorz38;
         aAlfa1 = aAlfa;

         nCampo = #dsarz041#4;
         aTabla = #dsarz041#33;
         nCampoTabla = #dsarz041#34;
         |HAZ TraeValorz38;
         aAlfa2 = aAlfa;

         nCampo = #dsarz041#6;
         aTabla = #dsarz041#35;
         nCampoTabla = #dsarz041#36;
         |HAZ TraeValorz38;
         aAlfa3 = aAlfa;

         nCampo = #dsarz041#8;
         aTabla = #dsarz041#37;
         nCampoTabla = #dsarz041#38;
         |HAZ TraeValorz38;
         aAlfa4 = aAlfa;

         nCampo = #dsarz041#10;
         aTabla = #dsarz041#39;
         nCampoTabla = #dsarz041#40;
         |HAZ TraeValorz38;
         aAlfa5 = aAlfa;

         |HAZ GrabaTempoz38;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm034Vistas;
     #dsarm034#5;
     ;
     "FR000000", aDFecha, "     ", "                    ", aDTipo;
     "FR000000", aHFecha, "zzzzz", "zzzzzzzzzzzzzzzzzzzz", aHTipo;
     ;
     NULL, dsarm034Vistas;
|FIN;

|DEFBUCLE dsarm034VistasUsu;
     #dsarm034#6;
     ;
     aQueUsu, aDFecha, "     ", "                    ", aDTipo;
     aQueUsu, aHFecha, "zzzzz", "zzzzzzzzzzzzzzzzzzzz", aHTipo;
     ;
     NULL, dsarm034Vistas;
|FIN;

|PROCESO CargaArbol;
     |QBF aAlfa;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;
|FPRC;

|PROCESO dsarm035_nomvar;
     |DDEFECTO #dsarm036;
     |SELECT #1#dsarm036;
     #dsarm036#0 = aProPI;
     #dsarm036#1 = #dsarm035#3;
     |LEE 000#dsarm036.=;
     |SI FSalida = 0;
          aAuxTabla = #dsarm036#10;
          |QBF aAuxTabla;
          |SI aAuxTabla = aTabla;
               nCampoDos = #dsarm036#11 + 31;
               |SI nCampoDos ! 75;
                   #gridref@#nCampoDos# = #dsarm035#4;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm035_nomvar;
 #dsarm035#1;
 ;
 #dsarm034#0, #dsarm034#1, #dsarm034#2, aVacio20;
 #dsarm034#0, #dsarm034#1, #dsarm034#2, aZeta20;
 ;
 NULL, dsarm035_nomvar;
|FIN;

|PROCESO MeteEnGrid;
     |DDEFECTO #gridref@;
     #gridref@#0 = nCarpeta1;
     #gridref@#1 = nCarpeta2;
     #gridref@#2 = nCarpeta3;
     #gridref@#3 = nCarpeta4;
     #gridref@#4 = nCarpeta5;
     #gridref@#8 = #dsarw017#11;
     #gridref@#9 = #dsarw017#12;
     #gridref@#10 = #dsarw017#13;
     |LEE 101#gridref@.=;
     |SI FSalida ! 0; |GRABA 020#gridref@.b; |FINSI;

     |ABRE #dsarm034;
     |DDEFECTO #dsarm034;
     #dsarm034#0 = #dsarw017#11;
     #dsarm034#1 = #dsarw017#12;
     #dsarm034#2 = #dsarw017#13;
     |LEE 000#dsarm034.=;
     |CIERRA #dsarm034;

     |PARA nCampo = 3; |SI nCampo [ 22; |HACIENDO nCampo = nCampo + 1;
          nCampoDos = nCampo + 8;

          #gridref@#nCampoDos# = #dsarm034#nCampo#;
     |SIGUE;

     ||3 campos custom. OKIE
     aAuxAlfa = "";
     aAlfa  = #dsarm034#15;  |QBF aAlfa;
     |SI aAlfa = "110,110,110;255,255,255";    || Gris
          aAuxAlfa = "1.- Pendientes de plantillas";
     |FINSI;

     |SI aAlfa = "192,192,192;255,255,255";    || Otro Gris
         aAuxAlfa = "1.- Pendientes de plantillas";
     |FINSI;

     |SI #dsarm034#7 = 0;  |Y #dsarm034#9 ! "I";
         aAuxAlfa = "1.- Pendientes de plantillas";
     |FINSI;

     |SI #dsarm034#9 = "N"; |Y #dsarm034#10 = "N";  |Y #dsarm034#7 ! 0;
         aAuxAlfa = "2.- Pendientes de integridad";
     |FINSI;

     |SI #dsarm034#9 = "S"; |Y #dsarm034#10 = "N";
         aAuxAlfa = "3.- Pendientes de validar";
     |FINSI;

     |SI #dsarm034#9 = "S"; |Y #dsarm034#10 = "S";  |Y #dsarm034#22 = "N";
         aAuxAlfa = "4.- Pendientes de Contabilizar";
     |FINSI;

     |SI #dsarm034#22 = "S";
         aAuxAlfa = "5.- Contabilizados";
     |FINSI;

     |SI #dsarm034#9 = "I";
         aAuxAlfa = "6.- No validos";
     |FINSI;
     #gridref@#5 = aAuxAlfa;

     #gridref@#6 = #dsarw017#10;

     aAuxAlfa  = #dsarm034#8;  |QBF aAuxAlfa;
     aAuxAlfa  = aAuxAlfa + " (" + (("000000000000" + #dsarm034#7) % -112) + ")";
     #gridref@#7 = aAuxAlfa;

     |SI aNomDef ! "dsesca00";
          ||ARA55. Resto de campos

          |SI aNomDef = "dsesca01";
               aTabla = "dpntm101";
               aProPI = #dsarz041#29; |QBF aProPI;

               |ABRE #dsarm036;
               |BUCLE dsarm035_nomvar;
               |CIERRA #dsarm036;
          |FINSI;
     |FINSI;

     |GRABA 020#gridref@.a;
     |LIBERA #gridref@;
|FPRC;

|PROCESO dsarw017;
    nSwBuscaReal = 0;
    aAuxBusca = #dsarw017#11 + #dsarw017#12 + #dsarw017#13;
    |QBF aAuxBusca;
    |SI aAuxBusca = aBusca;
          nSwBuscaReal = 1;
    |FINSI;

    |SI #dsarz041#1 = "1";
        |SI aCarpeta1 ! #dsarw017#1;
            nCarpeta1 = nCarpeta1 + 1;
            nCarpeta2 = 0;

            aAlfa     = #dsarw017#1;  |QBF aAlfa;
            |SI aAlfa = "";
                aAlfa = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + ":" + aAlfa;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI nSwBuscaReal = 1;
            aBuscaReal = nCarpeta1;
        |FINSI;

        nCarpeta2 = nCarpeta2 + 1;
        |SI nCarpeta2 = 1;
             aAlfa = nCarpeta1 + "," + nCarpeta2;
             aAlfa = aAlfa + ":Consulte los documentos en lineal inferior";
             aAlfa = aAlfa + "{{" + nCarpeta1 +"}}";
             |HAZ CargaArbol;
        |FINSI;

        aCarpeta1 = #dsarw017#1;

        |SI nSwCargaDefGrid = 1;
             |HAZ MeteEnGrid;
        |FINSI;
    |FINSI;

    |SI #dsarz041#1 = "2";
        |SI aCarpeta1 ! #dsarw017#1;
            aCarpeta2 = "";

            nCarpeta1 = nCarpeta1 + 1;
            nCarpeta2 = 0;
            nCarpeta3 = 0;

            aAlfa     = #dsarw017#1;  |QBF aAlfa;
            |SI aAlfa = "";
                aAlfa = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + ":" + aAlfa;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI aCarpeta2 ! #dsarw017#2;
            nCarpeta2 = nCarpeta2 + 1;
            nCarpeta3 = 0;

            aAlfa     = #dsarw017#2;  |QBF aAlfa;
            |SI aAlfa = "";
                aAlfa = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + "," + nCarpeta2 + ":" + aAlfa;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI nSwBuscaReal = 1;
            aBuscaReal = nCarpeta1 + "," + nCarpeta2;
        |FINSI;

        nCarpeta3 = nCarpeta3 + 1;
        |SI nCarpeta3 = 1;
             aAlfa = nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3;
             aAlfa = aAlfa + ":Consulte los documentos en lineal inferior";
             aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "}}";
             |HAZ CargaArbol;
        |FINSI;

        aCarpeta1 = #dsarw017#1;
        aCarpeta2 = #dsarw017#2;

        |SI nSwCargaDefGrid = 1;
             |HAZ MeteEnGrid;
        |FINSI;
    |FINSI;

    |SI #dsarz041#1 = "3";
        |SI aCarpeta1 ! #dsarw017#1;
            aCarpeta2 = "";
            aCarpeta3 = "";

            nCarpeta1 = nCarpeta1 + 1;
            nCarpeta2 = 0;
            nCarpeta3 = 0;
            nCarpeta4 = 0;

            aAlfa     = #dsarw017#1;  |QBF aAlfa;
            |SI aAlfa = "";
                aAlfa = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + ":" + aAlfa;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI aCarpeta2 ! #dsarw017#2;
            aCarpeta3 = "";

            nCarpeta2 = nCarpeta2 + 1;
            nCarpeta3 = 0;
            nCarpeta4 = 0;

            aAlfa     = #dsarw017#2;  |QBF aAlfa;
            |SI aAlfa = "";
                aAlfa = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + "," + nCarpeta2 + ":" + aAlfa;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI aCarpeta3 ! #dsarw017#3;
            nCarpeta3 = nCarpeta3 + 1;
            nCarpeta4 = 0;

            aAlfa     = #dsarw017#3;  |QBF aAlfa;
            |SI aAlfa = "";
                aAlfa = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + ":" + aAlfa;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI nSwBuscaReal = 1;
            aBuscaReal = nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3;
        |FINSI;

        nCarpeta4 = nCarpeta4 + 1;
        |SI nCarpeta4 = 1;
             aAlfa = nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "," + nCarpeta4;
             aAlfa = aAlfa + ":Consulte los documentos en lineal inferior";
             aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "}}";
             |HAZ CargaArbol;
        |FINSI;

        aCarpeta1 = #dsarw017#1;
        aCarpeta2 = #dsarw017#2;
        aCarpeta3 = #dsarw017#3;

        |SI nSwCargaDefGrid = 1;
             |HAZ MeteEnGrid;
        |FINSI;
    |FINSI;

    |SI #dsarz041#1 = "4";
        |SI aCarpeta1 ! #dsarw017#1;
            aCarpeta2 = "";
            aCarpeta3 = "";
            aCarpeta4 = "";

            nCarpeta1 = nCarpeta1 + 1;
            nCarpeta2 = 0;
            nCarpeta3 = 0;
            nCarpeta4 = 0;
            nCarpeta5 = 0;

            aAlfa     = #dsarw017#1;  |QBF aAlfa;
            |SI aAlfa = "";
                aAlfa = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + ":" + aAlfa;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI aCarpeta2 ! #dsarw017#2;
            aCarpeta3 = "";
            aCarpeta4 = "";

            nCarpeta2 = nCarpeta2 + 1;
            nCarpeta3 = 0;
            nCarpeta4 = 0;
            nCarpeta5 = 0;

            aAlfa     = #dsarw017#2;  |QBF aAlfa;
            |SI aAlfa = "";
                aAlfa = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + "," + nCarpeta2 + ":" + aAlfa;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI aCarpeta3 ! #dsarw017#3;
            aCarpeta4 = "";

            nCarpeta3 = nCarpeta3 + 1;
            nCarpeta4 = 0;
            nCarpeta5 = 0;

            aAlfa     = #dsarw017#3;  |QBF aAlfa;
            |SI aAlfa = "";
                aAlfa = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + ":" + aAlfa;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI aCarpeta4 ! #dsarw017#4;
            nCarpeta4 = nCarpeta4 + 1;
            nCarpeta5 = 0;

            aAlfa1     = #dsarw017#4;  |QBF aAlfa;
            |SI aAlfa1 = "";
                aAlfa1 = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "," + nCarpeta4;
            aAlfa     = aAlfa + ":" + aAlfa1;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "," + nCarpeta4 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI nSwBuscaReal = 1;
            aBuscaReal = nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "," + nCarpeta4;
        |FINSI;

        nCarpeta5 = nCarpeta5 + 1;
        |SI nCarpeta5 = 1;
             aAlfa = nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "," + nCarpeta4 + "," + nCarpeta5;
             aAlfa = aAlfa + ":Consulte los documentos en lineal inferior";
             aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "," + nCarpeta4 + "}}";
             |HAZ CargaArbol;
        |FINSI;

        aCarpeta1 = #dsarw017#1;
        aCarpeta2 = #dsarw017#2;
        aCarpeta3 = #dsarw017#3;
        aCarpeta4 = #dsarw017#4;

        |SI nSwCargaDefGrid = 1;
             |HAZ MeteEnGrid;
        |FINSI;
    |FINSI;

    |SI #dsarz041#1 = "5";
        |SI aCarpeta1 ! #dsarw017#1;
            aCarpeta2 = "";
            aCarpeta3 = "";
            aCarpeta4 = "";
            aCarpeta5 = "";

            nCarpeta1 = nCarpeta1 + 1;
            nCarpeta2 = 0;
            nCarpeta3 = 0;
            nCarpeta4 = 0;
            nCarpeta5 = 0;
            nCarpeta6 = 0;

            aAlfa     = #dsarw017#1;  |QBF aAlfa;
            |SI aAlfa = "";
                aAlfa = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + ":" + aAlfa;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI aCarpeta2 ! #dsarw017#2;
            aCarpeta3 = "";
            aCarpeta4 = "";
            aCarpeta5 = "";

            nCarpeta2 = nCarpeta2 + 1;
            nCarpeta3 = 0;
            nCarpeta4 = 0;
            nCarpeta5 = 0;
            nCarpeta6 = 0;

            aAlfa     = #dsarw017#2;  |QBF aAlfa;
            |SI aAlfa = "";
                aAlfa = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + "," + nCarpeta2 + ":" + aAlfa;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI aCarpeta3 ! #dsarw017#3;
            aCarpeta4 = "";
            aCarpeta5 = "";

            nCarpeta3 = nCarpeta3 + 1;
            nCarpeta4 = 0;
            nCarpeta5 = 0;
            nCarpeta6 = 0;

            aAlfa     = #dsarw017#3;  |QBF aAlfa;
            |SI aAlfa = "";
                aAlfa = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + ":" + aAlfa;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI aCarpeta4 ! #dsarw017#4;
            aCarpeta5 = "";

            nCarpeta4 = nCarpeta4 + 1;
            nCarpeta5 = 0;
            nCarpeta6 = 0;

            aAlfa1     = #dsarw017#4;  |QBF aAlfa;
            |SI aAlfa1 = "";
                aAlfa1 = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "," + nCarpeta4;
            aAlfa     = aAlfa + ":" + aAlfa1;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "," + nCarpeta4 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI aCarpeta5 ! #dsarw017#5;
            nCarpeta5 = nCarpeta5 + 1;
            nCarpeta6 = 0;

            aAlfa1     = #dsarw017#5;  |QBF aAlfa;
            |SI aAlfa1 = "";
                aAlfa1 = "Sin Contenido";
            |FINSI;

            aAlfa     = nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "," + nCarpeta4 + "," + nCarpeta5;
            aAlfa     = aAlfa + ":" + aAlfa1;  |QBF aAlfa;
            aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "," + nCarpeta4 + "," + nCarpeta5 + "}}";
            |HAZ CargaArbol;
        |FINSI;

        |SI nSwBuscaReal = 1;
            aBuscaReal = nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "," + nCarpeta4 + nCarpeta5;
        |FINSI;

        nCarpeta6 = nCarpeta6 + 1;
        |SI nCarpeta6 = 1;
             aAlfa = nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "," + nCarpeta4 + "," + nCarpeta5 + "," + nCarpeta6;
             aAlfa = aAlfa + ":Consulte los documentos en lineal inferior";
             aAlfa = aAlfa + "{{" + nCarpeta1 + "," + nCarpeta2 + "," + nCarpeta3 + "," + nCarpeta4 + "," + nCarpeta5 +"}}";
             |HAZ CargaArbol;
        |FINSI;

        aCarpeta1 = #dsarw017#1;
        aCarpeta2 = #dsarw017#2;
        aCarpeta3 = #dsarw017#3;
        aCarpeta4 = #dsarw017#4;
        aCarpeta5 = #dsarw017#5;

        |SI nSwCargaDefGrid = 1;
             |HAZ MeteEnGrid;
        |FINSI;
    |FINSI;
|FPRC;

|PROCESO CreaArbol;
     |ESTADO_CONTROL nBoton1,  "HIDE";
     |ESTADO_CONTROL nBoton3,  "HIDE";
     |ESTADO_CONTROL nBoton6,  "HIDE";
     |ESTADO_CONTROL nBoton11, "HIDE";
     |ESTADO_CONTROL nBoton13, "HIDE";
     |ESTADO_CONTROL nBoton14, "HIDE";
     |ESTADO_CONTROL nBoton4, "HIDE";
     |ESTADO_CONTROL nBoton12, "HIDE";
     |ESTADO_CONTROL nGrid0,   "HIDE";

     |HAZ QuitaBotonSalir;

     aFichero = ("17" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #dsarw017#aFichero#;

     |ABRE #dsarw017;  |CIERRA #dsarw017;  |DELINDEX #dsarw017;

     |ABRE #dsarw017;
     |SELECT #1#dsarw017;

     |DBASE aBase;  |QBF aBase;
     aAlfa = aBase + "tmp";          |MKDIR aAlfa;

     eaRutaOrigen  = aBase + "tmp/";
     |SI #dsarm001#7 = "N";
          |HAZ DimeUnidad;
          eaRutaDestino = eaUnidad + ":\documentos\dsarchi\";
     |SINO;
          |HAZ LeeUnidadBasico;
          eaRutaDestino = eaUnidadBasico + "\documentos\dsarchi\";
     |FINSI;
     eaFicheroTxt  = "dsarz03801" + Usuario + ".txt";
     eaFicheroTgz  = "dsarz03801" + Usuario + ".tgz";
     eaFicheroTar  = "dsarz03801" + Usuario + ".tar";

     eaFicheroTxt  = "dsarz03801" + Usuario + ".txt";
     aAlfa         = eaRutaDestino + eaFicheroTxt;
     |RFBORRA aAlfa;

     |SI nTree ! -1;
         |FIN_CONTROL_WINDOWS nTree;
         nTree = -1;
     |FINSI;

     |CONTROL_SIMPLE 0, "LABEL,{{5}}Realizando trabajo ...", 1315, 1680, NULL;
     nBotonLabel = FSalida;

     |PTEC 802;  |PAUSA;

     |DBASS aBaseConta;   |QBF aBaseConta;
     aBaseConta = aBaseConta + "contagen/";
     aDef       = aBaseConta + "def/canempre";
     aDirDatos  = aBaseConta + "fich/";

     |CARGA_DEF aDef, canemp1@;

     |PATH_DAT #canemp1@#aDirDatos#;

     |ABRE #canemp1@;

     |SI aQueUsu = "";
         |BUCLE dsarm034Vistas;
     |SINO;
         |BUCLE dsarm034VistasUsu;
     |FINSI;

     |CIERRA #canemp1@;
     |DESCARGA_DEF #canemp1@;

     aAbre = eaRutaOrigen + eaFicheroTxt;

     sT_nID   = nTree;
     sT_nOper = 0;

     |XABRE "WB", aAbre, nHandle;

     nCarpeta1 = 0;
     nCarpeta2 = 0;
     nCarpeta3 = 0;
     nCarpeta4 = 0;
     nCarpeta5 = 0;
     nCarpeta6 = 0;
     aCarpeta1 = "";
     aCarpeta2 = "";
     aCarpeta3 = "";
     aCarpeta4 = "";
     aCarpeta5 = "";

     ||ARA55.
     |SI nSwCargaDefGrid = 1;
          |CIERRA #gridref@;
          |DELINDEX #gridref@;
          |DESCARGA_DEF #gridref@;
     |FINSI;

     aNomDef = "dsesca00";
     |SI #dsarz041#28 ] 1;
         aNomDef = "dsesca01";
     |FINSI;

     |DBASE aBase;   |QBF aBase;
     aFicGrid = aBase + "def/" + aNomDef + ".mas";

     |XABRE "E", aFicGrid, 0;
     |SI FSalida ! 0;
          aMensaje = "0000No existe el fichero " + aNomDef + &13 + "Consulte con Diagram Software";
          |MENAV aMensaje;
          aNomDef = "dsesca00";
          aFicGrid = aBase + "def/" + aNomDef + ".mas";
     |FINSI;

     |CARGA_DEF aFicGrid, gridref@;
     |SI FSalida ! 0;
          aMensaje = "0000No existe el fichero " + aNomDef + &13 + "Consulte con Diagram Software";
          |MENAV aMensaje;

          nSwCargaDefGrid = 0;
     |SINO;
          nSwCargaDefGrid = 1;
     |FINSI;

     |SI nSwCargaDefGrid = 1;
          aAlfa = ("G5" + Usuario + "zzzzzzzz") % 108;
          |NOME_DAT #gridref@#aAlfa#;

          |ABRE #gridref@;
          |CIERRA #gridref@;
          |DELINDEX #gridref@;

          |ABRE #gridref@;
     |FINSI;

     |SELECT #2#dsarw017;
     |LEE 000#dsarw017.p;
     |PARA;  |SI FSalida = 0;  |HACIENDO;
         |HAZ dsarw017;

         |LEE 000#dsarw017.s;
     |SIGUE;

     |XCIERRA nHandle;

     |HAZ TraeTxtComprimido;

     |CIERRA #dsarw017;
     |DELINDEX #dsarw017;

     eaFicheroTxt  = "dsarz03801" + Usuario + ".txt";
     aAlfa         = eaRutaDestino + eaFicheroTxt;

     eaAlfa = "TREECTRL,Vistas: " + (aTipoArbol < "");  |QBF eaAlfa;
     eaAlfa = eaAlfa + " {{" + aAlfa + "}}";

     ||CONTROL_SIMPLE nPanta0, eaAlfa, 0602, 2998, EventoTree;
     |CONTROL_SIMPLE nPanta0, eaAlfa, 0602, 2098, EventoTree;
     nTree = FSalida;

     |ESTADO_CONTROL nTree, "HIDE";

     |SI nSwCargaDefGrid = 1;
          nDNivel1 = 0;
          nHNivel1 = 9999;
          nDNivel2 = 0;
          nHNivel2 = 9999;
          nDNivel3 = 0;
          nHNivel3 = 9999;
          nDNivel4 = 0;
          nHNivel4 = 9999;
          nDNivel5 = 0;
          nHNivel5 = 9999;

          nRango = 2 + 4 + 8 + 16 + 32 + 128;

          |SI nGridDos ! -1;
              |DESTRUYECONTROL nGridDos;
              nGridDos = -1;
          |FINSI;

          |LINEAL_SIMPLE #1#gridref@, nRango, 2202, 2998, BajaClave555, AltaClave555, EventoGridDos;
          nGridDos = FSalida;
     |FINSI;

     |FIN_CONTROL_WINDOWS nBotonLabel;

     |ESTADO_CONTROL nBoton1,  "SHOW";
     |ESTADO_CONTROL nBoton3,  "SHOW";
     |ESTADO_CONTROL nBoton6,  "SHOW";
     |ESTADO_CONTROL nBoton11, "SHOW";
     |ESTADO_CONTROL nBoton13, "SHOW";
     |ESTADO_CONTROL nBoton14, "SHOW";
     |ESTADO_CONTROL nBoton4, "SHOW";
     |ESTADO_CONTROL nBoton12, "SHOW";
     |ESTADO_CONTROL nGrid0,   "SHOW";

     |HAZ PonBotonSalir;

     ||TODO CCC.  Descomentar
     aAlfa = eaRutaDestino + eaFicheroTxt;
     |RFBORRA aAlfa;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;

|PROCESO PresentaArbol;
     |ESTADO_CONTROL nGrid0, "HIDE";
     |ESTADO_CONTROL nTree, "SHOW";
     |ESTADO_CONTROL nGridDos, "SHOW";

     |PULSATECLA;

     |SI aBuscaReal ! "";
         sT_nID   = nTree;
         sT_nOper = 3;
         sT_aData = "[" + aBuscaReal;
         |ESPECIFICA "COMMANDCONTROL", sTree;
         aRefresca = ":" + FSalida;
     |FINSI;

     sT_nID   = nTree;
     sT_nOper = 2;
     |SI aRefresca = "";
         sT_aData = "1:";
     |SINO;
         sT_aData = aRefresca;
     |FINSI;

     |ESPECIFICA "COMMANDCONTROL", sTree;
     |PULSATECLA;

     |FOCOTECLADO nTree;
|FPRC;

|PROCESO dsarz041;
     nContador = nContador + 1;

     eaAlfa     = #dsarz041#0;  |QBF eaAlfa;
     aOpcion    = eaAlfa;

     |HAZ QuitaRaros;
     aPopup    = eaAlfa;

     IaPopup   = IaPopup  + 1;
     IaOpcion  = IaOpcion + 1;
|FPRC;

|DEFBUCLE dsarz041;
     #dsarz041#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, dsarz041;
|FIN;

|PROCESO CambiaArbol;
     nContador = 0;
     aPopup1   = nGrid0;

     IaPopup  = aPopup3  <-;
     IaOpcion = aOpcion1 <-;
     |BUCLE dsarz041;
     aPopup2 = nContador;

     |SI nContador = 0; |ACABA;  |FINSI;

     IaPopup  = aPopup1  <-;
     IaOpcion = aOpcion1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;
     nError = FSalida;

     |SI nError > 0;
         IaPopup  = aPopup3  <-;
         IaOpcion = aOpcion1 <-;

         nOpcion  = nError - 1;
         IaPopup  = IaPopup  + nOpcion;
         IaOpcion = IaOpcion + nOpcion;
         aAlfa    = aOpcion;
         |PULSATECLA;

         #dsarz041#0 = aAlfa;
         |LEE 000#dsarz041.=;
         |SI FSalida ! 0;  |ACABA;  |FINSI;

         aTipoArbol = aAlfa;
         |HAZ CreaArbol;
         enBusqueda = 0;
     |FINSI;

     |SI nBotonCambia = -1;  |Y enBusqueda = 0;
         |ACABA;
     |FINSI;

     |SI enBusqueda = 1;
         |HAZ CreaArbol;
     |FINSI;

     enBusqueda = 0;
     |HAZ PresentaArbol;
|FPRC;

|PROCESO ActualizaArbol;
     aBusca = #dsarm034#0 + #dsarm034#1 + #dsarm034#2;  |QBF aBusca;

     |HAZ CreaArbol;
     |HAZ PresentaArbol;
|FPRC;

|PROCESO Arbol;
     aBusca = #dsarm034#0 + #dsarm034#1 + #dsarm034#2;  |QBF aBusca;

     |SI aTipoArbol = "";
         |HAZ CambiaArbol;

         |SI nError [ 0;  |ACABA;  |FINSI;
     |SINO;
          |DDEFECTO #dsarz041;
          #dsarz041#0 = aTipoArbol;
          |LEE 000#dsarz041.=;
          |HAZ ActualizaArbol;
     |FINSI;

     |SI nBotonArbol ! -1;
         |FIN_CONTROL_WINDOWS nBotonArbol;
         nBotonArbol = -1;

         |CONTROL_SIMPLE 0, "BOTON,{{155}}Vistas por lineal", 3202, 3220, Lineal;
         nBotonLineal = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{137}} Cambiar Vistas", 3242, 3260, CambiaArbol;
         nBotonCambia = FSalida;

         |CONTROL_SIMPLE 0, "BOTON,{{197}} Actualizar Arbol", 3222, 3240, ActualizaArbol;
         nBotonActualiza = FSalida;
     |FINSI;
|FPRC;

|PROCESO Lineal;
     |SI nTree ! -1;
         |ESTADO_CONTROL nTree, "HIDE";
         |ESTADO_CONTROL nGridDos, "HIDE";
     |FINSI;

     |PULSATECLA;

     |ESTADO_CONTROL nGrid0, "SHOW";
     nEstadoGrid = nGrid0;

     |REFRESCACONTROL nGrid0;
     |FOCOTECLADO nGrid0;
     |PULSATECLA;

     |FIN_CONTROL_WINDOWS nBotonLineal;
     nBotonLineal = -1;

     |FIN_CONTROL_WINDOWS nBotonCambia;
     nBotonCambia = -1;

     |FIN_CONTROL_WINDOWS nBotonActualiza;
     nBotonActualiza = -1;

     |CONTROL_SIMPLE 0, "BOTON,{{155}}Vistas por arbol", 3202, 3220, Arbol;
     nBotonArbol = FSalida;
|FPRC;

|PROCESO Tipo7C4_m035; |TIPO 7;
     aValorAntes = #dsarm035#4;
     |QBF aValorAntes;
|FPRC;

|PROCESO Tipo0C4_m035; |TIPO 0;
     aAlfa1 = #dsarm035#3;  |QBF aAlfa1;

                                            nChequeaPro = 0;
     |SI aAlfa1 = "FR000000_procalle";      nChequeaPro = 1;  |FINSI;
     |SI aAlfa1 = "FR000000_procodpos";     nChequeaPro = 1;  |FINSI;
     |SI aAlfa1 = "FR000000_prolocalidad";  nChequeaPro = 1;  |FINSI;
     |SI aAlfa1 = "FR000000_protelefono";   nChequeaPro = 1;  |FINSI;
     |SI aAlfa1 = "FR000000_profax";        nChequeaPro = 1;  |FINSI;
     |SI aAlfa1 = "FR000000_proapcorreo";   nChequeaPro = 1;  |FINSI;

     |SI aAlfa1 = "FR000000_pais";
          aAuxPais = #dsarm035#4 > #dsarm035#4;
          #dsarm035#4 = aAuxPais;
          |PINTA #dsarm035#4;
     |FINSI;

     |SI nChequeaPro = 1;
         |SI enNIF = 0;
             #dsarm035#4 = aValorAntes;
             |PINTA #dsarm035#4;
             |ACABA;
         |FINSI;
     |FINSI;

     aValorDespues = #dsarm035#4;
     |QBF aValorDespues;
     |SI aValorDespues ! aValorAntes;

          aNomVarAra = #dsarm035#3;

          aValorAnt = #dsarm035#9;
          |QBF aValorAnt;
          |SI aValorAnt = "*SIN CAMBIOS*";
               #dsarm035#9 = aValorAntes;
          |FINSI;

          #dsarm035#5 = 3;
          #dsarm035#8 = "0,158,0;255,255,255";
          |GRABA 020#dsarm035.a;
          |LIBERA #dsarm035;

          |ABRE #dsarm036;
          |DDEFECTO #dsarm036;
          #dsarm036#0 = aProcesoPI;
          #dsarm036#1 = #dsarm035#3;
          |LEE 000#dsarm036.=;
          |SI FSalida = 0;
               aAlfaAux = #dsarm036#8;
               |QBF aAlfaAux;
               |SI aAlfaAux = "pronom"; |O aAlfaAux = "pronif";
                    eaProcesoPIInte = aProcesoPI;
                    efFechaInte = #dsarm035#0;
                    eaHoraInte = #dsarm035#1;
                    eaFicInte = #dsarm035#2;
                    |HAZ ActNifyNombre;
               |FINSI;
          |FINSI;
          |CIERRA #dsarm036;

          enCodPrimeraInc = 0;
          eaPrimeraInc = "";
          enSwAvisaInte = 0;
          eaProcesoPIInte = aProcesoPI;
          enResultadoInte = 0;
          efFechaInte = #dsarm035#0;
          eaHoraInte = #dsarm035#1;
          eaFicInte = #dsarm035#2;
          enCodIncidencia = 0;
          eaIncidencia = "";

          |HAZ IntegridaddsEscan;

          |PULSATECLA;
          |PULSATECLA;
          |PULSATECLA;

          #dsarm035#0 = efFechaInte;
          #dsarm035#1 = eaHoraInte;
          #dsarm035#2 = eaFicInte;
          #dsarm035#3 = aNomVarAra;
          |LEE 000#dsarm035.=;

          |REFRESCACONTROL nGrid68;
     |FINSI;
|FPRC;



|| ------------------------------------------------------
|| Procesos del Inicio del Programa
|| ------------------------------------------------------

|PROCESO dsarm035B;
     |BORRA 020#dsarm035.a;
     |LIBERA #dsarm035;
|FPRC;

||ARA38
|DEFBUCLE dsarm035B;
     #dsarm035#1;
     ;
     #dsarm034#0, #dsarm034#1, #dsarm034#2, "                         ";
     #dsarm034#0, #dsarm034#1, #dsarm034#2, "zzzzzzzzzzzzzzzzzzzzzzzzz";
     be;
     NULL, dsarm035B;
|FIN;


|PROCESO canemp1;
     aCifAra   = #canemp1@#8;  |QBT aCifAra;

     |SI aCifAra = aCifContagen;
          |SI #canemp1@#21 = "A";       ||Empresa activa.
              |PARA nCampo = 0;  |SI nCampo [ 35;  |HACIENDO nCampo = nCampo + 1;
                    #canemp2@#nCampo# = #canemp1@#nCampo#;
              |SIGUE;
              |GRABA 020#canemp2@.n;
              |LIBERA #canemp2@;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE canemp1;
     #canemp1@#1002;
     ;
     00001, 0;
     99999, 9;
     ;
     NULL, canemp1;
|FIN;

|PROCESO Crea992;
     |SI nGrid992 ! -1;
         |DESTRUYECONTROL nGrid992;
     |FINSI;

     |CIERRA #canemp2@;  |DELINDEX #canemp2@;

     |ABRE #canemp2@;

     #dsarm035#0 = #dsarm034#0;
     #dsarm035#1 = #dsarm034#1;
     #dsarm035#2 = #dsarm034#2;
     #dsarm035#3 = "FR000000_clinif";
     |LEE 000#dsarm035.=;
     |SI FSalida ! 0;  |DDEFECTO #dsarm035;  |FINSI;

     aCifContagen = #dsarm035#4;  |QBF aCifContagen;
     |BUCLE canemp1;

     nRango    = 4 + 8 + 16 + 32 + 128;
     |LINEAL_SIMPLE #1#canemp2@, nRango, 0602, 2698, NULL, NULL, EventoGrid992;
     nGrid992 = FSalida;
|FPRC;

|PROCESO Recoger;
     nActArbol = 1;
     |PTEC 806;
|FPRC;

|PROCESO OtraEmpresa;
     |ABRE #canemp1@;
     #canemp1@#2 = #canemp2@#2;
     #canemp1@#3 = #canemp2@#3;
     |LEE 000#canemp1@.=;

     |CONSULTA_CLAVE #1#canemp1@;
     |SI FSalida = 0;
         aAlfa = "0000NHa seleccionado la empresa: " + #canemp1@#2 + " / " + #canemp1@#1;  |QBF aAlfa;
         aAlfa = aAlfa + ". Est  seguro";
         |CONFI aAlfa;
         |SI FSalida = 0;
             #dsarm035#0 = #dsarm034#0;
             #dsarm035#1 = #dsarm034#1;
             #dsarm035#2 = #dsarm034#2;
             #dsarm035#3 = "FR000000_clinif";
             |LEE 101#dsarm035.=;
             |SI FSalida = 0;
                 #dsarm035#4 = #canemp1@#8;
                 |GRABA 020#dsarm035.a;
                 |LIBERA #dsarm035;

                 |HAZ Crea992;
             |FINSI;
         |FINSI;
     |FINSI;
     |CIERRA #canemp1@;
|FPRC;

|PROCESO EventoGrid992;
     |SI FSalida = 1;  |O FSalida = 2;
         |LEE 000#canemp2@.=;
     |FINSI;
|FPRC;

|PROCESO Boton13;
     |DBASS aBaseConta;   |QBF aBaseConta;

     aBaseConta = aBaseConta + "contagen/";
     aDef       = aBaseConta + "def/canempre";
     aDirDatos  = aBaseConta + "fich/";

     |CARGA_DEF aDef, canemp1@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |CARGA_DEF aDef, canemp2@;
     |SI FSalida ! 0;
         |DESCARGA_DEF #canemp1@;
         |ACABA;
     |FINSI;

     |PATH_DAT #canemp1@#aDirDatos#;

     aAlfa = ("D1" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #canemp2@#aAlfa#;

     |ABRE #canemp2@;

     |VENTANA 0602, 2998, -1, 16, "Empresas contables";
     nVent992 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent992;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |CONTROL_SIMPLE 0, "BOTON,{{197}}Recoger", 2788, 2798, Recoger;
     |CONTROL_SIMPLE 0, "BOTON,{{197}}Buscar otra empresa", 2765, 2786, OtraEmpresa;

     nActArbol = 0;
     nGrid992  = -1;
     |HAZ Crea992;

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
          FSalida = "::{{001}}Salir," + nGrid992;
          |LEETECLA aTecla;
          |SI aTecla = aEsc1; |SAL;  |FINSI;
          |SI aTecla = aEsc2; |SAL;  |FINSI;
          |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;

     aTecla = "";

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent992;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVent992;

     |SI nActArbol = 1;
         nActArbol = 0;
         |LEE 101#dsarm034.=;
         |SI FSalida = 0;
             aAlfa = "0000NHa seleccionado la empresa: " + #canemp2@#2;
             aAlfa = aAlfa + " periodo: " + #canemp2@#3;
             aAlfa = aAlfa + ". Est  seguro";
             |CONFI aAlfa;
             |SI FSalida = 0;
                 #dsarm034#18 = #canemp2@#2;
                 #dsarm034#19 = #canemp2@#3;
                 |GRABA 020#dsarm034.a;
                 |LIBERA #dsarm034;

                 nActArbol = 1;
                 |REFRESCACONTROL nGrid0;
                 |FOCOTECLADO nGrid0;
             |FINSI;
         |FINSI;
     |FINSI;

     |CIERRA #canemp2@;
     |DELINDEX #canemp2@;

     |DESCARGA_DEF #canemp2@;
     |DESCARGA_DEF #canemp1@;

     |SI nBotonArbol = -1;
         |SI nActArbol = 1;  |HAZ ActualizaArbol;  |FINSI;
     |FINSI;
|FPRC;

|PROCESO registro;
     |BORRA 020#registro@.a;
     |LIBERA #registro@;
|FPRC;

|DEFBUCLE registro;
     #registro@#5001;
     ;
     #dsarm034#16;
     #dsarm034#16;
     be;
     NULL, registro;
|FIN;

|PROCESO Borradpntm101;
     ||Se basa en el calculo del dpntz002
     ||ARA101
     aProcesoPI = #dsarm034#17;
     |QBF aProcesoPI;
     |SI aProcesoPI ! "FR000000";  |ACABA;  |FINSI;

     aEmpB = ("00000" + #dsarm034#18) % -105;

     |DBASS aBaseB;  |QBF aBaseB;
     aPathDatos101 = aBaseB + "despanet";             |MKDIR aPathDatos101;
     aPathDatos101 = aPathDatos101 + "/" + aEmpB;     |MKDIR aPathDatos101;
     aPathDatos101 = aPathDatos101 + "/fich";         |MKDIR aPathDatos101;
     aPathDatos101 = aPathDatos101 + "/";

     |DBASE aBaseB;  |QBF aBaseB;
     aMasB = aBaseB + "def/dpntm101";
     |CARGA_DEF aMasB, registro@;
     |SI FSalida = 0;
         |PATH_DAT #registro@#aPathDatos101#;

         |BUCLE registro;

         |DESCARGA_DEF #registro@;
     |FINSI;
|FPRC;

|PROCESO dsarm030_borra;
     |BORRA 020#dsarm030.a;
|FPRC;

|DEFBUCLE dsarm030_borra;
     #dsarm030#1;
     ;
     #dsarm005#0,     0;
     #dsarm005#0, 99999;
     be;
     NULL, dsarm030_borra;
|FIN;

|PROCESO dsarm031_borra;
     |BORRA 020#dsarm031.a;
|FPRC;

|DEFBUCLE dsarm031_borra;
     #dsarm031#1;
     ;
     #dsarm005#0,   0;
     #dsarm005#0, 999;
     be;
     NULL, dsarm031_borra;
|FIN;

|PROCESO dsarm006_borra;
     |BORRA 020#dsarm006.a;
|FPRC;

|DEFBUCLE dsarm006_borra;
     #dsarm006#1;
     ;
     #dsarm005#0, 001;
     #dsarm005#0, 999;
     be;
     NULL, dsarm006_borra;
|FIN;

|PROCESO dsarm046_borra;
     |BORRA 020#dsarm046.a;
|FPRC;

|DEFBUCLE dsarm046_borra;
     #dsarm046#1;
     ;
     #dsarm005#0;
     #dsarm005#0;
     be;
     NULL, dsarm046_borra;
|FIN;


|PROCESO dsarm007_1B;
     |BORRA 020#dsarm007.a;
     |LIBERA #dsarm007;
|FPRC;

|DEFBUCLE dsarm007_1B;
     #dsarm007#1;
     ;
     #dsarm005#0, 000000001;
     #dsarm005#0, 999999999;
     be;
     NULL, dsarm007_1B;
|FIN;

|PROCESO dsarm007_2B;
     |BORRA 020#dsarm007.a;
     |LIBERA #dsarm007;
|FPRC;

|DEFBUCLE dsarm007_2B;
     #dsarm007#2;
     ;
     #dsarm005#0, 000000001;
     #dsarm005#0, 999999999;
     be;
     NULL, dsarm007_2B;
|FIN;

|PROCESO Boton14;
     |CONFI "0000NSeguro que quiere eliminar el registro seleccionado";
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |LEE 101#dsarm034.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aMensaje = "0000SBorrar tambin el documento del asistente de consulta?";
     |CONFI aMensaje;
     |SI FSalida = 0;
          |ABRE #dsarm005;
          |DDEFECTO #dsarm005;
          #dsarm005#0 = #dsarm034#16;
          |LEE 101#dsarm005.=;
          |SI FSalida = 0;
               aFicheroBorra = #dsarm005#7;
               |QBF aFicheroBorra;
               aFicheroBorra = aFicheroBorra + #dsarm005#9;
               |QBF aFicheroBorra;
               |SI #dsarm001#7 = "N";
                    |FBORRA aFicheroBorra;
                    aFicheroBorra = aFicheroBorra + ".txt";
                    |FBORRA aFicheroBorra;
               |SINO;
                    |RFBORRA aFicheroBorra;
                    aFicheroBorra = aFicheroBorra + ".txt";
                    |RFBORRA aFicheroBorra;
               |FINSI;

               |BUCLE dsarm006_borra;
               |BUCLE dsarm046_borra;
               |BUCLE dsarm007_1B;
               |BUCLE dsarm007_2B;
               |BUCLE dsarm030_borra;
               |BUCLE dsarm031_borra;

               |BORRA 020#dsarm005.a;

               ||ARA18
               ||Falta Borrar lo mismo que desde el dsarm005.
          |FINSI;
          |CIERRA #dsarm005;
     |FINSI;

     |BUCLE dsarm035B;

     |HAZ Borradpntm101;

     |BORRA 020#dsarm034.a;
     |LIBERA #dsarm034;

     |ABRE #dsarm054;
     #dsarm054#0 = #dsarm034#0;
     #dsarm054#1 = #dsarm034#1;
     #dsarm054#2 = #dsarm034#2;
     |LEE 101#dsarm054.=;
     |SI FSalida = 0;
          |BORRA 020#dsarm054.a;
          |LIBERA #dsarm054;
     |FINSI;
     |CIERRA #dsarm054;

     |REFRESCACONTROL nGrid0;
     |FOCOTECLADO nGrid0;

     |SI nBotonArbol = -1;
         |LEE 000#dsarm034.];
         |HAZ ActualizaArbol;
     |FINSI;
|FPRC;

|PROCESO Boton1;
     |LEE 000#dsarm034.=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |HAZ CtrlCache;

     |ABRE #dsarm005;
     |DDEFECTO #dsarm005;
     #dsarm005#0 = #dsarm034#16;
     |LEE 000#dsarm005.=;
     |CIERRA #dsarm005;

     |HAZ DimeUnidad;
     |DBASE aPathBase;
     |QBF aPathBase;

     aAuxNom = #dsarm005#9;
     |QBF aAuxNom;

     eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "dsabreextension.exe";
     eaOrigen = aPathBase + "dlls/dsabreextension.exe";
     |HAZ EnviaFicheroConMD5;

     eaOrigen  = #dsarm005#7;
     |QBF eaOrigen;
     eaOrigen  = eaOrigen + aAuxNom + ".txt";
     eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + aAuxNom + ".txt";

     aIPRemoto   = "";
     |IP_REMOTO aIPRemoto;

     |SI #dsarm001#7 = "N";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO eaOrigen, eaDestino;
         |SINO;
             |COPIA_FICHERO eaOrigen, eaDestino;
         |FINSI;
     |SINO;
         |RCOPIA_FICHERO eaOrigen, eaDestino;
     |FINSI;

     |SI aIPRemoto = "";
         |XABRE "E", eaDestino, nHandle;
     |SINO;
         |XABRE "EC", eaDestino, nHandle;
     |FINSI;

     |SI FSalida < 0;
         eaOrigen  = (aPathBase + "ocr/" + aAuxNom + ".txt") < "";
         eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + aAuxNom + ".txt";

         aIPRemoto   = "";
         |IP_REMOTO aIPRemoto;

         |SI aIPRemoto ! "";
             |ENVIA_FICHERO eaOrigen, eaDestino;
         |SINO;
             |COPIA_FICHERO eaOrigen, eaDestino;
         |FINSI;

         |SI aIPRemoto = "";
             |XABRE "E", eaDestino, nHandle;
         |SINO;
             |XABRE "EC", eaDestino, nHandle;
         |FINSI;

         |SI FSalida < 0;
             aMensaje = "0000No puedo localizar el texto resultado dsEscan. Debe haber sido borrado o movido de carpeta";
             |MENAV aMensaje;
             |ACABA;
         |FINSI;
          aBorraCache = eaDestino;
          |QBF aBorraCache;
     |SINO;
          aBorraCache = eaDestino;
          |QBF aBorraCache;
     |FINSI;

     |VENTANA 0501, 2999, -1, 16, "Visualizando Documento";
     nVentw6  = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentw6;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PINPA #0#dsarw008;
     |PINDA #0#dsarw008;
     |PTEC 802;
     |PAUSA;

     |XABRE "EC", eaDestino, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     ||Historico
     |HORA aHora;
     aUsuario = Usuario % 810;
     |ABRE #flowm006;
     #flowm006#0  = #dsarm005#0;
     #flowm006#1  = 99999;
     |LEE 000#flowm006.];
     |SI FSalida = 0;
          |LEE 000#flowm006.a;
     |SINO;
          |LEE 000#flowm006.u;
     |FINSI;
     |SI FSalida = 0; |Y #flowm006#0 = #dsarm005#0;
          nLinea = #flowm006#1 + 1;
          nSitu = #flowm006#2;
     |SINO;
          nSitu = 1;
          nLinea = 1;
     |FINSI;
     |DDEFECTO #flowm006;
     #flowm006#0  = #dsarm005#0;
     #flowm006#1  = nLinea;
     |LEE 101#flowm006.=;
     |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
     #flowm006#2  = nSitu;
     #flowm006#3  = ~;
     #flowm006#4  = aHora;
     #flowm006#5  = aUsuario;
     aDocHis = ("000000000" + #dsarm005#0) % -109;
     #flowm006#6  = "VISUALIZADO RESUL. dsEscan DOCUMENTO: " + aDocHis;

     enNumRegFlow = #flowm006#0;
     enSituFlow = #flowm006#2;
     |HAZ DimeDesFlow;
     #flowm006#7 = eaDesSituFlow;

     |GRABA 020#flowm006.a;
     |LIBERA #flowm006;
     |CIERRA #flowm006;

     aEjecuta = "START " + eaUnidad + ":\DOCUMENTOS\DSARCHI\dsabreextension ";
     aEjecuta = aEjecuta + eaDestino;
     aEjecuta = aEjecuta + " " + eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";

     aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;

     |RSYSTEM aEjecuta;

     aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentw6;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentw6;
|FPRC;

|PROCESO MiraProceso;
     aProcesoPI = #dsarm034#17;
     |QBF aProcesoPI;
     |SI aProcesoPI ! "";
          nSwTieneProceso = 1;
     |FINSI;
|FPRC;

|PROCESO BajaPanta35;
     #dsarm035#0 = efFechaInte;
     #dsarm035#1 = eaHoraInte;
     #dsarm035#2 = eaFicInte;
     #dsarm035#3 = aVacio25;
|FPRC;

|PROCESO AltaPanta35;
     #dsarm035#0 = efFechaInte;
     #dsarm035#1 = eaHoraInte;
     #dsarm035#2 = eaFicInte;
     #dsarm035#3 = aZeta25;
|FPRC;

|PROCESO dsarm035_restaura;
     aValorAnt = #dsarm035#9;
     |QBF aValorAnt;
     |SI aValorAnt ! "*SIN CAMBIOS*";
          #dsarm035#4 = #dsarm035#9;
          #dsarm035#9 = "*SIN CAMBIOS*";
          |GRABA 020#dsarm035.a;
          |LIBERA #dsarm035;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm035_restaura;
     #dsarm035#1;
     ;
     #dsarm034#0, #dsarm034#1, #dsarm034#2, aVacio25;
     #dsarm034#0, #dsarm034#1, #dsarm034#2, aZeta25;
     be;
     NULL, dsarm035_restaura;
|FIN;

|PROCESO DescartaCambios;
     |SI nSwFormulario = 0;
          efFechaInte = #dsarm035#0;
          eaHoraInte  = #dsarm035#1;
          eaFicInte   = #dsarm035#2;
          aNomVarAra  = #dsarm035#3;

          |BUCLE dsarm035_restaura;
          |HAZ Integridad;

          #dsarm035#0 = efFechaInte;
          #dsarm035#1 = eaHoraInte;
          #dsarm035#2 = eaFicInte;
          #dsarm035#3 = aNomVarAra;
          |LEE 000#dsarm035.=;

          |REFRESCACONTROL nGrid68;

          |HAZ MeteVar69;
     |SINO;
          |BUCLE dsarm035_restaura;
          |HAZ Integridad;
          |HAZ MeteVar69;
          |HAZ PintaLabels;
          |PINDA #0#dsarw069;
     |FINSI;
|FPRC;

|PROCESO Boton9;
     nSwFormulario = 1;
     |HAZ DescartaCambios;

     |POSICIONATE #dsarw069#3;
     |HAZ MeteVar69;
     |HAZ DatosProveedor;
|FPRC;

|PROCESO Boton10;
     nSwFormulario = 0;
     |HAZ DescartaCambios;
|FPRC;

|PROCESO EnvioDocumento;
     ||Hay tres formas de enviar el correo. (Tenemos ejemplo en dsarw010)
     || 1. Estandard. dscorreo
     || 2. Usando SMTPCLI. (solo unix).  Seguro que no lo vamos a utilizar.
     || 3. Usando dsenviacorreo.exe.     En principio tampoco lo vamos a utilizar.

     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     aEmailDestino = #dsarm001#169;
     |QBF aEmailDestino;

     aIPLocal = "";
     |IP_LOCAL aIPLocal;    |QBF aIPLocal;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;

     aQueSistema = "";
     |QUE_SISTEMA aQueSistema;  |QBF aQueSistema;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "SMTPCLI";
     |HAZ DSARCHI_INI;
     nSwSMTPCLI = enAprobacion;
     enAprobacion = nGuarda;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "DSENVIACORREO";
     |HAZ DSARCHI_INI;
     nSwDsEnviaCorreo = enAprobacion;
     enAprobacion = nGuarda;

     |SI nSwSMTPCLI = 1;
          aMensaje = "0000Envio por SMTPCLI no soportado";
          |SI enMensaOCX = 0;
              ||MENAV aMensaje;
          |FINSI;
     |FINSI;

     |HAZ Tgz;

     |SI nSwDsEnviaCorreo = 1;
          |HAZ DsEnviaCorreo;
     |SINO;
          |HAZ MandaCorreo;
     |FINSI;
|FPRC;


|PROCESO DsEnviaCorreo;
     eaAdjuntoPLB   = aDestino;
     aIP            = #dsarw010#19;  |QBF aIP;
     eaServidorSMTP = aIP;
     eaPassPLB      = #dsarw010#22;
     eaUsuarioPLB   = #dsarw010#21;
     aFrom          = #dsarw010#1;   |QBF aFrom;
     eaOrigenPLB    = aFrom;
     eaDirRespoPLB  = eaOrigenPLB;
     aTo            = aEmailDestino; |QBF aTo;
     eaDestinoPLB   = aTo;

     |DBASE aBase;  |QBF aBase;
     |HAZ QuitaBarras;

     aAsunto = ("000000000000" + #dsarm034#7) % -112;
     aAsunto = aAsunto + " AJUSTES ";
     aAsunto = aAsunto + (aAuxExtension - ".") > "";

     eaAlfa   = "Documento dsEscan para ajustar en DS.";
     eaAlfa   = eaAlfa + " Tipo imagen: " + aAsunto;
     eaAlfa   = eaAlfa + " Cod: " + aIni + aAuxBarra + (("000000000" + #dsarm005#0) % -109);

     aMensaje = "";
     |DBASE aBase;
     |QBF aBase;
     aCuerpo = aBase + "documentos";  |MKDIR aCuerpo;
     aCuerpo = aBase + "documentos/correos";  |MKDIR aCuerpo;
     aCuerpo = aCuerpo + "/cuerpo" + (("000000000" + #dsarm005#0) % -109) + ".txt";
     |XABRE "WB", aCuerpo, nHandleC;
     |SI FSalida ] 0;
          aAlfa = eaAlfa + &13 + &10;
          |XGRABA nHandleC, aAlfa;

          aAlfa = "" + &13 + &10;
          |XGRABA nHandleC, aAlfa;

          |ABRE #dsarm037;
          #dsarm037#0 = #dsarm034#0;
          #dsarm037#1 = #dsarm034#1;
          #dsarm037#2 = #dsarm034#2;
          |LEE 000#dsarm037.=;
          |SI FSalida = 0;
               |PARA nVoyCampo = 3; |SI nVoyCampo [ 22; |HACIENDO nVoyCampo = nVoyCampo + 1;
                    aAlfa = #dsarm037#nVoyCampo#;
                    |QBF aAlfa;
                    aAlfa = aAlfa + &13 + &10;
                    |XGRABA nHandleC, aAlfa;
               |SIGUE;
          |FINSI;
          |CIERRA #dsarm037;

          |XCIERRA nHandleC;
     |SINO;
          aMensaje = eaAlfa;
          aTextoMe = "0000Error al generar " + aCuerpo;
          |MENAV aTextoMe;
     |FINSI;

     |SI #dsarw010#23 = "S";
          eaConfLecPLB = "S";
     |SINO;
          eaConfLecPLB = "N";
     |FINSI;
     eaAsuntoPLB = aAsunto;
     eaCuerpoPLB = aCuerpo;

     enSwErrorCorreoPLB = 0;
     |HAZ DSEnviaCorreoPLB;

     |SI enSwErrorCorreoPLB = 1;
          aMensaje = "0000Error al enviar el correo. [dsenviacorreo]";
          |MENAV aMensaje;
     |FINSI;

     |SI #dsarm001#181 = "S";
          |QBF eaBorraCache1;
          |SI eaBorraCache1 ! "";
               |RFBORRA eaBorraCache1;
          |FINSI;
          |QBF eaBorraCache2;
          |SI eaBorraCache2 ! "";
               |RFBORRA eaBorraCache2;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO AveriguaINI;
     aSerie = "";
     |ESPECIFICA "SERIALIZACION", aSerie;
     aIni = FSalida;          ||Antes esto lo devolvia en la variable aSerie
     aIni = aIni % 106;       ||Esto es el numero de ORO. Los 6 primeros digitos
     nIni = aIni;
     aIni = ("000000" + nIni) % -106;
|FPRC;

||ARA17
|PROCESO Tgz;
     ||PREPARO EL DIRECTORIO DONDE HARE EL TGZ

     aNomTgz     = "tgz" + Usuario;                     |QBF aNomTgz
     |DBASE aBase;  |QBF aBase;
     aDestinoTgz = aBase + "correos";                   |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/" + aNomTgz;         |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/";

     aDirectorio = aDestinoTgz;
     |HAZ BorraDir;

     aNomTgz     = "tgz" + Usuario;                     |QBF aNomTgz
     |DBASE aBase;  |QBF aBase;
     aDestinoTgz = aBase + "correos";                   |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/" + aNomTgz;         |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/";

     |HAZ QuitaBarras;

     ||COPIO EL DOCUMENTO RESULTADO OCR SI EXISTE.
     aPathAdj2 = #dsarm005#7;   |QBF aPathAdj2;
     aPathAdj2 = aPathAdj2 + #dsarm005#9;
     |QBF aPathAdj2;
     aPathAdj2 = aPathAdj2 + ".txt";

     aNomFichero = aIni + aAuxBarra + (("000000000" + #dsarm005#0) % -109);

     aDestino = aDestinoTgz + aNomFichero + ".txt";

     aOrigen  = aPathAdj2;

     |SI #dsarm001#7 = "N";
         |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
         |SI aIPRemoto ! "";
             |RECIBE_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     |XABRE "E", aDestino, nHandle;
     |SI FSalida < 0;
         aOrigen = aBase + "ocr/" + #dsarm005#9;   |QBF aOrigen;
         aOrigen = aOrigen + ".txt";

         |SI #dsarm001#7 = "N";
             |COPIA_FICHERO aOrigen, aDestino;
         |SINO;
             aIPRemoto = "";
             |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
             |SI aIPRemoto ! "";
                 |RECIBE_FICHERO aOrigen, aDestino;
             |SINO;
                 |COPIA_FICHERO aOrigen, aDestino;
             |FINSI;
         |FINSI;
     |FINSI;

     aAlfa = #dsarm005#9;  |HAZ QuitaNombre;

     ||COPIO EL DOCUMENTO PRINCIPAL.
     aOrigen = #dsarm005#7;
     |QBF aOrigen;
     aOrigen = aOrigen + #dsarm005#9;
     |QBF aOrigen;
     aDestino = aDestinoTgz + aNomFichero + aAuxExtension;  |QBF aDestino;

     |SI #dsarm001#7 = "N";
         |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
         |SI aIPRemoto ! "";
             |RECIBE_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     ||Ahora el ATAR.

     aFicTar = aDestinoTgz + aNomFichero + ".tar" + " " + aNomFichero + ".txt";
     aFicTar = aFicTar + " " + aNomFichero + aAuxExtension;

     |ATAR aFicTar, aDestinoTgz;
     |SI FSalida = 0;
          aFicTar = aDestinoTgz + aNomFichero + ".tar";
          |COMPRIME aFicTar;
          |SI FSalida = 0;
               aBorra = aDestinoTgz + aNomFichero + ".tar";
               |FBORRA aBorra;
               aDestino = aDestinoTgz + aNomFichero + ".tgz";
               nSwTgzOk = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BorraDir;          ||Borra todos los archivos de aDirectorio
     direc = ""; |DIRECTORIO direc; |QBF direc;
     |SI aDirectorio ! "/";
          aAlfa1 = direc + "bin/agirm -r " + aDirectorio;
          |SYSTEM aAlfa1;
     |FINSI;
|FPRC;

|PROCESO QuitaBarras;
     aAuxBarra = "";
     |QBF aBase;
     aLong = aBase % A0;
     nLong = aLong;
     |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
          nSaca = (nVoy * 100) + 1;
          aLetra = aBase % nSaca;
          |SI aLetra = "/";  |O aLetra = "\";
               aLetra = "_";
          |FINSI;
          aAuxBarra = aAuxBarra + aLetra;

          |SI aLetra = ":";
              aAuxBarra = "";
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO QuitaNombre;
     aAuxExtension = "";
     |QBF aAlfa;
     aLong = aAlfa % A0;
     nLong = aLong;
     nPon  = 0;
     |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
          nSaca  = (nVoy * 100) + 1;
          aLetra = aAlfa % nSaca;
          |SI aLetra = ".";
              nPon = 1;
          |FINSI;

          |SI nPon = 1;
              aAuxExtension = aAuxExtension + aLetra;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO CorreoEnUnix;
     aAlfa = #dsarw010#18;  |QBF aAlfa;
     |SI aAlfa ! aIPRemoto;  |ACABA;  |FINSI;

     |ESPECIFICA "RBASS", aLocal;
     aBaseLocal = aLocal;

     aDestino   = aBaseLocal + "bin/dscorreo.exe";
     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aVersion1  = FSalida;  |QBF aVersion1;

     |DBASE aBase;  |QBF aBase;
     aOrigen    = aBase + "dlls/dscorreo.exe";
     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aVersion2  = FSalida;  |QBF aVersion2;

     |SI aVersion1 ! aVersion2;
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aAlfa  = "cmd " + &34 + "/c START /MIN " + aDestino + &34;
     |RSYSTEM aAlfa;

     |MENSA "         ";
     |PULSATECLA;
     |SLEEP 1;
|FPRC;

|PROCESO CorreoEnDos;
     |SI aIPRemoto ! "";  |ACABA;  |FINSI;

     |IP_LOCAL aIPLocal;
     |QBF aIPLocal;

     aAlfa = #dsarw010#18;  |QBF aAlfa;
     |SI aAlfa ! aIPLocal;  |ACABA;  |FINSI;

     |DBASE aBase;  |QBF aBase;
     aOrigen    = aBase + "dlls/dscorreo.exe";

     aAlfa  = "cmd " + &34 + "/c START /MIN " + aOrigen + &34;
     |SYSTEM aAlfa;

     |MENSA "         ";
     |PULSATECLA;
     |SLEEP 1;
|FPRC;


|PROCESO MandaCorreo;
     |SI enSwDesde9 = 0;
          |VENTANA 0501, 2799, -1, 1, "";
          nVent1   = FSalida;

          |PINPA #0#dsarw013;
          |PINDA #0#dsarw013;
          |PTEC 802;
          |PAUSA;
     |SINO;
          |SI enSwNomina = 0;
               |PINPA #0#dsarw019;
               |PINDA #0#dsarw019;
               |PTEC 802;
               |PAUSA;
          |FINSI;
     |FINSI;

     |IP_REMOTO aIPRemoto;
     |QBF aIPRemoto;

     aAdjunto = aDestino;

     |SI aQueSistema = "ESDOS";
         |HAZ CorreoEnDos;
         |SI aIPRemoto ! "";
             |HAZ CorreoEnUnix;
         |FINSI;
     |SINO;
          |HAZ CorreoEnUnix;
     |FINSI;

     aIP = "";
     aIP = #dsarw010#18;  |QBF aIP;

     aFrom    = #dsarw010#1;   |QBF aFrom;
     aSalida  = #dsarw010#19;  |QBF aSalida;

     aTo      = aEmailDestino;
     |QBF aTo;

     |DBASE aBase;  |QBF aBase;
     |HAZ QuitaBarras;

     aAsunto = ("000000000000" + #dsarm034#7) % -112;
     aAsunto = aAsunto + " AJUSTES ";
     aAsunto = aAsunto + (aAuxExtension - ".") > "";

     eaAlfa   = "Documento dsEscan para ajustar en DS.";
     eaAlfa   = eaAlfa + " Tipo imagen: " + aAsunto;
     eaAlfa   = eaAlfa + " Cod: " + aIni + aAuxBarra + (("000000000" + #dsarm005#0) % -109);

     aMensaje = "";
     |DBASE aBase;
     |QBF aBase;
     aCuerpo = aBase + "documentos";  |MKDIR aCuerpo;
     aCuerpo = aBase + "documentos/correos";  |MKDIR aCuerpo;
     aCuerpo = aCuerpo + "/cuerpo" + (("000000000" + #dsarm005#0) % -109) + ".txt";
     |XABRE "WB", aCuerpo, nHandleC;
     |SI FSalida ] 0;
          aAlfa = eaAlfa + &13 + &10;
          |XGRABA nHandleC, aAlfa;

          aAlfa = "" + &13 + &10;
          |XGRABA nHandleC, aAlfa;

          |ABRE #dsarm037;
          #dsarm037#0 = #dsarm034#0;
          #dsarm037#1 = #dsarm034#1;
          #dsarm037#2 = #dsarm034#2;
          |LEE 000#dsarm037.=;
          |SI FSalida = 0;
               |PARA nVoyCampo = 3; |SI nVoyCampo [ 22; |HACIENDO nVoyCampo = nVoyCampo + 1;
                    aAlfa = #dsarm037#nVoyCampo#;
                    |QBF aAlfa;
                    aAlfa = aAlfa + &13 + &10;
                    |XGRABA nHandleC, aAlfa;
               |SIGUE;
          |FINSI;
          |CIERRA #dsarm037;

          |XCIERRA nHandleC;
          aMensaje = "$$$$" + aCuerpo;
     |SINO;
          aMensaje = eaAlfa;
          aTextoMe = "0000Error al generar " + aCuerpo;
          |MENAV aTextoMe;
     |FINSI;

     |SI #dsarw010#20 = "N";
          aAutenti = aFrom;
     |SINO;
          aAutenti = #dsarw010#22;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + #dsarw010#21;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + aFrom;
     |FINSI;

     |SI #dsarw010#23 = "S";
          aAutenti = "!" + aAutenti;
     |FINSI;

     |DSCORREO_ENVIA aIP, aSalida, aAutenti, aTo, aAsunto, aMensaje, aAdjunto;
     |SI FSalida < 0;
         enErrorCorreo = 1;
         |SI enMensaOCX = 0;
             |MENAV "0000 Ha habido un error durante el envio.";
         |FINSI;
     |FINSI;

     |FBORRA aCuerpo;

     |SI enSwDesde9 = 0;
          |FINVENTANA nVent1;
     |FINSI;
|FPRC;

|PROCESO Boton17;
     |ABRE #dsarm037;

     |ABRE #dsarm005;
     |DDEFECTO #dsarm005;
     #dsarm005#0 = #dsarm034#16;
     |LEE 000#dsarm005.=;
     |CIERRA #dsarm005;

     ||ARA17
     |VENTANA 0501, 3299, -1, 16, "Ajustar plantilla en DS";
     nVent17 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent17;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PINPA #0#dsarw079;
     nPanta579 = FSalida;

     |DDEFECTO #dsarw079;

     |DDEFECTO #dsarm037;
     #dsarm037#0 = #dsarm034#0;
     #dsarm037#1 = #dsarm034#1;
     #dsarm037#2 = #dsarm034#2;
     |LEE 000#dsarm037.=;
     |SI FSalida = 0;
          |PARA nVoyCampo = 3; |SI nVoyCampo [ 22; |HACIENDO nVoyCampo = nVoyCampo + 1;
               #dsarw079#nVoyCampo# = #dsarm037#nVoyCampo#;
          |SIGUE;
     |FINSI;
     |PINDA #0#dsarw079;

     |ENDATOS #1#dsarw079;
     |SI FSalida = 0;
          |DDEFECTO #dsarm037;
          #dsarm037#0 = #dsarm034#0;
          #dsarm037#1 = #dsarm034#1;
          #dsarm037#2 = #dsarm034#2;
          |LEE 101#dsarm037.=;
          |SI FSalida ! 0; |GRABA 020#dsarm037.b; |FINSI;
          |PARA nVoyCampo = 3; |SI nVoyCampo [ 22; |HACIENDO nVoyCampo = nVoyCampo + 1;
               #dsarm037#nVoyCampo# = #dsarw079#nVoyCampo#;
          |SIGUE;
          |GRABA 020#dsarm037.a;
          |LIBERA #dsarm037;
          ||ARA17
          |HAZ EnvioDocumento;
     |FINSI;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVent17;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVent17;

     |SI nSwSinRestaModal = 0;
          aVent1 = -1;
          aVent2 = -1;
          aVent3 = 0;
          aVent4 = nVentw6;
          aVent5 = "MODAL";
          |ESPECIFICA "ESTADO_VENTANA", aVent;
     |FINSI;

     |CIERRA #dsarm037;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;

|PROCESO Boton17SinRestaModal;
     nSwSinRestaModal = 1;
     |HAZ Boton17;
     nSwSinRestaModal = 0;
|FPRC;

|PROCESO Boton7;         ||Ver documento.
     ||ARA22
     |LEE 000#dsarm034.=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |HAZ CtrlCache;

     |ABRE #dsarm005;
     |DDEFECTO #dsarm005;
     #dsarm005#0 = #dsarm034#16;
     |LEE 000#dsarm005.=;
     |CIERRA #dsarm005;

     |HAZ DimeUnidad;
     |DBASE aPathBase;
     |QBF aPathBase;

     aAuxNom = #dsarm005#9;
     |QBF aAuxNom;

     eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "dsabreextension.exe";
     eaOrigen = aPathBase + "dlls/dsabreextension.exe";
     |HAZ EnviaFicheroConMD5;

     eaOrigen  = #dsarm005#7;
     |QBF eaOrigen;
     eaOrigen = eaOrigen + aAuxNom;

     eaDestino = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + aAuxNom;

     aIPRemoto   = "";
     |IP_REMOTO aIPRemoto;

     |SI #dsarm001#7 = "N";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO eaOrigen, eaDestino;
         |SINO;
             |COPIA_FICHERO eaOrigen, eaDestino;
         |FINSI;
     |SINO;
         |RCOPIA_FICHERO eaOrigen, eaDestino;
     |FINSI;

     |SI aIPRemoto = "";
         |XABRE "E", eaDestino, nHandle;
     |SINO;
         |XABRE "EC", eaDestino, nHandle;
     |FINSI;

     |SI FSalida < 0;
         aMensaje = "0000No puedo localizar el documento. Debe haber sido borrado o movido de carpeta";
         |MENAV aMensaje;
         |ACABA;
     |FINSI;

     aBorraCache = eaDestino;
     |QBF aBorraCache;

     |VENTANA 0501, 2999, -1, 16, "Visualizando Documento";
     nVentw6  = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentw6;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PINPA #0#dsarw008;
     |PINDA #0#dsarw008;
     |PTEC 802;
     |PAUSA;

     |XABRE "EC", eaDestino, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     ||Historico
     |HORA aHora;
     aUsuario = Usuario % 810;
     |ABRE #flowm006;
     #flowm006#0  = #dsarm005#0;
     #flowm006#1  = 99999;
     |LEE 000#flowm006.];
     |SI FSalida = 0;
          |LEE 000#flowm006.a;
     |SINO;
          |LEE 000#flowm006.u;
     |FINSI;
     |SI FSalida = 0; |Y #flowm006#0 = #dsarm005#0;
          nLinea = #flowm006#1 + 1;
          nSitu = #flowm006#2;
     |SINO;
          nSitu = 1;
          nLinea = 1;
     |FINSI;
     |DDEFECTO #flowm006;
     #flowm006#0  = #dsarm005#0;
     #flowm006#1  = nLinea;
     |LEE 101#flowm006.=;
     |SI FSalida ! 0; |GRABA 020#flowm006.b; |FINSI;
     #flowm006#2  = nSitu;
     #flowm006#3  = ~;
     #flowm006#4  = aHora;
     #flowm006#5  = aUsuario;
     aDocHis = ("000000000" + #dsarm005#0) % -109;
     #flowm006#6  = "VISUALIZADO DOCUMENTO: " + aDocHis;

     enNumRegFlow = #flowm006#0;
     enSituFlow = #flowm006#2;
     |HAZ DimeDesFlow;
     #flowm006#7 = eaDesSituFlow;

     |GRABA 020#flowm006.a;
     |LIBERA #flowm006;
     |CIERRA #flowm006;

     aEjecuta = "START " + eaUnidad + ":\DOCUMENTOS\DSARCHI\dsabreextension ";
     aEjecuta = aEjecuta + eaDestino;
     aEjecuta = aEjecuta + " " + eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";

     aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;

     |RSYSTEM aEjecuta;

     aAlfa  = eaUnidad + ":\DOCUMENTOS\DSARCHI\" + "fin" + Usuario + ".txt";
     |RFBORRA aAlfa;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentw6;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentw6;
|FPRC;

|PROCESO Boton2;         ||Editar Variables
     |LEE 000#dsarm034.=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     |HAZ Integridad;

     nCodPlantilla = #dsarm034#7;
     |SI nCodPlantilla = 0;
          aMensaje = "0000No existe plantilla dsEscan para este documento.";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;
     aCodPlantilla = ("000000000000" + nCodPlantilla) % -112;

     aProcesoPI = "";
     nSwTieneProceso = 0;
     |HAZ MiraProceso;

     |SI nSwTieneProceso = 0;
          aMensaje = "0000Plantilla " + aCodPlantilla + " sin <PROCESOPI> asignado." + &13 + "Contacte con Diagram Software.";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     |HAZ EditarVariables;
|FPRC;

|PROCESO EditarVariables;
     efFechaInte = #dsarm034#0;
     eaHoraInte  = #dsarm034#1;
     eaFicInte   = #dsarm034#2;

     |VENTANA 0501, 3099, -1, 16, "Variables dsEscan";
     nVentz68 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz68;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PINPA #0#dsarw068;
     nPanta68 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{137}} Ver documento", 2902, 3018, Boton7;
     nBoton8 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{207}} Descartar cambios", 2920, 3038, Boton10;
     nBoton10 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{156}} Ajustar Plantilla en DS", 2940, 3058, Boton17SinRestaModal;
     nBoton17 = FSalida;

     nRango = 1 + 2 + 4 + 8 + 16 + 32 + 128;

     |LINEAL_SIMPLE #1#dsarm035, nRango, 0502, 3098, BajaPanta35, AltaPanta35, NULL;
     nGrid68   = FSalida;
     |FOCOTECLADO nGrid68;

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::Salir," + nGrid68;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
         |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;

     |DESTRUYECONTROL nGrid68;

     |PULSATECLA;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz68;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentz68;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentw6;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |HAZ Integridad;
     |HAZ MeteVar69;
     |HAZ PintaLabels;

     |PINTA #dsarw069#46;
     |PINTA #dsarw069#48;
     |PINTA #dsarw069#49;

     |PINDA #0#dsarw069;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;

|PROCESO Integridad;
     enCodPrimeraInc = 0;
     eaPrimeraInc    = "";
     enSwAvisaInte   = 1;
     eaProcesoPIInte = aProcesoPI;
     enResultadoInte = 0;
     efFechaInte     = #dsarm034#0;
     eaHoraInte      = #dsarm034#1;
     eaFicInte       = #dsarm034#2;
     enCodIncidencia = 0;
     eaIncidencia    = "";
     |HAZ IntegridaddsEscan;
     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
     |SI enResultadoInte = 0;
          aIntegridadOK = "N";
     |SINO;
          aIntegridadOK = "S";
     |FINSI;
|FPRC;

|PROCESO dsarm035_limpia;
     aValorAnt = #dsarm035#9;
     |QBF aValorAnt;
     |SI aValorAnt ! "*SIN CAMBIOS*";
          #dsarm035#9 = "*SIN CAMBIOS*";
          |GRABA 020#dsarm035.a;
          |LIBERA #dsarm035;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm035_limpia;
     #dsarm035#1;
     ;
     #dsarm034#0, #dsarm034#1, #dsarm034#2, aVacio25;
     #dsarm034#0, #dsarm034#1, #dsarm034#2, aZeta25;
     be;
     NULL, dsarm035_limpia;
|FIN;

|PROCESO LimpiaValorAnterior;
     |BUCLE dsarm035_limpia;
|FPRC;

|PROCESO Nuevo35;
     |ABRE #dsarm036;
     #dsarm036#0 = aProcesoPI;
     #dsarm036#1 = aLinea35;
     |LEE 000#dsarm036.=;
     |SI FSalida ! 0;  |CIERRA #dsarm036;  |ACABA;  |FINSI;
     |CIERRA #dsarm036;

     #dsarm035#0 = #dsarm034#0;
     #dsarm035#1 = #dsarm034#1;
     #dsarm035#2 = #dsarm034#2;
     #dsarm035#3 = #dsarm036#1;
     |LEE 000#dsarm035.=;
     |SI FSalida = 0;  |ACABA;  |FINSI;

     |DDEFECTO #dsarm035;
     #dsarm035#0  = #dsarm034#0;
     #dsarm035#1  = #dsarm034#1;
     #dsarm035#2  = #dsarm034#2;
     #dsarm035#3  = #dsarm036#1;
     #dsarm035#10 = #dsarm036#9;
     #dsarm035#8  = "0,158,0;255,255,255";

     |GRABA 020#dsarm035.n;
     |LIBERA #dsarm035;
|FPRC;

|PROCESO Actualiza005;
     |SI nCampo005 ! 0;       ||El cero es la clave y NO se puede modificar aqui
          |SI nCampo005 ] 23; |Y nCampo005 [ 37;
               nLibre = nCampo005 - 22;
               |HAZ ActualizaLibre;
          |SINO;
               |SI nCampo005 ] 60; |Y nCampo005 [ 64;
                    nLibre = nCampo005 - 44;
                    |HAZ ActualizaLibre;
               |SINO;
                    #dsarm005#nCampo005# = aVarContenido;
               |FINSI;
          |FINSI;
          ||Devuelve
          nSwHayCambios5 = 1;
     |FINSI;
|FPRC;

|PROCESO ControlLibres;
     aAux = #dsarm004#nCampo#;
     |QBF aAux;
     |SI aAux ! "";
          nContReal = nContReal + 1;
          |SI nContReal = nLibre;
               aTextoLibre = aAux + ": " + aVarContenido;
               #dsarm005#nCampo005# = aTextoLibre;
               nSwAcaba = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ActualizaLibre;
     ||Literales del 1 al 10
     ||Numericos del 1 al 5
     ||Fechas del 1 al 5.

     nSwAcaba = 0;
     nContReal = 0;
     |PARA nCampo = 5;  |SI nCampo [ 9;  |HACIENDO nCampo = nCampo + 1;
          |HAZ ControlLibres;
     |SIGUE;
     |SI nSwAcaba = 1; |ACABA; |FINSI;
     |PARA nCampo = 27;  |SI nCampo [ 31;  |HACIENDO nCampo = nCampo + 1;
          |HAZ ControlLibres;
     |SIGUE;
     |SI nSwAcaba = 1; |ACABA; |FINSI;
     |PARA nCampo = 10;  |SI nCampo [ 19;  |HACIENDO nCampo = nCampo + 1;
          |HAZ ControlLibres;
     |SIGUE;
|FPRC;


|PROCESO FormularioOK;
     nSwFormularioOk = 0;

     #dsarm005#0 = #dsarm034#16;
     |LEE 000#dsarm005.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     #dsarm004#0 = #dsarm005#1;
     #dsarm004#1 = #dsarm005#2;
     #dsarm004#2 = #dsarm005#3;
     |LEE 000#dsarm004.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |SI #dsarm004#78 = 0;  |ACABA;  |FINSI;

     #dsarm029#0 = #dsarm004#78;
     |LEE 000#dsarm029.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     #dsarm005#0 = #dsarm034#16;
     |LEE 101#dsarm005.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     nSwHayCambios5 = 0;
     |PARA nVoy = 4; |SI nVoy [ 80; |HACIENDO nVoy = nVoy + 4;
           aBuscaVar = #dsarm029#nVoy#;  |QBF aBuscaVar;

           |SI aBuscaVar ! "";
               #dsarm035#0 = #dsarm034#0;
               #dsarm035#1 = #dsarm034#1;
               #dsarm035#2 = #dsarm034#2;
               #dsarm035#3 = aBuscaVar;
               |LEE 000#dsarm035.=;
               |SI FSalida = 0;
                   aVarContenido = #dsarm035#4;  |QBF aVarContenido;

                   nAuxVoy = nVoy + 2;
                   nCampo005 = #dsarm029#nAuxVoy#;
                   |HAZ Actualiza005;
               |FINSI;
           |FINSI;
     |SIGUE;

     |SI nSwHayCambios5 = 1;
         |GRABA 020#dsarm005.a;
     |FINSI;
     |LIBERA #dsarm005;
|FPRC;

|PROCESO Boton3;
     |LEE 000#dsarm034.=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     aProcesoPI = "";

     |SI #dsarm034#9 = "I";
          ||Boton. Introduccion sin plantilla.
          enSituacion = 1;
     |FINSI;

     |SI enSituacion = 1;
         |CONFI "0000NEl documento no tiene plantilla. Quiere introducir los datos manualmente";
         |SI FSalida ! 0; |ACABA; |FINSI;

         |LEE 101#dsarm034.=;
         #dsarm034#7          = 999999999999;
         #dsarm034#17         = "FR000000";
         |SI #dsarm034#9 = "I";
              #dsarm034#9 = "N";
              #dsarm034#10 = "N";
              #dsarm034#15 = "255,0,0;255,255,255";
         |FINSI;
         |GRABA 020#dsarm034.a;
         |LIBERA #dsarm034;

         aProcesoPI    = #dsarm034#17;
         nCodPlantilla = #dsarm034#7;

         aLinea35 = aProcesoPI + "-" + "fechaexpe";  |HAZ Nuevo35;
         aLinea35 = aProcesoPI + "-" + "clinif";     |HAZ Nuevo35;
         |HAZ Integridad;
         |HAZ EditarVariables;
     |FINSI;

     |SI enSituacion = 0;
         nCodPlantilla = #dsarm034#7;
         |SI nCodPlantilla = 0;
              aMensaje = "0000No existe plantilla dsEscan para este documento.";
              |MENAV aMensaje;
              |ACABA;
         |FINSI;
         aCodPlantilla = ("000000000000" + nCodPlantilla) % -112;

         nSwTieneProceso = 0;
         |HAZ MiraProceso;

         |SI nSwTieneProceso = 0;
             aMensaje = "0000Plantilla " + aCodPlantilla + " sin <PROCESOPI> asignado." + &13 + "Contacte con Diagram Software.";
             |MENAV aMensaje;
             |ACABA;
         |FINSI;

         |HAZ LimpiaValorAnterior;

         |HAZ Integridad;
     |FINSI;

     |SI #dsarm034#10 = "S"; |Y #dsarm034#22 = "N";
          aMensaje = "0000NDocumento Validado. Para revisar la integridad, es necesario dejarlo como pendiente de validar. Continuar?";
          |CONFI aMensaje;
          |SI FSalida ! 0;  |ACABA;  |FINSI;

          |LEE 101#dsarm034.=;
          |SI FSalida ! 0;  |ACABA;  |FINSI;

          #dsarm034#10 = "N";
          #dsarm034#11 = "01.01.0000";
          #dsarm034#12 = "";
          #dsarm034#13 = "";
          #dsarm034#14 = 0;
          #dsarm034#15 = "18,28,245;255,255,255";
          |GRABA 020#dsarm034.a;
          |LIBERA #dsarm034;

          aProcesoPI = #dsarm034#17;   |QBF aProcesoPI;
          |SI aProcesoPI = "FR000000";
               aEmpContagen = ("00000" + #dsarm034#18) % -105;

               |DBASS aBase;  |QBF aBase;

               aPathDatos = aBase + "despanet";                  |MKDIR aPathDatos;
               aPathDatos = aPathDatos + "/" + aEmpContagen;     |MKDIR aPathDatos;
               aPathDatos = aPathDatos + "/fich";                |MKDIR aPathDatos;
               aPathDatos = aPathDatos + "/";

               |PATH_DAT #dpntm101#aPathDatos#;

               |ABRE #dpntm101;
               |SELECT #5#dpntm101;
               #dpntm101#50 = #dsarm034#16;
               |LEE 101#dpntm101.=;
               |SI FSalida = 0;
                    |BORRA 020#dpntm101.a;
                    |LIBERA #dpntm101;
               |FINSI;
               |CIERRA #dpntm101;
          |FINSI;
     |FINSI;

     nSwFormularioOk = 0;
     |PARA; |SI; |HACIENDO;
            |LEE 000#dsarm034.=;
            |SI FSalida ! 0; |SAL; |FINSI;

            |SI #dsarm034#18 ! 0;
                |HAZ EditarFormulario;
                |SAL;
            |FINSI;

            aMensaje = "0000SIncidencia cr¡tica: Falta determinar la empresa contable" + &13 + "a travs del CIF del cliente y de la fecha de factura" + &13 + "Corregir?";
            |CONFI aMensaje;
            |SI FSalida ! 0;  |SAL;  |FINSI;

            |HAZ Integridad;
            |HAZ EditarVariables;
            |HAZ Integridad;
     |SIGUE;

     |HAZ LimpiaValorAnterior;

     |SI nSwFormularioOk = 1;
         |ABRE #dsarm004;
         |ABRE #dsarm005;
         |ABRE #dsarm029;
         |ABRE #dsarm035;
         |HAZ FormularioOK;
         |CIERRA #dsarm004;
         |CIERRA #dsarm005;
         |CIERRA #dsarm029;
         |CIERRA #dsarm035;
     |FINSI;

     |SI aQueUsu ! "";
         |SELECT #6#dsarm034;
     |SINO;
         |SELECT #5#dsarm034;
     |FINSI;

     |LEE 000#dsarm034.=;

     |SI nBotonArbol = -1;
         |SALVA_DATOS #gridref@;
         |HAZ ActualizaArbol;
         |REPON_DATOS #gridref@;

         |SELECT #1#gridref@;
         |LEE 000#gridref@.=;

         |REFRESCACONTROL nGridDos;
         |FOCOTECLADO nGridDos;
     |SINO;
         |REFRESCACONTROL nGrid0;
         |FOCOTECLADO nGrid0;
     |FINSI;
|FPRC;

|PROCESO Boton4;
     |LEE 000#dsarm034.=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     nSwValidaSinInte = 0;
     |SI #dsarm001#199 = "S";
          |SI nPendValidar = 0;
               aMensaje = "0000MIntegridad incompleta. Validar?";
               |CONFI aMensaje;
               |SI FSalida ! 0;
                    |ACABA;
               |SINO;
                    |SI #dsarm034#18 = 0;
                         aMensaje = "0000Incidencia cr¡tica: Falta determinar la empresa contable" + &13 + "a travs del CIF del cliente y de la fecha de factura" + &13 + "No se puede validar.";
                         |MENAV aMensaje;
                         |ACABA;
                    |FINSI;
                    nSwValidaSinInte = 1;
               |FINSI;
          |FINSI;
     |FINSI;

     |HAZ Procesar;      ||Boton Validar

     |SI aQueUsu ! "";
         |SELECT #6#dsarm034;
     |SINO;
         |SELECT #5#dsarm034;
     |FINSI;

     |LEE 000#dsarm034.=;

     FSalida = 1;
     |HAZ EventoGrid0;

     |REFRESCACONTROL nGrid0;
     |FOCOTECLADO nGrid0;

     |SI nBotonArbol = -1;  |HAZ ActualizaArbol;  |FINSI;
|FPRC;

|PROCESO ReintentarActual;
     |LEE 000#dsarm034.=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     enNumTotalDocs  = 0;          ||Solo hay que reintatar el corriente
     nPasada         = 1;
     enRecupera      = 0;
     enMensaOCX      = 1;
     |HAZ dsarm034Rec;

     |LEE 000#dsarm034.=;

     FSalida = 1;
     |HAZ EventoGrid0;

     |REFRESCACONTROL nGrid0;
     |FOCOTECLADO nGrid0;

     |SI nBotonArbol = -1;  |HAZ ActualizaArbol;  |FINSI;
|FPRC;

|PROCESO dsarm034Rec;
     |SI #dsarm034#9 = "I";  |Y #dsarm034#10 ! "I";
         #dsarm034#10 = "I";
         |GRABA 020#dsarm034.a;
         |LIBERA #dsarm034;
     |FINSI;

     nSituacion = 0;
     aAlfa      = #dsarm034#15;  |QBF aAlfa;

     |SI aAlfa = "110,110,110;255,255,255";    || Gris
         nSituacion = 1;
     |FINSI;

     |SI aAlfa = "192,192,192;255,255,255";    || Otro Gris
         nSituacion = 1;
     |FINSI;

     |SI #dsarm034#7 = 0;  |Y #dsarm034#9 ! "I";
         nSituacion = 1;
     |FINSI;

     |SI #dsarm034#9 = "N"; |Y #dsarm034#10 = "N";  |Y #dsarm034#7 ! 0;
         nSituacion = 2;
     |FINSI;

     |SI nSituacion = 0;  |ACABA;  |FINSI;

     |SI nQueSituacion ! 0;
         |SI nSituacion ! nQueSituacion;
             |ACABA;
         |FINSI;
     |FINSI;

     |SI nPasada = 0;
         nCuenta = nCuenta + 1;
         |ACABA;
     |FINSI;

     |BUCLE dsarm035B;

     |LIBERA #dsarm034;

     enSwReintentarOCR = 1;
     efFechaOCR      = #dsarm034#0;
     eaHoraOCR       = #dsarm034#1;
     eaCarpetaOrigen = #dsarm034#5;
     aAlfa = "dsarz013;" + #dsarm034#16;
     |SUB_EJECUTA aAlfa;
     enSwReintentarOCR = 0;
|FPRC;

|DEFBUCLE dsarm034Rec;
     #dsarm034#1;
     17;
     "01.01.0000", "     ", "                    ", "FR000000";
     "31.12.9999", "zzzzz", "zzzzzzzzzzzzzzzzzzzz", "FR000000";
     be;
     NULL, dsarm034Rec;
|FIN;

|PROCESO ReintentarPlantilla;
     |VENTANA 0510, 1080, -1, 16, "Realizando trabajo";
     nVentTrab = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802; |PAUSA;

     |CONTROL_SIMPLE 0, "LABEL,{{14}}Realizando trabajo", 0720, 0879, NULL;

     nProcesados = 0;

     nCuenta       = 0;
     nSwProcesa    = 0;
     nPasada       = 0;
     nQueSituacion = 1;
     |BUCLE dsarm034Rec;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentTrab;

     |SI nCuenta = 0;  |ACABA;  |FINSI;

     aAlfa = "0000NExisten " + nCuenta + " registros pendientes de asignar plantilla. Reintentar asignaci¢n ahora?";
     |CONFI aAlfa;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     enNumTotalDocs  = nCuenta;
     nPasada         = 1;
     enRecupera      = 0;
     enMensaOCX      = 1;
     nQueSituacion   = 1;
     |BUCLE dsarm034Rec;
     enMensaOCX = 0;

     |SI enRecupera = 0;
          aMensaje = "0000No se ha recuperado ningun documento.";
          |MENAV aMensaje;
     |SINO;
          |SI enRecupera = 1;
               aMensaje = "0000Recuperado 1 documento.";
               |MENAV aMensaje;
          |SINO;
               aMensaje = "0000Recuperados " + enRecupera + " documentos.";
               |MENAV aMensaje;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ReintentarIntegridad;
     |VENTANA 0510, 1080, -1, 16, "Realizando trabajo";
     nVentTrab = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802; |PAUSA;

     |CONTROL_SIMPLE 0, "LABEL,{{14}}Realizando trabajo", 0720, 0879, NULL;

     nProcesados = 0;

     nCuenta       = 0;
     nSwProcesa    = 0;
     nPasada       = 0;
     nQueSituacion = 2;
     |BUCLE dsarm034Rec;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentTrab;

     |SI nCuenta = 0;  |ACABA;  |FINSI;

     aAlfa = "0000NExisten " + nCuenta + " registros pendientes de integridad. Reintentar asignaci¢n ahora?";
     |CONFI aAlfa;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     enNumTotalDocs  = nCuenta;
     nPasada         = 1;
     enRecupera      = 0;
     enMensaOCX      = 1;
     nQueSituacion   = 2;
     |BUCLE dsarm034Rec;
     enMensaOCX = 0;

     |SI enRecupera = 0;
          aMensaje = "0000No se ha recuperado ningun documento.";
          |MENAV aMensaje;
     |SINO;
          |SI enRecupera = 1;
               aMensaje = "0000Recuperado 1 documento.";
               |MENAV aMensaje;
          |SINO;
               aMensaje = "0000Recuperados " + enRecupera + " documentos.";
               |MENAV aMensaje;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ReintentarTodos;
     |VENTANA 0510, 1080, -1, 16, "Realizando trabajo";
     nVentTrab = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802; |PAUSA;

     |CONTROL_SIMPLE 0, "LABEL,{{14}}Realizando trabajo", 0720, 0879, NULL;

     nProcesados = 0;

     nCuenta       = 0;
     nSwProcesa    = 0;
     nPasada       = 0;
     nQueSituacion = 0;
     |BUCLE dsarm034Rec;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentTrab;

     |SI nCuenta = 0;  |ACABA;  |FINSI;

     aAlfa = "0000NExisten " + nCuenta + " registros pendientes. Reintentar asignaci¢n ahora?";
     |CONFI aAlfa;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     enNumTotalDocs  = nCuenta;
     nPasada         = 1;
     enRecupera      = 0;
     enMensaOCX      = 1;
     nQueSituacion   = 0;
     |BUCLE dsarm034Rec;
     enMensaOCX = 0;

     |SI enRecupera = 0;
          aMensaje = "0000No se ha recuperado ningun documento.";
          |MENAV aMensaje;
     |SINO;
          |SI enRecupera = 1;
               aMensaje = "0000Recuperado 1 documento.";
               |MENAV aMensaje;
          |SINO;
               aMensaje = "0000Recuperados " + enRecupera + " documentos.";
               |MENAV aMensaje;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Boton12;
     aPopup1  = "0";
     aPopup2  = 4;
     aPopup3  = "Reintentar actual";
     aPopup4  = "Reintentar TODOS pendientes de plantilla";
     aPopup5  = "Reintentar TODOS pendientes de integridad";
     aPopup6  = "Reintentar TODOS";
     IaPopup  = aPopup1  <-;
     |ESPECIFICA "TRACKPOPUP", aPopup;
     nOpcion = FSalida;
     |SI nOpcion ! 0;
         |SI nOpcion = 1;  |HAZ ReintentarActual;      |FINSI;
         |SI nOpcion = 2;  |HAZ ReintentarPlantilla;   |FINSI;
         |SI nOpcion = 3;  |HAZ ReintentarIntegridad;  |FINSI;
         |SI nOpcion = 4;  |HAZ ReintentarTodos;       |FINSI;
     |FINSI;
|FPRC;

|PROCESO EditarFormulario;
     |SI nCodPlantilla = 0;
          aMensaje = "0000No existe plantilla dsEscan para este documento.";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;
     aCodPlantilla = ("000000000000" + nCodPlantilla) % -112;

     aProcesoPI = #dsarm034#17;
     |QBF aProcesoPI;
     |SI aProcesoPI = "";
          aMensaje = "0000Plantilla " + aCodPlantilla + " sin <PROCESOPI> asignado." + &13 + "Contacte con Diagram Software.";
          |MENAV aMensaje;
          |ACABA;
     |SINO;
          |HAZ FormularioFR000000;
     |FINSI;
|FPRC;

|PROCESO VerFormulario;
     |SI nCodPlantilla = 0;
          aMensaje = "0000No existe plantilla dsEscan para este documento.";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;
     aCodPlantilla = ("000000000000" + nCodPlantilla) % -112;

     aProcesoPI = #dsarm034#17;
     |QBF aProcesoPI;
     |SI aProcesoPI = "";
          aMensaje = "0000Plantilla " + aCodPlantilla + " sin <PROCESOPI> asignado." + &13 + "Contacte con Diagram Software.";
          |MENAV aMensaje;
          |ACABA;
     |SINO;
          |HAZ VerFormularioFR000000;
     |FINSI;
|FPRC;

|PROCESO dsarm035_mete69;
     aAlfa = #dsarm035#3;
     |QBF aAlfa;

     |SI aAlfa = "FR000000_base1";
          #dsarw069#21 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_base2";
          #dsarw069#30 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_base3";
          #dsarw069#37 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_base4";
          #dsarw069#57 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_base5";
          #dsarw069#64 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cuotaiva1";
          #dsarw069#23 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cuotaiva2";
          #dsarw069#32 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cuotaiva3";
          #dsarw069#39 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cuotaiva4";
          #dsarw069#59 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cuotaiva5";
          #dsarw069#66 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cuotare1";
          #dsarw069#25 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cuotare2";
          #dsarw069#34 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cuotare3";
          #dsarw069#41 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cuotare4";
          #dsarw069#61 = #dsarm035#4;
     |FINSI;
     |SI aAlfa = "FR000000_cuotare5";
          #dsarw069#68 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cuotareten1";
          #dsarw069#27 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cuotareten2";
          #dsarw069#36 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cuotareten3";
          #dsarw069#43 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cuotareten4";
          #dsarw069#63 = #dsarm035#4;
     |FINSI;
     |SI aAlfa = "FR000000_cuotareten5";
          #dsarw069#70 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_reten1SobreBF";
          #dsarw069#71 = #dsarm035#4;
     |FINSI;
     |SI aAlfa = "FR000000_reten2SobreBF";
          #dsarw069#72 = #dsarm035#4;
     |FINSI;
     |SI aAlfa = "FR000000_reten3SobreBF";
          #dsarw069#73 = #dsarm035#4;
     |FINSI;
     |SI aAlfa = "FR000000_reten4SobreBF";
          #dsarw069#74 = #dsarm035#4;
     |FINSI;
     |SI aAlfa = "FR000000_reten5SobreBF";
          #dsarw069#75 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_fechaexpe";
          #dsarw069#15 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_fechaope";
          #dsarw069#16 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_idfactura";
          #dsarw069#13 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_iva1";
          #dsarw069#22 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_iva2";
          #dsarw069#31 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_iva3";
          #dsarw069#38 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_iva4";
          #dsarw069#58 = #dsarm035#4;
     |FINSI;
     |SI aAlfa = "FR000000_iva5";
          #dsarw069#65 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_obs";
          #dsarw069#20 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_pronif";
          #dsarw069#2 = #dsarm035#4;
     |FINSI;

     aAlfa1 = #dsarw069#4;  |QBF aAlfa1;
     |SI aAlfa1 = "";
         |SI aAlfa = "FR000000_pronom";
              #dsarw069#4 = #dsarm035#4;
         |FINSI;
     |FINSI;

     |SI aAlfa = "FR000000_re1";
          #dsarw069#24 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_re2";
          #dsarw069#33 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_re3";
          #dsarw069#40 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_re4";
          #dsarw069#60 = #dsarm035#4;
     |FINSI;
     |SI aAlfa = "FR000000_re5";
          #dsarw069#67 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_reten1";
          #dsarw069#26 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_reten2";
          #dsarw069#35 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_reten3";
          #dsarw069#42 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_reten4";
          #dsarw069#62 = #dsarm035#4;
     |FINSI;
     |SI aAlfa = "FR000000_reten5";
          #dsarw069#69 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_total";
          #dsarw069#28 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_reprelegal";
          #dsarw069#3 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_pais";
          #dsarw069#5 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_idpaisre";
          #dsarw069#6 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_numidfiscalpais";
          #dsarw069#7 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_cloperacion";
          #dsarw069#8 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_nf";
          #dsarw069#9 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_nr";
          #dsarw069#10 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_primern";
          #dsarw069#11 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_ultimon";
          #dsarw069#12 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_idfacrec";
          #dsarw069#14 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_igic";
          #dsarw069#17 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_bieninve";
          #dsarw069#18 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_desbieninve";
          #dsarw069#19 = #dsarm035#4;
     |FINSI;

     |SI aAlfa = "FR000000_actividad";
          #dsarw069#1 = #dsarm035#4;
     |FINSI;

     aAlfa1 = #dsarw069#51;  |QBF aAlfa1;
     |SI aAlfa1 = "";
         |SI aAlfa = "FR000000_procalle";
             #dsarw069#51 = #dsarm035#4;
         |FINSI;
     |FINSI;

     aAlfa1 = #dsarw069#52;  |QBF aAlfa1;
     |SI aAlfa1 = "00000";  |O aAlfa1 = "";
         |SI aAlfa = "FR000000_procodpos";
              #dsarw069#52 = #dsarm035#4;
         |FINSI;
     |FINSI;

     aAlfa1 = #dsarw069#53;  |QBF aAlfa1;
     |SI aAlfa1 = "";
         |SI aAlfa = "FR000000_prolocalidad";
              #dsarw069#53 = #dsarm035#4;
         |FINSI;
     |FINSI;

     aAlfa1 = #dsarw069#54;  |QBF aAlfa1;
     |SI aAlfa1 = "";
         |SI aAlfa = "FR000000_protelefono";
              #dsarw069#54 = #dsarm035#4;
         |FINSI;
     |FINSI;

     aAlfa1 = #dsarw069#55;  |QBF aAlfa1;
     |SI aAlfa1 = "";
         |SI aAlfa = "FR000000_profax";
              #dsarw069#55 = #dsarm035#4;
         |FINSI;
     |FINSI;

     |SI aAlfa = "FR000000_proapcorreo";
          #dsarw069#56 = #dsarm035#4;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm035_mete69;
     #dsarm035#1;
     ;
     #dsarm034#0, #dsarm034#1, #dsarm034#2, aVacio25;
     #dsarm034#0, #dsarm034#1, #dsarm034#2, aZeta25;
     ;
     NULL, dsarm035_mete69;
|FIN;

|PROCESO DeIVA2aIVA1;
     #dsarw069#21 = #dsarw069#30; eaVar = "FR000000_base1";       eaValor = #dsarw069#21;  |HAZ GrabaVariable;
     #dsarw069#22 = #dsarw069#31; eaVar = "FR000000_iva1";        eaValor = #dsarw069#22;  |HAZ GrabaVariable;
     #dsarw069#23 = #dsarw069#32; eaVar = "FR000000_cuotaiva1";   eaValor = #dsarw069#23;  |HAZ GrabaVariable;
     #dsarw069#24 = #dsarw069#33; eaVar = "FR000000_re1";         eaValor = #dsarw069#24;  |HAZ GrabaVariable;
     #dsarw069#25 = #dsarw069#34; eaVar = "FR000000_cuotare1";    eaValor = #dsarw069#25;  |HAZ GrabaVariable;
     #dsarw069#26 = #dsarw069#35; eaVar = "FR000000_reten1";      eaValor = #dsarw069#26;  |HAZ GrabaVariable;
     #dsarw069#27 = #dsarw069#36; eaVar = "FR000000_cuotareten1"; eaValor = #dsarw069#27;  |HAZ GrabaVariable;
     #dsarw069#71 = #dsarw069#72; eaVar = "FR000000_reten1SobreBF"; eaValor = #dsarw069#71;  |HAZ GrabaVariable;


     #dsarw069#30 = 0; eaVar = "FR000000_base2";       eaValor = #dsarw069#30;  |HAZ GrabaVariable;
     #dsarw069#31 = 0; eaVar = "FR000000_iva2";        eaValor = #dsarw069#31;  |HAZ GrabaVariable;
     #dsarw069#32 = 0; eaVar = "FR000000_cuotaiva2";   eaValor = #dsarw069#32;  |HAZ GrabaVariable;
     #dsarw069#33 = 0; eaVar = "FR000000_re2";         eaValor = #dsarw069#33;  |HAZ GrabaVariable;
     #dsarw069#34 = 0; eaVar = "FR000000_cuotare2";    eaValor = #dsarw069#34;  |HAZ GrabaVariable;
     #dsarw069#35 = 0; eaVar = "FR000000_reten2";      eaValor = #dsarw069#35;  |HAZ GrabaVariable;
     #dsarw069#36 = 0; eaVar = "FR000000_cuotareten2"; eaValor = #dsarw069#36;  |HAZ GrabaVariable;
     #dsarw069#72 = "B"; eaVar = "FR000000_reten2SobreBF"; eaValor = #dsarw069#72;  |HAZ GrabaVariable;

     nSuma1 = #dsarw069#21 + #dsarw069#23 + #dsarw069#25 + #dsarw069#27;
     nSuma2 = #dsarw069#30 + #dsarw069#32 + #dsarw069#34 + #dsarw069#36;
     nSuma3 = #dsarw069#37 + #dsarw069#39 + #dsarw069#41 + #dsarw069#43;
     nSuma4 = #dsarw069#57 + #dsarw069#59 + #dsarw069#61 + #dsarw069#63;
     nSuma5 = #dsarw069#64 + #dsarw069#66 + #dsarw069#68 + #dsarw069#70;
|FPRC;

|PROCESO DeIVA3aIVA2;
     #dsarw069#30 = #dsarw069#37; eaVar = "FR000000_base2";       eaValor = #dsarw069#30;  |HAZ GrabaVariable;
     #dsarw069#31 = #dsarw069#38; eaVar = "FR000000_iva2";        eaValor = #dsarw069#31;  |HAZ GrabaVariable;
     #dsarw069#32 = #dsarw069#39; eaVar = "FR000000_cuotaiva2";   eaValor = #dsarw069#32;  |HAZ GrabaVariable;
     #dsarw069#33 = #dsarw069#40; eaVar = "FR000000_re2";         eaValor = #dsarw069#33;  |HAZ GrabaVariable;
     #dsarw069#34 = #dsarw069#41; eaVar = "FR000000_cuotare2";    eaValor = #dsarw069#34;  |HAZ GrabaVariable;
     #dsarw069#35 = #dsarw069#42; eaVar = "FR000000_reten2";      eaValor = #dsarw069#35;  |HAZ GrabaVariable;
     #dsarw069#36 = #dsarw069#43; eaVar = "FR000000_cuotareten2"; eaValor = #dsarw069#36;  |HAZ GrabaVariable;
     #dsarw069#72 = #dsarw069#73; eaVar = "FR000000_reten2SobreBF"; eaValor = #dsarw069#72;  |HAZ GrabaVariable;

     #dsarw069#37 = 0; eaVar = "FR000000_base3";       eaValor = #dsarw069#37;  |HAZ GrabaVariable;
     #dsarw069#38 = 0; eaVar = "FR000000_iva3";        eaValor = #dsarw069#38;  |HAZ GrabaVariable;
     #dsarw069#39 = 0; eaVar = "FR000000_cuotaiva3";   eaValor = #dsarw069#39;  |HAZ GrabaVariable;
     #dsarw069#40 = 0; eaVar = "FR000000_re3";         eaValor = #dsarw069#40;  |HAZ GrabaVariable;
     #dsarw069#41 = 0; eaVar = "FR000000_cuotare3";    eaValor = #dsarw069#41;  |HAZ GrabaVariable;
     #dsarw069#42 = 0; eaVar = "FR000000_reten3";      eaValor = #dsarw069#42;  |HAZ GrabaVariable;
     #dsarw069#43 = 0; eaVar = "FR000000_cuotareten3"; eaValor = #dsarw069#43;  |HAZ GrabaVariable;
     #dsarw069#73 = "B"; eaVar = "FR000000_reten3SobreBF"; eaValor = #dsarw069#73;  |HAZ GrabaVariable;

     nSuma1 = #dsarw069#21 + #dsarw069#23 + #dsarw069#25 + #dsarw069#27;
     nSuma2 = #dsarw069#30 + #dsarw069#32 + #dsarw069#34 + #dsarw069#36;
     nSuma3 = #dsarw069#37 + #dsarw069#39 + #dsarw069#41 + #dsarw069#43;
     nSuma4 = #dsarw069#57 + #dsarw069#59 + #dsarw069#61 + #dsarw069#63;
     nSuma5 = #dsarw069#64 + #dsarw069#66 + #dsarw069#68 + #dsarw069#70;
|FPRC;

|PROCESO DeIVA4aIVA3;
     #dsarw069#37 = #dsarw069#57; eaVar = "FR000000_base3";       eaValor = #dsarw069#37;  |HAZ GrabaVariable;
     #dsarw069#38 = #dsarw069#58; eaVar = "FR000000_iva3";        eaValor = #dsarw069#38;  |HAZ GrabaVariable;
     #dsarw069#39 = #dsarw069#59; eaVar = "FR000000_cuotaiva3";   eaValor = #dsarw069#39;  |HAZ GrabaVariable;
     #dsarw069#40 = #dsarw069#60; eaVar = "FR000000_re3";         eaValor = #dsarw069#40;  |HAZ GrabaVariable;
     #dsarw069#41 = #dsarw069#61; eaVar = "FR000000_cuotare3";    eaValor = #dsarw069#41;  |HAZ GrabaVariable;
     #dsarw069#42 = #dsarw069#62; eaVar = "FR000000_reten3";      eaValor = #dsarw069#42;  |HAZ GrabaVariable;
     #dsarw069#43 = #dsarw069#63; eaVar = "FR000000_cuotareten3"; eaValor = #dsarw069#43;  |HAZ GrabaVariable;
     #dsarw069#73 = #dsarw069#74; eaVar = "FR000000_reten3SobreBF"; eaValor = #dsarw069#73;  |HAZ GrabaVariable;

     #dsarw069#57 = 0; eaVar = "FR000000_base4";       eaValor = #dsarw069#57;  |HAZ GrabaVariable;
     #dsarw069#58 = 0; eaVar = "FR000000_iva4";        eaValor = #dsarw069#58;  |HAZ GrabaVariable;
     #dsarw069#59 = 0; eaVar = "FR000000_cuotaiva4";   eaValor = #dsarw069#59;  |HAZ GrabaVariable;
     #dsarw069#60 = 0; eaVar = "FR000000_re4";         eaValor = #dsarw069#60;  |HAZ GrabaVariable;
     #dsarw069#61 = 0; eaVar = "FR000000_cuotare4";    eaValor = #dsarw069#61;  |HAZ GrabaVariable;
     #dsarw069#62 = 0; eaVar = "FR000000_reten4";      eaValor = #dsarw069#62;  |HAZ GrabaVariable;
     #dsarw069#63 = 0; eaVar = "FR000000_cuotareten4"; eaValor = #dsarw069#63;  |HAZ GrabaVariable;
     #dsarw069#74 = "B"; eaVar = "FR000000_reten4SobreBF"; eaValor = #dsarw069#74;  |HAZ GrabaVariable;

     nSuma1 = #dsarw069#21 + #dsarw069#23 + #dsarw069#25 + #dsarw069#27;
     nSuma2 = #dsarw069#30 + #dsarw069#32 + #dsarw069#34 + #dsarw069#36;
     nSuma3 = #dsarw069#37 + #dsarw069#39 + #dsarw069#41 + #dsarw069#43;
     nSuma4 = #dsarw069#57 + #dsarw069#59 + #dsarw069#61 + #dsarw069#63;
     nSuma5 = #dsarw069#64 + #dsarw069#66 + #dsarw069#68 + #dsarw069#70;
|FPRC;

|PROCESO DeIVA5aIVA4;
     #dsarw069#57 = #dsarw069#64; eaVar = "FR000000_base4";       eaValor = #dsarw069#57;  |HAZ GrabaVariable;
     #dsarw069#58 = #dsarw069#65; eaVar = "FR000000_iva4";        eaValor = #dsarw069#58;  |HAZ GrabaVariable;
     #dsarw069#59 = #dsarw069#66; eaVar = "FR000000_cuotaiva4";   eaValor = #dsarw069#59;  |HAZ GrabaVariable;
     #dsarw069#60 = #dsarw069#67; eaVar = "FR000000_re4";         eaValor = #dsarw069#60;  |HAZ GrabaVariable;
     #dsarw069#61 = #dsarw069#68; eaVar = "FR000000_cuotare4";    eaValor = #dsarw069#61;  |HAZ GrabaVariable;
     #dsarw069#62 = #dsarw069#69; eaVar = "FR000000_reten4";      eaValor = #dsarw069#62;  |HAZ GrabaVariable;
     #dsarw069#63 = #dsarw069#70; eaVar = "FR000000_cuotareten4"; eaValor = #dsarw069#63;  |HAZ GrabaVariable;
     #dsarw069#74 = #dsarw069#75; eaVar = "FR000000_reten4SobreBF"; eaValor = #dsarw069#74; |HAZ GrabaVariable;

     #dsarw069#64 = 0; eaVar = "FR000000_base5";       eaValor = #dsarw069#64;  |HAZ GrabaVariable;
     #dsarw069#65 = 0; eaVar = "FR000000_iva5";        eaValor = #dsarw069#65;  |HAZ GrabaVariable;
     #dsarw069#66 = 0; eaVar = "FR000000_cuotaiva5";   eaValor = #dsarw069#66;  |HAZ GrabaVariable;
     #dsarw069#67 = 0; eaVar = "FR000000_re5";         eaValor = #dsarw069#67;  |HAZ GrabaVariable;
     #dsarw069#68 = 0; eaVar = "FR000000_cuotare5";    eaValor = #dsarw069#68;  |HAZ GrabaVariable;
     #dsarw069#69 = 0; eaVar = "FR000000_reten5";      eaValor = #dsarw069#69;  |HAZ GrabaVariable;
     #dsarw069#70 = 0; eaVar = "FR000000_cuotareten5"; eaValor = #dsarw069#70;  |HAZ GrabaVariable;
     #dsarw069#75 = "B"; eaVar = "FR000000_reten5SobreBF"; eaValor = #dsarw069#75;  |HAZ GrabaVariable;

     nSuma1 = #dsarw069#21 + #dsarw069#23 + #dsarw069#25 + #dsarw069#27;
     nSuma2 = #dsarw069#30 + #dsarw069#32 + #dsarw069#34 + #dsarw069#36;
     nSuma3 = #dsarw069#37 + #dsarw069#39 + #dsarw069#41 + #dsarw069#43;
     nSuma4 = #dsarw069#57 + #dsarw069#59 + #dsarw069#61 + #dsarw069#63;
     nSuma5 = #dsarw069#64 + #dsarw069#66 + #dsarw069#68 + #dsarw069#70;
|FPRC;

|PROCESO OrdenaBases;
     ||TODO CCC
     ||AHORA tendremos base 4 y base 5

     nSuma1 = #dsarw069#21 + #dsarw069#23 + #dsarw069#25 + #dsarw069#27;
     nSuma2 = #dsarw069#30 + #dsarw069#32 + #dsarw069#34 + #dsarw069#36;
     nSuma3 = #dsarw069#37 + #dsarw069#39 + #dsarw069#41 + #dsarw069#43;
     nSuma4 = #dsarw069#57 + #dsarw069#59 + #dsarw069#61 + #dsarw069#63;
     nSuma5 = #dsarw069#64 + #dsarw069#66 + #dsarw069#68 + #dsarw069#70;

     |SI nSuma1 ! 0;  |Y nSuma2 ! 0;  |Y nSuma3 ! 0; |Y nSuma4 ! 0; |Y nSuma5 ! 0;
         |ACABA;
     |FINSI;

     |SI nSuma1 = 0;  |Y nSuma2 = 0;  |Y nSuma3 = 0; |Y nSuma4 = 0; |Y nSuma5 = 0;
         |ACABA;
     |FINSI;

     ||ARA39. CCC. Esto es un poco lioso. Pero la idea es que los
     ||importes van bajando mientras el anterior esta vacio.

     |SI nSuma1 = 0;
         |SI nSuma2 ! 0;
             |HAZ DeIVA2aIVA1;
         |FINSI;

         |SI nSuma3 ! 0;
             |HAZ DeIVA3aIVA2;
             |SI nSuma1 = 0;
                  |HAZ DeIVA2aIVA1;
             |FINSI;
         |FINSI;

         |SI nSuma4 ! 0;
             |HAZ DeIVA4aIVA3;
             |SI nSuma2 = 0;
                  |HAZ DeIVA3aIVA2;
                  |SI nSuma1 = 0;
                       |HAZ DeIVA2aIVA1;
                  |FINSI;
             |FINSI;
         |FINSI;

         |SI nSuma5 ! 0;
             |HAZ DeIVA5aIVA4;
             |SI nSuma3 = 0;
                  |HAZ DeIVA4aIVA3;
                  |SI nSuma2 = 0;
                       |HAZ DeIVA3aIVA2;
                       |SI nSuma1 = 0;
                            |HAZ DeIVA2aIVA1;
                       |FINSI;
                  |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI nSuma2 = 0;
         |SI nSuma3 ! 0;
             |HAZ DeIVA3aIVA2;
         |FINSI;

         |SI nSuma4 ! 0;
             |HAZ DeIVA4aIVA3;
             |SI nSuma2 = 0;
                  |HAZ DeIVA3aIVA2;
             |FINSI;
         |FINSI;

         |SI nSuma5 ! 0;
             |HAZ DeIVA5aIVA4;
             |SI nSuma3 = 0;
                  |HAZ DeIVA4aIVA3;
                  |SI nSuma2 = 0;
                       |HAZ DeIVA3aIVA2;
                  |FINSI;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI nSuma3 = 0;
         |SI nSuma4 ! 0;
             |HAZ DeIVA4aIVA3;
         |FINSI;

         |SI nSuma5 ! 0;
             |HAZ DeIVA5aIVA4;
             |SI nSuma3 = 0;
                  |HAZ DeIVA4aIVA3;
             |FINSI;
         |FINSI;
     |FINSI;

     |SI nSuma4 = 0;
         |SI nSuma5 ! 0;
             |HAZ DeIVA5aIVA4;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO MeteVar69;
     #dsarm035#0 = #dsarm034#0;
     #dsarm035#1 = #dsarm034#1;
     #dsarm035#2 = #dsarm034#2;
     #dsarm035#3 = "FR000000_pronif";
     |LEE 000#dsarm035.=;
     |SI FSalida ! 0;  |DDEFECTO #dsarm035;  |FINSI;

     #dsarw069#2 = #dsarm035#4;

     eaCodNif  = #dsarw069#2;
     |HAZ LeeNifs;

     |ABRE #regisnif@;
     #regisnif@#0 = #dsarw069#2;
     |LEE 000#regisnif@.=;
     |SI FSalida = 0;
         #dsarw069#4   = #regisnif@#1;
         aAlfa1   = #regisnif@#2;  |QBF aAlfa1;
         aAlfa1   = aAlfa1 + " " + #regisnif@#3;
         #dsarw069#51 = aAlfa1;

         aAlfa1  = (("00" + #regisnif@#4) % -102) + (("000" + #regisnif@#5) % -103);
         #dsarw069#52 = aAlfa1;
         #dsarw069#53 = #regisnif@#6;
         #dsarw069#54 = #regisnif@#8;
         #dsarw069#55 = #regisnif@#17;
     |SINO;
        #dsarw069#4   = "";
        #dsarw069#51  = "";
        #dsarw069#52  = "00000";
        #dsarw069#53  = "";
        #dsarw069#54  = "";
        #dsarw069#55  = "";
        #dsarw069#56  = "";
     |FINSI;
     |CIERRA #regisnif@;

     |BUCLE dsarm035_mete69;
     |HAZ OrdenaBases;

     #dsarw069#50 = #dsarm034#16;

     aPais = #dsarw069#5;
     |QBF aPais;
     |SI aPais = "ES";
          #dsarw069#47 = "ESPA¥A";
     |FINSI;

     |SI #dsarw069#6 = "1";
         #dsarw069#48 = "NIF";
     |FINSI;

     |SI #dsarw069#6 = "2";
         #dsarw069#48 = "NIF/IVA (NIF operador intracomunitario)";
     |FINSI;

     |SI #dsarw069#6 = "3";
         #dsarw069#48 = "Pasaporte";
     |FINSI;

     |SI #dsarw069#6 = "4";
         #dsarw069#48 = "Documento Oficial de identificacion expedido por el pais o territorio de residencia";
     |FINSI;

     |SI #dsarw069#6 = "5";
         #dsarw069#48 = "Certificado de residencia fiscal";
     |FINSI;

     |SI #dsarw069#6 = "6";
         #dsarw069#48 = "Otro documento probatorio";
     |FINSI;

     |SI #dsarw069#8 = " ";
         #dsarw069#49 = "Operaci¢n habitual";
     |FINSI;

     |SI #dsarw069#8 = "A";
         #dsarw069#49 = "Asiento resumen de facturas";
     |FINSI;

     |SI #dsarw069#8 = "B";
         #dsarw069#49 = "Asiento resumen de tiques";
     |FINSI;

     |SI #dsarw069#8 = "C";
         #dsarw069#49 = "Factura con varios asientos (varios tipo impositivos)";
     |FINSI;

     |SI #dsarw069#8 = "D";
         #dsarw069#49 = "Factura rectificativa";
     |FINSI;

     |SI #dsarw069#8 = "F";
         #dsarw069#49 = "Adquisiciones realizadas por las agencias de viajes directamente en inters del viajero";
     |FINSI;

     |SI #dsarw069#8 = "G";
         #dsarw069#49 = "Rgimen especial de grupo de entidades en IVA o IGIC";
     |FINSI;

     |SI #dsarw069#8 = "H";
         #dsarw069#49 = "Rgimen especial de oro de inversi¢n";
     |FINSI;

     |SI #dsarw069#8 = "I";
         #dsarw069#49 = "Inversi¢n del Sujeto pasivo (ISP)";
     |FINSI;

     |SI #dsarw069#8 = "J";
         #dsarw069#49 = "Tiques";
     |FINSI;

     |SI #dsarw069#8 = "K";
         #dsarw069#49 = "Rectificación anotaciones registrales";
     |FINSI;

     |SI #dsarw069#8 = "L";
         #dsarw069#49 = "Adquisiciones a comerciantes minoristas del IGIC";
     |FINSI;

     |SI #dsarw069#8 = "P";
         #dsarw069#49 = "Adquisiciones intracomunitarias de bienes.";
     |FINSI;

     |SI #dsarw069#8 = "Q";
         #dsarw069#49 = "Operaciones a las que se aplique el rgimen especial de bienes usados, ...";
     |FINSI;

     |SI #dsarw069#1 = 0;
          #dsarw069#46 = "";
     |SINO;
          eaDimeActividad = "";
          |HAZ DimeActividad;
          eaUsuario = ("00000" + #dsarm034#18) % -105;
          #dsarw069#46 = eaDimeActividad;
     |FINSI;

     aAlfa1 = #dsarw069#4;  |QBF aAlfa1;
     |SI aAlfa1 ! "";
         eaVar   = "FR000000_pronom";
         eaValor = #dsarw069#4;
         |HAZ GrabaVariable;
     |FINSI;

     aAlfa1 = #dsarw069#5;  |QBF aAlfa1;
     |SI aAlfa1 ! "";
         eaVar   = "FR000000_pais";
         eaValor = #dsarw069#5;
         |HAZ GrabaVariable;
     |FINSI;

     aAlfa1 = #dsarw069#51;  |QBF aAlfa1;
     |SI aAlfa1 ! "";
         eaVar   = "FR000000_procalle";
         eaValor = #dsarw069#51;
         |HAZ GrabaVariable;
     |FINSI;

     aAlfa1 = #dsarw069#52;  |QBF aAlfa1;
     |SI aAlfa1 ! "00000";  |Y aAlfa1 ! "";
         eaVar   = "FR000000_procodpos";
         eaValor = #dsarw069#52;  |QBF eaValor;
         |HAZ GrabaVariable;
     |FINSI;

     aAlfa1 = #dsarw069#53;  |QBF aAlfa1;
     |SI aAlfa1 ! "";
         eaVar   = "FR000000_prolocalidad";
         eaValor = #dsarw069#53;
         |HAZ GrabaVariable;
     |FINSI;

     aAlfa1 = #dsarw069#54;  |QBF aAlfa1;
     |SI aAlfa1 ! "";
         eaVar   = "FR000000_protelefono";
         eaValor = #dsarw069#54;
         |HAZ GrabaVariable;
     |FINSI;

     aAlfa1 = #dsarw069#55;  |QBF aAlfa1;
     |SI aAlfa1 ! "";
         eaVar   = "FR000000_profax";
         eaValor = #dsarw069#55;
         |HAZ GrabaVariable;
     |FINSI;

     aAlfa1 = #dsarw069#56;  |QBF aAlfa1;
     |SI aAlfa1 ! "";
         eaVar   = "FR000000_proapcorreo";
         eaValor = #dsarw069#56;
         |HAZ GrabaVariable;
     |FINSI;
|FPRC;

|PROCESO FormularioFR000000;
     ||Solucionado este tema.   Sera la empresa de contagen. Que ya la conocemos.
     eaUsuario = ("00000" + #dsarm034#18) % -105;

     |VENTANA 0601, 3099, -1, 16, "Factura Recibida";
     nVentw6  = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentw6;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |DDEFECTO #dsarw069;
     |HAZ MeteVar69;

     |PINPA #0#dsarw069;  enPantallaFR000000 = FSalida;

     |HAZ DatosProveedor;
     |HAZ PintaLabels;

     |CONTROL_SIMPLE 0, "BOTON,{{137}} Editar variables", 2902, 3015, Boton2;
     nBoton2 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{137}} Ver documento", 2917, 3030, Boton7;
     nBoton7 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{207}} Descartar cambios", 2932, 3045, Boton9;
     nBoton9 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{156}} Ajustar Plantilla en DS", 2947, 3060, Boton17;
     nBoton17 = FSalida;

     |PINTA #dsarw069#46;
     |PINTA #dsarw069#48;
     |PINTA #dsarw069#49;

     |PINDA #0#dsarw069;
     |PTEC 802;
     |PAUSA;

     |SI enCodPrimeraInc ! 0;
          |QBF eaIncidencia;
          aMensaje = "0000SIncidencia: " + eaPrimeraInc + &13 + "Corregir?";
          |CONFI aMensaje;
          |SI FSalida ! 0;
               aVent1 = -1;
               aVent2 = -1;
               aVent3 = 0;
               aVent4 = nVentw6;
               aVent5 = "MODELESS";
               |ESPECIFICA "ESTADO_VENTANA", aVent;

               |FIN_CONTROL_WINDOWS nBoton2;

               |FINVENTANA nVentw6;
               enPantallaFR000000 = -1;
               |ACABA;
          |FINSI;
     |FINSI;

     |ENDATOS #1#dsarw069;
     nSwFormularioOk = 1;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentw6;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FIN_CONTROL_WINDOWS nBoton2;

     |FINVENTANA nVentw6;
     enPantallaFR000000 = -1;
|FPRC;

|PROCESO VerFormularioFR000000;
     ||Solucionado este tema.   Sera la empresa de contagen. Que ya la conocemos.
     eaUsuario = ("00000" + #dsarm034#18) % -105;

     |VENTANA 0601, 3099, -1, 16, "Factura Recibida";
     nVentwVer  = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentwVer;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |DDEFECTO #dsarw069;
     |HAZ MeteVar69;

     |PINPA #0#dsarw069; enPantallaFR000000 = FSalida;

     |HAZ DatosProveedor;
     |HAZ PintaLabels;

     |C_V #dsarw069#46, 1, "S";
     |C_V #dsarw069#48, 1, "S";
     |C_V #dsarw069#49, 1, "S";

     |PINTA #dsarw069#46;
     |PINTA #dsarw069#48;
     |PINTA #dsarw069#49;

     |PINDA #0#dsarw069;

     |PTEC 802;
     |PAUSA;

     |C_V #dsarw069#46, 1, "S";
     |C_V #dsarw069#48, 1, "S";
     |C_V #dsarw069#49, 1, "S";

     |PINTA #dsarw069#46;
     |PINTA #dsarw069#48;
     |PINTA #dsarw069#49;

     enModoFormulario = 1;
     |PAUSA;
     enModoFormulario = 0;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentwVer;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentwVer;
     enPantallaFR000000 = -1;
|FPRC;


|PROCESO Boton6;    ||Ver formulario. Solo modo consulta.
     |LEE 000#dsarm034.=;
     |SI FSalida ! 0; |ACABA; |FINSI;

     nCodPlantilla = #dsarm034#7;
     |SI nCodPlantilla = 0;
          aMensaje = "0000No existe plantilla dsEscan para este documento.";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;
     aCodPlantilla = ("000000000000" + nCodPlantilla) % -112;

     aProcesoPI = "";
     nSwTieneProceso = 0;
     |HAZ MiraProceso;

     |SI nSwTieneProceso = 0;
          aMensaje = "0000Plantilla " + aCodPlantilla + " sin <PROCESOPI> asignado." + &13 + "Contacte con Diagram Software.";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     |HAZ VerFormulario;

     |REFRESCACONTROL nGrid0;
|FPRC;

|PROCESO PideFecha;
     |VENTANA 0501, 1354, -1, 16, "Pedir desde fecha";
     nVentFecha = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentFecha;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     aFechaGuarda = aDFecha;

     #dsarw018#7 = aTipoFecha;
     #dsarw018#8 = aDFecha;

     |PINPA #0#dsarw018;
     |PINDA #0#dsarw018;
     |ENDATOS #1#dsarw018;
     |SI FSalida = 0;
         aDFecha    = #dsarw018#8;
         aTipoFecha = #dsarw018#7;
     |FINSI;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentFecha;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentFecha;

     |SI nBotonArbol ! -1;
         |SI aFechaGuarda ! aDFecha;
             fFecha1 = aDFecha;
             fFecha2 = aHFecha;
             |SI fFecha1 > fFecha2;
                 aDFecha = aHFecha;
             |FINSI;
             |REFRESCACONTROL nGrid0;
         |FINSI;

         |FOCOTECLADO nGrid0;
     |SINO;
         |SI aFechaGuarda ! aDFecha;
             fFecha1 = aDFecha;
             fFecha2 = aHFecha;
             |SI fFecha1 > fFecha2;
                 aDFecha = aHFecha;
             |FINSI;
             |HAZ ActualizaArbol;
         |FINSI;

         |FOCOTECLADO nTree;
     |FINSI;

     |HAZ BotonesParametros;
|FPRC;

|PROCESO QueUsuario;
     |SI aQueUsu ! "";
         aQueUsu = "";
     |SINO;
         |ABRE #dsarz010;
         |CONSULTA_CLAVE #1#dsarz010;
         |SI FSalida = 0;
             aQueUsu = #dsarz010#0;
         |FINSI;
         |CIERRA #dsarz010;
     |FINSI;

     |HAZ ActualizaGridArbol;
|FPRC;

|PROCESO ActualizaGridArbol;
     |SI aQueUsu = "";
         |HAZ LinealSinLimite;
     |FINSI;

     |SI aQueUsu ! "";
         |HAZ LinealPorUsuario;
     |FINSI;

     |SI nBotonLineal ! -1;  #dsarm000#12 = "A";  |FINSI;
     |SI nBotonArbol  ! -1;  #dsarm000#12 = "L";  |FINSI;

     |SI #dsarm000#12 = "A";
         |HAZ Arbol;
     |SINO;
        |FOCOTECLADO nGrid0;
     |FINSI;

     |HAZ BotonesParametros;
|FPRC;

|PROCESO BotonTodos;
     aTipoEstado = "T";
     aDTipo = " ";
     aHTipo = "z";

     |HAZ ActBotonesEstado;
     |HAZ ActualizaGridArbol;
|FPRC;

|PROCESO BotonProce;
     aTipoEstado = "S";
     aDTipo = "S";
     aHTipo = "S";
     |HAZ ActBotonesEstado;
     |HAZ ActualizaGridArbol;
|FPRC;

|PROCESO BotonPendi;
     aTipoEstado = "N";
     aDTipo = "N";
     aHTipo = "N";
     |HAZ ActBotonesEstado;
     |HAZ ActualizaGridArbol;
|FPRC;

|PROCESO BotonesParametros;
     |SI nBotonFecha ! -1;
         |FIN_CONTROL_WINDOWS nBotonFecha;
         nBotonFecha = -1;
     |FINSI;

     |SI aTipoFecha = "1";  aAlfa = "BOTON,Desde Fecha: SIN LIMITE";        |FINSI;
     |SI aTipoFecha = "2";  aAlfa = "BOTON,Desde Fecha: MES ACTUAL";        |FINSI;
     |SI aTipoFecha = "3";  aAlfa = "BOTON,Desde Fecha: A¥O ACTUAL";        |FINSI;
     |SI aTipoFecha = "4";  aAlfa = "BOTON,Desde Fecha: TRES MESES ATRAS";  |FINSI;
     |SI aTipoFecha = "5";  aAlfa = "BOTON,Desde Fecha: SEIS MESES ATRAS";  |FINSI;
     |SI aTipoFecha = "6";  aAlfa = "BOTON,Desde Fecha: UN A¥O ATRAS";      |FINSI;
     |SI aTipoFecha = "7";  aAlfa = "BOTON,Desde Fecha: " + aDFecha;        |FINSI;

     |CONTROL_SIMPLE nPanta0, aAlfa, 0570, 0598, PideFecha;
     nBotonFecha = FSalida;

     |SI nBotonUsu ! -1;
         |FIN_CONTROL_WINDOWS nBotonUsu;
         nBotonUsu = -1;
     |FINSI;

     |SI aQueUsu = "";
         aAlfa = "BOTON, Usuario: SIN LIMITE";
     |FINSI;

     |SI aQueUsu ! "";
         aAlfa = "BOTON, Usuario: " + aQueUsu;
     |FINSI;

     |CONTROL_SIMPLE nPanta0, aAlfa, 0548, 0568, QueUsuario;
     nBotonUsu = FSalida;

     |SI nBotonTodos = -1;
          |CONTROL_SIMPLE nPanta0, "BOTON, Todos", 0501, 0515, BotonTodos;
          nBotonTodos = FSalida;
     |FINSI;
     |SI nBotonProce = -1;
          |CONTROL_SIMPLE nPanta0, "BOTON, Validados", 0516, 0530, BotonProce;
          nBotonProce = FSalida;
     |FINSI;
     |SI nBotonPendi = -1;
          |CONTROL_SIMPLE nPanta0, "BOTON, Pendientes", 0531, 0545, BotonPendi;
          nBotonPendi = FSalida;
     |FINSI;

     |HAZ ActBotonesEstado;
|FPRC;

|PROCESO ActBotonesEstado;
     |SI aTipoEstado = "T";
          |ESTADO_CONTROL nBotonTodos, "DISABLE";
          |ESTADO_CONTROL nBotonProce, "ENABLE";
          |ESTADO_CONTROL nBotonPendi, "ENABLE";
     |FINSI;
     |SI aTipoEstado = "S";
          |ESTADO_CONTROL nBotonTodos, "ENABLE";
          |ESTADO_CONTROL nBotonProce, "DISABLE";
          |ESTADO_CONTROL nBotonPendi, "ENABLE";
     |FINSI;
     |SI aTipoEstado = "N";
          |ESTADO_CONTROL nBotonTodos, "ENABLE";
          |ESTADO_CONTROL nBotonProce, "ENABLE";
          |ESTADO_CONTROL nBotonPendi, "DISABLE";
     |FINSI;
|FPRC;


|PROCESO BotonesPanta0;
     |CONTROL_SIMPLE 0, "BOTON,{{137}}Ver texto dsEscan", 2901, 3011, Boton1;
     nBoton1 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{137}}Ver formulario", 2913, 3023, Boton6;
     nBoton6 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{137}}Ver documento", 2925, 3035, Boton7;
     nBoton11 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,Introducci¢n sin plantilla", 2937, 3047, Boton3;
     nBoton16 = FSalida;
     |ESTADO_CONTROL nBoton16, "HIDE";

     |CONTROL_SIMPLE 0, "BOTON,{{135}}Revisar integridad", 2937, 3047, Boton3;
     nBoton3 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{197}}Reintentar", 2949, 3059, Boton12;
     nBoton12 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{197}}Validar", 2961, 3071, Boton4;
     nBoton4 = FSalida;

     |CONTROL_SIMPLE 0, "BOTON,{{197}}Cambiar empresa dsConta", 2980, 3099, Boton13;
     nBoton13 = FSalida;

     |CONTROL_SIMPLE nPanta0, "BOTON,{{207}}Eliminar", 3090, 3099, Boton14;
     nBoton14 = FSalida;

     |SI #dsarm000#12 = "L";
          |CONTROL_SIMPLE 0, "BOTON,{{155}}Vistas por arbol", 3202, 3220, Arbol;
          nBotonArbol = FSalida;
     |FINSI;

     |SI #dsarm000#12 = "A";
          |CONTROL_SIMPLE 0, "BOTON,{{155}}Vistas por lineal", 3202, 3220, Lineal;
          nBotonLineal = FSalida;

          |CONTROL_SIMPLE 0, "BOTON,{{137}} Cambiar Vistas", 3242, 3260, CambiaArbol;
          nBotonCambia = FSalida;

          |CONTROL_SIMPLE 0, "BOTON,{{197}} Actualizar Arbol", 3222, 3240, ActualizaArbol;
          nBotonActualiza = FSalida;
     |FINSI;

     |HAZ BotonesParametros;

     |ESTADO_CONTROL nBoton1, "ENABLE";
     |ESTADO_CONTROL nBoton3, "DISABLE";
     |ESTADO_CONTROL nBoton6, "ENABLE";
     |ESTADO_CONTROL nBoton11, "ENABLE";
     |ESTADO_CONTROL nBoton4, "DISABLE";
     |ESTADO_CONTROL nBoton12, "DISABLE";
|FPRC;

|PROCESO CalculaParametros;
     fFecha  = ~;

     |SI aTipoFecha = "1";
         aDFecha = "01.01.0000";
     |FINSI;

     |SI aTipoFecha = "2";
         aAlfa   = fFecha % 0402;
         aAlfa   = "01." + aAlfa + (fFecha % -105);
         aDFecha = aAlfa;
     |FINSI;

     |SI aTipoFecha = "3";
         aAlfa   = "01.01." + (fFecha % -104);
         aDFecha = aAlfa;
     |FINSI;

     |SI aTipoFecha = "4";
         nNume   = fFecha;
         nNume   = (nNume - 92);
         fFecha  = nNume;
         aDFecha = fFecha;
     |FINSI;

     |SI aTipoFecha = "5";
         nNume  = fFecha;
         nNume  = (nNume - 184);
         fFecha  = nNume;
         aDFecha = fFecha;
     |FINSI;

     |SI aTipoFecha = "6";
         nNume  = fFecha;
         nNume  = (nNume - 365);
         fFecha  = nNume;
         aDFecha = fFecha;
     |FINSI;
|FPRC;

|PROCESO RestoBases;
     |SI #dsarw069#30 ! 0;
         |LEE 000#dpntm101.u;
         |SI FSalida ! 0;  #dpntm101#0 = 0;  |FINSI;
         nReg = #dpntm101#0 + 1;

         |DDEFECTO #dpntm101;
         #dpntm101#0  = nReg;
         #dpntm101#44 = "N";
         |GRABA 020#dpntm101.b;

         |PARA nCampo = 1;  |SI nCampo [ 75;  |HACIENDO nCampo = nCampo + 1;
               #dpntm101#nCampo# = #dsarw069#nCampo#;
         |SIGUE;

         |SI #dpntm101#1 = 0;  #dpntm101#1 = 1;  |FINSI;

         #dpntm101#0  = nReg;
         #dpntm101#44 = "N";
         #dpntm101#45 = nRegPrimerIVA;
         #dpntm101#21 = #dsarw069#30;
         #dpntm101#22 = #dsarw069#31;
         #dpntm101#23 = #dsarw069#32;
         #dpntm101#24 = #dsarw069#33;
         #dpntm101#25 = #dsarw069#34;
         #dpntm101#26 = #dsarw069#35;
         #dpntm101#27 = #dsarw069#36;
         #dpntm101#71 = #dsarw069#72;
         #dpntm101#30 = #dsarw069#21;
         #dpntm101#31 = #dsarw069#22;
         #dpntm101#32 = #dsarw069#23;
         #dpntm101#33 = #dsarw069#24;
         #dpntm101#34 = #dsarw069#25;
         #dpntm101#35 = #dsarw069#26;
         #dpntm101#36 = #dsarw069#27;
         #dpntm101#72 = #dsarw069#71;

         |GRABA 020#dpntm101.a;
         |LIBERA #dpntm101;
     |FINSI;

     |SI #dsarw069#37 ! 0;
         |LEE 000#dpntm101.u;
         |SI FSalida ! 0;  #dpntm101#0 = 0;  |FINSI;
         nReg = #dpntm101#0 + 1;

         |DDEFECTO #dpntm101;
         #dpntm101#0  = nReg;
         #dpntm101#44 = "N";
         |GRABA 020#dpntm101.b;

         |PARA nCampo = 1;  |SI nCampo [ 75;  |HACIENDO nCampo = nCampo + 1;
               #dpntm101#nCampo# = #dsarw069#nCampo#;
         |SIGUE;

         #dpntm101#0  = nReg;
         #dpntm101#44 = "N";
         #dpntm101#45 = nRegPrimerIVA;
         #dpntm101#21 = #dsarw069#37;
         #dpntm101#22 = #dsarw069#38;
         #dpntm101#23 = #dsarw069#39;
         #dpntm101#24 = #dsarw069#40;
         #dpntm101#25 = #dsarw069#41;
         #dpntm101#26 = #dsarw069#42;
         #dpntm101#27 = #dsarw069#43;
         #dpntm101#71 = #dsarw069#73;
         #dpntm101#37 = #dsarw069#21;
         #dpntm101#38 = #dsarw069#22;
         #dpntm101#39 = #dsarw069#23;
         #dpntm101#40 = #dsarw069#24;
         #dpntm101#41 = #dsarw069#25;
         #dpntm101#42 = #dsarw069#26;
         #dpntm101#43 = #dsarw069#27;
         #dpntm101#73 = #dsarw069#71;

         |GRABA 020#dpntm101.a;
         |LIBERA #dpntm101;
     |FINSI;

     |SI #dsarw069#57 ! 0;
         |LEE 000#dpntm101.u;
         |SI FSalida ! 0;  #dpntm101#0 = 0;  |FINSI;
         nReg = #dpntm101#0 + 1;

         |DDEFECTO #dpntm101;
         #dpntm101#0  = nReg;
         #dpntm101#44 = "N";
         |GRABA 020#dpntm101.b;

         |PARA nCampo = 1;  |SI nCampo [ 75;  |HACIENDO nCampo = nCampo + 1;
               #dpntm101#nCampo# = #dsarw069#nCampo#;
         |SIGUE;

         #dpntm101#0  = nReg;
         #dpntm101#44 = "N";
         #dpntm101#45 = nRegPrimerIVA;
         #dpntm101#21 = #dsarw069#57;
         #dpntm101#22 = #dsarw069#58;
         #dpntm101#23 = #dsarw069#59;
         #dpntm101#24 = #dsarw069#60;
         #dpntm101#25 = #dsarw069#61;
         #dpntm101#26 = #dsarw069#62;
         #dpntm101#27 = #dsarw069#63;
         #dpntm101#71 = #dsarw069#74;
         #dpntm101#57 = #dsarw069#21;
         #dpntm101#58 = #dsarw069#22;
         #dpntm101#59 = #dsarw069#23;
         #dpntm101#60 = #dsarw069#24;
         #dpntm101#61 = #dsarw069#25;
         #dpntm101#62 = #dsarw069#26;
         #dpntm101#63 = #dsarw069#27;
         #dpntm101#74 = #dsarw069#71;

         |GRABA 020#dpntm101.a;
         |LIBERA #dpntm101;
     |FINSI;

     |SI #dsarw069#64 ! 0;
         |LEE 000#dpntm101.u;
         |SI FSalida ! 0;  #dpntm101#0 = 0;  |FINSI;
         nReg = #dpntm101#0 + 1;

         |DDEFECTO #dpntm101;
         #dpntm101#0  = nReg;
         #dpntm101#44 = "N";
         |GRABA 020#dpntm101.b;

         |PARA nCampo = 1;  |SI nCampo [ 75;  |HACIENDO nCampo = nCampo + 1;
               #dpntm101#nCampo# = #dsarw069#nCampo#;
         |SIGUE;

         #dpntm101#0  = nReg;
         #dpntm101#44 = "N";
         #dpntm101#45 = nRegPrimerIVA;
         #dpntm101#21 = #dsarw069#64;
         #dpntm101#22 = #dsarw069#65;
         #dpntm101#23 = #dsarw069#66;
         #dpntm101#24 = #dsarw069#67;
         #dpntm101#25 = #dsarw069#68;
         #dpntm101#26 = #dsarw069#69;
         #dpntm101#27 = #dsarw069#70;
         #dpntm101#71 = #dsarw069#75;
         #dpntm101#64 = #dsarw069#21;
         #dpntm101#65 = #dsarw069#22;
         #dpntm101#66 = #dsarw069#23;
         #dpntm101#67 = #dsarw069#24;
         #dpntm101#68 = #dsarw069#25;
         #dpntm101#69 = #dsarw069#26;
         #dpntm101#70 = #dsarw069#27;
         #dpntm101#75 = #dsarw069#71;

         |GRABA 020#dpntm101.a;
         |LIBERA #dpntm101;
     |FINSI;
|FPRC;

|PROCESO GrabaDPNTM101;
     aEmpContagen = ("00000" + #dsarm034#18) % -105;

     |DBASS aBase;  |QBF aBase;

     aPathDatos = aBase + "despanet";                  |MKDIR aPathDatos;
     aPathDatos = aPathDatos + "/" + aEmpContagen;     |MKDIR aPathDatos;
     aPathDatos = aPathDatos + "/fich";                |MKDIR aPathDatos;
     aPathDatos = aPathDatos + "/";

     |PATH_DAT #dpntm101#aPathDatos#;

     |ABRE #dpntm101;

     |SELECT #1#dpntm101;
     |LEE 000#dpntm101.u;
     |SI FSalida ! 0;  #dpntm101#0 = 0;  |FINSI;

     nReg = #dpntm101#0 + 1;
     |DDEFECTO #dpntm101;
     #dpntm101#0  = nReg;
     #dpntm101#44 = "S";
     |GRABA 020#dpntm101.b;

     |DDEFECTO #dsarw069;
     |HAZ MeteVar69;

     |PARA nCampo = 1;  |SI nCampo [ 75;  |HACIENDO nCampo = nCampo + 1;
           #dpntm101#nCampo# = #dsarw069#nCampo#;
     |SIGUE;

     #dpntm101#44 = "S";

     |GRABA 020#dpntm101.a;
     |LIBERA #dpntm101;

     |SI #dsarw069#30 ! 0;  |O #dsarw069#37 ! 0; |O #dsarw069#57 ! 0; |O #dsarw069#64 ! 0;
         nRegPrimerIVA = #dpntm101#0;
         |SELECT #1#dpntm101;
         |HAZ RestoBases;
     |FINSI;

     |LEE 101#dsarm034.=;
     |SI FSalida = 0;
         |HORA aHora;  aHora = aHora % 105;
         aUsuario = Usuario % 810;

         #dsarm034#10 = "S";
         #dsarm034#11 = ~;
         #dsarm034#12 = aHora;
         #dsarm034#13 = aUsuario;
         #dsarm034#14 = #dsarm034#16;
         #dsarm034#15 = "200,150,0;255,255,255";
         |GRABA 020#dsarm034.a;
         |LIBERA #dsarm034;

         nProcesados = nProcesados + 1;
     |FINSI;
     |CIERRA #dpntm101;
|FPRC;

|PROCESO Procesar;
     |SI #dsarm034#10 = "S";  |ACABA;  |FINSI;

     |SI #dsarm034#9  = "I";
          |SI nSwValidaSinInte = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     nCodPlantilla = #dsarm034#7;
     |SI nCodPlantilla = 0;  |ACABA;  |FINSI;
     aCodPlantilla = ("000000000000" + nCodPlantilla) % -112;

     aProcesoPI = "";
     nSwTieneProceso = 0;
     |HAZ MiraProceso;

     |SI nSwTieneProceso = 0;
          |ACABA;
     |FINSI;

     |SI nSwValidaSinInte = 1;
          #dsarm034#9 = "S";
     |SINO;
          enNoTocarEmpPerContagen = 1;
          enCodPrimeraInc         = 0;
          eaPrimeraInc            = "";
          enSwAvisaInte           = 0;
          eaProcesoPIInte         = aProcesoPI;
          enResultadoInte         = 0;
          efFechaInte             = #dsarm034#0;
          eaHoraInte              = #dsarm034#1;
          eaFicInte               = #dsarm034#2;
          enCodIncidencia         = 0;
          eaIncidencia            = "";
          |HAZ IntegridaddsEscan;
          enNoTocarEmpPerContagen = 0;
     |FINSI;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     |SI #dsarm034#9 = "N";  |ACABA;  |FINSI;
     |SI #dsarm034#18 = 0;   |ACABA;  |FINSI;

     |SI aProcesoPI = "FR000000";
         |HAZ GrabaDPNTM101;
     |FINSI;
|FPRC;

|PROCESO dsarm034C;
     |SI #dsarm034#10 = "S";  |ACABA;  |FINSI;
     |SI #dsarm034#9  = "I";  |ACABA;  |FINSI;

     nCodPlantilla = #dsarm034#7;
     |SI nCodPlantilla = 0;
          |ACABA;
     |FINSI;
     aCodPlantilla = ("000000000000" + nCodPlantilla) % -112;

     aProcesoPI = "";
     nSwTieneProceso = 0;
     |HAZ MiraProceso;

     |SI nSwTieneProceso = 0;
          |ACABA;
     |FINSI;

     enCodPrimeraInc = 0;
     eaPrimeraInc = "";
     enSwAvisaInte = 0;
     eaProcesoPIInte = aProcesoPI;
     enResultadoInte = 0;
     efFechaInte = #dsarm034#0;
     eaHoraInte = #dsarm034#1;
     eaFicInte = #dsarm034#2;
     enCodIncidencia = 0;
     eaIncidencia = "";

     |HAZ IntegridaddsEscan;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;

     |SI #dsarm034#9  = "N";   |ACABA;  |FINSI;
     |SI #dsarm034#18 = 0;     |ACABA;  |FINSI;

     |SI aProcesoPI = "FR000000";
          nCuenta = nCuenta + 1;
     |FINSI;
|FPRC;

|PROCESO Validar;
     |VENTANA 0510, 1080, -1, 16, "Realizando trabajo";
     nVentTrab = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802; |PAUSA;

     |CONTROL_SIMPLE 0, "LABEL,{{14}}Realizando trabajo", 0720, 0879, NULL;

     nProcesados = 0;

     nCuenta = 0;
     nSwProcesa = 0;

     |ABRE #dsarm034;
     #dsarm034#0 = "01.01.0000";
     #dsarm034#1 = "";
     #dsarm034#2 = "";
     |LEE 000#dsarm034.];
     |PARA; |SI FSalida = 0; |HACIENDO;
          fFechaBucle = #dsarm034#0;
          aHoraBucle  = #dsarm034#1;
          aNomBucle   = #dsarm034#2;

          |HAZ dsarm034C;

          |DDEFECTO #dsarm034;
          #dsarm034#0 = fFechaBucle;
          #dsarm034#1 = aHoraBucle;
          #dsarm034#2 = aNomBucle;
          |LEE 000#dsarm034.>;
     |SIGUE;

     |SI nCuenta = 0;
          aMensaje = "0000No hay nada que procesar";
          |MENAV aMensaje;
          nSwProcesa = 0;
     |SINO;
          |SI nCuenta = 1;
               aMensaje = "0000NProcesar 1 documento pendiente?";
               |CONFI aMensaje;
               |SI FSalida = 0;
                    nSwProcesa = 1;
               |FINSI;
          |SINO;
               aMensaje = "0000NProcesar " + nCuenta + " documentos pendientes?";
               |CONFI aMensaje;
               |SI FSalida = 0;
                    nSwProcesa = 1;
               |FINSI;
          |FINSI;
     |FINSI;

     |CIERRA #dsarm034;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentTrab;

     |SI nSwProcesa = 0;  |ACABA;  |FINSI;

     |VENTANA 0510, 1080, -1, 16, "Realizando trabajo";
     nVentTrab = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PTEC 802; |PAUSA;

     |CONTROL_SIMPLE 0, "LABEL,{{14}}Realizando trabajo", 0720, 0879, NULL;

     |ABRE #dsarm034;

     #dsarm034#0 = "01.01.0000";
     #dsarm034#1 = "";
     #dsarm034#2 = "";
     |LEE 000#dsarm034.];
     |PARA; |SI FSalida = 0; |HACIENDO;
            fFechaBucle = #dsarm034#0;
            aHoraBucle  = #dsarm034#1;
            aNomBucle   = #dsarm034#2;

            |HAZ Procesar;

            |DDEFECTO #dsarm034;
            #dsarm034#0 = fFechaBucle;
            #dsarm034#1 = aHoraBucle;
            #dsarm034#2 = aNomBucle;
            |LEE 000#dsarm034.>;
     |SIGUE;
     |CIERRA #dsarm034;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentTrab;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentTrab;

     |SI nProcesados = 0;
          aMensaje = "0000No se ha procesado ningun documento.";
          |MENAV aMensaje;
     |SINO;
          |SI nProcesados = 1;
               aMensaje = "0000Procesado 1 documento.";
               |MENAV aMensaje;
          |SINO;
               aMensaje = "0000Procesados " + nProcesados + " documentos.";
               |MENAV aMensaje;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO QueProcesoPI;
     eaQueProcesoPI = "FR000000";
     eaFicInte      = PARAMETRO - "DSPARTES";  |QBF eaFicInte;
     aRespuestaOCR  = "C:\DOCUMENTOS\DSARCHI\OCR\000000\" + eaFicInte;
     |XABRE "CU", aRespuestaOCR, nHandle;
     |SI FSalida ] 0;
          |PARA; |SI; |HACIENDO;
               |XLEE nHandle, 250, aAlfa;
               |SI FSalida < 0;  |SAL;  |FINSI;

               aAlfa = aAlfa - "MD000000";
               |SI FSalida ! 0;
                   eaQueProcesoPI = "MD000000";
               |FINSI;
          |SIGUE;
     |FINSI;

     |XCIERRA nHandle;
|FPRC;

|PROCESO DesdeDSPARTES;
     |HAZ QueProcesoPI;
     |SI eaQueProcesoPI = "MD000000";
         aAlfa = "dsarz001;" + PARAMETRO;
         |SUB_EJECUTA aAlfa;
         |ACABA;
     |FINSI;

     eaQueProcesoPI    = "";
     enSwReintentarOCR = 1;
     aAlfa = "dsarz013;" + PARAMETRO;
     |SUB_EJECUTA aAlfa;

     enSwReintentarOCR = 0;

     eaFicInte   = PARAMETRO - "DSPARTES";  |QBF eaFicInte;
     eaFicInte   = eaFicInte - ".txt";
     efFechaInte = efFechaOCR;
     eaHoraInte  = eaHoraOCR;

     aAlfa       = ("p1" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #dsarm034#aAlfa#;

     aAlfa       = ("p2" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #dsarm035#aAlfa#;

     |ABRE #dsarm034;
     |ABRE #dsarm035;

     |VENTANA 0501, 3099, -1, 16, "Variables dsEscan";
     nVentz68 = FSalida;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz68;
     aVent5 = "MODAL";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |PINPA #0#dsarw068;
     nPanta68 = FSalida;

     nRango = 2 + 4 + 8 + 16 + 32 + 128;

     |LINEAL_SIMPLE #1#dsarm035, nRango, 0502, 3098, NULL, NULL, NULL;
     nGrid68   = FSalida;
     |FOCOTECLADO nGrid68;

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
         FSalida = "::Salir," + nGrid68;
         |LEETECLA aTecla;
         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
         |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;

     |CIERRA #dsarm034;
     |CIERRA #dsarm035;

     |DESTRUYECONTROL nGrid68;

     |PULSATECLA;

     aVent1 = -1;
     aVent2 = -1;
     aVent3 = 0;
     aVent4 = nVentz68;
     aVent5 = "MODELESS";
     |ESPECIFICA "ESTADO_VENTANA", aVent;

     |FINVENTANA nVentz68;

     |DELINDEX #dsarm034;
     |DELINDEX #dsarm035;
|FPRC;

|PROCESO CtrlCache;
     ||Ahora controlamos si borramos o no la cache.
     |SI #dsarm001#181 = "S";
          |QBF aBorraCache;
          |SI aBorraCache ! "";
               |RFBORRA aBorraCache;
               aBorraCache = "";
          |FINSI;
     |FINSI;
|FPRC;

|PROGRAMA;
     aVacio20 = " " * 20;
     aZeta20 = "z" * 20;

     aIni = "";
     |HAZ AveriguaINI;
     |SI aIni = ""; |O aIni = "000000";
          aMensaje = "0000Problemas al obtener el número INI [" + aIni + "]";
          |MENAV aMensaje;
          |ACABA;
     |FINSI;

     |ABRE #dsarm001;
     |LEE 000#dsarm001.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarm001;  |FINSI;
     |CIERRA #dsarm001;

     aVacio25           = (" " * 25);
     aZeta25            = ("z" * 25);
     enSwModoIntegridad = 1;
     enPantallaFR000000 = -1;
     enBotonProv        = -1;

     |ABRE #dsarm000;
     #dsarm000#0 = Usuario % 810;
     |LEE 000#dsarm000.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsarm000;
     |FINSI;
     |CIERRA #dsarm000;

     aAlfa = PARAMETRO - "VERDOC";
     |SI FSalida ! 0;
         |ABRE #dsarm034;
         |SELECT #2#dsarm034;
         #dsarm034#16 = aAlfa;
         |LEE 000#dsarm034.=;
         |SI FSalida = 0;
             |HAZ Boton7;
         |FINSI;
         |CIERRA #dsarm034;

         |ACABA;
     |FINSI;

     aAlfa = PARAMETRO - "DSPARTES";
     |SI FSalida ! 0;
         |HAZ DesdeDSPARTES;
         |ACABA;
     |FINSI;

     |ABRET #dsarz041;

     fFecha     = ~;

     aTipoArbol = #dsarm000#13;   |QBF aTipoArbol;
     aDFecha    = #dsarm000#14;
     aTipoFecha = #dsarm000#15;
     aQueUsu    = #dsarm000#16;   |QBF aQueUsu;
     aHFecha    = fFecha;
     aTipoEstado = #dsarm000#18;   |QBF aTipoEstado;
     |SI aTipoEstado = "N";
          aDTipo = "N";
          aHTipo = "N";
     |SINO;
          |SI aTipoEstado = "S";
               aDTipo = "S";
               aHTipo = "S";
          |SINO;
               aDTipo = " ";
               aHTipo = "z";
          |FINSI;
     |FINSI;

     |HAZ CalculaParametros;

     aParametro = PARAMETRO;

     |SI aParametro = "REINTENTAR";
         |HAZ ReintentarPlantilla;
         |ACABA;
     |FINSI;

     |SI aParametro = "VALIDAR";
         |ABRET #dsarm035;
         |HAZ Validar;
         |CIERRAT #dsarm035;
         |ACABA;
     |FINSI;

     |ABRET #dsarm035;

     |ABRE #dsarm034;
     |LEE 000#dsarm034.p;

     |PINPA #0#dsarz038;  nPanta0 = FSalida;

     nGrid0 = -1;
     |SI aQueUsu = "";
         |HAZ LinealSinLimite;
     |FINSI;

     |SI aQueUsu ! "";
         |HAZ LinealPorUsuario;
     |FINSI;

     |HAZ BotonesPanta0;

     |LEE 000#dsarm034.u;
     |SI #dsarm000#12 = "A";
          |HAZ Arbol;
     |FINSI;

     |LEE 000#dsarm034.u;
     |HAZ EventoGrid0;
     |REFRESCACONTROL nGrid0;

     aEsc1  = &255 + "806";
     aEsc2  = &255 + "807";
     aRetu  = &255 + "802";
     |PARA; |SI;  |HACIENDO;
         |SI #dsarm000#12 = "L";  FSalida = "::Salir," + nGrid0;  |FINSI;
         |SI #dsarm000#12 = "A";  FSalida = "::Salir," + nTree;   |FINSI;

         |LEETECLA aTecla;

         |SI aTecla = aEsc1; |SAL;  |FINSI;
         |SI aTecla = aEsc2; |SAL;  |FINSI;
         |SI aTecla = aRetu; |SAL;  |FINSI;
     |SIGUE;

     |FIN_CONTROL_WINDOWS nBoton1;
     |FIN_CONTROL_WINDOWS nBoton3;
     |FIN_CONTROL_WINDOWS nBoton6;
     |FIN_CONTROL_WINDOWS nBoton11;
     |FIN_CONTROL_WINDOWS nBoton13;
     |FIN_CONTROL_WINDOWS nBoton14;
     |FIN_CONTROL_WINDOWS nBoton4;
     |FIN_CONTROL_WINDOWS nBoton12;
     |FIN_CONTROL_WINDOWS nBoton16;

     |DESTRUYECONTROL nGrid0;

     |PULSATECLA;

     |CIERRA #dsarm034;
     |CIERRAT #dsarm035;
     |CIERRAT #dsarz041;

     |ABRE #dsarm000;
     #dsarm000#0 = Usuario % 810;
     |LEE 101#dsarm000.=;
     |SI FSalida ! 0;
         |DDEFECTO #dsarm000;
         #dsarm000#0 = Usuario % 810;
         |GRABA 020#dsarm000.b;
     |FINSI;

     |SI nBotonLineal ! -1;  #dsarm000#12 = "A";  |FINSI;
     |SI nBotonArbol  ! -1;  #dsarm000#12 = "L";  |FINSI;

     #dsarm000#13 = aTipoArbol;
     #dsarm000#14 = aDFecha;
     #dsarm000#15 = aTipoFecha;
     #dsarm000#16 = aQueUsu;
     #dsarm000#18 = aTipoEstado;

     |GRABA 020#dsarm000.a;
     |LIBERA #dsarm000;
     |CIERRA #dsarm000;

     |SI nSwCargaDefGrid = 1;
          |CIERRA #gridref@;
          |DELINDEX #gridref@;
          |DESCARGA_DEF #gridref@;
     |FINSI;

     |HAZ CtrlCache;
|FPRO;

|PROCESO Tipo80;  |TIPO 80;
     aAlfa = PARAMETRO - "VERDOC";
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     FSalida = 3299;
|FPRC;

|PROCESO Tipo90;  |TIPO 90;
     |DBASE aAlfa;   |QBF aAlfa;
     aAlfa = aAlfa + "ocr/";
     aAlfa = aAlfa + "Envio" + Usuario + ".txt";
     |XABRE "E", aAlfa, 0;
     |SI FSalida ] 0;
         |SUB_EJECUTA "dsarw010;ENVIAAVISODIAGRAM";
     |FINSI;
|FPRC;
