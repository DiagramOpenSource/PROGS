||Autoplantillas --> AplicaPlantillasOCR

||Filtro de Seleccion G/S/T segun el documentos: FiltroPlantillas

||Ahora incluso antes de saber el G/S/T (si eaAutoSelPlantilla = "S"),
||realizare el OCR, y intentare averiguar a que G/S/T pertenece.
||Se ejecuta desde el asistente automatico.


||Ahora tengo que ejecutar el OCR, antes de que este creado el registro en
||el dsarm005, por eso le paso la informacion que necesita en el
||registro "cero". (dsarm031)
||Tendra este formato.
||001 001 003 /extra/FACTURAE/FACTURAE/FACTURAS/ESOTRES/|000000376.PDF

||Vamos a cambiar de motor de escaneo y el sistema de las plantillas.
||dsescan_cli.exe
||GrabaResultadoOCR

||SacaDatosRespuesta. Nos devuelve la informacion del resultado OCR. (dsEscan)

|FICHEROS;
     dsarz013;

     dsarm001;
     dsarm004;
     dsarm005;
     dsarm029;
     dsarm030;
     dsarm031;
     dsarm034;
     dsarm035,MANTE;
     dsarm036;
     dsarm041;
     dsarm058;
     dsarm053;

     dsarw010;

     dsarw013;
     dsarw019;

     Referen@;
     ficontab@;
|FIN;

|VARIABLES;
     ||Importacion albaranes venta. DSERP/DSCOMER9/DSARCHI
     &enNumDSerpAV = 0;
     &eaPathFichero = "";
     &enSwEstaAV = 0;
     &eaSerieAV = "";
     &enNumeroAV = 0;
     &enEmpresaAV = 0;
     nSwFoundSer = 0;
     nSwFoundNum = 0;
     nSwFoundEmp = 0;
     aSerieOCR = "";
     aNumeroOCR = "";
     aEmpresaOCR = "";
     aLetras = "";


     ||BANDEJADSESCANMANUAL
     &efFechaBandeja = @;
     &eaHoraBandeja = "";
     &eaNombreBandeja = "";
     aFicheroBja = "";
     aParametro = "";
     &enGrupoPV = 0;
     &enSubGrupoPV = 0;
     &enTipoPV = 0;


     aAuxFiltro = "";
     &eaDocCaptura = "";
     nSwHayPlantilla = 0;
     nTodosEncon = 0;
     aUltimaLetra = "";
     nNumAux = 0;
     &eaImpoAlbaVta = "";
     &eaAutoSelPlantilla = "";
     &eaUbicacionTempo = "";
     &eaNomFichero = "";
     nPrimerError = 0;
     nSwHayFiltro = 0;
     &enGrupoFiltro = 0;
     &enSubGrupoFiltro = 0;
     &enTipoFiltro = 0;

     aAuxAux = "";
     aNombreFichero = "";
     nSwEstaDsEscan = 0;
     &enSwReintentarOCR = 0;

     ||Modo silencio
     &enSwModoSilencio = 0;
     &eaErrorDsEscan = "";
     &enNumRegDsEscan = 0;
     nSwHayErrorSil = 0;
     aSwLanzaDsEscan = "";
     nHandleE = 0;
     nHandleEnv = 0;
     aNumeroDoc = "";
     aPathLog = "";

     ||NIF/CIF
     &eaVarDni = "";
     &enCalcCif = 0;
     &enModoSilencio = 0;
     &enHayErrorDni = 0;

     aConvierteLog = "";
     aConvierteErr = "";
     aDestinoFin = "";
     nContaReal = 0;
     ||dsenviacorreo
     &eaAdjuntoPLB = "";
     &eaServidorSMTP = "";
     &eaUsuarioPLB = "";
     &eaPassPLB = "";
     &eaOrigenPLB = "";
     &eaDestinoPLB = "";
     &eaDirRespoPLB = "";
     &eaAsuntoPLB = "";
     &eaCuerpoPLB = "";
     &eaConfLecPLB = "";
     &enSwErrorCorreoPLB = 0;
     &eaBorraCache1 = "";
     &eaBorraCache2 = "";
     aCuerpo = "";
     nHandleC = 0;
     aTextoMe = "";

     nCaracteres = 0;
     nGuiones = 0;

     aValorEntrada = "";
     aValorFecha = "";
     aValorMin = "";
     nSwMesLetra = 0;
     aAntes = "";
     aDespues = "";
     aVerifica = "";
     aAnyo = "";
     nSalto = 0;
     nDia = 0;
     nMes = 0;
     nAnyo = 0;
     nFecha = 0;
     fFechaDespues = @;
     fFechaFac = @;


     nVoyCtrlTipo = 0;
     aCtrlTipo = "";

     aBorraCache = "";
     aBorraCache2 = "";
     aBaseUnix = "";
     aBaseAux = "";
     aFicDestinoTif = "";
     aFicOrigen = "";
     aFicDestino = "";
     aNomDoc = "";

     aSistema = "";
     nSwPdf2TifUnix = 0;

     aEjecuta = "";
     &enVoyPorDoc = 0;
     &enNumTotalDocs = 0;

     &eaDSMAC = "";

     &enSwRealizadodsEscan = 0;
     aEmailDestino = "";
     aIPLocal = "";
     aQueSistema = "";
     nGuarda = 0;
     &eaPrograma = "";
     nSwSMTPCLI = 0;
     nSwDsEnviaCorreo = 0;
     nVent1 = 0;
     nVentana = 0;
     aIP = "";
     aFrom = "";
     aSalida = "";
     aTo = "";
     aAsunto = "";
     &eaAlfa = "";
     aAdjunto = "";
     aAutenti = "";
     nDecimales = 0;

     &enAprobacion = 0;
     &enErrorCorreo = 0;
     &enDocumento = 0;

     {1}aLocal       = "";
     aBaseLocal = "";
     aVersion1 = "";
     aVersion2 = "";
     aAlfa1 = "";
     aAlfa2 = "";

     aPathAdj2 = "";
     aDestinoTgz = "";
     aNomTgz = "";
     aDirectorio = "";
     aNomSin = "";
     aFicTar = "";
     aBorra = "";
     nSwTgzOk = 0;
     direc = "";

     nSwEnvioCorreo = 0;
     aAlfaAux = "";
     &enCodPrimeraInc = 0;
     &eaPrimeraInc = "";
     &enSwAvisaInte = 0;
     &eaProcesoPIInte = "";
     &enResultadoInte = 0;
     &efFechaInte = @;
     &eaHoraInte = "";
     &eaFicInte = "";
     &enCodIncidencia = 0;
     &eaIncidencia = "";
     aIntegridadOK = "";

     fFechaOCR = @;
     aHoraOCR = "";
     aFicOCR = "";

     aAbreBat = "";
     aAbreShell = "";
     aBarra    = "";
     aAuxBarra = "";

     nNume           = 0;
     nSaca           = 0;
     nOcrExterno     = 0;

     nSwErrorOCRLog = 0;
     aCodPlantilla = "";
     aDesPlantilla = "";
     aProcesoPI = "";
     nHandleLog = 0;
     aLetraIni = "";
     aLetraFin = "";
     aLineaLog = "";
     aNueveFinal = "";
     aCincoFinal = "";
     nParteOCR = 0;
     nParteVAR = 0;
     nParteLOG = 0;
     nParteNVAL = 0;
     aAlfaLog = "";

     aTab1 = "";
     aTab2 = "";
     aTab3 = "";
     aTab4 = "";
     aSaca = "";
     aSaca2 = "";
     aLetra2 = "";
     nContador = 0;
     aTextAux = "";

     &eaCarpetaOrigen = "";   ||Indica la carpeta del PC que se archiva.

     aDirBaseResOCR = "";     ||Directorio base donde nos devuelve la respuesta el dsescan_cli
     aNomResOCR = "";         ||Nombre del fichero respuesta del dsescan_cli.
     aRespuestaOCR = "";       ||Path completo al fichero respuesta del dsescan_cli
     nTimeOut = 0;

     {-1}aSerie = "";
     nIni = 0;
     aIni = "";
     aParamIni = "";
     aIPServOCR = "";
     nPuerto = 0;

     aNomFichero = "";

     aUsuario = "";
     aPathBase = "";
     Handle1 = 0 ;
     aNif = "";
     aNombreNif = "";
     aBarra1 = "";
     aBarra2 = "";
     aDia = "";
     aMes = "";
     aAny = "";
     aFechaBuena = "";
     fFechaBuena = @;
     nFechaBuena = 0;
     fFechaOtra = @;

     nSwReturn = 0;
     aAcumula = "";
     aTab = "";
     a10 = "";
     a13 = "";
     nLongBueno = 0;
     nSwHayEncabezado = 0;
     aTextoParcial = "";
     nLongParcial = 0;

     aFicheroOCR = "";
     nSwFound = 0;
     aValor = "";
     nVoy = 0;
     aBusca = "";
     aBusca2 = "";
     aBusca3 = "";
     nLetras = 0;
     nCampoDestino = 0;
     aTextoEncabezado = "";
     aSwEncabezado = "";

     aResultado = "";
     fFecha = @;
     aFecha = "";
     aHora = "";
     nRegistro = 0;
     nUltimo = 0;

     nSwAplicaPlantilla = 0;       ||Tengo que aplicar la plantilla OCR.
                                   ||se aplica antes de que exista el registro en dsarm005.
                                   ||se apoya en el dsarm030 y dsarm031.
     nSwPrimeraParte = 0;
     aLong = "";
     nLong = 0;
     nConta = 0;
     nCampo = 0;
     aLetra = "";
     aDatosCinco = "";
     aGrupoCinco = "";
     nGrupoCinco = 0;
     aSubGrupoCinco = "";
     nSubGrupoCinco = 0;
     aTipoCinco = "";
     nTipoCinco = 0;
     aResto = "";
     aPathCinco = "";
     aNombreCinco = "";
     aSeparador = "|";

     nSwErrorOCR = 0;
     aErrorOCR = "";
     aLogOCR = "";
     aMensaje = "";
     nHandleOCR = 0;
     aLinea = "";
     aAux = "";

     aDestinoDos = "";

     aTipoDoc = "";
     nError           = 0;
     nHandle          = 0;
     nPon             = 0;
     nParam           = 0;
     nParam1          = 0;
     nParam2          = 0;
     nParam3          = 0;
     nErrorIdentify   = 0;

     aParam1          = "";
     aParam2          = "";
     aParam3          = "";
     aAlfa            = "";
     aBase            = "";
     aDirBaseServidor = "";
     aDirBaseLocal    = "";
     aOrigen          = "";
     aDestino         = "";
     aIPRemoto        = "";
     aDocOrigen       = "";
     aDocDestino      = "";
     aFichero         = "";
     aAuxExtension    = "";
     aExtension       = "";
     aIdentify        = "";
     aAbre            = "";
     aHoraEnv         = "";
     aTipo            = "";
     aBaseConta       = "";
     aDirDatos        = "";
     aDirDatEmp       = "";
     aDef             = "";

     {1}aContiene     = "";

     &enSwDesde9      = 0;
     &eaUnidad        = "";
     &enError         = 0;
     &enSoyDESPANET   = 0;
     &efFechaOCR      = @;
     &eaHoraOCR       = "";
     &enRecupera      = 0;
     &enMensaOCX      = 0;
     &enSwADConta     = 0;
     &eaUsuArchivado  = "";

     aTextoLog        = "";
     nNoSeEscanea     = 0;
     nNoPasaOCR       = 0;
     nRecogeRes       = 0;
     nPasaIdenty      = 0;

     &enSwNomina      = 0;
     &eaQueProcesoPI  = "";
     &enEmpresa       = 0;
     &eaTipo          = "";
     &eaNif           = "";
|FIN;

|PROCESO Tipo7C4_m035;
|FPRC;

|PROCESO Tipo0C4_m035;
|FPRC;

|PROCESO GrabaResultadoOCR;
     |SI #dsarm004#87 = "N";       ||No se graba en el Panel dsEscan
          |ACABA;
     |FINSI;

     |ABRE #dsarm034;
     |DDEFECTO #dsarm034;
     #dsarm034#0 = fFechaOCR;
     #dsarm034#1 = aHoraOCR;
     #dsarm034#2 = aFicOCR;
     |LEE 101#dsarm034.=;
     |SI FSalida ! 0;
         |HAZ CogeMac;
         #dsarm034#20 = eaDSMAC;

         |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
         #dsarm034#4 = aIPRemoto;
         aUsuario = Usuario % 810;

         #dsarm034#6 = eaUsuArchivado;
         |SI eaUsuArchivado = "";
             #dsarm034#6 = aUsuario;
         |FINSI;

         #dsarm034#5 = eaCarpetaOrigen;
         |QBF eaCarpetaOrigen;

         #dsarm034#16 = #dsarm005#0;

         |GRABA 020#dsarm034.b;

         aHoraEnv = "";
     |FINSI;

     |QBF aCodPlantilla;
     |SI aCodPlantilla = "";
          #dsarm034#7 = 0;

          |SI aErrorOCR = " Error no existe plantilla asociada a la imagen";
              #dsarm034#8  = "<Desconocida>";
              #dsarm034#15 = "110,110,110;255,255,255";
          |SINO;
              nParteNVAL = 1;
          |FINSI;

          |SI nParteNVAL = 1;
              #dsarm034#8  = "<No v lida>";
              #dsarm034#15 = "215,120,210;255,255,255";
              #dsarm034#9  = "I";
              #dsarm034#10 = "I";
          |FINSI;

          |SI nRecogeRes = 1;
              #dsarm034#8  = "<Desconocida>";
              #dsarm034#15 = "110,110,110;255,255,255";
              #dsarm034#9  = "N";
              #dsarm034#10 = "N";
          |FINSI;

          |SI aProcesoPI = "";
              aProcesoPI   = #dsarm041#2;
          |FINSI;
     |SINO;
          #dsarm034#7 = aCodPlantilla;
          #dsarm034#8 = aDesPlantilla;

          enRecupera = enRecupera + 1;
     |FINSI;

     #dsarm034#17 = aProcesoPI;

     |SI nDecimales = 0;
          nDecimales = 2;
     |FINSI;
     #dsarm034#21 = nDecimales;

     |GRABA 020#dsarm034.a;
     |LIBERA #dsarm034;

     |CIERRA #dsarm034;
|FPRC;

|PROCESO SacaTabs;
     ||Devuelve en aTabX, el valor del campo separado por tabuladores.

     nContador = 0;
     aTab1    = "";
     aTab2    = "";
     aTab3    = "";
     aTab4    = "";
     aTextAux = "";
     aLong = aLineaLog % A0;
     nLong = aLong;

     |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
          aSaca = nVoy + "01";
          aLetra = aLineaLog % aSaca;
          |SI aLetra = aTab; |O aLetra = a10; |O aLetra = a13;
               nContador = nContador + 1;
               |SI nContador = 1;
                    aTab1 = aTextAux;
               |FINSI;
               |SI nContador = 2;
                    aTab2 = aTextAux;
               |FINSI;
               |SI nContador = 3;
                    aTab3 = aTextAux;
               |FINSI;
               |SI nContador = 4;
                    aTab4 = aTextAux;
               |FINSI;
               aTextAux = "";
          |SINO;
               aTextAux = aTextAux + aLetra;
          |FINSI;
     |SIGUE;

     |SI nContador = 1;
          aTab2 = aTextAux;
     |FINSI;
     |SI nContador = 2;
          aTab3 = aTextAux;
     |FINSI;
     |SI nContador = 3;
          aTab4 = aTextAux;
     |FINSI;

     nContador = 0;
|FPRC;

|PROCESO TrataRegistro;
     |SI FSalida = 0;  |ACABA;  |FINSI;

     |QBF aLineaLog;

     |SI aLineaLog = "IMAGEN NO VALIDA";
         nParteNVAL     = 1;
         nSwErrorOCRLog = 1;
         aErrorOCR      = "El documento ha sido marcado como no v lido. Pinche en ";
         aErrorOCR      = aErrorOCR + &34 + "Ver texto dsEscan" + &34 + " para ver el motivo";
         |ACABA;
     |FINSI;

     |SI aLineaLog = " Error no se puede procesar este tipo de fichero.";
         nParteNVAL     = 1;
         nSwErrorOCRLog = 1;
         aErrorOCR      = "El documento ha sido marcado como no v lido. Pinche en ";
         aErrorOCR      = aErrorOCR + &34 + "Ver texto dsEscan" + &34 + " para ver el motivo";
         |ACABA;
     |FINSI;

     |SI nParteNVAL = 1;
         |ACABA;
     |FINSI;

     aLetraIni = aLineaLog % 101;
     aLetraFin = aLineaLog % -101;
     |SI aLetraIni = "["; |Y aLetraFin = "]";
         aCincoFinal = aLineaLog % -105;
         aNueveFinal = aLineaLog % -109;
         |SI aNueveFinal = "_ocr.txt]";
             nParteOCR = 1;
             nParteVAR = 0;
             nParteLOG = 0;
         |SINO;
             |SI aNueveFinal = "_var.txt]";  |O aCincoFinal = "_var]";
                 nParteOCR = 0;
                 nParteVAR = 1;
                 nParteLOG = 0;
             |SINO;
                 |SI aNueveFinal = "_log.txt]";
                     nParteOCR = 0;
                     nParteVAR = 0;
                     nParteLOG = 1;
                 |FINSI;
             |FINSI;
         |FINSI;
     |SINO;
         |SI aLetraIni = "[";
             aAlfaLog = aLineaLog % 111;
             |SI aAlfaLog = "[PLANTILLA]";
                 |HAZ SacaTabs;

                  aCodPlantilla = aTab2;   |QBF aCodPlantilla;
                  aDesPlantilla = aTab3;   |QBF aDesPlantilla;

                                   nDecimales = aTab4;
                  |SI aTab4 = "";  nDecimales = 2;  |FINSI;
                  |SI nDecimales = 0;
                       nDecimales = 2;
                  |FINSI;
             |FINSI;

             |SI aAlfaLog = "[PROCESOPI]";
                 |HAZ SacaTabs;

                 aProcesoPI = aTab2 % 108;  |QBF aProcesoPI;
             |FINSI;
         |FINSI;

         ||Procesa las lineas, segun el tipo.
         |SI nParteOCR = 1;
             ||Por ahora NADA.
         |FINSI;

         |SI nParteVAR = 1;
             aAlfaLog = aLineaLog % 111;
             |SI aAlfaLog ! "[PLANTILLA]"; |Y aAlfaLog ! "[PROCESOPI]";
                 |HAZ SacaTabs;
                 |SI aTab1 ! ""; |Y aTab2 ! "";
                     |SI aTab1 = "FR000000_iva1";
                      |O aTab1 = "FR000000_iva2";
                      |O aTab1 = "FR000000_iva3";
                      |O aTab1 = "FR000000_iva4";
                      |O aTab1 = "FR000000_iva5";
                         aTab2 = aTab2 - "%";
                         |QBF aTab2;
                     |FINSI;

                     |SI aTab1 = "FE000000_iva1";
                      |O aTab1 = "FE000000_iva2";
                      |O aTab1 = "FE000000_iva3";
                      |O aTab1 = "FE000000_iva4";
                      |O aTab1 = "FE000000_iva5";
                         aTab2 = aTab2 - "%";
                         |QBF aTab2;
                     |FINSI;

                     #dsarm035#0 = fFechaOCR;
                     #dsarm035#1 = aHoraOCR;
                     #dsarm035#2 = aFicOCR;
                     #dsarm035#3 = aTab1;
                     |LEE 101#dsarm035.=;
                     |SI FSalida ! 0;
                         |DDEFECTO #dsarm035;
                         #dsarm035#0 = fFechaOCR;
                         #dsarm035#1 = aHoraOCR;
                         #dsarm035#2 = aFicOCR;
                         #dsarm035#3 = aTab1;
                         |GRABA 020#dsarm035.b;
                     |FINSI;

                     aAux = aTab1;
                     |QBF aAux;
                     aAux = aAux % 1010;
                     |SI aAux = "cuotareten";
                         nNumAux = aTab2;
                         |SI nNumAux < 0;
                              nNumAux = nNumAux * -1;
                              aTab2 = nNumAux;
                         |FINSI;
                     |FINSI;

                     #dsarm035#4 = aTab2;

                     |ABRE #dsarm036;
                     |DDEFECTO #dsarm036;
                     #dsarm036#0 = aProcesoPI;
                     #dsarm036#1 = #dsarm035#3;
                     |LEE 000#dsarm036.=;
                     |SI FSalida = 0;
                         #dsarm035#10 = #dsarm036#9;
                     |FINSI;
                     |CIERRA #dsarm036;

                     |GRABA 020#dsarm035.a;
                     |LIBERA #dsarm035;
                 |FINSI;
             |FINSI;
         |FINSI;

         |SI nParteLOG = 1;
             aAlfaLog = aLineaLog % 106;
             |SI aAlfaLog = "Error "; |O aAlfaLog = " Error";
                  nSwErrorOCRLog = 1;
                  aErrorOCR = aLineaLog;
             |FINSI;
         |FINSI;
     |FINSI;
|FPRC;

|PROCESO SacaDatosRespuesta;
     aNueveFinal    = "";
     aCincoFinal    = "";
     nSwErrorOCRLog = 0;
     aErrorOCR      = "";
     aCodPlantilla  = "";
     aDesPlantilla  = "";
     aProcesoPI     = "";
     nParteOCR      = 0;
     nParteVAR      = 0;
     nParteLOG      = 0;
     nParteNVAL     = 0;

     |XABRE "CU", aRespuestaOCR, nHandleLog;
     |SI FSalida ] 0;
          |PARA; |SI; |HACIENDO;
               |XLEE nHandleLog, 250, aLineaLog;
               |SI FSalida < 0;  |SAL;  |FINSI;

               |HAZ TrataRegistro;
          |SIGUE;
     |FINSI;

     |XCIERRA nHandleLog;
|FPRC;

|PROCESO CorreoEnUnix;
     aAlfa = #dsarw010#18;  |QBF aAlfa;
     |SI aAlfa ! aIPRemoto;  |ACABA;  |FINSI;

     |ESPECIFICA "RBASS", aLocal;
     aBaseLocal = aLocal;

     aDestino   = aBaseLocal + "bin/dscorreo.exe";
     aContiene1 = aDestino;
     |ESPECIFICA "REMOTOMD5", aContiene;
     aVersion1  = FSalida;  |QBF aVersion1;

     |DBASE aBase;  |QBF aBase;
     aOrigen    = aBase + "dlls/dscorreo.exe";
     aContiene1 = aOrigen;
     |ESPECIFICA "MD5", aContiene;
     aVersion2  = FSalida;  |QBF aVersion2;

     |SI aVersion1 ! aVersion2;
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aAlfa  = "cmd " + &34 + "/c START /MIN " + aDestino + &34;
     |RSYSTEM aAlfa;

     |MENSA "         ";
     |PULSATECLA;
     |SLEEP 1;
|FPRC;

|PROCESO CorreoEnDos;
     |SI aIPRemoto ! "";  |ACABA;  |FINSI;

     |IP_LOCAL aIPLocal;
     |QBF aIPLocal;

     aAlfa = #dsarw010#18;  |QBF aAlfa;
     |SI aAlfa ! aIPLocal;  |ACABA;  |FINSI;

     |DBASE aBase;  |QBF aBase;
     aOrigen    = aBase + "dlls/dscorreo.exe";

     aAlfa  = "cmd " + &34 + "/c START /MIN " + aOrigen + &34;
     |SYSTEM aAlfa;

     |MENSA "         ";
     |PULSATECLA;
     |SLEEP 1;
|FPRC;

|PROCESO CargaTexto;
     ||ARA22
|FPRC;

|PROCESO BorraDir;          ||Borra todos los archivos de aDirectorio
     direc = ""; |DIRECTORIO direc; |QBF direc;
     |SI aDirectorio ! "/";
          aAlfa1 = direc + "bin/agirm -r " + aDirectorio;
          |SYSTEM aAlfa1;
     |FINSI;
|FPRC;

|PROCESO QuitaBarras;
     aAuxBarra = "";
     |QBF aBase;
     aLong = aBase % A0;
     nLong = aLong;
     |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
          nSaca = (nVoy * 100) + 1;
          aLetra = aBase % nSaca;
          |SI aLetra = "/";  |O aLetra = "\";
               aLetra = "_";
          |FINSI;
          aAuxBarra = aAuxBarra + aLetra;

          |SI aLetra = ":";
              aAuxBarra = "";
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO QuitaNombre;
     aAuxExtension = "";
     |QBF aAlfa;
     aLong = aAlfa % A0;
     nLong = aLong;
     nPon  = 0;
     |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
          nSaca  = (nVoy * 100) + 1;
          aLetra = aAlfa % nSaca;
          |SI aLetra = ".";
              nPon = 1;
          |FINSI;

          |SI nPon = 1;
              aAuxExtension = aAuxExtension + aLetra;
          |FINSI;
     |SIGUE;
|FPRC;

/*
     ||Hay tres formas de enviar el correo. (Tenemos ejemplo en dsarw010)
     || 1. Estandard. dscorreo
     || 2. Usando SMTPCLI. (solo unix).  Seguro que no lo vamos a utilizar.
     || 3. Usando dsenviacorreo.exe.    (LO PONEMOS).
*/

|PROCESO TgzOCR;
     aNomTgz     = "tgz" + Usuario;                     |QBF aNomTgz
     |DBASE aBase;  |QBF aBase;
     aDestinoTgz = aBase + "correos";                   |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/" + aNomTgz;         |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/";

     aDirectorio = aDestinoTgz;
     |HAZ BorraDir;

     aNomTgz     = "tgz" + Usuario;                     |QBF aNomTgz
     |DBASE aBase;  |QBF aBase;
     aDestinoTgz = aBase + "correos";                   |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/" + aNomTgz;         |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/";

     |HAZ QuitaBarras;

     aNomFichero = aIni + aAuxBarra + (("000000000" + #dsarm005#0) % -109);

     aAbre = aDestinoTgz + aNomFichero + ".txt";
     |XABRE "WB", aAbre, nHandleEnv;

     aAlfa = #dsarm005#14;  |QBF aAlfa;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandleEnv, aAlfa;

     aAlfa = #dsarm005#10;  |QBF aAlfa;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandleEnv, aAlfa;

     |SI #dsarm004#91 = 1; aAlfa = "Recibida";  |FINSI;
     |SI #dsarm004#91 = 2; aAlfa = "Emitida";   |FINSI;
     aAlfa = aAlfa + &13 + &10;
     |XGRABA nHandleEnv, aAlfa;

     |XCIERRA nHandleEnv;

     aAlfa = #dsarm005#9;  |HAZ QuitaNombre;

     aOrigen = #dsarm005#7;               |QBF aOrigen;
     aOrigen = aOrigen + #dsarm005#9;     |QBF aOrigen;
     aDestino = aDestinoTgz + aNomFichero + aAuxExtension;  |QBF aDestino;

     |SI #dsarm001#7 = "N";
         |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
         |SI aIPRemoto ! "";
             |RECIBE_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     ||Ahora el ATAR.

     aFicTar = aDestinoTgz + aNomFichero + ".tar";
     aFicTar = aFicTar + " " + aNomFichero + aAuxExtension;
     aFicTar = aFicTar + " " + aNomFichero +".txt";

     |ATAR aFicTar, aDestinoTgz;
     |SI FSalida = 0;
          aFicTar = aDestinoTgz + aNomFichero + ".tar";
          |COMPRIME aFicTar;
          |SI FSalida = 0;
               aBorra = aDestinoTgz + aNomFichero + ".tar";
               |FBORRA aBorra;
               aDestino = aDestinoTgz + aNomFichero + ".tgz";
               nSwTgzOk = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DsEnviaCorreoOCR;
     eaAdjuntoPLB   = aDestino;
     aIP            = #dsarw010#19;  |QBF aIP;
     eaServidorSMTP = aIP;
     eaPassPLB      = #dsarw010#22;
     eaUsuarioPLB   = #dsarw010#21;

     aFrom          = #dsarw010#1;   |QBF aFrom;
     eaOrigenPLB    = aFrom;
     eaDirRespoPLB  = eaOrigenPLB;

     aTo            = aEmailDestino;  |QBF aTo;
     eaDestinoPLB   = aTo;

     |DBASE aBase;  |QBF aBase;
     |HAZ QuitaBarras;

     |SI #dsarm004#91 = 1;
         aAsunto  = "FACTURA RECIBIDA CONTAMATICA " + ((aAuxExtension - ".") > "");
     |FINSI;

     |SI #dsarm004#91 = 2;
         aAsunto  = "FACTURA EMITIDA CONTAMATICA " + ((aAuxExtension - ".") > "");
     |FINSI;

     eaAlfa   = "Documento a CONTAMATICA.";
     eaAlfa   = eaAlfa + " Tipo imagen: " + aAsunto;
     eaAlfa   = eaAlfa + " Cod: " + aIni + aAuxBarra + (("000000000" + #dsarm005#0) % -109);

     aMensaje = "";
     |DBASE aBase;
     |QBF aBase;
     aCuerpo = aBase + "documentos";  |MKDIR aCuerpo;
     aCuerpo = aBase + "documentos/correos";  |MKDIR aCuerpo;
     aCuerpo = aCuerpo + "/cuerpo" + (("000000000" + #dsarm005#0) % -109) + ".txt";
     |XABRE "WB", aCuerpo, nHandleC;
     |SI FSalida ] 0;
          aAlfa = eaAlfa + &13 + &10;
          |XGRABA nHandleC, aAlfa;
          |XCIERRA nHandleC;
     |SINO;
          aMensaje = eaAlfa;
          |SI enSwModoSilencio = 1;
               eaErrorDsEscan = "Error al generar " + aCuerpo;
               enNumRegDsEscan = #dsarm005#0;
          |SINO;
               aTextoMe = "0000Error al generar " + aCuerpo;
               |MENAV aTextoMe;
          |FINSI;
     |FINSI;

     |SI #dsarw010#23 = "S";
          eaConfLecPLB = "S";
     |SINO;
          eaConfLecPLB = "N";
     |FINSI;
     eaAsuntoPLB = aAsunto;
     eaCuerpoPLB = aCuerpo;

     enSwErrorCorreoPLB = 0;
     |HAZ DSEnviaCorreoPLB;

     |SI enSwErrorCorreoPLB = 1;
          |SI enSwModoSilencio = 1;
               eaErrorDsEscan = "Error al enviar el correo. [dsenviacorreo]";
               enNumRegDsEscan = #dsarm005#0;
          |SINO;
               aMensaje = "0000Error al enviar el correo. [dsenviacorreo]";
               |MENAV aMensaje;
          |FINSI;
     |FINSI;

     |SI #dsarm001#181 = "S";
          |QBF eaBorraCache1;
          |SI eaBorraCache1 ! "";
               |RFBORRA eaBorraCache1;
          |FINSI;
          |QBF eaBorraCache2;
          |SI eaBorraCache2 ! "";
               |RFBORRA eaBorraCache2;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MandaCorreoOCR;
     |SI enSwDesde9 = 0;
          |VENTANA 0501, 2799, -1, 1, "";
          nVent1   = FSalida;

          |PINPA #0#dsarw013;
          |PINDA #0#dsarw013;
          |PTEC 802;
          |PAUSA;
     |SINO;
          |SI enSwNomina = 0;
               |PINPA #0#dsarw019;
               |PINDA #0#dsarw019;
               |PTEC 802;
               |PAUSA;
          |FINSI;
     |FINSI;

     |IP_REMOTO aIPRemoto;
     |QBF aIPRemoto;

     aAdjunto = aDestino;

     |SI aQueSistema = "ESDOS";
         |HAZ CorreoEnDos;
         |SI aIPRemoto ! "";
             |HAZ CorreoEnUnix;
         |FINSI;
     |SINO;
          |HAZ CorreoEnUnix;
     |FINSI;

     aIP = "";
     aIP = #dsarw010#18;  |QBF aIP;

     aFrom    = #dsarw010#1;   |QBF aFrom;
     aSalida  = #dsarw010#19;  |QBF aSalida;

     aTo      = aEmailDestino;
     |QBF aTo;

     |DBASE aBase;  |QBF aBase;
     |HAZ QuitaBarras;

     |SI #dsarm004#91 = 1;
         aAsunto  = "FACTURA RECIBIDA CONTAMATICA " + ((aAuxExtension - ".") > "");
     |FINSI;

     |SI #dsarm004#91 = 2;
         aAsunto  = "FACTURA EMITIDA CONTAMATICA " + ((aAuxExtension - ".") > "");
     |FINSI;

     eaAlfa   = "Documento a CONTAMATICA.";
     eaAlfa   = eaAlfa + " Tipo imagen: " + aAsunto;
     eaAlfa   = eaAlfa + " Cod: " + aIni + aAuxBarra + (("000000000" + #dsarm005#0) % -109);
     aMensaje = eaAlfa;

     |SI #dsarw010#20 = "N";
          aAutenti = aFrom;
     |SINO;
          aAutenti = #dsarw010#22;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + #dsarw010#21;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + aFrom;
     |FINSI;

     |SI #dsarw010#23 = "S";
          aAutenti = "!" + aAutenti;
     |FINSI;

     |DSCORREO_ENVIA aIP, aSalida, aAutenti, aTo, aAsunto, aMensaje, aAdjunto;
     |SI FSalida < 0;
         enErrorCorreo = 1;
         |SI enMensaOCX = 0;
          |SI enSwModoSilencio = 0;
               |MENAV "0000 Ha habido un error durante el envio.";
          |FINSI;
         |FINSI;
     |FINSI;

     |SI enSwDesde9 = 0;
          |FINVENTANA nVent1;
     |FINSI;
|FPRC;

|PROCESO CorreoOCREXTERNO;
     |HAZ TgzOCR;

     |SI nSwDsEnviaCorreo = 1;
          |HAZ DsEnviaCorreoOCR;
     |SINO;
          |HAZ MandaCorreoOCR;
     |FINSI;
|FPRC;

|PROCESO TgzPlantillas;
     ||PREPARO EL DIRECTORIO DONDE HARE EL TGZ

     aNomTgz     = "tgz" + Usuario;                     |QBF aNomTgz
     |DBASE aBase;  |QBF aBase;
     aDestinoTgz = aBase + "correos";                   |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/" + aNomTgz;         |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/";

     aDirectorio = aDestinoTgz;
     |HAZ BorraDir;

     aNomTgz     = "tgz" + Usuario;                     |QBF aNomTgz
     |DBASE aBase;  |QBF aBase;
     aDestinoTgz = aBase + "correos";                   |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/" + aNomTgz;         |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/";

     |HAZ QuitaBarras;

     ||COPIO EL DOCUMENTO RESULTADO OCR SI EXISTE.
     aPathAdj2 = #dsarm005#7;   |QBF aPathAdj2;
     aPathAdj2 = aPathAdj2 + #dsarm005#9;
     |QBF aPathAdj2;
     aPathAdj2 = aPathAdj2 + ".txt";

     ||CCC. Tiene que llega   NOMBRE.tgz (sin la extension en el nombre)
     ||aNomFichero = aIni + aAuxBarra + (("000000000" + #dsarm005#0) % -109) + aAuxExtension;
     aNomFichero = aIni + aAuxBarra + (("000000000" + #dsarm005#0) % -109);

     aDestino = aDestinoTgz + aNomFichero + ".txt";

     aOrigen  = aPathAdj2;

     |SI #dsarm001#7 = "N";
         |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
         |SI aIPRemoto ! "";
             |RECIBE_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aAlfa = #dsarm005#9;  |HAZ QuitaNombre;

     ||COPIO EL DOCUMENTO PRINCIPAL.
     aOrigen = #dsarm005#7;
     |QBF aOrigen;
     aOrigen = aOrigen + #dsarm005#9;
     |QBF aOrigen;
     aDestino = aDestinoTgz + aNomFichero + aAuxExtension;  |QBF aDestino;

     |SI #dsarm001#7 = "N";
         |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
         |SI aIPRemoto ! "";
             |RECIBE_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     ||Ahora el ATAR.

     aFicTar = aDestinoTgz + aNomFichero + ".tar" + " " + aNomFichero + ".txt";
     aFicTar = aFicTar + " " + aNomFichero + aAuxExtension;

     |ATAR aFicTar, aDestinoTgz;
     |SI FSalida = 0;
          aFicTar = aDestinoTgz + aNomFichero + ".tar";
          |COMPRIME aFicTar;
          |SI FSalida = 0;
               aBorra = aDestinoTgz + aNomFichero + ".tar";
               |FBORRA aBorra;
               aDestino = aDestinoTgz + aNomFichero + ".tgz";
               nSwTgzOk = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO DsEnviaCorreoPLANTILLA;
     eaAdjuntoPLB   = aDestino;
     aIP            = #dsarw010#19;  |QBF aIP;
     eaServidorSMTP = aIP;
     eaPassPLB      = #dsarw010#22;
     eaUsuarioPLB   = #dsarw010#21;

     aFrom          = #dsarw010#1;   |QBF aFrom;
     eaOrigenPLB    = aFrom;
     eaDirRespoPLB  = eaOrigenPLB;

     aTo            = aEmailDestino;  |QBF aTo;
     eaDestinoPLB   = aTo;

     |DBASE aBase;  |QBF aBase;
     |HAZ QuitaBarras;

     aAsunto  = (aAuxExtension - ".") > "";
     eaAlfa   = "Documento dsEscan sin plantilla.";
     eaAlfa   = eaAlfa + " Tipo imagen: " + aAsunto;
     eaAlfa   = eaAlfa + " Cod: " + aIni + aAuxBarra + (("000000000" + #dsarm005#0) % -109);

     aMensaje = "";
     |DBASE aBase;
     |QBF aBase;
     aCuerpo = aBase + "documentos";  |MKDIR aCuerpo;
     aCuerpo = aBase + "documentos/correos";  |MKDIR aCuerpo;
     aCuerpo = aCuerpo + "/cuerpo" + (("000000000" + #dsarm005#0) % -109) + ".txt";
     |XABRE "WB", aCuerpo, nHandleC;
     |SI FSalida ] 0;
          aAlfa = eaAlfa + &13 + &10;
          |XGRABA nHandleC, aAlfa;
          |XCIERRA nHandleC;
     |SINO;
          aMensaje = eaAlfa;
          |SI enSwModoSilencio = 1;
               eaErrorDsEscan = "Error al generar " + aCuerpo;
               enNumRegDsEscan = #dsarm005#0;
          |SINO;
               aTextoMe = "0000Error al generar " + aCuerpo;
               |MENAV aTextoMe;
          |FINSI;
     |FINSI;

     |SI #dsarw010#23 = "S";
          eaConfLecPLB = "S";
     |SINO;
          eaConfLecPLB = "N";
     |FINSI;
     eaAsuntoPLB = aAsunto;
     eaCuerpoPLB = aCuerpo;

     enSwErrorCorreoPLB = 0;
     |HAZ DSEnviaCorreoPLB;

     |SI enSwErrorCorreoPLB = 1;
          |SI enSwModoSilencio = 1;
               eaErrorDsEscan = "Error al enviar el correo. [dsenviacorreo]";
               enNumRegDsEscan = #dsarm005#0;
          |SINO;
               aMensaje = "0000Error al enviar el correo. [dsenviacorreo]";
               |MENAV aMensaje;
          |FINSI;
     |FINSI;

     |SI #dsarm001#181 = "S";
          |QBF eaBorraCache1;
          |SI eaBorraCache1 ! "";
               |RFBORRA eaBorraCache1;
          |FINSI;
          |QBF eaBorraCache2;
          |SI eaBorraCache2 ! "";
               |RFBORRA eaBorraCache2;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MandaCorreoPLANTILLA;
     |SI enSwDesde9 = 0;
          |VENTANA 0501, 2799, -1, 1, "";
          nVent1   = FSalida;

          |PINPA #0#dsarw013;
          |PINDA #0#dsarw013;
          |PTEC 802;
          |PAUSA;
     |SINO;
          |SI enSwNomina = 0;
               |PINPA #0#dsarw019;
               |PINDA #0#dsarw019;
               |PTEC 802;
               |PAUSA;
          |FINSI;
     |FINSI;

     |IP_REMOTO aIPRemoto;
     |QBF aIPRemoto;

     aAdjunto = aDestino;

     |SI aQueSistema = "ESDOS";
         |HAZ CorreoEnDos;
         |SI aIPRemoto ! "";
             |HAZ CorreoEnUnix;
         |FINSI;
     |SINO;
          |HAZ CorreoEnUnix;
     |FINSI;

     aIP = "";
     aIP = #dsarw010#18;  |QBF aIP;

     aFrom    = #dsarw010#1;   |QBF aFrom;
     aSalida  = #dsarw010#19;  |QBF aSalida;

     aTo      = aEmailDestino;
     |QBF aTo;

     |DBASE aBase;  |QBF aBase;
     |HAZ QuitaBarras;

     aAsunto  = (aAuxExtension - ".") > "";
     eaAlfa   = "Documento dsEscan sin plantilla.";
     eaAlfa   = eaAlfa + " Tipo imagen: " + aAsunto;
     eaAlfa   = eaAlfa + " Cod: " + aIni + aAuxBarra + (("000000000" + #dsarm005#0) % -109);
     aMensaje = eaAlfa;

     |SI #dsarw010#20 = "N";
          aAutenti = aFrom;
     |SINO;
          aAutenti = #dsarw010#22;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + #dsarw010#21;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + aFrom;
     |FINSI;

     |SI #dsarw010#23 = "S";
          aAutenti = "!" + aAutenti;
     |FINSI;

     |DSCORREO_ENVIA aIP, aSalida, aAutenti, aTo, aAsunto, aMensaje, aAdjunto;
     |SI FSalida < 0;
         enErrorCorreo = 1;
         |SI enMensaOCX = 0;
          |SI enSwModoSilencio = 0;
               |MENAV "0000 Ha habido un error durante el envio.";
          |FINSI;
         |FINSI;
     |FINSI;

     |SI enSwDesde9 = 0;
          |FINVENTANA nVent1;
     |FINSI;
|FPRC;

|PROCESO CorreoPLANTILLAS;
     |HAZ TgzPlantillas;

     |SI nSwDsEnviaCorreo = 1;
         |HAZ DsEnviaCorreoPLANTILLA;
     |SINO;
          |HAZ MandaCorreoPLANTILLA;
     |FINSI;

     aAbre = aDirBaseServidor + "Envio" + Usuario + ".txt";
     |XABRE "AB", aAbre, nHandle;

     aAlfa   = "Documento dsEscan sin plantilla.";
     aAlfa   = aAlfa + " Tipo imagen: " + aAsunto;
     aAlfa   = aAlfa + " Cod: " + aIni + aAuxBarra + (("000000000" + #dsarm005#0) % -109);
     aAlfa   = aAlfa + &13 + &10;
     |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;
|FPRC;

|PROCESO CorreoNoPlantilla;
     |ABRE #dsarm004;
     #dsarm004#0 = #dsarm005#1;
     #dsarm004#1 = #dsarm005#2;
     #dsarm004#2 = #dsarm005#3;
     |LEE 000#dsarm004.=;
     |SI FSalida ! 0;  |DDEFECTO #dsarm004;  |FINSI;
     |CIERRA #dsarm004;

     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     aIPLocal = "";
     |IP_LOCAL aIPLocal;    |QBF aIPLocal;

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;

     aQueSistema = "";
     |QUE_SISTEMA aQueSistema;  |QBF aQueSistema;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "SMTPCLI";
     |HAZ DSARCHI_INI;
     nSwSMTPCLI = enAprobacion;
     enAprobacion = nGuarda;

     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "DSENVIACORREO";
     |HAZ DSARCHI_INI;
     nSwDsEnviaCorreo = enAprobacion;
     enAprobacion = nGuarda;

     |SI nSwSMTPCLI = 1;
          aMensaje = "0000Envio por SMTPCLI no soportado";
          |SI enMensaOCX = 0;
              ||MENAV aMensaje;
          |FINSI;
     |FINSI;

     |SI nOcrExterno = 1;
         aEmailDestino = #dsarm001#218;  |QBF aEmailDestino;

         |HAZ CorreoOCREXTERNO;
     |FINSI;

     |SI nOcrExterno = 0;
         aEmailDestino = #dsarm001#169;  |QBF aEmailDestino;

         |HAZ CorreoPLANTILLAS;
     |FINSI;

     |ABRE #dsarm034;
     #dsarm034#0 = efFechaOCR;
     #dsarm034#1 = eaHoraOCR;
     #dsarm034#2 = #dsarm005#9;
     |LEE 101#dsarm034.=;
     |SI FSalida = 0;
         |HORA aHoraEnv;

         #dsarm034#23 = ~;
         #dsarm034#24 = aHoraEnv;
         #dsarm034#25 = Usuario % 810;
         #dsarm034#18 = #dsarm005#8;
         #dsarm034#19 = 4;

         |GRABA 020#dsarm034.a;
         |LIBERA #dsarm034;
     |FINSI;
     |CIERRA #dsarm034;
|FPRC;

|PROCESO Integridad;
     ||Primero obtengo el PROCESOPI.

     |SI aProcesoPI = "";
          |ACABA;
     |FINSI;

     enCodPrimeraInc = 0;
     eaPrimeraInc = "";
     enSwAvisaInte = 0;
     eaProcesoPIInte = aProcesoPI;
     enResultadoInte = 0;
     efFechaInte = fFechaOCR;
     eaHoraInte = aHoraOCR;
     eaFicInte = aFicOCR;

     |HAZ IntegridaddsEscan;

     |SI enResultadoInte = 0;
          aIntegridadOK = "N";
     |SINO;
          aIntegridadOK = "S";
     |FINSI;
|FPRC;

|PROCESO VentaContado;
     #dsarm035#0 = fFechaOCR;
     #dsarm035#1 = aHoraOCR;
     #dsarm035#2 = aFicOCR;
     #dsarm035#3 = "FE000000_clinif";
     |LEE 000#dsarm035.=;
     |SI FSalida = 0;
         aAlfa = #dsarm035#4;  |QBF aAlfa;
         |SI aAlfa ! "QTY000000";
             |ACABA;
         |FINSI;
     |FINSI;

     #dsarm035#0 = fFechaOCR;
     #dsarm035#1 = aHoraOCR;
     #dsarm035#2 = aFicOCR;
     #dsarm035#3 = "FE000000_clinom";
     |LEE 101#dsarm035.=;
     |SI FSalida ! 0;
         #dsarm035#0 = fFechaOCR;
         #dsarm035#1 = aHoraOCR;
         #dsarm035#2 = aFicOCR;
         #dsarm035#3 = "FE000000_clinom";
         #dsarm035#4 = "VENTA AL CONTADO";
         |GRABA 020#dsarm035.n;
     |FINSI;
     |LIBERA #dsarm035;
|FPRC;

|PROCESO NumeroFactura;
     #dsarm035#0 = fFechaOCR;
     #dsarm035#1 = aHoraOCR;
     #dsarm035#2 = aFicOCR;
     #dsarm035#3 = "FE000000_idfactura";
     |LEE 000#dsarm035.=;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     aAlfa1 = #dsarm035#4;  |QBF aAlfa1;
     |SI aAlfa1 = "";  |ACABA;  |FINSI;

     aLong  = aAlfa1 % 0;
     |SI aLong > "6";  |ACABA;  |FINSI;

     nNume  = aAlfa1;
     aAlfa2 = nNume;

     |SI aAlfa1 ! aAlfa2;
         |ACABA;
     |FINSI;

     #dsarm035#0 = fFechaOCR;
     #dsarm035#1 = aHoraOCR;
     #dsarm035#2 = aFicOCR;
     #dsarm035#3 = "FE000000_idfactura";
     |LEE 101#dsarm035.=;
     |SI FSalida = 0;
         #dsarm035#4 = ("000000" + nNume) % -106;
         |GRABA 020#dsarm035.a;
         |LIBERA #dsarm035;
     |FINSI;
|FPRC;

|PROCESO CompruebaActividad;
     |SI aProcesoPI = "FR000000";
         #dsarm035#0 = fFechaOCR;
         #dsarm035#1 = aHoraOCR;
         #dsarm035#2 = aFicOCR;
         #dsarm035#3 = "FR000000_actividad";
         |LEE 000#dsarm035.=;
         |SI FSalida = 0;  |ACABA;  |FINSI;
     |FINSI;

     |SI aProcesoPI = "FE000000";
         |HAZ VentaContado;
         |HAZ NumeroFactura;

         #dsarm035#0 = fFechaOCR;
         #dsarm035#1 = aHoraOCR;
         #dsarm035#2 = aFicOCR;
         #dsarm035#3 = "FE000000_actividad";
         |LEE 000#dsarm035.=;
         |SI FSalida = 0;  |ACABA;  |FINSI;
     |FINSI;

     |SI aProcesoPI ! "FE000000";
      |Y aProcesoPI ! "FR000000";
         |ACABA;
     |FINSI;

     |DDEFECTO #dsarm035;
     #dsarm035#0 = fFechaOCR;
     #dsarm035#1 = aHoraOCR;
     #dsarm035#2 = aFicOCR;
     #dsarm035#3 = aProcesoPI + "_actividad";
     #dsarm035#4 = "1";

     |ABRE #dsarm036;
     |DDEFECTO #dsarm036;
     #dsarm036#0 = aProcesoPI;
     #dsarm036#1 = #dsarm035#3;
     |LEE 000#dsarm036.=;
     |SI FSalida = 0;
         #dsarm035#10 = #dsarm036#9;
     |FINSI;
     |CIERRA #dsarm036;

     #dsarm035#8 = "0,158,0;255,255,255";

     |GRABA 020#dsarm035.n;
     |LIBERA #dsarm035;
|FPRC;

|PROCESO Identify;
     nErrorIdentify = 0;
     |SI nPasaIdenty = 0;
         |ACABA;
     |FINSI;

     aAlfa = aDirBaseLocal + "imagemagick\identify.exe";
     |XABRE "EC", aAlfa, nHandle;
     |SI FSalida < 0;  |ACABA;  |FINSI;

     aAbreBat = aDirBaseLocal + "identify.bat";
     |XABRE "WCB", aAbreBat, nHandle;

     aLetra = aDirBaseLocal % 101;
     aAlfa = aLetra + ":" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "CD " + aDirBaseLocal + "imagemagick" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aIdentify = aDirBaseLocal + "identify.txt";

     aAlfa = "identify.exe -format " + &34 + " %%[xresolution] %%[yresolution] %%b" + &34;
     aAlfa =  aAlfa + " " + aDestino + " > " + aIdentify + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "exit " + &13 + &10;
     |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;
     aEjecuta  = "cmd " + &34 + "/c START /MIN " + aAbreBat + &34;
     |RSYSTEM aEjecuta;

     nContador = 0;
     |PARA;  |SI;  |HACIENDO;
          |XABRE "EC", aIdentify, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |SLEEP 1;

          nContador = nContador + 1;
          |SI nContador ] 60;  |SAL;  |FINSI;
     |SIGUE;

     |XABRE "CU", aIdentify, nHandle;
     |XLEE nHandle, 250, aLinea;
     |XCIERRA nHandle;

     |QBF aLinea;
     |SI aLinea = "";  |ACABA;  |FINSI;

     |QBF aLinea;
     aLong   = aLinea % A0;
     nLong   = aLong;
     nParam  = 1;
     aParam1 = "";
     aParam2 = "";
     aParam3 = "";
     |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
          nSaca  = (nVoy * 100) + 1;
          aLetra = aLinea % nSaca;
          |SI aLetra = " ";  |Y aParam1 ! "";
              nParam = nParam + 1;
          |FINSI;

          |SI nParam = 1; aParam1 = aParam1 + aLetra;  |FINSI;
          |SI nParam = 2; aParam2 = aParam2 + aLetra;  |FINSI;
          |SI nParam = 3; aParam3 = aParam3 + aLetra;  |FINSI;

          |SI nParam ] 4;  |SAL;  |FINSI;
     |SIGUE;

     nParam1 = aParam1 ! 0;
     nParam2 = aParam2 ! 0;
     nParam3 = aParam3 ! 0;

     |SI nParam1 < #dsarm001#176; |O nParam2 < #dsarm001#177; |O nParam3 > #dsarm001#175;
         nErrorIdentify = 1;
     |FINSI;

     |RFBORRA aIdentify;
|FPRC;

|PROCESO DeJPGaTIF;
     aAlfa = aDirBaseLocal + "imagemagick\convert.exe ";
     aAlfa = aAlfa + aDestino;

     |SI aTipoDoc = "jpg";
         aExtension = aDestino % -104;
         |SI aExtension = ".JPG";
             aDestinoDos = aDestino - ".JPG";
             aNomResOCR = aNomResOCR - ".JPG.txt";
         |SINO;
             aDestinoDos = aDestino - ".jpg";
             aNomResOCR = aNomResOCR - ".jpg.txt";
         |FINSI;
     |FINSI;

     |SI aTipoDoc = "jpe";
         aExtension = aDestino % -104;
         |SI aExtension = ".JPE";
             aDestinoDos = aDestino - ".JPE";
             aNomResOCR = aNomResOCR - ".JPE.txt";
         |SINO;
             aDestinoDos = aDestino - ".jpe";
             aNomResOCR = aNomResOCR - ".jpe.txt";
         |FINSI;
     |FINSI;

     |SI aTipoDoc = "png";
         aExtension = aDestino % -104;
         |SI aExtension = ".PNG";
             aDestinoDos = aDestino - ".PNG";
             aNomResOCR = aNomResOCR - ".PNG.txt";
         |SINO;
             aDestinoDos = aDestino - ".png";
             aNomResOCR = aNomResOCR - ".png.txt";
         |FINSI;
     |FINSI;

     aDestinoDos = aDestinoDos + ".tif";
     aNomResOCR = aNomResOCR + ".tif.txt";

     aAlfa = aAlfa + " -resize 1728x2255 -monochrome -units PixelsPerInch -density 204x196 -compress fax -endian lsb " + aDestinoDos;
     |RSYSTEM aAlfa;

     |RFBORRA aDestino;

     aTipoDoc = "tif";
     aDestino = aDestinoDos;
|FPRC;

|PROCESO DePDFaTIFUnix;
     |DBASE aBaseUnix;
     |QBF aBaseUnix;

     aBaseAux = aBaseUnix + "aux/";
     |MKDIR aBaseAux;

     aNomDoc = #dsarm005#9;
     |QBF aNomDoc;
     aNomDoc = aNomDoc < "";

     aPathLog = aBaseAux + "logs/";
     |MKDIR aPathLog;

     aNumeroDoc = ("000000000" + #dsarm005#0) % -109;
     aConvierteLog = aPathLog + "convierte" + aNumeroDoc + ".log";
     aConvierteErr = aPathLog + "convierte" + aNumeroDoc + ".err";

     aFicOrigen = aDestino;
     aFicDestino = aBaseAux + aNomDoc;

     aExtension = aDestino % -104;
     |SI aExtension = ".PDF";
         aDestinoDos = aDestino - ".PDF";
         aNomResOCR = aNomResOCR - ".PDF.txt";
     |SINO;
         aDestinoDos = aDestino - ".pdf";
         aNomResOCR = aNomResOCR - ".pdf.txt";
     |FINSI;
     aDestinoDos = aDestinoDos + ".tif";
     aNomResOCR = aNomResOCR + ".tif.txt";
     aFicDestinoTif = aFicDestino - ".pdf";
     aFicDestinoTif = aFicDestinoTif + ".tif";

     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
          |RECIBE_FICHERO aFicOrigen, aFicDestino;
     |SINO;
          |COPIA_FICHERO aFicOrigen, aFicDestino;
     |FINSI;

     ||UNIX
     aAbreShell = aBaseAux + "convierte.sh";
     |XABRE "WB", aAbreShell, nHandle;

     aEjecuta = "PATH=:.:/usr/agibin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin"
     aAlfa = aEjecuta + &10;
     |XGRABA nHandle, aAlfa;

          ||SOLO PRIMERA PAGINA
     |SI #dsarm004#85 = "N";
          aEjecuta = "convert -page A4 -density 300x300 -type bilevel -compress lzw " + aFicDestino + " " + aFicDestinoTif + " > " + aConvierteLog + " 2> " + aConvierteErr;
     |SINO;
          aEjecuta = "convert -page A4 -density 300x300 -type bilevel -compress lzw " + aFicDestino + "[0] " + aFicDestinoTif + " > " + aConvierteLog + " 2> " + aConvierteErr;
     |FINSI;
     aAlfa = aEjecuta + &10;
     |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;

     aEjecuta = "chmod 755 " + aAbreShell;
     |SYSTEM aEjecuta;

     aEjecuta = aAbreShell;
     |SYSTEM aEjecuta;

     aFicOrigen = aFicDestinoTif;
     aFicDestino = aDestinoDos;
     |SI aIPRemoto ! "";
          |ENVIA_FICHERO aFicOrigen, aFicDestino;
     |SINO;
          |COPIA_FICHERO aFicOrigen, aFicDestino;
     |FINSI;

     aTipoDoc = "tif";
     aDestino = aDestinoDos;

     aBorra = aBaseAux + aNomDoc;
     |FBORRA aBorra;
|FPRC;

|PROCESO DePDFaTIF;
     aAlfa = aDirBaseLocal + "imagemagick\convert.exe ";

     aExtension = aDestino % -104;
     |SI aExtension = ".PDF";
         aDestinoDos = aDestino - ".PDF";
         aNomResOCR = aNomResOCR - ".PDF.txt";
     |SINO;
         aDestinoDos = aDestino - ".pdf";
         aNomResOCR = aNomResOCR - ".pdf.txt";
     |FINSI;

     aPathLog = aDirBaseLocal + "logs\";
     |RMKDIR aPathLog;

     aNumeroDoc = ("000000000" + #dsarm005#0) % -109;
     aConvierteLog = aPathLog + "convierte" + aNumeroDoc + ".log";
     aConvierteErr = aPathLog + "convierte" + aNumeroDoc + ".err";

     aDestinoDos = aDestinoDos + ".tif";
     aNomResOCR = aNomResOCR + ".tif.txt";

     aAbreBat = aDirBaseLocal + "convierte.bat";
     |XABRE "WCB", aAbreBat, nHandle;

     aAlfa = "@ECHO OFF" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aLetra = aDirBaseLocal % 101;
     aAlfa = aLetra + ":" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa =  "DEL " + aDestinoDos + ".fin" + " 2> " + aDirBaseLocal + "del.log" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "CD " + aDirBaseLocal + "imagemagick" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "convert.exe" + " -density 300x300 -type bilevel -compress lzw";

     ||Lo del -page A4, era una idea, pero no ha funcionat.
     ||aAlfa = "convert.exe" + " -density 300x300 -type bilevel -compress lzw -page A4";


     |SI #dsarm004#85 = "N";
          aAlfa = aAlfa + " " + aDestino + " " + aDestinoDos;
          aAlfa = aAlfa + " > " + aConvierteLog + " 2> " + aConvierteErr + &13 + &10;
     |SINO;
          aAlfa =  aAlfa + " " + aDestino + "[0] " + aDestinoDos;
          aAlfa = aAlfa + " > " + aConvierteLog + " 2> " + aConvierteErr + &13 + &10;
     |FINSI;
     |XGRABA nHandle, aAlfa;

     aDestinoFin = aDestinoDos + ".fin";

     aAlfa =  "echo FIN > " + aDestinoFin + &13 + &10;
     |XGRABA nHandle, aAlfa;

     aAlfa = "exit" + &13 + &10;
     |XGRABA nHandle, aAlfa;

     |XCIERRA nHandle;

     ||Ahora sale minimizada y a continuacion se cierra. Practicamente no se ve.
     aEjecuta  = "cmd " + &34 + "/c START /MIN " + aAbreBat + &34;
     |RSYSTEM aEjecuta;

     nContador = 0;
     |PARA;  |SI;  |HACIENDO;
           |XABRE "EC", aDestinoDos, nHandle;
           |SI FSalida ] 0;  |SAL;  |FINSI;

           |SLEEP 1;

           ||A partir de los 30 segundos, miramos tambien el semamofo
           ||de fin, para terminar en caso de error, al procesar.

           |SI nContador ] 30;
                |XABRE "EC", aDestinoFin, nHandle;
                |SI FSalida ] 0;
                     |SI enSwModoSilencio = 1;
                          eaErrorDsEscan = "Error al convertir el PDF a TIF. Revise " + aConvierteErr;
                          enNumRegDsEscan = #dsarm005#0;
                          nSwHayErrorSil = 1;
                          |SAL;
                     |SINO;
                          aMensaje = "0000Error al convertir el PDF a TIF. Revise " + aConvierteErr;
                          |MENAV aMensaje;
                          |SAL;
                     |FINSI;
                |FINSI;
           |FINSI;

           ||3 minutos de tiempo maximo de espera para la conversion.
           ||Hay conversiones muy lentas.
           nContador = nContador + 1;
           |SI nContador ] 180;  |SAL;  |FINSI;
     |SIGUE;

     |RFBORRA aDestino;
     |RFBORRA aDestinoFin;

     aTipoDoc = "tif";
     aDestino = aDestinoDos;
|FPRC;

|PROCESO LanzaDSESCAN;
     aHoraEnv   = "";
     aIPServOCR = #dsarm001#166;   |QBF aIPServOCR;

     nPuerto = #dsarm001#167;
     |SI nPuerto ! 0;
         aIPServOCR = aIPServOCR + ":" + nPuerto;
     |FINSI;

     |SI enNumTotalDocs ! 0;
         enVoyPorDoc = enVoyPorDoc + 1;
         aAlfa = aDirBaseLocal + "bin/dsescan_cli.exe " + aDestino + " " + aIPServOCR + " " + aParamIni + " " + enVoyPorDoc + " " + enNumTotalDocs;
     |SINO;
         aAlfa = aDirBaseLocal + "bin/dsescan_cli.exe " + aDestino + " " + aIPServOCR + " " + aParamIni + " 1 1";
     |FINSI;

     |SI nRecogeRes = 1;
         aAlfa = aAlfa + " recogerespuesta";
     |FINSI;

     ||Tengo que verificar que existe el aDestino.
     ||Y que los paremetros son correctos, sino .. NO lo lanzo.

     |XABRE "CE", aDestino, nHandleE;
     |SI FSalida < 0;
         |SI enSwModoSilencio = 0;
             aMensaje = "0000No existe la imagen " + aDestino;
             |MENAV aMensaje;
         |SINO;
             |SI nSwHayErrorSil = 0;
                 eaErrorDsEscan = "No existe la imagen " + aDestino;
                 enNumRegDsEscan = #dsarm005#0;
                 nSwHayErrorSil = 1;
             |FINSI;
         |FINSI;

         aSwLanzaDsEscan = "NO";
    |FINSI;

    |SI aSwLanzaDsEscan ! "NO";
        |QBF aIPServOCR;
        |QBF aParamIni;

        |SI aIPServOCR = ""; |O aParamIni = "";
            |SI enSwModoSilencio = 0;
                |SI aIPServOCR = "";
                    aMensaje = "0000Error Direcci¢n del servidor dsEscan vacia";
                |SINO;
                    aMensaje = "0000Error Par metros dsEscan vacios";
                |FINSI;
                |MENAV aMensaje;
            |SINO;
                |SI nSwHayErrorSil = 0;
                    |SI aIPServOCR = "";
                        eaErrorDsEscan = "Error Direcci¢n del servidor dsEscan vacia";
                    |SINO;
                        eaErrorDsEscan = "Error Par metros dsEscan vacios";
                    |FINSI;
                    nSwHayErrorSil = 1;
                    enNumRegDsEscan = #dsarm005#0;
                |FINSI;
            |FINSI;
        |SINO;
            |RSYSTEM aAlfa;
        |FINSI;
     |SINO;
         aSwLanzaDsEscan = "";
     |FINSI;

     |PULSATECLA;
     |PULSATECLA;
     |PULSATECLA;
|FPRC;

|PROCESO AplicaHTM;
     aNomFichero = #dsarm005#9;                            |QBF aNomFichero;
     aDestino = aDirBaseServidor + #dsarm005#9 + ".txt";   |QBT aDestino;

     |SI #dsarm001#7 = "N";
         |COPIA_FICHERO aOrigen, aDestino;
     |SINO;
         aIPRemoto = "";
         |IP_REMOTO aIPRemoto;  |QBF aIPRemoto;
         |SI aIPRemoto ! "";
             |RECIBE_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |FINSI;

     aFicheroOCR = aDestino;
     |SI eaAutoSelPlantilla = "S";
         |HAZ FiltroPlantillas;
     |SINO;
         |SI eaImpoAlbaVta = "S";
             |HAZ FiltroAlbaVta;
         |FINSI;
     |FINSI;

     |SI enGrupoFiltro ! 0;
         |ABRE #dsarm004;
         |DDEFECTO #dsarm004;
         #dsarm004#0 = enGrupoFiltro;
         #dsarm004#1 = enSubGrupoFiltro;
         #dsarm004#2 = enTipoFiltro;
         |LEE 000#dsarm004.=;
         |CIERRA #dsarm004;
     |FINSI;

     |SI PARAMETRO ! ""; |Y #dsarm004#78 ! 0; |Y #dsarm001#45 = "S";
         |HAZ AplicaPlantillasOCR;
     |FINSI;
|FPRC;

|PROCESO AplicaPDF;
     nGuarda = enAprobacion;
     enAprobacion = 0;
     eaPrograma = "PDF2TIFUNIX";
     |HAZ DSARCHI_INI;
     nSwPdf2TifUnix = enAprobacion;
     enAprobacion = nGuarda;

     |QUE_SISTEMA aSistema;
     |SI aSistema = "ESDOS";
         aSistema = "ESDOS";
     |SINO;
         aSistema = "ESUNIX";
     |FINSI;

     |ABRE #dsarm004;
     |DDEFECTO #dsarm004;
     #dsarm004#0 = #dsarm005#1;
     #dsarm004#1 = #dsarm005#2;
     #dsarm004#2 = #dsarm005#3;
     |LEE 000#dsarm004.=;
     |CIERRA #dsarm004;

     |SI nSwPdf2TifUnix = 1; |Y aSistema = "ESUNIX";
         aBorraCache = aDestino;
         |QBF aBorraCache;
         |HAZ DePDFaTIFUnix;
     |SINO;
         |HAZ DePDFaTIF;
     |FINSI;
|FPRC;

|PROCESO TrataRespuesta;
     enSwRealizadodsEscan = 1;

     nTimeOut = 0;
     nSwErrorOCR = 0;
     |PARA;  |SI;  |HACIENDO;
         |XABRE "EC", aRespuestaOCR, nHandle;
         |SI FSalida ] 0;
             |SAL;
         |FINSI;

         |SLEEP 1;
         nTimeOut = nTimeOut + 1;

         |SI nTimeOut = 5;
             nSwErrorOCR = 1;
             |SAL;
         |FINSI;
     |SIGUE;

     |RFBORRA aDestino;

     |SI eaHoraOCR ! "";
         fFechaOCR = efFechaOCR;
         aHoraOCR  = eaHoraOCR;
     |SINO;
         |HORA aHoraOCR;
         fFechaOCR = ~;
         aHoraOCR  = aHoraOCR % 105;
     |FINSI;

     aFicOCR   = #dsarm005#9;             |QBF aFicOCR;

     |SI eaAutoSelPlantilla = "S"; |O eaImpoAlbaVta = "S";
         aOrigen  = aRespuestaOCR;
         aNomFichero = #dsarm005#9 < "";
         |QBF aNomFichero;
         aDestino = aDirBaseServidor + aNomFichero + ".txt";
         |QBT aDestino;

         |SI aIPRemoto ! "";
             |RECIBE_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;

         aFicheroOCR = aDestino;
         |SI eaAutoSelPlantilla = "S";
             |HAZ FiltroPlantillas;
         |SINO;
             |SI eaImpoAlbaVta = "S";
                 |HAZ FiltroAlbaVta;
             |FINSI;
         |FINSI;

         |SI enGrupoFiltro ! 0;
             |ABRE #dsarm004;
             |DDEFECTO #dsarm004;
             #dsarm004#0 = enGrupoFiltro;
             #dsarm004#1 = enSubGrupoFiltro;
             #dsarm004#2 = enTipoFiltro;
             |LEE 000#dsarm004.=;
             |CIERRA #dsarm004;
         |FINSI;

         |SI #dsarm004#81 = "N";
             |SI PARAMETRO ! ""; |Y #dsarm004#78 ! 0; |Y #dsarm001#45 = "S";
                 |HAZ AplicaPlantillasOCR;
             |FINSI;

             |SI #dsarm001#181 = "S";
                 |SI nSwPdf2TifUnix = 1; |Y aSistema = "ESUNIX";
                     |SI aBorraCache ! "";
                         |RFBORRA aBorraCache;
                     |FINSI;
                 |FINSI;

                 |SI aBorraCache2 ! "";
                     |RFBORRA aBorraCache2;
                 |FINSI;
              |FINSI;

              |ACABA;
         |FINSI;
     |FINSI;

     ||Nos devuelve:
     || - si hay o no error. (En caso de error. Texto del error)
     || - codigo plantilla y descripcion
     || - proceso PI.
     || - variables si existen.

     |ABRE #dsarm035;
     |HAZ SacaDatosRespuesta;
     |HAZ CompruebaActividad;
     |CIERRA #dsarm035;

     |HAZ GrabaResultadoOCR;

     nSwEnvioCorreo = 0;
     aIntegridadOK = "N";
     |SI nSwErrorOCR = 1;
         |SI enSwModoSilencio = 1;
             |SI nSwHayErrorSil = 0;
                 eaErrorDsEscan = "<dsEscan> No he podido abrir " + aRespuestaOCR;
                 enNumRegDsEscan = #dsarm005#0;
                 nSwHayErrorSil = 1;
             |FINSI;
         |SINO;
             aMensaje = "0000<dsEscan> No he podido abrir " + aRespuestaOCR;
              |SI enMensaOCX = 0;
                  |MENAV aMensaje;
              |FINSI;
         |FINSI;
     |SINO;
         |SI nSwErrorOCRLog = 1;
             |SI aErrorOCR = " Error no existe plantilla asociada a la imagen";
                 nSwEnvioCorreo = 1;
                 ||Si es error de plantilla, NO muestra el MENAV.
                 |SI enSwModoSilencio = 1;
                     eaErrorDsEscan = "<dsEscan> No existe plantilla asociada a la imagen";
                     enNumRegDsEscan = #dsarm005#0;
                 |FINSI;
             |SINO;
                 aMensaje = "0000<dsEscan> " + aErrorOCR;
                 |SI enSwModoSilencio = 1;
                     eaErrorDsEscan = "<dsEscan> " + aErrorOCR;
                     enNumRegDsEscan = #dsarm005#0;
                 |SINO;
                     |SI enMensaOCX = 0;
                         |MENAV aMensaje;
                     |FINSI;
                 |FINSI;
             |FINSI;
         |SINO;
             |HAZ Integridad;
         |FINSI;
     |FINSI;

     aBorraCache2 = aRespuestaOCR;

     aOrigen  = aRespuestaOCR;
     aNomFichero = #dsarm005#9 < "";
     |QBF aNomFichero;
     aDestino = aDirBaseServidor + aNomFichero + ".txt";
     |QBT aDestino;

     |SI aIPRemoto ! "";
         |RECIBE_FICHERO aOrigen, aDestino;
     |SINO;
         |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     aFicheroOCR = aDestino;
     |SI PARAMETRO ! ""; |Y #dsarm004#78 ! 0;
         |HAZ AplicaPlantillasOCR;
     |FINSI;

     aOrigen  = aRespuestaOCR;
     aDestino = #dsarm005#7;               |QBF aDestino;
     aDestino = aDestino + #dsarm005#9;    |QBF aDestino;
     aDestino = aDestino + ".txt";

     |SI #dsarm001#7 = "N";
         |SI aIPRemoto ! "";
             |RECIBE_FICHERO aOrigen, aDestino;
         |SINO;
             |RCOPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |SINO;
         |RCOPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |SI nSwEnvioCorreo = 1;
         efFechaOCR = #dsarm034#0;
         eaHoraOCR  = #dsarm034#1;

         |HAZ CorreoNoPlantilla;
         nSwEnvioCorreo = 0;
     |FINSI;
|FPRC;

|PROCESO AplicaTIF;
     |HAZ Identify;

     aRespuestaOCR = aDirBaseResOCR + aNomResOCR;
     |RFBORRA aRespuestaOCR;

     |SI nErrorIdentify = 1;
         |XABRE "ABC", aRespuestaOCR, nHandle;

         aAlfa = "IMAGEN NO VALIDA" + &13 + &10;
         |XGRABA nHandle, aAlfa;

         |SI nParam1 < #dsarm001#176; |O nParam2 < #dsarm001#177;
             eaAlfa = "Resoluci¢n de la imagen: " + nParam1 + " X " + nParam2;
             eaAlfa = eaAlfa + " es inferior a la de los par metros de la aplicaci¢n: " + #dsarm001#176 + " X " + #dsarm001#177;
             eaAlfa = eaAlfa + &13 + &10;
             |HAZ QuitaRaros;

             |XGRABA nHandle, eaAlfa;
         |FINSI;

         |SI nParam3 > #dsarm001#175;
             eaAlfa = "Tama¤o de la imagen: " + nParam3 + " es superior a la de los par metros de la aplicaci¢n: "  + #dsarm001#175;
             eaAlfa = eaAlfa + &13 + &10;
             |HAZ QuitaRaros;

             |XGRABA nHandle, eaAlfa;
         |FINSI;

         |XCIERRA nHandle;
     |FINSI;

     |SI nErrorIdentify = 0;
         |HAZ LanzaDSESCAN;
     |FINSI;

     |HAZ TrataRespuesta;
|FPRC;

|PROCESO AplicaResto;
     aAlfa = aDestino + ".txt";  |RFBORRA aAlfa;
     aLogOCR = aDestino + ".log";
     aAlfa = aLogOCR; |RFBORRA aAlfa;

     |SI aTipoDoc = "pdf";
         aAlfa = aDirBaseLocal + "pdftotext/pdftotext.exe " + aDestino + " " + aDestino + ".txt";
         aAlfa = aAlfa + " -enc Latin1 -layout";
     |SINO;
         |SI aTipoDoc = "doc"; |O aTipoDoc = "xls";
             aAlfa = aDirBaseLocal + "dsofficetxt/dsofficetxt.exe " + aDestino + " " + aDestino + ".txt";
         |SINO;
             |ACABA;
         |FINSI;
     |FINSI;

     |RSYSTEM aAlfa;

     nSwErrorOCR = 0;
     aAlfa = aDestino + ".txt";
     |PARA;  |SI;  |HACIENDO;
          |XABRE "EC", aAlfa, nHandle;
          |SI FSalida ] 0;  |SAL;  |FINSI;

          |XABRE "EC", aLogOCR, nHandle;
          |SI FSalida ] 0;
              |SLEEP 1;
              |XABRE "CU", aLogOCR, nHandleOCR;
              |SI FSalida ] 0;
                  |PARA; |SI; |HACIENDO;
                       |XLEE nHandleOCR, 250, aLinea;
                       |SI FSalida < 0;  |SAL;  |FINSI;

                       aAux = aLinea - "Error";
                       |SI aAux ! aLinea;
                           nSwErrorOCR = 1;
                           aErrorOCR = aLinea;
                           |SAL;
                       |FINSI;
                  |SIGUE;
              |FINSI;

              |SAL;
          |FINSI;

          |SLEEP 1;
     |SIGUE;

     |RFBORRA aDestino;

     |SI nSwErrorOCR = 1 ;
         aMensaje = "0000Error OCR: " + aErrorOCR;
         |QBF aMensaje;
         |SI enMensaOCX = 0; |Y enSwModoSilencio = 0;
             |MENAV aMensaje;
         |FINSI;
         |ACABA;
     |SINO;
         aOrigen  = aAlfa;
         aDestino = aDirBaseServidor + #dsarm005#9;
         |QBF aDestino;
         aDestino = (aDestino + ".txt") < "";
         |QBT aDestino;

         |SI aIPRemoto ! "";
             |RECIBE_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;

         aFicheroOCR = aDestino;
         |SI eaAutoSelPlantilla = "S";
             |HAZ FiltroPlantillas;
         |SINO;
             |SI eaImpoAlbaVta = "S";
                 |HAZ FiltroAlbaVta;
             |FINSI;
         |FINSI;

         |SI enGrupoFiltro ! 0;
             |ABRE #dsarm004;
             |DDEFECTO #dsarm004;
             #dsarm004#0 = enGrupoFiltro;
             #dsarm004#1 = enSubGrupoFiltro;
             #dsarm004#2 = enTipoFiltro;
             |LEE 000#dsarm004.=;
             |CIERRA #dsarm004;
         |FINSI;

         |SI PARAMETRO ! ""; |Y #dsarm004#78 ! 0;
             |HAZ AplicaPlantillasOCR;
         |FINSI;
     |FINSI;

     |RFBORRA aOrigen;

     |PULSATECLA;
|FPRC;

|PROCESO dsarm034_esta;
     nSwEstaDsEscan = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE dsarm034_esta;
 #dsarm034#2;
 ;
 #dsarm005#0;
 #dsarm005#0;
 ;
 NULL, dsarm034_esta;
|FIN;

|PROCESO dsarm005_ocr;
     |SI enSwNomina ! 0; || esto desde laboral no me hace falta y me esta
          |ACABA;        || dando problemas a la hora de convertir los PDF a
     |FINSI;             || TIF. Me lo cargo (Migue 16.05.2014)

     nSwEstaDsEscan = 0;
     |SI eaAutoSelPlantilla = "S"; |O eaImpoAlbaVta = "S";
          nSwEstaDsEscan = 0;
     |SINO;
          |SI enSwReintentarOCR = 0;
               |BUCLE dsarm034_esta;
          |FINSI;
     |FINSI;

     |SI nSwEstaDsEscan = 1;
          |ACABA;
     |FINSI;

     |ABRE #dsarm004;
     #dsarm004#0 = #dsarm005#1;
     #dsarm004#1 = #dsarm005#2;
     #dsarm004#2 = #dsarm005#3;
     |LEE 101#dsarm004.=;
     |SI FSalida = 0;
         |SI #dsarm004#91 = 0;
             #dsarm004#91 = 1;
             #dsarm004#92 = "Facturas recibidas";
         |FINSI;

         |GRABA 020#dsarm004.a;
         |LIBERA #dsarm004;
     |FINSI;
     |CIERRA #dsarm004;

     |SI #dsarm004#91 = 2;  |Y nRecogeRes = 0;
         |ACABA;
     |FINSI;

     |ABRE #dsarm041;
     #dsarm041#0 = #dsarm004#91;
     |LEE 000#dsarm041.=;
     |SI FSalida ! 0;  |DDEFECTO #dsarm041;  |FINSI;
     |CIERRA #dsarm041;

     aIPRemoto   = "";
     |IP_REMOTO aIPRemoto;

     aAlfa = #dsarm005#9 < "";  |QBF aAlfa;
     aAlfa = aAlfa % -103;
     aTipoDoc = aAlfa;

     |SI aTipoDoc ! "bmp";  |Y aTipoDoc ! "tif";  |Y aTipoDoc ! "pdf";
      |Y aTipoDoc ! "htm";  |Y aTipoDoc ! "xml";  |Y aTipoDoc ! "txt";
      |Y aTipoDoc ! "jpg";  |Y aTipoDoc ! "jpe";  |Y aTipoDoc ! "png";
      |Y aTipoDoc ! "doc";  |Y aTipoDoc ! "xls";  |Y aTipoDoc ! "iff";
         |ACABA;
     |FINSI;

     |SI eaAutoSelPlantilla ! "S"; |Y eaImpoAlbaVta ! "S";
          |SI #dsarm001#45 = "N";
               |SI aTipoDoc = "htm"; |O aTipoDoc = "xml";
                |O aTipoDoc = "txt"; |O aTipoDoc = "doc"; |O aTipoDoc = "xls";
                    |ACABA;
               |FINSI;
          |FINSI;

          |SI #dsarm001#168 = "N";
               |SI aTipoDoc = "bmp"; |O aTipoDoc = "jpg"; |O aTipoDoc = "jpe";
                |O aTipoDoc = "tif"; |O aTipoDoc = "png"; |O aTipoDoc = "iff";       ||El "iff" es para los ".tiff".
                |O aTipoDoc = "pdf";
                    |ACABA;
               |FINSI;
          |FINSI;
     |FINSI;

     aFichero = #dsarm005#7;   |QBF aFichero;
     aFichero = aFichero + #dsarm005#9;
     |QBF aFichero;

     aOrigen  = aFichero;

     |SI aTipoDoc = "htm";  |O aTipoDoc = "xml";  |O aTipoDoc = "txt";
          |HAZ AplicaHTM;

          |ACABA;
     |FINSI;

     aDestino = aDirBaseLocal + #dsarm005#9;
     |QBF aDestino;

     aNomResOCR = #dsarm005#9;
     |QBF aNomResOCR;
     aNomResOCR = aNomResOCR + ".txt";

     |SI #dsarm001#7 = "N";
         |SI aIPRemoto ! "";
             |ENVIA_FICHERO aOrigen, aDestino;
         |SINO;
             |COPIA_FICHERO aOrigen, aDestino;
         |FINSI;
     |SINO;
         |RCOPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |SI aIPRemoto = "";
         |XABRE "E", aDestino, nHandle;
     |SINO;
         |XABRE "EC", aDestino, nHandle;
     |FINSI;

     |SI FSalida < 0;  |ACABA;  |FINSI;

     nPasaIdenty = 1;

     |ABRE #dsarm034;
     #dsarm034#0 = efFechaOCR;
     #dsarm034#1 = eaHoraOCR;
     #dsarm034#2 = #dsarm005#9;
     |LEE 000#dsarm034.=;
     |SI FSalida = 0;
         nNoPasaOCR  = 0;
         nPasaIdenty = 0;
     |FINSI;
     |CIERRA #dsarm034;

     |SI nNoPasaOCR = 1;
         |SI eaHoraOCR ! "";
             fFechaOCR = efFechaOCR;
             aHoraOCR  = eaHoraOCR;
         |SINO;
             |HORA aHoraOCR;
             fFechaOCR = ~;
             aHoraOCR  = aHoraOCR % 105;
         |FINSI;

         aFicOCR   = #dsarm005#9;  |QBF aFicOCR;

         |HORA aHoraEnv;

         |HAZ GrabaResultadoOCR;

         efFechaOCR = #dsarm034#0;
         eaHoraOCR  = #dsarm034#1;
         |HAZ CorreoNoPlantilla;

         nSwEnvioCorreo = 0;

         |ACABA;
     |FINSI;

     |SI nRecogeRes = 1;
         aRespuestaOCR = aDirBaseResOCR + aNomResOCR;
         |RFBORRA aRespuestaOCR;

         |HAZ LanzaDSESCAN;
         |HAZ TrataRespuesta;
     |SINO;
         |SI aTipoDoc = "jpg"; |O aTipoDoc = "png"; |O aTipoDoc = "jpe";
              |HAZ DeJPGaTIF;
         |FINSI;

         |SI aTipoDoc = "pdf";
             |HAZ AplicaPDF;
         |FINSI;

         |SI enSwDesde9 = 0;
              #dsarz013#0 = aDestino;
              |PINDA #0#dsarz013;
         |FINSI;

         |SI aTipoDoc = "tif"; |O aTipoDoc = "bmp"; |O aTipoDoc = "iff";
             |HAZ AplicaTIF;
         |SINO;
             |HAZ AplicaResto;
         |FINSI;
     |FINSI;

     |SI #dsarm001#181 = "S";
          |SI nSwPdf2TifUnix = 1; |Y aSistema = "ESUNIX";
               |SI aBorraCache ! "";
                    |RFBORRA aBorraCache;
               |FINSI;
          |FINSI;

          |SI aBorraCache2 ! "";
               |RFBORRA aBorraCache2;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsarm005_ocr;
     #dsarm005#1;
     ;
     000000001;
     999999999;
     ;
     NULL, dsarm005_ocr;
|FIN;

|PROCESO Tipo80;  |TIPO 80;
     FSalida = 2499;
|FPRC;

|PROCESO Mete30_cero;
     ||aResultado

     |ABRE #dsarm030;
     |DDEFECTO #dsarm030;
     #dsarm030#0 = nRegistro;
     #dsarm030#1 = 0;
     |LEE 101#dsarm030.=;
     |SI FSalida ! 0;
          #dsarm030#2 = aResultado;
          |GRABA 020#dsarm030.n;
     |FINSI;
     |LIBERA #dsarm030;
     |CIERRA #dsarm030;
|FPRC;

|PROCESO Mete30;
     |ABRE #dsarm030;
     |DDEFECTO #dsarm030;
     #dsarm030#0 = nRegistro;
     #dsarm030#1 = 99999;
     |LEE 000#dsarm030.];
     |SI FSalida = 0;
          |LEE 000#dsarm030.a;
     |SINO;
          |LEE 000#dsarm030.u;
     |FINSI;
     |SI FSalida = 0; |Y #dsarm030#0 = nRegistro;
          nUltimo = #dsarm030#1 + 1;
     |SINO;
          nUltimo = 1;
     |FINSI;
     |DDEFECTO #dsarm030;
     #dsarm030#0 = nRegistro;
     #dsarm030#1 = nUltimo;
     |LEE 101#dsarm030.=;
     |SI FSalida ! 0;
          #dsarm030#2 = aTextoLog;
          |GRABA 020#dsarm030.n;
     |FINSI;
     |LIBERA #dsarm030;
     |CIERRA #dsarm030;
|FPRC;

|PROCESO BuscaNombreNif;
     ||Nos devuelve de la Basica o Integral .. El nombre del NIF en cuestion

     ||Buscamos el Nombre del CIF
     |DBASS aPathBase;
     |QBF aPathBase;
     aAlfa = aPathBase + "integral/fich/dsam0103.dat";
     |XABRE "E", aAlfa, Handle1;
     |SI FSalida ] 0;
        aAlfa = aPathBase + "integral/def/dsam0103.mas";
        |CARGA_DEF aAlfa, Referen@;
        |SI FSalida = 0;
           aAlfa = aPathBase + "integral/fich/";
           |PATH_DAT #Referen@#aAlfa#;
           |ABRE #Referen@;
           #Referen@#0 = aNif;
           |LEE 000#Referen@.=;
           |SI FSalida = 0;
               aNombreNif = #Referen@#1;
               |QBF aNombreNif;
           |FINSI;
           |CIERRA #Referen@;
           |DESCARGA_DEF #Referen@;
        |FINSI;
     |FINSI;
     |SI aNombreNif = "";
          aAlfa = aPathBase + "basica/fich/agim0003.dat";
          |XABRE "E", aAlfa, Handle1;
          |SI FSalida ] 0;
             aAlfa = aPathBase + "basica/def/agim0003.mas";
             |CARGA_DEF aAlfa, Referen@;
             |SI FSalida = 0;
                aAlfa = aPathBase + "basica/fich/";
                |PATH_DAT #Referen@#aAlfa#;
                |ABRE #Referen@;
                #Referen@#0 = aNif;
                |LEE 000#Referen@.=;
                |SI FSalida = 0;
                    aNombreNif = #Referen@#1;
                    |QBF aNombreNif;
                |FINSI;
                |CIERRA #Referen@;
                |DESCARGA_DEF #Referen@;
             |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO QBI_z013;
     ||Varible:  aVerifica
     aAlfa = "";

     aLong = aVerifica % A0;
     nLong = aLong;
     |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
          aSaca = nVoy + "01";
          aLetra = aVerifica % aSaca;
          |SI aLetra ! " ";
               aAlfa = aVerifica % nVoy;
               |SAL;
          |FINSI;
     |SIGUE;

     |SI aAlfa ! "";
          aVerifica = aAlfa;
     |FINSI;
|FPRC;

|PROCESO Mete31;
     ||Quitar.

     |SI aCtrlTipo = "NUM";

          aValorEntrada = aValor;
          |QBF aValorEntrada;

          aVerifica = aValor;
          aAlfa = "";
          nCaracteres = 0;
          nGuiones = 0;
          aLong = aVerifica % A0;
          nLong = aLong;
          |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
               aSaca = nVoy + "01";
               aSaca = "-" + aSaca;
               aLetra = aVerifica % aSaca;

               |SI aLetra < "0"; |O aLetra > "9";
                    |SI aLetra = "-";        ||Signo negativo
                         aSaca2 = nVoy + "02";
                         aSaca2 = "-" + aSaca2;
                         aLetra2 = aVerifica % aSaca2;
                         |SI aLetra2 = ".-";
                              ||Para saltar este valor.
                              nVoy = nVoy + 1;
                         |SINO;
                              |SI nCaracteres ! 0;
                                   aAlfa = aLetra + aAlfa;
                                   |SAL;
                              |FINSI;
                         |FINSI;
                    |FINSI;
                    |SI aLetra = "."; |O aLetra = " "; |O aLetra = "'"; |O aLetra = ","; |O aLetra = "`";
                    ||MANOLO. PARA CONTROL DE LOS DECIMALES
                         |SI nCaracteres [ nDecimales;  |Y nCaracteres > 0; |Y nGuiones = 0;
                              aAlfa = "," + aAlfa;
                              nGuiones = nGuiones + 1;
                         |FINSI;
                    |FINSI;
                    ||No es un caracter numerico
               |SINO;
                    aAlfa = aLetra + aAlfa;
                    nCaracteres = nCaracteres + 1;
               |FINSI;
          |SIGUE;
          aVerifica = aAlfa;

          aValor = aVerifica;
     |FINSI;

     |SI aCtrlTipo = "NIF";
          aValorEntrada = aValor;
          |QBF aValorEntrada;

          nContaReal = 0;
          aVerifica = aValor;
          aAlfa = "";
          aLong = aVerifica % A0;
          nLong = aLong;
          |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
               aSaca = nVoy + "01";
               aLetra = aVerifica % aSaca;
               |SI aLetra = "-"; |O aLetra = "."; |O aLetra = " "; |O aLetra = "/"; |O aLetra = "\"; |O aLetra = ","; |O aLetra = ":"; |O aLetra = "?";
                    ||No hacemos nada. Estos caracteres son los que quitamos
               |SINO;
                    aAlfa = aAlfa + aLetra;
               |FINSI;
          |SIGUE;
          aVerifica = aAlfa;

          aValor = aVerifica;
          |QBF aValor;

          aVerifica = aValor;
          aAlfa = aVerifica % -109;
          aValor = aAlfa;
          |QBF aValor;

          enModoSilencio = 1;
          enHayErrorDni = 0;
          eaVarDni = aValor;
          enCalcCif = 0;
          |HAZ CalculoDNI;
          |QBF eaVarDni;
          |SI eaVarDni ! aValor; |O enHayErrorDni = 1;
               nContaReal = 0;
               aVerifica = aValor;
               aAlfa = "";
               aLong = aVerifica % A0;
               nLong = aLong;
               |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
                    aSaca = nVoy + "01";
                    aLetra = aVerifica % aSaca;
                    ||Tiquet 4182.117. Y Tiquet 700000.6393
                    ||Asumimos que el primer digito es una letra y el resto numeros
                    nContaReal = nContaReal + 1;
                    |SI nContaReal > 1;
                         |SI aLetra = "O"; |O aLetra = "o";
                              aLetra = "0";
                         |FINSI;
                         |SI aLetra = "L"; |O aLetra = "l";
                              aLetra = "1";
                         |FINSI;
                         |SI aLetra = "Z"; |O aLetra = "z";
                              aLetra = "2";
                         |FINSI;
                         |SI aLetra = "A";
                              aLetra = "4";
                         |FINSI;
                         |SI aLetra = "S"; |O aLetra = "s";
                              aLetra = "5";
                         |FINSI;
                         |SI aLetra = "G";
                              aLetra = "6";
                         |FINSI;
                         |SI aLetra = "B";
                              aLetra = "8";
                         |FINSI;
                         |SI aLetra = "q"; |O aLetra = "g";
                              aLetra = "9";
                         |FINSI;
                         aAlfa = aAlfa + aLetra;
                    |SINO;
                         ||El primer digito
                         |SI aLetra = "8";
                              aUltimaLetra = aVerifica % -101;
                              |SI aUltimaLetra ] "0"; |Y aUltimaLetra [ "9";
                                   aLetra = "B";
                              |FINSI;
                              aAlfa = aAlfa + aLetra;
                         |SINO;
                              aAlfa = aAlfa + aLetra;
                         |FINSI;
                    |FINSI;
               |SIGUE;
               aVerifica = aAlfa;
               aValor = aVerifica;
               |QBF aValor;
          |FINSI;
     |FINSI;

     |SI aCtrlTipo = "FEC";
          ||ARA. Hacemos control de formato FECHA
          aValorFecha = aValor;

          ||Primero quito los espacios en blanco por el inicio y por el final
          |QBF aValor;
          aVerifica = aValor;
          |HAZ QBI_z013;
          aValor = aVerifica;

          aDia = "";
          aMes = "";
          aAnyo = "";

          aValorMin = aValor < aValor;  ||Lo paso a minusculas

          nSwMesLetra = 0;
          ||Luego verifico si el mes esta en letra
          aAntes = aValorMin;
          aDespues = aValorMin - "ene";
          |SI aAntes ! aDespues;
               aMes = "01";
               nSwMesLetra = 1;
          |FINSI;
          aDespues = aValorMin - "feb";
          |SI aAntes ! aDespues;
               aMes = "02";
               nSwMesLetra = 1;
          |FINSI;
          aDespues = aValorMin - "mar";
          |SI aAntes ! aDespues;
               aMes = "03";
               nSwMesLetra = 1;
          |FINSI;
          aDespues = aValorMin - "abr";
          |SI aAntes ! aDespues;
               aMes = "04";
               nSwMesLetra = 1;
          |FINSI;
          aDespues = aValorMin - "may";
          |SI aAntes ! aDespues;
               aMes = "05";
               nSwMesLetra = 1;
          |FINSI;
          aDespues = aValorMin - "jun";
          |SI aAntes ! aDespues;
               aMes = "06";
               nSwMesLetra = 1;
          |FINSI;
          aDespues = aValorMin - "jul";
          |SI aAntes ! aDespues;
               aMes = "07";
               nSwMesLetra = 1;
          |FINSI;
          aDespues = aValorMin - "ago";
          |SI aAntes ! aDespues;
               aMes = "08";
               nSwMesLetra = 1;
          |FINSI;
          aDespues = aValorMin - "sep";
          |SI aAntes ! aDespues;
               aMes = "09";
               nSwMesLetra = 1;
          |FINSI;
          aDespues = aValorMin - "oct";
          |SI aAntes ! aDespues;
               aMes = "10";
               nSwMesLetra = 1;
          |FINSI;
          aDespues = aValorMin - "nov";
          |SI aAntes ! aDespues;
               aMes = "11";
               nSwMesLetra = 1;
          |FINSI;
          aDespues = aValorMin - "dic";
          |SI aAntes ! aDespues;
               aMes = "12";
               nSwMesLetra = 1;
          |FINSI;
          ||Si lo esta .. proceso MesLetra

          ||Ahora saco el Anyo y el Mes si aun no lo tengo.

          nSalto = 0;
          aLong = aVerifica % A0;
          nLong = aLong;
          |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
               aSaca = nVoy + "01";
               aSaca = "-" + aSaca;
               aLetra = aValor % aSaca;
               |SI aLetra ] "0"; |Y aLetra [ "9";
                    |SI nSalto = 0;
                         aAnyo = aLetra + aAnyo;
                    |SINO;
                         |SI nSwMesLetra = 0;
                              |SI nSalto = 1;
                                   aMes = aLetra + aMes
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |SINO;
                    nSalto = nSalto + 1;
                    |SI nSalto > 1;
                         |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;

          ||Por ultimo saco el dia.
          nSalto = 0;
          aLong = aVerifica % A0;
          nLong = aLong;
          |PARA nVoy = 1; |SI nVoy [ nLong; |HACIENDO nVoy = nVoy + 1;
               aSaca = nVoy + "01";
               aLetra = aValor % aSaca;
               |SI aLetra ] "0"; |Y aLetra [ "9";
                    |SI nSalto = 0;
                         aDia = aDia + aLetra;
                    |SINO;
                         |SAL;
                    |FINSI;
               |SINO;
                    nSalto = nSalto + 1;
                    |SI nSalto > 1;
                         |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;

          |SI aDia = ""; |O aMes = ""; |O aAnyo = "";
               ||Fecha incorrecta. NO toco nada. No puedo hacer el formato
               aValor = aValorFecha;
          |SINO;
               nDia = aDia;
               nMes = aMes;
               nAnyo = aAnyo;
               |SI nAnyo < 99;
                    nAnyo = nAnyo + 2000;
               |FINSI;
               |SI nDia = 0; |O nMes = 0; |O aAnyo = 0;
                    ||Fecha incorrecta. NO toco nada. No puedo hacer el formato
                    aValor = aValorFecha;
               |SINO;
                    ||Lo trasformo a este formato Dia.Mes.A¤o. y verifico que es una fecha valida

                    aDia = ("00" + nDia) % -102;
                    aMes = ("00" + nMes) % -102;
                    aAnyo = ("0000" + nAnyo) % -104;

                    aFecha = aDia + "." + aMes + "." + aAnyo;
                    fFecha = aFecha;

                    nFecha = fFecha;
                    fFechaDespues = nFecha;
                    |SI fFecha ! fFechaDespues;
                         ||Fecha incorrecta. NO toco nada. No puedo hacer el formato
                         aValor = aValorFecha;
                    |SINO;
                         fFechaFac = fFecha;
                         aFecha = fFecha;
                         |QBF aFecha;
                         |SI aFecha ! aValor;
                              aValor = aFecha;
                         |SINO;
                              aValor = aValorFecha;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |ABRE #dsarm031;
     |DDEFECTO #dsarm031;
     #dsarm031#0 = nRegistro;
     #dsarm031#1 = nCampoDestino;
     |LEE 101#dsarm031.=;
     |SI FSalida ! 0; |GRABA 020#dsarm031.b; |FINSI;
     #dsarm031#2 = aValor;
     |GRABA 020#dsarm031.a;
     |LIBERA #dsarm031;

     |SI nCampoDestino = 10;      ||NIF. Buscamos el nombre.
          aNif = aValor;
          |QBF aNif;
          aNombreNif = "";
          |HAZ BuscaNombreNif;
          |DDEFECTO #dsarm031;
          #dsarm031#0 = nRegistro;
          #dsarm031#1 = 38;        ||Nombre NIF
          |LEE 101#dsarm031.=;
          |SI FSalida ! 0; |GRABA 020#dsarm031.b; |FINSI;
          |SI aNombreNif = "";
               #dsarm031#2 = "NIF NO REGISTRADO";
          |SINO;
               #dsarm031#2 = aNombreNif;
          |FINSI;
          |GRABA 020#dsarm031.a;
          |LIBERA #dsarm031;
     |FINSI;

     |CIERRA #dsarm031;
|FPRC;

|PROCESO AplicaPlantillasOCR;
     fFecha = ~;
     aFecha = fFecha;
     |HORA aHora;
     |QBF aHora;

     aTextoLog = aFecha + " " + aHora + " Inicio. Aplicando Plantilla " + #dsarm004#78;
     |HAZ Mete30;

     aTextoLog = "Fichero OCR a procesar: " + aFicheroOCR;
     |HAZ Mete30;

     aMensaje = "0000Tengo que aplicar la plantilla " + #dsarm004#78;
     |SI enMensaOCX = 0;
         ||MENAV aMensaje;
     |FINSI;

     |ABRE #dsarm029;
     |DDEFECTO #dsarm029;
     #dsarm029#0 = #dsarm004#78;
     |LEE 000#dsarm029.=;
     |SI FSalida ! 0;
          aTextoLog = "Error: Plantilla " + #dsarm004#78 + " NO encontrada";
          |HAZ Mete30;

          |HORA aHora;
          |QBF aHora;
          aTextoLog = aFecha + " " + aHora + " Final. Aplicando Plantilla " + #dsarm004#78;
          |HAZ Mete30;

          aResultado = "ERROR";
          |HAZ Mete30_cero;

          |HAZ MeteTextoOCR;

          |ACABA;
     |FINSI;

     |XABRE "E", aFicheroOCR, nHandle;
     |SI FSalida < 0;
          aTextoLog = "Error: No puedo abrir o no encuentro el fichero resultado OCR " + aFicheroOCR;
          |HAZ Mete30;
          aResultado = "ERROR";
          |HAZ Mete30_cero;

          |HORA aHora;
          |QBF aHora;
          aTextoLog = aFecha + " " + aHora + " Final. Aplicando Plantilla " + #dsarm004#78;
          |HAZ Mete30;
          |ACABA;
     |FINSI;

     aSwEncabezado = #dsarm029#2;
     aTextoEncabezado = #dsarm029#3;
     |QBF aTextoEncabezado;
     |SI aTextoEncabezado = "";
          aSwEncabezado = "N";
     |FINSI;

     nError = 0;
     |PARA nConta = 1; |SI nConta [ 20; |HACIENDO nConta = nConta + 1;
          nSwFound = 0;
          aValor = "";
          nVoy = nConta * 4;
          aBusca = #dsarm029#nVoy#;
          |QBF aBusca;
          nVoy = nVoy + 1;
          nLetras = #dsarm029#nVoy#;
          nVoy = nVoy + 1;
          nCampoDestino = #dsarm029#nVoy#;

          nVoyCtrlTipo = 84 + nConta;
          aCtrlTipo = #dsarm029#nVoyCtrlTipo#;
          |QBF aCtrlTipo;

          |SI aBusca ! ""; |Y nLetras ! 0; |Y nCampoDestino ! 0;
               |HAZ BuscaTextoOCR;
               |SI nSwFound = 0;
                    ||ERROR. No encuentra el Texto.
                    nError = 1;
                    aTextoLog = "No encuentra el texto: " + aBusca;
                    |HAZ Mete30;
               |SINO;
                    |HAZ Mete31;
               |FINSI;
          |FINSI;
     |SIGUE;
     |CIERRA #dsarm029;

     |SI nError = 0;
          aResultado = "CORRECTO";
          |HAZ Mete30_cero;

          |HORA aHora;
          |QBF aHora;
          aTextoLog = aFecha + " " + aHora + " Final. Aplicando Plantilla " + #dsarm004#78;
          |HAZ Mete30;
     |SINO;
          aResultado = "ERROR";
          |HAZ Mete30_cero;

          |HORA aHora;
          |QBF aHora;
          aTextoLog = aFecha + " " + aHora + " Final. Aplicando Plantilla " + #dsarm004#78;
          |HAZ Mete30;

          |HAZ MeteTextoOCR;
     |FINSI;
|FPRC;

|PROCESO MeteTextoOCR;
     aTextoLog = "";
     |HAZ Mete30;
     aTextoLog = " * * * Texto resultado proceso OCR * * *";
     |HAZ Mete30;
     aTextoLog = "";
     |HAZ Mete30;

     aAcumula = "";
     |XABRE "BU", aFicheroOCR, nHandle;
     |SI FSalida ] 0;
          |PARA; |SI; |HACIENDO;
               |XLEE nHandle, 1, aLetra;
               |SI FSalida [ 0; |SAL; |FINSI;
               |SI aLetra = a13; |O aLetra = a10;
                    |SI nSwReturn = 1;
                         nSwReturn = 0;
                    |SINO;
                         nSwReturn = 1;
                         aTextoLog = aAcumula;
                         |HAZ Mete30;
                         aAcumula = "";
                    |FINSI;
               |SINO;
                    aAcumula = aAcumula + aLetra;
                    aLong = aAcumula % A0;
                    nLong = aLong;
                    |SI nLong > 98;          ||Tama¤o para verse por pantalla
                         nSwReturn = 1;
                         aTextoLog = aAcumula;
                         |HAZ Mete30;
                         aAcumula = "";
                    |FINSI;
               |FINSI;
          |SIGUE;

          |XCIERRA nHandle;

          |SI aAcumula ! "";
               aTextoLog = aAcumula;
               |HAZ Mete30;
          |FINSI;
     |FINSI;

     aTextoLog = "";
     |HAZ Mete30;
     aTextoLog = " * * * FINAL Texto resultado proceso OCR * * *";
     |HAZ Mete30;
|FPRC;

|PROCESO BuscaTextoOCR;
     |XABRE "BU", aFicheroOCR, nHandle;
     |SI FSalida ] 0;
          |SI aSwEncabezado = "S";
               |HAZ BuscaEncabezado;
               |SI nSwHayEncabezado = 0;
                    ||Lo pongo a cero.
                    |XPOSICION nHandle, 1, 0;
               |FINSI;
          |FINSI;

          |HAZ BuscaCampo;
          |XCIERRA nHandle;
     |FINSI;
|FPRC;

|PROCESO BuscaTextoOCRFiltro;
     |XABRE "BU", aFicheroOCR, nHandle;
     |SI FSalida ] 0;
          |SI aSwEncabezado = "S";
               |HAZ BuscaEncabezado;
               |SI nSwHayEncabezado = 0;
                    nSwFound = 0;
               |SINO;
                    |HAZ BuscaCampoFiltro;
                    |XCIERRA nHandle;
               |FINSI;
          |SINO;
               |HAZ BuscaCampoFiltro;
               |XCIERRA nHandle;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BuscaEncabezado;
     aTextoParcial = "";
     nSwHayEncabezado = 0;
     aLong = aTextoEncabezado % A0;
     nLong = aLong;
     |PARA; |SI; |HACIENDO;
          |XLEE nHandle, 1, aLetra;
          |SI FSalida [ 0; |SAL; |FINSI;

          |SI aLetra ! aTab; |Y aLetra ! a13; |Y aLetra ! a10;
               aTextoParcial = aTextoParcial + aLetra;
               aLong = aTextoParcial % A0;
               nLongParcial = aLong;
               |SI nLongParcial > nLong;
                    ||Le quito el primer caracter
                    aTextoParcial = aTextoParcial % 2;
                    |SI aTextoParcial = aTextoEncabezado;
                         nSwHayEncabezado = 1;
                         |SAL;
                    |FINSI;
               |SINO;
                    |SI nLongParcial = nLong;
                         |SI aTextoParcial = aTextoEncabezado;
                              nSwHayEncabezado = 1;
                              |SAL;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO MiraFechaconBarras;
     aBarra1 = aValor % 301;
     aBarra2 = aValor % 601;

     aDia = aValor % 102;
     aMes = aValor % 402;
     aAny = aValor % -104;

     aFechaBuena = aDia + "." + aMes + "." + aAny;

     fFechaBuena = aFechaBuena;
     nFechaBuena = fFechaBuena;
     fFechaOtra = nFechaBuena;
     |SI fFechaBuena = fFechaOtra;
          aValor = aFechaBuena;
     |FINSI;
|FPRC;

|PROCESO BuscaCampo;
     aValor = "";
     nSwFound = 0;
     aTextoParcial = "";
     aLong = aBusca % A0;
     nLong = aLong;
     |PARA; |SI; |HACIENDO;
          |XLEE nHandle, 1, aLetra;
          |SI FSalida [ 0; |SAL; |FINSI;
          |SI aLetra ! aTab; |Y aLetra ! a13; |Y aLetra ! a10;
               |SI nSwFound = 1;
                    aValor = aValor + aLetra;
                    |SI aValor = " ";
                         aValor = "";
                    |FINSI;

                    aLong = aValor % A0;
                    nLongBueno = aLong;
                    |SI nLongBueno = nLetras;

                         |SI nLetras = 10;
                              |HAZ MiraFechaconBarras;
                         |FINSI;

                         ||Tiquet 4182.34
                         eaAlfa = aValor;
                         |QBF eaAlfa;
                         |HAZ QuitaRaros;
                         aValor = eaAlfa;

                         |ACABA;
                    |FINSI;
               |SINO;
                    aTextoParcial = aTextoParcial + aLetra;
                    aLong = aTextoParcial % A0;
                    nLongParcial = aLong;
                    |SI nLongParcial > nLong;
                         ||Le quito el primer caracter
                         aTextoParcial = aTextoParcial % 2;
                         |SI aTextoParcial = aBusca;
                              nSwFound = 1;
                              ||OKIE. ENCONTRADO.
                         |FINSI;
                    |SINO;
                         |SI nLongParcial = nLong;
                              |SI aTextoParcial = aBusca;
                                   nSwFound = 1;
                                   ||OKIE. ENCONTRADO.
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI aLetra = a13; |O aLetra = a10;
                    |SI nSwFound = 1;
                         ||Tiquet 4182.34
                         eaAlfa = aValor;
                         |QBF eaAlfa;
                         |HAZ QuitaRaros;
                         aValor = eaAlfa;

                         aLong = aValor % A0;
                         nLongBueno = aLong;
                         |SI nLongBueno = 10;
                              |HAZ MiraFechaconBarras;
                         |FINSI;

                         |ACABA;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO BuscaCampoFiltro;
     aValor = "";
     nSwFound = 0;
     aTextoParcial = "";
     aLong = aBusca % A0;
     nLong = aLong;
     |PARA; |SI; |HACIENDO;
          |XLEE nHandle, 1, aLetra;
          |SI FSalida [ 0; |SAL; |FINSI;
          |SI aLetra ! aTab; |Y aLetra ! a13; |Y aLetra ! a10;
               aTextoParcial = aTextoParcial + aLetra;
               aLong = aTextoParcial % A0;
               nLongParcial = aLong;
               |SI nLongParcial > nLong;
                    ||Le quito el primer caracter
                    aTextoParcial = aTextoParcial % 2;
                    |SI aTextoParcial = aBusca;
                         nSwFound = 1;
                         |SAL;
                         ||OKIE. ENCONTRADO.
                    |FINSI;
               |SINO;
                    |SI nLongParcial = nLong;
                         |SI aTextoParcial = aBusca;
                              nSwFound = 1;
                              |SAL;
                              ||OKIE. ENCONTRADO.
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO SacaPathyNombre;
     ||Devuelve aPathCinco y aNombreCinco

     aPathCinco = "";
     aNombreCinco = "";
     nSwPrimeraParte = 1;
     aLong = aResto % A0;
     nLong = aLong;
     |PARA nConta = 1; |SI nConta [ nLong; |HACIENDO nConta = nConta + 1;
          nCampo = nConta * 100;
          nCampo = nCampo + 1;
          aLetra = aResto % nCampo;
          |SI aLetra = aSeparador;
               nSwPrimeraParte = 0;
          |SINO;
               |SI nSwPrimeraParte = 1;
                    aPathCinco = aPathCinco + aLetra;
               |SINO;
                    aNombreCinco = aNombreCinco + aLetra;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO AveriguaINI;
     aSerie = "";
     |ESPECIFICA "SERIALIZACION", aSerie;
     aIni = FSalida;          ||Antes esto lo devolvia en la variable aSerie
     aIni = aIni % 106;       ||Esto es el numero de ORO. Los 6 primeros digitos
     nIni = aIni;
     aIni = ("000000" + nIni) % -106;

     |DBASE aBase;  |QBF aBase;
     |HAZ QuitaBarras;

     nRegistro = PARAMETRO;
     aParamIni = aIni + aAuxBarra + (("000000000" + nRegistro) % -109);
|FPRC;

|PROCESO QuitaVentana;
     |SI enSwDesde9 = 0;
         |FINVENTANA nVentana;
     |FINSI;
|FPRC;

|PROCESO LeeDocumento;
     nRegistro          = PARAMETRO;
     nSwAplicaPlantilla = 0;

     |ABRE #dsarm031;

     aNombreFichero = "";
     |DDEFECTO #dsarm031;
     #dsarm031#0 = nRegistro;
     #dsarm031#1 = 0;
     |LEE 000#dsarm031.=;
     |SI FSalida = 0;
         aDatosCinco = #dsarm031#2;  |QBF aDatosCinco;
         |SI eaAutoSelPlantilla = "S"; |O eaImpoAlbaVta = "S";
                  |SI eaImpoAlbaVta = "S";
                       |ACABA;
                  |FINSI;
                  aGrupoCinco = aDatosCinco % 103;
                  nGrupoCinco = aGrupoCinco;
                  aSubGrupoCinco = aDatosCinco % 503;
                  nSubGrupoCinco = aSubGrupoCinco;
                  aTipoCinco = aDatosCinco % 903;
                  nTipoCinco = aTipoCinco;

                  |ABRE #dsarm004;
                  |DDEFECTO #dsarm004;
                  #dsarm004#0 = nGrupoCinco;
                  #dsarm004#1 = nSubGrupoCinco;
                  #dsarm004#2 = nTipoCinco;
                  |LEE 000#dsarm004.=;
                  |CIERRA #dsarm004;

                  nNoSeEscanea = 0;
                  nSwAplicaPlantilla = 0;
         |SINO;
              |SI aDatosCinco ! "";
                  aGrupoCinco = aDatosCinco % 103;
                  nGrupoCinco = aGrupoCinco;
                  aSubGrupoCinco = aDatosCinco % 503;
                  nSubGrupoCinco = aSubGrupoCinco;
                  aTipoCinco = aDatosCinco % 903;
                  nTipoCinco = aTipoCinco;
                  aResto = aDatosCinco % 13;
                  |HAZ SacaPathyNombre;

                  ||Devuelve aPathCinco y aNombreCinco

                  aNombreFichero = aNombreCinco;
                  |ABRE #dsarm004;
                  |DDEFECTO #dsarm004;
                  #dsarm004#0 = nGrupoCinco;
                  #dsarm004#1 = nSubGrupoCinco;
                  #dsarm004#2 = nTipoCinco;
                  |LEE 000#dsarm004.=;
                  |CIERRA #dsarm004;
                  nSwAplicaPlantilla = 1;
              |SINO;
                  |ABRE #dsarm005;
                  #dsarm005#0 = PARAMETRO;
                  |LEE 000#dsarm005.=;
                  |SI FSalida = 0;
                      aNombreFichero = #dsarm005#9;
                      |ABRE #dsarm004;
                      |DDEFECTO #dsarm004;
                      #dsarm004#0 = #dsarm005#1;
                      #dsarm004#1 = #dsarm005#2;
                      #dsarm004#2 = #dsarm005#3;
                      |LEE 000#dsarm004.=;
                      |CIERRA #dsarm004;
                  |FINSI;
                  |CIERRA #dsarm005;
              |FINSI;
         |FINSI;
     |SINO;
         |ABRE #dsarm005;
         #dsarm005#0 = PARAMETRO;
         |LEE 000#dsarm005.=;
         |SI FSalida = 0;
             aNombreFichero = #dsarm005#9;
             |ABRE #dsarm004;
             |DDEFECTO #dsarm004;
             #dsarm004#0 = #dsarm005#1;
             #dsarm004#1 = #dsarm005#2;
             #dsarm004#2 = #dsarm005#3;
             |LEE 000#dsarm004.=;
             |CIERRA #dsarm004;
         |FINSI;
         |CIERRA #dsarm005;
     |FINSI;
     |CIERRA #dsarm031;

     |SI #dsarm004#81 = "N";
          |SI #dsarm001#45 = "S";
                aAuxAux = aNombreFichero < "";
                |QBF aAuxAux;
                aAuxAux = aAuxAux % -103;
                |SI aAuxAux = "doc"; |O aAuxAux = "xls";
                     nNoSeEscanea = 0;
                |SINO;
                     nNoSeEscanea = 1;
                |FINSI;
          |SINO;
                nNoSeEscanea = 1;
          |FINSI;
          |ACABA;
     |FINSI;
|FPRC;

|PROCESO DesdeDSPARTES;
     |HORA eaHoraOCR;
     efFechaOCR      = ~;

     fFechaOCR = efFechaOCR;
     aHoraOCR  = eaHoraOCR;
     aFicOCR   = PARAMETRO - "DSPARTES";  |QBF aFicOCR;

     aAlfa     = ("p1" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #dsarm034#aAlfa#;

     aAlfa     = ("p2" + Usuario + "zzzzzzzz") % 108;
     |NOME_DAT #dsarm035#aAlfa#;

     |ABRE #dsarm034;  |CIERRA #dsarm034;  |DELINDEX #dsarm034;
     |ABRE #dsarm035;  |CIERRA #dsarm035;  |DELINDEX #dsarm035;

     |ABRE #dsarm034;
     |ABRE #dsarm035;

     aRespuestaOCR = "C:\DOCUMENTOS\DSARCHI\OCR\000000\" + aFicOCR;
     |HAZ SacaDatosRespuesta;
     |HAZ CompruebaActividad;

     |CIERRA #dsarm035;

     |HAZ GrabaResultadoOCR;
     |HAZ Integridad;

     |CIERRA #dsarm034;
|FPRC;

|PROCESO dsarm058;
     nSwHayPlantilla = 0;

     fFecha = ~;
     aFecha = fFecha;
     |HORA aHora;
     |QBF aHora;

     |ABRE #dsarm029;
     |DDEFECTO #dsarm029;
     #dsarm029#0 = #dsarm058#0;
     |LEE 000#dsarm029.=;
     |SI FSalida ! 0;
          |SI nPrimerError = 0;
               aTextoLog = "Error: Plantilla " + #dsarm004#78 + " NO encontrada";
               |HAZ Mete30;

               aResultado = "ERROR";
               |HAZ Mete30_cero;

               |HAZ MeteTextoOCR;

               nPrimerError = 1;
          |FINSI;
          |ACABA;
     |FINSI;

     |XABRE "E", aFicheroOCR, nHandle;
     |SI FSalida < 0;
          |SI nPrimerError = 0;
               nError = 1;
               aTextoLog = "No encuentra el fichero texto: " + aBusca;
               |HAZ Mete30;

               nPrimerError = 1;
          |FINSI;
          |ACABA;
     |FINSI;

     aSwEncabezado = #dsarm029#2;
     aTextoEncabezado = #dsarm029#3;
     |QBF aTextoEncabezado;
     |SI aTextoEncabezado = "";
          aSwEncabezado = "N";
     |FINSI;

     nTodosEncon = 1;
     nError = 0;
     |PARA nConta = 1; |SI nConta [ 20; |HACIENDO nConta = nConta + 1;
          nSwFound = 0;
          aValor = "";
          nVoy = nConta * 4;
          aBusca = #dsarm029#nVoy#;
          |QBF aBusca;
          |SI aBusca ! "";
               |HAZ BuscaTextoOCRFiltro;
               |SI nSwFound = 0;
                    nTodosEncon = 0;
               |SINO;
                    nSwHayPlantilla = 1;
               |FINSI;
          |FINSI;
     |SIGUE;
     |CIERRA #dsarm029;

     |SI nTodosEncon = 1; |Y nSwHayPlantilla = 1;
          enGrupoFiltro = #dsarm058#2;
          enSubGrupoFiltro = #dsarm058#3;
          enTipoFiltro = #dsarm058#4;
          nSwHayFiltro = 1;
          |ERROR10;
     |SINO;
          ||Se queda con el G/S/T que tiene.
          ||Sigo mirando el resto de plantillas.
     |FINSI;
|FPRC;

|DEFBUCLE dsarm058;
 #dsarm058#1;
 ;
 INICIO;
 FINAL;
 ;
 NULL, dsarm058;
|FIN;

|PROCESO BuscaTextoAlbaran;
     ||Leo linea a linea.
     ||Primero busco el literal: [PROCESOPI]

     ||Si es AV ..
     ||Ya busco las 3 variables y cargo los valores.

     ||AV000000_serie
     ||AV000000_numero
     ||AV000000_empresa


     nVoy = 1;
     nSwFound = 0;
     nSwFoundSer = 0;
     nSwFoundNum = 0;
     nSwFoundEmp = 0;

     |XABRE "U", aFicheroOCR, nHandle;
     |SI FSalida ] 0;
          |PARA; |SI; |HACIENDO;
               |XLEE nHandle, 255, aLinea;
               |SI FSalida < 0; |SAL; |FINSI;

               |SI nVoy = 1;
                    aBusca = "[PROCESOPI]";
               |SINO;
                    aBusca  = "AV000000_serie";
                    aBusca2 = "AV000000_numero";
                    aBusca3 = "AV000000_empresa";
               |FINSI;

               |SI nVoy = 1;
                    aLong = aBusca % A0;
                    nLong = aLong;

                    nSaca = 100 + nLong;
                    aSaca = nSaca;
                    aLetras = aLinea % aSaca;
                    |SI aLetras = aBusca;
                         nVoy = nVoy + 1;
                    |FINSI;
               |SINO;
                    |SI nSwFoundSer = 1; |Y nSwFoundNum = 1; |Y nSwFoundEmp = 1;
                         nSwFound = 1;
                         |SAL;
                         ||OKIE. ENCONTRADO.
                    |SINO;
                         |SI nSwFoundSer = 0;
                              aLong = aBusca % A0;
                              nLong = aLong;
                              nSaca = 100 + nLong;
                              aSaca = nSaca;
                              aLetras = aLinea % aSaca;
                              |SI aLetras = aBusca;
                                   nSwFoundSer = 1;
                                   aSerieOCR = aLinea - aBusca - aTab;
                                   aSerieOCR = aSerieOCR - a10 - a13;
                                   |QBT aSerieOCR;
                                   aSerieOCR = (aSerieOCR + "     ") % 105;
                              |FINSI;
                         |FINSI;
                         |SI nSwFoundNum = 0;
                              aLong = aBusca2 % A0;
                              nLong = aLong;
                              nSaca = 100 + nLong;
                              aSaca = nSaca;
                              aLetras = aLinea % aSaca;
                              |SI aLetras = aBusca2;
                                   nSwFoundNum = 1;
                                   aNumeroOCR = aLinea - aBusca2 - aTab;
                                   aNumeroOCR = aNumeroOCR - a10 - a13;
                                   |QBT aNumeroOCR;
                              |FINSI;
                         |FINSI;
                         |SI nSwFoundEmp = 0;
                              aLong = aBusca3 % A0;
                              nLong = aLong;
                              nSaca = 100 + nLong;
                              aSaca = nSaca;
                              aLetras = aLinea % aSaca;
                              |SI aLetras = aBusca3;
                                   nSwFoundEmp = 1;
                                   aEmpresaOCR = aLinea - aBusca3 - aTab;
                                   aEmpresaOCR = aEmpresaOCR - a10 - a13;
                                   |QBT aEmpresaOCR;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
     |SI nSwFoundSer = 1; |Y nSwFoundNum = 1; |Y nSwFoundEmp = 1;
          nSwFound = 1;

          enSwEstaAV = 0;
          eaSerieAV = aSerieOCR;
          enNumeroAV = aNumeroOCR;
          enEmpresaAV = aEmpresaOCR;
          |HAZ AVEstaEnDscomer9;

          |SI enSwEstaAV = 1;
               ||ARA39
               eaPathFichero = #dsarm005#7;
               |QBF eaPathFichero;
               eaPathFichero = eaPathFichero + #dsarm005#9;
               |QBF eaPathFichero;

               aEjecuta = "dsarz060";
               |SUB_EJECUTA_NP aEjecuta;

               ||SUB_EJECUTAMOS un proceso que mete el documento
               ||en el dserp. (ver codigo de impoz001)
          |SINO;
               ||El albaran NO existe, aunque el OCR ha funcionado bien.
               nSwFound = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO FiltroAlbaVta;
     ||Obtener la serie, numero Albaran y Empresa
     ||A partir de estos datos, enviar a G/S/T que corresponda
     ||Y al dserp.

     ||ARA3939

     enGrupoFiltro = 0;
     enSubGrupoFiltro = 0;
     enTipoFiltro = 0;

     ||ARA3939
     ||TODO CCC.
     ||Para pruebas.
     ||Descomentar esto.
     ||aFicheroOCR = "/u/dsasesor/dsarchi/ocr/albaran0001.pdf.txt";

     ||aMensaje = "0000Procesar el documento: " + aFicheroOCR;
     ||MENAV aMensaje;

     |XABRE "E", aFicheroOCR, nHandle;
     |SI FSalida < 0;
          |SI nPrimerError = 0;
               nError = 1;
               aTextoLog = "No encuentra el fichero texto: " + aFicheroOCR;
               |HAZ Mete30;

               nPrimerError = 1;
          |FINSI;

          enGrupoFiltro = #dsarm001#207;
          enSubGrupoFiltro = #dsarm001#208;
          enTipoFiltro = #dsarm001#209;
          nSwHayFiltro = 1;

          |ACABA;
     |FINSI;

     ||ARA3939
     nSwFound = 0;
     |HAZ BuscaTextoAlbaran;

     ||Tengo que leer el albaran en la dscomer9. para asegurarme
     ||que el OCR lo ha leido correctamente.

     |SI nSwFound = 1;
          enGrupoFiltro = #dsarm001#204;
          enSubGrupoFiltro = #dsarm001#205;
          enTipoFiltro = #dsarm001#206;
          nSwHayFiltro = 1;
     |SINO;
          enGrupoFiltro = #dsarm001#207;
          enSubGrupoFiltro = #dsarm001#208;
          enTipoFiltro = #dsarm001#209;
          nSwHayFiltro = 1;
     |FINSI;
|FPRC;

|PROCESO FiltroPlantillas;
     enGrupoFiltro = 0;
     enSubGrupoFiltro = 0;
     enTipoFiltro = 0;

     nPrimerError = 0;
     nSwHayFiltro = 0;
     |BUCLE dsarm058;

     |HORA aHora;
     |QBF aHora;
     |ABRE #dsarm053;
     |DDEFECTO #dsarm053;
     #dsarm053#0 = ~;
     #dsarm053#1 = aHora;
     #dsarm053#2 = #dsarm005#0;
     |LEE 101#dsarm053.=;
     |SI FSalida ! 0; |GRABA 020#dsarm053.b; |FINSI;
     #dsarm053#3 = "N";
     |SI nSwHayFiltro = 1;
          ||He encontrado el nuevo G/S/T destino
          ||Lo tengo que meter en el log.
          aAuxFiltro = (("000" + enGrupoFiltro) % -103) + "/" + (("000" + enSubGrupoFiltro) % -103) + "/" + (("000" + enTipoFiltro) % -103);
          aAuxFiltro = "AVISO. Documento enviado al G/S/T: " + aAuxFiltro + " Plantilla: " + #dsarm058#0;
     |SINO;
          ||Se almacenara en el G/S/T por defecto.
          ||Lo tengo que meter en el log.
          aAuxFiltro = (("000" + #dsarm004#0) % -103) + "/" + (("000" + #dsarm004#1) % -103) + "/" + (("000" + #dsarm004#2) % -103);
          aAuxFiltro = "AVISO. No encontrada ninguna Plantilla. Se almacena en G/S/T: " + aAuxFiltro;
     |FINSI;
     #dsarm053#4 = aAuxFiltro;
     #dsarm053#5 = eaDocCaptura;
     |GRABA 020#dsarm053.a;
     |LIBERA #dsarm053;
     |CIERRA #dsarm053;
|FPRC;

|PROCESO caclipro;
     aAlfa = #ficontab@#9;  |QBF aAlfa;
     |SI aAlfa = "";  |ACABA;  |FINSI;

     eaAlfa = #ficontab@#1;  |HAZ QuitaRaros;

     aAlfa = #ficontab@#9 + eaAlfa + &13 + &10;
     |XGRABA nHandleEnv, aAlfa;
|FPRC;

|DEFBUCLE caclipro;
     #ficontab@#1002;
     ;
     aTipo, "            ";
     aTipo, "zzzzzzzzzzzz";
     ;
     NULL, caclipro;
|FIN;

|PROCESO DsEnviaList;
     eaAdjuntoPLB   = aDestino;
     aIP            = #dsarw010#19;  |QBF aIP;
     eaServidorSMTP = aIP;
     eaPassPLB      = #dsarw010#22;
     eaUsuarioPLB   = #dsarw010#21;

     aFrom          = #dsarw010#1;   |QBF aFrom;
     eaOrigenPLB    = aFrom;
     eaDirRespoPLB  = eaOrigenPLB;

     aTo            = aEmailDestino;  |QBF aTo;
     eaDestinoPLB   = aTo;

     |DBASE aBase;  |QBF aBase;
     |HAZ QuitaBarras;

     aAsunto  = "FACTURA LISTADO CONTAMATICA " + ((aAuxExtension - ".") > "");

     aMensaje = "";
     |DBASE aBase;
     |QBF aBase;
     aCuerpo = aBase + "documentos";  |MKDIR aCuerpo;
     aCuerpo = aBase + "documentos/correos";  |MKDIR aCuerpo;
     aCuerpo = aCuerpo + "/listado.txt";
     |XABRE "WB", aCuerpo, nHandleC;
     |SI FSalida ] 0;
          aAlfa = "DOCUMENTO INFORMATIVO" + &13 + &10;
          |XGRABA nHandleC, aAlfa;
     |FINSI;
     |XCIERRA nHandleC;

     |SI #dsarw010#23 = "S";
          eaConfLecPLB = "S";
     |SINO;
          eaConfLecPLB = "N";
     |FINSI;
     eaAsuntoPLB = aAsunto;
     eaCuerpoPLB = aCuerpo;

     eaAlfa   = "Documento a CONTAMATICA.";
     eaAlfa   = eaAlfa + " Tipo imagen: " + aAsunto;
     eaAlfa   = eaAlfa + " Cod: " + aIni + aAuxBarra + (("000000000" + #dsarm005#0) % -109);

     aMensaje = "";
     |DBASE aBase;
     |QBF aBase;

     eaAsuntoPLB = aAsunto;
     eaCuerpoPLB = aCuerpo;

     enSwErrorCorreoPLB = 0;
     |HAZ DSEnviaCorreoPLB;
|FPRC;

|PROCESO  MandaCorreoList;
     |IP_REMOTO aIPRemoto;
     |QBF aIPRemoto;

     aAdjunto = aDestino;

     |SI aQueSistema = "ESDOS";
         |HAZ CorreoEnDos;
         |SI aIPRemoto ! "";
             |HAZ CorreoEnUnix;
         |FINSI;
     |SINO;
          |HAZ CorreoEnUnix;
     |FINSI;

     aIP = "";
     aIP = #dsarw010#18;  |QBF aIP;

     aFrom    = #dsarw010#1;   |QBF aFrom;
     aSalida  = #dsarw010#19;  |QBF aSalida;

     aTo      = aEmailDestino;
     |QBF aTo;

     |DBASE aBase;  |QBF aBase;
     |HAZ QuitaBarras;

     aAsunto  = "FACTURA LISTADO CONTAMATICA " + ((aAuxExtension - ".") > "");

     eaAlfa   = "Documento a CONTAMATICA.";
     eaAlfa   = eaAlfa + " Tipo imagen: " + aAsunto;
     eaAlfa   = eaAlfa + " Cod: " + aIni + aAuxBarra + "Listado";
     aMensaje = eaAlfa;

     |SI #dsarw010#20 = "N";
          aAutenti = aFrom;
     |SINO;
          aAutenti = #dsarw010#22;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + #dsarw010#21;
          |QBF aAutenti;
          aAutenti = aAutenti + ":" + aFrom;
     |FINSI;

     |SI #dsarw010#23 = "S";
          aAutenti = "!" + aAutenti;
     |FINSI;

     |DSCORREO_ENVIA aIP, aSalida, aAutenti, aTo, aAsunto, aMensaje, aAdjunto;
|FPRC;

|PROCESO Listado;
     |QBF eaNif;
     |HAZ AveriguaINI;

     |ABRE #dsarw010;
     |LEE 000#dsarw010.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarw010;  |FINSI;
     |CIERRA #dsarw010;

     |DBASS aBaseConta;   |QBF aBaseConta;

     aBaseConta = aBaseConta + "contagen/";
     aDirDatos  = aBaseConta + "fich/";

     aDef       = aBaseConta + "def/canempre";
     |CARGA_DEF aDef, ficontab@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     fFecha = ~;
     aAlfa  = fFecha % -102;
     nAnyo  = aAlfa;

     aDirDatEmp = "";
     |PATH_DAT #ficontab@#aDirDatos#;

     |ABRE #ficontab@;
     |SELECT #4#ficontab@;
     |PARA;  |SI nAnyo ] 10;  |HACIENDO nAnyo = nAnyo - 1;
          #ficontab@#2  = enEmpresa;
          #ficontab@#26 = nAnyo;
          |LEE 000#ficontab@.=;
          |SI FSalida = 0;
              aDirDatEmp = aDirDatos + (("00000" + enEmpresa) % -105) + #ficontab@#3 + "/";
              |SAL;
          |FINSI;
     |SIGUE;
     |CIERRA #ficontab@;
     |DESCARGA_DEF #ficontab@;

     |SI aDirDatEmp = "";  |ACABA;  |FINSI;

     aNomTgz     = "tgz" + Usuario;                     |QBF aNomTgz
     |DBASE aBase;  |QBF aBase;
     aDestinoTgz = aBase + "correos";                   |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/" + aNomTgz;         |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/";

     aDirectorio = aDestinoTgz;
     |HAZ BorraDir;

     aNomTgz     = "tgz" + Usuario;                     |QBF aNomTgz
     |DBASE aBase;  |QBF aBase;
     aDestinoTgz = aBase + "correos";                   |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/" + aNomTgz;         |MKDIR aDestinoTgz;
     aDestinoTgz = aDestinoTgz + "/";

     |HAZ QuitaBarras;

     |SI eaTipo = "1";  aTipo = "P";  |FINSI;
     |SI eaTipo = "2";  aTipo = "C";  |FINSI;

     aNomFichero = aIni + aAuxBarra + aTipo + eaNif;

     aAbre = aDestinoTgz + aNomFichero + ".txt";
     |XABRE "WB", aAbre, nHandleEnv;

     aDef       = aBaseConta + "def/caclipro";
     |CARGA_DEF aDef, ficontab@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;
     |PATH_DAT #ficontab@#aDirDatEmp#;

     |BUCLE caclipro;

     |DESCARGA_DEF #ficontab@;

     |XCIERRA nHandleEnv;

     nSwTgzOk = 0;
     aFicTar  = aDestinoTgz + aNomFichero + ".tar";
     aFicTar  = aFicTar + " " + aNomFichero +".txt";

     |ATAR aFicTar, aDestinoTgz;
     |SI FSalida = 0;
          aFicTar = aDestinoTgz + aNomFichero + ".tar";
          |COMPRIME aFicTar;
          |SI FSalida = 0;
               aBorra = aDestinoTgz + aNomFichero + ".tar";
               |FBORRA aBorra;
               aDestino = aDestinoTgz + aNomFichero + ".tgz";
               nSwTgzOk = 1;
          |FINSI;
     |FINSI;

     |SI nSwTgzOk = 0;  |ACABA;  |FINSI;

     enAprobacion = 0;
     eaPrograma = "DSENVIACORREO";
     |HAZ DSARCHI_INI;
     nSwDsEnviaCorreo = enAprobacion;

     aEmailDestino = #dsarm001#218;  |QBF aEmailDestino;
     |SI nSwDsEnviaCorreo = 1;
          |HAZ DsEnviaList;
     |SINO;
          |HAZ MandaCorreoList;
     |FINSI;
|FPRC;

|PROGRAMA;
     aTab = &9;
     a10 = &10;
     a13 = &13;

     |DBASE aBase;   |QBF aBase;
     aDirBaseServidor = aBase + "ocr";  |MKDIR aDirBaseServidor;
     aDirBaseServidor = aBase + "ocr/";

     |HAZ DimeUnidad;
     aDirBaseLocal = eaUnidad + ":\DOCUMENTOS";              |RMKDIR aDirBaseLocal;
     aDirBaseLocal = eaUnidad + ":\DOCUMENTOS\DSARCHI";      |RMKDIR aDirBaseLocal;
     aDirBaseLocal = eaUnidad + ":\DOCUMENTOS\DSARCHI\";

     aDirBaseResOCR = aDirBaseLocal + "ocr";  |RMKDIR aDirBaseResOCR;
     aDirBaseResOCR = aDirBaseLocal + "ocr\";

     |ABRE #dsarm001;
     |LEE 000#dsarm001.p;
     |SI FSalida ! 0;  |DDEFECTO #dsarm001;  |FINSI;
     |CIERRA #dsarm001;

     enAprobacion = 0;
     eaPrograma   = "OCREXTERNO";
     |HAZ DSARCHI_INI;
     nOcrExterno  = enAprobacion;

     enAprobacion = 0;
     eaPrograma   = "NOPASAOCR";
     |HAZ DSARCHI_INI;
     nNoPasaOCR   = enAprobacion;
     nRecogeRes   = enAprobacion;

     |SI PARAMETRO = "listado";
         |SI nOcrExterno = 1;
             |HAZ Listado;
         |FINSI;

         |ACABA;
     |FINSI;

     aAlfa = PARAMETRO - "MANDAOCR";
     |SI FSalida ! 0;
          aIni = "";
          |HAZ AveriguaINI;

          |ABRE #dsarm005;
          |DDEFECTO #dsarm005;
          #dsarm005#0 = aAlfa;
          |LEE 000#dsarm005.=;
          |SI FSalida ! 0;
               |CIERRA #dsarm005;
               |ACABA;
          |FINSI;
          |CIERRA #dsarm005;

          |HAZ CorreoNoPlantilla;

          |ACABA;
     |FINSI;

     aAlfa = PARAMETRO - "DSPARTES";
     |SI FSalida ! 0;
         |HAZ DesdeDSPARTES;
         eaQueProcesoPI   = "MD000000";
         |ACABA;
     |FINSI;


     |SI enSwADConta = 1;  |Y #dsarm001#178 = "N";
          |ACABA;
     |FINSI;

     |SI #dsarm001#45 = "N"; |Y #dsarm001#168 = "N";
          |ACABA;
     |FINSI;

     |SI #dsarm001#168 = "S";
          ||Esto lo pongo lo primero que todo, pq. parece que no va fino del todo
          ||y me estaba devolviendo un "0". Si lo ponemos aqui parece que ya va bien
          aIni = "";
          |HAZ AveriguaINI;
          |SI aIni = ""; |O aIni = "000000";
               aMensaje = "0000Problemas al obtener el número INI [" + aIni + "]";
               |SI enMensaOCX = 0;
                    |SI enSwModoSilencio = 0;
                         |MENAV aMensaje;
                    |FINSI;
               |FINSI;
               |ACABA;
          |FINSI;
     |FINSI;

     aParametro = PARAMETRO;
     |QBF aParametro;
     |SI aParametro = "BANDEJADSESCANMANUAL";
          ||Si tengo ocr/XXXXXXX.txt
          ||Meto un registro en la bandeja a partir de este documento (.txt)
          ||Es decir lo meto en dsarm034 y dsarm035.
          ||Y devuelo Fecha, Hora y Nombre archivo. (la clave).

          |ABRE #dsarm005;
          |DDEFECTO #dsarm005;
          #dsarm005#0 = enDocumento;
          |LEE 000#dsarm005.=;
          |SI FSalida ! 0;
               |CIERRA #dsarm005;
               |ACABA;
          |FINSI;
          aFicheroBja = #dsarm005#9;
          |QBF aFicheroBja;
          |SI aFicheroBja = "";
               |CIERRA #dsarm005;
               |ACABA;
          |FINSI;

          aAlfa = #dsarm005#9 < "";  |QBF aAlfa;
          aAlfa = aAlfa % -103;
          aTipoDoc = aAlfa;

          |SI aTipoDoc ! "bmp";  |Y aTipoDoc ! "tif";  |Y aTipoDoc ! "pdf";
           |Y aTipoDoc ! "htm";  |Y aTipoDoc ! "xml";  |Y aTipoDoc ! "txt";
           |Y aTipoDoc ! "jpg";  |Y aTipoDoc ! "jpe";  |Y aTipoDoc ! "png";
           |Y aTipoDoc ! "doc";  |Y aTipoDoc ! "xls";  |Y aTipoDoc ! "iff";
               |CIERRA #dsarm005;
               |ACABA;
          |FINSI;

          |DBASE aBase;
          |QBF aBase;
          aRespuestaOCR = aBase + "ocr/" + aFicheroBja + ".txt";
          |XABRE "E", aRespuestaOCR, nHandleLog;
          |SI FSalida < 0;
               aAlfaAux = aFicheroBja < "";
               aRespuestaOCR = aBase + "ocr/" + aAlfaAux + ".txt";
               |XABRE "E", aRespuestaOCR, nHandleLog;
               |SI FSalida < 0;
                    |CIERRA #dsarm005;
                    |ACABA;
               |FINSI;
          |FINSI;
          ||Nos devuelve:
          || - si hay o no error. (En caso de error. Texto del error)
          || - codigo plantilla y descripcion
          || - proceso PI.
          || - variables si existen.
          |ABRE #dsarm004;
          |DDEFECTO #dsarm004;
          #dsarm004#0 = enGrupoPV;
          #dsarm004#1 = enSubGrupoPV;
          #dsarm004#2 = enTipoPV;
          |LEE 000#dsarm004.=;
          |CIERRA #dsarm004;

          |HORA aHoraOCR;
          fFechaOCR = ~;
          aHoraOCR  = aHoraOCR % 105;
          aFicOCR   = #dsarm005#9;
          |QBF aFicOCR;

          |ABRE #dsarm035;
          aNueveFinal    = "";
          aCincoFinal    = "";
          nSwErrorOCRLog = 0;
          aErrorOCR      = "";
          aCodPlantilla  = "";
          aDesPlantilla  = "";
          aProcesoPI     = "";
          nParteOCR      = 0;
          nParteVAR      = 0;
          nParteLOG      = 0;
          nParteNVAL     = 0;

          |XABRE "U", aRespuestaOCR, nHandleLog;
          |SI FSalida ] 0;
               |PARA; |SI; |HACIENDO;
                    |XLEE nHandleLog, 250, aLineaLog;
                    |SI FSalida < 0;  |SAL;  |FINSI;

                    |HAZ TrataRegistro;
               |SIGUE;
          |FINSI;
          |XCIERRA nHandleLog;
          |HAZ CompruebaActividad;
          |CIERRA #dsarm035;
          |HAZ GrabaResultadoOCR;

          efFechaBandeja = fFechaOCR;
          eaHoraBandeja = aHoraOCR;
          eaNombreBandeja = aFicOCR;

          |CIERRA #dsarm005;
          |ACABA;
     |FINSI;

     nNoSeEscanea = 0;
     |SI PARAMETRO ! "";
         |HAZ LeeDocumento;
         |SI nNoSeEscanea = 1;  |ACABA;  |FINSI;
     |FINSI;

     |HAZ Traete_dsescan_cli;
     |SI enError = 1;  |ACABA;  |FINSI;

     |HAZ Traete_pdftotext;
     |SI enError = 1;  |ACABA;  |FINSI;

     |HAZ Traete_imagemagick;
     |SI enError = 1;  |ACABA;  |FINSI;

     |HAZ Traete_dsofficetxt;
     |SI enError = 1;  |ACABA;  |FINSI;

     |SI enSwDesde9 = 0;
          |VENTANA 0501, 2499, -1, 16, "Conectando con el OCR";
          nVentana = FSalida;

          |PTEC 802;
          |PAUSA;
          |PINPA #0#dsarz013;
     |FINSI;

     |SI PARAMETRO ! "";
         |ABRE #dsarm005;
         |SI nSwAplicaPlantilla = 0;
              #dsarm005#0 = PARAMETRO;
              |LEE 000#dsarm005.=;
              |SI FSalida = 0;
                  |SI eaAutoSelPlantilla = "S"; |O eaImpoAlbaVta = "S";
                       #dsarm005#7 = eaUbicacionTempo;
                       #dsarm005#9 = eaNomFichero;
                  |FINSI;
                  |HAZ dsarm005_ocr;
              |FINSI;
         |SINO;
               |SI eaImpoAlbaVta = "S";
                    ||ARA3939.  ESTUDIAR ESTO.
               |FINSI;

               |DDEFECTO #dsarm005;
               #dsarm005#0 = PARAMETRO;
               #dsarm005#1 = nGrupoCinco;
               #dsarm005#2 = nSubGrupoCinco;
               #dsarm005#3 = nTipoCinco;
               #dsarm005#7 = aPathCinco;
               #dsarm005#9 = aNombreCinco;
               |HAZ dsarm005_ocr;
         |FINSI;
         |CIERRA #dsarm005;

         |HAZ QuitaVentana;
         |ACABA;
     |FINSI;
     |HAZ QuitaVentana;

     |HAZ SoyDESPANET;
     |SI enSoyDESPANET = 1;  |ACABA;  |FINSI;

     |CONFI "0000SQuiere realizar el proceso";
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |BUCLE dsarm005_ocr;
|FPRO;
