|FICHEROS;
   dscaz187 #0;

   dscam008 #10;
   dscam009 #11;

   dscam021 #50;
   dscam022 #51;
   dscam046 #52;
   dscam047 #53;
   dscam049 #54;
   dscam050 #55;
   dscam095 #56;
   dscam096 #57;

   dscam067 #70;
   dscam043 #71;

   Referen@ #100;
   Refere1@ #101;
   Refere2@ #102;
   Refere3@ #103;
   Refere4@ #104;
   Refere5@ #105;

   canempr@ #1000;
|FIN;

|VARIABLES;
   aAlfa      = "";
   aAlfa1     = "";
   aAlfa2     = "";
   aSerie     = "";

   nSw        = 0;
   nSwMira    = 0;
   nSwCambia  = 0;
   nDocumento = 0;
   fFechaEmi  = @;
   fFechaVto  = @;
   nImporte   = 0;
   nTipoRec   = 0;
   nLibro     = 0;
   nFactura   = 0;
   nRecibo    = 0;
   nEmpCont   = 0;
   nPerCont   = 0;
   fFecha     = @;
   aCtaProv   = "";
   aEstado    = "";

   nDocAnt    = 0;

   nCalc      = 0;
   nCalc1     = 0;
   nCalc2     = 0;
   nCalc3     = 0;
   nDocABorrar = 0;
   nDocLiquid  = 0;
   nDocNoLiqu  = 0;
   nNumNoLiq   = 0;
|FIN;

|PROCESO BuscaEmpresa;
   nEmpCont = 0; nPerCont = 0;

   |SELECT #2#dscam043;
   #dscam043#9 = #48#0;
   |LEE 000#dscam043.];
   |PARA; |SI FSalida = 0; |Y #dscam043#9 = #48#0; |HACIENDO;
      || Compruebo la serie y que sea de compras para buscar la empresa
      ||    contable
      |SI #dscam043#3 = "C";
         |SI #dscam043#5 [ #dscam008#27; |Y #dscam043#6 ] #dscam008#27;
            |SI #dscam043#7 [ #dscam008#0; |Y #dscam043#8 ] #dscam008#0;
               aAlfa = #48#16; |QBF aAlfa;
               aAlfa = aAlfa + "fich/"; |PATH_DAT #canempr@#aAlfa#;
               aAlfa = aAlfa + (("00000" + #dscam043#0) % -105) + #dscam043#1 + "/";
               |PATH_DAT #Referen@#aAlfa#; |PATH_DAT #Refere1@#aAlfa#;
               |PATH_DAT #Refere2@#aAlfa#; |PATH_DAT #Refere3@#aAlfa#;
               |ABRE #Referen@; |ABRE #Refere1@;
               |ABRE #Refere2@; |ABRE #Refere3@;
               |ABRE #canempr@;
               |SI nSw = 1;
                  #canempr@#2 = #dscam043#0;
                  #canempr@#3 = #dscam043#1;
                  |LEE 000#canempr@.=;
                  |SI FSalida = 0;
                     aAlfa = fFecha; |QBF aAlfa; aAlfa = aAlfa % -102;
                     nCalc = aAlfa;
                     |SI nCalc = #canempr@#26;
                        nEmpCont = #dscam043#0; nPerCont = #dscam043#1; |SAL;
                     |FINSI;
                  |FINSI;
               |FINSI;
               |SI nSw = 2;
                  #Referen@#0 = nLibro;
                  #Referen@#1 = nFactura;
                  #Referen@#2 = aSerie;
                  #Referen@#3 = nRecibo;
                  |LEE 000#Referen@.=;
                  |SI FSalida = 0;
                     |SI nTipoRec > 0;
                        |SI #Referen@#7 = fFechaVto; |Y #Referen@#8 = nImporte; |Y #Referen@#11 = nTipoRec;
                           || Tomo el codigo de empresa contable y el periodo
                           nEmpCont = #dscam043#0; nPerCont = #dscam043#1; |SAL;
                        |FINSI;
                     |SINO;
                        |SI #Referen@#7 = fFechaVto; |Y #Referen@#8 = nImporte;
                           || Tomo el codigo de empresa contable y el periodo
                           nEmpCont = #dscam043#0; nPerCont = #dscam043#1; |SAL;
                        |FINSI;
                     |FINSI;
                  |SINO;
                     |SELECT #3#Refere3@;
                     #Refere3@#0 = nLibro;
                     #Refere3@#2 = aSerie;
                     #Refere3@#3 = nFactura;
                     |LEE 000#Refere3@.=;
                     |SI FSalida = 0;
                        |SI #Refere3@#12 = aCtaProv; |Y #Refere3@#21 = nImporte;
                           nEmpCont = #dscam043#0; nPerCont = #dscam043#1; |SAL;
                        |FINSI;
                     |FINSI;
                     |SELECT #1#Refere3@;
                  |FINSI;
               |FINSI;
               |CIERRA #Referen@; |CIERRA #Refere1@;
               |CIERRA #Refere2@; |CIERRA #Refere3@;
            |FINSI;
         |FINSI;
      |FINSI;
      |LEE 000#dscam043.s;
   |SIGUE;
|FPRC;

|PROCESO MovsHuerfanos;
    #dscam008#40 = #dscam009#14;
    |LEE 000#dscam008.=;
    |SI FSalida ! 0;   || Movimiento 'huerfano'
       || Busco los que tengan la misma serie/factura/recibo
       nSwCambia = 0;
       |SELECT #2#dscam008;
       #dscam008#27 = #dscam009#13;
       #dscam008#0 = #dscam009#0;
       #dscam008#1 = #dscam009#1;
       #dscam008#2 = #dscam009#2;
       |LEE 000#dscam008.];
       |PARA; |SI FSalida = 0; |Y #dscam008#27 = #dscam009#13; |Y #dscam008#0 = #dscam009#0;
       |Y #dscam008#1 = #dscam009#1; |Y #dscam008#2 = #dscam009#2; |HACIENDO;
          || Compruebo tambien que la fecha de pago es anterior a la de emision
          |SI #dscam008#26 = #dscam009#6; |Y #dscam008#3 > #dscam008#26;
             nSwCambia = 1; |SAL;
          |FINSI;
          || Si no es asi, compruebo si viene de un pagare, talon, confirme
          ||    o pago domiciliado y busco en esa linea del documento si
          ||    coincide la fecha del movimiento con la del vto del recibo
          ||    Si coincide, es el mismo caso que el de arriba
          nSwMira = 0;
          |SI #dscam008#39 = "P"; |Y #dscam008#17 ! 0; |Y #dscam008#37 ! 0; |Y #dscam009#5 = "PPA"; nSwMira = 1; |FINSI;
          |SI #dscam008#39 = "T"; |Y #dscam008#17 ! 0; |Y #dscam008#37 ! 0; |Y #dscam009#5 = "PTA"; nSwMira = 1; |FINSI;
          |SI #dscam008#39 = "C"; |Y #dscam008#17 ! 0; |Y #dscam008#37 ! 0; |Y #dscam009#5 = "PCF"; nSwMira = 1; |FINSI;
          |SI #dscam008#39 = "D"; |Y #dscam008#17 ! 0; |Y #dscam008#37 ! 0; |Y #dscam009#5 = "PDM"; nSwMira = 1; |FINSI;
          |SI nSwMira = 1;
             |SI #dscam008#39 = "P";
                #dscam021#0 = #dscam008#17;
                |LEE 000#dscam021.=;
                |SI FSalida ! 0; |DDEFECTO #dscam021; |FINSI;

                #dscam022#0 = #dscam008#17;
                #dscam022#1 = #dscam008#37;
                |LEE 000#dscam022.=;
                |SI FSalida = 0;
                   |SI #dscam009#14 = #dscam022#13; |Y #dscam009#6 = #dscam022#6; |Y #dscam008#26 = #dscam021#1;
                      nSwCambia = 1; |SAL;
                   |FINSI;
                |FINSI;
             |FINSI;
             |SI #dscam008#39 = "T";
                #dscam046#0 = #dscam008#17;
                |LEE 000#dscam046.=;
                |SI FSalida ! 0; |DDEFECTO #dscam046; |FINSI;

                #dscam047#0 = #dscam008#17;
                #dscam047#1 = #dscam008#37;
                |LEE 000#dscam047.=;
                |SI FSalida = 0;
                   |SI #dscam009#14 = #dscam047#13; |Y #dscam009#6 = #dscam047#6; |Y #dscam008#26 = #dscam046#1;
                      nSwCambia = 1; |SAL;
                   |FINSI;
                |FINSI;
             |FINSI;
             |SI #dscam008#39 = "C";
                #dscam049#0 = #dscam008#17;
                |LEE 000#dscam049.=;
                |SI FSalida ! 0; |DDEFECTO #dscam049; |FINSI;

                #dscam050#0 = #dscam008#17;
                #dscam050#1 = #dscam008#37;
                |LEE 000#dscam050.=;
                |SI FSalida = 0;
                   |SI #dscam009#14 = #dscam050#13; |Y #dscam009#6 = #dscam050#6; |Y #dscam008#26 = #dscam049#1;
                      nSwCambia = 1; |SAL;
                   |FINSI;
                |FINSI;
             |FINSI;
             |SI #dscam008#39 = "D";
                #dscam095#0 = #dscam008#17;
                |LEE 000#dscam095.=;
                |SI FSalida ! 0; |DDEFECTO #dscam095; |FINSI;

                #dscam096#0 = #dscam008#17;
                #dscam096#1 = #dscam008#37;
                |LEE 000#dscam096.=;
                |SI FSalida = 0;
                   |SI #dscam009#14 = #dscam096#16; |Y #dscam009#6 = #dscam096#6; |Y #dscam008#26 = #dscam095#1;
                      nSwCambia = 1; |SAL;
                   |FINSI;
                |FINSI;
             |FINSI;
          |FINSI;

          || Si no es asi, compruebo si tiene algo en 'Total pagado' pero
          ||    no tiene lineas de movimientos
          |SI #dscam008#23 ! 0;
             #Refere4@#14 = #dscam008#40;
             |LEE 000#Refere4@.];
             |SI FSalida ! 0; |O #Refere4@#14 ! #dscam008#40;
                nSwCambia = 2; |SAL;
             |SINO;
                |SI #dscam008#39 = " "; |Y #dscam008#17 = 0; |Y #Refere4@#5 ! "PAG"; |Y #Refere4@#5 ! "PAP";
                   nSwCambia = 2; |SAL;
                |FINSI;
                |SI #dscam008#39 = "P"; |Y #dscam008#17 ! 0; |Y #Refere4@#5 ! "PPA"; nSwCambia = 2; |SAL; |FINSI;
                |SI #dscam008#39 = "C"; |Y #dscam008#17 ! 0; |Y #Refere4@#5 ! "PCF"; nSwCambia = 2; |SAL; |FINSI;
                |SI #dscam008#39 = "T"; |Y #dscam008#17 ! 0; |Y #Refere4@#5 ! "PTA"; nSwCambia = 2; |SAL; |FINSI;
                |SI #dscam008#39 = "D"; |Y #dscam008#17 ! 0; |Y #Refere4@#5 ! "PDM"; nSwCambia = 2; |SAL; |FINSI;
             |FINSI;
          |FINSI;
          |LEE 000#dscam008.s;
       |SIGUE;

       |SELECT #1#dscam008;
       |LEE 000#dscam008.=;
       |SI FSalida = 0; |Y nSwCambia > 0;
          nLibro = #dscam009#13;
          aSerie = #dscam009#0;
          nFactura = #dscam009#1;
          nRecibo = #dscam009#2;
          fFecha = #dscam009#6; nSw = 1; |HAZ BuscaEmpresa;
          |SI nEmpCont = 0; |Y nPerCont = 0; |ACABA; |FINSI;

          |BORRA 020#dscam008.a;
          aAlfa = "     Documento " + #dscam008#40  + "[" + #dscam008#0 + "/" + #dscam008#1 + "] reemplazado por el " + #dscam009#14 + "[" + #dscam009#6 + "] por encontrar movimiento 'huerfano'"; |IMPRIME aAlfa;

          #dscam008#40 = #dscam009#14;
          #dscam008#44 = nEmpCont;
          #dscam008#45 = nPerCont;
          #dscam008#26 = #dscam009#6;
          #dscam008#27 = #dscam009#13;
          #dscam008#0  = #dscam009#0;
          #dscam008#1  = #dscam009#1;
          #dscam008#2  = #dscam009#2;
          |GRABA 020#dscam008.c;

          |SI #dscam009#13 > 0;
             aAlfa = #48#16; |QBF aAlfa;
             aAlfa = aAlfa + "fich/" + (("00000" + #dscam008#44) % -105) + #dscam008#45 + "/";
             |PATH_DAT #Referen@#aAlfa#; |PATH_DAT #Refere1@#aAlfa#;
             |PATH_DAT #Refere2@#aAlfa#; |PATH_DAT #Refere3@#aAlfa#;
             |ABRE #Referen@; |ABRE #Refere1@; |ABRE #Refere2@; |ABRE #Refere3@;
             #Referen@#0 = #dscam009#13;
             |SI #Referen@#0 = 0; #Referen@#0 = 2; |FINSI;
             #Referen@#1 = #dscam009#1;
             #Referen@#2 = #dscam009#0;
             #Referen@#3 = #dscam009#2;
             |LEE 000#Referen@.=;
             |SI FSalida = 0;
                #Refere1@#23 = "P";
                #Refere1@#10 = #Referen@#4;
                #Refere1@#11 = #Referen@#5;
                |LEE 000#Refere1@.=;
                |SI FSalida ! 0; |DDEFECTO #Refere1@; |FINSI;

                #Refere2@#0 = #Refere1@#20;
                |LEE 000#Refere2@.=;
                |SI FSalida ! 0; |DDEFECTO #Refere2@; |FINSI;

                #dscam008#3 = #Referen@#7;
                #dscam008#4 = #Referen@#6;
                #dscam008#5 = #Referen@#4;
                #dscam008#6 = #Refere1@#1;
                #dscam008#7 = #Referen@#14;
                #dscam008#8 = #Referen@#29;
                #dscam008#9 = #Referen@#30;
                #dscam008#10 = #Referen@#31;
                #dscam008#11 = #Referen@#32;
                #dscam008#12 = #Referen@#11;
                #dscam008#22 = #Referen@#8;
                #dscam008#24 = #Referen@#9;
                #dscam008#53 = #Referen@#8;
                #dscam008#54 = #Referen@#9;
                #dscam008#59 = "EUR";
                #dscam008#60 = "EURO";
                #dscam008#61 = 1;
                #dscam008#62 = 0;
                #dscam008#67 = #Refere1@#20;
                #dscam008#68 = #Refere2@#1;

                #dscam008#25 = #dscam008#22 + #dscam008#24 + #dscam008#38;
                #dscam008#56 = #dscam008#53 + #dscam008#54 + #dscam008#55;
                #dscam008#23 = #dscam009#8;
                #dscam008#57 = #dscam009#21;
                #dscam008#31 = #dscam008#25 - #dscam008#23;
                #dscam008#58 = #dscam008#56 - #dscam008#57;

                |SI #dscam008#31 = 0;
                   #dscam008#14 = "L";
                   #dscam008#15 = "Recibo liquidado";
                |FINSI;
                |GRABA 020#dscam008.a;
             |SINO;
                |SELECT #3#Refere3@;
                #Refere3@#0 = #dscam009#13;
                |SI #Refere3@#0 = 0; #Refere3@#0 = 2; |FINSI;
                #Refere3@#2 = #dscam009#0;
                #Refere3@#3 = #dscam009#1;
                |LEE 000#Refere3@.=;
                |SI FSalida = 0;
                   #Refere1@#23 = "P";
                   #Refere1@#10 = #Refere3@#12;
                   |LEE 000#Refere1@.=;
                   |SI FSalida ! 0; |DDEFECTO #Refere1@; |FINSI;

                   #Refere2@#0 = #Refere1@#20;
                   |LEE 000#Refere2@.=;
                   |SI FSalida ! 0; |DDEFECTO #Refere2@; |FINSI;

                   nCalc = (#Refere2@#2 * (#dscam008#2 - 1)) * #Refere2@#4;
                   nCalc1 = #Refere3@#4; nCalc1 = nCalc + nCalc1;
                   #dscam008#3 = nCalc1;
                   #dscam008#4 = #Refere3@#4;
                   #dscam008#5 = #Refere3@#12;
                   #dscam008#6 = #Refere3@#13;
                   #dscam008#7 = #Refere1@#13;
                   #dscam008#8 = #Refere1@#29;
                   #dscam008#9 = #Refere1@#30;
                   #dscam008#10 = #Refere1@#31;
                   #dscam008#11 = #Refere1@#32;
                   #dscam008#12 = #Refere2@#5;
                   |SI #dscam008#17 ! 0;
                      #dscam008#22 = #dscam009#8;
                   |SINO;
                      |SI #dscam008#2 = #Refere2@#2;
                         #dscam008#22 = (#Refere3@#21 - ((#Refere3@#21 / #Refere2@#2) * (#Refere2@#2 - 1))) ! 2;
                      |SINO;
                         #dscam008#22 = (#Refere3@#21 / #Refere2@#2) ! 2;
                      |FINSI;
                   |FINSI;
                   #dscam008#23 = #dscam009#8;
                   #dscam008#57 = #dscam009#21;
                   #dscam008#25 = #dscam008#22 + #dscam008#24 + #dscam008#38;
                   #dscam008#53 = #dscam008#22;
                   #dscam008#56 = #dscam008#53 + #dscam008#54 + #dscam008#55;
                   #dscam008#59 = "EUR";
                   #dscam008#60 = "EURO";
                   #dscam008#61 = 1;
                   #dscam008#62 = 0;
                   #dscam008#63 = #Referen@#22;
                   #dscam008#67 = #Refere1@#20;
                   #dscam008#68 = #Refere2@#1;

                   #dscam008#31 = #dscam008#25 - #dscam008#23;
                   #dscam008#58 = #dscam008#56 - #dscam008#57;

                   |SI #dscam008#31 = 0;
                      #dscam008#14 = "L";
                      #dscam008#15 = "Recibo liquidado";
                   |FINSI;

                   |GRABA 020#dscam008.a;
                |SINO;
                   |SI #dscam009#5 = "PAG";
                      #dscam008#25 = #dscam009#7; #dscam008#56 = #dscam009#20;
                      #dscam008#31 = #dscam008#25 - #dscam008#23;
                      #dscam008#58 = #dscam008#56 - #dscam008#57;
                      |GRABA 020#dscam008.a;
                   |FINSI;
                   |SI #dscam009#5 = "PPA";
                      |SELECT #2#dscam022;
                      #dscam022#13 = #dscam009#14;
                      #dscam022#14 = #dscam009#3;
                      |LEE 000#dscam022.=;
                      |SI FSalida = 0;
                         aAlfa = #dscam022#8; |QBF aAlfa;
                         |SI aAlfa ! "";
                            aAlfa = #dscam022#37; |QBF aAlfa;
                            |SI aAlfa ! ""; #dscam008#63 = aAlfa; |FINSI;
                            #dscam008#5  = #dscam022#8;
                            #dscam008#6  = #dscam022#10;
                            #dscam008#12 = #dscam022#18;
                            #dscam008#25 = #dscam022#7;
                            #dscam008#56 = #dscam022#19;
                            #dscam008#59 = #dscam022#20;
                            #dscam008#60 = #dscam022#21;
                            |GRABA 020#dscam008.a;
                         |FINSI;
                      |FINSI;
                      |SELECT #1#dscam022;
                   |FINSI;
                |FINSI;
                |SELECT #1#Refere3@;
             |FINSI;
          |FINSI;
          |CIERRA #Referen@; |CIERRA #Refere1@; |CIERRA #Refere2@; |CIERRA #Refere3@;
       |FINSI;
    |FINSI;
|FPRC;

|DEFBUCLE MovsHuerfanos;
#dscam009#1;
;
INICIO;
FINAL;
;
NULL, MovsHuerfanos;
|FIN;

|PROCESO PonDatosFactura;
   |BORRA 020#dscam008.a;
   nDocAnt    = #dscam008#40;

   aAlfa = "     Documento " + #dscam008#40  + "[" + #dscam008#0 + "/" + #dscam008#1 + "] reemplazado por el " + nDocumento + " por vinculacion a " + #dscam008#47 + " n§ " + #dscam008#17; |IMPRIME aAlfa;

   #dscam008#40 = nDocumento;
   #dscam008#44 = nEmpCont;
   #dscam008#45 = nPerCont;
   #dscam008#27 = nLibro;
   #dscam008#0  = aSerie;
   #dscam008#1  = nFactura;
   #dscam008#2  = nRecibo;
   |GRABA 020#dscam008.c;

   #Refere1@#23 = "P";
   #Refere1@#10 = aCtaProv;
   |LEE 000#Refere1@.=;
   |SI FSalida ! 0; |DDEFECTO #Refere1@; |FINSI;

   #Refere2@#0 = #Refere1@#20;
   |LEE 000#Refere2@.=;
   |SI FSalida ! 0; |DDEFECTO #Refere2@; |FINSI;

   #dscam008#3  = #Refere3@#4;
   #dscam008#4  = #Refere3@#4;
   #dscam008#6  = #Refere1@#1;
   #dscam008#7  = #Refere1@#13;
   #dscam008#8  = #Refere1@#29;
   #dscam008#9  = #Refere1@#30;
   #dscam008#10 = #Refere1@#31;
   #dscam008#11 = #Refere1@#32;

   #dscam008#22 = nImporte; #dscam008#53 = nImporte;
   #dscam008#25 = nImporte; #dscam008#56 = nImporte;
   #dscam008#14 = aEstado;
   |SI aEstado = "L";
      #dscam008#15 = "Recibo liquidado";
      #dscam008#23 = nImporte; #dscam008#57 = nImporte;
   |SINO;
      |SI aEstado = "E";
         #dscam008#15 = "Englobado en " + #dscam008#39;
         #dscam008#23 = 0; #dscam008#57 = 0;
      |FINSI;
   |FINSI;

   #dscam008#59 = "EUR";
   #dscam008#60 = "EURO";
   #dscam008#61 = 1;
   #dscam008#62 = 0;
   #dscam008#67 = #Refere1@#20;
   #dscam008#68 = #Refere2@#1;
   #dscam008#31 = #dscam008#25 - #dscam008#23;
   #dscam008#58 = #dscam008#56 - #dscam008#57;

   |GRABA 020#dscam008.a;
|FPRC;

|PROCESO PonDatosRecibo;
   |BORRA 020#dscam008.a;
   nDocAnt    = #dscam008#40;

   aAlfa = "     Documento " + #dscam008#40  + "[" + #dscam008#0 + "/" + #dscam008#1 + "] reemplazado por el " + nDocumento + " por vinculacion a " + #dscam008#47 + " n§ " + #dscam008#17; |IMPRIME aAlfa;

   #dscam008#40 = nDocumento;
   #dscam008#44 = nEmpCont;
   #dscam008#45 = nPerCont;
   #dscam008#27 = nLibro;
   #dscam008#0  = aSerie;
   #dscam008#1  = nFactura;
   #dscam008#2  = nRecibo;
   |GRABA 020#dscam008.c;

   #Refere1@#23 = "P";
   #Refere1@#10 = #Referen@#4;
   #Refere1@#11 = #Referen@#5;
   |LEE 000#Refere1@.=;
   |SI FSalida ! 0; |DDEFECTO #Refere1@; |FINSI;

   #Refere2@#0 = #Refere1@#20;
   |LEE 000#Refere2@.=;
   |SI FSalida ! 0; |DDEFECTO #Refere2@; |FINSI;

   #dscam008#3 = #Referen@#7;
   #dscam008#4 = #Referen@#6;
   #dscam008#5 = #Referen@#4;
   #dscam008#6 = #Refere1@#1;
   #dscam008#7 = #Referen@#14;
   #dscam008#8 = #Referen@#29;
   #dscam008#9 = #Referen@#30;
   #dscam008#10 = #Referen@#31;
   #dscam008#11 = #Referen@#32;
   #dscam008#12 = #Referen@#11;
   #dscam008#22 = #Referen@#8;
   #dscam008#24 = #Referen@#9;
   #dscam008#53 = #Referen@#8;
   #dscam008#53 = #Referen@#9;
   #dscam008#59 = "EUR";
   #dscam008#60 = "EURO";
   #dscam008#61 = 1;
   #dscam008#62 = 0;
   #dscam008#67 = #Refere1@#20;
   #dscam008#68 = #Refere2@#1;

   #dscam008#31 = #dscam008#25 - #dscam008#23;
   #dscam008#58 = #dscam008#56 - #dscam008#57;

   |GRABA 020#dscam008.a;
|FPRC;

|PROCESO RecsFechaPagoAnt;
   || Necesita recalcular si la fecha de pago es anterior a la de emision
   |SI #dscam008#26 < #dscam008#4;
      nSwCambia = 0;
      |SI #dscam008#39 = "P";
         #dscam021#0 = #dscam008#17;
         |LEE 000#dscam021.=;
         |SI FSalida = 0; |Y #dscam021#1 = #dscam008#26;
            #dscam022#0 = #dscam008#17;
            #dscam022#1 = #dscam008#37;
            |LEE 000#dscam022.=;
            |SI FSalida = 0; |Y #dscam022#2 = #dscam008#27; |Y #dscam022#4 = #dscam008#0;
             |Y #dscam022#3 = #dscam008#1; |Y #dscam022#5 = #dscam008#2;
               nSwCambia = 1;
               nDocumento = #dscam022#13;
               fFechaVto  = #dscam022#6;
               nImporte = #dscam022#7;
               nTipoRec = #dscam022#18;
               nLibro   = #dscam022#2;
               nFactura = #dscam022#3;
               aSerie   = #dscam022#4;
               nRecibo  = #dscam022#5;
               aCtaProv = #dscam022#8;
               aEstado = "E";
               |SI #dscam021#8 = "S"; aEstado = "L"; |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;

      |SI #dscam008#39 = "T";
         #dscam046#0 = #dscam008#17;
         |LEE 000#dscam046.=;
         |SI FSalida = 0; |Y #dscam046#1 = #dscam008#26;
            #dscam047#0 = #dscam008#17;
            #dscam047#1 = #dscam008#37;
            |LEE 000#dscam047.=;
            |SI FSalida = 0; |Y #dscam047#2 = #dscam008#27; |Y #dscam047#4 = #dscam008#0;
             |Y #dscam047#3 = #dscam008#1; |Y #dscam047#5 = #dscam008#2;
               nSwCambia = 1;
               nDocumento = #dscam047#13;
               fFechaVto  = #dscam047#6;
               nImporte = #dscam047#7;
               nTipoRec = -1;
               nLibro   = #dscam047#2;
               nFactura = #dscam047#3;
               aSerie   = #dscam047#4;
               nRecibo  = #dscam047#5;
               aCtaProv = #dscam047#8;
               aEstado = "E";
               |SI #dscam046#8 = "S"; aEstado = "L"; |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;

      |SI #dscam008#39 = "C";
         #dscam049#0 = #dscam008#17;
         |LEE 000#dscam049.=;
         |SI FSalida = 0; |Y #dscam049#1 = #dscam008#26;
            #dscam050#0 = #dscam008#17;
            #dscam050#1 = #dscam008#37;
            |LEE 000#dscam050.=;
            |SI FSalida = 0; |Y #dscam050#2 = #dscam008#27; |Y #dscam050#4 = #dscam008#0;
             |Y #dscam050#3 = #dscam008#1; |Y #dscam050#5 = #dscam008#2;
               nSwCambia = 1;
               nDocumento = #dscam050#13;
               fFechaVto  = #dscam050#6;
               nImporte = #dscam050#7;
               nTipoRec = -1;
               nLibro   = #dscam050#2;
               nFactura = #dscam050#3;
               aSerie   = #dscam050#4;
               nRecibo  = #dscam050#5;
               aCtaProv = #dscam050#8;
               aEstado = "E";
               |SI #dscam049#8 = "S"; aEstado = "L"; |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;

      |SI #dscam008#39 = "D";
         #dscam095#0 = #dscam008#17;
         |LEE 000#dscam095.=;
         |SI FSalida = 0;
            |SELECT #2#dscam050;
            #dscam096#16 = #dscam008#17;
            #dscam096#17 = #dscam008#37;
            |LEE 000#dscam096.=;
            |SI FSalida = 0; |Y #dscam096#2 = #dscam008#27; |Y #dscam096#4 = #dscam008#0;
             |Y #dscam096#3 = #dscam008#1; |Y #dscam096#5 = #dscam008#2;
               nSwCambia = 1;
               nDocumento = #dscam096#16;
               fFechaVto  = #dscam096#6;
               nImporte = #dscam096#7;
               nTipoRec = -1;
               nLibro   = #dscam096#2;
               nFactura = #dscam096#3;
               aSerie   = #dscam096#4;
               nRecibo  = #dscam096#5;
               aCtaProv = #dscam096#11;
               aEstado = "E";
               |SI #dscam095#9 = "S"; aEstado = "L"; |FINSI;
            |FINSI;
            |SELECT #1#dscam096;
         |FINSI;
      |FINSI;

      |SI nSwCambia = 1;
         |SI #dscam008#27 > 0;
            nSw = 2; |HAZ BuscaEmpresa;
            |SI nEmpCont ! 0; |O nPerCont ! 0;
               aAlfa = #48#16; |QBF aAlfa;
               aAlfa = aAlfa + "fich/" + (("00000" + nEmpCont) % -105) + nPerCont + "/";
               |PATH_DAT #Referen@#aAlfa#; |PATH_DAT #Refere1@#aAlfa#;
               |PATH_DAT #Refere2@#aAlfa#; |PATH_DAT #Refere3@#aAlfa#;
               |ABRE #Referen@; |ABRE #Refere1@; |ABRE #Refere2@; |ABRE #Refere3@;
               |SI nLibro = 0; #Referen@#0 = 2; |SINO; #Referen@#0 = nLibro; |FINSI;
               #Referen@#1 = nFactura;
               #Referen@#2 = aSerie;
               #Referen@#3 = nRecibo;
               |LEE 000#Referen@.=;
               |SI FSalida = 0;
                  |SI nTipoRec > 0;
                     |SI #Referen@#7 = fFechaVto; |Y #Referen@#8 = nImporte; |Y #Referen@#11 = nTipoRec;
                        |HAZ PonDatosRecibo;
                     |FINSI;
                  |SINO;
                     |SI #Referen@#7 = fFechaVto; |Y #Referen@#8 = nImporte;
                        |HAZ PonDatosRecibo;
                     |FINSI;
                  |FINSI;
               |SINO;
                  |SELECT #3#Refere3@;
                  |SI nLibro = 0; #Refere3@#0 = 2; |SINO; #Refere3@#0 = nLibro; |FINSI;
                  #Refere3@#2 = aSerie;
                  #Refere3@#3 = nFactura;
                  |LEE 000#Refere3@.=;
                  |SI FSalida = 0;
                     |SI #Refere3@#12 = aCtaProv; |Y #Refere3@#21 = nImporte;
                        |HAZ PonDatosFactura;
                     |FINSI;
                  |FINSI;
                  |SELECT #1#Refere3@;
               |FINSI;
               |CIERRA #Referen@; |CIERRA #Refere1@; |CIERRA #Refere2@; |CIERRA #Refere3@;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE RecsFechaPagoAnt;
#dscam008#1;
26;
000000001, "01.01.1980";
999999999, "31.12.9999";
;
NULL, RecsFechaPagoAnt;
|FIN;

|PROCESO RevisaDuplicados;
   nDocABorrar = -1;
   nDocLiquid = -1; nDocNoLiqu = -1;
   nNumNoLiq = 0;

   |SELECT #2#Refere4@;
   #Refere4@#27 = #dscam008#27;
   #Refere4@#0 = #dscam008#0;
   #Refere4@#1 = #dscam008#1;
   #Refere4@#2 = #dscam008#2;
   |LEE 000#Refere4@.];
   |PARA; |SI FSalida = 0; |Y #Refere4@#27 = #dscam008#27; |Y #Refere4@#0 = #dscam008#0;
    |Y #Refere4@#1 = #dscam008#1; |Y #Refere4@#2 = #dscam008#2; |HACIENDO;
      |SI #Refere4@#27 > 0;
         |SI #Refere4@#44 = #dscam008#44; |Y #Refere4@#45 = #dscam008#45;
            aAlfa = #48#16; |QBF aAlfa;
            aAlfa = aAlfa + "fich/" + (("00000" + #Refere4@#44) % -105) + #Refere4@#45 + "/";
            |PATH_DAT #Refere5@#aAlfa#;
            |ABRE #Refere5@; |SELECT #3#Refere5@;
            #Refere5@#0 = #Refere4@#27;
            #Refere5@#2 = #Refere4@#0;
            #Refere5@#3 = #Refere4@#1;
            |LEE 000#Refere5@.=;
            |SI FSalida = 0;
               |SI #Refere4@#5 ! #Refere5@#12; nDocABorrar = #Refere4@#40; |FINSI;
               |SI #Refere4@#23 = 0; |Y #Refere4@#26 = "01.01.0000";
                  nDocNoLiqu  = #Refere4@#40;
                  nNumNoLiq = nNumNoLiq + 1;
               |SINO;
                  nDocLiquid  = #Refere4@#40;
               |FINSI;
            |FINSI;
            |SELECT #1#Refere5@; |CIERRA #Refere5@;
         |FINSI;
      |SINO;
         #dscam043#9 = #48#0;
         |LEE 000#dscam043.];
         |PARA; |SI FSalida = 0; |Y #dscam043#9 = #48#0; |HACIENDO;
            |SI #dscam043#3 = "C";
               |SI #dscam043#7 [ #Refere4@#0; |Y #dscam043#8 ] #Refere4@#0;
                  aAlfa = #48#16; |QBF aAlfa;
                  aAlfa = aAlfa + "fich/" + (("00000" + #dscam043#0) % -105) + #dscam043#1 + "/";
                  |PATH_DAT #Refere5@#aAlfa#;
                  |ABRE #Refere5@; |SELECT #3#Refere5@;
                  #Refere5@#0 = 2;
                  #Refere5@#2 = #Refere4@#0;
                  #Refere5@#3 = #Refere4@#1;
                  |LEE 000#Refere5@.=;
                  |SI FSalida = 0;
                     aAlfa = #Refere4@#4; |QBF aAlfa; aAlfa = aAlfa % -104; nCalc2 = aAlfa;
                     aAlfa = #Refere5@#4; |QBF aAlfa; aAlfa = aAlfa % -104; nCalc3 = aAlfa;
                     |SI nCalc2 = nCalc3;
                        aAlfa1 = #Refere4@#63; |QBF aAlfa1;
                        aAlfa2 = #Refere5@#28; |QBF aAlfa2;
                        aAlfa2 = aAlfa2 - aAlfa1;
                        |SI aAlfa1 ! ""; |Y FSalida = 0; nDocABorrar = #Refere4@#40; |FINSI;
                        |SI #Refere4@#22 = 0; |Y #Refere4@#23 = 0; nDocABorrar = #Refere4@#40; |FINSI;
                        |SELECT #1#Refere5@; |CIERRA #Refere5@; |SAL;
                     |FINSI;
                  |FINSI;
                  |SELECT #1#Refere5@; |CIERRA #Refere5@;
               |FINSI;
            |FINSI;
            |LEE 000#dscam043.s;
         |SIGUE;
      |FINSI;
      |LEE 000#Refere4@.s;
   |SIGUE;
   |SELECT #1#Refere4@;

   |SI nDocABorrar > 0;
      #Refere4@#40 = nDocABorrar;
      |LEE 000#Refere4@.=;
      |SI FSalida = 0; |BORRA 020#Refere4@.a; |FINSI;
      aAlfa = "     Documento " + #Refere4@#40  + "[" + #Refere4@#0 + "/" + #Refere4@#1 + "] eliminado por duplicidad"; |IMPRIME aAlfa;
   |SINO;
      |SI nDocLiquid > 0; |Y nDocNoLiqu > 0;
         #Refere4@#40 = nDocNoLiqu;
         |LEE 000#Refere4@.=;
         |SI FSalida = 0; |BORRA 020#Refere4@.a; |FINSI;
         aAlfa = "     Documento " + #Refere4@#40 + "[" + #Refere4@#0 + "/" + #Refere4@#1 + "] eliminado por duplicidad. Eliminado el documento pendiente."; |IMPRIME aAlfa;
      |SINO;
         |SI nDocNoLiqu > 0; |Y nNumNoLiq > 1;
            #Refere4@#40 = nDocNoLiqu;
            |LEE 000#Refere4@.=;
            |SI FSalida = 0; |BORRA 020#Refere4@.a; |FINSI;
            aAlfa = "     Documento " + #Refere4@#40 + "[" + #Refere4@#0 + "/" + #Refere4@#1 + "] eliminado por duplicidad."; |IMPRIME aAlfa;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE RevisaDuplicados;
#dscam008#1;
;
000000001;
999999999;
;
NULL, RevisaDuplicados;
|FIN;

|PROGRAMA;

   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida ! 0; |O #dscaz187#0 = "N"; |ACABA; |FINSI;

   |DFICB aAlfa; |QBF aAlfa;
   |PATH_DAT #dscam043#aAlfa#;

   |ABRE #dscam008; |ABRE #dscam067; |ABRE #dscam043;
   |ABRE #dscam022; |ABRE #dscam021;
   |ABRE #dscam046; |ABRE #dscam047;
   |ABRE #dscam049; |ABRE #dscam050;
   |ABRE #dscam095; |ABRE #dscam096;

   aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "def/calinpag.mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "def/caclipro.mas";
      |CARGA_DEF aAlfa, Refere1@;
      |SI FSalida = 0;
         aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "def/caforpag.mas";
         |CARGA_DEF aAlfa, Refere2@;
         |SI FSalida = 0;
            aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "def/camaniva.mas";
            |CARGA_DEF aAlfa, Refere3@;
            |SI FSalida = 0;
               aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "def/canempre.mas";
               |CARGA_DEF aAlfa, canempr@;
               |SI FSalida = 0;
                  |IMPRE 0;
                  |SI FSalida ! 0; |ACABA; |FINSI;

                  aAlfa = "*" * 80; |IMPRIME aAlfa;
                  aAlfa = ("*" * 5) + "                    RECALCULO RECIBOS DE COMPRA                    " + ("*" * 5); |IMPRIME aAlfa;
                  aAlfa = "*" * 80; |IMPRIME aAlfa;
                  aAlfa = " ";      |IMPRIME aAlfa;

                  |DDEF aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dscam009.mas";
                  |CARGA_DEF aAlfa, Refere4@;
                  |DFICE aAlfa; |QBF aAlfa; |PATH_DAT #Refere4@#aAlfa#;

                  |ABRE #Refere4@;
                  |BUCLE MovsHuerfanos;
                  |CIERRA #Refere4@; |DESCARGA_DEF #Refere4@;

                  |BUCLE RecsFechaPagoAnt;

                  aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "def/camaniva.mas";
                  |CARGA_DEF aAlfa, Refere5@;

                  |DDEF aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dscam008.mas";
                  |CARGA_DEF aAlfa, Refere4@;
                  |DFICE aAlfa; |QBF aAlfa; |PATH_DAT #Refere4@#aAlfa#;

                  |SELECT #1#Refere3@; |CIERRA #Refere3@;
                  |ABRE #Refere4@;
                  |BUCLE RevisaDuplicados;
                  |CIERRA #Refere4@; |DESCARGA_DEF #Refere4@;
                  |CIERRA #Refere5@; |DESCARGA_DEF #Refere5@;

                  |DESCARGA_DEF #canempr@;

                  |FINIMP;
               |FINSI;
               |DESCARGA_DEF #Refere3@;
            |FINSI;
            |DESCARGA_DEF #Refere2@;
         |FINSI;
         |DESCARGA_DEF #Refere1@;
      |FINSI;
      |DESCARGA_DEF #Referen@;
   |FINSI;
   |CIERRA #dscam095; |CIERRA #dscam096;
   |CIERRA #dscam049; |CIERRA #dscam050;
   |CIERRA #dscam046; |CIERRA #dscam047;
   |CIERRA #dscam022; |CIERRA #dscam021;
   |CIERRA #dscam043; |CIERRA #dscam067; |CIERRA #dscam008;
|FPRO;
