|FICHEROS;
   dscaz115 #0;
   dscam003 #3;
   dscam004 #4;
   dscam044 #44;
   dscam045 #45;

   agif010@ #1000;
   referen@;
|FIN;

|VARIABLES;
   &enEmpCartera = 0;
   &enEmpGestion = 0;
   &eaSerie      = "";
   &eaCliGest    = "";
   &eaTipoOper   = "";
   &eaTipoR      = "";
   &fFechaFac    = "";

   nSwErr      = 0;
   nFactura    = 0;
   nImpDiv     = 0;
   nImpBase    = 0;
   nNumEntrega = 0;
   Linea       = 0;
   nReciboACobrar = 0;
   LinCob      = 0;
   nImporte    = 0;

   Comodin     = "";
   CtaCobro    = "";
   aDirBase    = "";
   aAlfa       = "";
   aSerie      = "";
   CtaCli      = "";
   CodCli      = "";
|FIN;

|PROCESO BuscaRecibo;
     nSwErr = 1;
     |SALVA_FICHA #dscam003;
     |SELECT #6#dscam003;
     #dscam003#40 = 1;
     #dscam003#27 = 0;
     #dscam003#0  = aSerie;
     #dscam003#1  = nFactura;
     #dscam003#2  = 1;
     #dscam003#69 = " ";
     |LEE 000#dscam003.];
     |PARA; |SI FSalida = 0; |Y #dscam003#0  = aSerie; |Y #dscam003#1  = nFactura; |HACIENDO;
        |SI #dscam003#31 ! 0; |Y fFechaFac = #dscam003#4;
               nReciboACobrar = #dscam003#40;
               nSwErr = 0; |SAL;
        |FINSI;
        |LEE 000#dscam003.s;
     |SIGUE;
     |SELECT #1#dscam003;
     |REPON_FICHA #dscam003;
|FPRC;

|PROCESO Recibos;
     |SI #dscam003#30 = 0; |ACABA; |FINSI;

     #dscam044#0 = #dscam003#46;
     |LEE 000#dscam044.=
     |SI FSalida = 0;
          nSwErr = 0;
          aDirBase = #dscam044#1; |QBF aDirBase;
          |SI #dscam003#69 = "A";
               aAlfa = aDirBase + "def/agifa010.mas";
               |CARGA_DEF aAlfa, agif010@;
               |SI FSalida = 0;
                    aAlfa = aDirBase + "fich/" + (("00000" + #dscam044#0) % -105) + "/";
                    |PATH_DAT #agif010@#aAlfa#;
                    |ABRE #agif010@;
                    #agif010@#52 = #dscam003#0;
                    #agif010@#0  = #dscam003#1;
                    |LEE 000#agif010@.=;
                    |SI FSalida = 0;
                         |SI #agif010@#53 ! "     "; |O #agif010@#39 ! 0;
                              aSerie = #agif010@#53; nFactura = #agif010@#39;
                              fFechaFac = #agif010@#60;
                              nSwErr = 0;
                         |SINO;
                              nSwErr = 1;
                         |FINSI;
                    |SINO;
                         nSwErr = 1;
                    |FINSI;
                    |CIERRA #agif010@;
                    |DESCARGA_DEF #agif010@;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nSwErr = 1; |ACABA; |FINSI;

     |HAZ BuscaRecibo;

     |SI nSwErr = 1; |ACABA; |FINSI;

||    Escribo el movimiento del recibo cobrado y actualizo el recibo a cobrar

     |PARA; |SI #dscam003#14 = "e"; |O #dscam003#14 = "E"; |HACIENDO;  || Entrega a cuenta por compensar o compensada parcialmente
          CtaCobro    = "";
          #dscam004#17 = #dscam003#40;
          #dscam004#3 = 1;
          |LEE 000#dscam004.];
          |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
               CtaCobro = #dscam004#42;
          |FINSI;
          |SI #dscam003#23 = #dscam003#31;
               |SAL;     || Esto no estaba antes del 2448/42 (11/03/2015)
          |SINO;
             nImpDiv  = #dscam003#23; nImpBase = #dscam003#61; nNumEntrega = #dscam003#40;
             #dscam004#17 = #dscam003#40;
             #dscam004#3  = 1;
             |LEE 000#dscam004.];
             |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
                |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
                   Linea = #dscam004#3 + 1;
                   |LEE 000#dscam004.s;
                |SIGUE;
             |SINO;
                Linea = 1;
             |FINSI;
             |HAZ BuscaRecibo;
             |SALVA_DATOS #dscam003;
             |SI nSwErr = 0;
                #dscam003#40 = nReciboACobrar;
                |LEE 101#dscam003.=;
                |SI FSalida = 0;
                   #dscam004#17 = #dscam003#40;
                   #dscam004#3  = 1;
                   |LEE 000#dscam004.];
                   |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
                      |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
                         LinCob = #dscam004#3 + 1;
                         |LEE 000#dscam004.s;
                      |SIGUE;
                   |SINO;
                      LinCob = 1;
                   |FINSI;
                   |DDEFECTO #dscam004;
                   #dscam004#17 = #dscam003#40;
                   #dscam004#3  = LinCob; LinCob = LinCob + 1;
                   |GRABA 020#dscam004.b;
                   #dscam004#0 = #dscam003#0;
                   #dscam004#1 = #dscam003#1;
                   #dscam004#2 = #dscam003#2;
                   #dscam004#4 = "";
                   #dscam004#5 = "CAC";
                   #dscam004#6 = ~;
                   #dscam004#7 = #dscam003#23;
                   |SI #dscam003#31 ] nImpDiv;
                      #dscam004#8  = nImpDiv; #dscam004#26 = nImpBase;
                   |SINO;
                      #dscam004#8  = #dscam003#31; #dscam004#26 = #dscam003#65;
                   |FINSI;
                   #dscam004#15 = #dscam003#27;
                   Comodin = ("000000000" + nNumEntrega) % -109;
                   Comodin = "Cobro entr. " + Comodin;
                   #dscam004#16 = Comodin;
                   #dscam004#25 = #dscam003#61;
                   #dscam004#40 = nNumEntrega;
                   #dscam004#41 = Linea;
                   |GRABA 020#dscam004.a; |LIBERA #dscam004;
                   || enEmpCartera = #48#0; enEmpGestion = #dscam003#46;
                   enEmpCartera = -1;     enEmpGestion = #dscam003#46;
                   eaSerie = #dscam003#0; eaCliGest = #dscam003#32; nImporte = #dscam004#26;
                   eaTipoOper = "-4";
                   |HAZ BucleRiesgo;
                   |SI #dscam003#31 ] nImpDiv;
                      #dscam003#23 = #dscam003#23 + nImpDiv;
                      #dscam003#61 = #dscam003#61 + nImpBase;
                   |SINO;
                      #dscam003#23 = #dscam003#23 + #dscam003#31; nImpDiv  = #dscam003#31;
                      #dscam003#61 = #dscam003#61 + #dscam003#65; nImpBase = #dscam003#65;
                      #dscam003#31 = 0; #dscam003#65 = 0;
                   |FINSI;
                   #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
                   #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
                   #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
                   #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);
                   #dscam003#31 = #dscam003#30 - #dscam003#23; #dscam003#65 = #dscam003#64 - #dscam003#61;
                   |SI #dscam003#31 = 0;
                      #dscam003#14 = "L";
                      #dscam003#15 = "Recibo Liquidado";
                   |SINO;
                      |SI #dscam003#23 = 0;
                         |SI #dscam003#16 = 0;
                            #dscam003#14 = "P";
                            #dscam003#15 = "Pendiente de cobro";
                         |SINO;
                            #dscam003#14 = "I";
                            #dscam003#15 = "Impagado";
                         |FINSI;
                      |SINO;
                         #dscam003#14 = "C";
                         #dscam003#15 = "Parcialmente cobrado";
                      |FINSI;
                   |FINSI;
                   |GRABA 020#dscam003.a; |LIBERA #dscam003;
                |FINSI;
             |FINSI;
             |REPON_DATOS #dscam003;
             |LEE 121#dscam003.=;
             ||
             ||  Escribo el movimiento del recibo a cuenta y actualizo el recibo a cuenta
             ||
             |DDEFECTO #dscam004;
             #dscam004#17 = #dscam003#40;
             #dscam004#3  = Linea;
             |GRABA 020#dscam004.b;
             #dscam004#0 = #dscam003#0;
             #dscam004#1 = #dscam003#1;
             #dscam004#2 = #dscam003#2;
             #dscam004#4 = "";
             #dscam004#5 = "REC";
             #dscam004#6 = ~;
             #dscam004#7 = #dscam003#23;
             |SI #dscam003#23 ] nImpDiv;
                #dscam004#8  = -nImpDiv; #dscam004#26 = -nImpBase;
                #dscam004#23 = nImpDiv;  #dscam004#32 = nImpBase;
             |SINO;
                #dscam004#8  = -#dscam003#31; #dscam004#26 = -#dscam003#65;
                #dscam004#23 = #dscam003#31;  #dscam004#32 = #dscam003#65;
             |FINSI;
             #dscam004#15 = #dscam003#27;
             Comodin = ("0000000000" + nReciboACobrar) % -110;
             Comodin = "Cobro Doc. " + Comodin;
             #dscam004#16 = Comodin;
             #dscam004#25 = #dscam003#61;
             |GRABA 020#dscam004.a; |LIBERA #dscam004;
             || enEmpCartera = #48#0; enEmpGestion = #dscam003#46;
             enEmpCartera = -1;     enEmpGestion = #dscam003#46;
             eaSerie = #dscam003#0; eaCliGest = #dscam003#32; nImporte = -#dscam004#26;
             eaTipoOper = ""; eaTipoR = "";
             |SI #dscam003#69 = "P"; eaTipoOper = "-5"; eaTipoR = "P"; |FINSI;
             |SI #dscam003#69 = "A"; eaTipoOper = "-5"; eaTipoR = "A"; |FINSI;
             |SI eaTipoOper ! ""; |HAZ BucleRiesgo; |FINSI;
             eaTipoR = "";
             |SI #dscam003#23 ] nImpDiv;
                #dscam003#23 = #dscam003#23 - nImpDiv;
                #dscam003#61 = #dscam003#61 - nImpBase;
                #dscam003#55 = #dscam003#55 + nImpDiv;
                #dscam003#68 = #dscam003#68 + nImpBase;
             |SINO;
                #dscam003#23 = -#dscam003#31; nImpDiv = #dscam003#31;
                #dscam003#61 = -#dscam003#65; nImpBase = #dscam003#65;
                #dscam003#55 = #dscam003#55 + #dscam003#31;
                #dscam003#68 = #dscam003#68 + #dscam003#65;
                #dscam003#31 = 0; #dscam003#65 = 0;
             |FINSI;
             |SI #dscam003#31 = #dscam003#23;
                #dscam003#14 = "L";
                #dscam003#15 = "Recibo Compensado";
             |SINO;
                |SI #dscam003#23 = 0;
                   #dscam003#14 = "e";
                   #dscam003#15 = "Pendiente de compensar";
                |SINO;
                   #dscam003#14 = "E";
                   #dscam003#15 = "Compensado parcialmente";
                |FINSI;
             |FINSI;
             #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
             #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
             #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
             #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);
             #dscam003#31 = #dscam003#30 - #dscam003#23; #dscam003#65 = #dscam003#64 - #dscam003#61;
             |GRABA 020#dscam003.a; |LIBERA #dscam003;
          |FINSI;
   |SIGUE;
|FPRC;

|PROCESO Recibos0;
     |SELECT #1#dscam003;
     #dscam003#40 = #referen@#40;
     |LEE 121#dscam003.=;
     |SI FSalida = 0;
          |HAZ Recibos;
          |LIBERA #dscam003;
     |FINSI;
|FPRC;
/*
|DEFBUCLE Recibos;
     #referen@#15003;
     4;
     #dscaz115#1, "            ", "A", #dscaz115#3;
     #dscaz115#2, "zzzzzzzzzzzz", "A", #dscaz115#4;
     ;
     NULL,Recibos0;
|FIN;
*/
|DEFBUCLE Recibos;
     #referen@#11003;
     4, 69;
     #dscaz115#1, "01.01.0000", "     ", #dscaz115#3, "A";
     #dscaz115#2, "31.12.9999", "zzzzz", #dscaz115#4, "A";
     ;
     NULL,Recibos0;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |SI #0#0 ! "S"; |ACABA; |FINSI;

     |DFICB aAlfa; |QBF aAlfa;
     |PATH_DAT #dscam044#aAlfa#; |PATH_DAT #dscam045#aAlfa#;
     |ABRE #dscam044; |ABRE #dscam045; |ABRE #dscam004;

     |DDEF aAlfa;
     aAlfa = aAlfa + "dscam003";
     |CARGA_DEF aAlfa, referen@;
     |SI FSalida = 0;
          |ABRE #dscam003;
          |BUCLE Recibos;
          |CIERRA #dscam003;
          |DESCARGA_DEF #referen@;
     |FINSI;
     |CIERRA #dscam044; |CIERRA #dscam045; |CIERRA #dscam004;
|FPRC;
