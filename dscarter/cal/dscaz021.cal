|FICHEROS;
   dscaz021 #0;

   dscam046 #1;
   dscam047 #2;

   dscam008 #3;
   dscam009 #4;

   dscam030 #5;
   dscaw013 #6;
   dscam014 #7;
   dscam051 #8;
   dscam072 #9;

   &agif112@ #100;
   caclipr@ #101;
   &canempr@ #102;
|FIN;

|VARIABLES;
   nSwCrystal = 0;
   aInf = "";
   &Divisa = ""; &NombreDiv = "";
   &nDeci_Div = 0; &nDeci_Base = 0;
   &Fichero   = "";  &Cmp = "";   &Tipo = ""; &CmpNum = 0;
   &aInforme = "";
   &eaDiaL = ""; &eaMesL = ""; &eaAnyoL = "";

   &eaUsuario = ""; &enImpAnt = 0;  &enImpAct = 0;  &eaDescr = "";
   &eaTipoReg = ""; &eaNumero = ""; &eaTipoOp = "";
   &eaCodigo  = "";
   &eaTipoCod = "";
   &aCuenta   = "";

   &HayGestion  = 1;
   &HayConta    = 1;
   &prov        = "";
   &des         = "";
   &eaNif       = "";
   &eaNombre    = "";
   &eaApCorreos = "";
   &eaDireccion = "";
   &eaPoblacion = "";
   &eaProvincia = "";
   &eaCP        = "";
   &eaMesLetra  = "";
   &eaMesLetra1 = "";
   &eaImporte   = "";
   &EURO        = 0;
   &EURODB      = 0;
   &EURODV      = 0;

   aImp = "";
   fFecha = @;
   SwCambio = 0;
   Calc = 0;
   Cuenta = ""; Nivel = 0;
   Comodin = ""; Comodin1 = "";
   LinTal = 0;
   nNum    = 0; aAlfa = ""; aAlfa1 = ""; aDecs = "";
   nCalc    = 0; nSwImpre = 0;
   nLong = 0; aLong = "";
|FIN;

|PROCESO TalonDet;
   |SI #dscam046#7 = "N"; |HAZ LineasTal; |FINSI;

   eaImporte = #dscam046#9; |QBF eaImporte; |HAZ PonComas;
   eaImporte = "# " + eaImporte + " #";

   #dscam008#40 = #dscam047#13;
   |LEE 101#dscam008.=;

   #dscam014#0 = #dscam046#3;
   |LEE 010#dscam014.=;

   |HAZ LeeDatosProv;

   Divisa = #dscam046#18; |HAZ TomaDecim;
   des = #dscam046#19;
   |HAZ LeeDatosProv;
   Comodin = #dscam008#4; |QBF Comodin;
   Comodin = Comodin % 0402; nNum = Comodin;
   |HAZ MesLetra; eaMesLetra = aAlfa;
   |SI #dscaz021#4 = "C"; |O #dscaz021#4 = "A";
      |PRINT;
   |FINSI;

   |LIBERA #dscam008;
|FPRC;

|DEFBUCLE TalonDet;
#dscam047#1;
;
#dscam046#0,001;
#dscam046#0,999;
;
NULL,TalonDet;
|FIN;

|PROCESO Talones;
   eaUsuario = Usuario % 0810;
   eaDescr   = "EMISION TALON (" + (("00000" + #dscam046#0) % -105) + ")";
   eaTipoReg = "TA";  eaNumero = ("00000" + #dscam046#0) % -105;
   eaTipoOp  = "E";   enImpAnt = #dscam046#9; enImpAct = #dscam046#9;
   |HAZ GrabaAudit;

   |SI #dscam046#18 = "EUR";
      EURO   = 166.386;
      EURODB = 2; EURODV = 0;
   |SINO;
      EURO   = 0.0061;
      EURODB = 0; EURODV = 2;
   |FINSI;

   Divisa = #dscam046#18; |HAZ TomaDecim;

   #dscam046#23 = #dscam046#9;
   fFecha = #dscam046#1;
   aAlfa = fFecha % 0102; |LETRA aAlfa; |QBF aAlfa;
   aAlfa1 = aAlfa % -103;
   |SI aAlfa1 = "UNA";
      aAlfa = aAlfa - aAlfa1;
      aAlfa = aAlfa + "UNO";
   |FINSI;
   eaDiaL = aAlfa;
   aAlfa = fFecha % 0402; nNum = aAlfa; |HAZ MesLetra;
   eaMesL = aAlfa;
   aAlfa = fFecha % 0704;
   eaAnyoL = aAlfa;

   |SI nSwCrystal ! 0;
        |SI #dscaz021#4 = "C"; |O #dscaz021#4 = "A";
           aInforme = "Carta emision de talones"; |HAZ ObtenInforme;
           |INFOR aInforme;
           |SI FSalida ! 0; |ACABA; |FINSI;
           Divisa = #dscam046#18; |HAZ TomaDecim;
        |FINSI;

        |BUCLE TalonDet;

        |SI #dscaz021#4 = "C"; |O #dscaz021#4 = "A";
           |PIEINF; |FININF;
        |FINSI;

        |SI #dscaz021#4 = "T"; |O #dscaz021#4 = "A";
           |ABRE #dscam072;
           #dscam072#0 = #dscam046#6;
           |LEE 000#dscam072.=;
           |SI FSalida = 0
              aInforme = #dscam072#2; |QBF aInforme;
           |SINO;
              aInforme = "Emision de talones"; |HAZ ObtenInforme;
           |FINSI;
           |CIERRA #dscam072;

           |INFOR aInforme;
           |SI FSalida = 0;
              |PRINT;
              |PIEINF; |FININF;
           |FINSI;
           |SI #dscaz021#3 = "N";
              |SI #dscam051#101 = "S";
                 #dscam046#16 = (("0"*15) + #dscaz021#5) % -115;
              |FINSI;
              |GRABA 020#dscam046.a;

              #dscaz021#5 = #dscaz021#5 + 1;
           |SINO;
              #dscaz021#5 = #dscam046#16;
           |FINSI;
        |FINSI;
   |SINO;           || Crystal
        |SI #dscaz021#4 = "C"; |O #dscaz021#4 = "A";
           aInforme = "Carta emision de talones"; |HAZ ObtenInforme;

           |SI aInf ! aInforme;
               |SI aInf ! "";
                    |PIEINF; |FININF; aInf = "";
               |FINSI;
               |INFOR aInforme;
               |SI FSalida ! 0; |ACABA; |FINSI;
           |FINSI;
           aInf = aInforme;

           Divisa = #dscam046#18; |HAZ TomaDecim;
        |FINSI;

        |BUCLE TalonDet;

        |SI #dscaz021#4 = "T"; |O #dscaz021#4 = "A";
           |ABRE #dscam072;
           #dscam072#0 = #dscam046#6;
           |LEE 000#dscam072.=;
           |SI FSalida = 0
              aInforme = #dscam072#2; |QBF aInforme;
           |SINO;
              aInforme = "Emision de talones"; |HAZ ObtenInforme;
           |FINSI;
           |CIERRA #dscam072;

           |SI aInf ! aInforme;
               |SI aInf ! "";
                    |PIEINF; |FININF; aInf = "";
               |FINSI;
               |INFOR aInforme;
               |SI FSalida ! 0; |ACABA; |FINSI;
               aInf = aInforme;
           |FINSI;
           |PRINT;

           |SI #dscaz021#3 = "N";
              |SI #dscam051#101 = "S";
                 #dscam046#16 = (("0"*15) + #dscaz021#5) % -115;
              |FINSI;
              |GRABA 020#dscam046.a;

              #dscaz021#5 = #dscaz021#5 + 1;
           |SINO;
              #dscaz021#5 = #dscam046#16;
           |FINSI;
        |FINSI;
   |FINSI;

   |SI HayConta = 1; |HAZ ContTalones; |FINSI;

   #dscam046#7 = "S"; |GRABA 020#dscam046.a;
|FPRC;

|DEFBUCLE Talones;
#dscam046#1;
7;
#dscaz021#0,#dscaz021#3;
#dscaz021#1,#dscaz021#3;
be;
NULL,Talones;
|FIN;

|PROCESO ContTalones;
      |SI #0#3 = "N";
         |SI #dscam051#1 = "S";
            |ABRE #dscam030;
            #dscam030#0 = #dscaz021#2;
            |LEE 010#dscam030.=;
            |SI FSalida = 0;
               Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
               |NOME_DAT #6 Comodin;
               |DELINDEX #dscaw013; |ABRE #dscaw013;
               |DDEFECTO #dscaw013;
               #dscaw013#0  = 1;            #dscaw013#15 = #dscaz021#2;
               #dscaw013#5  = #dscam046#0;  #dscaw013#6  = #dscam046#0;
               #dscaw013#11 = "N";          #dscaw013#12 = 5;
               #dscaw013#13 = "dscam047";   #dscaw013#14 = 0;
               |GRABA 020#dscaw013.n;
               |CIERRA #dscaw013;

               Comodin = #dscaz021#2;
               Comodin = "dscam033.tab;" + Comodin + ",E";
               |LIBERA #dscam046; |CIERRAT #dscam046;
               |SUB_EJECUTA_NP Comodin;
               |ABRET #dscam046; |LEE 101#dscam046.=;

               |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".dat"; |FBORRA aAlfa;
               |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ddx"; |FBORRA aAlfa;
               |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ixx"; |FBORRA aAlfa;
            |FINSI;
            |CIERRA #dscam030;
         |FINSI;
      |SINO;
         #dscaz021#5 = #dscam046#16;
      |FINSI;
|FPRC;

|PROCESO LineasTal;
   || Actualizo  el historico de pagos

   #dscam008#40 = #dscam047#13;
   |LEE 101#dscam008.=;
   |SI FSalida = 0;
      #dscam009#14 = #dscam047#13;
      #dscam009#3 = 99;
      |LEE 010#dscam009.];
      |SI FSalida ! 0;
         |LEE 010#dscam009.u;
         |SI FSalida = 0; |Y #dscam009#14 = #dscam047#13;
            LinTal = #dscam009#3 + 1;
         |SINO;
            LinTal = 1;
         |FINSI;
      |SINO;
         |SI #dscam009#14 = #dscam047#13;
            LinTal = #dscam009#3 + 1;
         |SINO;
            |LEE 010#dscam009.a;
            |SI FSalida = 0; |Y #dscam009#14 = #dscam047#13;
               LinTal = #dscam009#3 + 1;
            |SINO;
               LinTal = 1;
            |FINSI;
         |FINSI;
      |FINSI;

      |DDEFECTO #dscam009;
      #dscam009#14 = #dscam047#13;        || N§ documento
      #dscam009#13 = #dscam047#2;         || Libro
      #dscam009#0  = #dscam047#4;         || Serie
      #dscam009#1  = #dscam047#3;         || Factura
      #dscam009#2  = #dscam047#5;         || Recibo
      #dscam009#3  = LinTal;              || N§ de pago
      #dscam009#4  = #dscam046#10;        || Cuenta de pago
      #dscam009#5  = "PTA";
      #dscam009#6  = #dscam046#1;         || Fecha de vencimiento
      #dscam009#7  = #dscam008#23;        || Total liquidado
      #dscam009#8  = #dscam047#7;         || Importe efecto
      #dscam009#9  = 0;
      #dscam009#20 = #dscam008#57;        || Total liquidado
      #dscam009#21 = #dscam047#18;        || Importe efecto
      #dscam009#22 = 0;
      #dscam009#25 = #dscam008#61;        || Cambio Actual;
      |GRABA 020#dscam009.n;

      || Actualizo el recibo
      #dscam008#14 = "L";
      #dscam008#15 = "Recibo liquidado";
      #dscam008#26 = #dscam046#1;
      #dscam008#23 = #dscam008#23 + #dscam047#7;
      #dscam008#57 = #dscam008#57 + #dscam047#18;
      #dscam008#25 = #dscam008#22 + #dscam008#24 + #dscam008#38;
      #dscam008#56 = #dscam008#53 + #dscam008#54 + #dscam008#55 + #dscam008#62;
      #dscam008#31 = #dscam008#25 - #dscam008#23;
      #dscam008#58 = #dscam008#56 - #dscam008#57;
      |GRABA 020#dscam008.a; |LIBERA #dscam008;
   |FINSI;
|FPRC;

|PROCESO MesLetra;
   |SI nNum = 1;  aAlfa = "Enero     "; |FINSI;
   |SI nNum = 2;  aAlfa = "Febrero   "; |FINSI;
   |SI nNum = 3;  aAlfa = "Marzo     "; |FINSI;
   |SI nNum = 4;  aAlfa = "Abril     "; |FINSI;
   |SI nNum = 5;  aAlfa = "Mayo      "; |FINSI;
   |SI nNum = 6;  aAlfa = "Junio     "; |FINSI;
   |SI nNum = 7;  aAlfa = "Julio     "; |FINSI;
   |SI nNum = 8;  aAlfa = "Agosto    "; |FINSI;
   |SI nNum = 9;  aAlfa = "Septiembre"; |FINSI;
   |SI nNum = 10; aAlfa = "Octubre   "; |FINSI;
   |SI nNum = 11; aAlfa = "Noviembre "; |FINSI;
   |SI nNum = 12; aAlfa = "Diciembre "; |FINSI;
|FPRC;

|PROCESO PonComas;
   Comodin = eaImporte; |QBF Comodin;
   Comodin = Comodin - ".";
   |SI FSalida ! 0;
      nCalc = FSalida + 98;
      aDecs = Comodin % nCalc; Comodin = Comodin - aDecs;
   |FINSI;

   Comodin1 = "";
   aLong = Comodin % 0; nLong = aLong;
   |PARA; |SI nLong > 3; |HACIENDO;
      Comodin1 = ("." + (Comodin % -103)) + Comodin1;
      nCalc = 100 + (nLong - 3);
      Comodin = Comodin % nCalc;
      aLong = Comodin % 0; nLong = aLong;
   |SIGUE;
   eaImporte = Comodin + Comodin1;
   |SI aDecs ! "";
      eaImporte = eaImporte + "," + aDecs;
   |FINSI;
|FPRC;

|PROCESO SacaNivel1;
   Comodin = Cuenta; |QBF Comodin;
   aLong = Comodin % 0; nLong = aLong;
   Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 1"; |HAZ ObtenDato;
   |SI #canempr@#CmpNum# = nLong; Nivel = 1; |FINSI;
   Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 2"; |HAZ ObtenDato;
   |SI #canempr@#CmpNum# = nLong; Nivel = 2; |FINSI;
   Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 3"; |HAZ ObtenDato;
   |SI #canempr@#CmpNum# = nLong; Nivel = 3; |FINSI;
   Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 4"; |HAZ ObtenDato;
   |SI #canempr@#CmpNum# = nLong; Nivel = 4; |FINSI;
   Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 5"; |HAZ ObtenDato;
   |SI #canempr@#CmpNum# = nLong; Nivel = 5; |FINSI;
   Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 6"; |HAZ ObtenDato;
   |SI #canempr@#CmpNum# = nLong; Nivel = 6; |FINSI;
|FPRC;

|PROCESO LeeDatosProv;
   eaCodigo = #dscam008#32; eaTipoCod = "P"; aCuenta = #dscam008#5; |HAZ LeeDatos;
/*
   |SI HayGestion = 1; |Y #dscam008#32 ! "      ";
      Comodin = #48#17; |QBF Comodin; Comodin = Comodin + "fich/" + (("00000" + #dscam008#46) % -105) + "/";
      |PATH_DAT #100 Comodin;
      |ABRE #agif112@;
      Fichero = "Proveedores"; Tipo = "G"; Cmp = "Codigo Proveedor"; |HAZ ObtenDato;
      #agif112@#CmpNum# = #dscam008#32;
      |LEE 000#agif112@.=;
      |SI FSalida = 0;
         Fichero = "Proveedores"; Tipo = "G"; Cmp = "Nif/Cif"; |HAZ ObtenDato;
         eaNif       = #agif112@#CmpNum#;
         Fichero = "Proveedores"; Tipo = "G"; Cmp = "Nombre Comercial"; |HAZ ObtenDato;
         eaNombre    = #agif112@#CmpNum#;
         Fichero = "Proveedores"; Tipo = "G"; Cmp = "Direccion"; |HAZ ObtenDato;
         eaDireccion = #agif112@#CmpNum#;
         Fichero = "Proveedores"; Tipo = "G"; Cmp = "Poblacion"; |HAZ ObtenDato;
         eaPoblacion = #agif112@#CmpNum#;
         Fichero = "Proveedores"; Tipo = "G"; Cmp = "Provincia"; |HAZ ObtenDato;
         eaProvincia = #agif112@#CmpNum#;
         Fichero = "Proveedores"; Tipo = "G"; Cmp = "Codigo Postal 1"; |HAZ ObtenDato;
         Calc = CmpNum;
         Fichero = "Proveedores"; Tipo = "G"; Cmp = "Codigo Postal 2"; |HAZ ObtenDato;
         eaCP        = (("00" + #agif112@#Calc#) % -102) + (("000" + #agif112@#CmpNum#) % -103);
      |FINSI;
      |CIERRA #agif112@;
   |FINSI;
   |SI HayConta = 1; |Y #dscam008#32 = "      ";
      Comodin = #48#16; |QBF Comodin; Comodin = Comodin + "def/caclipro.mas";
      |CARGA_DEF Comodin, caclipr@;
      |SI FSalida = 0;
         Comodin = #48#16; |QBF Comodin; Comodin = Comodin + "fich/" + (("00000" + #48#14) % -105) + #48#19 + "/";
         |PATH_DAT #101 Comodin; |ABRE #caclipr@;
         Fichero = "Clientes/Proveedores"; Tipo = "C"; Cmp = "Cliente/Proveedor"; |HAZ ObtenDato;
         #caclipr@#CmpNum# = "P";
         Fichero = "Clientes/Proveedores"; Tipo = "C"; Cmp = "Cuenta Contable"; |HAZ ObtenDato;
         #caclipr@#CmpNum# = #dscam008#5;
         Cuenta = #dscam008#5; |HAZ SacaNivel1;
         Fichero = "Clientes/Proveedores"; Tipo = "C"; Cmp = "Digito Contable"; |HAZ ObtenDato;
         #caclipr@#CmpNum# = Nivel;
         |LEE 000#caclipr@.=;
         |SI FSalida = 0;
            Fichero = "Clientes/Proveedores"; Tipo = "C"; Cmp = "Nif/Cif"; |HAZ ObtenDato;
            eaNif       = #caclipr@#CmpNum#;
            Fichero = "Clientes/Proveedores"; Tipo = "C"; Cmp = "Razon Social"; |HAZ ObtenDato;
            eaNombre    = #caclipr@#CmpNum#;
            Fichero = "Clientes/Proveedores"; Tipo = "C"; Cmp = "Direccion"; |HAZ ObtenDato;
            eaDireccion = #caclipr@#CmpNum#;
            Fichero = "Clientes/Proveedores"; Tipo = "C"; Cmp = "Poblacion"; |HAZ ObtenDato;
            eaPoblacion = #caclipr@#CmpNum#;
            Fichero = "Clientes/Proveedores"; Tipo = "C"; Cmp = "Provincia"; |HAZ ObtenDato;
            eaProvincia = #caclipr@#CmpNum#;
            Fichero = "Clientes/Proveedores"; Tipo = "C"; Cmp = "Codigo Postal 1"; |HAZ ObtenDato;
            Calc = CmpNum;
            Fichero = "Clientes/Proveedores"; Tipo = "C"; Cmp = "Codigo Postal 2"; |HAZ ObtenDato;
            eaCP        = (("00" + #caclipr@#Calc#) % -102) + (("000" + #caclipr@#CmpNum#) % -103);
         |FINSI;
         |CIERRA #caclipr@; |DESCARGA_DEF #caclipr@;
      |FINSI;
   |FINSI;
*/
|FPRC;

|PROCESO MiraParam; |TIPO 7;
   |ABRE #dscam051;
   |LEE 000#dscam051.p;
   |SI FSalida ! 0;
      |DDEFECTO #dscam051;
      |GRABA 020#dscam051.n;
      |LEE 000#dscam051.p;
   |FINSI;
   |CIERRA #dscam051;

   |SI #dscam051#1 = "S";
      Comodin = #dscam051#61;
      |C_M #dscaz021#2,1,Comodin;
   |SINO;
      |C_M #dscaz021#2,1,"N";
   |FINSI;
|FPRC;

|PROGRAMA;
   |CLS;
   |CABEZA "Emision de Talones";

   |HAZ Tipo8;

   |ABRE #dscam051;
   |LEE 010#dscam051.p;
   |SI FSalida ! 0;
      |DDEFECTO #dscam051;
      |GRABA 020#dscam051.n;
   |FINSI;
   |CIERRA #dscam051;

   |DDEFECTO #dscaz021;
   |SI HayConta = 1; |Y #dscam051#1 = "S";
      |C_M #dscaz021#2,1,"S";
      #dscaz021#2 = #dscam051#28;
   |SINO;
      |C_M #dscaz021#2,1,"N";
      #dscaz021#2 = "    ";
   |FINSI;

   |PINPA #0#0;
   |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      |IMPRE 0;
      |SI FSalida ! 0; |ACABA; |FINSI;
      aImp = Impresora;

      nSwCrystal = 1;
      |SI aImp = "CrystalReport"; nSwCrystal = 0; |FINSI;

      |ABRE #dscam008; |ABRE #dscam009; |ABRE #dscam014; |ABRE #dscam046;
      |BUCLE Talones;
      |CIERRA #dscam046; |CIERRA #dscam014; |CIERRA #dscam009; |CIERRA #dscam008;

      |SI nSwCrystal = 0; |Y aInf ! "";
          |PIEINF; |FININF;
      |FINSI;

      |FINIMP;

   |FINSI;
   |HAZ Tipo9;
|FPRO;
