|FICHEROS;
   dscaz106 #0;

   dscaw049 #10,MANTE;
   dscam096 #11;
   dscam008 #12;
   dscam009 #13;
   dscam030 #14;
   dscam051 #15;
   dscam095 #16;
   dscam002 #17;

   Referen@ #900;
   dscaw013 #910;
|FIN;

|VARIABLES;
   &enEmpCartera = 0; &enEmpGestion = 0; &enDocum = 0;
   &eaSerie = ""; &eaCliGest = ""; &nImporte = 0; &eaTipoOper = "";
   &nDeci_Base = 0;  &eaSesion = "";
   &eaUsuario = ""; &enImpAnt = 0;  &enImpAct = 0;  &eaDescr = "";
   &eaTipoReg = ""; &eaNumero = ""; &eaTipoOp = ""; &eaLlamada = "";
   &eaTipoRecibo = ""; &enNumDocum = 0; &eaMensRet = ""; &enSwError = 0; &eaTOperacion = "";
   &HayConta = 0;  &aInforme = "";
   &eaMes = "";

   ModoEntrada = 0;
   nFlag = 0;
   SwImp = 0;
   nDocum = 0;

   SwBuscaFac  = 0;
   SwError     = 0;
   nNumSec     = 0;
   nTotal      = 0;
   nNumMarcas  = 0;
   Linea       = 0;
   LinCob      = 0;
   UltFecha    = 0;
   UltNumero   = 0;

   aAlfa       = "";
   aAlfa1      = "";

   fFechaHoy = @;
|FIN;

|RUTINA inf66;
   #dscaw049#1 = 001;
|FRUT;

|RUTINA sup66;
   #dscaw049#1 = 999;
|FRUT;

|PROCESO Volcado;
   |SI nNumSec = 0;
      |SALVA_FICHA #dscam009;
      |SELECT #3#dscam009;
      |LEE 000#dscam009.u;
      |SI nNumSec [ #dscam009#33;
         nNumSec = #dscam009#33 + 1;
      |SINO;
         nNumSec = nNumSec + 1;
      |FINSI;
      |SELECT #1#dscam009;
      |LEE 000#dscam009.p; |REPON_FICHA #dscam009;
   |SINO;
      nNumSec = nNumSec + 1;
   |FINSI;

   |SI #dscam051#1 = "S";
      |ABRE #dscam030;
      #dscam030#0 = #dscaz106#1;
      |LEE 000#dscam030.=;
      |SI FSalida = 0;
         |SI #dscam030#8 = "N"; nNumSec = 0; |FINSI;
      |SINO;
         nNumSec = 0;
      |FINSI;
      |CIERRA #dscam030;
   |FINSI;

   #dscam008#40 = #dscaw049#8;
   |LEE 000#dscam008.=;

   #dscam009#14 = #dscaw049#8;
   #dscam009#3 = 99;
   |LEE 010#dscam009.];
   |SI FSalida ! 0;
      |LEE 010#dscam009.u;
      |SI FSalida = 0; |Y #dscam009#14 = #dscaw049#8;
         LinCob = #dscam009#3 + 1;
         UltFecha = #dscam009#6; UltNumero = #dscam009#3;
      |SINO;
         LinCob = 1;
      |FINSI;
   |SINO;
      |SI #dscam009#0 = #dscaw049#3; |Y #dscam009#14 = #dscaw049#8;
         LinCob = #dscam009#3 + 1;
         UltFecha = #dscam009#6; UltNumero = #dscam009#3;
      |SINO;
         |LEE 010#dscam009.a;
         |SI FSalida = 0; |Y #dscam009#14 = #dscaw049#8;
            LinCob = #dscam009#3 + 1;
            UltFecha = #dscam009#6; UltNumero = #dscam009#3;
         |SINO;
            LinCob = 1;
         |FINSI;
      |FINSI;
   |FINSI;

   |DDEFECTO #dscam009;
   #dscam009#0  = #dscaw049#4;
   #dscam009#1  = #dscaw049#3;
   #dscam009#2  = #dscaw049#5;
   #dscam009#3  = LinCob;
   #dscam009#5  = "RCE";
   #dscam009#6  = #dscaz106#0;
   #dscam008#40 = #dscaw049#8;
   |LEE 010#dscam008.=;
   |SI FSalida = 0;
      #dscam009#7  = #dscam008#23; #dscam009#20 = #dscam008#61;
   |FINSI;
   #dscam009#8  = 0;           #dscam009#21 = 0;
   #dscam009#9  = 0;           #dscam009#23 = 0;
   #dscam009#11 = 0;
   #dscam009#14 = #dscaw049#8; #dscam009#25 = 1;
   #dscam009#33 = nNumSec;
   |GRABA 020#dscam009.n;
   eaUsuario = Usuario % 0810;
   eaTipoReg = "CB";  eaNumero = (("000000000" + #dscam009#17) % -109) + "/" + (("000" + #dscam009#3) % -103);
   eaDescr   = "ALTA ELIMINACION PAGO DOMICILIADO (" + (("000000000" + #dscam009#17) % -109) + "/" + (("000" + #dscam009#3) % -103);
   eaDescr   = eaDescr + ") DESDE PAGOS DOMICILIADOS";
   eaTipoOp  = "A";
   enImpAnt = #dscam008#64; enImpAct = #dscam008#64 - #dscam009#9;
   |HAZ GrabaAudit;

   #dscam096#0 = #dscam008#17;
   #dscam096#1 = #dscam008#37;
   |LEE 101#dscam096.=;
   |SI FSalida = 0;
      #dscam096#15 = "R"; |GRABA 020#dscam096.a; |LIBERA #dscam096;
   |FINSI;

   #dscam008#40 = #dscaw049#8;
   |LEE 010#dscam008.=;
   |SI FSalida = 0;
      #dscam008#26 = "";
      #dscam008#23 = #dscam008#23 - #dscaw049#7;  #dscam008#57 = #dscam008#57 - #dscaw049#7;
      ||#dscam008#24 = #dscam008#24 + #dscaz106#2; #dscam008#54 = #dscam008#54 + #dscaz106#2;

      #dscam008#25 = #dscam008#22 + #dscam008#24 + #dscam008#38;
      #dscam008#56 = #dscam008#53 + #dscam008#54 + #dscam008#55 + #dscam008#62;

      #dscam008#31 = #dscam008#25 - #dscam008#23; #dscam008#58 = #dscam008#56 - #dscam008#57;

      #dscam008#17 = 0; #dscam008#37 = 0;
      #dscam008#14 = "P";
      #dscam008#15 = "Pendiente de pago";
      |GRABA 020#dscam008.a;
   |FINSI;

   |SI #dscam051#1 = "S"; |Y HayConta = 1; |Y #dscaz106#1 ! "    ";
      aAlfa = Usuario; |QBF aAlfa; aAlfa = "ac" + aAlfa;
      |NOME_DAT #910 aAlfa;
      |DELINDEX #dscaw013; |ABRE #dscaw013;
      |SI nNumSec = 0;
         Linea = 1;
         #dscaw013#15 = #dscaz106#1;  #dscaw013#0 = Linea;
         #dscaw013#13 = "dscam009";   #dscaw013#14 = 14;
         #dscaw013#5 = #dscam009#14;  #dscaw013#6 = #dscam009#14;
         #dscaw013#11 = "N";          #dscaw013#12 = 9;
         |GRABA 020#dscaw013.n;
         |LIBERA #dscaw013;
         Linea = Linea + 1;
         #dscaw013#15 = #dscaz106#1;  #dscaw013#0 = Linea;
         #dscaw013#13 = "dscam009";   #dscaw013#14 = 3;
         #dscaw013#5 = #dscam009#3;   #dscaw013#6 = #dscam009#3;
         #dscaw013#11 = "N";          #dscaw013#12 = 3;
         |GRABA 020#dscaw013.n;
         |LIBERA #dscaw013;
      |SINO;
         Linea = 1;
         #dscaw013#15 = #dscaz106#1;  #dscaw013#0 = Linea;
         #dscaw013#13 = "dscam009";   #dscaw013#14 = 33;
         #dscaw013#5 = #dscam009#33;  #dscaw013#6 = #dscam009#33;
         #dscaw013#11 = "N";          #dscaw013#12 = 9;
         |GRABA 020#dscaw013.n; |LIBERA #dscaw013;
      |FINSI;
      |CIERRA #dscaw013;
      aAlfa = #dscaz106#1; |QBF aAlfa;
      aAlfa = "dscam033.tab;" + aAlfa;

      |LIBERA #dscam008; |CIERRAT #dscam008;
      |LIBERA #dscam009; |CIERRAT #dscam009;
      |SUB_EJECUTA_NP aAlfa; |DELINDEX #dscaw013;
      |ABRET #dscam008; |LEE 101#dscam008.=;
      |ABRET #dscam009; |LEE 101#dscam009.=;
   |FINSI;

   eaTOperacion = "B"; eaTipoRecibo = "V"; enNumDocum = #dscaw049#8; |HAZ ProcesaTempo;
|FPRC;

|DEFBUCLE Volcado;
#dscaw049#1;
;
INICIO;
FINAL;
;
NULL,Volcado;
|FIN;

|PROCESO BajaBloq;
   eaTOperacion = "B"; eaTipoRecibo = "V"; enNumDocum = #dscaw049#8; |HAZ ProcesaTempo;
|FPRC;

|DEFBUCLE BajaBloq;
#dscaw049#1;
;
INICIO;
FINAL;
;
NULL,BajaBloq;
|FIN;

|PROCESO MiraSiEsta;
   enSwError = 1;
|FPRC;

|DEFBUCLE MiraSiEsta;
#dscaw049#1;
8;
001,nDocum;
999,nDocum;
;
NULL,MiraSiEsta;
|FIN;

|PROCESO BuscaDocumen;
   |SI FSalida = 10;
      #dscam008#40 = #dscaw049#8;
      |LEE 000#dscam008.];
      |CONSULTA_CLAVE #1#dscam008;
      #dscaw049#8 = #dscam008#40;
   |FINSI;
   |SI FSalida = 11;
      SwBuscaFac = 1;
      |C_M #dscaw049#2,1,"S"; |C_M #dscaw049#3,1,"S";
      |C_M #dscaw049#4,1,"S"; |C_M #dscaw049#5,1,"S";
   |SINO;
      |C_M #dscaw049#2,1,"N"; |C_M #dscaw049#3,1,"N";
      |C_M #dscaw049#4,1,"N"; |C_M #dscaw049#5,1,"N";
      SwBuscaFac = 0;
      #dscam008#40 = #dscaw049#8;
      |LEE 000#dscam008.=;
      |SI FSalida ! 0;
         |MENAV "    Recibo inexistente"; |ERROR;
      |SINO;
         |SI #dscam008#17 = 0;
            |MENAV "    Recibo no domiciliado"; |ERROR;
         |SINO;
            #dscam096#0 = #dscam008#17;
            #dscam096#1 = #dscam008#37;
            |LEE 000#dscam096.=;
            |SI FSalida = 0;
               |SI #dscam008#14 ! "L";
                  |MENAV "    El recibo ya ha sido eliminado de la domiciliacion"; |ERROR;
               |SINO;
                  enSwError = 0; nDocum = #dscaw049#8;
                  |SALVA_FICHA #dscaw049; |BUCLE MiraSiEsta; |REPON_FICHA #dscaw049;
                  |SI enSwError = 1;
                     |MENAV "    Recibo ya incluido "; |ERROR;
                  |SINO;
                     eaTOperacion = "A"; eaTipoRecibo = "V"; enNumDocum = #dscaw049#8; |HAZ ProcesaTempo;
                     |SI enSwError = 0;
                        #dscaw049#7 = #dscam096#7;
                        #dscaw049#2 = #dscam008#27;
                        #dscaw049#4 = #dscam008#0;
                        #dscaw049#3 = #dscam008#1;
                        #dscaw049#5 = #dscam008#2;
                        #dscaw049#6 = #dscam008#3;
                     |FINSI;
                  |FINSI;
               |FINSI;
               |LEE 000#dscam096.s;
            |SINO;
               |MENAV "    El recibo no se encuentra domiciliado "; |ERROR;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO BuscaFactura;
   |SELECT #6#dscam008;
   |SI FSalida = 10;
      #dscam008#27 = #dscaw049#2;
      #dscam008#0  = #dscaw049#4;
      #dscam008#1  = #dscaw049#3;
      #dscam008#2  = #dscaw049#5;
      #dscam008#69 = " ";
      |LEE 000#dscam008.];
      |LEE 000#dscam008.=;
      |CONSULTA_CLAVE #6#dscam008;
      |SI FSalida = 0;
         #dscaw049#2 = #dscam008#27;
         #dscaw049#4 = #dscam008#0;
         #dscaw049#3 = #dscam008#1;
         #dscaw049#5 = #dscam008#2;
         #dscaw049#6 = #dscam008#3;
      |SINO;
         |ERROR;
      |FINSI;
   |FINSI;
   |SI SwBuscaFac = 1;
      SwError = 1;
      |SELECT #2#dscam008;
      #dscam008#27 = #dscaw049#2;
      #dscam008#0  = #dscaw049#4;
      #dscam008#1  = #dscaw049#3;
      #dscam008#2  = #dscaw049#5;
      |LEE 000#dscam008.=;
      |PARA; |SI FSalida = 0; |Y #dscam008#27 = #dscaw049#2; |Y #dscam008#0 = #dscaw049#4;
       |Y #dscam008#1 = #dscaw049#3; |Y #dscam008#2 = #dscaw049#5; |HACIENDO;
         aAlfa = #dscam008#3; |QBF aAlfa; aAlfa = aAlfa % -104;
         fFechaHoy = ~; aAlfa1 = fFechaHoy; |QBF aAlfa1; aAlfa1 = aAlfa1 % -104;
         |SI aAlfa = aAlfa1;
            SwError = 0; |SAL;
         |SINO;
            |LEE 000#dscam008.s;
         |FINSI;
      |SIGUE;
      |SI SwError ! 0;
         |MENAV "    Recibo inexistente"; |POSICIONATE #dscaw049#8;
      |SINO;
         |SI #dscam008#17 = 0;
            |MENAV "    Recibo no domiciliado"; |POSICIONATE #dscaw049#8;
         |SINO;
            #dscam096#0 = #dscam008#17;
            #dscam096#1 = #dscam008#37;
            |LEE 000#dscam096.=;
            |SI FSalida = 0;
               |SI #dscam008#14 ! "L";
                  |MENAV "    El recibo ya ha sido retirado de la domiciliacion"; |POSICIONATE #dscaw049#8;
               |SINO;
                  enSwError = 0;
                  eaTOperacion = "A"; eaTipoRecibo = "V"; enNumDocum = #dscaw049#8; |HAZ ProcesaTempo;
                  |SI enSwError = 1;
                     |MENAV "    Recibo ya incluido "; |ERROR;
                  |SINO;
                     #dscaw049#8 = #dscam008#40;
                     #dscaw049#6 = #dscam008#3;
                     #dscaw049#7 = #dscam096#7;
                  |FINSI;
               |FINSI;
               |LEE 000#dscam096.s;
            |SINO;
               |MENAV "    El recibo no se encuentra domiciliado "; |POSICIONATE #dscaw049#8;
            |FINSI;
         |FINSI;
      |FINSI;
      |SELECT #1#dscam008;
      |C_M #dscaw049#2,1,"N"; |C_M #dscaw049#3,1,"N";
      |C_M #dscaw049#4,1,"N"; |C_M #dscaw049#5,1,"N";
   |FINSI;
   |SELECT #1#dscam008;
|FPRC;

|PROCESO Tipo2; |TIPO 2;
  ModoEntrada = (FEntrada / 100) ! 0;
  nFlag = 0 +. 1;
  |SI ModoEntrada = 1; |Y nFlag > 0;
      eaTOperacion = "A"; eaTipoRecibo = "V"; enNumDocum = #dscaw049#8; |HAZ ProcesaTempo;
  |FINSI;
  |SI ModoEntrada = 3;
     eaTOperacion = "B"; eaTipoRecibo = "V"; enNumDocum = #dscaw049#8; |HAZ ProcesaTempo;
  |FINSI;
  nNumMarcas = nNumMarcas +. 1;
|FPRC;

|PROCESO Imprime;
   #dscam008#40 = #dscaw049#8;
   |LEE 000#dscam008.=;
   |SI FSalida ! 0; |DDEFECTO #dscaw049; |FINSI;

   #dscam095#0 = #dscam008#17;
   |LEE 000#dscam095.=;
   |SI FSalida ! 0; |DDEFECTO #dscam095; |FINSI;

   #dscam002#0 = #dscam095#16;
   #dscam002#1 = #dscam095#17;
   |LEE 000#dscam002.=;
   |SI FSalida ! 0; |DDEFECTO #dscam002; |FINSI;

   |PRINT; |PIEINF;
|FPRC;

|DEFBUCLE Imprime;
#dscaw049#1;
;
INICIO;
FINAL;
;
NULL,Imprime;
|FIN;

|PROCESO Mes;
   eaMes = #dscaz106#0; |QBF eaMes; eaMes = eaMes % 0402;

   |SI eaMes = "01"; eaMes = "Enero";      |FINSI;
   |SI eaMes = "02"; eaMes = "Febrero";    |FINSI;
   |SI eaMes = "03"; eaMes = "Marzo";      |FINSI;
   |SI eaMes = "04"; eaMes = "Abril";      |FINSI;
   |SI eaMes = "05"; eaMes = "Mayo";       |FINSI;
   |SI eaMes = "06"; eaMes = "Junio";      |FINSI;
   |SI eaMes = "07"; eaMes = "Julio";      |FINSI;
   |SI eaMes = "08"; eaMes = "Agosto";     |FINSI;
   |SI eaMes = "09"; eaMes = "Septiembre"; |FINSI;
   |SI eaMes = "10"; eaMes = "Octubre";    |FINSI;
   |SI eaMes = "11"; eaMes = "Noviembre";  |FINSI;
   |SI eaMes = "12"; eaMes = "Diciembre";  |FINSI;
|FPRC;

|PROCESO MiraParam; |TIPO 7;
   |SI #dscam051#1 = "S";
      aAlfa = #dscam051#61;
      |C_M #dscaz106#1,1,aAlfa;
   |SINO;
      |C_M #dscaz106#1,1,"N";
   |FINSI;
|FPRC;

|PROGRAMA;
   |HAZ Tipo8; |HAZ TomaDecim;

   |ABRE #dscam008; |ABRE #dscam096; |ABRE #dscam009; |ABRE #dscam030;
   |ABRE #dscam051; |ABRE #dscam095; |ABRE #dscam002;
   |LEE 000#dscam051.p;
   |SI FSalida ! 0; |DDEFECTO #dscam051; |FINSI;

   |CLS;
   |CABEZA " Eliminacion de recibos ";
   |DDEFECTO #dscaz106;
   |SI #dscam051#1 = "S"; #dscaz106#1 = #dscam051#80; |SINO; #dscaz106#1 = "    "; |FINSI;

   |PINPA #0#0; |PINDA #0#0;
   |ENTLINEAL #1#dscaw049,-1,7,21,1,inf66,sup66;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      nNumMarcas = 0;
      aAlfa = "re" + Usuario; |NOME_DAT #10 aAlfa;
      |DELINDEX #dscaw049; |ABRE #dscaw049;
      |ENTLINEAL #1#dscaw049,-1,1,21,1,inf66,sup66;
      |SI nNumMarcas > 0;
         |CONFI "    NConforme con los datos introducidos ? ";
         |SI FSalida = 0;
            |CONFI "    NEmitir carta explicativa eliminacion ? ";
            |SI FSalida = 0;
               SwImp = 1;
            |SINO;
               SwImp = 0;
            |FINSI;
            |HAZ Mes;
            |SI SwImp = 1;
               |IMPRE 0;
               |SI FSalida = 0;
                  aInforme = "Carta eliminacion pagos"; |HAZ ObtenInforme;
                  |SI aInforme = "Carta eliminacion pagos"; aInforme = "dscaz106"; |FINSI;
                  |INFOR aInforme;
                  |SI FSalida = 0; |BUCLE Imprime; |FINSI;
                  |PIEINF; |FININF;
               |FINSI;
               |FINIMP;
            |FINSI;
            |BUCLE Volcado;
         |SINO;
            |BUCLE BajaBloq;
         |FINSI;
      |FINSI;

      |CIERRA #dscam030; |CIERRA #dscam051; |CIERRA #dscam095; |CIERRA #dscam002;
      |CIERRA #dscam009; |CIERRA #dscam008; |CIERRA #dscaw049; |CIERRA #dscam096;
   |FINSI;

   eaSesion   = Usuario; |HAZ LimpiaTempo;

   |HAZ Tipo9;
|FPRO;
