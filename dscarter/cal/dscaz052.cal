|FICHEROS;
   dscaz052 #0;

   dscam003 #1;
   dscam004 #2;

   dscam012 #3;
   dscam013 #4;
   dscam067 #5;
|FIN;

|VARIABLES;
   aAlfa    = "";
   NumLin   = 0;
   nLinea   = 0;

   nAbono   = 0;
   nEmision = 0;
|FIN;

|PROCESO Recibos;
   |SI #dscam003#17 ! 0; |Y #dscam003#14 = "R";
      #dscam012#0 = #dscam003#17; |LEE 000#dscam012.=;

      #dscam013#0 = #dscam003#17;
      #dscam013#1 = #dscam003#37;
      |LEE 000#dscam013.=;
      |SI FSalida = 0;
         #dscam003#84 = #dscam013#15;
         |SI #dscam012#8 ! "N";
            |SI #dscam003#31 = #dscam003#30;
               #dscam003#26  = #dscam012#1;  #dscam003#31 = 0;
			   |HAZ EsArtenvas;
			   |SI FSalida ! 0;
                   #dscam003#23  = #dscam003#30; #dscam003#61 = #dscam003#64;
                   #dscam003#14  = "L";          #dscam003#15 = "Recibo liquidado";
			   |SINO;
                   #dscam003#31  = #dscam003#30; #dscam003#65 = #dscam003#64;
                   #dscam003#14  = "R";          #dscam003#15 = "Remesado";
			   |FINSI;
               #dscam003#53 = #dscam012#1;
               #dscam003#51 = #dscam012#2;
               #dscam003#52 = #dscam012#3;

               || Compruebo si la informacion del campo 17 del dscam013 es fiable. Si no lo es
               ||     intento buscar la linea del movimiento y si no existe creo la linea en el
               ||     ultimo lugar y escribo el dato en la linea de la remesa. Si existe pero no
               ||     es un movimiento de abono, escribo el movimiento en ultimo lugar.

               #dscam004#17 = #dscam003#40;
               #dscam004#3  = #dscam013#17;
               |LEE 000#dscam004.=;
               |SI FSalida = 0;
                  |SI #dscam004#5 ! "REM";
                     nLinea = 1;
                     #dscam004#17 = #dscam003#40;
                     #dscam004#3  = 99;
                     |LEE 000#dscam004.];
                     |SI FSalida = 0;
                        |LEE 000#dscam004.a;
                        |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
                           nLinea = #dscam004#3 + 1;
                        |FINSI;
                     |SINO;
                        |LEE 000#dscam004.u;
                        |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
                           nLinea = #dscam004#3 + 1;
                        |FINSI;
                     |FINSI;
                  |SINO;
                     |ACABA;
                  |FINSI;
               |SINO;
                  nLinea = 1;
                  #dscam004#17 = #dscam003#40;
                  #dscam004#3  = 99;
                  |LEE 000#dscam004.];
                  |SI FSalida = 0;
                     |LEE 000#dscam004.a;
                     |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
                        nLinea = #dscam004#3 + 1;
                     |FINSI;
                  |SINO;
                     |LEE 000#dscam004.u;
                     |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
                        nLinea = #dscam004#3 + 1;
                     |FINSI;
                  |FINSI;
               |FINSI;

               |DDEFECTO #dscam004;
               #dscam004#17 = #dscam003#40;
               #dscam004#3  = nLinea;
               |GRABA 020#dscam004.b;
               #dscam004#0 = #dscam003#0;
               #dscam004#1 = #dscam003#1;
               #dscam004#2 = #dscam003#2;
               #dscam004#4 = #dscam012#14;
               #dscam004#5  = "REM";
               #dscam004#6  = #dscam012#1;
               #dscam004#7  = 0;            #dscam004#25  = 0;
               #dscam004#8  = #dscam013#22; #dscam004#26  = #dscam013#7;
               #dscam004#9  = 0;
               #dscam004#10 = 0;
               |GRABA 020#dscam004.a; |LIBERA #dscam004;
               #dscam013#17 = nLinea;
               |GRABA 020#dscam013.a; |LIBERA #dscam013;
            |SINO;
               |SI #dscam003#23 = #dscam003#30;
                  #dscam003#14  = "L";          #dscam003#15 = "Recibo liquidado";
               |FINSI;
            |FINSI;
         |FINSI;
         |GRABA 020#dscam003.a;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Recibos;
#dscam003#1;
;
INICIO;
FINAL;
be;
NULL,Recibos;
|FIN;

|PROCESO LineasRem;
   #dscam012#0 = #dscam013#0;   |LEE 000#dscam012.=;

   #dscam003#40 = #dscam013#16; |LEE 000#dscam003.=;
   #dscam003#84 = #dscam013#15;

   |SI #dscam012#8 ! "N";
      |SI #dscam003#14 ! "L"; |Y #dscam003#14 ! "I"; |Y #dscam013#15 = "S";
          #dscam004#17 = #dscam013#16;
          #dscam004#3  = #dscam013#17;
          |LEE 101#dscam004.=;
          |SI FSalida = 0;
             |SI #dscam004#33 ! #dscam003#59;
                #dscam013#22 = #dscam013#7 * #dscam004#33; |GRABA 020#dscam013.a;
                #dscam004#33 = #dscam003#59;
                #dscam004#8  = #dscam013#22; #dscam004#26  = #dscam013#7;
                |GRABA 020#dscam004.a;
             |FINSI;
             |LIBERA #dscam004;
          |SINO;
             |SI #dscam013#17 = 0;
                nLinea = 1;
                #dscam004#17 = #dscam003#40;
                #dscam004#3  = 99;
                |LEE 000#dscam004.];
                |SI FSalida = 0;
                   |LEE 000#dscam004.a;
                   |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
                      nLinea = #dscam004#3 + 1;
                   |FINSI;
                |SINO;
                   |LEE 000#dscam004.u;
                   |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
                      nLinea = #dscam004#3 + 1;
                   |FINSI;
                |FINSI;
             |SINO;
                nLinea = #dscam013#17;
             |FINSI;

             |SI #dscam013#22 = 0;
                #dscam013#22 = #dscam013#7 * #dscam003#57; |GRABA 020#dscam013.a;
             |FINSI;
             |DDEFECTO #dscam004;
             #dscam004#17 = #dscam003#40;
             #dscam004#3  = nLinea;
             |GRABA 020#dscam004.b;
             #dscam004#0 = #dscam003#0;
             #dscam004#1 = #dscam003#1;
             #dscam004#2 = #dscam003#2;
             #dscam004#4 = #dscam012#14;
             #dscam004#5  = "REM";
             #dscam004#6  = #dscam012#1;
             #dscam004#7  = 0;            #dscam004#25  = 0;
             #dscam004#33 = #dscam003#59;
             #dscam004#8  = #dscam013#22; #dscam004#26  = #dscam013#7;
             #dscam004#9  = 0;
             #dscam004#10 = 0;
             |GRABA 020#dscam004.a; |LIBERA #dscam004;
         |FINSI;
         #dscam003#26  = #dscam012#1;  #dscam003#31 = 0;
		 |HAZ EsArtenvas;
		 |SI FSalida ! 0;
             #dscam003#23  = #dscam003#30; #dscam003#61 = #dscam003#64;
             #dscam003#14  = "L";          #dscam003#15 = "Recibo liquidado";
	     |SINO;
             #dscam003#31  = #dscam003#30; #dscam003#65 = #dscam003#64;
             #dscam003#14  = "R";          #dscam003#15 = "Remesado";
		 |FINSI;
         #dscam003#53 = #dscam012#1;
         #dscam003#51 = #dscam012#2;
         #dscam003#52 = #dscam012#3;
         |SI #dscam003#17 = 0; #dscam003#17 = #dscam012#0; |FINSI;
         |SI #dscam003#37 = 0; #dscam003#37 = #dscam013#1; |FINSI;

         |GRABA 020#dscam003.a;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE LineasRem;
#dscam013#1;
;
INICIO;
FINAL;
be;
NULL,LineasRem;
|FIN;

|PROCESO Movtos;
   aAlfa = " Revisando documento " + #dscam003#40 + "          ";
   |ATRI I; |PINTA 2302, aAlfa; |ATRI N;

   |SI #dscam003#17 = 0; |ACABA; |FINSI;

   || Compruebo el n§ de linea de la emision y luego el de la remesa. Si el
   ||    primero es mayor que el segundo, los cambio.
   nAbono = 0; nEmision = 0;

   |DDEFECTO #dscam004;
   #dscam004#17 = #dscam003#40;
   |LEE 000#dscam004.];
   |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
      |SI #dscam004#5 = "REM"; nAbono   = #dscam004#3; |FINSI;
      |SI #dscam004#5 = "EMR"; nEmision = #dscam004#3; |FINSI;
      |SI nAbono ! 0; |Y nEmision ! 0;
         |SI nEmision > nAbono;
            nLinea = 1;
            #dscam004#17 = #dscam003#40;
            #dscam004#3  = 99;
            |LEE 000#dscam004.];
            |SI FSalida = 0;
               |LEE 000#dscam004.a;
               |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
                  nLinea = #dscam004#3 + 1;
               |FINSI;
            |SINO;
               |LEE 000#dscam004.u;
               |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
                  nLinea = #dscam004#3 + 1;
               |FINSI;
            |FINSI;

            |SALVA_FICHA #dscam004;
            #dscam004#17 = #dscam003#40;
            #dscam004#3  = nAbono;
            |LEE 000#dscam004.=;
            |SI FSalida = 0;
               |BORRA 020#dscam004.a;
               #dscam004#3 = nLinea;
               |GRABA 020#dscam004.n;

               #dscam004#17 = #dscam003#40;
               #dscam004#3  = nEmision;
               |LEE 000#dscam004.=;
               |SI FSalida = 0;
                  |BORRA 020#dscam004.a;
                  #dscam004#3 = nAbono;
                  |GRABA 020#dscam004.n;
               |FINSI;

               #dscam004#17 = #dscam003#40;
               #dscam004#3  = nLinea;
               |LEE 000#dscam004.=;
               |SI FSalida = 0;
                  |BORRA 020#dscam004.a;
                  #dscam004#3 = nEmision;
                  |GRABA 020#dscam004.n;
               |FINSI;

               #dscam004#17 = #dscam003#40;
               #dscam004#3  = nAbono;
               |LEE 000#dscam004.=;

               |SELECT #2#dscam013;
               #dscam013#16 = #dscam003#40;
               #dscam013#17 = 0;
               |LEE 000#dscam013.];
               |PARA; |SI FSalida = 0; |Y #dscam013#16 = #dscam003#40; |HACIENDO;

                  #dscam012#0 = #dscam013#0;
                  |LEE 000#dscam012.=;
                  |SI FSalida ! 0; |DDEFECTO #dscam012; |FINSI;

                  |SI #dscam012#1 = #dscam004#6;
                     || Tener en cuenta que se han cambiado los n§s de linea
                     #dscam013#17 = nEmision;
                     #dscam013#24 = nAbono;
                     |GRABA 020#dscam013.a;
                     |SAL;
                  |FINSI;

                  |LEE 000#dscam013.s;
               |SIGUE;
               |SELECT #1#dscam013;
            |FINSI;
            |REPON_FICHA #dscam004;
         |FINSI;
         nAbono = 0; nEmision = 0;
      |FINSI;
      |LEE 000#dscam004.s;
   |SIGUE;
|FPRC;

|DEFBUCLE Movtos;
#dscam003#1;
;
INICIO;
FINAL;
be;
NULL,Movtos;
|FIN;

|PROGRAMA;
   |SI PARAMETRO = "";
      |CLS;
      |CABEZA "Recalculo efectos";
      |PINPA #0#0; |PINDA #0#0;
      |ENDATOS #1#0;
      |SI #dscaz052#0 ! "S"; |ACABA; |FINSI;
   |SINO;
      |ATRI I; |PINTA 2310, "Ejecutando el recalculo de efectos"; |ATRI N;
      aAlfa = PARAMETRO;
      |PATH_DAT #0 aAlfa; |PATH_DAT #1 aAlfa; |PATH_DAT #2 aAlfa;
      |PATH_DAT #3 aAlfa; |PATH_DAT #4 aAlfa; |PATH_DAT #5 aAlfa;
      #0#0 = "S"; FSalida = 0;
   |FINSI;

   |SI FSalida = 0;
      |ABRE #dscam003; |ABRE #dscam004;
      |ABRE #dscam012; |ABRE #dscam013;
      |BUCLE Recibos;  |BUCLE LineasRem;
      |BUCLE Movtos;
      |CIERRA #dscam013; |CIERRA #dscam012;
      |CIERRA #dscam004; |CIERRA #dscam003;
      |ATRI I; |PINTA 2310, "                                  "; |ATRI N;
   |FINSI;
|FPRO;
