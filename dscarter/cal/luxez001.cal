|FICHEROS;
   luxez001 #0;

   dscam012 #1;
   dscam013 #2;
   dscam014 #3;
   dscam003 #4;
   dscam004 #5;

   dscaw013 #9,MANTE;
   dscam030 #10;
   dscam036 #11,MANTE;
   dscam051 #12;
   dscam068 #13;
   dscam067 #14;
   dscam093 #15,MANTE;
   dscam023 #16,MANTE;

   dscaw068 #100,MANTE;
   dscam066 #101;
   dscaw076 #102;

   Referen@ #1000;
   taglm01@ #1001;
|FIN;

|VARIABLES;
   &eaUsuario = ""; &enImpAnt = 0;  &enImpAct = 0;  &eaDescr = "";
   &eaTipoReg = ""; &eaNumero = ""; &eaTipoOp = ""; &eaSesion = "";
   &eaFichClas = "";  &eaTipoClas = ""; &enSwClas = 0;
   &enRemesa = 1; &eaTipoRecibo = ""; &enBiAtri = 1;
   &eaTOperacion = ""; &enNumDocum = 0;
   &enSinConfi = 0;

   nSwBloq       = 0;
   fFechaHoy     = @;
   &enFPago      = 0;
   &nCamFPago    = 0;
   &fFechaFac    = @;
   &fFecVto      = @;
   &eaCliente    = "";
   &enExistOblig = 0;

   SwDatos = 0; SwSerie = 0; nCont = 0;
   nNume = 0; fFecha = @; aAlfa = ""; aAlfa1 = ""; aAlfa2 = ""; aAlfa3 = "";
   SwImp = 0;
   nCampo = 0; nContador = 0; nCampo1 = 0;
   aEntidad = ""; aNumero = "";

   Calc1 = 0; Calc2 = 0; NumDias = 0; Linea = 0;
   nMarca = 0; nNumero = 0; aMarca = "";
   nRemesa = 0; nCalc = 0; nDiasCarencia = 0;

   EmpreAnt = 0; PerioAnt = 0;
   Mensaje = 0; LinCob = 0; NumLinea = 0;

   fFechaAnt  = @; nRemesaAnt = 0;
   nSwRiesgo = 0; nSwErr  = 0;

   aCodEnlace = "";
   UltOp = ""; Opcion = 0;
   TipoDato = ""; LongDato = 0; &HayConta = 0;

   Empresa = 0;
   Salir = 0; Cont = 0;

   nSwFVto = 0;

   nAgrupFecha = 0;

   Comodin = "";
   &enEmpCartera = 0;  &enEmpGestion = 0; &Divisa = "";
   &eaSerie      = ""; &eaCliGest    = "";
   &nImporte     = 0;  &eaTipoOper   = ""; &enBanco = 0;
   &nDeci_Div    = 0;  &nDeci_Base   = 0;

{-1}Menu  = "";
    Menu1 = "2400";
    Menu2 = "1";
    Menu3 = "";
    Menu4 = "REC";
    Menu5 = " Revisar ";
    Menu6 = " Enlazar ";
    Menu7 = " Cancelar ";

   nHandle = 0;
   aAlfaLog1 = "";
   fFechaLog = @;
   aAlfaLog2 = "";
   aLogTitulo = "";
   &aNombreLog = "";
   &enSwError = 0;
|FIN;

|PROCESO MiraHisCobro;
     enSwError = 0;
|FPRC;

|PROCESO LineasRem;
   |SI #dscam013#15 ! "S"; nSwErr = 1; |ERROR10; |FINSI;
|FPRC;

|DEFBUCLE LineasRem;
#dscam013#1;
;
#dscam012#0, 001;
#dscam012#0, 999;
;
NULL, LineasRem;
|FIN;

|PROCESO MarcaAbonada;
   #dscam012#0 = #dscaw076#0;
   |LEE 101#dscam012.=;
   |SI FSalida = 0;
      |SI #dscam012#22 = 1; |O #dscam012#22 = 3;
         nSwErr = 0; |BUCLE LineasRem;
         |SI nSwErr = 0;
            #dscam012#8 = "S"; |GRABA 020#dscam012.a;
         |FINSI;
      |FINSI;
      |LIBERA #dscam012;
   |FINSI;
|FPRC;

|DEFBUCLE MarcaAbonada;
#dscaw076#1;
;
INICIO;
FINAL;
;
NULL, MarcaAbonada;
|FIN;

|PROCESO EscogeFic;

         TipoDato = #dscaw013#11; LongDato = #dscaw013#12;
         |SI TipoDato = "A";
            |CAMPO_ANCHO #dscaw013#3,1,LongDato;
            |CAMPO_MAXIMO #dscaw013#3,1,"\ +#";
            |CAMPO_ANCHO #dscaw013#4,1,LongDato;
            |CAMPO_MAXIMO #dscaw013#4,1,"\ +#";
            |C_M #dscaw013#3,1,"S"; |C_V #dscaw013#3,1,"S"; |PINTA #dscaw013#3;
            |C_M #dscaw013#4,1,"S"; |C_V #dscaw013#4,1,"S"; |PINTA #dscaw013#4;
            |C_M #dscaw013#5,1,"N"; |C_V #dscaw013#5,1,"N";
            |C_M #dscaw013#6,1,"N"; |C_V #dscaw013#6,1,"N";
            |C_M #dscaw013#7,1,"N"; |C_V #dscaw013#7,1,"N";
            |C_M #dscaw013#8,1,"N"; |C_V #dscaw013#8,1,"N";
         |FINSI;
         |SI TipoDato = "N";
            |C_M #dscaw013#3,1,"N"; |C_V #dscaw013#3,1,"N";
            |C_M #dscaw013#4,1,"N"; |C_V #dscaw013#4,1,"N";
            |C_M #dscaw013#5,1,"S"; |C_V #dscaw013#5,1,"S"; |PINTA #dscaw013#5;
            |C_M #dscaw013#6,1,"S"; |C_V #dscaw013#6,1,"S"; |PINTA #dscaw013#6;
            |C_M #dscaw013#7,1,"N"; |C_V #dscaw013#7,1,"N";
            |C_M #dscaw013#8,1,"N"; |C_V #dscaw013#8,1,"N";
         |FINSI;
         |SI TipoDato = "F";
            |C_M #dscaw013#3,1,"N"; |C_V #dscaw013#3,1,"N";
            |C_M #dscaw013#4,1,"N"; |C_V #dscaw013#4,1,"N";
            |C_M #dscaw013#5,1,"N"; |C_V #dscaw013#5,1,"N";
            |C_M #dscaw013#6,1,"N"; |C_V #dscaw013#6,1,"N";
            |C_M #dscaw013#7,1,"S"; |C_V #dscaw013#7,1,"S"; |PINTA #dscaw013#7;
            |C_M #dscaw013#8,1,"S"; |C_V #dscaw013#8,1,"S"; |PINTA #dscaw013#8;
         |FINSI;
|FPRC;

|PROCESO TomaVal;
   |SI TipoDato = "A"; #dscaw013#9 = #dscaw013#3; #dscaw013#10 = #dscaw013#4; |FINSI;
   |SI TipoDato = "N"; #dscaw013#9 = #dscaw013#5; #dscaw013#10 = #dscaw013#6; |FINSI;
   |SI TipoDato = "F"; #dscaw013#9 = "   " + #dscaw013#7; #dscaw013#10 = "   "+ #dscaw013#8; |FINSI;

   |C_M #dscaw013#3,1,"N"; |C_V #dscaw013#3,1,"N";
   |C_M #dscaw013#4,1,"N"; |C_V #dscaw013#4,1,"N";
   |C_M #dscaw013#5,1,"N"; |C_V #dscaw013#5,1,"N";
   |C_M #dscaw013#6,1,"N"; |C_V #dscaw013#6,1,"N";
   |C_M #dscaw013#7,1,"N"; |C_V #dscaw013#7,1,"N";
   |C_M #dscaw013#8,1,"N"; |C_V #dscaw013#8,1,"N";
                           |C_V #dscaw013#9,1,"S";
                           |C_V #dscaw013#10,1,"S";
|FPRC;

|RUTINA infe1;
   #dscaw013#0 = 001;
   #dscaw013#15 = #luxez001#5;
   #dscaw013#17 = "S";
|FRUT;

|RUTINA supe1;
   #dscaw013#0 = 999;
   #dscaw013#15 = #luxez001#5;
   #dscaw013#17 = "S";
|FRUT;

|PROCESO RellenaAcot;
   |DDEFECTO #dscaw013;
   |PARA Cont = 0; |SI Cont [ 17; |HACIENDO Cont = Cont + 1;
      #dscaw013#Cont# = #dscam036#Cont#;
   |SIGUE;
   |GRABA 020#dscaw013.n;
|FPRC;

|DEFBUCLE RellenaAcot;
#dscam036#2;
;
#luxez001#5,"S",001;
#luxez001#5,"S",999;
;
NULL,RellenaAcot;
|FIN;

|PROCESO LineasRemesa;
   aLogTitulo = "Procesando linea " + #dscam013#1 + " de la remesa n§" + #dscam013#0; |HAZ ApuntaLog;
   fFecha = ~;
   nCalc = fFecha; nCalc = nCalc - #dscam014#70; fFecha = nCalc;
   aLogTitulo = "Pasando corte de indicadores de la fecha limite incluyendo dias de carencia [" + fFecha + "]"; |HAZ ApuntaLog;
   |SI #dscam013#6 > fFecha; |ACABA; |FINSI;

   |SI #luxez001#6 = "S";
      SwSerie = 0;
      |PARA nCont = 7; |SI nCont [ 18; |HACIENDO nCont = nCont + 1;
         |SI #dscam013#4 = #luxez001#nCont#; SwSerie = 1; |SAL; |FINSI;
      |SIGUE;
      |SI SwSerie = 0; |ACABA; |FINSI;
   |FINSI;

   aLogTitulo = "Actualizo campo Vencido S/N del recibo"; |HAZ ApuntaLog;
   #dscam003#40 = #dscam013#16;
   |LEE 101#dscam003.=;
   |SI FSalida ! 0;
      |ACABA;
   |SINO;
      |SI #dscam003#14 = "L";
         #dscam003#84 = "S"; |GRABA 020#dscam003.a;
      |FINSI;
      |LIBERA #dscam003;
      |SI #dscam003#14 ! "R"; |Y #dscam003#14 ! "L"; |ACABA; |FINSI;
   |FINSI;

   |SI #dscam013#15 = "S"; |O #dscam013#15 = "R"; |ACABA; |FINSI;

   aLogTitulo = "Comprobando tipos LUXE"; |HAZ ApuntaLog;
   nSwRiesgo = 1;

   |SI #dscam003#0 = "98   "; |O #dscam003#0 = "99   ";
      aLogTitulo = "Serie igual a 98 o 99"; |HAZ ApuntaLog;
      nSwRiesgo = 0;
   |FINSI;

   |SI #dscam003#12 = "03"; |O #dscam003#12 = "04";
    |O #dscam003#12 = "06"; |O #dscam003#12 = "11";
      |SI #dscam012#22 = 2; |O #dscam003#13 = "02";
         aLogTitulo = "Tipo de recibo igual a 03, 04, 06 o 11 en remesa tipo 2 o departamento = 02"; |HAZ ApuntaLog;
         nSwRiesgo = 0;
      |FINSI;
   |FINSI;
   |SI #dscam003#12 = "01"; |O #dscam003#12 = "07";
    |O #dscam003#12 = "08"; |O #dscam003#12 = "09";
      |SI #dscam003#17 ! 0;
         aLogTitulo = "Tipo de recibo igual a 01, 07, 08 o 09 en remesa.[" + #dscam003#17 + "/" + #dscam003#40 + "]"; |HAZ ApuntaLog;
         nSwRiesgo = 0;
      |FINSI;
   |FINSI;

   |SI #dscam012#22 = 3;
      aLogTitulo = "Remesa de pagares al cobro"; |HAZ ApuntaLog;
      nSwRiesgo = 0;
   |FINSI;

   |SI #dscam012#22 = 5;
      aLogTitulo = "Remesa de confirming"; |HAZ ApuntaLog;
      nSwRiesgo = 0;
   |FINSI;

   |SI #dscam012#22 = 6; |O #dscam012#22 = 7;
      aLogTitulo = "Remesa de factoring"; |HAZ ApuntaLog;
      nSwRiesgo = 0;
   |FINSI;

   |SI nSwRiesgo = 1;
      #dscam013#20 = "*"; |GRABA 020#dscam013.a;

      aLogTitulo = "Comprobacion superada"; |HAZ ApuntaLog;

      #dscam004#17 = #dscam013#16;
      #dscam004#3 = #dscam013#17;
      |LEE 000#dscam004.=;
      |SI FSalida = 0; |Y #dscam004#5 = "REM";
         |LEE 000#dscam004.s;
         |SI FSalida = 0; |Y #dscam004#17 = #dscam013#16; |Y #dscam004#5 = "IMP";
            SwImp = 1;
         |SINO;
            SwImp = 0;
         |FINSI;
      |FINSI;
      |SI SwImp = 0;
         enBanco = #dscam012#2;
         enEmpCartera = -1;      enEmpGestion = #dscam003#46;
         eaSerie = #dscam003#0;  eaCliGest = #dscam003#32;
         nImporte = #dscam013#7;
         |SI #dscam012#22 = "1"; |O #dscam012#22 = "3";
            eaTipoOper = "-4";
         |SINO;
            eaTipoOper = "-6";
         |FINSI;
         |HAZ BucleRiesgo;
      |FINSI;

      |SI #dscam012#22 = 1; |O #dscam012#22 = 3;
         #dscam003#40 = #dscam013#16;
         |LEE 000#dscam003.=;
         |SI FSalida = 0;
            #dscam004#17 = #dscam003#40;
            #dscam004#3 = 1;
            |LEE 000#dscam004.];
            |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
               LinCob = #dscam004#3 + 1;
               |LEE 000#dscam004.s;
            |SIGUE;
         |SINO;
            LinCob = 1;
         |FINSI;

         |DDEFECTO #dscam004;
         #dscam004#17 = #dscam003#40;
         #dscam004#15 = #dscam013#2;
         #dscam004#0  = #dscam013#4;
         #dscam004#1  = #dscam013#3;
         #dscam004#2  = #dscam013#5;
         #dscam004#3  = LinCob;
         #dscam004#4  = #dscam012#14;
         #dscam004#5  = "REM";
         #dscam004#6  = #dscam012#1;
         #dscam004#7  = #dscam003#23; #dscam004#25  = #dscam003#61;
         #dscam004#8  = #dscam013#22; #dscam004#26  = #dscam013#7;
         #dscam004#9  = 0;
         #dscam004#10 = 0;
         #dscam004#33 = #dscam003#59;
         |GRABA 020#dscam004.n;

         #dscam013#17 = LinCob; |GRABA 020#dscam013.a;
         || Actualizo el recibo
         #dscam003#40 = #dscam013#16;
         |LEE 101#dscam003.=;
         |SI FSalida = 0;
            #dscam066#0 = #dscam003#40;
            |LEE 000#dscam066.=;
            |SI FSalida = 0; |BORRA 020#dscam066.a; |FINSI;
            #dscam003#26 = #dscam012#1;
            #dscam003#23 = #dscam003#23 + #dscam013#7; #dscam003#61 = #dscam003#61 + #dscam013#7;
            #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
            #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
            #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
            #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);
            aAlfa = #dscam003#31; |QBF aAlfa; nCalc = aAlfa;
            #dscam003#31 = #dscam003#30 - #dscam003#23;
            #dscam003#65 = #dscam003#64 - #dscam003#61;
            |SI #dscam003#47 = "S"; |O #dscam003#69 ! " ";
               |SI #dscam003#31 = 0;
                  #dscam003#14 = "e"; #dscam003#15 = "Pendiente de compensar";
               |FINSI;
            |SINO;
               |SI #dscam003#31 = 0;
                  #dscam003#14 = "L"; #dscam003#15 = "Recibo liquidado";
               |SINO;
                  #dscam003#14 = "C"; #dscam003#15 = "Parcialmente cobrado";
               |FINSI;
            |FINSI;
            #dscam003#84 = "S";
            |GRABA 020#dscam003.a; |LIBERA #dscam003;
         |FINSI;
         eaCliente = #dscam003#32; |HAZ MiraBloqueoRiesgo;
      |FINSI;

      eaUsuario = Usuario % 0810;
      eaDescr   = "VENCIMIENTO LINEA REMESA (" + (("00000" + #dscam012#0) % -105) + "/" + (("000" + #dscam013#1) % -103) + ") CON RECIBO ";
      eaDescr   = eaDescr + #dscam003#0 + "/" + #dscam003#1 + "/" + #dscam003#2;
      eaTipoReg = "RE";  eaNumero = ("00000" + #dscam012#0) % -105;
      eaTipoOp  = "V";   enImpAct = #dscam012#10; enImpAnt = #dscam012#10;
      |HAZ GrabaAudit;
   |FINSI;
|FPRC;

|DEFBUCLE LineasRemesa;
#dscam013#1;
;
#dscaw076#0,001;
#dscaw076#0,999;
be;
NULL,LineasRemesa;
|FIN;

|PROCESO MarcaLineas;
   |SI #dscam013#20 = "*";
      #dscam013#20 = " "; #dscam013#15 = "S";
      |GRABA 020#dscam013.a;
   |FINSI;
|FPRC;

|DEFBUCLE MarcaLineas;
#dscam013#1;
;
#dscaw076#0,001;
#dscaw076#0,999;
be;
NULL,MarcaLineas;
|FIN;

|PROCESO MiraSeries;
   |PARA nCampo1 = 7; |SI nCampo1 [ 18; |HACIENDO nCampo1 = nCampo1 + 1;
      nContador = 0; aAlfa1 = #luxez001#nCampo1#;
      |PARA nCampo = 7; |SI nCampo [ 18; |HACIENDO nCampo = nCampo + 1;
         aAlfa  = #luxez001#nCampo#;
         |SI aAlfa = aAlfa1; nContador = nContador + 1; |FINSI;
      |SIGUE;
      |SI nContador > 1; |Y aAlfa1 ! "zzzzz"; |ERROR; |SAL; |FINSI;
   |SIGUE;
|FPRC;

|PROCESO BajaRemesa;

   #dscam012#0 = #dscaw076#0;
   |LEE 000#dscam012.=;
   |SI FSalida ! 0; |ACABA; |FINSI;
   |SI #dscam012#1 < #luxez001#2; |O #dscam012#1 > #luxez001#3; |ACABA; |FINSI;
   |SI #dscam012#22 = 6; |O #dscam012#22 = 7; |ACABA; |FINSI;

   aLogTitulo = "Tratando remesa n§ " + #dscam012#0; |HAZ ApuntaLog;
   aLogTitulo = "Pasando corte de fecha de remesa y tipos de factoring."; |HAZ ApuntaLog;

   #dscam014#0 = #dscam012#2;
   |LEE 000#dscam014.=;
   |SI FSalida ! 0; |DDEFECTO #dscam014; |FINSI;

   aLogTitulo = "Pasando corte de indicadores de emision y abono."; |HAZ ApuntaLog;
   |SI #dscam012#22 = 2; |O #dscam012#22 = 4; |O #dscam012#22 = 5;
      |SI #dscam012#8 = "N";
         aLogTitulo = "Remesa de tipo 2, 4 o 5 no abonada. Terminando con la remesa."; |HAZ ApuntaLog;
         |ACABA;
      |FINSI;
   |SINO;
      |SI #dscam012#23 = "N";
         aLogTitulo = "Remesa de tipo 1, 3, 6 o 7 no emitida. Terminando con la remesa."; |HAZ ApuntaLog;
         |ACABA;
      |FINSI;
   |FINSI;

   |BUCLE LineasRemesa;

   Divisa = "EUR"; |HAZ TomaDecim;

   |SI HayConta = 1; |Y #dscam051#1 = "S";
      aLogTitulo = "Hay contabilidad. Preparando enlace contable."; |HAZ ApuntaLog;
      |ABRE #dscam067;
      #dscam067#0 = "RM";
      #dscam067#1 = #dscam012#0;
      #dscam067#2 = 1;
      #dscam067#3 = "E";
      |LEE 000#dscam067.];
      nNume = #dscam067#1;
      |SI FSalida = 0; |Y #dscam067#0 = "RM"; |Y nNume = #dscam012#0;
       |Y #dscam067#3 = "E";
         #dscam030#0 = #luxez001#5;
         |LEE 000#dscam030.=;
         |SI FSalida = 0;
            EmpreAnt = #dscam030#4; PerioAnt = #dscam030#5;
            #dscam030#4 = #dscam067#8; #dscam030#5 = #dscam067#9;
            |GRABA 020#dscam030.a;
         |FINSI;
         aLogTitulo = "Encontrado apunte en el historico de enlaces. Usando empresa contable del apunte."; |HAZ ApuntaLog;
      |SINO;
         #dscam030#0 = #luxez001#5;
         |LEE 000#dscam030.=; EmpreAnt = -1;
         aLogTitulo = "No encontrado el historico de enlaces. Usando codigo de enlace indicado [" + #luxez001#5 + "]"; |HAZ ApuntaLog;
      |FINSI;
      |CIERRA #dscam067;

      Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
      |NOME_DAT #9 Comodin;
      |DELINDEX #dscaw013; |ABRE #dscaw013;
      Comodin = #luxez001#5;
      |SI Comodin = "    "; |Y #dscam051#1 = "S";
         |ABRE #dscam093;
         #dscam093#0 = "V";
         |LEE 000#dscam093.=;
         |SI FSalida = 0;
            |SI #dscam012#22 = 1; Comodin = #dscam093#1; |FINSI;
            |SI #dscam012#22 = 2; Comodin = #dscam093#3; |FINSI;
            |SI #dscam012#22 = 3; Comodin = #dscam093#5; |FINSI;
            |SI #dscam012#22 = 4; Comodin = #dscam093#7; |FINSI;
            |SI #dscam012#22 = 5; Comodin = #dscam093#9; |FINSI;
         |FINSI;
         |CIERRA #dscam093;
      |FINSI;

      aLogTitulo = "Acotacion enlace. Codigo remesa : " + #dscam012#0; |HAZ ApuntaLog;
      |DDEFECTO #dscaw013;
      #dscaw013#0  = 1;            #dscaw013#5  = #dscam012#0;
      #dscaw013#6  = #dscam012#0;  #dscaw013#11 = "N";
      #dscaw013#12 = 5;            #dscaw013#13 = "dscam013";
      #dscaw013#14 = 0;            #dscaw013#15 = Comodin;
      |GRABA 020#dscaw013.n;

      aLogTitulo = "Acotacion enlace. fecha vto. limite : " + #luxez001#4; |HAZ ApuntaLog;
      |DDEFECTO #dscaw013;
      #dscaw013#0  = 2;            #dscaw013#7  = "01.01.1900";
      #dscaw013#8  = #luxez001#4;  #dscaw013#11 = "F";
      #dscaw013#12 = 10;           #dscaw013#13 = "dscam013";
      #dscaw013#14 = 6;            #dscaw013#15 = Comodin;
      |GRABA 020#dscaw013.n;

      aLogTitulo = "Acotacion enlace. Marca vencido S/N : 'N'"; |HAZ ApuntaLog;
      |DDEFECTO #dscaw013;
      #dscaw013#0  = 3;            #dscaw013#3  = "N";
      #dscaw013#4  = "N";          #dscaw013#11 = "A";
      #dscaw013#12 = 1;            #dscaw013#13 = "dscam013";
      #dscaw013#14 = 15;           #dscaw013#15 = Comodin;
      |GRABA 020#dscaw013.n; NumLinea = NumLinea + 1;

      aLogTitulo = "Acotacion enlace. Marca pasar recibo S/N : 'N'"; |HAZ ApuntaLog;
      |DDEFECTO #dscaw013;
      #dscaw013#0  = 4;            #dscaw013#3  = "*";
      #dscaw013#4  = "*";          #dscaw013#11 = "A";
      #dscaw013#12 = 1;            #dscaw013#13 = "dscam013";
      #dscaw013#14 = 20;           #dscaw013#15 = Comodin;
      |GRABA 020#dscaw013.n; NumLinea = NumLinea + 1;

      |SI #luxez001#6 = "S";
         |PARA nCont = 7; |SI nCont [ 18; |HACIENDO nCont = nCont + 1;
            |SI #luxez001#nCont# ! "zzzzz";
               |DDEFECTO #dscaw013;
               #dscaw013#0  = nCont - 3;    #dscaw013#3  = "";
               #dscaw013#3 = #luxez001#nCont#; #dscaw013#4 = #luxez001#nCont#;
               #dscaw013#11 = "A";
               #dscaw013#12 = 5;            #dscaw013#13 = "dscam013";
               #dscaw013#14 = 4;            #dscaw013#15 = Comodin;
               #dscaw013#18 = "C";
               |GRABA 020#dscaw013.c;
            |FINSI;
         |SIGUE;
      |FINSI;
      |CIERRA #dscaw013;

      Comodin = #luxez001#5;
      |SI Comodin = "    "; |Y #dscam051#1 = "S";
         aLogTitulo = "Usando codigo de enlace por tipo de remesa."; |HAZ ApuntaLog;
         |ABRE #dscam093;
         #dscam093#0 = "V";
         |LEE 000#dscam093.=;
         |SI FSalida = 0;
            |SI #dscam012#22 = 1; Comodin = #dscam093#1; |FINSI;
            |SI #dscam012#22 = 2; Comodin = #dscam093#3; |FINSI;
            |SI #dscam012#22 = 3; Comodin = #dscam093#5; |FINSI;
            |SI #dscam012#22 = 4; Comodin = #dscam093#7; |FINSI;
            |SI #dscam012#22 = 5; Comodin = #dscam093#9; |FINSI;
         |FINSI;
         |CIERRA #dscam093;
      |FINSI;
      |SI #luxez001#20 ! "01.01.0000";
         Comodin = "dscam033.tab;" + Comodin + ",V" + #luxez001#20;
      |SINO;
         Comodin = "dscam033.tab;" + Comodin + ",V" + #luxez001#4;
      |FINSI;
      |SI PARAMETRO ! "";
         Comodin = Comodin + "|" + aAlfa;
         |PUSHV 1227 1453;
         |BLANCO 1227 1453;
         |CUADRO 1227 1453;
         aAlfa1 = " Procesando remesa " + (("00000" + #dscam012#0) % -105) + " ";
         |ATRI R; |PINTA 1328, aAlfa1; |ATRI N;
      |FINSI;

      aLogTitulo = "Llamando al proceso de preparacion de enlaces."; |HAZ ApuntaLog;
      |XCIERRA nHandle;

      |LIBERA #dscam012; |CIERRAT #dscam012;
      |SUB_EJECUTA_NP Comodin;
      |ABRET #dscam012; |LEE 101#dscam012.=;

      |XABRE "A", aNombreLog, nHandle;
      aLogTitulo = "Volviendo del proceso de preparacion de enlaces."; |HAZ ApuntaLog;

      aAlfa1 = aAlfa; |QBF aAlfa1; aAlfa1 = aAlfa1 + "ac" + Usuario + ".dat"; |FBORRA aAlfa1;
      aAlfa1 = aAlfa; |QBF aAlfa1; aAlfa1 = aAlfa1 + "ac" + Usuario + ".ddx"; |FBORRA aAlfa1;
      aAlfa1 = aAlfa; |QBF aAlfa1; aAlfa1 = aAlfa1 + "ac" + Usuario + ".ixx"; |FBORRA aAlfa1;

      |SI PARAMETRO ! "";
         |POPV;
      |FINSI;
      |SI EmpreAnt ! -1;
         #dscam030#4 = EmpreAnt; #dscam030#5 = PerioAnt;
         |GRABA 020#dscam030.a;
      |FINSI;
   |SINO;
      aLogTitulo = "No hay contabilidad. No se hace el enlace contable."; |HAZ ApuntaLog;
   |FINSI;
   |BUCLE MarcaLineas;
|FPRC;

|DEFBUCLE BajaRemesa;
#dscaw076#1;
;
INICIO;
FINAL;
be;
NULL,BajaRemesa;
|FIN;

|PROCESO BorraMarcas;
   #dscam013#20 = " "; |GRABA 020#dscam013.a;
|FPRC;

|DEFBUCLE BorraMarcas;
#dscam013#1;
;
#luxez001#0,001;
#luxez001#1,999;
be;
NULL,BorraMarcas;
|FIN;

|PROCESO RellenaTempo;
   |SI aEntidad ! "    "; |O aNumero ! "          ";
      |SI aEntidad = #dscam003#72; |Y aNumero = #dscam003#70; |ACABA; |FINSI;
      |SI #dscam003#71 > #luxez001#4; |ACABA; |FINSI;
   |FINSI;

   |SI #dscam003#72 = "    "; |Y #dscam003#70 = "          ";
      |SI #dscam003#3 > #luxez001#4; |ACABA; |FINSI;
   |FINSI;

   aEntidad = #dscam003#72; aNumero = #dscam003#70;

   #dscam012#0 = #dscam003#17;
   |LEE 000#dscam012.=;
   |SI FSalida ! 0; |ACABA; |FINSI;
   |SI #dscam012#22 = 6; |O #dscam012#22 = 7; |ACABA; |FINSI;
   |SI #luxez001#2 > #dscam012#1; |O #dscam012#1 > #luxez001#3; |ACABA; |FINSI;
   |SI #dscam012#22 = 2; |O #dscam012#22 = 4; |O #dscam012#22 = 5;
      |SI #dscam012#8 = "N"; |ACABA; |FINSI;
   |SINO;
      |SI #dscam012#23 = "N"; |ACABA; |FINSI;
   |FINSI;

   |SI #luxez001#21 = "C";
      |SI #dscam012#22 ! 1; |Y #dscam012#22 ! 3; |ACABA; |FINSI;
   |FINSI;
   |SI #luxez001#21 = "D";
      |SI #dscam012#22 ! 2; |Y #dscam012#22 < 4; |ACABA; |FINSI;
   |FINSI;

   #dscam013#0 = #dscam003#17;
   #dscam013#1 = #dscam003#37;
   |LEE 000#dscam013.=;
   |SI FSalida ! 0; |ACABA; |FINSI;
   |SI #dscam013#15 = "S"; |ACABA; |FINSI;

   |SI #dscam013#6 > #luxez001#4; |ACABA; |FINSI;

   |SI #dscam012#0 ! nNumero;
      |SI nMarca = 1;
         nMarca = 2;
      |SINO;
         nMarca = 1;
      |FINSI;
      nNumero = #dscam012#0;
   |FINSI;

   |SI #dscam012#22 = 5;
      |SI #dscam003#97 = "N"; |ACABA; |FINSI;
   |SINO;
      |SI #dscam003#97 = "S"; |ACABA; |FINSI;
   |FINSI;
   |SI #dscam003#90 = "N"; |ACABA; |FINSI;

   enSwClas   = 1; eaFichClas = "dscam012"; eaTipoClas = #dscam003#12;
   |HAZ CompruebaClas;
   |SI eaFichClas = "ERROR"; |ACABA; |FINSI;

   #dscam014#0 = #dscam012#2;
   |LEE 000#dscam014.=;
   |SI FSalida = 0;
      |SI #dscam014#40 = "N";
         |SI #dscam014#0 ! #dscam003#51; |Y #dscam051#7 = "S"; |ACABA; |FINSI;
      |FINSI;
   |FINSI;

   |SI #dscam051#2 = "N";
      Calc1 = #dscam012#1;
      Calc2 = #dscam003#3;
      NumDias = Calc2 - Calc1;
      |SI NumDias < 0; |ACABA; |FINSI;
   |FINSI;

   eaTOperacion = "A"; enNumDocum = #dscam003#40; |HAZ ProcesaTempo;

   Divisa = #dscam003#57; |HAZ TomaDecim;

   |DDEFECTO #dscaw068;
   #dscaw068#0 = #dscam003#17;
   #dscaw068#1 = #dscam003#37;
   #dscaw068#2 = #dscam003#3;
   |SI #dscam003#72 ! "    "; |O #dscam003#70 ! "          ";
      #dscaw068#3 = #dscam003#78;
   |SINO;
      #dscaw068#3 = #dscam013#7;
   |FINSI;
   #dscaw068#4 = aMarca;
   #dscaw068#5 = #dscam003#40;
   #dscaw068#6 = #dscam003#72;
   #dscaw068#7 = #dscam003#70;
   #dscaw068#8 = nMarca;
   #dscaw068#9 = #dscam003#57;
   |GRABA 010#dscaw068.n;
|FPRC;

|DEFBUCLE RellenaTempo;
#dscam003#14;
;
#luxez001#0,"    ", "          ",0000000001;
#luxez001#1,"zzzz", "zzzzzzzzzz",9999999999;
;
NULL,RellenaTempo;
|FIN;

|PROCESO PasaRecibo;
   #dscam012#0 = nRemesa;
   |LEE 000#dscam012.=;
   |SI #dscam012#22 = 1; |O #dscam012#22 = 3;
      #dscam003#40 = #dscaw068#5;
      |LEE 000#dscam003.=;
      |SI FSalida = 0;
         #dscam004#17 = #dscam003#40;
         #dscam004#3 = 1;
         |LEE 000#dscam004.];
         |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
            LinCob = #dscam004#3 + 1;
            |LEE 000#dscam004.s;
         |SIGUE;
      |SINO;
         LinCob = 1;
      |FINSI;

      |DDEFECTO #dscam004;
      #dscam004#17 = #dscam003#40;
      #dscam004#15 = #dscam013#2;
      #dscam004#0  = #dscam013#4;
      #dscam004#1  = #dscam013#3;
      #dscam004#2  = #dscam013#5;
      #dscam004#3  = LinCob;
      #dscam004#4  = #dscam012#14;
      #dscam004#5  = "REM";
      #dscam004#6  = #dscam012#1;
      #dscam004#7  = #dscam003#23; #dscam004#25  = #dscam003#61;
      #dscam004#8  = #dscam013#22; #dscam004#26  = #dscam013#7;
      #dscam004#9  = 0;
      #dscam004#10 = 0;
      #dscam004#33 = #dscam003#59;
      |GRABA 020#dscam004.n;
      #dscam013#17 = LinCob; |GRABA 020#dscam013.a;
      || Actualizo el riesgo de cliente
      |SI #dscam051#3 = "S";
         enBanco = #dscam012#2;
         enEmpCartera = -1;     enEmpGestion = #dscam003#46;
         eaSerie = #dscam003#0; eaCliGest = #dscam003#32;
         nImporte = #dscam013#7;
         |SI #dscam003#16 > 0;
            eaTipoOper = "-7";
         |SINO;
            eaTipoOper = "-4";
         |FINSI;
         |HAZ BucleRiesgo;
      |FINSI;
      || Actualizo el recibo
      #dscam003#40 = #dscam013#16;
      |LEE 101#dscam003.=;
      |SI FSalida = 0;
         #dscam066#0 = #dscam003#40;
         |LEE 000#dscam066.=;
         |SI FSalida = 0; |BORRA 020#dscam066.a; |FINSI;
         #dscam003#26 = #dscam012#1;
         #dscam003#23 = #dscam003#23 + #dscam013#7; #dscam003#61 = #dscam003#61 + #dscam013#7;
         #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
         #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
         #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
         #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);
         aAlfa = #dscam003#31; |QBF aAlfa; nCalc = aAlfa;
         #dscam003#31 = #dscam003#30 - #dscam003#23;
         #dscam003#65 = #dscam003#64 - #dscam003#61;
         |SI #dscam003#47 = "S"; |O #dscam003#69 ! " ";
            |SI #dscam003#31 = 0;
               #dscam003#14 = "e"; #dscam003#15 = "Pendiente de compensar";
            |FINSI;
         |SINO;
            |SI #dscam003#31 = 0;
               #dscam003#14 = "L"; #dscam003#15 = "Recibo liquidado";
            |SINO;
               #dscam003#14 = "C"; #dscam003#15 = "Parcialmente cobrado";
            |FINSI;
         |FINSI;
         #dscam003#84 = "S";
         |GRABA 020#dscam003.a; |LIBERA #dscam003;
      |FINSI;
      eaCliente = #dscam003#32; |HAZ MiraBloqueoRiesgo;
   |SINO;
      || Actualizo el recibo
      #dscam003#40 = #dscam013#16;
      |LEE 101#dscam003.=;
      |SI FSalida = 0;
         #dscam003#84 = "S";
         |GRABA 020#dscam003.a; |LIBERA #dscam003;
      |FINSI;

      || Actualizo el recibo en caso de usar la fecha vto. como fecha contable
      |SI #dscam051#3 = "S"; |Y nSwFVto = 1;
         #dscam004#17 = #dscam013#16;
         #dscam004#3 = #dscam013#17;
         |LEE 000#dscam004.=;
         |SI FSalida = 0; |Y #dscam004#5 = "REM";
            |LEE 000#dscam004.s;
            |SI FSalida = 0; |Y #dscam004#17 = #dscam013#16; |Y #dscam004#5 = "IMP";
               SwImp = 1;
            |SINO;
               SwImp = 0;
            |FINSI;
         |FINSI;
         |SI SwImp = 0;
            #dscam003#40 = #dscam013#16;
            |LEE 000#dscam003.=;
            |SI FSalida ! 0; |DDEFECTO #dscam003; |FINSI;
            enBanco = #dscam012#2;
            enEmpCartera = -1;      enEmpGestion = #dscam003#46;
            eaSerie = #dscam003#0;  eaCliGest = #dscam003#32;
            nImporte = #dscam013#7;
            |SI #dscam012#22 = "1"; |O #dscam012#22 = "3";
               eaTipoOper = "-4";
            |SINO;
               eaTipoOper = "-6";
            |FINSI;
            |HAZ BucleRiesgo;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO Pagare;
   #dscam013#0 = #dscam003#17;
   #dscam013#1 = #dscam003#37;
   |LEE 000#dscam013.=;
   |SI FSalida = 0;
       #dscam013#20 = "*"; #dscam013#15 = "S";
       |GRABA 020#dscam013.a;
   |FINSI;

   |SALVA_FICHA #dscam003;
   nRemesa = #dscam003#17; #dscaw068#5 = #dscam003#40; |HAZ PasaRecibo;
   |REPON_FICHA #dscam003;

   #dscaw076#0 = #dscam003#17;
   |LEE 000#dscaw076.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscaw076;
      #dscaw076#0 = #dscam003#17;
      |GRABA 020#dscaw076.n;
   |FINSI;
|FPRC;

|DEFBUCLE Pagare;
#dscam003#7;
;
#dscaw068#6, #dscaw068#7, 000000001;
#dscaw068#6, #dscaw068#7, 999999999;
;
NULL,Pagare;
|FIN;

|PROCESO VuelcaRecibos;
   eaTOperacion = "B"; enNumDocum = #dscaw068#5; |HAZ ProcesaTempo;

   |SI nSwFVto = 1; |Y nAgrupFecha = 1;
      |SI fFechaAnt ! #dscaw068#2; |O nRemesaAnt ! #dscaw068#0;
         |SI fFechaAnt ! "01.01.0000";
            Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
            |NOME_DAT #9 Comodin;
            |DELINDEX #dscaw013; |ABRE #dscaw013;

            |DDEFECTO #dscaw013;
            #dscaw013#0  = 1;            #dscaw013#5  = #dscaw068#0;
            #dscaw013#6  = #dscaw068#0;  #dscaw013#11 = "N";
            #dscaw013#12 = 5;            #dscaw013#13 = "dscam013";
            #dscaw013#14 = 0;            #dscaw013#15 = #luxez001#5;
            |GRABA 020#dscaw013.n;
            |DDEFECTO #dscaw013;
            #dscaw013#0  = 2;            #dscaw013#3  = "*";
            #dscaw013#4  = "*";          #dscaw013#11 = "A";
            #dscaw013#12 = 1;            #dscaw013#13 = "dscam013";
            #dscaw013#14 = 20;           #dscaw013#15 = #luxez001#5;
            |GRABA 020#dscaw013.n; NumLinea = NumLinea + 1;
            |CIERRA #dscaw013;

            Comodin = "dscam033.tab;" + #luxez001#5 + ",V" + fFechaAnt;
            |LIBERA #dscam012; |CIERRAT #dscam012;
            |SUB_EJECUTA_NP Comodin;
            |ABRET #dscam012; |LEE 101#dscam012.=;
            |DELINDEX #dscaw013;

            |BUCLE BorraMarcas;
         |FINSI;
         fFechaAnt = #dscaw068#2; nRemesaAnt = #dscaw068#0;
      |FINSI;
   |FINSI;

   |SI #dscaw068#6 ! "    "; |O #dscaw068#7 ! "          ";
      |BUCLE Pagare;
   |SINO;
      #dscaw076#0 = #dscaw068#0;
      |LEE 000#dscaw076.=;
      |SI FSalida ! 0;
         |DDEFECTO #dscaw076;
         #dscaw076#0 = #dscaw068#0;
         |GRABA 020#dscaw076.n;
      |FINSI;

      #dscam013#0 = #dscaw068#0;
      #dscam013#1 = #dscaw068#1;
      |LEE 000#dscam013.=;
      |SI FSalida = 0;
          #dscam013#20 = "*"; #dscam013#15 = "S";
          |GRABA 020#dscam013.a;
      |FINSI;

      nRemesa = #dscaw068#0; |HAZ PasaRecibo;
   |FINSI;

   |SI nSwFVto = 1; |Y nAgrupFecha = 0;
      aCodEnlace = #luxez001#5;
      |SI aCodEnlace = "    "; |Y #dscam051#1 = "S";
         |ABRE #dscam093;
         #dscam093#0 = "V";
         |LEE 000#dscam093.=;
         |SI FSalida = 0;
            |SI #dscam012#22 = 1; aCodEnlace = #dscam093#1; |FINSI;
            |SI #dscam012#22 = 2; aCodEnlace = #dscam093#3; |FINSI;
            |SI #dscam012#22 = 3; aCodEnlace = #dscam093#5; |FINSI;
            |SI #dscam012#22 = 4; aCodEnlace = #dscam093#7; |FINSI;
            |SI #dscam012#22 = 5; aCodEnlace = #dscam093#9; |FINSI;
         |FINSI;
         |CIERRA #dscam093;
      |FINSI;

      Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
      |NOME_DAT #9 Comodin;
      |DELINDEX #dscaw013; |ABRE #dscaw013;

      |DDEFECTO #dscaw013;
      #dscaw013#0  = 1;            #dscaw013#5  = #dscaw068#0;
      #dscaw013#6  = #dscaw068#0;  #dscaw013#11 = "N";
      #dscaw013#12 = 5;            #dscaw013#13 = "dscam013";
      #dscaw013#14 = 0;            #dscaw013#15 = aCodEnlace;
      |GRABA 020#dscaw013.n;
      |DDEFECTO #dscaw013;
      #dscaw013#0  = 2;            #dscaw013#5  = #dscaw068#5;
      #dscaw013#6  = #dscaw068#5;  #dscaw013#11 = "N";
      #dscaw013#12 = 9;            #dscaw013#13 = "dscam013";
      #dscaw013#14 = 16;           #dscaw013#15 = aCodEnlace;
      |GRABA 020#dscaw013.n; NumLinea = NumLinea + 1;
      |CIERRA #dscaw013;

      Comodin = "dscam033.tab;" + aCodEnlace + ",V" + #dscaw068#2;
      |LIBERA #dscam012; |CIERRAT #dscam012;
      |SUB_EJECUTA_NP Comodin;
      |ABRET #dscam012; |LEE 101#dscam012.=;
      |DELINDEX #dscaw013;
   |FINSI;
|FPRC;

|DEFBUCLE VuelcaRecibos;
#dscaw068#2;
;
00001,"*","01.01.0000",001;
99999,"*","31,12,9999",999;
;
NULL,VuelcaRecibos;
|FIN;

|PROCESO Riesgos;
      |SI #dscam051#3 = "S"; |Y #dscam013#20 = "*";
         #dscam004#17 = #dscam013#16;
         #dscam004#3 = #dscam013#17;
         |LEE 000#dscam004.=;
         |SI FSalida = 0; |Y #dscam004#5 = "REM";
            |LEE 000#dscam004.s;
            |SI FSalida = 0; |Y #dscam004#17 = #dscam013#16; |Y #dscam004#5 = "IMP";
               SwImp = 1;
            |SINO;
               SwImp = 0;
            |FINSI;
         |FINSI;
         |SI SwImp = 0;
            #dscam003#40 = #dscam013#16;
            |LEE 000#dscam003.=;
            |SI FSalida ! 0; |DDEFECTO #dscam003; |FINSI;
            enBanco = #dscam012#2;
            enEmpCartera = -1;      enEmpGestion = #dscam003#46;
            eaSerie = #dscam003#0;  eaCliGest = #dscam003#32;
            nImporte = #dscam013#7;
            |SI #dscam012#22 = "1"; |O #dscam012#22 = "3";
               eaTipoOper = "-4";
            |SINO;
               eaTipoOper = "-6";
            |FINSI;
            |HAZ BucleRiesgo;
         |FINSI;
      |FINSI;
|FPRC;

|DEFBUCLE Riesgos;
#dscam013#1;
;
#dscaw076#0, 001;
#dscaw076#0, 999;
;
NULL, Riesgos;
|FIN;

|PROCESO HazAsiento;
      #dscam012#0 = #dscaw076#0;
      |LEE 101#dscam012.=;
      |SI FSalida ! 0; |ACABA; |FINSI;

      Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
      |NOME_DAT #9 Comodin;
      |DELINDEX #dscaw013; |ABRE #dscaw013;

      Comodin = #luxez001#5;
      |SI Comodin = "    "; |Y #dscam051#1 = "S";
         |ABRE #dscam093;
         #dscam093#0 = "V";
         |LEE 000#dscam093.=;
         |SI FSalida = 0;
            |SI #dscam012#22 = 1; Comodin = #dscam093#1; |FINSI;
            |SI #dscam012#22 = 2; Comodin = #dscam093#3; |FINSI;
            |SI #dscam012#22 = 3; Comodin = #dscam093#5; |FINSI;
            |SI #dscam012#22 = 4; Comodin = #dscam093#7; |FINSI;
            |SI #dscam012#22 = 5; Comodin = #dscam093#9; |FINSI;
         |FINSI;
         |CIERRA #dscam093;
      |FINSI;

      |DDEFECTO #dscaw013;
      #dscaw013#0  = 1;            #dscaw013#5  = #dscam012#0;
      #dscaw013#6  = #dscam012#0;  #dscaw013#11 = "N";
      #dscaw013#12 = 5;            #dscaw013#13 = "dscam013";
      #dscaw013#14 = 0;            #dscaw013#15 = Comodin;
      |GRABA 020#dscaw013.n;
      |DDEFECTO #dscaw013;
      #dscaw013#0  = 2;            #dscaw013#3  = "*";
      #dscaw013#4  = "*";          #dscaw013#11 = "A";
      #dscaw013#12 = 1;            #dscaw013#13 = "dscam013";
      #dscaw013#14 = 20;           #dscaw013#15 = Comodin;
      |GRABA 020#dscaw013.n; NumLinea = NumLinea + 1;
      |CIERRA #dscaw013;

      |SI #luxez001#20 ! "01.01.0000";
         Comodin = "dscam033.tab;" + Comodin + ",V" + #luxez001#20;
      |SINO;
         Comodin = "dscam033.tab;" + Comodin + ",V" + #luxez001#4;
      |FINSI;
      |LIBERA #dscam012; |CIERRAT #dscam012;
      |SUB_EJECUTA_NP Comodin;
      |ABRET #dscam012; |LEE 101#dscam012.=;

      |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".dat"; |FBORRA aAlfa;
      |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ddx"; |FBORRA aAlfa;
      |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ixx"; |FBORRA aAlfa;

      #dscam012#8 = "S"; #dscam012#9 = "S";
      |GRABA 020#dscam012.a; |LIBERA #dscam012;

      |SI #dscam012#22 = 2; |O #dscam012#22 = 4; |BUCLE Riesgos; |FINSI;
|FPRC;

|DEFBUCLE EnlazaRemesas;
#dscaw076#1;
;
#luxez001#0;
#luxez001#1;
be;
NULL,HazAsiento;
|FIN;

|PROCESO VuelcaDatos;
   fFechaAnt = "01.01.0000";
   |DELINDEX #dscaw076; |ABRE #dscaw076;
   |BUCLE BorraMarcas;
   |BUCLE VuelcaRecibos;
   |SI nSwFVto = 0;
      |BUCLE EnlazaRemesas;
   |SINO;
      |SI fFechaAnt ! "01.01.0000"; |Y nAgrupFecha = 1;
         Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
         |NOME_DAT #9 Comodin;
         |DELINDEX #dscaw013; |ABRE #dscaw013;
         |DDEFECTO #dscaw013;
         #dscaw013#0  = 1;            #dscaw013#5  = #dscaw068#0;
         #dscaw013#6  = #dscaw068#0;  #dscaw013#11 = "N";
         #dscaw013#12 = 5;            #dscaw013#13 = "dscam013";
         #dscaw013#14 = 0;            #dscaw013#15 = #luxez001#5;
         |GRABA 020#dscaw013.n;
         |DDEFECTO #dscaw013;
         #dscaw013#0  = 2;            #dscaw013#3  = "*";
         #dscaw013#4  = "*";          #dscaw013#11 = "A";
         #dscaw013#12 = 1;            #dscaw013#13 = "dscam013";
         #dscaw013#14 = 20;           #dscaw013#15 = #luxez001#5;
         |GRABA 020#dscaw013.n; NumLinea = NumLinea + 1;
         |CIERRA #dscaw013;
         Comodin = "dscam033.tab;" + #luxez001#5 + ",V" + fFechaAnt;
         |LIBERA #dscam012; |CIERRAT #dscam012;
         |SUB_EJECUTA_NP Comodin;
         |ABRET #dscam012; |LEE 101#dscam012.=;
         |DELINDEX #dscaw013;
      |FINSI;
   |FINSI;
   |BUCLE BorraMarcas;
   |CIERRA #dscaw076;
|FPRC;

|RUTINA inf068;
   #dscaw068#0 = 1;
   #dscaw068#1 = 1;
|FRUT;

|RUTINA sup068;
   #dscaw068#0 = 99999;
   #dscaw068#1 = 999;
|FRUT;

|PROCESO Base;
   #dscaw076#0 = #Referen@#0;
   |LEE 000#dscaw076.=;
   |SI FSalida ! 0;
      aLogTitulo = "Guardando en el temporal la remesa n§ " + #Referen@#0; |HAZ ApuntaLog;

      |DDEFECTO #dscaw076;
      #dscaw076#0 = #Referen@#0;
      |GRABA 020#dscaw076.n;
   |FINSI;
|FPRC;

|DEFBUCLE Base;
#Referen@#1002;
;
000001, 001;
999999, 999;
;
NULL, Base;
|FIN;

|PROCESO Desbloquea;
   eaTOperacion = "B"; enNumDocum = #dscaw068#5; |HAZ ProcesaTempo;
|FPRC;

|DEFBUCLE Desbloquea;
#dscaw068#1;
;
INICIO;
FINAL;
;
NULL,Desbloquea;
|FIN;

|RUTINA infer068;
   #dscam068#0 = #dscam036#15;
   #dscam068#1 = #dscam036#0;
   #dscam068#2 = 1;
|FRUT;

|RUTINA super068;
   #dscam068#0 = #dscam036#15;
   #dscam068#1 = #dscam036#0;
   #dscam068#2 = 999;
|FRUT;

|PROCESO Exclusion; |TIPO 3;
   |PUSHV 0959 1979;
   |SI #dscam036#11 = "A";
      LongDato = #dscam036#12;
      |CAMPO_ANCHO #dscam068#3,1,LongDato;
      |CAMPO_MAXIMO #dscam068#3,1,"#";
      |C_V #dscam068#3,1,"S"; |C_M #dscam068#3,1,"S";
   |SINO;
      |C_V #dscam068#3,1,"N"; |C_M #dscam068#3,1,"N";
   |FINSI;
   |SI #dscam036#11 = "N";
      |C_V #dscam068#4,1,"S"; |C_M #dscam068#4,1,"S";
   |SINO;
      |C_V #dscam068#4,1,"N"; |C_M #dscam068#4,1,"N";
   |FINSI;
   |SI #dscam036#11 = "F";
      |C_V #dscam068#5,1,"S"; |C_M #dscam068#5,1,"S";
   |SINO;
      |C_V #dscam068#5,1,"N"; |C_M #dscam068#5,1,"N";
   |FINSI;
   |C_V #dscam068#6,1,"N";
   |ENTLINEAL #1#dscam068,-3,1,18,1,infer068,super068;
   |C_V #dscam068#3,1,"N"; |C_M #dscam068#3,1,"N";
   |C_V #dscam068#4,1,"N"; |C_M #dscam068#4,1,"N";
   |C_V #dscam068#5,1,"N"; |C_M #dscam068#5,1,"N";
   |C_V #dscam068#6,1,"S";
   |POPV;
|FPRC;

|PROCESO Select;
   |SI #luxez001#6 = "N";
      |PARA nCont = 7; |SI nCont [ 18; |HACIENDO nCont = nCont + 1;
         #luxez001#nCont# = "zzzzz"; |PINTA #luxez001#nCont#;
         |C_M #luxez001#nCont#,1,"N";
      |SIGUE;
   |SINO;
      |PARA nCont = 7; |SI nCont [ 18; |HACIENDO nCont = nCont + 1;
         |C_M #luxez001#nCont#,1,"S";
      |SIGUE;
   |FINSI;
|FPRC;

|PROCESO MiraFecha; |TIPO 7;
   |SI FSalida = 2; |ACABA; |FINSI;
   |CONFI "    NUsar como fecha contable la fecha de Vto.? ";
   |SI FSalida = 0;
      nSwFVto = 1;
      #luxez001#20 = "01.01.0000"; |PINTA #luxez001#20;
      |C_M #luxez001#20, 1, "N";
   |SINO;
      nSwFVto = 0;
      #luxez001#20 = ~; |PINTA #luxez001#20;
      |C_M #luxez001#20, 1, "S";
   |FINSI;
|FPRC;

|PROCESO MiraParam; |TIPO 7;
   |SI #dscam051#1 = "S";
      aAlfa = #dscam051#61; |QBF aAlfa;
      |C_M #luxez001#5, 1, aAlfa;
   |SINO;
      |C_M #luxez001#5, 1, "S";
   |FINSI;
|FPRC;

|PROCESO ApuntaLog;
   |SI nHandle < 0; |ACABA; |FINSI;
   |HORA aAlfaLog1; |QBF aAlfaLog1;
   fFechaLog = ~; aAlfaLog2 = fFechaLog;
   aAlfaLog1 = aAlfaLog2 + " " + aAlfaLog1 + " " + aLogTitulo;
   |XGRABA nHandle, aAlfaLog1;
|FPRC;

|PROGRAMA;
   |SI PARAMETRO = "";
      |HAZ Tipo8;
      |CLS;
      |CABEZA "Baja de remesas";

      |ABRE #luxez001; |ABRE #dscam030;
      |ABRE #dscam051;
      |LEE 010#dscam051.p;
      |SI FSalida ! 0;
         |DDEFECTO #dscam051;
         |GRABA 020#dscam051.n;
      |FINSI;
      |CIERRA #dscam051;

      |LEE 000#luxez001.p;
      |SI FSalida ! 0;
         |DDEFECTO #luxez001;
         |GRABA 020#luxez001.c;
      |FINSI;

      Comodin = #48#16; |QBF Comodin;
      |SI Comodin = "";
         HayConta = 0;
         |C_M #luxez001#5,1,"N";
         #luxez001#5 = "    ";
      |SINO;
         HayConta = 1;
         |SI #dscam051#1 = "S";
            #luxez001#5 = #dscam051#25;
            |C_M #luxez001#5,1,"S";
         |SINO;
            |C_M #luxez001#5,1,"N";
            #luxez001#5 = "    ";
         |FINSI;
      |FINSI;

      |PINPA #0#0; |PINDA #0#0;
      Empresa = #48#0;
      |ENDATOS #1#0;
      |SI FSalida = 0;
         nAgrupFecha = 0;
         |SI HayConta = 1;
            |ABRE #dscam030;
            #dscam030#0 = #luxez001#5;
            |LEE 000#dscam030.=;
            |SI FSalida = 0;
               |SI #dscam030#7 = "S"; nAgrupFecha = 1; |FINSI;
            |FINSI;
            |CIERRA #dscam030;
         |FINSI;

         |GRABA 020#luxez001.a;
         |ABRE #dscam012;
         |ABRE #dscam013;
         |ABRE #dscam014;
         |ABRE #dscam004;
         |ABRE #dscam003;
         |DELINDEX #dscaw076; |ABRE #dscaw076;

         Linea = 1;
         |SI #luxez001#22 = "S";
            Comodin = "rr" + Usuario; |NOME_DAT #100 Comodin;
            |DELINDEX #dscaw068; |ABRE #dscaw068;
            |ABRE #dscam013;
            |ABRE #dscam014;
            Linea = 1; nMarca = 1;
            eaTipoRecibo = "V"; aEntidad = "    "; aNumero = "          ";
            |BUCLE RellenaTempo;
            |PUSHV 05012380;
            |ENTLINEAL #1#dscaw068,-2,4,19,1,inf068,sup068;
            |POPV;
            |CONFI "    NConforme con los datos editados ?";
            |SI FSalida = 0;
               Linea = 1; |HAZ VuelcaDatos;
            |FINSI;
            |CIERRA #dscam014;
            |CIERRA #dscam013;
            |CIERRA #dscaw068;
            |BUCLE Desbloquea;
         |SINO;
            aAlfa = "SELECT * FROM dscam013 INTO tm" + Usuario + ".def";
            aAlfa = aAlfa + " WHERE 0 BETWEEN " + #luxez001#0 + "," + #luxez001#1;
            aAlfa = aAlfa + " AND 15 == 'N' AND 6 BETWEEN '01.01.1900','" + #luxez001#4 + "'";
            |SQL aAlfa;
            |SI FSalida = 0;
               |DBASE aAlfa; |QBF aAlfa;
               aAlfa = aAlfa + "def/tm" + Usuario + ".mas";
               |CARGA_DEF aAlfa, Referen@;
               |SI FSalida = 0;
                  |DFICE aAlfa; |QBF aAlfa;
                  |PATH_DAT #1000 aAlfa;
                  |ABRE #Referen@;
                  |DELINDEX #dscaw076; |ABRE #dscaw076;
                  |BUCLE Base;
                  |CIERRA #dscaw076;
                  |CIERRA #Referen@; |DELINDEX #Referen@; |DESCARGA_DEF #Referen@;
               |FINSI;
            |FINSI;
            NumLinea = 1; |BUCLE BajaRemesa;
         |FINSI;

         |CIERRA #dscam003;
         |CIERRA #dscam004;
         |CIERRA #dscam014;

         |BUCLE MarcaAbonada;
         |CIERRA #dscam013;
         |CIERRA #dscam012;
         |CIERRA #dscaw076; |DELINDEX #dscaw076;
      |FINSI;
      |CIERRA #dscam030; |CIERRA #luxez001;
      |HAZ Tipo9;
   |SINO;
      enSinConfi = 1;

      nHandle = -1;
      |HORA aAlfaLog1; |QBF aAlfaLog1;
      aAlfaLog1 = (aAlfaLog1 % 0102) + (aAlfaLog1 % 0402) + (aAlfaLog1 % 0702);
      fFechaLog = ~; aAlfaLog2 = fFechaLog; |QBF aAlfaLog2;
      aAlfaLog2 = (aAlfaLog2 % 0704) + (aAlfaLog2 % 0402) + (aAlfaLog2 % 0102);
      |DBASE aNombreLog; |QBF aNombreLog; aNombreLog = aNombreLog + "log/";
      |MKDIR aNombreLog;
      aNombreLog = aNombreLog + "log" + aAlfaLog2 + aAlfaLog1 + ".txt";
      |XABRE "W", aNombreLog, nHandle;

      aLogTitulo = "Comenzando proceso descuento automatico de riesgo de remesas"; |HAZ ApuntaLog;

      |DFICE aAlfa; |QBF aAlfa;
      || aAlfa = aAlfa + (("00000" + #48#0) % -105) + "/";
      aLogTitulo = "Comprueba si " + aAlfa + " es un directorio"; |HAZ ApuntaLog;

      |DFICE aAlfa; |QBF aAlfa;
      aAlfa2 = aAlfa + "*";
      |_PDIR aAlfa2;
      |SI FSalida ] 0;
         |PATH_DAT #15 aAlfa;
         |PATH_DAT #12 aAlfa; |PATH_DAT #2 aAlfa;
         |PATH_DAT #3 aAlfa;  |PATH_DAT #4 aAlfa;
         |PATH_DAT #1 aAlfa;  |PATH_DAT #5 aAlfa;

         |ABRE #dscam051;
         |LEE 010#dscam051.p;
         |SI FSalida ! 0;
            |DDEFECTO #dscam051;
            |GRABA 020#dscam051.n;
         |FINSI;

         aLogTitulo = "Comprobando si se debe hacer el proceso o se ha hecho ya hoy"; |HAZ ApuntaLog;
         fFecha = ~;
         |SI #dscam051#36 ! fFecha;
            aLogTitulo = "No se ha hecho hoy. Procediendo a ejecutarlo."; |HAZ ApuntaLog;
            #dscam051#36 = fFecha; |GRABA 020#dscam051.a;
            nNume = fFecha;
            nNume = nNume - nDiasCarencia;
            fFecha = nNume; #luxez001#4 = fFecha;
            #luxez001#5 = #dscam051#25;
            enEmpCartera = #48#0;
            |HAZ Tipo8;
            |ABRE #dscam012;
            |ABRE #dscam013;
            |ABRE #dscam014;
            |ABRE #dscam004;
            |ABRE #dscam003;
            |DELINDEX #dscaw076; |ABRE #dscaw076;

            aAlfa = "SELECT * FROM dscam013 INTO tm" + Usuario + ".def";
            aAlfa = aAlfa + " WHERE 15 == 'N' AND 6 BETWEEN '01.01.1900','" + #luxez001#4 + "'";
            aLogTitulo = " Ejecutando sentencia SQL '" + aAlfa + "'"; |HAZ ApuntaLog;
            |SQL aAlfa;
            aLogTitulo = FSalida % 0299; |HAZ ApuntaLog;
            |SI FSalida = 0;
               |DBASE aAlfa; |QBF aAlfa;
               aAlfa = aAlfa + "def/tm" + Usuario + ".mas";
               |CARGA_DEF aAlfa, Referen@;
               |SI FSalida = 0;
                  |DFICE aAlfa; |QBF aAlfa;
                  || aAlfa = aAlfa + (("00000" + #48#0) % -105) + "/";
                  aLogTitulo = "Ejecutando proceso en directorio de datos " + aAlfa; |HAZ ApuntaLog;
                  |PATH_DAT #1000 aAlfa;
                  |ABRE #Referen@;
                  |DELINDEX #dscaw076; |ABRE #dscaw076;
                  |BUCLE Base;
                  |CIERRA #dscaw076;
                  |CIERRA #Referen@; |DELINDEX #Referen@; |DESCARGA_DEF #Referen@;
               |FINSI;
            |FINSI;

            NumLinea = 1; |BUCLE BajaRemesa;

            |CIERRA #dscam003;
            |CIERRA #dscam004;
            |CIERRA #dscam014;

            |BUCLE MarcaAbonada;
            |CIERRA #dscam013;
            |CIERRA #dscam012;
            |CIERRA #dscaw076; |DELINDEX #dscaw076;
            |HAZ Tipo9;
         |SINO;
            aLogTitulo = "Se ha hecho hoy. No se vuelve a ejecutar."; |HAZ ApuntaLog;
         |FINSI;

         |CIERRA #dscam030;
         |CIERRA #dscam051;
         |CIERRA #luxez001;
      |FINSI;
      enSinConfi = 0;
   |FINSI;

   |XCIERRA nHandle;

   eaSesion   = Usuario; |HAZ LimpiaTempo;
|FPRO;
