|FICHEROS;
   dscaz112 #0;

   dscam003 #10;
   dscam004 #11;
   dscaw028 #12,MANTE;
   dscam044 #13;

   agif010@ #1000;
   agif071@ #1001;
|FIN;

|VARIABLES;
   &Divisa     = "";
   &enRemesa   = 0;
   &nDeci_Div  = 0;
   &nDeci_Base = 0;
   &enEmpCartera = 0; &enEmpGestion = 0; &enDocum = 0;
   &eaSerie = ""; &eaCliGest = ""; &nImporte = 0; &eaTipoOper = "";

   &eaTipoR = "";

   fFecha      = @;

   aRefer      = "";
   nSwErr      = 0;
   nFactura    = 0;
   nImpDiv     = 0;
   nImpBase    = 0;
   nNumEntrega = 0;
   Linea       = 0;
   nReciboACobrar = 0;
   fFechaEmis  = @;

   CtaCli      = "";
   CodCli      = "";
   CtaCobro    = "";

   nImporteD   = 0;
   nImporteB   = 0;

   nSwHay      = 0;
   nLinea      = 1;
   LinCob      = 0;
   nImpCob     = 0;
   nImpRec     = 0;
   nImpDto     = 0;
   nNumSec     = 0;
   nCalc       = 0;

   FechaOper   = @;

   aDirBase    = "";
   aSerie      = "";
   aAlfa       = "";
   aAlfa1      = "";
   aAlfa2      = "";
   Comodin     = "";
|FIN;

|PROCESO Pagares;
   |SI #dscam003#14 = "A"; |O #dscam003#14 = "D";
    |O #dscam003#14 = "R"; |O #dscam003#14 = "L";
       |ACABA;
   |FINSI;

   Divisa = #dscam003#57; |HAZ TomaDecim;

   |SELECT #2#dscaw028;
   #dscaw028#1 = #dscam003#72;
   #dscaw028#2 = #dscam003#70;
   |LEE 000#dscaw028.=;
   |SI FSalida ! 0; #dscaw028#0 = 0; |FINSI;
   |SELECT #1#dscaw028;
   |LEE 000#dscaw028.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscaw028;
      #dscaw028#0 = nLinea; nLinea = nLinea + 1;
      #dscaw028#1 = #dscam003#72;
      #dscaw028#2 = #dscam003#70;
      #dscaw028#3 = #dscam003#78;
      #dscaw028#4 = "*";
      #dscaw028#5 = #dscam003#32;
      #dscaw028#6 = #dscam003#5;
      #dscaw028#7 = #dscam003#6;
      #dscaw028#8 = #dscam003#71;

      #dscam004#17 = #dscam003#40;
      #dscam004#3  = 1;
      |LEE 000#dscam004.];
      |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
         |SI #dscam004#5 = "RPT"; #dscaw028#9 = #dscam004#6;  |FINSI;
         |LEE 000#dscam004.s;
      |SIGUE;

      |GRABA 020#dscaw028.n;
   |FINSI;
|FPRC;

|DEFBUCLE Pagares;
#dscam003#7;
31,71;
#dscaz112#0, "         !", 000000001, 0000000000.01, #dscaz112#1;
#dscaz112#2, "zzzzzzzzzz", 999999999, 9999999999.99, #dscaz112#3;
;
NULL,Pagares;
|FIN;

|PROCESO PagJamaica;
   Divisa = #dscam003#57; |HAZ TomaDecim;

   aAlfa = #dscam003#85; |QBF aAlfa;
   aAlfa1 = aAlfa % 1902; nCalc = aAlfa1;
   |SI nCalc > 80;
      aAlfa1 = "19" + aAlfa1;
   |SINO;
      aAlfa1 = "20" + aAlfa1;
   |FINSI;

   aAlfa1 = (aAlfa % 1502) + "." + (aAlfa % 1702) + "." + aAlfa1;
   aAlfa = aAlfa % 0104;
   |SI aAlfa < #dscaz112#0;  |O aAlfa > #dscaz112#2;  |ACABA; |FINSI;
   fFecha = aAlfa1;
   |SI fFecha < #dscaz112#1; |O fFecha > #dscaz112#3; |ACABA; |FINSI;
   aAlfa2 = #dscam003#85; |QBF aAlfa2;
   aAlfa2 = aAlfa2 % 0510;

   |SELECT #2#dscaw028;
   #dscaw028#1  = aAlfa;
   #dscaw028#2  = aAlfa2;
   |LEE 000#dscaw028.=;
   |SI FSalida ! 0;
      |SELECT #1#dscaw028;
      |DDEFECTO #dscaw028;
      #dscaw028#0  = nLinea; nLinea = nLinea + 1;
      #dscaw028#1  = aAlfa;
      #dscaw028#2  = aAlfa2;
      #dscaw028#4  = "*";
      #dscaw028#5  = #dscam003#32;
      #dscaw028#6  = #dscam003#5;
      #dscaw028#7  = #dscam003#6;
      #dscaw028#8  = aAlfa1;
      #dscaw028#10 = #dscam003#40;
      |GRABA 020#dscaw028.c;
   |SINO;
      |SELECT #1#dscaw028;
      |LEE 000#dscaw028.=;
   |FINSI;
   #dscaw028#3  = #dscaw028#3 + #dscam003#30;
   |GRABA 020#dscaw028.a;

   #dscam004#17 = #dscam003#40;
   #dscam004#3  = 1;
   |LEE 000#dscam004.];
   |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
      |SI #dscam004#5 = "RPT"; #dscaw028#9 = #dscam004#6;  |FINSI;
      |LEE 000#dscam004.s;
   |SIGUE;

|FPRC;

|DEFBUCLE PagJamaica;
#dscam003#6;
85;
00,"     ", 000000, 000, "A", 000000001, "0000                ";
99,"zzzzz", 999999, 999, "A", 999999999, "99999999999999999999";
;
NULL,PagJamaica;
|FIN;

|RUTINA inf028;
   #dscaw028#0 = 1;
|FRUT;

|RUTINA sup028;
   #dscaw028#0 = 999;
|FRUT;

|PROCESO Recibos;

   nSwHay = 1; nImpRec = 0; nImpDto = 0;
   Divisa = #dscam003#57; |HAZ TomaDecim;

   |ABRE #dscam004;
   #dscam004#17 = #dscam003#40;
   #dscam004#3  = 1;
   |LEE 000#dscam004.];
   |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
      |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
         LinCob = #dscam004#3 + 1;
         |SI #dscam004#5 = "RPT";
            nImpRec = #dscam004#44;
            nImpDto = #dscam004#45;
            |SI nNumSec = 0;
               |SI #dscam004#43 = 0;
                  |SALVA_FICHA #dscam004;
                  |SELECT #3#dscam004;
                  |LEE 000#dscam004.u;
                  nNumSec = #dscam004#43 + 1;
                  |SELECT #1#dscam004;
                  |LEE 000#dscam004.p;
                  |REPON_FICHA #dscam004;
               |SINO;
                  nNumSec = #dscam004#43;
               |FINSI;
            |FINSI;
         |FINSI;
         |LEE 000#dscam004.s;
      |SIGUE;
   |SINO;
      LinCob = 1;
   |FINSI;

   |DDEFECTO #dscam004;
   #dscam004#17 = #dscam003#40;
   #dscam004#3 = LinCob;
   |GRABA 020#dscam004.b;
   #dscam004#0  = #dscam003#0;
   #dscam004#1  = #dscam003#1;
   #dscam004#2  = #dscam003#2;
   #dscam004#4  = "";
   #dscam004#5  = "RTA";
   #dscam004#6  = #dscam003#71;
   |SI #dscam003#47 ! "S";
      #dscam004#7  = #dscam003#23; #dscam004#25 = #dscam003#61;
   |FINSI;
   #dscam004#8  = #dscam003#31;
   #dscam004#26 = #dscam003#65;
   #dscam004#11 = #dscam003#13;
   #dscam004#15 = #dscam003#27;
   Comodin = "Cob.Talon n§" + #dscam003#72 + "/" + #dscam003#70;
   #dscam004#16 = Comodin;
   #dscam004#33 = #dscam003#59;
   #dscam004#43 = nNumSec;
   #dscam004#44 = nImpRec;
   #dscam004#45 = nImpDto;
   |GRABA 020#dscam004.a;
   |LIBERA #dscam004; |CIERRA #dscam004;

   #dscam003#31 = 0; #dscam003#65 = 0;
   #dscam003#23 = #dscam003#30; #dscam003#61 = #dscam003#64;
   #dscam003#14 = "L"; #dscam003#15 = "Recibo liquidado";
   #dscam003#84 = "S";
   |GRABA 020#dscam003.a; |LIBERA #dscam003;

   eaTipoOper = "-4";           enEmpCartera = -1;
   enEmpGestion = #dscam003#46; eaSerie = #dscam003#0;
   eaCliGest = #dscam003#32;    nImporte = #dscam004#26;
   |HAZ BucleRiesgo;

|FPRC;

|DEFBUCLE Recibos;
#dscam003#7;
;
#dscaw028#1, #dscaw028#2, 000000001;
#dscaw028#1, #dscaw028#2, 999999999;
be;
NULL,Recibos;
|FIN;

|PROCESO SaldadoAuto;
|| Compruebo que la entrega a cuenta en la que se esta ,cuelga del recibo que
||    se esta tratando

   |DFICB aAlfa; |QBF aAlfa; |PATH_DAT #dscam044#aAlfa#;
   |ABRE #dscam044;
   #dscam044#0 = #dscam003#46;
   |LEE 000#dscam044.=
   |SI FSalida = 0;
      nSwErr = 0;
      aDirBase = #dscam044#1; |QBF aDirBase;
      |SI #dscam003#69 = "A";
         aAlfa = aDirBase + "def/agifa010.mas";
         |CARGA_DEF aAlfa, agif010@;
         |SI FSalida = 0;
            aAlfa = aDirBase + "fich/" + (("00000" + #dscam044#0) % -105) + "/";
            |PATH_DAT #1000 aAlfa; |ABRE #agif010@;
            #agif010@#52 = #dscam003#0;
            #agif010@#0  = #dscam003#1;
            |LEE 000#agif010@.=;
            |SI FSalida ! 0;
               nSwErr = 1;
            |SINO;
               aSerie     = #agif010@#53;
               nFactura   = #agif010@#39;
               fFechaEmis = #agif010@#60;
               nSwErr = 0;
            |FINSI;
            |CIERRA #agif010@; |DESCARGA_DEF #agif010@;
         |FINSI;
      |FINSI;
   |FINSI;
   |CIERRA #dscam044;

   |SI nSwErr = 1; |ACABA; |FINSI;

   nSwErr = 1;
   |SALVA_FICHA #dscam003;
   |SELECT #6#dscam003;
   |DDEFECTO #dscam003;
   #dscam003#0 = aSerie;
   #dscam003#1 = nFactura;
   |LEE 000#dscam003.];
   |PARA; |SI FSalida = 0; |Y #dscam003#0 = aSerie; |Y #dscam003#1 = nFactura; |Y #dscam003#4 = fFechaEmis; |HACIENDO;
      |SI #dscam003#31 ! 0;
         nReciboACobrar = #dscam003#40; nSwErr = 0; |SAL;
      |FINSI;
      |LEE 000#dscam003.s;
   |SIGUE;
   |SELECT #1#dscam003;
   |REPON_FICHA #dscam003;

   |SI nSwErr = 1; |ACABA; |FINSI;

||    Escribo el movimiento del recibo cobrado y actualizo el recibo a cobrar

   |SI #dscam003#14 = "e"; |O #dscam003#14 = "E";   || Entrega a cuenta por compensar o compensada parcialmente
      #dscam004#17 = #dscam003#40; #dscam004#3 = 1;
      |LEE 000#dscam004.];
      |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
         CtaCobro = #dscam004#42;
      |FINSI;
      |SI #dscam003#23 ! #dscam003#31;
         nImpDiv  = #dscam003#23; nImpBase = #dscam003#61; nNumEntrega = #dscam003#40;
         #dscam004#17 = #dscam003#40;
         #dscam004#3  = 1;
         |LEE 000#dscam004.];
         |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
            |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
               Linea = #dscam004#3 + 1;
               |LEE 000#dscam004.s;
            |SIGUE;
         |SINO;
            Linea = 1;
         |FINSI;

         |SALVA_FICHA #dscam003;
         |SELECT #1#dscam003;

         #dscam003#40 = nReciboACobrar;
         |LEE 101#dscam003.=;
         |SI FSalida = 0;

            |SI #dscam003#31 = 0; |ACABA; |FINSI;

            |DDEFECTO #dscam004;
            #dscam004#17 = #dscam003#40;
            #dscam004#3  = LinCob; LinCob = LinCob + 1;
            |GRABA 020#dscam004.b;
            #dscam004#0 = #dscam003#0;
            #dscam004#1 = #dscam003#1;
            #dscam004#2 = #dscam003#2;
            #dscam004#4 = CtaCobro;
            #dscam004#5 = "CAC";
            #dscam004#6 = ~;
            #dscam004#7 = #dscam003#23;
            |SI #dscam003#31 ] nImpDiv;
               #dscam004#8  = nImpDiv; #dscam004#26 = nImpBase;
            |SINO;
               #dscam004#8  = #dscam003#31; #dscam004#26 = #dscam003#65;
            |FINSI;
            #dscam004#15 = #dscam003#27;
            Comodin = ("000000000" + nNumEntrega) % -109;
            Comodin = "Cobro entr. " + Comodin;
            #dscam004#16 = Comodin;
            #dscam004#25 = #dscam003#61;
            #dscam004#40 = nNumEntrega;
            #dscam004#41 = Linea;
            |GRABA 020#dscam004.a; |LIBERA #dscam004;
            || enEmpCartera = #48#0; enEmpGestion = #dscam003#46;
            enEmpCartera = -1;     enEmpGestion = #dscam003#46;
            eaSerie = #dscam003#0; eaCliGest = #dscam003#32; nImporte = #dscam004#26;
            eaTipoOper = "-4";
            |HAZ BucleRiesgo;

            |SI #dscam003#31 ] nImpDiv;
               #dscam003#23 = #dscam003#23 + nImpDiv;
               #dscam003#61 = #dscam003#61 + nImpBase;
            |SINO;
               #dscam003#23 = #dscam003#23 + #dscam003#31; nImpDiv  = #dscam003#31;
               #dscam003#61 = #dscam003#61 + #dscam003#65; nImpBase = #dscam003#65;
               #dscam003#31 = 0; #dscam003#65 = 0;
            |FINSI;
            #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
            #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
            #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
            #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);
            #dscam003#31 = #dscam003#30 - #dscam003#23; #dscam003#65 = #dscam003#64 - #dscam003#61;
            |SI #dscam003#31 = 0;
               #dscam003#14 = "L";
               #dscam003#15 = "Recibo Liquidado";
            |SINO;
               |SI #dscam003#23 = 0;
                  |SI #dscam003#16 = 0;
                     #dscam003#14 = "P";
                     #dscam003#15 = "Pendiente de cobro";
                  |SINO;
                     #dscam003#14 = "I";
                     #dscam003#15 = "Impagado";
                  |FINSI;
               |SINO;
                  #dscam003#14 = "C";
                  #dscam003#15 = "Parcialmente cobrado";
               |FINSI;
            |FINSI;
            |GRABA 020#dscam003.a; |LIBERA #dscam003;
         |FINSI;
         |SELECT #6#dscam003;
         |REPON_FICHA #dscam003;

||  Escribo el movimiento del recibo a cuenta y actualizo el recibo a cuenta

         |DDEFECTO #dscam004;
         #dscam004#17 = #dscam003#40;
         #dscam004#3  = Linea;
         |GRABA 020#dscam004.b;
         #dscam004#0 = #dscam003#0;
         #dscam004#1 = #dscam003#1;
         #dscam004#2 = #dscam003#2;
         #dscam004#4 = "";
         #dscam004#5 = "REC";
         #dscam004#6 = ~;
         #dscam004#7 = #dscam003#23;
         |SI #dscam003#23 ] nImpDiv;
            #dscam004#8  = -nImpDiv; #dscam004#26 = -nImpBase;
            #dscam004#23 = nImpDiv;  #dscam004#32 = nImpBase;
         |SINO;
            #dscam004#8  = -#dscam003#31; #dscam004#26 = -#dscam003#65;
            #dscam004#23 = #dscam003#31;  #dscam004#32 = #dscam003#65;
         |FINSI;
         #dscam004#15 = #dscam003#27;
         Comodin = ("0000000000" + nReciboACobrar) % -110;
         Comodin = "Cobro Doc. " + Comodin;
         #dscam004#16 = Comodin;
         #dscam004#25 = #dscam003#61;
         |GRABA 020#dscam004.a; |LIBERA #dscam004;

         || enEmpCartera = #48#0; enEmpGestion = #dscam003#46;
         enEmpCartera = -1;     enEmpGestion = #dscam003#46;
         eaSerie = #dscam003#0; eaCliGest = #dscam003#32; nImporte = -#dscam004#26;
         eaTipoOper = ""; eaTipoR = "";
         |SI #dscam003#69 = "P"; eaTipoOper = "-5"; eaTipoR = "P"; |FINSI;
         |SI #dscam003#69 = "A"; eaTipoOper = "-5"; eaTipoR = "A"; |FINSI;
         |SI eaTipoOper ! ""; |HAZ BucleRiesgo; |FINSI;
         eaTipoR = "";

         |SI #dscam003#23 ] nImpDiv;
            #dscam003#23 = #dscam003#23 - nImpDiv;
            #dscam003#61 = #dscam003#61 - nImpBase;
            #dscam003#55 = #dscam003#55 + nImpDiv;
            #dscam003#68 = #dscam003#68 + nImpBase;
         |SINO;
            #dscam003#23 = -#dscam003#31; nImpDiv = #dscam003#31;
            #dscam003#61 = -#dscam003#65; nImpBase = #dscam003#65;
            #dscam003#55 = #dscam003#55 + #dscam003#31;
            #dscam003#68 = #dscam003#68 + #dscam003#65;
            #dscam003#31 = 0; #dscam003#65 = 0;
         |FINSI;
         |SI #dscam003#31 = #dscam003#23;
            #dscam003#14 = "L";
            #dscam003#15 = "Recibo Compensado";
         |SINO;
            |SI #dscam003#23 = 0;
               #dscam003#14 = "e";
               #dscam003#15 = "Pendiente de compensar";
            |SINO;
               #dscam003#14 = "E";
               #dscam003#15 = "Compensado parcialmente";
            |FINSI;
         |FINSI;
         #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
         #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
         #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
         #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);
         #dscam003#31 = #dscam003#30 - #dscam003#23; #dscam003#65 = #dscam003#64 - #dscam003#61;
         |GRABA 020#dscam003.a; |LIBERA #dscam003;
      |FINSI;
   |FINSI;

|FPRC;

|PROCESO SaldaEntrega;
      aAlfa = #dscam003#85; aAlfa = aAlfa % 0114;
      |SI aAlfa ! aRefer; |ACABA; |FINSI;

      #dscam004#17 = #dscam003#40;
      #dscam004#3 = 1;
      |LEE 000#dscam004.];
      |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
         |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
            LinCob = #dscam004#3 + 1;
            |LEE 000#dscam004.s;
         |SIGUE;
      |SINO;
         LinCob = 1;
      |FINSI;

      |DDEFECTO #dscam004;
      #dscam004#17 = #dscam003#40;
      #dscam004#3  = LinCob;
      |GRABA 020#dscam004.b;
      #dscam004#0 = #dscam003#0;
      #dscam004#1 = #dscam003#1;
      #dscam004#2 = #dscam003#2;
      #dscam004#4 = "";
      #dscam004#5 = "RAC";
      #dscam004#6 = ~;
      #dscam004#7 = 0;
      #dscam004#8 = #dscam003#31; #dscam004#26 = #dscam003#65;
      #dscam004#15 = #dscam003#27;
      Comodin = "Entrega a cuenta";
      #dscam004#16 = Comodin;
      #dscam004#25 = #dscam003#61;
      #dscam004#42 = "";
      |GRABA 020#dscam004.a; |LIBERA #dscam004;

      #dscam003#23 = #dscam003#23 + #dscam004#8;
      #dscam003#61 = #dscam003#61 + #dscam004#26;
      #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
      #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
      #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
      #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);
      #dscam003#31 = #dscam003#30 - #dscam003#23; #dscam003#65 = #dscam003#64 - #dscam003#61;
      #dscam003#85 = "";
      |GRABA 020#dscam003.a; |LIBERA #dscam003;

      |HAZ SaldadoAuto;
|FPRC;

|DEFBUCLE SaldaEntrega;
#dscam003#6;
;
00, "     ", 000000, 001, "A", 000000001;
99, "zzzzz", 999999, 999, "A", 999999999;
be;
NULL,SaldaEntrega;
|FIN;

|PROCESO Saldado;
   |SI #dscaw028#10 = 0;
      || Escribimos el movimiento de liquidacion y rebajamos el riesgo de cliente
      nSwHay = 0; |BUCLE Recibos;
   |SINO;
      aRefer = (("    " + #dscaw028#1) % -104) + (("          " + #dscaw028#2) % -110);
      |ABRE #dscam004;
      |BUCLE SaldaEntrega;
      |CIERRA #dscam004;
   |FINSI;
|FPRC;

|DEFBUCLE Saldado;
#dscaw028#1;
4;
00001, "*";
99999, "*";
;
NULL,Saldado;
|FIN;

|PROGRAMA;
   |HAZ Tipo8;

   enRemesa   = 1;
   |CLS;
   |CABEZA " Saldado pagares/talones de clientes ";

   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      aAlfa = "tp" + Usuario; |NOME_DAT #dscaw028#aAlfa#;
      |DELINDEX #dscaw028; |ABRE #dscaw028; nLinea = 1;
      |ABRE #dscam004;
      |BUCLE Pagares; |BUCLE PagJamaica;
      |ENTLINEAL #1#dscaw028,-1,4,19,1,inf028,sup028;
      |CONFI "    SConforme con la seleccion ? ";
      |SI FSalida = 0; |BUCLE Saldado; |FINSI;
      |CIERRA #dscam004; |CIERRA #dscaw028;
   |FINSI;

   |HAZ Tipo9;
|FPRO;
