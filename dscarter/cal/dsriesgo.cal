|FICHEROS;
   dsriesgo #0;
   dscamrie #1;
   dscam003 #5;

   dscam051 #10;
   dscaw210 #100;
|FIN;

|VARIABLES;
   &nDeci_Base = 0;

   &enEmpCartera = 0; &enEmpGestion = 0;
   &eaSerie = ""; &eaCliGest = ""; &nImporte = 0; &eaTipoOper = "";
   &eaNomCli = ""; &eaTipoR = "";

   Comodin  = "";
   Comodin1 = "";
   &aRPath  = "";
   &aRNome  = "";
   aAlfa  = "";
   aAlfa1 = "";
   nCalc  = 0;
   nCanal = 0;
   nTestCont = 0;

   FechaEnl    = @; FechaHoy  = @;
   HoraEnl     = 0; Hora      = 0;
   MinutosEnl  = 0; Minutos   = 0;
   SegundosEnl = 0; Segundos  = 0;
   Cambiante   = 0; Respuesta = "";

|FIN;

|PROCESO HazRiesgo;
   |LEE 101#dsriesgo.p; #dsriesgo#5 = nTestCont; |GRABA 020#dsriesgo.a; |LIBERA #dsriesgo;
   nTestCont = nTestCont + 1; |SI nTestCont > 99999999999; nTestCont = 0; |FINSI;

/*
   |DBASE aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "fich/" + (("00000" + #dscamrie#2) % -105) + "/";
   Comodin = aAlfa + "dscam051.dat";
   |XABRE "E", Comodin, nCanal;
   |SI FSalida < 0;
      Comodin = ("00000" + #dscamrie#2) % -105;
      Comodin = "    La empresa " + Comodin + " de cartera no existe";
      |MENAV Comodin; |ACABA;
   |FINSI;

   |PATH_DAT #10 aAlfa;
*/
   || enEmpCartera = #dscamrie#2; enEmpGestion = #dscamrie#0;
   enEmpCartera = -1; enEmpGestion = #dscamrie#0;
   eaSerie = #dscamrie#4; eaCliGest = #dscamrie#6; eaNomCli = #dscamrie#9;
   eaTipoR = #dscamrie#3;
   |SI #dscamrie#3 = "P"; eaTipoOper = "2"; |FINSI;
   |SI #dscamrie#3 = "p"; eaTipoOper = "5"; |FINSI;
   |SI #dscamrie#3 = "A"; eaTipoOper = "3"; |FINSI;
   |SI #dscamrie#3 = "a"; eaTipoOper = "5"; |FINSI;
   |SI #dscamrie#3 = "F"; eaTipoOper = "4"; |FINSI;
   nImporte = #dscamrie#5;
   |SI nImporte < 0;
      eaTipoOper = "-" + eaTipoOper;
      nImporte = 0 - nImporte;
   |SINO;
      eaTipoOper = "+" + eaTipoOper;
   |FINSI;
/*
   |ABRE #dscam051;
   |LEE 000#dscam051.p;
   |SI FSalida ! 0;
      |DDEFECTO #dscam051;
      |GRABA 020#dscam051.c;
   |FINSI;
   |CIERRA #dscam051;

   |SI #dscam051#3 = "N"; |ACABA; |FINSI;
*/
   |HAZ BucleRiesgo;
|FPRC;

|DEFBUCLE Riesgo;
#dscamrie#1;
;
00000,001;
99999,999;
;
NULL,HazRiesgo;
|FIN;

|PROGRAMA;
   |ABRET #dsriesgo;
   |PARA; |SI; |HACIENDO;
      |LEE 000#dsriesgo.p;
      |SI FSalida ! 0;
         |DDEFECTO #dsriesgo;
         |GRABA 020#dsriesgo.n;

         |SI FSalida = 102; |ACABA; |FINSI;

         |LEE 000#dsriesgo.p;
      |FINSI;
      |SI #dsriesgo#1 = "N";
          |LEE 101#dsriesgo.p;
          |SI FSalida = 0;
              #dsriesgo#1 = "S";
              #dsriesgo#2 = ~;
              |HORA Comodin; Comodin = Comodin % 0105; #dsriesgo#3 = Comodin;
              Comodin = Usuario % 0810; #dsriesgo#4 = Comodin;
              |GRABA 020#dsriesgo.a; |LIBERA #dsriesgo;
              |ATRI N;|PINTA 2307,"                                      "; |ATRI N;
              |SAL;
         |FINSI;
      |SINO;
         FechaHoy = ~;  FechaEnl = #dsriesgo#2;
         |HORA Comodin;
         Comodin1 = Comodin % 0102; Hora        = Comodin1;
         Comodin1 = Comodin % 0402; Minutos     = Comodin1;
         Comodin1 = Comodin % 0702; Segundos    = Comodin1;
         |SI HoraEnl = 0; |Y MinutosEnl = 0; |Y SegundosEnl = 0;
            |HORA Comodin; |QBF Comodin;
            Comodin1 = Comodin % 0102; HoraEnl     = Comodin1;
            Comodin1 = Comodin % 0402; MinutosEnl  = Comodin1;
            Comodin1 = Comodin % 0702; SegundosEnl = Comodin1;
            SegundosEnl = SegundosEnl + 30;
            |SI SegundosEnl ] 60;
               MinutosEnl = MinutosEnl + 1; SegundosEnl = SegundosEnl - 60;
               |SI MinutosEnl ] 60;
                  HoraEnl = HoraEnl + 1; MinutosEnl = MinutosEnl - 60;
               |FINSI;
            |FINSI;
         |SINO;
            |SI Cambiante ! #dsriesgo#5;
                Cambiante = #dsriesgo#5;
                |HORA Comodin; |QBF Comodin;
                Comodin1 = Comodin % 0102; HoraEnl     = Comodin1;
                Comodin1 = Comodin % 0402; MinutosEnl  = Comodin1;
                Comodin1 = Comodin % 0702; SegundosEnl = Comodin1;
                SegundosEnl = SegundosEnl + 30;
                |SI SegundosEnl ] 60;
                   MinutosEnl = MinutosEnl + 1; SegundosEnl = SegundosEnl - 60;
                   |SI MinutosEnl ] 60;
                      HoraEnl = HoraEnl + 1; MinutosEnl = MinutosEnl - 60;
                  |FINSI;
                |FINSI;
            |SINO;
               Comodin  = (("00" + Hora)    % -102) + (("00" + Minutos)    % -102) + (("00" + Segundos)    % -102);
               Comodin1 = (("00" + HoraEnl) % -102) + (("00" + MinutosEnl) % -102) + (("00" + SegundosEnl) % -102);
               |SI FechaHoy = FechaEnl; |Y Comodin1 ] Comodin;
                  |ATRI I; |PINTA 2307, "Puente Bloqueado, Espere por favor .. "; |ATRI N;
               |SINO;
                  |SI Respuesta = "";
                     |PUSHV 0501 2380;
                     #dscaw210#0 = #dsriesgo#2;
                     #dscaw210#1 = #dsriesgo#3;
                     #dscaw210#2 = #dsriesgo#4;
                     |PINPA #0#dscaw210; |PINDA #0#dscaw210;
                     |ENDATOS #1#dscaw210;
                     |SI FSalida = 0;
                        |SI #dscaw210#3 = "SI";
                           Respuesta = "SI";
                           #dsriesgo#1 = "S";
                           #dsriesgo#2 = ~;
                           |HORA Comodin; Comodin = Comodin % 0105;
                           #dsriesgo#3 = Comodin;
                           |GRABA 020#dsriesgo.a; |LIBERA #dsriesgo;
                           |ATRI N;|PINTA 2307,"                                      "; |ATRI N;
                           |SAL;
                        |SINO;
                           HoraEnl = 0; MinutosEnl = 0; SegundosEnl = 0;
                           Respuesta = "";
                        |FINSI;
                     |SINO;
                        HoraEnl = 0; MinutosEnl = 0; SegundosEnl = 0;
                        Respuesta = "";
                     |FINSI;
/*
                     |PUSHV 0501 2380; |BLANCO 1010 1870; |CUADRO 1010 1870;
                     |PINTA 1112, "Hay un puente activo que parece bloqueado.";
                     Comodin = "Fecha comienzo puente : " + #dsriesgo#2 + "   Hora comienzo : " + #dsriesgo#3;
                     |PINTA 1212, Comodin;
                     Comodin = "Usuario que lanzo el puente : " + #dsriesgo#4;
                     |PINTA 1312, Comodin;
                     Comodin = "¨ Desea anularlo ? (SI/NO) : ";
                     |PINTA 1513, Comodin;
                     E_sup = 2; E_inf = "SINO";
                     Respuesta = "NO";
                     Respuesta = 1541 ? 0;
                     |SI Respuesta = "SI";
                        #dsriesgo#1 = "S";
                        #dsriesgo#2 = ~;
                        |HORA Comodin; Comodin = Comodin % 0105;
                        #dsriesgo#3 = Comodin;
                        |GRABA 020#dsriesgo.a; |LIBERA #dsriesgo;
                        |ATRI N;|PINTA 2307,"                                      "; |ATRI N;
                        |SAL;
                     |SINO;
                        HoraEnl = 0; MinutosEnl = 0; SegundosEnl = 0;
                        Respuesta = "";
                     |FINSI;
*/
                     |POPV;
                  |SINO;
                     |ATRI I; |PINTA 2307, "Puente Bloqueado, Espere por favor .. "; |ATRI N;
                  |FINSI;
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
   |SIGUE;

   aAlfa  = aRPath; |QBF aAlfa;
   aAlfa1 = aRNome; |QBF aAlfa1;
   |SI aAlfa = ""; |Y aAlfa1 = ""; |Y PARAMETRO ! "";
      aAlfa = PARAMETRO; |QBF aAlfa;
      aAlfa = aAlfa - ",";
      |SI FSalida ! 0;
         nCalc = FSalida + 98; aRNome = aAlfa % nCalc;
         nCalc = ((FSalida / 100) ! 0) + 99; aRPath = aAlfa % nCalc;
      |FINSI;
   |FINSI;

   |PATH_DAT #1 aRPath;
   |NOME_DAT #1 aRNome;
   |ABRE #dscamrie;

   |HAZ Tipo8;

   |SI nDeci_Base = 0; nDeci_Base = 2; |FINSI;

   nTestCont = 0;
   |BUCLE Riesgo;

   |HAZ Tipo9;

   |CIERRA #dscamrie; |DELINDEX #dscamrie;

   |LEE 101#dsriesgo.p;
   |SI FSalida = 0;
      #dsriesgo#1 = "N";
      |GRABA 020#dsriesgo.a; |LIBERA #dsriesgo;
   |FINSI;
   |CIERRAT #dsriesgo;
|FPRO;
