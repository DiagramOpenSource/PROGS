|FICHEROS;
   dscaz002 #0;
   dscam051 #1;
   dscam030 #2;
   dscam043 #3;
   dscaz001 #4;
   dscam222 #5;

   canempr@ #100;
   cajainc@ #101;
   camasil@ #102;
   &cacuent@;
|FIN;

|VARIABLES;
   &HayConta = 0;
   &enTipoEntrada = 0;
   &enDocum = 0;
   &efFechaVto = @;
   &efFechaDoc = @;
   &efFechaUlt = @;
   &MaxDigit = 0;
   &nDeci_males = 0;
   &eaCodEnlace = "";
   &efFecha     = @;
   &eaSerie     = "";
   &eaDirConta  = "";
   &eaEmpContab = "";
   &enSwError   = 0;

   Comodin = "";
   Parte   = "";
   Part1   = "";
   Part2   = "";
   Calc    = 0;
   nCalc   = 0;
   nCalc1  = 0;
   Parte1  = 0;
   Parte2  = 0;
   Long    = 0;
   LongAlfa = "";

   nSwLuxe    = 0;
   nSwPermite = 0;

   fFecha  = @;
   nTecla  = 0;
   nAnyo   = 0;
   aAlfa   = "";
   aDirCont = "";
|FIN;

|PROCESO MiraImporte;
   Calc = (#dscaz002#3 - (#dscaz002#4 - (#dscaz002#5 + #dscaz002#9))) ! 2;
   |SI Calc ! 0;
      |C_M #dscaz002#10,1,"S";
   |SINO;
      |C_M #dscaz002#10,1,"N";
   |FINSI;

   Calc = (#dscaz002#3 + #dscaz002#5 + #dscaz002#9) ! nDeci_males;
   |SI Calc > 0;
      |SI #dscaz002#4 > Calc;
          |SI #dscam051#132 = "S";
               aAlfa = "    NSobrepasado importe del recibo. Se crear  una entrega a cuenta por el exceso. " + &191 + "Continuar ?";
               |CONFI aAlfa;
               |SI FSalida ! 0; |ERROR; |FINSI;
          |SINO;
               |AVISO;
               |MENAV "    Importe sobrepasado";
               |ERROR;
          |FINSI;
      |FINSI;
   |SINO;
      |SI #dscaz002#4 < Calc;
         |AVISO;
         |MENAV "    Importe sobrepasado";
         |ERROR;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO Cuenta; |TIPO 6;
   Comodin = #dscaz002#0;
   Comodin = Comodin - ".";
   |SI FSalida ! 0;
      Parte = FSalida;
      Parte1 = 100 + (((Parte / 100) ! 0) - 1);
      Parte2 = ((((Parte / 100) ! 0) + 1) * 100) + 99;
      Part1 = #dscaz002#0 % Parte1;
      Part2 = #dscaz002#0 % Parte2;
      |QBF Part2;
      Comodin = Part1 + Part2;
      LongAlfa = Comodin % 0;
      Long = MaxDigit - LongAlfa;
      LongAlfa = "0" * Long;
      Comodin = Part1 + LongAlfa + Part2;
      #dscaz002#0 = Comodin;
      |PINTA #dscaz002#0;
   |FINSI;
   Comodin = #dscaz002#0; |QBF Comodin;
   LongAlfa = Comodin % 0; Long = LongAlfa;
   |SI Long > MaxDigit;
      |MENAV "    Cuenta fuera de nivel";
      |ERROR;
   |FINSI;
|FPRC;

|PROCESO FlagPendte; |TIPO 7
   Calc = (#dscaz002#3 - (#dscaz002#4 - (#dscaz002#5 + #dscaz002#9))) ! 2;
   |SI Calc ! 0;
      |C_M #dscaz002#10,1,"S";
   |SINO;
      |C_M #dscaz002#10,1,"N";
   |FINSI;
|FPRC;

|PROCESO MiraParametros; |TIPO 7;
   nSwLuxe = 0; |HAZ EsLuxe;
   |SI FSalida = 0; nSwLuxe = 1; |FINSI;

   |ABRE #dscam051;
   |LEE 000#dscam051.p;
   |SI FSalida ! 0;
      |DDEFECTO #dscam051;
      |GRABA 020#dscam051.n;
      |LEE 000#dscam051.p;
   |FINSI;
   |CIERRA #dscam051;

   |SI #dscam051#1 = "S";
      |MENSA "    <F2> Acotacion de enlaces por cuenta";
      |SI #dscaz002#11 = "    ";
         #dscaz002#11 = #dscam051#21; |PINTA #dscaz002#11;
      |FINSI;
      Comodin = #dscam051#61;
      |C_M #dscaz002#11,1,Comodin;
   |SINO;
      |BLIN 4;
      #dscaz002#11 = "    ";
      |C_M #dscaz002#11,1,"N";
   |FINSI;

   |SI nSwLuxe ! 0;
      |SI nSwPermite = 0;
         aAlfa = #dscaz002#0; |QBF aAlfa;
         aAlfa = aAlfa % 0103;
         |SI aAlfa = "570";
            #dscaz002#11 = ""; |PINTA #dscaz002#11;
            |C_M #dscaz002#11,1,"N";
         |FINSI;
      |FINSI;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "contagen/def/canempre.mas";
      |CARGA_DEF aAlfa, canempr@;
      |SI FSalida = 0;
         |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "contagen/fich/";
         |PATH_DAT #canempr@#aAlfa#;
         |ABRE #canempr@;

         |DFICB aAlfa; |QBF aAlfa; |PATH_DAT #dscam043#aAlfa#;
         |ABRE #dscam043;
         |SELECT #2#dscam043;
         #dscam043#9 = #48#0;
         |LEE 000#dscam043.];
         |PARA; |SI FSalida = 0; |HACIENDO;
            #canempr@#2 = #dscam043#0;
            #canempr@#3 = #dscam043#1;
            |LEE 000#canempr@.=;
            |SI FSalida = 0;
               nAnyo = #canempr@#26;
               |SI nAnyo > 80;
                  nAnyo = nAnyo + 1900;
               |SINO;
                  nAnyo = nAnyo + 2000;
               |FINSI;
               aAlfa = #dscaz002#1; |QBF aAlfa;
               aAlfa = aAlfa % -104; nCalc = aAlfa;
               |SI nAnyo = nCalc; |Y eaSerie ] #dscam043#7; |Y eaSerie [ #dscam043#8;
                  enSwError   = 0; |SAL;
               |FINSI;
            |FINSI;
            |LEE 000#dscam043.s;
         |SIGUE;
         |CIERRA #canempr@; |DESCARGA_DEF #canempr@;

      |FINSI;
   |FINSI;
|FPRC;

|PROCESO MiraEmpCont;
   |SI nSwLuxe ! 0;
      aAlfa = #dscaz002#0; |QBF aAlfa;
      aAlfa = aAlfa % 0103;
      |SI aAlfa = "570"; #dscaz002#11 = ""; |FINSI;
   |FINSI;
   eaCodEnlace = #dscaz002#11; efFecha = #dscaz002#1;
   |HAZ ComprEmpContable;
|FPRC;

|PROCESO Calculo;
   #dscaz002#4 = #dscaz002#3 + #dscaz002#5 + #dscaz002#9;
   |PINTA #dscaz002#4;
|FPRC;

|PROCESO MiraRetraso;
   nSwPermite = 0;
   |ABRE #dscam051;
   |LEE 000#dscam051.p;
   |SI FSalida ! 0;
      |DDEFECTO #dscam051;
      |GRABA 020#dscam051.n;
      |LEE 000#dscam051.p;
   |FINSI;
   |CIERRA #dscam051;

   nTecla = FSalida;
   |SI #dscaz002#1 < efFechaUlt; |Y #dscam051#93 = "S";
      aAlfa = "    Fecha erronea. Fecha ultimo movimiento del documento : " + efFechaUlt;
      |MENAV aAlfa; |ERROR;
   |FINSI;
   |SI #dscaz002#1 < efFechaDoc; |Y #dscam051#74 = "N";
      aAlfa = "    Fecha erronea. Fecha del documento : " + efFechaDoc;
      |MENAV aAlfa; |ERROR;
   |FINSI;
   |SI nTecla = 2; |ACABA; |FINSI;
   |HAZ EsAgrogenil;
   |SI FSalida = 0;
      enTipoEntrada = 1;
      efFechaVto = #dscaz002#1; |SUB_EJECUTA_NP "dscagm01.tab";
      |SI efFechaVto ! #dscaz002#1; |ERROR; |FINSI;
   |FINSI;

   |HAZ EsLuxe;
   |SI FSalida = 0;
      aAlfa = #dscaz002#0; |QBF aAlfa;
      aAlfa = aAlfa % 0103;
      |SI aAlfa = "570";
         |DBASS aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + "contagen/def/canempre.mas";
         |CARGA_DEF aAlfa, canempr@;
         |SI FSalida = 0;
            |DBASS aAlfa; |QBF aAlfa; aAlfa = aAlfa + "contagen/fich/";
            |PATH_DAT #canempr@#aAlfa#;
            |ABRE #canempr@;

            aDirCont = "";
            |DFICB aAlfa; |QBF aAlfa; |PATH_DAT #dscam043#aAlfa#;
            |ABRE #dscam043;
            |SELECT #2#dscam043;
            #dscam043#9 = #48#0;
            |LEE 000#dscam043.];
            |PARA; |SI FSalida = 0; |HACIENDO;
               #canempr@#2 = #dscam043#0;
               #canempr@#3 = #dscam043#1;
               |LEE 000#canempr@.=;
               |SI FSalida = 0;
                  nAnyo = #canempr@#26;
                  |SI nAnyo > 80;
                     nAnyo = nAnyo + 1900;
                  |SINO;
                     nAnyo = nAnyo + 2000;
                  |FINSI;
                  aAlfa = #dscaz002#1; |QBF aAlfa;
                  aAlfa = aAlfa % -104; nCalc = aAlfa;
                  |SI nAnyo = nCalc; |Y eaSerie ] #dscam043#7; |Y eaSerie [ #dscam043#8;
                     enSwError   = 0;
                     |DBASS eaDirConta; |QBF eaDirConta;
                     eaDirConta = eaDirConta + "contagen/";
                     eaEmpContab = (("00000" + #dscam043#0) % -105) + #dscam043#1;
                     efFecha = #dscaz002#1;
                     |HAZ CompruebaEmpContable;
                     |SI enSwError = -1;
                        |MENAV "    Error. Empresa contable cerrada o inexistente. No se efectuara la operacion";
                        |ERROR;
                     |FINSI;
                     |SI enSwError = -2;
                        |MENAV "    No se encuentra el fichero de asientos de contabilidad.";
                        |ERROR;
                     |FINSI;
                     |SI enSwError = -3;
                        |MENAV "    Error. No se encuentra el fichero de empresas contables. No se efectuara la operacion";
                        |ERROR;
                     |FINSI;
                     |SI enSwError = -4;
                        aAlfa = "    Error. La empresa contable tiene bloqueo con fecha " + efFecha + ". No se efectuara la operacion";
                        |MENAV aAlfa;
                        |ERROR;
                     |FINSI;
                     aDirCont = eaDirConta + "fich/" + eaEmpContab + "/";
                     |SAL;
                  |FINSI;
               |FINSI;
               |LEE 000#dscam043.s;
            |SIGUE;
            |CIERRA #canempr@; |DESCARGA_DEF #canempr@;

            |QBF aDirCont;
            |SI aDirCont ! "";
               |DBASS aAlfa; |QBF aAlfa;
               aAlfa = aAlfa + "contagen/def/cajainca.mas";
               |CARGA_DEF aAlfa, cajainc@;
               |SI FSalida = 0;
                  |DBASS aAlfa; |QBF aAlfa;
                  aAlfa = aAlfa + "contagen/def/camaasil.mas";
                  |CARGA_DEF aAlfa, camasil@;

                  |PATH_DAT #cajainc@#aDirCont#; |PATH_DAT #camasil@#aDirCont#;

                  |ABRE #cajainc@; |ABRE #camasil@;
                  #cajainc@#1 = #dscaz002#1;
                  |LEE 000#cajainc@.=;
                  |SI FSalida ! 0;
                     aAlfa = "SELECT * FROM camaasil INTO pp" + Usuario + " WHERE 1 == " + #dscaz002#1 + " AND 4 = '" + #dscaz002#0 + "'";
                     |SQL aAlfa;
                     |SI FSalida = 0;
                        aAlfa = FSalida; |QBF aAlfa;
                        aAlfa = aAlfa % 0399;
                        aAlfa = aAlfa - "Seleccionados:"; nCalc = aAlfa;
                        |SI nCalc ! 0;
                           fFecha = ~;
                           |SI fFecha ! #dscaz002#1; nSwPermite = 1; |FINSI;
                        |FINSI;
                     |FINSI;
                  |FINSI;
                  |CIERRA #camasil@; |DESCARGA_DEF #camasil@;
                  |CIERRA #cajainc@; |DESCARGA_DEF #cajainc@;
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO CompruebaEnl;
   |HAZ EsLuxe;
   |SI FSalida = 0;
      aAlfa = #dscaz002#0; |QBF aAlfa;
      aAlfa = aAlfa % 0103;
      |SI aAlfa = "570";
         #dscaz002#11 = ""; |PINTA #dscaz002#11;
         |C_M #dscaz002#11,1,"N";
      |SINO;
         #dscaz002#11 = #dscaz001#30; |PINTA #dscaz002#11;
         |C_M #dscaz002#11,1,"S";
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO ConsultaCuenta; |TIPO 66;
     |SI HayConta = 0; |ACABA; |FINSI;
     |HAZ Cuenta;

     #cacuent@#0 = #dscaz002#0;
     |LEE 000#cacuent@.];

     |CONSULTA_CLAVE #1#cacuent@;
     |SI FSalida = 0;
           #dscaz002#0 = #cacuent@#0; |PINTA #dscaz002#0;
     |SINO;
          |ERROR;
     |FINSI;
|FPRC;
