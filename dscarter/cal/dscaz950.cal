|FICHEROS;
   dscaz950 #0;
   dscaw950 #1,MANTE;
   dscaw951 #2,MANTE;

   dscam003 #10;
   dscam004 #11;
   dscam012 #12;
   dscam013 #13;
   dscam051 #14;
   dscaw062 #15;
   dscam067 #16;
   dscam058 #17;
   dscam158 #18;

   dscam037 #26;
   dscam038 #27;
   dscam042 #28;
   dscam043 #29;
   dscam044 #30;
   dscam045 #31;
   dscam049 #32;
   dscam050 #33;
   dscam065 #34;
   dscam075 #35;

   dscam081 #50;
   dscam082 #51;

   dscam03@ #100;
   dscam04@ #101;
   dscam12@ #102;
   dscam13@ #103;
   dscam51@ #104;
   dscam14@ #105;
   dscam37@ #106;
   dscam38@ #107;
   dscam42@ #108;
   dscam43@ #109;
   dscam44@ #110;
   dscam45@ #111;
   dscam49@ #112;
   dscam50@ #113;
   dscam65@ #114;

   agifa091@ #1000;
|FIN;

|VARIABLES;
   nCont   = 0;
   nNumLin = 0;
   nCalc   = 0;
   nCalc1  = 0;
   nCalc2  = 0;
   nCodigo = 0;
   nSw     = 0;
   nSwError = 0;
   nEmprCar = 0;

   aOrigen = "";
   aDestino = "";
   aDesc   = "";
   aPrepar = "";
   aEstado = "";
   aAlfa   = "";
   aAlfa1  = "";
   aAlfa2  = "";
   aAlfa3  = "";
   aUltMov = "";
   aPathCartera4 = "";
   aInforme = "";
   aIP      = "";

   aClv1    = "";
   aClv2    = "";
   aClv3    = "";
   aClv4    = "";

   nHandle    = 0;
   nNumRemesa = 0;
   nNumDias   = 0;
   nNumDocum  = 0;
   nPorcInt   = 0;
   nInteres   = 0;
   nLinRemesa = 0;
   nTotRemesa = 0;
   nSwErr     = 0;
|FIN;

|PROCESO RectificaHistEnl;
   |SI #dscam004#5 ! "REM"; |Y #dscam004#5 ! "EMR"; |Y #dscam004#5 ! "REC";
      |ABRE #dscam067; |DDEFECTO #dscam067;
      aClv1 = "CB";
      aClv2 = #dscam004#17; aClv2 = (aClv2 + (" " * 50))% 0150;
      aClv3 = 99;           aClv3 = (aClv3 + (" " * 50))% 0150;
      #dscam067#0 = aClv1;
      #dscam067#1 = aClv2;
      #dscam067#2 = aClv3;
      |LEE 000#dscam067.];
      |SI FSalida = 0;
         |SI #dscam067#0 ! aClv1; |O #dscam067#1 ! aClv2;
            |LEE 000#dscam067.a;
            |SI FSalida = 0;
               |SI #dscam067#0 = aClv1; |Y #dscam067#1 = aClv2;
                  aClv3 = #dscam067#2;
               |FINSI;
            |FINSI;
         |FINSI;
      |SINO;
         |LEE 000#dscam067.u;
         |SI FSalida = 0;
            |SI #dscam067#0 = aClv1; |Y #dscam067#1 = aClv2;
               aClv3 = #dscam067#2;
            |FINSI;
         |FINSI;
      |FINSI;

      aAlfa = aClv3; |QBF aAlfa;
      |SI aAlfa = 99;
         |CIERRA #dscam067; |ACABA;
      |FINSI;

      aClv1 = "CB";
      aClv2 = #dscam004#17; aClv2 = (aClv2 + (" " * 50))% 0150;
      aClv4 = (aClv4 + (" " * 50))% 0150;
      #dscam067#0 = aClv1;
      #dscam067#1 = aClv2;
      #dscam067#2 = aClv3; nCalc = aClv3;
      #dscam067#3 = aClv4;
      |LEE 000#dscam067.];
      |PARA; |SI FSalida = 0; |Y #dscam067#0 = aClv1; |Y #dscam067#1 = aClv2; |Y nCalc > nNumLin; |HACIENDO;
         |BORRA 020#dscam067.a;

         nCalc = #dscam067#2; nCalc = nCalc + 1; #dscam067#2 = nCalc;
         |GRABA 020#dscam067.c;

         |LEE 000#dscam067.a; nCalc = #dscam067#2;
      |SIGUE;
      |CIERRA #dscam067;
   |FINSI;
|FPRC;

|PROCESO UltMov;
   |SI #dscam04@#5 = "REM"; nSwErr = 1; |FINSI;
|FPRC;

|DEFBUCLE UltMov;
#dscam04@#1002;
;
#dscam03@#40, nNumLin;
#dscam03@#40, 99;
;
NULL,UltMov;
|FIN;

|PROCESO ComprTotal;
   nTotRemesa = nTotRemesa + #dscam03@#30;
|FPRC;

|DEFBUCLE ComprTotal;
#dscam03@#1001;
17;
0000000001,nNumRemesa;
9999999999,nNumRemesa;
;
NULL,ComprTotal;
|FIN;

|PROCESO RecRemesa;

|| Primero compruebo que es el ultimo movimiento REM que hay en el recibo.
||   Si no es asi, salgo para que llame al proceso el ultimo movimiento de
||   remesa del recibo, puesto que por el resto no puedo hacer mas ....

   |SALVA_FICHA #dscam03@; |SALVA_FICHA #dscam04@;
   |SALVA_FICHA #dscam12@;

   nSwErr = 0; |BUCLE UltMov;

   |SI nSwErr ! 0;
      |REPON_FICHA #dscam12@;
      |REPON_FICHA #dscam04@; |REPON_FICHA #dscam03@;
      |ACABA;
   |FINSI;

|| Primero hago una pasada por los recibos que tienen esa remesa marcada
   #dscam12@#0 = nNumRemesa;
   |LEE 000#dscam12@.=;
   |SI FSalida ! 0; |DDEFECTO #dscam12@; |FINSI;

   nNumDocum = #dscam03@#40;
   nTotRemesa = 0; |BUCLE ComprTotal;

|| Compruebo que el total de la remesa coincide con la suma de los recibos
||     marcados como parte de esa remesa. Si coinciden, se graban y nada mas.
   |SI nTotRemesa = #dscam12@#10;
      #dscam03@#40 = nNumDocum;
      |LEE 000#dscam03@.=;
      |SI FSalida ! 0; |DDEFECTO #dscam003; |FINSI;

      |DDEFECTO #dscam13@;
      #dscam13@#0  = nNumRemesa;
      #dscam13@#1  = nLinRemesa;
      #dscam13@#2  = #dscam03@#27;
      #dscam13@#3  = #dscam03@#0;
      #dscam13@#4  = #dscam03@#1;
      #dscam13@#5  = #dscam03@#2;
      #dscam13@#6  = #dscam03@#3;
      #dscam13@#7  = #dscam03@#30;

      nCalc1 = #dscam12@#1; nCalc2 = #dscam03@#3;
      nNumDias = nCalc2 - nCalc1;
      |SI nNumDias < 0;
         nNumDias = 0;
         #dscam13@#12 = "S";
         nInteres = 0;
         nPorcInt = 0;
      |SINO;
         #dscam13@#12 = "N";
         |SI #dscam14@#28 ! 0; |O #dscam14@#29 ! 0; |O #dscam14@#30 ! 0; |O #dscam14@#31 ! 0;
            |SI nNumDias ] #dscam14@#20; |Y nNumDias [ #dscam14@#24;
               nInteres = ((#dscam13@#7 * #dscam14@#28) / 36000) * nNumDias;
               nPorcInt = #dscam14@#28;
            |FINSI;
            |SI nNumDias ] #dscam14@#21; |Y nNumDias [ #dscam14@#25;
               nInteres = ((#dscam13@#7 * #dscam14@#29) / 36000) * nNumDias;
               nPorcInt = #dscam14@#29;
            |FINSI;
            |SI nNumDias ] #dscam14@#22; |Y nNumDias [ #dscam14@#26;
               nInteres = ((#dscam13@#7 * #dscam14@#30) / 36000) * nNumDias;
               nPorcInt = #dscam14@#30;
            |FINSI;
            |SI nNumDias ] #dscam14@#23; |Y nNumDias [ #dscam14@#27;
               nInteres = ((#dscam13@#7 * #dscam14@#31) / 36000) * nNumDias;
               nPorcInt = #dscam14@#31;
            |FINSI;
         |SINO;
            |SI #dscam14@#32 ! 0;
               nInteres = (#dscam13@#7 % #dscam14@#32) * nNumDias ;
               nPorcInt = #dscam14@#32;
            |SINO;
               nInteres = ((#dscam13@#7 * #dscam14@#17)/36000) * nNumDias;
               nPorcInt = #dscam14@#17;
            |FINSI;
         |FINSI;
      |FINSI;
      #dscam13@#8  = nNumDias;
      |SI #dscam12@#22 = 2; |O #dscam12@#22 = 4;
         #dscam13@#9  = nPorcInt;
         #dscam13@#10 = nInteres;
      |SINO;
         #dscam13@#9  = 0;
         #dscam13@#10 = 0;
      |FINSI;
      nSwErr = 0;
      #dscam13@#11 = #dscam03@#5;
      #dscam13@#13 = #dscam03@#6;
      #dscam13@#16 = #dscam03@#40;
      #dscam13@#17 = #dscam04@#3;
      #dscam13@#22 = #dscam13@#7;
      |REPON_FICHA #dscam12@;
      |REPON_FICHA #dscam04@; |REPON_FICHA #dscam03@;
      |ACABA;
   |FINSI;

|| Si no coinciden , se debe ir uno por uno mirando los que tienen movimientos
||     "REM"
|| Si con esto no coinciden, poco mas se puede hacer.
   |REPON_FICHA #dscam12@;
   |REPON_FICHA #dscam04@; |REPON_FICHA #dscam03@;
|FPRC;

|PROCESO AdaptaRVL;
   aUltMov = #dscam04@#5;

   |SI #dscam04@#5 = "REM";
      || Primero miro el estado de la remesa correspondiente
      |ABRE #dscam12@;
      |ABRE #dscam13@; |SELECT #2#dscam13@;

      #dscam13@#16 = #dscam04@#17;
      #dscam13@#17 = #dscam04@#3;
      |LEE 000#dscam13@.=;
      |SI FSalida ! 0;
         nNumRemesa = #dscam03@#17;
         nLinRemesa = #dscam03@#37;
         nSwErr = 0; nNumLin = #dscam04@#3 + 1;
         |DDEFECTO #dscam13@; |HAZ RecRemesa;
      |FINSI;

      |SI #dscam13@#0 ! 0;
         |DDEFECTO #dscam013;
         |PARA nCont = 0; |SI nCont [ 38; |HACIENDO nCont = nCont + 1;
            #dscam013#nCont# = #dscam13@#nCont#;
         |SIGUE;
         |GRABA 020#dscam013.c;
      |FINSI;

      #dscam12@#0 = #dscam13@#0;
      |LEE 000#dscam12@.=;
      |SI FSalida ! 0; |CIERRA #dscam13@; |ACABA; |FINSI;

      #dscam012#0 = #dscam12@#0;
      |LEE 000#dscam012.=;
      |SI FSalida ! 0;
         |DDEFECTO #dscam012;
         |PARA nCont = 0; |SI nCont [ 22; |HACIENDO nCont = nCont + 1;
            #dscam012#nCont# = #dscam12@#nCont#;
         |SIGUE;
         #dscam012#23 = #dscam012#8; #dscam012#8 = "N";
         |GRABA 020#dscam012.c;
      |FINSI;

      || Si es una remesa de recibos, se a¤adira el movimiento PRE
      || OJO .... Si a¤adimos movimientos hay que rectificar el historico de
      ||    enlaces que pueda haber para indicar la nueva linea del asiento ...
      |SI #dscam12@#22 = 1; |O #dscam12@#22 = 2;
         nNumLin = 1;
         #dscam004#17 = #dscam04@#17;
         #dscam004#3  = 1;
         |LEE 000#dscam004.];
         |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam04@#17; |HACIENDO;
            nNumLin = #dscam004#3 + 1;
            |LEE 000#dscam004.s;
         |SIGUE;

         |HAZ RectificaHistEnl;

         |DDEFECTO #dscam004;
         #dscam004#17 = #dscam04@#17;
         #dscam004#3  = nNumLin;
         #dscam004#0  = #dscam04@#0;
         #dscam004#1  = #dscam04@#1;
         #dscam004#2  = #dscam04@#2;
         #dscam004#5  = "PRE";
         #dscam004#6  = #dscam04@#6;
         #dscam004#15 = #dscam04@#15;
         |GRABA 020#dscam004.n;
         #dscam003#90 = "S";
      |FINSI;

      || En primer lugar, si la remesa ha sido emitida hay que
      ||    reemplazar el movimiento REM por el EMR, y el recibo
      ||    pasaria de estar liquidado a estar pendiente. La remesa se
      ||    marca como emitida.
      |SI #dscam12@#8 = "S"; |O #dscam12@#9 = "S";
         nNumLin = 1;
         #dscam004#17 = #dscam04@#17;
         #dscam004#3  = 1;
         |LEE 000#dscam004.];
         |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam04@#17; |HACIENDO;

            nNumLin = #dscam004#3 + 1;
            |LEE 000#dscam004.s;
         |SIGUE;

         |HAZ RectificaHistEnl;

         |DDEFECTO #dscam004;
         #dscam004#17 = #dscam04@#17;
         #dscam004#3  = nNumLin;
         #dscam004#0  = #dscam04@#0;
         #dscam004#1  = #dscam04@#1;
         #dscam004#2  = #dscam04@#2;
         #dscam004#5  = "EMR";
         #dscam004#6  = #dscam04@#6;
         #dscam004#15 = #dscam04@#15;
         |GRABA 020#dscam004.n;

         #dscam013#24 = nNumLin; |GRABA 020#dscam013.a;
         aEstado = "P";
      |FINSI;

      || Si la remesa es al descuento y estaba emitida, se a¤adiria
      ||    el movimiento REM y volveria a estar liquidado. Se marcaria
      ||    la remesa como abonada
      || OJO .... Si a¤adimos movimientos hay que rectificar el historico de
      ||    enlaces que pueda haber para indicar la nueva linea del asiento ...
      |SI #dscam12@#22 = 2; |O #dscam12@#22 = 4;
         |SI #dscam12@#8 = "S"; |O #dscam12@#9 = "S";
            nNumLin = 1;
            #dscam004#17 = #dscam04@#17;
            #dscam004#3  = 1;
            |LEE 000#dscam004.];
            |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam04@#17; |HACIENDO;
               nNumLin = #dscam004#3 + 1;
               |LEE 000#dscam004.s;
            |SIGUE;

            |DDEFECTO #dscam004;
            |PARA nCont = 0; |SI nCont [ 47; |HACIENDO nCont = nCont + 1;
               #dscam004#nCont# = #dscam04@#nCont#;
            |SIGUE;
            #dscam004#3  = nNumLin;
            |GRABA 020#dscam004.c;

            || Cambio las notas del movimiento de clave
            |DDEFECTO #dscam075;
            #dscam075#14 = "V";
            #dscam075#12 = #dscam004#17;
            #dscam075#13 = #dscam04@#3;
            |LEE 000#dscam075.];
            |PARA; |SI FSalida = 0; |Y #dscam075#14 = "V"; |Y #dscam075#12 = #dscam004#17;
            |Y #dscam075#13 = #dscam04@#3; |HACIENDO;
               |BORRA 020#dscam075.a;

               #dscam075#13 = nNumLin;
               |GRABA 020#dscam075.n;
            |SIGUE;

            #dscam013#17 = nNumLin; |GRABA 020#dscam013.a;
            #dscam012#8  = "S"; |GRABA 020#dscam012.a;

            aEstado = "L";
         |FINSI;
      |FINSI;
      || Si la remesa es al cobro, habria que mirar si el recibo ha
      ||    sido rebajado del riesgo. Si no es asi , se rebaja y se
      ||    pone el recibo como liquidado. Se marcaria la remesa
      ||    como abonada.
      |SI #dscam12@#22 = 1; |O #dscam12@#22 = 3;
         nNumLin = 1;
         #dscam004#17 = #dscam04@#17;
         #dscam004#3  = 1;
         |LEE 000#dscam004.];
         |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam04@#17; |HACIENDO;
            nNumLin = #dscam004#3 + 1;
            |LEE 000#dscam004.s;
         |SIGUE;

         |DDEFECTO #dscam004;
         |PARA nCont = 0; |SI nCont [ 47; |HACIENDO nCont = nCont + 1;
            #dscam004#nCont# = #dscam04@#nCont#;
         |SIGUE;
         #dscam004#3  = nNumLin;
         |GRABA 020#dscam004.c;

         || Cambio las notas del movimiento de clave
         |DDEFECTO #dscam075;
         #dscam075#14 = "V";
         #dscam075#12 = #dscam004#17;
         #dscam075#13 = #dscam04@#3;
         |LEE 000#dscam075.];
         |PARA; |SI FSalida = 0; |Y #dscam075#14 = "V"; |Y #dscam075#12 = #dscam004#17;
         |Y #dscam075#13 = #dscam04@#3; |HACIENDO;
            |BORRA 020#dscam075.a;

            #dscam075#13 = nNumLin;
            |GRABA 020#dscam075.n;
         |SIGUE;

         |SI #dscam13@#15 ! "S"; #dscam013#15 = "S"; |FINSI;
         #dscam013#17 = nNumLin; |GRABA 020#dscam013.a;
         #dscam012#8  = "S"; |GRABA 020#dscam012.a;

         aEstado = "L";
      |FINSI;
      || En todo caso el recibo se marcara como preparado
      aPrepar = "S"; |ACABA;
   |FINSI;

   |SI #dscam04@#5 = "RCE";
      || Se insertaria un movimiento PRC anterior a este
      nNumLin = 1;
      #dscam004#17 = #dscam04@#17;
      #dscam004#3  = 1;
      |LEE 000#dscam004.];
      |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam04@#17; |HACIENDO;
         nNumLin = #dscam004#3 + 1;
         |LEE 000#dscam004.s;
      |SIGUE;

      |DDEFECTO #dscam004;
      #dscam004#17 = #dscam04@#17;
      #dscam004#15 = #dscam04@#15;
      #dscam004#0  = #dscam04@#0;
      #dscam004#1  = #dscam04@#1;
      #dscam004#2  = #dscam04@#2;
      #dscam004#3  = nNumLin;
      #dscam004#4  = #dscam04@#4;
      #dscam004#5  = "PRC";
      #dscam004#6  = #dscam04@#6;
      #dscam004#7  = #dscam03@#23;
      #dscam004#25 = #dscam03@#61;
      |GRABA 020#dscam004.n;

      nNumLin = 1;
      #dscam004#17 = #dscam04@#17;
      #dscam004#3  = 1;
      |LEE 000#dscam004.];
      |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam04@#17; |HACIENDO;
         nNumLin = #dscam004#3 + 1;
         |LEE 000#dscam004.s;
      |SIGUE;

      |DDEFECTO #dscam004;
      |PARA nCont = 0; |SI nCont [ 47; |HACIENDO nCont = nCont + 1;
         #dscam004#nCont# = #dscam04@#nCont#;
      |SIGUE;
      #dscam004#3  = nNumLin;
      |GRABA 020#dscam004.n;

      |DDEFECTO #dscam067;
      #dscam067#0 = "CB";
      #dscam067#1 = #dscam04@#17;
      #dscam067#2 = #dscam04@#3;
      |LEE 000#dscam067.=;
      |SI FSalida = 0;
         |BORRA 020#dscam067.a;
         #dscam067#2 = nNumLin;
         |GRABA 020#dscam067.n;
      |FINSI;
   |FINSI;

   |SI #dscam04@#5 ! "REM"; |Y #dscam04@#5 ! "RCE";
      nNumLin = 1;
      #dscam004#17 = #dscam04@#17;
      #dscam004#3  = 1;
      |LEE 000#dscam004.];
      |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam04@#17; |HACIENDO;
         nNumLin = #dscam004#3 + 1;
         |LEE 000#dscam004.s;
      |SIGUE;

      |DDEFECTO #dscam004;
      |PARA nCont = 0; |SI nCont [ 47; |HACIENDO nCont = nCont + 1;
         #dscam004#nCont# = #dscam04@#nCont#;
      |SIGUE;
      #dscam004#3  = nNumLin;
      |GRABA 020#dscam004.n;
   |FINSI;
|FPRC;

|DEFBUCLE AdaptaRVL;
#dscam04@#1002;
;
#dscam03@#40, 01;
#dscam03@#40, 99;
;
NULL,AdaptaRVL;
|FIN;

|PROCESO AdaptaRV;
   #dscaw950#0 = #dscam03@#12;
   |LEE 000#dscaw950.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscaw950;
      #dscaw950#0 = #dscam03@#12;
      #dscam058#0 = #dscam03@#12;
      |LEE 000#dscam058.=;
      |SI FSalida ! 0; |DDEFECTO #dscam058; |FINSI;
      #dscaw950#1 = #dscam058#1;
      |GRABA 020#dscaw950.n;
   |FINSI;

   aEstado = ""; aPrepar = ""; aUltMov = "";
   |BUCLE AdaptaRVL;

   |PARA nCont = 0; |SI nCont [ 89; |HACIENDO nCont = nCont + 1;
      #dscam003#nCont# = #dscam03@#nCont#;
   |SIGUE;
   #dscam003#99 = #dscam03@#90;

   |SI aUltMov = "REM";
      |SI aEstado = "L";
         #dscam003#14 = "L";
         #dscam003#15 = "Recibo liquidado";
         #dscam003#31 = 0;
         #dscam003#23 = #dscam003#30;
      |FINSI;
      |SI aEstado = "P";
         #dscam003#14 = "R";
         #dscam003#15 = "Remesado";
         #dscam003#31 = #dscam003#30;
         #dscam003#23 = 0;
      |FINSI;
      #dscam003#90 = aPrepar;
   |SINO;
      #dscam003#90 = "N";
      |SI #dscam003#14 = "L"; #dscam003#90 = "S"; |FINSI;
      |SI #dscam003#14 = "T"; #dscam003#90 = "S"; |FINSI;
   |FINSI;
   |GRABA 020#dscam003.n;
|FPRC;

|DEFBUCLE AdaptaRV;
#dscam03@#1001;
;
0000000001;
9999999999;
;
NULL,AdaptaRV;
|FIN;

|PROCESO AdaptaConf;
   #dscam050#0 = #dscam049#0;
   #dscam050#1 = 1;
   |LEE 000#dscam050.];
   |SI FSalida = 0; |Y #dscam050#0 = #dscam049#0;
      #dscam049#23 = #dscam050#16;
      |GRABA 020#dscam049.a; |LIBERA #dscam049;
   |FINSI;
|FPRC;

|DEFBUCLE AdaptaConf;
#dscam049#1;
;
INICIO;
FINAL;
be;
NULL, AdaptaConf;
|FIN;

|PROCESO Adaptacion;
   |LEE 000#dscam51@.p;
   |SI FSalida ! 0;
      |DDEFECTO #dscam51@;
   |FINSI;

   |PARA nCont = 0; |SI nCont [ 46; |HACIENDO nCont = nCont + 1;
      #dscam051#nCont# = #dscam51@#nCont#;
   |SIGUE;
   |PARA nCont = 78; |SI nCont [ 95; |HACIENDO nCont = nCont + 1;
      nCalc = nCont - 24;
      #dscam051#nCont# = #dscam51@#nCalc#;
   |SIGUE;
   #dscam051#53 = #dscam051#24;
   #dscam051#24 = "";
   #dscam051#64 = #dscam51@#47;
   #dscam051#68 = #dscam51@#48;
   #dscam051#71 = #dscam51@#50;
   #dscam051#72 = #dscam51@#51;
   #dscam051#73 = #dscam51@#52;
   #dscam051#74 = #dscam51@#53;
   |GRABA 020#dscam051.n;

   |BUCLE AdaptaRV;

   |ABRE #dscam049;   |ABRE #dscam050;
   |BUCLE AdaptaConf;
   |CIERRA #dscam049; |CIERRA #dscam050;
|FPRC;

|RUTINA inf950;
   #dscaw950#0 = 1;
|FRUT;

|RUTINA sup950;
   #dscaw950#0 = 99;
|FRUT;

|PROCESO GrabaClas;
      |SI #dscaw950#2 = "C"; nCodigo = 1; aDesc = "CLASIFICACION CONTADO   "; |FINSI;
      |SI #dscaw950#2 = "R"; nCodigo = 2; aDesc = "CLASIFICACION REMESABLE "; |FINSI;
      |SI #dscaw950#2 = "P"; nCodigo = 3; aDesc = "CLASIFICACION PAGARE    "; |FINSI;
      |SI #dscaw950#2 = "A"; nCodigo = 4; aDesc = "CLASIFICACION A ACEPTAR "; |FINSI;
      |SI #dscaw950#2 = "O"; nCodigo = 5; aDesc = "CLASIFICACION CONFIRMING"; |FINSI;
      #dscam081#0 = nCodigo;
      |LEE 000#dscam081.=;
      |SI FSalida ! 0;
         |DDEFECTO #dscam081;
         #dscam081#0 = nCodigo;
         #dscam081#1 = aDesc;
         #dscam081#2 = #dscaw950#2;
         |GRABA 020#dscam081.n;
      |SINO;
         |SI #dscaw950#0 = 0; |ACABA; |FINSI;
      |FINSI;
      #dscam082#0 = nCodigo;
      #dscam082#1 = #dscaw950#0;
      |LEE 000#dscam082.=;
      |SI FSalida ! 0;
         |DDEFECTO #dscam082;
         #dscam082#0 = nCodigo;
         #dscam082#1 = #dscaw950#0;
         #dscam082#2 = #dscaw950#1;
         |GRABA 020#dscam082.n;
      |FINSI;
|FPRC;

|PROCESO Clasif;
   |SI nSw = 1;
      |SI #dscaw950#2 = " ";
         nSwError = 1; |ERROR10;
      |FINSI;
   |SINO;
      |HAZ GrabaClas;
   |FINSI;
|FPRC;

|DEFBUCLE Clasif;
   #dscaw950#1;
   ;
   INICIO;
   FINAL;
   ;
   NULL,Clasif;
|FIN;

|PROCESO PintaTipo;
   |SI #dscaw950#2 = "C"; #dscaw950#3 = "Contado   "; |FINSI;
   |SI #dscaw950#2 = "R"; #dscaw950#3 = "Remesable "; |FINSI;
   |SI #dscaw950#2 = "P"; #dscaw950#3 = "Pagare    "; |FINSI;
   |SI #dscaw950#2 = "A"; #dscaw950#3 = "A aceptar "; |FINSI;
   |SI #dscaw950#2 = "O"; #dscaw950#3 = "Confirming"; |FINSI;
   |PINTA #dscaw950#3;
|FPRC;

|PROCESO ControlAlta;
   nCalc = (FEntrada / 100) ! 0;
   |SI nCalc = 1;
      |ABRE #dscam058;
      #dscam058#0 = #dscaw950#0;
      |LEE 000#dscam058.=;
      |SI FSalida = 0;
         #dscaw950#1 = #dscam058#1;
      |SINO;
         aAlfa = "dscam158.tab;" + #dscaw950#0;
         |SUB_EJECUTA aAlfa;
         #dscam058#0 = #dscaw950#0;
         |LEE 000#dscam058.=;
         |SI FSalida = 0; #dscaw950#1 = #dscam058#1; |FINSI;
      |FINSI;
      |CIERRA #dscam058;
   |FINSI;
|FPRC;

|PROCESO FormaPago;
   #dscaw951#0 = #dscam044#0;
   #dscaw951#1 = #agifa091@#0;
   |LEE 000#dscaw951.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscaw951;
      #dscaw951#0 = #dscam044#0;
      #dscaw951#1 = #agifa091@#0;
      #dscaw951#2 = #agifa091@#1;
      #dscaw951#3 = #agifa091@#69;
      #dscam058#0 = #agifa091@#69;
      |LEE 000#dscam058.=;
      |SI FSalida ! 0; |DDEFECTO #dscam058; |FINSI;
      #dscaw951#4 = #dscam058#1;
      #dscaw951#5 = #dscam044#2;
      #dscaw951#6 = #dscam044#1;
      |GRABA 020#dscaw951.n;
   |FINSI;
|FPRC;

|DEFBUCLE FormaPago;
#agifa091@#1001;
;
"  ";
"zz";
;
NULL,FormaPago;
|FIN;

|PROCESO Control;
   #dscam044#0 = #dscam045#0;
   |LEE 000#dscam044.=;
   |SI FSalida ! 0; |DDEFECTO #dscam044; |FINSI;

   aAlfa = #dscam044#1; |QBF aAlfa;
   aAlfa = aAlfa + "def/agifa091.mas";
   |CARGA_DEF aAlfa, agifa091@;
   |SI FSalida = 0;
      aAlfa = #dscam044#1; |QBF aAlfa;
      aAlfa = aAlfa + "fich/" + (("00000" + #dscam044#0) % -105) + "/";

      |PATH_DAT #1000 aAlfa;
      |ABRE #agifa091@;
      |BUCLE FormaPago;
      |CIERRA #agifa091@; |DESCARGA_DEF #agifa091@;
   |FINSI;
|FPRC;

|DEFBUCLE Control;
#dscam045#2;
;
nEmprCar;
nEmprCar;
;
NULL,Control;
|FIN;

|RUTINA inf951;
   #dscaw951#0 = 1;
   #dscaw951#1 = "  ";
|FRUT;

|RUTINA sup951;
   #dscaw951#0 = 99999;
   #dscaw951#1 = "zz";
|FRUT;

|PROCESO Volcado;
   aAlfa = #dscaw951#6; |QBF aAlfa;
   aAlfa = aAlfa + "def/agifa091.mas";
   |CARGA_DEF aAlfa, agifa091@;
   |SI FSalida = 0;
      aAlfa = #dscaw951#6; |QBF aAlfa;
      aAlfa = aAlfa + "fich/" + (("00000" + #dscaw951#0) % -105) + "/";

      |PATH_DAT #1000 aAlfa;
      |ABRE #agifa091@;
      #agifa091@#0 = #dscaw951#1;
      |LEE 101#agifa091@.=;
      |SI FSalida = 0;
         #agifa091@#69 = #dscaw951#3;
         |GRABA 020#agifa091@.a; |LIBERA #agifa091@;
      |FINSI;
      |CIERRA #agifa091@; |DESCARGA_DEF #agifa091@;
   |FINSI;
|FPRC;

|DEFBUCLE Volcado;
#dscaw951#1;
;
INICIO;
FINAL;
;
NULL,Volcado;
|FIN;

|PROCESO dscam38;
   aAlfa = "|NC"; aAlfa = #dscam038#aAlfa#; nCalc = aAlfa; nCalc = nCalc - 1;
   |DDEFECTO #dscam038;
   |PARA nCont = 0; |SI nCont [nCalc; |HACIENDO nCont = nCont + 1;
      #dscam038#nCont# = #dscam38@#nCont#;
   |SIGUE;
   |GRABA 020#dscam038.n;
|FPRC;

|DEFBUCLE dscam38;
#dscam38@#1002;
;
#dscam37@#0, 001;
#dscam37@#0, 999;
;
NULL,dscam38;
|FIN;

|PROCESO dscam37;
   |BUCLE dscam38;
   aAlfa = "|NC"; aAlfa = #dscam037#aAlfa#; nCalc = aAlfa; nCalc = nCalc - 1;
   |DDEFECTO #dscam037;
   |PARA nCont = 0; |SI nCont [nCalc; |HACIENDO nCont = nCont + 1;
      #dscam037#nCont# = #dscam37@#nCont#;
   |SIGUE;
   |GRABA 020#dscam037.n;
|FPRC;

|DEFBUCLE dscam037;
#dscam37@#1001;
;
00000;
99999;
;
NULL,dscam37;
|FIN;

|PROCESO dscam43;
   aAlfa = "|NC"; aAlfa = #dscam043#aAlfa#; nCalc = aAlfa; nCalc = nCalc - 1;
   |DDEFECTO #dscam043;
   |PARA nCont = 0; |SI nCont [nCalc; |HACIENDO nCont = nCont + 1;
      #dscam043#nCont# = #dscam43@#nCont#;
   |SIGUE;
   |GRABA 020#dscam043.n;
|FPRC;

|DEFBUCLE dscam43;
#dscam43@#1003;
;
#dscam42@#0, #dscam42@#1, 001;
#dscam42@#0, #dscam42@#1, 999;
;
NULL,dscam43;
|FIN;

|PROCESO dscam42;
   |BUCLE dscam43;
   aAlfa = "|NC"; aAlfa = #dscam042#aAlfa#; nCalc = aAlfa; nCalc = nCalc - 1;
   |DDEFECTO #dscam042;
   |PARA nCont = 0; |SI nCont [nCalc; |HACIENDO nCont = nCont + 1;
      #dscam042#nCont# = #dscam42@#nCont#;
   |SIGUE;
   |GRABA 020#dscam042.n;
|FPRC;

|DEFBUCLE dscam042;
#dscam42@#1002;
;
00000, 0;
99999, 9;
;
NULL,dscam42;
|FIN;

|PROCESO dscam45;
   aAlfa = "|NC"; aAlfa = #dscam045#aAlfa#; nCalc = aAlfa; nCalc = nCalc - 1;
   |DDEFECTO #dscam045;
   |PARA nCont = 0; |SI nCont [nCalc; |HACIENDO nCont = nCont + 1;
      #dscam045#nCont# = #dscam45@#nCont#;
   |SIGUE;
   |GRABA 020#dscam045.n;
|FPRC;

|DEFBUCLE dscam45;
#dscam45@#1002;
;
#dscam45@#0, 001;
#dscam45@#0, 999;
;
NULL,dscam45;
|FIN;

|PROCESO dscam44;
   |BUCLE dscam45;
   aAlfa = "|NC"; aAlfa = #dscam044#aAlfa#; nCalc = aAlfa; nCalc = nCalc - 1;
   |DDEFECTO #dscam044;
   |PARA nCont = 0; |SI nCont [nCalc; |HACIENDO nCont = nCont + 1;
      #dscam044#nCont# = #dscam44@#nCont#;
   |SIGUE;
   |GRABA 020#dscam044.n;
|FPRC;

|DEFBUCLE dscam044;
#dscam44@#1001;
;
00000;
99999;
;
NULL,dscam44;
|FIN;

|PROCESO CopiaFichero;
   aAlfa = aPathCartera4 + "def/"; |QBF aAlfa;
   aAlfa = aAlfa + aInforme; |QBF aAlfa;
   |XABRE "E", aAlfa, nHandle;
   |SI FSalida ] 0; || No se encuentra el informe
      |DDEF aDestino; |QBF aDestino;
      aDestino = aDestino + aInforme; |QBF aDestino;
      aOrigen = aPathCartera4 + "def/" + aInforme; |QBF aOrigen;
      |COPIA_FICHERO aOrigen, aDestino;
   |FINSI;
|FPRC;

|PROCESO PasaInformes;
   #dscam065#0 = #dscam65@#0;
   |LEE 000#dscam065.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscam065;
      #dscam065#0 = #dscam65@#0;
      #dscam065#1 = #dscam65@#1;
      |GRABA 020#dscam065.c;
   |SINO;
      |SI #dscam065#1 ! #dscam65@#1;
         #dscam065#1 = #dscam65@#1;
         |GRABA 020#dscam065.a;
      |FINSI;
   |FINSI;

   aInforme = #dscam065#1; |QBF aInforme;
   aInforme = aInforme + ".inf"; |HAZ CopiaFichero;
   aInforme = #dscam065#1; |QBF aInforme;
   aInforme = aInforme + ".rpt"; |HAZ CopiaFichero;
|FPRC;

|DEFBUCLE PasaInformes;
#dscam65@#1001;
;
"                              ";
"zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz";
;
NULL, PasaInformes;
|FIN;

|PROGRAMA;
   |CLS;
   |CABEZA " Adaptacion datos de DsCarter 4 a DsCarter 5 ";
   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      |ATRI I; |PINTA 2305, " Eliminando datos actuales de la empresa corriente ... "; |ATRI N;
      || Borramos los datos de la empresa actual .....
      |DFICE aAlfa; |QBF aAlfa; aAlfa1 = aAlfa;
      aAlfa = aAlfa + "*";
      |_PDIR aAlfa;
      |PARA; |SI FSalida = 0; |HACIENDO;
         aAlfa2 = aAlfa - aAlfa1; aAlfa2 = aAlfa2 % 0108;
         |SI aAlfa2 ! "dscam081"; |Y aAlfa2 ! "dscam082"; |Y aAlfa2 ! "dscam083";
          |Y aAlfa2 ! "dscam084"; |Y aAlfa2 ! "dscam085"; |Y aAlfa2 ! "dscam086";
          |Y aAlfa2 ! "dscam087"; |Y aAlfa2 ! "dscam088";
            |FBORRA aAlfa;
         |FINSI;
         |_SDIR aAlfa;
      |SIGUE;
      || ..... y los copiamos de la empresa anterior ......
      |ATRI I; |PINTA 2305, " Copiando datos actuales de la empresa antigua ...     "; |ATRI N;
      aAlfa = #dscaz950#0; |QBF aAlfa;
      aAlfa = aAlfa + (("00000" + #48#0) % -105) + "/"; aAlfa1 = aAlfa;
      aAlfa = aAlfa + "*";
      |_PDIR aAlfa;
      |PARA; |SI FSalida = 0; |HACIENDO;
         aAlfa3 = aAlfa - aAlfa1; |QBF aAlfa3; aAlfa3 = aAlfa3 % 0108;
         |SI aAlfa3 ! "dscam081"; |Y aAlfa3 ! "dscam082"; |Y aAlfa3 ! "dscam083";
          |Y aAlfa3 ! "dscam084"; |Y aAlfa3 ! "dscam085"; |Y aAlfa3 ! "dscam086";
          |Y aAlfa3 ! "dscam087"; |Y aAlfa3 ! "dscam088";
            aAlfa3 = aAlfa - aAlfa1; |QBF aAlfa3;
            |DFICE aAlfa2; |QBF aAlfa2;
            aAlfa2 = aAlfa2 + aAlfa3;
            |COPIA_FICHERO aAlfa, aAlfa2;
         |FINSI;
         |_SDIR aAlfa;
      |SIGUE;

      aAlfa = #dscaz950#0; |QBF aAlfa;
      aAlfa1 = aAlfa % -101;
      |SI aAlfa1 = "/";
         aAlfa = aAlfa - "fich/";
      |SINO;
         aAlfa = aAlfa - "fich";
      |FINSI;
      |SI FSalida = 0;
         |MENAV "    Revise el camino al directorio fich de los datos antiguos de cartera ";
         |ACABA;
      |SINO;
         aPathCartera4 = aAlfa;
      |FINSI;
      aAlfa1 = aAlfa + "def/dscam003.mas"; |CARGA_DEF aAlfa1, dscam03@;
      |SI FSalida = 0;
         |ATRI I; |PINTA 2305, " Adaptando ficheros ...                             "; |ATRI N;
         aAlfa1 = aAlfa + "def/dscam004.mas"; |CARGA_DEF aAlfa1, dscam04@;
         aAlfa1 = aAlfa + "def/dscam012.mas"; |CARGA_DEF aAlfa1, dscam12@;
         aAlfa1 = aAlfa + "def/dscam013.mas"; |CARGA_DEF aAlfa1, dscam13@;
         aAlfa1 = aAlfa + "def/dscam051.mas"; |CARGA_DEF aAlfa1, dscam51@;
         aAlfa1 = aAlfa + "def/dscam014.mas"; |CARGA_DEF aAlfa1, dscam14@;

         aAlfa1 = aAlfa + "def/dscam037.mas"; |CARGA_DEF aAlfa1, dscam37@;
         aAlfa1 = aAlfa + "def/dscam038.mas"; |CARGA_DEF aAlfa1, dscam38@;
         aAlfa1 = aAlfa + "def/dscam042.mas"; |CARGA_DEF aAlfa1, dscam42@;
         aAlfa1 = aAlfa + "def/dscam043.mas"; |CARGA_DEF aAlfa1, dscam43@;
         aAlfa1 = aAlfa + "def/dscam044.mas"; |CARGA_DEF aAlfa1, dscam44@;
         aAlfa1 = aAlfa + "def/dscam045.mas"; |CARGA_DEF aAlfa1, dscam45@;
         aAlfa1 = aAlfa + "def/dscam065.mas"; |CARGA_DEF aAlfa1, dscam65@;

         aAlfa1 = aAlfa + "fich/" + (("00000" + #48#0) % -105) + "/";
         |PATH_DAT #100 aAlfa1; |ABRE #dscam03@;
         |PATH_DAT #101 aAlfa1; |ABRE #dscam04@;
         |PATH_DAT #102 aAlfa1; |ABRE #dscam12@;
         |PATH_DAT #103 aAlfa1; |ABRE #dscam13@;
         |PATH_DAT #104 aAlfa1; |ABRE #dscam51@;
         |PATH_DAT #105 aAlfa1; |ABRE #dscam14@;

         aAlfa1 = aAlfa + "fich/";
         |PATH_DAT #106 aAlfa1; |ABRE #dscam37@;
         |PATH_DAT #107 aAlfa1; |ABRE #dscam38@;
         |PATH_DAT #108 aAlfa1; |ABRE #dscam42@;
         |PATH_DAT #109 aAlfa1; |ABRE #dscam43@;
         |PATH_DAT #110 aAlfa1; |ABRE #dscam44@;
         |PATH_DAT #111 aAlfa1; |ABRE #dscam45@;
         |PATH_DAT #114 aAlfa1; |ABRE #dscam65@;

         |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "fich/";
         |PATH_DAT #26 aAlfa; |PATH_DAT #27 aAlfa;
         |PATH_DAT #28 aAlfa; |PATH_DAT #29 aAlfa;
         |PATH_DAT #30 aAlfa; |PATH_DAT #31 aAlfa;

         |DELINDEX #dscaw062;
         |DELINDEX #dscam051; |ABRE #dscam051;
         |DELINDEX #dscam003; |ABRE #dscam003;
         |DELINDEX #dscam004; |ABRE #dscam004;
         |DELINDEX #dscam012; |ABRE #dscam012;
         |DELINDEX #dscam013; |ABRE #dscam013;
         |DELINDEX #dscam037; |ABRE #dscam037;
         |DELINDEX #dscam038; |ABRE #dscam038;
         |DELINDEX #dscam042; |ABRE #dscam042;
         |DELINDEX #dscam043; |ABRE #dscam043;
         |DELINDEX #dscam044; |ABRE #dscam044;
         |DELINDEX #dscam045; |ABRE #dscam045;
         |DELINDEX #dscam065; |ABRE #dscam065;
                              |ABRE #dscam075;
         |BUCLE dscam037;
         |BUCLE dscam042;
         |BUCLE dscam044;
         |CIERRA #dscam045; |CIERRA #dscam044;
         |CIERRA #dscam043; |CIERRA #dscam044;
         |CIERRA #dscam038; |CIERRA #dscam037;

         |DELINDEX #dscaw950; |ABRE #dscaw950;
         |ABRE #dscam058; |ABRE #dscam049; |ABRE #dscam050;

         |ABRE #dscam067; |HAZ Adaptacion; |CIERRA #dscam067;

         nSw = 1; nSwError = 1;
         |PARA; |SI nSwError = 1; |HACIENDO;
            |ENTLINEAL #1#dscaw950, -1, 2, 20, 1, inf950, sup950;
            nSwError = 0; |BUCLE Clasif;
            |SI nSwError = 1;
               |MENAV "    Quedan tipos de recibo sin especificar su clasificacion";
            |FINSI;
         |SIGUE;
         |ABRE #dscam081;   |ABRE #dscam082;
         nSw = 2; |BUCLE Clasif;

         #dscaw950#0 = 0;
         #dscaw950#1 = "TIPO DE RECIBO NULO";
         #dscaw950#2 = "C"; |HAZ GrabaClas;
         #dscaw950#2 = "R"; |HAZ GrabaClas;
         #dscaw950#2 = "P"; |HAZ GrabaClas;
         #dscaw950#2 = "A"; |HAZ GrabaClas;
         #dscaw950#2 = "O"; |HAZ GrabaClas;

         |CIERRA #dscam082; |CIERRA #dscam081;

         |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "fich/";
         |PATH_DAT #30 aAlfa; |PATH_DAT #31 aAlfa;
         |DELINDEX #dscaw951; |ABRE #dscaw951;
         |ABRE #dscam044; |ABRE #dscam045;
         nEmprCar = #48#0;
         |BUCLE Control;
         |ENTLINEAL #1#dscaw951, -2, 2, 20, 1, inf951, sup951;

         |BUCLE Volcado;

         |BUCLE PasaInformes;
         |CIERRA #dscaw951; |CIERRA #dscam065; |CIERRA #dscam075;
         |CIERRA #dscam044; |CIERRA #dscam045;

         |CIERRA #dscam049; |CIERRA #dscam050;
         |CIERRA #dscam058; |CIERRA #dscaw950;
         |CIERRA #dscam013; |CIERRA #dscam012;
         |CIERRA #dscam004; |CIERRA #dscam003;

         |CIERRA #dscam65@; |DESCARGA_DEF #dscam65@;
         |CIERRA #dscam45@; |DESCARGA_DEF #dscam45@;
         |CIERRA #dscam44@; |DESCARGA_DEF #dscam44@;
         |CIERRA #dscam43@; |DESCARGA_DEF #dscam43@;
         |CIERRA #dscam42@; |DESCARGA_DEF #dscam42@;
         |CIERRA #dscam38@; |DESCARGA_DEF #dscam38@;
         |CIERRA #dscam37@; |DESCARGA_DEF #dscam37@;
         |CIERRA #dscam14@; |DESCARGA_DEF #dscam14@;
         |CIERRA #dscam51@; |DESCARGA_DEF #dscam51@;
         |CIERRA #dscam13@; |DESCARGA_DEF #dscam13@;
         |CIERRA #dscam12@; |DESCARGA_DEF #dscam12@;
         |CIERRA #dscam04@; |DESCARGA_DEF #dscam04@;
         |CIERRA #dscam03@; |DESCARGA_DEF #dscam03@;
      |SINO;
         |MENAV "    Problemas al abrir el def de recibos de venta. Revise el camino a los datos antiguos";
      |FINSI;
   |FINSI;
|FPRO;
