|FICHEROS;
   dscaz118 #0;

   dscam042 #10;
   dscam043 #11;
   dscaw091 #12;

   dscam003  #100;
   camaniva@ #101;
   caclipro@ #102;
   caforpag@ #103;
|FIN;

|VARIABLES;
   &enSw = 0;

   aAlfa   = "";
   aPath   = "";

   aDSerie = "";
   aHSerie = "";

   nDLibro = 0;
   nHLibro = 0;

   nPrimero = 0;
   nEmp     = -1;
   nPer     = 0;
   nCalc    = 0;
   nSw      = 0;
|FIN;

|PROCESO Cartera;
   |SI #dscam003#49 = "S"; |ACABA; |FINSI;
   |SI #dscam003#46 ! 0;   |ACABA; |FINSI;

   |SI nEmp ! #dscam003#44; |O nPer ! #dscam003#45;
      |SI nPrimero = 1;
         nPrimero = 0;
      |SINO;
         |SI nEmp ] 0;
            |CIERRA #caforpag@; |DESCARGA_DEF #caforpag@;
            |CIERRA #caclipro@; |DESCARGA_DEF #caclipro@;
            |CIERRA #camaniva@; |DESCARGA_DEF #camaniva@;
         |FINSI;
      |FINSI;

      #dscam042#0 = #dscam003#44;
      #dscam042#1 = #dscam003#45;
      |LEE 000#dscam042.=;
      |SI FSalida = 0;
         aPath = #dscam042#2; |QBF aPath;
         aAlfa = aPath + "def/camaniva.mas";
         |CARGA_DEF aAlfa, camaniva@;
         |SI FSalida = 0;
            aAlfa = aPath + "def/caclipro.mas"; |CARGA_DEF aAlfa, caclipro@;
            aAlfa = aPath + "def/caforpag.mas"; |CARGA_DEF aAlfa, caforpag@;
            aAlfa = aPath + "fich/" + (("00000" + #dscam003#44) % -105) + #dscam003#45 + "/";
            |PATH_DAT #camaniva@#aAlfa#; |PATH_DAT #caclipro@#aAlfa#; |PATH_DAT #caforpag@#aAlfa#;
            |ABRE #camaniva@; |ABRE #caclipro@; |ABRE #caforpag@;
            nEmp = #dscam003#44; nPer = #dscam003#45;
         |SINO;
            nEmp = -1; nPer = 0;
         |FINSI;
      |SINO;
         nEmp = -1; nPer = 0;
      |FINSI;
   |SINO;
      nEmp = -1; nPer = 0;
   |FINSI;

   |SELECT #3#dscaw091;
   #dscaw091#8  = #dscam003#27;
   #dscaw091#9  = #dscam003#0;
   #dscaw091#10 = #dscam003#1;
   #dscaw091#11 = #dscam003#4;
   #dscaw091#12 = #dscam003#5;
   |LEE 000#dscaw091.=;
   |SI FSalida ! 0;
      |SELECT #1#dscaw091;
      |LEE 000#dscaw091.u;
      |SI FSalida = 0;
         nCalc = #dscaw091#15 + 1;
      |SINO;
         nCalc = 1;
      |FINSI;

      |DDEFECTO #dscaw091;
      #dscaw091#15 = nCalc;
      |GRABA 020#dscaw091.b;

      #dscaw091#8  = #dscam003#27;
      #dscaw091#9  = #dscam003#0;
      #dscaw091#10 = #dscam003#1;
      #dscaw091#11 = #dscam003#4;
      #dscaw091#12 = #dscam003#5;
      #dscaw091#13 = #dscam003#6;
   |FINSI;
   #dscaw091#14 = #dscaw091#14 + #dscam003#30;
   #dscaw091#16 = #dscaw091#16 + 1;

   |SI nEmp ] 0;
      |SELECT #3#camaniva@;
      #camaniva@#0  = #dscam003#27;
      #camaniva@#2  = #dscam003#0;
      #camaniva@#3  = #dscam003#1;
      |LEE 000#camaniva@.=;
      |PARA; |SI FSalida = 0; |Y #camaniva@#0  = #dscam003#27; |Y #camaniva@#2  = #dscam003#0; |Y #camaniva@#3  = #dscam003#1; |HACIENDO;
         |SI #camaniva@#12 = #dscam003#5; |Y #camaniva@#4 = #dscam003#4;
            |SI #camaniva@#36 = "S";
               #caclipro@#23 = "P";
            |SINO;
               #caclipro@#23 = "C";
            |FINSI;
            #caclipro@#10 = #camaniva@#12;
            |LEE 000#caclipro@.=;
            |SI FSalida ! 0; |DDEFECTO #caclipro@; |FINSI;

            #caforpag@#0 = #caclipro@#20;
            |LEE 000#caforpag@.=;
            |SI FSalida ! 0; |DDEFECTO #caforpag@; |FINSI;

            #dscaw091#0 = #camaniva@#0;
            #dscaw091#1 = #camaniva@#2;
            #dscaw091#2 = #camaniva@#3;
            #dscaw091#3 = #camaniva@#4;
            #dscaw091#4 = #camaniva@#12;
            #dscaw091#5 = #camaniva@#13;
            #dscaw091#6 = #camaniva@#21;
            #dscaw091#7 = #caforpag@#1;
            |SAL;
         |FINSI;
         |LEE 000#camaniva@.s;
      |SIGUE;
      #dscaw091#17 = 0;
      #camaniva@#0  = #dscam003#27;
      #camaniva@#2  = #dscam003#0;
      #camaniva@#3  = #dscam003#1;
      |LEE 000#camaniva@.=;
      |PARA; |SI FSalida = 0; |Y #camaniva@#0  = #dscam003#27; |Y #camaniva@#2  = #dscam003#0; |Y #camaniva@#3  = #dscam003#1; |HACIENDO;
         #dscaw091#17 = #dscaw091#17 + 1;
         |LEE 000#camaniva@.s;
      |SIGUE;
      |SELECT #1#camaniva@;
   |FINSI;

   |GRABA 020#dscaw091.a; |LIBERA #dscaw091;
|FPRC;

|DEFBUCLE Cartera;
  #dscam003#6;
  4;
  00, #dscaz118#0, #dscaz118#2, 000, " ", 000000001, #dscaz118#4;
  99, #dscaz118#1, #dscaz118#3, 999, " ", 999999999, #dscaz118#5;
  ;
  NULL, Cartera;
|FIN;

|PROCESO camaniva;

   |SI #camaniva@#36 = "S";
      #caclipro@#23 = "P";
   |SINO;
      #caclipro@#23 = "C";
   |FINSI;
   #caclipro@#10 = #camaniva@#12;
   |LEE 000#caclipro@.=;
   |SI FSalida ! 0; |DDEFECTO #caclipro@; |FINSI;

   #caforpag@#0 = #caclipro@#20;
   |LEE 000#caforpag@.=;
   |SI FSalida ! 0; |DDEFECTO #caforpag@; |FINSI;

   |SELECT #2#dscaw091;
   #dscaw091#0 = #camaniva@#0;
   #dscaw091#1 = #camaniva@#2;
   #dscaw091#2 = #camaniva@#3;
   #dscaw091#3 = #camaniva@#4;
   #dscaw091#4 = #camaniva@#12;
   |LEE 000#dscaw091.=;
   |SI FSalida ! 0;
      |SELECT #1#dscaw091;
      |LEE 000#dscaw091.u;
      |SI FSalida = 0;
         nCalc = #dscaw091#15 + 1;
      |SINO;
         nCalc = 1;
      |FINSI;
      #dscaw091#15 = nCalc;
      #dscaw091#0 = #camaniva@#0;
      #dscaw091#1 = #camaniva@#2;
      #dscaw091#2 = #camaniva@#3;
      #dscaw091#3 = #camaniva@#4;
      #dscaw091#4 = #camaniva@#12;
      #dscaw091#5 = #camaniva@#13;
      #dscaw091#7 = #caforpag@#1;
      |GRABA 020#dscaw091.b;
   |FINSI;
   #dscaw091#6  = #dscaw091#6  + #camaniva@#21;
   #dscaw091#16 = #dscaw091#16 + 1;
   |GRABA 020#dscaw091.a; |LIBERA #dscaw091;
   |SELECT #1#dscaw091;

|FPRC;

|DEFBUCLE camaniva;
#camaniva@#3003;
;
nDLibro, aDSerie, 000000;
nHLibro, aHSerie, 999999;
;
NULL,camaniva;
|FIN;

|PROCESO Impresion;
   |SI enSw = 1; |Y #dscaw091#17 > 1; |ACABA; |FINSI;
   |SI enSw = 2; |Y #dscaw091#16 ! 0; |ACABA; |FINSI;

   |PRINT;
|FPRC;

|DEFBUCLE Impresion;
#dscaw091#1;
;
INICIO;
FINAL;
;
NULL, Impresion;
|FIN;

|PROCESO Tipo3; |TIPO 3;
   |DFICB aAlfa; |QBF aAlfa; |PATH_DAT #dscam042#aAlfa#;
   aAlfa = "tm" + Usuario; |NOME_DAT #dscaw091#aAlfa#;
   |DELINDEX #dscaw091; |ABRE #dscaw091;
   nPrimero = 1;

   |ABRE #dscam042; |ABRE #dscam043;
   |BUCLE Cartera;
   || Se abre cada vez en el bucle. Para que con el ultimo
   |SI nEmp ] 0;
      |CIERRA #caforpag@; |DESCARGA_DEF #caforpag@;
      |CIERRA #caclipro@; |DESCARGA_DEF #caclipro@;
      |CIERRA #camaniva@; |DESCARGA_DEF #camaniva@;
   |FINSI;

   |SELECT #2#dscam043;
   #dscam043#9 = #48#0;
   |LEE 000#dscam043.];
   |PARA; |SI FSalida = 0; |Y #dscam043#9 = #48#0; |HACIENDO;
      #dscam042#0 = #dscam043#0;
      |LEE 000#dscam042.=;
      |SI FSalida = 0;
         #dscam042#0 = #dscam003#44;
         #dscam042#1 = #dscam003#45;
         |LEE 000#dscam042.=;
         |SI FSalida = 0;
            aPath = #dscam042#2; |QBF aPath;
         |FINSI;
         aAlfa = aPath + "def/camaniva.mas";
         |CARGA_DEF aAlfa, camaniva@;
         |SI FSalida = 0;
            aAlfa = aPath + "def/caclipro.mas"; |CARGA_DEF aAlfa, caclipro@;
            aAlfa = aPath + "def/caforpag.mas"; |CARGA_DEF aAlfa, caforpag@;
            aAlfa = aPath + "fich/" + (("00000" + #dscam003#44) % -105) + #dscam003#45 + "/";
            |PATH_DAT #camaniva@#aAlfa#; |PATH_DAT #caclipro@#aAlfa#; |PATH_DAT #caforpag@#aAlfa#;
            |ABRE #caclipro@; |ABRE #caforpag@;
            nDLibro = #dscam043#5; nHLibro = #dscam043#6;
            aDSerie = #dscam043#7; aHSerie = #dscam043#8;
            |BUCLE camaniva;
            |CIERRA #caforpag@; |DESCARGA_DEF #caforpag@;
            |CIERRA #caclipro@; |DESCARGA_DEF #caclipro@;
            |DESCARGA_DEF #camaniva@;
         |FINSI;
         |LEE 000#dscam043.s;
      |FINSI;
   |SIGUE;
   |CIERRA #dscam042; |CIERRA #dscam043;

   |IMPRE 0;
   |SI FSalida = 0;
      |INFOR "dscaz118";
      |SI FSalida = 0;
         enSw = 1; |BUCLE Impresion; || Para los tipos de error 1
         enSw = 2; |BUCLE Impresion; || Para los tipos de error 2
         |PIEINF; |FININF;
      |FINSI;
      |FINIMP;
   |FINSI;

   |CIERRA #dscaw091;
|FPRC;
