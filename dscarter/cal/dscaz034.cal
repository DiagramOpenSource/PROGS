||984

|| Ahora se le puede pasar un parametro de este estilo para
|| que haga el recalculo y luego mande un informe con el restultado
|| a la direccion de correo indicada

|| dscarz034;EMAIL=carlosc@digram.es

|FICHEROS;
   dscaz034 #0;
   dscam038 #1;
   dscam003 #2;
   dscam004 #3;
   dscam023 #4,MANTE;
   dscam024 #5;
   dscam037 #6;
   dscam014 #7;
   dscam012 #8;
   dscam013 #9;
   dscam051 #10;
   dscam044 #11;
   dscam045 #12;
   dscaw089 #13;

   dscam164 #164;

   agif010@ #500;
   agif104@ #501;
   agif066@ #502;
   agif073@ #503;
   agif134@ #504;
   agif084@ #505;
   agis002@ #506;
   agif024@ #507;
   con0625@ #508;
   con0626@ #509;
   con0603@ #510;
   agif019@ #511;
   con0606@ #512;
   con0683@ #513;
   agif007@ #514;

   dscam003@ #300;
   dscam000 #100;
   tagm0030@ #101;
|FIN;

|VARIABLES;
   aSaca = "";
   &enNum = 0;
   &enDebug = 0;
   &enImp1 = 0;
   &enImp2 = 0;
   &enImp3 = 0;
   nSwImpRec = 0;   || informe para pruebas: dscazrie


   nSwTagloma = 0;
   nSwArtenvas = 0;
   &Fichero = ""; &Tipo = ""; &Cmp = ""; &CmpNum = 0;
   &Divisa = "";  &nDeci_Div = 0;  &nDeci_Base = 0;
   &enDocRiesgo = 0; &enRiesgoImp = 0;

   &eaEntrada = ""; &eaSalida = "";

   &HayGestion = 0;
   &HayConta   = 0;
   &MaxDigit   = 0;
   &nImporte   = 0;
   &enEmpCartera = 0;
   &enEmpGestion = 0;
   &eaTipoR    = "";
   &enBanco    = 0;
   &eaSinAlta  = "";

   &eaCliGest  = "";
   &eaNomCli   = "";
   &eaSerie    = "";
   &eaTipoOper = "";

   aFichero    = "";
   aDsCorreoIP = "";
   aDirOrigen  = "";
   aDirDestino = "";
   aServidor   = "";
   aAsunto     = "";
   aTexto      = "";

   nTotal      = 0;
   nBase       = 0;
   nCalc       = 0;
   nNumImp     = 0;
   NumAgrup    = 0;
   Docum       = 0;
   Remes       = 0;
   Modo        = 0;
   RiesgoUtil  = 0;
   nEmpresa    = 0;
   nLong       = 0;
   Calc        = 0;
   Handle      = 0;
   SwError     = 0;
   nSwLuxe     = 0;
   nCobCfr     = 0;

   aOpcion     = "";
   Comodin     = "";
   Comodin1    = "";
   aLong       = "";
   aPart1      = "";
   aPart2      = "";
   aOpera      = "";
   aAlfa       = "";
   aAlfa1      = "";

   nSw =  0;

   nTotalOrden = 0;
   nTipoIva    = 0;

   fFechaIva   = @;
|FIN;

|PROCESO RiesgoBlock;
     #dscam023#0 = #tagm0030@#3;
     |LEE 101#dscam023.=;
     |SI FSalida ! 0;
          |DDEFECTO #dscam023;
          #dscam023#0 = #tagm0030@#3;
          #dscam023#1 = #tagm0030@#6;
          |GRABA 020#dscam023.n;
     |FINSI;

     #dscam024#0 = #tagm0030@#3;
     #dscam024#1 = #dscam038#6;
     |LEE 101#dscam024.=;
     |SI FSalida ! 0;
          |DDEFECTO #dscam024;
          #dscam024#0 = #tagm0030@#3;
          #dscam024#1 = #dscam038#6;
          |GRABA 020#dscam024.b;
     |FINSI;

     #dscam024#2 = #dscam024#2 + #tagm0030@#33;
     |GRABA 020#dscam024.a; |LIBERA #dscam024;
     |HAZ ActualizaTmp;
     |LIBERA #dscam023;
|FPRC;

|DEFBUCLE RiesgoBlock;
     #tagm0030@#2003;
     ;
     #0#1, #dscam038#3, 000001;
     #0#2, #dscam038#4, 999999;
     ;
     NULL, RiesgoBlock;
|FIN;


|PROCESO ActualizaTmp;
/*
   |SI #dscam038#8 = "R";
      #dscaw089#0 = #dscam024#0;
      #dscaw089#1 = #dscam024#1;
      |LEE 000#dscaw089.=;
      |SI FSalida ! 0;
         |DDEFECTO #dscaw089;
         #dscaw089#0 = #dscam024#0;
         #dscaw089#1 = #dscam024#1;
         |GRABA 020#dscaw089.c;
      |FINSI;
      #dscaw089#10 = #dscaw089#10 + #dscam024#2;
      #dscaw089#11 = #dscaw089#11 + #dscam024#3;
      #dscaw089#12 = #dscaw089#12 + #dscam024#4;
      #dscaw089#13 = #dscaw089#13 + #dscam024#6;
      #dscaw089#14 = #dscaw089#14 + #dscam024#7;
      #dscaw089#15 = #dscaw089#15 + #dscam024#5;
      |GRABA 020#dscaw089.a;
   |FINSI;
*/
   #dscaw089#0 = #dscam024#0;
   #dscaw089#1 = #dscam024#1;
   |LEE 000#dscaw089.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscaw089;
      #dscaw089#0 = #dscam024#0;
      #dscaw089#1 = #dscam024#1;
      |GRABA 020#dscaw089.c;
   |FINSI;
   #dscaw089#10 = #dscam024#2;
   #dscaw089#11 = #dscam024#3;
   #dscaw089#12 = #dscam024#4;
   #dscaw089#13 = #dscam024#6;
   #dscaw089#14 = #dscam024#7;
   #dscaw089#15 = #dscam024#5;
   |GRABA 020#dscaw089.a;
|FPRC;

|PROCESO RevisaRiesgos;
   #dscam023#0 = #dscaw089#0;
   |LEE 000#dscam023.=;
   |SI FSalida ! 0; |DDEFECTO #dscam023; |FINSI;

   #dscaw089#2 = #dscam023#19 - (#dscaw089#4  + #dscaw089#5  + #dscaw089#6  + #dscaw089#7  + #dscaw089#8  - #dscaw089#9);
   #dscaw089#3 = #dscam023#19 - (#dscaw089#10 + #dscaw089#11 + #dscaw089#12 + #dscaw089#13 + #dscaw089#14 - #dscaw089#15);
   |SI #dscaw089#2 ! #dscaw089#3; |PRINT; |FINSI;
|FPRC;

|DEFBUCLE RevisaRiesgos;
#dscaw089#1;
;
"      ", 00;
"zzzzzz", 99;
;
NULL,RevisaRiesgos;
|FIN;

|PROCESO AntesSelec; |TIPO 7;
   |SI HayConta = 0; |O HayGestion = 0;
      |SI HayConta = 0; |Y HayGestion = 1;
         |PINTA 1319, "Codigo";
         #dscaz034#0 = "G"; |C_M #dscaz034#0,1,"N";
         #dscaz034#1 = "";       #dscaz034#2 = "zzzzzz";
         #dscaz034#3 = "";       #dscaz034#4 = "zzzzzzzzzzzz";
         |C_M #dscaz034#1,1,"S"; |C_V #dscaz034#1,1,"S";
         |C_M #dscaz034#2,1,"S"; |C_V #dscaz034#2,1,"S";
         |PINTA #dscaz034#1;     |PINTA #dscaz034#2;
         |C_M #dscaz034#3,1,"N"; |C_V #dscaz034#3,1,"N";
         |C_M #dscaz034#4,1,"N"; |C_V #dscaz034#4,1,"N";
      |FINSI;
      |SI HayConta = 1; |Y HayGestion = 0;
         |PINTA 1319, "Cuenta";
         #dscaz034#0 = "C"; |C_M #dscaz034#0,1,"N";
         #dscaz034#1 = "";       #dscaz034#2 = "zzzzzz";
         #dscaz034#3 = "";       #dscaz034#4 = "zzzzzzzzzzzz";
         |C_M #dscaz034#3,1,"S"; |C_V #dscaz034#3,1,"S";
         |C_M #dscaz034#4,1,"S"; |C_V #dscaz034#4,1,"S";
         |PINTA #dscaz034#3;     |PINTA #dscaz034#4;
         |C_M #dscaz034#1,1,"N"; |C_V #dscaz034#1,1,"N";
         |C_M #dscaz034#2,1,"N"; |C_V #dscaz034#2,1,"N";
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO TrasSelec;
   |SI #dscaz034#0 ! Contenido; |BLANCO 1319 1358; |FINSI;
   |SI #dscaz034#0 = "G";
      |PINTA 1319, "Codigo Cliente";
      #dscaz034#1 = "";       #dscaz034#2 = "zzzzzz";
      #dscaz034#3 = "";       #dscaz034#4 = "zzzzzzzzzzzz";
      |C_M #dscaz034#1,1,"S"; |C_V #dscaz034#1,1,"S";
      |C_M #dscaz034#2,1,"S"; |C_V #dscaz034#2,1,"S";
      |PINTA #dscaz034#1;     |PINTA #dscaz034#2;
      |C_M #dscaz034#3,1,"N"; |C_V #dscaz034#3,1,"N";
      |C_M #dscaz034#4,1,"N"; |C_V #dscaz034#4,1,"N";
   |SINO;
      |PINTA 1319, "Cuenta Cliente";
      #dscaz034#1 = "";       #dscaz034#2 = "zzzzzz";
      #dscaz034#3 = "";       #dscaz034#4 = "zzzzzzzzzzzz";
      |C_M #dscaz034#3,1,"S"; |C_V #dscaz034#3,1,"S";
      |C_M #dscaz034#4,1,"S"; |C_V #dscaz034#4,1,"S";
      |PINTA #dscaz034#3;     |PINTA #dscaz034#4;
      |C_M #dscaz034#1,1,"N"; |C_V #dscaz034#1,1,"N";
      |C_M #dscaz034#2,1,"N"; |C_V #dscaz034#2,1,"N";
   |FINSI;
|FPRC;

|PROCESO TrasRiesgo;
   |SI #dscaz034#5 = "B";
      |C_M #dscaz034#1,1,"N";
      |C_M #dscaz034#2,1,"N";
      |C_M #dscaz034#6,1,"S"; |C_M #dscaz034#7,1,"S";
   |FINSI;
   |SI #dscaz034#5 = "C";
      |C_M #dscaz034#1,1,"S";
      |C_M #dscaz034#2,1,"S";
      |C_M #dscaz034#6,1,"N"; |C_M #dscaz034#7,1,"N";
   |FINSI;
   |SI #dscaz034#5 = "A";
      |C_M #dscaz034#1,1,"S";
      |C_M #dscaz034#2,1,"S";
      |C_M #dscaz034#6,1,"S"; |C_M #dscaz034#7,1,"S";
   |FINSI;
|FPRC;

|PROCESO Cuenta;
   Comodin = #dscaz034#Campo#; |QBF Comodin;
   Comodin = Comodin - ".";
   |SI FSalida ! 0;
      aLong = Comodin % 0; nLong = aLong; nLong = MaxDigit - nLong;
      Calc = ((FSalida / 100) ! 0) + 99; aPart1 = Comodin % Calc;
      Comodin = Comodin - aPart1;
      aPart2 = Comodin;
      Comodin = "0" * nLong;
      Comodin = aPart1 + Comodin + aPart2;
   |FINSI;
   #dscaz034#Campo# = Comodin; |PINTA #dscaz034#Campo#;
|FPRC;

|PROCESO CalcLins;
   Fichero = "Pedidos Lins."; Tipo = "G"; Cmp = "Importe Total Linea"; |HAZ ObtenDato;
   nBase = #agif073@#CmpNum#;
   Fichero = "Pedidos Lins."; Tipo = "G"; Cmp = "Importe Pendiente Linea"; |HAZ ObtenDato;
   nBase = #agif073@#CmpNum#;
   || nBase = nBase - #agif073@#CmpNum#;

   nCalc = 0; fFechaIva = "01.01.0000";
   Fichero = "Pedidos Lins."; Tipo = "G"; Cmp = "Tipo Iva"; |HAZ ObtenDato;
   #agif066@#0 = #agif073@#CmpNum#;
   #agif066@#4 = "01.01.0000";
   |LEE 000#agif066@.];
   |PARA; |SI FSalida = 0; |Y #agif066@#0 = #agif073@#CmpNum#; |HACIENDO;
      |SI #agif104@#1 ] #agif066@#4;
         fFechaIva = #agif066@#4;
      |SINO;
         |SAL;
      |FINSI;
      |LEE 000#agif066@.s;
   |SIGUE;

   #agif066@#0 = #agif073@#CmpNum#;
   #agif066@#4 = fFechaIva;
   |LEE 000#agif066@.=;
   |SI FSalida = 0;
      Fichero = "Pedidos"; Tipo = "G"; Cmp = "Codigo Cliente"; |HAZ ObtenDato;
      #agif024@#0 = #agif104@#CmpNum#;
      |LEE 000#agif024@.=;
      |SI FSalida = 0;
         |SI #agif024@#28 = "N";
            nCalc = (nBase % #agif066@#2);
            |SI #agif024@#47 = "S";
               nCalc = nCalc + (nBase % #agif066@#3);
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;
   nTotal = nTotal + (nBase + nCalc);
|FPRC;

|DEFBUCLE CalcLins;
#agif073@#1003;
;
#agif104@#25, #agif104@#0,001;
#agif104@#25, #agif104@#0,999;
;
NULL,CalcLins;
|FIN;

|PROCESO RiesgoAdel;
   Divisa = "";
   |SI #agis002@#30 = "P";
      #agif104@#25 = #agis002@#20;
      #agif104@#0  = #agis002@#17;
      |LEE 000#agif104@.=;
      |SI FSalida = 0; Divisa = #agif104@#35; |FINSI;
   |FINSI;
   |SI #agis002@#30 = "A";
      #agif010@#52 = #agis002@#20;
      #agif010@#0  = #agis002@#17;
      |LEE 000#agif010@.=;
      |SI FSalida = 0; Divisa = #agif010@#68; |FINSI;
   |FINSI;

   |SI Divisa = ""; Divisa = "EUR"; |FINSI;
   |HAZ CargaNDeci;

   #dscam023#0 = #agis002@#2;
   |LEE 000#dscam023.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscam023;
      #dscam023#0 = ("000000" + #agis002@#2) % -106;
      #dscam023#1 = #agis002@#3;
      |GRABA 020#dscam023.n;
   |FINSI;

   #dscam024#0 = #agis002@#2;
   #dscam024#1 = #dscam038#6;
   |LEE 101#dscam024.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscam024;
      #dscam024#0 = ("000000" + #agis002@#2) % -106;
      #dscam024#1 = #dscam038#6;
      |GRABA 020#dscam024.b;
   |FINSI;
/*
   |SI #agis002@#30 = "P";
      #dscam024#2 = #dscam024#2 - #agis002@#9;
   |FINSI;
   |SI #agis002@#30 = "A";
      #dscam024#3 = #dscam024#3 - #agis002@#9;
   |FINSI;
*/
   |ABRE #dscam003;
   |SELECT #6#dscam003; |DDEFECTO #dscam003;
   #dscam003#69 = #agis002@#30;
   #dscam003#0  = #agis002@#20;
   #dscam003#1  = #agis002@#17;
   #dscam003#2  = #agis002@#18;
   |LEE 000#dscam003.];
   |SI FSalida ! 0; |O #dscam003#69 ! #agis002@#30; |O #dscam003#0 ! #agis002@#20;
    |O #dscam003#1 ! #agis002@#17; |O #dscam003#2 ! #agis002@#18;
       |DDEFECTO #dscam003; #dscam003#40 = 0;
   |FINSI;
   |SELECT #1#dscam003;
   |LEE 000#dscam003.=;
   |SI FSalida = 0;
      |SI #dscam003#23 = 0; |CIERRA #dscam003; |ACABA; |FINSI;
      ||SI #dscam003#23 = 0; |ACABA; |FINSI;
   |FINSI;
   #dscam024#5 = #dscam024#5 + #dscam003#23;
   |GRABA 020#dscam024.a; |LIBERA #dscam024;
   |HAZ ActualizaTmp;
   |CIERRA #dscam003;
|FPRC;

|DEFBUCLE RiesgoAdel;
#agis002@#1004;
2;
#dscam038#2,#dscam038#3,000001,01,#dscaz034#1;
#dscam038#2,#dscam038#4,999999,99,#dscaz034#2;
;
NULL,RiesgoAdel;
|FIN;

|PROCESO RiesgoPedidos;
   Divisa = #agif104@#35; |HAZ CargaNDeci;

   Fichero = "Pedidos"; Tipo = "G"; Cmp = "Codigo Cliente"; |HAZ ObtenDato;
   #dscam023#0 = #agif104@#CmpNum#;
   |LEE 101#dscam023.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscam023;
      Fichero = "Pedidos"; Tipo = "G"; Cmp = "Codigo Cliente"; |HAZ ObtenDato;
      #dscam023#0 = ("000000" + #agif104@#CmpNum#) % -106;
      Fichero = "Pedidos"; Tipo = "G"; Cmp = "Nombre Cliente"; |HAZ ObtenDato;
      #dscam023#1 = #agif104@#CmpNum#;
      |GRABA 020#dscam023.n;
   |FINSI;

   Fichero = "Pedidos"; Tipo = "G"; Cmp = "Codigo Cliente"; |HAZ ObtenDato;
   #dscam024#0 = #agif104@#CmpNum#;
   #dscam024#1 = #dscam038#6;
   |LEE 101#dscam024.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscam024;
      Fichero = "Pedidos"; Tipo = "G"; Cmp = "Codigo Cliente"; |HAZ ObtenDato;
      #dscam024#0 = ("000000" + #agif104@#CmpNum#) % -106;
      #dscam024#1 = #dscam038#6;
      |GRABA 020#dscam024.b;
   |FINSI;

   nTotal = 0; |BUCLE CalcLins;

   #dscam024#2 = #dscam024#2 + nTotal;
   |GRABA 020#dscam024.a; |LIBERA #dscam024;
   |HAZ ActualizaTmp;
   |LIBERA #dscam023;
|FPRC;

|DEFBUCLE RiesgoPedidos;
#agif104@#1002;
4,12;
#dscam038#3,000001,#dscaz034#1,0000000001;
#dscam038#4,999999,#dscaz034#2,9999999999;
;
NULL,RiesgoPedidos;
|FIN;

|PROCESO RiesgoAlbaranes;
   || Un albaran no facturable no acumula en el riesgo
   |SI #agif010@#51 = "N"; |ACABA; |FINSI;

   Divisa = #agif010@#68; |HAZ CargaNDeci;

   Fichero = "Albaranes"; Tipo = "G"; Cmp = "Codigo Cliente"; |HAZ ObtenDato;
   #dscam023#0 = #agif010@#CmpNum#;
   |LEE 000#dscam023.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscam023;
      Fichero = "Albaranes"; Tipo = "G"; Cmp = "Codigo Cliente"; |HAZ ObtenDato;
      #dscam023#0 = ("000000" + #agif010@#CmpNum#) % -106;
      Fichero = "Albaranes"; Tipo = "G"; Cmp = "Nombre Cliente"; |HAZ ObtenDato;
      #dscam023#1 = #agif010@#CmpNum#;
      |GRABA 020#dscam023.n;
   |FINSI;

   Fichero = "Albaranes"; Tipo = "G"; Cmp = "Codigo Cliente"; |HAZ ObtenDato;
   #dscam024#0 = #agif010@#CmpNum#;
   #dscam024#1 = #dscam038#6;
   |LEE 101#dscam024.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscam024;
      Fichero = "Albaranes"; Tipo = "G"; Cmp = "Codigo Cliente"; |HAZ ObtenDato;
      #dscam024#0 = ("000000" + #agif010@#CmpNum#) % -106;
      #dscam024#1 = #dscam038#6;
      |GRABA 101#dscam024.b;
   |FINSI;
   Fichero = "Albaranes"; Tipo = "G"; Cmp = "Total Albaran"; |HAZ ObtenDato;
   #dscam024#3 = #dscam024#3 + #agif010@#CmpNum#;
   |GRABA 020#dscam024.a; |LIBERA #dscam024;
   |HAZ ActualizaTmp;
|FPRC;

|DEFBUCLE RiesgoAlbaranes;
#agif010@#1002;
3,38;
#dscam038#3,000001,#dscaz034#1,"N";
#dscam038#4,999999,#dscaz034#2,"N";
;
NULL,RiesgoAlbaranes;
|FIN;

|PROCESO CalculaOrden;
   |SI #con0626@#14 = "N";
      || nTotalOrden = nTotalOrden + #con0626@#8;
      |SI #con0626@#11 ] 1; |Y #con0626@#11 [ 999;
         #con0603@#0 = #con0626@#2;
         |LEE 000#con0603@.=;
         |SI FSalida ! 0; |DDEFECTO #con0603@; |FINSI;
         nTipoIva = #con0603@#5;
      |FINSI;
      |SI #con0626@#11 ] 1000; |Y #con0626@#11 [ 1999;
         #agif019@#0 = #con0626@#2;
         |LEE 000#agif019@.=;
         |SI FSalida ! 0; |DDEFECTO #agif019@; |FINSI;
         nTipoIva = #agif019@#30;
      |FINSI;
      |SI #con0626@#11 ] 2000; |Y #con0626@#11 [ 2999;
         #con0606@#0 = #con0626@#2;
         |LEE 000#con0606@.=;
         |SI FSalida ! 0; |DDEFECTO #con0606@; |FINSI;
         nTipoIva = #con0606@#4;
      |FINSI;
      |SI #con0626@#11 ] 3000; |Y #con0626@#11 [ 3999;
         #agif019@#0 = #con0626@#2;
         |LEE 000#agif019@.=;
         |SI FSalida ! 0; |DDEFECTO #agif019@; |FINSI;
         nTipoIva = #agif019@#30;
      |FINSI;

      #agif066@#0 = nTipoIva;
      |LEE 000#agif066@.=;
      |SI FSalida ! 0; |DDEFECTO #agif066@; |FINSI;
      nCalc = ((100 + #agif066@#2) / 100) ! 2;

      |SI #con0625@#0 = #con0683@#11; |O #con0625@#0 = #con0683@#12; |O #con0625@#0 = #con0683@#13;
       |O #con0625@#0 = #con0683@#17; |O #con0625@#0 = #con0683@#18; |O #con0625@#0 = #con0683@#19;
       |O #agif007@#30 = "S";
         nTotalOrden = nTotalOrden + #con0626@#8;
      |SINO;
         nTotalOrden = nTotalOrden + ((#con0626@#8 * nCalc) ! 2);
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE CalculaOrden;
#con0626@#1003;
;
#con0625@#0, #con0625@#1, 0001;
#con0625@#0, #con0625@#1, 9999;
;
NULL,CalculaOrden;
|FIN;

|PROCESO RiesgoOR;
   Divisa = "EUR"; |HAZ CargaNDeci;

   |ABRE #con0603@; |ABRE #agif019@; |ABRE #con0606@;
   |ABRE #con0683@; |ABRE #agif007@;

   #agif007@#26 = #con0625@#0;
   |LEE 000#agif007@.=;
   |SI FSalida ! 0; |DDEFECTO #agif007@; |FINSI;

   |LEE 000#con0683@.p;
   |SI FSalida ! 0; |DDEFECTO #con0683@; |FINSI;

   nTotalOrden = 0; |BUCLE CalculaOrden;
   |CIERRA #agif007@; |CIERRA #con0683@; |CIERRA #con0606@;
   |CIERRA #agif019@; |CIERRA #con0603@;

   #dscam023#0 = #con0625@#11;
   |LEE 000#dscam023.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscam023;
      #dscam023#0 = ("000000" + #con0625@#11) % -106;
      #dscam023#1 = #con0625@#19;
      |GRABA 020#dscam023.n;
   |FINSI;

   #dscam024#0 = ("000000" + #con0625@#11) % -106;
   #dscam024#1 = #dscam038#6;
   |LEE 101#dscam024.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscam024;
      #dscam024#0 = ("000000" + #con0625@#11) % -106;
      #dscam024#1 = #dscam038#6;
      |GRABA 101#dscam024.b;
   |FINSI;
   #dscam024#3 = #dscam024#3 + nTotalOrden;
   |GRABA 020#dscam024.a; |LIBERA #dscam024;
   |HAZ ActualizaTmp;
|FPRC;

|DEFBUCLE RiesgoOR;
#con0625@#1002;
11;
#dscam038#3,"      ",#dscaz034#1;
#dscam038#4,"zzzzzz",#dscaz034#2;
;
NULL,RiesgoOR;
|FIN;

|PROCESO LineasCob;
   |SALVA_FICHA #dscam038;
   || enEmpCartera = nEmpresa;
   enEmpCartera = #dscam038#5;
   enEmpGestion = #dscam038#0;
   eaCliGest    = #dscam003#32;
   eaTipoR      = "F";
   eaNomCli     = #dscam003#6;
   eaSerie      = #dscam003#0;
   nImporte     = 0;
   enBanco      = -1;  || No se toca el riesgo bancario, luego se recalculara
   |SI #dscam004#5 = "REM";
      eaTipoOper = "";
      || nImporte = #dscam004#26;
      nImporte = #dscam004#26 + #dscam004#32;
      |ABRE #dscam013;
      |SELECT #2#dscam013;
      #dscam013#16 = #dscam004#17;
      #dscam013#17 = #dscam004#3;
      |LEE 000#dscam013.=;
      |SI FSalida = 0; |Y nCobCfr = 0;
         |SI #dscam013#15 = "S"; |O #dscam013#15 = "R";
            |SI nNumImp = 0;
               eaTipoOper = "-4";
            |SINO;
               eaTipoOper = "-7";
            |FINSI;
         |SINO;
            |SI nNumImp = 0;
               eaTipoOper = "+6-4";
            |SINO;
               eaTipoOper = "+6-7";
            |FINSI;
         |FINSI;
      |FINSI;
      |SELECT #1#dscam013;
      |CIERRA #dscam013;
   |FINSI;
   |SI #dscam004#5 = "CFR"; |Y #dscam051#130 = "S";
      eaTipoOper = "-4";
      nImporte = #dscam003#60;
      nCobCfr    = 1;
   |FINSI;
   |SI #dscam004#5 = "COB"; |O #dscam004#5 = "COP"; |O #dscam004#5 = "RCB";
    |O #dscam004#5 = "REC"; |O #dscam004#5 = "RAC"; |O #dscam004#5 = "CAC";
       nImporte = #dscam004#26;
       |SI #dscam004#5 = "RAC"; |Y nImporte = 0;
          nImporte = #dscam003#22;
          eaTipoOper = "-4+5";
       |SINO;
          |SI nNumImp = 0;
             |SI nNumImp = 0;
                eaTipoOper = "-4";
             |SINO;
                eaTipoOper = "-7";
             |FINSI;
             |SI #dscam004#5 = "CAC";
                aAlfa = #dscam004#16; |QBF aAlfa; aAlfa = aAlfa % -109;
                |SALVA_FICHA #dscam003;
                #dscam003#40 = aAlfa;
                |LEE 000#dscam003.=;
                |SI FSalida = 0; |Y #dscam003#14 ! "L"; |Y #dscam003#14 ! "C";
                   |SI #dscam003#69 = "P";
                         eaTipoOper = eaTipoOper + "-2";
                   |FINSI;
                   |SI #dscam003#69 = "A";
                         eaTipoOper = eaTipoOper + "-3";
                   |FINSI;
                   |SI #dscam003#69 = " ";
                         eaTipoOper = eaTipoOper + "-5";
                   |FINSI;
                |FINSI;
                |REPON_FICHA #dscam003;
             |FINSI;
             |SI #dscam004#5 = "RAC"; |Y #dscam003#69 = " ";
                    eaTipoOper = eaTipoOper + "+5";
             |FINSI;
             |SI #dscam004#5 = "REC"; |Y #dscam003#69 = " ";
                    eaTipoOper = "+5";
             |FINSI;
          |SINO;
             eaTipoOper = "-7";
          |FINSI;
       |FINSI;
       |SI #dscam004#5 = "COB"; |Y nCobCfr = 1; eaTipoOper = ""; |FINSI;
   |FINSI;

   |SI #dscam004#5 = "IMP"; |O #dscam004#5 = "IMA"; |O #dscam004#5 = "RCE";
          |O #dscam004#5 = "RCA";

      |SI #dscam004#5 = "IMP"; |O #dscam004#5 = "IMA";
          nNumImp = nNumImp + 1;
      |FINSI;

      |SI #dscam004#5 = "IMA";
         nImporte = #dscam003#30 - (#dscam004#29 + #dscam004#30 + #dscam004#31 + #dscam004#32);
         eaTipoOper = "-4"; |HAZ BucleTR;
      |FINSI;

      |SI #dscam004#5 = "IMP";
          |ABRE #dscam013;
          |SELECT #4#dscam013;
          #dscam013#16 = #dscam004#17;
          #dscam013#24 = 1;
          |LEE 000#dscam013.];
          |SI FSalida = 0; |Y #dscam013#16 = #dscam004#17;
             |SI #dscam013#15 ! "S"; |Y #dscam013#15 ! "R";
                   nImporte = #dscam004#27;
                   eaTipoOper = "-6"; |HAZ BucleTR;
             |FINSI;
/* comentado por el Tiquet: 3068/618
             ||...Tiquet 160:984
             |SI #dscam013#15 = "S";
                   nImporte = #dscam004#27 + #dscam004#28;
                   eaTipoOper = "-4"; |HAZ BucleTR;
             |FINSI;
             ||....
*/
          |FINSI;
          |CIERRA #dscam013;

          ||...Tiquet 160:974  Talon impagado
          nImporte = #dscam004#30 + #dscam004#31;
          |SALVA_FICHA #dscam004;
          |LEE 000#dscam004.a;
          |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |Y #dscam004#5="RPT";
               eaTipoOper = "-7";
               |HAZ BucleTR;

               eaTipoOper = "+7-4";
               nImporte = -nImporte + #dscam003#30;
               |HAZ BucleTR;
          |FINSI;
          |REPON_FICHA #dscam004;
          ||...

         eaTipoOper = "+7";
         nImporte = #dscam004#27 + #dscam004#29 + #dscam004#30;
         nImporte = nImporte +     #dscam004#31 + #dscam004#32;

         |SI nSwArtenvas = 0; |Y nImporte = 0;
            nImporte = #dscam004#9 + #dscam004#12 + #dscam004#13;
            nImporte = nImporte +    #dscam004#14 + #dscam004#23;
         |FINSI;
      |FINSI;

      |SI #dscam004#5 = "IMA";
         eaTipoOper = "+7";
         nImporte = #dscam003#30;
      |FINSI;
      |SI #dscam004#5 = "RCE";
         eaTipoOper = "+4";
         nImporte = #dscam004#27 + #dscam004#29 + #dscam004#30;
         nImporte = nImporte +     #dscam004#31 + #dscam004#32;
      |FINSI;
   |FINSI;

   |SI #dscam004#5 = "CSI";
      || Tres casos. Cambio de Pendiente a Liquidado, de Pendiente a Impagado o de Liquidado a Pendiente
      || Nooooo .... un caso mas .... de impagado a impagado (alucina)
      || En este ultimo caso hay que tener en cuenta que el movimiento de impagado
      ||    ya acumul¢ el riesgo, por lo que este movimiento no afecta al
      ||    riesgo
      |SI #dscam004#8 = 0; |Y #dscam004#9 ! 0;
         || Compruebo en el historico de cambios de situacion si el estado
         ||     anterior era impagado. Si es asi, no acumulo el riesgo
         nSw = 1;
         aAlfa = #dscam004#16; |QBF aAlfa;
         aAlfa = aAlfa - "Cambio situacion ";
         |ABRE #dscam164; |SELECT #2#dscam164;
         #dscam164#0 = #dscam004#17;
         #dscam164#8 = aAlfa;
         |LEE 000#dscam164.=;
         |SI FSalida = 0;
            |SI #dscam164#9 = "I"; nSw =  0; |FINSI;
         |FINSI;
         |SELECT #1#dscam164; |CIERRA #dscam164;
         eaTipoOper = "-4+7";
         nImporte = #dscam004#27 + #dscam004#29 + #dscam004#30;
         nImporte = nImporte +     #dscam004#31 + #dscam004#32;
         |SI nSw = 0; nImporte = 0; eaTipoOper = ""; |FINSI;
      |FINSI;
   |FINSI;
   |HAZ BucleTR;
   |REPON_FICHA #dscam038;
|FPRC;

|DEFBUCLE LineasCob;
#dscam004#1;
;
#dscam003#40,001;
#dscam003#40,999;
;
NULL,LineasCob;
|FIN;

|PROCESO Agrupados;
   |SI #dscam003#0  < #dscam038#3; |O #dscam003#0 > #dscam038#4; |ACABA; |FINSI;
   |SI #dscam003#46 ! #dscam038#0; |ACABA; |FINSI;
|FPRC;

|DEFBUCLE Agrupados;
#dscam003#1;
41;
000000001,NumAgrup;
999999999,NumAgrup;
;
NULL,Agrupados;
|FIN;

|PROCESO MiraSiEntregas;
     |SI #dscam004#5 = "REC"; |Y #dscam003#69 = " "; |Y #dscam003#14 ! "L";
          enEmpCartera = nEmpresa;     enEmpGestion = #dscam038#0;
          eaCliGest    = #dscam003#32; eaTipoR      = "F";
          eaNomCli     = #dscam003#6;  eaSerie      = #dscam003#0;
          nImporte     = #dscam004#26; enBanco      = -1;
          eaTipoOper   = "-4+5";
          |HAZ BucleTR;
     |FINSI;
     |SI #dscam004#5 = "CAC";
          enEmpCartera = nEmpresa;     enEmpGestion = #dscam038#0;
          eaCliGest    = #dscam003#32; eaTipoR      = "F";
          eaNomCli     = #dscam003#6;  eaSerie      = #dscam003#0;
          nImporte     = #dscam004#26; enBanco      = -1;
          aAlfa = #dscam004#16; |QBF aAlfa; aAlfa = aAlfa % -109;
          #dscam003@#40 = aAlfa;
          |LEE 000#dscam003@.=;
          |SI FSalida = 0; |Y #dscam003#14 ! "L";
               |SI #dscam003@#69 = "P";
                    eaTipoOper = "+2";
               |FINSI;
               |SI #dscam003@#69 = "A";
                    eaTipoOper = "+3";
               |FINSI;
               |SI #dscam003@#69 = " ";
                    eaTipoOper = "-5";
               |FINSI;
         |FINSI;
         |HAZ BucleTR;
     |FINSI;
|FPRC;

|DEFBUCLE MiraSiEntregas;
     #dscam004#1;
     ;
     #dscam003#40,001;
     #dscam003#40,999;
     ;
     NULL,MiraSiEntregas;
|FIN;

|PROCESO RiesgoRecibos;
     |HAZ ComprTotVta;
     |SI #dscam038#3 > #dscam003#0; |O #dscam003#0 > #dscam038#4;
          |ACABA;
     |FINSI;

     || En caso de ser el modulo de Artenvas, compruebo si la factura est  impresa = "N";
     ||    y si es as¡ le pongo que si que est  impresa porque si no no existir¡an
     ||    los recibos
     |SI nSwArtenvas = 0;
          #agif134@#49 = #dscam003#0;
          #agif134@#0  = #dscam003#1;
          |LEE 101#agif134@.=;
          |SI FSalida = 0;
               |SI #dscam003#4 = #agif134@#1; |Y #agif134@#45 = "N";
                    #agif134@#45 = "S";
                    |GRABA 020#agif134@.a;
                    |LIBERA #agif134@;
                    |ACABA;
               |FINSI;
               |LIBERA #agif134@;
          |FINSI;
     |FINSI;

     Divisa = #dscam003#57; |HAZ TomaDecim;
     |SI #dscam003#14 = "A"; |ACABA; |FINSI;
     |SI #dscam003#14 = "D"; |ACABA; |FINSI;

     SwError = 0;
     |SI #dscam003#14 = "L";
          |SI #dscam003#17 = 0;
               eaTipoOper = "";
               |DDEF aAlfa; aAlfa = aAlfa + "dscam003";
               |CARGA_DEF aAlfa, dscam003@;
               |SI FSalida = 0;
                    |ABRE #dscam003@;
                    |BUCLE MiraSiEntregas;
                    |CIERRA #dscam003@;
                    |DESCARGA_DEF #dscam003@;
               |SINO;
                    |MENAV "0000Error al cargar 'dscam003'..."; |ERROR10;
               |FINSI;

               |SI nSwLuxe = 1;
                    |SI #dscam003#12 = 2; |O #dscam003#12 = 10;
                         |SI #dscam003#84 = "N";
                              enEmpCartera = nEmpresa;     enEmpGestion = #dscam038#0;
                              eaCliGest    = #dscam003#32; eaTipoR      = "F";
                              eaNomCli     = #dscam003#6;  eaSerie      = #dscam003#0;
                              nImporte     = #dscam003#60; eaTipoOper = "+6-4";
                              |HAZ BucleTR;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |ACABA;
          |SINO;
               |ABRE #dscam013;
               #dscam013#0 = #dscam003#17;
               #dscam013#1 = #dscam003#37;
               |LEE 000#dscam013.=;
               |SI FSalida = 0;
                    |SI #dscam013#15 = "N";
                         SwError = 0;
                    |SINO;
                         SwError = 1;
                    |FINSI;
               |SINO;
                    SwError = 1;
               |FINSI;
               |CIERRA #dscam013;
          |FINSI;
     |FINSI;

     |SI SwError = 1; |ACABA; |FINSI;

     #dscam023#0 = #dscam003#32;
     |LEE 101#dscam023.=;
     |SI FSalida ! 0;
          |DDEFECTO #dscam023;
          #dscam023#0 = #dscam003#32;
          #dscam023#1 = #dscam003#6;
          |GRABA 020#dscam023.b;
     |FINSI;

     #dscam023#21 = #dscam023#21 + 1;

     |SI #dscam023#22 > #dscam003#4; |Y #dscam003#4 ! "01.01.0000";
          #dscam023#22 = #dscam003#4;
     |FINSI;
     |GRABA 020#dscam023.a;
     |LIBERA #dscam023;

     |SALVA_FICHA #dscam038;
     enEmpCartera = nEmpresa;     enEmpGestion = #dscam038#0;
     eaCliGest    = #dscam003#32; eaTipoR      = "F";
     eaNomCli     = #dscam003#6;  eaSerie      = #dscam003#0;
     nImporte     = #dscam003#60; eaTipoOper   = "+4";
     enBanco = -1; || No se toca el riesgo bancario, luego se recalcular 

     enDebug = 1; |HAZ ImpreDebug;

     |SI #dscam051#114 = 1;
          |HAZ BucleTR;
     |SINO;
          enDocRiesgo  = #dscam003#40;
          |SI #dscam003#14 ! "I";
               |HAZ RevisaDatosRiesgo;
          |SINO;
               enRiesgoImp = 0;
          |FINSI;
          |SI enRiesgoImp = 0;
               |HAZ BucleTR;
          |SINO;
               nImporte = nImporte - enRiesgoImp;
               |HAZ BucleTR;

               eaTipoOper   = "+7";
               nImporte = enRiesgoImp;
               |HAZ BucleTR;
          |FINSI;
     |FINSI;
     |REPON_FICHA #dscam038;

     nNumImp = 0;
     |SI #dscam003#14 = "R";
          nImporte = #dscam004#26;
          |ABRE #dscam013;
          |SELECT #2#dscam013;
          #dscam013#16 = #dscam004#17;
          #dscam013#17 = #dscam004#3;
          |LEE 000#dscam013.=;
          |SI FSalida = 0;
               |SI #dscam013#15 = "S"; |O #dscam013#15 = "R";
                    |SI nNumImp = 0;
                         eaTipoOper = "-4";
                    |SINO;
                         eaTipoOper = "-7";
                    |FINSI;
               |SINO;
                    |SI nNumImp = 0;
                         eaTipoOper = "+6-4";
                    |SINO;
                         eaTipoOper = "+6-7";
                    |FINSI;
               |FINSI;
          |FINSI;
          |SELECT #1#dscam013;
          |CIERRA #dscam013;
     |FINSI;

     enDebug = 2; |HAZ ImpreDebug;

     nCobCfr = 0;
     |BUCLE LineasCob;

     enDebug = 3; |HAZ ImpreDebug;
|FPRC;

|PROCESO ImpreDebug;
     |SI nSwImpRec = 1;
          |SI enDebug [ 3;
               #5#0 = #dscam003#32;
               #5#1 = 1;
               |LEE 020#5=;
          |FINSI;
          |SI enDebug = 1;
               enImp1 = #5#4;
          |SINO;
               |SI enDebug = 2;
                    enImp2 = #5#4;
               |SINO;
                    |SI enDebug = 3;
                         enImp3 = #5#4;
                         |PRINT;
                    |SINO;
                         |PRINT;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE RiesgoRecibos;
     #dscam003#12;
     46;
     #12#4, 000000, 000, "01.01.0000", "            ", #0#1, #1#0;
     #12#5, 999999, 999, "31.12.9999", "zzzzzzzzzzzz", #0#2, #1#0;
     ;
     NULL,RiesgoRecibos;
|FIN;

|PROCESO RiesgoFacturas;
     |DFICB Comodin1; |QBF Comodin1;
     Comodin1 = Comodin1 + (("00000" + #dscam045#6) % -105) + "/";
     |PATH_DAT #dscam003#Comodin1#;
     |PATH_DAT #dscam004#Comodin1#;
     |PATH_DAT #dscam013#Comodin1#;

     |ABRE #dscam003; |ABRE #dscam004; |ABRE #dscam013;
     |BUCLE RiesgoRecibos;
     |CIERRA #dscam003; |CIERRA #dscam004; |CIERRA #dscam013;
|FPRC;

|DEFBUCLE RiesgoFacturas;
     #dscam045#1;
     2;
     #dscam038#0, 001, "V";
     #dscam038#0, 999, "V";
     ;
     NULL,RiesgoFacturas;
|FIN;

|PROCESO RiesgoFacNoImp;
   Divisa = #agif134@#58; |HAZ CargaNDeci;

   #dscam023#0 = #agif134@#2;
   |LEE 101#dscam023.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscam023;
      #dscam023#0 = #agif134@#2;
      #dscam023#1 = #agif134@#3;
      |GRABA 020#dscam023.b;
   |FINSI;

   #dscam023#21 = #dscam023#21 + 1;
   |SI #dscam023#22 < #agif134@#1; #dscam023#22 = #agif134@#1; |FINSI;
   |GRABA 020#dscam023.a; |LIBERA #dscam023;

   enEmpCartera = nEmpresa;
   enEmpGestion = #dscam038#0;
   eaCliGest    = #agif134@#2;
   eaTipoR      = "F";
   eaNomCli     = #agif134@#3;
   eaSerie      = #agif134@#49;
   nImporte     = #agif134@#101;
   eaTipoOper   = "+4";
   enBanco      = -1;        || No se toca el riesgo bancario, luego se recalculara
   |HAZ BucleTR;

   enDebug = 4; enNum = #agif134@#0; |HAZ ImpreDebug;

   |HAZ ActualizaTmp;
|FPRC;

|DEFBUCLE RiesgoFacNoImp;
#agif134@#3004;
45;
#dscaz034#1,"01.01.0000",#dscam038#3,000001,"N";
#dscaz034#2,"31.12.9999",#dscam038#4,999999,"N";
;
NULL,RiesgoFacNoImp;
|FIN;

|PROCESO RiesgoFacDNoImp;
   Divisa = #agif084@#65; |HAZ CargaNDeci;

   #dscam023#0 = #agif084@#3;
   |LEE 101#dscam023.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscam023;
      #dscam023#0 = #agif084@#3;
      #dscam023#1 = #agif084@#4;
      |GRABA 020#dscam023.b;
   |FINSI;

   #dscam023#21 = #dscam023#21 + 1;
   |SI #dscam023#22 < #agif084@#1; #dscam023#22 = #agif084@#1; |FINSI;
   |GRABA 020#dscam023.a; |LIBERA #dscam023;

   enEmpCartera = nEmpresa;
   enEmpGestion = #dscam038#0;
   eaCliGest    = #agif084@#3;
   eaTipoR      = "F";
   eaNomCli     = #agif084@#4;
   eaSerie      = #agif084@#48;
   nImporte     = #agif084@#73;
   eaTipoOper   = "+4";
   enBanco      = -1;        || No se toca el riesgo bancario, luego se recalculara
   |HAZ BucleTR;

   enDebug = 5; enNum = #agif084@#0; |HAZ ImpreDebug;

   |HAZ ActualizaTmp;
|FPRC;

|DEFBUCLE RiesgoFacDNoImp;
#agif084@#3004;
10;
#dscaz034#1,"01.01.0000",#dscam038#3,000001,"N";
#dscaz034#2,"31.12.9999",#dscam038#4,999999,"N";
;
NULL,RiesgoFacDNoImp;
|FIN;

|PROCESO ControlRiesgos;
   |SALVA_FICHA #dscam038;
   #dscam037#0 = #dscam038#0;
   |LEE 000#dscam037.=;

   Comodin = #dscam037#2; |QBF Comodin;
   Comodin1 = Comodin + "fich/" + (("00000" + #dscam038#0) % -105) + "/";
   Comodin1 = Comodin1 + "agifa066.dat";
   |XABRE "E",Comodin1,Handle;
   |SI FSalida ! 0;
      Comodin1 = Comodin + "fich/" + (("00" + #dscam038#0) % -102) + "/";
   |SINO;
      Comodin1 = Comodin + "fich/" + (("00000" + #dscam038#0) % -105) + "/";
   |FINSI;
   |XCIERRA Handle;

   |PATH_DAT #500 Comodin1; |ABRE #500;
   |PATH_DAT #501 Comodin1; |ABRE #501;
   |PATH_DAT #502 Comodin1; |ABRE #502;
   |PATH_DAT #503 Comodin1; |ABRE #503;
   |PATH_DAT #504 Comodin1; |ABRE #504;
   |PATH_DAT #505 Comodin1; |ABRE #505;
   |PATH_DAT #506 Comodin1; |ABRE #506;
   |PATH_DAT #507 Comodin1; |ABRE #507;
   |PATH_DAT #514 Comodin1; |ABRE #514;
   |HAZ EsTaller;
   |SI FSalida = 0;
      |PATH_DAT #508 Comodin1; |ABRE #508;
      |PATH_DAT #509 Comodin1; |ABRE #509;
      |PATH_DAT #510 Comodin1; |ABRE #510;
      |PATH_DAT #511 Comodin1; |ABRE #511;
      |PATH_DAT #512 Comodin1; |ABRE #512;
      |PATH_DAT #513 Comodin1; |ABRE #513;
   |FINSI;
   |SI nSwTagloma = 0;
      |PATH_DAT #tagm0030@#Comodin1#;
   |FINSI;

   |DFICB Comodin1; |QBF Comodin1;
   Comodin1 = Comodin1 + (("00000" + #dscam038#5) % -105) + "/";
   |PATH_DAT #4 Comodin1; |PATH_DAT #5 Comodin1;
   |ABRET #dscam023; |ABRET #dscam024;

   |SI #dscam038#8 = "A";
      |BUCLE RiesgoAdel;
      |BUCLE RiesgoPedidos;
      |SI nSwTagloma = 0;
          |BUCLE RiesgoBlock;
      |FINSI;
      |BUCLE RiesgoAlbaranes;
      |HAZ EsTaller;
      |SI FSalida = 0;
         |BUCLE RiesgoOR;
      |FINSI;
      |ABRE #dscam051;
      |LEE 000#dscam051.p;
      |SI FSalida ! 0;
         |DDEFECTO #dscam051; |GRABA 020#dscam051.n;
         |LEE 000#dscam051.p;
      |FINSI;
      aOpcion = #dscam051#3;
      #dscam051#3 = "S"; |GRABA 020#dscam051.a;
      |CIERRA #dscam051;

      |BUCLE RiesgoFacNoImp;
      |BUCLE RiesgoFacDNoImp;
      |BUCLE RiesgoFacturas;  || cartera

      |ABRE #dscam051; |LEE 000#dscam051.p;
      #dscam051#3 = aOpcion; |GRABA 020#dscam051.a;
      |CIERRA #dscam051;
   |SINO;
      |BUCLE RiesgoAdel;
      |SI #dscam038#2 = "P";
             |BUCLE RiesgoPedidos;
             |SI nSwTagloma = 0;
                 |BUCLE RiesgoBlock;
             |FINSI;
      |FINSI;
      |SI #dscam038#2 = "A";
         |BUCLE RiesgoAlbaranes;
         |HAZ EsTaller;
         |SI FSalida = 0;
            |BUCLE RiesgoOR;
         |FINSI;
      |FINSI;
      |SI #dscam038#2 = "F";
         |ABRE #dscam051;
         |LEE 000#dscam051.p;
         |SI FSalida ! 0;
            |DDEFECTO #dscam051; |GRABA 020#dscam051.n;
            |LEE 000#dscam051.p;
         |FINSI;
         aOpcion = #dscam051#3;
         #dscam051#3 = "S"; |GRABA 020#dscam051.a;
         |CIERRA #dscam051;

         |SI nSwImpRec = 1; |IMPRE 0; |INFOR "dscazrie"; |FINSI; || pruebas

         |BUCLE RiesgoFacNoImp;
         |BUCLE RiesgoFacDNoImp;

         |BUCLE RiesgoFacturas;    ||cartera

         |SI nSwImpRec = 1; |PIEINF; |FININF; |FINIMP; |FINSI;   || pruebas

         |ABRE #dscam051; |LEE 000#dscam051.p;
         #dscam051#3 = aOpcion; |GRABA 020#dscam051.a;
         |CIERRA #dscam051;
      |FINSI;
   |FINSI;

   |HAZ EsTaller;
   |SI FSalida = 0;
      |CIERRA #512; |CIERRA #509; |CIERRA #508;
      |CIERRA #510; |CIERRA #511;
   |FINSI;
   |CIERRA #506; |CIERRA #507; |CIERRA #514;
   |CIERRA #505; |CIERRA #504; |CIERRA #503;
   |CIERRA #502; |CIERRA #501; |CIERRA #500;
   |CIERRAT #dscam023; |CIERRAT #dscam024;
   |REPON_FICHA #dscam038;
|FPRC;

|DEFBUCLE ControlRiesgos;
#dscam038#2;
;
nEmpresa,00001," ",001;
nEmpresa,99999,"z",999;
;
NULL,ControlRiesgos;
|FIN;

|PROCESO AceraRiesgos1;
   #dscam023#0 = #dscam024#0;
   |LEE 000#dscam023.=;
   |SI FSalida ! 0; |DDEFECTO #dscam023; |FINSI;

   #dscaw089#0 = #dscam024#0;
   #dscaw089#1 = #dscam024#1;
   |LEE 000#dscaw089.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscaw089;
      #dscaw089#0 = #dscam024#0;
      #dscaw089#1 = #dscam024#1;
      #dscaw089#4 = #dscam024#2;
      #dscaw089#5 = #dscam024#3;
      #dscaw089#6 = #dscam024#4;
      #dscaw089#7 = #dscam024#6;
      #dscaw089#8 = #dscam024#7;
      #dscaw089#9 = #dscam024#5;
      |GRABA 020#dscaw089.n;
   |FINSI;

   #dscam024#2 = 0;
   #dscam024#3 = 0;
   #dscam024#4 = 0;
   #dscam024#5 = 0;
   #dscam024#6 = 0;
   #dscam024#7 = 0;
   #dscam024#8 = 0;
   #dscam024#9 = 0;
   |GRABA 020#dscam024.a;

   #dscam023#0 = #dscam024#0;
   |LEE 101#dscam023.=;
   |SI FSalida = 0;
      #dscam023#19 = #dscam023#13 + #dscam023#15 + #dscam023#17;
      #dscam023#20 = 0;
      #dscam023#21 = 0;
      #dscam023#22 = "31.12.9999";
      |GRABA 020#dscam023.a; |LIBERA #dscam023;
   |FINSI;
|FPRC;

|DEFBUCLE AceraRiesgos1;
#dscam024#1;
;
#dscaz034#1,#dscam038#6;
#dscaz034#2,#dscam038#6;
be;
NULL,AceraRiesgos1;
|FIN;

|PROCESO AceraRiesgos;
   |DFICB Comodin1; |QBF Comodin1;
   Comodin1 = Comodin1 + (("00000" + #dscam038#5) % -105) + "/";
   |PATH_DAT #4 Comodin1; |PATH_DAT #5 Comodin1;
   |ABRET #dscam023; |ABRET #dscam024;
   |BUCLE AceraRiesgos1;
   |CIERRAT #dscam023; |CIERRAT #dscam024;
|FPRC;

|DEFBUCLE AceraRiesgos;
#dscam038#2;
;
nEmpresa, 00001, " ", 001;
nEmpresa, 99999, "z", 999;
;
NULL,AceraRiesgos;
|FIN;

|PROCESO RevisaFechaPriFra1;
   #dscam023#0 = #dscam024#0;
   |LEE 101#dscam023.=;
   |SI FSalida = 0;
      |SI #dscam023#22 = "31.12.9999";
         #dscam023#22 = "01.01.0000";
         |GRABA 020#dscam023.a; |LIBERA #dscam023;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE RevisaFechaPriFra1;
#dscam024#1;
;
#dscaz034#1,#dscam038#6;
#dscaz034#2,#dscam038#6;
be;
NULL,RevisaFechaPriFra1;
|FIN;

|PROCESO RevisaFechaPriFra;
   |DFICB Comodin1; |QBF Comodin1;
   Comodin1 = Comodin1 + (("00000" + #dscam038#5) % -105) + "/";
   |PATH_DAT #4 Comodin1; |PATH_DAT #5 Comodin1;
   |ABRET #dscam023; |ABRET #dscam024;
   |BUCLE RevisaFechaPriFra1;
   |CIERRAT #dscam023; |CIERRAT #dscam024;
|FPRC;

|DEFBUCLE RevisaFechaPriFra;
#dscam038#2;
;
nEmpresa, 00001, " ", 001;
nEmpresa, 99999, "z", 999;
;
NULL,RevisaFechaPriFra;
|FIN;

|PROCESO RiesgoLin;
   |SI Modo = 1;
      |SELECT #4#dscam038;
      #dscam038#5 = #48#0;
      #dscam038#6 = #dscam024#1;
      #dscam038#0 = 0;
      #dscam038#1 = 1;
      |LEE 000#dscam038.];
      |SI FSalida = 0; |Y #dscam038#5 = #48#0; |Y #dscam038#6 = #dscam024#1;
         |SI #dscam038#8 = "R";
            #dscam024#8 = #dscam024#2 + #dscam024#3 + #dscam024#4 + #dscam024#6 + #dscam024#7 - #dscam024#5;
            RiesgoUtil = RiesgoUtil + #dscam024#8;
         |FINSI;
      |FINSI;
      |SELECT #1#dscam038;

      |SI #dscam038#8 = "R";
         #dscaw089#0 = #dscam024#0;
         #dscaw089#1 = #dscam024#1;
         |LEE 000#dscaw089.=;
         |SI FSalida = 0;
            #dscaw089#3 = #dscam023#19 - RiesgoUtil;
            |GRABA 020#dscaw089.a;
         |FINSI;
      |FINSI;
   |FINSI;
   |SI Modo = 2;
      ||SI #dscam024#8 = 0; #dscam024#8 = RiesgoUtil; |FINSI;
      #dscam024#9 = #dscam023#19 - RiesgoUtil;
   |FINSI;
   |GRABA 020#dscam024.a;
   |SI Modo = 1; |HAZ ActualizaTmp; |FINSI;
|FPRC;

|DEFBUCLE RiesgoLineas;
#dscam024#1;
;
#dscam023#0,01;
#dscam023#0,99;
be;
NULL,RiesgoLin;
|FIN;

|PROCESO RecalculaRie;
   RiesgoUtil = 0;
   Modo = 1; |BUCLE RiesgoLineas;
   #dscam023#20 = RiesgoUtil; |GRABA 020#dscam023.a;
   Modo = 2; |BUCLE RiesgoLineas;
|FPRC;

|DEFBUCLE RecalculaRie;
#dscam023#1;
;
#dscaz034#1;
#dscaz034#2;
be;
NULL,RecalculaRie;
|FIN;

|PROCESO LineasRemesas;
   |SI #dscam013#15 = "N";
      |SI #dscam012#22 = 2; |O #dscam012#22 = 4;
         |SI #dscam012#8 = "S";
            #dscam014#13 = #dscam014#13 + #dscam013#7;
            #dscam014#41 = #dscam014#12 + #dscam014#13;
         |FINSI;
      |SINO;
         |SI #dscam012#22 ! 1; |Y #dscam012#22 ! 3;
            #dscam014#13 = #dscam014#13 + #dscam013#7;
            #dscam014#41 = #dscam014#12 + #dscam014#13;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE LineasRemesas;
#dscam013#1;
;
#dscam012#0,001;
#dscam012#0,999;
;
NULL,LineasRemesas;
|FIN;

|PROCESO LeeRemesas;
   |BUCLE LineasRemesas;
|FPRC;

|DEFBUCLE LeeRemesas;
#dscam012#1;
2;
00001,#dscam014#0;
99999,#dscam014#0;
;
NULL,LeeRemesas;
|FIN;

|PROCESO RiesgoBancos;
   #dscam014#13 = 0;
   |BUCLE LeeRemesas;
   |GRABA 020#dscam014.a;
|FPRC;

|DEFBUCLE RiesgoBancos;
#dscam014#1;
;
#dscaz034#6;
#dscaz034#7;
;
NULL,RiesgoBancos;
|FIN;

|PROCESO RecalcRiesgos;
   |BUCLE AceraRiesgos;

   Comodin = #48#17; |QBF Comodin;
   ||Comodin1 = Comodin + "def/agifa010.mas";
   Fichero = "Albaranes"; Tipo = "G"; Cmp = ""; |HAZ ObtenFich;
   Comodin1 = Comodin + "def/" + Fichero + ".mas";
   |CARGA_DEF Comodin1, agif010@;
   |SI FSalida = 0;
      |HAZ EsTaller;
      |SI FSalida = 0;
         Comodin1 = Comodin + "def/con00625.mas";
         |CARGA_DEF Comodin1, con0625@;
         Comodin1 = Comodin + "def/con00626.mas";
         |CARGA_DEF Comodin1, con0626@;
         Comodin1 = Comodin + "def/con00603.mas";
         |CARGA_DEF Comodin1, con0603@;
         Comodin1 = Comodin + "def/agifa019.mas";
         |CARGA_DEF Comodin1, agif019@;
         Comodin1 = Comodin + "def/con00606.mas";
         |CARGA_DEF Comodin1, con0606@;
         Comodin1 = Comodin + "def/con00683.mas";
         |CARGA_DEF Comodin1, con0683@;
      |FINSI;
      Comodin1 = Comodin + "def/agifa007.mas";
      |CARGA_DEF Comodin1, agif007@;
      Fichero = "Pedidos"; Tipo = "G"; Cmp = ""; |HAZ ObtenFich;
      Comodin1 = Comodin + "def/" + Fichero + ".mas";
      |CARGA_DEF Comodin1, agif104@;
      Fichero = "Pedidos Lins."; Tipo = "G"; Cmp = ""; |HAZ ObtenFich;
      Comodin1 = Comodin + "def/" + Fichero + ".mas";
      |CARGA_DEF Comodin1, agif073@;
      Comodin1 = Comodin + "def/agifa024.mas"; |CARGA_DEF Comodin1, agif024@;
      Comodin1 = Comodin + "def/agifa066.mas"; |CARGA_DEF Comodin1, agif066@;
      Comodin1 = Comodin + "def/agifa134.mas"; |CARGA_DEF Comodin1, agif134@;
      Comodin1 = Comodin + "def/agifa084.mas"; |CARGA_DEF Comodin1, agif084@;
      Comodin1 = Comodin + "def/agis0002.mas"; |CARGA_DEF Comodin1, agis002@;
      |SI nSwTagloma = 0;
          Comodin1 = Comodin + "def/tagm0030.mas"; |CARGA_DEF Comodin1, tagm0030@;
      |FINSI;

      |SI #dscaz034#5 = "C"; |O #dscaz034#5 = "A";
          |BUCLE ControlRiesgos;
          |BUCLE RecalculaRie;
      |FINSI;
      |SI #dscaz034#5 = "B"; |O #dscaz034#5 = "A";
          |DFICE aAlfa; |QBF aAlfa; |PATH_DAT #dscam013#aAlfa#;
          |BUCLE RiesgoBancos;
      |FINSI;

      |SI nSwTagloma = 0;
          |DESCARGA_DEF #tagm0030@;
      |FINSI;
      |DESCARGA_DEF #agis002@;
      |DESCARGA_DEF #agif084@;
      |DESCARGA_DEF #agif134@;
      |DESCARGA_DEF #agif066@;
      |DESCARGA_DEF #agif024@;
      |DESCARGA_DEF #agif073@;
      |DESCARGA_DEF #agif104@;
      |DESCARGA_DEF #agif007@;
      |HAZ EsTaller;
      |SI FSalida = 0;
         |DESCARGA_DEF #con0683@;
         |DESCARGA_DEF #con0606@;
         |DESCARGA_DEF #agif019@;
         |DESCARGA_DEF #con0603@;
         |DESCARGA_DEF #con0626@;
         |DESCARGA_DEF #con0625@;
      |FINSI;
      |DESCARGA_DEF #agif010@;
   |FINSI;

   |BUCLE RevisaFechaPriFra;
|FPRC;

|PROCESO EnviaCorreo;
   |DFICE aAlfa; |QBF aAlfa;
   aFichero = aAlfa + "spool.txt";

   aAlfa = #dscam051#81; |QBF aAlfa;
   aAlfa = aAlfa + "." + #dscam051#82; |QBF aAlfa;
   aAlfa = aAlfa + "." + #dscam051#83; |QBF aAlfa;
   aAlfa = aAlfa + "." + #dscam051#84; |QBF aAlfa;
   |SI aAlfa = "0.0.0.0"; |ACABA; |FINSI;

   aDsCorreoIP = aAlfa;
   aDirOrigen  = #dscam051#90;
   aDirDestino = #dscam051#91;

   aAlfa = #dscaz034#3; |QBF aAlfa;
   |SI PARAMETRO = ""; |Y aAlfa ! "";
      aDirDestino = #dscaz034#3;
   |FINSI;
   |SI PARAMETRO ! "";
      aSaca = PARAMETRO; |QBF aSaca;
      aSaca = aSaca - "EMAIL=";
      |SI FSalida ! 0;
         |SI aSaca ! "";
            aDirDestino = aSaca;
         |SINO;
            || NO envia el informe a NADIE
            |ACABA;
         |FINSI;
      |FINSI;
   |FINSI;

   aServidor   = #dscam051#88; |QBF aServidor;
   aAsunto     = " Resultado recalculo riesgos ";
   aTexto      = "$$$$" + aFichero;
   |SI #dscam051#89 = "S";
      eaEntrada = #dscam051#92; |HAZ Encriptado;
      aAlfa = eaSalida;             |QBF aAlfa; aAlfa = aAlfa + ":";
      aAlfa = aAlfa + #dscam051#86; |QBF aAlfa; aAlfa = aAlfa + ":";
      aDirOrigen = aAlfa + aDirOrigen;
   |FINSI;

   |DSCORREO_ENVIA aDsCorreoIP, aServidor, aDirOrigen, aDirDestino, aAsunto, aTexto, aFichero;
   |SI FSalida < 0;
      |MENAV "    Problemas al enviar correo";
   |FINSI;
|FPRC;

|PROGRAMA;
   |HAZ EsLuxe;
   |SI FSalida = 0; nSwLuxe = 1; |SINO; nSwLuxe = 0; |FINSI;

   |HAZ EsArtenvas; nSwArtenvas = FSalida;
   |HAZ EsTagloma; nSwTagloma = FSalida;

   |SI PARAMETRO ! "";
      |DDEFECTO #dscaz034;
      aAlfa = PARAMETRO; |QBF aAlfa;
      aAlfa = aAlfa - ",INFORME";
      |SI FSalida ! 0;
         #dscaz034#0 = "S";
         |SI aAlfa = "";
            |DFICE aAlfa; |QBF aAlfa;
         |FINSI;
      |SINO;
         #dscaz034#0 = "N";
      |FINSI;

      aAlfa = PARAMETRO; |QBF aAlfa;
      aAlfa = aAlfa - "EMAIL=";
      |SI FSalida ! 0;
          #dscaz034#0 = "S";
      |FINSI;

      |HAZ Tipo8;
/*
      |QBF aAlfa;
      aAlfa1 = aAlfa % -101;
      |SI aAlfa1 ! "/"; aAlfa = aAlfa + "/"; |FINSI;

      |PATH_DAT #0 aAlfa; |PATH_DAT #2 aAlfa;
      |PATH_DAT #3 aAlfa; |PATH_DAT #4 aAlfa;
      |PATH_DAT #5 aAlfa;
      |PATH_DAT #7 aAlfa; |PATH_DAT #8 aAlfa;
      |PATH_DAT #9 aAlfa; |PATH_DAT #10 aAlfa;
*/
      #0#1 = "      ";
      #0#2 = "zzzzzz";
      #0#3 = #dscam051#91;
      #0#5 = "A";
      eaSinAlta = "S";
      FSalida = 0;
      |ATRI I; |PINTA 2310, "Ejecutando el recalculo de riesgos"; |ATRI N;
   |SINO;
      |ABRE #dscam051;
      |LEE 000#dscam051.p;
      |CIERRA #dscam051;

      |SI #dscam051#3 = "N";
         |MENAV "    No esta activado el control de riesgos. Proceso abortado.";
         |ACABA;
      |FINSI;

      #dscaz034#3 = #dscam051#91;

      |CLS;
      |HAZ Tipo8;
      eaSinAlta = "S";
      |CABEZA "Recalculo riesgos";
      |PINPA #0#0; |PINDA #0#0;
      |ENDATOS #1#0;
   |FINSI;

   |SI FSalida = 0;
      |DBASE Comodin;  Comodin = Comodin + "fich/";
      |PATH_DAT #1  Comodin; |PATH_DAT #6  Comodin;
      |PATH_DAT #11 Comodin; |PATH_DAT #12 Comodin;
      |ABRE #dscam038; |ABRE #dscam037;

      aAlfa = "r1" + Usuario; |NOME_DAT #dscaw089#aAlfa#;
      |DELINDEX #dscaw089; |ABRE #dscaw089;

      |SI #dscaz034#0 = "S";
         nEmpresa = #48#0; |HAZ RecalcRiesgos;

         |SI PARAMETRO ! "";
            |DFICE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "spool.txt";
            Impresora = aAlfa;
            |IMPRE -77;
         |SINO;
            aAlfa = #dscaz034#3; |QBF aAlfa;
            |SI aAlfa = "";
               |IMPRE 0;
            |SINO;
               |DFICE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "spool.txt";
               Impresora = aAlfa;
               |IMPRE -77;
            |FINSI;
         |FINSI;
         |SI FSalida = 0;
            |INFOR "dscaz034";
            |SI FSalida = 0;
               |BUCLE RevisaRiesgos;
               |PIEINF; |FININF;
            |FINSI;
            |FINIMP;
         |FINSI;
         |SI PARAMETRO ! "";
            |HAZ EnviaCorreo;
         |SINO;
            aAlfa = #dscaz034#3; |QBF aAlfa;
            |SI aAlfa ! "";
               |HAZ EnviaCorreo;
            |FINSI;
         |FINSI;
      |SINO;
         nEmpresa = #48#0; |HAZ RecalcRiesgos;
      |FINSI;

      |CIERRA #dscaw089;
      |CIERRA #dscam037; |CIERRA #dscam038;
   |FINSI;

   |ATRI I; |PINTA 2310, "                                  "; |ATRI N;
   |SI PARAMETRO = ""; |HAZ Tipo9; |FINSI;
|FPRO;
