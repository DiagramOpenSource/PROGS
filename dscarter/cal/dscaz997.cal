|FICHEROS;
   dscaz997 #0;

   dscam003 #10;
   dscam004 #11;

   dscam051 #50;
   dscam067 #51;
   dscaw013 #52;

   dscaw999 #100;
|FIN;

|VARIABLES;
   &eaPrint = "";
   &eaTipoOper = "";
   &eaTipoOp  = "";
   &eaTipoReg = "";
   &eaUsuario = "";
   &eaSerie   = "";
   &eaNumero  = "";
   &eaDescr   = "";
   &eaFicher  = "";
   &eaClave   = "";
   &eaCliGest = "";
   &enImpAnt  = 0;
   &enImpAct  = 0;
   &enEmpCartera = 0;
   &enEmpGestion = 0;

   aAlfa   = "";
   aTipoOp = "";
   aOper   = "";
   aOper1  = "";
   aOper2  = "";
   Comodin = "";
   Clave1  = "";
   Clave2  = "";
   Clave3  = "";

   nSwIncid    = 0;
   ModoEntrada = 0;
   FEstado     = 0;
   nImporte    = 0;
   nCalc       = 0;
   nCodigo     = 0;
   nLinea      = 0;
   nCuentaCobs = 0;
   nNumSec     = 0;
   Modo1       = 0;
   nRecEntrega = 0;
|FIN;

|PROCESO CuentaCobs;
   nCuentaCobs = nCuentaCobs + 1;
|FPRC;

|DEFBUCLE CuentaCobs;
#dscam004#3;
5;
nCodigo,aOper1;
nCodigo,aOper2;
;
NULL,CuentaCobs;
|FIN;

|PROCESO Movimientos;
   || Miro un saldado con el documento 0
   aAlfa = #dscam004#16; |QBF aAlfa;
   aAlfa = aAlfa - "Cobro Doc. ";
   |SI FSalida ! 0;
      nCalc = aAlfa;
      |SI nCalc = 0;
         |SALVA_FICHA #dscam004;
         || Si lo tiene, compruebo si es el ultimo movimiento del recibo ...
         |LEE 000#dscam004.s;
         |SI FSalida ! 0; |O #dscam004#17 ! #dscam003#40;
            |REPON_FICHA #dscam004;
            || Si lo es, lo elimino y dejo la entrega como pendiente de saldar

            aTipoOp = #dscam004#5; nNumSec = #dscam004#43;
            Comodin = #dscam004#16; |QBF Comodin; Comodin = Comodin % -109;
            nRecEntrega = Comodin;

            eaUsuario = Usuario % 0810;
            eaTipoReg = "CB";  eaNumero = ("000000000" + #dscam003#40) % -109;

            eaDescr   = "BAJA COMP.ENTREGA";
            eaDescr   = eaDescr + " (" + #dscam003#0 + "/";
            eaDescr   = eaDescr + #dscam003#1 + "/" + #dscam003#2 + ") DESDE LINEAS DE RECIBOS";
            eaTipoOp  = "B";   enImpAnt = #dscam003#61;
            eaFicher = "dscam003"; eaClave = #dscam003#40;
            enImpAct  = #dscam003#23 - #dscam004#8; |HAZ GrabaAudit;

            #dscam004#21 = "*"; |GRABA 020#dscam004.a;
            |SI #dscam051#1 = "S";
               |ABRE #dscam067;
               #dscam067#8 = 0;
               #dscam067#9 = 0;
               #dscam067#0 = "CB";
               #dscam067#1 = #dscam004#17;
               #dscam067#2 = #dscam004#3;
               #dscam067#3 = "";
               #dscam067#11 = 1;
               |LEE 000#dscam067.];
               FEstado = FSalida;
               Clave1 = #dscam067#1; Clave2 = #dscam067#2;
               Clave3 = #dscam067#3; |QBF Clave3;
               |PARA; |SI FEstado = 0; |Y Clave1 = #dscam004#17; |HACIENDO;
                  |SI Clave1 = #dscam004#17; |Y Clave2 = #dscam004#3; |Y Clave3  = "";
                      |SAL;
                  |FINSI;
                  |LEE 000#dscam067.s;
                  FEstado = FSalida;
                  Clave1 = #dscam067#1; Clave2 = #dscam067#2;
                  Clave3 = #dscam067#3; |QBF Clave3;
               |SIGUE;

               |SI FEstado = 0; |Y Clave1 = #dscam004#17; |Y Clave2 = #dscam004#3;
                |Y Clave3  = "";
                   Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
                   |NOME_DAT #dscaw013#Comodin#;
                   |DELINDEX #dscaw013; |ABRE #dscaw013;

                   |SI #dscam004#43 = 0;
                      |DDEFECTO #dscaw013;
                      #dscaw013#15 = #dscam067#10; #dscaw013#0 = 1;
                      #dscaw013#13 = "dscam004";   #dscaw013#14 = 17;
                      #dscaw013#11 = "N";          #dscaw013#12 = 9;
                      #dscaw013#5 = #dscam004#17;  #dscaw013#6 = #dscam004#17;
                      |GRABA 020#dscaw013.n;

                      |DDEFECTO #dscaw013;
                      #dscaw013#15 = #dscam067#10; #dscaw013#0 = 2;
                      #dscaw013#13 = "dscam004";   #dscaw013#14 = 3;
                      #dscaw013#11 = "N";          #dscaw013#12 = 3;
                      #dscaw013#5 = #dscam004#3;   #dscaw013#6 = #dscam004#3;
                      |GRABA 020#dscaw013.n;

                      |DDEFECTO #dscaw013;
                      #dscaw013#15 = #dscam067#10; #dscaw013#0 = 3;
                      #dscaw013#13 = "dscam004";   #dscaw013#14 = 6;
                      #dscaw013#11 = "F";          #dscaw013#12 = 10;
                      #dscaw013#7 = #dscam004#6;   #dscaw013#8 = #dscam004#6;
                      |GRABA 020#dscaw013.n;

                      |LIBERA #dscaw013; |CIERRA #dscaw013;
                      Comodin = #dscam067#10;
                      |SI nNumSec = 0; Modo1 = ",B"; |SINO; Modo1 = ""; |FINSI;
                      Comodin = "dscam033.tab;" + Comodin + Modo1;
                      |LIBERA #dscam003; |CIERRAT #dscam003;
                      |LIBERA #dscam004; |CIERRAT #dscam004;
                      |SUB_EJECUTA_NP Comodin;
                      |ABRET #dscam003; |LEE 101#dscam003.=;
                      |ABRET #dscam004; |LEE 101#dscam004.=;
                   |SINO;
                      |SALVA_FICHA #dscam004;
                      nCodigo = #dscam004#43;
                      aOper1  = #dscam004#5; aOper2  = #dscam004#5;
                      |SI aOper1 = "COB"; |O aOper1 = "COP";
                         aOper1 = "COB"; aOper2 = "COP";
                      |FINSI;
                      nCuentaCobs = 0;
                      |BUCLE CuentaCobs;
                      |LEE 000#dscam004.p; |REPON_FICHA #dscam004;
                      |SI nCuentaCobs = 1;
                         Modo1 = ",B";
                      |SINO;
                         |SALVA_DATOS #dscam004; |BORRA 020#dscam004.a;
                         Modo1 = "";
                      |FINSI;

                      |DDEFECTO #dscaw013;
                      #dscaw013#15 = #dscam067#10; #dscaw013#0 = 1;
                      #dscaw013#13 = "dscam004";   #dscaw013#14 = 43;
                      #dscaw013#11 = "N";          #dscaw013#12 = 9;
                      #dscaw013#5 = #dscam004#43;  #dscaw013#6 = #dscam004#43;
                      |GRABA 020#dscaw013.n;

                      |DDEFECTO #dscaw013;
                      #dscaw013#15 = #dscam067#10; #dscaw013#0 = 2;
                      #dscaw013#13 = "dscam004";   #dscaw013#14 = 5;
                      #dscaw013#11 = "A";          #dscaw013#12 = 3;
                      |SI #dscam004#5 = "COB"; |O #dscam004#5 = "COP";
                         #dscaw013#3 = "COB";  #dscaw013#4 = "COP";
                      |SINO;
                         #dscaw013#3 = #dscam004#5;  #dscaw013#4 = #dscam004#5;
                      |FINSI;
                      |GRABA 020#dscaw013.n;

                      |DDEFECTO #dscaw013;
                      #dscaw013#15 = #dscam067#10; #dscaw013#0 = 3;
                      #dscaw013#13 = "dscam004";   #dscaw013#14 = 6;
                      #dscaw013#11 = "F";          #dscaw013#12 = 10;
                      #dscaw013#7 = #dscam004#6;   #dscaw013#8 = #dscam004#6;
                      |GRABA 020#dscaw013.n;
                      |LIBERA #dscaw013; |CIERRA #dscaw013;

                      Comodin = #dscam067#10;
                      Comodin = "dscam033.tab;" + Comodin + Modo1;
                      |SI aOper = "RTA"; Comodin = Comodin + ",V"; |FINSI;
                      |LIBERA #dscam003; |CIERRAT #dscam003;
                      |LIBERA #dscam004; |CIERRAT #dscam004;
                      |SUB_EJECUTA_NP Comodin;
                      |ABRET #dscam003; |LEE 101#dscam003.=;
                      |ABRET #dscam004; |LEE 101#dscam004.=;

                      |SI Modo1 = "";
                         |REPON_DATOS #dscam004;
                         |GRABA 020#dscam004.c;
                         |BORRA 020#dscam067.a;
                      |FINSI;
                   |FINSI;

                   |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".dat"; |FBORRA aAlfa;
                   |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ddx"; |FBORRA aAlfa;
                   |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ixx"; |FBORRA aAlfa;
                |FINSI;
                |CIERRA #dscam067;
             |SINO;
                |ABRE #dscam067;
                #dscam067#8 = 0;
                #dscam067#9 = 0;
                #dscam067#0 = "CB";
                #dscam067#1 = #dscam004#17;
                #dscam067#2 = #dscam004#3;
                #dscam067#3 = "";
                #dscam067#11 = 1;
                |LEE 000#dscam067.];
                FEstado = FSalida;
                Clave1 = #dscam067#1; Clave2 = #dscam067#2;
                Clave3 = #dscam067#3; |QBF Clave3;
                |SI Clave1 = #dscam004#17; |Y Clave2 = #dscam004#3; |Y Clave3  = "";
                   |MENAV "    Ha modificado un efecto contabilizado. Debera volver a ejecutar el enlace ";
                |FINSI;
                |CIERRA #dscam067;
             |FINSI;

             #dscam003#56 = #dscam003#56 - #dscam004#24;
             #dscam003#23 = #dscam003#23 - #dscam004#8; #dscam003#61 = #dscam003#61 - #dscam004#26;
             #dscam003#30 = #dscam003#30 - #dscam004#8; #dscam003#64 = #dscam003#64 - #dscam004#26;
             |SI #dscam004#22 = "D";
                #dscam003#54 = #dscam003#54 - #dscam004#23; #dscam003#67 = #dscam003#67 - #dscam004#32;
             |SINO;
                #dscam003#55 = #dscam003#55 - #dscam004#23; #dscam003#68 = #dscam003#68 - #dscam004#32;
             |FINSI;
             #dscam003#24 = #dscam003#24 - #dscam004#12; #dscam003#62 = #dscam003#62 - #dscam004#29;
             #dscam003#25 = #dscam003#25 - #dscam004#13; #dscam003#63 = #dscam003#63 - #dscam004#30;
             #dscam003#38 = #dscam003#38 - #dscam004#14; #dscam003#66 = #dscam003#66 - #dscam004#31;

             |SI #dscam003#30 ! 0;
                |SI #dscam003#55 = 0;
                   #dscam003#14 = "e";
                   #dscam003#15 = "Pendiente de compensar";
                |SINO;
                   #dscam003#14 = "E";
                   #dscam003#15 = "Compensado parcialmente";
                |FINSI;
             |FINSI;

             |SI #dscam004#54 ! 0; #dscam003#12 = #dscam004#54; |FINSI;
             |SALVA_FICHA #dscam004;
             |LEE 000#dscam004.a;
             |SI FSalida = 0;
                |SI #dscam004#17 = #dscam003#40;
                   #dscam003#26 = #dscam004#6;
                |SINO;
                   #dscam003#26 = "01.01.0000";
                |FINSI;
                |LEE 000#dscam004.s;
             |SINO;
                #dscam003#26 = "01.01.0000";
             |FINSI;
             |REPON_FICHA #dscam004;
             |GRABA 020#dscam003.a;

             || enEmpCartera = #48#0; enEmpGestion = #dscam003#46;
             enEmpCartera = -1;     enEmpGestion = #dscam003#46;
             eaSerie = #dscam003#0; eaCliGest = #dscam003#32;
             nImporte = #dscam004#8; eaTipoOper = "+4";
             |HAZ BucleRiesgo;
             |BORRA 020#dscam004.a;
         |SINO;
             |REPON_FICHA #dscam004;
             || Si no lo es, dejo apunte en el informe final

             nSwIncid = 1;
             |DDEFECTO #dscaw999;
             #dscaw999#0 = nLinea; nLinea = nLinea + 1;
             aAlfa = "   La entrega " + #dscam003#40 + " tiene un importe saldado con el documento 0 pero no es el ultimo movimiento";
             #dscaw999#1 = aAlfa;
             |GRABA 020#dscaw999.n;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Movimientos;
#dscam004#1;
;
#dscam003#40, 01;
#dscam003#40, 99;
;
NULL, Movimientos;
|FIN;

|PROCESO Recibos;
   || Reviso los movimientos
   |BUCLE Movimientos;
|FPRC;

|DEFBUCLE Recibos;
#dscam003#6;
;
00, #dscaz997#0, #dscaz997#1, 000, "!", #dscaz997#2;
99, #dscaz997#3, #dscaz997#4, 999, "z", #dscaz997#5;
;
NULL, Recibos;
|FIN;

|PROCESO Incidencias;
   eaPrint = #dscaw999#1; |QBF eaPrint;
   |PRINT;
|FPRC;

|DEFBUCLE Incidencias;
#dscaw999#1;
;
INICIO;
FINAL;
;
NULL, Incidencias;
|FIN;

|PROGRAMA;
   |HAZ Tipo8;

   |CLS;
   |CABEZA "Deshazcer compensacion automatica documento cero";


   aAlfa = "tm" + Usuario; |NOME_DAT #dscaw999#aAlfa#;
   |DELINDEX #dscaw999; |ABRE #dscaw999;

   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0; |Y #dscaz997#6 = "S";
      nLinea = 1;
      |BUCLE Recibos;
      |SI nSwIncid ! 0;
         |IMPRE 0;
         |SI FSalida = 0;
            |INFOR "dscaz997";
            |SI FSalida = 0;
               |BUCLE Incidencias;
               |PIEINF; |FININF;
            |FINSI;
            |FINIMP;
         |FINSI;
      |FINSI;
   |FINSI;
   |CIERRA #dscaw999; |DELINDEX #dscaw999;

   |HAZ Tipo9;
|FPRO;
