|FICHEROS;
   dscaz004 #0;
   dscaz005 #1,MANTE;
   dscam003 #2;
   dscam008 #3;
   dscaz006 #4,MANTE;
   dscaz019 #5,MANTE;
   dscam004 #6;
   dscam009 #7;
   dscam014 #8;
   dscam051 #10;
   dscam081 #11;
   dscam082 #12;
   dscam013 #15;

   dscam067 #13;
   dscaw013 #14;

   &agif024@ #100;
   &caclipr@ #101;
   agifa091@ #102;

   dscam170 #500;
   dscam221 #501;
   dscam164 #502;
   dscam219 #503;

   Referen@ #1000;
   dscam224 #224;
   dscam225 #225;
|FIN;

|VARIABLES;
   &eaFichClas = "";  &eaTipoClas = ""; &enSwClas = 0; &eaClasif = "";
   &TipoCliente = ""; &CodCliente = ""; &DCampoC = 0; &HCampoC = 0; &CodProveedor = "";
   &eaSwCmpVta  = "";
   &enBanco      = 0;
   &enEmpCartera = 0;
   &enEmpGestion = 0;
   &eaSerie      = "";
   &eaCuenta     = "";
   &eaCliGest    = "";
   &nImporte     = 0;
   &enSwErr      = 0;
   &eaTipoOper   = "";
   &eaSesion     = "";
   &efFechaOri   = @;
   &efFechaApl   = @;

   &FecEmision   = "";
   &FecAgrup     = "";
   &FecDividido  = "";
   &FecVtoAgr    = "";
   &DAgrupador   = "";
   &TAgrup       = 0;
   &efFecVto     = "";

   &DocDividido  = 0;
   &DDividido    = 0;
   &FecVtoDiv    = "";
   &TotDividido  = 0;

   &Fichero   = "";  &Cmp = "";   &Tipo = ""; &CmpNum = 0;
   &aInforme  = "";
   &MaxDigit  = 0;

   &eaUsuario = ""; &enImpAnt = 0;  &enImpAct = 0;  &eaDescr = "";
   &eaTipoReg = ""; &eaNumero = ""; &eaTipoOp = "";
   &eaTipoRecibo = ""; &enNumDocum = 0; &eaMensRet = ""; &enSwError = 0; &eaTOperacion = "";
   &nDeci_Base = 0; &nDeci_Div = 0;

   &eaCodigo    = "";
   &eaTipoCod   = "";
   &aCuenta     = "";
   &eaNif       = "";
   &eaNombre    = "";
   &eaDireccion = "";
   &eaPoblacion = "";
   &eaProvincia = "";
   &eaCP        = "";
   &eaCP1       = "";
   &eaCP2       = "";
   &eaTelefono  = "";
   aDecimales = "";
   &enDocumento = 0;
   &eaSerieDiv  = "";
   &eaFactuDiv  = "";

   aEstado    = "";
   aPreparado = "";
   aAceptar   = "";
   aAceptado  = "";
   aTipoClas = "";
   aDomic   = "";
   aEntidad = "";
   aOficina = "";
   aDC      = "";
   aCta     = "";
   aSwAgrDiv = "";

   aMovto  = "";
   fFecMv  = @;
   nImpMv  = 0;
   nTecla  = 0;

   nSwError = 0;

   nSwArtenvas = 0;

   aClv1   = "";
   aClv2   = "";

   aSerDiv = "";
   nFacDiv = 0;
   nDiasCalcDiv = 0;
   nSwNo   = 0;
   nSwErr  = 0;
   nSwImpa = 0;
   nTR     = 0;
   aCodCli = "";

   nGtosArrastradosD = 0;
   nGtosArrastradosB = 0;

   nSwLuxe   = 0;
   nSumaLuxe = 0;
   nLuxadas  = 0;
   fFechaHoy = @;
   fFechaVto = @;
   &efFechaAgr   = @;
   &enSwAplazAgr = 0;

   nDecimales = 0;
   HayEntrega = 0;
   SwError  = 0;
   Flag     = 0;
   NuevoDoc = 0;
   Calc     = 0;
   DocAgrupador = 0;
   Linea    = 0;
   Cantidad = 0;
   TotAgrup = 0;
   nTotalRec = 0;
   NumRecs  = 0;
   ModoEntrada = 0;
   Cambio   = 0;
   Carta    = 0;
   nSwImp   = 0;
   nSwSal   = 0;

   nBotonCancel = 0;
   nBotonOk     = 0;

   aAlfa     = "";
   aAlfa1    = "";
   aAlfa2    = "";

   Proceso   = "";
   Operacion = "";
   &Divisa   = "";
   Cuenta   = "";
   Cadena   = "";
   Comodin  = "";
   Comodin1 = "";
   Parte   = "";
   Part1   = "";
   Part2   = "";
   Parte1  = 0;
   Parte2  = 0;
   Long    = 0;
   LongAlfa = "";

   Dia      = "";
   Mes      = "";
   anyo     = "";

   Total      = 0;
   TotalDiv   = 0;
   Salir      = 0;
   VtoMasAlto = @;
   LimEmisBaj = @;
   LimEmisAlt = @;
   SwNeg      = 0;

   fFecha1    = @;
   fFecha2    = @;

   nCalc      = 0;
   nCalc1     = 0;
   nCalc2     = 0;
   nCalcF1    = 0;
   nCalcF2    = 0;
   nSwAplaza  = 0;

   nLibro     = 0;
   aSerie     = "";
   nDocDiv    = 0;
   nSwOp      = 0;
   nSwHay     = 0;

   &HayConta = 0; &HayGestion = 0;
|FIN;

|PROCESO Ventas;
   |SI #dscam003#14 = "L"; |O #dscam003#14 = "A"; |O #dscam003#14 = "M";
   |O #dscam003#14 = "D";  |O #dscam003#14 = "R"; |O #dscam003#14 = "T";
   |O #dscam003#14 = "l";  |ACABA; |FINSI;

   |SI #dscam003#90 = "S";
      || ABDON   15/01/2013     N.Tiquet 003445/01540
      ||  Con este tiquet hemos visto que hay recibos impagados que sin un
      ||      movimiento posterior de preparacion, est n preparados.
      ||  Por tanto con este proceso compruebo que realmente tienen que estar
      ||      preparados
      |ABRE #dscam004;
      #dscam004#17 = #dscam003#40;
      #dscam004#3 = 99;
      |LEE 000#dscam004.];
      |SI FSalida = 0;
         |LEE 000#dscam004.a;
         |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
            nCalc = #dscam004#3;
         |SINO;
            nCalc = 1;
         |FINSI;
      |SINO;
         |LEE 000#dscam004.u;
         |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
            nCalc = #dscam004#3;
         |SINO;
            nCalc = 1;
         |FINSI;
      |FINSI;

      #dscam004#17 = #dscam003#40;
      #dscam004#3 = nCalc;
      |LEE 000#dscam004.=;
      |SI FSalida = 0;
         |SI #dscam004#5 = "IMP"; |Y #dscam003#90 = "S";
            #dscam003#90 = "N"; |GRABA 020#dscam003.a;
         |FINSI;
      |FINSI;
      |CIERRA #dscam004;

      |SI #dscam003#90 = "S"; |ACABA; |FINSI;
   |FINSI;

   |HAZ ComprTotVta;

   eaFichClas = "dscaz004"; eaTipoClas = #dscam003#12;
   enSwClas = 1; |HAZ CompruebaClas;
   |SI eaFichClas = "ERROR"; |ACABA; |FINSI;

   Divisa = #dscam003#57; |HAZ TomaDecim;

   |DDEFECTO #dscaz005;
   Linea = Linea + 1;
   #dscaz005#0  = Linea;
   #dscaz005#1  = #dscam003#0;
   #dscaz005#2  = #dscam003#1;
   #dscaz005#3  = #dscam003#2;
   #dscaz005#4  = #dscam003#6;
   #dscaz005#5  = #dscam003#3;
   #dscaz005#6  = #dscam003#12;
   #dscaz005#7  = #dscam003#13;
   |SI #dscam003#47 = "S";
      #dscaz005#8  = -#dscam003#23;
   |SINO;
      #dscaz005#8  = #dscam003#31;
   |FINSI;
   #dscaz005#10 = #dscam003#5;
   #dscaz005#11 = #dscam003#27;
   #dscaz005#12 = #dscam003#40;
   #dscaz005#13 = #dscam003#49;
   #dscaz005#14 = #dscam003#57;
   #dscaz005#15 = #dscam003#59;
   #dscaz005#16 = #dscam003#82;
   #dscaz005#17 = #dscam003#83;
   #dscaz005#18 = #dscam003#47;
   #dscaz005#19 = #dscam003#4;
   #dscaz005#21 = #dscam003#90;
   #dscaz005#22 = #dscam003#28;
   #dscaz005#23 = #dscam003#29;
   #dscaz005#24 = #dscam003#14;
   #dscaz005#25 = #dscam003#85;
   #dscaz005#26 = #dscam003#105;
   |SI #dscam051#47 = "S";
      |ABRE #dscam081; |ABRE #dscam082; |SELECT #2#dscam082;
      #dscam082#1 = #dscam003#12;
      |LEE 000#dscam082.=;
      |SI FSalida = 0;
         #dscam081#0 = #dscam082#0;
         |LEE 000#dscam081.=;
         |SI FSalida = 0;
            #dscaz005#20 = #dscam081#2;
         |FINSI;
      |FINSI;
      |CIERRA #dscam082; |CIERRA #dscam081;
   |FINSI;

   ||.. el Aux. agrupado con el n§ factura
   #dscam225#0 = #dscam003#40;
   |LEE 000#dscam225.=;
   |SI FSalida = 0; |Y #dscam225#4 = #dscam003#4; |Y #dscam225#5 = #dscam003#3;
       #dscaz005#1 = #dscam225#1;
       #dscaz005#2 = #dscam225#2;
       #dscaz005#3 = #dscam225#3;
   |FINSI;

   |GRABA 020#dscaz005.n;
|FPRC;

|DEFBUCLE Ventas;
#dscam003#16;
;
#0#4, #0#2, #0#6, #0#8, #0#10, #0#12;
#0#5, #0#3, #0#7, #0#9, #0#11, #0#13;
;
NULL,NULL,NULL,NULL,NULL,Ventas;
#dscam003#40;
|FIN;

|PROCESO Compras;
   |SI #dscam008#14 ! "P"; |Y #dscam008#14 ! "C"; |Y #dscam008#14 ! "N"; |ACABA; |FINSI;

   eaCodigo = #dscam008#32; eaCuenta = #dscam008#5; |HAZ MiraSiBloq;
   |SI enSwErr ! 0; |ACABA; |FINSI;

   eaFichClas = "dscaz004"; eaTipoClas = #dscam008#12;
   enSwClas = 1; |HAZ CompruebaClas;
   |SI eaFichClas = "ERROR"; |ACABA; |FINSI;

   Divisa = #dscam008#59; |HAZ TomaDecim;

   |DDEFECTO #dscaz005;
   Linea = Linea + 1;
   #dscaz005#0  = Linea;
   #dscaz005#1  = #dscam008#0;
   #dscaz005#2  = #dscam008#1;
   #dscaz005#3  = #dscam008#2;
   #dscaz005#4  = #dscam008#6;
   #dscaz005#5  = #dscam008#3;
   #dscaz005#6  = #dscam008#12;
   #dscaz005#7  = #dscam008#13;
   #dscaz005#8  = #dscam008#31;
   #dscaz005#10 = #dscam008#5;
   #dscaz005#11 = #dscam008#27;
   #dscaz005#12 = #dscam008#40;
   #dscaz005#13 = #dscam008#49;
   #dscaz005#14 = #dscam008#59;
   #dscaz005#15 = #dscam008#61;
   #dscaz005#16 = #dscam008#69;
   #dscaz005#17 = #dscam008#70;
   #dscaz005#25 = #dscam008#63;
   |SI #dscam051#47 = "S";
      |ABRE #dscam081; |ABRE #dscam082; |SELECT #2#dscam082;
      #dscam082#1 = #dscam008#12;
      |LEE 000#dscam082.=;
      |SI FSalida = 0;
         #dscam081#0 = #dscam082#0;
         |LEE 000#dscam081.=;
         |SI FSalida = 0;
            #dscaz005#20 = #dscam081#2;
         |FINSI;
      |FINSI;
      |CIERRA #dscam082; |CIERRA #dscam081;
   |FINSI;

   ||.. el Aux. agrupado con el n§ factura
   #dscam225#0 = #dscam003#40;
   |LEE 000#dscam225.=;
   |SI FSalida = 0; |Y #dscam225#4 = #dscam003#4; |Y #dscam225#5 = #dscam003#3;
       #dscaz005#1 = #dscam225#1;
       #dscaz005#2 = #dscam225#2;
       #dscaz005#3 = #dscam225#3;
   |FINSI;

   |GRABA 020#dscaz005.n;
|FPRC;

|DEFBUCLE Compras;
#dscam008#6;
12,13,31;
#0#2, #0#14, #0#8, #0#6, #0#10, #0#12;
#0#3, #0#15, #0#9, #0#7, #0#11, #0#13;
;
NULL,NULL,NULL,NULL,NULL,Compras;
#dscam008#40;
|FIN;

|PROCESO VentasCompras;
   |SI #dscaz004#0 = "V";
      |PINTA 0831 , "Cliente  ";
      |ATRI R;
      |PINTA 1520 , "Cliente  ";
      |ATRI N;
   |FINSI;
   |SI #dscaz004#0 = "C";
      |PINTA 0831 , "Proveedor";
      |ATRI R;
      |PINTA 1520 , "Proveedor";
      |ATRI N;
   |FINSI;
|FPRC;

|PROCESO AntesCodigo; |TIPO 7;
   |SI HayConta = 1; |Y HayGestion = 1;
      |C_M #dscaz004#1,1,"S";
   |SINO;
      |SI HayConta = 1; |Y HayGestion = 0;
         #dscaz004#1 = "C"; |PINTA #dscaz004#1;
         |C_M #dscaz004#1,1,"N";
      |FINSI;
      |SI HayConta = 0; |Y HayGestion = 1;
         #dscaz004#1 = "G"; |PINTA #dscaz004#1;
         |C_M #dscaz004#1,1,"N";
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO ContaGest;
   |PINTA 0844 , "             ";
   |PINTA 0859 , "             ";
   |SI #dscaz004#1 = "C";
      #dscaz004#4 = " " * 6; #dscaz004#5 = "z" * 6;
      |C_M #dscaz004#2,1,"S";
      |C_M #dscaz004#3,1,"S";
      |C_M #dscaz004#4,1,"N"; |C_M #dscaz004#14,1,"N";
      |C_M #dscaz004#5,1,"N"; |C_M #dscaz004#15,1,"N";
      |C_V #dscaz004#2,1,"S";
      |C_V #dscaz004#3,1,"S";
      |C_V #dscaz004#4,1,"N"; |C_V #dscaz004#14,1,"N";
      |C_V #dscaz004#5,1,"N"; |C_V #dscaz004#15,1,"N";
      |C_P #dscaz004#2,1,0845;
      |C_P #dscaz004#3,1,0860;
      |C_P #dscaz004#4,1,0648; |C_P #dscaz004#14,1,1548;
      |C_P #dscaz004#5,1,0663; |C_P #dscaz004#15,1,1563;
   |FINSI;
   |SI #dscaz004#1 = "G";
      #dscaz004#2 = " " * 12; #dscaz004#3 = "z" * 12;
      |C_M #dscaz004#2,1,"N";
      |C_M #dscaz004#3,1,"N";
      |SI #dscaz004#0 = "V";
         |C_M #dscaz004#4,1,"S"; |C_M #dscaz004#14,1,"N";
         |C_M #dscaz004#5,1,"S"; |C_M #dscaz004#15,1,"N";
         |C_P #dscaz004#4,1,0848; |C_P #dscaz004#14,1,1548;
         |C_P #dscaz004#5,1,0863; |C_P #dscaz004#15,1,1563;
         |C_V #dscaz004#4,1,"S"; |C_V #dscaz004#14,1,"N";
         |C_V #dscaz004#5,1,"S"; |C_V #dscaz004#15,1,"N";
      |SINO;
         |C_M #dscaz004#4,1,"N"; |C_M #dscaz004#14,1,"S";
         |C_M #dscaz004#5,1,"N"; |C_M #dscaz004#15,1,"S";
         |C_P #dscaz004#4,1,1548; |C_P #dscaz004#14,1,0848;
         |C_P #dscaz004#5,1,1563; |C_P #dscaz004#15,1,0863;
         |C_V #dscaz004#4,1,"N"; |C_V #dscaz004#14,1,"S";
         |C_V #dscaz004#5,1,"N"; |C_V #dscaz004#15,1,"S";
      |FINSI;
      |C_V #dscaz004#2,1,"N";
      |C_V #dscaz004#3,1,"N";
      |C_P #dscaz004#2,1,0544;
      |C_P #dscaz004#3,1,0559;
   |FINSI;
   |PINDA #0#0;
|FPRC;

|RUTINA inf;
   #dscaz005#0 = 00001;
|FRUT;

|RUTINA sup;
   #dscaz005#0 = 99999;
|FRUT;

|RUTINA inf1;
   #dscaz019#0 = 00001;
|FRUT;

|RUTINA sup1;
   #dscaz019#0 = 99999;
|FRUT;

|PROCESO Cuenta; |TIPO 6;
   nTecla = FSalida;

   Comodin = #dscaz004#Campo#;
   Comodin1 = Comodin;
   Comodin1 = Comodin1 - ".";
   |SI FSalida ! 0;
      Parte = FSalida;
      Parte1 = 100 + (((Parte / 100) ! 0) - 1);
      Parte2 = ((((Parte / 100) ! 0) + 1) * 100) + 99;
      Part1 = Comodin % Parte1;
      Part2 = Comodin % Parte2;
      |QBF Part2;
      Comodin1 = Part1 + Part2;
      LongAlfa = Comodin1 % 0;
      Long = MaxDigit - LongAlfa;
      LongAlfa = "0" * Long;
      Comodin = Part1 + LongAlfa + Part2;
      #dscaz004#Campo# = Comodin;
      |PINTA #dscaz004#Campo#;
   |FINSI;

   FSalida = nTecla;
|FPRC;

|PROCESO Puntos;
   |QBF aAlfa;
   aAlfa = aAlfa - ".";
   |PARA; |SI FSalida ! 0; |HACIENDO;
      nCalc = ((FSalida / 100) ! 0) + 99; aAlfa1 = aAlfa % nCalc;
      nCalc = FSalida + 98;               aAlfa2 = aAlfa % nCalc;
      aAlfa = aAlfa1 + aAlfa2; |QBF aAlfa;
      aAlfa = aAlfa % 0; nCalc = aAlfa;
      nCalc = MaxDigit - nCalc; |SI nCalc < 0; nCalc = 0; |FINSI;
      aAlfa = "0" * nCalc;
      aAlfa = aAlfa1 + aAlfa + aAlfa2;

      aAlfa = aAlfa - ".";
   |SIGUE;

   |QBF aAlfa;
|FPRC;

|PROCESO ConsultaCodigo;
   |SI Campo = 2; |O Campo = 3; |ACABA; |FINSI;

   aAlfa = #48#17; |QBF aAlfa;
   |SI #dscaz004#0 = "V";
      aAlfa = aAlfa + "def/agifa024.mas";
   |SINO;
      aAlfa = aAlfa + "def/agifa112.mas";
   |FINSI;
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      aAlfa = #48#17; |QBF aAlfa;
      aAlfa = aAlfa + "fich/" + (("00000" + #48#15) % -105) + "/";
      |PATH_DAT #Referen@#aAlfa#; |ABRE #Referen@;

      #Referen@#0 = #dscaz004#Campo#;
      |LEE 000#Referen@.];
      |CONSULTA_CLAVE #1#Referen@;
      |SI FSalida = 0;
         #dscaz004#Campo# = #Referen@#0; |PINTA #dscaz004#Campo#;
      |FINSI;

      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
   |FINSI;
|FPRC;

|PROCESO ConsultaCuenta;
   |SI Campo = 4; |O Campo = 5; |ACABA; |FINSI;

   DCampoC = Campo; HCampoC = Campo;
   |SI #dscaz004#0 = "V";
      TipoCliente = "C"; CodCliente = #dscaz004#Campo#;
      |HAZ ExisteCliente;
   |FINSI;
   |SI #dscaz004#0 = "C";
      TipoCliente = "P"; CodProveedor = #dscaz004#Campo#;
      |HAZ ExisteProveedor;
   |FINSI;

   |SI TipoCliente = "ERROR";
      |ERROR;
   |SINO;
      |SI #dscaz004#0 = "V"; #dscaz004#Campo# = CodCliente;   |FINSI;
      |SI #dscaz004#0 = "C"; #dscaz004#Campo# = CodProveedor; |FINSI;
      |PINTA #dscaz004#Campo#;
   |FINSI;

/*
   aAlfa = #48#16; |QBF aAlfa;
   aAlfa = aAlfa + "def/cacuenta.mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      aAlfa = #48#16; |QBF aAlfa;
      aAlfa = aAlfa + "fich/" + (("00000" + #48#14) % -105) + #48#19 + "/";
      |PATH_DAT #Referen@#aAlfa#; |ABRE #Referen@;

      aAlfa = #dscaz004#Campo#; |HAZ Puntos;

      #Referen@#0 = #dscaz004#Campo#;
      |LEE 000#Referen@.];
      |CONSULTA_CLAVE #1#Referen@;
      |SI FSalida = 0;
         #dscaz004#Campo# = #Referen@#0; |PINTA #dscaz004#Campo#;
      |FINSI;

      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
   |FINSI;
*/
|FPRC;

|PROCESO ConsultaF2;
   |SI FSalida ! 10; |ACABA; |FINSI;

   |SI #dscaz004#1 = "C";
      |HAZ ConsultaCuenta;
   |SINO;
      |HAZ ConsultaCodigo;
   |FINSI;
|FPRC;

|PROCESO DesmarcaTodos;
   eaTOperacion = "B"; eaTipoRecibo = #0#0; enNumDocum = #dscaz005#12; |HAZ ProcesaTempo;

   #dscaz005#9 = " ";
   |GRABA 020#dscaz005.a;
   HayEntrega = 0;
   VtoMasAlto = "";
   nSumaLuxe  = 0;
   LimEmisBaj = ~;
   LimEmisAlt = ~;

   aTipoClas = ""; aPreparado = "";
   aAceptar  = ""; aAceptado  = "";
   aEstado   = "";
|FPRC;

|DEFBUCLE DesmarcaTodos;
#dscaz005#1;
;
INICIO;
FINAL;
;
NULL,DesmarcaTodos;
|FIN;

|PROCESO MarcaTodos;
   Comodin1 = #dscaz005#10;
   |QBF Comodin1;
   |SI Comodin1 ! Cuenta; |ACABA; |FINSI;
   |SI #dscaz005#20 ! aTipoClas; |Y NumRecs ! 0; |Y aTipoClas ! " "; |ACABA; |FINSI;
   |SI #dscaz005#24 ! aEstado;
      |SI #dscaz005#24 = "P"; |Y aEstado = "I";  aEstado = #dscaz005#24; |FINSI;
      |SI #dscaz005#24 = "I"; |Y aEstado = "P";  aEstado = #dscaz005#24; |FINSI;
   |FINSI;
   |SI #dscaz005#24 ! aEstado;   |Y NumRecs ! 0; |Y aEstado ! " ";   |ACABA; |FINSI;
   |SI #dscaz005#23 = "S"; |ACABA; |FINSI;

   aTipoClas = #dscaz005#20; aPreparado = #dscaz005#21;
   aAceptar  = #dscaz005#22; aAceptado  = #dscaz005#23;
   aEstado   = #dscaz005#24;

   eaTOperacion = "A"; eaTipoRecibo = #0#0; enNumDocum = #dscaz005#12; |HAZ ProcesaTempo;

   #dscaz005#9 = "*";
   |GRABA 020#dscaz005.a;
   |SI #dscaz005#18 = "S"; HayEntrega = 1; |FINSI;
   Cantidad = Cantidad + #dscaz005#8;
   Cantidad = Cantidad ! nDeci_Div;
   NumRecs = NumRecs + 1;

   fFechaHoy = ~; fFechaVto = #dscaz005#5;
   nCalcF1 = fFechaVto; nCalcF2 = fFechaHoy; nCalcF1 = nCalcF1 - nCalcF2;
   nSumaLuxe = nSumaLuxe + (nCalcF1*#dscaz005#8);

   |SI #dscaz005#5 > VtoMasAlto; VtoMasAlto = #dscaz005#5; |FINSI;
   |SI #dscaz005#19 ] LimEmisAlt; LimEmisAlt = #dscaz005#19; |FINSI;
   |SI #dscaz005#19 [ LimEmisBaj; LimEmisBaj = #dscaz005#19; |FINSI;
|FPRC;

|DEFBUCLE MarcaTodos;
#dscaz005#1;
;
INICIO;
FINAL;
;
NULL,MarcaTodos;
|FIN;

|PROCESO Desgl; |TIPO 7;
   |SI #dscaz005#13 = "N"; |Y #dscaz005#16 = "N";
      aAlfa = &196 * 78
      |PINTA 1404, aAlfa;
      ||PINTA 1404, "                                                                             ";
   |FINSI;
   |SI #dscaz005#13 = "S";
      |ATRI R;
      ||PINTA 1403, "* <F6> Documentos que agrupa el documento actual   <F7> Deshacer agrupacion  ";
      |PINTA 1404, " <F6> Documentos agrupados  <F7> Deshacer agrupacion  <F9> Carta explicativa ";
      |ATRI N;
   |FINSI;
   |SI #dscaz005#16= "S";
      |ATRI R;
      |PINTA 1404, "* <F6> Documento dividido  <F7> Deshacer division  <F9> Carta explicativa    ";
      |ATRI N;
   |FINSI;
|FPRC;

|PROCESO RellenaTempo1;
   |DDEFECTO #dscaz019;
   #dscaz019#0 = Linea;  Linea = Linea + 1;
   #dscaz019#1 = #dscam003#40;
   #dscaz019#2 = #dscam003#3;
   #dscaz019#3 = #dscam003#31;
   |GRABA 020#dscaz019.n;
   TotAgrup = TotAgrup + #dscaz019#3;
|FPRC;

|DEFBUCLE RellenaTempo1;
#dscam003#1;
41;
000000001,#dscaz005#12;
999999999,#dscaz005#12;
;
NULL,NULL,NULL,NULL,NULL,RellenaTempo1;
#dscam003#5,#dscam003#32;
|FIN;

|PROCESO RellenaTempo2;
   |DDEFECTO #dscaz019;
   #dscaz019#0 = Linea;  Linea = Linea + 1;
   #dscaz019#1 = #dscam008#40;
   #dscaz019#2 = #dscam008#4;
   #dscaz019#3 = #dscam008#31;
   |GRABA 020#dscaz019.n;
   TotAgrup = TotAgrup + #dscaz019#3;
|FPRC;

|DEFBUCLE RellenaTempo2
#dscam008#1;
41;
000000001,#dscaz005#12;
999999999,#dscaz005#12;
;
NULL,RellenaTempo2
|FIN;

|PROCESO Aplazamiento;
   |SALVA_FICHA #dscam003; |SALVA_FICHA #dscaz005;
   |HAZ Tipo9;
   enDocumento = #dscaz005#12;
   efFechaOri  = #dscaz005#5;
   efFechaApl  = #dscaz019#2;

   |HAZ Aplaza;

   |HAZ Tipo8;
   |REPON_FICHA #dscaz005;
   |REPON_FICHA #dscam003;
|FPRC;

|PROCESO Divide;
   #dscam003#40 = #dscaz005#12;
   |LEE 000#dscam003.=;
   |SI FSalida = 0;
      nGtosArrastradosD = #dscam003#101 + #dscam003#24 + #dscam003#25 + #dscam003#38;
      nGtosArrastradosB = #dscam003#102 + #dscam003#62 + #dscam003#63 + #dscam003#66;
   |SINO;
      nGtosArrastradosD = 0;
      nGtosArrastradosB = 0;
   |FINSI;

   Proceso = "D";
   |PUSHV 0501 2380;
   |C_M #dscaz019#1,1,"N";
   |DELINDEX #dscaz019;
   |CUADRO 0606 1356;
   |ATRI R; |PINTA 607, " DIVISION DOCUMENTO ";                       |ATRI N;
   ||ATRI R; |PINTA 707, "Linea Documento Fecha Vto.  Importe Docum."; |ATRI N;
   |ATRI R; |PINTA 707, "Linea Documento Fecha Emi. Fecha Vto.   Importe  "; |ATRI N;
   nTotalRec = #dscaz005#8;
   |SI nSwArtenvas = 1;
      |C_M #dscaz019#2, 1, "N";
   |FINSI;

   |ENTLINEAL #1#dscaz019,-1,1,12,1,inf1,sup1;

   |SI TotAgrup ! 0;
      |MENAV "    Se ha dejado sin repartir una parte del recibo original. Se creara uno por la diferencia.";
   |FINSI;

   |SI nTotalRec ! TotAgrup;
      nSwNo = 0;
      |SI TotAgrup ! 0; nSwNo = 1; |FINSI;

      |SI nSwNo = 1;
         |SI #dscaz004#0 = "V";
            |LEE 000#dscam003.u;
            |SI  FSalida = 0;
               NuevoDoc = #dscam003#40 + 1;
            |SINO;
               NuevoDoc = 1;
            |FINSI;

            |DDEFECTO #dscam003;
            #dscam003#40 = #dscaz005#12;
            |LEE 000#dscam003.=;
            |SI FSalida = 0;

||         Para las agrupaciones y divisiones hay un parametro que determina
||         como actuar con el riesgo (#dscam051#114) ABDON (001483/00703)
               |SI #dscam003#16 ! 0; |Y #dscam051#114 = 1;
                  |SI #dscam051#3 = "S";
                     |SALVA_FICHA #dscam003;
                     enBanco = -1;
                     || enEmpCartera = #48#0;   enEmpGestion = #dscam003#46;
                     enEmpCartera = -1;   enEmpGestion = #dscam003#46;
                     eaSerie = #dscam003#0;  eaCliGest = #dscam003#32;
                     nImporte = TotAgrup; nImporte = (nImporte / #dscam003#59) ! nDeci_Div;
                     eaTipoOper = "-7+4";
                     |HAZ BucleRiesgo;
                     |REPON_FICHA #dscam003;
                  |FINSI;
               |FINSI;

               #dscam003#40 = NuevoDoc;
               |GRABA 020#dscam003.b;
               #dscam003#1 = 0;
               #dscam003#2 = 0;
               #dscam003#14 = "P"; #dscam003#15 = "Pendiente de cobro";
               #dscam003#16 = 0;
               #dscam003#23 = 0; #dscam003#61 = 0;
               #dscam003#17 = 0; #dscam003#37 = 0;
               #dscam003#24 = 0; #dscam003#25 = 0; #dscam003#38 = 0;
               #dscam003#62 = 0; #dscam003#63 = 0; #dscam003#66 = 0;
               #dscam003#26 = "01.01.0000";
               #dscam003#22 = TotAgrup; #dscam003#60 = #dscam003#22 / #dscam003#59;
               #dscam003#30 = TotAgrup; #dscam003#64 = #dscam003#30 / #dscam003#59;
               #dscam003#31 = TotAgrup; #dscam003#65 = #dscam003#31 / #dscam003#59;
               #dscam003#41 = 0;  #dscam003#49 = "N";
               #dscam003#70 = ""; #dscam003#72 = "";
               #dscam003#82 = "S";
               #dscam003#83 = #dscaz005#12;
               #dscam003#87 = aSerDiv;
               #dscam003#88 = nFacDiv;
               #dscam003#101 = nGtosArrastradosD;
               #dscam003#102 = nGtosArrastradosB;
               #dscam003#105 = nDiasCalcDiv;
               |GRABA 020#dscam003.a; |LIBERA #dscam003;

              || El auxiliar;
              #dscam224#0 = #dscaz005#12;
              |LEE 101#dscam224.=;
              |SI FSalida = 0;
                   #dscam224#0 = #dscam003#40;
                   |BORRA 000#dscam224.c;
                   |GRABA 020#dscam224.n;
              |FINSI;


               |SI nSwArtenvas = 1;
                  ||Copio tanto el historico de situaciones como de cambios de situacion, fecha de Vto y observaciones para no perder ambos en los recibos resultantes
                  |DDEFECTO #dscam164;
                  #dscam164#0 = #dscaz005#12;
                  |LEE 000#dscam164.];
                  |SI FSalida = 0; |Y #dscam164#0 = #dscaz005#12;
                     #dscam221#0 = #dscaz005#12;
                     |LEE 000#dscam221.=;
                     |SI FSalida = 0;
                        #dscam221#0 = NuevoDoc;
                        |GRABA 020#dscam221.n;
                     |FINSI;

                     #dscam164#0 = #dscaz005#12;
                     |LEE 000#dscam164.];
                     |PARA; |SI FSalida = 0; |Y #dscam164#0 = #dscaz005#12; |HACIENDO;
                        aAlfa  = (("0000000000" + #dscam164#0) % -110) + "/" + #dscam164#1 + "/" + #dscam164#2;
                        aAlfa1 = (("0000000000" + NuevoDoc) % -110) + "/" + #dscam164#1 + "/" + #dscam164#2;
                        |DDEFECTO #dscam219;
                        #dscam219#0 = aAlfa; aAlfa = #dscam219#0;
                        |LEE 000#dscam219.];
                        |PARA; |SI FSalida = 0; |Y #dscam219#0 = aAlfa; |HACIENDO;
                           |SALVA_FICHA #dscam219;
                           #dscam219#0 = aAlfa1;
                           |GRABA 020#dscam219.n;
                           |REPON_FICHA #dscam219;

                           |LEE 000#dscam219.s;
                        |SIGUE;

                        |SALVA_FICHA #dscam164;
                        #dscam164#0 = NuevoDoc;
                        |GRABA 020#dscam164.n;
                        |REPON_FICHA #dscam164;

                        |LEE 000#dscam164.s;
                     |SIGUE;
                  |FINSI;
               |FINSI;

               eaUsuario = Usuario % 0810;
               eaDescr   = "DIVISION DOCUMENTO VENTA (" + (("000000000" + #dscaz005#12) % -109) + ")";
               eaTipoReg = "DV";  eaNumero = ("000000000" + #dscaz005#12) % -109;
               eaTipoOp  = "A";   enImpAnt = #dscam003#30; enImpAct = 0;
               |HAZ GrabaAudit;
            |FINSI;
         |FINSI;
         |SI #dscaz004#0 = "C";
            |LEE 000#dscam008.u;
            |SI  FSalida = 0;
               NuevoDoc = #dscam008#40 + 1;
            |SINO;
               NuevoDoc = 1;
            |FINSI;

            |DDEFECTO #dscam008;
            #dscam008#40 = #dscaz005#12;
            |LEE 000#dscam008.=;
            |SI FSalida = 0;
               #dscam008#40 = NuevoDoc;
               |GRABA 020#dscam008.b;
               #dscam008#1 = 0;
               #dscam008#2 = 0;
               #dscam008#14 = "P"; #dscam008#15 = "Pendiente de pago";
               #dscam008#23 = 0; #dscam008#57 = 0;
               #dscam008#17 = 0; #dscam008#37 = 0; #dscam008#39 = "";
               #dscam008#26 = "01.01.0000";
               #dscam008#22 = TotAgrup; #dscam008#53 = #dscam008#22 / #dscam008#61;
               #dscam008#25 = TotAgrup; #dscam008#56 = #dscam008#25 / #dscam008#61;
               #dscam008#31 = TotAgrup; #dscam008#58 = #dscam008#31 / #dscam008#61;
               #dscam008#41 = 0;  #dscam008#49 = "N";
               #dscam008#69 = "S";
               #dscam008#70 = #dscaz005#12;
               |GRABA 020#dscam008.a; |LIBERA #dscam008;

               eaUsuario = Usuario % 0810;
               eaDescr   = "DIVISION DOCUMENTO COMPRA (" + (("000000000" + #dscaz005#12) % -109) + ")";
               eaTipoReg = "DC";  eaNumero = ("000000000" + #dscaz005#12) % -109;
               eaTipoOp  = "A";   enImpAnt = #dscam008#25; enImpAct = 0;
               |HAZ GrabaAudit;
            |FINSI;
         |FINSI;
      |FINSI;

      |SI #dscaz004#0 = "V";
         #dscam003#40 = #dscaz005#12;
         |LEE 101#dscam003.=;
         |SI FSalida = 0;
            #dscam003#14 = "D"; #dscam003#15 = "Dividido";
            |GRABA 020#dscam003.a; |LIBERA #dscam003;
         |FINSI;
      |FINSI;

      |SI #dscaz004#0 = "C";
         #dscam008#40 = #dscaz005#12;
         |LEE 101#dscam008.=;
         |SI FSalida = 0;
            #dscam008#14 = "D"; #dscam008#15 = "Dividido";
            |GRABA 020#dscam008.a; |LIBERA #dscam008;
         |FINSI;
      |FINSI;
   |FINSI;

   |POPV;
   Proceso   = "";
   eaTOperacion = "B"; eaTipoRecibo = #0#0; enNumDocum = #dscaz005#12; |HAZ ProcesaTempo;
|FPRC;

|PROCESO TomaNuevoDoc;
    #dscaz019#2 = #dscaz005#5;
    #dscaz019#4 = #dscaz005#19;
|ACABA;
    ModoEntrada = (FEntrada / 100) ! 0;
    |SI ModoEntrada ! 1; |ACABA; |FINSI;

    |SI #dscaz004#0 = "V";
       |LEE 000#dscam003.u;
       |SI  FSalida = 0;
          NuevoDoc = #dscam003#40 + 1;
       |SINO;
          NuevoDoc = 1;
       |FINSI;
       #dscam003#40 = NuevoDoc; |GRABA 020#dscam003.b;
    |FINSI;
    |SI #dscaz004#0 = "C";
       |LEE 000#dscam008.u;
       |SI  FSalida = 0;
          NuevoDoc = #dscam008#40 + 1;
       |SINO;
          NuevoDoc = 1;
       |FINSI;
       #dscam008#40 = NuevoDoc; |GRABA 020#dscam003.b;
    |FINSI;
    #dscaz019#1 = NuevoDoc;
    #dscaz019#2 = #dscaz005#5;
    |PINTA #dscaz019#1;
|FPRC;

|PROCESO ActualNuevoDoc; |TIPO 2;
   Flag = 0 +. 1;

   |SI Flag > 0; |Y #dscaz019#3 = 0;
      |MENAV "    El importe del documento no puede ser cero"; |ERROR; |ACABA;
   |FINSI;


   TotAgrup = TotAgrup -. #dscaz019#3;
   TotAgrup = TotAgrup ! nDeci_Div;
   |PINTA 0660, "                   ";
   Comodin = TotAgrup; |HAZ PonComas;
   |PINTA 0668,Comodin;

   |SI Flag < 0;
      |SI #dscaz004#0 = "V";
         #dscam003#40 = #dscaz019#1;
         |LEE 000#dscam003.=;
         |SI FSalida = 0;
              |BORRA 020#dscam003.a;
              || El auxiliar;
              #dscam224#0 = #dscam003#40;
              |LEE 101#dscam224.=;
              |SI FSalida = 0;
                   |BORRA 020#dscam224.a;
             |FINSI;

            |ABRE #dscam170;
            #dscam170#0 = #dscam003#40;
            #dscam170#3 = #dscam003#3;
            |LEE 101#dscam170.=;
            |SI FSalida = 0;
               |BORRA 020#dscam170.a;
            |FINSI;
            |LIBERA #dscam170; |CIERRA #dscam170;
         |FINSI;
      |FINSI;
      |SI #dscaz004#0 = "C";
         #dscam008#40 = #dscaz019#1;
         |LEE 000#dscam008.=;
         |SI FSalida = 0;
            |BORRA 020#dscam008.a;
         |FINSI;
      |FINSI;
   |SINO;
      |SI #dscaz004#0 = "V";
         |LEE 000#dscam003.u;
         |SI  FSalida = 0;
            NuevoDoc = #dscam003#40 + 1;
         |SINO;
            NuevoDoc = 1;
         |FINSI;
         #dscaz019#1 = NuevoDoc; |PINTA #dscaz019#1;
         |DDEFECTO #dscam003;
         #dscam003#40 = #dscaz005#12;
         |LEE 000#dscam003.=;
         |SI FSalida = 0;
||      Para las agrupaciones y divisiones hay un parametro que determina
||      como actuar con el riesgo (#dscam051#114) ABDON (001483/00703)
            |SI #dscam003#16 ! 0; |Y #dscam051#114 = 1;
               |SI #dscam051#3 = "S";
                  |SALVA_FICHA #dscam003;
                  enBanco = -1;
                  || enEmpCartera = #48#0;   enEmpGestion = #dscam003#46;
                  enEmpCartera = -1;      enEmpGestion = #dscam003#46;
                  eaSerie = #dscam003#0;  eaCliGest = #dscam003#32;
                  nImporte = #dscaz019#3; nImporte = (nImporte / #dscam003#59) ! nDeci_Div;
                  eaTipoOper = "-7+4";
                  |HAZ BucleRiesgo;
                  |REPON_FICHA #dscam003;
               |FINSI;
            |FINSI;
            #dscam003#40 = #dscaz019#1; |GRABA 020#dscam003.b;
            #dscam003#1 = 0;
            #dscam003#2 = 0;
            #dscam003#3 = #dscaz019#2;
            #dscam003#4 = #dscaz019#4;
            #dscam003#14 = "P"; #dscam003#15 = "Pendiente de cobro";
            #dscam003#16 = 0;
            #dscam003#23 = 0; #dscam003#61 = 0;
            #dscam003#17 = 0; #dscam003#37 = 0;
            #dscam003#24 = 0; #dscam003#25 = 0; #dscam003#38 = 0;
            #dscam003#62 = 0; #dscam003#63 = 0; #dscam003#66 = 0;
            #dscam003#26 = "01.01.0000";
            #dscam003#41 = 0;    #dscam003#49 = "N";
            #dscam003#70 = "";   #dscam003#72 = "";
            #dscam003#82 = "S";  #dscam003#83 = #dscaz005#12;
            #dscam003#87 = aSerDiv; #dscam003#88 = nFacDiv;
            #dscam003#22 = #dscaz019#3; #dscam003#60 = #dscam003#22 / #dscam003#59;
            #dscam003#30 = #dscam003#22 + (#dscam003#24 + #dscam003#25 + #dscam003#38);
            #dscam003#64 = #dscam003#60 + (#dscam003#62 + #dscam003#63 + #dscam003#66);
            #dscam003#31 = #dscam003#30;
            #dscam003#65 = #dscam003#64;
            #dscam003#105 = nDiasCalcDiv;
            |SI TotAgrup = 0;
               #dscam003#101 = nGtosArrastradosD;
               #dscam003#102 = nGtosArrastradosB;
            |SINO;
               |SI #dscam003#30 ] nGtosArrastradosD;
                  #dscam003#101 = nGtosArrastradosD; nGtosArrastradosD = 0;
                  #dscam003#102 = nGtosArrastradosB; nGtosArrastradosB = 0;
               |SINO;
                  #dscam003#101 = #dscam003#30; nGtosArrastradosD = nGtosArrastradosD - #dscam003#30;
                  #dscam003#102 = #dscam003#64; nGtosArrastradosB = nGtosArrastradosB - #dscam003#64;
               |FINSI;
            |FINSI;
            |GRABA 020#dscam003.a; |LIBERA #dscam003;
            || El auxiliar;
            #dscam224#0 = #dscaz005#12;  ;
            |LEE 101#dscam224.=;
            |SI FSalida = 0;
                 #dscam224#0 = #dscam003#40;
                 |BORRA 000#dscam224.c;
                 |GRABA 020#dscam224.n;
            |FINSI;

            |SI nSwArtenvas = 1;
               ||Copio tanto el historico de situaciones como de cambios de situacion, fecha de Vto y observaciones para no perder ambos en los recibos resultantes
               |DDEFECTO #dscam164;
               #dscam164#0 = #dscaz005#12;
               |LEE 000#dscam164.];
               |SI FSalida = 0; |Y #dscam164#0 = #dscaz005#12;
                  #dscam221#0 = #dscaz005#12;
                  |LEE 000#dscam221.=;
                  |SI FSalida = 0;
                     #dscam221#0 = #dscaz019#1;
                     |GRABA 020#dscam221.n;
                  |FINSI;

                  #dscam164#0 = #dscaz005#12;
                  |LEE 000#dscam164.];
                  |PARA; |SI FSalida = 0; |Y #dscam164#0 = #dscaz005#12; |HACIENDO;
                     aAlfa  = (("0000000000" + #dscam164#0) % -110) + "/" + #dscam164#1 + "/" + #dscam164#2;
                     aAlfa1 = (("0000000000" + #dscaz019#1) % -110) + "/" + #dscam164#1 + "/" + #dscam164#2;
                     |DDEFECTO #dscam219;
                     #dscam219#0 = aAlfa; aAlfa = #dscam219#0;
                     |LEE 000#dscam219.];
                     |PARA; |SI FSalida = 0; |Y #dscam219#0 = aAlfa; |HACIENDO;
                        |SALVA_FICHA #dscam219;
                        #dscam219#0 = aAlfa1;
                        |GRABA 020#dscam219.n;
                        |REPON_FICHA #dscam219;

                        |LEE 000#dscam219.s;
                     |SIGUE;

                     |SALVA_FICHA #dscam164;
                     #dscam164#0 = #dscaz019#1;
                     |GRABA 020#dscam164.n;
                     |REPON_FICHA #dscam164;

                     |LEE 000#dscam164.s;
                  |SIGUE;
               |FINSI;
            |FINSI;
            |SI nSwAplaza = 1; |HAZ Aplazamiento; |FINSI;
         |FINSI;
      |FINSI;
      |SI #dscaz004#0 = "C";
         |LEE 000#dscam008.u;
         |SI  FSalida = 0;
            NuevoDoc = #dscam008#40 + 1;
         |SINO;
            NuevoDoc = 1;
         |FINSI;
         #dscaz019#1 = NuevoDoc; |PINTA #dscaz019#1;
         |DDEFECTO #dscam008;
         #dscam008#40 = #dscaz005#12;
         |LEE 000#dscam008.=;
         |SI FSalida = 0;
            #dscam008#40 = #dscaz019#1; |GRABA 020#dscam008.b;
            #dscam008#1 = 0;
            #dscam008#2 = 0;
            #dscam008#3 = #dscaz019#2;
            #dscam008#14 = "P"; #dscam008#15 = "Pendiente de pago";
            #dscam008#23 = 0; #dscam008#57 = 0;
            #dscam008#17 = 0; #dscam008#37 = 0; #dscam008#39 = "";
            #dscam008#24 = 0; #dscam008#38 = 0;
            #dscam008#54 = 0; #dscam008#55 = 0;
            #dscam008#26 = "01.01.0000";
            #dscam008#41 = 0;  #dscam008#49 = "N";
            #dscam008#69 = "S";         #dscam008#70 = #dscaz005#12;
            #dscam008#22 = #dscaz019#3; #dscam008#53 = #dscam008#22 / #dscam008#61;
            #dscam008#25 = #dscaz019#3; #dscam008#56 = #dscam008#25 / #dscam008#61;
            #dscam008#31 = #dscaz019#3; #dscam008#58 = #dscam008#31 / #dscam008#61;
            |GRABA 020#dscam008.a; |LIBERA #dscam008;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO EliminaMovtos;
   |SI #dscam004#55 = "N";
      #dscam067#8 = 0;
      #dscam067#9 = 0;
      #dscam067#0 = "CB";
      #dscam067#1 = #dscam004#17; aClv1 = #dscam067#1;
      #dscam067#2 = #dscam004#3;  aClv2 = #dscam067#2;
      #dscam067#3 = "";
      |LEE 101#dscam067.];
      |SI FSalida = 0; |Y #dscam067#0 = "CB"; |Y #dscam067#1 = aClv1; |Y #dscam067#2 = aClv2;
         aAlfa = "    El movimiento del recibo " + #dscam004#17 + " sera eliminado y su asiento borrado de contabilidad. Enlace de nuevo el original";
         |MENAV aAlfa;

         Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
         |NOME_DAT #dscaw013#Comodin#;
         |DELINDEX #dscaw013; |ABRE #dscaw013;
         |DDEFECTO #dscaw013;
         #dscaw013#15 = #dscam067#10; #dscaw013#0 = 1;
         #dscaw013#13 = "dscam004";   #dscaw013#14 = 17;
         #dscaw013#11 = "N";          #dscaw013#12 = 9;
         #dscaw013#5 = #dscam004#17;  #dscaw013#6 = #dscam004#17;
         |GRABA 020#dscaw013.n;

         |DDEFECTO #dscaw013;
         #dscaw013#15 = #dscam067#10; #dscaw013#0 = 2;
         #dscaw013#13 = "dscam004";   #dscaw013#14 = 3;
         #dscaw013#11 = "N";          #dscaw013#12 = 3;
         #dscaw013#5 = #dscam004#3;   #dscaw013#6 = #dscam004#3;
         |GRABA 020#dscaw013.n;

         |DDEFECTO #dscaw013;
         #dscaw013#15 = #dscam067#10; #dscaw013#0 = 3;
         #dscaw013#13 = "dscam004";   #dscaw013#14 = 6;
         #dscaw013#11 = "F";          #dscaw013#12 = 10;
         #dscaw013#7 = #dscam004#6;   #dscaw013#8 = #dscam004#6;
         |GRABA 020#dscaw013.n;

         |LIBERA #dscaw013; |CIERRA #dscaw013;

         Comodin = #dscam067#10;
         Comodin = "dscam033.tab;" + Comodin + ",B";
         |LIBERA #dscam003; |CIERRAT #dscam003;
         |LIBERA #dscam004; |CIERRAT #dscam004;
         |SUB_EJECUTA_NP Comodin;
         |ABRET #dscam003; |LEE 000#dscam003.=;
         |ABRET #dscam004; |LEE 101#dscam004.=;

         |BORRA 020#dscam067.a; |LIBERA #dscam067;
      |FINSI;
   |FINSI;

   |BORRA 020#dscam004.a; |LIBERA #dscam004;
|FPRC;

|DEFBUCLE EliminaMovtos;
#dscam004#1;
;
#dscam003#40, 1;
#dscam003#40, 99;
be;
NULL, EliminaMovtos;
|FIN;

|PROCESO DesDivide;
   |SI #dscaz004#0 = "V";
||      Para las agrupaciones y divisiones hay un parametro que determina
||      como actuar con el riesgo (#dscam051#114) ABDON (001483/00703)
      |SI #dscam051#3 = "S"; |Y nSwImp = 1; |Y #dscam051#114 = 1;
         enBanco = -1;
         || enEmpCartera = #48#0;    enEmpGestion = #dscam003#46;
         enEmpCartera = -1;       enEmpGestion = #dscam003#46;
         eaSerie = #dscam003#0;   eaCliGest = #dscam003#32;
         nImporte = #dscam003#65; eaTipoOper = "+7-4";
         |HAZ BucleRiesgo;
      |FINSI;

      |SI SwError < 0;
         || Recibos liquidados pero imagenes de uno dividido, por lo que
         ||    pueden ser eliminados. OJO , hay que eliminar sus movimientos y
         ||    si no estan marcados como no enlazables, hay que ver si tienen
         ||    asiento en contabilidad y si es asi, avisar y eliminarlo
         ||    tambien.
         |ABRE #dscam067;
         |BUCLE EliminaMovtos;
         |CIERRA #dscam067;
      |FINSI;

      |BORRA 020#dscam003.a; |LIBERA #dscam003;
      || El auxiliar;
      #dscam224#0 = #dscam003#40;
      |LEE 101#dscam224.=;
      |SI FSalida = 0;
           |BORRA 020#dscam224.a;
      |FINSI;

      #dscam170#0 = #dscam003#40;
      #dscam170#3 = #dscam003#3;
      |LEE 101#dscam170.=;
      |SI FSalida = 0; |BORRA 020#dscam170.a; |FINSI;
      |LIBERA #dscam170;
   |FINSI;
   |SI #dscaz004#0 = "C";
      |BORRA 020#dscam008.a; |LIBERA #dscam008;
   |FINSI;
|FPRC;

|DEFBUCLE DesDivideV;
#dscam003#1;
82,83;
000000001,"S",#dscaz005#17;
999999999,"S",#dscaz005#17;
be;
NULL,DesDivide;
|FIN;

|DEFBUCLE DesDivideC;
#dscam008#1;
69,70;
000000001,"S",#dscaz005#17;
999999999,"S",#dscaz005#17;
be;
NULL,DesDivide;
|FIN;

|PROCESO Comprueba;
   |SI #0#0 = "V";
      |SI #dscam003#14 ! "P"; |Y #dscam003#14 ! "l";
         |SI #dscam003#14 = "L";
            aAlfa = #dscam003#15; |QBF aAlfa;
            aAlfa = aAlfa - " por division";
            |SI FSalida ! 0;
               SwError = -1;
               |ABRE #dscam004;
               #dscam004#17 = #dscam003#40;
               #dscam004#3 = 1;
               |LEE 000#dscam004.];
               |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
                  aMovto = #dscam004#5; fFecMv = #dscam004#6; nImpMv = #dscam004#8;
                  |SALVA_FICHA #dscam004;
                  #dscam004#17 = #dscam003#83;
                  |LEE 000#dscam004.=;
                  |SI FSalida = 0;
                     |SI aMovto ! #dscam004#5; |O fFecMv ! #dscam004#6; |O nImpMv ! #dscam004#8;
                        SwError = 1; |ERROR10;
                        |SAL;
                     |FINSI;
                  |SINO;
                     SwError = 1; |ERROR10;
                     |SAL;
                  |FINSI;
                  |REPON_FICHA #dscam004;

                  |LEE 000#dscam004.s;
               |SIGUE;
               |CIERRA #dscam004;
            |SINO;
               SwError = 1; |ERROR10; |ACABA;
            |FINSI;
         |SINO;
            |SI nSwLuxe = 1; |Y #dscam003#14 = "I";
               |ABRE #dscam004;
               #dscam004#17 = #dscam003#40;
               #dscam004#3 = 1;
               |LEE 000#dscam004.];
               |SI FSalida ! 0; |O #dscam004#17 ! #dscam003#40;
                  || Si esta marcado como impagado y no tiene lineas, es de
                  ||    los factorings de Luxe
                  nLuxadas  = 1;
               |SINO;
                  nLuxadas  = 0;
                  SwError = 1; |ERROR10; |ACABA;
               |FINSI;
            |SINO;
               SwError = 1; |ERROR10; |ACABA;
            |FINSI;
         |FINSI;
      |SINO;
         |ABRE #dscam004;
         #dscam004#17 = #dscam003#40;
         #dscam004#3 = 1;
         |LEE 000#dscam004.];
         |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
            SwError = 1; |ERROR10;
            |CIERRA #dscam004; |ACABA;
         |FINSI;
         |CIERRA #dscam004;
      |FINSI;
   |FINSI;
   |SI #0#0 = "C";
      |SI #dscam008#14 ! "P"; |Y #dscam008#14 ! "l";
         SwError = 1; |ERROR10; |ACABA;
      |SINO;
         |ABRE #dscam009;
         #dscam009#14 = #dscam008#40;
         #dscam009#3 = 1;
         |LEE 000#dscam009.];
         |SI FSalida = 0; |Y #dscam009#17 = #dscam008#40;
            SwError = 1; |ERROR10;
            |CIERRA #dscam009; |ACABA;
         |FINSI;
         |CIERRA #dscam009;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE CompruebaV;
#dscam003#1;
82,83;
000000001,"S",#dscaz005#17;
999999999,"S",#dscaz005#17;
;
NULL,Comprueba;
|FIN;

|DEFBUCLE CompruebaC;
#dscam008#1;
69,70;
000000001,"S",#dscaz005#17;
999999999,"S",#dscaz005#17;
;
NULL,Comprueba;
|FIN;

|PROCESO BorraObservSit;
   |BORRA 020#dscam219.a; |LIBERA #dscam219;
|FPRC;

|DEFBUCLE BorraObservSit;
#dscam219#1;
;
aAlfa, 001;
aAlfa, 999;
be;
NULL, BorraObservSit;
|FIN;

|PROCESO EliminaHistSit;
   aAlfa = (("0000000000" + #dscam164#0) % -110) + "/" + #dscam164#1 + "/" + #dscam164#2;
   aAlfa = (aAlfa + (" " * 30)) % 0130;
   |BUCLE BorraObservSit;
   |BORRA 020#dscam164.a;    |LIBERA #dscam164;
|FPRC;

|DEFBUCLE EliminaHistSit;
#dscam164#1;
;
#dscam003#40, "00.00.0000", "        ";
#dscam003#40, "31.12.9999", "zzzzzzzz";
be;
NULL, EliminaHistSit;
|FIN;

|PROCESO HistSitDiv;
   |SI nSwOp = 1;
      |DDEFECTO #dscam164;
      #dscam164#0 = #dscam003#40;
      |LEE 000#dscam164.];
      |SI FSalida = 0; |Y #dscam164#0 = #dscam003#40;
         nSwHay = 1;
      |FINSI;
   |FINSI;

   |SI nSwOp = 2;
      #dscam221#0 = #dscam003#40;
      |LEE 101#dscam221.=;
      |SI FSalida = 0;
         |BORRA 020#dscam221.a; |LIBERA #dscam221;
      |FINSI;
      |BUCLE EliminaHistSit;
   |FINSI;
|FPRC;

|DEFBUCLE HistSitDiv;
#dscam003#9;
83;
nLibro, aSerie, 000000, 000, 000000001, nDocDiv;
nLibro, aSerie, 999999, 999, 999999999, nDocDiv;
;
NULL,  HistSitDiv;
|FIN;

|PROCESO DesDivision;
   |SI #dscaz004#0 = "V";
      |SI nSwArtenvas = 1;
         nSwError = 0;
         |SALVA_FICHA #dscam003;
         #dscam003#40 = #dscaz005#17;
         |LEE 000#dscam003.=;
         |SI FSalida = 0;
            nLibro = #dscam003#27;
            aSerie = #dscam003#0;
            nDocDiv = #dscam003#40;
            nSwHay = 0; nSwOp = 1;
            |BUCLE HistSitDiv;
            |SI nSwHay = 1;
               aAlfa = "    NRecibo con movimientos en el historico de situaciones. " + &191 + " Continuar ?";
               |CONFI aAlfa;
               |SI FSalida = 0;
                  nSwOp = 2; |BUCLE HistSitDiv;
               |SINO;
                  nSwError = 1;
               |FINSI;
            |FINSI;
         |FINSI;
         |REPON_FICHA #dscam003;
         |SI nSwError = 1; |ACABA; |FINSI;
      |FINSI;

      nSwImp = 0;
      #dscam003#40 = #dscaz005#17;
      |LEE 101#dscam003.=;
      |SI FSalida = 0;
         |SI #dscam003#16 > 0; nSwImp = 1; |FINSI;
         SwError = 0;
         |SALVA_FICHA #dscam003; |BUCLE CompruebaV; |REPON_FICHA #dscam003;
         |SI SwError > 0;
            |SI SwError = 1;
               |MENAV "    Recibos divisores con movimientos.No se puede anular la division";
               |LIBERA #dscam003;
               |ERROR; |ACABA;
            |FINSI;
         |FINSI;
         |SI nSwLuxe = 1; |Y nLuxadas = 1;
            #dscam004#17 = #dscam003#40;
            #dscam004#3  = 99;
            |LEE 000#dscam004.];
            |SI FSalida = 0;
               |LEE 000#dscam004.a;
            |SINO;
               |LEE 000#dscam004.u;
            |FINSI;
            |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |Y #dscam004#5 = "FAP";
               |LEE 101#dscam004.=;
               |SI FSalida = 0;
                  #dscam003#55 = #dscam003#30 - #dscam004#7; #dscam003#68 = #dscam003#64 - #dscam004#25;
                  #dscam003#31 = 0;                          #dscam003#65 = 0;
                  #dscam003#23 = #dscam004#7;                #dscam003#61 = #dscam004#25;
                  #dscam003#30 = #dscam004#7;                #dscam003#64 = #dscam004#25;
                  |BORRA 020#dscam004.a; |LIBERA #dscam004;
               |FINSI;
               |LEE 000#dscam004.a;
               |SI FSalida = 0; |Y #dscam004#5 = "REM";
                  |ABRE #dscam013;
                  |SELECT #2#dscam013;
                  #dscam013#16 = #dscam004#17;
                  #dscam013#17 = #dscam004#3;
                  |LEE 101#dscam013.=;
                  |SI FSalida = 0; |Y #dscam013#15 = "S";
                     #dscam013#15 = "N";
                     |GRABA 020#dscam013.a; |LIBERA #dscam013;
                  |FINSI;
                  |SELECT #1#dscam013;
                  |ABRE #dscam013;
               |FINSI;
            |FINSI;
         |FINSI;
         |SI #dscam003#31 = 0;
            #dscam003#14 = "L";
            #dscam003#15 = "Recibo Liquidado";
         |SINO;
            |SI #dscam003#23 = 0;
               |SI #dscam003#70 = "          ";
                  |SI #dscam003#16 = 0;
                     #dscam003#14 = "P";
                     #dscam003#15 = "Pendiente de cobro";
                  |SINO;
                     #dscam003#14 = "I";
                     #dscam003#15 = "Impagado";
                  |FINSI;
               |SINO;
                  |ABRE #dscam004;
                  #dscam004#17 = #dscam003#40;
                  #dscam004#3  = 1;
                  |LEE 000#dscam004.];
                  |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
                     aAlfa = #dscam004#5; |QBF aAlfa;
                     |LEE 000#dscam004.s;
                  |SIGUE;
                  |CIERRA #dscam004;
                  |SI aAlfa = "IMP";
                     #dscam003#14 = "I";
                     #dscam003#15 = "Impagado";
                  |SINO;
                     #dscam003#14 = "T";
                     #dscam003#15 = "Pagare/Talon de cliente";
                  |FINSI;
               |FINSI;
            |SINO;
               #dscam003#14 = "C";
               #dscam003#15 = "Parcialmente cobrado";
            |FINSI;
         |FINSI;
         |GRABA 020#dscam003.a; |LIBERA #dscam003;

         |ABRE #dscam170;
         #dscam170#0 = #dscam003#40;
         #dscam170#3 = #dscam003#3;
         |LEE 101#dscam170.=;
         |SI FSalida = 0;
            |BORRA 020#dscam170.a;
         |FINSI;
         |LIBERA #dscam170; |CIERRA #dscam170;

         eaUsuario = Usuario % 0810;
         eaDescr   = "ELIMINACION DIVISION DOCUMENTO VENTA (" + (("000000000" + #dscam003#40) % -109) + ")";
         eaTipoReg = "DV";  eaNumero = ("000000000" + #dscam003#40) % -109;
         eaTipoOp  = "B";   enImpAct = #dscam003#30; enImpAnt = 0;
         |HAZ GrabaAudit;
      |FINSI;
      |ABRE #dscam170;
      |BUCLE DesDivideV;
      |CIERRA #dscam170;
   |FINSI;
   |SI #dscaz004#0 = "C";
      #dscam008#40 = #dscaz005#17;
      |LEE 101#dscam008.=;
      |SI FSalida = 0;
         SwError = 0;
         |SALVA_FICHA #dscam008; |BUCLE CompruebaC; |REPON_FICHA #dscam008;
         |SI SwError ! 0;
            |MENAV "    Recibos divisores con movimientos.No se puede anular la division";
            |LIBERA #dscam008;
            |ERROR; |ACABA;
         |FINSI;
         |SI #dscam008#23 = 0;
            #dscam008#39 = " "; #dscam008#47 = "";
            #dscam008#14 = "P";
            #dscam008#15 = "Pendiente de pago";
         |SINO;
            |SI #dscam008#17 = 0;
               #dscam008#14 = "E";
               |SI #dscam008#39 = "P"; #dscam008#15 = "Englobado en pagare  "; |FINSI;
               |SI #dscam008#39 = "C"; #dscam008#15 = "Englobado en confirme"; |FINSI;
               |SI #dscam008#39 = "T"; #dscam008#15 = "Englobado en talon   "; |FINSI;
            |FINSI;
            |SI #dscam008#31 = 0;
               #dscam008#14 = "L";
               #dscam008#15 = "Recibo liquidado";
            |SINO;
               #dscam008#14 = "C";
               #dscam008#15 = "Parcialmente pagado";
            |FINSI;
         |FINSI;
         |GRABA 020#dscam008.a; |LIBERA #dscam008;
         eaUsuario = Usuario % 0810;
         eaDescr   = "ELIMINACION DIVISION DOCUMENTO COMPRA (" + (("000000000" + #dscam008#40) % -109) + ")";
         eaTipoReg = "DC";  eaNumero = ("000000000" + #dscam008#40) % -109;
         eaTipoOp  = "B";   enImpAct = #dscam008#25; enImpAnt = 0;
         |HAZ GrabaAudit;
      |FINSI;
      |BUCLE DesDivideC;
   |FINSI;
|FPRC;

|PROCESO RecogeDivV;
   #dscam003#40 = #dscaz005#17;
   |LEE 000#dscam003.=;
   |SI FSalida = 0;
      |DDEFECTO #dscaz019;
      #dscaz019#0 = 1;
      #dscaz019#1 = #dscam003#40;
      #dscaz019#2 = #dscam003#3;
      #dscaz019#3 = #dscam003#31;
      |GRABA 020#dscaz019.n;
      TotAgrup = TotAgrup + #dscaz019#3;
   |FINSI;
|FPRC;

|PROCESO RecogeDivC;
   #dscam008#40 = #dscaz005#17;
   |LEE 000#dscam008.=;
   |SI FSalida = 0;
      |DDEFECTO #dscaz019;
      #dscaz019#0 = 1;
      #dscaz019#1 = #dscam008#40;
      #dscaz019#2 = #dscam008#3;
      #dscaz019#3 = #dscam008#31;
      |GRABA 020#dscaz019.n;
      TotAgrup = TotAgrup + #dscaz019#3;
   |FINSI;
|FPRC;

|PROCESO CartaGtosAp;
   |SI #dscaz019#2 [ #dscaz005#5; |ACABA; |FINSI;

   #dscam003#40 = #dscaz019#1;
   |LEE 000#dscam003.=;
   |SI FSalida ! 0; |DDEFECTO #dscam003; |FINSI;

   Dia  = #dscam003#4 % 0102; Dia = ("00" + Dia) % -102;
   Mes  = #dscam003#4 % 0402; Mes = ("00" + Mes) % -102; |HAZ MesLetra; |QBF Mes;
   anyo = #dscam003#4 % -104;
   FecEmision = Dia + " de " + Mes + " de " + anyo;

   eaCodigo = #dscam003#32; eaTipoCod = "C"; aCuenta = #dscam003#5; |HAZ LeeDatos;
   enDocumento = #dscaz005#12; efFecVto = #dscaz005#5;

   |PRINT;
|FPRC;

|DEFBUCLE CartaGtosAp;
#dscaz019#1;
;
INICIO;
FINAL;
;
NULL, CartaGtosAp;
|FIN;

|PROCESO Marca; |TIPO 11;
   |SI FSalida = 10;
      |SI Cuenta = "";
         Cuenta = #dscaz005#10; ||QBF Cuenta;
         Divisa = #dscaz005#14; |QBF Divisa;
         Cambio = #dscaz005#15;
      |SINO;
         Comodin = #dscaz005#10; ||QBF Comodin;
         |SI Cuenta ! Comodin;
            |AVISO;
            |SI #dscaz004#0 = "V";
               Comodin = "    El cliente de este recibo no se corresponde al de los demas";
            |SINO;
               Comodin = "    El proveedor de este recibo no se corresponde al de los demas";
            |FINSI;
            |MENAV Comodin;
            |ACABA;
         |FINSI;
         Comodin = #dscaz005#14; |QBF Comodin;
         |SI Divisa ! Comodin;
            |AVISO;
            |MENAV "    La divisa de este recibo no se corresponde al de los demas";
            |ACABA;
         |FINSI;
         |SI Cambio ! #dscaz005#15;
            |AVISO;
            |MENAV "    El cambio de este recibo no se corresponde al de los demas";
            |ACABA;
         |FINSI;
      |FINSI;
      |PONCONTROL 23,"si";
      |SI #dscaz005#9 = " ";
         |SI nTR > 0;
            |SI nTR ! #dscaz005#6; nTR = -1; |FINSI;
         |SINO;
            |SI nTR = 0; nTR = #dscaz005#6;  |FINSI;
         |FINSI;
         |SI #dscaz005#20 ! aTipoClas; |Y NumRecs ! 0;
            |MENAV "    La clasificacion de este documento es distinta a al de los ya seleccionados";
            |ERROR; |ACABA;
         |FINSI;
         |SI #dscaz005#21 ! aPreparado; |Y NumRecs ! 0;
            |SI aPreparado = "N";
               |MENAV "    Se estan agrupando documentos no preparados y este lo esta";
            |SINO;
               |MENAV "    Se estan agrupando documentos preparados y este no lo esta";
            |FINSI;
            |ERROR; |ACABA;
         |FINSI;
         |SI #dscaz005#22 ! aAceptar; |Y NumRecs ! 0;
            |SI aAceptar = "N";
               |MENAV "    Se estan agrupando documentos para no aceptar y este lo es";
            |SINO;
               |MENAV "    Se estan agrupando documentos a aceptar y este no lo es";
            |FINSI;
            |ERROR; |ACABA;
         |FINSI;
         |SI #dscaz005#23 ! aAceptado; |Y NumRecs ! 0;
            |SI aAceptado = "N";
               |MENAV "    Se estan agrupando documentos no aceptados y este lo esta";
            |SINO;
               |MENAV "    Se estan agrupando documentos aceptados y este no lo esta";
            |FINSI;
            |ERROR; |ACABA;
         |FINSI;
         |SI #dscaz005#24 ! aEstado; |Y NumRecs ! 0;
            nSwErr = 1;
            |SI #dscaz005#24 = "P"; |Y aEstado = "I"; nSwErr = 0; |FINSI;
            |SI #dscaz005#24 = "C"; |Y aEstado = "I"; nSwErr = 0; |FINSI;
            |SI #dscaz005#24 = "I"; |Y aEstado = "P"; nSwErr = 0; |FINSI;
            |SI #dscaz005#24 = "I"; |Y aEstado = "C"; nSwErr = 0; |FINSI;
            |SI #dscaz005#24 = "P"; |Y aEstado = "C"; nSwErr = 0; |FINSI;
            |SI #dscaz005#24 = "C"; |Y aEstado = "P"; nSwErr = 0; |FINSI;
            |SI nSwErr = 1;
               |MENAV "    Este documento no esta en el mismo estado que los ya seleccionados";
               |ERROR; |ACABA;
            |SINO;
               nSwImpa = 1;
            |FINSI;
         |FINSI;
         |SI #dscaz005#23 = "S";
            |MENAV "    Este documento esta aceptado. No se puede agrupar";
            |ERROR; |ACABA;
         |FINSI;
         |SI #dscaz005#24 = "V";
            |MENAV "    Este documento esta enviado para su aceptado. No se puede agrupar";
            |ERROR; |ACABA;
         |FINSI;
         aTipoClas = #dscaz005#20; aPreparado = #dscaz005#21;
         aAceptar  = #dscaz005#22; aAceptado  = #dscaz005#23;
         aEstado   = #dscaz005#24;
         enSwError = 0;
         |SI enSwError = 0;
            eaTOperacion = "A"; eaTipoRecibo = #0#0; enNumDocum = #dscaz005#12; |HAZ ProcesaTempo;
            #dscaz005#9 = "*";
            NumRecs = NumRecs + 1;
            |SI #dscaz005#18 = "S"; HayEntrega = 1; |FINSI;
            Cantidad = Cantidad + #dscaz005#8;
            Cantidad = Cantidad ! nDeci_Div;
            fFechaHoy = ~; fFechaVto = #dscaz005#5;
            nCalcF1 = fFechaVto; nCalcF2 = fFechaHoy; nCalcF1 = nCalcF1 - nCalcF2;
            nSumaLuxe = nSumaLuxe + (nCalcF1*#dscaz005#8);

            |SI #dscaz005#5 > VtoMasAlto;
               VtoMasAlto = #dscaz005#5;
            |FINSI;
            |SI #dscaz005#19 ] LimEmisAlt; LimEmisAlt = #dscaz005#19; |FINSI;
            |SI #dscaz005#19 [ LimEmisBaj; LimEmisBaj = #dscaz005#19; |FINSI;
         |FINSI;
      |SINO;
         eaTOperacion = "B"; eaTipoRecibo = #0#0; enNumDocum = #dscaz005#12; |HAZ ProcesaTempo;
         |SI enSwError = 0;
            #dscaz005#9 = " ";
            Cantidad = Cantidad - #dscaz005#8;
            Cantidad = Cantidad ! nDeci_Div;
            NumRecs = NumRecs - 1;
            fFechaHoy = ~; fFechaVto = #dscaz005#5;
            nCalcF1 = fFechaVto; nCalcF2 = fFechaHoy; nCalcF1 = nCalcF1 - nCalcF2;
            nSumaLuxe = nSumaLuxe - (nCalcF1*#dscaz005#8);
         |FINSI;
      |FINSI;
      |GRABA 020#dscaz005.a;
      |HAZ Totales;
      |SI NumRecs = 0;
         aTipoClas = ""; aPreparado = "";
         aAceptar  = ""; aAceptado  = "";
         aEstado   = "";
      |FINSI;
      |PINDA #0#dscaz005;
      |PONCONTROL 23,"si";
   |FINSI;
   |SI FSalida = 11;
      |SALVA_FICHA #dscaz005;
      |PONCONTROL 23,"si";
      Cantidad = 0;
      |SI Cuenta = "";
         Cuenta = #dscaz005#10; |QBF Cuenta;
         Divisa = #dscaz005#14; |QBF Divisa;
         Cambio = #dscaz005#15;
      |FINSI;
      |BUCLE MarcaTodos;
      |HAZ Totales;
      |PONCONTROL 23,"SI";
      |REPON_FICHA #dscaz005;
   |FINSI;
   |SI FSalida = 12;
      |SALVA_FICHA #dscaz005;
      |PONCONTROL 23,"si";
      Cantidad = 0; NumRecs = 0;
      |BUCLE DesmarcaTodos;
      |HAZ Totales;
      |PONCONTROL 23,"SI";
      |REPON_FICHA #dscaz005;
   |FINSI;
   |SI FSalida = 13;
      |SI nSwArtenvas = 0;
         |SI Cantidad = 0; |Y NumRecs = 0;
            |AVISO;
            |MENAV "    Debe tener algun recibo seleccionado";
         |SINO;
            Total = 0;   TotalDiv = 0;
            Cuenta = ""; Divisa = "";   Cambio = 0;
            |HAZ Agrupacion;
            Salir = 0;
            |PTEC 807;
         |FINSI;
      |SINO;
         |SI NumRecs = 0;
            |AVISO;
            |MENAV "    Debe tener algun recibo seleccionado";
         |SINO;
            |SI Cantidad ! 0; |Y #0#0 = "V";
               |AVISO;
               |MENAV "    El resultado de la agrupación debe ser 0";
            |SINO;
               Total = 0;   TotalDiv = 0;
               Cuenta = ""; Divisa = "";   Cambio = 0;
               |HAZ Agrupacion;
               Salir = 0;
               |PTEC 807;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;
   |SI FSalida = 14;
      |SI #dscaz005#13 = "S";
         Linea = 1;
         TotAgrup = 0;
         |DELINDEX #dscaz019;
         |ABRE #dscaz019;
         |SI #dscaz004#0 = "V";
            |BUCLE RellenaTempo1;
         |SINO;
            |BUCLE RellenaTempo2;
         |FINSI;
         |PUSHV 05011480;
         Comodin = " " * 80
         |PINTA 0501, Comodin; |PINTA 0601, Comodin; |PINTA 0701, Comodin; |PINTA 0801, Comodin;
         |PINTA 0901, Comodin; |PINTA 1001, Comodin; |PINTA 1101, Comodin; |PINTA 1201, Comodin;
         |PINTA 1301, Comodin; |PINTA 1401, Comodin;
         |CUADRO 0559 0779;
         |PINTA 0660, "                   ";
         |ATRI R; |PINTA 0660, " Total "; |ATRI N;
         Comodin = TotAgrup; |HAZ PonComas;
         |PINTA 0668,Comodin;
         |CUADRO 0613 1356;
         |ATRI R; |PINTA 614, " DETALLE AGRUPACION DOCUMENTO "; |ATRI N;
         |ATRI R; |PINTA 714, "Linea Documento Fecha Vto. Importe Pendte.";                |ATRI N;
         |ENTLINEAL #1#dscaz019,-1,4,12,1,inf1,sup1;
         |POPV;
         |CIERRA #dscaz019;
      |FINSI;
      |SI #dscaz005#16 = "S";
         Linea = 1;
         TotAgrup = 0;
         |DELINDEX #dscaz019;
         |ABRE #dscaz019;
         |SI #dscaz004#0 = "V";
            |HAZ RecogeDivV;
         |SINO;
            |HAZ RecogeDivC;
         |FINSI;
         |PUSHV 05011480;
         Comodin = " " * 80
         |PINTA 0501, Comodin; |PINTA 0601, Comodin; |PINTA 0701, Comodin; |PINTA 0801, Comodin;
         |PINTA 0901, Comodin; |PINTA 1001, Comodin; |PINTA 1101, Comodin; |PINTA 1201, Comodin;
         |PINTA 1301, Comodin; |PINTA 1401, Comodin;
         |CUADRO 0559 0779;
         |PINTA 0660, "                   ";
         |ATRI R; |PINTA 0660, " Total "; |ATRI N;
         Comodin = TotAgrup; |HAZ PonComas;
         |PINTA 0668,Comodin;
         |CUADRO 0613 1356;
         |ATRI R; |PINTA 614, " DETALLE AGRUPACION DOCUMENTO "; |ATRI N;
         |ATRI R; |PINTA 714, "Linea Documento Fecha Vto. Importe Pendte.";                |ATRI N;
         |ENTLINEAL #1#dscaz019,-1,4,12,1,inf1,sup1;
         |POPV;
         |CIERRA #dscaz019;
      |FINSI;
   |FINSI;
   |SI FSalida = 15;
      |SI #dscaz005#13 = "S";
         |HAZ Desagrupacion;
         Salir = 0; |PTEC 807;
      |FINSI;
      |SI #dscaz005#16 = "S";
         |HAZ DesDivision;
         Salir = 0; |PTEC 807;
      |FINSI;
   |FINSI;
   |SI FSalida = 16;
      |SI #dscaz005#8 = 0;
         |MENAV "    Este recibo no tiene importe pendiente para ser dividido";
         |ACABA;
      |FINSI;
      |PUSHV 05011480;
      Comodin = " " * 80
      |PINTA 0501, Comodin; |PINTA 0601, Comodin; |PINTA 0701, Comodin; |PINTA 0801, Comodin;
      |PINTA 0901, Comodin; |PINTA 1001, Comodin; |PINTA 1101, Comodin; |PINTA 1201, Comodin;
      |PINTA 1301, Comodin; |PINTA 1401, Comodin;
      |CUADRO 0559 0779;
      |PINTA 0660, "                   ";
      |ATRI R; |PINTA 0660, " Total "; |ATRI N;
      TotAgrup = #dscaz005#8;
      Comodin = TotAgrup; |HAZ PonComas;
      |PINTA 0668,Comodin;
      aSerDiv = #dscaz005#1; nFacDiv = #dscaz005#2; nDiasCalcDiv = #dscaz005#26;
      |HAZ Divide;
      |POPV;
      Salir = 0; |PTEC 807;
   |FINSI;
   |SI FSalida = 17;
      |SI #dscaz005#13 = "S"; |O #dscaz005#16 = "S";
         |HAZ SacaCarta;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO Totales;
   Comodin = Cantidad; |HAZ PonComas;
   Comodin = "Importe seleccion " + Comodin + "          ";
   |PINTA 2410, Comodin;
   |SI Cantidad = 0; Cuenta = ""; |FINSI;
|FPRC;

|PROCESO PonComas;
   Calc = Comodin;
   |SI Calc < 0;
      Calc = 0 - Calc;
      Comodin = Calc;
      SwNeg = 1;
   |SINO;
      SwNeg = 0;
   |FINSI;

   Comodin1 = Comodin;
   Comodin1 = Comodin1 - ".";
   |SI FSalida ! 0;
      Calc = FSalida + 98;
      Comodin1 = Comodin1 % Calc;
      nDecimales = Comodin1;
      aDecimales = Comodin1; |QBF aDecimales;

      LongAlfa = aDecimales % 0; Long = LongAlfa;
      |SI Long < 2;
         Long = 2 - Long;
         aDecimales = aDecimales + ("0" * Long);
      |FINSI;
      || Comodin = Comodin - Comodin1; Comodin = Comodin - ".";
      Calc = Calc - 199; Calc = 100 + ((Calc / 100) ! 0);
      Comodin = Comodin % Calc;
   |SINO;
      nDecimales = 0;
      aDecimales = "00";
   |FINSI;

   Comodin1 = Comodin;
   Comodin = "";
   |PARA; |SI Comodin1 ! ""; |HACIENDO;
      LongAlfa = Comodin1 % 0;
      Long = LongAlfa;
      |SI Long [ 3;
         Cadena = Comodin1;
         Comodin1 = "";
         |QBF Cadena;
         Comodin = Cadena + Comodin;
      |SINO;
         Cadena = Comodin1 % -103;
         Comodin1 = Comodin1 - Cadena;
         Comodin  = "." + Cadena + Comodin;
      |FINSI;
   |SIGUE;
   |SI SwNeg = 1;
      Comodin = "-" + Comodin;
   |FINSI;
   |SI nDecimales ] 0;
      Comodin = Comodin + ",";
      ||SI nDecimales < 10; Comodin = Comodin + "0"; |FINSI;
      Comodin = Comodin + aDecimales;
      ||Comodin = Comodin + nDecimales;
   |FINSI;
|FPRC;

|PROCESO Desagrupa;
   |SI #dscaz004#0 = "V";
      #dscam003#41 = 0;
      |SI #dscam003#23 = 0;
         |SI #dscam003#16 = 0;
            #dscam003#14 = "P";
            #dscam003#15 = "Pendiente de cobro";
         |SINO;
||      Para las agrupaciones y divisiones hay un parametro que determina
||      como actuar con el riesgo (#dscam051#114) ABDON (001483/00703)
            |SI #dscam051#3 = "S"; |Y #dscam051#114 = 1;
               |SALVA_FICHA #dscam003;
               enBanco = -1;
               || enEmpCartera = #48#0;    enEmpGestion = #dscam003#46;
               enEmpCartera = -1;       enEmpGestion = #dscam003#46;
               eaSerie = #dscam003#0;   eaCliGest = #dscam003#32;
               nImporte = #dscam003#65; eaTipoOper = "+7-4";
               |HAZ BucleRiesgo;
               |REPON_FICHA #dscam003;
            |FINSI;
            #dscam003#14 = "I";
            #dscam003#15 = "Impagado";
         |FINSI;
      |SINO;
         |SI #dscam003#31 = 0;
            |SI #dscam003#47 = "S";    || Entrega a cuenta
               #dscam003#14 = "e";
               #dscam003#15 = "Pendiente de compensar";
            |SINO;
               #dscam003#14 = "L";
               #dscam003#15 = "Recibo liquidado";
            |FINSI;
         |SINO;
            |SI #dscam003#47 = "S";    || Entrega a cuenta
               #dscam003#14 = "E";
               #dscam003#15 = "Compensado parcialmente";
            |SINO;
               #dscam003#14 = "C";
               #dscam003#15 = "Parcialmente cobrado";
            |FINSI;
         |FINSI;
      |FINSI;
      |GRABA 020#dscam003.a;
   |SINO;
      #dscam008#41 = 0;
      |SI #dscam008#23 = 0;
         #dscam008#14 = "P";
         #dscam008#15 = "Pendiente de pago";
      |SINO;
         |SI #dscam008#31 = 0;
            #dscam008#14 = "L";
            #dscam008#15 = "Recibo liquidado";
         |SINO;
            #dscam008#14 = "C";
            #dscam008#15 = "Parcialmente pagado";
         |FINSI;
      |FINSI;
      |GRABA 020#dscam008.a;
   |FINSI;
|FPRC;

|DEFBUCLE Desagrupa1;
#dscam003#1;
41;
000000001,#dscaz005#12;
999999999,#dscaz005#12;
;
NULL,Desagrupa;
|FIN;

|DEFBUCLE Desagrupa2;
#dscam008#1;
41;
000000001,#dscaz005#12;
999999999,#dscaz005#12;
;
NULL,Desagrupa;
|FIN;

|PROCESO BorraAgrp;
   |SI #dscaz004#0 = "V";
      |BORRA 020#dscam004.a;
   |SINO;
      |BORRA 020#dscam009.a;
   |FINSI;
|FPRC;

|DEFBUCLE BorraAgrp1;
#dscam004#1;
;
#dscaz005#12,01;
#dscaz005#12,99;
;
NULL,BorraAgrp;
|FIN;

|DEFBUCLE BorraAgrp2;
#dscam009#1;
;
#dscaz005#12,01;
#dscaz005#12,99;
;
NULL,BorraAgrp;
|FIN;

|PROCESO CompruebaHistSit;
   nSwError = 0;
   |DDEFECTO #dscam164;
   #dscam164#0 = #dscam003#40;
   |LEE 000#dscam164.];
   |SI FSalida = 0; |Y #dscam164#0 = #dscam003#40;
      aAlfa = "    NRecibo con movimientos en el historico de situaciones. " + &191 + " Continuar ?";
      |CONFI aAlfa;
      |SI FSalida = 0;
         #dscam221#0 = #dscaz005#12;
         |LEE 101#dscam221.=;
         |SI FSalida = 0;
            |BORRA 020#dscam221.a; |LIBERA #dscam221;
         |FINSI;
         |BUCLE EliminaHistSit;
      |SINO;
         |MENAV "    Proceso cancelado";
         nSwError = 1;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO Desagrupacion;
   |SI #dscaz004#0 = "V";
      #dscam003#40 = #dscaz005#12;
      |LEE 000#dscam003.=;
      |SI FSalida = 0;
         |SI nSwArtenvas = 1;
            |HAZ CompruebaHistSit;
            |SI nSwError = 1; |ACABA; |FINSI;
         |FINSI;
      |FINSI;

      |BUCLE Desagrupa1;
      #dscam003#40 = #dscaz005#12;
      |LEE 010#dscam003.=;
      |SI FSalida = 0;
         eaUsuario = Usuario % 0810;
         eaDescr   = "ELIMINACION DOCUMENTO AGRUPADOR VENTAS (" + (("000000000" + #dscam003#40) % -109) + ")";
         eaTipoReg = "AV";  eaNumero = ("000000000" + #dscam003#40) % -109;
         eaTipoOp  = "B";
         |SI #dscam003#37 = "N";
            enImpAnt = #dscam003#30;
         |SINO;
            enImpAnt = 0 - #dscam003#30;
         |FINSI;
         enImpAct = 0;
         |HAZ GrabaAudit;

         |BORRA 020#dscam003.a;
         || El auxiliar;
         #dscam224#0 = #dscam003#40;
         |LEE 101#dscam224.=;
         |SI FSalida = 0;
              |BORRA 020#dscam224.a;
         |FINSI;

         |ABRE #dscam170;
         #dscam170#0 = #dscam003#40;
         |LEE 101#dscam170.];
         |PARA; |SI FSalida = 0; |Y #dscam170#0 = #dscam003#40; |HACIENDO;
            |SI #dscam170#4 = "N"; |BORRA 020#dscam170.a; |LIBERA #dscam170; |FINSI;
            |LEE 101#dscam170.s;
         |SIGUE;
         |LIBERA #dscam170; |CIERRA #dscam170;

      |FINSI;
      |BUCLE BorraAgrp1;
   |SINO;
      |BUCLE Desagrupa2;
      #dscam008#40 = #dscaz005#12;
      |LEE 010#dscam008.=;
      |SI FSalida = 0;
         eaUsuario = Usuario % 0810;
         eaDescr   = "ELIMINACION DOCUMENTO AGRUPADOR COMPRAS (" + (("000000000" + #dscam008#40) % -109) + ")";
         eaTipoReg = "AC";  eaNumero = ("000000000" + #dscam008#40) % -109;
         eaTipoOp  = "B";   enImpAnt = #dscam008#25; enImpAct = 0;
         |HAZ GrabaAudit;

         |BORRA 020#dscam008.a;
      |FINSI;
      |BUCLE BorraAgrp2;
   |FINSI;
   eaTOperacion = "B"; eaTipoRecibo = #0#0; enNumDocum = #dscaz005#12; |HAZ ProcesaTempo;
|FPRC;

|PROCESO Volcado;
   |SI #dscaz004#0 = "V";
      #dscam003#40 = #dscaz005#12;
      |LEE 101#dscam003.=;
      |SI FSalida = 0;
         |SI #dscam003#16 ! 0;
||      Para las agrupaciones y divisiones hay un parametro que determina
||      como actuar con el riesgo (#dscam051#114) ABDON (001483/00703)
            |SI #dscam051#3 = "S"; |Y #dscam051#114 = 1;
               |SALVA_FICHA #dscam003;
               enBanco = -1;
               enEmpCartera = -1;       enEmpGestion = #dscam003#46;
               eaSerie = #dscam003#0;   eaCliGest = #dscam003#32;
               nImporte = #dscam003#65; eaTipoOper = "-7+4";
               |HAZ BucleRiesgo;
               |REPON_FICHA #dscam003;
            |FINSI;
         |FINSI;
         #dscam003#14 = "A";
         #dscam003#15 = "Agrupado";
         #dscam003#41 = #dscaz006#7;
         |GRABA 020#dscam003.a; |LIBERA #dscam003;

         nGtosArrastradosD = nGtosArrastradosD + #dscam003#101;
         nGtosArrastradosB = nGtosArrastradosB + #dscam003#102;
         |SI #dscam003#24 ! 0; |O #dscam003#25 ! 0; |O #dscam003#38 ! 0;
            |SI #dscam003#22 ! #dscam003#30;
               nGtosArrastradosD = nGtosArrastradosD + #dscam003#24 + #dscam003#25 + #dscam003#38;
               nGtosArrastradosB = nGtosArrastradosB + #dscam003#62 + #dscam003#63 + #dscam003#66;
            |FINSI;
         |FINSI;

         |SI #dscam003#47 = "S";
            Total    = Total    - #dscam003#23;
            TotalDiv = TotalDiv - #dscam003#61;
         |SINO;
            Total    = Total    + #dscam003#31;
            TotalDiv = TotalDiv + #dscam003#65;
         |FINSI;
         aDomic   = #dscam003#7;
         aEntidad = #dscam003#8;
         aOficina = #dscam003#9;
         aDC      = #dscam003#10;
         aCta     = #dscam003#11;
      |FINSI;
   |SINO;
      #dscam008#40 = #dscaz005#12;
      |LEE 101#dscam008.=;
      |SI FSalida = 0;
         #dscam008#14 = "A";
         #dscam008#15 = "Agrupado";
         #dscam008#41 = #dscaz006#7;
         |GRABA 020#dscam008.a; |LIBERA #dscam008;
         Total    = Total    + #dscam008#31;
         TotalDiv = TotalDiv + #dscam008#58;
         aDomic   = #dscam008#7;
         aEntidad = #dscam008#8;
         aOficina = #dscam008#9;
         aDC      = #dscam008#10;
         aCta     = #dscam008#11;
      |FINSI;
   |FINSI;
   eaTOperacion = "B"; eaTipoRecibo = #0#0; enNumDocum = #dscaz005#12; |HAZ ProcesaTempo;
|FPRC;

|DEFBUCLE Volcado;
#dscaz005#1;
9;
00001,"*";
99999,"*";
;
NULL,Volcado;
|FIN;

|PROCESO RecibosCarta;
   |PRINT;
|FPRC;

|DEFBUCLE RecibosCartaV;
#dscam003#8;
;
000000001,DocAgrupador;
999999999,DocAgrupador;
be;
NULL,RecibosCarta;
|FIN;

|DEFBUCLE RecibosCartaC;
#dscam008#1;
41;
000000001,DocAgrupador;
999999999,DocAgrupador;
be;
NULL,RecibosCarta;
|FIN;

|DEFBUCLE RecibosCartaDivV;
#dscam003#1;
82,83;
000000001,"S",DocDividido;
999999999,"S",DocDividido;
be;
NULL,RecibosCarta;
|FIN;

|DEFBUCLE RecibosCartaDivC;
#dscam008#1;
69,70;
000000001,"S",DocDividido;
999999999,"S",DocDividido;
be;
NULL,RecibosCarta;
|FIN;

|PROCESO GeneraCarta;
   |IMPRE 0;
   |SI FSalida ! 0; |ACABA; |FINSI;

   |SI aSwAgrDiv = "A";
      aInforme = "Carta de agrupacion"; |HAZ ObtenInforme;
   |FINSI;
   |SI aSwAgrDiv = "D";
      aInforme = "Carta de division"; |HAZ ObtenInforme;
      |SI aInforme = "Carta de division"; aInforme = "cartaex2"; |FINSI;
   |FINSI;

   |INFOR aInforme;
   |SI FSalida ! 0; |ACABA; |FINSI;

   |SI #dscaz004#0 = "V";
      eaCodigo = #dscam003#32; eaTipoCod = "C"; aCuenta = #dscam003#5; |HAZ LeeDatos;
      eaSwCmpVta  = "V";
      |SI aSwAgrDiv = "A"; |BUCLE RecibosCartaV;    |FINSI;
      |SI aSwAgrDiv = "D"; |BUCLE RecibosCartaDivV; |FINSI;
   |SINO;
      eaCodigo = #dscam008#32; eaTipoCod = "P"; aCuenta = #dscam008#5; |HAZ LeeDatos;
      eaSwCmpVta  = "C";
      |SI aSwAgrDiv = "A"; |BUCLE RecibosCartaC;    |FINSI;
      |SI aSwAgrDiv = "D"; |BUCLE RecibosCartaDivC; |FINSI;
   |FINSI;

   |PIEINF; |FININF;

   |FINIMP;
|FPRC;

|PROCESO MiraLim;
   |SI #dscam051#69 = "D";
      |SI LimEmisBaj > #dscaz006#8; |O LimEmisAlt < #dscaz006#8;
         aAlfa = "    La fecha no esta dentro de los limites. [" + LimEmisBaj;
         aAlfa = aAlfa + " / " + LimEmisAlt + "]";
         |MENAV aAlfa; |ERROR;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO CompruebaTR;
   |SI #dscaz005#9 = " "; |ACABA; |FINSI;

   #dscam003#40 = #dscaz005#12;
   |LEE 000#dscam003.=;
   |SI FSalida = 0;
      aCodCli = #dscam003#32;
   |FINSI;

   |SI nTR = 0;
      nTR = #dscaz005#6;
   |SINO;
      |SI nTR ! #dscaz005#6;
         nTR = -1; |ERROR10;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE CompruebaTR;
#dscaz005#1;
;
INICIO;
FINAL;
;
NULL,  CompruebaTR;
|FIN;

|PROCESO Agrupacion;
   aSwAgrDiv = "A";
   Proceso   = "A";
   |SI #dscaz004#0 = "V";
      #dscaz006#4 = #dscam051#10;
   |SINO;
      #dscaz006#4 = #dscam051#11;
   |FINSI;

   |ABRE #dscam003;
   |ABRE #dscam224;
   |ABRE #dscam008;

   |SI nSwLuxe = 1;
      |SALVA_FICHA #dscaz005;
      nTR = 0; |BUCLE CompruebaTR;
      |REPON_FICHA #dscaz005;
      |SI nTR < 0;
         #agif024@#0 = aCodCli;
         |LEE 000#agif024@.=;
         |SI FSalida ! 0; |DDEFECTO #agif024@; |FINSI;

         aAlfa = #48#17; |QBF aAlfa;
         aAlfa = aAlfa + "def/agifa091.mas";
         |CARGA_DEF aAlfa, agifa091@;
         |SI FSalida = 0;
            aAlfa = #48#17; |QBF aAlfa;
            aAlfa = aAlfa + "fich/" + (("00000" + #48#15) % -105) + "/";
            |PATH_DAT #agifa091@#aAlfa#;
            |ABRE #agifa091@;
            #agifa091@#0 = #agif024@#20;
            |LEE 000#agifa091@.=;
            |SI FSalida ! 0; |DDEFECTO #agifa091@; |FINSI;
            nTR = #agifa091@#69;
            |CIERRA #agifa091@; |DESCARGA_DEF #agifa091@;
         |FINSI;
         |MENSA "    Tipo de recibo procedente de la forma de pago del cliente";
      |SINO;
         |MENSA "    Tipo de recibo asignado por ser todos los recibos agrupados del mismo tipo";
      |FINSI;
      #dscaz006#4 = nTR;

      fFechaHoy = ~; nCalc = fFechaHoy; nCalc = nCalc + (nSumaLuxe/Cantidad);
      |SI nCalc < 0; nCalc = 0; |FINSI;
      nCalc = nCalc ! 0;
      VtoMasAlto = nCalc; efFechaAgr = nCalc; enSwAplazAgr = 0;
   |FINSI;

   |PUSHV 05011480;
   Comodin = " " * 80
   |PINTA 0501, Comodin; |PINTA 0601, Comodin; |PINTA 0701, Comodin; |PINTA 0801, Comodin;
   |PINTA 0901, Comodin; |PINTA 1001, Comodin; |PINTA 1101, Comodin; |PINTA 1201, Comodin;
   |PINTA 1301, Comodin; |PINTA 1401, Comodin;
   #dscaz006#3 = VtoMasAlto; eaClasif = aTipoClas;
   #dscaz006#8 = ~;

   |SI #dscam051#69 = "S";
      |C_M #dscaz006#8,1,"N";
   |SINO;
      |C_M #dscaz006#8,1,"S";
   |FINSI;

   |PINPA #0#dscaz006;
   |PINDA #0#dscaz006;

   |SI #dscaz004#0 = "C";
      |C_M #dscaz006#9, 1, "S"; |C_V #dscaz006#9, 1, "S";
      |PINTA 1217, "º Referencia                                  º";
      |PINTA 1317, "ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼";
      |PINTA #dscaz006#9;
   |FINSI;

   |ENDATOS #1#dscaz006;
   |SI FSalida ! 0;
      enSwAplazAgr = 0;
      |POPV;
      |CIERRA #dscam003;
      |CIERRA #dscam008;
      |ACABA;
   |SINO;
      |SI #dscaz004#0 = "V";
         |CONFI "    NGenerar carta explicativa para el cliente ?";
         |SI FSalida = 0;
            Carta = 1;
         |SINO;
            Carta = 0;
         |FINSI;
      |SINO;
         Carta = 0;
      |FINSI;
      |LEE 000#dscaz005.p;
      |SI #dscaz005#9 = " ";
         |PARA; |SI #dscaz005#9 = " "; |HACIENDO;
            |LEE 000#dscaz005.s;
         |SIGUE;
      |FINSI;
      |SI #dscaz004#0 = "V";
         |LEE 000#dscam003.u; #dscaz006#7 = #dscam003#40 + 1;
         #dscam003#40 = #dscaz005#12;
         |LEE 000#dscam003.=;
         |SI FSalida = 0;
            #dscam003#40 = #dscaz006#7;
            |GRABA 020#dscam003.b;
            #dscam003#0 = #dscaz006#0;
            #dscam003#27 = 0;
            #dscam003#1  = 0;
            #dscam003#2  = 0;
            #dscam003#49 = "S";
            #dscam003#14 = "P";
            #dscam003#15 = "Pendiente de cobro";
            #dscam003#24 = 0; #dscam003#25 = 0; #dscam003#38 = 0;
            #dscam003#62 = 0; #dscam003#63 = 0; #dscam003#66 = 0;
            #dscam003#26 = "01.01.0000";
            #dscam003#17 = 0; #dscam003#37 = 0;
            #dscam003#48 = "N";
            #dscam003#82 = "N";
            #dscam003#83 = 0;
            |GRABA 020#dscam003.a; |LIBERA #dscam003;
            || El auxiliar;
            #dscam224#0 = #dscaz005#12;
            |LEE 101#dscam224.=;
            |SI FSalida = 0;
                 #dscam224#0 = #dscam003#40;
                 |BORRA 000#dscam224.c;
                 |GRABA 020#dscam224.n;
            |FINSI;
         |FINSI;
      |SINO;
         |LEE 000#dscam008.u; #dscaz006#7 = #dscam008#40 + 1;
         #dscam008#40 = #dscaz005#12;
         |LEE 000#dscam008.=;
         |SI FSalida = 0;
            #dscam008#40 = #dscaz006#7;
            |GRABA 020#dscam008.b;
            #dscam008#0 = #dscaz006#0;
            #dscam008#27 = 0;
            #dscam008#1  = 0;
            #dscam008#2  = 0;
            #dscam008#49 = "S";
            #dscam008#14 = "P";
            #dscam008#15 = "Pendiente de pago";
            #dscam008#63 = "";
            #dscam008#48 = "N";
            #dscam008#63 = #dscaz006#9;
            #dscam008#69 = "N";
            #dscam008#70 = 0;
            |GRABA 020#dscam008.a; |LIBERA #dscam008;
         |FINSI;
      |FINSI;

      DocAgrupador = #dscaz006#7;
      nGtosArrastradosD = 0; nGtosArrastradosB = 0;
      |BUCLE Volcado;

      |SI #dscaz004#0 = "V";
         #dscam003#40 = #dscaz006#7;
         |LEE 101#dscam003.=;
         |SI FSalida = 0;
            #dscam003#7  = aDomic;
            #dscam003#8  = aEntidad;
            #dscam003#9  = aOficina;
            #dscam003#10 = aDC;
            #dscam003#11 = aCta;
            #dscam003#3  = #dscaz006#3;
            #dscam003#12 = #dscaz006#4;
            #dscam003#13 = #dscaz006#5;
            #dscam003#4  = #dscaz006#8;
            |SI Total < 0;
               |SI HayEntrega = 1;
                  Total    = 0 - Total; TotalDiv = 0 - TotalDiv;
                  #dscam003#47 = "S";
                  #dscam003#23 = Total; #dscam003#61 = TotalDiv;
                  #dscam003#31 = 0;     #dscam003#65 = 0;
               |SINO;
                  #dscam003#47 = "N";
                  #dscam003#31 = Total; #dscam003#65 = TotalDiv;
                  #dscam003#23 = 0;     #dscam003#61 = 0;
               |FINSI;
               #dscam003#22 = Total; #dscam003#60 = TotalDiv;
               #dscam003#30 = Total; #dscam003#64 = TotalDiv;
            |SINO;
               #dscam003#47 = "N";
               #dscam003#22 = Total; #dscam003#60 = TotalDiv;
               #dscam003#30 = Total; #dscam003#64 = TotalDiv;
               #dscam003#31 = Total; #dscam003#65 = TotalDiv;
               #dscam003#23 = 0;     #dscam003#61 = 0;
            |FINSI;
            #dscam003#24 = 0;
            #dscam003#25 = 0;
            #dscam003#38 = 0;
            #dscam003#54 = 0;
            #dscam003#55 = 0;
            |SI #dscam003#60 = 0; |Y #dscam003#22 = 0;
             |Y #dscam003#30 = 0; |Y #dscam003#64 = 0;
               #dscam003#14 = "N"; #dscam003#15 = "Recibo cancelado";
            |SINO;
               |SI #dscam003#47 = "S";
                  #dscam003#14 = "e";
                  #dscam003#15 = "Pendiente de compensar";
               |SINO;
                  |SI #dscam003#16 = 0;
                     #dscam003#14 = "P";
                     #dscam003#15 = "Pendiente de cobro";
                  |SINO;
                     |SI nSwImpa = 1;
                        #dscam003#14 = "P";
                        #dscam003#15 = "Pendiente de cobro";
                     |SINO;
                        #dscam003#14 = "I";
                        #dscam003#15 = "Impagado";
                     |FINSI;
                  |FINSI;
               |FINSI;
            |FINSI;
            #dscam003#101 = nGtosArrastradosD;
            #dscam003#102 = nGtosArrastradosB;

            eaUsuario = Usuario % 0810;
            eaDescr   = "AGRUPACION DOCUMENTO VENTA (" + (("000000000" + #dscam003#40) % -109) + ")";
            eaTipoReg = "AV";  eaNumero = ("000000000" + #dscam003#40) % -109;
            eaTipoOp  = "A";   enImpAnt = 0; enImpAct = Total;
            |HAZ GrabaAudit;
            |GRABA 020#dscam003.a; |LIBERA #dscam003;

            || El aux. con numero factura
            |ABRE # dscam225;
            #dscam225#0 =  #dscam003#40;
            |LEE 101#dscam225.=;
            |SI FSalida ! 0; |GRABA 020#dscam225.b; |FINSI;
            #dscam225#1 = #dscaz006#0;
            #dscam225#2 = #dscaz006#1;
            #dscam225#3 = #dscaz006#2;
            #dscam225#4 = #dscam003#4;
            #dscam225#5 = #dscam003#3;
            |GRABA 020#dscam225.a;
            |CIERRA #dscam225;
         |FINSI;
      |SINO;
         #dscam008#40 = #dscaz006#7;
         |LEE 101#dscam008.=;
         |SI FSalida = 0;
            #dscam008#7  = aDomic;
            #dscam008#8  = aEntidad;
            #dscam008#9  = aOficina;
            #dscam008#10 = aDC;
            #dscam008#11 = aCta;
            #dscam008#3  = #dscaz006#3;
            #dscam008#12 = #dscaz006#4;
            #dscam008#13 = #dscaz006#5;
            #dscam008#4  = #dscaz006#8;
            #dscam008#22 = Total; #dscam008#53 = TotalDiv;
            #dscam008#25 = Total; #dscam008#56 = TotalDiv;
            #dscam008#31 = Total; #dscam008#58 = TotalDiv;
            #dscam008#23 = 0;
            #dscam008#24 = 0;
            #dscam008#38 = 0;
            |SI #dscam008#53 = 0; |Y #dscam008#22 = 0;
             |Y #dscam008#56 = 0; |Y #dscam008#25 = 0;
               #dscam008#14 = "N"; #dscam008#15 = "Recibo cancelado";
            |SINO;
               #dscam008#14 = "P";
               #dscam008#15 = "Pendiente de pago";
            |FINSI;
            |GRABA 020#dscam008.a; |LIBERA #dscam008;
            eaUsuario = Usuario % 0810;
            eaDescr   = "AGRUPACION DOCUMENTO COMPRA (" + (("000000000" + #dscam008#40) % -109) + ")";
            eaTipoReg = "AC";  eaNumero = ("000000000" + #dscam008#40) % -109;
            eaTipoOp  = "A";   enImpAnt = 0; enImpAct = Total;
            |HAZ GrabaAudit;

            || El aux. con numero factura
            |ABRE #dscam225;
            #dscam225#0 =  #dscam008#40;
            |LEE 101#dscam225.=;
            |SI FSalida ! 0; |GRABA 020#dscam225.b; |FINSI;
            #dscam225#1 = #dscaz006#0;
            #dscam225#2 = #dscaz006#1;
            #dscam225#3 = #dscaz006#2;
            #dscam225#4 = #dscam008#4;
            #dscam225#5 = #dscam008#3;
            |GRABA 020#dscam225.a;
            |CIERRA #dscam225;
         |FINSI;
      |FINSI;
      |SI enSwAplazAgr = 1;
         |HAZ Tipo9;
         enDocumento = #dscaz006#7;
         efFechaOri  = VtoMasAlto;
         efFechaApl  = #dscaz006#3; |HAZ Aplaza;
         |HAZ Tipo8;
      |FINSI;
   |FINSI;
   |POPV;

   |CIERRA #dscam008;
   |CIERRA #dscam003;
   |CIERRA #dscam224;

   |SI Carta = 1;
      TAgrup   = Total;
      FecAgrup  = #dscam003#4;
      FecVtoAgr = #dscam003#3;
      Dia  = #dscam003#4 % 0102; Dia = ("00" + Dia) % -102;
      Mes  = #dscam003#4 % 0402; Mes = ("00" + Mes) % -102; |HAZ MesLetra; |QBF Mes;
      anyo = #dscam003#4 % -104;
      FecEmision = Dia + " de " + Mes + " de " + anyo;
      DAgrupador = ("000000000" + DocAgrupador) % -109;
      |HAZ GeneraCarta;
   |FINSI;

   Proceso   = "";
   eaTOperacion = "B"; eaTipoRecibo = #0#0; enNumDocum = #dscaz005#12; |HAZ ProcesaTempo;
|FPRC;

|PROCESO SacaCartaAgr;
   DocAgrupador = #dscaz005#12;
   DAgrupador = ("000000000" + DocAgrupador) % -109;
   |SI #dscaz004#0 = "V";
      #dscam003#40 = DocAgrupador; |LEE 000#dscam003.=;
      FecAgrup  = #dscam003#4; FecVtoAgr = #dscam003#3;
   |SINO;
      #dscam008#40 = DocAgrupador; |LEE 000#dscam008.=;
      FecAgrup  = #dscam008#4; FecVtoAgr = #dscam008#3;
   |FINSI;
   TAgrup   = #dscaz005#8;
   Dia  = FecAgrup % 0102; Dia = ("00" + Dia) % -102;
   Mes  = FecAgrup % 0402; Mes = ("00" + Mes) % -102; |HAZ MesLetra; |QBF Mes;
   anyo = FecAgrup % -104;
   FecEmision = Dia + " de " + Mes + " de " + anyo;
   |HAZ GeneraCarta;
|FPRC;

|PROCESO CalcImpDivV;
   TotDividido = TotDividido + #dscam003#30;
|FPRC;

|DEFBUCLE CalcImpDivV;
#dscam003#1;
82, 83;
000000001, "S", DocDividido;
999999999, "S", DocDividido;
;
NULL, CalcImpDivV;
|FIN;

|PROCESO CalcImpDivC;
   TotDividido = TotDividido + #dscam008#25;
|FPRC;

|DEFBUCLE CalcImpDivC;
#dscam008#1;
69, 70;
000000001, "S", DocDividido;
999999999, "S", DocDividido;
;
NULL, CalcImpDivC;
|FIN;

|PROCESO SacaCartaDiv;
   DocDividido = #dscaz005#17;
   DDividido = ("000000000" + DocDividido) % -109;
   |SI #dscaz004#0 = "V";
      #dscam003#40 = DocDividido; |LEE 000#dscam003.=;
      FecDividido  = #dscam003#4; FecVtoDiv  = #dscam003#3;
      eaSerieDiv   = #dscam003#0; eaFactuDiv = ("000000" + #dscam003#1) % -106;
      TotDividido = 0; |BUCLE CalcImpDivV;
   |SINO;
      #dscam008#40 = DocDividido; |LEE 000#dscam008.=;
      FecDividido  = #dscam008#4; FecVtoDiv = #dscam008#3;
      eaSerieDiv   = #dscam008#0; eaFactuDiv = ("000000" + #dscam008#1) % -106;
      TotDividido = 0; |BUCLE CalcImpDivC;
   |FINSI;
   Dia  = #dscaz005#19 % 0102; Dia = ("00" + Dia) % -102;
   Mes  = #dscaz005#19 % 0402; Mes = ("00" + Mes) % -102; |HAZ MesLetra; |QBF Mes;
   anyo = #dscaz005#19 % -104;
   FecEmision = Dia + " de " + Mes + " de " + anyo;
   |HAZ GeneraCarta;
|FPRC;

|PROCESO SacaCarta;
   |SI #dscaz005#13 = "S"; aSwAgrDiv = "A"; |HAZ SacaCartaAgr; |FINSI;
   |SI #dscaz005#16 = "S"; aSwAgrDiv = "D"; |HAZ SacaCartaDiv; |FINSI;
|FPRC;

|PROCESO MiraRecibo;
   |SI #dscaz004#0 = "V";
      #dscam003#40 = #dscaz006#7;
      |LEE 000#dscam003.=;
   |FINSI;
   |SI #dscaz004#0 = "C";
      #dscam008#40 = #dscaz006#7;
      |LEE 000#dscam008.=;
   |FINSI;
   |SI FSalida = 0;
      |AVISO;
      |MENAV "    El recibo ya existe";
      |ERROR;
   |FINSI;
|FPRC;

|PROCESO MesLetra;
   |SI Mes = "01"; Mes = "Enero     "; |FINSI;
   |SI Mes = "02"; Mes = "Febrero   "; |FINSI;
   |SI Mes = "03"; Mes = "Marzo     "; |FINSI;
   |SI Mes = "04"; Mes = "Abril     "; |FINSI;
   |SI Mes = "05"; Mes = "Mayo      "; |FINSI;
   |SI Mes = "06"; Mes = "Junio     "; |FINSI;
   |SI Mes = "07"; Mes = "Julio     "; |FINSI;
   |SI Mes = "08"; Mes = "Agosto    "; |FINSI;
   |SI Mes = "09"; Mes = "Septiembre"; |FINSI;
   |SI Mes = "10"; Mes = "Octubre   "; |FINSI;
   |SI Mes = "11"; Mes = "Noviembre "; |FINSI;
   |SI Mes = "12"; Mes = "Diciembre "; |FINSI;
|FPRC;

|PROCESO MiraImporte;
   |SI Proceso ! "D"; |ACABA; |FINSI;

   TotAgrup = TotAgrup ! nDeci_Div;
   |SI TotAgrup > 0;
      |SI #dscaz019#3 < 0;
         |CONFI "    NEl importe introducido es negativo. Continuar ?";
         |SI FSalida ! 0; |ERROR; |FINSI;
      |FINSI;
      |SI #dscaz019#3 > TotAgrup;
         |MENAV "    Esta intentando introducir una cantidad mayor a la restante";
         |ERROR;
      |FINSI;
   |SINO;
      |SI #dscaz019#3 > 0;
         |CONFI "    NEl importe introducido es positivo. Continuar ?";
         |SI FSalida ! 0; |ERROR; |FINSI;
      |FINSI;
      |SI #dscaz019#3 < TotAgrup;
         |MENAV "    Esta intentando introducir una cantidad mayor a la restante";
         |ERROR;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO MiraFecha;
   |SI #dscaz019#2 < #dscaz019#4;
      |MENAV "    Fecha incorrecta."; |ERROR;
   |FINSI;

   |SI nSwLuxe = 1;
      nSwAplaza = 0;
      |SI #dscaz019#2 > #dscaz005#5;
         aAlfa = "    SNuevo vencimiento posterior al original, " + &191 + " Calcular coste aplazamiento ?";
         |CONFI aAlfa;
         |SI FSalida = 0;
            nSwAplaza = 1;
         |FINSI;
      |FINSI;
   |SINO;
      nSwAplaza = 0;
   |FINSI;
|FPRC;

|PROCESO Decim1; |TIPO 13;
   Divisa = #dscaz005#14; |HAZ TomaDecim;
|FPRC;

|PROCESO BorraTempo;
   |BORRA 020#dscaz005.a;
|FPRC;

|DEFBUCLE BorraTempo;
#dscaz005#1;
;
INICIO;
FINAL;
be;
NULL, BorraTempo;
|FIN;

|PROGRAMA;
   |CLS;
   |CABEZA "Agrupacion de recibos";

   |HAZ Tipo8;

   |HAZ EsLuxe;
   |SI FSalida = 0;
      nSwLuxe = 1;
   |SINO;
      nSwLuxe = 0;
   |FINSI;

   |HAZ EsArtenvas;
   |SI FSalida = 0;
      nSwArtenvas = 1;
      |ABRE #dscam164; |ABRE #dscam221; |ABRE #dscam219;
   |SINO;
      nSwArtenvas = 0;
   |FINSI;

   Comodin = PARAMETRO; |QBF Comodin;
   |SI Comodin ! "";
      |C_M #dscaz004#0,1,"N";
      #dscaz004#0 = Comodin;
   |SINO;
      |C_M #dscaz004#0,1,"S";
   |FINSI;

   |ABRE #dscam051;
   |LEE 000#dscam051.p;
   |SI FSalida ! 0;
      |DDEFECTO #dscam051;
      |GRABA 020#dscam051.n;
      |LEE 000#dscam051.p;
   |FINSI;
   |CIERRA #dscam051;

   #dscaz004#1 = #dscam051#100;

   |PINPA #0#0;
   |PINDA #0#0;

   |ENDATOS #1#0;
   |SI FSalida ! 0; |ACABA; |FINSI;

   Comodin = "ag" + Usuario; |NOME_DAT #1 Comodin;
   |DELINDEX #dscaz005; |ABRE #dscaz005;

   |PARA; |SI Salir = 0; |HACIENDO;

      |BUCLE BorraTempo;

      LimEmisBaj = "31.12.9999";
      LimEmisAlt = "00.00.0000";
      nSumaLuxe = 0;
      Linea = 0;
      Salir = 1;
      NumRecs = 0;

      |ABRE #dscam225;
      |SI #dscaz004#0 = "V"; |BUCLE Ventas; |FINSI;
      |SI #dscaz004#0 = "C"; |BUCLE Compras; |FINSI;
      |CIERRA #dscam225;

      Cantidad = 0; |HAZ Totales;
      ||Comodin = "Importe seleccion " + Cantidad + "          ";
      ||PINTA 2410, Comodin;

      |ABRE #dscam224;
      |ABRE #dscam003;
      |ABRE #dscam008;

      HayEntrega = 0;
      |ENTLINEAL #1#dscaz005,-1,4,20,1,inf,sup;

      |CIERRA #dscam224;
      |CIERRA #dscam003;
      |CIERRA #dscam008;
   |SIGUE;
   |CIERRA #dscaz005;

   eaSesion   = Usuario; |HAZ LimpiaTempo;
   |SI nSwArtenvas = 1;
      |CIERRA #dscam221;
      |CIERRA #dscam164;
      |CIERRA #dscam219;
   |FINSI;

   |HAZ Tipo9;
|FPRO;
