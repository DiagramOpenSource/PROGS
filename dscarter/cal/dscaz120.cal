|FICHEROS;
   dscaz120 #0;

   dscaw092 #10;
   dscaw093 #11;

   Referen@ #100;
   caconas@ #101;
   camasic@ #102;
   canempr@ #103;
   cacuent@ #104;
|FIN;

|VARIABLES;
   aAlfa    = "";
   aAlfa1   = "";
   aCuenta  = "";
   aCuenta1 = "";
   aNombre  = "";

   nTecla    = 0;
   nNivel    = 0;
   nLinea    = 0;
   nAntLin   = 0;
   nNumDocum = 0;
   nErrContador = 0;
   nCalc     = 0;
   nMaxDigit = 0;

   nTotal1   = 0;
   nTotal2   = 0;
   nTotal3   = 0;
   nTotalBnc = 0;

   FEstado   = 0;

   &PRMNT_enVer = 0;
|FIN;

|PROCESO Contador;
   |ABRE #caconas@;
   |LEE 101#caconas@.p;
   |SI FSalida ! 0;
      |DDEFECTO #caconas@;
      |GRABA 020#caconas@.n;
      |LEE 101#caconas@.p;
   |FINSI;

   #caconas@#1 = #caconas@#1 + 1;
   nNumDocum = #caconas@#1;
   |GRABA 020#caconas@.a;
   |LIBERA #caconas@; |CIERRA #caconas@;

   |ABRE #camasic@;
   #camasic@#0 = #dscaz120#1;
   #camasic@#1 = #dscaz120#0;
   #camasic@#2 = nNumDocum;
   |LEE 000#camasic@.=;
   |SI FSalida = 0;
      nErrContador = 1;
   |SINO;
      nErrContador = 0;
   |FINSI;
   |CIERRA #camasic@;
|FPRC;

|PROCESO MiraNivel;
   nNivel = 0;
   aAlfa = aCuenta; |QBF aAlfa; aAlfa = aAlfa % 0;
   nCalc = aAlfa;
   |SI #canempr@#14 = nCalc; nNivel = 1; |FINSI;
   |SI #canempr@#15 = nCalc; nNivel = 2; |FINSI;
   |SI #canempr@#16 = nCalc; nNivel = 3; |FINSI;
   |SI #canempr@#17 = nCalc; nNivel = 4; |FINSI;
   |SI #canempr@#18 = nCalc; nNivel = 5; |FINSI;
   |SI #canempr@#19 = nCalc; nNivel = 6; |FINSI;
|FPRC;

|PROCESO MiraDiario;
   nTecla = FSalida;

   aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "def/camandia.mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "fich/" + (("00000" + #48#14) % -105) + #48#19 + "/";
      |PATH_DAT #Referen@#aAlfa#;
      |ABRE #Referen@;
      |SI nTecla = 10;
         #Referen@#0 = #dscaz120#1;
         |LEE 000#Referen@.];
         |CONSULTA_CLAVE #1#Referen@;
         |SI FSalida = 0;
            #dscaz120#1 = #Referen@#0; |PINTA #dscaz120#1;
            |PINTA 1330, #Referen@#1;
         |FINSI;
      |FINSI;
      #Referen@#0 = #dscaz120#1;
      |LEE 000#Referen@.=;
      |SI FSalida = 0;
         |PINTA 1330, #Referen@#1;
      |SINO;
         |MENAV "    Diario inexistente"; |ERROR;
      |FINSI;
      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
   |FINSI;
|FPRC;

|PROCESO LineasAsto;
   |SI #dscaw092#2 ! 0;
      |DDEFECTO #Referen@;
      #Referen@#0 = #dscaz120#1;
      #Referen@#1 = #dscaz120#0;
      #Referen@#2 = nNumDocum;
      #Referen@#3 = nLinea; nLinea = nLinea + 1;

      nCalc = nMaxDigit - 4; aAlfa1 = "0" * nCalc;
      nCalc = 0 - (100 + nCalc);
      aAlfa = #dscaw092#0;
      aAlfa = aAlfa1 + aAlfa
      aAlfa = aAlfa % nCalc;
      aAlfa = "4310" + aAlfa;
      #Referen@#4 = aAlfa; aCuenta = aAlfa; |HAZ MiraNivel;
      #Referen@#5 = nNivel;
      #Referen@#6 = 1;
      aAlfa = "ASTO.REGUL. CTA " + aCuenta;
      #Referen@#7 = aAlfa;
      #Referen@#8 = "D";
      #Referen@#9 = #dscaw092#2;
      #Referen@#37 = #48#14;
      #Referen@#38 = #48#19;
      |GRABA 020#Referen@.n;

      nTotal1 = nTotal1 + #dscaw092#2;
   |FINSI;

   |SI #dscaw092#3 ! 0;
      |DDEFECTO #Referen@;
      #Referen@#0 = #dscaz120#1;
      #Referen@#1 = #dscaz120#0;
      #Referen@#2 = nNumDocum;
      #Referen@#3 = nLinea; nLinea = nLinea + 1;
      nCalc = nMaxDigit - 4; aAlfa1 = "0" * nCalc;
      nCalc = 0 - (100 + nCalc);
      aAlfa = #dscaw092#0;
      aAlfa = aAlfa1 + aAlfa;
      aAlfa = aAlfa % nCalc;
      aAlfa = "4311" + aAlfa;
      #Referen@#4 = aAlfa; aCuenta = aAlfa; |HAZ MiraNivel;
      #Referen@#5 = nNivel;
      #Referen@#6 = 1;
      aAlfa = "ASTO.REGUL. CTA " + aCuenta;
      #Referen@#7 = aAlfa;
      #Referen@#8 = "D";
      #Referen@#9 = #dscaw092#3;
      #Referen@#37 = #48#14;
      #Referen@#38 = #48#19;
      |GRABA 020#Referen@.n;

      nTotal2 = nTotal2 + #dscaw092#3;
   |FINSI;

   |SI #dscaw092#4 ! 0;
      |DDEFECTO #Referen@;
      #Referen@#0 = #dscaz120#1;
      #Referen@#1 = #dscaz120#0;
      #Referen@#2 = nNumDocum;
      #Referen@#3 = nLinea; nLinea = nLinea + 1;
      nCalc = nMaxDigit - 4; aAlfa1 = "0" * nCalc;
      nCalc = 0 - (100 + nCalc);
      aAlfa = #dscaw092#0;
      aAlfa = aAlfa1 + aAlfa;
      aAlfa = aAlfa % nCalc;
      aAlfa = "4312" + aAlfa;
      #Referen@#4 = aAlfa; aCuenta = aAlfa; |HAZ MiraNivel;
      #Referen@#5 = nNivel;
      #Referen@#6 = 1;
      aAlfa = "ASTO.REGUL. CTA " + aCuenta;
      #Referen@#7 = aAlfa;
      #Referen@#8 = "D";
      #Referen@#9 = #dscaw092#4;
      #Referen@#37 = #48#14;
      #Referen@#38 = #48#19;
      |GRABA 020#Referen@.n;

      nTotal3 = nTotal3 + #dscaw092#4;
   |FINSI;
|FPRC;

|DEFBUCLE LineasAsto;
#dscaw092#1;
;
INICIO;
FINAL;
;
NULL,LineasAsto;
|FIN;

|PROCESO Totales;
   |SI nTotal1 ! 0;
      |DDEFECTO #Referen@;
      #Referen@#0 = #dscaz120#1;
      #Referen@#1 = #dscaz120#0;
      #Referen@#2 = nNumDocum;
      #Referen@#3 = 1;
      nCalc = nMaxDigit - 4; aAlfa = "4310" + ("0" * nCalc);
      #Referen@#4 = aAlfa; aCuenta = aAlfa; |HAZ MiraNivel;
      #Referen@#5 = nNivel;
      #Referen@#6 = 1;
      aAlfa = "ASTO.REGUL. CTA " + aCuenta;
      #Referen@#7 = aAlfa;
      #Referen@#8 = "H";
      #Referen@#9 = nTotal1;
      #Referen@#37 = #48#14;
      #Referen@#38 = #48#19;
      |GRABA 020#Referen@.n;
   |FINSI;

   |SI nTotal2 ! 0;
      |DDEFECTO #Referen@;
      #Referen@#0 = #dscaz120#1;
      #Referen@#1 = #dscaz120#0;
      #Referen@#2 = nNumDocum;
      #Referen@#3 = 2;
      nCalc = nMaxDigit - 4; aAlfa = "4311" + ("0" * nCalc);
      #Referen@#4 = aAlfa; aCuenta = aAlfa; |HAZ MiraNivel;
      #Referen@#5 = nNivel;
      #Referen@#6 = 1;
      aAlfa = "ASTO.REGUL. CTA " + aCuenta;
      #Referen@#7 = aAlfa;
      #Referen@#8 = "H";
      #Referen@#9 = nTotal2;
      #Referen@#37 = #48#14;
      #Referen@#38 = #48#19;
      |GRABA 020#Referen@.n;
   |FINSI;

   |SI nTotal3 ! 0;
      |DDEFECTO #Referen@;
      #Referen@#0 = #dscaz120#1;
      #Referen@#1 = #dscaz120#0;
      #Referen@#2 = nNumDocum;
      #Referen@#3 = 3;
      nCalc = nMaxDigit - 4; aAlfa = "4312" + ("0" * nCalc);
      #Referen@#4 = aAlfa; aCuenta = aAlfa; |HAZ MiraNivel;
      #Referen@#5 = nNivel;
      #Referen@#6 = 1;
      aAlfa = "ASTO.REGUL. CTA " + aCuenta;
      #Referen@#7 = aAlfa;
      #Referen@#8 = "H";
      #Referen@#9 = nTotal3;
      #Referen@#37 = #48#14;
      #Referen@#38 = #48#19;
      |GRABA 020#Referen@.n;
   |FINSI;
|FPRC;

|PROCESO Bancos;
   |SI #dscaw093#2 ! 0;
      |DDEFECTO #Referen@;
      #Referen@#0 = #dscaz120#1;
      #Referen@#1 = #dscaz120#0;
      #Referen@#2 = nNumDocum;
      #Referen@#3 = nLinea; nLinea = nLinea + 1;
      nCalc = nMaxDigit - 4; aAlfa1 = "0" * nCalc;
      nCalc = 0 - (100 + nCalc);
      aAlfa = #dscaw093#0;
      aAlfa = aAlfa1 + aAlfa;
      aAlfa = aAlfa % nCalc;
      aAlfa = "5208" + aAlfa;
      #Referen@#4 = aAlfa; aCuenta = aAlfa; |HAZ MiraNivel;
      #Referen@#5 = nNivel;
      #Referen@#6 = 1;
      aAlfa = "ASTO.REGUL. BANCO " + aCuenta;
      #Referen@#7 = aAlfa;
      #Referen@#8 = "H";
      #Referen@#9 = #dscaw093#2;
      #Referen@#37 = #48#14;
      #Referen@#38 = #48#19;
      |GRABA 020#Referen@.n;

      nTotalBnc = nTotalBnc + #dscaw093#2
   |FINSI;
|FPRC;

|DEFBUCLE Bancos;
#dscaw093#1;
;
INICIO;
FINAL;
;
NULL, Bancos;
|FIN;

|PROCESO TotalBanco;
   |SI nTotalBnc ! 0;
      |DDEFECTO #Referen@;
      #Referen@#0 = #dscaz120#1;
      #Referen@#1 = #dscaz120#0;
      #Referen@#2 = nNumDocum;
      #Referen@#3 = nAntLin;
      nCalc = nMaxDigit - 4; aAlfa = "5208" + ("0" * nCalc);
      #Referen@#4 = aAlfa; aCuenta = aAlfa; |HAZ MiraNivel;
      #Referen@#5 = nNivel;
      #Referen@#6 = 1;
      aAlfa = "ASTO.REGUL. BANCO " + aCuenta;
      #Referen@#7 = aAlfa;
      #Referen@#8 = "D";
      #Referen@#9 = nTotalBnc;
      #Referen@#37 = #48#14;
      #Referen@#38 = #48#19;
      |GRABA 020#Referen@.n;
   |FINSI;
|FPRC;

|PROCESO AltaCta;
   #cacuent@#0 = aCuenta1; aCuenta = #cacuent@#0; |HAZ MiraNivel;
   #cacuent@#1 = nNivel;
   |LEE 000#cacuent@.=;
   |SI FSalida ! 0;
      aAlfa = aCuenta1; |QBF aAlfa; aAlfa = aAlfa % 0104;
      #cacuent@#0 = aAlfa;
      aCuenta = #cacuent@#0; |HAZ MiraNivel; aCuenta = aCuenta % 0104;
      #cacuent@#1 = nNivel;
      |LEE 000#cacuent@.];
      FEstado = FSalida;
      aAlfa = #cacuent@#0; |QBF aAlfa; aAlfa = aAlfa % 0104;
      |SI FEstado = 0; |Y aAlfa = aCuenta;
         #cacuent@#0 = aCuenta1;
         aCuenta = #cacuent@#0; |HAZ MiraNivel; aCuenta = aCuenta % 0104;
         #cacuent@#1 = nNivel;
         #cacuent@#2 = aNombre;
         |GRABA 020#cacuent@.n;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO CtasBancos;
   nCalc = nMaxDigit - 4; aAlfa1 = "0" * nCalc;
   nCalc = 0 - (100 + nCalc);
   aAlfa = #dscaw093#0;
   aAlfa = aAlfa1 + aAlfa;
   aAlfa = aAlfa % nCalc;
   aCuenta1 = "5208" + aAlfa; aNombre = #dscaw093#2;
   |HAZ AltaCta;
|FPRC;

|DEFBUCLE CtasBancos;
#dscaw093#1;
;
INICIO;
FINAL;
;
NULL,CtasBancos;
|FIN;

|PROCESO CtasClientes;
   |SI #dscaw092#2 ! 0;
      nCalc = nMaxDigit - 4; aAlfa1 = "0" * nCalc;
      nCalc = 0 - (100 + nCalc);
      aAlfa = #dscaw092#0;
      aAlfa = aAlfa1 + aAlfa;
      aAlfa = aAlfa % nCalc;
      aCuenta1 = "4310" + aAlfa; aNombre = #dscaw092#6;
      |HAZ AltaCta;
   |FINSI;

   |SI #dscaw092#3 ! 0;
      nCalc = nMaxDigit - 4; aAlfa1 = "0" * nCalc;
      nCalc = 0 - (100 + nCalc);
      aAlfa = #dscaw092#0;
      aAlfa = aAlfa1 + aAlfa;
      aAlfa = aAlfa % nCalc;
      aCuenta1 = "4311" + aAlfa;  aNombre = #dscaw092#6;
      |HAZ AltaCta;
   |FINSI;

   |SI #dscaw092#4 ! 0;
      nCalc = nMaxDigit - 4; aAlfa1 = "0" * nCalc;
      nCalc = 0 - (100 + nCalc);
      aAlfa = #dscaw092#0;
      aAlfa = aAlfa1 + aAlfa;
      aAlfa = aAlfa % nCalc;
      aCuenta1 = "4312" + aAlfa; aNombre = #dscaw092#6;
      |HAZ AltaCta;
   |FINSI;

|FPRC;

|DEFBUCLE CtasClientes;
#dscaw092#1;
;
INICIO;
FINAL;
;
NULL,CtasClientes;
|FIN;

|PROCESO AltaCuentas;
   |ABRE #cacuent@;
   |BUCLE CtasClientes; |BUCLE CtasBancos;
   |CIERRA #cacuent@;
|FPRC;

|PROGRAMA;
   |CLS;
   |CABEZA " Contabilizacion asiento regularizacion cuentas efectos";

   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "def/caenlace.mas";
      |CARGA_DEF aAlfa, Referen@;
      |SI FSalida = 0;
         aAlfa = "pu" + Usuario; |NOME_DAT #Referen@#aAlfa#;
         aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "def/caconasi.mas";
         |CARGA_DEF aAlfa, caconas@;
         |SI FSalida = 0;
            aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "def/camaasic.mas";
            |CARGA_DEF aAlfa, camasic@;
            |SI FSalida = 0;
               aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "def/canempre.mas";
               |CARGA_DEF aAlfa, canempr@;
               |SI FSalida = 0;
                  aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "def/cacuenta.mas";
                  |CARGA_DEF aAlfa, cacuent@;
                  |SI FSalida = 0;
                     aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "fich/" + (("00000" + #48#14) % -105) + #48#19 + "/";
                     |PATH_DAT #Referen@#aAlfa#; |PATH_DAT #caconas@#aAlfa#;
                     |PATH_DAT #camasic@#aAlfa#; |PATH_DAT #cacuent@#aAlfa#;
                     aAlfa = #48#16; |QBF aAlfa; aAlfa = aAlfa + "fich/";
                     |PATH_DAT #canempr@#aAlfa#;
                     |DELINDEX #Referen@;
                     |ABRE #Referen@; |ABRE #canempr@;

                     #canempr@#2 = #48#14;
                     #canempr@#3 = #48#19;
                     |LEE 000#canempr@.=;
                     |SI FSalida ! 0; |DDEFECTO #canempr@; |FINSI;

                     nMaxDigit = 0;
                     |SI #canempr@#14 ] nMaxDigit; nMaxDigit = #canempr@#14; |FINSI;
                     |SI #canempr@#15 ] nMaxDigit; nMaxDigit = #canempr@#15; |FINSI;
                     |SI #canempr@#16 ] nMaxDigit; nMaxDigit = #canempr@#16; |FINSI;
                     |SI #canempr@#17 ] nMaxDigit; nMaxDigit = #canempr@#17; |FINSI;
                     |SI #canempr@#18 ] nMaxDigit; nMaxDigit = #canempr@#18; |FINSI;
                     |SI #canempr@#19 ] nMaxDigit; nMaxDigit = #canempr@#19; |FINSI;

                     |HAZ AltaCuentas;

                     nErrContador = 0;
                     |HAZ Contador;
                     |SI nErrContador = 1;
                        |MENAV "    Problemas con el contador de contabilidad. Reviselo, por favor";
                     |SINO;
                        nTotal1   = 0; nTotal2   = 0; nTotal3   = 0;
                        nLinea = 4; |BUCLE LineasAsto;
                        |HAZ Totales;

                        nAntLin = nLinea; nLinea = nLinea + 1;
                        |BUCLE Bancos;

                        |HAZ TotalBanco;
                     |FINSI;
                     |CIERRA #cacuent@; |DESCARGA_DEF #cacuent@;
                  |FINSI;
                  |CIERRA #canempr@; |DESCARGA_DEF #canempr@;
               |FINSI;
               |DESCARGA_DEF #camasic@;
            |FINSI;
            |DESCARGA_DEF #caconas@;
         |FINSI;
         |CIERRA #Referen@; |DESCARGA_DEF #Referen@;

         |HAZ CogeVersion;
         aAlfa = #48#16; |QBF aAlfa;
         aAlfa = aAlfa - "agicont";
         |SI FSalida = 0;
            aAlfa = #48#16; |QBF aAlfa;
            aAlfa = ":contagen/dsapunte.tab;" + aAlfa;
         |SINO;
            aAlfa = #48#16; |QBF aAlfa;
            aAlfa = ":agicont/dsapunte.tab;" + aAlfa;
         |FINSI;
         aAlfa1 = "fich/" + (("00000" + #48#14) % -105) + #48#19 + "/";
         aAlfa = aAlfa + aAlfa1 + ",pu" + Usuario;
         |SUB_EJECUTA_NP aAlfa;
      |FINSI;
   |FINSI;
|FPRO;
