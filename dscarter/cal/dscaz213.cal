|FICHEROS;
   dscaz213 #0;

   dscam003 #10;
   dscam052 #11;

   Referen@ #100;
   Refere1@ #101;
|FIN;

|VARIABLES;
    &eaEstado  = "";

    nLibro = 0;
    aSerie = "";
    nFactura = 0;

    nLib = 0;
    aSer = "";
    nFac = 0;

    aAlfa = "";

    nDiv    = 0;
    nAgrupa = 0;
|FIN;

|PROCESO Divididos;
    |SI #Refere1@#14 = "L"; |Y eaEstado = "";           eaEstado = "L";      |FINSI;
    |SI eaEstado = "L"; |Y #Refere1@#14 ! "L";          eaEstado = "P";      |FINSI;
    |SI eaEstado = "";  |Y #Refere1@#14 ! "L";          eaEstado = "P";      |FINSI;
|FPRC;

|DEFBUCLE Divididos;
#Refere1@#1001;
;
000000001;
999999999;
;
NULL, Divididos;
|FIN;

|PROCESO BuscaDivididos;
   |SI #dscam003#83 = nDiv;
      |SALVA_FICHA #dscam003;
      |HAZ MiraEstadoFra;
      |REPON_FICHA #dscam003;
   |FINSI;
|FPRC;

|DEFBUCLE BuscaDivididos;
#dscam003#9;
;
nLib, aSer, 000000, 000, 000000001;
nLib, aSer, 000000, 000, 999999999;
;
NULL, BuscaDivididos;
|FIN;

|PROCESO MiraEstadoFra;
    |SI #dscam003#14 ! "A"; |Y #dscam003#14 ! "D";
         |SI #dscam003#14 = "N"; #dscam003#14 = "L"; |FINSI;
        |SI #dscam003#14 = "L"; |Y eaEstado = "";           eaEstado = "L";      |FINSI;
        |SI eaEstado = "L"; |Y #dscam003#14 ! "L";          eaEstado = "P";      |FINSI;
        |SI eaEstado = "";  |Y #dscam003#14 ! "L";          eaEstado = "P";      |FINSI;
    |FINSI;

    |SI #dscam003#14 = "A";
        nAgrupa = #dscam003#41;
        |SALVA_FICHA #dscam003;
        |SELECT #1#dscam003;
        #dscam003#40 = nAgrupa;
        |LEE 000#dscam003.=;
        |SI FSalida ! 0;
            #dscam003#0 = "zzzzz";
            #dscam003#1 = -1;
        |FINSI;
        |SELECT #9#dscam003;
        |LEE 000#dscam003.=;
        |SI FSalida = 0;
            |HAZ MiraEstadoFra;
        |FINSI;
        |REPON_FICHA #dscam003;
    |FINSI;

    |SI #dscam003#14 = "D";
        nDiv = #dscam003#40;
        nLib = #dscam003#27;
        aSer = #dscam003#0;
        nFac = #dscam003#1;
        |SALVA_FICHA #dscam003;
        |BUCLE BuscaDivididos;
        |REPON_FICHA #dscam003;
    |FINSI;
/*
    |SI #Referen@#14 ! "A"; |Y #Referen@#14 ! "D";
        |SI #Referen@#14 = "L"; |Y eaEstado = "";           eaEstado = "L";      |FINSI;
        |SI eaEstado = "L"; |Y #Referen@#14 ! "L";          eaEstado = "P";      |FINSI;
        |SI eaEstado = "";  |Y #Referen@#14 ! "L";          eaEstado = "P";      |FINSI;
    |FINSI;

    |SI #Referen@#14 = "A";
        nAgrupa = #Referen@#
        |SALVA_FICHA #Referen@;
         |BUCLE Agrupados;
        |REPON_FICHA #Referen@;

        aAlfa = "dscam003"; |NOME_DAT #Refere1@#aAlfa#;
        |DFICE aAlfa; |PATH_DAT #Refere1@#aAlfa#;
        |ABRE #Refere1@;
        #Refere1@#40 = #Referen@#41;
        |LEE 000#Refere1@.=;
        |SI FSalida = 0;
            |SI #Refere1@#30 < 0;
                |SI eaEstado = "";           eaEstado = "L";      |FINSI;
            |SINO;
                |SI #Refere1@#14 = "L"; |Y eaEstado = "";           eaEstado = "L";      |FINSI;
                |SI eaEstado = "L"; |Y #Refere1@#14 ! "L";          eaEstado = "P";      |FINSI;
                |SI eaEstado = "";  |Y #Refere1@#14 ! "L";          eaEstado = "P";      |FINSI;
            |FINSI;
        |FINSI;
        |CIERRA #Refere1@;
    |FINSI;

    |SI #Referen@#14 = "D";
        aAlfa = "SELECT * FROM dscam003 INTO trd" + Usuario + " WHERE 83 = " + #Referen@#40;
        |SQL aAlfa;
        |SI FSalida = 0;
            aAlfa = "trd" + Usuario; |NOME_DAT #Refere1@#aAlfa#;
            |ABRE #Refere1@;
            |BUCLE Divididos;
            |CIERRA #Refere1@;
        |FINSI;
    |FINSI;
*/
|FPRC;

|DEFBUCLE MiraEstadoFra;
#dscam003#9;
;
nLibro, aSerie, nFactura, 000, 000000001;
nLibro, aSerie, nFactura, 999, 999999999;
;
NULL, MiraEstadoFra;
|FIN;

|PROCESO Recibos;
    |SI #Referen@#1 = 0; |ACABA; |FINSI;

    nLibro = #Referen@#27;
    aSerie = #Referen@#0; nFactura = #Referen@#1;
    eaEstado = ""; |BUCLE MiraEstadoFra;

    #dscam003#40 = #Referen@#40;
    |LEE 000#dscam003.=;
    |PRINT;
|FPRC;

|DEFBUCLE Recibos;
#Referen@#3002;
;
#dscaz213#0, 000000001;
#dscaz213#1, 999999999;
;
NULL, Recibos;
|FIN;

|PROGRAMA;
   |CLS;
   |CABEZA "Informe seleccion declaracion de ventas";
   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      Impresora = "CrystalReport";
       |IMPRE -1;
       |SI FSalida = 0;
           |INFOR "dscaz213";
           |SI FSalida = 0;
                 |DDEF aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dscam003.mas";
                  |CARGA_DEF aAlfa, Referen@;
                  |SI FSalida = 0;
                      |CARGA_DEF aAlfa, Refere1@;
                      |DFICE aAlfa;
                       |PATH_DAT #Referen@#aAlfa#; |PATH_DAT #Refere1@#aAlfa#;
                       |ABRE #Referen@; |ABRE #dscam003;
                       |BUCLE Recibos;
                       |DESCARGA_DEF #Refere1@
                       |CIERRA #dscam003; |CIERRA #Referen@; |DESCARGA_DEF #Referen@
                  |FINSI;
               |PIEINF; |FININF;
             |FINSI;
           |FINIMP;
      |FINSI;
   |FINSI;
|FPRO;
