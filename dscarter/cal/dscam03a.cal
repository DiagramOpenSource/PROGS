|FICHEROS;
   dscam003 #0;
   dscam004 #1,MANTE;
   dscam025 #2;
   &agif024@ #7;

   dscam014 #12;
   dscam012 #13;
   dscaw013 #20;
   dscam044 #21;
   dscam025 #22;
   dscam051 #5;
   dscam052 #52;
   dscam163 #53;
   dscam221 #221;

   dscam013 #70;
   dscam017 #71;
   dscam045 #72;
   dscam075 #75,MANTE;

   dscam067 #100;

   dscam212 #212;
   dscam164 #213;
   dscaw205 #214,MANTE;
   dscam215 #215,MANTE;
   dscaw219 #219;
   dscam219 #1219;
   dscaw227 #227;

   referen@ #333;
   dscam106 #506;
   dscam004@ #1000;
   agif134@ #1001;
   agif084@ #1002;
   agif133@ #1003;
   agif069@ #1004;

   gestr168@ #2000;
   gestr149@ #2001;
   canempre@ #2002;
   gestr150@ #2003;

   visalm00@ #4000;
   dspvm002@ #4001;
   maesm011@ #4002;

   Referen@  #5000;
|FIN;

|VARIABLES;
    &enEmpCartera = 0; &enEmpGestion = 0; &eaCliGest = "";
    &nImporte = 0; &eaTipoOper = "";
    &eaEntPag = ""; &eaNumPag = "";

    &enNumRecs  = 0;
    &enNumSec   = 0;

    &eaUsuario = ""; &enImpAnt = 0;  &enImpAct = 0;  &eaDescr = "";
    &eaTipoReg = ""; &eaNumero = ""; &eaTipoOp = ""; &eaLlamada = "";
    &eaFicher  = ""; &eaClave  = ""; &HayConta = 0;

    &eaSerie      = "";
    &enFactura    = 0;
    &eaSerieDiv   = "";
    &eaFactuDiv   = "";
    &DocDividido  = 0;
    &TAgrup       = 0;
    &DDividido    = 0;
    &TotDividido  = 0;
    &FecEmision   = "";
    &FecAgrup     = "";
    &FecDividido  = "";
    &FecVtoAgr    = "";
    &FecVtoDiv    = "";
    &DAgrupador   = "";
    &aInforme     = "";
    &eaCodigo     = "";
    &eaTipoCod    = "";
    &aCuenta      = "";
    &eaSwCmpVta   = "";
    &eaCliente    = "";
    &enObra       = 0;
    &enModo       = 0;
    &Opcion       = 0;
    &Modo1        = "";
    &aOper        = "";
    &enSwEsFinal  = 0;
    &enSwLinea    = 0;
    &enSwDesgl    = 0;
    &efFechaImp   = @;
    &efFechaOri   = @;
    &efFechaApl   = @;
    &enDocumento  = 0;
    &eaModoSec    = "";
    &eaEntidad    = "";
    &eaSucursal   = "";
    &eaCuenta     = "";
    &eaDC         = "";
    &fAntVto      = @;

    &enCuadroIni = 0;
    &enCuadroFin = 0;
    &eaTitulo    = "";

    &enNumRemesa = 0;
    &enNumDoc    = 0;

    &efFechaEdit = @;
    &eaMovtoEdit = "";
    aModoSec     = "";
    nNumSesion = 0;
    nLinSesion = 0;
    nDocSesion = 0;

    nSwModoDiv = 0;       ||O -> Agrupacion; 1-> Division; 2-> Cobro
    aSwDire = "";
    nUltimoSubir = 0;
    nUltimoBajar = 0;
    nUltimo = 0;
    nAntOpc = 0;

    aCmp1 = "";
    aCmp2 = "";
    aCmp3 = "";
    aCmp4 = "";
    nCmp5 = 0;
    nCmp6 = 0;
    nCmp7 = 0;

    nNumAgrup    = 0;

    Linea        = 0;
    Documento    = 0;
    nDocAgrup    = 0;
    nDocOriDiv   = 0;
    nDocOri      = 0;
    nImpoOri     = 0;
    nDocDestino  = 0;
    nSwMiraSiFinal = 1;
    aBase        = "";
    aMas         = "";
    aEstado      = "";
    nVoy         = 0;
    aAux         = "";
    nSwPie       = 0;
    nSwMiraMas   = 0;
    nDesde       = 0;
    nSwVertical  = 0;

    nSwCargaDef3  = 0;
    nSwImpTraza   = 0;
    nSwImpCarta   = 0;
    nBotonImp     = 0;
    nBotonCarta   = 0;
    nDif          = 0;
    nTopeDiv      = 0;
    nSwCompleto   = 0;
    nSuma         = 0;
    nLinea        = 0;

    nModo         = 0;

    fFechaEmi     = @;
    DocAgrupador  = 0;
    aSwAgrDiv     = "";
    aMensaje      = "";
    MaxOpc        = 0;
    nID           = 0;
    Comodin       = "";
    nFlag         = 0;

    Dia      = "";
    Mes      = "";
    anyo     = "";

    fFecha1  = @;
    fFecha2  = @;

   nBotonOk     = 0;
   nBotonCancel = 0;
   nSwSal   = 0;
   &enSwErr = 0;
   nCalc    = 0;
   nCalc1   = 0;
   nCalc2   = 0;
   nCalc5   = 0;
   nCont    = 0;
   nNumOpc  = 0;
   nNumSecuencia = 0;
   aAlfa    = "";
   aAlfa1   = "";
   aAntMenu = "";
   aHotKey  = "";
   aTitulo  = "";

{-1}menu   = "";
    menu1  = "2400";
    menu2  = "1";
    menu3  = "";
    menu4  = "CSAPUMILTOZ";
    menu5  = " Clave ";
    menu6  = " Sig. ";
    menu7  = " Ant. ";
    menu8  = " Primera ";
    menu9  = " Ultima ";
    menu10 = " Modificar";
    menu11 = " Imprimir ";
    menu12 = " Lineas ";
    menu13 = "Texto";
    menu14 = "mOneda";
    menu15 = "traZabil";
    menu16 = "";
    menu17 = "";
    menu18 = "";
    menu19 = "";
    menu20 = "";
    menu21 = "";
    menu22 = "";
    menu23 = "";
    menu24 = "";

{25}NumOpciones = 0;

    &eaOpcMenu = "";

    nEmpresa = 0;
    nPeriodo = 0;
    nAnyo    = 0;

    nEmpr    = 0;

    aClv1    = "";
    aClv2    = "";
    aClv3    = "";
    aClv4    = "";
    aMovOrig = "";

    nRemesa = 0;
    nNumLin = 0;
    aOperac = "";

    ModoEntrada = 0;
    Flag = 0;
    nSwCerrada  = 0;
    nNumDocum   = 0;
    FEstado     = 0;
|FIN;

|PROCESO inf106;
     #dscam106#0 = 001;
     #dscam106#2 = 000000000;
|FPRC;

|PROCESO sup106;
     #dscam106#0 = 999;
     #dscam106#2 =9999999999;
|FPRC;

|PROCESO BotonCarta;
     nSwImpCarta = 1;
     |PTEC 806;
|FPRC;

|PROCESO BotonImp;
     nSwImpTraza = 1;
     |PTEC 806;
|FPRC;

|PROCESO MesLetra;
   |SI Mes = "01"; Mes = "Enero     "; |FINSI;
   |SI Mes = "02"; Mes = "Febrero   "; |FINSI;
   |SI Mes = "03"; Mes = "Marzo     "; |FINSI;
   |SI Mes = "04"; Mes = "Abril     "; |FINSI;
   |SI Mes = "05"; Mes = "Mayo      "; |FINSI;
   |SI Mes = "06"; Mes = "Junio     "; |FINSI;
   |SI Mes = "07"; Mes = "Julio     "; |FINSI;
   |SI Mes = "08"; Mes = "Agosto    "; |FINSI;
   |SI Mes = "09"; Mes = "Septiembre"; |FINSI;
   |SI Mes = "10"; Mes = "Octubre   "; |FINSI;
   |SI Mes = "11"; Mes = "Noviembre "; |FINSI;
   |SI Mes = "12"; Mes = "Diciembre "; |FINSI;
|FPRC;

|PROCESO CalcImpDivV;
   TotDividido = TotDividido + #dscam003#30;
|FPRC;

|DEFBUCLE CalcImpDivV;
#dscam003#1;
82, 83;
000000001, "S", DocDividido;
999999999, "S", DocDividido;
;
NULL, CalcImpDivV;
|FIN;

|PROCESO RecibosCarta;
   |PRINT;
|FPRC;

|DEFBUCLE RecibosCarta;
#dscam003#8;
;
000000001,DocAgrupador;
999999999,DocAgrupador;
be;
NULL,RecibosCarta;
|FIN;

|DEFBUCLE RecibosCartaDiv;
#dscam003#1;
82,83;
000000001,"S",DocDividido;
999999999,"S",DocDividido;
be;
NULL,RecibosCarta;
|FIN;

|PROCESO GeneraCarta;
   |IMPRE 0;
   |SI FSalida ! 0; |ACABA; |FINSI;

   |SI aSwAgrDiv = "A";
      aInforme = "Carta de agrupacion"; |HAZ ObtenInforme;
   |FINSI;
   |SI aSwAgrDiv = "D";
      aInforme = "Carta de division"; |HAZ ObtenInforme;
      |SI aInforme = "Carta de division"; aInforme = "cartaex2"; |FINSI;
   |FINSI;

   |INFOR aInforme;
   |SI FSalida ! 0; |ACABA; |FINSI;

   eaCodigo = #dscam003#32; eaTipoCod = "C"; aCuenta = #dscam003#5; |HAZ LeeDatos;
   eaSwCmpVta  = "V";
   |SI aSwAgrDiv = "A"; |BUCLE RecibosCarta;    |FINSI;
   |SI aSwAgrDiv = "D"; |BUCLE RecibosCartaDiv; |FINSI;

   |PIEINF;
   |FININF;
   |FINIMP;
|FPRC;

|PROCESO SacaCartaDiv;
   |SALVA_FICHA #dscam003;
   DocDividido = #dscam003#83; fFechaEmi = #dscam003#4;
   DDividido = ("000000000" + DocDividido) % -109;
   #dscam003#40 = DocDividido; |LEE 000#dscam003.=;
   eaSerieDiv = #dscam003#0; eaFactuDiv = #dscam003#1;
   FecDividido  = #dscam003#4; FecVtoDiv = #dscam003#3;
   TotDividido = 0; |BUCLE CalcImpDivV;
   Dia  = fFechaEmi % 0102; Dia = ("00" + Dia) % -102;
   Mes  = fFechaEmi % 0402; Mes = ("00" + Mes) % -102; |HAZ MesLetra; |QBF Mes;
   anyo = fFechaEmi % -104;
   FecEmision = Dia + " de " + Mes + " de " + anyo;
   |REPON_FICHA #dscam003;

   |HAZ GeneraCarta;
|FPRC;

|PROCESO SacaCarta;
   |SALVA_FICHA #dscam003; |SALVA_FICHA #dscam004;
   |SI #dscam003#49 = "S"; aSwAgrDiv = "A"; |HAZ SacaCartaAgr; |FINSI;
   |SI #dscam003#82 = "S"; aSwAgrDiv = "D"; |HAZ SacaCartaDiv; |FINSI;
   |REPON_FICHA #dscam004; |REPON_FICHA #dscam003;
|FPRC;

|PROCESO SacaCartaAgr;
   DocAgrupador = #dscam003#40;
   DAgrupador = ("000000000" + DocAgrupador) % -109;
   #dscam003#40 = DocAgrupador; |LEE 000#dscam003.=;
   FecAgrup  = #dscam003#4; FecVtoAgr = #dscam003#3;
   TAgrup   = #dscam003#30;
   Dia  = FecAgrup % 0102; Dia = ("00" + Dia) % -102;
   Mes  = FecAgrup % 0402; Mes = ("00" + Mes) % -102; |HAZ MesLetra; |QBF Mes;
   anyo = FecAgrup % -104;
   FecEmision = Dia + " de " + Mes + " de " + anyo;
   |HAZ GeneraCarta;
|FPRC;

|PROCESO IncluyeOpc;
   menu4 = menu4 + aHotKey;
   |PARA nCont = 16; |SI nCont < 24; |HACIENDO nCont = nCont + 1;
      Imenu = menu1<-; Imenu = Imenu + (nCont - 1);
      |SI menu = "";
         menu = aTitulo;
         nCalc = nCont - 16;
         INumOpciones = NumOpciones1<-; INumOpciones = INumOpciones + nCalc;
         NumOpciones = nNumOpc;
         Imenu = menu1<-;
         |SAL;
      |FINSI;
   |SIGUE;
   MaxOpc = MaxOpc + 1;
|FPRC;

|PROCESO MenuOpciones;
      menu2 = nAntOpc;
      aAntMenu = menu4;

      |PARA nCont = 0; |SI nCont < 19; |HACIENDO nCont = nCont + 1;
         INumOpciones = NumOpciones1<-; INumOpciones = INumOpciones + nCont;
         NumOpciones = 0;
      |SIGUE;
      menu16 = ""; menu17 = ""; menu18 = ""; menu19 = "";
      menu20 = ""; menu21 = ""; menu22 = ""; menu23 = ""; menu24 = "";

      MaxOpc = 11; nID = 0; nNumOpc = 12;
      |SI #dscam003#49 = "S";
         aHotKey = "G"; aTitulo = "aGrupados"; |HAZ IncluyeOpc; nNumOpc = nNumOpc + 1;
         |SI #dscam003#14 = "D";
            aHotKey = "D"; aTitulo = "Divididos"; |HAZ IncluyeOpc;  nNumOpc = nNumOpc + 1;
         |FINSI;
      |SINO;
         |SI #dscam003#14 = "D";
            aHotKey = "D"; aTitulo = "Divididos"; |HAZ IncluyeOpc;  nNumOpc = nNumOpc + 1;
         |FINSI;
      |FINSI;
      |SI #dscam003#49 = "S";
         aHotKey = "g"; aTitulo = "Carta Agr."; |HAZ IncluyeOpc;  nNumOpc = nNumOpc + 1;
         |SI #dscam003#82 = "S";
            aHotKey = "d"; aTitulo = "Carta Div."; |HAZ IncluyeOpc;  nNumOpc = nNumOpc + 1;
         |FINSI;
      |SINO;
         |SI #dscam003#82 = "S";
            aHotKey = "d"; aTitulo = "Carta Div."; |HAZ IncluyeOpc;  nNumOpc = nNumOpc + 1;
         |FINSI;
      |FINSI;
      |HAZ EsMOrts;
      |SI FSalida = 0;
         aHotKey = "Q"; aTitulo = "LiQuidaciones"; |HAZ IncluyeOpc;  nNumOpc = nNumOpc + 1;
      |FINSI;

      |HAZ EsArtenvas;
      |SI FSalida = 0;
         aHotKey = "N"; aTitulo = "situacioNes";  |HAZ IncluyeOpc; nNumOpc = nNumOpc + 1;
         aHotKey = "V"; aTitulo = "Vto.Original"; |HAZ IncluyeOpc; nNumOpc = nNumOpc + 1;
      |FINSI;

      |MENU menu;
      Opcion = FSalida; |PTEC 802; |PAUSA; nAntOpc = Opcion;
      |SI Opcion > MaxOpc;
         Opcion = -1;
      |SINO;
         |SI Opcion ] 12;
            nCalc = (Opcion * 100) + 1;
            eaOpcMenu = menu4; eaOpcMenu = eaOpcMenu % nCalc;
            nCalc = Opcion - 12;
            INumOpciones = NumOpciones1<-; INumOpciones = INumOpciones + nCalc;
            Opcion = NumOpciones;
         |SINO;
            eaOpcMenu = "";
         |FINSI;
      |FINSI;

      menu4 = aAntMenu;
|FPRC;

|PROCESO BotonAplaza;
   |SALVA_FICHA #dscam003;
   |HAZ Tipo9;
   enDocumento = #dscam003#40;
   efFechaOri  = #dscam003#3;
   eaEntidad   = #dscam003#72; eaNumero = #dscam003#70;
   efFechaApl  = #dscam003#3; |HAZ Aplaza;
   |HAZ Tipo8;
   |REPON_FICHA #dscam003;
|FPRC;

|PROCESO CuentaSesion;
   |SI #dscam004#17 ! nDocSesion;
      nLinSesion = nLinSesion + 1;
   |FINSI;
|FPRC;

|DEFBUCLE CuentaSesion;
#dscam004#3;
;
nNumSecuencia;
nNumSecuencia;
;
NULL, CuentaSesion;
|FIN;

|PROCESO TrataSecuencia;
      || Me guardo el n§ de secuencia y la clave del historico de enlaces
      nNumSecuencia = #dscam004#43;
      aCmp1 = #dscam067#0;
      aCmp2 = #dscam067#1;
      aCmp3 = #dscam067#2;
      aCmp4 = #dscam067#3;
      nCmp5 = #dscam067#11;
      nCmp6 = #dscam067#8;
      nCmp7 = #dscam067#9;

      || En caso de que haya cambiado la cuenta contable o el movimiento
      ||    no hay problema en que el movimiento mantenga el n§ de sesion,
      ||    pero si lo que ha cambiado es la fecha y hay mas de un movimiento
      ||    en el n§ de sesion es imposible mantenerlo.
      |SALVA_FICHA #dscam004;
      nNumSecuencia = #dscam004#43; nDocSesion = #dscam004#17;
      nLinSesion = 0; |BUCLE CuentaSesion;
      |LEE 000#dscam004.p; |REPON_FICHA #dscam004;
      |SI nLinSesion = 0;
         aModoSec = "";
      |SINO;
         || Compruebo si hay un solo documento en la sesion. Si es asi, el modo
         ||     es de baja y eliminamos la sesion del movimiento
         |SI efFechaEdit ! #dscam004#6;
            #dscam004#43 = 0; |GRABA 020#dscam004.a;
            |BORRA 020#dscam067.a; |LIBERA #dscam067;

            aModoSec = "";
         |SINO;
            aModoSec = ",B";
         |FINSI;
      |FINSI;

      || Hago el enlace de la secuencia
      |DDEFECTO #dscaw013;
      #dscaw013#15 = #dscam067#10; #dscaw013#0 = 1;
      #dscaw013#13 = "dscam004";   #dscaw013#14 = 43;
      #dscaw013#11 = "N";          #dscaw013#12 = 9;
      #dscaw013#5 = nNumSecuencia;  #dscaw013#6 = nNumSecuencia;
      |GRABA 020#dscaw013.n;
      |LIBERA #dscaw013; |CIERRA #dscaw013;

      Comodin = #dscam067#10;
      Comodin = "dscam033.tab;" + Comodin + aModoSec;
      |SI aOper = "RTA"; Comodin = Comodin + ",V"; |FINSI;

      |LIBERA #dscam067; |CIERRAT #dscam067;
      |LIBERA #dscam003; |CIERRAT #dscam003;
      |LIBERA #dscam004; |CIERRAT #dscam004;
      |SUB_EJECUTA_NP Comodin;
      |ABRET #dscam003; |LEE 101#dscam003.=;
      |ABRET #dscam004; |LEE 101#dscam004.=;
      |ABRET #dscam067;
      #dscam067#0  = aCmp1;
      #dscam067#1  = aCmp2;
      #dscam067#2  = aCmp3;
      #dscam067#3  = aCmp4;
      #dscam067#11 = nCmp5;
      #dscam067#8  = nCmp6;
      #dscam067#9  = nCmp7;
      |LEE 000#dscam067.=;

      |CIERRA #dscaw013; |DELINDEX #dscaw013;
      |DELINDEX #dscaw013; |ABRE #dscaw013;
|FPRC;

|PROCESO BloqueaCambios;
   nFlag = 0 +. 1; enSwErr = 0;

   |SI #dscam004#5 = "PRC";
      |SI #dscam003#17 = 0; |O #dscam003#14 ! "L";
         enSwErr = 1;
         |SI nFlag < 0;
            |MENAV "    El recibo no pertenece a una remesa o esta no esta abonada";
         |FINSI;
         |ERROR; |ACABA;
      |FINSI;
      |C_M #dscam004#7,1,"N";  |C_M #dscam004#25,1,"N";
      |C_M #dscam004#8,1,"N";  |C_M #dscam004#9,1,"N";
      |C_M #dscam004#12,1,"N"; |C_M #dscam004#13,1,"N";
      |C_M #dscam004#14,1,"N"; |C_M #dscam004#23,1,"N";
      |C_M #dscam004#26,1,"N"; |C_M #dscam004#27,1,"N";
      |C_M #dscam004#29,1,"N"; |C_M #dscam004#30,1,"N";
      |C_M #dscam004#31,1,"N"; |C_M #dscam004#32,1,"N";
      |ACABA;
   |FINSI;

   |SI #dscam004#5 = "RCE";
      |SALVA_FICHA #dscam004;
      |LEE 000#dscam004.a;
      |SI #dscam004#5 ! "PRC"
         enSwErr = 1;
         |SI nFlag < 0;
            |MENAV "    El recibo no tiene peticion de reclamacion";
         |FINSI;
         |REPON_FICHA #dscam004;
         |ERROR; |ACABA;
      |FINSI;
      |REPON_FICHA #dscam004;
      |SI nFlag < 0;
         |SI #dscam003#14 ! "P";
            enSwErr = 1;
            |MENAV "    El recibo no est  pendiente despues de la reclamacion";
            |ERROR; |ACABA;
         |FINSI;
      |FINSI;
      |C_M #dscam004#7,1,"N";  |C_M #dscam004#25,1,"N";
      |C_M #dscam004#8,1,"N";  |C_M #dscam004#9,1,"N";
      |C_M #dscam004#12,1,"N"; |C_M #dscam004#13,1,"N";
      |C_M #dscam004#14,1,"N"; |C_M #dscam004#23,1,"N";
      |C_M #dscam004#26,1,"N"; |C_M #dscam004#27,1,"N";
      |C_M #dscam004#29,1,"N"; |C_M #dscam004#30,1,"N";
      |C_M #dscam004#31,1,"N"; |C_M #dscam004#32,1,"N";
      |ACABA;
   |FINSI;

   |SI #dscam004#5 = "PRE"; |O #dscam004#5 = "EMR"; |O #dscam004#5 = "REM";
      enSwErr = 1;
      |SI nFlag < 0;
         |MENAV "    No se pueden modificar estos movimientos. Se controlan por el mantenimiento de remesas";
      |FINSI;
      |ERROR; |ACABA;
   |FINSI;
|FPRC;

|PROCESO MalpeCom;
   eaCliente = #dscam003#32;
   enObra    = #dscam003#91; enModo = 4;
   aAlfa     = ":dscomer9/malpe185.tab;" + (("00000" + #dscam044#0) % -105);
   |SUB_EJECUTA aAlfa;
|FPRC;

|PROCESO MeteRestoCampos;
     |SI nSwCargaDef3 = 1;
          #referen@#40 = #dscam106#3;
          |LEE 000#referen@.=;
          |SI FSalida = 0;
               #dscam106#10 = #referen@#14;
               #dscam106#11 = #referen@#15;
               #dscam106#12 = #referen@#60;
               #dscam106#13 = #referen@#25;
               #dscam106#14 = #referen@#23;
               #dscam106#15 = #referen@#12;
               #dscam106#16 = #referen@#2;
               #dscam106#17 = #referen@#65;
               #dscam106#19 = #referen@#0;
               #dscam106#20 = #referen@#1;
               #dscam106#21 = #referen@#4;
               #dscam106#22 = #referen@#3;
          |FINSI;
          #referen@#40 = #dscam106#2;
          |LEE 000#referen@.=;
          |SI FSalida = 0;
               #dscam106#1 = #referen@#4;
               #dscam106#4 = #referen@#0;
               #dscam106#5 = #referen@#1;
               #dscam106#23 = #referen@#3;
               #dscam106#24 = #referen@#2;
               #dscam106#25 = #referen@#65;
               #dscam106#26 = #referen@#14;
               #dscam106#27 = #referen@#15;
               #dscam106#28 = #referen@#64;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaRecTraza;
     Linea = Linea + 1;

     |SI aSwDire = "SUBIR";
          nUltimoSubir = nUltimoSubir + 1;
          nUltimo = nUltimoSubir;
     |SINO;
          nUltimoBajar = nUltimoBajar - 1;
          nUltimo = nUltimoBajar;
     |FINSI;

     |DDEFECTO #dscam106;
     #dscam106#0 = nUltimo;
     |LEE 101#dscam106.=;
     |SI FSalida ! 0;
          |SI aSwDire = "SUBIR";
               #dscam106#2 = Documento;
               |SI nSwModoDiv = 1;
                    #dscam106#3 = #dscam003#40;
               |SINO;
                    |SI nSwModoDiv = 0;
                         #dscam106#3 = #dscam003#41;
                    |SINO;
                         #dscam106#3 = Documento;
                    |FINSI;
               |FINSI;
               |SI nSwModoDiv = 1;
                    #dscam106#6 = "Division";
               |SINO;
                    |SI nSwModoDiv = 0;
                         #dscam106#6 = "Agrupacion";
                    |SINO;
                         #dscam106#6 = "Cobro";
                    |FINSI;
               |FINSI;
               |SI nSwModoDiv = 1; |Y nTopeDiv ! 0;
                    nSuma = nSuma + #dscam003#64;
                    |SI nSuma ] nTopeDiv;
                          nDif = nSuma - nTopeDiv;
                          #dscam106#7 = #dscam003#64 - nDif;
                          nSwCompleto = 1;
                    |SINO;
                          #dscam106#7 = #dscam003#64;
                    |FINSI;
               |SINO;
                    |SI nSwModoDiv = 2; |Y nTopeDiv ! 0;
                         ||Total Liquidado
                         nSuma = nSuma + #dscam003#23;
                         |SI nSuma ] nTopeDiv;
                               nDif = nSuma - nTopeDiv;
                               #dscam106#7 = #dscam003#23 - nDif;
                               nSwCompleto = 1;
                         |SINO;
                               #dscam106#7 = #dscam003#23;
                         |FINSI;
                    |SINO;
                         #dscam106#7 = #dscam003#64;
                    |FINSI;
               |FINSI;
               |SI nSwModoDiv = 2;
                    #dscam106#8 = "NO";
               |SINO;
                    #dscam106#8 = "PE";
               |FINSI;
               #dscam106#9 = "NO";

               |HAZ MeteRestoCampos;
          |SINO;
               ||MODO BAJAR. TODO CCC. ARA

               #dscam106#2 = #dscam003#40;
               #dscam106#3 = nDocOri;
               |SI nSwModoDiv = 1;
                    #dscam106#6 = "Division";
               |SINO;
                    |SI nSwModoDiv = 0;
                         #dscam106#6 = "Agrupacion";
                    |SINO;
                         #dscam106#6 = "Cobro";
                    |FINSI;
               |FINSI;
               |SI nSwModoDiv = 0;
                    #dscam106#7 = #dscam003#64;
               |SINO;
                    #dscam106#7 = nImpoOri;
               |FINSI;
               #dscam106#8 = "NO";
               #dscam106#9 = "PE";
               |HAZ MeteRestoCampos;
          |FINSI;
          |GRABA 020#dscam106.n;

          |SI nSwMiraSiFinal = 1;
               enSwEsFinal = 0;
          |FINSI;
     |FINSI;
     |LIBERA #dscam106;

     |SI nSwCompleto = 1;
          nSwCompleto = 0;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE AgrupadosTraza;
#dscam003#1;
41;
000000001,nDocOri;
999999999,nDocOri;
;
NULL,GrabaRecTraza;
|FIN;

|DEFBUCLE DivididosTraza;
#dscam003#1;
83;
000000001,Documento;
999999999,Documento;
;
NULL,GrabaRecTraza;
|FIN;

|PROCESO MasTraza;
     nSwModoDiv = 1;
     |BUCLE DivididosTraza;
     nSwModoDiv = 0;
     #dscam003#40 = Documento;
     |LEE 000#dscam003.=;
     |SI FSalida = 0;
          nDocAgrup = #dscam003#41;
          |SI nDocAgrup ! 0;
               nSwModoDiv = 0;
               |HAZ GrabaRecTraza;
          |FINSI;
          aEstado = #dscam003#14;
          |SI aEstado = "L"; |O aEstado = "C";
               nSwModoDiv = 2;
               |HAZ GrabaRecTraza;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MasTrazaBajar;
     nSwModoDiv = 1;
     |SI nDocOriDiv ! 0;
          |DDEFECTO #dscam003;
          #dscam003#40 = nDocOriDiv;
          |LEE 000#dscam003.=;
          |SI FSalida = 0;
               |HAZ GrabaRecTraza;
          |FINSI;
     |FINSI;

     nSwModoDiv = 0;
     |||BUCLE AgrupadosTraza;  ||Necesito recorrer este bucle al reves.
     |LEE 000#dscam003.u;      ||Lo hacemos con un |PARA.
     |SI FSalida = 0;
          |PARA; |SI; |HACIENDO;
               |SI #dscam003#41 = nDocOri;
                    |HAZ GrabaRecTraza;
               |FINSI;
               |LEE 000#dscam003.a;
               |SI FSalida ! 0; |SAL; |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO LineasRecibo;
     enSwLinea = 4;
     |PRINT;
|FPRC;

|DEFBUCLE LineasRecibo;
 #dscam004#1;
 ;
 #dscam003#40, 01;
 #dscam003#40, 99;
 ;
 NULL, LineasRecibo;
|FIN;

|PROCESO MiraMas;
     |SI #dscam106#2 = nDocDestino;
          nSwMiraMas = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE MiraMas;
 #dscam106#1;
 ;
 nDesde;
 999;
 ;
 NULL, MiraMas;
|FIN;

|PROCESO RecibosAgrupados;
   #dscam106#3  = #dscam003#40;
   #dscam106#12 = #dscam003#30;
   #dscam106#13 = #dscam003#25;
   #dscam106#14 = #dscam003#23;
   #dscam106#15 = #dscam003#4;
   #dscam106#16 = #dscam003#3;
   |PRINT;
|FPRC;

|DEFBUCLE RecibosAgrupados;
   #dscam003#8;
   ;
   0000000000, nNumAgrup;
   9999999999, nNumAgrup;
   ;
   NULL, RecibosAgrupados;
|FIN;

|PROCESO ImpTraza;
     nSwPie = 0;
     Impresora = "CrystalReport"
     |IMPRE -1;
     ||IMPRE 0;
     |SI FSalida = 0;
          aInforme = "dscam106";
          |INFOR aInforme;
          |SI FSalida = 0;
               nVoy = nUltimoBajar - 1;
               |PARA; |SI; |HACIENDO;
                    nVoy = nVoy + 1;
                    |DDEFECTO #506;
                    #506#0 = nVoy;
                    |LEE 000#506.=;
                    |SI FSalida ! 0;
                         |SI nVoy ! 500;
                              |SAL;
                         |FINSI;
                    |FINSI;
                    |SI nVoy ! 500;
                         enSwLinea = 1;
                         |PRINT;

                         aAux = #dscam106#6; |QBF aAux;
                         |SI aAux = "Agrupacion"; |Y #dscam003#49 ! "S";
                            enSwDesgl = 1;
                            |SALVA_FICHA #dscam003;
                            enSwLinea = 1; nNumAgrup = #dscam106#3;
                            |BUCLE RecibosAgrupados;
                            |REPON_FICHA #dscam003;
                            enSwDesgl = 0;
                         |FINSI;

                         |SI aAux = "Cobro";
                              enSwLinea = 3;
                              |PRINT;
                         |SINO;
                              nSwMiraMas = 0;
                              nDocDestino = #506#3;
                              nDesde = nVoy + 1;
                              |BUCLE MiraMas;
                              |SI nSwMiraMas = 0;
                                   #506#0 = nVoy;
                                   |LEE 000#506.=;
                                   enSwLinea = 2;
                                   |PRINT;
                              |FINSI;
                         |FINSI;
                         nSwPie = 1;
                    |FINSI;
               |SIGUE;
               |BUCLE LineasRecibo;
               |SI nSwPie = 1;
                    |PIEINF;
               |FINSI;
               |FININF;
          |SINO;
               aMensaje = "0000Informe " + aInforme + " inaccesible.";
               |MENAV aMensaje;
          |FINSI;
          |FINIMP;
     |SINO;
          |MENAV "0000Proceso cancelado.";
     |FINSI;
|FPRC;

|PROCESO ImpCarta;
     nSwPie = 0;

     aMensaje = "0000NUtilizar formato Vertical" + &13 + "Carta de Impagado?";
     |CONFI aMensaje;
     |SI FSalida = 0;
          nSwVertical = 1;
     |SINO;
          nSwVertical = 0;
     |FINSI;

     Impresora = "CrystalReport"
     |IMPRE -1;
     |SI FSalida = 0;
          |SI nSwVertical = 0;
               aInforme = "Carta impagado horizontal"; |HAZ ObtenInforme;
               |SI aInforme = "Carta impagado horizontal";
                  aInforme = "luxe0106";
               |FINSI;
          |SINO;
               aInforme = "Carta impagado vertical"; |HAZ ObtenInforme;
               |SI aInforme = "Carta impagado vertical";
                  aInforme = "luxe0107";
               |FINSI;
          |FINSI;
          |INFOR aInforme;
          |SI FSalida = 0;
            |DDEF aAlfa; |QBF aAlfa;
            aAlfa = aAlfa + "dscam004.mas";
            |CARGA_DEF aAlfa, dscam004@;
            |SI FSalida = 0;
               |DFICE aAlfa; |QBF aAlfa; |PATH_DAT #dscam004@#aAlfa#;
               |ABRE #dscam004@;
               #dscam004@#17 = #dscam003#40;
               #dscam004@#3  = 99;
               |LEE 000#dscam004@.];
               |SI FSalida = 0;
                  |SI #dscam004@#17 ! #dscam003#40;
                     |LEE 000#dscam004@.a;
                     |SI FSalida = 0;
                        |SI #dscam004@#17 ! #dscam003#40;
                           |DDEFECTO #dscam004@;
                        |FINSI;
                     |SINO;
                        |DDEFECTO #dscam004@;
                     |FINSI;
                  |FINSI;
               |SINO;
                  |LEE 000#dscam004@.u;
                  |SI FSalida = 0;
                     |SI #dscam004@#17 ! #dscam003#40;
                        |DDEFECTO #dscam004@;
                     |FINSI;
                  |SINO;
                     |DDEFECTO #dscam004@;
                  |FINSI;
               |FINSI;
               |PARA; |SI FSalida = 0; |Y #dscam004@#17 ! #dscam003#40; |HACIENDO;
                  |SI #dscam004@#5 = "IMP"; |SAL; |FINSI;
                  |LEE 000#dscam004@.s;
               |SIGUE;
               |SI #dscam004@#5 ! "IMP"; |DDEFECTO #dscam004@; |FINSI;
               efFechaImp = #dscam004@#6;
               |CIERRA #dscam004@; |DESCARGA_DEF #dscam004@;

               |ABRE #dscam052;
               |DDEFECTO #dscam052;
               #dscam052#0 = #dscam003#32;
               |LEE 000#dscam052.=;
               |CIERRA #dscam052;

               nVoy = nUltimoBajar - 1;
               |PARA; |SI; |HACIENDO;
                    nVoy = nVoy + 1;
                    |DDEFECTO #506;
                    #506#0 = nVoy;
                    |LEE 000#506.=;
                    |SI FSalida ! 0;
                         |SI nVoy ! 500;
                              |SAL;
                         |FINSI;
                    |FINSI;
                    |SI nVoy ! 500;
                         |PRINT;
                    |FINSI;
               |SIGUE;

               nVoy = nVoy + 1;
               #dscam106#0 = nVoy;
               #dscam106#1 = #dscam003#3;
               #dscam106#2 = #dscam003#40;
               #dscam106#3 = #dscam003#40;
               #dscam106#4 = #dscam003#0;
               #dscam106#5 = #dscam003#1;
               #dscam106#6 = "Impagado";
               #dscam106#7 = #dscam003#64;
               #dscam106#8 = "NO";
               #dscam106#9 = "NO";
               #dscam106#10 = #dscam003#14;
               #dscam106#11 = #dscam003#15;
               #dscam106#12 = #dscam003#60;
               #dscam106#13 = #dscam003#25;
               #dscam106#14 = #dscam003#23;
               #dscam106#15 = #dscam003#12;
               #dscam106#16 = #dscam003#2;
               #dscam106#17 = #dscam003#65;
               #dscam106#19 = #dscam003#0;
               #dscam106#20 = #dscam003#1;
               #dscam106#21 = #dscam003#4;
               #dscam106#22 = #dscam003#3;

               #dscam106#1 = #dscam003#4;
               #dscam106#4 = #dscam003#0;
               #dscam106#5 = #dscam003#1;
               #dscam106#23 = #dscam003#3;
               #dscam106#24 = #dscam003#2;
               #dscam106#25 = #dscam003#65;
               #dscam106#26 = #dscam003#14;
               #dscam106#27 = #dscam003#15;
               #dscam106#28 = #referen@#64;

               ||ARA55
               |PRINT;

               |PIEINF;
               |FININF;
            |FINSI;
          |SINO;
               aMensaje = "0000Informe " + aInforme + " inaccesible.";
               |MENAV aMensaje;
          |FINSI;
          |FINIMP;
     |SINO;
          |MENAV "0000Proceso cancelado.";
     |FINSI;
|FPRC;

|PROCESO Trazabilidad;
     aAlfa1 = Usuario;
     |QBF aAlfa1;

     aAlfa1 = "55" + aAlfa1;
     |NOME_DAT #506 aAlfa1;
     |ABRE #506;
     |CIERRA #506;

     |DELINDEX #506;

     |ABRET #506;

     nSwCargaDef3 = 0;
     |DBASE aBase; |QBF aBase;
     aMas = aBase + "def/dscam003.mas";
     |CARGA_DEF aMas, referen@;
     |SI FSalida = 0;
          nSwCargaDef3 = 1;
     |FINSI;
     |SI nSwCargaDef3 = 1;
          |ABRE #referen@;
     |FINSI;

     nSuma = 0;

     |LEE 101#dscam003.=;
     |PUSHV 0501 2380;
     Documento = #dscam003#40;
     nDocOri = #dscam003#40;
     nTopeDiv = #dscam003#64;
     nImpoOri = #dscam003#64;
     nDocOriDiv = #dscam003#83;
     Linea = 1;
     |SALVA_FICHA #dscam003;
     |DELINDEX #dscam025;

     aSwDire = "SUBIR";
     nUltimoSubir = 500;

     nSwMiraSiFinal = 1;
     enSwEsFinal = 1;

     nSwModoDiv = 1;
     |BUCLE DivididosTraza;
     nSwModoDiv = 0;
     #dscam003#40 = Documento;
     |LEE 000#dscam003.=;
     |SI FSalida = 0;
          nDocAgrup = #dscam003#41;
          |SI nDocAgrup ! 0;
               nSwModoDiv = 0;
               |HAZ GrabaRecTraza;
          |FINSI;
          aEstado = #dscam003#14;
          |SI aEstado = "L"; |O aEstado = "C";
               nSwMiraSiFinal = 0;
               nSwModoDiv = 2;
               |HAZ GrabaRecTraza;
          |FINSI;
     |FINSI;

     nSwMiraSiFinal = 0;

     ||Aqui pongo el bucle para ir rellenado con el resto de niveles.
     nVoy = 500;
     |PARA; |SI; |HACIENDO;
          |SI Linea > 499; |SAL; |FINSI;
          nVoy = nVoy + 1;
          |DDEFECTO #506;
          #506#0 = nVoy;
          |LEE 101#506.=;
          |SI FSalida ! 0;
               |SAL;
          |SINO;
               |SI #506#8 = "PE";
                    #506#8 = "NO";
                    |GRABA 020#506.a;
                    |LIBERA #506;
                    Documento = #506#3;
                    nTopeDiv = #506#7;
                    nSwCompleto = 0;
                    nSuma = 0;
                    |HAZ MasTraza;
               |SINO;
                    |LIBERA #506;
               |FINSI;
          |FINSI;
     |SIGUE;

     ||ARA HACEMOS EL PROCESO CONTRARIO.
     aSwDire = "BAJAR";
     nTopeDiv = 0;
     nUltimoBajar = 500;
     nSwModoDiv = 1;
     |SI nDocOriDiv ! 0;
          |DDEFECTO #dscam003;
          #dscam003#40 = nDocOriDiv;
          |LEE 000#dscam003.=;
          |SI FSalida = 0;
               |HAZ GrabaRecTraza;
          |FINSI;
     |FINSI;

     nSwModoDiv = 0;
     |||BUCLE AgrupadosTraza;  ||Necesito recorrer este bucle al reves.
     |LEE 000#dscam003.u;      ||Lo hacemos con un |PARA.
     |SI FSalida = 0;
          |PARA; |SI; |HACIENDO;
               |SI #dscam003#41 = nDocOri;
                    |HAZ GrabaRecTraza;
               |FINSI;
               |LEE 000#dscam003.a;
               |SI FSalida ! 0; |SAL; |FINSI;
          |SIGUE;
     |FINSI;

     ||Aqui pongo el bucle para ir rellenado con el resto de niveles. (BAJAR)
     nVoy = 500;
     |PARA; |SI; |HACIENDO;
          |SI Linea > 499; |SAL; |FINSI;
          nVoy = nVoy - 1;
          |DDEFECTO #506;
          #506#0 = nVoy;
          |LEE 101#506.=;
          |SI FSalida ! 0;
               |SAL;
          |SINO;
               |SI #506#9 = "PE";
                    #506#9 = "NO";
                    |GRABA 020#506.a;
                    |LIBERA #506;

                    |DDEFECTO #dscam003;
                    #dscam003#40 = #506#2;
                    |LEE 000#dscam003.=;
                    |SI FSalida = 0;
                         nDocOri = #dscam003#40;
                         nTopeDiv = #dscam003#64;
                         nImpoOri = #dscam003#64;
                         nDocOriDiv = #dscam003#83;
                         |HAZ MasTrazaBajar;
                    |FINSI;
               |SINO;
                    |LIBERA #506;
               |FINSI;
          |FINSI;
     |SIGUE;

     |REPON_FICHA #dscam003;

     |CONTROL_SIMPLE 0, "BOTON, {{205}} Inf. Trazabilidad", 2302, 2316, BotonImp;
     nBotonImp = FSalida; |PULSATECLA;

     ||SI es Impagado y luxe. Permite imprimir CARTA DE IMPAGADO.
     |SI #dscam003#14 = "I";
          |HAZ EsLuxe;
          |SI FSalida = 0;
               |CONTROL_SIMPLE 0, "BOTON, {{205}} Carta de Impagado", 2318, 2334, BotonCarta;
               nBotonCarta = FSalida; |PULSATECLA;
          |FINSI;
     |FINSI;

     |ENTLINEAL #2#dscam106,-2,4,21,1,inf106,sup106;

     |POPV;
     |LIBERA #dscam003;
     |FIN_CONTROL_WINDOWS nBotonImp;

     |SI nBotonCarta ! 0;
          |FIN_CONTROL_WINDOWS nBotonCarta;
          nBotonCarta = 0;
     |FINSI;

     |SI nSwImpTraza = 1;
          nSwImpTraza = 0;
          |HAZ ImpTraza;
     |FINSI;

     |SI nSwImpCarta = 1;
          nSwImpCarta = 0;
          |HAZ ImpCarta;
     |FINSI;

     |SI nSwCargaDef3 = 1;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
          nSwCargaDef3 = 0;
     |FINSI;

     |CIERRAT #506;

     |DELINDEX #506;
     nTopeDiv = 0;
|FPRC;

|PROCESO AntesSituacion; |TIPO 7;
   |C_M #dscam003#35, 1 , "S";
   |SI #dscam003#35 = "   ";
      aAlfa = #dscam003#36; |QBF aAlfa;
      |SI aAlfa ! "";
         |ABRE #dscam163;
         #dscam163#0 = #dscam003#35;
         |LEE 000#dscam163.=;
         |SI FSalida = 0;
            aAlfa1 = #dscam163#1; |QBF aAlfa1;
            |SI aAlfa ! aAlfa1;
               |C_M #dscam003#35, 1 , "N";
            |FINSI;
         |FINSI;
         |CIERRA #dscam163;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO TrasSituacion;
   |HAZ EsDiagram;
   |SI FSalida = 0;
      |SI #dscam003#35 = "   ";
         |C_M #dscam003#36, 1, "S";
      |SINO;
         |C_M #dscam003#36, 1, "N";
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO MiraImporte;
   |SI #dscam004#5 = "COB"; |O #dscam004#5 = "COP";
      |SI #dscam003#30 < 0;
         |SI #dscam004#8 < #dscam003#31;
            |MENAV "    Importe maximo sobrepasado "; |ERROR;
         |FINSI;
      |SINO;
         |SI #dscam004#8 > #dscam003#31;
            |MENAV "    Importe maximo sobrepasado "; |ERROR;
         |FINSI;
      |FINSI;
   |FINSI;
   |SI #dscam004#5 = "IMP";
      |SI #dscam004#9 > #dscam003#30;
         |MENAV "    Importe maximo sobrepasado "; |ERROR;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO PonColor;
   |SI #dscam051#68 = "S";
      |SI #dscam003#4 ! #dscam003#99;
         |ATRI R; aAlfa = #dscam003#99;
         |PINTA 0969, aAlfa;
         |ATRI N;
      |SINO;
         |PINTA #dscam003#99;
      |FINSI;
   |SINO;
      |PINTA #dscam003#4;
   |FINSI;
|FPRC;

|PROCESO CalcuRec;
   #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
   #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
   #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
   #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);

   #dscam003#31 = #dscam003#30 - #dscam003#23; #dscam003#65 = #dscam003#64 - #dscam003#61;
   |PINTA #dscam003#64;
   |PINTA #dscam003#65;
|FPRC;

|PROCESO CalcDC;
   eaEntidad = #dscam003#8;
   eaSucursal = #dscam003#9;
   eaCuenta = #dscam003#11;
   eaDC = "";
   |HAZ CalculoDC;
   #dscam003#10 = eaDC;
   |PINTA #dscam003#10;
|FPRC;

|RUTINA Inf212;
   #dscam212#0 = #dscam003#40;
   #dscam212#1 = 00001;
|FRUT;

|RUTINA Sup212;
   #dscam212#0 = #dscam003#40;
   #dscam212#1 = 99999;
|FRUT;

|PROCESO LinLiquidaciones;
   |PUSHV 1249 2380;

   |ABRE #dscam212;
   |ENTLINEAL #1#dscam212, -1, 4, 21, 1, Inf212, Sup212;
   |CIERRA #dscam212;

   |POPV;
|FPRC;

|PROCESO PintaTablas;
      |PUSHV 1324 2380;
      |CUADRO 1324 2380;
      |ATRI R; |BLANCO 1425 2379;
      |PINTA 1425,      " ACE Recibo aceptado por el cliente    ";
      |PINTA 1525,      " CAC Cobrado de una entrega a cuenta   ";
      |PINTA 1625,      " CFR Recepcion cobro confirmado        ";
      |PINTA 1725,      " COB Cobro normal                      ";
      |PINTA 1825,      " COP Cobro parcial                     ";
      |PINTA 1925,      " EMR Emision de remesa                 ";
      |PINTA 2025,      " ENV Recibo enviado al cliente         ";
      |PINTA 2125,      " FAP Perdida retenciones factoring     ";
      |PINTA 2225,      " FAR Recuperacion retenciones factoring";
      |PINTA 2325,      " IMA Impagado de remesa sin abonar     ";
      |ATRI N;
      |PAUSA;
      |ATRI R; |BLANCO 1425 2379;
      |PINTA 1425,      " IMP Impagado                          ";
      |PINTA 1525,      " PRA Pet.reclamacion documento no abon.";
      |PINTA 1625,      " PRC Peticion reclamacion de documento ";
      |PINTA 1725,      " PRE Recibo preparado para remesar     ";
      |PINTA 1825,      " RAC Recepcion entrega a cuenta        ";
      |PINTA 1925,      " RCB Cobro a traves de cobrador        ";
      |PINTA 2025,      " RCA Confirmacion reclamacion no abon. ";
      |PINTA 2125,      " RCE Confirmacion reclamacion          ";
      |PINTA 2225,      " RCF Recepcion confirming              ";
      |PINTA 2325,      " REC Compensacion entrega a cuenta     ";
      |ATRI N;
      |PAUSA;
      |ATRI R; |BLANCO 1425 2379;
      |PINTA 1425,      " REM Abono de remesa                   ";
      |PINTA 1525,      " RPT Recepcion Talon/Pagare de cliente ";
      |PINTA 1625,      " RTA Cobro al vto. de un pagare/talon  ";
      |PAUSA; |ERROR;
      |POPV;
|FPRC;

|PROCESO Tipo13m003; |TIPO 13;
   |SI #dscam003#83 ! 0;
      |C_V #dscam003#88, 1, "S"; |C_P #dscam003#88, 1, 0655;
   |SINO;
      |C_V #dscam003#88, 1, "N";
   |FINSI;
|FPRC;

|PROCESO ControlImporte;
   nModo = (FEntrada / 100) ! 0;
   |SI nModo ! 1; |ACABA; |FINSI;

   |SI #dscam003#30 ] 0;
      |SI #dscam004#8 > #dscam003#30; |MENAV "    Importe superado"; |ERROR; |FINSI;
   |SINO;
      |SI #dscam004#8 < #dscam003#30; |MENAV "    Importe superado"; |ERROR; |FINSI;
   |FINSI;
|FPRC;

|PROCESO CopiaFecha;
   |SI #dscam051#68 = "N"; #dscam003#99 = #dscam003#4; |FINSI;
|FPRC;

|PROCESO MiraFecha;
   |HAZ EsArtenvas;
   |SI FSalida = 0; |Y #dscam003#3 ! Contenido;
      |MENAV "    No se puede cambiar la fecha de vto. de un recibo dividido";
      |ERROR; |ACABA;
   |FINSI;

   |SI #dscam003#3 < #dscam003#4; |Y #dscam051#39 = "S";
      |MENAV "    La fecha de vto.nunca puede ser menor a la de emision";
      |ERROR; |ACABA;
   |FINSI;
|FPRC;

|PROCESO LRem;
   |SI #dscam013#6 ! #dscam003#3; |Y #dscam013#15 ! "S";
      |SI #dscam013#14 = "L"; |O #dscam013#14 = "R";
         #dscam013#6 = #dscam003#3; |GRABA 020#dscam013.a;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE LRem;
   #dscam013#2;
   ;
   #dscam003#40,001;
   #dscam003#40,999;
   be;
   NULL,LRem;
|FIN;

|PROCESO LRemCob;
   |SI #dscam017#6 ! #dscam003#3;
      #dscam017#6 = #dscam003#3; |GRABA 020#dscam017.a;
   |FINSI;
|FPRC;

|DEFBUCLE LRemCob;
   #dscam017#2;
   ;
   #dscam003#40;
   #dscam003#40;
   be;
   NULL,LRemCob;
|FIN;

|PROCESO Facturas;
   #agif134@#49 = #dscam003#0;
   #agif134@#0 = #dscam003#1;
   |LEE 000#agif134@.=;
   |PARA; |SI FSalida = 0; |Y #agif134@#49 = #dscam003#0; |Y #agif134@#0 = #dscam003#1; |HACIENDO;
      |SI #agif134@#1 = #dscam003#4; |SAL; |FINSI;
      |LEE 000#agif134@.s;
   |SIGUE;
   |SI #agif134@#1 ! #dscam003#4; |O #agif134@#49 ! #dscam003#0; |O #agif134@#0 ! #dscam003#1;
      #agif084@#48 = #dscam003#0;
      #agif084@#0 = #dscam003#1;
      |LEE 000#agif084@.=;
      |PARA; |SI FSalida = 0; |Y #agif084@#48 = #dscam003#0; |Y #agif084@#0 = #dscam003#1; |HACIENDO;
         |SI #agif084@#1 = #dscam003#4; |SAL; |FINSI;
         |LEE 000#agif084@.s;
      |SIGUE;
      |SI #agif084@#1 ! #dscam003#4; |O #agif084@#48 ! #dscam003#0; |O #agif084@#0 ! #dscam003#1;
         |ACABA;
      |FINSI;
   |FINSI;

   |SI #dscam003#3 ! #agif133@#3;
      #agif133@#3 = #dscam003#3; |GRABA 020#agif133@.a;
   |FINSI;
|FPRC;

|DEFBUCLE Facturas;
#agif133@#1003;
;
#dscam003#0,#dscam003#1,#dscam003#2;
#dscam003#0,#dscam003#1,#dscam003#2;
be;
NULL,Facturas;
|FIN;

|PROCESO Control;
   #dscam044#0 = #dscam045#0;
   |LEE 000#dscam044.=;
   |SI FSalida = 0;
      aAlfa = #dscam044#1; |QBF aAlfa;
      aAlfa1 = aAlfa + "def/agifa133.mas";
      |CARGA_DEF aAlfa1, agif133@;
      |SI FSalida ! 0;
         |MENAV "    Fallo al cargar el def de vencimientos";
         |ERROR; |ACABA;
      |FINSI;
      aAlfa1 = aAlfa + "def/agifa134.mas"; |CARGA_DEF aAlfa1, agif134@;
      aAlfa1 = aAlfa + "def/agifa084.mas"; |CARGA_DEF aAlfa1, agif084@;
      aAlfa1 = aAlfa + "fich/" + (("00000" + #dscam044#0) % -105) + "/";
      |PATH_DAT #agif133@#aAlfa1#; |ABRE #agif133@;
      |PATH_DAT #agif134@#aAlfa1#; |ABRE #agif134@;
      |PATH_DAT #agif084@#aAlfa1#; |ABRE #agif084@;
      |BUCLE LRem; |BUCLE LRemCob; |BUCLE Facturas;
      |CIERRA #agif084@; |DESCARGA_DEF #agif084@;
      |CIERRA #agif134@; |DESCARGA_DEF #agif134@;
      |CIERRA #agif133@; |DESCARGA_DEF #agif133@;
   |FINSI;
|FPRC;

|DEFBUCLE Control;
#dscam045#1;
2,6;
00001,001,"V",nEmpresa;
99999,999,"V",nEmpresa;
;
NULL,Control;
|FIN;

|PROCESO CambiaVto;
   |HAZ EsArtenvas;
   |SI FSalida = 0; |ACABA; |FINSI;

   |SI #dscam003#23 ! 0; |O #dscam003#31 ! #dscam003#30;
      |MENAV "    No se puede cambiar el vencimiento de un recibo con movimientos";
      #dscam003#3 = fAntVto; |PINTA #dscam003#3;
      |GRABA 020#dscam003.a;
      |ACABA;
   |FINSI;

   |HAZ EsArtenvas;
   |SI FSalida = 0;
      |ABRE #dscam215; |SELECT #3#dscam215;
      |DDEFECTO #dscam215;
      #dscam215#4 = #dscam003#32;
      |LEE 000#dscam215.];
      |PARA; |SI FSalida = 0; |Y #dscam215#4 = #dscam003#32; |HACIENDO;
         nCalc1 = #dscam003#3; nCalc = #dscam003#4;
         nCalc = nCalc1 - nCalc;
         |SI nCalc > #dscam215#20;
            |MENAV "    Superado plazo máximo compañía"; |SAL;
         |FINSI;

         |LEE 000#dscam215.s;
      |SIGUE;
      |SELECT #1#dscam215; |CIERRA #dscam215;
   |FINSI;

   |CONFI "    NEsta seguro de cambiar el vencimiento ? ";
   |SI FSalida = 0; |Y #dscam003#23 = 0; |Y #dscam003#31 = #dscam003#30;
      nEmpresa = #48#0;
      |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "fich/";
      |PATH_DAT #dscam044#aAlfa#; |PATH_DAT #dscam045#aAlfa#;
      |ABRE #dscam044; |ABRE #dscam045;
      |BUCLE Control;
      |CIERRA #dscam045; |CIERRA #dscam044;
   |SINO;
      #dscam003#3 = fAntVto; |PINTA #dscam003#3;
   |FINSI;
|FPRC;

|PROCESO GrabaTemporal;
   #dscaw205#0 = #dscam164#0;
   #dscaw205#1 = #dscam164#1;
   #dscaw205#2 = #dscam164#2;
   #dscaw205#3 = #dscam164#3;
   #dscaw205#4 = #dscam164#4;
   #dscaw205#5 = #dscam164#5;
   #dscaw205#6 = #dscam164#6;
   #dscaw205#7 = #dscam164#7;
   #dscaw205#8 = nLinea; nLinea = nLinea + 1;
   |GRABA 020#dscaw205.n;
|FPRC;

|DEFBUCLE GrabaTemporal;
#dscam164#1;
;
INICIO;
FINAL;
;
NULL, GrabaTemporal;
|FIN;

|RUTINA infw205;
   #dscaw205#0 = #dscam003#40;
   #dscaw205#1 = "01.01.0000";
   #dscaw205#2 = "        ";
|FRUT;

|RUTINA supw205;
   #dscaw205#0 = #dscam003#40;
   #dscaw205#1 = "31.12.9999";
   #dscaw205#2 = "zzzzzzzz";
|FRUT;

|PROCESO VerSituaciones; |TIPO 11;
  |SI FSalida = 10;
      enCuadroIni  = 1401;
      enCuadroFin  = 2261;
      eaTitulo     = " Observaciones al cambio de situacion        ";
      || aAlfa = "dscaz030.tab;" + (("0000000000" + #dscam003#40) % -110) + "/" + #dscaw205#8;
      aAlfa = "dscaz200.tab;" + (("0000000000" + #dscaw205#0) % -110) + "/" + #dscaw205#1 + "/" + #dscaw205#2;
      |SUB_EJECUTA aAlfa;

      |ERROR;
  |FINSI;
|FPRC;

|PROCESO HistCambioSit;
   |ABRE #dscam164;
   aAlfa = "SELECT * FROM dscam164 INTO hs" + Usuario + " WHERE 0 == " + #dscam003#40;
   |SQL aAlfa;
   |SI FSalida = 0;
      aAlfa = "tmp" + Usuario; |NOME_DAT #dscaw205#aAlfa#;
      |DELINDEX #dscaw205; |ABRE #dscaw205;
      |CIERRA #dscam164;

      aAlfa = "hs" + Usuario;
      |NOME_DAT #dscam164#aAlfa#; |ABRE #dscam164;

      nLinea = 501;
      |BUCLE GrabaTemporal;

      |PUSHV 0501 2380;
      |ENTLINEAL #1#dscaw205, 3, 4, 21, 1, infw205, supw205;
      |POPV;

      |CIERRA #dscaw205; |DELINDEX #dscaw205;
   |FINSI;
   |CIERRA #dscam164;
   aAlfa = "dscam164"; |NOME_DAT #dscam164#aAlfa#;
|FPRC;

|PROCESO VtoOriginal;
   |ABRE #dscam221;

   |HAZ EsArtenvas;
   |SI FSalida = 0;
      |PUSHV 0501 2380;
      #dscam221#0 = #dscam003#40;
      |LEE 000#dscam221.=;
      |SI FSalida ! 0;
         #dscaw219#0 = #dscam003#3;
          |SI #dscam003#70 = "          "; |Y #dscam003#72 = "    ";
             #dscaw219#1 = #dscam003#3;
          |SINO;
             #dscaw219#1 = #dscam003#71;
         |FINSI;
      |SINO;
         #dscaw219#0 = #dscam221#1;
         |SI #dscam003#70 = "          "; |Y #dscam003#72 = "    ";
              #dscaw219#1 = #dscam221#3;
           |SINO;
            #dscaw219#1 = #dscam003#71;
         |FINSI;
      |FINSI;
      |PINPA #0#dscaw219; |PINDA #0#dscaw219;
      |PAUSA;
      |POPV;
      |ACABA;
   |FINSI;

   #dscam221#0 = #dscam003#40;
   |LEE 000#dscam221.=;
   |SI FSalida = 0;
      |PUSHV 0501 2380;
      #dscaw219#0 = #dscam221#1;
      #dscaw219#1 = #dscam221#3;
      |PINPA #0#dscaw219; |PINDA #0#dscaw219;
      |PAUSA;
      |POPV;
   |FINSI;
   |CIERRA #dscam221;
|FPRC;

|PROCESO Liquidaciones;
   #gestr150@#0 = #gestr149@#0;
   #gestr150@#1 = #gestr149@#1;
   #gestr150@#2 = #gestr149@#2;
   #gestr150@#3 = 1;
   |LEE 000#gestr150@.];
   |PARA; |SI FSalida = 0; |Y #gestr150@#0 = #gestr149@#0; |Y #gestr150@#1 = #gestr149@#1;
     |Y #gestr150@#2 = #gestr149@#2; |HACIENDO;
      |SI #gestr150@#4 = "V"; |Y #gestr150@#6 = #dscam003#40; |SAL; |FINSI;
      |LEE 000#gestr150@.s;
   |SIGUE;
   |SI FSalida = 0; |Y #gestr150@#0 = #gestr149@#0; |Y #gestr150@#1 = #gestr149@#1;
     |Y #gestr150@#2 = #gestr149@#2; |Y #gestr150@#4 = "V"; |Y #gestr150@#6 = #dscam003#40;
        |ERROR10;
   |FINSI;
|FPRC;

|DEFBUCLE Liquidaciones;
#gestr149@#2003;
;
nEmpr, " ", 000000000;
nEmpr, "z", 999999999;
;
NULL, Liquidaciones;
|FIN;

|PROCESO ConsAstoViuda;
   enSwErr = 0;
   |DBASS aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "gesenvia/def/gestr168.mas";
   |CARGA_DEF aAlfa, gestr168@;
   |SI FSalida = 0;
      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "gesenvia/def/gestr149.mas";
      |CARGA_DEF aAlfa, gestr149@;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "gesenvia/def/gestr150.mas";
      |CARGA_DEF aAlfa, gestr150@;

      aAlfa = #48#16; |QBF aAlfa;
      aAlfa = aAlfa + "def/canempre.mas";
      |CARGA_DEF aAlfa, canempre@;

      aAlfa = #48#16; |QBF aAlfa;
      aAlfa = aAlfa + "fich/"; |PATH_DAT #canempre@#aAlfa#;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "gesenvia/fich/" + (("00000" + #48#15) % -105) + "/";
      |PATH_DAT #gestr149@#aAlfa#; |PATH_DAT #gestr150@#aAlfa#;
      |PATH_DAT #gestr168@#aAlfa#;

      nEmpr = #48#0; |ABRE #gestr150@;
      |BUCLE Liquidaciones;
      |CIERRA #gestr150@;

      |ABRE #canempre@; |ABRE #gestr168@;

      aAlfa = #gestr149@#6; |QBF aAlfa;
      aAlfa = aAlfa % -104; nAnyo = aAlfa;
      nPeriodo = -1;
      #canempre@#2 = #gestr149@#4;
      #canempre@#3 = 0;
      |LEE 000#canempre@.];
      |PARA; |SI FSalida = 0; |Y #canempre@#2 = #gestr149@#4; |HACIENDO;
         nCalc = #canempre@#26;
         |SI nCalc > 80;
            nCalc = nCalc + 1900;
         |SINO;
            nCalc = nCalc + 2000;
         |FINSI;
         |SI nCalc = nAnyo;
            nPeriodo = #canempre@#3; |SAL;
         |FINSI;
         |LEE 000#canempre@.s;
      |SIGUE;

      |SI nPeriodo ! -1;
         #gestr168@#0 = "L";
         #gestr168@#1 = #gestr149@#0;
         #gestr168@#2 = #gestr149@#1;
         #gestr168@#3 = #gestr149@#2;
         #gestr168@#7 = #gestr149@#4;
         #gestr168@#8 = nPeriodo;
         |LEE 000#gestr168@.=;
         |SI FSalida = 0;
            #dscam067#4 = #gestr168@#4;
            #dscam067#5 = #gestr168@#5;
            #dscam067#6 = #gestr168@#6;
            #dscam067#8 = #gestr168@#7;
            #dscam067#9 = #gestr168@#8;
         |SINO;
            enSwErr = -1;
         |FINSI;
      |SINO;
         enSwErr = -1;
      |FINSI;
      |CIERRA #canempre@; |DESCARGA_DEF #canempre@;
      |CIERRA #gestr150@; |DESCARGA_DEF #gestr150@;
      |CIERRA #gestr149@; |DESCARGA_DEF #gestr149@;
      |CIERRA #gestr168@; |DESCARGA_DEF #gestr168@;
   |SINO;
      enSwErr = -1;
   |FINSI;
|FPRC;

|PROCESO ActualizaLineas;
   |DDEFECTO #dscam067;
   aClv1 = "CB";
   aClv2 = #dscam004#17; aClv2 = (aClv2 + (" " * 50))% 0150;
   aClv3 = #dscam004#3;  aClv3 = (aClv3 + (" " * 50))% 0150;
   aClv4 = "";           aClv4 = (aClv4 + (" " * 50))% 0150;
   |SI #dscam004#5 = "REM";
      |ABRE #dscam013; |SELECT #2#dscam013;
      #dscam013#16 = #dscam004#17;
      #dscam013#17 = #dscam004#3;
      |LEE 000#dscam013.=;
      |SI FSalida ! 0; |CIERRA #dscam013; |ACABA; |FINSI;
      |CIERRA #dscam013;

      aClv1 = "RM";
      aClv2 = #dscam013#0; aClv2 = (aClv2 + (" " * 50))% 0150;
      aClv3 = #dscam013#1; aClv3 = (aClv3 + (" " * 50))% 0150;
      aClv4 = "E"; aClv4 = (aClv4 + (" " * 50))% 0150;
      #dscam067#0 = aClv1;
      #dscam067#1 = aClv2;
      #dscam067#2 = aClv3;
      #dscam067#3 = aClv4;
      |LEE 000#dscam067.];
      |SI FSalida ! 0; |O #dscam067#0 ! aClv1;  |O #dscam067#1 ! aClv2;
       |O #dscam067#2 ! aClv3;  |O #dscam067#3 ! aClv4;
         aClv1 = "RM";
         aClv2 = #dscam013#0; aClv2 = (aClv2 + (" " * 50))% 0150;
         aClv3 = #dscam013#1; aClv3 = (aClv3 + (" " * 50))% 0150;
         aClv4 = "V"; aClv4 = (aClv4 + (" " * 50))% 0150;
      |FINSI;
   |FINSI;
   |SI #dscam004#5 = "EMR";
      |ABRE #dscam013; |SELECT #4#dscam013;
      #dscam013#16 = #dscam004#17;
      #dscam013#24 = #dscam004#3;
      |LEE 000#dscam013.=;
      |SI FSalida ! 0; |CIERRA #dscam013; |ACABA; |FINSI;
      |CIERRA #dscam013;
      aClv1 = "RM";
      aClv2 = #dscam013#0; aClv2 = (aClv2 + (" " * 50))% 0150;
      aClv3 = #dscam013#1; aClv3 = (aClv3 + (" " * 50))% 0150;
      aClv4 = "I"; aClv4 = (aClv4 + (" " * 50))% 0150;
   |FINSI;
   |SI #dscam004#5 = "REC";
      aClv1 = "CB";
      aClv2 = #dscam004#16; |QBF aClv2; aClv2 = aClv2 % -109;
      aMovOrig = ("000000000" + #dscam004#17) % -109;
      |SALVA_FICHA #dscam004;
      #dscam004#17 = aClv2; aClv2 = #dscam004#17;
      #dscam004#3  = 1;
      |LEE 000#dscam004.];
      |PARA; |SI FSalida = 0; |Y #dscam004#17 = aClv2; |HACIENDO;
         |SI #dscam004#5 = "CAC";
            aAlfa = #dscam004#16; |QBF aAlfa;
            aAlfa = aAlfa - aMovOrig;
            |SI FSalida ! 0;
               aClv3 = #dscam004#3; |SAL;
            |FINSI;
         |FINSI;
         |LEE 000#dscam004.s;
      |SIGUE;
      |REPON_FICHA #dscam004;
      aClv4 = " " * 50;
   |FINSI;
   nCalc5 = aClv2; aClv2 = nCalc5;
   aClv2 = (aClv2 + (" " * 50)) % 0150;
   aClv3 = (aClv3 + (" " * 50)) % 0150;
   #dscam067#0 = aClv1;
   #dscam067#1 = aClv2;
   #dscam067#2 = aClv3;
   #dscam067#3 = aClv4;
   |LEE 000#dscam067.];
   |SI FSalida = 0; |Y #dscam067#0 = aClv1;  |Y #dscam067#1 = aClv2;
    |Y #dscam067#2 = aClv3;  |Y #dscam067#3 = aClv4;
      #dscam004#18 = "S"; |GRABA 020#dscam004.a;
   |FINSI;
|FPRC;

|DEFBUCLE ActualizaLineas;
#dscam004#1;
;
#dscam003#40, 01;
#dscam003#40, 99;
be;
NULL, ActualizaLineas;
|FIN;

|PROCESO Tipo5; |TIPO 5;
    ||Actualiza el campo 'Contabilizado' del lineal de movimientos
    |SALVA_FICHA #dscam004;
    |ABRE #dscam067;
    |BUCLE ActualizaLineas;
    |CIERRA #dscam067;

    #dscam004#18 = "N";
    |LINEAS_BI_ATRI #dscam004#18,D,S,-1;

    |REPON_FICHA #dscam004;
|FPRC;

|PROCESO BorraAnotacion;
   |BORRA 020#dscam075.a;
|FPRC;

|DEFBUCLE BorraAnota;
#dscam075#1;
;
"V",#dscam004#17,#dscam004#3,01;
"V",#dscam004#17,#dscam004#3,99;
be;
NULL,BorraAnotacion;
|FIN;

|PROCESO BorraAnota;
   |BUCLE BorraAnota;
|FPRC;

|PROCESO AntesMov; |TIPO 7;
   nModo = (FEntrada / 100) ! 0;
   |SI nModo = 1;
      |SI #dscam003#14 = "A";
         |MENAV "    Recibo Agrupado. No se puede rectificar.";
         |PTEC 807;
      |FINSI;
      |SI #dscam003#14 = "D";
         |MENAV "    Recibo Dividido. No se puede rectificar.";
         |PTEC 807;
      |FINSI;
      |SI #dscam003#14 = "R";
         |MENAV "    Se espera el movimiento de abono de remesa. No se pueden introducir movtos.manualmente.";
         |PTEC 807;
      |FINSI;
      |SI #dscam003#14 = "T";
         |MENAV "    Se espera el movimiento de emision de remesa. No se pueden introducir movtos.manualmente.";
         |PTEC 807;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO BorraLFact;
   |BORRA 020#agif069@.a;
|FPRC;

|DEFBUCLE BorraLFact;
#agif069@#1003;
;
eaSerie,enFactura,001;
eaSerie,enFactura,999;
be;
NULL,BorraLFact;
|FIN;

|PROCESO BorraFact;
   |BUCLE BorraLFact;

   #agif024@#0 = #agif084@#3;
   |LEE 000#agif024@.=;
   |SI FSalida = 0;
      aAlfa = #agif084@#1; |QBF aAlfa;
      aAlfa = aAlfa % 0402;
      nCalc = aAlfa; nCalc = 50 + (nCalc * 4);
      #agif024@#nCalc# = #agif024@#nCalc# - #agif084@#73;
      |GRABA 020#agif024@.a;
   |FINSI;

   |BORRA 020#agif084@.a;
|FPRC;

|DEFBUCLE BorraFact;
#agif084@#1002;
;
eaSerie,enFactura;
eaSerie,enFactura;
be;
NULL,BorraFact;
|FIN;

|PROCESO BucleControl;
   #dscam044#0 = #dscam045#0;
   |LEE 000#dscam044.=;
   |SI FSalida = 0;
      aAlfa = #dscam044#1; |QBF aAlfa;
      aAlfa1 = aAlfa + "def/agifa084.mas";
      |CARGA_DEF aAlfa1, agif084@;
      |SI FSalida ! 0;
         |MENAV "    Fallo al cargar el def de facturas directas";
         |ERROR; |ACABA;
      |FINSI;
      aAlfa1 = aAlfa + "def/agifa069.mas"; |CARGA_DEF aAlfa1, agif069@;
      aAlfa1 = aAlfa + "fich/" + (("00000" + #dscam044#0) % -105) + "/";
      |PATH_DAT #agif084@#aAlfa1#; |ABRE #agif084@;
      |PATH_DAT #agif069@#aAlfa1#; |ABRE #agif069@;
      |BUCLE BorraFact;
      |CIERRA #agif069@; |DESCARGA_DEF #agif069@;
      |CIERRA #agif084@; |DESCARGA_DEF #agif084@;
   |FINSI;
|FPRC;

|DEFBUCLE BucleControl;
#dscam045#2;
2;
nEmpresa,"V";
nEmpresa,"V";
;
NULL,BucleControl;
|FIN;

|PROCESO BorraFactura;
   nEmpresa = #48#0;
   |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "fich/";
   |PATH_DAT #dscam044#aAlfa#; |PATH_DAT #dscam045#aAlfa#;
   |ABRE #dscam044; |ABRE #dscam045;
   |BUCLE BucleControl;
   |CIERRA #dscam045; |CIERRA #dscam044;
|FPRC;

|PROCESO GrabaRec;
   |DDEFECTO #dscam025;
   #dscam025#0 = nLinea;  nLinea = nLinea + 1;
   #dscam025#1 = #dscam003#40;
   #dscam025#2 = #dscam003#31;
   #dscam025#3 = #dscam003#3;
   |GRABA 020#dscam025.n;
|FPRC;

|DEFBUCLE Agrupados;
#dscam003#1;
41;
000000001,enDocumento;
999999999,enDocumento;
;
NULL,GrabaRec;
|FIN;

|DEFBUCLE Divididos;
#dscam003#1;
83;
000000001,enDocumento;
999999999,enDocumento;
;
NULL,GrabaRec;
|FIN;

|PROCESO BucleAgrupados;
   nLinea = 1;

   |DELINDEX #dscam025; |ABRE #dscam025;
   |BUCLE Agrupados;
   |CIERRA #dscam025;
|FPRC;

|PROCESO BucleDivididos;
   nLinea = 1;

   |DELINDEX #dscam025; |ABRE #dscam025;
   |BUCLE Divididos;
   |CIERRA #dscam025;
|FPRC;

|PROCESO BorraLin1;
   |BORRA 020#dscam004.a;
|FPRC;

|DEFBUCLE BorraLin1;
#dscam004#1;
;
#dscam003#40,001;
#dscam003#40,999;
be;
NULL,BorraLin1;
|FIN;

|PROCESO Eliminacion;
   |SI FSalida = 27;
      eaUsuario = Usuario % 0810;
      eaTipoReg = "CB";  eaNumero = ("000000000" + #dscam003#40) % -109;
      eaDescr   = "ELIMINACION REC.VENTA (" + (("000000000" + #dscam003#40) % -109);
      eaDescr   = eaDescr + ") DESDE MANTENIMIENTO DE RECIBOS";
      eaTipoOp  = "B"; enImpAnt = #dscam003#30; enImpAct = #dscam003#30;
      eaFicher = "dscam003"; eaClave = #dscam003#40;
      |HAZ GrabaAudit; |BUCLE BorraLin1;
      |BORRA 020#dscam003.a; |DDEFECTO #dscam003;
   |FINSI;
|FPRC;

|PROCESO InciOTP;
     aAlfa = "    N" + &191 + " Eliminar la incidencia ?";
     |CONFI aAlfa;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |DBASS aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "dspreven/def/visalm00.mas";
     |CARGA_DEF aAlfa, visalm00@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |DBASS aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "dspreven/fich/"; |PATH_DAT #visalm00@#aAlfa#;

     |ABRE #visalm00@;
     |LEE 000#visalm00@.p;
     |PARA; |SI FSalida = 0; |HACIENDO;
            |SI #visalm00@#3 = "S"; |SAL; |FINSI;
            |LEE 000#visalm00@.s;
     |SIGUE;
     |CIERRA #visalm00@;

     |SI #visalm00@#3 = "N";
         |DESCARGA_DEF #visalm00@;
         |ACABA;
     |FINSI;

     |DBASS aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "dspreven/def/dspvm002.mas";
     |CARGA_DEF aAlfa, dspvm002@;

     |DBASS aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "dspreven/def/maesm011.mas";
     |CARGA_DEF aAlfa, maesm011@;

     |DBASS aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "dspreven/fich/"; |PATH_DAT #maesm011@#aAlfa#;
     aAlfa = aAlfa + (("00000" + #visalm00@#0) % -105) + "/";
     |PATH_DAT #dspvm002@#aAlfa#;

     |ABRE #dspvm002@;
     |SELECT #2#dspvm002@;
     |LEE 000#dspvm002@.p;

     nSwCerrada = -1;
     #dspvm002@#8 = #dscam003#32;
     |LEE 000#dspvm002@.];
     |PARA; |SI FSalida = 0; |Y #dspvm002@#8 = #dscam003#32; |HACIENDO;
          |SI #dspvm002@#129 = #dscam003#0; |Y #dspvm002@#130 = #dscam003#1;
           |Y #dspvm002@#131 = #dscam003#2;
              |SI #dspvm002@#1   = "A";
                  nSwCerrada = -1; |SAL;
              |SINO;
                  nSwCerrada = #dspvm002@#0;
              |FINSI;
          |FINSI;

          |LEE 000#dspvm002@.s;
     |SIGUE;

     |SI #dspvm002@#8 ! #dscam003#32; |O FSalida ! 0;
         #dspvm002@#0 = -1;
     |FINSI;

     |SELECT #1#dspvm002@;
     |SI nSwCerrada ] 0;
         |MENAV "    La incidencia no se cambiara porque esta cerrada.";
     |FINSI;

     |LEE 101#dspvm002@.=;
     |SI FSalida = 0;
         |SI #dspvm002@#121 = "S"; |Y #dspvm002@#129 = #dscam003#0;
          |Y #dspvm002@#130 = #dscam003#1; |Y #dspvm002@#131 = #dscam003#2;
          |Y #dspvm002@#1 ! "C";
             |SI #dspvm002@#23 = "S"; |O #dspvm002@#71 = "S";
                 #dspvm002@#121 = "N";
                 #dspvm002@#122 = "01.01.0000";
                 |PARA nCont = 123; |SI nCont [ 171; |HACIENDO nCont = nCont + 1;
                       |SI nCont = 130; |O nCont = 131;
                           #dspvm002@#nCont# = 0;
                       |SINO;
                           #dspvm002@#nCont# = "";
                       |FINSI;
                 |SIGUE;

                 #dspvm002@#201 = "N";
                 |GRABA 020#dspvm002@.a;
              |SINO;
                 |BORRA 020#dspvm002@.a;
              |FINSI;
         |FINSI;
         |LIBERA #dspvm002@;
     |FINSI;
     |SELECT #1#dspvm002@;

     |CIERRA #maesm011@;  |DESCARGA_DEF #maesm011@;
     |CIERRA #dspvm002@;  |DESCARGA_DEF #dspvm002@;
                          |DESCARGA_DEF #visalm00@;
|FPRC;

|PROCESO Recl;
   |SI #dscam003#14 = "A"; |O #dscam003#14 = "D"; |O #dscam003#14 = "V"; |ACABA; |FINSI;

   #dscam004#17 = #dscam003#40;
   #dscam004#3 = 99;
   |LEE 000#dscam004.];
   |SI FSalida = 0;
      |SI #dscam004#17 = #dscam003#40;
         |PARA; |SI FSalida = 0; |Y #dscam004#5 ! "RCE"; |Y #dscam004#5 ! "RCA"; |Y #dscam004#5 ! "IMP";
          |Y #dscam004#5 ! "IMA"; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
            |LEE 000#dscam004.a;
         |SIGUE;
      |SINO;
         |LEE 000#dscam004.a;
         |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
            |PARA; |SI FSalida = 0; |Y #dscam004#5 ! "RCE"; |Y #dscam004#5 ! "RCA"; |Y #dscam004#5 ! "IMP"; |Y #dscam004#5 ! "IMA";
             |Y #dscam004#17 = #dscam003#40; |HACIENDO;
               |LEE 000#dscam004.a;
            |SIGUE;
         |FINSI;
      |FINSI;
   |SINO;
      |LEE 000#dscam004.u;
      |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
         |PARA; |SI FSalida = 0; |Y #dscam004#5 ! "RCE"; |Y #dscam004#5 ! "RCA"; |Y #dscam004#5 ! "IMP"; |Y #dscam004#5 ! "IMA";
          |Y #dscam004#17 = #dscam003#40; |HACIENDO;
            |LEE 000#dscam004.a;
         |SIGUE;
      |FINSI;
   |FINSI;

   |SI #dscam004#17 = #dscam003#40;
      |SI #dscam004#5 = "RCE"; |O #dscam004#5 = "RCA"; |O #dscam004#5 = "IMP"; |O #dscam004#5 = "IMA";
         |SI #dscam004#5 = "IMP"; |O #dscam004#5 = "IMA"; #dscam003#16  = #dscam003#16 - 1; |FINSI;
         aOperac = #dscam004#5;
         |SI #dscam003#47 = "S"; |O #dscam003#69 ! " ";
            #dscam003#23 = #dscam003#23 + #dscam004#8;  #dscam003#61 = #dscam003#61 + (#dscam004#26 - #dscam004#24);
         |SINO;
            #dscam003#23 = #dscam003#23 + #dscam004#9;  #dscam003#61 = #dscam003#61 + (#dscam004#27 - #dscam004#24);
         |FINSI;
         #dscam003#24 = #dscam003#24 - #dscam004#12; #dscam003#62 = #dscam003#62 - #dscam004#29;
         #dscam003#25 = #dscam003#25 - #dscam004#13; #dscam003#63 = #dscam003#63 - #dscam004#30;
         #dscam003#38 = #dscam003#38 - #dscam004#14; #dscam003#66 = #dscam003#66 - #dscam004#31;
         #dscam003#56 = #dscam003#56 - #dscam004#24;

         nRemesa = 0; nNumLin = 0;
         |ABRE #dscam013; |SELECT #4#dscam013;
         #dscam013#16 = #dscam004#17;
         #dscam013#24 = 1;
         |LEE 000#dscam013.];
         |PARA; |SI FSalida = 0; |Y #dscam013#16 = #dscam004#17; |HACIENDO;
            nRemesa = #dscam013#0; nNumLin  = #dscam013#1;
            |LEE 000#dscam013.s;
         |SIGUE;
         |SELECT #1#dscam013;
         #dscam013#0 = nRemesa;
         #dscam013#1 = nNumLin;
         |LEE 101#dscam013.=;
         |SI FSalida = 0;
            |SI #dscam013#15 = "S"; #dscam003#84 = "S"; |FINSI;
            |SI aOperac = "RCE"; |O aOperac = "RCA";
               |SI ModoEntrada = 3; #dscam003#98 = "S"; |FINSI;
               |SI #dscam013#15 = "R";
                  #dscam013#15 = "N"; |GRABA 020#dscam013.a;
               |FINSI;
            |FINSI;
            |LIBERA #dscam013;
         |FINSI;
         |CIERRA #dscam013;

         |ABRE #dscam012;
         #dscam012#0 = nRemesa;
         |LEE 000#dscam012.=;
         |SI FSalida ! 0; |DDEFECTO #dscam012; |FINSI;
         |CIERRA #dscam012;

         |SI ModoEntrada = 2; |Y Flag > 0;
            eaFicher = "dscam003"; eaClave = #dscam003#40;
            enImpAct  = #dscam003#23; |HAZ GrabaAudit;
         |FINSI;
         || enEmpCartera = #48#0; enEmpGestion = #dscam003#46;
         enEmpCartera = -1;     enEmpGestion = #dscam003#46;
         eaSerie = #dscam003#0; eaCliGest = #dscam003#32;
         |SI ModoEntrada = 3;
            #dscam003#100 = "N";
            |SI #dscam003#84 = "N";
               |SI #dscam012#22 ! 1; |Y #dscam012#22 ! 3;
                  |SI #dscam004#5 = "IMP"; nImporte = #dscam004#27; eaTipoOper = "+6"; |FINSI;
                  |SI #dscam004#5 = "IMA"; nImporte = #dscam003#30; eaTipoOper = "+4"; |FINSI;
                  |SI #dscam004#5 ! "RCA";
                     |HAZ BucleRiesgo;
                  |FINSI;
               |FINSI;
               |SI #dscam004#5 ! "RCA";
                  nImporte = #dscam004#27 + #dscam004#29 + #dscam004#30 + #dscam004#31 + #dscam004#32;
                  eaTipoOper = "-7"; |HAZ BucleRiesgo;
               |FINSI;

               |HAZ EsOTP;
               |SI FSalida = 0;
                   |HAZ InciOTP;
               |FINSI;
            |SINO;
               |SI #dscam004#5 ! "RCA";
                  nImporte = #dscam004#27 + #dscam004#29 + #dscam004#30 + #dscam004#31 + #dscam004#32;
                  eaTipoOper = "-4+6"; |HAZ BucleRiesgo;
               |FINSI;
            |FINSI;
         |FINSI;
         |SI ModoEntrada = 2;
            |SI Flag < 0;
               |SI #dscam003#84 = "N";
                  |SI #dscam012#22 ! 1; |Y #dscam012#22 ! 3;
                     |SI #dscam004#5 = "IMP"; nImporte = #dscam004#27; eaTipoOper = "+6"; |FINSI;
                     |SI #dscam004#5 = "IMA"; nImporte = #dscam004#27; eaTipoOper = "+4"; |FINSI;
                     |SI #dscam004#5 ! "RCA";
                        |HAZ BucleRiesgo;
                     |FINSI;
                  |FINSI;
                  |SI #dscam004#5 ! "RCA";
                     nImporte = #dscam004#27 + #dscam004#29 + #dscam004#30 + #dscam004#31 + #dscam004#32;
                     eaTipoOper = "-7"; |HAZ BucleRiesgo;
                  |FINSI;
               |SINO;
                  |SI #dscam004#5 ! "RCA";
                     nImporte = #dscam004#27 + #dscam004#29 + #dscam004#30 + #dscam004#31 + #dscam004#32;
                     eaTipoOper = "-4+6"; |HAZ BucleRiesgo;
                  |FINSI;
               |FINSI;
            |SINO;
               |SI #dscam003#84 = "N";
                  |HAZ EsArimesa;
                  |SI FSalida ! 0;
                     |SI #dscam012#22 ! 1; |Y #dscam012#22 ! 3;
                        nImporte = #dscam004#27;
                        |SI #dscam004#5 = "IMA"; eaTipoOper = "-4"; |SINO; eaTipoOper = "-6"; |FINSI;
                        |SI #dscam004#5 ! "RCA";
                           |HAZ BucleRiesgo;
                        |FINSI;
                     |FINSI;
                  |FINSI;

                  |SI #dscam004#5 ! "RCA";
                     nImporte = #dscam004#27 + #dscam004#29 + #dscam004#30 + #dscam004#31 + #dscam004#32;
                     eaTipoOper = "+7"; |HAZ BucleRiesgo;
                  |FINSI;
               |SINO;
                  |SI #dscam004#5 ! "RCA";
                     nImporte = #dscam004#27 + #dscam004#29 + #dscam004#30 + #dscam004#31 + #dscam004#32;
                     |SI #dscam012#22 ! 1; |Y #dscam012#22 ! 3;
                        eaTipoOper = "+4-6"; |HAZ BucleRiesgo;
                     |SINO;
                        eaTipoOper = "+4"; |HAZ BucleRiesgo;
                     |FINSI;
                  |FINSI;
               |FINSI;
            |FINSI;
         |FINSI;

         #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
         #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
         #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
         #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);

         #dscam003#31 = #dscam003#30 - #dscam003#23;  #dscam003#65 = #dscam003#64 - #dscam003#61;

         |SI #dscam003#69 ! " "; |O #dscam003#47 = "S";
            |SI #dscam003#23 = 0;
               #dscam003#14 = "L";
               #dscam003#15 = "Recibo Compensado";
            |SINO;
               |SI #dscam003#23 = #dscam003#22;
                  #dscam003#14 = "e";
                  #dscam003#15 = "Pendiente de compensar";
               |SINO;
                  #dscam003#14 = "E";
                  #dscam003#15 = "Compensado parcialmente";
               |FINSI;
            |FINSI;
         |SINO;
            |SI #dscam003#31 = 0;
               #dscam003#14 = "L";
               #dscam003#15 = "Recibo Liquidado";
            |SINO;
               |SI #dscam003#23 = 0;
                  |SI #dscam003#70 = "          ";
                     |SI #dscam003#16 = 0; |Y #dscam004#5 ! "IMP"; |Y #dscam004#5 ! "IMA";
                        #dscam003#14 = "P";
                        #dscam003#15 = "Pendiente de cobro";
                     |SINO;
                        #dscam003#14 = "I";
                        #dscam003#15 = "Impagado";
                     |FINSI;
                  |SINO;
                     |SI #dscam003#16 = 0; |Y #dscam004#5 ! "IMP";
                        #dscam003#14 = "T";
                        #dscam003#15 = "Pagare/Talon de cliente";
                     |SINO;
                        #dscam003#14 = "I";
                        #dscam003#15 = "Impagado";
                     |FINSI;
                  |FINSI;
               |SINO;
                  #dscam003#14 = "C";
                  #dscam003#15 = "Parcialmente cobrado";
               |FINSI;
            |FINSI;
         |FINSI;
         |GRABA 020#dscam003.a; |BORRA 020#dscam004.a;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Recl;
#dscam003#7;
;
eaEntPag, eaNumPag, 000000001;
eaEntPag, eaNumPag, 999999999;
be;
NULL,Recl;
|FIN;

|PROCESO PetRecl;
   #dscam004#17 = #dscam003#40;
   #dscam004#3 = 99;
   |LEE 000#dscam004.];
   |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
      |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
         |SI #dscam004#5 = "PRC"; |O #dscam004#5 = "PRA"; |SAL; |FINSI;
         |LEE 000#dscam004.a;
      |SIGUE;
      |SI #dscam004#5 ! "PRC"; |Y #dscam004#5 ! "PRA"; |ACABA; |FINSI;
   |SINO;
      |LEE 000#dscam004.a;
      |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
         |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
            |SI #dscam004#5 = "PRC"; |Y #dscam004#5 = "PRA"; |SAL; |FINSI;
            |LEE 000#dscam004.a;
         |SIGUE;
         |SI #dscam004#5 ! "PRC"; |O #dscam004#5 ! "PRA"; |ACABA; |FINSI;
      |FINSI;
   |FINSI;
   |SALVA_FICHA #dscam004;
   |LEE 000#dscam004.a;
   |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
      #dscam003#26 = #dscam004#6;
      |SI #dscam004#5 = "REM";
         |ABRE #dscam013; |SELECT #2#dscam013;
         #dscam013#16 = #dscam004#17;
         #dscam013#17 = #dscam004#3;
         |LEE 000#dscam013.=;
         |SI FSalida ! 0; |DDEFECTO #dscam013; |FINSI;
         |SELECT #1#dscam013;
         |LEE 101#dscam013.=;
         |SI FSalida = 0;
            |SI #dscam013#15 = "S"; #dscam003#84 = "S"; |FINSI;
            |ABRE #dscam012;
            #dscam012#0 = #dscam013#0;
            |LEE 000#dscam012.=;
            |SI FSalida ! 0; |DDEFECTO #dscam012; |FINSI;
            |CIERRA #dscam012;
            #dscam013#15 = "N"; |GRABA 020#dscam013.a;
            #dscam003#17 = #dscam012#0;
            #dscam003#53 = #dscam012#1;
            #dscam003#37 = #dscam013#1;
            #dscam003#98 = "N";
            |LIBERA #dscam013;
            #dscam003#84 = "N";
            #dscam003#98 = "N";
         |FINSI;
         |CIERRA #dscam013;
      |SINO;
         #dscam003#26 = "01.01.0000";
      |FINSI;
   |SINO;
      #dscam003#26 = #dscam004#6;
   |FINSI;
   |REPON_FICHA #dscam004;

   |SI #dscam004#17 ! nNumDocum; |O #dscam004#3 ! nNumLin;
      |SI #dscam004#54 ! 0; #dscam003#12 = #dscam004#54; |FINSI;
      |BORRA 020#dscam004.a;
   |FINSI;
   #dscam003#98 = "N";
   |GRABA 020#dscam003.a; |LIBERA #dscam003;
|FPRC;

|DEFBUCLE PetRecl;
#dscam003#7;
;
eaEntPag, eaNumPag, 000000001;
eaEntPag, eaNumPag, 999999999;
be;
NULL,PetRecl;
|FIN;

|PROCESO Reclam;
   ModoEntrada = (FEntrada / 100) ! 0; Flag = 0 +. 1;
   |BUCLE Recl;
|FPRC;

|PROCESO PetReclam;
   ModoEntrada = (FEntrada / 100) ! 0; Flag = 0 +. 1;
   |BUCLE PetRecl;
|FPRC;

|PROCESO ProcesaAsiento;
   |ABRE #dscam067;
   #dscam067#8 = 0;
   #dscam067#9 = 0;
   #dscam067#0  = "CB";
   #dscam067#1  = #dscam004#17;
   #dscam067#2  = #dscam004#3;
   #dscam067#3  = "";
   #dscam067#11 = 1;
   |LEE 000#dscam067.];
   FEstado = FSalida;
   nCalc1 = #dscam067#1;
   nCalc2 = #dscam067#2;
   |SI FEstado = 0; |Y nCalc1 = #dscam004#17; |Y nCalc2 = #dscam004#3;
      Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
      |NOME_DAT #dscaw013#Comodin#;
      |DELINDEX #dscaw013; |ABRE #dscaw013;
      |DDEFECTO #dscaw013;
      #dscaw013#15 = #dscam067#10;  #dscaw013#0 = 1;
      #dscaw013#13 = "dscam004";    #dscaw013#14 = 17;
      #dscaw013#11 = "N";           #dscaw013#12 = 10;
      #dscaw013#5  = #dscam004#17; #dscaw013#6 = #dscam004#17;
      |GRABA 020#dscaw013.n;
      |DDEFECTO #dscaw013;
      #dscaw013#15 = #dscam067#10;  #dscaw013#0 = 2;
      #dscaw013#13 = "dscam004"; #dscaw013#14 = 3;
      #dscaw013#11 = "N";        #dscaw013#12 = 3;
      #dscaw013#5  = #dscam004#3; #dscaw013#6 = #dscam004#3;
      |GRABA 020#dscaw013.n;

      Comodin = #dscam067#10;
      Comodin = "dscam033.tab;" + Comodin;
      |SI ModoEntrada = 3; Comodin = Comodin + ",B"; |FINSI;

      |LIBERA #dscam003; |CIERRAT #dscam003;
      |LIBERA #dscam004; |CIERRAT #dscam004;
      |SUB_EJECUTA_NP Comodin;
      |ABRET #dscam003; |LEE 101#dscam003.=;
      |ABRET #dscam004; |LEE 101#dscam004.=;
      |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".dat"; |FBORRA aAlfa;
      |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ddx"; |FBORRA aAlfa;
      |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ixx"; |FBORRA aAlfa;
   |FINSI;
|FPRC;

|PROCESO OtrosMovtos;
   ModoEntrada = (FEntrada / 100) ! 0;
   nFlag = 0 +. 1;

   |SI #dscam004#5 = "CCT";
      |SI ModoEntrada = 2;
         |MENAV "    No se puede modificar este movimiento"; enSwErr = -2; |ACABA;
      |FINSI;
      |SI ModoEntrada = 3;
         #dscam003#5 = #dscam004#4;
         |GRABA 020#dscam003.a;

         |SI #dscam051#1 = "S"; |HAZ ProcesaAsiento; |FINSI;
         enSwErr = -1;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO BuscaNumRecs;
   |SI #dscam004#17 = nCalc; |ACABA; |FINSI;
   enNumRecs = enNumRecs + 1;
|FPRC;

|DEFBUCLE BuscaSec;
#dscam004#3;
;
enNumSec;
enNumSec;
;
NULL, BuscaNumRecs;
|FIN;

|PROCESO BuscaSec;
   nCalc = #dscam004#17;
   |SALVA_FICHA #dscam004;
   |BUCLE BuscaSec;
   |SELECT #1#dscam004;
   |REPON_FICHA #dscam004;
|FPRC;

|PROCESO BorraObservm164;
   |BORRA 020#dscam219.a;
|FPRC;

|DEFBUCLE BorraObservm164;
#dscam219#1;
;
aAlfa, 001;
aAlfa, 999;
be;
NULL, BorraObservm164;
|FIN;

|PROCESO BorraCambioSit;
   aAlfa = #dscam004#16; |QBF aAlfa;
   aAlfa = aAlfa - "Cambio situacion ";
   |SI FSalida ! 0;
      |ABRE #dscam164;
      |SELECT #2#dscam164;
      #dscam164#0 = #dscam003#40;
      #dscam164#8 = aAlfa;
      |LEE 000#dscam164.=;
      |SI FSalida = 0;
         #dscam003#35 = #dscam164#3;
         #dscam003#36 = #dscam164#4;
         |SI #dscam164#9 ! "";
            |SI #dscam003#14 = "I"; |Y #dscam164#9 ! "I";
               #dscam003#16 = #dscam003#16 - 1;
            |FINSI;
            #dscam003#14 = #dscam164#9;
            #dscam003#15 = #dscam164#10;
         |SINO;
            |SI #dscam004#8 = 0; |Y #dscam004#9 ! 0; ||Es un impagado
               #dscam003#16 = #dscam003#16 - 1;
            |FINSI;
         |FINSI;
         |SI #dscam164#11 ! "01.01.0000";
            #dscam003#3 = #dscam164#11;
         |FINSI;

         aAlfa = (("0000000000" + #dscam164#0) % -110) + "/" + #dscam164#1 + "/" + #dscam164#2;
         |BUCLE BorraObservm164;
         |BORRA 020#dscam164.a;
      |FINSI;
      |SELECT #1#dscam164;
      |CIERRA #dscam164;
   |FINSI;
|FPRC;

|PROCESO RemMovs;
   |SI #dscam013#16 = enNumDoc; |ACABA; |FINSI;

   #dscam003#40 = #dscam013#16;
   |LEE 101#dscam003.=;
   |SI FSalida = 0;
      #dscam004#17 = #dscam013#16;
      #dscam004#3  = #dscam013#17;
      |LEE 101#dscam004.=;
      |SI FSalida = 0; |Y #dscam004#5 = "REM";
         |HAZ EsArtenvas;
         |SI FSalida ! 0;
            || Actualiza la cabecera del recibo .....
            #dscam003#26 = "01.01.0000";
            #dscam003#23 = #dscam003#23 - #dscam004#8;  #dscam003#61 = #dscam003#61 - #dscam004#26;
            #dscam003#24 = #dscam003#24 - #dscam004#12; #dscam003#62 = #dscam003#62 - #dscam004#29;
            #dscam003#25 = #dscam003#25 - #dscam004#13; #dscam003#63 = #dscam003#63 - #dscam004#30;
            #dscam003#38 = #dscam003#38 - #dscam004#14; #dscam003#66 = #dscam003#66 - #dscam004#31;
            #dscam003#55 = #dscam003#55 - #dscam004#23; #dscam003#68 = #dscam003#68 - #dscam004#32;
         |SINO;
            |SI #dscam003#14 ! "R";
               || Actualiza la cabecera del recibo .....
               #dscam003#26 = "01.01.0000";
               #dscam003#23 = #dscam003#23 - #dscam004#8;  #dscam003#61 = #dscam003#61 - #dscam004#26;
               #dscam003#24 = #dscam003#24 - #dscam004#12; #dscam003#62 = #dscam003#62 - #dscam004#29;
               #dscam003#25 = #dscam003#25 - #dscam004#13; #dscam003#63 = #dscam003#63 - #dscam004#30;
               #dscam003#38 = #dscam003#38 - #dscam004#14; #dscam003#66 = #dscam003#66 - #dscam004#31;
               #dscam003#55 = #dscam003#55 - #dscam004#23; #dscam003#68 = #dscam003#68 - #dscam004#32;
            |FINSI;
         |FINSI;

         #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
         #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
         #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
         #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);
         #dscam003#31 = #dscam003#30 - #dscam003#23;  #dscam003#65 = #dscam003#64 - #dscam003#61;

         #dscam003#14 = "R";
         #dscam003#15 = "Remesado";
         |SI #dscam004#54 ! 0; #dscam003#12 = #dscam004#54; |FINSI;
         |GRABA 020#dscam003.a;

         || ..... descuento el riesgo del banco .....
         |SI #dscam051#3 = "S";
            |SI #dscam013#15 = "S";
               eaTipoOper = "+4";
            |SINO;
               eaTipoOper = "-6+4";
            |FINSI;
            || enEmpCartera = #48#0; enEmpGestion = #dscam003#46;
            enEmpCartera = -1;     enEmpGestion = #dscam003#46;
            eaSerie = #dscam003#0; eaCliGest = #dscam003#32;
            nImporte = #dscam013#7;
            |HAZ BucleRiesgo;
         |FINSI;

         || ..... borro el movimiento del abono .....
         |BORRA 020#dscam004.a; |LIBERA #dscam004;
      |FINSI;
      |LIBERA #dscam003;
   |FINSI;
|FPRC;

|DEFBUCLE RemMovs;
#dscam013#1;
;
enNumRemesa, 001;
enNumRemesa, 999;
;
NULL,RemMovs;
|FIN;

|PROCESO MovRemesas;
   |BUCLE RemMovs;
|FPRC;

|PROCESO PintaFechaVisita; || Para Artenvas ...
   |HAZ EsArtenvas;
   |SI FSalida = 0;
      |DDEF aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dscam223.mas";
      |CARGA_DEF aAlfa, Referen@;
      |SI FSalida = 0;
         |DFICE aAlfa; |QBF aAlfa; |PATH_DAT #Referen@#aAlfa#;
         |ABRE #Referen@;
         #Referen@#0 = #dscam003#40;
         |LEE 000#Referen@.=;
         |SI FSalida = 0;
            |PINTA 1250, " Fecha visita ....            ";
            |PINTA 1269, #Referen@#4;
         |SINO;
            |PINTA 1250, "ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ";
         |FINSI;
         |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO OtrosCalculos;
   |HAZ EsArtenvas;
   |SI FSalida = 0;
      |SI #dscam003#83 ! 0; |Y #dscam003#14 = "P";
         |DDEFECTO #dscaw227;
         #dscaw227#0 = "P";
         #dscaw227#1 = "Pendiente de cobro";

         |SALVA_FICHA #dscam004;
         #dscam004#17 = #dscam003#83;
         #dscam004#3  = 1;
         |LEE 000#dscam004.];
         |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#83; |HACIENDO;
            |SI #dscam004#5 = "IMP"; |O #dscam004#5 = "IMA";
               #dscaw227#0 = "I";
               #dscaw227#1 = "Impagado";
               #dscaw227#2 = #dscaw227#2 + 1;
            |SINO;
               #dscaw227#0 = #dscam003#14;
               #dscaw227#1 = #dscam003#15;
            |FINSI;
            |LEE 000#dscam004.s;
         |SIGUE;
         |SI #dscaw227#0 ! #dscam003#14;
            |PINTA 1709, #dscaw227#0; |PINTA 1711, #dscaw227#1;
         |FINSI;
         |SI #dscaw227#2 ! #dscam003#16;
            |PINTA 1746, #dscaw227#2;
         |FINSI;
         |REPON_FICHA #dscam004;
      |FINSI;
   |FINSI;
|FPRC;
