|FICHEROS;
   dscaz199 #0;

   dscam003 #10;
   dscam004 #11;
   dscam044 #12;
   dscam045 #13;
   dscam030 #14;
   dscam051 #15;
   dscamrec #16;

   dscaw013 #20;

   agif010@ #100;
   agif071@ #101;
|FIN;

|VARIABLES;
   &eaVarLog = "";
   &enEmpCartera = 0;
   &enEmpGestion = 0;
   &eaSerie      = "";
   &eaCliGest    = "";
   &nImporte     = 0;
   &eaTipoOper   = "";
   &eaTipoR      = "";

   nImpACobrarD = 0;

   Comodin  = "";
   CodCli   = "";
   CtaCli   = "";
   nFactura = 0;
   Linea    = 0;
   LinCob   = 0;
   nSwErr   = 0;

   aDirBase = "";
   aAlfa    = "";
   aSerie   = "";
   CtaCobro = "";

   nImpDiv        = 0;
   nImpBase       = 0;
   nNumEntrega    = 0;
   nReciboACobrar = 0;
|FIN;

|PROCESO SaldaACuenta;
|| Compruebo que la entrega a cuenta en la que se esta ,cuelga del recibo que
||    se esta tratando
   eaVarLog = "Comprobando si la entrega " + #dscam003#40 + " esta asociada al documento " + nReciboACobrar + "."; |HAZ AnyadeLog;

   eaVarLog = "   Buscando en la empresa de gestion " + #dscam003#46 + "."; |HAZ AnyadeLog;
   nSwErr = 0;
   aDirBase = #48#17; |QBF aDirBase;
   |SI #dscam003#69 = "A";
      aAlfa = aDirBase + "def/agifa010.mas";
      |CARGA_DEF aAlfa, agif010@;
      |SI FSalida = 0;
         aAlfa = aDirBase + "fich/" + (("00000" + #dscam003#46) % -105) + "/";
         |PATH_DAT #agif010@#aAlfa#; |ABRE #agif010@;
         #agif010@#52 = #dscam003#0;
         #agif010@#0  = #dscam003#1;
         |LEE 000#agif010@.=;
         |SI FSalida ! 0; |O #agif010@#53 ! aSerie; |O #agif010@#39 ! nFactura;
            |SI FSalida ! 0;
               eaVarLog = "       Albaran n§ " + #agif010@#52 + "/" + (("000000" + #agif010@#0) % -106) + " no encontrado [" + FSalida + "]."; |HAZ AnyadeLog;
            |SINO;
               eaVarLog = "       Albaran n§ " + #agif010@#52 + "/" + (("000000" + #agif010@#0) % -106) + " no pertenece a la factura n§ ";
               eaVarLog = eaVarLog + aSerie + "/" + (("000000" + nFactura) % -106) + "."; |HAZ AnyadeLog;
            |FINSI;
            nSwErr = 1;
         |SINO;
            nSwErr = 0;
         |FINSI;
         |CIERRA #agif010@; |DESCARGA_DEF #agif010@;
      |FINSI;
   |FINSI;
   |SI #dscam003#69 = "P";
      aAlfa = aDirBase + "def/agifa010.mas";
      |CARGA_DEF aAlfa, agif010@;
      |SI FSalida = 0;
         aAlfa = aDirBase + "def/agifa071.mas"; |CARGA_DEF aAlfa, agif071@;
         aAlfa = aDirBase + "fich/" + (("00000" + #dscam003#46) % -105) + "/";
         |PATH_DAT #agif010@#aAlfa#; |ABRE #agif010@;
         |PATH_DAT #agif071@#aAlfa#; |ABRE #agif071@; |SELECT #4#agif071@;

         eaVarLog = "Buscando una linea de albaran de adjudicacion del pedido " + #dscam003#0 + "/" + (("000000" + #dscam003#1) % -106) + "."; |HAZ AnyadeLog;
         nSwErr = 1;
         #agif071@#31 = #dscam003#0;
         #agif071@#12 = #dscam003#1;
         #agif071@#21 = 1;
         |LEE 000#agif071@.];
         |PARA; |SI FSalida = 0; |Y #agif071@#31 = #dscam003#0; |Y #agif071@#12 = #dscam003#1; |HACIENDO;
            eaVarLog = "   Comprobando la linea de albaran " + #agif071@#29 + "/" + (("000000" + #agif071@#0) % -106) + " adjudicacion del pedido n§ ";
            eaVarLog = eaVarLog + #dscam003#0 + "/" + (("000000" + #dscam003#1) % -106) + "."; |HAZ AnyadeLog;

            aAlfa = #agif071@#29; |QBF aAlfa;
            #agif010@#52 = aAlfa;
            #agif010@#0  = #agif071@#0;
            |LEE 000#agif010@.=;
            |SI FSalida = 0; |Y #agif010@#53 = aSerie; |Y #agif010@#39 = nFactura;
               nSwErr = 0; |SAL;
            |SINO;
               |SI FSalida ! 0;
                  eaVarLog = "       Albaran n§ " + #agif010@#52 + "/" + (("000000" + #agif010@#0) % -106) + " no encontrado."; |HAZ AnyadeLog;
               |SINO;
                  eaVarLog = "       Albaran n§ " + #agif010@#52 + "/" + (("000000" + #agif010@#0) % -106) + " no pertenece a la factura n§ ";
                  eaVarLog = eaVarLog + aSerie + "/" + (("000000" + nFactura) % -106) + "."; |HAZ AnyadeLog;
               |FINSI;
            |FINSI;
            |LEE 000#agif071@.s;
         |SIGUE;
         |CIERRA #agif071@; |DESCARGA_DEF #agif071@;
         |CIERRA #agif010@; |DESCARGA_DEF #agif010@;
      |FINSI;
   |FINSI;

   |SI nSwErr = 1; |ACABA; |FINSI;

||   Escribo el movimiento del recibo cobrado y actualizo el recibo a cobrar
   |SI #dscam003#5 ! CtaCli; |Y #dscam003#32 ! CodCli;
      eaVarLog = "El recibo tratado no coincide en cuenta y codigo de cliente [" + CtaCli + "," + CodCli;
      eaVarLog = eaVarLog +"][" + #dscam003#0 + "," + #dscam003#1 + "]"; |HAZ AnyadeLog;
      nSwErr = 1; |ACABA;
   |FINSI;

   eaVarLog = "Escribiendo el movimiento del recibo cobrado y actualizando el recibo a cobrar [" + nReciboACobrar + "]"; |HAZ AnyadeLog;
   |SI #dscam003#14 = "e"; |O #dscam003#14 = "E";   || Entrega a cuenta por compensar o compensada parcialmente
      #dscam004#17 = #dscam003#40; #dscam004#3 = 1;
      |LEE 000#dscam004.];
      |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
         CtaCobro = #dscam004#42;
      |FINSI;
      |SI #dscam003#23 ! #dscam003#31;
         nImpDiv  = #dscam003#23; nImpBase = #dscam003#61; nNumEntrega = #dscam003#40;
         Linea = 1;
         #dscam004#17 = #dscam003#40;
         #dscam004#3  = 1;
         |LEE 000#dscam004.];
         |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
            Linea = #dscam004#3 + 1;
            |LEE 000#dscam004.s;
         |SIGUE;

         |SALVA_FICHA #dscam003;
         |SELECT #1#dscam003;

         #dscam003#40 = nReciboACobrar;
         |LEE 101#dscam003.=;
         |SI FSalida = 0;

            |SI #dscam003#31 = 0;
               |SELECT #6#dscam003;
               |REPON_FICHA #dscam003;
               |ACABA;
            |FINSI;

            |DDEFECTO #dscam004;
            #dscam004#17 = #dscam003#40;
            #dscam004#3  = LinCob; LinCob = LinCob + 1;
            |GRABA 020#dscam004.b;
            #dscam004#0 = #dscam003#0;
            #dscam004#1 = #dscam003#1;
            #dscam004#2 = #dscam003#2;
            #dscam004#4 = CtaCobro;
            #dscam004#5 = "CAC";
            #dscam004#6 = ~;
            #dscam004#7 = #dscam003#23;
            |SI #dscam003#31 ] 0;
               |SI #dscam003#31 ] nImpDiv;
                  #dscam004#8  = nImpDiv; #dscam004#26 = nImpBase;
               |SINO;
                  #dscam004#8  = #dscam003#31; #dscam004#26 = #dscam003#65;
               |FINSI;
            |SINO;
               |SI #dscam003#31 [ nImpDiv;
                  #dscam004#8  = nImpDiv; #dscam004#26 = nImpBase;
               |SINO;
                  #dscam004#8  = #dscam003#31; #dscam004#26 = #dscam003#65;
               |FINSI;
            |FINSI;
            #dscam004#15 = #dscam003#27;
            Comodin = ("000000000" + nNumEntrega) % -109;
            Comodin = "Cobro entr. " + Comodin;
            #dscam004#16 = Comodin;
            #dscam004#25 = #dscam003#61;
            #dscam004#40 = nNumEntrega;
            #dscam004#41 = Linea;
            |GRABA 020#dscam004.a; |LIBERA #dscam004;
            eaVarLog = FSalida;
            eaVarLog = "FSalida [" + eaVarLog + "] del movimiento del recibo cobrado [" + #dscam004#17 + "/" + #dscam004#3 + "]"; |HAZ AnyadeLog;

            || enEmpCartera = #48#0; enEmpGestion = #dscam003#46;
            enEmpCartera = -1;     enEmpGestion = #dscam003#46;
            eaSerie = #dscam003#0; eaCliGest = #dscam003#32; nImporte = #dscam004#26;
            eaTipoOper = "-4";
            |HAZ BucleRiesgo;

            #dscam003#26 = ~;
            |SI #dscam003#31 ] 0;
               |SI #dscam003#31 ] nImpDiv;
                  #dscam003#23 = #dscam003#23 + nImpDiv;
                  #dscam003#61 = #dscam003#61 + nImpBase;
               |SINO;
                  #dscam003#23 = #dscam003#23 + #dscam003#31; nImpDiv  = #dscam003#31;
                  #dscam003#61 = #dscam003#61 + #dscam003#65; nImpBase = #dscam003#65;
                  #dscam003#31 = 0; #dscam003#65 = 0;
               |FINSI;
            |SINO;
               |SI #dscam003#31 [ nImpDiv;
                  #dscam003#23 = #dscam003#23 + nImpDiv;
                  #dscam003#61 = #dscam003#61 + nImpBase;
               |SINO;
                  #dscam003#23 = #dscam003#23 + #dscam003#31; nImpDiv  = #dscam003#31;
                  #dscam003#61 = #dscam003#61 + #dscam003#65; nImpBase = #dscam003#65;
                  #dscam003#31 = 0; #dscam003#65 = 0;
               |FINSI;
            |FINSI;
            #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
            #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
            #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
            #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);
            #dscam003#31 = #dscam003#30 - #dscam003#23; #dscam003#65 = #dscam003#64 - #dscam003#61;
            |SI #dscam003#31 = 0;
               #dscam003#14 = "L";
               #dscam003#15 = "Recibo Liquidado";
            |SINO;
               |SI #dscam003#23 = 0;
                  |SI #dscam003#16 = 0;
                     #dscam003#14 = "P";
                     #dscam003#15 = "Pendiente de cobro";
                  |SINO;
                     #dscam003#14 = "I";
                     #dscam003#15 = "Impagado";
                  |FINSI;
               |SINO;
                  #dscam003#14 = "C";
                  #dscam003#15 = "Parcialmente cobrado";
               |FINSI;
            |FINSI;
            |GRABA 020#dscam003.a; |LIBERA #dscam003;
            eaVarLog = FSalida;
            eaVarLog = "FSalida [" + eaVarLog + "] de la actualizacion del recibo cobrado [" + #dscam003#40 + "]"; |HAZ AnyadeLog;

            |SI #dscam051#117 = "S"; |Y #dscam051#70 ! "    ";
               || Hago el enlace automatico a contabilidad de la compensacion
               ||    automatica de la entrega
               |ABRE #dscam030;
               #dscam030#0 = #dscam051#70;
               |LEE 000#dscam030.=;
               |SI FSalida = 0;
                  Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
                  |NOME_DAT #dscaw013#Comodin#;
                  |DELINDEX #dscaw013; |ABRE #dscaw013;
                  Comodin = #dscam051#70;
                  |DDEFECTO #dscaw013;
                  #dscaw013#0  = 1;            #dscaw013#15 = Comodin;
                  #dscaw013#5  = nNumEntrega;  #dscaw013#6  = nNumEntrega;
                  #dscaw013#11 = "N";          #dscaw013#12 = 9;
                  #dscaw013#13 = "dscam004";   #dscaw013#14 = 40;
                  |GRABA 020#dscaw013.n;

                  |DDEFECTO #dscaw013;
                  #dscaw013#0  = 2;            #dscaw013#15 = Comodin;
                  #dscaw013#3  = "CAC";        #dscaw013#4  = "CAC";
                  #dscaw013#11 = "A";          #dscaw013#12 = 3;
                  #dscaw013#13 = "dscam004";   #dscaw013#14 = 5;
                  |GRABA 020#dscaw013.n;
                  |CIERRA #dscaw013;
                  Comodin = "dscam033.tab;" + Comodin;
                  |LIBERA #dscam003; |CIERRAT #dscam003;
                  |LIBERA #dscam004; |CIERRAT #dscam004;
                  |SUB_EJECUTA_NP Comodin;
                  |ABRET #dscam003; |LEE 000#dscam003.=;
                  |ABRET #dscam004; |LEE 000#dscam004.=;
                  |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".dat"; |FBORRA aAlfa;
                  |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ddx"; |FBORRA aAlfa;
                  |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ixx"; |FBORRA aAlfa;
               |FINSI;
               |CIERRA #dscam030;
            |FINSI;
         |FINSI;
         |SELECT #6#dscam003;
         |REPON_FICHA #dscam003;

||  Escribo el movimiento del recibo a cuenta y actualizo el recibo a cuenta
         eaVarLog = "Escribiendo el movimiento del recibo a cuenta y actualizando el recibo a cuenta [" + #dscam003#40 + "]"; |HAZ AnyadeLog;

         |DDEFECTO #dscam004;
         #dscam004#17 = #dscam003#40;
         #dscam004#3  = Linea;
         |GRABA 020#dscam004.b;
         #dscam004#0 = #dscam003#0;
         #dscam004#1 = #dscam003#1;
         #dscam004#2 = #dscam003#2;
         #dscam004#4 = #dscamrec#36;
         #dscam004#5 = "REC";
         #dscam004#6 = ~;
         #dscam004#7 = #dscam003#23;
         |SI #dscam003#30 ] 0;
            |SI #dscam003#31 ] nImpACobrarD;
               #dscam004#8  = -nImpDiv; #dscam004#26 = -nImpBase;
               #dscam004#23 = nImpDiv; #dscam004#32 = nImpBase;
            |SINO;
               #dscam004#8  = -#dscam003#31; #dscam004#26 = -#dscam003#65;
               #dscam004#23 = #dscam003#31;  #dscam004#32 = #dscam003#65;
            |FINSI;
         |SINO;
            |SI #dscam003#31 [ nImpACobrarD;
               #dscam004#8  = -nImpDiv; #dscam004#26 = -nImpBase;
               #dscam004#23 = nImpDiv; #dscam004#32 = nImpBase;
            |SINO;
               #dscam004#8  = -#dscam003#31; #dscam004#26 = -#dscam003#65;
               #dscam004#23 = #dscam003#31;  #dscam004#32 = #dscam003#65;
            |FINSI;
         |FINSI;
         #dscam004#15 = #dscam003#27;
         Comodin = ("0000000000" + nReciboACobrar) % -110;
         Comodin = "Cobro Doc. " + Comodin;
         #dscam004#16 = Comodin;
         #dscam004#25 = #dscam003#61;
         |GRABA 020#dscam004.a; |LIBERA #dscam004;
         eaVarLog = FSalida;
         eaVarLog = "FSalida [" + eaVarLog + "] de la grabacion del movimiento del recibo a cuenta [" + #dscam004#17 + "/" + #dscam004#3 + "]"; |HAZ AnyadeLog;

         || enEmpCartera = #48#0; enEmpGestion = #dscam003#46;
         enEmpCartera = -1;     enEmpGestion = #dscam003#46;
         eaSerie = #dscam003#0; eaCliGest = #dscam003#32; nImporte = -#dscam004#26;
         eaTipoOper = ""; eaTipoR = "";
         |SI #dscam003#69 = "P"; eaTipoOper = "-5"; eaTipoR = "P"; |FINSI;
         |SI #dscam003#69 = "A"; eaTipoOper = "-5"; eaTipoR = "A"; |FINSI;
         |SI eaTipoOper ! ""; |HAZ BucleRiesgo; |FINSI;
         eaTipoR = "";

         |SI #dscam003#30 ] 0;
            |SI #dscam003#23 ] nImpDiv;
               #dscam003#23 = #dscam003#23 - nImpDiv;
               #dscam003#61 = #dscam003#61 - nImpBase;
               #dscam003#55 = #dscam003#55 + nImpDiv;
               #dscam003#68 = #dscam003#68 + nImpBase;
            |SINO;
               #dscam003#23 = -#dscam003#31; nImpDiv = #dscam003#31;
               #dscam003#61 = -#dscam003#65; nImpBase = #dscam003#65;
               #dscam003#55 = #dscam003#55 + #dscam003#31;
               #dscam003#68 = #dscam003#68 + #dscam003#65;
               #dscam003#31 = 0; #dscam003#65 = 0;
            |FINSI;
         |SINO;
            |SI #dscam003#23 [ nImpDiv;
               #dscam003#23 = #dscam003#23 - nImpDiv;
               #dscam003#61 = #dscam003#61 - nImpBase;
               #dscam003#55 = #dscam003#55 + nImpDiv;
               #dscam003#68 = #dscam003#68 + nImpBase;
            |SINO;
               #dscam003#23 = -#dscam003#31; nImpDiv = #dscam003#31;
               #dscam003#61 = -#dscam003#65; nImpBase = #dscam003#65;
               #dscam003#55 = #dscam003#55 + #dscam003#31;
               #dscam003#68 = #dscam003#68 + #dscam003#65;
               #dscam003#31 = 0; #dscam003#65 = 0;
            |FINSI;
         |FINSI;
         |SI #dscam003#31 = #dscam003#23;
            #dscam003#14 = "L";
            #dscam003#15 = "Recibo Compensado";
         |SINO;
            |SI #dscam003#23 = 0;
               #dscam003#14 = "e";
               #dscam003#15 = "Pendiente de compensar";
            |SINO;
               #dscam003#14 = "E";
               #dscam003#15 = "Compensado parcialmente";
            |FINSI;
         |FINSI;
         #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
         #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
         #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
         #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);
         #dscam003#31 = #dscam003#30 - #dscam003#23; #dscam003#65 = #dscam003#64 - #dscam003#61;
         |GRABA 020#dscam003.a; |LIBERA #dscam003;
         eaVarLog = FSalida;
         eaVarLog = "FSalida [" + eaVarLog + "] de la grabacion de la actualizacion del recibo a cuenta [" + #dscam003#40 + "]"; |HAZ AnyadeLog;
         eaVarLog = "Saldado automatico finalizado [" + nReciboACobrar + "," + #dscam003#40 + "]"; |HAZ AnyadeLog;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE SaldaACuenta;
#dscam003#15;
;
CodCli, CtaCli, "A";
CodCli, CtaCli, "P";
be;
NULL,SaldaACuenta;
|FIN;

|PROCESO Recibos;
   |SI #dscam003#69 = " ";
      LinCob = 1;
      eaVarLog = "Grabado recibo de ventas [" + #dscam003#0 + "-";
      eaVarLog = eaVarLog + (("000000" + #dscam003#1) % -106) + "-";
      eaVarLog = eaVarLog + (("000" + #dscam003#2) % -103) + ",";
      eaVarLog = eaVarLog + #dscam003#40 + "]. Entrando al saldado automatico"; |HAZ AnyadeLog;
      nReciboACobrar = #dscam003#40; CtaCli = #dscam003#5;

      aSerie = #dscam003#0; nFactura = #dscam003#1;
      CodCli = #dscam003#32;
      #dscam004#17 = nReciboACobrar;
      #dscam004#3 = 1;
      |LEE 000#dscam004.];
      |PARA; |SI FSalida = 0; |Y #dscam004#17 = nReciboACobrar; |HACIENDO;
         LinCob = #dscam004#3 + 1;
         |LEE 000#dscam004.s;
      |SIGUE;

      |SALVA_FICHA #dscam003; |SALVA_FICHA #dscam004;
      |BUCLE SaldaACuenta;
      |REPON_FICHA #dscam004; |REPON_FICHA #dscam003;

      |SI nSwErr = 1;
         eaVarLog = "No se han encontrado entregas procedentes de albaranes o pedidos del cliente."; |HAZ AnyadeLog;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Recibos;
#dscam003#6;
4;
00, #dscaz199#0, #dscaz199#1, 000, " ", 000000001, #dscaz199#2;
00, #dscaz199#3, #dscaz199#4, 999, " ", 999999999, #dscaz199#5;
be;
NULL, Recibos;
|FIN;

|PROGRAMA;
   |CLS;
   |CABEZA "Proceso de saldado automatico de entregas a cuenta";

   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      |ABRE #dscam003; |ABRE #dscam004;
      |DFICE aAlfa; |QBF aAlfa;
      |PATH_DAT #dscam044#aAlfa#; |PATH_DAT #dscam045#aAlfa#;
      |ABRE #dscam044; |ABRE #dscam045;
      |BUCLE Recibos;
      |CIERRA #dscam044; |CIERRA #dscam045;
      |CIERRA #dscam003; |CIERRA #dscam004;
   |FINSI;
|FPRO;
