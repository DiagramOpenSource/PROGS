|FICHEROS;
   dscam210 #10;
   dscam211 #11;
   dscam212 #12;

   dscam003 #20;
   dscam004 #21;
   dscam044 #22;
   dscam013 #23;

   dscaw105 #50;
   dscaw106 #51;

   dscm211@ #100;
   agif134@ #110;
   agif084@ #111;
|FIN;

|VARIABLES;
   &eaTitulo = "";

   nComParc   = 0;
   nTotParc   = 0;
   nComision  = 0;
   nTotalF    = 0;

   nModo  = 0;
   nFlag  = 0;
   nCalc  = 0;
   nCalc1 = 0;
   nCalc2 = 0;
   nNumLiqAnt   = 0;
   nSwTomaDatos = 0;
   nFactuAnt    = 0;

   nFactor      = 0;
   nNumRecs     = 0;

   aEstadoAnt   = "";
   aAlfa        = "";
   aAlfa1       = "";
   aSerieAnt    = "";
   aSerieB      = "";
   aCodRepres   = "";

   nCodEmpresa  = 0;
   nSwNoLiq     = 0;
   nDocDiv      = 0;
   nDocAgr      = 0;

   nSwError     = 0;

   aDirPath     = "";

 {1000}nSwLinLiq    = 0;
 {1000}aSerieBase   = "";
 {1000}nDocDividido = 0;
 {1000}nDocAgrup    = 0;
|FIN;

|PROCESO MiraSiEntra;
   nSwError = 0;
   |SI #dscam003#47 ! "N";
      |MENAV "    El recibo es una entrega a cuenta"; nSwError = -1;
   |FINSI;
   |SI #dscam003#33 ! #dscam210#1;
      |MENAV "    El representante  el recibo no coincide con el de la liquidacion"; nSwError = -1;
   |FINSI;
   |SI #dscam003#14 ! "P"; |Y #dscam003#14 ! "T"; |Y #dscam003#14 ! "C"; |Y #dscam003#14 ! "R";
      |SI #dscam003#26 = "01.01.0000";
         |MENAV "    El recibo seleccionado esta pendiente de cobro"; nSwError = -1;
      |FINSI;
   |SINO;
      |SI #dscam003#35 ! "LIQ";
         |MENAV "    El recibo seleccionado esta pendiente de cobro"; nSwError = -1;
      |FINSI;
   |FINSI;
   |SI #dscam003#14 = "I"; |Y #dscam003#35 = "   ";
      |MENAV "    El recibo seleccionado esta impagado pero no esta incluido en una liquidacion anterior"; nSwError = -1;
   |FINSI;
   |SI #dscam003#14 = "L";
      || Compruebo si se ha liquidado con una remesa y si es asi si el
      ||    riesgo esta descontado
      #dscam004#17 = #dscam003#40;
      #dscam004#3  = 99;
      |LEE 000#dscam004.];
      |SI FSalida = 0;
         |LEE 000#dscam004.a;
      |SINO;
         |LEE 000#dscam004.u;
      |FINSI;
      |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
         |SI #dscam004#5 = "REM";
            |ABRE #dscam013;
            |SELECT #2#dscam013;
            #dscam013#16 = #dscam004#17;
            #dscam013#17 = #dscam004#3;
            |LEE 000#dscam013.=;
            |SI FSalida ! 0; |O #dscam013#15 = "N";
               |MENAV "    El recibo seleccionado no esta descontado del riesgo"; nSwError = -1;
            |FINSI;
            |CIERRA #dscam013;
         |FINSI;
      |FINSI;
   |FINSI;
   |SI #dscam003#14 = "L"; |Y #dscam003#35 = "LIQ"
      |MENAV "    El recibo seleccionado esta liquidado y ya incluido en una liquidacion";
      nSwError = -1;
   |FINSI;
|FPRC;

|PROCESO SumaComision;
   #agif134@#49 = #dscam003#0;
   #agif134@#0 = #dscam003#1;
   |LEE 000#agif134@.=;
   |SI FSalida = 0;
      |SI #dscam003#4 = #agif134@#1;
         nCalc2 = (#dscam003#22 * #agif134@#111) / #agif134@#101;
         nComParc  = nComParc + nCalc2;
      |SINO;
         #agif084@#48 = #dscam003#0;
         #agif084@#0 = #dscam003#1;
         |LEE 000#agif084@.=;
         |SI FSalida = 0;
            |SI #dscam003#4 = #agif084@#1;
               nCalc2 = (#dscam003#22 * #agif084@#26) / #agif084@#73;
               nComParc  = nComParc + nCalc2;
            |FINSI;
         |FINSI;
      |FINSI;
   |SINO;
      #agif084@#48 = #dscam003#0;
      #agif084@#0 = #dscam003#1;
      |LEE 000#agif084@.=;
      |SI FSalida = 0;
         |SI #dscam003#4 = #agif084@#1;
            nCalc2 = ((#dscam003#22 * #agif084@#26) / #agif084@#73) ! 2;
            nComParc  = nComParc + nCalc2;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO Agrupados;
   |SALVA_FICHA #dscam003;
   |SELECT #1#dscam003;
   |HAZ CalculaComision;
   |SELECT #8#dscam003;
   |REPON_FICHA #dscam003;

   nComision = nComision + nComParc;
   nTotalF   = nTotalF   + nTotParc;
   nComParc = 0; nTotParc = 0;
|FPRC;

|DEFBUCLE Agrupados;
#dscam003#8;
;
000000001, nCalc;
999999999, nCalc;
;
NULL, Agrupados;
|FIN;

|PROCESO CalculaComision;
   |SI #dscam003#49 = "N"; |Y #dscam003#82 = "N";
      nComParc = 0; |HAZ SumaComision;
      nTotParc = #dscam003#31;
   |FINSI;

   |SI #dscam003#49 = "S";
      |SALVA_FICHA #dscam003; nCalc = #dscam003#40;
      |BUCLE Agrupados;
      |REPON_FICHA #dscam003; nCalc = #dscam003#40;
      nComParc = nComision;
   |FINSI;
   |SI #dscam003#82 = "S";
      |SALVA_FICHA #dscam003;

      #dscam003#40 = #dscam003#83;
      |LEE 000#dscam003.=;

      |HAZ CalculaComision;

      |REPON_FICHA #dscam003;

      nComParc  = (#dscam003#22 * nComParc) / nTotParc;
      nTotParc  = #dscam003#22;
   |FINSI;
|FPRC;

|PROCESO CalcComision;
   |SALVA_FICHA #dscam003;
   |HAZ CalculaComision;
   nComision = nComParc;
   |REPON_FICHA #dscam003;
|FPRC;

|PROCESO IncluyeFra;
   |ABRE #dscam003;
   |SELECT #9#dscam003;
   #dscam003#27 = 0;
   #dscam003#40 = 1;
   #dscam003#0 = #dscam211#2;
   #dscam003#1 = #dscam211#3;
   #dscam003#2 = #dscam211#4;
   |LEE 000#dscam003.];
   |SI FSalida ! 0; |O #dscam003#1 ! #dscam211#3; |O #dscam003#1 ! #dscam211#3;
    |O #dscam003#2 ! #dscam211#4; |DDEFECTO #dscam003; |FINSI;

   |SELECT #1#dscam003;
   |LEE 000#dscam003.=;
   |SI FSalida ! 0; |MENAV "    Recibo inexistente"; |ERROR; |ACABA; |FINSI;

   nSwError = 0; |HAZ MiraSiEntra;
   |SI nSwError < 0; |ERROR; |ACABA; |FINSI;

   |SI #dscam003#14 = "L"; |Y #dscam003#17 ! 0; |Y #dscam003#84 = "N";
      |ABRE #dscam013;
      |SELECT #5#dscam013;
      #dscam013#15 = "N";
      #dscam013#16 = #dscam003#40;
      |LEE 000#dscam013.];
      |PARA; |SI FSalida = 0; |Y #dscam013#16 = #dscam003#40; |Y #dscam013#15 = "N"; |HACIENDO;
         |SI #dscam013#0 = #dscam003#17; |SAL; |FINSI;
         |LEE 000#dscam013.s;
      |SIGUE;
      |CIERRA #dscam013;
      |SI FSalida = 0; |Y #dscam013#16 = #dscam003#40; |Y #dscam013#15 = "N"; |Y #dscam013#0 = #dscam003#17;
         |MENAV "    El recibo indicado no está vencido";
         |CIERRA #dscam003;
         |ERROR; |ACABA;
      |FINSI;
   |FINSI;

   |SI #dscam003#33 ! #dscam210#1;
      |MENAV "    El recibo indicado no tiene el representante de la liquidacion";
      |CIERRA #dscam003;
      |ERROR; |ACABA;
   |FINSI;
   |CIERRA #dscam003;

   nModo = (FEntrada / 100) ! 0;
   |SI nModo = 1; nSwTomaDatos = 1; |FINSI;
   |SI nModo = 2;
      |SI aSerieAnt ! #dscam211#2; |O nFactuAnt ! #dscam211#3;
         nSwTomaDatos = 1;
      |FINSI;
   |FINSI;

   |SI nSwTomaDatos = 1;
      |DFICB aAlfa; |QBF aAlfa; |PATH_DAT #dscam044#aAlfa#;

      |ABRE #dscam044;
      #dscam044#0 = #dscam003#46;
      |LEE 000#dscam044.=;
      |SI FSalida = 0;
         aDirPath = #dscam044#1;
      |SINO;
         |DBASS aDirPath; |QBF aDirPath;
         aDirPath = aDirPath + "dscomer9/";
      |FINSI;
      |CIERRA #dscam044;
      |QBF aDirPath;

      aAlfa = aDirPath + "def/agifa134.mas";
      |CARGA_DEF aAlfa, agif134@;
      |SI FSalida = 0;
         |DBASS aAlfa; |QBF aAlfa;
         aAlfa = aDirPath + "def/agifa084.mas";
         |CARGA_DEF aAlfa, agif084@;

         aAlfa1 = #dscam003#46; |QBF aAlfa1; aAlfa1 = (("00000" + aAlfa1) % -105)
         |DBASS aAlfa; |QBF aAlfa;
         aAlfa = aDirPath + "fich/" + aAlfa1 + "/";
         |PATH_DAT #agif134@#aAlfa#; |PATH_DAT #agif084@#aAlfa#;
         |ABRE #agif134@; |ABRE #agif084@;

         #agif134@#49 = #dscam211#2;
         #agif134@#0  = #dscam211#3;
         |LEE 000#agif134@.=;
         |SI FSalida ! 0;
            |DDEFECTO #agif134@;
            #agif084@#48 = #dscam211#2;
            #agif084@#0  = #dscam211#3;
            |LEE 000#agif084@.=;
            |SI FSalida ! 0; |DDEFECTO #agif084@; |FINSI;
         |FINSI;

         |SI #agif134@#49 = #dscam211#2; |Y #agif134@#0 = #dscam211#3;
            #dscam211#5 = #agif134@#1;
            #dscam211#6 = #agif134@#101;
            #dscam211#9 = #dscam003#30;
            |SI #dscam003#35 = "   "; |O #dscam003#35 = "IMP";
               #dscam211#7 = #agif134@#111;
               #dscam211#8 = "F";
               nCalc2 = (#dscam003#22 * #agif134@#111) / #agif134@#101;
               #dscam211#10 = nCalc2 ! 2;
/*
               |HAZ CalcComision;
               #dscam211#10 = nComision ! 2;
*/
            |SINO;
/*
               |HAZ CalcComision;
               #dscam211#7 = nComision ! 2;
               #dscam211#8 = "I";
               #dscam211#10 = nComision ! 2;
*/
               nCalc2 = 0 - ((#dscam003#22 * #agif134@#111) / #agif134@#101);
               #dscam211#7 = nCalc2 ! 2;
               #dscam211#8 = "I";
               #dscam211#10 = nCalc2 ! 2;
            |FINSI;
         |SINO;
            #dscam211#5 = #agif084@#1;
            #dscam211#6 = #agif084@#73;
            #dscam211#9 = #dscam003#30;
            |SI #dscam211#4 = 0;
               #dscam211#7 = #agif084@#26;
               #dscam211#8 = "F";
/*
               |HAZ CalcComision;
               #dscam211#10 = nComision ! 2;
*/
               nCalc2 = (#dscam003#22 * #agif134@#111) / #agif134@#101;
               #dscam211#10 = nCalc2 ! 2;
            |SINO;
/*
               |HAZ CalcComision;
               #dscam211#7 = nComision ! 2;
               #dscam211#8 = "I";
               #dscam211#10 = nComision ! 2;
*/
               nCalc2 = 0 - ((#dscam003#22 * #agif084@#26) / #agif084@#73);
               #dscam211#7 = nCalc2 ! 2;
               #dscam211#8 = "I";
               #dscam211#10 = nCalc2 ! 2;
            |FINSI;
         |FINSI;
         #dscam211#11 = #dscam003#40;
         |PINTA #dscam211#5; |PINTA #dscam211#6;
         |PINTA #dscam211#10; |PINTA #dscam211#8;
         |PINTA #dscam211#9;

         |ABRE #dscam212;
         #dscam212#0 = #dscam003#40;
         #dscam212#1 = #dscam211#0;
         |LEE 000#dscam212.=;
         |SI FSalida ! 0;
            |DDEFECTO #dscam212;
            #dscam212#0 = #dscam003#40;
            #dscam212#1 = #dscam211#0;
            #dscam212#2 = #dscam210#3;
            #dscam212#3 = #dscam211#8;
            |GRABA 020#dscam212.n;
         |FINSI;
         |CIERRA #dscam212;

         |ABRE #dscam003;
         #dscam003#40 = #dscam211#11;
         |LEE 101#dscam003.=;
         |SI FSalida = 0;
            |SI #dscam211#8 = "I";
               #dscam003#35 = "IMP";
            |SINO;
               #dscam003#35 = "LIQ";
            |FINSI;
            #dscam003#36 = "Liquidacion n." + (("00000" + #dscam211#0) % -105);
            |GRABA 020#dscam003.a; |LIBERA #dscam003;
         |FINSI;
         |CIERRA #dscam003;

         |CIERRA #agif084@; |DESCARGA_DEF #agif084@;
         |CIERRA #agif134@; |DESCARGA_DEF #agif134@;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO RecalcRecs;
   |SI nFlag < 0;
      |SI aEstadoAnt = "F"; #dscam003#35 = "LIQ"; |FINSI;
      |SI aEstadoAnt = "I"; #dscam003#35 = "IMP"; |FINSI;
      |SI aEstadoAnt = "";  #dscam003#35 = "";    |FINSI;
      |SI nNumLiqAnt > 0;
         #dscam003#36 = "Liquidaci¢n n." + (("00000" + nNumLiqAnt) % -105);
      |SINO;
         #dscam003#36 = "";
      |FINSI;

      |SI nModo = 3;
         |ABRE #dscam212;
         #dscam212#0 = #dscam003#40;
         #dscam212#1 = #dscam211#0;
         |LEE 101#dscam212.=;
         |SI FSalida = 0;
            |BORRA 020#dscam212.a; |LIBERA #dscam212;
         |FINSI;
         |CIERRA #dscam212;
      |FINSI;

   |SINO;
      |SI #dscam211#8 = "F"; #dscam003#35 = "LIQ"; |FINSI;
      |SI #dscam211#8 = "I"; #dscam003#35 = "IMP"; |FINSI;
      #dscam003#36 = "Liquidaci¢n n." + (("00000" + #dscam211#0) % -105);

      |SI nModo = 1;
         |ABRE #dscam212;
         #dscam212#0 = #dscam003#40;
         #dscam212#1 = #dscam211#0;
         |LEE 000#dscam212.=;
         |SI FSalida ! 0;
            |DDEFECTO #dscam212;
            #dscam212#0 = #dscam003#40;
            #dscam212#1 = #dscam211#0;
            #dscam212#2 = #dscam210#3;
            #dscam212#3 = #dscam211#8;
            |GRABA 020#dscam212.n;
         |FINSI;
         |CIERRA #dscam212;
      |FINSI;

   |FINSI;
   |GRABA 020#dscam003.a; |LIBERA #dscam003;
|FPRC;

|DEFBUCLE RecalcRecs;
#dscam003#9;
;
00, #dscam211#2, #dscam211#3, 000, 000000001;
00, #dscam211#2, #dscam211#3, 999, 999999999;
be;
NULL, RecalcRecs;
|FIN;

|PROCESO Tipo2; |TIPO 2;
   nModo = (FEntrada / 100) ! 0;
   nFlag = 0 +. 1;

   nNumLiqAnt = 0; aEstadoAnt = "";
   |DDEF aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dscam211.mas";
   |CARGA_DEF aAlfa, dscm211@;
   |SI FSalida = 0;
      nCalc = 0;
      |DFICE aAlfa; |PATH_DAT #dscm211@#aAlfa#;
      |ABRE #dscm211@;
      |SELECT #4#dscm211@;
      |DDEFECTO #dscm211@;
      #dscm211@#11 = #dscam211#11;
      |LEE 000#dscm211@.];
      |PARA; |SI FSalida = 0; |Y #dscm211@#11 = #dscam211#11; |HACIENDO;
         |SI #dscm211@#0 < #dscam211#0;
            nNumLiqAnt = #dscm211@#0;  aEstadoAnt = #dscm211@#8;
         |FINSI;
         |SI #dscm211@#0 > #dscam211#0;
            nNumLiqAnt = -1; |SAL;
         |FINSI;
         |LEE 000#dscm211@.s;
      |SIGUE;
      |SELECT #1#dscm211@;
      |CIERRA #dscm211@; |DESCARGA_DEF #dscm211@;
   |FINSI;

   |SI nModo ! 1;
      |SI nNumLiqAnt < 0;
         |SI nFlag < 0;
            |MENAV "    Existen liquidaciones posteriores. No se puede modificar la linea.";
         |FINSI;
         |ERROR; |ACABA;
      |FINSI;
   |FINSI;

   |ABRE #dscam003;
   #dscam003#40 = #dscam211#11;
   |LEE 101#dscam003.=;
   |SI FSalida = 0;
      |SI nFlag < 0;
         |SI aEstadoAnt = "F"; #dscam003#35 = "LIQ"; |FINSI;
         |SI aEstadoAnt = "I"; #dscam003#35 = "IMP"; |FINSI;
         |SI aEstadoAnt = "";  #dscam003#35 = "";    |FINSI;
         |SI nNumLiqAnt > 0;
            #dscam003#36 = "Liquidaci¢n n." + (("00000" + nNumLiqAnt) % -105);
         |SINO;
            #dscam003#36 = "";
         |FINSI;
      |SINO;
         |SI #dscam211#8 = "F"; #dscam003#35 = "LIQ"; |FINSI;
         |SI #dscam211#8 = "I"; #dscam003#35 = "IMP"; |FINSI;
         #dscam003#36 = "Liquidaci¢n n." + (("00000" + #dscam211#0) % -105);
      |FINSI;
      |GRABA 020#dscam003.a; |LIBERA #dscam003;
   |FINSI;
   |CIERRA #dscam003;

   |SI nFlag < 0;
      aSerieAnt = #dscam211#2;
      nFactuAnt = #dscam211#3;

      |ABRE #dscam212;
      #dscam212#0 = #dscam003#40;
      #dscam212#1 = #dscam211#0;
      |LEE 101#dscam212.=;
      |SI FSalida = 0;
         |BORRA 020#dscam212.a; |LIBERA #dscam212;
      |FINSI;
      |CIERRA #dscam212;
   |SINO;
      |ABRE #dscam212;
      #dscam212#0 = #dscam003#40;
      #dscam212#1 = #dscam211#0;
      |LEE 000#dscam212.=;
      |SI FSalida ! 0;
         |DDEFECTO #dscam212;
         #dscam212#0 = #dscam003#40;
         #dscam212#1 = #dscam211#0;
         #dscam212#2 = #dscam210#3;
         #dscam212#3 = #dscam211#8;
         |GRABA 020#dscam212.n;
      |FINSI;
      |CIERRA #dscam212;
   |FINSI;
|FPRC;

|PROCESO Recibos;
   #dscaw106#0  = #dscam003#33;
   #dscaw106#1  = #dscam003#0;
   #dscaw106#2  = #dscam003#1;
   #dscaw106#3  = #dscam003#2;
   #dscaw106#4  = #dscam003#4;
   #dscaw106#18 = #dscam003#40;
   |LEE 000#dscaw106.=;
   |SI FSalida ! 0;
      |DDEFECTO #dscaw106;
      #dscaw106#0  = #dscam003#33;
      #dscaw106#1  = #dscam003#0;
      #dscaw106#2  = #dscam003#1;
      #dscaw106#3  = #dscam003#2;
      #dscaw106#4  = #dscam003#4;
      #dscaw106#5  = #dscam003#80;
      #dscaw106#6  = #dscam003#81;
      #dscaw106#7  = nNumRecs;
      #dscaw106#8  = #dscam003#32;
      #dscaw106#9  = #dscam003#6;
      #dscaw106#10 = #dscam211#7;
      #dscaw106#11 = #dscam211#6;
      #dscaw106#12 = #dscam003#3;
      #dscaw106#13 = #dscam003#26;
      #dscaw106#14 = #dscam003#15;
      #dscaw106#15 = #dscam003#30;
      #dscaw106#17 = #dscam211#10;
      #dscaw106#18 = #dscam211#11;
      |GRABA 020#dscaw106.c;

      || Calculo el n§ de recibos .....
      nNumRecs = 0;
      #dscaw106#0  = #dscam003#33;
      #dscaw106#1  = #dscam003#0;
      #dscaw106#2  = #dscam003#1;
      #dscaw106#3  = 0;
      #dscaw106#4  = "01.01.0000";
      #dscaw106#18 = 1;
      |LEE 000#dscaw106.];
      |PARA; |SI FSalida = 0; |Y #dscaw106#0 = #dscam003#33;
       |Y #dscaw106#1 = #dscam003#0; |Y #dscaw106#2 = #dscam003#1; |HACIENDO;
         |SI #dscaw106#4 = #dscam003#4; nNumRecs = nNumRecs + 1; |FINSI;
         |LEE 000#dscaw106.s;
      |SIGUE;

      || Grabo el n§ de recibos .....
      #dscaw106#0  = #dscam003#33;
      #dscaw106#1  = #dscam003#0;
      #dscaw106#2  = #dscam003#1;
      #dscaw106#3  = 0;
      #dscaw106#4  = "01.01.0000";
      #dscaw106#18 = 1;
      |LEE 000#dscaw106.];
      |PARA; |SI FSalida = 0; |Y #dscaw106#0 = #dscam003#33;
       |Y #dscaw106#1 = #dscam003#0; |Y #dscaw106#2 = #dscam003#1; |HACIENDO;
         |SI #dscaw106#4 = #dscam003#4;
            #dscaw106#7  = nNumRecs;
            |GRABA 020#dscaw106.a;
         |FINSI;
         |LEE 000#dscaw106.s;
      |SIGUE;
   |FINSI;
|FPRC;

|DEFBUCLE Recibos;
   #dscam003#9;
   4;
   00, #dscam211#2, #dscam211#3, 000, 000000001, #dscam211#5;
   00, #dscam211#2, #dscam211#3, 999, 999999999, #dscam211#5;
   ;
   NULL, Recibos;
|FIN;

|PROCESO PreparaTmps;
   |DBASS aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "dscomer9/def/agifa134.mas";
   |CARGA_DEF aAlfa, agif134@;
   |SI FSalida = 0;
      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dscomer9/def/agifa084.mas";
      |CARGA_DEF aAlfa, agif084@;

      aAlfa1 = nCodEmpresa; |QBF aAlfa1; aAlfa1 = (("00000" + aAlfa1) % -105)
      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dscomer9/fich/" + aAlfa1 + "/";
      |PATH_DAT #agif134@#aAlfa#; |PATH_DAT #agif084@#aAlfa#;
      |ABRE #agif134@; |ABRE #agif084@;

      |SELECT #1#dscam003;
      #dscam003#40 = #dscam211#11;
      |LEE 000#dscam003.=;
      |SI FSalida = 0;
         |HAZ Recibos;
      |FINSI;

      |CIERRA #agif084@; |DESCARGA_DEF #agif084@;
      |CIERRA #agif134@; |DESCARGA_DEF #agif134@;
   |FINSI;
|FPRC;

|DEFBUCLE PreparaTmps;
#dscam211#1;
;
#dscam210#0, 00001;
#dscam210#0, 99999;
;
NULL, PreparaTmps;
|FIN;

|PROCESO Imprime;
   |SI #dscaw106#13 ! "01.01.0000"; |O #dscaw106#14 ! "T";
      |PRINT;
   |FINSI;
|FPRC;

|DEFBUCLE Imprime;
#dscaw106#1;
;
INICIO;
FINAL;
;
NULL, Imprime;
|FIN;

|PROCESO Tipo4; |TIPO 4;
   |ABRE #dscam003;
   aAlfa = "l1" + Usuario;  |NOME_DAT #dscaw105#aAlfa#;
   aAlfa = "l2" + Usuario;  |NOME_DAT #dscaw106#aAlfa#;
   |DELINDEX #dscaw105; |ABRE #dscaw105;
   |DELINDEX #dscaw106; |ABRE #dscaw106;

   eaTitulo = "LIQUIDACION N§ " + (("00000" + #dscam210#0) % -105);

   |DDEFECTO #dscaw105;
   #dscaw105#0 = #dscam210#1;
   #dscaw105#1 = #dscam210#2;
   #dscaw105#2 = #dscam210#3;
   |GRABA 020#dscaw105.n;

   |BUCLE PreparaTmps;

   Impresora = "CrystalReport";
   |IMPRE -1;
   |SI FSalida = 0;
      |INFOR "dscaz194";
      |SI FSalida = 0;
         |BUCLE Imprime;
         |PIEINF; |FININF;
      |FINSI;
      |FINIMP;
   |FINSI;

   |CIERRA #dscam003;
   |CIERRA #dscaw105; |DELINDEX #dscaw105;
   |CIERRA #dscaw106; |DELINDEX #dscaw106;
|FPRC;

|PROCESO Tipo7; |TIPO 7;
   nModo = (FEntrada / 100) ! 0;
   |SI nModo ! 1; |ACABA; |FINSI;

   nCalc = 1;
   |LEE 000#dscam210.u;
   |SI FSalida = 0; nCalc = #dscam210#0 + 1; |FINSI;

   |DDEFECTO #dscam210;
   #dscam210#0 = nCalc; |PINTA #dscam210#0;
|FPRC;

|PROCESO BorraDocs;
   |BORRA 020#dscam212.a;
|FPRC;

|DEFBUCLE BorraDocs;
#dscam212#1;
;
000000001, #dscam210#0;
999999999, #dscam210#0;
be;
NULL, BorraDocs;
|FIN;

|PROCESO InitRecs;
   |SI nNumLiqAnt > 0;
      |SI aEstadoAnt = "F"; #dscam003#35 = "LIQ"; |FINSI;
      |SI aEstadoAnt = "I"; #dscam003#35 = "IMP"; |FINSI;
      #dscam003#36 = "Liquidaci¢n n." + (("00000" + nNumLiqAnt) % -105);
   |SINO;
      #dscam003#35 = "";
      #dscam003#36 = "";
   |FINSI;
   |GRABA 020#dscam003.a;
|FPRC;

|DEFBUCLE InitRecs;
#dscam003#9;
;
00, #dscam211#2, #dscam211#3, 000, 000000001;
00, #dscam211#2, #dscam211#3, 999, 999999999;
;
NULL, InitRecs;
|FIN;

|PROCESO BorraLiqu;
   nNumLiqAnt = 0; aEstadoAnt = "";
   |DDEF aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dscam211.mas";
   |CARGA_DEF aAlfa, dscm211@;
   |SI FSalida = 0;
      nCalc = 0;
      |DFICE aAlfa; |PATH_DAT #dscm211@#aAlfa#;
      |ABRE #dscm211@;
      |SELECT #3#dscm211@;
      |DDEFECTO #dscm211@;
      #dscm211@#2 = #dscam211#2;
      #dscm211@#3 = #dscam211#3;
      |LEE 000#dscm211@.];
      |PARA; |SI FSalida = 0; |Y #dscm211@#2 = #dscam211#2; |Y #dscm211@#3 = #dscam211#3; |HACIENDO;
         |SI #dscm211@#4 ! 0;
            |SI #dscm211@#4 = #dscam211#4; |Y #dscm211@#0 < #dscam211#0;
               nNumLiqAnt = #dscm211@#0; aEstadoAnt = #dscm211@#8;
            |FINSI;
            |SI #dscm211@#4 = #dscam211#4; |Y #dscm211@#0 > #dscam211#0;
               nNumLiqAnt = -1; |SAL;
            |FINSI;
         |SINO;
            |SI #dscm211@#0 < #dscam211#0; nNumLiqAnt = #dscm211@#0; aEstadoAnt = #dscm211@#8; |FINSI;
            |SI #dscm211@#0 > #dscam211#0; nNumLiqAnt = -1; |SAL; |FINSI;
         |FINSI;
         |LEE 000#dscm211@.s;
      |SIGUE;
      |SELECT #1#dscm211@;
      |CIERRA #dscm211@; |DESCARGA_DEF #dscm211@;
   |FINSI;

   |SI nNumLiqAnt < 0; |ERROR10; |ACABA; |FINSI;

   |ABRE #dscam003;
   #dscam003#40 = #dscam211#11;
   |LEE 000#dscam003.=;
   |SI FSalida = 0;
      |SI nNumLiqAnt > 0;
         |SI aEstadoAnt = "F"; #dscam003#35 = "LIQ"; |FINSI;
         |SI aEstadoAnt = "I"; #dscam003#35 = "IMP"; |FINSI;
         #dscam003#36 = "Liquidaci¢n n." + (("00000" + nNumLiqAnt) % -105);
      |SINO;
         #dscam003#35 = "";
         #dscam003#36 = "";
      |FINSI;
      |GRABA 020#dscam003.a;
   |FINSI;
   |CIERRA #dscam003;
|FPRC;

|DEFBUCLE BorraLiqu;
#dscam211#1;
;
#dscam210#0, 00001;
#dscam210#0, 99999;
;
NULL, BorraLiqu;
|FIN;

|PROCESO CompruebaLins;
   |DDEFECTO #dscm211@;
   #dscm211@#11 = #dscam211#11;
   |LEE 000#dscm211@.];
   |PARA; |SI FSalida = 0; |Y #dscm211@#11 = #dscam211#11; |HACIENDO;
      |SI #dscm211@#0 < #dscam211#0;
         nNumLiqAnt = #dscm211@#0;  aEstadoAnt = #dscm211@#8;
      |FINSI;
      |SI #dscm211@#0 > #dscam211#0;
         nNumLiqAnt = -1; |SAL;
      |FINSI;
      |LEE 000#dscm211@.s;
   |SIGUE;
   |SI nNumLiqAnt < 0; |ERROR10; |FINSI;
|FPRC;

|DEFBUCLE CompruebaLins;
#dscam211#1;
;
#dscam210#0, 001;
#dscam210#0, 999;
;
NULL, CompruebaLins;
|FIN;

|PROCESO Tipo1; |TIPO 1;
   nModo = (FEntrada / 100) ! 0;
   |SI nModo ! 3; |ACABA; |FINSI;

   || Primero hay que comprobar si hay alguna linea que aparezca en liquidaciones posteriores. Si es así, no podemos dar de baja la liquidacion
   nNumLiqAnt = 0; aEstadoAnt = "";
   |DDEF aAlfa; |QBF aAlfa; aAlfa = aAlfa + "dscam211.mas";
   |CARGA_DEF aAlfa, dscm211@;
   |SI FSalida = 0;
      nCalc = 0;
      |DFICE aAlfa; |PATH_DAT #dscm211@#aAlfa#;
      |ABRE #dscm211@; |SELECT #4#dscm211@;
      |BUCLE CompruebaLins;
      |SELECT #1#dscm211@;
      |CIERRA #dscm211@; |DESCARGA_DEF #dscm211@;
   |FINSI;

   |SI nNumLiqAnt < 0;
      |MENAV "    Existen liquidaciones posteriores. No se puede eliminar la liquidacion.";
      |ERROR; |ACABA;
   |FINSI;

   |BUCLE BorraDocs;
|FPRC;

|PROCESO ModifRep; |TIPO 7;
   nModo = (FEntrada / 100) ! 0;
   |SI nModo = 2;
      |C_M #dscam210#1, 1, "N";
   |SINO;
      |C_M #dscam210#1, 1, "S";
   |FINSI;
|FPRC;
