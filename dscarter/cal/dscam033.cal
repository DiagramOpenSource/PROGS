|FICHEROS;
   dscam033 #0;
   dscam034 #1;
   dscam031 #2,MANTE;
   dscam032 #3,MANTE;
   dscam029 #4;

   dscaw013 #5,MANTE;

   dscaw011 #7;
   dscaw012 #8;

   FMaster@ #9;
   FEsclav@ #10;
   Referen@ #11;
   ReferCb@ #12;
   Princip@ #16;

   dscam030 #13;
   dscam036 #14,MANTE;
   dscam051 #15;
   dscam067 #17;
   dscam068 #18;
   dscam094 #19;

   canempr@ #20;
   caenlac@ #23;
   caconas@ #24;
   camoned@ #25;
   camasic@ #26;
   camasil@ #27;
   caivm01@ #28;
   caivm02@ #29;
   caconta@ #30;
   Tempo00@ #60;

   dscam013 #100;
   dscam044 #101;
   dscam045 #102;
   dscam159 #103;
   dscam172 #104,MANTE;
   dscam173 #105,MANTE;
   dscam174 #106,MANTE;

   RefDato@  #500;
   refere1@  #501;
   Refere2@  #502;
   RefeDef@  #503;
   Refere3@  #504;

   dscam004  #1000;
   dscaw103  #1001;
   dscaw109  #1002;
   dscaw137  #1003;
   dscam107  #107;

   dscaw231 #231;
|FIN;

|VARIABLES;
   aEsCobro = "";
   nContaErr = 0;
   aClave = "";

   nReg = 0;
   &nDeci_nDec = 0;
   &PRMNT_Init    = 0;
   &PRMNT_enError = 0;
   &PRMNT_enVer   = 0;
   &enNumRegs = 0;
   &eaCodEnlace = "";
   &enNoModif   = 0;
   &enGenAsi0 = 0;
   &enGenIva0 = 0;
   &efFechaExt = @;

   &enSinConfi = 0;

   &Fichero = ""; &Tipo = ""; &Cmp = ""; &CmpNum = 0;
   &eaUsuario = ""; &enImpAnt = 0;  &enImpAct = 0;  &eaDescr = "";
   &eaTipoReg = ""; &eaNumero = ""; &eaTipoOp = ""; &eaFicher = ""; &eaClave = "";
   &nDeci_Base = 6; &nDeci_Div = 6; &eaLlamada = ""; &enEmpCartera = 0;

   &eaCtaAn = "";
   &eaEntrada = "";
   &eaSalida  = "";
   &eaVarLog  = "";

   nMenosUno = 0;
   nNumLinea = 0;

   Base       = 0;
   Div        = 0;
   CmpEntidad = 0;
   CmpNumero  = 0;
   nHandle    = 0;
   &enHandLog = 0;
   nAvisoPer  = 0;
   nContDi    = 0;
   nContAs    = 0;
   nEmpresa   = 0;
   nPeriodo   = 0;
   nErrContador = 0;
   nSigue     = 0;
   nCmpSec    = 0;
   nSwHay     = 0;
   nSwFueraEj = 0;
   nSwAcot    = 0;
   nSwPath    = 0;

   nSwNuevoHisEnl = 0;

   nEmprEnl   = 0;
   nPeriEnl   = 0;

   fContFe    = @;
   fFecha     = @;
   fFechaIva  = @;
   nEmpr = 0; nPeri = 0; nSwError = 0;
   nEmpre = 0; nPerio = 0;
   CmpEmp = 0; CmpPer = 0;
   nMarca = 0;

   fFechaEje = @;
   fFechaIni = @;
   fFechaFin = @;

   nCmp    = 0; aCmpClv = ""; aFiltro = "";

   aCampo1 = ""; aCampo2 = ""; aCampo3 = "";
   aCampo4 = ""; aCampo5 = ""; aCampo6 = "";

   fFechaLog = @; aAlfaLog1 = ""; aAlfaLog2 = ""; aLogTitulo = "";
   &aNombreLog = "";

   aAlfaX1   = "";
   aAlfaX2   = "";
   aAlfaX3   = "";
   aCond1    = "";
   aCond2    = "";
   aOperCond = "";

   nDiarioAs = 0;
   fFechaAs  = @;
   nNumDocAs = 0;
   nSwAna    = 0;
   nSwEmpr   = 0;

   aOpAnt    = ""; nDgAnt = 0;

   SwAsiento = 0; aResp = ""; Depart = ""; nSw = 0; aMensaje = "";
   Direc    = ""; MarcaPant = "|"; aAlfa = ""; aAlfa1 = ""; aAlfa2 = ""; aAlfa3 = "";
   aAlfa4   = ""; aAlfa5   = ""; aAlfa6   = "";
   aExpresion = ""; nSwCondic = 0;
   aParte1  = ""; aParte2  = "";
   nParte1  = 0;  nParte2  = 0;
   nVersion = 0;  aCampos = "";
   DComodin = ""; HComodin  = ""; Ref = ""; Mast = "";
   Comodin  = ""; PathAplic = ""; Fichero1 = ""; PathDatos = "";
   Comodin1 = ""; ComFecha = @;
   Comodin2 = ""; FechaVto = ""; FechaAbo = "";
   ComodNum = 0;  TipoEnl = "";   aNome = "";
   Calc = 0; Calc1 = 0; Calc2 = 0; Cont = 0; Cont1 = 0; Cont2 = 0;
   aLong = ""; nLong = 0;
   Oper1 = 0; Oper2 = 0;
   Operacion = ""; Mensaje = "";
   Resultado = 0; nCont = 0; SwError = 0; CmpOrden = "";

   nNumero = 0; Caracter = "";
   nCalc = 0; nCalc1 = 0; nCalc2 = 0; FEstado = 0; aEstado = "";
   nCalc3 = 0; nCalc4 = 0; nCalc5 = 0;

   Diario = 0; Fecha = 0; Docum = 0; nAsient = 0;
   Cuenta = ""; Descr = ""; Cadena = ""; nImporte = 0;
   UltimoAsiento = 0;
   UltimoApunte  = 0;
   nCampoAlfa = 0;

   TipoDato = ""; LongDato = 0; nSerie = 0; aSerie = "";
   aTipoSerie = "";
   aFichero   = "";

   Fich = ""; LinRel = 0; Fich1 = "";
   Camp = ""; SwCondic = 0;
   nEmp = 0; nPer = 0; nEje = 0; nAnyo = 0;

   Salir = 0; Opcion = 0;

   &CodEnlace = ""; CmpContab = 0; CmpRegist = 0;

   PosicAPar = 0;  PosicCPar = 0;
   Cad1 = ""; Cad2 = "";
   Neg = 0; Modo = "";
   &fich_alta = "";

   NumAsientos = 0; NVuelta = 0; NumRegistro = 0; TotalRegs = 0;

   NomFich = ""; NumCmps = 0; FichRelac = ""; NombreRel = "";
   NumCmps1 = 0; NumCmps2 = 0;

   Clave1 = ""; Clave2 = "";
   CmpClave1 = 0; CmpClave2 = 0;

   Empresa = 0; Periodo = 0; PathEnlace = ""; Tecla = 0;

   CmpDebe  = 0; CmpHaber = 0; CmpSaldo = 0;
   TotDebe  = 0; TotHaber = 0; TotSaldo = 0;
   SwNivel = 0; Nivel = 0; UltDocum = 0;
   Dig1 = 0; Dig2 = 0; Dig3 = 0; Dig4 = 0; Dig5 = 0; Dig6 = 0;

   DigFormat = 0;
   NumReg = 0;
   nSwAnula = 0;

   aFichCorreo = "";
   aDsCorreoIP = "";
   aDirOrigen  = "";
   aDirDestino = "";
   aServidor   = "";
   aAsunto     = "";
   aTexto      = "";

   UltFecha  = @;
   UltRecibo = 0;
   UltEmpr   = 0;
   UltPeri   = 0;
   ReciboAct = 0;

   CmpClave1Cab = 0; CmpClave2Cab = 0;

   NumApunte = 1; NumAsto = 0;

   Libro = 0; Factura = 0; Recibo = 0;
   FichEsclavo = ""; FichMaster = ""; Marca = 0;
   aCuentaAn = "";

   &EURO = 1; &EURODB = 0; &EURODV = 0;

{-1}Menu  = "";
    Menu1 = "2400";
    Menu2 = "1";
    Menu3 = "";
    Menu4 = "REC";
    Menu5 = " Revisar ";
    Menu6 = " Enlazar ";
    Menu7 = " Cancelar ";

    nNumFicheros = 7;

{-1}TiposEnlaces  = "";
    TiposEnlaces1 = "CB";
    TiposEnlaces2 = "PG";
    TiposEnlaces3 = "RM";
    TiposEnlaces4 = "PA";
    TiposEnlaces5 = "TA";
    TiposEnlaces6 = "CF";
    TiposEnlaces7 = "PD";

{-1}Ficheros  = "";
    Ficheros1 = "dscam004";   || Lineas de cobros de recibos
    Ficheros2 = "dscam009";   || Lineas de pagos de recibos
    Ficheros3 = "dscam013";   || Lineas de remesas
    Ficheros4 = "dscam022";   || Lineas de pagares
    Ficheros5 = "dscam047";   || Lineas de talones
    Ficheros6 = "dscam050";   || Lineas de confirmes
    Ficheros7 = "dscam096";   || Lineas de pagos domiciliados

{-1}Moneda  = 0;
    Moneda1 = 57;
    Moneda2 = 59;
    Moneda3 = 0;
    Moneda4 = 18;
    Moneda5 = 18;
    Moneda6 = 16;
    Moneda7 = 0;

{-1}nAsiento  = 0;
    nAsiento1 = 34;
    nAsiento2 = 27;
    nAsiento3 = 24;
    nAsiento4 = 24;
    nAsiento5 = 19;
    nAsiento6 = 21;
    nAsiento7 = 24;

{-1}nAstoEmi  = 0;
    nAstoEmi1 = 34;
    nAstoEmi2 = 27;
    nAstoEmi3 = 24;
    nAstoEmi4 = 24;
    nAstoEmi5 = 19;
    nAstoEmi6 = 21;
    nAstoEmi7 = 24;

{-1}nAstoVto = 0;
    nAstoVto1 = 0;
    nAstoVto2 = 0;
    nAstoVto3 = 31;
    nAstoVto4 = 30;
    nAstoVto5 = 0;
    nAstoVto6 = 27;
    nAstoVto7 = 31;

{-1}nAstoAbo = 0;
    nAstoAbo1 = 0;
    nAstoAbo2 = 0;
    nAstoAbo3 = 31;
    nAstoAbo4 = 30;
    nAstoAbo5 = 0;
    nAstoAbo6 = 27;
    nAstoAbo7 = 31;

{-1}Campo1Clave  = 0;
    Campo1Clave1 = 17;
    Campo1Clave2 = 14;
    Campo1Clave3 = 0;
    Campo1Clave4 = 0;
    Campo1Clave5 = 0;
    Campo1Clave6 = 0;
    Campo1Clave7 = 0;

{-1}Campo2Clave  = 0;
    Campo2Clave1 = 3;
    Campo2Clave2 = 3;
    Campo2Clave3 = 1;
    Campo2Clave4 = 1;
    Campo2Clave5 = 1;
    Campo2Clave6 = 1;
    Campo2Clave7 = 1;

{-1}CmpEmpresa  = 0;
    CmpEmpresa1 = 38;
    CmpEmpresa2 = 31;
    CmpEmpresa3 = 28;
    CmpEmpresa4 = 28;
    CmpEmpresa5 = 23;
    CmpEmpresa6 = 25;
    CmpEmpresa7 = 28;

{-1}CmpPeriodo  = 0;
    CmpPeriodo1 = 39;
    CmpPeriodo2 = 32;
    CmpPeriodo3 = 29;
    CmpPeriodo4 = 29;
    CmpPeriodo5 = 24;
    CmpPeriodo6 = 26;
    CmpPeriodo7 = 29;

{-1}Fechas  = 0;
    Fechas1 = 6;
    Fechas2 = 6;
    Fechas3 = 1;
    Fechas4 = 1;
    Fechas5 = 1;
    Fechas6 = 1;
    Fechas7 = 1;

{-1}FecEmi  = 0;
    FecEmi1 = 6;
    FecEmi2 = 6;
    FecEmi3 = 1;
    FecEmi4 = 1;
    FecEmi5 = 1;
    FecEmi6 = 1;
    FecEmi7 = 1;

{-1}FecVto  = 0;
    FecVto1 = 6;
    FecVto2 = 6;
    FecVto3 = 1;
    FecVto4 = 2;
    FecVto5 = 1;
    FecVto6 = 2;
    FecVto7 = 2;

{-1}FecAbo  = 0;
    FecAbo1 = 6;
    FecAbo2 = 6;
    FecAbo3 = 1;
    FecAbo4 = 2;
    FecAbo5 = 1;
    FecAbo6 = 2;
    FecAbo7 = 2;

{-1}CmpEnlace  = 0;
    CmpEnlace1 = 20;
    CmpEnlace2 = 18;
    CmpEnlace3 = 19;
    CmpEnlace4 = 16;
    CmpEnlace5 = 16;
    CmpEnlace6 = 18;
    CmpEnlace7 = 19;

{-1}Serie  = 0;
    Serie1 = 0;   || Lineas de cobros de recibos
    Serie2 = 0;   || Lineas de pagos de recibos
    Serie3 = 4;   || Lineas de remesas
    Serie4 = 4;   || Lineas de pagares
    Serie5 = 4;   || Lineas de talones
    Serie6 = 4;   || Lineas de confirmes
    Serie7 = 4;   || Lineas de pagos domiciliados

{-1}FichCab  = "";
    FichCab1 = "dscam003";   || Cobros de recibos
    FichCab2 = "dscam008";   || Pagos de recibos
    FichCab3 = "dscam012";   || Remesas
    FichCab4 = "dscam021";   || Pagares
    FichCab5 = "dscam046";   || Talones
    FichCab6 = "dscam049";   || Confirmes
    FichCab7 = "dscam095";   || Pagos domiciliados

{-1}ClaveCab  = 0;
    ClaveCab1 = 40;
    ClaveCab2 = 40;
    ClaveCab3 = 0;
    ClaveCab4 = 0;
    ClaveCab5 = 0;
    ClaveCab6 = 0;
    ClaveCab7 = 0;

{-1}EmpresCab  = 0;
    EmpresCab1 = 44;
    EmpresCab2 = 44;
    EmpresCab3 = 20;
    EmpresCab4 = 21;
    EmpresCab5 = 21;
    EmpresCab6 = 20;
    EmpresCab7 = 20;

{-1}PeriodCab  = 0;
    PeriodCab1 = 45;
    PeriodCab2 = 45;
    PeriodCab3 = 21;
    PeriodCab4 = 22;
    PeriodCab5 = 22;
    PeriodCab6 = 21;
    PeriodCab7 = 21;

{-1}EmprEmi  = 0;
    EmprEmi1 = 38;
    EmprEmi2 = 31;
    EmprEmi3 = 28;
    EmprEmi4 = 28;
    EmprEmi5 = 23;
    EmprEmi6 = 25;
    EmprEmi7 = 25;

{-1}PeriEmi  = 0;
    PeriEmi1 = 39;
    PeriEmi2 = 32;
    PeriEmi3 = 29;
    PeriEmi4 = 29;
    PeriEmi5 = 24;
    PeriEmi6 = 26;
    PeriEmi7 = 26;

{-1}EnlEmi  = 0;
    EnlEmi1 = 20;
    EnlEmi2 = 18;
    EnlEmi3 = 19;
    EnlEmi4 = 16;
    EnlEmi5 = 16;
    EnlEmi6 = 18;

{-1}EmprAbo  = 0;
    EmprAbo1 = 38;
    EmprAbo2 = 31;
    EmprAbo3 = 28;
    EmprAbo4 = 28;
    EmprAbo5 = 23;
    EmprAbo6 = 25;
    EmprAbo7 = 25;

{-1}PeriAbo  = 0;
    PeriAbo1 = 39;
    PeriAbo2 = 32;
    PeriAbo3 = 29;
    PeriAbo4 = 29;
    PeriAbo5 = 24;
    PeriAbo6 = 26;
    PeriAbo7 = 26;

{-1}EnlAbo  = 0;
    EnlAbo1 = 20;
    EnlAbo2 = 18;
    EnlAbo3 = 19;
    EnlAbo4 = 16;
    EnlAbo5 = 16;
    EnlAbo6 = 18;
    EnlAbo7 = 19;

{-1}EmprVto  = 0;
    EmprVto1 = 38;
    EmprVto2 = 31;
    EmprVto3 = 35;
    EmprVto4 = 34;
    EmprVto5 = 23;
    EmprVto6 = 31;
    EmprVto7 = 31;

{-1}PeriVto  = 0;
    PeriVto1 = 39;
    PeriVto2 = 32;
    PeriVto3 = 36;
    PeriVto4 = 35;
    PeriVto5 = 24;
    PeriVto6 = 32;
    PeriVto7 = 32;

{-1}EnlVto  = 0;
    EnlVto1 = 20;
    EnlVto2 = 18;
    EnlVto3 = 30;
    EnlVto4 = 36;
    EnlVto5 = 16;
    EnlVto6 = 33;
    EnlVto7 = 33;

{-1}Departamento  = 0;
    Departamento1 = -1; || 11;
    Departamento2 = -1; || 10;
    Departamento3 = -1;
    Departamento4 = -1;
    Departamento5 = -1;
    Departamento6 = -1;
    Departamento7 = -1;

{-1}Contabil = 0;
    Contabil1 = -1;
    Contabil2 = -1;
    Contabil3 = 9;
    Contabil4 = 8;
    Contabil5 = 8;
    Contabil6 = 8;
    Contabil7 = 8;
|FIN;

|PROCESO LogErrConta;
     |ABRE #107;
     |LEE 000#107u;
     |SI FSalida = 0;
          nReg = #107#0 + 1;
     |SINO;
          nReg = 1;
     |FINSI;
     #107#0 = nReg;
     aAlfa = Usuario % 810;
     #107#1 = aAlfa;
     #107#2 = ~;
     |HORA aAlfa;
     #107#3 = aAlfa;
     #107#4 = NumAsientos;
     #107#5 = #caenlac@#0;
     #107#6 = #caenlac@#1;
     #107#7 = NumAsientos;
     |GRABA 020#107n;
     |CIERRA #107;
|FPRC;

|PROCESO EnviaCorreo;
   |DFICE aFichCorreo; |QBF aFichCorreo;
   aFichCorreo = aFichCorreo + "tmp/" + Usuario + ".spo";

   aAlfa = #dscam051#81; |QBF aAlfa;
   aAlfa = aAlfa + "." + #dscam051#82; |QBF aAlfa;
   aAlfa = aAlfa + "." + #dscam051#83; |QBF aAlfa;
   aAlfa = aAlfa + "." + #dscam051#84; |QBF aAlfa;
   |SI aAlfa = "0.0.0.0"; |ACABA; |FINSI;

   aDsCorreoIP = aAlfa;
   aDirOrigen  = #dscam051#90;
   aDirDestino = #dscam051#91;
   aServidor   = #dscam051#88; |QBF aServidor;
   aAsunto     = " Salida de pantalla de enlace contable ";
   aTexto      = "$$$$" + aFichCorreo;
   |SI #dscam051#89 = "S";
      eaEntrada = #dscam051#92; |HAZ Encriptado;
      aAlfa = eaSalida;             |QBF aAlfa; aAlfa = aAlfa + ":";
      aAlfa = aAlfa + #dscam051#86; |QBF aAlfa; aAlfa = aAlfa + ":";
      aDirOrigen = aAlfa + aDirOrigen;
   |FINSI;

   |DSCORREO_ENVIA aDsCorreoIP, aServidor, aDirOrigen, aDirDestino, aAsunto, aTexto, aFichCorreo;
   |SI FSalida < 0;
      aLogTitulo = "Problemas al enviar correo"; |HAZ ApuntaLog;
   |FINSI;
|FPRC;

|RUTINA inferior;
   #dscam034#0 = 00;
   #dscam034#1 = "01.01.1900";
   #dscam034#2 = 000001;
   #dscam034#3 = 0001;
   #dscam034#12 = 0;
   #dscam034#13 = 0;
|FRUT;

|RUTINA superior;
   #dscam034#0 = 99;
   #dscam034#1 = "31.12.2900";
   #dscam034#2 = 999999;
   #dscam034#3 = 9999;
   #dscam034#12 = 99999;
   #dscam034#13 = 9;
|FRUT;

|PROCESO TomaDatos;

/*
   Si se le pasa en la variable 'Fich' el nombre del fichero del que quieres
   extraer el dato y en la variable 'Cmp' el numero del campo, devuelve en la
   variable 'Comodin' el valor correspondiente
*/
   nCampoAlfa = 0;

   #dscaw012#0 = Fich;
   #dscaw012#1 = Camp;
   |LEE 000#dscaw012.=;
   |SI FSalida = 0;
      |SI #dscaw012#2 = "A"; nCampoAlfa = 1; Comodin = #dscaw012#3; |FINSI;
      |SI #dscaw012#2 = "N";                 Comodin = #dscaw012#4; |FINSI;
      |SI #dscaw012#2 = "F"; nCampoAlfa = 1; Comodin = #dscaw012#5; |FINSI;
   |SINO;
      |SI SwError = 0;
         |SI enSinConfi = 0;
            aAlfa = "    Hay campos inexistentes en la relaccion de conceptos a enlazar ([" + Fich + "][" + Camp + "])";
            |MENAV aAlfa;
         |SINO;
            aLogTitulo = "    Hay campos inexistentes en la relaccion de conceptos a enlazar ([" + Fich + "][" + Camp + "])";
            |HAZ ApuntaLog;   |XGRABA enHandLog, aLogTitulo;
         |FINSI;

         SwError = 1;
      |FINSI;
      |ACABA;
   |FINSI;

   |SI DigFormat ! 0;
      |SI DigFormat < 0;
         DigFormat = 0 - DigFormat;
         |SI #dscaw012#2 = "N";
            Comodin1 = "0" * DigFormat;
            |QBF Comodin;
            Calc = 0 - (100 + DigFormat);
            Comodin = (Comodin1 + Comodin) % Calc;
         |FINSI;
         |SI #dscaw012#2 = "A";
            Comodin1 = " " * DigFormat;
            |QBF Comodin;
            Calc = 0 - (100 + DigFormat);
            Comodin = (Comodin1 + Comodin) % Calc;
         |FINSI;
      |SINO;
         |SI #dscaw012#2 = "N";
            Comodin1 = "0" * DigFormat;
            |QBF Comodin;
            Calc = 0 - (100 + DigFormat);
            Comodin = (Comodin1 + Comodin) % Calc;
         |FINSI;
         |SI #dscaw012#2 = "A";
            Comodin1 = " " * DigFormat;
            Calc = 100 + DigFormat;
            Comodin = (Comodin + Comodin1) % Calc;
         |FINSI;
      |FINSI;
   |SINO;
      |QBF Comodin;
   |FINSI;

|FPRC;

|PROCESO BuscaPeriodo;
   nPeriodo = -1;
   Fichero = "Empresas"; Tipo = "C"; Cmp = "Codigo Empresa"; |HAZ ObtenDato; nEmp = CmpNum;
   Fichero = "Empresas"; Tipo = "C"; Cmp = "Periodo";        |HAZ ObtenDato; nPer = CmpNum;
   Fichero = "Empresas"; Tipo = "C"; Cmp = "Ejercicio";      |HAZ ObtenDato; nEje = CmpNum;
   #canempr@#nEmp# = #dscam030#4;
   #canempr@#nPer# = 0;
   |LEE 000#canempr@.];
   |PARA; |SI FSalida = 0; |Y #canempr@#nEmp# = #dscam030#4; |HACIENDO;
      nCalc = #canempr@#nEje#;
      |SI nCalc ] 80; nCalc = nCalc + 1900; |SINO; nCalc = nCalc + 2000; |FINSI;
      nCalc = #canempr@#26;
      |SI nCalc > 80; nCalc = nCalc + 1900; |SINO; nCalc = nCalc + 2000; |FINSI;
      aAlfa = "01." + (("00" + #canempr@#11) % -102) + "." + nCalc;       fFechaIni = aAlfa;
      nCalc = nCalc + 1;
      nCalc1 = #canempr@#12 + 1;
      |SI nCalc1 > 12; nCalc1 = 1; |FINSI;
      aAlfa = "01." + (("00" + nCalc1) % -102) + "." + nCalc; fFechaFin = aAlfa;
      nCalc1 = fFechaFin; nCalc1 = nCalc1 - 1; fFechaFin = nCalc1;
      |SI fFechaIni [ fFechaEje; |Y fFechaEje [ fFechaFin;
         nPeriodo = #canempr@#nPer#; |SAL;
      |FINSI;
      |LEE 000#canempr@.s;
   |SIGUE;
|FPRC;

|PROCESO CondValores;
   Cadena = Cadena + #dscam174#4; |QBF Cadena;
|FPRC;

|DEFBUCLE CondValores;
#dscam174#1;
;
#dscam173#0, #dscam173#1, #dscam173#2, 001;
#dscam173#0, #dscam173#1, #dscam173#2, 999;
;
NULL,CondValores;
|FIN;

|PROCESO LinsCondMemo;
   Cadena = #dscam173#3; |QBF Cadena;
   |SI Cadena ! "";
      |HAZ ResolCondicion;
   |SINO;
      Resultado = 1;
   |FINSI;
   || Si la condicion se cumple, recojo las expresiones que determinaran
   ||    el valor de la memoria .... si no se cumple continuo
   Cadena = "";
   |SI Resultado = 1;
      |BUCLE CondValores;
      |HAZ ResuelveExpr;
      |ERROR10;
   |FINSI;
|FPRC;

|DEFBUCLE LinsCondMemo;
#dscam173#1;
;
#dscam172#0, #dscam172#1, 001
#dscam172#0, #dscam172#1, 999;
;
NULL,LinsCondMemo;
|FIN;

|PROCESO dscam032a;

/*
   Consta de tres partes :
    1 - Se resuelve la expresion o se recoge el valor fijo que se indico como
        la cuenta que ira referida a la linea que estamos tratando.
    2 - Resolvera la expresion indicada para usar como descripcion en la
        linea del asiento
    3 - Se resolvera el importe del asiento en base a la cantidad o la
        expresion indicadas para ello

   Una vez calculado todo esto, se escribe la linea del asiento en el fichero
   puente.

   Ademas se ocupa de marcar el registro del fichero principal del enlace
   con el numero de empresa y el periodo con el que se ejecuta el enlace asi
   como el codigo de enlace usado.
*/

   |ATRI I; Mensaje = "Enlazando, espere por favor ..... " + MarcaPant; |HAZ ActMarca;
   |PINTA 2207, "Escribiendo asientos      ";
   |PINTA 2307, Mensaje; |ATRI R;
   CmpOrden = "";

   fFechaIva = "01.01.0000";
   |SI #dscam032#14 = "S";
      |SI #dscam032#19 = "1";
         fFechaIva = #caenlac@#1;
      |SINO;
         |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
            ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
            IFechas       = Fechas1<-;       IFechas       = IFechas       + Cont;
            |SI #dscam030#2 = TiposEnlaces;
               Calc = Fechas;   fFechaIva = #Referen@#Calc#;
            |FINSI;
         |SIGUE;
      |FINSI;
   |FINSI;

   |SI #dscam030#2 = "RM"; |O #dscam030#2 = "CB";
      |SI #dscam032#13 = "S";
         |SI #dscam030#2 = "RM"; Fich = "dscam013"; CmpEntidad = 37; CmpNumero = 38; |FINSI;
         |SI #dscam030#2 = "CB"; Fich = "dscam003"; CmpEntidad = 72; CmpNumero = 70; |FINSI;
         Camp = CmpEntidad; |HAZ TomaDatos; CmpOrden = Comodin;            |QBF CmpOrden;
         Camp = CmpNumero;  |HAZ TomaDatos; CmpOrden = CmpOrden + Comodin; |QBF CmpOrden;
      |SINO;
         CmpOrden = "";
      |FINSI;
   |SINO;
      CmpOrden = "";
   |FINSI;

||************************************* PARTE 1

   aLogTitulo = "Registro numero " + NumRegistro + ". Resolviendo campo cuenta."; |HAZ ApuntaLog;
   |SALVA_DATOS #caenlac@;
   |ABRE #dscaw012;

   Cuenta = #dscam032#3; aLong = Cuenta % 0; nLong = aLong;
   |PARA nCont = 1; |SI nCont [ nLong; |HACIENDO nCont = nCont + 1;
      Calc = (nCont * 100) + 1;
      Caracter = Cuenta % Calc;
      |SI Caracter = "[";
         Calc1 = Calc + 100; Caracter = Cuenta % Calc1;
         |SI Caracter = "%";
            Calc1 = Calc1 + 100; aAlfa = Cuenta % Calc1;
            |SI aAlfa = "-";
               Calc1 = Calc + 18;
            |SINO;
               Calc1 = Calc + 17;
            |FINSI;
            Cadena = Cuenta % Calc1; Cuenta = Cuenta - Cadena;
            |SI aAlfa = "-";
               aLong = Cadena % 0402;
               DigFormat = 0 - aLong;
               Fich  = Cadena % 0608; Camp  = Cadena % 1603;
            |SINO;
               aLong = Cadena % 0302;
               DigFormat = aLong;
               Fich  = Cadena % 0508; Camp  = Cadena % 1503;
            |FINSI;
            |HAZ TomaDatos;
         |SINO;
            Calc1 = Calc + 14;
            aAlfa4 = Cuenta % Calc1;
            aAlfa4 = aAlfa4 - "][";
            |SI FSalida ! 0;
               Calc1 = Calc + 14;
               Cadena = Cuenta % Calc1; Cuenta = Cuenta - Cadena;
               DigFormat = 0;
               Fich  = Cadena % 0208; Camp  = Cadena % 1203;
               |HAZ TomaDatos;
            |FINSI;
         |FINSI;
         Calc1 = 100 + (nCont - 1);
         Cadena = Cuenta % Calc1; Cuenta = Cuenta - Cadena;
         Cuenta = Cadena + Comodin + Cuenta;
         nCont = nCont - 1;
      |SINO;
         |SI Caracter = "{";                 || Es una memoria MEMOPART1
            aAlfa4 = Cuenta;
            aAlfa4 = aAlfa4 - "}";
            |SI FSalida ! 0;
               nCalc1 = ((FSalida / 100) ! 0) + 199;
               aAlfa4 = aAlfa4 % nCalc1;
            |FINSI;
            aAlfa5 = "{" + aAlfa4; |QBF aAlfa5;
            aAlfa5 = aAlfa5 + "}"; Cuenta = Cuenta - aAlfa5;
            || En aAlfa4 tenemos el nombre. La buscamos .....
            |ABRE #dscam172;
            #dscam172#0 = #dscam030#0;
            #dscam172#1 = aAlfa4;
            |LEE 000#dscam172.=;
            |SI FSalida = 0;
               || .... y si la encontramos disponemos todo para ....
               || .... 1) Comprobar cual es la condicion que se cumple
               aExpresion = "";
               |BUCLE LinsCondMemo;
            |SINO;
               Comodin = "";
            |FINSI;
            |CIERRA #dscam172;

            Calc1 = 100 + (nCont - 1);
            Cadena = Cuenta % Calc1; Cuenta = Cuenta - Cadena;
            Cuenta = Cadena + Comodin + Cuenta;
            nCont = nCont - 1;
         |FINSI;
      |FINSI;
   |SIGUE;

   Comodin = Cuenta; |QBF Comodin;
   aLong = Comodin % 0; nLong = aLong;
   SwNivel = 0;
   |SI nLong = Dig1; SwNivel = 1; Nivel = 1; |FINSI;
   |SI nLong = Dig2; SwNivel = 1; Nivel = 2; |FINSI;
   |SI nLong = Dig3; SwNivel = 1; Nivel = 3; |FINSI;
   |SI nLong = Dig4; SwNivel = 1; Nivel = 4; |FINSI;
   |SI nLong = Dig5; SwNivel = 1; Nivel = 5; |FINSI;
   |SI nLong = Dig6; SwNivel = 1; Nivel = 6; |FINSI;
   |SI SwNivel = 0; Nivel = 0; |FINSI;

||************************************* PARTE 2
   aLogTitulo = "Registro numero " + NumRegistro + ". Resolviendo campo Descripcion."; |HAZ ApuntaLog;

   DigFormat = 0;
   Comodin = #dscam032#6; |QBF Comodin;

   |SI Comodin ! "[=]";
      Cadena = "";
      Comodin = "";
      Descr = #dscam032#6;
      Descr = Descr - "][";
      |SI FSalida ! 0;
         |PARA; |SI FSalida ! 0; |HACIENDO;
            Descr = Descr - "[";
            Calc = FSalida;
            Comodin1 = Descr % Calc;
            |SI Comodin1 = "%";
               Calc = Calc + 100; Comodin1 = Descr % Calc;
               |SI Comodin1 = "-";
                  Calc = Calc + 100; Comodin1 = Descr % Calc;
                  aAlfa = "-";
               |FINSI;
               |SI Comodin1 ] "0"; |Y Comodin [ "9";
                  Calc = Calc + 2;
                  Comodin1 = Descr % Calc;
                  |SI aAlfa = "-";
                     Descr = Descr - "%-";
                     DigFormat = 0 - Comodin1;
                  |SINO;
                     Descr = Descr - "%";
                     DigFormat = Comodin1;
                  |FINSI;
                  Descr = Descr - Comodin1;
               |FINSI;
            |FINSI;
            ComodNum = FSalida;
            ComodNum = ((ComodNum / 100) ! 0);
            ComodNum = 100 + (ComodNum - 1);
            Comodin1 = Descr % ComodNum; Descr = Descr - Comodin1;
            Cadena   = Cadena + Comodin1; ||QBF Cadena;
            Fich = Descr % 0108; |QBF Fich; Descr = Descr - Fich;
            Camp = Descr % 0103; Descr = Descr - Camp;
            Descr = Descr - "]";
            |HAZ TomaDatos; DigFormat = 0;
            Cadena = Cadena + Comodin;
            Descr = Descr - "][";
         |SIGUE;
         Descr = Cadena + Descr;

         Descr = Descr - "}"; || Compruebo si hay memorias
         |SI FSalida ! 0;
            nCalc2 = (FSalida / 100) ! 0;
            Descr = Descr - "{";
            nCalc1 = FSalida + nCalc2;
            aAlfa4 = Descr % nCalc1;
         |FINSI;
         || En aAlfa4 tenemos el nombre. La buscamos .....
         |ABRE #dscam172;
         #dscam172#0 = #dscam030#0;
         #dscam172#1 = aAlfa4;
         |LEE 000#dscam172.=;
         |SI FSalida = 0;
            || .... y si la encontramos disponemos todo para ....
            || .... 1) Comprobar cual es la condicion que se cumple
            aExpresion = "";
            |BUCLE LinsCondMemo;
            || .... 2) Si hay una condicion que se cumple, tomo el valor
            Comodin = Cadena;
         |SINO;
            Comodin = "";
         |FINSI;
         |CIERRA #dscam172;
      |SINO;                 || Compruebo si hay memorias MEMOPART2
         Descr = Descr - "}";
         |SI FSalida ! 0;
            nCalc2 = (FSalida / 100) ! 0;
            Descr = Descr - "{";
            nCalc1 = FSalida + nCalc2;
            aAlfa4 = Descr % nCalc1;
         |FINSI;
         || En aAlfa4 tenemos el nombre. La buscamos .....
         |ABRE #dscam172;
         #dscam172#0 = #dscam030#0;
         #dscam172#1 = aAlfa4;
         |LEE 000#dscam172.=;
         |SI FSalida = 0;
            || .... y si la encontramos disponemos todo para ....
            || .... 1) Comprobar cual es la condicion que se cumple
            aExpresion = "";
            |BUCLE LinsCondMemo;
            || .... 2) Si hay una condicion que se cumple, tomo el valor
            ||         y lo reemplazo por la memoria
            Descr = Descr - aAlfa4;
            nParte1 = ((FSalida / 100) ! 0) + 99;
            nParte2 = (((FSalida / 100) ! 0) * 100) + 99;
            aParte1 = Descr % nParte1;
            aParte2 = Descr % nParte2;
            |QBF Cadena;
            Descr = aParte1 + Cadena + aParte2;
         |SINO;
            Comodin = "";
         |FINSI;
         |CIERRA #dscam172;
      |FINSI;
   |FINSI;


||************************************* PARTE 3

   aLogTitulo = "Registro numero " + NumRegistro + ". Resolviendo campo Importe."; |HAZ ApuntaLog;
   DigFormat = 0;
   Cadena = #dscam032#8; |HAZ ResuelveExpr; nImporte = Resultado;

   |SI #dscam032#21 = "S";
      aFiltro = "";
      |SI #dscam030#2 = "CB";
         Fich = "dscam004"; Camp = 0; |HAZ TomaDatos;
         aSerie = Comodin; aFiltro = "V";
      |FINSI;
      |SI #dscam030#2 = "PG";
         Fich = "dscam009"; Camp = 0; |HAZ TomaDatos;
         aSerie = Comodin; aFiltro = "C";
      |FINSI;
      aSerie = (aSerie + "     ") % 0105;

      |DFICB aAlfa; |QBF aAlfa;
      |PATH_DAT #dscam044#aAlfa#; |PATH_DAT #dscam045#aAlfa#;

      nSwAna = 0;
      |ABRE #dscam045; |ABRE #dscam044;
      |SELECT #2#dscam045;
      #dscam045#6 = #48#0;
      |LEE 000#dscam045.=;
      |PARA; |SI FSalida = 0; |Y #dscam045#6 = #48#0; |HACIENDO;
         |SI #dscam045#2 = aFiltro;
            |SI #dscam045#4 [ aSerie; |Y #dscam045#5 ] aSerie; nSwAna = 1; |SAL; |FINSI;
         |FINSI;
         |LEE 000#dscam045.s;
      |SIGUE;
      |SELECT #1#dscam045;

      |SI nSwAna = 1;
         |ABRE #dscam159;
         |SELECT #2#dscam159;
         #dscam159#1 = aSerie;
         |LEE 000#dscam159.=;
         |SI FSalida = 0;
            aCuentaAn = #dscam159#2;
         |FINSI;
         |SELECT #1#dscam159;
         |CIERRA #dscam159;
/*
         #dscam044#0 = #dscam045#0;
         |LEE 000#dscam044.=;
         |SI FSalida ! 0;   |DDEFECTO #dscam044; |FINSI;
         |CIERRA #dscam045; |CIERRA #dscam044;

         aAlfa = #dscam044#1; |QBF aAlfa;
         aAlfa = aAlfa + "def/agifa007.mas";
         |CARGA_DEF aAlfa, Refere3@;
         |SI FSalida = 0;
            aAlfa = #dscam044#1; |QBF aAlfa;
            aAlfa = aAlfa + "fich/" + (("00000" + #dscam044#0) % -105) + "/";
            |PATH_DAT #Refere3@#aAlfa#; |ABRE #Refere3@;
            #Refere3@#26 = aSerie;
            |LEE 000#Refere3@.=;
            |SI FSalida = 0;
               aCuentaAn = #Refere3@#43;
            |SINO;
               aCuentaAn = "";
            |FINSI;
            |CIERRA #Refere3@; |DESCARGA_DEF #Refere3@;
         |FINSI;
*/
      |SINO;
         aCuentaAn = "";
      |FINSI;
   |SINO;
      aCuentaAn = eaCtaAn;
   |FINSI;
/*
   Cadena = #dscam032#8; |QBF Cadena;
   |SI Cadena ! "[dscam004][013]"; |Y Cadena ! "[dscam004][014]";
    |Y Cadena ! "[dscam004][030]"; |Y Cadena ! "[dscam004][031]";
    |Y Cadena ! "[dscam004][013]+[dscam004][014]";
    |Y Cadena ! "[dscam004][014]+[dscam004][013]";
    |Y Cadena ! "[dscam004][030]+[dscam004][031]";
    |Y Cadena ! "[dscam004][031]+[dscam004][030]";
      aCuentaAn = "";
   |FINSI;
*/
   |SI nSw > 0;
      aMensaje = #caenlac@#0 + "/" + #caenlac@#1 + "/" + #caenlac@#2;
      aMensaje = aMensaje + " " + (Descr + (" " * 30)) % 0130;
      nCalc2 = nImporte ! 2;
      aMensaje = aMensaje + " " + nCalc2;
      |IMPRIME aMensaje;
   |FINSI;

||  A partir de aqui, se genera la/s linea/s del fichero puente necesarias
||    para dar de alta el/los asiento/s necesario/s

   UltimoApunte  = NumApunte;
   aLogTitulo = "Registro numero " + NumRegistro + ". Escribiendo linea apunte " + NumApunte + "."; |HAZ ApuntaLog;

   nDiarioAs = #caenlac@#0;
   fFechaAs  = #caenlac@#1;
   nNumDocAs = #caenlac@#2;
   nEmprEnl  = #caenlac@#37;
   nPeriEnl  = #caenlac@#38;
   Cuenta = Cuenta % 0112;

   |SI #dscam032#7 = "S";
      |SI #dscam030#7 = "N";
         |SELECT #3#caenlac@;
      |SINO;
         |SELECT #2#caenlac@;
      |FINSI;
      #caenlac@#3  = NumApunte;
      #caenlac@#4  = Cuenta;
      #caenlac@#40 = CmpOrden; CmpOrden = #caenlac@#40;
      |LEE 101#caenlac@.];
      |PARA; |SI FSalida = 0; |Y nDiarioAs = #caenlac@#0; |Y fFechaAs = #caenlac@#1; |Y nNumDocAs = #caenlac@#2; |HACIENDO;
          || ABDON 16/06/2008 Tiquet 2359/508
          || En el bucle anterior no tenia en cuenta la empresa y el periodo contables
          ||   ya que a veces puede venir distinta (asignacion de series a empresas contables)
          || |SI Cuenta = #caenlac@#4; |Y #caenlac@#8 = #dscam032#4; |LIBERA #caenlac@; |SAL; |FINSI;
          |SI Cuenta = #caenlac@#4; |Y #caenlac@#8 = #dscam032#4;
           |Y nEmprEnl = #caenlac@#37; |Y nPeriEnl = #caenlac@#38;
             |LIBERA #caenlac@; |SAL;
          |FINSI;
          |LIBERA #caenlac@; |LEE 101#caenlac@.s;
      |SIGUE;
      |SI FSalida = 0; |Y nDiarioAs = #caenlac@#0; |Y fFechaAs = #caenlac@#1; |Y nNumDocAs= #caenlac@#2;
       |Y #caenlac@#40 = CmpOrden;
         #caenlac@#7 = Descr;
         #caenlac@#9 = #caenlac@#9 + nImporte;
         |GRABA 020#caenlac@.a; |LIBERA #caenlac@;
      |SINO;
         #caenlac@#0  = nDiarioAs;
         #caenlac@#1  = fFechaAs;
         #caenlac@#2  = nNumDocAs;
         #caenlac@#25 = "N";
         #caenlac@#3  = NumApunte; NumApunte = NumApunte + 1;
         #caenlac@#4  = Cuenta;
         #caenlac@#5  = Nivel;
         #caenlac@#6  = #dscam032#5;
         #caenlac@#7  = Descr;
         #caenlac@#8  = #dscam032#4;
         #caenlac@#9  = nImporte;
         #caenlac@#37 = nEmprEnl;
         #caenlac@#38 = nPeriEnl;
         #caenlac@#40 = CmpOrden;
         |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
            ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
            IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
            IDepartamento = Departamento1<-; IDepartamento = IDepartamento + Cont;
            |SI #dscam030#2 = TiposEnlaces; #dscaw012#0 = Ficheros; |SAL; |FINSI;
         |SIGUE;

         |SI Departamento ] 0;
            Fich = Ficheros; Camp = Departamento; |HAZ TomaDatos;
            #caenlac@#15 = Comodin;
         |SINO;
            Depart = #dscam032#12; aLong = Depart % 0; nLong = aLong;
            |PARA nCont = 1; |SI nCont [ nLong; |HACIENDO nCont = nCont + 1;
                Calc = (nCont * 100) + 1;
                Caracter = Depart % Calc;
                |SI Caracter = "[";
                   Calc1 = Calc + 100; Caracter = Depart % Calc1;
                   |SI Caracter = "%";
                   Calc1 = Calc1 + 100; aAlfa = Depart % Calc1;
                   |SI aAlfa = "-";
                      Calc1 = Calc + 18;
                   |SINO;
                      Calc1 = Calc + 17;
                   |FINSI;
                   Cadena = Depart % Calc1; Depart = Depart - Cadena;
                   |SI aAlfa = "-";
                      aLong = Cadena % 0402;
                      DigFormat = 0 - aLong;
                      Fich  = Cadena % 0608; Camp  = Cadena % 1603;
                   |SINO;
                      aLong = Cadena % 0302;
                      DigFormat = aLong;
                      Fich  = Cadena % 0508; Camp  = Cadena % 1503;
                   |FINSI;
                   |HAZ TomaDatos;
                   |SINO;
                      Calc1 = Calc + 14;
                      Cadena = Depart % Calc1; Depart = Depart - Cadena;
                      DigFormat = 0;
                      Fich  = Cadena % 0208; Camp  = Cadena % 1203;
                      |HAZ TomaDatos;
                   |FINSI;
                   Calc1 = 100 + (nCont - 1);
                   Cadena = Depart % Calc1; Depart = Depart - Cadena;
                   Depart = Cadena + Comodin + Depart;
                   nCont = nCont - 1;
                |FINSI;
            |SIGUE;
            #caenlac@#15 = Depart;
         |FINSI;
         #caenlac@#17 = 0; #caenlac@#18 = "";
         Comodin = Usuario % 0810;
         #caenlac@#19 = Comodin;
         #caenlac@#24 = #dscam030#2;

         |SI #dscam032#14 = "S"; |Y nImporte ! 0;
            #caenlac@#10 = #dscam032#20;
            #caenlac@#11 = #dscam032#15;
            #caenlac@#12 = #dscam032#16;
            #caenlac@#13 = -1;
            #caenlac@#26 = #dscam032#17;
            #caenlac@#27 = #dscam032#18;
            || #caenlac@#28 = 16;
            #caenlac@#28 = 18;
            #caenlac@#29 = fFechaIva;
         |FINSI;

         |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
            ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
            IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
            ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
            ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
            |SI #dscam030#2 = TiposEnlaces;
               Comodin = Campo1Clave; |QBF Comodin; #caenlac@#21 = Comodin;
               Comodin = Campo2Clave; |QBF Comodin; #caenlac@#22 = Comodin;
               |SAL;
            |FINSI;
         |SIGUE;

         #caenlac@#39 = aCuentaAn;
         |SI #dscam030#2 = "CB"; |O #dscam030#2 = "PG";
            |SI #dscam030#2 = "CB"; Fich = "dscam003"; Camp = 4; |HAZ TomaDatos; |FINSI;
            |SI #dscam030#2 = "PG"; Fich = "dscam008"; Camp = 4; |HAZ TomaDatos; |FINSI;
            |QBF Comodin; Comodin = Comodin % -104;
            #caenlac@#36 = Comodin;
         |FINSI;
         |GRABA 020#caenlac@.c; |LIBERA #caenlac@;
      |FINSI;
      |SELECT #1#caenlac@;
   |SINO;
      #caenlac@#25 = "N";
      #caenlac@#3 = NumApunte; NumApunte = NumApunte + 1;
      #caenlac@#4 = Cuenta;
      #caenlac@#5 = Nivel;
      #caenlac@#6 = #dscam032#5;
      #caenlac@#7 = Descr;
      #caenlac@#8 = #dscam032#4;
      #caenlac@#9 = nImporte;
      #caenlac@#40 = CmpOrden;

      |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
         ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
         IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
         IDepartamento = Departamento1<-; IDepartamento = IDepartamento + Cont;
         |SI #dscam030#2 = TiposEnlaces;
            ||#caenlac@#10 = #dscam030#2;
            |SAL;
         |FINSI;
      |SIGUE;

      |SI Departamento ] 0;
         Fich = Ficheros; Camp = Departamento; |HAZ TomaDatos;
         #caenlac@#15 = Comodin;
      |SINO;
         Depart = #dscam032#12; aLong = Depart % 0; nLong = aLong;
         |PARA nCont = 1; |SI nCont [ nLong; |HACIENDO nCont = nCont + 1;
             Calc = (nCont * 100) + 1;
             Caracter = Depart % Calc;
             |SI Caracter = "[";
                Calc1 = Calc + 100; Caracter = Depart % Calc1;
                |SI Caracter = "%";
                Calc1 = Calc1 + 100; aAlfa = Depart % Calc1;
                |SI aAlfa = "-";
                   Calc1 = Calc + 18;
                |SINO;
                   Calc1 = Calc + 17;
                |FINSI;
                Cadena = Depart % Calc1; Depart = Depart - Cadena;
                |SI aAlfa = "-";
                   aLong = Cadena % 0402;
                   DigFormat = 0 - aLong;
                   Fich  = Cadena % 0608; Camp  = Cadena % 1603;
                |SINO;
                   aLong = Cadena % 0302;
                   DigFormat = aLong;
                   Fich  = Cadena % 0508; Camp  = Cadena % 1503;
                |FINSI;
                |HAZ TomaDatos;
                |SINO;
                   Calc1 = Calc + 14;
                   Cadena = Depart % Calc1; Depart = Depart - Cadena;
                   DigFormat = 0;
                   Fich  = Cadena % 0208; Camp  = Cadena % 1203;
                   |HAZ TomaDatos;
                |FINSI;
                Calc1 = 100 + (nCont - 1);
                Cadena = Depart % Calc1; Depart = Depart - Cadena;
                Depart = Cadena + Comodin + Depart;
                nCont = nCont - 1;
             |FINSI;
         |SIGUE;
         #caenlac@#15 = Depart;
      |FINSI;
      #caenlac@#17 = 0; #caenlac@#18 = "";
      Comodin = Usuario % 0810;
      #caenlac@#19 = Comodin;
      #caenlac@#24 = #dscam030#2;

      |SI #dscam032#14 = "S"; |Y nImporte ! 0;
         #caenlac@#10 = #dscam032#20;
         #caenlac@#11 = #dscam032#15;
         #caenlac@#12 = #dscam032#16;
         #caenlac@#13 = -1;
         #caenlac@#26 = #dscam032#17;
         #caenlac@#27 = #dscam032#18;
         ||#caenlac@#28 = 16;
         #caenlac@#28 = 18;
         #caenlac@#29 = fFechaIva;
      |FINSI;

      |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
         ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
         IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
         ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
         ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
         |SI #dscam030#2 = TiposEnlaces;
            Comodin = Campo1Clave; |QBF Comodin; #caenlac@#21 = Comodin;
            Comodin = Campo2Clave; |QBF Comodin; #caenlac@#22 = Comodin;
            |SAL;
         |FINSI;
      |SIGUE;

      #caenlac@#39 = aCuentaAn;
      |SI #dscam030#2 = "CB"; |O #dscam030#2 = "PG";
         |SI #dscam030#2 = "CB"; Fich = "dscam003"; Camp = 4; |HAZ TomaDatos; |FINSI;
         |SI #dscam030#2 = "PG"; Fich = "dscam008"; Camp = 4; |HAZ TomaDatos; |FINSI;
         |QBF Comodin; Comodin = Comodin % -104;
         #caenlac@#36 = Comodin;
      |FINSI;
      |GRABA 020#caenlac@.c; |LIBERA #caenlac@;
   |FINSI;

   |DBASS aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "contagen/def/caivam01.mas";
   |CARGA_DEF aAlfa, caivm01@;
   |SI FSalida = 0;
      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "contagen/fich/000000/"; |PATH_DAT #caivm01@#aAlfa#;
      |ABRE #caivm01@;
      #caivm01@#0 = #caenlac@#37;
      |LEE 000#caivm01@.=;
      |SI FSalida ! 0; |DDEFECTO #caivm01@; |FINSI;
      |SI #caivm01@#4 = "S";
         |LEE 000#caenlac@.=;
         |SI FSalida = 0;
            #dscaw103#4 = #caenlac@#37;
            #dscaw103#5 = #caenlac@#38;
            #dscaw103#0 = #caenlac@#0;
            #dscaw103#1 = #caenlac@#1;
            #dscaw103#2 = #caenlac@#2;
            |LEE 000#dscaw103.=;
            |SI FSalida ! 0;
               |DBASS aAlfa; |QBF aAlfa;
               aAlfa = aAlfa + "contagen/def/caivam02.mas";
               |CARGA_DEF aAlfa, caivm02@;
               |SI FSalida = 0;
                  |DBASS aAlfa; |QBF aAlfa;
                  aAlfa = aAlfa + "contagen/fich/" + (("00000" + #caenlac@#37) % -105) + #caenlac@#38 + "/"; |PATH_DAT #caivm02@#aAlfa#;
                  |ABRE #caivm02@;
                  #caivm02@#0 = #caenlac@#2;
                  #caivm02@#1 = #caenlac@#0;
                  #caivm02@#2 = #caenlac@#1;
                  |LEE 101#caivm02@.=;
                  |SI FSalida = 0;
                     |DDEFECTO #dscaw103;
                     #dscaw103#0 = #caenlac@#0;
                     #dscaw103#1 = #caenlac@#1;
                     #dscaw103#2 = #caenlac@#2;
                     #dscaw103#3 = "N";
                     #dscaw103#4 = #caenlac@#37;
                     #dscaw103#5 = #caenlac@#38;
                     |GRABA 020#dscaw103.c;

                     |SI enSinConfi = 0;
                        aAlfa = "    NAsto." + (("00" + #caenlac@#0) % -102) + "/";
                        aAlfa = aAlfa + #caenlac@#1 + "/" + (("00000" + #caenlac@#2) % -105);
                        aAlfa = aAlfa + " modificado,si vuelve a enlazar perdera los cambios, " + &191 + " Continuar ?";
                        |CONFI aAlfa;
                     |SINO;
                        aLogTitulo = "    NAsto." + (("00" + #caenlac@#0) % -102) + "/";
                        aLogTitulo = aLogTitulo + #caenlac@#1 + "/" + (("00000" + #caenlac@#2) % -105);
                        aLogTitulo = aLogTitulo + " modificado. Proceso cancelado"; |HAZ ApuntaLog;
                        |XGRABA enHandLog, aLogTitulo;
                        FSalida = nMenosUno;
                     |FINSI;
                     |SI FSalida ! 0;
                        || #caenlac@#18 = "S"; |GRABA 020#caenlac@.a;
                     |SINO;
                        #dscaw103#3 = "S";
                        |GRABA 020#dscaw103.a;
                     |FINSI;
                     |LIBERA #caivm02@;
                  |FINSI;
                  |CIERRA #caivm02@; |DESCARGA_DEF #caivm02@;
               |FINSI;
            |SINO;
               |SI #dscaw103#3 = "N";
                  #caenlac@#18 = "S";
                  |GRABA 020#caenlac@.a;
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
      |CIERRA #caivm01@; |DESCARGA_DEF #caivm01@;
   |FINSI;

   aLogTitulo = "Registro numero " + NumRegistro + ". Escribiendo historico de enlaces y marcando registro como contabilizado."; |HAZ ApuntaLog;
   |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
      ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
      IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
      IFichCab      = FichCab1<-;      IFichCab      = IFichCab      + Cont;
      IClaveCab     = ClaveCab1<-;     IClaveCab     = IClaveCab     + Cont;
      IEmpresCab    = EmpresCab1<-;    IEmpresCab    = IEmpresCab    + Cont;
      IPeriodCab    = PeriodCab1<-;    IPeriodCab    = IPeriodCab    + Cont;
      IContabil     = Contabil1<-;     IContabil     = IContabil     + Cont;
      ICmpEmpresa   = CmpEmpresa1<-;   ICmpEmpresa   = ICmpEmpresa   + Cont;
      ICmpPeriodo   = CmpPeriodo1<-;   ICmpPeriodo   = ICmpPeriodo   + Cont;
      InAsiento     = nAsiento1<-;     InAsiento     = InAsiento     + Cont;
      ICmpEnlace    = CmpEnlace1<-;    ICmpEnlace    = ICmpEnlace    + Cont;
      ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
      ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
      |SI #dscam030#2 = TiposEnlaces;
         |DBASE Direc; ||Fich = FichCab;
         Comodin = Direc + "def/" + FichCab + ".mas";
         |DFICE Comodin1;
         |CARGA_DEF Comodin, ReferCb@;
         |SI FSalida = 0;
            |PATH_DAT #12 Comodin1;
            |ABRE #ReferCb@;
            #dscaw012#0 = FichCab;
            #dscaw012#1 = ClaveCab;
            |LEE 000#dscaw012.=;
            |SI FSalida = 0;
               Calc = ClaveCab;
               |SI #dscaw012#2 = "A"; #ReferCb@#Calc# = #dscaw012#3; |FINSI;
               |SI #dscaw012#2 = "N"; #ReferCb@#Calc# = #dscaw012#4; |FINSI;
               |SI #dscaw012#2 = "F"; #ReferCb@#Calc# = #dscaw012#5; |FINSI;
               |LEE 101#ReferCb@.=;
               |SI FSalida = 0;
                  Calc = EmpresCab; #ReferCb@#Calc# = Empresa;
                  Calc = PeriodCab; #ReferCb@#Calc# = Periodo;
                  Calc = Contabil;
                  |SI Calc > 0; |Y PARAMETRO ! "";
                      |SI #dscam033#6 = " ";
                         #ReferCb@#Calc# = "S";
                      |SINO;
                         |SI #dscam033#6 = "E"; Calc = Calc - 1; |FINSI;
                         #ReferCb@#Calc# = "S";
                      |FINSI;
                  |FINSI;
                  |GRABA 020#ReferCb@.a;
               |FINSI;
               |LIBERA #ReferCb@;
            |FINSI;
            |CIERRA #ReferCb@; |DESCARGA_DEF #ReferCb@;
         |FINSI;

         #dscam067#8 = #caenlac@#37;
         #dscam067#9 = #caenlac@#38;
         #dscam067#0 = #dscam030#2;
         Calc = Campo1Clave; Comodin = #Referen@#Calc#; #dscam067#1 = Comodin;
         Calc = Campo2Clave; Comodin = #Referen@#Calc#; #dscam067#2 = Comodin;
         #dscam067#3  = TipoEnl;
         #dscam067#11 = #dscam031#2;
         |LEE 101#dscam067.=;
         |SI FSalida ! 0;
            |DDEFECTO #dscam067;
            #dscam067#8 = #caenlac@#37;
            #dscam067#9 = #caenlac@#38;
            #dscam067#0 = #dscam030#2;
            Calc = Campo1Clave; Comodin = #Referen@#Calc#; #dscam067#1 = Comodin;
            Calc = Campo2Clave; Comodin = #Referen@#Calc#; #dscam067#2 = Comodin;
            #dscam067#3  = TipoEnl;
            #dscam067#11 = #dscam031#2;
            |GRABA 020#dscam067.b;
            nSwNuevoHisEnl = 1;
         |FINSI;

         |SI nSwNuevoHisEnl = 1;
            aAlfa = "|NC"; aAlfa = #caenlac@#aAlfa#; nCalc = aAlfa;
            |SI nCalc ] 49;
               |LEE 101#caenlac@.=;
               |SI FSalida = 0;
                  nCalc = 48; #caenlac@#nCalc# = "S";
                  |GRABA 020#caenlac@.a; |LIBERA #caenlac@;
               |FINSI;
            |FINSI;
         |FINSI;

         #dscam067#4  = #caenlac@#0;
         #dscam067#5  = #caenlac@#1;
         #dscam067#6  = #caenlac@#2;
         #dscam067#7  = #caenlac@#3;
         #dscam067#10 = CodEnlace;
         |GRABA 020#dscam067.a; |LIBERA #dscam067;
         |SAL;
      |FINSI;
   |SIGUE;

   |CIERRA #dscaw012;
   |REPON_DATOS #caenlac@;
|FPRC;

|DEFBUCLE dscam032a;
#dscam032#1;
;
CodEnlace,#dscam031#2,0001;
CodEnlace,#dscam031#2,9999;
;
NULL,dscam032a;
|FIN;

|PROCESO EliminaSobras;
   |BORRA 020#caenlac@.a;
|FPRC;

|DEFBUCLE EliminaSobras;
#caenlac@#1006;
;
#dscaw103#0, #dscaw103#1, #dscaw103#2, 0000, #dscaw103#4, #dscaw103#5;
#dscaw103#0, #dscaw103#1, #dscaw103#2, 9999, #dscaw103#4, #dscaw103#5;
;
NULL,EliminaSobras;
|FIN;

|PROCESO dscaw103a;
   |SI #dscaw103#3 = "N"; |BUCLE EliminaSobras; |FINSI;
|FPRC;

|DEFBUCLE dscaw103a;
#dscaw103#1;
;
INICIO;
FINAL;
;
NULL, dscaw103a;
|FIN;

|PROCESO Asiento;
   aLogTitulo = "Registro numero " + NumRegistro + ". Comienzo del bucle de creacion de asiento."; |HAZ ApuntaLog;
   nSwNuevoHisEnl = 0;
   |BUCLE dscam032a;

   || Elimina los registros que no se enlazaran
   |BUCLE dscaw103a;
|FPRC;

|PROCESO Contador;
   || Esto se hace porque no vale la forma de detectar el modulo de Forestales.
   ||    Lo mejor seria hacer un def que fuera solo para forestales y hacer
   ||    depender de eso la deteccion del modulo.

   |HAZ EsForest;
   |SI FSalida = 0;
      |ABRE #caconta@;
      #caconta@#0 = #caenlac@#0;
      |LEE 101#caconta@.=;
      |SI FSalida ! 0;
         |DDEFECTO #caconta@;
         #caconta@#0 = #caenlac@#0;
         |GRABA 020#caconta@.b;
      |FINSI;
      #caconta@#2 = #caconta@#2 + 1; NumAsientos = #caconta@#2;
      |GRABA 020#caconta@.a; |LIBERA #caconta@;
      |CIERRA #caconta@;

      |VETE FinContador;
   |FINSI;

   |ABRE #caconas@;
   |LEE 101#caconas@.p;
   |SI FSalida ! 0;
      |DDEFECTO #caconas@;
      |GRABA 020#caconas@.n;
      |LEE 101#caconas@.p;
   |FINSI;

   Fichero = "Contador Asientos"; Tipo = "C"; Cmp = "Contador Asiento"; |HAZ ObtenDato;
   #caconas@#CmpNum# = #caconas@#CmpNum# + 1;
   NumAsientos = #caconas@#CmpNum#;

   Comodin = "|NC"; Calc = #caconas@#Comodin#;
   Fichero = "Contador Asientos"; Tipo = "C"; Cmp = "Contador Registro"; |HAZ ObtenDato;
   |SI Calc > 2; #caconas@#CmpNum# = #caconas@#CmpNum# + 1; |FINSI;

   |GRABA 020#caconas@.a;
   |LIBERA #caconas@; |CIERRA #caconas@;

|ET FinContador;
   |ABRE #camasic@;
   #camasic@#0 = #caenlac@#0;
   #camasic@#1 = #caenlac@#1;
   #camasic@#2 = NumAsientos;
   |LEE 000#camasic@.=;
   |SI FSalida = 0;
      nErrContador = 1;
      |HAZ LogErrConta;
   |SINO;
      nErrContador = 0;
   |FINSI;
   |CIERRA #camasic@;
|FPRC;

|RUTINA infe1;
   #dscaw013#15 = CodEnlace;
   #dscaw013#0 = 001;
|FRUT;

|RUTINA supe1;
   #dscaw013#15 = CodEnlace;
   #dscaw013#0 = 999;
|FRUT;

|PROCESO Exclusiones;
   |SI PARAMETRO ! ""; |ACABA; |FINSI;
   |SI #dscaw013#11 = "A";
      Calc = 100 + #dscaw012#6;
      DComodin = #dscam068#3; DComodin = DComodin % Calc;
      |SI DComodin = Comodin; SwCondic = 0; |ERROR10; |FINSI;
   |FINSI;
   |SI #dscaw013#11 = "N";
      |SI #dscam068#4 = Comodin; SwCondic = 0; |ERROR10; |FINSI;
   |FINSI;
   |SI #dscaw013#11 = "F";
      |SI #dscam068#5 = Comodin; SwCondic = 0; |ERROR10; |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Exclusiones;
#dscam068#1;
;
#dscaw013#15,#dscaw013#0,001;
#dscaw013#15,#dscaw013#0,999;
;
NULL,Exclusiones;
|FIN;

|PROCESO Condicion;
/*
   Se devuelve en la variable 'SwCondic' un uno si el registro actual del
   fichero principal del enlace (o de cualquiera de sus relaciones) entra
   dentro de la acotacion que tenemos recogida en el fichero 'dscaw013'. Si
   no es asi, devuelve un cero.
*/
   nLong = 0;
   |SI #dscaw013#11 = "N";
      |DBASE aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "def/" + #dscaw013#13;
      |CARGA_DEF aAlfa, RefDato@;
      |SI FSalida = 0;
         aAlfa = "|C" + (("000" + #dscaw013#14) % -103) + "MINIMO";
         aAlfa = #RefDato@#aAlfa#;
         aAlfa = aAlfa - ".";
         |SI FSalida ! 0;
            nCalc = FSalida; nCalc1 = nCalc + 98; aAlfa = aAlfa % nCalc1; |QBF aAlfa;
            aLong = aAlfa % 0; nLong = aLong;
            aAlfa1 = "9" * nLong;
            |SI aAlfa ! aAlfa1;
               aAlfa = "|C" + (("000" + #dscaw013#14) % -103) + "MAXIMO";
               aAlfa = #RefDato@#aAlfa#;
               aAlfa = aAlfa - ".";
               |SI FSalida ! 0;
                  nCalc1 = FSalida; nCalc1 = nCalc1 + 98; aAlfa = aAlfa % nCalc1; |QBF aAlfa;
               |FINSI;
               aLong = aAlfa % 0; nCalc1 = aLong;
               nCalc2 = (nCalc / 100) ! 0;
               |SI nCalc1 > nCalc2; nCalc = (nCalc1 + 1) * 100; |FINSI;
               nCalc1 = (nCalc / 100) ! 0; nLong = 15 - nCalc1;
            |FINSI;
         |FINSI;
         |DESCARGA_DEF #RefDato@;
      |FINSI;
   |FINSI;
   nDeci_nDec = nLong;

   |SI #dscaw013#13 ! Fich1;
      |ATRI I; |PINTA 2207, "Resolviendo condiciones        "; |ATRI R;
      #dscaw012#0 = #dscaw013#13;
      #dscaw012#1 = #dscaw013#14;
      |LEE 000#dscaw012.=;
      |SI FSalida = 0;
         |SI #dscaw012#2 = "A"; Comodin = #dscaw012#3; |FINSI;
         |SI #dscaw012#2 = "N"; Comodin = #dscaw012#4; |FINSI;
         |SI #dscaw012#2 = "F"; Comodin = #dscaw012#5; |FINSI;
         |SI #dscaw013#11 = "A";
            Calc = 100 + #dscaw012#6; Comodin = Comodin % Calc;
            DComodin = #dscaw013#3; DComodin = DComodin % Calc;
            HComodin = #dscaw013#4; HComodin = HComodin % Calc;
            |SI DComodin [ Comodin; |Y Comodin [ HComodin;
               SwCondic = 1;
            |SINO;
               SwCondic = 0; |ERROR10;
            |FINSI;
         |FINSI;
         |SI #dscaw013#11 = "N";
            |SI #dscaw013#5 [ Comodin; |Y Comodin [ #dscaw013#6;
               SwCondic = 1;
            |SINO;
               SwCondic = 0; |ERROR10;
            |FINSI;
         |FINSI;
         |SI #dscaw013#11 = "F";
            ComFecha = Comodin;
            |SI #dscaw013#7 [ ComFecha; |Y ComFecha [ #dscaw013#8;
               SwCondic = 1;
            |SINO;
               SwCondic = 0; |ERROR10;
            |FINSI;
         |FINSI;
         |SI SwCondic = 1;
            |BUCLE Exclusiones;
            |SI SwCondic = 0; |ERROR10; |FINSI;
         |FINSI;
      |FINSI;
   |SINO;
      |ATRI I; |PINTA 2207, "Resolviendo condiciones        "; |ATRI R;
      #dscaw012#0 = #dscaw013#13;
      #dscaw012#1 = #dscaw013#14;
      |LEE 000#dscaw012.=;
      |SI FSalida = 0;
         |SI #dscaw012#2 = "A";
            Comodin = #dscaw012#3;
            Calc = 100 + #dscaw012#6; Comodin = Comodin % Calc;
         |FINSI;
         |SI #dscaw012#2 = "N"; Comodin = #dscaw012#4; |FINSI;
         |SI #dscaw012#2 = "F"; Comodin = #dscaw012#5; |FINSI;
         SwCondic = 1;
         |BUCLE Exclusiones;
         |SI SwCondic = 0; |ERROR10; |FINSI;
      |FINSI;
   |FINSI;

   |SI #dscam030#2 = "RM"; |Y PARAMETRO = "";
      |DBASE Direc;
      Comodin = Direc + "def/" + FichCab + ".mas";
      |DFICE Comodin1;
      |CARGA_DEF Comodin, ReferCb@;
      |SI FSalida = 0;
         |PATH_DAT #12 Comodin1;
         |ABRE #ReferCb@;
         #ReferCb@#0 = #Referen@#0;
         |LEE 000#ReferCb@.=;
         |SI FSalida = 0;
            |SI #dscam033#6 = "E"; nCmp = 23; |FINSI;
            |SI #dscam033#6 = "A"; nCmp = 8;  |FINSI;
            |SI #dscam033#6 = "V"; nCmp = 9;  |FINSI;
            |SI #ReferCb@#nCmp# = "N"; SwCondic = 0; |FINSI;
         |SINO;
            SwCondic = 0;
         |FINSI;
         |CIERRA #ReferCb@; |DESCARGA_DEF #ReferCb@;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE Condicion;
#dscaw013#1;
;
CodEnlace,001;
CodEnlace,999;
;
NULL,Condicion;
|FIN;

|PROCESO BorraHist;
   |BORRA 020#dscam067.a;
|FPRC;

|DEFBUCLE BorraHist;
#dscam067#2;
;
nEmpresa, nPeriodo, nContDi, fContFe, nContAs, 0001;
nEmpresa, nPeriodo, nContDi, fContFe, nContAs, 9999;
be;
NULL,BorraHist;
|FINSI;

|PROCESO BucleFichero;
/*
   Esta rutina crea los asientos en base a la plantilla que nosotros hemos
   generado anteriormente en la parametrizacion. Recorre el fichero
   'dscam031'. Por cada linea que encuentra de este fichero (que representa
   un asiento) recogeremos los datos que estan relacionados con el registro
   ,miraremos si el registro entra dentro de la acotacion que tenemos y si es
   validado recorreremos el fichero 'dscam032' con la clave correspondiente
*/

   |SALVA_FICHA #dscam031;
|| Primero reviso si el asiento ya ha sido enlazado ...
   |SI TotalRegs > 0;
      Comodin2 = Usuario; |QBF Comodin2; Comodin2 = "sq" + Comodin2;
      |CARGA_DEF Comodin2,Referen@;
      |SI FSalida = 0;
         |ABRE #Referen@;
         |SI #dscam030#8 = "S"; |SELECT #3#Referen@; |SINO; |SELECT #1#Referen@; |FINSI;

         NumAsto = NumAsto + 1; nSw = 0;
         |LEE 101#Referen@.p;
         |SI FSalida = 0;
            |PARA; |SI FSalida = 0; |HACIENDO;
               |ATRI I;
               Mensaje = "Recorriendo resultados                Enlazando registro ...... : " + NumRegistro;
               |PINTA 2207, Mensaje;
               Mensaje = "Enlazando, espere por favor ..... " + MarcaPant; |HAZ ActMarca;
               Mensaje = Mensaje + "   Total registros a enlazar : " + TotalRegs;
               |PINTA 2307, Mensaje; |ATRI R;

               aLogTitulo = "Registro numero " + NumRegistro + ". Se inicia el proceso de resolucion de relaciones."; |HAZ ApuntaLog;
               FichRelac = Fich1; |HAZ ResuelveRels;
               SwAsiento = 0; SwCondic = 0;

               aLogTitulo = "Registro numero " + NumRegistro + ". Se inicia el bucle de evaluacion de condiciones."; |HAZ ApuntaLog;
               |ABRE #dscaw012;
               |BUCLE Condicion;
               |SI SwCondic = 1;
                  aLogTitulo = "Registro numero " + NumRegistro + ". Registro dentro de la acotacion. Preparacion datos para bucle de creacion de asiento."; |HAZ ApuntaLog;
                  |SI #dscam051#62 = "S";
                     |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
                        ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
                        ISerie = Serie1<-; ISerie = ISerie + Cont;
                        |SI #dscam030#2 = TiposEnlaces;
                           nSerie = Serie;
                           |SI TiposEnlaces = "CB"; |O TiposEnlaces = "RM";
                              aTipoSerie = "V";
                           |SINO;
                              aTipoSerie = "C";
                           |FINSI;
                           |SAL;
                        |FINSI;
                     |SIGUE;
                     aSerie = #Referen@#nSerie#;
                     |ABRE #dscam094;
   |ET Atras;
                     #dscam094#0 = aTipoSerie;
                     #dscam094#1 = aSerie;
                     |LEE 000#dscam094.=;
                     |SI FSalida = 0;
                        nSerie = #dscam094#2;
                     |SINO;
                        |SI enSinConfi = 0;
                           aAlfa = "    NLa serie " + aSerie + " no tiene asociada empresa contable";
                           aAlfa = aAlfa + ". Enlazar con la empresa por defecto ?";
                           |CONFI aAlfa;
                        |SINO;
                           aLogTitulo = "    NLa serie " + aSerie + " no tiene asociada empresa contable";
                           aLogTitulo = aLogTitulo + ". Proceso cancelado."; |HAZ ApuntaLog;
                           |XGRABA enHandLog, aLogTitulo;
                           FSalida = nMenosUno;
                        |FINSI;
                        |SI FSalida ! 0;
                           |SI enSinConfi = 0;
                              |MENAV "    Proceso cancelado. Ningun registro pasara a contabilidad.";
                           |SINO;
                              aLogTitulo = "Proceso cancelado. Ningun registro pasara a contabilidad.";
                              |HAZ ApuntaLog; |XGRABA enHandLog, aLogTitulo;
                           |FINSI;

                           |CIERRA #dscam094;
                           |CIERRA #dscaw012; |LIBERA #Referen@;
                           Salir = 1; |SAL;
                        |FINSI;
                        nSerie = -1;
                     |FINSI;
                     |CIERRA #dscam094;
                  |SINO;
                     nSerie = -1;
                  |FINSI;
                  || aqui
                  || Primero recojo los datos de la fecha contable para catalogar la empresa a la que
                  ||    iran enlazados los datos y recojer el contador de asientos de donde hace falta
                  |DDEFECTO #caenlac@;
                  #caenlac@#0 = #dscam031#3;
                  |SI #dscam030#8 = "N";
                     #caenlac@#1 = #dscam031#4;
                  |SINO;
                     #caenlac@#1 = fFecha;
                  |FINSI;
                  |SI FechaVto ! ""; |Y FechaVto ! "00.00.0000";
                      #caenlac@#1 = FechaVto;
                  |SINO;
                     |SI FechaAbo ! ""; |Y FechaAbo ! "00.00.0000";
                        #caenlac@#1 = FechaAbo;
                     |FINSI;
                  |FINSI;
                  |SI #caenlac@#1 = "00.00.0000";
                      #caenlac@#1 = ~;
                  |SINO;
                      |SI #dscam030#8 = "N"; |Y #dscam031#4 = "00.00.0000";
                           #caenlac@#1 = ~;
                      |FINSI;
                  |FINSI;
                  |SI #caenlac@#1 = "01.01.0000";
                     |SI FechaVto = "";
                        |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
                           ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
                           IFechas       = Fechas1<-;       IFechas       = IFechas       + Cont;
                           IFichCab      = FichCab1<-;      IFichCab      = IFichCab      + Cont;
                           IClaveCab     = ClaveCab1<-;     IClaveCab     = IClaveCab     + Cont;
                           IContabil     = Contabil1<-;     IContabil     = IContabil     + Cont;
                           |SI #dscam030#2 = TiposEnlaces;
                              |SI #dscam030#2 ! "CB"; |Y #dscam030#2 ! "PG";
                                 |DBASE Direc;
                                 Comodin = Direc + "def/" + FichCab + ".mas";
                                 |DFICE Comodin1;
                                 |CARGA_DEF Comodin, ReferCb@;
                                 |SI FSalida = 0;
                                    |PATH_DAT #12 Comodin1;
                                    |ABRE #ReferCb@;
                                    #dscaw012#0 = FichCab;
                                    #dscaw012#1 = ClaveCab;
                                    |LEE 000#dscaw012.=;
                                    |SI FSalida = 0;
                                       Calc = ClaveCab;
                                       |SI #dscaw012#2 = "A"; #ReferCb@#Calc# = #dscaw012#3; |FINSI;
                                       |SI #dscaw012#2 = "N"; #ReferCb@#Calc# = #dscaw012#4; |FINSI;
                                       |SI #dscaw012#2 = "F"; #ReferCb@#Calc# = #dscaw012#5; |FINSI;
                                       |LEE 101#ReferCb@.=;
                                       |SI FSalida = 0;
                                          Calc = Fechas;   #caenlac@#1 = #ReferCb@#Calc#;
                                          Calc = Contabil;
                                          |SI Calc > 0; |Y PARAMETRO ! "";
                                             #ReferCb@#Calc# = "S";
                                          |FINSI;
                                          |GRABA 020#ReferCb@.a;
                                       |FINSI;
                                       |LIBERA #ReferCb@;
                                    |FINSI;
                                    |CIERRA #ReferCb@; |DESCARGA_DEF #ReferCb@;
                                 |FINSI;
                              |SINO;
                                 |SI efFechaExt = "01.01.0000"; |O efFechaExt = "00.00.0000";
                                    Calc = Fechas; #caenlac@#1 = #Referen@#Calc#;
                                 |SINO;
                                    #caenlac@#1 = efFechaExt;
                                 |FINSI;
                              |FINSI;
                              |SAL;
                           |FINSI;
                        |SIGUE;
                     |SINO;
                        #caenlac@#1 = FechaVto;
                     |FINSI;
                  |FINSI;
                  || Nos aseguramos que la empresa a la que van enlazados los datos es la correcta
                  Comodin  = PathEnlace; |QBF Comodin;
                  Comodin1 = Comodin;
                  Fichero = "Empresas"; Tipo = "C"; Cmp = ""; |HAZ ObtenFich;
                  Comodin = Comodin + "def/" + Fichero + ".mas";
                  Comodin1 = Comodin1 + "fich/";
                  |CARGA_DEF Comodin , canempr@;
                  |SI FSalida = 0;
                     |PATH_DAT #20 Comodin1; |ABRE #canempr@;
                     |SI nSerie ! -1;
                        Fichero = "Empresas"; Tipo = "C"; Cmp = "Codigo Empresa"; |HAZ ObtenDato;
                        CmpEmp = CmpNum;
                        Fichero = "Empresas"; Tipo = "C"; Cmp = "Periodo";        |HAZ ObtenDato;
                        CmpPer = CmpNum;
                        #canempr@#CmpEmp# = nSerie;
                        #canempr@#CmpPer# = 0;
                        |LEE 000#canempr@.];
                        |SI FSalida = 0; |Y #canempr@#CmpEmp# = nSerie;
                           nEmpr = #dscam033#4; nPeri = #dscam033#5;
                           aAlfa = #caenlac@#1; |QBF aAlfa; aAlfa = aAlfa % -104; nAnyo = aAlfa;
                           fFechaEje = #caenlac@#1;
                           Fichero = "Empresas"; Tipo = "C"; Cmp = "Ejercicio"; |HAZ ObtenDato;
                           nCalc = #canempr@#CmpNum#;
                           |SI nCalc ] 80; nCalc = nCalc + 1900; |SINO; nCalc = nCalc + 2000; |FINSI;
                           aAlfa = "01." + (("00" + #canempr@#11) % -102) + "." + nCalc;       fFechaIni = aAlfa;
                           nCalc = nCalc + 1;
                           nCalc1 = #canempr@#12 + 1;
                           |SI nCalc1 > 12; nCalc1 = 1; |FINSI;
                           aAlfa = "01." + (("00" + nCalc1) % -102) + "." + nCalc; fFechaFin = aAlfa;
                           nCalc1 = fFechaFin; nCalc1 = nCalc1 - 1; fFechaFin = nCalc1;
                           |SI fFechaIni > fFechaEje; |O fFechaEje > fFechaFin;
                              #dscam030#4 = #canempr@#CmpEmp#; |HAZ BuscaPeriodo;
                              #dscam033#4 = #canempr@#CmpEmp#; #dscam033#5 = nPeriodo;
                              #dscam030#4 = #canempr@#CmpEmp#; #dscam030#5 = nPeriodo;
                           |SINO;
                              #dscam033#4 = #canempr@#CmpEmp#; #dscam033#5 = #canempr@#CmpPer#;
                              #dscam030#4 = #canempr@#CmpEmp#; #dscam030#5 = #canempr@#CmpPer#;
                           |FINSI;
                        |FINSI;
                     |FINSI;
                     Fichero = "Empresas"; Tipo = "C"; Cmp = "Codigo Empresa"; |HAZ ObtenDato;
                     #canempr@#CmpNum# = #dscam033#4;
                     Fichero = "Empresas"; Tipo = "C"; Cmp = "Periodo";        |HAZ ObtenDato;
                     #canempr@#CmpNum# = #dscam033#5;
                     |LEE 000#canempr@.=;
                     |SI FSalida = 0;
                        aAlfa = #caenlac@#1; |QBF aAlfa; aAlfa = aAlfa % -104; nAnyo = aAlfa;
                        fFechaEje = #caenlac@#1;
                        Fichero = "Empresas"; Tipo = "C"; Cmp = "Ejercicio"; |HAZ ObtenDato;
                        nCalc = #canempr@#CmpNum#;
                        |SI nCalc ] 80; nCalc = nCalc + 1900; |SINO; nCalc = nCalc + 2000; |FINSI;
                        aAlfa = "01." + (("00" + #canempr@#11) % -102) + "." + nCalc;       fFechaIni = aAlfa;
                        nCalc = nCalc + 1;
                        nCalc1 = #canempr@#12 + 1;
                        |SI nCalc1 > 12; nCalc1 = 1; |FINSI;
                        aAlfa = "01." + (("00" + nCalc1) % -102) + "." + nCalc; fFechaFin = aAlfa;
                        nCalc1 = fFechaFin; nCalc1 = nCalc1 - 1; fFechaFin = nCalc1;
                        |SI fFechaIni > fFechaEje; |O fFechaEje > fFechaFin;
                           |HAZ BuscaPeriodo;
                           #caenlac@#37 = #dscam033#4; #caenlac@#38 = nPeriodo;
                        |SINO;
                           #caenlac@#37 = #dscam033#4; #caenlac@#38 = #dscam033#5;
                        |FINSI;
                     |FINSI;
                     |CIERRA #canempr@; |DESCARGA_DEF #canempr@;
                  |FINSI;
                  |CIERRA #caconas@;

                  nSwFueraEj = 0;
                  |SI #caenlac@#38 = -1;
                     |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
                        ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
                        ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
                        ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
                        |SI #dscam030#2 = TiposEnlaces; |SAL; |FINSI;
                     |SIGUE;

                     |LEE 000#dscaw109.u; Calc = #dscaw109#0;
                     |DDEFECTO #dscaw109;
                     #dscaw109#0 = Calc + 1;
                     #dscaw109#1 = "A";
                     aAlfa = "Registro " + #dscam030#2 + "/";
                     Calc = Campo1Clave; Comodin = #Referen@#Calc#; |QBF Comodin; Comodin = (("000000000" + Comodin) % -109);
                     aAlfa = aAlfa + Comodin + "/";
                     Calc = Campo2Clave; Comodin = #Referen@#Calc#; |QBF Comodin; Comodin = (("000" + Comodin) % -103);
                     aAlfa = aAlfa + Comodin + " sin ubicar en ningun periodo contable. Ser omitido.";
                     #dscaw109#2 = aAlfa;
                     |GRABA 020#dscaw109.n;

                     aLogTitulo = "Registro numero " + NumRegistro + "(" + #dscam030#2 + "/";
                     Calc = Campo1Clave; Comodin = #Referen@#Calc#; |QBF Comodin;
                     aLogTitulo = aLogTitulo + Comodin + "/";
                     Calc = Campo2Clave; Comodin = #Referen@#Calc#; |QBF Comodin;
                     aLogTitulo = aLogTitulo + Comodin;
                     aLogTitulo = aLogTitulo + "). Imposible buscar ubicacion en periodos contables. Siguiente registro."; |HAZ ApuntaLog;
                     nSwFueraEj = 1;
                     |VETE Salta;
                  |FINSI;

                  Comodin2 = ("00000" + #caenlac@#37) % -105;
                  Comodin2 = Comodin2 + #caenlac@#38 + "/";
                  Comodin1 = PathEnlace; |QBF Comodin1;
                  Comodin1 = Comodin1 + "fich/" + Comodin2;
                  |PATH_DAT #24 Comodin1;
                  |ABRE #caconas@;

                  || Compruebo si tengo el asiento apuntado en el historico de enlaces.
                  ||     Si est, tomo ese n de documento, y si no, tomo uno nuevo
                  |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
                     ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
                     InAsiento     = nAsiento1<-;     InAsiento     = InAsiento     + Cont;
                     ICampo1Clave  = Campo1Clave1<-;  ICampo1Clave  = ICampo1Clave  + Cont;
                     ICampo2Clave  = Campo2Clave1<-;  ICampo2Clave  = ICampo2Clave  + Cont;
                     |SI #dscam030#2 = TiposEnlaces;
                        #dscam067#8 = #caenlac@#37;
                        #dscam067#9 = #caenlac@#38;
                        #dscam067#0 = #dscam030#2;
                        Calc = Campo1Clave; Comodin = #Referen@#Calc#;
                        #dscam067#1 = Comodin;
                        Calc = Campo2Clave; Comodin = #Referen@#Calc#;
                        #dscam067#2 = Comodin;
                        #dscam067#3  = TipoEnl;
                        #dscam067#11 = #dscam031#2;
                        |LEE 101#dscam067.=;
                        |SI FSalida = 0;
                           aCampo1 = #caenlac@#0;
                           aCampo2 = #caenlac@#1;
                           aCampo3 = #caenlac@#2;
                           aCampo4 = #caenlac@#3;
                           aCampo5 = #caenlac@#37;
                           aCampo6 = #caenlac@#38;
                           |DDEFECTO #caenlac@;
                           #caenlac@#0 = #dscam067#4;
                           #caenlac@#1 = #dscam067#5;
                           #caenlac@#2 = #dscam067#6;
                           #caenlac@#37 = #dscam067#8;
                           #caenlac@#38 = #dscam067#9;
                           #dscam067#9 = #caenlac@#38;
                           #caenlac@#3 = 0;
                           |LEE 000#caenlac@.=;
                           |SI FSalida ! 0;
                              #caenlac@#37 = #dscam067#8;
                              #caenlac@#38 = #dscam067#9;
                              #caenlac@#0 = #dscam067#4;
                              #caenlac@#1 = #dscam067#5;
                              #caenlac@#2 = #dscam067#6;
                              #caenlac@#3 = 0;
                              #caenlac@#9 = 0;
                              #caenlac@#25 = "S";
                              |GRABA 020#caenlac@.n; |LEE 000#caenlac@.=;
                           |FINSI;
                           #caenlac@#0  = aCampo1;
                           #caenlac@#1  = aCampo2;
                           #caenlac@#2  = aCampo3;
                           #caenlac@#3  = aCampo4;
                           #caenlac@#37 = aCampo5;
                           #caenlac@#38 = aCampo6;
                           |SI #dscam067#4 = 0; |Y #dscam067#5 = "00.00.0000"; |Y #dscam067#6 = 0;
                              |LIBERA #dscam067;
                              |VETE Salta;
                           |FINSI;
                           Calc = #dscam067#6;
                           |SI NumAsientos ! Calc;
                              NumAsientos = Calc;
                              NumApunte = 1; NVuelta = 0;
                              || ABDON 18/09/2007 Tiquet 2743/1266
                              || Si no se pone la condicion siguiente, hay casos en los que
                              ||   al volver a enlazar renueva el n de documento
                              |SI #dscam031#5 = "N";
                                 |SI #dscam030#8 ! "N";
                                    |SI #dscam030#2 = "CB"; nCmpSec = 43; |FINSI;
                                    |SI #dscam030#2 = "PG"; nCmpSec = 33; |FINSI;
                                    |SI #dscam030#2 = "CF"; nCmpSec = 23; |FINSI;
                                    CmpClave1Cab = #Referen@#nCmpSec#;
                                 |FINSI;
                              |FINSI;
                           |FINSI;
                           |SI #dscam030#8 = "N";
                              Calc  = Campo1Clave; CmpClave1Cab = #Referen@#Calc#;
                              Calc1 = Campo2Clave; CmpClave2Cab = #Referen@#Calc1#;
                           |FINSI;

                           |SI Modo = "B";
                              nContDi  = #dscam067#4;
                              fContFe  = #dscam067#5;
                              nContAs  = #dscam067#6;
                              nEmpresa = #dscam067#8;
                              nPeriodo = #dscam067#9;
                              |BORRA 020#dscam067.a; |LIBERA #dscam067;
                              |BUCLE BorraHist;

                           |FINSI;
                           |LIBERA #dscam067;
                        |FINSI;
                        |SAL;
                     |FINSI;
                  |SIGUE;

                  |SI Modo = "B"; |VETE Salta; |FINSI;

                  || Miro si necesito tomar un nuevo n de documento

                  |SI #dscam031#5 = "N";
                     |SI #dscam030#8 = "N";
                        Calc = Campo1Clave; Calc1 = Campo2Clave;
                        |SI CmpClave1Cab ! #Referen@#Calc#;
                           NumAsientos = -1; NumApunte = 1; NVuelta = 1;
                           CmpClave1Cab = #Referen@#Calc#;
                           CmpClave2Cab = #Referen@#Calc1#;
                        |SINO;
                           NVuelta = NVuelta + 1;
                        |FINSI;
                     |SINO;
                        |SI #dscam030#2 = "CB"; nCmpSec = 43; |FINSI;
                        |SI #dscam030#2 = "PG"; nCmpSec = 33; |FINSI;
                        |SI #dscam030#2 = "CF"; nCmpSec = 23; |FINSI;
                        |SI CmpClave1Cab ! #Referen@#nCmpSec#;
                           |SI CmpClave1Cab ! 0;
                              NumAsientos = -1; NumApunte = 1; NVuelta = 1;
                           |FINSI;
                           CmpClave1Cab = #Referen@#nCmpSec#;
                        |SINO;
                           NVuelta = NVuelta + 1;
                        |FINSI;
                     |FINSI;
                  |FINSI;

                  |SI NumAsientos < 0;
                     |HAZ Contador; NumApunte = 1; NVuelta = 1;
                     |SI nErrContador = 1; |SAL; |FINSI;
                  |FINSI;

                  |SI #dscam031#5 = "N";
                     |SI #dscam030#7 = "S";
                        |SI UltFecha ! #caenlac@#1; |Y NumApunte ! 1;
                           |HAZ Contador; NumApunte = 1;
                           |SI nErrContador = 1; |SAL; |FINSI;
                        |FINSI;
                     |FINSI;
                  |FINSI;
                  UltFecha  = #caenlac@#1;

|| ABDON Tiquet 2359/508 No comprobaba que si se cambia de empresa con la anterior
||     hay que tomar un nuevo n de documento

                  |SI #dscam051#62 = "S";
                     |SI UltEmpr ! #caenlac@#37; |O UltPeri ! #caenlac@#38;
                        |SI NumApunte ! 1;
                           |HAZ Contador; NumApunte = 1;
                           |SI nErrContador = 1; |SAL; |FINSI;
                        |FINSI;
                     |FINSI;
                  |FINSI;
                  UltEmpr = #caenlac@#37; UltPeri = #caenlac@#38;
                  #caenlac@#2 = NumAsientos;

                  || Preparado para escribir el asiento en el temporal
                  |HAZ Asiento; SwAsiento = 1;
               |SINO;
                  aLogTitulo = "Registro numero " + NumRegistro + ". Registro fuera de la acotacion. Siguiente registro."; |HAZ ApuntaLog;
               |FINSI;
|ET Salta;
               |CIERRA #dscaw012; |LIBERA #Referen@;
               |LEE 101#Referen@.s; NumRegistro = NumRegistro + 1;
               |SI SwAsiento = 1; |Y #dscam031#6 = "S"; FSalida = 111; |FINSI;
            |SIGUE;
         |FINSI;
         |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
         |SI nSw > 0; |FINIMP; |FINSI;
      |FINSI;
   |SINO;
      |SI PARAMETRO = "";
         |SI enSinConfi = 0;
            |MENAV "    Seleccion vacia";
         |SINO;
            aLogTitulo = "Seleccion vacia"; |HAZ ApuntaLog;
            |XGRABA enHandLog, aLogTitulo;
         |FINSI;
      |FINSI;
   |FINSI;

   NumRegistro = 1;
   NumAsientos = -1;
   |REPON_FICHA #dscam031;

   |SI nSerie ! -1;
       #dscam033#4 = nEmpr; #dscam033#5 = nPeri;
   |FINSI;
|FPRC;

|DEFBUCLE Asientos;
#dscam031#1;
;
CodEnlace,000001;
CodEnlace,999999;
;
NULL,BucleFichero;
|FIN;

|PROCESO LineasLog;
   |DDEFECTO #dscam034;
   #dscam034#0  = #caenlac@#0;
   #dscam034#1  = #caenlac@#1;
   #dscam034#2  = #caenlac@#2;
   #dscam034#3  = #caenlac@#3;
   #dscam034#4  = #caenlac@#4;
   #dscam034#5  = #caenlac@#5;
   #dscam034#6  = #caenlac@#6;
   #dscam034#7  = #caenlac@#7;
   #dscam034#8  = #caenlac@#8;
   #dscam034#9  = #caenlac@#9;
   #dscam034#10 = #caenlac@#16;
   #dscam034#11 = #caenlac@#16;
   #dscam034#12 = #caenlac@#37;
   #dscam034#13 = #caenlac@#38;
   #dscam034#14 = #caenlac@#15;

   Comodin  = PathEnlace; |QBF Comodin;
   Comodin1 = Comodin;
   Fichero = "Empresas"; Tipo = "C"; Cmp = ""; |HAZ ObtenFich;
   Comodin = Comodin + "def/" + Fichero + ".mas";
   Comodin1 = Comodin1 + "fich/";
   |CARGA_DEF Comodin , canempr@;
   |SI FSalida = 0;
      |PATH_DAT #20 Comodin1; |ABRE #canempr@;
      Fichero = "Empresas"; Tipo = "C"; Cmp = "Codigo Empresa"; |HAZ ObtenDato;
      #canempr@#CmpNum# = #caenlac@#37;
      Fichero = "Empresas"; Tipo = "C"; Cmp = "Periodo";        |HAZ ObtenDato;
      #canempr@#CmpNum# = #caenlac@#38;
      |LEE 000#canempr@.=;
      |SI FSalida = 0;
         Fichero = "Empresas"; Tipo = "C"; Cmp = "Nombre Comercial"; |HAZ ObtenDato;
         #dscam034#15 = #canempr@#CmpNum#;
      |FINSI;
   |FINSI;
   |CIERRA #canempr@; |DESCARGA_DEF #canempr@;

   |SI #dscam034#9 ! 0;
      nSwHay = 1; |GRABA 020#dscam034.n;
   |FINSI;

   #dscaw103#0 = #caenlac@#0;
   #dscaw103#1 = #caenlac@#1;
   #dscaw103#2 = #caenlac@#2;
   |LEE 000#dscaw103.=;
   |SI FSalida = 0; |Y #dscaw103#3 = "S";
      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "contagen/def/caivam02.mas";
      |CARGA_DEF aAlfa, caivm02@;
      |SI FSalida = 0;
         |DBASS aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + "contagen/fich/" + (("00000" + #caenlac@#37) % -105) + #caenlac@#38 + "/"; |PATH_DAT #caivm02@#aAlfa#;
         |ABRE #caivm02@;
         #caivm02@#0 = #caenlac@#2;
         #caivm02@#1 = #caenlac@#0;
         #caivm02@#2 = #caenlac@#1;
         |LEE 101#caivm02@.=;
         |SI FSalida = 0;
            |BORRA 020#caivm02@.a;
         |FINSI;
         |LIBERA #caivm02@;
      |FINSI;
      |CIERRA #caivm02@; |DESCARGA_DEF #caivm02@;
   |FINSI;
|FPRC;

|DEFBUCLE LineasLog;
#caenlac@#1006;
;
00,"00.00.0000",000001,0001,00000,0;
99,"31.12.2999",999999,9999,99999,9;
;
NULL,LineasLog;
|FIN;

|PROCESO RellenaAcot;
   |DDEFECTO #dscaw013;
   |PARA Cont = 0; |SI Cont [ 17; |HACIENDO Cont = Cont + 1;
      #dscaw013#Cont# = #dscam036#Cont#;
   |SIGUE;
   |GRABA 020#dscaw013.n;
|FPRC;

|DEFBUCLE RellenaAcot1;
#dscam036#2;
;
CodEnlace,"S",001;
CodEnlace,"S",999;
;
NULL,RellenaAcot;
|FIN;

|DEFBUCLE RellenaAcot2;
#dscam036#2;
;
CodEnlace,"N",001;
CodEnlace,"N",999;
;
NULL,RellenaAcot;
|FIN;

|PROCESO Meollo;
   |DBASE Comodin; |QBF Comodin;
   Comodin = Comodin + "def/" + Fich1 + ".mas";
   |CARGA_DEF Comodin, Princip@;
   |SI FSalida ! 0; |ACABA; |FINSI;
   |SI nSwPath    = 1; || En caso de llamar al dsrecibo desde fuera no sabe
                       ||     donde est
      |PATH_DAT #Princip@#PathAplic#;
   |FINSI;
   |ABRE #Princip@;

   aLogTitulo = "Inicio de preseleccion."; |HAZ ApuntaLog;
   |PUSHV 0501 2380; |BLANCO 0919 1666;

   |HAZ Prelavado;

   aLogTitulo = "Acabada la preseleccion. Preparacion sentencia SQL."; |HAZ ApuntaLog;
   aLogTitulo = "Ejecucion sentencia SQL."; |HAZ ApuntaLog;
   |MENSA "    Ejecutando consulta";

   Fichero1 = Fich1; |HAZ GeneraSQL;
   |SI nHandle ] 0; |XGRABA nHandle, Fichero1; |FINSI;

   |SI nSwAcot ] 0;
      aAlfa = Fichero1; |QBF aAlfa;
      aAlfa = aAlfa - "FROM dscam004";
      |SI FSalida ! 0;
         aEsCobro = "S";
         Fichero1 = Fichero1 + " AND 55 == 'N'";
      |FINSI;
      |SQL Fichero1;
      aAlfa = FSalida;
      aEstado = FSalida;

      aLogTitulo = "Fin sentencia SQL. Respuesta : " + aEstado;
      |HAZ ApuntaLog;

/*
      ||...PARCHE: Borra los que no tienen la cabecera en el dscam0003
      |SI aEsCobro = "S";
           |HAZ PurgaCobros;
      |FINSI;
      ||...
*/
      aAlfa2 = "    Registros " + aAlfa % 0399; |MENSA aAlfa2;
      aAlfa2 = ""; NumRegistro = 1;
      |PARA; |SI; |HACIENDO;
         aAlfa1 = aAlfa % -101;
         aLong = aAlfa % 0; nLong = aLong; Calc = 100 + (nLong - 1);
         aAlfa = aAlfa % Calc;
         |SI aAlfa1 = ":";
            TotalRegs = aAlfa2;
            |SAL;
         |SINO;
            aAlfa2 = aAlfa1 + aAlfa2;
         |FINSI;
      |SIGUE;
      aAlfa = aAlfa % -102;

      aAlfa2 = aEstado % 0102; nCalc = aAlfa2;
      |SI nCalc = 0;
         aAlfa2 = aEstado; aAlfa2 = aAlfa2 % 0399;
         |DDEF aAlfa;   |QBF aAlfa; aAlfa = aAlfa + Fich1 + ".mas";
         |DFICE aAlfa1; |QBF aAlfa1;
         |LEEDEDEF aAlfa, aAlfa1; aAlfa = FSalida % 1815; |QBT aAlfa;
         |SI enNumRegs = -1; enNumRegs = aAlfa; |FINSI;
         aAlfa = "    Totales:" + aAlfa + "   Preseleccionados:" + enNumRegs + "   " + aAlfa2;
         |MENSA aAlfa;
         aAlfa2 = "0 " + aAlfa2; FSalida = aAlfa2;
      |FINSI;

      aLogTitulo = "Inicio de bucle de montaje de los asientos."; |HAZ ApuntaLog;

      |SI #dscam030#2 = "CB"; |O #dscam030#2 = "PG";
         |PATH_DAT #4 PathAplic;
         |ABRE #dscam029; |SELECT #3#dscam029;
         |SI #dscam030#2 = "CB"; #dscam029#1 = "dscam003"; |FINSI;
         |SI #dscam030#2 = "PG"; #dscam029#1 = "dscam008"; |FINSI;
         #dscam029#2 = 4;
         #dscam029#4 = #dscam030#2;
         |LEE 000#dscam029.=;
         |SI FSalida ! 0;
            |SELECT #1#dscam029;

            |DDEFECTO #dscam029;
            |LEE 000#dscam029.u;
            nCalc = #dscam029#0 + 1;
            |DDEFECTO #dscam029;
            #dscam029#0 = nCalc;
            |SI #dscam030#2 = "CB"; #dscam029#1 = "dscam003"; |FINSI;
            |SI #dscam030#2 = "PG"; #dscam029#1 = "dscam008"; |FINSI;
            #dscam029#2 = 4;
            #dscam029#3 = "Fecha emision";
            #dscam029#4 = #dscam030#2;
            #dscam029#5 = "A";
            |GRABA 020#dscam029.n;
         |FINSI;
         |SELECT #1#dscam029; |CIERRA #dscam029;
      |FINSI;

      |DELINDEX #dscaw109; |ABRE #dscaw109;
      |BUCLE Asientos;
      |CIERRA #dscaw109;

      |POPV;

      |DBASE Comodin; |QBF Comodin; Comodin2 = Usuario; |QBF Comodin2;
      Comodin1 = Comodin + "def/tm" + Comodin2 + ".mas"; |FBORRA Comodin1;
      |DFICE Comodin; |QBF Comodin;
      Comodin1 = Comodin + "sq" + Comodin2 + ".dat"; |FBORRA Comodin1;
      Comodin1 = Comodin + "sq" + Comodin2 + ".ddx"; |FBORRA Comodin1;
      Comodin1 = Comodin + "sq" + Comodin2 + ".ixx"; |FBORRA Comodin1;
   |FINSI;

   |LIBERA #Princip@;
   |CIERRA #Princip@; |DESCARGA_DEF #Princip@;
|FPRC;

|PROCESO ElimHist;
   aAlfa = "|NC"; aAlfa = #caenlac@#aAlfa#; nCalc = aAlfa;
   |SI nCalc ] 49;
      nCalc = 48; |SI #caenlac@#nCalc# ! "S"; |ACABA; |FINSI;
   |FINSI;
   nContDi  = #caenlac@#0;  fContFe  = #caenlac@#1;  nContAs  = #caenlac@#2;
   nEmpresa = #caenlac@#37; nPeriodo = #caenlac@#38;
   |BUCLE BorraHist;
|FPRC;

|DEFBUCLE ElimHist;
#caenlac@#1006;
;
00,"01.01.0000",000000,0000,00000,0;
99,"31.12.9999",999999,9999,99999,9;
;
NULL,ElimHist;
|FIN;

|PROGRAMA;
   nMenosUno = -1;
   enGenAsi0 = 1;
   enGenIva0 = 1;

   enNoModif = 150;
   |ABRE #dscam051;
   |LEE 000#dscam051.p;
   |SI FSalida ! 0; |DDEFECTO #dscam051; |FINSI;
   |CIERRA #dscam051;

   aAlfa = "yy" + Usuario; |NOME_DAT #dscaw103#aAlfa#;
   |DELINDEX #dscaw103; |ABRE #dscaw103;

   |SI enSinConfi ! 0;
      |DFICE aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "tmp/"; |MKDIR aAlfa;
      aAlfa = aAlfa + Usuario + ".spo";
      |XABRE "W", aAlfa, enHandLog;
   |FINSI;
/*   USAMOS EL LOG ESTANDAR
   |SI aNombreLog ! "";
      |XABRE "A", aNombreLog, nHandle;
   |SINO;
      nHandle = -1;
      |HORA aAlfaLog1; |QBF aAlfaLog1;
      aAlfaLog1 = (aAlfaLog1 % 0102) + (aAlfaLog1 % 0402) + (aAlfaLog1 % 0702);
      fFechaLog = ~; aAlfaLog2 = fFechaLog; |QBF aAlfaLog2;
      aAlfaLog2 = (aAlfaLog2 % 0704) + (aAlfaLog2 % 0402) + (aAlfaLog2 % 0102);
      aNombreLog = "c:\documentos\logs\"; |RMKDIR aNombreLog;
      aNombreLog = aNombreLog + "log" + aAlfaLog2 + aAlfaLog1 + ".txt";
      |XABRE "CW", aNombreLog, nHandle;
   |FINSI;
*/
   aLogTitulo = "Entrada al proceso de enlace. Preparacion de variables."; |HAZ ApuntaLog;

   nVersion = 1;
   Base = nDeci_Base; Div = nDeci_Div;
   fFecha = ~; aAlfa = fFecha; |QBF aAlfa;
   aAlfa = aAlfa % -104; nAnyo = aAlfa; fFecha = "01.01.0000";
   nDeci_Base = 6; nDeci_Div = 6;
   |SI PARAMETRO ! "";
      |SI eaLlamada = "A";
/*
         |PUSHV 0501 2380;
         |BLANCO 0803 1476;
         |CUADRO 0803 1476;
         |PINTA 0905, "Se va a proceder a la ejecucion del enlace contable para la contabili-";
         |PINTA 1005, "zacion del movimiento que se acaba de hacer. Si no desea continuar, si";
         |PINTA 1105, "el movimiento ya estaba contabilizado no se actualizaran los cambios y";
         |PINTA 1205, "si no lo estaba no se reflejara en la contabilidad. Podra de todos mo-";
         |PINTA 1305, "dos hacer el enlace manualmente.  Desea continuar ? ( / )            ";
         |ATRI I; |PINTA 1359, "S"; |PINTA 1361, "N"; |ATRI R;
         aResp = "N";
         E_sup = 1;
         E_inf = "SN";
         aResp = 1364 ? 0;
         FEstado = FSalida;
         |POPV;
         |SI FEstado ! 0; |ACABA; |FINSI;
         |SI aResp = "N"; |ACABA; |FINSI;
         |SI aResp = "S"; eaLlamada = ""; |FINSI;
*/
      |FINSI;
      nSwPath    = 0;
      CodEnlace = PARAMETRO;
      CodEnlace = CodEnlace - "|";
      |SI FSalida ! 0;
         Calc = (((FSalida / 100) ! 0) * 100) + 99;
         PathAplic = CodEnlace % Calc;
         CodEnlace = CodEnlace - PathAplic;
         |PATH_DAT #100 PathAplic;
      |SINO;
         |DFICE PathAplic;
         aAlfa = PathAplic; |QBF aAlfa;
         aAlfa = aAlfa % -105;
         |SI aAlfa = "fich/";
            nSwPath    = 1;
            PathAplic = PathAplic + (("00000" + enEmpCartera) % -105) + "/";
            |PATH_DAT #1000 PathAplic;
         |FINSI;
      |FINSI;
      |PATH_DAT #13 PathAplic; |PATH_DAT #2 PathAplic; |PATH_DAT #3 PathAplic; |PATH_DAT #17 PathAplic;

      |PATH_DAT #dscam051#PathAplic#; |PATH_DAT #dscam094#PathAplic#;
      |ABRE #dscam051;
      |LEE 000#dscam051.p;
      |SI FSalida ! 0; |DDEFECTO #dscam051; |FINSI;
      |CIERRA #dscam051;

      CodEnlace = CodEnlace - ",B";
      |SI FSalida ! 0;
         Modo = "B";
         aLogTitulo = "ATENCION !!!! Enlace de desactualizacion"; |HAZ ApuntaLog;
      |FINSI;
      FechaVto = ""; FechaAbo = "";
      CodEnlace = CodEnlace - ",V";
      |SI FSalida ! 0;
         TipoEnl = "V";
         Contabil3 = 9; Contabil4 = 8; Contabil6 = 8;
         Calc = FSalida + 8;
         FechaVto = CodEnlace % Calc; CodEnlace = CodEnlace - FechaVto;
         |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
            InAsiento    = nAsiento1<-;     InAsiento    = InAsiento    + Cont;
            InAstoVto    = nAstoVto1<-;     InAstoVto    = InAstoVto    + Cont;
            ICmpEmpresa  = CmpEmpresa1<-;   ICmpEmpresa  = ICmpEmpresa  + Cont;
            ICmpPeriodo  = CmpPeriodo1<-;   ICmpPeriodo  = ICmpPeriodo  + Cont;
            ICmpEnlace   = CmpEnlace1<-;    ICmpEnlace   = ICmpEnlace   + Cont;
            IEmprVto     = EmprVto1<-;      IEmprVto     = IEmprVto     + Cont;
            IPeriVto     = PeriVto1<-;      IPeriVto     = IPeriVto     + Cont;
            IEnlVto      = EnlVto1<-;       IEnlVto      = IEnlVto      + Cont;
            IFechas      = Fechas1<-;       IFechas      = IFechas      + Cont;
            IFecVto      = FecVto1<-;       IFecVto      = IFecVto      + Cont;
            nAsiento     = nAstoVto; CmpEmpresa  = EmprVto;
            CmpPeriodo   = PeriVto;  CmpEnlace   = EnlVto;
            Fechas = FecVto;
         |SIGUE;
      |SINO;
         CodEnlace = CodEnlace - ",E";
         |SI FSalida ! 0;
            nCalc3 = FSalida + 8; FechaAbo = CodEnlace % nCalc3;
            TipoEnl = "E"; Contabil3 = 8; Contabil4 = -1; Contabil6 = -1;

            || Ahora tengo que asegurarme que es una fecha, para tomarla como
            ||    fecha de abono y eliminarla de la linea de parametros
            aAlfa4 = FechaAbo % 0301;
            |SI aAlfa4 ! ".";
               FechaAbo = "";
            |SINO;
               aAlfa4 = FechaAbo % 0601;
               |SI aAlfa4 ! ".";
                  FechaAbo = "";
               |SINO;
                  aAlfa4 = FechaAbo % 0402; nCalc3 = aAlfa4;
                  |SI nCalc3 < 1; |O nCalc3 > 12;
                     FechaAbo = "";
                  |SINO;
                     aAlfa4 = FechaAbo % 0102; nCalc3 = aAlfa4;
                     |SI nCalc3 < 1; |O nCalc3 > 31;
                        FechaAbo = "";
                     |SINO;  || Es una fecha
                        CodEnlace = CodEnlace - FechaAbo;
                     |FINSI;
                  |FINSI;
               |FINSI;
            |FINSI;
         |SINO;
            CodEnlace = CodEnlace - ",I";
            |SI FSalida ! 0;
               TipoEnl = "I";
               Contabil3 = 23; Contabil4 = -1; Contabil6 = -1;
            |FINSI;
         |FINSI;
         |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
            InAsiento    = nAsiento1<-;     InAsiento    = InAsiento + Cont;
            InAstoEmi    = nAstoEmi1<-;     InAstoEmi    = InAstoEmi + Cont;
            ICmpEmpresa  = CmpEmpresa1<-;   ICmpEmpresa  = ICmpEmpresa  + Cont;
            ICmpPeriodo  = CmpPeriodo1<-;   ICmpPeriodo  = ICmpPeriodo  + Cont;
            ICmpEnlace   = CmpEnlace1<-;    ICmpEnlace   = ICmpEnlace   + Cont;
            IEmprEmi     = EmprEmi1<-;      IEmprEmi     = IEmprEmi     + Cont;
            IPeriEmi     = PeriEmi1<-;      IPeriEmi     = IPeriEmi     + Cont;
            IEnlEmi      = EnlEmi1<-;       IEnlEmi      = IEnlEmi      + Cont;
            IFechas      = Fechas1<-;       IFechas      = IFechas      + Cont;
            IFecEmi      = FecEmi1<-;       IFecEmi      = IFecEmi      + Cont;
            nAsiento     = nAstoEmi; CmpEmpresa  = EmprEmi;
            CmpPeriodo   = PeriEmi;  CmpEnlace   = EnlEmi;
            Fechas = FecEmi;
         |SIGUE;
      |FINSI;

      |ABRE #dscam067; |ABRE #dscam030;
      #dscam030#0 = CodEnlace;
      |LEE 000#dscam030.=;
      |SI FSalida = 0;
         PathEnlace = #dscam030#6;
         #dscam033#0 =#dscam030#0;
         #dscam033#1 =#dscam030#1;
         #dscam033#4 =#dscam030#4;
         #dscam033#5 =#dscam030#5;
         SwError = 0;
         |HAZ MiraEmp;
      |FINSI;
      |CIERRA #dscam030;
      FSalida = 0;
      |SI SwError = 1; |VETE Acaba; |FINSI;
   |SINO;
      |DFICE PathAplic;
      aAlfa = PathAplic; |QBF aAlfa;
      aAlfa = aAlfa % -105;
      |SI aAlfa = "fich/";
         PathAplic = PathAplic + (("00000" + enEmpCartera) % -105) + "/";
      |FINSI;
      |ABRE #dscam067;
      |CLS;
      |PINPA #0#0;
      |PINDA #0#0;
      |ENDATOS #1#dscam033;
   |FINSI;
   |SI FSalida = 0;
      |SI PARAMETRO = "";
         CodEnlace = #dscam033#0;
         Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
         |NOME_DAT #5 Comodin;
         Comodin = Usuario; |QBF Comodin; Comodin = "ad" + Comodin;
         |NOME_DAT #7 Comodin;
         Comodin = Usuario; |QBF Comodin; Comodin = "ae" + Comodin;
         |NOME_DAT #8 Comodin;
         |DELINDEX #dscaw013; |ABRE #dscaw013;
         |BUCLE RellenaAcot1;
         |PARA; |SI; |HACIENDO;
            |PTEC 808; eaCodEnlace = #dscam033#0;
            |PINPA #0#dscaw013;
            |ENTLINEAL #2#dscaw013,-3,1,21,0,infe1,supe1;
            |MENU Menu;
            Opcion = FSalida;
            |SI Opcion = 2; Salir = 0; |SAL; |FINSI;
            |SI Opcion = 3; Salir = 1; |SAL; |FINSI;
         |SIGUE;
         |BUCLE RellenaAcot2;
         |CIERRA #dscaw013;
      |SINO;
         |HAZ TomaDefec033;
      |FINSI;

      |SI Salir = 1;  || Cancelar
         |VETE Acaba;
      |FINSI;

      |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
         ITiposEnlaces = TiposEnlaces1<-; ITiposEnlaces = ITiposEnlaces + Cont;
         IFicheros     = Ficheros1<-;     IFicheros     = IFicheros     + Cont;
         IFichCab      = FichCab1<-;      IFichCab      = IFichCab      + Cont;
         |SI #dscam030#2 = TiposEnlaces;
            |SI #dscam030#2 ! "RM"; |Y #dscam030#2 ! "PA"; |Y #dscam030#2 ! "CF"; |Y #dscam030#2 ! "PD";
               TipoEnl = "";
            |FINSI;
            Fich1 = Ficheros;
            |SAL;
         |FINSI;
      |SIGUE;

      |DBASE Direc;
      Comodin = Direc + "def/" + Fich1 + ".mas";
      |CARGA_DEF Comodin, Tempo00@; Ref = Comodin;
      |SI FSalida = 0;
         Comodin  = PathEnlace; |QBF Comodin;
         Comodin  = Comodin + "def/";
         Comodin1 = Comodin + "caenlace.mas"; |CARGA_DEF Comodin1, caenlac@;
         Comodin1 = Comodin + "caconasi.mas"; |CARGA_DEF Comodin1, caconas@;
         Comodin1 = Comodin + "camaasic.mas"; |CARGA_DEF Comodin1, camasic@;
         |HAZ EsForest;
         |SI FSalida = 0;
            Comodin1 = Comodin + "cacontar.mas"; |CARGA_DEF Comodin1, caconta@;
         |FINSI;

         nEmpre = #dscam033#4; nPerio = #dscam033#5;
         Comodin2 = ("00000" + #dscam033#4) % -105;
         Comodin2 = Comodin2 + #dscam033#5 + "/";
         Comodin1 = PathEnlace; |QBF Comodin1;
         Comodin1 = Comodin1 + "fich/" + Comodin2;
         |PATH_DAT #23 Comodin1; |PATH_DAT #24 Comodin1; |PATH_DAT #26 Comodin1;
         |HAZ EsForest;
         |SI FSalida = 0; |PATH_DAT #30 Comodin1; |FINSI;
         |PATH_DAT #dscaw109#Comodin1#;

         Comodin1 = "en" + Usuario; |NOME_DAT #23 Comodin1;
         Comodin1 = "er" + Usuario; |NOME_DAT #1002 Comodin1;
         aNome = Usuario; |QBF aNome; aNome = "pu" + aNome;
         |NOME_DAT #23 aNome;

         |DELINDEX #caenlac@; |ABRE #caenlac@; |ABRE #caconas@;

         eaUsuario = Usuario % 0810;
         |SI #dscam030#2 = "CB"; eaDescr = "COBROS";       |FINSI;
         |SI #dscam030#2 = "PG"; eaDescr = "PAGOS";        |FINSI;
         |SI #dscam030#2 = "RE"; eaDescr = "REMESAS";      |FINSI;
         |SI #dscam030#2 = "PA"; eaDescr = "PAGARES";      |FINSI;
         |SI #dscam030#2 = "TA"; eaDescr = "TALONES";      |FINSI;
         |SI #dscam030#2 = "CF"; eaDescr = "CONFIRMES";    |FINSI;
         |SI #dscam030#2 = "PD"; eaDescr = "PAGOS DOMIC."; |FINSI;
         eaDescr   = "ENLACE DE " + eaDescr + " (" + CodEnlace + ")";
         eaDescr   = eaDescr + " A LA EMPRESA " + (("00000" + #dscam030#4) % -105) + "/" + #dscam030#5;
         eaDescr   = eaDescr + " DE CONTABILIDAD";
         eaTipoReg = "EN";  eaNumero = CodEnlace;
         eaTipoOp  = " ";   enImpAnt = 0; enImpAct = 0;
         eaFicher = "ENLAC" + #dscam030#2;
         Fichero1 = Fich1; |HAZ GeneraSQL; eaClave = Fichero1;
         nCalc = 0; nCalc1 = 0;
         eaClave = eaClave - "FROM ";
         |SI FSalida ! 0; nCalc = FSalida + 8; |FINSI;
         eaClave = eaClave - "WHERE ";
         |SI FSalida ! 0; nCalc1 = FSalida + 93; |FINSI;
         |SI nCalc ! 0; |O nCalc1 ! 0;
            eaClave = (Fichero1 % nCalc1); Fichero1 = Fichero1 - eaClave;
            eaClave = (Fichero1 % nCalc) + eaClave + (Fichero1 % nCalc1);
         |FINSI;
         |HAZ GrabaAudit;

         |SI nSwAcot ] 0;
            aLogTitulo = "Comienzo del proceso."; |HAZ ApuntaLog;
            NumAsientos = -1; NumApunte = 1; NumAsto = 0;
            |HAZ Meollo;
            ||BUCLE Asientos;          ||  MEOLLO !!!!!!!!! .......
         |SINO;
            |SI enSinConfi = 0;
               |MENAV "    Proceso cancelado";
            |SINO;
               aLogTitulo = " Proceso cancelado";
               |HAZ ApuntaLog; |XGRABA enHandLog, aLogTitulo;
            |FINSI;
         |FINSI;;

         nSigue = 1;
         |SI nErrContador ! 0;
            nSigue = 0;
            |LEE 000#caenlac@.p;
            |SI FSalida = 0;
               |SI enSinConfi = 0;
                  |CONFI "    NProblemas con el contador de contabilidad.  Enlazar lo que hay preparado ?";
               |SINO;
                  aLogTitulo = "Problemas con el contador de contabilidad. Proceso cancelado";
                  |HAZ ApuntaLog;
                  |XGRABA enHandLog, aLogTitulo;
                  FSalida = nMenosUno;
               |FINSI;
               |SI FSalida = 0;
                  nSigue = 1;
               |FINSI;
            |SINO;
               |SI enSinConfi = 0;
                  |MENAV "    Problemas con el contador de contabilidad. Proceso abortado";
               |SINO;
                  aLogTitulo = " Problemas con el contador de contabilidad. Proceso abortado";
                  |HAZ ApuntaLog; |XGRABA enHandLog, aLogTitulo;
               |FINSI;
            |FINSI;
         |FINSI;

         |SI nSigue = 1;
            nSwHay = 0;
            |DELINDEX #dscam034;
            |ABRE #dscam034;
            |BUCLE LineasLog;
            |CIERRA #dscam034;

            |SI PARAMETRO = ""; |Y nSwHay = 1;
               |PARA; |SI; |HACIENDO;
                  |PINPA #0#dscam034;
                  |ENTLINEAL #1#dscam034,-4,4,21,0,inferior,superior;
                  |MENU Menu;
                  Opcion = FSalida;
                  |SI Opcion = 2; Salir = 0; |SAL; |FINSI;
                  |SI Opcion = 3; Salir = 1; |SAL; |FINSI;
               |SIGUE;
            |SINO;
               |SI nSwFueraEj = 1; |Y nSwHay = 0;
                  |SI enSinConfi = 0;
                     |MENAV "    No existe empresa contable donde ubicar los asientos";
                  |SINO;
                     aLogTitulo = " No existe empresa contable donde ubicar los asientos"; |HAZ ApuntaLog;
                     |XGRABA enHandLog, aLogTitulo;
                  |FINSI;

                  Salir = 1;
               |SINO;
                  Salir = 0;
               |FINSI;
            |FINSI;

            |SI Salir = 1;  || Cancelar
               |BUCLE ElimHist;
            |FINSI;

            |SI Salir = 0;
               Comodin2 = ("00000" + #dscam033#4) % -105;
               Comodin2 = Comodin2 + #dscam033#5 + "/";
               fich_alta = Comodin2;

               |HAZ CogeVersion;
               Comodin = PathEnlace; |QBF Comodin;
               Comodin = Comodin - "agicont";
               |SI FSalida = 0;
                  Comodin = PathEnlace; |QBF Comodin;
                  Comodin = ":contagen/dsapunte.tab;" + Comodin;
               |SINO;
                  Comodin = PathEnlace; |QBF Comodin;
                  Comodin = ":agicont/dsapunte.tab;" + Comodin;
               |FINSI;
               #dscam033#4 = nEmpre; #dscam033#5 = nPerio;
               Comodin2 = ("00000" + #dscam033#4) % -105;
               Comodin2 = Comodin2 + #dscam033#5 + "/";
               Comodin = Comodin + "fich/" + Comodin2 + "," + aNome;

               aLogTitulo = "Enviando llamada a contabilidad : '" + Comodin + "'."; |HAZ ApuntaLog;

               |SI enSinConfi ! 0; |XCIERRA enHandLog; |FINSI;

||CONSULTA_CLAVE #1#caenlac@;
               |CIERRA #caenlac@;

               |SUB_EJECUTA_NP Comodin;

               |ABRE #caenlac@; |LEE 000#caenlac@.c;

               aLogTitulo = "Terminada llamada a contabilidad."; |HAZ ApuntaLog;

               |SI enSinConfi ! 0;
                  |DFICE aAlfa; |QBF aAlfa;
                  aAlfa = aAlfa + "tmp/"; |MKDIR aAlfa;
                  aAlfa = aAlfa + Usuario + ".spo";
                  |XABRE "A", aAlfa, enHandLog;
               |FINSI;

               |SI PRMNT_enError ! 0;
                  aLogTitulo = "Proceso abortado desde contabilidad. Eliminando apunte del historico de enlaces."; |HAZ ApuntaLog;
                  |HAZ ElimHist;
               |FINSI;
            |SINO;

            |FINSI;

            |HAZ ComprEnlace;
         |FINSI;

         |HAZ EsForest;
         |SI FSalida = 0;
            |CIERRA #caconta@; |DESCARGA_DEF #caconta@;
         |FINSI;
         |CIERRA #camasic@; |DESCARGA_DEF #camasic@;
         |CIERRA #caconas@; |DESCARGA_DEF #caconas@;
         |CIERRA #caenlac@; |DESCARGA_DEF #caenlac@;

         |DESCARGA_DEF #Tempo00@;

         |DBASE Direc; Comodin = Direc + "def/tempo.mas";  |FBORRA Comodin;
         Comodin = Direc + "fich/tempo.dat"; |FBORRA Comodin;
         Comodin = Direc + "fich/tempo.ddx"; |FBORRA Comodin;
         Comodin = Direc + "fich/tempo.ixx"; |FBORRA Comodin;
      |FINSI;
      |CIERRA #dscam067;
   |FINSI;

   aLogTitulo = "Proceso de enlace terminado."; |HAZ ApuntaLog;

|ET Acaba;
   nDeci_Base = Base; nDeci_Div = Div;

   |SI enSinConfi ! 0;
      |XCIERRA enHandLog;

      |DFICE aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "tmp/"; |MKDIR aAlfa;
      aAlfa = aAlfa + Usuario + ".spo";
      |XABRE "", aAlfa, enHandLog;
      |SI FSalida ] 0;
         |XLEE enHandLog, 4, aAlfa;
         |SI FSalida ] 0;
            |XCIERRA enHandLog;
            |HAZ EnviaCorreo;
         |SINO;
            |XCIERRA enHandLog;
         |FINSI;
      |FINSI;
   |FINSI;

   |CIERRA #dscaw103; |DELINDEX #dscaw103;

   efFechaExt = "01.01.0000";

   |SI nContaErr ! 0; ||Para pruebas de debug-> MiDebug
     |ABRE #231; |CONSULTA_CLAVE #1#231; |CIERRA #231;
     |DELINDEX #231;
   |FINSI;
|FPRO;

|| **************************************************************************
|| **************************************************************************
|| ****              RESOLUCION DE EXPRESIONES Y FORMULAS                ****
|| **************************************************************************
|| **************************************************************************

/*
   Recoge de la variable 'cadena' la expresion a resolver y devuelve el
   valor de la expresion en la variable 'Resultado'
*/

|PROCESO ResuelveExpr;
   |HAZ ResolCampos;

|ET Comienzo;
   PosicAPar = 0;  PosicCPar = 0;
   Cad1 = "";

   Comodin = Cadena;
   Comodin1 = Comodin - "(";
   |SI FSalida ! 0;
      aLong = Comodin % 0; nLong = aLong;
      |PARA Cont = 1; |SI Cont [ nLong; |HACIENDO Cont = Cont + 1;
         Calc = (Cont * 100) + 1;
         Comodin1 = Comodin % Calc;
         |SI Comodin1 = "(";
            PosicAPar = Cont;
            Cad1 = "";
         |SINO;
            |SI Comodin1 = ")";
               PosicCPar = Cont;
               |SI PosicAPar ! 0;
                  |HAZ ResolSimple;
                  Calc1 = 100 + (PosicAPar - 1);
                  Calc2 = ((PosicCPar + 1) * 100) + 99;
                  Comodin1 = Comodin % Calc1;
                  Comodin1 = Comodin1 + Cad1;
                  Comodin1 = Comodin1 + (Comodin % Calc2);
                  Cadena   = Comodin1;
                  |VETE Comienzo;
               |SINO;
                  |SI enSinConfi = 0;
                     |MENAV "    Error de sintaxis en la expresion";
                  |SINO;
                     aLogTitulo = " Error de sintaxis en la expresion"; |HAZ ApuntaLog;
                     |XGRABA enHandLog, aLogTitulo;
                  |FINSI;
                  |ERROR;
                  |ACABA;
               |FINSI;
            |SINO;
               Cad1 = Cad1 + Comodin1;
            |FINSI;
         |FINSI;
      |SIGUE;
   |FINSI;

   Cad1 = Cadena;
   |HAZ ResolSimple;
   Resultado = Cad1;
|FPRC;

|PROCESO ResolSimple;
   Comodin1 = Cad1;
   Comodin1 = Comodin1 - "+";
   Comodin1 = Comodin1 - "-";
   Comodin1 = Comodin1 - "/";
   Comodin1 = Comodin1 - "*";
   Comodin1 = Comodin1 - "%";
   Comodin1 = Comodin1 - "!";
   Comodin1 = Comodin1 - "?";
   |SI Comodin1 = Cad1; || Si no hay operador, no hay operacion ...
      |ACABA;
   |FINSI;

   Oper1 = 0; Oper2 = 0;
   Operacion = "";
   Cad2 = "";
   Neg = 0;

   aLong = Cad1 % 0; nLong = aLong;

   |PARA Cont1 = 1; |SI Cont1 [ nLong; |HACIENDO Cont1 = Cont1 + 1;
      Calc1 = (Cont1 * 100) + 1;
      Comodin1 = Cad1 % Calc1;
      |SI Comodin1 = "+"; |O Comodin1 = "-";
       |O Comodin1 = "/"; |O Comodin1 = "*";
       |O Comodin1 = "%"; |O Comodin1 = "[";
       |O Comodin1 = "!"; |O Comodin1 = "?";
         |SI Oper1 = 0;
            Oper1 = Cad2;
            |SI Neg = 1; Oper1 = 0 - Oper1; Neg = 0; |FINSI;
            |SI Cad2 = "";
               Neg = 1;
            |SINO;
               Operacion = Comodin1;
               Cad2 = "";
               Neg = 0;
            |FINSI;
         |SINO;
            |SI Cad2 = "";
               |SI Comodin1 = "-"; Neg = 1; |FINSI;
            |SINO;
               Oper2 = Cad2;
               |SI Neg = 1; Oper2 = 0 - Oper2; |FINSI;
               |SI Operacion = "+"; Oper1 = Oper1 + Oper2; |FINSI;  || Suma
               |SI Operacion = "-"; Oper1 = Oper1 - Oper2; |FINSI;  || Resta
               |SI Operacion = "/"; Oper1 = Oper1 / Oper2; |FINSI;  || Division
               |SI Operacion = "*"; Oper1 = Oper1 * Oper2; |FINSI;  || Multiplicacion
               |SI Operacion = "%"; Oper1 = Oper1 % Oper2; |FINSI;  || Porcentaje
               |SI Operacion = "!"; Oper1 = Oper1 ! Oper2; |FINSI;  || Redondeo
               |SI Operacion = "?"; |SI Oper2 < 0; Oper2 = 0 - Oper2; |FINSI; |FINSI; || Valor Absoluto
               Operacion = Comodin1; Cad2 = ""; Neg = 0;
            |FINSI;
         |FINSI;
      |SINO;
         Cad2 = Cad2 + Comodin1;
      |FINSI;
   |SIGUE;

   |QBF Operacion;
   |SI Operacion ! "";
      |SI Cad2 = "";
         |SI Comodin1 = "-"; Neg = 1; |FINSI;
      |SINO;
         Oper2 = Cad2;
         |SI Neg = 1; Oper2 = 0 - Oper2; |FINSI;
         |SI Operacion = "+"; Oper1 = Oper1 + Oper2; |FINSI;
         |SI Operacion = "-"; Oper1 = Oper1 - Oper2; |FINSI;
         |SI Operacion = "/"; Oper1 = Oper1 / Oper2; |FINSI;
         |SI Operacion = "*"; Oper1 = Oper1 * Oper2; |FINSI;
         |SI Operacion = "%"; Oper1 = Oper1 % Oper2; |FINSI;
         |SI Operacion = "!"; Oper1 = Oper1 ! Oper2; |FINSI;
         |SI Operacion = "?"; |SI Oper2 < 0; Oper2 = 0 - Oper2; |FINSI; |FINSI; || Valor Absoluto
      |FINSI;
   |SINO;
      Oper1 = Cad1;
   |FINSI;
   Cad1 = Oper1;
|FPRC;

|PROCESO ResolCampos;
|| Esta rutina obtiene el valor del campo dado por la expresion
||   [fichero][n campo] del temporal de datos relacionados
||   o resuelve la expresion [Memoria]

   Cad1 = "";
   Cad2 = "";
   ||Cadena = #dscam032#8;
   Cadena = Cadena - "][";
   |SI FSalida ! 0;
      |PARA; |SI FSalida ! 0; |HACIENDO;
         |SI nSwCondic = 1;
            nCalc1 = ((((FSalida / 100) ! 0) - 9) * 100) + 1;
            aAlfa4 = Cadena % nCalc1;
            |SI aAlfa4 = "[";
               nCalc4 = ((nCalc1 / 100) ! 0) + 99;
               nCalc5 = ((((nCalc1 / 100) ! 0) + 1) * 100) + 99;
               Cadena = (Cadena % nCalc4) + (Cadena % nCalc5);

               ComodNum = nCalc1;
               ComodNum = ((ComodNum / 100) ! 0);
               ComodNum = 100 + (ComodNum - 1);
               Cad1 = Cadena % ComodNum; Cadena = Cadena - Cad1;
               Fich = Cadena % 0108; |QBF Fich; Cadena = Cadena - Fich;
               Camp = Cadena % 0103; Cadena = Cadena - Camp;

               aAlfa4 = Cadena % 0101;
               |SI aAlfa4 = "]";
                  Cadena = Cadena % 0299;
               |SINO;
                  Cadena = Cadena - "]";
               |FINSI;
               Cad2 = Cadena;
            |SINO;
               Cadena = Cadena - "[";

               ComodNum = FSalida;
               ComodNum = ((ComodNum / 100) ! 0);
               ComodNum = 100 + (ComodNum - 1);
               Cad1 = Cadena % ComodNum; Cadena = Cadena - Cad1;
               Fich = Cadena % 0108; |QBF Fich; Cadena = Cadena - Fich;
               Camp = Cadena % 0103; Cadena = Cadena - Camp;
               Cadena = Cadena - "]";
               Cad2 = Cadena;
            |FINSI;
         |SINO;
            nCalc4 = ((FSalida / 100) ! 0);
            Cadena = Cadena - "[";
            nCalc5 = FSalida;
            ComodNum = ((FSalida / 100) ! 0) + 99;
            Cad1 = Cadena % ComodNum;

            nCalc4 = nCalc4 - ((nCalc5 / 100) ! 0) - 2;
            nCalc5 = nCalc5 + nCalc4;
            Fich = Cadena % nCalc5; |QBF Fich; Cadena = Cadena - Fich;
            nCalc5 = (((nCalc5 / 100) ! 0) * 100) + 3;
            Camp = Cadena % nCalc5; aAlfa6 = Camp + "]";
            Cadena = Cadena - aAlfa6;
            Cadena = Cadena - Cad1;
            Cad2 = Cadena;

            aOpAnt = Fich % 0101;
            |SI aOpAnt = "%";
               aOpAnt = Fich % 0102;
               |SI aOpAnt = "%-";
                  aOpAnt = Fich % 0302;
                  nDgAnt = aOpAnt; nDgAnt = 0 - nDgAnt;
                  aOpAnt = "%";
                  Fich = Fich % 0599;
               |FINSI;
               |SI aOpAnt = "%0";
                  aOpAnt = Fich % 0202; nDgAnt = aOpAnt;
                  aOpAnt = "%";
                  Fich = Fich % 0499;
               |FINSI;
            |SINO;
               aOpAnt = ""; nDgAnt = 0;
            |FINSI;
         |FINSI;

         |HAZ TomaDatos;
         |SI nSwCondic = 1;
            |SI nCampoAlfa = 1; Comodin = "'" + Comodin + "'"; |FINSI;
         |FINSI;

         |SI aOpAnt = "%";
            |SI nDgAnt < 0;
               nDgAnt = nDgAnt - 100;
            |SINO;
               nDgAnt = nDgAnt + 100;
            |FINSI;
            Comodin = Comodin % nDgAnt;
         |FINSI;

         |SI Comodin = "S"; Comodin = "1"; |FINSI;
         |SI Comodin = "N"; Comodin = "0"; |FINSI;
         Cadena = Cad1 + Comodin + Cad2;
         Cadena = Cadena - "][";
      |SIGUE;
   |SINO;
      aAlfa4 = Cadena;
      aAlfa4 = aAlfa4 - "{";         || Es una memoria MEMOPART3
      |PARA; |SI FSalida ! 0; |HACIENDO;
         aAlfa4 = Cadena;
         aAlfa4 = aAlfa4 - "}";
         |SI FSalida ! 0;
            nCalc1 = ((FSalida / 100) ! 0) + 199;
            aAlfa4 = aAlfa4 % nCalc1;
         |FINSI;
         aAlfa5 = "{" + aAlfa4; |QBF aAlfa5;
         aAlfa5 = aAlfa5 + "}"; Cadena = Cadena - aAlfa5;
         || En aAlfa4 tenemos el nombre. La buscamos .....
         |ABRE #dscam172;
         #dscam172#0 = #dscam030#0;
         #dscam172#1 = aAlfa4;
         |LEE 000#dscam172.=;
         |SI FSalida = 0;
            || .... y si la encontramos disponemos todo para ....
            || .... 1) Comprobar cual es la condicion que se cumple
            aExpresion = "";
            |BUCLE LinsCondMemo;
         |SINO;
            Comodin = "";
         |FINSI;
         |CIERRA #dscam172;

         Cadena = Cadena - "{";
      |SIGUE;
   |FINSI;
|FPRC;

/*
   Recoge de la variable 'cadena' la expresion a comprobar y devuelve el
   valor de la condicion en la variable 'Resultado'
*/
|PROCESO ResolCondicion;
   nSwCondic = 1; |HAZ ResolCampos; nSwCondic = 0;

|ET ComienzoCond;
   PosicAPar = 0;  PosicCPar = 0;
   Cad1 = "";

   Comodin = Cadena;
   Comodin1 = Comodin - "(";
   |SI FSalida ! 0;
      aLong = Comodin % 0; nLong = aLong;
      |PARA Cont = 1; |SI Cont [ nLong; |HACIENDO Cont = Cont + 1;
         Calc = (Cont * 100) + 1;
         Comodin1 = Comodin % Calc;
         |SI Comodin1 = "(";
            PosicAPar = Cont;
            Cad1 = "";
         |SINO;
            |SI Comodin1 = ")";
               PosicCPar = Cont;
               |SI PosicAPar ! 0;
                  |HAZ ResolSimple;
                  Calc1 = 100 + (PosicAPar - 1);
                  Calc2 = ((PosicCPar + 1) * 100) + 99;
                  Comodin1 = Comodin % Calc1;
                  Comodin1 = Comodin1 + Cad1;
                  Comodin1 = Comodin1 + (Comodin % Calc2);
                  Cadena   = Comodin1;
                  |VETE ComienzoCond;
               |SINO;
                  |SI enSinConfi = 0;
                     |MENAV "    Error de sintaxis en la expresion";
                  |SINO;
                     aLogTitulo = " Error de sintaxis en la expresion"; |HAZ ApuntaLog;
                     |XGRABA enHandLog, aLogTitulo;
                  |FINSI;
                  |ERROR;
                  |ACABA;
               |FINSI;
            |SINO;
               Cad1 = Cad1 + Comodin1;
            |FINSI;
         |FINSI;
      |SIGUE;
   |FINSI;

   Cad1 = Cadena;
   |HAZ ResolCondSimple;
|FPRC;

|PROCESO ResolCondSimple;
  || ABDON Tiquet 004182/00348 (25/07/2011)
  || Este proceso va bien, pero solo puedo hacer condiciones con campos
  ||    numericos. Lo que voy a hacer es comprobar antes de nada si hay algun
  ||    condicionante que sea alfanumerico buscando comillas simples y dobles
  || Si no es as, lanzo el mismo proceso que hasta ahora, pero si no, lanzo
  ||    uno que voy a hacer ahora
   aAlfaX1 = Cad1; |QBF aAlfaX1;
   aAlfaX1 = aAlfaX1 - &34;
   |SI FSalida = 0;
      aAlfaX1 = aAlfaX1 - "'";
      |SI FSalida ! 0;
         aAlfaX3 = "'"
      |FINSI;
   |SINO;
      aAlfaX3 = &34;
   |FINSI;

   |SI FSalida ! 0;
      Cad1 = Cad1 - aAlfaX3;
      |PARA; |SI FSalida ! 0; |HACIENDO;
         Cad1 = Cad1 - aAlfaX3;
      |SIGUE;

      aCond1 = ""; aCond2 = ""; aOperCond = ""; aAlfaX1 = "";
      aLong = Cad1 % 0; nLong = aLong;
      |PARA Cont1 = 1; |SI Cont1 [ nLong; |HACIENDO Cont1 = Cont1 + 1;
         Calc1 = (Cont1 * 100) + 1;
         Comodin1 = Cad1 % Calc1;
         |SI Comodin1 = ">"; |O Comodin1 = "<";
          |O Comodin1 = "]"; |O Comodin1 = "[";
          |O Comodin1 = "="; |O Comodin1 = "!";
             |SI aAlfaX1 = ""; aAlfaX1 = " "; |FINSI;
             aCond1 = aAlfaX1; aAlfaX1 = "";
             aOperCond = Comodin1;
         |SINO;
            aAlfaX1 = aAlfaX1 + Comodin1;
         |FINSI;
      |SIGUE;
      |SI aAlfaX1 ! "";
         aCond2 = aAlfaX1; aAlfaX1 = "";
      |FINSI;
      |SI aOperCond = "=";
         |SI aCond1 = aCond2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
      |FINSI;
      |SI aOperCond = "!";
         |SI aCond1 ! aCond2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
      |FINSI;
      |SI aOperCond = "<";
         |SI aCond1 < aCond2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
      |FINSI;
      |SI aOperCond = ">";
         |SI aCond1 > aCond2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
      |FINSI;
      |SI aOperCond = "[";
         |SI aCond1 [ aCond2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
      |FINSI;
      |SI aOperCond = "]";
         |SI aCond1 ] aCond2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
      |FINSI;
   |SINO;
      Oper1 = 0; Oper2 = 0;
      Operacion = "";
      Cad2 = "";
      Neg = 0;

      aLong = Cad1 % 0; nLong = aLong;

      |PARA Cont1 = 1; |SI Cont1 [ nLong; |HACIENDO Cont1 = Cont1 + 1;
         Calc1 = (Cont1 * 100) + 1;
         Comodin1 = Cad1 % Calc1;
         |SI Comodin1 = ">"; |O Comodin1 = "<";
          |O Comodin1 = "]"; |O Comodin1 = "[";
          |O Comodin1 = "="; |O Comodin1 = "!";
            |SI Oper1 = 0;
               Oper1 = Cad2;
               |SI Neg = 1; Oper1 = 0 - Oper1; Neg = 0; |FINSI;
               |SI Cad2 = "";
                  Neg = 1;
               |SINO;
                  Operacion = Comodin1;
                  Cad2 = "";
                  Neg = 0;
               |FINSI;
            |SINO;
               |SI Cad2 = "";
                  |SI Comodin1 = "-"; Neg = 1; |FINSI;
               |SINO;
                  Oper2 = Cad2;
                  |SI Neg = 1; Oper2 = 0 - Oper2; Neg = 0; |FINSI;
                  |SI Operacion = ">";
                     |SI Oper1 > Oper2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
                  |FINSI;
                  |SI Operacion = "<";
                     |SI Oper1 < Oper2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
                  |FINSI;
                  |SI Operacion = "]";
                     |SI Oper1 ] Oper2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
                  |FINSI;
                  |SI Operacion = "[";
                     |SI Oper1 [ Oper2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
                  |FINSI;
                  |SI Operacion = "=";
                     |SI Oper1 = Oper2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
                  |FINSI;
                  |SI Operacion = "!";
                     |SI Oper1 ! Oper2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
                  |FINSI;
                  Operacion = Comodin1; Cad2 = "";
               |FINSI;
            |FINSI;
         |SINO;
            Cad2 = Cad2 + Comodin1;
         |FINSI;
      |SIGUE;

      |QBF Operacion;
      |SI Operacion ! "";
         |SI Cad2 = "";
            |SI Comodin1 = "-"; Neg = 1; |FINSI;
         |SINO;
            Oper2 = Cad2;
            |SI Neg = 1; Oper2 = 0 - Oper2; Neg = 0; |FINSI;
            |SI Operacion = ">";
               |SI Oper1 > Oper2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
            |FINSI;
            |SI Operacion = "<";
               |SI Oper1 < Oper2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
            |FINSI;
            |SI Operacion = "]";
               |SI Oper1 ] Oper2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
            |FINSI;
            |SI Operacion = "[";
               |SI Oper1 [ Oper2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
            |FINSI;
            |SI Operacion = "=";
               |SI Oper1 = Oper2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
            |FINSI;
            |SI Operacion = "!";
               |SI Oper1 ! Oper2; Resultado = 1; |SINO; Resultado = 0; |FINSI;
            |FINSI;
         |FINSI;
      |SINO;
         Oper1 = Cad1;
      |FINSI;
      Cad1 = Oper1;
   |FINSI;
|FPRC;

|| **************************************************************************
|| **************************************************************************
|| ****                     RESOLUCION DE RELACIONES                     ****
|| **************************************************************************
|| **************************************************************************

/*

  La llamada al proceso principal 'ResuelveRels' toma el valor de la variable
  'FichRelac' que contiene el nombre del fichero del cual se resolveran las
  relaciones. En base al registro corriente del fichero 'FichRelac', se
  rellena el fichero 'dscaw012' con los registros correspondientes de los
  ficheros relacionados con el indicado.

*/

|PROCESO CargaRegAct;
   Mensaje = "Cargando registro : " + nCont + "  /" + FichMaster;
   |ATRI I; |PINTA 2207, Mensaje; |ATRI N; nCont = nCont + 1;
   ComodNum = #dscaw012#1;
   |SI #dscaw012#2 = "A"; #FMaster@#ComodNum# = #dscaw012#3; |FINSI;
   |SI #dscaw012#2 = "N"; #FMaster@#ComodNum# = #dscaw012#4; |FINSI;
   |SI #dscaw012#2 = "F"; #FMaster@#ComodNum# = #dscaw012#5; |FINSI;
|FPRC;

|DEFBUCLE CargaRegAct;
#dscaw012#1;
;
#dscaw011#1,000;
#dscaw011#1,255;
;
NULL,CargaRegAct;
|FIN;

|PROCESO SacaRels;
   |PATH_DAT #4 PathAplic;
   |ABRE #dscam029; |SELECT #2#dscam029;

   |DBASE Direc;
   Comodin = #dscaw011#1; |QBF Comodin; FichMaster = Comodin;
   Comodin = Direc + "def/" + Comodin + ".mas";
   |CARGA_DEF Comodin, FMaster@;
   |SI FSalida = 0;
      |PATH_DAT #9 PathAplic;
      |ABRE #FMaster@;

      nCont = 0; |BUCLE CargaRegAct;

      Comodin = "|NR";
      Calc1 = #FMaster@#Comodin#;

      |ATRI I; |PINTA 2207, "Resolviendo relaciones           "; |ATRI N;

      |PARA Cont = 0; |SI Cont < Calc1; |HACIENDO Cont = Cont + 1;
         Comodin = ("000" + Cont) % -103;
         Comodin = "|R" + Comodin;
         Comodin = #FMaster@#Comodin#;
         Comodin1 = Comodin % 108; NombreRel = Comodin1;
         #dscam029#1 = NombreRel;
         #dscam029#0 = 1;
         |LEE 000#dscam029.];
         |SI FSalida = 0; |Y #dscam029#1 = NombreRel;
            Comodin = Comodin - Comodin1;
            Comodin = Comodin - "|";
            Comodin = Comodin - "-";
            |SI FSalida = 0;
               |DBASE Direc;
               FichEsclavo = Comodin1;
               Comodin1 = Direc + "def/" + Comodin1 + ".mas";
               |CARGA_DEF Comodin1, FEsclav@;
               |SI FSalida = 0;
                  |ATRI I; Mensaje = "Enlazando, espere por favor ..... " + MarcaPant; |HAZ ActMarca;
                  |PINTA 2307, Mensaje; |ATRI R;

                  |PATH_DAT #10 PathAplic;
                  |ABRE #FEsclav@;

                  || Cargo la clave del fichero nuevo y lo busco

                  Comodin1 = Comodin % 103;
                  Comodin = Comodin - Comodin1;
                  Calc2 = Comodin1;

                  Clave1 = Comodin;
                  Comodin = "|K000";
                  Comodin = #FEsclav@#Comodin#;
                  Clave2 = Comodin % 0499;

                  aClave = "";
                  |PARA Cont1 = 0; |SI Cont1 < Calc2; |HACIENDO Cont1 = Cont1 + 1;
                     Comodin = Clave1 % 0103;
                     Clave1 = Clave1 - Comodin;
                     CmpClave1 = Comodin;
                     CmpClave1 = CmpClave1 - 1;
                     Comodin = Clave2 % 0103;
                     Clave2 = Clave2 - Comodin;
                     CmpClave2 = Comodin;

                     |SI aClave = "";
                         aClave = #FMaster@#CmpClave1#;
                     |SINO;
                         aClave = aClave + ", " + #FMaster@#CmpClave1#;
                     |FINSI;

                     #FEsclav@#CmpClave2# = #FMaster@#CmpClave1#;
                  |SIGUE;

                  |LEE 000#FEsclav@.=;

                  |SI FSalida ! 0;
                     |HAZ MiDebug;
                  |SINO;
                     || Si se encuentra , grabo los datos en el temporal de datos relaccionados
                     Comodin1 = "|NC";
                     NumCmps = #FEsclav@#Comodin1# - 1;
                     |SELECT #3#dscam029;
                     |PARA Cont2 = 0; |SI Cont2 [ NumCmps; |HACIENDO Cont2 = Cont2 + 1;
                        #dscam029#1 = NombreRel;
                        #dscam029#2 = Cont2;
                        #dscam029#4 = #dscam030#2;
                        |LEE 000#dscam029.=;
                        |SI FSalida = 0;
                           #dscaw012#0 = NombreRel;
                           #dscaw012#1 = Cont2;
                           |LEE 101#dscaw012.=;
                           |SI FSalida ! 0;
                              |DDEFECTO #dscaw012;
                              #dscaw012#0 = NombreRel;
                              #dscaw012#1 = Cont2;
                              Comodin1 = ("000" + Cont2) % -103;
                              Comodin1 = "|C" + Comodin1 + "TIPO";
                              Comodin1 = #FEsclav@#Comodin1#;
                              #dscaw012#2 = Comodin1;
                              |SI Comodin1 = "A"; #dscaw012#3 = #FEsclav@#Cont2#; |FINSI;
                              |SI Comodin1 = "N"; #dscaw012#4 = #FEsclav@#Cont2#; |FINSI;
                              |SI Comodin1 = "F"; #dscaw012#5 = #FEsclav@#Cont2#; |FINSI;
                              Comodin1 = ("000" + Cont2) % -103;
                              Comodin1 = "|C" + Comodin1 + "LONGITUD";
                              #dscaw012#6 = #FEsclav@#Comodin1#;
                              |GRABA 020#dscaw012.n; |LIBERA #dscaw012;
                           |FINSI;
                        |FINSI;
                     |SIGUE;
                     |SELECT #2#dscam029;

                     |SALVA_FICHA #dscaw011;
                     |SELECT #2#dscaw011;
                     #dscaw011#1 = NombreRel;
                     |LEE 000#dscaw011.=;
                     |SI FSalida ! 0;
                        |DDEFECTO #dscaw011;
                        #dscaw011#0 = LinRel; LinRel = LinRel + 1;
                        #dscaw011#1 = NombreRel;
                        |GRABA 000#dscaw011.n;
                     |FINSI;
                     |SELECT #1#dscaw011;
                     |REPON_FICHA #dscaw011;
                  |FINSI;

                  |CIERRA #FEsclav@; |DESCARGA_DEF #FEsclav@;
               |FINSI;
            |FINSI;
         |FINSI;
      |SIGUE;
      |CIERRA #FMaster@; |DESCARGA_DEF #FMaster@;
   |FINSI;
   #dscaw011#2 = "*"; |GRABA 020#dscaw011.a;
|FPRC;

|PROCESO ResuelveRels;

|| Esta rutina rellena un temporal con el registro del fichero principal que
||   se esta tratando, ademas de rellenarlo con los registros de todos los
||   ficheros que estan relacionados con el. Para esto se apoya sobre un
||   temporal que indica los ficheros relacionados con el fichero principal
||   y los relacionados entre si, comenzando luego escribiendo el registro
||   actual del fichero principal y buscando los registros relacionados a
||   partir de ahi


||  Primero, rellenamos el temporal para saber todos los ficheros que
||    tendremos que leer ....

   |PATH_DAT #7 PathAplic; |PATH_DAT #8 PathAplic;
   |DELINDEX #dscaw011; |DELINDEX #dscaw012;
   |ABRE #dscaw011;
   LinRel = 1;

   aLogTitulo = "Registro numero " + NumRegistro + ". Resolviendo relacion " + LinRel + "."; |HAZ ApuntaLog;
   |DDEFECTO #dscaw011;
   #dscaw011#0 = LinRel; LinRel = LinRel + 1;
   #dscaw011#1 = FichRelac;
   |GRABA 020#dscaw011.n;

   |ABRET #dscaw012;
   |DBASE Direc;
   FichMaster = FichRelac;
   Comodin = Direc + "def/" + FichRelac + ".mas";
   |CARGA_DEF Comodin, FMaster@;
   |SI FSalida = 0;
      |PATH_DAT #9 PathAplic;
      |ABRE #FMaster@;

      Comodin1 = "|NC";
      NumCmps = #FMaster@#Comodin1#; NumCmps = NumCmps - 1;
      |PARA Cont = 0; |SI Cont [ NumCmps; |HACIENDO Cont = Cont + 1;
         #FMaster@#Cont# = #Referen@#Cont#;
      |SIGUE;
      |LEE 000#FMaster@.=;

      |PARA Cont = 0; |SI Cont [ NumCmps; |HACIENDO Cont = Cont + 1;
         |DDEFECTO #dscaw012;
         #dscaw012#0 = FichRelac;
         #dscaw012#1 = Cont;
         Comodin1 = ("000" + Cont) % -103;
         Comodin1 = "|C" + Comodin1 + "TIPO";
         Comodin1 = #FMaster@#Comodin1#;
         #dscaw012#2 = Comodin1;
         |SI Comodin1 = "A"; #dscaw012#3 = #FMaster@#Cont#; |FINSI;
         |SI Comodin1 = "N"; #dscaw012#4 = #FMaster@#Cont#; |FINSI;
         |SI Comodin1 = "F"; #dscaw012#5 = #FMaster@#Cont#; |FINSI;
         Comodin1 = ("000" + Cont) % -103;
         Comodin1 = "|C" + Comodin1 + "LONGITUD";
         #dscaw012#6 = #FMaster@#Comodin1#;
         |GRABA 020#dscaw012.n;
      |SIGUE;

      Comodin = "|NR";
      Calc1 = #FMaster@#Comodin#;

      |PARA Cont = 0; |SI Cont < Calc1; |HACIENDO Cont = Cont + 1;
         Comodin = ("000" + Cont) % -103;
         Comodin = "|R" + Comodin;
         Comodin = #FMaster@#Comodin#;
         Comodin = Comodin % 108;
         aLogTitulo = "Registro numero " + NumRegistro + ". Resolviendo relacion " + LinRel + "."; |HAZ ApuntaLog;

         |DDEFECTO #dscaw011;
         #dscaw011#0 = LinRel; LinRel = LinRel + 1;
         #dscaw011#1 = Comodin;
         |GRABA 020#dscaw011.n;
      |SIGUE;

      |CIERRA #FMaster@; |DESCARGA_DEF #FMaster@;
   |FINSI;


||  ... y una vez lo tenemos , vamos obteniendo los registros relacionados
||   con el registro actual del fichero principal o con cualquiera
||   relacionado con este
   |LEE 000#dscaw011.p;
   |PARA; |SI FSalida = 0; |HACIENDO;
      |HAZ SacaRels;
      |LEE 000#dscaw011.p;
      |PARA; |SI FSalida = 0; |HACIENDO;
         |SI #dscaw011#2 = " "; |SAL; |FINSI;
         |LEE 000#dscaw011.s;
      |SIGUE;
   |SIGUE;

   |CIERRAT #dscaw012;
   |CIERRA #dscaw011;
|FPRC;

|PROCESO EscogeFic;

|| Parametriza la linea del fichero de acotacion en base a la naturaleza del campo
||   que se esta tratando

         TipoDato = #dscaw013#11; LongDato = #dscaw013#12;
         |SI TipoDato = "A";
            |CAMPO_ANCHO #dscaw013#3,1,LongDato;
            |CAMPO_MAXIMO #dscaw013#3,1,"#";
            |CAMPO_ANCHO #dscaw013#4,1,LongDato;
            |CAMPO_MAXIMO #dscaw013#4,1,"#";
            |C_M #dscaw013#3,1,"S"; |C_V #dscaw013#3,1,"S"; |PINTA #dscaw013#3;
            |C_M #dscaw013#4,1,"S"; |C_V #dscaw013#4,1,"S"; |PINTA #dscaw013#4;
            |C_M #dscaw013#5,1,"N"; |C_V #dscaw013#5,1,"N";
            |C_M #dscaw013#6,1,"N"; |C_V #dscaw013#6,1,"N";
            |C_M #dscaw013#7,1,"N"; |C_V #dscaw013#7,1,"N";
            |C_M #dscaw013#8,1,"N"; |C_V #dscaw013#8,1,"N";
         |FINSI;
         |SI TipoDato = "N";
            |C_M #dscaw013#3,1,"N"; |C_V #dscaw013#3,1,"N";
            |C_M #dscaw013#4,1,"N"; |C_V #dscaw013#4,1,"N";
            |C_M #dscaw013#5,1,"S"; |C_V #dscaw013#5,1,"S"; |PINTA #dscaw013#5;
            |C_M #dscaw013#6,1,"S"; |C_V #dscaw013#6,1,"S"; |PINTA #dscaw013#6;
            |C_M #dscaw013#7,1,"N"; |C_V #dscaw013#7,1,"N";
            |C_M #dscaw013#8,1,"N"; |C_V #dscaw013#8,1,"N";
         |FINSI;
         |SI TipoDato = "F";
            |C_M #dscaw013#3,1,"N"; |C_V #dscaw013#3,1,"N";
            |C_M #dscaw013#4,1,"N"; |C_V #dscaw013#4,1,"N";
            |C_M #dscaw013#5,1,"N"; |C_V #dscaw013#5,1,"N";
            |C_M #dscaw013#6,1,"N"; |C_V #dscaw013#6,1,"N";
            |C_M #dscaw013#7,1,"S"; |C_V #dscaw013#7,1,"S"; |PINTA #dscaw013#7;
            |C_M #dscaw013#8,1,"S"; |C_V #dscaw013#8,1,"S"; |PINTA #dscaw013#8;
         |FINSI;
|FPRC;

|PROCESO TomaVal;

|| Parametriza la linea del fichero de acotacion en base a la naturaleza del campo
||   que se esta tratando

   |SI TipoDato = "A"; #dscaw013#9 = #dscaw013#3; #dscaw013#10 = #dscaw013#4; |FINSI;
   |SI TipoDato = "N"; #dscaw013#9 = #dscaw013#5; #dscaw013#10 = #dscaw013#6; |FINSI;
   |SI TipoDato = "F"; #dscaw013#9 = "   " + #dscaw013#7; #dscaw013#10 = "   "+ #dscaw013#8; |FINSI;

   |C_M #dscaw013#3,1,"N"; |C_V #dscaw013#3,1,"N";
   |C_M #dscaw013#4,1,"N"; |C_V #dscaw013#4,1,"N";
   |C_M #dscaw013#5,1,"N"; |C_V #dscaw013#5,1,"N";
   |C_M #dscaw013#6,1,"N"; |C_V #dscaw013#6,1,"N";
   |C_M #dscaw013#7,1,"N"; |C_V #dscaw013#7,1,"N";
   |C_M #dscaw013#8,1,"N"; |C_V #dscaw013#8,1,"N";
                           |C_V #dscaw013#9,1,"S";
                           |C_V #dscaw013#10,1,"S";
|FPRC;

|PROCESO MiraEmp;
   Tecla = FSalida;
   |SI FSalida = 2; |ACABA; |FINSI;

   SwError = 0;

   Comodin  = PathEnlace; |QBF Comodin;
   Comodin1 = Comodin;
   Fichero = "Empresas"; Tipo = "C"; Cmp = ""; |HAZ ObtenFich;
   Comodin = Comodin + "def/" + Fichero + ".mas";
   Comodin1 = Comodin1 + "fich/";
   |CARGA_DEF Comodin , canempr@;
   |SI FSalida = 0;
      |PATH_DAT #20 Comodin1;
      |ABRE #canempr@;
      |SI Tecla = 10;
         |CONSULTA_CLAVE #1#canempr@;
         |SI FSalida ] 0;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Codigo Empresa"; |HAZ ObtenDato;
            #dscam033#4 = #canempr@#CmpNum#; |PINTA #dscam033#4;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Periodo"; |HAZ ObtenDato;
            #dscam033#5 = #canempr@#CmpNum#; |PINTA #dscam033#5;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 1"; |HAZ ObtenDato;
            Dig1 = #canempr@#CmpNum#;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 2"; |HAZ ObtenDato;
            Dig2 = #canempr@#CmpNum#;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 3"; |HAZ ObtenDato;
            Dig3 = #canempr@#CmpNum#;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 4"; |HAZ ObtenDato;
            Dig4 = #canempr@#CmpNum#;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 5"; |HAZ ObtenDato;
            Dig5 = #canempr@#CmpNum#;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 6"; |HAZ ObtenDato;
            Dig6 = #canempr@#CmpNum#;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Nombre Comercial"; |HAZ ObtenDato;
            |PINTA 0738, #canempr@#CmpNum#;
         |SINO;
            |ERROR;
         |FINSI;
      |SINO;
         Fichero = "Empresas"; Tipo = "C"; Cmp = "Codigo Empresa"; |HAZ ObtenDato;
         #canempr@#CmpNum# = #dscam033#4;
         Fichero = "Empresas"; Tipo = "C"; Cmp = "Periodo"; |HAZ ObtenDato;
         #canempr@#CmpNum# = #dscam033#5;
         |LEE 000#canempr@.=;
         |SI FSalida = 0;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 1"; |HAZ ObtenDato;
            Dig1 = #canempr@#CmpNum#;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 2"; |HAZ ObtenDato;
            Dig2 = #canempr@#CmpNum#;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 3"; |HAZ ObtenDato;
            Dig3 = #canempr@#CmpNum#;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 4"; |HAZ ObtenDato;
            Dig4 = #canempr@#CmpNum#;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 5"; |HAZ ObtenDato;
            Dig5 = #canempr@#CmpNum#;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Digitos Nivel 6"; |HAZ ObtenDato;
            Dig6 = #canempr@#CmpNum#;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Nombre Comercial"; |HAZ ObtenDato;
            |SI PARAMETRO = ""; |PINTA 0738, #canempr@#CmpNum#; |FINSI;
         |SINO;
            |SI enSinConfi = 0;
               aAlfa = "    La empresa " + (("00000" + #dscam033#4) % -105) + " periodo " + #dscam033#5;
               aAlfa = aAlfa + " no existe ";
               |MENAV aAlfa;
            |SINO;
               aLogTitulo = " La empresa " + (("00000" + #dscam033#4) % -105) + " periodo " + #dscam033#5;
               aLogTitulo = aLogTitulo + " no existe "; |HAZ ApuntaLog;
               |XGRABA enHandLog, aLogTitulo;
            |FINSI;
            SwError = 1; |ERROR;
         |FINSI;
      |FINSI;

      Comodin = "|NC"; Comodin = #canempr@#Comodin#;

      |SI Comodin = 27;
         Comodin  = PathEnlace; |QBF Comodin;
         Comodin1 = Comodin;
         ||Comodin  = Comodin + "def/camoneda.mas";
         Fichero = "Moneda Empresas"; Tipo = "C"; Cmp = ""; |HAZ ObtenFich;
         Comodin = Comodin + "def/" + Fichero + ".mas";
         Comodin1 = Comodin1 + "fich/000000/";
         |CARGA_DEF Comodin , camoned@;
         |SI FSalida = 0;
            |PATH_DAT #25 Comodin1;
            |ABRE #camoned@;
            Fichero = "Moneda Empresas"; Tipo = "C"; Cmp = "Codigo Empresa"; |HAZ ObtenDato;
            #camoned@#CmpNum# = #dscam033#4;
            Fichero = "Moneda Empresas"; Tipo = "C"; Cmp = "Periodo"; |HAZ ObtenDato;
            #camoned@#CmpNum# = #dscam033#5;
            |LEE 000#camoned@.=;
            |SI FSalida = 0;
               Fichero = "Moneda Empresas"; Tipo = "C"; Cmp = "Moneda"; |HAZ ObtenDato;
               |SI #camoned@#CmpNum# = "P";
                  EURO = 1 / 166.386; EURODB = 0; EURODV = 2;
               |SINO;
                  EURO = 166.386; EURODB = 2; EURODV = 0;
               |FINSI;
            |SINO;
               EURO = 1 / 166.386; EURODB = 0; EURODV = 2;
            |FINSI;
            |CIERRA #camoned@; |DESCARGA_DEF #camoned@;
         |FINSI;
      |SINO;
         |SI #canempr@#28 = "P";
            EURO = 1 / 166.386; EURODB = 0; EURODV = 2;
         |SINO;
            EURO = 166.386; EURODB = 2; EURODV = 0;
         |FINSI;
      |FINSI;

      |CIERRA #canempr@; |DESCARGA_DEF #canempr@;
   |SINO;
      SwError = 1;
      |SI CodEnlace ! "    ";
         |SI enSinConfi = 0;
            |MENAV "    Problemas para encontrar el def de empresa de contabilidad. Revise el path y la empresa de contabilidad.";
         |SINO;
            aLogTitulo = " Problemas para encontrar el def de empresa de contabilidad. Revise el path y la empresa de contabilidad.";
            |HAZ ApuntaLog; |XGRABA enHandLog, aLogTitulo;
         |FINSI;

         |ERROR;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO TomaDefec033;
   |SI PARAMETRO = "";
      CodEnlace = #dscam033#0;
   |SINO;
      CodEnlace = PARAMETRO;
      CodEnlace = CodEnlace - ",B";
      CodEnlace = CodEnlace - ",V";
      |SI FSalida ! 0;
         Calc = FSalida + 8;
         Comodin = CodEnlace % Calc;
         CodEnlace = CodEnlace - Comodin;
      |FINSI;
      CodEnlace = CodEnlace - "|";
      |SI FSalida ! 0;
         Calc = (((FSalida / 100) ! 0) * 100) + 99;
         Comodin = CodEnlace % Calc;
         CodEnlace = CodEnlace - Comodin;
      |FINSI;
   |FINSI;

   |ABRE #dscam030;
   #dscam030#0 = CodEnlace;
   |LEE 000#dscam030.=;
   |SI FSalida = 0;
      Empresa = #dscam030#4;
      Periodo = #dscam030#5;
      PathEnlace = #dscam030#6;
      #dscam033#4 = Empresa; |PINTA #dscam033#4;
      #dscam033#5 = Periodo; |PINTA #dscam033#5;

      aCmpClv = &196 * 60;
      |DDEF aAlfa; |QBF aAlfa; aAlfa = aAlfa + #dscam030#9 + ".mas";
      |CARGA_DEF aAlfa, refere1@;
      |SI FSalida = 0;
         aCmpClv = " Campo clave enlace : ["; aAlfa1 = "|TITULO";
         aAlfa1 = #refere1@#aAlfa1#; aCmpClv = aCmpClv + aAlfa1 + "][";
         aAlfa1 = "|C" + (("000" + #dscam030#10) % -103) + "NOMBRE";
         aAlfa1 = #refere1@#aAlfa1#; aCmpClv = aCmpClv + aAlfa1 + "]";
      |FINSI;
      |PINTA 0915, aCmpClv;
   |FINSI;
   |CIERRA #dscam030;
|FPRC;

|PROCESO ActMarca;
   |SI MarcaPant = "|"; MarcaPant = "/"; |ACABA; |FINSI;
   |SI MarcaPant = "/"; MarcaPant = "-"; |ACABA; |FINSI;
   |SI MarcaPant = "-"; MarcaPant = "\"; |ACABA; |FINSI;
   |SI MarcaPant = "\"; MarcaPant = "|"; |ACABA; |FINSI;
|FPRC;

|PROCESO Acotaciones;
   aAlfa1  = #dscaw013#13; |QBF aAlfa1;
   |SI nVersion = 1;
      |SI aAlfa1 ! Fich1; |ACABA; |FINSI;
      aAlfa3 = "";
   |SINO;
      |SI aAlfa1 ! Fich1; |Y aAlfa1 ! FichCab; |ACABA; |FINSI;
      aAlfa3 = #dscaw013#13 + ".";
      aCampos = aCampos + #dscaw013#13 + "." + #dscaw013#14 + ",";
   |FINSI;

   Comodin1 = " " * #dscaw013#12; Calc = -(100 + #dscaw013#12);
   |SI #dscaw013#11 = "A";
      Calc = 100 + #dscaw013#12;
      aAlfa1 = #dscaw013#3; |QBF aAlfa1; aAlfa1 = (aAlfa1 + Comodin1) % Calc;
      aAlfa2 = #dscaw013#4; |QBF aAlfa2; aAlfa2 = (aAlfa2 + Comodin1) % Calc;
      |SI aAlfa1 = aAlfa2;
         Comodin = Comodin + aAlfa3 + #dscaw013#14 + " == '" + aAlfa1 + "' ";
      |SINO;
         Comodin = Comodin + aAlfa3 + #dscaw013#14 + " BETWEEN '" + aAlfa1 + "', '" + aAlfa2 + "' ";
      |FINSI;
   |FINSI;
   |SI #dscaw013#11 = "N";
      aAlfa1 = #dscaw013#5; |QBT aAlfa1; aAlfa1 = (Comodin1 + aAlfa1) % Calc;
      aAlfa2 = #dscaw013#6; |QBT aAlfa2; aAlfa2 = (Comodin1 + aAlfa2) % Calc;
      |SI aAlfa1 = aAlfa2;
         Comodin = Comodin + aAlfa3 + #dscaw013#14 + " == " + aAlfa1 + " ";
      |SINO;
         Comodin = Comodin + aAlfa3 + #dscaw013#14 + " BETWEEN " + aAlfa1 + ", " + aAlfa2 + " ";
      |FINSI;
   |FINSI;
   |SI #dscaw013#11 = "F";
      aAlfa1 = #dscaw013#7; |QBT aAlfa1; aAlfa1 = (Comodin1 + aAlfa1) % Calc;
      aAlfa2 = #dscaw013#8; |QBT aAlfa2; aAlfa2 = (Comodin1 + aAlfa2) % Calc;
      |SI aAlfa1 = aAlfa2;
         Comodin = Comodin + aAlfa3 + #dscaw013#14 + " == " + aAlfa1 + " ";
      |SINO;
         Comodin = Comodin + aAlfa3 + #dscaw013#14 + " BETWEEN " + aAlfa1 + "," + aAlfa2 + " ";
      |FINSI;
   |FINSI;

   aFichero = #dscaw013#13;
   |SALVA_FICHA #dscaw013;
   |SI #dscaw013#18 ! "A"; aAlfa1 = "OR "; |SINO; aAlfa1 = "AND "; |FINSI;
   |LEE 000#dscaw013.s;
   |SI FSalida = 0; |Y #dscaw013#13 = aFichero; Comodin = Comodin + aAlfa1; |FINSI;
   |REPON_FICHA #dscaw013;
   nSwAcot = 1;
|FPRC;

|DEFBUCLE Acotaciones;
#dscaw013#1;
;
CodEnlace,001;
CodEnlace,999;
;
NULL,Acotaciones;
|FIN;

|PROCESO GeneraSQL;
   nSwAcot = 0;
   |SI nVersion = 1;
      Comodin = Usuario; |QBF Comodin; Comodin = "sq" + Comodin;
      Cadena = "SELECT * FROM " + Fichero1 + " INTO " + Comodin + ".def WHERE ";
      Comodin = Usuario; |QBF Comodin; Comodin = "ad" + Comodin;
      |NOME_DAT #7 Comodin;
      Comodin = Usuario; |QBF Comodin; Comodin = "ae" + Comodin;
      |NOME_DAT #8 Comodin;
      Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
      |NOME_DAT #5 Comodin; PathDatos = Comodin; Comodin = "";
      |ABRE #dscaw013;
      |BUCLE Acotaciones; Cadena = Cadena + Comodin;
      |CIERRA #dscaw013;
      Fichero1 = Cadena;
   |SINO;
      Comodin = Usuario; |QBF Comodin; Comodin = "tm" + Comodin;
      Comodin = Usuario; |QBF Comodin; Comodin = "ad" + Comodin;
      |NOME_DAT #7 Comodin;
      Comodin = Usuario; |QBF Comodin; Comodin = "ae" + Comodin;
      |NOME_DAT #8 Comodin;
      Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
      |NOME_DAT #5 Comodin; PathDatos = Comodin; Comodin = "";
      |ABRE #dscaw013;
      Cadena = "SELECT " + aCampos + " FROM " + Fichero1 + "," + FichCab + " INTO " + Comodin + ".def WHERE ";
      |BUCLE Acotaciones; Cadena = Cadena + Comodin;
      |CIERRA #dscaw013;
      Fichero1 = Cadena;
   |FINSI;
   |SI nSwAcot = 0;
      |SI enSinConfi = 0;
         aAlfa = "    NSe esta ejecutando un enlace sin acotar. Esto puede tardar considerablemente. " + &191 + " Continuar ? ";
         |CONFI aAlfa;
      |SINO;
         aLogTitulo = "Se esta ejecutando un enlace sin acotar. Esto puede tardar considerablemente. Proceso cancelado.";
         |HAZ ApuntaLog;
         |XGRABA enHandLog, aLogTitulo;
         FSalida = nMenosUno;
      |FINSI;
      |SI FSalida = 0;
         nSwAcot = 0;
      |SINO;
         nSwAcot = -1;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO EmiVto;
   |SI #dscam030#2 = "RM"; |O #dscam030#2 = "PA"; |O #dscam030#2 = "CF"; |O #dscam030#2 = "PD";
      |PINTA 0649, " Tipo enlace : ";
      #dscam033#6 = "E";
      |C_M #dscam033#6,1,"S"; |C_V #dscam033#6,1,"S";
   |SINO;
      |PINTA 0649, "               ";
      #dscam033#6 = " ";
      |C_M #dscam033#6,1,"N"; |C_V #dscam033#6,1,"N";
   |FINSI;
|FPRC;

|PROCESO MiraEmiVto;
   |SI #dscam030#2 ! "RM"; |Y #dscam030#2 ! "PA"; |Y #dscam030#2 ! "CF"; |Y #dscam030#2 ! "PD";
      |ACABA;
   |FINSI;

   |SI #dscam033#6 = "V";
      Calc = FSalida + 8;
      FechaVto = CodEnlace % Calc; CodEnlace = CodEnlace - FechaVto;
      |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
         InAsiento    = nAsiento1<-;     InAsiento    = InAsiento    + Cont;
         InAstoVto    = nAstoVto1<-;     InAstoVto    = InAstoVto    + Cont;
         ICmpEmpresa  = CmpEmpresa1<-;   ICmpEmpresa  = ICmpEmpresa  + Cont;
         ICmpPeriodo  = CmpPeriodo1<-;   ICmpPeriodo  = ICmpPeriodo  + Cont;
         ICmpEnlace   = CmpEnlace1<-;    ICmpEnlace   = ICmpEnlace   + Cont;
         IEmprVto     = EmprVto1<-;      IEmprVto     = IEmprVto     + Cont;
         IPeriVto     = PeriVto1<-;      IPeriVto     = IPeriVto     + Cont;
         IEnlVto      = EnlVto1<-;       IEnlVto      = IEnlVto      + Cont;
         IFechas      = Fechas1<-;       IFechas      = IFechas      + Cont;
         IFecVto      = FecVto1<-;       IFecVto      = IFecVto      + Cont;
         nAsiento     = nAstoVto; CmpEmpresa  = EmprVto;
         CmpPeriodo   = PeriVto;  CmpEnlace   = EnlVto;
         Fechas = FecVto;
      |SIGUE;
      TipoEnl = "V";
   |FINSI;
   |SI #dscam033#6 = "E";
      |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
         InAsiento    = nAsiento1<-;     InAsiento    = InAsiento + Cont;
         InAstoEmi    = nAstoEmi1<-;     InAstoEmi    = InAstoEmi + Cont;
         ICmpEmpresa  = CmpEmpresa1<-;   ICmpEmpresa  = ICmpEmpresa  + Cont;
         ICmpPeriodo  = CmpPeriodo1<-;   ICmpPeriodo  = ICmpPeriodo  + Cont;
         ICmpEnlace   = CmpEnlace1<-;    ICmpEnlace   = ICmpEnlace   + Cont;
         IEmprEmi     = EmprEmi1<-;      IEmprEmi     = IEmprEmi     + Cont;
         IPeriEmi     = PeriEmi1<-;      IPeriEmi     = IPeriEmi     + Cont;
         IEnlEmi      = EnlEmi1<-;       IEnlEmi      = IEnlEmi      + Cont;
         IFechas      = Fechas1<-;       IFechas      = IFechas      + Cont;
         IFecEmi      = FecEmi1<-;       IFecEmi      = IFecEmi      + Cont;
         nAsiento     = nAstoEmi; CmpEmpresa  = EmprEmi;
         CmpPeriodo   = PeriEmi;  CmpEnlace   = EnlEmi;
         Fechas = FecEmi;
      |SIGUE;
      TipoEnl = "I";
   |FINSI;
   |SI #dscam033#6 = "A";
      |PARA Cont = 0; |SI Cont < nNumFicheros; |HACIENDO Cont = Cont + 1;
         InAsiento    = nAsiento1<-;     InAsiento    = InAsiento + Cont;
         InAstoAbo    = nAstoAbo1<-;     InAstoAbo    = InAstoAbo + Cont;
         ICmpEmpresa  = CmpEmpresa1<-;   ICmpEmpresa  = ICmpEmpresa  + Cont;
         ICmpPeriodo  = CmpPeriodo1<-;   ICmpPeriodo  = ICmpPeriodo  + Cont;
         ICmpEnlace   = CmpEnlace1<-;    ICmpEnlace   = ICmpEnlace   + Cont;
         IEmprAbo     = EmprAbo1<-;      IEmprAbo     = IEmprAbo     + Cont;
         IPeriAbo     = PeriAbo1<-;      IPeriAbo     = IPeriAbo     + Cont;
         IEnlAbo      = EnlAbo1<-;       IEnlAbo      = IEnlAbo      + Cont;
         IFechas      = Fechas1<-;       IFechas      = IFechas      + Cont;
         IFecAbo      = FecAbo1<-;       IFecAbo      = IFecAbo      + Cont;
         nAsiento     = nAstoAbo; CmpEmpresa  = EmprAbo;
         CmpPeriodo   = PeriAbo;  CmpEnlace   = EnlAbo;
         Fechas = FecAbo;
      |SIGUE;
      TipoEnl = "E";
   |FINSI;
|FPRC;

|RUTINA infer068;
   #dscam068#0 = #dscam033#0;
   #dscam068#1 = #dscaw013#0;
   #dscam068#2 = 1;
|FRUT;

|RUTINA super068;
   #dscam068#0 = #dscam033#0;
   #dscam068#1 = #dscaw013#0;
   #dscam068#2 = 999;
|FRUT;

|PROCESO Exclusion; |TIPO 3;
   |PUSHV 0959 1979;
   |SI #dscaw013#11 = "A";
      LongDato = #dscaw013#12;
      |CAMPO_ANCHO #dscam068#3,1,LongDato;
      |CAMPO_MAXIMO #dscam068#3,1,"#";
      |C_V #dscam068#3,1,"S"; |C_M #dscam068#3,1,"S";
   |SINO;
      |C_V #dscam068#3,1,"N"; |C_M #dscam068#3,1,"N";
   |FINSI;
   |SI #dscaw013#11 = "N";
      |C_V #dscam068#4,1,"S"; |C_M #dscam068#4,1,"S";
   |SINO;
      |C_V #dscam068#4,1,"N"; |C_M #dscam068#4,1,"N";
   |FINSI;
   |SI #dscaw013#11 = "F";
      |C_V #dscam068#5,1,"S"; |C_M #dscam068#5,1,"S";
   |SINO;
      |C_V #dscam068#5,1,"N"; |C_M #dscam068#5,1,"N";
   |FINSI;
   |C_V #dscam068#6,1,"N";
   |ENTLINEAL #1#dscam068,-3,1,18,1,infer068,super068;
   |C_V #dscam068#3,1,"N"; |C_M #dscam068#3,1,"N";
   |C_V #dscam068#4,1,"N"; |C_M #dscam068#4,1,"N";
   |C_V #dscam068#5,1,"N"; |C_M #dscam068#5,1,"N";
   |C_V #dscam068#6,1,"S";
   |POPV;
|FPRC;

|PROCESO ComprAstos;
   aAlfa = "|DEF"; aAlfa = #48#aAlfa#;
   aAlfa = aAlfa - "dscam005"; || Llamo al asiento desde cartera ...
   |SI FSalida ! 0;
      aAlfa = #48#16; |QBF aAlfa;
   |SINO;
      |ABRE #dscam030;
      #dscam030#0 = PARAMETRO;
      |LEE 000#dscam030.=;
      |SI FSalida ! 0; |DDEFECTO #dscam030; |FINSI;
      aAlfa = #dscam030#6; |QBF aAlfa;
      |CIERRA #dscam030;
   |FINSI;
   aAlfa = aAlfa + "fich/" + (("00000" + #caenlac@#37) % -105) + #caenlac@#38 + "/";
   |PATH_DAT #27 aAlfa; |ABRE #camasil@;
   #camasil@#0 = #caenlac@#0;
   #camasil@#1 = #caenlac@#1;
   #camasil@#2 = #caenlac@#2;
   #camasil@#3 = #caenlac@#3;
   |LEE 000#camasil@.=;
   |SI FSalida = 0;
      |SI #camasil@#9 ! #caenlac@#9;
         nSwError = 2; |ERROR10;
      |FINSI;
   |SINO;
      |SI #caenlac@#9 = 0; |ACABA; |FINSI;
      nSwError = 1; |ERROR10;
   |FINSI;
   |CIERRA #camasil@;
|FPRC;

|DEFBUCLE ComprAstos;
#caenlac@#1006;
;
00,"00.00.0000",000001,0001,00000,0;
99,"31.12.2999",999999,9999,99999,9;
;
NULL,ComprAstos;
|FIN;

|PROCESO MiraAnulacion;
   || Hasta ahora al volver de contabilidad se miraba si alguno de los asientos que se habian enviado a contabilidad venan rechazados por la misma (ejercicio
   ||     incorrecto, empresa cerrada, etc) para eliminar el historico de enlaces. Pero no se ha tenido en cuenta el que se estuviera reenlazando el registro,
   ||     con lo que no hay que borrarlo, ya que perderamos el vnculo anterior. Ahora cuando un asiento se rechace, primero voy a ver si el asiento existe en
   ||     contabilidad y si es as no elimino el vnculo. Si no existe en contabilidad, entonces si que lo elimino porque es seal de que se ha filtrado y no se
   ||     ha llegado a enlazar
   Comodin  = PathEnlace; |QBF Comodin;
   Comodin  = Comodin + "fich/" + (("00000" + #dscam067#8) % -105) + #dscam067#9 + "/";
   |PATH_DAT #camasic@#Comodin#;

   |ABRE #camasic@;
   |DDEFECTO #camasic@;
   #camasic@#0 = #dscam067#4;
   #camasic@#1 = #dscam067#5;
   #camasic@#2 = #dscam067#6;
   |LEE 000#camasic@.];
   |SI FSalida = 0; |Y #camasic@#0 = #dscam067#4; |Y #camasic@#1 = #dscam067#5; |Y #camasic@#2 = #dscam067#6;
      nSwAnula = 0;
   |FINSI;
   |CIERRA #camasic@;
|FPRC;

|PROCESO AstosAnulados;
   aAlfa = #caenlac@#18; |QBF aAlfa;
   |SI PRMNT_Init = 1; |Y aAlfa ! "S"; |Y #caenlac@#9 ! 0;
      #dscaw137#0  = #caenlac@#37;
      #dscaw137#1  = #caenlac@#38;
      #dscaw137#2  = #caenlac@#0;
      #dscaw137#3  = #caenlac@#1;
      #dscaw137#4  = #caenlac@#2;
      #dscaw137#5  = #caenlac@#3;
      |LEE 000#dscaw137.=;
      |SI FSalida ! 0;
         #dscaw137#0 = #caenlac@#37;
         #dscaw137#1 = #caenlac@#38;
         #dscaw137#2 = #caenlac@#0;
         #dscaw137#3 = #caenlac@#1;
         #dscaw137#4 = #caenlac@#2;
         #dscaw137#5 = 1;
         |LEE 000#dscaw137.];
         |SI FSalida = 0; |Y #dscaw137#0 = #caenlac@#37; |Y #dscaw137#1 = #caenlac@#38;
          |Y #dscaw137#2 = #caenlac@#0; |Y #dscaw137#3 = #caenlac@#1; |Y #dscaw137#4 = #caenlac@#2;
            nMarca = #dscaw137#12;
         |SINO;
            |SI nMarca = "1";
               nMarca = "0";
            |SINO;
               nMarca = "1";
            |FINSI;
         |FINSI;

         |DDEFECTO #dscaw137;
         #dscaw137#0  = #caenlac@#37;
         #dscaw137#1  = #caenlac@#38;
         #dscaw137#2  = #caenlac@#0;
         #dscaw137#3  = #caenlac@#1;
         #dscaw137#4  = #caenlac@#2;
         #dscaw137#5  = #caenlac@#3;
         #dscaw137#6  = #caenlac@#4;
         #dscaw137#7  = #caenlac@#6;
         #dscaw137#8  = #caenlac@#7;
         #dscaw137#9  = #caenlac@#8;
         #dscaw137#10 = #caenlac@#15;
         #dscaw137#11 = #caenlac@#9;
         #dscaw137#12 = nMarca;

         Comodin  = PathEnlace; |QBF Comodin;
         Comodin1 = Comodin;
         Fichero = "Empresas"; Tipo = "C"; Cmp = ""; |HAZ ObtenFich;
         Comodin = Comodin + "def/" + Fichero + ".mas";
         Comodin1 = Comodin1 + "fich/";
         |CARGA_DEF Comodin , canempr@;
         |SI FSalida = 0;
            |PATH_DAT #20 Comodin1; |ABRE #canempr@;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Codigo Empresa"; |HAZ ObtenDato;
            #canempr@#CmpNum# = #caenlac@#37;
            Fichero = "Empresas"; Tipo = "C"; Cmp = "Periodo";        |HAZ ObtenDato;
            #canempr@#CmpNum# = #caenlac@#38;
            |LEE 000#canempr@.=;
            |SI FSalida = 0;
               Fichero = "Empresas"; Tipo = "C"; Cmp = "Nombre Comercial"; |HAZ ObtenDato;
               #dscaw137#13 = #canempr@#CmpNum#;
            |FINSI;
         |FINSI;
         |CIERRA #canempr@; |DESCARGA_DEF #canempr@;

         |GRABA 020#dscaw137.n;
      |FINSI;
   |FINSI;

   aAlfa = #caenlac@#18; |QBF aAlfa;
   |SI aAlfa ! "S"; |ACABA; |FINSI;

   #dscam067#8 = #caenlac@#37;
   #dscam067#9 = #caenlac@#38;
   #dscam067#4 = #caenlac@#0;
   #dscam067#5 = #caenlac@#1;
   #dscam067#6 = #caenlac@#2;
   #dscam067#7 = #caenlac@#3;
   |LEE 000#dscam067.=;
   |SI FSalida = 0;
      nSwAnula = 1; |HAZ MiraAnulacion;
      |SI nSwAnula = 1; |BORRA 020#dscam067.a; |FINSI;
   |SINO;
      |SI #dscam030#8 = "S";
         #dscam067#8 = #caenlac@#37;
         #dscam067#9 = #caenlac@#38;
         #dscam067#4 = #caenlac@#0;
         #dscam067#5 = #caenlac@#1;
         #dscam067#6 = #caenlac@#2;
         #dscam067#7 = 1;
         |LEE 000#dscam067.];
         |SI FSalida = 0; |Y #dscam067#8 = #caenlac@#37; |Y #dscam067#9 = #caenlac@#38;
          |Y #dscam067#4 = #caenlac@#0; |Y #dscam067#5 = #caenlac@#1; |Y #dscam067#6 = #caenlac@#2;

            nSwAnula = 1; |HAZ MiraAnulacion;
            |SI nSwAnula = 1; |BORRA 020#dscam067.a; |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE AstosAnulados;
#caenlac@#1006;
;
00,"00.00.0000",000001,0001,00000,0;
99,"31.12.2999",999999,9999,99999,9;
;
NULL,AstosAnulados;
|FIN;

|PROCESO ComprEnlace;
   || Debemos eliminar del historico de enlaces los asientos que hayan sido
   ||    repudiados desde contabilidad , pero la cartera los haya anotado.
   aLogTitulo = "Borrando registros del historico de enlace de asientos anulados por contabilidad."; |HAZ ApuntaLog;

   |SI PRMNT_Init = 1;
      aAlfa = "rc" + Usuario; |NOME_DAT #dscaw137#aAlfa#;
      |ABRE #dscaw137;
   |FINSI;

   |SELECT #2#dscam067;
   |BUCLE AstosAnulados;
   |SELECT #1#dscam067;

   |SI PRMNT_Init = 1; |CIERRA #dscaw137; |FINSI;

   |SI #dscam051#67 = "N"; |ACABA; |FINSI;

   aAlfa = "|DEF"; aAlfa = #48#aAlfa#;

   Comodin  = PathEnlace; |QBF Comodin;
   Comodin  = Comodin + "def/";
   Comodin1 = Comodin + "camaasil.mas";
   |CARGA_DEF Comodin1, camasil@;
   |SI FSalida = 0;
      aLogTitulo = "Comprobando que los asientos enlazados realmente estan en contabilidad."; |HAZ ApuntaLog;
      nSwError = 0;
      |BUCLE ComprAstos;
      |SI nSwError = 0; |Y #dscam051#67 = "M"; |Y Modo ! "B";
         |SI enSinConfi = 0;
            |MENAV "    Asiento verificado y validado.";
         |SINO;
            aLogTitulo = " Asiento verificado y validado.";
            |HAZ ApuntaLog; |XGRABA enHandLog, aLogTitulo;
         |FINSI;
      |FINSI;
      |SI nSwError = 1;
         |SI enSinConfi = 0;
            |MENAV "    Problemas en grabacion asiento, revise contabilidad";
         |SINO;
            aLogTitulo = " Problemas en grabacion asiento, revise contabilidad";
            |HAZ ApuntaLog; |XGRABA enHandLog, aLogTitulo;
         |FINSI;
      |FINSI;
      |SI nSwError = 2;
         |SI enSinConfi = 0;
            |MENAV "    Problemas con los totales del asiento, revise contabilidad";
         |SINO;
            aLogTitulo = "Problemas con los totales del asiento, revise contabilidad";
            |HAZ ApuntaLog; |XGRABA enHandLog, aLogTitulo;
         |FINSI;
      |FINSI;
      |DESCARGA_DEF #camasic@;
   |FINSI;
|FPRC;

|PROCESO ApuntaLog;
   eaVarLog = aLogTitulo; |HAZ AnyadeLog; |ACABA;

   |SI nHandle < 0; |ACABA; |FINSI;
   |HORA aAlfaLog1; |QBF aAlfaLog1;
   fFechaLog = ~; aAlfaLog2 = fFechaLog;
   aAlfaLog1 = aAlfaLog2 + " " + aAlfaLog1 + " " + aLogTitulo;
   |XGRABA nHandle, aAlfaLog1;
|FPRC;

||Para pruebas de debug
||Saca un mensaje por cada registro que no exista
|PROCESO MiDebug;
/*
     ||SI FichEsclavo = "dscam003";
         |SI nContaErr = 0; |DELINDEX #231; |FINSI;
         nContaErr = nContaErr + 1;

          aAlfa = FichEsclavo + ":" + aClave;
          |ABRE #231;
          #231#0 = aAlfa;
          |LEE 000#231=;
          |SI FSalida ! 0;
               |GRABA 020#231n;
               aAlfa = "0000No existe " + aAlfa;
               |MENAV aAlfa;
          |FINSI;
          |CIERRA #231;
     ||FINSI;
*/
|FPRC;
