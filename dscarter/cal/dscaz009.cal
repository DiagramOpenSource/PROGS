|FICHEROS;
   dscaz009 #0;
   dscaz010 #1,MANTE;
   dscam003 #2;
   dscam004 #3;
   dscam066 #4;

   dscaw007 #5,MANTE;
   dscaw178 #6,MANTE;

   dscam013 #100;
   dscam012 #101;
   dscam023 #102;
   dscam164 #103;
   dscam219 #104;

   dscaz027 #7,MANTE;
   dscaz028 #8,MANTE;

   dscam051 #9;
   dscaw013 #10;
   dscaw043 #11;
   dscam030 #12;
   dscam043 #43;
   dscam045 #45;
   dscaw211 #211,MANTE;
   dscaw140 #140;

   &agif024@ #100;
   dscam176@ #101

   visalm00@ #1000;
   dspvm002@ #1001;
   dspvm003@;
   pycm0013@;
   maesm011@ #1002;
   pycm0011@ #1003;
   pycm0007@ #1004;
   pycm0024@ #1005;
   prevm004@ #1006;
   dsvim017@ #1007;
   visalm01@ #1008;
   pycm0005@ #1009;
   dscaw139@ #1010;

   Referen@ #2000;
|FIN;

|VARIABLES;
   nOpeRecPag = 0;
   nSwEsPagare = 0;
   &eaSerieGastos = ""; &enFactGastos = 0; &efEmisionGastos = @;
   &eaFichClas = "";  &eaTipoClas = ""; &enSwClas = 0; &enTipoRec = 0;
   &eaSesion   = "";

   &efFechaDoc = @;
   &efFechaUlt = @;
   &eaFechaUlt = @;
   &eaResult   = "";
   &enSwPag    = 0;

   nEsArimesa = 0;
   nContError = 0;

{-1}menu  = "";
    menu1 = "2400";
    menu2 = "1";
    menu3 = "";
    menu4 = "MVFCTP";
    menu5 = "Manual";
    menu6 = "Aut.Vto.";
    menu7 = "Aut.Fecha";
    menu8 = "Aut.Cliente";
    menu9 = "Acotar recibos";
    menu10 = "Acotar Pag/Tal";

    &LetraImp1 = ""; &LetraImp2 = ""; &SwFin = 0;

    &efFechaDiv = @;
    &Divisa = "";   &CambioBaseVn = 0; &CambioBaseCm = 0;
    &CmpDivisa = 0; &CambioDivVn  = 0; &CambioDivCm  = 0;
    &PosLibro = 0; &PosSerie = 0; &PosFactu = 0; &PosRecib = 0;
    &enDocum  = 0; &enFactura = 0;
    &enDocumto = 0; &efFechaMov = @; &eaHoraMov = "";
    &eaSituRec = ""; &eaObs = "";
    &FecEmision  = ""; &importeant = 0;

    &eaUsuario = ""; &enImpAnt = 0;  &enImpAct = 0;  &eaDescr = ""; &eaFicher = "";
    &eaTipoReg = ""; &eaNumero = ""; &eaTipoOp = ""; &eaClave = "";

    &Fichero   = "";  &Cmp = "";   &Tipo = ""; &CmpNum = 0;
    &eaTipoRecibo = ""; &enNumDocum = 0; &eaMensRet = ""; &enSwError = 0; &eaTOperacion = "";
    &aInforme  = "";

    &eaCodigo    = "";
    &eaTipoCod   = "";
    &aCuenta     = "";
    &eaNif       = "";
    &eaNombre    = "";
    &eaDireccion = "";
    &eaPoblacion = "";
    &eaProvincia = "";
    &eaCP        = "";
    &eaCP1       = "";
    &eaCP2       = "";
    &eaTelefono  = "";

    SwClave  = 0;
    Fecha    = @;
    fFechaOpMenor = @;
    fFechaOpMayor = @;
    nNumSec  = 0;
    nSwError = 0;
    nLinea   = 0;
    nCalc    = 0;
    aValAnt  = "";
    aEntidad = "";
    aNumero  = "";

    Cont = 0;
    nSwAcota = 0;

    nSwCambia = 0;

    aAlfa1   = "";
    aAlfa2   = "";
    aSerie   = "";
    nFactura = 0;
    nRecibo  = 0;
    fFecCob  = @;
    fFecha   = @;
    nEmpGest = 0;
    &aEnt1    = "";
    &aNum1    = "";

    Opcion = 0;
    Linea  = 0;
    LinCob = 0;
    UltFecha = "";
    UltNumero = 0;
    nCambiaEnl = 0;

    DCliente  = "";
    HCliente  = "";

    Entidad   = "";
    Documento = "";

    nTotalImporte = 0;
    nTotalGtos   = 0;
    nContGtos    = 0;
    nImpGtos     = 0;
    nCuentaLineas = 0;
    nContLineas   = 0;

    nSwAviso1 = 0; nSwRemesa = 0;
    nSwAviso2 = 0; nSwRemesa2 = 0;

    NumDoc = 0;
    NumLin = 0;
    Libro  = 0;
    Serie  = "";
    Factura = 0;
    Recibo = 0;
    Mensaje = "";

    aAlfa = ""; nNume = 0; aLong = ""; nLong = 0;

    ModoEntrada = 0;
    SwError = 0;
    Manual = 0;
    FEstado = 0;
    HaySelec = 0;
    SwHay = 0;

    &MaxDigit = 0;
    &UltNivel = 0;

    &HayGestion = 0; &HayConta = 0;
    &nDeci_Div = 0; &nDeci_Base = 0;
    &enEmpCartera = 0; &enEmpGestion = 0;
    &eaSerie = ""; &eaCliGest = ""; &nImporte = 0; &eaTipoOper = "";

    DifCambio = 0; Empresa = 0;

    Comodin = ""; Comodin1 = "";
    Dia     = ""; Mes      = ""; anyo = "";
    NumLinea = 1;

    DFechaVto = @; HFechaVto = @;

    Calc = 0; Caracter = ""; nCont = 0;

    nCont1    = 0;
    nContrato = 0;
    nSw       = 0;
    nCalc1    = 0;

    nCuentaCobs = 0;
    nCodigo   = 0;
    nDocum    = 0;
    nImporteD = 0;
    nImporteB = 0;

    aOper1    = "";
    aOper2    = "";
    aCtaCobro = "";
    nTecla    = 0;

     nDocu = 0;
|FIN;

|PROCESO Temporal;
     |SI nDocu ! #dscaz009#21;
          #dscam003#40 = #dscaz009#21;
          |LEE 020#dscam003.=;
          |SI #dscam003#70 = aNumero; |Y #dscam003#72 = aEntidad;
               |SI nOpeRecPag = 0;
                    #dscaz009#13 = #dscaz010#0;
                    #dscaz009#14 = #dscaz010#1;
                    #dscaz009#8  = 0;
                    #dscaz009#7  = 0;
                    #dscaz009#18 = 0;
                    #dscaz009#16 = #dscaz010#6;
                    #dscaz009#17 = #dscaz010#7;
                    #dscaz009#13 = #dscaz010#0;
                    #dscaz009#19 = 0;
                    #dscaz009#10 = "*";
                    #dscaz009#33 = CambioDivVn;
                    #dscaz009#25 = 0;
                    #dscaz009#26 = 0;
                    #dscaz009#29 = 0;
                    #dscaz009#30 = 0;
                    #dscaz009#35 = #dscaz010#10;
                    #dscaz009#37 = eaResult;
                    |GRABA 020#dscaz009.a;
               |FINSI;
               |SI nOpeRecPag = 1;
                   eaTOperacion = "C";
                   eaTipoRecibo = "V";
                   enNumDocum = #dscaz009#21;
                   |HAZ ProcesaTempo;
               |FINSI;
               |SI nOpeRecPag = 2;
                    #dscaz009#13 = "";
                    #dscaz009#14 = "01.01.0000";
                    #dscaz009#8  = 0;
                    #dscaz009#7  = 0;
                    #dscaz009#18 = 0;
                    #dscaz009#16 = "";
                    #dscaz009#17 = "";
                    #dscaz009#13 = "";
                    #dscaz009#19 = 0;
                    #dscaz009#10 = "";
                    #dscaz009#33 = CambioDivVn;
                    #dscaz009#25 = 0;
                    #dscaz009#26 = 0;
                    #dscaz009#29 = 0;
                    #dscaz009#30 = 0;
                    #dscaz009#35 = "";
                    #dscaz009#37 = "";
                    |GRABA 020#dscaz009.a;
               |FINSI;
               |SI nOpeRecPag = 3;
                    |HAZ Tipo9;
                    aAlfa = "dscaz198.tab;" + #dscaz009#21;
                    |SUB_EJECUTA aAlfa;
                    |HAZ Tipo8;
                    |DDEFECTO #dscaw140;
                    #dscaw140#0 = #dscaz009#21;
                    #dscaw140#1 = efFechaMov;
                    #dscaw140#2 = eaHoraMov;
                    |GRABA 000#dscaw140.n;
                    |SI FSalida ! 0;
                         |BORRA 000#dscaw140.c;
                         |GRABA 000#dscaw140.n;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE Temporal;
     #dscaz009#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Temporal;
|FIN;

|PROCESO RecibosPagare;
     |SI nSwEsPagare = 1;
          |SALVA_FICHA #dscaz009;

          |PONCONTROL 23,"si";
          nDocu = #dscaz009#21;
          #dscam003#40 = nDocu;
          |LEE 020#dscam003.=;
          aNumero = #dscam003#70; |QBF aNumero;
          |SI aNumero ! "";
               aNumero = #dscam003#70;
               aEntidad = #dscam003#72;
               |BUCLE Temporal;
          |FINSI;
          aEntidad = ""; aNumero = "";

          |REPON_FICHA #dscaz009;
     |FINSI;
|FPRC;

|PROCESO ImpaArtenvas;
     |SI #dscam003#89 = "S";
          |MENAV "    El recibo est  declarado";
     |FINSI;
     aAlfa = "    N" + &191 + " Cambiar situación ?";
     |CONFI aAlfa;
     |SI FSalida = 0;
          |HAZ Tipo9;
          aAlfa = "dscaz198.tab;" + #dscaz009#21;
          |SUB_EJECUTA aAlfa;
          |HAZ Tipo8;
          |SI enDocumto ] 0;
               |DDEFECTO #dscaw140;
               #dscaw140#0 = #dscaz009#21;
               #dscaw140#1 = efFechaMov;
               #dscaw140#2 = eaHoraMov;
               |GRABA 000#dscaw140.n;
               |SI FSalida ! 0;
                    |BORRA 000#dscaw140.c;
                    |GRABA 000#dscaw140.n;
               |FINSI;
               nOpeRecPag = 3; |HAZ RecibosPagare;
               eaSituRec = "";
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO HazImpagado;
   enSwError = 0;
   eaTOperacion = "A";
   eaTipoRecibo = "V";
   enNumDocum = #dscaz009#21;

   |HAZ ProcesaTempo;
   |SI enSwError = 1; |ERROR; |ACABA; |FINSI;

   nOpeRecPag = 1; |HAZ RecibosPagare;
   |SI enSwError = 1; |ERROR; |ACABA; |FINSI;

   nSwError = 0;
   nLinea = #dscaz009#0;
   enNumDocum = #dscaz009#21;

   |SALVA_FICHA #dscaz009;
   |SELECT #2#dscaz009;
   #dscaz009#21 = enNumDocum;
   #dscaz009#0 = 1;
   |LEE 000#dscaz009.];
   |PARA; |SI FSalida = 0; |Y #dscaz009#21 = enNumDocum; |HACIENDO;
      |SI #dscaz009#0 ! nLinea; nSwError = 1; |SAL; |FINSI;
      |LEE 000#dscaz009.s;
   |SIGUE;
   |SELECT #1#dscaz009;
   |REPON_FICHA #dscaz009;

   |SI nSwError = 1;
      |MENAV "    Recibo ya incluido"; |ERROR; |ACABA;
   |FINSI;

   |HAZ EsArtenvas;
   |SI FSalida = 0;
      |HAZ ImpaArtenvas;
   |FINSI;

   |C_M #dscaz010#4,1,"S";

   |SI HayConta = 1; |Y #dscam051#1 = "S";
      |C_M #dscaz010#10,1,"S";
   |SINO;
      |C_M #dscaz010#10,1,"N";
   |FINSI;

   #dscam003#40 = #dscaz009#21;
   |LEE 000#dscam003.=;
   || ABDON   010028/00678
   ||
   || #dscaz010#0 = #dscam051#20;
   || Antes con la linea de arriba se tomaba siempre la cuenta contable por
   ||     defecto de impagados. Aunque se hubiera introducido y entraras a
   ||     modificar, volvia a cogerla. Ahora solo la coge en caso de que la
   ||     cuenta contable de la linea est vacia.

   aAlfa = #dscaz009#13; |QBF aAlfa;
   |SI aAlfa = "";
      #dscaz010#0 = #dscam051#20;
   |SINO;
      #dscaz010#0 = #dscaz009#13;
   |FINSI;
   #dscaz010#1 = #dscaz009#14;
   #dscaz010#2 = #dscaz009#9;
   |SI #dscam003#17 ! 0;
      |SI #dscam003#14 = "L";
         |ABRE #dscam013;
         #dscam013#0 = #dscam003#17;
         #dscam013#1 = #dscam003#37;
         |LEE 000#dscam013.=;
         |SI FSalida = 0; |Y #dscam013#16 = #dscam003#40;
            #dscaz010#3 = #dscam003#23;
            #dscaz010#4 = #dscam013#22;
         |FINSI;
         |CIERRA #dscam013;
      |SINO;
         |ABRE #dscam012;
         #dscam012#0 = #dscam003#17;
         |LEE 000#dscam012.=;
         |SI FSalida ! 0; |DDEFECTO #dscam012; |FINSI;
         |CIERRA #dscam012;

   || ABDON   17/10/2012   N§ tiquet 000160/00648
   || Se inhabilita el campo 'Importe impagado' para los recibos pertenecientes
   ||    a remesas de recibos al descuento que no hayan sido abonadas, dado
   ||    que no puedo impagar algo que el banco no me ha abonado. Eso si,
   ||    puedo incluir en el recibo los gastos que el banco me haya aplicado
         |ABRE #dscam013;
         #dscam013#0 = #dscam003#17;
         #dscam013#1 = #dscam003#37;
         |LEE 000#dscam013.=;
         |SI FSalida = 0; |Y #dscam013#16 = #dscam003#40;
            #dscaz010#3 = #dscam003#23;
            |SI #dscam012#22 ! 2;
               |C_M #dscaz010#4, 1, "S";
               #dscaz010#4 = #dscam013#22;
            |SINO;
               |C_M #dscaz010#4, 1, "N";
               #dscaz010#4 = 0;
            |FINSI;
         |FINSI;
      |FINSI;
   |SINO;
      #dscaz010#3 = #dscaz009#7;
      #dscaz010#4 = #dscaz009#7;
   |FINSI;
   #dscaz010#5 = #dscaz009#18;
   #dscaz010#6 = #dscaz009#16;
   #dscaz010#7 = #dscaz009#17;
   #dscaz010#9 = #dscaz010#4 % #dscam051#31;
   |SI #dscam051#1 = "S";
      |C_M #dscaz010#10, 1, "S";
      #dscaz010#10 = #dscaz009#35;
   |SINO;
      #dscaz010#10 = "    ";
      |C_M #dscaz010#10, 1, "N";
   |FINSI;

   ||Si acota por Pag/Tal el impagado no se modifica
   |SI nSwAcota = 2;
      |C_M #dscaz010#4, 1, "N";
   |FINSI;
   eaResult   = ""; enDocum = #dscaz009#21;
   |PUSHV 0946 2178;
   |PINPA #0#1;
   |PINDA #0#1;
   |ENDATOS #2#dscaz010;
   FEstado = FSalida;
   |POPV;

   |SI FEstado = 0; |Y #dscaz010#8 = "S";
      efFechaDiv = #dscaz009#14;
      Divisa = #dscaz009#31; |HAZ TomaDecim;
      #dscaz009#13 = #dscaz010#0;
      #dscaz009#14 = #dscaz010#1;
      #dscaz009#8  = #dscaz010#4;
      #dscaz009#7  = #dscaz010#3;
      #dscaz009#18 = #dscaz010#5;
      #dscaz009#16 = #dscaz010#6;
      #dscaz009#17 = #dscaz010#7;
      #dscaz009#13 = #dscaz010#0;
      #dscaz009#19 = #dscaz010#9;
      #dscaz009#10 = "*";
      #dscaz009#33 = CambioDivVn;
      #dscaz009#25 = #dscaz010#3 / #dscaz009#34;
      #dscaz009#26 = #dscaz010#4 / #dscaz009#33;
      #dscaz009#29 = #dscaz010#5 / #dscaz009#34;
      #dscaz009#30 = #dscaz010#9 / #dscaz009#34;
      #dscaz009#35 = #dscaz010#10;
      #dscaz009#37 = eaResult;

      |GRABA 020#dscaz009.a;
      HaySelec = HaySelec + 1;

      nOpeRecPag = 0; |HAZ RecibosPagare;
   |SINO;
      eaTOperacion = "B";
      eaTipoRecibo = "V";
      enNumDocum = #dscaz009#21;
      |HAZ ProcesaTempo;
      |ERROR;
   |FINSI;

   |HAZ EsDiagram;
   |SI FSalida = 0;
      aAlfa = "dscam176.tab;" + #dscaz009#21; |SUB_EJECUTA aAlfa;
   |FINSI;
   |POPV;
|FPRC;

|PROCESO TomaDocum; |TIPO 7;
     |SI #dscaz009#10 = "*";
          #dscam003#40 = #dscaz009#21;
          |LEE 000#dscam003.=;
          |SI FSalida = 0;
               eaTOperacion = "B";
               eaTipoRecibo = "V";
               enNumDocum = #dscaz009#21;
               |HAZ ProcesaTempo;
               #dscaz009#10 = " "; |PINTA #dscaz009#10;
               |GRABA 020#dscaz009.a;
               HaySelec = HaySelec - 1;

               nOpeRecPag = 2; |HAZ RecibosPagare;
               |LEE 020#dscaz009.=;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MiraRecibo;
   |SI FSalida = 11;
      PosLibro = 2209; PosSerie = 2219; PosFactu = 2234; PosRecib = 2255;
      |HAZ ConsultaVentas;
      |SI enDocum ! -1; |Y enFactura ! -1;
         #dscaz009#21 = enDocum; |PINTA #dscaz009#21;
      |SINO;
         |MENAV "    Ficha inexistente"; |ERROR;
      |FINSI;
      SwClave = 1;
   |FINSI;

   |SI FSalida = 2; |ERROR; |ACABA; |FINSI;

   #dscam003#40 = #dscaz009#21;
   |LEE 000#dscam003.=;
   |SI FSalida = 0;
      |HAZ ComprTotVta;

      efFechaDoc = #dscam003#4;
      efFechaUlt = "01.01.0000";
      #dscam004#17 = #dscam003#40;
      #dscam004#3 = 99;
      |LEE 000#dscam004.];
      |SI FSalida = 0;
         |SI #dscam004#17 = #dscam003#40;
            efFechaUlt = #dscam004#6;
         |SINO;
            |LEE 000#dscam004.a;
            |SI FSalida = 0;
               |SI #dscam004#17 = #dscam003#40;
                  efFechaUlt = #dscam004#6;
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
   |FINSI;

   ModoEntrada = (FEntrada / 100) ! 0;
   |SI ModoEntrada ! 1; |Y #dscaz009#21 = Contenido; |ACABA; |FINSI;

   |SALVA_FICHA #dscaz009;
   |SELECT #2#dscaz009;

   NumDoc  = #dscaz009#21;
   NumLin  = #dscaz009#0;
   Libro   = #dscaz009#20;
   Serie   = #dscaz009#1;
   Factura = #dscaz009#2;
   Recibo  = #dscaz009#3;
   SwError = 0;

   |LEE 010#dscaz009.=;
   |SI FSalida = 0; |Y NumLin ! #dscaz009#0;
      |AVISO;
      |MENAV "    Recibo ya introducido";
      |ERROR;
      SwError = 1;
   |SINO;
      #dscam003#40 = NumDoc;
      |LEE 000#dscam003.=;
      |SI FSalida = 0;
         efFechaDoc = #dscam003#4;
         efFechaUlt = "01.01.0000";
         #dscam004#17 = #dscam003#40;
         #dscam004#3 = 99;
         |LEE 000#dscam004.];
         |SI FSalida = 0;
            |SI #dscam004#17 = #dscam003#40;
               efFechaUlt = #dscam004#6;
            |SINO;
               |LEE 000#dscam004.a;
               |SI FSalida = 0;
                  |SI #dscam004#17 = #dscam003#40;
                     efFechaUlt = #dscam004#6;
                  |FINSI;
               |FINSI;
            |FINSI;
         |SINO;
            |LEE 000#dscam004.u;
            |SI FSalida = 0;
               |SI #dscam004#17 = #dscam003#40;
                  efFechaUlt = #dscam004#6;
               |FINSI;
            |FINSI;
         |FINSI;

         |SI #dscam051#119 = "S";
            nContError = 0; || La uso para que en caso de que falle el proceso
                            ||    de descuento automatico no se quede en un
                            ||    bucle infinito. Lo intenta 3 veces y si no
                            ||    puede, da un error
            |ABRE #dscam013; |ABRE #dscam012;
            |PARA nContError = 0; |SI nContError [ 3; |HACIENDO nContError = nContError + 1;
               #dscam013#0 = #dscam003#17;
               #dscam013#1 = #dscam003#37;
               |LEE 000#dscam013.=;
               |SI FSalida ! 0; |DDEFECTO #dscam013; |FINSI;

               #dscam012#0 = #dscam003#17;
               |LEE 000#dscam012.=;
               |SI FSalida = 0;
                  |SI #dscam012#23 = "N";
                     aAlfa = "    El recibo " + #dscam003#40 + " es de la remesa " + #dscam013#0;
                     aAlfa = aAlfa + " que no est  emitida.";
                     |MENAV aAlfa; |ERROR; SwError = 1; |SAL;
                  |FINSI;
                  |SI #dscam012#8 = "N";
                     aAlfa = "    NEl recibo " + #dscam003#40 + " es de la remesa " + #dscam013#0;
                     aAlfa = aAlfa + " que no est  abonada. " + &191 + " Continuar ?";
                     |CONFI aAlfa;
                     |SI FSalida ! 0; |ERROR; SwError = 1; |SAL; |FINSI;
                  |FINSI;
               |FINSI;

               #dscam013#0 = #dscam003#17;
               #dscam013#1 = #dscam003#37;
               |LEE 000#dscam013.=;
               |SI FSalida = 0;
                  |SI #dscam013#15 = "N";
                     |HAZ EsArtenvas;
                     |SI FSalida ! 0;
                        |SI nSwAviso1 < 0; |O nSwRemesa ! #dscam013#0;
                           aAlfa = "    NEl recibo " + #dscam003#40 + " es de la remesa " + #dscam013#0;
                           aAlfa = aAlfa + " sin riesgo bancario descontado. " + &191 + " Descontar ?";
                           |CONFI aAlfa;

                           nSwAviso1 = FSalida; nSwRemesa = #dscam013#0;
                        |FINSI;
                        |SI nSwAviso1 = 0;
                           |HAZ DescuentoAutomatico;
                        |SINO;
                           |ERROR; SwError = 1; |SAL;
                        |FINSI;
                     |SINO;
                        |SAL;
                     |FINSI;
                  |SINO;
                     |SAL;
                  |FINSI;
               |FINSI;
            |SIGUE;
            |CIERRA #dscam012; |CIERRA #dscam013;

            || ABDON  17/10/2012   N§ tiquet 000160/00646
            ||SI nContError = 4;
            |ABRE #dscam012;
            #dscam012#0 = #dscam003#17;
            |LEE 000#dscam012.=;
            |SI FSalida ! 0; |DDEFECTO #dscam012; |FINSI;
            |CIERRA #dscam012;

            |SI #dscam012#22 = 2;
               |SI nContError = 4; |Y #dscam003#14 = "L";
                  |MENAV "    No se puede impagar el documento porque aun no se ha descontado el riesgo";
                  |ERROR;
                  SwError = 1;
               |FINSI;
            |SINO;
                  |SI #dscam012#22 ! 0; || Hay remesa ...
                  |SI nContError = 4;
                     |MENAV "    No se puede impagar el documento porque aun no se ha descontado el riesgo";
                     |ERROR;
                     SwError = 1;
                  |FINSI;
               |FINSI;
            |FINSI;

/* ABDON  17/10/2012   N§ tiquet 000160/00646
  Se hizo que para el modulo de Viuda, si se encontraba para impagar un documento
        que no tuviera el riesgo descontado, que se descontara automaticamente
        antes de seguir. Ahora puesto que se iba a incluir en el modulo de Artenvas
        tambien, se incluye en la estandar. Ojo, la remesa tiene que estar abonada
               |SINO;
                  |ABRE #dscam012;
                  #dscam012#0 = #dscam003#17;
                  |LEE 000#dscam012.=;
                  |SI FSalida ! 0; |DDEFECTO #dscam012; |FINSI;
                  |CIERRA #dscam012;

                  |ABRE #dscam013;
                  #dscam013#0 = #dscam003#17;
                  #dscam013#1 = #dscam003#37;
                  |LEE 000#dscam013.=;
                  |SI FSalida = 0;
                     |SI #dscam013#15 = "N";
                        |MENAV "    No se puede impagar el documento porque aun no se ha descontado el riesgo";
                        |ERROR;
                        SwError = 1;
                     |FINSI;
                  |FINSI;
                  |CIERRA #dscam013;
               |FINSI;
*/
         |FINSI;
         |SI nEsArimesa ! 0;
            |ABRE #dscam012;
            #dscam012#0 = #dscam003#17;
            |LEE 000#dscam012.=;
            |SI FSalida ! 0; |DDEFECTO #dscam012; |FINSI;
            |CIERRA #dscam012;

            |SI #dscam003#14 ! "L";
 || ABDON   17/10/2012   N§ Tiquet 000160/00648
 ||   En caso de que la remesa sea de recibos y al descuento, tengo que tener
 ||       en cuenta que el recibo puede venir impagado antes de que el banco
 ||       me haga efectiva la remesa. Si no es de este tipo, no dejo impagar
 ||       recibos sin el abono de la remesa.
               |HAZ EsOTP;
               |SI #dscam012#22 ! 2; |O FSalida = 0;
                  |SI #dscam003#17 = 0;
                     |AVISO;
                     aAlfa = "    Imposible impagar porque no se ha negociado en el banco. El estado es " + #dscam003#15; |QBF aAlfa;
                     |MENAV aAlfa;
                     |ERROR;
                     SwError = 1;
                  |SINO;
                     |SI #dscam003#14 = "I";
                        |AVISO;
                        |MENAV "    El recibo ya esta impagado.";
                        |ERROR; SwError = 1;
                     |SINO;
                        |AVISO;
                        aAlfa = "    Imposible impagar porque el recibo no se ha liquidado. El estado es " + #dscam003#15; |QBF aAlfa;
                        |MENAV aAlfa;
                        |ERROR;
                        SwError = 1;
                     |FINSI;
                  |FINSI;
               |SINO;
                  |SI #dscam003#17 = 0;
                     |AVISO;
                     aAlfa = "    Imposible impagar porque no se ha negociado en el banco. El estado es " + #dscam003#15; |QBF aAlfa;
                     |MENAV aAlfa;
                     |ERROR;
                     SwError = 1;
                  |SINO;
                     |SI #dscam003#14 = "I";
                        |AVISO;
                        |MENAV "    El recibo ya esta impagado.";
                        |ERROR; SwError = 1;
                     |FINSI;
                  |FINSI;
               |FINSI;
            |FINSI;
         |SINO;
            |SI #dscam003#14 ! "L";
               |AVISO;
               aAlfa = "    Imposible impagar porque el recibo no se ha liquidado. El estado es " + #dscam003#15; |QBF aAlfa;
               |MENAV aAlfa;
               |ERROR;
               SwError = 1;
            |FINSI;
         |FINSI;
         enSwClas   = 1; eaFichClas = "dscaz009"; eaTipoClas = #dscam003#12;
         |HAZ CompruebaClas;
         |SI eaFichClas = "ERROR";
            |MENAV "    Documento inoperable en el perfil actual ";
            |ERROR; SwError = 1;
         |FINSI;
         |SI eaFichClas = "INFOR";
            eaFichClas = "dscaz009";
            enNumDocum = #dscam003#40; enTipoRec = #dscam003#12; |HAZ CambiaTR;
         |FINSI;
      |SINO;
         |AVISO;
         |MENAV "    Recibo inexistente";
         |ERROR;
         SwError = 1;
      |FINSI;
   |FINSI;
   |SELECT #1#dscaz009;
   |REPON_FICHA #dscaz009;

   Divisa = #dscam003#57; |HAZ TomaDecim;

   |SI SwError = 0;
      Manual = 1;
      #dscam003#40 = NumDoc;
      |LEE 010#dscam003.=;
      |SI FSalida = 0;
         |HAZ GrabaRecibo;
      |FINSI;
      Manual = 0;
   |SINO;
      #dscaz009#0 = NumLin;
      |LEE 010#dscaz009.=;
   |FINSI;
|FPRC;

|PROCESO GrabaRecibo;
   |HAZ EsArimesa;
   |SI FSalida ! 0;
      |HAZ EsArtenvas;
      |SI FSalida ! 0;
         |SI #dscam003#17 = 0;
            |SI #dscam003#72 ! "    ";
               |SI #dscam003#14 = "I"; |ACABA; |FINSI;
               |SI #dscam003#14 = "p"; |ACABA; |FINSI;
            |SINO;
               |ACABA;
            |FINSI;
            |SI #dscam003#14 = "I"; |ACABA; |FINSI;
            |SI #dscam003#14 = "p"; |ACABA; |FINSI;
            |SI nSwAcota = 1; |ACABA; |FINSI;
         |SINO;
            |SI #dscam003#14 ! "L";
               |ABRE #dscam012;
               #dscam012#0 = #dscam003#17;
               |LEE 000#dscam012.=;
               |SI FSalida ! 0; |DDEFECTO #dscam012; |FINSI;
               |CIERRA #dscam012;

               |SI #dscam012#22 ! 2; |ACABA; |FINSI;
               |SI #dscam003#14 = "I"; |ACABA; |FINSI;
            |FINSI;
         |FINSI;
      |SINO;
         |SI #dscam003#17 = 0;
            |SI #dscam003#72 ! "    ";
               |SI #dscam003#14 = "I"; |ACABA; |FINSI;
               |SI #dscam003#14 = "p"; |ACABA; |FINSI;
               |SI nSwAcota = 1; |ACABA; |FINSI;
            |SINO;
               |ACABA;
            |FINSI;
         |SINO;
            |SI #dscam003#14 ! "L";
               |ABRE #dscam012;
               #dscam012#0 = #dscam003#17;
               |LEE 000#dscam012.=;
               |SI FSalida ! 0; |DDEFECTO #dscam012; |FINSI;
               |CIERRA #dscam012;

               |SI #dscam012#22 ! 2; |ACABA; |FINSI;
               |SI #dscam003#14 = "I"; |ACABA; |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;
   |SINO;
      |SI #dscam003#14 ! "L"; |O #dscam003#70 = "          "; |ACABA; |FINSI;
   |FINSI;
/*
   |SI #dscam051#119 = "S";
      |ABRE #dscam013;
      #dscam013#0 = #dscam003#17;
      #dscam013#1 = #dscam003#37;
      |LEE 000#dscam013.=;
      |SI FSalida = 0;
         |SI #dscam013#15 = "N"; |ACABA; |FINSI;
      |FINSI;
      |CIERRA #dscam013;
   |FINSI;
*/
   enSwClas   = 1; eaFichClas = "dscaz009"; eaTipoClas = #dscam003#12;
   |HAZ CompruebaClas;
   |SI eaFichClas = "ERROR"; |ACABA; |FINSI;

   |SI Manual = 0; Linea = Linea + 1; |FINSI;
   |DDEFECTO #dscaz009;
   |SI Manual = 0;
      #dscaz009#0  = Linea;
   |SINO;
      #dscaz009#0  = NumLin;
      |LEE 000#dscaz009.=;
   |FINSI;
   #dscaz009#31 = #dscam003#57;

   efFechaDiv = #dscaz009#14;
   Divisa = #dscaz009#31; |HAZ TomaDecim;
   #dscaz009#32 = #dscam003#58;
   #dscaz009#33 = CambioDivVn;
   #dscaz009#34 = #dscam003#59;
   #dscaz009#35 = #dscam051#23;
   #dscaz009#1  = #dscam003#0;
   #dscaz009#2  = #dscam003#1;
   #dscaz009#3  = #dscam003#2;
   #dscaz009#4  = #dscam003#5;
   #dscaz009#5  = #dscam003#32;
   #dscaz009#6  = #dscam003#6;
   #dscaz009#7  = #dscam003#23;
   #dscaz009#8  = 0;
   #dscaz009#9  = #dscam003#30;
   #dscaz009#10 = " ";
   #dscaz009#11 = #dscam003#3;
   #dscaz009#12 = #dscam003#4;
   #dscaz009#13 = "";
   #dscaz009#14 = ~;
   #dscaz009#15 = 0;
   #dscaz009#16 = #dscam003#13;
   #dscaz009#17 = #dscam003#12;
   #dscaz009#20 = #dscam003#27;
   #dscaz009#21 = #dscam003#40;
   #dscaz009#22 = #dscam003#44;
   #dscaz009#23 = #dscam003#45;
   #dscaz009#24 = #dscam003#46;
   #dscaz009#25 = #dscam003#61;
   #dscaz009#26 = 0;
   #dscaz009#27 = #dscam003#64;
   #dscaz009#28 = 0;
   #dscaz009#29 = 0;
   |SI Manual = 0;
      |GRABA 020#dscaz009.n;
   |SINO;
      |GRABA 020#dscaz009.a;
   |FINSI;
|FPRC;

|DEFBUCLE Vencimiento;
#dscam003#2;
23;
"01.01.1900",0000000001,0000000001;
"31.12.2999",9999999999,9999999999;
;
NULL,GrabaRecibo;
|FIN;

|DEFBUCLE Emision;
#dscam003#3;
23;
"01.01.1900",0000000001,0000000001;
"31.12.2999",9999999999,9999999999;
;
NULL,GrabaRecibo;
|FIN;

|DEFBUCLE Cliente;
#dscam003#4;
23;
"            ",000000001,0000000001;
"zzzzzzzzzzzz",999999999,9999999999;
;
NULL,GrabaRecibo;
|FIN;

|DEFBUCLE Acota1;
#dscam003#1;
32,3,4,12;
000000001,DCliente,#dscaw007#3,#dscaw007#5,#dscaw007#46;
999999999,HCliente,#dscaw007#4,#dscaw007#6,#dscaw007#47;
;
NULL,GrabaRecibo;
|FIN;

|DEFBUCLE Acota2;
#dscam003#1;
5,3,4,12;
000000001,DCliente,#dscaw007#3,#dscaw007#5,#dscaw007#46;
999999999,HCliente,#dscaw007#4,#dscaw007#6,#dscaw007#47;
;
NULL,GrabaRecibo;
|FIN;

|DEFBUCLE AcotaPT1;
#dscam003#1;
32,71,72;
000000001,DCliente,#dscaw178#3,#dscaw178#5;
999999999,HCliente,#dscaw178#4,#dscaw178#6;
;
NULL,GrabaRecibo;
|FIN;

|DEFBUCLE AcotaPT2;
#dscam003#1;
5,71,72;
000000001,DCliente,#dscaw007#3,#dscaw007#5;
999999999,HCliente,#dscaw007#4,#dscaw007#6;
;
NULL,GrabaRecibo;
|FIN;

|PROCESO BucleAcotadoRec;
   nSwAcota = 1;
   |PUSHV 0501 2380;
   #dscaw007#31 = #dscam051#100;

   |PINPA #0#5; |PINDA #0#5;
   |HAZ Seleccion;
   |ENDATOS #1#5;
   |SI FSalida = 0;
      |SI #dscaw007#31 = "G";
         |SI #dscaw007#0 = "S";
            DCliente = #dscaw007#1;
            HCliente = #dscaw007#2;
            |BUCLE Acota1;
         |SINO;
            |PARA Cont = 7; |SI Cont [ 30; |HACIENDO Cont = Cont + 1;
               |SI #dscaw007#Cont# ! 0;
                  DCliente = #dscaw007#Cont#;
                  HCliente = #dscaw007#Cont#;
                  |BUCLE Acota1;
               |FINSI;
            |SIGUE;
         |FINSI;
      |SINO;
         |SI #dscaw007#0 = "S";
            DCliente = #dscaw007#32;
            HCliente = #dscaw007#33;
            |BUCLE Acota2;
         |SINO;
            |PARA Cont = 34; |SI Cont [ 45; |HACIENDO Cont = Cont + 1;
               |SI #dscaw007#Cont# ! 0;
                  DCliente = #dscaw007#Cont#;
                  HCliente = #dscaw007#Cont#;
                  |BUCLE Acota2;
               |FINSI;
            |SIGUE;
         |FINSI;
      |FINSI;
   |FINSI;
   |POPV;
|FPRC;

|PROCESO BucleAcotadoPag;
   nSwAcota = 2;
   |PUSHV 0501 2380;
   #dscaw178#31 = #dscam051#100;
   |PINPA #0#dscaw178; |PINDA #0#dscaw178;
   |HAZ Seleccion1;
   |ENDATOS #1#dscaw178;
   |SI FSalida = 0;
      nSwEsPagare = 1;
      |SI #dscaw178#5 = "    "; #dscaw178#5 = "   !"; |FINSI;

      |SI #dscaw178#31 = "G";
         |SI #dscaw178#0 = "S";
            DCliente = #dscaw178#1;
            HCliente = #dscaw178#2;
            |BUCLE AcotaPT1;
         |SINO;
            |PARA Cont = 7; |SI Cont [ 30; |HACIENDO Cont = Cont + 1;
               |SI #dscaw178#Cont# ! 0;
                  DCliente = #dscaw178#Cont#;
                  HCliente = #dscaw178#Cont#;
                  |BUCLE AcotaPT1;
               |FINSI;
            |SIGUE;
         |FINSI;
      |SINO;
         |SI #dscaw178#0 = "S";
            DCliente = #dscaw178#32;
            HCliente = #dscaw178#33;
            |BUCLE AcotaPT2;
         |SINO;
            |PARA Cont = 34; |SI Cont [ 45; |HACIENDO Cont = Cont + 1;
               |SI #dscaw178#Cont# ! 0;
                  DCliente = #dscaw178#Cont#;
                  HCliente = #dscaw178#Cont#;
                  |BUCLE AcotaPT2;
               |FINSI;
            |SIGUE;
         |FINSI;
      |FINSI;
   |FINSI;
   |POPV;
|FPRC;

|RUTINA inf009;
   #dscaz009#0 = 00001;
|FRUT;

|RUTINA sup009;
   #dscaz009#0 = 99999;
|FRUT;

|PROCESO MarcaTodos;
   |SI #dscaz009#10 = "*"; |ACABA; |FINSI;
   eaTOperacion = "A"; eaTipoRecibo = "V"; enNumDocum = #dscaz009#21; |HAZ ProcesaTempo;

   #dscam003#40 = #dscaz009#21;
   |LEE 010#dscam003.=;
   |SI FSalida = 0;
      #dscaz009#35 = #dscam051#23;
      #dscaz009#8 = #dscam003#23;
      #dscaz009#10 = "*";
      HaySelec = HaySelec + 1;
      |GRABA 020#dscaz009.a;
   |FINSI;
|FPRC;

|DEFBUCLE MarcaTodos;
#dscaz009#1;
;
INICIO;
FINAL;
;
NULL,MarcaTodos;
|FIN;

|PROCESO DesmarcaTodos;
   |SI #dscaz009#10 = " "; |ACABA; |FINSI;
   eaTOperacion = "B"; eaTipoRecibo = "V"; enNumDocum = #dscaz009#21; |HAZ ProcesaTempo;

   #dscaz009#8 = 0;
   #dscaz009#10 = " ";
   |GRABA 020#dscaz009.a;
   HaySelec = HaySelec - 1;
|FPRC;

|DEFBUCLE DesmarcaTodos;
#dscaz009#1;
;
INICIO;
FINAL;
;
NULL,DesmarcaTodos;
|FIN;

|PROCESO MarcaDesm;
   |SI #dscaz009#10 = "*";
      eaTOperacion = "B"; eaTipoRecibo = "V"; enNumDocum = #dscaz009#21; |HAZ ProcesaTempo;
      #dscaz009#7  = 0;
      #dscaz009#8  = 0;
      #dscaz009#10 = " ";
      #dscaz009#13 = "";
      #dscaz009#14 = "01.01.0000";
      #dscaz009#16 = "";
      #dscaz009#17 = "";
      #dscaz009#25 = 0;
      #dscaz009#26 = 0;
      #dscaz009#33 = 0;
      #dscaz009#34 = 0;
      #dscaz009#35 = "";
      HaySelec = HaySelec - 1;
      |GRABA 020#dscaz009.a;
   |SINO;
      eaTOperacion = "A"; eaTipoRecibo = "V"; enNumDocum = #dscaz009#21; |HAZ ProcesaTempo;
      #dscam003#40 = #dscaz009#21;
      |LEE 010#dscam003.=;
      |SI FSalida = 0;
         #dscaz009#7  = #dscam003#23;
         #dscaz009#8  = #dscam003#23;
         #dscaz009#9  = #dscam003#30;
         #dscaz009#10 = "*";
         #dscaz009#13 = #dscam051#20;
         #dscaz009#14 = ~;
         #dscaz009#16 = #dscam003#13;
         #dscaz009#17 = #dscam003#12;
         #dscaz009#25 = #dscam003#61;
         #dscaz009#26 = #dscam003#61;
         #dscaz009#27 = #dscam003#64;
         #dscaz009#33 = #dscam003#59;
         #dscaz009#34 = #dscam003#59;
         #dscaz009#35 = #dscam051#23;
         |GRABA 020#dscaz009.a;
         HaySelec = HaySelec + 1;
      |FINSI;
   |FINSI;
|FPRC;

|PROCESO VuelcaRecs;
   ||Divisa = #dscam003#57; |HAZ TomaDecim;

   |SELECT #2#dscaz009;
   #dscaz009#0  = 1;
   #dscaz009#21 = #dscam003#40;
   |LEE 000#dscaz009.];
   |SI FSalida = 0; |Y #dscaz009#21 = #dscam003#40;
      #dscaz009#7  = #dscam003#23;
      #dscaz009#8  = #dscam003#23;
      #dscaz009#9  = #dscam003#30;
      #dscaz009#10 = "*";
      #dscaz009#13 = #dscam003#74;
      #dscaz009#14 = ~;
      #dscaz009#16 = #dscam003#13;
      #dscaz009#17 = #dscam003#12;
      #dscaz009#25 = #dscam003#61;
      #dscaz009#26 = #dscam003#61;
      #dscaz009#27 = #dscam003#64;
      #dscaz009#33 = #dscam003#59;
      #dscaz009#34 = #dscam003#59;
      #dscaz009#35 = #dscam051#23;
      |GRABA 020#dscaz009.a;
   |SINO;
      #dscaz009#0  = Linea; Linea = Linea + 1;
      #dscaz009#1  = #dscam003#0;
      #dscaz009#2  = #dscam003#1;
      #dscaz009#3  = #dscam003#2;
      #dscaz009#4  = #dscam003#5;
      #dscaz009#5  = #dscam003#32;
      #dscaz009#6  = #dscam003#6;
      #dscaz009#7  = #dscam003#23;
      #dscaz009#8  = #dscam003#23;
      #dscaz009#9  = #dscam003#30;
      #dscaz009#10 = "*";
      #dscaz009#11 = #dscam003#3;
      #dscaz009#12 = #dscam003#4;
      #dscaz009#13 = #dscam003#74;
      #dscaz009#14 = ~;
      #dscaz009#15 = 0;
      #dscaz009#16 = #dscam003#13;
      #dscaz009#17 = #dscam003#12;
      #dscaz009#18 = 0;
      #dscaz009#19 = 0;
      #dscaz009#20 = #dscam003#27;
      #dscaz009#21 = #dscam003#40;
      #dscaz009#22 = #dscam003#44;
      #dscaz009#23 = #dscam003#45;
      #dscaz009#24 = #dscam003#46;
      #dscaz009#25 = #dscam003#61;
      #dscaz009#26 = #dscam003#61;
      #dscaz009#27 = #dscam003#64;
      #dscaz009#28 = 0;
      #dscaz009#29 = 0;
      #dscaz009#30 = 0;
      #dscaz009#31 = #dscam003#57;
      #dscaz009#32 = #dscam003#58;
      #dscaz009#33 = #dscam003#59;
      #dscaz009#34 = #dscam003#59;
      #dscaz009#35 = #dscam051#23;
      |GRABA 020#dscaz009.n;
   |FINSI;
   HaySelec = HaySelec + 1;
   |SELECT #1#dscaz009;
|FPRC;

|DEFBUCLE VuelcaRecs;
#dscam003#7;
;
Entidad,Documento,0000000001;
Entidad,Documento,9999999999;
;
NULL,VuelcaRecs;
|FIN;

|PROCESO CompruebaRecs;
   |SI #dscam003#14 ! "L";
      |SI #dscam003#47 = "S";
         |SI #dscam003#14 ! "e";
            SwError = 1; |ERROR10;
         |FINSI;
      |SINO;
         SwError = 1; |ERROR10;
      |FINSI;
   |SINO;
      |SI #dscam003#47 = "S";
         SwError = 2; |ERROR10;
      |FINSI;
   |FINSI;
|FPRC;

|DEFBUCLE CompruebaRecs;
#dscam003#7;
;
Entidad,Documento,0000000001;
Entidad,Documento,9999999999;
;
NULL,CompruebaRecs;
|FIN;

|PROCESO VuelcaPagare;

   |PUSHV 2202 2270;
   |BLANCO 2202 2270;
   |PINTA 2203, "Entidad        N§ Documento            ";
   E_sup = 4;  E_inf = "";
   Entidad = "    ";
   Entidad = 2211 ? 0;
   E_sup = 10;  E_inf = "";
   Documento = "          ";
   Documento = 2231 ? 0;
   |ABRE #dscam003;
   |SELECT #7#dscam003;
   #dscam003#40 = 1;
   #dscam003#72 = Entidad;
   #dscam003#70 = Documento;
   |LEE 000#dscam003.];
   |SI FSalida ! 0; |O #dscam003#72 ! Entidad; |O #dscam003#70 ! Documento;
      |MENAV "    No existe el documento indicado";
      |ERROR;
   |SINO;
      Divisa = #dscam003#57; |HAZ TomaDecim;
      Linea = #dscaz009#0;

      SwError = 0;
      |BUCLE CompruebaRecs;
      |SI SwError ! 0;
         |SI SwError = 1;
            |MENAV "    Talon/Pagare con recibos no liquidados";
         |FINSI;
         |SI SwError = 2;
            |MENAV "    Talon/Pagare con entregas saldadas. Elimine el saldado e introduzca el impagado.";
         |FINSI;
         |ERROR;
      |SINO;
         |BUCLE VuelcaRecs;
      |FINSI;
   |FINSI;
   |SELECT #1#dscam003;
   |CIERRA #dscam003;
   |POPV;
|FPRC;

|PROCESO Baja; |TIPO 1;
     ModoEntrada = (FEntrada / 100) ! 0;
     |SI ModoEntrada = 3;
          |SI nSwEsPagare = 1;
               |AVISO; |ERROR;
          |SINO;
               eaTOperacion = "B";
               eaTipoRecibo = "V";
               enNumDocum = #dscaz009#21;
               |HAZ ProcesaTempo;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO MarcaDesmarca; |TIPO 11;
   |SI FSalida = 18;
      |SALVA_FICHA #dscaz009;
      |HAZ PideDatos;
      |PONCONTROL 23,"si";
      |REPON_FICHA #dscaz009;
   |FINSI;
/*
   |SI FSalida = 12;
      |SALVA_FICHA #dscaz009;
      |BUCLE DesmarcaTodos;
      |PONCONTROL 23,"si";
      |REPON_FICHA #dscaz009;
   |FINSI;
*/
   |SI FSalida = 13;
      |SALVA_FICHA #dscaz009;
      |HAZ VuelcaPagare;
      |PONCONTROL 23,"si";
      |REPON_FICHA #dscaz009;
   |FINSI;
/*
   |SI FSalida = 9;
      |HAZ MarcaDesm;
   |FINSI;
*/
|FPRC;

|PROCESO CuentaCobs;
   nCuentaCobs = nCuentaCobs + 1;
|FPRC;

|DEFBUCLE CuentaCobs;
#dscam004#3;
5;
nCodigo,aOper1;
nCodigo,aOper2;
;
NULL,CuentaCobs;
|FIN;

|PROCESO DesSalda;
   #dscam003#40 = nDocum;
   |LEE 101#dscam003.=;
   |SI FSalida = 0;
      aCtaCobro = "";
      #dscam004#17 = #dscam003#40;
      #dscam004#3  = 99;
      |LEE 000#dscam004.];
      |SI FSalida = 0;
         |LEE 000#dscam004.a;
      |SINO;
         |LEE 000#dscam004.u;
      |FINSI;
      |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40;
         |SI #dscam004#5 = "CAC"; aCtaCobro = #dscam004#4; |FINSI;
         nLinea = #dscam004#3 + 1;
      |SINO;
         nLinea = 1;
      |FINSI;

      |DDEFECTO #dscam004;
      #dscam004#17 = #dscam003#40;
      #dscam004#3 = nLinea;
      |GRABA 020#dscam004.b;

      #dscam004#0 = #dscam003#0;
      #dscam004#1 = #dscam003#1;
      #dscam004#2 = #dscam003#2;
      #dscam004#4 = aCtaCobro;
      #dscam004#5 = "ACA";  || Anulacion cobro a cuenta
      #dscam004#6 = ~;
      #dscam004#7 = #dscam003#23; #dscam004#25 = #dscam003#61;
      #dscam004#9 = nImporteD;    #dscam004#27 = nImporteB;
      aAlfa = "Impagado entr. " + (("000000000" + #dscaz009#21) % -109);
      #dscam004#16 = aAlfa;
      #dscam004#22 = " ";
      #dscam004#24 = 0;
      #dscam004#38 = #dscam003#44; #dscam004#39 = #dscam003#45;
      |GRABA 020#dscam004.a; |LIBERA #dscam004;

      #dscam003#23 = #dscam003#23 - #dscam004#9; #dscam003#61 = #dscam003#61 - #dscam004#27;
      #dscam003#31 = #dscam003#31 + #dscam004#9; #dscam003#65 = #dscam003#65 + #dscam004#27;

      #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
      #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
      #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
      #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);
      #dscam003#26 = #dscam004#6;
      |SI #dscam003#23 ! 0;
         #dscam003#14 = "C";
         #dscam003#15 = "Cobrado parcialmente";
      |SINO;
         #dscam003#14 = "P";
         #dscam003#15 = "Pendiente de cobro";
      |FINSI;
      |GRABA 020#dscam003.a;

      eaDescr = "BAJA COMP.ENTREGA POR IMPAGO";
      eaDescr   = eaDescr + " (" + #dscam003#0 + "/";
      eaDescr   = eaDescr + #dscam003#1 + "/" + #dscam003#2 + ") DESDE LINEAS DE RECIBOS";
      eaTipoOp  = "B";   enImpAnt = #dscam003#55 + #dscam004#9;
      eaFicher = "dscam003"; eaClave = #dscam003#40;
      enImpAct  = #dscam003#31; |HAZ GrabaAudit;

      |LIBERA #dscam003;
   |FINSI;
|FPRC;

|PROCESO PonUsuImpagado;
     |HORA aAlfa;
     aAlfa1 = aAlfa % 0102;    #dspvm002@#123 = aAlfa1;
     aAlfa1 = aAlfa % 0402;    #dspvm002@#124 = aAlfa1;

     #pycm0013@#0 = #48#0;
     |LEE 000#pycm0013@.=;
     |SI FSalida ! 0;  |DDEFECTO #pycm0013@;  |FINSI;

     aAlfa = #pycm0013@#96;   |QBF aAlfa;
     |SI aAlfa = "";
         aAlfa = Usuario % 0810;
     |FINSI;

     #dspvm002@#125 = aAlfa;

     #maesm011@#0 = aAlfa;
     |LEE 000#maesm011@.=;
     |SI FSalida ! 0; |DDEFECTO #maesm011@; |FINSI;

     #dspvm002@#126 = #maesm011@#1;
     #dspvm002@#127 = #maesm011@#11;
|FPRC;

|PROCESO CreaNuevaIncidencia;
     |SELECT #3#pycm0011@;
     #pycm0011@#9  = #dscaz009#1;
     #pycm0011@#10 = #dscaz009#2;
     |LEE 000#pycm0011@.=;
     |SI FSalida = 0;
        nContrato = #pycm0011@#0;
     |SINO;
        |SELECT #3#dsvim017@;
        #dsvim017@#7  = #dscaz009#1;
        #dsvim017@#8  = #dscaz009#2;
        |LEE 000#dsvim017@.=;
        |SI FSalida = 0;
           nSw = 0;
           |SELECT #3#pycm0007@;
           #pycm0007@#0 = 1;
           #pycm0007@#3 = #dsvim017@#1;
           |LEE 000#pycm0007@.];
           |PARA; |SI FSalida = 0; |Y #pycm0007@#3 = #dsvim017@#1; |HACIENDO;
              #pycm0024@#0 = #pycm0007@#0;
              #pycm0024@#1 = #dsvim017@#2;
              |LEE 000#pycm0024@.=;
              |SI FSalida = 0; nSw = 1; |SAL; |FINSI;
              |LEE 000#pycm0007@.s;
           |SIGUE;
           |SELECT #1#pycm0007@;
           |SI nSw = 1;
              nContrato = #pycm0007@#0;
           |FINSI;
        |FINSI;
        |SELECT #1#dsvim017@;
     |FINSI;

     |SELECT #4#pycm0011@;
     #pycm0011@#11 = #dscaz009#1;
     #pycm0011@#12 = #dscaz009#2;
     |LEE 000#pycm0011@.=;
     |SI FSalida = 0;
        nContrato = #pycm0011@#0;
     |FINSI;

     |SI nContrato ! 0;
        #pycm0007@#0 = nContrato;
        |LEE 000#pycm0007@.=;
        |SI FSalida ! 0; |DDEFECTO #pycm0007@; |FINSI;

        #pycm0024@#0 = nContrato;
        #pycm0024@#1 = 1;
        |LEE 000#pycm0024@.];
        |SI FSalida ! 0; |O #pycm0024@#0 ! nContrato;
           |DDEFECTO #pycm0024@;
        |FINSI;

        #prevm004@#0 = #pycm0007@#3;
        #prevm004@#1 = #pycm0024@#1;
        |LEE 000#prevm004@.=;
        |SI FSalida ! 0; |DDEFECTO #prevm004@; |FINSI;

        #visalm01@#0 = #dscaz009#5;
        |LEE 000#visalm01@.=;
        |SI FSalida ! 0; |DDEFECTO #visalm01@; |FINSI;
     |SINO;
        |MENAV "    No se encuentra el contrato de la cuota de este recibo.La incidencia tendra algunos campos por defecto.";

        #visalm01@#0 = #dscaz009#5;
        |LEE 000#visalm01@.=;
        |SI FSalida ! 0; |DDEFECTO #visalm01@; |FINSI;

        #pycm0005@#0 = #visalm01@#5;
        #pycm0005@#1 = 1;
        |LEE 000#pycm0005@.];
        |SI FSalida ! 0; |O #pycm0005@#0 ! #visalm01@#5;
           |DDEFECTO #pycm0005@;
        |FINSI;

        #prevm004@#0 = #visalm01@#0;
        #prevm004@#1 = #pycm0005@#1;
        |LEE 000#prevm004@.=;
        |SI FSalida ! 0; |DDEFECTO #prevm004@; |FINSI;

        |DDEFECTO #pycm0024@; |DDEFECTO #pycm0007@;
        #pycm0024@#1 = #pycm0005@#1;
        #pycm0024@#2 = #pycm0005@#2;

        |DDEFECTO #pycm0007@;
        #pycm0007@#0 = 0;
     |FINSI;

     |SELECT #1#dspvm002@;
     |LEE 000#dspvm002@.p;
     nCalc = #dspvm002@#0 + 1;

     |DDEFECTO #dspvm002@;
     #dspvm002@#0 = nCalc;
     |GRABA 020#dspvm002@.b;

     #dspvm002@#7   = "C";
     #dspvm002@#8   = #dscaz009#5;
     #dspvm002@#9   = #dscaz009#6;
     #dspvm002@#10  = #pycm0024@#1;
     #dspvm002@#11  = #pycm0024@#2;
     #dspvm002@#15  = #pycm0007@#0;
     #dspvm002@#16  = #pycm0007@#85;
     #dspvm002@#17  = #dscam003#33;
     #dspvm002@#18  = #dscam003#34;
     #dspvm002@#175 = #prevm004@#3;
     #dspvm002@#176 = #prevm004@#9;
     #dspvm002@#202 = #visalm01@#13;
     #dspvm002@#203 = #visalm01@#113;

     #maesm011@#0 = #dspvm002@#175;
     |LEE 000#maesm011@.=;
     |SI FSalida ! 0; |DDEFECTO #maesm011@; |FINSI;

     #dspvm002@#177 = #maesm011@#11;
     #dspvm002@#121 = "S";
     #dspvm002@#122 = #dscaz009#14;

     |HAZ PonUsuImpagado;

     #dspvm002@#128 = #dscam003#5;
     #dspvm002@#129 = #dscaz009#1;
     #dspvm002@#130 = #dscaz009#2;
     #dspvm002@#131 = #dscaz009#3;
     #dspvm002@#201 = "S";

     aAlfa = "Devoluci¢n del recibo correspondiente a la factura ";
     aAlfa = aAlfa + #dscaz009#1 + "/" + (("000000" + #dscaz009#2) % -106);
     aAlfa = aAlfa + " por importe";
     #dspvm002@#132 = aAlfa; nCalc1 = nCalc1 + 1;

     aAlfa = "de " + #dscaz009#8;
     #dspvm002@#133 = aAlfa;

     #dspvm002@#204 = #48#0;

     #dscam043#9 = #48#0;
     |LEE 000#dscam043.=;
     |SI FSalida ! 0;
        #dspvm002@#205 = #48#0;
     |SINO;
        #dspvm002@#205 = #dscam043#0;
     |FINSI;

     |GRABA 020#dspvm002@.a;
     |LIBERA #dspvm002@;

     #maesm011@#0 = Usuario % 810;
     |LEE 000#maesm011@.=;
     |SI FSalida ! 0; |DDEFECTO #maesm011@; |FINSI;
     #dspvm002@#177 = #maesm011@#11;

     #dspvm003@#0  = #dspvm002@#0;
     #dspvm003@#1  = 1;
     |LEE 101#dspvm003@.=;
     |SI FSalida ! 0;
         |DDEFECTO #dspvm003@;
         #dspvm003@#0  = #dspvm002@#0;
         #dspvm003@#1  = 1;
         |GRABA 020#dspvm003@.b;
     |FINSI;

     #dspvm003@#2  = #dspvm002@#122;
     #dspvm003@#3  = #dspvm002@#123;
     #dspvm003@#4  = #dspvm002@#124;
     #dspvm003@#5  = #maesm011@#0;
     #dspvm003@#6  = #maesm011@#1;
     #dspvm003@#7  = "Reclamar impago";
     #dspvm003@#29 = #maesm011@#0;
     #dspvm003@#30 = #maesm011@#1;

     |GRABA 020#dspvm003@.a;
     |LIBERA #dspvm003@;
|FPRC;

|PROCESO InciOTP;
     aAlfa = "    S" + &191 + " Crear incidencia ?";
     |CONFI aAlfa;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |SI #dscaz009#5 = "000000";
         |MENAV "0000Impagado sin codigo de cliente, revise los datos.";
         |ACABA;
     |FINSI;

     nContrato = 0;
     #dscam003#40 = #dscaz009#21;
     |LEE 000#dscam003.=;
     |SI FSalida ! 0; |DDEFECTO #dscam003; |FINSI;

     |DBASS aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "dspreven/def/visalm00.mas";
     |CARGA_DEF aAlfa, visalm00@;
     |SI FSalida ! 0;  |ACABA;  |FINSI;

     |DBASS aAlfa; |QBF aAlfa;
     aAlfa = aAlfa + "dspreven/fich/"; |PATH_DAT #visalm00@#aAlfa#;

     |ABRE #visalm00@;
     |LEE 000#visalm00@.p;
     |PARA; |SI FSalida = 0; |HACIENDO;
            |SI #visalm00@#3 = "S"; |SAL; |FINSI;
            |LEE 000#visalm00@.s;
      |SIGUE;
      |CIERRA #visalm00@;

      |SI #visalm00@#3 ! "S";
          |DESCARGA_DEF #visalm00@;
          |ACABA;
      |FINSI;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dspreven/def/dspvm002.mas";
      |CARGA_DEF aAlfa, dspvm002@;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dspreven/def/dspvm003.mas";
      |CARGA_DEF aAlfa, dspvm003@;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dspreven/def/maesm011.mas";
      |CARGA_DEF aAlfa, maesm011@;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dspreven/def/pycm0011.mas";
      |CARGA_DEF aAlfa, pycm0011@;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dspreven/def/pycm0007.mas";
      |CARGA_DEF aAlfa, pycm0007@;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dspreven/def/pycm0024.mas";
      |CARGA_DEF aAlfa, pycm0024@;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dspreven/def/prevm004.mas";
      |CARGA_DEF aAlfa, prevm004@;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dspreven/def/dsvim017.mas";
      |CARGA_DEF aAlfa, dsvim017@;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dspreven/def/visalm01.mas";
      |CARGA_DEF aAlfa, visalm01@;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dspreven/def/pycm0005.mas";
      |CARGA_DEF aAlfa, pycm0005@;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dspreven/def/pycm0013.mas";
      |CARGA_DEF aAlfa, pycm0013@;

      |DBASS aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dspreven/fich/";
      |PATH_DAT #maesm011@#aAlfa#;

      aAlfa = aAlfa + (("00000" + #visalm00@#0) % -105) + "/";

      |PATH_DAT #dspvm002@#aAlfa#; |PATH_DAT #pycm0005@#aAlfa#;
      |PATH_DAT #dspvm003@#aAlfa#;
      |PATH_DAT #pycm0011@#aAlfa#; |PATH_DAT #pycm0007@#aAlfa#;
      |PATH_DAT #pycm0024@#aAlfa#; |PATH_DAT #prevm004@#aAlfa#;
      |PATH_DAT #dsvim017@#aAlfa#; |PATH_DAT #visalm01@#aAlfa#;
      |PATH_DAT #pycm0013@#aAlfa#;

      |ABRE #maesm011@; |ABRE #pycm0011@;
      |ABRE #pycm0007@; |ABRE #pycm0024@;
      |ABRE #prevm004@; |ABRE #dsvim017@;
      |ABRE #dspvm002@; |ABRE #dspvm003@;
      |ABRE #visalm01@; |ABRE #pycm0005@;
      |ABRE #pycm0013@;

      |SELECT #2#dspvm002@;
      |LEE 000#dspvm002@.p;
      #dspvm002@#8 = #dscaz009#5;
      |LEE 000#dspvm002@.];
      |PARA; |SI FSalida = 0; |Y #dspvm002@#8 = #dscaz009#5;  |HACIENDO;
             |SI #dspvm002@#1 = "A"; |Y #dspvm002@#7 = "C";
                 |SAL;
             |FINSI;
             |LEE 000#dspvm002@.s;
      |SIGUE;

      |SI FSalida ! 0;  |O #dspvm002@#8 ! #dscaz009#5;
          #dspvm002@#0 = -1;
      |FINSI;

      |SELECT #1#dspvm002@;
      |LEE 101#dspvm002@.=;
      |SI FSalida = 0;
          |SI #dspvm002@#121 = "N";
               #dspvm002@#121 = "S";
               #dspvm002@#122 = #dscaz009#14;

               |HAZ PonUsuImpagado;

               #dspvm002@#128 = #dscam003#5;
               #dspvm002@#129 = #dscaz009#1;
               #dspvm002@#130 = #dscaz009#2;
               #dspvm002@#131 = #dscaz009#3;
               #dspvm002@#201 = "S";
               #dspvm002@#204 = #48#0;

               #dscam043#9 = #48#0;
               |LEE 000#dscam043.=;
               |SI FSalida ! 0;
                   #dspvm002@#205 = #48#0;
               |SINO;
                   #dspvm002@#205 = #dscam043#0;
               |FINSI;

               nCalc1 = 151;
               |PARA nCont1 = 151; |SI nCont1 ] 132; |HACIENDO nCont1 = nCont1 - 1;
                     aAlfa2 = #dspvm002@#nCont1#; |QBF aAlfa2;
                     |SI aAlfa2 = "";
                         nCalc1 = nCont1;
                     |SINO;
                         |SAL;
                     |FINSI;
               |SIGUE;

               |SI nCalc1 ] 132; |Y nCalc1 [ 151;
                   aAlfa = "Devoluci¢n del recibo correspondiente a la factura ";
                   aAlfa = aAlfa + #dscaz009#1 + "/" + (("000000" + #dscaz009#2) % -106);
                   aAlfa = aAlfa + " por importe";
                   #dspvm002@#nCalc1# = aAlfa; nCalc1 = nCalc1 + 1;
                   |SI nCalc1 [ 151;
                       aAlfa = "de " + #dscaz009#8;
                       #dspvm002@#nCalc1# = aAlfa;
                   |FINSI;
                |FINSI;
                |GRABA 020#dspvm002@.a;
                |LIBERA #dspvm002@;
          |SINO;
                |LIBERA #dspvm002@;

                aAlfa = "0000Hay una incidencia abierta del mismo cliente. [" + (("0000000" + #dspvm002@#0) % -107) + "]";
                |MENAV aAlfa;
                aAlfa = "0000NCreamos una nueva incidencia";
                |CONFI aAlfa;
                |SI FSalida = 0;
                    |HAZ CreaNuevaIncidencia;
                |FINSI;
          |FINSI;
      |SINO;
          |HAZ CreaNuevaIncidencia;
      |FINSI;
      |SELECT #1#dspvm002@;

      |CIERRA #pycm0013@; |DESCARGA_DEF #pycm0013@;
      |CIERRA #pycm0005@; |DESCARGA_DEF #pycm0005@;
      |CIERRA #visalm01@; |DESCARGA_DEF #visalm01@;
      |CIERRA #dsvim017@; |DESCARGA_DEF #dsvim017@;
      |CIERRA #prevm004@; |DESCARGA_DEF #prevm004@;
      |CIERRA #pycm0024@; |DESCARGA_DEF #pycm0024@;
      |CIERRA #pycm0007@; |DESCARGA_DEF #pycm0007@;
      |CIERRA #pycm0011@; |DESCARGA_DEF #pycm0011@;
      |CIERRA #maesm011@; |DESCARGA_DEF #maesm011@;
      |CIERRA #dspvm003@; |DESCARGA_DEF #dspvm003@;
      |CIERRA #dspvm002@; |DESCARGA_DEF #dspvm002@;
                          |DESCARGA_DEF #visalm00@;
|FPRC;

|PROCESO Volcado;
   |SI #dscaz009#10 = " "; |ACABA; |FINSI;

   nNumSec = #dscaz009#36;

   Divisa = #dscaz009#31; |HAZ TomaDecim;
   DifCambio = (1/#dscaz009#33) - (1/#dscaz009#34);

   eaSerieGastos   = ""; enFactGastos    = 0; efEmisionGastos = "01.01.0000";
   |SI #dscam051#48 = "S";
      |HAZ FacturaGastos;
      #dscaz009#15 = 0; #dscaz009#18 = 0; #dscaz009#19 = 0;
      #dscaz009#28 = 0; #dscaz009#29 = 0; #dscaz009#30 = 0;
   |FINSI;

   |SI #dscaz009#14 < fFechaOpMenor; fFechaOpMenor = #dscaz009#14; |FINSI;
   |SI #dscaz009#14 > fFechaOpMayor; fFechaOpMayor = #dscaz009#14; |FINSI;

   #dscam003#40 = #dscaz009#21;
   |LEE 000#dscam003.=;
   |SI FSalida = 0;
      |ABRE #dscam012;
      #dscam012#0 = #dscam003#17;
      |LEE 000#dscam012.=;
      |SI FSalida ! 0; |DDEFECTO #dscam012; |FINSI;
      |CIERRA #dscam012;

      |HAZ EsArtenvas;
      |SI FSalida = 0;
         |ABRE #dscam013;
         #dscam013#0 = #dscam003#17;
         #dscam013#1 = #dscam003#37;
         |LEE 000#dscam013.=;
         |SI FSalida = 0; |Y #dscam013#15 = "N";
            aAlfa = "    NEl recibo " + #dscam003#40 + " es de la remesa " + #dscam013#0;
            aAlfa = aAlfa + " sin riesgo bancario descontado. " + &191 + " Descontar ?";
            |CONFI aAlfa;
            |SI FSalida = 0;
               |HAZ DescuentoAutomatico;
               |LEE 000#dscam003.=;
               |LEE 000#dscam013.=;
               |SI #dscam003#14 = "L";
                  #dscaz009#31 = #dscam003#57;
                  efFechaDiv = #dscaz009#14;
                  Divisa = #dscaz009#31; |HAZ TomaDecim;
                  #dscaz009#32 = #dscam003#58;
                  #dscaz009#33 = CambioDivVn;
                  #dscaz009#34 = #dscam003#59;
                  DifCambio = (1/#dscaz009#33) - (1/#dscaz009#34);
                  #dscaz009#35 = #dscam051#23;
                  #dscaz009#1  = #dscam003#0;
                  #dscaz009#2  = #dscam003#1;
                  #dscaz009#3  = #dscam003#2;
                  #dscaz009#4  = #dscam003#5;
                  #dscaz009#5  = #dscam003#32;
                  #dscaz009#6  = #dscam003#6;
                  #dscaz009#7  = #dscam003#23;
                  #dscaz009#8  = #dscam013#22;
                  #dscaz009#9  = #dscam003#30;
                  #dscaz009#10 = " ";
                  #dscaz009#11 = #dscam003#3;
                  #dscaz009#12 = #dscam003#4;
                  #dscaz009#13 = "";
                  #dscaz009#14 = ~;
                  #dscaz009#15 = 0;
                  #dscaz009#16 = #dscam003#13;
            || Comentado segun Tiquet: 160/1060
            ||      #dscaz009#17 = #dscam003#12;
                  #dscaz009#20 = #dscam003#27;
                  #dscaz009#21 = #dscam003#40;
                  #dscaz009#22 = #dscam003#44;
                  #dscaz009#23 = #dscam003#45;
                  #dscaz009#24 = #dscam003#46;
                  #dscaz009#25 = #dscam003#61;
                  #dscaz009#27 = #dscam003#64;
                  #dscaz009#26 = #dscam013#7;
                  #dscaz009#28 = 0;
                  #dscaz009#29 = 0;
               |FINSI;
            |SINO;
               |CIERRA #dscam013; |ACABA;
            |FINSI;
         |FINSI;
         |CIERRA #dscam013;
      |FINSI;
   |FINSI;

   nImporte = 0;
   eaTipoOper = "";

   |SI #dscam051#3 = "S";
      enEmpCartera = -1;     enEmpGestion = #dscaz009#24;
      eaSerie = #dscaz009#1; eaCliGest = #dscaz009#5;
      eaTipoOper = "+7";
      |SI #dscam003#14 ! "L"; |Y #dscam012#22 = 2; || Impagado de remesa sin abono
         nImporte = #dscaz009#27 + #dscaz009#28 + #dscaz009#29 + #dscaz009#30;
         |SI nImporte = 0;
            nImporte = #dscam003#30;
            enEmpCartera = -1;     enEmpGestion = #dscam003#46;
            eaSerie = #dscam003#0; eaCliGest    = #dscam003#32;
         |FINSI;
      |SINO;
         |SI #dscam003#14 = "T";
               nImporte = #dscaz009#9;
               eaTipoOper = eaTipoOper + "-4";
         |SINO;
               nImporte = #dscaz009#26 + #dscaz009#28 + #dscaz009#29 + #dscaz009#30;
         |FINSI;
      |FINSI;
      |HAZ BucleRiesgo;
      eaTipoOper = "";

      |SI #dscam003#14 = "L";
         |SI #dscam051#119 = "N";
            |ABRE #dscam013;
            #dscam013#0 = #dscam003#17;
            #dscam013#1 = #dscam003#37;
            |LEE 000#dscam013.=;
            |SI FSalida = 0;
               |SI #dscam013#15 = "N";
                  nImporte = #dscaz009#26;
                  eaTipoOper = "-6";
               |FINSI;
            |FINSI;
            |CIERRA #dscam013;
         |FINSI;
      |SINO;
         |ABRE #dscam012;
         #dscam012#0 = #dscam003#17;
         |LEE 000#dscam012.=;
         |SI FSalida ! 0; |DDEFECTO #dscam012; |FINSI;
         |CIERRA #dscam012;

         |SI #dscam012#22 = 2;
            nImporte = #dscaz009#27;
            eaTipoOper = "-4";
         |FINSI;
      |FINSI;
      |HAZ BucleRiesgo;
   |FINSI;

   #dscam004#17 = #dscaz009#21;
   #dscam004#3 = 99;
   |LEE 010#dscam004.];
   |SI FSalida ! 0;
      |LEE 010#dscam004.u;
      |SI FSalida = 0; |Y #dscam004#17 = #dscaz009#21;
         LinCob = #dscam004#3 + 1;
         UltFecha = #dscam004#6; UltNumero = #dscam004#3;
      |SINO;
         LinCob = 1;
      |FINSI;
   |SINO;
      |SI #dscam004#0 = #dscaz009#1; |Y #dscam004#17 = #dscaz009#21;
         LinCob = #dscam004#3 + 1;
         UltFecha = #dscam004#6; UltNumero = #dscam004#3;
      |SINO;
         |LEE 010#dscam004.a;
         |SI FSalida = 0; |Y #dscam004#17 = #dscaz009#21;
            LinCob = #dscam004#3 + 1;
            UltFecha = #dscam004#6; UltNumero = #dscam004#3;
         |SINO;
            LinCob = 1;
         |FINSI;
      |FINSI;
   |FINSI;

   #dscam003#40 = #dscaz009#21;
   |LEE 000#dscam003.=;
   |SI FSalida = 0;
      |ABRE #dscam012;
      #dscam012#0 = #dscam003#17;
      |LEE 000#dscam012.=;
      |SI FSalida ! 0; |DDEFECTO #dscam012; |FINSI;
      |CIERRA #dscam012;

      aEnt1 = #dscam003#72; aNum1 = #dscam003#70;
      |SI #dscam003#47 ! "S"; |Y #dscam003#69 = " ";
         |DDEFECTO #dscam004;
         #dscam004#0  = #dscaz009#1;
         #dscam004#1  = #dscaz009#2;
         #dscam004#2  = #dscaz009#3;
         #dscam004#3  = LinCob;
         #dscam004#4  = #dscaz009#13;
         |SI #dscam003#14 = "L";
            #dscam004#5  = "IMP";
         |SINO;
            || ABDON   17/10/2012   N§ tiquet 000160/00648
            ||  Este nuevo movimiento es un impagado de un recibo que
            ||     pertenece a una remesa que el banco aun no me ha abonado.
            |SI #dscam012#22 ! 2;
               #dscam004#5  = "IMP";
            |SINO;
               #dscam004#5  = "IMA";
            |FINSI;
         |FINSI;
         #dscam004#6  = #dscaz009#14;
         #dscam003#40 = #dscaz009#21;
         |LEE 010#dscam003.=;
         |SI FSalida = 0;
            #dscam004#7  = #dscam003#23; #dscam004#25 = #dscam003#61;
         |FINSI;
         #dscam004#8  = 0; #dscam004#26 = 0;
         #dscam004#9  = #dscaz009#8;   #dscam004#27 = #dscaz009#26;
         #dscam004#10 = #dscaz009#15 + #dscaz009#19 + #dscaz009#18;
         #dscam004#11 = #dscaz009#16;
         #dscam004#12 = #dscaz009#15; #dscam004#29 = #dscaz009#28;
         #dscam004#13 = #dscaz009#18; #dscam004#30 = #dscaz009#29;
         #dscam004#14 = #dscaz009#19; #dscam004#31 = #dscaz009#30;
         #dscam004#15 = #dscaz009#20;
         #dscam004#17 = #dscaz009#21;

         #dscam004#24 = #dscaz009#8 * DifCambio;
         #dscam004#33 = #dscaz009#33;
         #dscam004#43 = nNumSec;
         #dscam004#48 = eaSerieGastos;
         #dscam004#49 = enFactGastos;
         #dscam004#50 = efEmisionGastos;
         #dscam004#51 = #dscam003#72;
         #dscam004#52 = #dscam003#70;
         #dscam004#53 = #dscam003#71;
         |HAZ EsArtenvas;
         |SI FSalida = 0; |Y #dscam004#9 ! 0; |Y #dscam004#27 = 0;
            |SI #dscam003#59 = 1; #dscam004#27 = #dscam004#9; |FINSI;
         |FINSI;
         |GRABA 020#dscam004.c;
         eaUsuario = Usuario % 0810;
         eaTipoReg = "CB";  eaNumero = (("000000000" + #dscam004#17) % -109) + "/" + (("000" + #dscam004#3) % -103);
         eaDescr   = "ALTA IMPAGADO RECIBO (" + (("000000000" + #dscam004#17) % -109) + "/" + (("000" + #dscam004#3) % -103);
         eaDescr   = eaDescr + ") DESDE CONTROL DE IMPAGADOS";
         eaTipoOp  = "A";
         enImpAnt = #dscam003#64; enImpAct = #dscam003#64 - #dscam004#9;
         |HAZ GrabaAudit;

         |SI #dscam004#5  = "IMA";
            |ABRE #dscam013;
            #dscam013#0 = #dscam003#17;
            #dscam013#1 = #dscam003#37;
            |LEE 101#dscam013.=;
            |SI FSalida = 0;
               #dscam013#15 = "I";
               |GRABA 020#dscam013.a; |LIBERA #dscam013;
            |FINSI;
            |CIERRA #dscam013;
         |FINSI;

         #dscam003#40 = #dscaz009#21;
         |LEE 101#dscam003.=;
         |SI FSalida = 0;
            importeant = #dscam003#64;
            #dscam003#56 = #dscam003#56 + (#dscaz009#8 * DifCambio);
            #dscam003#26 = "";
            #dscam003#23 = #dscam003#23 - #dscaz009#8;  #dscam003#61 = #dscam003#61 - (#dscaz009#26 - #dscam004#24);
            #dscam003#16 = #dscam003#16 + 1;
            #dscam003#24 = #dscam003#24 + #dscaz009#15; #dscam003#62 = #dscam003#62 - (#dscaz009#15 * #dscaz009#33);
            #dscam003#25 = #dscam003#25 + #dscaz009#18; #dscam003#63 = #dscam003#63 + #dscaz009#29;
            #dscam003#38 = #dscam003#38 + #dscaz009#19; #dscam003#66 = #dscam003#66 + #dscaz009#30;

            #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
            #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);

            #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
            #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);

            #dscam003#31 = #dscam003#30 - #dscam003#23; #dscam003#65 = #dscam003#64 - #dscam003#61;

            |SI #dscam003#31 = 0;
               #dscam003#14 = "L";
               #dscam003#15 = "Recibo Liquidado";
            |SINO;
               |SI #dscam003#23 = 0;
                  |SI #dscam003#16 = 0;
                     #dscam003#14 = "P";
                     #dscam003#15 = "Pendiente de cobro";
                  |SINO;
                     #dscam003#14 = "I";
                     #dscam003#15 = "Impagado";
                  |FINSI;
               |SINO;
                  #dscam003#14 = "C";
                  #dscam003#15 = "Parcialmente cobrado";
               |FINSI;
            |FINSI;
            |SI #dscam003#72 ! "    ";
               |DDEFECTO #dscam066;
               #dscam066#0 = #dscam003#40;
               |LEE 000#dscam066.=;
               |SI FSalida ! 0;
                  #dscam066#0 = #dscam003#40;
                  #dscam066#1 = #dscam003#31;
                  #dscam066#2 = #dscam003#65;
                  |GRABA 020#dscam066.n;
               |FINSI;
            |FINSI;

            |SI #dscaz009#37 = "A"; #dscam003#28 = "S"; |FINSI;

            #dscam003#12 = #dscaz009#17;
            #dscam003#84 = "N"; #dscam003#90 = "N";
            #dscam003#29 = "N"; #dscam003#93 = "N";
            #dscam003#70 = "";  #dscam003#72 = "";
            #dscam003#100 = "S";
            |GRABA 020#dscam003.a; |LIBERA #dscam003;
         |FINSI;
      |SINO;
         || Puede que la entrega este saldada o no saldada. Si no est  saldada
         ||    hacemos lo que hace ahora ...
         #dscam003#40 = #dscaz009#21;
         |LEE 000#dscam003.=;
         |SI FSalida = 0;
            |SI #dscam003#14 = "e";
               |DDEFECTO #dscam004;
               #dscam004#0  = #dscaz009#1;
               #dscam004#1  = #dscaz009#2;
               #dscam004#2  = #dscaz009#3;
               #dscam004#3  = LinCob;
               #dscam004#4  = #dscaz009#13;
               #dscam004#5  = "IMP";
               #dscam004#6  = #dscaz009#14;
               #dscam003#40 = #dscaz009#21;
               |LEE 000#dscam003.=;
               |SI FSalida = 0;
                  #dscam004#7  = #dscam003#23; #dscam004#25 = #dscam003#61;
               |FINSI;
               #dscam004#8  = 0;             #dscam004#26 = 0;
               #dscam004#9  = #dscaz009#8;   #dscam004#27 = #dscaz009#26;
               #dscam004#10 = #dscaz009#15 + #dscaz009#19 + #dscaz009#18;
               #dscam004#11 = #dscaz009#16;
               #dscam004#12 = #dscaz009#15; #dscam004#29 = #dscaz009#28;
               #dscam004#13 = #dscaz009#18; #dscam004#30 = #dscaz009#29;
               #dscam004#14 = #dscaz009#19; #dscam004#31 = #dscaz009#30;
               #dscam004#15 = #dscaz009#20;
               #dscam004#17 = #dscaz009#21;

               |SI DifCambio ! 1;
                  #dscam004#24 = #dscaz009#8 * DifCambio;
               |FINSI;
               #dscam004#33 = #dscaz009#33;
               #dscam004#43 = nNumSec;
               #dscam004#51 = #dscam003#72;
               #dscam004#52 = #dscam003#70;
               #dscam004#53 = #dscam003#71;
               |GRABA 020#dscam004.n;

               eaUsuario = Usuario % 0810;
               eaTipoReg = "CB";  eaNumero = (("000000000" + #dscam004#17) % -109) + "/" + (("000" + #dscam004#3) % -103);
               eaDescr   = "ALTA IMPAGADO ENTREGA A CUENTA (" + (("000000000" + #dscam004#17) % -109) + "/" + (("000" + #dscam004#3) % -103);
               eaDescr   = eaDescr + ") DESDE CONTROL DE IMPAGADOS";
               eaTipoOp  = "A";
               enImpAnt = #dscam003#64; enImpAct = #dscam003#64 - #dscam004#9;
               |HAZ GrabaAudit;

               #dscam003#40 = #dscaz009#21;
               |LEE 101#dscam003.=;
               |SI FSalida = 0;
                  importeant = #dscam003#64;
                  |SI DifCambio ! 1;
                     #dscam003#56 = #dscam003#56 + (#dscaz009#8 * DifCambio);
                  |FINSI;
                  #dscam003#26 = "";
                  #dscam003#31 = #dscam003#31 + #dscaz009#8;  #dscam003#65 = #dscam003#65 + (#dscaz009#26 - #dscam004#24);
                  #dscam003#23 = #dscam003#30 - #dscaz009#8;  #dscam003#61 = #dscam003#61 - (#dscaz009#26 - #dscam004#24);
                  #dscam003#16 = #dscam003#16 + 1;
                  #dscam003#24 = #dscam003#24 + #dscaz009#15; #dscam003#62 = #dscam003#62 + (#dscaz009#15 * #dscaz009#33);
                  #dscam003#25 = #dscam003#25 + #dscaz009#18; #dscam003#63 = #dscam003#63 + (#dscaz009#18 * #dscaz009#33);
                  #dscam003#38 = #dscam003#38 + #dscaz009#19; #dscam003#66 = #dscam003#66 + (#dscaz009#19 * #dscaz009#33);

                  #dscam003#16 = #dscam003#16 + 1;

                  |SI #dscam003#23 = 0;
                     #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
                     #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
                     #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
                     #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);
                     #dscam003#31 = #dscam003#30 - #dscam003#23;  #dscam003#65 = #dscam003#64 - #dscam003#61;

                     #dscam003#14 = "p";
                     #dscam003#15 = "Entrega pdte.cobro";
                  |SINO;
                     #dscam003#14 = "e";
                     #dscam003#15 = "Pendiente de compensar";
                  |FINSI;
                  #dscam003#100 = "S";
                  |GRABA 020#dscam003.a; |LIBERA #dscam003;
               |FINSI;
            |SINO;
               ||.... pero si no, lo primero que tengo que hacer es buscar
               ||         el/los recibos con los que se compens¢ esta entrega
               ||         a cuenta y crearles el movimiento que anula dicha
               ||         compensacion.

               || Busco los movimientos REC y por cada uno escribo un ACA
               #dscam004#17 = #dscaz009#21;
               #dscam004#3  = 99;
               |LEE 000#dscam004.];
               |SI FSalida = 0;
                  |LEE 000#dscam004.a;
               |SINO;
                  |LEE 000#dscam004.u;
               |FINSI;
               |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscaz009#21; |HACIENDO;
                  |SI #dscam004#5 = "REM"; |SAL; |FINSI;
                  |SI #dscam004#5 = "REC";
                     aAlfa = #dscam004#16; |QBF aAlfa; aAlfa = aAlfa % -109;
                     nDocum = aAlfa; nImporteD = -#dscam004#8; nImporteB = -#dscam004#26;
                     |SALVA_FICHA #dscam003; |SALVA_FICHA #dscam004;
                     |HAZ DesSalda;
                     |REPON_FICHA #dscam003; |REPON_FICHA #dscam004;
                  |FINSI;
                  |LEE 000#dscam004.a;
               |SIGUE;

               || Hecho esto, tengo que crear el movimiento de impagado que en
               ||    la entrega a cuenta va asociado a la anulaci¢n de los
               ||    recibos compensados

               |DDEFECTO #dscam004;
               #dscam004#0  = #dscaz009#1;
               #dscam004#1  = #dscaz009#2;
               #dscam004#2  = #dscaz009#3;
               #dscam004#3  = LinCob;
               #dscam004#4  = #dscaz009#13;
               #dscam004#5  = "IME";
               #dscam004#6  = #dscaz009#14;
               #dscam003#40 = #dscaz009#21;
               |LEE 000#dscam003.=;
               |SI FSalida = 0;
                  #dscam004#7  = #dscam003#23; #dscam004#25 = #dscam003#61;
               |FINSI;
               #dscam004#8  = 0;             #dscam004#26 = 0;
               #dscam004#9  = #dscaz009#8;   #dscam004#27 = #dscaz009#26;
               #dscam004#10 = #dscaz009#15 + #dscaz009#19 + #dscaz009#18;
               #dscam004#11 = #dscaz009#16;
               #dscam004#12 = #dscaz009#15; #dscam004#29 = #dscaz009#28;
               #dscam004#13 = #dscaz009#18; #dscam004#30 = #dscaz009#29;
               #dscam004#14 = #dscaz009#19; #dscam004#31 = #dscaz009#30;
               #dscam004#15 = #dscaz009#20;
               #dscam004#17 = #dscaz009#21;

               #dscam004#24 = #dscaz009#8 * DifCambio;
               #dscam004#33 = #dscaz009#33;
               #dscam004#43 = nNumSec;
               #dscam004#51 = #dscam003#72;
               #dscam004#52 = #dscam003#70;
               #dscam004#53 = #dscam003#71;
               |GRABA 020#dscam004.n;

               eaUsuario = Usuario % 0810;
               eaTipoReg = "CB";  eaNumero = (("000000000" + #dscam004#17) % -109) + "/" + (("000" + #dscam004#3) % -103);
               eaDescr   = "ALTA IMPAGADO ENTREGA A CUENTA (" + (("000000000" + #dscam004#17) % -109) + "/" + (("000" + #dscam004#3) % -103);
               eaDescr   = eaDescr + ") DESDE CONTROL DE IMPAGADOS";
               eaTipoOp  = "A";
               enImpAnt = #dscam003#64; enImpAct = #dscam003#64 - #dscam004#9;
               |HAZ GrabaAudit;

               #dscam003#40 = #dscaz009#21;
               |LEE 101#dscam003.=;
               |SI FSalida = 0;
                  importeant = #dscam003#64;
                  #dscam003#56 = #dscam003#56 + (#dscaz009#8 * DifCambio);
                  #dscam003#26 = "";
                  #dscam003#55 = #dscam003#55 - #dscaz009#8;  #dscam003#68 = #dscam003#68 - (#dscaz009#26 - #dscam004#24);
                  #dscam003#31 = #dscam003#31 + #dscaz009#8;  #dscam003#65 = #dscam003#65 + (#dscaz009#26 - #dscam004#24);
                  #dscam003#30 = #dscam003#30 + #dscaz009#8;  #dscam003#64 = #dscam003#64 + (#dscaz009#26 - #dscam004#24);
                  #dscam003#16 = #dscam003#16 + 1;
                  #dscam003#24 = #dscam003#24 + #dscaz009#15; #dscam003#62 = #dscam003#62 + (#dscaz009#15 * #dscaz009#33);
                  #dscam003#25 = #dscam003#25 + #dscaz009#18; #dscam003#63 = #dscam003#63 + (#dscaz009#18 * #dscaz009#33);
                  #dscam003#38 = #dscam003#38 + #dscaz009#19; #dscam003#66 = #dscam003#66 + (#dscaz009#19 * #dscaz009#33);
/*
                  #dscam003#24 = #dscam003#24 + #dscaz009#15; #dscam003#62 = #dscam003#62 - (#dscaz009#15 * #dscaz009#33);
                  #dscam003#25 = #dscam003#25 + #dscaz009#18; #dscam003#63 = #dscam003#63 + #dscaz009#29;
                  #dscam003#38 = #dscam003#38 + #dscaz009#19; #dscam003#66 = #dscam003#66 + #dscaz009#30;
*/
                  #dscam003#23 = #dscam003#30 - #dscam003#31; #dscam003#61 = #dscam003#64 - #dscam003#65;
                  #dscam003#16 = #dscam003#16 + 1;

                  |SI #dscam003#23 = 0;
                     #dscam003#30 = #dscam003#22 + #dscam003#24 + #dscam003#25 + #dscam003#38;
                     #dscam003#30 = #dscam003#30 - (#dscam003#54 + #dscam003#55);
                     #dscam003#64 = #dscam003#60 + #dscam003#62 + #dscam003#63 + #dscam003#66 + #dscam003#56;
                     #dscam003#64 = #dscam003#64 - (#dscam003#67 + #dscam003#68);
                     #dscam003#31 = #dscam003#30 - #dscam003#23;  #dscam003#65 = #dscam003#64 - #dscam003#61;

                     #dscam003#14 = "p";
                     #dscam003#15 = "Entrega pdte.cobro";
                  |SINO;
                     #dscam003#14 = "e";
                     #dscam003#15 = "Pendiente de compensar";
                  |FINSI;
                  #dscam003#100 = "S";
                  |GRABA 020#dscam003.a; |LIBERA #dscam003;
               |FINSI;
            |FINSI;
         |FINSI;
      |FINSI;

      |HAZ EsOTP;
      |SI FSalida = 0;
          |HAZ InciOTP;
      |FINSI;

      |HAZ EsDiagram;
      |SI FSalida = 0;
         |DDEF aAlfa; |QBF aAlfa;
         aAlfa = aAlfa + "dscam176.mas";
         |CARGA_DEF aAlfa, dscam176@;
         |SI FSalida = 0;
            |DFICE aAlfa; |QBF aAlfa; |PATH_DAT #dscam176@#aAlfa#;
            aAlfa = "tg" + Usuario;   |NOME_DAT #dscam176@#aAlfa#;
            |ABRE #dscam176@;
            #dscam176@#0 = #dscaz009#21;
            |LEE 000#dscam176@.=;
            |SI FSalida = 0;
               #dscam003#40 = #dscaz009#21;
               |LEE 101#dscam003.=;
               |SI FSalida = 0;
                  aAlfa = "Gastos : " + #dscam176@#1;
                  #dscam003#36 = aAlfa
                  |GRABA 020#dscam003.a; |LIBERA #dscam003;
               |FINSI;
               |BORRA 020#dscam176@.a;
            |FINSI;
            |CIERRA #dscam176@; |DESCARGA_DEF #dscam176@;
         |FINSI;
      |FINSI;
   |FINSI;

   |ABRE #dscam051;
   |LEE 000#dscam051.p;
   |SI FSalida ! 0;
      |DDEFECTO #dscam051;
      |GRABA 020#dscam051.n;
      |LEE 000#dscam051.p;
   |FINSI;
   |CIERRA #dscam051;

   #dscaw140#0 = #dscaz009#21;
   |LEE 000#dscaw140.=;
   |SI FSalida = 0;
      |BORRA 020#dscaw140.a;
   |FINSI;

   |SI #dscam051#1 = "S"; |Y HayConta = 1; |Y #dscaz009#35 ! "    ";
      Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
      |NOME_DAT #10 Comodin;
      |DELINDEX #dscaw013; |ABRE #dscaw013;
      |SI #dscaz009#36 = 0;
         Linea = 1;
         #dscaw013#15 = #dscaz009#35; #dscaw013#0 = Linea;
         #dscaw013#13 = "dscam004";   #dscaw013#14 = 17;
         #dscaw013#5 = #dscam004#17;  #dscaw013#6 = #dscam004#17;
         #dscaw013#11 = "N";          #dscaw013#12 = 9;
         |GRABA 020#dscaw013.n;
         |LIBERA #dscaw013;
         Linea = Linea + 1;
         #dscaw013#15 = #dscaz009#35; #dscaw013#0 = Linea;
         #dscaw013#13 = "dscam004";   #dscaw013#14 = 3;
         #dscaw013#5 = #dscam004#3;   #dscaw013#6 = #dscam004#3;
         #dscaw013#11 = "N";          #dscaw013#12 = 3;
         |GRABA 020#dscaw013.n; |LIBERA #dscaw013;
         Linea = Linea + 1;
         #dscaw013#15 = #dscaz009#35; #dscaw013#0 = Linea;
         #dscaw013#13 = "dscam004";   #dscaw013#14 = 43;
         #dscaw013#5 = #dscam004#43;  #dscaw013#6 = #dscam004#43;
         #dscaw013#11 = "N";          #dscaw013#12 = 9;
         |GRABA 020#dscaw013.n; |LIBERA #dscaw013;
         Linea = Linea + 1;
         #dscaw013#15 = #dscaz009#35; #dscaw013#0 = Linea;
         #dscaw013#13 = "dscam004";   #dscaw013#14 = 6;
         #dscaw013#7 = #dscam004#6;   #dscaw013#8 = #dscam004#6;
         #dscaw013#11 = "F";          #dscaw013#12 = 10;
         |GRABA 020#dscaw013.n; |LIBERA #dscaw013;
         |CIERRA #dscaw013;

         Comodin = #dscaz009#35; |QBF Comodin;
         Comodin = "dscam033.tab;" + Comodin;

         |LIBERA #dscam003; |CIERRAT #dscam003;
         |LIBERA #dscam004; |CIERRAT #dscam004;
         |SUB_EJECUTA_NP Comodin;
         |ABRET #dscam003; |LEE 101#dscam003.=;
         |ABRET #dscam004; |LEE 101#dscam004.=;
         |DELINDEX #dscaw013;

         |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".dat"; |FBORRA aAlfa;
         |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ddx"; |FBORRA aAlfa;
         |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ixx"; |FBORRA aAlfa;
      |FINSI;
   |FINSI;

   |SI #dscam051#32 = "S";
      |SI aEntidad = aEnt1; |Y aNumero = aNum1;
         |SI aEntidad ! "    "; |O aNumero ! "          ";
            enSwPag = 1;
            eaTOperacion = "B"; eaTipoRecibo = "V"; enNumDocum = #dscaz009#21; |HAZ ProcesaTempo;
            |ACABA;
         |SINO;
            enSwPag = 0;
         |FINSI;
      |SINO;
         |SI aEnt1 ! "    "; |O aNum1 ! "          ";
            enSwPag = 1;
         |SINO;
            enSwPag = 0;
         |FINSI;
         aEntidad = aEnt1; aNumero = aNum1;
      |FINSI;

      |IMPRE 0;
      |SI FSalida ! 0; |ACABA; |FINSI;

      eaCodigo = #dscam003#32; eaTipoCod = "C"; aCuenta = #dscam003#5; |HAZ LeeDatos;

      Fecha = ~;
      Dia  = Fecha % 0102; Dia = ("00" + Dia) % -102;
      Mes  = Fecha % 0402; Mes = ("00" + Mes) % -102; |HAZ MesLetra; |QBF Mes;
      anyo = Fecha % -104;
      FecEmision = Dia + " de " + Mes + " de " + anyo;

      aInforme = "Carta encabezado de impagados"; |HAZ ObtenInforme;
      |INFOR aInforme;
      |SI FSalida ! 0; |ACABA; |FINSI;
      |PRINT;
      |PIEINF;
      |PRINT;
      |PIEINF;
      |FININF;

      |SI aEnt1 ! "          "; |O aNum1 ! "    ";
         enSwPag = 1;
         Comodin = #dscam003#79 - (#dscam003#62 + #dscam003#63);
      |SINO;
         enSwPag = 0;
         Comodin = importeant;
      |FINSI;

      |LETRA Comodin; |QBF Comodin;
      |SI #dscam003#57 = "ESP"; Comodin = Comodin + " PESETAS"; |FINSI;
      |SI #dscam003#57 = "EUR"; Comodin = Comodin + " EUROS";   |FINSI;
      Comodin1 = Comodin % 0151;
      |PARA nCont = 51; |SI nCont ] 1; |HACIENDO nCont = nCont - 1;
         Calc = (nCont * 100) + 1;
         Caracter = Comodin1 % Calc;
         |SI Caracter = " ";
            Calc = 100 + nCont;
            LetraImp1 = Comodin % Calc; LetraImp2 = Comodin - LetraImp1;
            |SAL;
         |FINSI;
      |SIGUE;

      aInforme = "Carta finalizacion impagados"; |HAZ ObtenInforme;
      |INFOR aInforme;
      |SI FSalida = 0; |Y aInforme ! "        ";
         SwFin = 0;
         |PRINT;
         |PIEINF;
         SwFin = 1;
         |PRINT; |PIEINF;
         |PRINT; |PIEINF;

         |FININF;
      |FINSI;
      |FINIMP;
   |FINSI;

   eaTOperacion = "B";
   eaTipoRecibo = "V";
   enNumDocum = #dscaz009#21;
   |HAZ ProcesaTempo;
|FPRC;

|DEFBUCLE Volcado;
#dscaz009#1;
;
INICIO;
FINAL;
;
NULL,Volcado;
|FIN;

|PROCESO MiraSec;
   #dscam003#40 = #dscaz009#21;
   |LEE 000#dscam003.=;
   |SI FSalida ! 0; |DDEFECTO #dscam003; |FINSI;

   |SI #dscam003#70 ! "          ";
/*
      |SELECT #2#dscaw043;
      #dscaw043#3 = #dscam003#72;
      #dscaw043#4 = #dscam003#70;
      #dscaw043#5 = #dscaz009#35;
      |LEE 000#dscaw043.=;
      FEstado = FSalida;
      |SELECT #1#dscaw043;
*/
      |SELECT #4#dscaw043;
      #dscaw043#2 = #dscaz009#13;
      #dscaw043#7 = #dscaz009#14;
      #dscaw043#8 = 0;
      |LEE 000#dscaw043.=;
      FEstado = FSalida;
      |SELECT #1#dscaw043;
   |SINO;
      |SELECT #3#dscaw043;
      #dscaw043#2 = #dscaz009#13;
      #dscaw043#3 = "    ";
      #dscaw043#4 = "          ";
      #dscaw043#5 = #dscaz009#35;
      #dscaw043#7 = #dscaz009#14;
      #dscaw043#8 = 0;
      |LEE 000#dscaw043.=;
      FEstado = FSalida;
      |SELECT #1#dscaw043;
   |FINSI;

/*
   |SELECT #3#dscaw043;
   #dscaw043#2 = #dscaz009#13;
   #dscaw043#3 = #dscam003#72;
   #dscaw043#4 = #dscam003#70;
   #dscaw043#5 = #dscaz009#35;
   #dscaw043#7 = #dscaz009#14;
   #dscaw043#8 = 0;
   |LEE 000#dscaw043.=;
   FEstado = FSalida;
   |SELECT #1#dscaw043;
*/
   |SI FEstado = 0;
      nNumSec = #dscaw043#6;
   |SINO;
      |SI nNumSec = 0;
         |SALVA_FICHA #dscam004;
         |SELECT #3#dscam004;
         |LEE 000#dscam004.u;
         |SI nNumSec [ #dscam004#43;
            nNumSec = #dscam004#43 + 1;
         |SINO;
            nNumSec = nNumSec + 1;
         |FINSI;
         |SELECT #1#dscam004;
         |LEE 000#dscam004.p; |REPON_FICHA #dscam004;
      |SINO;
         nNumSec = nNumSec + 1;
      |FINSI;
   |FINSI;

   |ABRE #dscam030;
   #dscam030#0 = #dscaz009#35;
   |LEE 000#dscam030.=;
   |SI FSalida = 0;
      |SI #dscam030#8 = "N";
         |SI #dscam003#70 = "          "; |Y #dscam003#72 = "    ";
            nNumSec = 0;
         |FINSI;
      |FINSI;
   |SINO;
      nNumSec = 0;
   |FINSI;
   |CIERRA #dscam030;

   |DDEFECTO #dscaw043;
   #dscaw043#0 = #dscaz009#0;
   #dscaw043#1 = #dscaz009#21;
   #dscaw043#2 = #dscaz009#13;
   #dscaw043#3 = #dscam003#72;
   #dscaw043#4 = #dscam003#70;
   #dscaw043#5 = #dscaz009#35;
   #dscaw043#6 = nNumSec;
   #dscaw043#7 = #dscaz009#14;
   #dscaw043#8 = 0;
   |GRABA 020#dscaw043.n;

   #dscaz009#36 = nNumSec; |GRABA 020#dscaz009.a;
|FPRC;

|DEFBUCLE MiraSec;
#dscaz009#1;
10;
00001,"*";
99999,"*";
;
NULL,MiraSec;
|FIN;

|PROCESO MarcaSec;
   #dscaw043#6 = -1; |GRABA 020#dscaw043.a;
|FPRC;

|DEFBUCLE MarcaSec;
#dscaw043#1;
6;
00001,nNumSec;
99999,nNumSec;
;
NULL,MarcaSec;
|FIN;

|PROCESO RellenaDatos;
   |SI #dscam003#14 ! "L"; |Y #dscam003#14 ! "C";
      |ACABA;
   |SINO;
      |SI #dscam003#17 = 0; |ACABA; |FINSI;
   |FINSI;

   |DDEFECTO #dscaz028;
   #dscaz028#0 = NumLinea;   NumLinea = NumLinea + 1;
   #dscaz028#1 = #dscam003#40;
   #dscaz028#2 = #dscam003#6;
   #dscaz028#3 = #dscam003#3;
   #dscaz028#4 = #dscam003#30;
   |GRABA 020#dscaz028.n;
|FPRC;

|DEFBUCLE RellenaDatos;
#dscam003#1;
51,3,30;
0000000001,#dscaz027#0,DFechaVto,#dscaz027#3;
9999999999,#dscaz027#0,HFechaVto,#dscaz027#3;
;
NULL,RellenaDatos;
|FIN;

|RUTINA inf1009;
   #dscaz028#0 = 01;
|FRUT;

|RUTINA sup1009;
   #dscaz028#0 = 99;
|FRUT;

|PROCESO CogeRecibo;
   #dscaz009#21 = #dscaz028#1;
   #dscaz009#6  = #dscaz028#2;
   #dscaz009#11 = #dscaz028#3;
   |PTEC 807;
|FPRC;

|PROCESO BuscaRecibo;
   |SI FSalida = 10;
      |PUSHV 0501 2380;
      |DELINDEX #dscaz028; |DDEFECTO #dscaz027;
      |ABRE #dscaz027; |ABRE #dscaz028;
      #dscaz027#2 = "          ";
      |PINPA #0#dscaz027; |PINDA #0#dscaz027;
      |ENTLINEAL #1#dscaz028,1,7,18,1,inf1009,sup1009;
      |ENDATOS #1#dscaz027;
      |SI FSalida = 0;
         Comodin = #dscaz027#2; |QBF Comodin;
         |SI Comodin ! "00.00.0000";
            DFechaVto = Comodin; HFechaVto = Comodin;
         |SINO;
            DFechaVto = "01.01.1900"; HFechaVto = "31.12.2999";
         |FINSI;
         |BUCLE RellenaDatos;
         |ENTLINEAL #1#dscaz028,1,4,18,1,inf1009,sup1009;
      |SINO;
         |ERROR;
      |FINSI;
      |CIERRA #dscaz028; |CIERRA #dscaz027;
      |POPV;
      |PINTA #dscaz009#21; |PINTA #dscaz009#6; |PINTA #dscaz009#11;
   |FINSI;
|FPRC;

|PROCESO Ti13; |TIPO 13;
   Divisa = #dscaz009#CmpDivisa#; |QBF Divisa; |HAZ Tipo13;
|FPRC;

|PROCESO MesLetra;
   |SI Mes = "01"; Mes = "Enero     "; |FINSI;
   |SI Mes = "02"; Mes = "Febrero   "; |FINSI;
   |SI Mes = "03"; Mes = "Marzo     "; |FINSI;
   |SI Mes = "04"; Mes = "Abril     "; |FINSI;
   |SI Mes = "05"; Mes = "Mayo      "; |FINSI;
   |SI Mes = "06"; Mes = "Junio     "; |FINSI;
   |SI Mes = "07"; Mes = "Julio     "; |FINSI;
   |SI Mes = "08"; Mes = "Agosto    "; |FINSI;
   |SI Mes = "09"; Mes = "Septiembre"; |FINSI;
   |SI Mes = "10"; Mes = "Octubre   "; |FINSI;
   |SI Mes = "11"; Mes = "Noviembre "; |FINSI;
   |SI Mes = "12"; Mes = "Diciembre "; |FINSI;
|FPRC;

|PROCESO LiberaFichas;
   eaTOperacion = "B"; eaTipoRecibo = "V"; enNumDocum = #dscaz009#21; |HAZ ProcesaTempo;
|FPRC;

|DEFBUCLE LiberaFichas;
#dscaz009#1;
10;
00001,"*";
99999,"*";
;
NULL,LiberaFichas;
|FIN;

|PROCESO VuelcaSec;
   |SI #dscaw043#6 ] 0;
      |SI #dscam051#1 = "S"; |Y HayConta = 1;
         || Compruebo que el enlace que voy a usar esta marcado por sesion.
         || Si no es asi , lo pongo y enlazo. Luego lo dejo como estaba.
         |ABRE #dscam030;
         #dscam030#0 = #dscaw043#5;
         |LEE 000#dscam030.=;
         |SI FSalida = 0;
            |SI #dscam030#8 = "N";
               nCambiaEnl = 1;
               #dscam030#8 = "S";
               |GRABA 020#dscam030.a;
            |SINO;
               nCambiaEnl = 0;
            |FINSI;
         |SINO;
            nNumSec = 0;
         |FINSI;
         |CIERRA #dscam030;

         Comodin = Usuario; |QBF Comodin; Comodin = "ac" + Comodin;
         |NOME_DAT #10 Comodin;
         |DELINDEX #dscaw013; |ABRE #dscaw013;
         #dscaw013#15 = #dscaw043#5;  #dscaw013#0  = 1;
         #dscaw013#13 = "dscam004";   #dscaw013#14 = 43;
         #dscaw013#5 = #dscaw043#6;   #dscaw013#6  = #dscaw043#6;
         #dscaw013#11 = "N";          #dscaw013#12 = 9;
         |GRABA 020#dscaw013.n; |LIBERA #dscaw013;
         #dscaw013#15 = #dscaw043#5;  #dscaw013#0 = 2;
         #dscaw013#13 = "dscam004";   #dscaw013#14 = 6;
         #dscaw013#7 = fFechaOpMenor; #dscaw013#8 = fFechaOpMayor;
         #dscaw013#11 = "F";          #dscaw013#12 = 10;
         |GRABA 020#dscaw013.n; |LIBERA #dscaw013;

         Comodin = #dscaw043#5; |QBF Comodin;
         Comodin = "dscam033.tab;" + Comodin;
         |LIBERA #dscam003; |CIERRAT #dscam003;
         |LIBERA #dscam004; |CIERRAT #dscam004;
         |SUB_EJECUTA_NP Comodin; |DELINDEX #dscaw013;
         |ABRET #dscam003; |LEE 101#dscam003.=;
         |ABRET #dscam004; |LEE 101#dscam004.=;

         |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".dat"; |FBORRA aAlfa;
         |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ddx"; |FBORRA aAlfa;
         |DFICE aAlfa; |QBF aAlfa; aAlfa = "ac" + Usuario + ".ixx"; |FBORRA aAlfa;

         |SI nCambiaEnl = 1;
            |ABRE #dscam030;
            #dscam030#0 = #dscaw043#5;
            |LEE 000#dscam030.=;
            |SI FSalida = 0;
               #dscam030#8 = "N";
               |GRABA 020#dscam030.a;
            |FINSI;
            |CIERRA #dscam030;
         |FINSI;
      |FINSI;

      nNumSec = #dscaw043#6;
      |SALVA_FICHA #dscaw043;
      |BUCLE MarcaSec;
      |LEE 000#dscaw043.p; |REPON_FICHA #dscaw043;
      |CIERRA #dscaw013;
   |FINSI;
|FPRC;

|DEFBUCLE VuelcaSec;
#dscaw043#1;
6;
00001,000000001;
99999,999999999;
;
NULL,VuelcaSec;
|FIN;

|PROCESO BorraObservm164;
   |BORRA 020#dscam219.a;
|FPRC;

|DEFBUCLE BorraObservm164;
#dscam219#1;
;
aAlfa, 001;
aAlfa, 999;
be;
NULL, BorraObservm164;
|FIN;

|PROCESO EliminaCambiosSit;
   |ABRE #dscam164;
   #dscam164#0 = #dscaw140#0;
   #dscam164#1 = #dscaw140#1;
   #dscam164#2 = #dscaw140#2;
   |LEE 000#dscam164.=;
   |SI FSalida = 0;
      #dscam004#17 = #dscam164#0;
      #dscam004#3 = #dscam164#8;
      |LEE 101#dscam004.=;
      |SI FSalida = 0; |Y #dscam004#5 = "CSI";
         |BORRA 020#dscam004.a;
      |FINSI;

      #dscam003#40 = #dscam164#0;
      |LEE 101#dscam003.=;
      |SI FSalida = 0;
         #dscam003#35 = #dscam164#3;
         #dscam003#36 = #dscam164#4;
         |SI #dscam164#9 ! "";
            |SI #dscam003#14 = "I"; |Y #dscam164#9 ! "I";
               #dscam003#16 = #dscam003#16 - 1;
            |FINSI;
            #dscam003#14 = #dscam164#9;
            #dscam003#15 = #dscam164#10;
         |SINO;
            |SI #dscam004#8 = 0; |Y #dscam004#9 ! 0; ||Es un impagado
               #dscam003#16 = #dscam003#16 - 1;
            |FINSI;
         |FINSI;
         |SI #dscam164#11 ! "01.01.0000";
            #dscam003#3 = #dscam164#11;
         |FINSI;
         aAlfa = (("0000000000" + #dscam164#0) % -110) + "/" + #dscam164#1 + "/" + #dscam164#2;
         |BUCLE BorraObservm164;
         |BORRA 020#dscam164.a;

         |GRABA 020#dscam003.a; |LIBERA #dscam003;
      |FINSI;
   |FINSI;
   |CIERRA #dscam164;
|FPRC;

|DEFBUCLE EliminaCambiosSit;
#dscaw140#1;
;
INICIO;
FINAL;
;
NULL, EliminaCambiosSit;

|FIN;

|PROGRAMA;

   |SI PARAMETRO ! ""; |HAZ GrabaExt; |ACABA; |FINSI;

   |CLS;
   |CABEZA "Control de cobros";

   |HAZ Tipo8;
   CmpDivisa = 31;
   nEsArimesa = 0; |HAZ EsArimesa; nEsArimesa = FSalida;

   |PINPA #0#0; |PINDA #0#0;

   Empresa = #48#0;

   |MENU menu;
   Opcion = FSalida;
   |SI Opcion < 1; |O Opcion > 6; |ACABA; |FINSI;

   Comodin = "ci" + Usuario; |NOME_DAT #0 Comodin;
   |DELINDEX #dscaz009;
   |ABRE #dscaz009;

   aAlfa = "tcs" + Usuario; |NOME_DAT #dscaw140#aAlfa#;
   |DELINDEX #dscaw140; |ABRE #dscaw140;

   |ABRE #dscam051;
   |LEE 000#dscam051.p;
   |SI FSalida ! 0;
      |DDEFECTO #dscam051;
      |GRABA 020#dscam051.n;
   |FINSI;

   |ABRE #dscam003;
   |ABRE #dscam004;
   |ABRE #dscam066;

   |SI Opcion = 2;
      |C_V #dscaz009#11,1,"S";
      |C_V #dscaz009#12,1,"N";
      |C_P #dscaz009#11,1,1246;
      |C_P #dscaz009#12,1,1146;
      |PINTA 1050, "Vto";
      |BUCLE Vencimiento;
   |FINSI;
   |SI Opcion = 3;
      |C_V #dscaz009#11,1,"N";
      |C_V #dscaz009#12,1,"S";
      |C_P #dscaz009#11,1,1146;
      |C_P #dscaz009#12,1,1246;
      |PINTA 1050, "Emi";
      |BUCLE Emision;
   |FINSI;
   |SI Opcion = 4; |BUCLE Cliente;        |FINSI;
   |SI Opcion = 5; |HAZ BucleAcotadoRec;  |FINSI;
   |SI Opcion = 6; |HAZ BucleAcotadoPag;  |FINSI;
/*
   |PTEC 809; |PTEC 809; |PTEC 809; |PTEC 809; |PTEC 809; |PTEC 809; |PTEC 809;
   |PTEC 809; |PTEC 809; |PTEC 809; |PTEC 809; |PTEC 809; |PTEC 809; |PTEC 809;
*/
   |PTEC 815; |PTEC 814;

   |ENTLINEAL #1#dscaz009,1,1,20,1,inf009,sup009;
   aEntidad = ""; aNumero = "";

   |SI HaySelec > 0;
      |ATRI R;
      |CONFI "0400N¿ Conforme con los datos introducidos ? ";
      |SI FSalida = 0;

         |SUB_EJECUTA_NP "dscaz169.tab;INICIO";

         aAlfa = ("43" + Usuario + "zzzzzzzz") % 0108; |NOME_DAT #dscaw043#aAlfa#;
         |DELINDEX #dscaw043; |ABRE #dscaw043;
         fFechaOpMenor = "31.12.9999"; fFechaOpMayor = "01.01.0000";
         |BUCLE MiraSec;
         |BUCLE Volcado;
         |BUCLE VuelcaSec;
         |CIERRA #dscaw043;

         |SUB_EJECUTA_NP "dscaz169.tab;FINAL";
      |FINSI;
      |BUCLE LiberaFichas;
      |ATRI N;
   |FINSI;

   eaSesion   = Usuario; |HAZ LimpiaTempo;
   |HAZ EsArtenvas;
   |SI FSalida = 0;
      |BUCLE EliminaCambiosSit;
   |FINSI;

   |CIERRA #dscaw140; |DELINDEX #dscaw140;

   |CIERRA #dscam066;
   |CIERRA #dscam004;
   |CIERRA #dscam003;
   |CIERRA #dscam051;
   |CIERRA #dscaz009;

   |HAZ Tipo9;
|FPRO;

|PROCESO GrabaExt;
   |HAZ Tipo8; CmpDivisa = 31;
   nEsArimesa = 0; |HAZ EsArimesa; nEsArimesa = FSalida;

   aAlfa = PARAMETRO;
   aAlfa1 = aAlfa - ":";
   nCalc = ((FSalida / 100) ! 0) + 99; aSerie   = aAlfa % nCalc;
   nCalc = FSalida + 198;               aAlfa    = aAlfa % nCalc;
   aAlfa1 = aAlfa - ":";
   nCalc = ((FSalida / 100) ! 0) + 99; aAlfa2   = aAlfa % nCalc; nFactura = aAlfa2;
   nCalc = FSalida + 198;               aAlfa    = aAlfa % nCalc;
   aAlfa1 = aAlfa - ":";
   nCalc = ((FSalida / 100) ! 0) + 99; aAlfa2   = aAlfa % nCalc; nRecibo  = aAlfa2;
   nCalc = FSalida + 198;               aAlfa    = aAlfa % nCalc;
   aAlfa1 = aAlfa - ":";
   nCalc = ((FSalida / 100) ! 0) + 99; aAlfa2   = aAlfa % nCalc; fFecha = aAlfa2;
   nCalc = FSalida + 198;               aAlfa    = aAlfa % nCalc;
   aAlfa1 = aAlfa - ":";
   nCalc = ((FSalida / 100) ! 0) + 99; aAlfa2   = aAlfa % nCalc; nImporte = aAlfa2;
   nCalc = FSalida + 198;               aAlfa    = aAlfa % nCalc;
   aAlfa1 = aAlfa - ":";
   nCalc = ((FSalida / 100) ! 0) + 99; aAlfa2   = aAlfa % nCalc; fFecCob  = aAlfa2;
   nCalc = FSalida + 198;               aAlfa2   = aAlfa % nCalc; nEmpGest = aAlfa2;

   |DFICB aAlfa; |QBF aAlfa;
   |PATH_DAT #dscam045#aAlfa#; |ABRE #dscam045;
   #dscam045#0 = nEmpGest;
   #dscam045#1 = 1;
   |LEE 000#dscam045.];
   |PARA; |SI FSalida = 0; |Y #dscam045#0 = nEmpGest; |HACIENDO;
      |SI #dscam045#4 [ aSerie; |Y #dscam045#5 ] aSerie; Empresa = #dscam045#6; |SAL; |FINSI;
   |SIGUE;
   |CIERRA #dscam045;

   |DFICB aAlfa; |QBF aAlfa; aAlfa = aAlfa + (("00000" + Empresa) % -105) + "/";

   |PATH_DAT #dscaz009#aAlfa#; |PATH_DAT #dscam003#aAlfa#;
   |PATH_DAT #dscam004#aAlfa#; |PATH_DAT #dscam066#aAlfa#;
   |PATH_DAT #dscam051#aAlfa#;

   Comodin = "ci" + Usuario; |NOME_DAT #0 Comodin;
   |DELINDEX #dscaz009; |ABRE #dscaz009;

   |ABRE #dscam051;
   |LEE 101#dscam051.p;
   |SI FSalida ! 0;
      |DDEFECTO #dscam051;
      |GRABA 020#dscam051.c;
   |FINSI;
   aValAnt = #dscam051#32;
   #dscam051#32 = "N";
   |GRABA 020#dscam051.a; |LIBERA #dscam051;
   |CIERRA #dscam051;

   |ABRE #dscam003; |ABRE #dscam004; |ABRE #dscam066;

   |SELECT #6#dscam003;
   |DDEFECTO #dscam003;
   #dscam003#0 = aSerie;
   #dscam003#1 = nFactura;
   #dscam003#2 = nRecibo;
   |LEE 000#dscam003.];
   |PARA; |SI FSalida = 0; |Y #dscam003#0 = aSerie; |Y #dscam003#1 = nFactura; |Y #dscam003#2 = nRecibo; |HACIENDO;
      |SI fFecha = #dscam003#4; |SAL; |FINSI;
      |LEE 000#dscam003.s;
   |SIGUE;
   |SI FSalida = 0; |Y #dscam003#0 = aSerie; |Y #dscam003#1 = nFactura;
    |Y #dscam003#2 = nRecibo; |Y fFecha = #dscam003#4; |Y #dscam003#14 = "I";
      |DDEFECTO #dscaz009;
      #dscaz009#0  = 1;
      #dscaz009#1  = aSerie;
      #dscaz009#2  = nFactura;
      #dscaz009#3  = nRecibo;
      #dscaz009#4  = #dscam003#5;
      #dscaz009#5  = #dscam003#32;
      #dscaz009#6  = #dscam003#6;
      #dscaz009#7  = #dscam003#23;
      #dscaz009#8  = nImporte;
      #dscaz009#9  = #dscam003#30;
      #dscaz009#10 = "*";
      #dscaz009#11 = #dscam003#3;
      #dscaz009#12 = #dscam003#4;
      #dscaz009#13 = #dscam051#4;
      #dscaz009#14 = fFecCob;
      #dscaz009#15 = 0;
      #dscaz009#16 = #dscam003#13;
      #dscaz009#17 = #dscam003#12;
      #dscaz009#20 = #dscam003#27;
      #dscaz009#21 = #dscam003#40;
      #dscaz009#22 = #dscam003#44;
      #dscaz009#23 = #dscam003#45;
      #dscaz009#24 = #dscam003#46;
      #dscaz009#25 = #dscaz009#7;
      #dscaz009#26 = #dscaz009#8;
      #dscaz009#27 = #dscaz009#9;
      #dscaz009#28 = 0;
      #dscaz009#29 = 0;
      #dscaz009#31 = "EUR";
      #dscaz009#32 = "EURO";
      #dscaz009#33 = 1;
      #dscaz009#34 = 1;
      #dscaz009#35 = #dscam051#23;
      |GRABA 020#dscaz009.c;

      aAlfa = ("43" + Usuario + "zzzzzzzz") % 0108; |NOME_DAT #dscaw043#aAlfa#;
      |DELINDEX #dscaw043; |ABRE #dscaw043;
      |HAZ Volcado;
      |CIERRA #dscaw043;
   |FINSI;
   |BUCLE LiberaFichas;

   |ABRE #dscam051;
   |LEE 101#dscam051.p;
   |SI FSalida = 0;
      #dscam051#32 = aValAnt;
      |GRABA 020#dscam051.a; |LIBERA #dscam051;
   |FINSI;

   |CIERRA #dscam066; |CIERRA #dscam004; |CIERRA #dscam003;
   |CIERRA #dscaz009; |CIERRA #dscam051;

   |HAZ EsDiagram;
   |SI FSalida = 0;
      |DDEF aAlfa; |QBF aAlfa;
      aAlfa = aAlfa + "dscam176.mas";
      |CARGA_DEF aAlfa, dscam176@;
      |SI FSalida = 0;
         |DFICE aAlfa; |QBF aAlfa; |PATH_DAT #dscam176@#aAlfa#;
         aAlfa = "tg" + Usuario; |NOME_DAT #dscam176@#aAlfa#;
         |DELINDEX #dscam176@; |DESCARGA_DEF #dscam176@;
      |FINSI;
   |FINSI;

   |HAZ Tipo9;
|FPRC;

|PROCESO DescuentoAutomatico;
   |HAZ Tipo9;
   aAlfa = "dscaz017.tab;#" + (("00000" + #dscam003#17) % -105) + (("000" + #dscam003#37)% -103) + #dscam013#6;
   |SUB_EJECUTA aAlfa;
   |HAZ Tipo8;
|FPRC;

|PROCESO Puntos; |TIPO 6;
   nTecla = FSalida;
   aAlfa = #Fichero@#Campo#; |QBF aAlfa;
   aAlfa = aAlfa - ".";
   |PARA; |SI FSalida ! 0; |HACIENDO;
      nCalc = ((FSalida / 100) ! 0) + 99; aAlfa1 = aAlfa % nCalc;
      nCalc = FSalida + 98;               aAlfa2 = aAlfa % nCalc;
      aAlfa = aAlfa1 + aAlfa2; |QBF aAlfa;
      aAlfa = aAlfa % 0; nCalc = aAlfa;
      nCalc = MaxDigit - nCalc; |SI nCalc < 0; nCalc = 0; |FINSI;
      aAlfa = "0" * nCalc;
      aAlfa = aAlfa1 + aAlfa + aAlfa2;

      aAlfa = aAlfa - ".";
   |SIGUE;

   #Fichero@#Campo# = aAlfa; |PINTA #Fichero@#Campo#;
   FSalida = nTecla;
|FPRC;

|PROCESO ConsultaCtas;
   #Referen@#0 = #dscaw211#0;
   |LEE 000#Referen@.];
   |CONSULTA_CLAVE #1#Referen@;
   |SI FSalida = 0;
      #dscaw211#0 = #Referen@#0; |PINTA #dscaw211#0;
      #dscaw211#4 = #Referen@#2; |PINTA #dscaw211#4;
   |FINSI;
|FPRC;

|PROCESO CompruebaCta;
   |SI FSalida = 10; |HAZ ConsultaCtas; |ERROR; |ACABA; |FINSI;

   #Referen@#0 = #dscaw211#0;
   |LEE 000#Referen@.=;
   |SI FSalida ! 0;
      |MENAV "    Cuenta inexistente"; |ERROR;
   |SINO;
      #dscaw211#0 = #Referen@#0; |PINTA #dscaw211#0;
      #dscaw211#4 = #Referen@#2; |PINTA #dscaw211#4;
   |FINSI;
|FPRC;

|PROCESO MarcaLin;
   nContLineas = nContLineas + 1;

   #dscaz009#13 = #dscaw211#0;
   #dscaz009#14 = #dscaw211#1;
   #dscaz009#35 = #dscaw211#2;
   |SI nContLineas < nCuentaLineas;
      nCalc = ((#dscaz009#9 * #dscaw211#3) / nTotalImporte) ! 2;
   |SINO;
      nCalc = #dscaw211#3 - nTotalGtos;
   |FINSI;
   #dscaz009#18 = nCalc;
   nTotalGtos = nTotalGtos + nCalc;
   #dscaz009#29 = #dscaz009#18 / #dscaz009#34;

   |GRABA 020#dscaz009.a;
|FPRC;

|DEFBUCLE MarcaLin;
#dscaz009#1;
10;
00001, "*";
99999, "*";
;
NULL, MarcaLin;
|FIN;

|PROCESO CuentaLin;
   nCuentaLineas = nCuentaLineas + 1;
   nTotalImporte = nTotalImporte + #dscaz009#9;
|FPRC;

|DEFBUCLE CuentaLin;
#dscaz009#1;
10;
00001, "*";
99999, "*";
;
NULL, CuentaLin;
|FIN;

|PROCESO PideDatos;
   |SI HaySelec = 0;
      |MENAV "    No hay recibos marcados";
      |ACABA;
   |FINSI;

   nSwCambia = 0;
   #dscaw211#0 = #dscaz009#13;
   #dscaw211#1 = #dscaz009#14;
   #dscaw211#2 = #dscaz009#35;
   #dscaw211#3 = #dscaz009#18;

   |PUSHV 0501 2380;
   |PINPA #0#dscaw211; |PINDA #0#dscaw211;

   aAlfa = #48#16; |QBF aAlfa;
   aAlfa = aAlfa + "def/cacuenta.mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida = 0;
      aAlfa = #48#16; |QBF aAlfa;
      aAlfa = aAlfa + "fich/" + (("00000" + #48#14) % -105) + #48#19 + "/";
      |PATH_DAT #Referen@#aAlfa#;
      |ABRE #Referen@;

      #Referen@#0 = #dscaw211#0;
      |LEE 000#Referen@.=;
      |SI FSalida ! 0; |DDEFECTO #Referen@; |FINSI;
      #dscaw211#4 = #Referen@#2; |PINTA #dscaw211#4;

      |ENDATOS #1#dscaw211;
      |SI FSalida = 0;
         #dscaw211#4 = #Referen@#2; |PINTA #dscaw211#4;

         nSwCambia = 1;
         |SALVA_FICHA #dscaz009;
         nTotalImporte = 0;
         nCuentaLineas = 0; |BUCLE CuentaLin;
         |SI nCuentaLineas = 1;
            nImpGtos = #dscaw211#3;
         |SINO;
            nImpGtos = (#dscaw211#3 / nCuentaLineas) ! 2;
         |FINSI;
         nTotalGtos = 0; nContGtos = 0; |BUCLE MarcaLin;
         |REPON_FICHA #dscaz009;
      |SINO;
         |MENAV "    Proceso cancelado";
      |FINSI;
      |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
   |FINSI;
   |POPV;

   |SI nSwCambia = 1; |PONCONTROL 23, "si"; |FINSI;
|FPRC;

|PROCESO RelRecibos; |TIPO 66;
   |CONSULTA_CLAVE #1#dscam003;
   |SI FSalida = 0;
      #dscaz009#21 = #dscam003#40; |PINTA #dscaz009#21;
   |FINSI;
   |ERROR; |ACABA;
|FPRC;

|PROCESO Consu0; |TIPO 66;
     |CONSULTA_CLAVE #1#0;
|FPRC;
