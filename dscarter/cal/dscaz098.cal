|FICHEROS;
   dscaz098 #0;

   dscam003 #10;
   dscam004 #11;
   dscam013 #12;
   dscam067 #13;
   dscam017 #14;
   dscam067 #67;
   Referen@ #100;
|FIN;

|VARIABLES;
   nEmpresa = 0;

   aAlfa    = "";
   aAlfa1   = "";
   aAlfa2   = "";

   aOrigen  = "";
   aDestino = "";

   nCont    = 0;
   nCalc    = 0;
   nCalc1   = 0;
   nSwError = 0;
   nNumDoc  = 0;

   fFecha = @;
   aClave1 = "";
   aClave2 = "";
   aClave3 = "";
|FIN;

|PROCESO BorHisEnlace;
     #dscam067#0  = "CB";
     #dscam067#1 = #dscam004#17;
     #dscam067#2 = #dscam004#3;
     #dscam067#3 = "";
     #dscam067#11 = 1;
     #dscam067#8 = 0;
     #dscam067#9 = 0;
     aClave1 = #dscam067#1; aClave2 = #dscam067#2;
     aClave3 = #dscam067#3; |QBF aClave3;
     |LEE 000#dscam067.];
     |PARA; |SI FSalida = 0; |Y #dscam067#0 = "CB"; |Y #dscam067#1 = aClave1;
               |Y #dscam067#2 = aClave2; |Y aClave3 = ""; |HACIENDO;
          |BORRA 020#dscam067.a;
          |LIBERA #dscam067;
          |LEE 101#dscam067.s;
          aClave1 = #dscam067#1; aClave2 = #dscam067#2;
          aClave3 = #dscam067#3; |QBF aClave3;
     |SIGUE;
     |LIBERA #dscam067;
|FPRC;

|PROCESO PideEmpCopia;
   |DDEF aAlfa; |QBF aAlfa;
   aAlfa = aAlfa + "dscam005.mas";
   |CARGA_DEF aAlfa, Referen@;
   |SI FSalida ! 0;
      |MENAV "    No encuentro el fichero de empresas de cartera";
      |ERROR; |ACABA;
   |FINSI;

   |DFICB aAlfa; |QBF aAlfa;
   |PATH_DAT #Referen@#aAlfa#;
   |ABRE #Referen@;

   |PUSHV 0501 2380;
   |BLANCO 1009 1471;
   |CUADRO 1110 1370;
   |ATRI R; |PINTA 1111, " Introduzca el codigo de la empresa destino "; |ATRI N;
   |PINTA 1212, "Empresa : ";
   |PARA; |SI FSalida = 0; |HACIENDO;
      |ET OtraVez;
      |MENSA "    <F2> Consulta empresas ";
      |PINTA 1229, #Referen@#1;
      E_sup = 99999; E_inf = 0;
      nEmpresa = 1222 ? 1;
      |SI FSalida = 0; |Y nEmpresa ! #48#0;
         #Referen@#0 = nEmpresa;
         |LEE 000#Referen@.=;
         |SI FSalida ! 0;
            aAlfa = "    NLa empresa seleccionada no existe. " + &191 + " Crearla ? ";
            |CONFI aAlfa;
            |SI FSalida = 0;
               |DDEFECTO #Referen@;
               #Referen@#0 = nEmpresa;
               aAlfa = "Copia empresa " + #48#1; |QBF aAlfa;
               #Referen@#1 = aAlfa;
               aAlfa = "|NC"; aAlfa = #Referen@#aAlfa#;
               nCalc = aAlfa; nCalc = nCalc - 1;
               |PARA nCont = 2; |SI nCont [ nCalc; |HACIENDO nCont = nCont + 1;
                  #Referen@#nCont# = #48#nCont#;
               |SIGUE;
               #Referen@#18 = "~~~~~~~~~~";
               |GRABA 020#Referen@.n;
               |DFICB aAlfa; |QBF aAlfa;
               aAlfa = aAlfa + (("00000" + nEmpresa) % -105) + "/";
               |MKDIR aAlfa;
            |SINO;
               nSwError = -1;
               |MENAV "     Proceso cancelado "; |SAL;
            |FINSI;
         |SINO;
            aAlfa = "     NSe sobreescribirán los datos de la empresa seleccionada. " + &191 + " Continuar ? ";
            |CONFI aAlfa;
            |SI FSalida ! 0;
               nSwError = -1;
               |MENAV "     Proceso cancelado "; |SAL;
            |FINSI;
         |FINSI;

         |DFICE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "*";
         |_PDIR aAlfa;
         |PARA; |SI FSalida = 0; |HACIENDO;
            aAlfa1   = "";
            aOrigen  = aAlfa;
            aDestino = aAlfa;
            aAlfa2   = aDestino % -101;
            |PARA nCalc = 2; |SI aAlfa2 ! "/"; |HACIENDO nCalc = nCalc + 1;
               aAlfa1 = aAlfa2 + aAlfa1;
               nCalc1 = 0 - ((nCalc * 100) + 1);
               aAlfa2 = aDestino % nCalc1;
            |SIGUE;
            |DFICB aDestino; |QBF aDestino;
            aDestino = aDestino + (("00000" + nEmpresa) % -105) + "/";
            aDestino = aDestino + aAlfa1;
            |COPIA_FICHERO aOrigen, aDestino;
            aAlfa1 = " Copiando fichero " + aOrigen + " a la empresa destino";
            |ATRI I; |PINTA 2301, aAlfa1; |ATRI N;
            |_SDIR aAlfa;
         |SIGUE;
      |SINO;
         |SI FSalida = 10;
            |CONSULTA_CLAVE #1#Referen@;
            |SI FSalida = 0;
               nEmpresa = #Referen@#0;
               |PINTA 1229, #Referen@#1;
            |FINSI;
            FSalida = 10;
            |VETE OtraVez;
         |SINO;
            |SI nEmpresa ! #48#0;
               nSwError = -1;
               |MENAV "     Proceso cancelado "; |SAL;
            |SINO;
               |MENAV "     La empresa origen y destino no pueden ser la misma";
            |FINSI;
         |FINSI;
      |FINSI;
   |SIGUE;

   |BLIN 4;
   |POPV;

   |CIERRA #Referen@; |DESCARGA_DEF #Referen@;
|FPRC;

|PROCESO Documentos;
   nSwError = -1;
   #dscam004#17 = #dscam003#40 + 1;
   #dscam004#3  = 1;
   |LEE 000#dscam004.];
   |SI FSalida = 0;
      |LEE 000#dscam004.a;
   |SINO;
      |LEE 000#dscam004.u;
   |FINSI;
   |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
      nSwError = 0;
      |SI #dscam004#6 [ #dscaz098#0;
         #dscam013#16 = #dscam004#17;
         #dscam013#24 = 1;
         |LEE 000#dscam013.];
         |PARA; |SI FSalida = 0; |Y #dscam013#16 = #dscam004#17; |HACIENDO;
            |SI #dscam013#15 = "N"; nSwError = -1; |SAL; |FINSI;
            |LEE 000#dscam013.s;
         |SIGUE;
         |SI nSwError = -1; |SAL; |FINSI;
      |SINO;
         nSwError = -1;
      |FINSI;
      |LEE 000#dscam004.s;
   |SIGUE;

   |SI nSwError = 0;
      #dscam013#16 = #dscam003#40;
      #dscam013#24 = 1;
      |LEE 101#dscam013.];
      |PARA; |SI FSalida = 0; |Y #dscam013#16 = #dscam003#40; |HACIENDO;
         |BORRA 020#dscam013.a;
         |LIBERA #dscam013;
         |LEE 101#dscam013.s;
      |SIGUE;

      #dscam004#17 = #dscam003#40;
      #dscam004#3  = 1;
      |LEE 101#dscam004.];
      |PARA; |SI FSalida = 0; |Y #dscam004#17 = #dscam003#40; |HACIENDO;
         |DDEFECTO #dscam067;
         #dscam067#0 = "CB";
         #dscam067#1 = #dscam004#17; aAlfa  = #dscam067#1;
         #dscam067#2 = #dscam004#3;  aAlfa1 = #dscam067#2;
         |LEE 101#dscam067.];
         |PARA; |SI FSalida = 0; |Y #dscam067#1 = aAlfa; |Y #dscam067#2 = aAlfa1; |HACIENDO;
            |BORRA 020#dscam067.a;
            |LIBERA #dscam067;
            |LEE 101#dscam067.s;
         |SIGUE;

         |BORRA 020#dscam004.a; |LIBERA #dscam004;
         |HAZ BorHisEnlace;
         |LEE 101#dscam004.s;
      |SIGUE;
      |LIBERA #dscam004;

      #dscam017#9 = #dscam003#40;
      |LEE 101#dscam017.];
      |PARA; |SI FSalida = 0; |Y #dscam017#9 = #dscam003#40; |HACIENDO;
         |BORRA 020#dscam017.a;
         |LIBERA #dscam017;
         |LEE 101#dscam017.s;
      |SIGUE;

      |BORRA 020#dscam003.a;
      |LIBERA #dscam003;
   |FINSI;
|FPRC;

|DEFBUCLE Documentos;
#dscam003#10;
;
"L", 0000000001, 00000, "  ", "00.00.0000";
"L", 9999999999, 99999, "zz", "31.12.9999";
be;
NULL,Documentos;
|FIN;

|PROCESO Borrado;
   |ABRE #dscam013; |SELECT #4#dscam013;
   |ABRE #dscam017; |SELECT #2#dscam017;
   |ABRE #dscam004;
   |BUCLE Documentos;
   |CIERRA #dscam004;
   |SELECT #1#dscam017; |CIERRA #dscam017;
   |SELECT #1#dscam013; |CIERRA #dscam013;
|FPRC;

|PROCESO Agrupados;
   nSwError = 0; nNumDoc = #dscam003#41;
   |SALVA_FICHA #dscam003;
   |SELECT #1#dscam003;
   #dscam003#40 = nNumDoc;
   |LEE 000#dscam003.=;
   |SI FSalida = 0; nSwError = 1; |FINSI;
   |SELECT #10#dscam003;
   |REPON_FICHA #dscam003;
   |SI nSwError = 0;
      |BORRA 020#dscam003.a; |LIBERA #dscam003;
   |FINSI;
|FPRC;

|DEFBUCLE Agrupados;
#dscam003#10;
;
"A", 0000000001, 00000, "  ", "00.00.0000";
"A", 9999999999, 99999, "zz", "31.12.9999";
be;
NULL,Agrupados;
|FIN;

|PROCESO Divididos;
   nSwError = 1; nNumDoc = #dscam003#40;
   |SALVA_FICHA #dscam003;
   aAlfa = "SELECT * FROM dscam003 INTO us" + Usuario + " WHERE 83 == " + nNumDoc;
   |SQL aAlfa;
   aAlfa = FSalida;
   aAlfa = aAlfa - "Seleccionados:0";
   |SI FSalida ! 0; nSwError = 0; |FINSI;
   |REPON_FICHA #dscam003;

   |SI nSwError = 0; |BORRA 020#dscam003.a; |LIBERA #dscam003; |FINSI;
|FPRC;

|DEFBUCLE Divididos;
#dscam003#10;
;
"D", 0000000001, 00000, "  ", "00.00.0000";
"D", 9999999999, 99999, "zz", "31.12.9999";
be;
NULL,Divididos;
|FIN;

|PROCESO PurgaAgrDiv;
   |ABRE #dscam013; |SELECT #4#dscam013;
   |ABRE #dscam017; |SELECT #2#dscam017;
   |BLIN 23;
   |ATRI I; |PINTA 2301, " Purgando documentos agrupados "; |ATRI N;
   |BUCLE Agrupados;
   |BLIN 23;
   |ATRI I; |PINTA 2301, " Purgando documentos divididos "; |ATRI N;
   |BUCLE Divididos;
   |SELECT #1#dscam017; |CIERRA #dscam017;
   |SELECT #1#dscam013; |CIERRA #dscam013;
|FPRC;

|PROCESO MiraFecha;
   fFecha = ~; nCalc = fFecha; nCalc = nCalc - 180; fFecha = nCalc;
   |SI fFecha < #dscaz098#0;
      |MENAV "    Deben haber pasado al menos 6 meses para eliminar documentos liquidados";
      #dscaz098#0 = fFecha; |ERROR;
   |FINSI;
|FPRC;

|PROGRAMA
   |CLS;
   |CABEZA "Borrado datos liquidados de cartera";
   |PINPA #0#0; |PINDA #0#0;
   |ENDATOS #1#0;
   |SI FSalida = 0;
      |HAZ PideEmpCopia;
      |SI nSwError = 0;
         aAlfa = "    NSe va a proceder a borrar los documentos liquidados hasta la fecha " + #dscaz098#0; |QBF aAlfa;
         aAlfa = aAlfa + &191 + " Continuar ?";
         |CONFI aAlfa;
         |SI FSalida = 0;
            |ABRE #dscam067;
            |HAZ Borrado;
            |HAZ PurgaAgrDiv;
            |CIERRA #dscam067;
         |FINSI;
      |FINSI;
   |FINSI;
|FPRO;
