|FICHEROS;
     nomlogca;          || log incidencias calculo de la nomina Cabs.
     nomlogli;          || log incidencias calculo de la nomina Lins.
     nomincid;          || fichero de incidencias
     labempre;
     labtraba;
     labtracu;
     nomcalcu;
     nomconst;
     gomcotiz;
     nompanta;
     nombonif;
     nompagca;
     nompagli;
     nomcontr;
     nomepigr #2610;
     nomcnaec;
     nomocupa;
     labempre;
     labtraba;
     labcentr;
     nomcnama; || CNAEs por a¤os
     nomocuma; || ocupaciones por a¤os
     nomfical;
     nomtmcal #2611;
     labmunic;
     nompmail;

     labor001;
     gecom001@ #1000;
     gecom012@ #1012;
     gecom014@ #1014;
     nomcnahi;
     nomocuhi;

     gomcot12;
|FIN;

|VARIABLES;
     &nContLog = 0;
     &nNroErrores = 0;
     &nIncid = 0;
     &swIniLog = 0;
     &aDesIncid = "";
     &runnom = "";
     nNume = 0;
     aAlfa = "";
     &aCError = "";
     &nCConst = 0;
     &fCFecha = @;
     nModo = 0;
     &aParam = "";
     &fCFechaCot = @;
     &aCErrorCot = "";

     &nMes = 0;
     &nAny = 0;
     &nCodigoCons = 0;
     &swConsModif = 0;
     aCodigoCons = "";

     &swCambioDes = 0;
     &swCambioFOG = 0;
     aAlfa1 = "";
     aAlfa2 = "";
     aModulo = "";
     aMes = "";

     swCambioBon = 0;
     &nCodigoBon = 0;
     aCodigoBon = "";
     swBonModif = 0;

     &nTip = 0;
     &nEmpPag = 0;
     &nTraPag = 0;
     &nMesPag = 0;
     &nAnyPag = 0;
     &nTipPag = 0;
     &fFecPag = @;
     &aNorPag = "";
     &aRegPag = "";
     &nLiqEnlace = 0;
     &aDatosRec = "";
     &swSegPasada = 0;
     &swStop = 0;
     &liquipag = 0;
     &swDiosMio = 0;
     swCambio = 0;

     nTipoCuenta = 0;
     nBanco      = 0;
     aCuenta     = "";

     nClaveEpig = 0;
     nLon = 0;
     aLon = "";
     &aCNAE = "";
     &nEpigConv = 0;
     aAvisos = "";
     nNume1 = 0;
     nNume2 = 0;
     nNume3 = 0;
     &aCNAEEmp = "";
     &nElMes = 0;
     &nElAny = 0;

     aAny = "";
     aDia = "";
     aFecha = "";
     fFecha = @;
     FEstado = 0;
     &aTempEpig = "";
     &aCodPos = "";
     nPos1 = 0;
     nPos2 = 0;
     &nOpcionPLB = 0;
     aCodMuni = "";
     nCodMuni = 0;
     aNombreMuni = "";
     nCalc = 0;
     nCalc1 = 0;
     nCont = 0;
     nPos = 0;
     nAscii = 0;
     aCaracter = "";
     aCadena = "";
     aCaracterSal = "";
     aCadenaSal = "";
     aLongitud = "";
     nLongitud = 0;
     nBusca = 0;
     nCaracter = 0;
     aMiCaracter = "";
     nPorDonde = 0;
     aMensa = "";
     aEmp = "";
     aTra = "";
     aCen = "";
     swSigue = 0;
     swLocalizado = 0;
|FIN;

|PROCESO AvisaFich; |TIPO 7;
     |DBASE aAlfa;
     |QBF aAlfa;
     |SI aAlfa = "/u/dsprofes/laboral/";
          aAlfa = aAlfa + "fich/producci.ddx";
          aAlfa = "rb  " + aAlfa;
          |FABRE aAlfa;
          |SI FSalida < 0;
               |COLOR 1,7;
               |ATRI R;
               |PINTA 0556, "- FICHEROS CAMBIADOS -"
               |ATRI 0;
         |SINO;
               |FCIERRA FSalida;
         |FINSI;
     |FINSI;
|FPRC;


||****************************************************************************
||       GRABACION DE LOG DE INCIDENCIAS PRODUCIDAS DURANTE EL CALCULO
||****************************************************************************

|PROCESO ini_log;
     |SI swIniLog = 1; |O runnom = "nomcalir"; |O runnom = "nomcalfi";
     |O aParam = "AUTO"; |O aParam = "NOMVARCA"; |O runnom = "nomcalf1";
          |ACABA;
     |FINSI;
     |ABRE #nomlogca;
     |ABRE #nomlogli;
     |ABRE #nomincid;

     |LEE 000#nomlogca.u;
     |SI FSalida = 0;
          nContLog = #nomlogca#0;
          nContLog = nContLog + 1;
          #nomlogca#0 = nContLog;                 || contador
     |SINO;
          #nomlogca#0 = 1;
          nContLog = #nomlogca#0;
     |FINSI;
     #nomlogca#1 = Usuario % 0810;      || usuario
     #nomlogca#2 = ~;                   || fecha emision
     |HORA aAlfa;
     aAlfa = aAlfa % 105;
     #nomlogca#3 = aAlfa;                || hora emision
     #nomlogca#4 = nMes;                || mes
     nNume = nAny;
     #nomlogca#5 = nNume;               || a¤o
     #nomlogca#6 = 0;                   || nro. errores
     |GRABA 020#nomlogca.n;
     nNroErrores = #nomlogca#6;
     swIniLog = 1;
|FPRC;

|PROCESO lee_inc;
     |ABRE #nomincid;
     #nomincid#0 = nIncid;
     |LEE 000#nomincid.=;
     |CIERRA #nomincid;
|FPRC;

|PROCESO graba_inc;
     |SI runnom = "nomcalir"; |O runnom = "nomcalfi"; |O runnom = "nomvarca";
     |O aParam = "AUTO"; |O aParam = "NOMVARCA"; |O runnom = "nomcalf1";
     |O aParam = "NOMSICOS";
     |O swSegPasada = 1;
          |ACABA;
     |FINSI;
     |HAZ lee_inc;
     |SI nIncid ! 999; |Y aDesIncid = "";
          nNroErrores = nNroErrores + 1;
     |FINSI;
     |SI aDesIncid = "";
          aDesIncid = #nomincid#1;
     |FINSI;
     #nomlogli#0 = nContLog;
     #nomlogli#1 = #labempre#0;                || Empresa
     #nomlogli#2 = #labtraba#1;                || Trabajador
     #nomlogli#3 = nIncid;              || Nro. incidencia
     |QBF aDesIncid;
     |SI nIncid = 22;
          aDesIncid = aDesIncid + aDatosRec;
     |FINSI;
     |SI runnom = "nomcalat";
          |QBF aDesIncid;
          aMes = nElMes; aMes = ("00" + aMes) % -102;
          aDesIncid = aDesIncid + ": mes " + aMes;
     |FINSI;
     #nomlogli#4 = aDesIncid;
     #nomlogli#5 = nElMes;
     |SI runnom = "nomcalat";
          #nomlogli#6 = 5;
     |SINO;
          #nomlogli#6 = 0;
     |FINSI;
     |LEE 101#nomlogli.=;
     |SI FSalida = 0;
          |GRABA 020#nomlogli.a;
     |SINO;
          |GRABA 020#nomlogli.n;
     |FINSI;
     aDesIncid = "";
     |LIBERA #nomlogli;
|FPRC;

|PROCESO fin_log;
     |SI runnom = "nomcalir"; |O runnom = "nomcalfi"; |O runnom = "nomvarca";
     |O aParam = "AUTO"; |O aParam = "NOMVARCA"; |O runnom = "nomcalf1";
          |ACABA;
     |FINSI;
     #nomlogca#0 = nContLog;
     |LEE 101#nomlogca.=;
     |SI FSalida = 0;
          #nomlogca#6 = nNroErrores;
          |GRABA 020#nomlogca.a;
     |FINSI;
     |CIERRA #nomlogca;
     |CIERRA #nomlogli;
     |CIERRA #nomincid;
|FPRC;

|PROCESO ImprimeLog;
     |PRINT;
|FPRC;

|DEFBUCLE InformeLog;
     #nomlogli#1;
     ;
     #nomlogca#0, 00001, 00001, 001, 01, 0;
     #nomlogca#0, 99999, 99999, 999, 12, 9;
     ;
     NULL, ImprimeLog;
|FIN;

|PROCESO InformeLog;
     |IMPRE 0;
     |SI FSalida = 0;
          |INFOR "nomcalog";
          |BUCLE InformeLog;
          |PIEINF;
          |FININF;
          |FINIMP;
     |FINSI;
|FPRC;

|PROCESO CargaLog;
     |SUB_EJECUTA "nomlogca;calculo";
|FPRC;

||****************************************************************************
||                  PROCESO PARA LA CARGA DE LA CONSTANTE
||****************************************************************************

|PROCESO LeeCons;
     |ABRE #nomconst;
     #nomconst#0 = nCConst;
     #nomconst#79 = fCFecha;
     |LEE 000#nomconst.];
     |SI FSalida = 0;
          |SI fCFecha ! #nomconst#79; |O nCConst ! #nomconst#0;
               |LEE 000#nomconst.a;
          |FINSI;
     |SINO;
          |LEE 000#nomconst.u;
     |FINSI;
     |SI FSalida = 0;|Y #nomconst#0 = nCConst;
          aCError = "";       || todo correcto: constante encontrada
     |SINO;
          aCError = "    ATENCION: No existe Constante definida para el periodo";
          aCError = aCError + " que se esta calculando";
          || constante no encontrada
     |FINSI;

     |CIERRA #nomconst;

     |SI aCError = "";
          ||HAZ VerifCons;
     |FINSI;
|FPRC;

||****************************************************************************
||           PROCESO PARA LA CARGA DE COTIZACIONES EN AGRARIOS
||****************************************************************************

|PROCESO LeeCotAgr;
     |ABRE #gomcotiz;
     #gomcotiz#23 = fCFechaCot;
     |LEE 000#gomcotiz.];
     |SI FSalida = 0;
          |SI fCFechaCot ! #gomcotiz#23;
               |LEE 000#gomcotiz.a;
          |FINSI;
     |SINO;
          |LEE 000#gomcotiz.u;
     |FINSI;
     |SI FSalida = 0;
          aCErrorCot = "";       || todo correcto: constante encontrada
     |SINO;
          aCErrorCot = "    ATENCION: No existe Tabla de Cotizaciones definida para el periodo";
          aCErrorCot = aCErrorCot + " que se calcula";
          || constante no encontrada
     |FINSI;
     |CIERRA #gomcotiz;
|FPRC;

|PROCESO LeeRedMaxAgr;
     |ABRE #gomcot12;
     #gomcot12#0 = fCFechaCot;
     |LEE 000#gomcot12.];
     |SI FSalida = 0;
          |SI fCFechaCot ! #gomcot12#0;
               |LEE 000#gomcot12.a;
          |FINSI;
     |SINO;
          |LEE 000#gomcot12.u;
     |FINSI;
     |SI FSalida = 0;
          aCErrorCot = "";       || todo correcto: constante encontrada
     |SINO;
          aCErrorCot = "    ATENCION: No existe tabla de reducciones y máximos definida";
          aCErrorCot = aCErrorCot + " para el periodo que se calcula";
          || constante no encontrada
     |FINSI;
     |CIERRA #gomcot12;
|FPRC;

||****************************************************************************
||             PROCESO PARA CONFIRMACION DE BORRADO EN LINEAS
||****************************************************************************

|PROCESO confirma; |TIPO 2;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 3;
          |CONFI "     Esta seguro?";
          |SI FSalida ! 0;
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;

||****************************************************************************
||  PROCESOS PARA COMPROBACION DE PORCENTAJES DE DESEMPLEO POR EL RDL 5/2006
||****************************************************************************

|PROCESO CambioAct;
     || si no ha habido cambios es porque ya estan cambiados de antes, la fe-
     || cha de ultima revision debe ser 07/2008 para no dar lugar a errores
     || de que no te deje actualizar despues por detectar cambio de constante

     |SI swCambioDes = 0;
          || #nomconst#77 = 2006;
          || #nomconst#78 = 07;
          #nomconst#77 = 2008;
          #nomconst#78 = 07;
          |GRABA 020#nomconst.a;
          |LIBERA #nomconst;
     |FINSI;
|FPRC;

|PROCESO VerifCons;
     swCambioDes = 0;
     swCambioFOG = 0;

     nCodigoCons = nCConst;
     aAlfa = fCFecha;
     aAlfa = aAlfa % 402;
     nMes = aAlfa;
     aAlfa = fCFecha;
     aAlfa = aAlfa % -104;
     nAny = aAlfa;

     |SI nCodigoCons ] 500;
          swCambio = 0;
          |SI nAny ] 2009;
               swCambio = 1;
          |SINO;
               |SI nAny = 2008; |Y nMes ] 7;
                    swCambio = 1;
               |FINSI;
          |FINSI;
          |SI swCambio = 1;
               |SI #nomconst#12 = 5.75;      || tipo cotiz por DESEMPLEO al 5.75%
                    |SUB_EJECUTA "nomfan02;ACTUALIZACIONRL";
                    |HAZ LeeCons;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO VerifBonif;
|ACABA;
     swCambioBon = 0;
     aCodigoBon = nCodigoBon;
     aCodigoBon = "00" + aCodigoBon;
     aCodigoBon = aCodigoBon % -102;
     swBonModif = 0;

     |MODULO aModulo;
     |QBF aModulo;

     #nombonif#0 = nCodigoBon;
     |LEE 101#nombonif.=;
     |SI FSalida = 0;
          swCambio = 0;
          |SI nAny ] 2009;
               swCambio = 1;
          |SINO;
               |SI nAny = 2008; |Y nMes ] 7;
                    swCambio = 1;
               |FINSI;
          |FINSI;
          |SI swCambio = 1;
               |SI #nombonif#5 = 6.55;          || bonif. desempleo al 6.55% (des+FOG+FP)
                    swCambioBon = 1;
               |FINSI;
               |SI #nombonif#5 = 6.35;       || bonif. desempleo al 6.35% (des+FP)
                    swCambioBon = 2;
               |FINSI;
               |SI #nombonif#5 = 5.95;       || bonif. desempleo al 5.95% (Agrario des+FOG)
                    swCambioBon = 3;
               |FINSI;
               |SI #nombonif#5 = 5.75;       || bonif. desempleo al 5.75% (Agrario des.)
                    swCambioBon = 4;
               |FINSI;
          |SINO;
               |SI #nombonif#5 = 6.30;       || bonif. desempleo al 6.30% (des+FOG+FP)
                    swCambioBon = -1;
               |FINSI;
               |SI #nombonif#5 = 6.10;       || bonif. desempleo al 6.10% (des+FP)
                    swCambioBon = -2;
               |FINSI;
               |SI #nombonif#5 = 5.70;       || bonif. desempleo al 5.70% (Agrario des+FOG)
                    swCambioBon = -3;
               |FINSI;
               |SI #nombonif#5 = 5.50;       || bonif. desempleo al 5.50% (Agrario des.)
                    swCambioBon = -4;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI aModulo ! "nomcalir";
          |SI swCambioBon > 0;
               |PUSHV 05012380;
               |BLANCO 10012380;
               |AVISO;
               |PINPA #6#nompanta;
               |ATRI S;
               |PINTA 1747, aCodigoBon;
               |SI swCambioBon = 1;
                    aAlfa1 = "pasa del 6.55% al 6.30%";
               |FINSI;
               |SI swCambioBon = 2;
                    aAlfa1 = "pasa del 6.35% al 6.10%";
               |FINSI;
               |SI swCambioBon = 3;
                    aAlfa1 = "pasa del 5.95% al 5.70%";
               |FINSI;
               |SI swCambioBon = 4;
                    aAlfa1 = "pasa del 5.75% al 5.50%";
               |FINSI;
               |PINTA 2024, aAlfa1;
               |ATRI 0;
               |PAUSA;
               |POPV;

               |SI swCambioBon = 1;
                    #nombonif#5 = 6.30;
               |FINSI;
               |SI swCambioBon = 2;
                    #nombonif#5 = 6.10;
               |FINSI;
               |SI swCambioBon = 3;
                    #nombonif#5 = 5.70;
               |FINSI;
               |SI swCambioBon = 4;
                    #nombonif#5 = 5.50;
               |FINSI;
               |GRABA 020#nombonif.a;
               |LIBERA #nombonif;
          |FINSI;
          |SI swCambioBon < 0;
               |SI swCambioBon = -1;
                    #nombonif#5 = 6.55;
               |FINSI;
               |SI swCambioBon = -2;
                    #nombonif#5 = 6.35;
               |FINSI;
               |SI swCambioBon = -3;
                    #nombonif#5 = 5.95;
               |FINSI;
               |SI swCambioBon = -4;
                    #nombonif#5 = 5.75;
               |FINSI;
               swBonModif = -1;
          |FINSI;
     |FINSI;
|FPRC;

/*
|PROCESO CambioAct;
     || si no ha habido cambios es porque ya estan cambiados de antes, la fe-
     || cha de ultima revision debe ser 07/2006 para no dar lugar a errores
     || de que no te deje actualizar despues por detectar cambio de constante

     |SI swCambioDes = 0; |Y swCambioFOG = 0;
          || #nomconst#77 = 2006;
          || #nomconst#78 = 07;
          #nomconst#77 = 2007;
          #nomconst#78 = 01;
          |GRABA 020#nomconst.a;
          |LIBERA #nomconst;
     |FINSI;
|FPRC;

|PROCESO VerifCons;
     |ACABA;
     swCambioDes = 0;
     swCambioFOG = 0;

     nCodigoCons = nCConst;
     aAlfa = fCFecha;
     aAlfa = aAlfa % 402;
     nMes = aAlfa;
     aAlfa = fCFecha;
     aAlfa = aAlfa % -104;
     nAny = aAlfa;

     |SI nCodigoCons ] 500;
          swCambio = 0;
          |SI nAny ] 2007;
               swCambio = 1;
          |SINO;
               |SI nAny = 2006; |Y nMes ] 7;
                    swCambio = 1;
               |FINSI;
          |FINSI;
          |SI swCambio = 1;
               |SI #nomconst#14 = 0.40;      || tipo cotiz por FOGASA al 0.40%
                    |SUB_EJECUTA "nomfan02;ACTUALIZACIONRL";
                    |HAZ LeeCons;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO VerifBonif;
     swCambioBon = 0;
     aCodigoBon = nCodigoBon;
     aCodigoBon = "00" + aCodigoBon;
     aCodigoBon = aCodigoBon % -102;
     swBonModif = 0;

     |MODULO aModulo;
     |QBF aModulo;

     #nombonif#0 = nCodigoBon;
     |LEE 101#nombonif.=;
     |SI FSalida = 0;
          swCambio = 0;
          |SI nAny ] 2007;
               swCambio = 1;
          |SINO;
               |SI nAny = 2006; |Y nMes ] 7;
                    swCambio = 1;
               |FINSI;
          |FINSI;
          |SI swCambio = 1;
               |SI #nombonif#5 = 7;          || bonif. desempleo al 7% (des+FOG)
                    swCambioBon = 1;
               |FINSI;
               |SI #nombonif#5 = 7.70;       || bonif. desempleo al 7.70% (des+FOG)
                    swCambioBon = 2;
               |FINSI;
               |SI #nombonif#5 = 8.70;       || bonif. desempleo al 8.70% (des+FOG)
                    swCambioBon = 3;
               |FINSI;
               |SI #nombonif#5 = 7.55;       || bonif. desempleo al 7% (des. Agr.)
                    swCambioBon = 4;
               |FINSI;
          |SINO;
               |SI #nombonif#5 = 6.55;          || bonif. desempleo al 7% (des+FOG)
                    swCambioBon = -1;
               |FINSI;
               |SI #nombonif#5 = 7.50;       || bonif. desempleo al 7.70% (des+FOG)
                    swCambioBon = -2;
               |FINSI;
               |SI #nombonif#5 = 8.50;       || bonif. desempleo al 8.70% (des+FOG)
                    swCambioBon = -3;
               |FINSI;
               |SI #nombonif#5 = 7.30;       || bonif. desempleo al 7% (des. Agr.)
                    swCambioBon = -4;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI aModulo ! "nomcalir";
          |SI swCambioBon > 0;
               |PUSHV 05012380;
               |BLANCO 10012380;
               |AVISO;
               |PINPA #6#nompanta;
               |ATRI S;
               |PINTA 1660, aCodigoBon;
               |SI swCambioBon = 1;
                    aAlfa1 = "pasa del 7% al 6.55%";
               |FINSI;
               |SI swCambioBon = 2;
                    aAlfa1 = "pasa del 7.70% al 6.50%";
               |FINSI;
               |SI swCambioBon = 3;
                    aAlfa1 = "pasa del 8.70% al 8.50%";
               |FINSI;
               |SI swCambioBon = 4;
                    aAlfa1 = "pasa del 7.55% al 7.30%";
               |FINSI;
               |PINTA 2024, aAlfa1;
               |ATRI 0;
               |PAUSA;
               |POPV;

               |SI swCambioBon = 1;
                    #nombonif#5 = 6.55;
               |FINSI;
               |SI swCambioBon = 2;
                    #nombonif#5 = 7.50;
               |FINSI;
               |SI swCambioBon = 3;
                    #nombonif#5 = 8.50;
               |FINSI;
               |SI swCambioBon = 4;
                    #nombonif#5 = 7.30;
               |FINSI;
               |GRABA 020#nombonif.a;
               |LIBERA #nombonif;
          |FINSI;
          |SI swCambioBon < 0;
               |SI swCambioBon = -1;
                    #nombonif#5 = 7;
               |FINSI;
               |SI swCambioBon = -2;
                    #nombonif#5 = 7.70;
               |FINSI;
               |SI swCambioBon = -3;
                    #nombonif#5 = 8.70;
               |FINSI;
               |SI swCambioBon = -4;
                    #nombonif#5 = 7.55;
               |FINSI;
               swBonModif = -1;
          |FINSI;
     |FINSI;
|FPRC;
*/
||****************************************************************************
||  PROCESO PARA GRABAR EN EL CONTROL DE NOMINAS PAGADAS
||****************************************************************************

|PROCESO GrabaNompag;
     |ABRE #nomcontr; |LEE 000#nomcontr.p; |CIERRA #nomcontr;
     |SI #nomcontr#42 = "N"; |ACABA; |FINSI;
     |ABRE #nompagca;
     |ABRE #nompagli;
     |SI nTip = 10;
          nTip = 0;
          aNorPag = "P";
     |SINO;
          aNorPag = "N";
     |FINSI;
     #nompagca#0 = #labempre#0;
     #nompagca#1 = nAny;
     #nompagca#2 = nMes;
     #nompagca#3 = nTip;
     #nompagca#4 = aNorPag;
     |LEE 101#nompagca.=;
     |SI FSalida ! 0;
          #nompagca#0 = #labempre#0;
          #nompagca#1 = nAny;
          #nompagca#2 = nMes;
          #nompagca#3 = nTip;
          #nompagca#4 = aNorPag;
          |GRABA 020#nompagca.n;
          |LIBERA #nompagca;
     |FINSI;

     |SI aNorPag = "N";  nTipoCuenta = 1;  |FINSI;
     |SI aNorPag = "P";  nTipoCuenta = 2;  |FINSI;
     |SI aNorPag = "E";  nTipoCuenta = 3;  |FINSI;

     |ABRE #labtracu;
     #labtracu#0 = #labtraba#0;
     #labtracu#1 = #labtraba#1;
     #labtracu#2 = nTipoCuenta;
     |LEE 000#labtracu.=;
     |SI FSalida = 0;
         nBanco = #labtracu#3;
         aCuenta = #labtracu#5 + #labtracu#6 + #labtracu#7 + #labtracu#8;
     |SINO;
         nBanco    = #labtraba#71;
         aCuenta   = #labtraba#72;        || cta. cte.
     |FINSI;
     |CIERRA #labtracu;

     #nompagli#0 = #labempre#0;
     #nompagli#1 = nAny;
     #nompagli#2 = nMes;
     #nompagli#3 = nTip;
     #nompagli#4 = aNorPag;
     #nompagli#5 = #labtraba#1;
     |LEE 101#nompagli.=;
     |SI FSalida ! 0;
          #nompagli#6  = #labtraba#2;
          #nompagli#7  = #labtraba#70;
          #nompagli#8  = "00.00.0000"
          #nompagli#9  = aCuenta;
          #nompagli#10 = "";
          #nompagli#11 = "N";
          #nompagli#12 = liquipag;
          |GRABA 020#nompagli.c;
          |LIBERA #nompagli;
     |FINSI;
     |CIERRA #nompagli;
     |CIERRA #nompagca;
|FPRC;

|PROCESO CompPagado;
     |ABRE #nomcontr; |LEE 000#nomcontr.p; |CIERRA #nomcontr;
     |SI #nomcontr#42 = "N"; |ACABA; |FINSI;

     |ABRE #nompagli;
     #nompagli#0 = nEmpPag;
     #nompagli#1 = nAnyPag;
     #nompagli#2 = nMesPag;
     #nompagli#3 = nTipPag;
     #nompagli#4 = aNorPag;
     #nompagli#5 = nTraPag;
     |LEE 000#nompagli.=;
     aAlfa = #nompagli#10;
     |QBF aAlfa;
     |SI FSalida = 0; |Y aAlfa ! "";
          swStop = 1;
     |FINSI;
|FPRC;

|PROCESO Pagado;
     |ABRE #nomcontr; |LEE 000#nomcontr.p; |CIERRA #nomcontr;
     |SI #nomcontr#42 = "N"; |ACABA; |FINSI;

     |SI aNorPag = "N";  nTipoCuenta = 1;  |FINSI;
     |SI aNorPag = "P";  nTipoCuenta = 2;  |FINSI;
     |SI aNorPag = "E";  nTipoCuenta = 3;  |FINSI;

     |ABRE #labtracu;
     #labtracu#0 = #labtraba#0;
     #labtracu#1 = #labtraba#1;
     #labtracu#2 = nTipoCuenta;
     |LEE 000#labtracu.=;
     |SI FSalida = 0;
         nBanco = #labtracu#3;
         aCuenta = #labtracu#5 + #labtracu#6 + #labtracu#7 + #labtracu#8;
     |SINO;
         nBanco    = #labtraba#71;
         aCuenta   = #labtraba#72;        || cta. cte.
     |FINSI;
     |CIERRA #labtracu;

     |ABRE #nompagca;
     #nompagca#0 = nEmpPag;
     #nompagca#1 = nAnyPag;
     #nompagca#2 = nMesPag;
     #nompagca#3 = nTipPag;
     #nompagca#4 = aNorPag;
     |LEE 101#nompagca.=;
     |SI FSalida ! 0;
          |GRABA 020#nompagca.c;
     |FINSI;
     |LIBERA #nompagca;
     |CIERRA #nompagca;

     |ABRE #nompagli;
     #nompagli#0 = nEmpPag;
     #nompagli#1 = nAnyPag;
     #nompagli#2 = nMesPag;
     #nompagli#3 = nTipPag;
     #nompagli#4 = aNorPag;
     #nompagli#5 = nTraPag;
     |LEE 101#nompagli.=;
     |SI FSalida ! 0;
          #nompagli#6 = #labtraba#2;
          #nompagli#7 = #labtraba#70;
          #nompagli#9 = aCuenta;
          #nompagli#12 = nLiqEnlace;   || liquido en tranferencias para enlace contable
          #nompagli#13 = "N";           || contabilizado S/N
          |GRABA 020#nompagli.c;
     |FINSI;
     #nompagli#8 = fFecPag;
     |QBF aRegPag;
     #nompagli#10 = aRegPag;
     |SI aRegPag = "";   || vengo de talones o desglose moneda
          #nompagli#11 = "S";
     |SINO;       || si traigo nro registro es porque vengo de transf.
          #nompagli#11 = "N";
     |FINSI;
     #nompagli#12 = nLiqEnlace;   || liquido en tranferencias para enlace contable
     #nompagli#13 = "N";           || contabilizado S/N

     |GRABA 020#nompagli.a;
     |LIBERA #nompagli;
     |CIERRA #nompagli;
|FPRC;

|PROCESO PasaOcupa;
     nClaveEpig = nClaveEpig + 1;
     #nomepigr#0 = nClaveEpig;
     #nomepigr#1 = #nomocupa#2;
     #nomepigr#2 = #nomocupa#3;
     |GRABA 020#nomepigr.n;
     #nomocupa#5 = nClaveEpig;
     |GRABA 020#nomocupa.a;
|FPRC;

|DEFBUCLE PasaOcupa;
     #nomocupa#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, PasaOcupa;
|FIN;

|PROCESO PasaCNAE;
     nClaveEpig = nClaveEpig + 1;
     #nomepigr#0 = nClaveEpig;
     #nomepigr#1 = #nomcnaec#2;
     #nomepigr#2 = #nomcnaec#3;
     |GRABA 020#nomepigr.n;
     #nomcnaec#5 = nClaveEpig;
     |GRABA 020#nomcnaec.a;
|FPRC;

|DEFBUCLE PasaCNAE;
     #nomcnaec#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, PasaCNAE;
|FIN;

|PROCESO PaseTablas;
     nClaveEpig = 700;
     |BUCLE PasaCNAE;
     nClaveEpig = 900;
     |BUCLE PasaOcupa;
|FPRC;

|PROCESO CompruebaTablas;
     |ABRE #nomepigr;
     #nomepigr#0 = 701;
     |LEE 000#nomepigr.=;
     |SI FSalida ! 0;
          || no existe el epigrafe 700, no se han pasado aun las tablas
          |HAZ PaseTablas;
     |FINSI;
     |CIERRA #nomepigr;
|FPRC;

|PROCESO CNAEEmpHis;
     || BUSCO PRIMERO EL CNAE POR EMPRESA

     swSigue = 0;

     |ABRE #nomcnahi;
     #nomcnahi#0 = #labempre#0;
     #nomcnahi#2 = 2009;
     #nomcnahi#4 = 00;
     |LEE 000#nomcnahi.=
     |SI FSalida = 0;
          aAlfa1 = #nomcnahi#3;
          |QBF aAlfa1;
          |SI aAlfa1 ! "";
               swSigue = 1;
          |FINSI;
     |FINSI;

     |SI swSigue = 1;
          aAlfa = #nomcnahi#3;     || me quedo con el CNAE por empresa

          |SI #nomcnahi#3 ! #labempre#128; |Y aCNAEEmp = "";
          /*
               || no saco mensaje de momento

               aEmp = #labempre#0;
               |QBF aEmp;
               aEmp = ("00000" + aEmp) % -105;
               aMensa = "    ATENCION. El CNAE de la empresa " + aEmp;
               aMensa = aMensa + " para el año 2009 (" + aAlfa;
               aMensa = aMensa + ") es distinto al actual (" + #labempre#128 + ").";
               |MENAV aMensa;

               aMensa = "    Se usará el correspondiente al 2009.";
               aMensa = aMensa + " Verifique que el dato es correcto";
               |MENAV aMensa;
          */
          |FINSI;
     |FINSI;

     || BUSCO TAMBIEN POR SI HUBIERA CNAE POR CENTRO

     swSigue = 0;

     |ABRE #labcentr;
     #labcentr#0 = #labempre#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;

     #nomcnahi#0 = #labempre#0;
     #nomcnahi#2 = 2009;
     #nomcnahi#4 = #labtraba#77;
     |LEE 000#nomcnahi.=
     |SI FSalida = 0;
          aAlfa1 = #nomcnahi#3;
          |QBF aAlfa1;
          |SI aAlfa1 ! "";
               swSigue = 1;
          |FINSI;
     |FINSI;

     |CIERRA #labcentr;

     |SI swSigue = 1;
          aAlfa = #nomcnahi#3;     || me quedo con el CNAE por centro

          |SI #nomcnahi#3 ! #labcentr#22; |Y aCNAEEmp = "";
          /*
               || no saco mensaje de momento

               aEmp = #labempre#0;
               |QBF aEmp;
               aEmp = ("00000" + aEmp) % -105;
               aCen = #labtraba#77;
               |QBF aCen;
               aCen = ("00" + aCen) % -102;

               aMensa = "    ATENCION. El CNAE de la empresa " + aEmp;
               aMensa = aMensa + ", centro " + aCen + " para el año 2009 (" + aAlfa;
               aMensa = aMensa + ") es distinto al actual (" + #labempre#128 + ").";
               |MENAV aMensa;

               aMensa = "    Se usará el correspondiente al 2009.";
               aMensa = aMensa + " Verifique que el dato es correcto";
               |MENAV aMensa;
          */
          |FINSI;
     |FINSI;
     |CIERRA #nomcnahi;
|FPRC;

|PROCESO CNAEHis;
     || PRIMERO POR TRABAJADOR

     aAlfa = "";    || OJO que en esa variable me guardare el CNAE u Ocup
                    || comprobar al usarla

     swSigue = 1;

     |ABRE #nomocuhi;
     #nomocuhi#2 = 2009;
     #nomocuhi#0 = #labtraba#0;
     #nomocuhi#4 = #labtraba#1;
     |LEE 000#nomocuhi.=
     |SI FSalida = 0;
          aAlfa1 = #nomocuhi#3;
          |QBF aAlfa1;
          |SI aAlfa1 ! "";
               aAlfa = #nomocuhi#3;     || me quedo con la ocupacion del trab.
               swSigue = 0;
               |SI #nomocuhi#3 ! #labtraba#204;
               /*
                    || no saco mensaje de momento
                    aEmp = #labtraba#0;
                    aTra = #labtraba#1;
                    |QBF aEmp;
                    |QBF aTra;
                    aEmp = ("00000" + aEmp) % -105;
                    aTra = ("00000" + aTra) % -105;
                    aMensa = "    ATENCION. La ocupación del trab. " + aEmp + "." + aTra;
                    aMensa = aMensa + " para el año 2009 (" + aAlfa;
                    aMensa = aMensa + ") es distinta a la actual (" + #labtraba#204 + ").";
                    |MENAV aMensa;

                    aMensa = "    Se usará la correspondiente al 2009.";
                    aMensa = aMensa + " Verifique que el dato es correcto";
                    |MENAV aMensa;
               */
               |FINSI;
          |FINSI;
     |FINSI;
     |SI swSigue = 1;
          || no he encontrado ocupacion por trabajador en el historico
          || busco en la ficha del trabajador antes de buscar en el historico
          || por CNAE de Empresa y Centro

          aAlfa = #labtraba#204;                  || si el trabajador tiene ocup
          |QBF aAlfa;                             || me quedo con ella
          |SI aAlfa ! "";
               || ya tengo mi ocupacion
               swSigue = 0;
          |FINSI;
     |FINSI;
     |SI swSigue = 1;
          || SI NO POR CENTRO O EMPRESA
          |HAZ CNAEEmpHis;
     |FINSI;
     |CIERRA #nomocuhi;

     |SI aAlfa ! "";
          aCNAE = aAlfa;
     |FINSI;
|FPRC;

|PROCESO BuscaEquivCNAE;
     swLocalizado = 0;

     aMes = nElMes; aMes = ("00" + aMes) % -102;
     aAny = nElAny;
     aDia = "01";
     aFecha = aDia + "." + aMes + "." + aAny;
     fFecha = aFecha;

     aCNAE = (aCNAE + "          ") % 110;
     |ABRE #nomcnama;
     |SELECT #2#nomcnama;
     #nomcnama#0 = aCNAE;
     #nomcnama#6 = fFecha;
     |LEE 000#nomcnama.];
     |SI FSalida = 0;
          |SI #nomcnama#0 = aCNAE; |Y #nomcnama#6 = fFecha;
               nEpigConv = #nomcnama#5;
               swLocalizado = 1;
          |SINO;
               |LEE 000#nomcnama.a;
               |SI #nomcnama#0 = aCNAE;
                    nEpigConv = #nomcnama#5;
                    swLocalizado = 1;
               |SINO;
                    || NO ENCONTRADO
               |FINSI;
          |FINSI;
     |SINO;
          |LEE 000#nomcnama.u;
          |SI #nomcnama#0 = aCNAE;
               nEpigConv = #nomcnama#5;
               swLocalizado = 1;
          |SINO;
               || NO ENCONTRADO
          |FINSI;
     |FINSI;

     |SI swLocalizado = 0;
          aAlfa2 = " ";
          |PARA nNume1 = 1; |SI aAlfa2 ! ""; |HACIENDO nNume1 = nNume1 + 5;
               nNume2 = (nNume1 * 100) + 5;
               aAlfa2 = aAvisos % nNume2;

               aAlfa1 = #labempre#0;
               aAlfa1 = ("00000" + aAlfa1) % -105;
               |SI aAlfa1 = aAlfa2;
                    aAlfa1 = "";
                    |ACABA;
               |FINSI;
          |SIGUE;
          |SI aAlfa1 ! "";
               aAlfa = "    ATENCION: El CNAE " + aCNAE + " de la empresa " + aAlfa1;
               aAlfa = aAlfa + " no se encuentra. Repase los datos y vuelva a calcular.";
               |SI aModulo ! "nomcalir"; |Y aModulo ! "gomcalc1";
                    |MENAV aAlfa;
               |FINSI;
               aAvisos = aAvisos + aAlfa1;
          |FINSI;
     |FINSI;

     |CIERRA #nomcnama;

/*
     |ABRE #nomcnaec;
          #nomcnaec#0 = aCNAE;
          |LEE 000#nomcnaec.=;
          |SI FSalida = 0;
               nEpigConv = #nomcnaec#5;
          |SINO;
               aAlfa2 = " ";
               |PARA nNume1 = 1; |SI aAlfa2 ! ""; |HACIENDO nNume1 = nNume1 + 5;
                    nNume2 = (nNume1 * 100) + 5;
                    aAlfa2 = aAvisos % nNume2;

                    aAlfa1 = #labempre#0;
                    aAlfa1 = ("00000" + aAlfa1) % -105;
                    |SI aAlfa1 = aAlfa2;
                         aAlfa1 = "";
                         |ACABA;
                    |FINSI;
               |SIGUE;
               |SI aAlfa1 ! "";
                    aAlfa = "    ATENCION: El CNAE " + aCNAE + " de la empresa " + aAlfa1;
                    aAlfa = aAlfa + " no se encuentra. Repase los datos y vuelva a calcular.";
                    |SI aModulo ! "nomcalir"; |Y aModulo ! "gomcalc1";
                         |MENAV aAlfa;
                    |FINSI;
                    aAvisos = aAvisos + aAlfa1;
                    ||ACABA;
               |FINSI;
          |FINSI;
          |CIERRA #nomcnaec;
*/

|FPRC;

|PROCESO BuscaEquivOcupa;
     swLocalizado = 0;

     aMes = nElMes; aMes = ("00" + aMes) % -102;
     aAny = nElAny;
     aDia = "01";
     aFecha = aDia + "." + aMes + "." + aAny;
     fFecha = aFecha;

     |ABRE #nomocuma;
     |SELECT #2#nomocuma;
     #nomocuma#0 = aCNAE;
     #nomocuma#6 = fFecha;
     |LEE 000#nomocuma.];
     |SI FSalida = 0;
          |SI #nomocuma#0 = aCNAE; |Y #nomocuma#6 = fFecha;
               nEpigConv = #nomocuma#5;
               swLocalizado = 1;
          |SINO;
               |LEE 000#nomocuma.a;
               |SI #nomocuma#0 = aCNAE;
                    nEpigConv = #nomocuma#5;
                    swLocalizado = 1;
               |SINO;
                    || NO ENCONTRADO
               |FINSI;
          |FINSI;
     |SINO;
          |LEE 000#nomocuma.u;
          |SI #nomocuma#0 = aCNAE;
               nEpigConv = #nomocuma#5;
               swLocalizado = 1;
          |SINO;
               || NO ENCONTRADO
          |FINSI;
     |FINSI;

     |SI swLocalizado = 0;
          aAlfa = "    No se ha encontrado la ocupacion " + aCNAE + ".";
          |SI aModulo ! "nomcalir";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
     |CIERRA #nomocuma;
/*
          |ABRE #nomocupa;
          #nomocupa#0 = aCNAE;
          #nomocuma#6 = fFecha;
          |LEE 000#nomocuma.=;

          |SI FSalida = 0;
               nEpigConv = #nomocupa#5;
          |SINO;
               aAlfa = "    No se ha encontrado la ocupacion " + aCNAE + ".";
               |SI aModulo ! "nomcalir";
                    |MENAV aAlfa;
               |FINSI;
          |FINSI;
          |CIERRA #nomocupa;
*/
|FPRC;

|PROCESO VerifCNAE;
     |HAZ CompruebaTablas;

     aCNAE = "";
     aAlfa = #labtraba#204;                  || si el trabajador tiene ocup
     |QBF aAlfa;                             || me quedo con ella

     |SI aAlfa = "e"; |Y nElAny ] 2013;
          aAlfa = "";
     |FINSI;

     |SI aAlfa ! "";
          aCNAE = aAlfa;
     |SINO;
          aAlfa = #labempre#128;             || si no, en principio el CNAE
          |ABRE #nomcnahi;                   || de la empresa
          |SI nElAny [ 2008;
               #nomcnahi#0 = #labempre#0;    || 2008 o anterior, busco nomcnahi
               #nomcnahi#2 = 2008;
               #nomcnahi#4 = 00;
               |LEE 000#nomcnahi.=
               |SI FSalida = 0;
                    aAlfa1 = #nomcnahi#3;
                    |QBF aAlfa1;
                    |SI aAlfa1 ! "";         || existe y distinto de blanco
                         aAlfa = #nomcnahi#3;     || cojo esta
                    |FINSI;
               |FINSI;
          |FINSI;

          |QBF aAlfa;
          |SI aCNAEEmp ! "";
               aAlfa = aCNAEEmp;
          |FINSI;
          |SI aAlfa ! "";
               aCNAE = aAlfa;
          |FINSI;

          |ABRE #labcentr;
          #labcentr#0 = #labempre#0;
          #labcentr#1 = #labtraba#77;
          |LEE 000#labcentr.=;
          |SI FSalida = 0; |Y aParam ! "NOMSICOS";
               aAlfa = #labcentr#22;
               |QBF aAlfa;
               |SI aAlfa ! "";
                    |SI nElAny [ 2008;
                         #nomcnahi#0 = #labempre#0;
                         #nomcnahi#2 = 2008;
                         #nomcnahi#4 = #labtraba#77;
                         |LEE 000#nomcnahi.=
                         |SI FSalida = 0;
                              aAlfa = #nomcnahi#3;
                              |QBF aAlfa;
                              aCNAE = aAlfa;
                         |FINSI;
                    |SINO;
                         aCNAE = aAlfa;
                    |FINSI;
               |FINSI;
          |FINSI;
          |CIERRA #labcentr;

          |CIERRA #nomcnahi;
     |FINSI;

     |SI nElAny = 2009;
          |HAZ CNAEHis;
     |FINSI;

     aAlfa2 = " ";
     |SI aCNAE = "";
          |PARA nNume1 = 1; |SI aAlfa2 ! ""; |HACIENDO nNume1 = nNume1 + 5;
               nNume2 = (nNume1 * 100) + 5;
               aAlfa2 = aAvisos % nNume2;

               aAlfa1 = #labempre#0;
               aAlfa1 = ("00000" + aAlfa1) % -105;
               |SI aAlfa1 = aAlfa2;
                    aAlfa1 = "";
                    |ACABA;
               |FINSI;
          |SIGUE;
          |SI aAlfa1 ! "";
               aAlfa = "    ATENCION: La empresa " + aAlfa1 + " no tiene CNAE. ";
               aAlfa = aAlfa + "Repase los datos y vuelva a calcular.";
               ||MENAV aAlfa;
               aAvisos = aAvisos + aAlfa1;
               |ACABA;
          |FINSI;
     |FINSI;

     nEpigConv = #labtraba#32;
     |QBF aCNAE;
     |SI aCNAE = "52."; aCNAE = "52"; |FINSI;
     aLon = aCNAE % 0;
     nLon = aLon;

     |MODULO aModulo;
     |QBF aModulo;

     |SI nLon = 1;
          || miro en la tabla de ocupaciones
          |HAZ BuscaEquivOcupa;
     |SINO;
          || miro en la tabla de CNAEs
          |HAZ BuscaEquivCNAE;
     |FINSI;
|FPRC;

/*
|PROCESO nomocupa;
     #nomepigr#0 = #nomocupa#5;
     |LEE 101#nomepigr.=;
     FEstado = FSalida;

     #nomepigr#1 = #nomocupa#2;
     #nomepigr#2 = #nomocupa#3;

     |SI FEstado = 0;
          |GRABA 020#nomepigr.a;
     |SINO;
          |GRABA 020#nomepigr.n;
     |FINSI;
     |LIBERA #nomepigr;
|FPRC;

|DEFBUCLE nomocupa;
     #nomocupa#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, nomocupa;
|FIN;

|PROCESO nomcnaec;
     #nomepigr#0 = #nomcnaec#5;
     |LEE 101#nomepigr.=;
     FEstado = FSalida;

     #nomepigr#1 = #nomcnaec#2;
     #nomepigr#2 = #nomcnaec#3;

     |SI FEstado = 0;
          |GRABA 020#nomepigr.a;
     |SINO;
          |GRABA 020#nomepigr.n;
     |FINSI;
     |LIBERA #nomepigr;
|FPRC;

|DEFBUCLE nomcnaec;
     #nomcnaec#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, nomcnaec;
|FIN;
*/

|PROCESO nomocuma;
     || primero cargo el nomocupa, esta tabla me sirve para consulta desde
     || el labempre o el labtraba por ejemplo, ya no paso por aqui para
     || nomina o seguros sociales

     #nomocupa#0 = #nomocuma#0;
     |LEE 101#nomocupa.=;
     FEstado = FSalida;

     #nomocupa#1 = #nomocuma#1;
     #nomocupa#2 = #nomocuma#2;
     #nomocupa#3 = #nomocuma#3;
     #nomocupa#4 = #nomocuma#4;
     #nomocupa#5 = #nomocuma#5;

     |SI FEstado = 0;
          |GRABA 020#nomocupa.a;
     |SINO;
          |GRABA 020#nomocupa.n;
     |FINSI;
     |LIBERA #nomocupa;

     || y ahora directamente desde el nomocuma cargo la tabla de epigrafes
     || en la que voy a mirar para calculo de nomina y seguros sociales

     #nomepigr#0 = #nomocuma#5;
     |LEE 101#nomepigr.=;
     FEstado = FSalida;

     #nomepigr#1 = #nomocuma#2;
     #nomepigr#2 = #nomocuma#3;

     |SI FEstado = 0;
          |GRABA 020#nomepigr.a;
     |SINO;
          |GRABA 020#nomepigr.n;
     |FINSI;
     |LIBERA #nomepigr;
|FPRC;

|DEFBUCLE nomocuma;
     #nomocuma#1;
     ;
     fFecha, " ";
     fFecha, "z";
     ;
     NULL, nomocuma;
|FIN;

|PROCESO nomcnama;
     || primero cargo el nomcnaec, esta tabla me sirve para consulta desde
     || el labempre o el labtraba por ejemplo, ya no paso por aqui para
     || nomina o seguros sociales

     #nomcnaec#0 = #nomcnama#0;
     |LEE 101#nomcnaec.=;
     FEstado = FSalida;

     #nomcnaec#1 = #nomcnama#1;
     #nomcnaec#2 = #nomcnama#2;
     #nomcnaec#3 = #nomcnama#3;
     #nomcnaec#4 = #nomcnama#4;
     #nomcnaec#5 = #nomcnama#5;

     |SI FEstado = 0;
          |GRABA 020#nomcnaec.a;
     |SINO;
          |GRABA 020#nomcnaec.n;
     |FINSI;
     |LIBERA #nomcnaec;

     || y ahora directamente desde el nomcnama cargo la tabla de epigrafes
     || en la que voy a mirar para calculo de nomina y seguros sociales

     #nomepigr#0 = #nomcnama#5;
     |LEE 101#nomepigr.=;
     FEstado = FSalida;

     #nomepigr#1 = #nomcnama#2;
     #nomepigr#2 = #nomcnama#3;

     |SI FEstado = 0;
          |GRABA 020#nomepigr.a;
     |SINO;
          |GRABA 020#nomepigr.n;
     |FINSI;
     |LIBERA #nomepigr;
|FPRC;

|DEFBUCLE nomcnama;
     #nomcnama#1;
     ;
     fFecha, "          ";
     fFecha, "zzzzzzzzzz";
     ;
     NULL, nomcnama;
|FIN;

|PROCESO Actualizador;
     |MODULO aAlfa;
     |QBF aAlfa;

     |SI aAlfa ! "labtraba"; |Y aAlfa ! "labempre";
     |Y aAlfa ! "nomw0003"; |Y aAlfa ! "nomw0002";
          || para que el epigrafe se quede actualizado al a¤o en curso, pero
          || el nomepigr de verdad, para el resto de operaciones uso
          || los temporales, esto es para los procesos que no esten con-
          || templados y que accedan al nomepigr (simulacion de nomina y cosas
          || asi)
          aTempEpig = Usuario; |QBT aTempEpig; aTempEpig = ("EP" + aTempEpig) % 108;
          |NOME_DAT #2610 aTempEpig;
          |DELINDEX #2610;
     |FINSI;

     |ABRE #nomepigr;

     |DELINDEX #nomcnaec;
     |ABRE #nomcnaec;
     |BUCLE nomcnama;
     |CIERRA #nomcnaec;

     |DELINDEX #nomocupa;
     |ABRE #nomocupa;
     |BUCLE nomocuma;
     |CIERRA #nomocupa;

     /*
     |BUCLE nomcnaec;
     |BUCLE nomocupa;
     */

     |CIERRA #nomepigr;
|FPRC;

|PROCESO ValoresITIMS;
     |SI nElAny < 2007;
          |ACABA;
     |FINSI;

     aMes = nElMes; aMes = ("00" + aMes) % -102;
     aAny = nElAny;
     aDia = "01";
     aFecha = aDia + "." + aMes + "." + aAny;
     fFecha = aFecha;

     |ABRE #nomcnama;
     #nomcnama#0 = "          ";
     #nomcnama#6 = fFecha;
     |LEE 000#nomcnama.];
     |SI FSalida = 0;
          |SI #nomcnama#0 = "          "; |Y #nomcnama#6 = fFecha;
               |HAZ Actualizador;
          |SINO;
               |LEE 000#nomcnama.a;
               fFecha = #nomcnama#6;
               |HAZ Actualizador;
          |FINSI;
     |SINO;
          |LEE 000#nomcnama.u;
          fFecha = #nomcnama#6;
          |HAZ Actualizador;
     |FINSI;

     |CIERRA #nomcnama;
|FPRC;

|PROCESO BuscaMun;
     aCodMuni = #labmunic#1;       || codigo del municipio segun el labmunic
     aNombreMuni = #labmunic#3;    || nombre del municipio segun el labmunic
     nCodMuni = aCodMuni;
     |ERROR10;
|FPRC;

|DEFBUCLE BuscaMun;
     #labmunic#1;
     ;
     aCodPos, "00000";
     aCodPos, "99999";
     ;
     NULL, BuscaMun;
|FIN;

|PROCESO nomfical;
     #nomtmcal#0 = #nomfical#0;
     #nomtmcal#1 = #nomfical#159;
     |SI #nomfical#159 = 0;
          #nomtmcal#2 = "General";
     |SINO;
     || aCodPos me viene del proceso
          #nomtmcal#2 = aNombreMuni;
     |FINSI;
     |GRABA 000#nomtmcal.n;
|FPRC;

|DEFBUCLE nomfical2;
     #nomfical#1;
     159;
     001, aAny, nCodMuni;
     999, aAny, nCodMuni;
     ;
     NULL, nomfical;
|FIN;

|DEFBUCLE nomfical1;
     #nomfical#1;
     159;
     001, aAny, 00000;
     999, aAny, 00000;
     ;
     NULL, nomfical;
|FIN;

|PROCESO ConsCalenPLB;
     aAlfa = Usuario; |QBT aAlfa;    aAlfa = ("f" + aAlfa) % 108;
     |NOME_DAT #2611 aAlfa;
     |DELINDEX #nomtmcal;

     |ABRE #nomtmcal;

     fFecha = ~;
     aFecha = fFecha;
     aAny = aFecha % -104;
     |BUCLE nomfical1;

     |BUCLE BuscaMun;

     |BUCLE nomfical2;

     nOpcionPLB = 0;
     nModo = 2 + 4 + 8 + 16;
     |MODULO aAlfa;
     |SI aAlfa = "labempre"; nPos1 = 1540; nPos2 = 2279; |FINSI;
     |SI aAlfa = "labtraba"; nPos1 = 1540; nPos2 = 2279; |FINSI;
     |SI aAlfa = "labcentr"; nPos1 = 1830; nPos2 = 2271; |FINSI;
     |SI aAlfa = "nomw0003"; nPos1 = 1540; nPos2 = 2279; |FINSI;
     |SI aAlfa = "nomw0002"; nPos1 = 1538; nPos2 = 2277; |FINSI;
     |SI aAlfa = "nomw0007"; nPos1 = 1840; nPos2 = 2276; |FINSI;
     |LINEAL_SIMPLE #1#nomtmcal, nModo, nPos1, nPos2, NULL, NULL, NULL;
     |SI FSalida = 0;
          nOpcionPLB = #nomtmcal#0;
     |FINSI;

     |CIERRA #nomtmcal;
|FPRC;

|PROCESO Tipo20Fm103;                                                         º
     || por compatibilidad con procesos de la integrada
|FPRC;

|| **************************************************************************
|| ********************** ENVIO DE CORREOS ELECTRONICOS *********************
|| **************************************************************************

|VARIABLES;
   aIPDsCorreo1 = "";
   aSMTP        = "";
   aDirOrigen   = "";

{2}nDato        = 0;

   &eaDirDest   = "";
   &eaAsunto    = "";
   &eaTexto     = "";
   &eaFichero   = "";

   &eaEmpresa = "";
   &eaTrabajador = "";
   &eaAccion = "";
     nCodAdmin = 0;
|FIN;

|PROCESO SendMail;
   |ABRE #nompmail;
   |LEE 000#nompmail.p;
   |SI FSalida ! 0;
      |MENAV "    No se han indicado los parametros de envio de correos. Proceso cancelado";
      |CIERRA #nompmail;
      |ACABA;
   |FINSI;
   |CIERRA #nompmail;

   aIPDsCorreo1 = #nompmail#1 + "." + #nompmail#2 + "." + #nompmail#3 + "." + #nompmail#4;
   aSMTP = #nompmail#5; |QBF aSMTP;
   aDirOrigen = #nompmail#10; |QBF aDirOrigen;

   |SI #nompmail#6 = "S";
      aAlfa = #nompmail#9; |QBF aAlfa;
      aAlfa1 = aAlfa % 0; nCalc = aAlfa1; aAlfa2 = "";
      |PARA nCont = 1; |SI nCont [ nCalc; |HACIENDO nCont = nCont + 1;
         nCalc1 = (nCont * 100) + 1;
         aAlfa1 = aAlfa % nCalc1; nDato1 = &aAlfa1; nDato2 = 255;
         InDato = nDato1<-;
         |ESPECIFICA "XOR", nDato;
         nCalc1 = FSalida; aAlfa2 = aAlfa2 + &nCalc1;
      |SIGUE;
      aAlfa = aAlfa2;              |QBF aAlfa; aAlfa = aAlfa + ":";
      aAlfa = aAlfa + #nompmail#7; |QBF aAlfa; aAlfa = aAlfa + ":";
      aDirOrigen = aAlfa + aDirOrigen;
   |FINSI;

   |DSCORREO_ENVIA aIPDsCorreo1, aSMTP, aDirOrigen, eaDirDest, eaAsunto, eaTexto, eaFichero;
   |SI FSalida < 0;
      |MENAV "    Problemas al enviar correo";
   |FINSI;
|FPRC;

|PROCESO gecom012;
     |ABRE #gecom001@;
     #gecom001@#0 = #gecom012@#1;
     |LEE 000#gecom001@.=;
     |SI FSalida = 0;
          eaDirDest = #gecom001@#2;
     |FINSI;
     |CIERRA #gecom001@;
     |HAZ SendMail;
|FPRC;

|DEFBUCLE gecom012;
     #1012#1002;
     ;
     #labor001#0, 00000;
     #labor001#0, 99999;
     ;
     NULL, gecom012;
|FIN;


|PROCESO corrige;
     nAscii = & aCaracter;
     aCaracterSal = aCaracter;
     |SI nAscii = 160;             || el caracter  
          aCaracterSal = "á";
     |FINSI;
     |SI nAscii = 130;             || el caracter ‚
          aCaracterSal = "é";
     |FINSI;
     |SI nAscii = 161;             || el caracter ¡
          aCaracterSal = "í";
     |FINSI;
     |SI nAscii = 162; |O nAscii = 243;            || el caracter ¢
          aCaracterSal = "ó";
     |FINSI;
     |SI nAscii = 163;             || el caracter £
          aCaracterSal = "ú";
     |FINSI;
     |SI nAscii = 164;             || el caracter ¤
          aCaracterSal = "ñ";
     |FINSI;
     |SI nAscii = 241;             || el caracter ¤ (otro codigo ¨?)
          aCaracterSal = "ñ";
     |FINSI;
     |SI nAscii = 165;             || el caracter ¥
          aCaracterSal = "Ñ";
     |FINSI;
     |SI nAscii = 129;
          aCaracterSal = "ü";   || el caracter u con dieresis
     |FINSI;
     |SI nAscii = 154;
          aCaracterSal = "Ü";   || el caracter U (mayuscula) con dieresis
     |FINSI;
/*
     |SI nAscii = 167;
          aCaracterSal = "\272";   || el caracter §
     |FINSI;
     |SI nAscii = 166;
          aCaracterSal = "\252";   || el caracter ¦
     |FINSI;
     |SI aCaracter = "(";
          aCaracterSal = "\(";
     |FINSI;
     |SI aCaracter = ")";
          aCaracterSal = "\)";
     |FINSI;
*/
|FPRC;

|PROCESO tildes;
     aCadenaSal = "";
     aLongitud = aCadena % 0;
     nLongitud = aLongitud;
     |PARA nPos = 1; |SI nPos [ nLongitud; |HACIENDO nPos = nPos + 1;
          nBusca = (nPos * 100) + 1;
          aCaracter = aCadena % nBusca;
          |HAZ corrige;
          aCadenaSal = aCadenaSal + aCaracterSal;
     |SIGUE;
|FPRC;

|PROCESO ConsEmail;
     aCadena = eaTrabajador;
     |HAZ tildes;
     eaTrabajador = aCadenaSal;

     aAlfa = Usuario % 0810;
     eaTexto = &13 + &10 + "El usuario " + aAlfa + " ha generado una solicitud de " + eaAccion + " de trabajador." + &13 + &10 + &13 + &10;
     eaTexto = eaTexto + "Los datos de esta solicitud son : " + &13 + &10;
     eaTexto = eaTexto + "Empresa...: " + eaEmpresa; |QBF eaTexto;
     eaTexto = eaTexto + &13 + &10 + "Trabajador: " + eaTrabajador; |QBF eaTexto;
     eaTexto = eaTexto + &13 + &10;

     eaAsunto  = "Tramitada solicitud de " + eaAccion + " de trabajador";
     eaDirDest = "";

     |ABRE #labor001;
     |SELECT #2#labor001;

     aAlfa = (eaEmpresa % 105);
     #labor001#1 = aAlfa;
     |LEE 000#labor001.=;
     |SI FSalida = 0;
          |DBASS aAlfa; |QBF aAlfa;
          aAlfa = aAlfa % -109;
          |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
               aAlfa = "/u/dsmedida/gecochek/def/gecom012.mas";
          |SINO;
               |DBASS aAlfa; |QBF aAlfa;
               aAlfa = aAlfa + "gecochek/def/gecom012.mas";
          |FINSI;
          |CARGA_DEF aAlfa, gecom012@;

          |SI FSalida = 0;
               |DBASS aAlfa; |QBF aAlfa;
               aAlfa = aAlfa % -109;
               |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
                    aAlfa = "/u/dsmedida/gecochek/fich/";
               |SINO;
                    |DBASS aAlfa; |QBF aAlfa;
                    aAlfa = aAlfa + "/gecochek/fich/";
               |FINSI;
               |PATH_DAT #gecom012@#aAlfa#;
          |SINO;
               |MENAV "    Error en CARGA_DEF ... gecom012";

               |SELECT #1#labor001;
               |CIERRA #labor001;
               |ACABA;
          |FINSI;

          |DBASS aAlfa; |QBF aAlfa;
          aAlfa = aAlfa % -109;
          |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
               aAlfa = "/u/dsmedida/gecochek/def/gecom001.mas";
          |SINO;
               |DBASS aAlfa; |QBF aAlfa;
               aAlfa = aAlfa + "gecochek/def/gecom001.mas";
          |FINSI;
          |CARGA_DEF aAlfa, gecom001@;

          |SI FSalida = 0;
               |DBASS aAlfa; |QBF aAlfa;
               aAlfa = aAlfa % -109;
               |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
                    aAlfa = "/u/dsmedida/gecochek/fich/";
               |SINO;
                    |DBASS aAlfa; |QBF aAlfa;
                    aAlfa = aAlfa + "/gecochek/fich/";
               |FINSI;
               |PATH_DAT #gecom001@#aAlfa#;
          |SINO;
               |MENAV "    Error en CARGA_DEF ... gecom001";

               |SELECT #1#labor001;
               |CIERRA #labor001;
               |ACABA;
          |FINSI;

          |ABRE #gecom012@;

          |BUCLE gecom012;

          |CIERRA #gecom012@;

          |DESCARGA_DEF #gecom001@;
          |DESCARGA_DEF #gecom012@;
     |FINSI;
     |SELECT #1#labor001;
     |CIERRA #labor001;
|FPRC;

|PROCESO gecom014;
     eaDirDest = #gecom014@#6;
     |HAZ SendMail;
|FPRC;

|DEFBUCLE gecom014;
     #1014#1003;
     ;
     #labor001#0, 01, "          ";
     #labor001#0, 99, "zzzzzzzzzz";
     ;
     NULL, gecom014;
|FIN;

|PROCESO ConsEmail2;
/*
     aAlfa = Usuario % 0810;
     eaTexto = &13 + &10 + "El usuario " + aAlfa + " ha generado una solicitud de " + eaAccion + " de trabajador." + &13 + &10 + &13 + &10;
     eaTexto = eaTexto + "Los datos de esta solicitud son : " + &13 + &10;
     eaTexto = eaTexto + "Empresa...: " + eaEmpresa; |QBF eaTexto;
     eaTexto = eaTexto + &13 + &10 + "Trabajador: " + eaTrabajador; |QBF eaTexto;
     eaTexto = eaTexto + &13 + &10;

     eaAsunto  = "Tramitada solicitud de " + eaAccion + " de trabajador";
     eaDirDest = "";
*/
     |ABRE #labor001;
     |SELECT #2#labor001;

     aAlfa = (eaEmpresa % 105);
     #labor001#1 = aAlfa;
     |LEE 000#labor001.=;
     |SI FSalida = 0;
          |DBASS aAlfa; |QBF aAlfa;
          aAlfa = aAlfa % -109;
          |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
               aAlfa = "/u/dsmedida/gecochek/def/gecom014.mas";
          |SINO;
               |DBASS aAlfa; |QBF aAlfa;
               aAlfa = aAlfa + "gecochek/def/gecom014.mas";
          |FINSI;
          |CARGA_DEF aAlfa, gecom014@;

          |SI FSalida = 0;
               |DBASS aAlfa; |QBF aAlfa;
               aAlfa = aAlfa % -109;
               |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
                    aAlfa = "/u/dsmedida/gecochek/fich/";
               |SINO;
                    |DBASS aAlfa; |QBF aAlfa;
                    aAlfa = aAlfa + "/gecochek/fich/";
               |FINSI;
               |PATH_DAT #gecom014@#aAlfa#;
          |SINO;
               |MENAV "    Error en CARGA_DEF ... gecom014";

               |SELECT #1#labor001;
               |CIERRA #labor001;
               |ACABA;
          |FINSI;
/*
          |DBASS aAlfa; |QBF aAlfa;
          aAlfa = aAlfa % -109;
          |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
               aAlfa = "/u/dsmedida/gecochek/def/gecom001.mas";
          |SINO;
               |DBASS aAlfa; |QBF aAlfa;
               aAlfa = aAlfa + "gecochek/def/gecom001.mas";
          |FINSI;
          |CARGA_DEF aAlfa, gecom001@;

          |SI FSalida = 0;
               |DBASS aAlfa; |QBF aAlfa;
               aAlfa = aAlfa % -109;
               |SI aAlfa = "dsprofes/";       || estoy en produccion, sin duda
                    aAlfa = "/u/dsmedida/gecochek/fich/";
               |SINO;
                    |DBASS aAlfa; |QBF aAlfa;
                    aAlfa = aAlfa + "/gecochek/fich/";
               |FINSI;
               |PATH_DAT #gecom001@#aAlfa#;
          |SINO;
               |MENAV "    Error en CARGA_DEF ... gecom001";

               |SELECT #1#labor001;
               |CIERRA #labor001;
               |ACABA;
          |FINSI;
*/
          |ABRE #gecom014@;

          |BUCLE gecom014;

          |CIERRA #gecom014@;

          ||DESCARGA_DEF #gecom001@;
          |DESCARGA_DEF #gecom014@;
     |FINSI;
     |SELECT #1#labor001;
     |CIERRA #labor001;
|FPRC;

|PROCESO TablaCtos;
|FPRC;

|PROCESO Banco0;

|FPRC;
