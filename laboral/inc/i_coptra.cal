|FICHEROS;
     labtraba #1;
     nomtraca #2;
     nomtrali #3;
     labpadre #4;
     nomvarca;
     nomcalca;
     nomcalli;
     nomconca;
     nomtraju;
     nombotra #11;
     nomabsca #12;
     nomabsli #13;
     labtracu;
     :/basica/def/agidanif #200;
     copiadef@ #500;
     nomhicca;
     nomembca;
     nomembli;
     nomembcf;

     Referen@;
|FIN;

|VARIABLES;
     campo1 = 0;
     campo2 = 0;
     campo3 = 0;
     campo4 = 0;
     FEstado = 0;

     emp_ori = 0;
     emp_des = 0;
     dtra_ori = 0;
     htra_ori = 0;
     tra_ori = 0;
     tra_des = 0;
     re_irpf = "";
     regraba = "";

     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     alfa4 = "";

     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     fFech1 = @;
     nEmprDestino = 0;
     nAnyo = 0;
     nDiasAlta = 0;
     nDiasIT = 0;
     nNume = 0;
     nNume1 = 0;
     nNume2 = 0;
     nConcepto = 0;
     nCampo = 0;
     swSigue = 0;

     nMes = 0;
     nAny = 0;
     aAny = "";
     aMes1 = "";
     aMes2 = "";
     aAny1 = "";
     aAny2 = "";
     nMes1 = 0;
     nAny1 = 0;

     nEmpOri = 0;
     nTraOri = 0;
     fNuevaFecha = @;
     &aNuevoTra = "";
     &swModulo = 0;
     &nEnEmpresa = 0;
     &eaFiniquito = "";

     nHandle = 0;
     swEmbargo = 0;
     aDNIOri = "";
|FIN;
____________________________________/ COPIA DE labtraba, nomtraca Y nomtrali
|PROCESO grabalin;
    #3#0 = emp_des;
    #3#1 = tra_des;
|GRABA 020#3n;
|FPRC;

|PROCESO leelinea;
|SI FEstado ! 0; |O regraba = "S";
        #2#0 = emp_ori;
        #2#1 = tra_ori;
    |LEE 000#2=;
    |SI FSalida = 0;
        |BUCLELIN 0grabalin#2;
    |FINSI;
|FINSI;
|FPRC;

|PROCESO grabacal;
    #2#0 = emp_des;
    #2#1 = tra_des;
|LEE 000#2=;                    || lee destino
    FEstado = FSalida;
|SI FEstado = 0; |Y regraba = "S";
    |BORRA 020#2a;              || borra destino existente
    |BUCLELIN 1NULL#2;
|FINSI;
    #2#0 = emp_ori;
    #2#1 = tra_ori;
|LEE 000#2=;                    || lee origen
|SI FSalida = 0;
        #2#0 = emp_des;
        #2#1 = tra_des;
    |GRABA 000#2n;              || graba destino
|FINSI;
|FPRC;

|PROCESO irpf;
     || el #0 es el nomtrapc, si se ejecuta desde la copia de empresa nomemppc
     || el #0#11 y el #0#12 vienen en blanco
     |ABRE #200;
     #200#0 = #0#11;
     #200#1 = 1;
     |LEE 101#200=;
     |SI FSalida = 0;
          #200#36 = #0#10;
          |GRABA 020#200a;
     |FINSI;
     |LIBERA #200;
     |CIERRA #200;
|FPRC;

|PROCESO Datos003145;
     |ABRE #500;
     #500#0 = emp_des;
     #500#1 = tra_des;
     |LEE 000#500=;                  || lee destino (para borrar si existe)
     FEstado = FSalida;
     #500#0 = emp_ori;
     #500#1 = tra_ori;
     |LEE 000#500=;                  || lee origen
     |SI FSalida = 0;
          #500#0 = emp_des;
          #500#1 = tra_des;
          |SI FEstado = 0;
               |SI regraba = "S";
                    |GRABA 020#500a;
               |FINSI;
          |SINO;
               |GRABA 020#500n;
          |FINSI;
     |FINSI;
     |LIBERA #500;
     |CIERRA #500;
|FPRC;

|PROCESO nomtraju;
     #nomtraju#0 = emp_des;
     #nomtraju#1 = tra_des;
     #nomtraju#2 = #nomtraju#2;
     |GRABA 020#nomtraju.n;
|FPRC;

|DEFBUCLE nomtraju;
     #nomtraju#1;
     ;
     emp_ori, tra_ori, 001;
     emp_ori, tra_ori, 999;
     ;
     NULL, nomtraju;
|FIN;
/*
|PROCESO graba_nombotra;
     |ABRE #11;
     #11#0 = emp_des;
     #11#1 = tra_des;
     |LEE 000#11=;                  || lee destino (para borrar si existe)
     FEstado = FSalida;
     #11#0 = emp_ori;
     #11#1 = tra_ori;
     |LEE 000#11=;                  || lee origen
     |SI FSalida = 0;
          #11#0 = emp_des;
          #11#1 = tra_des;
          |SI FEstado = 0;
               |SI regraba = "S";
                    |GRABA 020#11a;
               |FINSI;
          |SINO;
               |GRABA 020#11n;
          |FINSI;
     |FINSI;
     |LIBERA #11;
     |CIERRA #11;
|FPRC;
*/

|PROCESO nombotra
     #nombotra#0 = emp_des;
     #nombotra#1 = tra_des;
     #nombotra#2 = #nombotra#2;
     |GRABA 020#nombotra.n;
|FPRC;

|DEFBUCLE nombotra;
     #nombotra#1;
     ;
     emp_ori, tra_ori, 001;
     emp_ori, tra_ori, 999;
     ;
     NULL, nombotra;
|FIN;

/******************* GRABACION DE CTAS. POR TRABAJADOR **********************/

|PROCESO labtracu;
     #labtracu#0 = emp_des;
     #labtracu#1 = tra_des;
     #labtracu#2 = #labtracu#2;
     |GRABA 020#labtracu.n;
|FPRC;

|DEFBUCLE labtracu;
     #labtracu#1;
     ;
     emp_ori, tra_ori, 1;
     emp_ori, tra_ori, 3;
     ;
     NULL, labtracu;
|FIN;


/******************* GRABACION DE LOS EMBARGOS ******************************/

|PROCESO nomembcf;
     #nomembcf#0 = emp_des;
     #nomembcf#1 = tra_des;
     #nomembcf#2 = #nomembcf#2;
     |GRABA 020#nomembcf.n;
|FPRC;

|DEFBUCLE nomembcf;
     #nomembcf#1;
     ;
     emp_ori, tra_ori, 101;
     emp_ori, tra_ori, 999;
     ;
     NULL, nomembcf;
|FIN;

|PROCESO nomembli;
     #nomembli#0 = emp_des;
     #nomembli#1 = tra_des;
     #nomembli#2 = #nomembli#2;
     #nomembli#30 = 0;
     #nomembli#31 = 0;
     #nomembli#32 = 0;
     #nomembli#33 = 0;
     #nomembli#34 = 0;
     #nomembli#35 = 0;
     #nomembli#36 = 0;
     #nomembli#37 = 0;
     |GRABA 020#nomembli.n;
|FPRC;

|DEFBUCLE nomembli;
     #nomembli#1;
     ;
     emp_ori, tra_ori, 1999;
     emp_ori, tra_ori, 2999;
     ;
     NULL, nomembli;
|FIN;

|PROCESO graba_nomembca;
     |ABRE #nomembca;
     #nomembca#0 = emp_des;
     #nomembca#1 = tra_des;
     |LEE 000#11=;                  || lee destino (para borrar si existe)
     FEstado = FSalida;
     #nomembca#0 = emp_ori;
     #nomembca#1 = tra_ori;
     |LEE 000#nomembca.=;                  || lee origen
     |SI FSalida = 0; |Y aDNIOri = #0#11;
          aAlfa = "    SEl trabajador tiene asociado un embargo. ¿Duplicarlo ";
          aAlfa = aAlfa + "en la nueva ficha?";
          |CONFI aAlfa;
          |SI FSalida = 0;
               swEmbargo = 1;
          |FINSI;
     |FINSI;
     |SI swEmbargo = 1;
          #nomembca#0 = emp_des;
          #nomembca#1 = tra_des;
          |SI FEstado = 0;
               |SI regraba = "S";
                    |GRABA 020#nomembca.a;
               |FINSI;
          |SINO;
               |GRABA 020#nomembca.n;
          |FINSI;
     |FINSI;
     |LIBERA #nomembca;
     |CIERRA #nomembca;
|FPRC;

/****************************************************************************/

|PROCESO nomabsli;
     #nomabsli#0 = emp_des;
     #nomabsli#1 = tra_des;
     #nomabsli#2 = #nomabsli#2;
     |GRABA 020#nomabsli.n;
|FPRC;
/*
|DEFBUCLE nomabsli;
     #nomabsli#1;
     ;
     emp_ori, tra_ori, "01.01.1900";
     emp_ori, tra_ori, "31.12.2999";
     ;
     NULL, nomabsli;
|FIN;
*/
|PROCESO graba_nomabsca;
     |ABRE #12;
     #12#0 = emp_des;
     #12#1 = tra_des;
     |LEE 000#12=;                  || lee destino (para borrar si existe)
     FEstado = FSalida;
     #12#0 = emp_ori;
     #12#1 = tra_ori;
     |LEE 000#12=;                  || lee origen
     |SI FSalida = 0;
          |BUCLELIN 0nomabsli#12;
          #12#0 = emp_des;
          #12#1 = tra_des;
          |SI FEstado = 0;
               |SI regraba = "S";
                    |GRABA 020#12a;
               |FINSI;
          |SINO;
               |GRABA 020#12n;
          |FINSI;
     |FINSI;
     |LIBERA #12;
     |CIERRA #12;
|FPRC;

|PROCESO graba_complem;
     |ABRE #4;
     #4#0 = emp_des;
     #4#1 = tra_des;
     |LEE 000#4=;                  || lee destino (para borrar si existe)
     FEstado = FSalida;
     #4#0 = emp_ori;
     #4#1 = tra_ori;
     |LEE 000#4=;                  || lee origen
     |SI FSalida = 0;
          #4#0 = emp_des;
          #4#1 = tra_des;
          |SI FEstado = 0;
               |SI regraba = "S";
                    |GRABA 020#4a;
               |FINSI;
          |SINO;
               |GRABA 020#4n;
          |FINSI;
     |FINSI;
     |LIBERA #4;
     |CIERRA #4;
|FPRC;

|PROCESO dias_paga;
          |SALVA_FICHA #labtraba;

          #labtraba#0 = #0#0;
          #labtraba#1 = #0#3;
          |LEE 000#labtraba.=;

          aAlfa1 = #labtraba#36;
          aMes1 = aAlfa1 % 402;
          aAny1 = aAlfa1 % -104;

          aAlfa2 = #0#6;
          aMes2 = aAlfa2 % 402;
          aAny2 = aAlfa2 % -104;

          |SI aMes1 = aMes2; |Y aAny1 = aAny2;
               aAlfa1 = aAlfa1 % 102;
               nNume1 = aAlfa1;
          |SINO;
               nNume1 = 1;
          |FINSI;

          |ABRE #nomhicca;
          #nomhicca#0 = #0#0;
          #nomhicca#1 = #0#3;
          alfa1 = #labtraba#37;
          alfa1 = alfa1 % 402;
          nMes1 = alfa1;
          #nomhicca#2 = nMes1;
          #nomhicca#3 = 0;
          alfa1 = #labtraba#37;
          alfa1 = alfa1 % -104;
          nAny1 = alfa1;
          nAny1 = nAny1 - 2000;
          #nomhicca#66 = nAny1;
          |LEE 000#nomhicca.=;
          |SI FSalida = 0;    || ya esta actualizado en el historico
               |CIERRA #nomhicca;
               |REPON_FICHA #labtraba;
               |ACABA;        || los dias pasaran correctos
          |FINSI;
          |CIERRA #nomhicca;

          |REPON_FICHA #labtraba;

          aAlfa2 = aAlfa2 % 102;
          nNume2 = aAlfa2;

          nNume = nNume2 - nNume1;
          nDiasAlta = nNume;

          aAlfa = #0#6;
          aAlfa = aAlfa % 402;
          nMes = aAlfa;

          |ABRE #nomcalca;
          #nomcalca#0 = #0#0;
          #nomcalca#1 = #0#3;
          #nomcalca#2 = nMes;
          #nomcalca#3 = 0;
          |LEE 000#nomcalca.=;
          |SI FSalida = 0;
               nDiasIT = #nomcalca#31 + #nomcalca#32 + #nomcalca#65;
               nDiasAlta = nDiasAlta - nDiasIT;
               |SI nDiasAlta < 0;
                    nDiasAlta = 0;
               |FINSI;
          |SINO;
               aAlfa = "    ATENCION: El trabajador origen no tiene calculada ";
               aAlfa = aAlfa + "la nomina del mes.";
               |MENAV aAlfa;
               aAlfa = "    Los dias acumulados pagas del mes actual que pasaran al ";
               aAlfa = aAlfa + "nuevo trabajador pueden no ser correctos.";
               |MENAV aAlfa;

               campo1 = 108;       || desde dia
               campo2 = 4;         || desde mes
               campo3 = 116;       || hasta dia
               campo4 = 12;        || hasta mes
               |ABRE #nomconca;
               #nomconca#0 = #labtraba#87;
               |LEE 000#nomconca.=;
               |SI FSalida = 0;
                    |PARA nNume = 0; |SI nNume [ 7; |Y #nomconca#campo1# ! 0; |HACIENDO nNume = nNume + 1;
                         swSigue = 0;
                         campo1 = campo1 + nNume;
                         campo2 = campo2 + nNume;
                         campo3 = campo3 + nNume;
                         campo4 = campo4 + nNume;
                         |SI #nomconca#campo2# ] #nomconca#campo4#;
                              |SI #nomconca#campo2# [ nMes; |Y nMes [ 12;
                                   swSigue = 1;
                              |FINSI;
                              |SI 1 [ nMes; |Y nMes [ #nomconca#campo4#;
                                   swSigue = 1;
                              |FINSI;
                         |FINSI;
                         |SI #nomconca#campo2# [ nMes; |Y nMes [ #nomconca#campo4#;
                              swSigue = 1;
                         |FINSI;
                         |SI #nomconca#campo1# = 0;
                              swSigue = 0;
                         |FINSI;
                         |SI swSigue = 1;
                              nDiasAlta = nDiasAlta;
                              |SI nMes = #nomconca#campo2#;
                                   nDiasAlta = nDiasAlta - #nomconca#campo1# + 1;
                              |FINSI;
                              |SI nMes = #nomconca#campo4#;
                                   nDiasAlta = #nomconca#campo3# - nDiasAlta + 1;
                              |FINSI;
                              |SI nDiasAlta < 0;
                                   nDiasAlta = 0;
                              |FINSI;
                              nCampo = campo1 - 53;
                              #labtraba#nCampo# = #labtraba#nCampo# + nDiasAlta;
                         |FINSI;
                    |SIGUE;
               |FINSI;
               |CIERRA #nomconca;
               |CIERRA #nomcalca;
               |ACABA;
          |FINSI;

          |CIERRA #nomcalca;

          |ABRE #nomcalli;
          #nomcalli#0 = #0#0;
          #nomcalli#1 = #0#3;
          #nomcalli#2 = nMes;
          #nomcalli#3 = 0;
          |PARA nConcepto = 201; |SI nConcepto [ 208; |HACIENDO nConcepto = nConcepto + 1;
               #nomcalli#4 = nConcepto;
               |LEE 000#nomcalli.=;
               |SI FSalida = 0;
                    |SI #nomcalli#10 > 1;
                         nCampo = nConcepto - 151;
                         #labtraba#nCampo# = #labtraba#nCampo# + nDiasIT;
                         nCampo = nConcepto - 146;
                         #labtraba#nCampo# = #labtraba#nCampo# + nDiasAlta;
                    |FINSI;
               |FINSI;
          |SIGUE;
          |CIERRA #nomcalli;
|FPRC;

|PROCESO BuscaPaga;
     || el #0 es el nomtrapc, si se ejecuta desde la copia de empresa nomemppc
     || el #0#9 y el #0#12 vienen en blanco
     |SI #0#12 = "S"; |Y #0#9 = "N";         || un solo trabajador
          nEmpOri = #0#0;
          nTraOri = #0#3;
          fNuevaFecha = #0#6;
          |HAZ dias_paga;
     |FINSI;
     |SI #10#13 = "S"; |Y #0#9 = "S";        || copia masiva
          nEmpOri = #10#1;
          nTraOri = #10#2;
          fNuevaFecha = #10#7;
          |HAZ dias_paga;
     |FINSI;
|FPRC;

|PROCESO copia1;
     #500#0 = emp_des;
     #500#1 = tra_des;
     |GRABA 020#500.n;
|FPRC;

|DEFBUCLE copia1;
     #500#1002;
     ;
     emp_ori, tra_ori;
     emp_ori, tra_ori;
     ;
     NULL, copia1;
|FIN;

|PROCESO syke0014;
     #500#0 = emp_des;
     #500#1 = tra_des;
     |GRABA 020#500.n;
|FPRC;

|DEFBUCLE syke0014;
     #500#1005;
     ;
     emp_ori, tra_ori, "    ", 01, 001;
     emp_ori, tra_ori, "zzzz", 99, 999;
     ;
     NULL, syke0014;
|FIN;

|PROCESO syke0013;
     #500#0 = emp_des;
     #500#1 = tra_des;
     |GRABA 020#500.n;
|FPRC;

|DEFBUCLE syke0013;
     #500#1004;
     ;
     emp_ori, tra_ori, "    ", 01;
     emp_ori, tra_ori, "zzzz", 99;
     ;
     NULL, syke0013;
|FIN;

|PROCESO proceso;
     aNuevoTra = "";
     |HAZ carga_varios;

     #1#0 = emp_des;
     #1#1 = tra_des;
     |LEE 000#1=;                  || lee destino (para borrar si existe)
     FEstado = FSalida;
     |SI FEstado = 0; |Y regraba = "S";
          |BORRA 020#1a;            || borra destino trabajador
     |FINSI;
     #1#0 = emp_ori;
     #1#1 = tra_ori;
     |LEE 000#1=;                  || lee origen
     aDNIOri = #1#7;
     #1#0 = emp_des;
     #1#1 = tra_des;
     |HAZ campos_varios;
     |HAZ graba_complem;
     |BUCLE nombotra;
     |SI eaFiniquito = "";
          eaFiniquito = #labtraba#48;
     |FINSI;
     |SI eaFiniquito ! "S";
          |HAZ graba_nomabsca;
     |FINSI;
     |HAZ irpf;

     |ABRE #nomtraju;
     |BUCLE nomtraju;
     |CIERRA #nomtraju;

     swEmbargo = 0;
     |HAZ graba_nomembca;
     |SI swEmbargo = 1;
          |BUCLE nomembli;
          |BUCLE nomembcf;
     |FINSI;

     |BUCLE labtracu;

     nEnEmpresa = emp_des;
     |HAZ BuscaModulo;
     |SI swModulo = 3145;
          |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "def/bomb0009.mas";
          |CARGA_DEF aAlfa, copiadef@;
          |SI FSalida = 0;
               |HAZ Datos003145;
          |FINSI;
          |DESCARGA_DEF #copiadef@;
     |FINSI;
     |SI swModulo = 3462;
          |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "def/syke0013.mas";
          |CARGA_DEF aAlfa, copiadef@;
          |SI FSalida = 0;
               |BUCLE syke0013;
          |FINSI;
          |DESCARGA_DEF #copiadef@;

          |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "def/syke0014.mas";
          |CARGA_DEF aAlfa, copiadef@;
          |SI FSalida = 0;
               |BUCLE syke0014;
          |FINSI;
          |DESCARGA_DEF #copiadef@;
     |FINSI;
     |SI swModulo = 19; |O swModulo = 1;       || modulo de construccion
          |DBASE aAlfa; |QBF aAlfa; aAlfa = aAlfa + "def/aovi0011.mas";
          |CARGA_DEF aAlfa, copiadef@;
          |SI FSalida = 0;
               |BUCLE copia1;
          |FINSI;
          |DESCARGA_DEF #copiadef@;
     |FINSI;

     |HAZ BuscaPaga;
     |SI eaFiniquito = "";
          eaFiniquito = #labtraba#48;
     |FINSI;
     |MODULO aAlfa;
     |QBF aAlfa;
     |SI aAlfa ! "nomemppc";
          |SI eaFiniquito = "S";
               |PARA nCampo = 50; |SI nCampo [ 59; |HACIENDO nCampo = nCampo + 1;
                    #1nCampo = 0;
               |SIGUE;
               |PARA nCampo = 65; |SI nCampo [ 69; |HACIENDO nCampo = nCampo + 1;
                    #1nCampo = 0;
               |SIGUE;
               |PARA nCampo = 78; |SI nCampo [ 86; |HACIENDO nCampo = nCampo + 1;
                    #1nCampo = 0;
               |SIGUE;
          |FINSI;
     |FINSI;
     |GRABA 000#1n;                || graba destino
     |SI FSalida = 0;
          alfa1 = #1#0; alfa1 = ("00000" + alfa1) % -105;
          alfa2 = #1#1; alfa2 = ("00000" + alfa2) % -105;
          aNuevoTra = alfa1 + "." + alfa2;

          |DBASS aAlfa; |QBF aAlfa;
          aAlfa = aAlfa + "epresen/def/prequiva.mas";
          |XABRE "E", aAlfa, nHandle;
          |SI FSalida ] 0;
             |CARGA_DEF aAlfa, Referen@;
             |SI FSalida = 0;
                |DBASS aAlfa; |QBF aAlfa;
                aAlfa = aAlfa + "epresen/fich/"; |PATH_DAT #Referen@#aAlfa#;
                |ABRE #Referen@; |SELECT #2#Referen@; FSalida = 0;
                |PARA; |SI FSalida = 0; |HACIENDO;
                   #Referen@#1 = emp_ori;
                   #Referen@#2 = tra_ori;
                   |LEE 101#Referen@.=;
                   |SI FSalida = 0;
                      #Referen@#1 = emp_des;
                      #Referen@#2 = tra_des;
                      |GRABA 020#Referen@.a; |LIBERA #Referen@;
                   |FINSI;
                |SIGUE;
                |SELECT #1#Referen@; |CIERRA #Referen@;
                |DESCARGA_DEF #Referen@;
             |FINSI;
          |FINSI;
     |FINSI;
     |SI FEstado ! 0; |O regraba = "S";
          |HAZ grabacal;            || graba o regraba aux.trab.cabs.
          |HAZ leelinea;            || graba o regraba aux.trab.lins.
     |FINSI;
|FPRC;

|DEFBUCLE copiando;
 #1#1;
 ;
 emp_ori, dtra_ori;
 emp_ori, htra_ori;
 ;
 NULL, proceso;
|FIN;

|PROCESO tipo3;
|ABRE #1;
|ABRE #2;
|BUCLE copiando;
|HAZ ActOrigen;
|CIERRA #2;
|CIERRA #1;
|FPRC;
