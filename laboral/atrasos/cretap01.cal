|FICHEROS;
     cretap01 #0;

     || silcon06 #6;  || empresas silcon

     || tsilcon9,MANTE;      || tmp. centros

     tsilco14,MANTE;      || tmp. parrilla empresas
     tsilco15,MANTE;      || tmp. parrilla trabajadores

     labempre #10;        || empresas
     labtraba #12;        || trabajadores
     labcentr #16;        || centros de trabajo
     nomcenes #17;        || centros de trabajo especiales

     nomcalca;            || calculos cabs. (proceso mensual)
     nomcalli;            || calculos lins. (proceso mensual)
     nomhicca #19;        || calculos cabs. (proceso historico)
     nomhicli;            || calculos lins. (proceso historico)
     nomcalac;            || calculos cabs. (proceso atrasos)
     nomcalal;            || calculos cabs. (proceso atrasos)
     silcon15 #25;        || regimenes centros
     nomcontr #36;        || control aplicacion

     nombotra;
     nomconca;
     nomhisit;
     nombofca;
     nombofli;

     cretam01;
     cretam02;
     cretam03;
     cretam04;

     cretat04;
|FIN;

|VARIABLES;
     fech1 = @;
     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     alfa4 = "";
     nume1 = 0;
     nume2 = 0;
     enAny = 0;
     p_mes = 0;
     traba = 0;
     nMarcarT = 0;
     nMarcarE = 0;
     sw_parrilla = 0;
     aAviso = "";
     FEstado = 0;
     clave = "";
     sw_auxil = 0;
     linea = 0;
     aRegimen = "";
     aParam = "";
     aAlfa = "";
     aAlfa0 = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aAlfa4 = "";
     aLibre = "";
     aReser = "";
     for_fecha = "";
     for_hora = "";
     fichero = "";
     extension = "";
     indica = "";
     swStop = 0;
     nEmp = 0;
     nTra = 0;
     any_hist = 0;
     tipo_bot = 0;
     tipo_top = 0;
     nElAny = 0;
     nElMes = 0;
     enDesCen = 0;
     enHasCen = 0;
     eaFuente = "";

     ajuste1 = "";
     ajuste2 = "";
     ajuste3 = "";
     alfa = "";
     error = 0;
     ind = 0;
     long = 0;
     posi = 0;
     digito = "";
     texto = "";
     mascara = "";
     i = 0;
     j = 0;
     nCampo = 0;
     nTipo = 0;
     nTipoNominas = 0;
     descom = "";
     entero = "";
     decima = "";
     elsw1 = 0;
     para1 = 0;
     nNume = 0;
     cadena = "";
     swRepite = 0;
     aCCC = "";
     nConcepto = 0;
     nConceptoRED = 0;
     nImporte = 0;
     nConvenio = 0;
     aIndicativo = "";
     aDescripcion = "";
     aTipoPaga = "";
     nUnidades = 0;
     nUnidadesCal = 0;
     nPrecio = 0;
     nBrutoMenosPrest = 0;
     nMesAtrasos = 0;
     nDesdeMes = 0;
     nHastaMes = 0;
     nMesHist = 0;
     swSigue = 0;
     aAntNroAfil = "";
     aAntCCC ="";
     aAntCen ="";
     nNroEmpresas = 0;
     nNroTrabaj = 0;
     nAntEmp = 0;
     nBrutoTrab = 0;
     nPagasProrr = 0;

     &s_ori = "";
     &s_tat = 0;
     &s_ele = "";
     &s_any = 0;
     &s_mes = 0;
     &s_has = 0;
     &s_anyl = 0;
     &s_sel = "";
     &s_lotecra = 0;
     &s_fichcra = "";

     nNroTras = 0;
     nAntEmpCon = 0;
     nTotEmp = 0;
     nImporteFin = 0;

     aCadena = "";
     aCadenaSal = "";
     nEspacio = 0;
     aLon = "";
     nLon = 0;
     nBlancos = 0;
     nBlancosIzd = 0;
     nBlancosDer = 0;
     aBlancosIzd = "";
     aBlancosDer = "";

     &s_num = 0;
     &s_fich = "";
     topemes = 0;
     nMes = 0;
     aMes = "";
     aAny = "";
     aFecha = "";
     fIniMes = @;
     fFinMes = @;
     fFechaIniMes = @;
     fFechaFinMes = @;
     nFechaIniMes = 0;
     nFechaFinMes = 0;
     aFechaIniMes = "";
     aFechaFinMes = "";
     fFechaAlta = @;
     fFechaBaja = @;
     nFechaAlta = 0;
     nFechaBaja = 0;
     nNume1 = 0;
     nNume2 = 0;
     nDias = 0;
     nDiasAlta = 0;
     &enLote = 0;
     &eaFich = "";
     &eaExt = "";
     swPosibleError = 0;
     nDesdeTra = 0;
     nHastaTra = 0;
     swHayAlguno = 0;
     nAny = 0;
     nAnyXX = 0;
     aCentroNom = "":
     fFechaIniPer = @;
     fFechaFinPer = @;
     aFechaIniPer = "";
     aFechaFinPer = "";

     fFechaIniTramo = @;
     nFechaIniTramo = 0;
     aFechaIniTramo = "";
     fFechaFinTramo = @;
     nFechaFinTramo = 0;
     aFechaFinTramo = "";

     nBase = 0;
     nLinea = 0;
     aLinea = "";
     nCampo1 = 0;
     nCampo2 = 0;
     nCampo3 = 0;
     aTipo = "";
     nDesde = 0;
     nHasta = 0;
     nCodTipo = 0;
     aDesTipo = "";
     swDesde = 0;
     swHasta = 0;
     aFechaBusca = "";
     fFechaBusca = @;
     aContrato = "";
     nGrupoCot = 0;
     nCategoria = 0;
     aOcupacion = "";
     nHoras = 0;
     aNif = "";
     nVez = 0;
     nFechaIniPer = 0;
     nFechaFinPer = 0;
     nBonifMan = 0;
     nBonifFom = 0;
     aFechaIniBon = "";
     fFechaIniBon = @;
     aFechaFinBon = "";
     fFechaFinBon = @;
     swGraba = 0;
     swGrabado = 0;
     swPrest = 0;
     fFecha = @;
     nFecha = 0;
     nUltima = 0;
     aNAFSS = "";
     nLineaAjuste = 0;
     nUltimoTramoAlta = 0;
     nUltimoTramoIT = 0;
     nCodTipoAnt = 0;
     nLineaAnt = 0;
     nDiasCot = 0;
     aFechaAlta = "";
     aFechaBaja = "";
     swMarca52 = 0;
     swRegrabado = 0;
     swHay = 0;

     nBaseComunes_Alta = 0;
     nBaseATEP_Alta = 0;
     nBaseEnfAcc = 0;
     nBaseMat = 0;
     nBasePat = 0;
     nBaseRie = 0;
     nBaseCon = 0;
     nBaseERE = 0;
     nBaseHorasFM = 0;
     nBaseHorasOtras = 0;
     nNumHorasComp = 0;
     aSituacion = "";
     nCodigo = 0;
     nUltimoCodigo = 0;

     nDiasEnf = 0;
     nDiasAcc = 0;
     nDiasMat = 0;
     nDiasPat = 0;
     nDiasRie = 0;
     nDiasCon = 0;
     nDiasERE = 0;
     nPropERE = 0;
     aUltimaIT = "";
     nAjuste = 0;
     nDiasCotAlta = 0;
     nDiasCotIT = 0;
     nPrestEnf = 0;
     nPrestAcc = 0;
     nBases = 0;
     nDiasTramo = 0;
     nDiasNatTramo = 0;
     nPropTramo = 0;
     swPrest52 = 0;
     swPrest53 = 0;
     nPromedioCC = 0;
     nPromedioATEP = 0;
     nBaseDiariaERE = 0;
     nDiasMesTrab = 0;
     nDiaIT = 0;
     nDiasAcumIT = 0;
     nDiasAcumEnf = 0;
     nDias60 = 0;
     nDias75 = 0;
     nHastaReal = 0;
     nIndicador = 0;
     nCodigoHoras = 0;
     swTopeMin = 0;
     nNumHorasFor = 0;
     aTipoHorasFor = "";
     nAcumHorasFor = 0;
     nAcumHorasComp = 0;

     swCuenta = 0;
     nTrabEmp = 0;
     nTotalTra = 0;
     aTotalTra = "";
     nNroTra = 0;
     nTotalEmp = 0;
     aTotalEmp = "";
     nNroEmp = 0;
     swFinPeriodo = 0;
     swUltimoDiaIT = 0;

     nDiasAltaNIF = 0;
     fFecha1 = @;
     fFecha2 = @;
     nFecha1 = 0;
     nFecha2 = 0;
     nNroCCCs = 0;
     nCodigoIniIT = 0;
     nCodigoFinIT = 0;

     nJornadasIT = 0;
     nPrestManEnf = 0;
     nPrestManAcc = 0;

     swDiferente = 0;
     nMesAnt = 0;
     swIniPeriodo = 0;
     swTramoUnSoloDia = 0;
     nDiasRecaida = 0;
     swCentroFormacion = 0;

     nDesdeTipo = 0;
     nHastaTipo = 0;
     nDiasVac1 = 0;
     nDiasVac2 = 0;

     nDias99 = 0;  || para las L13
     nMes99 = 0;
     nAny99 = 0;

     nBonifFormCont = 0;
     swAsignada = 0;

     nDiaDesde = 0;
     nDiaHasta = 0;
     fFechaHastaTra = @;
     fFechaHastaPer = @;
     nDiaHastaMasUno = 0;

     nEmpAnt = 0;
     nTraAnt = 0;
|FIN;

/****************************************************************************/
/****************      PROCESOS DESDE LA PANTALLA   *************************/
/****************************************************************************/

|PROCESO MesHasta; |TIPO 7;
     |SI #0#4 < #0#1;
          #0#4 = #0#1;
          |PINTA #0#4;
     |FINSI;
|FPRC;

|PROCESO CompMesHasta;
     |SI #0#4 < #0#1;
          |MENAV "    ATENCION: el 'mes hasta' no puede ser mayor que el 'mes desde'";
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Mensa18; |TIPO 7;
     |SI #0#3 = "M"; |O #0#3 = "H";
          |MENSA "    Introduzca el año de abono de las nominas";
     |FINSI;
     |SI #0#3 = "A";
          |MENSA "    Introduzca el año al que corresponden los atrasos.";
     |FINSI;
     |SI #0#3 = "T";
          |MENSA "    Introduzca el año donde se encuentran grabados los atrasos en el histórico";
     |FINSI;
|FPRC;

|PROCESO topemes;     || halla el ultimo dia del mes
     nume2 = 0;
     nume1 = nAny $ 4;    || a¤o historico
     |SI nume1 = 0;
          nume2 = 1;
     |FINSI;
     topemes = 31;
     |SI nMes = 2;
          topemes = 28 + nume2;
     |FINSI;
     |SI nMes = 4; |O nMes = 6; |O nMes = 9; |O nMes = 11;
          topemes = 30;
     |FINSI;
|FPRC;

|PROCESO AyudaTipos; |TIPO 7;
     |PUSHV 08552380;
     |ATRI R;
     ||            5    6         7         8
     ||            56789012345678901234567890
     |PINTA 0855, "       - Opciones -       ";
     |PINTA 0955, " 00 :Normal               ";
     |PINTA 1055, " 02 :Finiquitos           ";
     |PINTA 1155, "5-20:Atrasos              ";
     |PINTA 1255, " 98 :Salarios de tramita- ";
     |PINTA 1355, "     ci¢n                 ";
     |PINTA 1455, "                          ";
     |ATRI 0;
|FPRC;

|PROCESO Restaura; |TIPO 0;
     |POPV;
|FPRC;

|PROCESO defectoMesAny;
     fech1 = ~;
     alfa1 = fech1;
     alfa1 = alfa1 % 402;          || MES
     nume1 = alfa1;

     alfa2 = fech1;
     alfa2 = alfa2 % -104;
     nume2 = alfa2;                || A¥O

     |SI nume1 = 1;
         #0#0 = nume2 - 1;
         #0#1 = 12;
     |SINO;
         #0#0 = nume2;
         #0#1 = nume1 - 1;
     |FINSI;
     #0#6 = #0#0;
     #0#4 = #0#1;

     |PINTA #0#0;
     |PINTA #0#1;
     ||PINTA #0#6;
     ||PINTA #0#4;

     ||HAZ mirames;
|FPRC;

|PROCESO elAnyo; |TIPO 0;
     enAny = #0#0;
|FPRC;

|PROCESO mirames;
     |SI #0#3 ! "A";|Y #0#3 ! "T"; |Y #0#3 ! "C";
          fech1 = ~;
          alfa1 = fech1;
          alfa1 = alfa1 % 402;
          nume1 = alfa1;
          alfa2 = fech1;
          alfa2 = alfa2 % -104;
          nume2 = alfa2;

          |SI nume1 = 1;
              #0#1 = 12;
              #0#4 = 12;
          |SINO;
              #0#1 = nume1 - 2;
              #0#4 = nume1 - 2;
          |FINSI;

          |PINTA #0#1;
          |PINTA #0#4;
     |FINSI;
|FPRC;

|PROCESO pintames; |TIPO 0;
     |SI #0Campo =  1;  p_mes = "ENERO     ";  |FINSI;
     |SI #0Campo =  2;  p_mes = "FEBRERO   ";  |FINSI;
     |SI #0Campo =  3;  p_mes = "MARZO     ";  |FINSI;
     |SI #0Campo =  4;  p_mes = "ABRIL     ";  |FINSI;
     |SI #0Campo =  5;  p_mes = "MAYO      ";  |FINSI;
     |SI #0Campo =  6;  p_mes = "JUNIO     ";  |FINSI;
     |SI #0Campo =  7;  p_mes = "JULIO     ";  |FINSI;
     |SI #0Campo =  8;  p_mes = "AGOSTO    ";  |FINSI;
     |SI #0Campo =  9;  p_mes = "SEPTIEMBRE";  |FINSI;
     |SI #0Campo = 10;  p_mes = "OCTUBRE   ";  |FINSI;
     |SI #0Campo = 11;  p_mes = "NOVIEMBRE ";  |FINSI;
     |SI #0Campo = 12;  p_mes = "DICIEMBRE ";  |FINSI;
     |PINTA 0843, p_mes;
|FPRC;

|PROCESO AnyLote;
     |SI #0#3 = "M"; |O #0#3 = "H";
          #0#6 = #0#0;
     |FINSI;
|FPRC;

|PROCESO ValorCampos;
     |SI #0#3 = "A"; |O #0#3 = "T";
          |SI #0#5 < 5;
               #0#5 = 5;
               |PINTA #0#5;
          |FINSI;
     |SINO;
          |SI #0#5 > 2;
               #0#5 = 0;
               |PINTA #0#5;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ActivaCampos;
     |SI #0#3 = "A"; |O #0#3 = "T";
          |CAMPO_MODIFICA #0#4, 1, "S";
          |CAMPO_VISUAL #0#4, 1, "S";
          |PINTA 1148, "-    ";
          |PINTA #0#4;
          |SI #0#3 = "A";
               |CAMPO_MODIFICA #0#5, 1, "N";
               #0#5 = 05;
               |PINTA #0#5;
          |SINO;
               |CAMPO_MODIFICA #0#5, 1, "S";
          |FINSI;
     |SINO;
          |CAMPO_MODIFICA #0#4, 1, "N";
          |CAMPO_VISUAL #0#4, 1, "N";
          |PINTA 1148, "     ";

          |CAMPO_MODIFICA #0#5, 1, "S";
     |FINSI;
|FPRC;

|PROCESO PintaPantalla; |TIPO 7;
     |HAZ ActivaCampos;
|FPRC;

|PROCESO notipo;
     |SI #0#3 ! "A";
          |C_M #0#5, 1, "S";
          |SI #0#3 = "M";|O #0#3 = "H";    #0#5 = 0;     |FINSI;
          |SI #0#3 = "T";                   #0#5 = 5;     |FINSI;
          |PINTA #0#5;
     |SINO;
          |C_M #0#5, 1, "N";
          #0#5 = 5;
          |PINTA #0#5;
     |FINSI;
|FPRC;

|PROCESO cheq_tipo; |TIPO 0;
     swSigue = 0;
     |SI #0#5 = 0; |O #0#5 = 2; |O #0#5 = 98;
          swSigue = 1;
     |FINSI;
     |SI 5 [ #0#5; |Y #0#5 [ 20;
          swSigue = 1;
     |FINSI;
     |SI swSigue = 0;
          |MENAV "    Tipo de nómina no permitido";
          |ERROR;
     |FINSI;

     |SI #0#3 = "M"; |O #0#3 = "H";
          |SI #0Campo ! 0; |Y #0Campo ! 2; |Y #0Campo ! 98;
               aAviso = "0000En Procesos Mensual o Histórico sólo se admiten "
               aAviso = aAviso + "los tipos 0, 2 y 98";
               |MENAV aAviso;
               |ERROR;
          |FINSI;
     |FINSI;
     |SI #0#3 = "T";
          |SI #0Campo < 5; |O #0Campo > 20;
               aAviso = "0000En Proceso Atrasos desde Histórico sólo se admiten "
               aAviso = aAviso + "los tipos del 5 al 20";
               |MENAV aAviso;
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;

/****************************************************************************/
/******* PROCESOS PARA COMPROBAR SI EXISTEN TRABAJADORES EN LA SELECCION ****/
/************ QUE ESTOY HACIENDO CALCULADOS EN LOS MANTENIEMIENTOS **********/
/****************************************************************************/

/****************************************************************************/
/*********** PROCESOS PARA LA SELECCION DE EMPRESAS Y TRABAJADORES **********/
/****************************************************************************/

|PROCESO Repetir;
     swRepite = 0;
     |SI #0#3 = "R";
          |LEE 000#0p;
          |SI FSalida = 0;
               swRepite = 1;
               |PINDA #0#0;
               alfa1 = Usuario; |QBT alfa1;    alfa1 = ("t" + alfa1) % 108;
               alfa2 = Usuario; |QBT alfa2;    alfa2 = ("u" + alfa2) % 108;
               alfa3 = Usuario; |QBT alfa3;    alfa3 = ("v" + alfa2) % 108;
               |NOME_DAT #tsilco14#alfa1#;
               |NOME_DAT #tsilco15#alfa2#;
               ||NOME_DAT #tsilcon9#alfa3#;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO comp;
     |SI nTipo ! 2;
          swHayAlguno = 1;
          |ERROR10;
     |FINSI;
     |SI nTipo = 2;
          |SI eaFuente = "M";
               |SI #nomcalca#39 ! 0;
                    swHayAlguno = 1;
                    |ERROR10;
               |FINSI;
          |FINSI;
          |SI eaFuente = "H";
               |SI #nomhicca#39 ! 0;
                    swHayAlguno = 1;
                    |ERROR10;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE comp_nomcalac;
     #nomcalac#1;
     ;
     nEmp, nDesdeTra, nDesdeMes, nTipo;
     nEmp, nHastaTra, nHastaMes, nTipo;
     ;
     NULL, comp;
|FIN;

|DEFBUCLE comp_nomhicca;
     #nomhicca#1;
     ;
     nEmp, nDesdeTra, nAnyXX, nDesdeMes, nTipo;
     nEmp, nHastaTra, nAnyXX, nHastaMes, nTipo;
     ;
     NULL, comp;
|FIN;

|DEFBUCLE comp_nomcalca;
     #nomcalca#1;
     ;
     nEmp, nDesdeTra, nDesdeMes, nTipo;
     nEmp, nHastaTra, nHastaMes, nTipo;
     ;
     NULL, comp;
|FIN;

|PROCESO CargaEmp;
     swHayAlguno = 0;
     |SI eaFuente = "M";
          |BUCLE comp_nomcalca;
     |FINSI;
     |SI eaFuente = "H";
          |BUCLE comp_nomhicca;
     |FINSI;
     |SI eaFuente = "A";
          |BUCLE comp_nomcalac;
     |FINSI;
     |SI eaFuente = "T";
          |BUCLE comp_nomhicca;
     |FINSI;
|FPRC;

|PROCESO reenvio1;
     nDesdeMes = #0#1;
     |SI eaFuente = "M"; |O eaFuente = "H";
          nHastaMes = #0#1;
     |SINO;
          nHastaMes = #0#4;
     |FINSI;
     nAny = #0#0;
     nAnyXX = #0#0 - 2000;
     nTipo = #0#5;
     nDesdeTra = 00001;
     nHastaTra = 99999;

     |SI #labempre#67 = "S";
          swHayAlguno = 0;
          nEmp = #labempre#0;

          |HAZ CargaEmp;
          |SI swHayAlguno = 1;
               |DDEFECTO #tsilco14;
               #tsilco14#0 = #labempre#0;
               #tsilco14#1 = #labempre#2;
               #tsilco14#2 = " ";
               |GRABA 020#tsilco14.n;
               |LIBERA #tsilco14;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE reenvio;
     #labempre#1;
     ;
         1;
     99999;
     ;
     NULL, reenvio1;
|FIN;

|PROCESO min14;
    #tsilco14#0 = 00001;
|FPRC;

|PROCESO max14;
    #tsilco14#0 = 99999;
|FPRC;

|PROCESO parrilla; |TIPO 0;
     |SI FSalida = 2;    || no si pulso la flecha arriba
          |ACABA;
     |FINSI;

     |SI #0#2 = "S";
          |ATRI P;   |MENSA "    Cargando seleccion ...";    |ATRI 0;
          alfa1 = Usuario; |QBT alfa1;    alfa1 = ("t" + alfa1) % 108;
          alfa2 = Usuario; |QBT alfa2;    alfa2 = ("u" + alfa2) % 108;
          alfa3 = Usuario; |QBT alfa3;    alfa3 = ("v" + alfa2) % 108;
          |NOME_DAT #tsilco14#alfa1#;
          |NOME_DAT #tsilco15#alfa2#;
          || NOME_DAT #tsilcon9#alfa3#;
          |DELINDEX #tsilco14;
          |DELINDEX #tsilco15;
          || DELINDEX #tsilcon9;

          |ABRE #labempre;
          |ABRE #tsilco14;
          ||ABRE #tsilcon9;

          eaFuente = #0#3;
          |BUCLE reenvio;

          ||CIERRA #tsilcon9;
          |CIERRA #labempre;
          |CIERRA #tsilco14;
          |ATRI R;
          |BLIN 4;
          |ATRI 0;
          sw_parrilla = 1;

          |PUSHV 0501 2380;
          |ENTLINEAL #1#tsilco14, 1, 4, 22, 1, min14, max14;
          |POPV;
     |FINSI;
|FPRC;


/****************************************************************************/
/******************* PROCESOS PARA LA GRABACION DE BASES ********************/
/****************************************************************************/

|PROCESO GrabaBaseIT;
     |SI #cretam04#27 = "ETP";
          || antes he grabado la parte de alta, continuo por aqui sin reiniciar
          || el codigo de la base
     |SINO;
          nBases = 30;
     |FINSI;
     nCodigoHoras = 60;
     nDiasTramo = #cretam04#22;
     nNume1 = #cretam04#8;
     nNume2 = #cretam04#9;
     nDiasNatTramo = nNume2 - nNume1 + 1;
     |SI #cretam04#27 = "ENF"; nPropTramo = nDiasTramo / nDiasEnf; |FINSI;
     |SI #cretam04#27 = "ACC"; nPropTramo = nDiasTramo / nDiasAcc; |FINSI;
     |SI #cretam04#27 = "MAT"; nPropTramo = nDiasTramo / nDiasMat; |FINSI;
     |SI #cretam04#27 = "PAT"; nPropTramo = nDiasTramo / nDiasPat; |FINSI;
     |SI #cretam04#27 = "RIE"; nPropTramo = nDiasTramo / nDiasRie; |FINSI;
     |SI #cretam04#27 = "ERE"; nPropTramo = nDiasTramo / nDiasERE; |FINSI;
     |SI #cretam04#27 = "ETP";
          nPropTramo = nDiasTramo * (nPropERE / 100) / nDiasERE;
     |FINSI;
     |SI #cretam04#27 = "CON"; nPropTramo = nDiasTramo / nDiasCon; |FINSI;

/*   no se envian las horas en los tramos en IT de los trabajadores
     a tiempo parcial

     || HORAS TIEMPO PARCIAL
     |SI #cretam04#24 ! 0;
     |Y #cretam04#25 = "N"; |Y #cretam04#26 = "N";
          #cretam04#nCodigoHoras# = 01;
          nCodigoHoras = nCodigoHoras + 1;
          #cretam04#nCodigoHoras# = #cretam04#24;
          nCodigoHoras = nCodigoHoras + 1;
     |FINSI;
*/
     swPrest = 0;
     swPrest52 = 0;
     swPrest53 = 0;
     |SI #cretam04#27 = "ENF"; |O #cretam04#27 = "ACC";
          |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
               nCampo = ((nVez - 1) * 2) + 10;
               |SI #cretam04#nCampo# = 102; |O #cretam04#nCampo# = 111;
                    swPrest = 1;
               |FINSI;
               |SI #cretam04#nCampo# = 052;
                    swPrest52 = 1;
               |FINSI;
               |SI #cretam04#nCampo# = 053;
                    swPrest53 = 1;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI #labtraba#42 = "A"; |O #labtraba#42 = "E";
          swPrest = 0;
          swPrest52 = 0;
          swPrest53 = 0;
     |FINSI;
/* cambio sistema: esto en verdad, ya no me sirve
     |SI swPrest52 = 1;
          #cretam04#nBases# = 563;
          nBases = nBases + 1;

          || ahora hay que saber en que dias estamos de la enfermedad para
          || saber si corresponde el 60% o el 75 % de la prestacion

          nNume2 = #cretam04#28 + nDiasTramo - 1;

          nDias60 = 0;
          nDias75 = 0;
          |PARA nNume1 = #cretam04#28; |SI nNume1 [ nNume2; |HACIENDO nNume1 = nNume1 + 1;
               |SI 16 [ nNume1; |Y nNume1 [ 20;
                    nDias60 = nDias60 + 1;
               |FINSI;
               |SI nNume1 ] 21;
                    nDias75 = nDias75 + 1;
               |FINSI;
          |SIGUE;

          #cretam04#nBases# = nDias60 * ((nPromedioCC % 60) ! 2);
          #cretam04#nBases# = #cretam04#nBases# + (nDias75 * ((nPromedioCC % 75) ! 2));

          nBases = nBases + 1;
          |ACABA;
     |FINSI;

     |SI swPrest53 = 1;
          #cretam04#nBases# = 663;
          nBases = nBases + 1;
          #cretam04#nBases# = nDiasNatTramo * ((nPromedioATEP % 75) ! 2);
          nBases = nBases + 1;
          |ACABA;
     |FINSI;

     || si es el tramo de un dia de los mensuales grupo 8, aqui no
     || tiene que haber bases, solo prestacion si existe

     |SI #cretam04#25 = "S";
          |ACABA;
     |FINSI;
*/

     || primero el codigo de la base de CC en IT
     |SI #cretam04#27 = "ENF"; |O #cretam04#27 = "ACC";
          #cretam04#nBases# = 500;
          nBases = nBases + 1;
     |FINSI;
     |SI #cretam04#27 = "MAT"; |O #cretam04#27 = "PAT"; |O #cretam04#27 = "RIE";
     |O #cretam04#27 = "ERE"; |O #cretam04#27 = "CON";
          #cretam04#nBases# = 509;
          nBases = nBases + 1;
     |FINSI;
     |SI #cretam04#27 = "ETP";
          #cretam04#nBases# = 536;
          nBases = nBases + 1;
     |FINSI;

     || ahora el importe de la base de CC en IT

     |SI #cretam04#27 = "ERE"; |O #cretam04#27 = "ETP";
          #cretam04#nBases# = nPropTramo * nBaseERE;
     |SINO;
          |SI #labtraba#42 = "A"; |O #labtraba#42 = "E";
               #cretam04#nBases# = (nJornadasIT * nPromedioCC);
          |SINO;
               #cretam04#nBases# = (nDiasTramo * nPromedioCC);
          |FINSI;
     |FINSI;

     || si es cero no me grabes nada
     |SI #cretam04#nBases# = 0;
          nBases = nBases - 1;
          #cretam04#nBases# = 0;
     |SINO;
          nBases = nBases + 1;
     |FINSI;

     || ahora el codigo de la base de CP en IT

     #cretam04#nBases# = 603;
     |SI #cretam04#27 = "ETP";
          #cretam04#nBases# = 636;
     |FINSI;
     nBases = nBases + 1;

     || ahora el importe de la base de CP en IT

     #cretam04#nBases# = (nDiasTramo * nPromedioATEP);
     |SI #cretam04#27 = "ERE"; |O #cretam04#27 = "ETP";
          #cretam04#nBases# = nPropTramo * nBaseERE;
     |SINO;
          |SI #labtraba#42 = "A"; |O #labtraba#42 = "E";
               #cretam04#nBases# = (nJornadasIT * nPromedioATEP);
          |SINO;
               #cretam04#nBases# = (nDiasTramo * nPromedioATEP);
          |FINSI;
     |FINSI;

     || igual que las CC: en CP si es cero no me grabes nada
     |SI #cretam04#nBases# = 0;
          nBases = nBases - 1;
          #cretam04#nBases# = 0;
     |SINO;
          nBases = nBases + 1;
     |FINSI;

     |SI swPrest = 1;
          |SI #cretam04#27 = "ENF";
               #cretam04#nBases# = 563;
               nBases = nBases + 1;

               || ahora hay que saber en que dias estamos de la enfermedad para
               || saber si corresponde el 60% o el 75 % de la prestacion

               nNume2 = #cretam04#28 + nDiasNatTramo - 1;

               nDias60 = 0;
               nDias75 = 0;
               |PARA nNume1 = #cretam04#28; |SI nNume1 [ nNume2; |HACIENDO nNume1 = nNume1 + 1;
                    |SI 16 [ nNume1; |Y nNume1 [ 20;
                         nDias60 = nDias60 + 1;
                    |FINSI;
                    |SI nNume1 ] 21;
                         nDias75 = nDias75 + 1;
                    |FINSI;
               |SIGUE;

               #cretam04#nBases# = nDias60 * ((nPromedioCC % 60) ! 2);
               #cretam04#nBases# = #cretam04#nBases# + (nDias75 * ((nPromedioCC % 75) ! 2));

               nBases = nBases + 1;
          |FINSI;
          |SI #cretam04#27 = "ACC";
               #cretam04#nBases# = 663;
               nBases = nBases + 1;

               #cretam04#nBases# = nDiasNatTramo * ((nPromedioATEP % 75) ! 2);
               nBases = nBases + 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaBaseAlta;
     nBases = 30;
     nCodigoHoras = 60;

     nPropTramo = #cretam04#22 / nDiasCotAlta;
     |SI #cretam04#27 = "ETP";
          nPropTramo = (#cretam04#22 * (100 - nPropERE) / 100) / nDiasCotAlta;
     |FINSI;

     || HORAS TIEMPO PARCIAL
     |SI #cretam04#24 ! 0;
          #cretam04#nCodigoHoras# = 01;
          nCodigoHoras = nCodigoHoras + 1;
          #cretam04#nCodigoHoras# = #cretam04#24;
          nCodigoHoras = nCodigoHoras + 1;
     |FINSI;

     || HORAS COMPLEMENTARIAS
     |SI nNumHorasComp ! 0;
          #cretam04#nCodigoHoras# = 02;
          nCodigoHoras = nCodigoHoras + 1;
          |SI #cretam04#6 = nUltimoTramoAlta;
               #cretam04#nCodigoHoras# = nNumHorasComp - nAcumHorasComp;
          |SINO;
               nNume = nPropTramo * nNumHorasComp;
               nNume = (nNume - 0.49) ! 0;
               #cretam04#nCodigoHoras# = nNume;
          |FINSI;
          nAcumHorasComp = nAcumHorasComp + nNume;
     |FINSI;

     || HORAS BONIFICADAS FORMACION
     |SI nNumHorasFor ! 0;
          |SI aTipoHorasFor = "D";
               #cretam04#nCodigoHoras# = 04;
          |SINO;
               #cretam04#nCodigoHoras# = 03;
          |FINSI;
          nCodigoHoras = nCodigoHoras + 1;
          |SI #cretam04#6 = nUltimoTramoAlta;
               #cretam04#nCodigoHoras# = nNumHorasFor - nAcumHorasFor;
          |SINO;
               nNume = nPropTramo * nNumHorasFor;
               nNume = (nNume - 0.49) ! 0;
               #cretam04#nCodigoHoras# = nNume;
          |FINSI;
          nAcumHorasFor = nAcumHorasFor + nNume;
     |FINSI;

     || HORAS TRABAJADAS EN ERE PARCIAL
     |SI #cretam04#27 = "ETP";
          #cretam04#nCodigoHoras# = 01;
          nCodigoHoras = nCodigoHoras + 1;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
               #cretam04#nCodigoHoras# = (#cretam04#22 * (100 - nPropERE) / 100) * #labtraba#47;
          |SINO;
               |ABRE #nomconca;
               #nomconca#0 = #labtraba#87;
               |LEE 000#nomconca.=;
               |CIERRA #nomconca;

               #cretam04#nCodigoHoras# = (#cretam04#22 * (100 - nPropERE) / 100) * ((#nomconca#162 / 7) ! 2);
          |FINSI;
          nCodigoHoras = nCodigoHoras + 1;

          #cretam04#nCodigoHoras# = 05;
          nCodigoHoras = nCodigoHoras + 1;
          #cretam04#nCodigoHoras# = nPropERE;
          nCodigoHoras = nCodigoHoras + 1;
     |FINSI;

     #cretam04#nBases# = 500;
     nBases = nBases + 1;
     #cretam04#nBases# = (nBaseComunes_Alta * nPropTramo) ! 2;
     nBases = nBases + 1;

     #cretam04#nBases# = 601;
     nBases = nBases + 1;
     #cretam04#nBases# = (nBaseATEP_Alta * nPropTramo) ! 2;
     nBases = nBases + 1;

     |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
          nNume = nBaseHorasFM + nBaseHorasOtras;
          |SI nNume ! 0;
               #cretam04#nBases# = 537;
               nBases = nBases + 1;
               #cretam04#nBases# = (nNume * nPropTramo) ! 2;
               nBases = nBases + 1;
          |FINSI;
     |SINO;
          |SI nBaseHorasFM ! 0;
               #cretam04#nBases# = 501;
               nBases = nBases + 1;
               #cretam04#nBases# = (nBaseHorasFM * nPropTramo) ! 2;
               nBases = nBases + 1;
          |FINSI;
          |SI nBaseHorasOtras ! 0;
               #cretam04#nBases# = 502;
               nBases = nBases + 1;
               #cretam04#nBases# = (nBaseHorasOtras * nPropTramo) ! 2;
               nBases = nBases + 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaBase51;
     nIndicador = 50;
     #cretam04#nIndicador# = 51;
     nIndicador = nIndicador + 1;
     #cretam04#nIndicador# = "M";
     nIndicador = nIndicador + 1;
|FPRC;

|PROCESO GrabaBases;
     || nDiasCot: dias cotizables
     || nDiasCotAlta: total dias cotizables en Alta
     || nDiasCotIT: total dias cotizables en IT

     || nBaseComunes_Alta: base CC en alta
     || nBaseATEP_Alta: base ATEP en Alta
     || nBaseEnfAcc: base de enf y acc
     || nBaseMat: base en Maternidad
     || nBasePat: base en Paternidad
     || nBaseRie: base en Riesgo durante en embarazo
     || nBaseCon: base en Control de IT
     || nBaseERE: base en ERE
     || nBaseHorasFM: base de horas extras fuerza mayor
     || nBaseHorasOtras: base de otras horas extras

     || TODOS ESTOS DIAS SON DIAS COTIZABLES
     || nDiasAlta: dias en alta
     || nDiasEnf: dias en enfermedad
     || nDiasAcc: dias en accidente
     || nDiasMat: dias en maternidad
     || nDiasPat: dias de paternidad
     || nDiasRie: dias en riesgo
     || nDiasCon: dias en control de IT
     || nDiasERE: dias en ERE

     || nPromedioCC: base diaria CC
     || nPromedioATEP: base diaria ATEP
     || nPrestEnf: prestaciones por enfermedad
     || nPrestAcc: prestaciones por accidente

     |SI #cretam04#27 = "ALT";
          |SI #cretam04#25 = "S";
               |HAZ GrabaBase51;
          |FINSI;
          |HAZ GrabaBaseAlta;
     |SINO;
          |SI #cretam04#25 = "S";
               |HAZ GrabaBase51;
          |FINSI;

          |SI #cretam04#27 = "ETP";
               |HAZ GrabaBaseAlta;
          |FINSI;
          |HAZ GrabaBaseIT;
     |FINSI;

     |GRABA 020#cretam04.a;
     |LIBERA #cretam04;
|FPRC;

|DEFBUCLE GrabaBases;
     #cretam04#1;
     7;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01, nTra;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99, nTra;
     ;
     NULL, GrabaBases;
|FIN;

|PROCESO Bases;
     nAcumHorasFor = 0;
     nAcumHorasComp = 0;
     |BUCLE GrabaBases;
|FPRC;

/****************************************************************************/
/******************* PROCESOS PARA LA CREACION DE TRAMS *********************/
/****************************************************************************/

|PROCESO control;
     |DDEFECTO #36; |ABRE #36; |LEE 000#36p;
     |CIERRA #36;
|FPRC;

|PROCESO GrabaTramo52;
     #cretam04#6 = nLinea;
     |LEE 101#cretam04.=;

     #cretam04#8 = fFecha;
     #cretam04#9 = fFecha;
     swGraba = 0;
     |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
          nCampo = ((nVez - 1) * 2) + 10;
          nCampo1 = nCampo + 1;
          |SI #cretam04#nCampo# = 102; |O #cretam04#nCampo# = 111;
               || tengo que hacer un tramo de UN dia con la prestacion
               || que es el dia que le he quitado a la enfermedad en
               || el ajuste mensual
               || sustituyo la 102 que hubiera por la 052
               || o la 111 por la 053

               |SI #cretam04#nCampo# = 102;
                    nCodTipo = 052;
                    aDesTipo = "PRES SC";
               |FINSI;
               |SI #cretam04#nCampo# = 111;
                    nCodTipo = 053;
                    aDesTipo = "PRES SC";
               |FINSI;
               #cretam04#nCampo# = nCodTipo;
               #cretam04#nCampo1# = aDesTipo;
               #cretam04#20 = nLinea;
               #cretam04#21 = nLinea;
               #cretam04#22 = 1;
               #cretam04#24 = 0;   || horas TP cotizables no hay en este dia
               #cretam04#26 = "S";
               |SI nCodTipo = 052;
                    #cretam04#27 = "ENF";
                    #cretam04#28 = #cretam04#28 + nDiasAcumIT;
               |FINSI;
               |SI nCodTipo = 053;
                    #cretam04#27 = "ACC";
               |FINSI;
               swGraba = nVez;
               |SAL;
          |FINSI;
     |SIGUE;

     swRegrabado = 0;
     |SI swGraba ] 1;
          |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
               nCampo = ((nVez - 1) * 2) + 10;
               nCampo1 = nCampo + 1;
               |SI #cretam04#nCampo# ! 102;
                    |SI #cretam04#nCampo# = 001; |O #cretam04#nCampo# = 999;
                         #cretam04#nCampo# = 000;
                         #cretam04#nCampo1# = "";
                    |FINSI;
                    |SI #cretam04#nCampo# ] 100; |Y #cretam04#nCampo# [ 199;
                         #cretam04#nCampo# = 000;
                         #cretam04#nCampo1# = "";
                    |FINSI;

                    |SI #cretam04#nCampo# = 052; |O #cretam04#nCampo# = 053;
                         |SI swRegrabado = 1;
                              #cretam04#nCampo# = 000;
                              #cretam04#nCampo1# = "";
                         |FINSI;
                    |FINSI;

                    |SI #cretam04#nCampo# = 000; |Y nVez [ swGraba;
                         #cretam04#nCampo# = nCodTipo;
                         #cretam04#nCampo1# = aDesTipo;
                         swGraba = 1;
                         swRegrabado = 1;
                    |FINSI;
               |SINO;
                    |SI swRegrabado = 1;
                         #cretam04#nCampo# = 000;
                         #cretam04#nCampo1# = "";
                    |FINSI;
               |FINSI;
          |SIGUE;

          |SI #cretam04#25 = "S";
               || he grabado el tramo anteriormente por ser G8 - mensual
               |GRABA 020#cretam04.a;
          |SINO;
               |GRABA 020#cretam04.n;
          |FINSI;
     |FINSI;
     |LIBERA #cretam04;
|FPRC;

|PROCESO GrabaTramo51;
     #cretam04#6 = nLinea;
     /*
     || cambio sistema, las fechas no las cambio
     #cretam04#8 = fFecha;
     #cretam04#9 = fFecha;
     */
     |PARA nCampo = 10; |SI nCampo [ 19; |HACIENDO nCampo = nCampo + 2;
          |SI #cretam04#nCampo# = 000;
               nCampo1 = nCampo + 1
               #cretam04#nCampo# = 051;
               #cretam04#nCampo1# = "D-G8 SC";
               |SAL;
          |FINSI;
     |SIGUE;
     #cretam04#25 = "S";
     |GRABA 020#cretam04.a;
     |LIBERA #cretam04;
     /*
     || cambio sistema, no cambio nada mas, solo grabo la situacion 51
     #cretam04#20 = nLinea;
     #cretam04#21 = nLinea;
     #cretam04#22 = 1;
     #cretam04#24 = 0;   || horas TP cotizables no hay en este dia
     #cretam04#25 = "S";
     |GRABA 020#cretam04.n;
     |LIBERA #cretam04;
     */
|FPRC;

|PROCESO LeeLinAnt;
     swMarca52 = 0;
     |LEE 101#cretam04.a;
     |SI FSalida = 0;
     |Y #cretam04#0 = nEmp; |Y #cretam04#1 = nAny; |Y #cretam04#2 = nMes;
     |Y #cretam04#3 = nTipo; |Y #cretam04#4 = aCCC; |Y #cretam04#5 = aNAFSS;

          || primero busco si la linea anterior tenia prestacion

          |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
               nNume = ((nVez - 1) * 2) + 10;
               |SI #cretam04#nNume# = 102;
                    swMarca52 = 1;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI FSalida = 110;
          || si es la linea 1 del primer trabajador que se calcula
          || no ha de seguir
          |ACABA;
     |FINSI;

     || si resulta que si que la tenia, grabo en la linea siguiente
     || un concepto de prestacion para saberlo, asi sera mas facil hacer
     || el ajuste

     |LEE 101#cretam04.s;

     |SI swMarca52 = 1;
          |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
               nNume = ((nVez - 1) * 2) + 10;
               |SI #cretam04#nNume# = 000; |Y #cretam04#nNume# ! 102;
                    #cretam04#nNume# = 102;
                    nNume1 = nNume + 1;
                    #cretam04#nNume1# = "PREST.";
                    |GRABA 020#cretam04.a;
                    |LIBERA 020#cretam04;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO AjusteLineaFeb;

|FPRC;

|PROCESO AjusteLinea;
     nDiasAcumIT = 0;

     #cretam04#0 = nEmp;
     #cretam04#1 = nAny;
     #cretam04#2 = nMes;
     #cretam04#3 = nTipo;
     #cretam04#4 = aCCC;
     #cretam04#5 = aNAFSS;
     #cretam04#6 = nLineaAjuste;
     |LEE 101#cretam04.=;
     |SI FSalida = 0;
          || me hace falta leer la linea anterior, ya que si vengo de una
          || prestacion, en los mensuales tengo que dejar el tramo del dia
          || que no cotiza pero si que cobra prestacion

          |SI #cretam04#27 = "ENF"; |O #cretam04#27 = "ACC";
               |HAZ LeeLinAnt;
          |FINSI;

          |SI #cretam04#8 = #cretam04#9;
               || es un tramo desde - hasta el mismo dia, lo tengo que borrar

               || cambio sistema

               #cretam04#72 = 1;
               || los dias cotizables los dejo ajustados
               #cretam04#22 = #cretam04#22 - nAjuste;
               |GRABA 020#cretam04.a;
               |LIBERA #cretam04;
/*

               |BORRA 020#cretam04.a;
               |LIBERA #cretam04;

               nFecha = #cretam04#9;
               #cretam04#9 = nFecha - nAjuste;
               #cretam04#21 = #cretam04#21 - nAjuste;
*/
          |SINO;
               || si no, grabo el tramo ultimo pero hasta un dia antes

/*
               || cambio sistema, quito esto

               nFecha = #cretam04#9;
               nFecha = nFecha - nAjuste;
               #cretam04#9 = nFecha;
               #cretam04#21 = #cretam04#21 - nAjuste;
*/
               || los dias cotizables los dejo ajustados
               #cretam04#22 = #cretam04#22 - nAjuste;

               || Horas tiempo parcial
               |SI #0#5 ! 02;
                    || horas en finiquitos no
                    |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
                         nNume = #cretam04#22 * #labtraba#47;
                         |SI swTopeMin = 1;
                              nNume = nNume - 0.49;
                         |FINSI;
                         nNume = nNume ! 0;
                         #cretam04#24 = nNume;
                    |FINSI;
               |FINSI;

               nDiasAcumIT = #cretam04#22;

               #cretam04#72 = 1;
               |GRABA 020#cretam04.a;
               |LIBERA #cretam04;
          |FINSI;

          || ahora el ajuste, primero compruebo los mensuales G8

/*
          || cambio de sistema, el 51 lo tengo que grabar como indicador,
          || en la misma linea

          fFecha = #cretam04#9;
          nFecha = fFecha;
          nFecha = nFecha + 1;
          fFecha = nFecha;
          nLinea = #cretam04#21 + 1;
*/
          nLinea = nLineaAjuste

          |SI #cretam04#23 = "S";
          |Y topemes ! 30; |Y nDiasMesTrab = topemes;
               |HAZ GrabaTramo51;
          |FINSI;

          || y despues compruebo si tengo que grabar la linea de la prestacion
          || del dia de ajuste que no se cotiza

          || cambio sistema, esto se supone que no hay que hacerlo
          ||HAZ GrabaTramo52;
     |FINSI;
|FPRC;

|PROCESO CuentaDias;
     nDias = nDias + #cretam04#22;
     |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
          nNume = ((nVez - 1) * 2) + 10;
          |SI #cretam04#nNume# ! 000;
               |SI #cretam04#nNume# = 101; |O #cretam04#nNume# = 102;
               |O #cretam04#nNume# = 111; |O #cretam04#nNume# = 121;
               |O #cretam04#nNume# = 131; |O #cretam04#nNume# = 141;
               |O #cretam04#nNume# = 151; |O #cretam04#nNume# = 161;
               |O #cretam04#nNume# = 171;
                    || inicio de IT
                    nUltimoTramoIT = #cretam04#6;
               |SINO;
                    swSigue = 0;
                    |SI #cretam04#nNume# = 001;
                         || alta desde inicio del periodo
                         swSigue = 1;
                    |FINSI;
                    |SI #cretam04#nNume# > 100; |Y #cretam04#nNume# < 199;
                         || fin de IT
                         swSigue = 1;
                    |FINSI;
                    |SI swSigue = 1;
                         nUltimoTramoAlta = #cretam04#6;

                         || esto por si en este tramo empiezo alta, y venia de
                         || enfermedad, en mensuales el tramo anterior es el ultimo
                         || en IT para ajustar

                         |SI #cretam04#nNume# = 109;
                         |O #cretam04#nNume# = 119; |O #cretam04#nNume# = 129;
                         |O #cretam04#nNume# = 139; |O #cretam04#nNume# = 149;
                         |O #cretam04#nNume# = 159; |O #cretam04#nNume# = 169;
                              nUltimoTramoIT = nLineaAnt;
                         |FINSI;
                    |SINO;
                         || inicio o fin de bonificaciones, indicadores de
                         || cambio de situacion

                         |SI nCodTipoAnt = 101; |O nCodTipoAnt = 102;
                         |O nCodTipoAnt = 111; |O nCodTipoAnt = 121;
                         |O nCodTipoAnt = 131; |O nCodTipoAnt = 141;
                         |O nCodTipoAnt = 151; |O nCodTipoAnt = 161;
                         |O nCodTipoAnt = 171;
                              nUltimoTramoIT = #cretam04#6;
                         |SINO;
                              nUltimoTramoAlta = #cretam04#6;
                         |FINSI;
                    |FINSI;
               |FINSI;

               || nLineaAnt = #cretam04#6;
               nCodTipoAnt = #cretam04#nNume#;
          |SINO;
               |SAL;
          |FINSI;
     |SIGUE;
     nLineaAnt = #cretam04#6;
|FPRC;

|DEFBUCLE CuentaDias;
     #cretam04#1;
     ;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99;
     ;
     NULL, CuentaDias;
|FIN;

|PROCESO DiasAltaNIF;
     aAlfa = #labtraba#36;
     fFecha1 = aAlfa;

     aAlfa = #labtraba#37;
     |QBF aAlfa;
     |SI aAlfa = ""; |O aAlfa = "..........";
          fFecha2 = "31.12.2999";
     |SINO;
          fFecha2 = aAlfa;
     |FINSI;

     |SI fFecha2 < fFechaIniMes; |O fFecha1 > fFechaFinMes;
          || no ha estado de alta en el periodo que buscamos
     |SINO;
          nFecha1 = fFecha1;
          nFecha2 = fFecha2;

          |SI fFecha1 < fFechaIniMes;
               nFecha1 = nFechaIniMes;
          |FINSI;
          |SI fFecha2 > fFechaFinMes;
               nFecha2 = nFechaFinMes;
          |FINSI;
          nDiasAltaNIF = nDiasAltaNIF + (nFecha2 - nFecha1 + 1);

          #labcentr#0 = #labtraba#0;
          #labcentr#1 = #labtraba#77;
          |LEE 000#labcentr.=;

          |SI #labcentr#10 ! aAntCCC;
               nNroCCCs = nNroCCCs + 1;
          |FINSI;
          aAntCCC = #labcentr#10;
     |FINSI;
|FPRC;

|DEFBUCLE DiasAltaNIF;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, DiasAltaNIF;
|FIN;

|PROCESO AjusteMensual;
     nDias = 0;
     nUltimoTramoAlta = 0;
     nUltimoTramoIT = 0;
     nCodTipoAnt = 0;
     nLineaAnt = 0;
     nLineaAjuste = 0;

     |BUCLE CuentaDias;

     |SI nDias = topemes;
          |SI nUltimoTramoIT ! 0;
               nLineaAjuste = nUltimoTramoIT;
          |SINO;
               nLineaAjuste = nUltimoTramoAlta;
          |FINSI;
     |SINO;
          |SI fFechaIniMes [ fFechaAlta; |Y fFechaAlta [ fFechaFinMes;
               || alta este mes, de alta el mes completo entre todas sus fichas
               || estando en varios CCCs

               aNif = #labtraba#7;
               nDiasAltaNIF = 0;
               aAntCCC = "";
               nNroCCCs = 0;
               |SALVA_FICHA #labtraba;
               |BUCLE DiasAltaNIF;
               |REPON_FICHA #labtraba;

               |SI nDiasAltaNIF = topemes; |Y nNroCCCs > 1;
               ||SI nDias < 30; |Y nDiasCot < nDias;
                    || mensual, cotiza menos de 30 dias y menos de los dias
                    || que le corresponderian
                    || entonces asumo que el trabajador ha tenido otra
                    || ficha y que entre las dos han tenido 30 dias, pero que la
                    || otra estaba en otra empresa (cosas de Dany que inten-
                    || taremos controlar)

                    nLineaAjuste = nUltimoTramoAlta;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nDias = topemes;
          nAjuste = topemes - 30;
     |FINSI;

     |SI nElMes = 1; |O nElMes = 3; |O nElMes = 5;
     |O nElMes = 7; |O nElMes = 8; |O nElMes = 10; |O nElMes = 12;
          |HAZ AjusteLinea;
     |FINSI;
     |SI nElMes = 2;
          |HAZ AjusteLinea;
     |FINSI;
|FPRC;

|PROCESO BuscaAnterior;
     #cretam04#0 = nEmp;
     #cretam04#1 = nAny;
     #cretam04#2 = nMes;
     #cretam04#3 = nTipo;
     #cretam04#4 = aCCC;
     #cretam04#5 = aNAFSS;

     aAlfa = fFechaAlta;
     aAlfa = aAlfa % 102;
     nNume = aAlfa;

     #cretam04#6 = nNume - 1;
     |LEE 101#cretam04.=;
     |SI FSalida = 0;
          |SI #cretam04#10 = 999;
               |BORRA 020#cretam04.a;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO labtraba;
     fFechaIniTramo = fFechaAlta;

     |SI aFechaBusca = #labtraba#37;
          nCodTipo = 000;
          aDesTipo = "";
          |SI aContrato ! #labtraba#45;
               nCodTipo = 005;
               aDesTipo = "CONTRATO";
               |HAZ GrabaTramo;
          |FINSI;
          |SI nGrupoCot ! #labtraba#33;
               nCodTipo = 010;
               aDesTipo = "GRUPO COT";
               |HAZ GrabaTramo;
          |FINSI;
          |SI aOcupacion ! #labtraba#204;
               nCodTipo = 015;
               aDesTipo = "OCUPACION";
               |HAZ GrabaTramo;
          |FINSI;
          |SI nHoras ! #labtraba#234;
               nCodTipo = 020;
               aDesTipo = "JORNADA";
               |HAZ GrabaTramo;
          |FINSI;
          |SI nCategoria ! #labtraba#17;
               nCodTipo = 025;
               aDesTipo = "CATEGORIA";
               |HAZ GrabaTramo;
          |FINSI;
          |SI nCodTipo ! 000;
               ||HAZ BuscaAnterior;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE labtraba;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, labtraba;
|FIN;

|PROCESO variaciones;
     aNif = #labtraba#7;

     |SI fFechaAlta ] fFechaIniPer;
          || es porque he sido alta el dia 1 del periodo o despues, quiere
          || decir que puede que este mes haya sufrido alguna variacion
          || voy a buscar un trabajador que fuera baja el dia anterior
          || a la fecha de alta

          nNume = fFechaAlta;
          nNume = nNume - 1;
          fFechaBusca = nNume;
          aFechaBusca = fFechaBusca;

          aContrato = #labtraba#45;
          nGrupoCot = #labtraba#33;
          nCategoria = #labtraba#17;
          aOcupacion = #labtraba#204;
          nHoras = #labtraba#234;

          |SALVA_FICHA #labtraba;
          |BUCLE labtraba;
          |REPON_FICHA #labtraba;

          |SI nCodTipo ! 000;
               aAlfa = #labtraba#36;
               aAlfa = (aAlfa % 102)
               nLinea = aAlfa;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO cta_cotizacion;
     swCentroFormacion = 0;
     aCCC = #labempre#13;          || cta.cot. de la empresa
     |SI #labtraba#45 = "085"; |O #labtraba#45 = "087"; |O #labtraba#45 = "097";
     |O #labtraba#45 = "421"; |O #labtraba#45 = "422";
          |DDEFECTO #nomcenes;
          |ABRE #nomcenes;
          #nomcenes#0 = #labtraba#0;
          #nomcenes#13 = #labtraba#77;
          #nomcenes#1 = 87;
          |LEE 000#nomcenes.=;
          |SI FSalida = 0;
               aAlfa = #nomcenes#10;      || cta.cto. del centro de trabajo especial
               |QBF aAlfa;
               |SI aAlfa ! "";
                    aCCC = aAlfa;         || cta.cto. del centro de trabajo especial
               |FINSI;
               aCentroNom = #nomcenes#2;
               swCentroFormacion = 1;
          |FINSI;
          |CIERRA #nomcenes;
     |SINO;
          |DDEFECTO #labcentr;
          |ABRE #labcentr;
          #labcentr#0 = #labtraba#0;
          #labcentr#1 = #labtraba#77;
          |LEE 000#labcentr.=;
          |SI FSalida = 0;
               aAlfa = #labcentr#10;      || cta.cot. centro de trabajo
               |QBF aAlfa;
               |SI aAlfa ! "";
                    aCCC = aAlfa;
               |FINSI;
               aCentroNom = #labcentr#2;
          |FINSI;
          |CIERRA #labcentr;
     |FINSI;
     |QBF aCCC;
     |SI aCCC ! "";
          aCCC = ("00000000000" + aCCC) % -111;
     |FINSI;
     aAlfa = #labtraba#247;
     |QBF aAlfa;
     aAlfa = ("0000" + aAlfa) % -104;
     |SI aCCC ! "";
          aCCC = aAlfa + aCCC;
     |FINSI;
|FPRC;

|PROCESO CodigoSituacion;
     |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
          nNume = ((nVez - 1) * 2) + 10;
          nCodigo = #cretam04#nNume#;
          |SI nCodigo ! 000;
               nUltimoCodigo = #cretam04#nNume#;
          |FINSI;
          |SI nCodigo ] 100; |Y nCodigo [ 199;
               aAlfa = nCodigo;
               |QBF aAlfa;
               aAlfa = aAlfa % -101;
               |SI aAlfa = "1"; |O nCodigo = 102;
                    || estoy en situacion especial

                    |SI nCodigo = 101; aSituacion = "ENF"; |FINSI;
                    |SI nCodigo = 102; aSituacion = "ENF"; |FINSI;
                    |SI nCodigo = 111; aSituacion = "ACC"; |FINSI;
                    |SI nCodigo = 121; aSituacion = "MAT"; |FINSI;
                    |SI nCodigo = 131; aSituacion = "PAT"; |FINSI;
                    |SI nCodigo = 141; aSituacion = "RIE"; |FINSI;
                    |SI nCodigo = 151; aSituacion = "ERE"; |FINSI;
                    |SI nCodigo = 161; aSituacion = "ETP"; |FINSI;
                    |SI nCodigo = 171; aSituacion = "CON"; |FINSI;
                    |SAL;
                    nCodigoIniIT = nCodigo;
               |SINO;
                    aSituacion = "ALT";
                    nCodigoFinIT = nCodigo;
               |FINSI;
          |SINO;
               aSituacion = "ALT";
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO GrabaSituacion;
     aSituacion = "";
     nCodigoIniIT = 0;
     nCodigoFinIT = 0;
     |HAZ CodigoSituacion;

     swSigue = 0;
     |SI nUltimoCodigo ] 400; |Y nUltimoCodigo [ 499;
          swSigue = 1;
          ||SI aSituacion = ""; |O aSituacion = "ALT";
          |SI nCodigoIniIT ! 0;
               swSigue = 1;
          |FINSI;
          |SI nCodigoFinIT ! 0;
               swSigue = 0;
          |FINSI;
     |FINSI;
     |SI swSigue = 1;
          || esto es para que al poner la bonificacion se mantenga la situacion
          || del tramo anterior, pero puede ser que en este tramo inicie
          || situacion nueva, por ejemplo cuando acaba o empieza bonificacion
          || a la vez que empieza o acaba maternidad

          || solo me voy a buscar el codigo del tramo anterior si no tengo
          || situacion o tengo "ALT" que es lo mismo.

          |SALVA_FICHA #cretam04;
          |LEE 101#cretam04.a;
          |SI #cretam04#0 = nEmp; |Y #cretam04#1 = nAny; |Y #cretam04#2 = nMes;
          |Y #cretam04#3 = nTipo; |Y #cretam04#4 = aCCC; |Y #cretam04#5 = aNAFSS;
          |Y #cretam04#7 = nTra;
          |Y FSalida = 0;
               |HAZ CodigoSituacion;
          |FINSI;
          |REPON_FICHA #cretam04;
     |FINSI;
|FPRC;

|PROCESO GrabaUnionTramo;
     #cretam04#9 = fFecha;

     aFechaIniTramo = #cretam04#8;
     aFechaFinTramo = #cretam04#9;
     aAlfa = aFechaIniTramo % 102;
     #cretam04#20 = aAlfa;
     aAlfa = aFechaFinTramo % 102;
     #cretam04#21 = aAlfa;

     nFechaIniTramo = #cretam04#8;
     nFechaFinTramo = #cretam04#9;
     #cretam04#22 = nFechaFinTramo - nFechaIniTramo + 1;

     || Mensual grupo 8
     |SI #labtraba#42 ! "T"; |Y #labtraba#42 ! "X"; |Y #labtraba#42 ! "D"; |Y #labtraba#42 ! "E";
          || no en los contratos a tiempo parcial
          || ni en los diarios claro
          |SI #labtraba#45 ! "421"; |Y #labtraba#45 ! "422";
               || no en los contratos de formacion
               |SI #labtraba#33 ] 8;
                    #cretam04#23 = "S";
               |FINSI;
          |FINSI;
     |FINSI;

     || Horas tiempo parcial
     |SI #0#5 ! 02;
          || horas en finiquitos no
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
               nNume = #cretam04#22 * #labtraba#47;
               |SI swTopeMin = 1;
                    nNume = nNume - 0.49;
               |FINSI;
               nNume = nNume ! 0;
               #cretam04#24 = nNume;
          |FINSI;
     |FINSI;

     |HAZ GrabaSituacion;

     #cretam04#27 = aSituacion;

     || trabajadores mensuales con GC 08 en adelante, llevan el indicativo
     || 51-M siempre, en principio lo poniamos solo en el tramo donde se
     || realizaba el ajuste, ahora lo llevan siempre (solo en meses que NO
     || sean de 30 dias claro)

     |SI #cretam04#23 = "S";
     |Y topemes ! 30; |Y nDiasMesTrab = topemes;
          #cretam04#25 = "S";
     |FINSI;

     |GRABA 020#cretam04.a;
     |LIBERA #cretam04;
|FPRC;

|PROCESO UltimoDiaIT;
     |SI #0#5 = 2;
          |ACABA;
     |FINSI;

     aAlfa = fFechaFinPer;
     aAlfa = aAlfa % 102;
     nNume = aAlfa;

     |SI #0#3 = "M"; |O #0#3 = "A";
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               aAlfa = #nomcalca#nCampo#;
               |QBF aAlfa;
               |SI aAlfa ! "";
                    nCampo1 = nCampo - 4;
                    |SI #nomcalca#nCampo1# = 0; |O #nomcalca#nCampo1# = nNume;
                         swUltimoDiaIT = 1;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI #0#3 = "H"; |O #0#3 = "T";
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               aAlfa = #nomhicca#nCampo#;
               |QBF aAlfa;
               |SI aAlfa ! "";
                    nCampo1 = nCampo - 4;
                    |SI #nomhicca#nCampo1# = 0; |O #nomhicca#nCampo1# = nNume;
                         swUltimoDiaIT = 1;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO BuscaITPenultimoDia;
     || este proceso es para cubrir los casos tipo Del 1 al 30 IT y del
     || 31 al 31 ALTA, para que cree los dos tramos que tiene que crear
     || ya que en ese caso creo en el dia 31 la 999 y la 109

     || PERO SOLO si el ultimo dia realmente no estoy de IT porque en una
     || IT en que soy baja en la empresa el dia 14, si estoy los 14 dias
     || de IT, tambien creo la ultima linea con el dia 14 con la 999 y la 109
     || asi que en caso de ser IR el ultimo dia no tengo que hacer esto

     swUltimoDiaIT = 0;
     |HAZ UltimoDiaIT;

     swIniPeriodo = 0;
     swFinPeriodo = 0;
     |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
          nCampo = ((nVez - 1) * 2) + 10;
          nCodigo = #cretam04#nCampo#;
          |SI nCodigo = 001;
               swIniPeriodo = 1;
          |FINSI;
          |SI nCodigo = 999;
               swFinPeriodo = 1;
          |FINSI;
          swSigue = 0;
          |SI nCodigo = 109; |O nCodigo = 119; |O nCodigo = 129;
          |O nCodigo = 139; |O nCodigo = 149; |O nCodigo = 159;
          |O nCodigo = 169; |O nCodigo = 179;
               |SI swFinPeriodo = 1; |Y swUltimoDiaIT = 0;
                    swSigue = 1;
               |FINSI;
          |FINSI;

          || esto es lo mismo pero para otro caso:
          || todo el mes de alta y el ultimo dia y el ultimo dia
          || empiezo IT
          |SI nCodigo = 101; |O nCodigo = 111; |O nCodigo = 121;
          |O nCodigo = 131; |O nCodigo = 141; |O nCodigo = 151;
          |O nCodigo = 161; |O nCodigo = 171;
               |SI swFinPeriodo = 1; |Y swUltimoDiaIT = 1;
                    swSigue = 1;
               |FINSI;
          |FINSI;

          || nuevo caso que hace que no haya que borrar el tramo
          || febrero, comienzo una IT o el tramo de prestaciones de una IT
          || el dia 28, me borraba el tramo al ser el ultimo porque pensaba
          || que no tenia que estar, no es correcto

          || 26.05.2015 Bueno asi estaba antes, pero es que no tiene que ser
          || solo en febrero. Si un mes cualquiera un trab. es baja el dia
          || 19 por ejemplo, y ese dia es el dia 16 de la IT (porque empezo
          || el 4 por ejemplo), no salia tampoco y tiene que salir ese ultimo
          || dia como tramo para la prestacion

          |SI nCodigo = 102;
               aAlfa = fFechaIniTramo;
               aAlfa = aAlfa % 102;
               nNume = aAlfa;

               |SI swFinPeriodo = 1; |Y swUltimoDiaIT = 1;
                    |||SI nMes = 2; |Y #cretam04#6 = nNume;
                    || quito lo del febrero
                    |SI #cretam04#6 = nNume;
                         swSigue = 1;
                    |FINSI;
               |FINSI;
          |FINSI;

          |SI swSigue = 1;
               swFinPeriodo = 2;
               fFecha = #cretam04#8;
               |HAZ GrabaUnionTramo;

               nFecha = #cretam04#8;
               nFecha = nFecha - 1;
               fFecha = nFecha;
               |SALVA_FICHA #cretam04;
               |LEE 101#cretam04.a;
               |HAZ GrabaUnionTramo;

               || para que pase como ultimo dia del periodo anterior
               nFecha = #cretam04#8;
               nFecha = nFecha - 1;
               fFecha = nFecha;

               |REPON_FICHA #cretam04;

               |SAL;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO GrabaTramo99;
     |DDEFECTO #cretam04;
     #cretam04#0 = nEmp;
     #cretam04#1 = nAny;
     #cretam04#2 = nMes;
     #cretam04#3 = nTipo;
     #cretam04#4 = aCCC;
     #cretam04#5 = aNAFSS;
     #cretam04#6 = 99;

     nMes99 = nMes + 1;
     |SI nMes99 = 13;
          nMes99 = 1;
          nAny99 = nAny + 1;
     |SINO;
          nAny99 = nAny;
     |FINSI;

     aAlfa1 = "01";
     aAlfa2 = nMes99; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
     aAlfa3 = nAny99;
     aFechaIniPer = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;

     aAlfa1 = nDiasVac2; |QBF aAlfa1; aAlfa1 = ("00" + aAlfa1) % -102;
     aFechaFinPer = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;

     #cretam04#8 = aFechaIniPer;
     #cretam04#9 = aFechaFinPer;

     #cretam04#10 = 001;
     #cretam04#11 = "INI PERIODO";
     #cretam04#12 = 999;
     #cretam04#13 = "FIN PERIODO";

     #cretam04#20 = 01;
     #cretam04#21 = nDiasVac2;
     #cretam04#22 = nDiasVac2;
     #cretam04#27 = "ALT";

     #cretam04#7 = #labtraba#1;
     #cretam04#29 = #labtraba#2;
     #cretam04#70 = aFechaIniPer;
     #cretam04#71 = aFechaFinPer;
     #cretam04#73 = #labtraba#45;

     |GRABA 020#cretam04.n;
     |LIBERA #cretam04;
|FPRC;

|PROCESO UltimaLinea;
     nUltima = #cretam04#6;
|FPRC;

|DEFBUCLE UltimaLinea;
     #cretam04#1;
     7;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01, nTra;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99, nTra;
     ;
     NULL, UltimaLinea;
|FIN;

|PROCESO DosFichasSinRuptura;
     || lo primero es ver en cual se ha quedado ahora la ultima linea
     |BUCLE UltimaLinea;

     #cretam04#0 = nEmp;
     #cretam04#1 = nAny;
     #cretam04#2 = nMes;
     #cretam04#3 = nTipo;
     #cretam04#4 = aCCC;
     #cretam04#5 = aNAFSS;
     #cretam04#6 = nUltima;
     |LEE 101#cretam04.=;

     swSigue = 0;

     |PARA nCampo = 10; |SI nCampo [ 19; |HACIENDO nCampo = nCampo + 2;
          |SI #cretam04#nCampo# ! 000;
               |SI #cretam04#nCampo# = 025;
                    swSigue = 1;
               |SINO;
                    |SI #cretam04#nCampo# ! 001; |Y #cretam04#nCampo# ! 999;
                         swSigue = 0;
                         |SAL;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;

     |SI swSigue = 1;
          nEmp = #cretam04#0;
          nAny = #cretam04#1;
          nMes = #cretam04#2;
          nTipo = #cretam04#3;
          aCCC = #cretam04#4;
          aNAFSS = #cretam04#5;
          nDiaDesde = #cretam04#6;
          nDiaHasta = #cretam04#21;
          fFechaHastaTra = #cretam04#9;
          fFechaHastaPer = #cretam04#71;
          nDias = #cretam04#22;

          |DDEFECTO #cretat04;

          |PARA nCampo = 30; |SI nCampo [ 69; |HACIENDO nCampo = nCampo + 1;
               #cretat04#nCampo# = #cretam04#nCampo#;
          |SIGUE;

          |LEE 101#cretam04.a;

          |SI #cretam04#0 = nEmp; |Y #cretam04#1 = nAny; |Y #cretam04#2 = nMes;
          |Y #cretam04#3 = nTipo; |Y #cretam04#4 = aCCC; |Y #cretam04#5 = aNAFSS;
          |Y #cretam04#7 ! nTra;
               || este es el tramo con el que lo tendre que unir

               nDiaHastaMasUno = #cretam04#22 + 1;
               |SI nDiaHastaMasUno = nDiaDesde;
                    || el dia desde del segundo trab (en el que se cambia la
                    || categoria) es igual que el dia hasta del primero
                    || entonces si que hago la union de los dos tramos

                    #cretam04#21 = nDiaHasta;
                    #cretam04#22 = #cretam04#22 + nDias;
                    #cretam04#9 = fFechaHastaTra;
                    #cretam04#71 = fFechaHastaPer;

                    || ahora tengo que sumar las bases del segundo a las del
                    || primero

                    |PARA nCampo1 = 30; |SI nCampo1 [ 49; |HACIENDO nCampo1 = nCampo1 + 2;
                         nCampo2 = nCampo1 + 1;
                         |SI #cretam04#nCampo1# = #cretat04#nCampo1#;
                              #cretam04#nCampo2# = #cretam04#nCampo2# + #cretat04#nCampo2#;
                         |FINSI;
                    |SIGUE;
                    |PARA nCampo1 = 60; |SI nCampo1 [ 69; |HACIENDO nCampo1 = nCampo1 + 2;
                         nCampo2 = nCampo1 + 1;
                         |SI #cretam04#nCampo1# = #cretat04#nCampo1#;
                              #cretam04#nCampo2# = #cretam04#nCampo2# + #cretat04#nCampo2#;
                         |FINSI;
                    |SIGUE;

                    |GRABA 020#cretam04.a;
                    |LIBERA #cretam04;

                    |LEE 020#cretam04.s;
                    |BORRA 020#cretam04.a;
                    |LIBERA #cretam04;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO union;
     fFecha = "01.01.0000";

     #cretam04#0 = nEmp;
     #cretam04#1 = nAny;
     #cretam04#2 = nMes;
     #cretam04#3 = nTipo;
     #cretam04#4 = aCCC;
     #cretam04#5 = aNAFSS;
     #cretam04#6 = nUltima;
     |LEE 101#cretam04.=;
     |SI FSalida = 0;
          fFecha = #cretam04#9;
          nCodTipo = #cretam04#10;
          |SI fFecha = "01.01.0000";
               |HAZ BuscaITPenultimoDia;
               swTramoUnSoloDia = 0;
               |SI swIniPeriodo = 1; |Y swFinPeriodo = 1;
                    ||SI nUltima = 1; |O nUltima = topemes;
                         swTramoUnSoloDia = 1;    || esto es para detectar
                                                  || tramos de un solo dia
                    ||FINSI;
               |FINSI;
               |SI swFinPeriodo = 2;
                    || no hagas nada, ya esta hecho
               |SINO;
                    |SI swTramoUnSoloDia = 1;
                         || un solo dia de alta, no me lo borres
                         nFecha = #cretam04#8;
                         fFecha = nFecha;
                    |SINO;
                         fFecha = #cretam04#8;
                         |BORRA 020#cretam04.a;
                    |FINSI;
               |FINSI;
          |SINO;
               nFecha = #cretam04#8;
               nFecha = nFecha - 1;
               fFecha = nFecha;
          |FINSI;

          |LEE 101#cretam04.a;
          |SI swTramoUnSoloDia = 1;
               || un solo dia de alta en el mes, el dia 1
               || hago esto para que grabe resto de campos del unico tramo
               |LEE 101#cretam04.s;
          |FINSI;

          |PARA;
          |SI #cretam04#0 = nEmp; |Y #cretam04#1 = nAny; |Y #cretam04#2 = nMes;
          |Y #cretam04#3 = nTipo; |Y #cretam04#4 = aCCC; |Y #cretam04#5 = aNAFSS;
          |Y #cretam04#7 = nTra;
          |Y FSalida = 0;
          |HACIENDO;
               |SI #cretam04#9 = "01.01.0000";
                    |HAZ GrabaUnionTramo;
                    nFecha = #cretam04#8;
                    nFecha = nFecha - 1;
                    fFecha = nFecha;
               |FINSI;
               |LEE 101#cretam04.a;
          |SIGUE;
     |FINSI;

     |SI #0#5 = 2; |Y nDiasVac2 ! 0;
          |HAZ GrabaTramo99;
     |FINSI;
|FPRC;

|PROCESO CodigoTiposEnf;
     nCodTipo = 000;
     aDesTipo = "";

     |SI aTipo = "E"; nCodTipo = 01; aDesTipo = "ENF"; |FINSI;
     |SI aTipo = "A"; nCodTipo = 11; aDesTipo = "ACC"; |FINSI;
     |SI aTipo = "M"; nCodTipo = 21; aDesTipo = "MAT"; |FINSI;
     |SI aTipo = "P"; nCodTipo = 31; aDesTipo = "PAT"; |FINSI;
     |SI aTipo = "R"; nCodTipo = 41; aDesTipo = "RIE"; |FINSI;
     |SI aTipo = "D";
          |SI nPropERE = 100;
               nCodTipo = 51;
               aDesTipo = "ERE";
          |SINO;
               nCodTipo = 61;
               aDesTipo = "ETP";
          |FINSI;
     |FINSI;
     |SI aTipo = "C"; nCodTipo = 71; aDesTipo = "CON"; |FINSI;
     |SI swDesde = 1;
          nCodTipo = nCodTipo + 100;
          aDesTipo = "INI " + aDesTipo;
     |FINSI;
     |SI swHasta = 1;
          nCodTipo = nCodTipo + 108;
          aDesTipo = "FIN " + aDesTipo;
     |FINSI;
     |SI swPrest = 1;
          nCodTipo = nCodTipo + 101;
          aDesTipo = "PREST. " + aDesTipo;
     |FINSI;
|FPRC;

|PROCESO GrabaTramo;
     |SI nTipo = 2;
          |SI nDiasVac1 = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     |DDEFECTO #cretam04;

     aFechaIniTramo = fFechaIniTramo;
     aLinea = aFechaIniTramo % 102;
     nLinea = aLinea;

     aAlfa = nCodTipo; |QBF aAlfa; aAlfa = aAlfa % -101;
     |SI aAlfa = "9"; |Y nCodTipo ! 999;
          |SI nLinea ! topemes;
               nFechaIniTramo = fFechaIniTramo;
               nFechaIniTramo = nFechaIniTramo + 1;
               fFechaIniTramo = nFechaIniTramo;

               |SI fFechaIniTramo > fFechaFinPer;
                    || se da cuando tenemos una bonif que acaba el mismo
                    || dia que el trabajador es baja, no puedo hacer otro
                    || tramo

                    nFechaIniTramo = nFechaIniTramo - 1;
                    fFechaIniTramo = nFechaIniTramo;
               |FINSI;
          |FINSI;
     |FINSI;

     aFechaIniTramo = fFechaIniTramo;
     aLinea = aFechaIniTramo % 102;
     nLinea = aLinea;

     #cretam04#0 = nEmp;
     #cretam04#1 = nAny;
     #cretam04#2 = nMes;
     #cretam04#3 = nTipo;
     #cretam04#4 = aCCC;
     #cretam04#5 = aNAFSS;
     #cretam04#6 = nLinea;
     |LEE 101#cretam04.=;
     FEstado = FSalida;

     #cretam04#7 = nTra;
     #cretam04#8 = fFechaIniTramo;

     |PARA nVez = 1; |SI nVez [ 5; |HACIENDO nVez = nVez + 1;
          nNume = ((nVez - 1) * 2) + 10;
          swGraba = 0;
          |SI #cretam04#nNume# = 000;
               swGraba = 1;
          |FINSI;
          |SI #cretam04#nNume# = 001;
               |SI nCodTipo ] 5; |Y nCodTipo [ 50; || es un cambio por
                    || swGraba = 1;                   || variacion de algo
                    || cambio sistema: no tengo por que cambiarlo !!
                    || ¨o no?
               |FINSI;
          |FINSI;
          |SI swGraba = 1;
               nNume1 = nNume + 1;
               #cretam04#nNume# = nCodTipo;
               #cretam04#nNume1# = aDesTipo;
               |SAL;
          |FINSI;
     |SIGUE;

     |SI swPrest = 1;
          #cretam04#28 = nDiaIT;
     |FINSI;

     #cretam04#29 = #labtraba#2;
     #cretam04#70 = fFechaIniPer;
     #cretam04#71 = fFechaFinPer;
     #cretam04#73 = #labtraba#45;

     |SI FEstado ! 0;
          |GRABA 020#cretam04.n;
     |SINO;
          |GRABA 020#cretam04.a;
     |FINSI;
     |LIBERA #cretam04;
|FPRC;

|PROCESO busca_tramo;
     swHay = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE busca_tramo;
     #cretam04#1;
     ;
     #cretam03#0, #cretam03#1, #cretam03#2, #cretam03#3, #cretam03#4, #cretam03#5, 001;
     #cretam03#0, #cretam03#1, #cretam03#2, #cretam03#3, #cretam03#4, #cretam03#5, 999;
     ;
     NULL, busca_tramo;
|FIN;

|PROCESO limpia_NAFSS;
     swHay = 0;
     |BUCLE busca_tramo;
     |SI swHay = 0;
         |BORRA 020#cretam03.a;
         |LIBERA #cretam04;
     |FINSI;
|FPRC;

|DEFBUCLE limpia_NAFSS;
     #cretam03#1;
     ;
     nEmp, nAny, nMes, nTipo, "           ", "            ";
     nEmp, nAny, nMes, nTipo, "zzzzzzzzzzz", "zzzzzzzzzzzz";
     ;
     NULL, limpia_NAFSS;
|FIN;

|| BUCLE Y PROCESO PARA BORRAR LOS TRAMOS QUE EXISTIERAN DE UN TRABAJADOR
|| ANTES DE INICIAR LA GRABACION DE LOS TRAMOS NUEVOS

|PROCESO borra_tramos;
     |BORRA 020#cretam04.a;
     |LIBERA #cretam04;
|FPRC;

|DEFBUCLE borra_tramos;
     #cretam04#2;
     ;
     nEmp, nAny, nMes, nTipo, "           ", "            ", nTra;
     nEmp, nAny, nMes, nTipo, "zzzzzzzzzzz", "zzzzzzzzzzzz", nTra;
     ;
     NULL, borra_tramos;
|FIN;

/****************************************************************************/
/*** PROCESOS PARA GRABAR LAS BONFICACIONES DE FORMACION CONTINA POR CCC ****/
/****************************************************************************/

|PROCESO nombofli;
     swAsignada = 0;

     #labcentr#0 = #nombofli#0;
     #labcentr#1 = #nombofli#4;
     |LEE 000#labcentr.=;
     |SI FSalida = 0; |Y #nombofli#6 ! "F";
          aAlfa = #labcentr#10;
          |QBF aAlfa;
          aAlfa1 = aAlfa % -107;

          aAlfa = #cretam02#4;
          aAlfa2 = aAlfa % -107;

          |SI aAlfa1 = aAlfa2;
               || esto quiere decir que el centro al que le he asignado
               || la bonificacion de Formacion Continua de este tema,
               || tiene el mismo CCC del que estoy haciendo el lote, luego
               || es el momento de incluirla en el lote

               nBonifFormCont = nBonifFormCont + #nombofli#3;
               swAsignada = 1;
          |FINSI;
     |FINSI;

     || lo mismo para el nomcenes, si en el labcentr no
     || esta encontrada
     #nomcenes#0 = #nombofli#0;
     #nomcenes#13 = #nombofli#4;
     #nomcenes#1 = "87";
     |LEE 000#nomcenes.=;
     |SI FSalida = 0; |Y #nombofli#6 = "F";
          aAlfa = #nomcenes#10;
          |QBF aAlfa;
          aAlfa1 = aAlfa % -107;

          aAlfa = #cretam02#4;
          aAlfa2 = aAlfa % -107;

          |SI aAlfa1 = aAlfa2;
               || esto quiere decir que el centro al que le he asignado
               || la bonificacion de Formacion Continua de este tema,
               || tiene el mismo CCC del que estoy haciendo el lote, luego
               || es el moemento de incluirla en el lote

               nBonifFormCont = nBonifFormCont + #nombofli#3;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE nombofli;
     #nombofli#1;
     ;
     #cretam02#0, #cretam02#1, #cretam02#2, 01, " ", "B";
     #cretam02#0, #cretam02#1, #cretam02#2, 98, "F", "P";
     ;
     NULL, nombofli;
|FIN;

|PROCESO BonifFormCont;
     || las bonificaciones de formacion continua van con el tipo de dato
     || C-763 a nivel de LIQUIDACION

     || primero compruebo si existe la bonif

     |SI #0#5 ! 00;
          |ACABA;
     |FINSI;

     |ABRE #nombofca;
     #nombofca#0 = #cretam02#0;
     #nombofca#1 = #cretam02#1;
     |LEE 000#nombofca.=;
     |SI FSalida = 0;
          || existe la cabecera, ahora hay que buscar si hay alguna linea
          || este mes, en un centro que tenga el CCC como el que estoy
          || grabando

          nBonifFormCont = 0;
          |BUCLE nombofli;
     |FINSI;
     |CIERRA #nombofca;
|FPRC;


|PROCESO cretam03;
     |DDEFECTO #cretam03;
     #cretam03#0 = nEmp;
     #cretam03#1 = nAny;
     #cretam03#2 = nMes;
     #cretam03#3 = nTipo;
     #cretam03#4 = aCCC;
     #cretam03#5 = aNAFSS;
     |LEE 101#cretam03.=;
     FEstado = FSalida;

     #cretam03#6 = #labempre#2;
     #cretam03#7 = #labtraba#77;
     #cretam03#8 = aCentroNom;
     #cretam03#9 = #labtraba#2;
     #cretam03#10 = #labtraba#7;
     #cretam03#11 = #labtraba#1;

     |SI FEstado ! 0;
          |GRABA 020#cretam03.n;
     |SINO;
          |GRABA 020#cretam03.a;
     |FINSI;
     |LIBERA #cretam03;
|FPRC;

|PROCESO cretam02;
     |DDEFECTO #cretam02;
     #cretam02#0 = nEmp;
     #cretam02#1 = nAny;
     #cretam02#2 = nMes;
     #cretam02#3 = nTipo;
     |HAZ cta_cotizacion;
     #cretam02#4 = aCCC;
     |LEE 101#cretam02.=;
     FEstado = FSalida;

     |SI swCentroFormacion = 1;
          #cretam02#11 = "S";
     |SINO;
          #cretam02#11 = "N";
     |FINSI;

     || si ya la he grabado no la grabo de nuevo
     |SI #0#5 = 00;
          |HAZ BonifFormCont;
          #cretam02#15 = nBonifFormCont;
     |FINSI;

     |SI FEstado ! 0;
          #cretam02#5 = #labtraba#77;
          #cretam02#6 = aCentroNom;
          |GRABA 020#cretam02.n;
     |SINO;
          |SI #labtraba#77 ! #cretam02#5; |Y #cretam02#5 ! 00;
               #cretam02#5 = 00;
               #cretam02#6 = "Varios Centros";
          |FINSI;
          |GRABA 020#cretam02.a;
     |FINSI;
     |LIBERA #cretam02;

     || Ahora dentro del CCC doy de alta el Nro de Afiliacion del trabajador
     |HAZ cretam03;
|FPRC;

|PROCESO cretam01;
     |DDEFECTO #cretam01;
     #cretam01#0 = nEmp;
     #cretam01#1 = nAny;
     #cretam01#2 = nMes;
     #cretam01#3 = nTipo;
     |LEE 101#cretam01.=;
     |SI FSalida ! 0;
          |GRABA 020#cretam01.n;
     |FINSI;
     |LIBERA #cretam01;

     || Ahora dentro de la empresa doy de alta el CCC del centro
     |HAZ cretam02;
|FPRC;

|PROCESO CompCentro;
/*
     #labtraba#0 = nEmp;
     #labtraba#1 = nTra;
     |LEE 000#labtraba.=;
     |SI FSalida = 0;
          #tsilcon9#0 = #labtraba#0;
          #tsilcon9#1 = #labtraba#77;
          |LEE 000#tsilcon9.=;
          |SI FSalida = 0;
               |SI #tsilcon9#3 ! "*";
                    swStop = 1;
               |FINSI;
          |FINSI;
     |FINSI;
*/
|FPRC;

|PROCESO nombotra;
     |SI fFechaIniPer [ #nombotra#4; |Y #nombotra#4 [ fFechaFinPer;
          fFechaIniTramo = #nombotra#4;
          nCodTipo = 411;
          aDesTipo = "INI.BON.F.";
          |HAZ GrabaTramo;
     |FINSI;

     |SI fFechaIniPer [ #nombotra#5; |Y #nombotra#5 [ fFechaFinPer;
          fFechaIniTramo = #nombotra#5;
          nCodTipo = 419;
          aDesTipo = "FIN.BON.F.";
          |HAZ GrabaTramo;
     |FINSI;
|FPRC;

|DEFBUCLE nombotra;
    #nombotra#1;
    ;
    #labtraba#0, #labtraba#1, 001;
    #labtraba#0, #labtraba#1, 999;
    ;
    NULL, nombotra;
|FIN;

|PROCESO bonificaciones;
     |SI nBonifMan ! 0;
          fFechaIniBon = #labtraba#40;
          |SI fFechaIniPer [ fFechaIniBon; |Y fFechaIniBon [ fFechaFinPer;
               fFechaIniTramo = fFechaIniBon;
               nCodTipo = 401;
               aDesTipo = "INI BONIF";
               |HAZ GrabaTramo;
          |FINSI;

          fFechaFinBon = #labtraba#41;
          |SI fFechaIniPer [ fFechaFinBon; |Y fFechaFinBon [ fFechaFinPer;
               fFechaIniTramo = fFechaFinBon;
               nCodTipo = 409;
               aDesTipo = "FIN BONIF";
               |HAZ GrabaTramo;
          |FINSI;
     |FINSI;

     |BUCLE nombotra;
|FPRC;

|PROCESO BuscaRecaida;
     nDiasRecaida = 0;

     |ABRE #nomhisit;
     #nomhisit#0 = #labtraba#0;
     #nomhisit#1 = #labtraba#1;
     #nomhisit#2 = nElAny;
     #nomhisit#3 = nElMes;
     #nomhisit#8 = nCampo - 26;
     |LEE 000#nomhisit.=;
     |SI FSalida = 0;
          nDiasRecaida = #nomhisit#11;
     |FINSI;

     |CIERRA #nomhisit;
|FPRC;

|PROCESO BuscaITs;
     nDiasAcumEnf = 0;
     nPrestManEnf = 0;
     nPrestManAcc = 0;

     |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
          nCampo1 = nCampo - 8;
          nCampo2 = nCampo - 4;
          |SI #0#3 = "M";
               aTipo = #nomcalca#nCampo#; nDesde = #nomcalca#nCampo1#;
               nHasta = #nomcalca#nCampo2#;
               nDiasAcumEnf = #labtraba#89;
               nPrestManEnf = #nomcalca#57;
               nPrestManAcc = #nomcalca#58;

               nCampo3 = nCampo + 65;
               nDiasRecaida = 0;
               |SI #nomcalca#nCampo3# = "S";
                    |HAZ BuscaRecaida;
                    nDiasAcumEnf = nDiasAcumEnf + nDiasRecaida;
               |FINSI;
          |FINSI;
          |SI #0#3 = "H";
               aTipo = #nomhicca#nCampo#; nDesde = #nomhicca#nCampo1#;
               nHasta = #nomhicca#nCampo2#;
               nDiasAcumEnf = #nomhicca#70;
               nPrestManEnf = #nomhicca#57;
               nPrestManAcc = #nomhicca#58;

               nCampo3 = nCampo + 107;
               nDiasRecaida = 0;
               |SI #nomhicca#nCampo3# = "S";
                    |HAZ BuscaRecaida;
                    nDiasAcumEnf = nDiasAcumEnf + nDiasRecaida;
               |FINSI;
          |FINSI;
          |SI #0#3 = "A";
               aTipo = #nomcalac#nCampo#; nDesde = #nomcalac#nCampo1#;
               nHasta = #nomcalac#nCampo2#;
          |FINSI;
          |QBF aTipo;

          |SI aTipo ! ""; |Y aTipo ! "0";
               swDesde = 0;
               swHasta = 0;
               swPrest = 0;
               nDiaIT = 0;

               || TIPO DE IT: DESDE X HASTA X

               nHastaReal = nHasta;

               |SI nHasta = 0;
                    aAlfa = fFechaFinPer;
                    aAlfa = aAlfa % 102;
                    nHasta = aAlfa;
               |FINSI;

               |SI nDesde ! 0;
                    aAlfa1 = nDesde;
                    |QBF aAlfa1;
                    aAlfa1 = ("00" + aAlfa1) % -102;
                    aAlfa = aAlfa1 + "." + aMes + "." + aAny;

                    swDesde = 1; swHasta = 0; swPrest = 0;
                    fFechaIniTramo = aAlfa;
                    |HAZ CodigoTiposEnf;
                    |HAZ GrabaTramo;

                    || SI ES ENFERMEDAD GRABA LA PRESTACION

                    |SI aTipo = "E"; |Y nPrestManEnf ! 0;
                         |SI nDiasRecaida = 0;
                              || normal, sin recaida
                              nNume = nHasta - nDesde + 1;
                              |SI nNume > 15;
                                   nNume = nDesde + 15;
                                   aAlfa1 = nNume;
                                   |QBF aAlfa1;
                                   aAlfa1 = ("00" + aAlfa1) % -102;
                                   aAlfa = aAlfa1 + "." + aMes + "." + aAny;
                                   swDesde = 0; swHasta = 0; swPrest = 1;
                                   nDiaIT = 16;
                                   fFechaIniTramo= aAlfa;
                                   |HAZ CodigoTiposEnf;
                                   |HAZ GrabaTramo;
                              |FINSI;
                         |SINO;
                              || recaida, que sumados a los dias de la IT
                              || hace que durante esta IT se cumple el dia 16
                              || en que comienza la prestacion

                              nNume = nHasta - nDesde + 1;
                              nNume1 = nNume + nDiasRecaida;
                              |SI nDiasRecaida < 16; |Y nNume1 ] 16;
                                   nNume = 16 - nNume + nDesde;
                                   aAlfa1 = nNume;
                                   |QBF aAlfa1;
                                   aAlfa1 = ("00" + aAlfa1) % -102;
                                   aAlfa = aAlfa1 + "." + aMes + "." + aAny;
                                   swDesde = 0; swHasta = 0; swPrest = 1;
                                   nDiaIT = (nHasta - nDesde + 1) + nDiasRecaida + 1;
                                   fFechaIniTramo = aAlfa;
                                   |HAZ CodigoTiposEnf;
                                   |HAZ GrabaTramo;
                              |SINO;
                                   || caso de que entre los dias de IT y los de
                                   || prestacion, llevamos mas de 16, con lo que
                                   || hay que meter la prestacion

                                   |SI nNume1 ] 15;
                                        aAlfa1 = nDesde;
                                        |QBF aAlfa1;
                                        aAlfa1 = ("00" + aAlfa1) % -102;
                                        aAlfa = aAlfa1 + "." + aMes + "." + aAny;
                                        nDiaIT = nDiasRecaida + 1;

                                        swDesde = 0; swHasta = 0; swPrest = 1;
                                        fFechaIniTramo = aAlfa;
                                        |HAZ CodigoTiposEnf;
                                        |HAZ GrabaTramo;
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;

               || TIPO DE IT: DESDE 0 HASTA X

               |SI nDesde = 0;
                    || regrabo el dia 1 para saber que venia de IT
                    aAlfa1 = 1;
                    |QBF aAlfa1;
                    aAlfa1 = ("00" + aAlfa1) % -102;
                    aAlfa = aAlfa1 + "." + aMes + "." + aAny;

                    swDesde = 1; swHasta = 0; swPrest = 0;
                    fFechaIniTramo = aAlfa;
                    |HAZ CodigoTiposEnf;
                    |HAZ GrabaTramo;

                    || EN ENFERMEDAD GRABO LA PRESTACION SI HAY

                    |SI aTipo = "E"; |Y nPrestManEnf ! 0;
                         || ahora si hay prestacion por enf grabo la prestacion


                         nNume1 = nHasta + nDiasAcumEnf;
                         |SI nNume1 > 15;
                              |SI nDiasAcumEnf [ 15;
                                   nNume = 15 - nDiasAcumEnf + 1;
                              |SINO;
                                   nNume = 1;
                              |FINSI;
                              |SI nNume [ nHasta;
                                   aAlfa1 = nNume;
                                   |QBF aAlfa1;
                                   aAlfa1 = ("00" + aAlfa1) % -102;
                                   aAlfa = aAlfa1 + "." + aMes + "." + aAny;
                                   swDesde = 0; swHasta = 0; swPrest = 1;
                                   fFechaIniTramo = aAlfa;
                                   || dias de IT acumulados cuando empieza el tramo
                                   || con prestacion
                                   nDiaIT = nDiasAcumEnf + nNume;
                                   |HAZ CodigoTiposEnf;
                                   |HAZ GrabaTramo;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;

               || TIPO DE IT: HASTA X, PARA MARCAR EL FINAL DE LA IT

               |SI nHastaReal ! 0;
                    aAlfa1 = nHasta;
                    |QBF aAlfa1;
                    aAlfa1 = ("00" + aAlfa1) % -102;
                    aAlfa2 = #0#1; |QBF aAlfa2; aAlfa2 = ("00" + aAlfa2) % -102;
                    aAlfa3 = #0#0;
                    aAlfa = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;

                    swDesde = 0; swHasta = 1; swPrest = 0;
                    fFechaIniTramo = aAlfa;
                    |HAZ CodigoTiposEnf;
                    |HAZ GrabaTramo;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO ComparaMeses;
     #cretat04#0 = #cretam04#0;
     #cretat04#1 = #cretam04#1;
     #cretat04#2 = nMesAnt;
     #cretat04#3 = #cretam04#3;
     #cretat04#4 = #cretam04#4;
     #cretat04#5 = #cretam04#5;
     #cretat04#6 = #cretam04#6;
     |LEE 101#cretat04.=;
     |SI FSalida = 0;
          |PARA nCampo = 30;
          |SI nCampo [ 69; |Y swDiferente = 0;
          |HACIENDO nCampo = nCampo + 1;
               |SI #cretat04#nCampo# ! #cretam04#nCampo#;
                    swDiferente = 1;
                    |ERROR10;
               |FINSI;
          |SIGUE;
     |SINO;
          swDiferente = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE ComparaMeses;
     #cretam04#1;
     ;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 01;
     nEmp, nAny, nMes, nTipo, aCCC, aNAFSS, 99;
     ;
     NULL, ComparaMeses;
|FIN;

|PROCESO GrabaMesAnt;
     #cretat04#0 = #cretam04#0;
     #cretat04#1 = #cretam04#1;
     #cretat04#2 = #cretam04#2;
     #cretat04#3 = #cretam04#3;
     #cretat04#4 = #cretam04#4;
     #cretat04#5 = #cretam04#5;
     #cretat04#6 = #cretam04#6;
     |LEE 101#cretat04.=;
     FEstado = FSalida;

     |PARA nCampo = 7; |SI nCampo [ 71; |HACIENDO nCampo = nCampo + 1;
          #cretat04#nCampo# = #cretam04#nCampo#;
     |SIGUE;

     |SI FEstado = 0;
          |GRABA 020#cretat04.a;
     |SINO;
          |GRABA 020#cretat04.n;
     |FINSI;
     |LIBERA #cretat04;
|FPRC;

|DEFBUCLE GrabaMesAnt;
     #cretam04#1;
     ;
     nEmp, nAny, nMesAnt, nTipo, aCCC, aNAFSS, 01;
     nEmp, nAny, nMesAnt, nTipo, aCCC, aNAFSS, 99;
     ;
     NULL, GrabaMesAnt;
|FIN;

|PROCESO MesAnterior;
     |SI nMes = 1;
          |ACABA;
     |FINSI;

     nMesAnt = nMes - 1;

     |BUCLE GrabaMesAnt;

     swDiferente = 0;

     |BUCLE ComparaMeses;

     |SI swDiferente = 0;
          #cretam03#12 = "S";
     |SINO;
          #cretam03#12 = "N";
     |FINSI;
     |LEE 101#cretam03.=;     || vuelvo a leer que si no la ficha no esta leida

     |GRABA 020#cretam03.a;
     |LIBERA 020#cretam03;
|FPRC;

|PROCESO Fechas;
     #labtraba#0 = nEmp;
     #labtraba#1 = nTra;
     |LEE 000#labtraba.=;

     fFechaAlta = aFechaAlta;
     aNAFSS = #labtraba#75;
     |QBF aNAFSS;
     aAlfa1 = aNAFSS % 102;
     aAlfa2 = aNAFSS % 310;
     |QBF aAlfa2;
     aAlfa2 = ("0000000000" + aAlfa2) % -110;
     aNAFSS = aAlfa1 + aAlfa2;

     aAlfa = aFechaBaja;
     |QBF aAlfa;
     |SI aAlfa = ""; |O aAlfa = "..........";
          fFechaBaja = "31.12.2999";
     |SINO;
          fFechaBaja = aAlfa;
     |FINSI;

     |SI nTipo = 2;
          nFechaBaja = fFechaBaja;
          nFechaAlta = nFechaBaja + 1;
          fFechaAlta = nFechaAlta;

          nFechaBaja = fFechaAlta + nDiasVac1 - 1;
          fFechaBaja = nFechaBaja;
     |FINSI;

     nMes = nElMes;
     nAny = #0#0;
     |HAZ topemes;

     aMes = nMes; |QBF aMes; aMes = ("00" + aMes) % -102;
     aAny = nAny;

     aAlfa1 = topemes;
     aAlfa = aAlfa1 + "." + aMes + "." + aAny;
     fFechaFinPer = aAlfa;

     fFechaFinMes = aAlfa;
     nFechaFinMes = fFechaFinMes;

     aAlfa1 = "01";
     aAlfa = aAlfa1 + "." + aMes + "." + aAny;
     fFechaIniPer = aAlfa;

     fFechaIniMes = aAlfa;
     nFechaIniMes = fFechaIniMes;

     |SI fFechaAlta > fFechaIniPer;
          fFechaIniPer = fFechaAlta;
     |FINSI;

     |SI fFechaBaja < fFechaFinPer;
          fFechaFinPer = fFechaBaja;
     |FINSI;

     nNume1 = fFechaIniPer;
     nNume2 = fFechaFinPer;

     nDiasMesTrab = nNume2 - nNume1 + 1;
|FPRC;

|PROCESO VarAtrasos;
     nBaseComunes_Alta = #nomcalac#39;  || para las L13

     |SI swCuenta = 1;
          |ACABA;
     |FINSI;

     nTipo = #nomcalac#3;
     aFechaAlta = #nomcalac#4;
     aFechaBaja = #nomcalac#5;

     nDiasVac1 = #nomcalac#171;
     nDiasVac2 = #nomcalac#172;

     |HAZ Fechas;

     nBonifMan = #nomcalac#63;
     nBonifFom = #nomcalac#96;

     nDiasCot = #nomcalac#8;

     |SI #labtraba#42 = "C";
          nDiasCot = #nomcalac#55;
     |FINSI;
     nPromedioCC = #nomcalac#35;
     nPromedioATEP = #nomcalac#36;
     nBaseDiariaERE = #nomcalac#127;
     nPrestEnf = #nomcalac#57;
     nPrestAcc = #nomcalac#58;
     nBaseComunes_Alta = #nomcalac#39;
     nBaseATEP_Alta = #nomcalac#40;
     nBaseEnfAcc = #nomcalac#62;
     nBaseEnfAcc = nBaseEnfAcc - #nomcalac#117 - #nomcalac#130;
     nBaseEnfAcc = nBaseEnfAcc - #nomcalac#132;
     nBaseComunes_Alta = nBaseComunes_Alta - nBaseEnfAcc;
     nBaseATEP_Alta = nBaseATEP_Alta - nBaseEnfAcc;
     nBaseMat = #nomcalac#117;
     |SI #nomcalac#139 ! 0;
          nBasePat = nBaseMat;
          nBaseMat = 0;
     |FINSI;
     nBaseRie = #nomcalac#130;
     nBaseCon = #nomcalac#132;
     nBaseERE = #nomcalac#128;
     nBaseHorasFM = #nomcalac#41;
     nBaseHorasOtras = #nomcalac#42;

     nNumHorasComp = 0;
     |SI nBaseHorasFM ! 0; |O nBaseHorasOtras ! 0;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
               |PARA nConcepto = 301; |SI nConcepto [ 310; |HACIENDO nConcepto = nConcepto + 1;
                    #nomcalli#0 = #nomcalac#0;
                    #nomcalli#1 = #nomcalac#1;
                    #nomcalli#2 = #nomcalac#2;
                    #nomcalli#3 = #nomcalac#3;
                    #nomcalli#4 = nConcepto;
                    |LEE 000#nomcalli.=;
                    |SI FSalida = 0;
                         nNumHorasComp = nNumHorasComp + #nomcalli#11;
                    |FINSI;
               |SIGUE;
          |FINSI;
     |FINSI;

     |SI nTipo = 2;
          nDiasCot = nDiasVac1 + nDiasVac2;
          |SI nDiasVac2 = 0;
               nDias99 = 0;  || para las L13
          |SINO;
               nDias99 = nDiasVac2;  || para las L13
          |FINSI;
     |FINSI;

     nDiasAlta = nDiasCot;
     nDiasEnf = #nomcalac#31;
     nDiasAcc = #nomcalac#32;
     nDiasMat = #nomcalac#65 - #nomcalac#139 - #nomcalac#129;
     nDiasPat = #nomcalac#139;
     nDiasRie = #nomcalac#129;
     nDiasCon = #nomcalac#131;
     nDiasERE = #nomcalac#78;
     nPropERE = 100;
     nJornadasIT = #nomcalac#55;
     |SI nDiasERE > 0;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomcalac#nCampo# = "D";
                    nCampo1 = nCampo + 92;
                    nPropERE = #nomcalac#nCampo1#;
               |FINSI;
          |SIGUE;
     |FINSI;
     swTopeMin = 0;
     |SI #nomcalac#168 = "m"; |O #nomcalac#169 = "m";
          swTopeMin = 1;
     |FINSI;

     |SI nDiasPat ! 0;
          nDiasMat = 0;
     |FINSI;

     || Ajuste Mensuales

     aUltimaIT = "";
     nAny = #0#0;
     nMes = #nomcalac#2;
     |HAZ topemes;

     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
     |Y #labtraba#42 ! "E";
     |Y topemes ! 30; |Y nDiasMesTrab = topemes;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomcalac#nCampo# = "E"; |O #nomcalac#nCampo# = "A";
               |O #nomcalac#nCampo# = "M"; |O #nomcalac#nCampo# = "P";
               |O #nomcalac#nCampo# = "R"; |O #nomcalac#nCampo# = "C";
               |O #nomcalac#nCampo# = "D";
                    aUltimaIT = #nomcalac#nCampo#;
               |FINSI;
          |SIGUE;
          nAjuste = topemes - 30;
          |SI aUltimaIT ! "";
               |SI aUltimaIT = "E"; nDiasEnf = nDiasEnf - nAjuste; |FINSI;
               |SI aUltimaIT = "A"; nDiasAcc = nDiasAcc - nAjuste; |FINSI;
               |SI aUltimaIT = "M"; nDiasMat = nDiasMat - nAjuste; |FINSI;
               |SI aUltimaIT = "P"; nDiasPat = nDiasPat - nAjuste; |FINSI;
               |SI aUltimaIT = "R"; nDiasRie = nDiasRie - nAjuste; |FINSI;
               |SI aUltimaIT = "C"; nDiasCon = nDiasCon - nAjuste; |FINSI;
               |SI aUltimaIT = "D";
                    nDiasERE = nDiasERE - (nAjuste * (nPropERE / 100));
               |FINSI;
          |FINSI;
     |FINSI;

     nDiasCotIT = nDiasEnf + nDiasAcc + nDiasMat + nDiasPat;
     nDiasCotIT = nDiasCotIT + nDiasRie + nDiasCon;

     nDiasCotAlta = nDiasCot - nDiasCotIT;

     |SI nPromedioCC ! nPromedioATEP;
          nBaseComunes_Alta = #nomcalac#39 - (nDiasCotIT * nPromedioCC);
     |FINSI;

     aTipoHorasFor = "";
     nNumHorasFor = #nomcalac#107;
     nNume = #nomcalac#64 / nNumHorasFor;
     |SI nNume = 5;
          aTipoHorasFor = "D";
     |SINO;
          aTipoHorasFor = "P";
     |FINSI;
|FPRC;

|PROCESO VarHistorico;
     nBaseComunes_Alta = #nomhicca#39;  || para las L13

     |SI swCuenta = 1;
          |ACABA;
     |FINSI;

     nTipo = #nomhicca#3;
     aFechaAlta = #nomhicca#4;
     aFechaBaja = #nomhicca#5;

     nDiasVac1 = #nomhicca#213;
     nDiasVac2 = #nomhicca#214;

     |HAZ Fechas;

     nBonifMan = #nomhicca#63;
     nBonifFom = #nomhicca#138;

     nDiasCot = #nomhicca#8;

     |SI #labtraba#42 = "C";
          nDiasCot = #nomhicca#55;
     |FINSI;
     nPromedioCC = #nomhicca#35;
     nPromedioATEP = #nomhicca#36;
     nBaseDiariaERE = #nomhicca#169;
     nPrestEnf = #nomhicca#57;
     nPrestAcc = #nomhicca#58;
     nBaseComunes_Alta = #nomhicca#39;
     nBaseATEP_Alta = #nomhicca#40;
     nBaseEnfAcc = #nomhicca#62;
     nBaseEnfAcc = nBaseEnfAcc - #nomhicca#159 - #nomhicca#172;
     nBaseEnfAcc = nBaseEnfAcc - #nomhicca#174;
     nBaseComunes_Alta = nBaseComunes_Alta - nBaseEnfAcc;
     nBaseATEP_Alta = nBaseATEP_Alta - nBaseEnfAcc;
     nBaseMat = #nomhicca#159;
     |SI #nomhicca#181 ! 0;
          nBasePat = nBaseMat;
          nBaseMat = 0;
     |FINSI;
     nBaseRie = #nomhicca#172;
     nBaseCon = #nomhicca#174;
     nBaseERE = #nomhicca#170;
     nBaseHorasFM = #nomhicca#41;
     nBaseHorasOtras = #nomhicca#42;

     nNumHorasComp = 0;
     |SI nBaseHorasFM ! 0; |O nBaseHorasOtras ! 0;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
               |PARA nConcepto = 301; |SI nConcepto [ 310; |HACIENDO nConcepto = nConcepto + 1;
                    #nomhicli#0 = #nomhicca#0;
                    #nomhicli#1 = #nomhicca#1;
                    #nomhicli#12 = #nomhicca#66;
                    #nomhicli#2 = #nomhicca#2;
                    #nomhicli#3 = #nomhicca#3;
                    #nomhicli#4 = nConcepto;
                    |LEE 000#nomhicli.=;
                    |SI FSalida = 0;
                         nNumHorasComp = nNumHorasComp + #nomhicli#11;
                    |FINSI;
               |SIGUE;
          |FINSI;
     |FINSI;

     |SI nTipo = 2;
          nDiasCot = nDiasVac1 + nDiasVac2;
          |SI nDiasVac2 = 0;
               nDias99 = 0;  || para las L13
          |SINO;
               nDias99 = nDiasVac2;  || para las L13
          |FINSI;
     |FINSI;

     nDiasAlta = nDiasCot;
     nDiasEnf = #nomhicca#31;
     nDiasAcc = #nomhicca#32;
     nDiasMat = #nomhicca#65 - #nomhicca#181 - #nomhicca#171;
     nDiasPat = #nomhicca#181;
     nDiasRie = #nomhicca#171;
     nDiasCon = #nomhicca#173;
     nDiasERE = #nomhicca#119;
     nPropERE = 100;
     nJornadasIT = #nomhicca#55;
     |SI nDiasERE > 0;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomhicca#nCampo# = "D";
                    nCampo1 = nCampo + 134;
                    nPropERE = #nomhicca#nCampo1#;
               |FINSI;
          |SIGUE;
     |FINSI;

     swTopeMin = 0;
     |SI #nomhicca#210 = "m"; |O #nomhicca#211 = "m";
          swTopeMin = 1;
     |FINSI;

     |SI nDiasPat ! 0;
          nDiasMat = 0;
     |FINSI;

     || Ajuste Mensuales

     aUltimaIT = "";
     nAny = #0#0;
     nMes = #nomhicca#2;
     |HAZ topemes;

     nAjuste = 0;
     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
     |Y #labtraba#42 ! "E";
     |Y topemes ! 30; |Y nDiasMesTrab = topemes;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomhicca#nCampo# = "E"; |O #nomhicca#nCampo# = "A";
               |O #nomhicca#nCampo# = "M"; |O #nomhicca#nCampo# = "P";
               |O #nomhicca#nCampo# = "R"; |O #nomhicca#nCampo# = "C";
               |O #nomhicca#nCampo# = "D";
                    aUltimaIT = #nomhicca#nCampo#;
               |FINSI;
          |SIGUE;
          nAjuste = topemes - 30;
          |SI aUltimaIT ! "";
               |SI aUltimaIT = "E"; nDiasEnf = nDiasEnf - nAjuste; |FINSI;
               |SI aUltimaIT = "A"; nDiasAcc = nDiasAcc - nAjuste; |FINSI;
               |SI aUltimaIT = "M"; nDiasMat = nDiasMat - nAjuste; |FINSI;
               |SI aUltimaIT = "P"; nDiasPat = nDiasPat - nAjuste; |FINSI;
               |SI aUltimaIT = "R"; nDiasRie = nDiasRie - nAjuste; |FINSI;
               |SI aUltimaIT = "C"; nDiasCon = nDiasCon - nAjuste; |FINSI;
               |SI aUltimaIT = "D";
                    nDiasERE = nDiasERE - (nAjuste * (nPropERE / 100));
               |FINSI;
          |FINSI;
     |FINSI;

     nDiasCotIT = nDiasEnf + nDiasAcc + nDiasMat + nDiasPat;
     nDiasCotIT = nDiasCotIT + nDiasRie + nDiasCon;

     nDiasCotAlta = nDiasCot - nDiasCotIT;

     |SI nPromedioCC ! nPromedioATEP;
          nBaseComunes_Alta = #nomhicca#39 - (nDiasCotIT * nPromedioCC);
     |FINSI;

     aTipoHorasFor = "";
     nNumHorasFor = #nomhicca#149;
     nNume = #nomhicca#64 / nNumHorasFor;
     |SI nNume = 5;
          aTipoHorasFor = "D";
     |SINO;
          aTipoHorasFor = "P";
     |FINSI;
|FPRC;

|PROCESO VarMensuales;
     nBaseComunes_Alta = #nomcalca#39;  || para las L13

     |SI swCuenta = 1;
          |ACABA;
     |FINSI;

     nTipo = #nomcalca#3;
     aFechaAlta = #nomcalca#4;
     aFechaBaja = #nomcalca#5;

     nDiasVac1 = #nomcalca#171;
     nDiasVac2 = #nomcalca#172;

     |HAZ Fechas;

     nBonifMan = #nomcalca#63;
     nBonifFom = #nomcalca#96;

     nDiasCot = #nomcalca#8;

     |SI #labtraba#42 = "C";
          nDiasCot = #nomcalca#55;
     |FINSI;
     nPromedioCC = #nomcalca#35;
     nPromedioATEP = #nomcalca#36;
     nBaseDiariaERE = #nomcalca#127;
     nPrestEnf = #nomcalca#57;
     nPrestAcc = #nomcalca#58;
     nBaseComunes_Alta = #nomcalca#39;
     nBaseATEP_Alta = #nomcalca#40;
     nBaseEnfAcc = #nomcalca#62;
     nBaseEnfAcc = nBaseEnfAcc - #nomcalca#117 - #nomcalca#130;
     nBaseEnfAcc = nBaseEnfAcc - #nomcalca#132;
     nBaseComunes_Alta = nBaseComunes_Alta - nBaseEnfAcc;
     nBaseATEP_Alta = nBaseATEP_Alta - nBaseEnfAcc;
     nBaseMat = #nomcalca#117;
     |SI #nomcalca#139 ! 0;
          nBasePat = nBaseMat;
          nBaseMat = 0;
     |FINSI;
     nBaseRie = #nomcalca#130;
     nBaseCon = #nomcalca#132;
     nBaseERE = #nomcalca#128;
     nBaseHorasFM = #nomcalca#41;
     nBaseHorasOtras = #nomcalca#42;

     nNumHorasComp = 0;
     |SI nBaseHorasFM ! 0; |O nBaseHorasOtras ! 0;
          |SI #labtraba#42 = "X"; |O #labtraba#42 = "T";
               |PARA nConcepto = 301; |SI nConcepto [ 310; |HACIENDO nConcepto = nConcepto + 1;
                    #nomcalli#0 = #nomcalca#0;
                    #nomcalli#1 = #nomcalca#1;
                    #nomcalli#2 = #nomcalca#2;
                    #nomcalli#3 = #nomcalca#3;
                    #nomcalli#4 = nConcepto;
                    |LEE 000#nomcalli.=;
                    |SI FSalida = 0;
                         nNumHorasComp = nNumHorasComp + #nomcalli#11;
                    |FINSI;
               |SIGUE;
          |FINSI;
     |FINSI;

     |SI nTipo = 2;
          nDiasCot = nDiasVac1 + nDiasVac2;
          |SI nDiasVac2 = 0;
               nDias99 = 0;  || para las L13
          |SINO;
               nDias99 = nDiasVac2;  || para las L13
          |FINSI;
     |FINSI;

     nDiasAlta = nDiasCot;
     nDiasEnf = #nomcalca#31;
     nDiasAcc = #nomcalca#32;
     nDiasMat = #nomcalca#65 - #nomcalca#139 - #nomcalca#129;
     nDiasPat = #nomcalca#139;
     nDiasRie = #nomcalca#129;
     nDiasCon = #nomcalca#131;
     nDiasERE = #nomcalca#78;
     nPropERE = 100;
     nJornadasIT = #nomcalca#55;
     |SI nDiasERE > 0;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomcalca#nCampo# = "D";
                    nCampo1 = nCampo + 92;
                    nPropERE = #nomcalca#nCampo1#;
               |FINSI;
          |SIGUE;
     |FINSI;
     swTopeMin = 0;
     |SI #nomcalca#168 = "m"; |O #nomcalca#169 = "m";
          swTopeMin = 1;
     |FINSI;

     |SI nDiasPat ! 0;
          nDiasMat = 0;
     |FINSI;

     || Ajuste Mensuales

     aUltimaIT = "";
     nAny = #0#0;
     nMes = #nomcalca#2;
     |HAZ topemes;

     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
     |Y #labtraba#42 ! "E";
     |Y topemes ! 30; |Y nDiasMesTrab = topemes;
          |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
               |SI #nomcalca#nCampo# = "E"; |O #nomcalca#nCampo# = "A";
               |O #nomcalca#nCampo# = "M"; |O #nomcalca#nCampo# = "P";
               |O #nomcalca#nCampo# = "R"; |O #nomcalca#nCampo# = "C";
               |O #nomcalca#nCampo# = "D";
                    aUltimaIT = #nomcalca#nCampo#;
               |FINSI;
          |SIGUE;
          nAjuste = topemes - 30;
          |SI aUltimaIT ! "";
               |SI aUltimaIT = "E"; nDiasEnf = nDiasEnf - nAjuste; |FINSI;
               |SI aUltimaIT = "A"; nDiasAcc = nDiasAcc - nAjuste; |FINSI;
               |SI aUltimaIT = "M"; nDiasMat = nDiasMat - nAjuste; |FINSI;
               |SI aUltimaIT = "P"; nDiasPat = nDiasPat - nAjuste; |FINSI;
               |SI aUltimaIT = "R"; nDiasRie = nDiasRie - nAjuste; |FINSI;
               |SI aUltimaIT = "C"; nDiasCon = nDiasCon - nAjuste; |FINSI;
               |SI aUltimaIT = "D";
                    nDiasERE = nDiasERE - (nAjuste * (nPropERE / 100));
               |FINSI;
          |FINSI;
     |FINSI;

     nDiasCotIT = nDiasEnf + nDiasAcc + nDiasMat + nDiasPat;
     nDiasCotIT = nDiasCotIT + nDiasRie + nDiasCon;

     nDiasCotAlta = nDiasCot - nDiasCotIT;

     |SI nPromedioCC ! nPromedioATEP;
          nBaseComunes_Alta = #nomcalca#39 - (nDiasCotIT * nPromedioCC);
     |FINSI;

     aTipoHorasFor = "";
     nNumHorasFor = #nomcalca#107;
     nNume = #nomcalca#64 / nNumHorasFor;
     |SI nNume = 5;
          aTipoHorasFor = "D";
     |SINO;
          aTipoHorasFor = "P";
     |FINSI;
|FPRC;

|PROCESO generador;
     || PRIMERO: Cargo variables de calculo segun mensual, historico o atrasos

     |SI #0#3 = "M";
          nEmp = #nomcalca#0;
          nTra = #nomcalca#1;
          nElMes = #nomcalca#2;
          |HAZ VarMensuales;
     |FINSI;

     |SI #0#3 = "H"; |O #0#3 = "T";
          nEmp = #nomhicca#0;
          nTra = #nomhicca#1;
          nElMes = #nomhicca#2;
          |HAZ VarHistorico;
     |FINSI;

     |SI #0#3 = "A";
          nEmp = #nomcalac#0;
          nTra = #nomcalac#1;
          nElMes = #nomcalac#2;
          |HAZ VarAtrasos;
     |FINSI;

     || SEGUNDO comprobaciones a ver si el trabajador entra en la seleccion

     |SI #0#2 = "S";
          |SI #tsilco14#2 = "*";
               |SI #tsilco14#3 = "*";
                    #tsilco15#0 = nEmp;
                    #tsilco15#1 = nTra;
                    |LEE 000#tsilco15.=;
                    |SI FSalida = 0; |Y #tsilco15#7 = "*";
                         || continua
                    |SINO;
                         |ACABA;
                    |FINSI;
               |SINO;
                    || continua, no hay seleccion de trabajadores
               |FINSI;
          |SINO;
               |ACABA;
          |FINSI;
     |FINSI;

     |SI #0#5 = 2;
          |SI nBaseComunes_Alta = 0; |Y nDias99 = 0;
               |ACABA;
          |FINSI;
     |FINSI;

     #labtraba#0 = nEmp;
     #labtraba#1 = nTra;
     |LEE 000#labtraba.=;
     |SI FSalida = 0;
          |SI #labtraba#247 = 121; |O #labtraba#247 = 138; |O #labtraba#42 = "H";
          |O #labtraba#42 = "A"; |O #labtraba#42 = "E"; || agrarios no, de momento
               |ACABA;
          |FINSI;

          swStop = 0;
          |HAZ CompCentro;
          |SI swStop = 1;
               |ACABA;
          |FINSI;

          ||SI nDiasCot = 0; |ACABA; |FINSI;
     |FINSI;

     nTrabEmp = nTrabEmp + 1;

     |SI swCuenta = 1;
          |SI nEmpAnt ! nEmp; |O nTraAnt ! nTra;
               nTotalTra = nTotalTra + 1;
          |FINSI;

          aAlfa = nTotalTra;
          |QBF aAlfa;
          aAlfa = ("    " + aAlfa) % -104;
          |ATRI R; |PINTA 2151, aAlfa; |ATRI 0;

          nEmpAnt = nEmp;
          nTraAnt = nTra;

          |ACABA;
     |SINO;
          |SI nEmpAnt ! nEmp; |O nTraAnt ! nTra;
               nNroTra = nNroTra + 1;
          |FINSI;
          aAlfa = nNroTra; |QBF aAlfa;
          aAlfa = "Trabajador " + aAlfa + " de " + aTotalTra;
          |ATRI R; |PINTA 2128, aAlfa; |ATRI 0;

          nEmpAnt = nEmp;
          nTraAnt = nTra;
     |FINSI;

     || AHORA EMPIEZO CON LA GENERACION DE LOS TRAMOS

     || Primero doy de alta la empresa en el fichero de tramos
     || si no existia
     |HAZ cretam01;

     || Borro los tramos que existieran de este NAFSS
     |BUCLE borra_tramos;

     || Primero: fecha inicio y fin periodo

     swDesde = 0; swHasta = 0; swPrest = 0;

     fFechaIniTramo = fFechaIniPer;
     nCodTipo = 001;
     aDesTipo = "INI PERIODO";
     |HAZ GrabaTramo;

     fFechaIniTramo = fFechaFinPer;
     nCodTipo = 999;
     aDesTipo = "FIN PERIODO";

     |HAZ GrabaTramo;

     || Segundo: busco ITs

     |HAZ BuscaITs;

     || Tercero: busco variaciones para ver si el alta del trabajador ha sido
     || debida a alguna circunstancia que provoque cambio de tramo y hay que
     || poner el codigo

     |HAZ variaciones;

     || Cuarto: busco fechas de bonificaciones, inicio o fin

     |HAZ bonificaciones;

     || En ultimo lugar, hare la union de tramos

     || primero miro a ver cual es la ultima linea

     |BUCLE UltimaLinea;

     || Y ahora hago la union para crear los tramos
     |SELECT #1#cretam04;
     |HAZ union;

     || Paso siguiente: Ajuste Mensual
     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
     |Y #labtraba#42 ! "E";
          |SI nElMes = 1; |O nElMes = 2; |O nElMes = 3; |O nElMes = 5;
          |O nElMes = 7; |O nElMes = 8; |O nElMes = 10; |O nElMes = 12;
               |HAZ AjusteMensual;
          |SINO;
               || tengo que hacerlo porque quiero saber cual es la ultima
               || linea de alta, y esto se cuenta en este bucle
               |BUCLE CuentaDias;
          |FINSI;
     |SINO;
          || tengo que hacerlo porque quiero saber cual es la ultima
          || linea de alta, y esto se cuenta en este bucle
          |BUCLE CuentaDias;
     |FINSI;

     || lo ultimo: grabacion de bases
     |HAZ Bases;


     || ATENCION, ESTA LA POSIBILIDAD DE QUE SE HAYA CAMBIADO DE TRABAJADOR
     || PERO NO HAYA QUE CREAR UN NUEVO TRAMO, POR QUE HAYA SIDO CAMBIO DE
     || CATEGORIA

     |HAZ DosFichasSinRuptura;

     || una cosa mas, comprobar bases mes anterior para poner una marca de
     || que las bases son las mismas este mes

     |HAZ MesAnterior;
|FPRC;

|DEFBUCLE nomcalac;
     #nomcalac#1;
     ;
     #labempre#0,     1, nDesdeMes, nDesdeTipo;
     #labempre#0, 99999, nHastaMes, nHastaTipo;
     ;
     NULL, generador;
|FIN;

|DEFBUCLE nomhicca;
     #nomhicca#1;
     ;
     #labempre#0,     1, nAnyXX, nDesdeMes, nDesdeTipo;
     #labempre#0, 99999, nAnyXX, nHastaMes, nHastaTipo;
     ;
     NULL, generador;
|FIN;

|DEFBUCLE nomcalca;
     #nomcalca#1;
     ;
     #labempre#0,     1, #0#1, nHastaTipo;
     #labempre#0, 99999, #0#1, nDesdeTipo;
     ;
     NULL, generador;
|FIN;

|PROCESO carga_temporal;

     nDesdeTipo = #0#5;         || limites de tipo para el bucle
     nHastaTipo = #0#5;         || si es el RED, lo que vengan del DEF

     |SI #0#5 = 98;
          nHastaTipo = 0;
          nDesdeTipo = 0;
     |FINSI;

     nDesdeMes = #0#1;
     |SI #0#3 = "A"; |O #0#3 = "T";
          nHastaMes = #0#4;
     |SINO;
          nHastaMes = nDesdeMes;
     |FINSI;

     || procesos de carga

     tipo_bot = #0#5; tipo_top = #0#5;
     nAnyXX = #0#0 - 2000;

     |SI #0#3 = "M";    |BUCLE nomcalca;     |FINSI;

     |SI #0#3 = "H";    |BUCLE nomhicca;     |FINSI;
     |SI #0#3 = "T";    |BUCLE nomhicca;     |FINSI;

     |SI #0#3 = "A";    |BUCLE nomcalac;     |FINSI;

     |SI swCuenta = 1;
          |ACABA;
     |FINSI;

     |BUCLE limpia_NAFSS;
|FPRC;

|| PROCESOS PARA BORRAR SI EXISTIERAN, DENTRO DE LAS EMPRESAS CCCs SIN
|| NINGUN TRABAJADOR PORQUE SE HUBIERAN QUEDADO GRABADOS POR ERROR

|PROCESO limpia_CCC_2;
     swHayAlguno = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE limpia_CCC_2;
     #cretam03#1;
     ;
     #cretam02#0, #cretam02#1, #cretam02#2, #cretam02#3, #cretam02#4, "            ";
     #cretam02#0, #cretam02#1, #cretam02#2, #cretam02#3, #cretam02#4, "zzzzzzzzzzzz";
     ;
     NULL, limpia_CCC_2;
|FIN;

|PROCESO limpia_CCC;
     swHayAlguno = 0;
     |BUCLE limpia_CCC_2;
     |SI swHayAlguno = 0;
          |BORRA 020#cretam02.a;
          |LIBERA #cretam02;
     |FINSI;
|FPRC;

|DEFBUCLE limpia_CCC;
     #cretam02#1;
     ;
     nEmp, nAny, nMes, nTipo, "           ";
     nEmp, nAny, nMes, nTipo, "zzzzzzzzzzz";
     ;
     NULL, limpia_CCC;
|FIN;

|PROCESO empresas1;
     |SI #labempre#67 = "S";
          |DDEFECTO #tsilco14;
          #tsilco14#0 = #labempre#0;
          |LEE 000#tsilco14.=;
          |SI #0#2 = "S";
               |SI FSalida ! 0; |O #tsilco14#2 ! "*";
                    |ACABA;
               |FINSI;
          |FINSI;

          |SI swCuenta = 1;
               nTotalEmp = nTotalEmp + 1;
               aAlfa = nTotalEmp;
               |QBF aAlfa;
               aAlfa = ("    " + aAlfa) % -104;
               ||ATRI R; |PINTA 2051, aAlfa; |ATRI 0;
          |SINO;
               nNroEmp = nNroEmp + 1;
               aAlfa = nNroEmp; |QBF aAlfa;
               aAlfa = "  Empresa " + aAlfa + " de " + aTotalEmp;
               || |ATRI R; |PINTA 2028, aAlfa; |ATRI 0;
          |FINSI;

          nTrabEmp = 0;
          |HAZ carga_temporal;
          |SI nTrabEmp = 0;
               |SI swCuenta = 1;
                    nTotalEmp = nTotalEmp - 1;
                    aAlfa = nTotalEmp;
                    |QBF aAlfa;
                    aAlfa = ("    " + aAlfa) % -104;
                    |ATRI R; |PINTA 2051, aAlfa; |ATRI 0;
               |SINO;
                    nNroEmp = nNroEmp - 1;
                    aAlfa = nNroEmp;
                    |QBF aAlfa;
                    aAlfa = "  Empresa " + aAlfa + " de " + aTotalEmp;
                    |ATRI R; |PINTA 2028, aAlfa; |ATRI 0;
               |FINSI;
          |SINO;
               |SI swCuenta ! 1;
                    |BUCLE limpia_CCC;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE empresas;
     #labempre#1;
     ;
     00001;
     99999;
     ;
     NULL, empresas1;
|FIN;

|PROCESO CargaTramos;
     |ATRI R;
     ||            1   2         3         4         5         6
     ||            56789012345678901234567890123456789012345678901234
     |PINTA 1715, "                                                  ";
     |PINTA 1815, " Realizando  recuento de  empresas y trabajadores ";
     |PINTA 1915, " ------------------------------------------------ ";
     |PINTA 2015, "           N£mero de empresas ...:                ";
     |PINTA 2115, "           N£mero de trabajadores:                ";
     |PINTA 2215, "                                                  ";
     |ATRI 0;

     swCuenta = 1;
     nTotalEmp = 0;
     nTotalTra = 0;

     |BUCLE empresas;
     aTotalEmp = nTotalEmp;
     aTotalTra = nTotalTra;
     |ATRI R;
     ||            1   2         3         4         5         6
     ||            56789012345678901234567890123456789012345678901234
     |PINTA 1715, "                                                  ";
     |PINTA 1815, " Procesando la generaci¢n de tramos de cotizaci¢n ";
     |PINTA 1915, " ------------------------------------------------ ";
     |PINTA 2015, "                                                  ";
     |PINTA 2115, "                                                  ";
     |PINTA 2215, "                                                  ";
     |ATRI 0;

     swCuenta = 0;
     |BUCLE empresas;
|FPRC;

|PROCESO Centra;
     aLon = aCadena % 0;
     nLon = aLon;
     nBlancos = nEspacio - nLon;
     nNume = nBlancos / 2;
     nBlancosIzd = nNume ! 0;
     nBlancosDer = nBlancos - nBlancosIzd;
     aBlancosIzd = " " * nBlancosIzd;
     aBlancosDer = nBlancosDer * " ";
     aCadenaSal = aBlancosIzd + aCadena + aBlancosDer;
|FPRC;

|PROCESO Mensaje;
     |ATRI R;
     |BLANCO 16142265;
     ||CUADRO 16142265;
               ||  1       2         3         4         5         6
               ||  234567890123456789012345678901234567890123456789012345678

     aLinea = "Se han generado los tramos pertenecientes a";
     aCadena = aLinea; nEspacio = 49; |HAZ Centra;
     |PINTA 1715, aCadenaSal;
     aLinea = "la liquidaci¢n solicitada. Se incluyen:"
     aCadena = aLinea; nEspacio = 49; |HAZ Centra;
     |PINTA 1815, aCadenaSal;
     aAlfa = nTotalEmp; |QBF aAlfa;
     aLinea = aAlfa + " empresas";
     aCadena = aLinea; nEspacio = 49; |HAZ Centra;
     |PINTA 2015, aCadenaSal;
     aAlfa = nTotalTra; |QBF aAlfa;
     aLinea = aAlfa + " trabajadores";
     aCadena = aLinea; nEspacio = 49; |HAZ Centra;
     |PINTA 2115, aCadenaSal;
     |PINTA 2215, "                                                  ";

     |ATRI 0;
     |PAUSA;
|FPRC;

|PROCESO tipo3;
     |ABRE #labempre;
     |ABRE #12;
     ||ABRE #tsilcon5;
     |ABRE #tsilco14;
     |ABRE #tsilco15;
     |ABRE #labcentr;
     |ABRE #nomcenes;

     |ABRE #nomcalca;
     |ABRE #nomcalli;
     |ABRE #nomhicca;
     |ABRE #nomhicli;
     |ABRE #nomcalac;

     |ABRE #cretam01;
     |ABRE #cretam02;
     |ABRE #cretam03;
     |ABRE #cretam04;

     ||ABRE #tsilcon6;
     ||ABRE #tsilcon9;
     ||SELECT #2#tsilcon6;

     |HAZ control;

     |SI #0#3 = "M"; |O #0#3 = "H";
          |HAZ CargaTramos;
     |FINSI;

     |SI #0#3 = "A"; |O #0#3 = "T";
          |HAZ CargaTramos;
/*
          |PARA nMesAtrasos = #0#1; |SI nMesAtrasos [ #0#4; |HACIENDO nMesAtrasos = nMesAtrasos + 1;
               nElMes = nMesAtrasos;
               |HAZ CargaTramos;
          |SIGUE;
*/
     |FINSI;

     ||CIERRA #tsilcon9;
     ||CIERRA #tsilcon6;

     |CIERRA #cretam04;
     |CIERRA #cretam03;
     |CIERRA #cretam02;
     |CIERRA #cretam01;

     |CIERRA #nomcalac;
     |CIERRA #nomhicli;
     |CIERRA #nomhicca;
     |CIERRA #nomcalli;
     |CIERRA #nomcalca;
     |CIERRA #nomcenes;

     |CIERRA #labcentr;
     |CIERRA #labempre;
     |CIERRA #12;
     ||CIERRA #tsilcon5;
     |CIERRA #tsilco14;
     |CIERRA #tsilco15;

     |DBASS aAlfa; |QBF aAlfa;
     |SI aAlfa ! "/u/dsprofes/";
          ||DELINDEX #tsilcon9;
          |DELINDEX #tsilco14;      || parrilla empresas        se queda con la seleccion
          |DELINDEX #tsilco15;      || parrilla trabajadores    para volver a hacer el
     |FINSI;                                              || lote
|FPRC;

|PROCESO ElProceso;
     nElAny = #0#0;
     nElMes = #0#1;

     enDesCen = 1;
     enHasCen = 99;
     eaFuente = #0#3;
     |HAZ tipo3;
|FPRC;

|PROGRAMA;
     aParam = PARAMETRO;
     |QBF aParam;
     |SI aParam = "";
          |CLS;
          |CABEZA "GENERACION LIQUIDACION CRETA";

          |ABRE #0;
          |LEE 000#0p;
          |SI FSalida ! 0;
               |DDEFECTO #0;
               |GRABA 020#0n;
          |FINSI;
          |LEE 101#0=;

          ||HAZ defectoMesAny;
          |HAZ ActivaCampos;
          ||HAZ notipo;
          |PINPA #0#0;
          |PINDA #0#0;
          |ENDATOS #1#0;
          |SI FSalida = 0;
               alfa4 = Usuario; |QBT alfa4; alfa4 = ("w" + alfa4) % 108;
               |NOME_DAT #cretat04#alfa4#;
               |DELINDEX #cretat04;
               |ABRE #cretat04;

               |HAZ ElProceso;
               |SI nTotalEmp > 0; |Y nTotalTra > 0;
                    |HAZ Mensaje;
               |SINO;
                    aAlfa = "    No se han encontrado trabajadores para incluir ";
                    aAlfa = aAlfa + "en la liquidación del periodo solicitado";
                    |MENAV aAlfa;
               |FINSI;

               |CIERRA #cretat04;
          |FINSI;

          |GRABA 020#0a;
          |LIBERA #0;
          |CIERRA #0;
     |FINSI;
|FPRO;
