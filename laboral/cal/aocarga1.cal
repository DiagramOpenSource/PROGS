     Comun para aomcoste y aocargao: ActGestion

|FICHEROS;
     gopartca@ #1;
     gopartll@ #2;
     gopartli@ #3;
     goptrbca@ #4;
     goptrbli@ #5;
     gopartia@ #6;
     gomantho@ #7;
     gomantl1@ #8;
     gopre001@ #9;
     gotrabaj@ #10;
     gocatcot@ #11;
     gocatcon@ #12;
     gotrarel@ #13; || Relacion
     agifa027@ #27;
     aomparam #100;
|FIN;

|VARIABLES;
     &enForma = 0;
     &efFecha = @;
     &enUni = 0;
     &enHora = 0;
     &enObra = 0;
     &enSubobra = 0;
     &enTraba = 0;
     &enEmpre = 0;
     &enCoste = 0;
     &eaSerPre = "";
     &enNumPre = 0;
     &eaNivel = "";
     &eaCapitulo = "";
     &eaPartida = "";
     &eaDesParti = "";
     nIncr = 0;
     nTraba = 0;
     aTipoPres = "";
     nUni = 0;
     nTotCos = 0;
     nTotVen = 0;
     nHA = 0;
     nHE = 0;
     nHP = 0;
     nErr = 0;
     aAlfa = "";
     aPath = "";
     aFic = "";
     aEmp = "";
     aDef = "";
     aSerExp = "";
     nNumExp = 0;
     aSerPre = "";
     nNumPre = 0;
     nLin = 0;
     aSerPar = "";
     nNumPar = 0;
     nPreV = 0;
     nPreC = 0;
|FIN;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO BorraGes;
     |SI #6#10 ! 0; |O #6#36 ! 0; |ACABA; |FINSI; || Unidades
     |BORRA 020#6a;

     |SELECT #1#6;
     nLin = #6#6;
     #6#7 = 1;
     |LEE 000#6];
     |SI FSalida = 0; |Y #6#34 = "T"; |Y #6#4 = aSerPar; |Y #6#5 = nNumPar;
               |Y #6#6 = nLin;
          |ACABA;
     |FINSI;
     |BORRA 020#5a;

     |SELECT #1#5;
     #5#3 = 1;
     |LEE 000#5];
     |SI FSalida = 0; |Y #5#20 = aSerPre; |Y #5#21 = nNumPre; |Y #5#2 = efFecha;
          |ACABA;
     |FINSI;
     |BORRA 020#4a;
     |BORRA 020#3a;

     |SELECT #1#3;
     #3#2 = 1;
     |LEE 000#3];
     |SI FSalida = 0; |Y #3#0 = aSerPre; |Y #3#1 = nNumPre;
          |ACABA;
     |FINSI;
     |BORRA 020#2a;

     |SELECT #1#2;
     #2#2 = 1;
     |LEE 000#2];
     |SI #2#0 = aSerExp; |Y #2#1 = nNumExp;
          |ACABA;
     |FINSI;
     |BORRA 020#1a;
|FPRC;
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
|PROCESO CalcuGopartia;
     #6#45 = #6#37;
     #6#46 = #6#38;
     #6#47 = #6#39;
     #6#48 = #6#40;

     #6#49 = #6#41;
     #6#50 = #6#42;
     #6#51 = #6#43;
     #6#52 = #6#44;

     #6#13 = #6#10 * #6#37;
     #6#13 = #6#13 < #6#38;
     #6#13 = #6#13 < #6#39;
     #6#13 = #6#13 < #6#40;
     #6#11 = #6#13 / #6#10;

     #6#14 = #6#10 * #6#41;
     #6#14 = #6#14 < #6#42;
     #6#14 = #6#14 < #6#43;
     #6#14 = #6#14 < #6#44;
     #6#12 = #6#14 / #6#10;

     #6#24 = #6#10 * #6#45;
     #6#24 = #6#24 < #6#46;
     #6#24 = #6#24 < #6#47;
     #6#24 = #6#24 < #6#48;
     #6#22 = #6#24 / #6#10;

     #6#25 = #6#10 * #6#49;
     #6#25 = #6#25 < #6#50;
     #6#25 = #6#25 < #6#51;
     #6#25 = #6#25 < #6#52;
     #6#23 = #6#25 / #6#10;
|FPRC;

|PROCESO Graba6;
     nUni = enUni * enForma;

     |DDEFECTO #6;
     #6#34 = "T";
     #6#4 = aSerPar;
     #6#5 = nNumPar;
     #6#6 = #5#3;
     #6#7 = 1;
     |LEE 101#6=;
     |SI FSalida ! 0; |GRABA 020#6b; |FINSI;
     #6#0 = aSerPre;
     #6#1 = nNumPre;
     #6#2 = aSerExp;
     #6#3 = nNumExp;
     #6#10 = #6#10 + nUni;
     #6#15 = #7#2;
     #6#16 = #7#8;
     #6#20 = #12#13; ||Articulo
     #6#21 = #7#6;
     #6#28 = #3#3;
     #6#36 = #6#10;

/***************************************
     nPreV = 0; nPreC = 0;
     |SI #9#18 = "P";
          nPreV = #11#4;                 ||PVP.
          nPreC = #11#5;                 ||PVC.
     |FINSI;
     |SI #9#18 = "A";
          nPreV = #11#6;                 ||PVP.
          nPreC = #11#7;                 ||PVC.
     |FINSI;
     |SI #9#18 = "E";
          nPreV = #11#8;                 ||PVP.
          nPreC = #11#9;                 ||PVC.
     |FINSI;
*/
     #6#37 = nPreV;
     #6#38 = 0;
     #6#39 = 0;
     #6#40 = 0;
     #6#41 = nPreC;
     #6#42 = 0;
     #6#43 = 0;
     #6#44 = 0;

     |SI eaNivel = "P";
          #6#8 = eaPartida;
          #6#9 = eaDesParti;
     |FINSI;
     |SI eaNivel = "P"; |O eaNivel = "C";
          #6#33 = eaCapitulo;
     |FINSI;
     |HAZ CalcuGopartia;

     #6#29 = "T";        || tipo de articulo

     |GRABA 020#6a;
     |LIBERA #6;

     nTotCos = nPreC * nUni;
     nTotVen = nPreV * nUni;
|FPRC;

|PROCESO Graba5;
/*   esto lo comento porque asi consigo que me grabe cada registro del aomcoste
     en una linea del goptrbli y luego quede el gopartia asociado a la linea
     correspondiente cada partida
     MIGUE 05.04.2006

     |SELECT #5#5;
     #5#20 = aSerPre;
     #5#21 = nNumPre;
     #5#2 = efFecha;
     #5#4 = #10#0;
     #5#26 = enHora;
     |LEE 000#5=;
     |SI FSalida ! 0;
*/
          |SELECT #1#5;
          #5#20 = aSerPre;
          #5#21 = nNumPre;
          #5#2 = efFecha;
          #5#3 = 9999;
          |LEE 000#5];
          |SI FSalida = 0;
               |LEE 000#5a;
          |SINO;
               |LEE 000#5u;
          |FINSI;
          |SI FSalida = 0; |Y #5#20 = aSerPre; |Y #5#21 = nNumPre; |Y #5#2 = efFecha;
               nLin = #5#3 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |DDEFECTO #5;
          #5#20 = aSerPre;
          #5#21 = nNumPre;
          #5#2 = efFecha;

          #5#0 = aSerExp;
          #5#1 = nNumExp;

          #5#3 = nLin;
          #5#4 = #10#0;
          #5#5 = #10#1;
          #5#6 = #10#3;
          #5#7 = #10#25;
          #5#22 = #12#13;
          #5#23 = aSerPar;
          #5#24 = nNumPar;
          #5#26 = enHora;
          #5#27 = #11#3;
          |GRABA 020#5b;
/*
     |FINSI;
     |SELECT #1#5;
     |LEE 101#5=;
*/
|FPRC;

|PROCESO Graba4;
     |DDEFECTO #4;
     #4#0 = aSerExp;
     #4#1 = nNumExp;
     #4#2 = efFecha;
     #4#16 = aSerPre;
     #4#17 = nNumPre;
     |LEE 101#4=;
     |SI FSalida ! 0;
          |GRABA 020#4b;
     |FINSI;
     #4#3 = nNumPar;
     #4#7 = #7#2;
     #4#8 = #7#8;
     #4#14 = #7#6;
     #4#15 = aSerPar;
     #4#20 = #3#16;
|FPRC;

|PROCESO ContaParte;
     #27#0 = "partetrab";
     #27#2 = aSerExp;
     |LEE 101#27=;
     |SI FSalida = 0;
          #27#1 = #27#1 + 1;
          |GRABA 020#27a;
          |LIBERA #27;
     |SINO;
          #27#1 = 1;
          |GRABA 020#27n;
     |FINSI;
     aSerPar = #27#2;
     nNumPar = #27#1;
|FPRC;

|PROCESO Graba3;
     |SELECT #2#3;
     #3#0 = aSerPre;
     #3#1 = nNumPre;
     #3#3 = efFecha;
     |LEE 000#3=;
     |SI FSalida ! 0;
          |SELECT #1#3;
          #3#0 = aSerPre;
          #3#1 = nNumPre;
          #3#2 = 9999;
          |LEE 000#3];
          |SI FSalida = 0;
               |LEE 000#3a;
          |SINO;
               |LEE 000#3u;
          |FINSI;
          |SI FSalida = 0; |Y #3#0 = aSerPre; |Y #3#1 = nNumPre;
               nLin = #3#2 + 1;
          |SINO;
               nLin = 1;
          |FINSI;
          |HAZ ContaParte;
          |DDEFECTO #3;
          #3#0 = aSerPre;
          #3#1 = nNumPre;
          #3#2 = nLin;
          #3#3 = efFecha;
          #3#4 = aSerPar;
          #3#5 = nNumPar;
          #3#14 = aSerExp;
          #3#15 = nNumExp;
          #3#16 = #9#18;
          |GRABA 020#3b;
     |SINO;
          aSerPar = #3#4;
          nNumPar = #3#5;
     |FINSI;
     |SELECT #1#3;
     |LEE 101#3=;
|FPRC;

|PROCESO Graba2;
     |SELECT #2#2;
     #2#0 = aSerExp;
     #2#1 = nNumExp;
     #2#4 = aSerPre;
     #2#5 = nNumPre;
     |LEE 000#2=;
     |SI FSalida ! 0;
          |SELECT #1#2;
          #2#0 = aSerExp;
          #2#1 = nNumExp;
          #2#2 = 9999;
          |LEE 000#2];
          |SI FSalida = 0;
               |LEE 000#2a;
          |SINO;
               |LEE 000#2u;
          |FINSI;
          |SI FSalida = 0; |Y #2#0 = aSerExp; |Y #2#1 = nNumExp;
               nLin = #2#2 + 1;
          |SINO;
               nLin = 1;
          |FINSI;

          |DDEFECTO #2;
          #2#0 = aSerExp;
          #2#1 = nNumExp;
          #2#2 = nLin;
          #2#3 = #9#4;
          #2#4 = aSerPre;
          #2#5 = nNumPre;
          #2#14 = aTipoPres;
          |GRABA 020#2b;
     |FINSI;
     |SELECT #1#2;
     |LEE 101#2=;
|FPRC;

|PROCESO Graba1;
     |DDEFECTO #1;
     #1#0 = aSerExp;
     #1#1 = nNumExp;
     |LEE 101#1=;
     |SI FSalida ! 0;
          #1#10 = #7#2;
          #1#11 = #7#6;
          #1#12 = #7#8;
          |GRABA 020#1b;
     |FINSI;
|FPRC;

|PROCESO BusTraba;
     |SI efFecha ] #13#4;
          |SI efFecha[#13#5;|O #13#5="01.01.0000"; |O #13#5="  .  .    ";
               nTraba = #13#0;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE BusTraba;
     #13#2002;
     ;
     enEmpre, enTraba;
     enEmpre, enTraba;
     ;
     NULL, BusTraba;
|FIN;

|PROCESO BuscaPres;
     aSerPre = "";
     nNumPre = 0;
     aTipoPres = "";
     #8#0 = #7#0;
     #8#1 = #7#1;
     #8#2 = 1;
     |LEE 000#8];
     |SI FSalida = 0; |Y #8#0 = #7#0; |Y #8#1 = #7#1;
          aSerPre = #8#3;
          nNumPre = #8#4;
     |FINSI;
     |SI eaNivel = "C"; |O eaNivel = "P";
          aSerPre = eaSerPre;
          nNumPre = enNumPre;
     |FINSI;
     |DDEFECTO #9;
     #9#0 = aSerPre;
     #9#1 = nNumPre;
     |LEE 000#9=;
     aTipoPres = #9#18;
|FPRC;

|PROCESO GrabaGes;
     aSerExp = ("00000" + enObra) % -105;
     nNumExp = enSubobra;

/* Ya no se busca en gotrarel el trabajador..........
     nTraba = 0;
     |BUCLE BusTraba;
*/
     nTraba = enTraba;

     |DDEFECTO #10;
     #10#0 = nTraba;
     |LEE 000#10=;

     |DDEFECTO #11;
     #11#0 = #10#3;
     #11#1 = #10#2;
     #11#2 = enHora;
     |LEE 000#11=;

     |DDEFECTO #12;
     #12#0 = #10#3;
     #12#1 = #10#2;
     |LEE 000#12=;

     |DDEFECTO #7;
     #7#0 = aSerExp;
     #7#1 = nNumExp;
     |LEE 000#7=;
     |SI FSalida ! 0;
          #7#1 = 1;
          |LEE 000#7];        ||Que recoja el 1 expediente de la serie
          nNumExp = #7#1;
     |FINSI;

     |HAZ Graba1;
     |HAZ BuscaPres;
     |SI FSalida ! 0;
          aAlfa = "0000No existe Presupuesto. Expediente:" + aSerExp + "/"+ nNumExp;
          |MENAV aAlfa;
     |SINO;
          |SI #9#42 = "+";
               nIncr = ((#9#5-#9#6)/#9#6)*100;         ||Calcula el Incremento.
          |SINO;
               nIncr = (1 - (#9#6/#9#5))*100;
          |FINSI;
          nPreV = enCoste + (enCoste * nIncr / 100);
          nPreC = enCoste;
          |HAZ Graba2;
          |HAZ Graba3;
          |HAZ Graba4;
          |HAZ Graba5;
          |HAZ Graba6;

          nHP = 0; nHA = 0; nHE = 0;
          |SI #9#18 = "P"; nHP = nUni; |FINSI;
          |SI #9#18 = "A"; nHA = nUni; |FINSI;
          |SI #9#18 = "E"; nHE = nUni; |FINSI;
          #5#8 = #5#8 + nHP;
          #5#9 = #5#9 + nHA;
          #5#10 = #5#10 + nHE;
          #5#11 = #5#8 + #5#9 + #5#10;
          #5#12 = nPreV;
          #5#13 = nPreC;
          #5#16 = #5#11 * #5#12;
          #5#17 = #5#11 * #5#13;

          #4#4 = #4#4 + nHP;
          #4#5 = #4#5 + nHA;
          #4#6 = #4#6 + nHE;
          #4#9 = #4#4 + #4#5 + #4#6;
          #4#10 = #4#10 + nTotCos;
          #4#11 = #4#11 + nTotVen;
          #4#12 = #4#12 + nTotCos;
          #4#13 = #4#13 + nTotVen;

          #3#6 = #3#6 + nHP;
          #3#7 = #3#7 + nHA;
          #3#8 = #3#8 + nHE;
          #3#9 = #3#9 + nTotCos;
          #3#10 = #3#10 + nTotVen;
          #3#11 = #3#9;
          #3#12 = #3#10;
          #3#13 = #3#6 + #3#7 + #3#8;

          #2#6 = #2#6 + nHP;
          #2#7 = #2#7 + nHA;
          #2#8 = #2#8 + nHE;
          #2#9 = #2#9 + nTotCos;
          #2#10 = #2#10 + nTotVen;
          #2#11 = #2#9;
          #2#12 = #2#10;
          #2#13 = #2#6 + #2#7 + #2#8;

          |GRABA 020#1a;
          |GRABA 020#2a;
          |GRABA 020#3a;
          |GRABA 020#4a;
          |GRABA 020#5a;

          |LIBERA #1;
          |LIBERA #2;
          |LIBERA #3;
          |LIBERA #4;
          |LIBERA #5;
     |FINSI;
|FPRC;

|PROCESO ExisteEmpresa;
     nErr = 1;
     |DBASS aAlfa;
     aPath = #100#1; |QBF aPath;
     aPath = aAlfa + aPath;
     aFic = aPath + "/fich/";
     aDef = aPath + "/def/agifa041";
     |CARGA_DEF aDef, gopartca@;
     |SI FSalida = 0;
          aEmp = ("00000" + #100#2) % -105;
          |PATH_DAT #1 aFic;
          |ABRE #1;
          #1#0 = aEmp;
          |LEE 000#1=;
          nErr = FSalida;
          |CIERRA #1;
          |DESCARGA_DEF #gopartca@;
     |FINSI;
     FSalida = nErr;
|FPRC;

|PROCESO ActGestion;
     |ABRE #100; |LEE 000#100p; |CIERRA #100;
     || SI #100#3 = "N"; |ACABA; |FINSI;

     |HAZ ExisteEmpresa;
     |SI FSalida ! 0;
          |MENAV "0000ERROR en configuracion empresa gestion...";
          |ACABA;
     |FINSI;

     aDef = aPath + "/def/gopartca";
     |CARGA_DEF aDef, gopartca@;

     aDef = aPath + "/def/gopartll";
     |CARGA_DEF aDef, gopartll@;

     aDef = aPath + "/def/gopartli";
     |CARGA_DEF aDef, gopartli@;

     aDef = aPath + "/def/goptrbca";
     |CARGA_DEF aDef, goptrbca@;

     aDef = aPath + "/def/goptrbli";
     |CARGA_DEF aDef, goptrbli@;

     aDef = aPath + "/def/gopartia";
     |CARGA_DEF aDef, gopartia@;

     aDef = aPath + "/def/gomantho";
     |CARGA_DEF aDef, gomantho@;

     aDef = aPath + "/def/gomantl1";
     |CARGA_DEF aDef, gomantl1@;

     aDef = aPath + "/def/gopre001";
     |CARGA_DEF aDef, gopre001@;

     aDef = aPath + "/def/agifa027";
     |CARGA_DEF aDef, agifa027@;

     aDef = aPath + "/def/gotrabaj";
     |CARGA_DEF aDef, gotrabaj@;

     aDef = aPath + "/def/gocatcot";
     |CARGA_DEF aDef, gocatcot@;

     aDef = aPath + "/def/gocatcon";
     |CARGA_DEF aDef, gocatcon@;

     aDef = aPath + "/def/gotrarel";
     |CARGA_DEF aDef, gotrarel@;

     aFic = aPath + "/fich/" + aEmp + "/";
     |PATH_DAT #1 aFic;
     |PATH_DAT #2 aFic;
     |PATH_DAT #3 aFic;
     |PATH_DAT #4 aFic;
     |PATH_DAT #5 aFic;
     |PATH_DAT #6 aFic;
     |PATH_DAT #7 aFic;
     |PATH_DAT #8 aFic;
     |PATH_DAT #9 aFic;
     |PATH_DAT #10 aFic;
     |PATH_DAT #11 aFic;
     |PATH_DAT #12 aFic;
     |PATH_DAT #13 aFic;
     |PATH_DAT #27 aFic;
     |ABRE #1;
     |ABRE #2;
     |ABRE #3;
     |ABRE #4;
     |ABRE #5;
     |ABRE #6;
     |ABRE #7;
     |ABRE #8;
     |ABRE #9;
     |ABRE #27;
     |ABRE #10;
     |ABRE #11;
     |ABRE #12;
     |HAZ GrabaGes;
     |SI enForma < 0; |Y nNumPre > 0;
          |HAZ BorraGes;
     |FINSI;
     |CIERRA #1;
     |CIERRA #2;
     |CIERRA #3;
     |CIERRA #4;
     |CIERRA #5;
     |CIERRA #6;
     |CIERRA #7;
     |CIERRA #8;
     |CIERRA #9;
     |CIERRA #27;
     |CIERRA #10;
     |CIERRA #11;
     |CIERRA #12;
     |DESCARGA_DEF #gotrarel@;
     |DESCARGA_DEF #gocatcon@;
     |DESCARGA_DEF #gocatcot@;
     |DESCARGA_DEF #gotrabaj@;
     |DESCARGA_DEF #agifa027@;
     |DESCARGA_DEF #gopre001@;
     |DESCARGA_DEF #gomantl1@;
     |DESCARGA_DEF #gomantho@;
     |DESCARGA_DEF #gopartia@;
     |DESCARGA_DEF #goptrbli@;
     |DESCARGA_DEF #goptrbca@;
     |DESCARGA_DEF #gopartli@;
     |DESCARGA_DEF #gopartll@;
     |DESCARGA_DEF #gopartca@;
|FPRC;
