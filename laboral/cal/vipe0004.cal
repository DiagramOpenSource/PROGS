|FICHEROS;
     vipe0004 #0;
     vipe0002 #2;
     vipe0005 #5;
     vipe0007 #7;
     vipe0008 #8;
     vipe1001;      || tipos de horas
     vipe1002;      || control del modulo

     labtraba;
     nomcatli;
     nomtrali;
     nomvarli;
     nomconst;
     nomfical;
     nomvarca;
     nomvarli;
     labcentr;
     nomcalca;
     nomhicca;
     labempre;
     nomabsca;
     nomabsli;
|FIN;

|VARIABLES;
     aDef = "";
     fFecha = @;
     fFecha1 = @;
     fFecha2 = @;
     aFecha = "";
     aDia = "";
     nDia = 0;
     nMes = 0;
     nAny = 0;
     aMes = "";
     aAny = "";
     numer = 0;
     anynum = 0;
     bisiesto = 0;
     mesnum = 0;
     topemes = 0;
     aAlfa = "";

     aFechaDesde = "";
     aFechaHasta = "";
     fFechaAlta = @;
     fFechaBaja = @;
     fFechaDesde = @;
     fFechaHasta = @;
     nDias = 0;
     fFechaAltaMes = @;
     fFechaBajaMes = @;
     nFechaAltaMes = 0;
     nFechaBajaMes = 0;
     nHoras = 0;

     nImporte = 0;
     nConcepto = 0;
     FEstado = 0;

     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     alfa4 = "";
     &aCError = "";
     &fCFecha = @;
     &nCConst = 0;
     nLimite = 0;

     nBoton1 = 0;
     nBoton2 = 0;
     nBoton3 = 0;
     nBoton4 = 0;
     nOpcion = 0;
     swMenu = 0;

     nHorasPend = 0;
     nVacacPend = 0;
     nVacacPendAnt = 0;
     nNume = 0;
     nNume1 = 0;
     nNume2 = 0;
     nEntero = 0;
     nDeci = 0;
     nVacacCal = 0;
     swVacaciones = " ";

     desde = 0;
     hasta = 0;
     pesos = 0;
     campo = 0;
     diades = 0;
     mesdes = 0;
     diahas = 0;
     meshas = 0;
     peso = 0;
     diafij = 0;
     mesfij = 0;
     nHorasIntr = 0;
     nVacacIntr = 0;
     swAcu = 0;
     swVar = 0;
     swMen = 0;
     swHis = 0;
     swMYAP = 0;
     nBorraLin = 0;
     aTipo = "";
     aAlfa1 = "";
     aDiaD = "";
     aDiaH = "";
     nDiaD = 0;
     nDiaH = 0;
     nCampo = 0;
     nCampoD = 0;
     nCampoH = 0;
     nVacAnyAnt = 0;
     swColocada = 1;
     nDiaDMenosUno = 1;
     nModo = 0;
     nPos1 = 0;
     nPos2 = 0;

     nDiasTot = 0;
     nGridFichero = 0;
     nSalir = 0;
     aEsc1  = "";
     aEsc2  = "";
     aRetu  = "";
     aTecla = "";
     aNif = "";
     nFlag = 0;
     &enGrid = 0;
     &nIdSalir = -1;
     {2}nNivel = 0;
     nSalida = 0;

     nEmpAnt = 0;
     nTraAnt = 0;
     aNIFAnt = "";
     swHaEntrado = 0;
|FIN;

|PROCESO Tipo80; |TIPO 80;
     FSalida = 2999;
|FPRC;

|PROCESO Tipo6; |TIPO 6;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO AnyDefecto; |TIPO 7;
     fFecha = ~;
     aFecha = fFecha;
     aMes = aFecha % 402;
     nMes = aMes;
     aAny = aFecha % -104;
     nAny = aAny;
     #0#4 = nAny;
     #0#5 = nMes;
     |PINTA #0#4;
     |PINTA #0#5;
|FPRC;


|PROCESO PulsaBoton4;
|FPRC;

|PROCESO vipe0005;
     |PRINT;
|FPRC;

|DEFBUCLE vipe0005;
     #5#3;
     ;
     INICIO;
     FINAL;
     ;
     NULL, vipe0005;
|FIN;

|PROCESO PulsaBoton3;    || Imprimir
/*
     nOpcion = 3;
     swMenu = 1;
     |HAZ FinMenu;
     |CIERRA #vipe0005;
     |ACABA;
*/

     nOpcion = 3;
     swMenu = 1;

     Impresora = "CrystalReports";
     |IMPRE 0;
     |SI FSalida = 0;
          |INFOR "vipe0004";
          |SI FSalida = 0;
               |BUCLE vipe0005;
               |PIEINF;
               |FININF;
          |FINSI;
          |FINIMP;
     |FINSI;
     |ACABA;
|FPRC;

|PROCESO PulsaBoton2;    || Cancelar
     |CIERRA #vipe0005;
     |PTEC 806;
|FPRC;
/*
|PROCESO PulsaBoton2;
     nOpcion = 2;
     swMenu = 1;
|FPRC;
*/
|PROCESO CompruebaDiaD;
     |SI nDiaD = 1;
          |SI #labtraba#89 ! 0;
               |SI aTipo = #labtraba#60;
                    nDiaD = 0;
               |FINSI;
          |FINSI;
          |SI #labtraba#92 ! 0;
               |SI aTipo = "A";
                    nDiaD = 0;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO HorasNoNormales;
     #nomvarca#0 = #vipe0005#0;         || empresa
     #nomvarca#1 = #vipe0005#1;         || trabajador
     #nomvarca#2 = #vipe0005#4;         || mes
     #nomvarca#3 = 0;                   || tipo
     |LEE 101#nomvarca.=;

     aTipo = #vipe0002#7;
     |SI aTipo = "E"; |O aTipo = "A"; |O aTipo = "M"; |O aTipo = "V";
          aAlfa1 = #vipe0002#5;
          aDiaD = aAlfa1 % 102;
          nDiaD = aDiaD;

          aAlfa1 = #vipe0002#6;
          aDiaH = aAlfa1 % 102;
          nDiaH = aDiaH;

          swColocada = 0;
          |PARA nCampo = 12; |SI nCampo [ 15; |Y swColocada ! 1; |HACIENDO nCampo = nCampo + 1;
               nCampoD = nCampo - 8;
               nCampoH = nCampo - 4;
               aAlfa = #nomvarca#nCampo#;
               || primero compruebo que la baja no exista ya
               |SI aAlfa = aTipo;
                    nDiaDMenosUno = nDiaD - 1;
                    |SI nDiaDMenosUno = #nomvarca#nCampoH#;
                         #nomvarca#nCampo# = aTipo;
                         |SI nDiaH = topemes;     nDiaH = 0;     |FINSI;
                         #nomvarca#nCampoH# = nDiaH;
                         |GRABA 020#nomvarca.a;
                         swColocada = 1;
                         |SAL;
                    |FINSI;
               |FINSI;
          |SIGUE;
          || si no la he colocado antes busco un sitio vacio y la coloco
          |PARA nCampo = 12; |SI nCampo [ 15; |Y swColocada ! 1; |HACIENDO nCampo = nCampo + 1;
               nCampoD = nCampo - 8;
               nCampoH = nCampo - 4;
               aAlfa = #nomvarca#nCampo#;
               |SI aAlfa = " ";
                    |HAZ CompruebaDiaD;
                    #nomvarca#nCampo# = aTipo;
                    #nomvarca#nCampoD# = nDiaD;
                    |SI nDiaH = topemes;     nDiaH = 0;     |FINSI;
                    #nomvarca#nCampoH# = nDiaH;
                    |GRABA 020#nomvarca.a;
                    swColocada = 1;
                    |SAL;
               |FINSI;
          |SIGUE;
     |FINSI;
     |SI aTipo = "F"; |O aTipo = "f";
          |ABRE #nomabsca;
          |ABRE #nomabsli;

          #labtraba#0 = #vipe0005#0;
          #labtraba#1 = #vipe0005#1;
          |LEE 000#labtraba.=;

          #nomabsca#0 = #vipe0005#0;
          #nomabsca#1 = #vipe0005#1;
          #nomabsca#2 = #labtraba#47;

          |LEE 101#nomabsca.=;
          |SI FSalida ! 0;
               |GRABA 020#nomabsca.n;
               |LIBERA #nomabsca;
          |FINSI;

          #nomabsli#0 = #vipe0005#0;
          #nomabsli#1 = #vipe0005#1;
          #nomabsli#2 = #vipe0002#5;
          |LEE 000#nomabsli.=;
          FEstado = FSalida;

          #nomabsli#3 = #vipe0002#6;
          #nomabsli#4 = "A";
          |SI aTipo = "F";
               #nomabsli#5 = "S";
          |SINO;
               #nomabsli#5 = "N";
          |FINSI;
          #nomabsli#6 = #vipe0002#9;
          |SI FEstado = 0;
               |GRABA 020#nomabsli.a;
          |SINO;
               |GRABA 020#nomabsli.n;
          |FINSI;

          |CIERRA #nomabsli;
          |CIERRA #nomabsca;
     |FINSI;
|FPRC;

|DEFBUCLE HorasNoNormales;
     #vipe0002#1;
     ;
     #vipe0005#0, #vipe0005#1, fFechaDesde;
     #vipe0005#0, #vipe0005#1, fFechaHasta;
     ;
     NULL, HorasNoNormales;
|FIN;

|PROCESO Variaciones;
     |ABRE #nomvarca;
     |ABRE #nomvarli;

     |DDEFECTO #nomvarca;
     |DDEFECTO #nomvarli;

     #nomvarca#0 = #vipe0005#0;         || empresa
     #nomvarca#1 = #vipe0005#1;         || trabajador
     #nomvarca#2 = #vipe0005#4;         || mes
     #nomvarca#3 = 0;                   || tipo
     |LEE 101#nomvarca.=;
     |SI FSalida ! 0;
          |GRABA 020#nomvarca.n;
          |LIBERA #nomvarca;
     |SINO;
          || pongo a cero las ITs para evitar problemas
          |PARA nCampo = 12; |SI nCampo [ 15; |HACIENDO nCampo = nCampo + 1;
               nCampoD = nCampo - 8;
               nCampoH = nCampo - 4;
               #nomvarca#nCampo# = " ";
               #nomvarca#nCampoD# = 0;
               #nomvarca#nCampoH# = 0;
          |SIGUE;
          |GRABA 020#nomvarca.a;
     |FINSI;

     |BUCLE HorasNoNormales;

     |SI #vipe0005#16 = 0;
          #nomvarli#0 = #vipe0005#0;         || empresa
          #nomvarli#1 = #vipe0005#1;         || trabajador
          #nomvarli#2 = #vipe0005#4;         || mes
          #nomvarli#3 = 0;                   || tipo
          #nomvarli#4 = #vipe1002#1;         || concepto (linea)
          |LEE 101#nomvarli.=;
          |SI FSalida = 0;
               |BORRA 020#nomvarli.a;
          |FINSI;

          #nomvarli#0 = #vipe0005#0;         || empresa
          #nomvarli#1 = #vipe0005#1;         || trabajador
          #nomvarli#2 = #vipe0005#4;         || mes
          #nomvarli#3 = 0;                   || tipo
          #nomvarli#4 = #vipe1002#2;         || concepto (linea)
          |LEE 101#nomvarli.=;
          |SI FSalida = 0;
               |BORRA 020#nomvarli.a;
               |LIBERA #nomvarli;
          |FINSI;
     |SINO;
          #nomvarli#0 = #vipe0005#0;         || empresa
          #nomvarli#1 = #vipe0005#1;         || trabajador
          #nomvarli#2 = #vipe0005#4;         || mes
          #nomvarli#3 = 0;                   || tipo
          #nomvarli#4 = #vipe0005#17;         || concepto (linea)
          |LEE 101#nomvarli.=;
          FEstado = FSalida;

          aAlfa = #vipe0005#16;
          aAlfa = "          " + aAlfa;
          aAlfa = aAlfa % -110;
          #nomvarli#5 = aAlfa;          || unidades
          aAlfa = #vipe0005#18;
          aAlfa = "          " + aAlfa;
          aAlfa = aAlfa % -112;
          #nomvarli#6 = aAlfa;          || unidades

          |SI FEstado = 0;
               |GRABA 020#nomvarli.a;
          |SINO;
               |GRABA 020#nomvarli.n;
          |FINSI;

          |LIBERA #nomvarli;
     |FINSI;

     |SI #vipe0005#24 = 0;         || VACACIONES
          #nomvarli#0 = #vipe0005#0;         || empresa
          #nomvarli#1 = #vipe0005#1;         || trabajador
          #nomvarli#2 = #vipe0005#4;         || mes
          #nomvarli#3 = 0;                   || tipo
          #nomvarli#4 = #vipe0005#25;        || concepto
          |LEE 101#nomvarli.=;
          |SI FSalida = 0;
               |BORRA 020#nomvarli.a;
               |LIBERA #nomvarli;
          |FINSI;
     |SINO;
          #nomvarli#0 = #vipe0005#0;         || empresa
          #nomvarli#1 = #vipe0005#1;         || trabajador
          #nomvarli#2 = #vipe0005#4;         || mes
          #nomvarli#3 = 0;                   || tipo
          #nomvarli#4 = #vipe0005#25;        || concepto
          |LEE 101#nomvarli.=;
          FEstado = FSalida;

          aAlfa = #vipe0005#24;
          aAlfa = "          " + aAlfa;
          aAlfa = aAlfa % -110;
          #nomvarli#5 = aAlfa;          || unidades
          aAlfa = #vipe0005#26;
          aAlfa = "          " + aAlfa;
          aAlfa = aAlfa % -112;
          #nomvarli#6 = aAlfa;          || importe

          |SI FEstado = 0;
               |GRABA 020#nomvarli.a;
          |SINO;
               |GRABA 020#nomvarli.n;
          |FINSI;
          |LIBERA #nomvarli;
     |FINSI;

     |CIERRA #nomvarli;
     |CIERRA #nomvarca;
|FPRC;

|PROCESO EsteMes;
     nHorasIntr = 0;
     nVacacIntr = 0;

     #vipe0007#0 = #vipe0005#0;         || empresa
     #vipe0007#1 = #vipe0005#1;         || trabajador
     #vipe0007#3 = #vipe0005#3;         || mes
     #vipe0007#4 = #vipe0005#4;         || a¤o
     |LEE 101#vipe0007.=;
     |SI FSalida = 0;
          nHorasIntr = #vipe0007#16;    || horas ya introducidas
          nVacacIntr = #vipe0007#29;    || vacaciones ya introducidas
     |FINSI;
|FPRC;

|PROCESO MesAnterior;
     |SI #vipe0007#0 = #labtraba#0;     || SOLO SI ESTA EN LA MISMA EMPRESA
          nHorasPend = nHorasPend + #vipe0007#18;
          nVacacPend = nVacacPend + #vipe0007#23;
          nVacacPendAnt = nVacacPendAnt + #vipe0007#27;
     |FINSI;
|FPRC;

|DEFBUCLE MesAnterior;
     #vipe0007#1;
     24;
     00001, 00001, nAny, nMes, aNif;
     99999, 99999, nAny, nMes, aNif;
     ;
     NULL, MesAnterior;
|FIN;

|PROCESO EsteMesBucle;
     || SOLO SI ESTA EN LA MISMA EMPRESA Y ES OTRO TRABAJADOR
     |SI #vipe0007#0 = #vipe0005#0; |Y #vipe0007#1 ! #vipe0005#1;
     |Y #vipe0007#14 ! 0;
          swHaEntrado = 1;
     |FINSI;

     || esto querra decir que de alguna manera en algun otro calculo
     || tengo a un trabajador con este NIF que ya he calculado, con lo cual
     || ya tengo las horas del mes anterior, y estas han de pasar solo
     || una vez, con este swHaEntrado consigo eso, que no ente a buscarlas
     || una segunda vez
|FPRC;

|DEFBUCLE EsteMes;
     #vipe0007#1;
     24;
     00001, 00001, nAny, nMes, aNif;
     99999, 99999, nAny, nMes, aNif;
     ;
     NULL, EsteMesBucle;
|FIN;

|PROCESO Rellena;
     swMYAP = 0;
     |PARA nMes = 1; |SI nMes [ 12; |HACIENDO nMes = nMes + 1;
          #vipe0007#0 = #vipe0005#0;         || empresa
          #vipe0007#1 = #vipe0005#1;         || trabajador
          #vipe0007#3 = #vipe0005#3;         || a¤o
          #vipe0007#4 = nMes;         || mes
          |LEE 000#vipe0007.=;
          |SI FSalida ! 0;
               |DDEFECTO #vipe0007;
               #vipe0007#0 = #vipe0005#0;         || empresa
               #vipe0007#1 = #vipe0005#1;         || trabajador
               #vipe0007#2 = #vipe0005#2;         || nombre trabajador
               #vipe0007#3 = #vipe0005#3;         || a¤o
               #vipe0007#4 = nMes;                || mes
               #vipe0007#24 = #vipe0005#20;       || NIF
               |GRABA 020#vipe0007.n;
               |LIBERA #vipe0007;
          |SINO;
               |SI nMes > #0#5; |Y #vipe0007#25 = "*";
                    swMYAP = 1;
               |FINSI;
          |FINSI;
     |SIGUE;
     #vipe0007#4 = 99;         || linea totales
     |LEE 000#vipe0007.=;
     |SI FSalida ! 0;
          #vipe0007#0 = #vipe0005#0;         || empresa
          #vipe0007#1 = #vipe0005#1;         || trabajador
          #vipe0007#2 = #vipe0005#2;         || nombre trabajador
          #vipe0007#3 = #vipe0005#3;         || a¤o
          #vipe0007#4 = 99;                  || totales
          #vipe0007#24 = #vipe0005#20;       || NIF
          |GRABA 020#vipe0007.n;
          |LIBERA #vipe0007;
     |FINSI;
|FPRC;

|PROCESO Calendario;
     |ABRE #nomfical;
     nAny = #vipe0005#3;
     nMes = #vipe0005#4;
     aAny = #vipe0005#3;

     #nomfical#0 = #vipe0005#21;
     #nomfical#1 = aAny;
     |LEE 000#nomfical.=;

     nVacacCal = 0;

     |PARA campo = 9; |SI campo [ 96; |HACIENDO campo = campo + 3;
          |SI #nomfical#campo# ! "    ";
               desde = campo;
               hasta = campo + 1;
               pesos = campo + 2;

               alfa1 = #nomfical#desde# % 102;    || separa el desde
               alfa2 = #nomfical#desde# % 302;
               diades = alfa1;
               mesdes = alfa2;

               alfa1 = #nomfical#hasta# % 102;    || separa el hasta
               alfa2 = #nomfical#hasta# % 302;
               diahas = alfa1;
               meshas = alfa2;

               peso = #nomfical#pesos#;

               |SI mesdes = nMes; |Y meshas = nMes;
                    |SI peso = 1;
                         nVacacCal = nVacacCal + (diahas - diades + 1);
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;

     |PARA campo = 99; |SI campo [ 157; |HACIENDO campo = campo + 2;
          |SI #nomfical#campo# ! "    ";
               pesos = campo + 1;

               alfa1 = #nomfical#campo# % 102;    || separa el dia fijo
               alfa2 = #nomfical#campo# % 302;
               diafij = alfa1;
               mesfij = alfa2;
               mesnum = mesfij;
               peso = #nomfical#pesos#;

               |SI mesnum = nMes;
                    |SI peso = 1;
                         nVacacCal = nVacacCal + 1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;

     |CIERRA #nomfical;
|FPRC;

|PROCESO imprime;
     |PRINT;
|FPRC;

|DEFBUCLE vipe0008;
     #vipe0008#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, imprime;
|FIN;

|PROCESO Informe;
     Impresora = "CrystalReport";
     |IMPRE -1
     |INFOR "vipe0008";
     |BUCLE vipe0008;
     |PIEINF;
     |FININF;
     |FINIMP;
|FPRC;

|PROCESO Comprobaciones;
     || para presentar luego el informe

     || primero creo registro para el trabajador e incializo
     |ABRE #labempre;
     |ABRE #labcentr;
     |ABRE #nomvarca;
     |ABRE #nomvarli;
     |ABRE #nomcalca;
     |ABRE #nomhicca;

     swAcu = 0;
     swVar = 0;
     swMen = 0;
     swHis = 0;

     |DDEFECTO #vipe0008;
     #vipe0008#0 = #vipe0007#0;         || empresa
     #vipe0008#1 = #vipe0007#1;         || trabajador
     #vipe0008#2 = #vipe0007#26;        || centro
     #vipe0008#3 = #vipe0007#3;         || a¤o
     #vipe0008#4 = #vipe0007#4;         || mes

     #labempre#0 = #vipe0008#0;
     |LEE 000#labempre.=;
     #vipe0008#5  = #labempre#2;

     #vipe0008#6  = #vipe0005#2;

     #labcentr#0 = #vipe0008#0;
     #labcentr#1 = #vipe0008#2;
     |LEE 000#labcentr.=;
     #vipe0008#7  = #labcentr#2;

     nNume = #vipe0007#3;
     nNume = nNume - 2000;
     #nomhicca#0 = #vipe0007#0;         || empresa
     #nomhicca#1 = #vipe0007#1;         || trabajador
     #nomhicca#2 = #vipe0007#4;         || mes
     #nomhicca#3 = 0;                   || tipo
     #nomhicca#66 = nNume;              || a¤o
     |LEE 000#nomhicca.=;
     |SI FSalida = 0;
          #vipe0008#14 = 1;
          #vipe0008#15 = "Nomina ya calculada y actualizada en Historico. Imposible Actualizar";
          swHis = 1;
     |FINSI;

     |SI swHis = 0;
          |SI swMYAP = 1;     || algun Mes Ya Actualizado Posterior
               #vipe0008#12 = 1;
               #vipe0008#13 = "Existen nominas ya calculadas en meses posteriores. Imposible Actulizar.";
          |FINSI;
     |FINSI;

     |SI swHis = 0; |Y swMYAP = 0;     || algun Mes Ya Actualizado Posterior
          |SI #vipe0007#25 = "*";
               #vipe0008#10 = 2;          || ya se habia creado en mto.acum: la actualizo
               #vipe0008#11 = "Actualizado";
          |SINO;
               #vipe0008#10 = 1;          || la creo
               #vipe0008#11 = "Creado";
          |FINSI;

          |SI #vipe0005#16 ! 0; |O #vipe0005#24 ! 0;    || si no tengo horas no hago nada
               #nomvarca#0 = #vipe0005#0;         || empresa
               #nomvarca#1 = #vipe0005#1;         || trabajador
               #nomvarca#2 = #vipe0005#4;         || mes
               #nomvarca#3 = 0;                   || tipo
               |LEE 000#nomvarca.=;
               |SI FSalida = 0;
                    #vipe0008#8 = 2;          || ya se habia creado en variaciones
                    #vipe0008#9 = "Actualizado";
                    swVar = 2;
               |SINO;
                    #vipe0008#8 = 1;          || nueva linea
                    #vipe0008#9 = "Creado";
                    swVar = 1;
               |FINSI;
          |FINSI;

          #nomcalca#0 = #vipe0007#0;         || empresa
          #nomcalca#1 = #vipe0007#1;         || trabajador
          #nomcalca#2 = #vipe0007#4;         || mes
          #nomcalca#3 = 0;                   || tipo
          |LEE 000#nomcalca.=;
          |SI FSalida = 0;
               #vipe0008#12 = 1;
               swMen = 1;
               #vipe0008#13 = "Nomina ya calculada en Mto. Mensual. Necesita recalcular nomina.";
          |FINSI;
     |FINSI;

     |GRABA 020#vipe0008.n;
     |LIBERA #vipe0008;

     |CIERRA #nomhicca;
     |CIERRA #nomcalca;
     |CIERRA #nomvarli;
     |CIERRA #nomvarca;
     |CIERRA #labcentr;
     |CIERRA #labempre;
|FPRC;

|PROCESO Actualiza;
     |HAZ Rellena;

     nHorasPend = 0;
     nVacacPend = 0;
     nVacacPendAnt = 0;
     aNif = #vipe0005#20;

     |SI #vipe0005#0 ! nEmpAnt; |O #vipe0005#1 ! nTraAnt;
     || un codigo de trabajador distinto trabajador distinto
          |SI #vipe0005#20 ! aNIFAnt;
          || solo si tiene distinto NIF he de mirar meses anteriores,
          || si no me salen dos veces despues las cantidades
               swHaEntrado = 0;
               nMes = #vipe0005#4;                || mes
               nAny = #vipe0005#3;           || a¤o

               |BUCLE EsteMes;

               nMes = #vipe0005#4;                || mes
               nMes = nMes - 1;
               |SI nMes = 0;
                    nMes = 12;
                    nAny = #vipe0005#3 - 1;       || a¤o
               |SINO;
                    nAny = #vipe0005#3;           || a¤o
               |FINSI;
               |SI swHaEntrado = 0;
                    |BUCLE MesAnterior;
               |FINSI;
          |FINSI;
     |FINSI;

     |DDEFECTO #vipe0007;
     #vipe0007#0 = #vipe0005#0;         || empresa
     #vipe0007#1 = #vipe0005#1;         || trabajador
     #vipe0007#3 = #vipe0005#3;         || a¤o
     #vipe0007#4 = #vipe0005#4;         || mes
     |LEE 101#vipe0007.=;
     FEstado = FSalida;
|| xxxxxxxxx
     |HAZ Comprobaciones;

     |SI swHis = 0; |Y swMYAP = 0; || si hay algo en el historico ni de co¤a
                                   || tampoco si hay meses posteriores actualizados
          #vipe0007#2 = #vipe0005#2;
          #vipe0007#5 = #vipe0005#5;
          #vipe0007#6 = #vipe0005#6;
          #vipe0007#7 = #vipe0005#7;
          #vipe0007#8 = #vipe0005#8;
          #vipe0007#9 = #vipe0005#9;
          #vipe0007#10 = #vipe0005#10;  || dias vacaciones
          #vipe0007#11 = #vipe0005#11;
          #vipe0007#12 = #vipe0005#12;
          #vipe0007#13 = #vipe0005#13;  || diferencia (horas a pagar)

          #vipe0007#14 = nHorasPend;    || horas pendientes meses anteriores
          #vipe0007#15 = 0;             || reservado para regularizacion
          #vipe0007#16 = #vipe0005#16;

          || (diferencia normales - horas contrato) - a pagar - regularizacion
          #vipe0007#17 = #vipe0007#13 - #vipe0007#16 - #vipe0007#15;

          || las que tenia pendientes + las que genero este mes
          #vipe0007#18 = #vipe0007#14 + #vipe0007#17;
          #vipe0007#19 = nVacacPend;
          |HAZ Calendario;
          #vipe0007#20 = (#vipe0007#5 / 30) * 2.5;     || dias generados mes
          #vipe0007#20 = #vipe0007#20 + nVacacCal;
          #vipe0007#21 = #vipe0005#10;   || dias vacaciones

          || vacaciones pendientes generadas este mes
          #vipe0007#22 = #vipe0007#20 - #vipe0007#21;

          || si estoy en enero no hay que recoger lo del mes anterior pendiente
          || porque me vendran acumuladas en las del a¤o anterior
          |SI #vipe0005#4 = 1;     || si estoy en enero no hay que recoger
                #vipe0007#23 = #vipe0007#22;      || MES ANTERIOR
          |SINO;
          || si no, s¡ que habr  que recogerlas
          || las vacaciones que tenia pendientes + las que genero este mes
                #vipe0007#23 = #vipe0007#19 + #vipe0007#22;
          |FINSI;

          #vipe0007#24 = #vipe0005#20;  || nif
          #vipe0007#25 = "*";
          #vipe0007#26 = #vipe0005#22;  || centro

          nVacAnyAnt = 0;
          |SI #vipe0005#4 = 1;     || si estoy en enero
               |SALVA_FICHA #vipe0007;
               #vipe0007#0 = #vipe0005#0;         || empresa
               #vipe0007#1 = #vipe0005#1;         || trabajador
               #vipe0007#3 = #vipe0005#3 - 1;     || a¤o
               #vipe0007#4 = 12;                  || mes
               |LEE 101#vipe0007.=;
               |SI FSalida = 0;
                    nVacAnyAnt = #vipe0007#28;
               |FINSI;
               |REPON_FICHA #vipe0007;
          |SINO;
               nVacAnyAnt = #vipe0005#31;
          |FINSI;

          |SI nVacAnyAnt ! 0;
               #vipe0007#27 = nVacacPendAnt;
               || #vipe0007#27 = nVacAnyAnt;
          |FINSI;

          |SI #vipe0007#23 < 0;    || si he consumido mas vacaciones
                                   || que las generadas de este a¤o
               #vipe0007#27 = #vipe0007#27 + #vipe0007#23;  || las resto de las
               #vipe0007#23 = 0;
                                   || pendientes del a¤o anterior
               |SI #vipe0007#27 < 0; || si aun asi no tengo bastante,
                    #vipe0007#23 = #vipe0007#27;  || le debo vacaciones a la empresa
                    #vipe0007#27 = 0;             || que acumulo aqui
               |FINSI;
          |FINSI;

          #vipe0007#29 = #vipe0005#24;
          #vipe0007#28 = #vipe0007#23 + #vipe0007#27 - #vipe0005#24;

          |GRABA 020#vipe0007.a;
          |LIBERA #vipe0007;

          nNume = #vipe0005#16 + #vipe0005#9 + #vipe0005#10 + #vipe0005#11 + #vipe0005#24;
          |SI nNume ! 0;         || si no tengo horas no hago nada
               |HAZ Variaciones;
          |FINSI;

          nEmpAnt = #vipe0005#0;
          nTraAnt = #vipe0005#1;
          aNIFAnt = #vipe0005#20;
     |FINSI;
|FPRC;

|DEFBUCLE Actualiza;
     #vipe0005#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Actualiza;
|FIN;

|PROCESO PulsaBoton1;
     alfa1 = Usuario; |QBT alfa1;    alfa1 = ("i" + alfa1) % 108;
     |NOME_DAT #8 alfa1;
     |DELINDEX #8;

     |ABRE #labtraba;
     |ABRE #vipe0007;
     |ABRE #vipe0008;

     |BUCLE Actualiza;
     |HAZ Informe;

     |CIERRA #vipe0008;
     |CIERRA #vipe0007;
     |CIERRA #labtraba;
|FPRC;

/*
|PROCESO FinMenu;
     |PULSATECLA;
     |FIN_CONTROL_WINDOWS nBoton1;
     |PULSATECLA;
     |FIN_CONTROL_WINDOWS nBoton2;
     |PULSATECLA;
     |FIN_CONTROL_WINDOWS nBoton3;
     |PULSATECLA;
     ||FIN_CONTROL_WINDOWS nBoton4;
     ||PULSATECLA;
|FPRC;

|PROCESO ElMenu;
     || nBoton1 - Aceptar
     || nBoton2 - Revisar
     || nBoton3 - Cancelar
     || nBoton4 - Imprimir

     |CLS;

     |ATRI R;   || 23456789012345678
     |PINTA 0632, "  Menu de  opciones  ";
     |ATRI 0;
     |CUADRO 0705 1975;

     |CONTROL_SIMPLE 0, "BOTON,Actualizar", 0807, 0817, PulsaBoton1;
     nBoton1 = FSalida;
     |ESTADO_CONTROL nBoton1, "SHOW"; ||"SHOW""HIDE""ENABLE""DISABLE".
     |ESTADO_CONTROL nBoton1, "ENABLE"; ||"SHOW""HIDE""ENABLE""DISABLE".

     |CONTROL_SIMPLE 0, "BOTON,Revisar", 2750, 2760, PulsaBoton2;
     nBoton2 = FSalida;
     |ESTADO_CONTROL nBoton2, "SHOW"; ||"SHOW""HIDE""ENABLE""DISABLE".
     |ESTADO_CONTROL nBoton2, "ENABLE"; ||"SHOW""HIDE""ENABLE""DISABLE".

     |CONTROL_SIMPLE 0, "BOTON,Terminar", 1407, 1417, PulsaBoton3;
     nBoton3 = FSalida;
     |ESTADO_CONTROL nBoton3, "SHOW"; ||"SHOW""HIDE""ENABLE""DISABLE".
     |ESTADO_CONTROL nBoton3, "ENABLE"; ||"SHOW""HIDE""ENABLE""DISABLE".

     ||CONTROL_SIMPLE 0, "BOTON,Imprimir", 1707, 1717, PulsaBoton4;
     ||nBoton4 = FSalida;
     ||ESTADO_CONTROL nBoton4, "SHOW"; ||"SHOW""HIDE""ENABLE""DISABLE".
     ||ESTADO_CONTROL nBoton4, "ENABLE"; ||"SHOW""HIDE""ENABLE""DISABLE".

               ||  12         3         4         5         6         7
               ||  9012345678901234567890123456789012345678901234567890123
     |PINTA 0819, "Actualiza las horas introducidas en el Mantenimiento de";
     |PINTA 0919, "acumulados de horas";
     |PINTA 1119, "Vuelve al lineal para revisar las horas introducidas";
     |PINTA 1219, "";
     |PINTA 1419, "Sale del lineal sin efectuar ningun cambio. Ninguno de";
     |PINTA 1519, "los cambios introducidos tendran efecto";
     ||PINTA 1719, "Impresion de los cambios introducidos";
     ||PINTA 1819, "";

     |ATRI I;
     |PINTA 2010, "             - Seleccione en la opcion deseada  -";
     |ATRI 0;
|FPRC;
*/

|PROCESO FinMenu;
     |PULSATECLA;
     |FIN_CONTROL_WINDOWS nBoton1;
     |PULSATECLA;
     |FIN_CONTROL_WINDOWS nBoton2;
     |PULSATECLA;
     |FIN_CONTROL_WINDOWS nBoton3;
     |PULSATECLA;
     ||FIN_CONTROL_WINDOWS nBoton4;
     ||PULSATECLA;
|FPRC;

|PROCESO ElMenu;
     || nBoton1 - Actualizar
     || nBoton2 - Cancelar
     || nBoton3 - Imprimir

     |CONTROL_SIMPLE 0, "BOTON,Actualizar", 2830, 2845, PulsaBoton1;
     nBoton1 = FSalida;
     |ESTADO_CONTROL nBoton1, "SHOW"; ||"SHOW""HIDE""ENABLE""DISABLE".
     |ESTADO_CONTROL nBoton1, "ENABLE"; ||"SHOW""HIDE""ENABLE""DISABLE".

     |CONTROL_SIMPLE 0, "BOTON,Salir", 2865, 2870, PulsaBoton2;
     nBoton2 = FSalida;
     |ESTADO_CONTROL nBoton2, "SHOW"; ||"SHOW""HIDE""ENABLE""DISABLE".
     |ESTADO_CONTROL nBoton2, "ENABLE"; ||"SHOW""HIDE""ENABLE""DISABLE".

     |CONTROL_SIMPLE 0, "BOTON,Imprimir", 2848, 2862, PulsaBoton3;
     nBoton3 = FSalida;
     |ESTADO_CONTROL nBoton3, "SHOW"; ||"SHOW""HIDE""ENABLE""DISABLE".
     |ESTADO_CONTROL nBoton3, "ENABLE"; ||"SHOW""HIDE""ENABLE""DISABLE".

/*
               ||  12         3         4         5         6         7
               ||  9012345678901234567890123456789012345678901234567890123
     |PINTA 0819, "Actualiza las horas introducidas en el Mantenimiento de";
     |PINTA 0919, "acumulados de horas";
     |PINTA 1119, "Vuelve al lineal para revisar las horas introducidas";
     |PINTA 1219, "";
     |PINTA 1419, "Sale del lineal sin efectuar ningun cambio. Ninguno de";
     |PINTA 1519, "los cambios introducidos tendran efecto";
     ||PINTA 1719, "Impresion de los cambios introducidos";
     ||PINTA 1819, "";
*/
|FPRC;

|PROCESO BuscaConcepto;
     nImporte = 0;

     |ABRE #nomcatli;
     #nomcatli#0 = #labtraba#87;
     #nomcatli#1 = #labtraba#17;
     #nomcatli#2 = nConcepto;
     |LEE 000#nomcatli.=;
     |SI FSalida = 0;
          nImporte = #nomcatli#4;
     |FINSI;
     |CIERRA #nomcatli;

     |ABRE #nomtrali;
     #nomtrali#0 = #labtraba#0;
     #nomtrali#1 = #labtraba#1;
     #nomtrali#2 = nConcepto;
     |LEE 000#nomtrali.=;
     |SI FSalida = 0;
          nImporte = #nomtrali#4;
     |FINSI;
     |CIERRA #nomtrali;

     |ABRE #nomvarli;
     #nomvarli#0 = #labtraba#0;
     #nomvarli#1 = #labtraba#1;
     #nomvarli#2 = #0#5;
     #nomvarli#3 = 0;
     #nomvarli#4 = nConcepto;
     |LEE 000#nomvarli.=;
     |SI FSalida = 0;
          nImporte = #nomvarli#6;
     |FINSI;
     |CIERRA #nomvarli;
|FPRC;

/*
|PROCESO constante;
     alfa1 = "01";
     alfa2 = #vipe0004#5;  alfa2 = "00" + alfa2;    alfa2 = alfa2 % -102;
     alfa3 = #vipe0004#4;
     alfa4 = alfa1 + "." + alfa2 + "." + alfa3;

     fCFecha = alfa4;         || primer dia de mes de calculo
     aCError = "";            || inicializo errores
     |HAZ LeeCons;
|FPRC;

|PROCESO CompruebaIPREM;
     |ABRE #labtraba;
     #labtraba#0 = #vipe0005#0;
     #labtraba#1 = #vipe0005#1;
     |LEE 000#labtraba.=;

     nCConst = #labtraba#248;
     |HAZ constante;
     nLimite = #nomconst#76;
     nLimite = nLimite % 20;

     |SI #vipe0005#19 > nLimite;
          alfa1 = #vipe0005#19;
          alfa2 = nLimite;
          aAlfa = "    ATENCION: El total del exceso de horas (" + alfa1;
          aAlfa = aAlfa + " euros) es superior al maximo no cotizable (" + alfa2;
          aAlfa = aAlfa + " euros)."
          |MENAV aAlfa;
     |FINSI;

     |CIERRA #labtraba;
|FPRC;

|PROCESO Concepto;
     |SI #vipe0005#16 ] 0;
          #vipe0005#17 = #vipe1002#1;        || concepto (del control)
     |SINO;
          #vipe0005#17 = #vipe1002#2;        || concepto (del control)
     |FINSI;
     |PINTA #vipe0005#17;
|FPRC;

|PROCESO Total;
     |SI #vipe0005#16 ] 0;
          #vipe0005#19 = #vipe0005#16 * #vipe0005#18;
     |SINO;
          #vipe0005#19 = #vipe0005#16 * #vipe0005#18 * -1;
     |FINSI;
     |PINTA #vipe0005#19;
|FPRC;

|PROCESO TotalV;
     #vipe0005#29 = #vipe0005#24 * #vipe0005#26;
     |PINTA #vipe0005#29;
|FPRC;

|PROCESO Vacaciones; |TIPO 0;
     |SI #vipe0005#24 ! 0;
          |SI #vipe0005#23 ! "*";
               |MENAV "    ATENCION: El trabajador no es baja este mes.";
          |FINSI;
          #labtraba#0 = #vipe0005#0;
          #labtraba#1 = #vipe0005#1;
          |LEE 000#labtraba.=;
          |SI FSalida = 0;
               |SI #labtraba#48 ! "S";
                    |MENAV "    ATENCION: El trabajador tiene informado en su ficha Finiquito 'No'";
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;
*/
|PROCESO superior;
     #vipe0005#23 = " ";
     #vipe0005#0 = 99999;
     #vipe0005#1 = 99999;
|FPRC;

|PROCESO inferior;
     #vipe0005#23 = "*";
     #vipe0005#0 = 00001;
     #vipe0005#1 = 00001;
|FPRC;

|PROCESO Evento;
     nSalida = FSalida;
/*
          InNivel = nNivel1<-;
          nNivel1 = 0;
          |ESPECIFICA "IDBOTONTECLA", nNivel;
          nIdSalir = nNivel2;
          |ESTADO_CONTROL nIdSalir, "HIDE";
*/

     |SI nSalida = 4;
          |HAZ DobleClick;
     |FINSI;
|FPRC;

|PROCESO Tipo2; |TIPO 2;
     nFlag = 0 +. 1;
     |SI nFlag ] 0;
          ||PTEC 811;
          ||PULSATECLA;
          ||REFRESCACONTROL nGridFichero;
     |FINSI;
|FPRC;

|PROCESO CreaLineal;
     |PARA; |SI; |HACIENDO;
          nModo = 2 + 4 + 8 + 16 + 32;
          nPos1 = 0803;
          nPos2 = 2497;

          |ABRE #5;
          |LINEAL_SIMPLE #3#vipe0005, nModo, nPos1, nPos2, inferior, superior, Evento;
          enGrid = FSalida;

          aEsc1  = &255 + "806";
          aEsc2  = &255 + "807";
          aRetu  = &255 + "802";
          |PARA; |SI; |HACIENDO;
               FSalida = "::{{001}}Datos," + enGrid;


               |LEETECLA aTecla;
               |SI aTecla = aEsc1; |SAL; |FINSI;
               |SI aTecla = aEsc2; |SAL; |FINSI;
               |SI aTecla = aRetu;
                    FSalida = 4;
                    |HAZ DobleClick;
               |FINSI;
          |SIGUE;

          |SI aTecla = aEsc1; |O aTecla = aEsc2;
               |CONFI "     Todos los cambios no actualizados se perderan. Seguro que desea salir del lineal?";
               |SI FSalida = 0;
                    |SAL;
                    |HAZ FinMenu;
               |FINSI;
          |FINSI;
          |CIERRA #5;
          |DESTRUYECONTROL enGrid;
     |SIGUE;
     nGridFichero = FSalida;

/*
     |PARA; |SI; |HACIENDO;
          nModo = 2 + 4 + 8 + 16;
          nPos1 = 0803;
          nPos2 = 2497;
          |ABRE #5;
          |LINEAL_SIMPLE #3#vipe0005, nModo, nPos1, nPos2, inferior, superior, Evento;
          enGrid = FSalida;
          |SI FSalida = -1;
               |CONFI "     Todos los cambios no actualizados se perderan. Seguro que desea salir del lineal?";
               |SI FSalida = 0;
                    |SAL;
                    |HAZ FinMenu;
               |FINSI;
          |FINSI;
          |CIERRA #5;
     |SIGUE;
     nGridFichero = FSalida;
*/
|FPRC;

|PROCESO DestruyeLineal;
     |CIERRAT #5;
     |DESTRUYECONTROL nGridFichero;
     nGridFichero = -1;
|FPRC;

|PROCESO Presenta;
     |ABRET #vipe0005;
     ||PARA; |SI; |HACIENDO;
          ||CONSULTA_CLAVE #3#vipe0005;
          ||PINPA #0#0;
          |HAZ ElMenu;
          |PULSATECLA;

          |HAZ CreaLineal;

          nSalir   = 0;
/*
          aEsc1  = &255 + "806";
          aEsc2  = &255 + "807";
          aRetu  = &255 + "802";
          |PARA; |SI;  |HACIENDO;
               FSalida = "::Salir," + nGridFichero;
               |LEETECLA aTecla;
               |SI aTecla = aEsc1; |SAL;  |FINSI;
               |SI aTecla = aEsc2; |SAL;  |FINSI;
               |SI aTecla = aRetu; |SAL;  |FINSI;

          |SIGUE;

          |HAZ DestruyeLineal;
*/

/*
          |SI FSalida ! 0;
               swMenu = 0;
               |HAZ ElMenu;
               |PARA; |SI swMenu = 0; |HACIENDO;
                    |PULSATECLA;
               |SIGUE;
               |SI nOpcion = 2;
                    |HAZ FinMenu;
               |FINSI;
               |SI nOpcion = 3;
                    |HAZ FinMenu;
                    |CIERRA #vipe0005;
                    |ACABA;
               |FINSI;
          |FINSI;
          |SI nOpcion ! 2;
               |LEE 101#vipe0005.=;
               |PINPA #0#5;
               |PINDA #0#5;
               |ENDATOS #2#5;
               |SI FSalida = 0;
                    |HAZ CompruebaIPREM;
                    |GRABA 020#vipe0005.a;
                    |LIBERA #vipe0005;
               |FINSI;
          |FINSI;
          nOpcion = 0;
     ||SIGUE;
     */
     ||CIERRA #vipe0005;
|FPRC;

|PROCESO Redondea25;
     nEntero = 0;
     nDeci = 0;

     nEntero = (nNume - 0.49) ! 0;        || horas sin decimales
     nDeci = nNume - nEntero;
     |SI nDeci < 0; nDeci = 0; |FINSI;
     |SI nDeci > 0; |Y nDeci [ 0.125; nDeci = 0; |FINSI;
     |SI nDeci > 0.125; |Y nDeci [ 0.375; nDeci = 0.25; |FINSI;
     |SI nDeci > 0.375; |Y nDeci [ 0.625; nDeci = 0.50; |FINSI;
     |SI nDeci > 0.625; |Y nDeci [ 0.875; nDeci = 0.75; |FINSI;
     |SI nDeci > 0.875; nDeci = 1; |FINSI;
|FPRC;

|PROCESO Ajuste1;
     #labtraba#0 = #vipe0005#0;
     #labtraba#1 = #vipe0005#1;
     |LEE 000#labtraba.=;

     nNume = #vipe0005#7;
     |HAZ Redondea25;
     #vipe0005#7 = nEntero + nDeci;

     |SI topemes = 31; |O topemes = 28;      || mes que no es de 30 dias
          |SI #labtraba#42 = "X";            || trabajador mensual
               |SI #vipe0005#5 = 30;         || de alta el mes completo
                    ||SI #vipe0005#9 > 0;|| tengo enf, acc o mat
                    |SI #vipe0005#9 = topemes;|| tengo enf, acc o mat TODO EL PERIODO
                         |SI topemes = 31;   || ene, mar, may, jul, ago, oct, dic
                              #vipe0005#12 = #vipe0005#12 - #labtraba#47;
                         |SINO;              || feb
                              #vipe0005#12 = #vipe0005#12 + (2 * #labtraba#47);
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     || esto porque si he estado todo el mes entero de IT y he usado el
     || Redondea25 en las horas, tambien tendre que usarlo aqui para no
     || provocar descuadres

/*
     || atencion, redondeamos SIEMPRE, no solo en este caso

     |SI #labtraba#42 = "X";            || trabajador mensual
          |SI #vipe0005#5 = 30;              || de alta el mes completo
               |SI #vipe0005#9 = topemes;    || tengo IT todo el mes
                    nNume = #vipe0005#12;
                    |HAZ Redondea25;
                    #vipe0005#12 = nEntero + nDeci;
               |FINSI;
          |FINSI;
     |FINSI;
*/

     nNume = #vipe0005#12;
     |HAZ Redondea25;
     #vipe0005#12 = nEntero + nDeci;

     || diferencia partes-contrato
     #vipe0005#13 = #vipe0005#12 - #vipe0005#7;

     #vipe0005#15 = #vipe0005#13 + #vipe0005#14;  || total diferencia

     |GRABA 020#vipe0005.a;
     |LIBERA #vipe0005;
|FPRC;

|DEFBUCLE Ajuste1;
     #vipe0005#1;
     ;
     INICIO;
     FINAL;
     be;
     NULL, Ajuste1;
|FIN;

|PROCESO DiasTotal;
     nDiasTot = nDias;
     |SI fFechaAlta > fFechaDesde;
          |SI #vipe0005#0 ! #labtraba#0; |O #vipe0005#1 ! #labtraba#1;
               nDiasTot = nDiasTot + #vipe0005#5;
               || quitado porque estaba acumulando dias sin sentido
               || en caso de alta-baja el mismo mes durante mas de 15 dias
               || haz la prueba si no te lo crees
               |SI #labtraba#42 = "X"; |O #labtraba#42 = "M";
                    |SI nDiasTot > 30; |Y topemes = 31;
                         nDias = nDias - 1;
                    |FINSI;
               |FINSI;

               fFecha1 = #vipe0005#28;
               fFecha1 = fFecha1 + 1;

               fFecha2 = fFechaAlta;
               |SI nNume1 = nNume2;     || continua en alta, no lo considero finiq.
                    #vipe0005#23 = " ";
                    |GRABA 020#vipe0005.a;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE DiasTotal;
     #vipe0005#2;
     ;
     #labtraba#7;
     #labtraba#7;
     be;
     NULL, DiasTotal;
|FIN;

|PROCESO cargatmp;
     swVacaciones = " ";

     #labtraba#0 = #vipe0002#0;
     #labtraba#1 = #vipe0002#1;
     |LEE 000#labtraba.=;

     #vipe1001#0 = #vipe0002#7;
     |LEE 000#vipe1001.=;

     |DDEFECTO #vipe0005;
     #vipe0005#0 = #vipe0002#0;         || empresa
     #vipe0005#1 = #vipe0002#1;         || trabajador
     |LEE 101#vipe0005.=;
     FEstado = FSalida;

     #vipe0005#2 = #labtraba#2;         || nombre trabajador
     #vipe0005#3 = #0#4;                || a¤o
     #vipe0005#4 = #0#5;                || mes

     aAlfa = #labtraba#36;
     fFecha = aAlfa;
     #vipe0005#27 = fFecha;

     aAlfa = #labtraba#37;
     fFecha = aAlfa;
     #vipe0005#28 = fFecha;

     aAlfa = #labtraba#36;
     fFechaAlta = aAlfa;
     aAlfa = #labtraba#37;
     |QBF aAlfa;
     |SI aAlfa ! "";
          fFechaBaja = aAlfa;
          |SI fFechaBaja = fFechaHasta;
               swVacaciones = "*";
          |FINSI;
     |SINO;
          fFechaBaja = fFechaHasta;
     |FINSI;
     fFechaAltaMes = fFechaDesde;
     fFechaBajaMes = fFechaHasta;
     |SI fFechaAlta [ fFechaDesde; |Y fFechaBaja ] fFechaHasta;
          |SI #labtraba#42 = "D";
               nDias = topemes;
          |SINO;
               nDias = 30;
          |FINSI;
     |SINO;
          |SI fFechaAlta > fFechaDesde;
               fFechaAltaMes = fFechaAlta;
          |FINSI;
          fFecha = #labtraba#37;
          |SI fFechaBaja < fFechaHasta;
               swVacaciones = "*";
               fFechaBajaMes = fFechaBaja;
          |FINSI;
          nFechaAltaMes = fFechaAltaMes;
          nFechaBajaMes = fFechaBajaMes;
          nDias = nFechaBajaMes - nFechaAltaMes + 1;
     |FINSI;

     |SALVA_FICHA #vipe0005;
     |BUCLE DiasTotal;
     |REPON_FICHA #vipe0005;

     #vipe0005#5 = nDias;                    || dias trabajados

     |SI #labtraba#42 = "X";       || si son tp
          #vipe0005#6 = #labtraba#234;            || horas contrato
     |SINO;
          #vipe0005#6 = 40;                       || horas jornada completa
     |FINSI;
     |SI #labtraba#42 = "X";       || si son tp
          #vipe0005#7 = nDias * #labtraba#47;     || dias por horas TC2
     |SINO;
          #vipe0005#7 = nDias * ((40 / 7) ! 2);   || dias por horas por dia
     |FINSI;                                      || jornada completa

     nHoras = #vipe0002#9;
     |SI #vipe0002#7 = "N";
          #vipe0005#8 = #vipe0005#8 + nHoras;     || horas normales partes
     |FINSI;
     |SI #vipe0002#7 = "E"; |O #vipe0002#7 = "A"; |O #vipe0002#7 = "M";
          #vipe0005#9 = #vipe0005#9 + nHoras ;    || horas enf, acc, mat partes
     |FINSI;                                    || (dias en este caso)
     |SI #vipe0002#7 = "V";
          #vipe0005#10 = #vipe0005#10 + nHoras; || horas vacaciones partes
     |FINSI;                                    || (dias en este caso)
     |SI #vipe0002#7 = "F"; |O #vipe0002#7 = "f";
          #vipe0005#11 = #vipe0005#11 + nHoras;   || horas absentismo partes
     |FINSI;

     |SI #vipe0002#7 ! "F"; |Y #vipe0002#7 ! "f";
          |SI #vipe1001#2 = "D"; || horas enf, acc, mat, vac se supone
               |SI #labtraba#42 = "X";
                    #vipe0005#12 = #vipe0005#12 + (nHoras * #labtraba#47);
               |SINO;
                    #vipe0005#12 = #vipe0005#12 + (nHoras * ((40 / 7) ! 2));
               |FINSI;
          |SINO;                 || (normales se supone)
               #vipe0005#12 = #vipe0005#12 + nHoras;        || total horas partes
          |FINSI;
     |FINSI;

     nMes = #vipe0005#4;                || mes
     nMes = nMes - 1;
     |SI nMes = 0;
          nMes = 12;
          nAny = #vipe0005#3 - 1;       || a¤o
     |SINO;
          nAny = #vipe0005#3;           || a¤o
     |FINSI;

     nHorasPend = 0;
     nVacacPend = 0;
     nVacacPendAnt = 0;
     aNif = #labtraba#7;

     |BUCLE MesAnterior;

     #vipe0005#14 = nHorasPend;                   || arrastre mes anterior
     || se supone que se cogera del mantenimiento acumulados
     #vipe0005#15 = #vipe0005#13 + #vipe0005#14;  || total diferencia
/*
     |SI #0#5 = 1;       || ENERO
          #vipe0005#30 = 0;             || vacaciones pendientes a¤o actual
          #vipe0005#31 = #vipe0007#23;  || vacaciones pendientes a¤o anterior
     |SINO;              || NO ENERO
          #vipe0005#30 = #vipe0007#23;  || vacaciones pendientes a¤o actual
          #vipe0005#31 = #vipe0007#27;  || vacaciones pendientes a¤o anterior
     |FINSI;
*/

     |SI #0#5 = 1;       || ENERO
          #vipe0005#30 = 0;             || vacaciones pendientes a¤o actual
          #vipe0005#31 = nVacacPend;  || vacaciones pendientes a¤o anterior
     |SINO;              || NO ENERO
          #vipe0005#30 = nVacacPend;  || vacaciones pendientes a¤o actual
          #vipe0005#31 = nVacacPendAnt;  || vacaciones pendientes a¤o anterior
     |FINSI;

     |HAZ Calendario;
     #vipe0005#33 = (#vipe0005#5 / 30) * 2.5;     || dias generados mes
     #vipe0005#33 = #vipe0005#33 + nVacacCal;


     || total vacaciones pendientes:
     #vipe0005#32 = #vipe0005#30 + #vipe0005#31 + #vipe0005#33 - #vipe0005#10;

     |ABRE #vipe0007;
     |HAZ EsteMes;
     |CIERRA #vipe0007;
     #vipe0005#16 = nHorasIntr;                            || horas a pagar
     #vipe0005#24 = nVacacIntr;                            || horas a pagar
                         || (las introducira el usuario)

     |SI #vipe0005#16 ] 0;
          #vipe0005#17 = #vipe1002#1;                || concepto (del control)
     |SINO;
          #vipe0005#17 = #vipe1002#2;                || concepto (del control)
     |FINSI;
     nConcepto = #vipe0005#17;
     |HAZ BuscaConcepto;
     #vipe0005#18 = nImporte;                     || importe (del nomtrali)
     #vipe0005#19 = #vipe0005#16 * #vipe0005#18;  || importe total por horas a pagar

     |HAZ Total;
     #vipe0005#20 = #labtraba#7;                  || NIF
     #vipe0005#21 = #labtraba#156;                || labtraba
     #vipe0005#22 = #labtraba#77;                 || centro
     #vipe0005#23 = swVacaciones;
     ||SI swVacaciones = "*";
          nConcepto = #vipe1002#3;
          |HAZ BuscaConcepto;
          #vipe0005#25 = nConcepto;
          #vipe0005#26 = nImporte;                     || importe (del nomtrali)
          #vipe0005#29 = #vipe0005#24 * #vipe0005#26;
          /*
          |SI #labtraba#42 = "X";       || si son tp
               #vipe0005#26 = nImporte * #labtraba#47;     || dias por horas TC2
          |SINO;
               #vipe0005#26 = nImporte * ((40 / 7) ! 2);   || dias por horas por dia
          |FINSI;                                         || jornada completa
          */
     ||FINSI;

     |SI FEstado = 0;
          |GRABA 020#vipe0005.a;
     |SINO;
          |GRABA 020#vipe0005.n;
     |FINSI;
     |LIBERA #vipe0005;
|FPRC;

|DEFBUCLE vipe0002;
     #vipe0002#1;
     11;
     #0#0, #0#2, fFechaDesde, #0#6;
     #0#1, #0#3, fFechaHasta, #0#7;
     ;
     NULL, cargatmp;
|FIN;

|PROCESO ulti_dia;  || halla el ultimo dia del mes
     numer = anynum $ 4;
     |SI numer = 0;
             bisiesto = 1;
     |SINO;
             bisiesto = 0;
     |FINSI;
     |SI mesnum =  1;  topemes = 31;            |FINSI;
     |SI mesnum =  2;  topemes = 28 + bisiesto; |FINSI;
     |SI mesnum =  3;  topemes = 31;            |FINSI;
     |SI mesnum =  4;  topemes = 30;            |FINSI;
     |SI mesnum =  5;  topemes = 31;            |FINSI;
     |SI mesnum =  6;  topemes = 30;            |FINSI;
     |SI mesnum =  7;  topemes = 31;            |FINSI;
     |SI mesnum =  8;  topemes = 31;            |FINSI;
     |SI mesnum =  9;  topemes = 30;            |FINSI;
     |SI mesnum = 10;  topemes = 31;            |FINSI;
     |SI mesnum = 11;  topemes = 30;            |FINSI;
     |SI mesnum = 12;  topemes = 31;            |FINSI;
|FPRC;

|PROCESO GrabaTemporal;
     aMes = #0#5;   aMes = "00" + aMes; aMes = aMes % -102;
     aAny = #0#4;
     aFechaDesde = "01" + "." + aMes + "." + aAny;
     fFechaDesde = aFechaDesde;

     mesnum = aMes;
     anynum = aAny;
     |HAZ ulti_dia;
     aDia = topemes;
     aFechaHasta = aDia + "." + aMes + "." + aAny;
     fFechaHasta = aFechaHasta;

     alfa1 = Usuario; |QBT alfa1;    alfa1 = ("u" + alfa1) % 108;
     |NOME_DAT #5 alfa1;

     |DELINDEX #5;

     |ABRE #vipe1001;
     |ABRE #vipe0005;
     |ABRE #labtraba;
     |ABRE #vipe1002;    |LEE 000#vipe1002.p;     |CIERRA #vipe1002;

     |BUCLE vipe0002;
     |BUCLE Ajuste1;

     |CIERRA #labtraba;
     |CIERRA #vipe0005;
     |CIERRA #vipe1001;
|FPRC;

|PROGRAMA;
     |CLS;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |HAZ GrabaTemporal;
          |HAZ Presenta;
     |FINSI;
|FPRO;
