|FICHEROS;
     vipe0009 #0;
     vipe0002 #2;
     vipe0007 #7;
     vipe0010 #10,MANTE;
     vipe1001;

     labtraba #10;
|FIN;

|VARIABLES;
     aDia = "";
     nDia = 0;
     aMes = "";
     nMes = 0;
     aFecha = "";
     fFecha = @;
     aAny = "";
     nAny = 0;

     aAnyD = "";
     nAnyD = 0;
     aAnyH = "";
     nAnyH = 0;
     aMesD = "";
     nMesD = 0;
     aMesH = "";
     nMesH = 0;
     aAlfa = "";
     alfa1 = "";
     alfa2 = "";
     fech1 = @;
     fech2 = @;
     nNume = 0;
     nume1 = 0;
     nume2 = 0;
     nume3 = 0;
     sdia = 0;
     smas = 0;
     sdife = 0;
     srest = 0;

     verrfec = "0000ATENCION !! Fecha erronea o formato incorrecto ";
     vdia1 = "";
     vme1 = "";
     vany1 = "";
     vdia = 0;
     vme = 0;
     vany = 0;
     vtope = 0;
     vsw = 0;
     vfec = "";
     vblanco = "          ";
     vpuntos = "..........";
     v = 0;
     mod = 0;

     swVengoDe = 0;
     nFechaDesde = 0;
     aFechaHasta = "";
     swCreaNueva = 0;
     nLinea = 0;
     nCampo = 0;
     nLineaAct = 0;
     swEstoy = 0;
     swCuenta = 0;
     nModo = 0;
     numer = 0;
     anynum = 0;
     bisiesto = 0;
     mesnum = 0;
     topemes = 0;
     FEstado = 0;

     {-1}menu = "";
     menu1 = "2400";
     menu2 = "1";
     menu3 = "Elegir Opcion:";
     menu4 = "RAC";
     ||menu4 = "RACI";
     menu5 = "Revisar";
     menu6 = "Actualizar";
     menu7 = "Cancelar";
     || menu8 = "Imprimir";
     nOpcion = 0;
     nCuantos = 0;

     aDiaD = "";
     aDiaH = "";
     nDiaD = 0;
     nDiaH = 0;
     aAlfa1 = "";
     aAlfa2 = "";
     nHorasHis = 0;
|FIN;

/*****************   PROCESOS DESDE LA PANTALLA *****************************/

|PROCESO SiCambia;
     nume1 = Contenido;
     |SI nume1 ! #vipe0010#12;
          #vipe0010#13 = "*";
          |PINTA #vipe0010#13;
          |GRABA 020#vipe0010.a;
     |FINSI;
|FPRC;

|PROCESO ulti_dia;  || halla el ultimo dia del mes
     numer = anynum $ 4;
     |SI numer = 0;
             bisiesto = 1;
     |SINO;
             bisiesto = 0;
     |FINSI;
     |SI mesnum =  1;  topemes = 31;            |FINSI;
     |SI mesnum =  2;  topemes = 28 + bisiesto; |FINSI;
     |SI mesnum =  3;  topemes = 31;            |FINSI;
     |SI mesnum =  4;  topemes = 30;            |FINSI;
     |SI mesnum =  5;  topemes = 31;            |FINSI;
     |SI mesnum =  6;  topemes = 30;            |FINSI;
     |SI mesnum =  7;  topemes = 31;            |FINSI;
     |SI mesnum =  8;  topemes = 31;            |FINSI;
     |SI mesnum =  9;  topemes = 30;            |FINSI;
     |SI mesnum = 10;  topemes = 31;            |FINSI;
     |SI mesnum = 11;  topemes = 30;            |FINSI;
     |SI mesnum = 12;  topemes = 31;            |FINSI;
|FPRC;

|PROCESO Seleccion;
     |SI #0#7 ! "C";
          |SI #0#3 = 0;
               |MENAV "    Debe realizar una seleccion por fecha o por semana";
               #0#7 = "N";
               |PINTA #0#7;
          |FINSI;
     |FINSI;
     |SI #0#7 = "C";
          |POSICIONATE #0#2;
     |FINSI;
|FPRC;

|PROCESO BlancoFecha;
     #0#4 = "";
     |PINTA #0#4;
|FPRC;

|PROCESO fechacon1; |TIPO 0;
     vfec = #0Campo; vsw = 0;
     |SI vfec ! vblanco; |Y vfec ! vpuntos;
          vdia1 = vfec % A102;
          vme1 = vfec % A402;
          vany1 = vfec % A704;
          vdia = vdia1; vme = vme1; vany = vany1;
          |SI vdia ! 0; |Y vme ! 0; |Y vany > 1900;
               |SI vme [ 12; |Y vme ] 1;
                    |SI vme = 1; |O vme = 3; |O vme = 5;|O vme = 7;
                    |O vme = 8; |O vme = 10; |O vme = 12;
                         vtope = 31;
                    |SINO;
                         |SI vme = 2;
                              mod = vany $ 4;
                              |SI mod = 0;
                                   vtope = 29;
                              |SINO;
                                   vtope = 28;
                              |FINSI;
                         |SINO;
                              vtope = 30;
                         |FINSI;
                    |FINSI;
                    |SI vdia [ vtope;
                         vsw = 1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          vsw = 1;
     |FINSI;
     |SI vsw = 0;
          |MENAV verrfec;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO PorDia;
     aAlfa = #0#4;
     |QBF aAlfa;
     |SI aAlfa ! "";
          swVengoDe = 2;
          aDia = aAlfa % 102;
          aMes = aAlfa % 402;
          aAny = aAlfa % -104;
          nDia = aDia;
          nMes = aMes;
          nAny = aAny;
          #0#2 = nAny;
          |PINTA #0#2;
          |HAZ mirasem;
     |FINSI;
|FPRC;

|PROCESO PorDia7; |TIPO 7;
     |HAZ PorDia;
|FPRC;

|PROCESO BuscaSemana;
     aMes = #0#8;
     aMes = "00" + aMes; aMes = aMes % -102;
     aAny = #0#2;

     mesnum = #0#8;
     anynum = #0#2;
     |HAZ ulti_dia;
     aDia = topemes;
     aFecha = aDia + "." + aMes + "." + aAny;
     fFecha = aFecha;
     #0#4 = fFecha;
     |PINTA #0#4;
     |HAZ PorDia;
     #0#4 = #0#5;
     |PINTA #0#4;
|FPRC;

|PROCESO Defectos; |TIPO 7;
     fFecha = ~;
     aFecha = fFecha;
     aAny = aFecha % -104;
     nAny = aAny;

     aMes = aFecha % 402;
     nMes = aMes;
     nMes = nMes - 1;
     |SI nMes = 0;
          nAny = nAny - 1;
          nMes = 12;
     |FINSI;
     #0#8 = nMes;
     |PINTA #0#8;
     #0#2 = nAny;
     |PINTA #0#2;

     |HAZ BuscaSemana;
|FPRC;

|PROCESO PorSemana;
     aAlfa = #0#3;
     |QBF aAlfa;
     |SI aAlfa ! "";
          nNume = aAlfa;
          |SI nNume ! 0;
               swVengoDe = 1;
               |HAZ deshas;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO mirasem; |TIPO 7;
     alfa1 = #0#2;
     alfa1 = "01.01." + alfa1;
     fech1 = alfa1;            || primero saca el dia de la semana
     fech2 = fech1 % 1;        ||/que fue el uno de enero
     alfa1 = fech2 % 11;

     |SI alfa1 = "Lunes";     sdia=1; smas=1; |FINSI;
     |SI alfa1 = "Martes";    sdia=7; smas=1; |FINSI;
     |SI alfa1 = "Miercoles"; sdia=6; smas=1; |FINSI;
     |SI alfa1 = "Jueves";    sdia=5; smas=1; |FINSI; ||saca el dia del mes que fue
     |SI alfa1 = "Viernes";   sdia=4; smas=1; |FINSI; ||el primer lunes del a¤o
     |SI alfa1 = "Sabado";    sdia=3; smas=1; |FINSI;
     |SI alfa1 = "Domingo";   sdia=2; smas=1; |FINSI;

     alfa1 = ("00" + sdia) % -102;  || construye el primer lunes del a¤o
     |SI swVengoDe ! 2;
          fech1 = ~;                     ||/como fecha inicial de calculo
     |SINO;
          fech1 = #0#4;
     |FINSI;

     alfa2 = fech1 % -104;
     alfa1 = alfa1 + ".01." + alfa2;
     fech1 = alfa1;
     nume1 = fech1;                 || calcula dias hasta primer lunes a¤o

     |SI swVengoDe ! 2;
          fech1 = ~;                     ||/como fecha inicial de calculo
     |SINO;
          fech1 = #0#4;
     |FINSI;
     nume2 = fech1;

     sdife = nume2 - nume1;         || calcula la diferencia desde el primer
     |SI sdife ] 0;
          srest = sdife $ 7;           || lunes hasta la fecha actual,la redondea,
          sdife = sdife + (7 - srest); || la divide por 7 y le suma 1 por la
          nNume = (sdife / 7) + smas;|| primera semana (en su caso !!!)
          #0#3 = nNume;
     |SINO;
          nNume = 1;
          #0#3 = nNume;
     |FINSI;
/*
     |ABRE #semcntcu;
     |LEE 000#semcntcu.p;
     |CIERRA #semcntcu;

     #0Campo = #0Campo - #semcntcu#3;
*/

     |SI nNume = 0; nNume = 52; |FINSI;
     #0#3 = nNume;

     |PINTA #0#3;

     |HAZ deshas;
|FPRC;

|PROCESO deshas; |TIPO 7;   || calcula segun semana, desde dia hasta dia
/*
     |ABRE #semcntcu;
     |LEE 000#semcntcu.p;
     |CIERRA #semcntcu;

     nume2 = (#0#1 + #semcntcu#3) - smas;
*/

     nume2 = #0#3 - smas;
     nume2 = (nume2 * 7) + (sdia - 1);   || dias hasta
     nume1 = nume2 - 6;                  || dias desde

     nume3 = #0#2;
     nume3 = nume3 - 1;
     alfa1 = "31.12." + nume3;    || saca los dias que hay hasta el 31.12
     fech1 = alfa1;
     nume3 = fech1;

     nume1 = nume1 + nume3;
     fech1 = nume1;         || fecha desde
     #0#5 = fech1;

     nume2 = nume2 + nume3;
     fech1 = nume2;         || fecha hasta
     #0#6 = fech1;

     aAlfa = #0#5;
     aMesD = aAlfa % 402;
     nMesD = aMesD;
     aAnyD = aAlfa % -104
     nAnyD = aAnyD;

     aAlfa = #0#6;
     aMesH = aAlfa % 402;
     nMesH = aMesH;
     aAnyH = aAlfa % -104
     nAnyH = aAnyH;

     |SI nMesD ! nMesH;
          |SI swVengoDe = 2;
               aAlfa = #0#4;
               aMes = aAlfa % 402;
               nMes = aMes;
               aAny = aAlfa % -104;
               nAny = aAny;

               |SI nMesD = nMes;
                    mesnum = nMesD;
                    anynum = aAnyD;
                    |HAZ ulti_dia;

                    aAlfa = topemes;
                    aAlfa = aAlfa + "." + aMesD + "." + aAnyD;
                    #0#6 = aAlfa;
               |FINSI;
               |SI nMesH = nMes;
                    aAlfa = "01" + "." + aMesH + "." + aAnyH;
                    #0#5 = aAlfa;
               |FINSI;
          |SINO;
               mesnum = nMesD;
               anynum = aAnyD;
               |HAZ ulti_dia;

               aAlfa = topemes;
               aAlfa = aAlfa + "." + aMesD + "." + aAnyD;
               #0#6 = aAlfa;
          |FINSI;
     |FINSI;

     aAlfa = #0#5;
     aDiaD = aAlfa % 102;
     nDiaD = aDiaD;

     aAlfa = #0#6;
     aDiaH = aAlfa % 102;
     nDiaH = aDiaH;

     |PINTA #0#5;
     |PINTA #0#6;
|FPRC;


/*****************     FIN PROCESOS DESDE LA PANTALLA     *******************/

|PROCESO Impresion;

|FPRC;

|PROCESO actualiza;
     |SI #vipe0010#9 = #vipe0010#12;    || si las horas introducidas en partes
          ||ACABA;                       || son iguales a las reales
     |FINSI;                            || no tengo nada que regularizar

     |SI #vipe0010#13 ! "*";
          |ACABA;
     |FINSI;

     #vipe0002#0 = #vipe0010#0;
     #vipe0002#1 = #vipe0010#1;
     #vipe0002#5 = #vipe0010#5;
     |LEE 101#vipe0002.=;
     |SI FSalida = 0;         || a la fuerza: ha de existir
          #vipe0002#2 = #vipe0010#2;
          #vipe0002#3 = #vipe0010#3;
          #vipe0002#4 = #vipe0010#4;
          #vipe0002#6 = #vipe0010#6;
          #vipe0002#7 = #vipe0010#7;
          #vipe0002#8 = #vipe0010#8;
          #vipe0002#9 = #vipe0010#9;
          #vipe0002#12 = #vipe0010#12;
     |FINSI;
     |GRABA 020#vipe0002.a;

     #labtraba#0 = #vipe0002#0;
     #labtraba#1 = #vipe0002#1;
     |LEE 000#labtraba.=;

     |DDEFECTO #vipe0007;
     #vipe0007#0 = #vipe0002#0;         || empresa
     #vipe0007#1 = #vipe0002#1;         || trabajador
     #vipe0007#3 = #vipe0002#3;         || a¤o
     || nMes = #vipe0002#10 + 1;
     || SI nMes = 13;
     ||     nMes = 1;
     ||     #vipe0007#3 = #vipe0007#3 + 1;
     || FINSI;
     #vipe0007#4 = #vipe0002#10;         || mes
     |LEE 101#vipe0007.=;
     FEstado = FSalida;

     |SI #vipe0007#15 ! 0;    || si ya se habia regularizado descuento del
          #vipe0007#14 = #vipe0007#14 - #vipe0007#15;  || pendientes mes anterior
          #vipe0007#18 = #vipe0007#18 - #vipe0007#15;  || arrastre pendientes
     |FINSI;
     #vipe0007#15 = #vipe0002#12 - #vipe0002#9;   || regularizacion
     #vipe0007#14 = #vipe0007#14 + #vipe0007#15;  || pendientes mes anterior
     #vipe0007#18 = #vipe0007#18 + #vipe0007#15;  || arrastre pendientes

     #vipe0007#24 = #labtraba#7;                  || NIF
     #vipe0007#26 = #labtraba#77;                 || centro
     #vipe0007#30 = "S";                 || centro

     |SI FEstado = 0;
          |GRABA 020#vipe0007.a;
     |SINO;
          |GRABA 020#vipe0007.n;
     |FINSI;
     nCuantos = nCuantos + 1;
|FPRC;

|DEFBUCLE actualiza;
     #vipe0010#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, actualiza;
|FIN;

|PROCESO Actualizacion;
     nCuantos = 0;
     |BUCLE actualiza;
     aAlfa = nCuantos;
     |SI nCuantos = 0;
          aAlfa = "    No se actualizo ningun trabajador";
     |SINO;
          aAlfa = "    Se ha actualizado "  + aAlfa + " trabajadores.";
     |FINSI;
     |MENAV aAlfa;
|FPRC;


|PROCESO SinAlta; |TIPO 6;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 1;
          |ERROR;
     |FINSI;
     |SI nModo = 2;
          |SI #vipe0010#7 ! "N";
               |MENAV "    ATENCION: solo es posible regularizar las horas Normales";
               |ERROR;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Consulta; |TIPO 11;
     |SI FSalida = 13;
          |SI swCuenta = 0;
               |CONSULTA_CLAVE #1#vipe0010;
               swCuenta = 1;
          |SINO;
               swCuenta = 0;
          |FINSI;
     |FINSI;
     |SI FSalida = 14;
          |SI #vipe0010#13 = "*";
               #vipe0010#13 = " ";
          |SINO;
               #vipe0010#13 = "*";
          |FINSI;
          |PINTA #vipe0010#13;
          |GRABA 020#vipe0010.a;
     |FINSI;
|FPRC;

|PROCESO tipo5; |TIPO 5;
     |PTEC 809;
|FPRC;

|PROCESO inferior;
     |SI FSalida = "POSICION";
          #vipe0010#10 = nLineaAct;
          |ACABA;
     |FINSI;
     #vipe0010#10 = 001;
|FPRC;

|PROCESO superior;
     #vipe0010#10 = 999;
|FPRC;

|PROCESO Presenta;
     |ABRE #vipe0002;
     |ABRE #vipe0007;
     |ABRE #labtraba;
     |PARA; |SI; |HACIENDO;
          |ENTLINEAL #1#vipe0010, -1, 2, 22, 0, inferior, superior;
          |MENU menu;
          nOpcion = FSalida;
          |SI nOpcion = 2;     |HAZ Actualizacion;     |SAL;|FINSI;
          |SI nOpcion = 3;     |SAL;                    |FINSI;
          ||SI nOpcion = 4;     |HAZ Impresion;            |FINSI;
          menu2 = nOpcion;
     |SIGUE;
     |CIERRA #labtraba;
     |CIERRA #vipe0007;
     |CIERRA #vipe0002;
|FPRC;

|PROCESO BuscaHis;
     nHorasHis = -1;
     |DDEFECTO #vipe0007;
     #vipe0007#0 = #vipe0002#0;         || empresa
     #vipe0007#1 = #vipe0002#1;         || trabajador
     #vipe0007#3 = #vipe0002#3;         || a¤o
     #vipe0007#4 = #vipe0002#10;         || mes
     |LEE 101#vipe0007.=;
     |SI FSalida = 0;
          nHorasHis = (-1) * #vipe0007#15;
          |SI #vipe0002#9 = nHorasHis;
               nHorasHis = 0;
          |FINSI;
     |FINSI;

     || si se cumple se supone que las horas que habia actualizadas en el
     || campo "regularizacion" son iguales a las horas que tenia que haber hecho
     || pero en negativo, es decir, que intencionadamente se habia dejado
     || la regularizacion a cero, mantengo el valor
|FPRC;

|PROCESO cargatmp;
     |DDEFECTO #vipe0010;
     nLinea = nLinea + 1;
     #vipe0010#0 = #vipe0002#0;
     #vipe0010#1 = #vipe0002#1;
     #vipe0010#2 = #vipe0002#2;
     #vipe0010#3 = #vipe0002#3;
     #vipe0010#4 = #vipe0002#4;
     #vipe0010#5 = #vipe0002#5;
     #vipe0010#6 = #vipe0002#6;
     #vipe0010#7 = #vipe0002#7;
     #vipe0010#8 = #vipe0002#8;
     #vipe0010#9 = #vipe0002#9;
     #vipe0010#10 = nLinea;

     #labtraba#0 = #vipe0002#0;    || empresa
     #labtraba#1 = #vipe0002#1;    || trabajador
     |LEE 000#labtraba.=;

     |HAZ BuscaHis;

     |SI #0#7 = "N"; |Y #vipe0007#30 = "S";
          |ACABA;
     |FINSI;
     |SI #0#7 = "A"; |Y #vipe0007#30 = "N";
          |ACABA;
     |FINSI;

     |SI #vipe0002#7 ="N";
          |SI #vipe0002#12 = 0;              || se supone que si no he introducido nada
               |SI #vipe0002#9 ! 0; |Y nHorasHis ! 0;
                    #vipe0010#12 = #vipe0002#9;   || por defecto cargo las horas en teoria
               |FINSI;
          |SINO;
               #vipe0010#12 = #vipe0002#12;  || si no las que hubiera
          |FINSI;
     |SINO;
          #vipe0010#12 = #vipe0002#9;   || si no son horas "normales"
     |FINSI;

     |GRABA 020#vipe0010.n;
     |LIBERA #vipe0010;
|FPRC;

|DEFBUCLE cargatmp;
     #vipe0002#1;
     11;
     #0#0, 00001, #0#5, #0#1;
     #0#0, 99999, #0#6, #0#1;
     ;
     NULL, cargatmp;
|FIN;

|PROCESO LaCargaDelTmp;
     alfa1 = Usuario; |QBT alfa1;    alfa1 = ("t" + alfa1) % 108;
     |NOME_DAT #10 alfa1;

     |DELINDEX #10;

     |ABRE #labtraba;
     |ABRE #vipe0010;
     |ABRE #vipe0007;
     nLinea = 0;
     |BUCLE cargatmp;
     |CIERRA #vipe0007;
     |CIERRA #vipe0010;
     |CIERRA #labtraba;

     |PONCONTROL 23, "si";
|FPRC;

|PROGRAMA;
     |CLS;
     |PINPA #0#0;
     |PINDA #0#0;
     |PARA; |SI FEstado ! 14; |HACIENDO;
          |ENDATOS #1#0;
          |SI FSalida = -1;
               |SAL;
          |FINSI;
          |SI FSalida = 0;
               nLineaAct = 1;
               swEstoy = 1;
               |PARA; |SI swEstoy > 0; |HACIENDO;
                    |HAZ LaCargaDelTmp;
                    swEstoy = 0;
                    |HAZ Presenta;
               |SIGUE;
          |FINSI;
     |SIGUE;
|FPRO;
