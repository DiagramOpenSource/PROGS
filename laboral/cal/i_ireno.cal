|FICHEROS;
    labtraba #2;
    labempre #3;
    nomauxi1 #4;    || areas (grupos)
    nomauxi2 #5;    || secciones (subgrupos)
    nomauxc3 #6;    || prorrata cabs.
    nomauxl3 #7;    || prorrata lins.
    nomauxtp #8;    || temporal prorrata
|FIN;

|VARIABLES;
    month = 0;
    mesos = 0;
    seleccio = 0;
    centro = 0;
    sw = 0;
    empresa = 0;

    ginf_enf = 0;
    ginf_sub = 0;
    ginf_bru = 0;
    ginf_dto = 0;
    ginf_tan = 0;
    ginf_ded = 0;
    ginf_dse = 0;
    ginf_liq = 0;
    ginf_sss = 0;
    ginf_exe = 0;

    sinf_enf = 0;
    sinf_sub = 0;
    sinf_bru = 0;
    sinf_dto = 0;
    sinf_tan = 0;
    sinf_ded = 0;
    sinf_dse = 0;
    sinf_liq = 0;
    sinf_sss = 0;
    sinf_exe = 0;

    cinf_enf = 0;
    cinf_sub = 0;
    cinf_bru = 0;
    cinf_dto = 0;
    cinf_tan = 0;
    cinf_ded = 0;
    cinf_dse = 0;
    cinf_liq = 0;
    cinf_sss = 0;
    cinf_exe = 0;
    tinf_tan = 0;
    nume1 = 0;
    nume2 = 0;
    fech1 = @;
    fech2 = @;
    fecsys = @;
    alfa1 = "";
    error0       = "     Proceso ABORTADO !!! ";
    informe = "nomireno";
    &p_mes = " ";
    &swlin = 0;
    &varinf1 = "";
    &varinf2 = "";

    &inf_enf = 0;
    &inf_sub = 0;
    &inf_bru = 0;
    &inf_dto = 0;
    &inf_tan = 0;
    &inf_ded = 0;
    &inf_dse = 0;
    &inf_liq = 0;
    &inf_sss = 0;
    &inf_exe = 0;

    &pinf_enf = 0;
    &pinf_sub = 0;
    &pinf_bru = 0;
    &pinf_dto = 0;
    &pinf_ded = 0;
    &pinf_dse = 0;
    &pinf_liq = 0;
    &pinf_sss = 0;
    &pinf_exe = 0;

    &tinf_tc1 = 0;
    &tinf_enf = 0;
    &tinf_sub = 0;
    &tinf_bru = 0;
    &tinf_dto = 0;
    &tinf_ded = 0;
    &tinf_dse = 0;
    &tinf_liq = 0;
    &tinf_sss = 0;
    &tinf_exe = 0;

    &fecha = @;
    &cabeza = "";
    grupo = "";
    subgr = "";
    campo1 = 0;
    campo2 = 0;
    campo3 = 0;
    campo4 = 0;
    campo5 = 0;
    campo6 = 0;
    campo7 = 0;
    campo8 = 0;
    campo9 = 0;
    campoa = 0;
    ultimo = 0;
    area = "";
    secc = "";
    coef = 0;

    dia = 0;
    mes = 0;
    any = 0;
    swbaja = 0;
    fecalf = "";
    &inf_ant = 0;
     swSigue = 0;
|FIN;

*****************************************************************************
    LLAMADAS DESDE CAMPOS
*****************************************************************************

|PROCESO mirames; |TIPO 7; ||CALCULA EL MES POR DEFECTO SEGUN FECHA SISTEMA
    fecsys = ~;
    alfa1 = fecsys;
    alfa1 = alfa1 % 402;
    #0Campo = alfa1;
|PINTA #0Campo;
|FPRC;

|PROCESO pintames; |TIPO 0;      || PINTA EL MES LITERAL
|SI #0Campo =  1;  p_mes = "ENERO     ";  |FINSI;
|SI #0Campo =  2;  p_mes = "FEBRERO   ";  |FINSI;
|SI #0Campo =  3;  p_mes = "MARZO     ";  |FINSI;
|SI #0Campo =  4;  p_mes = "ABRIL     ";  |FINSI;
|SI #0Campo =  5;  p_mes = "MAYO      ";  |FINSI;
|SI #0Campo =  6;  p_mes = "JUNIO     ";  |FINSI;
|SI #0Campo =  7;  p_mes = "JULIO     ";  |FINSI;
|SI #0Campo =  8;  p_mes = "AGOSTO    ";  |FINSI;
|SI #0Campo =  9;  p_mes = "SEPTIEMBRE";  |FINSI;
|SI #0Campo = 10;  p_mes = "OCTUBRE   ";  |FINSI;
|SI #0Campo = 11;  p_mes = "NOVIEMBRE ";  |FINSI;
|SI #0Campo = 12;  p_mes = "DICIEMBRE ";  |FINSI;
|ATRI I;
|PINTA 1448, p_mes;
|ATRI 0;
|FPRC;

|PROCESO defecto; |TIPO 7;    || calcula el a₪o por defecto segun sistema
     fech1 = ~;
     alfa1 = fech1;
     alfa1 = alfa1 % -102;
     #0Campo = alfa1;
     |PINTA #0Campo;
|FPRC;

*****************************************************************************
    LECTURA E IMPRESION
*****************************************************************************

|PROCESO imprimir;
|ABRE #3;
    #3#0 = #8#0;
|LEE 020#3=;
|SI FSalida ! 0;  |DDEFECTO #3;  |FINSI;
|CIERRA #3;
    #2#0 = #8#0;
    #2#1 = #8#1;
|LEE 001#2=;
|SI FSalida = 0;
        |SI sw = 0;
                seleccio = 1;
                empresa = #2#0;
                grupo = #8#2;
                subgr = #8#3;
                sw = 1;
        |FINSI;
        |SI empresa ! #2#0;                            || ruptura por empresa
            |HAZ tc1;
                swlin = 2;
            |HAZ puesubgrs;  |PRINT;
            |HAZ puegrupos;  |PRINT;
                swlin = 9;
            |PIEINF;
            |HAZ limptotal;
            |HAZ limparcial;
            |HAZ limpgrupos;
            |HAZ limpsubgrs;
                empresa = #2#0;
                grupo = #8#2;
                subgr = #8#3;
                swlin = 0;
        |SINO;
            |SI grupo ! #8#2;          || ruptura por grupos
                    swlin = 2;
                |HAZ puesubgrs;  |PRINT;  |HAZ limpsubgrs;
                |HAZ puegrupos;  |PRINT;  |HAZ limpgrupos;
                    grupo = #8#2;
                    subgr = #8#3;
                    swlin = 9;
                    FSalida = "PAGINA";
                |PRINT;
                    swlin = 0;

            |SINO;
                |SI subgr ! #8#3;          || ruptura por subgrupos
                        swlin = 2;
                    |HAZ puesubgrs;  |PRINT;  |HAZ limpsubgrs;
                        subgr = #8#3;
                        swlin = 0;
                |FINSI;
            |FINSI;
        |FINSI;
        |HAZ detalle_tmp;
        |PRINT;
        |HAZ grupos;
        |HAZ subgr;
        |HAZ totales;
|FINSI;
|FPRC;

|DEFBUCLE lee_temporal;
 #8#1;
 ;
     1, "    ", "    ",     1,0;
 99999, "zzzz", "zzzz", 99999,9;
 e;
 NULL, imprimir;
|FIN;

****************************************************************************
               GRABACION DEL TEMPORAL
****************************************************************************

|PROCESO limpieza;
|DDEFECTO #7;
    campo1 = 0;
    campo2 = 0;
    campo3 = 0;
    campo4 = 0;
    campo5 = 0;
    campo6 = 0;
    campo7 = 0;
    campo8 = 0;
    campo9 = 0;
    campoa = 0;
    ultimo = 0;
|FPRC;

|PROCESO ultimo;
    ultimo = #7#2;
|FPRC;

|PROCESO graba;
    #8#00 = #1#0;        || empresa
    #8#01 = #1#1;        || trabajador
    #8#02 = area;        || area
    #8#03 = secc;        || seccion
    #8#04 = coef;        || coeficiente
|SI #7#2 ! ultimo;
        #8#05 = inf_enf*#8#4;     || campo  1
        #8#06 = inf_sub*#8#4;     || campo  2
        #8#07 = inf_bru*#8#4;     || campo  3
        #8#08 = inf_dto*#8#4;     || campo  4
        #8#09 = inf_tan*#8#4;     || campo  5
        #8#10 = inf_ded*#8#4;     || campo  6
        #8#11 = inf_dse*#8#4;     || campo  7
        #8#12 = inf_liq*#8#4;     || campo  8
        #8#13 = inf_sss*#8#4;     || campo  9
        #8#14 = inf_exe*#8#4;     || campo 10
        campo1 = campo1 + #8#05;
        campo2 = campo2 + #8#06;
        campo3 = campo3 + #8#07;
        campo4 = campo4 + #8#08;
        campo5 = campo5 + #8#09;
        campo6 = campo6 + #8#10;
        campo7 = campo7 + #8#11;
        campo8 = campo8 + #8#12;
        campo9 = campo9 + #8#13;
        campoa = campoa + #8#14;
|SINO;
        #8#05 = inf_enf-campo1;   || campo  1
        #8#06 = inf_sub-campo2;   || campo  2
        #8#07 = inf_bru-campo3;   || campo  3
        #8#08 = inf_dto-campo4;   || campo  4
        #8#09 = inf_tan-campo5;   || campo  5
        #8#10 = inf_ded-campo6;   || campo  6
        #8#11 = inf_dse-campo7;   || campo  7
        #8#12 = inf_liq-campo8;   || campo  8
        #8#13 = inf_sss-campo9;   || campo  9
        #8#14 = inf_exe-campoa;   || campo 10
|FINSI;
#8#16 = 0;
|GRABA 020#8n;
|FPRC;

|PROCESO prorrata;
    area = #7#3;
    secc = #7#4;
    coef = #7#7;
|HAZ graba;
|FPRC;

|PROCESO leetraba;
    swbaja = 0;
    fecalf = #1#5;

    alfa1 = fecalf %  102;   dia = alfa1;
    alfa1 = fecalf %  402;   mes = alfa1;
    alfa1 = fecalf % -102;   any = alfa1;
|SI alfa1 = "....";
        dia = 0;
        mes = 0;
        any = 0;
|FINSI;

|SI mes = #0#2; |Y any = #0#4;     swbaja = 1;    |FINSI;
|FPRC;

|PROCESO temporal;
     |ABRE #3;
     |DDEFECTO #3;
     #3#0 = #2#0;
     |LEE 020#3=;
     |CIERRA #3;

     |SI #3#36 ! "N";   || si el switch de emision no es "N"
          #1#0 = #2#0;   || Empresa
          #1#1 = #2#1;   || Trabajador
          #1#2 = #0#2;   || Mes
          #1#3 = #0#5;   || Tipo
          |SI runnom = "nomwreno";  #1#66 = #0#4;  |FINSI;   || a₪o historico
          |LEE 000#1=;
          |SI FSalida = 0;
               |HAZ leetraba;
               |SI #0#10 ! "T";
                    |SI #0#10 = "A";|Y swbaja = 1;   |ACABA;   |FINSI;
                    |SI #0#10 = "B";|Y swbaja = 0;   |ACABA;   |FINSI;
               |FINSI;

               |HAZ limpieza;
               |HAZ detalle;

               |ABRE #6;
               swSigue = 0;
               #6#0 = #1#0;
               #6#1 = #1#1;
               #6#3 = #0#4 + 2000;
               #6#4 = #0#2;
               |LEE 001#6=;
               |SI FSalida = 0;
                    swSigue = 1;
               |SINO;
                    #6#0 = #1#0;
                    #6#1 = #1#1;
                    #6#3 = 0000;
                    #6#4 = 00;
                    |LEE 001#6=;
                    |SI FSalida = 0;
                         swSigue = 1;
                    |FINSI;
               |FINSI;
               |SI swSigue = 1;
                    |BUCLELIN 2ultimo#6;
                    |BUCLELIN 2prorrata#6;
               |SINO;
                    area = #2#62;
                    secc = #2#63;
                    coef = 1;
                    |HAZ graba;
               |FINSI;
               |CIERRA #6;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE gra_temporal;
 #2#1;
 77;
 #0#0,     1, #0#8;
 #0#1, 99999, #0#9;
 ;
 NULL, temporal;
|FIN;

|PROCESO imprime;|TIPO 3;
|IMPRE 0;
|SI FSalida = 0;
        fecha = #0#3;
        cabeza = cabeza_tit + p_mes;
    |HAZ centra;
        alfa1 = Usuario; |QBF alfa1;
    |NOME_DAT #8 alfa1;
    |DELINDEX #8;
    |ABRE #1;
    |INFOR informe;
        seleccio = 0;
    |ABRE #8;
    |BUCLE gra_temporal;
    |CIERRA #8;
    |ABRE #2;
    |BUCLE lee_temporal;
    |CIERRA #2;
    |SI seleccio = 1;
            swlin = 2;
        |HAZ puesubgrs;  |PRINT;
        |HAZ puegrupos;  |PRINT;
        |HAZ tc1;
        |PIEINF;
    |FINSI;
    |FININF;
    |DELINDEX #8;
    |CIERRA #1;
|SINO;
    |MENAV error0;
|FINSI;
|FINIMP;
|FPRC;

******************************************************************************
    CARGA DE VARIABLES
******************************************************************************

|PROCESO detalle;
    ||inf_enf = #1#57 + #1#58 + #1#55 + #1#56;      || prestaciones
    inf_enf = #1#57 + #1#58;      || prestaciones
    inf_sub = #1#46 - inf_enf + #1#45;            || coste trabajad.
    inf_bru = #1#46;                              || Importe bruto
    inf_dto = #1#38;                              || Importe prorrata
    inf_tan = #1#13; inf_tan = inf_tan ! 2;       || Porcentaje
    inf_ded = #1campo_irpf;                       || Deduccion
    inf_dse = #1#48 + #1#49 + #1#50 + #1#51;      || Deduccion S.S
    inf_ant = #1#52 + #1#53 + #1#54;              || Anticipo
    inf_liq = inf_bru -inf_ded -inf_dse -inf_ant; || Liquido
    inf_sss = #1#45;                              || S.S CGO
    inf_exe = #1#18;                              || Base IRPF exenta
|FPRC;

|PROCESO detalle_tmp;
    inf_enf = #8#05;                              || prestaciones
    inf_sub = #8#06;                              || coste trabajad.
    inf_bru = #8#07;                              || Importe bruto
    inf_dto = #8#08;                              || Importe prorrata
    inf_tan = #8#09;                              || Porcentaje
    inf_ded = #8#10;                              || Deduccion
    inf_dse = #8#11;                              || Deduccion S.S
    inf_liq = #8#12;                              || Liquido
    inf_sss = #8#13;                              || S.S CGO
    inf_exe = #8#14;                              || Base IRPF exenta
|FPRC;

|PROCESO grupos;
    ginf_enf = ginf_enf + inf_enf;       || Enfermedad
    ginf_sub = ginf_sub + inf_sub;       || Subnormalidad
    ginf_bru = ginf_bru + inf_bru;       || Importe bruto
    ginf_dto = ginf_dto + inf_dto;       || Importe prorrata
    ginf_tan = ginf_tan ! 2;             || Porcentaje
    ginf_ded = ginf_ded + inf_ded;       || Deduccion
    ginf_dse = ginf_dse + inf_dse;       || Deduccion S.S
    ginf_liq = ginf_liq + inf_liq;       || Liquido
    ginf_sss = ginf_sss + inf_sss;       || S.S CGO
    ginf_exe = ginf_exe + inf_exe;       || Base IRPF exenta
|FPRC;

|PROCESO subgr;
    sinf_enf = sinf_enf + inf_enf;       || Enfermedad
    sinf_sub = sinf_sub + inf_sub;       || Subnormalidad
    sinf_bru = sinf_bru + inf_bru;       || Importe bruto
    sinf_dto = sinf_dto + inf_dto;       || Importe prorrata
    sinf_tan = sinf_tan ! 2;             || Porcentaje
    sinf_ded = sinf_ded + inf_ded;       || Deduccion
    sinf_dse = sinf_dse + inf_dse;       || Deduccion S.S
    sinf_liq = sinf_liq + inf_liq;       || Liquido
    sinf_sss = sinf_sss + inf_sss;       || S.S CGO
    sinf_exe = sinf_exe + inf_exe;       || Base IRPF exenta
|FPRC;

|PROCESO centros;
    cinf_enf = cinf_enf + inf_enf;       || Enfermedad
    cinf_sub = cinf_sub + inf_sub;       || Subnormalidad
    cinf_bru = cinf_bru + inf_bru;       || Importe bruto
    cinf_dto = cinf_dto + inf_dto;       || Importe prorrata
    cinf_tan = cinf_tan ! 2;             || Porcentaje
    cinf_ded = cinf_ded + inf_ded;       || Deduccion
    cinf_dse = cinf_dse + inf_dse;       || Deduccion S.S
    cinf_liq = cinf_liq + inf_liq;       || Liquido
    cinf_sss = cinf_sss + inf_sss;       || S.S CGO
    cinf_exe = cinf_exe + inf_exe;       || Base IRPF exenta
|FPRC;

|PROCESO totales;
    tinf_enf = tinf_enf + inf_enf;       || Enfermedad
    tinf_sub = tinf_sub + inf_sub;       || Subnormalidad
    tinf_bru = tinf_bru + inf_bru;       || Importe bruto
    tinf_dto = tinf_dto + inf_dto;       || Importe prorrata
    tinf_tan = tinf_tan ! 2;             || Porcentaje
    tinf_ded = tinf_ded + inf_ded;       || Deduccion
    tinf_dse = tinf_dse + inf_dse;       || Deduccion S.S
    tinf_liq = tinf_liq + inf_liq;       || Liquido
    tinf_sss = tinf_sss + inf_sss;       || S.S CGO
    tinf_exe = tinf_exe + inf_exe;       || Base IRPF exenta
|FPRC;

******************************************************************************
    PASE DE VARIABLES
******************************************************************************

|PROCESO puecentro;
    pinf_enf = cinf_enf;
    pinf_sub = cinf_sub;
    pinf_bru = cinf_bru;
    pinf_dto = cinf_dto;
    pinf_ded = cinf_ded;
    pinf_dse = cinf_dse;
    pinf_liq = cinf_liq;
    pinf_sss = cinf_sss;
    pinf_exe = cinf_exe;
|FPRC;

|PROCESO puegrupos;
|ABRE #4;
    #4#0 = grupo;
|LEE 001#4=;
|SI FSalida ! 0;  |DDEFECTO #4;  |FINSI;
|CIERRA #4;
    varinf1 = #4#1;
|QBF varinf1;
    varinf1 = varinf1 + "******************************";
    varinf1 = varinf1 % 133;
    pinf_enf = ginf_enf;
    pinf_sub = ginf_sub;
    pinf_bru = ginf_bru;
    pinf_dto = ginf_dto;
    pinf_ded = ginf_ded;
    pinf_dse = ginf_dse;
    pinf_liq = ginf_liq;
    pinf_sss = ginf_sss;
    pinf_exe = ginf_exe;
|FPRC;

|PROCESO puesubgrs;
|ABRE #5;
    #5#0 = grupo;
    #5#1 = subgr;
|LEE 001#5=;
|SI FSalida ! 0;  |DDEFECTO #5;  |FINSI;
|CIERRA #5;
    varinf1 = #5#2;
|QBF varinf1;
    varinf1 = varinf1 + "שששששששששששששששששששששששששששששש";
    varinf1 = varinf1 % 133;
    pinf_enf = sinf_enf;
    pinf_sub = sinf_sub;
    pinf_bru = sinf_bru;
    pinf_dto = sinf_dto;
    pinf_ded = sinf_ded;
    pinf_dse = sinf_dse;
    pinf_liq = sinf_liq;
    pinf_sss = sinf_sss;
    pinf_exe = sinf_exe;
|FPRC;

******************************************************************************
    LIMPIEZA DE VARIABLES
******************************************************************************

|PROCESO limpgrupos;
    ginf_enf = 0;
    ginf_sub = 0;
    ginf_bru = 0;
    ginf_dto = 0;
    ginf_ded = 0;
    ginf_dse = 0;
    ginf_liq = 0;
    ginf_sss = 0;
    ginf_exe = 0;
|FPRC;

|PROCESO limpsubgrs;
    sinf_enf = 0;
    sinf_sub = 0;
    sinf_bru = 0;
    sinf_dto = 0;
    sinf_ded = 0;
    sinf_dse = 0;
    sinf_liq = 0;
    sinf_sss = 0;
    sinf_exe = 0;
|FPRC;

|PROCESO limparcial;
    cinf_enf = 0;
    cinf_sub = 0;
    cinf_bru = 0;
    cinf_dto = 0;
    cinf_ded = 0;
    cinf_dse = 0;
    cinf_liq = 0;
    cinf_sss = 0;
    cinf_exe = 0;
|FPRC;

|PROCESO limptotal;
    tinf_enf = 0;
    tinf_sub = 0;
    tinf_bru = 0;
    tinf_dto = 0;
    tinf_ded = 0;
    tinf_dse = 0;
    tinf_liq = 0;
    tinf_sss = 0;
    tinf_exe = 0;
    tinf_tc1 = 0;
    tinf_tc1re = 0;
|FPRC;

******************************************************************************
   RUTINAS
******************************************************************************

|PROCESO centra;         || CENTRA TITULO DEL INFORME
    alfa1 = cabeza % 0;
    nume1 = alfa1;
    nume2 = ((79 - nume1) / 2) - 0.5;
    nume2 = nume2 ! 0;
    alfa1 = " " * nume2;
    cabeza = alfa1 + cabeza;
|FPRC;
