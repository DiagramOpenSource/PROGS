|FICHEROS;
     nomir001 #0;
     labempre #1;   || empresas
     labtraba #2;   || trabajadores
     nomhicca #3;   || historico cabs.
     nomcalca #4;   || calculos cabs.
     labregis #5;   || registro contratos
     nomhicli #6;   || historico lins.
     nomcalli #7;   || calculos lins.
     nomconli #8;   || convenios lins.
     nomvarca;
     nomauto2;
     nomconca;

     nomir002 #101,MANTE; || asignar codigo
     nomir003 #102,MANTE; || parametros de calculo
     nomir004 #103,MANTE; || ayuda para pintar campos en formato estandar
     nomir005 #104,MANTE; || presentacion de resultados
     nomir007 #106,MANTE; || fechas de alta/baja modificadas

     nomir999 #999;      || detector de cambio de version

     nomir008 #2000;     || resultados calculo masivo
     nomir009 #2002;     || regularizacion automatica

     :/modelos/def/dsm190li  #137; || mantenimiento 190 lineas
     :/modelos/def/dsm19001;       || mantenimiento 190 lineas 2016
     :/modelos/def/dsmom026  #138; || grupos de empresas para 110/190

     nomimpre;
     nomcalac;   || calculos atrasos cabs.
     nomir012,MANTE;
     nomconst;
     nomir013;
     nomir015;
     nomirz15,MANTE;
     nomtrtmp #200;

     nomir020,MANTE;
     nomir016 #201;
     elmodulo@ #500;
|FIN;

|VARIABLES;
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aAlfa4 = "";
     nNume0 = 0;
     nNume1 = 0;
     nNume2 = 0;
     nNume3 = 0;
     nNume4 = 0;
     nPara1 = 0;
     nPara2 = 0;
     nPara3 = 0;
     nPara4 = 0;
     nPara5 = 0;
     fFech1 = @;
     fFech2 = @;
     fFech3 = @;
     fFech4 = @;

     x = "";
     final = "";
     letra = "";
     letrasnif = "TRWAGMYFPDXBNJZSQVHLCKE";
     lugar = 0;
     resto = 0;
     nifnum = 0;

     &nCalculo99 = 0;          || comunicacion con 'nomcalir'
     &nEmpr99 = 0;
     &nTrab99 = 0;
     &nAnyo99 = 0;
     &nEstima = 0;
     &nSeguri = 0;
     &nMes99 = 0;
     &nSwMes99 = 0;
     &aFeAlta = "";
     &aFeBaja = "";

     &nDiferencias = 0;
     &nVEmp = 0;
     &aVDNI = "";
     &nVAny = 0;
     &nCuotNueva = 0;
     &nFam00    =  0;
     &nFam01    = 0;
     &nFam02    = 0;
     &nFam03    = 0;
     &nFam04    = 0;
     &nFam05    = 0;
     &enEdad    = 0;
     &eaTContr  = "";
     &eaDiscap  = "";
     &eaSitFam  = "";
     &eaCeMel   = "";
     &eaGrado   = "";
     &enEmpresa = 0;
     &eaNif     = "";
     &enModoNif = 0;
     &enAnyo    = 0;

     nModo = 0;
     nModoExt = 0;
     nInkey = 0;
     nSwRepinta = 0;
 {-1}pMenu  = "";
     pMenu1 = "1618";
     /*
     pMenu2 = "1";
     pMenu3 = "6";
     pMenu4 = "Datos Familiares ";
     pMenu5 = "Asignar Codigo de Trabajador.";
     pMenu6 = "Emitir Comunicacion de  Datos.";
     pMenu7 = "Configurar Parametros del Calculo.";
     pMenu8 = "Presentar Resultados del Calculo.";
     pMenu9 = "Actualizar Porcentaje en Trabajador.";
     */
     pMenu2 = "1";
     pMenu3 = "5";
     pMenu4 = "Datos Personales y Familiares.";
     pMenu5 = "Emitir Comunicaci¢n de Datos.";
     pMenu6 = "Consultar Par metros del C lculo.";
     pMenu7 = "Anualidades, reducciones art.18 y gastos art.19.2";
     pMenu8 = "Presentar Resultados del C lculo.";
     nCodEmpr = 0;
     nCodTrab = 0;
     &aEjemplar = "";
     NifLetra = "";
     nEstado = 0;
     nEstado2 = 0;
     nLinea = 0;
     nDosDigitos = 0;
     nEdad = 0;
     nEsBases = 0;
     nEsCuota = 0;
     nTipo = 0;
     nGuardaTipo = 0;
     nAcumSS = 0;
     &nMes = 0;
     &nAny = 0;
     nTopemes = 0;
     nSwMes = 0;
     &nElTop = 12;
     &nElMesIRPF = 0;
     &nElAnyIRPF = 0;
     nAcumBases = 0;
     nAcumCuota = 0;
     aPMensual = "";
     nOtrosIngresos = 0;
     nOtrosSocial = 0;
     nAsignado = 0;
     nEmpAsig = 0;
     nTraAsig = 0;
     &nEsteMes = 0;
     nBaseEste = 0;
     nSeguEste = 0;

     nB0 = 0;
     nB1 = 0;
     nB2 = 0;
     nB3 = 0;
     nB4 = 0;
     nB5 = 0;
     nB6 = 0;
     nR0 = 0;
     nR1 = 0;
     nR2 = 0;
     nR3 = 0;
     nR4 = 0;
     nR5 = 0;
     nR6 = 0;
     nP0 = 0;
     nP1 = 0;
     nP2 = 0;
     nP3 = 0;
     nP4 = 0;
     nP5 = 0;
     nP6 = 0;
     nEspecial = 0;
     nInferior = 0;
     nMaximo = 0;
     nEntero = 0;
     nEl20 = 0;
     nEl21 = 0;
     nEl22 = 0;
     nEl23 = 0;

     n12 = 0;      n25 = 0;      n100 = 0;
     n150 = 0;     n200 = 0;     n300 = 0;
     n375 = 0;     n500 = 0;     n550 = 0;
     n600 = 0;     n650 = 0;     n850 = 0;
     n1150 = 0;    n1250 = 0;    n1350 = 0;
     n1351 = 0;    n1450 = 0;    n1675 = 0;
     n1850 = 0;    n2000 = 0;    n2025 = 0;
     n3500 = 0;

     &EURODB = 0;

     nSwPagas = 0;
     nPaga12 = 0;

     nRNT = 0;
     nMINPER = 0;
     nRED46 = 0;
     nDISTRA = 0;
     nPROLONLAB = 0;
     nMOVILGEO = 0;
     n65PER = 0;
     n75PER = 0;
     nDISPER = 0;
     nASISPER = 0;
     nPENSION = 0;
     nDESEM = 0;
     nCUIDADO = 0;
     nNUMDES = 0;
     nHIJOS = 0;
     nDISDES = 0;
     nASISDES = 0;
     n65AS = 0;
     nNUMAS = 0
     n75AS = 0;
     nDISAS = 0;
     nREDU = 0;
     nBASE = 0;
     aBASE = "";
     nRED65 = 0;
     nRED75 = 0;
     nREDIS = 0;
     nRETRIB = 0;
     aEXENTOS = "";
     nCUOTA = 0;
     nTIPO = 0;
     nLIMITE = 0;
     nANUALIDADES = 0;
     nCONTRATO = 0;
     nIMPORTE = 0;
     nEDADAS = 0;
     nASISAS = 0;
     nCONYUGE = 0;
     nMINDES = 0;
     aSITUFAM = "";
     nBASE1 = 0;
     nBASE2 = 0;
     nCUOTA1 = 0;
     nCUOTA2 = 0;
     nBASEA = 0;
     aBASEA = "";
     nTIPOA = 0;
     nRETENIDO = 0;
     nPERCIBIDO = 0;
     nAdopcion = 0;
     nREDDESC = 0;
     nREDASC = 0;
     nRETRIBa   = 0;
     nIMPORTEA  = 0;
     aREVISAR   = "N";
     nINCREIMPORTE = 0;
     nINCREBASE = 0;

     &aFecha = "";
     &p_mes = "";
     &aDia = "";
     &aAnyo = "";

     &nRete1_PA = 0;
     &nRete2_PA = 0;
     &nRete3_PA = 0;

     nCuot = 0;
     nBase = 0;
     nRete = 0;

     aClave = "";
     aDSubClave = "";
     aHSubClave = "";
     aEspe = "";
     nElAnyIRPFAnt = 0;
     aCeuMelTemp = "";
     &swTipoMedio = 0;
     &swAvisaMedio = 0;
     swEl190 = 0;
     &nTIPOEst = 0;
     nElCodigo = 0;

     aFechaBaja = "";
     nCausaBaja = 0;
     aMesBaja = "";
     aAnyBaja = "";
     nMesBaja = 0;
     nAnyBaja = 0;
     aFechaAlta = "";
     aMesAlta = "";
     aAnyAlta = "";
     nMesAlta = 0;
     nAnyAlta = 0;
     nElTopAnt = 0;
     nBaseFiniq = 0;
     nRetenFiniq = 0;
     &swFiniq = 0;
     &swMesBaja = 0;
     &nBaseEste2 = 0;
     &nRetenEste2 = 0;
     &eaVengoDe = "";
     &nJorAgr = 0;
     nREDCOPA = 0;

     nAnuHijos = 0;
     nAnuConyu = 0;
     nAutGastos = 0;
     nEmpr999 = 0;
     nTrab999 = 0;

     nDesdeMes = 0;
     nHastaMes = 0;
     nMesPago = 0;
     &nPP201 = 0; &nPP202 = 0; &nPP203 = 0; &nPP204 = 0;
     &nPP205 = 0; &nPP206 = 0; &nPP207 = 0; &nPP208 = 0;
     nUniPP201 = 0; nUniPP202 = 0; nUniPP203 = 0; nUniPP204 = 0;
     nUniPP205 = 0; nUniPP206 = 0; nUniPP207 = 0; nUniPP208 = 0;

    aAlfa    = "";
    aLong    = "";

    nInd     = 0;
    nLong    = 0;
    nCalc    = 0;
    nHayComa = 0;
    nPos     = 0;
    SwSalir  = 0;
     &aDatosSN = "";
     nMINDESG = 0;
     nMINDES3 = 0;
     nRED20 = 0;
     nRNTREDU = 0;
     nMINCON = 0;
     nMINAS = 0;
     nMINDISC = 0;
     nMDISDEAS = 0;
     nMINDIS = 0;
     nMINPERFA = 0;
     nMISDIS = 0;
     nCUOTA1_1 = 0;
     nCUOTA1_2 = 0;
     nDIFERENCIA = 0;
     nMINPERFAA = 0;
     nINCREBASEMIN = 0;

     nDiaBaja = 0;
     aDiaBaja = "";
     nDiaAlta = 0;
     aDiaAlta = "";
     swHayFiniq = 0;
     nCampoPT = 0;
     &nBaseHist = 0;
     &nSSHist = 0;
     &nGasto1 = 0;
     &nGasto3 = 0;
     &nGasto4 = 0;
     swPagaImpresa = 0;
     &swPerComp = 0;
     nAcumOtros = 0;     || acumulado bases otros trabajadores
     nAcumOtrosSS = 0;   || acumulado S.S. otros trabajadores
     &nRetEstAnu = 0;    || rentencion estimada anual

     nTIPOPREVIO = 0;
     nTIPOPREVIOR = 0;
     nTIPOPREVIOCM = 0;
     nTIPOPREVIOCMR = 0;
     nIMPORTEPREVIO = 0;
     nTIPOREG = 0;
     nDIFERENCIAPOSITIVA = 0;
     swSegSem = 0;
     &swCalPagas = "";
     nMINOPAGOa = 0;
     nMINOPAGOb = 0;
     nMINOPAGO = 0;
     nCAUSA = 0;
     aMINORADO = "";               || para el algoritmo de 2010 o 2009
                                   || O 2012
     aPRESVIV = "";                || para el algoritmo de 2010 o 2009

     aMINORADO1 = "";    || 2011
     aMINORADO2 = "";    || 2010 o anterior
     aPRESVIV1 = "";
     aPRESVIV2 = "";
     nNume = 0;
     nCampo012 = 0;
     nMes012 = 0;
     nTipo012 = 0;
     nImporte012 = 0;
     concepto = 0;
     swNo = 0;
     nUnidPaga = 0;
     swLocalizado = 0;
     nMesBusca = 0;
     nCAUSA2 = 0;
     nIMPORTEGuarda = 0;
     nRETRIBGuarda = 0;
     nGASTOSGuarda = 0;
     nGASTOSa = 0;
     nGASTOS = 0;
     nIRREGULAR1 = 0;
     nIRREGULAR2 = 0;
     &fCFecha = @;
     &aCError = "";
     &nCConst = 0;
     nCAUSAa = 0;
     aPRESVIVa = "";
     aPRESVIV1a = "";
     aPRESVIV2a = "";
     FEstado = 0;
     aNif = "";
     nCAUSAGuarda = 0;
     swExiste013 = 0;
     swCambio013 = 0;
     nUltimoMes013 = 0;
     nCampo = 0;
     FEstado15 = 0;
     nDEDUCCION = 0;
     &nCuotaMin = 0;
     &nCuotaMax = 0;
     &nVivienda = 0;
     &swVivienda = 0;
     &swVuelta = 0;
     swDesdeMenu = 0;
     swSigue = 0;
     nDedVivTra = 0;
     nDedVivGen = 0;
     nDedViv = 0;
     &eaVarDni  = "";
     &enCalcCif = 0;
     modo = 0;
     alfa1 = "";
     aPRESVIV1Guarda = "";
     aPRESVIV2Guarda = "";
     &eaProcedencia = "";
     swHijos = 0;
     nPan = 0;
     &nTipoRel = 0;
     &eaVivienda1 = "";       || vienen del nomesfin
     &eaVivienda2 = "";
     nMes2012 = 0;
     nMes2015 = 0;
     swSI = 0;
     nLimiteRet1 = 0;
     nLimiteRet2 = 0;
     nLimiteRet3 = 0;
     nLimiteRet4 = 0;
     mesnum = 0;
     anynum = 0;
     nDias = 0;
     topemes = 0;
     nDesdeMesReal = 0;
     nHastaMesReal = 0;
     nDiasDivide = 0;
     nTramo = 0;
     nDiasPago = 0;
     nGuardaUnidPaga = 0;
     swPosibleIT = 0;

     nImpAju = 0;
     nProrAju = 0;
     nCampoAju = 0;
     nCampoImpAju = 0;

     &enBoton = 0;
     nOpcion = 0;
     swBotonSiNo = 0;
     nCampo2 = 0;
     nCuotaAuto = 0;

     nTotal = 0;
     nume1 = 0; nume2 = 0; nume3 = 0; nume4 = 0; nume5 = 0; nume6 = 0;
     &swOtraMensual = 0;
     swBuscoOtra = 0;
     aFabre = "";
     aDef = "";
     nAnysAdop = 0;
     nMINOPAGO_TODO = 0;

     aMOVIL = "";
     nGASTOSGEN = 0;
     nCAMBIORESI = 0;
     nINCREGASMOVIL = 0;
     nINCREGASDISTRA = 0;
     nOTROSGASTOS = 0;
     nCOTIZACIONES = 0;
     nIMPORTEREG = 0;

     swNoExistia = 1;
     nRedCeuMel = 0;
     swCambio2018 = 1;

     &eaNom = "";
     &eaApel1 = "";
     &eaApel2 = "";
     &aCadena = "";
|FIN;
____________________________________/ CALCULOS DESDE CAMPOS
|PROCESO Tipo88nomir001; |TIPO 88;
     |HAZ LeeEURODB;
|FPRC;

|PROCESO Defecto; |TIPO 7;
     fFech1 = ~;
     aAlfa1 = fFech1;
     aAlfa1 = aAlfa1 % -104;
     #0Campo = aAlfa1;
     |PINTA #0Campo;
|FPRC;

|PROCESO SoloConsulta0; |TIPO 7;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 4;
          aAlfa1 = "S";
     |SINO;
          aAlfa1 = "N";
     |FINSI;
     |C_M #0#1, 1, aAlfa1;
|FPRC;

|PROCESO LetraNif0; |TIPO 0;
     eaVarDni  = #0Campo;
     enCalcCif = 0;
     |HAZ CalculoDNI;
     |SI Campo = 26;
          eaVarDni = (eaVarDni + "               ") % 115;
     |SINO;
          eaVarDni = (eaVarDni + "             ") % 112;
     |FINSI;
     |SI #0Campo ! eaVarDni;
         |CONFI "0000SEl Nif puede ser Erroneo. Desea Calcularlo.";
         |SI FSalida = 0;
             #0Campo = eaVarDni;  |PINTA #0Campo;
             |ERROR;
             |ACABA;
         |FINSI;
     |FINSI;

     modo = (FEntrada / 100) ! 0;
     alfa1 = #0Campo;
     |QBT alfa1;

     |SI alfa1 = ""; |Y modo ! 4;
         |MENAV "    AVISO !!! Trabajador sin D.N.I. ...";
         |ERROR;
     |FINSI;
/*
     NifLetra = #0Campo;
     |HAZ LetraNif;
     #0Campo = NifLetra;
     |PINTA #0Campo;
*/
|FPRC;

|PROCESO LetraNif;
        aAlfa1 = NifLetra;          || recoge valor en variable trabajo
    |QBT aAlfa1;                    || le quita los espacios en blanco
        x = aAlfa1 % 101;           || carga primer caracter
        x = x > x;
    |SI x ] "0";|Y x [ "9";
            final = "";                 || inicializa variable de trabajo
            aAlfa2 = aAlfa1 % 0;        || halla la longitud en caracteres
            nNume1 = aAlfa2;            || recoge valor en variable numerica
        |PARA nNume2 = 1; |SI nNume2 [ nNume1; |HACIENDO nNume2 = nNume2 + 1;
                lugar = (nNume2 * 100) + 1;       || construye literal
                aAlfa2 = aAlfa1 % lugar;          || despreciando puntos, etc.
            |SI aAlfa2="0";|O aAlfa2="1";|O aAlfa2="2";|O aAlfa2="3";
                           |O aAlfa2="4";|O aAlfa2="5";|O aAlfa2="6";
                           |O aAlfa2="7";|O aAlfa2="8";|O aAlfa2="9";
                    final = final + aAlfa2;
            |FINSI;
        |SIGUE;
            nifnum = final;
        |SI nifnum ! 0; |Y final ! "";
                resto = nifnum $ 23;       || halla el resto
                resto = resto + 1;         || le suma uno para no operar con cero
                lugar = (resto * 100) + 1; || halla la posicion en el literal
                letra = letrasnif % lugar; || saca la letra segun posicion
                NifLetra = final + letra;  || recoge en variable Campo
        |FINSI;
    |FINSI;
|FPRC;

|PROCESO Buscalo0; |TIPO 0;
     nInkey = FSalida;
     nModo = (FEntrada / 100) ! 0;

     |SI nInkey = 10;
          |ABRE #2;
          |PUSHV 0501 2380;
          |PINPA #0#2;
          |PTEC 820;
          |CONSULTA #1#2;
          |SI FSalida = 0;
               #0#0 = #2#7;
               #0#1 = #2#2;
               #0#3 = #2#0;
          |FINSI;
          |POPV;
          |CIERRA #2;
          |PINTA #0#0;
          |PINTA #0#1;
          |PINTA #0#3;
     |SINO;
          |SI nModo = 1;
               aAlfa1 = #0#1;
               |ABRE #2;
               |SELECT #2#2;
               #2#7 = #0#0;
               |LEE 000#2=;
               |SI FSalida = 0;
                    #0#1 = #2#2;
                    #0#3 = #2#0;
                    |PINTA #0#1;
                    |PINTA #0#3;
               |SINO;
                    |MENAV "    NIF inexistente en trabajadores ...";
                    |ERROR;
               |FINSI;
               |CIERRA #2;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Tipo2; |TIPO 2;
     nModo = (FEntrada / 100) ! 0;
     |SI nModo = 3;
          |ABRE #102;
          #102#0 = #0#0;
          #102#40= #0#2;
          #102#41= #0#3;
          |LEE 101#102=;
          |SI FSalida = 0;
               |BORRA 020#102a;
          |FINSI;
          |LIBERA #102;
          |CIERRA #102;

          |ABRE #104;
          #104#0 = #0#0;
          #104#1 = #0#2;
          #104#44= #0#3;
          |LEE 101#104=;
          |SI FSalida = 0;
               |BORRA 020#104a;
          |FINSI;
          |LIBERA #104;
          |CIERRA #104;
     |FINSI;
|FPRC;

|PROCESO re_nomir001_1;
     #102#0 = #0#0;
     #102#40 = #0#2;
     #102#41 = 0;
     |LEE 101#102=;
     |SI FSalida = 0;
          |BORRA 020#102a;
          #102#41 = #0#3;
          |GRABA 020#102n;
     |FINSI;
     |LIBERA #102;

     #104#0 = #0#0;
     #104#1 = #0#2;
     #104#44 = 0;
     |LEE 101#104=;
     |SI FSalida = 0;
          |BORRA 020#104a;
          #104#44 = #0#3;
          |GRABA 020#104n;
     |FINSI;
     |LIBERA #104;
|FPRC;

|DEFBUCLE re_nomir001;
     #0#1;
     ;
     "            ", 1900,     0;
     "zzzzzzzzzzzz", 2999, 99999;
     be;
     NULL, re_nomir001_1;
|FIN;

|PROCESO Tipo8; |TIPO 8;
     |ABRE #999;
     |LEE 000#999p;
     |SI FSalida ! 0;
          |ATRI P;
          |MENSA "    Reestructurando ficheros ... Espere por favor ...";
          |ATRI 0;
          #999#0 = ~;
          |GRABA 020#999n;
          |ABRE #102;
          |ABRE #104;
          |BUCLE re_nomir001;
          |CIERRA #102;
          |CIERRA #104;
          |BLIN 4;
     |FINSI;
     |CIERRA #999;
|FPRC;
____________________________________/ GESTION DEL MENU
|PROCESO Gastos_001;
     |MENAV "    Ahora la pantalla";
|FPRC;

|PROCESO nomauto2_001;
     |PARA nCampo = 3; |SI nCampo [ 26; |HACIENDO nCampo = nCampo + 2;
          nCampo2 = nCampo + 1;
          nCuotaAuto = nCuotaAuto + #nomauto2#nCampo2#;
     |SIGUE;
|FPRC;

|DEFBUCLE nomauto2_001;
     #nomauto2#1;
     ;
     #labtraba#0, #labtraba#1, #nomir001#2;
     #labtraba#0, #labtraba#1, #nomir001#2;
     ;
     NULL, nomauto2_001;
|FIN;

|PROCESO labtraba_001;
     |SI #0#2 ] 2013;
          |SI #labtraba#42 = "H"; |Y #labtraba#44 = "A";
               |CAMPO_MODIFICA #nomir020#2, 1, "N";
               |CAMPO_VISUAL #nomir020#2, 1, "S";
               |PINTA 1803, "Gastos deducibles (Art. 19.2: Seg. Social) ->                    :          ";
               |CONTROL_SIMPLE 0, "BOTON,Pulse para introducir gastos", 1849, 1867, Gastos_001;
               enBoton = FSalida;
               |ESTADO_CONTROL enBoton, "DISABLE";

               nCuotaAuto = 0;
               |BUCLE nomauto2_001;
               #nomir020#2 = nCuotaAuto;

               |PINTA #nomir020#2;
               |ERROR10;
          |FINSI;
     |SINO;
          |SI #labtraba#42 = "H"; |Y #labtraba#44 = "A";
               |CAMPO_MODIFICA #nomir020#2, 1, "S";
               |CAMPO_VISUAL #nomir020#2, 1, "S";
               |PINTA 1803, "Gastos deducibles (Art. 19.2: Seg. Social, mutualidades, etc.) ..:          ";
               |PINTA #nomir020#2;
               |ERROR10;
          |FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE labtraba_001;
     #labtraba#2;
     ;
     #nomir001#0;
     #nomir001#0;
     ;
     NULL, labtraba_001;
|FIN;

|PROCESO Autonomos_001; |TIPO 7;
     |CAMPO_MODIFICA #nomir020#2, 1, "N";
     |CAMPO_VISUAL #nomir020#2, 1, "N";
     |PINTA 1868, "            ";
     |BUCLE labtraba_001;
|FPRC;

|PROCESO Anualidades;
     |PUSHV 14012380;
     |DDEFECTO #nomir020;

     |DDEFECTO #102;
     |ABRE #102;
     #102#0 = #0#0;
     #102#40= #0#2;
     #102#41= #0#3;
     |LEE 101#102=;
     FEstado = FSalida;
     |SI FEstado = 0;
          #nomir020#0 = #102#10;
          #nomir020#1 = #102#127;
          #nomir020#2 = #102#11;
          #nomir020#3 = #102#12;
          #nomir020#4 = #102#13;
     |FINSI;

     |PINPA #0#nomir020;
     |PINDA #0#nomir020;

     nModo = (FEntrada / 100) ! 0;
     |SI nModo ! 4;
          |ENDATOS #1#nomir020;
     |SINO;
          |HAZ Autonomos_001;
          |PAUSA;
     |FINSI;

     |SI nModo ! 4; |Y FSalida = 0;
          #102#10 = #nomir020#0;
          #102#127 = #nomir020#1;
          #102#11 = #nomir020#2;
          #102#12 = #nomir020#3;
          #102#13 = #nomir020#4;
          |SI FEstado = 0;
               |GRABA 020#102a;
               |LIBERA #102;
          |SINO;
               |GRABA 020#102n;
               |LIBERA #102;
          |FINSI;
     |FINSI;

     |ESTADO_CONTROL enBoton, "HIDE";
     |CIERRA #102;
     |POPV;
|FPRC;

|PROCESO BorraWin;
     |PARA nPara1 = 14; |SI nPara1 [ 23; |HACIENDO nPara1 = nPara1 + 1;
          |BLIN nPara1;
     |SIGUE;
|FPRC;

|PROCESO RePinta;
     nSwRepinta = 1;
     |PINPA #0#0;
     |PINDA #0#0;
     nSwRepinta = 0;
|FPRC;

|PROCESO ElMenu;
     aAlfa1 = #0#0;
     |QBF aAlfa1;
     |SI aAlfa1 = "";    |ACABA;   |FINSI;

     nElAnyIRPF = #0#2;
     nModo = (FEntrada / 100) ! 0;
     swDesdeMenu = nModo;
     |SI nModo ! 3;|Y nModo ! 0;
          nModoExt = nModo;
          |HAZ RePinta;
          |PARA; |SI; |HACIENDO;
               |MENUG pMenu;
               |SI FSalida > 0;
                    pMenu2 = FSalida;
                    ||HAZ BorraWin;
                    /*
                    |SI FSalida = 1;  |HAZ Punto01;    |FINSI;
                    |SI FSalida = 2;  |HAZ Punto02;    |FINSI;
                    |SI FSalida = 3;  |HAZ Punto03;    |FINSI;
                    |SI FSalida = 4;  |HAZ Punto04;    |FINSI;
                    |SI FSalida = 5;  |HAZ Punto05;    |FINSI;
                    |SI FSalida = 6;  |HAZ Punto06;    |FINSI;
                    */
                    |SI FSalida = 1;
                         |HAZ Punto01;  || Datos familiares
                    |FINSI;
                    |SI FSalida = 2;
                         |HAZ Punto03;  || emitir comunicacion
                    |FINSI;
                    |SI FSalida = 3;
                         |HAZ Punto04;  || configurar parametros
                    |FINSI;
                    |SI FSalida = 4;
                         |HAZ Anualidades;  || configurar parametros
                    |FINSI;
                    |SI FSalida = 5;
                         |HAZ Punto05;  || presentar resultados
                    |FINSI;
               |SINO;
                    |SAL;
               |FINSI;
               |HAZ RePinta;
          |SIGUE;
          |HAZ RePinta;
     |FINSI;
|FPRC;

|PROCESO Tipo13; |TIPO 13;
     |SI nSwRepinta = 0;
          |HAZ ElMenu;
     |FINSI;
|FPRC;

|PROCESO Tipo30; |TIPO 30;
     |HAZ ElMenu;
|FPRC;
____________________________________/ PUNTO 01 (Asignar Codigo)
|PROCESO GrabaFechas101; |TIPO 0;
     fFech1 = Contenido; nNume1 = fFech1;
                         nNume2 = #101Campo;
     |SI nNume1 ! nNume2;
          |DDEFECTO #106;
          |ABRE #106;
          #106#0 = #101#1;
          #106#1 = #101#2;
          |LEE 101#106=;
          nEstado = FSalida;

          |SI Campo = 4; #106#2 = #101Campo; |FINSI;   || fecha alta
          |SI Campo = 5; #106#3 = #101Campo; |FINSI;   || fecha baja

          |SI nEstado = 0;    |GRABA 020#106a;    |FINSI;
          |SI nEstado ! 0;    |GRABA 020#106n;    |FINSI;
          |LIBERA #106;
          |CIERRA #106;
     |FINSI;
|FPRC;

|PROCESO Guarda105;
     |ABRE #nomir015;

     #nomir015#44 = #nomir005#44;
     #nomir015#0 = #nomir005#0;
     #nomir015#1 = #nomir005#1;
     #nomir015#75 = nElMesIRPF;
     |LEE 000#nomir015.=;
     FEstado15 = FSalida;

     |PARA nCampo = 0; |SI nCampo [ 74; |HACIENDO nCampo = nCampo + 1;
          #nomir015#nCampo# = #nomir005#nCampo#;
     |SIGUE;
     #nomir015#75 = nElMesIRPF;
     #nomir015#76 = #nomir005#75;
     #nomir015#77 = #nomir005#76;
     #nomir015#78 = #nomir005#77;

     |SI FEstado15 = 0;
          |GRABA 020#nomir015.a;
     |SINO;
          |GRABA 020#nomir015.n;
     |FINSI;

     |LIBERA #nomir015;

     |CIERRA #nomir015;
|FPRC;

|PROCESO CambioParam;
     || este proceso sirve para mantener el nomir013, en este fichero me
     || guardo los datos personales del trabajador por periodo
     || La primera vez en el a¤o que se calcula y luego cuando cambian
     || si es que lo hacen

     |ABRE #nomir013;
     swExiste013 = 0;
     swCambio013 = 0;
     nUltimoMes013 = 0;

     |PARA nMesBusca = nElMesIRPF; |SI nMesBusca ] 1; |HACIENDO nMesBusca = nMesBusca - 1;
          #nomir013#0 = #0#0;           || NIF
          #nomir013#41 = #0#3;          || Empresa
          #nomir013#40 = #0#2;          || A¤o
          #nomir013#120 = nMesBusca;    || Mes
          |LEE 000#nomir013.=;
          |SI FSalida = 0;
               swExiste013 = 1;
               |SAL;
          |FINSI;
     |SIGUE;

     |SI swExiste013 = 0;     || no existe ninguno
          |PARA nCampo = 0; |SI nCampo [ 128; |HACIENDO nCampo = nCampo + 1;
               #nomir013#nCampo# = #nomir003#nCampo#;
          |SIGUE;
          #nomir013#120 = nElMesIRPF;
          |GRABA 020#nomir013.n;
          |LIBERA #nomir013;
     |SINO;
          |PARA nCampo = 0; |SI nCampo [ 128; |HACIENDO nCampo = nCampo + 1;
               |SI nCampo ! 9; |Y nCampo ! 11;
               |Y nCampo ! 15; |Y nCampo ! 16; |Y nCampo ! 17;
               |Y nCampo ! 18; |Y nCampo ! 19;
               |Y nCampo ! 115; |Y nCampo ! 116; |Y nCampo ! 117;
               |Y nCampo ! 118; |Y nCampo ! 120; |Y nCampo ! 122;
               |Y nCampo ! 123; |Y nCampo ! 125; |Y nCampo ! 128;
                    |SI #nomir013#nCampo# ! #nomir003#nCampo#;
                         swCambio013 = 1;
                    |FINSI;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI swCambio013 = 1;
          |PARA nCampo = 0; |SI nCampo [ 128; |HACIENDO nCampo = nCampo + 1;
               #nomir013#nCampo# = #nomir003#nCampo#;
          |SIGUE;
          #nomir013#120 = nElMesIRPF;
          |SI nElMesIRPF = nMesBusca;
               || este mismo mes ha habido cambio, y no es el primero
               |GRABA 020#nomir013.a;
          |SINO;
               || lo normal, se detecta cambio este mes por primera vez
               |GRABA 020#nomir013.n;
          |FINSI;
     |FINSI;

     |CIERRA #nomir013;
|FPRC;

|PROCESO Mes2012;
     nMes2012 = 0;
     |SI nElAnyIRPF = 2012;
          |SI nElMesIRPF = 1;
               nMes2012 = 1;
          |SINO;
               nMes2012 = nElMesIRPF;
          |FINSI;
     |FINSI;
     |SI nElAnyIRPF ] 2013;        || a partir de 2013, dejo la variable a 13
          nMes2012 = 13;           || asi cogera siempre el calculo del a¤o
     |FINSI;
|FPRC;

|PROCESO Mes2015;
     nMes2015 = 0;
     |SI nElAnyIRPF = 2015;
          nMes2015 = nElMesIRPF;
     |FINSI;
     |SI nDiferencias = 1;
          nMes2015 = 12;
     |FINSI;
|FPRC;

|PROCESO GrabaParametros;
     nAnuHijos = 0;
     nAnuConyu = 0;
     nAutGastos = 0;
     swNoExistia = 0;

     |ABRE #2;           || para buscar si es autonomo
     #2#0 = #0#3;
     #2#1 = #0#4;
     |LEE 000#2=;
     |CIERRA #2;

     aCeuMelTemp = #102#14;
     |DDEFECTO #102;
     |ABRE #102;
     #102#0 = #0#0;
     #102#40= #0#2;
     #102#41= #0#3;
     |LEE 040#102=;
     |SI FSalida ! 0;
         |CIERRA #2;
         swNoExistia = 1;
         eaNif     = #0#0;
         enEmpresa = #0#3;
         enAnyo    = #0#2;
         enModoNif = -1;
         eaProcedencia = "regularizacion";
         |SUB_EJECUTA_NP ":basica/agidanif";
     |SINO;
          |SI #2#42 = "H"; |Y nAutGastos = 0;
               nAutGastos = #102#11;
          |FINSI;
          nAnuHijos = #102#12;
          nAnuConyu = #102#13;
     |FINSI;

     || pues a partir del 2012 (3923.533) no se cogen estos importes
     || del ejercicio anterior si estan a cero, los tienen que meter
     || los clientes a mano a principio de a¤o

     #102#0  = #0#0;          || busco a¤o anterior para pensiones
     #102#40 = #0#2 - 1;      || por alimentos mujer o hijos
     #102#41 = #0#3;
     |LEE 101#102=;
     |SI FSalida = 0;
          || A partir de 2015 para Anualidades por Alimentos o Hijos
          || en la gestion que se crea automaticamente el primer mes de calculo
          || y se copian los importes del a¤o anterior, hasta ahi bien

          || Pero si los importes estan ya creados a CERO, se quedan a CERO
          || la variable swNoExistia la pongo a 1 si he tenido que irme a
          || buscar a la gestion los datos
          || 000098.03614

          |SI swNoExistia = 1;
               |SI nAnuHijos = 0;
                    nAnuHijos = #102#12;
               |FINSI;
               |SI nAnuConyu = 0;
                    nAnuConyu = #102#13;
               |FINSI;
          |FINSI;
/*
     || pues a partir del 2012 (3923.533) no se cogen estos importes
     || del ejercicio anterior si estan a cero, los tienen que meter
     || los clientes a mano a principio de a¤o

          |SI #2#42 = "H"; |Y nAutGastos = 0;
               nAutGastos = #102#11;
          |FINSI;
*/
     |FINSI;

     #102#0  = #0#0;
     #102#40 = #0#2;
     #102#41 = #0#3;
     |LEE 101#102=;
     |SI FSalida = 0;
          |SI #102#1 = 0;
               || edad igual a cero !!!!
               || lo normal es que no haya ficha en el agidanif, entonces
               || se crea la ficha por defecto, con la edad igual a cero
               || al no encontrarla en la ficha del agidanif, esto no es
               || correcto 24.01.2020

               aAlfa = #labtraba#11;
               |QBF aAlfa;
               |SI aAlfa ! "";
                    aAlfa = aAlfa % -104;
                    nNume = aAlfa;
                    nNume = #0#2 - nNume;
                    #102#1 = nNume;
               |FINSI;
          |FINSI;
          #102#9  = #103#2;        || ingresos anuales estimados
         #102#11 = #103#3;        || seguridad social
         #102#16 = #103#0;        || acumulado bases
         #102#17 = #103#1;        || acumulado cuota
         |SI #102#16 ! 0;|O #102#17 ! 0;
             #102#15 = "S";      || regularizacion SI
         |SINO;
             || #102#14 = "N";      || ingresos Ceuta y Melilla
             || #102#14 = aCeuMelTemp;
             #102#15 = "N";      || regularizacion NO
         |FINSI;
         |SI #102#15 = "S"; |Y #102#18 = 0;
              #102#18 = #102#9;   || ingresos anuales iniciales
         |FINSI;

          |SI nAnuHijos ! 0; |Y #102#12 = 0;
               #102#12 = nAnuHijos;
          |FINSI;
          |SI nAnuConyu ! 0; |Y #102#13 = 0;
               #102#13 = nAnuConyu;
          |FINSI;
/*
          || ya tienen que venir a cero, pero por si acaso comento

          |SI nAutGastos ! 0; |Y #102#11 = 0; |Y #2#42 = "H";
               #102#11 = nAutGastos;
          |FINSI;
*/
          #102#5 = #labtraba#111;
          #102#121 = #labtraba#130;
          |GRABA 020#102a;
          |LIBERA #102;
     |FINSI;
     |CIERRA #102;
|FPRC;

|PROCESO Acumulados;
     #103#2 = #103#0;
     #103#3 = nAcumSS;

     #103#0 = 0;
     #103#1 = 0;
     nAcumSS = 0;

     |ATRI R;
     |PINTA 1669, #103#0;
     |PINTA 1869, #103#1;
     |PINTA 2269, #103#2;
     |ATRI 0;
|FPRC;

|PROCESO Estimacion;
     |DDEFECTO #nomir009;
     |ABRE #nomir009;
     #nomir009#0 = #0#3;
     |LEE 000#nomir009.=;
     |CIERRA #nomir009;

     nCalculo99 = 1;
     nEmpr99 = #101#1;
     nTrab99 = #101#2;
     nAnyo99 = #0#2;
     nSwMes99 = #nomir009#14;
     aFeAlta = #101#4;
     aFeBaja = #101#5;
     E_inf = 0;
     E_sup = 12;
     |MENSA "2400Mes para variaciones (0-12): ";
     nMes99 = 2454 ? 1;
     |SI FSalida = 0;
          |SUB_EJECUTA "nomcalir";
          #103#2 = nEstima;
          #103#3 = nSeguri;
          |ATRI R;
          |PINTA 2269, #103#2;
          |ATRI 0;
     |SINO;
          |MENAV "    Estimacion cancelada ...";
     |FINSI;
     |BLIN 24;
|FPRC;

|PROCESO Consulta101;
     |PUSHV 0501 2380;
     |ABRE #2;
     |PINPA #0#2;
     #2#0 = #101#1;
     #2#1 = #101#2;
     |PTEC 802;
     |PTEC 802;
     |CONSULTA #0#2;
     |CIERRA #2;
     |POPV;
|FPRC;

|PROCESO Asigna101;
     |SI nModoExt ! 1;|Y nModoExt ! 2;
          |MENAV "    Opcion activa unicamente en Alta o Modificacion ...";
     |SINO;
          |SI #101#3 = "B";
               |MENAV "    Este trabajador esta en situacion de BAJA ...";
               |ERROR;
          |SINO;
               |AVISO;
               ||CAMPO_ATRIBUTO #0#3, S, 0, 0;
               ||CAMPO_ATRIBUTO #0#4, S, 0, 0;
               nCodEmpr = #101#1;  #0#3 = nCodEmpr;    |PINTA #0#3;
               nCodTrab = #101#2;  #0#4 = nCodTrab;    |PINTA #0#4;
               |SI nInkey = 9;
                    eaVengoDe = "nomir002";
                    |HAZ Estimacion;    || elegir estimando ingresos
               |FINSI;
               |SI nInkey = 11;
                    |HAZ Acumulados;    || elegir cogiendo lo acumulado
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Pulsa101; |TIPO 11;
     nInkey = FSalida;

     |SI nInkey = 9;|O nInkey = 11;
          |HAZ Asigna101;
     |FINSI;
     |SI nInkey = 10;
          |HAZ Consulta101;
     |FINSI;
|FPRC;

|PROCESO Min101;
     #101#0 = 1;
|FPRC;

|PROCESO Max101;
     #101#0 = nLinea;
|FPRC;

|PROCESO nomcalca_3;
     |DDEFECTO #8;
     #8#0 = #2#87;
     #8#2 = #7#4;
     |LEE 000#8=;

     nAcumBases = nAcumBases + ((#7#11 * #7#10) ! EURODB);
     |SI #8#8 = 1;  nAcumCuota = nAcumCuota + (nAcumBases % #4#13);   |FINSI;
     |SI #8#8 = 2;  nAcumCuota = nAcumCuota + (nAcumBases % #4#67);   |FINSI;
     |SI #8#8 = 3;  nAcumCuota = nAcumCuota + (nAcumBases % #4#68);   |FINSI;
|FPRC;

|PROCESO nomcalca_2;
     |SI #7#4 ] 101;|Y #7#4 [ 199; |HAZ nomcalca_3;    |FINSI;
     |SI #7#4 ] 400;|Y #7#4 [ 410; |HAZ nomcalca_3;    |FINSI;
|FPRC;

|PROCESO nomcalca_1;
     |SI nElAnyIRPF ! #4#184; || no es lo normal, pero para estimar el a¤o
          |ACABA;             || no te traigas fichas de otros a¤o que no
     |FINSI;                  || sean el del calculo

     nSwMes = 1;

     #101#7 = #101#7 + (#4#14 + #4#69 + #4#70 + #4#16);     || bases
     #101#8 = #101#8 + (#4#15 + #4#71 + #4#72 + #4#17);     || cuota

     nAcumSS = nAcumSS + (#4#48 + #4#49 + #4#50 + #4#51);   || seg.social
     #101#9 = #101#9 + (#4#48 + #4#49 + #4#50 + #4#51);     || seg.social
|FPRC;

|DEFBUCLE nomcalca;
 #4#1;
 ;
 #2#0, #2#1, nMes, 0;
 #2#0, #2#1, nMes, 9;
 ;
 NULL, nomcalca_1;
|FIN;

|PROCESO nomhicca_3;
     |DDEFECTO #8;
     #8#0 = #2#87;
     #8#2 = #6#4;
     |LEE 000#8=;

     nAcumBases = nAcumBases + ((#6#11 * #6#10) ! EURODB);
     |SI #8#8 = 1;  nAcumCuota = nAcumCuota + (nAcumBases % #3#13);   |FINSI;
     |SI #8#8 = 2;  nAcumCuota = nAcumCuota + (nAcumBases % #3#106);  |FINSI;
     |SI #8#8 = 3;  nAcumCuota = nAcumCuota + (nAcumBases % #3#107);  |FINSI;
|FPRC;

|PROCESO nomhicca_2;
     |SI #6#4 ] 101;|Y #6#4 [ 199; |HAZ nomhicca_3;    |FINSI;
     |SI #6#4 ] 400;|Y #6#4 [ 410; |HAZ nomhicca_3;    |FINSI;
|FPRC;

|PROCESO nomhicca_1;
     nSwMes = 1;

     #101#7 = #101#7 + (#3#14 + #3#108 + #3#109 + #3#16);   || bases
     #101#8 = #101#8 + (#3#15 + #3#110 + #3#111 + #3#17);   || cuota

     nAcumSS = nAcumSS + (#3#48 + #3#49 + #3#50 + #3#51);   || seg.social
     #101#9 = #101#9 + (#3#48 + #3#49 + #3#50 + #3#51);       || seg.social

|FPRC;

|DEFBUCLE nomhicca;
 #3#1;
 ;
 #2#0, #2#1, nDosDigitos, nMes,  0;
 #2#0, #2#1, nDosDigitos, nMes, 99;
 ;
 NULL, nomhicca_1;
|FIN;

|DEFBUCLE nomhicca_at;
 #3#1;
 ;
 #2#0, #2#1, nDosDigitos, nNume, 5;
 #2#0, #2#1, nDosDigitos, 12, 20;
 ;
 NULL, nomhicca_1;
|FIN;

|PROCESO FechaBaja;
     aFechaAlta = #2#36;
     aFechaBaja = #2#37;
     |ABRE #nomvarca;
     #nomvarca#0 = #2#0;
     #nomvarca#1 = #2#1;
     #nomvarca#2 = nElMesIRPF;
     #nomvarca#3 = 0;
     |LEE 000#nomvarca.=;
     |SI FSalida = 0;
          aAlfa1 = #nomvarca#16;
          |QBF aAlfa1;
          |SI aAlfa1 ! ""; |Y aAlfa1 ! "..........";
               aFechaBaja = #nomvarca#16;
               nCausaBaja = #nomvarca#46;
          |FINSI;
     |FINSI;
     |QBF aFechaBaja;
     |CIERRA #nomvarca;
|FPRC;

|PROCESO SiBaja;
     nElTopAnt = 0;
     swMesBaja = 0;
     nCausaBaja = 0;

     |HAZ FechaBaja;

     aMesBaja = aFechaBaja % 402;  || mes y el trabajador esta el el historico
     aAnyBaja = aFechaBaja % -104; || (o sea un trabajador duplicado, la pri-
     nMesBaja = aMesBaja;          || mera ficha), tambien tenga en cuenta
     nAnyBaja = aAnyBaja;          || la base y cuota del mes del trab. anterior
     |SI nMesBaja = nElMesIRPF; |Y nAnyBaja = nElAnyIRPF; |Y nMesBaja ! 0; |Y aAnyBaja ! 0;
          nElTopAnt = nElTop; || ha cambiado, me lo guardo para luego
          nElTop = nMesBaja;
          swMesBaja = 1;
          aDiaBaja = aFechaBaja % 102;
          nDiaBaja = aDiaBaja;
     |FINSI;

     || exactamente lo mismo de antes pero para el caso de alta, para que
     || coja la segunda ficha si existe

     aMesAlta = aFechaAlta % 402;
     aAnyAlta = aFechaAlta % -104;
     nMesAlta = aMesAlta;
     nAnyAlta = aAnyAlta;
     |SI nMesAlta = nElMesIRPF; |Y nAnyAlta = nElAnyIRPF; |Y nMesAlta ! 0; |Y aAnyAlta ! 0;
          nElTopAnt = nElTop; || ha cambiado, me lo guardo para luego
          nElTop = nMesAlta;
          || swMesBaja = 1;
          aDiaAlta = aFechaAlta % 102;
          nDiaAlta = aDiaAlta;
     |FINSI;
|FPRC;

|PROCESO FechasGuardadas;
     |SI nElMesIRPF ! 0;     |ACABA;   |FINSI;

     |ABRE #106;
     #106#0 = #101#1;
     #106#1 = #101#2;
     |LEE 101#106=;
     |SI FSalida = 0;
          |CONFI "    SPeriodo de alta modificado. Respetar modificacion S/N: ";
          |SI FSalida = 0;
               fFech1 = #106#2;    nNume1 = fFech1;
               |SI nNume1 > 0;    #101#4 = #106#2;    |FINSI;
               fFech1 = #106#3;    nNume1 = fFech1;
               |SI #106#3 > 0;    #101#5 = #106#3;    |FINSI;
          |SINO;
               |BORRA 020#106a;
          |FINSI;
     |FINSI;
     |LIBERA #106;
     |CIERRA #106;
|FPRC;

|PROCESO RevisaFechas;
     |DDEFECTO #nomir009;
     |ABRE #nomir009;
     #nomir009#0 = #0#3;
     |LEE 000#nomir009.=;
     |CIERRA #nomir009;
     |SI nCausaBaja = 8; |O nCausaBaja = 9; |O nCausaBaja = 10;         || periodo completo
     |O nCausaBaja = 11; |O nCausaBaja = 12;

     ||SI #nomir009#17 = 2; |O #nomir009#17 = 3; |O nCausaBaja = 8; |O nCausaBaja = 9; |O nCausaBaja = 10;         || periodo completo
     || esto fue lo que provoco el desastre del IRPF del 2008, mucho cuidado
           || periodo completo
           aAlfa1 = "31.12." + #0#2;
           #101#5 = aAlfa1;
           swPerComp = 1;
     |SINO;
          nNume1 = #101#4;         || alta
          nNume2 = #101#5;         || baja
          |SI nNume2 < nNume1;
               aAlfa1 = "31.12." + #0#2;
               #101#5 = aAlfa1;
          |FINSI;

          aAlfa1 = #101#5 % -104;
          nNume1 = aAlfa1;
          |SI nNume1 < #0#2;
               aAlfa1 = "31.12." + #0#2;
               #101#5 = aAlfa1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO labtraba_6;
     |DDEFECTO #1;
     #1#0 = #2#0;
     |LEE 000#1=;

     |SI #1#50 = "S";    || empresa desactivada en calculos
          |ACABA;
     |FINSI;

     |SI #labtraba#0 ! #nomir008#0; |Y #nomir009#20 = 2;
     |Y #1#133 = "S";    || es un trabajador de otra empresa que esta de alta
          |ACABA;        || pero tengo desactivado por empresa que en este
     |FINSI;             || caso se tenga en cuenta

     |SI #labtraba#99 = "E"; |O #labtraba#100 = "E"; |O #labtraba#101 = "E";
          || tengo alguna clave "E"

          |SI #labtraba#0 ! #nomir008#0; |O #labtraba#1 ! #nomir008#1;
               || no soy el trabajador que calculo

               || autonomos con clave E tienen un porcentaje fijo de IRPF por esos
               || ingresos, esos NO HAY QUE TENERLOS EN CUENTA para regularizar
               || junto con los de otra ficha con el mismo NIF con clave A que
               || tuviera de alta -  28.01.2015 tiquet 002884.02818

               |ACABA;

          |FINSI;
     |FINSI;

     nLinea = nLinea + 1;
     |DDEFECTO #101;
     #101#0 = nLinea;         || nro.movimiento
     #101#1 = #2#0;           || empresa
     #101#2 = #2#1;           || trabajador
     #101#3 = #2#44;          || situacion A/B
     #101#4 = #2#36;          || fecha alta
     #101#5 = #2#37;          || fecha baja
     |SI #2#37 = ".........."; |O #2#37 = "          ";
          |SI #2#177 = ".........."; |O #2#177 = "          ";
               #5#1 = #101#1;
               #5#2 = #101#2;
               |LEE 000#5=;                  || fecha de baja de contratos
               |SI FSalida = 0;
                    |SI #5#15 = 0;
                         #101#5 = #5#8;
                    |SINO;
                         #101#5 = #5#20;
                    |FINSI;
               |FINSI;
          |SINO;
               #101#5 = #2#177;
          |FINSI;
     |FINSI;

     |HAZ SiBaja;
     swPerComp = 0;
     |HAZ RevisaFechas;
     |HAZ FechasGuardadas;

     #101#6 = #1#2;           || nombre empresa
     |PARA nPara1 = 1; |SI nPara1 [ nElTop; |HACIENDO nPara1 = nPara1 + 1;
          nSwMes = 0;
          nMes = nPara1;
          |BUCLE nomhicca;

          ||SI nSwMes = 0;|Y aPMensual = "S";
          || si no habia nada en el historico y estoy en un trabajador distinto
          || al que he empezado a calcular, busco por si hubiera algo en el
          || nomcalca que tuviera que acumular de trabajador en cuestion
          || por si ha sido este mes baja y alta
          || lo de nElMesIRPF ! 0 para que si lo estoy haciendo manual NO mire
          || en el mensual ... que da problemas y no hace falta

          |SI nSwMes = 0; |Y #labtraba#1 ! #nomir008#1;
          |Y nElMesIRPF ! 0;
               |SI #labtraba#0 = #nomir008#0; |Y #labtraba#1 > #nomir008#1;
                    |SI swPerComp = 1;
                         |BUCLE nomcalca;
                    |FINSI;
               |SINO;
                    |SI #labtraba#0 = #nomir008#0;
                         |BUCLE nomcalca;
                    |FINSI;
               |FINSI;

          /*
               || realmente de esta manera no seria correcto, lo suyo seria
               |SI #labtraba#0 = #nomir008#0; |Y #labtraba#1 > #nomir008#1;
               |Y swPerComp = 1;
                    |BUCLE nomcalca;
               |SINO;
                    |SI #labtraba#0 = #nomir008#0;
                         |BUCLE nomcalca;
                    |FINSI;
               |FINSI;

               || porque asi tendriamos en cuenta los ingresos en el mismo
               || mes de fichas posteriores a la que se calcula, por cambio
               || de ficha, aunque como de lo que realmente se trata es de
               || que entre las dos fichas se retenga la cuota correcta
               || y el problema es en como se reparte ese % entre las dos
               || fichas, por no cambiarlo no vaya a ser que nos carguemos
               || algo, se queda como esta

               || mirar tiquets 4877.693 y 1331.1734, amnos ejemplos
               || de lo mismo: 03.02.2020
          */

          |FINSI;
     |SIGUE;

     nNume = nElTop + 1; || los atrasos desde el historico se consideran
     |BUCLE nomhicca_at; || ACUMULADO, con lo que hay que acumularlos
                         || tambien de los meses que no coge el bucle nomhicca

     |ABRE #nomauto2;           || para buscar si es autonomo
     #nomauto2#0 = #2#0;
     #nomauto2#1 = #2#1;
     #nomauto2#2 = #0#2;
     |LEE 000#nomauto2.=;
     |SI FSalida = 0;
          nAutGastos = nAutGastos + #nomauto2#32;
     |FINSI;
     |CIERRA #nomauto2;

     |GRABA 020#101n;

     |SI nElTopAnt ! 0;
          nElTop = nElTopAnt;      || lo dejo como estaba
     |FINSI;

     #103#0 = #103#0 + #101#7;     || acumulado bases (total)
     #103#1 = #103#1 + #101#8;     || acumulado cuota (total)

     |SI #labtraba#0 ! #nomir008#0; |Y #nomir009#20 = 2;
          || trabajador en empresa distinta, acumulo ya para el total

          || atencion, si el trabajador es alta, es decir un trabajador con
          || dos codigos, el segundo perteneciente a otra empresa, si es alta
          || no acumulo aqui ya que despues, en la estimacion del nomcalir se
          || acumulara
          || Es decir que para el campo de la estimacion de "Contratos Anteriores"
          || solo entraran los que sean baja

          |SI #labtraba#44 = "B";
               nAcumOtros = nAcumOtros + #101#7;     || acumulado bases (total)
               nAcumOtrosSS = nAcumOtrosSS + #101#9; || acumulado Seg.Soc. (total)
          |FINSI;

          #nomir016#0 = #nomir008#0;
          #nomir016#1 = #nomir008#1;
          #nomir016#2 = #labtraba#0;
          #nomir016#3 = #labtraba#1;
          |GRABA 020#nomir016.n;
     |FINSI;

     nSwPagas = 0;
     nPaga12 = 0;

     |SI nElTop = 11;
          swPagaImpresa = 0;
          |ABRE #nomimpre;          || busca si tengo guardada la retenc. de P.Extra
          #nomimpre#0 = nElAnyIRPF;       || a¤o
          #nomimpre#1 = nElMesIRPF;       || mes
          #nomimpre#2 = #labtraba#0;       || empresa
          #nomimpre#3 = #labtraba#1;       || trabajador
          #nomimpre#4 = 0;          || tipo = 0 por defecto
          #nomimpre#5 = "P";        || clase = P (Paga Extra) por defecto
          |LEE 000#nomimpre.=;
          |SI FSalida = 0; |Y swCalPagas = "N";
               swPagaImpresa = 1;
          |FINSI;
          |CIERRA #nomimpre;

          |ABRE #nomcalca;
          #nomcalca#0 = #2#0;
          #nomcalca#1 = #2#1;
          #nomcalca#2 = 12;
          #nomcalca#3 = 0;
          |LEE 000#nomcalca.=;
          |SI FSalida = 0; |Y swPagaImpresa = 1;
               nSwPagas = 1;
               #103#0 = #103#0 + #nomcalca#16;    || acumulado bases (total)
               #103#1 = #103#1 + #nomcalca#17;    || acumulado cuota (total)
               nPaga12 = #nomcalca#16;
          |FINSI;
          |CIERRA #nomcalca;
     |FINSI;
|FPRC;

|PROCESO labtraba_2;
     aAlfa1 = (#2#36 % -104) + (#2#36 % 402) + (#2#36 % 102);
     nNume1 = aAlfa1;
|FPRC;

|DEFBUCLE labtraba_TODO;
     #2#2;
     ;
     #0#0;
     #0#0;
     ;
     NULL, labtraba_2, NULL, NULL, NULL, labtraba_6;
     nNume1, #2#0, #2#1;
|FIN;

|DEFBUCLE labtraba;
     #2#2;
     0;
     #0#0, #0#3;
     #0#0, #0#3;
     ;
     NULL, labtraba_2, NULL, NULL, NULL, labtraba_6;
     nNume1, #2#0, #2#1;
|FIN;

|DEFBUCLE labtraba_sin_TODO;
     #2#2;
     ;
     #0#0;
     #0#0;
     ;
     NULL, labtraba_6;
|FIN;

|DEFBUCLE labtraba_sin;
     #2#2;
     0;
     #0#0, #0#3;
     #0#0, #0#3;
     ;
     NULL, labtraba_6;
|FIN;

|PROCESO Inicia012;
     #nomir012#1 = #2#0;      || Empresa
     #nomir012#2 = #2#1;      || Trabajador
     #nomir012#3 = nElAnyIRPF;      || A¤o
     #nomir012#4 = nElMesIRPF;      || Mes
     |LEE 101#nomir012.=;
     |SI FSalida ! 0;
          |PDEFECTO #nomir012, 5, 101;
          |PDEFECTO #nomir012, 110, 113;
          |GRABA 020#nomir012.b;
     |SINO;
          |PDEFECTO #nomir012, 5, 101;
          |PDEFECTO #nomir012, 100, 113;
     |FINSI;
|FPRC;

|PROCESO Acum012;
     |SI nTipo012 = 0; nCampo012 = nMes012 + 4; |FINSI;
     |SI nTipo012 = 51; nCampo012 = nMes012 + 17; |FINSI;
     |SI nTipo012 = 1; nCampo012 = nMes012 + 30; |FINSI;
     |SI nTipo012 = 2; nCampo012 = nMes012 + 43; |FINSI;
     |SI nTipo012 ] 5; |Y nTipo012 [ 20;
          nCampo012 = nMes012 + 56;
     |FINSI;

     #nomir012#nCampo012# = #nomir012#nCampo012# + nImporte012;
|FPRC;

|PROCESO AcumPagas;
          nBaseEste = nBaseEste + (nUniPP201 * nPP201);
          nBaseEste = nBaseEste + (nUniPP202 * nPP202);
          nBaseEste = nBaseEste + (nUniPP203 * nPP203);
          nBaseEste = nBaseEste + (nUniPP204 * nPP204);
          nBaseEste = nBaseEste + (nUniPP205 * nPP205);
          nBaseEste = nBaseEste + (nUniPP206 * nPP206);
          nBaseEste = nBaseEste + (nUniPP207 * nPP207);
          nBaseEste = nBaseEste + (nUniPP208 * nPP208);

     || Acumula

     |ABRE #nomconca;
     #nomconca#0 = #labtraba#87;
     |LEE 000#nomconca.=;
     |CIERRA #nomconca;

     |PARA concepto = 201; |SI concepto [ 208; |HACIENDO concepto = concepto + 1;
          nNume3 = concepto - 181;     || mes de pago
          nMesPago = #nomconca#nNume3#;
          nNume = 0;
          |SI concepto = 201; nNume = (nUniPP201 * nPP201); |FINSI;
          |SI concepto = 202; nNume = (nUniPP202 * nPP202); |FINSI;
          |SI concepto = 203; nNume = (nUniPP203 * nPP203); |FINSI;
          |SI concepto = 204; nNume = (nUniPP204 * nPP204); |FINSI;
          |SI concepto = 205; nNume = (nUniPP205 * nPP205); |FINSI;
          |SI concepto = 206; nNume = (nUniPP206 * nPP206); |FINSI;
          |SI concepto = 207; nNume = (nUniPP207 * nPP207); |FINSI;
          |SI concepto = 208; nNume = (nUniPP208 * nPP208); |FINSI;

          nCampoPT = concepto - 88;

          |SI nNume ! 0;
               |SI nMesPago ! 99; |Y #labtraba#nCampoPT# ! "S"; |Y nMesPago ! 0;
                    |SI nMesPago ! nElMesIRPF;
                         nImporte012 = nNume;
                         nMes012 = nMesPago;
                         nTipo012 = 51;         || PAGAS
                         |HAZ Acum012;
                    |SINO;
                         nBaseEste = nBaseEste - nNume;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Graba012;
     |HAZ FechaBaja;
     #nomir012#0 = #labtraba#7;
     #nomir012#88 = #labtraba#36;
     #nomir012#89 = aFechaBaja;
     #nomir012#90 = #nomir009#17;
     |GRABA 020#nomir012.a;
     |LIBERA #nomir012;
|FPRC;

|PROCESO Totaliza012;
     nTotal = 0;
     |PARA nume1 = 5; |SI nume1 [ 69; |HACIENDO nume1 = nume1 + 1;
          nTotal = nTotal + #nomir012#nume1#;
          |SI nume1 = 17; #nomir012#nume1# = nTotal; nTotal = 0; |FINSI;
          |SI nume1 = 30; #nomir012#nume1# = nTotal; nTotal = 0; |FINSI;
          |SI nume1 = 43; #nomir012#nume1# = nTotal; nTotal = 0; |FINSI;
          |SI nume1 = 56; #nomir012#nume1# = nTotal; nTotal = 0; |FINSI;
          |SI nume1 = 69; #nomir012#nume1# = nTotal; nTotal = 0; |FINSI;
     |SIGUE;
     #nomir012#82 = #nomir012#17 + #nomir012#30 + #nomir012#43 + #nomir012#56;
     #nomir012#82 = #nomir012#82 + #nomir012#69;
     #nomir012#84 = #nomir012#82;

     |PARA nume1 = 70; |SI nume1 [ 81; |HACIENDO nume1 = nume1 + 1;
          nume2 = nume1 - 65;
          nume3 = nume1 - 52;
          nume4 = nume1 - 39;
          nume5 = nume1 - 26;
          nume6 = nume1 - 13;
          #nomir012#nume1# = #nomir012#nume2# + #nomir012#nume3# + #nomir012#nume4#;
          #nomir012#nume1# = #nomir012#nume1# + #nomir012#nume5# + #nomir012#nume6#;
     |SIGUE;

     #nomir012#83 = 0;
     nume1 = #nomir012#4;
     nume1 = nume1 + 69 - 1;
     |PARA nume2 = 70; |SI nume2 [ nume1; |HACIENDO nume2 = nume2 + 1;
          #nomir012#83 = #nomir012#83 + #nomir012#nume2#;
     |SIGUE;
     |PARA nume2 = nume1 + 1 - 13; |SI nume2 [ 68; |HACIENDO nume2 = nume2 + 1;
          #nomir012#83 = #nomir012#83 + #nomir012#nume2#;
     |SIGUE;

     |SI eaVengoDe = "nomir002";
          |ACABA;
     |FINSI;

     |GRABA 020#nomir012.a;
     |LIBERA #nomir012;
|FPRC;

|PROCESO OtrosPeriodos_1;
     || con este proceso cojo lo que el trabajador tenga en otros periodos
     || que en el proceso labtraba_6 he ido grabando
     || las limitaciones de configuracion de regularizacion de IRPF para
     || que entren o no entren trabajadores estan en ese proceso con lo que
     || aqui directamente me lo traigo todo, la unica condicion es que
     || este en la misma empresa, cosa que tendriamos que estar comprobando
     || con el nomir009#20 y la variable nAcumOtros pero NO estamos haciendo
     || no se muy bien por que

     ||SI #101#1 ! nEmpAsig; |O #101#2 ! nTraAsig;
     ||SI #101#1 = nEmpAsig; |Y #101#2 < nTraAsig;

     |SI #101#1 = nEmpAsig; |Y #101#2 ! nTraAsig;
          nOtrosIngresos = nOtrosIngresos + #101#7;
          nOtrosSocial = nOtrosSocial + #101#9;
/*
          || ahora busco la nomina del mes
          |SALVA_FICHA #nomcalca;
          #nomcalca#0 = #101#1;
          #nomcalca#1 = #101#2;
          #nomcalca#2 = nElMesIRPF;
          #nomcalca#3 = 0;
          |LEE 000#nomcalca.=;
          |SI FSalida = 0;
               nOtrosIngresos = nOtrosIngresos + #nomcalca#14 + #nomcalca#16;
               nOtrosIngresos = nOtrosIngresos + #nomcalca#69 + #nomcalca#70;
               nOtrosSocial = nOtrosSocial + #nomcalca#48 + #nomcalca#49;
               nOtrosSocial = nOtrosSocial + #nomcalca#50 + #nomcalca#51;
          |FINSI;
          |REPON_FICHA #nomcalca;
*/
     |FINSI;
|FPRC;

|DEFBUCLE OtrosPeriodos;
     #101#1;
     ;
     1;
     999;
     ;
     NULL, OtrosPeriodos_1;
|FIN;

|PROCESO OtrosPeriodos;
     nOtrosIngresos = 0;
     nOtrosSocial = 0;        || acumula ingresos y seg. social de
     |BUCLE OtrosPeriodos;    ||/otros periodos de alta en este a¤o
     #103#2 = #103#2 + nOtrosIngresos;
     #103#3 = #103#3 + nOtrosSocial;

     |ABRE #nomir012;
     #nomir012#1 = #2#0;      || Empresa
     #nomir012#2 = #2#1;      || Trabajador
     #nomir012#3 = nElAnyIRPF;      || A¤o
     #nomir012#4 = nElMesIRPF;      || Mes
     |LEE 101#nomir012.=;
     |SI FSalida = 0;
          #nomir012#87 = nOtrosIngresos + nAcumOtros;

          #nomir012#83 = #nomir012#83 + #nomir012#87;
          #nomir012#84 = #nomir012#84 + #nomir012#87;

          |GRABA 020#nomir012.a;
          |LIBERA #nomir012;
     |FINSI;
     |CIERRA #nomir012;
|FPRC;

|PROCESO GeneraUnidPaga;
     /*
     aFechaAnt = #labtraba#36;
     aFechaAnt = (aFechaAnt % -104) + (aFechaAnt % 402);
     nFechaAnt = aFechaAnt;

     alfa1 = nMesBusca; alfa1 = ("00" + alfa1) % -102;
     nume5 = el_anyo - 1;
     alfa2 = nume5; alfa2 = ("00" + alfa2) % -102;
     alfa2 = "20" + alfa2;
     aFechaNom = alfa2 + alfa1;
     nFechaNom = aFechaNom;

     swSigue = 0;
     |SI nFechaAnt [ nFechaNom; |Y nCodEmp = #labtraba#0; |Y nCodTra = #labtraba#1;
     |Y nTipo = 1; |Y nTramo = 1;
          swSigue = 1;
     |FINSI;
     |SI nFechaAnt [ nFechaNom; |Y nCodEmp = #labtraba#0; |Y nCodTra = #labtraba#1;
     |Y swPosibleIT = 1;
          || si vengo del proceso que busca las teoricas unidades de paga
          || cuando hubo IT, entro en cualquiera de los dos tramos
          || y en cualquiera de los dos tipos
          swSigue = 1;
     |FINSI;
     |SI swSigue = 1;
     */
          nMes = #nomcalca#2;
          nAny = nElAnyIRPF;
          |HAZ topemes_plb;
     /*
          || esto es si el trabajador es alta este mismo mes, no me meto
          || en tanto lio para esto
          |SI nFechaAnt = nFechaNom;
               alfa1 = #labtraba#36 % 102;
               nDiaAlta = alfa1;
               nDias = topemes - nDiaAlta + 1;
               |SI #labtraba#42 ! "D"; |O #labtraba#42 ! "T";
                    |SI nDias > 30;
                         nDias = 30;
                    |FINSI;
               |FINSI;
          |SINO;
     */
          ||FINSI;
     |SI #labtraba#42 = "D"; |O #labtraba#42 = "T";
          nDias = nTopemes;
     |SINO;
          nDias = 30;
     |FINSI;

     nDiasDivide = nHastaMes - nDesdeMes + 1;

     |SI nDesdeMesReal ] nHastaMesReal;
          nDiasDivide = nDiasDivide + (12 - nDesdeMesReal + 1);
     |FINSI;

     |SI nDiasDivide = 0; |O nDiasDivide = 1;
          nDiasDivide = 12;
     |FINSI;
     |SI nDiasDivide < 0;
          nDiasDivide = 12 + nDiasDivide + 1;
     |FINSI;

     |SI nDiasDivide = 12; |Y #labtraba#42 ! "M";
          || si el a¤o es completo cojo todos los dias
          nDiasDivide = 365;
     |SINO;
          || esto esta mal imagino, habria que distinguir
          || los diarios, otro dia
          nDiasDivide = nDiasDivide * 30;
     |FINSI;
     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
          nUnidPaga = nDias * nDiasPago / nDiasDivide * nDias / 30;
     |SINO;
          || diarios
          nUnidPaga = nDias * nDiasPago / nDiasDivide;
     |FINSI;

     ||FINSI;
|FPRC;

|PROCESO BuscaPosibleIT;
     swPosibleIT = 1;
     |SI #nomcalca#31 ! 0;
          |SI #labempre#26 = "N";
               |HAZ GeneraUnidPaga;
          |FINSI;
     |FINSI;
     |SI #nomcalca#32 ! 0;
          |SI #labempre#27 = "N";
               |HAZ GeneraUnidPaga;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO AjustePagaF;
     || una cosa mas, si la paga es de ajuste tipo "F", lo que hago
     || es coger el importe que tengo en la ficha del trabajador
     || y lo divido por los meses de prorrateo de la paga

     nImpAju = 0;
     nProrAju = 0;
     nCampoAju = 0;
     nCampoImpAju = 0;

     nCampoAju = concepto - 44;
     nCampoImpAju = concepto - 36;
     |SI #labtraba#nCampoAju# = "F";
          nImpAju = #labtraba#nCampoImpAju#;
          nProrAju = nImpAju / 30; || aproximadamente
          || si hay diarios en esta circunstancia y alguien se queja
          || ya lo liaremos mas

          |SI concepto = 201; nPP201 = nProrAju; |FINSI;
          |SI concepto = 202; nPP202 = nProrAju; |FINSI;
          |SI concepto = 203; nPP203 = nProrAju; |FINSI;
          |SI concepto = 204; nPP204 = nProrAju; |FINSI;
          |SI concepto = 205; nPP205 = nProrAju; |FINSI;
          |SI concepto = 206; nPP206 = nProrAju; |FINSI;
          |SI concepto = 207; nPP207 = nProrAju; |FINSI;
          |SI concepto = 208; nPP208 = nProrAju; |FINSI;
     |FINSI;
|FPRC;

|PROCESO EsteMes_5;
     |SI #7#4 ] 201; |Y #7#4 [ 208;
          concepto = #7#4;
          #nomconca#0 = #labtraba#87;
          |LEE 000#nomconca.=;

          swNo = 0;

          nNume1 = #7#4 - 197;     || mes desde prorrateo
          nNume2 = #7#4 - 189;     || mes haste prorrateo
          nNume3 = #7#4 - 181;     || mes de pago
          nNume4 = #7#4 - 165;     || dias de pago
          nDesdeMes = #nomconca#nNume1#;
          nHastaMes = #nomconca#nNume2#;
          nMesPago = #nomconca#nNume3#;
          nDiasPago = #nomconca#nNume4#;
          nDesdeMesReal = nDesdeMes;
          nHastaMesReal = nHastaMes;

          nCampoPT = #7#4 - 88;
          |SI nMesPago = 99; |O #labtraba#nCampoPT# = "S";
               |ACABA;
          |FINSI;
          |SI nDesdeMes > nHastaMes;
               nDesdeMes = 1;
          |FINSI;
          |SI nMesPago < nHastaMes;
               swNo = 1;
               || nBaseEste = nBaseEste - (#7#9 * #7#10);
               || ACABA;
          |FINSI;
          |SI nDesdeMes [ #4#2; |Y #4#2 [ nHastaMes; |Y #4#2 [ nMesPago;
               || estos son los casos en que
               || la prorrata ha de tenerse en cuenta
          |SINO;
               swNo = 1;
               ||nBaseEste = nBaseEste - (#7#9 * #7#10);
          |FINSI;
          nUnidPaga = #7#9;

          nGuardaUnidPaga = nUnidPaga;
          |HAZ BuscaPosibleIT;
          |SI nUnidPaga > nGuardaUnidPaga;
               nUnidPaga = nUnidPaga;
          |SINO;
               nUnidPaga = nGuardaUnidPaga;
          |FINSI;

          |SI #7#10 = 1;
               #7#10 = 0;
          |FINSI;

          || unidades de cada paga en el mes de calcula se guarda en nUniPP2XX
          || prorrata de cada paga en el mes de calcula se guarda en nPP2XX

          |SI swNo = 0; |Y nUnidPaga ! 0;
               |SI concepto = 201; nUniPP201 = nUniPP201 + nUnidPaga; |FINSI;
               |SI concepto = 202; nUniPP202 = nUniPP202 + nUnidPaga; |FINSI;
               |SI concepto = 203; nUniPP203 = nUniPP203 + nUnidPaga; |FINSI;
               |SI concepto = 204; nUniPP204 = nUniPP204 + nUnidPaga; |FINSI;
               |SI concepto = 205; nUniPP205 = nUniPP205 + nUnidPaga; |FINSI;
               |SI concepto = 206; nUniPP206 = nUniPP206 + nUnidPaga; |FINSI;
               |SI concepto = 207; nUniPP207 = nUniPP207 + nUnidPaga; |FINSI;
               |SI concepto = 208; nUniPP208 = nUniPP208 + nUnidPaga; |FINSI;

               |SI concepto = 201; |Y nPP201 = 0; nPP201 = #7#10; |FINSI;
               |SI concepto = 202; |Y nPP202 = 0; nPP202 = #7#10; |FINSI;
               |SI concepto = 203; |Y nPP203 = 0; nPP203 = #7#10; |FINSI;
               |SI concepto = 204; |Y nPP204 = 0; nPP204 = #7#10; |FINSI;
               |SI concepto = 205; |Y nPP205 = 0; nPP205 = #7#10; |FINSI;
               |SI concepto = 206; |Y nPP206 = 0; nPP206 = #7#10; |FINSI;
               |SI concepto = 207; |Y nPP207 = 0; nPP207 = #7#10; |FINSI;
               |SI concepto = 208; |Y nPP208 = 0; nPP208 = #7#10; |FINSI;

               |HAZ AjustePagaF;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO EsteMes_G;                     || para los agrarios cuento las jorna-
     |SI #7#4 = 903; |O #7#4 = 922;     || das que he tenido este mes entre
          nJorAgr = nJorAgr + #7#11;    || alta y baja, porque tener algun va-
     |FINSI;                            || lor para estimar en Seg. Social
|FPRC;

|PROCESO EsteMes_3;                     || en los finiquitos separados
     |SI swFiniq = 0;
          |SI #7#4 > 101;|Y #7#4 [ 199;      ||/no cuenta las pagas
               nNume1 = (#7#10 * #7#11) ! EURODB;
               nBaseEste = nBaseEste + nNume1;
               nBaseFiniq = nBaseFiniq + nNume1;
          |FINSI;
          |SI #7#4 > 401;|Y #7#4 < 410;      ||/no cuenta las pagas
               nNume1 = (#7#10 * #7#11) ! EURODB;
               nBaseEste = nBaseEste + nNume1;
               nBaseFiniq = nBaseFiniq + nNume1;
          |FINSI;
     |SINO;
          || ahora tengo que contar las pagas si estoy regularizando en finiquitos
          |SI #7#4 > 101;|Y #7#4 < 410;      || SI cuenta las pagas
               nNume1 = (#7#10 * #7#11) ! EURODB;
               nBaseEste = nBaseEste + nNume1;
               nBaseFiniq = nBaseFiniq + nNume1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO EsteMes_2;
     ||SI #7#4 ] 201;|Y #7#4 [ 299;|Y #7#5 = "P"; |Y #labempre#39 ! 1;
     || quito lo del labempre#39 ! 1 porque no veo que tenga sentido aqui
     || las prorrateadas las esta duplicanso al no dejar pasar
     |SI #7#4 ] 201;|Y #7#4 [ 299;|Y #7#5 = "P";
          |SI swMesBaja = 0;  || en el mes de baja se cobra siempre se cuenta
                              || para regularizar
               nNume1 = (#7#10 * #7#11) ! EURODB;
               nBaseEste = nBaseEste - nNume1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO EsteMes_1;
     |SI swBuscoOtra = 1; |Y #4#3 = 0;
          || estoy buscando el mensual de un trabajador con dos codigos, cada
          || uno en una empresa

          swOtraMensual = 1;

          || esta variable pasa al nomcalir para saber que tengo dos con el mismo
          || NIF en distintas empresas, y que tengo la nomina "del segundo"
          || en el mensual, para que luego no me la estime

          || los tengo que poner a cero, que si no se queda cogido el importe
          || de la prorrata de las pagas del primer trabajador

          nPP201 = 0; nPP202 = 0; nPP203 = 0; nPP204 = 0;
          nPP205 = 0; nPP206 = 0; nPP207 = 0; nPP208 = 0;
          nUniPP201 = 0; nUniPP202 = 0; nUniPP203 = 0; nUniPP204 = 0;
          nUniPP205 = 0; nUniPP206 = 0; nUniPP207 = 0; nUniPP208 = 0;
     |FINSI;

     nEsteMes = #4#2;

     |SI #4#3 = 2;
          swHayFiniq = 1;
     |FINSI;
     |SI nEsteMes ! 12;
          |SI #4#3 ! 2;
               |SI swMesBaja = 0;  || mes normal: tengo en cuenta prorratas
                    || nBaseEste = nBaseEste + (#4#74 + #4#38);
                    nBaseEste = nBaseEste + #4#74 + #4#16;

                    |ABRE #nomconca;
                    |BUCLELIN 2EsteMes_5#4;
                    |CIERRA #nomconca;
               |SINO;              || mes baja: tengo en cuenta lo cobrado
                    |SI #labempre#39 = 1; || si finiquito junto, este mes todo
                         nBaseEste = nBaseEste + #4#74;
                         || no pongo la prorrata porque ya viene incluida en
                         || la base del mes si es finiquito junto al mes
                         || despues en EsteMes_2 no se la quito
                    |SINO;
                         nBaseEste = nBaseEste + (#4#74 + #4#16);
                         nBaseEste2 = #4#74 + #4#16;   || me hara falta en nomcalir
                         nRetenEste2 =  #4#15 + #4#71 + #4#72;
                    |FINSI;
               |FINSI;             || las prorratas no cobradas en finiquitos

               |SI #4#38 ! 0;
                    ||BUCLELIN 2EsteMes_2#4;
               |FINSI;
          |SINO;
               ||BUCLELIN 2EsteMes_3#4;
               nRetenFiniq = nRetenFiniq + #4#15 + #4#71 + #4#72;
          |FINSI;
     |SINO;
          |SI nSwPagas = 0;
               nBaseEste = nBaseEste + (#4#74 + #4#16);
          |SINO;
               nBaseEste = nBaseEste + #4#74;
          |FINSI;
          || por algun motivo, en Diciembre en finiquito aparte no estaba teniendo
          || en cuenta lo cobrado en el mes para regularizar, lo metia todo en
          || finiquito y habia que volver a calcular nomina y finiquito tras
          || regularizar, ahora lo cambio para que lo del tipo 0 lo meta como
          || ya cobrado y regularice solo respecto al finiquito, luego si hay
          || que volver a calcular sera solo el finiquito: 12.12.2005
          |SI #4#3 ! 2; |Y swMesBaja ! 0; |Y #labempre#39 ! 1;
               nBaseEste2 = #4#74 + #4#16;   || me hara falta en nomcalir
               nRetenEste2 =  #4#15 + #4#71 + #4#72;
          |FINSI;
     |FINSI;
     nSeguEste = nSeguEste + (#4#48 + #4#49 + #4#50 + #4#51);
     nJorAgr = 0;

     nImporte012 = #4#74;
     nMes012 = nElMesIRPF;
     nTipo012 = 0;         || NOMINA
     |SI #4#3 = 2;
          nTipo012 = 2;         || FINIQUITO
     |FINSI;
     |HAZ Acum012;

     nImporte012 = #4#16;
     nMes012 = nElMesIRPF;
     nTipo012 = 51;         || PAGAS
     |HAZ Acum012;

     |BUCLELIN 2EsteMes_G#4;
|FPRC;

|DEFBUCLE EsteMes_Otra;
 #4#1;
 ;
 #nomir016#2, #nomir016#3, nMes99, 0;
 #nomir016#2, #nomir016#3, nMes99, 9;
 ;
 NULL, EsteMes_1;
|FIN;

|PROCESO nomir016;
     |BUCLE EsteMes_Otra;
|FPRC;

|DEFBUCLE nomir016;
     #nomir016#1;
     ;
     nEmpr99, nTrab99, 00001, 00001;
     nEmpr99, nTrab99, 99999, 99999;
     ;
     NULL, nomir016;
|FINSI;

|DEFBUCLE EsteMes;
 #4#1;
 ;
 nEmpr99, nTrab99, nMes99, 0;
 nEmpr99, nTrab99, nMes99, 9;
 ;
 NULL, EsteMes_1;
|FIN;

|PROCESO Minimo; |TIPO 0;
     aFabre = "";
     |DIRECTORIO aFabre;
     aFabre = "rt  " + aFabre + "laboral/bin/gafi0001.tab";
     |FABRE aFabre;
     |SI FSalida ] 0;
          |FCIERRA FSalida;
          |DDEF aDef;
          aAlfa = aDef % 0111;
          |SI aAlfa = "/u/dsprofes";    || estoy en produccion
               |ACABA;             || no me compruebes nada
          |FINSI;
          aDef = aDef + "gafi0001";
          |CARGA_DEF aDef, elmodulo@;
          |SI FSalida = 0;
               |ABRE #500;
               |LEE 000#500.p;
               |SI FSalida = 0;
                    |SI #nomir008#7 < #500#1; |Y #500#4 = "N";
                         #nomir008#7 = #500#1;
                    |FINSI;
               |FINSI;
               |CIERRA #500;
          |FINSI;
          |DESCARGA_DEF #elmodulo@;
     |FINSI;
|FPRC;

|PROCESO nomhicca_2_2;
     nImporte012 = #3#14 + #3#108 + #3#109;
     nMes012 = #3#2;
     nTipo012 = 0;         || NOMINA
     |SI #3#3 = 2;
          nTipo012 = 2;         || FINIQUITO
     |FINSI;
     |HAZ Acum012;

     nImporte012 = #3#16;
     nMes012 = #3#2;
     nTipo012 = 51;         || PAGAS
     |HAZ Acum012;
|FPRC;

|DEFBUCLE nomhicca_2_2;
     #3#1;
     ;
     #2#0, #2#1, nDosDigitos,      1,  0;
     #2#0, #2#1, nDosDigitos, nElTop, 99;
     ;
     NULL, nomhicca_2_2;
|FIN;

|PROCESO Punto02Multi;
     |DDEFECTO #nomir009;
     |ABRE #nomir009;
     #nomir009#0 = #0#3;
     |LEE 000#nomir009.=;
     |CIERRA #nomir009;

     #nomir008#2 = #103#0;         || acumulado ingresos
     #nomir008#3 = #103#1;         || acumulado retencion

     nCalculo99 = 1;
     nEmpr99 = #nomir008#0;
     nTrab99 = #nomir008#1;
     nAnyo99 = nElAnyIRPF;
     nMes99 = nElMesIRPF;
     nSwMes99 = #nomir009#14;
     aFeAlta = #nomir008#12;
     aFeBaja = #nomir008#13;

     nEsteMes = 0;
     nBaseEste = 0;
     nSeguEste = 0;           || recoge lo del mes, es mejor que estimarlo
     nBaseFiniq = 0;
     nRetenFiniq = 0;
     nEstima = 0;
     nSeguri = 0;
     swHayFiniq = 0;

     nPP201 = 0; nPP202 = 0; nPP203 = 0; nPP204 = 0;
     nPP205 = 0; nPP206 = 0; nPP207 = 0; nPP208 = 0;
     nUniPP201 = 0; nUniPP202 = 0; nUniPP203 = 0; nUniPP204 = 0;
     nUniPP205 = 0; nUniPP206 = 0; nUniPP207 = 0; nUniPP208 = 0;

     |ABRE #labtraba;
     #labtraba#0 = nEmpr99;
     #labtraba#1 = nTrab99;
     |LEE 000#labtraba.=;
     |CIERRA #labtraba;

     |ABRE #nomir012;
     |HAZ Inicia012;

     swBuscoOtra = 0;
     |BUCLE EsteMes;
     |HAZ AcumPagas;

     swBuscoOtra = 1;
     swOtraMensual = 0;
     |BUCLE nomir016;
     swBuscoOtra = 0;

     |SI swOtraMensual = 1;
          |HAZ AcumPagas;

          || los pongo a cero para que no pase al nomcalir con importe
          || proveniente de esta paga

          nPP201 = 0; nPP202 = 0; nPP203 = 0; nPP204 = 0;
          nPP205 = 0; nPP206 = 0; nPP207 = 0; nPP208 = 0;
     |FINSI;

     |HAZ Graba012;

     |SI #labtraba#111 = 2; |Y #labtraba#130 = 2; |Y nElAnyIRPF ] 2013;
          || en estos casos no entra en la estimacion de IRPF del nomcalir
          || y ahi es donde se graba la pantalla, con lo que no se graba
          || asi que la grabo aqui.

          |BUCLE nomhicca_2_2;

          |HAZ Graba012;
          |HAZ Totaliza012;
     |FINSI;

     |CIERRA #nomir012;

     |DDEFECTO #102;
     |ABRE #102;
     #102#0 = #0#0;
     #102#40= #0#2;
     #102#41= #0#3;
     |LEE 000#102=;
     |CIERRA #102;

     || para comprobar/grabar el nomir013

     |HAZ CambioParam;

     |SI #labtraba#111 ! 2; |O #labtraba#130 ! 2;
     ||SI #102#5 ! 2; |O #102#121 ! 2;
         |SUB_EJECUTA "nomcalir";
     |FINSI;

     || #103#2 = nBaseEste + nEstima + nPaga12;
     || ATENCION: lo estimado pillo lo nuevo, que para eso esta
     || es la variable nEstima, que viene del #nomir012#84 que se ha calculado
     || en el nomcalir

     #103#2 = nEstima;
     #103#3 = nSeguEste + nSeguri + nAutGastos;


     |SI #nomir009#20 = 2;
          || si el trabajador ha tenido durante el a¤o un codigo en otra
          || empresa y quiero que me tenga en cuenta esas bases se lo tengo
          || que a¤adir aqui 17.04.2008

          #103#2 = #103#2 + nAcumOtros;
          #103#3 = #103#3 + nAcumOtrosSS;
     |SINO;
          nAcumOtros = 0;
          nAcumOtrosSS = 0;
     |FINSI;

     || #103#0 = #103#0 + nBaseFiniq;  || los finiquitos ya no se tienen en
     || #103#1 = #103#1 + nRetenFiniq; || cuenta en lo acumulado

     |SI swFiniq = 1;
          || esto no me debe hacer falta en lo nuevo, ya que tengo mi campo
          || con el que se exactamente lo acumulado

          || #103#0 = #103#0 + nBaseEste2;
          || #103#1 = #103#1 + nRetenEste2;

          #nomir008#2 = #103#0;         || acumulado ingresos
          #nomir008#3 = #103#1;         || acumulado retencion
     |FINSI;

     nEmpAsig = #nomir008#0;
     nTraAsig = #nomir008#1;
     |HAZ OtrosPeriodos;

     |SI #103#3 = 0;
          #103#3 = #102#11;   || conserva seg.social informada (autonomos)
     |FINSI;

     || esto lo dejo pero no lo tengo muy claro
     |SI #103#0 > #103#2;     || si lo ya ingresado es superior a la estimacion
          #103#2 = #103#0 + nBaseEste + nPaga12;    || de lo que voy a ingresar en el a¤o (NO puede
          #103#3 = #103#3 + #101#9;
     |FINSI;                  || pasar), las igualo

     #0#3 = nEmpr99;
     #0#4 = nTrab99;
     |HAZ GrabaParametros;

     #nomir008#5 = #103#2;              || ingresos estimados
     #nomir008#8 = #103#3;              || seg.social estimada
     |HAZ Punto05Multi;
     #nomir008#6 = #104#26;             || retencion estimada
     #nomir008#7 = #104#25;             || tipo estimado
     nRetEstAnu = #nomir008#6;
     |HAZ Minimo;
|FPRC;

|PROCESO Punto02Mono;
     nCodEmpr = 0;
     nCodTrab = 0;
     |PUSHV 0501 2380;
     |PINPA #0#101;
     |ATRI R;
     |PINTA 1669, #103#0;
     |PINTA 1869, #103#1;
     |PINTA 2269, #103#2;
     |ATRI 0;
     |ENTLINEAL #1#101, 1, 2, 20, 0, Min101, Max101;
     |SI nCodEmpr ! 0;|Y nCodTrab ! 0;
          |CONFI "    SConforme con la asignacion S/N: ";
          |SI FSalida = 0;
               #0#3 = nCodEmpr;
               #0#4 = nCodTrab;
               #0#5 = "N";
               |GRABA 020#0a;
               |SI FSalida = 0;
                    nEmpAsig = #0#3;
                    nTraAsig = #0#4;
                    |HAZ OtrosPeriodos;

                    |HAZ GrabaParametros;
                    |CONFI "    SPresentar resultados del calculo S/N: ";
                    |SI FSalida = 0;
                         |HAZ Punto05;
                    |FINSI;
               |FINSI;
          |SINO;
               |LEE 000#0=;
          |FINSI;
     |FINSI;
     |POPV;
     ||CAMPO_ATRIBUTO #0#3, D, 0, 0;
     ||CAMPO_ATRIBUTO #0#4, D, 0, 0;
     |PINTA #0#3;
     |PINTA #0#4;
     |PINTA #0#5;
|FPRC;

|PROCESO Punto02;
     || Desde aqui se llamaba a "Asignar Codigo de Trabajador" asi que este
     || punto desaparece del menu pero claro, la opcion la dejo ya que es
     || la que me realiza el calculo de IRPF

     |SI aPMensual = ""; aPMensual = "N";    |FINSI;

     nDosDigitos = #0#2 $ 100;
     nLinea = 0;
     #103#0 = 0;
     #103#1 = 0;
     #103#2 = 0;
     #103#3 = 0;
     nAcumSS = 0;
     nAutGastos = 0;

     aAlfa1 = Usuario; |QBF aAlfa1; aAlfa1 = "s" + aAlfa1;
     |NOME_DAT #101 aAlfa1;
     |DELINDEX #101;

     |ABRE #1;
     |ABRE #5;
     |ABRE #8;
     |SELECT #2#5;
     |ABRE #101;

     aAlfa2 = Usuario; |QBF aAlfa2; aAlfa2 = "u" + aAlfa2;
     |NOME_DAT #201 aAlfa2;
     |DELINDEX #201;
     |ABRE #201;

     |DDEFECTO #nomir009;
     |ABRE #nomir009;
     #nomir009#0 = #0#3;
     |LEE 000#nomir009.=;
     |CIERRA #nomir009;
     nAcumOtros = 0;     || acumulado bases otros trabajadores
     nAcumOtrosSS = 0;   || acumulado S.S. otros trabajadores

     |SI nElMesIRPF = 0;
          |SI #nomir009#20 ! 2;
               |BUCLE labtraba;
          |SINO;
               |BUCLE labtraba_TODO;
          |FINSI;
     |SINO;
          |SI #nomir009#20 ! 2;
               |BUCLE labtraba_sin;  || con segunda ordenacion daba problemas
          |SINO;                     ||/en calculos masivos de regularizacion
               |BUCLE labtraba_sin_TODO;
          |FINSI;
     |FINSI;
     |CIERRA #1;
     |CIERRA #5;
     |CIERRA #8;
     |CIERRA #101;

     |CIERRA #201;

     |SI nLinea ! 0;
          |SI nElMesIRPF = 0;
               |HAZ Punto02Mono;
          |SINO;
               |HAZ Punto02Multi;
          |FINSI;
     |SINO;
          aAlfa1 = "    NIF [" + #0#0 + "] inexistente en trabajadores ...";
          |MENAV aAlfa1;
     |FINSI;
     |DELINDEX #101;
|FPRC;

|PROCESO BuscaTrab;
     swSigue = 1;
     |ERROR10;
|FPRC;

|DEFBUCLE BuscaTrab;
     #labtraba#5;
     44;
     #0#3, #0#0, "A";
     #0#3, #0#0, "A";
     ;
     NULL, BuscaTrab;
|FIN;

____________________________________/ PUNTO 02 (Emitir Comunicacion)
|PROCESO Punto03;
     swSigue = 0;
     Impresora = "CrystalReport";
     |IMPRE -1;
     |SI FSalida ! 0;
          |ACABA;
     |FINSI;

     |DDEFECTO #1;
     |ABRE #1;
     #1#0 = #0#3;
     |LEE 000#1=;
     |CIERRA #1;

     |BUCLE BuscaTrab;
/*
     |DDEFECTO #2;
     |ABRE #2;
     |SELECT #2#labtraba;
     #2#7 = #0#0;
     |LEE 000#2];
     |SI FSalida = 0; |Y #0#0 = #2#7;
          swSigue = 1;
     |FINSI;
     |SELECT #1#labtraba;
     |CIERRA #2;
*/

     |SI swSigue ! 1;
          |MENAV "    No se ha encontrado un trabajador de alta con este NIF en esta empresa. Compruebe sus datos.";
          |ACABA;
     |FINSI;
/*
     #2#0 = #0#3;
     #2#1 = #0#4;
     |LEE 000#2=;
*/
     |DDEFECTO #102;
     |ABRE #102;
     #102#0 = #0#0;
     #102#40= #0#2;
     #102#41= #0#3;
     |LEE 000#102=;
     |CIERRA #102;

     aCadena = #2#2;
     |HAZ SeparaNom_plb;

     |HAZ Fecha;

     |CONFI "    NEmitir por triplicado (S/N): ";
     |SI FSalida = 0;
         aDatosSN = "S";
         |INFOR "nomycom1";
         |PARA nPara1 = 1; |SI nPara1 [ 3; |HACIENDO nPara1 = nPara1 + 1;
              |SI nPara1 = 1;  aEjemplar = "EJEMPLAR PARA EL TRABAJADOR"; |FINSI;
              |SI nPara1 = 2;  aEjemplar = "EJEMPLAR PARA LA EMPRESA   "; |FINSI;
              |SI nPara1 = 3;  aEjemplar = "EJEMPLAR PARA LA ASESORIA  "; |FINSI;
              |PRINT;
              |PIEINF;
         |SIGUE;
         |FININF;
     |SINO;
         aDatosSN = "S";
          aEjemplar = "";
          |INFOR "nomycom1";
          |PRINT;
          |PIEINF;
          |FININF;
     |FINSI;
     |FINIMP;
|FPRC;

|PROCESO Fecha;
     fFech1 = ~;
     ||aFecha = #0#13;
     aFecha = fFech1;
     aAlfa1 = aFecha % 102;
     aAlfa2 = aFecha % 402;
     nNume2 = aAlfa2;
     aAlfa3 = aFecha % 704;
     |SI nNume2 =  1;  p_mes = "ENERO     ";  |FINSI;
     |SI nNume2 =  2;  p_mes = "FEBRERO   ";  |FINSI;
     |SI nNume2 =  3;  p_mes = "MARZO     ";  |FINSI;
     |SI nNume2 =  4;  p_mes = "ABRIL     ";  |FINSI;
     |SI nNume2 =  5;  p_mes = "MAYO      ";  |FINSI;
     |SI nNume2 =  6;  p_mes = "JUNIO     ";  |FINSI;
     |SI nNume2 =  7;  p_mes = "JULIO     ";  |FINSI;
     |SI nNume2 =  8;  p_mes = "AGOSTO    ";  |FINSI;
     |SI nNume2 =  9;  p_mes = "SEPTIEMBRE";  |FINSI;
     |SI nNume2 = 10;  p_mes = "OCTUBRE   ";  |FINSI;
     |SI nNume2 = 11;  p_mes = "NOVIEMBRE ";  |FINSI;
     |SI nNume2 = 12;  p_mes = "DICIEMBRE ";  |FINSI;
     aDia  = aAlfa1;
     aAnyo = aAlfa3;
|FPRC;

____________________________________/ PUNTO 03 (Parametros Calculo)
|PROCESO Reduccion102; |TIPO 0;
     |SI #102#10 > 120000;
          aAlfa = "    ATENCION: no se permiten en esta reduccion ";
          aAlfa = aAlfa + "importes superiores a 120000 euros";
          |MENAV aAlfa;
          |ERROR;
     |FINSI;
|FPRC;

|PROCESO Nacido102; |TIPO 7;
     |ABRE #2;
     #2#0 = #0#3;
     #2#1 = #0#4;
     |LEE 000#2=;
     |SI FSalida = 0;
          fFech2 = #2#11;          aAlfa2 = fFech2;
          aAlfa2 = aAlfa2 % -104;  nNume2 = aAlfa2;
          |SI nNume2 ! 0;
               #102#1 = #0#2 - nNume2;
               |PINTA #102#1;
          |FINSI;
     |FINSI;
     |CIERRA #2;
|FPRC;

|PROCESO LetraNif102; |TIPO 0;
     NifLetra = #102Campo;
     |HAZ LetraNif;
     #102Campo = NifLetra;
     |PINTA #102Campo;
|FPRC;

|PROCESO Mayus102; |TIPO 0;
     #102Campo = #102Campo > #102Campo;
     |PINTA #102Campo;
|FPRC;

|PROCESO SinConyuge102; |TIPO 7;
     ||ACABA;
     |SI #102#3 = "2";
          |C_M #102Campo, 1, "S";
     |SINO;
          #102Campo = "";
          |PINTA #102Campo;
          |C_M #102Campo, 1, "N";
     |FINSI;
|FPRC;

|PROCESO NoMinus102; |TIPO 7;
     ||ACABA;
     |SI #102#6 = "S";
          |C_M #102Campo, 1, "S";
     |SINO;
          |C_M #102Campo, 1, "N";
     |FINSI;
|FPRC;

|PROCESO NoAyuda102; |TIPO 7;
     ||ACABA;
     |SI #102#6 = "S";
          |SI #102#7 = "1";
               |C_M #102Campo, 1, "S";
          |SINO;
               #102Campo = "N";
               |PINTA #102Campo;
               |C_M #102Campo, 1, "N";
          |FINSI;
     |SINO;
          #102Campo = "N";
          |PINTA #102Campo;
          |C_M #102Campo, 1, "N";
     |FINSI;
|FPRC;

|PROCESO NoTrabaja102; |TIPO 7;
     ||ACABA;
     |SI #102#2 = "A";
          |C_M #102Campo, 1, "S";
          |DDEFECTO #2;
          |ABRE #2;
          #2#0 = #0#3;
          #2#1 = #0#4;
          |LEE 000#2=;
          |SI FSalida = 0;
               #102Campo = #2#111;
               |PINTA #102Campo;
          |FINSI;
          |CIERRA #2;
     |SINO;
          #102Campo = "1";
          |PINTA #102Campo;
          |C_M #102Campo, 1, "N";
     |FINSI;
|FPRC;

|PROCESO NoRegul102; |TIPO 0;
     |SI #102#15 = "S";
          |C_M #102#16, 1, "S";
          |C_M #102#17, 1, "S";
          |C_M #102#18, 1, "S";
          |C_M #102#19, 1, "S";
          |C_M #102#115, 1, "S";
          |C_M #102#116, 1, "S";
          |C_M #102#117, 1, "S";
          |C_M #102#118, 1, "S";
     |SINO;
     /*
          || para que sirve esto? no tiene sentido, lo quito 13/01/2011

          #102#16 = 0;   |PINTA #102#16;
          #102#17 = 0;   |PINTA #102#17;
          #102#18 = 0;   |PINTA #102#18;
          #102#19 = 0;   |PINTA #102#19;
          #102#115 = "N";   |PINTA #102#115
          #102#116 = 0;   |PINTA #102#117;
          #102#117 = 0;   |PINTA #102#117;
          #102#118 = 0;   |PINTA #102#118;
          |C_M #102#16, 1, "N";
          |C_M #102#17, 1, "N";
          |C_M #102#18, 1, "N";
          |C_M #102#19, 1, "N";
          |C_M #102#115, 1, "N";
          |C_M #102#116, 1, "N";
          |C_M #102#117, 1, "N";
          |C_M #102#118, 1, "N";
     */
     |FINSI;
|FPRC;

|PROCESO Ordenados102;
     nNume1 = 0;
     |PARA nPara1 = 20; |SI nPara1 [ 29; |HACIENDO nPara1 = nPara1 + 1;
          |SI #102nPara1 ! 0;
               |SI nNume1 = 0;
                    nNume1 = #102nPara1;
               |FINSI;
               |SI nNume1 > #102nPara1;
                    |MENAV "0000Asegurese de que los descendientes esten ordenados por fecha de nacimiento.";
                    |SAL;
               |SINO;
                    nNume1 = #102nPara1;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO SinPadre102; |TIPO 7;
     ||ACABA;
     nNume1 = Campo + 33;
     |SI #102nNume1 ! 0;
          |C_M #102Campo, 1, "S";
     |SINO;
          nNume2 = Campo + 1;
          |PDEFECTO #102, Campo, nNume2;
          |PINTA #102Campo;
          |C_M #102Campo, 1, "N";
     |FINSI;
|FPRC;

|PROCESO SinHijo102; |TIPO 7;
     ||ACABA;
     |SI Campo ] 30;|Y Campo [ 39;
          nNume1 = Campo - 10;
     |FINSI;
     |SI Campo ] 42;|Y Campo [ 51;
          nNume1 = Campo - 22;
     |FINSI;
     |SI Campo ] 75;|Y Campo [ 84;
          nNume1 = Campo - 55;
     |FINSI;
     |SI #102nNume1 ! 0;
          |C_M #102Campo, 1, "S";
     |SINO;
          nNume2 = Campo + 1;
          |PDEFECTO #102, Campo, nNume2;
          |PINTA #102Campo;
          |C_M #102Campo, 1, "N";
     |FINSI;
|FPRC;

|PROCESO ConstantesEuro;      || Pasa constantes de cuotas retencion a EURO
                              || o a Pesetas segun la moneda elegida
     |SI #0#2 [ 2014;
          |SI EURODB = 2;
               n12 = 75.13;        n25 = 150.25;       n100 = 601.01;
               n150 = 901.52;      n200 = 1202.02;     n300 = 1803.04;
               n375 = 2253.80;     n500 = 3005.06;     n550 = 3305.57;
               n600 = 3606.07;     n650 = 3906.58;     n850 = 5108.60;
               n1150 = 6911.64;    n1250 = 7512.65;    n1350 = 8113.66;
               n1351 = 8113.67;    n1450 = 8714.68;    n1675 = 10066.95;
               n1850 = 11118.72;   n2000 = 12020.24;   n2025 = 12170.50;
               n3500 = 21035.42;
          |SINO;
               n12 = 12500;        n25 = 25000;        n100 = 100000;
               n150 = 150000;      n200 = 200000;      n300 = 300000;
               n375 = 375000;      n500 = 500000;      n550 = 550000;
               n600 = 600000;      n650 = 650000;      n850 = 850000;
               n1150 = 1150000;    n1250 = 1250000;    n1350 = 1350000;
               n1351 = 1350001;    n1450 = 1450000;    n1675 = 1675000;
               n1850 = 1850000;    n2000 = 2000000;    n2025 = 2025000;
               n3500 = 3500000;
           |FINSI;
     |FINSI;
     |SI #0#2 ] 2015;
          n12 = 75.13;        n25 = 150.25;       n100 = 601.01;
          n150 = 901.52;      n200 = 1202.02;     n300 = 1803.04;
          n375 = 2253.80;     n500 = 3005.06;     n550 = 3305.57;
          n600 = 3606.07;     n650 = 3906.58;     n850 = 5108.60;
          n1150 = 6911.64;    n1250 = 7512.65;    n1350 = 8113.66;
          n1351 = 8113.67;    n1450 = 8714.68;    n1675 = 10066.95;
          n1850 = 11118.72;   n2000 = 12020.24;   n2025 = 12170.50;
          n3500 = 21035.42;
     |FINSI;
|FPRC;

|PROCESO TipoEstima;
/*
     |SI #nomir003#5 = 2;
          |C_M #nomir003#121, 1, "S";
          |C_V #nomir003#121, 1, "S";
          |PINTA #nomir003#121;
     |SINO;
          |C_M #nomir003#121, 1, "N";
          |C_V #nomir003#121, 1, "N";
          |PINTA 1051, "   ";
     |FINSI;
*/
     |SI #nomir003#5 = 2;
          |C_V #nomir003#121, 1, "S";
          |PINTA #nomir003#121;
     |SINO;
          |C_V #nomir003#121, 1, "N";
          |PINTA 1051, "   ";
     |FINSI;
|FPRC;

|PROCESO comp_hijos_001;
     swHijos = 0;
     |PARA nPara1 = 20; |SI nPara1 [ 29; |HACIENDO nPara1 = nPara1 + 1;
          nEdad = #0#2 - #102nPara1;
          |SI #102nPara1 ! 0;
               nPara2 = nPara1 + 10;    || grado minusvalia

               || solo tienen reduccion menores de 25 a¤os o mayores c/minusv.
               |SI nEdad < 25;
               |O #102nPara2 = "1"; |O #102nPara2 = "2";
                   swHijos = 1;
               |FINSI;
          |FINSI;
     |SIGUE;
     |SI #102#3 = 1; |Y swHijos ! 1;
          aAlfa1 = "    ATENCION. Para la situación familiar tipo 1 es obligatorio tener ";
          aAlfa1 = aAlfa1 + " des- cendientes con derecho a reducción";
          |MENAV aAlfa1;
          #102#3 = 3;
          |PINTA #102#3;
          aAlfa = "    Se ha cambiado la situación familiar a tipo 3. Si no es correcto ";
          aAlfa = aAlfa + "cámbielo al 1 e introduzca los datos de los desc.";
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO comp_conyuge_001;
     aAlfa1 = #102#4;
     |QBF aAlfa1;
     |SI aAlfa1 =""; |Y #102#3 = 2;
          aAlfa1 = "    ATENCION. Para la situación familiar tipo 2 es obligatorio tener informado";
          aAlfa1 = aAlfa1 + " el NIF del cónyuge.";
          |MENAV aAlfa1;
          #102#3 = 3;
          |PINTA #102#3;
          aAlfa = "    Se ha cambiado la situación familiar a tipo 3. Si no es correcto ";
          aAlfa = aAlfa + "cámbielo al 2 e introduzca el NIF del cónyuge";
          |MENAV aAlfa;
     |FINSI;
|FPRC;

|PROCESO Punto04;
     |PUSHV 0501 2380;
     |DDEFECTO #102;
     |SI nModoExt ! 4;
         |ABRE #102;
         #102#0 = #0#0;
         #102#40= #0#2;
         #102#41= #0#3;
         |LEE 040#102=;
         |SI FSalida = 0;
               nPan = 1;
               |PARA; |SI; |HACIENDO;
                    |SI FSalida = 4;
                         nPan = nPan - 1;
                    |FINSI;
                    |SI FSalida = 5;
                         nPan = nPan + 1;
                    |FINSI;
                    |SI FSalida = 1;
                         |PINPA #0#102; |PINDA #0#102;
                         |HAZ TipoEstima;
                         |SAL;
                    |FINSI;
                    |SI nPan [ 1;
                         nPan = 1;
                         |PINPA #0#102; |PINDA #0#102;
                         |HAZ TipoEstima;
                         |PAUSA;
                    |FINSI;
                    |SI nPan ] 2;
                         nPan = 2;
                         |PINPA #1#102; |PINDA #1#102;
                         |PAUSA;
                    |FINSI;
               |SIGUE;

             /*
             |PINPA #0#102;
             |PINDA #0#102;
             |HAZ Ordenados102;
             |HAZ TipoEstima;
             |ENDATOS #1#102;
             |SI FSalida = 0;
                  |HAZ comp_conyuge_001;
                  |HAZ comp_hijos_001;
                  #102#122 = "0";
                  |GRABA 020#102a;
             |FINSI;
             */
         |FINSI;
         |HAZ Ordenados102;
         |LIBERA #102;
         |CIERRA #102;
     |SINO;
          |ABRE #102;
          #102#0 = #0#0;
          #102#40= #0#2;
          #102#41= #0#3;
          |LEE 000#102=;
          |SI FSalida = 0;
               nPan = 1;
               |PARA; |SI; |HACIENDO;
                    |SI FSalida = 4;
                         nPan = nPan - 1;
                    |FINSI;
                    |SI FSalida = 5;
                         nPan = nPan + 1;
                    |FINSI;
                    |SI FSalida = 1;
                         |PINPA #0#102; |PINDA #0#102;
                         |HAZ TipoEstima;
                         |SAL;
                    |FINSI;
                    |SI nPan [ 1;
                         nPan = 1;
                         |PINPA #0#102; |PINDA #0#102;
                         |HAZ TipoEstima;
                         |PAUSA;
                    |FINSI;
                    |SI nPan ] 2;
                         nPan = 2;
                         |PINPA #1#102; |PINDA #1#102;
                         |PAUSA;
                    |FINSI;
               |SIGUE;
/*
               |PINPA #0#102;
               |PINDA #0#102;
               |HAZ TipoEstima;
               |PAUSA;
*/
          |SINO;
               |MENAV "    Parametros de calculo inexistentes ...";
          |FINSI;
          |CIERRA #102;
     |FINSI;
     |POPV;
|FPRC;
____________________________________/ PUNTO 04 (Calcular y Presentar)
|PROCESO TipoAntesDe;
     nTipo = (#104#38 * 100) / #102#9;
     nTipo = nTipo - .005;              || trunca a dos decimales
     nTipo = nTipo ! 2;
     |SI nTipo < 0; nTipo = 0;     |FINSI;
     |SI #0#2 ] 2002;    nTipo = nTipo ! 0;  |FINSI;

     #104#38 = #102#9 % nTipo;
|FPRC;

|PROCESO ElTipo;
     |SI #0#2 = 1999;
          nEspecial = 20;
          nMaximo = 48;
          nInferior = 2;
     |FINSI;
     |SI #0#2 ] 2000;
          nEspecial = 18;
          nMaximo = 48;
          nInferior = 2;
     |FINSI;

     |SI #102#15 = "S";                 || regularizacion S/N

          ||HAZ TipoAntesDe;        || antes de regularizar recalcula la
                                   ||/cuota que saldria si no regularizara

          |SI #102#14 = "S";            || ceuta y melilla S/N
               #102#19 = #102#19 * 2;
               #102#17 = #102#17 * 2;
          |FINSI;
          |SI #102#18 ! 0;|Y #102#19 = 0;    || parche!
               #102#18 = 0;
          |FINSI;
          |SI #102#9 ! #102#18;
               |SI #102#9 > #102#18;
                    #104#39 = #102#9 - #102#18;
               |SINO;
                    #104#39 = 0;        || incremento bases
               |FINSI;
               |SI #104#38 > #102#19;
                    #104#40 = #104#38 - #102#19;
               |SINO;
                    #104#40 = 0;        || incremento cuota
               |FINSI;
               |SI #104#40 > #104#39;
                    #104#40 = #104#39;
               |FINSI;
               nNume1 = #102#19 + #104#40;
               |SI #104#38 > nNume1;
                    #104#38 = nNume1;
               |FINSI;
          |FINSI;
          |SI #104#38 [ #102#17;
               nTipo = 0;
          |SINO;
               nTipo = ((#104#38 - #102#17) * 100) / (#102#9 - #102#16);
               nTipo = nTipo - .005;
               nTipo = nTipo ! 2;
               |SI nTipo < 0; nTipo = 0;     |FINSI;
               |SI nTipo > nMaximo;
                    nTipo = nMaximo;
               |FINSI;
          |FINSI;
     |SINO;
          nTipo = (#104#38 * 100) / #102#9;
          nTipo = nTipo - .005;              || trunca a dos decimales
          nTipo = nTipo ! 2;
          |SI nTipo < 0; nTipo = 0;     |FINSI;
     |FINSI;

     |SI #104#7 = "2";        || inferiores a 1 a¤o
          |SI nTipo < nInferior;
               #104#42 = "NO";
               #104#43 = 0;
               nTipo = nInferior;
          |FINSI;
     |SINO;
          |SI #104#7 = "3";   || relaciones especiales
               |SI nTipo < nEspecial;
                    #104#42 = "NO";
                    #104#43 = 0;
                    nTipo = nEspecial;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #0#2 ] 2002;    nTipo = nTipo ! 0;  |FINSI;

     |SI #104#18 = "S";            || ceuta y melilla
          nTipo = nTipo / 2;
          nTipo = nTipo - .005;
          nTipo = nTipo ! 2;
          |SI nTipo < 0; nTipo = 0;     |FINSI;
          |SI #0#2 ] 2002;    nTipo = nTipo ! 0;  |FINSI;
          #104#25 = nTipo;
          #104#26 = #102#9 % #104#25;
     |SINO;
          |SI #102#15 = "S";
               #104#25 = nTipo;
               #104#26 = #102#17 + ((#104#25 * (#102#9 - #102#16)) / 100);
          |SINO;
               #104#25 = nTipo;
               #104#26 = #102#9 % #104#25;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO LimiteCuota;
     #104#41 = 0;             || limite de ingresos
     #104#42 = "NO";          || cuota limitada
     #104#43 = 0;             || cuota limite
     |SI #102#9 [ n3500;
          |SI #104#8 = "1";
               |SI #104#19 = 0;    #104#41 = n1250;  |FINSI;
               |SI #104#19 = 1;    #104#41 = n1675;  |FINSI;
               |SI #104#19 ] 2;    #104#41 = n1850;  |FINSI;
          |FINSI;
          |SI #104#8 = "2";
               |SI #104#19 = 0;    #104#41 = n1675;  |FINSI;
               |SI #104#19 = 1;    #104#41 = n1850;  |FINSI;
               |SI #104#19 ] 2;    #104#41 = n2025;  |FINSI;
          |FINSI;
          |SI #104#8 = "3";
               |SI #104#19 = 0;    #104#41 = n1250;  |FINSI;
               |SI #104#19 = 1;    #104#41 = n1350;  |FINSI;
               |SI #104#19 ] 2;    #104#41 = n1450;  |FINSI;
          |FINSI;
          |SI #102#2 = "P";
               #104#41 = #104#41 + n100;
          |FINSI;
          |SI #102#2 = "D";
               #104#41 = #104#41 + n200;
          |FINSI;
          |SI #102#9 [ #104#41;
               #104#38 = 0;
          |SINO;
               #104#43 = (0.35 * (#102#9 - #104#41)) ! EURODB;
               |SI #104#43 < #104#38;
                    nNume1 = #104#38;
                    #104#38 = #104#43;
                    #104#43 = nNume1;
                    #104#42 = "SI";
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO BaseLiquidable;
     #104#35 = #104#28 - (#104#13 + #104#14 + #102#13 + #104#34 + #104#45);
     |SI #104#35 < 0;
          #104#35 = 0;
     |FINSI;
     #104#36 = 0;
     #104#37 = 0;
     #104#38 = 0;

     |SI #102#12 ! 0;|Y #102#12 < #104#35;
          nEsBases = #104#35 - #102#12; |HAZ Escala;   #104#36 = nEsCuota;
          nEsBases = #102#12;           |HAZ Escala;   #104#37 = nEsCuota;
          #104#38 = #104#36 + #104#37;
     |SINO;
          nEsBases = #104#35;           |HAZ Escala;   #104#38 = nEsCuota;
     |FINSI;
|FPRC;

|PROCESO SituacionLaboral;
     #104#34 = 0;                  || reduccion por situacion laboral

     |SI #102#2 = "P";
          #104#34 = n100;        || pensionista
     |FINSI;

     |SI #102#2 = "D";
          #104#34 = n200;        || desempleado
     |FINSI;

     |SI #104#19 > 2;
          #104#34 = #104#34 + n100;   || familia numerosa
     |FINSI;

|FPRC;

|PROCESO MinimoFamiliarAsc;
     #104#45 = 0;                       || reduccion minimo familiar
     |PDEFECTO #104, 50, 53;

     |PARA nPara1 = 52; |SI nPara1 [ 61; |HACIENDO nPara1 = nPara1 + 1;
          |SI #102nPara1 ! 0;
               nPara2 = nPara1 + 10;

               #104#50 = #104#50 + ((n100 / #102nPara1) ! 0);

               |SI #102nPara2 = "1";    || disc. >33 <65
                    #104#51 = #104#51 + ((n300 / #102nPara1) ! 0);
               |FINSI;

               |SI #102nPara2 = "2";    || disc. >65
                    #104#52 = #104#52 + ((n600 / #102nPara1) ! 0);
               |FINSI;
          |FINSI;
     |SIGUE;

     #104#45 = #104#50 + #104#51 + #104#52;
|FPRC;

|PROCESO MinimoFamiliar;
     #104#14 = 0;                       || reduccion minimo familiar
     |PDEFECTO #104, 30, 34;

/*
     nNume1 = 0;
     |PARA nPara1 = 20; |SI nPara1 [ 29; |HACIENDO nPara1 = nPara1 + 1;
          |SI #102nPara1 ! 0;
               nPara3 = nPara1 + 22;
               nNume1 = nNume1 + 1;
               |SI nNume1 [ 2;
                    |SI #102nPara3 = "N";
                         #104#29 = #104#29 + 100000;
                    |SINO;
                         #104#29 = #104#29 + 200000;
                    |FINSI;
               |SINO;
                    |SI #102nPara3 = "N";
                         #104#29 = #104#29 + 150000;
                    |SINO;
                         #104#29 = #104#29 + 300000;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
*/

     #104#30 = nEl20 * n12;      || >3 <16
     #104#31 = nEl21 * n25;      || >0 <3
     #104#32 = nEl22 * n150;     || disc. >33 <65
     #104#33 = nEl23 * n300;     || disc. >65

     #104#14 = #104#29 + #104#30 + #104#31 + #104#32 + #104#33;
|FPRC;

|PROCESO Reduccion18;
     #104#12 = 0;                                 || reduccion art.18
     #104#27 = #102#9 - (#102#10 + #102#11 + #102#127);      || rend.neto trabajo
     |SI #104#27 [ n1350;
          #104#12 = n500;
     |SINO;
          |SI #104#27 > n2000;
               #104#12 = n375;
          |SINO;
               #104#12 = n500 - (0.1923 * (#104#27 - n1351));
          |FINSI;
     |FINSI;

     |SI #104#3 = "S";                       || discapacitado
          |SI #104#4 = "2";                  || >65
               #104#12 = #104#12 * 2.75;
          |SINO;
               |SI #104#4 = "1";
                    |SI #102#8 = "S";
                         #104#12 = #104#12 * 2.25;     || >33 y <65 con ayuda
                    |SINO;
                         #104#12 = #104#12 * 1.75;     || >33 y <65 sin ayuda
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Descendientes190;
     |PDEFECTO #104, 19, 25;
     #104#19 = nFam01;   || menores de 25 (26)
     #104#20 = nFam02;   || de 3 a 16 (25)
     #104#21 = nFam03;   || de 0 a 3 (24)
     #104#22 = nFam04;   || de 33 a 65 (27)
     #104#23 = nFam05;   || mas de 65 (28)

     nEl20 = #104#20;    || minimo familiar
     nEl21 = #104#21;    || minimo familiar
     nEl22 = #104#22;    || minimo familiar
     nEl23 = #104#23;    || minimo familiar
|FPRC;

|PROCESO Suma19;
     #104#19 = #104#19 + 1;   || hijos con reduccion
     |SI #104#19 [ 2;
          |SI #102nPara3 = "N";
               #104#29 = #104#29 + n100;
          |SINO;
               #104#29 = #104#29 + n200;
          |FINSI;
     |SINO;
          |SI #102nPara3 = "N";
               #104#29 = #104#29 + n150;
          |SINO;
               #104#29 = #104#29 + n300;
          |FINSI;
     |FINSI;
|FPRC;


|PROCESO Ordenados001;
     nNume1 = 0;
     |PARA nPara1 = 20; |SI nPara1 [ 29; |HACIENDO nPara1 = nPara1 + 1;
          |SI #102nPara1 ! 0;
               |SI nNume1 = 0;
                    nNume1 = #102nPara1;
               |FINSI;
               |SI nNume1 > #102nPara1;
                    |MENAV "0000Asegurese de que los descendientes esten ordenados por fecha de nacimiento.";
                    |SAL;
               |SINO;
                    nNume1 = #102nPara1;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|| *********** PROCESOS PARA LA REGULARIZACION ESPECIAL EN ENERO ************

|PROCESO dsm190li_1;
     swEl190 = 1;
     |SI aEspe = "N";
          nBase = nBase + #dsm190li#16;      || bases
          nCuot = nCuot + #dsm190li#17;      || cuota
          || tdescue = tdescue + #dsm190li#13; || seg.social
          || nDescrip="(Dinerarias)";
          || SI #0#5 > #dsm190li#3;|Y #dsm190li#3 ! 0;
          ||     nBase_Ant = nBase_Ant + #dsm190li#7;      || bases periodos anteriores
          ||     nCuot_Ant = nCuot_Ant + #dsm190li#8;      || cuota periodos anteriores
          ||     tdescue_Ant = tdescue_Ant + #dsm190li#13;  || seg.social periodos anteriores
          ||     nDescrip="(Dinerarias)";
          || FINSI;
     |SINO;
          nBase = nBase + #dsm190li#18;      || bases
          nCuot = nCuot + #dsm190li#19;     || cuota
          || nDescrip="   (Especie)";
          || nIngresoCR=nIngresoCR+#dsm190li#11;  || ingreso a Cta repercutido S/N
          || SI #0#5 > #dsm190li#3; |Y #dsm190li#3 ! 0;
          ||     nBase_Ant = nBase_Ant + #dsm190li#9;      || bases periodos anteriores
          ||     nCuot_Ant = nCuot_Ant + #dsm190li#10;      || cuota periodos anteriores
          ||     nDescrip="   (Especie)";
          ||     |SI #dsm190li#13="S";
          ||          nIngresoCR_Ant=nIngresoCR_Ant+#dsm190li#11;  || ingreso a Cta repercutido S/N
          ||     |FINSI;
          || FINSI;
     |FINSI;
|FPRC;

|DEFBUCLE dsm190li;
     #dsm190li#1;
     ;
     nElCodigo, nElAnyIRPFAnt, 99, 190, 0, 0, #102#0, 0000, aClave, aDSubClave, 0;
     nElCodigo, nElAnyIRPFAnt, 99, 190, 0, 0, #102#0, 0000, aClave, aHSubClave, 9;
     ;
     NULL, dsm190li_1;
|FIN;

|PROCESO dsm19001;
     swEl190 = 1;
     |SI aEspe = "N";
          nBase = nBase + #dsm19001#16;      || bases
          nBase = nBase + #dsm19001#65;      || bases
          nCuot = nCuot + #dsm19001#17;      || cuota
          nCuot = nCuot + #dsm19001#66;      || cuota
     |SINO;
          nBase = nBase + #dsm19001#18;      || bases
          nBase = nBase + #dsm19001#67;      || bases
          nCuot = nCuot + #dsm19001#19;     || cuota
          nCuot = nCuot + #dsm19001#68;     || cuota
     |FINSI;
|FPRC;

|DEFBUCLE dsm19001;
     #dsm19001#1;
     ;
     nElCodigo, nElAnyIRPFAnt, 99, 190, 0, 0, #102#0, 0000, aClave, aDSubClave, 0;
     nElCodigo, nElAnyIRPFAnt, 99, 190, 0, 0, #102#0, 0000, aClave, aHSubClave, 9;
     ;
     NULL, dsm19001;
|FIN;

|PROCESO dsmom026;
     nElCodigo = #dsmom026#0;
|FPRC;

|DEFBUCLE dsmom026;
     #dsmom026#1;
     ;
     00001, #102#41;
     99999, #102#41;
     ;
     NULL, dsmom026;
|FIN;

|PROCESO acumula;
/*
     |ABRE #labtraba;
     #labtraba#0 = #101#1;
     #labtraba#1 = #101#2;
     |LEE 000#labtraba.=;
     |CIERRA #labtraba;
*/
     |SI #labtraba#99 ! "L";
          nBase = 0;
          nCuot = 0;
          aClave = #labtraba#99;
          aDSubClave = #labtraba#102;
          aHSubClave = #labtraba#102;
          |SI nElAnyIRPFAnt = 2015; |Y aClave = "A";
               aDSubClave = "01";
               aHSubClave = "02";
          |FINSI;
          aEspe = #labtraba#105;
          nElCodigo = #102#41;

          |BUCLE dsmom026;

          |SI nElAnyIRPFAnt [ 2015;
              |BUCLE dsm190li;
          |FINSI;

          |SI nElAnyIRPFAnt ] 2016;
              |BUCLE dsm19001;
          |FINSI;

          nRete = ((nCuot / nBase) * 100);
          nRete = nRete - 0.005;
          |SI nRete < 0; nRete = 0; |FINSI;
          nRete = nRete ! 2;       || trunco a dos decimales

          nRete1_PA = nRete;
     |FINSI;

     |SI #labtraba#100 ! "L";
          nBase = 0;
          nCuot = 0;
          aClave = #labtraba#100;
          aDSubClave = #labtraba#103;
          aHSubClave = #labtraba#103;
          |SI nElAnyIRPFAnt = 2015; |Y aClave = "A";
               aDSubClave = "01";
               aHSubClave = "02";
          |FINSI;
          aEspe = #labtraba#106;

          |SI nElAnyIRPFAnt [ 2015;
              |BUCLE dsm190li;
          |FINSI;

          |SI nElAnyIRPFAnt ] 2016;
              |BUCLE dsm19001;
          |FINSI;

          nRete = ((nCuot / nBase) * 100);
          nRete = nRete - 0.005;
          |SI nRete < 0; nRete = 0; |FINSI;
          nRete = nRete ! 2;       || trunco a dos decimales

          nRete2_PA = nRete;
          |SI nRete2_PA < 0;
               nRete2_PA = 0;
          |FINSI;
     |FINSI;

     |SI #labtraba#101 ! "L";
          nBase = 0;
          nCuot = 0;
          aClave = #labtraba#101;
          aDSubClave = #labtraba#104;
          aHSubClave = #labtraba#104;
          |SI nElAnyIRPFAnt = 2015; |Y aClave = "A";
               aDSubClave = "01";
               aHSubClave = "02";
          |FINSI;
          aEspe = #labtraba#107;

          |SI nElAnyIRPFAnt [ 2015;
              |BUCLE dsm190li;
          |FINSI;

          |SI nElAnyIRPFAnt ] 2016;
              |BUCLE dsm19001;
          |FINSI;

          nRete = ((nCuot / nBase) * 100);
          nRete = nRete - 0.005;
          |SI nRete < 0; nRete = 0; |FINSI;
          nRete = nRete ! 2;       || trunco a dos decimales

          nRete3_PA = nRete;
          |SI nRete3_PA < 0;
               nRete3_PA = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Regulariza_Enero;
     swTipoMedio = 0;
     |SI #nomir009#19 = 2; |Y nElMesIRPF = 1;
          nRete1_PA = 0;
          nRete2_PA = 0;
          nRete3_PA = 0;
          swEl190 = 0;

          nElAnyIRPFAnt = nElAnyIRPF - 1;

          |HAZ acumula;

          |SI swEl190 = 0;
               fFech1 = #labtraba#36;
               aAlfa1 = nElAnyIRPF;
               aAlfa1 = "01.01." + aAlfa1;
               fFech2 = aAlfa1;
               aAlfa2 = #labtraba#0; aAlfa2 = "00000" + aAlfa2; aAlfa2 = aAlfa2 % -105;
               aAlfa3 = #labtraba#1; aAlfa3 = "00000" + aAlfa3; aAlfa3 = aAlfa3 % -105;
               |SI fFech1 < fFech2;     || alta antes de este a¤o y sin 190
                    aAlfa1 = "    ATENCION: Trabajador " + aAlfa2 + "." + aAlfa3;
                    aAlfa1 = aAlfa1 + " no tiene calculado Mod. 190. Media IRPF del a¤o ";
                    aAlfa1 = aAlfa1 + "anterior inexacta";
                    |MENAV aAlfa1;
               |FINSI;
          |FINSI;

          |SI nTIPO < nRete1_PA;
               nTIPOEst = nTIPO;   || me lo guardo para luego
               nTIPO = nRete1_PA;
               |SI nTIPO < 0;
                    nTIPO = 0;
               |FINSI;
               swTipoMedio = 1;
          |FINSI;
          nIMPORTE = nRETRIB * (nTIPO / 100);
     |FINSI;
|FPRC;

||        ******************** PROCESOS IRPF ************************

|PROCESO GuardaDatosReg;
     |ABRE #nomir012;
     #nomir012#1 = #2#0;      || Empresa
     #nomir012#2 = #2#1;      || Trabajador
     #nomir012#3 = nElAnyIRPF;      || A¤o
     #nomir012#4 = nElMesIRPF;      || Mes
     |LEE 101#nomir012.=;
     |SI FSalida = 0;
          || lo que me guardo para el mes que viene
          #nomir012#91 = #102#16;       || guarda retribuciones ya satisfechas
          #nomir012#92 = #102#17;       || guarda retenciones ya satisfechas
          #nomir012#93 = #104#9;        || guarda ingresos iniciales
          #nomir012#94 = #104#26;       || guarda cuota inicial
          #nomir012#95 = #102#115;      || Ceuta/Melilla S/M
          #nomir012#96 = #104#35;       || guarda base inicial
          #nomir012#97 = nMINCON + nMINDES + nMINAS + nMINDIS; || minimo pers. y fam.
          #nomir012#98 = #labtraba#30;  || guarda tipo inicial

          |SI nElAnyIRPF [ 2010;
               |SI #104#74 ! 0;
                    #nomir012#99 = "S";       || minoracion vivienda S/N
               |SINO;
                    #nomir012#99 = "N";       || minoracion vivienda S/N
               |FINSI;
          |SINO;
               |SI #104#74 ! 0;
                    #nomir012#99 = #104#73;   || minoracion vivienda S/N
                    #nomir012#110 = #104#75;  || minoracion vivienda S/N
                    |SI #nomir012#99 = "N";
                         #nomir012#99 = aMINORADO2;   || minoracion vivienda S/N
                    |FINSI;
                    |SI #nomir012#110 = "N";
                         #nomir012#110 = aMINORADO1;  || minoracion vivienda S/N
                    |FINSI;
               |FINSI;
          |FINSI;

          #nomir012#100 = #104#74;      || guarda importe ded. vivienda
          |SI nCAUSA2 ! 0;
               nCAUSA = nCAUSA2;
               nCAUSA2 = 0;
          |FINSI;
          #nomir012#103 = nCAUSA;       || guarda causa regularizacion
          #nomir012#104 = #103#3;       || guarda seg. social estimada
          |SI nElAnyIRPF [ 2010;
               #nomir012#105 = aPRESVIV;     || se ha practicado minoracion viv.
          |SINO;
               #nomir012#105 = aPRESVIV2;     || se ha practicado minoracion viv.
               #nomir012#111 = aPRESVIV1;     || se ha practicado minoracion viv.
          |FINSI;
          #nomir012#106 = #nomir009#15;
          #nomir012#107 = #labtraba#29;
          #nomir012#108 = #nomir003#122;
          || #nomir012#109 = #nomir003#5;
          #nomir012#109 = #labtraba#111;
          #nomir012#112 = #nomir003#128;

          |GRABA 020#nomir012.a;
          |LIBERA #nomir012;
     |FINSI;
     |CIERRA #nomir012;

     |ABRE #nomcalca;
     #nomcalca#0 = #2#0;      || Empresa
     #nomcalca#1 = #2#1;      || Trabajador
     #nomcalca#2 = nElMesIRPF;    || Mes
     |SI swFiniq = 1;
          #nomcalca#3 = 2;         || Tipo
     |SINO;
          #nomcalca#3 = 0;         || Tipo
     |FINSI;
     |LEE 101#nomcalca.=;
     |SI FSalida = 0;
          nNume = #labtraba#30 - nTIPO;

          |SI nElAnyIRPF [ 2010;
               |SI -0.05 [ nNume; |Y nNume [ 0.05;
                    #nomcalca#123 = aPRESVIV;
               |SINO;
                    #nomcalca#123 = aPRESVIVa;
               |FINSI;
          |SINO;
               |SI -0.05 [ nNume; |Y nNume [ 0.05;
                    |SI aPRESVIV1 = "S"; |O aPRESVIV2 = "S";
                         |SI aPRESVIV1 = "S";
                              #nomcalca#123 = "G";
                         |FINSI;
                         |SI aPRESVIV2 = "S";
                              #nomcalca#123 = "S";
                         |FINSI;
                    |SINO;
                         #nomcalca#123 = "N";
                    |FINSI;
               |SINO;
                    |SI aPRESVIV1a = "S"; |O aPRESVIV2a = "S";
                         |SI aPRESVIV1a = "S";
                              #nomcalca#123 = "G";
                         |FINSI;
                         |SI aPRESVIV2a = "S";
                              #nomcalca#123 = "S";
                         |FINSI;
                    |SINO;
                         #nomcalca#123 = "N";
                    |FINSI;
               |FINSI;
          |FINSI;
          |GRABA 020#nomcalca.a;
          |LIBERA #nomcalca;
     |FINSI;
     |CIERRA #nomcalca;
|FPRC;

|PROCESO Punto05Multi;
     |SI #0#2 [ 2006; |HAZ Punto05Multi_06; |ACABA; |FINSI;

     |ABRE #102;
     |ABRE #104;
     #102#0 = #0#0;
     #102#40= #0#2;
     #102#41= #0#3;
     |LEE 000#102=;
     |SI FSalida = 0;
          |SI #102#1 > 100; #102#1 = 0; |FINSI;
          |DDEFECTO #104;
          #104#0 = #0#0;
          #104#1 = #0#2;
          #104#44= #0#3;
          |LEE 101#104=;
          nEstado = FSalida;
          nGuardaTipo = #104#25;
|| MULTI
          |HAZ ConstantesEuro;
          |HAZ Inicializa;
          |HAZ SinCalculo;
          |HAZ Descendientes;
          |HAZ Ascendientes;
          |HAZ GastosDeducibles;
          |HAZ Rendimiento;
          |HAZ ReduRendTrabajo;
          |HAZ ReduCopaAmerica;
          |HAZ RendiNetoRedu;
          |HAZ ReduccPen;
          |HAZ ReduccMasDeDos;
          |HAZ ReduccDes;
          |HAZ MinimoPers_Fami;
          |HAZ ReduccPerceptor;
          |HAZ Mes2012;
          |HAZ Mes2015;
          |HAZ Base;
          |HAZ Resultados;
          |HAZ CuotaRetencion;
          |HAZ TipoRetencion;
          |HAZ Regulariza;
          |HAZ Regulariza_Enero;
          |HAZ GuardaDatos;

          |SI nEstado = 0;    |GRABA 020#104a;    |FINSI;
          |SI nEstado ! 0;    |GRABA 020#104n;    |FINSI;
          |HAZ Guarda105;
          |LIBERA #104;
          |SI nGuardaTipo ! #104#25;|O #0#5 = "N";
          /*
               |SI #102#18 = 0;|Y #102#19 = 0;
                    swNo = 0;
               |FINSI;
          */
               #102#18 = #104#9;        || guarda ingresos iniciales
               #102#19 = #104#26;       || guarda cuota inicial
               #102#117 = #104#35;      || guarda base inicial
               #102#118 = #104#25;      || guarda tipo inicial
               #102#123 = nMINCON + nMINDES + nMINAS + nMINDIS;
               #102#124 = #104#73;      || ded. vivienda S/N 2010 o anterior
               #102#125 = #104#74;      || guarda importe ded. vivienda
               #102#126 = #104#75;      || ded. vivienda S/N 2011
               #102#128 = #104#77;      || Deduccion Art. 80 Bis LIRPF
               |GRABA 020#102a;
          |FINSI;
          |HAZ GuardaDatosReg;
     |SINO;
          |SI nDiferencias = 0;
               || para que no me lo diga en la comprobacion del 190
               |MENAV "    Parametros de calculo inaccesibles ...";
          |FINSI;
     |FINSI;
     |LIBERA #102;
     |CIERRA #102;
     |CIERRA #104;
|FPRC;

|PROCESO nomir012;
     nVivienda = #nomir012#100;
|FPRC;

|DEFBUCLE nomir012;
     #nomir012#3;
     ;
     aVDNI, nVEmp, nVAny, 01;
     aVDNI, nVEmp, nVAny, 12;
     ;
     NULL, nomir012;
|FIN;

|PROCESO Vivienda;
     aVDNI = (aVDNI + "           ") % 112;
     nVivienda = 0;
     |BUCLE nomir012;
|FPRC;

|PROCESO nomirz15_sup;
     #nomirz15#44 = #0#3;
     #nomirz15#0 = #0#0;
     #nomirz15#1 = #0#2;
     #nomirz15#75 = 12
|FPRC;

|PROCESO nomirz15_inf;
     #nomirz15#44 = #0#3;
     #nomirz15#0 = #0#0;
     #nomirz15#1 = #0#2;
     #nomirz15#75 = 01;
|FPRC;

|PROCESO Borra;
     |ABRE #nomirz15;
     |PARA nNume = 1; |SI nNume [ 12; |HACIENDO nNume = nNume + 1;
          #nomirz15#44 = #0#3;
          #nomirz15#0 = #0#0;
          #nomirz15#1 = #0#2;
          #nomirz15#75 = nNume;
          |LEE 000#nomirz15.=;
          |SI FSalida = 0;
               |SI #nomirz15#17 = "X";
                    |BORRA 020#nomirz15.a;
                    |LIBERA #nomirz15;
               |FINSI;
          |FINSI;
     |SIGUE;
     |CIERRA #nomirz15;
|FPRC;

|PROCESO Rellena;
     |ABRE #nomirz15;
     |PARA nNume = 1; |SI nNume [ 12; |HACIENDO nNume = nNume + 1;
          #nomirz15#44 = #0#3;
          #nomirz15#0 = #0#0;
          #nomirz15#1 = #0#2;
          #nomirz15#75 = nNume;
          |LEE 000#nomirz15.=;
          |SI FSalida ! 0;
               |DDEFECTO #nomirz15;
               #nomirz15#44 = #0#3;
               #nomirz15#0 = #0#0;
               #nomirz15#1 = #0#2;
               #nomirz15#75 = nNume;
               #nomirz15#17 = "X";
               |GRABA 020#nomirz15.n;
               |LIBERA #nomirz15;
          |FINSI;
     |SIGUE;
     |CIERRA #nomirz15;
|FPRC;

|PROCESO Punto05;
     || en este punto si es desde el menu tengo que hacer lo nuevo que ha
     || propuesto Jose

     |SI swDesdeMenu ! 0;
          |HAZ Rellena;
          |ENTCOLUMNA #1#nomirz15, 4, 4, 12, 1, nomirz15_inf, nomirz15_sup;
          |HAZ Borra;
          |ACABA;
     |FINSI;
     |SI nDiferencias = 1;
          #0#0 = aVDNI;
          #0#2 = nVAny;
          #0#3 = nVEmp;
     |FINSI;

     |SI #0#2 [ 2006; |HAZ Punto05_06; |ACABA; |FINSI;

     |ABRE #102;
     |ABRE #104;
     #102#0 = #0#0;
     #102#40= #0#2;
     #102#41= #0#3;
     |LEE 000#102=;
     |SI #102#1 > 100; #102#1 = 0; |FINSI;
     |SI FSalida = 0; |O eaVengoDe = "nomesfin";
          || si vengo del informe de comprobacion, aunque no tenga datos
          || de IRPF adelante
          |SI nDiferencias = 0;
               |PUSHV 0501 2380;
               |PINPA #0#104;
               |HAZ Ordenados001;
          |FINSI;
          |DDEFECTO #104;
          #104#0 = #0#0;
          #104#1 = #0#2;
          #104#44= #0#3;
          |LEE 101#104=;
          nEstado = FSalida;
          nGuardaTipo = #104#25;

          |HAZ ConstantesEuro;
          |HAZ Inicializa;

          |SI nDiferencias = 0;
               |HAZ SinCalculo;
          |SINO;
               |SI nFam00 = 0;
                    |HAZ SinCalculo;
               |SINO;
                    |HAZ SinCalculo190;
               |FINSI;
          |FINSI;

|| MONO
          |HAZ Descendientes;
          |HAZ Ascendientes;
          |HAZ GastosDeducibles;
          |HAZ Rendimiento;
          |HAZ ReduRendTrabajo;
          |HAZ ReduCopaAmerica;
          |HAZ RendiNetoRedu;
          |HAZ ReduccPen;
          |HAZ ReduccMasDeDos;
          |HAZ ReduccDes;
          |HAZ MinimoPers_Fami;
          |HAZ ReduccPerceptor;
          |HAZ Mes2012;
          |HAZ Mes2015;
          |HAZ Base;
          |HAZ Resultados;
          |HAZ CuotaRetencion;
          |HAZ TipoRetencion;
          |HAZ Regulariza;
          |HAZ Regulariza_Enero;
          |HAZ GuardaDatos;

          |SI nEstado = 0;    |GRABA 020#104a;    |FINSI;
          |SI nEstado ! 0;    |GRABA 020#104n;    |FINSI;

          |SI nDiferencias = 0;
               |PINDA #0#104;
               |PAUSA;
               |LIBERA #104;
               |POPV;

               |SI nGuardaTipo ! #104#25;|O #0#5 = "N";
                    #0#5 = "N";
                    |GRABA 020#0a;
                    |SI FSalida = 0;
                         |PINTA #0#5;
                    |FINSI;
                    /*
                    |SI #102#18 = 0;|Y #102#19 = 0;
                         swNo = 0;
                    |FINSI;
                    */
                    #102#18 = #104#9;        || guarda ingresos iniciales
                    #102#19 = #104#26;       || guarda cuota inicial
                    #102#117 = #104#35;      || guarda base inicial
                    #102#118 = #104#25;      || guarda tipo inicial
                    #102#123 = nMINCON + nMINDES + nMINAS + nMINDIS;
                    #102#124 = #104#73;      || ded. vivienda S/N 2010 o anterior
                    #102#125 = #104#74;      || guarda importe ded. vivienda
                    #102#126 = #104#75;      || ded. vivienda S/N 2011
                    #102#128 = #104#77;      || Deduccion Art. 80 Bis LIRPF
                    |SI nModoExt ! 4;
                    || para que no grabe desde el menu desde el punto 4
                         |GRABA 020#102a;
                    |FINSI;
               |FINSI;
          |SINO;
               |LIBERA #104;
               nCuotNueva = #104#26;

/*
               || esto ya no es necesario, antes buscaba aqui si habia
               || tenido deduccion por vivienda, ahora esto lo hace Manolo
               || en el calculo del 190 y de ahi me lo traigo yo
               || aun asi sigo entrando en el bucle por saber el importe
               || deducido y llevarmelo al lineal de NIFs del 190, aunque de
               || momento alli no lo uso para nada

               |SI swVuelta = 0;
                    |HAZ Vivienda;
               |FINSI;
*/
               |SI swVivienda ! 0;
                    |HAZ Vivienda;
                    |SI #104#73 = "S"; |O #104#75 = "S";
                         nCuotaMin = #104#26;
                    |SINO;
                         nCuotaMax = #104#26;
                    |FINSI;
                    swVuelta = swVuelta + 1;
               |FINSI;
          |FINSI;
     |SINO;
          |SI nDiferencias = 0;
               || para que no me lo diga en la comprobacion del 190
               |MENAV "    Parametros de calculo inaccesibles ...";
          |FINSI;
     |FINSI;
     |LIBERA #102;
     |CIERRA #102;
     |CIERRA #104;
|FPRC;

|PROCESO Inicializa;
     nRNT = 0;
     nMINPER = 0;
     nRED46 = 0;
     nDISTRA = 0;
     nPROLONLAB = 0;
     nMOVILGEO = 0;
     n65PER = 0;
     n75PER = 0;
     nDISPER = 0;
     nASISPER = 0;
     nPENSION = 0;
     nDESEM = 0;
     nCUIDADO = 0;
     nNUMDES = 0;
     nMINDES = 0;
     nMINDESG = 0;
     nMINDES3 = 0;
     nHIJOS = 0;
     nDISDES = 0;
     nASISDES = 0;
     n65AS = 0;
     nNUMAS = 0
     n75AS = 0;
     nDISAS = 0;
     nASISAS = 0;
     nREDU = 0;
     nBASE = 0;
     nRED65 = 0;
     nRED75 = 0;
     nREDIS = 0;
     nRETRIB = 0;
     aEXENTOS = "";
     nCUOTA = 0;
     nTIPO = 0;
     nLIMITE = 0;
     nANUALIDADES = #102#12;       || anualidades a favor de los hijos
     nTIPO = 0;
     |SI nDiferencias = 1;
          |SI #102#5 = 0;          || no tengo datos NIF (trabajador agrario
               #102#5 = nTipoRel;  || eventual por ejemplo) para hacer la com-
          |FINSI;                  || probacion cojo lo que me venga del proceso
          nCONTRATO = #102#5;      || so donde lo he llamado
     |SINO;
          nCONTRATO = #labtraba#111;
     |FINSI;
     nIMPORTE = 0;
     nRETRIBa   = 0;
     nBASEA     = 0;
     nTIPOA     = 0;
     nIMPORTEA  = 0;
     nPERCIBIDO = 0;
     nRETENIDO  = 0;
     aREVISAR   = "N";
     nINCREIMPORTE = 0;
     nINCREBASE = 0;
     nREDCOPA = 0;
     nRED20 = 0;
     nRNTREDU = 0;
     nMINCON = 0;
     nMINAS = 0;
     nMINDISC = 0;
     nMDISDEAS = 0;
     nMINDIS = 0;
     nMINPERFA = 0;
     nMISDIS = 0;
     nCUOTA1_1 = 0;
     nCUOTA1_2 = 0;
     nDIFERENCIA = 0;
     nMINPERFAA = 0;
     nINCREBASEMIN = 0;
     nTIPOPREVIO = 0;
     nTIPOPREVIOR = 0;
     nTIPOPREVIOCM = 0;
     nTIPOPREVIOCMR = 0;
     nIMPORTEPREVIO = 0;
     nTIPOREG = 0;
     nDIFERENCIAPOSITIVA = 0;
     nCAUSA2 = 0;
     nCAUSAGuarda = 0;
     nDEDUCCION = 0;
     aPRESVIV1Guarda = "";
     aPRESVIV2Guarda = "";

     aMOVIL = "";
     nGASTOSGEN = 0;
     nCAMBIORESI = 0;
     nINCREGASMOVIL = 0;
     nINCREGASDISTRA = 0;
     nOTROSGASTOS = 0;
     nCOTIZACIONES = 0;
     nIMPORTEREG = 0;
|FPRC;

|PROCESO SinCalculo;
     #104#2 = #102#1;        || edad
     |SI #104#2 > 100;
          #104#2 = 0;
     |FINSI;
     #104#3 = #102#6;        || discapacitado S/N
     #104#4 = #102#7;        || grado 1-2
     #104#5 = #102#8;        || necesita ayuda S/N
     #104#6 = #102#2;        || situacion laboral
     ||#104#7 = #102#5;        || tipo de contrato
     #104#7 = #labtraba#111;        || tipo de contrato
     #104#8 = #102#3;        || situacion familiar
     |SI nDiferencias = 1;
          || vengo del 190 para comprobar diferencias
          #104#7 = #102#5;        || tipo de contrato
          #102#9 = nBaseHist; || ingresos anuales
          #102#11 = nSSHist;   || gastos anuales 17.3
          |SI eaVengoDe ! "nomesfin";
               || estas tres variables con anualidades hijos o conyuge, solo
               || si vengo del calculo de diferencias del 190, que por aqui
               || pasa tambien el calculo de diferencias de la nomina
               #102#10 = nGasto1;   ||
               #102#12 = nGasto3;   || Hijo
               #102#13 = nGasto4;   || anualidades conyuge
          |FINSI;
          #102#15 = "N";       || no regularices

          || por algun motivo, esta variable  en lugar de ponerse a cero en el
          || proceso Inicializa, lo asigna alli (solo este, curioso)
          || asi que en caso de que venga del 190, lo pongo aqui otra vez,
          || por si hubiera cambiado
          nANUALIDADES = #102#12;       || anualidades a favor de los hijos
     |FINSI;
     #104#9  = #102#9;        || ingresos anuales
     #104#10 = #102#10;       || reduccion 18.2
     #104#11 = #102#11;       || gastos anuales 19.3
     #104#15 = #102#13;       || anualidades conyuge
     #104#16 = #102#12;       || anualidades hijos
     #104#17 = #102#15;       || regularizando S/N
     #104#18 = #102#14;       || Residencia Ceuta y Melilla S/N
     #104#56 = #102#14;       || Rendimientos Ceuta y Melilla S/N
     #104#54 = #102#73;       || Movilidad Geografica S/N
     #104#53 = #102#72;       || Prolongacion Actividad Laboral S/N
     #104#73 = #102#124;      || Reduccion Inversion Vivienda Habitual
     #104#75 = #102#126;      || Reduccion Inversion Vivienda Habitual
     #104#76 = #102#127;      || reduccion 18.3

     |SI nDiferencias = 1; |Y eaVengoDe = "nomesfin";
          || estas dos variables me vienen cargadas del nomesfin para
          || tener en cuenta la deduccion por Vivienda aunque tenga puesto
          || en parametros de calculo que NO tiene vivienda

          || Eso es porque del nomir012 se ve que si ue tiene deduccion
          || por vivienda pero por ejemplo se la han quitado a mitad de a¤o

          |SI #102#124 = "N"; |Y eaVivienda1 = "S";
               #102#124 = "S";
               #104#73 = #102#124;
          |FINSI;
          |SI #102#126 = "N"; |Y eaVivienda2 = "S";
               #102#126 = "S";
               #104#75 = #102#126;
          |FINSI;
     |FINSI;

     nRETRIB = #102#9;
     nIRREGULAR1 = #102#10;
     nIRREGULAR2 = #102#127;
     nGASTOS = #102#11;

     |SI nElAnyIRPF [ 2010;
          aPRESVIV = #102#124;     || se acoge a reduccion por prestamo para
          |SI swVuelta = 1;
               |SI #104#73 = "S";
                    #104#73 = "N";
                    aPRESVIV = "N";
               |SINO;
                    #104#73 = "S";
                    aPRESVIV = "S";
               |FINSI;
          |FINSI;
     |SINO;
          aPRESVIV2 = #102#124;    || red. vivienda, regimen Transitorio 2010
          aPRESVIV1 = #102#126;    || red. vivienda, regimen General 2011
          |SI swVuelta = 1;
               || regimen transitorio (2009 y 2010)
               |SI #102#124 = "S";
                    |SI #104#73 = "S";
                         #104#73 = "N";
                         aPRESVIV2 = "N";
                    |SINO;
                         #104#73 = "S";
                         aPRESVIV2 = "S";
                    |FINSI;
               |FINSI;

               || regimen general (2011)
               |SI #102#126 = "S";
                    |SI #104#75 = "S";
                         #104#75 = "N";
                         aPRESVIV1 = "N";
                    |SINO;
                         #104#75 = "S";
                         aPRESVIV1 = "S";
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO SinCalculo190;
     #104#2  = enEdad;        || edad
     #104#3  = eaDiscap;      || discapacitado S/N
     #104#4  = eaGrado;       || grado 1-2
     #104#5  = #102#8;        || necesita ayuda S/N
     #104#6  = #102#2;        || situacion laboral
     #104#7  = eaTContr;      || tipo de contrato
     #104#8  = eaSitFam;      || situacion familiar
     |SI nDiferencias = 1;
          || vengo del 190 para comprobar diferencias
          #102#9  = nBaseHist;        || ingresos anuales
          #102#11 = nSSHist;       || gastos anuales 17.3
          #102#10 = nGasto1;   ||
          #102#12 = nGasto3;   || Hijo
          #102#13 = nGasto4;   || anualidades conyuge
          #102#15 = "N";       || no regularices
          nANUALIDADES = #102#12;       || anualidades a favor de los hijos
     |FINSI;
     #104#9  = #102#9;        || ingresos anuales
     #104#10 = #102#10;       || reduccion 18.2
     #104#11 = #102#11;       || gastos anuales 19.2
     #104#15 = #102#13;       || anualidades conyuge
     #104#16 = #102#12;       || anualidades hijos
     #104#17 = "N";           || regularizando S/N
     #104#18 = eaCeMel;       || Ceuta y Melilla S/N
     #104#56 = #102#14;       || Rendimientos Ceuta y Melilla S/N
     #104#54 = #102#73;       || Movilidad Geografica S/N
     #104#53 = #102#72;       || Prolongacion Actividad Laboral S/N
     #104#76 = #102#127;      || reduccion 18.3

     nRETRIB = #102#9;
     nIRREGULAR1 = #102#10;
     nIRREGULAR2 = #102#127;
     nGASTOS = #102#11;
     |SI nElAnyIRPF [ 2010;
          aPRESVIV = #102#124;     || se acoge a reduccion por prestamo para
     |SINO;
          aPRESVIV2 = #102#124;    || red. vivienda, regimen Transitorio 2010
          aPRESVIV1 = #102#126;    || red. vivienda, regimen General 2011
     |FINSI;
|FPRC;

|PROCESO GastosDeducibles;
     |SI #0#2 < 2015;
          |ACABA;
     |FINSI;

     || A. caracter general
     nGASTOSGEN = 2000;

     || B. movilidad geografica

     aMOVIL = #102#73;
     aAlfa = #102#74;
     aAlfa = aAlfa % -104;
     nCAMBIORESI = aAlfa;
     |SI nCAMBIORESI [ 2015;
          |SI aMOVIL = "S"; |Y nCAMBIORESI = #0#2;
               nINCREGASMOVIL = 2000;
          |SINO;
               nINCREGASMOVIL = 0;
          |FINSI;
     |SINO;
          || a partir de 2016
          |SI aMOVIL = "S";
               nINCREGASMOVIL = 2000;
          |SINO;
               nINCREGASMOVIL = 0;
          |FINSI;
     |FINSI;

     || C. incremento para trabajadores activos con discapacidad

     swSigue = 0;
     |SI #104#3 = "S";             || DISCAPACITADO
          |SI #104#4 = "2";        || > 65%
               swSigue = 1;
          |FINSI;
          |SI #104#4 = "1"; |Y #104#5 = "S";  || > 33% Y AYUDA MOVILIDAD PERSONAL
               swSigue = 1;
          |FINSI;
          |SI swSigue = 1;
               nINCREGASDISTRA = 7750;
          |SINO;
               |SI #104#4 = "1";   || > 33%
                    nINCREGASDISTRA = 3500;
               |SINO;
                    nINCREGASDISTRA = 0;
               |FINSI;
          |FINSI;
     |FINSI;

     || D. total otros gastos

     nOTROSGASTOS = nGASTOSGEN + nINCREGASMOVIL + nINCREGASDISTRA;
     nCOTIZACIONES = #102#11;

     nNume = nRETRIB - nCOTIZACIONES;
     |SI nNume < 0;
          nOTROSGASTOS = 0;
     |FINSI;

     nNume = nRETRIB - nCOTIZACIONES;
     |SI nOTROSGASTOS > nNume;
          nOTROSGASTOS = nNume;
     |FINSI;

     || GASTOS DEDUCIBLES

     nGASTOS = nCOTIZACIONES + nOTROSGASTOS;
|FPRC;

|PROCESO Rendimiento;
     #104#12 = 0;
     || #104#27 = #102#9 - (#102#10 + #102#11);      || rend.neto trabajo
     |SI #0#2 [ 2014;
          nRNT = nRETRIB - nIRREGULAR1 - nIRREGULAR2 - nGASTOS;
     |FINSI;
     |SI #0#2 ] 2015;
          nRNT = nRETRIB - nIRREGULAR1 - nIRREGULAR2 - nCOTIZACIONES;
     |FINSI;
     |SI nRNT < 0;
          nRNT = 0;
     |FINSI;
|FPRC;

|PROCESO MinimoPers_Fami; || MINIMO PERSONAL Y FAMILIAR

     || A. MINIMO DEL CONTRIBUYENTE

     |SI #0#2 = 2007;
          nMINPER = 5050;
          |SI #102#1 > 64;         || reduccion por edad del perceptor
               n65PER = 900;
          |FINSI;
          |SI #102#1 > 74;         || reduccion asistencia a perceptores
               n75PER = 1100;      || mayores de 75 a¤os
          |FINSI;
     |FINSI;
     |SI #0#2 ] 2008; |Y #0#2 [ 2014;
          nMINPER = 5151;
          |SI #102#1 > 64;         || reduccion por edad del perceptor
               n65PER = 918;
          |FINSI;
          |SI #102#1 > 74;         || reduccion asistencia a perceptores
               n75PER = 1122;      || mayores de 75 a¤os
          |FINSI;
     |FINSI;
     |SI #0#2 ] 2015;
          nMINPER = 5550;
          |SI #102#1 > 64;         || reduccion mayores de 64 a¤os
               n65PER = 1150;
          |FINSI;
          |SI #102#1 > 74;         || reduccion mayores de 74 a¤os
               n75PER = 1400;
          |FINSI;
     |FINSI;

     nMINCON = nMINPER + n65PER + n75PER;
|FPRC;

|PROCESO ReduCaracGeneral;    || REDUCCION DE CARACTER GENERAL
     |SI #0#2 = 2007;
          nNume1 = nRNT - nREDCOPA;
          |SI nNume1 [ 9000;
               nRED20 = 4000;
          |SINO;
               |SI nNume1 [ 13000;
                    nRED20 = 4000 - (0.35 * (nNume1 - 9000));
               |SINO;
                    nRED20 = 2600;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI #0#2 ] 2008; |Y #0#2 [ 2014;
          nNume1 = nRNT;
          |SI nNume1 [ 9180;
               nRED20 = 4080;
          |SINO;
               |SI nNume1 [ 13260;
                    nRED20 = 4080 - (0.35 * (nNume1 - 9180));
               |SINO;
                    nRED20 = 2652;
               |FINSI;
          |FINSI;
     |FINSI;
     || julio 2018
     swSigue = 1;
     |SI #0#2 ] 2015; |Y #0#2 [ 2017;
          swSigue = 1;
     |FINSI;
     |SI #0#2 = 2018; |Y swCambio2018 = 1;
          |SI nElMesIRPF [ 6; |Y nDiferencias = 0;
               swSigue = 1;
          |SINO;
               swSigue = 2;
          |FINSI;
     |FINSI;
     |SI #0#2 ] 2019;
          swSigue = 3;
     |FINSI;

     |SI swSigue = 1;
          |SI nRNT [ 11250;
               nRED20 = 3700;
          |SINO;
               |SI nRNT [ 14450;
                    nRED20 = 3700 - (1.15625 * (nRNT - 11250));
               |SINO;
                    nRED20 = 0;
               |FINSI;
          |FINSI;
          nRED20 = nRED20 ! 2;
     |FINSI;
     |SI swSigue = 2;
          |SI nRNT [ 11250;
               nRED20 = 3700 + (0.5 * (5565 - 3700));
          |SINO;
               |SI nRNT [ 13115;
                    nNume1 = 3700 - (1.15625 * (nRNT - 11250));
                    nNume2 = 0.5 * (5565 - nNume1);
                    nRED20 = nNume1 + nNume2;
               |SINO;
                    |SI nRNT [ 14450;
                         nNume1 = 3700 - (1.15625 * (nRNT - 11250));
                         nNume2 = 5565 - (1.5 * (nRNT - 13115));
                         nRED20 = nNume1 + (0.5 * (nNume2 - nNume1));
                    |SINO;
                         |SI nRNT [ 16825;
                              nRED20 = 0.5 * (5565 - (1.5 * (nRNT - 13115)));
                         |SINO;
                              nRED20 = 0;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          nRED20 = nRED20 ! 2;
     |FINSI;
     |SI swSigue = 3;
          |SI nRNT [ 13115;
               nRED20 = 5565;
          |SINO;
               |SI nRNT [ 16825;
                    nRED20 = 5565 - (1.5 * (nRNT - 13115));
               |SINO;
                    nRED20 = 0;
               |FINSI;
          |FINSI;
          nRED20 = nRED20 ! 2;
     |FINSI;
|FPRC;

|PROCESO RedProlongacion;
     |SI #102#72 = "S"; |Y #102#1 > 64;  || Prolongacion de la actividad laboral
          nPROLONLAB = nRED20;
     |FINSI;
|FPRC;

|PROCESO RedMovilidad;
     |SI #0#2 [ 2014;
          |SI #102#73 = "S";            || Reduccion por movilidad goegrafica
               nMOVILGEO = nRED20;
          |FINSI;
     |FINSI;
     |SI #0#2 = 2015;
          |SI aMOVIL = "S"; |Y nCAMBIORESI = 2014;
               |SI nRNT [ 9180;
                    nMOVILGEO = 4080;
               |SINO;
                    |SI nRNT [ 13260;
                         nMOVILGEO = 4080 - (0.35 * (nRNT - 9180));
                    |SINO;
                         nMOVILGEO = 2652;
                    |FINSI;
               |FINSI;
          |SINO;
               nMOVILGEO = 0
          |FINSI;
          nMOVILGEO = nMOVILGEO ! 2;
     |FINSI;
     |SI #0#2 ] 2016;
          nMOVILGEO = 0;
     |FINSI;
|FPRC;

|PROCESO RedDiscapacidad;
     |SI #104#3 = "S";             || Deduccion por discapacidad de trabajadores
                                   || activos
          |SI #0#2 = 2007;
               |SI #104#4 = "2";             || >65
                    nDISTRA = 7100;
               |SINO;
                    |SI #104#4 = "1";
                         |SI #102#8 = "S";
                              nDISTRA = 7100;     || >33 y <65 con ayuda
                         |SINO;
                              nDISTRA = 3200;     || >33 y <65 sin ayuda
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #0#2 ] 2008;
               |SI #104#4 = "2";             || >65
                    nDISTRA = 7242;
               |SINO;
                    |SI #104#4 = "1";
                         |SI #102#8 = "S";
                              nDISTRA = 7242;     || >33 y <65 con ayuda
                         |SINO;
                              nDISTRA = 3264;     || >33 y <65 sin ayuda
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ReduRendTrabajo;     || reducciones por obtencion de
                              || rendimientos del trabajo

     |HAZ ReduCaracGeneral;   || reduccion de caracter general

     |SI #0#2 [ 2014;
          |HAZ RedProlongacion;
          |HAZ RedMovilidad;
          |HAZ RedDiscapacidad;
     |FINSI;
     |SI #0#2 ] 2015;
          |HAZ RedMovilidad;
     |FINSI;
|FPRC;

|PROCESO ReduCopaAmerica;
     |SI #0#2 = 2007;
          |SI #102#2 = "A";
               |SI #102#122 = "S";
                    nREDCOPA = #104#27 * 0.65;
               |SINO;
                    nREDCOPA = 0;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ReduccMasDeDos;
     |SI nNUMDES > 2;
          nHIJOS = 600;
     |FINSI;
|FPRC;

|PROCESO RendiNetoRedu;
     |SI #0#2 [ 2014;
          nNume1 = nRED20 + nPROLONLAB + nMOVILGEO + nDISTRA;
          |SI #0#2 = 2007;
               nNume1 = nNume1 + nREDCOPA;
          |FINSI;
          nRNTREDU = nRNT - nNume1;
          |SI nRNTREDU < 0;
               nRNTREDU = 0;
          |FINSI;
     |FINSI;
     |SI #0#2 ] 2015;
          nRNTREDU = nRNT - nOTROSGASTOS - nRED20 - nMOVILGEO;
          |SI nRNTREDU < 0;
               nRNTREDU = 0;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ReduccPerceptor;
     |SI #102#6 = "S";        || reduccion por discapacidad del perceptor
          |SI #0#2 = 2007;
               |SI #102#7 = "1";
                    nDISPER = 2270;          || 33-65%
               |SINO;
                    nDISPER = 6900;          || >65%
               |FINSI;

               |SI #102#7 = "2";             || >65%
                    nASISPER = 2270;
               |SINO;
                    |SI #102#8 = "S";        || 33-65% y necesita asistencia
                         nASISPER = 6900;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #0#2 ] 2008; |Y #0#2 [ 2014;
               |SI #102#7 = "1";
                    nDISPER = 2316;          || 33-65%
               |SINO;
                    nDISPER = 7038;          || >65%
               |FINSI;

               |SI #102#7 = "2";             || >65%
                    nASISPER = 2316;
               |SINO;
                    |SI #102#8 = "S";        || 33-65% y necesita asistencia
                         nASISPER = 2316;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #0#2 ] 2015;
               |SI #102#7 = "1";
                    nDISPER = 3000;          || 33-65%
               |SINO;
                    nDISPER = 9000;          || >65%
               |FINSI;

               |SI #102#7 = "2";             || >65%
                    nASISPER = 3000;
               |SINO;
                    |SI #102#8 = "S";        || 33-65% y necesita asistencia
                         nASISPER = 3000;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO ReduccPen;
     |SI #102#3 = "P";
          nPENSION = 600;
     |FINSI;
|FPRC;

|PROCESO ReduccDes;
     |SI #102#3 = "D";
          nDESEM = 1200;
     |FINSI;
|FPRC;

|PROCESO Descendientes;
     |PDEFECTO #104, 19, 25;
     |PDEFECTO #104, 29, 30;
     |PDEFECTO #104, 57, 70;
     nEl20 = 0;     nEl21 = 0;     nEl22 = 0;     nEl23 = 0;
     |PARA nPara1 = 20; |SI nPara1 [ 29; |HACIENDO nPara1 = nPara1 + 1;
          nEdad = #0#2 - #102nPara1;
          |SI #102nPara1 ! 0;
               nPara2 = nPara1 + 10;    || grado minusvalia
               nPara3 = nPara1 + 22;    || por entero S/N
               nPara4 = nPara1 + 65;    || movilidad reducida S/N
               nPara5 = nPara1 + 55;    || A¤o Adopcion
               nAnysAdop = #0#2 - #102nPara5;

               || solo tienen reduccion menores de 25 a¤os o mayores c/minusv.
               |SI nEdad < 25; |O #102nPara2 = "1"; |O #102nPara2 = "2";
                    nNUMDES = nNUMDES + 1;
                    nAdopcion = #0#2 - #102nPara5;
                    nEntero = 0.5;
                    |SI #102nPara3 = "S";    || si computa o no por entero
                         nEntero = 1;
                         #104#24 = #104#24 + 1;   || por entero
                    |FINSI;

                    #104#19 = #104#19 + 1;   || numero de descendientes

                                             || calculamos edad
                    |SI nEdad < 3;
                         #104#21 = #104#21 + 1;
                    |FINSI;
                    |SI nEdad ]3; |Y nEdad < 25;
                         #104#20 = #104#20 + 1;
                    |FINSI;
                                             || calculamos a¤os adopcion
                    |SI nAdopcion < 3;
                         #104#66 = #104#66 + 1;
                    |FINSI;

                                                  || minimo por descendientes
                    |SI #0#2 = 2007;
                         |SI #104#19 = 1;
                              nMINDESG = nMINDESG + (1800 * nEntero);
                         |FINSI;

                         |SI #104#19 = 2;
                              nMINDESG = nMINDESG + (2000 * nEntero);
                         |FINSI;

                         |SI #104#19 = 3;
                              nMINDESG = nMINDESG + (3600 * nEntero);
                         |FINSI;

                         |SI #104#19 > 3;
                              nMINDESG = nMINDESG + (4100 * nEntero);
                         |FINSI;

                         |SI nEdad < 3;
                              nMINDES3 = nMINDES3 + 2200 * nEntero;
                         |SINO;
                              nNume1 = #102nPara5 - #102nPara1;
                              |SI #102nPara5 ] #102nPara1; |Y #102nPara5 > 2004; |Y nNume1 < 19;
                                   nMINDES3 = nMINDES3 + 2200 * nEntero;
                              |FINSI;
                         |FINSI;

                         nMINDES = nMINDESG + nMINDES3;
                         #104#29 = nMINDES;

                                                  || reduccion por cuidado de descend.
                         |SI #102nPara2 = "1";    || reduccion discapacidad descend.
                              nDISDES = nDISDES + (2270 * nEntero);    || 33-65%
                              #104#22 = #104#22 + 1;
                         |FINSI;

                         |SI #102nPara2 = "2";
                              nDISDES = nDISDES + (6900 * nEntero);    || > 65%
                              #104#23 = #104#23 + 1;
                         |FINSI;

                                                  || reduccion asistencia descend.disc.
                         |SI #102nPara2 = "1"; |Y #102nPara4 = "S";
                              nASISDES = nASISDES + (2270 * nEntero);
                              #104#67 = #104#67 + 1;
                         |FINSI;

                         |SI #102nPara2 = "2";
                              nASISDES = nASISDES + (2270 * nEntero);
                         |FINSI;
                    |FINSI;
                    |SI #0#2 ] 2008; |Y #0#2 [ 2014;
                                                  || minimo por descendientes
                         |SI #104#19 = 1;
                              nMINDESG = nMINDESG + (1836 * nEntero);
                         |FINSI;

                         |SI #104#19 = 2;
                              nMINDESG = nMINDESG + (2040 * nEntero);
                         |FINSI;

                         |SI #104#19 = 3;
                              nMINDESG = nMINDESG + (3672 * nEntero);
                         |FINSI;

                         |SI #104#19 > 3;
                              nMINDESG = nMINDESG + (4182 * nEntero);
                         |FINSI;

                         |SI nEdad < 3;
                              nMINDES3 = nMINDES3 + 2244 * nEntero;
                         |SINO;
                              nNume1 = #102nPara5 - #102nPara1;
                              |SI #102nPara5 ] #102nPara1; |Y nAnysAdop < 3; |Y nNume1 < 19;
                                   nMINDES3 = nMINDES3 + 2244 * nEntero;
                              |FINSI;
                         |FINSI;

                         nMINDES = nMINDESG + nMINDES3;
                         #104#29 = nMINDES;

                                                  || reduccion por cuidado de descend.
                         |SI #102nPara2 = "1";    || reduccion discapacidad descend.
                              nDISDES = nDISDES + (2316 * nEntero);    || 33-65%
                              #104#22 = #104#22 + 1;
                         |FINSI;

                         |SI #102nPara2 = "2";
                              nDISDES = nDISDES + (7038 * nEntero);    || > 65%
                              #104#23 = #104#23 + 1;
                         |FINSI;

                                                  || reduccion asistencia descend.disc.
                         |SI #102nPara2 = "1"; |Y #102nPara4 = "S";
                              nASISDES = nASISDES + (2316 * nEntero);
                              #104#67 = #104#67 + 1;
                         |FINSI;

                         |SI #102nPara2 = "2";
                              nASISDES = nASISDES + (2316 * nEntero);
                         |FINSI;
                    |FINSI;
                    |SI #0#2 ] 2015;
                                                  || minimo por descendientes
                         |SI #104#19 = 1;
                              nMINDESG = nMINDESG + (2400 * nEntero);
                         |FINSI;

                         |SI #104#19 = 2;
                              nMINDESG = nMINDESG + (2700 * nEntero);
                         |FINSI;

                         |SI #104#19 = 3;
                              nMINDESG = nMINDESG + (4000 * nEntero);
                         |FINSI;

                         |SI #104#19 > 3;
                              nMINDESG = nMINDESG + (4500 * nEntero);
                         |FINSI;

                         |SI nEdad < 3;
                              nMINDES3 = nMINDES3 + 2800 * nEntero;
                         |SINO;
                              nNume1 = #102nPara5 - #102nPara1;

                              |SI #0#2 ] 2018;
                                   || en principio, unico cambio para 2018
                                   |SI #102nPara5 ] #102nPara1; |Y nAnysAdop < 3;
                                        nMINDES3 = nMINDES3 + 2800 * nEntero;
                                   |FINSI;
                              |SINO;
                                   |SI #102nPara5 ] #102nPara1; |Y nAnysAdop < 3; |Y nNume1 < 19;
                                        nMINDES3 = nMINDES3 + 2800 * nEntero;
                                   |FINSI;
                              |FINSI;
                         |FINSI;

                         nMINDES = nMINDESG + nMINDES3;
                         #104#29 = nMINDES;

                                                  || reduccion por cuidado de descend.
                         |SI #102nPara2 = "1";    || reduccion discapacidad descend.
                              nDISDES = nDISDES + (3000 * nEntero);    || 33-65%
                              #104#22 = #104#22 + 1;
                         |FINSI;

                         |SI #102nPara2 = "2";
                              nDISDES = nDISDES + (9000 * nEntero);    || > 65%
                              #104#23 = #104#23 + 1;
                         |FINSI;

                                                  || reduccion asistencia descend.disc.
                         |SI #102nPara2 = "1"; |Y #102nPara4 = "S";
                              nASISDES = nASISDES + (3000 * nEntero);
                              #104#67 = #104#67 + 1;
                         |FINSI;

                         |SI #102nPara2 = "2";
                              nASISDES = nASISDES + (3000 * nEntero);
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Ascendientes;
     |PDEFECTO #104, 46, 50;
     |PARA nPara1 = 95; |SI nPara1 [ 104; |HACIENDO nPara1 = nPara1 + 1;
          |SI #102nPara1 ! 0;
               nPara2 = nPara1 - 33;    || % Discapacidad
               nPara3 = nPara1 - 43;    || Convivencia
               nPara4 = nPara1 + 10;    || Movilidad Reducida

               nEDADAS = #0#2 - #102nPara1;
               |SI nEDADAS < 65; |Y #102nPara2 ! "1"; |Y #102nPara2 ! "2";
                    |ACABA;        || solo mayores de 64 a¤os o menos de 64
               |FINSI;             || a¤os con disc. tienen reduccion

               |SI #102nPara3 = 0; #102nPara3 = 1; |FINSI;
               |SI #102nPara3 = 1;
                    #104#48 = #104#48 + 1;   || por entero
               |FINSI;

               |SI #0#2 = 2007;
                                             || reduccion de edad por ascendientes
                    n65AS = n65AS + (900 / #102nPara3);

                                             || reduc.asistencia mayores de 75 a¤os
                    |SI nEDADAS > 74;
                         n75AS = n75AS + (1100 / #102nPara3);
                         #104#68 = #104#68 + 1;
                    |FINSI;

                                             || reduccion discapacidad ascendientes
                    |SI #102nPara2 = "1";
                         #104#46 = #104#46 + 1;   || de 33 a 65
                         nDISAS = nDISAS + (2270 / #102nPara3);
                    |FINSI;
                    |SI #102nPara2 = "2";
                         #104#47 = #104#47 + 1;   || mas de 65
                         nDISAS = nDISAS + (6900 / #102nPara3);
                    |FINSI;

                                            || reduccion asistencia ascend.discap.
                    |SI #102nPara2 = "1"; |Y #102nPara4 = "S";
                         nASISAS = nASISAS + (2270 / #102nPara3);
                         #104#69 = #104#69 + 1;
                    |FINSI;
                    |SI #102nPara2 = "2";
                         nASISAS = nASISAS + (2270 / #102nPara3);
                    |FINSI;
                    nREDASC = #104#46 + #104#47 + #104#68 + #104#69;
                    |SI nREDASC ! 0;
                         #104#49 = #104#49 + 1;        || totales
                    |FINSI;
               |FINSI;
               |SI #0#2 ] 2008; |Y #0#2 [ 2014;
                                             || reduccion de edad por ascendientes
                    n65AS = n65AS + (918 / #102nPara3);

                                             || reduc.asistencia mayores de 75 a¤os
                    |SI nEDADAS > 74;
                         n75AS = n75AS + (1122 / #102nPara3);
                         #104#68 = #104#68 + 1;
                    |FINSI;

                                             || reduccion discapacidad ascendientes
                    |SI #102nPara2 = "1";
                         #104#46 = #104#46 + 1;   || de 33 a 65
                         nDISAS = nDISAS + (2316 / #102nPara3);
                    |FINSI;
                    |SI #102nPara2 = "2";
                         #104#47 = #104#47 + 1;   || mas de 65
                         nDISAS = nDISAS + (7038 / #102nPara3);
                    |FINSI;

                                            || reduccion asistencia ascend.discap.
                    |SI #102nPara2 = "1"; |Y #102nPara4 = "S";
                         nASISAS = nASISAS + (2316 / #102nPara3);
                         #104#69 = #104#69 + 1;
                    |FINSI;
                    |SI #102nPara2 = "2";
                         nASISAS = nASISAS + (2316 / #102nPara3);
                    |FINSI;
                    nREDASC = #104#46 + #104#47 + #104#68 + #104#69;
                    |SI nREDASC ! 0;
                         #104#49 = #104#49 + 1;        || totales
                    |FINSI;
               |FINSI;
               |SI #0#2 ] 2015;
                                             || reduccion de edad por ascendientes
                    n65AS = n65AS + (1150 / #102nPara3);

                                             || reduc.asistencia mayores de 75 a¤os
                    |SI nEDADAS > 74;
                         n75AS = n75AS + (1400 / #102nPara3);
                         #104#68 = #104#68 + 1;
                    |FINSI;

                                             || reduccion discapacidad ascendientes
                    |SI #102nPara2 = "1";
                         #104#46 = #104#46 + 1;   || de 33 a 65
                         nDISAS = nDISAS + (3000 / #102nPara3);
                    |FINSI;
                    |SI #102nPara2 = "2";
                         #104#47 = #104#47 + 1;   || mas de 65
                         nDISAS = nDISAS + (9000 / #102nPara3);
                    |FINSI;

                                            || reduccion asistencia ascend.discap.
                    |SI #102nPara2 = "1"; |Y #102nPara4 = "S";
                         nASISAS = nASISAS + (3000 / #102nPara3);
                         #104#69 = #104#69 + 1;
                    |FINSI;
                    |SI #102nPara2 = "2";
                         nASISAS = nASISAS + (3000 / #102nPara3);
                    |FINSI;
                    nREDASC = #104#46 + #104#47 + #104#68 + #104#69;
                    |SI nREDASC ! 0;
                         #104#49 = #104#49 + 1;        || totales
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;

     nMINAS = n65AS + n75AS;
|FPRC;

|PROCESO Resultados;
     nRED65 = n65PER + n65AS;
     nRED75 = n75PER + n75AS;
     nREDIS = nDISPER + nDISDES + nDISAS + nASISPER + nASISDES + nASISAS;

     nMINDISC = nDISPER + nASISPER;
     nMDISDEAS = nDISAS + nDISDES + nASISDES + nASISAS;
     nMINDIS = nMINDISC + nMDISDEAS;
     nMINPERFA = nMINCON + nMINDES + nMINAS + nMINDIS;
|FPRC;

|PROCESO Base;
     || nRETRIB = #102#9;     || ingresos anuales perceptor
     nCONYUGE = #102#13;

     nREDU = nPENSION + nHIJOS + nDESEM + nCONYUGE;
     |SI nRNTREDU > nREDU;
          nBASE = nRNTREDU - nREDU;
     |SINO;
          nBASE = 0;
     |FINSI;
|FPRC;

|PROCESO Escala;
     |SI #0#2 ] 2000; |Y #0#2 [ 2004;
          nB0 = 0;       nR0 = 0;        nP0 = 15;
          nB1 = 4000;    nR1 = 600;      nP1 = 24;
          nB2 = 13800;   nR2 = 2952;     nP2 = 28;
          nB3 = 25800;   nR3 = 6312;     nP3 = 37;
          nB4 = 45000;   nR4 = 13416;    nP4 = 45;
     |FINSI;

     |SI #0#2 = 2005;
          nB0 = 0;       nR0 = 0;           nP0 = 15;
          nB1 = 4080;    nR1 = 612;         nP1 = 24;
          nB2 = 14076;   nR2 = 3011.04;     nP2 = 28;
          nB3 = 26316;   nR3 = 6438.24;     nP3 = 37;
          nB4 = 45900;   nR4 = 13684.32;    nP4 = 45;
     |FINSI;

     |SI #0#2 = 2006;
          nB0 = 0;          nR0 = 0;           nP0 = 15;
          nB1 = 4161.60;    nR1 = 624.24;      nP1 = 24;
          nB2 = 14357.52;   nR2 = 3071.26;     nP2 = 28;
          nB3 = 26842.32;   nR3 = 6567.00;     nP3 = 37;
          nB4 = 46818.00;   nR4 = 13958.00;    nP4 = 45;
     |FINSI;

     |SI #0#2 = 2007;
          nB0 = 0;          nR0 = 0;           nP0 = 24;
          nB1 = 17360.00;   nR1 = 4166.40;     nP1 = 28;
          nB2 = 32360.00;   nR2 = 8366.40;     nP2 = 37;
          nB3 = 52360.00;   nR3 = 15766.40;    nP3 = 43;
     |FINSI;

     |SI #0#2 = 2008;
          nB0 = 0;          nR0 = 0;           nP0 = 24;
          nB1 = 17707.20;   nR1 = 4249.73;     nP1 = 28;
          nB2 = 33007.20;   nR2 = 8533.73;     nP2 = 37;
          nB3 = 53407.20;   nR3 = 16081.73;    nP3 = 43;
     |FINSI;

     |SI #0#2 = 2009;    || la escala del 2009 igual a la del 2008
          nB0 = 0;          nR0 = 0;           nP0 = 24;
          nB1 = 17707.20;   nR1 = 4249.73;     nP1 = 28;
          nB2 = 33007.20;   nR2 = 8533.73;     nP2 = 37;
          nB3 = 53407.20;   nR3 = 16081.73;    nP3 = 43;
     |FINSI;

     |SI #0#2 = 2010;    || la escala del 2010 igual a la del 2009 (y a la del 2008)
          nB0 = 0;          nR0 = 0;           nP0 = 24;
          nB1 = 17707.20;   nR1 = 4249.73;     nP1 = 28;
          nB2 = 33007.20;   nR2 = 8533.73;     nP2 = 37;
          nB3 = 53407.20;   nR3 = 16081.73;    nP3 = 43;
     |FINSI;

     || la escala del 2011, hay un par de tramos mas
     || ademas en enero de 2012 a¤ado que estoy calculando ENERO de 2012
     || tengo que seguir esta escala, a partir de FEBRERO cambia

     |SI #0#2 = 2011; |O nMes2012 = 1;
          nB0 = 0;          nR0 = 0;           nP0 = 24;
          nB1 = 17707.20;   nR1 = 4249.73;     nP1 = 28;
          nB2 = 33007.20;   nR2 = 8533.73;     nP2 = 37;
          nB3 = 53407.20;   nR3 = 16081.73;    nP3 = 43;
          nB4 = 120000.20;  nR4 = 44716.72;    nP4 = 44;
          nB5 = 175000.20;  nR5 = 68916.73;    nP5 = 45;
     |FINSI;

     || un tramo mas a partir de febrero de 2012
     |SI nMes2012 ] 2; |Y #0#2 [ 2014;
          nB0 = 0;          nR0 = 0;           nP0 = 24.75;
          nB1 = 17707.20;   nR1 = 4382.53;     nP1 = 30;
          nB2 = 33007.20;   nR2 = 8972.53;     nP2 = 40;
          nB3 = 53407.20;   nR3 = 17132.53;    nP3 = 47;
          nB4 = 120000.20;  nR4 = 48431.24;    nP4 = 49;
          nB5 = 175000.20;  nR5 = 75381.24;    nP5 = 51;
          nB6 = 300000.20;  nR6 = 139131.24;   nP6 = 52;
     |FINSI;

     || escala 2015 enero a junio
     |SI #0#2 ] 2015; |Y nMes2015 [ 6;
          nB0 = 0;          nR0 = 0;           nP0 = 20;
          nB1 = 12450.00;   nR1 = 2490.00;     nP1 = 25;
          nB2 = 20200.00;   nR2 = 4427.50;     nP2 = 31;
          nB3 = 34000.00;   nR3 = 8705.50;     nP3 = 39;
          nB4 = 60000.00;   nR4 = 18845.50;    nP4 = 47;
     |FINSI;

     || escala 2015 julio en adelante
     swSigue = 0;
     |SI #0#2 = 2015; |Y nMes2015 ] 7;
          swSigue = 1;
     |FINSI;
     |SI swSigue = 1;
          nB0 = 0;          nR0 = 0;           nP0 = 19.50;
          nB1 = 12450.00;   nR1 = 2427.75;     nP1 = 24.50;
          nB2 = 20200.00;   nR2 = 4326.50;     nP2 = 30.50;
          nB3 = 34000.00;   nR3 = 8535.50;     nP3 = 38;
          nB4 = 60000.00;   nR4 = 18415.50;    nP4 = 46;
     |FINSI;

     |SI #0#2 = 2016;
          nB0 = 0;          nR0 = 0;           nP0 = 19;
          nB1 = 12450.00;   nR1 = 2365.50;     nP1 = 24;
          nB2 = 20200.00;   nR2 = 4225.50;     nP2 = 30;
          nB3 = 35200.00;   nR3 = 8725.50;     nP3 = 37;
          nB4 = 60000.00;   nR4 = 17901.50;    nP4 = 45;
     |FINSI;

     |SI #0#2 ] 2017;
          nB0 = 0;          nR0 = 0;           nP0 = 19;
          nB1 = 12450.00;   nR1 = 2365.50;     nP1 = 24;
          nB2 = 20200.00;   nR2 = 4225.50;     nP2 = 30;
          nB3 = 35200.00;   nR3 = 8725.50;     nP3 = 37;
          nB4 = 60000.00;   nR4 = 17901.50;    nP4 = 45;
     |FINSI;

     |SI #0#2 [ 2010;    || la escala del 2010 o anterior
          nEsCuota = 0;
          |SI nEsBases < nB1;
               nEsCuota = nEsBases % nP0;
          |SINO;
               |SI nEsBases < nB2;
                    nEsCuota = nR1 + ((nEsBases - nB1) % nP1);
               |SINO;
                    |SI nEsBases < nB3;
                         nEsCuota = nR2 + ((nEsBases - nB2) % nP2);
                    |SINO;
                         nEsCuota = nR3 + ((nEsBases - nB3) % nP3);
                    |FINSI;
               |FINSI;
          |FINSI;
          nEsCuota = nEsCuota ! EURODB;
     |FINSI;

     || la escala del 2011, hay un par de tramos mas
     || ademas en enero de 2012 a¤ado que se estoy calculando ENERO de 2012
     || tengo que seguir esta escala, a partir de FEBRERO cambia

     |SI #0#2 = 2011; |O nMes2012 = 1;
          nEsCuota = 0;
          |SI nEsBases < nB1;
               nEsCuota = nEsBases % nP0;
          |SINO;
               |SI nEsBases < nB2;
                    nEsCuota = nR1 + ((nEsBases - nB1) % nP1);
               |SINO;
                    |SI nEsBases < nB3;
                         nEsCuota = nR2 + ((nEsBases - nB2) % nP2);
                    |SINO;
                         |SI nEsBases < nB4;
                              nEsCuota = nR3 + ((nEsBases - nB3) % nP3);
                         |SINO;
                              |SI nEsBases < nB5;
                                   nEsCuota = nR4 + ((nEsBases - nB4) % nP4);
                              |SINO;
                                   nEsCuota = nR5 + ((nEsBases - nB5) % nP5);
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          nEsCuota = nEsCuota ! EURODB;
     |FINSI;

     || un tramo mas a partir de febrero de 2012
     |SI nMes2012 ] 2; |Y #0#2 [ 2014;
          nEsCuota = 0;
          |SI nEsBases < nB1;
               nEsCuota = nEsBases % nP0;
          |SINO;
               |SI nEsBases < nB2;
                    nEsCuota = nR1 + ((nEsBases - nB1) % nP1);
               |SINO;
                    |SI nEsBases < nB3;
                         nEsCuota = nR2 + ((nEsBases - nB2) % nP2);
                    |SINO;
                         |SI nEsBases < nB4;
                              nEsCuota = nR3 + ((nEsBases - nB3) % nP3);
                         |SINO;
                              |SI nEsBases < nB5;
                                   nEsCuota = nR4 + ((nEsBases - nB4) % nP4);
                              |SINO;
                                   |SI nEsBases < nB6;
                                        nEsCuota = nR5 + ((nEsBases - nB5) % nP5);
                                   |SINO;
                                        nEsCuota = nR6 + ((nEsBases - nB6) % nP6);
                                   |FINSI;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          nEsCuota = nEsCuota ! EURODB;
     |FINSI;

     || cinco tramos a partir de 2015
     |SI #0#2 ] 2015;
          nEsCuota = 0;
          |SI nEsBases < nB1;
               nEsCuota = nEsBases % nP0;
          |SINO;
               |SI nEsBases < nB2;
                    nEsCuota = nR1 + ((nEsBases - nB1) % nP1);
               |SINO;
                    |SI nEsBases < nB3;
                         nEsCuota = nR2 + ((nEsBases - nB2) % nP2);
                    |SINO;
                         |SI nEsBases < nB4;
                              nEsCuota = nR3 + ((nEsBases - nB3) % nP3);
                         |SINO;
                              nEsCuota = nR4 + ((nEsBases - nB4) % nP4);
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
          nEsCuota = nEsCuota ! EURODB;
     |FINSI;
|FPRC;

|PROCESO CuotaRetencion;
                              || rendimientos exentos de retencion

     #104#41 = 0;             || limite de ingresos
     #104#42 = "NO";          || cuota limitada
     #104#43 = 0;             || cuota limite

     aSITUFAM = #102#3;    || situacion familiar
     || nNUMDES = 104#19;     || nro. descendientes

     || (1) En nomirold calculos anteriores a 2015
|| julio 2018
     swSigue = 1;
     |SI #0#2 ] 2015; |Y #0#2 [ 2017;
          swSigue = 1;
     |FINSI;
     |SI #0#2 = 2018; |Y swCambio2018 = 1;
          |SI nElMesIRPF [ 6; |Y nDiferencias = 0;
               swSigue = 1;
          |SINO;
               swSigue = 2;
          |FINSI;
     |FINSI;
     |SI #0#2 ] 2019;
          swSigue = 3;
     |FINSI;

     |SI swSigue = 1;
          aEXENTOS = "N";
          |SI nRETRIB [ 17138;
               |SI #104#8 = "1";
                    nNume1 = 14266 + nPENSION + nDESEM;
                    |SI #104#19 = 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    nNume1 = 15803 + nPENSION + nDESEM;
                    |SI #104#19 > 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
               |FINSI;
               |SI #104#8 = "2";
                    nNume1 = 13696 + nPENSION + nDESEM;
                    |SI #104#19 = 0; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    nNume1 = 14985 + nPENSION + nDESEM;
                    |SI #104#19 = 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    nNume1 = 17138 + nPENSION + nDESEM;
                    |SI #104#19 > 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
               |FINSI;
               |SI #104#8 = "3";
                    nNume1 = 12000 + nPENSION + nDESEM;
                    |SI #104#19 = 0; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    nNume1 = 12607 + nPENSION + nDESEM;
                    |SI #104#19 = 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    nNume1 = 13275 + nPENSION + nDESEM;
                    |SI #104#19 > 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI swSigue = 2;
          |SI #102#2 ! "P"; |Y #102#2 ! "D";
               aEXENTOS = "N";
               |SI nRETRIB [ 17492;
                    |SI #104#8 = "1";
                         nNume1 = 15168;
                         |SI #104#19 = 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                         nNume1 = 16730;
                         |SI #104#19 > 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    |FINSI;
                    |SI #104#8 = "2";
                         nNume1 = 14641;
                         |SI #104#19 = 0; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                         nNume1 = 15845;
                         |SI #104#19 = 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                         nNume1 = 17492;
                         |SI #104#19 > 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    |FINSI;
                    |SI #104#8 = "3";
                         nNume1 = 12643;
                         |SI #104#19 = 0; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                         nNume1 = 13455;
                         |SI #104#19 = 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                         nNume1 = 14251;
                         |SI #104#19 > 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               aEXENTOS = "N";
               nNume0 = 17386 + nPENSION + nDESEM;
               |SI nRETRIB [ nNume0;
                    |SI #104#8 = "1";
                         nNume1 = 15106.50 + nPENSION + nDESEM;
                         |SI #104#19 = 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                         nNume1 = 16541.50 + nPENSION + nDESEM;
                         |SI #104#19 > 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    |FINSI;
                    |SI #104#8 = "2";
                         nNume1 = 14576 + nPENSION + nDESEM;
                         |SI #104#19 = 0; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                         nNume1 = 15733 + nPENSION + nDESEM;
                         |SI #104#19 = 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                         nNume1 = 17386 + nPENSION + nDESEM;
                         |SI #104#19 > 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    |FINSI;
                    |SI #104#8 = "3";
                         nNume1 = 13000 + nPENSION + nDESEM;
                         |SI #104#19 = 0; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                         nNume1 = 13561.50 + nPENSION + nDESEM;
                         |SI #104#19 = 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                         nNume1 = 14184 + nPENSION + nDESEM;
                         |SI #104#19 > 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI swSigue = 3;
          aEXENTOS = "N";
          nNume1 = 17634 + nPENSION + nDESEM;
          |SI nRETRIB [ nNume1;
               |SI #104#8 = "1";
                    nNume1 = 15947 + nPENSION + nDESEM;
                    |SI #104#19 = 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    nNume1 = 17100 + nPENSION + nDESEM;
                    |SI #104#19 > 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
               |FINSI;
               |SI #104#8 = "2";
                    nNume1 = 15456 + nPENSION + nDESEM;
                    |SI #104#19 = 0; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    nNume1 = 16481 + nPENSION + nDESEM;
                    |SI #104#19 = 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    nNume1 = 17634 + nPENSION + nDESEM;
                    |SI #104#19 > 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
               |FINSI;
               |SI #104#8 = "3";
                    nNume1 = 14000 + nPENSION + nDESEM;
                    |SI #104#19 = 0; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    nNume1 = 14516 + nPENSION + nDESEM;
                    |SI #104#19 = 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
                    nNume1 = 15093 + nPENSION + nDESEM;
                    |SI #104#19 > 1; |Y nRETRIB [ nNume1; aEXENTOS = "S";  |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI aEXENTOS = "S";
          nCUOTA = 0;
          nTIPO = 0;
          |ACABA;
     |FINSI;
                         || rendimientos sujetos a retencion

     nNume1 = (nBASE - nANUALIDADES)

     |SI nANUALIDADES > 0; |Y nNume1 > 0;
          nBASE1 = nBASE - nANUALIDADES;
          nBASE2 = nANUALIDADES;

          nEsBases = nBASE1;
          |HAZ Escala;
          nCUOTA1_1 = nEsCuota;

          nEsBases = nBASE2;
          |HAZ Escala;
          nCUOTA1_2 = nEsCuota;

          nCUOTA1 = nCUOTA1_1 + nCUOTA1_2;
     |SINO;
          nEsBases = nBASE;
          |HAZ Escala;
          nCUOTA1 = nEsCuota;
     |FINSI;

     nNume1 = (nBASE - nANUALIDADES)

     |SI nANUALIDADES > 0; |Y nNume1 > 0;
          |SI #0#2 [ 2014;
               nEsBases = nMINPERFA + 1600;
          |FINSI;
          |SI #0#2 ] 2015;
               nEsBases = nMINPERFA + 1980;
          |FINSI;
          |HAZ Escala;
          nCUOTA2 = nEsCuota;
     |SINO;
          nEsBases = nMINPERFA;
          |HAZ Escala;
          nCUOTA2 = nEsCuota;
     |FINSI;

     |SI nCUOTA1 > nCUOTA2;
          nCUOTA = nCUOTA1 - nCUOTA2;
     |SINO;
          nCUOTA = 0;
     |FINSI;

     || (2) en nomirold calculos de periodos anteriores a 2015
|| julio 2018
     swSigue = 1;
     |SI #0#2 ] 2015; |Y #0#2 [ 2017;
          swSigue = 1;
     |FINSI;
     |SI #0#2 = 2018; |Y swCambio2018 = 1;
          |SI nElMesIRPF [ 6; |Y nDiferencias = 0;
               swSigue = 1;
          |SINO;
               swSigue = 2;
          |FINSI;
     |FINSI;
     |SI #0#2 ] 2019;
          swSigue = 3;
     |FINSI;

     |SI swSigue = 1;
          |SI nRETRIB [ 22000;               || limite del 43%
               |SI aSITUFAM = "1";
                    |SI nNUMDES = 1;
                         nLIMITE = ((nRETRIB - (14266 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
                    |SI nNUMDES > 1;
                         nLIMITE = ((nRETRIB - (15803 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
               |FINSI;
               |SI aSITUFAM = "2";
                    |SI nNUMDES = 0;
                         nLIMITE = ((nRETRIB - (13696 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
                    |SI nNUMDES = 1;
                         nLIMITE = ((nRETRIB - (14985 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
                    |SI nNUMDES > 1;
                         nLIMITE = ((nRETRIB - (17138 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
               |FINSI;
               |SI aSITUFAM = "3";
                    |SI nNUMDES = 0;
                         nLIMITE = ((nRETRIB - (12000 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
                    |SI nNUMDES = 1;
                         nLIMITE = ((nRETRIB - (12607 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
                    |SI nNUMDES > 1;
                         nLIMITE = ((nRETRIB - (13275 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
               |FINSI;
               |SI nCUOTA > nLIMITE;
                    nCUOTA = nLIMITE;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI swSigue = 2;
          |SI nRETRIB [ 22000;
               |SI #102#2 ! "P"; |Y #102#2 ! "D";
                    |SI nRETRIB [ 22000;               || limite del 43%
                         |SI aSITUFAM = "1";
                              |SI nNUMDES = 1;
                                   nLIMITE = (nRETRIB - 15168) * 0.43;
                              |FINSI;
                              |SI nNUMDES > 1;
                                   nLIMITE = (nRETRIB - 16730) * 0.43;
                              |FINSI;
                         |FINSI;
                         |SI aSITUFAM = "2";
                              |SI nNUMDES = 0;
                                   nLIMITE = (nRETRIB - 14641) * 0.43;
                              |FINSI;
                              |SI nNUMDES = 1;
                                   nLIMITE = (nRETRIB - 15845) * 0.43;
                              |FINSI;
                              |SI nNUMDES > 1;
                                   nLIMITE = (nRETRIB - 17492) * 0.43;
                              |FINSI;
                         |FINSI;
                         |SI aSITUFAM = "3";
                              |SI nNUMDES = 0;
                                   nLIMITE = (nRETRIB - 12643) * 0.43;
                              |FINSI;
                              |SI nNUMDES = 1;
                                   nLIMITE = (nRETRIB - 13455) * 0.43;
                              |FINSI;
                              |SI nNUMDES > 1;
                                   nLIMITE = (nRETRIB - 14251) * 0.43;
                              |FINSI;
                         |FINSI;
                         |SI nCUOTA > nLIMITE;
                              nCUOTA = nLIMITE;
                         |FINSI;
                    |FINSI;
               |SINO;
                    |SI nRETRIB [ 22000;               || limite del 43%
                         |SI aSITUFAM = "1";
                              |SI nNUMDES = 1;
                                   nLIMITE = (nRETRIB - (15106.50 + nPENSION + nDESEM)) * 0.43;
                              |FINSI;
                              |SI nNUMDES > 1;
                                   nLIMITE = (nRETRIB - (16451.50 + nPENSION + nDESEM)) * 0.43;
                              |FINSI;
                         |FINSI;
                         |SI aSITUFAM = "2";
                              |SI nNUMDES = 0;
                                   nLIMITE = (nRETRIB - (14576 + nPENSION + nDESEM)) * 0.43;
                              |FINSI;
                              |SI nNUMDES = 1;
                                   nLIMITE = (nRETRIB - (15733 + nPENSION + nDESEM)) * 0.43;
                              |FINSI;
                              |SI nNUMDES > 1;
                                   nLIMITE = (nRETRIB - (17386 + nPENSION + nDESEM)) * 0.43;
                              |FINSI;
                         |FINSI;
                         |SI aSITUFAM = "3";
                              |SI nNUMDES = 0;
                                   nLIMITE = (nRETRIB - (13000 + nPENSION + nDESEM)) * 0.43;
                              |FINSI;
                              |SI nNUMDES = 1;
                                   nLIMITE = (nRETRIB - (13561.50 + nPENSION + nDESEM)) * 0.43;
                              |FINSI;
                              |SI nNUMDES > 1;
                                   nLIMITE = (nRETRIB - (14184 + nPENSION + nDESEM)) * 0.43;
                              |FINSI;
                         |FINSI;
                         |SI nCUOTA > nLIMITE;
                              nCUOTA = nLIMITE;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI swSigue = 3;
          |SI nRETRIB [ 22000;               || limite del 43%
               |SI aSITUFAM = "1";
                    |SI nNUMDES = 1;
                         nLIMITE = ((nRETRIB - (15947 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
                    |SI nNUMDES > 1;
                         nLIMITE = ((nRETRIB - (17100 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
               |FINSI;
               |SI aSITUFAM = "2";
                    |SI nNUMDES = 0;
                         nLIMITE = ((nRETRIB - (15456 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
                    |SI nNUMDES = 1;
                         nLIMITE = ((nRETRIB - (16481 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
                    |SI nNUMDES > 1;
                         nLIMITE = ((nRETRIB - (17634 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
               |FINSI;
               |SI aSITUFAM = "3";
                    |SI nNUMDES = 0;
                         nLIMITE = ((nRETRIB - (14000 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
                    |SI nNUMDES = 1;
                         nLIMITE = ((nRETRIB - (14516 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
                    |SI nNUMDES > 1;
                         nLIMITE = ((nRETRIB - (15093 + nPENSION + nDESEM)) * 0.43);
                    |FINSI;
               |FINSI;
               |SI nCUOTA > nLIMITE;
                    nCUOTA = nLIMITE;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO TipoRetencion;
     swSegSem = 0;

     || (1) Periodos anteriores a 2015 en nomirold
|| julio 2018
     |SI #0#2 = 2018; |Y swCambio2018 = 1;
          |SI nElMesIRPF ] 7; |O nDiferencias = 1;
               swSegSem = 1;
          |FINSI;
     |FINSI;
     |SI #0#2 ] 2019;
          swSegSem = 1;
     |FINSI;

     |SI nElAnyIRPF ] 2015;        || A¥O 2015
          || aplicacion de la reduccion por pago de prestamos para adquisicion
          || o rehabilitacion de la VIVIENDA HABIRUAL (RD 1975/2008)

          nDedVivTra = 0;
          nDedVivGen = 0;
          |SI nRETRIB < 33007.20; |Y aPRESVIV2 = "S";
               nDedVivTra = 1;
          |FINSI;
          |SI nElAnyIRPF = 2011; |O nMes2012 = 1;
               |SI nRETRIB < 22000.00; |Y aPRESVIV1 = "S";
                    nDedVivGen = 1;
               |FINSI;
          |FINSI;
          |SI nMes2012 ] 2;
               |SI nRETRIB < 33007.20; |Y aPRESVIV1 = "S";
                    nDedVivGen = 1;
               |FINSI;
          |FINSI;
          |SI nDiferencias = 1;
               || vengo de buscar diferencias con el informe
               || no compruebo los importes maximos ya que puede ser
               || que durante el a¤o lo haya superado, pero lo deducido
               || por vivienda hasta ahi estara correcto
               |SI aPRESVIV2 = "S";
                    nDedVivTra = 1;
               |FINSI;
               |SI aPRESVIV1 = "S";
                    nDedVivGen = 1;
               |FINSI;
          |FINSI;
          |SI nDedVivTra = 1; |O nDedVivGen = 1;
               nMINOPAGO = nRETRIB % 2;
          |SINO;
               nMINOPAGO = 0;
          |FINSI;

          nMINOPAGO = nMINOPAGO - .005;              || trunca a dos decimales
          nMINOPAGO = nMINOPAGO ! 2;
          |SI nMINOPAGO < 0; nMINOPAGO = 0;     |FINSI;

          |SI #102#14 = "S";    || residencia en Ceuta/Melilla

               nDIFERENCIAPOSITIVA = (nCUOTA / 2) - nMINOPAGO;
               |SI swSegSem = 1;
                    || a partir de segundo semestre de 2018
                    nDIFERENCIAPOSITIVA = (nCUOTA * 0.40) - nMINOPAGO;
               |FINSI;
          |SINO;
               nNume1 = nCUOTA;
               nNume2 = nMINOPAGO;
               nDIFERENCIAPOSITIVA = nNume1 - nNume2;
          |FINSI;

          |SI nDIFERENCIAPOSITIVA < 0;
               nDIFERENCIAPOSITIVA = 0;
          |FINSI;

          nTIPO = (nDIFERENCIAPOSITIVA / nRETRIB) * 100;
          nTIPO = nTIPO - .005;              || trunca a dos decimales
          nTIPO = nTIPO ! 2;
          |SI nTIPO < 0; nTIPO = 0; |FINSI;

          |SI #102#14 = "S";       || RESIDENCIA EN CEUTA/CELILLA
               |SI nElAnyIRPF ] 2015;        || A¥O 2015
                    |SI nCONTRATO = "3"; |Y nTIPO < 8;
                         nTIPO = 8;
                    |SINO;
                         |SI nCONTRATO = "2"; |Y nTIPO < 1;
                              nTIPO = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI nElAnyIRPF ] 2019;        || A¥O 2019
                    |SI nCONTRATO = "3"; |Y nTIPO < 6;
                         nTIPO = 6;
                    |SINO;
                         |SI nCONTRATO = "2"; |Y nTIPO < 0.8;
                              nTIPO = 0.8;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI nCONTRATO = "3"; |Y nTIPO < 15;
                    nTIPO = 15;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPO < 2;
                         nTIPO = 2;
                    |FINSI;
               |FINSI;
          |FINSI;

          nIMPORTE = (nRETRIB * nTIPO) / 100;
          nIMPORTE = nIMPORTE ! 2;
     |FINSI;
|FPRC;

|PROCESO RegulExtra;
     |HAZ GastosDeducibles;
     |HAZ Rendimiento;
     |HAZ ReduRendTrabajo;
     |HAZ ReduCopaAmerica;
     |HAZ RendiNetoRedu;
     |HAZ ReduccPen;
     |HAZ ReduccMasDeDos;
     |HAZ ReduccDes;
     |HAZ MinimoPers_Fami;
     |HAZ ReduccPerceptor;
     |HAZ Mes2012;
     |HAZ Mes2015;
     |HAZ Base;
     |HAZ Resultados;
     |HAZ CuotaRetencion;
     |HAZ TipoRetencion;
|FPRC;

|PROCESO CausaReg2012;
     |SI nCAUSA2 = 0;
          || es la primera regularizacion, es un tipo 9 o 10 SIN tener en
          || cuenta los importes nuevos retefentes a ingresos

          nCAUSA = #102#116;  || causa regularizacion
          |SI nCAUSA = 0; |O nCAUSA > 11;
               nCAUSA = 11;
          |FINSI;

          aPRESVIV2 = #102#124;     || se acoge a reduccion por prestamo para
                                    || inversion en vivienda o no se acoge
          aPRESVIV1 = #102#126;     || se acoge a reduccion por prestamo para

          |SI nMINOPAGOa ! 0;      || en algun momento he tenido deduccion por
               nCAUSA = 1;         || inversion en vivienda, ya no puedo usar
          |FINSI;                  || la causa 11
          |SI aPRESVIV1 = "S"; |O aPRESVIV2 = "S"; || este mes me practico deduccion
               |SI aPRESVIV1 = "S";
                    |SI aPRESVIV1a = "N";           || el mes anterior tenia que NO
                         |SI nRETRIB < 33007.20;
                              nCAUSA = 9;         || que usar causa 9, empiezo este mes
                         |SINO;
                              aPRESVIV1 = "N";
                         |FINSI;
                    |FINSI;
                    |SI nRETRIBa < 33007.20; |Y nRETRIB ] 33007.20;
                         || tengo deduccion vivienda, y aumento ingresos por
                         || encima del limite
                         |SI aPRESVIV1a = "S";     || si el mes anterior tenia ded.
                              nCAUSA = 10;        || viv.
                              aPRESVIV1 = "N";     || fuerzo a que NO, si no, no calcula
                                             || bien
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI aPRESVIV2 = "S";
                    |SI aPRESVIV2a = "N";           || el mes anterior tenia que NO
                         |SI nRETRIB < 33007.20;
                              nCAUSA = 9;         || que usar causa 9, empiezo este mes
                         |SINO;
                              aPRESVIV2 = "N";
                         |FINSI;
                    |FINSI;
                    |SI nRETRIBa < 33007.20; |Y nRETRIB ] 33007.20;
                         || tengo deduccion vivienda, y aumento ingresos por
                         || encima del limite
                         |SI aPRESVIV2a = "S";     || si el mes anterior tenia ded.
                              nCAUSA = 10;        || viv.
                              aPRESVIV2 = "N";     || fuerzo a que NO, si no, no calcula
                                             || bien
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI aPRESVIV1a = "S"; |O aPRESVIV2a = "S";
                                        || el mes anterior tenia que SI, tengo
                    nCAUSA = 10;        || que usar causa 10, acabo este mes
               |FINSI;
          |FINSI;
          |SI nCAUSA = 9; |O nCAUSA = 10;
               |SI nRETRIB ! nRETRIBa; |Y swLocalizado ! 0; |Y nRETRIBa ! 0;
                    |SI nRETRIB > nRETRIBa;
                         nCAUSA2 = 10 + nCAUSA;

                         nRETRIBGuarda = nRETRIB;      || me guardo los datos reales
                         nIMPORTEGuarda = nIMPORTE;    || de este mes
                         nGASTOSGuarda = nGASTOS;
                         aPRESVIV1Guarda = aPRESVIV1;
                         aPRESVIV2Guarda = aPRESVIV2;

                         || regularizo una primera vez teniendo en cuenta la ded. viv.
                         || pero con los datos economicos del mes anterior

                         nRETRIB = nRETRIBa;
                         nIMPORTE = nIMPORTEA;
                         nGASTOS = nGASTOSa;

                         |HAZ RegulExtra;

                         || tengo que regularizar dos veces
                    |SINO;
                         |SI nCAUSA = 9;
                              aPRESVIV1Guarda = aPRESVIV1;
                              aPRESVIV2Guarda = aPRESVIV2;

                              aPRESVIV1 = "N";     || fuerzo a que NO, si no, no calcula
                              aPRESVIV2 = "N";     || fuerzo a que NO, si no, no calcula

                              || lo tengo que cambiar para que la primera
                              || regularizacion no me tenga en cuenta la
                              || deduccion de vivienda
                         |FINSI;

                         |SI nCAUSA = 10;     || migue
                              aPRESVIV1Guarda = aPRESVIV1;
                              aPRESVIV2Guarda = aPRESVIV2;
                              |SI aPRESVIV1a = "S";
                                   aPRESVIV1 = "S";     || fuerzo a que SI, si no, no calcula
                              |FINSI;
                              |SI aPRESVIV2a = "S";
                                   aPRESVIV2 = "S";     || fuerzo a que SI, si no, no calcula
                              |FINSI;

                              || lo tengo que cambiar para que la primera
                              || regularizacion no me tenga en cuenta la
                              || deduccion de vivienda
                         |FINSI;

                         nCAUSA2 = 10 + nCAUSA;
                         nCAUSAGuarda = nCAUSA;
                         nCAUSA = 1;

                         nRETRIBGuarda = nRETRIB;      || me guardo los datos reales
                         nIMPORTEGuarda = nIMPORTE;    || de este mes
                         nGASTOSGuarda = nGASTOS;

                         || regularizo una primera SIN tener en cuenta la ded. viv.
                         || con los datos economicos nuevos

                         |HAZ RegulExtra;
                         || tengo que regularizar dos veces
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          || es la segunda regularizacion, previamente he tenido
          || una tipo 9 o 10, recupero los importes reales que iba a cobrar


          |SI nCAUSAGuarda ! 0;
               nCAUSA = nCAUSAGuarda;
               nCAUSAGuarda = 0;
          |SINO;
               nCAUSA = 1;
          |FINSI;

          nRETRIB = nRETRIBGuarda;
          nIMPORTE = nIMPORTEGuarda;
          nGASTOS = nGASTOSGuarda;

          || estas variables las cojo de lo que me ha resultado
          || de la primera Regularizacion

          |SI nCAUSA2 = 19;
               aPRESVIV1 = aPRESVIV1Guarda;
               aPRESVIV2 = aPRESVIV2Guarda;
               || ahora lo dejo como estaba, la segunda regularizacion es
               || cuando tengo  que tener en cuenta lo de la vivienda
          |FINSI;
          |SI nCAUSA2 = 20;     || migue
               aPRESVIV1 = aPRESVIV1Guarda;
               aPRESVIV2 = aPRESVIV2Guarda;
               || ahora lo dejo como estaba, la segunda regularizacion es
               || cuando tengo  que tener en cuenta lo de la vivienda
          |FINSI;

          |SI nElAnyIRPF [ 2010;
               swSigue = 2;
               aMINORADO = aPRESVIV;
          |SINO;
               aMINORADO1 = aPRESVIV1;       || 2011
               aMINORADO2 = aPRESVIV2;       || 2010 o anterior
          |FINSI;
          nMINOPAGOa = nMINOPAGO;
          nTIPOA = nTIPO;

          |HAZ RegulExtra;
     |FINSI;
|FPRC;

|PROCESO CausaReg2011;
     |SI nCAUSA2 = 0;
          || es la primera regularizacion, es un tipo 9 o 10 SIN tener en
          || cuenta los importes nuevos retefentes a ingresos

          nCAUSA = #102#116;  || causa regularizacion
          |SI nCAUSA = 0; |O nCAUSA > 11;
               nCAUSA = 11;
          |FINSI;

          aPRESVIV2 = #102#124;     || se acoge a reduccion por prestamo para
                                   || inversion en vivienda o no se acoge
          aPRESVIV1 = #102#126;     || se acoge a reduccion por prestamo para

          |SI nMINOPAGOa ! 0;      || en algun momento he tenido deduccion por
               nCAUSA = 1;         || inversion en vivienda, ya no puedo usar
          |FINSI;                  || la causa 11
          |SI aPRESVIV1 = "S"; |O aPRESVIV2 = "S"; || este mes me practico deduccion
               |SI aPRESVIV1 = "S";
                    |SI aPRESVIV1a = "N";           || el mes anterior tenia que NO
                         |SI nRETRIB < 22000.00;
                              nCAUSA = 9;         || que usar causa 9, empiezo este mes
                              /*
                              |SI nRETRIBa ] 22000.00;  || el mes anterior tenia que NO tengo
                                   nCAUSA = 9;         || que usar causa 9, empiezo este mes
                              |SINO;
                                   nCAUSA = 1;         || que usar causa 9, empiezo este mes
                              |FINSI;
                              */
                         |SINO;
                              aPRESVIV1 = "N";
                         |FINSI;
                    |FINSI;
                    |SI nRETRIBa < 22000.00; |Y nRETRIB ] 22000.00;
                         || tengo deduccion vivienda, y aumento ingresos por
                         || encima del limite
                         |SI aPRESVIV1a = "S";     || si el mes anterior tenia ded.
                              nCAUSA = 10;        || viv.
                              aPRESVIV1 = "N";     || fuerzo a que NO, si no, no calcula
                                             || bien
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI aPRESVIV2 = "S";
                    |SI aPRESVIV2a = "N";           || el mes anterior tenia que NO
                         |SI nRETRIB < 33007.20;
                              nCAUSA = 9;         || que usar causa 9, empiezo este mes
                              /*
                              |SI nRETRIBa ] 33007.20;  || el mes anterior tenia que NO tengo
                                   nCAUSA = 9;         || que usar causa 9, empiezo este mes
                              |SINO;
                                   nCAUSA = 1;         || que usar causa 9, empiezo este mes
                              |FINSI;
                              */
                         |SINO;
                              aPRESVIV2 = "N";
                         |FINSI;
                    |FINSI;
                    |SI nRETRIBa < 33007.20; |Y nRETRIB ] 33007.20;
                         || tengo deduccion vivienda, y aumento ingresos por
                         || encima del limite
                         |SI aPRESVIV2a = "S";     || si el mes anterior tenia ded.
                              nCAUSA = 10;        || viv.
                              aPRESVIV2 = "N";     || fuerzo a que NO, si no, no calcula
                                             || bien
                         |FINSI;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI aPRESVIV1a = "S"; |O aPRESVIV2a = "S";
                                        || el mes anterior tenia que SI, tengo
                    nCAUSA = 10;        || que usar causa 10, acabo este mes
               |FINSI;
          |FINSI;
          |SI nCAUSA = 9; |O nCAUSA = 10;
               |SI nRETRIB ! nRETRIBa; |Y swLocalizado ! 0; |Y nRETRIBa ! 0;
                    |SI nRETRIB > nRETRIBa;
                         nCAUSA2 = 10 + nCAUSA;

                         nRETRIBGuarda = nRETRIB;      || me guardo los datos reales
                         nIMPORTEGuarda = nIMPORTE;    || de este mes
                         nGASTOSGuarda = nGASTOS;
                         aPRESVIV1Guarda = aPRESVIV1;
                         aPRESVIV2Guarda = aPRESVIV2;

                         || regularizo una primera vez teniendo en cuenta la ded. viv.
                         || pero con los datos economicos del mes anterior

                         nRETRIB = nRETRIBa;
                         nIMPORTE = nIMPORTEA;
                         nGASTOS = nGASTOSa;

                         |HAZ RegulExtra;

                         || tengo que regularizar dos veces
                    |SINO;
                         |SI nCAUSA = 9;
                              aPRESVIV1Guarda = aPRESVIV1;
                              aPRESVIV2Guarda = aPRESVIV2;

                              aPRESVIV1 = "N";     || fuerzo a que NO, si no, no calcula
                              aPRESVIV2 = "N";     || fuerzo a que NO, si no, no calcula

                              || lo tengo que cambiar para que la primera
                              || regularizacion no me tenga en cuenta la
                              || deduccion de vivienda
                         |FINSI;

                         |SI nCAUSA = 10;     || migue
                              aPRESVIV1Guarda = aPRESVIV1;
                              aPRESVIV2Guarda = aPRESVIV2;
                              |SI aPRESVIV1a = "S";
                                   aPRESVIV1 = "S";     || fuerzo a que SI, si no, no calcula
                              |FINSI;
                              |SI aPRESVIV2a = "S";
                                   aPRESVIV2 = "S";     || fuerzo a que SI, si no, no calcula
                              |FINSI;

                              || lo tengo que cambiar para que la primera
                              || regularizacion no me tenga en cuenta la
                              || deduccion de vivienda
                         |FINSI;

                         nCAUSA2 = 10 + nCAUSA;
                         nCAUSAGuarda = nCAUSA;
                         nCAUSA = 1;

                         nRETRIBGuarda = nRETRIB;      || me guardo los datos reales
                         nIMPORTEGuarda = nIMPORTE;    || de este mes
                         nGASTOSGuarda = nGASTOS;

                         || regularizo una primera SIN tener en cuenta la ded. viv.
                         || con los datos economicos nuevos

                         |HAZ RegulExtra;
                         || tengo que regularizar dos veces
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          || es la segunda regularizacion, previamente he tenido
          || una tipo 9 o 10, recupero los importes reales que iba a cobrar


          |SI nCAUSAGuarda ! 0;
               nCAUSA = nCAUSAGuarda;
               nCAUSAGuarda = 0;
          |SINO;
               nCAUSA = 1;
          |FINSI;

          nRETRIB = nRETRIBGuarda;
          nIMPORTE = nIMPORTEGuarda;
          nGASTOS = nGASTOSGuarda;

          || estas variables las cojo de lo que me ha resultado
          || de la primera Regularizacion

          |SI nCAUSA2 = 19;
               aPRESVIV1 = aPRESVIV1Guarda;
               aPRESVIV2 = aPRESVIV2Guarda;
               || ahora lo dejo como estaba, la segunda regularizacion es
               || cuando tengo  que tener en cuenta lo de la vivienda
          |FINSI;
          |SI nCAUSA2 = 20;     || migue
               aPRESVIV1 = aPRESVIV1Guarda;
               aPRESVIV2 = aPRESVIV2Guarda;
               || ahora lo dejo como estaba, la segunda regularizacion es
               || cuando tengo  que tener en cuenta lo de la vivienda
          |FINSI;

          |SI nElAnyIRPF [ 2010;
               swSigue = 2;
               aMINORADO = aPRESVIV;
          |SINO;
               aMINORADO1 = aPRESVIV1;       || 2011
               aMINORADO2 = aPRESVIV2;       || 2010 o anterior
          |FINSI;
          nMINOPAGOa = nMINOPAGO;
          nTIPOA = nTIPO;

          |HAZ RegulExtra;
     |FINSI;
|FPRC;

|PROCESO Regulariza2011;
     |MODULO aAlfa;
     |QBF aAlfa;
     |SI aAlfa = "nomir001";
          |SI #102#124 = "S"; |O #102#126 = "S";
               nPERCIBIDO = 0;
               nRETENIDO = 0;
          |FINSI;
     |FINSI;

     |SI nPERCIBIDO = 0; |Y nRETENIDO = 0;
          |ACABA;
     |FINSI;
     |SI nElAnyIRPF = 2011; |O nMes2012 = 1;
          |HAZ CausaReg2011;
     |FINSI;
     |SI nMes2012 ] 2;
          |HAZ CausaReg2012;
     |FINSI;

     || (1) calculos anteriores a 2015 en el nomirold

     |SI nElAnyIRPF = 2015; |Y nMes2015 [ 6;
          swSI = 0;
          |SI #102#14 = "S"; |Y #102#115 = "N"; |Y #102#116 = 7;
               nIMPORTEREG = (nPERCIBIDO * (nCUOTA / nRETRIB));
               nIMPORTEREG = nIMPORTEREG + ((nRETRIB - nPERCIBIDO) * ((nCUOTA / 2) / nRETRIB));
          |SINO;
               |SI #102#115 = "S"; |Y #102#116 = 8;
                    nIMPORTEREG = nPERCIBIDO * ((nCUOTA / 2) / nRETRIB);
                    nIMPORTEREG = nIMPORTEREG + ((nRETRIB - nPERCIBIDO) * (nCUOTA / nRETRIB));
               |SINO;
                    |SI #102#14 = "S"; |Y #102#115 = "S";
                         nIMPORTEREG = nCUOTA / 2;
                    |SINO;
                         nIMPORTEREG = nCUOTA;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

|| C lculo importe para la determinación del tipo de retenci¢n a partir de la regularizaci¢n
|| julio 2018
     swSigue = 0;
     |SI nElAnyIRPF = 2015; |Y nMes2015 ] 7;
          swSigue = 1;
     |FINSI;
     |SI nElAnyIRPF ] 2016;
          swSigue = 1;
     |FINSI;
     |SI nElAnyIRPF = 2018; |Y swCambio2018 = 1;
           |SI nElMesIRPF ] 7; |O nDiferencias = 1;
                swSigue = 2;
           |FINSI;
     |FINSI;
     |SI nElAnyIRPF ] 2019;
          swSigue = 3;
     |FINSI;

     |SI swSigue = 1; |O swSigue = 2; |O swSigue = 3;
          swSI = 0;
          |SI #102#14 = "S"; |Y #102#115 = "N";
               |SI swSigue = 1; |O swSigue = 2;
                    |SI #102#116 = 7; |O #102#116 = 11;
                         swSI = 1;
                    |FINSI;
               |FINSI;
               |SI swSigue = 3;
                    |SI #102#116 = 7;
                         swSI = 1;
                    |FINSI;
               |FINSI;
          |FINSI;

          |SI swSigue = 1; nRedCeuMel = 0.5; |FINSI;
          |SI swSigue = 2; nRedCeuMel = 0.4; |FINSI;
          |SI swSigue = 3; nRedCeuMel = 0.4; |FINSI;

          |SI swSI = 1;
               nIMPORTEREG = (nPERCIBIDO * (nCUOTA / nRETRIB));
               nIMPORTEREG = nIMPORTEREG + ((nRETRIB - nPERCIBIDO) * ((nCUOTA * nRedCeuMel) / nRETRIB));
          |SINO;
               swSI = 0;
               |SI #102#115 = "S";
                    |SI swSigue = 1; |O swSigue = 2;
                         |SI #102#116 = 8; |O #102#116 = 11;
                              swSI = 1;
                         |FINSI;
                    |FINSI;
                    |SI swSigue = 3;
                         |SI #102#116 = 8;
                              swSI = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI swSI = 1;
                    nIMPORTEREG = nPERCIBIDO * ((nCUOTA * nRedCeuMel) / nRETRIB);
                    nIMPORTEREG = nIMPORTEREG + ((nRETRIB - nPERCIBIDO) * (nCUOTA / nRETRIB));
               |SINO;
                    |SI #102#14 = "S"; |Y #102#115 = "S";
                         nIMPORTEREG = nCUOTA * nRedCeuMel;
                    |SINO;
                         nIMPORTEREG = nCUOTA;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

                         || tratamiento especial por minoracion por pagos de
                         || prestamos para la vivienda habitual

|| AQUI ESTA EL PROBLEMA
     || ojo, que tengo que saber si este campo venia cargado o no, si ya
     || venia cargado, a ver por que puse esa condicion ahi

     |SI nMINOPAGOa > 0;      || si tengo minoracion o no
          |SI aPRESVIV1a = "S";
               aMINORADO1 = "S";
          |FINSI;
          |SI aPRESVIV2a = "S";
               aMINORADO2 = "S";
          |FINSI;
     |SINO;
          aMINORADO1 = "N";
          aMINORADO2 = "N";
     |FINSI;

     nMINOPAGO_TODO = nMINOPAGO;
     |SI nCAUSA ] 1; |Y nCAUSA [ 8;
          nDedVivTra = 0;
          nDedVivGen = 0;

          |SI nElAnyIRPF = 2011;
               |SI aMINORADO1 = "S"; |Y aPRESVIV1 = "S"; |Y nRETRIB < 22000.00;
                    nDedVivGen = 1;     || 2011
               |FINSI;
               |SI aMINORADO2 = "S"; |Y aPRESVIV2 = "S"; |Y nRETRIB < 33007.20;
                    nDedVivTra = 1;     || 2010 o anterior
               |FINSI;
          |FINSI;
          |SI nElAnyIRPF = 2012; |Y nMes2012 = 1;
               |SI aMINORADO1 = "S"; |O aMINORADO2 = "S";
                    |SI aPRESVIV1 = "S"; |Y nRETRIB < 22000.00;
                         nDedVivGen = 1;     || 2011
                    |FINSI;
               |FINSI;
               |SI aMINORADO1 = "S"; |O aMINORADO2 = "S";
                    |SI aPRESVIV2 = "S"; |Y nRETRIB < 33007.20;
                         nDedVivTra = 1;     || 2010 o anterior
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI nMes2012 ] 2;
               |SI aMINORADO1 = "S"; |O aMINORADO2 = "S";
                    |SI aPRESVIV1 = "S"; |Y nRETRIB < 33007.20;
                         nDedVivGen = 1;     || 2011
                    |FINSI;
               |FINSI;
               |SI aMINORADO1 = "S"; |O aMINORADO2 = "S";
                    |SI aPRESVIV2 = "S"; |Y nRETRIB < 33007.20;
                         nDedVivTra = 1;     || 2010 o anterior
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI nDedVivGen = 1; |O nDedVivTra = 1;
               |SI nRETRIB > nRETRIBa;
                    nMINOPAGO = nMINOPAGOa + ((nRETRIB - nRETRIBa) % 2);
               |SINO;
                    |SI nRETRIB < nRETRIBa;
                         nMINOPAGO = nMINOPAGOa - ((nRETRIBa - nRETRIB) % 2);
                    |SINO;
                         nMINOPAGO = nMINOPAGOa;
                    |FINSI;
               |FINSI;
          |SINO;
               nDedVivTra = 0;
               nDedVivGen = 0;
               |SI nElAnyIRPF = 2011;
                    |SI aMINORADO1 = "S"; |Y aPRESVIV1 = "N";
                         nDedVivGen = 1;     || 2011
                    |FINSI;
                    |SI aMINORADO2 = "S"; |Y aPRESVIV2 = "N";
                         nDedVivTra = 1;     || 2010 o anterior
                    |FINSI;
               |FINSI;
               |SI nElAnyIRPF ] 2012;
                    |SI aMINORADO1 = "S"; |O aMINORADO2 = "S";
                         |SI aPRESVIV1 = "N"; |Y aPRESVIV2 = "N";
                              nDedVivGen = 1;     || 2011
                              nDedVivTra = 1;     || 2010 o anterior
                              || en verdad basta con un switch, da igual
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI nDedVivGen = 1; |O nDedVivTra = 1;
                    nMINOPAGO = nMINOPAGOa;
               |SINO;
                    nMINOPAGO = 0;
               |FINSI;
          |FINSI;
     |SINO;
          nDedVivTra = 0;
          nDedVivGen = 0;
          |SI aPRESVIV1 = "S"; |Y nRETRIB < 22000.00;
               nDedVivGen = 1;     || 2011
          |FINSI;
          |SI nMes2012 ] 2;        || a partir de febrero de 2012
               |SI aPRESVIV1 = "S"; |Y nRETRIB < 33007.20;
                    nDedVivGen = 1;
               |FINSI;
          |FINSI;
          |SI aPRESVIV2 = "S"; |Y nRETRIB < 33007.20;
               nDedVivTra = 1;     || 2010 o anterior
          |FINSI;
          nDedViv = nDedVivGen + nDedVivTra;
          |SI nCAUSA = 9; |Y nDedViv ! 0;
               |SI aMINORADO1 = "S"; |O aMINORADO2 = "S";
                    nMINOPAGO = nMINOPAGOa + ((nRETRIB - nPERCIBIDO) % 2);
               |SINO;
                    nMINOPAGO = (nRETRIB - nPERCIBIDO) % 2;
               |FINSI;
          |SINO;
               nDedVivTra = 0;
               nDedVivGen = 0;
               |SI nElAnyIRPF = 2011;
                    |SI aMINORADO1 = "S"; |Y aPRESVIV1 = "N";
                         nDedVivGen = 1;     || 2011
                    |FINSI;
                    |SI aMINORADO2 = "S"; |Y aPRESVIV2 = "N";
                         nDedVivTra = 1;     || 2010 o anterior
                    |FINSI;
               |FINSI;
               |SI nElAnyIRPF ] 2012;
                    |SI aMINORADO1 = "S"; |O aMINORADO2 = "S";
                         |SI aPRESVIV1 = "N"; |Y aPRESVIV2 = "N";
                              nDedVivGen = 1;     || 2011
                              nDedVivTra = 1;     || 2010 o anterior
                              || en verdad basta con un switch, da igual
                         |FINSI;
                    |FINSI;
               |FINSI;

               nDedViv = nDedVivTra + nDedVivGen;

               |SI nCAUSA = 10; |Y nDedViv ! 0;
                    nMINOPAGO = nMINOPAGOa - ((nRETRIB - nPERCIBIDO) % 2);
               |SINO;
                    nDedVivTra = 0;
                    nDedVivGen = 0;
                    |SI aPRESVIV1 = "S"; |Y nRETRIB < 22000.00;
                         nDedVivGen = 1;     || 2011
                    |FINSI;
                    |SI nMes2012 ] 2;        || a partir de febrero de 2012
                         |SI aPRESVIV1 = "S"; |Y nRETRIB < 33007.20;
                              nDedVivGen = 1;
                         |FINSI;
                    |FINSI;
                    |SI aPRESVIV2 = "S"; |Y nRETRIB < 33007.20;
                         nDedVivTra = 1;     || 2010 o anterior
                    |FINSI;
                    nDedViv = nDedVivGen + nDedVivTra;

|| AQUIIIIIIIIIIIIIIIII
                    |SI nElAnyIRPF = 2011; |O nMes2012 = 1;
                         |SI nCAUSA = 11; |Y nDedViv ! 0;
                              nMINOPAGO = (nRETRIB - nPERCIBIDO) % 2;
                         |SINO;
                              nMINOPAGO = 0;
                         |FINSI;
                    |FINSI;
                    |SI nMes2012 ] 2;
                         |SI nElAnyIRPF = 2012;
                              |SI nCAUSA = 11; |Y nDedViv ! 0;
                                   |SI nRETRIB > nRETRIBa;
                                        nMINOPAGO = nMINOPAGOa + ((nRETRIB - nRETRIBa) % 2);
                                   |SINO;
                                        |SI nRETRIB < nRETRIBa;
                                             nMINOPAGO = nMINOPAGOa - ((nRETRIBa - nRETRIB) % 2);
                                        |SINO;
                                             nMINOPAGO = nMINOPAGOa;
                                        |FINSI;
                                   |FINSI;
                              |SINO;
                                   nDedViv = 0;
                                   |SI aMINORADO1 = "S"; |O aMINORADO2 = "S";
                                        |SI aPRESVIV1 = "N"; |Y aPRESVIV2 = "N";
                                             nDedVivGen = 1;     || 2011
                                             nDedVivTra = 1;     || 2010 o anterior
                                             || en verdad basta con un switch, da igual
                                        |FINSI;
                                   |FINSI;
                                   nDedViv = nDedVivGen + nDedVivTra;
                                   |SI nDedViv = 1;
                                        nMINOPAGO = nPERCIBIDO % 2;
                                   |SINO;
                                        nDedViv = 0;
                                        |SI aMINORADO1 = "N"; |Y aMINORADO2 = "N";
                                             |SI aPRESVIV1 = "S"; |O aPRESVIV2 = "S";
                                                  nDedVivGen = 1;     || 2011
                                                  nDedVivTra = 1;     || 2010 o anterior
                                                  || en verdad basta con un switch, da igual
                                             |FINSI;
                                        |FINSI;
                                        nDedViv = nDedVivGen + nDedVivTra;
                                        |SI nDedViv = 1; |Y nRETRIB < 33007.20;
                                             nMINOPAGO = (nRETRIB - nPERCIBIDO) % 2;
                                        |SINO;
                                             nMINOPAGO = 0;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                         |FINSI;        || fin para el 2012

                         |SI nElAnyIRPF ] 2013; |Y nElAnyIRPF [ 2014;
                              |SI nCAUSA = 11; |Y nDedViv ! 0; |Y nRETRIB < 33007.20;
                                   nMINOPAGO = (nRETRIB - nPERCIBIDO) % 2;
                              |SINO;
                                   nMINOPAGO = 0;
                              |FINSI;
                         |FINSI;

                         |SI nElAnyIRPF = 2015; |Y nMes2015 [ 6;
                              |SI nCAUSA = 11; |Y nDedViv ! 0; |Y nRETRIB < 33007.20;
                                   nMINOPAGO = (nRETRIB - nPERCIBIDO) % 2;
                              |SINO;
                                   nMINOPAGO = 0;
                              |FINSI;
                         |FINSI;

                         swSigue = 0;
                         |SI nElAnyIRPF = 2015; |Y nMes2015 ] 7;
                              swSigue = 1;
                         |FINSI;
                         |SI nElAnyIRPF ] 2016;
                              swSigue = 1;
                         |FINSI;
                         || julio 2018
                         |SI nElAnyIRPF = 2018; |Y swCambio2018 = 1;
                              |SI nElMesIRPF ] 7; |O nDiferencias = 1;
                                   swSigue = 2;
                              |FINSI;
                         |FINSI;
                         |SI nElAnyIRPF ] 2019;
                              swSigue = 3;
                         |FINSI;

                         |SI swSigue = 1;
                              || lo nuevo
                              |SI nCAUSA = 11; |Y nDedViv ! 0; |Y nRETRIB < 33007.20;
                                   |SI aMINORADO = "S"; |Y aPRESVIV = "S"; |Y nRETRIB < 33007.20;
                                        |SI nRETRIB > nRETRIBa;
                                             nMINOPAGO = nMINOPAGOa + ((nRETRIB - nRETRIBa) % 2);
                                        |SINO;
                                             |SI nRETRIB < nRETRIBa;
                                                  nMINOPAGO = nMINOPAGOa - ((nRETRIBa - nRETRIB) % 2);
                                             |SINO;
                                                  nMINOPAGO = nMINOPAGOa;
                                             |FINSI;
                                        |FINSI;
                                   |SINO;
                                        |SI aMINORADO = "S"; |Y aPRESVIV = "N";
                                             nMINOPAGO = nMINOPAGOa;
                                        |SINO;
                                             |SI aMINORADO = "S"; |Y aPRESVIV = "S"; |Y nRETRIB < 33007.20;
                                                  nMINOPAGO = (nRETRIB - nPERCIBIDO) % 2;
                                             |SINO;
                                                  nMINOPAGO = 0;
                                             |FINSI;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                         |FINSI;

                         |SI swSigue = 2;
                              || lo nuevo a partir de julio de 2018
                              |SI nCAUSA = 11; |Y nDedViv ! 0;
                                   |SI aMINORADO = "S"; |Y aPRESVIV = "S"; |Y nRETRIB < 33007.20;
                                        |SI nRETRIB > nRETRIBa;
                                             nMINOPAGO = nMINOPAGOa + ((nRETRIB - nRETRIBa) % 2);
                                        |SINO;
                                             |SI nRETRIB < nRETRIBa;
                                                  nMINOPAGO = nMINOPAGOa - ((nRETRIBa - nRETRIB) % 2);
                                             |SINO;
                                                  nMINOPAGO = nMINOPAGOa;
                                             |FINSI;
                                        |FINSI;
                                   |SINO;
                                        |SI aMINORADO = "S"; |Y aPRESVIV = "N";
                                             nMINOPAGO = nMINOPAGOa;
                                        |SINO;
                                             |SI aMINORADO = "S"; |Y aPRESVIV = "S"; |Y nRETRIB < 33007.20;
                                                  nMINOPAGO = (nRETRIB - nPERCIBIDO) % 2;
                                             |SINO;
                                                  nMINOPAGO = 0;
                                             |FINSI;
                                        |FINSI;
                                   |FINSI;
                              |FINSI;
                         |FINSI;

                         |SI swSigue = 3;    || a partir de 2019
                              |SI nCAUSA = 11; |Y nDedViv ! 0; |Y nRETRIB < 33007.20;
                                   nMINOPAGO = (nRETRIB - nPERCIBIDO) % 2;
                              |SINO;
                                   nMINOPAGO = 0;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

     nNume = 33007.20 % 2;
     |SI aPRESVIV2 = "S"; |Y nMINOPAGO > nNume;
          nMINOPAGO = nNume;
     |FINSI;

     |SI nElAnyIRPF = 2011; |O nMes2012 = 1;
          nNume = 22000.00 % 2;
          |SI aPRESVIV1 = "S"; |Y nMINOPAGO > nNume;
               nMINOPAGO = nNume;
          |FINSI;
     |FINSI;

     |SI nMes2012 ] 2;
          nNume = 33007.20 % 2;
          |SI aPRESVIV1 = "S"; |Y nMINOPAGO > nNume;
               nMINOPAGO = nNume;
          |FINSI;
     |FINSI;

     || calculo del tipo de retencion a partir de la regularizacion

     |SI nElAnyIRPF = 2009;
          nMINOPAGO = nMINOPAGO ! 2;
          nTIPOREG = ((nIMPORTEPREVIO - nRETENIDO - 400 - nMINOPAGO) / (nRETRIB - nPERCIBIDO)) * 100;
     |FINSI;
     |SI nElAnyIRPF ] 2010;
          nMINOPAGO = nMINOPAGO - .005;              || trunca a dos decimales
          nMINOPAGO = nMINOPAGO ! 2;
          |SI nMINOPAGO < 0; nMINOPAGO = 0;     |FINSI;
          |SI nElAnyIRPF [ 2014;
               nTIPOREG = ((nIMPORTEPREVIO - nRETENIDO - nDEDUCCION - nMINOPAGO) / (nRETRIB - nPERCIBIDO)) * 100;
          |FINSI;
          |SI nElAnyIRPF ] 2015;
               nTIPOREG = ((nIMPORTEREG - nRETENIDO - nMINOPAGO) / (nRETRIB - nPERCIBIDO)) * 100;
          |FINSI;
     |FINSI;

     |SI nTIPOREG < 0; nTIPOREG = 0;     |FINSI;

     nTIPOREG = nTIPOREG - .005;              || trunca a dos decimales
     nTIPOREG = nTIPOREG ! 2;

     |SI nTIPOREG < 0; nTIPOREG = 0;     |FINSI;

                    || limites generales (max. 45% y min 15%, 2%)
                    || Febrero 2012: limites generales (max. 52% y min 15%, 2%)

     |SI nElAnyIRPF = 2011; |O nMes2012 = 1;
          nLimiteRet1 = 23;
          nLimiteRet2 = 45;
          nLimiteRet3 = 8;
          nLimiteRet4 = 1;
     |FINSI;
     |SI nMes2012 ] 2; |Y nElAnyIRPF [ 2014;
          nLimiteRet1 = 26;
          nLimiteRet2 = 52;
          nLimiteRet3 = 8;
          nLimiteRet4 = 1;
     |FINSI;
     |SI nElAnyIRPF = 2015;
          nLimiteRet1 = 24;
          nLimiteRet2 = 47;
          nLimiteRet3 = 8;
          nLimiteRet4 = 1;
     |FINSI;
     |SI nElAnyIRPF ] 2016;
          nLimiteRet1 = 23;
          nLimiteRet2 = 45;
          nLimiteRet3 = 8;
          nLimiteRet4 = 1;
     |FINSI;
     |SI nElAnyIRPF ] 2019;
          nLimiteRet1 = 18;
          nLimiteRet2 = 45;
          nLimiteRet3 = 6;
          nLimiteRet4 = 0.8;
     |FINSI;

     |SI #102#14 = "S";
          |SI #102#115 = "S"; |Y nTIPOREG > nLimiteRet1;
               nTIPOREG = nLimiteRet1;
          |SINO;
               |SI nTIPOREG > nLimiteRet2;
                    nTIPOREG = nLimiteRet2;
               |SINO;
                    |SI nCONTRATO = "3"; |Y nTIPOREG < nLimiteRet3;
                         nTIPOREG = nLimiteRet3;
                    |SINO;
                         |SI nCONTRATO = "2"; |Y nTIPOREG < nLimiteRet4;
                              nTIPOREG = nLimiteRet4;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          |SI nTIPOREG > nLimiteRet2;
               nTIPOREG = nLimiteRet2;
          |SINO;
               |SI nCONTRATO = "3"; |Y nTIPOREG < 15;
                    nTIPOREG = 15;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPOREG < 2;
                         nTIPOREG = 2;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
                         || calculo del importe anual de la retencion
     nIMPORTE = (((nRETRIB - nPERCIBIDO) * nTIPOREG) / 100) + nRETENIDO;
     nIMPORTE = nIMPORTE ! EURODB;

     |SI nCAUSA = 5; |O nCAUSA = 6; |O nCAUSA = 8; |O nCAUSA = 9; |O nCAUSA = 10;
     |O nCAUSA = 11;
          nTIPO = nTIPOREG;
          |ACABA;
     |FINSI;

     || Atencion, La causa 1 no debe entrar por aqui tampoco. Segun el algo-
     || ritmo si, pero segun nuestros calculos no, ya que cuando regulariza-
     || mos durante el a¤o, si el mes anterior tenia mal calculado el % como
     || pudo suceder en algunas nominas de febrero, mantiene como base el %
     || del mes anterior si este sube, con lo que NO me regularizaba, esto
     || NO es correcto. Viene todo del tiquet 2752.424 de Colas
     |SI nCAUSA = 1;
          nTIPO = nTIPOREG;
          |ACABA;
     |FINSI;

     || limite de art. 81.5

     aBASEA = nBASEA;
     nBASEA = aBASEA;
     aBASE  = nBASE;
     nBASE  = aBASE;

     aREVISAR = "N";
     nNume2 = nBASEA;
     nNume3 = nMINPERFAA;
     nNume1 = nNume2 - nNume3;
     nDIFERENCIA = nNume1;

     |SI nDIFERENCIA < 0;
          nDIFERENCIA = 0;
     |FINSI;

     nNume1 = nBASE - nMINPERFA;

     |SI nDIFERENCIA ] nNume1; |Y nTIPOREG > nTIPOA;
          nTIPOREG = nTIPOA;
          aREVISAR = "S";
     |SINO;
          |SI nDIFERENCIA < nNume1; |Y nIMPORTEA < nIMPORTE;
               nINCREIMPORTE = nIMPORTE - nIMPORTEA;
               nINCREBASEMIN = nNume1 - nDIFERENCIA;
               |SI nINCREIMPORTE > nINCREBASEMIN;
                    aREVISAR = "S";
                    nIMPORTE = nIMPORTEA + nINCREBASEMIN;
                    nTIPOREG = ((nIMPORTE - nRETENIDO) / (nRETRIB - nPERCIBIDO));
                    nTIPOREG = nTIPOREG * 100;
                    |SI nTIPOREG < 0;
                         nTIPOREG = 0;
                    |SINO;
                         nTIPOREG = nTIPOREG - .005;   || trunca a dos decimales
                         nTIPOREG = nTIPOREG ! 2;
                         nIMPORTE = ((nRETRIB - nPERCIBIDO) * nTIPOREG) / 100;
                         nIMPORTE = nIMPORTE + nRETENIDO;
                         nINCREIMPORTE = nIMPORTE - nIMPORTEA;
                    |FINSI;
                    |SI nINCREIMPORTE > nINCREBASEMIN; |Y nTIPOREG > 0;
                         nTIPOREG = (nIMPORTEA + nINCREBASEMIN - nRETENIDO);
                         nTIPOREG = nTIPOREG / ((nRETRIB - nPERCIBIDO) * 100);
                         nTIPOREG = nTIPOREG - .005;   || trunca a dos decimales
                         nTIPOREG = nTIPOREG ! 2;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI aREVISAR = "S";
          |SI #102#14 = "S";
               |SI nCONTRATO = "3"; |Y nTIPOREG < nLimiteRet3;
                    nTIPOREG = nLimiteRet3;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPOREG < nLimiteRet4;
                         nTIPOREG = nLimiteRet4;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI nCONTRATO = "3"; |Y nTIPOREG < 15;
                    nTIPOREG = 15;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPOREG < 2;
                         nTIPOREG = 2;
                    |FINSI;
               |FINSI;
          |FINSI;
          nIMPORTE = (((nRETRIB - nPERCIBIDO) * nTIPOREG) / 100) + nRETENIDO;
     |FINSI;
     nTIPO = nTIPOREG;
|FPRC;

|PROCESO CausaReg2010;
     |SI nCAUSA2 = 0;
          || es la primera regularizacion, es un tipo 9 o 10 SIN tener en
          || cuenta los importes nuevos retefentes a ingresos

          nCAUSA = #102#116;  || causa regularizacion
          |SI nCAUSA = 0; |O nCAUSA > 11;
               nCAUSA = 11;
          |FINSI;

          aPRESVIV = #102#124;     || se acoge a reduccion por prestamo para
                                   || inversion en vivienda o no se acoge
          |SI nMINOPAGOa ! 0;      || en algun momento he tenido deduccion por
               nCAUSA = 1;         || inversion en vivienda, ya no puedo usar
          |FINSI;                  || la causa 11
          |SI aPRESVIV = "S";      || este mes me practico deduccion
               |SI aPRESVIVa = "N";           || el mes anterior tenia que NO
                    |SI nRETRIB < 33007.20;
                         |SI nRETRIBa ] 33007.20;  || el mes anterior tenia que NO tengo
                              nCAUSA = 1;         || que usar causa 9, empiezo este mes
                         |SINO;
                              nCAUSA = 9;         || que usar causa 9, empiezo este mes
                         |FINSI;
                    |SINO;
                         aPRESVIV = "N";
                    |FINSI;
                    |SI nElMesIRPF = 2; |Y nElAnyIRPF = 2009; |Y nMINOPAGO ! 0;
                         || ojo, estamos en febrero de 2009 y el campo 105 del
                         || nomir012 no existia, si tengo importe min. supongo
                         || que el mes pasado se practico y no se pudo grabar
                         || aunque tuviera el campo a "N"

                         |SI nMINOPAGOb > 0;
                              |SI swLocalizado = 2;
                              || tenia deduccion vivienda con el campito = "N"
                              || en enero, regularice y todo fue correcto
                              || entonces es correcto lo del mes anterior
                                   nCAUSA = 1;
                              |SINO;
                                   nCAUSA = 11;
                                   nRETENIDO = 0;
                                   nPERCIBIDO = 0;
                              |FINSI;
                         |SINO;
                              |SI swLocalizado ] 2; |Y nCAUSA = 9;
                              |SINO;
                                   nCAUSA = 11;
                              |FINSI;
                              || como no tengo datos del mes anterior, pues como
                              || si fuera el primer calculo, pongo esto a cero para
                              || que NO me regularice
                         |FINSI;
                    |FINSI;
               |SINO;
                    |SI nElMesIRPF = 2; |Y nElAnyIRPF = 2009; |Y nMINOPAGO ! 0;
                         || ojo, estamos en febrero de 2009 y el campo 105 del
                         || nomir012 no existia, si tengo importe min. supongo
                         || que el mes pasado se practico y no se pudo grabar
                         || aunque tuviera el campo a "N"

                         |SI swLocalizado = 2;
                         || tenia deduccion vivienda con el campito = "N"
                         || en enero, regularice y todo fue correcto
                         || entonces es correcto lo del mes anterior
                              nCAUSA = 1;
                         |SINO;
                              nCAUSA = 11;
                              nRETENIDO = 0;
                              nPERCIBIDO = 0;
                         |FINSI;
                    |FINSI;
               |FINSI;
               |SI nRETRIBa < 33007.20; |Y nRETRIB ] 33007.20;
                    || tengo deduccion vivienda, y aumento ingresos por
                    || encima del limite
                    |SI aPRESVIVa = "S";     || si el mes anterior tenia ded.
                         nCAUSA = 10;        || viv.
                         aPRESVIV = "N";     || fuerzo a que NO, si no, no calcula
                                        || bien
                    |FINSI;
                    |SI nElMesIRPF = 2; |Y nElAnyIRPF = 2009; |Y nMINOPAGOb ! 0;
                         nCAUSA = 10;        || viv.
                         aPRESVIV = "N";     || fuerzo a que NO, si no, no calcula
                         || esto es para febrero, por si realmente tuvo ded.
                         || viv. el mes pasado y no se grabo el campo
                    |FINSI;
               |FINSI;
          |SINO;
               |SI aPRESVIVa = "S";     || el mes anterior tenia que SI, tengo
                    nCAUSA = 10;        || que usar causa 10, acabo este mes
               |FINSI;
          |FINSI;
          |SI nCAUSA = 9; |O nCAUSA = 10;
               |SI nRETRIB ! nRETRIBa; |Y swLocalizado ! 0; |Y nRETRIBa ! 0;
                    |SI nRETRIB > nRETRIBa;
                         nCAUSA2 = 10 + nCAUSA;

                         nRETRIBGuarda = nRETRIB;      || me guardo los datos reales
                         nIMPORTEGuarda = nIMPORTE;    || de este mes
                         nGASTOSGuarda = nGASTOS;

                         || regularizo una primera vez teniendo en cuenta la ded. viv.
                         || pero con los datos economicos del mes anterior

                         nRETRIB = nRETRIBa;
                         nIMPORTE = nIMPORTEA;
                         nGASTOS = nGASTOSa;

                         |HAZ RegulExtra;

                         || tengo que regularizar dos veces
                    |SINO;
                         nCAUSA2 = 10 + nCAUSA;
                         nCAUSAGuarda = nCAUSA;
                         nCAUSA = 1;

                         nRETRIBGuarda = nRETRIB;      || me guardo los datos reales
                         nIMPORTEGuarda = nIMPORTE;    || de este mes
                         nGASTOSGuarda = nGASTOS;

                         || regularizo una primera SIN tener en cuenta la ded. viv.
                         || con los datos economicos nuevos

                         |HAZ RegulExtra;
                         || tengo que regularizar dos veces
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          || es la segunda regularizacion, previamente he tenido
          || una tipo 9 o 10, recupero los importes reales que iba a cobrar


          |SI nCAUSAGuarda ! 0;
               nCAUSA = nCAUSAGuarda;
               nCAUSAGuarda = 0;
          |SINO;
               nCAUSA = 1;
          |FINSI;

          nRETRIB = nRETRIBGuarda;
          nIMPORTE = nIMPORTEGuarda;
          nGASTOS = nGASTOSGuarda;

          || estas variables las cojo de lo que me ha resultado
          || de la primera Regularizacion

          |SI nElAnyIRPF [ 2010;
               aMINORADO = aPRESVIV;
          |SINO;
               aMINORADO1 = aPRESVIV1;       || 2011
               aMINORADO2 = aPRESVIV2;       || 2010 o anterior
          |FINSI;
          nMINOPAGOa = nMINOPAGO;
          nTIPOA = nTIPO;

          |HAZ RegulExtra;
     |FINSI;
|FPRC;

|PROCESO Regulariza2009;
     |MODULO aAlfa;
     |QBF aAlfa;
     |SI aAlfa = "nomir001"; |Y #102#124 = "S";
          nPERCIBIDO = 0;
          nRETENIDO = 0;
     |FINSI;

     |SI nPERCIBIDO = 0; |Y nRETENIDO = 0;
          |ACABA;
     |FINSI;

     |HAZ CausaReg2010;

                         || tratamiento especial Ceuta y Melilla
     |SI #102#14 = "S"; |Y #102#115 = "N"; |Y #102#116 = 7;
          nIMPORTEPREVIO = (nPERCIBIDO * nTIPOPREVIOR) / 100;
          nIMPORTEPREVIO = (nRETRIB - nPERCIBIDO) * nTIPOPREVIOCMR / 100;
     |SINO;
          |SI #102#14 = "N"; |Y #102#115 = "S"; |Y #102#116 = 8;
               nIMPORTEPREVIO = (nPERCIBIDO * nTIPOPREVIOCMR) / 100;
               nIMPORTEPREVIO = (nRETRIB - nPERCIBIDO) * nTIPOPREVIOR / 100;
          |FINSI;
     |FINSI;
                         || tratamiento especial por minoracion por pagos de
                         || prestamos para la vivienda habitual
     |SI nMINOPAGOa > 0;      || si tengo minoracion o no
          aMINORADO = "S";
     |SINO;
          aMINORADO = "N";
     |FINSI;

     |SI nElMesIRPF = 2; |Y nElAnyIRPF = 2009; |Y nMINOPAGO ! 0;
          || caso de que en la nomina de febrero de 2009 el trabajador
          || tuviera deduccion de vivienda y el campo de importe del mes
          || anterior no se quedara grabado no la aplicaria por culpa de la
          || condicion anterior.

          aMINORADO = "S";
     |FINSI;

     |SI nCAUSA ] 1; |Y nCAUSA [ 8;
          |SI aMINORADO = "S"; |Y aPRESVIV = "S"; |Y nRETRIB < 33007.20;
               |SI nRETRIB > nRETRIBa;
                    nMINOPAGO = nMINOPAGOa + ((nRETRIB - nRETRIBa) % 2);
               |SINO;
                    |SI nRETRIB < nRETRIBa;
                         nMINOPAGO = nMINOPAGOa - ((nRETRIBa - nRETRIB) % 2);
                    |SINO;
                         nMINOPAGO = nMINOPAGOa;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI aMINORADO = "S"; |Y aPRESVIV = "N";
                    nMINOPAGO = nMINOPAGOa;
               |SINO;
                    nMINOPAGO = 0;
               |FINSI;
          |FINSI;
     |SINO;
          |SI nCAUSA = 9; |Y aPRESVIV = "S"; |Y nRETRIB < 33007.20;
               |SI aMINORADO = "S";
                    nMINOPAGO = nMINOPAGOa + ((nRETRIB - nPERCIBIDO) % 2);
               |SINO;
                    nMINOPAGO = (nRETRIB - nPERCIBIDO) % 2;
               |FINSI;
          |SINO;
               |SI nCAUSA = 10; |Y aMINORADO = "S"; |Y aPRESVIV = "N";
                    nMINOPAGO = nMINOPAGOa - ((nRETRIB - nPERCIBIDO) % 2);
               |SINO;
                    |SI nCAUSA = 11; |Y aPRESVIV = "S"; |Y nRETRIB < 33007.20;
                         nMINOPAGO = (nRETRIB - nPERCIBIDO) % 2;
                    |SINO;
                         nMINOPAGO = 0;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

|| a ver, al hacer el algoritmo de IRPF del 2010 me doy cuenta de que
|| aqui estaba esto asi:
     ||nNume = 33007.20 % 2;
     ||SI nMINOPAGOa > nNume;
     ||     nMINOPAGOa = nNume;
     ||FINSI;
|| cuando esa comparacion debe hacerse para MINOPAGO y no para MINOPAGOa
|| segun el algoritmo, esto no tiene mucho sentido, pero lo dejo con MINOPAGO
|| para el 2009 y para el 2010, realmente no tiene importancia ya que eso
|| sirve para limitar la minoracion de pagos por deduccion vivienda y es
|| imposible que supere el 2% del limite, pero bueno como nunca se sabe
|| esto queda aqui dicho por si hubiera algun problema 02.12.2009

     nNume = 33007.20 % 2;
     |SI nMINOPAGO > nNume;
          nMINOPAGO = nNume;
     |FINSI;

     || calculo del tipo de retencion
     |SI nElAnyIRPF = 2009;
          nMINOPAGO = nMINOPAGO ! 2;
          nTIPOREG = ((nIMPORTEPREVIO - nRETENIDO - 400 - nMINOPAGO) / (nRETRIB - nPERCIBIDO)) * 100;
     |FINSI;
     |SI nElAnyIRPF ] 2010;
          nMINOPAGO = nMINOPAGO - .005;              || trunca a dos decimales
          nMINOPAGO = nMINOPAGO ! 2;
          |SI nMINOPAGO < 0; nMINOPAGO = 0;     |FINSI;
          nTIPOREG = ((nIMPORTEPREVIO - nRETENIDO - nDEDUCCION - nMINOPAGO) / (nRETRIB - nPERCIBIDO)) * 100;
     |FINSI;

     |SI nTIPOREG < 0; nTIPOREG = 0;     |FINSI;

     nTIPOREG = nTIPOREG - .005;              || trunca a dos decimales
     nTIPOREG = nTIPOREG ! 2;

     |SI nTIPOREG < 0; nTIPOREG = 0;     |FINSI;

                         || limites generales (max. 43% y min 15%, 2%)
     |SI #102#14 = "S";
          |SI #102#115 = "S"; |Y nTIPOREG > 22;
               nTIPOREG = 22;
          |SINO;
               |SI nTIPOREG > 43;
                    nTIPOREG = 43;
               |SINO;
                    |SI nCONTRATO = "3"; |Y nTIPOREG < 8;
                         nTIPOREG = 8;
                    |SINO;
                         |SI nCONTRATO = "2"; |Y nTIPOREG < 1;
                              nTIPOREG = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          |SI nTIPOREG > 43;
               nTIPOREG = 43;
          |SINO;
               |SI nCONTRATO = "3"; |Y nTIPOREG < 15;
                    nTIPOREG = 15;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPOREG < 2;
                         nTIPOREG = 2;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
                         || calculo del importe anual de la retencion
     nIMPORTE = (((nRETRIB - nPERCIBIDO) * nTIPOREG) / 100) + nRETENIDO;
     nIMPORTE = nIMPORTE ! EURODB;

     |SI nCAUSA = 5; |O nCAUSA = 6; |O nCAUSA = 8; |O nCAUSA = 9; |O nCAUSA = 10;
     |O nCAUSA = 11;
          nTIPO = nTIPOREG;
          |ACABA;
     |FINSI;

     || Atencion, La causa 1 no debe entrar por aqui tampoco. Segun el algo-
     || ritmo si, pero segun nuestros calculos no, ya que cuando regulariza-
     || mos durante el a¤o, si el mes anterior tenia mal calculado el % como
     || pudo suceder en algunas nominas de febrero, mantiene como base el %
     || del mes anterior si este sube, con lo que NO me regularizaba, esto
     || NO es correcto. Viene todo del tiquet 2752.424 de Colas
     |SI nCAUSA = 1;
          nTIPO = nTIPOREG;
          |ACABA;
     |FINSI;

     || limite de art. 81.5

     aBASEA = nBASEA;
     nBASEA = aBASEA;
     aBASE  = nBASE;
     nBASE  = aBASE;

     aREVISAR = "N";
     nNume2 = nBASEA;
     nNume3 = nMINPERFAA;
     nNume1 = nNume2 - nNume3;
     nDIFERENCIA = nNume1;

     |SI nDIFERENCIA < 0;
          nDIFERENCIA = 0;
     |FINSI;

     nNume1 = nBASE - nMINPERFA;

     |SI nDIFERENCIA ] nNume1; |Y nTIPOREG > nTIPOA;
          nTIPOREG = nTIPOA;
          aREVISAR = "S";
     |SINO;
          |SI nDIFERENCIA < nNume1; |Y nIMPORTEA < nIMPORTE;
               nINCREIMPORTE = nIMPORTE - nIMPORTEA;
               nINCREBASEMIN = nNume1 - nDIFERENCIA;
               |SI nINCREIMPORTE > nINCREBASEMIN;
                    aREVISAR = "S";
                    nIMPORTE = nIMPORTEA + nINCREBASEMIN;
                    nTIPOREG = ((nIMPORTE - nRETENIDO) / (nRETRIB - nPERCIBIDO));
                    nTIPOREG = nTIPOREG * 100;
                    |SI nTIPOREG < 0;
                         nTIPOREG = 0;
                    |SINO;
                         nTIPOREG = nTIPOREG - .005;   || trunca a dos decimales
                         nTIPOREG = nTIPOREG ! 2;
                         nIMPORTE = ((nRETRIB - nPERCIBIDO) * nTIPOREG) / 100;
                         nIMPORTE = nIMPORTE + nRETENIDO;
                         nINCREIMPORTE = nIMPORTE - nIMPORTEA;
                    |FINSI;
                    |SI nINCREIMPORTE > nINCREBASEMIN; |Y nTIPOREG > 0;
                         nTIPOREG = (nIMPORTEA + nINCREBASEMIN - nRETENIDO);
                         nTIPOREG = nTIPOREG / ((nRETRIB - nPERCIBIDO) * 100);
                         nTIPOREG = nTIPOREG - .005;   || trunca a dos decimales
                         nTIPOREG = nTIPOREG ! 2;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI aREVISAR = "S";
          |SI #102#14 = "S";
               |SI nCONTRATO = "3"; |Y nTIPOREG < 8;
                    nTIPOREG = 8;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPOREG < 1;
                         nTIPOREG = 1;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI nCONTRATO = "3"; |Y nTIPOREG < 15;
                    nTIPOREG = 15;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPOREG < 2;
                         nTIPOREG = 2;
                    |FINSI;
               |FINSI;
          |FINSI;
          nIMPORTE = (((nRETRIB - nPERCIBIDO) * nTIPOREG) / 100) + nRETENIDO;
     |FINSI;
     nTIPO = nTIPOREG;
|FPRC;


|PROCESO RegularizaJul2008;
                         || tratamiento especial Ceuta y Melilla
     |SI #102#14 = "S"; |Y #102#115 = "N"; |Y #102#116 = 13;
          nIMPORTEPREVIO = (nPERCIBIDO * nTIPOPREVIOR) / 100;
          nIMPORTEPREVIO = (nRETRIB - nPERCIBIDO) * nTIPOPREVIOCMR / 100;
     |SINO;
          |SI #102#14 = "N"; |Y #102#115 = "S"; |Y #102#116 = 14;
               nIMPORTEPREVIO = (nPERCIBIDO * nTIPOPREVIOCMR) / 100;
               nIMPORTEPREVIO = (nRETRIB - nPERCIBIDO) * nTIPOPREVIOR / 100;
          |FINSI;
     |FINSI;

                         || calculo del tipo de retencion
     nTIPOREG = ((nIMPORTEPREVIO - nRETENIDO - 400) / (nRETRIB - nPERCIBIDO)) * 100;

     |SI nTIPOREG < 0; nTIPOREG = 0;     |FINSI;

     nTIPOREG = nTIPOREG - .005;              || trunca a dos decimales
     nTIPOREG = nTIPOREG ! 2;

     |SI nTIPOREG < 0; nTIPOREG = 0;     |FINSI;

                         || limites generales (max. 43% y min 15%, 2%)
     |SI #102#14 = "S";
          |SI #102#115 = "S"; |Y nTIPOREG > 22;
               nTIPOREG = 22;
          |SINO;
               |SI nTIPOREG > 43;
                    nTIPOREG = 43;
               |SINO;
                    |SI nCONTRATO = "3"; |Y nTIPOREG < 8;
                         nTIPOREG = 8;
                    |SINO;
                         |SI nCONTRATO = "2"; |Y nTIPOREG < 1;
                              nTIPOREG = 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |SINO;
          |SI nTIPOREG > 43;
               nTIPOREG = 43;
          |SINO;
               |SI nCONTRATO = "3"; |Y nTIPOREG < 15;
                    nTIPOREG = 15;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPOREG < 2;
                         nTIPOREG = 2;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

                         || calculo del importe anual de la retencion
     nIMPORTE = (((nRETRIB - nPERCIBIDO) * nTIPOREG) / 100) + nRETENIDO;
     nIMPORTE = nIMPORTE ! EURODB;

     |SI #102#116 = 11; |O #102#116 = 12; |O #102#116 = 14; |O #102#116 = 15; |O #102#116 = 0;
          nTIPO = nTIPOREG;
          |ACABA;
     |FINSI;

     || limite de art. 81.5

     aBASEA = nBASEA;
     nBASEA = aBASEA;
     aBASE  = nBASE;
     nBASE  = aBASE;

     aREVISAR = "N";
     nNume2 = nBASEA;
     nNume3 = nMINPERFAA;
     nNume1 = nNume2 - nNume3;
     nDIFERENCIA = nNume1;

     |SI nDIFERENCIA < 0;
          nDIFERENCIA = 0;
     |FINSI;

     nNume1 = nBASE - nMINPERFA;

     |SI nDIFERENCIA ] nNume1; |Y nTIPOREG > nTIPOA;
          nTIPOREG = nTIPOA;
          aREVISAR = "S";
     |SINO;
          |SI nDIFERENCIA < nNume1; |Y nIMPORTEA < nIMPORTE;
               nINCREIMPORTE = nIMPORTE - nIMPORTEA;
               nINCREBASEMIN = nNume1 - nDIFERENCIA;
               |SI nINCREIMPORTE > nINCREBASEMIN;
                    aREVISAR = "S";
                    nIMPORTE = nIMPORTEA + nINCREBASEMIN;
                    nTIPOREG = ((nIMPORTE - nRETENIDO) / (nRETRIB - nPERCIBIDO));
                    nTIPOREG = nTIPOREG * 100;
                    |SI nTIPOREG < 0;
                         nTIPOREG = 0;
                    |SINO;
                         nTIPOREG = nTIPOREG - .005;   || trunca a dos decimales
                         nTIPOREG = nTIPOREG ! 2;
                         nIMPORTE = ((nRETRIB - nPERCIBIDO) * nTIPOREG) / 100;
                         nIMPORTE = nIMPORTE + nRETENIDO;
                         nINCREIMPORTE = nIMPORTE - nIMPORTEA;
                    |FINSI;
                    |SI nINCREIMPORTE > nINCREBASEMIN; |Y nTIPOREG > 0;
                         nTIPOREG = (nIMPORTEA + nINCREBASEMIN - nRETENIDO);
                         nTIPOREG = nTIPOREG / ((nRETRIB - nPERCIBIDO) * 100);
                         nTIPOREG = nTIPOREG - .005;   || trunca a dos decimales
                         nTIPOREG = nTIPOREG ! 2;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI aREVISAR = "S";
          |SI #102#14 = "S";
               |SI nCONTRATO = "3"; |Y nTIPOREG < 8;
                    nTIPOREG = 8;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPOREG < 1;
                         nTIPOREG = 1;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI nCONTRATO = "3"; |Y nTIPOREG < 15;
                    nTIPOREG = 15;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPOREG < 2;
                         nTIPOREG = 2;
                    |FINSI;
               |FINSI;
          |FINSI;
          nIMPORTE = (((nRETRIB - nPERCIBIDO) * nTIPOREG) / 100) + nRETENIDO;
     |FINSI;
     nTIPO = nTIPOREG;
|FPRC;

|PROCESO RegularizaEne2008;
                         || tratamiento especial Ceuta y Melilla
     |SI #102#14 = "S"; |Y #102#115 = "S"; |Y #102#116 ! 13;
          nRETENIDO = #102#17 * 2;
     |SINO;
          |SI #102#14 = "S"; |Y #102#115 = "N"; |Y #102#116 = 13;
               || nRETENIDO = #104#17 * 2;
               nIMPORTE = nPERCIBIDO * (nTIPOA/100);
               nNume1 = (nRETRIBa - nPERCIBIDO) * ((nTIPOA / 2) / 100);
               nIMPORTE = nIMPORTE + nNume1;
          |SINO;
               |SI #102#14 = "N"; |Y #102#115 = "S"; |Y #102#116 = 14;
                    || nRETENIDO = #104#17 * 2;
                    nIMPORTE = nPERCIBIDO * ((nTIPOA / 2) / 100);
                    nNume1 = ((nRETRIBa - nPERCIBIDO) * (nTIPOA / 100));
                    nIMPORTE = nIMPORTE + nNume1;
               |FINSI;
          |FINSI;
     |FINSI;
                         || calculo del tipo de retencion
     nTIPO = ((nIMPORTE - nRETENIDO) / (nRETRIB - nPERCIBIDO)) * 100;

     |SI nTIPO < 0; nTIPO = 0;     |FINSI;
     nTIPO = nTIPO - .005;              || trunca a dos decimales
     nTIPO = nTIPO ! 2;

     |SI nTIPO < 0; nTIPO = 0;     |FINSI;

                         || limites generales (max. 45% y min 15%, 2%)
     |SI nTIPO > 43;
          nTIPO = 43;
     |SINO;
          |SI #102#14 = "S"; |Y #102#115 = "N"; |Y #102#116 = 13;
               |SI nCONTRATO = "3"; |Y nTIPO < 8;
                    nTIPO = 8;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPO < 1;
                         nTIPO = 1;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI nCONTRATO = "3"; |Y nTIPO < 15;
                    nTIPO = 15;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPO < 2;
                         nTIPO = 2;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;

                         || tratamiento especial Ceuta y Melilla
     |SI #102#14 = "S"; |Y #102#115 = "S"; |Y #102#116 ! 13;
          nTIPO = nTIPO / 2;
          nRETENIDO = nRETENIDO / 2;
     |SINO;
          |SI #102#14 = "S"; |Y #102#115 = "S"; |Y #102#116 = 13;
               nTIPO = nTIPO / 2;
          |FINSI;
          |SI #102#14 = "S"; |Y #102#115 = "N"; |Y #102#116 ! 13; |Y #102#116 ! 0;
               nTIPO = nTIPO / 2;
          |FINSI;   || lo ultimo se lo a¤ado por problemas con el 2004 en
                    || Ceuta/Melilla cuando regulariza automaticamente
     |FINSI;

                         || redondeo del tipo;
     nTIPO = nTIPO ! 0;
                         || calculo del importe anual de la retencion
     nIMPORTE = (((nRETRIB - nPERCIBIDO) * nTIPO) / 100) + nRETENIDO;
     nIMPORTE = nIMPORTE ! EURODB;

     |SI #102#116 = 11; |O #102#116 = 12; |O #102#116 = 14; |O #102#116 = 15; |O #102#116 = 0;
          |ACABA;
     |FINSI;

                         || limite de art. 81.5

          aBASEA = nBASEA;
          nBASEA = aBASEA;
          aBASE  = nBASE;
          nBASE  = aBASE;

     aREVISAR = "N";
     nDIFERENCIA = nBASEA;
     nNume1 = nBASEA;
     nNume2 = nMINPERFAA;
     nNume3 = nNume1 - nNume1;

     |SI nDIFERENCIA < 0;
          nDIFERENCIA = 0;
     |FINSI;

     nNume1 = nBASE - nMINPERFA;

     |SI nDIFERENCIA ] nNume1; |Y nTIPO > nTIPOA;
          nTIPO = nTIPOA;
          aREVISAR = "S";
     |SINO;
          |SI nDIFERENCIA < nNume1; |Y nIMPORTEA < nIMPORTE;
               nINCREIMPORTE = nIMPORTE - nIMPORTEA;
               nINCREBASEMIN = nNume1 - nDIFERENCIA;
               |SI nINCREIMPORTE > nINCREBASEMIN;
                    aREVISAR = "S";
                    nIMPORTE = nIMPORTEA + nINCREBASEMIN;
                    nTIPO = ((nIMPORTE - nRETENIDO) / (nRETRIB - nPERCIBIDO));
                    nTIPO = nTIPO * 100;
                    |SI nTIPO < 0;
                         nTIPO = 0;
                    |SINO;
                         nTIPO = nTIPO - .005;   || trunca a dos decimales
                         nTIPO = nTIPO ! 2;
                         nTIPO = nTIPO ! 0;
                         |SI nTIPO < 0; nTIPO = 0;     |FINSI;
                         nIMPORTE = ((nRETRIB - nPERCIBIDO) * nTIPO) / 100;
                         nIMPORTE = nIMPORTE + nRETENIDO;
                         nINCREIMPORTE = nIMPORTE - nIMPORTEA;
                         |SI nINCREIMPORTE > nINCREBASEMIN; |Y nTIPO > 0;
                              nTIPO = nTIPO - 1;
                         |FINSI;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     |SI aREVISAR = "S";
          |SI #102#14 = "S";
               |SI nCONTRATO = "3"; |Y nTIPO < 8;
                    nTIPO = 8;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPO < 1;
                         nTIPO = 1;
                    |FINSI;
               |FINSI;
          |SINO;
               |SI nCONTRATO = "3"; |Y nTIPO < 15;
                    nTIPO = 15;
               |SINO;
                    |SI nCONTRATO = "2"; |Y nTIPO < 2;
                         nTIPO = 2;
                    |FINSI;
               |FINSI;
          |FINSI;
          nIMPORTE = (((nRETRIB - nPERCIBIDO) * nTIPO) / 100) + nRETENIDO;
     |FINSI;
|FPRC;

|PROCESO constante;
     aAlfa1 = "01";
     aAlfa2 = nElMesIRPF; aAlfa2 = "00" + aAlfa2; aAlfa2 = aAlfa2 % -102;
     aAlfa3 = nElAnyIRPF;
     aAlfa4 = aAlfa1 + "." + aAlfa2 + "." + aAlfa3;

     fCFecha = aAlfa4;         || primer dia de mes de calculo
     aCError = "";            || inicializo errores
     |HAZ LeeCons;
|FPRC;

|PROCESO EstimaSS;
     nCConst = #labtraba#248;
     |HAZ constante;

     nGASTOSa = nRETRIBa % (#nomconst#7 + #nomconst#13 + #nomconst#15 + #nomconst#17);
|FPRC;

|PROCESO Anteriores;
     |SI nEmpr99 ! #200#0; |Y #nomir009#20 ! 2;
          |ACABA;
     |FINSI;
     |PARA nMesBusca = nElMesIRPF - 1; |SI nMesBusca ] 1; |Y swLocalizado = 0;
     |HACIENDO nMesBusca = nMesBusca - 1;
          #nomir012#1 = #200#0;      || Empresa
          #nomir012#2 = #200#1;      || Trabajador
          #nomir012#3 = nElAnyIRPF;      || A¤o
          #nomir012#4 = nMesBusca;      || Mes
          |LEE 101#nomir012.=;
          FEstado = FSalida;
          |SI FEstado = 0;
          |Y nElMesIRPF = 2; |Y nElAnyIRPF = 2009;
               aPRESVIVa = #nomir012#105;
               nMINOPAGOb = #nomir012#100;   || me lo guardo aqui
               swLocalizado = 1;
          |FINSI;
          |SI FEstado = 0; |Y #nomir012#85 = #nomir012#86;
          || cuando el IRPF calculado es igual al estimado son los ultimos
          || datos correctos para la regularizacion, si no es asi es
          || porque no se le dijo que regularizara
               nRETRIBa = #nomir012#93;      || ingresos iniciales
               nIMPORTEA = #nomir012#94;     || cuota inicial
               || #nomir012#95;              || Ceuta/Melilla S/M
               nBASEA = #nomir012#96;        || base inicial
               nMINPERFAA = #nomir012#97;    || minimo pers. y fam.
               nTIPOA = #nomir012#98;        || tipo inicial
               |SI nElAnyIRPF [ 2010;
                    aMINORADO = #nomir012#99;     || minoracion vivienda S/N
               |SINO;
                    aMINORADO2 = #nomir012#99;     || minoracion vivienda S/N
                    aMINORADO1 = #nomir012#110;     || minoracion vivienda S/N
               |FINSI;
               nMINOPAGOa = #nomir012#100;   || importe ded. vivienda
               nGASTOSa = #nomir012#104;     || gastos seg. social
               |SI nGASTOSa = 0;
                    |HAZ EstimaSS;
               |FINSI;
               nCAUSAa = #nomir012#103;      || causa regularizacion anterior
               |SI nElAnyIRPF [ 2010;
                    aPRESVIVa = #nomir012#105;
               |SINO;
                    aPRESVIV1a = #nomir012#111;
                    aPRESVIV2a = #nomir012#105;
               |FINSI;
               |SI #nomir012#3 [ 2010;
                    |SI #nomir012#4 = 01; |Y #nomir012#100 > 0;
                         aPRESVIVa = "S";
                    |FINSI;
               |SINO;
                    |SI #nomir012#4 = 01; |Y #nomir012#100 > 0;
                         |SI #nomir012#110 = "S"; |O #nomir012#111 = "S";
                              aPRESVIV1a = "S";
                         |FINSI;
                         |SI #nomir012#99 = "S"; |O #nomir012#105 = "S";
                              aPRESVIV2a = "S";
                         |FINSI;
                    |FINSI;
                    || ojo, si el mes pasado tenia que si queria deduccion
                    || por vivienda pero no se me aplic¢ debido a que superaba
                    || el limite de ingresos, entonces se me quedaba grabado
                    || que s¡ que se aplic¢
                    || eso provoca que si este mes ya cumplo con las retribuciones
                    || necesarias para que se me aplique, no se me esta aplicando
                    || lo dejo como que si tunia que si se me aplicara y no tengo
                    || nada en el campo minoracion vivienda, en verdad no se me
                    || ha aplicado, es imposible si ah¡ no tengo nada
                    |SI #nomir012#100 = 0;
                         |SI aPRESVIV1a = "S";
                              aPRESVIV1a = "N";
                         |FINSI;
                         |SI aPRESVIV2a = "S";
                              aPRESVIV2a = "N";
                         |FINSI;
                    |FINSI;
               |FINSI;
               swLocalizado = 2;
          |FINSI;
          |SI swLocalizado ! 0;
               |SI #nomir012#93 = 0; |Y #nomir012#94 = 0; |Y #nomir012#96 = 0;
               |Y #nomir012#97 = 0; |Y #nomir012#98 = 0;
                    || si son todos cero, esta ficha NO la considero localizada
                    swLocalizado = 0;
               |FINSI;
               |ERROR10;
          |FINSI;
     |SIGUE;
|FPRC;

/*
|DEFBUCLE Anteriores;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, Anteriores;
|FIN;
*/

|DEFBUCLE Anteriores;
     #200#3;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Anteriores;
|FIN;

|PROCESO CargaTrab;
     #200#0 = #labtraba#0;
     #200#1 = #labtraba#1;
     #200#4 = #labtraba#36;
     |GRABA 020#200n;
     |LIBERA #200;
|FPRC;

|DEFBUCLE CargaTrab;
     #labtraba#2;
     ;
     aNif;
     aNif;
     ;
     NULL, CargaTrab;
|FIN;

|PROCESO TmpTrab;
     aAlfa1 = Usuario;
     |QBF aAlfa1;
     aAlfa1 = "a" + aAlfa1;
     |NOME_DAT #200 aAlfa1;
     |DELINDEX #200;
     |ABRE #200;
     |BUCLE CargaTrab;
     |CIERRA #200;
|FPRC;

|PROCESO Regulariza;
     |SI nDiferencias = 1;
          |ACABA;
     |FINSI;

     nPERCIBIDO = #102#16;         || ingresos ya satifechos
     nRETENIDO  = #102#17;         || retenciones ya practicadas

     || en principio TODO a cero

     nRETRIBa = 0;      || guarda ingresos iniciales
     nIMPORTEA = 0;     || guarda cuota inicial
     || #nomir012#95;      || Ceuta/Melilla S/M
     nBASEA = 0;        || guarda base inicial
     nMINPERFAA = 0; || minimo pers. y fam.
     nTIPOA = 0;  || guarda tipo inicial
     aMINORADO = "N";         || minoracion vivienda S/N
     aMINORADO1 = "N";         || minoracion vivienda S/N
     aMINORADO2 = "N";         || minoracion vivienda S/N
     nMINOPAGOa = 0;          || guarda importe ded. vivienda
     nMINOPAGOb = 0;          || guarda importe ded. vivienda
     nGASTOSa = 0;            || gastos seguridad social
     nCAUSAa = 0;             || causa regularizacion anterior
     /*
     aPRESVIVa = aPRESVIV;    || se practico el mes pasado ded. viv.
                              || por defecto lo que haya este mes
     */
     aPRESVIVa = "N";         || se practico el mes pasado ded. viv.
                              || por defecto a "N", asi si no ha regularizado
                              || el trabajador parte de que NO ha tenido viv.
                              || si no da problema en algun caso: 000098.02160
     aPRESVIV1a = "N";
     aPRESVIV2a = "N";
     swLocalizado = 0;
     |MODULO aAlfa;
     |QBF aAlfa;
     |SI aAlfa = "nomir001";            || vengo del menu de calculo de %
          aNif = #0#0;
          nEmpr99 = #0#3;

          |DDEFECTO #nomir009;
          |ABRE #nomir009;
          #nomir009#0 = #0#3;
          |LEE 000#nomir009.=;
          |CIERRA #nomir009;
     |SINO;                             || vengo de regularizacion
          nEmpr99 = #2#0;
          aNif = #2#7;
     |FINSI;

     |SALVA_FICHA #labtraba;
     |ABRE #nomir012;
     |HAZ TmpTrab;
     |BUCLE Anteriores;
     |CIERRA #nomir012;
     |REPON_FICHA #labtraba;

/*
     || ya no voy a coger nada del mantenimiento de IRPF
          nRETRIBa   = #102#18;         || ingresos iniciales
          nBASEA     = #102#117;        || base inicial
          nTIPOA     = #102#118;        || tipo inicial
          nIMPORTEA  = #102#19;         || cuota inicial
          nMINPERFAA = #102#123;        || minimo personal y familiar antes de regul.
          nMINOPAGOa = 0;
          |SI #102#124 = "S";
               nMINOPAGOa = #102#125;   || minoracion en el pago por reduccion por
                                        || prestamo para inversion en vivienda
          |FINSI;                       || antes de regularizacion
*/

     |SI nElAnyIRPF [ 2008; |Y swSegSem = 0; || hasta Jun-2008
          |HAZ RegularizaEne2008;
     |FINSI;

     |SI nElAnyIRPF = 2008; |Y swSegSem = 1; || Segundo semestre 2008
          |HAZ RegularizaJul2008;
     |FINSI;

     |SI nElAnyIRPF ] 2009; |Y nElAnyIRPF [ 2010;     || 2009 Y 2010
          |HAZ Regulariza2009;
          |SI nCAUSA2 ! 0;
               |HAZ Regulariza2009;
          |FINSI;
     |FINSI;

     |SI nElAnyIRPF ] 2011;               || 2011 en adelante
          |HAZ Regulariza2011;
          |SI nCAUSA2 ! 0;
               |HAZ Regulariza2011;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GuardaDatos;
     #104#13 = nMINPER;       || Minimo Personal
     #104#12 = nRED46;        || Reducc. Rendimientos del trabajo art.46
     #104#57 = nPROLONLAB;    || Reducc. Prolongacion de la Activ. Laboral
     #104#58 = nMOVILGEO;     || Reducc. Movilidad Geografica
     #104#59 = nDISTRA;       || Reducc. Discapacidad Trabajadores Activos
     #104#60 = nCUIDADO;       || Reducc. Cuidado de Hijos
     #104#61 = n65PER + n65AS;        || Reducc. Edad
     #104#62 = ASISPER + n75AS;   || Reducc. Asistencia
     #104#63 = nDISPER + nDISDES + nDISAS + nASISPER + nASISDES + nASISAS;
               || Reducc. Discapacidad Trabajadores no activos
     #104#64 = nPENSION + nDESEM;  || Reducc. Pensionista-Desempleado
     #104#65 = nHIJOS;        || Reducc. por tener mas de dos descend.
     #104#70 = nREDCOPA;      || Reducc. Copa America
     #104#71 = nRED20;      || Reducc. Caracter General
     #104#72 = nMINPERFA;      || Minimo Personal y Familiar
     #104#74 = nMINOPAGO;      || Deduccion inversion vivienda habitual
     #104#13 = nMINPER;       || Minimo Personal

     #104#35 = nBASE;
     #104#25 = nTIPO;
     #104#26 = nIMPORTE;
     #104#77 = nDEDUCCION;       || Deduccion Art. 80 Bis LIRPF
|FPRC;
|| ***************************************************************************
____________________________________/ PUNTO 05 (Actualizar)
/*
|| este punto desaparece tambien del menu, el de "Actualizar porcentaje"

|PROCESO Punto06;
     |SI nModoExt ! 1;|Y nModoExt ! 2;
          |MENAV "    Opcion activa unicamente en Alta o Modificacion ...";
          |ACABA;
     |FINSI;

     |SI #0#5 = "S";
          |MENAV "    Tipo de IRPF ya actualizado ...";
          |ACABA;
     |FINSI;

     |SI #0#3 = 0;|O #0#4 = 0;
          |MENAV "    Asignacion del codigo no realizada ...";
     |SINO;
          |ABRE #2;
          #2#0 = #0#3;
          #2#1 = #0#4;
          |LEE 101#2=;
          |SI FSalida = 0;
               |ABRE #104;
               #104#0 = #0#0;
               #104#1 = #0#2;
               #104#44= #0#3;
               |LEE 000#104=;
               |SI FSalida = 0;
                    aAlfa1 = "    NCambiar [" + #2#30 + "%] por [" + #104#25 + "%], (S/N): ";
                    |CONFI aAlfa1;
                    |SI FSalida = 0;
                         |DDEFECTO #nomir009;
                         |ABRE #nomir009;
                         #nomir009#0 = #2#0;
                         |LEE 000#nomir009.=;
                         |CIERRA #nomir009;

                         |SI #nomir009#16 = 0;|O #nomir009#16 = 1;  #2#30 = #104#25;    |FINSI;   || %irpf 1
                         |SI #nomir009#16 = 0;|O #nomir009#16 = 2;  #2#174= #104#25;    |FINSI;   || %irpf 2
                         |SI #nomir009#16 = 0;|O #nomir009#16 = 3;  #2#175= #104#25;    |FINSI;   || %irpf 3

                         |GRABA 020#2a;
                         |SI FSalida = 0;
                              #0#5 = "S";
                              |GRABA 020#0a;
                              |SI FSalida = 0;
                                   |PINTA #0#5;
                              |FINSI;
                         |FINSI;
                    |FINSI;
               |SINO;
                    |MENAV "    Calculo no realizado ...";
               |FINSI;
               |CIERRA #104;
          |SINO;
               |MENAV "    Codigo asignado inaccesible ...";
          |FINSI;
          |LIBERA #2;
          |CIERRA #2;
     |FINSI;
|FPRC;
*/

|PROCESO Punto01;
     enAnyo    = #0#2;
     eaNif     = #0#0;
     enEmpresa = #0#3;
     enModoNif = nModoExt;
     eaProcedencia = "nomir001";
     |SUB_EJECUTA_NP ":basica/agidanif";
|FPRC;
