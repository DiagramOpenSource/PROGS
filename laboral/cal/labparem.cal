|FICHEROS;
     labparem #0;
     labparma #1;        || mantenimiento partes
     xmlarbol #100;      || tmp para creacion xml
     xmlparca;
     xmlparli;

     labempre;
     labtraba;
     labparhi;
     labcontr;
     silcon01;

     labmunic;
     nomequiv;
     nomconca;
|FIN;

|VARIABLES;
     &eaVengoDe = "";
     nNume1 = 0;
     nNume2 = 0;
     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     nume1 = 0;
     nume2 = 0;
     para1 = 0;
     para2 = 0;
     elsw4 = 0;
     aApell1 = "";
     aApell2 = "";
     aNombre = "";
     aCampo = "";
     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aNivel = "";
     i = 0;
     j = 0;
     k = 0;
     nNivel = 0;
     nNivel1 = 0;
     nNivel2 = 0;
     aNivel2 = "";
     nCorta = 0;
     nCorta1 = 0;
     nCorta2 = 0;
     aParte1 = "";
     aParte2 = "";
     swACero = 0;
     nElemento = 0;
     nContador = 0;
     swHayHijos = 0;
     aEntidad = "";
     nCanal = 0;

     aValor = "";
     aLinea = "";
     aEtiqueta = "";
     aEtiqueta1 = "";
     aEtiqueta2 = "";
     aArchivo = "";
     aLimInf = "";
     aLimSup = "";

     aEsp = "";
     aExt = "";
     aIPF = "";
     fFecAcc = @;
     fFecAnt = @;
     fFecDif = @;
     nFecAcc = 0;
     nFecAnt = 0;
     nFecDif = 0;
     aFecDif = "";
     nume3 = 0;
     nMeses = 0;
     nDias = 0;
     aRegimen = "";
     fech1 = @;
     fech2 = @;
     aDiaSemana = "";
     nNume = 0;
     aNivelSup = "";
     nBReg = 0;
     nProm = 0;
     fFecha = @;

     aValorSal = "";
     aLongitud = "";
     nLongitud = 0;
     aCaracter = "";
     aCaracterSal = "";
     nPos = 0;
     nBusca = 0;
     nPaso = 0;
     aPath = "";
     aHora = "";
     swHayDatos = 0;
     nPara1 = 0;

     nContMuni = 0;
     &aCodMuni = "";
     &aCodPos = "";
     &aMuni = "";
     &nMensajeF5 = 0;
     &aCodigoMunicipio = "";
     aMuniError = "";
     aContrato = "";
     nValor = 0;
     &eaNom   = "";
     &eaApel1 = "";
     &eaApel2 = "";
     &aCadena    = "";
|FIN;

/*******************     PROCESOS DESDE EL MANTENIMIENTO   ******************/

|PROCESO Restaura;
     |POPV;
|FPRC;

|PROCESO Ayuda1; |TIPO 7;
     |PUSHV 17162265;
     |COLOR 7,1;
     |ATRI I;
     |PINTA 1817, " Introduzca 'S' para  incluir en la remesa todos ";
     |PINTA 1917, " los partes de trabajo que estuvieran pendientes ";
     |PINTA 2017, " de creacion de remesa o 'N' para  elegir cuales ";
     |PINTA 2117, "                 desea incluir.                  ";
     |ATRI 0;
|FPRC;

|PROCESO NombreFichero;
     fFecha = ~;
     |HORA aHora;
     |QBT aHora;
     aAlfa = fFecha;
     |QBF aAlfa;
     aAlfa = (aAlfa % -104) + (aAlfa % 402) + (aAlfa % 102);
     aHora = aHora - ":";
     aHora = aHora - ":";
     aAlfa = aAlfa + "_" + aHora;
     |QBT aAlfa;
     aAlfa = aAlfa + ".xml";
     #0#1 = aAlfa;
     |PINTA #0#1;
|FPRC;

|PROCESO path;
     |ABRE #labcontr;
     |LEE 000#labcontr.p;
     aPath = #labcontr#51;
     |QBF aPath;
     |SI aPath = "";
          |ABRE #silcon01;
          |LEE 000#silcon01.p;
          |SI FSalida = 0;
               aPath = #silcon01#2;
               |QBF aPath;
               #labcontr#51 = aPath;
               |GRABA 020#labcontr.a;
               |LIBERA #labcontr;
          |FINSI;
          |CIERRA #silcon01;
     |FINSI;
     |CIERRA #labcontr;
     aAlfa = aPath % -101;
     |SI aAlfa ! "/"; |Y aAlfa ! "\";
          aPath = aPath + "/";
     |FINSI;
|FPRC;

/*******************     PROCESOS AYUDA CREACION REMESA     *****************/

|PROCESO separa_nom;
     || alfa1 = #14#2;
     |QBF alfa1;
     alfa2 = alfa1 % 0;
     para2 = alfa2;
     elsw4 = 0;
     aApell1 = "";
     aApell2 = "";
     aNombre = "";
     |PARA para1 = 1; |SI para1 [ para2; |HACIENDO para1 = para1 + 1;
          nume2 = (para1 * 100) + 1;
          alfa3 = alfa1 % nume2;
          |SI alfa3 = " ";|O alfa3 = ",";
               |SI aApell1 ! "";
                    elsw4 = elsw4 + 1;
               |FINSI;
               |SI elsw4 ] 2;|Y aNombre ! "";
                    aNombre = aNombre + alfa3;
               |FINSI;
          |SINO;
               |SI elsw4 = 0;  aApell1 = aApell1 + alfa3; |FINSI;
               |SI elsw4 = 1;  aApell2 = aApell2 + alfa3; |FINSI;
               |SI elsw4 ] 2;  aNombre = aNombre + alfa3; |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO ipf;
     alfa1 = aValor;
     alfa1 = alfa1 % 101;
     |SI alfa1 ! "X"; |Y alfa1 ! "Y"; |Y alfa1 ! "Z";
          aEsp = "X";
     |SINO;
          aExt = "X";
     |FINSI;
     |SI alfa1 ] "0";|Y alfa1 [ "9";
          aIPF = "1";            || tipo identificacion DNI
     |SINO;
          |SI alfa1 ! "X"; |Y alfa1 ! "Y"; |Y alfa1 ! "Z";
               aIPF = "6";        || tipo identificacion EXTRANJERO
          |SINO;
               |SI alfa1 ] "a";|Y alfa1 [ "z";
                    aIPF = "2";    || tipo identificacion PASAPORTE
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Antiguedad;
||        ANTIGUEDAD EN PUESTO DE TRABAJO (MESES Y DIAS)
     fFecAcc = #labparhi#15;
     fFecAnt = #labparhi#93;
     nFecAcc = fFecAcc;
     nFecAnt = fFecAnt;
     nFecDif = nFecAcc - nFecAnt;
     fFecDif = nFecDif;
     aFecDif = fFecDif;

     alfa1 = aFecDif % 102;
     alfa2 = aFecDif % 402;
     alfa3 = aFecDif % 704;

     nume1 = alfa1;
     nume2 = alfa2;
     nume3 = alfa3;

     nume3 = nume3 * 12;
     nMeses = nume2 + nume3 - 1;
     nDias = nume1;

     |SI nDias ] 30;
          nMeses = nMeses + 1;
          nDias = nDias - 30;
     |FINSI;
     |SI nMeses ! 0;
          nDias = 0;
     |FINSI;
|FPRC;

|PROCESO regimen;
     aRegimen = "";
     |SI #labtraba#247 = 111; aRegimen = "1"; |FINSI;
     |SI #labtraba#247 = 611; aRegimen = "6"; |FINSI;
     |SI #labtraba#247 = 613; |O #labtraba#247 = 163;
          aRegimen = "7";
     |FINSI;
     |SI #labtraba#247 = 800; aRegimen = "8"; |FINSI;
     |SI #labtraba#247 = 911; aRegimen = "9"; |FINSI;
     |SI aRegimen = ""; aRegimen = "1"; |FINSI;
|FPRC;

|PROCESO DiaSemana;
     ||        DIA DE LA SEMANA
     fech2 = fech1 % 1;
     alfa2 = fech2;
     alfa2 = alfa2 % 1102;
     |SI alfa2 = "Lu";   aDiaSemana = "1";   |FINSI;
     |SI alfa2 = "Ma";   aDiaSemana = "2";   |FINSI;
     |SI alfa2 = "Mi";   aDiaSemana = "3";   |FINSI;
     |SI alfa2 = "Ju";   aDiaSemana = "4";   |FINSI;
     |SI alfa2 = "Vi";   aDiaSemana = "5";   |FINSI;
     |SI alfa2 = "Sa";   aDiaSemana = "6";   |FINSI;
     |SI alfa2 = "Do";   aDiaSemana = "7";   |FINSI;
|FPRC;

|PROCESO decimales;
     aValorSal = "";
     aLongitud = aValor % 0;
     nLongitud = aLongitud;
     |PARA nPos = 1; |SI nPos [ nLongitud; |HACIENDO nPos = nPos + 1;
          nBusca = (nPos * 100) + 1;
          aCaracter = aValor % nBusca;
          |SI aCaracter = ".";
               aCaracterSal = ",";
          |SINO;
               aCaracterSal = aCaracter;
          |FINSI;
          aValorSal = aValorSal + aCaracterSal;
     |SIGUE;
     aValor = aValorSal;
|FPRC;

____________________________________/ TRANSFORMACION CONTRATOS
|PROCESO CodigosNuevos;
     |QBF aContrato;
     aContrato = ("000" + aContrato) % -103;
     |ABRE #nomequiv;
     #nomequiv#0 = aContrato;
     |LEE 000#nomequiv.=;
     |SI FSalida = 0;
          |SI #labtraba#42 = "X";|O #labtraba#42 = "T";|O #labtraba#42 = "P";
               aContrato = #nomequiv#2;      || tiempo parcial
          |SINO;
               aContrato = #nomequiv#1;      || tiempo completo
          |FINSI;
     |FINSI;
     |CIERRA #nomequiv;
|FPRC;

/*********** PARA BUSCAR EL MUNICIPIO (COPIADO DEL zpdfdocs) ****************/

|PROCESO CuentaMunicipio;
     nContMuni = nContMuni + 1;
     aCodMuni = #labmunic#1;
|FPRC;

|DEFBUCLE CuentaMunicipio;
     #labmunic#1;
     ;
     aCodPos, "00000";
     aCodPos, "99999";
     ;
     NULL,CuentaMunicipio;
|FIN;

|PROCESO BuscaMunicipio;
     aAlfa2 = #labmunic#3;            || aAlfa2 = municipio de labmunic
     |QBT aAlfa2;
     aMuni = aMuni > "";
     |QBT aMuni;

     aAlfa = aMuni - aAlfa2;
     |SI aAlfa ! aMuni;
          ||aAlfa2 esta en aMuni
          aCodMuni = #labmunic#1;
          nContMuni = nContMuni + 1;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaMunicipio;
     #labmunic#1;
     ;
     aCodPos, "00000";
     aCodPos, "99999";
     ;
     NULL,BuscaMunicipio;
|FIN;

|PROCESO min_labmunic;
     #labmunic#4 = aCodPos;
     #labmunic#1 = "00000";
|FPRC;

|PROCESO max_labmunic;
     #labmunic#4 = aCodPos;
     #labmunic#1 = "99999";
|FPRC;

|PROCESO CodigoMuni;
     nContMuni = 0;
     |BUCLE CuentaMunicipio;

     |SI nContMuni > 1;
          nContMuni = 0;
          |BUCLE BuscaMunicipio;
          |SI nContMuni > 1;
               nMensajeF5 = 1;
               aCodigoMunicipio = "";
               |SUB_EJECUTA "labmunic";
               |SI aCodigoMunicipio ! "";
                    aCodMuni = aCodigoMunicipio;
                    nContMuni = 1;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI nContMuni = 0;
          nMensajeF5 = 1;
          aCodigoMunicipio = "";
          /*
          aMuniError = "    " + "El Codigo Postal" + aMuniError;
          aMuniError = aMuniError + "no existe. Introduzca un Codigo Postal correcto";
          |MENAV aMuniError;
          */
          |SUB_EJECUTA "labmunic";
          |SI aCodigoMunicipio ! "";
               aCodMuni = aCodigoMunicipio;
               nContMuni = 1;
          |FINSI;
     |FINSI;
     ||ahora se supone que en aCodMuni tenemos el codigo del municipio
|FPRC;

/************************** FIN BUSQUEDA DEL MUNICIPIO **********************/
/*******************  FINAL PROCESOS AYUDA CREACION REMESA  *****************/

|PROCESO ImprimeLinea;
     aEtiqueta = #xmlarbol#2;
     |QBF aEtiqueta;
     aEtiqueta1 = "";
     aEtiqueta2 = "";
     aValor = "";
     |SI #100#1 = 1;     || el nivel uno se imprime en la cabecera
          |ACABA;        || para que solo se imprima una vez
     |FINSI;

     aAlfa = "";
     |SI #100#1 = 2;
          aAlfa = "  ";
     |FINSI;
     |SI #100#1 = 3;
          aAlfa = "  " + "  ";
     |FINSI;
     |SI #100#1 = 4;
          aAlfa = "  " + "  " + "  ";
     |FINSI;
     |SI #100#1 = 5;
          aAlfa = "  " + "  " + "  " + "  ";
     |FINSI;
     |SI #100#1 = 6;
          aAlfa = "  " + "  " + "  " + "  " + "  ";
     |FINSI;

     |SI #100#5 = 0;                              || abro entidad compleja
          aEtiqueta1 = "<" + aEtiqueta + ">";
     |FINSI;
     |SI #100#5 = 1;                              || entidad simple (
          aEtiqueta1 = "<" + aEtiqueta + ">";
          aEtiqueta2 = "</" + aEtiqueta + ">";
     |FINSI;
     |SI #100#5 = 2;                              || cierro entidad compleja
          aEtiqueta2 = "</" + aEtiqueta + ">";
     |FINSI;
     aValor = #xmlarbol#4;
     |QBF aValor;
     aLinea = aAlfa + aEtiqueta1 + aValor + aEtiqueta2 + &13 + &10;
     |XGRABA nCanal, aLinea;
|FPRC;

|DEFBUCLE LineasXML;
     #xmlarbol#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, ImprimeLinea;
|FIN;

|PROCESO Cabecera;
     aLinea = "<?xml version=" + &34 + "1.0" + &34 + " encoding=";
     aLinea = aLinea + &34 + "ISO-8859-1" + &34 + "?>" + &13 + &10;
     |XGRABA nCanal, aLinea;
     aLinea = "<!DOCTYPE MultiPAT PUBLIC " + &34 + "-//Delta//PAT//ES" + &34;
     aLinea = aLinea + " " + &34 + "http://www.delta.mtas.es/Delta2Web/dtd/PAT.dtd";
     aLinea = aLinea + &34 + ">" + &13 + &10;
     |XGRABA nCanal, aLinea;
     aLinea = "<MultiPAT>" + &13 + &10;
     |XGRABA nCanal, aLinea;
|FPRC;

|PROCESO Pie;
     aLinea = "</MultiPAT>" + &13 + &10;
     |XGRABA nCanal, aLinea;
     |XCIERRA nCanal;
|FPRC;

|PROCESO CreaFichero;
     |SI nPaso = 1;
          aArchivo = #0#1;
          |QBT aArchivo;
          aAlfa = aArchivo % -104;
          |SI aAlfa ! ".xml";
               aArchivo = aArchivo + ".xml";
          |FINSI;
          aArchivo = aPath + aArchivo;
          |XABRE "CBW", aArchivo, nCanal;
          |HAZ Cabecera;
     |FINSI;

     |SI nPaso = 2;
          |BUCLE LineasXML;
     |FINSI;

     |SI nPaso = 3;
          |HAZ Pie;
     |FINSI;
|FPRC;

|PROCESO CreaDirectorio;
     aAlfa1 = aPath % 0;  nNume1 = aAlfa1;
     aAlfa2 = "";
     |PARA nPara1 = 1; |SI nPara1 [ nNume1; |HACIENDO nPara1 = nPara1 + 1;
          nNume2 = (nPara1 * 100) + 1;
          aAlfa1 = aPath % nNume2;
          |SI aAlfa1 = "/"; |O aAlfa1 = "\";
               |SI aAlfa2 ! "";
                    |MKDIR aAlfa2;
               |FINSI;
          |FINSI;
          aAlfa2 = aAlfa2 + aAlfa1;
     |SIGUE;
     |SI alfa2 ! "";
          |MKDIR aAlfa2;
     |FINSI;
|FPRC;

|PROCESO LineasArbol;
     aCampo = #xmlarbol#2;
     |QBF aCampo;
     aValor = "";

     aNivel = #xmlarbol#3;
     |QBF aNivel;
     aAlfa = aNivel % 0;
     nNume = aAlfa;
     nNume = nNume - 2;
     nNume = 100 + nNume;
     aNivelSup = aNivel % nNume;

     /************************     DATOS TRABAJADOR      *******************/

     |SI aCampo = "numreferencia";
          aValor = "000000000000";
     |FINSI;
     |SI aCampo = "apellido1";
          aValor = aApell1;
     |FINSI;
     |SI aCampo = "apellido2";
          aValor = aApell2;
     |FINSI;
     |SI aCampo = "nombre";
          aValor = aNombre;
     |FINSI;
     |SI aCampo = "tipo";
          aAlfa = #labparhi#40;
          |QBF aAlfa;
          |SI aAlfa = "A";
               aValor = "1";
          |FINSI;
          |SI aAlfa = "R";
               aValor = "2";
          |FINSI;
     |FINSI;
     |SI aCampo = "naf";
          aValor = #labtraba#75;
     |FINSI;
     |SI aCampo = "fechaingreso";
          aValor = #labtraba#34;
          aValor = aValor - ".";
          aValor = aValor - ".";
     |FINSI;
     |SI aCampo = "sexo";
          aValor = #labparhi#14;
          |SI aValor = "V";
               aValor = "H";
          |FINSI;
     |FINSI;
     |SI aCampo = "fechanacimiento";
          aValor = #labtraba#11;
          aValor = aValor - ".";
          aValor = aValor - ".";
     |FINSI;
     |SI aCampo = "nacion";
          aValor = #labparhi#94;
     |FINSI;
     |SI aCampo = "ipf";
          aValor = #labtraba#7;
          |HAZ ipf;
          aValor = aIPF + aValor;
     |FINSI;
     |SI aCampo = "situacion";
          aValor = #labparhi#42;
     |FINSI;
     |SI aCampo = "texto";
          aValor = #labparhi#97;
     |FINSI;
     |SI aCampo = "codigo";
          aValor = #labparhi#96;
          aValor = aValor % 103;
     |FINSI;
     |SI aNivelSup = "01010312";
          |SI aCampo = "meses";
               |HAZ Antiguedad;
               aValor = nMeses;
               aValor = "000" + aValor;
               aValor = aValor % -103;
          |FINSI;
          |SI aCampo = "dias";
               aValor = nDias;
               aValor = "00" + aValor;
               aValor = aValor % -102;
          |FINSI;
     |FINSI;
     |SI aCampo = "contrato";
          aValor = #labtraba#45;
          aValor = "000" + aValor;
          aValor = aValor % -103;
          aContrato = aValor;
          |HAZ CodigosNuevos;
          aValor = aContrato;
     |FINSI;
     |SI aCampo = "regimenss";
          |HAZ regimen;
          aValor = aRegimen;
          aValor = "00" + aValor; aValor = aValor % -102;
     |FINSI;
     |SI aCampo = "textoconv";
          aValor = #labtraba#25;
     |FINSI;
     /*
     |SI aCampo = "atep";
          aValor = #labtraba#32;
          aValor = "000" + aValor;
          aValor = aValor % -103;
     |FINSI;
     */
     |SI aCampo = "atepcnae";
          aAlfa1 = #labempre#128; |QBF aAlfa1;
          aAlfa1 = aAlfa1 % 102;        || CNAE

          aAlfa2 = #labempre#12; |QBF aAlfa2;
          aAlfa2 = aAlfa2 - ".";
          nNume = FSalida - 100;
          aAlfa2 = nNume;
          aAlfa2 = ("00" + aAlfa2) % -104;
          aAlfa2 = "1" + (aAlfa2 % 102);
          nNume = aAlfa2;
          aAlfa2 = #labempre#12 % nNume; |QBF aAlfa2;
          aAlfa2 = aAlfa2 % 102;

          |SI aAlfa1 = aAlfa2;
               aValor = #labempre#12 % nNume;
          |SINO;
               aValor = #labempre#128 % 102;
          |FINSI;
          || aValor = ("00000" + aValor) % -105;
     |FINSI;
     |SI aCampo = "atepocupacion";
          aValor = #labtraba#204;
     |FINSI;
     |SI aNivelSup = "010103";
          |SI aCampo = "domicilio";
               aAlfa = #labtraba#3;
               |QBF aAlfa;
               aAlfa = aAlfa + ", " + #labtraba#4;
               |QBF aAlfa;
               aAlfa = aAlfa + " - " + #labtraba#5;
               |QBF aAlfa;
               aValor = aAlfa;
          |FINSI;
          |SI aCampo = "telefono";
               aValor = #labtraba#244;
          |FINSI;
          |SI aCampo = "provincia";
               aValor = #labtraba#8;
               aValor = "00" + aValor; aValor = aValor % -102;
          |FINSI;
          |SI aCampo = "municipio";
               aAlfa1 = #labtraba#8; aAlfa1 = "00" + aAlfa1;  aAlfa1 = aAlfa1 % -102;
               aAlfa2 = #labtraba#9; aAlfa2 = "000" + aAlfa2; aAlfa2 = aAlfa2 % -103;
               aValor = aAlfa1 + aAlfa2;
               aCodPos = aValor;
               aMuni = #labtraba#6;
               aMuniError = " del trabajador ";
               |HAZ CodigoMuni;
               aValor = aCodMuni;
          |FINSI;
          |SI aCampo = "codpostal";
               aAlfa1 = #labtraba#8; aAlfa1 = "00" + aAlfa1;  aAlfa1 = aAlfa1 % -102;
               aAlfa2 = #labtraba#9; aAlfa2 = "000" + aAlfa2; aAlfa2 = aAlfa2 % -103;
               aValor = aAlfa1 + aAlfa2;
          |FINSI;
     |FINSI;

     /************************        DATOS EMPRESA      *******************/

     |SI aNivelSup = "01010404";             || cnae empresa
          |SI aCampo = "texto";
               aValor = #labparhi#44;
          |FINSI;
          |SI aCampo = "codigo";
               aValor = #labparhi#43;
          |FINSI;
     |FINSI;
     |SI aNivelSup = "010104"; |O aNivelSup = "01010503";       || empresa
          |SI aCampo = "cifnif";
               aValor = #labempre#10;
          |FINSI;
          |SI aCampo = "razon";
               aValor = #labempre#2;
          |FINSI;
          |SI aCampo = "ccc";
               aValor = #labempre#13;
          |FINSI;
          |SI aCampo = "plantilla";
               aValor = #labempre#14;
          |FINSI;
          |SI aCampo = "domicilio";
               aAlfa = #labempre#3;
               |QBF aAlfa;
               aAlfa = aAlfa + ", " + #labempre#4;
               |QBF aAlfa;
               aAlfa = aAlfa + " - " + #labempre#5;
               |QBF aAlfa;
               aValor = aAlfa;
          |FINSI;
          |SI aCampo = "telefono";
               aValor = #labempre#111;
          |FINSI;
          |SI aCampo = "provincia";
               aValor = #labempre#7;
               aValor = "00" + aValor; aValor = aValor % -102;
          |FINSI;
          |SI aCampo = "municipio";
               aAlfa1 = #labempre#7; aAlfa1 = "00" + aAlfa1;  aAlfa1 = aAlfa1 % -102;
               aAlfa2 = #labempre#8; aAlfa2 = "000" + aAlfa2; aAlfa2 = aAlfa2 % -103;
               aValor = aAlfa1 + aAlfa2;
               aCodPos = aValor;
               aMuni = #labempre#6;
               aMuniError = " de la empresa";
               |HAZ CodigoMuni;
               aValor = aCodMuni;
          |FINSI;
          |SI aCampo = "codpostal";
               aAlfa1 = #labempre#7; aAlfa1 = "00" + aAlfa1;  aAlfa1 = aAlfa1 % -102;
               aAlfa2 = #labempre#8; aAlfa2 = "000" + aAlfa2; aAlfa2 = aAlfa2 % -103;
               aValor = aAlfa1 + aAlfa2;
          |FINSI;
     |FINSI;
     |SI aCampo = "contrata";
          |SI #labparhi#45 = "1";
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aCampo = "ett";
          |SI #labparhi#45 = "2";
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aCampo = "asunpersona";
          |SI #labparhi#46 = "1";
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aCampo = "servprevpro";
          |SI #labparhi#46 = "2";
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aCampo = "servprevaje";
          |SI #labparhi#46 = "3";
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aCampo = "trabdesigna";
          |SI #labparhi#46 = "4";
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aCampo = "servprevman";
          |SI #labparhi#46 = "5";
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aCampo = "ninguna";
          |SI #labparhi#46 = "6";
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;

     /************************      DATOS CCC LUGAR      *******************/

     |SI aNivelSup = "01010501";
          |SI aCampo = "codigo";
               aValor = #labparhi#4;
          |FINSI;
     |FINSI;
     |SI aCampo = "trafico";
          |SI #labparhi#47 = "S";
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aNivelSup = "01010501"; |Y #labparhi#111 = "S";
          |SI aCampo = "pais";
               aValor = #labparhi#48;
          |FINSI;
          |SI aCampo = "provincia";
               aValor = #labparhi#50;
               aValor = "00" + aValor; aValor = aValor % -102;
          |FINSI;
          |SI aCampo = "municipio";
               aAlfa1 = #labparhi#110; aAlfa1 = "00000" + aAlfa1;  aAlfa1 = aAlfa1 % -105;
               aValor = aAlfa1;
               /*
               aCodPos = aValor;
               aMuniError = " del lugar del accidente ";
               |HAZ CodigoMuni;
               aValor = aCodMuni;
               */
          |FINSI;
          |SI aCampo = "direccion";
               aValor = #labparhi#54;             |QBF aValor;
               aValor = aValor + #labparhi#55;    |QBF aValor;
          |FINSI;
          |SI aCampo = "viakm";
               aValor = #labparhi#56;
          |FINSI;
          |SI aCampo = "otro";
               aValor = #labparhi#57;
          |FINSI;
     |FINSI;

     |SI aCampo = "empresaep2";
          |SI #labparhi#58 = 1;
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aCampo = "centroep2";
          |SI #labparhi#100 = "S"; |Y #labparhi#58 = 1;
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aCampo = "tipoempresa";
          |SI #labparhi#58 = 2;
               |SI #labparhi#59 = "C";
                    aValor = "1";
               |FINSI;
               |SI #labparhi#59 = "E";
                    aValor = "2";
               |FINSI;
               |SI #labparhi#59 = "O";
                    aValor = "3";
               |FINSI;
          |FINSI;
     |FINSI;
     |SI aCampo = "ciftipo";
          |SI #labparhi#58 = 2;
               aValor = #labparhi#60;
          |FINSI;
     |FINSI;
     |SI aNivelSup = "01010503";           || cipal de la empresa: cambio
          |SI aCampo = "razon";
               aValor = #labparhi#61;
          |FINSI;
          |SI aCampo = "ccc";
               aValor = #labparhi#70;
          |FINSI;
          |SI aCampo = "plantilla";
               aValor = #labparhi#69;
          |FINSI;
          |SI aCampo = "domicilio";
               aValor = #labparhi#62;
          |FINSI;
          |SI aCampo = "telefono";
               aValor = #labparhi#68;
          |FINSI;
          |SI aCampo = "provincia";
               aValor = #labparhi#63;
               aValor = "00" + aValor; aValor = aValor % -102;
          |FINSI;
          |SI aCampo = "municipio";
               aAlfa1 = #labparhi#63; aAlfa1 = "00" + aAlfa1;  aAlfa1 = aAlfa1 % -102;
               aAlfa2 = #labparhi#65; aAlfa2 = "000" + aAlfa2; aAlfa2 = aAlfa2 % -103;
               aValor = aAlfa1 + aAlfa2;
          |FINSI;
          |SI aCampo = "codpostal";
               aAlfa1 = #labparhi#67; aAlfa1 = "00000" + aAlfa1;  aAlfa1 = aAlfa1 % -105;
               aValor = aAlfa1;
          |FINSI;
          |SI aNivelSup = "0101050309";             || cnae Centro
               |SI aCampo = "texto";
                    aValor = #labparhi#44;
               |FINSI;
               |SI aCampo = "codigo";
                    aValor = #labparhi#43;
               |FINSI;
          |FINSI;
     |FINSI;

     /************************      DATOS ACCIDENTE      *******************/

     |SI aCampo = "fechaaccidente";
          aValor = #labparhi#3;
          aValor = aValor - ".";
          aValor = aValor - ".";
     |FINSI;
     |SI aCampo = "fechabaja";
          aValor = #labparhi#15;
          aValor = aValor - ".";
          aValor = aValor - ".";
     |FINSI;
     |SI aCampo = "diasemana";
          fech1 = #labparhi#3;
          |HAZ DiaSemana;
          aValor = aDiaSemana;
     |FINSI;
     |SI aCampo = "hora";
          aValor = #labparhi#8;
     |FINSI;
     |SI aCampo = "horatrabajo";
          aValor = #labparhi#16;
     |FINSI;
     |SI aCampo = "habitual";
          |SI #labparhi#13 = "S";
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aCampo = "evaluacion";
          |SI #labparhi#73 = "S";
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aCampo = "descripcion";
          aValor = #labparhi#17; |QBF aValor;
          aValor = aValor + " " + #labparhi#18; |QBF aValor;
          aValor = aValor + " " + #labparhi#19; |QBF aValor;
     |FINSI;
     |SI aCampo = "tipolugar";          || lugar
          aValor = #labparhi#74;
          aValor = "000" + aValor; aValor = aValor % -103;
     |FINSI;
     |SI aCampo = "lug";
          aValor = #labparhi#75;
     |FINSI;
     |SI aCampo = "tipotrabajo";        || trabajo
          aValor = #labparhi#76;
     |FINSI;
     |SI aCampo = "trabajo";
          aValor = #labparhi#77;
     |FINSI;
     |SI aCampo = "especifica";         || actividad
          aValor = #labparhi#78;
     |FINSI;
     |SI aCampo = "actividad";
          aValor = #labparhi#79;
     |FINSI;
     |SI aCampo = "agente";
          aValor = #labparhi#80;
     |FINSI;
     |SI aCampo = "desv";               || codigo de desviacion
          aValor = #labparhi#82;
     |FINSI;
     |SI aCampo = "hech";
          aValor = #labparhi#83;
     |FINSI;
     |SI aCampo = "agen";
          aValor = #labparhi#84;
     |FINSI;
     |SI aCampo = "formalesion";
          aValor = #labparhi#86;
     |FINSI;
     |SI aCampo = "tipomodo";
          aValor = #labparhi#87;
     |FINSI;
     |SI aNivelSup = "0101060905";
          |SI aCampo = "agente";
               aValor = #labparhi#88;
          |FINSI;
     |FINSI;
     |SI aCampo = "textoagente";
          aValor = #labparhi#89;
     |FINSI;
     |SI aCampo = "multiples";
          |SI #labparhi#90 = "S";
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aCampo = "testigos";
          |SI #labparhi#101 = "S";
               aValor = "1";
          |SINO;
               aValor = "0";
          |FINSI;
     |FINSI;
     |SI aCampo = "datostes";
          aValor = #labparhi#10; |QBF aValor;
          aValor = aValor + " " + #labparhi#11; |QBF aValor;
     |FINSI;

     /************************    DATOS ASISTENCIALES    *******************/

     |SI aCampo = "lesion";
          aValor = #labparhi#27;
          aValor = "000" + aValor; aValor = aValor % -103;
     |FINSI;
     |SI aCampo = "grado";
          aValor = #labparhi#32;
     |FINSI;
     |SI aCampo = "parte";
          aValor = #labparhi#28;
     |FINSI;
     |SI aNivelSup = "01010704";
          |SI aCampo = "nombre";
               aValor = #labparhi#29;
          |FINSI;
          |SI aCampo = "domicilio";
               || aValor = #labparhi#;
          |FINSI;
          |SI aCampo = "";
               || aValor = #labparhi#;
          |FINSI;
     |FINSI;
     |SI aCampo = "tipoasistenc";
          aValor = #labparhi#33;
     |FINSI;
     |SI aNivelSup = "01010706";        || hospital
          |SI aCampo = "codigo";
               |SI #labparhi#35 = "S";
                    aValor = "1";
               |SINO;
                    aValor = "0";
               |FINSI;
          |FINSI;
          |SI aCampo = "nombre";
               aValor = #labparhi#34;
          |FINSI;
     |FINSI;

     /************************    DATOS ECONOMICOS    *******************/

     |SI aCampo = "mesanterior";
          aValor = #labparhi#36;
          |HAZ decimales;
     |FINSI;
     |SI aNivelSup = "01010801"
          |SI aCampo = "dias";
               aValor = #labparhi#37;
               |HAZ decimales;
          |FINSI;
     |FINSI;
     |SI aCampo = "base";
          nBReg = #labparhi#36/#labparhi#37;
          nBReg = nBReg ! 2;
          aValor = nBReg;
          |HAZ decimales;
     |FINSI;
     |SI aCampo = "b1";
          aValor = #labparhi#38;
          |HAZ decimales;
     |FINSI;
     |SI aCampo = "b2";
          aValor = #labparhi#39;
          |HAZ decimales;
     |FINSI;
     |SI aNivelSup = "01010802";
          |SI aCampo = "total";
               nNume1 = #labparhi#38;
               nNume2 = #labparhi#39;
               nNume = nNume1 + nNume2;
               nNume = nNume ! 2;
               aValor = nNume;
               |HAZ decimales;
          |FINSI;
     |FINSI;
     |SI aCampo = "promedio";
          nProm = #labparhi#38 + #labparhi#39;
          nProm = nProm / 365;
          nProm = nProm ! 2;
          aValor = nProm;
          |HAZ decimales;
     |FINSI;
     |SI aCampo = "promedioa";
          aValor = nBReg;
          |HAZ decimales;
     |FINSI;
     |SI aCampo = "promediob";
          aValor = nProm;
          |HAZ decimales;
     |FINSI;
     |SI aNivelSup = "01010803";
          |SI aCampo = "total";
               nValor = nBReg + nProm;
               aValor = nValor;
               |HAZ decimales;
          |FINSI;
     |FINSI;
     |SI aCampo = "indemnizac";
          nNume = ((nBReg + nProm) % 75) ! 2;
          aValor = nNume;
          |HAZ decimales;
     |FINSI;

     /************************       DATOS ACTORES       *******************/
     |SI aNivelSup = "01010901";
          |SI aCampo = "nombreapellid";       || representante de la empresa
               aValor = #labempre#15;
          |FINSI;
          |SI aCampo = "calidadde";          || cargo representante
               aValor = #labempre#18;
          |FINSI;
          |SI aCampo = "provincia";
               aValor = #labempre#6;
          |FINSI;
          |SI aCampo = "fechapresenta";      || ESTE CAMPO NO DEBE RELLENARSE
          /*
               fFecha = ~;
               aValor = fFecha;
               aValor = aValor - ".";
               aValor = aValor - ".";
          */
          |FINSI;
     |FINSI;
     |SI aNivelSup = "01010902";
          |SI aCampo = "codigo";
               aValor = #labparhi#102 + #labparhi#103;
          |FINSI;
          |SI aCampo = "numexpediente";      || SOLO PARA ENTIDADES GESTORAS
               || aValor = #labparhi#;
          |FINSI;
          |SI aCampo = "fechaaceptacion";    || SOLO PARA ENTIDADES GESTORAS
               || aValor = #labparhi#;
          |FINSI;
     |FINSI;
     |SI aNivelSup = "01010903";
          |SI aCampo = "codigo";          || SOLO PARA AUTORIDADES LABORALES
               aValor = ""
          |FINSI;
          |SI aCampo = "numexpediente";   || SOLO PARA AUTORIDADES LABORALES
               || aValor = #labparhi#;
          |FINSI;
          |SI aCampo = "fecharecepcion"; || SOLO PARA AUTORIDADES LABORALES
               || aValor = #labparhi#;
          |FINSI;
     |FINSI;
     |SI aCampo = "motivorechazo";
          || aValor = #labparhi#;
     |FINSI;

     |QBF aValor;
     |SI aValor ! "";
          #xmlarbol#4 = aValor;
          |GRABA 020#xmlarbol.a;
     |FINSI;
|FPRC;

|DEFBUCLE LineasArbol;
     #xmlarbol#1;
     5;
     001, 1;
     999, 1;
     be;
     NULL, LineasArbol;
|FIN;

|PROCESO CargaParte;
     |ABRE #labparhi;
     |ABRE #labempre;
     |ABRE #labtraba;

     #labparhi#1 = #labparma#1;         || empresa
     #labparhi#2 = #labparma#2;         || trabajador
     #labparhi#15 = #labparma#3;        || fecha baja
     |LEE 101#labparhi.=;

     #labempre#0 = #labparma#1;         || empresa
     |LEE 000#labempre.=;

     #labtraba#0 = #labparma#1;         || empresa
     #labtraba#1 = #labparma#2;         || trabajador
     |LEE 000#labtraba.=;
     alfa1 = #labtraba#2;

     aCadena = #labtraba#2;
     |HAZ SeparaNom_plb;
     aApell1 = eaApel1;
     aApell2 = eaApel2;
     aNombre = eaNom;

     |BUCLE LineasArbol;

     #labparhi#0 = "*";
     |GRABA 020#labparhi.a;
     |LIBERA #labparhi;

     |CIERRA #labempre;
     |CIERRA #labtraba;
     |CIERRA #labparhi;
|FPRC;


/****************** PROCESOS PARA CREACION DEL ARBOL XML ********************/

|PROCESO QuitaCeros;
     |PARA i = 1; |SI i [ 21; |HACIENDO i = i + 1;
          aAlfa = aNivel % -101;
          |SI aAlfa = "0";
               k = 20 - i;
               k = k + 100;
               aNivel = aNivel % k;
          |SINO;
               |SAL;
          |FINSI;
     |SIGUE;
     |SI nNivel2 = 10; |O nNivel2 = 20; |O nNivel2 = 30; |O nNivel2 = 40;
      |O nNivel2 = 50; |O nNivel2 = 60; |O nNivel2 = 70; |O nNivel2 = 80;
          aNivel = aNivel + "0";
     |FINSI;
|FPRC;

|PROCESO Construye2;
     aNivel = aNivel + "00000000000000000000";
     aNivel = aNivel % 120;
     nCorta = nNivel * 2;
     nCorta1 = nCorta - 2;
     nCorta1 = 100 + nCorta1;
     aParte1 = aNivel % nCorta1;
     nCorta2 = 20 - nCorta;
     nCorta2 = -1 * (100 + nCorta2);
     aParte2 = aNivel % nCorta2;

     nCorta = 100 + nCorta;
     aNivel2 = aNivel % nCorta;
     aNivel2 = aNivel2 % -102;
     nNivel2 = aNivel2;
     nNivel2 = nNivel2 + 1;
     || aNivel2 = nNivel2;
     aNivel2 = #xmlparli#1;
     aNivel2 = "00" + aNivel2;
     aNivel2 = aNivel2 % -102;

     aNivel = aParte1 + aNivel2 + aParte2;
     |SI swACero = 1;
          aNivel = aNivel - aParte2;
          aNivel = aNivel + "0000000000000000000";
          aNivel = aNivel % 120;
     |FINSI;
     |HAZ QuitaCeros;
|FPRC;

|PROCESO ConstruyeNivel;
     |SI nElemento [ 1;
          nNivel = nNivel + 1;
     |FINSI;
     nContador = nContador + 1;
|FPRC;

|PROCESO BuscaHijos;
     swHayHijos = 1;

     aEntidad = #xmlparli#2;
     |HAZ impresion;
|FPRC;

|DEFBUCLE BuscaHijos;
     #xmlparli#1;
     ;
     aEntidad,   1;
     aEntidad, 999;
     ;
     NULL, BuscaHijos;
|FIN;

|PROCESO MarcaFin;
     |HAZ ConstruyeNivel;
     |HAZ Construye2
     #100#0 = nContador;
     #100#1 = nNivel;
     #100#2 = #xmlparli#2;
     |SI nNivel = 1;          || excepcion: la ultima
          #100#2 = #xmlparli#0;
     |FINSI;
     #100#3 = aNivel;
     #100#5 = 2;         || cierro entidad compleja
     |GRABA 020#100n;
|FPRC;

|PROCESO BuscaLineaUno;
     || tengo que buscar la linea del xmlparli para que me haga el SALVA_FICHA
     || de la primera linea tambien, sino, no saldra bien al final
     || esto no esta en el proceso que imprime, aunque daria igual
     |SI nContador = 0;
          #xmlparli#0 = #xmlparca#0;
          #xmlparli#1 = 1;
          |LEE 000#xmlparli.=;
     |FINSI;
|FPRC;

|PROCESO impresion;
     swHayHijos = 0;
     #xmlparca#0 = aEntidad;
     |HAZ BuscaLineaUno;
     |LEE 000#xmlparca.=;
     |SI FSalida = 0;         || tiene hijos
          |SALVA_FICHA #xmlparca;
          |SALVA_FICHA #xmlparli;

          swACero = 0;
          |SI nElemento ! 0;
               nNivel = nNivel - 1;
               swACero = 1;
          |FINSI;
          nElemento = 0;
          |HAZ ConstruyeNivel;
          |HAZ Construye2
          #100#0 = nContador;
          #100#1 = nNivel;
          #100#2 = aEntidad;
          #100#3 = aNivel;
          #100#5 = 0;                   || abro entidad compleja
          |GRABA 020#100n;

          |BUCLE BuscaHijos;

          |SI swHayHijos = 0;
               nNivel = nNivel - 1;
               |REPON_FICHA #xmlparca;
               |REPON_FICHA #xmlparli;
               |PARA; |SI FSalida = -1; |HACIENDO;
                    |REPON_FICHA #xmlparca;
                    |REPON_FICHA #xmlparli;
                    ||HAZ MarcaFin2;
               |SIGUE;
               |HAZ MarcaFin;
          |FINSI;
     |SINO;
          nElemento = nElemento + 1;
          |HAZ ConstruyeNivel;
          |HAZ Construye2;
          #100#0 = nContador;
          #100#1 = nNivel;
          #100#2 = aEntidad;
          #100#3 = aNivel;
          #100#5 = 1;                   || entidad simple
          |GRABA 020#100n;
     |FINSI;
|FPRC;

|PROCESO arbol;
     aAlfa = Usuario;    |QBT aAlfa;    aAlfa = ("x" + aAlfa) % 108;
     |NOME_DAT #100 aAlfa;
     |DELINDEX #100;
     |ABRE #100;
     |ABRE #xmlparca;
     |ABRE #xmlparli;
     aEntidad = "MultiPAT";
     |HAZ impresion;
     |CIERRA #100;
     |CIERRA #xmlparca;
     |CIERRA #xmlparli;
|FPRC;

/*************** FINAL PROCESOS PARA CREACION DEL ARBOL XML *****************/

|PROCESO Remesa;
     |HAZ arbol;
     |HAZ CargaParte;
     nPaso = 2;
     |HAZ CreaFichero;
|FPRC;

|PROCESO labparma;
     swHayDatos = 1;
     |HAZ Remesa;

     #labparma#6 = "*";
     #labparma#8 = " ";

     fFecha = ~;
     aAlfa = fFecha;
     #labparma#7 = aAlfa;

     aAlfa = aArchivo;
     |QBF aAlfa;
     #labparma#9 = aAlfa;          || el nombre de fichero

     |GRABA 020#labparma.a;
     |LIBERA #labparma;
|FPRC;

|DEFBUCLE labparma;
     #labparma#2;
     7, 8;
     "-", 000001, "          ", aLimInf;
     "-", 999999, "          ", aLimSup;
     be;
     NULL, labparma;
|FIN;

|PROGRAMA;
     |CLS;
     |HAZ path;
     |HAZ NombreFichero;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |SI #0#0 = "S";
               eaVengoDe = "labparem";
               |SUB_EJECUTA "labparma;PEN";
               aLimInf = "*";
               aLimSup = "*";
          |SINO;
               aLimInf = " ";
               aLimSup = "*";
          |FINSI;

          nPaso = 1;          || la cabecera
          |HAZ CreaDirectorio;
          |HAZ CreaFichero;

          swHayDatos = 0;
          |BUCLE labparma;

          nPaso = 3;          || el pie
          |HAZ CreaFichero;

          |SI swHayDatos = 0;
               |FBORRA aArchivo;
               |MENAV "    No se ha seleccionado ningun Parte";
          |SINO;
               aAlfa = "    Creado fichero de remesa: " + aArchivo;
               aAlfa = aAlfa + " para enviar mediante Sistema Delt@.";
               |MENAV aAlfa;
          |FINSI;
     |FINSI;
|FPRO;
