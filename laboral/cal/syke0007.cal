|FICHEROS;
     syke0007 #0;
     syke0008 #100;
     nomauxi1;
     nomauxi2;
     nomauxl3;
     labtraba;
     labempre;
     labcentr;
     ref0001@ #900;
     syke0014;
|FIN;

|VARIABLES;
     nC0 = 0;
     aC1 = "";
     aC2 = "";
     aC3 = "";
     aC4 = "";
     aC5 = "";
     nC6 = 0;
     aC7 = "";
     nC8 = 0;
     aC9 = "";
     nC10 = 0;
     aC11 = "";
     fC12 = @;
     nC13 = 0;

     {1}aVersion      = "";
     aPath = "";
     aLongitud = "";
     nLongitud = 0;
     nPos = 0;
     nCaracter = 0;
     aCaracter = "";

     fecsys = @;
     aAlfa = "";
     aAlfa1 = "";
     aCodTra = "";
     aDirBase = "";
     aBase = "";
     aOrigen = "";
     aDestino = "";
     aDestinoTrab = "";
     aIPRemoto = "";

     nCuenta = 0;
     nCuentaTot = 0;
     nLinea = 0;
     nNum = 0;

     fFecha = @;
     fFec1 = @;
     fFec2 = @;

     aEmpresa = "";
     aCentro = "";
     aCat = "";
     aEmpresaAnt = "";
     aCentroAnt = "";
     aCatAnt = "";
     aResultado = "";
|FIN;

|PROCESO mirames; |TIPO 7; ||calcula el mes por defecto segun fecha sistema
     fecsys = ~;
     aAlfa = fecsys;
     aAlfa = aAlfa % 402;
     #0Campo = aAlfa;
     |PINTA #0Campo;
|FPRC;

|PROCESO miraanyo; |TIPO 7; ||calcula el periodo por defecto segun fecha sistema
     fecsys = ~;
     aAlfa = fecsys;
     aAlfa = aAlfa % -104;
     #0Campo = aAlfa;
     |PINTA #0Campo;
|FPRC;

|PROCESO labtraba;
     #nomauxi1#0 = #labtraba#62;
     |LEE 000#nomauxi1.=;
     |SI FSalida = 0;
          aC2 = #nomauxi1#0;
          aC3 = #nomauxi1#1;
     |FINSI;

     #nomauxi2#0 = #labtraba#62;
     #nomauxi2#1 = #labtraba#63;
     |LEE 000#nomauxi2.=;
     |SI FSalida = 0;
          ||aArea = #nomauxi2#2;
          ||SISCO. 2.1.2007 Lo he cambiado a Seccion ponia aArea y aSeccion no se inicializaba en ningun sitio
          aC4 = #nomauxi2#1;
          aC5 = #nomauxi2#2;
     |FINSI;

     aAlfa = #labtraba#0; |QBF aAlfa;
     aAlfa = "00000" + aAlfa;
     aAlfa = aAlfa % -105;
     nC0 = aAlfa;

     |LEE 000#labempre.=;
     |SI FSalida = 0;
          aC1 = #labempre#2;
     |FINSI;

     aCodTra = #labtraba#1;
     |QBF aCodTra;
     aCodTra = "00000" + aCodTra;
     aCodTra = aCodTra % -105;
     nC8 = aCodTra;
     aC9 = #labtraba#2;

     #labcentr#0 = #labtraba#0;
     #labcentr#1 = #labtraba#77;
     |LEE 000#labcentr.=;
     |SI FSalida = 0;
          nC6 = #labcentr#1;
          aC7 = #labcentr#2;
     |FINSI;

     nC10 = #labtraba#17;
     aC11 = #labtraba#18;

     |SI #0#6 = "1";
          ||Fecha de Alta
          fC12 = #labtraba#36;
     |SINO;
          ||Fecha de Antiguedad
          fC12 = #labtraba#34;
     |FINSI;

     #syke0014#0 = #labtraba#0;
     #syke0014#1 = #labtraba#1;
     #syke0014#2 = #0#2;
     #syke0014#3 = #0#3;
     #syke0014#4 = 1;
     |LEE 000#syke0014.];
     |SI FSalida = 0; |Y #syke0014#0 = #labtraba#0; |Y #syke0014#1 = #labtraba#1; |Y #syke0014#2 = #0#2; |Y #syke0014#3 = #0#3;
          |PARA; |SI FSalida = 0; #syke0014#0 = #labtraba#0; |Y #syke0014#1 = #labtraba#1; |Y #syke0014#2 = #0#2; |Y #syke0014#3 = #0#3; |HACIENDO;
               aC2  = #syke0014#7;
               aC3  = #syke0014#8;
               aC4  = #syke0014#9;
               aC5  = #syke0014#10;
               nC6  = #syke0014#5;
               aC7  = #syke0014#6;
               nC13 = #syke0014#11;
               |HAZ GrabaTmp;
               |LEE 000#syke0014.s;
          |SIGUE;
     |SINO;
          #syke0014#0 = #labtraba#0;
          #syke0014#1 = #labtraba#1;
          #syke0014#2 = #0#2;
          #syke0014#3 = 99;
          #syke0014#4 = 1;
          |LEE 000#syke0014.];
          |SI FSalida = 0; |Y #syke0014#0 = #labtraba#0; |Y #syke0014#1 = #labtraba#1; |Y #syke0014#2 = #0#2; |Y #syke0014#3 = 99;
               |PARA; |SI FSalida = 0; #syke0014#0 = #labtraba#0; |Y #syke0014#1 = #labtraba#1; |Y #syke0014#2 = #0#2; |Y #syke0014#3 = 99; |HACIENDO;
                    aC2  = #syke0014#7;
                    aC3  = #syke0014#8;
                    aC4  = #syke0014#9;
                    aC5  = #syke0014#10;
                    nC6  = #syke0014#5;
                    aC7  = #syke0014#6;
                    nC13 = #syke0014#11;
                    |HAZ GrabaTmp;
                    |LEE 000#syke0014.s;
               |SIGUE;
          |SINO;
               nC13 = 1;
               |HAZ GrabaTmp;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO GrabaTmp;
     |SI nC6 < #0#4; |O nC6 > #0#5;     |ACABA;   |FINSI;

     #100#0 = nC0;
     #100#1 = aC1;
     #100#2 = aC2;
     #100#3 = aC3;
     #100#4 = aC4;
     #100#5 = aC5;
     #100#6 = nC6;
     #100#7 = aC7;
     #100#8 = nC8;
     #100#9 = aC9;
     #100#10 = nC10;
     #100#11 = aC11;
     #100#12 = fC12;
     #100#13 = nC13;
     |GRABA 020#100n;
|FPRC;

|DEFBUCLE labtraba;
     #labtraba#1;
     44;
     #0#0, 00001, "A";
     #0#1, 99999, "A";
     ;
     NULL, labtraba;
|FIN;

|PROCESO ElProceso;
     |ABRE #labempre;
     |ABRE #labtraba;
     |ABRE #labcentr;
     |ABRE #nomauxi1;
     |ABRE #nomauxi2;
     |ABRE #nomauxl3;
     |ABRE #syke0014;

     aAlfa1 = Usuario; |QBT aAlfa1;    aAlfa1 = ("s" + aAlfa1) % 108;
     |NOME_DAT #100 aAlfa1;
     |DELINDEX #100;

     |ABRE #100;
     |BUCLE labtraba;

     ||CONSULTA_CLAVE #1#100;

     |CIERRA #100;
     |CIERRA #syke0014;
     |CIERRA #labtraba;
     |CIERRA #labempre;
     |CIERRA #labcentr;
     |CIERRA #nomauxi1;
     |CIERRA #nomauxi2;
     |CIERRA #nomauxl3;
|FPRC;

|PROCESO CuentaTrab;
     nCuenta = nCuenta + #100#13;
|FPRC;

|DEFBUCLE CuentaTrab;
     #900#2004;
     12;
     #100#0,#100#6,#100#10,00001,fFec2;
     #100#0,#100#6,#100#10,99999,fFec1;
     ;
     NULL, CuentaTrab;
|FIN;

|PROCESO syke0008;
     aEmpresa = #100#0;    |QBF aEmpresa;
     aCentro = #100#6;     |QBF aCentro;
     aCat = #100#10;       |QBF aCat;
     |SI aEmpresa = aEmpresaAnt; |Y aCentro = aCentroAnt; |Y aCat = aCatAnt;    |ACABA;   |FINSI;

     nLinea = nLinea + 1;
     ||Empresa
     aAlfa = "B" + nLinea + "," + #100#1; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     ||Centro
     aAlfa = "C" + nLinea + "," + #100#7; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     ||Categoria
     aAlfa = "D" + nLinea + "," + #100#11; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     || <1
     fFecha = ~;
     aAlfa = fFecha;
     aAlfa = aAlfa % 407;
     aAlfa = "30." + aAlfa;
     fFec1 = aAlfa;

     aAlfa1 = fFec1;
     aAlfa = aAlfa1 % -104;
     nNum = aAlfa;
     nNum = nNum -1;
     aAlfa = aAlfa1 % 106;
     aAlfa1 = nNum;
     aAlfa = aAlfa + aAlfa1;
     fFec2 = aAlfa;

     nCuenta = 0;
     |BUCLE CuentaTrab;
     aAlfa = "E" + nLinea + "," + nCuenta; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     nCuentaTot = nCuenta;
     || 1
     fFecha = ~;
     aAlfa = fFecha;
     aAlfa = aAlfa % 407;
     aAlfa = "30." + aAlfa;
     fFecha = aAlfa;

     aAlfa1 = fFecha;
     aAlfa = aAlfa1 % -104;
     nNum = aAlfa;
     nNum = nNum -1;
     aAlfa = aAlfa1 % 106;
     aAlfa1 = nNum;
     aAlfa = aAlfa + aAlfa1;
     fFec1 = aAlfa;

     aAlfa1 = fFecha;
     aAlfa = aAlfa1 % -104;
     nNum = aAlfa;
     nNum = nNum -2;
     aAlfa = aAlfa1 % 106;
     aAlfa1 = nNum;
     aAlfa = aAlfa + aAlfa1;
     fFec2 = aAlfa;


     nCuenta = 0;
     |BUCLE CuentaTrab;
     aAlfa = "G" + nLinea + "," + nCuenta; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     nCuentaTot = nCuentaTot + nCuenta;


     || 2
     fFecha = ~;
     aAlfa = fFecha;
     aAlfa = aAlfa % 407;
     aAlfa = "30." + aAlfa;
     fFecha = aAlfa;

     aAlfa1 = fFecha;
     aAlfa = aAlfa1 % -104;
     nNum = aAlfa;
     nNum = nNum -2;
     aAlfa = aAlfa1 % 106;
     aAlfa1 = nNum;
     aAlfa = aAlfa + aAlfa1;
     fFec1 = aAlfa;

     aAlfa1 = fFecha;
     aAlfa = aAlfa1 % -104;
     nNum = aAlfa;
     nNum = nNum -3;
     aAlfa = aAlfa1 % 106;
     aAlfa1 = nNum;
     aAlfa = aAlfa + aAlfa1;
     fFec2 = aAlfa;


     nCuenta = 0;
     |BUCLE CuentaTrab;
     aAlfa = "I" + nLinea + "," + nCuenta; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     nCuentaTot = nCuentaTot + nCuenta;


     || 3
     fFecha = ~;
     aAlfa = fFecha;
     aAlfa = aAlfa % 407;
     aAlfa = "30." + aAlfa;
     fFecha = aAlfa;

     aAlfa1 = fFecha;
     aAlfa = aAlfa1 % -104;
     nNum = aAlfa;
     nNum = nNum -3;
     aAlfa = aAlfa1 % 106;
     aAlfa1 = nNum;
     aAlfa = aAlfa + aAlfa1;
     fFec1 = aAlfa;

     aAlfa1 = fFecha;
     aAlfa = aAlfa1 % -104;
     nNum = aAlfa;
     nNum = nNum -4;
     aAlfa = aAlfa1 % 106;
     aAlfa1 = nNum;
     aAlfa = aAlfa + aAlfa1;
     fFec2 = aAlfa;


     nCuenta = 0;
     |BUCLE CuentaTrab;
     aAlfa = "K" + nLinea + "," + nCuenta; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     nCuentaTot = nCuentaTot + nCuenta;

     || 4
     fFecha = ~;
     aAlfa = fFecha;
     aAlfa = aAlfa % 407;
     aAlfa = "30." + aAlfa;
     fFecha = aAlfa;

     aAlfa1 = fFecha;
     aAlfa = aAlfa1 % -104;
     nNum = aAlfa;
     nNum = nNum -4;
     aAlfa = aAlfa1 % 106;
     aAlfa1 = nNum;
     aAlfa = aAlfa + aAlfa1;
     fFec1 = aAlfa;

     aAlfa1 = fFecha;
     aAlfa = aAlfa1 % -104;
     nNum = aAlfa;
     nNum = nNum -5;
     aAlfa = aAlfa1 % 106;
     aAlfa1 = nNum;
     aAlfa = aAlfa + aAlfa1;
     fFec2 = aAlfa;


     nCuenta = 0;
     |BUCLE CuentaTrab;
     aAlfa = "M" + nLinea + "," + nCuenta; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     nCuentaTot = nCuentaTot + nCuenta;

     || 5>
     fFecha = ~;
     aAlfa = fFecha;
     aAlfa = aAlfa % 407;
     aAlfa = "30." + aAlfa;
     fFecha = aAlfa;

     aAlfa1 = fFecha;
     aAlfa = aAlfa1 % -104;
     nNum = aAlfa;
     nNum = nNum -5;
     aAlfa = aAlfa1 % 106;
     aAlfa1 = nNum;
     aAlfa = aAlfa + aAlfa1;
     fFec1 = aAlfa;

     fFec2 = "01.01.1900";

     nCuenta = 0;
     |BUCLE CuentaTrab;
     aAlfa = "O" + nLinea + "," + nCuenta; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     nCuentaTot = nCuentaTot + nCuenta;

     ||TOTAL y PORCENTAJES
     aAlfa = "Q" + nLinea + "," + nCuentaTot; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;

     aAlfa = "E" + nLinea; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa; nNum = aAlfa;
     |SI nNum ! 0;
          nNum = nNum / nCuentaTot;
          aAlfa = "F" + nLinea + "," + nNum; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;

     aAlfa = "G" + nLinea; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa; nNum = aAlfa;
     |SI nNum ! 0;
          nNum = nNum / nCuentaTot;
          aAlfa = "H" + nLinea + "," + nNum; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;

     aAlfa = "I" + nLinea; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa; nNum = aAlfa;          nNum = nNum / nCuentaTot;
     |SI nNum ! 0;
          nNum = nNum / nCuentaTot;
          aAlfa = "J" + nLinea + "," + nNum; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;

     aAlfa = "K" + nLinea; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa; nNum = aAlfa;
     |SI nNum ! 0;
          nNum = nNum / nCuentaTot;
          aAlfa = "L" + nLinea + "," + nNum; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;

     aAlfa = "M" + nLinea; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa; nNum = aAlfa;
     |SI nNum ! 0;
          nNum = nNum / nCuentaTot;
          aAlfa = "N" + nLinea + "," + nNum; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;

     aAlfa = "O" + nLinea; |ALFACALLDLL "agixl97.dll", "peek_dato", aAlfa; nNum = aAlfa;
     |SI nNum ! 0;
          nNum = nNum / nCuentaTot;
          aAlfa = "P" + nLinea + "," + nNum; |ALFACALLDLL "agixl97.dll","poke_dato", aAlfa;
     |FINSI;

     nCuentaTot = 0;

     aEmpresaAnt = #100#0;    |QBF aEmpresaAnt;
     aCentroAnt = #100#6;     |QBF aCentroAnt;
     aCatAnt = #100#10;       |QBF aCatAnt;
|FPRC;

|DEFBUCLE syke0008;
     #100#2;
     ;
     INICIO;
     FINAL;
     ;
     NULL, syke0008;
|FIN;

|PROCESO ElInforme;
     |DBASE aDirBase;    |QBF aDirBase;
     aAlfa = aDirBase + "def/syke0008.mas";
     |CARGA_DEF aAlfa, ref0001@;
     |SI FSalida ! 0;    |ACABA;   |FINSI;
     aAlfa1 = Usuario; |QBT aAlfa1;    aAlfa1 = ("s" + aAlfa1) % 108;
     |NOME_DAT #900 aAlfa1;
     |ABRE #100;

     |CARGADLL "agixl97.dll";
     |SI FSalida < 0;
          |MENAV "0000No se puede usar la DLL de Excel.";
          |ACABA;
     |FINSI;

     |DBASE aBase;  |QBF aBase;
     aOrigen = aBase + "documentos/tenure_report.xls";
     aDestinoTrab = "C:\DOCUMENTOS";         |RMKDIR aDestino;
     aDestino = aDestinoTrab + "\trabajo.xls";

     aIPRemoto = "";
     |IP_REMOTO aIPRemoto;  |QBT aIPRemoto;
     |SI aIPRemoto ! "";
          |ENVIA_FICHERO aOrigen, aDestino;
     |SINO;
          |COPIA_FICHERO aOrigen, aDestino;
     |FINSI;

     |ALFACALLDLL "agixl97.dll", "carga_book", aDestino;
     |ALFACALLDLL "agixl97.dll", "selecciona_hoja", "TENURE REPORT";


     nLinea = 4;
     |BUCLE syke0008;
     aAlfa   = aDestinoTrab + "\tenure_report.xls";
     |RFBORRA aAlfa;

     |ALFACALLDLL "agixl97.dll", "fichero_destino", aAlfa;
     aResultado = aAlfa;

     |ALFACALLDLL "agixl97.dll", "fin_book", "salva";
     |DESCARGADLL "agixl97.dll";

     aDestino   = aDestinoTrab + "\trabajo.xls";
     |RFBORRA aDestino;

     aVersion1 = "Excel.Sheet";
     |ESPECIFICA "VERSION_PROGRAMA", aVersion;
     |HAZ ExtraePath;
     |SI aPath = "NO LOCALIZADO";
         |MENAV "0000 No puedo encontrar automaticamente la Excel";
         |ACABA;
     |FINSI;

     |QBF aPath;

     || aAlfa  = "cmd " + &34 + "/c START /WAIT " + aPath + " " + aAlfa + &34;
     aAlfa  = "cmd " + &34 + "/c START /WAIT " + aResultado + &34;
     |RSYSTEM aAlfa;

     |CIERRA #100;

     |DESCARGA_DEF #900;
|FPRC;

|PROCESO ExtraePath;
     aPath     = aVersion1;
     aLongitud = aPath % 0;
     nLongitud = aLongitud;
     |PARA nPos = 1; |SI nPos [ nLongitud; |HACIENDO nPos = nPos + 1;
           nCaracter = (nPos * 100) + 1;
           aCaracter = aPath % nCaracter;
           |SI aCaracter = ",";
               nPos = nLongitud - nPos;
               nPos = nPos + 100;
               nPos = (-1) * nPos;
               aPath = aPath % nPos;
               |SAL;
          |FINSI;
     |SIGUE;

     aPath = aPath - "[";
     aPath = aPath - "]";
     |QBF aPath;
|FPRC;

|PROGRAMA;
     |CLS;
     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |HAZ ElProceso;
          |HAZ ElInforme;
     |FINSI;
|FPRO;
