|FICHEROS;
     hotm0036;
     hotm0033;
     hotm0034;
     nomrevca;
     nomrevli;
     labtraba;
|FIN;

|VARIABLES;
     aAlfa1 = "";
     aAlfa2 = "";
     aAlfa3 = "";
     aAlfa4 = "";
     nNume1 = 0;
     nNume2 = 0;
     nNume3 = 0;
     nNume4 = 0;
     nPara1 = 0;
     nPara2 = 0;
     nPara3 = 0;
     nPara4 = 0;
     fFech1 = @;
     fFech2 = @;
     fFech3 = @;
     fFech4 = @;
     nFEstado = 0;
     nSeleccio = 0;
     nModo = 0;

     nImporte = 0;
     nSwRuptura = 0;
     nAntTraba = 0;

     elsw1 = 0;
     confi = "";
     linea = 0;
     la_linea = 0;
     FEstado = 0;
|FIN;
____________________________________/
|PROCESO Ultimo; |TIPO 7;
     |SI elsw1 = 0;
          elsw1 = 1;
          |ABRE #nomrevca;
          #nomrevca#0 = #hotm0036#1;
          #nomrevca#1 = 999999;
          |LEE 000#nomrevca.];
          |SI FSalida = 0;
               |LEE 000#nomrevca.a;
          |SINO;
               |LEE 000#nomrevca.u;
          |FINSI;
          |SI FSalida = 0;|Y #nomrevca#0 = #hotm0036#1;
               #hotm0036#0 = #nomrevca#1 + 1;
          |SINO;
               #hotm0036#0 = 1;
          |FINSI;
          |CIERRA #nomrevca;
     |FINSI;
|FPRC;

|PROCESO SiEsta; |TIPO 0;
     |ABRE #nomrevca;
     #nomrevca#0 = #hotm0036#1;
     #nomrevca#1 = #hotm0036#0;
     |LEE 101#nomrevca.=;
     |SI FSalida = 0;
          |MENSA "2300Registro existente, (I)nicializar - (A)cumular - (C) Cancelar: ";
          |ATRI I;
          |PINTA 2329, "I";
          |PINTA 2345, "A";
          |PINTA 2358, "C";
          |ATRI 0;
          E_sup = 1;
          E_inf = "IACiac";
          |AVISO;
          confi = 2371 ? 0;
          |SI confi = "I";|O confi = "i";
               |MENSA "2300Borrando ...";
               |BUCLELIN 1NULL#nomrevca;
               |BORRA 020#nomrevca.a;
          |SINO;
               |SI confi = "C";|O confi = "c";
                    |PTEC 807;
               |FINSI;
          |FINSI;
          |BLIN 23;
     |FINSI;
     |LIBERA #nomrevca;
     |CIERRA #nomrevca;
|FPRC;
____________________________________/
|PROCESO graba_trans;
     |DDEFECTO #labtraba;
     #labtraba#0 = #hotm0033#0;
     #labtraba#1 = nAntTraba;
     |LEE 000#labtraba.=;

     |SELECT #2#nomrevli;
     #nomrevli#1 = #hotm0036#0;         || registro
     #nomrevli#0 = #hotm0036#1;         || empresa
     #nomrevli#3 = #labtraba#1;         || trabajador
     |LEE 000#nomrevli.=;
     |SI FSalida = 0;                   || lectura por clave secundaria
          la_linea = #nomrevli#2;       ||/por si hay que acumular
     |SINO;
          la_linea = linea;
     |FINSI;

     |SELECT #1#nomrevli;
     |DDEFECTO #nomrevli;
     #nomrevli#0 = #hotm0036#1;         || empresa
     #nomrevli#1 = #hotm0036#0;         || registro
     #nomrevli#2 = la_linea;            || linea
     |LEE 101#nomrevli.=;
     FEstado = FSalida;

     #nomrevli#3  = #labtraba#1;         || trabajador
     #nomrevli#4  = #labtraba#7;         || dni
     #nomrevli#5  = #labtraba#72;        || cta. cte.
     #nomrevli#6  = #nomrevli#6 + nImporte;   || importe
     #nomrevli#7  = #hotm0036#6;              || concepto
     #nomrevli#8  = #labtraba#2;              || apellidos y nombre
     #nomrevli#9  = #labtraba#154;            || IBAN
     #nomrevli#10 = #labtraba#155;            || BIC
     #nomrevli#11 = 0;                        || Transferencia dividida
     #nomrevli#12 = "N";                      || Transferencia dividida

     |SI FEstado = 0;    |GRABA 020#nomrevli.a;   |FINSI;
     |SI FEstado ! 0;    |GRABA 020#nomrevli.n;   |FINSI;
     |LIBERA #nomrevli;

     #nomrevca#2 = #nomrevca#2 + nImporte;   || total importes
     |SI FEstado ! 0;
          linea = linea + 1;                 || contador de lineas
          #nomrevca#3 = #nomrevca#3 + 1;     || total transferencias
     |FINSI;
|FPRC;

|PROCESO graba_cab;
     |DDEFECTO #nomrevca;
     #nomrevca#0 = #hotm0036#1;
     #nomrevca#1 = #hotm0036#0;
     |LEE 101#nomrevca.=;
     |SI FSalida ! 0;
          |GRABA 020#nomrevca.b;
     |FINSI;

     #nomrevli#0 = #nomrevca#0;
     #nomrevli#1 = #nomrevca#1;
     #nomrevli#2 = 99999;
     |LEE 000#nomrevli.];
     |SI FSalida = 0;
          |LEE 000#nomrevli.a;
     |SINO;
          |LEE 000#nomrevli.u;
     |FINSI;
     |SI FSalida = 0;|Y #nomrevli#0 = #nomrevca#0;|Y #nomrevli#1 = #nomrevca#1;
             linea = #nomrevli#2 + 1;
     |SINO;
             linea = 1;
     |FINSI;
|FPRC;

|PROCESO hotm0034;
     #hotm0033#0 = #hotm0034#0;
     #hotm0033#1 = #hotm0034#1;
     |LEE 000#hotm0033.=;
     |SI FSalida = 0;              || si existe la cabecera
          |SI nSwRuptura = 0;
               nSwRuptura = 1;
               nAntTraba = #hotm0034#1;
          |FINSI;
          |SI #hotm0034#1 ! nAntTraba;

               |HAZ graba_trans;

               nAntTraba = #hotm0034#1;
               nImporte = 0;
          |FINSI;

          nImporte = nImporte + #hotm0034#3 + #hotm0034#4 + #hotm0034#5;

          nSeleccio = 1;
     |FINSI;
|FPRC;

|DEFBUCLE hotm0034;
     #hotm0034#1;
     6;
     #hotm0036#1, #hotm0036#2, #hotm0036#4, "T";
     #hotm0036#1, #hotm0036#3, #hotm0036#5, "T";
     ;
     NULL, hotm0034;
|FIN;

|PROCESO Tipo3; |TIPO 3;
     |ABRE #nomrevca;
     |ABRE #nomrevli;
     |ABRE #labtraba;
     |ABRE #hotm0033;

     |HAZ graba_cab;
     |BUCLE hotm0034;
     |SI nSeleccio = 0;
          |MENAV "0000Seleccion vacia.";
          |BORRA 020#nomrevca.a;
     |SINO;
          |HAZ graba_trans;
          #nomrevca#4 = ~;                        || fecha registro
          |GRABA 020#nomrevca.a;
     |FINSI;

     |LIBERA #nomrevca;
     |CIERRA #nomrevca;
     |CIERRA #nomrevli;
     |CIERRA #hotm0033;
     |CIERRA #labtraba;
|FPRC;
