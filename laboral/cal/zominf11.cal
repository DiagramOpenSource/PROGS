|FICHEROS;
     zominf11 #0;
     labempre;
     labtraba;
     nomhicca;

     nomtmp04;
     nomtmp12;
|FIN;

|VARIABLES;
     nDesdeAny = 0;
     nHastaAny = 0;
     swHayAlgo = 0;

     nDiasERE = 0;
     &nDiasEREOK = 0;
     &nDiasERECalc = 0;

     nDesdeMes = 0;
     nHastaMes = 0;
     nCampo = 0;
     nCampo1 = 0;
     nCampo2 = 0;
     nCampo3 = 0;
     nNume = 0;

     nAntEmp = 0;
     nAntTra = 0;
     nAcumDiasOK = 0;
     nAcumDiasCalc = 0;
     aAlfa = "";
     swMarca = 0;
     nAcumDif = 0;
|FIN;

|PROCESO Imprime;
     #nomtmp04#0 = #nomtmp12#0;
     #nomtmp04#1 = #nomtmp12#1;
     |LEE 000#nomtmp04.=;
     |SI FSalida ! 0;
          |ACABA;
     |FINSI;

     #labempre#0 = #nomtmp12#0;
     |LEE 000#labempre.=;
     |SI FSalida ! 0;
          #labempre#2 = "NO EXISTE EMPRESA";
     |FINSI;

     #labtraba#0 = #nomtmp12#0;
     #labtraba#1 = #nomtmp12#1;
     |LEE 000#labtraba.=;
     |SI FSalida ! 0;
          #labtraba#2 = "NO EXISTE TRABAJADOR";
     |FINSI;

     |SI swHayAlgo = 0;
          Impresora = "CrystalReport";
          |IMPRE -1;
          |INFOR "zominf11";
     |FINSI;

     |PRINT;
     swHayAlgo = 1;
|FPRC;

|DEFBUCLE Imprime;
     #nomtmp12#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, Imprime;
|FIN;

|PROCESO LimiteDif;
     || si el trabajador anterior tenia una diferencia menor que
     || 12 euros asumo que no hay que imprimirlo por ser cosa de ajustes
     |SI nAntEmp ! 0; |Y nAntTra ! 0; || no es el primero
          |SI nAcumDif [ 12;
               #nomtmp04#0 = nAntEmp;
               #nomtmp04#1 = nAntTra;
               |LEE 101#nomtmp04.=;
               |SI FSalida = 0;
                    |BORRA 020#nomtmp04.a;
               |FINSI;
               |LIBERA #nomtmp04;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO SegundaPasada;
     swMarca = 0;
     |SI nAntEmp ! #nomtmp12#0; |O nAntTra ! #nomtmp12#1;
          |HAZ LimiteDif;
          || si el trabajador anterior tenia una diferencia menor que
          || 12 euros asumo que no hay que imprimirlo por ser cosa de ajustes
          |SI nAntEmp ! 0; |Y nAntTra ! 0; || no es el primero
               |SI nAcumDif [ 12;
                    #nomtmp04#0 = nAntEmp;
                    #nomtmp04#1 = nAntTra;
                    |LEE 101#nomtmp04.=;
                    |SI FSalida = 0;
                         |BORRA 020#nomtmp04.a;
                    |FINSI;
                    |LIBERA #nomtmp04;
               |FINSI;
          |FINSI;
          nAcumDiasOK = 0;
          nAcumDiasCalc = 0;
          nAcumDif = 0;
     |FINSI;

     |SI nAcumDiasOK = 240;
          #nomtmp12#5 = 0
          #nomtmp12#6 = 240;
          swMarca = 1;
     |SINO;
          #nomtmp12#6 = nAcumDiasOK + #nomtmp12#5;
          |SI #nomtmp12#6 > 240;
               #nomtmp12#5 = 240 - nAcumDiasOK;
               #nomtmp12#6 = 240;
               swMarca = 1;
          |FINSI;
     |FINSI;
     nAcumDiasOK = #nomtmp12#6;

     #nomtmp12#8 = nAcumDiasCalc + #nomtmp12#7;
     nAcumDiasCalc = #nomtmp12#8;

     #nomtmp12#9 = (((#nomtmp12#12 / #nomtmp12#4 * #nomtmp12#5) % 23.60) % #nomtmp12#13);
     #nomtmp12#11 = #nomtmp12#10 - #nomtmp12#9;

     nAcumDif = nAcumDif + #nomtmp12#11;

     nAntEmp = #nomtmp12#0;
     nAntTra = #nomtmp12#1;

     |GRABA 020#nomtmp12.a;
     |LIBERA #nomtmp12;

     |SI swMarca = 1;
          #nomtmp04#0 = nAntEmp;
          #nomtmp04#1 = nAntTra;
          |LEE 101#nomtmp04.=;
          |SI FSalida ! 0;
               |GRABA 020#nomtmp04.n;
          |FINSI;
          |LIBERA #nomtmp04;
     |FINSI;
|FPRC;

|DEFBUCLE SegundaPasada;
     #nomtmp12#1;
     ;
     INICIO;
     FINAL;
     ;
     NULL, SegundaPasada;
|FIN;

|PROCESO GrabaTMP;
     #nomtmp12#0 = #nomhicca#0;
     #nomtmp12#1 = #nomhicca#1;
     #nomtmp12#2 = #nomhicca#66 + 2000;
     #nomtmp12#3 = #nomhicca#2;

     #nomtmp12#4 = nDiasEREOK;
     #nomtmp12#5 = nDiasEREOK;
     #nomtmp12#7 = nDiasEREOK;

     #nomtmp12#10 = #nomhicca#167;
     #nomtmp12#12 = #nomhicca#170;

     |GRABA 020#nomtmp12.n;
     |LIBERA #nomtmp12;
|FPRC;

|PROCESO nomhicca;
     swHayAlgo = 1;

     #labempre#0 = #nomhicca#0;
     |LEE 000#labempre.=;
     |SI FSalida ! 0;
          #labempre#2 = "NO EXISTE EMPRESA";
     |FINSI;

     #labtraba#0 = #nomhicca#0;
     #labtraba#1 = #nomhicca#1;
     |LEE 000#labtraba.=;
     |SI FSalida ! 0;
          #labtraba#2 = "NO EXISTE TRABAJADOR";
     |FINSI;

     nDiasERE = 0;
     nDiasEREOK = 0;
     nDiasERECalc = 0;

     |PARA nCampo = 27; |SI nCampo [ 30; |HACIENDO nCampo = nCampo + 1;
          nCampo1 = nCampo - 8;
          nCampo2 = nCampo - 4;
          nCampo3 = nCampo - 134;
          |SI #nomhicca#nCampo# = "D";
               nDiasERE = (#nomhicca#nCampo2# - #nomhicca#nCampo1#) + 1;
               nDiasEREOK = nDiasEREOK + nDiasERE;
               nDiasERECalc = nDiasERECalc + #nomhicca#119;
          |FINSI;
     |SIGUE;

     |SI #labtraba#219 = 0;
          #nomtmp12#13 = 50;
     |SINO;
          #nomtmp12#13 = #labtraba#219;
     |FINSI;

     |SI nDiasERE ! 0; |Y #nomhicca#167 ! 0;
          |HAZ GrabaTMP;
     |FINSI;
|FPRC;

|DEFBUCLE nomhicca;
     #nomhicca#1;
     ;
     #0#0, #0#2, nDesdeAny, nDesdeMes, 00;
     #0#1, #0#3, nHastaAny, nHastaMes, 00;
     ;
     NULL, nomhicca;
|FIN;

|PROGRAMA;
     |CLS;

     |PINPA #0#0;

     |ABRE #0;
     |DDEFECTO #0;
     |LEE 000#0p;
     |SI FSalida = 0;
          |BORRA 020#0a;
     |FINSI;

     |PINDA #0#0;

     |ENDATOS #1#0;
     |SI FSalida = 0;
          aAlfa = Usuario; |QBT aAlfa; aAlfa = "tm_nomtmp12_" + aAlfa;
          |NOME_DAT #nomtmp12#aAlfa#;
          |DELINDEX #nomtmp12;
          |ABRE #nomtmp12;

          aAlfa = Usuario; |QBT aAlfa; aAlfa = "tm_nomtmp04_" + aAlfa;
          |NOME_DAT #nomtmp04#aAlfa#;
          |DELINDEX #nomtmp04;
          |ABRE #nomtmp04;

          |ABRE #labempre;
          |ABRE #labtraba;
          |ABRE #nomhicca;

          nDesdeAny = #0#4 - 2000;
          nHastaAny = #0#5 - 2000;

          |SI #0#4 = #0#5;
               nDesdeAny = #0#4 - 2000;
               nHastaAny = #0#5 - 2000;

               nDesdeMes = #0#6;
               nHastaMes = #0#7;
               |BUCLE nomhicca;
          |SINO;
               nDesdeAny = #0#4 - 2000;
               nHastaAny = #0#4 - 2000;

               nDesdeMes = #0#6;
               nHastaMes = 12;

               |BUCLE nomhicca;

               nDesdeAny = #0#4 - 2000;
               nHastaAny = #0#5 - 2000;

               nNume = nHastaAny - nDesdeAny;
               |SI nNume ] 2;
                    nDesdeAny = nDesdeAny + 1;
                    nHastaAny = nHastaAny - 1;
                    nDesdeMes = 1;
                    nHastaMes = 12;
                    |BUCLE nomhicca;
               |FINSI;

               nDesdeAny = #0#5 - 2000;
               nHastaAny = #0#5 - 2000;

               nDesdeMes = 1;
               nHastaMes = #0#6;

               |BUCLE nomhicca;
          |FINSI;

          |BUCLE SegundaPasada;
          |HAZ LimiteDif;

          ||CONSULTA_CLAVE #1#nomtmp12;
          ||CONSULTA_CLAVE #1#nomtmp04;

          swHayAlgo = 0;
          |BUCLE Imprime;

          |CIERRA #nomtmp04;
          |CIERRA #nomtmp12;
          |CIERRA #nomhicca;
          |CIERRA #labtraba;
          |CIERRA #labempre;

          |SI swHayAlgo = 0;
               |MENAV "    No se han encontrado trabajadores afectados";
          |SINO;
               |PIEINF;
               |FININF;
               |FINIMP;
          |FINSI;

          |DELINDEX #nomtmp04;
          |DELINDEX #nomtmp12;
     |FINSI;
     |GRABA 000#0n;
     |CIERRA #0;
|FPRO;
