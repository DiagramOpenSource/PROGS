|FICHEROS;
     hotm0053 #0;
     hotm0054;
     hotm0009 #9;        || cabecera planilla mensual
     hotm0010 #10;       || lineas planilla mensual
     hotm0012 #12;       || cabecera planilla general
     hotm0013 #13;       || lineas planilla general
     copiacab@ #100;
     copialin@ #101;
     labtraba;
     nomconca;
     hotm0060;           || Equivalencia Diagram-Evology Empresas
     hotm0061;           || Equivalencia Diagram-Evology Centros
     hotm0062;           || Equivalencia Diagram-Evology Areas
     labempre;
|FIN;

|VARIABLES;
     nDesdeTipo = 0;
     nHastaTipo = 0;
     fFecha = @;
     fFechaIni = @;
     aFecha = "";
     aHora = "";
     aDia = "";
     aMes = "";
     aAny = "";
     nDia = 0;
     nMes = 0;
     nAny = 0;
     nNume = 0;

     &aFichero = "";
     nCanal = 0;
     aLinea = "";
     aDato = "";
     aTipo = "";

     taporta = 0;
     tantici = 0;
     deducir = 0;
     nConcepto = 0;
     aDef = "";
     aElDef = "";
     &nGenerados = 0;
     &nNoGenerados = 0;
     &nRepetidos = 0;
     swSTOP = 0;
     aPath = "";
     aAlfa = "";
     nCar = 0;
     aTip = "";
     nAnyHis = 0;
     nCampo = 0;
     nCampoE = 0;
     nCampoT = 0;
     swFiniquito = 0;
     swMensual = 0;
     swGeneral = 0;
     nCoefi = 0;
     nBruto = 0;
     nBaseIRPF = 0;
     nNeto = 0;
     nReten = 0;
     n414 = 0;
     n418 = 0;
     n906 = 0;
     n907 = 0;
     n908 = 0;
     n201 = 0;
     n202 = 0;
     n203 = 0;
     n204 = 0;
     nA201 = 0;
     nA202 = 0;
     nA203 = 0;
     nA204 = 0;
     n121 = 0;
     nRet121 = 0;
     n926 = 0;
     n121Pre = 0;
     nRet121Pre = 0;

     nTotBruto = 0;
     nTotBaseIRPF = 0;
     nTotNeto = 0;
     nTotReten = 0;
     nTot414 = 0;
     nTot418 = 0;
     nTot906 = 0;
     nTot907 = 0;
     nTot908 = 0;
     nTot201 = 0;
     nTot202 = 0;
     nTot203 = 0;
     nTot204 = 0;
     nTotA201 = 0;
     nTotA202 = 0;
     nTotA203 = 0;
     nTotA204 = 0;
     nTot121 = 0;
     nTotRet121 = 0;
     nTot121Pre = 0;
     nTotRet121Pre = 0;
     nTot926 = 0;
     nLinea = 0;
     nTotLineas = 0;
     nSSTra = 0;
     nTotSSTra = 0;
     nSSEmp = 0;
     nTotSSEmp = 0;
     nExento = 0;
     nTotExento = 0;
     nExentoFin = 0;
     nTotExentoFin = 0;
     nLineaPro = 0;
     nPresSS = 0;
     nTotPresSS = 0;
     nDato = 0;
     swBuscoPro = 0;
     aDelimitador = "#";
     &nAcumBru = 0;
     &nAcumBas = 0;
     &nAcumRet = 0;
     &nAcumEx1 = 0;
     &nAcumSST = 0;
     &nAcumSSE = 0;
     &nAcumPSS = 0;
     &nAcumNet = 0;
     &nAcum906 = 0;
     &nAcum414 = 0;
     &nAcum418 = 0;
     &nAcum4XX = 0;
     &nAcum907 = 0;
     &nAcum908 = 0;
     &nAcum201 = 0;
     &nAcum202 = 0;
     &nAcum203 = 0;
     &nAcum204 = 0;
     &nAcumA201 = 0;
     &nAcumA202 = 0;
     &nAcumA203 = 0;
     &nAcumA204 = 0;
     &nAcum926 = 0;

     &nAcum121 = 0;
     &nAcum121Pre = 0;
     &nAcumRet121 = 0;
     &nAcumRet121Pre = 0;

     aError = "";
     aAlfa1 = "";
     aAlfa2 = "";
     &aEmpresa = "";
     nEmpAnt = 0;
     nTotTrabEmp = 0;
     swElPrimero = 0;
     swParrilla = 0;
     &swPorEmpresa = 0;
     &aNomEmpresa = "";
     nDesdeMes = 0;
     nHastaMes = 0;
     nMesCalculo = 0;
|FIN;

/****************** PROCESOS DESDE LA PANTALLA ******************************/

|PROCESO LimpiaParr;
     nCampoE = Campo;
     |SI #0nCampoE = 0;
          |PARA nCampoE = 13; |SI nCampoE [ 30; |HACIENDO nCampoE = nCampoE + 1;
               nCampoT = nCampoE + 21;
               #0nCampoE = 0;
               #0nCampoT = 0;
               |PINTA #0nCampoE;
               |PINTA #0nCampoT;
               |SI nCampoE ! 13;
                    |CAMPO_MODIFICA #0nCampoE, 1, "N";
               |FINSI;
               |CAMPO_MODIFICA #0nCampoT, 1, "N";
          |SIGUE;
          |PARA nCampoE = 0; |SI nCampoE [ 1; |HACIENDO nCampoE = nCampoE + 1;
               nCampoT = nCampoE + 2;
               |CAMPO_MODIFICA #0nCampoE, 1, "S";
               |CAMPO_MODIFICA #0nCampoT, 1, "S";
          |SIGUE;
     |SINO;
          |PARA nCampoE = 13; |SI nCampoE [ 30; |HACIENDO nCampoE = nCampoE + 1;
               nCampoT = nCampoE + 21;
               |CAMPO_MODIFICA #0nCampoE, 1, "S";
               |CAMPO_MODIFICA #0nCampoT, 1, "S";
          |SIGUE;
          |PARA nCampoE = 0; |SI nCampoE [ 1; |HACIENDO nCampoE = nCampoE + 1;
               nCampoT = nCampoE + 2;
               |CAMPO_MODIFICA #0nCampoE, 1, "N";
               |CAMPO_MODIFICA #0nCampoT, 1, "N";
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO Defecto; |TIPO 14;
     |PINTA 0906, "                                   ";
     |SI #0#4 = "M";
          |ATRI R;
          |PINTA 0911,      " MANTENIMIENTO MENSUAL ";
          |ATRI 0;
     |FINSI;
     |SI #0#4 = "H";
          |ATRI R;
          |PINTA 0910,     " MANTENIMIENTO HISTORICO ";
          |ATRI 0;
     |FINSI;
     |SI #0#4 = "A";
          |ATRI R;
          |PINTA 0911,      " MANTENIMIENTO ATRASOS ";
          |ATRI 0;
     |FINSI;
     |SI #0#4 = "T";
          |ATRI R;
          |PINTA 0906, "  MANTENIMIENTO ATRASOS HISTORICO  ";
          |ATRI 0;
     |FINSI;
     |SI #0#4 = "A"; |O #0#4 = "T";
          #0#8 = "X";
          #0#9 = " ";
          #0#10 = " ";
          |CAMPO_MODIFICA #0#8, 1, "N";
          |CAMPO_MODIFICA #0#9, 1, "N";
          |CAMPO_MODIFICA #0#10, 1, "N";
          |PINTA #0#8;
          |PINTA #0#9;
          |PINTA #0#10;
     |SINO;
          |CAMPO_MODIFICA #0#8, 1, "S";
          |CAMPO_MODIFICA #0#9, 1, "S";
          |CAMPO_MODIFICA #0#10, 1, "S";
     |FINSI;

     |ATRI I;
     |SI #0#4 = "A"; |O #0#4 = "T";
          |ATRI 0;
          |PINTA 1022, "-    ";
          |CAMPO_MODIFICA #0#58, 1, "S";
          |CAMPO_VISUAL #0#58, 1, "S";
          |PINTA #0#58
     |SINO;
          |CAMPO_MODIFICA #0#58, 1, "N";
          |CAMPO_VISUAL #0#58, 1, "N";
          |ATRI 0;
          |PINTA 1022, "     ";
     |FINSI;
     |ATRI I;

     |ATRI I;
     |SI #0#4 = "T";
          |PINTA 0830, "Tipo:    ";
          |CAMPO_MODIFICA #0#59, 1, "S";
          |CAMPO_VISUAL #0#59, 1, "S";
          |PINTA #0#59;
     |SINO;
          |CAMPO_MODIFICA #0#59, 1, "N";
          |CAMPO_VISUAL #0#59, 1, "N";
          |ATRI 0;
          |PINTA 0830, "         ";
     |FINSI;
     |ATRI I;
|FPRC;

|PROCESO Marca;
     |SI #0Campo = " ";
          #0Campo = "X";
          |PINTA #0Campo;
     |SINO;
          #0Campo = "X";
          |PINTA #0Campo;
     |FINSI;
|FPRC;


|PROCESO Fichero;
     |ABRE #labempre;
     #labempre#0 = #100#0;
     |LEE 000#labempre.=;
     |CIERRA #labempre;

     aEmpresa = #100#0;
     aEmpresa = "00000" + aEmpresa;
     aEmpresa = aEmpresa % -105;

     fFecha = ~;
     aFecha = fFecha;
     |HORA aHora;
     aFecha = aFecha - ".";
     aFecha = aFecha - ".";
     aHora = aHora - ":";
     aHora = aHora - ":";
     |SI swParrilla = 1;
          aFichero = aFecha + "_" + aHora;
     |SINO;
          aFichero = aEmpresa + "_" + aFecha + "_" + aHora;
     |FINSI;
     |SI #0#4 = "M";      || desde el mensual
          aFichero = aFichero + "_M";
     |FINSI;
     |SI #0#4 = "H";      || desde el historico
          aFichero = aFichero + "_H";
     |FINSI;
     |SI #0#4 = "A";      || desde atrasos
          aFichero = aFichero + "_A";
     |FINSI;
     |SI #0#4 = "T";      || desde atrasos
          aFichero = aFichero + "_T";
     |FINSI;
     aFichero = aFichero + ".txt";
     aPath = #0#12;
     |QBF aPath;
     aAlfa = aPath % -101;
     |SI aAlfa ! "/"; |Y aAlfa ! "\";
          aPath = aPath + "/";
     |FINSI;
     aPath = aPath + aFichero;
|FPRC;

|PROCESO Seleccion;
     |SI #0#8 = " "; |Y #0#9 = " "; |Y #0#10 = " ";
          |MENAV "    Debera marcar algun tipo de nomina: Normal, Finiquito o Pagas";
          |POSICIONATE #0#8;
     |FINSI;
|FPRC;

|PROCESO Desmarca;
     |SI Campo = 8;
          |SI #0#8 = "X";
               #0#9 = " ";
               #0#10 = " ";

               |PINTA #0#9;
               |PINTA #0#10;
          |FINSI;
     |FINSI;
     |SI Campo = 9;
          |SI #0#9 = "X";
               #0#8 = " ";
               #0#10 = " ";

               |PINTA #0#8;
               |PINTA #0#10;
          |FINSI;
     |FINSI;
     |SI Campo = 10;
          |SI #0#10 = "X";
               #0#8 = " ";
               #0#9 = " ";

               |PINTA #0#8;
               |PINTA #0#9;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO FechaIni;
     nDia = 1;
     nMes = #100#2;
     nAny = #0#7;

     aDia = "01";
     aMes = nMes; aMes = "00" + aMes; aMes = aMes % -102;
     aAny = nAny;

     aFecha = aDia + "." + aMes + "." + aAny;
     fFecha = aFecha;

     fFechaIni = #100#4;
     |SI fFechaIni > fFecha;
          aDia = #100#4 % 102;
          nDia = aDia;
     |FINSI;
|FPRC;

|PROCESO FechaFin;
     nMes = #100#2;
     nAny = #0#7;
     nNume = nAny $ 4;

     |SI nMes = 1; |O nMes = 3; |O nMes = 5; |O nMes = 7; |O nMes = 8;
     |O nMes = 10; |O nMes = 12;
          nDia = 31;
     |FINSI;
     |SI nMes = 4; |O nMes = 6; |O nMes = 9; |O nMes = 11;
          nDia = 30;
     |FINSI;
     |SI nMes = 2;
          |SI nNume ! 0;
               nDia = 28;
          |SINO;
               nDia = 29;
          |FINSI;
     |FINSI;

     |SI aTipo = "FINIQUITO   ";
          aAlfa = #100#5 % 102;
          nDia = aAlfa;
     |FINSI;
|FPRC;

|PROCESO Registro;
     #hotm0054#0 = #100#0;    || Empresa
     #hotm0054#1 = #100#1;    || Trabajador
     #hotm0054#2 = #0#7;      || A¤o
     #hotm0054#3 = #100#2;    || Mes
     |SI aTipo = "NORMAL      ";        || Tipo
          #hotm0054#4 = 0;
          |SI swFiniquito = 1;
               #hotm0054#4 = 2;
          |FINSI;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  ";        || Tipo
          #hotm0054#4 = 1;
     |FINSI;
     /*
     |SI aTipo = "FINIQUITO   ";        || Tipo
          #hotm0054#4 = 2;
     |FINSI;
     */

     |SI #0#4 = "M"
          #hotm0054#5 = "M";         || Desde Mensual
     |FINSI;
     |SI #0#4 = "H"
          #hotm0054#5 = "H";         || Desde Historico
     |FINSI;
     |SI #0#4 = "A"
          #hotm0054#4 = 5;
          #hotm0054#5 = "A";         || Desde Atrasos
     |FINSI;
     |SI #0#4 = "T"
          #hotm0054#4 = #100#3;
          #hotm0054#5 = "T";         || Desde Atrasos
     |FINSI;

     #hotm0054#6 = aFichero;       || Fichero
     #hotm0054#7 = ~;              || Fecha
     #hotm0054#8 = aHora;          || Hora Creacion
     #hotm0054#9 = nLineaPro;      || Linea Prorrata

     |GRABA 020#hotm0054.n;
     |LIBERA #hotm0054;
|FPRC;

|PROCESO ParaFiniq;
     nNume = 0;
     |PARA nConcepto = 201; |SI nConcepto [ 208; |HACIENDO nConcepto = nConcepto + 1;
          #101#0 = #100#0;
          #101#1 = #100#1;
          |SI #0#4 = "H"; |O #0#4 = "T";    || desde historico, busco a¤o
               #101#12 = #0#7 - 2000;
          |FINSI;
          #101#2 = #100#2;
          #101#3 = #100#3;
          #101#4 = nConcepto;
          |LEE 000#101=;
          |SI FSalida = 0;
               #nomconca#0 = #labtraba#87;        || busco convenio
               |LEE 000#nomconca.=;
               |SI FSalida = 0;
                    nCampo = nConcepto - 181;  || para buscar si es "99"
                    |SI #nomconca#nCampo# ! 99;
                         nNume = nNume + ((#101#9 * #101#10) ! 2);
                    |FINSI;
               |FINSI;
          |FINSI;
     |SIGUE;
     nNume = nNume ! 2;
|FPRC;

|PROCESO LeeConcepto;
     nNume = 0;
     #101#0 = #100#0;
     #101#1 = #100#1;
     |SI #0#4 = "H"; |O #0#4 = "T";    || desde historico, busco a¤o
          #101#12 = #0#7 - 2000;
     |FINSI;
     #101#2 = #100#2;
     #101#3 = #100#3;
     #101#4 = nConcepto;
     |LEE 000#101=;
     |SI FSalida = 0; |O swBuscoPro = 1;
          |SI nConcepto > 299;                    || no es una paga
          |O nConcepto = 121;           || el 121 lo pidieron tambien
                                        || para que apareciera aqui
               nNume = #101#11 * #101#10;
          |SINO;                                  || es una paga
               #nomconca#0 = #labtraba#87;        || busco convenio
               |LEE 000#nomconca.=;
               |SI FSalida = 0;
                    nConcepto = nConcepto - 181;  || para buscar si es "99"
                    ||SI #nomconca#nConcepto# ! 99;
                         nNume = #101#9 * #101#10;
                    ||SINO;
                    ||     nNume = 0;
                    ||FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     nNume = nNume ! 2;
|FPRC;

|PROCESO BuscaAcumPaga;
     nNume = 0;
     #101#0 = #100#0;
     #101#1 = #100#1;
     |SI #0#4 = "H"; |O #0#4 = "T";    || desde historico, busco a¤o
          #101#12 = #0#7 - 2000;
     |FINSI;
     #101#2 = #100#2;
     #101#3 = #100#3;
     #101#4 = nConcepto;
     |LEE 000#101=;
     |SI FSalida = 0;
          #nomconca#0 = #labtraba#87;        || busco convenio
          |LEE 000#nomconca.=;
          |SI FSalida = 0;
               nConcepto = nConcepto - 181;  || para buscar si es "99"
               |SI #nomconca#nConcepto# ! 99;
                    nNume = (#101#11 * #101#10) - (#101#9 * #101#10);
               |FINSI;
          |FINSI;
     |FINSI;
     nNume = nNume ! 2;
|FPRC;

|PROCESO LeeCAS;

|FPRC;

|PROCESO DatosAdic;
     #labtraba#0 = #100#0;
     #labtraba#1 = #100#1;
     |LEE 000#labtraba.=;

     |SI #0#55 = "A"; |Y #labtraba#44 ! "A";
          swSTOP = 1;
     |FINSI;
     |SI #0#55 = "B"; |Y #labtraba#44 ! "B";
          swSTOP = 1;
     |FINSI;

     aAlfa = #100#5;
     aAlfa = aAlfa % 402;
     nNume = aAlfa;

     |SI nNume = #100#2; |Y #0#4 ! "A"; |Y #0#4 ! "T";
          swFiniquito = 1;    || tengo finiquito en el mes
     |SINO;
          swFiniquito = 0;
     |FINSI;

     |SI aTipo = "NORMAL      "; || Tipo
          |SI swFiniquito = 1;
               swSTOP = 1;
          |FINSI;
     |FINSI;
     |SI aTipo = "FINIQUITO   ";        || Tipo
          |SI swFiniquito = 0;
               swSTOP = 1;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO Comprobaciones;
     #hotm0054#0 = #100#0;    || Empresa
     #hotm0054#1 = #100#1;    || Trabajador
     #hotm0054#2 = #0#7;      || A¤o
     #hotm0054#3 = #100#2;    || Mes
     |SI aTipo = "NORMAL      ";        || Tipo
          #hotm0054#4 = 0;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  ";        || Tipo
          #hotm0054#4 = 1;
     |FINSI;
     |SI aTipo = "FINIQUITO   ";        || Tipo
          #hotm0054#4 = 2;
     |FINSI;
     |SI #0#4 = "M"; #hotm0054#5 = "M"; |FINSI;
     |SI #0#4 = "H"; #hotm0054#5 = "H"; |FINSI;
     |SI #0#4 = "A"; #hotm0054#5 = "A"; |FINSI;
     |SI #0#4 = "T"; #hotm0054#5 = "T"; |FINSI;

     |SI #0#4 = "A"; |O #0#4 = "T";
          #hotm0054#4 = #100#3;
     |FINSI;

     #hotm0054#9 = nLineaPro;
     |LEE 000#hotm0054.=;
     |SI FSalida ! 0;
          swSTOP = 0;
     |SINO;
          swSTOP = 1;
          nNoGenerados = nNoGenerados + 1;
          nRepetidos = nRepetidos + 1;
          |PRINT;
     |FINSI;
|FPRC;

|PROCESO Formatea;
     || N = numero, rellena por la izquierda con ceros
     || A = alfanumerico, rellena por la derecha con blancos
     || D = numero con decimales, por la derecha con blancos y si es entero
     ||     lo transforma a ,00
     || F = Fecha, construye fecha a partir de nDia, nMes, nAny

     |SI aTip = "N"; |O aTip = "A"; |O aTip = "D";
          |SI aTip = "D";
               aAlfa = aDato % -301;
               |SI aAlfa ! ".";
                    aAlfa = aDato % -201;
                    |SI aAlfa ! ".";
                         aDato = aDato + ".00";
                    |SINO;
                         aDato = aDato + "0";
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI aTip = "N";
               aAlfa = "0" * nCar;
          |SINO;
               aAlfa = " " * nCar;
          |FINSI;
          aDato = aAlfa + aDato;
          nCar = (nCar + 100) * (-1)
          aDato = aDato % nCar;
     |FINSI;

     |SI aTip = "F";
          aDia = nDia; aDia = "00" + aDia; aDia = aDia % -102;
          aMes = nMes; aMes = "00" + aMes; aMes = aMes % -102;
          aAny = nAny;
          aDato = aDia + "." + aMes + "." + aAny;
     |FINSI;

     aLinea = aLinea + aDato + aDelimitador;
|FPRC;

|PROCESO Lineas;
     nLinea = nLinea + 1;
     nLineaPro = 0;
     swBuscoPro = 0;
     |SI swMensual = 1;
          nCoefi = #hotm0010#11;
          nLineaPro = #hotm0010#4;
     |SINO;
          nCoefi = #hotm0013#9;
          nLineaPro = #hotm0013#2;
     |FINSI;
     |HAZ Comprobaciones;
     |HAZ DatosAdic;
     |SI swSTOP = 1;
          |ACABA;
     |FINSI;

     aLinea = "";

     nDato = #100#0;
     #hotm0060#0 = nDato;
     |LEE 000#hotm0060.=;
     |SI FSalida = 0;
          nDato = #hotm0060#1;
     |SINO;
          aDato = nDato;               || Empresa
          aError = "la Empresa " + aDato;
     |FINSI;

     aDato = nDato;               || Empresa
     nCar = 5; aTip = "N";    |HAZ Formatea;

     |HAZ LeeCAS;

     |SI swMensual = 1;                      || CENTRO
          nDato = #10#5;
     |SINO;
          nDato = #13#3;
     |FINSI;
     #hotm0061#0 = nDato;
     |LEE 000#hotm0061.=;
     |SI FSalida = 0;
          nDato = #hotm0061#1;
     |SINO;
          aDato = nDato;
          aError = "el Centro " + aDato;
     |FINSI;
     aDato = nDato;
     nCar = 2; aTip = "N";    |HAZ Formatea;

     |SI swMensual = 1;                      || AREA
          aDato = #10#7;
     |SINO;
          aDato = #13#5;
     |FINSI;

     #hotm0062#0 = aDato;
     |LEE 000#hotm0062.=;
     |SI FSalida = 0;
          aDato = #hotm0062#1;
     |SINO;
          aError = "el Area " + aDato;
     |FINSI;
     nCar = 2; aTip = "N";    |HAZ Formatea;

     |SI swMensual = 1;                      || SECCION
          aDato = #10#9;
     |SINO;
          aDato = #13#7;
     |FINSI;
     nCar = 2; aTip = "A";    |HAZ Formatea;

     aDato = #100#1;                         || Trabajador
     nCar = 5; aTip = "N";    |HAZ Formatea;
     aDato = #labtraba#7;                    || NIF
     nCar = 12; aTip = "A";    |HAZ Formatea;
     aDato = #labtraba#2;                    || Nombre trabajador
     nCar = 40; aTip = "A";    |HAZ Formatea;

     aAlfa = aError % -101;   || para saber que es el trabajador que tiene error
     |SI aError ! ""; |Y aAlfa ! ")";
          aAlfa1 = #100#0; aAlfa1 = "00000" + aAlfa1; aAlfa1 = aAlfa1 % -105;
          aAlfa2 = #100#1; aAlfa2 = "00000" + aAlfa2; aAlfa2 = aAlfa2 % -105;
          aError = aError + " (" + aAlfa1 + "." + aAlfa2 + ")"
     |FINSI;

     nDia = 1;
     nMes = #100#2;
     nAny = #0#7;
     |HAZ FechaIni;
     nCar = 0; aTip = "F";    |HAZ Formatea;

     |HAZ FechaFin;
     nCar = 0; aTip = "F";    |HAZ Formatea;

     aDato = aTipo;                || Id. Tipo de Nomina
     |SI #0#4 = "A"; |O #0#4 = "T";
          aDato = "ATRASOS     ";                 || Para que grabe el tipo
     |FINSI;                                      || Atrasos
     nCar = 12; aTip = "A";    |HAZ Formatea;

     |SI aTipo = "PAGA EXTRA  ";                  || Paga Extra
          nBruto = #100#47;
          |SI nBruto = 0; |O swFiniquito = 1;
               |ACABA;
          |FINSI;
     |FINSI;
     |SI aTipo = "NORMAL      ";                  || Normal
          nBruto = #100#46;
     |FINSI;
     |SI aTipo = "FINIQUITO   ";                  || Finiquito
          || HAZ ParaFiniq;
          || nBruto = #100#46 - nNume;
          nBruto = #100#46;
     |FINSI;

     |SI nLinea ! nTotLineas;
          nBruto = nBruto * nCoefi;
          nBruto = nBruto ! 2;
          nTotBruto = nTotBruto + nBruto;
     |SINO;
          nAcumBru = nAcumBru + nBruto;

          nBruto = nBruto - nTotBruto;
     |FINSI;

     aDato = nBruto
     nCar = 20; aTip = "D";    |HAZ Formatea;     || BRUTO

     |SI aTipo = "PAGA EXTRA  ";                  || Paga Extra
          nBaseIRPF = #100#16;
          |SI nBaseIRPF = 0; |O swFiniquito = 1;
               |ACABA;
          |FINSI;
     |FINSI;
     |SI aTipo = "NORMAL      ";                  || Normal
          nBaseIRPF = #100#14;
     |FINSI;
     |SI aTipo = "FINIQUITO   ";                  || Finiquito
          nBaseIRPF = #100#14;
     |FINSI;

     |SI nLinea ! nTotLineas;
          nBaseIRPF = nBaseIRPF * nCoefi;
          nBaseIRPF = nBaseIRPF ! 2;
          nTotBaseIRPF = nTotBaseIRPF + nBaseIRPF;
     |SINO;
          nAcumBas = nAcumBas + nBaseIRPF;
          nBaseIRPF = nBaseIRPF - nTotBaseIRPF;
     |FINSI;

     aDato = nBaseIRPF
     nCar = 20; aTip = "D";    |HAZ Formatea;     || BASE IRPF

     |SI aTipo = "PAGA EXTRA  ";                  || Paga Extra
          |SI swFiniquito = 0;
               nReten = #100#17;
          |FINSI;
     |FINSI;
     |SI aTipo = "NORMAL      "; |O aTipo = "FINIQUITO   "; || Normal o Finiquito
          |SI #0#4 = "M"; |O #0#4 = "A";
               nReten = #100#75;
          |SINO;
               nReten = #100#114;
          |FINSI;
     |FINSI;

     || le tengo que restar el 121, ya que este sale en columna aparte

     nRet121Pre = 0;
     |SI aTipo ! "PAGA EXTRA  ";                  || Paga Extra
          nConcepto = 121;
          |HAZ LeeConcepto;
          n121Pre = nNume;
          |SI #0#4 = "H"; |O #0#4 = "T";    || desde historico, busco a¤o
               nRet121Pre = (n121Pre % #100#106) ! 2;
          |SINO;
               nRet121Pre = (n121Pre % #100#67) ! 2;
          |FINSI;
          |SI nLinea ! nTotLineas;
               nRet121Pre = nRet121Pre * nCoefi;
               nRet121Pre = nRet121Pre ! 2;
               nTotRet121Pre = nTotRet121Pre + nRet121Pre;
          |SINO;
               nAcumRet121Pre = nAcumRet121Pre + nRet121Pre;
               nRet121Pre = nRet121Pre - nTotRet121Pre;
          |FINSI;
     |FINSI;

     nReten = nReten - nRet121Pre;
     |SI nLinea ! nTotLineas;
          nReten = nReten * nCoefi;
          nReten = nReten ! 2;
          nTotReten = nTotReten + nReten;
     |SINO;
          nAcumRet = nAcumRet + nReten;
          nReten = nReten - nTotReten;
     |FINSI;
     aDato = nReten;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || Retencion IRPF

     nExento = 0;
     |PARA nConcepto = 401; |SI nConcepto [ 410; |HACIENDO nConcepto = nConcepto + 1;
          |HAZ LeeConcepto;
          nExento = nExento + nNume;
     |SIGUE;

     |SI nLinea ! nTotLineas;
          nExento = nExento * nCoefi;
          nExento = nExento ! 2;
          nTotExento = nTotExento + nExento;
     |SINO;
          nAcumEx1 = nAcumEx1 + nExento;
          nExento = nExento - nTotExento;
     |FINSI;
     aDato = nExento;
     |SI aTipo = "PAGA EXTRA  "; aDato = "0"; |FINSI;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || Importe Dietas: Bases Exentas

     nSSTra = #100#48 + #100#49;
     |SI nLinea ! nTotLineas;
          nSSTra = nSSTra * nCoefi;
          nSSTra = nSSTra ! 2;
          nTotSSTra = nTotSSTra + nSSTra;
     |SINO;
          nAcumSST = nAcumSST + nSSTra;
          nSSTra = nSSTra - nTotSSTra;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  "; nSSTra = 0; |FINSI;
     aDato = nSSTra;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || SS Trabajador

     nSSEmp = #100#45;
     |SI nLinea ! nTotLineas;
          nSSEmp = nSSEmp * nCoefi;
          nSSEmp = nSSEmp ! 2;
          nTotSSEmp = nTotSSEmp + nSSEmp;
     |SINO;
          nAcumSSE = nAcumSSE + nSSEmp;
          nSSEmp = nSSEmp - nTotSSEmp;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  "; nSSEmp = 0; |FINSI;
     aDato = nSSEmp;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || SS EMPRESA

     |XGRABA nCanal, aLinea;
     aLinea = "";             || por la limitacion a 255 caracteres de
                              || nuestras variables alfanumericas

     taporta = #100#48 + #100#49;
     taporta = taporta + #100#50 + #100#51;   || total aportacion
     tantici = #100#52 + #100#53;             || anticipos
     |SI #0#4 = "M"; |O #0#4 = "A";
          tantici = tantici + #100#89;   || anticipos 3
     |SINO;
          tantici = tantici + #100#131;   || anticipos 3
     |FINSI;
     deducir = taporta + tantici;
     |SI #0#4 = "M"; |O #0#4 = "A";
          deducir = deducir + #100#75 + #100#54;  || total deducir
     |SINO;
          deducir = deducir + #100#114 + #100#54;  || total deducir
     |FINSI;

     |SI aTipo = "PAGA EXTRA  ";
          nNeto = #100#16 - #100#17;
     |FINSI;
     |SI aTipo = "NORMAL      ";
          nNeto = #100#46 - deducir;
     |FINSI;
     |SI aTipo = "FINIQUITO   ";
          nNeto = #100#46 - deducir;
     |FINSI;
     |SI nLinea ! nTotLineas;
          nNeto = nNeto * nCoefi;
          nNeto = nNeto ! 2;
          nTotNeto = nTotNeto + nNeto;
     |SINO;
          nAcumNet = nAcumNet + nNeto;
          nNeto = nNeto - nTotNeto;
     |FINSI;
     aDato = nNeto;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || NETO

     nConcepto = 906;
     |HAZ LeeConcepto;
     n906 = nNume;
     |SI nLinea ! nTotLineas;
          n906 = n906 * nCoefi;
          n906 = n906 ! 2;
          nTot906 = nTot906 + n906;
     |SINO;
          nAcum906 = nAcum906 + n906;
          n906 = n906 - nTot906;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  "; n906 = 0; |FINSI;
     aDato = n906
     nCar = 20; aTip = "D";    |HAZ Formatea;     || El 906

     nConcepto = 414;
     |HAZ LeeConcepto;
     n414 = nNume;
     |SI nLinea ! nTotLineas;
          n414 = n414 * nCoefi;
          n414 = n414 ! 2;
          nTot414 = nTot414 + n414;
     |SINO;
          nAcum414 = nAcum414 + n414;
          n414 = n414 - nTot414;
     |FINSI;
     aDato = n414;                          || INDEMNIZACION (BASE EXENTA)
     |SI swFiniquito = 0; |O aTipo = "PAGA EXTRA  ";
          aDato = "0";
     |FINSI;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || El 414

     nConcepto = 418;
     |HAZ LeeConcepto;
     n418 = nNume;
     |SI nLinea ! nTotLineas;
          n418 = n418 * nCoefi;
          n418 = n418 ! 2;
          nTot418 = nTot418 + n418;
     |SINO;
          nAcum418 = nAcum418 + n418;
          n418 = n418 - nTot418;
     |FINSI;
     aDato = n418;                          || INDEMNIZACION (BASE EXENTA)
     |SI swFiniquito = 0; |O aTipo = "PAGA EXTRA  ";
          aDato = "0";
     |FINSI;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || El 418

     nExentoFin = 0;
     |PARA nConcepto = 411; |SI nConcepto [ 420; |HACIENDO nConcepto = nConcepto + 1;
          |HAZ LeeConcepto;
          |SI nConcepto ! 414; |Y nConcepto ! 418;
               nExentoFin = nExentoFin + nNume;
          |FINSI;
     |SIGUE;
     |SI nLinea ! nTotLineas;
          nExentoFin = nExentoFin * nCoefi;
          nExentoFin = nExentoFin ! 2;
          nTotExentoFin = nTotExentoFin + nExentoFin;
     |SINO;
          nAcum4XX = nAcum4XX + nExentoFin;
          nExentoFin = nExentoFin - nTotExentoFin;
     |FINSI;
     aDato = nExentoFin;
     |SI aTipo = "PAGA EXTRA  ";
          aDato = "0";
     |FINSI;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || Importe Dietas: Bases Exentas

     nConcepto = 907;
     |HAZ LeeConcepto;
     n907 = nNume;
     |SI nLinea ! nTotLineas;
          n907 = n907 * nCoefi;
          n907 = n907 ! 2;
          nTot907 = nTot907 + n907;
     |SINO;
          nAcum907 = nAcum907 + n907;
          n907 = n907 - nTot907;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  "; n907 = 0; |FINSI;
     aDato = n907;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || El 907

     nConcepto = 908;
     |HAZ LeeConcepto;
     n908 = nNume;
     |SI nLinea ! nTotLineas;
          n908 = n908 * nCoefi;
          n908 = n908 ! 2;
          nTot908 = nTot908 + n908;
     |SINO;
          nAcum908 = nAcum908 + n908;
          n908 = n908 - nTot908;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  "; n908 = "0"; |FINSI;
     aDato = n908;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || El 908

     nPresSS = #100#57 + #100#58;
     |SI nLinea ! nTotLineas;
          nPresSS = nPresSS * nCoefi;
          nPresSS = nPresSS ! 2;
          nTotPresSS = nTotPresSS + nPresSS;
     |SINO;
          nAcumPSS = nAcumPSS + nPresSS;
          nPresSS = nPresSS - nTotPresSS;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  "; nPresSS = 0; |FINSI;
     aDato = nPresSS;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || PRESTACION A CARGO DE SS

     nConcepto = 201;
     |HAZ LeeConcepto;
     n201 = nNume;
     |SI nLinea ! nTotLineas;
          n201 = n201 * nCoefi;
          n201 = n201 ! 2;
          nTot201 = nTot201 + n201;
     |SINO;
          nAcum201 = nAcum201 + n201;
          n201 = n201 - nTot201;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  "; n201 = 0; |FINSI;
     aDato = n201;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || prorrata paga Junio

     nConcepto = 202;
     |HAZ LeeConcepto;
     n202 = nNume;
     |SI nLinea ! nTotLineas;
          n202 = n202 * nCoefi;
          n202 = n202 ! 2;
          nTot202 = nTot202 + n202;
     |SINO;
          nAcum202 = nAcum202 + n202;
          n202 = n202 - nTot202;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  "; n202 = 0; |FINSI;
     aDato = n202;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || prorrata paga Octubre

     nConcepto = 203;
     |HAZ LeeConcepto;
     n203 = nNume;
     |SI nLinea ! nTotLineas;
          n203 = n203 * nCoefi;
          n203 = n203 ! 2;
          nTot203 = nTot203 + n203;
     |SINO;
          nAcum203 = nAcum203 + n203;
          n203 = n203 - nTot203;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  "; n203 = 0; |FINSI;
     aDato = n203;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || prorrata paga Diciembre

     |XGRABA nCanal, aLinea;
     aLinea = "";             || por la limitacion a 255 caracteres de
                              || nuestras variables alfanumericas

     nConcepto = 204;
     |HAZ LeeConcepto;
     n204 = nNume;
     |SI nLinea ! nTotLineas;
          n204 = n204 * nCoefi;
          n204 = n204 ! 2;
          nTot204 = nTot204 + n204;
     |SINO;
          nAcum204 = nAcum204 + n204;
          n204 = n204 - nTot204;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  "; n204 = 0; |FINSI;
     aDato = n204;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || prorrata paga Diciembre

     nConcepto = 201;
     swBuscoPro = 1;
     |HAZ LeeConcepto;
     aDato = #nomconca#nConcepto#;
     ||SI aDato = "99";   |ACABA;   |FINSI;
     nCar = 2; aTip = "N";    |HAZ Formatea;     || mes pago paga Junio

     nConcepto = 202;
     swBuscoPro = 1;
     |HAZ LeeConcepto;
     aDato = #nomconca#nConcepto#;
     ||SI aDato = "99";   |ACABA;   |FINSI;
     nCar = 2; aTip = "N";    |HAZ Formatea;     || mes pago paga Octubre

     nConcepto = 203;
     swBuscoPro = 1;
     |HAZ LeeConcepto;
     aDato = #nomconca#nConcepto#;
     ||SI aDato = "99";   |ACABA;   |FINSI;
     nCar = 2; aTip = "N";    |HAZ Formatea;     || mes pago paga Diciembre

     nConcepto = 204;
     swBuscoPro = 1;
     |HAZ LeeConcepto;
     aDato = #nomconca#nConcepto#;
     ||SI aDato = "99";   |ACABA;   |FINSI;
     nCar = 2; aTip = "N";    |HAZ Formatea;     || mes pago paga Diciembre

     nConcepto = 201;                   || acumulados de cada paga
     |HAZ BuscaAcumPaga;                  || solo en finiquito
     nA201 = nNume;
     |SI nLinea ! nTotLineas;
          nA201 = nA201 * nCoefi;
          nA201 = nA201 ! 2;
          nTotA201 = nTotA201 + nA201;
     |SINO;
          nAcumA201 = nAcumA201 + nA201;
          nA201 = nA201 - nTotA201;
     |FINSI;
     |SI aTipo ! "FINIQUITO   "; nA201 = 0; nAcumA201 = 0; |FINSI;
     aDato = nA201;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || prorrata paga Junio

     nConcepto = 202;
     |HAZ BuscaAcumPaga;                  || solo en finiquito
     nA202 = nNume;
     |SI nLinea ! nTotLineas;
          nA202 = nA202 * nCoefi;
          nA202 = nA202 ! 2;
          nTotA202 = nTotA202 + nA202;
     |SINO;
          nAcumA202 = nAcumA202 + nA202;
          nA202 = nA202 - nTotA202;
     |FINSI;
     |SI aTipo ! "FINIQUITO   "; nA202 = 0; nAcumA202 = 0; |FINSI;
     aDato = nA202;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || prorrata paga Junio

     nConcepto = 203;
     |HAZ BuscaAcumPaga;                  || solo en finiquito
     nA203 = nNume;
     |SI nLinea ! nTotLineas;
          nA203 = nA203 * nCoefi;
          nA203 = nA203 ! 2;
          nTotA203 = nTotA203 + nA203;
     |SINO;
          nAcumA203 = nAcumA203 + nA203;
          nA203 = nA203 - nTotA203;
     |FINSI;
     |SI aTipo ! "FINIQUITO   "; nA203 = 0; nAcumA203 = 0; |FINSI;
     aDato = nA203;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || prorrata paga Junio

     nConcepto = 204;
     |HAZ BuscaAcumPaga;                  || solo en finiquito
     nA204 = nNume;
     |SI nLinea ! nTotLineas;
          nA204 = nA204 * nCoefi;
          nA204 = nA204 ! 2;
          nTotA204 = nTotA204 + nA204;
     |SINO;
          nAcumA204 = nAcumA204 + nA204;
          nA204 = nA204 - nTotA204;
     |FINSI;
     |SI aTipo ! "FINIQUITO   "; nA204 = 0; nAcumA204 = 0; |FINSI;
     aDato = nA204;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || prorrata paga Junio

     |XGRABA nCanal, aLinea;
     aLinea = "";             || por la limitacion a 255 caracteres de
                              || nuestras variables alfanumericas
     swBuscoPro = 0;
     nConcepto = 121;
     |HAZ LeeConcepto;
     n121 = nNume;
     |SI nLinea ! nTotLineas;
          n121 = n121 * nCoefi;
          n121 = n121 ! 2;
          nTot121 = nTot121 + n121;
     |SINO;
          nAcum121 = nAcum121 + n121;
          n121 = n121 - nTot121;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  "; n121 = "0"; |FINSI;
     aDato = n121;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || El 121

     nConcepto = 121;
     |HAZ LeeConcepto;
     n121 = nNume;
     |SI #0#4 = "H"; |O #0#4 = "T";    || desde historico, busco a¤o
          nRet121 = (n121 % #100#106) ! 2;
     |SINO;
          nRet121 = (n121 % #100#67) ! 2;
     |FINSI;
     |SI nLinea ! nTotLineas;
          nRet121 = nRet121 * nCoefi;
          nRet121 = nRet121 ! 2;
          nTotRet121 = nTotRet121 + nRet121;
     |SINO;
          nAcumRet121 = nAcumRet121 + nRet121;
          nRet121 = nRet121 - nTotRet121;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  "; nRet121 = "0"; |FINSI;
     aDato = nRet121;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || retencion aplicada al 121

     nConcepto = 926;
     |HAZ LeeConcepto;
     n926 = nNume;
     |SI nLinea ! nTotLineas;
          n926 = n926 * nCoefi;
          n926 = n926 ! 2;
          nTot926 = nTot926 + n926;
     |SINO;
          nAcum926 = nAcum926 + n926;
          n926 = n926 - nTot926;
     |FINSI;
     |SI aTipo = "PAGA EXTRA  "; n926 = "0"; |FINSI;
     aDato = n926;
     nCar = 20; aTip = "D";    |HAZ Formatea;     || El 926

     || FINAL

     aLinea = aLinea + &13 + &10;
     |XGRABA nCanal, aLinea;
     |HAZ Registro;
     nGenerados = nGenerados + 1;
|FPRC;

|PROCESO Cuenta;
     nTotTrabEmp = nTotTrabEmp + 1;
     nTotLineas = nTotLineas + 1;
|FPRC;

|PROCESO Cabecera;
     |SI #0#57 ! "S";
          |ACABA;
     |FINSI;

     aLinea = "";

     aDato = "EMPR.";               || Empresa
     nCar = 5; aTip = "A";    |HAZ Formatea;

     aDato = "CE";
     nCar = 2; aTip = "A";    |HAZ Formatea;

     aDato = "AR";
     nCar = 2; aTip = "A";    |HAZ Formatea;

     aDato = "SE";
     nCar = 2; aTip = "A";    |HAZ Formatea;

     aDato = "TRAB.";                         || Trabajador
     nCar = 5; aTip = "N";    |HAZ Formatea;

     aDato = "NIF";                    || NIF
     nCar = 12; aTip = "A";    |HAZ Formatea;

     aDato = "NOMBRE";                    || NOMBRE TRABAJADOR
     nCar = 40; aTip = "A";    |HAZ Formatea;

     aDato = "FECHA INI.";           || INICIO PERIODO
     nCar = 10; aTip = "A";    |HAZ Formatea;

     aDato = "FECHA FIN";           || FIN PERIODO
     nCar = 10; aTip = "A";    |HAZ Formatea;

     aDato = "TIPO";                || Id. Tipo de Nomina
     nCar = 12; aTip = "A";    |HAZ Formatea;

     aDato ="BRUTO";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || BRUTO

     aDato = "BASE IRPF";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || BRUTO

     aDato = "RETENCION";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || Retencion IRPF

     aDato = "EXENTO (401-410)";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || Importe Dietas: Bases Exentas

     aDato = "S.S. TRABAJADOR";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || SS Trabajador

     |XGRABA nCanal, aLinea;
     aLinea = "";             || por la limitacion a 255 caracteres de
                              || nuestras variables alfanumericas
     aDato = "S.S. EMPRESA";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || SS Trabajador

     aDato = "NETO";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || NETO

     aDato = "EL 906";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || El 906

     aDato = "EXENTA (414)";      || INDEMNIZACION (BASE EXENTA)
     nCar = 20; aTip = "A";    |HAZ Formatea;     || El 414

     aDato = "EXENTA (418)";      || INDEMNIZACION (BASE EXENTA)
     nCar = 20; aTip = "A";    |HAZ Formatea;     || El 418

     aDato = "EXENTA (RESTO 4XX)";      || INDEMNIZACION (BASE EXENTA)
     nCar = 20; aTip = "A";    |HAZ Formatea;     || El 414

     aDato = "EL 907";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || El 907

     aDato = "EL 908";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || El 908

     aDato = "PRES. SS. ACC/ENF";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || PRESTACION A CARGO DE SS

     |XGRABA nCanal, aLinea;
     aLinea = "";             || por la limitacion a 255 caracteres de
                              || nuestras variables alfanumericas
     aDato = "PRORR. PAGA 201";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || prorrata paga Junio

     aDato = "PRORR. PAGA 202";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || prorrata paga Diciembre

     aDato = "PRORR. PAGA 203";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || prorrata paga Octubre

     aDato = "PRORR. PAGA 204";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || prorrata paga Octubre 2

     aDato = "M1";
     nCar = 2; aTip = "A";    |HAZ Formatea;     || mes pago paga Junio

     aDato = "M2";
     nCar = 2; aTip = "A";    |HAZ Formatea;     || mes pago paga Octubre

     aDato = "M3";
     nCar = 2; aTip = "A";    |HAZ Formatea;     || mes pago paga Diciembre

     aDato = "M4";
     nCar = 2; aTip = "A";    |HAZ Formatea;     || mes pago paga Diciembre

     aDato = "ACUM. PAGA 201";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || acumulado paga Junio

     aDato = "ACUM. PAGA 202";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || acumulado paga Diciembre

     aDato = "ACUM. PAGA 203";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || acumulado paga Octubre

     aDato = "ACUM. PAGA 204";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || acumulado paga Octubre 2

     aDato = "PLUS MANUTENCION";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || acumulado paga Octubre 2

     aDato = "RET. PLUS MANUT.";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || acumulado paga Octubre 2

     aDato = "ANTICIPO 926";
     nCar = 20; aTip = "A";    |HAZ Formatea;     || acumulado paga Octubre 2

     aLinea = aLinea + &13 + &10;
     |XGRABA nCanal, aLinea;
|FPRC;

|PROCESO BorraRegistro;
     |BORRA 020#hotm0054.a;
|FPRC;

|DEFBUCLE BorraRegistro;
     #hotm0054#2;
     ;
     aFichero;
     aFichero;
     be;
     NULL, BorraRegistro;
|FIN;

|PROCESO Inicializa;
     nTotLineas = 0;
     nLinea = 0;
     swGeneral = 0
     swMensual = 1;
     nCoefi = 0;
     nBruto = 0;
     nNeto = 0;
     nBaseIRPF = 0;
     nReten = 0;
     nSSTra = 0;
     nSSEmp = 0;
     nPresSS = 0;
     nExento = 0;
     nExentoFin = 0;
     n414 = 0;
     n418 = 0;
     n906 = 0;
     n907 = 0;
     n908 = 0;
     n201 = 0;
     n202 = 0;
     n203 = 0;
     n204 = 0;
     nA201 = 0;
     nA202 = 0;
     nA203 = 0;
     nA204 = 0;
     n926 = 0;
     n121 = 0;
     nRet121 = 0;
     n121Pre = 0;
     nRet121Pre = 0;
     nTotBruto = 0;
     nTotNeto = 0;
     nTotReten = 0;
     nTotBaseIRPF = 0;
     nTotSSEmp = 0;
     nTotSSTra = 0;
     nTotPresSS = 0;
     nTotExento = 0;
     nTotExentoFin = 0;
     nTot414 = 0;
     nTot418 = 0;
     nTot906 = 0;
     nTot907 = 0;
     nTot908 = 0;
     nTot201 = 0;
     nTot202 = 0;
     nTot203 = 0;
     nTot204 = 0;
     nTotA201 = 0;
     nTotA202 = 0;
     nTotA203 = 0;
     nTotA204 = 0;
     nTot926 = 0;
     nTot121 = 0;
     nTot121Pre = 0;
     nTotRet121 = 0;
     nTotRet121Pre = 0;
|FPRC;

|PROCESO InicializaTot;
     nAcumBru = 0;
     nAcumBas = 0;
     nAcumRet = 0;
     nAcumEx1 = 0;
     nAcumSST = 0;
     nAcumSSE = 0;
     nAcumPSS = 0;
     nAcumNet = 0;
     nAcum906 = 0;
     nAcum414 = 0;
     nAcum418 = 0;
     nAcum4XX = 0;
     nAcum907 = 0;
     nAcum908 = 0;
     nAcum201 = 0;
     nAcum202 = 0;
     nAcum203 = 0;
     nAcum204 = 0;
     nAcumA201 = 0;
     nAcumA202 = 0;
     nAcumA203 = 0;
     nAcumA204 = 0;
     nAcum926 = 0;
     nAcum121 = 0;
     nAcum121Pre = 0;
     nAcumRet121 = 0;
     nAcumRet121Pre = 0;
     aError = "";
     nTotTrabEmp = 0;
|FPRC;

|PROCESO Centros;
     |SI swPorEmpresa = 1;
          |SI #100#0 ! nEmpAnt;
               |SI swElPrimero ! 1;
                    |XCIERRA nCanal;
                    |SI aError ! ""; |O nTotTrabEmp = 0;
                         |FBORRA aPath;
                         |SI aError ! "";
                              aAlfa = "    ATENCION: No se ha encontrado la equivalencia para " + aError;
                              |MENAV aAlfa;
                              |BUCLE BorraRegistro;
                         |FINSI;
                    |SINO;
                         |PIEINF;
                    |FINSI;
               |FINSI;

               nGenerados = 0;
               nNoGenerados = 0;
               nRepetidos = 0;
               |HAZ Fichero;
               |XABRE "CWB", aPath, nCanal;
               |HAZ Cabecera;
               |HAZ InicializaTot;
               swElPrimero = 0;
          |FINSI;
     |FINSI;

     |HAZ Inicializa;
     #hotm0009#0 = #100#0;         || empresa
     #hotm0009#1 = #100#1;         || trabajador
     #hotm0009#2 = #0#7;           || a¤o
     #hotm0009#3 = #100#2;         || mes
     |LEE 000#hotm0009.=;
     |SI FSalida = 0;
          swMensual = 1;
          |BUCLELIN 2Cuenta#9;
          |BUCLELIN 2Lineas#9;
     |SINO;
          #hotm0012#0 = #100#0;         || empresa
          #hotm0012#1 = #100#1;         || trabajador
          |LEE 000#hotm0012.=;
          |SI FSalida = 0;
               swMensual = 0;
               |BUCLELIN 2Cuenta#12;
               |BUCLELIN 2Lineas#12;
          |FINSI;
     |FINSI;

     nEmpAnt = #100#0;
|FPRC;

|DEFBUCLE historico;
     #100#1005;
     ;
     #0#0, #0#2, nAnyHis, nDesdeMes, nDesdeTipo;
     #0#1, #0#3, nAnyHis, nHastaMes, nHastaTipo;
     ;
     NULL, Centros;
|FIN;

|DEFBUCLE mensual;
     #100#1004;
     ;
     #0#0, #0#2, nDesdeMes, nDesdeTipo;
     #0#1, #0#3, nHastaMes, nHastaTipo;
     ;
     NULL, Centros;
|FIN;

|PROCESO ElProceso;
     nDesdeMes = #0#6;
     |SI #0#4 = "A"; |O #0#4 = "T";
          nHastaMes = #0#58;
     |SINO;
          nHastaMes = nDesdeMes;
     |FINSI;

     |SI swParrilla = 0;   || DESDE / HASTA
          |SI #0#4 = "M"; |O #0#4 = "A";
               swElPrimero = 1;
               |BUCLE mensual;         || normales mensual/atrasos
               |SI swPorEmpresa = 1;
                    |XCIERRA nCanal;

                    |SI aError ! ""; |O nTotTrabEmp = 0;
                         |FBORRA aPath;
                         |SI aError ! "";
                              aAlfa = "    ATENCION: No se ha encontrado la equivalencia para " + aError;
                              |MENAV aAlfa;
                              |BUCLE BorraRegistro;
                         |FINSI;
                    |SINO;
                         |PIEINF;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI #0#4 = "H"; |O #0#4 = "T";
               swElPrimero = 1;
               nDesdeMes =
               |BUCLE historico;         || normales mensual/atrasos
               |SI swPorEmpresa = 1;
                    |XCIERRA nCanal;
                    |SI aError ! ""; |O nTotTrabEmp = 0;
                         |FBORRA aPath;
                         |SI aError ! "";
                              aAlfa = "    ATENCION: No se ha encontrado la equivalencia para " + aError;
                              |MENAV aAlfa;
                              |BUCLE BorraRegistro;
                         |FINSI;
                    |SINO;
                         |PIEINF;
                    |FINSI;
               |FINSI;
          |FINSI;
          |SI aError ! "";
               aAlfa = "    ATENCION: No se ha encontrado la equivalencia para " + aError;
               |MENAV aAlfa;
               |BUCLE BorraRegistro;
          |FINSI;
     |SINO;              || PARRILLA
          |HAZ Cabecera;
          |PARA nCampoE = 13; |SI nCampoE [ 30; |Y aError = ""; |HACIENDO nCampoE = nCampoE + 1;
               |SI #0nCampoE ! 0;
                    |PARA nMesCalculo = nDesdeMes;
                    |SI nMesCalculo [ nHastaMes;
                    |HACIENDO nMesCalculo = nMesCalculo + 1;
                         nCampoT = nCampoE + 21;
                         #100#0 = #0nCampoE;
                         #100#1 = #0nCampoT;
                         #100#2 = nMesCalculo;
                         #100#3 = nDesdeTipo;
                         |SI #0#4 = "H"; |O #0#4 = "T";         || Historico
                              #100#66 = nAnyHis;
                         |FINSI;
                         |LEE 000#100=;
                         |SI FSalida = 0;
                              |HAZ Centros;
                              |SI aError ! "";
                                   aAlfa = "    ATENCION: No se ha encontrado la equivalencia para " + aError;
                                   |MENAV aAlfa;
                                   |BUCLE BorraRegistro;
                                   |ERROR10;
                              |FINSI;
                         |FINSI;
                    |SIGUE;
               |FINSI;
          |SIGUE;
     |FINSI;
|FPRC;

|PROCESO GeneraFichero;
     nGenerados = 0;
     nNoGenerados = 0;
     nRepetidos = 0;

     |SI #0#13 = 0;      || DESDE / HASTA
          swParrilla = 0;          || seleccion desde/hasta
          swPorEmpresa = 1;        || SE HACE POR EMPRESA
     |SINO;              || PARRILLA
          swParrilla = 1;          || seleccion parrilla
          swPorEmpresa = 0;        || se hacen todos juntos, no por empresa
     |FINSI;

     |SI #0#9 = "X";
          swPorEmpresa = 0;        || NO SE HACE POR EMPRESA si es FINIQUITO
     |FINSI;

     |IMPRE 0;
     |SI FSalida = 0;
          |INFOR "hotm0054";

          |SI swPorEmpresa = 0;
               |HAZ Fichero;
               |XABRE "CWB", aPath, nCanal;
          |FINSI;
          nAnyHis = #0#7 - 2000;

          |SI #0#8 = "X";
               aTipo = "NORMAL      ";
               |HAZ ElProceso;
          |FINSI;
          |SI #0#10 = "X";
               aTipo = "PAGA EXTRA  ";
               |HAZ ElProceso;
          |FINSI;
          |SI #0#9 = "X";
               aTipo = "FINIQUITO   ";
               |HAZ ElProceso;
          |FINSI;

          |SI swPorEmpresa = 0;
               |XCIERRA nCanal;

               |SI aError ! "";
                    |FBORRA aPath;
                    |ACABA;
               |FINSI;

               |PIEINF;

               |FININF;
          |FINSI;
     |FINSI;
     |FINIMP;
|FPRC;

|PROCESO tipo3; |TIPO 3;
     |SI #0#11 ! "S";
          |ACABA;
     |FINSI;
     |ABRE #nomconca;
     |ABRE #labtraba;
     |ABRE #hotm0009;
     |ABRE #hotm0010;
     |ABRE #hotm0012;
     |ABRE #hotm0013;
     |ABRE #hotm0054;
     |ABRE #hotm0060;
     |ABRE #hotm0061;
     |ABRE #hotm0062;

     |DDEF aDef;

     |SI #0#4 = "M"; |O #0#4 = "H";     || desde el mensual/historico
          nDesdeTipo = 0;
          nHastaTipo = 0;
     |FINSI;

     |SI #0#4 = "A";                    || desde atrasos
          nDesdeTipo = 5;
          nHastaTipo = 5;
     |FINSI;

     |SI #0#4 = "T";                    || desde atrasos historico
          nDesdeTipo = #0#59;
          nHastaTipo = #0#59;
     |FINSI;

     |SI #0#4 = "M";      || desde el mensual
          aElDef = aDef + "nomcalca";
          |CARGA_DEF aElDef, copiacab@;
          aElDef = aDef + "nomcalli";
          |CARGA_DEF aElDef, copialin@;
          |ABRE #100;
          |ABRE #101;

          |HAZ GeneraFichero;

          |CIERRA #101;
          |CIERRA #100;
          |DESCARGA_DEF #copialin@;
          |DESCARGA_DEF #copiacab@;
     |FINSI;

     |SI #0#4 = "H"; |O #0#4 = "T";    || desde el historico
          aElDef = aDef + "nomhicca";
          |CARGA_DEF aElDef, copiacab@;
          aElDef = aDef + "nomhicli";
          |CARGA_DEF aElDef, copialin@;
          |ABRE #100;
          |ABRE #101;

          |HAZ GeneraFichero;

          |CIERRA #101;
          |CIERRA #100;
          |DESCARGA_DEF #copialin@;
          |DESCARGA_DEF #copiacab@;
     |FINSI;

     |SI #0#4 = "A";     || desde atrasos
          aElDef = aDef + "nomcalac";
          |CARGA_DEF aElDef, copiacab@;
          aElDef = aDef + "nomcalal";
          |CARGA_DEF aElDef, copialin@;
          |ABRE #100;
          |ABRE #101;

          |HAZ GeneraFichero;

          |CIERRA #101;
          |CIERRA #100;
          |DESCARGA_DEF #copialin@;
          |DESCARGA_DEF #copiacab@;
     |FINSI;

     |CIERRA #hotm0062;
     |CIERRA #hotm0061;
     |CIERRA #hotm0060;
     |CIERRA #hotm0054;
     |CIERRA #hotm0013;
     |CIERRA #hotm0012;
     |CIERRA #hotm0010;
     |CIERRA #hotm0009;
     |CIERRA #labtraba;
     |CIERRA #nomconca;
|FPRC;

|PROGRAMA;
     |CLS;
     |ABRE #0;
     #0#56 = 1;
     |LEE 101#0=;
     |SI FSalida ! 0;
          |GRABA 020#0.n;
     |FINSI;

     |PINPA #0#0;
     |PINDA #0#0;
     |ENDATOS #1#0;
     |SI FSalida = 0;
          |GRABA 020#0.a;
          |HAZ tipo3;
     |FINSI;
     |CIERRA #0;
|FPRO;
