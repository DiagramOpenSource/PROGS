|| PLB para temas de Web.
|| Temas de JSON
||

|FICHEROS;
     referen@ #1000;

||     visalm05 #5;
|FIN;

|VARIABLES;
     nValor              = 0;
     nNumCampos          = 0;
     nLong               = 0;
     nConta              = 0;
     nCampo              = 0;
     nVoy                = 0;
     nLen                = 0;
     nCampos             = 0;
     nPos                = 0;
     nHandle             = 0;
     nVoyLinea           = 0;
     nEstoy              = 0;
     nUltimo             = 0;

     aMensaje            = "";
     aFic                = "";
     aHora               = "";
     aFecha              = "";
     aLong               = "";
     aSaca               = "";
     aCaracter           = "";
     aAlfa               = "";
     aTextoUtf8          = "";
     aCadena             = "";
     aLen                = "";
     aCaracRaro          = "";
     aValor              = "";
     aCom                = "";
     aLinea              = "";
     aParametro          = "";
     aTab                = "";
     aCadena1            = "";
     aCadena2            = "";
     aCampo              = "";
     aResultado          = "";
     aNomDat             = "";
     aNomDic             = "";
     aNomDef             = "";
     aBase               = "";
     aMas                = "";

     fFecha              = @;

     &eaClavePLB         = "";
     &eaValorPLB         = "";
     &eaLineaPLB         = "";
     &eaFicheroLog       = "";
     &eaTextoLog         = "";

     &eaTextoMeteTres    = "";
     &eaTextoMeteDos     = "";
     &eaTextoMete        = "";
     &eaFicJson          = "";
     &eaNombreJson       = "";
     &eaTextoJson        = "";
     &enSwInicializaJson = 0;
     &enVoyPrimeroRegDic = 0;
     &eaNomDicJson       = "";

     &eaNomeDatUno       = "";
     &enNumCamposUno     = 0;
     &eaNomDicUno        = "";
     &eaNomDefUno        = "";

     &enHandleJson       = 0;
     &eaAlfaJson         = "";
     &eaEJsn             = "";
     &eaTJsn             = "";
     &eaSJsn             = "";
     &enNTab             = 0;
|FIN;

|PROCESO ConvierteUTF8;
     ||Se basa en los famosos quitararos

     ||e acentuada es \u00e9

     aAlfa = aTextoUtf8;
     |QBF aAlfa;

     aCadena = "";
     aLen    = aAlfa % 0;
     nLen    = aLen;
     |PARA nCampos = 1;  |SI nCampos [ nLen;  |HACIENDO nCampos = nCampos + 1;
          nPos       = (100 * nCampos) + 1;
          aCaracRaro = aAlfa % nPos;

          nValor = &aCaracRaro;

          |SI nValor > 127;
               aValor = "";
               |SI nValor = "164"; aValor = "\u00f1"; |FINSI;    || eny
               |SI nValor = "165"; aValor = "\u00d1"; |FINSI;    || ENYE
               |SI nValor = "209"; aValor = "\u00d1"; |FINSI;    || ENYE

               |SI nValor = "160"; aValor = "\u00e1"; |FINSI;    || a acento
               |SI nValor = "130"; aValor = "\u00e9"; |FINSI;    || e acento
               |SI nValor = "161"; aValor = "\u00ed"; |FINSI;    || i acento
               |SI nValor = "162"; aValor = "\u00f3"; |FINSI;    || o acento
               |SI nValor = "163"; aValor = "\u00fa"; |FINSI;    || u acento

               |SI nValor = "133"; aValor = "\u00e0"; |FINSI;    || a acento cerrado
               |SI nValor = "149"; aValor = "\u00f2"; |FINSI;    || o acento cerrado

               |SI nValor = "135"; aValor = "\u00e7"; |FINSI;    || c cedilla
               |SI nValor = "128"; aValor = "\u00c7"; |FINSI;    || C cedilla

               |SI nValor = "166"; aValor = "\u00aa"; |FINSI;    || ordinar femenino
               |SI nValor = "170"; aValor = "\u00aa"; |FINSI;    || ordinar femenino
               |SI nValor = "167"; aValor = "\u00ba"; |FINSI;    || ordinar maculino

               |SI nValor = "129"; aValor = "\u00fc"; |FINSI;    || u con dieresis
               |SI nValor = "154"; aValor = "\u00dc"; |FINSI;    || U con dieresis

               |SI nValor = "181"; aValor = "\u00c1"; |FINSI;    || A acento
               |SI nValor = "144"; aValor = "\u00c9"; |FINSI;    || E acento
               |SI nValor = "214"; aValor = "\u00cd"; |FINSI;    || I acento
               |SI nValor = "224"; aValor = "\u00d3"; |FINSI;    || O acento
               |SI nValor = "233"; aValor = "\u00da"; |FINSI;    || U acento

               |SI aValor = "";
                   aValor = "(" + nValor + ") ";
                   || aCadena = aCadena + aCaracRaro + aValor;
                   || De esta forma no petara, e incluso se puede controlar desde python.
                   aCadena = aCadena + aValor;
               |SINO;
                   aCadena = aCadena + aValor;
               |FINSI;
          |SINO;
               aCadena = aCadena + aCaracRaro;
          |FINSI;
     |SIGUE;
     aTextoUtf8 = aCadena;
|FPRC;

|PROCESO VuelcaDatosJson;
     aLinea = aTab + &34 + aNomDic + &34 + ": [";
     |XGRABA nHandle, aLinea;

     aMas = aBase + "def/" + aNomDef;
     |CARGA_DEF aMas, referen@;
     |SI FSalida ! 0;
          |SI aResultado = "";
               aResultado = "Error: Carga_def del " + aNomDef;
          |SINO;
               aResultado = aResultado + " Carga_def del " + aNomDef;
          |FINSI;
     |SINO;
          |SI aNomDat ! "";
               |NOME_DAT #referen@#aNomDat#;
          |FINSI;

          nVoyLinea = 0;
          |ABRE #referen@;
          |LEE 000#referen@.p;
          |PARA; |SI FSalida = 0; |HACIENDO;
               nVoyLinea = nVoyLinea + 1;
               |SI nVoyLinea ! 1;
                    aLinea = aTab + aTab + ",";
                    |XGRABA nHandle, aLinea;
               |FINSI;

               aLinea = aTab + aTab + "{";
               |XGRABA nHandle, aLinea;

               |PARA nEstoy = 1; |SI nEstoy < nNumCampos; |HACIENDO nEstoy = nEstoy + 1;
                    aCampo = "C" + (("000" + nEstoy) % -103);

                    aTextoUtf8 = #referen@#nEstoy#;
                    |QBF aTextoUtf8;
                    |SI aTextoUtf8 ! "";
                         |HAZ ConvierteUTF8;
                    |FINSI;
                    aLinea = aTab + aTab + aTab + &34 + aCampo + &34 + ":" + &34 + aTextoUtf8;
                    |QBF aLinea;
                    aLinea = aLinea + &34;
                    nUltimo = nNumCampos -1;
                    |SI nEstoy ! nUltimo;
                         aLinea = aLinea + ",";
                    |FINSI;
                    |XGRABA nHandle, aLinea;
               |SIGUE;

               aLinea = aTab + aTab + "}";
               |XGRABA nHandle, aLinea;

               |LEE 000#referen@.s;
          |SIGUE;
          |CIERRA #referen@;
          |DESCARGA_DEF #referen@;
          aLinea = aTab + "],";
          |XGRABA nHandle, aLinea;
     |FINSI;
|FPRC;

|PROCESO CreaJsonRespuesta;
     nHandle = 0;
     aTab = "    ";
     |XABRE "W", eaFicJson, nHandle;
     |SI FSalida ] 0;
          nVoyLinea = 0;

          aLinea = "{";
          |XGRABA nHandle, aLinea;

          aLinea = aTab + &34 + "nombre" + &34 + " : " + &34 + eaNombreJson + &34 + ",";
          |XGRABA nHandle, aLinea;

          |DBASE aBase;
          |QBF aBase;

          |SI eaNomDefUno ! "";
               aNomDat = eaNomeDatUno;
               nNumCampos = enNumCamposUno;
               aNomDic = eaNomDicUno;
               aNomDef = eaNomDefUno;

               |HAZ VuelcaDatosJson;
          |FINSI;

/*
     ||TODO CCC
     Ver si hay dos y/o tres
*/

          |SI aResultado = "";
              aResultado = "OK";
          |FINSI;
          aLinea = aTab + &34 + "resultado" + &34 + " : " + &34 + aResultado + &34;
          |XGRABA nHandle, aLinea;

          aLinea = "}";
          |XGRABA nHandle, aLinea;

     |FINSI;
     |XCIERRA nHandle;
|FPRC;

|PROCESO SacaClaveValorPLB;
     eaClavePLB = "";
     eaValorPLB = "";
     aLong = eaLineaPLB % A0;
     |QBF aLong;
     nLong = aLong;
     |PARA nConta = 1; |SI nConta [ nLong; |HACIENDO nConta = nConta + 1;
          nCampo = (100 * nConta) + 1;
          aSaca = eaLineaPLB % nCampo;
          |SI aSaca = ":";
               nVoy = nConta + 2;
               eaValorPLB = eaLineaPLB % nVoy;
               |SAL;
          |SINO;
               eaClavePLB = eaClavePLB + aSaca;
          |FINSI;
     |SIGUE;
     |QBF eaValorPLB;
     |QBF eaClavePLB;
|FPRC;

|PROCESO EscribeEnLog;
     aFic = eaFicheroLog;
     nHandle = 0;
     |XABRE "A", aFic, nHandle;
     |SI FSalida ] 0;
          |HORA aHora;
          fFecha = ~;
          aFecha = fFecha;
          aLinea = aFecha + " " + aHora + " " + eaTextoLog;
          |XGRABA nHandle, aLinea;
     |FINSI;
     |XCIERRA nHandle;
|FPRC;

|PROCESO EscribeLineaEnJson;
     nHandle = 0;
     |SI enSwInicializaJson = 1;
         |XABRE "W", eaFicJson, nHandle;
     |SINO;
         |XABRE "A", eaFicJson, nHandle;
     |FINSI;
     |SI FSalida ] 0;
          aLinea = eaTextoJson;
          |XGRABA nHandle, aLinea;
     |FINSI;
     |XCIERRA nHandle;
|FPRC;

/*
|PROCESO MeteDatosJsonVisalm05;
     aCadena1 = "|NC";
     aCadena2 = #visalm05#aCadena1#;
     nNumCampos = aCadena2;
     aTab = "    ";

     nHandle = 0;
     |XABRE "A", eaFicJson, nHandle;
     |SI FSalida ] 0;
          |SI enVoyPrimeroRegDic = 1;
               aLinea = aTab + &34 + eaNomDicJson + &34 + " : [";
               |XGRABA nHandle, aLinea;

               aLinea = aTab + aTab + "{";
               |XGRABA nHandle, aLinea;
          |SINO;
               aLinea = aTab + aTab + ",";
               |XGRABA nHandle, aLinea;
               aLinea = aTab + aTab + "{";
               |XGRABA nHandle, aLinea;
          |FINSI;

          aTextoUtf8 = eaTextoMete;
          |QBF aTextoUtf8;
          |SI aTextoUtf8 ! "";
              |HAZ ConvierteUTF8;
          |FINSI;
          aLinea = aTab + aTab + aTab + &34 + "textoAptitud" + &34 + ":" + &34 + aTextoUtf8;
          |QBF aLinea;
          aLinea = aLinea + &34 + ",";
          |XGRABA nHandle, aLinea;

          aTextoUtf8 = eaTextoMeteDos;
          |QBF aTextoUtf8;
          |SI aTextoUtf8 ! "";
              |HAZ ConvierteUTF8;
          |FINSI;
          aLinea = aTab + aTab + aTab + &34 + "nombreConsu" + &34 + ":" + &34 + aTextoUtf8;
          |QBF aLinea;
          aLinea = aLinea + &34 + ",";
          |XGRABA nHandle, aLinea;

          aTextoUtf8 = eaTextoMeteTres;
          |QBF aTextoUtf8;
          |SI aTextoUtf8 ! "";
              |HAZ ConvierteUTF8;
          |FINSI;
          aLinea = aTab + aTab + aTab + &34 + "fechaProReco" + &34 + ":" + &34 + aTextoUtf8;
          |QBF aLinea;
          aLinea = aLinea + &34 + ",";
          |XGRABA nHandle, aLinea;

          |PARA nEstoy = 0; |SI nEstoy < nNumCampos; |HACIENDO nEstoy = nEstoy + 1;
               aCampo = "C" + (("000" + nEstoy) % -103);

               aTextoUtf8 = #visalm05#nEstoy#;
               |QBF aTextoUtf8;
               |SI aTextoUtf8 ! "";
                    |HAZ ConvierteUTF8;
               |FINSI;
               aLinea = aTab + aTab + aTab + &34 + aCampo + &34 + ":" + &34 + aTextoUtf8;
               |QBF aLinea;
               aLinea = aLinea + &34;
               nUltimo = nNumCampos -1;
               |SI nEstoy ! nUltimo;
                    aLinea = aLinea + ",";
               |FINSI;
               |XGRABA nHandle, aLinea;
          |SIGUE;

          aLinea = aTab + aTab + "}";
          |XGRABA nHandle, aLinea;
     |FINSI;
     |XCIERRA nHandle;
|FPRC;
*/

|PROCESO AbreFicJson;
     |XABRE "WB", eaFicJson, enHandleJson;
|FPRC;

|PROCESO EscribeFicJson;
     aTextoUtf8 = eaAlfaJson;  |QBF aTextoUtf8;
     |SI aTextoUtf8 ! "";
         |HAZ ConvierteUTF8;
     |FINSI;

     |XABRE "A", eaFicJson, enHandleJson;
     |SI FSalida ] 0;
          eaAlfaJson = aTextoUtf8 + &13 + &10;
          |XGRABA enHandleJson, eaAlfaJson;
          |XCIERRA enHandleJson;
     |FINSI;
|FPRC;

|PROCESO MontaVJsn;
     aTab = &9;
     aCom = &34;

     |QBF eaTJsn;

     eaAlfaJson = aTab * enNTab;
     eaAlfaJson = eaAlfaJson + aCom + eaEJsn + aCom + ": ";
     eaAlfaJson = eaAlfaJson + aCom + eaTJsn + aCom + eaSJsn;
     |HAZ EscribeFicJson;
|FPRC;


|PROCESO CierraFicJson;
     |XCIERRA enHandleJson;
|FPRC;
