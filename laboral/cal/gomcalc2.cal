|FICHEROS;
     labempre;
     labtraba #2;
     nomcalca;
     nomcalli;
     nomhicca;
     nomhicli;
     nomconca;
     nomfinli;
     nomcalal;
     nomcatli #4;
     nomtrali #6;
     nomvarca #7;
     nomvarli #8;
     nomconli #10;
     nompanta;
     copiadef@ #500;
     nomcontr;
|FIN;

|VARIABLES;
     || las variables estan copiadas del nomcalc1, con lo que habra muchas
     || que no sirvan
     &nPasoIT = 0;
     &aDef = "";
     &campos = 0;
     &topemes1 = 0;
     &topemes2 = 0;
     &denfe_0 = 0;
     &dacci_0 = 0;
     &dacci_21 = 0;
     &dacci_22 = 0;
     &dacci_23 = 0;
     &dacci_24 = 0;
     &dacci_X0 = 0;
     &nume1 = 0;
     &para1 = 0;
     &prom_enf = 0;
     &prom_acc = 0;
     &prom_ac2 = 0;
     &nDiasAlta = 0;
     &nCarencia = 180;
     &denfe_A0 = 0;
     &denfe_B0 = 0;
     &denfe_C0 = 0;
     &denfe_D0 = 0;

     &denfe_XX = 0;
     &denfe_XXC = 0;
     &dacci_XX = 0;
     &dacci_XXC = 0;

     &denfe_Y1 = 0;
     &denfe_Y2 = 0;
     &denfe_Y1_H = 0;
     &denfe_Y2_H = 0;

     &denfe_U = 0; &denfe_S = 0; &denfe_T = 0; &denfe_R = 0;
     &denfe_X = 0; &denfe_Y = 0; &denfe_W = 0; &denfe_V = 0;
     &denfe_U_H = 0; &denfe_S_H = 0; &denfe_T_H = 0; &denfe_R_H = 0;
     &denfe_X_H = 0; &denfe_Y_H = 0; &denfe_W_H = 0; &denfe_V_H = 0;
     &dacci_z = 0; &dacci_Z = 0; &dacci_Y = 0; &dacci_y = 0;
     &dacci_z_H = 0; &dacci_Z_H = 0; &dacci_Y_H = 0; &dacci_y_H = 0;
     &dacci_ZC = 0; &dacci_ZC_H = 0; &dacci_YC = 0; &dacci_YC_H = 0;

     &denfe_U0 = 0; &denfe_U0_H = 0; &denfe_UC0 = 0;
     &denfe_S0 = 0; &denfe_S0_H = 0; &denfe_SC0 = 0;
     &denfe_T0 = 0; &denfe_T0_H = 0; &denfe_TC0 = 0;
     &denfe_R0 = 0; &denfe_R0_H = 0; &denfe_RC0 = 0;

     &denfe_Y0 = 0; &denfe_Y0_H = 0; &denfe_YC0 = 0;
     &denfe_X0 = 0; &denfe_X0_H = 0; &denfe_XC0 = 0;
     &denfe_W0 = 0; &denfe_W0_H = 0; &denfe_WC0 = 0;
     &denfe_V0 = 0; &denfe_V0_H = 0; &denfe_VC0 = 0;

     &dacci_z0 = 0; &dacci_z0_H = 0; &dacci_zC0 = 0;
     &dacci_Z0 = 0; &dacci_Z0_H = 0; &dacci_ZC0 = 0;
     &dacci_Y0 = 0; &dacci_Y0_H = 0; &dacci_YC0 = 0;
     &dacci_y0 = 0; &dacci_y0_H = 0; &dacci_yC0 = 0;

     &dacum_999 = 0;
     &denfe_3 = 0;
     &denfe_4 = 0;
     &dacci_3 = 0;
     &base_1 = 0;
     &base_2 = 0;
     &base_3 = 0;

     &campo1 = 0;
     &campo2 = 0;
     &campo3 = 0;
     &campo4 = 0;
     &swSegPasada = 0;

     aAlfa = "";
     aAlfa1 = "";
     aAlfa2 = "";
     aMes = "";
     &nMes = 0;
     &nElMes = 0;
     aAny = "";
     &nAny = 0;
     &nElAny = 0;
     &nTopemes = 0;
     aDia = "";
     nDia = 0;
     FEstado = 0;
     &nIncid = 0;
     &nContLog = 0;
     &nNroErrores = 0;
     &swIniLog = 0;
     &aDesIncid = "";

     alfa1 = "";
     alfa2 = "";
     alfa3 = "";
     alfa4 = "";
     alfa5 = "";
     alfa6 = "";
     alfa7 = "";
     alfa8 = "";
     alfa9 = "";
     alfa10 = "";
     &nume2 = 0;
     nume3 = 0;
     nume4 = 0;
     nume5 = 0;
     nume6 = 0;
     nume7 = 0;
     nume8 = 0;
     nume9 = 0;
     nume10 = 0;
     &anticom2 = 0;
     &anticom3 = 0;
     &swCalPror = 0;
     &swCalPaga = 0;
     &dvalo_pro = 0;
     &nPropPrac = 1;

     aFecha = "";
     fFecha = @;
     fFecha1 = @;
     fFecha2 = @;
     &aFechaAlta = "";
     fFechaAlta = @;
     &aFechaRef = "";
     &fecha_bon_16 = "";
     &nMesesBon16 = 0;
     &nAnyosBon16 = 0;
     &por_bon_16A = 0;
     &nPB16Calc = 0;
     &nPB16CalcA = 0;
     &por_bon_16 = 0;
     &por_bon_60 = 0;
     &bon_60 = 0;
     &bon_60A = 0;
     &aParam = "";
     &swNoMensa = 0;
     &base_6 = 0;
     &EURODB = 0;
     &nPrecioVar = 0;
     &concepto = 0;
     &porce = 0;
     &swConceptoOFF = 0;

     &swCumple = 0;
     &aNif = "";
     fech1 = @;
     fech2 = @;
     &mesnum = 0;
     &anynum = 0;
     &topemes = 0;
     &bisiesto = 0;
     &acum_53 = 0;
     &acum_54 = 0;
     nDesdeMes = 0;
     nHastaMes = 0;
     nCampo = 0;
     nCampoD = 0;
     nCampoH = 0;
     numer = 0;
     nEdadParaBon = 0;
     nDiaCambioA60 = 0;
     nDiaCambioA59 = 0;
     &bon_55 = 0;
     aEPBon = "";

     aFabre = "";
     &ay_emp = 0;
     &ay_tra = 0;
     &ay_mes = 0;
     &ay_any = 0;
     &ay_ant = "";

     nConcepAju = 0;
     nTipoAjuste = 0;
     nImpoAjuste = 0;
     nSituaciAju = 0;
     aDescripAju = "";
     nImporteAju = 0;
     nImporteAju1 = 0;
     nImporteAju2 = 0;
     nNume = 0;
     nNume1 = 0;
     nNume2 = 0;
     nNume3 = 0;
     &nPaso = 0;
     &swCompAjuste = 0;
     &dcofi_999 = 0;
     &swDiosMio = 0;
     &swComp120 = 0;
     &nBaseIT2 = 0;
     &nBaseComp = 0;
     &nImporte_E = 0;
     &nDiasTeor_E = 0;
     &nDiasReal_E = 0;
     aMesAlta = "";
     aAnyAlta = "";
     nMesAlta = 0;
     nAnyAlta = 0;
     &nEmbargo = 0;
     aMas = "";
     aFich = "";
     aBase = "";
     &bon_59 = 0;
     &nAnysParaAnt = 0;
     &nVacMesAct = 0;
     &nVacRestoAny = 0;
     aFechaDesde = "";
     aFechaHasta = "";
     fFechaDesde = @;
     fFechaHasta = @;

     diff = 0;
     &guarda = 0;
     &swaju_des = 0;
     &swaju_hue = 0;
     &swaju_abs = 0;
     &swaju_acc = 0;
     &swaju_enf = 0;
     &swaju_mat = 0;
     &denfe_2 = 0;
     &denfe_21 = 0;
     &denfe_22 = 0;
     &denfe_23 = 0;
     &denfe_24 = 0;
     &ddese_2 = 0;
     &ddese_3 = 0;
     &dhuel_2 = 0;
     &dhuel_3 = 0;
     &dabse_2 = 0;
     &dacci_2 = 0;
     &dmate_2 = 0;
     fecha_ini_bon = @;
     any_ini_bon = 0;
     &nPresDia = 0;
     aTipo = "";
     &bruto_pag = 0;
     &swHistor = 0;
     &nDiasVac = 0;
     fFechaIni = @;
     &nDiasLabTra = 0;
     &nDiasLabAny = 0;
     nPos = 0;
     &aFechaBaja = "";
     nDesdeDia  = 0;
     nHastaDia  = 0;
     &aBaja1_Art = "";
     &aBaja2_Art = "";
     &aBaja3_Art = "";
     &aBaja4_Art = "";
     campo = 0;
     desde = 0;
     &hasta = 0;
     &mesco = 0;
     tipo = 0;
     prop = 0;
     aAlfa3 = "";
     aAlfa4 = "";
     &aTipoITAcum = "";
     &nDiasITAcum = 0;
     nEmp = 0;
     nTra = 0;

     fFechaBaja = @;
     fech4 = @;
     fech5 = @;
     &swSigue = 0;
     nDiaBaja = 0;
     nFecha = 0;
     aUnid = "";
     nUnidades = 0;
     nRango = 0;
     nImporInd = 0;
     nDConcepto = 0;
     nHConcepto = 0;
     nConcepto1 = 0;
     aPrecio = "";
     &swModulo = 0;
     nTImporInd = 0;
     &nMesesAlta = 0;
     swTengoDerecho = 0;
     fFechaAnt = @;
     aDiaAlta = "";
     nDiaAlta = 0;
     aDiaBaja = "";
     aMesBaja = "";
     nMesBaja = 0;
     aAnyBaja = "";
     nAnyBaja = 0;
     nPropAlta = 0;
     nNumDias = 0;
     nPorCada = 0;
     nFechaAlta = 0;
     nConceptos = 0;
     &nIRPF1 = 0;
     &nIRPF2 = 0;
     &nIRPF3 = 0;
     &duni1_902 = 0;
     &duni2_902 = 0;
     &dvalo_902 = 0;
     product = 0;
     &convenio = 0;
     nFechaBaja = 0;

     &nTotBru = 0;
     &aFechaFIN = "";
     fFechaFIN = @;
     &nTotInd = 0;
     &nDiasPago = 0;

     &graba04 = 0;
     &graba05 = "";
     &graba06 = 0;
     &graba07 = 0;
     &graba08 = "";
     &graba09 = 0;
     &graba10 = 0;
     &graba11 = 0;
     &swgracon = 0;
     &swcongra = 0;
     &unidades = 0;
     &fijo_1 = 0;
     &doce = 0;
     tempo1 = 0;
     tempo2 = 0;
     tempo3 = 0;
     tempo4 = 0;
     tempo5 = 0;

     &acum_40 = 0;
     &acum_401 = 0;
     &acum_402 = 0;
     &acum_403 = 0;
     &acum_41 = 0;
     &acum_60 = 0;
     &duni2_999 = 0;
     &dvalo_999 = 0;
     nDesde = 0;
     nHasta = 0;
     nDias = 0;
     nCampoDias = 0;
     nMeses = 0;
     &swContCont = 0;
     aFechaBajaAct = "";
     &nMesIRPF = 0;
     nFecha1 = 0;
     nFecha2 = 0;
     &aFeBajaReal = "";

     &nIngresos = 0;
     &nIngresosPag = 0;
     &nDeducc = 0;
     &nDeduccPag = 0;
     &nLiquidoNom = 0;
     &nLiquidoPag = 0;

     &bruto_rec = 0;                            || BRUTO
     &dto_con = 0;                 || cont. comunes.
     &deducss = 0;                 || cont. comunes.
     &dto_dfp = 0;            || cont. profesionales
     &dto_ho1 = 0;   || cont. horas
     &dto_ho2 = 0;   || cont. horas
     &antici1 = 0;  || anticipos
     &antici2 = 0;  || anticipos
     &antici4 = 0;  || anticipos
     &especie = 0;            || en especie
     &nAcumAbs = 0;           || absentismos
     &swbaja = 0;
     &acum2_200 = 0;
     &reten_1 = 0;
     &reten_2 = 0;
     &reten_11 = 0;
     &reten_12 = 0;
     &reten_13 = 0;
     &antici3 = 0;  || anticipos
     &reten_p = 0;
     nCuotaEmb = 0;
     nSMI = 0;
     nLiqEmb = 0;
     nLimite = 0;
     nLimite1 = 0;
     nLimite2 = 0;
     nPasada = 0;
     nPor = 0;
     &dalta_3 = 0;
     &dbaja_3 = 0;
     &dcoti_0 = 0;
     &dia_2 = 0;
     &dia_4 = 0;
     &nRetEstAnu = 0;
     &coba_1 = 0;
     &cobb_1 = 0;
     &cobb_2 = 0;
     &coba_2 = 0;
     &coba_4 = 0;
     &cobb_4 = 0;
     swExiste902 = 0;
     swExiste410 = 0;
     &nDesem = 0;
     swExiste = 0;
     nImporte = 0;
     nDiasMes = 0;
     nMesBusca = 0;
     nAnyBusca = 0;
     nTipo = 0;
     &histori = "";
     &histori2 = "";
     &histori3 = "";
     &nDiaCumple2 = 0;
     &swAjuste3 = 0;
     &swAjuste3_2 = 0;
     &swAjuste3_C = 0;
     &duni1_999 = 0;
     &divide = 0;
     &aTipoIT = "";
     &camhos = 0;
     &aHosp = "";
     nDesdeAny = 0;
     nHastaAny = 0;
     &ajuste7 = 0;
     &mid = 0;
     &meslabo = "";
     aCon = "";
     &denfe_NO = 0;
     &denfe_Z0 = 0;
     &nDesEnf = 0;
     &nDesAcc = 0;
     &nBonifERE = 0;
     &nDiasBonifERE = 0;
     &base_A = 0;
     &nBonifFCI = 0;
     &nBonifFCI1 = 0;
     &nBonifFCI2 = 0;
     &nBonifFCI_T1 = 0;
     &nBonifFCI_T2 = 0;
     &tp = 0;
     &nBonifTex = 0;
     &nBonifTex1 = 0;
     &nBonifTex2 = 0;
     nEdad = 0;
     &nAjuste = 0;
     &stop = 0;
     &acum_10 = 0;
     &acum_11 = 0;
     &acum_50 = 0;
     &acum_99 = 0;
     &acum_991 = 0;
     &acum_992 = 0;
     &acum_993 = 0;
     &swParcheAjuIT = 0;
     &nBaseMesAntIT = 0;
     swNoEntra = 0;
     nAjuEmb = 0;
     aFecha1 = "";
     aFecha2 = "";
     nPuntero = 0;
     nDiasLab = 0;
     nDiasFes = 0;
     &nDiasDesCoef = 0;
     nMaxDiasAlta = 0;
     fech3 = @;
     fech6 = @;
     &swAjusteD = 0;
     &swAjusteDD = 0;
     fIniBon = @;
     aIniBon = "";
     fAny1Bon = @;
     fAny2Bon = @;
     swCambioBon = 0;
     nDiasBon_1 = 0;
     fFechaCal = @;
     fFechaIniBon = @;
     fFechaFinBon = @;
     nDiasBon = 0;
     &hcoti_0 = 0;
     &aIndTex = "";
     &nCodBonFom1 = 0;
     &nCodBonFom2 = 0;
     &nCodBonTex1 = 0;
     &nCodBonTex2 = 0;
     &swDupli = 0;
     &nCuantos = 0;
     &swPrimera = 0;
     aFechaIT = "";
     &nTrabDupli = 0;
     &nRemunMes = 0;
     &nRemunMesOri = 0;
     nRemunMesDia = 0;
     nRemunMayo = 0;
     nRemunMayoDia = 0;
     nDiasMayo = 0;
     &dcobr_0 = 0;
     nRemunMesAper = 0;
     nRemunMayoAper = 0;
     swPaso = 0;
     &nEl928 = 0;
     nCampo1 = 0;
     nCampo2 = 0;
     nCampo3 = 0;
     nCampo4 = 0;
     &dacum_30 = 0;
     &dacum_31 = 0;

     &nEstoyEnAjuste = 0;
     &swFuncRecorte = 0;
     &nNuevaAcum10 = 0;
     &nAjusteEBnor1 = 0;
     &nAjusteEBnor2 = 0;
     &nAjusteEBnor3 = 0;
     nomtmpca = "";
     nomtmpli = "";
     &nDiferPror = 0;
     &paga = 0;
     &nUnidYaPagadas = 0;
     &aFiestaAct = "";
     &nDiaAct1 = 0; &nDiaAct2 = 0; &nDiaAct3 = 0; &nDiaAct4 = 0;
     &nDiaAct5 = 0; &nDiaAct6 = 0; &nDiaAct7 = 0; &nDiaAct8 = 0;
     &nTFAct = 0;    || total dias de fiesta por Actividad en el mes
     any = 0;
     nProp = 0;
     swHijos = 0;
     nPara1 = 0;
     nPara2 = 0;
     nAnyRef = 0;
     nMesRef = 0;
     &nTotalPrecioVar = 0;
     &nPrecioVarMes = 0;
     &dacum_999_completo = 0;
     nBaseReal = 0;
     nBaseGrabada = 0;
     nDiferencia = 0;
     nRemunMesRefApli = 0;
     nDiasDesde = 0;
     nDiasTramo = 0;
     nRestoDias = 0;
     &nPresDiaEnf = 0;
     &nPresDiaAcc = 0;

     &aFecBajaBon = 0;
     &nDiasBonBaja = 0;
     nAltaBonif = 0;
     nBajaBonif = 0;
     nBaja = 0;
     nInicioBaja = 0;
     nFinBaja = 0;
     nRemunMayoTeor = 0;
     nMesPaga = 0;
     nDiasPaga = 0;
     nImportePaga = 0;
     &fecbaj = "";
     &nPasoLog = 0;
     &nCanal = 0;

     nCampoDesde = 0;
     nCampoHasta = 0;
     nCampoTipo = 0;
     nCampoPorc = 0;
     sw100por100 = 0;
     nInembargable = 0;
     swPagasProrr = 0;
     nCampoPT = 0;
     &nDiasEnfBase2 = 0; &nDiasAccBase2 = 0; &nDiasMatBase2 = 0;
     &denfe_A_Base2 = 0; &denfe_B_Base2 = 0; &denfe_C_Base2 = 0; &denfe_D_Base2 = 0;
     &dacci_X2_Base2 = 0;
     &aTipoITBase2 = "";
     &nPromedio = 0;
     nPropProrr = 0;
     &denfe_U_Base2 = 0; &denfe_T_Base2 = 0;
     &denfe_S_Base2 = 0; &denfe_R_Base2 = 0;
     &denfe_Y_Base2 = 0; &denfe_X_Base2 = 0;
     &denfe_W_Base2 = 0; &denfe_V_Base2 = 0;
     nPromedioBase = 0;
     &swIndem = 0;
     &nConceptoInd = 0;
     swGastosACero = 0;
     nVeces = 0;
     nResto = 0;
     nAcumDias = 0;
     nAcumDiasSueltos = 0;
     nTotalDias = 0;
     nTotalDiasSueltos = 0;
     sw125acero = 0;
     &swAbsVacHue = 0;
     &swAgosto2012 = 0;
     nTotAju = 0;
     sw920 = 0;
     &swProrPaga = 0;
     &nImportePagaMes = 0;
     nConcPaga = 0;
     nFinConcPaga = 0;
     nContrato = 0;
     nDiasLey = 0;
     &dto_sol_tra = 0;
     fFechaIniNom = @;
     fFechaFinNom = @;
     nOtroLiquido = 0;
     aFechaIniNom = "";
     aFechaFinNom = "";
     nOtroEmbEmp = 0;
     nOtroEmbTra = 0;
     nLiquidoOtroNom = 0;
     nLiquidoOtroPag = 0;
     nEmbargoOtro = 0;
     &exce_smi = 0;
     &nArrAnyAnt = 0;
     swAjuCompFeb = 0;
     &nBonifJuv = 0;
     swAdadeAgrHor = 0;
     nUnidadesCon = 0;
     nGuardaMeses = 0;
     nHoras = 0;
     aImporte = "";
     sw949 = 0;
|FIN;

/****************************************************************************/
/**************        PROCESOS AUXILIARES         **************************/
/****************************************************************************/

|PROCESO ulti_dia_ind;  || halla el ultimo dia del mes
     bisiesto = 0;
     numer = anynum $ 4;
     |SI numer = 0;
          bisiesto = 1;
     |FINSI;
     topemes = 31;
     |SI mesnum= 2;
          topemes = 28 + bisiesto;
     |FINSI;
     |SI mesnum= 4;|O mesnum= 6;|O mesnum= 9;|O mesnum=11;
          topemes = 30;
     |FINSI;
|FPRC;

|PROCESO PreguntaIndem;
     |SI aFechaFIN ! ""; || Sykes, Theorical Liquidation
          |ACABA;
     |FINSI;

     aAlfa1 = #labtraba#0; |QBF aAlfa1; aAlfa1 = ("00000" + aAlfa1) % -105;
     aAlfa2 = #labtraba#1; |QBF aAlfa2; aAlfa2 = ("00000" + aAlfa2) % -105;
     aAlfa = aAlfa1 + "." + aAlfa2;
     |SI swIndem = 1;        || por convenio
          aAlfa3 = "S";
     |FINSI;
     |SI swIndem = 2;        || por concepto 902;
          aAlfa3 = "N";
          |SI duni1_902 = 20; |O duni1_902 = 33; |O duni1_902 = 45;
               aAlfa3 = "S";
          |FINSI;
     |FINSI;
     aAlfa = "    ATENCION: el trabajador " + aAlfa + " tiene indemnización ";
     aAlfa = aAlfa + "por cese de contrato.";
     |MENAV aAlfa;
     aAlfa = "    " + aAlfa3 + "¿Aplicar retención por IRPF en la indemnización?";
     |CONFI aAlfa;
     |SI FSalida = 0;
          concepto = 410;
     |SINO;
          concepto = 415;
     |FINSI;
     nConceptoInd = concepto;
|FPRC;

|PROCESO convenio_ind;     || comprueba si existe linea de convenio
     |DDEFECTO #10;
     convenio = 1;
     #10#00 = #2#87;
     #10#02 = concepto;
/*
     || desactivo para agrarios
     |HAZ excepciones;
     |SI concepto < 901; |Y swConceptoOFF ! 0;
          |ACABA;
     |FINSI;
*/
     |LEE 000#10=;
     |SI FSalida = 0;|O concepto ] 901; || los conceptos 9xx pasan aunque no esten
          convenio = 0;
          |SI concepto ] 901;
               |SI concepto = 901;  #10#6 = "N§ HORAS";  |FINSI;
               |SI concepto = 902;  #10#6 = "INDEMNI.";  |FINSI;
               |SI concepto = 903;
                    #10#6 = "CITRICOS";
                    fijo_1 = unidades;       || dias cotizados citricos
               |FINSI;
               |SI concepto = 904;  #10#6 = "VACACION";  |FINSI;
               |SI concepto = 905;  #10#6 = "HORAS TP";  |FINSI;
               |SI concepto = 906;  #10#6 = "ANTIC. 1";  |FINSI;
               |SI concepto = 907;  #10#6 = "ANTIC. 2";  |FINSI;
               |SI concepto = 908;  #10#6 = "ESPECIE ";  |FINSI;
               |SI concepto = 923;  #10#6 = "ESPECIE2";  |FINSI;
               |SI concepto = 924;  #10#6 = "ESPECIE3";  |FINSI;
               |SI concepto = 909;  #10#6 = "H.C.SEM.";  |FINSI;
               |SI concepto = 910;  #10#6 = "H.T.SEM.";  |FINSI;
               |SI concepto = 911;  #10#6 = "H.C.MES ";  |FINSI;
               |SI concepto = 912;  #10#6 = "H.T.MES ";  |FINSI;
               |SI concepto = 913;  #10#6 = "ALTA=CTO";  |FINSI;
               |SI concepto = 914;  #10#6 = "D.ALTA  ";  |FINSI;
               |SI concepto = 915;  #10#6 = "DIAS VAC";  |FINSI;
               |SI concepto = 916;  #10#6 = "DED.S.S.";  |FINSI;
               |SI concepto = 917;  #10#6 = "DIAS TC2";  |FINSI;
               |SI concepto = 918;  #10#6 = "HORASTC2";  |FINSI;
               |SI concepto = 919;  #10#6 = "BASEIRPF";  |FINSI;
               |SI concepto = 920;  #10#6 = "P.INDEM.";  |FINSI;
               |SI concepto = 921;  #10#6 = "ANTIC.PE";  |FINSI;
               |SI concepto = 925;  #10#6 = "MED.VAR.";  |FINSI;
               |SI concepto = 926;  #10#6 = "ANTIC. 3";  |FINSI;
               |SI concepto = 928;  #10#6 = "BASE REM";  |FINSI;
               |SI concepto > 928;
                    convenio = 1;         || los no contemplados no los graba
               |SINO;
                    |SI FSalida ! 0;
                         #10#3 = "V";
                         #10#4 = 0;
                         #10#5 = 0;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO leedoce_ind;
     |LIBERA #nomcalli;
     #nomcalli#0 = #2#0;
     #nomcalli#1 = #2#1;
     #nomcalli#2 = nElMes;
     #nomcalli#3 = 0;
     #nomcalli#4 = doce;
     |LEE 101#nomcalli.=;
|FPRC;

|PROCESO grabacon_ind;        || GRABA O REGRABA LINEAS DE CALCULO SEGUN VARIABLES
     doce = graba04;
     |HAZ leedoce_ind;
     FEstado = FSalida;
     |SI FEstado ! 0; |O swgracon = 1;    || switch para regrabar campos convenio
          #nomcalli#5 = graba05; || calculo alfa
          #nomcalli#06 = graba06; || calculo nume
          #nomcalli#07 = graba07; || situacion
          #nomcalli#08 = graba08; || descripcion
     |FINSI;
     |SI FEstado = 0; |Y swcongra = 1;    || switch para regrabar acumulando
          tempo1 = #nomcalli#10;  || valor anterior
          tempo2 = #nomcalli#11;  || unidades calculo anterior
          tempo3 = graba10; || valor actual
          tempo4 = graba11; || unidades calculo actual
          tempo5 = (tempo1 * tempo2) + (tempo3 * tempo4); || importe total
          graba10 = tempo5; || valor concepto nuevo
          graba11 = 1;      || unidades calculo concepto nuevo
     |FINSI;
     |SI FEstado = 0; |Y swcongra = 2;    || switch para regrabar SIN ACUMUILAR
          tempo1 = #nomcalli#9;
          tempo2 = #nomcalli#10;
          tempo3 = #nomcalli#11;
          |SI tempo1 ! 0; graba09 = tempo1; |FINSI;
          |SI tempo2 ! 0; graba10 = tempo2; |FINSI;
          |SI tempo3 ! 0; graba11 = tempo3; |FINSI;
          /*
          || desactivado para agrarios
          |SI doce = 125;
               |HAZ VacacVaria;
               |SI sw125acero = 1;
                    graba11 = 0;   || para permitir no pagar vacaciones desde
                                   || variaciones si lo creamos a cero
               |FINSI;
          |FINSI;
          */
          |SI doce = 125; || vacaciones con dias desde variaciones
          |O doce = 410; |O doce = 415; || indemnizacion, mismo caso
               |SI tempo1 ! 0; |Y swExiste902 = 0;
                    || en caso de que exista el 902 no salia como debia
                    graba11 = tempo1;
               |FINSI;
          |FINSI;
     |FINSI;
     #nomcalli#09 = graba09;     || unidades
     #nomcalli#10 = graba10;     || valor
     #nomcalli#11 = graba11;     || unidades calculo
     |SI FEstado ! 0;
          |GRABA 020#nomcalli.n;
     |SINO;
          |GRABA 020#nomcalli.a;
     |FINSI;
     |LIBERA #nomcalli;
|FPRC;

/****************************************************************************/
/*               CALCULO DE INDEMNIZACIONES SEGUN CONVENIO                  */
/****************************************************************************/

|PROCESO Prop902;
     nDiasPago = nUnidades;

     nPorCada = 12;

     nUnidades = nMesesAlta / nPorCada;

     nUnidades = nUnidades * nDiasPago;
|FPRC;

|PROCESO Busca949;
     sw949 = 0;

     |ABRE #6;
     #6#0 = #2#0;  #6#1 = #2#1;  #6#2 = 949;
     |LEE 000#6=;
     |SI FSalida = 0;
          aUnid = #6#3;
          |QBT aUnid;
          |SI aUnid ! "-1";
               nUnidades = aUnid;
          |FINSI;

          |SI aImporte ! "-1";
               aImporte = #6#4;
          |FINSI;
          |QBT aImporte;
          nImporInd = aImporte;
          sw949 = 1;
     |FINSI;
     |CIERRA #6;

     |ABRE #8;
     #8#0 = #2#0;  #8#1 = #2#1;  #8#2 = nElMes; #8#3 = 0; #8#4 = 949;
     |LEE 000#8=;
     |SI FSalida = 0;
          aUnid = #8#5;
          |QBT aUnid;
          |SI aUnid ! "-1";
               nUnidades = aUnid;
          |FINSI;

          aImporte = #8#6;
          |QBT aImporte;
          |SI aImporte ! "-1";
               nImporInd = aImporte;
          |FINSI;

          sw949 = 1;
     |FINSI;
     |CIERRA #8;
|FPRC;

|PROCESO Busca902;
     |ABRE #6;
     #6#0 = #2#0;  #6#1 = #2#1;  #6#2 = 902;
     |LEE 000#6=;
     |SI FSalida = 0;
          aUnid = #6#3;
          |QBT aUnid;
          nUnidades = aUnid;
          swExiste902 = 1;
          |HAZ Prop902;
     |FINSI;
     |CIERRA #6;

     |ABRE #8;
     #8#0 = #2#0;  #8#1 = #2#1;  #8#2 = nElMes; #8#3 = 0; #8#4 = 902;
     |LEE 000#8=;
     |SI FSalida = 0;
          aUnid = #8#5;
          |QBT aUnid;
          nUnidades = aUnid;
          swExiste902 = 1;
          |HAZ Prop902;
     |FINSI;
     |CIERRA #8;
|FPRC;

|PROCESO Busca410;
     |ABRE #6;
     #6#0 = #2#0;  #6#1 = #2#1;  #6#2 = 410;
     |LEE 000#6=;
     |SI FSalida = 0;
          swExiste410 = 1;
     |FINSI;
     |CIERRA #6;

     |ABRE #8;
     #8#0 = #2#0;  #8#1 = #2#1;  #8#2 = nElMes; #8#3 = 0; #8#4 = 410;
     |LEE 000#8=;
     |SI FSalida = 0;
          swExiste410 = 1;
     |FINSI;
     |CIERRA #8;
|FPRC;

|PROCESO cuentadias;
     |PARA nMesPaga = nDesdeMes; |SI nMesPaga [ nHastaMes; |HACIENDO nMesPaga = nMesPaga + 1;
          |SI nMesPaga = 1; |O nMesPaga = 3; |O nMesPaga = 5; |O nMesPaga = 7;
          |O nMesPaga = 8; |O nMesPaga = 10; |O nMesPaga = 12;
               nDiasPaga = nDiasPaga + 31;
          |SINO;
               |SI nMesPaga = 2;
                    nDiasPaga = nDiasPaga + 28;
               |SINO;
                    nDiasPaga = nDiasPaga + 30;
               |FINSI;
          |FINSI;
     |SIGUE;
|FPRC;

|PROCESO Busca200Sykes;
     || probablemente esto para todo el mundo deberia ponerse, pero de momento
     || no me arriesgo

     nImportePaga = 0;
     nDesde = nRango - 197;
     nHasta = nRango - 189;
     nCampoDias = nRango - 165;
     nConcPaga = nRango - 149;
     nFinConcPaga = nConcPaga + 32;
     |PARA nCampo = nConcPaga; |SI nCampo [ nFinConcPaga; |HACIENDO nCampo = nCampo + 8;
          #nomcalli#0 = #labtraba#0;
          #nomcalli#1 = #labtraba#1;
          #nomcalli#2 = nElMes;
          #nomcalli#3 = 0;
          #nomcalli#4 = #nomconca#nCampo#;
          |LEE 000#nomcalli.=;
          |SI FSalida = 0;
               nImportePaga = nImportePaga + #nomcalli#10;
          |FINSI;
     |SIGUE;
     |SI nImportePaga = 0; || nada en mensual, tendre que buscar en Hco.
          |PARA nCampo = nConcPaga; |SI nCampo [ nFinConcPaga; |HACIENDO nCampo = nCampo + 8;
               #nomhicli#0 = #labtraba#0;
               #nomhicli#1 = #labtraba#1;
               #nomhicli#12 = nElAny - 2000;
               #nomhicli#2 = nElMes;
               #nomhicli#3 = 0;
               #nomhicli#4 = #nomconca#nCampo#;
               |LEE 000#nomhicli.=;
               |SI FSalida = 0;
                    nImportePaga = nImportePaga + #nomhicli#10;
               |FINSI;
          |SIGUE;
     |FINSI;

     |SI #nomconca#nDesde# < #nomconca#nHasta#;
          nDesdeMes = #nomconca#nDesde#;
          nHastaMes = #nomconca#nHasta#;
          nMeses = nHastaMes - nDesdeMes + 1;

          nDiasPaga = 0;
          |HAZ cuentadias;
     |SINO;
          nDesdeMes = #nomconca#nDesde#;
          nHastaMes = 12;
          nMeses = nHastaMes - nDesdeMes + 1;
          nDiasPaga = 0;
          |HAZ cuentadias;

          nDesdeMes = 1;
          nHastaMes = #nomconca#nHasta#;
          nMeses = nMeses + (nHastaMes - nDesdeMes + 1);
          |HAZ cuentadias;
     |FINSI;
     |SI nMeses > 12;
          nMeses = 12;
     |FINSI;
     nDias = #nomconca#nCampoDias#;
/*
     |SI tp ! 0;
          nImportePaga = nImportePaga / tp;
     |FINSI;

     || lo quito, lo que venga del mantenimiento ya viene calculado segun el
     || coef. TP
*/
     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
          nImportePaga = nImportePaga / 30;
     |SINO;
          nMes = nElMes;
          nAny = nElAny;
          |HAZ topemes_plb;

          nImportePaga = nImportePaga / nTopemes;
     |FINSI;

     |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
          || nImporInd = nImporInd + ((nDias / nMeses * nImportePaga) / 30);
          nImporInd = nImporInd + ((nDias / 12 * nImportePaga) / 30);
     |SINO;
          nImporInd = nImporInd + ((nDias * nImportePaga) / nDiasPaga);
     |FINSI;

     |CIERRA #nomhicli;
|FPRC;

|PROCESO Busca200Mens;
     #nomcalli#0 = #labtraba#0;
     #nomcalli#1 = #labtraba#1;
     #nomcalli#2 = nElMes;
     #nomcalli#3 = 0;
     #nomcalli#4 = nRango;
     |LEE 000#nomcalli.=;
     |SI FSalida = 0;
          nDesde = nRango - 197;
          nHasta = nRango - 189;
          nCampoDias = nRango - 165;
          |SI #nomconca#nDesde# < #nomconca#nHasta#;
               nDesdeMes = #nomconca#nDesde#;
               nHastaMes = #nomconca#nHasta#;
               nMeses = nHastaMes - nDesdeMes + 1;

               nDiasPaga = 0;
               |HAZ cuentadias;
          |SINO;
               nDesdeMes = #nomconca#nDesde#;
               nHastaMes = 12;
               nMeses = nHastaMes - nDesdeMes + 1;
               nDiasPaga = 0;
               |HAZ cuentadias;

               nDesdeMes = 1;
               nHastaMes = #nomconca#nHasta#;
               nMeses = nMeses + (nHastaMes - nDesdeMes + 1);
               |HAZ cuentadias;
          |FINSI;
          |SI nMeses > 12;
               nMeses = 12;
          |FINSI;
          nDias = #nomconca#nCampoDias#;

          |SI #nomcalli#10 > 1;    || si hay algun importe
               /*
               || no tiene sentido, no se por que en los TP estoy dividiendo
               || entre la jornada para calcular la paga segun el valor del
               || concepto como si no estuviera a TP, lo quito
               || 12.06.2014 - Tiquet 5050.134 Datos Matilde Nu¤ez
               || lo que pasaba es que despues lo volvia a multiplicar, estaba
               || mal planteado (busca"* tp")

               |SI tp ! 0; |Y tp ! 1;
                    nImportePaga = #nomcalli#10 / tp;
               |SINO;
                    nImportePaga = #nomcalli#10;
               |FINSI;
               */
               nImportePaga = #nomcalli#10;
               |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";
                    nImporInd = nImporInd + ((nDias/nMeses * nImportePaga) / 30);
               |SINO;
                    nImporInd = nImporInd + ((nDias * nImportePaga) / nDiasPaga);
               |FINSI;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO concepto200;
     |HAZ BuscaModulo;
     |SI swModulo = 3462;
          |HAZ Busca200Sykes;
     |SINO;
          |HAZ Busca200Mens;
     |FINSI;
|FPRC;

|PROCESO BuscaCon200;
     |SI concepto = 200;
          nDConcepto = 201;
          nHConcepto = 208;
          |PARA nRango = nDConcepto; |SI nRango [ nHConcepto; |HACIENDO nRango = nRango + 1;
               |HAZ concepto200;
          |SIGUE;
     |SINO;
          nRango = concepto;
          |HAZ concepto200;
     |FINSI;
|FPRC;

|PROCESO AntiguedadInd;
     #nomcalli#0 = #2#0;
     #nomcalli#1 = #2#1;
     #nomcalli#2 = nElMes;
     #nomcalli#3 = 0;
     #nomcalli#4 = 102;
     |LEE 000#nomcalli.=;
     |SI FSalida = 0;
          |SI #nomcalli#9 = 1;     || unidades = 1, mensual
               nImporInd = nImporInd + (#nomcalli#10 / 30);
          |SINO;
               nImporInd = nImporInd + #nomcalli#10;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO PropUltMes;
     nMes = nElMes;
     nAny = nElAny;
     |HAZ topemes_plb;
     |SI nDiaBaja ! nTopemes;
          nMes = nMesBusca;
          nAny = nAnyBusca;
          |HAZ topemes_plb;
          nume3 = nTopemes - nDiaBaja;

          |SI nume3 < nDiasAlta;
               nume4 = nume3;
          |SINO;
               nume4 = nDiasAlta;
          |FINSI;
          nImporte = nume4 * nImporte / nDiasMes;
     |FINSI;
     |SI nImporte < 0;
          nImporte = 0;
     |FINSI;
|FPRC;

|PROCESO BuscaImpCalc;
     nMeses = #nomfinli#7;
     nAnyBusca = nElAny;
     |SI nMeses = 0;
          nMeses = 999;
     |FINSI;
     |PARA nMesBusca = nMesBaja; |SI nMeses ] 0; |HACIENDO nMesBusca = nMesBusca - 1;
          |SI nMesBusca = 0;
               nMesBusca = 12;
               nAnyBusca = nAnyBusca - 1;
          |FINSI;
          nImporte = 0
          swExiste = 0;
          |SI nMesBusca = nMesBaja; |Y nAnyBusca = nAnyBaja;
               || es el mes de la baja, busco mensual
               #nomcalli#0 = #labtraba#0;
               #nomcalli#1 = #labtraba#1;
               #nomcalli#2 = nMesBusca;
               #nomcalli#3 = 0;
               #nomcalli#4 = nConcepto1;
               |LEE 000#nomcalli.=;
               |SI FSalida = 0;
                    swExiste = 1;
                    nUnidadesCon = nUnidadesCon + #nomcalli#11;
                    nImporte = (#nomcalli#11* #nomcalli#10);
                    nImporInd = nImporInd + nImporte;
               |FINSI;
               || tambien busco atrasos mensual
               #nomcalal#0 = #labtraba#0;
               #nomcalal#1 = #labtraba#1;
               #nomcalal#2 = nMesBusca;
               #nomcalal#3 = 0;
               #nomcalal#4 = nConcepto1;
               |LEE 000#nomcalal.=;
               |SI FSalida = 0;
                    swExiste = 1;
                    nImporte = (#nomcalal#11* #nomcalal#10);
                    nImporInd = nImporInd + nImporte;
               |FINSI;
          |SINO;
               || es el otro mes anterior, busco historico

               #nomhicca#0 = #labtraba#0;
               #nomhicca#1 = #labtraba#1;
               #nomhicca#66 = nAnyBusca - 2000;
               #nomhicca#2 = nMesBusca;
               #nomhicca#3 = 0;
               |LEE 000#nomhicca.=;
               |SI FSalida = 0;
                    swExiste = 1;
                    |PARA nTipo = 0; |SI nTipo [ 7; |HACIENDO nTipo = nTipo + 1;
                         |SI nTipo = 0; |O nTipo = 5; |O nTipo = 6; |O nTipo = 7;
                              #nomhicli#0 = #labtraba#0;
                              #nomhicli#1 = #labtraba#1;
                              #nomhicli#12 = nAnyBusca - 2000;
                              #nomhicli#2 = nMesBusca;
                              #nomhicli#3 = nTipo;
                              #nomhicli#4 = nConcepto1;
                              |LEE 000#nomhicli.=;
                              |SI FSalida = 0;
                                   nImporte = (#nomhicli#11* #nomhicli#10);
                                   |SI nTipo = 0;
                                        nUnidadesCon = nUnidadesCon + #nomhicli#11;
                                   |FINSI;
                                   |SI nMeses = 0;
                                        nDiasMes = #nomhicca#7;
                                        nDiasAlta = #nomhicca#8;
                                        |HAZ PropUltMes;
                                   |FINSI;
                                   nImporInd = nImporInd + nImporte;
                              |FINSI;
                         |FINSI;
                    |SIGUE;
               |FINSI;
          |FINSI;
          nMeses = nMeses - 1;
          |SI swExiste = 0;
               || No encuentro en un mes del trabajador, no sigo buscando
               swExiste = 1;
               |SAL;
          |FINSI;
      |SIGUE;
|FPRC;

|PROCESO BuscaImpMant;
     #nomconli#0 = #labtraba#87;
     #nomconli#2 = nConcepto1;
     |LEE 000#nomconli.=;
     |ABRE #nomcatli;
     #nomcatli#0 = #2#87; #nomcatli#1 = #2#17; #nomcatli#2 = nConcepto1;
     |LEE 000#nomcatli.=;
     |SI FSalida = 0;
          nImporInd = #nomcatli#4;
          aUnid = #nomcatli#3;
          |QBT aUnid;
          |SI aUnid = "1";
               nImporInd = #nomcatli#4 / 30;
          |SINO;
               |SI aUnid ! ""; |O #nomconli#3 = "M"; |O #nomconli#3 = "Z";
               |O #nomconli#3 = "D"; |O #nomconli#3 = "E"; |O #nomconli#3 = "L";
                    |SI #nomconli#3 = "E"; |O #nomconli#3 = "L";
                         nImporInd = #nomcatli#4 * #nomconli#14 / 30;
                    |SINO;
                         nImporInd = #nomcatli#4;
                    |FINSI;
               |SINO;
                    nImporInd = 0;
               |FINSI;
          |FINSI;
          |SI tp ! 0; |Y tp ! 1;
               nImporInd = nImporInd * tp;
               || aqui es el unico sitio donde tengo que multiplicar por
               || el coeficiente, ya que si lo cojo del importes por
               || trabajador o variaciones, ya se pone el importe reducido
          |FINSI;
          |SI #nomconli#7 = "E";   || los exclusivos de vacaciones NO
               nImporInd = 0;
          |FINSI;
          |SI swAdadeAgrHor = 1;   || para agrarios por horas, cojo este
                                   || importe para calcular importe por hora
               nNume = #nomcatli#4;
               |SI nNume ! 0;
                    nImporInd = nNume;
               |FINSI;
          |FINSI;
          |SI nConcepto1 = 920;
               aAlfa = #nomcatli#3;
               nImporInd = aAlfa;
               sw920 = 1;
          |FINSI;
     |FINSI;
     |CIERRA #nomcatli;

     |ABRE #nomtrali;
     #nomtrali#0 = #2#0;  #nomtrali#1 = #2#1;  #nomtrali#2 = nConcepto1;
     |LEE 000#nomtrali.=;
     |SI FSalida = 0;
          nImporInd = #nomtrali#4;
          aUnid = #nomtrali#3;
          |QBT aUnid;
          |SI aUnid = "1";
               nImporInd = #nomtrali#4 / 30;
          |SINO;
               |SI aUnid ! ""; |O #nomconli#3 = "M"; |O #nomconli#3 = "Z";
               |O #nomconli#3 = "D"; |O #nomconli#3 = "E"; |O #nomconli#3 = "L";
                    |SI #nomconli#3 = "E"; |O #nomconli#3 = "L";
                         nImporInd = #nomtrali#4 * #nomconli#14 / 30;
                    |SINO;
                         nImporInd = #nomtrali#4;
                    |FINSI;
               |SINO;
                    nImporInd = 0;
               |FINSI;
          |FINSI;
          |SI #nomconli#7 = "E";   || los exclusivos de vacaciones NO
               nImporInd = 0;
          |FINSI;
          |SI swAdadeAgrHor = 1;   || para agrarios por horas, cojo este
                                   || importe para calcular importe por hora
               nNume = #nomtrali#4;
               |SI nNume ! 0;
                    nImporInd = nNume;
               |FINSI;
          |FINSI;
          |SI nConcepto1 = 920;
               aAlfa = #nomtrali#3;
               nImporInd = aAlfa;
               sw920 = 1;
          |FINSI;
     |FINSI;
     |CIERRA #nomtrali;

     |ABRE #nomvarli;
     #nomvarli#0 = #2#0;  #nomvarli#1 = #2#1;  #nomvarli#2 = nElMes;  #nomvarli#3 = 0;  #nomvarli#4 = nConcepto1;
     |LEE 000#nomvarli.=;
     |SI FSalida = 0;
          aUnid = #nomvarli#5;
          aPrecio = #nomvarli#6;
          |QBT aUnid;
          |QBT aPrecio;
          |SI aUnid ! ""; |Y aPrecio ! "";
               nImporInd = #nomvarli#6 / 30;
               |SI aUnid = "1";
                    nImporInd = #nomvarli#6 / 30;
               |SINO;
                    |SI aUnid ! ""; |O #nomconli#3 = "M"; |O #nomconli#3 = "Z";
                    |O #nomconli#3 = "D"; |O #nomconli#3 = "E"; |O #nomconli#3 = "L";
                         |SI #nomconli#3 = "E"; |O #nomconli#3 = "L";
                              nImporInd = #nomvarli#6 * #nomconli#14 / 30;
                         |SINO;
                              |SI #nomconli#3 = "V"; |O #nomconli#3 = "F";
                                   nImporInd = #nomvarli#5 * #nomconli#6 / 30;
                              |SINO;
                                   nImporInd = #nomvarli#6;
                              |FINSI;
                         |FINSI;
                    |SINO;
                         nImporInd = 0;
                    |FINSI;
               |FINSI;
               |SI #nomconli#7 = "E";   || los exclusivos de vacaciones NO
                    nImporInd = 0;
               |FINSI;
               |SI swAdadeAgrHor = 1;   || para agrarios por horas, cojo este
                                        || importe para calcular importe por hora
                    nNume = #nomvarli#6;
                    |SI nNume ! 0;
                         nImporInd = nNume;
                    |FINSI;
               |FINSI;
               |SI nConcepto1 = 920;
                    aAlfa = #nomvarli#5;
                    nImporInd = aAlfa;
                    sw920 = 1;
               |FINSI;
          |FINSI;
     |FINSI;
     |CIERRA #nomvarli;

     |SI nImporInd < 0;
          nImporInd = 0;
     |FINSI;

     |HAZ BuscaModulo;
     |SI swModulo = 3462;    || para sykes, 39 horas semanales a pelo
          |SI #labtraba#234 ! 0;
               nImporInd = nImporInd * (#labtraba#234 / 39);
          |FINSI;
     |FINSI;
     |SI nConcepto1 = 102;
          |HAZ AntiguedadInd;
     |FINSI;
|FPRC;

|PROCESO BuscaConInd1;
     |SI #nomfinli#6 = "%"; |Y #nomfinli#8 ! "P";
          || solo en caso de % y que ademas le digamos de cuantos meses
          || queremos cobrarlo

          |HAZ BuscaImpCalc;  || Busca importe por los mantenimientos
                              || mensual o historico
     |SINO;

          |HAZ BuscaImpMant;  || Busca importe por los mantenimientos
                              || convenio, trabajador, variaciones

     |FINSI;
|FPRC;

|PROCESO BuscaConInd;
     aAlfa = ("000" + concepto) % -102;
     |SI aAlfa ! "00";
         nConcepto1 = concepto;
         |HAZ BuscaConInd1;
     |SINO;
         nDConcepto = concepto + 1;
         nHConcepto = concepto + 99;
         nTImporInd = 0;

         |PARA nRango = nDConcepto; |SI nRango [ nHConcepto;  |HACIENDO nRango = nRango + 1;
               ||SI nRango ! 102;
               || no se porque hacia esto, incluyo antiguedad a partir de
               || 07.01.2013
                   nImporInd  = 0;
                   nConcepto1 = nRango;
                   |HAZ BuscaConInd1;
                   nTImporInd = nTImporInd + nImporInd;
               ||FINSI;
         |SIGUE;

         nImporInd = nTImporInd;
     |FINSI;
|FPRC;

|PROCESO BuscaIndem;
     nNume1 = nMesesAlta - (nMesesAlta ! 0);
     aAlfa = nNume1; |QBF aAlfa;
     |SI aAlfa = "0"; |O aAlfa = "-0";
          nMesesAlta = nMesesAlta ! 0;
     |FINSI;

     |SI #nomfinli#3 < nMesesAlta; |Y nMesesAlta [ #nomfinli#4;
          swTengoDerecho = 1;
          |ERROR10;
     |FINSI;
|FPRC;

|DEFBUCLE BuscaIndem;
     #nomfinli#1;
     ;
     #labtraba#87, nume1, 01;
     #labtraba#87, nume1, 99;
     ;
     NULL, BuscaIndem;
|FIN;

|PROCESO BuscaConInd2;
     nImporInd = 0;
     concepto = #nomconli#2;
     |HAZ BuscaConInd;
     nTotInd = nTotInd + nImporInd;
|FPRC;

|DEFBUCLE ConceptosCat;
     #nomconli#1;
     ;
     #labtraba#87, 101;
     #labtraba#87, 999;
     ;
     NULL, BuscaConInd2;
|FIN;

|PROCESO acu_ctos_fin;
     |SI concepto = 410;
                          acum_40 = acum_40 + product;
          |SI #10#8 = 1;  acum_401 = acum_401 + product;  |FINSI;
          |SI #10#8 = 2;  acum_402 = acum_402 + product;  |FINSI;
          |SI #10#8 = 3;  acum_403 = acum_403 + product;  |FINSI;

          ||SI runnom = "nomcalcu";
               bruto_rec = bruto_rec + product;
               acum_99 = acum_99 + product;   || total
               acum_991 = acum_991 + product;  || irpf 1
               || la indemnizacion la acumulo solo en el tipo 1 de IRPF
               || acum_992 = acum_992 + product;  || irpf 2
               || acum_993 = acum_993 + product;  || irpf 3

               reten_11 = acum_991 % nIRPF1;  || retencion IRPF 1
               reten_12 = acum_992 % nIRPF2;  || retencion IRPF 2
               reten_13 = acum_993 % nIRPF3;  || retencion IRPF 3
               reten_11 = reten_11 ! EURODB;
               reten_12 = reten_12 ! EURODB;
               reten_13 = reten_13 ! EURODB;
               reten_1 = reten_11 + reten_12 + reten_13;  || total retenciones
          ||FINSI;
     |FINSI;

     |SI concepto = 415;
          |SI #10#8 ! 0;
               acum_41 = acum_41 + product;
               bruto_rec = bruto_rec + acum_41;
          |SINO;
               acum_60 = acum_60 + product;
               bruto_rec = bruto_rec + acum_60;
          |FINSI;
     |FINSI;
|FPRC;

|PROCESO mesesAlta;
     aDiaAlta = aFechaAlta % 102;
     aMesAlta = aFechaAlta % 402;
     aAnyAlta = aFechaAlta % -104;
     aDiaBaja = aFechaBaja % 102;
     aMesBaja = aFechaBaja % 402;
     aAnyBaja = aFechaBaja % -104;
     nDiaAlta = aDiaAlta;
     nMesAlta = aMesAlta;
     nAnyAlta = aAnyAlta;
     nDiaBaja = aDiaBaja;
     nMesBaja = aMesBaja;
     nAnyBaja = aAnyBaja;

     guarda = topemes;
     nDiasAlta = 0;
     nMesesAlta = 0;
     |PARA nAny = nAnyAlta; |SI nAny [ nAnyBaja; |HACIENDO nAny = nAny + 1;
          |PARA nMes = 1; |SI nMes [ 12; |HACIENDO nMes = nMes + 1;
               |SI nMes < nMesAlta; |Y nAny = nAnyAlta;
                    || todavia no
               |SINO;
                    |SI nAny = nAnyBaja; |Y nMes = nMesBaja;
                         |SAL;
                    |FINSI;
                    mesnum = nMes;
                    anynum = nAny;
                    |HAZ ulti_dia_ind;
                    |SI nMesesAlta = 0;
                         |SI nDiaAlta ! 1;
                              || como en dias cotizables:
                              nPropAlta = (topemes - nDiaAlta + 1) / topemes;
                              nNumDias = (topemes - nDiaAlta + 1);
                         |SINO;
                              nPropAlta = 1;
                              nNumDias = topemes;
                         |FINSI;
                    |SINO;
                         nPropAlta = 1;
                         nNumDias = topemes;
                    |FINSI;
                    nMesesAlta = nMesesAlta + nPropAlta;
                    nDiasAlta = nDiasAlta + nNumDias;
               |FINSI;
          |SIGUE;
     |SIGUE;

     || el ultimo mes:

     mesnum = nMesBaja;
     |HAZ ulti_dia_ind;
     |SI nDiaBaja ! topemes;
          || como en dias cotizables:
          |SI nMesAlta = nMesBaja; |Y nAnyAlta = nAnyBaja; || mismo mes alta y baja
              nPropAlta = (nDiaBaja - nDiaAlta + 1)/ topemes;
              nNumDias =  (nDiaBaja - nDiaAlta + 1);
          |SINO;
              nPropAlta = nDiaBaja / topemes;
              nNumDias =  nDiaBaja;
          |FINSI;
     |SINO;
          |SI nMesAlta = nMesBaja; |Y nAnyAlta = nAnyBaja; || mismo mes alta y baja
              nPropAlta = (nDiaBaja - nDiaAlta + 1)/ topemes;
              nNumDias =  (nDiaBaja - nDiaAlta + 1);
          |SINO;
               nPropAlta = 1;
               nNumDias = topemes;
          |FINSI;
     |FINSI;

     nMesesAlta = nMesesAlta + nPropAlta;
     nDiasAlta = nDiasAlta + nNumDias;
|FPRC;

|PROCESO DiasPago;
     |HAZ BuscaModulo;
     |SI swModulo = 3462; |O swModulo = 1;
          |ACABA;        || no hagas esto con el informe de Sykes
     |FINSI;
     nContrato = #labtraba#45;
     |SI nContrato ] 400; |Y #nomfinli#6 = "D"; |Y #nomfinli#7 = 12;
          || para los contratos de duracion determinada, los dias de indem-
          || nizacion estan estipulados segun la fecha de alta

          aAlfa = #labtraba#36;
          aAlfa = aAlfa % -104;
          nAnyAlta = aAlfa;

          |SI nAnyAlta [ 2011; nDiasLey = 8; |FINSI;
          |SI nAnyAlta = 2012; nDiasLey = 9; |FINSI;
          |SI nAnyAlta = 2013; nDiasLey = 10; |FINSI;
          |SI nAnyAlta = 2014; nDiasLey = 11; |FINSI;
          |SI nAnyAlta ] 2015; nDiasLey = 12; |FINSI;
     |FINSI;

     |SI nDiasLey ! #nomfinli#5;
          |SI nDiasLey = 8;
               aAlfa2 = " ocho";
               aAlfa3 = "hasta el 31 de diciem-";
               aAlfa4 = "bre de 2011.";
          |FINSI;
          |SI nDiasLey = 9;
               aAlfa2 = "nueve";
               aAlfa3 = "a partir del 1 de ene-";
               aAlfa4 = "ro de 2012.";
          |FINSI;
          |SI nDiasLey = 10;
               aAlfa2 = " diez";
               aAlfa3 = "a partir del 1 de ene-";
               aAlfa4 = "ro de 2013.";
          |FINSI;
          |SI nDiasLey = 11;
               aAlfa2 = " once";
               aAlfa3 = "a partir del 1 de ene-";
               aAlfa4 = "ro de 2014.";
          |FINSI;
          |SI nDiasLey = 12;
               aAlfa2 = " doce";
               aAlfa3 = "a partir del 1 de ene-";
               aAlfa4 = "ro de 2015.";
          |FINSI;

          |PUSHV 05012380;
          |BLANCO 10102271;
          |AVISO;
          |PINPA #5#nompanta;
          |ATRI S;
          |PINTA 1664, aAlfa2;
          |PINTA 1847, aAlfa3;
          |PINTA 1913, aAlfa4;
          |ATRI 0;
          |PAUSA;

          aAlfa1 = #nomfinli#5;
          aAlfa2 = nDiasLey;

          aAlfa = "    S¿Desea aplicar la indemnización de " + aAlfa2;
          aAlfa = aAlfa + " días (según Ley) en lugar de " + aAlfa1;
          aAlfa = aAlfa + " días (según Convenio)?";
          |CONFI aAlfa;

          |SI FSalida = 0;
               nDiasPago = nDiasLey;
          |FINSI;

          |POPV;
     |FINSI;
|FPRC;

|PROCESO AdadeAgrarios;
     swAdadeAgrHor = 0;

     |DBASS aBase;  |QBF aBase;
     aMas  = aBase + "laboral/def/adade004.mas";
     aFich = aBase + "laboral/fich/";

     |CARGA_DEF aMas, copiadef@;
     |SI FSalida ! 0;
         aAlfa = "0000 No puedo cargar el Def " + aMas;
         |MENAV aAlfa;
         |ACABA;
     |FINSI;

     |ABRE #500;
     #500#0 = #labtraba#87;   || convenio
     |LEE 000#500=;
     |SI FSalida = 0;
          swAdadeAgrHor = 1;
     |FINSI;
     |CIERRA #500;

     |DESCARGA_DEF #copiadef@;
|FPRC;

|PROCESO CalIndAgr;   || CALCULA LA INDEMNIZACION
     || SOLO ACTIVO LAS INDEMNIZACIONES AGRARIOS PARA ADADE, DE MOMENTO
     || LAS JUNTO AL MES, LAS OTRAS SI ESTAN PARA TODOS

     swAdadeAgrHor = 0;       || este es el switch

     swModulo = 0;
     |HAZ BuscaModulo;
     |SI swModulo = 2884; |O swModulo = 1;
          |HAZ AdadeAgrarios;
     |FINSI;

     |SI swAdadeAgrHor = 0;       || este es el switch
          |ACABA;
     |FINSI;

     || lo primero es saber cuantos dias lleva esta persona de alta desde
     || su fecha de antiguedad (mas bien en meses)
     swSigue = 0;
     ||SI runnom = "gomcalcu"; |Y #labempre#39 = 1; || desde nomina, finiquito junto mes
     |SI #labempre#39 = 1; || desde nomina, finiquito junto mes
          |SI #2#36 ! ".........."; |Y #2#36 ! "          ";      || fecha alta valida
               |SI fecbaj ! ".........."; |Y fecbaj ! "          "; || fecha baja valida
                    aMesBaja = fecbaj % 402;
                    nMesBaja = aMesBaja;
                    aAnyBaja = fecbaj % -104;
                    nAnyBaja = aAnyBaja;
                    |SI nMesBaja = nElMes; |Y nAnyBaja = nElAny;
                         swSigue = 1;
                    |FINSI;
               |FINSI;
          |FINSI;
     |FINSI;
     /*
     |SI runnom = "nomcalfi";
          swSigue = 1;
     |FINSI;
     */
     |SI swSigue = 1;
          aAlfa = #nomvarca#46;
          |QBF aAlfa;
          aAlfa = ("00" + aAlfa) % -102;
          |SI aAlfa ! "54"; |Y aAlfa ! "77";
          |Y aAlfa ! "91"; |Y aAlfa ! "92"; |Y aAlfa ! "93"; |Y aAlfa ! "98";
               aAlfa = #labtraba#184;
               aAlfa = aAlfa % 102;
               |QBF aAlfa;
               |SI aAlfa ! "54"; |Y aAlfa ! "77";
               |Y aAlfa ! "91"; |Y aAlfa ! "92"; |Y aAlfa ! "93"; |Y aAlfa ! "98";
                    swSigue = 0;
               |FINSI;
          |FINSI;
     |FINSI;

     |SI aFechaFIN ! ""; || Sykes, Theorical Liquidation
          swSigue = 1;
     |FINSI;

     |SI swSigue = 0;
          |ACABA;
     |FINSI;
/*
     || esto para saber si son los trabajadores agrarios del modulo de
     || adade, que van por horas y hay que calcularles el finiquito
     || a razon de las HORAS trabajadas y no los dias

     swAdadeAgrHor = 0;       || este es el switch

     swModulo = 0;
     |HAZ BuscaModulo;
     |SI swModulo = 2884; |O swModulo = 1;
          |HAZ AdadeAgrarios;
     |FINSI;
*/
     |ABRE #nomhicca;
     |ABRE #nomhicli;
     |ABRE #nomcalal;

     fFechaAnt = #labtraba#34;     || la fecha de antiguedad
     fFechaAlta = #labtraba#36;     || la fecha de alta contrato
     fFechaBaja = #2#37;            || la fecha de baja
     |SI #7#16 ! "..........";|Y #7#16 ! "          ";
          fFechaBaja = #7#16;
     |FINSI;

     || aFechaAlta = fFechaAlta;
     aFechaAlta = fFechaAnt;
     aFechaBaja = fFechaBaja;

     |QBF aFechaAlta;
     |QBF aFechaBaja;

     |SI aFechaFIN ! "";
          |SI aFechaBaja ! ""; |Y fFechaBaja [ fFechaFIN;
               aFechaBaja = aFechaBaja;
          |SINO;
               aFechaBaja = aFechaFIN;
          |FINSI;
     |FINSI;

     |HAZ mesesAlta;
     |SI swAdadeAgrHor = 1;
          nGuardaMeses = #nomfinli#7;
          #nomfinli#7 = 0;
          nConcepto1 = 101;
          nUnidadesCon = 0;
          |HAZ BuscaImpCalc;
          #nomfinli#7 = nGuardaMeses;
          nHoras = nUnidadesCon;
     |FINSI;

     topemes = guarda;

     || lo segundo: a ver si tengo derecho a indemnizacion por cese;

     swTengoDerecho = 0;
     nume1 = #labtraba#45;
     |BUCLE BuscaIndem;
     |SI swTengoDerecho ! 1;
          |ACABA;
     |FINSI;

     || tercero: a ver cuantos dias de indemnizacion tengo que pagar segun
     || el tiempo que se ha trabajado

     |SI #nomfinli#6 ! "%";
          nDiasPago = #nomfinli#5;
          |HAZ DiasPago;

          nPorCada = #nomfinli#7;
          |SI nPorCada ! 0;
               nUnidades = nMesesAlta / nPorCada;
          |SINO;
               nUnidades = 1;
          |FINSI;

          |SI #nomfinli#8 = "N";             || no proporciono
               nUnidades = (nUnidades - 0.49) ! 0;
          |FINSI;

          nUnidades = nUnidades * nDiasPago;
          |SI #nomfinli#6 = "M";
               nUnidades = nUnidades * 30;
          |FINSI;
     |SINO;
          || aqui si es por porcentaje
          nDiasPago = #nomfinli#5;
          |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";      || mensuales
               nUnidades = nDiasAlta;
          |SINO;                        || diarios
               nFechaAlta = fFechaAlta;
               nFechaBaja = fFechaBaja;
               nUnidades = nFechaBaja - nFechaAlta + 1;
          |FINSI;
     |FINSI;

     swExiste902 = 0;
     |HAZ Busca902;
     swExiste410 = 0;
     |HAZ Busca410;

     nTotAju = 0;
     nTotInd = 0;
     nConceptos = 0;

     |SI #labtraba#97 ! 0; |Y #nomfinli#8 ! "D";
          || si tengo ajuste y no es por importe cobrado claro
          || ahora hay que simular un ajuste, a ver como lo hacemos
          |SI #labtraba#42 ! "D"; |Y #labtraba#42 ! "T";    || mensuales
               |SI #labtraba#207 ! "M";
                    nTotInd = #2#98;
               |SINO;
                    nTotInd = #2#98 / 30;
               |FINSI;
          |SINO;                                            || diarios
               |SI #labtraba#207 ! "M";
                    nTotInd = #2#98;
               |SINO;
                    nTotInd = (#2#98 * 12) / 365;
               |FINSI;
          |FINSI;

          || vale, ahora tengo en nTotInd el importe diario que he de pagar
          |SI #labtraba#97 = 1; |O #labtraba#97 = 2; |O #labtraba#97 = 5;
               || bruto, se queda igual
          |SINO;
               || liquido, hago ajuste rapido, no tengo SS, solo IRPF:
               || nTotBru = nTotInd + ((nTotInd * nIRPF1) / 100);
               || aqui no, a¤ado el IRPF para que sea el importe liquido del ajuste
               || solo si le digo que la indemnizacion va CON IRPF
               || eso lo hago despues
               nTotInd = nTotInd;
          |FINSI;

          nTotAju = nTotInd;
     |FINSI;

     swSigue = 1;

     sw920 = 0;
     nTotInd = 0;
     |PARA nume1 = 9; |SI nume1 [ 14; |Y swSigue = 1; |HACIENDO nume1 = nume1 + 1;
          nImporInd = 0;
          concepto = #nomfinli#nume1#;
          |SI concepto ! 0;
               nConceptos = nConceptos + 1;
               ||SI concepto ! 102; |Y concepto ! 0;    || la antiguedad aparte
               || no se porque hacia esto, incluyo antiguedad a partir de
               || 07.01.2013
               |SI concepto ! 0;
                    |SI 200 [ concepto; |Y concepto [ 208; |Y #nomfinli#8 ! "D";
                         |ABRE #nomconca;
                         #nomconca#0 = #labtraba#87;
                         |LEE 000#nomconca.=;
                         |HAZ BuscaCon200;
                         |CIERRA #nomconca;
                    |SINO;
                         |HAZ BuscaConInd;
                    |FINSI;
               |FINSI;
               nTotInd = nTotInd + nImporInd;
          |FINSI;
     |SIGUE;

     |SI nConceptos = 0; |Y swSigue = 1;
          nTotInd = 0;

          |BUCLE ConceptosCat;
     |FINSI;

     nImporInd = nTotInd;

     |SI nTotAju ! 0; |Y sw920 = 0;
          || cojo el importe calculado del ajuste,
          || simpre que no exista el 920
          || en la lista de conceptos que entran en la indemnizacion
          nImporInd = nTotAju;
     |FINSI;

     |SI #nomfinli#6 = "%"; |Y #nomfinli#8 = "D";
          || el importe de las salarios que cojo del historico de las nominas
          || del trabajador ya esta reducido en los tiempos parciales, no hay
          || que volver a aplicar coeficiente de tp en los casos de que la indem.
          || sea del tipo "el 7% de todo lo cobrado por el trabajador"
     |SINO;
          || el resto de casos si no es un ajuste, s¡

          |SI #labtraba#97 ! 0;
               || tiene ajuste
          |SINO;
               |SI tp ! 0; |Y tp ! 1;
                    || nImporInd = nTotInd * tp;
                    || lo tiene que hacer solo si el importe viene de
                    || importes por categorias, aqui NO se hace mas
                    || 12.06.2014
               |FINSI;
          |FINSI;
     |FINSI;

     |SI #nomfinli#6 = "%";
          nImporInd = nImporInd % nDiasPago;
     |FINSI;

     |SI #nomfinli#6 = "%"; |Y #nomfinli#8 = "D";
          nUnidades = 1;
     |FINSI;

     |SI swAdadeAgrHor = 1;
          nUnidades = nHoras * nDiasPago / 365;
          nImporInd = nTotInd;
     |FINSI;

     || si he usado el 949, lo que diga el concepto

     |HAZ Busca949;

     || Ya tengo las unidades a pagar y el importe, con lo que ya puedo
     || construir la indemnizacion

     |SI #nomcontr#13 = "N";  concepto = 415;  |FINSI;     || sin IRPF
     |SI #nomcontr#13 = "S";  concepto = 410;  |FINSI;     || con IRPF
     swIndem = 1;        || por convenio


     |SI #nomcontr#59 = "S"; |Y swExiste902 = 0;
          |HAZ PreguntaIndem;      || si existe el 902 ya he preguntado
     |FINSI;                       || antes

     |||SI #nomcontr#59 = "S"; |Y runnom = "nomcalcu";
     |SI #nomcontr#59 = "S";
          concepto = nConceptoInd;
     |FINSI;

     || ajustes a liquido, a¤ado IRPF si le digo que tiene retencion
     || para que de el liquido que ha de dar

     |SI #labtraba#97 = 3; |O #labtraba#97 = 4; |O #labtraba#97 = 6;
          |SI concepto = 410;
               nImporInd = nImporInd + ((nImporInd * nIRPF1) / 100);
          |FINSI;
     |FINSI;

     duni1_902 = 1;
     duni2_902 = nUnidades;
     dvalo_902 = nImporInd;
     product = dvalo_902 * duni2_902;
     product = product ! EURODB;

     |HAZ convenio_ind;
     |SI convenio = 0;
          graba04 = concepto;
          graba09 = 1;
          graba10 = dvalo_902;
          graba11 = duni2_902;
          |SI product ! 0;
               ||HAZ CompruebaIndem;
               swgracon = 1;   || para que regrabe campos
               swcongra = 2;   || para que acumule si existe
               graba05 = #nomconli#3;
               graba06 = #nomconli#4;
               graba07 = #nomconli#5;
               graba08 = #nomconli#6;
               |HAZ grabacon_ind;

               duni2_999 = #nomcalli#11;
               dvalo_999 = #nomcalli#10;
               product = duni2_999 * dvalo_999;
               product = product ! EURODB;

               swSigue = 1;
               ||SI runnom = "nomcalcu"; |Y #labempre#39 = 1;
               |SI #labempre#39 = 1;
                    |SI swExiste902 = 1; |O swExiste410 = 1;
                         || desde nomina, finiquito junto mes, con importe
                         || en 902 o 410 entonces NO, ya se acumula despues
                         swSigue = 0;
                    |FINSI;
               |FINSI;
               |SI swSigue = 1;
                    |HAZ acu_ctos_fin;
               |FINSI;
          |FINSI;
     |SINO;
          alfa1 = "    Indemnizacion: concepto [" + concepto + "] no definido en convenio ...";
          |MENAV alfa1;
     |FINSI;

     |CIERRA #nomcalal;
     |CIERRA #nomhicli;
     |CIERRA #nomhicca;
|FPRC;

|PROCESO GrabaFiniqCero;
     |HAZ Busca949;
     |SI sw949 = 1;
          #nomcalca#3 = 2;
          |LEE 101#nomcalca.=;
          |SI FSalida = 0;
               |PDEFECTO #nomcalca, 11, 170;
               |GRABA 020#nomcalca.a;
          |SINO;
               |PDEFECTO #nomcalca, 11, 170;
               |GRABA 020#nomcalca.n;
          |FINSI;
          |LIBERA #nomcalca;
     |FINSI;
|FPRC;
